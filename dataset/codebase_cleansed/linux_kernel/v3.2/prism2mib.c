int prism2mgmt_mibset_mibget(wlandevice_t *wlandev, void *msgp)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nint result, isget;\r\nstruct mibrec *mib;\r\nu16 which;\r\nstruct p80211msg_dot11req_mibset *msg = msgp;\r\np80211itemd_t *mibitem;\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\nmsg->resultcode.data = P80211ENUM_resultcode_success;\r\nwhich = F_STA;\r\nmibitem = (p80211itemd_t *) msg->mibattribute.data;\r\nfor (mib = mibtab; mib->did != 0; mib++)\r\nif (mib->did == mibitem->did && (mib->flag & which))\r\nbreak;\r\nif (mib->did == 0) {\r\nmsg->resultcode.data = P80211ENUM_resultcode_not_supported;\r\ngoto done;\r\n}\r\nisget = (msg->msgcode == DIDmsg_dot11req_mibget);\r\nif (isget) {\r\nif (!(mib->flag & F_READ)) {\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_cant_get_writeonly_mib;\r\ngoto done;\r\n}\r\n} else {\r\nif (!(mib->flag & F_WRITE)) {\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_cant_set_readonly_mib;\r\ngoto done;\r\n}\r\n}\r\nresult = mib->func(mib, isget, wlandev, hw, msg, (void *)mibitem->data);\r\nif (msg->resultcode.data == P80211ENUM_resultcode_success) {\r\nif (result != 0) {\r\npr_debug("get/set failure, result=%d\n", result);\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\n} else {\r\nif (isget) {\r\nmsg->mibattribute.status =\r\nP80211ENUM_msgitem_status_data_ok;\r\nmibitem->status =\r\nP80211ENUM_msgitem_status_data_ok;\r\n}\r\n}\r\n}\r\ndone:\r\nreturn 0;\r\n}\r\nstatic int prism2mib_bytearea2pstr(struct mibrec *mib,\r\nint isget,\r\nwlandevice_t *wlandev,\r\nhfa384x_t *hw,\r\nstruct p80211msg_dot11req_mibset *msg,\r\nvoid *data)\r\n{\r\nint result;\r\np80211pstrd_t *pstr = (p80211pstrd_t *) data;\r\nu8 bytebuf[MIB_TMP_MAXLEN];\r\nif (isget) {\r\nresult =\r\nhfa384x_drvr_getconfig(hw, mib->parm1, bytebuf, mib->parm2);\r\nprism2mgmt_bytearea2pstr(bytebuf, pstr, mib->parm2);\r\n} else {\r\nmemset(bytebuf, 0, mib->parm2);\r\nprism2mgmt_pstr2bytearea(bytebuf, pstr);\r\nresult =\r\nhfa384x_drvr_setconfig(hw, mib->parm1, bytebuf, mib->parm2);\r\n}\r\nreturn result;\r\n}\r\nstatic int prism2mib_uint32(struct mibrec *mib,\r\nint isget,\r\nwlandevice_t *wlandev,\r\nhfa384x_t *hw,\r\nstruct p80211msg_dot11req_mibset *msg, void *data)\r\n{\r\nint result;\r\nu32 *uint32 = (u32 *) data;\r\nu8 bytebuf[MIB_TMP_MAXLEN];\r\nu16 *wordbuf = (u16 *) bytebuf;\r\nif (isget) {\r\nresult = hfa384x_drvr_getconfig16(hw, mib->parm1, wordbuf);\r\n*uint32 = *wordbuf;\r\n} else {\r\n*wordbuf = *uint32;\r\nresult = hfa384x_drvr_setconfig16(hw, mib->parm1, *wordbuf);\r\n}\r\nreturn result;\r\n}\r\nstatic int prism2mib_flag(struct mibrec *mib,\r\nint isget,\r\nwlandevice_t *wlandev,\r\nhfa384x_t *hw,\r\nstruct p80211msg_dot11req_mibset *msg, void *data)\r\n{\r\nint result;\r\nu32 *uint32 = (u32 *) data;\r\nu8 bytebuf[MIB_TMP_MAXLEN];\r\nu16 *wordbuf = (u16 *) bytebuf;\r\nu32 flags;\r\nresult = hfa384x_drvr_getconfig16(hw, mib->parm1, wordbuf);\r\nif (result == 0) {\r\nflags = *wordbuf;\r\nif (isget) {\r\n*uint32 = (flags & mib->parm2) ?\r\nP80211ENUM_truth_true : P80211ENUM_truth_false;\r\n} else {\r\nif ((*uint32) == P80211ENUM_truth_true)\r\nflags |= mib->parm2;\r\nelse\r\nflags &= ~mib->parm2;\r\n*wordbuf = flags;\r\nresult =\r\nhfa384x_drvr_setconfig16(hw, mib->parm1, *wordbuf);\r\n}\r\n}\r\nreturn result;\r\n}\r\nstatic int prism2mib_wepdefaultkey(struct mibrec *mib,\r\nint isget,\r\nwlandevice_t *wlandev,\r\nhfa384x_t *hw,\r\nstruct p80211msg_dot11req_mibset *msg,\r\nvoid *data)\r\n{\r\nint result;\r\np80211pstrd_t *pstr = (p80211pstrd_t *) data;\r\nu8 bytebuf[MIB_TMP_MAXLEN];\r\nu16 len;\r\nif (isget) {\r\nresult = 0;\r\n} else {\r\nlen = (pstr->len > 5) ? HFA384x_RID_CNFWEP128DEFAULTKEY_LEN :\r\nHFA384x_RID_CNFWEPDEFAULTKEY_LEN;\r\nmemset(bytebuf, 0, len);\r\nprism2mgmt_pstr2bytearea(bytebuf, pstr);\r\nresult = hfa384x_drvr_setconfig(hw, mib->parm1, bytebuf, len);\r\n}\r\nreturn result;\r\n}\r\nstatic int prism2mib_privacyinvoked(struct mibrec *mib,\r\nint isget,\r\nwlandevice_t *wlandev,\r\nhfa384x_t *hw,\r\nstruct p80211msg_dot11req_mibset *msg,\r\nvoid *data)\r\n{\r\nint result;\r\nif (wlandev->hostwep & HOSTWEP_DECRYPT) {\r\nif (wlandev->hostwep & HOSTWEP_DECRYPT)\r\nmib->parm2 |= HFA384x_WEPFLAGS_DISABLE_RXCRYPT;\r\nif (wlandev->hostwep & HOSTWEP_ENCRYPT)\r\nmib->parm2 |= HFA384x_WEPFLAGS_DISABLE_TXCRYPT;\r\n}\r\nresult = prism2mib_flag(mib, isget, wlandev, hw, msg, data);\r\nreturn result;\r\n}\r\nstatic int prism2mib_excludeunencrypted(struct mibrec *mib,\r\nint isget,\r\nwlandevice_t *wlandev,\r\nhfa384x_t *hw,\r\nstruct p80211msg_dot11req_mibset *msg,\r\nvoid *data)\r\n{\r\nint result;\r\nresult = prism2mib_flag(mib, isget, wlandev, hw, msg, data);\r\nreturn result;\r\n}\r\nstatic int prism2mib_fragmentationthreshold(struct mibrec *mib,\r\nint isget,\r\nwlandevice_t *wlandev,\r\nhfa384x_t *hw,\r\nstruct p80211msg_dot11req_mibset *msg,\r\nvoid *data)\r\n{\r\nint result;\r\nu32 *uint32 = (u32 *) data;\r\nif (!isget)\r\nif ((*uint32) % 2) {\r\nprintk(KERN_WARNING "Attempt to set odd number "\r\n"FragmentationThreshold\n");\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_not_supported;\r\nreturn 0;\r\n}\r\nresult = prism2mib_uint32(mib, isget, wlandev, hw, msg, data);\r\nreturn result;\r\n}\r\nstatic int prism2mib_priv(struct mibrec *mib,\r\nint isget,\r\nwlandevice_t *wlandev,\r\nhfa384x_t *hw,\r\nstruct p80211msg_dot11req_mibset *msg, void *data)\r\n{\r\np80211pstrd_t *pstr = (p80211pstrd_t *) data;\r\nint result;\r\nswitch (mib->did) {\r\ncase DIDmib_lnx_lnxConfigTable_lnxRSNAIE:{\r\nhfa384x_WPAData_t wpa;\r\nif (isget) {\r\nhfa384x_drvr_getconfig(hw,\r\nHFA384x_RID_CNFWPADATA,\r\n(u8 *) &wpa,\r\nsizeof(wpa));\r\npstr->len = le16_to_cpu(wpa.datalen);\r\nmemcpy(pstr->data, wpa.data, pstr->len);\r\n} else {\r\nwpa.datalen = cpu_to_le16(pstr->len);\r\nmemcpy(wpa.data, pstr->data, pstr->len);\r\nresult =\r\nhfa384x_drvr_setconfig(hw,\r\nHFA384x_RID_CNFWPADATA,\r\n(u8 *) &wpa,\r\nsizeof(wpa));\r\n}\r\nbreak;\r\n}\r\ndefault:\r\nprintk(KERN_ERR "Unhandled DID 0x%08x\n", mib->did);\r\n}\r\nreturn 0;\r\n}\r\nvoid prism2mgmt_pstr2bytestr(hfa384x_bytestr_t *bytestr, p80211pstrd_t *pstr)\r\n{\r\nbytestr->len = cpu_to_le16((u16) (pstr->len));\r\nmemcpy(bytestr->data, pstr->data, pstr->len);\r\n}\r\nvoid prism2mgmt_pstr2bytearea(u8 *bytearea, p80211pstrd_t *pstr)\r\n{\r\nmemcpy(bytearea, pstr->data, pstr->len);\r\n}\r\nvoid prism2mgmt_bytestr2pstr(hfa384x_bytestr_t *bytestr, p80211pstrd_t *pstr)\r\n{\r\npstr->len = (u8) (le16_to_cpu((u16) (bytestr->len)));\r\nmemcpy(pstr->data, bytestr->data, pstr->len);\r\n}\r\nvoid prism2mgmt_bytearea2pstr(u8 *bytearea, p80211pstrd_t *pstr, int len)\r\n{\r\npstr->len = (u8) len;\r\nmemcpy(pstr->data, bytearea, len);\r\n}

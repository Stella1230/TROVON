static int mv64x60_i2c_wait_for_status(int wanted)\r\n{\r\nint i;\r\nint status;\r\nfor (i=0; i<1000; i++) {\r\nudelay(10);\r\nstatus = in_le32((u32 *)(ctlr_base + MV64x60_I2C_REG_STATUS))\r\n& 0xff;\r\nif (status == wanted)\r\nreturn status;\r\n}\r\nreturn -status;\r\n}\r\nstatic int mv64x60_i2c_control(int control, int status)\r\n{\r\nout_le32((u32 *)(ctlr_base + MV64x60_I2C_REG_CONTROL), control & 0xff);\r\nreturn mv64x60_i2c_wait_for_status(status);\r\n}\r\nstatic int mv64x60_i2c_read_byte(int control, int status)\r\n{\r\nout_le32((u32 *)(ctlr_base + MV64x60_I2C_REG_CONTROL), control & 0xff);\r\nif (mv64x60_i2c_wait_for_status(status) < 0)\r\nreturn -1;\r\nreturn in_le32((u32 *)(ctlr_base + MV64x60_I2C_REG_DATA)) & 0xff;\r\n}\r\nstatic int mv64x60_i2c_write_byte(int data, int control, int status)\r\n{\r\nout_le32((u32 *)(ctlr_base + MV64x60_I2C_REG_DATA), data & 0xff);\r\nout_le32((u32 *)(ctlr_base + MV64x60_I2C_REG_CONTROL), control & 0xff);\r\nreturn mv64x60_i2c_wait_for_status(status);\r\n}\r\nint mv64x60_i2c_read(u32 devaddr, u8 *buf, u32 offset, u32 offset_size,\r\nu32 count)\r\n{\r\nint i;\r\nint data;\r\nint control;\r\nint status;\r\nif (ctlr_base == NULL)\r\nreturn -1;\r\nout_le32((u32 *)(ctlr_base + MV64x60_I2C_REG_SOFT_RESET), 0);\r\nout_le32((u32 *)(ctlr_base + MV64x60_I2C_REG_SLAVE_ADDR), 0);\r\nout_le32((u32 *)(ctlr_base + MV64x60_I2C_REG_EXT_SLAVE_ADDR), 0);\r\nout_le32((u32 *)(ctlr_base + MV64x60_I2C_REG_BAUD), (4 << 3) | 0x4);\r\nif (mv64x60_i2c_control(MV64x60_I2C_CONTROL_TWSIEN,\r\nMV64x60_I2C_STATUS_NO_STATUS) < 0)\r\nreturn -1;\r\ncontrol = MV64x60_I2C_CONTROL_START | MV64x60_I2C_CONTROL_TWSIEN;\r\nstatus = MV64x60_I2C_STATUS_MAST_START;\r\nif (mv64x60_i2c_control(control, status) < 0)\r\nreturn -1;\r\ndata = devaddr & ~0x1;\r\ncontrol = MV64x60_I2C_CONTROL_TWSIEN;\r\nstatus = MV64x60_I2C_STATUS_MAST_WR_ADDR_ACK;\r\nif (mv64x60_i2c_write_byte(data, control, status) < 0)\r\nreturn -1;\r\ncontrol = MV64x60_I2C_CONTROL_TWSIEN;\r\nstatus = MV64x60_I2C_STATUS_MAST_WR_ACK;\r\nif (offset_size > 1) {\r\nif (mv64x60_i2c_write_byte(offset >> 8, control, status) < 0)\r\nreturn -1;\r\n}\r\nif (mv64x60_i2c_write_byte(offset, control, status) < 0)\r\nreturn -1;\r\ncontrol = MV64x60_I2C_CONTROL_START | MV64x60_I2C_CONTROL_TWSIEN;\r\nstatus = MV64x60_I2C_STATUS_MAST_REPEAT_START;\r\nif (mv64x60_i2c_control(control, status) < 0)\r\nreturn -1;\r\ndata = devaddr | 0x1;\r\ncontrol = MV64x60_I2C_CONTROL_TWSIEN;\r\nstatus = MV64x60_I2C_STATUS_MAST_RD_ADDR_ACK;\r\nif (mv64x60_i2c_write_byte(data, control, status) < 0)\r\nreturn -1;\r\ncontrol = MV64x60_I2C_CONTROL_ACK | MV64x60_I2C_CONTROL_TWSIEN;\r\nstatus = MV64x60_I2C_STATUS_MAST_RD_DATA_ACK;\r\nfor (i=1; i<count; i++) {\r\ndata = mv64x60_i2c_read_byte(control, status);\r\nif (data < 0) {\r\nprintf("errors on iteration %d\n", i);\r\nreturn -1;\r\n}\r\n*buf++ = data;\r\n}\r\ncontrol = MV64x60_I2C_CONTROL_TWSIEN;\r\nstatus = MV64x60_I2C_STATUS_MAST_RD_DATA_NO_ACK;\r\ndata = mv64x60_i2c_read_byte(control, status);\r\nif (data < 0)\r\nreturn -1;\r\n*buf++ = data;\r\ncontrol = MV64x60_I2C_CONTROL_STOP | MV64x60_I2C_CONTROL_TWSIEN;\r\nstatus = MV64x60_I2C_STATUS_NO_STATUS;\r\nif (mv64x60_i2c_control(control, status) < 0)\r\nreturn -1;\r\nreturn count;\r\n}\r\nint mv64x60_i2c_open(void)\r\n{\r\nu32 v;\r\nvoid *devp;\r\ndevp = find_node_by_compatible(NULL, "marvell,mv64360-i2c");\r\nif (devp == NULL)\r\ngoto err_out;\r\nif (getprop(devp, "virtual-reg", &v, sizeof(v)) != sizeof(v))\r\ngoto err_out;\r\nctlr_base = (u8 *)v;\r\nreturn 0;\r\nerr_out:\r\nreturn -1;\r\n}\r\nvoid mv64x60_i2c_close(void)\r\n{\r\nctlr_base = NULL;\r\n}

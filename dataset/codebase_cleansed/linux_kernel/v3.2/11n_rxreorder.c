static int\r\nmwifiex_11n_dispatch_pkt_until_start_win(struct mwifiex_private *priv,\r\nstruct mwifiex_rx_reorder_tbl\r\n*rx_reor_tbl_ptr, int start_win)\r\n{\r\nint no_pkt_to_send, i;\r\nvoid *rx_tmp_ptr;\r\nunsigned long flags;\r\nno_pkt_to_send = (start_win > rx_reor_tbl_ptr->start_win) ?\r\nmin((start_win - rx_reor_tbl_ptr->start_win),\r\nrx_reor_tbl_ptr->win_size) : rx_reor_tbl_ptr->win_size;\r\nfor (i = 0; i < no_pkt_to_send; ++i) {\r\nspin_lock_irqsave(&priv->rx_pkt_lock, flags);\r\nrx_tmp_ptr = NULL;\r\nif (rx_reor_tbl_ptr->rx_reorder_ptr[i]) {\r\nrx_tmp_ptr = rx_reor_tbl_ptr->rx_reorder_ptr[i];\r\nrx_reor_tbl_ptr->rx_reorder_ptr[i] = NULL;\r\n}\r\nspin_unlock_irqrestore(&priv->rx_pkt_lock, flags);\r\nif (rx_tmp_ptr)\r\nmwifiex_process_rx_packet(priv->adapter, rx_tmp_ptr);\r\n}\r\nspin_lock_irqsave(&priv->rx_pkt_lock, flags);\r\nfor (i = 0; i < rx_reor_tbl_ptr->win_size - no_pkt_to_send; ++i) {\r\nrx_reor_tbl_ptr->rx_reorder_ptr[i] =\r\nrx_reor_tbl_ptr->rx_reorder_ptr[no_pkt_to_send + i];\r\nrx_reor_tbl_ptr->rx_reorder_ptr[no_pkt_to_send + i] = NULL;\r\n}\r\nrx_reor_tbl_ptr->start_win = start_win;\r\nspin_unlock_irqrestore(&priv->rx_pkt_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int\r\nmwifiex_11n_scan_and_dispatch(struct mwifiex_private *priv,\r\nstruct mwifiex_rx_reorder_tbl *rx_reor_tbl_ptr)\r\n{\r\nint i, j, xchg;\r\nvoid *rx_tmp_ptr;\r\nunsigned long flags;\r\nfor (i = 0; i < rx_reor_tbl_ptr->win_size; ++i) {\r\nspin_lock_irqsave(&priv->rx_pkt_lock, flags);\r\nif (!rx_reor_tbl_ptr->rx_reorder_ptr[i]) {\r\nspin_unlock_irqrestore(&priv->rx_pkt_lock, flags);\r\nbreak;\r\n}\r\nrx_tmp_ptr = rx_reor_tbl_ptr->rx_reorder_ptr[i];\r\nrx_reor_tbl_ptr->rx_reorder_ptr[i] = NULL;\r\nspin_unlock_irqrestore(&priv->rx_pkt_lock, flags);\r\nmwifiex_process_rx_packet(priv->adapter, rx_tmp_ptr);\r\n}\r\nspin_lock_irqsave(&priv->rx_pkt_lock, flags);\r\nif (i > 0) {\r\nxchg = rx_reor_tbl_ptr->win_size - i;\r\nfor (j = 0; j < xchg; ++j) {\r\nrx_reor_tbl_ptr->rx_reorder_ptr[j] =\r\nrx_reor_tbl_ptr->rx_reorder_ptr[i + j];\r\nrx_reor_tbl_ptr->rx_reorder_ptr[i + j] = NULL;\r\n}\r\n}\r\nrx_reor_tbl_ptr->start_win = (rx_reor_tbl_ptr->start_win + i)\r\n&(MAX_TID_VALUE - 1);\r\nspin_unlock_irqrestore(&priv->rx_pkt_lock, flags);\r\nreturn 0;\r\n}\r\nstatic void\r\nmwifiex_11n_delete_rx_reorder_tbl_entry(struct mwifiex_private *priv,\r\nstruct mwifiex_rx_reorder_tbl\r\n*rx_reor_tbl_ptr)\r\n{\r\nunsigned long flags;\r\nif (!rx_reor_tbl_ptr)\r\nreturn;\r\nmwifiex_11n_dispatch_pkt_until_start_win(priv, rx_reor_tbl_ptr,\r\n(rx_reor_tbl_ptr->start_win +\r\nrx_reor_tbl_ptr->win_size)\r\n&(MAX_TID_VALUE - 1));\r\ndel_timer(&rx_reor_tbl_ptr->timer_context.timer);\r\nspin_lock_irqsave(&priv->rx_reorder_tbl_lock, flags);\r\nlist_del(&rx_reor_tbl_ptr->list);\r\nspin_unlock_irqrestore(&priv->rx_reorder_tbl_lock, flags);\r\nkfree(rx_reor_tbl_ptr->rx_reorder_ptr);\r\nkfree(rx_reor_tbl_ptr);\r\n}\r\nstatic struct mwifiex_rx_reorder_tbl *\r\nmwifiex_11n_get_rx_reorder_tbl(struct mwifiex_private *priv, int tid, u8 *ta)\r\n{\r\nstruct mwifiex_rx_reorder_tbl *rx_reor_tbl_ptr;\r\nunsigned long flags;\r\nspin_lock_irqsave(&priv->rx_reorder_tbl_lock, flags);\r\nlist_for_each_entry(rx_reor_tbl_ptr, &priv->rx_reorder_tbl_ptr, list) {\r\nif ((!memcmp(rx_reor_tbl_ptr->ta, ta, ETH_ALEN))\r\n&& (rx_reor_tbl_ptr->tid == tid)) {\r\nspin_unlock_irqrestore(&priv->rx_reorder_tbl_lock,\r\nflags);\r\nreturn rx_reor_tbl_ptr;\r\n}\r\n}\r\nspin_unlock_irqrestore(&priv->rx_reorder_tbl_lock, flags);\r\nreturn NULL;\r\n}\r\nstatic int\r\nmwifiex_11n_find_last_seq_num(struct mwifiex_rx_reorder_tbl *rx_reorder_tbl_ptr)\r\n{\r\nint i;\r\nfor (i = (rx_reorder_tbl_ptr->win_size - 1); i >= 0; --i)\r\nif (rx_reorder_tbl_ptr->rx_reorder_ptr[i])\r\nreturn i;\r\nreturn -1;\r\n}\r\nstatic void\r\nmwifiex_flush_data(unsigned long context)\r\n{\r\nstruct reorder_tmr_cnxt *reorder_cnxt =\r\n(struct reorder_tmr_cnxt *) context;\r\nint start_win;\r\nstart_win = mwifiex_11n_find_last_seq_num(reorder_cnxt->ptr);\r\nif (start_win >= 0) {\r\ndev_dbg(reorder_cnxt->priv->adapter->dev,\r\n"info: flush data %d\n", start_win);\r\nmwifiex_11n_dispatch_pkt_until_start_win(reorder_cnxt->priv,\r\nreorder_cnxt->ptr,\r\n((reorder_cnxt->ptr->start_win +\r\nstart_win + 1) & (MAX_TID_VALUE - 1)));\r\n}\r\n}\r\nstatic void\r\nmwifiex_11n_create_rx_reorder_tbl(struct mwifiex_private *priv, u8 *ta,\r\nint tid, int win_size, int seq_num)\r\n{\r\nint i;\r\nstruct mwifiex_rx_reorder_tbl *rx_reor_tbl_ptr, *new_node;\r\nu16 last_seq = 0;\r\nunsigned long flags;\r\nrx_reor_tbl_ptr = mwifiex_11n_get_rx_reorder_tbl(priv, tid, ta);\r\nif (rx_reor_tbl_ptr) {\r\nmwifiex_11n_dispatch_pkt_until_start_win(priv, rx_reor_tbl_ptr,\r\nseq_num);\r\nreturn;\r\n}\r\nnew_node = kzalloc(sizeof(struct mwifiex_rx_reorder_tbl), GFP_KERNEL);\r\nif (!new_node) {\r\ndev_err(priv->adapter->dev, "%s: failed to alloc new_node\n",\r\n__func__);\r\nreturn;\r\n}\r\nINIT_LIST_HEAD(&new_node->list);\r\nnew_node->tid = tid;\r\nmemcpy(new_node->ta, ta, ETH_ALEN);\r\nnew_node->start_win = seq_num;\r\nif (mwifiex_queuing_ra_based(priv))\r\ndev_dbg(priv->adapter->dev,\r\n"info: ADHOC:last_seq=%d start_win=%d\n",\r\nlast_seq, new_node->start_win);\r\nelse\r\nlast_seq = priv->rx_seq[tid];\r\nif (last_seq >= new_node->start_win)\r\nnew_node->start_win = last_seq + 1;\r\nnew_node->win_size = win_size;\r\nnew_node->rx_reorder_ptr = kzalloc(sizeof(void *) * win_size,\r\nGFP_KERNEL);\r\nif (!new_node->rx_reorder_ptr) {\r\nkfree((u8 *) new_node);\r\ndev_err(priv->adapter->dev,\r\n"%s: failed to alloc reorder_ptr\n", __func__);\r\nreturn;\r\n}\r\nnew_node->timer_context.ptr = new_node;\r\nnew_node->timer_context.priv = priv;\r\ninit_timer(&new_node->timer_context.timer);\r\nnew_node->timer_context.timer.function = mwifiex_flush_data;\r\nnew_node->timer_context.timer.data =\r\n(unsigned long) &new_node->timer_context;\r\nfor (i = 0; i < win_size; ++i)\r\nnew_node->rx_reorder_ptr[i] = NULL;\r\nspin_lock_irqsave(&priv->rx_reorder_tbl_lock, flags);\r\nlist_add_tail(&new_node->list, &priv->rx_reorder_tbl_ptr);\r\nspin_unlock_irqrestore(&priv->rx_reorder_tbl_lock, flags);\r\n}\r\nint mwifiex_cmd_11n_addba_req(struct host_cmd_ds_command *cmd, void *data_buf)\r\n{\r\nstruct host_cmd_ds_11n_addba_req *add_ba_req =\r\n(struct host_cmd_ds_11n_addba_req *)\r\n&cmd->params.add_ba_req;\r\ncmd->command = cpu_to_le16(HostCmd_CMD_11N_ADDBA_REQ);\r\ncmd->size = cpu_to_le16(sizeof(*add_ba_req) + S_DS_GEN);\r\nmemcpy(add_ba_req, data_buf, sizeof(*add_ba_req));\r\nreturn 0;\r\n}\r\nint mwifiex_cmd_11n_addba_rsp_gen(struct mwifiex_private *priv,\r\nstruct host_cmd_ds_command *cmd,\r\nstruct host_cmd_ds_11n_addba_req\r\n*cmd_addba_req)\r\n{\r\nstruct host_cmd_ds_11n_addba_rsp *add_ba_rsp =\r\n(struct host_cmd_ds_11n_addba_rsp *)\r\n&cmd->params.add_ba_rsp;\r\nu8 tid;\r\nint win_size;\r\nuint16_t block_ack_param_set;\r\ncmd->command = cpu_to_le16(HostCmd_CMD_11N_ADDBA_RSP);\r\ncmd->size = cpu_to_le16(sizeof(*add_ba_rsp) + S_DS_GEN);\r\nmemcpy(add_ba_rsp->peer_mac_addr, cmd_addba_req->peer_mac_addr,\r\nETH_ALEN);\r\nadd_ba_rsp->dialog_token = cmd_addba_req->dialog_token;\r\nadd_ba_rsp->block_ack_tmo = cmd_addba_req->block_ack_tmo;\r\nadd_ba_rsp->ssn = cmd_addba_req->ssn;\r\nblock_ack_param_set = le16_to_cpu(cmd_addba_req->block_ack_param_set);\r\ntid = (block_ack_param_set & IEEE80211_ADDBA_PARAM_TID_MASK)\r\n>> BLOCKACKPARAM_TID_POS;\r\nadd_ba_rsp->status_code = cpu_to_le16(ADDBA_RSP_STATUS_ACCEPT);\r\nblock_ack_param_set &= ~IEEE80211_ADDBA_PARAM_BUF_SIZE_MASK;\r\nblock_ack_param_set &= ~BLOCKACKPARAM_AMSDU_SUPP_MASK;\r\nblock_ack_param_set |= (priv->add_ba_param.rx_win_size <<\r\nBLOCKACKPARAM_WINSIZE_POS);\r\nadd_ba_rsp->block_ack_param_set = cpu_to_le16(block_ack_param_set);\r\nwin_size = (le16_to_cpu(add_ba_rsp->block_ack_param_set)\r\n& IEEE80211_ADDBA_PARAM_BUF_SIZE_MASK)\r\n>> BLOCKACKPARAM_WINSIZE_POS;\r\ncmd_addba_req->block_ack_param_set = cpu_to_le16(block_ack_param_set);\r\nmwifiex_11n_create_rx_reorder_tbl(priv, cmd_addba_req->peer_mac_addr,\r\ntid, win_size, le16_to_cpu(cmd_addba_req->ssn));\r\nreturn 0;\r\n}\r\nint mwifiex_cmd_11n_delba(struct host_cmd_ds_command *cmd, void *data_buf)\r\n{\r\nstruct host_cmd_ds_11n_delba *del_ba = (struct host_cmd_ds_11n_delba *)\r\n&cmd->params.del_ba;\r\ncmd->command = cpu_to_le16(HostCmd_CMD_11N_DELBA);\r\ncmd->size = cpu_to_le16(sizeof(*del_ba) + S_DS_GEN);\r\nmemcpy(del_ba, data_buf, sizeof(*del_ba));\r\nreturn 0;\r\n}\r\nint mwifiex_11n_rx_reorder_pkt(struct mwifiex_private *priv,\r\nu16 seq_num, u16 tid,\r\nu8 *ta, u8 pkt_type, void *payload)\r\n{\r\nstruct mwifiex_rx_reorder_tbl *rx_reor_tbl_ptr;\r\nint start_win, end_win, win_size, ret;\r\nu16 pkt_index;\r\nrx_reor_tbl_ptr =\r\nmwifiex_11n_get_rx_reorder_tbl((struct mwifiex_private *) priv,\r\ntid, ta);\r\nif (!rx_reor_tbl_ptr) {\r\nif (pkt_type != PKT_TYPE_BAR)\r\nmwifiex_process_rx_packet(priv->adapter, payload);\r\nreturn 0;\r\n}\r\nstart_win = rx_reor_tbl_ptr->start_win;\r\nwin_size = rx_reor_tbl_ptr->win_size;\r\nend_win = ((start_win + win_size) - 1) & (MAX_TID_VALUE - 1);\r\ndel_timer(&rx_reor_tbl_ptr->timer_context.timer);\r\nmod_timer(&rx_reor_tbl_ptr->timer_context.timer, jiffies\r\n+ (MIN_FLUSH_TIMER_MS * win_size * HZ) / 1000);\r\nif ((start_win + TWOPOW11) > (MAX_TID_VALUE - 1)) {\r\nif (seq_num >= ((start_win + (TWOPOW11)) & (MAX_TID_VALUE - 1))\r\n&& (seq_num < start_win))\r\nreturn -1;\r\n} else if ((seq_num < start_win)\r\n|| (seq_num > (start_win + (TWOPOW11)))) {\r\nreturn -1;\r\n}\r\nif (pkt_type == PKT_TYPE_BAR)\r\nseq_num = ((seq_num + win_size) - 1) & (MAX_TID_VALUE - 1);\r\nif (((end_win < start_win)\r\n&& (seq_num < (TWOPOW11 - (MAX_TID_VALUE - start_win)))\r\n&& (seq_num > end_win)) || ((end_win > start_win)\r\n&& ((seq_num > end_win) || (seq_num < start_win)))) {\r\nend_win = seq_num;\r\nif (((seq_num - win_size) + 1) >= 0)\r\nstart_win = (end_win - win_size) + 1;\r\nelse\r\nstart_win = (MAX_TID_VALUE - (win_size - seq_num)) + 1;\r\nret = mwifiex_11n_dispatch_pkt_until_start_win(priv,\r\nrx_reor_tbl_ptr, start_win);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (pkt_type != PKT_TYPE_BAR) {\r\nif (seq_num >= start_win)\r\npkt_index = seq_num - start_win;\r\nelse\r\npkt_index = (seq_num+MAX_TID_VALUE) - start_win;\r\nif (rx_reor_tbl_ptr->rx_reorder_ptr[pkt_index])\r\nreturn -1;\r\nrx_reor_tbl_ptr->rx_reorder_ptr[pkt_index] = payload;\r\n}\r\nret = mwifiex_11n_scan_and_dispatch(priv, rx_reor_tbl_ptr);\r\nreturn ret;\r\n}\r\nvoid\r\nmwifiex_11n_delete_ba_stream_tbl(struct mwifiex_private *priv, int tid,\r\nu8 *peer_mac, u8 type, int initiator)\r\n{\r\nstruct mwifiex_rx_reorder_tbl *rx_reor_tbl_ptr;\r\nstruct mwifiex_tx_ba_stream_tbl *ptx_tbl;\r\nu8 cleanup_rx_reorder_tbl;\r\nunsigned long flags;\r\nif (type == TYPE_DELBA_RECEIVE)\r\ncleanup_rx_reorder_tbl = (initiator) ? true : false;\r\nelse\r\ncleanup_rx_reorder_tbl = (initiator) ? false : true;\r\ndev_dbg(priv->adapter->dev, "event: DELBA: %pM tid=%d, "\r\n"initiator=%d\n", peer_mac, tid, initiator);\r\nif (cleanup_rx_reorder_tbl) {\r\nrx_reor_tbl_ptr = mwifiex_11n_get_rx_reorder_tbl(priv, tid,\r\npeer_mac);\r\nif (!rx_reor_tbl_ptr) {\r\ndev_dbg(priv->adapter->dev,\r\n"event: TID, TA not found in table\n");\r\nreturn;\r\n}\r\nmwifiex_11n_delete_rx_reorder_tbl_entry(priv, rx_reor_tbl_ptr);\r\n} else {\r\nptx_tbl = mwifiex_11n_get_tx_ba_stream_tbl(priv, tid, peer_mac);\r\nif (!ptx_tbl) {\r\ndev_dbg(priv->adapter->dev,\r\n"event: TID, RA not found in table\n");\r\nreturn;\r\n}\r\nspin_lock_irqsave(&priv->tx_ba_stream_tbl_lock, flags);\r\nmwifiex_11n_delete_tx_ba_stream_tbl_entry(priv, ptx_tbl);\r\nspin_unlock_irqrestore(&priv->tx_ba_stream_tbl_lock, flags);\r\n}\r\n}\r\nint mwifiex_ret_11n_addba_resp(struct mwifiex_private *priv,\r\nstruct host_cmd_ds_command *resp)\r\n{\r\nstruct host_cmd_ds_11n_addba_rsp *add_ba_rsp =\r\n(struct host_cmd_ds_11n_addba_rsp *)\r\n&resp->params.add_ba_rsp;\r\nint tid, win_size;\r\nstruct mwifiex_rx_reorder_tbl *rx_reor_tbl_ptr;\r\nuint16_t block_ack_param_set;\r\nblock_ack_param_set = le16_to_cpu(add_ba_rsp->block_ack_param_set);\r\ntid = (block_ack_param_set & IEEE80211_ADDBA_PARAM_TID_MASK)\r\n>> BLOCKACKPARAM_TID_POS;\r\nif (le16_to_cpu(add_ba_rsp->status_code) == BA_RESULT_SUCCESS) {\r\nwin_size = (block_ack_param_set &\r\nIEEE80211_ADDBA_PARAM_BUF_SIZE_MASK)\r\n>> BLOCKACKPARAM_WINSIZE_POS;\r\ndev_dbg(priv->adapter->dev, "cmd: ADDBA RSP: %pM"\r\n" tid=%d ssn=%d win_size=%d\n",\r\nadd_ba_rsp->peer_mac_addr,\r\ntid, add_ba_rsp->ssn, win_size);\r\n} else {\r\ndev_err(priv->adapter->dev, "ADDBA RSP: failed %pM tid=%d)\n",\r\nadd_ba_rsp->peer_mac_addr, tid);\r\nrx_reor_tbl_ptr = mwifiex_11n_get_rx_reorder_tbl(priv,\r\ntid, add_ba_rsp->peer_mac_addr);\r\nif (rx_reor_tbl_ptr)\r\nmwifiex_11n_delete_rx_reorder_tbl_entry(priv,\r\nrx_reor_tbl_ptr);\r\n}\r\nreturn 0;\r\n}\r\nvoid mwifiex_11n_ba_stream_timeout(struct mwifiex_private *priv,\r\nstruct host_cmd_ds_11n_batimeout *event)\r\n{\r\nstruct host_cmd_ds_11n_delba delba;\r\nmemset(&delba, 0, sizeof(struct host_cmd_ds_11n_delba));\r\nmemcpy(delba.peer_mac_addr, event->peer_mac_addr, ETH_ALEN);\r\ndelba.del_ba_param_set |=\r\ncpu_to_le16((u16) event->tid << DELBA_TID_POS);\r\ndelba.del_ba_param_set |= cpu_to_le16(\r\n(u16) event->origninator << DELBA_INITIATOR_POS);\r\ndelba.reason_code = cpu_to_le16(WLAN_REASON_QSTA_TIMEOUT);\r\nmwifiex_send_cmd_async(priv, HostCmd_CMD_11N_DELBA, 0, 0, &delba);\r\n}\r\nvoid mwifiex_11n_cleanup_reorder_tbl(struct mwifiex_private *priv)\r\n{\r\nstruct mwifiex_rx_reorder_tbl *del_tbl_ptr, *tmp_node;\r\nunsigned long flags;\r\nspin_lock_irqsave(&priv->rx_reorder_tbl_lock, flags);\r\nlist_for_each_entry_safe(del_tbl_ptr, tmp_node,\r\n&priv->rx_reorder_tbl_ptr, list) {\r\nspin_unlock_irqrestore(&priv->rx_reorder_tbl_lock, flags);\r\nmwifiex_11n_delete_rx_reorder_tbl_entry(priv, del_tbl_ptr);\r\nspin_lock_irqsave(&priv->rx_reorder_tbl_lock, flags);\r\n}\r\nspin_unlock_irqrestore(&priv->rx_reorder_tbl_lock, flags);\r\nINIT_LIST_HEAD(&priv->rx_reorder_tbl_ptr);\r\nmemset(priv->rx_seq, 0, sizeof(priv->rx_seq));\r\n}

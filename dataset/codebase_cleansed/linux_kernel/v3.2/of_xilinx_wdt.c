static void xwdt_start(void)\r\n{\r\nspin_lock(&spinlock);\r\ncontrol_status_reg = ioread32(xdev.base + XWT_TWCSR0_OFFSET);\r\ncontrol_status_reg |= (XWT_CSR0_WRS_MASK | XWT_CSR0_WDS_MASK);\r\niowrite32((control_status_reg | XWT_CSR0_EWDT1_MASK),\r\nxdev.base + XWT_TWCSR0_OFFSET);\r\niowrite32(XWT_CSRX_EWDT2_MASK, xdev.base + XWT_TWCSR1_OFFSET);\r\nspin_unlock(&spinlock);\r\n}\r\nstatic void xwdt_stop(void)\r\n{\r\nspin_lock(&spinlock);\r\ncontrol_status_reg = ioread32(xdev.base + XWT_TWCSR0_OFFSET);\r\niowrite32((control_status_reg & ~XWT_CSR0_EWDT1_MASK),\r\nxdev.base + XWT_TWCSR0_OFFSET);\r\niowrite32(0, xdev.base + XWT_TWCSR1_OFFSET);\r\nspin_unlock(&spinlock);\r\nprintk(KERN_INFO PFX "Stopped!\n");\r\n}\r\nstatic void xwdt_keepalive(void)\r\n{\r\nspin_lock(&spinlock);\r\ncontrol_status_reg = ioread32(xdev.base + XWT_TWCSR0_OFFSET);\r\ncontrol_status_reg |= (XWT_CSR0_WRS_MASK | XWT_CSR0_WDS_MASK);\r\niowrite32(control_status_reg, xdev.base + XWT_TWCSR0_OFFSET);\r\nspin_unlock(&spinlock);\r\n}\r\nstatic void xwdt_get_status(int *status)\r\n{\r\nint new_status;\r\nspin_lock(&spinlock);\r\ncontrol_status_reg = ioread32(xdev.base + XWT_TWCSR0_OFFSET);\r\nnew_status = ((control_status_reg &\r\n(XWT_CSR0_WRS_MASK | XWT_CSR0_WDS_MASK)) != 0);\r\nspin_unlock(&spinlock);\r\n*status = 0;\r\nif (new_status & 1)\r\n*status |= WDIOF_CARDRESET;\r\n}\r\nstatic u32 xwdt_selftest(void)\r\n{\r\nint i;\r\nu32 timer_value1;\r\nu32 timer_value2;\r\nspin_lock(&spinlock);\r\ntimer_value1 = ioread32(xdev.base + XWT_TBR_OFFSET);\r\ntimer_value2 = ioread32(xdev.base + XWT_TBR_OFFSET);\r\nfor (i = 0;\r\n((i <= XWT_MAX_SELFTEST_LOOP_COUNT) &&\r\n(timer_value2 == timer_value1)); i++) {\r\ntimer_value2 = ioread32(xdev.base + XWT_TBR_OFFSET);\r\n}\r\nspin_unlock(&spinlock);\r\nif (timer_value2 != timer_value1)\r\nreturn ~XWT_TIMER_FAILED;\r\nelse\r\nreturn XWT_TIMER_FAILED;\r\n}\r\nstatic int xwdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &driver_open))\r\nreturn -EBUSY;\r\nif (xdev.nowayout)\r\n__module_get(THIS_MODULE);\r\nxwdt_start();\r\nprintk(KERN_INFO PFX "Started...\n");\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int xwdt_release(struct inode *inode, struct file *file)\r\n{\r\nif (expect_close == 42) {\r\nxwdt_stop();\r\n} else {\r\nprintk(KERN_CRIT PFX\r\n"Unexpected close, not stopping watchdog!\n");\r\nxwdt_keepalive();\r\n}\r\nclear_bit(0, &driver_open);\r\nexpect_close = 0;\r\nreturn 0;\r\n}\r\nstatic ssize_t xwdt_write(struct file *file, const char __user *buf,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nif (!xdev.nowayout) {\r\nsize_t i;\r\nexpect_close = 0;\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, buf + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nexpect_close = 42;\r\n}\r\n}\r\nxwdt_keepalive();\r\n}\r\nreturn len;\r\n}\r\nstatic long xwdt_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nint status;\r\nunion {\r\nstruct watchdog_info __user *ident;\r\nint __user *i;\r\n} uarg;\r\nuarg.i = (int __user *)arg;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nreturn copy_to_user(uarg.ident, &ident,\r\nsizeof(ident)) ? -EFAULT : 0;\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(xdev.boot_status, uarg.i);\r\ncase WDIOC_GETSTATUS:\r\nxwdt_get_status(&status);\r\nreturn put_user(status, uarg.i);\r\ncase WDIOC_KEEPALIVE:\r\nxwdt_keepalive();\r\nreturn 0;\r\ncase WDIOC_GETTIMEOUT:\r\nif (no_timeout)\r\nreturn -ENOTTY;\r\nelse\r\nreturn put_user(timeout, uarg.i);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\n}\r\nstatic int __devinit xwdt_probe(struct platform_device *pdev)\r\n{\r\nint rc;\r\nu32 *tmptr;\r\nu32 *pfreq;\r\nno_timeout = 0;\r\npfreq = (u32 *)of_get_property(pdev->dev.of_node->parent,\r\n"clock-frequency", NULL);\r\nif (pfreq == NULL) {\r\nprintk(KERN_WARNING PFX\r\n"The watchdog clock frequency cannot be obtained!\n");\r\nno_timeout = 1;\r\n}\r\nrc = of_address_to_resource(pdev->dev.of_node, 0, &xdev.res);\r\nif (rc) {\r\nprintk(KERN_WARNING PFX "invalid address!\n");\r\nreturn rc;\r\n}\r\ntmptr = (u32 *)of_get_property(pdev->dev.of_node,\r\n"xlnx,wdt-interval", NULL);\r\nif (tmptr == NULL) {\r\nprintk(KERN_WARNING PFX "Parameter \"xlnx,wdt-interval\""\r\n" not found in device tree!\n");\r\nno_timeout = 1;\r\n} else {\r\nxdev.wdt_interval = *tmptr;\r\n}\r\ntmptr = (u32 *)of_get_property(pdev->dev.of_node,\r\n"xlnx,wdt-enable-once", NULL);\r\nif (tmptr == NULL) {\r\nprintk(KERN_WARNING PFX "Parameter \"xlnx,wdt-enable-once\""\r\n" not found in device tree!\n");\r\nxdev.nowayout = WATCHDOG_NOWAYOUT;\r\n}\r\nif (!no_timeout)\r\ntimeout = 2 * ((1<<xdev.wdt_interval) / *pfreq);\r\nif (!request_mem_region(xdev.res.start,\r\nxdev.res.end - xdev.res.start + 1, WATCHDOG_NAME)) {\r\nrc = -ENXIO;\r\nprintk(KERN_ERR PFX "memory request failure!\n");\r\ngoto err_out;\r\n}\r\nxdev.base = ioremap(xdev.res.start, xdev.res.end - xdev.res.start + 1);\r\nif (xdev.base == NULL) {\r\nrc = -ENOMEM;\r\nprintk(KERN_ERR PFX "ioremap failure!\n");\r\ngoto release_mem;\r\n}\r\nrc = xwdt_selftest();\r\nif (rc == XWT_TIMER_FAILED) {\r\nprintk(KERN_ERR PFX "SelfTest routine error!\n");\r\ngoto unmap_io;\r\n}\r\nxwdt_get_status(&xdev.boot_status);\r\nrc = misc_register(&xwdt_miscdev);\r\nif (rc) {\r\nprintk(KERN_ERR PFX\r\n"cannot register miscdev on minor=%d (err=%d)\n",\r\nxwdt_miscdev.minor, rc);\r\ngoto unmap_io;\r\n}\r\nif (no_timeout)\r\nprintk(KERN_INFO PFX\r\n"driver loaded (timeout=? sec, nowayout=%d)\n",\r\nxdev.nowayout);\r\nelse\r\nprintk(KERN_INFO PFX\r\n"driver loaded (timeout=%d sec, nowayout=%d)\n",\r\ntimeout, xdev.nowayout);\r\nexpect_close = 0;\r\nclear_bit(0, &driver_open);\r\nreturn 0;\r\nunmap_io:\r\niounmap(xdev.base);\r\nrelease_mem:\r\nrelease_mem_region(xdev.res.start, resource_size(&xdev.res));\r\nerr_out:\r\nreturn rc;\r\n}\r\nstatic int __devexit xwdt_remove(struct platform_device *dev)\r\n{\r\nmisc_deregister(&xwdt_miscdev);\r\niounmap(xdev.base);\r\nrelease_mem_region(xdev.res.start, resource_size(&xdev.res));\r\nreturn 0;\r\n}\r\nstatic int __init xwdt_init(void)\r\n{\r\nreturn platform_driver_register(&xwdt_driver);\r\n}\r\nstatic void __exit xwdt_exit(void)\r\n{\r\nplatform_driver_unregister(&xwdt_driver);\r\n}

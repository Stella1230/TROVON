int key_task_permission(const key_ref_t key_ref, const struct cred *cred,\r\nkey_perm_t perm)\r\n{\r\nstruct key *key;\r\nkey_perm_t kperm;\r\nint ret;\r\nkey = key_ref_to_ptr(key_ref);\r\nif (key->user->user_ns != cred->user->user_ns)\r\ngoto use_other_perms;\r\nif (key->uid == cred->fsuid) {\r\nkperm = key->perm >> 16;\r\ngoto use_these_perms;\r\n}\r\nif (key->gid != -1 && key->perm & KEY_GRP_ALL) {\r\nif (key->gid == cred->fsgid) {\r\nkperm = key->perm >> 8;\r\ngoto use_these_perms;\r\n}\r\nret = groups_search(cred->group_info, key->gid);\r\nif (ret) {\r\nkperm = key->perm >> 8;\r\ngoto use_these_perms;\r\n}\r\n}\r\nuse_other_perms:\r\nkperm = key->perm;\r\nuse_these_perms:\r\nif (is_key_possessed(key_ref))\r\nkperm |= key->perm >> 24;\r\nkperm = kperm & perm & KEY_ALL;\r\nif (kperm != perm)\r\nreturn -EACCES;\r\nreturn security_key_permission(key_ref, cred, perm);\r\n}\r\nint key_validate(struct key *key)\r\n{\r\nstruct timespec now;\r\nint ret = 0;\r\nif (key) {\r\nret = -EKEYREVOKED;\r\nif (test_bit(KEY_FLAG_REVOKED, &key->flags) ||\r\ntest_bit(KEY_FLAG_DEAD, &key->flags))\r\ngoto error;\r\nret = 0;\r\nif (key->expiry) {\r\nnow = current_kernel_time();\r\nif (now.tv_sec >= key->expiry)\r\nret = -EKEYEXPIRED;\r\n}\r\n}\r\nerror:\r\nreturn ret;\r\n}

void iwl4965_rx_missed_beacon_notif(struct iwl_priv *priv,\r\nstruct iwl_rx_mem_buffer *rxb)\r\n{\r\nstruct iwl_rx_packet *pkt = rxb_addr(rxb);\r\nstruct iwl_missed_beacon_notif *missed_beacon;\r\nmissed_beacon = &pkt->u.missed_beacon;\r\nif (le32_to_cpu(missed_beacon->consecutive_missed_beacons) >\r\npriv->missed_beacon_threshold) {\r\nIWL_DEBUG_CALIB(priv,\r\n"missed bcn cnsq %d totl %d rcd %d expctd %d\n",\r\nle32_to_cpu(missed_beacon->consecutive_missed_beacons),\r\nle32_to_cpu(missed_beacon->total_missed_becons),\r\nle32_to_cpu(missed_beacon->num_recvd_beacons),\r\nle32_to_cpu(missed_beacon->num_expected_beacons));\r\nif (!test_bit(STATUS_SCANNING, &priv->status))\r\niwl4965_init_sensitivity(priv);\r\n}\r\n}\r\nstatic void iwl4965_rx_calc_noise(struct iwl_priv *priv)\r\n{\r\nstruct statistics_rx_non_phy *rx_info;\r\nint num_active_rx = 0;\r\nint total_silence = 0;\r\nint bcn_silence_a, bcn_silence_b, bcn_silence_c;\r\nint last_rx_noise;\r\nrx_info = &(priv->_4965.statistics.rx.general);\r\nbcn_silence_a =\r\nle32_to_cpu(rx_info->beacon_silence_rssi_a) & IN_BAND_FILTER;\r\nbcn_silence_b =\r\nle32_to_cpu(rx_info->beacon_silence_rssi_b) & IN_BAND_FILTER;\r\nbcn_silence_c =\r\nle32_to_cpu(rx_info->beacon_silence_rssi_c) & IN_BAND_FILTER;\r\nif (bcn_silence_a) {\r\ntotal_silence += bcn_silence_a;\r\nnum_active_rx++;\r\n}\r\nif (bcn_silence_b) {\r\ntotal_silence += bcn_silence_b;\r\nnum_active_rx++;\r\n}\r\nif (bcn_silence_c) {\r\ntotal_silence += bcn_silence_c;\r\nnum_active_rx++;\r\n}\r\nif (num_active_rx)\r\nlast_rx_noise = (total_silence / num_active_rx) - 107;\r\nelse\r\nlast_rx_noise = IWL_NOISE_MEAS_NOT_AVAILABLE;\r\nIWL_DEBUG_CALIB(priv, "inband silence a %u, b %u, c %u, dBm %d\n",\r\nbcn_silence_a, bcn_silence_b, bcn_silence_c,\r\nlast_rx_noise);\r\n}\r\nstatic void iwl4965_accumulative_statistics(struct iwl_priv *priv,\r\n__le32 *stats)\r\n{\r\nint i, size;\r\n__le32 *prev_stats;\r\nu32 *accum_stats;\r\nu32 *delta, *max_delta;\r\nstruct statistics_general_common *general, *accum_general;\r\nstruct statistics_tx *tx, *accum_tx;\r\nprev_stats = (__le32 *)&priv->_4965.statistics;\r\naccum_stats = (u32 *)&priv->_4965.accum_statistics;\r\nsize = sizeof(struct iwl_notif_statistics);\r\ngeneral = &priv->_4965.statistics.general.common;\r\naccum_general = &priv->_4965.accum_statistics.general.common;\r\ntx = &priv->_4965.statistics.tx;\r\naccum_tx = &priv->_4965.accum_statistics.tx;\r\ndelta = (u32 *)&priv->_4965.delta_statistics;\r\nmax_delta = (u32 *)&priv->_4965.max_delta;\r\nfor (i = sizeof(__le32); i < size;\r\ni += sizeof(__le32), stats++, prev_stats++, delta++,\r\nmax_delta++, accum_stats++) {\r\nif (le32_to_cpu(*stats) > le32_to_cpu(*prev_stats)) {\r\n*delta = (le32_to_cpu(*stats) -\r\nle32_to_cpu(*prev_stats));\r\n*accum_stats += *delta;\r\nif (*delta > *max_delta)\r\n*max_delta = *delta;\r\n}\r\n}\r\naccum_general->temperature = general->temperature;\r\naccum_general->ttl_timestamp = general->ttl_timestamp;\r\n}\r\nvoid iwl4965_rx_statistics(struct iwl_priv *priv,\r\nstruct iwl_rx_mem_buffer *rxb)\r\n{\r\nint change;\r\nstruct iwl_rx_packet *pkt = rxb_addr(rxb);\r\nIWL_DEBUG_RX(priv,\r\n"Statistics notification received (%d vs %d).\n",\r\n(int)sizeof(struct iwl_notif_statistics),\r\nle32_to_cpu(pkt->len_n_flags) &\r\nFH_RSCSR_FRAME_SIZE_MSK);\r\nchange = ((priv->_4965.statistics.general.common.temperature !=\r\npkt->u.stats.general.common.temperature) ||\r\n((priv->_4965.statistics.flag &\r\nSTATISTICS_REPLY_FLG_HT40_MODE_MSK) !=\r\n(pkt->u.stats.flag &\r\nSTATISTICS_REPLY_FLG_HT40_MODE_MSK)));\r\n#ifdef CONFIG_IWLWIFI_LEGACY_DEBUGFS\r\niwl4965_accumulative_statistics(priv, (__le32 *)&pkt->u.stats);\r\n#endif\r\nmemcpy(&priv->_4965.statistics, &pkt->u.stats,\r\nsizeof(priv->_4965.statistics));\r\nset_bit(STATUS_STATISTICS, &priv->status);\r\nmod_timer(&priv->statistics_periodic, jiffies +\r\nmsecs_to_jiffies(REG_RECALIB_PERIOD * 1000));\r\nif (unlikely(!test_bit(STATUS_SCANNING, &priv->status)) &&\r\n(pkt->hdr.cmd == STATISTICS_NOTIFICATION)) {\r\niwl4965_rx_calc_noise(priv);\r\nqueue_work(priv->workqueue, &priv->run_time_calib_work);\r\n}\r\nif (priv->cfg->ops->lib->temp_ops.temperature && change)\r\npriv->cfg->ops->lib->temp_ops.temperature(priv);\r\n}\r\nvoid iwl4965_reply_statistics(struct iwl_priv *priv,\r\nstruct iwl_rx_mem_buffer *rxb)\r\n{\r\nstruct iwl_rx_packet *pkt = rxb_addr(rxb);\r\nif (le32_to_cpu(pkt->u.stats.flag) & UCODE_STATISTICS_CLEAR_MSK) {\r\n#ifdef CONFIG_IWLWIFI_LEGACY_DEBUGFS\r\nmemset(&priv->_4965.accum_statistics, 0,\r\nsizeof(struct iwl_notif_statistics));\r\nmemset(&priv->_4965.delta_statistics, 0,\r\nsizeof(struct iwl_notif_statistics));\r\nmemset(&priv->_4965.max_delta, 0,\r\nsizeof(struct iwl_notif_statistics));\r\n#endif\r\nIWL_DEBUG_RX(priv, "Statistics have been cleared\n");\r\n}\r\niwl4965_rx_statistics(priv, rxb);\r\n}

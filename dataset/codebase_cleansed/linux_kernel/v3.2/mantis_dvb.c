int mantis_frontend_power(struct mantis_pci *mantis, enum mantis_power power)\r\n{\r\nstruct mantis_hwconfig *config = mantis->hwconfig;\r\nswitch (power) {\r\ncase POWER_ON:\r\ndprintk(MANTIS_DEBUG, 1, "Power ON");\r\nmantis_gpio_set_bits(mantis, config->power, POWER_ON);\r\nmsleep(100);\r\nmantis_gpio_set_bits(mantis, config->power, POWER_ON);\r\nmsleep(100);\r\nbreak;\r\ncase POWER_OFF:\r\ndprintk(MANTIS_DEBUG, 1, "Power OFF");\r\nmantis_gpio_set_bits(mantis, config->power, POWER_OFF);\r\nmsleep(100);\r\nbreak;\r\ndefault:\r\ndprintk(MANTIS_DEBUG, 1, "Unknown state <%02x>", power);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nvoid mantis_frontend_soft_reset(struct mantis_pci *mantis)\r\n{\r\nstruct mantis_hwconfig *config = mantis->hwconfig;\r\ndprintk(MANTIS_DEBUG, 1, "Frontend RESET");\r\nmantis_gpio_set_bits(mantis, config->reset, 0);\r\nmsleep(100);\r\nmantis_gpio_set_bits(mantis, config->reset, 0);\r\nmsleep(100);\r\nmantis_gpio_set_bits(mantis, config->reset, 1);\r\nmsleep(100);\r\nmantis_gpio_set_bits(mantis, config->reset, 1);\r\nmsleep(100);\r\nreturn;\r\n}\r\nstatic int mantis_frontend_shutdown(struct mantis_pci *mantis)\r\n{\r\nint err;\r\nmantis_frontend_soft_reset(mantis);\r\nerr = mantis_frontend_power(mantis, POWER_OFF);\r\nif (err != 0) {\r\ndprintk(MANTIS_ERROR, 1, "Frontend POWER OFF failed! <%d>", err);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mantis_dvb_start_feed(struct dvb_demux_feed *dvbdmxfeed)\r\n{\r\nstruct dvb_demux *dvbdmx = dvbdmxfeed->demux;\r\nstruct mantis_pci *mantis = dvbdmx->priv;\r\ndprintk(MANTIS_DEBUG, 1, "Mantis DVB Start feed");\r\nif (!dvbdmx->dmx.frontend) {\r\ndprintk(MANTIS_DEBUG, 1, "no frontend ?");\r\nreturn -EINVAL;\r\n}\r\nmantis->feeds++;\r\ndprintk(MANTIS_DEBUG, 1, "mantis start feed, feeds=%d", mantis->feeds);\r\nif (mantis->feeds == 1) {\r\ndprintk(MANTIS_DEBUG, 1, "mantis start feed & dma");\r\nmantis_dma_start(mantis);\r\ntasklet_enable(&mantis->tasklet);\r\n}\r\nreturn mantis->feeds;\r\n}\r\nstatic int mantis_dvb_stop_feed(struct dvb_demux_feed *dvbdmxfeed)\r\n{\r\nstruct dvb_demux *dvbdmx = dvbdmxfeed->demux;\r\nstruct mantis_pci *mantis = dvbdmx->priv;\r\ndprintk(MANTIS_DEBUG, 1, "Mantis DVB Stop feed");\r\nif (!dvbdmx->dmx.frontend) {\r\ndprintk(MANTIS_DEBUG, 1, "no frontend ?");\r\nreturn -EINVAL;\r\n}\r\nmantis->feeds--;\r\nif (mantis->feeds == 0) {\r\ndprintk(MANTIS_DEBUG, 1, "mantis stop feed and dma");\r\ntasklet_disable(&mantis->tasklet);\r\nmantis_dma_stop(mantis);\r\n}\r\nreturn 0;\r\n}\r\nint __devinit mantis_dvb_init(struct mantis_pci *mantis)\r\n{\r\nstruct mantis_hwconfig *config = mantis->hwconfig;\r\nint result = -1;\r\ndprintk(MANTIS_DEBUG, 1, "dvb_register_adapter");\r\nresult = dvb_register_adapter(&mantis->dvb_adapter,\r\n"Mantis DVB adapter",\r\nTHIS_MODULE,\r\n&mantis->pdev->dev,\r\nadapter_nr);\r\nif (result < 0) {\r\ndprintk(MANTIS_ERROR, 1, "Error registering adapter");\r\nreturn -ENODEV;\r\n}\r\nmantis->dvb_adapter.priv = mantis;\r\nmantis->demux.dmx.capabilities = DMX_TS_FILTERING |\r\nDMX_SECTION_FILTERING |\r\nDMX_MEMORY_BASED_FILTERING;\r\nmantis->demux.priv = mantis;\r\nmantis->demux.filternum = 256;\r\nmantis->demux.feednum = 256;\r\nmantis->demux.start_feed = mantis_dvb_start_feed;\r\nmantis->demux.stop_feed = mantis_dvb_stop_feed;\r\nmantis->demux.write_to_decoder = NULL;\r\ndprintk(MANTIS_DEBUG, 1, "dvb_dmx_init");\r\nresult = dvb_dmx_init(&mantis->demux);\r\nif (result < 0) {\r\ndprintk(MANTIS_ERROR, 1, "dvb_dmx_init failed, ERROR=%d", result);\r\ngoto err0;\r\n}\r\nmantis->dmxdev.filternum = 256;\r\nmantis->dmxdev.demux = &mantis->demux.dmx;\r\nmantis->dmxdev.capabilities = 0;\r\ndprintk(MANTIS_DEBUG, 1, "dvb_dmxdev_init");\r\nresult = dvb_dmxdev_init(&mantis->dmxdev, &mantis->dvb_adapter);\r\nif (result < 0) {\r\ndprintk(MANTIS_ERROR, 1, "dvb_dmxdev_init failed, ERROR=%d", result);\r\ngoto err1;\r\n}\r\nmantis->fe_hw.source = DMX_FRONTEND_0;\r\nresult = mantis->demux.dmx.add_frontend(&mantis->demux.dmx, &mantis->fe_hw);\r\nif (result < 0) {\r\ndprintk(MANTIS_ERROR, 1, "dvb_dmx_init failed, ERROR=%d", result);\r\ngoto err2;\r\n}\r\nmantis->fe_mem.source = DMX_MEMORY_FE;\r\nresult = mantis->demux.dmx.add_frontend(&mantis->demux.dmx, &mantis->fe_mem);\r\nif (result < 0) {\r\ndprintk(MANTIS_ERROR, 1, "dvb_dmx_init failed, ERROR=%d", result);\r\ngoto err3;\r\n}\r\nresult = mantis->demux.dmx.connect_frontend(&mantis->demux.dmx, &mantis->fe_hw);\r\nif (result < 0) {\r\ndprintk(MANTIS_ERROR, 1, "dvb_dmx_init failed, ERROR=%d", result);\r\ngoto err4;\r\n}\r\ndvb_net_init(&mantis->dvb_adapter, &mantis->dvbnet, &mantis->demux.dmx);\r\ntasklet_init(&mantis->tasklet, mantis_dma_xfer, (unsigned long) mantis);\r\ntasklet_disable(&mantis->tasklet);\r\nif (mantis->hwconfig) {\r\nresult = config->frontend_init(mantis, mantis->fe);\r\nif (result < 0) {\r\ndprintk(MANTIS_ERROR, 1, "!!! NO Frontends found !!!");\r\ngoto err5;\r\n} else {\r\nif (mantis->fe == NULL) {\r\ndprintk(MANTIS_ERROR, 1, "FE <NULL>");\r\ngoto err5;\r\n}\r\nif (dvb_register_frontend(&mantis->dvb_adapter, mantis->fe)) {\r\ndprintk(MANTIS_ERROR, 1, "ERROR: Frontend registration failed");\r\nif (mantis->fe->ops.release)\r\nmantis->fe->ops.release(mantis->fe);\r\nmantis->fe = NULL;\r\ngoto err5;\r\n}\r\n}\r\n}\r\nreturn 0;\r\nerr5:\r\ntasklet_kill(&mantis->tasklet);\r\ndvb_net_release(&mantis->dvbnet);\r\ndvb_unregister_frontend(mantis->fe);\r\ndvb_frontend_detach(mantis->fe);\r\nerr4:\r\nmantis->demux.dmx.remove_frontend(&mantis->demux.dmx, &mantis->fe_mem);\r\nerr3:\r\nmantis->demux.dmx.remove_frontend(&mantis->demux.dmx, &mantis->fe_hw);\r\nerr2:\r\ndvb_dmxdev_release(&mantis->dmxdev);\r\nerr1:\r\ndvb_dmx_release(&mantis->demux);\r\nerr0:\r\ndvb_unregister_adapter(&mantis->dvb_adapter);\r\nreturn result;\r\n}\r\nint __devexit mantis_dvb_exit(struct mantis_pci *mantis)\r\n{\r\nint err;\r\nif (mantis->fe) {\r\nerr = mantis_frontend_shutdown(mantis);\r\nif (err != 0)\r\ndprintk(MANTIS_ERROR, 1, "Frontend exit while POWER ON! <%d>", err);\r\ndvb_unregister_frontend(mantis->fe);\r\ndvb_frontend_detach(mantis->fe);\r\n}\r\ntasklet_kill(&mantis->tasklet);\r\ndvb_net_release(&mantis->dvbnet);\r\nmantis->demux.dmx.remove_frontend(&mantis->demux.dmx, &mantis->fe_mem);\r\nmantis->demux.dmx.remove_frontend(&mantis->demux.dmx, &mantis->fe_hw);\r\ndvb_dmxdev_release(&mantis->dmxdev);\r\ndvb_dmx_release(&mantis->demux);\r\ndprintk(MANTIS_DEBUG, 1, "dvb_unregister_adapter");\r\ndvb_unregister_adapter(&mantis->dvb_adapter);\r\nreturn 0;\r\n}

static void tt_write_vol(struct terratec *tt, int volume)\r\n{\r\nint i;\r\nvolume = volume + (volume * 32);\r\nmutex_lock(&tt->lock);\r\nfor (i = 0; i < 8; i++) {\r\nif (volume & (0x80 >> i))\r\noutb(0x80, tt->io + 1);\r\nelse\r\noutb(0x00, tt->io + 1);\r\n}\r\nmutex_unlock(&tt->lock);\r\n}\r\nstatic void tt_mute(struct terratec *tt)\r\n{\r\ntt->muted = 1;\r\ntt_write_vol(tt, 0);\r\n}\r\nstatic int tt_setvol(struct terratec *tt, int vol)\r\n{\r\nif (vol == tt->curvol) {\r\nif (tt->muted) {\r\ntt->muted = 0;\r\ntt_write_vol(tt, vol);\r\n}\r\nreturn 0;\r\n}\r\nif (vol == 0) {\r\ntt_write_vol(tt, 0);\r\ntt->curvol = vol;\r\nreturn 0;\r\n}\r\ntt->muted = 0;\r\ntt_write_vol(tt, vol);\r\ntt->curvol = vol;\r\nreturn 0;\r\n}\r\nstatic int tt_setfreq(struct terratec *tt, unsigned long freq1)\r\n{\r\nint freq;\r\nint i;\r\nint p;\r\nint temp;\r\nlong rest;\r\nunsigned char buffer[25];\r\nmutex_lock(&tt->lock);\r\ntt->curfreq = freq1;\r\nfreq = freq1 / 160;\r\nmemset(buffer, 0, sizeof(buffer));\r\nrest = freq * 10 + 10700;\r\ni = 13;\r\np = 10;\r\ntemp = 102400;\r\nwhile (rest != 0) {\r\nif (rest % temp == rest)\r\nbuffer[i] = 0;\r\nelse {\r\nbuffer[i] = 1;\r\nrest = rest - temp;\r\n}\r\ni--;\r\np--;\r\ntemp = temp / 2;\r\n}\r\nfor (i = 24; i > -1; i--) {\r\nif (buffer[i] == 1) {\r\noutb(WRT_EN | DATA, tt->io);\r\noutb(WRT_EN | DATA | CLK_ON, tt->io);\r\noutb(WRT_EN | DATA, tt->io);\r\n} else {\r\noutb(WRT_EN | 0x00, tt->io);\r\noutb(WRT_EN | 0x00 | CLK_ON, tt->io);\r\n}\r\n}\r\noutb(0x00, tt->io);\r\nmutex_unlock(&tt->lock);\r\nreturn 0;\r\n}\r\nstatic int tt_getsigstr(struct terratec *tt)\r\n{\r\nif (inb(tt->io) & 2)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int vidioc_querycap(struct file *file, void *priv,\r\nstruct v4l2_capability *v)\r\n{\r\nstrlcpy(v->driver, "radio-terratec", sizeof(v->driver));\r\nstrlcpy(v->card, "ActiveRadio", sizeof(v->card));\r\nstrlcpy(v->bus_info, "ISA", sizeof(v->bus_info));\r\nv->capabilities = V4L2_CAP_TUNER | V4L2_CAP_RADIO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nstruct terratec *tt = video_drvdata(file);\r\nif (v->index > 0)\r\nreturn -EINVAL;\r\nstrlcpy(v->name, "FM", sizeof(v->name));\r\nv->type = V4L2_TUNER_RADIO;\r\nv->rangelow = 87 * 16000;\r\nv->rangehigh = 108 * 16000;\r\nv->rxsubchans = V4L2_TUNER_SUB_MONO;\r\nv->capability = V4L2_TUNER_CAP_LOW;\r\nv->audmode = V4L2_TUNER_MODE_MONO;\r\nv->signal = 0xFFFF * tt_getsigstr(tt);\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nreturn v->index ? -EINVAL : 0;\r\n}\r\nstatic int vidioc_s_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct terratec *tt = video_drvdata(file);\r\nif (f->tuner != 0 || f->type != V4L2_TUNER_RADIO)\r\nreturn -EINVAL;\r\ntt_setfreq(tt, f->frequency);\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct terratec *tt = video_drvdata(file);\r\nif (f->tuner != 0)\r\nreturn -EINVAL;\r\nf->type = V4L2_TUNER_RADIO;\r\nf->frequency = tt->curfreq;\r\nreturn 0;\r\n}\r\nstatic int vidioc_queryctrl(struct file *file, void *priv,\r\nstruct v4l2_queryctrl *qc)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(radio_qctrl); i++) {\r\nif (qc->id && qc->id == radio_qctrl[i].id) {\r\nmemcpy(qc, &(radio_qctrl[i]), sizeof(*qc));\r\nreturn 0;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_g_ctrl(struct file *file, void *priv,\r\nstruct v4l2_control *ctrl)\r\n{\r\nstruct terratec *tt = video_drvdata(file);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nif (tt->muted)\r\nctrl->value = 1;\r\nelse\r\nctrl->value = 0;\r\nreturn 0;\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nctrl->value = tt->curvol * 6554;\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_s_ctrl(struct file *file, void *priv,\r\nstruct v4l2_control *ctrl)\r\n{\r\nstruct terratec *tt = video_drvdata(file);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nif (ctrl->value)\r\ntt_mute(tt);\r\nelse\r\ntt_setvol(tt,tt->curvol);\r\nreturn 0;\r\ncase V4L2_CID_AUDIO_VOLUME:\r\ntt_setvol(tt,ctrl->value);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_g_input(struct file *filp, void *priv, unsigned int *i)\r\n{\r\n*i = 0;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_input(struct file *filp, void *priv, unsigned int i)\r\n{\r\nreturn i ? -EINVAL : 0;\r\n}\r\nstatic int vidioc_g_audio(struct file *file, void *priv,\r\nstruct v4l2_audio *a)\r\n{\r\na->index = 0;\r\nstrlcpy(a->name, "Radio", sizeof(a->name));\r\na->capability = V4L2_AUDCAP_STEREO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_audio(struct file *file, void *priv,\r\nstruct v4l2_audio *a)\r\n{\r\nreturn a->index ? -EINVAL : 0;\r\n}\r\nstatic int __init terratec_init(void)\r\n{\r\nstruct terratec *tt = &terratec_card;\r\nstruct v4l2_device *v4l2_dev = &tt->v4l2_dev;\r\nint res;\r\nstrlcpy(v4l2_dev->name, "terratec", sizeof(v4l2_dev->name));\r\ntt->io = io;\r\nif (tt->io == -1) {\r\nv4l2_err(v4l2_dev, "you must set an I/O address with io=0x590 or 0x591\n");\r\nreturn -EINVAL;\r\n}\r\nif (!request_region(tt->io, 2, "terratec")) {\r\nv4l2_err(v4l2_dev, "port 0x%x already in use\n", io);\r\nreturn -EBUSY;\r\n}\r\nres = v4l2_device_register(NULL, v4l2_dev);\r\nif (res < 0) {\r\nrelease_region(tt->io, 2);\r\nv4l2_err(v4l2_dev, "Could not register v4l2_device\n");\r\nreturn res;\r\n}\r\nstrlcpy(tt->vdev.name, v4l2_dev->name, sizeof(tt->vdev.name));\r\ntt->vdev.v4l2_dev = v4l2_dev;\r\ntt->vdev.fops = &terratec_fops;\r\ntt->vdev.ioctl_ops = &terratec_ioctl_ops;\r\ntt->vdev.release = video_device_release_empty;\r\nvideo_set_drvdata(&tt->vdev, tt);\r\nmutex_init(&tt->lock);\r\ntt_write_vol(tt, 0);\r\nif (video_register_device(&tt->vdev, VFL_TYPE_RADIO, radio_nr) < 0) {\r\nv4l2_device_unregister(&tt->v4l2_dev);\r\nrelease_region(tt->io, 2);\r\nreturn -EINVAL;\r\n}\r\nv4l2_info(v4l2_dev, "TERRATEC ActivRadio Standalone card driver.\n");\r\nreturn 0;\r\n}\r\nstatic void __exit terratec_exit(void)\r\n{\r\nstruct terratec *tt = &terratec_card;\r\nstruct v4l2_device *v4l2_dev = &tt->v4l2_dev;\r\nvideo_unregister_device(&tt->vdev);\r\nv4l2_device_unregister(&tt->v4l2_dev);\r\nrelease_region(tt->io, 2);\r\nv4l2_info(v4l2_dev, "TERRATEC ActivRadio Standalone card driver unloaded.\n");\r\n}

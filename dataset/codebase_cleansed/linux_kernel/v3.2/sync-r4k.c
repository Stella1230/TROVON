void __cpuinit synchronise_count_master(void)\r\n{\r\nint i;\r\nunsigned long flags;\r\nunsigned int initcount;\r\nint nslaves;\r\n#ifdef CONFIG_MIPS_MT_SMTC\r\nreturn;\r\n#endif\r\nprintk(KERN_INFO "Synchronize counters across %u CPUs: ",\r\nnum_online_cpus());\r\nlocal_irq_save(flags);\r\natomic_set(&count_reference, read_c0_count());\r\natomic_set(&count_start_flag, 1);\r\nsmp_wmb();\r\ninitcount = read_c0_count();\r\nnslaves = num_online_cpus()-1;\r\nfor (i = 0; i < NR_LOOPS; i++) {\r\nwhile (atomic_read(&count_count_start) != nslaves)\r\nmb();\r\natomic_set(&count_count_stop, 0);\r\nsmp_wmb();\r\natomic_inc(&count_count_start);\r\nif (i == NR_LOOPS-1)\r\nwrite_c0_count(initcount);\r\nwhile (atomic_read(&count_count_stop) != nslaves)\r\nmb();\r\natomic_set(&count_count_start, 0);\r\nsmp_wmb();\r\natomic_inc(&count_count_stop);\r\n}\r\nwrite_c0_compare(read_c0_count() + COUNTON);\r\nlocal_irq_restore(flags);\r\nprintk("done.\n");\r\n}\r\nvoid __cpuinit synchronise_count_slave(void)\r\n{\r\nint i;\r\nunsigned long flags;\r\nunsigned int initcount;\r\nint ncpus;\r\n#ifdef CONFIG_MIPS_MT_SMTC\r\nreturn;\r\n#endif\r\nlocal_irq_save(flags);\r\nwhile (!atomic_read(&count_start_flag))\r\nmb();\r\ninitcount = atomic_read(&count_reference);\r\nncpus = num_online_cpus();\r\nfor (i = 0; i < NR_LOOPS; i++) {\r\natomic_inc(&count_count_start);\r\nwhile (atomic_read(&count_count_start) != ncpus)\r\nmb();\r\nif (i == NR_LOOPS-1)\r\nwrite_c0_count(initcount);\r\natomic_inc(&count_count_stop);\r\nwhile (atomic_read(&count_count_stop) != ncpus)\r\nmb();\r\n}\r\nwrite_c0_compare(read_c0_count() + COUNTON);\r\nlocal_irq_restore(flags);\r\n}

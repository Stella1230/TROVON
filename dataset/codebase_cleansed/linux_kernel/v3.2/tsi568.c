static int\r\ntsi568_route_add_entry(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu16 table, u16 route_destid, u8 route_port)\r\n{\r\nif (table == RIO_GLOBAL_TABLE) {\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPBC_ROUTE_CFG_DESTID, route_destid);\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPBC_ROUTE_CFG_PORT, route_port);\r\n} else {\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPP_ROUTE_CFG_DESTID(table),\r\nroute_destid);\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPP_ROUTE_CFG_PORT(table), route_port);\r\n}\r\nudelay(10);\r\nreturn 0;\r\n}\r\nstatic int\r\ntsi568_route_get_entry(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu16 table, u16 route_destid, u8 *route_port)\r\n{\r\nint ret = 0;\r\nu32 result;\r\nif (table == RIO_GLOBAL_TABLE) {\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPBC_ROUTE_CFG_DESTID, route_destid);\r\nrio_mport_read_config_32(mport, destid, hopcount,\r\nSPBC_ROUTE_CFG_PORT, &result);\r\n} else {\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPP_ROUTE_CFG_DESTID(table),\r\nroute_destid);\r\nrio_mport_read_config_32(mport, destid, hopcount,\r\nSPP_ROUTE_CFG_PORT(table), &result);\r\n}\r\n*route_port = result;\r\nif (*route_port > 15)\r\nret = -1;\r\nreturn ret;\r\n}\r\nstatic int\r\ntsi568_route_clr_table(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu16 table)\r\n{\r\nu32 route_idx;\r\nu32 lut_size;\r\nlut_size = (mport->sys_size) ? 0x1ff : 0xff;\r\nif (table == RIO_GLOBAL_TABLE) {\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPBC_ROUTE_CFG_DESTID, 0x80000000);\r\nfor (route_idx = 0; route_idx <= lut_size; route_idx++)\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPBC_ROUTE_CFG_PORT,\r\nRIO_INVALID_ROUTE);\r\n} else {\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPP_ROUTE_CFG_DESTID(table),\r\n0x80000000);\r\nfor (route_idx = 0; route_idx <= lut_size; route_idx++)\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nSPP_ROUTE_CFG_PORT(table),\r\nRIO_INVALID_ROUTE);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\ntsi568_em_init(struct rio_dev *rdev)\r\n{\r\nu32 regval;\r\nint portnum;\r\npr_debug("TSI568 %s [%d:%d]\n", __func__, rdev->destid, rdev->hopcount);\r\nfor (portnum = 0;\r\nportnum < RIO_GET_TOTAL_PORTS(rdev->swpinfo); portnum++) {\r\nrio_read_config_32(rdev, TSI568_SP_MODE(portnum), &regval);\r\nrio_write_config_32(rdev, TSI568_SP_MODE(portnum),\r\nregval | TSI568_SP_MODE_PW_DIS);\r\n}\r\nreturn 0;\r\n}\r\nstatic int tsi568_switch_init(struct rio_dev *rdev, int do_enum)\r\n{\r\npr_debug("RIO: %s for %s\n", __func__, rio_name(rdev));\r\nrdev->rswitch->add_entry = tsi568_route_add_entry;\r\nrdev->rswitch->get_entry = tsi568_route_get_entry;\r\nrdev->rswitch->clr_table = tsi568_route_clr_table;\r\nrdev->rswitch->set_domain = NULL;\r\nrdev->rswitch->get_domain = NULL;\r\nrdev->rswitch->em_init = tsi568_em_init;\r\nrdev->rswitch->em_handle = NULL;\r\nreturn 0;\r\n}

static int max1111_read(struct device *dev, int channel)\r\n{\r\nstruct max1111_data *data = dev_get_drvdata(dev);\r\nuint8_t v1, v2;\r\nint err;\r\nmutex_lock(&data->drvdata_lock);\r\ndata->tx_buf[0] = (channel << MAX1111_CTRL_SEL_SH) |\r\nMAX1111_CTRL_PD0 | MAX1111_CTRL_PD1 |\r\nMAX1111_CTRL_SGL | MAX1111_CTRL_UNI | MAX1111_CTRL_STR;\r\nerr = spi_sync(data->spi, &data->msg);\r\nif (err < 0) {\r\ndev_err(dev, "spi_sync failed with %d\n", err);\r\nmutex_unlock(&data->drvdata_lock);\r\nreturn err;\r\n}\r\nv1 = data->rx_buf[0];\r\nv2 = data->rx_buf[1];\r\nmutex_unlock(&data->drvdata_lock);\r\nif ((v1 & 0xc0) || (v2 & 0x3f))\r\nreturn -EINVAL;\r\nreturn (v1 << 2) | (v2 >> 6);\r\n}\r\nint max1111_read_channel(int channel)\r\n{\r\nreturn max1111_read(&the_max1111->spi->dev, channel);\r\n}\r\nstatic ssize_t show_name(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "max1111\n");\r\n}\r\nstatic ssize_t show_adc(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nint channel = to_sensor_dev_attr(attr)->index;\r\nint ret;\r\nret = max1111_read(dev, channel);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", ret);\r\n}\r\nstatic int __devinit setup_transfer(struct max1111_data *data)\r\n{\r\nstruct spi_message *m;\r\nstruct spi_transfer *x;\r\nm = &data->msg;\r\nx = &data->xfer[0];\r\nspi_message_init(m);\r\nx->tx_buf = &data->tx_buf[0];\r\nx->len = MAX1111_TX_BUF_SIZE;\r\nspi_message_add_tail(x, m);\r\nx++;\r\nx->rx_buf = &data->rx_buf[0];\r\nx->len = MAX1111_RX_BUF_SIZE;\r\nspi_message_add_tail(x, m);\r\nreturn 0;\r\n}\r\nstatic int __devinit max1111_probe(struct spi_device *spi)\r\n{\r\nstruct max1111_data *data;\r\nint err;\r\nspi->bits_per_word = 8;\r\nspi->mode = SPI_MODE_0;\r\nerr = spi_setup(spi);\r\nif (err < 0)\r\nreturn err;\r\ndata = kzalloc(sizeof(struct max1111_data), GFP_KERNEL);\r\nif (data == NULL) {\r\ndev_err(&spi->dev, "failed to allocate memory\n");\r\nreturn -ENOMEM;\r\n}\r\nerr = setup_transfer(data);\r\nif (err)\r\ngoto err_free_data;\r\nmutex_init(&data->drvdata_lock);\r\ndata->spi = spi;\r\nspi_set_drvdata(spi, data);\r\nerr = sysfs_create_group(&spi->dev.kobj, &max1111_attr_group);\r\nif (err) {\r\ndev_err(&spi->dev, "failed to create attribute group\n");\r\ngoto err_free_data;\r\n}\r\ndata->hwmon_dev = hwmon_device_register(&spi->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\ndev_err(&spi->dev, "failed to create hwmon device\n");\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto err_remove;\r\n}\r\n#ifdef CONFIG_SHARPSL_PM\r\nthe_max1111 = data;\r\n#endif\r\nreturn 0;\r\nerr_remove:\r\nsysfs_remove_group(&spi->dev.kobj, &max1111_attr_group);\r\nerr_free_data:\r\nkfree(data);\r\nreturn err;\r\n}\r\nstatic int __devexit max1111_remove(struct spi_device *spi)\r\n{\r\nstruct max1111_data *data = spi_get_drvdata(spi);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nsysfs_remove_group(&spi->dev.kobj, &max1111_attr_group);\r\nmutex_destroy(&data->drvdata_lock);\r\nkfree(data);\r\nreturn 0;\r\n}\r\nstatic int __init max1111_init(void)\r\n{\r\nreturn spi_register_driver(&max1111_driver);\r\n}\r\nstatic void __exit max1111_exit(void)\r\n{\r\nspi_unregister_driver(&max1111_driver);\r\n}

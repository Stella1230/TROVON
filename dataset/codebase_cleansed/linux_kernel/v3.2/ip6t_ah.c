static inline bool\r\nspi_match(u_int32_t min, u_int32_t max, u_int32_t spi, bool invert)\r\n{\r\nbool r;\r\npr_debug("spi_match:%c 0x%x <= 0x%x <= 0x%x\n",\r\ninvert ? '!' : ' ', min, spi, max);\r\nr = (spi >= min && spi <= max) ^ invert;\r\npr_debug(" result %s\n", r ? "PASS" : "FAILED");\r\nreturn r;\r\n}\r\nstatic bool ah_mt6(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nstruct ip_auth_hdr _ah;\r\nconst struct ip_auth_hdr *ah;\r\nconst struct ip6t_ah *ahinfo = par->matchinfo;\r\nunsigned int ptr;\r\nunsigned int hdrlen = 0;\r\nint err;\r\nerr = ipv6_find_hdr(skb, &ptr, NEXTHDR_AUTH, NULL);\r\nif (err < 0) {\r\nif (err != -ENOENT)\r\npar->hotdrop = true;\r\nreturn false;\r\n}\r\nah = skb_header_pointer(skb, ptr, sizeof(_ah), &_ah);\r\nif (ah == NULL) {\r\npar->hotdrop = true;\r\nreturn false;\r\n}\r\nhdrlen = (ah->hdrlen + 2) << 2;\r\npr_debug("IPv6 AH LEN %u %u ", hdrlen, ah->hdrlen);\r\npr_debug("RES %04X ", ah->reserved);\r\npr_debug("SPI %u %08X\n", ntohl(ah->spi), ntohl(ah->spi));\r\npr_debug("IPv6 AH spi %02X ",\r\nspi_match(ahinfo->spis[0], ahinfo->spis[1],\r\nntohl(ah->spi),\r\n!!(ahinfo->invflags & IP6T_AH_INV_SPI)));\r\npr_debug("len %02X %04X %02X ",\r\nahinfo->hdrlen, hdrlen,\r\n(!ahinfo->hdrlen ||\r\n(ahinfo->hdrlen == hdrlen) ^\r\n!!(ahinfo->invflags & IP6T_AH_INV_LEN)));\r\npr_debug("res %02X %04X %02X\n",\r\nahinfo->hdrres, ah->reserved,\r\n!(ahinfo->hdrres && ah->reserved));\r\nreturn (ah != NULL) &&\r\nspi_match(ahinfo->spis[0], ahinfo->spis[1],\r\nntohl(ah->spi),\r\n!!(ahinfo->invflags & IP6T_AH_INV_SPI)) &&\r\n(!ahinfo->hdrlen ||\r\n(ahinfo->hdrlen == hdrlen) ^\r\n!!(ahinfo->invflags & IP6T_AH_INV_LEN)) &&\r\n!(ahinfo->hdrres && ah->reserved);\r\n}\r\nstatic int ah_mt6_check(const struct xt_mtchk_param *par)\r\n{\r\nconst struct ip6t_ah *ahinfo = par->matchinfo;\r\nif (ahinfo->invflags & ~IP6T_AH_INV_MASK) {\r\npr_debug("unknown flags %X\n", ahinfo->invflags);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init ah_mt6_init(void)\r\n{\r\nreturn xt_register_match(&ah_mt6_reg);\r\n}\r\nstatic void __exit ah_mt6_exit(void)\r\n{\r\nxt_unregister_match(&ah_mt6_reg);\r\n}

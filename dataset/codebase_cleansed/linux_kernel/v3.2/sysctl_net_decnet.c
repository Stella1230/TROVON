static void strip_it(char *str)\r\n{\r\nfor(;;) {\r\nswitch (*str) {\r\ncase ' ':\r\ncase '\n':\r\ncase '\r':\r\ncase ':':\r\n*str = 0;\r\ncase 0:\r\nreturn;\r\n}\r\nstr++;\r\n}\r\n}\r\nstatic int parse_addr(__le16 *addr, char *str)\r\n{\r\n__u16 area, node;\r\nwhile(*str && !ISNUM(*str)) str++;\r\nif (*str == 0)\r\nreturn -1;\r\narea = (*str++ - '0');\r\nif (ISNUM(*str)) {\r\narea *= 10;\r\narea += (*str++ - '0');\r\n}\r\nif (*str++ != '.')\r\nreturn -1;\r\nif (!ISNUM(*str))\r\nreturn -1;\r\nnode = *str++ - '0';\r\nif (ISNUM(*str)) {\r\nnode *= 10;\r\nnode += (*str++ - '0');\r\n}\r\nif (ISNUM(*str)) {\r\nnode *= 10;\r\nnode += (*str++ - '0');\r\n}\r\nif (ISNUM(*str)) {\r\nnode *= 10;\r\nnode += (*str++ - '0');\r\n}\r\nif ((node > 1023) || (area > 63))\r\nreturn -1;\r\nif (INVALID_END_CHAR(*str))\r\nreturn -1;\r\n*addr = cpu_to_le16((area << 10) | node);\r\nreturn 0;\r\n}\r\nstatic int dn_node_address_handler(ctl_table *table, int write,\r\nvoid __user *buffer,\r\nsize_t *lenp, loff_t *ppos)\r\n{\r\nchar addr[DN_ASCBUF_LEN];\r\nsize_t len;\r\n__le16 dnaddr;\r\nif (!*lenp || (*ppos && !write)) {\r\n*lenp = 0;\r\nreturn 0;\r\n}\r\nif (write) {\r\nlen = (*lenp < DN_ASCBUF_LEN) ? *lenp : (DN_ASCBUF_LEN-1);\r\nif (copy_from_user(addr, buffer, len))\r\nreturn -EFAULT;\r\naddr[len] = 0;\r\nstrip_it(addr);\r\nif (parse_addr(&dnaddr, addr))\r\nreturn -EINVAL;\r\ndn_dev_devices_off();\r\ndecnet_address = dnaddr;\r\ndn_dev_devices_on();\r\n*ppos += len;\r\nreturn 0;\r\n}\r\ndn_addr2asc(le16_to_cpu(decnet_address), addr);\r\nlen = strlen(addr);\r\naddr[len++] = '\n';\r\nif (len > *lenp) len = *lenp;\r\nif (copy_to_user(buffer, addr, len))\r\nreturn -EFAULT;\r\n*lenp = len;\r\n*ppos += len;\r\nreturn 0;\r\n}\r\nstatic int dn_def_dev_handler(ctl_table *table, int write,\r\nvoid __user *buffer,\r\nsize_t *lenp, loff_t *ppos)\r\n{\r\nsize_t len;\r\nstruct net_device *dev;\r\nchar devname[17];\r\nif (!*lenp || (*ppos && !write)) {\r\n*lenp = 0;\r\nreturn 0;\r\n}\r\nif (write) {\r\nif (*lenp > 16)\r\nreturn -E2BIG;\r\nif (copy_from_user(devname, buffer, *lenp))\r\nreturn -EFAULT;\r\ndevname[*lenp] = 0;\r\nstrip_it(devname);\r\ndev = dev_get_by_name(&init_net, devname);\r\nif (dev == NULL)\r\nreturn -ENODEV;\r\nif (dev->dn_ptr == NULL) {\r\ndev_put(dev);\r\nreturn -ENODEV;\r\n}\r\nif (dn_dev_set_default(dev, 1)) {\r\ndev_put(dev);\r\nreturn -ENODEV;\r\n}\r\n*ppos += *lenp;\r\nreturn 0;\r\n}\r\ndev = dn_dev_get_default();\r\nif (dev == NULL) {\r\n*lenp = 0;\r\nreturn 0;\r\n}\r\nstrcpy(devname, dev->name);\r\ndev_put(dev);\r\nlen = strlen(devname);\r\ndevname[len++] = '\n';\r\nif (len > *lenp) len = *lenp;\r\nif (copy_to_user(buffer, devname, len))\r\nreturn -EFAULT;\r\n*lenp = len;\r\n*ppos += len;\r\nreturn 0;\r\n}\r\nvoid dn_register_sysctl(void)\r\n{\r\ndn_table_header = register_sysctl_paths(dn_path, dn_table);\r\n}\r\nvoid dn_unregister_sysctl(void)\r\n{\r\nunregister_sysctl_table(dn_table_header);\r\n}\r\nvoid dn_unregister_sysctl(void)\r\n{\r\n}\r\nvoid dn_register_sysctl(void)\r\n{\r\n}

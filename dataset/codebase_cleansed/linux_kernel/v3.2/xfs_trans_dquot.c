void\r\nxfs_trans_dqjoin(\r\nxfs_trans_t *tp,\r\nxfs_dquot_t *dqp)\r\n{\r\nASSERT(dqp->q_transp != tp);\r\nASSERT(XFS_DQ_IS_LOCKED(dqp));\r\nASSERT(dqp->q_logitem.qli_dquot == dqp);\r\nxfs_trans_add_item(tp, &dqp->q_logitem.qli_item);\r\ndqp->q_transp = tp;\r\n}\r\nvoid\r\nxfs_trans_log_dquot(\r\nxfs_trans_t *tp,\r\nxfs_dquot_t *dqp)\r\n{\r\nASSERT(dqp->q_transp == tp);\r\nASSERT(XFS_DQ_IS_LOCKED(dqp));\r\ntp->t_flags |= XFS_TRANS_DIRTY;\r\ndqp->q_logitem.qli_item.li_desc->lid_flags |= XFS_LID_DIRTY;\r\n}\r\nvoid\r\nxfs_trans_dup_dqinfo(\r\nxfs_trans_t *otp,\r\nxfs_trans_t *ntp)\r\n{\r\nxfs_dqtrx_t *oq, *nq;\r\nint i,j;\r\nxfs_dqtrx_t *oqa, *nqa;\r\nif (!otp->t_dqinfo)\r\nreturn;\r\nxfs_trans_alloc_dqinfo(ntp);\r\noqa = otp->t_dqinfo->dqa_usrdquots;\r\nnqa = ntp->t_dqinfo->dqa_usrdquots;\r\nif(otp->t_flags & XFS_TRANS_DQ_DIRTY)\r\nntp->t_flags |= XFS_TRANS_DQ_DIRTY;\r\nfor (j = 0; j < 2; j++) {\r\nfor (i = 0; i < XFS_QM_TRANS_MAXDQS; i++) {\r\nif (oqa[i].qt_dquot == NULL)\r\nbreak;\r\noq = &oqa[i];\r\nnq = &nqa[i];\r\nnq->qt_dquot = oq->qt_dquot;\r\nnq->qt_bcount_delta = nq->qt_icount_delta = 0;\r\nnq->qt_rtbcount_delta = 0;\r\nnq->qt_blk_res = oq->qt_blk_res - oq->qt_blk_res_used;\r\noq->qt_blk_res = oq->qt_blk_res_used;\r\nnq->qt_rtblk_res = oq->qt_rtblk_res -\r\noq->qt_rtblk_res_used;\r\noq->qt_rtblk_res = oq->qt_rtblk_res_used;\r\nnq->qt_ino_res = oq->qt_ino_res - oq->qt_ino_res_used;\r\noq->qt_ino_res = oq->qt_ino_res_used;\r\n}\r\noqa = otp->t_dqinfo->dqa_grpdquots;\r\nnqa = ntp->t_dqinfo->dqa_grpdquots;\r\n}\r\n}\r\nvoid\r\nxfs_trans_mod_dquot_byino(\r\nxfs_trans_t *tp,\r\nxfs_inode_t *ip,\r\nuint field,\r\nlong delta)\r\n{\r\nxfs_mount_t *mp = tp->t_mountp;\r\nif (!XFS_IS_QUOTA_RUNNING(mp) ||\r\n!XFS_IS_QUOTA_ON(mp) ||\r\nip->i_ino == mp->m_sb.sb_uquotino ||\r\nip->i_ino == mp->m_sb.sb_gquotino)\r\nreturn;\r\nif (tp->t_dqinfo == NULL)\r\nxfs_trans_alloc_dqinfo(tp);\r\nif (XFS_IS_UQUOTA_ON(mp) && ip->i_udquot)\r\n(void) xfs_trans_mod_dquot(tp, ip->i_udquot, field, delta);\r\nif (XFS_IS_OQUOTA_ON(mp) && ip->i_gdquot)\r\n(void) xfs_trans_mod_dquot(tp, ip->i_gdquot, field, delta);\r\n}\r\nSTATIC xfs_dqtrx_t *\r\nxfs_trans_get_dqtrx(\r\nxfs_trans_t *tp,\r\nxfs_dquot_t *dqp)\r\n{\r\nint i;\r\nxfs_dqtrx_t *qa;\r\nqa = XFS_QM_ISUDQ(dqp) ?\r\ntp->t_dqinfo->dqa_usrdquots : tp->t_dqinfo->dqa_grpdquots;\r\nfor (i = 0; i < XFS_QM_TRANS_MAXDQS; i++) {\r\nif (qa[i].qt_dquot == NULL ||\r\nqa[i].qt_dquot == dqp)\r\nreturn &qa[i];\r\n}\r\nreturn NULL;\r\n}\r\nvoid\r\nxfs_trans_mod_dquot(\r\nxfs_trans_t *tp,\r\nxfs_dquot_t *dqp,\r\nuint field,\r\nlong delta)\r\n{\r\nxfs_dqtrx_t *qtrx;\r\nASSERT(tp);\r\nASSERT(XFS_IS_QUOTA_RUNNING(tp->t_mountp));\r\nqtrx = NULL;\r\nif (tp->t_dqinfo == NULL)\r\nxfs_trans_alloc_dqinfo(tp);\r\nqtrx = xfs_trans_get_dqtrx(tp, dqp);\r\nASSERT(qtrx);\r\nif (qtrx->qt_dquot == NULL)\r\nqtrx->qt_dquot = dqp;\r\nswitch (field) {\r\ncase XFS_TRANS_DQ_RES_BLKS:\r\nqtrx->qt_blk_res += (ulong)delta;\r\nbreak;\r\ncase XFS_TRANS_DQ_RES_INOS:\r\nqtrx->qt_ino_res += (ulong)delta;\r\nbreak;\r\ncase XFS_TRANS_DQ_BCOUNT:\r\nif (qtrx->qt_blk_res && delta > 0) {\r\nqtrx->qt_blk_res_used += (ulong)delta;\r\nASSERT(qtrx->qt_blk_res >= qtrx->qt_blk_res_used);\r\n}\r\nqtrx->qt_bcount_delta += delta;\r\nbreak;\r\ncase XFS_TRANS_DQ_DELBCOUNT:\r\nqtrx->qt_delbcnt_delta += delta;\r\nbreak;\r\ncase XFS_TRANS_DQ_ICOUNT:\r\nif (qtrx->qt_ino_res && delta > 0) {\r\nqtrx->qt_ino_res_used += (ulong)delta;\r\nASSERT(qtrx->qt_ino_res >= qtrx->qt_ino_res_used);\r\n}\r\nqtrx->qt_icount_delta += delta;\r\nbreak;\r\ncase XFS_TRANS_DQ_RES_RTBLKS:\r\nqtrx->qt_rtblk_res += (ulong)delta;\r\nbreak;\r\ncase XFS_TRANS_DQ_RTBCOUNT:\r\nif (qtrx->qt_rtblk_res && delta > 0) {\r\nqtrx->qt_rtblk_res_used += (ulong)delta;\r\nASSERT(qtrx->qt_rtblk_res >= qtrx->qt_rtblk_res_used);\r\n}\r\nqtrx->qt_rtbcount_delta += delta;\r\nbreak;\r\ncase XFS_TRANS_DQ_DELRTBCOUNT:\r\nqtrx->qt_delrtb_delta += delta;\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\n}\r\ntp->t_flags |= XFS_TRANS_DQ_DIRTY;\r\n}\r\nSTATIC void\r\nxfs_trans_dqlockedjoin(\r\nxfs_trans_t *tp,\r\nxfs_dqtrx_t *q)\r\n{\r\nASSERT(q[0].qt_dquot != NULL);\r\nif (q[1].qt_dquot == NULL) {\r\nxfs_dqlock(q[0].qt_dquot);\r\nxfs_trans_dqjoin(tp, q[0].qt_dquot);\r\n} else {\r\nASSERT(XFS_QM_TRANS_MAXDQS == 2);\r\nxfs_dqlock2(q[0].qt_dquot, q[1].qt_dquot);\r\nxfs_trans_dqjoin(tp, q[0].qt_dquot);\r\nxfs_trans_dqjoin(tp, q[1].qt_dquot);\r\n}\r\n}\r\nvoid\r\nxfs_trans_apply_dquot_deltas(\r\nxfs_trans_t *tp)\r\n{\r\nint i, j;\r\nxfs_dquot_t *dqp;\r\nxfs_dqtrx_t *qtrx, *qa;\r\nxfs_disk_dquot_t *d;\r\nlong totalbdelta;\r\nlong totalrtbdelta;\r\nif (!(tp->t_flags & XFS_TRANS_DQ_DIRTY))\r\nreturn;\r\nASSERT(tp->t_dqinfo);\r\nqa = tp->t_dqinfo->dqa_usrdquots;\r\nfor (j = 0; j < 2; j++) {\r\nif (qa[0].qt_dquot == NULL) {\r\nqa = tp->t_dqinfo->dqa_grpdquots;\r\ncontinue;\r\n}\r\nxfs_trans_dqlockedjoin(tp, qa);\r\nfor (i = 0; i < XFS_QM_TRANS_MAXDQS; i++) {\r\nqtrx = &qa[i];\r\nif ((dqp = qtrx->qt_dquot) == NULL)\r\nbreak;\r\nASSERT(XFS_DQ_IS_LOCKED(dqp));\r\nASSERT(dqp->q_transp == tp);\r\nd = &dqp->q_core;\r\ntotalbdelta = qtrx->qt_bcount_delta +\r\nqtrx->qt_delbcnt_delta;\r\ntotalrtbdelta = qtrx->qt_rtbcount_delta +\r\nqtrx->qt_delrtb_delta;\r\n#ifdef DEBUG\r\nif (totalbdelta < 0)\r\nASSERT(be64_to_cpu(d->d_bcount) >=\r\n-totalbdelta);\r\nif (totalrtbdelta < 0)\r\nASSERT(be64_to_cpu(d->d_rtbcount) >=\r\n-totalrtbdelta);\r\nif (qtrx->qt_icount_delta < 0)\r\nASSERT(be64_to_cpu(d->d_icount) >=\r\n-qtrx->qt_icount_delta);\r\n#endif\r\nif (totalbdelta)\r\nbe64_add_cpu(&d->d_bcount, (xfs_qcnt_t)totalbdelta);\r\nif (qtrx->qt_icount_delta)\r\nbe64_add_cpu(&d->d_icount, (xfs_qcnt_t)qtrx->qt_icount_delta);\r\nif (totalrtbdelta)\r\nbe64_add_cpu(&d->d_rtbcount, (xfs_qcnt_t)totalrtbdelta);\r\nif (d->d_id) {\r\nxfs_qm_adjust_dqlimits(tp->t_mountp, d);\r\nxfs_qm_adjust_dqtimers(tp->t_mountp, d);\r\n}\r\ndqp->dq_flags |= XFS_DQ_DIRTY;\r\nxfs_trans_log_dquot(tp, dqp);\r\nif (qtrx->qt_blk_res != 0) {\r\nif (qtrx->qt_blk_res != qtrx->qt_blk_res_used) {\r\nif (qtrx->qt_blk_res >\r\nqtrx->qt_blk_res_used)\r\ndqp->q_res_bcount -= (xfs_qcnt_t)\r\n(qtrx->qt_blk_res -\r\nqtrx->qt_blk_res_used);\r\nelse\r\ndqp->q_res_bcount -= (xfs_qcnt_t)\r\n(qtrx->qt_blk_res_used -\r\nqtrx->qt_blk_res);\r\n}\r\n} else {\r\nif (qtrx->qt_bcount_delta) {\r\ndqp->q_res_bcount +=\r\n(xfs_qcnt_t)qtrx->qt_bcount_delta;\r\n}\r\n}\r\nif (qtrx->qt_rtblk_res != 0) {\r\nif (qtrx->qt_rtblk_res != qtrx->qt_rtblk_res_used) {\r\nif (qtrx->qt_rtblk_res >\r\nqtrx->qt_rtblk_res_used)\r\ndqp->q_res_rtbcount -= (xfs_qcnt_t)\r\n(qtrx->qt_rtblk_res -\r\nqtrx->qt_rtblk_res_used);\r\nelse\r\ndqp->q_res_rtbcount -= (xfs_qcnt_t)\r\n(qtrx->qt_rtblk_res_used -\r\nqtrx->qt_rtblk_res);\r\n}\r\n} else {\r\nif (qtrx->qt_rtbcount_delta)\r\ndqp->q_res_rtbcount +=\r\n(xfs_qcnt_t)qtrx->qt_rtbcount_delta;\r\n}\r\nif (qtrx->qt_ino_res != 0) {\r\nASSERT(qtrx->qt_ino_res >=\r\nqtrx->qt_ino_res_used);\r\nif (qtrx->qt_ino_res > qtrx->qt_ino_res_used)\r\ndqp->q_res_icount -= (xfs_qcnt_t)\r\n(qtrx->qt_ino_res -\r\nqtrx->qt_ino_res_used);\r\n} else {\r\nif (qtrx->qt_icount_delta)\r\ndqp->q_res_icount +=\r\n(xfs_qcnt_t)qtrx->qt_icount_delta;\r\n}\r\nASSERT(dqp->q_res_bcount >=\r\nbe64_to_cpu(dqp->q_core.d_bcount));\r\nASSERT(dqp->q_res_icount >=\r\nbe64_to_cpu(dqp->q_core.d_icount));\r\nASSERT(dqp->q_res_rtbcount >=\r\nbe64_to_cpu(dqp->q_core.d_rtbcount));\r\n}\r\nqa = tp->t_dqinfo->dqa_grpdquots;\r\n}\r\n}\r\nvoid\r\nxfs_trans_unreserve_and_mod_dquots(\r\nxfs_trans_t *tp)\r\n{\r\nint i, j;\r\nxfs_dquot_t *dqp;\r\nxfs_dqtrx_t *qtrx, *qa;\r\nboolean_t locked;\r\nif (!tp->t_dqinfo || !(tp->t_flags & XFS_TRANS_DQ_DIRTY))\r\nreturn;\r\nqa = tp->t_dqinfo->dqa_usrdquots;\r\nfor (j = 0; j < 2; j++) {\r\nfor (i = 0; i < XFS_QM_TRANS_MAXDQS; i++) {\r\nqtrx = &qa[i];\r\nif ((dqp = qtrx->qt_dquot) == NULL)\r\nbreak;\r\nlocked = B_FALSE;\r\nif (qtrx->qt_blk_res) {\r\nxfs_dqlock(dqp);\r\nlocked = B_TRUE;\r\ndqp->q_res_bcount -=\r\n(xfs_qcnt_t)qtrx->qt_blk_res;\r\n}\r\nif (qtrx->qt_ino_res) {\r\nif (!locked) {\r\nxfs_dqlock(dqp);\r\nlocked = B_TRUE;\r\n}\r\ndqp->q_res_icount -=\r\n(xfs_qcnt_t)qtrx->qt_ino_res;\r\n}\r\nif (qtrx->qt_rtblk_res) {\r\nif (!locked) {\r\nxfs_dqlock(dqp);\r\nlocked = B_TRUE;\r\n}\r\ndqp->q_res_rtbcount -=\r\n(xfs_qcnt_t)qtrx->qt_rtblk_res;\r\n}\r\nif (locked)\r\nxfs_dqunlock(dqp);\r\n}\r\nqa = tp->t_dqinfo->dqa_grpdquots;\r\n}\r\n}\r\nSTATIC void\r\nxfs_quota_warn(\r\nstruct xfs_mount *mp,\r\nstruct xfs_dquot *dqp,\r\nint type)\r\n{\r\nif (dqp->dq_flags & XFS_DQ_PROJ)\r\nreturn;\r\nquota_send_warning((dqp->dq_flags & XFS_DQ_USER) ? USRQUOTA : GRPQUOTA,\r\nbe32_to_cpu(dqp->q_core.d_id), mp->m_super->s_dev,\r\ntype);\r\n}\r\nSTATIC int\r\nxfs_trans_dqresv(\r\nxfs_trans_t *tp,\r\nxfs_mount_t *mp,\r\nxfs_dquot_t *dqp,\r\nlong nblks,\r\nlong ninos,\r\nuint flags)\r\n{\r\nxfs_qcnt_t hardlimit;\r\nxfs_qcnt_t softlimit;\r\ntime_t timer;\r\nxfs_qwarncnt_t warns;\r\nxfs_qwarncnt_t warnlimit;\r\nxfs_qcnt_t count;\r\nxfs_qcnt_t *resbcountp;\r\nxfs_quotainfo_t *q = mp->m_quotainfo;\r\nxfs_dqlock(dqp);\r\nif (flags & XFS_TRANS_DQ_RES_BLKS) {\r\nhardlimit = be64_to_cpu(dqp->q_core.d_blk_hardlimit);\r\nif (!hardlimit)\r\nhardlimit = q->qi_bhardlimit;\r\nsoftlimit = be64_to_cpu(dqp->q_core.d_blk_softlimit);\r\nif (!softlimit)\r\nsoftlimit = q->qi_bsoftlimit;\r\ntimer = be32_to_cpu(dqp->q_core.d_btimer);\r\nwarns = be16_to_cpu(dqp->q_core.d_bwarns);\r\nwarnlimit = dqp->q_mount->m_quotainfo->qi_bwarnlimit;\r\nresbcountp = &dqp->q_res_bcount;\r\n} else {\r\nASSERT(flags & XFS_TRANS_DQ_RES_RTBLKS);\r\nhardlimit = be64_to_cpu(dqp->q_core.d_rtb_hardlimit);\r\nif (!hardlimit)\r\nhardlimit = q->qi_rtbhardlimit;\r\nsoftlimit = be64_to_cpu(dqp->q_core.d_rtb_softlimit);\r\nif (!softlimit)\r\nsoftlimit = q->qi_rtbsoftlimit;\r\ntimer = be32_to_cpu(dqp->q_core.d_rtbtimer);\r\nwarns = be16_to_cpu(dqp->q_core.d_rtbwarns);\r\nwarnlimit = dqp->q_mount->m_quotainfo->qi_rtbwarnlimit;\r\nresbcountp = &dqp->q_res_rtbcount;\r\n}\r\nif ((flags & XFS_QMOPT_FORCE_RES) == 0 &&\r\ndqp->q_core.d_id &&\r\n((XFS_IS_UQUOTA_ENFORCED(dqp->q_mount) && XFS_QM_ISUDQ(dqp)) ||\r\n(XFS_IS_OQUOTA_ENFORCED(dqp->q_mount) &&\r\n(XFS_QM_ISPDQ(dqp) || XFS_QM_ISGDQ(dqp))))) {\r\nif (nblks > 0) {\r\nif (hardlimit > 0ULL &&\r\nhardlimit <= nblks + *resbcountp) {\r\nxfs_quota_warn(mp, dqp, QUOTA_NL_BHARDWARN);\r\ngoto error_return;\r\n}\r\nif (softlimit > 0ULL &&\r\nsoftlimit <= nblks + *resbcountp) {\r\nif ((timer != 0 && get_seconds() > timer) ||\r\n(warns != 0 && warns >= warnlimit)) {\r\nxfs_quota_warn(mp, dqp,\r\nQUOTA_NL_BSOFTLONGWARN);\r\ngoto error_return;\r\n}\r\nxfs_quota_warn(mp, dqp, QUOTA_NL_BSOFTWARN);\r\n}\r\n}\r\nif (ninos > 0) {\r\ncount = be64_to_cpu(dqp->q_core.d_icount);\r\ntimer = be32_to_cpu(dqp->q_core.d_itimer);\r\nwarns = be16_to_cpu(dqp->q_core.d_iwarns);\r\nwarnlimit = dqp->q_mount->m_quotainfo->qi_iwarnlimit;\r\nhardlimit = be64_to_cpu(dqp->q_core.d_ino_hardlimit);\r\nif (!hardlimit)\r\nhardlimit = q->qi_ihardlimit;\r\nsoftlimit = be64_to_cpu(dqp->q_core.d_ino_softlimit);\r\nif (!softlimit)\r\nsoftlimit = q->qi_isoftlimit;\r\nif (hardlimit > 0ULL && count >= hardlimit) {\r\nxfs_quota_warn(mp, dqp, QUOTA_NL_IHARDWARN);\r\ngoto error_return;\r\n}\r\nif (softlimit > 0ULL && count >= softlimit) {\r\nif ((timer != 0 && get_seconds() > timer) ||\r\n(warns != 0 && warns >= warnlimit)) {\r\nxfs_quota_warn(mp, dqp,\r\nQUOTA_NL_ISOFTLONGWARN);\r\ngoto error_return;\r\n}\r\nxfs_quota_warn(mp, dqp, QUOTA_NL_ISOFTWARN);\r\n}\r\n}\r\n}\r\n(*resbcountp) += (xfs_qcnt_t)nblks;\r\nif (ninos != 0)\r\ndqp->q_res_icount += (xfs_qcnt_t)ninos;\r\nif (tp) {\r\nASSERT(tp->t_dqinfo);\r\nASSERT(flags & XFS_QMOPT_RESBLK_MASK);\r\nif (nblks != 0)\r\nxfs_trans_mod_dquot(tp, dqp,\r\nflags & XFS_QMOPT_RESBLK_MASK,\r\nnblks);\r\nif (ninos != 0)\r\nxfs_trans_mod_dquot(tp, dqp,\r\nXFS_TRANS_DQ_RES_INOS,\r\nninos);\r\n}\r\nASSERT(dqp->q_res_bcount >= be64_to_cpu(dqp->q_core.d_bcount));\r\nASSERT(dqp->q_res_rtbcount >= be64_to_cpu(dqp->q_core.d_rtbcount));\r\nASSERT(dqp->q_res_icount >= be64_to_cpu(dqp->q_core.d_icount));\r\nxfs_dqunlock(dqp);\r\nreturn 0;\r\nerror_return:\r\nxfs_dqunlock(dqp);\r\nif (flags & XFS_QMOPT_ENOSPC)\r\nreturn ENOSPC;\r\nreturn EDQUOT;\r\n}\r\nint\r\nxfs_trans_reserve_quota_bydquots(\r\nxfs_trans_t *tp,\r\nxfs_mount_t *mp,\r\nxfs_dquot_t *udqp,\r\nxfs_dquot_t *gdqp,\r\nlong nblks,\r\nlong ninos,\r\nuint flags)\r\n{\r\nint resvd = 0, error;\r\nif (!XFS_IS_QUOTA_RUNNING(mp) || !XFS_IS_QUOTA_ON(mp))\r\nreturn 0;\r\nif (tp && tp->t_dqinfo == NULL)\r\nxfs_trans_alloc_dqinfo(tp);\r\nASSERT(flags & XFS_QMOPT_RESBLK_MASK);\r\nif (udqp) {\r\nerror = xfs_trans_dqresv(tp, mp, udqp, nblks, ninos,\r\n(flags & ~XFS_QMOPT_ENOSPC));\r\nif (error)\r\nreturn error;\r\nresvd = 1;\r\n}\r\nif (gdqp) {\r\nerror = xfs_trans_dqresv(tp, mp, gdqp, nblks, ninos, flags);\r\nif (error) {\r\nif (resvd) {\r\nflags |= XFS_QMOPT_FORCE_RES;\r\nxfs_trans_dqresv(tp, mp, udqp,\r\n-nblks, -ninos, flags);\r\n}\r\nreturn error;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint\r\nxfs_trans_reserve_quota_nblks(\r\nstruct xfs_trans *tp,\r\nstruct xfs_inode *ip,\r\nlong nblks,\r\nlong ninos,\r\nuint flags)\r\n{\r\nstruct xfs_mount *mp = ip->i_mount;\r\nif (!XFS_IS_QUOTA_RUNNING(mp) || !XFS_IS_QUOTA_ON(mp))\r\nreturn 0;\r\nif (XFS_IS_PQUOTA_ON(mp))\r\nflags |= XFS_QMOPT_ENOSPC;\r\nASSERT(ip->i_ino != mp->m_sb.sb_uquotino);\r\nASSERT(ip->i_ino != mp->m_sb.sb_gquotino);\r\nASSERT(xfs_isilocked(ip, XFS_ILOCK_EXCL));\r\nASSERT((flags & ~(XFS_QMOPT_FORCE_RES | XFS_QMOPT_ENOSPC)) ==\r\nXFS_TRANS_DQ_RES_RTBLKS ||\r\n(flags & ~(XFS_QMOPT_FORCE_RES | XFS_QMOPT_ENOSPC)) ==\r\nXFS_TRANS_DQ_RES_BLKS);\r\nreturn xfs_trans_reserve_quota_bydquots(tp, mp,\r\nip->i_udquot, ip->i_gdquot,\r\nnblks, ninos, flags);\r\n}\r\nxfs_qoff_logitem_t *\r\nxfs_trans_get_qoff_item(\r\nxfs_trans_t *tp,\r\nxfs_qoff_logitem_t *startqoff,\r\nuint flags)\r\n{\r\nxfs_qoff_logitem_t *q;\r\nASSERT(tp != NULL);\r\nq = xfs_qm_qoff_logitem_init(tp->t_mountp, startqoff, flags);\r\nASSERT(q != NULL);\r\nxfs_trans_add_item(tp, &q->qql_item);\r\nreturn q;\r\n}\r\nvoid\r\nxfs_trans_log_quotaoff_item(\r\nxfs_trans_t *tp,\r\nxfs_qoff_logitem_t *qlp)\r\n{\r\ntp->t_flags |= XFS_TRANS_DIRTY;\r\nqlp->qql_item.li_desc->lid_flags |= XFS_LID_DIRTY;\r\n}\r\nSTATIC void\r\nxfs_trans_alloc_dqinfo(\r\nxfs_trans_t *tp)\r\n{\r\ntp->t_dqinfo = kmem_zone_zalloc(xfs_Gqm->qm_dqtrxzone, KM_SLEEP);\r\n}\r\nvoid\r\nxfs_trans_free_dqinfo(\r\nxfs_trans_t *tp)\r\n{\r\nif (!tp->t_dqinfo)\r\nreturn;\r\nkmem_zone_free(xfs_Gqm->qm_dqtrxzone, tp->t_dqinfo);\r\ntp->t_dqinfo = NULL;\r\n}

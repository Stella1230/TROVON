static int wait_for_phy_ready(void __iomem *reg, unsigned long bit)\r\n{\r\nunsigned long timeout;\r\ntimeout = jiffies + msecs_to_jiffies(3000);\r\nwhile (!(__raw_readl(reg) & bit)) {\r\nif (time_after(jiffies, timeout))\r\nreturn -1;\r\ncpu_relax();\r\n}\r\nreturn 0;\r\n}\r\nstatic int ahci_phy_init(void __iomem *mmio)\r\n{\r\nint i, ctrl0;\r\nfor (i = 0; i < ARRAY_SIZE(exynos4_sataphy_cmu); i++)\r\n__raw_writeb(exynos4_sataphy_cmu[i].val,\r\nphy_base + (exynos4_sataphy_cmu[i].reg * 4));\r\nfor (i = 0; i < ARRAY_SIZE(exynos4_sataphy_lane); i++)\r\n__raw_writeb(exynos4_sataphy_lane[i].val,\r\nphy_base + (LANE0 + exynos4_sataphy_lane[i].reg) * 4);\r\nfor (i = 0; i < ARRAY_SIZE(exynos4_sataphy_comlane); i++)\r\n__raw_writeb(exynos4_sataphy_comlane[i].val,\r\nphy_base + (COM_LANE + exynos4_sataphy_comlane[i].reg) * 4);\r\n__raw_writeb(0x07, phy_base);\r\nctrl0 = __raw_readl(phy_ctrl + SATA_CTRL0);\r\nctrl0 |= SATA_CTRL0_PHY_CMU_RST_N;\r\n__raw_writel(ctrl0, phy_ctrl + SATA_CTRL0);\r\nif (wait_for_phy_ready(phy_ctrl + SATA_PHY_STATUS,\r\nSATA_PHY_STATUS_CMU_OK) < 0) {\r\nprintk(KERN_ERR "PHY CMU not ready\n");\r\nreturn -EBUSY;\r\n}\r\n__raw_writeb(0x03, phy_base + (COM_LANE * 4));\r\nctrl0 = __raw_readl(phy_ctrl + SATA_CTRL0);\r\nctrl0 |= SATA_CTRL0_M_PHY_LN_RST_N;\r\n__raw_writel(ctrl0, phy_ctrl + SATA_CTRL0);\r\nif (wait_for_phy_ready(phy_ctrl + SATA_PHY_STATUS,\r\nSATA_PHY_STATUS_LANE_OK) < 0) {\r\nprintk(KERN_ERR "PHY LANE not ready\n");\r\nreturn -EBUSY;\r\n}\r\nctrl0 = __raw_readl(phy_ctrl + SATA_CTRL0);\r\nctrl0 |= SATA_CTRL0_M_PHY_CAL;\r\n__raw_writel(ctrl0, phy_ctrl + SATA_CTRL0);\r\nreturn 0;\r\n}\r\nstatic int exynos4_ahci_init(struct device *dev, void __iomem *mmio)\r\n{\r\nstruct clk *clk_sata, *clk_sataphy, *clk_sclk_sata;\r\nint val, ret;\r\nphy_base = ioremap(EXYNOS4_PA_SATAPHY, SZ_64K);\r\nif (!phy_base) {\r\ndev_err(dev, "failed to allocate memory for SATA PHY\n");\r\nreturn -ENOMEM;\r\n}\r\nphy_ctrl = ioremap(EXYNOS4_PA_SATAPHY_CTRL, SZ_16);\r\nif (!phy_ctrl) {\r\ndev_err(dev, "failed to allocate memory for SATA PHY CTRL\n");\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nclk_sata = clk_get(dev, "sata");\r\nif (IS_ERR(clk_sata)) {\r\ndev_err(dev, "failed to get sata clock\n");\r\nret = PTR_ERR(clk_sata);\r\nclk_sata = NULL;\r\ngoto err2;\r\n}\r\nclk_enable(clk_sata);\r\nclk_sataphy = clk_get(dev, "sataphy");\r\nif (IS_ERR(clk_sataphy)) {\r\ndev_err(dev, "failed to get sataphy clock\n");\r\nret = PTR_ERR(clk_sataphy);\r\nclk_sataphy = NULL;\r\ngoto err3;\r\n}\r\nclk_enable(clk_sataphy);\r\nclk_sclk_sata = clk_get(dev, "sclk_sata");\r\nif (IS_ERR(clk_sclk_sata)) {\r\ndev_err(dev, "failed to get sclk_sata\n");\r\nret = PTR_ERR(clk_sclk_sata);\r\nclk_sclk_sata = NULL;\r\ngoto err4;\r\n}\r\nclk_enable(clk_sclk_sata);\r\nclk_set_rate(clk_sclk_sata, SCLK_SATA_FREQ);\r\n__raw_writel(S5P_PMU_SATA_PHY_CONTROL_EN, S5P_PMU_SATA_PHY_CONTROL);\r\nval = SATA_CTRL1_RST_PMALIVE_N | SATA_CTRL1_RST_RXOOB_N |\r\nSATA_CTRL1_RST_RX_N | SATA_CTRL1_RST_TX_N;\r\n__raw_writel(val, phy_ctrl + SATA_CTRL1);\r\nval = SATA_CTRL0_RX_DATA_VALID(3) | SATA_CTRL0_SPEED_MODE |\r\nSATA_CTRL0_PHY_POR_N;\r\n__raw_writel(val, phy_ctrl + SATA_CTRL0);\r\n__raw_writel(0x1, mmio + HOST_PORTS_IMPL);\r\nreturn ahci_phy_init(mmio);\r\nerr4:\r\nclk_disable(clk_sataphy);\r\nclk_put(clk_sataphy);\r\nerr3:\r\nclk_disable(clk_sata);\r\nclk_put(clk_sata);\r\nerr2:\r\niounmap(phy_ctrl);\r\nerr1:\r\niounmap(phy_base);\r\nreturn ret;\r\n}

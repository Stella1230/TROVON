static int bt8xxgpio_gpio_direction_input(struct gpio_chip *gpio, unsigned nr)\r\n{\r\nstruct bt8xxgpio *bg = container_of(gpio, struct bt8xxgpio, gpio);\r\nunsigned long flags;\r\nu32 outen, data;\r\nspin_lock_irqsave(&bg->lock, flags);\r\ndata = bgread(BT848_GPIO_DATA);\r\ndata &= ~(1 << nr);\r\nbgwrite(data, BT848_GPIO_DATA);\r\nouten = bgread(BT848_GPIO_OUT_EN);\r\nouten &= ~(1 << nr);\r\nbgwrite(outen, BT848_GPIO_OUT_EN);\r\nspin_unlock_irqrestore(&bg->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int bt8xxgpio_gpio_get(struct gpio_chip *gpio, unsigned nr)\r\n{\r\nstruct bt8xxgpio *bg = container_of(gpio, struct bt8xxgpio, gpio);\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&bg->lock, flags);\r\nval = bgread(BT848_GPIO_DATA);\r\nspin_unlock_irqrestore(&bg->lock, flags);\r\nreturn !!(val & (1 << nr));\r\n}\r\nstatic int bt8xxgpio_gpio_direction_output(struct gpio_chip *gpio,\r\nunsigned nr, int val)\r\n{\r\nstruct bt8xxgpio *bg = container_of(gpio, struct bt8xxgpio, gpio);\r\nunsigned long flags;\r\nu32 outen, data;\r\nspin_lock_irqsave(&bg->lock, flags);\r\nouten = bgread(BT848_GPIO_OUT_EN);\r\nouten |= (1 << nr);\r\nbgwrite(outen, BT848_GPIO_OUT_EN);\r\ndata = bgread(BT848_GPIO_DATA);\r\nif (val)\r\ndata |= (1 << nr);\r\nelse\r\ndata &= ~(1 << nr);\r\nbgwrite(data, BT848_GPIO_DATA);\r\nspin_unlock_irqrestore(&bg->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void bt8xxgpio_gpio_set(struct gpio_chip *gpio,\r\nunsigned nr, int val)\r\n{\r\nstruct bt8xxgpio *bg = container_of(gpio, struct bt8xxgpio, gpio);\r\nunsigned long flags;\r\nu32 data;\r\nspin_lock_irqsave(&bg->lock, flags);\r\ndata = bgread(BT848_GPIO_DATA);\r\nif (val)\r\ndata |= (1 << nr);\r\nelse\r\ndata &= ~(1 << nr);\r\nbgwrite(data, BT848_GPIO_DATA);\r\nspin_unlock_irqrestore(&bg->lock, flags);\r\n}\r\nstatic void bt8xxgpio_gpio_setup(struct bt8xxgpio *bg)\r\n{\r\nstruct gpio_chip *c = &bg->gpio;\r\nc->label = dev_name(&bg->pdev->dev);\r\nc->owner = THIS_MODULE;\r\nc->direction_input = bt8xxgpio_gpio_direction_input;\r\nc->get = bt8xxgpio_gpio_get;\r\nc->direction_output = bt8xxgpio_gpio_direction_output;\r\nc->set = bt8xxgpio_gpio_set;\r\nc->dbg_show = NULL;\r\nc->base = modparam_gpiobase;\r\nc->ngpio = BT8XXGPIO_NR_GPIOS;\r\nc->can_sleep = 0;\r\n}\r\nstatic int bt8xxgpio_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nstruct bt8xxgpio *bg;\r\nint err;\r\nbg = kzalloc(sizeof(*bg), GFP_KERNEL);\r\nif (!bg)\r\nreturn -ENOMEM;\r\nbg->pdev = dev;\r\nspin_lock_init(&bg->lock);\r\nerr = pci_enable_device(dev);\r\nif (err) {\r\nprintk(KERN_ERR "bt8xxgpio: Can't enable device.\n");\r\ngoto err_freebg;\r\n}\r\nif (!request_mem_region(pci_resource_start(dev, 0),\r\npci_resource_len(dev, 0),\r\n"bt8xxgpio")) {\r\nprintk(KERN_WARNING "bt8xxgpio: Can't request iomem (0x%llx).\n",\r\n(unsigned long long)pci_resource_start(dev, 0));\r\nerr = -EBUSY;\r\ngoto err_disable;\r\n}\r\npci_set_master(dev);\r\npci_set_drvdata(dev, bg);\r\nbg->mmio = ioremap(pci_resource_start(dev, 0), 0x1000);\r\nif (!bg->mmio) {\r\nprintk(KERN_ERR "bt8xxgpio: ioremap() failed\n");\r\nerr = -EIO;\r\ngoto err_release_mem;\r\n}\r\nbgwrite(0, BT848_INT_MASK);\r\nbgwrite(0, BT848_GPIO_DMA_CTL);\r\nbgwrite(0, BT848_GPIO_REG_INP);\r\nbgwrite(0, BT848_GPIO_OUT_EN);\r\nbt8xxgpio_gpio_setup(bg);\r\nerr = gpiochip_add(&bg->gpio);\r\nif (err) {\r\nprintk(KERN_ERR "bt8xxgpio: Failed to register GPIOs\n");\r\ngoto err_release_mem;\r\n}\r\nprintk(KERN_INFO "bt8xxgpio: Abusing BT8xx card for GPIOs %d to %d\n",\r\nbg->gpio.base, bg->gpio.base + BT8XXGPIO_NR_GPIOS - 1);\r\nreturn 0;\r\nerr_release_mem:\r\nrelease_mem_region(pci_resource_start(dev, 0),\r\npci_resource_len(dev, 0));\r\npci_set_drvdata(dev, NULL);\r\nerr_disable:\r\npci_disable_device(dev);\r\nerr_freebg:\r\nkfree(bg);\r\nreturn err;\r\n}\r\nstatic void bt8xxgpio_remove(struct pci_dev *pdev)\r\n{\r\nstruct bt8xxgpio *bg = pci_get_drvdata(pdev);\r\ngpiochip_remove(&bg->gpio);\r\nbgwrite(0, BT848_INT_MASK);\r\nbgwrite(~0x0, BT848_INT_STAT);\r\nbgwrite(0x0, BT848_GPIO_OUT_EN);\r\niounmap(bg->mmio);\r\nrelease_mem_region(pci_resource_start(pdev, 0),\r\npci_resource_len(pdev, 0));\r\npci_disable_device(pdev);\r\npci_set_drvdata(pdev, NULL);\r\nkfree(bg);\r\n}\r\nstatic int bt8xxgpio_suspend(struct pci_dev *pdev, pm_message_t state)\r\n{\r\nstruct bt8xxgpio *bg = pci_get_drvdata(pdev);\r\nunsigned long flags;\r\nspin_lock_irqsave(&bg->lock, flags);\r\nbg->saved_outen = bgread(BT848_GPIO_OUT_EN);\r\nbg->saved_data = bgread(BT848_GPIO_DATA);\r\nbgwrite(0, BT848_INT_MASK);\r\nbgwrite(~0x0, BT848_INT_STAT);\r\nbgwrite(0x0, BT848_GPIO_OUT_EN);\r\nspin_unlock_irqrestore(&bg->lock, flags);\r\npci_save_state(pdev);\r\npci_disable_device(pdev);\r\npci_set_power_state(pdev, pci_choose_state(pdev, state));\r\nreturn 0;\r\n}\r\nstatic int bt8xxgpio_resume(struct pci_dev *pdev)\r\n{\r\nstruct bt8xxgpio *bg = pci_get_drvdata(pdev);\r\nunsigned long flags;\r\nint err;\r\npci_set_power_state(pdev, 0);\r\nerr = pci_enable_device(pdev);\r\nif (err)\r\nreturn err;\r\npci_restore_state(pdev);\r\nspin_lock_irqsave(&bg->lock, flags);\r\nbgwrite(0, BT848_INT_MASK);\r\nbgwrite(0, BT848_GPIO_DMA_CTL);\r\nbgwrite(0, BT848_GPIO_REG_INP);\r\nbgwrite(bg->saved_outen, BT848_GPIO_OUT_EN);\r\nbgwrite(bg->saved_data & bg->saved_outen,\r\nBT848_GPIO_DATA);\r\nspin_unlock_irqrestore(&bg->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int __init bt8xxgpio_init(void)\r\n{\r\nreturn pci_register_driver(&bt8xxgpio_pci_driver);\r\n}\r\nstatic void __exit bt8xxgpio_exit(void)\r\n{\r\npci_unregister_driver(&bt8xxgpio_pci_driver);\r\n}

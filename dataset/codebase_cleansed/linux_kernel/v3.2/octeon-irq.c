static void __init octeon_irq_set_ciu_mapping(int irq, int line, int bit,\r\nstruct irq_chip *chip,\r\nirq_flow_handler_t handler)\r\n{\r\nunion octeon_ciu_chip_data cd;\r\nirq_set_chip_and_handler(irq, chip, handler);\r\ncd.l = 0;\r\ncd.s.line = line;\r\ncd.s.bit = bit;\r\nirq_set_chip_data(irq, cd.p);\r\nocteon_irq_ciu_to_irq[line][bit] = irq;\r\n}\r\nstatic int octeon_coreid_for_cpu(int cpu)\r\n{\r\n#ifdef CONFIG_SMP\r\nreturn cpu_logical_map(cpu);\r\n#else\r\nreturn cvmx_get_core_num();\r\n#endif\r\n}\r\nstatic int octeon_cpu_for_coreid(int coreid)\r\n{\r\n#ifdef CONFIG_SMP\r\nreturn cpu_number_map(coreid);\r\n#else\r\nreturn smp_processor_id();\r\n#endif\r\n}\r\nstatic void octeon_irq_core_ack(struct irq_data *data)\r\n{\r\nstruct octeon_core_chip_data *cd = irq_data_get_irq_chip_data(data);\r\nunsigned int bit = cd->bit;\r\nclear_c0_status(0x100 << bit);\r\nif (bit < 2)\r\nclear_c0_cause(0x100 << bit);\r\n}\r\nstatic void octeon_irq_core_eoi(struct irq_data *data)\r\n{\r\nstruct octeon_core_chip_data *cd = irq_data_get_irq_chip_data(data);\r\nset_c0_status(0x100 << cd->bit);\r\n}\r\nstatic void octeon_irq_core_set_enable_local(void *arg)\r\n{\r\nstruct irq_data *data = arg;\r\nstruct octeon_core_chip_data *cd = irq_data_get_irq_chip_data(data);\r\nunsigned int mask = 0x100 << cd->bit;\r\nif (cd->desired_en)\r\nset_c0_status(mask);\r\nelse\r\nclear_c0_status(mask);\r\n}\r\nstatic void octeon_irq_core_disable(struct irq_data *data)\r\n{\r\nstruct octeon_core_chip_data *cd = irq_data_get_irq_chip_data(data);\r\ncd->desired_en = false;\r\n}\r\nstatic void octeon_irq_core_enable(struct irq_data *data)\r\n{\r\nstruct octeon_core_chip_data *cd = irq_data_get_irq_chip_data(data);\r\ncd->desired_en = true;\r\n}\r\nstatic void octeon_irq_core_bus_lock(struct irq_data *data)\r\n{\r\nstruct octeon_core_chip_data *cd = irq_data_get_irq_chip_data(data);\r\nmutex_lock(&cd->core_irq_mutex);\r\n}\r\nstatic void octeon_irq_core_bus_sync_unlock(struct irq_data *data)\r\n{\r\nstruct octeon_core_chip_data *cd = irq_data_get_irq_chip_data(data);\r\nif (cd->desired_en != cd->current_en) {\r\non_each_cpu(octeon_irq_core_set_enable_local, data, 1);\r\ncd->current_en = cd->desired_en;\r\n}\r\nmutex_unlock(&cd->core_irq_mutex);\r\n}\r\nstatic void __init octeon_irq_init_core(void)\r\n{\r\nint i;\r\nint irq;\r\nstruct octeon_core_chip_data *cd;\r\nfor (i = 0; i < MIPS_CORE_IRQ_LINES; i++) {\r\ncd = &octeon_irq_core_chip_data[i];\r\ncd->current_en = false;\r\ncd->desired_en = false;\r\ncd->bit = i;\r\nmutex_init(&cd->core_irq_mutex);\r\nirq = OCTEON_IRQ_SW0 + i;\r\nswitch (irq) {\r\ncase OCTEON_IRQ_TIMER:\r\ncase OCTEON_IRQ_SW0:\r\ncase OCTEON_IRQ_SW1:\r\ncase OCTEON_IRQ_5:\r\ncase OCTEON_IRQ_PERF:\r\nirq_set_chip_data(irq, cd);\r\nirq_set_chip_and_handler(irq, &octeon_irq_chip_core,\r\nhandle_percpu_irq);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic int next_cpu_for_irq(struct irq_data *data)\r\n{\r\n#ifdef CONFIG_SMP\r\nint cpu;\r\nint weight = cpumask_weight(data->affinity);\r\nif (weight > 1) {\r\ncpu = smp_processor_id();\r\nfor (;;) {\r\ncpu = cpumask_next(cpu, data->affinity);\r\nif (cpu >= nr_cpu_ids) {\r\ncpu = -1;\r\ncontinue;\r\n} else if (cpumask_test_cpu(cpu, cpu_online_mask)) {\r\nbreak;\r\n}\r\n}\r\n} else if (weight == 1) {\r\ncpu = cpumask_first(data->affinity);\r\n} else {\r\ncpu = smp_processor_id();\r\n}\r\nreturn cpu;\r\n#else\r\nreturn smp_processor_id();\r\n#endif\r\n}\r\nstatic void octeon_irq_ciu_enable(struct irq_data *data)\r\n{\r\nint cpu = next_cpu_for_irq(data);\r\nint coreid = octeon_coreid_for_cpu(cpu);\r\nunsigned long *pen;\r\nunsigned long flags;\r\nunion octeon_ciu_chip_data cd;\r\ncd.p = irq_data_get_irq_chip_data(data);\r\nif (cd.s.line == 0) {\r\nraw_spin_lock_irqsave(&octeon_irq_ciu0_lock, flags);\r\npen = &per_cpu(octeon_irq_ciu0_en_mirror, cpu);\r\nset_bit(cd.s.bit, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0(coreid * 2), *pen);\r\nraw_spin_unlock_irqrestore(&octeon_irq_ciu0_lock, flags);\r\n} else {\r\nraw_spin_lock_irqsave(&octeon_irq_ciu1_lock, flags);\r\npen = &per_cpu(octeon_irq_ciu1_en_mirror, cpu);\r\nset_bit(cd.s.bit, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1(coreid * 2 + 1), *pen);\r\nraw_spin_unlock_irqrestore(&octeon_irq_ciu1_lock, flags);\r\n}\r\n}\r\nstatic void octeon_irq_ciu_enable_local(struct irq_data *data)\r\n{\r\nunsigned long *pen;\r\nunsigned long flags;\r\nunion octeon_ciu_chip_data cd;\r\ncd.p = irq_data_get_irq_chip_data(data);\r\nif (cd.s.line == 0) {\r\nraw_spin_lock_irqsave(&octeon_irq_ciu0_lock, flags);\r\npen = &__get_cpu_var(octeon_irq_ciu0_en_mirror);\r\nset_bit(cd.s.bit, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0(cvmx_get_core_num() * 2), *pen);\r\nraw_spin_unlock_irqrestore(&octeon_irq_ciu0_lock, flags);\r\n} else {\r\nraw_spin_lock_irqsave(&octeon_irq_ciu1_lock, flags);\r\npen = &__get_cpu_var(octeon_irq_ciu1_en_mirror);\r\nset_bit(cd.s.bit, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1(cvmx_get_core_num() * 2 + 1), *pen);\r\nraw_spin_unlock_irqrestore(&octeon_irq_ciu1_lock, flags);\r\n}\r\n}\r\nstatic void octeon_irq_ciu_disable_local(struct irq_data *data)\r\n{\r\nunsigned long *pen;\r\nunsigned long flags;\r\nunion octeon_ciu_chip_data cd;\r\ncd.p = irq_data_get_irq_chip_data(data);\r\nif (cd.s.line == 0) {\r\nraw_spin_lock_irqsave(&octeon_irq_ciu0_lock, flags);\r\npen = &__get_cpu_var(octeon_irq_ciu0_en_mirror);\r\nclear_bit(cd.s.bit, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0(cvmx_get_core_num() * 2), *pen);\r\nraw_spin_unlock_irqrestore(&octeon_irq_ciu0_lock, flags);\r\n} else {\r\nraw_spin_lock_irqsave(&octeon_irq_ciu1_lock, flags);\r\npen = &__get_cpu_var(octeon_irq_ciu1_en_mirror);\r\nclear_bit(cd.s.bit, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1(cvmx_get_core_num() * 2 + 1), *pen);\r\nraw_spin_unlock_irqrestore(&octeon_irq_ciu1_lock, flags);\r\n}\r\n}\r\nstatic void octeon_irq_ciu_disable_all(struct irq_data *data)\r\n{\r\nunsigned long flags;\r\nunsigned long *pen;\r\nint cpu;\r\nunion octeon_ciu_chip_data cd;\r\nwmb();\r\ncd.p = irq_data_get_irq_chip_data(data);\r\nif (cd.s.line == 0) {\r\nraw_spin_lock_irqsave(&octeon_irq_ciu0_lock, flags);\r\nfor_each_online_cpu(cpu) {\r\nint coreid = octeon_coreid_for_cpu(cpu);\r\npen = &per_cpu(octeon_irq_ciu0_en_mirror, cpu);\r\nclear_bit(cd.s.bit, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0(coreid * 2), *pen);\r\n}\r\nraw_spin_unlock_irqrestore(&octeon_irq_ciu0_lock, flags);\r\n} else {\r\nraw_spin_lock_irqsave(&octeon_irq_ciu1_lock, flags);\r\nfor_each_online_cpu(cpu) {\r\nint coreid = octeon_coreid_for_cpu(cpu);\r\npen = &per_cpu(octeon_irq_ciu1_en_mirror, cpu);\r\nclear_bit(cd.s.bit, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1(coreid * 2 + 1), *pen);\r\n}\r\nraw_spin_unlock_irqrestore(&octeon_irq_ciu1_lock, flags);\r\n}\r\n}\r\nstatic void octeon_irq_ciu_enable_all(struct irq_data *data)\r\n{\r\nunsigned long flags;\r\nunsigned long *pen;\r\nint cpu;\r\nunion octeon_ciu_chip_data cd;\r\ncd.p = irq_data_get_irq_chip_data(data);\r\nif (cd.s.line == 0) {\r\nraw_spin_lock_irqsave(&octeon_irq_ciu0_lock, flags);\r\nfor_each_online_cpu(cpu) {\r\nint coreid = octeon_coreid_for_cpu(cpu);\r\npen = &per_cpu(octeon_irq_ciu0_en_mirror, cpu);\r\nset_bit(cd.s.bit, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0(coreid * 2), *pen);\r\n}\r\nraw_spin_unlock_irqrestore(&octeon_irq_ciu0_lock, flags);\r\n} else {\r\nraw_spin_lock_irqsave(&octeon_irq_ciu1_lock, flags);\r\nfor_each_online_cpu(cpu) {\r\nint coreid = octeon_coreid_for_cpu(cpu);\r\npen = &per_cpu(octeon_irq_ciu1_en_mirror, cpu);\r\nset_bit(cd.s.bit, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1(coreid * 2 + 1), *pen);\r\n}\r\nraw_spin_unlock_irqrestore(&octeon_irq_ciu1_lock, flags);\r\n}\r\n}\r\nstatic void octeon_irq_ciu_enable_v2(struct irq_data *data)\r\n{\r\nu64 mask;\r\nint cpu = next_cpu_for_irq(data);\r\nunion octeon_ciu_chip_data cd;\r\ncd.p = irq_data_get_irq_chip_data(data);\r\nmask = 1ull << (cd.s.bit);\r\nif (cd.s.line == 0) {\r\nint index = octeon_coreid_for_cpu(cpu) * 2;\r\nset_bit(cd.s.bit, &per_cpu(octeon_irq_ciu0_en_mirror, cpu));\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0_W1S(index), mask);\r\n} else {\r\nint index = octeon_coreid_for_cpu(cpu) * 2 + 1;\r\nset_bit(cd.s.bit, &per_cpu(octeon_irq_ciu1_en_mirror, cpu));\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1_W1S(index), mask);\r\n}\r\n}\r\nstatic void octeon_irq_ciu_enable_local_v2(struct irq_data *data)\r\n{\r\nu64 mask;\r\nunion octeon_ciu_chip_data cd;\r\ncd.p = irq_data_get_irq_chip_data(data);\r\nmask = 1ull << (cd.s.bit);\r\nif (cd.s.line == 0) {\r\nint index = cvmx_get_core_num() * 2;\r\nset_bit(cd.s.bit, &__get_cpu_var(octeon_irq_ciu0_en_mirror));\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0_W1S(index), mask);\r\n} else {\r\nint index = cvmx_get_core_num() * 2 + 1;\r\nset_bit(cd.s.bit, &__get_cpu_var(octeon_irq_ciu1_en_mirror));\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1_W1S(index), mask);\r\n}\r\n}\r\nstatic void octeon_irq_ciu_disable_local_v2(struct irq_data *data)\r\n{\r\nu64 mask;\r\nunion octeon_ciu_chip_data cd;\r\ncd.p = irq_data_get_irq_chip_data(data);\r\nmask = 1ull << (cd.s.bit);\r\nif (cd.s.line == 0) {\r\nint index = cvmx_get_core_num() * 2;\r\nclear_bit(cd.s.bit, &__get_cpu_var(octeon_irq_ciu0_en_mirror));\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0_W1C(index), mask);\r\n} else {\r\nint index = cvmx_get_core_num() * 2 + 1;\r\nclear_bit(cd.s.bit, &__get_cpu_var(octeon_irq_ciu1_en_mirror));\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1_W1C(index), mask);\r\n}\r\n}\r\nstatic void octeon_irq_ciu_ack(struct irq_data *data)\r\n{\r\nu64 mask;\r\nunion octeon_ciu_chip_data cd;\r\ncd.p = data->chip_data;\r\nmask = 1ull << (cd.s.bit);\r\nif (cd.s.line == 0) {\r\nint index = cvmx_get_core_num() * 2;\r\ncvmx_write_csr(CVMX_CIU_INTX_SUM0(index), mask);\r\n} else {\r\ncvmx_write_csr(CVMX_CIU_INT_SUM1, mask);\r\n}\r\n}\r\nstatic void octeon_irq_ciu_disable_all_v2(struct irq_data *data)\r\n{\r\nint cpu;\r\nu64 mask;\r\nunion octeon_ciu_chip_data cd;\r\nwmb();\r\ncd.p = data->chip_data;\r\nmask = 1ull << (cd.s.bit);\r\nif (cd.s.line == 0) {\r\nfor_each_online_cpu(cpu) {\r\nint index = octeon_coreid_for_cpu(cpu) * 2;\r\nclear_bit(cd.s.bit, &per_cpu(octeon_irq_ciu0_en_mirror, cpu));\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0_W1C(index), mask);\r\n}\r\n} else {\r\nfor_each_online_cpu(cpu) {\r\nint index = octeon_coreid_for_cpu(cpu) * 2 + 1;\r\nclear_bit(cd.s.bit, &per_cpu(octeon_irq_ciu1_en_mirror, cpu));\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1_W1C(index), mask);\r\n}\r\n}\r\n}\r\nstatic void octeon_irq_ciu_enable_all_v2(struct irq_data *data)\r\n{\r\nint cpu;\r\nu64 mask;\r\nunion octeon_ciu_chip_data cd;\r\ncd.p = data->chip_data;\r\nmask = 1ull << (cd.s.bit);\r\nif (cd.s.line == 0) {\r\nfor_each_online_cpu(cpu) {\r\nint index = octeon_coreid_for_cpu(cpu) * 2;\r\nset_bit(cd.s.bit, &per_cpu(octeon_irq_ciu0_en_mirror, cpu));\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0_W1S(index), mask);\r\n}\r\n} else {\r\nfor_each_online_cpu(cpu) {\r\nint index = octeon_coreid_for_cpu(cpu) * 2 + 1;\r\nset_bit(cd.s.bit, &per_cpu(octeon_irq_ciu1_en_mirror, cpu));\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1_W1S(index), mask);\r\n}\r\n}\r\n}\r\nstatic void octeon_irq_cpu_offline_ciu(struct irq_data *data)\r\n{\r\nint cpu = smp_processor_id();\r\ncpumask_t new_affinity;\r\nif (!cpumask_test_cpu(cpu, data->affinity))\r\nreturn;\r\nif (cpumask_weight(data->affinity) > 1) {\r\ncpumask_copy(&new_affinity, data->affinity);\r\ncpumask_clear_cpu(cpu, &new_affinity);\r\n} else {\r\ncpumask_clear(&new_affinity);\r\ncpumask_set_cpu(cpumask_first(cpu_online_mask), &new_affinity);\r\n}\r\n__irq_set_affinity_locked(data, &new_affinity);\r\n}\r\nstatic int octeon_irq_ciu_set_affinity(struct irq_data *data,\r\nconst struct cpumask *dest, bool force)\r\n{\r\nint cpu;\r\nbool enable_one = !irqd_irq_disabled(data) && !irqd_irq_masked(data);\r\nunsigned long flags;\r\nunion octeon_ciu_chip_data cd;\r\ncd.p = data->chip_data;\r\nif (cpumask_weight(dest) != 1)\r\nreturn -EINVAL;\r\nif (!enable_one)\r\nreturn 0;\r\nif (cd.s.line == 0) {\r\nraw_spin_lock_irqsave(&octeon_irq_ciu0_lock, flags);\r\nfor_each_online_cpu(cpu) {\r\nint coreid = octeon_coreid_for_cpu(cpu);\r\nunsigned long *pen = &per_cpu(octeon_irq_ciu0_en_mirror, cpu);\r\nif (cpumask_test_cpu(cpu, dest) && enable_one) {\r\nenable_one = false;\r\nset_bit(cd.s.bit, pen);\r\n} else {\r\nclear_bit(cd.s.bit, pen);\r\n}\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0(coreid * 2), *pen);\r\n}\r\nraw_spin_unlock_irqrestore(&octeon_irq_ciu0_lock, flags);\r\n} else {\r\nraw_spin_lock_irqsave(&octeon_irq_ciu1_lock, flags);\r\nfor_each_online_cpu(cpu) {\r\nint coreid = octeon_coreid_for_cpu(cpu);\r\nunsigned long *pen = &per_cpu(octeon_irq_ciu1_en_mirror, cpu);\r\nif (cpumask_test_cpu(cpu, dest) && enable_one) {\r\nenable_one = false;\r\nset_bit(cd.s.bit, pen);\r\n} else {\r\nclear_bit(cd.s.bit, pen);\r\n}\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1(coreid * 2 + 1), *pen);\r\n}\r\nraw_spin_unlock_irqrestore(&octeon_irq_ciu1_lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic int octeon_irq_ciu_set_affinity_v2(struct irq_data *data,\r\nconst struct cpumask *dest,\r\nbool force)\r\n{\r\nint cpu;\r\nbool enable_one = !irqd_irq_disabled(data) && !irqd_irq_masked(data);\r\nu64 mask;\r\nunion octeon_ciu_chip_data cd;\r\nif (!enable_one)\r\nreturn 0;\r\ncd.p = data->chip_data;\r\nmask = 1ull << cd.s.bit;\r\nif (cd.s.line == 0) {\r\nfor_each_online_cpu(cpu) {\r\nunsigned long *pen = &per_cpu(octeon_irq_ciu0_en_mirror, cpu);\r\nint index = octeon_coreid_for_cpu(cpu) * 2;\r\nif (cpumask_test_cpu(cpu, dest) && enable_one) {\r\nenable_one = false;\r\nset_bit(cd.s.bit, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0_W1S(index), mask);\r\n} else {\r\nclear_bit(cd.s.bit, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0_W1C(index), mask);\r\n}\r\n}\r\n} else {\r\nfor_each_online_cpu(cpu) {\r\nunsigned long *pen = &per_cpu(octeon_irq_ciu1_en_mirror, cpu);\r\nint index = octeon_coreid_for_cpu(cpu) * 2 + 1;\r\nif (cpumask_test_cpu(cpu, dest) && enable_one) {\r\nenable_one = false;\r\nset_bit(cd.s.bit, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1_W1S(index), mask);\r\n} else {\r\nclear_bit(cd.s.bit, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1_W1C(index), mask);\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void octeon_irq_dummy_mask(struct irq_data *data)\r\n{\r\n}\r\nstatic void octeon_irq_ciu_wd_enable(struct irq_data *data)\r\n{\r\nunsigned long flags;\r\nunsigned long *pen;\r\nint coreid = data->irq - OCTEON_IRQ_WDOG0;\r\nint cpu = octeon_cpu_for_coreid(coreid);\r\nraw_spin_lock_irqsave(&octeon_irq_ciu1_lock, flags);\r\npen = &per_cpu(octeon_irq_ciu1_en_mirror, cpu);\r\nset_bit(coreid, pen);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1(coreid * 2 + 1), *pen);\r\nraw_spin_unlock_irqrestore(&octeon_irq_ciu1_lock, flags);\r\n}\r\nstatic void octeon_irq_ciu1_wd_enable_v2(struct irq_data *data)\r\n{\r\nint coreid = data->irq - OCTEON_IRQ_WDOG0;\r\nint cpu = octeon_cpu_for_coreid(coreid);\r\nset_bit(coreid, &per_cpu(octeon_irq_ciu1_en_mirror, cpu));\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1_W1S(coreid * 2 + 1), 1ull << coreid);\r\n}\r\nstatic void octeon_irq_ip2_v1(void)\r\n{\r\nconst unsigned long core_id = cvmx_get_core_num();\r\nu64 ciu_sum = cvmx_read_csr(CVMX_CIU_INTX_SUM0(core_id * 2));\r\nciu_sum &= __get_cpu_var(octeon_irq_ciu0_en_mirror);\r\nclear_c0_status(STATUSF_IP2);\r\nif (likely(ciu_sum)) {\r\nint bit = fls64(ciu_sum) - 1;\r\nint irq = octeon_irq_ciu_to_irq[0][bit];\r\nif (likely(irq))\r\ndo_IRQ(irq);\r\nelse\r\nspurious_interrupt();\r\n} else {\r\nspurious_interrupt();\r\n}\r\nset_c0_status(STATUSF_IP2);\r\n}\r\nstatic void octeon_irq_ip2_v2(void)\r\n{\r\nconst unsigned long core_id = cvmx_get_core_num();\r\nu64 ciu_sum = cvmx_read_csr(CVMX_CIU_INTX_SUM0(core_id * 2));\r\nciu_sum &= __get_cpu_var(octeon_irq_ciu0_en_mirror);\r\nif (likely(ciu_sum)) {\r\nint bit = fls64(ciu_sum) - 1;\r\nint irq = octeon_irq_ciu_to_irq[0][bit];\r\nif (likely(irq))\r\ndo_IRQ(irq);\r\nelse\r\nspurious_interrupt();\r\n} else {\r\nspurious_interrupt();\r\n}\r\n}\r\nstatic void octeon_irq_ip3_v1(void)\r\n{\r\nu64 ciu_sum = cvmx_read_csr(CVMX_CIU_INT_SUM1);\r\nciu_sum &= __get_cpu_var(octeon_irq_ciu1_en_mirror);\r\nclear_c0_status(STATUSF_IP3);\r\nif (likely(ciu_sum)) {\r\nint bit = fls64(ciu_sum) - 1;\r\nint irq = octeon_irq_ciu_to_irq[1][bit];\r\nif (likely(irq))\r\ndo_IRQ(irq);\r\nelse\r\nspurious_interrupt();\r\n} else {\r\nspurious_interrupt();\r\n}\r\nset_c0_status(STATUSF_IP3);\r\n}\r\nstatic void octeon_irq_ip3_v2(void)\r\n{\r\nu64 ciu_sum = cvmx_read_csr(CVMX_CIU_INT_SUM1);\r\nciu_sum &= __get_cpu_var(octeon_irq_ciu1_en_mirror);\r\nif (likely(ciu_sum)) {\r\nint bit = fls64(ciu_sum) - 1;\r\nint irq = octeon_irq_ciu_to_irq[1][bit];\r\nif (likely(irq))\r\ndo_IRQ(irq);\r\nelse\r\nspurious_interrupt();\r\n} else {\r\nspurious_interrupt();\r\n}\r\n}\r\nstatic void octeon_irq_ip4_mask(void)\r\n{\r\nclear_c0_status(STATUSF_IP4);\r\nspurious_interrupt();\r\n}\r\nstatic void __cpuinit octeon_irq_percpu_enable(void)\r\n{\r\nirq_cpu_online();\r\n}\r\nstatic void __cpuinit octeon_irq_init_ciu_percpu(void)\r\n{\r\nint coreid = cvmx_get_core_num();\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0((coreid * 2)), 0);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN0((coreid * 2 + 1)), 0);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1((coreid * 2)), 0);\r\ncvmx_write_csr(CVMX_CIU_INTX_EN1((coreid * 2 + 1)), 0);\r\ncvmx_read_csr(CVMX_CIU_INTX_SUM0((coreid * 2)));\r\n}\r\nstatic void __cpuinit octeon_irq_setup_secondary_ciu(void)\r\n{\r\n__get_cpu_var(octeon_irq_ciu0_en_mirror) = 0;\r\n__get_cpu_var(octeon_irq_ciu1_en_mirror) = 0;\r\nocteon_irq_init_ciu_percpu();\r\nocteon_irq_percpu_enable();\r\nset_c0_status(STATUSF_IP3 | STATUSF_IP2);\r\nclear_c0_status(STATUSF_IP4);\r\n}\r\nstatic void __init octeon_irq_init_ciu(void)\r\n{\r\nunsigned int i;\r\nstruct irq_chip *chip;\r\nstruct irq_chip *chip_edge;\r\nstruct irq_chip *chip_mbox;\r\nstruct irq_chip *chip_wd;\r\nocteon_irq_init_ciu_percpu();\r\nocteon_irq_setup_secondary = octeon_irq_setup_secondary_ciu;\r\nif (OCTEON_IS_MODEL(OCTEON_CN58XX_PASS2_X) ||\r\nOCTEON_IS_MODEL(OCTEON_CN56XX_PASS2_X) ||\r\nOCTEON_IS_MODEL(OCTEON_CN52XX_PASS2_X) ||\r\nOCTEON_IS_MODEL(OCTEON_CN6XXX)) {\r\nocteon_irq_ip2 = octeon_irq_ip2_v2;\r\nocteon_irq_ip3 = octeon_irq_ip3_v2;\r\nchip = &octeon_irq_chip_ciu_v2;\r\nchip_edge = &octeon_irq_chip_ciu_edge_v2;\r\nchip_mbox = &octeon_irq_chip_ciu_mbox_v2;\r\nchip_wd = &octeon_irq_chip_ciu_wd_v2;\r\n} else {\r\nocteon_irq_ip2 = octeon_irq_ip2_v1;\r\nocteon_irq_ip3 = octeon_irq_ip3_v1;\r\nchip = &octeon_irq_chip_ciu;\r\nchip_edge = &octeon_irq_chip_ciu_edge;\r\nchip_mbox = &octeon_irq_chip_ciu_mbox;\r\nchip_wd = &octeon_irq_chip_ciu_wd;\r\n}\r\nocteon_irq_ip4 = octeon_irq_ip4_mask;\r\nocteon_irq_init_core();\r\nfor (i = 0; i < 16; i++)\r\nocteon_irq_set_ciu_mapping(i + OCTEON_IRQ_WORKQ0, 0, i + 0, chip, handle_level_irq);\r\nfor (i = 0; i < 16; i++)\r\nocteon_irq_set_ciu_mapping(i + OCTEON_IRQ_GPIO0, 0, i + 16, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_MBOX0, 0, 32, chip_mbox, handle_percpu_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_MBOX1, 0, 33, chip_mbox, handle_percpu_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_UART0, 0, 34, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_UART1, 0, 35, chip, handle_level_irq);\r\nfor (i = 0; i < 4; i++)\r\nocteon_irq_set_ciu_mapping(i + OCTEON_IRQ_PCI_INT0, 0, i + 36, chip, handle_level_irq);\r\nfor (i = 0; i < 4; i++)\r\nocteon_irq_set_ciu_mapping(i + OCTEON_IRQ_PCI_MSI0, 0, i + 40, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_TWSI, 0, 45, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_RML, 0, 46, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_TRACE0, 0, 47, chip, handle_level_irq);\r\nfor (i = 0; i < 2; i++)\r\nocteon_irq_set_ciu_mapping(i + OCTEON_IRQ_GMX_DRP0, 0, i + 48, chip_edge, handle_edge_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_IPD_DRP, 0, 50, chip_edge, handle_edge_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_KEY_ZERO, 0, 51, chip_edge, handle_edge_irq);\r\nfor (i = 0; i < 4; i++)\r\nocteon_irq_set_ciu_mapping(i + OCTEON_IRQ_TIMER0, 0, i + 52, chip_edge, handle_edge_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_USB0, 0, 56, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_PCM, 0, 57, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_MPI, 0, 58, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_TWSI2, 0, 59, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_POWIQ, 0, 60, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_IPDPPTHR, 0, 61, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_MII0, 0, 62, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_BOOTDMA, 0, 63, chip, handle_level_irq);\r\nfor (i = 0; i < 16; i++)\r\nocteon_irq_set_ciu_mapping(i + OCTEON_IRQ_WDOG0, 1, i + 0, chip_wd, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_UART2, 1, 16, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_USB1, 1, 17, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_MII1, 1, 18, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_NAND, 1, 19, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_MIO, 1, 20, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_IOB, 1, 21, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_FPA, 1, 22, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_POW, 1, 23, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_L2C, 1, 24, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_IPD, 1, 25, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_PIP, 1, 26, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_PKO, 1, 27, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_ZIP, 1, 28, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_TIM, 1, 29, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_RAD, 1, 30, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_KEY, 1, 31, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_DFA, 1, 32, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_USBCTL, 1, 33, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_SLI, 1, 34, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_DPI, 1, 35, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_AGX0, 1, 36, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_AGL, 1, 46, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_PTP, 1, 47, chip_edge, handle_edge_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_PEM0, 1, 48, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_PEM1, 1, 49, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_SRIO0, 1, 50, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_SRIO1, 1, 51, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_LMC0, 1, 52, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_DFM, 1, 56, chip, handle_level_irq);\r\nocteon_irq_set_ciu_mapping(OCTEON_IRQ_RST, 1, 63, chip, handle_level_irq);\r\nset_c0_status(STATUSF_IP3 | STATUSF_IP2);\r\nclear_c0_status(STATUSF_IP4);\r\n}\r\nvoid __init arch_init_irq(void)\r\n{\r\n#ifdef CONFIG_SMP\r\ncpumask_clear(irq_default_affinity);\r\ncpumask_set_cpu(smp_processor_id(), irq_default_affinity);\r\n#endif\r\nocteon_irq_init_ciu();\r\n}\r\nasmlinkage void plat_irq_dispatch(void)\r\n{\r\nunsigned long cop0_cause;\r\nunsigned long cop0_status;\r\nwhile (1) {\r\ncop0_cause = read_c0_cause();\r\ncop0_status = read_c0_status();\r\ncop0_cause &= cop0_status;\r\ncop0_cause &= ST0_IM;\r\nif (unlikely(cop0_cause & STATUSF_IP2))\r\nocteon_irq_ip2();\r\nelse if (unlikely(cop0_cause & STATUSF_IP3))\r\nocteon_irq_ip3();\r\nelse if (unlikely(cop0_cause & STATUSF_IP4))\r\nocteon_irq_ip4();\r\nelse if (likely(cop0_cause))\r\ndo_IRQ(fls(cop0_cause) - 9 + MIPS_CPU_IRQ_BASE);\r\nelse\r\nbreak;\r\n}\r\n}\r\nvoid fixup_irqs(void)\r\n{\r\nirq_cpu_offline();\r\n}

ssize_t i2400ms_bus_bm_cmd_send(struct i2400m *i2400m,\r\nconst struct i2400m_bootrom_header *_cmd,\r\nsize_t cmd_size, int flags)\r\n{\r\nssize_t result;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nstruct i2400ms *i2400ms = container_of(i2400m, struct i2400ms, i2400m);\r\nint opcode = _cmd == NULL ? -1 : i2400m_brh_get_opcode(_cmd);\r\nstruct i2400m_bootrom_header *cmd;\r\nsize_t cmd_size_a = ALIGN(cmd_size, I2400MS_BLK_SIZE);\r\nd_fnstart(5, dev, "(i2400m %p cmd %p size %zu)\n",\r\ni2400m, _cmd, cmd_size);\r\nresult = -E2BIG;\r\nif (cmd_size > I2400M_BM_CMD_BUF_SIZE)\r\ngoto error_too_big;\r\nif (_cmd != i2400m->bm_cmd_buf)\r\nmemmove(i2400m->bm_cmd_buf, _cmd, cmd_size);\r\ncmd = i2400m->bm_cmd_buf;\r\nif (cmd_size_a > cmd_size)\r\nmemset(i2400m->bm_cmd_buf + cmd_size, 0, cmd_size_a - cmd_size);\r\nif ((flags & I2400M_BM_CMD_RAW) == 0) {\r\nif (WARN_ON(i2400m_brh_get_response_required(cmd) == 0))\r\ndev_warn(dev, "SW BUG: response_required == 0\n");\r\ni2400m_bm_cmd_prepare(cmd);\r\n}\r\nd_printf(4, dev, "BM cmd %d: %zu bytes (%zu padded)\n",\r\nopcode, cmd_size, cmd_size_a);\r\nd_dump(5, dev, cmd, cmd_size);\r\nsdio_claim_host(i2400ms->func);\r\nresult = sdio_memcpy_toio(i2400ms->func, I2400MS_DATA_ADDR,\r\ni2400m->bm_cmd_buf, cmd_size_a);\r\nsdio_release_host(i2400ms->func);\r\nif (result < 0) {\r\ndev_err(dev, "BM cmd %d: cannot send: %ld\n",\r\nopcode, (long) result);\r\ngoto error_cmd_send;\r\n}\r\nresult = cmd_size;\r\nerror_cmd_send:\r\nerror_too_big:\r\nd_fnend(5, dev, "(i2400m %p cmd %p size %zu) = %d\n",\r\ni2400m, _cmd, cmd_size, (int) result);\r\nreturn result;\r\n}\r\nssize_t i2400ms_bus_bm_wait_for_ack(struct i2400m *i2400m,\r\nstruct i2400m_bootrom_header *ack,\r\nsize_t ack_size)\r\n{\r\nssize_t result;\r\nstruct i2400ms *i2400ms = container_of(i2400m, struct i2400ms, i2400m);\r\nstruct sdio_func *func = i2400ms->func;\r\nstruct device *dev = &func->dev;\r\nint size;\r\nBUG_ON(sizeof(*ack) > ack_size);\r\nd_fnstart(5, dev, "(i2400m %p ack %p size %zu)\n",\r\ni2400m, ack, ack_size);\r\nresult = wait_event_timeout(i2400ms->bm_wfa_wq,\r\ni2400ms->bm_ack_size != -EINPROGRESS,\r\n2 * HZ);\r\nif (result == 0) {\r\nresult = -ETIMEDOUT;\r\ndev_err(dev, "BM: error waiting for an ack\n");\r\ngoto error_timeout;\r\n}\r\nspin_lock(&i2400m->rx_lock);\r\nresult = i2400ms->bm_ack_size;\r\nBUG_ON(result == -EINPROGRESS);\r\nif (result < 0)\r\ndev_err(dev, "BM: %s failed: %zd\n", __func__, result);\r\nelse {\r\nsize = min(ack_size, i2400ms->bm_ack_size);\r\nmemcpy(ack, i2400m->bm_ack_buf, size);\r\n}\r\ni2400ms->bm_ack_size = -EINPROGRESS;\r\nspin_unlock(&i2400m->rx_lock);\r\nerror_timeout:\r\nd_fnend(5, dev, "(i2400m %p ack %p size %zu) = %zd\n",\r\ni2400m, ack, ack_size, result);\r\nreturn result;\r\n}

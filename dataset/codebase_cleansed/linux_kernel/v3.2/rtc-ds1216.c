static void ds1216_read(u8 __iomem *ioaddr, u8 *buf)\r\n{\r\nunsigned char c;\r\nint i, j;\r\nfor (i = 0; i < 8; i++) {\r\nc = 0;\r\nfor (j = 0; j < 8; j++)\r\nc |= (readb(ioaddr) & 0x1) << j;\r\nbuf[i] = c;\r\n}\r\n}\r\nstatic void ds1216_write(u8 __iomem *ioaddr, const u8 *buf)\r\n{\r\nunsigned char c;\r\nint i, j;\r\nfor (i = 0; i < 8; i++) {\r\nc = buf[i];\r\nfor (j = 0; j < 8; j++) {\r\nwriteb(c, ioaddr);\r\nc = c >> 1;\r\n}\r\n}\r\n}\r\nstatic void ds1216_switch_ds_to_clock(u8 __iomem *ioaddr)\r\n{\r\nreadb(ioaddr);\r\nds1216_write(ioaddr, magic);\r\n}\r\nstatic int ds1216_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct ds1216_priv *priv = platform_get_drvdata(pdev);\r\nstruct ds1216_regs regs;\r\nds1216_switch_ds_to_clock(priv->ioaddr);\r\nds1216_read(priv->ioaddr, (u8 *)&regs);\r\ntm->tm_sec = bcd2bin(regs.sec);\r\ntm->tm_min = bcd2bin(regs.min);\r\nif (regs.hour & DS1216_HOUR_1224) {\r\ntm->tm_hour = bcd2bin(regs.hour & 0x1f);\r\nif (regs.hour & DS1216_HOUR_AMPM)\r\ntm->tm_hour += 12;\r\n} else\r\ntm->tm_hour = bcd2bin(regs.hour & 0x3f);\r\ntm->tm_wday = (regs.wday & 7) - 1;\r\ntm->tm_mday = bcd2bin(regs.mday & 0x3f);\r\ntm->tm_mon = bcd2bin(regs.month & 0x1f);\r\ntm->tm_year = bcd2bin(regs.year);\r\nif (tm->tm_year < 70)\r\ntm->tm_year += 100;\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int ds1216_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct ds1216_priv *priv = platform_get_drvdata(pdev);\r\nstruct ds1216_regs regs;\r\nds1216_switch_ds_to_clock(priv->ioaddr);\r\nds1216_read(priv->ioaddr, (u8 *)&regs);\r\nregs.tsec = 0;\r\nregs.sec = bin2bcd(tm->tm_sec);\r\nregs.min = bin2bcd(tm->tm_min);\r\nregs.hour &= DS1216_HOUR_1224;\r\nif (regs.hour && tm->tm_hour > 12) {\r\nregs.hour |= DS1216_HOUR_AMPM;\r\ntm->tm_hour -= 12;\r\n}\r\nregs.hour |= bin2bcd(tm->tm_hour);\r\nregs.wday &= ~7;\r\nregs.wday |= tm->tm_wday;\r\nregs.mday = bin2bcd(tm->tm_mday);\r\nregs.month = bin2bcd(tm->tm_mon);\r\nregs.year = bin2bcd(tm->tm_year % 100);\r\nds1216_switch_ds_to_clock(priv->ioaddr);\r\nds1216_write(priv->ioaddr, (u8 *)&regs);\r\nreturn 0;\r\n}\r\nstatic int __init ds1216_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct ds1216_priv *priv;\r\nint ret = 0;\r\nu8 dummy[8];\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\npriv = kzalloc(sizeof *priv, GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, priv);\r\npriv->size = resource_size(res);\r\nif (!request_mem_region(res->start, priv->size, pdev->name)) {\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\npriv->baseaddr = res->start;\r\npriv->ioaddr = ioremap(priv->baseaddr, priv->size);\r\nif (!priv->ioaddr) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\npriv->rtc = rtc_device_register("ds1216", &pdev->dev,\r\n&ds1216_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(priv->rtc)) {\r\nret = PTR_ERR(priv->rtc);\r\ngoto out;\r\n}\r\nds1216_read(priv->ioaddr, dummy);\r\nreturn 0;\r\nout:\r\nif (priv->ioaddr)\r\niounmap(priv->ioaddr);\r\nif (priv->baseaddr)\r\nrelease_mem_region(priv->baseaddr, priv->size);\r\nkfree(priv);\r\nreturn ret;\r\n}\r\nstatic int __exit ds1216_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct ds1216_priv *priv = platform_get_drvdata(pdev);\r\nrtc_device_unregister(priv->rtc);\r\niounmap(priv->ioaddr);\r\nrelease_mem_region(priv->baseaddr, priv->size);\r\nkfree(priv);\r\nreturn 0;\r\n}\r\nstatic int __init ds1216_rtc_init(void)\r\n{\r\nreturn platform_driver_probe(&ds1216_rtc_platform_driver, ds1216_rtc_probe);\r\n}\r\nstatic void __exit ds1216_rtc_exit(void)\r\n{\r\nplatform_driver_unregister(&ds1216_rtc_platform_driver);\r\n}

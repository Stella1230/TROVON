static void\r\nh7202_timerx_demux_handler(unsigned int irq_unused, struct irq_desc *desc)\r\n{\r\nunsigned int mask, irq;\r\nmask = CPU_REG (TIMER_VIRT, TIMER_TOPSTAT);\r\nif ( mask & TSTAT_T0INT ) {\r\ntimer_tick();\r\nif( mask == TSTAT_T0INT )\r\nreturn;\r\n}\r\nmask >>= 1;\r\nirq = IRQ_TIMER1;\r\nwhile (mask) {\r\nif (mask & 1)\r\ngeneric_handle_irq(irq);\r\nirq++;\r\nmask >>= 1;\r\n}\r\n}\r\nstatic irqreturn_t\r\nh7202_timer_interrupt(int irq, void *dev_id)\r\n{\r\nh7202_timerx_demux_handler(0, NULL);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void inline __mask_timerx_irq(unsigned int irq)\r\n{\r\nunsigned int bit;\r\nbit = 2 << ((irq == IRQ_TIMER64B) ? 4 : (irq - IRQ_TIMER1));\r\nCPU_REG (TIMER_VIRT, TIMER_TOPCTRL) &= ~bit;\r\n}\r\nstatic void inline mask_timerx_irq(struct irq_data *d)\r\n{\r\n__mask_timerx_irq(d->irq);\r\n}\r\nstatic void inline unmask_timerx_irq(struct irq_data *d)\r\n{\r\nunsigned int bit;\r\nbit = 2 << ((d->irq == IRQ_TIMER64B) ? 4 : (d->irq - IRQ_TIMER1));\r\nCPU_REG (TIMER_VIRT, TIMER_TOPCTRL) |= bit;\r\n}\r\nvoid __init h7202_init_time(void)\r\n{\r\nCPU_REG (TIMER_VIRT, TM0_PERIOD) = LATCH;\r\nCPU_REG (TIMER_VIRT, TM0_CTRL) = TM_RESET;\r\nCPU_REG (TIMER_VIRT, TM0_CTRL) = TM_REPEAT | TM_START;\r\nCPU_REG (TIMER_VIRT, TIMER_TOPCTRL) = ENABLE_TM0_INTR | TIMER_ENABLE_BIT;\r\nsetup_irq(IRQ_TIMER0, &h7202_timer_irq);\r\n}\r\nvoid __init h7202_init_irq (void)\r\n{\r\nint irq;\r\nCPU_REG (GPIO_E_VIRT, GPIO_MASK) = 0x0;\r\nfor (irq = IRQ_TIMER1;\r\nirq < IRQ_CHAINED_TIMERX(NR_TIMERX_IRQS); irq++) {\r\n__mask_timerx_irq(irq);\r\nirq_set_chip_and_handler(irq, &h7202_timerx_chip,\r\nhandle_edge_irq);\r\nset_irq_flags(irq, IRQF_VALID );\r\n}\r\nirq_set_chained_handler(IRQ_TIMERX, h7202_timerx_demux_handler);\r\nh720x_init_irq();\r\n}\r\nvoid __init init_hw_h7202(void)\r\n{\r\nCPU_REG (PMU_BASE, PMU_PLL_CTRL) |= PLL_2_EN | PLL_1_EN | PLL_3_MUTE;\r\nCPU_REG (SERIAL0_VIRT, SERIAL_ENABLE) = SERIAL_ENABLE_EN;\r\nCPU_REG (SERIAL1_VIRT, SERIAL_ENABLE) = SERIAL_ENABLE_EN;\r\n#ifdef CONFIG_H7202_SERIAL23\r\nCPU_REG (SERIAL2_VIRT, SERIAL_ENABLE) = SERIAL_ENABLE_EN;\r\nCPU_REG (SERIAL3_VIRT, SERIAL_ENABLE) = SERIAL_ENABLE_EN;\r\nCPU_IO (GPIO_AMULSEL) = AMULSEL_USIN2 | AMULSEL_USOUT2 |\r\nAMULSEL_USIN3 | AMULSEL_USOUT3;\r\n#endif\r\n(void) platform_add_devices(devices, ARRAY_SIZE(devices));\r\n}

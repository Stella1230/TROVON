static inline int uhc_clkctrl_ready(u32 val)\r\n{\r\nconst u32 mask = SCC_UHC_USBCEN | SCC_UHC_USBCEN;\r\nreturn((val & mask) == mask);\r\n}\r\nstatic void enable_scc_uhc(struct pci_dev *dev)\r\n{\r\nvoid __iomem *uhc_base;\r\nu32 __iomem *uhc_clkctrl;\r\nu32 __iomem *uhc_ecmode;\r\nu32 val = 0;\r\nint i;\r\nif (!machine_is(celleb_beat) &&\r\n!machine_is(celleb_native))\r\nreturn;\r\nuhc_base = ioremap(pci_resource_start(dev, 0),\r\npci_resource_len(dev, 0));\r\nif (!uhc_base) {\r\nprintk(KERN_ERR "failed to map UHC register base.\n");\r\nreturn;\r\n}\r\nuhc_clkctrl = uhc_base + SCC_UHC_CKRCTRL;\r\nuhc_ecmode = uhc_base + SCC_UHC_ECMODE;\r\nval |= SCC_UHC_F48MCKLEN;\r\nout_be32(uhc_clkctrl, val);\r\nval |= SCC_UHC_PHY_SUSPEND_SEL;\r\nout_be32(uhc_clkctrl, val);\r\nudelay(10);\r\nval |= SCC_UHC_PHYEN;\r\nout_be32(uhc_clkctrl, val);\r\nudelay(50);\r\nval |= SCC_UHC_HCLKEN;\r\nout_be32(uhc_clkctrl, val);\r\nval |= (SCC_UHC_USBCEN | SCC_UHC_USBEN);\r\nout_be32(uhc_clkctrl, val);\r\ni = 0;\r\nwhile (!uhc_clkctrl_ready(in_be32(uhc_clkctrl))) {\r\nudelay(10);\r\nif (i++ > UHC_RESET_WAIT_MAX) {\r\nprintk(KERN_ERR "Failed to disable UHC reset %x\n",\r\nin_be32(uhc_clkctrl));\r\nbreak;\r\n}\r\n}\r\nout_be32(uhc_ecmode, SCC_UHC_ECMODE_BY_BYTE);\r\niounmap(uhc_base);\r\n}

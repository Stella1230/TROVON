static irqreturn_t math_error_irq(int cpl, void *dev_id)\r\n{\r\noutb(0, 0xF0);\r\nif (ignore_fpu_irq || !boot_cpu_data.hard_math)\r\nreturn IRQ_NONE;\r\nmath_error(get_irq_regs(), 0, 16);\r\nreturn IRQ_HANDLED;\r\n}\r\nint vector_used_by_percpu_irq(unsigned int vector)\r\n{\r\nint cpu;\r\nfor_each_online_cpu(cpu) {\r\nif (per_cpu(vector_irq, cpu)[vector] != -1)\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nvoid __init init_ISA_irqs(void)\r\n{\r\nstruct irq_chip *chip = legacy_pic->chip;\r\nconst char *name = chip->name;\r\nint i;\r\n#if defined(CONFIG_X86_64) || defined(CONFIG_X86_LOCAL_APIC)\r\ninit_bsp_APIC();\r\n#endif\r\nlegacy_pic->init(0);\r\nfor (i = 0; i < legacy_pic->nr_legacy_irqs; i++)\r\nirq_set_chip_and_handler_name(i, chip, handle_level_irq, name);\r\n}\r\nvoid __init init_IRQ(void)\r\n{\r\nint i;\r\nx86_add_irq_domains();\r\nfor (i = 0; i < legacy_pic->nr_legacy_irqs; i++)\r\nper_cpu(vector_irq, 0)[IRQ0_VECTOR + i] = i;\r\nx86_init.irqs.intr_init();\r\n}\r\nvoid setup_vector_irq(int cpu)\r\n{\r\n#ifndef CONFIG_X86_IO_APIC\r\nint irq;\r\nfor (irq = 0; irq < legacy_pic->nr_legacy_irqs; irq++)\r\nper_cpu(vector_irq, cpu)[IRQ0_VECTOR + irq] = irq;\r\n#endif\r\n__setup_vector_irq(cpu);\r\n}\r\nstatic void __init smp_intr_init(void)\r\n{\r\n#ifdef CONFIG_SMP\r\n#if defined(CONFIG_X86_64) || defined(CONFIG_X86_LOCAL_APIC)\r\nalloc_intr_gate(RESCHEDULE_VECTOR, reschedule_interrupt);\r\n#define ALLOC_INVTLB_VEC(NR) \\r\nalloc_intr_gate(INVALIDATE_TLB_VECTOR_START+NR, \\r\ninvalidate_interrupt##NR)\r\nswitch (NUM_INVALIDATE_TLB_VECTORS) {\r\ndefault:\r\nALLOC_INVTLB_VEC(31);\r\ncase 31:\r\nALLOC_INVTLB_VEC(30);\r\ncase 30:\r\nALLOC_INVTLB_VEC(29);\r\ncase 29:\r\nALLOC_INVTLB_VEC(28);\r\ncase 28:\r\nALLOC_INVTLB_VEC(27);\r\ncase 27:\r\nALLOC_INVTLB_VEC(26);\r\ncase 26:\r\nALLOC_INVTLB_VEC(25);\r\ncase 25:\r\nALLOC_INVTLB_VEC(24);\r\ncase 24:\r\nALLOC_INVTLB_VEC(23);\r\ncase 23:\r\nALLOC_INVTLB_VEC(22);\r\ncase 22:\r\nALLOC_INVTLB_VEC(21);\r\ncase 21:\r\nALLOC_INVTLB_VEC(20);\r\ncase 20:\r\nALLOC_INVTLB_VEC(19);\r\ncase 19:\r\nALLOC_INVTLB_VEC(18);\r\ncase 18:\r\nALLOC_INVTLB_VEC(17);\r\ncase 17:\r\nALLOC_INVTLB_VEC(16);\r\ncase 16:\r\nALLOC_INVTLB_VEC(15);\r\ncase 15:\r\nALLOC_INVTLB_VEC(14);\r\ncase 14:\r\nALLOC_INVTLB_VEC(13);\r\ncase 13:\r\nALLOC_INVTLB_VEC(12);\r\ncase 12:\r\nALLOC_INVTLB_VEC(11);\r\ncase 11:\r\nALLOC_INVTLB_VEC(10);\r\ncase 10:\r\nALLOC_INVTLB_VEC(9);\r\ncase 9:\r\nALLOC_INVTLB_VEC(8);\r\ncase 8:\r\nALLOC_INVTLB_VEC(7);\r\ncase 7:\r\nALLOC_INVTLB_VEC(6);\r\ncase 6:\r\nALLOC_INVTLB_VEC(5);\r\ncase 5:\r\nALLOC_INVTLB_VEC(4);\r\ncase 4:\r\nALLOC_INVTLB_VEC(3);\r\ncase 3:\r\nALLOC_INVTLB_VEC(2);\r\ncase 2:\r\nALLOC_INVTLB_VEC(1);\r\ncase 1:\r\nALLOC_INVTLB_VEC(0);\r\nbreak;\r\n}\r\nalloc_intr_gate(CALL_FUNCTION_VECTOR, call_function_interrupt);\r\nalloc_intr_gate(CALL_FUNCTION_SINGLE_VECTOR,\r\ncall_function_single_interrupt);\r\nset_intr_gate(IRQ_MOVE_CLEANUP_VECTOR, irq_move_cleanup_interrupt);\r\nset_bit(IRQ_MOVE_CLEANUP_VECTOR, used_vectors);\r\nalloc_intr_gate(REBOOT_VECTOR, reboot_interrupt);\r\n#endif\r\n#endif\r\n}\r\nstatic void __init apic_intr_init(void)\r\n{\r\nsmp_intr_init();\r\n#ifdef CONFIG_X86_THERMAL_VECTOR\r\nalloc_intr_gate(THERMAL_APIC_VECTOR, thermal_interrupt);\r\n#endif\r\n#ifdef CONFIG_X86_MCE_THRESHOLD\r\nalloc_intr_gate(THRESHOLD_APIC_VECTOR, threshold_interrupt);\r\n#endif\r\n#if defined(CONFIG_X86_64) || defined(CONFIG_X86_LOCAL_APIC)\r\nalloc_intr_gate(LOCAL_TIMER_VECTOR, apic_timer_interrupt);\r\nalloc_intr_gate(X86_PLATFORM_IPI_VECTOR, x86_platform_ipi);\r\nalloc_intr_gate(SPURIOUS_APIC_VECTOR, spurious_interrupt);\r\nalloc_intr_gate(ERROR_APIC_VECTOR, error_interrupt);\r\n# ifdef CONFIG_IRQ_WORK\r\nalloc_intr_gate(IRQ_WORK_VECTOR, irq_work_interrupt);\r\n# endif\r\n#endif\r\n}\r\nvoid __init native_init_IRQ(void)\r\n{\r\nint i;\r\nx86_init.irqs.pre_vector_init();\r\napic_intr_init();\r\nfor (i = FIRST_EXTERNAL_VECTOR; i < NR_VECTORS; i++) {\r\nif (!test_bit(i, used_vectors))\r\nset_intr_gate(i, interrupt[i-FIRST_EXTERNAL_VECTOR]);\r\n}\r\nif (!acpi_ioapic && !of_ioapic)\r\nsetup_irq(2, &irq2);\r\n#ifdef CONFIG_X86_32\r\nif (boot_cpu_data.hard_math && !cpu_has_fpu)\r\nsetup_irq(FPU_IRQ, &fpu_irq);\r\nirq_ctx_init(smp_processor_id());\r\n#endif\r\n}

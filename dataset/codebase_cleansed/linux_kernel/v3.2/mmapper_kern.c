static ssize_t mmapper_read(struct file *file, char __user *buf, size_t count,\r\nloff_t *ppos)\r\n{\r\nreturn simple_read_from_buffer(buf, count, ppos, v_buf, mmapper_size);\r\n}\r\nstatic ssize_t mmapper_write(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nif (*ppos > mmapper_size)\r\nreturn -EINVAL;\r\nreturn simple_write_to_buffer(v_buf, mmapper_size, ppos, buf, count);\r\n}\r\nstatic long mmapper_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nreturn -ENOIOCTLCMD;\r\n}\r\nstatic int mmapper_mmap(struct file *file, struct vm_area_struct *vma)\r\n{\r\nint ret = -EINVAL;\r\nint size;\r\nif (vma->vm_pgoff != 0)\r\ngoto out;\r\nsize = vma->vm_end - vma->vm_start;\r\nif (size > mmapper_size)\r\nreturn -EFAULT;\r\nif (remap_pfn_range(vma, vma->vm_start, p_buf >> PAGE_SHIFT, size,\r\nvma->vm_page_prot))\r\ngoto out;\r\nret = 0;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int mmapper_open(struct inode *inode, struct file *file)\r\n{\r\nreturn 0;\r\n}\r\nstatic int mmapper_release(struct inode *inode, struct file *file)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __init mmapper_init(void)\r\n{\r\nint err;\r\nprintk(KERN_INFO "Mapper v0.1\n");\r\nv_buf = (char *) find_iomem("mmapper", &mmapper_size);\r\nif (mmapper_size == 0) {\r\nprintk(KERN_ERR "mmapper_init - find_iomem failed\n");\r\nreturn -ENODEV;\r\n}\r\np_buf = __pa(v_buf);\r\nerr = misc_register(&mmapper_dev);\r\nif (err) {\r\nprintk(KERN_ERR "mmapper - misc_register failed, err = %d\n",\r\nerr);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic void mmapper_exit(void)\r\n{\r\nmisc_deregister(&mmapper_dev);\r\n}

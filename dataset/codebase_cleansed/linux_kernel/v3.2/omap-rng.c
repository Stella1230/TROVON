static inline u32 omap_rng_read_reg(int reg)\r\n{\r\nreturn __raw_readl(rng_base + reg);\r\n}\r\nstatic inline void omap_rng_write_reg(int reg, u32 val)\r\n{\r\n__raw_writel(val, rng_base + reg);\r\n}\r\nstatic int omap_rng_data_present(struct hwrng *rng, int wait)\r\n{\r\nint data, i;\r\nfor (i = 0; i < 20; i++) {\r\ndata = omap_rng_read_reg(RNG_STAT_REG) ? 0 : 1;\r\nif (data || !wait)\r\nbreak;\r\nudelay(10);\r\n}\r\nreturn data;\r\n}\r\nstatic int omap_rng_data_read(struct hwrng *rng, u32 *data)\r\n{\r\n*data = omap_rng_read_reg(RNG_OUT_REG);\r\nreturn 4;\r\n}\r\nstatic int __devinit omap_rng_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nint ret;\r\nif (rng_dev)\r\nreturn -EBUSY;\r\nif (cpu_is_omap24xx()) {\r\nrng_ick = clk_get(&pdev->dev, "ick");\r\nif (IS_ERR(rng_ick)) {\r\ndev_err(&pdev->dev, "Could not get rng_ick\n");\r\nret = PTR_ERR(rng_ick);\r\nreturn ret;\r\n} else\r\nclk_enable(rng_ick);\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\nret = -ENOENT;\r\ngoto err_region;\r\n}\r\nif (!request_mem_region(res->start, resource_size(res), pdev->name)) {\r\nret = -EBUSY;\r\ngoto err_region;\r\n}\r\ndev_set_drvdata(&pdev->dev, res);\r\nrng_base = ioremap(res->start, resource_size(res));\r\nif (!rng_base) {\r\nret = -ENOMEM;\r\ngoto err_ioremap;\r\n}\r\nret = hwrng_register(&omap_rng_ops);\r\nif (ret)\r\ngoto err_register;\r\ndev_info(&pdev->dev, "OMAP Random Number Generator ver. %02x\n",\r\nomap_rng_read_reg(RNG_REV_REG));\r\nomap_rng_write_reg(RNG_MASK_REG, 0x1);\r\nrng_dev = pdev;\r\nreturn 0;\r\nerr_register:\r\niounmap(rng_base);\r\nrng_base = NULL;\r\nerr_ioremap:\r\nrelease_mem_region(res->start, resource_size(res));\r\nerr_region:\r\nif (cpu_is_omap24xx()) {\r\nclk_disable(rng_ick);\r\nclk_put(rng_ick);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __exit omap_rng_remove(struct platform_device *pdev)\r\n{\r\nstruct resource *res = dev_get_drvdata(&pdev->dev);\r\nhwrng_unregister(&omap_rng_ops);\r\nomap_rng_write_reg(RNG_MASK_REG, 0x0);\r\niounmap(rng_base);\r\nif (cpu_is_omap24xx()) {\r\nclk_disable(rng_ick);\r\nclk_put(rng_ick);\r\n}\r\nrelease_mem_region(res->start, resource_size(res));\r\nrng_base = NULL;\r\nreturn 0;\r\n}\r\nstatic int omap_rng_suspend(struct platform_device *pdev, pm_message_t message)\r\n{\r\nomap_rng_write_reg(RNG_MASK_REG, 0x0);\r\nreturn 0;\r\n}\r\nstatic int omap_rng_resume(struct platform_device *pdev)\r\n{\r\nomap_rng_write_reg(RNG_MASK_REG, 0x1);\r\nreturn 0;\r\n}\r\nstatic int __init omap_rng_init(void)\r\n{\r\nif (!cpu_is_omap16xx() && !cpu_is_omap24xx())\r\nreturn -ENODEV;\r\nreturn platform_driver_register(&omap_rng_driver);\r\n}\r\nstatic void __exit omap_rng_exit(void)\r\n{\r\nplatform_driver_unregister(&omap_rng_driver);\r\n}

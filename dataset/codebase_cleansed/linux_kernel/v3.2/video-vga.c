static u8 vga_set_basic_mode(void)\r\n{\r\nstruct biosregs ireg, oreg;\r\nu8 mode;\r\ninitregs(&ireg);\r\nireg.ax = 0x0f00;\r\nintcall(0x10, &ireg, &oreg);\r\nmode = oreg.al;\r\nif (mode != 3 && mode != 7)\r\nmode = 3;\r\nireg.ax = mode;\r\nintcall(0x10, &ireg, NULL);\r\ndo_restore = 1;\r\nreturn mode;\r\n}\r\nstatic void vga_set_8font(void)\r\n{\r\nstruct biosregs ireg;\r\ninitregs(&ireg);\r\nireg.ax = 0x1112;\r\nintcall(0x10, &ireg, NULL);\r\nireg.ax = 0x1200;\r\nireg.bl = 0x20;\r\nintcall(0x10, &ireg, NULL);\r\nireg.ax = 0x1201;\r\nireg.bl = 0x34;\r\nintcall(0x10, &ireg, NULL);\r\nireg.ax = 0x0100;\r\nireg.cx = 0x0607;\r\nintcall(0x10, &ireg, NULL);\r\n}\r\nstatic void vga_set_14font(void)\r\n{\r\nstruct biosregs ireg;\r\ninitregs(&ireg);\r\nireg.ax = 0x1111;\r\nintcall(0x10, &ireg, NULL);\r\nireg.ax = 0x1201;\r\nireg.bl = 0x34;\r\nintcall(0x10, &ireg, NULL);\r\nireg.ax = 0x0100;\r\nireg.cx = 0x0b0c;\r\nintcall(0x10, &ireg, NULL);\r\n}\r\nstatic void vga_set_80x43(void)\r\n{\r\nstruct biosregs ireg;\r\ninitregs(&ireg);\r\nireg.ax = 0x1201;\r\nireg.bl = 0x30;\r\nintcall(0x10, &ireg, NULL);\r\nireg.ax = 0x0003;\r\nintcall(0x10, &ireg, NULL);\r\nvga_set_8font();\r\n}\r\nu16 vga_crtc(void)\r\n{\r\nreturn (inb(0x3cc) & 1) ? 0x3d4 : 0x3b4;\r\n}\r\nstatic void vga_set_480_scanlines(void)\r\n{\r\nu16 crtc;\r\nu8 csel;\r\ncrtc = vga_crtc();\r\nout_idx(0x0c, crtc, 0x11);\r\nout_idx(0x0b, crtc, 0x06);\r\nout_idx(0x3e, crtc, 0x07);\r\nout_idx(0xea, crtc, 0x10);\r\nout_idx(0xdf, crtc, 0x12);\r\nout_idx(0xe7, crtc, 0x15);\r\nout_idx(0x04, crtc, 0x16);\r\ncsel = inb(0x3cc);\r\ncsel &= 0x0d;\r\ncsel |= 0xe2;\r\noutb(csel, 0x3c2);\r\n}\r\nstatic void vga_set_vertical_end(int lines)\r\n{\r\nu16 crtc;\r\nu8 ovfw;\r\nint end = lines-1;\r\ncrtc = vga_crtc();\r\novfw = 0x3c | ((end >> (8-1)) & 0x02) | ((end >> (9-6)) & 0x40);\r\nout_idx(ovfw, crtc, 0x07);\r\nout_idx(end, crtc, 0x12);\r\n}\r\nstatic void vga_set_80x30(void)\r\n{\r\nvga_set_480_scanlines();\r\nvga_set_vertical_end(30*16);\r\n}\r\nstatic void vga_set_80x34(void)\r\n{\r\nvga_set_480_scanlines();\r\nvga_set_14font();\r\nvga_set_vertical_end(34*14);\r\n}\r\nstatic void vga_set_80x60(void)\r\n{\r\nvga_set_480_scanlines();\r\nvga_set_8font();\r\nvga_set_vertical_end(60*8);\r\n}\r\nstatic int vga_set_mode(struct mode_info *mode)\r\n{\r\nvga_set_basic_mode();\r\nforce_x = mode->x;\r\nforce_y = mode->y;\r\nswitch (mode->mode) {\r\ncase VIDEO_80x25:\r\nbreak;\r\ncase VIDEO_8POINT:\r\nvga_set_8font();\r\nbreak;\r\ncase VIDEO_80x43:\r\nvga_set_80x43();\r\nbreak;\r\ncase VIDEO_80x28:\r\nvga_set_14font();\r\nbreak;\r\ncase VIDEO_80x30:\r\nvga_set_80x30();\r\nbreak;\r\ncase VIDEO_80x34:\r\nvga_set_80x34();\r\nbreak;\r\ncase VIDEO_80x60:\r\nvga_set_80x60();\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int vga_probe(void)\r\n{\r\nstatic const char *card_name[] = {\r\n"CGA/MDA/HGC", "EGA", "VGA"\r\n};\r\nstatic struct mode_info *mode_lists[] = {\r\ncga_modes,\r\nega_modes,\r\nvga_modes,\r\n};\r\nstatic int mode_count[] = {\r\nsizeof(cga_modes)/sizeof(struct mode_info),\r\nsizeof(ega_modes)/sizeof(struct mode_info),\r\nsizeof(vga_modes)/sizeof(struct mode_info),\r\n};\r\nstruct biosregs ireg, oreg;\r\ninitregs(&ireg);\r\nireg.ax = 0x1200;\r\nireg.bl = 0x10;\r\nintcall(0x10, &ireg, &oreg);\r\n#ifndef _WAKEUP\r\nboot_params.screen_info.orig_video_ega_bx = oreg.bx;\r\n#endif\r\nif (oreg.bl != 0x10) {\r\nireg.ax = 0x1a00;\r\nintcall(0x10, &ireg, &oreg);\r\nif (oreg.al == 0x1a) {\r\nadapter = ADAPTER_VGA;\r\n#ifndef _WAKEUP\r\nboot_params.screen_info.orig_video_isVGA = 1;\r\n#endif\r\n} else {\r\nadapter = ADAPTER_EGA;\r\n}\r\n} else {\r\nadapter = ADAPTER_CGA;\r\n}\r\nvideo_vga.modes = mode_lists[adapter];\r\nvideo_vga.card_name = card_name[adapter];\r\nreturn mode_count[adapter];\r\n}

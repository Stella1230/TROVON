static int gio_open(struct inode *inode, struct file *filp)\r\n{\r\nint minor;\r\nint ret = -ENOENT;\r\npreempt_disable();\r\nminor = MINOR(inode->i_rdev);\r\nif (minor < DEVCOUNT) {\r\nif (openCnt > 0) {\r\nret = -EALREADY;\r\n} else {\r\nopenCnt++;\r\nret = 0;\r\n}\r\n}\r\npreempt_enable();\r\nreturn ret;\r\n}\r\nstatic int gio_close(struct inode *inode, struct file *filp)\r\n{\r\nint minor;\r\nminor = MINOR(inode->i_rdev);\r\nif (minor < DEVCOUNT) {\r\nopenCnt--;\r\n}\r\nreturn 0;\r\n}\r\nstatic long gio_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\r\n{\r\nunsigned int data;\r\nstatic unsigned int addr = 0;\r\nif (cmd & 0x01) {\r\nif (copy_from_user(&data, (int *)arg, sizeof(int))) {\r\nreturn -EFAULT;\r\n}\r\n}\r\nswitch (cmd) {\r\ncase GIODRV_IOCSGIOSETADDR:\r\naddr = data;\r\nbreak;\r\ncase GIODRV_IOCSGIODATA1:\r\n__raw_writeb((unsigned char)(0x0ff & data), addr);\r\nbreak;\r\ncase GIODRV_IOCSGIODATA2:\r\nif (addr & 0x01) {\r\nreturn -EFAULT;\r\n}\r\n__raw_writew((unsigned short int)(0x0ffff & data), addr);\r\nbreak;\r\ncase GIODRV_IOCSGIODATA4:\r\nif (addr & 0x03) {\r\nreturn -EFAULT;\r\n}\r\n__raw_writel(data, addr);\r\nbreak;\r\ncase GIODRV_IOCGGIODATA1:\r\ndata = __raw_readb(addr);\r\nbreak;\r\ncase GIODRV_IOCGGIODATA2:\r\nif (addr & 0x01) {\r\nreturn -EFAULT;\r\n}\r\ndata = __raw_readw(addr);\r\nbreak;\r\ncase GIODRV_IOCGGIODATA4:\r\nif (addr & 0x03) {\r\nreturn -EFAULT;\r\n}\r\ndata = __raw_readl(addr);\r\nbreak;\r\ndefault:\r\nreturn -EFAULT;\r\nbreak;\r\n}\r\nif ((cmd & 0x01) == 0) {\r\nif (copy_to_user((int *)arg, &data, sizeof(int))) {\r\nreturn -EFAULT;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init gio_init(void)\r\n{\r\nint error;\r\nprintk(KERN_INFO "gio: driver initialized\n");\r\nopenCnt = 0;\r\nif ((error = alloc_chrdev_region(&dev, 0, DEVCOUNT, "gio")) < 0) {\r\nprintk(KERN_ERR\r\n"gio: Couldn't alloc_chrdev_region, error=%d\n",\r\nerror);\r\nreturn 1;\r\n}\r\ncdev_p = cdev_alloc();\r\ncdev_p->ops = &gio_fops;\r\nerror = cdev_add(cdev_p, dev, DEVCOUNT);\r\nif (error) {\r\nprintk(KERN_ERR\r\n"gio: Couldn't cdev_add, error=%d\n", error);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit gio_exit(void)\r\n{\r\ncdev_del(cdev_p);\r\nunregister_chrdev_region(dev, DEVCOUNT);\r\n}

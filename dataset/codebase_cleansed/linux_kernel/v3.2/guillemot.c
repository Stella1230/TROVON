static int guillemot_read_packet(struct gameport *gameport, u8 *data)\r\n{\r\nunsigned long flags;\r\nunsigned char u, v;\r\nunsigned int t, s;\r\nint i;\r\nfor (i = 0; i < GUILLEMOT_MAX_LENGTH; i++)\r\ndata[i] = 0;\r\ni = 0;\r\nt = gameport_time(gameport, GUILLEMOT_MAX_START);\r\ns = gameport_time(gameport, GUILLEMOT_MAX_STROBE);\r\nlocal_irq_save(flags);\r\ngameport_trigger(gameport);\r\nv = gameport_read(gameport);\r\nwhile (t > 0 && i < GUILLEMOT_MAX_LENGTH * 8) {\r\nt--;\r\nu = v; v = gameport_read(gameport);\r\nif (v & ~u & 0x10) {\r\ndata[i >> 3] |= ((v >> 5) & 1) << (i & 7);\r\ni++;\r\nt = s;\r\n}\r\n}\r\nlocal_irq_restore(flags);\r\nreturn i;\r\n}\r\nstatic void guillemot_poll(struct gameport *gameport)\r\n{\r\nstruct guillemot *guillemot = gameport_get_drvdata(gameport);\r\nstruct input_dev *dev = guillemot->dev;\r\nu8 data[GUILLEMOT_MAX_LENGTH];\r\nint i;\r\nguillemot->reads++;\r\nif (guillemot_read_packet(guillemot->gameport, data) != GUILLEMOT_MAX_LENGTH * 8 ||\r\ndata[0] != 0x55 || data[16] != 0xaa) {\r\nguillemot->bads++;\r\n} else {\r\nfor (i = 0; i < 6 && guillemot->type->abs[i] >= 0; i++)\r\ninput_report_abs(dev, guillemot->type->abs[i], data[i + 5]);\r\nif (guillemot->type->hat) {\r\ninput_report_abs(dev, ABS_HAT0X, guillemot_hat_to_axis[data[4] >> 4].x);\r\ninput_report_abs(dev, ABS_HAT0Y, guillemot_hat_to_axis[data[4] >> 4].y);\r\n}\r\nfor (i = 0; i < 16 && guillemot->type->btn[i] >= 0; i++)\r\ninput_report_key(dev, guillemot->type->btn[i], (data[2 + (i >> 3)] >> (i & 7)) & 1);\r\n}\r\ninput_sync(dev);\r\n}\r\nstatic int guillemot_open(struct input_dev *dev)\r\n{\r\nstruct guillemot *guillemot = input_get_drvdata(dev);\r\ngameport_start_polling(guillemot->gameport);\r\nreturn 0;\r\n}\r\nstatic void guillemot_close(struct input_dev *dev)\r\n{\r\nstruct guillemot *guillemot = input_get_drvdata(dev);\r\ngameport_stop_polling(guillemot->gameport);\r\n}\r\nstatic int guillemot_connect(struct gameport *gameport, struct gameport_driver *drv)\r\n{\r\nstruct guillemot *guillemot;\r\nstruct input_dev *input_dev;\r\nu8 data[GUILLEMOT_MAX_LENGTH];\r\nint i, t;\r\nint err;\r\nguillemot = kzalloc(sizeof(struct guillemot), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!guillemot || !input_dev) {\r\nerr = -ENOMEM;\r\ngoto fail1;\r\n}\r\nguillemot->gameport = gameport;\r\nguillemot->dev = input_dev;\r\ngameport_set_drvdata(gameport, guillemot);\r\nerr = gameport_open(gameport, drv, GAMEPORT_MODE_RAW);\r\nif (err)\r\ngoto fail1;\r\ni = guillemot_read_packet(gameport, data);\r\nif (i != GUILLEMOT_MAX_LENGTH * 8 || data[0] != 0x55 || data[16] != 0xaa) {\r\nerr = -ENODEV;\r\ngoto fail2;\r\n}\r\nfor (i = 0; guillemot_type[i].name; i++)\r\nif (guillemot_type[i].id == data[11])\r\nbreak;\r\nif (!guillemot_type[i].name) {\r\nprintk(KERN_WARNING "guillemot.c: Unknown joystick on %s. [ %02x%02x:%04x, ver %d.%02d ]\n",\r\ngameport->phys, data[12], data[13], data[11], data[14], data[15]);\r\nerr = -ENODEV;\r\ngoto fail2;\r\n}\r\ngameport_set_poll_handler(gameport, guillemot_poll);\r\ngameport_set_poll_interval(gameport, 20);\r\nsnprintf(guillemot->phys, sizeof(guillemot->phys), "%s/input0", gameport->phys);\r\nguillemot->type = guillemot_type + i;\r\ninput_dev->name = guillemot_type[i].name;\r\ninput_dev->phys = guillemot->phys;\r\ninput_dev->id.bustype = BUS_GAMEPORT;\r\ninput_dev->id.vendor = GAMEPORT_ID_VENDOR_GUILLEMOT;\r\ninput_dev->id.product = guillemot_type[i].id;\r\ninput_dev->id.version = (int)data[14] << 8 | data[15];\r\ninput_dev->dev.parent = &gameport->dev;\r\ninput_set_drvdata(input_dev, guillemot);\r\ninput_dev->open = guillemot_open;\r\ninput_dev->close = guillemot_close;\r\ninput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\r\nfor (i = 0; (t = guillemot->type->abs[i]) >= 0; i++)\r\ninput_set_abs_params(input_dev, t, 0, 255, 0, 0);\r\nif (guillemot->type->hat) {\r\ninput_set_abs_params(input_dev, ABS_HAT0X, -1, 1, 0, 0);\r\ninput_set_abs_params(input_dev, ABS_HAT0Y, -1, 1, 0, 0);\r\n}\r\nfor (i = 0; (t = guillemot->type->btn[i]) >= 0; i++)\r\nset_bit(t, input_dev->keybit);\r\nerr = input_register_device(guillemot->dev);\r\nif (err)\r\ngoto fail2;\r\nreturn 0;\r\nfail2: gameport_close(gameport);\r\nfail1: gameport_set_drvdata(gameport, NULL);\r\ninput_free_device(input_dev);\r\nkfree(guillemot);\r\nreturn err;\r\n}\r\nstatic void guillemot_disconnect(struct gameport *gameport)\r\n{\r\nstruct guillemot *guillemot = gameport_get_drvdata(gameport);\r\nprintk(KERN_INFO "guillemot.c: Failed %d reads out of %d on %s\n", guillemot->reads, guillemot->bads, guillemot->phys);\r\ninput_unregister_device(guillemot->dev);\r\ngameport_close(gameport);\r\nkfree(guillemot);\r\n}\r\nstatic int __init guillemot_init(void)\r\n{\r\nreturn gameport_register_driver(&guillemot_drv);\r\n}\r\nstatic void __exit guillemot_exit(void)\r\n{\r\ngameport_unregister_driver(&guillemot_drv);\r\n}

static int __devinit ali1535_setup(struct pci_dev *dev)\r\n{\r\nint retval = -ENODEV;\r\nunsigned char temp;\r\npci_read_config_word(dev, SMBBA, &ali1535_smba);\r\nali1535_smba &= (0xffff & ~(ALI1535_SMB_IOSIZE - 1));\r\nif (ali1535_smba == 0) {\r\ndev_warn(&dev->dev,\r\n"ALI1535_smb region uninitialized - upgrade BIOS?\n");\r\ngoto exit;\r\n}\r\nretval = acpi_check_region(ali1535_smba, ALI1535_SMB_IOSIZE,\r\nali1535_driver.name);\r\nif (retval)\r\ngoto exit;\r\nif (!request_region(ali1535_smba, ALI1535_SMB_IOSIZE,\r\nali1535_driver.name)) {\r\ndev_err(&dev->dev, "ALI1535_smb region 0x%x already in use!\n",\r\nali1535_smba);\r\ngoto exit;\r\n}\r\npci_read_config_byte(dev, SMBCFG, &temp);\r\nif ((temp & ALI1535_SMBIO_EN) == 0) {\r\ndev_err(&dev->dev, "SMB device not enabled - upgrade BIOS?\n");\r\ngoto exit_free;\r\n}\r\npci_read_config_byte(dev, SMBHSTCFG, &temp);\r\nif ((temp & 1) == 0) {\r\ndev_err(&dev->dev, "SMBus controller not enabled - upgrade BIOS?\n");\r\ngoto exit_free;\r\n}\r\npci_write_config_byte(dev, SMBCLK, 0x20);\r\npci_read_config_byte(dev, SMBREV, &temp);\r\ndev_dbg(&dev->dev, "SMBREV = 0x%X\n", temp);\r\ndev_dbg(&dev->dev, "ALI1535_smba = 0x%X\n", ali1535_smba);\r\nretval = 0;\r\nexit:\r\nreturn retval;\r\nexit_free:\r\nrelease_region(ali1535_smba, ALI1535_SMB_IOSIZE);\r\nreturn retval;\r\n}\r\nstatic int ali1535_transaction(struct i2c_adapter *adap)\r\n{\r\nint temp;\r\nint result = 0;\r\nint timeout = 0;\r\ndev_dbg(&adap->dev, "Transaction (pre): STS=%02x, TYP=%02x, "\r\n"CMD=%02x, ADD=%02x, DAT0=%02x, DAT1=%02x\n",\r\ninb_p(SMBHSTSTS), inb_p(SMBHSTTYP), inb_p(SMBHSTCMD),\r\ninb_p(SMBHSTADD), inb_p(SMBHSTDAT0), inb_p(SMBHSTDAT1));\r\ntemp = inb_p(SMBHSTSTS);\r\nif (temp & ALI1535_STS_BUSY) {\r\ndev_info(&adap->dev,\r\n"Resetting entire SMB Bus to clear busy condition (%02x)\n",\r\ntemp);\r\noutb_p(ALI1535_T_OUT, SMBHSTTYP);\r\ntemp = inb_p(SMBHSTSTS);\r\n}\r\nif (temp & (ALI1535_STS_ERR | ALI1535_STS_BUSY)) {\r\noutb_p(0xFF, SMBHSTSTS);\r\ntemp = inb_p(SMBHSTSTS);\r\nif (temp & (ALI1535_STS_ERR | ALI1535_STS_BUSY)) {\r\ndev_err(&adap->dev,\r\n"SMBus reset failed! (0x%02x) - controller or "\r\n"device on bus is probably hung\n", temp);\r\nreturn -EBUSY;\r\n}\r\n} else {\r\nif (temp & ALI1535_STS_DONE)\r\noutb_p(temp, SMBHSTSTS);\r\n}\r\noutb_p(0xFF, SMBHSTPORT);\r\ntimeout = 0;\r\ndo {\r\nusleep_range(1000, 2000);\r\ntemp = inb_p(SMBHSTSTS);\r\n} while (((temp & ALI1535_STS_BUSY) && !(temp & ALI1535_STS_IDLE))\r\n&& (timeout++ < MAX_TIMEOUT));\r\nif (timeout > MAX_TIMEOUT) {\r\nresult = -ETIMEDOUT;\r\ndev_err(&adap->dev, "SMBus Timeout!\n");\r\n}\r\nif (temp & ALI1535_STS_FAIL) {\r\nresult = -EIO;\r\ndev_dbg(&adap->dev, "Error: Failed bus transaction\n");\r\n}\r\nif (temp & ALI1535_STS_BUSERR) {\r\nresult = -ENXIO;\r\ndev_dbg(&adap->dev,\r\n"Error: no response or bus collision ADD=%02x\n",\r\ninb_p(SMBHSTADD));\r\n}\r\nif (temp & ALI1535_STS_DEV) {\r\nresult = -EIO;\r\ndev_err(&adap->dev, "Error: device error\n");\r\n}\r\nif (!(temp & ALI1535_STS_DONE)) {\r\nresult = -ETIMEDOUT;\r\ndev_err(&adap->dev, "Error: command never completed\n");\r\n}\r\ndev_dbg(&adap->dev, "Transaction (post): STS=%02x, TYP=%02x, "\r\n"CMD=%02x, ADD=%02x, DAT0=%02x, DAT1=%02x\n",\r\ninb_p(SMBHSTSTS), inb_p(SMBHSTTYP), inb_p(SMBHSTCMD),\r\ninb_p(SMBHSTADD), inb_p(SMBHSTDAT0), inb_p(SMBHSTDAT1));\r\nif (!(temp & ALI1535_STS_DONE)) {\r\noutb_p(ALI1535_KILL, SMBHSTTYP);\r\noutb_p(0xFF, SMBHSTSTS);\r\n} else if (temp & ALI1535_STS_ERR) {\r\noutb_p(ALI1535_T_OUT, SMBHSTTYP);\r\noutb_p(0xFF, SMBHSTSTS);\r\n}\r\nreturn result;\r\n}\r\nstatic s32 ali1535_access(struct i2c_adapter *adap, u16 addr,\r\nunsigned short flags, char read_write, u8 command,\r\nint size, union i2c_smbus_data *data)\r\n{\r\nint i, len;\r\nint temp;\r\nint timeout;\r\ns32 result = 0;\r\ntemp = inb_p(SMBHSTSTS);\r\nfor (timeout = 0;\r\n(timeout < MAX_TIMEOUT) && !(temp & ALI1535_STS_IDLE);\r\ntimeout++) {\r\nusleep_range(1000, 2000);\r\ntemp = inb_p(SMBHSTSTS);\r\n}\r\nif (timeout >= MAX_TIMEOUT)\r\ndev_warn(&adap->dev, "Idle wait Timeout! STS=0x%02x\n", temp);\r\noutb_p(0xFF, SMBHSTSTS);\r\nswitch (size) {\r\ncase I2C_SMBUS_QUICK:\r\noutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMBHSTADD);\r\nsize = ALI1535_QUICK;\r\noutb_p(size, SMBHSTTYP);\r\nbreak;\r\ncase I2C_SMBUS_BYTE:\r\noutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMBHSTADD);\r\nsize = ALI1535_BYTE;\r\noutb_p(size, SMBHSTTYP);\r\nif (read_write == I2C_SMBUS_WRITE)\r\noutb_p(command, SMBHSTCMD);\r\nbreak;\r\ncase I2C_SMBUS_BYTE_DATA:\r\noutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMBHSTADD);\r\nsize = ALI1535_BYTE_DATA;\r\noutb_p(size, SMBHSTTYP);\r\noutb_p(command, SMBHSTCMD);\r\nif (read_write == I2C_SMBUS_WRITE)\r\noutb_p(data->byte, SMBHSTDAT0);\r\nbreak;\r\ncase I2C_SMBUS_WORD_DATA:\r\noutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMBHSTADD);\r\nsize = ALI1535_WORD_DATA;\r\noutb_p(size, SMBHSTTYP);\r\noutb_p(command, SMBHSTCMD);\r\nif (read_write == I2C_SMBUS_WRITE) {\r\noutb_p(data->word & 0xff, SMBHSTDAT0);\r\noutb_p((data->word & 0xff00) >> 8, SMBHSTDAT1);\r\n}\r\nbreak;\r\ncase I2C_SMBUS_BLOCK_DATA:\r\noutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMBHSTADD);\r\nsize = ALI1535_BLOCK_DATA;\r\noutb_p(size, SMBHSTTYP);\r\noutb_p(command, SMBHSTCMD);\r\nif (read_write == I2C_SMBUS_WRITE) {\r\nlen = data->block[0];\r\nif (len < 0) {\r\nlen = 0;\r\ndata->block[0] = len;\r\n}\r\nif (len > 32) {\r\nlen = 32;\r\ndata->block[0] = len;\r\n}\r\noutb_p(len, SMBHSTDAT0);\r\noutb_p(inb_p(SMBHSTTYP) | ALI1535_BLOCK_CLR, SMBHSTTYP);\r\nfor (i = 1; i <= len; i++)\r\noutb_p(data->block[i], SMBBLKDAT);\r\n}\r\nbreak;\r\ndefault:\r\ndev_warn(&adap->dev, "Unsupported transaction %d\n", size);\r\nresult = -EOPNOTSUPP;\r\ngoto EXIT;\r\n}\r\nresult = ali1535_transaction(adap);\r\nif (result)\r\ngoto EXIT;\r\nif ((read_write == I2C_SMBUS_WRITE) || (size == ALI1535_QUICK)) {\r\nresult = 0;\r\ngoto EXIT;\r\n}\r\nswitch (size) {\r\ncase ALI1535_BYTE:\r\ndata->byte = inb_p(SMBHSTDAT0);\r\nbreak;\r\ncase ALI1535_BYTE_DATA:\r\ndata->byte = inb_p(SMBHSTDAT0);\r\nbreak;\r\ncase ALI1535_WORD_DATA:\r\ndata->word = inb_p(SMBHSTDAT0) + (inb_p(SMBHSTDAT1) << 8);\r\nbreak;\r\ncase ALI1535_BLOCK_DATA:\r\nlen = inb_p(SMBHSTDAT0);\r\nif (len > 32)\r\nlen = 32;\r\ndata->block[0] = len;\r\noutb_p(inb_p(SMBHSTTYP) | ALI1535_BLOCK_CLR, SMBHSTTYP);\r\nfor (i = 1; i <= data->block[0]; i++) {\r\ndata->block[i] = inb_p(SMBBLKDAT);\r\ndev_dbg(&adap->dev, "Blk: len=%d, i=%d, data=%02x\n",\r\nlen, i, data->block[i]);\r\n}\r\nbreak;\r\n}\r\nEXIT:\r\nreturn result;\r\n}\r\nstatic u32 ali1535_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_SMBUS_QUICK | I2C_FUNC_SMBUS_BYTE |\r\nI2C_FUNC_SMBUS_BYTE_DATA | I2C_FUNC_SMBUS_WORD_DATA |\r\nI2C_FUNC_SMBUS_BLOCK_DATA;\r\n}\r\nstatic int __devinit ali1535_probe(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nif (ali1535_setup(dev)) {\r\ndev_warn(&dev->dev,\r\n"ALI1535 not detected, module not inserted.\n");\r\nreturn -ENODEV;\r\n}\r\nali1535_adapter.dev.parent = &dev->dev;\r\nsnprintf(ali1535_adapter.name, sizeof(ali1535_adapter.name),\r\n"SMBus ALI1535 adapter at %04x", ali1535_smba);\r\nreturn i2c_add_adapter(&ali1535_adapter);\r\n}\r\nstatic void __devexit ali1535_remove(struct pci_dev *dev)\r\n{\r\ni2c_del_adapter(&ali1535_adapter);\r\nrelease_region(ali1535_smba, ALI1535_SMB_IOSIZE);\r\n}\r\nstatic int __init i2c_ali1535_init(void)\r\n{\r\nreturn pci_register_driver(&ali1535_driver);\r\n}\r\nstatic void __exit i2c_ali1535_exit(void)\r\n{\r\npci_unregister_driver(&ali1535_driver);\r\n}

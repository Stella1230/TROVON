void FPU_pop(void)\r\n{\r\nfpu_tag_word |= 3 << ((top & 7) * 2);\r\ntop++;\r\n}\r\nint FPU_gettag0(void)\r\n{\r\nreturn (fpu_tag_word >> ((top & 7) * 2)) & 3;\r\n}\r\nint FPU_gettagi(int stnr)\r\n{\r\nreturn (fpu_tag_word >> (((top + stnr) & 7) * 2)) & 3;\r\n}\r\nint FPU_gettag(int regnr)\r\n{\r\nreturn (fpu_tag_word >> ((regnr & 7) * 2)) & 3;\r\n}\r\nvoid FPU_settag0(int tag)\r\n{\r\nint regnr = top;\r\nregnr &= 7;\r\nfpu_tag_word &= ~(3 << (regnr * 2));\r\nfpu_tag_word |= (tag & 3) << (regnr * 2);\r\n}\r\nvoid FPU_settagi(int stnr, int tag)\r\n{\r\nint regnr = stnr + top;\r\nregnr &= 7;\r\nfpu_tag_word &= ~(3 << (regnr * 2));\r\nfpu_tag_word |= (tag & 3) << (regnr * 2);\r\n}\r\nvoid FPU_settag(int regnr, int tag)\r\n{\r\nregnr &= 7;\r\nfpu_tag_word &= ~(3 << (regnr * 2));\r\nfpu_tag_word |= (tag & 3) << (regnr * 2);\r\n}\r\nint FPU_Special(FPU_REG const *ptr)\r\n{\r\nint exp = exponent(ptr);\r\nif (exp == EXP_BIAS + EXP_UNDER)\r\nreturn TW_Denormal;\r\nelse if (exp != EXP_BIAS + EXP_OVER)\r\nreturn TW_NaN;\r\nelse if ((ptr->sigh == 0x80000000) && (ptr->sigl == 0))\r\nreturn TW_Infinity;\r\nreturn TW_NaN;\r\n}\r\nint isNaN(FPU_REG const *ptr)\r\n{\r\nreturn ((exponent(ptr) == EXP_BIAS + EXP_OVER)\r\n&& !((ptr->sigh == 0x80000000) && (ptr->sigl == 0)));\r\n}\r\nint FPU_empty_i(int stnr)\r\n{\r\nint regnr = (top + stnr) & 7;\r\nreturn ((fpu_tag_word >> (regnr * 2)) & 3) == TAG_Empty;\r\n}\r\nint FPU_stackoverflow(FPU_REG ** st_new_ptr)\r\n{\r\n*st_new_ptr = &st(-1);\r\nreturn ((fpu_tag_word >> (((top - 1) & 7) * 2)) & 3) != TAG_Empty;\r\n}\r\nvoid FPU_copy_to_regi(FPU_REG const *r, u_char tag, int stnr)\r\n{\r\nreg_copy(r, &st(stnr));\r\nFPU_settagi(stnr, tag);\r\n}\r\nvoid FPU_copy_to_reg1(FPU_REG const *r, u_char tag)\r\n{\r\nreg_copy(r, &st(1));\r\nFPU_settagi(1, tag);\r\n}\r\nvoid FPU_copy_to_reg0(FPU_REG const *r, u_char tag)\r\n{\r\nint regnr = top;\r\nregnr &= 7;\r\nreg_copy(r, &st(0));\r\nfpu_tag_word &= ~(3 << (regnr * 2));\r\nfpu_tag_word |= (tag & 3) << (regnr * 2);\r\n}

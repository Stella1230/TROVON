static void icu_mask_irq(struct irq_data *d)\r\n{\r\nuint32_t r = __raw_readl(ICU_INT_CONF(d->irq));\r\nr &= ~ICU_INT_ROUTE_PJ4_IRQ;\r\n__raw_writel(r, ICU_INT_CONF(d->irq));\r\n}\r\nstatic void icu_unmask_irq(struct irq_data *d)\r\n{\r\nuint32_t r = __raw_readl(ICU_INT_CONF(d->irq));\r\nr |= ICU_INT_ROUTE_PJ4_IRQ;\r\n__raw_writel(r, ICU_INT_CONF(d->irq));\r\n}\r\nstatic void pmic_irq_ack(struct irq_data *d)\r\n{\r\nif (d->irq == IRQ_MMP2_PMIC)\r\nmmp2_clear_pmic_int();\r\n}\r\nstatic void init_mux_irq(struct irq_chip *chip, int start, int num)\r\n{\r\nint irq;\r\nfor (irq = start; num > 0; irq++, num--) {\r\nstruct irq_data *d = irq_get_irq_data(irq);\r\nchip->irq_mask(d);\r\nif (chip->irq_ack)\r\nchip->irq_ack(d);\r\nirq_set_chip(irq, chip);\r\nset_irq_flags(irq, IRQF_VALID);\r\nirq_set_handler(irq, handle_level_irq);\r\n}\r\n}\r\nvoid __init mmp2_init_icu(void)\r\n{\r\nint irq;\r\nfor (irq = 0; irq < IRQ_MMP2_MUX_BASE; irq++) {\r\nicu_mask_irq(irq_get_irq_data(irq));\r\nirq_set_chip(irq, &icu_irq_chip);\r\nset_irq_flags(irq, IRQF_VALID);\r\nswitch (irq) {\r\ncase IRQ_MMP2_PMIC_MUX:\r\ncase IRQ_MMP2_RTC_MUX:\r\ncase IRQ_MMP2_TWSI_MUX:\r\ncase IRQ_MMP2_MISC_MUX:\r\ncase IRQ_MMP2_SSP_MUX:\r\nbreak;\r\ndefault:\r\nirq_set_handler(irq, handle_level_irq);\r\nbreak;\r\n}\r\n}\r\npmic_irq_chip.irq_ack = pmic_irq_ack;\r\ninit_mux_irq(&pmic_irq_chip, IRQ_MMP2_PMIC_BASE, 2);\r\ninit_mux_irq(&rtc_irq_chip, IRQ_MMP2_RTC_BASE, 2);\r\ninit_mux_irq(&twsi_irq_chip, IRQ_MMP2_TWSI_BASE, 5);\r\ninit_mux_irq(&misc_irq_chip, IRQ_MMP2_MISC_BASE, 15);\r\ninit_mux_irq(&ssp_irq_chip, IRQ_MMP2_SSP_BASE, 2);\r\nirq_set_chained_handler(IRQ_MMP2_PMIC_MUX, pmic_irq_demux);\r\nirq_set_chained_handler(IRQ_MMP2_RTC_MUX, rtc_irq_demux);\r\nirq_set_chained_handler(IRQ_MMP2_TWSI_MUX, twsi_irq_demux);\r\nirq_set_chained_handler(IRQ_MMP2_MISC_MUX, misc_irq_demux);\r\nirq_set_chained_handler(IRQ_MMP2_SSP_MUX, ssp_irq_demux);\r\n}

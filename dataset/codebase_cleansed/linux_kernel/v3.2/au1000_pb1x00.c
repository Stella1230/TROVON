static int pb1x00_pcmcia_init(struct pcmcia_init *init)\r\n{\r\nu16 pcr;\r\npcr = PCR_SLOT_0_RST | PCR_SLOT_1_RST;\r\nau_writel(0x8000, PB1000_MDR);\r\nau_sync_delay(100);\r\nau_writel(0x4000, PB1000_MDR);\r\nau_sync();\r\npcr |= SET_VCC_VPP(VCC_HIZ,VPP_HIZ,0);\r\npcr |= SET_VCC_VPP(VCC_HIZ,VPP_HIZ,1);\r\nau_writel(pcr, PB1000_PCR);\r\nau_sync_delay(20);\r\nreturn PCMCIA_NUM_SOCKS;\r\n}\r\nstatic int pb1x00_pcmcia_shutdown(void)\r\n{\r\nu16 pcr;\r\npcr = PCR_SLOT_0_RST | PCR_SLOT_1_RST;\r\npcr |= SET_VCC_VPP(VCC_HIZ,VPP_HIZ,0);\r\npcr |= SET_VCC_VPP(VCC_HIZ,VPP_HIZ,1);\r\nau_writel(pcr, PB1000_PCR);\r\nau_sync_delay(20);\r\nreturn 0;\r\n}\r\nstatic int\r\npb1x00_pcmcia_socket_state(unsigned sock, struct pcmcia_state *state)\r\n{\r\nu32 inserted0, inserted1;\r\nu16 vs0, vs1;\r\nvs0 = vs1 = (u16)au_readl(PB1000_ACR1);\r\ninserted0 = !(vs0 & (ACR1_SLOT_0_CD1 | ACR1_SLOT_0_CD2));\r\ninserted1 = !(vs1 & (ACR1_SLOT_1_CD1 | ACR1_SLOT_1_CD2));\r\nvs0 = (vs0 >> 4) & 0x3;\r\nvs1 = (vs1 >> 12) & 0x3;\r\nstate->ready = 0;\r\nstate->vs_Xv = 0;\r\nstate->vs_3v = 0;\r\nstate->detect = 0;\r\nif (sock == 0) {\r\nif (inserted0) {\r\nswitch (vs0) {\r\ncase 0:\r\ncase 2:\r\nstate->vs_3v=1;\r\nbreak;\r\ncase 3:\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "pb1x00 bad VS (%d)\n",\r\nvs0);\r\nreturn 0;\r\n}\r\nstate->detect = 1;\r\n}\r\n}\r\nelse {\r\nif (inserted1) {\r\nswitch (vs1) {\r\ncase 0:\r\ncase 2:\r\nstate->vs_3v=1;\r\nbreak;\r\ncase 3:\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "pb1x00 bad VS (%d)\n",\r\nvs1);\r\nreturn 0;\r\n}\r\nstate->detect = 1;\r\n}\r\n}\r\nif (state->detect) {\r\nstate->ready = 1;\r\n}\r\nstate->bvd1=1;\r\nstate->bvd2=1;\r\nstate->wrprot=0;\r\nreturn 1;\r\n}\r\nstatic int pb1x00_pcmcia_get_irq_info(struct pcmcia_irq_info *info)\r\n{\r\nif(info->sock > PCMCIA_MAX_SOCK) return -1;\r\ninfo->irq = PCMCIA_IRQ;\r\nreturn 0;\r\n}\r\nstatic int\r\npb1x00_pcmcia_configure_socket(const struct pcmcia_configure *configure)\r\n{\r\nu16 pcr;\r\nif(configure->sock > PCMCIA_MAX_SOCK) return -1;\r\npcr = au_readl(PB1000_PCR);\r\nif (configure->sock == 0) {\r\npcr &= ~(PCR_SLOT_0_VCC0 | PCR_SLOT_0_VCC1 |\r\nPCR_SLOT_0_VPP0 | PCR_SLOT_0_VPP1);\r\n}\r\nelse {\r\npcr &= ~(PCR_SLOT_1_VCC0 | PCR_SLOT_1_VCC1 |\r\nPCR_SLOT_1_VPP0 | PCR_SLOT_1_VPP1);\r\n}\r\npcr &= ~PCR_SLOT_0_RST;\r\ndebug("Vcc %dV Vpp %dV, pcr %x\n",\r\nconfigure->vcc, configure->vpp, pcr);\r\nswitch(configure->vcc){\r\ncase 0:\r\nswitch(configure->vpp) {\r\ncase 0:\r\npcr |= SET_VCC_VPP(VCC_HIZ,VPP_GND,\r\nconfigure->sock);\r\nbreak;\r\ncase 12:\r\npcr |= SET_VCC_VPP(VCC_HIZ,VPP_12V,\r\nconfigure->sock);\r\nbreak;\r\ncase 50:\r\npcr |= SET_VCC_VPP(VCC_HIZ,VPP_5V,\r\nconfigure->sock);\r\nbreak;\r\ncase 33:\r\npcr |= SET_VCC_VPP(VCC_HIZ,VPP_3V,\r\nconfigure->sock);\r\nbreak;\r\ndefault:\r\npcr |= SET_VCC_VPP(VCC_HIZ,VPP_HIZ,\r\nconfigure->sock);\r\nprintk("%s: bad Vcc/Vpp (%d:%d)\n",\r\n__func__,\r\nconfigure->vcc,\r\nconfigure->vpp);\r\nbreak;\r\n}\r\nbreak;\r\ncase 50:\r\nswitch(configure->vpp) {\r\ncase 0:\r\npcr |= SET_VCC_VPP(VCC_5V,VPP_GND,\r\nconfigure->sock);\r\nbreak;\r\ncase 50:\r\npcr |= SET_VCC_VPP(VCC_5V,VPP_5V,\r\nconfigure->sock);\r\nbreak;\r\ncase 12:\r\npcr |= SET_VCC_VPP(VCC_5V,VPP_12V,\r\nconfigure->sock);\r\nbreak;\r\ncase 33:\r\npcr |= SET_VCC_VPP(VCC_5V,VPP_3V,\r\nconfigure->sock);\r\nbreak;\r\ndefault:\r\npcr |= SET_VCC_VPP(VCC_HIZ,VPP_HIZ,\r\nconfigure->sock);\r\nprintk("%s: bad Vcc/Vpp (%d:%d)\n",\r\n__func__,\r\nconfigure->vcc,\r\nconfigure->vpp);\r\nbreak;\r\n}\r\nbreak;\r\ncase 33:\r\nswitch(configure->vpp) {\r\ncase 0:\r\npcr |= SET_VCC_VPP(VCC_3V,VPP_GND,\r\nconfigure->sock);\r\nbreak;\r\ncase 50:\r\npcr |= SET_VCC_VPP(VCC_3V,VPP_5V,\r\nconfigure->sock);\r\nbreak;\r\ncase 12:\r\npcr |= SET_VCC_VPP(VCC_3V,VPP_12V,\r\nconfigure->sock);\r\nbreak;\r\ncase 33:\r\npcr |= SET_VCC_VPP(VCC_3V,VPP_3V,\r\nconfigure->sock);\r\nbreak;\r\ndefault:\r\npcr |= SET_VCC_VPP(VCC_HIZ,VPP_HIZ,\r\nconfigure->sock);\r\nprintk("%s: bad Vcc/Vpp (%d:%d)\n",\r\n__func__,\r\nconfigure->vcc,\r\nconfigure->vpp);\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\npcr |= SET_VCC_VPP(VCC_HIZ,VPP_HIZ,configure->sock);\r\nprintk(KERN_ERR "%s: bad Vcc %d\n",\r\n__func__, configure->vcc);\r\nbreak;\r\n}\r\nif (configure->sock == 0) {\r\npcr &= ~(PCR_SLOT_0_RST);\r\nif (configure->reset)\r\npcr |= PCR_SLOT_0_RST;\r\n}\r\nelse {\r\npcr &= ~(PCR_SLOT_1_RST);\r\nif (configure->reset)\r\npcr |= PCR_SLOT_1_RST;\r\n}\r\nau_writel(pcr, PB1000_PCR);\r\nau_sync_delay(300);\r\nreturn 0;\r\n}

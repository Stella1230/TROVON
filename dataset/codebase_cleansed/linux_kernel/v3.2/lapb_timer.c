void lapb_start_t1timer(struct lapb_cb *lapb)\r\n{\r\ndel_timer(&lapb->t1timer);\r\nlapb->t1timer.data = (unsigned long)lapb;\r\nlapb->t1timer.function = &lapb_t1timer_expiry;\r\nlapb->t1timer.expires = jiffies + lapb->t1;\r\nadd_timer(&lapb->t1timer);\r\n}\r\nvoid lapb_start_t2timer(struct lapb_cb *lapb)\r\n{\r\ndel_timer(&lapb->t2timer);\r\nlapb->t2timer.data = (unsigned long)lapb;\r\nlapb->t2timer.function = &lapb_t2timer_expiry;\r\nlapb->t2timer.expires = jiffies + lapb->t2;\r\nadd_timer(&lapb->t2timer);\r\n}\r\nvoid lapb_stop_t1timer(struct lapb_cb *lapb)\r\n{\r\ndel_timer(&lapb->t1timer);\r\n}\r\nvoid lapb_stop_t2timer(struct lapb_cb *lapb)\r\n{\r\ndel_timer(&lapb->t2timer);\r\n}\r\nint lapb_t1timer_running(struct lapb_cb *lapb)\r\n{\r\nreturn timer_pending(&lapb->t1timer);\r\n}\r\nstatic void lapb_t2timer_expiry(unsigned long param)\r\n{\r\nstruct lapb_cb *lapb = (struct lapb_cb *)param;\r\nif (lapb->condition & LAPB_ACK_PENDING_CONDITION) {\r\nlapb->condition &= ~LAPB_ACK_PENDING_CONDITION;\r\nlapb_timeout_response(lapb);\r\n}\r\n}\r\nstatic void lapb_t1timer_expiry(unsigned long param)\r\n{\r\nstruct lapb_cb *lapb = (struct lapb_cb *)param;\r\nswitch (lapb->state) {\r\ncase LAPB_STATE_0:\r\nif (lapb->mode & LAPB_DCE)\r\nlapb_send_control(lapb, LAPB_DM, LAPB_POLLOFF, LAPB_RESPONSE);\r\nbreak;\r\ncase LAPB_STATE_1:\r\nif (lapb->n2count == lapb->n2) {\r\nlapb_clear_queues(lapb);\r\nlapb->state = LAPB_STATE_0;\r\nlapb_disconnect_indication(lapb, LAPB_TIMEDOUT);\r\n#if LAPB_DEBUG > 0\r\nprintk(KERN_DEBUG "lapb: (%p) S1 -> S0\n", lapb->dev);\r\n#endif\r\nreturn;\r\n} else {\r\nlapb->n2count++;\r\nif (lapb->mode & LAPB_EXTENDED) {\r\n#if LAPB_DEBUG > 1\r\nprintk(KERN_DEBUG "lapb: (%p) S1 TX SABME(1)\n", lapb->dev);\r\n#endif\r\nlapb_send_control(lapb, LAPB_SABME, LAPB_POLLON, LAPB_COMMAND);\r\n} else {\r\n#if LAPB_DEBUG > 1\r\nprintk(KERN_DEBUG "lapb: (%p) S1 TX SABM(1)\n", lapb->dev);\r\n#endif\r\nlapb_send_control(lapb, LAPB_SABM, LAPB_POLLON, LAPB_COMMAND);\r\n}\r\n}\r\nbreak;\r\ncase LAPB_STATE_2:\r\nif (lapb->n2count == lapb->n2) {\r\nlapb_clear_queues(lapb);\r\nlapb->state = LAPB_STATE_0;\r\nlapb_disconnect_confirmation(lapb, LAPB_TIMEDOUT);\r\n#if LAPB_DEBUG > 0\r\nprintk(KERN_DEBUG "lapb: (%p) S2 -> S0\n", lapb->dev);\r\n#endif\r\nreturn;\r\n} else {\r\nlapb->n2count++;\r\n#if LAPB_DEBUG > 1\r\nprintk(KERN_DEBUG "lapb: (%p) S2 TX DISC(1)\n", lapb->dev);\r\n#endif\r\nlapb_send_control(lapb, LAPB_DISC, LAPB_POLLON, LAPB_COMMAND);\r\n}\r\nbreak;\r\ncase LAPB_STATE_3:\r\nif (lapb->n2count == lapb->n2) {\r\nlapb_clear_queues(lapb);\r\nlapb->state = LAPB_STATE_0;\r\nlapb_stop_t2timer(lapb);\r\nlapb_disconnect_indication(lapb, LAPB_TIMEDOUT);\r\n#if LAPB_DEBUG > 0\r\nprintk(KERN_DEBUG "lapb: (%p) S3 -> S0\n", lapb->dev);\r\n#endif\r\nreturn;\r\n} else {\r\nlapb->n2count++;\r\nlapb_requeue_frames(lapb);\r\n}\r\nbreak;\r\ncase LAPB_STATE_4:\r\nif (lapb->n2count == lapb->n2) {\r\nlapb_clear_queues(lapb);\r\nlapb->state = LAPB_STATE_0;\r\nlapb_disconnect_indication(lapb, LAPB_TIMEDOUT);\r\n#if LAPB_DEBUG > 0\r\nprintk(KERN_DEBUG "lapb: (%p) S4 -> S0\n", lapb->dev);\r\n#endif\r\nreturn;\r\n} else {\r\nlapb->n2count++;\r\nlapb_transmit_frmr(lapb);\r\n}\r\nbreak;\r\n}\r\nlapb_start_t1timer(lapb);\r\n}

static int __devinit netmos_parallel_init(struct pci_dev *dev, struct parport_pc_pci *par, int autoirq, int autodma)\r\n{\r\nif (dev->device == PCI_DEVICE_ID_NETMOS_9835 &&\r\ndev->subsystem_vendor == PCI_VENDOR_ID_IBM &&\r\ndev->subsystem_device == 0x0299)\r\nreturn -ENODEV;\r\nif (dev->device == PCI_DEVICE_ID_NETMOS_9912) {\r\npar->numports = 1;\r\n} else {\r\npar->numports = (dev->subsystem_device & 0xf0) >> 4;\r\nif (par->numports > ARRAY_SIZE(par->addr))\r\npar->numports = ARRAY_SIZE(par->addr);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit serial_register (struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nstruct parport_serial_private *priv = pci_get_drvdata (dev);\r\nstruct pciserial_board *board;\r\nstruct serial_private *serial;\r\nboard = &pci_parport_serial_boards[id->driver_data];\r\nif (board->num_ports == 0)\r\nreturn 0;\r\nserial = pciserial_init_ports(dev, board);\r\nif (IS_ERR(serial))\r\nreturn PTR_ERR(serial);\r\npriv->serial = serial;\r\nreturn 0;\r\n}\r\nstatic int __devinit parport_register (struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nstruct parport_pc_pci *card;\r\nstruct parport_serial_private *priv = pci_get_drvdata (dev);\r\nint n, success = 0;\r\npriv->par = cards[id->driver_data];\r\ncard = &priv->par;\r\nif (card->preinit_hook &&\r\ncard->preinit_hook (dev, card, PARPORT_IRQ_NONE, PARPORT_DMA_NONE))\r\nreturn -ENODEV;\r\nfor (n = 0; n < card->numports; n++) {\r\nstruct parport *port;\r\nint lo = card->addr[n].lo;\r\nint hi = card->addr[n].hi;\r\nunsigned long io_lo, io_hi;\r\nint irq;\r\nif (priv->num_par == ARRAY_SIZE (priv->port)) {\r\nprintk (KERN_WARNING\r\n"parport_serial: %s: only %zu parallel ports "\r\n"supported (%d reported)\n", pci_name (dev),\r\nARRAY_SIZE(priv->port), card->numports);\r\nbreak;\r\n}\r\nio_lo = pci_resource_start (dev, lo);\r\nio_hi = 0;\r\nif ((hi >= 0) && (hi <= 6))\r\nio_hi = pci_resource_start (dev, hi);\r\nelse if (hi > 6)\r\nio_lo += hi;\r\nirq = dev->irq;\r\nif (irq == IRQ_NONE) {\r\ndev_dbg(&dev->dev,\r\n"PCI parallel port detected: I/O at %#lx(%#lx)\n",\r\nio_lo, io_hi);\r\nirq = PARPORT_IRQ_NONE;\r\n} else {\r\ndev_dbg(&dev->dev,\r\n"PCI parallel port detected: I/O at %#lx(%#lx), IRQ %d\n",\r\nio_lo, io_hi, irq);\r\n}\r\nport = parport_pc_probe_port (io_lo, io_hi, irq,\r\nPARPORT_DMA_NONE, &dev->dev, IRQF_SHARED);\r\nif (port) {\r\npriv->port[priv->num_par++] = port;\r\nsuccess = 1;\r\n}\r\n}\r\nif (card->postinit_hook)\r\ncard->postinit_hook (dev, card, !success);\r\nreturn 0;\r\n}\r\nstatic int __devinit parport_serial_pci_probe (struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nstruct parport_serial_private *priv;\r\nint err;\r\npriv = kzalloc (sizeof *priv, GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npci_set_drvdata (dev, priv);\r\nerr = pci_enable_device (dev);\r\nif (err) {\r\npci_set_drvdata (dev, NULL);\r\nkfree (priv);\r\nreturn err;\r\n}\r\nif (parport_register (dev, id)) {\r\npci_set_drvdata (dev, NULL);\r\nkfree (priv);\r\nreturn -ENODEV;\r\n}\r\nif (serial_register (dev, id)) {\r\nint i;\r\nfor (i = 0; i < priv->num_par; i++)\r\nparport_pc_unregister_port (priv->port[i]);\r\npci_set_drvdata (dev, NULL);\r\nkfree (priv);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __devexit parport_serial_pci_remove (struct pci_dev *dev)\r\n{\r\nstruct parport_serial_private *priv = pci_get_drvdata (dev);\r\nint i;\r\npci_set_drvdata(dev, NULL);\r\nif (priv->serial)\r\npciserial_remove_ports(priv->serial);\r\nfor (i = 0; i < priv->num_par; i++)\r\nparport_pc_unregister_port (priv->port[i]);\r\nkfree (priv);\r\nreturn;\r\n}\r\nstatic int parport_serial_pci_suspend(struct pci_dev *dev, pm_message_t state)\r\n{\r\nstruct parport_serial_private *priv = pci_get_drvdata(dev);\r\nif (priv->serial)\r\npciserial_suspend_ports(priv->serial);\r\npci_save_state(dev);\r\npci_set_power_state(dev, pci_choose_state(dev, state));\r\nreturn 0;\r\n}\r\nstatic int parport_serial_pci_resume(struct pci_dev *dev)\r\n{\r\nstruct parport_serial_private *priv = pci_get_drvdata(dev);\r\nint err;\r\npci_set_power_state(dev, PCI_D0);\r\npci_restore_state(dev);\r\nerr = pci_enable_device(dev);\r\nif (err) {\r\nprintk(KERN_ERR "parport_serial: %s: error enabling "\r\n"device for resume (%d)\n", pci_name(dev), err);\r\nreturn err;\r\n}\r\nif (priv->serial)\r\npciserial_resume_ports(priv->serial);\r\nreturn 0;\r\n}\r\nstatic int __init parport_serial_init (void)\r\n{\r\nreturn pci_register_driver (&parport_serial_pci_driver);\r\n}\r\nstatic void __exit parport_serial_exit (void)\r\n{\r\npci_unregister_driver (&parport_serial_pci_driver);\r\nreturn;\r\n}

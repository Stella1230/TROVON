unsigned long ioc_timer_gettimeoffset(void)\r\n{\r\nunsigned int count1, count2, status;\r\nlong offset;\r\nioc_writeb (0, IOC_T0LATCH);\r\nbarrier ();\r\ncount1 = ioc_readb(IOC_T0CNTL) | (ioc_readb(IOC_T0CNTH) << 8);\r\nbarrier ();\r\nstatus = ioc_readb(IOC_IRQREQA);\r\nbarrier ();\r\nioc_writeb (0, IOC_T0LATCH);\r\nbarrier ();\r\ncount2 = ioc_readb(IOC_T0CNTL) | (ioc_readb(IOC_T0CNTH) << 8);\r\noffset = count2;\r\nif (count2 < count1) {\r\nif (status & (1 << 5))\r\noffset -= LATCH;\r\n} else if (count2 > count1) {\r\noffset -= LATCH;\r\n}\r\noffset = (LATCH - offset) * (tick_nsec / 1000);\r\nreturn (offset + LATCH/2) / LATCH;\r\n}\r\nvoid __init ioctime_init(void)\r\n{\r\nioc_writeb(LATCH & 255, IOC_T0LTCHL);\r\nioc_writeb(LATCH >> 8, IOC_T0LTCHH);\r\nioc_writeb(0, IOC_T0GO);\r\n}\r\nstatic irqreturn_t\r\nioc_timer_interrupt(int irq, void *dev_id)\r\n{\r\ntimer_tick();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __init ioc_timer_init(void)\r\n{\r\nioctime_init();\r\nsetup_irq(IRQ_TIMER, &ioc_timer_irq);\r\n}

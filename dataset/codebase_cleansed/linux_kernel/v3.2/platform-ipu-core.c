struct platform_device *__init imx_add_ipu_core(\r\nconst struct imx_ipu_core_data *data,\r\nconst struct ipu_platform_data *pdata)\r\n{\r\nstruct resource res[] = {\r\n{\r\n.start = data->iobase,\r\n.end = data->iobase + 0x5f,\r\n.flags = IORESOURCE_MEM,\r\n}, {\r\n.start = data->iobase + 0x88,\r\n.end = data->iobase + 0xb3,\r\n.flags = IORESOURCE_MEM,\r\n}, {\r\n.start = data->synirq,\r\n.end = data->synirq,\r\n.flags = IORESOURCE_IRQ,\r\n}, {\r\n.start = data->errirq,\r\n.end = data->errirq,\r\n.flags = IORESOURCE_IRQ,\r\n},\r\n};\r\nreturn imx_ipu_coredev = imx_add_platform_device("ipu-core", -1,\r\nres, ARRAY_SIZE(res), pdata, sizeof(*pdata));\r\n}\r\nstruct platform_device *__init imx_alloc_mx3_camera(\r\nconst struct imx_ipu_core_data *data,\r\nconst struct mx3_camera_pdata *pdata)\r\n{\r\nstruct resource res[] = {\r\n{\r\n.start = data->iobase + 0x60,\r\n.end = data->iobase + 0x87,\r\n.flags = IORESOURCE_MEM,\r\n},\r\n};\r\nint ret = -ENOMEM;\r\nstruct platform_device *pdev;\r\nif (IS_ERR_OR_NULL(imx_ipu_coredev))\r\nreturn ERR_PTR(-ENODEV);\r\npdev = platform_device_alloc("mx3-camera", 0);\r\nif (!pdev)\r\ngoto err;\r\npdev->dev.dma_mask = kmalloc(sizeof(*pdev->dev.dma_mask), GFP_KERNEL);\r\nif (!pdev->dev.dma_mask)\r\ngoto err;\r\n*pdev->dev.dma_mask = DMA_BIT_MASK(32);\r\npdev->dev.coherent_dma_mask = DMA_BIT_MASK(32);\r\nret = platform_device_add_resources(pdev, res, ARRAY_SIZE(res));\r\nif (ret)\r\ngoto err;\r\nif (pdata) {\r\nstruct mx3_camera_pdata *copied_pdata;\r\nret = platform_device_add_data(pdev, pdata, sizeof(*pdata));\r\nif (ret) {\r\nerr:\r\nkfree(pdev->dev.dma_mask);\r\nplatform_device_put(pdev);\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\ncopied_pdata = dev_get_platdata(&pdev->dev);\r\ncopied_pdata->dma_dev = &imx_ipu_coredev->dev;\r\n}\r\nreturn pdev;\r\n}\r\nstruct platform_device *__init imx_add_mx3_sdc_fb(\r\nconst struct imx_ipu_core_data *data,\r\nstruct mx3fb_platform_data *pdata)\r\n{\r\nstruct resource res[] = {\r\n{\r\n.start = data->iobase + 0xb4,\r\n.end = data->iobase + 0x1bf,\r\n.flags = IORESOURCE_MEM,\r\n},\r\n};\r\nif (IS_ERR_OR_NULL(imx_ipu_coredev))\r\nreturn ERR_PTR(-ENODEV);\r\npdata->dma_dev = &imx_ipu_coredev->dev;\r\nreturn imx_add_platform_device_dmamask("mx3_sdc_fb", -1,\r\nres, ARRAY_SIZE(res), pdata, sizeof(*pdata),\r\nDMA_BIT_MASK(32));\r\n}

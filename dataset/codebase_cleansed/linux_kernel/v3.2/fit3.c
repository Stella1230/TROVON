static void fit3_write_regr( PIA *pi, int cont, int regr, int val)\r\n{ if (cont == 1) return;\r\nswitch (pi->mode) {\r\ncase 0:\r\ncase 1: w2(0xc); w0(regr); w2(0x8); w2(0xc);\r\nw0(val); w2(0xd);\r\nw0(0); w2(0xc);\r\nbreak;\r\ncase 2: w2(0xc); w0(regr); w2(0x8); w2(0xc);\r\nw4(val); w4(0);\r\nw2(0xc);\r\nbreak;\r\n}\r\n}\r\nstatic int fit3_read_regr( PIA *pi, int cont, int regr )\r\n{ int a, b;\r\nif (cont) {\r\nif (regr != 6) return 0xff;\r\nregr = 7;\r\n}\r\nswitch (pi->mode) {\r\ncase 0: w2(0xc); w0(regr + 0x10); w2(0x8); w2(0xc);\r\nw2(0xd); a = r1();\r\nw2(0xf); b = r1();\r\nw2(0xc);\r\nreturn j44(a,b);\r\ncase 1: w2(0xc); w0(regr + 0x90); w2(0x8); w2(0xc);\r\nw2(0xec); w2(0xee); w2(0xef); a = r0();\r\nw2(0xc);\r\nreturn a;\r\ncase 2: w2(0xc); w0(regr + 0x90); w2(0x8); w2(0xc);\r\nw2(0xec);\r\na = r4(); b = r4();\r\nw2(0xc);\r\nreturn a;\r\n}\r\nreturn -1;\r\n}\r\nstatic void fit3_read_block( PIA *pi, char * buf, int count )\r\n{ int k, a, b, c, d;\r\nswitch (pi->mode) {\r\ncase 0: w2(0xc); w0(0x10); w2(0x8); w2(0xc);\r\nfor (k=0;k<count/2;k++) {\r\nw2(0xd); a = r1();\r\nw2(0xf); b = r1();\r\nw2(0xc); c = r1();\r\nw2(0xe); d = r1();\r\nbuf[2*k ] = j44(a,b);\r\nbuf[2*k+1] = j44(c,d);\r\n}\r\nw2(0xc);\r\nbreak;\r\ncase 1: w2(0xc); w0(0x90); w2(0x8); w2(0xc);\r\nw2(0xec); w2(0xee);\r\nfor (k=0;k<count/2;k++) {\r\nw2(0xef); a = r0();\r\nw2(0xee); b = r0();\r\nbuf[2*k ] = a;\r\nbuf[2*k+1] = b;\r\n}\r\nw2(0xec);\r\nw2(0xc);\r\nbreak;\r\ncase 2: w2(0xc); w0(0x90); w2(0x8); w2(0xc);\r\nw2(0xec);\r\nfor (k=0;k<count;k++) buf[k] = r4();\r\nw2(0xc);\r\nbreak;\r\n}\r\n}\r\nstatic void fit3_write_block( PIA *pi, char * buf, int count )\r\n{ int k;\r\nswitch (pi->mode) {\r\ncase 0:\r\ncase 1: w2(0xc); w0(0); w2(0x8); w2(0xc);\r\nfor (k=0;k<count/2;k++) {\r\nw0(buf[2*k ]); w2(0xd);\r\nw0(buf[2*k+1]); w2(0xc);\r\n}\r\nbreak;\r\ncase 2: w2(0xc); w0(0); w2(0x8); w2(0xc);\r\nfor (k=0;k<count;k++) w4(buf[k]);\r\nw2(0xc);\r\nbreak;\r\n}\r\n}\r\nstatic void fit3_connect ( PIA *pi )\r\n{ pi->saved_r0 = r0();\r\npi->saved_r2 = r2();\r\nw2(0xc); w0(0); w2(0xa);\r\nif (pi->mode == 2) {\r\nw2(0xc); w0(0x9); w2(0x8); w2(0xc);\r\n}\r\n}\r\nstatic void fit3_disconnect ( PIA *pi )\r\n{ w2(0xc); w0(0xa); w2(0x8); w2(0xc);\r\nw0(pi->saved_r0);\r\nw2(pi->saved_r2);\r\n}\r\nstatic void fit3_log_adapter( PIA *pi, char * scratch, int verbose )\r\n{ char *mode_string[3] = {"4-bit","8-bit","EPP"};\r\nprintk("%s: fit3 %s, FIT 3000 adapter at 0x%x, "\r\n"mode %d (%s), delay %d\n",\r\npi->device,FIT3_VERSION,pi->port,\r\npi->mode,mode_string[pi->mode],pi->delay);\r\n}\r\nstatic int __init fit3_init(void)\r\n{\r\nreturn paride_register(&fit3);\r\n}\r\nstatic void __exit fit3_exit(void)\r\n{\r\nparide_unregister(&fit3);\r\n}

static u8 superio_ide_inb (unsigned long port)\r\n{\r\nu8 tmp;\r\nint retries = SUPERIO_IDE_MAX_RETRIES;\r\ndo {\r\ntmp = inb(port);\r\nif (tmp == 0)\r\nudelay(50);\r\n} while (tmp == 0 && retries-- > 0);\r\nreturn tmp;\r\n}\r\nstatic u8 superio_read_status(ide_hwif_t *hwif)\r\n{\r\nreturn superio_ide_inb(hwif->io_ports.status_addr);\r\n}\r\nstatic u8 superio_dma_sff_read_status(ide_hwif_t *hwif)\r\n{\r\nreturn superio_ide_inb(hwif->dma_base + ATA_DMA_STATUS);\r\n}\r\nstatic void superio_tf_read(ide_drive_t *drive, struct ide_taskfile *tf,\r\nu8 valid)\r\n{\r\nstruct ide_io_ports *io_ports = &drive->hwif->io_ports;\r\nif (valid & IDE_VALID_ERROR)\r\ntf->error = inb(io_ports->feature_addr);\r\nif (valid & IDE_VALID_NSECT)\r\ntf->nsect = inb(io_ports->nsect_addr);\r\nif (valid & IDE_VALID_LBAL)\r\ntf->lbal = inb(io_ports->lbal_addr);\r\nif (valid & IDE_VALID_LBAM)\r\ntf->lbam = inb(io_ports->lbam_addr);\r\nif (valid & IDE_VALID_LBAH)\r\ntf->lbah = inb(io_ports->lbah_addr);\r\nif (valid & IDE_VALID_DEVICE)\r\ntf->device = superio_ide_inb(io_ports->device_addr);\r\n}\r\nstatic void __devinit superio_init_iops(struct hwif_s *hwif)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(hwif->dev);\r\nu32 dma_stat;\r\nu8 port = hwif->channel, tmp;\r\ndma_stat = (pci_resource_start(pdev, 4) & ~3) + (!port ? 2 : 0xa);\r\ntmp = superio_ide_inb(dma_stat);\r\noutb(tmp | 0x66, dma_stat);\r\n}\r\nstatic void ns87415_prepare_drive (ide_drive_t *drive, unsigned int use_dma)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nunsigned int bit, other, new, *old = (unsigned int *) hwif->select_data;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nnew = *old;\r\nbit = 1 << (8 + hwif->channel);\r\nif (drive->dev_flags & IDE_DFLAG_PRESENT)\r\nnew &= ~bit;\r\nelse\r\nnew |= bit;\r\nbit = 1 << (20 + (drive->dn & 1) + (hwif->channel << 1));\r\nother = 1 << (20 + (1 - (drive->dn & 1)) + (hwif->channel << 1));\r\nnew = use_dma ? ((new & ~other) | bit) : (new & ~bit);\r\nif (new != *old) {\r\nunsigned char stat;\r\n(void) pci_read_config_byte(dev, 0x43, &stat);\r\nwhile (stat & 0x03) {\r\nudelay(1);\r\n(void) pci_read_config_byte(dev, 0x43, &stat);\r\n}\r\n*old = new;\r\n(void) pci_write_config_dword(dev, 0x40, new);\r\nudelay(10);\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void ns87415_dev_select(ide_drive_t *drive)\r\n{\r\nns87415_prepare_drive(drive,\r\n!!(drive->dev_flags & IDE_DFLAG_USING_DMA));\r\noutb(drive->select | ATA_DEVICE_OBS, drive->hwif->io_ports.device_addr);\r\n}\r\nstatic void ns87415_dma_start(ide_drive_t *drive)\r\n{\r\nns87415_prepare_drive(drive, 1);\r\nide_dma_start(drive);\r\n}\r\nstatic int ns87415_dma_end(ide_drive_t *drive)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nu8 dma_stat = 0, dma_cmd = 0;\r\ndma_stat = hwif->dma_ops->dma_sff_read_status(hwif);\r\ndma_cmd = inb(hwif->dma_base + ATA_DMA_CMD);\r\noutb(dma_cmd & ~1, hwif->dma_base + ATA_DMA_CMD);\r\ndma_cmd = inb(hwif->dma_base + ATA_DMA_CMD);\r\noutb(dma_cmd | 6, hwif->dma_base + ATA_DMA_CMD);\r\nns87415_prepare_drive(drive, 0);\r\nreturn (dma_stat & 7) != 4;\r\n}\r\nstatic void __devinit init_hwif_ns87415 (ide_hwif_t *hwif)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nunsigned int ctrl, using_inta;\r\nu8 progif;\r\n#ifdef __sparc_v9__\r\nint timeout;\r\nu8 stat;\r\n#endif\r\n(void) pci_read_config_dword(dev, 0x40, &ctrl);\r\n(void) pci_read_config_byte(dev, 0x09, &progif);\r\nusing_inta = progif & (1 << (hwif->channel << 1));\r\nif (!using_inta)\r\nusing_inta = ctrl & (1 << (4 + hwif->channel));\r\nif (hwif->mate) {\r\nhwif->select_data = hwif->mate->select_data;\r\n} else {\r\nhwif->select_data = (unsigned long)\r\n&ns87415_control[ns87415_count++];\r\nctrl |= (1 << 8) | (1 << 9);\r\nif (using_inta)\r\nctrl &= ~(1 << 6);\r\n*((unsigned int *)hwif->select_data) = ctrl;\r\n(void) pci_write_config_dword(dev, 0x40, ctrl);\r\npci_write_config_byte(dev, 0x55, 0xee);\r\n#ifdef __sparc_v9__\r\ntimeout = 10000;\r\noutb(12, hwif->io_ports.ctl_addr);\r\nudelay(10);\r\noutb(8, hwif->io_ports.ctl_addr);\r\ndo {\r\nudelay(50);\r\nstat = hwif->tp_ops->read_status(hwif);\r\nif (stat == 0xff)\r\nbreak;\r\n} while ((stat & ATA_BUSY) && --timeout);\r\n#endif\r\n}\r\nif (!using_inta)\r\nhwif->irq = pci_get_legacy_ide_irq(dev, hwif->channel);\r\nif (!hwif->dma_base)\r\nreturn;\r\noutb(0x60, hwif->dma_base + ATA_DMA_STATUS);\r\n}\r\nstatic int __devinit ns87415_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstruct ide_port_info d = ns87415_chipset;\r\n#ifdef CONFIG_SUPERIO\r\nif (PCI_SLOT(dev->devfn) == 0xE) {\r\nd.init_iops = superio_init_iops;\r\nd.tp_ops = &superio_tp_ops;\r\n}\r\n#endif\r\nreturn ide_pci_init_one(dev, &d, NULL);\r\n}\r\nstatic int __init ns87415_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&ns87415_pci_driver);\r\n}\r\nstatic void __exit ns87415_ide_exit(void)\r\n{\r\npci_unregister_driver(&ns87415_pci_driver);\r\n}

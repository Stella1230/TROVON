static int __devinit check_name(char *name)\r\n{\r\nchar **tmp;\r\nfor (tmp = modem_names; *tmp; tmp++)\r\nif (strstr(name, *tmp))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int __devinit check_resources(struct pnp_dev *dev)\r\n{\r\nresource_size_t base[] = {0x2f8, 0x3f8, 0x2e8, 0x3e8};\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(base); i++) {\r\nif (pnp_possible_config(dev, IORESOURCE_IO, base[i], 8))\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit serial_pnp_guess_board(struct pnp_dev *dev, int *flags)\r\n{\r\nif (!(check_name(pnp_dev_name(dev)) ||\r\n(dev->card && check_name(dev->card->name))))\r\nreturn -ENODEV;\r\nif (check_resources(dev))\r\nreturn 0;\r\nreturn -ENODEV;\r\n}\r\nstatic int __devinit\r\nserial_pnp_probe(struct pnp_dev *dev, const struct pnp_device_id *dev_id)\r\n{\r\nstruct uart_port port;\r\nint ret, line, flags = dev_id->driver_data;\r\nif (flags & UNKNOWN_DEV) {\r\nret = serial_pnp_guess_board(dev, &flags);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nmemset(&port, 0, sizeof(struct uart_port));\r\nif (pnp_irq_valid(dev, 0))\r\nport.irq = pnp_irq(dev, 0);\r\nif (pnp_port_valid(dev, 0)) {\r\nport.iobase = pnp_port_start(dev, 0);\r\nport.iotype = UPIO_PORT;\r\n} else if (pnp_mem_valid(dev, 0)) {\r\nport.mapbase = pnp_mem_start(dev, 0);\r\nport.iotype = UPIO_MEM;\r\nport.flags = UPF_IOREMAP;\r\n} else\r\nreturn -ENODEV;\r\n#ifdef SERIAL_DEBUG_PNP\r\nprintk(KERN_DEBUG\r\n"Setup PNP port: port %x, mem 0x%lx, irq %d, type %d\n",\r\nport.iobase, port.mapbase, port.irq, port.iotype);\r\n#endif\r\nport.flags |= UPF_SKIP_TEST | UPF_BOOT_AUTOCONF;\r\nif (pnp_irq_flags(dev, 0) & IORESOURCE_IRQ_SHAREABLE)\r\nport.flags |= UPF_SHARE_IRQ;\r\nport.uartclk = 1843200;\r\nport.dev = &dev->dev;\r\nline = serial8250_register_port(&port);\r\nif (line < 0)\r\nreturn -ENODEV;\r\npnp_set_drvdata(dev, (void *)((long)line + 1));\r\nreturn 0;\r\n}\r\nstatic void __devexit serial_pnp_remove(struct pnp_dev *dev)\r\n{\r\nlong line = (long)pnp_get_drvdata(dev);\r\nif (line)\r\nserial8250_unregister_port(line - 1);\r\n}\r\nstatic int serial_pnp_suspend(struct pnp_dev *dev, pm_message_t state)\r\n{\r\nlong line = (long)pnp_get_drvdata(dev);\r\nif (!line)\r\nreturn -ENODEV;\r\nserial8250_suspend_port(line - 1);\r\nreturn 0;\r\n}\r\nstatic int serial_pnp_resume(struct pnp_dev *dev)\r\n{\r\nlong line = (long)pnp_get_drvdata(dev);\r\nif (!line)\r\nreturn -ENODEV;\r\nserial8250_resume_port(line - 1);\r\nreturn 0;\r\n}\r\nstatic int __init serial8250_pnp_init(void)\r\n{\r\nreturn pnp_register_driver(&serial_pnp_driver);\r\n}\r\nstatic void __exit serial8250_pnp_exit(void)\r\n{\r\npnp_unregister_driver(&serial_pnp_driver);\r\n}

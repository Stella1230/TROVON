static int mantis_hif_sbuf_opdone_wait(struct mantis_ca *ca)\r\n{\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\nint rc = 0;\r\nif (wait_event_timeout(ca->hif_opdone_wq,\r\nca->hif_event & MANTIS_SBUF_OPDONE,\r\nmsecs_to_jiffies(500)) == -ERESTARTSYS) {\r\ndprintk(MANTIS_ERROR, 1, "Adapter(%d) Slot(0): Smart buffer operation timeout !", mantis->num);\r\nrc = -EREMOTEIO;\r\n}\r\ndprintk(MANTIS_DEBUG, 1, "Smart Buffer Operation complete");\r\nca->hif_event &= ~MANTIS_SBUF_OPDONE;\r\nreturn rc;\r\n}\r\nstatic int mantis_hif_write_wait(struct mantis_ca *ca)\r\n{\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\nu32 opdone = 0, timeout = 0;\r\nint rc = 0;\r\nif (wait_event_timeout(ca->hif_write_wq,\r\nmantis->gpif_status & MANTIS_GPIF_WRACK,\r\nmsecs_to_jiffies(500)) == -ERESTARTSYS) {\r\ndprintk(MANTIS_ERROR, 1, "Adapter(%d) Slot(0): Write ACK timed out !", mantis->num);\r\nrc = -EREMOTEIO;\r\n}\r\ndprintk(MANTIS_DEBUG, 1, "Write Acknowledged");\r\nmantis->gpif_status &= ~MANTIS_GPIF_WRACK;\r\nwhile (!opdone) {\r\nopdone = (mmread(MANTIS_GPIF_STATUS) & MANTIS_SBUF_OPDONE);\r\nudelay(500);\r\ntimeout++;\r\nif (timeout > 100) {\r\ndprintk(MANTIS_ERROR, 1, "Adater(%d) Slot(0): Write operation timed out!", mantis->num);\r\nrc = -ETIMEDOUT;\r\nbreak;\r\n}\r\n}\r\ndprintk(MANTIS_DEBUG, 1, "HIF Write success");\r\nreturn rc;\r\n}\r\nint mantis_hif_read_mem(struct mantis_ca *ca, u32 addr)\r\n{\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\nu32 hif_addr = 0, data, count = 4;\r\ndprintk(MANTIS_DEBUG, 1, "Adapter(%d) Slot(0): Request HIF Mem Read", mantis->num);\r\nmutex_lock(&ca->ca_lock);\r\nhif_addr &= ~MANTIS_GPIF_PCMCIAREG;\r\nhif_addr &= ~MANTIS_GPIF_PCMCIAIOM;\r\nhif_addr |= MANTIS_HIF_STATUS;\r\nhif_addr |= addr;\r\nmmwrite(hif_addr, MANTIS_GPIF_BRADDR);\r\nmmwrite(count, MANTIS_GPIF_BRBYTES);\r\nudelay(20);\r\nmmwrite(hif_addr | MANTIS_GPIF_HIFRDWRN, MANTIS_GPIF_ADDR);\r\nif (mantis_hif_sbuf_opdone_wait(ca) != 0) {\r\ndprintk(MANTIS_ERROR, 1, "Adapter(%d) Slot(0): GPIF Smart Buffer operation failed", mantis->num);\r\nmutex_unlock(&ca->ca_lock);\r\nreturn -EREMOTEIO;\r\n}\r\ndata = mmread(MANTIS_GPIF_DIN);\r\nmutex_unlock(&ca->ca_lock);\r\ndprintk(MANTIS_DEBUG, 1, "Mem Read: 0x%02x", data);\r\nreturn (data >> 24) & 0xff;\r\n}\r\nint mantis_hif_write_mem(struct mantis_ca *ca, u32 addr, u8 data)\r\n{\r\nstruct mantis_slot *slot = ca->slot;\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\nu32 hif_addr = 0;\r\ndprintk(MANTIS_DEBUG, 1, "Adapter(%d) Slot(0): Request HIF Mem Write", mantis->num);\r\nmutex_lock(&ca->ca_lock);\r\nhif_addr &= ~MANTIS_GPIF_HIFRDWRN;\r\nhif_addr &= ~MANTIS_GPIF_PCMCIAREG;\r\nhif_addr &= ~MANTIS_GPIF_PCMCIAIOM;\r\nhif_addr |= MANTIS_HIF_STATUS;\r\nhif_addr |= addr;\r\nmmwrite(slot->slave_cfg, MANTIS_GPIF_CFGSLA);\r\nmmwrite(hif_addr, MANTIS_GPIF_ADDR);\r\nmmwrite(data, MANTIS_GPIF_DOUT);\r\nif (mantis_hif_write_wait(ca) != 0) {\r\ndprintk(MANTIS_ERROR, 1, "Adapter(%d) Slot(0): HIF Smart Buffer operation failed", mantis->num);\r\nmutex_unlock(&ca->ca_lock);\r\nreturn -EREMOTEIO;\r\n}\r\ndprintk(MANTIS_DEBUG, 1, "Mem Write: (0x%02x to 0x%02x)", data, addr);\r\nmutex_unlock(&ca->ca_lock);\r\nreturn 0;\r\n}\r\nint mantis_hif_read_iom(struct mantis_ca *ca, u32 addr)\r\n{\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\nu32 data, hif_addr = 0;\r\ndprintk(MANTIS_DEBUG, 1, "Adapter(%d) Slot(0): Request HIF I/O Read", mantis->num);\r\nmutex_lock(&ca->ca_lock);\r\nhif_addr &= ~MANTIS_GPIF_PCMCIAREG;\r\nhif_addr |= MANTIS_GPIF_PCMCIAIOM;\r\nhif_addr |= MANTIS_HIF_STATUS;\r\nhif_addr |= addr;\r\nmmwrite(hif_addr, MANTIS_GPIF_BRADDR);\r\nmmwrite(1, MANTIS_GPIF_BRBYTES);\r\nudelay(20);\r\nmmwrite(hif_addr | MANTIS_GPIF_HIFRDWRN, MANTIS_GPIF_ADDR);\r\nif (mantis_hif_sbuf_opdone_wait(ca) != 0) {\r\ndprintk(MANTIS_ERROR, 1, "Adapter(%d) Slot(0): HIF Smart Buffer operation failed", mantis->num);\r\nmutex_unlock(&ca->ca_lock);\r\nreturn -EREMOTEIO;\r\n}\r\ndata = mmread(MANTIS_GPIF_DIN);\r\ndprintk(MANTIS_DEBUG, 1, "I/O Read: 0x%02x", data);\r\nudelay(50);\r\nmutex_unlock(&ca->ca_lock);\r\nreturn (u8) data;\r\n}\r\nint mantis_hif_write_iom(struct mantis_ca *ca, u32 addr, u8 data)\r\n{\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\nu32 hif_addr = 0;\r\ndprintk(MANTIS_DEBUG, 1, "Adapter(%d) Slot(0): Request HIF I/O Write", mantis->num);\r\nmutex_lock(&ca->ca_lock);\r\nhif_addr &= ~MANTIS_GPIF_PCMCIAREG;\r\nhif_addr &= ~MANTIS_GPIF_HIFRDWRN;\r\nhif_addr |= MANTIS_GPIF_PCMCIAIOM;\r\nhif_addr |= MANTIS_HIF_STATUS;\r\nhif_addr |= addr;\r\nmmwrite(hif_addr, MANTIS_GPIF_ADDR);\r\nmmwrite(data, MANTIS_GPIF_DOUT);\r\nif (mantis_hif_write_wait(ca) != 0) {\r\ndprintk(MANTIS_ERROR, 1, "Adapter(%d) Slot(0): HIF Smart Buffer operation failed", mantis->num);\r\nmutex_unlock(&ca->ca_lock);\r\nreturn -EREMOTEIO;\r\n}\r\ndprintk(MANTIS_DEBUG, 1, "I/O Write: (0x%02x to 0x%02x)", data, addr);\r\nmutex_unlock(&ca->ca_lock);\r\nudelay(50);\r\nreturn 0;\r\n}\r\nint mantis_hif_init(struct mantis_ca *ca)\r\n{\r\nstruct mantis_slot *slot = ca->slot;\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\nu32 irqcfg;\r\nslot[0].slave_cfg = 0x70773028;\r\ndprintk(MANTIS_ERROR, 1, "Adapter(%d) Initializing Mantis Host Interface", mantis->num);\r\nmutex_lock(&ca->ca_lock);\r\nirqcfg = mmread(MANTIS_GPIF_IRQCFG);\r\nirqcfg = MANTIS_MASK_BRRDY |\r\nMANTIS_MASK_WRACK |\r\nMANTIS_MASK_EXTIRQ |\r\nMANTIS_MASK_WSTO |\r\nMANTIS_MASK_OTHERR |\r\nMANTIS_MASK_OVFLW;\r\nmmwrite(irqcfg, MANTIS_GPIF_IRQCFG);\r\nmutex_unlock(&ca->ca_lock);\r\nreturn 0;\r\n}\r\nvoid mantis_hif_exit(struct mantis_ca *ca)\r\n{\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\nu32 irqcfg;\r\ndprintk(MANTIS_ERROR, 1, "Adapter(%d) Exiting Mantis Host Interface", mantis->num);\r\nmutex_lock(&ca->ca_lock);\r\nirqcfg = mmread(MANTIS_GPIF_IRQCFG);\r\nirqcfg &= ~MANTIS_MASK_BRRDY;\r\nmmwrite(irqcfg, MANTIS_GPIF_IRQCFG);\r\nmutex_unlock(&ca->ca_lock);\r\n}

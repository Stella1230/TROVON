static void sh2a__flush_wback_region(void *start, int size)\r\n{\r\nunsigned long v;\r\nunsigned long begin, end;\r\nunsigned long flags;\r\nbegin = (unsigned long)start & ~(L1_CACHE_BYTES-1);\r\nend = ((unsigned long)start + size + L1_CACHE_BYTES-1)\r\n& ~(L1_CACHE_BYTES-1);\r\nlocal_irq_save(flags);\r\njump_to_uncached();\r\nfor (v = begin; v < end; v+=L1_CACHE_BYTES) {\r\nunsigned long addr = CACHE_OC_ADDRESS_ARRAY | (v & 0x000007f0);\r\nint way;\r\nfor (way = 0; way < 4; way++) {\r\nunsigned long data = __raw_readl(addr | (way << 11));\r\nif ((data & CACHE_PHYSADDR_MASK) == (v & CACHE_PHYSADDR_MASK)) {\r\ndata &= ~SH_CACHE_UPDATED;\r\n__raw_writel(data, addr | (way << 11));\r\n}\r\n}\r\n}\r\nback_to_cached();\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void sh2a__flush_purge_region(void *start, int size)\r\n{\r\nunsigned long v;\r\nunsigned long begin, end;\r\nunsigned long flags;\r\nbegin = (unsigned long)start & ~(L1_CACHE_BYTES-1);\r\nend = ((unsigned long)start + size + L1_CACHE_BYTES-1)\r\n& ~(L1_CACHE_BYTES-1);\r\nlocal_irq_save(flags);\r\njump_to_uncached();\r\nfor (v = begin; v < end; v+=L1_CACHE_BYTES) {\r\n__raw_writel((v & CACHE_PHYSADDR_MASK),\r\nCACHE_OC_ADDRESS_ARRAY | (v & 0x000007f0) | 0x00000008);\r\n}\r\nback_to_cached();\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void sh2a__flush_invalidate_region(void *start, int size)\r\n{\r\nunsigned long v;\r\nunsigned long begin, end;\r\nunsigned long flags;\r\nbegin = (unsigned long)start & ~(L1_CACHE_BYTES-1);\r\nend = ((unsigned long)start + size + L1_CACHE_BYTES-1)\r\n& ~(L1_CACHE_BYTES-1);\r\nlocal_irq_save(flags);\r\njump_to_uncached();\r\n#ifdef CONFIG_CACHE_WRITEBACK\r\n__raw_writel(__raw_readl(CCR) | CCR_OCACHE_INVALIDATE, CCR);\r\nfor (v = begin; v < end; v+=L1_CACHE_BYTES) {\r\n__raw_writel((v & CACHE_PHYSADDR_MASK),\r\nCACHE_IC_ADDRESS_ARRAY | (v & 0x000007f0) | 0x00000008);\r\n}\r\n#else\r\nfor (v = begin; v < end; v+=L1_CACHE_BYTES) {\r\n__raw_writel((v & CACHE_PHYSADDR_MASK),\r\nCACHE_IC_ADDRESS_ARRAY | (v & 0x000007f0) | 0x00000008);\r\n__raw_writel((v & CACHE_PHYSADDR_MASK),\r\nCACHE_OC_ADDRESS_ARRAY | (v & 0x000007f0) | 0x00000008);\r\n}\r\n#endif\r\nback_to_cached();\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void sh2a_flush_icache_range(void *args)\r\n{\r\nstruct flusher_data *data = args;\r\nunsigned long start, end;\r\nunsigned long v;\r\nunsigned long flags;\r\nstart = data->addr1 & ~(L1_CACHE_BYTES-1);\r\nend = (data->addr2 + L1_CACHE_BYTES-1) & ~(L1_CACHE_BYTES-1);\r\nlocal_irq_save(flags);\r\njump_to_uncached();\r\nfor (v = start; v < end; v+=L1_CACHE_BYTES) {\r\nunsigned long addr = (v & 0x000007f0);\r\nint way;\r\nfor (way = 0; way < 4; way++) {\r\nunsigned long data = __raw_readl(CACHE_OC_ADDRESS_ARRAY | addr | (way << 11));\r\nif ((data & CACHE_PHYSADDR_MASK) == (v & CACHE_PHYSADDR_MASK)) {\r\ndata &= ~SH_CACHE_UPDATED;\r\n__raw_writel(data, CACHE_OC_ADDRESS_ARRAY | addr | (way << 11));\r\n}\r\n}\r\n__raw_writel(addr,\r\nCACHE_IC_ADDRESS_ARRAY | addr | 0x00000008);\r\n}\r\nback_to_cached();\r\nlocal_irq_restore(flags);\r\n}\r\nvoid __init sh2a_cache_init(void)\r\n{\r\nlocal_flush_icache_range = sh2a_flush_icache_range;\r\n__flush_wback_region = sh2a__flush_wback_region;\r\n__flush_purge_region = sh2a__flush_purge_region;\r\n__flush_invalidate_region = sh2a__flush_invalidate_region;\r\n}

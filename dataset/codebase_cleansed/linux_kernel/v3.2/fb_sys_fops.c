ssize_t fb_sys_read(struct fb_info *info, char __user *buf, size_t count,\r\nloff_t *ppos)\r\n{\r\nunsigned long p = *ppos;\r\nvoid *src;\r\nint err = 0;\r\nunsigned long total_size;\r\nif (info->state != FBINFO_STATE_RUNNING)\r\nreturn -EPERM;\r\ntotal_size = info->screen_size;\r\nif (total_size == 0)\r\ntotal_size = info->fix.smem_len;\r\nif (p >= total_size)\r\nreturn 0;\r\nif (count >= total_size)\r\ncount = total_size;\r\nif (count + p > total_size)\r\ncount = total_size - p;\r\nsrc = (void __force *)(info->screen_base + p);\r\nif (info->fbops->fb_sync)\r\ninfo->fbops->fb_sync(info);\r\nif (copy_to_user(buf, src, count))\r\nerr = -EFAULT;\r\nif (!err)\r\n*ppos += count;\r\nreturn (err) ? err : count;\r\n}\r\nssize_t fb_sys_write(struct fb_info *info, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nunsigned long p = *ppos;\r\nvoid *dst;\r\nint err = 0;\r\nunsigned long total_size;\r\nif (info->state != FBINFO_STATE_RUNNING)\r\nreturn -EPERM;\r\ntotal_size = info->screen_size;\r\nif (total_size == 0)\r\ntotal_size = info->fix.smem_len;\r\nif (p > total_size)\r\nreturn -EFBIG;\r\nif (count > total_size) {\r\nerr = -EFBIG;\r\ncount = total_size;\r\n}\r\nif (count + p > total_size) {\r\nif (!err)\r\nerr = -ENOSPC;\r\ncount = total_size - p;\r\n}\r\ndst = (void __force *) (info->screen_base + p);\r\nif (info->fbops->fb_sync)\r\ninfo->fbops->fb_sync(info);\r\nif (copy_from_user(dst, buf, count))\r\nerr = -EFAULT;\r\nif (!err)\r\n*ppos += count;\r\nreturn (err) ? err : count;\r\n}

static cycle_t read_hrt(struct clocksource *cs)\r\n{\r\nreturn (cycle_t) inl(scx200_cb_base + SCx200_TIMER_OFFSET);\r\n}\r\nstatic int __init init_hrt_clocksource(void)\r\n{\r\nif (!scx200_cb_present())\r\nreturn -ENODEV;\r\nif (!request_region(scx200_cb_base + SCx200_TIMER_OFFSET,\r\nSCx200_TIMER_SIZE,\r\n"NatSemi SCx200 High-Resolution Timer")) {\r\nprintk(KERN_WARNING NAME ": unable to lock timer region\n");\r\nreturn -ENODEV;\r\n}\r\noutb(HR_TMEN | (mhz27 ? HR_TMCLKSEL : 0),\r\nscx200_cb_base + SCx200_TMCNFG_OFFSET);\r\nif (mhz27) {\r\ncs_hrt.shift = HRT_SHIFT_27;\r\ncs_hrt.mult = clocksource_hz2mult((HRT_FREQ + ppm) * 27,\r\ncs_hrt.shift);\r\n} else {\r\ncs_hrt.shift = HRT_SHIFT_1;\r\ncs_hrt.mult = clocksource_hz2mult(HRT_FREQ + ppm,\r\ncs_hrt.shift);\r\n}\r\nprintk(KERN_INFO "enabling scx200 high-res timer (%s MHz +%d ppm)\n",\r\nmhz27 ? "27":"1", ppm);\r\nreturn clocksource_register(&cs_hrt);\r\n}

static void i2c_versatile_setsda(void *data, int state)\r\n{\r\nstruct i2c_versatile *i2c = data;\r\nwritel(SDA, i2c->base + (state ? I2C_CONTROLS : I2C_CONTROLC));\r\n}\r\nstatic void i2c_versatile_setscl(void *data, int state)\r\n{\r\nstruct i2c_versatile *i2c = data;\r\nwritel(SCL, i2c->base + (state ? I2C_CONTROLS : I2C_CONTROLC));\r\n}\r\nstatic int i2c_versatile_getsda(void *data)\r\n{\r\nstruct i2c_versatile *i2c = data;\r\nreturn !!(readl(i2c->base + I2C_CONTROL) & SDA);\r\n}\r\nstatic int i2c_versatile_getscl(void *data)\r\n{\r\nstruct i2c_versatile *i2c = data;\r\nreturn !!(readl(i2c->base + I2C_CONTROL) & SCL);\r\n}\r\nstatic int i2c_versatile_probe(struct platform_device *dev)\r\n{\r\nstruct i2c_versatile *i2c;\r\nstruct resource *r;\r\nint ret;\r\nr = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!r) {\r\nret = -EINVAL;\r\ngoto err_out;\r\n}\r\nif (!request_mem_region(r->start, resource_size(r), "versatile-i2c")) {\r\nret = -EBUSY;\r\ngoto err_out;\r\n}\r\ni2c = kzalloc(sizeof(struct i2c_versatile), GFP_KERNEL);\r\nif (!i2c) {\r\nret = -ENOMEM;\r\ngoto err_release;\r\n}\r\ni2c->base = ioremap(r->start, resource_size(r));\r\nif (!i2c->base) {\r\nret = -ENOMEM;\r\ngoto err_free;\r\n}\r\nwritel(SCL | SDA, i2c->base + I2C_CONTROLS);\r\ni2c->adap.owner = THIS_MODULE;\r\nstrlcpy(i2c->adap.name, "Versatile I2C adapter", sizeof(i2c->adap.name));\r\ni2c->adap.algo_data = &i2c->algo;\r\ni2c->adap.dev.parent = &dev->dev;\r\ni2c->algo = i2c_versatile_algo;\r\ni2c->algo.data = i2c;\r\nif (dev->id >= 0) {\r\ni2c->adap.nr = dev->id;\r\nret = i2c_bit_add_numbered_bus(&i2c->adap);\r\n} else\r\nret = i2c_bit_add_bus(&i2c->adap);\r\nif (ret >= 0) {\r\nplatform_set_drvdata(dev, i2c);\r\nreturn 0;\r\n}\r\niounmap(i2c->base);\r\nerr_free:\r\nkfree(i2c);\r\nerr_release:\r\nrelease_mem_region(r->start, resource_size(r));\r\nerr_out:\r\nreturn ret;\r\n}\r\nstatic int i2c_versatile_remove(struct platform_device *dev)\r\n{\r\nstruct i2c_versatile *i2c = platform_get_drvdata(dev);\r\nplatform_set_drvdata(dev, NULL);\r\ni2c_del_adapter(&i2c->adap);\r\nreturn 0;\r\n}\r\nstatic int __init i2c_versatile_init(void)\r\n{\r\nreturn platform_driver_register(&i2c_versatile_driver);\r\n}\r\nstatic void __exit i2c_versatile_exit(void)\r\n{\r\nplatform_driver_unregister(&i2c_versatile_driver);\r\n}

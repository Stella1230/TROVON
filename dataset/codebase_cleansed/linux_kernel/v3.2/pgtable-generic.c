int ptep_set_access_flags(struct vm_area_struct *vma,\r\nunsigned long address, pte_t *ptep,\r\npte_t entry, int dirty)\r\n{\r\nint changed = !pte_same(*ptep, entry);\r\nif (changed) {\r\nset_pte_at(vma->vm_mm, address, ptep, entry);\r\nflush_tlb_page(vma, address);\r\n}\r\nreturn changed;\r\n}\r\nint pmdp_set_access_flags(struct vm_area_struct *vma,\r\nunsigned long address, pmd_t *pmdp,\r\npmd_t entry, int dirty)\r\n{\r\n#ifdef CONFIG_TRANSPARENT_HUGEPAGE\r\nint changed = !pmd_same(*pmdp, entry);\r\nVM_BUG_ON(address & ~HPAGE_PMD_MASK);\r\nif (changed) {\r\nset_pmd_at(vma->vm_mm, address, pmdp, entry);\r\nflush_tlb_range(vma, address, address + HPAGE_PMD_SIZE);\r\n}\r\nreturn changed;\r\n#else\r\nBUG();\r\nreturn 0;\r\n#endif\r\n}\r\nint ptep_clear_flush_young(struct vm_area_struct *vma,\r\nunsigned long address, pte_t *ptep)\r\n{\r\nint young;\r\nyoung = ptep_test_and_clear_young(vma, address, ptep);\r\nif (young)\r\nflush_tlb_page(vma, address);\r\nreturn young;\r\n}\r\nint pmdp_clear_flush_young(struct vm_area_struct *vma,\r\nunsigned long address, pmd_t *pmdp)\r\n{\r\nint young;\r\n#ifndef CONFIG_TRANSPARENT_HUGEPAGE\r\nBUG();\r\n#endif\r\nVM_BUG_ON(address & ~HPAGE_PMD_MASK);\r\nyoung = pmdp_test_and_clear_young(vma, address, pmdp);\r\nif (young)\r\nflush_tlb_range(vma, address, address + HPAGE_PMD_SIZE);\r\nreturn young;\r\n}\r\npte_t ptep_clear_flush(struct vm_area_struct *vma, unsigned long address,\r\npte_t *ptep)\r\n{\r\npte_t pte;\r\npte = ptep_get_and_clear((vma)->vm_mm, address, ptep);\r\nflush_tlb_page(vma, address);\r\nreturn pte;\r\n}\r\npmd_t pmdp_clear_flush(struct vm_area_struct *vma, unsigned long address,\r\npmd_t *pmdp)\r\n{\r\npmd_t pmd;\r\nVM_BUG_ON(address & ~HPAGE_PMD_MASK);\r\npmd = pmdp_get_and_clear(vma->vm_mm, address, pmdp);\r\nflush_tlb_range(vma, address, address + HPAGE_PMD_SIZE);\r\nreturn pmd;\r\n}\r\npmd_t pmdp_splitting_flush(struct vm_area_struct *vma, unsigned long address,\r\npmd_t *pmdp)\r\n{\r\npmd_t pmd = pmd_mksplitting(*pmdp);\r\nVM_BUG_ON(address & ~HPAGE_PMD_MASK);\r\nset_pmd_at(vma->vm_mm, address, pmdp, pmd);\r\nflush_tlb_range(vma, address, address + HPAGE_PMD_SIZE);\r\n}

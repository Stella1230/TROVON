static inline unsigned long long notrace _omap_32k_sched_clock(void)\r\n{\r\nu32 cyc = timer_32k_base ? __raw_readl(timer_32k_base) : 0;\r\nreturn cyc_to_fixed_sched_clock(&cd, cyc, (u32)~0, SC_MULT, SC_SHIFT);\r\n}\r\nunsigned long long notrace sched_clock(void)\r\n{\r\nreturn _omap_32k_sched_clock();\r\n}\r\nunsigned long long notrace omap_32k_sched_clock(void)\r\n{\r\nreturn _omap_32k_sched_clock();\r\n}\r\nstatic void notrace omap_update_sched_clock(void)\r\n{\r\nu32 cyc = timer_32k_base ? __raw_readl(timer_32k_base) : 0;\r\nupdate_sched_clock(&cd, cyc, (u32)~0);\r\n}\r\nvoid read_persistent_clock(struct timespec *ts)\r\n{\r\nunsigned long long nsecs;\r\ncycles_t delta;\r\nstruct timespec *tsp = &persistent_ts;\r\nlast_cycles = cycles;\r\ncycles = timer_32k_base ? __raw_readl(timer_32k_base) : 0;\r\ndelta = cycles - last_cycles;\r\nnsecs = clocksource_cyc2ns(delta, persistent_mult, persistent_shift);\r\ntimespec_add_ns(tsp, nsecs);\r\n*ts = *tsp;\r\n}\r\nint __init omap_init_clocksource_32k(void)\r\n{\r\nstatic char err[] __initdata = KERN_ERR\r\n"%s: can't register clocksource!\n";\r\nif (cpu_is_omap16xx() || cpu_class_is_omap2()) {\r\nu32 pbase;\r\nunsigned long size = SZ_4K;\r\nvoid __iomem *base;\r\nstruct clk *sync_32k_ick;\r\nif (cpu_is_omap16xx()) {\r\npbase = OMAP16XX_TIMER_32K_SYNCHRONIZED;\r\nsize = SZ_1K;\r\n} else if (cpu_is_omap2420())\r\npbase = OMAP2420_32KSYNCT_BASE + 0x10;\r\nelse if (cpu_is_omap2430())\r\npbase = OMAP2430_32KSYNCT_BASE + 0x10;\r\nelse if (cpu_is_omap34xx())\r\npbase = OMAP3430_32KSYNCT_BASE + 0x10;\r\nelse if (cpu_is_omap44xx())\r\npbase = OMAP4430_32KSYNCT_BASE + 0x10;\r\nelse\r\nreturn -ENODEV;\r\nbase = ioremap(pbase, size);\r\nif (!base)\r\nreturn -ENODEV;\r\nsync_32k_ick = clk_get(NULL, "omap_32ksync_ick");\r\nif (!IS_ERR(sync_32k_ick))\r\nclk_enable(sync_32k_ick);\r\ntimer_32k_base = base;\r\nclocks_calc_mult_shift(&persistent_mult, &persistent_shift,\r\n32768, NSEC_PER_SEC, 120000);\r\nif (clocksource_mmio_init(base, "32k_counter", 32768, 250, 32,\r\nclocksource_mmio_readl_up))\r\nprintk(err, "32k_counter");\r\ninit_fixed_sched_clock(&cd, omap_update_sched_clock, 32,\r\n32768, SC_MULT, SC_SHIFT);\r\n}\r\nreturn 0;\r\n}

static void at91_rtc_decodetime(unsigned int timereg, unsigned int calreg,\r\nstruct rtc_time *tm)\r\n{\r\nunsigned int time, date;\r\ndo {\r\ntime = at91_sys_read(timereg);\r\ndate = at91_sys_read(calreg);\r\n} while ((time != at91_sys_read(timereg)) ||\r\n(date != at91_sys_read(calreg)));\r\ntm->tm_sec = bcd2bin((time & AT91_RTC_SEC) >> 0);\r\ntm->tm_min = bcd2bin((time & AT91_RTC_MIN) >> 8);\r\ntm->tm_hour = bcd2bin((time & AT91_RTC_HOUR) >> 16);\r\ntm->tm_year = bcd2bin(date & AT91_RTC_CENT) * 100;\r\ntm->tm_year += bcd2bin((date & AT91_RTC_YEAR) >> 8);\r\ntm->tm_wday = bcd2bin((date & AT91_RTC_DAY) >> 21) - 1;\r\ntm->tm_mon = bcd2bin((date & AT91_RTC_MONTH) >> 16) - 1;\r\ntm->tm_mday = bcd2bin((date & AT91_RTC_DATE) >> 24);\r\n}\r\nstatic int at91_rtc_readtime(struct device *dev, struct rtc_time *tm)\r\n{\r\nat91_rtc_decodetime(AT91_RTC_TIMR, AT91_RTC_CALR, tm);\r\ntm->tm_yday = rtc_year_days(tm->tm_mday, tm->tm_mon, tm->tm_year);\r\ntm->tm_year = tm->tm_year - 1900;\r\npr_debug("%s(): %4d-%02d-%02d %02d:%02d:%02d\n", __func__,\r\n1900 + tm->tm_year, tm->tm_mon, tm->tm_mday,\r\ntm->tm_hour, tm->tm_min, tm->tm_sec);\r\nreturn 0;\r\n}\r\nstatic int at91_rtc_settime(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned long cr;\r\npr_debug("%s(): %4d-%02d-%02d %02d:%02d:%02d\n", __func__,\r\n1900 + tm->tm_year, tm->tm_mon, tm->tm_mday,\r\ntm->tm_hour, tm->tm_min, tm->tm_sec);\r\ncr = at91_sys_read(AT91_RTC_CR);\r\nat91_sys_write(AT91_RTC_CR, cr | AT91_RTC_UPDCAL | AT91_RTC_UPDTIM);\r\nat91_sys_write(AT91_RTC_IER, AT91_RTC_ACKUPD);\r\nwait_for_completion(&at91_rtc_updated);\r\nat91_sys_write(AT91_RTC_IDR, AT91_RTC_ACKUPD);\r\nat91_sys_write(AT91_RTC_TIMR,\r\nbin2bcd(tm->tm_sec) << 0\r\n| bin2bcd(tm->tm_min) << 8\r\n| bin2bcd(tm->tm_hour) << 16);\r\nat91_sys_write(AT91_RTC_CALR,\r\nbin2bcd((tm->tm_year + 1900) / 100)\r\n| bin2bcd(tm->tm_year % 100) << 8\r\n| bin2bcd(tm->tm_mon + 1) << 16\r\n| bin2bcd(tm->tm_wday + 1) << 21\r\n| bin2bcd(tm->tm_mday) << 24);\r\ncr = at91_sys_read(AT91_RTC_CR);\r\nat91_sys_write(AT91_RTC_CR, cr & ~(AT91_RTC_UPDCAL | AT91_RTC_UPDTIM));\r\nreturn 0;\r\n}\r\nstatic int at91_rtc_readalarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct rtc_time *tm = &alrm->time;\r\nat91_rtc_decodetime(AT91_RTC_TIMALR, AT91_RTC_CALALR, tm);\r\ntm->tm_yday = rtc_year_days(tm->tm_mday, tm->tm_mon, tm->tm_year);\r\ntm->tm_year = at91_alarm_year - 1900;\r\nalrm->enabled = (at91_sys_read(AT91_RTC_IMR) & AT91_RTC_ALARM)\r\n? 1 : 0;\r\npr_debug("%s(): %4d-%02d-%02d %02d:%02d:%02d\n", __func__,\r\n1900 + tm->tm_year, tm->tm_mon, tm->tm_mday,\r\ntm->tm_hour, tm->tm_min, tm->tm_sec);\r\nreturn 0;\r\n}\r\nstatic int at91_rtc_setalarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct rtc_time tm;\r\nat91_rtc_decodetime(AT91_RTC_TIMR, AT91_RTC_CALR, &tm);\r\nat91_alarm_year = tm.tm_year;\r\ntm.tm_hour = alrm->time.tm_hour;\r\ntm.tm_min = alrm->time.tm_min;\r\ntm.tm_sec = alrm->time.tm_sec;\r\nat91_sys_write(AT91_RTC_IDR, AT91_RTC_ALARM);\r\nat91_sys_write(AT91_RTC_TIMALR,\r\nbin2bcd(tm.tm_sec) << 0\r\n| bin2bcd(tm.tm_min) << 8\r\n| bin2bcd(tm.tm_hour) << 16\r\n| AT91_RTC_HOUREN | AT91_RTC_MINEN | AT91_RTC_SECEN);\r\nat91_sys_write(AT91_RTC_CALALR,\r\nbin2bcd(tm.tm_mon + 1) << 16\r\n| bin2bcd(tm.tm_mday) << 24\r\n| AT91_RTC_DATEEN | AT91_RTC_MTHEN);\r\nif (alrm->enabled) {\r\nat91_sys_write(AT91_RTC_SCCR, AT91_RTC_ALARM);\r\nat91_sys_write(AT91_RTC_IER, AT91_RTC_ALARM);\r\n}\r\npr_debug("%s(): %4d-%02d-%02d %02d:%02d:%02d\n", __func__,\r\nat91_alarm_year, tm.tm_mon, tm.tm_mday, tm.tm_hour,\r\ntm.tm_min, tm.tm_sec);\r\nreturn 0;\r\n}\r\nstatic int at91_rtc_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\npr_debug("%s(): cmd=%08x\n", __func__, enabled);\r\nif (enabled) {\r\nat91_sys_write(AT91_RTC_SCCR, AT91_RTC_ALARM);\r\nat91_sys_write(AT91_RTC_IER, AT91_RTC_ALARM);\r\n} else\r\nat91_sys_write(AT91_RTC_IDR, AT91_RTC_ALARM);\r\nreturn 0;\r\n}\r\nstatic int at91_rtc_proc(struct device *dev, struct seq_file *seq)\r\n{\r\nunsigned long imr = at91_sys_read(AT91_RTC_IMR);\r\nseq_printf(seq, "update_IRQ\t: %s\n",\r\n(imr & AT91_RTC_ACKUPD) ? "yes" : "no");\r\nseq_printf(seq, "periodic_IRQ\t: %s\n",\r\n(imr & AT91_RTC_SECEV) ? "yes" : "no");\r\nreturn 0;\r\n}\r\nstatic irqreturn_t at91_rtc_interrupt(int irq, void *dev_id)\r\n{\r\nstruct platform_device *pdev = dev_id;\r\nstruct rtc_device *rtc = platform_get_drvdata(pdev);\r\nunsigned int rtsr;\r\nunsigned long events = 0;\r\nrtsr = at91_sys_read(AT91_RTC_SR) & at91_sys_read(AT91_RTC_IMR);\r\nif (rtsr) {\r\nif (rtsr & AT91_RTC_ALARM)\r\nevents |= (RTC_AF | RTC_IRQF);\r\nif (rtsr & AT91_RTC_SECEV)\r\nevents |= (RTC_UF | RTC_IRQF);\r\nif (rtsr & AT91_RTC_ACKUPD)\r\ncomplete(&at91_rtc_updated);\r\nat91_sys_write(AT91_RTC_SCCR, rtsr);\r\nrtc_update_irq(rtc, 1, events);\r\npr_debug("%s(): num=%ld, events=0x%02lx\n", __func__,\r\nevents >> 8, events & 0x000000FF);\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic int __init at91_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc;\r\nint ret;\r\nat91_sys_write(AT91_RTC_CR, 0);\r\nat91_sys_write(AT91_RTC_MR, 0);\r\nat91_sys_write(AT91_RTC_IDR, AT91_RTC_ACKUPD | AT91_RTC_ALARM |\r\nAT91_RTC_SECEV | AT91_RTC_TIMEV |\r\nAT91_RTC_CALEV);\r\nret = request_irq(AT91_ID_SYS, at91_rtc_interrupt,\r\nIRQF_SHARED,\r\n"at91_rtc", pdev);\r\nif (ret) {\r\nprintk(KERN_ERR "at91_rtc: IRQ %d already in use.\n",\r\nAT91_ID_SYS);\r\nreturn ret;\r\n}\r\nif (!device_can_wakeup(&pdev->dev))\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nrtc = rtc_device_register(pdev->name, &pdev->dev,\r\n&at91_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc)) {\r\nfree_irq(AT91_ID_SYS, pdev);\r\nreturn PTR_ERR(rtc);\r\n}\r\nplatform_set_drvdata(pdev, rtc);\r\nprintk(KERN_INFO "AT91 Real Time Clock driver.\n");\r\nreturn 0;\r\n}\r\nstatic int __exit at91_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc = platform_get_drvdata(pdev);\r\nat91_sys_write(AT91_RTC_IDR, AT91_RTC_ACKUPD | AT91_RTC_ALARM |\r\nAT91_RTC_SECEV | AT91_RTC_TIMEV |\r\nAT91_RTC_CALEV);\r\nfree_irq(AT91_ID_SYS, pdev);\r\nrtc_device_unregister(rtc);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int at91_rtc_suspend(struct device *dev)\r\n{\r\nat91_rtc_imr = at91_sys_read(AT91_RTC_IMR)\r\n& (AT91_RTC_ALARM|AT91_RTC_SECEV);\r\nif (at91_rtc_imr) {\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(AT91_ID_SYS);\r\nelse\r\nat91_sys_write(AT91_RTC_IDR, at91_rtc_imr);\r\n}\r\nreturn 0;\r\n}\r\nstatic int at91_rtc_resume(struct device *dev)\r\n{\r\nif (at91_rtc_imr) {\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(AT91_ID_SYS);\r\nelse\r\nat91_sys_write(AT91_RTC_IER, at91_rtc_imr);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init at91_rtc_init(void)\r\n{\r\nreturn platform_driver_probe(&at91_rtc_driver, at91_rtc_probe);\r\n}\r\nstatic void __exit at91_rtc_exit(void)\r\n{\r\nplatform_driver_unregister(&at91_rtc_driver);\r\n}

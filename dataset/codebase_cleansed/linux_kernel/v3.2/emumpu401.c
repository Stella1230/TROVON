static inline unsigned char mpu401_read(struct snd_emu10k1 *emu,\r\nstruct snd_emu10k1_midi *mpu, int idx)\r\n{\r\nif (emu->audigy)\r\nreturn (unsigned char)snd_emu10k1_ptr_read(emu, mpu->port + idx, 0);\r\nelse\r\nreturn inb(emu->port + mpu->port + idx);\r\n}\r\nstatic inline void mpu401_write(struct snd_emu10k1 *emu,\r\nstruct snd_emu10k1_midi *mpu, int data, int idx)\r\n{\r\nif (emu->audigy)\r\nsnd_emu10k1_ptr_write(emu, mpu->port + idx, 0, data);\r\nelse\r\noutb(data, emu->port + mpu->port + idx);\r\n}\r\nstatic void mpu401_clear_rx(struct snd_emu10k1 *emu, struct snd_emu10k1_midi *mpu)\r\n{\r\nint timeout = 100000;\r\nfor (; timeout > 0 && mpu401_input_avail(emu, mpu); timeout--)\r\nmpu401_read_data(emu, mpu);\r\n#ifdef CONFIG_SND_DEBUG\r\nif (timeout <= 0)\r\nsnd_printk(KERN_ERR "cmd: clear rx timeout (status = 0x%x)\n", mpu401_read_stat(emu, mpu));\r\n#endif\r\n}\r\nstatic void do_emu10k1_midi_interrupt(struct snd_emu10k1 *emu, struct snd_emu10k1_midi *midi, unsigned int status)\r\n{\r\nunsigned char byte;\r\nif (midi->rmidi == NULL) {\r\nsnd_emu10k1_intr_disable(emu, midi->tx_enable | midi->rx_enable);\r\nreturn;\r\n}\r\nspin_lock(&midi->input_lock);\r\nif ((status & midi->ipr_rx) && mpu401_input_avail(emu, midi)) {\r\nif (!(midi->midi_mode & EMU10K1_MIDI_MODE_INPUT)) {\r\nmpu401_clear_rx(emu, midi);\r\n} else {\r\nbyte = mpu401_read_data(emu, midi);\r\nif (midi->substream_input)\r\nsnd_rawmidi_receive(midi->substream_input, &byte, 1);\r\n}\r\n}\r\nspin_unlock(&midi->input_lock);\r\nspin_lock(&midi->output_lock);\r\nif ((status & midi->ipr_tx) && mpu401_output_ready(emu, midi)) {\r\nif (midi->substream_output &&\r\nsnd_rawmidi_transmit(midi->substream_output, &byte, 1) == 1) {\r\nmpu401_write_data(emu, midi, byte);\r\n} else {\r\nsnd_emu10k1_intr_disable(emu, midi->tx_enable);\r\n}\r\n}\r\nspin_unlock(&midi->output_lock);\r\n}\r\nstatic void snd_emu10k1_midi_interrupt(struct snd_emu10k1 *emu, unsigned int status)\r\n{\r\ndo_emu10k1_midi_interrupt(emu, &emu->midi, status);\r\n}\r\nstatic void snd_emu10k1_midi_interrupt2(struct snd_emu10k1 *emu, unsigned int status)\r\n{\r\ndo_emu10k1_midi_interrupt(emu, &emu->midi2, status);\r\n}\r\nstatic int snd_emu10k1_midi_cmd(struct snd_emu10k1 * emu, struct snd_emu10k1_midi *midi, unsigned char cmd, int ack)\r\n{\r\nunsigned long flags;\r\nint timeout, ok;\r\nspin_lock_irqsave(&midi->input_lock, flags);\r\nmpu401_write_data(emu, midi, 0x00);\r\nmpu401_write_cmd(emu, midi, cmd);\r\nif (ack) {\r\nok = 0;\r\ntimeout = 10000;\r\nwhile (!ok && timeout-- > 0) {\r\nif (mpu401_input_avail(emu, midi)) {\r\nif (mpu401_read_data(emu, midi) == MPU401_ACK)\r\nok = 1;\r\n}\r\n}\r\nif (!ok && mpu401_read_data(emu, midi) == MPU401_ACK)\r\nok = 1;\r\n} else {\r\nok = 1;\r\n}\r\nspin_unlock_irqrestore(&midi->input_lock, flags);\r\nif (!ok) {\r\nsnd_printk(KERN_ERR "midi_cmd: 0x%x failed at 0x%lx (status = 0x%x, data = 0x%x)!!!\n",\r\ncmd, emu->port,\r\nmpu401_read_stat(emu, midi),\r\nmpu401_read_data(emu, midi));\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_emu10k1_midi_input_open(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_emu10k1 *emu;\r\nstruct snd_emu10k1_midi *midi = (struct snd_emu10k1_midi *)substream->rmidi->private_data;\r\nunsigned long flags;\r\nemu = midi->emu;\r\nif (snd_BUG_ON(!emu))\r\nreturn -ENXIO;\r\nspin_lock_irqsave(&midi->open_lock, flags);\r\nmidi->midi_mode |= EMU10K1_MIDI_MODE_INPUT;\r\nmidi->substream_input = substream;\r\nif (!(midi->midi_mode & EMU10K1_MIDI_MODE_OUTPUT)) {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\nif (snd_emu10k1_midi_cmd(emu, midi, MPU401_RESET, 1))\r\ngoto error_out;\r\nif (snd_emu10k1_midi_cmd(emu, midi, MPU401_ENTER_UART, 1))\r\ngoto error_out;\r\n} else {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\n}\r\nreturn 0;\r\nerror_out:\r\nreturn -EIO;\r\n}\r\nstatic int snd_emu10k1_midi_output_open(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_emu10k1 *emu;\r\nstruct snd_emu10k1_midi *midi = (struct snd_emu10k1_midi *)substream->rmidi->private_data;\r\nunsigned long flags;\r\nemu = midi->emu;\r\nif (snd_BUG_ON(!emu))\r\nreturn -ENXIO;\r\nspin_lock_irqsave(&midi->open_lock, flags);\r\nmidi->midi_mode |= EMU10K1_MIDI_MODE_OUTPUT;\r\nmidi->substream_output = substream;\r\nif (!(midi->midi_mode & EMU10K1_MIDI_MODE_INPUT)) {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\nif (snd_emu10k1_midi_cmd(emu, midi, MPU401_RESET, 1))\r\ngoto error_out;\r\nif (snd_emu10k1_midi_cmd(emu, midi, MPU401_ENTER_UART, 1))\r\ngoto error_out;\r\n} else {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\n}\r\nreturn 0;\r\nerror_out:\r\nreturn -EIO;\r\n}\r\nstatic int snd_emu10k1_midi_input_close(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_emu10k1 *emu;\r\nstruct snd_emu10k1_midi *midi = (struct snd_emu10k1_midi *)substream->rmidi->private_data;\r\nunsigned long flags;\r\nint err = 0;\r\nemu = midi->emu;\r\nif (snd_BUG_ON(!emu))\r\nreturn -ENXIO;\r\nspin_lock_irqsave(&midi->open_lock, flags);\r\nsnd_emu10k1_intr_disable(emu, midi->rx_enable);\r\nmidi->midi_mode &= ~EMU10K1_MIDI_MODE_INPUT;\r\nmidi->substream_input = NULL;\r\nif (!(midi->midi_mode & EMU10K1_MIDI_MODE_OUTPUT)) {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\nerr = snd_emu10k1_midi_cmd(emu, midi, MPU401_RESET, 0);\r\n} else {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\n}\r\nreturn err;\r\n}\r\nstatic int snd_emu10k1_midi_output_close(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_emu10k1 *emu;\r\nstruct snd_emu10k1_midi *midi = (struct snd_emu10k1_midi *)substream->rmidi->private_data;\r\nunsigned long flags;\r\nint err = 0;\r\nemu = midi->emu;\r\nif (snd_BUG_ON(!emu))\r\nreturn -ENXIO;\r\nspin_lock_irqsave(&midi->open_lock, flags);\r\nsnd_emu10k1_intr_disable(emu, midi->tx_enable);\r\nmidi->midi_mode &= ~EMU10K1_MIDI_MODE_OUTPUT;\r\nmidi->substream_output = NULL;\r\nif (!(midi->midi_mode & EMU10K1_MIDI_MODE_INPUT)) {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\nerr = snd_emu10k1_midi_cmd(emu, midi, MPU401_RESET, 0);\r\n} else {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\n}\r\nreturn err;\r\n}\r\nstatic void snd_emu10k1_midi_input_trigger(struct snd_rawmidi_substream *substream, int up)\r\n{\r\nstruct snd_emu10k1 *emu;\r\nstruct snd_emu10k1_midi *midi = (struct snd_emu10k1_midi *)substream->rmidi->private_data;\r\nemu = midi->emu;\r\nif (snd_BUG_ON(!emu))\r\nreturn;\r\nif (up)\r\nsnd_emu10k1_intr_enable(emu, midi->rx_enable);\r\nelse\r\nsnd_emu10k1_intr_disable(emu, midi->rx_enable);\r\n}\r\nstatic void snd_emu10k1_midi_output_trigger(struct snd_rawmidi_substream *substream, int up)\r\n{\r\nstruct snd_emu10k1 *emu;\r\nstruct snd_emu10k1_midi *midi = (struct snd_emu10k1_midi *)substream->rmidi->private_data;\r\nunsigned long flags;\r\nemu = midi->emu;\r\nif (snd_BUG_ON(!emu))\r\nreturn;\r\nif (up) {\r\nint max = 4;\r\nunsigned char byte;\r\nspin_lock_irqsave(&midi->output_lock, flags);\r\nwhile (max > 0) {\r\nif (mpu401_output_ready(emu, midi)) {\r\nif (!(midi->midi_mode & EMU10K1_MIDI_MODE_OUTPUT) ||\r\nsnd_rawmidi_transmit(substream, &byte, 1) != 1) {\r\nspin_unlock_irqrestore(&midi->output_lock, flags);\r\nreturn;\r\n}\r\nmpu401_write_data(emu, midi, byte);\r\nmax--;\r\n} else {\r\nbreak;\r\n}\r\n}\r\nspin_unlock_irqrestore(&midi->output_lock, flags);\r\nsnd_emu10k1_intr_enable(emu, midi->tx_enable);\r\n} else {\r\nsnd_emu10k1_intr_disable(emu, midi->tx_enable);\r\n}\r\n}\r\nstatic void snd_emu10k1_midi_free(struct snd_rawmidi *rmidi)\r\n{\r\nstruct snd_emu10k1_midi *midi = rmidi->private_data;\r\nmidi->interrupt = NULL;\r\nmidi->rmidi = NULL;\r\n}\r\nstatic int __devinit emu10k1_midi_init(struct snd_emu10k1 *emu, struct snd_emu10k1_midi *midi, int device, char *name)\r\n{\r\nstruct snd_rawmidi *rmidi;\r\nint err;\r\nif ((err = snd_rawmidi_new(emu->card, name, device, 1, 1, &rmidi)) < 0)\r\nreturn err;\r\nmidi->emu = emu;\r\nspin_lock_init(&midi->open_lock);\r\nspin_lock_init(&midi->input_lock);\r\nspin_lock_init(&midi->output_lock);\r\nstrcpy(rmidi->name, name);\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT, &snd_emu10k1_midi_output);\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT, &snd_emu10k1_midi_input);\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_OUTPUT |\r\nSNDRV_RAWMIDI_INFO_INPUT |\r\nSNDRV_RAWMIDI_INFO_DUPLEX;\r\nrmidi->private_data = midi;\r\nrmidi->private_free = snd_emu10k1_midi_free;\r\nmidi->rmidi = rmidi;\r\nreturn 0;\r\n}\r\nint __devinit snd_emu10k1_midi(struct snd_emu10k1 *emu)\r\n{\r\nstruct snd_emu10k1_midi *midi = &emu->midi;\r\nint err;\r\nif ((err = emu10k1_midi_init(emu, midi, 0, "EMU10K1 MPU-401 (UART)")) < 0)\r\nreturn err;\r\nmidi->tx_enable = INTE_MIDITXENABLE;\r\nmidi->rx_enable = INTE_MIDIRXENABLE;\r\nmidi->port = MUDATA;\r\nmidi->ipr_tx = IPR_MIDITRANSBUFEMPTY;\r\nmidi->ipr_rx = IPR_MIDIRECVBUFEMPTY;\r\nmidi->interrupt = snd_emu10k1_midi_interrupt;\r\nreturn 0;\r\n}\r\nint __devinit snd_emu10k1_audigy_midi(struct snd_emu10k1 *emu)\r\n{\r\nstruct snd_emu10k1_midi *midi;\r\nint err;\r\nmidi = &emu->midi;\r\nif ((err = emu10k1_midi_init(emu, midi, 0, "Audigy MPU-401 (UART)")) < 0)\r\nreturn err;\r\nmidi->tx_enable = INTE_MIDITXENABLE;\r\nmidi->rx_enable = INTE_MIDIRXENABLE;\r\nmidi->port = A_MUDATA1;\r\nmidi->ipr_tx = IPR_MIDITRANSBUFEMPTY;\r\nmidi->ipr_rx = IPR_MIDIRECVBUFEMPTY;\r\nmidi->interrupt = snd_emu10k1_midi_interrupt;\r\nmidi = &emu->midi2;\r\nif ((err = emu10k1_midi_init(emu, midi, 1, "Audigy MPU-401 #2")) < 0)\r\nreturn err;\r\nmidi->tx_enable = INTE_A_MIDITXENABLE2;\r\nmidi->rx_enable = INTE_A_MIDIRXENABLE2;\r\nmidi->port = A_MUDATA2;\r\nmidi->ipr_tx = IPR_A_MIDITRANSBUFEMPTY2;\r\nmidi->ipr_rx = IPR_A_MIDIRECVBUFEMPTY2;\r\nmidi->interrupt = snd_emu10k1_midi_interrupt2;\r\nreturn 0;\r\n}

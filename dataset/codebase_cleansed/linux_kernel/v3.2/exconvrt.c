acpi_status\r\nacpi_ex_convert_to_integer(union acpi_operand_object *obj_desc,\r\nunion acpi_operand_object **result_desc, u32 flags)\r\n{\r\nunion acpi_operand_object *return_desc;\r\nu8 *pointer;\r\nu64 result;\r\nu32 i;\r\nu32 count;\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE_PTR(ex_convert_to_integer, obj_desc);\r\nswitch (obj_desc->common.type) {\r\ncase ACPI_TYPE_INTEGER:\r\n*result_desc = obj_desc;\r\nreturn_ACPI_STATUS(AE_OK);\r\ncase ACPI_TYPE_BUFFER:\r\ncase ACPI_TYPE_STRING:\r\npointer = obj_desc->buffer.pointer;\r\ncount = obj_desc->buffer.length;\r\nbreak;\r\ndefault:\r\nreturn_ACPI_STATUS(AE_TYPE);\r\n}\r\nresult = 0;\r\nswitch (obj_desc->common.type) {\r\ncase ACPI_TYPE_STRING:\r\nstatus = acpi_ut_strtoul64((char *)pointer, flags, &result);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nbreak;\r\ncase ACPI_TYPE_BUFFER:\r\nif (!count) {\r\nreturn_ACPI_STATUS(AE_AML_BUFFER_LIMIT);\r\n}\r\nif (count > acpi_gbl_integer_byte_width) {\r\ncount = acpi_gbl_integer_byte_width;\r\n}\r\nfor (i = 0; i < count; i++) {\r\nresult |= (((u64) pointer[i]) << (i * 8));\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn_desc = acpi_ut_create_integer_object(result);\r\nif (!return_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "Converted value: %8.8X%8.8X\n",\r\nACPI_FORMAT_UINT64(result)));\r\nacpi_ex_truncate_for32bit_table(return_desc);\r\n*result_desc = return_desc;\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_ex_convert_to_buffer(union acpi_operand_object *obj_desc,\r\nunion acpi_operand_object **result_desc)\r\n{\r\nunion acpi_operand_object *return_desc;\r\nu8 *new_buf;\r\nACPI_FUNCTION_TRACE_PTR(ex_convert_to_buffer, obj_desc);\r\nswitch (obj_desc->common.type) {\r\ncase ACPI_TYPE_BUFFER:\r\n*result_desc = obj_desc;\r\nreturn_ACPI_STATUS(AE_OK);\r\ncase ACPI_TYPE_INTEGER:\r\nreturn_desc =\r\nacpi_ut_create_buffer_object(acpi_gbl_integer_byte_width);\r\nif (!return_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nnew_buf = return_desc->buffer.pointer;\r\nACPI_MEMCPY(new_buf,\r\n&obj_desc->integer.value,\r\nacpi_gbl_integer_byte_width);\r\nbreak;\r\ncase ACPI_TYPE_STRING:\r\nreturn_desc = acpi_ut_create_buffer_object((acpi_size)\r\nobj_desc->string.\r\nlength + 1);\r\nif (!return_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nnew_buf = return_desc->buffer.pointer;\r\nACPI_STRNCPY((char *)new_buf, (char *)obj_desc->string.pointer,\r\nobj_desc->string.length);\r\nbreak;\r\ndefault:\r\nreturn_ACPI_STATUS(AE_TYPE);\r\n}\r\nreturn_desc->common.flags |= AOPOBJ_DATA_VALID;\r\n*result_desc = return_desc;\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nstatic u32\r\nacpi_ex_convert_to_ascii(u64 integer, u16 base, u8 *string, u8 data_width)\r\n{\r\nu64 digit;\r\nu32 i;\r\nu32 j;\r\nu32 k = 0;\r\nu32 hex_length;\r\nu32 decimal_length;\r\nu32 remainder;\r\nu8 supress_zeros;\r\nACPI_FUNCTION_ENTRY();\r\nswitch (base) {\r\ncase 10:\r\nswitch (data_width) {\r\ncase 1:\r\ndecimal_length = ACPI_MAX8_DECIMAL_DIGITS;\r\nbreak;\r\ncase 4:\r\ndecimal_length = ACPI_MAX32_DECIMAL_DIGITS;\r\nbreak;\r\ncase 8:\r\ndefault:\r\ndecimal_length = ACPI_MAX64_DECIMAL_DIGITS;\r\nbreak;\r\n}\r\nsupress_zeros = TRUE;\r\nremainder = 0;\r\nfor (i = decimal_length; i > 0; i--) {\r\ndigit = integer;\r\nfor (j = 0; j < i; j++) {\r\n(void)acpi_ut_short_divide(digit, 10, &digit,\r\n&remainder);\r\n}\r\nif (remainder != 0) {\r\nsupress_zeros = FALSE;\r\n}\r\nif (!supress_zeros) {\r\nstring[k] = (u8) (ACPI_ASCII_ZERO + remainder);\r\nk++;\r\n}\r\n}\r\nbreak;\r\ncase 16:\r\nhex_length = ACPI_MUL_2(data_width);\r\nfor (i = 0, j = (hex_length - 1); i < hex_length; i++, j--) {\r\nstring[k] =\r\n(u8) acpi_ut_hex_to_ascii_char(integer,\r\nACPI_MUL_4(j));\r\nk++;\r\n}\r\nbreak;\r\ndefault:\r\nreturn (0);\r\n}\r\nif (!k) {\r\nstring[0] = ACPI_ASCII_ZERO;\r\nk = 1;\r\n}\r\nstring[k] = 0;\r\nreturn ((u32) k);\r\n}\r\nacpi_status\r\nacpi_ex_convert_to_string(union acpi_operand_object * obj_desc,\r\nunion acpi_operand_object ** result_desc, u32 type)\r\n{\r\nunion acpi_operand_object *return_desc;\r\nu8 *new_buf;\r\nu32 i;\r\nu32 string_length = 0;\r\nu16 base = 16;\r\nu8 separator = ',';\r\nACPI_FUNCTION_TRACE_PTR(ex_convert_to_string, obj_desc);\r\nswitch (obj_desc->common.type) {\r\ncase ACPI_TYPE_STRING:\r\n*result_desc = obj_desc;\r\nreturn_ACPI_STATUS(AE_OK);\r\ncase ACPI_TYPE_INTEGER:\r\nswitch (type) {\r\ncase ACPI_EXPLICIT_CONVERT_DECIMAL:\r\nstring_length = ACPI_MAX_DECIMAL_DIGITS;\r\nbase = 10;\r\nbreak;\r\ndefault:\r\nstring_length = ACPI_MUL_2(acpi_gbl_integer_byte_width);\r\nbreak;\r\n}\r\nreturn_desc =\r\nacpi_ut_create_string_object((acpi_size) string_length);\r\nif (!return_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nnew_buf = return_desc->buffer.pointer;\r\nstring_length =\r\nacpi_ex_convert_to_ascii(obj_desc->integer.value, base,\r\nnew_buf,\r\nacpi_gbl_integer_byte_width);\r\nreturn_desc->string.length = string_length;\r\nnew_buf[string_length] = 0;\r\nbreak;\r\ncase ACPI_TYPE_BUFFER:\r\nswitch (type) {\r\ncase ACPI_EXPLICIT_CONVERT_DECIMAL:\r\nbase = 10;\r\nfor (i = 0; i < obj_desc->buffer.length; i++) {\r\nif (obj_desc->buffer.pointer[i] >= 100) {\r\nstring_length += 4;\r\n} else if (obj_desc->buffer.pointer[i] >= 10) {\r\nstring_length += 3;\r\n} else {\r\nstring_length += 2;\r\n}\r\n}\r\nbreak;\r\ncase ACPI_IMPLICIT_CONVERT_HEX:\r\nseparator = ' ';\r\nstring_length = (obj_desc->buffer.length * 3);\r\nbreak;\r\ncase ACPI_EXPLICIT_CONVERT_HEX:\r\nstring_length = (obj_desc->buffer.length * 3);\r\nbreak;\r\ndefault:\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nif (string_length) {\r\nstring_length--;\r\n}\r\nreturn_desc = acpi_ut_create_string_object((acpi_size)\r\nstring_length);\r\nif (!return_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nnew_buf = return_desc->buffer.pointer;\r\nfor (i = 0; i < obj_desc->buffer.length; i++) {\r\nnew_buf += acpi_ex_convert_to_ascii((u64) obj_desc->\r\nbuffer.pointer[i],\r\nbase, new_buf, 1);\r\n*new_buf++ = separator;\r\n}\r\nif (obj_desc->buffer.length) {\r\nnew_buf--;\r\n}\r\n*new_buf = 0;\r\nbreak;\r\ndefault:\r\nreturn_ACPI_STATUS(AE_TYPE);\r\n}\r\n*result_desc = return_desc;\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_ex_convert_to_target_type(acpi_object_type destination_type,\r\nunion acpi_operand_object *source_desc,\r\nunion acpi_operand_object **result_desc,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status = AE_OK;\r\nACPI_FUNCTION_TRACE(ex_convert_to_target_type);\r\n*result_desc = source_desc;\r\nswitch (GET_CURRENT_ARG_TYPE(walk_state->op_info->runtime_args)) {\r\ncase ARGI_SIMPLE_TARGET:\r\ncase ARGI_FIXED_TARGET:\r\ncase ARGI_INTEGER_REF:\r\nswitch (destination_type) {\r\ncase ACPI_TYPE_LOCAL_REGION_FIELD:\r\nbreak;\r\ndefault:\r\nif (destination_type != source_desc->common.type) {\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"Explicit operator, will store (%s) over existing type (%s)\n",\r\nacpi_ut_get_object_type_name\r\n(source_desc),\r\nacpi_ut_get_type_name\r\n(destination_type)));\r\nstatus = AE_TYPE;\r\n}\r\n}\r\nbreak;\r\ncase ARGI_TARGETREF:\r\nswitch (destination_type) {\r\ncase ACPI_TYPE_INTEGER:\r\ncase ACPI_TYPE_BUFFER_FIELD:\r\ncase ACPI_TYPE_LOCAL_BANK_FIELD:\r\ncase ACPI_TYPE_LOCAL_INDEX_FIELD:\r\nstatus =\r\nacpi_ex_convert_to_integer(source_desc, result_desc,\r\n16);\r\nbreak;\r\ncase ACPI_TYPE_STRING:\r\nstatus =\r\nacpi_ex_convert_to_string(source_desc, result_desc,\r\nACPI_IMPLICIT_CONVERT_HEX);\r\nbreak;\r\ncase ACPI_TYPE_BUFFER:\r\nstatus =\r\nacpi_ex_convert_to_buffer(source_desc, result_desc);\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Bad destination type during conversion: 0x%X",\r\ndestination_type));\r\nstatus = AE_AML_INTERNAL;\r\nbreak;\r\n}\r\nbreak;\r\ncase ARGI_REFERENCE:\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Unknown Target type ID 0x%X AmlOpcode 0x%X DestType %s",\r\nGET_CURRENT_ARG_TYPE(walk_state->op_info->\r\nruntime_args),\r\nwalk_state->opcode,\r\nacpi_ut_get_type_name(destination_type)));\r\nstatus = AE_AML_INTERNAL;\r\n}\r\nif (status == AE_TYPE) {\r\nstatus = AE_OK;\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}

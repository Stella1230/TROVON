int pwc_decompress(struct pwc_device *pdev, struct pwc_frame_buf *fbuf)\r\n{\r\nint n, line, col, stride;\r\nvoid *yuv, *image;\r\nu16 *src;\r\nu16 *dsty, *dstu, *dstv;\r\nimage = vb2_plane_vaddr(&fbuf->vb, 0);\r\nyuv = fbuf->data + pdev->frame_header_size;\r\nif (pdev->pixfmt != V4L2_PIX_FMT_YUV420)\r\n{\r\nstruct pwc_raw_frame *raw_frame = image;\r\nraw_frame->type = cpu_to_le16(pdev->type);\r\nraw_frame->vbandlength = cpu_to_le16(pdev->vbandlength);\r\nmemcpy(raw_frame->cmd, pdev->cmd_buf, 4);\r\nmemcpy(raw_frame+1, yuv, pdev->frame_size);\r\nvb2_set_plane_payload(&fbuf->vb, 0,\r\npdev->frame_size + sizeof(struct pwc_raw_frame));\r\nreturn 0;\r\n}\r\nvb2_set_plane_payload(&fbuf->vb, 0, pdev->view.size);\r\nif (pdev->vbandlength == 0) {\r\nsrc = (u16 *)yuv;\r\nn = pdev->view.x * pdev->view.y;\r\nstride = pdev->view.x * pdev->offset.y + pdev->offset.x;\r\ndsty = (u16 *)(image + stride);\r\nstride = pdev->view.x * pdev->offset.y / 4 + pdev->offset.x / 2;\r\ndstu = (u16 *)(image + n + stride);\r\ndstv = (u16 *)(image + n + n / 4 + stride);\r\nstride = (pdev->view.x - pdev->image.x) / 2;\r\nfor (line = 0; line < pdev->image.y; line++) {\r\nfor (col = 0; col < pdev->image.x; col += 4) {\r\n*dsty++ = *src++;\r\n*dsty++ = *src++;\r\nif (line & 1)\r\n*dstv++ = *src++;\r\nelse\r\n*dstu++ = *src++;\r\n}\r\ndsty += stride;\r\nif (line & 1)\r\ndstv += (stride >> 1);\r\nelse\r\ndstu += (stride >> 1);\r\n}\r\nreturn 0;\r\n}\r\nif (pdev->vsize == PSZ_VGA && pdev->vframes == 5 && pdev->vsnapshot) {\r\nPWC_ERROR("Mode Bayer is not supported for now\n");\r\nreturn -ENXIO;\r\n}\r\nif (DEVICE_USE_CODEC1(pdev->type)) {\r\nPWC_ERROR("This chipset is not supported for now\n");\r\nreturn -ENXIO;\r\n} else {\r\npwc_dec23_decompress(pdev, yuv, image, PWCX_FLAG_PLANAR);\r\n}\r\nreturn 0;\r\n}

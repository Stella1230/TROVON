static void stinger_process_packet(struct stinger *stinger)\r\n{\r\nstruct input_dev *dev = stinger->dev;\r\nunsigned char *data = stinger->data;\r\nif (!stinger->idx) return;\r\ninput_report_key(dev, BTN_A, ((data[0] & 0x20) >> 5));\r\ninput_report_key(dev, BTN_B, ((data[0] & 0x10) >> 4));\r\ninput_report_key(dev, BTN_C, ((data[0] & 0x08) >> 3));\r\ninput_report_key(dev, BTN_X, ((data[0] & 0x04) >> 2));\r\ninput_report_key(dev, BTN_Y, ((data[3] & 0x20) >> 5));\r\ninput_report_key(dev, BTN_Z, ((data[3] & 0x10) >> 4));\r\ninput_report_key(dev, BTN_TL, ((data[3] & 0x08) >> 3));\r\ninput_report_key(dev, BTN_TR, ((data[3] & 0x04) >> 2));\r\ninput_report_key(dev, BTN_SELECT, ((data[3] & 0x02) >> 1));\r\ninput_report_key(dev, BTN_START, (data[3] & 0x01));\r\ninput_report_abs(dev, ABS_X, (data[1] & 0x3F) - ((data[0] & 0x01) << 6));\r\ninput_report_abs(dev, ABS_Y, ((data[0] & 0x02) << 5) - (data[2] & 0x3F));\r\ninput_sync(dev);\r\nreturn;\r\n}\r\nstatic irqreturn_t stinger_interrupt(struct serio *serio,\r\nunsigned char data, unsigned int flags)\r\n{\r\nstruct stinger *stinger = serio_get_drvdata(serio);\r\nif (stinger->idx < STINGER_MAX_LENGTH)\r\nstinger->data[stinger->idx++] = data;\r\nif (stinger->idx == 4) {\r\nstinger_process_packet(stinger);\r\nstinger->idx = 0;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void stinger_disconnect(struct serio *serio)\r\n{\r\nstruct stinger *stinger = serio_get_drvdata(serio);\r\nserio_close(serio);\r\nserio_set_drvdata(serio, NULL);\r\ninput_unregister_device(stinger->dev);\r\nkfree(stinger);\r\n}\r\nstatic int stinger_connect(struct serio *serio, struct serio_driver *drv)\r\n{\r\nstruct stinger *stinger;\r\nstruct input_dev *input_dev;\r\nint err = -ENOMEM;\r\nstinger = kmalloc(sizeof(struct stinger), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!stinger || !input_dev)\r\ngoto fail1;\r\nstinger->dev = input_dev;\r\nsnprintf(stinger->phys, sizeof(stinger->phys), "%s/serio0", serio->phys);\r\ninput_dev->name = "Gravis Stinger";\r\ninput_dev->phys = stinger->phys;\r\ninput_dev->id.bustype = BUS_RS232;\r\ninput_dev->id.vendor = SERIO_STINGER;\r\ninput_dev->id.product = 0x0001;\r\ninput_dev->id.version = 0x0100;\r\ninput_dev->dev.parent = &serio->dev;\r\ninput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\r\ninput_dev->keybit[BIT_WORD(BTN_A)] = BIT_MASK(BTN_A) | BIT_MASK(BTN_B) |\r\nBIT_MASK(BTN_C) | BIT_MASK(BTN_X) | BIT_MASK(BTN_Y) |\r\nBIT_MASK(BTN_Z) | BIT_MASK(BTN_TL) | BIT_MASK(BTN_TR) |\r\nBIT_MASK(BTN_START) | BIT_MASK(BTN_SELECT);\r\ninput_set_abs_params(input_dev, ABS_X, -64, 64, 0, 4);\r\ninput_set_abs_params(input_dev, ABS_Y, -64, 64, 0, 4);\r\nserio_set_drvdata(serio, stinger);\r\nerr = serio_open(serio, drv);\r\nif (err)\r\ngoto fail2;\r\nerr = input_register_device(stinger->dev);\r\nif (err)\r\ngoto fail3;\r\nreturn 0;\r\nfail3: serio_close(serio);\r\nfail2: serio_set_drvdata(serio, NULL);\r\nfail1: input_free_device(input_dev);\r\nkfree(stinger);\r\nreturn err;\r\n}\r\nstatic int __init stinger_init(void)\r\n{\r\nreturn serio_register_driver(&stinger_drv);\r\n}\r\nstatic void __exit stinger_exit(void)\r\n{\r\nserio_unregister_driver(&stinger_drv);\r\n}

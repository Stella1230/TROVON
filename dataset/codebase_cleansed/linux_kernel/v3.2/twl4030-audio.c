static int twl4030_audio_set_resource(enum twl4030_audio_res id, int enable)\r\n{\r\nstruct twl4030_audio *audio = platform_get_drvdata(twl4030_audio_dev);\r\nu8 val;\r\ntwl_i2c_read_u8(TWL4030_MODULE_AUDIO_VOICE, &val,\r\naudio->resource[id].reg);\r\nif (enable)\r\nval |= audio->resource[id].mask;\r\nelse\r\nval &= ~audio->resource[id].mask;\r\ntwl_i2c_write_u8(TWL4030_MODULE_AUDIO_VOICE,\r\nval, audio->resource[id].reg);\r\nreturn val;\r\n}\r\nstatic inline int twl4030_audio_get_resource(enum twl4030_audio_res id)\r\n{\r\nstruct twl4030_audio *audio = platform_get_drvdata(twl4030_audio_dev);\r\nu8 val;\r\ntwl_i2c_read_u8(TWL4030_MODULE_AUDIO_VOICE, &val,\r\naudio->resource[id].reg);\r\nreturn val;\r\n}\r\nint twl4030_audio_enable_resource(enum twl4030_audio_res id)\r\n{\r\nstruct twl4030_audio *audio = platform_get_drvdata(twl4030_audio_dev);\r\nint val;\r\nif (id >= TWL4030_AUDIO_RES_MAX) {\r\ndev_err(&twl4030_audio_dev->dev,\r\n"Invalid resource ID (%u)\n", id);\r\nreturn -EINVAL;\r\n}\r\nmutex_lock(&audio->mutex);\r\nif (!audio->resource[id].request_count)\r\nval = twl4030_audio_set_resource(id, 1);\r\nelse\r\nval = twl4030_audio_get_resource(id);\r\naudio->resource[id].request_count++;\r\nmutex_unlock(&audio->mutex);\r\nreturn val;\r\n}\r\nint twl4030_audio_disable_resource(unsigned id)\r\n{\r\nstruct twl4030_audio *audio = platform_get_drvdata(twl4030_audio_dev);\r\nint val;\r\nif (id >= TWL4030_AUDIO_RES_MAX) {\r\ndev_err(&twl4030_audio_dev->dev,\r\n"Invalid resource ID (%u)\n", id);\r\nreturn -EINVAL;\r\n}\r\nmutex_lock(&audio->mutex);\r\nif (!audio->resource[id].request_count) {\r\ndev_err(&twl4030_audio_dev->dev,\r\n"Resource has been disabled already (%u)\n", id);\r\nmutex_unlock(&audio->mutex);\r\nreturn -EPERM;\r\n}\r\naudio->resource[id].request_count--;\r\nif (!audio->resource[id].request_count)\r\nval = twl4030_audio_set_resource(id, 0);\r\nelse\r\nval = twl4030_audio_get_resource(id);\r\nmutex_unlock(&audio->mutex);\r\nreturn val;\r\n}\r\nunsigned int twl4030_audio_get_mclk(void)\r\n{\r\nstruct twl4030_audio *audio = platform_get_drvdata(twl4030_audio_dev);\r\nreturn audio->audio_mclk;\r\n}\r\nstatic int __devinit twl4030_audio_probe(struct platform_device *pdev)\r\n{\r\nstruct twl4030_audio *audio;\r\nstruct twl4030_audio_data *pdata = pdev->dev.platform_data;\r\nstruct mfd_cell *cell = NULL;\r\nint ret, childs = 0;\r\nu8 val;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "Platform data is missing\n");\r\nreturn -EINVAL;\r\n}\r\nval = 0;\r\nswitch (pdata->audio_mclk) {\r\ncase 19200000:\r\nval |= TWL4030_APLL_INFREQ_19200KHZ;\r\nbreak;\r\ncase 26000000:\r\nval |= TWL4030_APLL_INFREQ_26000KHZ;\r\nbreak;\r\ncase 38400000:\r\nval |= TWL4030_APLL_INFREQ_38400KHZ;\r\nbreak;\r\ndefault:\r\ndev_err(&pdev->dev, "Invalid audio_mclk\n");\r\nreturn -EINVAL;\r\n}\r\ntwl_i2c_write_u8(TWL4030_MODULE_AUDIO_VOICE,\r\nval, TWL4030_REG_APLL_CTL);\r\naudio = kzalloc(sizeof(struct twl4030_audio), GFP_KERNEL);\r\nif (!audio)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, audio);\r\ntwl4030_audio_dev = pdev;\r\nmutex_init(&audio->mutex);\r\naudio->audio_mclk = pdata->audio_mclk;\r\naudio->resource[TWL4030_AUDIO_RES_POWER].reg = TWL4030_REG_CODEC_MODE;\r\naudio->resource[TWL4030_AUDIO_RES_POWER].mask = TWL4030_CODECPDZ;\r\naudio->resource[TWL4030_AUDIO_RES_APLL].reg = TWL4030_REG_APLL_CTL;\r\naudio->resource[TWL4030_AUDIO_RES_APLL].mask = TWL4030_APLL_EN;\r\nif (pdata->codec) {\r\ncell = &audio->cells[childs];\r\ncell->name = "twl4030-codec";\r\ncell->platform_data = pdata->codec;\r\ncell->pdata_size = sizeof(*pdata->codec);\r\nchilds++;\r\n}\r\nif (pdata->vibra) {\r\ncell = &audio->cells[childs];\r\ncell->name = "twl4030-vibra";\r\ncell->platform_data = pdata->vibra;\r\ncell->pdata_size = sizeof(*pdata->vibra);\r\nchilds++;\r\n}\r\nif (childs)\r\nret = mfd_add_devices(&pdev->dev, pdev->id, audio->cells,\r\nchilds, NULL, 0);\r\nelse {\r\ndev_err(&pdev->dev, "No platform data found for childs\n");\r\nret = -ENODEV;\r\n}\r\nif (!ret)\r\nreturn 0;\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(audio);\r\ntwl4030_audio_dev = NULL;\r\nreturn ret;\r\n}\r\nstatic int __devexit twl4030_audio_remove(struct platform_device *pdev)\r\n{\r\nstruct twl4030_audio *audio = platform_get_drvdata(pdev);\r\nmfd_remove_devices(&pdev->dev);\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(audio);\r\ntwl4030_audio_dev = NULL;\r\nreturn 0;\r\n}\r\nstatic int __devinit twl4030_audio_init(void)\r\n{\r\nreturn platform_driver_register(&twl4030_audio_driver);\r\n}\r\nstatic void __devexit twl4030_audio_exit(void)\r\n{\r\nplatform_driver_unregister(&twl4030_audio_driver);\r\n}

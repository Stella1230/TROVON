static int olpc_ac_get_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nint ret = 0;\r\nuint8_t status;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nret = olpc_ec_cmd(EC_BAT_STATUS, NULL, 0, &status, 1);\r\nif (ret)\r\nreturn ret;\r\nval->intval = !!(status & BAT_STAT_AC);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int olpc_bat_get_status(union power_supply_propval *val, uint8_t ec_byte)\r\n{\r\nif (olpc_platform_info.ecver > 0x44) {\r\nif (ec_byte & (BAT_STAT_CHARGING | BAT_STAT_TRICKLE))\r\nval->intval = POWER_SUPPLY_STATUS_CHARGING;\r\nelse if (ec_byte & BAT_STAT_DISCHARGING)\r\nval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\r\nelse if (ec_byte & BAT_STAT_FULL)\r\nval->intval = POWER_SUPPLY_STATUS_FULL;\r\nelse\r\nval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\n} else {\r\nif (!(ec_byte & BAT_STAT_AC))\r\nval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\r\nelse if (ec_byte & BAT_STAT_FULL)\r\nval->intval = POWER_SUPPLY_STATUS_FULL;\r\nelse\r\nval->intval = POWER_SUPPLY_STATUS_CHARGING;\r\n}\r\nreturn 0;\r\n}\r\nstatic int olpc_bat_get_health(union power_supply_propval *val)\r\n{\r\nuint8_t ec_byte;\r\nint ret;\r\nret = olpc_ec_cmd(EC_BAT_ERRCODE, NULL, 0, &ec_byte, 1);\r\nif (ret)\r\nreturn ret;\r\nswitch (ec_byte) {\r\ncase 0:\r\nval->intval = POWER_SUPPLY_HEALTH_GOOD;\r\nbreak;\r\ncase BAT_ERR_OVERTEMP:\r\nval->intval = POWER_SUPPLY_HEALTH_OVERHEAT;\r\nbreak;\r\ncase BAT_ERR_OVERVOLTAGE:\r\nval->intval = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\r\nbreak;\r\ncase BAT_ERR_INFOFAIL:\r\ncase BAT_ERR_OUT_OF_CONTROL:\r\ncase BAT_ERR_ID_FAIL:\r\ncase BAT_ERR_ACR_FAIL:\r\nval->intval = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\r\nbreak;\r\ndefault:\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic int olpc_bat_get_mfr(union power_supply_propval *val)\r\n{\r\nuint8_t ec_byte;\r\nint ret;\r\nec_byte = BAT_ADDR_MFR_TYPE;\r\nret = olpc_ec_cmd(EC_BAT_EEPROM, &ec_byte, 1, &ec_byte, 1);\r\nif (ret)\r\nreturn ret;\r\nswitch (ec_byte >> 4) {\r\ncase 1:\r\nval->strval = "Gold Peak";\r\nbreak;\r\ncase 2:\r\nval->strval = "BYD";\r\nbreak;\r\ndefault:\r\nval->strval = "Unknown";\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int olpc_bat_get_tech(union power_supply_propval *val)\r\n{\r\nuint8_t ec_byte;\r\nint ret;\r\nec_byte = BAT_ADDR_MFR_TYPE;\r\nret = olpc_ec_cmd(EC_BAT_EEPROM, &ec_byte, 1, &ec_byte, 1);\r\nif (ret)\r\nreturn ret;\r\nswitch (ec_byte & 0xf) {\r\ncase 1:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_NiMH;\r\nbreak;\r\ncase 2:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_LiFe;\r\nbreak;\r\ndefault:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_UNKNOWN;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int olpc_bat_get_charge_full_design(union power_supply_propval *val)\r\n{\r\nuint8_t ec_byte;\r\nunion power_supply_propval tech;\r\nint ret, mfr;\r\nret = olpc_bat_get_tech(&tech);\r\nif (ret)\r\nreturn ret;\r\nec_byte = BAT_ADDR_MFR_TYPE;\r\nret = olpc_ec_cmd(EC_BAT_EEPROM, &ec_byte, 1, &ec_byte, 1);\r\nif (ret)\r\nreturn ret;\r\nmfr = ec_byte >> 4;\r\nswitch (tech.intval) {\r\ncase POWER_SUPPLY_TECHNOLOGY_NiMH:\r\nswitch (mfr) {\r\ncase 1:\r\nval->intval = 3000000*.8;\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\nbreak;\r\ncase POWER_SUPPLY_TECHNOLOGY_LiFe:\r\nswitch (mfr) {\r\ncase 1:\r\nval->intval = 2800000;\r\nbreak;\r\ncase 2:\r\nval->intval = 3100000;\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic int olpc_bat_get_charge_now(union power_supply_propval *val)\r\n{\r\nuint8_t soc;\r\nunion power_supply_propval full;\r\nint ret;\r\nret = olpc_ec_cmd(EC_BAT_SOC, NULL, 0, &soc, 1);\r\nif (ret)\r\nreturn ret;\r\nret = olpc_bat_get_charge_full_design(&full);\r\nif (ret)\r\nreturn ret;\r\nval->intval = soc * (full.intval / 100);\r\nreturn 0;\r\n}\r\nstatic int olpc_bat_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nint ret = 0;\r\n__be16 ec_word;\r\nuint8_t ec_byte;\r\n__be64 ser_buf;\r\nret = olpc_ec_cmd(EC_BAT_STATUS, NULL, 0, &ec_byte, 1);\r\nif (ret)\r\nreturn ret;\r\nif (!(ec_byte & (BAT_STAT_PRESENT | BAT_STAT_TRICKLE)) &&\r\npsp != POWER_SUPPLY_PROP_PRESENT)\r\nreturn -ENODEV;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nret = olpc_bat_get_status(val, ec_byte);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_TYPE:\r\nif (ec_byte & BAT_STAT_TRICKLE)\r\nval->intval = POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\r\nelse if (ec_byte & BAT_STAT_CHARGING)\r\nval->intval = POWER_SUPPLY_CHARGE_TYPE_FAST;\r\nelse\r\nval->intval = POWER_SUPPLY_CHARGE_TYPE_NONE;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = !!(ec_byte & (BAT_STAT_PRESENT |\r\nBAT_STAT_TRICKLE));\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nif (ec_byte & BAT_STAT_DESTROY)\r\nval->intval = POWER_SUPPLY_HEALTH_DEAD;\r\nelse {\r\nret = olpc_bat_get_health(val);\r\nif (ret)\r\nreturn ret;\r\n}\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MANUFACTURER:\r\nret = olpc_bat_get_mfr(val);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nret = olpc_bat_get_tech(val);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_AVG:\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nret = olpc_ec_cmd(EC_BAT_VOLTAGE, NULL, 0, (void *)&ec_word, 2);\r\nif (ret)\r\nreturn ret;\r\nval->intval = (s16)be16_to_cpu(ec_word) * 9760L / 32;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_AVG:\r\ncase POWER_SUPPLY_PROP_CURRENT_NOW:\r\nret = olpc_ec_cmd(EC_BAT_CURRENT, NULL, 0, (void *)&ec_word, 2);\r\nif (ret)\r\nreturn ret;\r\nval->intval = (s16)be16_to_cpu(ec_word) * 15625L / 120;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CAPACITY:\r\nret = olpc_ec_cmd(EC_BAT_SOC, NULL, 0, &ec_byte, 1);\r\nif (ret)\r\nreturn ret;\r\nval->intval = ec_byte;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CAPACITY_LEVEL:\r\nif (ec_byte & BAT_STAT_FULL)\r\nval->intval = POWER_SUPPLY_CAPACITY_LEVEL_FULL;\r\nelse if (ec_byte & BAT_STAT_LOW)\r\nval->intval = POWER_SUPPLY_CAPACITY_LEVEL_LOW;\r\nelse\r\nval->intval = POWER_SUPPLY_CAPACITY_LEVEL_NORMAL;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN:\r\nret = olpc_bat_get_charge_full_design(val);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_NOW:\r\nret = olpc_bat_get_charge_now(val);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP:\r\nret = olpc_ec_cmd(EC_BAT_TEMP, NULL, 0, (void *)&ec_word, 2);\r\nif (ret)\r\nreturn ret;\r\nval->intval = (s16)be16_to_cpu(ec_word) * 100 / 256;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP_AMBIENT:\r\nret = olpc_ec_cmd(EC_AMB_TEMP, NULL, 0, (void *)&ec_word, 2);\r\nif (ret)\r\nreturn ret;\r\nval->intval = (int)be16_to_cpu(ec_word) * 100 / 256;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_COUNTER:\r\nret = olpc_ec_cmd(EC_BAT_ACR, NULL, 0, (void *)&ec_word, 2);\r\nif (ret)\r\nreturn ret;\r\nval->intval = (s16)be16_to_cpu(ec_word) * 6250 / 15;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_SERIAL_NUMBER:\r\nret = olpc_ec_cmd(EC_BAT_SERIAL, NULL, 0, (void *)&ser_buf, 8);\r\nif (ret)\r\nreturn ret;\r\nsprintf(bat_serial, "%016llx", (long long)be64_to_cpu(ser_buf));\r\nval->strval = bat_serial;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic ssize_t olpc_bat_eeprom_read(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *attr, char *buf, loff_t off, size_t count)\r\n{\r\nuint8_t ec_byte;\r\nint ret;\r\nint i;\r\nif (off >= EEPROM_SIZE)\r\nreturn 0;\r\nif (off + count > EEPROM_SIZE)\r\ncount = EEPROM_SIZE - off;\r\nfor (i = 0; i < count; i++) {\r\nec_byte = EEPROM_START + off + i;\r\nret = olpc_ec_cmd(EC_BAT_EEPROM, &ec_byte, 1, &buf[i], 1);\r\nif (ret) {\r\npr_err("olpc-battery: "\r\n"EC_BAT_EEPROM cmd @ 0x%x failed - %d!\n",\r\nec_byte, ret);\r\nreturn -EIO;\r\n}\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t olpc_bat_error_read(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nuint8_t ec_byte;\r\nssize_t ret;\r\nret = olpc_ec_cmd(EC_BAT_ERRCODE, NULL, 0, &ec_byte, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", ec_byte);\r\n}\r\nvoid olpc_battery_trigger_uevent(unsigned long cause)\r\n{\r\nif (cause & EC_SCI_SRC_ACPWR)\r\nkobject_uevent(&olpc_ac.dev->kobj, KOBJ_CHANGE);\r\nif (cause & (EC_SCI_SRC_BATERR|EC_SCI_SRC_BATSOC|EC_SCI_SRC_BATTERY))\r\nkobject_uevent(&olpc_bat.dev->kobj, KOBJ_CHANGE);\r\n}\r\nstatic int __init olpc_bat_init(void)\r\n{\r\nint ret = 0;\r\nuint8_t status;\r\nif (!olpc_platform_info.ecver)\r\nreturn -ENXIO;\r\nif (olpc_platform_info.ecver < 0x44) {\r\nprintk(KERN_NOTICE "OLPC EC version 0x%02x too old for "\r\n"battery driver.\n", olpc_platform_info.ecver);\r\nreturn -ENXIO;\r\n}\r\nret = olpc_ec_cmd(EC_BAT_STATUS, NULL, 0, &status, 1);\r\nif (ret)\r\nreturn ret;\r\nbat_pdev = platform_device_register_simple("olpc-battery", 0, NULL, 0);\r\nif (IS_ERR(bat_pdev))\r\nreturn PTR_ERR(bat_pdev);\r\nret = power_supply_register(&bat_pdev->dev, &olpc_ac);\r\nif (ret)\r\ngoto ac_failed;\r\nolpc_bat.name = bat_pdev->name;\r\nif (olpc_board_at_least(olpc_board_pre(0xd0))) {\r\nolpc_bat.properties = olpc_xo15_bat_props;\r\nolpc_bat.num_properties = ARRAY_SIZE(olpc_xo15_bat_props);\r\n} else {\r\nolpc_bat.properties = olpc_xo1_bat_props;\r\nolpc_bat.num_properties = ARRAY_SIZE(olpc_xo1_bat_props);\r\n}\r\nret = power_supply_register(&bat_pdev->dev, &olpc_bat);\r\nif (ret)\r\ngoto battery_failed;\r\nret = device_create_bin_file(olpc_bat.dev, &olpc_bat_eeprom);\r\nif (ret)\r\ngoto eeprom_failed;\r\nret = device_create_file(olpc_bat.dev, &olpc_bat_error);\r\nif (ret)\r\ngoto error_failed;\r\ngoto success;\r\nerror_failed:\r\ndevice_remove_bin_file(olpc_bat.dev, &olpc_bat_eeprom);\r\neeprom_failed:\r\npower_supply_unregister(&olpc_bat);\r\nbattery_failed:\r\npower_supply_unregister(&olpc_ac);\r\nac_failed:\r\nplatform_device_unregister(bat_pdev);\r\nsuccess:\r\nreturn ret;\r\n}\r\nstatic void __exit olpc_bat_exit(void)\r\n{\r\ndevice_remove_file(olpc_bat.dev, &olpc_bat_error);\r\ndevice_remove_bin_file(olpc_bat.dev, &olpc_bat_eeprom);\r\npower_supply_unregister(&olpc_bat);\r\npower_supply_unregister(&olpc_ac);\r\nplatform_device_unregister(bat_pdev);\r\n}

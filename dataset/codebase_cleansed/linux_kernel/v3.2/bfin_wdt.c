static int bfin_wdt_keepalive(void)\r\n{\r\nstampit();\r\nbfin_write_WDOG_STAT(0);\r\nreturn 0;\r\n}\r\nstatic int bfin_wdt_stop(void)\r\n{\r\nstampit();\r\nbfin_write_WDOG_CTL(WDEN_DISABLE);\r\nreturn 0;\r\n}\r\nstatic int bfin_wdt_start(void)\r\n{\r\nstampit();\r\nbfin_write_WDOG_CTL(WDEN_ENABLE | ICTL_RESET);\r\nreturn 0;\r\n}\r\nstatic int bfin_wdt_running(void)\r\n{\r\nstampit();\r\nreturn ((bfin_read_WDOG_CTL() & WDEN_MASK) != WDEN_DISABLE);\r\n}\r\nstatic int bfin_wdt_set_timeout(unsigned long t)\r\n{\r\nu32 cnt, max_t, sclk;\r\nunsigned long flags;\r\nsclk = get_sclk();\r\nmax_t = -1 / sclk;\r\ncnt = t * sclk;\r\nstamp("maxtimeout=%us newtimeout=%lus (cnt=%#x)", max_t, t, cnt);\r\nif (t > max_t) {\r\nprintk(KERN_WARNING PFX "timeout value is too large\n");\r\nreturn -EINVAL;\r\n}\r\nspin_lock_irqsave(&bfin_wdt_spinlock, flags);\r\n{\r\nint run = bfin_wdt_running();\r\nbfin_wdt_stop();\r\nbfin_write_WDOG_CNT(cnt);\r\nif (run)\r\nbfin_wdt_start();\r\n}\r\nspin_unlock_irqrestore(&bfin_wdt_spinlock, flags);\r\ntimeout = t;\r\nreturn 0;\r\n}\r\nstatic int bfin_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nstampit();\r\nif (test_and_set_bit(0, &open_check))\r\nreturn -EBUSY;\r\nif (nowayout)\r\n__module_get(THIS_MODULE);\r\nbfin_wdt_keepalive();\r\nbfin_wdt_start();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int bfin_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nstampit();\r\nif (expect_close == 42)\r\nbfin_wdt_stop();\r\nelse {\r\nprintk(KERN_CRIT PFX\r\n"Unexpected close, not stopping watchdog!\n");\r\nbfin_wdt_keepalive();\r\n}\r\nexpect_close = 0;\r\nclear_bit(0, &open_check);\r\nreturn 0;\r\n}\r\nstatic ssize_t bfin_wdt_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nstampit();\r\nif (len) {\r\nif (!nowayout) {\r\nsize_t i;\r\nexpect_close = 0;\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nexpect_close = 42;\r\n}\r\n}\r\nbfin_wdt_keepalive();\r\n}\r\nreturn len;\r\n}\r\nstatic long bfin_wdt_ioctl(struct file *file,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nstampit();\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nif (copy_to_user(argp, &bfin_wdt_info, sizeof(bfin_wdt_info)))\r\nreturn -EFAULT;\r\nelse\r\nreturn 0;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(!!(_bfin_swrst & SWRST_RESET_WDOG), p);\r\ncase WDIOC_SETOPTIONS: {\r\nunsigned long flags;\r\nint options, ret = -EINVAL;\r\nif (get_user(options, p))\r\nreturn -EFAULT;\r\nspin_lock_irqsave(&bfin_wdt_spinlock, flags);\r\nif (options & WDIOS_DISABLECARD) {\r\nbfin_wdt_stop();\r\nret = 0;\r\n}\r\nif (options & WDIOS_ENABLECARD) {\r\nbfin_wdt_start();\r\nret = 0;\r\n}\r\nspin_unlock_irqrestore(&bfin_wdt_spinlock, flags);\r\nreturn ret;\r\n}\r\ncase WDIOC_KEEPALIVE:\r\nbfin_wdt_keepalive();\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT: {\r\nint new_timeout;\r\nif (get_user(new_timeout, p))\r\nreturn -EFAULT;\r\nif (bfin_wdt_set_timeout(new_timeout))\r\nreturn -EINVAL;\r\n}\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(timeout, p);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\n}\r\nstatic int bfin_wdt_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nstampit();\r\nstate_before_suspend = bfin_wdt_running();\r\nbfin_wdt_stop();\r\nreturn 0;\r\n}\r\nstatic int bfin_wdt_resume(struct platform_device *pdev)\r\n{\r\nstampit();\r\nif (state_before_suspend) {\r\nbfin_wdt_set_timeout(timeout);\r\nbfin_wdt_start();\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit bfin_wdt_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nret = misc_register(&bfin_wdt_miscdev);\r\nif (ret) {\r\npr_devinit(KERN_ERR PFX\r\n"cannot register miscdev on minor=%d (err=%d)\n",\r\nWATCHDOG_MINOR, ret);\r\nreturn ret;\r\n}\r\npr_devinit(KERN_INFO PFX "initialized: timeout=%d sec (nowayout=%d)\n",\r\ntimeout, nowayout);\r\nreturn 0;\r\n}\r\nstatic int __devexit bfin_wdt_remove(struct platform_device *pdev)\r\n{\r\nmisc_deregister(&bfin_wdt_miscdev);\r\nreturn 0;\r\n}\r\nstatic void bfin_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nstampit();\r\nbfin_wdt_stop();\r\n}\r\nstatic int __init bfin_wdt_init(void)\r\n{\r\nint ret;\r\nstampit();\r\nif (bfin_wdt_set_timeout(timeout))\r\nreturn -EINVAL;\r\nret = platform_driver_register(&bfin_wdt_driver);\r\nif (ret) {\r\npr_init(KERN_ERR PFX "unable to register driver\n");\r\nreturn ret;\r\n}\r\nbfin_wdt_device = platform_device_register_simple(WATCHDOG_NAME,\r\n-1, NULL, 0);\r\nif (IS_ERR(bfin_wdt_device)) {\r\npr_init(KERN_ERR PFX "unable to register device\n");\r\nplatform_driver_unregister(&bfin_wdt_driver);\r\nreturn PTR_ERR(bfin_wdt_device);\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit bfin_wdt_exit(void)\r\n{\r\nplatform_device_unregister(bfin_wdt_device);\r\nplatform_driver_unregister(&bfin_wdt_driver);\r\n}

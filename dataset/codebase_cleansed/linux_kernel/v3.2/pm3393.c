static int pmread(struct cmac *cmac, u32 reg, u32 * data32)\r\n{\r\nt1_tpi_read(cmac->adapter, OFFSET(reg), data32);\r\nreturn 0;\r\n}\r\nstatic int pmwrite(struct cmac *cmac, u32 reg, u32 data32)\r\n{\r\nt1_tpi_write(cmac->adapter, OFFSET(reg), data32);\r\nreturn 0;\r\n}\r\nstatic int pm3393_reset(struct cmac *cmac)\r\n{\r\nreturn 0;\r\n}\r\nstatic int pm3393_interrupt_enable(struct cmac *cmac)\r\n{\r\nu32 pl_intr;\r\npmwrite(cmac, SUNI1x10GEXP_REG_SERDES_3125_INTERRUPT_ENABLE, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_XRF_INTERRUPT_ENABLE, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_XRF_DIAG_INTERRUPT_ENABLE, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXOAM_INTERRUPT_ENABLE, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_0, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_1, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_2, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_3, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_IFLX_FIFO_OVERFLOW_ENABLE, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_PL4ODP_INTERRUPT_MASK, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_XTEF_INTERRUPT_ENABLE, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_TXOAM_INTERRUPT_ENABLE, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_CONFIG_3, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_PL4IO_LOCK_DETECT_MASK, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_TXXG_CONFIG_3, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_PL4IDU_INTERRUPT_MASK, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_EFLX_FIFO_OVERFLOW_ERROR_ENABLE, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_GLOBAL_INTERRUPT_ENABLE,\r\n0 );\r\npl_intr = readl(cmac->adapter->regs + A_PL_ENABLE);\r\npl_intr |= F_PL_INTR_EXT;\r\nwritel(pl_intr, cmac->adapter->regs + A_PL_ENABLE);\r\nreturn 0;\r\n}\r\nstatic int pm3393_interrupt_disable(struct cmac *cmac)\r\n{\r\nu32 elmer;\r\npmwrite(cmac, SUNI1x10GEXP_REG_SERDES_3125_INTERRUPT_ENABLE, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_XRF_INTERRUPT_ENABLE, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_XRF_DIAG_INTERRUPT_ENABLE, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXOAM_INTERRUPT_ENABLE, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_0, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_1, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_2, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_3, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_IFLX_FIFO_OVERFLOW_ENABLE, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_PL4ODP_INTERRUPT_MASK, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_XTEF_INTERRUPT_ENABLE, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_TXOAM_INTERRUPT_ENABLE, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_CONFIG_3, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_PL4IO_LOCK_DETECT_MASK, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_TXXG_CONFIG_3, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_PL4IDU_INTERRUPT_MASK, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_EFLX_FIFO_OVERFLOW_ERROR_ENABLE, 0);\r\npmwrite(cmac, SUNI1x10GEXP_REG_GLOBAL_INTERRUPT_ENABLE, 0);\r\nt1_tpi_read(cmac->adapter, A_ELMER0_INT_ENABLE, &elmer);\r\nelmer &= ~ELMER0_GP_BIT1;\r\nt1_tpi_write(cmac->adapter, A_ELMER0_INT_ENABLE, elmer);\r\nreturn 0;\r\n}\r\nstatic int pm3393_interrupt_clear(struct cmac *cmac)\r\n{\r\nu32 elmer;\r\nu32 pl_intr;\r\nu32 val32;\r\npmread(cmac, SUNI1x10GEXP_REG_SERDES_3125_INTERRUPT_STATUS, &val32);\r\npmread(cmac, SUNI1x10GEXP_REG_XRF_INTERRUPT_STATUS, &val32);\r\npmread(cmac, SUNI1x10GEXP_REG_XRF_DIAG_INTERRUPT_STATUS, &val32);\r\npmread(cmac, SUNI1x10GEXP_REG_RXOAM_INTERRUPT_STATUS, &val32);\r\npmread(cmac, SUNI1x10GEXP_REG_PL4ODP_INTERRUPT, &val32);\r\npmread(cmac, SUNI1x10GEXP_REG_XTEF_INTERRUPT_STATUS, &val32);\r\npmread(cmac, SUNI1x10GEXP_REG_IFLX_FIFO_OVERFLOW_INTERRUPT, &val32);\r\npmread(cmac, SUNI1x10GEXP_REG_TXOAM_INTERRUPT_STATUS, &val32);\r\npmread(cmac, SUNI1x10GEXP_REG_RXXG_INTERRUPT, &val32);\r\npmread(cmac, SUNI1x10GEXP_REG_TXXG_INTERRUPT, &val32);\r\npmread(cmac, SUNI1x10GEXP_REG_PL4IDU_INTERRUPT, &val32);\r\npmread(cmac, SUNI1x10GEXP_REG_EFLX_FIFO_OVERFLOW_ERROR_INDICATION,\r\n&val32);\r\npmread(cmac, SUNI1x10GEXP_REG_PL4IO_LOCK_DETECT_STATUS, &val32);\r\npmread(cmac, SUNI1x10GEXP_REG_PL4IO_LOCK_DETECT_CHANGE, &val32);\r\npmread(cmac, SUNI1x10GEXP_REG_MASTER_INTERRUPT_STATUS, &val32);\r\nt1_tpi_read(cmac->adapter, A_ELMER0_INT_CAUSE, &elmer);\r\nelmer |= ELMER0_GP_BIT1;\r\nt1_tpi_write(cmac->adapter, A_ELMER0_INT_CAUSE, elmer);\r\npl_intr = readl(cmac->adapter->regs + A_PL_CAUSE);\r\npl_intr |= F_PL_INTR_EXT;\r\nwritel(pl_intr, cmac->adapter->regs + A_PL_CAUSE);\r\nreturn 0;\r\n}\r\nstatic int pm3393_interrupt_handler(struct cmac *cmac)\r\n{\r\nu32 master_intr_status;\r\npmread(cmac, SUNI1x10GEXP_REG_MASTER_INTERRUPT_STATUS,\r\n&master_intr_status);\r\nif (netif_msg_intr(cmac->adapter))\r\ndev_dbg(&cmac->adapter->pdev->dev, "PM3393 intr cause 0x%x\n",\r\nmaster_intr_status);\r\npm3393_interrupt_clear(cmac);\r\nreturn 0;\r\n}\r\nstatic int pm3393_enable(struct cmac *cmac, int which)\r\n{\r\nif (which & MAC_DIRECTION_RX)\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_CONFIG_1,\r\n(RXXG_CONF1_VAL | SUNI1x10GEXP_BITMSK_RXXG_RXEN));\r\nif (which & MAC_DIRECTION_TX) {\r\nu32 val = TXXG_CONF1_VAL | SUNI1x10GEXP_BITMSK_TXXG_TXEN0;\r\nif (cmac->instance->fc & PAUSE_RX)\r\nval |= SUNI1x10GEXP_BITMSK_TXXG_FCRX;\r\nif (cmac->instance->fc & PAUSE_TX)\r\nval |= SUNI1x10GEXP_BITMSK_TXXG_FCTX;\r\npmwrite(cmac, SUNI1x10GEXP_REG_TXXG_CONFIG_1, val);\r\n}\r\ncmac->instance->enabled |= which;\r\nreturn 0;\r\n}\r\nstatic int pm3393_enable_port(struct cmac *cmac, int which)\r\n{\r\npmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_CONTROL,\r\nSUNI1x10GEXP_BITMSK_MSTAT_CLEAR);\r\nudelay(2);\r\nmemset(&cmac->stats, 0, sizeof(struct cmac_statistics));\r\npm3393_enable(cmac, which);\r\nt1_link_changed(cmac->adapter, 0);\r\nreturn 0;\r\n}\r\nstatic int pm3393_disable(struct cmac *cmac, int which)\r\n{\r\nif (which & MAC_DIRECTION_RX)\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_CONFIG_1, RXXG_CONF1_VAL);\r\nif (which & MAC_DIRECTION_TX)\r\npmwrite(cmac, SUNI1x10GEXP_REG_TXXG_CONFIG_1, TXXG_CONF1_VAL);\r\nudelay(20);\r\ncmac->instance->enabled &= ~which;\r\nreturn 0;\r\n}\r\nstatic int pm3393_loopback_enable(struct cmac *cmac)\r\n{\r\nreturn 0;\r\n}\r\nstatic int pm3393_loopback_disable(struct cmac *cmac)\r\n{\r\nreturn 0;\r\n}\r\nstatic int pm3393_set_mtu(struct cmac *cmac, int mtu)\r\n{\r\nint enabled = cmac->instance->enabled;\r\nmtu += 14 + 4;\r\nif (mtu > MAX_FRAME_SIZE)\r\nreturn -EINVAL;\r\nif (enabled)\r\npm3393_disable(cmac, MAC_DIRECTION_RX | MAC_DIRECTION_TX);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MAX_FRAME_LENGTH, mtu);\r\npmwrite(cmac, SUNI1x10GEXP_REG_TXXG_MAX_FRAME_SIZE, mtu);\r\nif (enabled)\r\npm3393_enable(cmac, enabled);\r\nreturn 0;\r\n}\r\nstatic int pm3393_set_rx_mode(struct cmac *cmac, struct t1_rx_mode *rm)\r\n{\r\nint enabled = cmac->instance->enabled & MAC_DIRECTION_RX;\r\nu32 rx_mode;\r\nif (enabled)\r\npm3393_disable(cmac, MAC_DIRECTION_RX);\r\npmread(cmac, SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_2, &rx_mode);\r\nrx_mode &= ~(SUNI1x10GEXP_BITMSK_RXXG_PMODE |\r\nSUNI1x10GEXP_BITMSK_RXXG_MHASH_EN);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_2,\r\n(u16)rx_mode);\r\nif (t1_rx_mode_promisc(rm)) {\r\nrx_mode |= SUNI1x10GEXP_BITMSK_RXXG_PMODE;\r\n}\r\nif (t1_rx_mode_allmulti(rm)) {\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_LOW, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_MIDLOW, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_MIDHIGH, 0xffff);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_HIGH, 0xffff);\r\nrx_mode |= SUNI1x10GEXP_BITMSK_RXXG_MHASH_EN;\r\n} else if (t1_rx_mode_mc_cnt(rm)) {\r\nstruct netdev_hw_addr *ha;\r\nint bit;\r\nu16 mc_filter[4] = { 0, };\r\nnetdev_for_each_mc_addr(ha, t1_get_netdev(rm)) {\r\nbit = (ether_crc(ETH_ALEN, ha->addr) >> 23) & 0x3f;\r\nmc_filter[bit >> 4] |= 1 << (bit & 0xf);\r\n}\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_LOW, mc_filter[0]);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_MIDLOW, mc_filter[1]);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_MIDHIGH, mc_filter[2]);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_HIGH, mc_filter[3]);\r\nrx_mode |= SUNI1x10GEXP_BITMSK_RXXG_MHASH_EN;\r\n}\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_2, (u16)rx_mode);\r\nif (enabled)\r\npm3393_enable(cmac, MAC_DIRECTION_RX);\r\nreturn 0;\r\n}\r\nstatic int pm3393_get_speed_duplex_fc(struct cmac *cmac, int *speed,\r\nint *duplex, int *fc)\r\n{\r\nif (speed)\r\n*speed = SPEED_10000;\r\nif (duplex)\r\n*duplex = DUPLEX_FULL;\r\nif (fc)\r\n*fc = cmac->instance->fc;\r\nreturn 0;\r\n}\r\nstatic int pm3393_set_speed_duplex_fc(struct cmac *cmac, int speed, int duplex,\r\nint fc)\r\n{\r\nif (speed >= 0 && speed != SPEED_10000)\r\nreturn -1;\r\nif (duplex >= 0 && duplex != DUPLEX_FULL)\r\nreturn -1;\r\nif (fc & ~(PAUSE_TX | PAUSE_RX))\r\nreturn -1;\r\nif (fc != cmac->instance->fc) {\r\ncmac->instance->fc = (u8) fc;\r\nif (cmac->instance->enabled & MAC_DIRECTION_TX)\r\npm3393_enable(cmac, MAC_DIRECTION_TX);\r\n}\r\nreturn 0;\r\n}\r\nstatic const struct cmac_statistics *pm3393_update_statistics(struct cmac *mac,\r\nint flag)\r\n{\r\nu64 ro;\r\nu32 val0, val1, val2, val3;\r\npmwrite(mac, SUNI1x10GEXP_REG_MSTAT_CONTROL,\r\nSUNI1x10GEXP_BITMSK_MSTAT_SNAP);\r\npmread(mac, SUNI1x10GEXP_REG_MSTAT_COUNTER_ROLLOVER_0, &val0);\r\npmread(mac, SUNI1x10GEXP_REG_MSTAT_COUNTER_ROLLOVER_1, &val1);\r\npmread(mac, SUNI1x10GEXP_REG_MSTAT_COUNTER_ROLLOVER_2, &val2);\r\npmread(mac, SUNI1x10GEXP_REG_MSTAT_COUNTER_ROLLOVER_3, &val3);\r\nro = ((u64)val0 & 0xffff) | (((u64)val1 & 0xffff) << 16) |\r\n(((u64)val2 & 0xffff) << 32) | (((u64)val3 & 0xffff) << 48);\r\nRMON_UPDATE(mac, RxOctetsReceivedOK, RxOctetsOK);\r\nRMON_UPDATE(mac, RxUnicastFramesReceivedOK, RxUnicastFramesOK);\r\nRMON_UPDATE(mac, RxMulticastFramesReceivedOK, RxMulticastFramesOK);\r\nRMON_UPDATE(mac, RxBroadcastFramesReceivedOK, RxBroadcastFramesOK);\r\nRMON_UPDATE(mac, RxPAUSEMACCtrlFramesReceived, RxPauseFrames);\r\nRMON_UPDATE(mac, RxFrameCheckSequenceErrors, RxFCSErrors);\r\nRMON_UPDATE(mac, RxFramesLostDueToInternalMACErrors,\r\nRxInternalMACRcvError);\r\nRMON_UPDATE(mac, RxSymbolErrors, RxSymbolErrors);\r\nRMON_UPDATE(mac, RxInRangeLengthErrors, RxInRangeLengthErrors);\r\nRMON_UPDATE(mac, RxFramesTooLongErrors , RxFrameTooLongErrors);\r\nRMON_UPDATE(mac, RxJabbers, RxJabberErrors);\r\nRMON_UPDATE(mac, RxFragments, RxRuntErrors);\r\nRMON_UPDATE(mac, RxUndersizedFrames, RxRuntErrors);\r\nRMON_UPDATE(mac, RxJumboFramesReceivedOK, RxJumboFramesOK);\r\nRMON_UPDATE(mac, RxJumboOctetsReceivedOK, RxJumboOctetsOK);\r\nRMON_UPDATE(mac, TxOctetsTransmittedOK, TxOctetsOK);\r\nRMON_UPDATE(mac, TxFramesLostDueToInternalMACTransmissionError,\r\nTxInternalMACXmitError);\r\nRMON_UPDATE(mac, TxTransmitSystemError, TxFCSErrors);\r\nRMON_UPDATE(mac, TxUnicastFramesTransmittedOK, TxUnicastFramesOK);\r\nRMON_UPDATE(mac, TxMulticastFramesTransmittedOK, TxMulticastFramesOK);\r\nRMON_UPDATE(mac, TxBroadcastFramesTransmittedOK, TxBroadcastFramesOK);\r\nRMON_UPDATE(mac, TxPAUSEMACCtrlFramesTransmitted, TxPauseFrames);\r\nRMON_UPDATE(mac, TxJumboFramesReceivedOK, TxJumboFramesOK);\r\nRMON_UPDATE(mac, TxJumboOctetsReceivedOK, TxJumboOctetsOK);\r\nreturn &mac->stats;\r\n}\r\nstatic int pm3393_macaddress_get(struct cmac *cmac, u8 mac_addr[6])\r\n{\r\nmemcpy(mac_addr, cmac->instance->mac_addr, 6);\r\nreturn 0;\r\n}\r\nstatic int pm3393_macaddress_set(struct cmac *cmac, u8 ma[6])\r\n{\r\nu32 val, lo, mid, hi, enabled = cmac->instance->enabled;\r\nmemcpy(cmac->instance->mac_addr, ma, 6);\r\nlo = ((u32) ma[1] << 8) | (u32) ma[0];\r\nmid = ((u32) ma[3] << 8) | (u32) ma[2];\r\nhi = ((u32) ma[5] << 8) | (u32) ma[4];\r\nif (enabled)\r\npm3393_disable(cmac, MAC_DIRECTION_RX | MAC_DIRECTION_TX);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_SA_15_0, lo);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_SA_31_16, mid);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_SA_47_32, hi);\r\npmwrite(cmac, SUNI1x10GEXP_REG_TXXG_SA_15_0, lo);\r\npmwrite(cmac, SUNI1x10GEXP_REG_TXXG_SA_31_16, mid);\r\npmwrite(cmac, SUNI1x10GEXP_REG_TXXG_SA_47_32, hi);\r\npmread(cmac, SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_0, &val);\r\nval &= 0xff0f;\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_0, val);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_EXACT_MATCH_ADDR_1_LOW, lo);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_EXACT_MATCH_ADDR_1_MID, mid);\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_EXACT_MATCH_ADDR_1_HIGH, hi);\r\nval |= 0x0090;\r\npmwrite(cmac, SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_0, val);\r\nif (enabled)\r\npm3393_enable(cmac, enabled);\r\nreturn 0;\r\n}\r\nstatic void pm3393_destroy(struct cmac *cmac)\r\n{\r\nkfree(cmac);\r\n}\r\nstatic struct cmac *pm3393_mac_create(adapter_t *adapter, int index)\r\n{\r\nstruct cmac *cmac;\r\ncmac = kzalloc(sizeof(*cmac) + sizeof(cmac_instance), GFP_KERNEL);\r\nif (!cmac)\r\nreturn NULL;\r\ncmac->ops = &pm3393_ops;\r\ncmac->instance = (cmac_instance *) (cmac + 1);\r\ncmac->adapter = adapter;\r\ncmac->instance->fc = PAUSE_TX | PAUSE_RX;\r\nt1_tpi_write(adapter, OFFSET(0x0001), 0x00008000);\r\nt1_tpi_write(adapter, OFFSET(0x0001), 0x00000000);\r\nt1_tpi_write(adapter, OFFSET(0x2308), 0x00009800);\r\nt1_tpi_write(adapter, OFFSET(0x2305), 0x00001001);\r\nt1_tpi_write(adapter, OFFSET(0x2320), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x2321), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x2322), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x2323), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x2324), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x2325), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x2326), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x2327), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x2328), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x2329), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x232a), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x232b), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x232c), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x232d), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x232e), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x232f), 0x00008800);\r\nt1_tpi_write(adapter, OFFSET(0x230d), 0x00009c00);\r\nt1_tpi_write(adapter, OFFSET(0x2304), 0x00000202);\r\nt1_tpi_write(adapter, OFFSET(0x3200), 0x00008080);\r\nt1_tpi_write(adapter, OFFSET(0x3210), 0x00000000);\r\nt1_tpi_write(adapter, OFFSET(0x3203), 0x00000000);\r\nt1_tpi_write(adapter, OFFSET(0x3204), 0x00000040);\r\nt1_tpi_write(adapter, OFFSET(0x3205), 0x000002cc);\r\nt1_tpi_write(adapter, OFFSET(0x3206), 0x00000199);\r\nt1_tpi_write(adapter, OFFSET(0x3207), 0x00000240);\r\nt1_tpi_write(adapter, OFFSET(0x3202), 0x00000000);\r\nt1_tpi_write(adapter, OFFSET(0x3210), 0x00000001);\r\nt1_tpi_write(adapter, OFFSET(0x3208), 0x0000ffff);\r\nt1_tpi_write(adapter, OFFSET(0x320a), 0x0000ffff);\r\nt1_tpi_write(adapter, OFFSET(0x320c), 0x0000ffff);\r\nt1_tpi_write(adapter, OFFSET(0x320e), 0x0000ffff);\r\nt1_tpi_write(adapter, OFFSET(0x2200), 0x0000c000);\r\nt1_tpi_write(adapter, OFFSET(0x2201), 0x00000000);\r\nt1_tpi_write(adapter, OFFSET(0x220e), 0x00000000);\r\nt1_tpi_write(adapter, OFFSET(0x220f), 0x00000100);\r\nt1_tpi_write(adapter, OFFSET(0x2210), 0x00000c00);\r\nt1_tpi_write(adapter, OFFSET(0x2211), 0x00000599);\r\nt1_tpi_write(adapter, OFFSET(0x220d), 0x00000000);\r\nt1_tpi_write(adapter, OFFSET(0x2201), 0x00000001);\r\nt1_tpi_write(adapter, OFFSET(0x2203), 0x0000ffff);\r\nt1_tpi_write(adapter, OFFSET(0x2205), 0x0000ffff);\r\nt1_tpi_write(adapter, OFFSET(0x2209), 0x0000ffff);\r\nt1_tpi_write(adapter, OFFSET(0x2241), 0xfffffffe);\r\nt1_tpi_write(adapter, OFFSET(0x2242), 0x0000ffff);\r\nt1_tpi_write(adapter, OFFSET(0x2243), 0x00000008);\r\nt1_tpi_write(adapter, OFFSET(0x2244), 0x00000008);\r\nt1_tpi_write(adapter, OFFSET(0x2245), 0x00000008);\r\nt1_tpi_write(adapter, OFFSET(0x2240), 0x00000005);\r\nt1_tpi_write(adapter, OFFSET(0x2280), 0x00002103);\r\nt1_tpi_write(adapter, OFFSET(0x2284), 0x00000000);\r\nt1_tpi_write(adapter, OFFSET(0x3280), 0x00000087);\r\nt1_tpi_write(adapter, OFFSET(0x3282), 0x0000001f);\r\nt1_tpi_write(adapter, OFFSET(0x3040), 0x0c32);\r\nt1_tpi_write(adapter, OFFSET(0x304d), 0x8000);\r\nt1_tpi_write(adapter, OFFSET(0x2040), 0x059c);\r\nt1_tpi_write(adapter, OFFSET(0x2049), 0x0001);\r\nt1_tpi_write(adapter, OFFSET(0x2070), 0x0000);\r\nt1_tpi_write(adapter, OFFSET(0x206e), 0x0000);\r\nt1_tpi_write(adapter, OFFSET(0x204a), 0xffff);\r\nt1_tpi_write(adapter, OFFSET(0x204b), 0xffff);\r\nt1_tpi_write(adapter, OFFSET(0x204c), 0xffff);\r\nt1_tpi_write(adapter, OFFSET(0x206e), 0x0009);\r\nt1_tpi_write(adapter, OFFSET(0x0003), 0x0000);\r\nt1_tpi_write(adapter, OFFSET(0x0100), 0x0ff0);\r\nt1_tpi_write(adapter, OFFSET(0x0101), 0x0f0f);\r\nreturn cmac;\r\n}\r\nstatic int pm3393_mac_reset(adapter_t * adapter)\r\n{\r\nu32 val;\r\nu32 x;\r\nu32 is_pl4_reset_finished;\r\nu32 is_pl4_outof_lock;\r\nu32 is_xaui_mabc_pll_locked;\r\nu32 successful_reset;\r\nint i;\r\nsuccessful_reset = 0;\r\nfor (i = 0; i < 3 && !successful_reset; i++) {\r\nt1_tpi_read(adapter, A_ELMER0_GPO, &val);\r\nval &= ~1;\r\nt1_tpi_write(adapter, A_ELMER0_GPO, val);\r\nmsleep(1);\r\nmsleep(1);\r\nmsleep(2 );\r\nval |= 1;\r\nt1_tpi_write(adapter, A_ELMER0_GPO, val);\r\nmsleep(15 );\r\nmsleep(1);\r\nt1_tpi_read(adapter, OFFSET(SUNI1x10GEXP_REG_DEVICE_STATUS), &val);\r\nis_pl4_reset_finished = (val & SUNI1x10GEXP_BITMSK_TOP_EXPIRED);\r\nx = (SUNI1x10GEXP_BITMSK_TOP_PL4_ID_DOOL\r\n|\r\nSUNI1x10GEXP_BITMSK_TOP_PL4_ID_ROOL |\r\nSUNI1x10GEXP_BITMSK_TOP_PL4_IS_ROOL |\r\nSUNI1x10GEXP_BITMSK_TOP_PL4_OUT_ROOL);\r\nis_pl4_outof_lock = (val & x);\r\nis_xaui_mabc_pll_locked =\r\n(val & SUNI1x10GEXP_BITMSK_TOP_SXRA_EXPIRED);\r\nsuccessful_reset = (is_pl4_reset_finished && !is_pl4_outof_lock\r\n&& is_xaui_mabc_pll_locked);\r\nif (netif_msg_hw(adapter))\r\ndev_dbg(&adapter->pdev->dev,\r\n"PM3393 HW reset %d: pl4_reset 0x%x, val 0x%x, "\r\n"is_pl4_outof_lock 0x%x, xaui_locked 0x%x\n",\r\ni, is_pl4_reset_finished, val,\r\nis_pl4_outof_lock, is_xaui_mabc_pll_locked);\r\n}\r\nreturn successful_reset ? 0 : 1;\r\n}

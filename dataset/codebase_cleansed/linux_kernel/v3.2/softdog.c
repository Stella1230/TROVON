static void watchdog_fire(unsigned long data)\r\n{\r\nif (test_and_clear_bit(0, &orphan_timer))\r\nmodule_put(THIS_MODULE);\r\nif (soft_noboot)\r\nprintk(KERN_CRIT PFX "Triggered - Reboot ignored.\n");\r\nelse if (soft_panic) {\r\nprintk(KERN_CRIT PFX "Initiating panic.\n");\r\npanic("Software Watchdog Timer expired.");\r\n} else {\r\nprintk(KERN_CRIT PFX "Initiating system reboot.\n");\r\nemergency_restart();\r\nprintk(KERN_CRIT PFX "Reboot didn't ?????\n");\r\n}\r\n}\r\nstatic int softdog_keepalive(void)\r\n{\r\nmod_timer(&watchdog_ticktock, jiffies+(soft_margin*HZ));\r\nreturn 0;\r\n}\r\nstatic int softdog_stop(void)\r\n{\r\ndel_timer(&watchdog_ticktock);\r\nreturn 0;\r\n}\r\nstatic int softdog_set_heartbeat(int t)\r\n{\r\nif ((t < 0x0001) || (t > 0xFFFF))\r\nreturn -EINVAL;\r\nsoft_margin = t;\r\nreturn 0;\r\n}\r\nstatic int softdog_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &driver_open))\r\nreturn -EBUSY;\r\nif (!test_and_clear_bit(0, &orphan_timer))\r\n__module_get(THIS_MODULE);\r\nsoftdog_keepalive();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int softdog_release(struct inode *inode, struct file *file)\r\n{\r\nif (expect_close == 42) {\r\nsoftdog_stop();\r\nmodule_put(THIS_MODULE);\r\n} else {\r\nprintk(KERN_CRIT PFX\r\n"Unexpected close, not stopping watchdog!\n");\r\nset_bit(0, &orphan_timer);\r\nsoftdog_keepalive();\r\n}\r\nclear_bit(0, &driver_open);\r\nexpect_close = 0;\r\nreturn 0;\r\n}\r\nstatic ssize_t softdog_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nif (!nowayout) {\r\nsize_t i;\r\nexpect_close = 0;\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nexpect_close = 42;\r\n}\r\n}\r\nsoftdog_keepalive();\r\n}\r\nreturn len;\r\n}\r\nstatic long softdog_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nint new_margin;\r\nstatic const struct watchdog_info ident = {\r\n.options = WDIOF_SETTIMEOUT |\r\nWDIOF_KEEPALIVEPING |\r\nWDIOF_MAGICCLOSE,\r\n.firmware_version = 0,\r\n.identity = "Software Watchdog",\r\n};\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nreturn copy_to_user(argp, &ident, sizeof(ident)) ? -EFAULT : 0;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, p);\r\ncase WDIOC_KEEPALIVE:\r\nsoftdog_keepalive();\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT:\r\nif (get_user(new_margin, p))\r\nreturn -EFAULT;\r\nif (softdog_set_heartbeat(new_margin))\r\nreturn -EINVAL;\r\nsoftdog_keepalive();\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(soft_margin, p);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\n}\r\nstatic int softdog_notify_sys(struct notifier_block *this, unsigned long code,\r\nvoid *unused)\r\n{\r\nif (code == SYS_DOWN || code == SYS_HALT)\r\nsoftdog_stop();\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init watchdog_init(void)\r\n{\r\nint ret;\r\nif (softdog_set_heartbeat(soft_margin)) {\r\nsoftdog_set_heartbeat(TIMER_MARGIN);\r\nprintk(KERN_INFO PFX\r\n"soft_margin must be 0 < soft_margin < 65536, using %d\n",\r\nTIMER_MARGIN);\r\n}\r\nret = register_reboot_notifier(&softdog_notifier);\r\nif (ret) {\r\nprintk(KERN_ERR PFX\r\n"cannot register reboot notifier (err=%d)\n", ret);\r\nreturn ret;\r\n}\r\nret = misc_register(&softdog_miscdev);\r\nif (ret) {\r\nprintk(KERN_ERR PFX\r\n"cannot register miscdev on minor=%d (err=%d)\n",\r\nWATCHDOG_MINOR, ret);\r\nunregister_reboot_notifier(&softdog_notifier);\r\nreturn ret;\r\n}\r\nprintk(banner, soft_noboot, soft_margin, soft_panic, nowayout);\r\nreturn 0;\r\n}\r\nstatic void __exit watchdog_exit(void)\r\n{\r\nmisc_deregister(&softdog_miscdev);\r\nunregister_reboot_notifier(&softdog_notifier);\r\n}

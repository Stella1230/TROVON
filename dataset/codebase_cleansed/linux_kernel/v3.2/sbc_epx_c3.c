static void epx_c3_start(void)\r\n{\r\noutb(1, EPXC3_WATCHDOG_CTL_REG);\r\n}\r\nstatic void epx_c3_stop(void)\r\n{\r\noutb(0, EPXC3_WATCHDOG_CTL_REG);\r\nprintk(KERN_INFO PFX "Stopped watchdog timer.\n");\r\n}\r\nstatic void epx_c3_pet(void)\r\n{\r\noutb(1, EPXC3_WATCHDOG_PET_REG);\r\n}\r\nstatic int epx_c3_open(struct inode *inode, struct file *file)\r\n{\r\nif (epx_c3_alive)\r\nreturn -EBUSY;\r\nif (nowayout)\r\n__module_get(THIS_MODULE);\r\nepx_c3_start();\r\nepx_c3_pet();\r\nepx_c3_alive = 1;\r\nprintk(KERN_INFO "Started watchdog timer.\n");\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int epx_c3_release(struct inode *inode, struct file *file)\r\n{\r\nif (!nowayout)\r\nepx_c3_stop();\r\nepx_c3_alive = 0;\r\nreturn 0;\r\n}\r\nstatic ssize_t epx_c3_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len)\r\nepx_c3_pet();\r\nreturn len;\r\n}\r\nstatic long epx_c3_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint options, retval = -EINVAL;\r\nint __user *argp = (void __user *)arg;\r\nstatic const struct watchdog_info ident = {\r\n.options = WDIOF_KEEPALIVEPING,\r\n.firmware_version = 0,\r\n.identity = "Winsystems EPX-C3 H/W Watchdog",\r\n};\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nif (copy_to_user(argp, &ident, sizeof(ident)))\r\nreturn -EFAULT;\r\nreturn 0;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, argp);\r\ncase WDIOC_SETOPTIONS:\r\nif (get_user(options, argp))\r\nreturn -EFAULT;\r\nif (options & WDIOS_DISABLECARD) {\r\nepx_c3_stop();\r\nretval = 0;\r\n}\r\nif (options & WDIOS_ENABLECARD) {\r\nepx_c3_start();\r\nretval = 0;\r\n}\r\nreturn retval;\r\ncase WDIOC_KEEPALIVE:\r\nepx_c3_pet();\r\nreturn 0;\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(WATCHDOG_TIMEOUT, argp);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\n}\r\nstatic int epx_c3_notify_sys(struct notifier_block *this, unsigned long code,\r\nvoid *unused)\r\n{\r\nif (code == SYS_DOWN || code == SYS_HALT)\r\nepx_c3_stop();\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init watchdog_init(void)\r\n{\r\nint ret;\r\nif (!request_region(EPXC3_WATCHDOG_CTL_REG, 2, "epxc3_watchdog"))\r\nreturn -EBUSY;\r\nret = register_reboot_notifier(&epx_c3_notifier);\r\nif (ret) {\r\nprintk(KERN_ERR PFX "cannot register reboot notifier "\r\n"(err=%d)\n", ret);\r\ngoto out;\r\n}\r\nret = misc_register(&epx_c3_miscdev);\r\nif (ret) {\r\nprintk(KERN_ERR PFX "cannot register miscdev on minor=%d "\r\n"(err=%d)\n", WATCHDOG_MINOR, ret);\r\nunregister_reboot_notifier(&epx_c3_notifier);\r\ngoto out;\r\n}\r\nprintk(banner);\r\nreturn 0;\r\nout:\r\nrelease_region(EPXC3_WATCHDOG_CTL_REG, 2);\r\nreturn ret;\r\n}\r\nstatic void __exit watchdog_exit(void)\r\n{\r\nmisc_deregister(&epx_c3_miscdev);\r\nunregister_reboot_notifier(&epx_c3_notifier);\r\nrelease_region(EPXC3_WATCHDOG_CTL_REG, 2);\r\n}

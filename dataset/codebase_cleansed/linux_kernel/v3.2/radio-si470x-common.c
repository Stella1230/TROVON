static int si470x_set_chan(struct si470x_device *radio, unsigned short chan)\r\n{\r\nint retval;\r\nunsigned long timeout;\r\nbool timed_out = 0;\r\nradio->registers[CHANNEL] &= ~CHANNEL_CHAN;\r\nradio->registers[CHANNEL] |= CHANNEL_TUNE | chan;\r\nretval = si470x_set_register(radio, CHANNEL);\r\nif (retval < 0)\r\ngoto done;\r\nif (radio->stci_enabled) {\r\nINIT_COMPLETION(radio->completion);\r\nretval = wait_for_completion_timeout(&radio->completion,\r\nmsecs_to_jiffies(tune_timeout));\r\nif (!retval)\r\ntimed_out = true;\r\n} else {\r\ntimeout = jiffies + msecs_to_jiffies(tune_timeout);\r\ndo {\r\nretval = si470x_get_register(radio, STATUSRSSI);\r\nif (retval < 0)\r\ngoto stop;\r\ntimed_out = time_after(jiffies, timeout);\r\n} while (((radio->registers[STATUSRSSI] & STATUSRSSI_STC) == 0)\r\n&& (!timed_out));\r\n}\r\nif ((radio->registers[STATUSRSSI] & STATUSRSSI_STC) == 0)\r\ndev_warn(&radio->videodev->dev, "tune does not complete\n");\r\nif (timed_out)\r\ndev_warn(&radio->videodev->dev,\r\n"tune timed out after %u ms\n", tune_timeout);\r\nstop:\r\nradio->registers[CHANNEL] &= ~CHANNEL_TUNE;\r\nretval = si470x_set_register(radio, CHANNEL);\r\ndone:\r\nreturn retval;\r\n}\r\nstatic int si470x_get_freq(struct si470x_device *radio, unsigned int *freq)\r\n{\r\nunsigned int spacing, band_bottom;\r\nunsigned short chan;\r\nint retval;\r\nswitch ((radio->registers[SYSCONFIG2] & SYSCONFIG2_SPACE) >> 4) {\r\ncase 0:\r\nspacing = 0.200 * FREQ_MUL; break;\r\ncase 1:\r\nspacing = 0.100 * FREQ_MUL; break;\r\ndefault:\r\nspacing = 0.050 * FREQ_MUL; break;\r\n};\r\nswitch ((radio->registers[SYSCONFIG2] & SYSCONFIG2_BAND) >> 6) {\r\ncase 0:\r\nband_bottom = 87.5 * FREQ_MUL; break;\r\ndefault:\r\nband_bottom = 76 * FREQ_MUL; break;\r\ncase 2:\r\nband_bottom = 76 * FREQ_MUL; break;\r\n};\r\nretval = si470x_get_register(radio, READCHAN);\r\nchan = radio->registers[READCHAN] & READCHAN_READCHAN;\r\n*freq = chan * spacing + band_bottom;\r\nreturn retval;\r\n}\r\nint si470x_set_freq(struct si470x_device *radio, unsigned int freq)\r\n{\r\nunsigned int spacing, band_bottom;\r\nunsigned short chan;\r\nswitch ((radio->registers[SYSCONFIG2] & SYSCONFIG2_SPACE) >> 4) {\r\ncase 0:\r\nspacing = 0.200 * FREQ_MUL; break;\r\ncase 1:\r\nspacing = 0.100 * FREQ_MUL; break;\r\ndefault:\r\nspacing = 0.050 * FREQ_MUL; break;\r\n};\r\nswitch ((radio->registers[SYSCONFIG2] & SYSCONFIG2_BAND) >> 6) {\r\ncase 0:\r\nband_bottom = 87.5 * FREQ_MUL; break;\r\ndefault:\r\nband_bottom = 76 * FREQ_MUL; break;\r\ncase 2:\r\nband_bottom = 76 * FREQ_MUL; break;\r\n};\r\nchan = (freq - band_bottom) / spacing;\r\nreturn si470x_set_chan(radio, chan);\r\n}\r\nstatic int si470x_set_seek(struct si470x_device *radio,\r\nunsigned int wrap_around, unsigned int seek_upward)\r\n{\r\nint retval = 0;\r\nunsigned long timeout;\r\nbool timed_out = 0;\r\nradio->registers[POWERCFG] |= POWERCFG_SEEK;\r\nif (wrap_around == 1)\r\nradio->registers[POWERCFG] &= ~POWERCFG_SKMODE;\r\nelse\r\nradio->registers[POWERCFG] |= POWERCFG_SKMODE;\r\nif (seek_upward == 1)\r\nradio->registers[POWERCFG] |= POWERCFG_SEEKUP;\r\nelse\r\nradio->registers[POWERCFG] &= ~POWERCFG_SEEKUP;\r\nretval = si470x_set_register(radio, POWERCFG);\r\nif (retval < 0)\r\ngoto done;\r\nif (radio->stci_enabled) {\r\nINIT_COMPLETION(radio->completion);\r\nretval = wait_for_completion_timeout(&radio->completion,\r\nmsecs_to_jiffies(seek_timeout));\r\nif (!retval)\r\ntimed_out = true;\r\n} else {\r\ntimeout = jiffies + msecs_to_jiffies(seek_timeout);\r\ndo {\r\nretval = si470x_get_register(radio, STATUSRSSI);\r\nif (retval < 0)\r\ngoto stop;\r\ntimed_out = time_after(jiffies, timeout);\r\n} while (((radio->registers[STATUSRSSI] & STATUSRSSI_STC) == 0)\r\n&& (!timed_out));\r\n}\r\nif ((radio->registers[STATUSRSSI] & STATUSRSSI_STC) == 0)\r\ndev_warn(&radio->videodev->dev, "seek does not complete\n");\r\nif (radio->registers[STATUSRSSI] & STATUSRSSI_SF)\r\ndev_warn(&radio->videodev->dev,\r\n"seek failed / band limit reached\n");\r\nif (timed_out)\r\ndev_warn(&radio->videodev->dev,\r\n"seek timed out after %u ms\n", seek_timeout);\r\nstop:\r\nradio->registers[POWERCFG] &= ~POWERCFG_SEEK;\r\nretval = si470x_set_register(radio, POWERCFG);\r\ndone:\r\nif ((retval == 0) && timed_out)\r\nretval = -EAGAIN;\r\nreturn retval;\r\n}\r\nint si470x_start(struct si470x_device *radio)\r\n{\r\nint retval;\r\nradio->registers[POWERCFG] =\r\nPOWERCFG_DMUTE | POWERCFG_ENABLE | POWERCFG_RDSM;\r\nretval = si470x_set_register(radio, POWERCFG);\r\nif (retval < 0)\r\ngoto done;\r\nradio->registers[SYSCONFIG1] =\r\n(de << 11) & SYSCONFIG1_DE;\r\nretval = si470x_set_register(radio, SYSCONFIG1);\r\nif (retval < 0)\r\ngoto done;\r\nradio->registers[SYSCONFIG2] =\r\n(0x3f << 8) |\r\n((band << 6) & SYSCONFIG2_BAND) |\r\n((space << 4) & SYSCONFIG2_SPACE) |\r\n15;\r\nretval = si470x_set_register(radio, SYSCONFIG2);\r\nif (retval < 0)\r\ngoto done;\r\nretval = si470x_set_chan(radio,\r\nradio->registers[CHANNEL] & CHANNEL_CHAN);\r\ndone:\r\nreturn retval;\r\n}\r\nint si470x_stop(struct si470x_device *radio)\r\n{\r\nint retval;\r\nradio->registers[SYSCONFIG1] &= ~SYSCONFIG1_RDS;\r\nretval = si470x_set_register(radio, SYSCONFIG1);\r\nif (retval < 0)\r\ngoto done;\r\nradio->registers[POWERCFG] &= ~POWERCFG_DMUTE;\r\nradio->registers[POWERCFG] |= POWERCFG_ENABLE | POWERCFG_DISABLE;\r\nretval = si470x_set_register(radio, POWERCFG);\r\ndone:\r\nreturn retval;\r\n}\r\nstatic int si470x_rds_on(struct si470x_device *radio)\r\n{\r\nint retval;\r\nradio->registers[SYSCONFIG1] |= SYSCONFIG1_RDS;\r\nretval = si470x_set_register(radio, SYSCONFIG1);\r\nif (retval < 0)\r\nradio->registers[SYSCONFIG1] &= ~SYSCONFIG1_RDS;\r\nreturn retval;\r\n}\r\nstatic ssize_t si470x_fops_read(struct file *file, char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nint retval = 0;\r\nunsigned int block_count = 0;\r\nmutex_lock(&radio->lock);\r\nif ((radio->registers[SYSCONFIG1] & SYSCONFIG1_RDS) == 0)\r\nsi470x_rds_on(radio);\r\nwhile (radio->wr_index == radio->rd_index) {\r\nif (file->f_flags & O_NONBLOCK) {\r\nretval = -EWOULDBLOCK;\r\ngoto done;\r\n}\r\nif (wait_event_interruptible(radio->read_queue,\r\nradio->wr_index != radio->rd_index) < 0) {\r\nretval = -EINTR;\r\ngoto done;\r\n}\r\n}\r\ncount /= 3;\r\nwhile (block_count < count) {\r\nif (radio->rd_index == radio->wr_index)\r\nbreak;\r\nif (copy_to_user(buf, &radio->buffer[radio->rd_index], 3))\r\nbreak;\r\nradio->rd_index += 3;\r\nif (radio->rd_index >= radio->buf_size)\r\nradio->rd_index = 0;\r\nblock_count++;\r\nbuf += 3;\r\nretval += 3;\r\n}\r\ndone:\r\nmutex_unlock(&radio->lock);\r\nreturn retval;\r\n}\r\nstatic unsigned int si470x_fops_poll(struct file *file,\r\nstruct poll_table_struct *pts)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nint retval = 0;\r\nmutex_lock(&radio->lock);\r\nif ((radio->registers[SYSCONFIG1] & SYSCONFIG1_RDS) == 0)\r\nsi470x_rds_on(radio);\r\nmutex_unlock(&radio->lock);\r\npoll_wait(file, &radio->read_queue, pts);\r\nif (radio->rd_index != radio->wr_index)\r\nretval = POLLIN | POLLRDNORM;\r\nreturn retval;\r\n}\r\nstatic int si470x_vidioc_queryctrl(struct file *file, void *priv,\r\nstruct v4l2_queryctrl *qc)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nint retval = -EINVAL;\r\nif (qc->id < V4L2_CID_BASE)\r\ngoto done;\r\nswitch (qc->id) {\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nreturn v4l2_ctrl_query_fill(qc, 0, 15, 1, 15);\r\ncase V4L2_CID_AUDIO_MUTE:\r\nreturn v4l2_ctrl_query_fill(qc, 0, 1, 1, 1);\r\n}\r\nif ((retval == -EINVAL) && (qc->id < V4L2_CID_LASTP1)) {\r\nqc->flags = V4L2_CTRL_FLAG_DISABLED;\r\nretval = 0;\r\n}\r\ndone:\r\nif (retval < 0)\r\ndev_warn(&radio->videodev->dev,\r\n"query controls failed with %d\n", retval);\r\nreturn retval;\r\n}\r\nstatic int si470x_vidioc_g_ctrl(struct file *file, void *priv,\r\nstruct v4l2_control *ctrl)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nint retval = 0;\r\nmutex_lock(&radio->lock);\r\nretval = si470x_disconnect_check(radio);\r\nif (retval)\r\ngoto done;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nctrl->value = radio->registers[SYSCONFIG2] &\r\nSYSCONFIG2_VOLUME;\r\nbreak;\r\ncase V4L2_CID_AUDIO_MUTE:\r\nctrl->value = ((radio->registers[POWERCFG] &\r\nPOWERCFG_DMUTE) == 0) ? 1 : 0;\r\nbreak;\r\ndefault:\r\nretval = -EINVAL;\r\n}\r\ndone:\r\nif (retval < 0)\r\ndev_warn(&radio->videodev->dev,\r\n"get control failed with %d\n", retval);\r\nmutex_unlock(&radio->lock);\r\nreturn retval;\r\n}\r\nstatic int si470x_vidioc_s_ctrl(struct file *file, void *priv,\r\nstruct v4l2_control *ctrl)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nint retval = 0;\r\nmutex_lock(&radio->lock);\r\nretval = si470x_disconnect_check(radio);\r\nif (retval)\r\ngoto done;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nradio->registers[SYSCONFIG2] &= ~SYSCONFIG2_VOLUME;\r\nradio->registers[SYSCONFIG2] |= ctrl->value;\r\nretval = si470x_set_register(radio, SYSCONFIG2);\r\nbreak;\r\ncase V4L2_CID_AUDIO_MUTE:\r\nif (ctrl->value == 1)\r\nradio->registers[POWERCFG] &= ~POWERCFG_DMUTE;\r\nelse\r\nradio->registers[POWERCFG] |= POWERCFG_DMUTE;\r\nretval = si470x_set_register(radio, POWERCFG);\r\nbreak;\r\ndefault:\r\nretval = -EINVAL;\r\n}\r\ndone:\r\nif (retval < 0)\r\ndev_warn(&radio->videodev->dev,\r\n"set control failed with %d\n", retval);\r\nmutex_unlock(&radio->lock);\r\nreturn retval;\r\n}\r\nstatic int si470x_vidioc_g_audio(struct file *file, void *priv,\r\nstruct v4l2_audio *audio)\r\n{\r\naudio->index = 0;\r\nstrcpy(audio->name, "Radio");\r\naudio->capability = V4L2_AUDCAP_STEREO;\r\naudio->mode = 0;\r\nreturn 0;\r\n}\r\nstatic int si470x_vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *tuner)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nint retval = 0;\r\nmutex_lock(&radio->lock);\r\nretval = si470x_disconnect_check(radio);\r\nif (retval)\r\ngoto done;\r\nif (tuner->index != 0) {\r\nretval = -EINVAL;\r\ngoto done;\r\n}\r\nretval = si470x_get_register(radio, STATUSRSSI);\r\nif (retval < 0)\r\ngoto done;\r\nstrcpy(tuner->name, "FM");\r\ntuner->type = V4L2_TUNER_RADIO;\r\ntuner->capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_STEREO |\r\nV4L2_TUNER_CAP_RDS | V4L2_TUNER_CAP_RDS_BLOCK_IO;\r\nswitch ((radio->registers[SYSCONFIG2] & SYSCONFIG2_BAND) >> 6) {\r\ndefault:\r\ntuner->rangelow = 87.5 * FREQ_MUL;\r\ntuner->rangehigh = 108 * FREQ_MUL;\r\nbreak;\r\ncase 1:\r\ntuner->rangelow = 76 * FREQ_MUL;\r\ntuner->rangehigh = 108 * FREQ_MUL;\r\nbreak;\r\ncase 2:\r\ntuner->rangelow = 76 * FREQ_MUL;\r\ntuner->rangehigh = 90 * FREQ_MUL;\r\nbreak;\r\n};\r\nif ((radio->registers[STATUSRSSI] & STATUSRSSI_ST) == 0)\r\ntuner->rxsubchans = V4L2_TUNER_SUB_MONO;\r\nelse\r\ntuner->rxsubchans = V4L2_TUNER_SUB_MONO | V4L2_TUNER_SUB_STEREO;\r\ntuner->rxsubchans |= V4L2_TUNER_SUB_RDS;\r\nif ((radio->registers[POWERCFG] & POWERCFG_MONO) == 0)\r\ntuner->audmode = V4L2_TUNER_MODE_STEREO;\r\nelse\r\ntuner->audmode = V4L2_TUNER_MODE_MONO;\r\ntuner->signal = (radio->registers[STATUSRSSI] & STATUSRSSI_RSSI);\r\ntuner->signal = (tuner->signal * 873) + (8 * tuner->signal / 10);\r\ntuner->afc = (radio->registers[STATUSRSSI] & STATUSRSSI_AFCRL) ? 1 : 0;\r\ndone:\r\nif (retval < 0)\r\ndev_warn(&radio->videodev->dev,\r\n"get tuner failed with %d\n", retval);\r\nmutex_unlock(&radio->lock);\r\nreturn retval;\r\n}\r\nstatic int si470x_vidioc_s_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *tuner)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nint retval = 0;\r\nmutex_lock(&radio->lock);\r\nretval = si470x_disconnect_check(radio);\r\nif (retval)\r\ngoto done;\r\nif (tuner->index != 0)\r\ngoto done;\r\nswitch (tuner->audmode) {\r\ncase V4L2_TUNER_MODE_MONO:\r\nradio->registers[POWERCFG] |= POWERCFG_MONO;\r\nbreak;\r\ncase V4L2_TUNER_MODE_STEREO:\r\nradio->registers[POWERCFG] &= ~POWERCFG_MONO;\r\nbreak;\r\ndefault:\r\ngoto done;\r\n}\r\nretval = si470x_set_register(radio, POWERCFG);\r\ndone:\r\nif (retval < 0)\r\ndev_warn(&radio->videodev->dev,\r\n"set tuner failed with %d\n", retval);\r\nmutex_unlock(&radio->lock);\r\nreturn retval;\r\n}\r\nstatic int si470x_vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *freq)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nint retval = 0;\r\nmutex_lock(&radio->lock);\r\nretval = si470x_disconnect_check(radio);\r\nif (retval)\r\ngoto done;\r\nif (freq->tuner != 0) {\r\nretval = -EINVAL;\r\ngoto done;\r\n}\r\nfreq->type = V4L2_TUNER_RADIO;\r\nretval = si470x_get_freq(radio, &freq->frequency);\r\ndone:\r\nif (retval < 0)\r\ndev_warn(&radio->videodev->dev,\r\n"get frequency failed with %d\n", retval);\r\nmutex_unlock(&radio->lock);\r\nreturn retval;\r\n}\r\nstatic int si470x_vidioc_s_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *freq)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nint retval = 0;\r\nmutex_lock(&radio->lock);\r\nretval = si470x_disconnect_check(radio);\r\nif (retval)\r\ngoto done;\r\nif (freq->tuner != 0) {\r\nretval = -EINVAL;\r\ngoto done;\r\n}\r\nretval = si470x_set_freq(radio, freq->frequency);\r\ndone:\r\nif (retval < 0)\r\ndev_warn(&radio->videodev->dev,\r\n"set frequency failed with %d\n", retval);\r\nmutex_unlock(&radio->lock);\r\nreturn retval;\r\n}\r\nstatic int si470x_vidioc_s_hw_freq_seek(struct file *file, void *priv,\r\nstruct v4l2_hw_freq_seek *seek)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nint retval = 0;\r\nmutex_lock(&radio->lock);\r\nretval = si470x_disconnect_check(radio);\r\nif (retval)\r\ngoto done;\r\nif (seek->tuner != 0) {\r\nretval = -EINVAL;\r\ngoto done;\r\n}\r\nretval = si470x_set_seek(radio, seek->wrap_around, seek->seek_upward);\r\ndone:\r\nif (retval < 0)\r\ndev_warn(&radio->videodev->dev,\r\n"set hardware frequency seek failed with %d\n", retval);\r\nmutex_unlock(&radio->lock);\r\nreturn retval;\r\n}

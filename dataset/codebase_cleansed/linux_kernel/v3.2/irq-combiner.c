static inline void __iomem *combiner_base(struct irq_data *data)\r\n{\r\nstruct combiner_chip_data *combiner_data =\r\nirq_data_get_irq_chip_data(data);\r\nreturn combiner_data->base;\r\n}\r\nstatic void combiner_mask_irq(struct irq_data *data)\r\n{\r\nu32 mask = 1 << (data->irq % 32);\r\n__raw_writel(mask, combiner_base(data) + COMBINER_ENABLE_CLEAR);\r\n}\r\nstatic void combiner_unmask_irq(struct irq_data *data)\r\n{\r\nu32 mask = 1 << (data->irq % 32);\r\n__raw_writel(mask, combiner_base(data) + COMBINER_ENABLE_SET);\r\n}\r\nstatic void combiner_handle_cascade_irq(unsigned int irq, struct irq_desc *desc)\r\n{\r\nstruct combiner_chip_data *chip_data = irq_get_handler_data(irq);\r\nstruct irq_chip *chip = irq_get_chip(irq);\r\nunsigned int cascade_irq, combiner_irq;\r\nunsigned long status;\r\nchained_irq_enter(chip, desc);\r\nspin_lock(&irq_controller_lock);\r\nstatus = __raw_readl(chip_data->base + COMBINER_INT_STATUS);\r\nspin_unlock(&irq_controller_lock);\r\nstatus &= chip_data->irq_mask;\r\nif (status == 0)\r\ngoto out;\r\ncombiner_irq = __ffs(status);\r\ncascade_irq = combiner_irq + (chip_data->irq_offset & ~31);\r\nif (unlikely(cascade_irq >= NR_IRQS))\r\ndo_bad_IRQ(cascade_irq, desc);\r\nelse\r\ngeneric_handle_irq(cascade_irq);\r\nout:\r\nchained_irq_exit(chip, desc);\r\n}\r\nvoid __init combiner_cascade_irq(unsigned int combiner_nr, unsigned int irq)\r\n{\r\nif (combiner_nr >= MAX_COMBINER_NR)\r\nBUG();\r\nif (irq_set_handler_data(irq, &combiner_data[combiner_nr]) != 0)\r\nBUG();\r\nirq_set_chained_handler(irq, combiner_handle_cascade_irq);\r\n}\r\nvoid __init combiner_init(unsigned int combiner_nr, void __iomem *base,\r\nunsigned int irq_start)\r\n{\r\nunsigned int i;\r\nif (combiner_nr >= MAX_COMBINER_NR)\r\nBUG();\r\ncombiner_data[combiner_nr].base = base;\r\ncombiner_data[combiner_nr].irq_offset = irq_start;\r\ncombiner_data[combiner_nr].irq_mask = 0xff << ((combiner_nr % 4) << 3);\r\n__raw_writel(combiner_data[combiner_nr].irq_mask,\r\nbase + COMBINER_ENABLE_CLEAR);\r\nfor (i = irq_start; i < combiner_data[combiner_nr].irq_offset\r\n+ MAX_IRQ_IN_COMBINER; i++) {\r\nirq_set_chip_and_handler(i, &combiner_chip, handle_level_irq);\r\nirq_set_chip_data(i, &combiner_data[combiner_nr]);\r\nset_irq_flags(i, IRQF_VALID | IRQF_PROBE);\r\n}\r\n}

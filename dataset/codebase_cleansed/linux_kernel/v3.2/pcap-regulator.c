static int pcap_regulator_set_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV,\r\nunsigned *selector)\r\n{\r\nstruct pcap_regulator *vreg = &vreg_table[rdev_get_id(rdev)];\r\nvoid *pcap = rdev_get_drvdata(rdev);\r\nint uV;\r\nu8 i;\r\nif (vreg->n_voltages == 1)\r\nreturn -EINVAL;\r\nfor (i = 0; i < vreg->n_voltages; i++) {\r\nif (i == 0 && rdev_get_id(rdev) == V1)\r\ni = 1;\r\nelse if (i + 1 == vreg->n_voltages && rdev_get_id(rdev) == V1)\r\ni = 0;\r\nuV = vreg->voltage_table[i] * 1000;\r\nif (min_uV <= uV && uV <= max_uV) {\r\n*selector = i;\r\nreturn ezx_pcap_set_bits(pcap, vreg->reg,\r\n(vreg->n_voltages - 1) << vreg->index,\r\ni << vreg->index);\r\n}\r\nif (i == 0 && rdev_get_id(rdev) == V1)\r\ni = vreg->n_voltages - 1;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int pcap_regulator_get_voltage(struct regulator_dev *rdev)\r\n{\r\nstruct pcap_regulator *vreg = &vreg_table[rdev_get_id(rdev)];\r\nvoid *pcap = rdev_get_drvdata(rdev);\r\nu32 tmp;\r\nint mV;\r\nif (vreg->n_voltages == 1)\r\nreturn vreg->voltage_table[0] * 1000;\r\nezx_pcap_read(pcap, vreg->reg, &tmp);\r\ntmp = ((tmp >> vreg->index) & (vreg->n_voltages - 1));\r\nmV = vreg->voltage_table[tmp];\r\nreturn mV * 1000;\r\n}\r\nstatic int pcap_regulator_enable(struct regulator_dev *rdev)\r\n{\r\nstruct pcap_regulator *vreg = &vreg_table[rdev_get_id(rdev)];\r\nvoid *pcap = rdev_get_drvdata(rdev);\r\nif (vreg->en == NA)\r\nreturn -EINVAL;\r\nreturn ezx_pcap_set_bits(pcap, vreg->reg, 1 << vreg->en, 1 << vreg->en);\r\n}\r\nstatic int pcap_regulator_disable(struct regulator_dev *rdev)\r\n{\r\nstruct pcap_regulator *vreg = &vreg_table[rdev_get_id(rdev)];\r\nvoid *pcap = rdev_get_drvdata(rdev);\r\nif (vreg->en == NA)\r\nreturn -EINVAL;\r\nreturn ezx_pcap_set_bits(pcap, vreg->reg, 1 << vreg->en, 0);\r\n}\r\nstatic int pcap_regulator_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct pcap_regulator *vreg = &vreg_table[rdev_get_id(rdev)];\r\nvoid *pcap = rdev_get_drvdata(rdev);\r\nu32 tmp;\r\nif (vreg->en == NA)\r\nreturn -EINVAL;\r\nezx_pcap_read(pcap, vreg->reg, &tmp);\r\nreturn (tmp >> vreg->en) & 1;\r\n}\r\nstatic int pcap_regulator_list_voltage(struct regulator_dev *rdev,\r\nunsigned int index)\r\n{\r\nstruct pcap_regulator *vreg = &vreg_table[rdev_get_id(rdev)];\r\nreturn vreg->voltage_table[index] * 1000;\r\n}\r\nstatic int __devinit pcap_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct regulator_dev *rdev;\r\nvoid *pcap = dev_get_drvdata(pdev->dev.parent);\r\nrdev = regulator_register(&pcap_regulators[pdev->id], &pdev->dev,\r\npdev->dev.platform_data, pcap);\r\nif (IS_ERR(rdev))\r\nreturn PTR_ERR(rdev);\r\nplatform_set_drvdata(pdev, rdev);\r\nreturn 0;\r\n}\r\nstatic int __devexit pcap_regulator_remove(struct platform_device *pdev)\r\n{\r\nstruct regulator_dev *rdev = platform_get_drvdata(pdev);\r\nregulator_unregister(rdev);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init pcap_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&pcap_regulator_driver);\r\n}\r\nstatic void __exit pcap_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&pcap_regulator_driver);\r\n}

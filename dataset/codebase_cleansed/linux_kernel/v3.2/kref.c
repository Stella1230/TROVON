void kref_init(struct kref *kref)\r\n{\r\natomic_set(&kref->refcount, 1);\r\nsmp_mb();\r\n}\r\nvoid kref_get(struct kref *kref)\r\n{\r\nWARN_ON(!atomic_read(&kref->refcount));\r\natomic_inc(&kref->refcount);\r\nsmp_mb__after_atomic_inc();\r\n}\r\nint kref_put(struct kref *kref, void (*release)(struct kref *kref))\r\n{\r\nWARN_ON(release == NULL);\r\nWARN_ON(release == (void (*)(struct kref *))kfree);\r\nif (atomic_dec_and_test(&kref->refcount)) {\r\nrelease(kref);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nint kref_sub(struct kref *kref, unsigned int count,\r\nvoid (*release)(struct kref *kref))\r\n{\r\nWARN_ON(release == NULL);\r\nWARN_ON(release == (void (*)(struct kref *))kfree);\r\nif (atomic_sub_and_test((int) count, &kref->refcount)) {\r\nrelease(kref);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}

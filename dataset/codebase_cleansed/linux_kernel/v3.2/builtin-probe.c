static int parse_probe_event(const char *str)\r\n{\r\nstruct perf_probe_event *pev = &params.events[params.nevents];\r\nint ret;\r\npr_debug("probe-definition(%d): %s\n", params.nevents, str);\r\nif (++params.nevents == MAX_PROBES) {\r\npr_err("Too many probes (> %d) were specified.", MAX_PROBES);\r\nreturn -1;\r\n}\r\nret = parse_perf_probe_command(str, pev);\r\npr_debug("%d arguments\n", pev->nargs);\r\nreturn ret;\r\n}\r\nstatic int parse_probe_event_argv(int argc, const char **argv)\r\n{\r\nint i, len, ret;\r\nchar *buf;\r\nlen = 0;\r\nfor (i = 0; i < argc; i++)\r\nlen += strlen(argv[i]) + 1;\r\nbuf = zalloc(len + 1);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nlen = 0;\r\nfor (i = 0; i < argc; i++)\r\nlen += sprintf(&buf[len], "%s ", argv[i]);\r\nparams.mod_events = true;\r\nret = parse_probe_event(buf);\r\nfree(buf);\r\nreturn ret;\r\n}\r\nstatic int opt_add_probe_event(const struct option *opt __used,\r\nconst char *str, int unset __used)\r\n{\r\nif (str) {\r\nparams.mod_events = true;\r\nreturn parse_probe_event(str);\r\n} else\r\nreturn 0;\r\n}\r\nstatic int opt_del_probe_event(const struct option *opt __used,\r\nconst char *str, int unset __used)\r\n{\r\nif (str) {\r\nparams.mod_events = true;\r\nif (!params.dellist)\r\nparams.dellist = strlist__new(true, NULL);\r\nstrlist__add(params.dellist, str);\r\n}\r\nreturn 0;\r\n}\r\nstatic int opt_show_lines(const struct option *opt __used,\r\nconst char *str, int unset __used)\r\n{\r\nint ret = 0;\r\nif (!str)\r\nreturn 0;\r\nif (params.show_lines) {\r\npr_warning("Warning: more than one --line options are"\r\n" detected. Only the first one is valid.\n");\r\nreturn 0;\r\n}\r\nparams.show_lines = true;\r\nret = parse_line_range_desc(str, &params.line_range);\r\nINIT_LIST_HEAD(&params.line_range.line_list);\r\nreturn ret;\r\n}\r\nstatic int opt_show_vars(const struct option *opt __used,\r\nconst char *str, int unset __used)\r\n{\r\nstruct perf_probe_event *pev = &params.events[params.nevents];\r\nint ret;\r\nif (!str)\r\nreturn 0;\r\nret = parse_probe_event(str);\r\nif (!ret && pev->nargs != 0) {\r\npr_err(" Error: '--vars' doesn't accept arguments.\n");\r\nreturn -EINVAL;\r\n}\r\nparams.show_vars = true;\r\nreturn ret;\r\n}\r\nstatic int opt_set_filter(const struct option *opt __used,\r\nconst char *str, int unset __used)\r\n{\r\nconst char *err;\r\nif (str) {\r\npr_debug2("Set filter: %s\n", str);\r\nif (params.filter)\r\nstrfilter__delete(params.filter);\r\nparams.filter = strfilter__new(str, &err);\r\nif (!params.filter) {\r\npr_err("Filter parse error at %td.\n", err - str + 1);\r\npr_err("Source: \"%s\"\n", str);\r\npr_err(" %*c\n", (int)(err - str + 1), '^');\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint cmd_probe(int argc, const char **argv, const char *prefix __used)\r\n{\r\nint ret;\r\nargc = parse_options(argc, argv, options, probe_usage,\r\nPARSE_OPT_STOP_AT_NON_OPTION);\r\nif (argc > 0) {\r\nif (strcmp(argv[0], "-") == 0) {\r\npr_warning(" Error: '-' is not supported.\n");\r\nusage_with_options(probe_usage, options);\r\n}\r\nret = parse_probe_event_argv(argc, argv);\r\nif (ret < 0) {\r\npr_err(" Error: Parse Error. (%d)\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nif (params.max_probe_points == 0)\r\nparams.max_probe_points = MAX_PROBES;\r\nif ((!params.nevents && !params.dellist && !params.list_events &&\r\n!params.show_lines && !params.show_funcs))\r\nusage_with_options(probe_usage, options);\r\nsymbol_conf.try_vmlinux_path = (symbol_conf.vmlinux_name == NULL);\r\nif (params.list_events) {\r\nif (params.mod_events) {\r\npr_err(" Error: Don't use --list with --add/--del.\n");\r\nusage_with_options(probe_usage, options);\r\n}\r\nif (params.show_lines) {\r\npr_err(" Error: Don't use --list with --line.\n");\r\nusage_with_options(probe_usage, options);\r\n}\r\nif (params.show_vars) {\r\npr_err(" Error: Don't use --list with --vars.\n");\r\nusage_with_options(probe_usage, options);\r\n}\r\nif (params.show_funcs) {\r\npr_err(" Error: Don't use --list with --funcs.\n");\r\nusage_with_options(probe_usage, options);\r\n}\r\nret = show_perf_probe_events();\r\nif (ret < 0)\r\npr_err(" Error: Failed to show event list. (%d)\n",\r\nret);\r\nreturn ret;\r\n}\r\nif (params.show_funcs) {\r\nif (params.nevents != 0 || params.dellist) {\r\npr_err(" Error: Don't use --funcs with"\r\n" --add/--del.\n");\r\nusage_with_options(probe_usage, options);\r\n}\r\nif (params.show_lines) {\r\npr_err(" Error: Don't use --funcs with --line.\n");\r\nusage_with_options(probe_usage, options);\r\n}\r\nif (params.show_vars) {\r\npr_err(" Error: Don't use --funcs with --vars.\n");\r\nusage_with_options(probe_usage, options);\r\n}\r\nif (!params.filter)\r\nparams.filter = strfilter__new(DEFAULT_FUNC_FILTER,\r\nNULL);\r\nret = show_available_funcs(params.target_module,\r\nparams.filter);\r\nstrfilter__delete(params.filter);\r\nif (ret < 0)\r\npr_err(" Error: Failed to show functions."\r\n" (%d)\n", ret);\r\nreturn ret;\r\n}\r\n#ifdef DWARF_SUPPORT\r\nif (params.show_lines) {\r\nif (params.mod_events) {\r\npr_err(" Error: Don't use --line with"\r\n" --add/--del.\n");\r\nusage_with_options(probe_usage, options);\r\n}\r\nif (params.show_vars) {\r\npr_err(" Error: Don't use --line with --vars.\n");\r\nusage_with_options(probe_usage, options);\r\n}\r\nret = show_line_range(&params.line_range, params.target_module);\r\nif (ret < 0)\r\npr_err(" Error: Failed to show lines. (%d)\n", ret);\r\nreturn ret;\r\n}\r\nif (params.show_vars) {\r\nif (params.mod_events) {\r\npr_err(" Error: Don't use --vars with"\r\n" --add/--del.\n");\r\nusage_with_options(probe_usage, options);\r\n}\r\nif (!params.filter)\r\nparams.filter = strfilter__new(DEFAULT_VAR_FILTER,\r\nNULL);\r\nret = show_available_vars(params.events, params.nevents,\r\nparams.max_probe_points,\r\nparams.target_module,\r\nparams.filter,\r\nparams.show_ext_vars);\r\nstrfilter__delete(params.filter);\r\nif (ret < 0)\r\npr_err(" Error: Failed to show vars. (%d)\n", ret);\r\nreturn ret;\r\n}\r\n#endif\r\nif (params.dellist) {\r\nret = del_perf_probe_events(params.dellist);\r\nstrlist__delete(params.dellist);\r\nif (ret < 0) {\r\npr_err(" Error: Failed to delete events. (%d)\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nif (params.nevents) {\r\nret = add_perf_probe_events(params.events, params.nevents,\r\nparams.max_probe_points,\r\nparams.target_module,\r\nparams.force_add);\r\nif (ret < 0) {\r\npr_err(" Error: Failed to add events. (%d)\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}

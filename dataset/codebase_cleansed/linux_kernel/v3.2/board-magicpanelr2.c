static int __init ethernet_reset_finished(void)\r\n{\r\nint i;\r\nif (LAN9115_READY)\r\nreturn 1;\r\nfor (i = 0; i < 10; ++i) {\r\nmdelay(10);\r\nif (LAN9115_READY)\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __init reset_ethernet(void)\r\n{\r\nCLRBITS_OUTB(0x10, PORT_PMDR);\r\nudelay(200);\r\nSETBITS_OUTB(0x10, PORT_PMDR);\r\n}\r\nstatic void __init setup_chip_select(void)\r\n{\r\n__raw_writel(0x36db0400, CS2BCR);\r\n__raw_writel(0x000003c0, CS2WCR);\r\n__raw_writel(0x00000200, CS4BCR);\r\n__raw_writel(0x00100981, CS4WCR);\r\n__raw_writel(0x00000200, CS5ABCR);\r\n__raw_writel(0x00100981, CS5AWCR);\r\n__raw_writel(0x00000200, CS5BBCR);\r\n__raw_writel(0x00100981, CS5BWCR);\r\n__raw_writel(0x00000200, CS6ABCR);\r\n__raw_writel(0x001009C1, CS6AWCR);\r\n}\r\nstatic void __init setup_port_multiplexing(void)\r\n{\r\n__raw_writew(0x5555, PORT_PACR);\r\n__raw_writew(0x5555, PORT_PBCR);\r\n__raw_writew(0x5500, PORT_PCCR);\r\n__raw_writew(0x5555, PORT_PDCR);\r\n__raw_writew(0x3C00, PORT_PECR);\r\n__raw_writew(0x0002, PORT_PFCR);\r\n__raw_writew(0x03D5, PORT_PGCR);\r\n__raw_writew(0x0050, PORT_PHCR);\r\n__raw_writew(0x0000, PORT_PJCR);\r\n__raw_writew(0x00FF, PORT_PKCR);\r\n__raw_writew(0x0000, PORT_PLCR);\r\n__raw_writew(0x5552, PORT_PMCR);\r\n#if CONFIG_SH_MAGIC_PANEL_R2_VERSION == 2\r\n__raw_writeb(0x30, PORT_PMDR);\r\n#elif CONFIG_SH_MAGIC_PANEL_R2_VERSION == 3\r\n__raw_writeb(0xF0, PORT_PMDR);\r\n#else\r\n#error Unknown revision of PLATFORM_MP_R2\r\n#endif\r\n__raw_writew(0x0100, PORT_PPCR);\r\n__raw_writeb(0x10, PORT_PPDR);\r\ngpio_request(GPIO_FN_A25, NULL);\r\ngpio_request(GPIO_FN_A24, NULL);\r\ngpio_request(GPIO_FN_A23, NULL);\r\ngpio_request(GPIO_FN_A22, NULL);\r\ngpio_request(GPIO_FN_A21, NULL);\r\ngpio_request(GPIO_FN_A20, NULL);\r\ngpio_request(GPIO_FN_A19, NULL);\r\ngpio_request(GPIO_FN_A0, NULL);\r\n__raw_writew(0x0140, PORT_PSCR);\r\n__raw_writew(0x0001, PORT_PTCR);\r\n__raw_writew(0x0240, PORT_PUCR);\r\n__raw_writew(0x0142, PORT_PVCR);\r\n}\r\nstatic void __init mpr2_setup(char **cmdline_p)\r\n{\r\n__raw_writew(0xAABC, PORT_PSELA);\r\n__raw_writew(0x3C00, PORT_PSELB);\r\n__raw_writew(0x0000, PORT_PSELC);\r\n__raw_writew(0x0000, PORT_PSELD);\r\n__raw_writew(0x0101, PORT_UTRCTL);\r\n__raw_writew(0xA5C0, PORT_UCLKCR_W);\r\nsetup_chip_select();\r\nsetup_port_multiplexing();\r\nreset_ethernet();\r\nprintk(KERN_INFO "Magic Panel Release 2 A.%i\n",\r\nCONFIG_SH_MAGIC_PANEL_R2_VERSION);\r\nif (ethernet_reset_finished() == 0)\r\nprintk(KERN_WARNING "Ethernet not ready\n");\r\n}\r\nstatic void __init set_mtd_partitions(void)\r\n{\r\nint nr_parts = 0;\r\nsimple_map_init(&mpr2_flash_map);\r\nflash_mtd = do_map_probe("cfi_probe", &mpr2_flash_map);\r\nnr_parts = parse_mtd_partitions(flash_mtd, probes,\r\n&parsed_partitions, 0);\r\nif (nr_parts <= 0) {\r\nflash_data.parts = mpr2_partitions;\r\nflash_data.nr_parts = ARRAY_SIZE(mpr2_partitions);\r\n} else {\r\nflash_data.nr_parts = nr_parts;\r\nflash_data.parts = parsed_partitions;\r\n}\r\n}\r\nstatic int __init mpr2_devices_setup(void)\r\n{\r\nset_mtd_partitions();\r\nreturn platform_add_devices(mpr2_devices, ARRAY_SIZE(mpr2_devices));\r\n}\r\nstatic void __init init_mpr2_IRQ(void)\r\n{\r\nplat_irq_setup_pins(IRQ_MODE_IRQ);\r\nirq_set_irq_type(32, IRQ_TYPE_LEVEL_LOW);\r\nirq_set_irq_type(33, IRQ_TYPE_LEVEL_LOW);\r\nirq_set_irq_type(34, IRQ_TYPE_LEVEL_LOW);\r\nirq_set_irq_type(35, IRQ_TYPE_LEVEL_LOW);\r\nirq_set_irq_type(36, IRQ_TYPE_EDGE_RISING);\r\nirq_set_irq_type(37, IRQ_TYPE_EDGE_FALLING);\r\nintc_set_priority(32, 13);\r\nintc_set_priority(33, 13);\r\nintc_set_priority(34, 13);\r\nintc_set_priority(35, 6);\r\n}

static unsigned int bm_find(struct ts_config *conf, struct ts_state *state)\r\n{\r\nstruct ts_bm *bm = ts_config_priv(conf);\r\nunsigned int i, text_len, consumed = state->offset;\r\nconst u8 *text;\r\nint shift = bm->patlen - 1, bs;\r\nconst u8 icase = conf->flags & TS_IGNORECASE;\r\nfor (;;) {\r\ntext_len = conf->get_next_block(consumed, &text, conf, state);\r\nif (unlikely(text_len == 0))\r\nbreak;\r\nwhile (shift < text_len) {\r\nDEBUGP("Searching in position %d (%c)\n",\r\nshift, text[shift]);\r\nfor (i = 0; i < bm->patlen; i++)\r\nif ((icase ? toupper(text[shift-i])\r\n: text[shift-i])\r\n!= bm->pattern[bm->patlen-1-i])\r\ngoto next;\r\nDEBUGP("found!\n");\r\nreturn consumed += (shift-(bm->patlen-1));\r\nnext: bs = bm->bad_shift[text[shift-i]];\r\nshift = max_t(int, shift-i+bs, shift+bm->good_shift[i]);\r\n}\r\nconsumed += text_len;\r\n}\r\nreturn UINT_MAX;\r\n}\r\nstatic int subpattern(u8 *pattern, int i, int j, int g)\r\n{\r\nint x = i+g-1, y = j+g-1, ret = 0;\r\nwhile(pattern[x--] == pattern[y--]) {\r\nif (y < 0) {\r\nret = 1;\r\nbreak;\r\n}\r\nif (--g == 0) {\r\nret = pattern[i-1] != pattern[j-1];\r\nbreak;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic void compute_prefix_tbl(struct ts_bm *bm, int flags)\r\n{\r\nint i, j, g;\r\nfor (i = 0; i < ASIZE; i++)\r\nbm->bad_shift[i] = bm->patlen;\r\nfor (i = 0; i < bm->patlen - 1; i++) {\r\nbm->bad_shift[bm->pattern[i]] = bm->patlen - 1 - i;\r\nif (flags & TS_IGNORECASE)\r\nbm->bad_shift[tolower(bm->pattern[i])]\r\n= bm->patlen - 1 - i;\r\n}\r\nbm->good_shift[0] = 1;\r\nfor (i = 1; i < bm->patlen; i++)\r\nbm->good_shift[i] = bm->patlen;\r\nfor (i = bm->patlen-1, g = 1; i > 0; g++, i--) {\r\nfor (j = i-1; j >= 1-g ; j--)\r\nif (subpattern(bm->pattern, i, j, g)) {\r\nbm->good_shift[g] = bm->patlen-j-g;\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic struct ts_config *bm_init(const void *pattern, unsigned int len,\r\ngfp_t gfp_mask, int flags)\r\n{\r\nstruct ts_config *conf;\r\nstruct ts_bm *bm;\r\nint i;\r\nunsigned int prefix_tbl_len = len * sizeof(unsigned int);\r\nsize_t priv_size = sizeof(*bm) + len + prefix_tbl_len;\r\nconf = alloc_ts_config(priv_size, gfp_mask);\r\nif (IS_ERR(conf))\r\nreturn conf;\r\nconf->flags = flags;\r\nbm = ts_config_priv(conf);\r\nbm->patlen = len;\r\nbm->pattern = (u8 *) bm->good_shift + prefix_tbl_len;\r\nif (flags & TS_IGNORECASE)\r\nfor (i = 0; i < len; i++)\r\nbm->pattern[i] = toupper(((u8 *)pattern)[i]);\r\nelse\r\nmemcpy(bm->pattern, pattern, len);\r\ncompute_prefix_tbl(bm, flags);\r\nreturn conf;\r\n}\r\nstatic void *bm_get_pattern(struct ts_config *conf)\r\n{\r\nstruct ts_bm *bm = ts_config_priv(conf);\r\nreturn bm->pattern;\r\n}\r\nstatic unsigned int bm_get_pattern_len(struct ts_config *conf)\r\n{\r\nstruct ts_bm *bm = ts_config_priv(conf);\r\nreturn bm->patlen;\r\n}\r\nstatic int __init init_bm(void)\r\n{\r\nreturn textsearch_register(&bm_ops);\r\n}\r\nstatic void __exit exit_bm(void)\r\n{\r\ntextsearch_unregister(&bm_ops);\r\n}

static inline void emc_writel(u32 val, unsigned long addr)\r\n{\r\nwritel(val, emc + addr);\r\n}\r\nstatic inline u32 emc_readl(unsigned long addr)\r\n{\r\nreturn readl(emc + addr);\r\n}\r\nlong tegra_emc_round_rate(unsigned long rate)\r\n{\r\nint i;\r\nint best = -1;\r\nunsigned long distance = ULONG_MAX;\r\nif (!tegra_emc_table)\r\nreturn -EINVAL;\r\nif (!emc_enable)\r\nreturn -EINVAL;\r\npr_debug("%s: %lu\n", __func__, rate);\r\nrate = rate / 2 / 1000;\r\nfor (i = 0; i < tegra_emc_table_size; i++) {\r\nif (tegra_emc_table[i].rate >= rate &&\r\n(tegra_emc_table[i].rate - rate) < distance) {\r\ndistance = tegra_emc_table[i].rate - rate;\r\nbest = i;\r\n}\r\n}\r\nif (best < 0)\r\nreturn -EINVAL;\r\npr_debug("%s: using %lu\n", __func__, tegra_emc_table[best].rate);\r\nreturn tegra_emc_table[best].rate * 2 * 1000;\r\n}\r\nint tegra_emc_set_rate(unsigned long rate)\r\n{\r\nint i;\r\nint j;\r\nif (!tegra_emc_table)\r\nreturn -EINVAL;\r\nrate = rate / 2 / 1000;\r\nfor (i = 0; i < tegra_emc_table_size; i++)\r\nif (tegra_emc_table[i].rate == rate)\r\nbreak;\r\nif (i >= tegra_emc_table_size)\r\nreturn -EINVAL;\r\npr_debug("%s: setting to %lu\n", __func__, rate);\r\nfor (j = 0; j < TEGRA_EMC_NUM_REGS; j++)\r\nemc_writel(tegra_emc_table[i].regs[j], emc_reg_addr[j]);\r\nemc_readl(tegra_emc_table[i].regs[TEGRA_EMC_NUM_REGS - 1]);\r\nreturn 0;\r\n}\r\nvoid tegra_init_emc(const struct tegra_emc_table *table, int table_size)\r\n{\r\ntegra_emc_table = table;\r\ntegra_emc_table_size = table_size;\r\n}

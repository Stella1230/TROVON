static void release_platform_dev(struct device * dev)\r\n{\r\ndev_dbg(dev, "sl811_cs platform_dev release\n");\r\ndev->parent = NULL;\r\n}\r\nstatic int sl811_hc_init(struct device *parent, resource_size_t base_addr,\r\nint irq)\r\n{\r\nif (platform_dev.dev.parent)\r\nreturn -EBUSY;\r\nplatform_dev.dev.parent = parent;\r\nresources[0].start = irq;\r\nresources[1].start = base_addr;\r\nresources[1].end = base_addr;\r\nresources[2].start = base_addr + 1;\r\nresources[2].end = base_addr + 1;\r\nplatform_dev.name = sl811h_driver.driver.name;\r\nreturn platform_device_register(&platform_dev);\r\n}\r\nstatic void sl811_cs_detach(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "sl811_cs_detach\n");\r\nsl811_cs_release(link);\r\nkfree(link->priv);\r\n}\r\nstatic void sl811_cs_release(struct pcmcia_device * link)\r\n{\r\ndev_dbg(&link->dev, "sl811_cs_release\n");\r\npcmcia_disable_device(link);\r\nplatform_device_unregister(&platform_dev);\r\n}\r\nstatic int sl811_cs_config_check(struct pcmcia_device *p_dev, void *priv_data)\r\n{\r\nif (p_dev->config_index == 0)\r\nreturn -EINVAL;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic int sl811_cs_config(struct pcmcia_device *link)\r\n{\r\nstruct device *parent = &link->dev;\r\nint ret;\r\ndev_dbg(&link->dev, "sl811_cs_config\n");\r\nlink->config_flags |= CONF_ENABLE_IRQ | CONF_AUTO_SET_VPP |\r\nCONF_AUTO_CHECK_VCC | CONF_AUTO_SET_IO;\r\nif (pcmcia_loop_config(link, sl811_cs_config_check, NULL))\r\ngoto failed;\r\nif (resource_size(link->resource[0]) < 2)\r\ngoto failed;\r\nif (!link->irq)\r\ngoto failed;\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\nif (sl811_hc_init(parent, link->resource[0]->start, link->irq)\r\n< 0) {\r\nfailed:\r\nprintk(KERN_WARNING "sl811_cs_config failed\n");\r\nsl811_cs_release(link);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sl811_cs_probe(struct pcmcia_device *link)\r\n{\r\nlocal_info_t *local;\r\nlocal = kzalloc(sizeof(local_info_t), GFP_KERNEL);\r\nif (!local)\r\nreturn -ENOMEM;\r\nlocal->p_dev = link;\r\nlink->priv = local;\r\nreturn sl811_cs_config(link);\r\n}\r\nstatic int __init init_sl811_cs(void)\r\n{\r\nreturn pcmcia_register_driver(&sl811_cs_driver);\r\n}\r\nstatic void __exit exit_sl811_cs(void)\r\n{\r\npcmcia_unregister_driver(&sl811_cs_driver);\r\n}

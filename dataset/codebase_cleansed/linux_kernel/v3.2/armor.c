static int encode_bits(int c)\r\n{\r\nreturn pem_key[c];\r\n}\r\nstatic int decode_bits(char c)\r\n{\r\nif (c >= 'A' && c <= 'Z')\r\nreturn c - 'A';\r\nif (c >= 'a' && c <= 'z')\r\nreturn c - 'a' + 26;\r\nif (c >= '0' && c <= '9')\r\nreturn c - '0' + 52;\r\nif (c == '+')\r\nreturn 62;\r\nif (c == '/')\r\nreturn 63;\r\nif (c == '=')\r\nreturn 0;\r\nreturn -EINVAL;\r\n}\r\nint ceph_armor(char *dst, const char *src, const char *end)\r\n{\r\nint olen = 0;\r\nint line = 0;\r\nwhile (src < end) {\r\nunsigned char a, b, c;\r\na = *src++;\r\n*dst++ = encode_bits(a >> 2);\r\nif (src < end) {\r\nb = *src++;\r\n*dst++ = encode_bits(((a & 3) << 4) | (b >> 4));\r\nif (src < end) {\r\nc = *src++;\r\n*dst++ = encode_bits(((b & 15) << 2) |\r\n(c >> 6));\r\n*dst++ = encode_bits(c & 63);\r\n} else {\r\n*dst++ = encode_bits((b & 15) << 2);\r\n*dst++ = '=';\r\n}\r\n} else {\r\n*dst++ = encode_bits(((a & 3) << 4));\r\n*dst++ = '=';\r\n*dst++ = '=';\r\n}\r\nolen += 4;\r\nline += 4;\r\nif (line == 64) {\r\nline = 0;\r\n*(dst++) = '\n';\r\nolen++;\r\n}\r\n}\r\nreturn olen;\r\n}\r\nint ceph_unarmor(char *dst, const char *src, const char *end)\r\n{\r\nint olen = 0;\r\nwhile (src < end) {\r\nint a, b, c, d;\r\nif (src[0] == '\n') {\r\nsrc++;\r\ncontinue;\r\n}\r\nif (src + 4 > end)\r\nreturn -EINVAL;\r\na = decode_bits(src[0]);\r\nb = decode_bits(src[1]);\r\nc = decode_bits(src[2]);\r\nd = decode_bits(src[3]);\r\nif (a < 0 || b < 0 || c < 0 || d < 0)\r\nreturn -EINVAL;\r\n*dst++ = (a << 2) | (b >> 4);\r\nif (src[2] == '=')\r\nreturn olen + 1;\r\n*dst++ = ((b & 15) << 4) | (c >> 2);\r\nif (src[3] == '=')\r\nreturn olen + 2;\r\n*dst++ = ((c & 3) << 6) | d;\r\nolen += 3;\r\nsrc += 4;\r\n}\r\nreturn olen;\r\n}

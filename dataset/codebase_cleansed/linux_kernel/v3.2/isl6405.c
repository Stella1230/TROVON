static int isl6405_set_voltage(struct dvb_frontend *fe, fe_sec_voltage_t voltage)\r\n{\r\nstruct isl6405 *isl6405 = (struct isl6405 *) fe->sec_priv;\r\nstruct i2c_msg msg = { .addr = isl6405->i2c_addr, .flags = 0,\r\n.buf = &isl6405->config,\r\n.len = sizeof(isl6405->config) };\r\nif (isl6405->override_or & 0x80) {\r\nisl6405->config &= ~(ISL6405_VSEL2 | ISL6405_EN2);\r\nswitch (voltage) {\r\ncase SEC_VOLTAGE_OFF:\r\nbreak;\r\ncase SEC_VOLTAGE_13:\r\nisl6405->config |= ISL6405_EN2;\r\nbreak;\r\ncase SEC_VOLTAGE_18:\r\nisl6405->config |= (ISL6405_EN2 | ISL6405_VSEL2);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n} else {\r\nisl6405->config &= ~(ISL6405_VSEL1 | ISL6405_EN1);\r\nswitch (voltage) {\r\ncase SEC_VOLTAGE_OFF:\r\nbreak;\r\ncase SEC_VOLTAGE_13:\r\nisl6405->config |= ISL6405_EN1;\r\nbreak;\r\ncase SEC_VOLTAGE_18:\r\nisl6405->config |= (ISL6405_EN1 | ISL6405_VSEL1);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n};\r\n}\r\nisl6405->config |= isl6405->override_or;\r\nisl6405->config &= isl6405->override_and;\r\nreturn (i2c_transfer(isl6405->i2c, &msg, 1) == 1) ? 0 : -EIO;\r\n}\r\nstatic int isl6405_enable_high_lnb_voltage(struct dvb_frontend *fe, long arg)\r\n{\r\nstruct isl6405 *isl6405 = (struct isl6405 *) fe->sec_priv;\r\nstruct i2c_msg msg = { .addr = isl6405->i2c_addr, .flags = 0,\r\n.buf = &isl6405->config,\r\n.len = sizeof(isl6405->config) };\r\nif (isl6405->override_or & 0x80) {\r\nif (arg)\r\nisl6405->config |= ISL6405_LLC2;\r\nelse\r\nisl6405->config &= ~ISL6405_LLC2;\r\n} else {\r\nif (arg)\r\nisl6405->config |= ISL6405_LLC1;\r\nelse\r\nisl6405->config &= ~ISL6405_LLC1;\r\n}\r\nisl6405->config |= isl6405->override_or;\r\nisl6405->config &= isl6405->override_and;\r\nreturn (i2c_transfer(isl6405->i2c, &msg, 1) == 1) ? 0 : -EIO;\r\n}\r\nstatic void isl6405_release(struct dvb_frontend *fe)\r\n{\r\nisl6405_set_voltage(fe, SEC_VOLTAGE_OFF);\r\nkfree(fe->sec_priv);\r\nfe->sec_priv = NULL;\r\n}\r\nstruct dvb_frontend *isl6405_attach(struct dvb_frontend *fe, struct i2c_adapter *i2c,\r\nu8 i2c_addr, u8 override_set, u8 override_clear)\r\n{\r\nstruct isl6405 *isl6405 = kmalloc(sizeof(struct isl6405), GFP_KERNEL);\r\nif (!isl6405)\r\nreturn NULL;\r\nif (override_set & 0x80)\r\nisl6405->config = ISL6405_ISEL2;\r\nelse\r\nisl6405->config = ISL6405_ISEL1;\r\nisl6405->i2c = i2c;\r\nisl6405->i2c_addr = i2c_addr;\r\nfe->sec_priv = isl6405;\r\nisl6405->override_or = override_set;\r\nisl6405->override_and = ~override_clear;\r\nif (isl6405_set_voltage(fe, SEC_VOLTAGE_OFF)) {\r\nkfree(isl6405);\r\nfe->sec_priv = NULL;\r\nreturn NULL;\r\n}\r\nfe->ops.release_sec = isl6405_release;\r\nfe->ops.set_voltage = isl6405_set_voltage;\r\nfe->ops.enable_high_lnb_voltage = isl6405_enable_high_lnb_voltage;\r\nreturn fe;\r\n}

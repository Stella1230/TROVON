static void *ixp2000_uengine_csr_area(int uengine)\r\n{\r\nreturn ((void *)IXP_UENGINE_CSR_VIRT_BASE) + (uengine << 10);\r\n}\r\nu32 ixp2000_uengine_csr_read(int uengine, int offset)\r\n{\r\nvoid *uebase;\r\nu32 *local_csr_status;\r\nu32 *reg;\r\nu32 value;\r\nuebase = ixp2000_uengine_csr_area(uengine);\r\nlocal_csr_status = (u32 *)(uebase + LOCAL_CSR_STATUS);\r\nreg = (u32 *)(uebase + offset);\r\ndo {\r\nvalue = ixp2000_reg_read(reg);\r\n} while (ixp2000_reg_read(local_csr_status) & 1);\r\nreturn value;\r\n}\r\nvoid ixp2000_uengine_csr_write(int uengine, int offset, u32 value)\r\n{\r\nvoid *uebase;\r\nu32 *local_csr_status;\r\nu32 *reg;\r\nuebase = ixp2000_uengine_csr_area(uengine);\r\nlocal_csr_status = (u32 *)(uebase + LOCAL_CSR_STATUS);\r\nreg = (u32 *)(uebase + offset);\r\ndo {\r\nixp2000_reg_write(reg, value);\r\n} while (ixp2000_reg_read(local_csr_status) & 1);\r\n}\r\nvoid ixp2000_uengine_reset(u32 uengine_mask)\r\n{\r\nu32 value;\r\nvalue = ixp2000_reg_read(IXP_RESET1) & ~ixp2000_uengine_mask;\r\nuengine_mask &= ixp2000_uengine_mask;\r\nixp2000_reg_wrb(IXP_RESET1, value | uengine_mask);\r\nixp2000_reg_wrb(IXP_RESET1, value);\r\n}\r\nvoid ixp2000_uengine_set_mode(int uengine, u32 mode)\r\n{\r\nmode |= 0x10000000;\r\nixp2000_uengine_csr_write(uengine, CTX_ENABLES, mode);\r\nixp2000_uengine_csr_write(uengine, CC_ENABLE, 0x00002000);\r\nixp2000_uengine_csr_write(uengine, NN_PUT, 0x00);\r\nixp2000_uengine_csr_write(uengine, NN_GET, 0x00);\r\nixp2000_uengine_csr_write(uengine, T_INDEX_BYTE_INDEX, 0);\r\n}\r\nstatic int make_even_parity(u32 x)\r\n{\r\nreturn hweight32(x) & 1;\r\n}\r\nstatic void ustore_write(int uengine, u64 insn)\r\n{\r\ninsn |= (u64)make_even_parity((insn >> 20) & 0x000fffff) << 41;\r\ninsn |= (u64)make_even_parity(insn & 0x000fffff) << 40;\r\nixp2000_uengine_csr_write(uengine, USTORE_DATA_LOWER, (u32)insn);\r\nixp2000_uengine_csr_write(uengine, USTORE_DATA_UPPER, (u32)(insn >> 32));\r\n}\r\nvoid ixp2000_uengine_load_microcode(int uengine, u8 *ucode, int insns)\r\n{\r\nint i;\r\nixp2000_uengine_csr_write(uengine, USTORE_ADDRESS, 0x80000000);\r\nfor (i = 0; i < insns; i++) {\r\nu64 insn;\r\ninsn = (((u64)ucode[0]) << 32) |\r\n(((u64)ucode[1]) << 24) |\r\n(((u64)ucode[2]) << 16) |\r\n(((u64)ucode[3]) << 8) |\r\n((u64)ucode[4]);\r\nucode += 5;\r\nustore_write(uengine, insn);\r\n}\r\nfor (i = 0; i < 4; i++) {\r\nu32 addr;\r\naddr = ixp2000_uengine_csr_read(uengine, USTORE_ADDRESS);\r\nif (addr == 0x80000000)\r\nbreak;\r\nustore_write(uengine, 0xf0000c0300ULL);\r\n}\r\nixp2000_uengine_csr_write(uengine, USTORE_ADDRESS, 0x00000000);\r\n}\r\nvoid ixp2000_uengine_init_context(int uengine, int context, int pc)\r\n{\r\nixp2000_uengine_csr_write(uengine, CSR_CTX_POINTER, context);\r\nixp2000_uengine_csr_write(uengine, INDIRECT_CTX_SIG_EVENTS, 1);\r\nixp2000_uengine_csr_write(uengine, INDIRECT_CTX_WAKEUP_EVENTS, 1);\r\nixp2000_uengine_csr_write(uengine, INDIRECT_CTX_STS, pc);\r\n}\r\nvoid ixp2000_uengine_start_contexts(int uengine, u8 ctx_mask)\r\n{\r\nu32 mask;\r\nmask = ixp2000_uengine_csr_read(uengine, CTX_ENABLES);\r\nmask |= ctx_mask << 8;\r\nixp2000_uengine_csr_write(uengine, CTX_ENABLES, mask);\r\n}\r\nvoid ixp2000_uengine_stop_contexts(int uengine, u8 ctx_mask)\r\n{\r\nu32 mask;\r\nmask = ixp2000_uengine_csr_read(uengine, CTX_ENABLES);\r\nmask &= ~(ctx_mask << 8);\r\nixp2000_uengine_csr_write(uengine, CTX_ENABLES, mask);\r\n}\r\nstatic int check_ixp_type(struct ixp2000_uengine_code *c)\r\n{\r\nu32 product_id;\r\nu32 rev;\r\nproduct_id = ixp2000_reg_read(IXP_PRODUCT_ID);\r\nif (((product_id >> 16) & 0x1f) != 0)\r\nreturn 0;\r\nswitch ((product_id >> 8) & 0xff) {\r\n#ifdef CONFIG_ARCH_IXP2000\r\ncase 0:\r\nif (!(c->cpu_model_bitmask & 4))\r\nreturn 0;\r\nbreak;\r\ncase 1:\r\nif (!(c->cpu_model_bitmask & 8))\r\nreturn 0;\r\nbreak;\r\ncase 2:\r\nif (!(c->cpu_model_bitmask & 2))\r\nreturn 0;\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_ARCH_IXP23XX\r\ncase 4:\r\nif (!(c->cpu_model_bitmask & 0x3f0))\r\nreturn 0;\r\nbreak;\r\n#endif\r\ndefault:\r\nreturn 0;\r\n}\r\nrev = product_id & 0xff;\r\nif (rev < c->cpu_min_revision || rev > c->cpu_max_revision)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic void generate_ucode(u8 *ucode, u32 *gpr_a, u32 *gpr_b)\r\n{\r\nint offset;\r\nint i;\r\noffset = 0;\r\nfor (i = 0; i < 128; i++) {\r\nu8 b3;\r\nu8 b2;\r\nu8 b1;\r\nu8 b0;\r\nb3 = (gpr_a[i] >> 24) & 0xff;\r\nb2 = (gpr_a[i] >> 16) & 0xff;\r\nb1 = (gpr_a[i] >> 8) & 0xff;\r\nb0 = gpr_a[i] & 0xff;\r\nucode[offset++] = 0xf0;\r\nucode[offset++] = (b1 >> 4);\r\nucode[offset++] = (b1 << 4) | 0x0c | (b0 >> 6);\r\nucode[offset++] = (b0 << 2);\r\nucode[offset++] = 0x80 | i;\r\nucode[offset++] = 0xf4;\r\nucode[offset++] = 0x40 | (b3 >> 4);\r\nucode[offset++] = (b3 << 4) | 0x0c | (b2 >> 6);\r\nucode[offset++] = (b2 << 2);\r\nucode[offset++] = 0x80 | i;\r\n}\r\nfor (i = 0; i < 128; i++) {\r\nu8 b3;\r\nu8 b2;\r\nu8 b1;\r\nu8 b0;\r\nb3 = (gpr_b[i] >> 24) & 0xff;\r\nb2 = (gpr_b[i] >> 16) & 0xff;\r\nb1 = (gpr_b[i] >> 8) & 0xff;\r\nb0 = gpr_b[i] & 0xff;\r\nucode[offset++] = 0xf0;\r\nucode[offset++] = (b1 >> 4);\r\nucode[offset++] = (b1 << 4) | 0x02 | (i >> 6);\r\nucode[offset++] = (i << 2) | 0x03;\r\nucode[offset++] = b0;\r\nucode[offset++] = 0xf4;\r\nucode[offset++] = 0x40 | (b3 >> 4);\r\nucode[offset++] = (b3 << 4) | 0x02 | (i >> 6);\r\nucode[offset++] = (i << 2) | 0x03;\r\nucode[offset++] = b2;\r\n}\r\nucode[offset++] = 0xe0;\r\nucode[offset++] = 0x00;\r\nucode[offset++] = 0x01;\r\nucode[offset++] = 0x00;\r\nucode[offset++] = 0x00;\r\n}\r\nstatic int set_initial_registers(int uengine, struct ixp2000_uengine_code *c)\r\n{\r\nint per_ctx_regs;\r\nu32 *gpr_a;\r\nu32 *gpr_b;\r\nu8 *ucode;\r\nint i;\r\ngpr_a = kzalloc(128 * sizeof(u32), GFP_KERNEL);\r\ngpr_b = kzalloc(128 * sizeof(u32), GFP_KERNEL);\r\nucode = kmalloc(513 * 5, GFP_KERNEL);\r\nif (gpr_a == NULL || gpr_b == NULL || ucode == NULL) {\r\nkfree(ucode);\r\nkfree(gpr_b);\r\nkfree(gpr_a);\r\nreturn 1;\r\n}\r\nper_ctx_regs = 16;\r\nif (c->uengine_parameters & IXP2000_UENGINE_4_CONTEXTS)\r\nper_ctx_regs = 32;\r\nfor (i = 0; i < 256; i++) {\r\nstruct ixp2000_reg_value *r = c->initial_reg_values + i;\r\nu32 *bank;\r\nint inc;\r\nint j;\r\nif (r->reg == -1)\r\nbreak;\r\nbank = (r->reg & 0x400) ? gpr_b : gpr_a;\r\ninc = (r->reg & 0x80) ? 128 : per_ctx_regs;\r\nj = r->reg & 0x7f;\r\nwhile (j < 128) {\r\nbank[j] = r->value;\r\nj += inc;\r\n}\r\n}\r\ngenerate_ucode(ucode, gpr_a, gpr_b);\r\nixp2000_uengine_load_microcode(uengine, ucode, 513);\r\nixp2000_uengine_init_context(uengine, 0, 0);\r\nixp2000_uengine_start_contexts(uengine, 0x01);\r\nfor (i = 0; i < 100; i++) {\r\nu32 status;\r\nstatus = ixp2000_uengine_csr_read(uengine, ACTIVE_CTX_STS);\r\nif (!(status & 0x80000000))\r\nbreak;\r\n}\r\nixp2000_uengine_stop_contexts(uengine, 0x01);\r\nkfree(ucode);\r\nkfree(gpr_b);\r\nkfree(gpr_a);\r\nreturn !!(i == 100);\r\n}\r\nint ixp2000_uengine_load(int uengine, struct ixp2000_uengine_code *c)\r\n{\r\nint ctx;\r\nif (!check_ixp_type(c))\r\nreturn 1;\r\nif (!(ixp2000_uengine_mask & (1 << uengine)))\r\nreturn 1;\r\nixp2000_uengine_reset(1 << uengine);\r\nixp2000_uengine_set_mode(uengine, c->uengine_parameters);\r\nif (set_initial_registers(uengine, c))\r\nreturn 1;\r\nixp2000_uengine_load_microcode(uengine, c->insns, c->num_insns);\r\nfor (ctx = 0; ctx < 8; ctx++)\r\nixp2000_uengine_init_context(uengine, ctx, 0);\r\nreturn 0;\r\n}\r\nstatic int __init ixp2000_uengine_init(void)\r\n{\r\nint uengine;\r\nu32 value;\r\nswitch ((ixp2000_reg_read(IXP_PRODUCT_ID) >> 8) & 0x1fff) {\r\n#ifdef CONFIG_ARCH_IXP2000\r\ncase 0:\r\ncase 1:\r\nixp2000_uengine_mask = 0x00ff00ff;\r\nbreak;\r\ncase 2:\r\nixp2000_uengine_mask = 0x000f000f;\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_ARCH_IXP23XX\r\ncase 4:\r\nixp2000_uengine_mask = (*IXP23XX_EXP_CFG_FUSE >> 8) & 0xf;\r\nbreak;\r\n#endif\r\ndefault:\r\nprintk(KERN_INFO "Detected unknown IXP2000 model (%.8x)\n",\r\n(unsigned int)ixp2000_reg_read(IXP_PRODUCT_ID));\r\nixp2000_uengine_mask = 0x00000000;\r\nbreak;\r\n}\r\nixp2000_uengine_reset(ixp2000_uengine_mask);\r\nvalue = ixp2000_reg_read(IXP_MISC_CONTROL);\r\nixp2000_reg_wrb(IXP_MISC_CONTROL, value & ~0x80);\r\nfor (uengine = 0; uengine < 32; uengine++) {\r\nif (ixp2000_uengine_mask & (1 << uengine)) {\r\nixp2000_uengine_csr_write(uengine, TIMESTAMP_LOW, 0);\r\nixp2000_uengine_csr_write(uengine, TIMESTAMP_HIGH, 0);\r\n}\r\n}\r\nixp2000_reg_wrb(IXP_MISC_CONTROL, value | 0x80);\r\nreturn 0;\r\n}

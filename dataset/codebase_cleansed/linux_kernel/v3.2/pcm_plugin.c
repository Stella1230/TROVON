static int rate_match(unsigned int src_rate, unsigned int dst_rate)\r\n{\r\nunsigned int low = (src_rate * 95) / 100;\r\nunsigned int high = (src_rate * 105) / 100;\r\nreturn dst_rate >= low && dst_rate <= high;\r\n}\r\nstatic int snd_pcm_plugin_alloc(struct snd_pcm_plugin *plugin, snd_pcm_uframes_t frames)\r\n{\r\nstruct snd_pcm_plugin_format *format;\r\nssize_t width;\r\nsize_t size;\r\nunsigned int channel;\r\nstruct snd_pcm_plugin_channel *c;\r\nif (plugin->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nformat = &plugin->src_format;\r\n} else {\r\nformat = &plugin->dst_format;\r\n}\r\nif ((width = snd_pcm_format_physical_width(format->format)) < 0)\r\nreturn width;\r\nsize = frames * format->channels * width;\r\nif (snd_BUG_ON(size % 8))\r\nreturn -ENXIO;\r\nsize /= 8;\r\nif (plugin->buf_frames < frames) {\r\nvfree(plugin->buf);\r\nplugin->buf = vmalloc(size);\r\nplugin->buf_frames = frames;\r\n}\r\nif (!plugin->buf) {\r\nplugin->buf_frames = 0;\r\nreturn -ENOMEM;\r\n}\r\nc = plugin->buf_channels;\r\nif (plugin->access == SNDRV_PCM_ACCESS_RW_INTERLEAVED) {\r\nfor (channel = 0; channel < format->channels; channel++, c++) {\r\nc->frames = frames;\r\nc->enabled = 1;\r\nc->wanted = 0;\r\nc->area.addr = plugin->buf;\r\nc->area.first = channel * width;\r\nc->area.step = format->channels * width;\r\n}\r\n} else if (plugin->access == SNDRV_PCM_ACCESS_RW_NONINTERLEAVED) {\r\nif (snd_BUG_ON(size % format->channels))\r\nreturn -EINVAL;\r\nsize /= format->channels;\r\nfor (channel = 0; channel < format->channels; channel++, c++) {\r\nc->frames = frames;\r\nc->enabled = 1;\r\nc->wanted = 0;\r\nc->area.addr = plugin->buf + (channel * size);\r\nc->area.first = 0;\r\nc->area.step = width;\r\n}\r\n} else\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nint snd_pcm_plug_alloc(struct snd_pcm_substream *plug, snd_pcm_uframes_t frames)\r\n{\r\nint err;\r\nif (snd_BUG_ON(!snd_pcm_plug_first(plug)))\r\nreturn -ENXIO;\r\nif (snd_pcm_plug_stream(plug) == SNDRV_PCM_STREAM_PLAYBACK) {\r\nstruct snd_pcm_plugin *plugin = snd_pcm_plug_first(plug);\r\nwhile (plugin->next) {\r\nif (plugin->dst_frames)\r\nframes = plugin->dst_frames(plugin, frames);\r\nif (snd_BUG_ON(frames <= 0))\r\nreturn -ENXIO;\r\nplugin = plugin->next;\r\nerr = snd_pcm_plugin_alloc(plugin, frames);\r\nif (err < 0)\r\nreturn err;\r\n}\r\n} else {\r\nstruct snd_pcm_plugin *plugin = snd_pcm_plug_last(plug);\r\nwhile (plugin->prev) {\r\nif (plugin->src_frames)\r\nframes = plugin->src_frames(plugin, frames);\r\nif (snd_BUG_ON(frames <= 0))\r\nreturn -ENXIO;\r\nplugin = plugin->prev;\r\nerr = snd_pcm_plugin_alloc(plugin, frames);\r\nif (err < 0)\r\nreturn err;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nsnd_pcm_sframes_t snd_pcm_plugin_client_channels(struct snd_pcm_plugin *plugin,\r\nsnd_pcm_uframes_t frames,\r\nstruct snd_pcm_plugin_channel **channels)\r\n{\r\n*channels = plugin->buf_channels;\r\nreturn frames;\r\n}\r\nint snd_pcm_plugin_build(struct snd_pcm_substream *plug,\r\nconst char *name,\r\nstruct snd_pcm_plugin_format *src_format,\r\nstruct snd_pcm_plugin_format *dst_format,\r\nsize_t extra,\r\nstruct snd_pcm_plugin **ret)\r\n{\r\nstruct snd_pcm_plugin *plugin;\r\nunsigned int channels;\r\nif (snd_BUG_ON(!plug))\r\nreturn -ENXIO;\r\nif (snd_BUG_ON(!src_format || !dst_format))\r\nreturn -ENXIO;\r\nplugin = kzalloc(sizeof(*plugin) + extra, GFP_KERNEL);\r\nif (plugin == NULL)\r\nreturn -ENOMEM;\r\nplugin->name = name;\r\nplugin->plug = plug;\r\nplugin->stream = snd_pcm_plug_stream(plug);\r\nplugin->access = SNDRV_PCM_ACCESS_RW_INTERLEAVED;\r\nplugin->src_format = *src_format;\r\nplugin->src_width = snd_pcm_format_physical_width(src_format->format);\r\nsnd_BUG_ON(plugin->src_width <= 0);\r\nplugin->dst_format = *dst_format;\r\nplugin->dst_width = snd_pcm_format_physical_width(dst_format->format);\r\nsnd_BUG_ON(plugin->dst_width <= 0);\r\nif (plugin->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nchannels = src_format->channels;\r\nelse\r\nchannels = dst_format->channels;\r\nplugin->buf_channels = kcalloc(channels, sizeof(*plugin->buf_channels), GFP_KERNEL);\r\nif (plugin->buf_channels == NULL) {\r\nsnd_pcm_plugin_free(plugin);\r\nreturn -ENOMEM;\r\n}\r\nplugin->client_channels = snd_pcm_plugin_client_channels;\r\n*ret = plugin;\r\nreturn 0;\r\n}\r\nint snd_pcm_plugin_free(struct snd_pcm_plugin *plugin)\r\n{\r\nif (! plugin)\r\nreturn 0;\r\nif (plugin->private_free)\r\nplugin->private_free(plugin);\r\nkfree(plugin->buf_channels);\r\nvfree(plugin->buf);\r\nkfree(plugin);\r\nreturn 0;\r\n}\r\nsnd_pcm_sframes_t snd_pcm_plug_client_size(struct snd_pcm_substream *plug, snd_pcm_uframes_t drv_frames)\r\n{\r\nstruct snd_pcm_plugin *plugin, *plugin_prev, *plugin_next;\r\nint stream = snd_pcm_plug_stream(plug);\r\nif (snd_BUG_ON(!plug))\r\nreturn -ENXIO;\r\nif (drv_frames == 0)\r\nreturn 0;\r\nif (stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nplugin = snd_pcm_plug_last(plug);\r\nwhile (plugin && drv_frames > 0) {\r\nplugin_prev = plugin->prev;\r\nif (plugin->src_frames)\r\ndrv_frames = plugin->src_frames(plugin, drv_frames);\r\nplugin = plugin_prev;\r\n}\r\n} else if (stream == SNDRV_PCM_STREAM_CAPTURE) {\r\nplugin = snd_pcm_plug_first(plug);\r\nwhile (plugin && drv_frames > 0) {\r\nplugin_next = plugin->next;\r\nif (plugin->dst_frames)\r\ndrv_frames = plugin->dst_frames(plugin, drv_frames);\r\nplugin = plugin_next;\r\n}\r\n} else\r\nsnd_BUG();\r\nreturn drv_frames;\r\n}\r\nsnd_pcm_sframes_t snd_pcm_plug_slave_size(struct snd_pcm_substream *plug, snd_pcm_uframes_t clt_frames)\r\n{\r\nstruct snd_pcm_plugin *plugin, *plugin_prev, *plugin_next;\r\nsnd_pcm_sframes_t frames;\r\nint stream = snd_pcm_plug_stream(plug);\r\nif (snd_BUG_ON(!plug))\r\nreturn -ENXIO;\r\nif (clt_frames == 0)\r\nreturn 0;\r\nframes = clt_frames;\r\nif (stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nplugin = snd_pcm_plug_first(plug);\r\nwhile (plugin && frames > 0) {\r\nplugin_next = plugin->next;\r\nif (plugin->dst_frames) {\r\nframes = plugin->dst_frames(plugin, frames);\r\nif (frames < 0)\r\nreturn frames;\r\n}\r\nplugin = plugin_next;\r\n}\r\n} else if (stream == SNDRV_PCM_STREAM_CAPTURE) {\r\nplugin = snd_pcm_plug_last(plug);\r\nwhile (plugin) {\r\nplugin_prev = plugin->prev;\r\nif (plugin->src_frames) {\r\nframes = plugin->src_frames(plugin, frames);\r\nif (frames < 0)\r\nreturn frames;\r\n}\r\nplugin = plugin_prev;\r\n}\r\n} else\r\nsnd_BUG();\r\nreturn frames;\r\n}\r\nstatic int snd_pcm_plug_formats(struct snd_mask *mask, snd_pcm_format_t format)\r\n{\r\nstruct snd_mask formats = *mask;\r\nu64 linfmts = (SNDRV_PCM_FMTBIT_U8 | SNDRV_PCM_FMTBIT_S8 |\r\nSNDRV_PCM_FMTBIT_U16_LE | SNDRV_PCM_FMTBIT_S16_LE |\r\nSNDRV_PCM_FMTBIT_U16_BE | SNDRV_PCM_FMTBIT_S16_BE |\r\nSNDRV_PCM_FMTBIT_U24_LE | SNDRV_PCM_FMTBIT_S24_LE |\r\nSNDRV_PCM_FMTBIT_U24_BE | SNDRV_PCM_FMTBIT_S24_BE |\r\nSNDRV_PCM_FMTBIT_U24_3LE | SNDRV_PCM_FMTBIT_S24_3LE |\r\nSNDRV_PCM_FMTBIT_U24_3BE | SNDRV_PCM_FMTBIT_S24_3BE |\r\nSNDRV_PCM_FMTBIT_U32_LE | SNDRV_PCM_FMTBIT_S32_LE |\r\nSNDRV_PCM_FMTBIT_U32_BE | SNDRV_PCM_FMTBIT_S32_BE);\r\nsnd_mask_set(&formats, (__force int)SNDRV_PCM_FORMAT_MU_LAW);\r\nif (formats.bits[0] & (u32)linfmts)\r\nformats.bits[0] |= (u32)linfmts;\r\nif (formats.bits[1] & (u32)(linfmts >> 32))\r\nformats.bits[1] |= (u32)(linfmts >> 32);\r\nreturn snd_mask_test(&formats, (__force int)format);\r\n}\r\nsnd_pcm_format_t snd_pcm_plug_slave_format(snd_pcm_format_t format,\r\nstruct snd_mask *format_mask)\r\n{\r\nint i;\r\nif (snd_mask_test(format_mask, (__force int)format))\r\nreturn format;\r\nif (!snd_pcm_plug_formats(format_mask, format))\r\nreturn (__force snd_pcm_format_t)-EINVAL;\r\nif (snd_pcm_format_linear(format)) {\r\nunsigned int width = snd_pcm_format_width(format);\r\nint unsignd = snd_pcm_format_unsigned(format) > 0;\r\nint big = snd_pcm_format_big_endian(format) > 0;\r\nunsigned int badness, best = -1;\r\nsnd_pcm_format_t best_format = (__force snd_pcm_format_t)-1;\r\nfor (i = 0; i < ARRAY_SIZE(preferred_formats); i++) {\r\nsnd_pcm_format_t f = preferred_formats[i];\r\nunsigned int w;\r\nif (!snd_mask_test(format_mask, (__force int)f))\r\ncontinue;\r\nw = snd_pcm_format_width(f);\r\nif (w >= width)\r\nbadness = w - width;\r\nelse\r\nbadness = width - w + 32;\r\nbadness += snd_pcm_format_unsigned(f) != unsignd;\r\nbadness += snd_pcm_format_big_endian(f) != big;\r\nif (badness < best) {\r\nbest_format = f;\r\nbest = badness;\r\n}\r\n}\r\nif ((__force int)best_format >= 0)\r\nreturn best_format;\r\nelse\r\nreturn (__force snd_pcm_format_t)-EINVAL;\r\n} else {\r\nswitch (format) {\r\ncase SNDRV_PCM_FORMAT_MU_LAW:\r\nfor (i = 0; i < ARRAY_SIZE(preferred_formats); ++i) {\r\nsnd_pcm_format_t format1 = preferred_formats[i];\r\nif (snd_mask_test(format_mask, (__force int)format1))\r\nreturn format1;\r\n}\r\ndefault:\r\nreturn (__force snd_pcm_format_t)-EINVAL;\r\n}\r\n}\r\n}\r\nint snd_pcm_plug_format_plugins(struct snd_pcm_substream *plug,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_pcm_hw_params *slave_params)\r\n{\r\nstruct snd_pcm_plugin_format tmpformat;\r\nstruct snd_pcm_plugin_format dstformat;\r\nstruct snd_pcm_plugin_format srcformat;\r\nsnd_pcm_access_t src_access, dst_access;\r\nstruct snd_pcm_plugin *plugin = NULL;\r\nint err;\r\nint stream = snd_pcm_plug_stream(plug);\r\nint slave_interleaved = (params_channels(slave_params) == 1 ||\r\nparams_access(slave_params) == SNDRV_PCM_ACCESS_RW_INTERLEAVED);\r\nswitch (stream) {\r\ncase SNDRV_PCM_STREAM_PLAYBACK:\r\ndstformat.format = params_format(slave_params);\r\ndstformat.rate = params_rate(slave_params);\r\ndstformat.channels = params_channels(slave_params);\r\nsrcformat.format = params_format(params);\r\nsrcformat.rate = params_rate(params);\r\nsrcformat.channels = params_channels(params);\r\nsrc_access = SNDRV_PCM_ACCESS_RW_INTERLEAVED;\r\ndst_access = (slave_interleaved ? SNDRV_PCM_ACCESS_RW_INTERLEAVED :\r\nSNDRV_PCM_ACCESS_RW_NONINTERLEAVED);\r\nbreak;\r\ncase SNDRV_PCM_STREAM_CAPTURE:\r\ndstformat.format = params_format(params);\r\ndstformat.rate = params_rate(params);\r\ndstformat.channels = params_channels(params);\r\nsrcformat.format = params_format(slave_params);\r\nsrcformat.rate = params_rate(slave_params);\r\nsrcformat.channels = params_channels(slave_params);\r\nsrc_access = (slave_interleaved ? SNDRV_PCM_ACCESS_RW_INTERLEAVED :\r\nSNDRV_PCM_ACCESS_RW_NONINTERLEAVED);\r\ndst_access = SNDRV_PCM_ACCESS_RW_INTERLEAVED;\r\nbreak;\r\ndefault:\r\nsnd_BUG();\r\nreturn -EINVAL;\r\n}\r\ntmpformat = srcformat;\r\npdprintf("srcformat: format=%i, rate=%i, channels=%i\n",\r\nsrcformat.format,\r\nsrcformat.rate,\r\nsrcformat.channels);\r\npdprintf("dstformat: format=%i, rate=%i, channels=%i\n",\r\ndstformat.format,\r\ndstformat.rate,\r\ndstformat.channels);\r\nif (! rate_match(srcformat.rate, dstformat.rate) &&\r\n! snd_pcm_format_linear(srcformat.format)) {\r\nif (srcformat.format != SNDRV_PCM_FORMAT_MU_LAW)\r\nreturn -EINVAL;\r\ntmpformat.format = SNDRV_PCM_FORMAT_S16;\r\nerr = snd_pcm_plugin_build_mulaw(plug,\r\n&srcformat, &tmpformat,\r\n&plugin);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_pcm_plugin_append(plugin);\r\nif (err < 0) {\r\nsnd_pcm_plugin_free(plugin);\r\nreturn err;\r\n}\r\nsrcformat = tmpformat;\r\nsrc_access = dst_access;\r\n}\r\nif (srcformat.channels > dstformat.channels) {\r\ntmpformat.channels = dstformat.channels;\r\nerr = snd_pcm_plugin_build_route(plug, &srcformat, &tmpformat, &plugin);\r\npdprintf("channels reduction: src=%i, dst=%i returns %i\n", srcformat.channels, tmpformat.channels, err);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_pcm_plugin_append(plugin);\r\nif (err < 0) {\r\nsnd_pcm_plugin_free(plugin);\r\nreturn err;\r\n}\r\nsrcformat = tmpformat;\r\nsrc_access = dst_access;\r\n}\r\nif (!rate_match(srcformat.rate, dstformat.rate)) {\r\nif (srcformat.format != SNDRV_PCM_FORMAT_S16) {\r\ntmpformat.format = SNDRV_PCM_FORMAT_S16;\r\nerr = snd_pcm_plugin_build_linear(plug,\r\n&srcformat, &tmpformat,\r\n&plugin);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_pcm_plugin_append(plugin);\r\nif (err < 0) {\r\nsnd_pcm_plugin_free(plugin);\r\nreturn err;\r\n}\r\nsrcformat = tmpformat;\r\nsrc_access = dst_access;\r\n}\r\ntmpformat.rate = dstformat.rate;\r\nerr = snd_pcm_plugin_build_rate(plug,\r\n&srcformat, &tmpformat,\r\n&plugin);\r\npdprintf("rate down resampling: src=%i, dst=%i returns %i\n", srcformat.rate, tmpformat.rate, err);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_pcm_plugin_append(plugin);\r\nif (err < 0) {\r\nsnd_pcm_plugin_free(plugin);\r\nreturn err;\r\n}\r\nsrcformat = tmpformat;\r\nsrc_access = dst_access;\r\n}\r\nif (srcformat.format != dstformat.format) {\r\ntmpformat.format = dstformat.format;\r\nif (srcformat.format == SNDRV_PCM_FORMAT_MU_LAW ||\r\ntmpformat.format == SNDRV_PCM_FORMAT_MU_LAW) {\r\nerr = snd_pcm_plugin_build_mulaw(plug,\r\n&srcformat, &tmpformat,\r\n&plugin);\r\n}\r\nelse if (snd_pcm_format_linear(srcformat.format) &&\r\nsnd_pcm_format_linear(tmpformat.format)) {\r\nerr = snd_pcm_plugin_build_linear(plug,\r\n&srcformat, &tmpformat,\r\n&plugin);\r\n}\r\nelse\r\nreturn -EINVAL;\r\npdprintf("format change: src=%i, dst=%i returns %i\n", srcformat.format, tmpformat.format, err);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_pcm_plugin_append(plugin);\r\nif (err < 0) {\r\nsnd_pcm_plugin_free(plugin);\r\nreturn err;\r\n}\r\nsrcformat = tmpformat;\r\nsrc_access = dst_access;\r\n}\r\nif (srcformat.channels < dstformat.channels) {\r\ntmpformat.channels = dstformat.channels;\r\nerr = snd_pcm_plugin_build_route(plug, &srcformat, &tmpformat, &plugin);\r\npdprintf("channels extension: src=%i, dst=%i returns %i\n", srcformat.channels, tmpformat.channels, err);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_pcm_plugin_append(plugin);\r\nif (err < 0) {\r\nsnd_pcm_plugin_free(plugin);\r\nreturn err;\r\n}\r\nsrcformat = tmpformat;\r\nsrc_access = dst_access;\r\n}\r\nif (src_access != dst_access) {\r\nerr = snd_pcm_plugin_build_copy(plug,\r\n&srcformat,\r\n&tmpformat,\r\n&plugin);\r\npdprintf("interleave change (copy: returns %i)\n", err);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_pcm_plugin_append(plugin);\r\nif (err < 0) {\r\nsnd_pcm_plugin_free(plugin);\r\nreturn err;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nsnd_pcm_sframes_t snd_pcm_plug_client_channels_buf(struct snd_pcm_substream *plug,\r\nchar *buf,\r\nsnd_pcm_uframes_t count,\r\nstruct snd_pcm_plugin_channel **channels)\r\n{\r\nstruct snd_pcm_plugin *plugin;\r\nstruct snd_pcm_plugin_channel *v;\r\nstruct snd_pcm_plugin_format *format;\r\nint width, nchannels, channel;\r\nint stream = snd_pcm_plug_stream(plug);\r\nif (snd_BUG_ON(!buf))\r\nreturn -ENXIO;\r\nif (stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nplugin = snd_pcm_plug_first(plug);\r\nformat = &plugin->src_format;\r\n} else {\r\nplugin = snd_pcm_plug_last(plug);\r\nformat = &plugin->dst_format;\r\n}\r\nv = plugin->buf_channels;\r\n*channels = v;\r\nif ((width = snd_pcm_format_physical_width(format->format)) < 0)\r\nreturn width;\r\nnchannels = format->channels;\r\nif (snd_BUG_ON(plugin->access != SNDRV_PCM_ACCESS_RW_INTERLEAVED &&\r\nformat->channels > 1))\r\nreturn -ENXIO;\r\nfor (channel = 0; channel < nchannels; channel++, v++) {\r\nv->frames = count;\r\nv->enabled = 1;\r\nv->wanted = (stream == SNDRV_PCM_STREAM_CAPTURE);\r\nv->area.addr = buf;\r\nv->area.first = channel * width;\r\nv->area.step = nchannels * width;\r\n}\r\nreturn count;\r\n}\r\nsnd_pcm_sframes_t snd_pcm_plug_write_transfer(struct snd_pcm_substream *plug, struct snd_pcm_plugin_channel *src_channels, snd_pcm_uframes_t size)\r\n{\r\nstruct snd_pcm_plugin *plugin, *next;\r\nstruct snd_pcm_plugin_channel *dst_channels;\r\nint err;\r\nsnd_pcm_sframes_t frames = size;\r\nplugin = snd_pcm_plug_first(plug);\r\nwhile (plugin && frames > 0) {\r\nif ((next = plugin->next) != NULL) {\r\nsnd_pcm_sframes_t frames1 = frames;\r\nif (plugin->dst_frames)\r\nframes1 = plugin->dst_frames(plugin, frames);\r\nif ((err = next->client_channels(next, frames1, &dst_channels)) < 0) {\r\nreturn err;\r\n}\r\nif (err != frames1) {\r\nframes = err;\r\nif (plugin->src_frames)\r\nframes = plugin->src_frames(plugin, frames1);\r\n}\r\n} else\r\ndst_channels = NULL;\r\npdprintf("write plugin: %s, %li\n", plugin->name, frames);\r\nif ((frames = plugin->transfer(plugin, src_channels, dst_channels, frames)) < 0)\r\nreturn frames;\r\nsrc_channels = dst_channels;\r\nplugin = next;\r\n}\r\nreturn snd_pcm_plug_client_size(plug, frames);\r\n}\r\nsnd_pcm_sframes_t snd_pcm_plug_read_transfer(struct snd_pcm_substream *plug, struct snd_pcm_plugin_channel *dst_channels_final, snd_pcm_uframes_t size)\r\n{\r\nstruct snd_pcm_plugin *plugin, *next;\r\nstruct snd_pcm_plugin_channel *src_channels, *dst_channels;\r\nsnd_pcm_sframes_t frames = size;\r\nint err;\r\nframes = snd_pcm_plug_slave_size(plug, frames);\r\nif (frames < 0)\r\nreturn frames;\r\nsrc_channels = NULL;\r\nplugin = snd_pcm_plug_first(plug);\r\nwhile (plugin && frames > 0) {\r\nif ((next = plugin->next) != NULL) {\r\nif ((err = plugin->client_channels(plugin, frames, &dst_channels)) < 0) {\r\nreturn err;\r\n}\r\nframes = err;\r\n} else {\r\ndst_channels = dst_channels_final;\r\n}\r\npdprintf("read plugin: %s, %li\n", plugin->name, frames);\r\nif ((frames = plugin->transfer(plugin, src_channels, dst_channels, frames)) < 0)\r\nreturn frames;\r\nplugin = next;\r\nsrc_channels = dst_channels;\r\n}\r\nreturn frames;\r\n}\r\nint snd_pcm_area_silence(const struct snd_pcm_channel_area *dst_area, size_t dst_offset,\r\nsize_t samples, snd_pcm_format_t format)\r\n{\r\nunsigned char *dst;\r\nunsigned int dst_step;\r\nint width;\r\nconst unsigned char *silence;\r\nif (!dst_area->addr)\r\nreturn 0;\r\ndst = dst_area->addr + (dst_area->first + dst_area->step * dst_offset) / 8;\r\nwidth = snd_pcm_format_physical_width(format);\r\nif (width <= 0)\r\nreturn -EINVAL;\r\nif (dst_area->step == (unsigned int) width && width >= 8)\r\nreturn snd_pcm_format_set_silence(format, dst, samples);\r\nsilence = snd_pcm_format_silence_64(format);\r\nif (! silence)\r\nreturn -EINVAL;\r\ndst_step = dst_area->step / 8;\r\nif (width == 4) {\r\nint dstbit = dst_area->first % 8;\r\nint dstbit_step = dst_area->step % 8;\r\nwhile (samples-- > 0) {\r\nif (dstbit)\r\n*dst &= 0xf0;\r\nelse\r\n*dst &= 0x0f;\r\ndst += dst_step;\r\ndstbit += dstbit_step;\r\nif (dstbit == 8) {\r\ndst++;\r\ndstbit = 0;\r\n}\r\n}\r\n} else {\r\nwidth /= 8;\r\nwhile (samples-- > 0) {\r\nmemcpy(dst, silence, width);\r\ndst += dst_step;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint snd_pcm_area_copy(const struct snd_pcm_channel_area *src_area, size_t src_offset,\r\nconst struct snd_pcm_channel_area *dst_area, size_t dst_offset,\r\nsize_t samples, snd_pcm_format_t format)\r\n{\r\nchar *src, *dst;\r\nint width;\r\nint src_step, dst_step;\r\nsrc = src_area->addr + (src_area->first + src_area->step * src_offset) / 8;\r\nif (!src_area->addr)\r\nreturn snd_pcm_area_silence(dst_area, dst_offset, samples, format);\r\ndst = dst_area->addr + (dst_area->first + dst_area->step * dst_offset) / 8;\r\nif (!dst_area->addr)\r\nreturn 0;\r\nwidth = snd_pcm_format_physical_width(format);\r\nif (width <= 0)\r\nreturn -EINVAL;\r\nif (src_area->step == (unsigned int) width &&\r\ndst_area->step == (unsigned int) width && width >= 8) {\r\nsize_t bytes = samples * width / 8;\r\nmemcpy(dst, src, bytes);\r\nreturn 0;\r\n}\r\nsrc_step = src_area->step / 8;\r\ndst_step = dst_area->step / 8;\r\nif (width == 4) {\r\nint srcbit = src_area->first % 8;\r\nint srcbit_step = src_area->step % 8;\r\nint dstbit = dst_area->first % 8;\r\nint dstbit_step = dst_area->step % 8;\r\nwhile (samples-- > 0) {\r\nunsigned char srcval;\r\nif (srcbit)\r\nsrcval = *src & 0x0f;\r\nelse\r\nsrcval = (*src & 0xf0) >> 4;\r\nif (dstbit)\r\n*dst = (*dst & 0xf0) | srcval;\r\nelse\r\n*dst = (*dst & 0x0f) | (srcval << 4);\r\nsrc += src_step;\r\nsrcbit += srcbit_step;\r\nif (srcbit == 8) {\r\nsrc++;\r\nsrcbit = 0;\r\n}\r\ndst += dst_step;\r\ndstbit += dstbit_step;\r\nif (dstbit == 8) {\r\ndst++;\r\ndstbit = 0;\r\n}\r\n}\r\n} else {\r\nwidth /= 8;\r\nwhile (samples-- > 0) {\r\nmemcpy(dst, src, width);\r\nsrc += src_step;\r\ndst += dst_step;\r\n}\r\n}\r\nreturn 0;\r\n}

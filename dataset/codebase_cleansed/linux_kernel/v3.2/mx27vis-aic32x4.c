static int mx27vis_aic32x4_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nint ret;\r\nu32 dai_format;\r\ndai_format = SND_SOC_DAIFMT_DSP_B | SND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CBM_CFM;\r\nsnd_soc_dai_set_fmt(codec_dai, dai_format);\r\nsnd_soc_dai_set_fmt(cpu_dai, dai_format);\r\nret = snd_soc_dai_set_sysclk(codec_dai, 0,\r\n25000000, SND_SOC_CLOCK_OUT);\r\nif (ret) {\r\npr_err("%s: failed setting codec sysclk\n", __func__);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_sysclk(cpu_dai, IMX_SSP_SYS_CLK, 0,\r\nSND_SOC_CLOCK_IN);\r\nif (ret) {\r\npr_err("can't set CPU system clock IMX_SSP_SYS_CLK\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init mx27vis_aic32x4_init(void)\r\n{\r\nint ret;\r\nmx27vis_aic32x4_snd_device = platform_device_alloc("soc-audio", -1);\r\nif (!mx27vis_aic32x4_snd_device)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(mx27vis_aic32x4_snd_device, &mx27vis_aic32x4);\r\nret = platform_device_add(mx27vis_aic32x4_snd_device);\r\nif (ret) {\r\nprintk(KERN_ERR "ASoC: Platform device allocation failed\n");\r\nplatform_device_put(mx27vis_aic32x4_snd_device);\r\n}\r\nmxc_audmux_v1_configure_port(MX27_AUDMUX_HPCR1_SSI0,\r\nMXC_AUDMUX_V1_PCR_SYN |\r\nMXC_AUDMUX_V1_PCR_TFSDIR |\r\nMXC_AUDMUX_V1_PCR_TCLKDIR |\r\nMXC_AUDMUX_V1_PCR_TFCSEL(MX27_AUDMUX_PPCR1_SSI_PINS_1) |\r\nMXC_AUDMUX_V1_PCR_RXDSEL(MX27_AUDMUX_PPCR1_SSI_PINS_1)\r\n);\r\nmxc_audmux_v1_configure_port(MX27_AUDMUX_PPCR1_SSI_PINS_1,\r\nMXC_AUDMUX_V1_PCR_SYN |\r\nMXC_AUDMUX_V1_PCR_RXDSEL(MX27_AUDMUX_HPCR1_SSI0)\r\n);\r\nreturn ret;\r\n}\r\nstatic void __exit mx27vis_aic32x4_exit(void)\r\n{\r\nplatform_device_unregister(mx27vis_aic32x4_snd_device);\r\n}

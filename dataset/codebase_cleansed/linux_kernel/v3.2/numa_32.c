void memory_present(int nid, unsigned long start, unsigned long end)\r\n{\r\nunsigned long pfn;\r\nprintk(KERN_INFO "Node: %d, start_pfn: %lx, end_pfn: %lx\n",\r\nnid, start, end);\r\nprintk(KERN_DEBUG " Setting physnode_map array to node %d for pfns:\n", nid);\r\nprintk(KERN_DEBUG " ");\r\nfor (pfn = start; pfn < end; pfn += PAGES_PER_SECTION) {\r\nphysnode_map[pfn / PAGES_PER_SECTION] = nid;\r\nprintk(KERN_CONT "%lx ", pfn);\r\n}\r\nprintk(KERN_CONT "\n");\r\n}\r\nunsigned long node_memmap_size_bytes(int nid, unsigned long start_pfn,\r\nunsigned long end_pfn)\r\n{\r\nunsigned long nr_pages = end_pfn - start_pfn;\r\nif (!nr_pages)\r\nreturn 0;\r\nreturn (nr_pages + 1) * sizeof(struct page);\r\n}\r\nvoid *alloc_remap(int nid, unsigned long size)\r\n{\r\nvoid *allocation = node_remap_alloc_vaddr[nid];\r\nsize = ALIGN(size, L1_CACHE_BYTES);\r\nif (!allocation || (allocation + size) > node_remap_end_vaddr[nid])\r\nreturn NULL;\r\nnode_remap_alloc_vaddr[nid] += size;\r\nmemset(allocation, 0, size);\r\nreturn allocation;\r\n}\r\nvoid resume_map_numa_kva(pgd_t *pgd_base)\r\n{\r\nint node;\r\nfor_each_online_node(node) {\r\nunsigned long start_va, start_pfn, nr_pages, pfn;\r\nstart_va = (unsigned long)node_remap_start_vaddr[node];\r\nstart_pfn = node_remap_start_pfn[node];\r\nnr_pages = (node_remap_end_vaddr[node] -\r\nnode_remap_start_vaddr[node]) >> PAGE_SHIFT;\r\nprintk(KERN_DEBUG "%s: node %d\n", __func__, node);\r\nfor (pfn = 0; pfn < nr_pages; pfn += PTRS_PER_PTE) {\r\nunsigned long vaddr = start_va + (pfn << PAGE_SHIFT);\r\npgd_t *pgd = pgd_base + pgd_index(vaddr);\r\npud_t *pud = pud_offset(pgd, vaddr);\r\npmd_t *pmd = pmd_offset(pud, vaddr);\r\nset_pmd(pmd, pfn_pmd(start_pfn + pfn,\r\nPAGE_KERNEL_LARGE_EXEC));\r\nprintk(KERN_DEBUG "%s: %08lx -> pfn %08lx\n",\r\n__func__, vaddr, start_pfn + pfn);\r\n}\r\n}\r\n}\r\nvoid __init init_alloc_remap(int nid, u64 start, u64 end)\r\n{\r\nunsigned long start_pfn = start >> PAGE_SHIFT;\r\nunsigned long end_pfn = end >> PAGE_SHIFT;\r\nunsigned long size, pfn;\r\nu64 node_pa, remap_pa;\r\nvoid *remap_va;\r\nprintk(KERN_DEBUG "node %d pfn: [%lx - %lx]\n",\r\nnid, start_pfn, end_pfn);\r\nsize = node_memmap_size_bytes(nid, start_pfn, end_pfn);\r\nsize += ALIGN(sizeof(pg_data_t), PAGE_SIZE);\r\nsize = ALIGN(size, LARGE_PAGE_BYTES);\r\nnode_pa = memblock_find_in_range(start, end, size, LARGE_PAGE_BYTES);\r\nif (node_pa == MEMBLOCK_ERROR) {\r\npr_warning("remap_alloc: failed to allocate %lu bytes for node %d\n",\r\nsize, nid);\r\nreturn;\r\n}\r\nmemblock_x86_reserve_range(node_pa, node_pa + size, "KVA RAM");\r\nremap_pa = memblock_find_in_range(min_low_pfn << PAGE_SHIFT,\r\nmax_low_pfn << PAGE_SHIFT,\r\nsize, LARGE_PAGE_BYTES);\r\nif (remap_pa == MEMBLOCK_ERROR) {\r\npr_warning("remap_alloc: failed to allocate %lu bytes remap area for node %d\n",\r\nsize, nid);\r\nmemblock_x86_free_range(node_pa, node_pa + size);\r\nreturn;\r\n}\r\nmemblock_x86_reserve_range(remap_pa, remap_pa + size, "KVA PG");\r\nremap_va = phys_to_virt(remap_pa);\r\nfor (pfn = 0; pfn < size >> PAGE_SHIFT; pfn += PTRS_PER_PTE)\r\nset_pmd_pfn((unsigned long)remap_va + (pfn << PAGE_SHIFT),\r\n(node_pa >> PAGE_SHIFT) + pfn,\r\nPAGE_KERNEL_LARGE);\r\nnode_remap_start_pfn[nid] = node_pa >> PAGE_SHIFT;\r\nnode_remap_start_vaddr[nid] = remap_va;\r\nnode_remap_end_vaddr[nid] = remap_va + size;\r\nnode_remap_alloc_vaddr[nid] = remap_va;\r\nprintk(KERN_DEBUG "remap_alloc: node %d [%08llx-%08llx) -> [%p-%p)\n",\r\nnid, node_pa, node_pa + size, remap_va, remap_va + size);\r\n}\r\nvoid __init initmem_init(void)\r\n{\r\nx86_numa_init();\r\n#ifdef CONFIG_HIGHMEM\r\nhighstart_pfn = highend_pfn = max_pfn;\r\nif (max_pfn > max_low_pfn)\r\nhighstart_pfn = max_low_pfn;\r\nprintk(KERN_NOTICE "%ldMB HIGHMEM available.\n",\r\npages_to_mb(highend_pfn - highstart_pfn));\r\nnum_physpages = highend_pfn;\r\nhigh_memory = (void *) __va(highstart_pfn * PAGE_SIZE - 1) + 1;\r\n#else\r\nnum_physpages = max_low_pfn;\r\nhigh_memory = (void *) __va(max_low_pfn * PAGE_SIZE - 1) + 1;\r\n#endif\r\nprintk(KERN_NOTICE "%ldMB LOWMEM available.\n",\r\npages_to_mb(max_low_pfn));\r\nprintk(KERN_DEBUG "max_low_pfn = %lx, highstart_pfn = %lx\n",\r\nmax_low_pfn, highstart_pfn);\r\nprintk(KERN_DEBUG "Low memory ends at vaddr %08lx\n",\r\n(ulong) pfn_to_kaddr(max_low_pfn));\r\nprintk(KERN_DEBUG "High memory starts at vaddr %08lx\n",\r\n(ulong) pfn_to_kaddr(highstart_pfn));\r\nsetup_bootmem_allocator();\r\n}

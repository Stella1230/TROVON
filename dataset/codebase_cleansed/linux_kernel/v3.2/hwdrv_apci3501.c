int i_APCI3501_ReadDigitalInput(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int ui_Temp;\r\nunsigned int ui_NoOfChannel;\r\nui_NoOfChannel = CR_CHAN(insn->chanspec);\r\nui_Temp = data[0];\r\n*data = inl(devpriv->iobase + APCI3501_DIGITAL_IP);\r\nif (ui_Temp == 0) {\r\n*data = (*data >> ui_NoOfChannel) & 0x1;\r\n}\r\nelse {\r\nif (ui_Temp == 1) {\r\n*data = *data & 0x3;\r\n}\r\nelse {\r\nprintk("\nSpecified channel not supported \n");\r\n}\r\n}\r\nreturn insn->n;\r\n}\r\nint i_APCI3501_ConfigDigitalOutput(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif ((data[0] != 0) && (data[0] != 1)) {\r\ncomedi_error(dev,\r\n"Not a valid Data !!! ,Data should be 1 or 0\n");\r\nreturn -EINVAL;\r\n}\r\nif (data[0]) {\r\ndevpriv->b_OutputMemoryStatus = ADDIDATA_ENABLE;\r\n}\r\nelse {\r\ndevpriv->b_OutputMemoryStatus = ADDIDATA_DISABLE;\r\n}\r\nreturn insn->n;\r\n}\r\nint i_APCI3501_WriteDigitalOutput(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int ui_Temp, ui_Temp1;\r\nunsigned int ui_NoOfChannel = CR_CHAN(insn->chanspec);\r\nif (devpriv->b_OutputMemoryStatus) {\r\nui_Temp = inl(devpriv->iobase + APCI3501_DIGITAL_OP);\r\n}\r\nelse {\r\nui_Temp = 0;\r\n}\r\nif (data[3] == 0) {\r\nif (data[1] == 0) {\r\ndata[0] = (data[0] << ui_NoOfChannel) | ui_Temp;\r\noutl(data[0], devpriv->iobase + APCI3501_DIGITAL_OP);\r\n}\r\nelse {\r\nif (data[1] == 1) {\r\ndata[0] = (data[0] << (2 * data[2])) | ui_Temp;\r\noutl(data[0],\r\ndevpriv->iobase + APCI3501_DIGITAL_OP);\r\n}\r\nelse {\r\nprintk("\nSpecified channel not supported\n");\r\n}\r\n}\r\n}\r\nelse {\r\nif (data[3] == 1) {\r\nif (data[1] == 0) {\r\ndata[0] = ~data[0] & 0x1;\r\nui_Temp1 = 1;\r\nui_Temp1 = ui_Temp1 << ui_NoOfChannel;\r\nui_Temp = ui_Temp | ui_Temp1;\r\ndata[0] =\r\n(data[0] << ui_NoOfChannel) ^\r\n0xffffffff;\r\ndata[0] = data[0] & ui_Temp;\r\noutl(data[0],\r\ndevpriv->iobase + APCI3501_DIGITAL_OP);\r\n}\r\nelse {\r\nif (data[1] == 1) {\r\ndata[0] = ~data[0] & 0x3;\r\nui_Temp1 = 3;\r\nui_Temp1 = ui_Temp1 << 2 * data[2];\r\nui_Temp = ui_Temp | ui_Temp1;\r\ndata[0] =\r\n((data[0] << (2 *\r\ndata[2])) ^\r\n0xffffffff) & ui_Temp;\r\noutl(data[0],\r\ndevpriv->iobase +\r\nAPCI3501_DIGITAL_OP);\r\n}\r\nelse {\r\nprintk("\nSpecified channel not supported\n");\r\n}\r\n}\r\n}\r\nelse {\r\nprintk("\nSpecified functionality does not exist\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn insn->n;\r\n}\r\nint i_APCI3501_ReadDigitalOutput(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int ui_Temp;\r\nunsigned int ui_NoOfChannel;\r\nui_NoOfChannel = CR_CHAN(insn->chanspec);\r\nui_Temp = data[0];\r\n*data = inl(devpriv->iobase + APCI3501_DIGITAL_OP);\r\nif (ui_Temp == 0) {\r\n*data = (*data >> ui_NoOfChannel) & 0x1;\r\n}\r\nelse {\r\nif (ui_Temp == 1) {\r\n*data = *data & 0x3;\r\n}\r\nelse {\r\nprintk("\nSpecified channel not supported \n");\r\n}\r\n}\r\nreturn insn->n;\r\n}\r\nint i_APCI3501_ConfigAnalogOutput(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\noutl(data[0],\r\ndevpriv->iobase + APCI3501_ANALOG_OUTPUT +\r\nAPCI3501_AO_VOLT_MODE);\r\nif (data[0]) {\r\ndevpriv->b_InterruptMode = MODE1;\r\n} else {\r\ndevpriv->b_InterruptMode = MODE0;\r\n}\r\nreturn insn->n;\r\n}\r\nint i_APCI3501_WriteAnalogOutput(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int ul_Command1 = 0, ul_Channel_no, ul_Polarity, ul_DAC_Ready = 0;\r\nul_Channel_no = CR_CHAN(insn->chanspec);\r\nif (devpriv->b_InterruptMode == MODE1) {\r\nul_Polarity = 0x80000000;\r\nif ((*data < 0) || (*data > 16384)) {\r\nprintk("\nIn WriteAnalogOutput :: Not Valid Data\n");\r\n}\r\n}\r\nelse {\r\nul_Polarity = 0;\r\nif ((*data < 0) || (*data > 8192)) {\r\nprintk("\nIn WriteAnalogOutput :: Not Valid Data\n");\r\n}\r\n}\r\nif ((ul_Channel_no < 0) || (ul_Channel_no > 7)) {\r\nprintk("\nIn WriteAnalogOutput :: Not Valid Channel\n");\r\n}\r\nul_DAC_Ready = inl(devpriv->iobase + APCI3501_ANALOG_OUTPUT);\r\nwhile (ul_DAC_Ready == 0) {\r\nul_DAC_Ready = inl(devpriv->iobase + APCI3501_ANALOG_OUTPUT);\r\nul_DAC_Ready = (ul_DAC_Ready >> 8) & 1;\r\n}\r\nif (ul_DAC_Ready) {\r\nul_Command1 =\r\n(unsigned int) ((unsigned int) (ul_Channel_no & 0xFF) |\r\n(unsigned int) ((*data << 0x8) & 0x7FFFFF00L) |\r\n(unsigned int) (ul_Polarity));\r\noutl(ul_Command1,\r\ndevpriv->iobase + APCI3501_ANALOG_OUTPUT +\r\nAPCI3501_AO_PROG);\r\n}\r\nreturn insn->n;\r\n}\r\nint i_APCI3501_ConfigTimerCounterWatchdog(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int ul_Command1 = 0;\r\ndevpriv->tsk_Current = current;\r\nif (data[0] == ADDIDATA_WATCHDOG) {\r\ndevpriv->b_TimerSelectMode = ADDIDATA_WATCHDOG;\r\noutl(0x0, devpriv->iobase + APCI3501_WATCHDOG + APCI3501_TCW_PROG);\r\nif (data[1] == 1) {\r\noutl(0x02,\r\ndevpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\n} else {\r\noutl(0x0, devpriv->iobase + APCI3501_WATCHDOG + APCI3501_TCW_PROG);\r\n}\r\noutl(data[2],\r\ndevpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_TIMEBASE);\r\noutl(data[3],\r\ndevpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_RELOAD_VALUE);\r\nul_Command1 = inl(devpriv->iobase + APCI3501_WATCHDOG + APCI3501_TCW_PROG) | 0xFFF819E0UL;\r\noutl(ul_Command1,\r\ndevpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\n}\r\nelse if (data[0] == ADDIDATA_TIMER) {\r\nul_Command1 =\r\ninl(devpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\nul_Command1 = ul_Command1 & 0xFFFFF9FEUL;\r\noutl(ul_Command1, devpriv->iobase + APCI3501_WATCHDOG + APCI3501_TCW_PROG);\r\ndevpriv->b_TimerSelectMode = ADDIDATA_TIMER;\r\nif (data[1] == 1) {\r\noutl(0x02,\r\ndevpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\n} else {\r\noutl(0x0, devpriv->iobase + APCI3501_WATCHDOG + APCI3501_TCW_PROG);\r\n}\r\noutl(data[2],\r\ndevpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_TIMEBASE);\r\noutl(data[3],\r\ndevpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_RELOAD_VALUE);\r\nul_Command1 =\r\ninl(devpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\nul_Command1 =\r\n(ul_Command1 & 0xFFF719E2UL) | 2UL << 13UL | 0x10UL;\r\noutl(ul_Command1, devpriv->iobase + APCI3501_WATCHDOG + APCI3501_TCW_PROG);\r\n}\r\nreturn insn->n;\r\n}\r\nint i_APCI3501_StartStopWriteTimerCounterWatchdog(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int ul_Command1 = 0;\r\nint i_Temp;\r\nif (devpriv->b_TimerSelectMode == ADDIDATA_WATCHDOG) {\r\nif (data[1] == 1) {\r\nul_Command1 =\r\ninl(devpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\nul_Command1 = (ul_Command1 & 0xFFFFF9FFUL) | 0x1UL;\r\noutl(ul_Command1,\r\ndevpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\n}\r\nelse if (data[1] == 0)\r\n{\r\nul_Command1 =\r\ninl(devpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\nul_Command1 = ul_Command1 & 0xFFFFF9FEUL;\r\noutl(0x0,\r\ndevpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\n} else if (data[1] == 2) {\r\nul_Command1 =\r\ninl(devpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\nul_Command1 = (ul_Command1 & 0xFFFFF9FFUL) | 0x200UL;\r\noutl(ul_Command1,\r\ndevpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\n}\r\n}\r\nif (devpriv->b_TimerSelectMode == ADDIDATA_TIMER) {\r\nif (data[1] == 1) {\r\nul_Command1 =\r\ninl(devpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\nul_Command1 = (ul_Command1 & 0xFFFFF9FFUL) | 0x1UL;\r\noutl(ul_Command1,\r\ndevpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\n} else if (data[1] == 0) {\r\nul_Command1 =\r\ninl(devpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\nul_Command1 = ul_Command1 & 0xFFFFF9FEUL;\r\noutl(ul_Command1,\r\ndevpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\n}\r\nelse if (data[1] == 2) {\r\nul_Command1 =\r\ninl(devpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\nul_Command1 = (ul_Command1 & 0xFFFFF9FFUL) | 0x200UL;\r\noutl(ul_Command1,\r\ndevpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_PROG);\r\n}\r\n}\r\ni_Temp = inl(devpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_TRIG_STATUS) & 0x1;\r\nreturn insn->n;\r\n}\r\nint i_APCI3501_ReadTimerCounterWatchdog(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (devpriv->b_TimerSelectMode == ADDIDATA_WATCHDOG) {\r\ndata[0] =\r\ninl(devpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_TRIG_STATUS) & 0x1;\r\ndata[1] = inl(devpriv->iobase + APCI3501_WATCHDOG);\r\n}\r\nelse if (devpriv->b_TimerSelectMode == ADDIDATA_TIMER) {\r\ndata[0] =\r\ninl(devpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_TRIG_STATUS) & 0x1;\r\ndata[1] = inl(devpriv->iobase + APCI3501_WATCHDOG);\r\n}\r\nelse if ((devpriv->b_TimerSelectMode != ADDIDATA_TIMER)\r\n&& (devpriv->b_TimerSelectMode != ADDIDATA_WATCHDOG)) {\r\nprintk("\nIn ReadTimerCounterWatchdog :: Invalid Subdevice \n");\r\n}\r\nreturn insn->n;\r\n}\r\nint i_APCI3501_Reset(struct comedi_device *dev)\r\n{\r\nint i_Count = 0, i_temp = 0;\r\nunsigned int ul_Command1 = 0, ul_Polarity, ul_DAC_Ready = 0;\r\noutl(0x0, devpriv->iobase + APCI3501_DIGITAL_OP);\r\noutl(1, devpriv->iobase + APCI3501_ANALOG_OUTPUT +\r\nAPCI3501_AO_VOLT_MODE);\r\nul_Polarity = 0x80000000;\r\nfor (i_Count = 0; i_Count <= 7; i_Count++) {\r\nul_DAC_Ready = inl(devpriv->iobase + APCI3501_ANALOG_OUTPUT);\r\nwhile (ul_DAC_Ready == 0) {\r\nul_DAC_Ready =\r\ninl(devpriv->iobase + APCI3501_ANALOG_OUTPUT);\r\nul_DAC_Ready = (ul_DAC_Ready >> 8) & 1;\r\n}\r\nif (ul_DAC_Ready) {\r\nul_Command1 =\r\n(unsigned int) ((unsigned int) (i_Count & 0xFF) |\r\n(unsigned int) ((i_temp << 0x8) & 0x7FFFFF00L) |\r\n(unsigned int) (ul_Polarity));\r\noutl(ul_Command1,\r\ndevpriv->iobase + APCI3501_ANALOG_OUTPUT +\r\nAPCI3501_AO_PROG);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid v_APCI3501_Interrupt(int irq, void *d)\r\n{\r\nint i_temp;\r\nstruct comedi_device *dev = d;\r\nunsigned int ui_Timer_AOWatchdog;\r\nunsigned long ul_Command1;\r\nul_Command1 =\r\ninl(devpriv->iobase + APCI3501_WATCHDOG + APCI3501_TCW_PROG);\r\nul_Command1 = (ul_Command1 & 0xFFFFF9FDul);\r\noutl(ul_Command1,\r\ndevpriv->iobase + APCI3501_WATCHDOG + APCI3501_TCW_PROG);\r\nui_Timer_AOWatchdog =\r\ninl(devpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_IRQ) & 0x1;\r\nif ((!ui_Timer_AOWatchdog)) {\r\ncomedi_error(dev, "IRQ from unknown source");\r\nreturn;\r\n}\r\nsend_sig(SIGIO, devpriv->tsk_Current, 0);\r\nul_Command1 =\r\ninl(devpriv->iobase + APCI3501_WATCHDOG + APCI3501_TCW_PROG);\r\nul_Command1 = ((ul_Command1 & 0xFFFFF9FDul) | 1 << 1);\r\noutl(ul_Command1,\r\ndevpriv->iobase + APCI3501_WATCHDOG + APCI3501_TCW_PROG);\r\ni_temp = inl(devpriv->iobase + APCI3501_WATCHDOG +\r\nAPCI3501_TCW_TRIG_STATUS) & 0x1;\r\nreturn;\r\n}

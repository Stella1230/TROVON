void bacct_add_tsk(struct taskstats *stats, struct task_struct *tsk)\r\n{\r\nconst struct cred *tcred;\r\nstruct timespec uptime, ts;\r\nu64 ac_etime;\r\nBUILD_BUG_ON(TS_COMM_LEN < TASK_COMM_LEN);\r\ndo_posix_clock_monotonic_gettime(&uptime);\r\nts = timespec_sub(uptime, tsk->start_time);\r\nac_etime = timespec_to_ns(&ts);\r\ndo_div(ac_etime, NSEC_PER_USEC);\r\nstats->ac_etime = ac_etime;\r\nstats->ac_btime = get_seconds() - ts.tv_sec;\r\nif (thread_group_leader(tsk)) {\r\nstats->ac_exitcode = tsk->exit_code;\r\nif (tsk->flags & PF_FORKNOEXEC)\r\nstats->ac_flag |= AFORK;\r\n}\r\nif (tsk->flags & PF_SUPERPRIV)\r\nstats->ac_flag |= ASU;\r\nif (tsk->flags & PF_DUMPCORE)\r\nstats->ac_flag |= ACORE;\r\nif (tsk->flags & PF_SIGNALED)\r\nstats->ac_flag |= AXSIG;\r\nstats->ac_nice = task_nice(tsk);\r\nstats->ac_sched = tsk->policy;\r\nstats->ac_pid = tsk->pid;\r\nrcu_read_lock();\r\ntcred = __task_cred(tsk);\r\nstats->ac_uid = tcred->uid;\r\nstats->ac_gid = tcred->gid;\r\nstats->ac_ppid = pid_alive(tsk) ?\r\nrcu_dereference(tsk->real_parent)->tgid : 0;\r\nrcu_read_unlock();\r\nstats->ac_utime = cputime_to_usecs(tsk->utime);\r\nstats->ac_stime = cputime_to_usecs(tsk->stime);\r\nstats->ac_utimescaled = cputime_to_usecs(tsk->utimescaled);\r\nstats->ac_stimescaled = cputime_to_usecs(tsk->stimescaled);\r\nstats->ac_minflt = tsk->min_flt;\r\nstats->ac_majflt = tsk->maj_flt;\r\nstrncpy(stats->ac_comm, tsk->comm, sizeof(stats->ac_comm));\r\n}\r\nvoid xacct_add_tsk(struct taskstats *stats, struct task_struct *p)\r\n{\r\nstruct mm_struct *mm;\r\nstats->coremem = p->acct_rss_mem1 * PAGE_SIZE / MB;\r\nstats->virtmem = p->acct_vm_mem1 * PAGE_SIZE / MB;\r\nmm = get_task_mm(p);\r\nif (mm) {\r\nstats->hiwater_rss = get_mm_hiwater_rss(mm) * PAGE_SIZE / KB;\r\nstats->hiwater_vm = get_mm_hiwater_vm(mm) * PAGE_SIZE / KB;\r\nmmput(mm);\r\n}\r\nstats->read_char = p->ioac.rchar & KB_MASK;\r\nstats->write_char = p->ioac.wchar & KB_MASK;\r\nstats->read_syscalls = p->ioac.syscr & KB_MASK;\r\nstats->write_syscalls = p->ioac.syscw & KB_MASK;\r\n#ifdef CONFIG_TASK_IO_ACCOUNTING\r\nstats->read_bytes = p->ioac.read_bytes & KB_MASK;\r\nstats->write_bytes = p->ioac.write_bytes & KB_MASK;\r\nstats->cancelled_write_bytes = p->ioac.cancelled_write_bytes & KB_MASK;\r\n#else\r\nstats->read_bytes = 0;\r\nstats->write_bytes = 0;\r\nstats->cancelled_write_bytes = 0;\r\n#endif\r\n}\r\nvoid acct_update_integrals(struct task_struct *tsk)\r\n{\r\nif (likely(tsk->mm)) {\r\ncputime_t time, dtime;\r\nstruct timeval value;\r\nunsigned long flags;\r\nu64 delta;\r\nlocal_irq_save(flags);\r\ntime = tsk->stime + tsk->utime;\r\ndtime = cputime_sub(time, tsk->acct_timexpd);\r\njiffies_to_timeval(cputime_to_jiffies(dtime), &value);\r\ndelta = value.tv_sec;\r\ndelta = delta * USEC_PER_SEC + value.tv_usec;\r\nif (delta == 0)\r\ngoto out;\r\ntsk->acct_timexpd = time;\r\ntsk->acct_rss_mem1 += delta * get_mm_rss(tsk->mm);\r\ntsk->acct_vm_mem1 += delta * tsk->mm->total_vm;\r\nout:\r\nlocal_irq_restore(flags);\r\n}\r\n}\r\nvoid acct_clear_integrals(struct task_struct *tsk)\r\n{\r\ntsk->acct_timexpd = 0;\r\ntsk->acct_rss_mem1 = 0;\r\ntsk->acct_vm_mem1 = 0;\r\n}

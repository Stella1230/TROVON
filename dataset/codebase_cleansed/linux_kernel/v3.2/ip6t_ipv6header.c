static bool\r\nipv6header_mt6(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct ip6t_ipv6header_info *info = par->matchinfo;\r\nunsigned int temp;\r\nint len;\r\nu8 nexthdr;\r\nunsigned int ptr;\r\nnexthdr = ipv6_hdr(skb)->nexthdr;\r\nptr = sizeof(struct ipv6hdr);\r\nlen = skb->len - ptr;\r\ntemp = 0;\r\nwhile (ip6t_ext_hdr(nexthdr)) {\r\nconst struct ipv6_opt_hdr *hp;\r\nstruct ipv6_opt_hdr _hdr;\r\nint hdrlen;\r\nif (nexthdr == NEXTHDR_NONE) {\r\ntemp |= MASK_NONE;\r\nbreak;\r\n}\r\nif (len < (int)sizeof(struct ipv6_opt_hdr))\r\nreturn false;\r\nif (nexthdr == NEXTHDR_ESP) {\r\ntemp |= MASK_ESP;\r\nbreak;\r\n}\r\nhp = skb_header_pointer(skb, ptr, sizeof(_hdr), &_hdr);\r\nBUG_ON(hp == NULL);\r\nif (nexthdr == NEXTHDR_FRAGMENT)\r\nhdrlen = 8;\r\nelse if (nexthdr == NEXTHDR_AUTH)\r\nhdrlen = (hp->hdrlen + 2) << 2;\r\nelse\r\nhdrlen = ipv6_optlen(hp);\r\nswitch (nexthdr) {\r\ncase NEXTHDR_HOP:\r\ntemp |= MASK_HOPOPTS;\r\nbreak;\r\ncase NEXTHDR_ROUTING:\r\ntemp |= MASK_ROUTING;\r\nbreak;\r\ncase NEXTHDR_FRAGMENT:\r\ntemp |= MASK_FRAGMENT;\r\nbreak;\r\ncase NEXTHDR_AUTH:\r\ntemp |= MASK_AH;\r\nbreak;\r\ncase NEXTHDR_DEST:\r\ntemp |= MASK_DSTOPTS;\r\nbreak;\r\ndefault:\r\nreturn false;\r\nbreak;\r\n}\r\nnexthdr = hp->nexthdr;\r\nlen -= hdrlen;\r\nptr += hdrlen;\r\nif (ptr > skb->len)\r\nbreak;\r\n}\r\nif (nexthdr != NEXTHDR_NONE && nexthdr != NEXTHDR_ESP)\r\ntemp |= MASK_PROTO;\r\nif (info->modeflag)\r\nreturn !((temp ^ info->matchflags ^ info->invflags)\r\n& info->matchflags);\r\nelse {\r\nif (info->invflags)\r\nreturn temp != info->matchflags;\r\nelse\r\nreturn temp == info->matchflags;\r\n}\r\n}\r\nstatic int ipv6header_mt6_check(const struct xt_mtchk_param *par)\r\n{\r\nconst struct ip6t_ipv6header_info *info = par->matchinfo;\r\nif ((!info->modeflag) && info->invflags != 0x00 &&\r\ninfo->invflags != 0xFF)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int __init ipv6header_mt6_init(void)\r\n{\r\nreturn xt_register_match(&ipv6header_mt6_reg);\r\n}\r\nstatic void __exit ipv6header_mt6_exit(void)\r\n{\r\nxt_unregister_match(&ipv6header_mt6_reg);\r\n}

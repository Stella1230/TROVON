int xfrm6_tunnel_register(struct xfrm6_tunnel *handler, unsigned short family)\r\n{\r\nstruct xfrm6_tunnel __rcu **pprev;\r\nstruct xfrm6_tunnel *t;\r\nint ret = -EEXIST;\r\nint priority = handler->priority;\r\nmutex_lock(&tunnel6_mutex);\r\nfor (pprev = (family == AF_INET6) ? &tunnel6_handlers : &tunnel46_handlers;\r\n(t = rcu_dereference_protected(*pprev,\r\nlockdep_is_held(&tunnel6_mutex))) != NULL;\r\npprev = &t->next) {\r\nif (t->priority > priority)\r\nbreak;\r\nif (t->priority == priority)\r\ngoto err;\r\n}\r\nhandler->next = *pprev;\r\nrcu_assign_pointer(*pprev, handler);\r\nret = 0;\r\nerr:\r\nmutex_unlock(&tunnel6_mutex);\r\nreturn ret;\r\n}\r\nint xfrm6_tunnel_deregister(struct xfrm6_tunnel *handler, unsigned short family)\r\n{\r\nstruct xfrm6_tunnel __rcu **pprev;\r\nstruct xfrm6_tunnel *t;\r\nint ret = -ENOENT;\r\nmutex_lock(&tunnel6_mutex);\r\nfor (pprev = (family == AF_INET6) ? &tunnel6_handlers : &tunnel46_handlers;\r\n(t = rcu_dereference_protected(*pprev,\r\nlockdep_is_held(&tunnel6_mutex))) != NULL;\r\npprev = &t->next) {\r\nif (t == handler) {\r\n*pprev = handler->next;\r\nret = 0;\r\nbreak;\r\n}\r\n}\r\nmutex_unlock(&tunnel6_mutex);\r\nsynchronize_net();\r\nreturn ret;\r\n}\r\nstatic int tunnel46_rcv(struct sk_buff *skb)\r\n{\r\nstruct xfrm6_tunnel *handler;\r\nif (!pskb_may_pull(skb, sizeof(struct iphdr)))\r\ngoto drop;\r\nfor_each_tunnel_rcu(tunnel46_handlers, handler)\r\nif (!handler->handler(skb))\r\nreturn 0;\r\nicmpv6_send(skb, ICMPV6_DEST_UNREACH, ICMPV6_PORT_UNREACH, 0);\r\ndrop:\r\nkfree_skb(skb);\r\nreturn 0;\r\n}\r\nstatic void tunnel6_err(struct sk_buff *skb, struct inet6_skb_parm *opt,\r\nu8 type, u8 code, int offset, __be32 info)\r\n{\r\nstruct xfrm6_tunnel *handler;\r\nfor_each_tunnel_rcu(tunnel6_handlers, handler)\r\nif (!handler->err_handler(skb, opt, type, code, offset, info))\r\nbreak;\r\n}\r\nstatic int __init tunnel6_init(void)\r\n{\r\nif (inet6_add_protocol(&tunnel6_protocol, IPPROTO_IPV6)) {\r\nprintk(KERN_ERR "tunnel6 init(): can't add protocol\n");\r\nreturn -EAGAIN;\r\n}\r\nif (inet6_add_protocol(&tunnel46_protocol, IPPROTO_IPIP)) {\r\nprintk(KERN_ERR "tunnel6 init(): can't add protocol\n");\r\ninet6_del_protocol(&tunnel6_protocol, IPPROTO_IPV6);\r\nreturn -EAGAIN;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit tunnel6_fini(void)\r\n{\r\nif (inet6_del_protocol(&tunnel46_protocol, IPPROTO_IPIP))\r\nprintk(KERN_ERR "tunnel6 close: can't remove protocol\n");\r\nif (inet6_del_protocol(&tunnel6_protocol, IPPROTO_IPV6))\r\nprintk(KERN_ERR "tunnel6 close: can't remove protocol\n");\r\n}

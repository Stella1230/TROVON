static int no_cursor(struct fb_info *info, struct fb_cursor *cursor)\r\n{\r\nreturn 0;\r\n}\r\nstatic int rgbfb_setcolreg(u_int regno, u_int red, u_int green, u_int blue,\r\nu_int transp, struct fb_info *info)\r\n{\r\nif (regno > 15)\r\nreturn 1;\r\ncolreg[regno] = ((red & 0xff00) << 8) | (green & 0xff00) |\r\n((blue & 0xff00) >> 8);\r\nreturn 0;\r\n}\r\nstatic int rgbfb_mmap(struct fb_info *info, struct vm_area_struct *vma)\r\n{\r\nreturn pnx4008_sdum_mmap(info, vma, NULL);\r\n}\r\nstatic int rgbfb_remove(struct platform_device *pdev)\r\n{\r\nstruct fb_info *info = platform_get_drvdata(pdev);\r\nif (info) {\r\nunregister_framebuffer(info);\r\nfb_dealloc_cmap(&info->cmap);\r\nframebuffer_release(info);\r\nplatform_set_drvdata(pdev, NULL);\r\n}\r\npnx4008_free_dum_channel(channel_owned, pdev->id);\r\npnx4008_set_dum_exit_notification(pdev->id);\r\nreturn 0;\r\n}\r\nstatic int __devinit rgbfb_probe(struct platform_device *pdev)\r\n{\r\nstruct fb_info *info;\r\nstruct dumchannel_uf chan_uf;\r\nint ret;\r\nchar *option;\r\ninfo = framebuffer_alloc(sizeof(u32) * 16, &pdev->dev);\r\nif (!info) {\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\npnx4008_get_fb_addresses(FB_TYPE_RGB, (void **)&info->screen_base,\r\n(dma_addr_t *) &rgbfb_fix.smem_start,\r\n&rgbfb_fix.smem_len);\r\nif ((ret = pnx4008_alloc_dum_channel(pdev->id)) < 0)\r\ngoto err0;\r\nelse {\r\nchannel_owned = ret;\r\nchan_uf.channelnr = channel_owned;\r\nchan_uf.dirty = (u32 *) NULL;\r\nchan_uf.source = (u32 *) rgbfb_fix.smem_start;\r\nchan_uf.x_offset = 0;\r\nchan_uf.y_offset = 0;\r\nchan_uf.width = LCD_X_RES;\r\nchan_uf.height = LCD_Y_RES;\r\nif ((ret = pnx4008_put_dum_channel_uf(chan_uf, pdev->id))< 0)\r\ngoto err1;\r\nif ((ret =\r\npnx4008_set_dum_channel_sync(channel_owned, CONF_SYNC_ON,\r\npdev->id)) < 0)\r\ngoto err1;\r\nif ((ret =\r\npnx4008_set_dum_channel_dirty_detect(channel_owned,\r\nCONF_DIRTYDETECTION_ON,\r\npdev->id)) < 0)\r\ngoto err1;\r\n}\r\nif (!fb_get_options("pnxrgbfb", &option) && option &&\r\n!strcmp(option, "nocursor"))\r\nrgbfb_ops.fb_cursor = no_cursor;\r\ninfo->node = -1;\r\ninfo->flags = FBINFO_FLAG_DEFAULT;\r\ninfo->fbops = &rgbfb_ops;\r\ninfo->fix = rgbfb_fix;\r\ninfo->var = rgbfb_var;\r\ninfo->screen_size = rgbfb_fix.smem_len;\r\ninfo->pseudo_palette = info->par;\r\ninfo->par = NULL;\r\nret = fb_alloc_cmap(&info->cmap, 256, 0);\r\nif (ret < 0)\r\ngoto err1;\r\nret = register_framebuffer(info);\r\nif (ret < 0)\r\ngoto err2;\r\nplatform_set_drvdata(pdev, info);\r\nreturn 0;\r\nerr2:\r\nfb_dealloc_cmap(&info->cmap);\r\nerr1:\r\npnx4008_free_dum_channel(channel_owned, pdev->id);\r\nerr0:\r\nframebuffer_release(info);\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int __init rgbfb_init(void)\r\n{\r\nreturn platform_driver_register(&rgbfb_driver);\r\n}\r\nstatic void __exit rgbfb_exit(void)\r\n{\r\nplatform_driver_unregister(&rgbfb_driver);\r\n}

static void emit_log_char(struct debug_log *debug_log, char c)\r\n{\r\nLOG_BUFF(debug_log->log_end) = c;\r\ndebug_log->log_end++;\r\nif (debug_log->log_end - debug_log->log_start > log_buff_len)\r\ndebug_log->log_start = debug_log->log_end - log_buff_len;\r\n}\r\nstatic int fdebug_log(struct debug_log *debug_log, const char *fmt, ...)\r\n{\r\nva_list args;\r\nstatic char debug_log_buf[256];\r\nchar *p;\r\nif (!debug_log)\r\nreturn 0;\r\nspin_lock_bh(&debug_log->lock);\r\nva_start(args, fmt);\r\nvscnprintf(debug_log_buf, sizeof(debug_log_buf), fmt, args);\r\nva_end(args);\r\nfor (p = debug_log_buf; *p != 0; p++)\r\nemit_log_char(debug_log, *p);\r\nspin_unlock_bh(&debug_log->lock);\r\nwake_up(&debug_log->queue_wait);\r\nreturn 0;\r\n}\r\nint debug_log(struct bat_priv *bat_priv, const char *fmt, ...)\r\n{\r\nva_list args;\r\nchar tmp_log_buf[256];\r\nva_start(args, fmt);\r\nvscnprintf(tmp_log_buf, sizeof(tmp_log_buf), fmt, args);\r\nfdebug_log(bat_priv->debug_log, "[%10lu] %s",\r\n(jiffies / HZ), tmp_log_buf);\r\nva_end(args);\r\nreturn 0;\r\n}\r\nstatic int log_open(struct inode *inode, struct file *file)\r\n{\r\nnonseekable_open(inode, file);\r\nfile->private_data = inode->i_private;\r\ninc_module_count();\r\nreturn 0;\r\n}\r\nstatic int log_release(struct inode *inode, struct file *file)\r\n{\r\ndec_module_count();\r\nreturn 0;\r\n}\r\nstatic ssize_t log_read(struct file *file, char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct bat_priv *bat_priv = file->private_data;\r\nstruct debug_log *debug_log = bat_priv->debug_log;\r\nint error, i = 0;\r\nchar c;\r\nif ((file->f_flags & O_NONBLOCK) &&\r\n!(debug_log->log_end - debug_log->log_start))\r\nreturn -EAGAIN;\r\nif (!buf)\r\nreturn -EINVAL;\r\nif (count == 0)\r\nreturn 0;\r\nif (!access_ok(VERIFY_WRITE, buf, count))\r\nreturn -EFAULT;\r\nerror = wait_event_interruptible(debug_log->queue_wait,\r\n(debug_log->log_start - debug_log->log_end));\r\nif (error)\r\nreturn error;\r\nspin_lock_bh(&debug_log->lock);\r\nwhile ((!error) && (i < count) &&\r\n(debug_log->log_start != debug_log->log_end)) {\r\nc = LOG_BUFF(debug_log->log_start);\r\ndebug_log->log_start++;\r\nspin_unlock_bh(&debug_log->lock);\r\nerror = __put_user(c, buf);\r\nspin_lock_bh(&debug_log->lock);\r\nbuf++;\r\ni++;\r\n}\r\nspin_unlock_bh(&debug_log->lock);\r\nif (!error)\r\nreturn i;\r\nreturn error;\r\n}\r\nstatic unsigned int log_poll(struct file *file, poll_table *wait)\r\n{\r\nstruct bat_priv *bat_priv = file->private_data;\r\nstruct debug_log *debug_log = bat_priv->debug_log;\r\npoll_wait(file, &debug_log->queue_wait, wait);\r\nif (debug_log->log_end - debug_log->log_start)\r\nreturn POLLIN | POLLRDNORM;\r\nreturn 0;\r\n}\r\nstatic int debug_log_setup(struct bat_priv *bat_priv)\r\n{\r\nstruct dentry *d;\r\nif (!bat_priv->debug_dir)\r\ngoto err;\r\nbat_priv->debug_log = kzalloc(sizeof(*bat_priv->debug_log), GFP_ATOMIC);\r\nif (!bat_priv->debug_log)\r\ngoto err;\r\nspin_lock_init(&bat_priv->debug_log->lock);\r\ninit_waitqueue_head(&bat_priv->debug_log->queue_wait);\r\nd = debugfs_create_file("log", S_IFREG | S_IRUSR,\r\nbat_priv->debug_dir, bat_priv, &log_fops);\r\nif (d)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\nreturn 1;\r\n}\r\nstatic void debug_log_cleanup(struct bat_priv *bat_priv)\r\n{\r\nkfree(bat_priv->debug_log);\r\nbat_priv->debug_log = NULL;\r\n}\r\nstatic int debug_log_setup(struct bat_priv *bat_priv)\r\n{\r\nbat_priv->debug_log = NULL;\r\nreturn 0;\r\n}\r\nstatic void debug_log_cleanup(struct bat_priv *bat_priv)\r\n{\r\nreturn;\r\n}\r\nstatic int originators_open(struct inode *inode, struct file *file)\r\n{\r\nstruct net_device *net_dev = (struct net_device *)inode->i_private;\r\nreturn single_open(file, orig_seq_print_text, net_dev);\r\n}\r\nstatic int gateways_open(struct inode *inode, struct file *file)\r\n{\r\nstruct net_device *net_dev = (struct net_device *)inode->i_private;\r\nreturn single_open(file, gw_client_seq_print_text, net_dev);\r\n}\r\nstatic int softif_neigh_open(struct inode *inode, struct file *file)\r\n{\r\nstruct net_device *net_dev = (struct net_device *)inode->i_private;\r\nreturn single_open(file, softif_neigh_seq_print_text, net_dev);\r\n}\r\nstatic int transtable_global_open(struct inode *inode, struct file *file)\r\n{\r\nstruct net_device *net_dev = (struct net_device *)inode->i_private;\r\nreturn single_open(file, tt_global_seq_print_text, net_dev);\r\n}\r\nstatic int transtable_local_open(struct inode *inode, struct file *file)\r\n{\r\nstruct net_device *net_dev = (struct net_device *)inode->i_private;\r\nreturn single_open(file, tt_local_seq_print_text, net_dev);\r\n}\r\nstatic int vis_data_open(struct inode *inode, struct file *file)\r\n{\r\nstruct net_device *net_dev = (struct net_device *)inode->i_private;\r\nreturn single_open(file, vis_seq_print_text, net_dev);\r\n}\r\nvoid debugfs_init(void)\r\n{\r\nbat_debugfs = debugfs_create_dir(DEBUGFS_BAT_SUBDIR, NULL);\r\nif (bat_debugfs == ERR_PTR(-ENODEV))\r\nbat_debugfs = NULL;\r\n}\r\nvoid debugfs_destroy(void)\r\n{\r\nif (bat_debugfs) {\r\ndebugfs_remove_recursive(bat_debugfs);\r\nbat_debugfs = NULL;\r\n}\r\n}\r\nint debugfs_add_meshif(struct net_device *dev)\r\n{\r\nstruct bat_priv *bat_priv = netdev_priv(dev);\r\nstruct bat_debuginfo **bat_debug;\r\nstruct dentry *file;\r\nif (!bat_debugfs)\r\ngoto out;\r\nbat_priv->debug_dir = debugfs_create_dir(dev->name, bat_debugfs);\r\nif (!bat_priv->debug_dir)\r\ngoto out;\r\nbat_socket_setup(bat_priv);\r\ndebug_log_setup(bat_priv);\r\nfor (bat_debug = mesh_debuginfos; *bat_debug; ++bat_debug) {\r\nfile = debugfs_create_file(((*bat_debug)->attr).name,\r\nS_IFREG | ((*bat_debug)->attr).mode,\r\nbat_priv->debug_dir,\r\ndev, &(*bat_debug)->fops);\r\nif (!file) {\r\nbat_err(dev, "Can't add debugfs file: %s/%s\n",\r\ndev->name, ((*bat_debug)->attr).name);\r\ngoto rem_attr;\r\n}\r\n}\r\nreturn 0;\r\nrem_attr:\r\ndebugfs_remove_recursive(bat_priv->debug_dir);\r\nbat_priv->debug_dir = NULL;\r\nout:\r\n#ifdef CONFIG_DEBUG_FS\r\nreturn -ENOMEM;\r\n#else\r\nreturn 0;\r\n#endif\r\n}\r\nvoid debugfs_del_meshif(struct net_device *dev)\r\n{\r\nstruct bat_priv *bat_priv = netdev_priv(dev);\r\ndebug_log_cleanup(bat_priv);\r\nif (bat_debugfs) {\r\ndebugfs_remove_recursive(bat_priv->debug_dir);\r\nbat_priv->debug_dir = NULL;\r\n}\r\n}

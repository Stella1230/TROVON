static int m5mols_capture_error_handler(struct m5mols_info *info,\r\nint timeout)\r\n{\r\nint ret;\r\nret = m5mols_write(&info->sd, SYSTEM_INT_ENABLE,\r\ninfo->interrupt & ~(REG_INT_CAPTURE));\r\nif (ret)\r\nreturn ret;\r\nif (timeout == 0)\r\nreturn -ETIMEDOUT;\r\nreturn 0;\r\n}\r\nstatic int m5mols_read_rational(struct v4l2_subdev *sd, u32 addr_num,\r\nu32 addr_den, u32 *val)\r\n{\r\nu32 num, den;\r\nint ret = m5mols_read_u32(sd, addr_num, &num);\r\nif (!ret)\r\nret = m5mols_read_u32(sd, addr_den, &den);\r\nif (ret)\r\nreturn ret;\r\n*val = den == 0 ? 0 : num / den;\r\nreturn ret;\r\n}\r\nstatic int m5mols_capture_info(struct m5mols_info *info)\r\n{\r\nstruct m5mols_exif *exif = &info->cap.exif;\r\nstruct v4l2_subdev *sd = &info->sd;\r\nint ret;\r\nret = m5mols_read_rational(sd, EXIF_INFO_EXPTIME_NU,\r\nEXIF_INFO_EXPTIME_DE, &exif->exposure_time);\r\nif (ret)\r\nreturn ret;\r\nret = m5mols_read_rational(sd, EXIF_INFO_TV_NU, EXIF_INFO_TV_DE,\r\n&exif->shutter_speed);\r\nif (ret)\r\nreturn ret;\r\nret = m5mols_read_rational(sd, EXIF_INFO_AV_NU, EXIF_INFO_AV_DE,\r\n&exif->aperture);\r\nif (ret)\r\nreturn ret;\r\nret = m5mols_read_rational(sd, EXIF_INFO_BV_NU, EXIF_INFO_BV_DE,\r\n&exif->brightness);\r\nif (ret)\r\nreturn ret;\r\nret = m5mols_read_rational(sd, EXIF_INFO_EBV_NU, EXIF_INFO_EBV_DE,\r\n&exif->exposure_bias);\r\nif (ret)\r\nreturn ret;\r\nret = m5mols_read_u16(sd, EXIF_INFO_ISO, &exif->iso_speed);\r\nif (!ret)\r\nret = m5mols_read_u16(sd, EXIF_INFO_FLASH, &exif->flash);\r\nif (!ret)\r\nret = m5mols_read_u16(sd, EXIF_INFO_SDR, &exif->sdr);\r\nif (!ret)\r\nret = m5mols_read_u16(sd, EXIF_INFO_QVAL, &exif->qval);\r\nif (ret)\r\nreturn ret;\r\nif (!ret)\r\nret = m5mols_read_u32(sd, CAPC_IMAGE_SIZE, &info->cap.main);\r\nif (!ret)\r\nret = m5mols_read_u32(sd, CAPC_THUMB_SIZE, &info->cap.thumb);\r\nif (!ret)\r\ninfo->cap.total = info->cap.main + info->cap.thumb;\r\nreturn ret;\r\n}\r\nint m5mols_start_capture(struct m5mols_info *info)\r\n{\r\nstruct v4l2_subdev *sd = &info->sd;\r\nu8 resolution = info->resolution;\r\nint timeout;\r\nint ret;\r\nret = m5mols_mode(info, REG_MONITOR);\r\nif (!ret)\r\nret = m5mols_sync_controls(info);\r\nif (!ret)\r\nret = m5mols_lock_3a(info, true);\r\nif (!ret)\r\nret = m5mols_enable_interrupt(sd, REG_INT_CAPTURE);\r\nif (!ret)\r\nret = m5mols_mode(info, REG_CAPTURE);\r\nif (!ret) {\r\ntimeout = wait_event_interruptible_timeout(info->irq_waitq,\r\ntest_bit(ST_CAPT_IRQ, &info->flags),\r\nmsecs_to_jiffies(2000));\r\nif (test_and_clear_bit(ST_CAPT_IRQ, &info->flags))\r\nret = m5mols_capture_error_handler(info, timeout);\r\n}\r\nif (!ret)\r\nret = m5mols_lock_3a(info, false);\r\nif (ret)\r\nreturn ret;\r\nret = m5mols_write(sd, CAPC_SEL_FRAME, 1);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPP_YUVOUT_MAIN, REG_JPEG);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPP_MAIN_IMAGE_SIZE, resolution);\r\nif (!ret)\r\nret = m5mols_enable_interrupt(sd, REG_INT_CAPTURE);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPC_START, REG_CAP_START_MAIN);\r\nif (!ret) {\r\ntimeout = wait_event_interruptible_timeout(info->irq_waitq,\r\ntest_bit(ST_CAPT_IRQ, &info->flags),\r\nmsecs_to_jiffies(2000));\r\nif (test_and_clear_bit(ST_CAPT_IRQ, &info->flags)) {\r\nret = m5mols_capture_info(info);\r\nif (!ret)\r\nv4l2_subdev_notify(sd, 0, &info->cap.total);\r\n}\r\n}\r\nreturn m5mols_capture_error_handler(info, timeout);\r\n}

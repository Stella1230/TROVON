static void __noreturn sgi_machine_power_off(void)\r\n{\r\nunsigned int tmp;\r\nlocal_irq_disable();\r\ntmp = hpc3c0->rtcregs[RTC_CMD] & 0xff;\r\nhpc3c0->rtcregs[RTC_CMD] = tmp | RTC_WAM;\r\nhpc3c0->rtcregs[RTC_WSEC] = 0;\r\nhpc3c0->rtcregs[RTC_WHSEC] = 0;\r\nwhile (1) {\r\nsgioc->panel = ~SGIOC_PANEL_POWERON;\r\ntmp = hpc3c0->rtcregs[RTC_HOURS_ALARM];\r\n}\r\n}\r\nstatic void __noreturn sgi_machine_restart(char *command)\r\n{\r\nif (machine_state & MACHINE_SHUTTING_DOWN)\r\nsgi_machine_power_off();\r\nsgimc->cpuctrl0 |= SGIMC_CCTRL0_SYSINIT;\r\nwhile (1);\r\n}\r\nstatic void __noreturn sgi_machine_halt(void)\r\n{\r\nif (machine_state & MACHINE_SHUTTING_DOWN)\r\nsgi_machine_power_off();\r\nArcEnterInteractiveMode();\r\n}\r\nstatic void power_timeout(unsigned long data)\r\n{\r\nsgi_machine_power_off();\r\n}\r\nstatic void blink_timeout(unsigned long data)\r\n{\r\nsgi_ioc_reset ^= (SGIOC_RESET_LC0OFF|SGIOC_RESET_LC1OFF);\r\nsgioc->reset = sgi_ioc_reset;\r\nmod_timer(&blink_timer, jiffies + data);\r\n}\r\nstatic void debounce(unsigned long data)\r\n{\r\ndel_timer(&debounce_timer);\r\nif (sgint->istat1 & SGINT_ISTAT1_PWR) {\r\ndebounce_timer.expires = jiffies + (HZ / 20);\r\nadd_timer(&debounce_timer);\r\nsgioc->panel = SGIOC_PANEL_POWERON | SGIOC_PANEL_POWERINTR |\r\nSGIOC_PANEL_VOLDNINTR | SGIOC_PANEL_VOLDNHOLD |\r\nSGIOC_PANEL_VOLUPINTR | SGIOC_PANEL_VOLUPHOLD;\r\nreturn;\r\n}\r\nif (machine_state & MACHINE_PANICED)\r\nsgimc->cpuctrl0 |= SGIMC_CCTRL0_SYSINIT;\r\nenable_irq(SGI_PANEL_IRQ);\r\n}\r\nstatic inline void power_button(void)\r\n{\r\nif (machine_state & MACHINE_PANICED)\r\nreturn;\r\nif ((machine_state & MACHINE_SHUTTING_DOWN) ||\r\nkill_cad_pid(SIGINT, 1)) {\r\nsgi_machine_power_off();\r\n}\r\nmachine_state |= MACHINE_SHUTTING_DOWN;\r\nblink_timer.data = POWERDOWN_FREQ;\r\nblink_timeout(POWERDOWN_FREQ);\r\ninit_timer(&power_timer);\r\npower_timer.function = power_timeout;\r\npower_timer.expires = jiffies + POWERDOWN_TIMEOUT * HZ;\r\nadd_timer(&power_timer);\r\n}\r\nstatic irqreturn_t panel_int(int irq, void *dev_id)\r\n{\r\nunsigned int buttons;\r\nbuttons = sgioc->panel;\r\nsgioc->panel = SGIOC_PANEL_POWERON | SGIOC_PANEL_POWERINTR;\r\nif (sgint->istat1 & SGINT_ISTAT1_PWR) {\r\ndisable_irq_nosync(SGI_PANEL_IRQ);\r\ninit_timer(&debounce_timer);\r\ndebounce_timer.function = debounce;\r\ndebounce_timer.expires = jiffies + 5;\r\nadd_timer(&debounce_timer);\r\n}\r\nif (!(buttons & SGIOC_PANEL_POWERINTR))\r\npower_button();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int panic_event(struct notifier_block *this, unsigned long event,\r\nvoid *ptr)\r\n{\r\nif (machine_state & MACHINE_PANICED)\r\nreturn NOTIFY_DONE;\r\nmachine_state |= MACHINE_PANICED;\r\nblink_timer.data = PANIC_FREQ;\r\nblink_timeout(PANIC_FREQ);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init reboot_setup(void)\r\n{\r\nint res;\r\n_machine_restart = sgi_machine_restart;\r\n_machine_halt = sgi_machine_halt;\r\npm_power_off = sgi_machine_power_off;\r\nres = request_irq(SGI_PANEL_IRQ, panel_int, 0, "Front Panel", NULL);\r\nif (res) {\r\nprintk(KERN_ERR "Allocation of front panel IRQ failed\n");\r\nreturn res;\r\n}\r\ninit_timer(&blink_timer);\r\nblink_timer.function = blink_timeout;\r\natomic_notifier_chain_register(&panic_notifier_list, &panic_block);\r\nreturn 0;\r\n}

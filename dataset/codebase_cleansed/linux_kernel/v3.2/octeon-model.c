const char *octeon_model_get_string(uint32_t chip_id)\r\n{\r\nstatic char buffer[32];\r\nreturn octeon_model_get_string_buffer(chip_id, buffer);\r\n}\r\nconst char *octeon_model_get_string_buffer(uint32_t chip_id, char *buffer)\r\n{\r\nconst char *family;\r\nconst char *core_model;\r\nchar pass[4];\r\nint clock_mhz;\r\nconst char *suffix;\r\nunion cvmx_l2d_fus3 fus3;\r\nint num_cores;\r\nunion cvmx_mio_fus_dat2 fus_dat2;\r\nunion cvmx_mio_fus_dat3 fus_dat3;\r\nchar fuse_model[10];\r\nuint32_t fuse_data = 0;\r\nfus3.u64 = cvmx_read_csr(CVMX_L2D_FUS3);\r\nfus_dat2.u64 = cvmx_read_csr(CVMX_MIO_FUS_DAT2);\r\nfus_dat3.u64 = cvmx_read_csr(CVMX_MIO_FUS_DAT3);\r\nnum_cores = cvmx_octeon_num_cores();\r\nswitch ((chip_id >> 8) & 0xff) {\r\ncase 6:\r\ncase 2:\r\nfus_dat3.s.nodfa_dte = 1;\r\nfus_dat3.s.nozip = 1;\r\nbreak;\r\ncase 4:\r\nfus_dat3.s.nodfa_dte = 1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (fus_dat3.s.nodfa_dte) {\r\nif (fus_dat2.s.nocrypto)\r\nsuffix = "CP";\r\nelse\r\nsuffix = "SCP";\r\n} else if (fus_dat2.s.nocrypto)\r\nsuffix = "EXP";\r\nelse\r\nsuffix = "NSP";\r\nsprintf(pass, "%u.%u", ((chip_id >> 3) & 7) + 1, chip_id & 7);\r\nswitch (num_cores) {\r\ncase 16:\r\ncore_model = "60";\r\nbreak;\r\ncase 15:\r\ncore_model = "58";\r\nbreak;\r\ncase 14:\r\ncore_model = "55";\r\nbreak;\r\ncase 13:\r\ncore_model = "52";\r\nbreak;\r\ncase 12:\r\ncore_model = "50";\r\nbreak;\r\ncase 11:\r\ncore_model = "48";\r\nbreak;\r\ncase 10:\r\ncore_model = "45";\r\nbreak;\r\ncase 9:\r\ncore_model = "42";\r\nbreak;\r\ncase 8:\r\ncore_model = "40";\r\nbreak;\r\ncase 7:\r\ncore_model = "38";\r\nbreak;\r\ncase 6:\r\ncore_model = "34";\r\nbreak;\r\ncase 5:\r\ncore_model = "32";\r\nbreak;\r\ncase 4:\r\ncore_model = "30";\r\nbreak;\r\ncase 3:\r\ncore_model = "25";\r\nbreak;\r\ncase 2:\r\ncore_model = "20";\r\nbreak;\r\ncase 1:\r\ncore_model = "10";\r\nbreak;\r\ndefault:\r\ncore_model = "XX";\r\nbreak;\r\n}\r\nswitch ((chip_id >> 8) & 0xff) {\r\ncase 0:\r\nif (fus3.cn38xx.crip_512k) {\r\nif (num_cores >= 16)\r\nfamily = "37";\r\nelse\r\nfamily = "36";\r\n} else\r\nfamily = "38";\r\nswitch (chip_id & 0xf) {\r\ncase 0:\r\nstrcpy(pass, "1.X");\r\nbreak;\r\ncase 1:\r\nstrcpy(pass, "2.X");\r\nbreak;\r\ncase 3:\r\nstrcpy(pass, "3.X");\r\nbreak;\r\ndefault:\r\nstrcpy(pass, "X.X");\r\nbreak;\r\n}\r\nbreak;\r\ncase 1:\r\nif ((chip_id & 0x10) || fus3.cn31xx.crip_128k)\r\nfamily = "30";\r\nelse\r\nfamily = "31";\r\nswitch (chip_id & 0xf) {\r\ncase 0:\r\nstrcpy(pass, "1.0");\r\nbreak;\r\ncase 2:\r\nstrcpy(pass, "1.1");\r\nbreak;\r\ndefault:\r\nstrcpy(pass, "X.X");\r\nbreak;\r\n}\r\nbreak;\r\ncase 2:\r\nfamily = "30";\r\nif (fus3.cn30xx.crip_64k)\r\ncore_model = "05";\r\nswitch (chip_id & 0xf) {\r\ncase 0:\r\nstrcpy(pass, "1.0");\r\nbreak;\r\ncase 2:\r\nstrcpy(pass, "1.1");\r\nbreak;\r\ndefault:\r\nstrcpy(pass, "X.X");\r\nbreak;\r\n}\r\nbreak;\r\ncase 3:\r\nfamily = "58";\r\nif ((num_cores == 4) && fus_dat2.cn38xx.nocrypto)\r\ncore_model = "29";\r\nif ((chip_id & 0xFF) < 0x8) {\r\nswitch (chip_id & 0x3) {\r\ncase 0:\r\nstrcpy(pass, "1.0");\r\nbreak;\r\ncase 1:\r\nstrcpy(pass, "1.1");\r\nbreak;\r\ncase 3:\r\nstrcpy(pass, "1.2");\r\nbreak;\r\ndefault:\r\nstrcpy(pass, "1.X");\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ncase 4:\r\nif (fus_dat2.cn56xx.raid_en) {\r\nif (fus3.cn56xx.crip_1024k)\r\nfamily = "55";\r\nelse\r\nfamily = "57";\r\nif (fus_dat2.cn56xx.nocrypto)\r\nsuffix = "SP";\r\nelse\r\nsuffix = "SSP";\r\n} else {\r\nif (fus_dat2.cn56xx.nocrypto)\r\nsuffix = "CP";\r\nelse {\r\nsuffix = "NSP";\r\nif (fus_dat3.s.nozip)\r\nsuffix = "SCP";\r\n}\r\nif (fus3.cn56xx.crip_1024k)\r\nfamily = "54";\r\nelse\r\nfamily = "56";\r\n}\r\nbreak;\r\ncase 6:\r\nfamily = "50";\r\nbreak;\r\ncase 7:\r\nif (fus3.cn52xx.crip_256k)\r\nfamily = "51";\r\nelse\r\nfamily = "52";\r\nbreak;\r\ndefault:\r\nfamily = "XX";\r\ncore_model = "XX";\r\nstrcpy(pass, "X.X");\r\nsuffix = "XXX";\r\nbreak;\r\n}\r\nclock_mhz = octeon_get_clock_rate() / 1000000;\r\nif (family[0] != '3') {\r\nfuse_data |= cvmx_fuse_read_byte(51);\r\nfuse_data = fuse_data << 8;\r\nfuse_data |= cvmx_fuse_read_byte(50);\r\nfuse_data = fuse_data << 8;\r\nfuse_data |= cvmx_fuse_read_byte(49);\r\nfuse_data = fuse_data << 8;\r\nfuse_data |= cvmx_fuse_read_byte(48);\r\nif (fuse_data & 0x7ffff) {\r\nint model = fuse_data & 0x3fff;\r\nint suffix = (fuse_data >> 14) & 0x1f;\r\nif (suffix && model) {\r\nsprintf(fuse_model, "%d%c",\r\nmodel, 'A' + suffix - 1);\r\ncore_model = "";\r\nfamily = fuse_model;\r\n} else if (suffix && !model) {\r\nsprintf(fuse_model, "%s%c", core_model,\r\n'A' + suffix - 1);\r\ncore_model = fuse_model;\r\n} else {\r\nsprintf(fuse_model, "%d", model);\r\ncore_model = "";\r\nfamily = fuse_model;\r\n}\r\n}\r\n}\r\nsprintf(buffer, "CN%s%sp%s-%d-%s",\r\nfamily, core_model, pass, clock_mhz, suffix);\r\nreturn buffer;\r\n}

static int ds3232_check_rtc_status(struct i2c_client *client)\r\n{\r\nint ret = 0;\r\nint control, stat;\r\nstat = i2c_smbus_read_byte_data(client, DS3232_REG_SR);\r\nif (stat < 0)\r\nreturn stat;\r\nif (stat & DS3232_REG_SR_OSF)\r\ndev_warn(&client->dev,\r\n"oscillator discontinuity flagged, "\r\n"time unreliable\n");\r\nstat &= ~(DS3232_REG_SR_OSF | DS3232_REG_SR_A1F | DS3232_REG_SR_A2F);\r\nret = i2c_smbus_write_byte_data(client, DS3232_REG_SR, stat);\r\nif (ret < 0)\r\nreturn ret;\r\ncontrol = i2c_smbus_read_byte_data(client, DS3232_REG_CR);\r\nif (control < 0)\r\nreturn control;\r\ncontrol &= ~(DS3232_REG_CR_A1IE | DS3232_REG_CR_A2IE);\r\ncontrol |= DS3232_REG_CR_INTCN;\r\nreturn i2c_smbus_write_byte_data(client, DS3232_REG_CR, control);\r\n}\r\nstatic int ds3232_read_time(struct device *dev, struct rtc_time *time)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nint ret;\r\nu8 buf[7];\r\nunsigned int year, month, day, hour, minute, second;\r\nunsigned int week, twelve_hr, am_pm;\r\nunsigned int century, add_century = 0;\r\nret = i2c_smbus_read_i2c_block_data(client, DS3232_REG_SECONDS, 7, buf);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret < 7)\r\nreturn -EIO;\r\nsecond = buf[0];\r\nminute = buf[1];\r\nhour = buf[2];\r\nweek = buf[3];\r\nday = buf[4];\r\nmonth = buf[5];\r\nyear = buf[6];\r\ntwelve_hr = hour & 0x40;\r\nam_pm = hour & 0x20;\r\ncentury = month & 0x80;\r\ntime->tm_sec = bcd2bin(second);\r\ntime->tm_min = bcd2bin(minute);\r\nif (twelve_hr) {\r\nif (am_pm)\r\ntime->tm_hour = bcd2bin(hour & 0x1F) + 12;\r\nelse\r\ntime->tm_hour = bcd2bin(hour & 0x1F);\r\n} else {\r\ntime->tm_hour = bcd2bin(hour);\r\n}\r\ntime->tm_wday = bcd2bin(week) - 1;\r\ntime->tm_mday = bcd2bin(day);\r\ntime->tm_mon = bcd2bin(month & 0x7F) - 1;\r\nif (century)\r\nadd_century = 100;\r\ntime->tm_year = bcd2bin(year) + add_century;\r\nreturn rtc_valid_tm(time);\r\n}\r\nstatic int ds3232_set_time(struct device *dev, struct rtc_time *time)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nu8 buf[7];\r\nbuf[0] = bin2bcd(time->tm_sec);\r\nbuf[1] = bin2bcd(time->tm_min);\r\nbuf[2] = bin2bcd(time->tm_hour);\r\nbuf[3] = bin2bcd(time->tm_wday + 1);\r\nbuf[4] = bin2bcd(time->tm_mday);\r\nbuf[5] = bin2bcd(time->tm_mon + 1);\r\nif (time->tm_year >= 100) {\r\nbuf[5] |= 0x80;\r\nbuf[6] = bin2bcd(time->tm_year - 100);\r\n} else {\r\nbuf[6] = bin2bcd(time->tm_year);\r\n}\r\nreturn i2c_smbus_write_i2c_block_data(client,\r\nDS3232_REG_SECONDS, 7, buf);\r\n}\r\nstatic int ds3232_read_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ds3232 *ds3232 = i2c_get_clientdata(client);\r\nint control, stat;\r\nint ret;\r\nu8 buf[4];\r\nmutex_lock(&ds3232->mutex);\r\nret = i2c_smbus_read_byte_data(client, DS3232_REG_SR);\r\nif (ret < 0)\r\ngoto out;\r\nstat = ret;\r\nret = i2c_smbus_read_byte_data(client, DS3232_REG_CR);\r\nif (ret < 0)\r\ngoto out;\r\ncontrol = ret;\r\nret = i2c_smbus_read_i2c_block_data(client, DS3232_REG_ALARM1, 4, buf);\r\nif (ret < 0)\r\ngoto out;\r\nalarm->time.tm_sec = bcd2bin(buf[0] & 0x7F);\r\nalarm->time.tm_min = bcd2bin(buf[1] & 0x7F);\r\nalarm->time.tm_hour = bcd2bin(buf[2] & 0x7F);\r\nalarm->time.tm_mday = bcd2bin(buf[3] & 0x7F);\r\nalarm->time.tm_mon = -1;\r\nalarm->time.tm_year = -1;\r\nalarm->time.tm_wday = -1;\r\nalarm->time.tm_yday = -1;\r\nalarm->time.tm_isdst = -1;\r\nalarm->enabled = !!(control & DS3232_REG_CR_A1IE);\r\nalarm->pending = !!(stat & DS3232_REG_SR_A1F);\r\nret = 0;\r\nout:\r\nmutex_unlock(&ds3232->mutex);\r\nreturn ret;\r\n}\r\nstatic int ds3232_set_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ds3232 *ds3232 = i2c_get_clientdata(client);\r\nint control, stat;\r\nint ret;\r\nu8 buf[4];\r\nif (client->irq <= 0)\r\nreturn -EINVAL;\r\nmutex_lock(&ds3232->mutex);\r\nbuf[0] = bin2bcd(alarm->time.tm_sec);\r\nbuf[1] = bin2bcd(alarm->time.tm_min);\r\nbuf[2] = bin2bcd(alarm->time.tm_hour);\r\nbuf[3] = bin2bcd(alarm->time.tm_mday);\r\nret = i2c_smbus_read_byte_data(client, DS3232_REG_CR);\r\nif (ret < 0)\r\ngoto out;\r\ncontrol = ret;\r\ncontrol &= ~(DS3232_REG_CR_A1IE | DS3232_REG_CR_A2IE);\r\nret = i2c_smbus_write_byte_data(client, DS3232_REG_CR, control);\r\nif (ret < 0)\r\ngoto out;\r\nret = i2c_smbus_read_byte_data(client, DS3232_REG_SR);\r\nif (ret < 0)\r\ngoto out;\r\nstat = ret;\r\nstat &= ~(DS3232_REG_SR_A1F | DS3232_REG_SR_A2F);\r\nret = i2c_smbus_write_byte_data(client, DS3232_REG_SR, stat);\r\nif (ret < 0)\r\ngoto out;\r\nret = i2c_smbus_write_i2c_block_data(client, DS3232_REG_ALARM1, 4, buf);\r\nif (alarm->enabled) {\r\ncontrol |= DS3232_REG_CR_A1IE;\r\nret = i2c_smbus_write_byte_data(client, DS3232_REG_CR, control);\r\n}\r\nout:\r\nmutex_unlock(&ds3232->mutex);\r\nreturn ret;\r\n}\r\nstatic void ds3232_update_alarm(struct i2c_client *client)\r\n{\r\nstruct ds3232 *ds3232 = i2c_get_clientdata(client);\r\nint control;\r\nint ret;\r\nu8 buf[4];\r\nmutex_lock(&ds3232->mutex);\r\nret = i2c_smbus_read_i2c_block_data(client, DS3232_REG_ALARM1, 4, buf);\r\nif (ret < 0)\r\ngoto unlock;\r\nbuf[0] = bcd2bin(buf[0]) < 0 || (ds3232->rtc->irq_data & RTC_UF) ?\r\n0x80 : buf[0];\r\nbuf[1] = bcd2bin(buf[1]) < 0 || (ds3232->rtc->irq_data & RTC_UF) ?\r\n0x80 : buf[1];\r\nbuf[2] = bcd2bin(buf[2]) < 0 || (ds3232->rtc->irq_data & RTC_UF) ?\r\n0x80 : buf[2];\r\nbuf[3] = bcd2bin(buf[3]) < 0 || (ds3232->rtc->irq_data & RTC_UF) ?\r\n0x80 : buf[3];\r\nret = i2c_smbus_write_i2c_block_data(client, DS3232_REG_ALARM1, 4, buf);\r\nif (ret < 0)\r\ngoto unlock;\r\ncontrol = i2c_smbus_read_byte_data(client, DS3232_REG_CR);\r\nif (control < 0)\r\ngoto unlock;\r\nif (ds3232->rtc->irq_data & (RTC_AF | RTC_UF))\r\ncontrol |= DS3232_REG_CR_A1IE;\r\nelse\r\ncontrol &= ~(DS3232_REG_CR_A1IE);\r\ni2c_smbus_write_byte_data(client, DS3232_REG_CR, control);\r\nunlock:\r\nmutex_unlock(&ds3232->mutex);\r\n}\r\nstatic int ds3232_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ds3232 *ds3232 = i2c_get_clientdata(client);\r\nif (client->irq <= 0)\r\nreturn -EINVAL;\r\nif (enabled)\r\nds3232->rtc->irq_data |= RTC_AF;\r\nelse\r\nds3232->rtc->irq_data &= ~RTC_AF;\r\nds3232_update_alarm(client);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t ds3232_irq(int irq, void *dev_id)\r\n{\r\nstruct i2c_client *client = dev_id;\r\nstruct ds3232 *ds3232 = i2c_get_clientdata(client);\r\ndisable_irq_nosync(irq);\r\nschedule_work(&ds3232->work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void ds3232_work(struct work_struct *work)\r\n{\r\nstruct ds3232 *ds3232 = container_of(work, struct ds3232, work);\r\nstruct i2c_client *client = ds3232->client;\r\nint stat, control;\r\nmutex_lock(&ds3232->mutex);\r\nstat = i2c_smbus_read_byte_data(client, DS3232_REG_SR);\r\nif (stat < 0)\r\ngoto unlock;\r\nif (stat & DS3232_REG_SR_A1F) {\r\ncontrol = i2c_smbus_read_byte_data(client, DS3232_REG_CR);\r\nif (control < 0)\r\ngoto out;\r\ncontrol &= ~(DS3232_REG_CR_A1IE);\r\ni2c_smbus_write_byte_data(client, DS3232_REG_CR, control);\r\nstat &= ~DS3232_REG_SR_A1F;\r\ni2c_smbus_write_byte_data(client, DS3232_REG_SR, stat);\r\nrtc_update_irq(ds3232->rtc, 1, RTC_AF | RTC_IRQF);\r\n}\r\nout:\r\nif (!ds3232->exiting)\r\nenable_irq(client->irq);\r\nunlock:\r\nmutex_unlock(&ds3232->mutex);\r\n}\r\nstatic int __devinit ds3232_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct ds3232 *ds3232;\r\nint ret;\r\nds3232 = kzalloc(sizeof(struct ds3232), GFP_KERNEL);\r\nif (!ds3232)\r\nreturn -ENOMEM;\r\nds3232->client = client;\r\ni2c_set_clientdata(client, ds3232);\r\nINIT_WORK(&ds3232->work, ds3232_work);\r\nmutex_init(&ds3232->mutex);\r\nret = ds3232_check_rtc_status(client);\r\nif (ret)\r\ngoto out_free;\r\nds3232->rtc = rtc_device_register(client->name, &client->dev,\r\n&ds3232_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(ds3232->rtc)) {\r\nret = PTR_ERR(ds3232->rtc);\r\ndev_err(&client->dev, "unable to register the class device\n");\r\ngoto out_irq;\r\n}\r\nif (client->irq >= 0) {\r\nret = request_irq(client->irq, ds3232_irq, 0,\r\n"ds3232", client);\r\nif (ret) {\r\ndev_err(&client->dev, "unable to request IRQ\n");\r\ngoto out_free;\r\n}\r\n}\r\nreturn 0;\r\nout_irq:\r\nif (client->irq >= 0)\r\nfree_irq(client->irq, client);\r\nout_free:\r\nkfree(ds3232);\r\nreturn ret;\r\n}\r\nstatic int __devexit ds3232_remove(struct i2c_client *client)\r\n{\r\nstruct ds3232 *ds3232 = i2c_get_clientdata(client);\r\nif (client->irq >= 0) {\r\nmutex_lock(&ds3232->mutex);\r\nds3232->exiting = 1;\r\nmutex_unlock(&ds3232->mutex);\r\nfree_irq(client->irq, client);\r\ncancel_work_sync(&ds3232->work);\r\n}\r\nrtc_device_unregister(ds3232->rtc);\r\nkfree(ds3232);\r\nreturn 0;\r\n}\r\nstatic int __init ds3232_init(void)\r\n{\r\nreturn i2c_add_driver(&ds3232_driver);\r\n}\r\nstatic void __exit ds3232_exit(void)\r\n{\r\ni2c_del_driver(&ds3232_driver);\r\n}

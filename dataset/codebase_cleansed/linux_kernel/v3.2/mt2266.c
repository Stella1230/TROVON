static int mt2266_readreg(struct mt2266_priv *priv, u8 reg, u8 *val)\r\n{\r\nstruct i2c_msg msg[2] = {\r\n{ .addr = priv->cfg->i2c_address, .flags = 0, .buf = &reg, .len = 1 },\r\n{ .addr = priv->cfg->i2c_address, .flags = I2C_M_RD, .buf = val, .len = 1 },\r\n};\r\nif (i2c_transfer(priv->i2c, msg, 2) != 2) {\r\nprintk(KERN_WARNING "MT2266 I2C read failed\n");\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mt2266_writereg(struct mt2266_priv *priv, u8 reg, u8 val)\r\n{\r\nu8 buf[2] = { reg, val };\r\nstruct i2c_msg msg = {\r\n.addr = priv->cfg->i2c_address, .flags = 0, .buf = buf, .len = 2\r\n};\r\nif (i2c_transfer(priv->i2c, &msg, 1) != 1) {\r\nprintk(KERN_WARNING "MT2266 I2C write failed\n");\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mt2266_writeregs(struct mt2266_priv *priv,u8 *buf, u8 len)\r\n{\r\nstruct i2c_msg msg = {\r\n.addr = priv->cfg->i2c_address, .flags = 0, .buf = buf, .len = len\r\n};\r\nif (i2c_transfer(priv->i2c, &msg, 1) != 1) {\r\nprintk(KERN_WARNING "MT2266 I2C write failed (len=%i)\n",(int)len);\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mt2266_set_params(struct dvb_frontend *fe, struct dvb_frontend_parameters *params)\r\n{\r\nstruct mt2266_priv *priv;\r\nint ret=0;\r\nu32 freq;\r\nu32 tune;\r\nu8 lnaband;\r\nu8 b[10];\r\nint i;\r\nu8 band;\r\npriv = fe->tuner_priv;\r\nfreq = params->frequency / 1000;\r\nif (freq < 470000 && freq > 230000)\r\nreturn -EINVAL;\r\npriv->bandwidth = (fe->ops.info.type == FE_OFDM) ? params->u.ofdm.bandwidth : 0;\r\npriv->frequency = freq * 1000;\r\ntune = 2 * freq * (8192/16) / (FREF/16);\r\nband = (freq < 300000) ? MT2266_VHF : MT2266_UHF;\r\nif (band == MT2266_VHF)\r\ntune *= 2;\r\nswitch (params->u.ofdm.bandwidth) {\r\ncase BANDWIDTH_6_MHZ:\r\nmt2266_writeregs(priv, mt2266_init_6mhz,\r\nsizeof(mt2266_init_6mhz));\r\nbreak;\r\ncase BANDWIDTH_7_MHZ:\r\nmt2266_writeregs(priv, mt2266_init_7mhz,\r\nsizeof(mt2266_init_7mhz));\r\nbreak;\r\ncase BANDWIDTH_8_MHZ:\r\ndefault:\r\nmt2266_writeregs(priv, mt2266_init_8mhz,\r\nsizeof(mt2266_init_8mhz));\r\nbreak;\r\n}\r\nif (band == MT2266_VHF && priv->band == MT2266_UHF) {\r\ndprintk("Switch from UHF to VHF");\r\nmt2266_writereg(priv, 0x05, 0x04);\r\nmt2266_writereg(priv, 0x19, 0x61);\r\nmt2266_writeregs(priv, mt2266_vhf, sizeof(mt2266_vhf));\r\n} else if (band == MT2266_UHF && priv->band == MT2266_VHF) {\r\ndprintk("Switch from VHF to UHF");\r\nmt2266_writereg(priv, 0x05, 0x52);\r\nmt2266_writereg(priv, 0x19, 0x61);\r\nmt2266_writeregs(priv, mt2266_uhf, sizeof(mt2266_uhf));\r\n}\r\nmsleep(10);\r\nif (freq <= 495000)\r\nlnaband = 0xEE;\r\nelse if (freq <= 525000)\r\nlnaband = 0xDD;\r\nelse if (freq <= 550000)\r\nlnaband = 0xCC;\r\nelse if (freq <= 580000)\r\nlnaband = 0xBB;\r\nelse if (freq <= 605000)\r\nlnaband = 0xAA;\r\nelse if (freq <= 630000)\r\nlnaband = 0x99;\r\nelse if (freq <= 655000)\r\nlnaband = 0x88;\r\nelse if (freq <= 685000)\r\nlnaband = 0x77;\r\nelse if (freq <= 710000)\r\nlnaband = 0x66;\r\nelse if (freq <= 735000)\r\nlnaband = 0x55;\r\nelse if (freq <= 765000)\r\nlnaband = 0x44;\r\nelse if (freq <= 802000)\r\nlnaband = 0x33;\r\nelse if (freq <= 840000)\r\nlnaband = 0x22;\r\nelse\r\nlnaband = 0x11;\r\nb[0] = REG_TUNE;\r\nb[1] = (tune >> 8) & 0x1F;\r\nb[2] = tune & 0xFF;\r\nb[3] = tune >> 13;\r\nmt2266_writeregs(priv,b,4);\r\ndprintk("set_parms: tune=%d band=%d %s",\r\n(int) tune, (int) lnaband,\r\n(band == MT2266_UHF) ? "UHF" : "VHF");\r\ndprintk("set_parms: [1..3]: %2x %2x %2x",\r\n(int) b[1], (int) b[2], (int)b[3]);\r\nif (band == MT2266_UHF) {\r\nb[0] = 0x05;\r\nb[1] = (priv->band == MT2266_VHF) ? 0x52 : 0x62;\r\nb[2] = lnaband;\r\nmt2266_writeregs(priv, b, 3);\r\n}\r\ni = 0;\r\ndo {\r\nmt2266_readreg(priv,REG_LOCK,b);\r\nif (b[0] & 0x40)\r\nbreak;\r\nmsleep(10);\r\ni++;\r\n} while (i<10);\r\ndprintk("Lock when i=%i",(int)i);\r\nif (band == MT2266_UHF && priv->band == MT2266_VHF)\r\nmt2266_writereg(priv, 0x05, 0x62);\r\npriv->band = band;\r\nreturn ret;\r\n}\r\nstatic void mt2266_calibrate(struct mt2266_priv *priv)\r\n{\r\nmt2266_writereg(priv, 0x11, 0x03);\r\nmt2266_writereg(priv, 0x11, 0x01);\r\nmt2266_writeregs(priv, mt2266_init1, sizeof(mt2266_init1));\r\nmt2266_writeregs(priv, mt2266_init2, sizeof(mt2266_init2));\r\nmt2266_writereg(priv, 0x33, 0x5e);\r\nmt2266_writereg(priv, 0x10, 0x10);\r\nmt2266_writereg(priv, 0x10, 0x00);\r\nmt2266_writeregs(priv, mt2266_init_8mhz, sizeof(mt2266_init_8mhz));\r\nmsleep(25);\r\nmt2266_writereg(priv, 0x17, 0x6d);\r\nmt2266_writereg(priv, 0x1c, 0x00);\r\nmsleep(75);\r\nmt2266_writereg(priv, 0x17, 0x6d);\r\nmt2266_writereg(priv, 0x1c, 0xff);\r\n}\r\nstatic int mt2266_get_frequency(struct dvb_frontend *fe, u32 *frequency)\r\n{\r\nstruct mt2266_priv *priv = fe->tuner_priv;\r\n*frequency = priv->frequency;\r\nreturn 0;\r\n}\r\nstatic int mt2266_get_bandwidth(struct dvb_frontend *fe, u32 *bandwidth)\r\n{\r\nstruct mt2266_priv *priv = fe->tuner_priv;\r\n*bandwidth = priv->bandwidth;\r\nreturn 0;\r\n}\r\nstatic int mt2266_init(struct dvb_frontend *fe)\r\n{\r\nint ret;\r\nstruct mt2266_priv *priv = fe->tuner_priv;\r\nret = mt2266_writereg(priv, 0x17, 0x6d);\r\nif (ret < 0)\r\nreturn ret;\r\nret = mt2266_writereg(priv, 0x1c, 0xff);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int mt2266_sleep(struct dvb_frontend *fe)\r\n{\r\nstruct mt2266_priv *priv = fe->tuner_priv;\r\nmt2266_writereg(priv, 0x17, 0x6d);\r\nmt2266_writereg(priv, 0x1c, 0x00);\r\nreturn 0;\r\n}\r\nstatic int mt2266_release(struct dvb_frontend *fe)\r\n{\r\nkfree(fe->tuner_priv);\r\nfe->tuner_priv = NULL;\r\nreturn 0;\r\n}\r\nstruct dvb_frontend * mt2266_attach(struct dvb_frontend *fe, struct i2c_adapter *i2c, struct mt2266_config *cfg)\r\n{\r\nstruct mt2266_priv *priv = NULL;\r\nu8 id = 0;\r\npriv = kzalloc(sizeof(struct mt2266_priv), GFP_KERNEL);\r\nif (priv == NULL)\r\nreturn NULL;\r\npriv->cfg = cfg;\r\npriv->i2c = i2c;\r\npriv->band = MT2266_UHF;\r\nif (mt2266_readreg(priv, 0, &id)) {\r\nkfree(priv);\r\nreturn NULL;\r\n}\r\nif (id != PART_REV) {\r\nkfree(priv);\r\nreturn NULL;\r\n}\r\nprintk(KERN_INFO "MT2266: successfully identified\n");\r\nmemcpy(&fe->ops.tuner_ops, &mt2266_tuner_ops, sizeof(struct dvb_tuner_ops));\r\nfe->tuner_priv = priv;\r\nmt2266_calibrate(priv);\r\nreturn fe;\r\n}

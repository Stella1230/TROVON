static int dsbr100_start(struct dsbr100_device *radio)\r\n{\r\nint retval;\r\nint request;\r\nretval = usb_control_msg(radio->usbdev,\r\nusb_rcvctrlpipe(radio->usbdev, 0),\r\nUSB_REQ_GET_STATUS,\r\nUSB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_DIR_IN,\r\n0x00, 0xC7, radio->transfer_buffer, 8, 300);\r\nif (retval < 0) {\r\nrequest = USB_REQ_GET_STATUS;\r\ngoto usb_control_msg_failed;\r\n}\r\nretval = usb_control_msg(radio->usbdev,\r\nusb_rcvctrlpipe(radio->usbdev, 0),\r\nDSB100_ONOFF,\r\nUSB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_DIR_IN,\r\n0x01, 0x00, radio->transfer_buffer, 8, 300);\r\nif (retval < 0) {\r\nrequest = DSB100_ONOFF;\r\ngoto usb_control_msg_failed;\r\n}\r\nradio->status = STARTED;\r\nreturn (radio->transfer_buffer)[0];\r\nusb_control_msg_failed:\r\ndev_err(&radio->usbdev->dev,\r\n"%s - usb_control_msg returned %i, request %i\n",\r\n__func__, retval, request);\r\nreturn retval;\r\n}\r\nstatic int dsbr100_stop(struct dsbr100_device *radio)\r\n{\r\nint retval;\r\nint request;\r\nretval = usb_control_msg(radio->usbdev,\r\nusb_rcvctrlpipe(radio->usbdev, 0),\r\nUSB_REQ_GET_STATUS,\r\nUSB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_DIR_IN,\r\n0x16, 0x1C, radio->transfer_buffer, 8, 300);\r\nif (retval < 0) {\r\nrequest = USB_REQ_GET_STATUS;\r\ngoto usb_control_msg_failed;\r\n}\r\nretval = usb_control_msg(radio->usbdev,\r\nusb_rcvctrlpipe(radio->usbdev, 0),\r\nDSB100_ONOFF,\r\nUSB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_DIR_IN,\r\n0x00, 0x00, radio->transfer_buffer, 8, 300);\r\nif (retval < 0) {\r\nrequest = DSB100_ONOFF;\r\ngoto usb_control_msg_failed;\r\n}\r\nradio->status = STOPPED;\r\nreturn (radio->transfer_buffer)[0];\r\nusb_control_msg_failed:\r\ndev_err(&radio->usbdev->dev,\r\n"%s - usb_control_msg returned %i, request %i\n",\r\n__func__, retval, request);\r\nreturn retval;\r\n}\r\nstatic int dsbr100_setfreq(struct dsbr100_device *radio)\r\n{\r\nint retval;\r\nint request;\r\nint freq = (radio->curfreq / 16 * 80) / 1000 + 856;\r\nretval = usb_control_msg(radio->usbdev,\r\nusb_rcvctrlpipe(radio->usbdev, 0),\r\nDSB100_TUNE,\r\nUSB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_DIR_IN,\r\n(freq >> 8) & 0x00ff, freq & 0xff,\r\nradio->transfer_buffer, 8, 300);\r\nif (retval < 0) {\r\nrequest = DSB100_TUNE;\r\ngoto usb_control_msg_failed;\r\n}\r\nretval = usb_control_msg(radio->usbdev,\r\nusb_rcvctrlpipe(radio->usbdev, 0),\r\nUSB_REQ_GET_STATUS,\r\nUSB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_DIR_IN,\r\n0x96, 0xB7, radio->transfer_buffer, 8, 300);\r\nif (retval < 0) {\r\nrequest = USB_REQ_GET_STATUS;\r\ngoto usb_control_msg_failed;\r\n}\r\nretval = usb_control_msg(radio->usbdev,\r\nusb_rcvctrlpipe(radio->usbdev, 0),\r\nUSB_REQ_GET_STATUS,\r\nUSB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_DIR_IN,\r\n0x00, 0x24, radio->transfer_buffer, 8, 300);\r\nif (retval < 0) {\r\nrequest = USB_REQ_GET_STATUS;\r\ngoto usb_control_msg_failed;\r\n}\r\nradio->stereo = !((radio->transfer_buffer)[0] & 0x01);\r\nreturn (radio->transfer_buffer)[0];\r\nusb_control_msg_failed:\r\nradio->stereo = -1;\r\ndev_err(&radio->usbdev->dev,\r\n"%s - usb_control_msg returned %i, request %i\n",\r\n__func__, retval, request);\r\nreturn retval;\r\n}\r\nstatic void dsbr100_getstat(struct dsbr100_device *radio)\r\n{\r\nint retval;\r\nretval = usb_control_msg(radio->usbdev,\r\nusb_rcvctrlpipe(radio->usbdev, 0),\r\nUSB_REQ_GET_STATUS,\r\nUSB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_DIR_IN,\r\n0x00 , 0x24, radio->transfer_buffer, 8, 300);\r\nif (retval < 0) {\r\nradio->stereo = -1;\r\ndev_err(&radio->usbdev->dev,\r\n"%s - usb_control_msg returned %i, request %i\n",\r\n__func__, retval, USB_REQ_GET_STATUS);\r\n} else {\r\nradio->stereo = !(radio->transfer_buffer[0] & 0x01);\r\n}\r\n}\r\nstatic int vidioc_querycap(struct file *file, void *priv,\r\nstruct v4l2_capability *v)\r\n{\r\nstruct dsbr100_device *radio = video_drvdata(file);\r\nstrlcpy(v->driver, "dsbr100", sizeof(v->driver));\r\nstrlcpy(v->card, "D-Link R-100 USB FM Radio", sizeof(v->card));\r\nusb_make_path(radio->usbdev, v->bus_info, sizeof(v->bus_info));\r\nv->capabilities = V4L2_CAP_TUNER;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nstruct dsbr100_device *radio = video_drvdata(file);\r\nif (v->index > 0)\r\nreturn -EINVAL;\r\ndsbr100_getstat(radio);\r\nstrcpy(v->name, "FM");\r\nv->type = V4L2_TUNER_RADIO;\r\nv->rangelow = FREQ_MIN * FREQ_MUL;\r\nv->rangehigh = FREQ_MAX * FREQ_MUL;\r\nv->rxsubchans = V4L2_TUNER_SUB_MONO | V4L2_TUNER_SUB_STEREO;\r\nv->capability = V4L2_TUNER_CAP_LOW;\r\nif(radio->stereo)\r\nv->audmode = V4L2_TUNER_MODE_STEREO;\r\nelse\r\nv->audmode = V4L2_TUNER_MODE_MONO;\r\nv->signal = 0xffff;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nreturn v->index ? -EINVAL : 0;\r\n}\r\nstatic int vidioc_s_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct dsbr100_device *radio = video_drvdata(file);\r\nint retval;\r\nradio->curfreq = f->frequency;\r\nretval = dsbr100_setfreq(radio);\r\nif (retval < 0)\r\ndev_warn(&radio->usbdev->dev, "Set frequency failed\n");\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct dsbr100_device *radio = video_drvdata(file);\r\nf->type = V4L2_TUNER_RADIO;\r\nf->frequency = radio->curfreq;\r\nreturn 0;\r\n}\r\nstatic int vidioc_queryctrl(struct file *file, void *priv,\r\nstruct v4l2_queryctrl *qc)\r\n{\r\nswitch (qc->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nreturn v4l2_ctrl_query_fill(qc, 0, 1, 1, 1);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_g_ctrl(struct file *file, void *priv,\r\nstruct v4l2_control *ctrl)\r\n{\r\nstruct dsbr100_device *radio = video_drvdata(file);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nctrl->value = radio->status;\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_s_ctrl(struct file *file, void *priv,\r\nstruct v4l2_control *ctrl)\r\n{\r\nstruct dsbr100_device *radio = video_drvdata(file);\r\nint retval;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nif (ctrl->value) {\r\nretval = dsbr100_stop(radio);\r\nif (retval < 0) {\r\ndev_warn(&radio->usbdev->dev,\r\n"Radio did not respond properly\n");\r\nreturn -EBUSY;\r\n}\r\n} else {\r\nretval = dsbr100_start(radio);\r\nif (retval < 0) {\r\ndev_warn(&radio->usbdev->dev,\r\n"Radio did not respond properly\n");\r\nreturn -EBUSY;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_g_audio(struct file *file, void *priv,\r\nstruct v4l2_audio *a)\r\n{\r\nif (a->index > 1)\r\nreturn -EINVAL;\r\nstrcpy(a->name, "Radio");\r\na->capability = V4L2_AUDCAP_STEREO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_input(struct file *filp, void *priv, unsigned int *i)\r\n{\r\n*i = 0;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_input(struct file *filp, void *priv, unsigned int i)\r\n{\r\nreturn i ? -EINVAL : 0;\r\n}\r\nstatic int vidioc_s_audio(struct file *file, void *priv,\r\nstruct v4l2_audio *a)\r\n{\r\nreturn a->index ? -EINVAL : 0;\r\n}\r\nstatic void usb_dsbr100_disconnect(struct usb_interface *intf)\r\n{\r\nstruct dsbr100_device *radio = usb_get_intfdata(intf);\r\nv4l2_device_get(&radio->v4l2_dev);\r\nmutex_lock(&radio->v4l2_lock);\r\nusb_set_intfdata(intf, NULL);\r\nvideo_unregister_device(&radio->videodev);\r\nv4l2_device_disconnect(&radio->v4l2_dev);\r\nmutex_unlock(&radio->v4l2_lock);\r\nv4l2_device_put(&radio->v4l2_dev);\r\n}\r\nstatic int usb_dsbr100_suspend(struct usb_interface *intf, pm_message_t message)\r\n{\r\nstruct dsbr100_device *radio = usb_get_intfdata(intf);\r\nint retval;\r\nmutex_lock(&radio->v4l2_lock);\r\nif (radio->status == STARTED) {\r\nretval = dsbr100_stop(radio);\r\nif (retval < 0)\r\ndev_warn(&intf->dev, "dsbr100_stop failed\n");\r\nradio->status = STARTED;\r\n}\r\nmutex_unlock(&radio->v4l2_lock);\r\ndev_info(&intf->dev, "going into suspend..\n");\r\nreturn 0;\r\n}\r\nstatic int usb_dsbr100_resume(struct usb_interface *intf)\r\n{\r\nstruct dsbr100_device *radio = usb_get_intfdata(intf);\r\nint retval;\r\nmutex_lock(&radio->v4l2_lock);\r\nif (radio->status == STARTED) {\r\nretval = dsbr100_start(radio);\r\nif (retval < 0)\r\ndev_warn(&intf->dev, "dsbr100_start failed\n");\r\n}\r\nmutex_unlock(&radio->v4l2_lock);\r\ndev_info(&intf->dev, "coming out of suspend..\n");\r\nreturn 0;\r\n}\r\nstatic void usb_dsbr100_release(struct v4l2_device *v4l2_dev)\r\n{\r\nstruct dsbr100_device *radio = v4l2_dev_to_radio(v4l2_dev);\r\nv4l2_device_unregister(&radio->v4l2_dev);\r\nkfree(radio->transfer_buffer);\r\nkfree(radio);\r\n}\r\nstatic int usb_dsbr100_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct dsbr100_device *radio;\r\nstruct v4l2_device *v4l2_dev;\r\nint retval;\r\nradio = kzalloc(sizeof(struct dsbr100_device), GFP_KERNEL);\r\nif (!radio)\r\nreturn -ENOMEM;\r\nradio->transfer_buffer = kmalloc(TB_LEN, GFP_KERNEL);\r\nif (!(radio->transfer_buffer)) {\r\nkfree(radio);\r\nreturn -ENOMEM;\r\n}\r\nv4l2_dev = &radio->v4l2_dev;\r\nv4l2_dev->release = usb_dsbr100_release;\r\nretval = v4l2_device_register(&intf->dev, v4l2_dev);\r\nif (retval < 0) {\r\nv4l2_err(v4l2_dev, "couldn't register v4l2_device\n");\r\nkfree(radio->transfer_buffer);\r\nkfree(radio);\r\nreturn retval;\r\n}\r\nmutex_init(&radio->v4l2_lock);\r\nstrlcpy(radio->videodev.name, v4l2_dev->name, sizeof(radio->videodev.name));\r\nradio->videodev.v4l2_dev = v4l2_dev;\r\nradio->videodev.fops = &usb_dsbr100_fops;\r\nradio->videodev.ioctl_ops = &usb_dsbr100_ioctl_ops;\r\nradio->videodev.release = video_device_release_empty;\r\nradio->videodev.lock = &radio->v4l2_lock;\r\nradio->usbdev = interface_to_usbdev(intf);\r\nradio->curfreq = FREQ_MIN * FREQ_MUL;\r\nradio->status = STOPPED;\r\nvideo_set_drvdata(&radio->videodev, radio);\r\nretval = video_register_device(&radio->videodev, VFL_TYPE_RADIO, radio_nr);\r\nif (retval < 0) {\r\nv4l2_err(v4l2_dev, "couldn't register video device\n");\r\nv4l2_device_unregister(v4l2_dev);\r\nkfree(radio->transfer_buffer);\r\nkfree(radio);\r\nreturn -EIO;\r\n}\r\nusb_set_intfdata(intf, radio);\r\nreturn 0;\r\n}\r\nstatic int __init dsbr100_init(void)\r\n{\r\nint retval = usb_register(&usb_dsbr100_driver);\r\nprintk(KERN_INFO KBUILD_MODNAME ": " DRIVER_VERSION ":"\r\nDRIVER_DESC "\n");\r\nreturn retval;\r\n}\r\nstatic void __exit dsbr100_exit(void)\r\n{\r\nusb_deregister(&usb_dsbr100_driver);\r\n}

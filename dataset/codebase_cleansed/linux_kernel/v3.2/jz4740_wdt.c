static void jz4740_wdt_service(void)\r\n{\r\nwritew(0x0, jz4740_wdt.base + JZ_REG_WDT_TIMER_COUNTER);\r\n}\r\nstatic void jz4740_wdt_set_heartbeat(int new_heartbeat)\r\n{\r\nunsigned int rtc_clk_rate;\r\nunsigned int timeout_value;\r\nunsigned short clock_div = JZ_WDT_CLOCK_DIV_1;\r\nheartbeat = new_heartbeat;\r\nrtc_clk_rate = clk_get_rate(jz4740_wdt.rtc_clk);\r\ntimeout_value = rtc_clk_rate * heartbeat;\r\nwhile (timeout_value > 0xffff) {\r\nif (clock_div == JZ_WDT_CLOCK_DIV_1024) {\r\ntimeout_value = 0xffff;\r\nbreak;\r\n}\r\ntimeout_value >>= 2;\r\nclock_div += (1 << JZ_WDT_CLOCK_DIV_SHIFT);\r\n}\r\nwriteb(0x0, jz4740_wdt.base + JZ_REG_WDT_COUNTER_ENABLE);\r\nwritew(clock_div, jz4740_wdt.base + JZ_REG_WDT_TIMER_CONTROL);\r\nwritew((u16)timeout_value, jz4740_wdt.base + JZ_REG_WDT_TIMER_DATA);\r\nwritew(0x0, jz4740_wdt.base + JZ_REG_WDT_TIMER_COUNTER);\r\nwritew(clock_div | JZ_WDT_CLOCK_RTC,\r\njz4740_wdt.base + JZ_REG_WDT_TIMER_CONTROL);\r\nwriteb(0x1, jz4740_wdt.base + JZ_REG_WDT_COUNTER_ENABLE);\r\n}\r\nstatic void jz4740_wdt_enable(void)\r\n{\r\njz4740_timer_enable_watchdog();\r\njz4740_wdt_set_heartbeat(heartbeat);\r\n}\r\nstatic void jz4740_wdt_disable(void)\r\n{\r\njz4740_timer_disable_watchdog();\r\nwriteb(0x0, jz4740_wdt.base + JZ_REG_WDT_COUNTER_ENABLE);\r\n}\r\nstatic int jz4740_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(WDT_IN_USE, &jz4740_wdt.status))\r\nreturn -EBUSY;\r\njz4740_wdt_enable();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic ssize_t jz4740_wdt_write(struct file *file, const char *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nsize_t i;\r\nclear_bit(WDT_OK_TO_CLOSE, &jz4740_wdt.status);\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nset_bit(WDT_OK_TO_CLOSE, &jz4740_wdt.status);\r\n}\r\njz4740_wdt_service();\r\n}\r\nreturn len;\r\n}\r\nstatic long jz4740_wdt_ioctl(struct file *file,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nint ret = -ENOTTY;\r\nint heartbeat_seconds;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nret = copy_to_user((struct watchdog_info *)arg, &ident,\r\nsizeof(ident)) ? -EFAULT : 0;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nret = put_user(0, (int *)arg);\r\nbreak;\r\ncase WDIOC_KEEPALIVE:\r\njz4740_wdt_service();\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT:\r\nif (get_user(heartbeat_seconds, (int __user *)arg))\r\nreturn -EFAULT;\r\njz4740_wdt_set_heartbeat(heartbeat_seconds);\r\nreturn 0;\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(heartbeat, (int *)arg);\r\ndefault:\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int jz4740_wdt_release(struct inode *inode, struct file *file)\r\n{\r\njz4740_wdt_service();\r\nif (test_and_clear_bit(WDT_OK_TO_CLOSE, &jz4740_wdt.status))\r\njz4740_wdt_disable();\r\nclear_bit(WDT_IN_USE, &jz4740_wdt.status);\r\nreturn 0;\r\n}\r\nstatic int __devinit jz4740_wdt_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0, size;\r\nstruct resource *res;\r\nstruct device *dev = &pdev->dev;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (res == NULL) {\r\ndev_err(dev, "failed to get memory region resource\n");\r\nreturn -ENXIO;\r\n}\r\nsize = resource_size(res);\r\njz4740_wdt.mem = request_mem_region(res->start, size, pdev->name);\r\nif (jz4740_wdt.mem == NULL) {\r\ndev_err(dev, "failed to get memory region\n");\r\nreturn -EBUSY;\r\n}\r\njz4740_wdt.base = ioremap_nocache(res->start, size);\r\nif (jz4740_wdt.base == NULL) {\r\ndev_err(dev, "failed to map memory region\n");\r\nret = -EBUSY;\r\ngoto err_release_region;\r\n}\r\njz4740_wdt.rtc_clk = clk_get(NULL, "rtc");\r\nif (IS_ERR(jz4740_wdt.rtc_clk)) {\r\ndev_err(dev, "cannot find RTC clock\n");\r\nret = PTR_ERR(jz4740_wdt.rtc_clk);\r\ngoto err_iounmap;\r\n}\r\nret = misc_register(&jz4740_wdt_miscdev);\r\nif (ret < 0) {\r\ndev_err(dev, "cannot register misc device\n");\r\ngoto err_disable_clk;\r\n}\r\nreturn 0;\r\nerr_disable_clk:\r\nclk_put(jz4740_wdt.rtc_clk);\r\nerr_iounmap:\r\niounmap(jz4740_wdt.base);\r\nerr_release_region:\r\nrelease_mem_region(jz4740_wdt.mem->start,\r\nresource_size(jz4740_wdt.mem));\r\nreturn ret;\r\n}\r\nstatic int __devexit jz4740_wdt_remove(struct platform_device *pdev)\r\n{\r\njz4740_wdt_disable();\r\nmisc_deregister(&jz4740_wdt_miscdev);\r\nclk_put(jz4740_wdt.rtc_clk);\r\niounmap(jz4740_wdt.base);\r\njz4740_wdt.base = NULL;\r\nrelease_mem_region(jz4740_wdt.mem->start,\r\nresource_size(jz4740_wdt.mem));\r\njz4740_wdt.mem = NULL;\r\nreturn 0;\r\n}\r\nstatic int __init jz4740_wdt_init(void)\r\n{\r\nreturn platform_driver_register(&jz4740_wdt_driver);\r\n}\r\nstatic void __exit jz4740_wdt_exit(void)\r\n{\r\nplatform_driver_unregister(&jz4740_wdt_driver);\r\n}

int atm_charge(struct atm_vcc *vcc, int truesize)\r\n{\r\natm_force_charge(vcc, truesize);\r\nif (atomic_read(&sk_atm(vcc)->sk_rmem_alloc) <= sk_atm(vcc)->sk_rcvbuf)\r\nreturn 1;\r\natm_return(vcc, truesize);\r\natomic_inc(&vcc->stats->rx_drop);\r\nreturn 0;\r\n}\r\nstruct sk_buff *atm_alloc_charge(struct atm_vcc *vcc, int pdu_size,\r\ngfp_t gfp_flags)\r\n{\r\nstruct sock *sk = sk_atm(vcc);\r\nint guess = atm_guess_pdu2truesize(pdu_size);\r\natm_force_charge(vcc, guess);\r\nif (atomic_read(&sk->sk_rmem_alloc) <= sk->sk_rcvbuf) {\r\nstruct sk_buff *skb = alloc_skb(pdu_size, gfp_flags);\r\nif (skb) {\r\natomic_add(skb->truesize-guess,\r\n&sk->sk_rmem_alloc);\r\nreturn skb;\r\n}\r\n}\r\natm_return(vcc, guess);\r\natomic_inc(&vcc->stats->rx_drop);\r\nreturn NULL;\r\n}\r\nint atm_pcr_goal(const struct atm_trafprm *tp)\r\n{\r\nif (tp->pcr && tp->pcr != ATM_MAX_PCR)\r\nreturn -tp->pcr;\r\nif (tp->min_pcr && !tp->pcr)\r\nreturn tp->min_pcr;\r\nif (tp->max_pcr != ATM_MAX_PCR)\r\nreturn -tp->max_pcr;\r\nreturn 0;\r\n}\r\nvoid sonet_copy_stats(struct k_sonet_stats *from, struct sonet_stats *to)\r\n{\r\n#define __HANDLE_ITEM(i) to->i = atomic_read(&from->i)\r\n__SONET_ITEMS\r\n#undef __HANDLE_ITEM\r\n}\r\nvoid sonet_subtract_stats(struct k_sonet_stats *from, struct sonet_stats *to)\r\n{\r\n#define __HANDLE_ITEM(i) atomic_sub(to->i, &from->i)\r\n__SONET_ITEMS\r\n#undef __HANDLE_ITEM\r\n}

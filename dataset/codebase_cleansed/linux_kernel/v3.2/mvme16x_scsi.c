static __devinit int\r\nmvme16x_probe(struct platform_device *dev)\r\n{\r\nstruct Scsi_Host * host = NULL;\r\nstruct NCR_700_Host_Parameters *hostdata;\r\nif (!MACH_IS_MVME16x)\r\ngoto out;\r\nif (mvme16x_config & MVME16x_CONFIG_NO_SCSICHIP) {\r\nprintk(KERN_INFO "mvme16x-scsi: detection disabled, "\r\n"SCSI chip not present\n");\r\ngoto out;\r\n}\r\nhostdata = kzalloc(sizeof(struct NCR_700_Host_Parameters), GFP_KERNEL);\r\nif (hostdata == NULL) {\r\nprintk(KERN_ERR "mvme16x-scsi: "\r\n"Failed to allocate host data\n");\r\ngoto out;\r\n}\r\nhostdata->base = (void __iomem *)0xfff47000UL;\r\nhostdata->clock = 50;\r\nhostdata->chip710 = 1;\r\nhostdata->dmode_extra = DMODE_FC2;\r\nhostdata->dcntl_extra = EA_710;\r\nhostdata->ctest7_extra = CTEST7_TT1;\r\nhost = NCR_700_detect(&mvme16x_scsi_driver_template, hostdata,\r\n&dev->dev);\r\nif (!host) {\r\nprintk(KERN_ERR "mvme16x-scsi: No host detected; "\r\n"board configuration problem?\n");\r\ngoto out_free;\r\n}\r\nhost->this_id = 7;\r\nhost->base = 0xfff47000UL;\r\nhost->irq = MVME16x_IRQ_SCSI;\r\nif (request_irq(host->irq, NCR_700_intr, 0, "mvme16x-scsi", host)) {\r\nprintk(KERN_ERR "mvme16x-scsi: request_irq failed\n");\r\ngoto out_put_host;\r\n}\r\n{\r\nvolatile unsigned long v;\r\nv = in_be32(0xfff4202c);\r\nv = (v & ~0xff) | 0x10 | 4;\r\nout_be32(0xfff4202c, v);\r\n}\r\nplatform_set_drvdata(dev, host);\r\nscsi_scan_host(host);\r\nreturn 0;\r\nout_put_host:\r\nscsi_host_put(host);\r\nout_free:\r\nkfree(hostdata);\r\nout:\r\nreturn -ENODEV;\r\n}\r\nstatic __devexit int\r\nmvme16x_device_remove(struct platform_device *dev)\r\n{\r\nstruct Scsi_Host *host = platform_get_drvdata(dev);\r\nstruct NCR_700_Host_Parameters *hostdata = shost_priv(host);\r\n{\r\nvolatile unsigned long v;\r\nv = in_be32(0xfff4202c);\r\nv &= ~0x10;\r\nout_be32(0xfff4202c, v);\r\n}\r\nscsi_remove_host(host);\r\nNCR_700_release(host);\r\nkfree(hostdata);\r\nfree_irq(host->irq, host);\r\nreturn 0;\r\n}\r\nstatic int __init mvme16x_scsi_init(void)\r\n{\r\nint err;\r\nerr = platform_driver_register(&mvme16x_scsi_driver);\r\nif (err)\r\nreturn err;\r\nmvme16x_scsi_device = platform_device_register_simple("mvme16x-scsi",\r\n-1, NULL, 0);\r\nif (IS_ERR(mvme16x_scsi_device)) {\r\nplatform_driver_unregister(&mvme16x_scsi_driver);\r\nreturn PTR_ERR(mvme16x_scsi_device);\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit mvme16x_scsi_exit(void)\r\n{\r\nplatform_device_unregister(mvme16x_scsi_device);\r\nplatform_driver_unregister(&mvme16x_scsi_driver);\r\n}

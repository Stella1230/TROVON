static int compass_command(struct i2c_client *c, u8 cmd)\r\n{\r\nint ret = i2c_master_send(c, &cmd, 1);\r\nif (ret < 0)\r\ndev_warn(&c->dev, "command '%c' failed.\n", cmd);\r\nreturn ret;\r\n}\r\nstatic int compass_store(struct device *dev, const char *buf, size_t count,\r\nconst char *map)\r\n{\r\nstruct i2c_client *c = to_i2c_client(dev);\r\nint ret;\r\nunsigned long val;\r\nif (strict_strtoul(buf, 10, &val))\r\nreturn -EINVAL;\r\nif (val >= strlen(map))\r\nreturn -EINVAL;\r\nmutex_lock(&compass_mutex);\r\nret = compass_command(c, map[val]);\r\nmutex_unlock(&compass_mutex);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn count;\r\n}\r\nstatic ssize_t compass_calibration_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nreturn compass_store(dev, buf, count, "EC");\r\n}\r\nstatic ssize_t compass_power_mode_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nreturn compass_store(dev, buf, count, "SW");\r\n}\r\nstatic ssize_t compass_heading_data_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nunsigned char i2c_data[2];\r\nint ret;\r\nmutex_lock(&compass_mutex);\r\nret = compass_command(client, 'A');\r\nif (ret != 1) {\r\nmutex_unlock(&compass_mutex);\r\nreturn ret;\r\n}\r\nmsleep(10);\r\nret = i2c_master_recv(client, i2c_data, 2);\r\nmutex_unlock(&compass_mutex);\r\nif (ret < 0) {\r\ndev_warn(dev, "i2c read data cmd failed\n");\r\nreturn ret;\r\n}\r\nret = (i2c_data[0] << 8) | i2c_data[1];\r\nreturn sprintf(buf, "%d.%d\n", ret/10, ret%10);\r\n}\r\nstatic int hmc6352_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nint res;\r\nres = sysfs_create_group(&client->dev.kobj, &m_compass_gr);\r\nif (res) {\r\ndev_err(&client->dev, "device_create_file failed\n");\r\nreturn res;\r\n}\r\ndev_info(&client->dev, "%s HMC6352 compass chip found\n",\r\nclient->name);\r\nreturn 0;\r\n}\r\nstatic int hmc6352_remove(struct i2c_client *client)\r\n{\r\nsysfs_remove_group(&client->dev.kobj, &m_compass_gr);\r\nreturn 0;\r\n}\r\nstatic int __init sensor_hmc6352_init(void)\r\n{\r\nreturn i2c_add_driver(&hmc6352_driver);\r\n}\r\nstatic void __exit sensor_hmc6352_exit(void)\r\n{\r\ni2c_del_driver(&hmc6352_driver);\r\n}

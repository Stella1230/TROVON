static ssize_t memconsole_read(struct file *filp, struct kobject *kobp,\r\nstruct bin_attribute *bin_attr, char *buf,\r\nloff_t pos, size_t count)\r\n{\r\nreturn memory_read_from_buffer(buf, count, &pos, memconsole_baseaddr,\r\nmemconsole_length);\r\n}\r\nstatic void found_v1_header(struct biosmemcon_ebda *hdr)\r\n{\r\nprintk(KERN_INFO "BIOS console v1 EBDA structure found at %p\n", hdr);\r\nprintk(KERN_INFO "BIOS console buffer at 0x%.8x, "\r\n"start = %d, end = %d, num = %d\n",\r\nhdr->v1.buffer_addr, hdr->v1.start,\r\nhdr->v1.end, hdr->v1.num_chars);\r\nmemconsole_length = hdr->v1.num_chars;\r\nmemconsole_baseaddr = phys_to_virt(hdr->v1.buffer_addr);\r\n}\r\nstatic void found_v2_header(struct biosmemcon_ebda *hdr)\r\n{\r\nprintk(KERN_INFO "BIOS console v2 EBDA structure found at %p\n", hdr);\r\nprintk(KERN_INFO "BIOS console buffer at 0x%.8x, "\r\n"start = %d, end = %d, num_bytes = %d\n",\r\nhdr->v2.buffer_addr, hdr->v2.start,\r\nhdr->v2.end, hdr->v2.num_bytes);\r\nmemconsole_length = hdr->v2.end - hdr->v2.start;\r\nmemconsole_baseaddr = phys_to_virt(hdr->v2.buffer_addr\r\n+ hdr->v2.start);\r\n}\r\nstatic bool found_memconsole(void)\r\n{\r\nunsigned int address;\r\nsize_t length, cur;\r\naddress = get_bios_ebda();\r\nif (!address) {\r\nprintk(KERN_INFO "BIOS EBDA non-existent.\n");\r\nreturn false;\r\n}\r\nlength = *(u8 *)phys_to_virt(address);\r\nlength <<= 10;\r\nfor (cur = 0; cur < length; cur++) {\r\nstruct biosmemcon_ebda *hdr = phys_to_virt(address + cur);\r\nif (hdr->signature == BIOS_MEMCONSOLE_V1_MAGIC) {\r\nfound_v1_header(hdr);\r\nreturn true;\r\n}\r\nif (hdr->signature == BIOS_MEMCONSOLE_V2_MAGIC) {\r\nfound_v2_header(hdr);\r\nreturn true;\r\n}\r\n}\r\nprintk(KERN_INFO "BIOS console EBDA structure not found!\n");\r\nreturn false;\r\n}\r\nstatic int __init memconsole_init(void)\r\n{\r\nint ret;\r\nif (!dmi_check_system(memconsole_dmi_table))\r\nreturn -ENODEV;\r\nif (!found_memconsole())\r\nreturn -ENODEV;\r\nmemconsole_bin_attr.size = memconsole_length;\r\nret = sysfs_create_bin_file(firmware_kobj, &memconsole_bin_attr);\r\nreturn ret;\r\n}\r\nstatic void __exit memconsole_exit(void)\r\n{\r\nsysfs_remove_bin_file(firmware_kobj, &memconsole_bin_attr);\r\n}

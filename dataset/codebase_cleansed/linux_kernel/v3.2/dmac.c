void s6dmac_put_fifo_cache(u32 dmac, int chan, u32 src, u32 dst, u32 size)\r\n{\r\nif (xtensa_need_flush_dma_source(src)) {\r\nu32 base = src;\r\nu32 span = size;\r\nu32 chunk = readl(DMA_CHNL(dmac, chan) + S6_DMA_CMONCHUNK);\r\nif (chunk && (size > chunk)) {\r\ns32 skip =\r\nreadl(DMA_CHNL(dmac, chan) + S6_DMA_SRCSKIP);\r\nu32 gaps = (size+chunk-1)/chunk - 1;\r\nif (skip >= 0) {\r\nspan += gaps * skip;\r\n} else if (-skip > chunk) {\r\ns32 decr = gaps * (chunk + skip);\r\nbase += decr;\r\nspan = chunk - decr;\r\n} else {\r\nspan = max(span + gaps * skip,\r\n(chunk + skip) * gaps - skip);\r\n}\r\n}\r\nflush_dcache_unaligned(base, span);\r\n}\r\nif (xtensa_need_invalidate_dma_destination(dst)) {\r\nu32 base = dst;\r\nu32 span = size;\r\nu32 chunk = readl(DMA_CHNL(dmac, chan) + S6_DMA_CMONCHUNK);\r\nif (chunk && (size > chunk)) {\r\ns32 skip =\r\nreadl(DMA_CHNL(dmac, chan) + S6_DMA_DSTSKIP);\r\nu32 gaps = (size+chunk-1)/chunk - 1;\r\nif (skip >= 0) {\r\nspan += gaps * skip;\r\n} else if (-skip > chunk) {\r\ns32 decr = gaps * (chunk + skip);\r\nbase += decr;\r\nspan = chunk - decr;\r\n} else {\r\nspan = max(span + gaps * skip,\r\n(chunk + skip) * gaps - skip);\r\n}\r\n}\r\ninvalidate_dcache_unaligned(base, span);\r\n}\r\ns6dmac_put_fifo(dmac, chan, src, dst, size);\r\n}\r\nvoid s6dmac_disable_error_irqs(u32 dmac, u32 mask)\r\n{\r\nunsigned long flags;\r\nspinlock_t *spinl = &s6dmac_ctrl[_dmac_addr_index(dmac)].lock;\r\nspin_lock_irqsave(spinl, flags);\r\n_s6dmac_disable_error_irqs(dmac, mask);\r\nspin_unlock_irqrestore(spinl, flags);\r\n}\r\nu32 s6dmac_int_sources(u32 dmac, u32 channel)\r\n{\r\nu32 mask, ret, tmp;\r\nmask = 1 << channel;\r\ntmp = readl(dmac + S6_DMA_TERMCNTIRQSTAT);\r\ntmp &= mask;\r\nwritel(tmp, dmac + S6_DMA_TERMCNTIRQCLR);\r\nret = tmp >> channel;\r\ntmp = readl(dmac + S6_DMA_PENDCNTIRQSTAT);\r\ntmp &= mask;\r\nwritel(tmp, dmac + S6_DMA_PENDCNTIRQCLR);\r\nret |= (tmp >> channel) << 1;\r\ntmp = readl(dmac + S6_DMA_LOWWMRKIRQSTAT);\r\ntmp &= mask;\r\nwritel(tmp, dmac + S6_DMA_LOWWMRKIRQCLR);\r\nret |= (tmp >> channel) << 2;\r\ntmp = readl(dmac + S6_DMA_INTRAW0);\r\ntmp &= (mask << S6_DMA_INT0_OVER) | (mask << S6_DMA_INT0_UNDER);\r\nwritel(tmp, dmac + S6_DMA_INTCLEAR0);\r\nif (tmp & (mask << S6_DMA_INT0_UNDER))\r\nret |= 1 << 3;\r\nif (tmp & (mask << S6_DMA_INT0_OVER))\r\nret |= 1 << 4;\r\ntmp = readl(dmac + S6_DMA_MASTERERRINFO);\r\nmask <<= S6_DMA_INT1_CHANNEL;\r\nif (((tmp >> S6_DMA_MASTERERR_CHAN(0)) & S6_DMA_MASTERERR_CHAN_MASK)\r\n== channel)\r\nmask |= 1 << S6_DMA_INT1_MASTER;\r\nif (((tmp >> S6_DMA_MASTERERR_CHAN(1)) & S6_DMA_MASTERERR_CHAN_MASK)\r\n== channel)\r\nmask |= 1 << (S6_DMA_INT1_MASTER + 1);\r\nif (((tmp >> S6_DMA_MASTERERR_CHAN(2)) & S6_DMA_MASTERERR_CHAN_MASK)\r\n== channel)\r\nmask |= 1 << (S6_DMA_INT1_MASTER + 2);\r\ntmp = readl(dmac + S6_DMA_INTRAW1) & mask;\r\nwritel(tmp, dmac + S6_DMA_INTCLEAR1);\r\nret |= ((tmp >> channel) & 1) << 5;\r\nret |= ((tmp >> S6_DMA_INT1_MASTER) & S6_DMA_INT1_MASTER_MASK) << 6;\r\nreturn ret;\r\n}\r\nvoid s6dmac_release_chan(u32 dmac, int chan)\r\n{\r\nif (chan >= 0)\r\ns6dmac_disable_chan(dmac, chan);\r\n}\r\nstatic inline void __init dmac_init(u32 dmac, u8 chan_nb)\r\n{\r\ns6dmac_ctrl[S6_DMAC_INDEX(dmac)].dmac = dmac;\r\nspin_lock_init(&s6dmac_ctrl[S6_DMAC_INDEX(dmac)].lock);\r\ns6dmac_ctrl[S6_DMAC_INDEX(dmac)].chan_nb = chan_nb;\r\nwritel(S6_DMA_INT1_MASTER_MASK << S6_DMA_INT1_MASTER,\r\ndmac + S6_DMA_INTCLEAR1);\r\n}\r\nstatic inline void __init dmac_master(u32 dmac,\r\nu32 m0start, u32 m0end, u32 m1start, u32 m1end)\r\n{\r\nwritel(m0start, dmac + S6_DMA_MASTER0START);\r\nwritel(m0end - 1, dmac + S6_DMA_MASTER0END);\r\nwritel(m1start, dmac + S6_DMA_MASTER1START);\r\nwritel(m1end - 1, dmac + S6_DMA_MASTER1END);\r\n}\r\nstatic void __init s6_dmac_init(void)\r\n{\r\ndmac_init(S6_REG_LMSDMA, S6_LMSDMA_NB);\r\ndmac_master(S6_REG_LMSDMA,\r\nS6_MEM_DDR, S6_MEM_PCIE_APER, S6_MEM_EFI, S6_MEM_GMAC);\r\ndmac_init(S6_REG_NIDMA, S6_NIDMA_NB);\r\ndmac_init(S6_REG_DPDMA, S6_DPDMA_NB);\r\ndmac_master(S6_REG_DPDMA,\r\nS6_MEM_DDR, S6_MEM_PCIE_APER, S6_REG_DP, S6_REG_DPDMA);\r\ndmac_init(S6_REG_HIFDMA, S6_HIFDMA_NB);\r\ndmac_master(S6_REG_HIFDMA,\r\nS6_MEM_GMAC, S6_MEM_PCIE_CFG, S6_MEM_PCIE_APER, S6_MEM_AUX);\r\n}

static int vlan_seq_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open_net(inode, file, &vlan_seq_ops,\r\nsizeof(struct seq_net_private));\r\n}\r\nstatic int vlandev_seq_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, vlandev_seq_show, PDE(inode)->data);\r\n}\r\nvoid vlan_proc_cleanup(struct net *net)\r\n{\r\nstruct vlan_net *vn = net_generic(net, vlan_net_id);\r\nif (vn->proc_vlan_conf)\r\nremove_proc_entry(name_conf, vn->proc_vlan_dir);\r\nif (vn->proc_vlan_dir)\r\nproc_net_remove(net, name_root);\r\n}\r\nint __net_init vlan_proc_init(struct net *net)\r\n{\r\nstruct vlan_net *vn = net_generic(net, vlan_net_id);\r\nvn->proc_vlan_dir = proc_net_mkdir(net, name_root, net->proc_net);\r\nif (!vn->proc_vlan_dir)\r\ngoto err;\r\nvn->proc_vlan_conf = proc_create(name_conf, S_IFREG|S_IRUSR|S_IWUSR,\r\nvn->proc_vlan_dir, &vlan_fops);\r\nif (!vn->proc_vlan_conf)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\npr_err("can't create entry in proc filesystem!\n");\r\nvlan_proc_cleanup(net);\r\nreturn -ENOBUFS;\r\n}\r\nint vlan_proc_add_dev(struct net_device *vlandev)\r\n{\r\nstruct vlan_dev_info *dev_info = vlan_dev_info(vlandev);\r\nstruct vlan_net *vn = net_generic(dev_net(vlandev), vlan_net_id);\r\ndev_info->dent =\r\nproc_create_data(vlandev->name, S_IFREG|S_IRUSR|S_IWUSR,\r\nvn->proc_vlan_dir, &vlandev_fops, vlandev);\r\nif (!dev_info->dent)\r\nreturn -ENOBUFS;\r\nreturn 0;\r\n}\r\nint vlan_proc_rem_dev(struct net_device *vlandev)\r\n{\r\nstruct vlan_net *vn = net_generic(dev_net(vlandev), vlan_net_id);\r\nif (vlan_dev_info(vlandev)->dent) {\r\nremove_proc_entry(vlan_dev_info(vlandev)->dent->name,\r\nvn->proc_vlan_dir);\r\nvlan_dev_info(vlandev)->dent = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void *vlan_seq_start(struct seq_file *seq, loff_t *pos)\r\n__acquires(rcu)\r\n{\r\nstruct net_device *dev;\r\nstruct net *net = seq_file_net(seq);\r\nloff_t i = 1;\r\nrcu_read_lock();\r\nif (*pos == 0)\r\nreturn SEQ_START_TOKEN;\r\nfor_each_netdev_rcu(net, dev) {\r\nif (!is_vlan_dev(dev))\r\ncontinue;\r\nif (i++ == *pos)\r\nreturn dev;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void *vlan_seq_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nstruct net_device *dev;\r\nstruct net *net = seq_file_net(seq);\r\n++*pos;\r\ndev = v;\r\nif (v == SEQ_START_TOKEN)\r\ndev = net_device_entry(&net->dev_base_head);\r\nfor_each_netdev_continue_rcu(net, dev) {\r\nif (!is_vlan_dev(dev))\r\ncontinue;\r\nreturn dev;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void vlan_seq_stop(struct seq_file *seq, void *v)\r\n__releases(rcu)\r\n{\r\nrcu_read_unlock();\r\n}\r\nstatic int vlan_seq_show(struct seq_file *seq, void *v)\r\n{\r\nstruct net *net = seq_file_net(seq);\r\nstruct vlan_net *vn = net_generic(net, vlan_net_id);\r\nif (v == SEQ_START_TOKEN) {\r\nconst char *nmtype = NULL;\r\nseq_puts(seq, "VLAN Dev name | VLAN ID\n");\r\nif (vn->name_type < ARRAY_SIZE(vlan_name_type_str))\r\nnmtype = vlan_name_type_str[vn->name_type];\r\nseq_printf(seq, "Name-Type: %s\n",\r\nnmtype ? nmtype : "UNKNOWN");\r\n} else {\r\nconst struct net_device *vlandev = v;\r\nconst struct vlan_dev_info *dev_info = vlan_dev_info(vlandev);\r\nseq_printf(seq, "%-15s| %d | %s\n", vlandev->name,\r\ndev_info->vlan_id, dev_info->real_dev->name);\r\n}\r\nreturn 0;\r\n}\r\nstatic int vlandev_seq_show(struct seq_file *seq, void *offset)\r\n{\r\nstruct net_device *vlandev = (struct net_device *) seq->private;\r\nconst struct vlan_dev_info *dev_info = vlan_dev_info(vlandev);\r\nstruct rtnl_link_stats64 temp;\r\nconst struct rtnl_link_stats64 *stats;\r\nstatic const char fmt64[] = "%30s %12llu\n";\r\nint i;\r\nif (!is_vlan_dev(vlandev))\r\nreturn 0;\r\nstats = dev_get_stats(vlandev, &temp);\r\nseq_printf(seq,\r\n"%s VID: %d REORDER_HDR: %i dev->priv_flags: %hx\n",\r\nvlandev->name, dev_info->vlan_id,\r\n(int)(dev_info->flags & 1), vlandev->priv_flags);\r\nseq_printf(seq, fmt64, "total frames received", stats->rx_packets);\r\nseq_printf(seq, fmt64, "total bytes received", stats->rx_bytes);\r\nseq_printf(seq, fmt64, "Broadcast/Multicast Rcvd", stats->multicast);\r\nseq_puts(seq, "\n");\r\nseq_printf(seq, fmt64, "total frames transmitted", stats->tx_packets);\r\nseq_printf(seq, fmt64, "total bytes transmitted", stats->tx_bytes);\r\nseq_printf(seq, "Device: %s", dev_info->real_dev->name);\r\nseq_printf(seq, "\nINGRESS priority mappings: "\r\n"0:%u 1:%u 2:%u 3:%u 4:%u 5:%u 6:%u 7:%u\n",\r\ndev_info->ingress_priority_map[0],\r\ndev_info->ingress_priority_map[1],\r\ndev_info->ingress_priority_map[2],\r\ndev_info->ingress_priority_map[3],\r\ndev_info->ingress_priority_map[4],\r\ndev_info->ingress_priority_map[5],\r\ndev_info->ingress_priority_map[6],\r\ndev_info->ingress_priority_map[7]);\r\nseq_printf(seq, " EGRESS priority mappings: ");\r\nfor (i = 0; i < 16; i++) {\r\nconst struct vlan_priority_tci_mapping *mp\r\n= dev_info->egress_priority_map[i];\r\nwhile (mp) {\r\nseq_printf(seq, "%u:%hu ",\r\nmp->priority, ((mp->vlan_qos >> 13) & 0x7));\r\nmp = mp->next;\r\n}\r\n}\r\nseq_puts(seq, "\n");\r\nreturn 0;\r\n}

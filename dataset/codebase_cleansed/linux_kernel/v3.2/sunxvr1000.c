static int __devinit gfb_get_props(struct gfb_info *gp)\r\n{\r\ngp->width = of_getintprop_default(gp->of_node, "width", 0);\r\ngp->height = of_getintprop_default(gp->of_node, "height", 0);\r\ngp->depth = of_getintprop_default(gp->of_node, "depth", 32);\r\nif (!gp->width || !gp->height) {\r\nprintk(KERN_ERR "gfb: Critical properties missing for %s\n",\r\ngp->of_node->full_name);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int gfb_setcolreg(unsigned regno,\r\nunsigned red, unsigned green, unsigned blue,\r\nunsigned transp, struct fb_info *info)\r\n{\r\nu32 value;\r\nif (regno < 16) {\r\nred >>= 8;\r\ngreen >>= 8;\r\nblue >>= 8;\r\nvalue = (blue << 16) | (green << 8) | red;\r\n((u32 *)info->pseudo_palette)[regno] = value;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit gfb_set_fbinfo(struct gfb_info *gp)\r\n{\r\nstruct fb_info *info = gp->info;\r\nstruct fb_var_screeninfo *var = &info->var;\r\ninfo->flags = FBINFO_DEFAULT;\r\ninfo->fbops = &gfb_ops;\r\ninfo->screen_base = gp->fb_base;\r\ninfo->screen_size = gp->fb_size;\r\ninfo->pseudo_palette = gp->pseudo_palette;\r\nstrlcpy(info->fix.id, "gfb", sizeof(info->fix.id));\r\ninfo->fix.smem_start = gp->fb_base_phys;\r\ninfo->fix.smem_len = gp->fb_size;\r\ninfo->fix.type = FB_TYPE_PACKED_PIXELS;\r\nif (gp->depth == 32 || gp->depth == 24)\r\ninfo->fix.visual = FB_VISUAL_TRUECOLOR;\r\nelse\r\ninfo->fix.visual = FB_VISUAL_PSEUDOCOLOR;\r\nvar->xres = gp->width;\r\nvar->yres = gp->height;\r\nvar->xres_virtual = var->xres;\r\nvar->yres_virtual = var->yres;\r\nvar->bits_per_pixel = gp->depth;\r\nvar->red.offset = 0;\r\nvar->red.length = 8;\r\nvar->green.offset = 8;\r\nvar->green.length = 8;\r\nvar->blue.offset = 16;\r\nvar->blue.length = 8;\r\nvar->transp.offset = 0;\r\nvar->transp.length = 0;\r\nif (fb_alloc_cmap(&info->cmap, 256, 0)) {\r\nprintk(KERN_ERR "gfb: Cannot allocate color map.\n");\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit gfb_probe(struct platform_device *op)\r\n{\r\nstruct device_node *dp = op->dev.of_node;\r\nstruct fb_info *info;\r\nstruct gfb_info *gp;\r\nint err;\r\ninfo = framebuffer_alloc(sizeof(struct gfb_info), &op->dev);\r\nif (!info) {\r\nprintk(KERN_ERR "gfb: Cannot allocate fb_info\n");\r\nerr = -ENOMEM;\r\ngoto err_out;\r\n}\r\ngp = info->par;\r\ngp->info = info;\r\ngp->of_node = dp;\r\ngp->fb_base_phys = op->resource[6].start;\r\nerr = gfb_get_props(gp);\r\nif (err)\r\ngoto err_release_fb;\r\ninfo->fix.line_length = 16384;\r\ngp->fb_size = info->fix.line_length * gp->height;\r\ngp->fb_base = of_ioremap(&op->resource[6], 0,\r\ngp->fb_size, "gfb fb");\r\nif (!gp->fb_base)\r\ngoto err_release_fb;\r\nerr = gfb_set_fbinfo(gp);\r\nif (err)\r\ngoto err_unmap_fb;\r\nprintk("gfb: Found device at %s\n", dp->full_name);\r\nerr = register_framebuffer(info);\r\nif (err < 0) {\r\nprintk(KERN_ERR "gfb: Could not register framebuffer %s\n",\r\ndp->full_name);\r\ngoto err_unmap_fb;\r\n}\r\ndev_set_drvdata(&op->dev, info);\r\nreturn 0;\r\nerr_unmap_fb:\r\nof_iounmap(&op->resource[6], gp->fb_base, gp->fb_size);\r\nerr_release_fb:\r\nframebuffer_release(info);\r\nerr_out:\r\nreturn err;\r\n}\r\nstatic int __devexit gfb_remove(struct platform_device *op)\r\n{\r\nstruct fb_info *info = dev_get_drvdata(&op->dev);\r\nstruct gfb_info *gp = info->par;\r\nunregister_framebuffer(info);\r\niounmap(gp->fb_base);\r\nof_iounmap(&op->resource[6], gp->fb_base, gp->fb_size);\r\nframebuffer_release(info);\r\ndev_set_drvdata(&op->dev, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init gfb_init(void)\r\n{\r\nif (fb_get_options("gfb", NULL))\r\nreturn -ENODEV;\r\nreturn platform_driver_register(&gfb_driver);\r\n}\r\nstatic void __exit gfb_exit(void)\r\n{\r\nplatform_driver_unregister(&gfb_driver);\r\n}

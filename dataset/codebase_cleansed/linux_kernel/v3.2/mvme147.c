static irqreturn_t mvme147_intr(int irq, void *data)\r\n{\r\nstruct Scsi_Host *instance = data;\r\nif (irq == MVME147_IRQ_SCSI_PORT)\r\nwd33c93_intr(instance);\r\nelse\r\nm147_pcc->dma_intr = 0x89;\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int dma_setup(struct scsi_cmnd *cmd, int dir_in)\r\n{\r\nstruct Scsi_Host *instance = cmd->device->host;\r\nstruct WD33C93_hostdata *hdata = shost_priv(instance);\r\nunsigned char flags = 0x01;\r\nunsigned long addr = virt_to_bus(cmd->SCp.ptr);\r\nif (!dir_in)\r\nflags |= 0x04;\r\nhdata->dma_dir = dir_in;\r\nif (dir_in) {\r\ncache_clear(addr, cmd->SCp.this_residual);\r\n} else {\r\ncache_push(addr, cmd->SCp.this_residual);\r\n}\r\nm147_pcc->dma_bcr = cmd->SCp.this_residual | (1 << 24);\r\nm147_pcc->dma_dadr = addr;\r\nm147_pcc->dma_cntrl = flags;\r\nreturn 0;\r\n}\r\nstatic void dma_stop(struct Scsi_Host *instance, struct scsi_cmnd *SCpnt,\r\nint status)\r\n{\r\nm147_pcc->dma_cntrl = 0;\r\n}\r\nint mvme147_detect(struct scsi_host_template *tpnt)\r\n{\r\nstatic unsigned char called = 0;\r\nstruct Scsi_Host *instance;\r\nwd33c93_regs regs;\r\nstruct WD33C93_hostdata *hdata;\r\nif (!MACH_IS_MVME147 || called)\r\nreturn 0;\r\ncalled++;\r\ntpnt->proc_name = "MVME147";\r\ntpnt->proc_info = &wd33c93_proc_info;\r\ninstance = scsi_register(tpnt, sizeof(struct WD33C93_hostdata));\r\nif (!instance)\r\ngoto err_out;\r\ninstance->base = 0xfffe4000;\r\ninstance->irq = MVME147_IRQ_SCSI_PORT;\r\nregs.SASR = (volatile unsigned char *)0xfffe4000;\r\nregs.SCMD = (volatile unsigned char *)0xfffe4001;\r\nhdata = shost_priv(instance);\r\nhdata->no_sync = 0xff;\r\nhdata->fast = 0;\r\nhdata->dma_mode = CTRL_DMA;\r\nwd33c93_init(instance, regs, dma_setup, dma_stop, WD33C93_FS_8_10);\r\nif (request_irq(MVME147_IRQ_SCSI_PORT, mvme147_intr, 0,\r\n"MVME147 SCSI PORT", instance))\r\ngoto err_unregister;\r\nif (request_irq(MVME147_IRQ_SCSI_DMA, mvme147_intr, 0,\r\n"MVME147 SCSI DMA", instance))\r\ngoto err_free_irq;\r\n#if 0\r\nm147_pcc->scsi_interrupt = 0x10;\r\nudelay(100);\r\nm147_pcc->scsi_interrupt = 0x00;\r\nudelay(2000);\r\nm147_pcc->scsi_interrupt = 0x40;\r\n#endif\r\nm147_pcc->scsi_interrupt = 0x09;\r\nm147_pcc->dma_cntrl = 0x00;\r\nm147_pcc->dma_intr = 0x89;\r\nreturn 1;\r\nerr_free_irq:\r\nfree_irq(MVME147_IRQ_SCSI_PORT, mvme147_intr);\r\nerr_unregister:\r\nscsi_unregister(instance);\r\nerr_out:\r\nreturn 0;\r\n}\r\nstatic int mvme147_bus_reset(struct scsi_cmnd *cmd)\r\n{\r\nspin_lock_irq(cmd->device->host->host_lock);\r\nwd33c93_host_reset(cmd);\r\nspin_unlock_irq(cmd->device->host->host_lock);\r\nreturn SUCCESS;\r\n}\r\nint mvme147_release(struct Scsi_Host *instance)\r\n{\r\n#ifdef MODULE\r\nfree_irq(MVME147_IRQ_SCSI_PORT, mvme147_intr);\r\nfree_irq(MVME147_IRQ_SCSI_DMA, mvme147_intr);\r\n#endif\r\nreturn 1;\r\n}

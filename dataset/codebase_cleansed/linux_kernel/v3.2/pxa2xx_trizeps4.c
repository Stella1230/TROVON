static int trizeps_pcmcia_hw_init(struct soc_pcmcia_socket *skt)\r\n{\r\nint ret, i;\r\nswitch (skt->nr) {\r\ncase 0:\r\nif (gpio_request(GPIO_PRDY, "cf_irq") < 0) {\r\npr_err("%s: sock %d unable to request gpio %d\n", __func__,\r\nskt->nr, GPIO_PRDY);\r\nreturn -EBUSY;\r\n}\r\nif (gpio_direction_input(GPIO_PRDY) < 0) {\r\npr_err("%s: sock %d unable to set input gpio %d\n", __func__,\r\nskt->nr, GPIO_PRDY);\r\ngpio_free(GPIO_PRDY);\r\nreturn -EINVAL;\r\n}\r\nskt->socket.pci_irq = IRQ_GPIO(GPIO_PRDY);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\npr_debug("%s: sock %d irq %d\n", __func__, skt->nr, skt->socket.pci_irq);\r\nfor (i = 0; i < ARRAY_SIZE(irqs); i++) {\r\nif (irqs[i].sock != skt->nr)\r\ncontinue;\r\nif (gpio_request(irq_to_gpio(irqs[i].irq), irqs[i].str) < 0) {\r\npr_err("%s: sock %d unable to request gpio %d\n",\r\n__func__, skt->nr, irq_to_gpio(irqs[i].irq));\r\nret = -EBUSY;\r\ngoto error;\r\n}\r\nif (gpio_direction_input(irq_to_gpio(irqs[i].irq)) < 0) {\r\npr_err("%s: sock %d unable to set input gpio %d\n",\r\n__func__, skt->nr, irq_to_gpio(irqs[i].irq));\r\nret = -EINVAL;\r\ngoto error;\r\n}\r\n}\r\nreturn soc_pcmcia_request_irqs(skt, irqs, ARRAY_SIZE(irqs));\r\nerror:\r\nfor (; i >= 0; i--) {\r\ngpio_free(irq_to_gpio(irqs[i].irq));\r\n}\r\nreturn (ret);\r\n}\r\nstatic void trizeps_pcmcia_hw_shutdown(struct soc_pcmcia_socket *skt)\r\n{\r\nint i;\r\ngpio_free(GPIO_PRDY);\r\nfor (i = 0; i < ARRAY_SIZE(irqs); i++)\r\ngpio_free(irq_to_gpio(irqs[i].irq));\r\n}\r\nstatic void trizeps_pcmcia_socket_state(struct soc_pcmcia_socket *skt,\r\nstruct pcmcia_state *state)\r\n{\r\nunsigned short status = 0, change;\r\nstatus = CFSR_readw();\r\nchange = (status ^ trizeps_pcmcia_status[skt->nr]) &\r\nConXS_CFSR_BVD_MASK;\r\nif (change) {\r\ntrizeps_pcmcia_status[skt->nr] = status;\r\nif (status & ConXS_CFSR_BVD1) {\r\n} else {\r\n}\r\n}\r\nswitch (skt->nr) {\r\ncase 0:\r\nstate->detect = gpio_get_value(GPIO_PCD) ? 0 : 1;\r\nstate->ready = gpio_get_value(GPIO_PRDY) ? 1 : 0;\r\nstate->bvd1 = (status & ConXS_CFSR_BVD1) ? 1 : 0;\r\nstate->bvd2 = (status & ConXS_CFSR_BVD2) ? 1 : 0;\r\nstate->vs_3v = (status & ConXS_CFSR_VS1) ? 0 : 1;\r\nstate->vs_Xv = (status & ConXS_CFSR_VS2) ? 0 : 1;\r\nstate->wrprot = 0;\r\nbreak;\r\n#ifndef CONFIG_MACH_TRIZEPS_CONXS\r\ncase 1:\r\nstate->detect = 0;\r\nstate->ready = 0;\r\nstate->bvd1 = 0;\r\nstate->bvd2 = 0;\r\nstate->vs_3v = 0;\r\nstate->vs_Xv = 0;\r\nstate->wrprot = 0;\r\nbreak;\r\n#endif\r\n}\r\n}\r\nstatic int trizeps_pcmcia_configure_socket(struct soc_pcmcia_socket *skt,\r\nconst socket_state_t *state)\r\n{\r\nint ret = 0;\r\nunsigned short power = 0;\r\nswitch (state->Vcc) {\r\ncase 0: power &= 0xfc; break;\r\ncase 33: power |= ConXS_BCR_S0_VCC_3V3; break;\r\ncase 50:\r\npr_err("%s(): Vcc 5V not supported in socket\n", __func__);\r\nbreak;\r\ndefault:\r\npr_err("%s(): bad Vcc %u\n", __func__, state->Vcc);\r\nret = -1;\r\n}\r\nswitch (state->Vpp) {\r\ncase 0: power &= 0xf3; break;\r\ncase 33: power |= ConXS_BCR_S0_VPP_3V3; break;\r\ncase 120:\r\npr_err("%s(): Vpp 12V not supported in socket\n", __func__);\r\nbreak;\r\ndefault:\r\nif (state->Vpp != state->Vcc) {\r\npr_err("%s(): bad Vpp %u\n", __func__, state->Vpp);\r\nret = -1;\r\n}\r\n}\r\nswitch (skt->nr) {\r\ncase 0:\r\nboard_pcmcia_power(power);\r\nbreak;\r\n#ifndef CONFIG_MACH_TRIZEPS_CONXS\r\ncase 1:\r\n#endif\r\ndefault:\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic void trizeps_pcmcia_socket_init(struct soc_pcmcia_socket *skt)\r\n{\r\nboard_pcmcia_power(0x9);\r\n}\r\nstatic void trizeps_pcmcia_socket_suspend(struct soc_pcmcia_socket *skt)\r\n{\r\nboard_pcmcia_power(0x0);\r\n}\r\nstatic int __init trizeps_pcmcia_init(void)\r\n{\r\nint ret;\r\nif (!machine_is_trizeps4() && !machine_is_trizeps4wl())\r\nreturn -ENODEV;\r\ntrizeps_pcmcia_device = platform_device_alloc("pxa2xx-pcmcia", -1);\r\nif (!trizeps_pcmcia_device)\r\nreturn -ENOMEM;\r\nret = platform_device_add_data(trizeps_pcmcia_device,\r\n&trizeps_pcmcia_ops, sizeof(trizeps_pcmcia_ops));\r\nif (ret == 0)\r\nret = platform_device_add(trizeps_pcmcia_device);\r\nif (ret)\r\nplatform_device_put(trizeps_pcmcia_device);\r\nreturn ret;\r\n}\r\nstatic void __exit trizeps_pcmcia_exit(void)\r\n{\r\nplatform_device_unregister(trizeps_pcmcia_device);\r\n}

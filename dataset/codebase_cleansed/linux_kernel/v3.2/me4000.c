static inline void me4000_outb(struct comedi_device *dev, unsigned char value,\r\nunsigned long port)\r\n{\r\nPORT_PDEBUG("--> 0x%02X port 0x%04lX\n", value, port);\r\noutb(value, port);\r\n}\r\nstatic inline void me4000_outl(struct comedi_device *dev, unsigned long value,\r\nunsigned long port)\r\n{\r\nPORT_PDEBUG("--> 0x%08lX port 0x%04lX\n", value, port);\r\noutl(value, port);\r\n}\r\nstatic inline unsigned long me4000_inl(struct comedi_device *dev,\r\nunsigned long port)\r\n{\r\nunsigned long value;\r\nvalue = inl(port);\r\nPORT_PDEBUG("<-- 0x%08lX port 0x%04lX\n", value, port);\r\nreturn value;\r\n}\r\nstatic inline unsigned char me4000_inb(struct comedi_device *dev,\r\nunsigned long port)\r\n{\r\nunsigned char value;\r\nvalue = inb(port);\r\nPORT_PDEBUG("<-- 0x%08X port 0x%04lX\n", value, port);\r\nreturn value;\r\n}\r\nstatic int me4000_attach(struct comedi_device *dev, struct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nint result;\r\nCALL_PDEBUG("In me4000_attach()\n");\r\nresult = me4000_probe(dev, it);\r\nif (result)\r\nreturn result;\r\nif (alloc_subdevices(dev, 4) < 0)\r\nreturn -ENOMEM;\r\ns = dev->subdevices + 0;\r\nif (thisboard->ai.count) {\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags =\r\nSDF_READABLE | SDF_COMMON | SDF_GROUND | SDF_DIFF;\r\ns->n_chan = thisboard->ai.count;\r\ns->maxdata = 0xFFFF;\r\ns->len_chanlist = ME4000_AI_CHANNEL_LIST_COUNT;\r\ns->range_table = &me4000_ai_range;\r\ns->insn_read = me4000_ai_insn_read;\r\nif (info->irq > 0) {\r\nif (request_irq(info->irq, me4000_ai_isr,\r\nIRQF_SHARED, "ME-4000", dev)) {\r\nprintk\r\n("comedi%d: me4000: me4000_attach(): "\r\n"Unable to allocate irq\n", dev->minor);\r\n} else {\r\ndev->read_subdev = s;\r\ns->subdev_flags |= SDF_CMD_READ;\r\ns->cancel = me4000_ai_cancel;\r\ns->do_cmdtest = me4000_ai_do_cmd_test;\r\ns->do_cmd = me4000_ai_do_cmd;\r\n}\r\n} else {\r\nprintk(KERN_WARNING\r\n"comedi%d: me4000: me4000_attach(): "\r\n"No interrupt available\n", dev->minor);\r\n}\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = dev->subdevices + 1;\r\nif (thisboard->ao.count) {\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITEABLE | SDF_COMMON | SDF_GROUND;\r\ns->n_chan = thisboard->ao.count;\r\ns->maxdata = 0xFFFF;\r\ns->range_table = &me4000_ao_range;\r\ns->insn_write = me4000_ao_insn_write;\r\ns->insn_read = me4000_ao_insn_read;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = dev->subdevices + 2;\r\nif (thisboard->dio.count) {\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = thisboard->dio.count * 8;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = me4000_dio_insn_bits;\r\ns->insn_config = me4000_dio_insn_config;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\nif (!me4000_inl(dev, info->dio_context.dir_reg)) {\r\ns->io_bits |= 0xFF;\r\nme4000_outl(dev, ME4000_DIO_CTRL_BIT_MODE_0,\r\ninfo->dio_context.dir_reg);\r\n}\r\ns = dev->subdevices + 3;\r\nif (thisboard->cnt.count) {\r\ns->type = COMEDI_SUBD_COUNTER;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = thisboard->cnt.count;\r\ns->maxdata = 0xFFFF;\r\ns->insn_read = me4000_cnt_insn_read;\r\ns->insn_write = me4000_cnt_insn_write;\r\ns->insn_config = me4000_cnt_insn_config;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\nreturn 0;\r\n}\r\nstatic int me4000_probe(struct comedi_device *dev, struct comedi_devconfig *it)\r\n{\r\nstruct pci_dev *pci_device = NULL;\r\nint result, i;\r\nstruct me4000_board *board;\r\nCALL_PDEBUG("In me4000_probe()\n");\r\nif (alloc_private(dev, sizeof(struct me4000_info)) < 0)\r\nreturn -ENOMEM;\r\nfor_each_pci_dev(pci_device) {\r\nif (pci_device->vendor == PCI_VENDOR_ID_MEILHAUS) {\r\nfor (i = 0; i < ME4000_BOARD_VERSIONS; i++) {\r\nif (me4000_boards[i].device_id ==\r\npci_device->device) {\r\nif ((it->options[0] != 0)\r\n|| (it->options[1] != 0)) {\r\nif (pci_device->bus->number !=\r\nit->options[0]\r\n||\r\nPCI_SLOT(pci_device->devfn)\r\n!= it->options[1]) {\r\ncontinue;\r\n}\r\n}\r\ndev->board_ptr = me4000_boards + i;\r\nboard =\r\n(struct me4000_board *)\r\ndev->board_ptr;\r\ninfo->pci_dev_p = pci_device;\r\ngoto found;\r\n}\r\n}\r\n}\r\n}\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_probe(): "\r\n"No supported board found (req. bus/slot : %d/%d)\n",\r\ndev->minor, it->options[0], it->options[1]);\r\nreturn -ENODEV;\r\nfound:\r\nprintk(KERN_INFO\r\n"comedi%d: me4000: me4000_probe(): "\r\n"Found %s at PCI bus %d, slot %d\n",\r\ndev->minor, me4000_boards[i].name, pci_device->bus->number,\r\nPCI_SLOT(pci_device->devfn));\r\ndev->board_name = board->name;\r\nresult = comedi_pci_enable(pci_device, dev->board_name);\r\nif (result) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_probe(): Cannot enable PCI "\r\n"device and request I/O regions\n", dev->minor);\r\nreturn result;\r\n}\r\nresult = get_registers(dev, pci_device);\r\nif (result) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_probe(): "\r\n"Cannot get registers\n", dev->minor);\r\nreturn result;\r\n}\r\nresult = init_board_info(dev, pci_device);\r\nif (result) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_probe(): "\r\n"Cannot init baord info\n", dev->minor);\r\nreturn result;\r\n}\r\nresult = init_ao_context(dev);\r\nif (result) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_probe(): "\r\n"Cannot init ao context\n", dev->minor);\r\nreturn result;\r\n}\r\nresult = init_ai_context(dev);\r\nif (result) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_probe(): "\r\n"Cannot init ai context\n", dev->minor);\r\nreturn result;\r\n}\r\nresult = init_dio_context(dev);\r\nif (result) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_probe(): "\r\n"Cannot init dio context\n", dev->minor);\r\nreturn result;\r\n}\r\nresult = init_cnt_context(dev);\r\nif (result) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_probe(): "\r\n"Cannot init cnt context\n", dev->minor);\r\nreturn result;\r\n}\r\nresult = xilinx_download(dev);\r\nif (result) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_probe(): "\r\n"Can't download firmware\n", dev->minor);\r\nreturn result;\r\n}\r\nresult = reset_board(dev);\r\nif (result) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_probe(): Can't reset board\n",\r\ndev->minor);\r\nreturn result;\r\n}\r\nreturn 0;\r\n}\r\nstatic int get_registers(struct comedi_device *dev, struct pci_dev *pci_dev_p)\r\n{\r\nCALL_PDEBUG("In get_registers()\n");\r\ninfo->plx_regbase = pci_resource_start(pci_dev_p, 1);\r\nif (info->plx_regbase == 0) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: get_registers(): "\r\n"PCI base address 1 is not available\n", dev->minor);\r\nreturn -ENODEV;\r\n}\r\ninfo->plx_regbase_size = pci_resource_len(pci_dev_p, 1);\r\ninfo->me4000_regbase = pci_resource_start(pci_dev_p, 2);\r\nif (info->me4000_regbase == 0) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: get_registers(): "\r\n"PCI base address 2 is not available\n", dev->minor);\r\nreturn -ENODEV;\r\n}\r\ninfo->me4000_regbase_size = pci_resource_len(pci_dev_p, 2);\r\ninfo->timer_regbase = pci_resource_start(pci_dev_p, 3);\r\nif (info->timer_regbase == 0) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: get_registers(): "\r\n"PCI base address 3 is not available\n", dev->minor);\r\nreturn -ENODEV;\r\n}\r\ninfo->timer_regbase_size = pci_resource_len(pci_dev_p, 3);\r\ninfo->program_regbase = pci_resource_start(pci_dev_p, 5);\r\nif (info->program_regbase == 0) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: get_registers(): "\r\n"PCI base address 5 is not available\n", dev->minor);\r\nreturn -ENODEV;\r\n}\r\ninfo->program_regbase_size = pci_resource_len(pci_dev_p, 5);\r\nreturn 0;\r\n}\r\nstatic int init_board_info(struct comedi_device *dev, struct pci_dev *pci_dev_p)\r\n{\r\nint result;\r\nCALL_PDEBUG("In init_board_info()\n");\r\nresult = pci_read_config_dword(pci_dev_p, 0x2C, &info->serial_no);\r\nif (result != PCIBIOS_SUCCESSFUL)\r\nreturn result;\r\nresult = pci_read_config_byte(pci_dev_p, 0x08, &info->hw_revision);\r\nif (result != PCIBIOS_SUCCESSFUL)\r\nreturn result;\r\ninfo->vendor_id = pci_dev_p->vendor;\r\ninfo->device_id = pci_dev_p->device;\r\ninfo->irq = pci_dev_p->irq;\r\nreturn 0;\r\n}\r\nstatic int init_ao_context(struct comedi_device *dev)\r\n{\r\nint i;\r\nCALL_PDEBUG("In init_ao_context()\n");\r\nfor (i = 0; i < thisboard->ao.count; i++) {\r\ninfo->ao_context[i].irq = info->irq;\r\nswitch (i) {\r\ncase 0:\r\ninfo->ao_context[i].ctrl_reg =\r\ninfo->me4000_regbase + ME4000_AO_00_CTRL_REG;\r\ninfo->ao_context[i].status_reg =\r\ninfo->me4000_regbase + ME4000_AO_00_STATUS_REG;\r\ninfo->ao_context[i].fifo_reg =\r\ninfo->me4000_regbase + ME4000_AO_00_FIFO_REG;\r\ninfo->ao_context[i].single_reg =\r\ninfo->me4000_regbase + ME4000_AO_00_SINGLE_REG;\r\ninfo->ao_context[i].timer_reg =\r\ninfo->me4000_regbase + ME4000_AO_00_TIMER_REG;\r\ninfo->ao_context[i].irq_status_reg =\r\ninfo->me4000_regbase + ME4000_IRQ_STATUS_REG;\r\ninfo->ao_context[i].preload_reg =\r\ninfo->me4000_regbase + ME4000_AO_LOADSETREG_XX;\r\nbreak;\r\ncase 1:\r\ninfo->ao_context[i].ctrl_reg =\r\ninfo->me4000_regbase + ME4000_AO_01_CTRL_REG;\r\ninfo->ao_context[i].status_reg =\r\ninfo->me4000_regbase + ME4000_AO_01_STATUS_REG;\r\ninfo->ao_context[i].fifo_reg =\r\ninfo->me4000_regbase + ME4000_AO_01_FIFO_REG;\r\ninfo->ao_context[i].single_reg =\r\ninfo->me4000_regbase + ME4000_AO_01_SINGLE_REG;\r\ninfo->ao_context[i].timer_reg =\r\ninfo->me4000_regbase + ME4000_AO_01_TIMER_REG;\r\ninfo->ao_context[i].irq_status_reg =\r\ninfo->me4000_regbase + ME4000_IRQ_STATUS_REG;\r\ninfo->ao_context[i].preload_reg =\r\ninfo->me4000_regbase + ME4000_AO_LOADSETREG_XX;\r\nbreak;\r\ncase 2:\r\ninfo->ao_context[i].ctrl_reg =\r\ninfo->me4000_regbase + ME4000_AO_02_CTRL_REG;\r\ninfo->ao_context[i].status_reg =\r\ninfo->me4000_regbase + ME4000_AO_02_STATUS_REG;\r\ninfo->ao_context[i].fifo_reg =\r\ninfo->me4000_regbase + ME4000_AO_02_FIFO_REG;\r\ninfo->ao_context[i].single_reg =\r\ninfo->me4000_regbase + ME4000_AO_02_SINGLE_REG;\r\ninfo->ao_context[i].timer_reg =\r\ninfo->me4000_regbase + ME4000_AO_02_TIMER_REG;\r\ninfo->ao_context[i].irq_status_reg =\r\ninfo->me4000_regbase + ME4000_IRQ_STATUS_REG;\r\ninfo->ao_context[i].preload_reg =\r\ninfo->me4000_regbase + ME4000_AO_LOADSETREG_XX;\r\nbreak;\r\ncase 3:\r\ninfo->ao_context[i].ctrl_reg =\r\ninfo->me4000_regbase + ME4000_AO_03_CTRL_REG;\r\ninfo->ao_context[i].status_reg =\r\ninfo->me4000_regbase + ME4000_AO_03_STATUS_REG;\r\ninfo->ao_context[i].fifo_reg =\r\ninfo->me4000_regbase + ME4000_AO_03_FIFO_REG;\r\ninfo->ao_context[i].single_reg =\r\ninfo->me4000_regbase + ME4000_AO_03_SINGLE_REG;\r\ninfo->ao_context[i].timer_reg =\r\ninfo->me4000_regbase + ME4000_AO_03_TIMER_REG;\r\ninfo->ao_context[i].irq_status_reg =\r\ninfo->me4000_regbase + ME4000_IRQ_STATUS_REG;\r\ninfo->ao_context[i].preload_reg =\r\ninfo->me4000_regbase + ME4000_AO_LOADSETREG_XX;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int init_ai_context(struct comedi_device *dev)\r\n{\r\nCALL_PDEBUG("In init_ai_context()\n");\r\ninfo->ai_context.irq = info->irq;\r\ninfo->ai_context.ctrl_reg = info->me4000_regbase + ME4000_AI_CTRL_REG;\r\ninfo->ai_context.status_reg =\r\ninfo->me4000_regbase + ME4000_AI_STATUS_REG;\r\ninfo->ai_context.channel_list_reg =\r\ninfo->me4000_regbase + ME4000_AI_CHANNEL_LIST_REG;\r\ninfo->ai_context.data_reg = info->me4000_regbase + ME4000_AI_DATA_REG;\r\ninfo->ai_context.chan_timer_reg =\r\ninfo->me4000_regbase + ME4000_AI_CHAN_TIMER_REG;\r\ninfo->ai_context.chan_pre_timer_reg =\r\ninfo->me4000_regbase + ME4000_AI_CHAN_PRE_TIMER_REG;\r\ninfo->ai_context.scan_timer_low_reg =\r\ninfo->me4000_regbase + ME4000_AI_SCAN_TIMER_LOW_REG;\r\ninfo->ai_context.scan_timer_high_reg =\r\ninfo->me4000_regbase + ME4000_AI_SCAN_TIMER_HIGH_REG;\r\ninfo->ai_context.scan_pre_timer_low_reg =\r\ninfo->me4000_regbase + ME4000_AI_SCAN_PRE_TIMER_LOW_REG;\r\ninfo->ai_context.scan_pre_timer_high_reg =\r\ninfo->me4000_regbase + ME4000_AI_SCAN_PRE_TIMER_HIGH_REG;\r\ninfo->ai_context.start_reg = info->me4000_regbase + ME4000_AI_START_REG;\r\ninfo->ai_context.irq_status_reg =\r\ninfo->me4000_regbase + ME4000_IRQ_STATUS_REG;\r\ninfo->ai_context.sample_counter_reg =\r\ninfo->me4000_regbase + ME4000_AI_SAMPLE_COUNTER_REG;\r\nreturn 0;\r\n}\r\nstatic int init_dio_context(struct comedi_device *dev)\r\n{\r\nCALL_PDEBUG("In init_dio_context()\n");\r\ninfo->dio_context.dir_reg = info->me4000_regbase + ME4000_DIO_DIR_REG;\r\ninfo->dio_context.ctrl_reg = info->me4000_regbase + ME4000_DIO_CTRL_REG;\r\ninfo->dio_context.port_0_reg =\r\ninfo->me4000_regbase + ME4000_DIO_PORT_0_REG;\r\ninfo->dio_context.port_1_reg =\r\ninfo->me4000_regbase + ME4000_DIO_PORT_1_REG;\r\ninfo->dio_context.port_2_reg =\r\ninfo->me4000_regbase + ME4000_DIO_PORT_2_REG;\r\ninfo->dio_context.port_3_reg =\r\ninfo->me4000_regbase + ME4000_DIO_PORT_3_REG;\r\nreturn 0;\r\n}\r\nstatic int init_cnt_context(struct comedi_device *dev)\r\n{\r\nCALL_PDEBUG("In init_cnt_context()\n");\r\ninfo->cnt_context.ctrl_reg = info->timer_regbase + ME4000_CNT_CTRL_REG;\r\ninfo->cnt_context.counter_0_reg =\r\ninfo->timer_regbase + ME4000_CNT_COUNTER_0_REG;\r\ninfo->cnt_context.counter_1_reg =\r\ninfo->timer_regbase + ME4000_CNT_COUNTER_1_REG;\r\ninfo->cnt_context.counter_2_reg =\r\ninfo->timer_regbase + ME4000_CNT_COUNTER_2_REG;\r\nreturn 0;\r\n}\r\nstatic int xilinx_download(struct comedi_device *dev)\r\n{\r\nu32 value = 0;\r\nwait_queue_head_t queue;\r\nint idx = 0;\r\nint size = 0;\r\nCALL_PDEBUG("In xilinx_download()\n");\r\ninit_waitqueue_head(&queue);\r\noutl(0x10, info->plx_regbase + PLX_INTCSR);\r\nvalue = inl(info->plx_regbase + PLX_ICR);\r\nvalue |= 0x100;\r\noutl(value, info->plx_regbase + PLX_ICR);\r\ninb(info->program_regbase + 0xC8);\r\nudelay(20);\r\nif (!(inl(info->plx_regbase + PLX_INTCSR) & 0x20)) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: xilinx_download(): "\r\n"Can't init Xilinx\n", dev->minor);\r\nreturn -EIO;\r\n}\r\nvalue = inl(info->plx_regbase + PLX_ICR);\r\nvalue &= ~0x100;\r\noutl(value, info->plx_regbase + PLX_ICR);\r\nif (FIRMWARE_NOT_AVAILABLE) {\r\ncomedi_error(dev, "xilinx firmware unavailable "\r\n"due to licensing, aborting");\r\nreturn -EIO;\r\n} else {\r\nsize = (xilinx_firm[0] << 24) + (xilinx_firm[1] << 16) +\r\n(xilinx_firm[2] << 8) + xilinx_firm[3];\r\nudelay(10);\r\nfor (idx = 0; idx < size; idx++) {\r\noutb(xilinx_firm[16 + idx], info->program_regbase);\r\nudelay(10);\r\nif (inl(info->plx_regbase + PLX_ICR) & 0x20) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: xilinx_download(): "\r\n"Xilinx is still busy (idx = %d)\n",\r\ndev->minor, idx);\r\nreturn -EIO;\r\n}\r\n}\r\n}\r\nif (inl(info->plx_regbase + PLX_ICR) & 0x4) {\r\n} else {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: xilinx_download(): "\r\n"DONE flag is not set\n", dev->minor);\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: xilinx_download(): "\r\n"Download not successful\n", dev->minor);\r\nreturn -EIO;\r\n}\r\nvalue = inl(info->plx_regbase + PLX_ICR);\r\nvalue |= 0x100;\r\noutl(value, info->plx_regbase + PLX_ICR);\r\nreturn 0;\r\n}\r\nstatic int reset_board(struct comedi_device *dev)\r\n{\r\nunsigned long icr;\r\nCALL_PDEBUG("In reset_board()\n");\r\nicr = me4000_inl(dev, info->plx_regbase + PLX_ICR);\r\nicr |= 0x40000000;\r\nme4000_outl(dev, icr, info->plx_regbase + PLX_ICR);\r\nicr &= ~0x40000000;\r\nme4000_outl(dev, icr, info->plx_regbase + PLX_ICR);\r\nme4000_outl(dev, 0x8000,\r\ninfo->me4000_regbase + ME4000_AO_00_SINGLE_REG);\r\nme4000_outl(dev, 0x8000,\r\ninfo->me4000_regbase + ME4000_AO_01_SINGLE_REG);\r\nme4000_outl(dev, 0x8000,\r\ninfo->me4000_regbase + ME4000_AO_02_SINGLE_REG);\r\nme4000_outl(dev, 0x8000,\r\ninfo->me4000_regbase + ME4000_AO_03_SINGLE_REG);\r\nme4000_outl(dev,\r\nME4000_AI_CTRL_BIT_IMMEDIATE_STOP | ME4000_AI_CTRL_BIT_STOP,\r\ninfo->me4000_regbase + ME4000_AI_CTRL_REG);\r\nme4000_outl(dev,\r\nME4000_AO_CTRL_BIT_IMMEDIATE_STOP | ME4000_AO_CTRL_BIT_STOP,\r\ninfo->me4000_regbase + ME4000_AO_00_CTRL_REG);\r\nme4000_outl(dev,\r\nME4000_AO_CTRL_BIT_IMMEDIATE_STOP | ME4000_AO_CTRL_BIT_STOP,\r\ninfo->me4000_regbase + ME4000_AO_01_CTRL_REG);\r\nme4000_outl(dev,\r\nME4000_AO_CTRL_BIT_IMMEDIATE_STOP | ME4000_AO_CTRL_BIT_STOP,\r\ninfo->me4000_regbase + ME4000_AO_02_CTRL_REG);\r\nme4000_outl(dev,\r\nME4000_AO_CTRL_BIT_IMMEDIATE_STOP | ME4000_AO_CTRL_BIT_STOP,\r\ninfo->me4000_regbase + ME4000_AO_03_CTRL_REG);\r\nme4000_outl(dev, 0x43, info->plx_regbase + PLX_INTCSR);\r\nme4000_outl(dev, ME4000_AO_DEMUX_ADJUST_VALUE,\r\ninfo->me4000_regbase + ME4000_AO_DEMUX_ADJUST_REG);\r\nif (!(me4000_inl(dev, info->me4000_regbase + ME4000_DIO_DIR_REG) & 0x1)) {\r\nme4000_outl(dev, 0x1,\r\ninfo->me4000_regbase + ME4000_DIO_CTRL_REG);\r\n}\r\nreturn 0;\r\n}\r\nstatic int me4000_detach(struct comedi_device *dev)\r\n{\r\nCALL_PDEBUG("In me4000_detach()\n");\r\nif (info) {\r\nif (info->pci_dev_p) {\r\nreset_board(dev);\r\nif (info->plx_regbase)\r\ncomedi_pci_disable(info->pci_dev_p);\r\npci_dev_put(info->pci_dev_p);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int me4000_ai_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *subdevice,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint chan = CR_CHAN(insn->chanspec);\r\nint rang = CR_RANGE(insn->chanspec);\r\nint aref = CR_AREF(insn->chanspec);\r\nunsigned long entry = 0;\r\nunsigned long tmp;\r\nlong lval;\r\nCALL_PDEBUG("In me4000_ai_insn_read()\n");\r\nif (insn->n == 0) {\r\nreturn 0;\r\n} else if (insn->n > 1) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_insn_read(): "\r\n"Invalid instruction length %d\n", dev->minor, insn->n);\r\nreturn -EINVAL;\r\n}\r\nswitch (rang) {\r\ncase 0:\r\nentry |= ME4000_AI_LIST_RANGE_UNIPOLAR_2_5;\r\nbreak;\r\ncase 1:\r\nentry |= ME4000_AI_LIST_RANGE_UNIPOLAR_10;\r\nbreak;\r\ncase 2:\r\nentry |= ME4000_AI_LIST_RANGE_BIPOLAR_2_5;\r\nbreak;\r\ncase 3:\r\nentry |= ME4000_AI_LIST_RANGE_BIPOLAR_10;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_insn_read(): "\r\n"Invalid range specified\n", dev->minor);\r\nreturn -EINVAL;\r\n}\r\nswitch (aref) {\r\ncase AREF_GROUND:\r\ncase AREF_COMMON:\r\nif (chan >= thisboard->ai.count) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_insn_read(): "\r\n"Analog input is not available\n", dev->minor);\r\nreturn -EINVAL;\r\n}\r\nentry |= ME4000_AI_LIST_INPUT_SINGLE_ENDED | chan;\r\nbreak;\r\ncase AREF_DIFF:\r\nif (rang == 0 || rang == 1) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_insn_read(): "\r\n"Range must be bipolar when aref = diff\n",\r\ndev->minor);\r\nreturn -EINVAL;\r\n}\r\nif (chan >= thisboard->ai.diff_count) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_insn_read(): "\r\n"Analog input is not available\n", dev->minor);\r\nreturn -EINVAL;\r\n}\r\nentry |= ME4000_AI_LIST_INPUT_DIFFERENTIAL | chan;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_insn_read(): "\r\n"Invalid aref specified\n", dev->minor);\r\nreturn -EINVAL;\r\n}\r\nentry |= ME4000_AI_LIST_LAST_ENTRY;\r\ntmp = me4000_inl(dev, info->ai_context.ctrl_reg);\r\ntmp &= ~(ME4000_AI_CTRL_BIT_CHANNEL_FIFO |\r\nME4000_AI_CTRL_BIT_DATA_FIFO |\r\nME4000_AI_CTRL_BIT_STOP | ME4000_AI_CTRL_BIT_IMMEDIATE_STOP);\r\nme4000_outl(dev, tmp, info->ai_context.ctrl_reg);\r\ntmp &= ~(ME4000_AI_CTRL_BIT_MODE_0 | ME4000_AI_CTRL_BIT_MODE_1 |\r\nME4000_AI_CTRL_BIT_MODE_2);\r\nme4000_outl(dev, tmp, info->ai_context.ctrl_reg);\r\ntmp |= ME4000_AI_CTRL_BIT_CHANNEL_FIFO | ME4000_AI_CTRL_BIT_DATA_FIFO;\r\nme4000_outl(dev, tmp, info->ai_context.ctrl_reg);\r\nme4000_outl(dev, entry, info->ai_context.channel_list_reg);\r\nme4000_outl(dev, ME4000_AI_MIN_TICKS, info->ai_context.chan_timer_reg);\r\nme4000_outl(dev, ME4000_AI_MIN_TICKS,\r\ninfo->ai_context.chan_pre_timer_reg);\r\nme4000_inl(dev, info->ai_context.start_reg);\r\nudelay(10);\r\nif (!\r\n(me4000_inl(dev, info->ai_context.status_reg) &\r\nME4000_AI_STATUS_BIT_EF_DATA)) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_insn_read(): "\r\n"Value not available after wait\n", dev->minor);\r\nreturn -EIO;\r\n}\r\nlval = me4000_inl(dev, info->ai_context.data_reg) & 0xFFFF;\r\ndata[0] = lval ^ 0x8000;\r\nreturn 1;\r\n}\r\nstatic int me4000_ai_cancel(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nunsigned long tmp;\r\nCALL_PDEBUG("In me4000_ai_cancel()\n");\r\ntmp = me4000_inl(dev, info->ai_context.ctrl_reg);\r\ntmp &= ~(ME4000_AI_CTRL_BIT_STOP | ME4000_AI_CTRL_BIT_IMMEDIATE_STOP);\r\nme4000_outl(dev, tmp, info->ai_context.ctrl_reg);\r\nme4000_outl(dev, 0x0, info->ai_context.ctrl_reg);\r\nreturn 0;\r\n}\r\nstatic int ai_check_chanlist(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_cmd *cmd)\r\n{\r\nint aref;\r\nint i;\r\nCALL_PDEBUG("In ai_check_chanlist()\n");\r\nif (!cmd->chanlist_len) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: ai_check_chanlist(): "\r\n"No channel list available\n", dev->minor);\r\nreturn -EINVAL;\r\n}\r\nif (cmd->chanlist_len > ME4000_AI_CHANNEL_LIST_COUNT) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: ai_check_chanlist(): "\r\n"Channel list is to large\n", dev->minor);\r\nreturn -EINVAL;\r\n}\r\nif (!cmd->chanlist) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: ai_check_chanlist(): "\r\n"NULL pointer to channel list\n", dev->minor);\r\nreturn -EFAULT;\r\n}\r\naref = CR_AREF(cmd->chanlist[0]);\r\nfor (i = 0; i < cmd->chanlist_len; i++) {\r\nif (CR_AREF(cmd->chanlist[i]) != aref) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: ai_check_chanlist(): "\r\n"Mode is not equal for all entries\n",\r\ndev->minor);\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (aref == SDF_DIFF) {\r\nfor (i = 0; i < cmd->chanlist_len; i++) {\r\nif (CR_CHAN(cmd->chanlist[i]) >=\r\nthisboard->ai.diff_count) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: ai_check_chanlist():"\r\n" Channel number to high\n", dev->minor);\r\nreturn -EINVAL;\r\n}\r\n}\r\n} else {\r\nfor (i = 0; i < cmd->chanlist_len; i++) {\r\nif (CR_CHAN(cmd->chanlist[i]) >= thisboard->ai.count) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: ai_check_chanlist(): "\r\n"Channel number to high\n", dev->minor);\r\nreturn -EINVAL;\r\n}\r\n}\r\n}\r\nif (aref == SDF_DIFF) {\r\nfor (i = 0; i < cmd->chanlist_len; i++) {\r\nif (CR_RANGE(cmd->chanlist[i]) != 1 &&\r\nCR_RANGE(cmd->chanlist[i]) != 2) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: ai_check_chanlist(): "\r\n"Bipolar is not selected in "\r\n"differential mode\n",\r\ndev->minor);\r\nreturn -EINVAL;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int ai_round_cmd_args(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_cmd *cmd,\r\nunsigned int *init_ticks,\r\nunsigned int *scan_ticks, unsigned int *chan_ticks)\r\n{\r\nint rest;\r\nCALL_PDEBUG("In ai_round_cmd_args()\n");\r\n*init_ticks = 0;\r\n*scan_ticks = 0;\r\n*chan_ticks = 0;\r\nPDEBUG("ai_round_cmd_arg(): start_arg = %d\n", cmd->start_arg);\r\nPDEBUG("ai_round_cmd_arg(): scan_begin_arg = %d\n",\r\ncmd->scan_begin_arg);\r\nPDEBUG("ai_round_cmd_arg(): convert_arg = %d\n", cmd->convert_arg);\r\nif (cmd->start_arg) {\r\n*init_ticks = (cmd->start_arg * 33) / 1000;\r\nrest = (cmd->start_arg * 33) % 1000;\r\nif (cmd->flags & TRIG_ROUND_NEAREST) {\r\nif (rest > 33)\r\n(*init_ticks)++;\r\n} else if (cmd->flags & TRIG_ROUND_UP) {\r\nif (rest)\r\n(*init_ticks)++;\r\n}\r\n}\r\nif (cmd->scan_begin_arg) {\r\n*scan_ticks = (cmd->scan_begin_arg * 33) / 1000;\r\nrest = (cmd->scan_begin_arg * 33) % 1000;\r\nif (cmd->flags & TRIG_ROUND_NEAREST) {\r\nif (rest > 33)\r\n(*scan_ticks)++;\r\n} else if (cmd->flags & TRIG_ROUND_UP) {\r\nif (rest)\r\n(*scan_ticks)++;\r\n}\r\n}\r\nif (cmd->convert_arg) {\r\n*chan_ticks = (cmd->convert_arg * 33) / 1000;\r\nrest = (cmd->convert_arg * 33) % 1000;\r\nif (cmd->flags & TRIG_ROUND_NEAREST) {\r\nif (rest > 33)\r\n(*chan_ticks)++;\r\n} else if (cmd->flags & TRIG_ROUND_UP) {\r\nif (rest)\r\n(*chan_ticks)++;\r\n}\r\n}\r\nPDEBUG("ai_round_cmd_args(): init_ticks = %d\n", *init_ticks);\r\nPDEBUG("ai_round_cmd_args(): scan_ticks = %d\n", *scan_ticks);\r\nPDEBUG("ai_round_cmd_args(): chan_ticks = %d\n", *chan_ticks);\r\nreturn 0;\r\n}\r\nstatic void ai_write_timer(struct comedi_device *dev,\r\nunsigned int init_ticks,\r\nunsigned int scan_ticks, unsigned int chan_ticks)\r\n{\r\nCALL_PDEBUG("In ai_write_timer()\n");\r\nme4000_outl(dev, init_ticks - 1,\r\ninfo->ai_context.scan_pre_timer_low_reg);\r\nme4000_outl(dev, 0x0, info->ai_context.scan_pre_timer_high_reg);\r\nif (scan_ticks) {\r\nme4000_outl(dev, scan_ticks - 1,\r\ninfo->ai_context.scan_timer_low_reg);\r\nme4000_outl(dev, 0x0, info->ai_context.scan_timer_high_reg);\r\n}\r\nme4000_outl(dev, chan_ticks - 1, info->ai_context.chan_pre_timer_reg);\r\nme4000_outl(dev, chan_ticks - 1, info->ai_context.chan_timer_reg);\r\n}\r\nstatic int ai_prepare(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_cmd *cmd,\r\nunsigned int init_ticks,\r\nunsigned int scan_ticks, unsigned int chan_ticks)\r\n{\r\nunsigned long tmp = 0;\r\nCALL_PDEBUG("In ai_prepare()\n");\r\nai_write_timer(dev, init_ticks, scan_ticks, chan_ticks);\r\nme4000_outl(dev, tmp, info->ai_context.ctrl_reg);\r\nif ((cmd->start_src == TRIG_EXT &&\r\ncmd->scan_begin_src == TRIG_TIMER &&\r\ncmd->convert_src == TRIG_TIMER) ||\r\n(cmd->start_src == TRIG_EXT &&\r\ncmd->scan_begin_src == TRIG_FOLLOW &&\r\ncmd->convert_src == TRIG_TIMER)) {\r\ntmp = ME4000_AI_CTRL_BIT_MODE_1 |\r\nME4000_AI_CTRL_BIT_CHANNEL_FIFO |\r\nME4000_AI_CTRL_BIT_DATA_FIFO;\r\n} else if (cmd->start_src == TRIG_EXT &&\r\ncmd->scan_begin_src == TRIG_EXT &&\r\ncmd->convert_src == TRIG_TIMER) {\r\ntmp = ME4000_AI_CTRL_BIT_MODE_2 |\r\nME4000_AI_CTRL_BIT_CHANNEL_FIFO |\r\nME4000_AI_CTRL_BIT_DATA_FIFO;\r\n} else if (cmd->start_src == TRIG_EXT &&\r\ncmd->scan_begin_src == TRIG_EXT &&\r\ncmd->convert_src == TRIG_EXT) {\r\ntmp = ME4000_AI_CTRL_BIT_MODE_0 |\r\nME4000_AI_CTRL_BIT_MODE_1 |\r\nME4000_AI_CTRL_BIT_CHANNEL_FIFO |\r\nME4000_AI_CTRL_BIT_DATA_FIFO;\r\n} else {\r\ntmp = ME4000_AI_CTRL_BIT_MODE_0 |\r\nME4000_AI_CTRL_BIT_CHANNEL_FIFO |\r\nME4000_AI_CTRL_BIT_DATA_FIFO;\r\n}\r\nif (cmd->stop_src == TRIG_COUNT) {\r\nme4000_outl(dev, cmd->chanlist_len * cmd->stop_arg,\r\ninfo->ai_context.sample_counter_reg);\r\ntmp |= ME4000_AI_CTRL_BIT_HF_IRQ | ME4000_AI_CTRL_BIT_SC_IRQ;\r\n} else if (cmd->stop_src == TRIG_NONE &&\r\ncmd->scan_end_src == TRIG_COUNT) {\r\nme4000_outl(dev, cmd->scan_end_arg,\r\ninfo->ai_context.sample_counter_reg);\r\ntmp |= ME4000_AI_CTRL_BIT_HF_IRQ | ME4000_AI_CTRL_BIT_SC_IRQ;\r\n} else {\r\ntmp |= ME4000_AI_CTRL_BIT_HF_IRQ;\r\n}\r\nme4000_outl(dev, tmp, info->ai_context.ctrl_reg);\r\nai_write_chanlist(dev, s, cmd);\r\nreturn 0;\r\n}\r\nstatic int ai_write_chanlist(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_cmd *cmd)\r\n{\r\nunsigned int entry;\r\nunsigned int chan;\r\nunsigned int rang;\r\nunsigned int aref;\r\nint i;\r\nCALL_PDEBUG("In ai_write_chanlist()\n");\r\nfor (i = 0; i < cmd->chanlist_len; i++) {\r\nchan = CR_CHAN(cmd->chanlist[i]);\r\nrang = CR_RANGE(cmd->chanlist[i]);\r\naref = CR_AREF(cmd->chanlist[i]);\r\nentry = chan;\r\nif (rang == 0)\r\nentry |= ME4000_AI_LIST_RANGE_UNIPOLAR_2_5;\r\nelse if (rang == 1)\r\nentry |= ME4000_AI_LIST_RANGE_UNIPOLAR_10;\r\nelse if (rang == 2)\r\nentry |= ME4000_AI_LIST_RANGE_BIPOLAR_2_5;\r\nelse\r\nentry |= ME4000_AI_LIST_RANGE_BIPOLAR_10;\r\nif (aref == SDF_DIFF)\r\nentry |= ME4000_AI_LIST_INPUT_DIFFERENTIAL;\r\nelse\r\nentry |= ME4000_AI_LIST_INPUT_SINGLE_ENDED;\r\nme4000_outl(dev, entry, info->ai_context.channel_list_reg);\r\n}\r\nreturn 0;\r\n}\r\nstatic int me4000_ai_do_cmd(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nint err;\r\nunsigned int init_ticks = 0;\r\nunsigned int scan_ticks = 0;\r\nunsigned int chan_ticks = 0;\r\nstruct comedi_cmd *cmd = &s->async->cmd;\r\nCALL_PDEBUG("In me4000_ai_do_cmd()\n");\r\nerr = me4000_ai_cancel(dev, s);\r\nif (err)\r\nreturn err;\r\nerr = ai_round_cmd_args(dev,\r\ns, cmd, &init_ticks, &scan_ticks, &chan_ticks);\r\nif (err)\r\nreturn err;\r\nerr = ai_prepare(dev, s, cmd, init_ticks, scan_ticks, chan_ticks);\r\nif (err)\r\nreturn err;\r\nme4000_inl(dev, info->ai_context.start_reg);\r\nreturn 0;\r\n}\r\nstatic int me4000_ai_do_cmd_test(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_cmd *cmd)\r\n{\r\nunsigned int init_ticks;\r\nunsigned int chan_ticks;\r\nunsigned int scan_ticks;\r\nint err = 0;\r\nCALL_PDEBUG("In me4000_ai_do_cmd_test()\n");\r\nPDEBUG("me4000_ai_do_cmd_test(): subdev = %d\n", cmd->subdev);\r\nPDEBUG("me4000_ai_do_cmd_test(): flags = %08X\n", cmd->flags);\r\nPDEBUG("me4000_ai_do_cmd_test(): start_src = %08X\n",\r\ncmd->start_src);\r\nPDEBUG("me4000_ai_do_cmd_test(): start_arg = %d\n",\r\ncmd->start_arg);\r\nPDEBUG("me4000_ai_do_cmd_test(): scan_begin_src = %08X\n",\r\ncmd->scan_begin_src);\r\nPDEBUG("me4000_ai_do_cmd_test(): scan_begin_arg = %d\n",\r\ncmd->scan_begin_arg);\r\nPDEBUG("me4000_ai_do_cmd_test(): convert_src = %08X\n",\r\ncmd->convert_src);\r\nPDEBUG("me4000_ai_do_cmd_test(): convert_arg = %d\n",\r\ncmd->convert_arg);\r\nPDEBUG("me4000_ai_do_cmd_test(): scan_end_src = %08X\n",\r\ncmd->scan_end_src);\r\nPDEBUG("me4000_ai_do_cmd_test(): scan_end_arg = %d\n",\r\ncmd->scan_end_arg);\r\nPDEBUG("me4000_ai_do_cmd_test(): stop_src = %08X\n",\r\ncmd->stop_src);\r\nPDEBUG("me4000_ai_do_cmd_test(): stop_arg = %d\n", cmd->stop_arg);\r\nPDEBUG("me4000_ai_do_cmd_test(): chanlist = %d\n",\r\n(unsigned int)cmd->chanlist);\r\nPDEBUG("me4000_ai_do_cmd_test(): chanlist_len = %d\n",\r\ncmd->chanlist_len);\r\ncmd->flags &= TRIG_ROUND_NEAREST | TRIG_ROUND_UP | TRIG_ROUND_DOWN;\r\nai_round_cmd_args(dev, s, cmd, &init_ticks, &scan_ticks, &chan_ticks);\r\nswitch (cmd->start_src) {\r\ncase TRIG_NOW:\r\ncase TRIG_EXT:\r\nbreak;\r\ncase TRIG_ANY:\r\ncmd->start_src &= TRIG_NOW | TRIG_EXT;\r\nerr++;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid start source\n", dev->minor);\r\ncmd->start_src = TRIG_NOW;\r\nerr++;\r\n}\r\nswitch (cmd->scan_begin_src) {\r\ncase TRIG_FOLLOW:\r\ncase TRIG_TIMER:\r\ncase TRIG_EXT:\r\nbreak;\r\ncase TRIG_ANY:\r\ncmd->scan_begin_src &= TRIG_FOLLOW | TRIG_TIMER | TRIG_EXT;\r\nerr++;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid scan begin source\n", dev->minor);\r\ncmd->scan_begin_src = TRIG_FOLLOW;\r\nerr++;\r\n}\r\nswitch (cmd->convert_src) {\r\ncase TRIG_TIMER:\r\ncase TRIG_EXT:\r\nbreak;\r\ncase TRIG_ANY:\r\ncmd->convert_src &= TRIG_TIMER | TRIG_EXT;\r\nerr++;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid convert source\n", dev->minor);\r\ncmd->convert_src = TRIG_TIMER;\r\nerr++;\r\n}\r\nswitch (cmd->scan_end_src) {\r\ncase TRIG_NONE:\r\ncase TRIG_COUNT:\r\nbreak;\r\ncase TRIG_ANY:\r\ncmd->scan_end_src &= TRIG_NONE | TRIG_COUNT;\r\nerr++;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid scan end source\n", dev->minor);\r\ncmd->scan_end_src = TRIG_NONE;\r\nerr++;\r\n}\r\nswitch (cmd->stop_src) {\r\ncase TRIG_NONE:\r\ncase TRIG_COUNT:\r\nbreak;\r\ncase TRIG_ANY:\r\ncmd->stop_src &= TRIG_NONE | TRIG_COUNT;\r\nerr++;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid stop source\n", dev->minor);\r\ncmd->stop_src = TRIG_NONE;\r\nerr++;\r\n}\r\nif (err)\r\nreturn 1;\r\nif (cmd->start_src == TRIG_NOW &&\r\ncmd->scan_begin_src == TRIG_TIMER &&\r\ncmd->convert_src == TRIG_TIMER) {\r\n} else if (cmd->start_src == TRIG_NOW &&\r\ncmd->scan_begin_src == TRIG_FOLLOW &&\r\ncmd->convert_src == TRIG_TIMER) {\r\n} else if (cmd->start_src == TRIG_EXT &&\r\ncmd->scan_begin_src == TRIG_TIMER &&\r\ncmd->convert_src == TRIG_TIMER) {\r\n} else if (cmd->start_src == TRIG_EXT &&\r\ncmd->scan_begin_src == TRIG_FOLLOW &&\r\ncmd->convert_src == TRIG_TIMER) {\r\n} else if (cmd->start_src == TRIG_EXT &&\r\ncmd->scan_begin_src == TRIG_EXT &&\r\ncmd->convert_src == TRIG_TIMER) {\r\n} else if (cmd->start_src == TRIG_EXT &&\r\ncmd->scan_begin_src == TRIG_EXT &&\r\ncmd->convert_src == TRIG_EXT) {\r\n} else {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid start trigger combination\n", dev->minor);\r\ncmd->start_src = TRIG_NOW;\r\ncmd->scan_begin_src = TRIG_FOLLOW;\r\ncmd->convert_src = TRIG_TIMER;\r\nerr++;\r\n}\r\nif (cmd->stop_src == TRIG_NONE && cmd->scan_end_src == TRIG_NONE) {\r\n} else if (cmd->stop_src == TRIG_COUNT &&\r\ncmd->scan_end_src == TRIG_NONE) {\r\n} else if (cmd->stop_src == TRIG_NONE &&\r\ncmd->scan_end_src == TRIG_COUNT) {\r\n} else if (cmd->stop_src == TRIG_COUNT &&\r\ncmd->scan_end_src == TRIG_COUNT) {\r\n} else {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid stop trigger combination\n", dev->minor);\r\ncmd->stop_src = TRIG_NONE;\r\ncmd->scan_end_src = TRIG_NONE;\r\nerr++;\r\n}\r\nif (err)\r\nreturn 2;\r\nif (cmd->chanlist_len < 1) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"No channel list\n", dev->minor);\r\ncmd->chanlist_len = 1;\r\nerr++;\r\n}\r\nif (init_ticks < 66) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Start arg to low\n", dev->minor);\r\ncmd->start_arg = 2000;\r\nerr++;\r\n}\r\nif (scan_ticks && scan_ticks < 67) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Scan begin arg to low\n", dev->minor);\r\ncmd->scan_begin_arg = 2031;\r\nerr++;\r\n}\r\nif (chan_ticks < 66) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Convert arg to low\n", dev->minor);\r\ncmd->convert_arg = 2000;\r\nerr++;\r\n}\r\nif (err)\r\nreturn 3;\r\nif (cmd->start_src == TRIG_NOW &&\r\ncmd->scan_begin_src == TRIG_TIMER &&\r\ncmd->convert_src == TRIG_TIMER) {\r\nif (init_ticks < ME4000_AI_MIN_TICKS) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid start arg\n", dev->minor);\r\ncmd->start_arg = 2000;\r\nerr++;\r\n}\r\nif (chan_ticks < ME4000_AI_MIN_TICKS) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid convert arg\n", dev->minor);\r\ncmd->convert_arg = 2000;\r\nerr++;\r\n}\r\nif (scan_ticks <= cmd->chanlist_len * chan_ticks) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid scan end arg\n", dev->minor);\r\ncmd->scan_end_arg = 2000 * cmd->chanlist_len + 31;\r\nerr++;\r\n}\r\n} else if (cmd->start_src == TRIG_NOW &&\r\ncmd->scan_begin_src == TRIG_FOLLOW &&\r\ncmd->convert_src == TRIG_TIMER) {\r\nif (init_ticks < ME4000_AI_MIN_TICKS) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid start arg\n", dev->minor);\r\ncmd->start_arg = 2000;\r\nerr++;\r\n}\r\nif (chan_ticks < ME4000_AI_MIN_TICKS) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid convert arg\n", dev->minor);\r\ncmd->convert_arg = 2000;\r\nerr++;\r\n}\r\n} else if (cmd->start_src == TRIG_EXT &&\r\ncmd->scan_begin_src == TRIG_TIMER &&\r\ncmd->convert_src == TRIG_TIMER) {\r\nif (init_ticks < ME4000_AI_MIN_TICKS) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid start arg\n", dev->minor);\r\ncmd->start_arg = 2000;\r\nerr++;\r\n}\r\nif (chan_ticks < ME4000_AI_MIN_TICKS) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid convert arg\n", dev->minor);\r\ncmd->convert_arg = 2000;\r\nerr++;\r\n}\r\nif (scan_ticks <= cmd->chanlist_len * chan_ticks) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid scan end arg\n", dev->minor);\r\ncmd->scan_end_arg = 2000 * cmd->chanlist_len + 31;\r\nerr++;\r\n}\r\n} else if (cmd->start_src == TRIG_EXT &&\r\ncmd->scan_begin_src == TRIG_FOLLOW &&\r\ncmd->convert_src == TRIG_TIMER) {\r\nif (init_ticks < ME4000_AI_MIN_TICKS) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid start arg\n", dev->minor);\r\ncmd->start_arg = 2000;\r\nerr++;\r\n}\r\nif (chan_ticks < ME4000_AI_MIN_TICKS) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid convert arg\n", dev->minor);\r\ncmd->convert_arg = 2000;\r\nerr++;\r\n}\r\n} else if (cmd->start_src == TRIG_EXT &&\r\ncmd->scan_begin_src == TRIG_EXT &&\r\ncmd->convert_src == TRIG_TIMER) {\r\nif (init_ticks < ME4000_AI_MIN_TICKS) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid start arg\n", dev->minor);\r\ncmd->start_arg = 2000;\r\nerr++;\r\n}\r\nif (chan_ticks < ME4000_AI_MIN_TICKS) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid convert arg\n", dev->minor);\r\ncmd->convert_arg = 2000;\r\nerr++;\r\n}\r\n} else if (cmd->start_src == TRIG_EXT &&\r\ncmd->scan_begin_src == TRIG_EXT &&\r\ncmd->convert_src == TRIG_EXT) {\r\nif (init_ticks < ME4000_AI_MIN_TICKS) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid start arg\n", dev->minor);\r\ncmd->start_arg = 2000;\r\nerr++;\r\n}\r\n}\r\nif (cmd->stop_src == TRIG_COUNT) {\r\nif (cmd->stop_arg == 0) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid stop arg\n", dev->minor);\r\ncmd->stop_arg = 1;\r\nerr++;\r\n}\r\n}\r\nif (cmd->scan_end_src == TRIG_COUNT) {\r\nif (cmd->scan_end_arg == 0) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_do_cmd_test(): "\r\n"Invalid scan end arg\n", dev->minor);\r\ncmd->scan_end_arg = 1;\r\nerr++;\r\n}\r\n}\r\nif (err)\r\nreturn 4;\r\nif (ai_check_chanlist(dev, s, cmd))\r\nreturn 5;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t me4000_ai_isr(int irq, void *dev_id)\r\n{\r\nunsigned int tmp;\r\nstruct comedi_device *dev = dev_id;\r\nstruct comedi_subdevice *s = dev->subdevices;\r\nstruct me4000_ai_context *ai_context = &info->ai_context;\r\nint i;\r\nint c = 0;\r\nlong lval;\r\nISR_PDEBUG("me4000_ai_isr() is executed\n");\r\nif (!dev->attached) {\r\nISR_PDEBUG("me4000_ai_isr() premature interrupt\n");\r\nreturn IRQ_NONE;\r\n}\r\ns->async->events = 0;\r\nif (irq != ai_context->irq) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_isr(): "\r\n"Incorrect interrupt num: %d\n", dev->minor, irq);\r\nreturn IRQ_HANDLED;\r\n}\r\nif (me4000_inl(dev,\r\nai_context->irq_status_reg) &\r\nME4000_IRQ_STATUS_BIT_AI_HF) {\r\nISR_PDEBUG\r\n("me4000_ai_isr(): Fifo half full interrupt occurred\n");\r\ntmp = me4000_inl(dev, ai_context->ctrl_reg);\r\nif (!(tmp & ME4000_AI_STATUS_BIT_FF_DATA) &&\r\n!(tmp & ME4000_AI_STATUS_BIT_HF_DATA) &&\r\n(tmp & ME4000_AI_STATUS_BIT_EF_DATA)) {\r\nISR_PDEBUG("me4000_ai_isr(): Fifo full\n");\r\nc = ME4000_AI_FIFO_COUNT;\r\ntmp |= ME4000_AI_CTRL_BIT_IMMEDIATE_STOP;\r\ntmp &= ~(ME4000_AI_CTRL_BIT_HF_IRQ |\r\nME4000_AI_CTRL_BIT_SC_IRQ);\r\nme4000_outl(dev, tmp, ai_context->ctrl_reg);\r\ns->async->events |= COMEDI_CB_ERROR | COMEDI_CB_EOA;\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_isr(): "\r\n"FIFO overflow\n", dev->minor);\r\n} else if ((tmp & ME4000_AI_STATUS_BIT_FF_DATA)\r\n&& !(tmp & ME4000_AI_STATUS_BIT_HF_DATA)\r\n&& (tmp & ME4000_AI_STATUS_BIT_EF_DATA)) {\r\nISR_PDEBUG("me4000_ai_isr(): Fifo half full\n");\r\ns->async->events |= COMEDI_CB_BLOCK;\r\nc = ME4000_AI_FIFO_COUNT / 2;\r\n} else {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_isr(): "\r\n"Can't determine state of fifo\n", dev->minor);\r\nc = 0;\r\ntmp |= ME4000_AI_CTRL_BIT_IMMEDIATE_STOP;\r\ntmp &= ~(ME4000_AI_CTRL_BIT_HF_IRQ |\r\nME4000_AI_CTRL_BIT_SC_IRQ);\r\nme4000_outl(dev, tmp, ai_context->ctrl_reg);\r\ns->async->events |= COMEDI_CB_ERROR | COMEDI_CB_EOA;\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_isr(): "\r\n"Undefined FIFO state\n", dev->minor);\r\n}\r\nISR_PDEBUG("me4000_ai_isr(): Try to read %d values\n", c);\r\nfor (i = 0; i < c; i++) {\r\nlval = inl(ai_context->data_reg) & 0xFFFF;\r\nlval ^= 0x8000;\r\nif (!comedi_buf_put(s->async, lval)) {\r\ntmp |= ME4000_AI_CTRL_BIT_IMMEDIATE_STOP;\r\ntmp &= ~(ME4000_AI_CTRL_BIT_HF_IRQ |\r\nME4000_AI_CTRL_BIT_SC_IRQ);\r\nme4000_outl(dev, tmp, ai_context->ctrl_reg);\r\ns->async->events |= COMEDI_CB_OVERFLOW;\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_isr(): "\r\n"Buffer overflow\n", dev->minor);\r\nbreak;\r\n}\r\n}\r\nISR_PDEBUG("me4000_ai_isr(): Reset fifo half full interrupt\n");\r\ntmp |= ME4000_AI_CTRL_BIT_HF_IRQ_RESET;\r\nme4000_outl(dev, tmp, ai_context->ctrl_reg);\r\ntmp &= ~ME4000_AI_CTRL_BIT_HF_IRQ_RESET;\r\nme4000_outl(dev, tmp, ai_context->ctrl_reg);\r\n}\r\nif (me4000_inl(dev,\r\nai_context->irq_status_reg) & ME4000_IRQ_STATUS_BIT_SC) {\r\nISR_PDEBUG\r\n("me4000_ai_isr(): Sample counter interrupt occurred\n");\r\ns->async->events |= COMEDI_CB_BLOCK | COMEDI_CB_EOA;\r\ntmp = me4000_inl(dev, ai_context->ctrl_reg);\r\ntmp |= ME4000_AI_CTRL_BIT_IMMEDIATE_STOP;\r\ntmp &= ~(ME4000_AI_CTRL_BIT_HF_IRQ | ME4000_AI_CTRL_BIT_SC_IRQ);\r\nme4000_outl(dev, tmp, ai_context->ctrl_reg);\r\nwhile (inl(ai_context->ctrl_reg) & ME4000_AI_STATUS_BIT_EF_DATA) {\r\nlval = inl(ai_context->data_reg) & 0xFFFF;\r\nlval ^= 0x8000;\r\nif (!comedi_buf_put(s->async, lval)) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ai_isr(): "\r\n"Buffer overflow\n", dev->minor);\r\ns->async->events |= COMEDI_CB_OVERFLOW;\r\nbreak;\r\n}\r\n}\r\nISR_PDEBUG\r\n("me4000_ai_isr(): Reset interrupt from sample counter\n");\r\ntmp |= ME4000_AI_CTRL_BIT_SC_IRQ_RESET;\r\nme4000_outl(dev, tmp, ai_context->ctrl_reg);\r\ntmp &= ~ME4000_AI_CTRL_BIT_SC_IRQ_RESET;\r\nme4000_outl(dev, tmp, ai_context->ctrl_reg);\r\n}\r\nISR_PDEBUG("me4000_ai_isr(): Events = 0x%X\n", s->async->events);\r\nif (s->async->events)\r\ncomedi_event(dev, s);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int me4000_ao_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint chan = CR_CHAN(insn->chanspec);\r\nint rang = CR_RANGE(insn->chanspec);\r\nint aref = CR_AREF(insn->chanspec);\r\nunsigned long tmp;\r\nCALL_PDEBUG("In me4000_ao_insn_write()\n");\r\nif (insn->n == 0) {\r\nreturn 0;\r\n} else if (insn->n > 1) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ao_insn_write(): "\r\n"Invalid instruction length %d\n", dev->minor, insn->n);\r\nreturn -EINVAL;\r\n}\r\nif (chan >= thisboard->ao.count) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ao_insn_write(): "\r\n"Invalid channel %d\n", dev->minor, insn->n);\r\nreturn -EINVAL;\r\n}\r\nif (rang != 0) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ao_insn_write(): "\r\n"Invalid range %d\n", dev->minor, insn->n);\r\nreturn -EINVAL;\r\n}\r\nif (aref != AREF_GROUND && aref != AREF_COMMON) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_ao_insn_write(): "\r\n"Invalid aref %d\n", dev->minor, insn->n);\r\nreturn -EINVAL;\r\n}\r\ntmp = me4000_inl(dev, info->ao_context[chan].ctrl_reg);\r\ntmp |= ME4000_AO_CTRL_BIT_IMMEDIATE_STOP;\r\nme4000_outl(dev, tmp, info->ao_context[chan].ctrl_reg);\r\nme4000_outl(dev, 0x0, info->ao_context[chan].ctrl_reg);\r\nme4000_outl(dev, data[0], info->ao_context[chan].single_reg);\r\ninfo->ao_context[chan].mirror = data[0];\r\nreturn 1;\r\n}\r\nstatic int me4000_ao_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint chan = CR_CHAN(insn->chanspec);\r\nif (insn->n == 0) {\r\nreturn 0;\r\n} else if (insn->n > 1) {\r\nprintk\r\n("comedi%d: me4000: me4000_ao_insn_read(): "\r\n"Invalid instruction length\n", dev->minor);\r\nreturn -EINVAL;\r\n}\r\ndata[0] = info->ao_context[chan].mirror;\r\nreturn 1;\r\n}\r\nstatic int me4000_dio_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nCALL_PDEBUG("In me4000_dio_insn_bits()\n");\r\nif (insn->n == 0)\r\nreturn 0;\r\nif (insn->n != 2) {\r\nprintk\r\n("comedi%d: me4000: me4000_dio_insn_bits(): "\r\n"Invalid instruction length\n", dev->minor);\r\nreturn -EINVAL;\r\n}\r\nif (data[0]) {\r\nif ((s->io_bits & data[0]) != data[0])\r\nreturn -EIO;\r\ns->state &= ~data[0];\r\ns->state |= data[0] & data[1];\r\nme4000_outl(dev, (s->state >> 0) & 0xFF,\r\ninfo->dio_context.port_0_reg);\r\nme4000_outl(dev, (s->state >> 8) & 0xFF,\r\ninfo->dio_context.port_1_reg);\r\nme4000_outl(dev, (s->state >> 16) & 0xFF,\r\ninfo->dio_context.port_2_reg);\r\nme4000_outl(dev, (s->state >> 24) & 0xFF,\r\ninfo->dio_context.port_3_reg);\r\n}\r\ndata[1] =\r\n((me4000_inl(dev, info->dio_context.port_0_reg) & 0xFF) << 0) |\r\n((me4000_inl(dev, info->dio_context.port_1_reg) & 0xFF) << 8) |\r\n((me4000_inl(dev, info->dio_context.port_2_reg) & 0xFF) << 16) |\r\n((me4000_inl(dev, info->dio_context.port_3_reg) & 0xFF) << 24);\r\nreturn 2;\r\n}\r\nstatic int me4000_dio_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned long tmp;\r\nint chan = CR_CHAN(insn->chanspec);\r\nCALL_PDEBUG("In me4000_dio_insn_config()\n");\r\nif (data[0] == INSN_CONFIG_DIO_QUERY) {\r\ndata[1] =\r\n(s->io_bits & (1 << chan)) ? COMEDI_OUTPUT : COMEDI_INPUT;\r\nreturn insn->n;\r\n}\r\ntmp = me4000_inl(dev, info->dio_context.ctrl_reg);\r\nif (data[0] == COMEDI_OUTPUT) {\r\nif (chan < 8) {\r\ns->io_bits |= 0xFF;\r\ntmp &= ~(ME4000_DIO_CTRL_BIT_MODE_0 |\r\nME4000_DIO_CTRL_BIT_MODE_1);\r\ntmp |= ME4000_DIO_CTRL_BIT_MODE_0;\r\n} else if (chan < 16) {\r\nif (!me4000_inl(dev, info->dio_context.dir_reg))\r\nreturn -ENODEV;\r\ns->io_bits |= 0xFF00;\r\ntmp &= ~(ME4000_DIO_CTRL_BIT_MODE_2 |\r\nME4000_DIO_CTRL_BIT_MODE_3);\r\ntmp |= ME4000_DIO_CTRL_BIT_MODE_2;\r\n} else if (chan < 24) {\r\ns->io_bits |= 0xFF0000;\r\ntmp &= ~(ME4000_DIO_CTRL_BIT_MODE_4 |\r\nME4000_DIO_CTRL_BIT_MODE_5);\r\ntmp |= ME4000_DIO_CTRL_BIT_MODE_4;\r\n} else if (chan < 32) {\r\ns->io_bits |= 0xFF000000;\r\ntmp &= ~(ME4000_DIO_CTRL_BIT_MODE_6 |\r\nME4000_DIO_CTRL_BIT_MODE_7);\r\ntmp |= ME4000_DIO_CTRL_BIT_MODE_6;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n} else {\r\nif (chan < 8) {\r\nif (!me4000_inl(dev, info->dio_context.dir_reg))\r\nreturn -ENODEV;\r\ns->io_bits &= ~0xFF;\r\ntmp &= ~(ME4000_DIO_CTRL_BIT_MODE_0 |\r\nME4000_DIO_CTRL_BIT_MODE_1);\r\n} else if (chan < 16) {\r\ns->io_bits &= ~0xFF00;\r\ntmp &= ~(ME4000_DIO_CTRL_BIT_MODE_2 |\r\nME4000_DIO_CTRL_BIT_MODE_3);\r\n} else if (chan < 24) {\r\ns->io_bits &= ~0xFF0000;\r\ntmp &= ~(ME4000_DIO_CTRL_BIT_MODE_4 |\r\nME4000_DIO_CTRL_BIT_MODE_5);\r\n} else if (chan < 32) {\r\ns->io_bits &= ~0xFF000000;\r\ntmp &= ~(ME4000_DIO_CTRL_BIT_MODE_6 |\r\nME4000_DIO_CTRL_BIT_MODE_7);\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n}\r\nme4000_outl(dev, tmp, info->dio_context.ctrl_reg);\r\nreturn 1;\r\n}\r\nstatic int cnt_reset(struct comedi_device *dev, unsigned int channel)\r\n{\r\nCALL_PDEBUG("In cnt_reset()\n");\r\nswitch (channel) {\r\ncase 0:\r\nme4000_outb(dev, 0x30, info->cnt_context.ctrl_reg);\r\nme4000_outb(dev, 0x00, info->cnt_context.counter_0_reg);\r\nme4000_outb(dev, 0x00, info->cnt_context.counter_0_reg);\r\nbreak;\r\ncase 1:\r\nme4000_outb(dev, 0x70, info->cnt_context.ctrl_reg);\r\nme4000_outb(dev, 0x00, info->cnt_context.counter_1_reg);\r\nme4000_outb(dev, 0x00, info->cnt_context.counter_1_reg);\r\nbreak;\r\ncase 2:\r\nme4000_outb(dev, 0xB0, info->cnt_context.ctrl_reg);\r\nme4000_outb(dev, 0x00, info->cnt_context.counter_2_reg);\r\nme4000_outb(dev, 0x00, info->cnt_context.counter_2_reg);\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: cnt_reset(): Invalid channel\n",\r\ndev->minor);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cnt_config(struct comedi_device *dev, unsigned int channel,\r\nunsigned int mode)\r\n{\r\nint tmp = 0;\r\nCALL_PDEBUG("In cnt_config()\n");\r\nswitch (channel) {\r\ncase 0:\r\ntmp |= ME4000_CNT_COUNTER_0;\r\nbreak;\r\ncase 1:\r\ntmp |= ME4000_CNT_COUNTER_1;\r\nbreak;\r\ncase 2:\r\ntmp |= ME4000_CNT_COUNTER_2;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: cnt_config(): Invalid channel\n",\r\ndev->minor);\r\nreturn -EINVAL;\r\n}\r\nswitch (mode) {\r\ncase 0:\r\ntmp |= ME4000_CNT_MODE_0;\r\nbreak;\r\ncase 1:\r\ntmp |= ME4000_CNT_MODE_1;\r\nbreak;\r\ncase 2:\r\ntmp |= ME4000_CNT_MODE_2;\r\nbreak;\r\ncase 3:\r\ntmp |= ME4000_CNT_MODE_3;\r\nbreak;\r\ncase 4:\r\ntmp |= ME4000_CNT_MODE_4;\r\nbreak;\r\ncase 5:\r\ntmp |= ME4000_CNT_MODE_5;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: cnt_config(): Invalid counter mode\n",\r\ndev->minor);\r\nreturn -EINVAL;\r\n}\r\ntmp |= 0x30;\r\nme4000_outb(dev, tmp, info->cnt_context.ctrl_reg);\r\nreturn 0;\r\n}\r\nstatic int me4000_cnt_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint err;\r\nCALL_PDEBUG("In me4000_cnt_insn_config()\n");\r\nswitch (data[0]) {\r\ncase GPCT_RESET:\r\nif (insn->n != 1) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_cnt_insn_config(): "\r\n"Invalid instruction length%d\n",\r\ndev->minor, insn->n);\r\nreturn -EINVAL;\r\n}\r\nerr = cnt_reset(dev, insn->chanspec);\r\nif (err)\r\nreturn err;\r\nbreak;\r\ncase GPCT_SET_OPERATION:\r\nif (insn->n != 2) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_cnt_insn_config(): "\r\n"Invalid instruction length%d\n",\r\ndev->minor, insn->n);\r\nreturn -EINVAL;\r\n}\r\nerr = cnt_config(dev, insn->chanspec, data[1]);\r\nif (err)\r\nreturn err;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_cnt_insn_config(): "\r\n"Invalid instruction\n", dev->minor);\r\nreturn -EINVAL;\r\n}\r\nreturn 2;\r\n}\r\nstatic int me4000_cnt_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned short tmp;\r\nCALL_PDEBUG("In me4000_cnt_insn_read()\n");\r\nif (insn->n == 0)\r\nreturn 0;\r\nif (insn->n > 1) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_cnt_insn_read(): "\r\n"Invalid instruction length %d\n",\r\ndev->minor, insn->n);\r\nreturn -EINVAL;\r\n}\r\nswitch (insn->chanspec) {\r\ncase 0:\r\ntmp = me4000_inb(dev, info->cnt_context.counter_0_reg);\r\ndata[0] = tmp;\r\ntmp = me4000_inb(dev, info->cnt_context.counter_0_reg);\r\ndata[0] |= tmp << 8;\r\nbreak;\r\ncase 1:\r\ntmp = me4000_inb(dev, info->cnt_context.counter_1_reg);\r\ndata[0] = tmp;\r\ntmp = me4000_inb(dev, info->cnt_context.counter_1_reg);\r\ndata[0] |= tmp << 8;\r\nbreak;\r\ncase 2:\r\ntmp = me4000_inb(dev, info->cnt_context.counter_2_reg);\r\ndata[0] = tmp;\r\ntmp = me4000_inb(dev, info->cnt_context.counter_2_reg);\r\ndata[0] |= tmp << 8;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_cnt_insn_read(): "\r\n"Invalid channel %d\n",\r\ndev->minor, insn->chanspec);\r\nreturn -EINVAL;\r\n}\r\nreturn 1;\r\n}\r\nstatic int me4000_cnt_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned short tmp;\r\nCALL_PDEBUG("In me4000_cnt_insn_write()\n");\r\nif (insn->n == 0) {\r\nreturn 0;\r\n} else if (insn->n > 1) {\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_cnt_insn_write(): "\r\n"Invalid instruction length %d\n",\r\ndev->minor, insn->n);\r\nreturn -EINVAL;\r\n}\r\nswitch (insn->chanspec) {\r\ncase 0:\r\ntmp = data[0] & 0xFF;\r\nme4000_outb(dev, tmp, info->cnt_context.counter_0_reg);\r\ntmp = (data[0] >> 8) & 0xFF;\r\nme4000_outb(dev, tmp, info->cnt_context.counter_0_reg);\r\nbreak;\r\ncase 1:\r\ntmp = data[0] & 0xFF;\r\nme4000_outb(dev, tmp, info->cnt_context.counter_1_reg);\r\ntmp = (data[0] >> 8) & 0xFF;\r\nme4000_outb(dev, tmp, info->cnt_context.counter_1_reg);\r\nbreak;\r\ncase 2:\r\ntmp = data[0] & 0xFF;\r\nme4000_outb(dev, tmp, info->cnt_context.counter_2_reg);\r\ntmp = (data[0] >> 8) & 0xFF;\r\nme4000_outb(dev, tmp, info->cnt_context.counter_2_reg);\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR\r\n"comedi%d: me4000: me4000_cnt_insn_write(): "\r\n"Invalid channel %d\n",\r\ndev->minor, insn->chanspec);\r\nreturn -EINVAL;\r\n}\r\nreturn 1;\r\n}\r\nstatic int __devinit driver_me4000_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nreturn comedi_pci_auto_config(dev, driver_me4000.driver_name);\r\n}\r\nstatic void __devexit driver_me4000_pci_remove(struct pci_dev *dev)\r\n{\r\ncomedi_pci_auto_unconfig(dev);\r\n}\r\nstatic int __init driver_me4000_init_module(void)\r\n{\r\nint retval;\r\nretval = comedi_driver_register(&driver_me4000);\r\nif (retval < 0)\r\nreturn retval;\r\ndriver_me4000_pci_driver.name = (char *)driver_me4000.driver_name;\r\nreturn pci_register_driver(&driver_me4000_pci_driver);\r\n}\r\nstatic void __exit driver_me4000_cleanup_module(void)\r\n{\r\npci_unregister_driver(&driver_me4000_pci_driver);\r\ncomedi_driver_unregister(&driver_me4000);\r\n}

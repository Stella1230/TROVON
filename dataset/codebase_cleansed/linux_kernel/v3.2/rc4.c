void rc4_init(PRC4Ext pRC4, unsigned char *pbyKey, unsigned int cbKey_len)\r\n{\r\nunsigned int ust1, ust2;\r\nunsigned int keyindex;\r\nunsigned int stateindex;\r\nunsigned char *pbyst;\r\nunsigned int idx;\r\npbyst = pRC4->abystate;\r\npRC4->ux = 0;\r\npRC4->uy = 0;\r\nfor (idx = 0; idx < 256; idx++)\r\npbyst[idx] = (unsigned char)idx;\r\nkeyindex = 0;\r\nstateindex = 0;\r\nfor (idx = 0; idx < 256; idx++) {\r\nust1 = pbyst[idx];\r\nstateindex = (stateindex + pbyKey[keyindex] + ust1) & 0xff;\r\nust2 = pbyst[stateindex];\r\npbyst[stateindex] = (unsigned char)ust1;\r\npbyst[idx] = (unsigned char)ust2;\r\nif (++keyindex >= cbKey_len)\r\nkeyindex = 0;\r\n}\r\n}\r\nunsigned int rc4_byte(PRC4Ext pRC4)\r\n{\r\nunsigned int ux;\r\nunsigned int uy;\r\nunsigned int ustx, usty;\r\nunsigned char *pbyst;\r\npbyst = pRC4->abystate;\r\nux = (pRC4->ux + 1) & 0xff;\r\nustx = pbyst[ux];\r\nuy = (ustx + pRC4->uy) & 0xff;\r\nusty = pbyst[uy];\r\npRC4->ux = ux;\r\npRC4->uy = uy;\r\npbyst[uy] = (unsigned char)ustx;\r\npbyst[ux] = (unsigned char)usty;\r\nreturn pbyst[(ustx + usty) & 0xff];\r\n}\r\nvoid rc4_encrypt(PRC4Ext pRC4, unsigned char *pbyDest,\r\nunsigned char *pbySrc, unsigned int cbData_len)\r\n{\r\nunsigned int ii;\r\nfor (ii = 0; ii < cbData_len; ii++)\r\npbyDest[ii] = (unsigned char)(pbySrc[ii] ^ rc4_byte(pRC4));\r\n}

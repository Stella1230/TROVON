static int m41t94_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nu8 buf[8];\r\ndev_dbg(dev, "%s secs=%d, mins=%d, "\r\n"hours=%d, mday=%d, mon=%d, year=%d, wday=%d\n",\r\n"write", tm->tm_sec, tm->tm_min,\r\ntm->tm_hour, tm->tm_mday,\r\ntm->tm_mon, tm->tm_year, tm->tm_wday);\r\nbuf[0] = 0x80 | M41T94_REG_SECONDS;\r\nbuf[M41T94_REG_SECONDS] = bin2bcd(tm->tm_sec);\r\nbuf[M41T94_REG_MINUTES] = bin2bcd(tm->tm_min);\r\nbuf[M41T94_REG_HOURS] = bin2bcd(tm->tm_hour);\r\nbuf[M41T94_REG_WDAY] = bin2bcd(tm->tm_wday + 1);\r\nbuf[M41T94_REG_DAY] = bin2bcd(tm->tm_mday);\r\nbuf[M41T94_REG_MONTH] = bin2bcd(tm->tm_mon + 1);\r\nbuf[M41T94_REG_HOURS] |= M41T94_BIT_CEB;\r\nif (tm->tm_year >= 100)\r\nbuf[M41T94_REG_HOURS] |= M41T94_BIT_CB;\r\nbuf[M41T94_REG_YEAR] = bin2bcd(tm->tm_year % 100);\r\nreturn spi_write(spi, buf, 8);\r\n}\r\nstatic int m41t94_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nu8 buf[2];\r\nint ret, hour;\r\nret = spi_w8r8(spi, M41T94_REG_HT);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret & M41T94_BIT_HALT) {\r\nbuf[0] = 0x80 | M41T94_REG_HT;\r\nbuf[1] = ret & ~M41T94_BIT_HALT;\r\nspi_write(spi, buf, 2);\r\n}\r\nret = spi_w8r8(spi, M41T94_REG_SECONDS);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret & M41T94_BIT_STOP) {\r\nbuf[0] = 0x80 | M41T94_REG_SECONDS;\r\nbuf[1] = ret & ~M41T94_BIT_STOP;\r\nspi_write(spi, buf, 2);\r\n}\r\ntm->tm_sec = bcd2bin(spi_w8r8(spi, M41T94_REG_SECONDS));\r\ntm->tm_min = bcd2bin(spi_w8r8(spi, M41T94_REG_MINUTES));\r\nhour = spi_w8r8(spi, M41T94_REG_HOURS);\r\ntm->tm_hour = bcd2bin(hour & 0x3f);\r\ntm->tm_wday = bcd2bin(spi_w8r8(spi, M41T94_REG_WDAY)) - 1;\r\ntm->tm_mday = bcd2bin(spi_w8r8(spi, M41T94_REG_DAY));\r\ntm->tm_mon = bcd2bin(spi_w8r8(spi, M41T94_REG_MONTH)) - 1;\r\ntm->tm_year = bcd2bin(spi_w8r8(spi, M41T94_REG_YEAR));\r\nif ((hour & M41T94_BIT_CB) || !(hour & M41T94_BIT_CEB))\r\ntm->tm_year += 100;\r\ndev_dbg(dev, "%s secs=%d, mins=%d, "\r\n"hours=%d, mday=%d, mon=%d, year=%d, wday=%d\n",\r\n"read", tm->tm_sec, tm->tm_min,\r\ntm->tm_hour, tm->tm_mday,\r\ntm->tm_mon, tm->tm_year, tm->tm_wday);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int __devinit m41t94_probe(struct spi_device *spi)\r\n{\r\nstruct rtc_device *rtc;\r\nint res;\r\nspi->bits_per_word = 8;\r\nspi_setup(spi);\r\nres = spi_w8r8(spi, M41T94_REG_SECONDS);\r\nif (res < 0) {\r\ndev_err(&spi->dev, "not found.\n");\r\nreturn res;\r\n}\r\nrtc = rtc_device_register(m41t94_driver.driver.name,\r\n&spi->dev, &m41t94_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\ndev_set_drvdata(&spi->dev, rtc);\r\nreturn 0;\r\n}\r\nstatic int __devexit m41t94_remove(struct spi_device *spi)\r\n{\r\nstruct rtc_device *rtc = spi_get_drvdata(spi);\r\nif (rtc)\r\nrtc_device_unregister(rtc);\r\nreturn 0;\r\n}\r\nstatic __init int m41t94_init(void)\r\n{\r\nreturn spi_register_driver(&m41t94_driver);\r\n}\r\nstatic __exit void m41t94_exit(void)\r\n{\r\nspi_unregister_driver(&m41t94_driver);\r\n}

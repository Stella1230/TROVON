int via_agp_init(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\ndrm_via_agp_t *agp = data;\r\ndrm_via_private_t *dev_priv = (drm_via_private_t *) dev->dev_private;\r\nint ret;\r\nmutex_lock(&dev->struct_mutex);\r\nret = drm_sman_set_range(&dev_priv->sman, VIA_MEM_AGP, 0,\r\nagp->size >> VIA_MM_ALIGN_SHIFT);\r\nif (ret) {\r\nDRM_ERROR("AGP memory manager initialisation error\n");\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn ret;\r\n}\r\ndev_priv->agp_initialized = 1;\r\ndev_priv->agp_offset = agp->offset;\r\nmutex_unlock(&dev->struct_mutex);\r\nDRM_DEBUG("offset = %u, size = %u\n", agp->offset, agp->size);\r\nreturn 0;\r\n}\r\nint via_fb_init(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\ndrm_via_fb_t *fb = data;\r\ndrm_via_private_t *dev_priv = (drm_via_private_t *) dev->dev_private;\r\nint ret;\r\nmutex_lock(&dev->struct_mutex);\r\nret = drm_sman_set_range(&dev_priv->sman, VIA_MEM_VIDEO, 0,\r\nfb->size >> VIA_MM_ALIGN_SHIFT);\r\nif (ret) {\r\nDRM_ERROR("VRAM memory manager initialisation error\n");\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn ret;\r\n}\r\ndev_priv->vram_initialized = 1;\r\ndev_priv->vram_offset = fb->offset;\r\nmutex_unlock(&dev->struct_mutex);\r\nDRM_DEBUG("offset = %u, size = %u\n", fb->offset, fb->size);\r\nreturn 0;\r\n}\r\nint via_final_context(struct drm_device *dev, int context)\r\n{\r\ndrm_via_private_t *dev_priv = (drm_via_private_t *) dev->dev_private;\r\nvia_release_futex(dev_priv, context);\r\nif (dev->ctx_count == 1 && dev->dev_private) {\r\nDRM_DEBUG("Last Context\n");\r\ndrm_irq_uninstall(dev);\r\nvia_cleanup_futex(dev_priv);\r\nvia_do_cleanup_map(dev);\r\n}\r\nreturn 1;\r\n}\r\nvoid via_lastclose(struct drm_device *dev)\r\n{\r\ndrm_via_private_t *dev_priv = (drm_via_private_t *) dev->dev_private;\r\nif (!dev_priv)\r\nreturn;\r\nmutex_lock(&dev->struct_mutex);\r\ndrm_sman_cleanup(&dev_priv->sman);\r\ndev_priv->vram_initialized = 0;\r\ndev_priv->agp_initialized = 0;\r\nmutex_unlock(&dev->struct_mutex);\r\n}\r\nint via_mem_alloc(struct drm_device *dev, void *data,\r\nstruct drm_file *file_priv)\r\n{\r\ndrm_via_mem_t *mem = data;\r\nint retval = 0;\r\nstruct drm_memblock_item *item;\r\ndrm_via_private_t *dev_priv = (drm_via_private_t *) dev->dev_private;\r\nunsigned long tmpSize;\r\nif (mem->type > VIA_MEM_AGP) {\r\nDRM_ERROR("Unknown memory type allocation\n");\r\nreturn -EINVAL;\r\n}\r\nmutex_lock(&dev->struct_mutex);\r\nif (0 == ((mem->type == VIA_MEM_VIDEO) ? dev_priv->vram_initialized :\r\ndev_priv->agp_initialized)) {\r\nDRM_ERROR\r\n("Attempt to allocate from uninitialized memory manager.\n");\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn -EINVAL;\r\n}\r\ntmpSize = (mem->size + VIA_MM_ALIGN_MASK) >> VIA_MM_ALIGN_SHIFT;\r\nitem = drm_sman_alloc(&dev_priv->sman, mem->type, tmpSize, 0,\r\n(unsigned long)file_priv);\r\nmutex_unlock(&dev->struct_mutex);\r\nif (item) {\r\nmem->offset = ((mem->type == VIA_MEM_VIDEO) ?\r\ndev_priv->vram_offset : dev_priv->agp_offset) +\r\n(item->mm->\r\noffset(item->mm, item->mm_info) << VIA_MM_ALIGN_SHIFT);\r\nmem->index = item->user_hash.key;\r\n} else {\r\nmem->offset = 0;\r\nmem->size = 0;\r\nmem->index = 0;\r\nDRM_DEBUG("Video memory allocation failed\n");\r\nretval = -ENOMEM;\r\n}\r\nreturn retval;\r\n}\r\nint via_mem_free(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\ndrm_via_private_t *dev_priv = dev->dev_private;\r\ndrm_via_mem_t *mem = data;\r\nint ret;\r\nmutex_lock(&dev->struct_mutex);\r\nret = drm_sman_free_key(&dev_priv->sman, mem->index);\r\nmutex_unlock(&dev->struct_mutex);\r\nDRM_DEBUG("free = 0x%lx\n", mem->index);\r\nreturn ret;\r\n}\r\nvoid via_reclaim_buffers_locked(struct drm_device *dev,\r\nstruct drm_file *file_priv)\r\n{\r\ndrm_via_private_t *dev_priv = dev->dev_private;\r\nmutex_lock(&dev->struct_mutex);\r\nif (drm_sman_owner_clean(&dev_priv->sman, (unsigned long)file_priv)) {\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn;\r\n}\r\nif (dev->driver->dma_quiescent)\r\ndev->driver->dma_quiescent(dev);\r\ndrm_sman_owner_cleanup(&dev_priv->sman, (unsigned long)file_priv);\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn;\r\n}

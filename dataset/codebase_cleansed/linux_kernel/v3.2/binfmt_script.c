static int load_script(struct linux_binprm *bprm,struct pt_regs *regs)\r\n{\r\nconst char *i_arg, *i_name;\r\nchar *cp;\r\nstruct file *file;\r\nchar interp[BINPRM_BUF_SIZE];\r\nint retval;\r\nif ((bprm->buf[0] != '#') || (bprm->buf[1] != '!') ||\r\n(bprm->recursion_depth > BINPRM_MAX_RECURSION))\r\nreturn -ENOEXEC;\r\nbprm->recursion_depth++;\r\nallow_write_access(bprm->file);\r\nfput(bprm->file);\r\nbprm->file = NULL;\r\nbprm->buf[BINPRM_BUF_SIZE - 1] = '\0';\r\nif ((cp = strchr(bprm->buf, '\n')) == NULL)\r\ncp = bprm->buf+BINPRM_BUF_SIZE-1;\r\n*cp = '\0';\r\nwhile (cp > bprm->buf) {\r\ncp--;\r\nif ((*cp == ' ') || (*cp == '\t'))\r\n*cp = '\0';\r\nelse\r\nbreak;\r\n}\r\nfor (cp = bprm->buf+2; (*cp == ' ') || (*cp == '\t'); cp++);\r\nif (*cp == '\0')\r\nreturn -ENOEXEC;\r\ni_name = cp;\r\ni_arg = NULL;\r\nfor ( ; *cp && (*cp != ' ') && (*cp != '\t'); cp++)\r\n;\r\nwhile ((*cp == ' ') || (*cp == '\t'))\r\n*cp++ = '\0';\r\nif (*cp)\r\ni_arg = cp;\r\nstrcpy (interp, i_name);\r\nretval = remove_arg_zero(bprm);\r\nif (retval)\r\nreturn retval;\r\nretval = copy_strings_kernel(1, &bprm->interp, bprm);\r\nif (retval < 0) return retval;\r\nbprm->argc++;\r\nif (i_arg) {\r\nretval = copy_strings_kernel(1, &i_arg, bprm);\r\nif (retval < 0) return retval;\r\nbprm->argc++;\r\n}\r\nretval = copy_strings_kernel(1, &i_name, bprm);\r\nif (retval) return retval;\r\nbprm->argc++;\r\nbprm->interp = interp;\r\nfile = open_exec(interp);\r\nif (IS_ERR(file))\r\nreturn PTR_ERR(file);\r\nbprm->file = file;\r\nretval = prepare_binprm(bprm);\r\nif (retval < 0)\r\nreturn retval;\r\nreturn search_binary_handler(bprm,regs);\r\n}\r\nstatic int __init init_script_binfmt(void)\r\n{\r\nreturn register_binfmt(&script_format);\r\n}\r\nstatic void __exit exit_script_binfmt(void)\r\n{\r\nunregister_binfmt(&script_format);\r\n}

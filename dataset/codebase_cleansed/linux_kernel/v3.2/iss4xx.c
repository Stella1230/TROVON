static int __init iss4xx_device_probe(void)\r\n{\r\nof_platform_bus_probe(NULL, iss4xx_of_bus, NULL);\r\nof_instantiate_rtc();\r\nreturn 0;\r\n}\r\nstatic void __init iss4xx_init_irq(void)\r\n{\r\nstruct device_node *np;\r\nfor_each_node_with_property(np, "interrupt-controller") {\r\nif (of_get_property(np, "interrupts", NULL) == NULL)\r\nbreak;\r\n}\r\nif (np == NULL)\r\npanic("Can't find top level interrupt controller");\r\nif (of_device_is_compatible(np, "ibm,uic")) {\r\nuic_init_tree();\r\nppc_md.get_irq = uic_get_irq;\r\n#ifdef CONFIG_MPIC\r\n} else if (of_device_is_compatible(np, "chrp,open-pic")) {\r\nstruct mpic *mpic = mpic_alloc(np, 0, MPIC_PRIMARY, 0, 0,\r\n" MPIC ");\r\nBUG_ON(mpic == NULL);\r\nmpic_init(mpic);\r\nppc_md.get_irq = mpic_get_irq;\r\n#endif\r\n} else\r\npanic("Unrecognized top level interrupt controller");\r\n}\r\nstatic void __cpuinit smp_iss4xx_setup_cpu(int cpu)\r\n{\r\nmpic_setup_this_cpu();\r\n}\r\nstatic int __cpuinit smp_iss4xx_kick_cpu(int cpu)\r\n{\r\nstruct device_node *cpunode = of_get_cpu_node(cpu, NULL);\r\nconst u64 *spin_table_addr_prop;\r\nu32 *spin_table;\r\nextern void start_secondary_47x(void);\r\nBUG_ON(cpunode == NULL);\r\nspin_table_addr_prop = of_get_property(cpunode, "cpu-release-addr",\r\nNULL);\r\nif (spin_table_addr_prop == NULL) {\r\npr_err("CPU%d: Can't start, missing cpu-release-addr !\n", cpu);\r\nreturn -ENOENT;\r\n}\r\nspin_table = (u32 *)__va(*spin_table_addr_prop);\r\npr_debug("CPU%d: Spin table mapped at %p\n", cpu, spin_table);\r\nspin_table[3] = cpu;\r\nsmp_wmb();\r\nspin_table[1] = __pa(start_secondary_47x);\r\nmb();\r\nreturn 0;\r\n}\r\nstatic void __init iss4xx_smp_init(void)\r\n{\r\nif (mmu_has_feature(MMU_FTR_TYPE_47x))\r\nsmp_ops = &iss_smp_ops;\r\n}\r\nstatic void __init iss4xx_smp_init(void) { }\r\nstatic void __init iss4xx_setup_arch(void)\r\n{\r\niss4xx_smp_init();\r\n}\r\nstatic int __init iss4xx_probe(void)\r\n{\r\nunsigned long root = of_get_flat_dt_root();\r\nif (!of_flat_dt_is_compatible(root, "ibm,iss-4xx"))\r\nreturn 0;\r\nreturn 1;\r\n}

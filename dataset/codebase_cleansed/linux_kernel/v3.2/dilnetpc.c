static inline void setcsc(int reg, unsigned char data)\r\n{\r\noutb(reg, CSC_INDEX);\r\noutb(data, CSC_DATA);\r\n}\r\nstatic inline unsigned char getcsc(int reg)\r\n{\r\noutb(reg, CSC_INDEX);\r\nreturn(inb(CSC_DATA));\r\n}\r\nstatic inline void setpcc(int reg, unsigned char data)\r\n{\r\noutb(reg, PCC_INDEX);\r\noutb(data, PCC_DATA);\r\n}\r\nstatic inline unsigned char getpcc(int reg)\r\n{\r\noutb(reg, PCC_INDEX);\r\nreturn(inb(PCC_DATA));\r\n}\r\nstatic void dnpc_map_flash(unsigned long flash_base, unsigned long flash_size)\r\n{\r\nunsigned long flash_end = flash_base + flash_size - 1;\r\nsetcsc(CSC_CR, getcsc(CSC_CR) | 0x2);\r\nsetcsc(CSC_PCCMDCR, getcsc(CSC_PCCMDCR) & ~1);\r\nsetpcc(PCC_MWSAR_1_Lo, (flash_base >> 12) & 0xff);\r\nsetpcc(PCC_MWSAR_1_Hi, (flash_base >> 20) & 0x3f);\r\nsetpcc(PCC_MWEAR_1_Lo, (flash_end >> 12) & 0xff);\r\nsetpcc(PCC_MWEAR_1_Hi, (flash_end >> 20) & 0x3f);\r\nsetpcc(PCC_MWAOR_1_Lo, ((0 - flash_base) >> 12) & 0xff);\r\nsetpcc(PCC_MWAOR_1_Hi, ((0 - flash_base)>> 20) & 0x3f);\r\nsetcsc(CSC_MMSWAR, getcsc(CSC_MMSWAR) & ~0x11);\r\nsetcsc(CSC_MMSWDSR, getcsc(CSC_MMSWDSR) & ~0x03);\r\nsetpcc(PCC_AWER_B, getpcc(PCC_AWER_B) | 0x02);\r\nsetcsc(CSC_CR, getcsc(CSC_CR) & ~0x2);\r\n}\r\nstatic void dnpc_unmap_flash(void)\r\n{\r\nsetcsc(CSC_CR, getcsc(CSC_CR) | 0x2);\r\nsetpcc(PCC_AWER_B, getpcc(PCC_AWER_B) & ~0x02);\r\nsetcsc(CSC_CR, getcsc(CSC_CR) & ~0x2);\r\n}\r\nstatic void dnp_set_vpp(struct map_info *not_used, int on)\r\n{\r\nspin_lock_irq(&dnpc_spin);\r\nif (on)\r\n{\r\nif(++vpp_counter == 1)\r\nsetcsc(CSC_RBWR, getcsc(CSC_RBWR) & ~0x4);\r\n}\r\nelse\r\n{\r\nif(--vpp_counter == 0)\r\nsetcsc(CSC_RBWR, getcsc(CSC_RBWR) | 0x4);\r\nelse\r\nBUG_ON(vpp_counter < 0);\r\n}\r\nspin_unlock_irq(&dnpc_spin);\r\n}\r\nstatic void adnp_set_vpp(struct map_info *not_used, int on)\r\n{\r\nspin_lock_irq(&dnpc_spin);\r\nif (on)\r\n{\r\nif(++vpp_counter == 1)\r\nsetcsc(CSC_RBWR, getcsc(CSC_RBWR) & ~0x8);\r\n}\r\nelse\r\n{\r\nif(--vpp_counter == 0)\r\nsetcsc(CSC_RBWR, getcsc(CSC_RBWR) | 0x8);\r\nelse\r\nBUG_ON(vpp_counter < 0);\r\n}\r\nspin_unlock_irq(&dnpc_spin);\r\n}\r\nstatic int dnp_adnp_probe(void)\r\n{\r\nchar *biosid, rc = -1;\r\nbiosid = (char*)ioremap(BIOSID_BASE, 16);\r\nif(biosid)\r\n{\r\nif(!strcmp(biosid, ID_DNPC))\r\nrc = 1;\r\nelse if(!strcmp(biosid, ID_ADNP))\r\nrc = 0;\r\n}\r\niounmap((void *)biosid);\r\nreturn(rc);\r\n}\r\nstatic int __init init_dnpc(void)\r\n{\r\nint is_dnp;\r\nif((is_dnp = dnp_adnp_probe()) < 0)\r\nreturn -ENXIO;\r\nif(is_dnp)\r\n{\r\nint i;\r\ndnpc_map.size = DNP_WINDOW_SIZE;\r\ndnpc_map.set_vpp = dnp_set_vpp;\r\npartition_info[2].size = 0xf0000;\r\n++dnpc_map.name;\r\nfor(i = 0; i < NUM_PARTITIONS; i++)\r\n++partition_info[i].name;\r\nhiglvl_partition_info[1].size = DNP_WINDOW_SIZE -\r\nCONFIG_MTD_DILNETPC_BOOTSIZE - 0x20000;\r\nfor(i = 0; i < NUM_HIGHLVL_PARTITIONS; i++)\r\n++higlvl_partition_info[i].name;\r\n}\r\nprintk(KERN_NOTICE "DIL/Net %s flash: 0x%lx at 0x%llx\n",\r\nis_dnp ? "DNPC" : "ADNP", dnpc_map.size, (unsigned long long)dnpc_map.phys);\r\ndnpc_map.virt = ioremap_nocache(dnpc_map.phys, dnpc_map.size);\r\ndnpc_map_flash(dnpc_map.phys, dnpc_map.size);\r\nif (!dnpc_map.virt) {\r\nprintk("Failed to ioremap_nocache\n");\r\nreturn -EIO;\r\n}\r\nsimple_map_init(&dnpc_map);\r\nprintk("FLASH virtual address: 0x%p\n", dnpc_map.virt);\r\nmymtd = do_map_probe("jedec_probe", &dnpc_map);\r\nif (!mymtd)\r\nmymtd = do_map_probe("cfi_probe", &dnpc_map);\r\nif (!mymtd)\r\nif((mymtd = do_map_probe("map_rom", &dnpc_map)))\r\nmymtd->erasesize = 0x10000;\r\nif (!mymtd) {\r\niounmap(dnpc_map.virt);\r\nreturn -ENXIO;\r\n}\r\nmymtd->owner = THIS_MODULE;\r\npartition_info[0].mtdp = &lowlvl_parts[0];\r\npartition_info[1].mtdp = &lowlvl_parts[2];\r\npartition_info[2].mtdp = &lowlvl_parts[1];\r\npartition_info[3].mtdp = &lowlvl_parts[3];\r\nmtd_device_register(mymtd, partition_info, NUM_PARTITIONS);\r\nmerged_mtd = mtd_concat_create(lowlvl_parts, NUM_PARTITIONS, "(A)DNP Flash Concatenated");\r\nif(merged_mtd)\r\n{\r\nmtd_device_register(merged_mtd, higlvl_partition_info,\r\nNUM_HIGHLVL_PARTITIONS);\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit cleanup_dnpc(void)\r\n{\r\nif(merged_mtd) {\r\nmtd_device_unregister(merged_mtd);\r\nmtd_concat_destroy(merged_mtd);\r\n}\r\nif (mymtd) {\r\nmtd_device_unregister(mymtd);\r\nmap_destroy(mymtd);\r\n}\r\nif (dnpc_map.virt) {\r\niounmap(dnpc_map.virt);\r\ndnpc_unmap_flash();\r\ndnpc_map.virt = NULL;\r\n}\r\n}

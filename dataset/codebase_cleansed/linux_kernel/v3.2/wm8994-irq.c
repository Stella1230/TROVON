static inline int irq_data_to_status_reg(struct wm8994_irq_data *irq_data)\r\n{\r\nreturn WM8994_INTERRUPT_STATUS_1 - 1 + irq_data->reg;\r\n}\r\nstatic inline int irq_data_to_mask_reg(struct wm8994_irq_data *irq_data)\r\n{\r\nreturn WM8994_INTERRUPT_STATUS_1_MASK - 1 + irq_data->reg;\r\n}\r\nstatic inline struct wm8994_irq_data *irq_to_wm8994_irq(struct wm8994 *wm8994,\r\nint irq)\r\n{\r\nreturn &wm8994_irqs[irq - wm8994->irq_base];\r\n}\r\nstatic void wm8994_irq_lock(struct irq_data *data)\r\n{\r\nstruct wm8994 *wm8994 = irq_data_get_irq_chip_data(data);\r\nmutex_lock(&wm8994->irq_lock);\r\n}\r\nstatic void wm8994_irq_sync_unlock(struct irq_data *data)\r\n{\r\nstruct wm8994 *wm8994 = irq_data_get_irq_chip_data(data);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(wm8994->irq_masks_cur); i++) {\r\nif (wm8994->irq_masks_cur[i] != wm8994->irq_masks_cache[i]) {\r\nwm8994->irq_masks_cache[i] = wm8994->irq_masks_cur[i];\r\nwm8994_reg_write(wm8994,\r\nWM8994_INTERRUPT_STATUS_1_MASK + i,\r\nwm8994->irq_masks_cur[i]);\r\n}\r\n}\r\nmutex_unlock(&wm8994->irq_lock);\r\n}\r\nstatic void wm8994_irq_enable(struct irq_data *data)\r\n{\r\nstruct wm8994 *wm8994 = irq_data_get_irq_chip_data(data);\r\nstruct wm8994_irq_data *irq_data = irq_to_wm8994_irq(wm8994,\r\ndata->irq);\r\nwm8994->irq_masks_cur[irq_data->reg - 1] &= ~irq_data->mask;\r\n}\r\nstatic void wm8994_irq_disable(struct irq_data *data)\r\n{\r\nstruct wm8994 *wm8994 = irq_data_get_irq_chip_data(data);\r\nstruct wm8994_irq_data *irq_data = irq_to_wm8994_irq(wm8994,\r\ndata->irq);\r\nwm8994->irq_masks_cur[irq_data->reg - 1] |= irq_data->mask;\r\n}\r\nstatic irqreturn_t wm8994_irq_thread(int irq, void *data)\r\n{\r\nstruct wm8994 *wm8994 = data;\r\nunsigned int i;\r\nu16 status[WM8994_NUM_IRQ_REGS];\r\nint ret;\r\nret = wm8994_bulk_read(wm8994, WM8994_INTERRUPT_STATUS_1,\r\nWM8994_NUM_IRQ_REGS, status);\r\nif (ret < 0) {\r\ndev_err(wm8994->dev, "Failed to read interrupt status: %d\n",\r\nret);\r\nreturn IRQ_NONE;\r\n}\r\nfor (i = 0; i < WM8994_NUM_IRQ_REGS; i++) {\r\nstatus[i] = be16_to_cpu(status[i]);\r\nstatus[i] &= ~wm8994->irq_masks_cur[i];\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(status); i++) {\r\nif (status[i])\r\nwm8994_reg_write(wm8994, WM8994_INTERRUPT_STATUS_1 + i,\r\nstatus[i]);\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(wm8994_irqs); i++) {\r\nif (status[wm8994_irqs[i].reg - 1] & wm8994_irqs[i].mask)\r\nhandle_nested_irq(wm8994->irq_base + i);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nint wm8994_irq_init(struct wm8994 *wm8994)\r\n{\r\nint i, cur_irq, ret;\r\nmutex_init(&wm8994->irq_lock);\r\nfor (i = 0; i < ARRAY_SIZE(wm8994->irq_masks_cur); i++) {\r\nwm8994->irq_masks_cur[i] = 0xffff;\r\nwm8994->irq_masks_cache[i] = 0xffff;\r\nwm8994_reg_write(wm8994, WM8994_INTERRUPT_STATUS_1_MASK + i,\r\n0xffff);\r\n}\r\nif (!wm8994->irq) {\r\ndev_warn(wm8994->dev,\r\n"No interrupt specified, no interrupts\n");\r\nwm8994->irq_base = 0;\r\nreturn 0;\r\n}\r\nif (!wm8994->irq_base) {\r\ndev_err(wm8994->dev,\r\n"No interrupt base specified, no interrupts\n");\r\nreturn 0;\r\n}\r\nfor (cur_irq = wm8994->irq_base;\r\ncur_irq < ARRAY_SIZE(wm8994_irqs) + wm8994->irq_base;\r\ncur_irq++) {\r\nirq_set_chip_data(cur_irq, wm8994);\r\nirq_set_chip_and_handler(cur_irq, &wm8994_irq_chip,\r\nhandle_edge_irq);\r\nirq_set_nested_thread(cur_irq, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(cur_irq, IRQF_VALID);\r\n#else\r\nirq_set_noprobe(cur_irq);\r\n#endif\r\n}\r\nret = request_threaded_irq(wm8994->irq, NULL, wm8994_irq_thread,\r\nIRQF_TRIGGER_HIGH | IRQF_ONESHOT,\r\n"wm8994", wm8994);\r\nif (ret != 0) {\r\ndev_err(wm8994->dev, "Failed to request IRQ %d: %d\n",\r\nwm8994->irq, ret);\r\nreturn ret;\r\n}\r\nwm8994_reg_write(wm8994, WM8994_INTERRUPT_CONTROL, 0);\r\nreturn 0;\r\n}\r\nvoid wm8994_irq_exit(struct wm8994 *wm8994)\r\n{\r\nif (wm8994->irq)\r\nfree_irq(wm8994->irq, wm8994);\r\n}

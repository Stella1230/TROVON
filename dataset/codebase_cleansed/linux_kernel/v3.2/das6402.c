static int __init driver_das6402_init_module(void)\r\n{\r\nreturn comedi_driver_register(&driver_das6402);\r\n}\r\nstatic void __exit driver_das6402_cleanup_module(void)\r\n{\r\ncomedi_driver_unregister(&driver_das6402);\r\n}\r\nstatic void das6402_setcounter(struct comedi_device *dev)\r\n{\r\nBYTE p;\r\nunsigned short ctrlwrd;\r\np = M0 | C0 | RWLH;\r\noutb_p(p, dev->iobase + 15);\r\nctrlwrd = 2000;\r\np = (BYTE) (0xff & ctrlwrd);\r\noutb_p(p, dev->iobase + 12);\r\np = (BYTE) (0xff & (ctrlwrd >> 8));\r\noutb_p(p, dev->iobase + 12);\r\np = M2 | C1 | RWLH;\r\noutb_p(p, dev->iobase + 15);\r\nctrlwrd = 10;\r\np = (BYTE) (0xff & ctrlwrd);\r\noutb_p(p, dev->iobase + 13);\r\np = (BYTE) (0xff & (ctrlwrd >> 8));\r\noutb_p(p, dev->iobase + 13);\r\np = M2 | C2 | RWLH;\r\noutb_p(p, dev->iobase + 15);\r\nctrlwrd = 1000;\r\np = (BYTE) (0xff & ctrlwrd);\r\noutb_p(p, dev->iobase + 14);\r\np = (BYTE) (0xff & (ctrlwrd >> 8));\r\noutb_p(p, dev->iobase + 14);\r\n}\r\nstatic irqreturn_t intr_handler(int irq, void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nstruct comedi_subdevice *s = dev->subdevices;\r\nif (!dev->attached || devpriv->das6402_ignoreirq) {\r\nprintk("das6402: BUG: spurious interrupt\n");\r\nreturn IRQ_HANDLED;\r\n}\r\n#ifdef DEBUG\r\nprintk("das6402: interrupt! das6402_irqcount=%i\n",\r\ndevpriv->das6402_irqcount);\r\nprintk("das6402: iobase+2=%i\n", inw_p(dev->iobase + 2));\r\n#endif\r\ndas6402_ai_fifo_dregs(dev, s);\r\nif (s->async->buf_write_count >= devpriv->ai_bytes_to_read) {\r\noutw_p(SCANL, dev->iobase + 2);\r\noutb(0x07, dev->iobase + 8);\r\n#ifdef DEBUG\r\nprintk("das6402: Got %i samples\n\n",\r\ndevpriv->das6402_wordsread - diff);\r\n#endif\r\ns->async->events |= COMEDI_CB_EOA;\r\ncomedi_event(dev, s);\r\n}\r\noutb(0x01, dev->iobase + 8);\r\ncomedi_event(dev, s);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void das6402_ai_fifo_dregs(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nwhile (1) {\r\nif (!(inb(dev->iobase + 8) & 0x01))\r\nreturn;\r\ncomedi_buf_put(s->async, inw(dev->iobase));\r\n}\r\n}\r\nstatic int das6402_ai_cancel(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\ndevpriv->das6402_ignoreirq = 1;\r\n#ifdef DEBUG\r\nprintk("das6402: Stopping acquisition\n");\r\n#endif\r\ndevpriv->das6402_ignoreirq = 1;\r\noutb_p(0x02, dev->iobase + 10);\r\noutw_p(SCANL, dev->iobase + 2);\r\noutb_p(0, dev->iobase + 9);\r\noutw_p(SCANL, dev->iobase + 2);\r\nreturn 0;\r\n}\r\nstatic int das6402_ai_mode2(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, comedi_trig * it)\r\n{\r\ndevpriv->das6402_ignoreirq = 1;\r\n#ifdef DEBUG\r\nprintk("das6402: Starting acquisition\n");\r\n#endif\r\noutb_p(0x03, dev->iobase + 10);\r\noutw_p(SCANL, dev->iobase + 2);\r\noutb_p(IRQ | CONVSRC | BURSTEN | INTE, dev->iobase + 9);\r\ndevpriv->ai_bytes_to_read = it->n * sizeof(short);\r\ndevpriv->das6402_ignoreirq = 0;\r\noutw_p(SCANL, dev->iobase + 2);\r\nreturn 0;\r\n}\r\nstatic int board_init(struct comedi_device *dev)\r\n{\r\nBYTE b;\r\ndevpriv->das6402_ignoreirq = 1;\r\noutb(0x07, dev->iobase + 8);\r\noutb_p(MODE, dev->iobase + 11);\r\nb = BIP | SEM | MODE | GAIN | FIFOHFULL;\r\noutb_p(b, dev->iobase + 11);\r\noutb_p(EXTEND, dev->iobase + 8);\r\nb = EXTEND | MHZ;\r\noutb_p(b, dev->iobase + 8);\r\nb = MHZ | CLRINT | CLRXTR | CLRXIN;\r\noutb_p(b, dev->iobase + 8);\r\nb = IRQ | CONVSRC | BURSTEN | INTE;\r\noutb_p(b, dev->iobase + 9);\r\nb = TGSEL | TGEN;\r\noutb_p(b, dev->iobase + 10);\r\nb = 0x07;\r\noutb_p(b, dev->iobase + 8);\r\ndas6402_setcounter(dev);\r\noutw_p(SCANL, dev->iobase + 2);\r\ndevpriv->das6402_ignoreirq = 0;\r\nreturn 0;\r\n}\r\nstatic int das6402_detach(struct comedi_device *dev)\r\n{\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\nif (dev->iobase)\r\nrelease_region(dev->iobase, DAS6402_SIZE);\r\nreturn 0;\r\n}\r\nstatic int das6402_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nunsigned int irq;\r\nunsigned long iobase;\r\nint ret;\r\nstruct comedi_subdevice *s;\r\ndev->board_name = "das6402";\r\niobase = it->options[0];\r\nif (iobase == 0)\r\niobase = 0x300;\r\nprintk("comedi%d: das6402: 0x%04lx", dev->minor, iobase);\r\nif (!request_region(iobase, DAS6402_SIZE, "das6402")) {\r\nprintk(" I/O port conflict\n");\r\nreturn -EIO;\r\n}\r\ndev->iobase = iobase;\r\nirq = it->options[0];\r\nprintk(" ( irq = %u )", irq);\r\nret = request_irq(irq, intr_handler, 0, "das6402", dev);\r\nif (ret < 0) {\r\nprintk("irq conflict\n");\r\nreturn ret;\r\n}\r\ndev->irq = irq;\r\nret = alloc_private(dev, sizeof(struct das6402_private));\r\nif (ret < 0)\r\nreturn ret;\r\nret = alloc_subdevices(dev, 1);\r\nif (ret < 0)\r\nreturn ret;\r\ns = dev->subdevices + 0;\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND;\r\ns->n_chan = 8;\r\ns->cancel = das6402_ai_cancel;\r\ns->maxdata = (1 << 12) - 1;\r\ns->len_chanlist = 16;\r\ns->range_table = &range_unknown;\r\nboard_init(dev);\r\nreturn 0;\r\n}

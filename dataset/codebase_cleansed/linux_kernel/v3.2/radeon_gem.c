int radeon_gem_object_init(struct drm_gem_object *obj)\r\n{\r\nBUG();\r\nreturn 0;\r\n}\r\nvoid radeon_gem_object_free(struct drm_gem_object *gobj)\r\n{\r\nstruct radeon_bo *robj = gem_to_radeon_bo(gobj);\r\nif (robj) {\r\nradeon_bo_unref(&robj);\r\n}\r\n}\r\nint radeon_gem_object_create(struct radeon_device *rdev, int size,\r\nint alignment, int initial_domain,\r\nbool discardable, bool kernel,\r\nstruct drm_gem_object **obj)\r\n{\r\nstruct radeon_bo *robj;\r\nint r;\r\n*obj = NULL;\r\nif (alignment < PAGE_SIZE) {\r\nalignment = PAGE_SIZE;\r\n}\r\nr = radeon_bo_create(rdev, size, alignment, kernel, initial_domain, &robj);\r\nif (r) {\r\nif (r != -ERESTARTSYS)\r\nDRM_ERROR("Failed to allocate GEM object (%d, %d, %u, %d)\n",\r\nsize, initial_domain, alignment, r);\r\nreturn r;\r\n}\r\n*obj = &robj->gem_base;\r\nmutex_lock(&rdev->gem.mutex);\r\nlist_add_tail(&robj->list, &rdev->gem.objects);\r\nmutex_unlock(&rdev->gem.mutex);\r\nreturn 0;\r\n}\r\nint radeon_gem_object_pin(struct drm_gem_object *obj, uint32_t pin_domain,\r\nuint64_t *gpu_addr)\r\n{\r\nstruct radeon_bo *robj = gem_to_radeon_bo(obj);\r\nint r;\r\nr = radeon_bo_reserve(robj, false);\r\nif (unlikely(r != 0))\r\nreturn r;\r\nr = radeon_bo_pin(robj, pin_domain, gpu_addr);\r\nradeon_bo_unreserve(robj);\r\nreturn r;\r\n}\r\nvoid radeon_gem_object_unpin(struct drm_gem_object *obj)\r\n{\r\nstruct radeon_bo *robj = gem_to_radeon_bo(obj);\r\nint r;\r\nr = radeon_bo_reserve(robj, false);\r\nif (likely(r == 0)) {\r\nradeon_bo_unpin(robj);\r\nradeon_bo_unreserve(robj);\r\n}\r\n}\r\nint radeon_gem_set_domain(struct drm_gem_object *gobj,\r\nuint32_t rdomain, uint32_t wdomain)\r\n{\r\nstruct radeon_bo *robj;\r\nuint32_t domain;\r\nint r;\r\nrobj = gem_to_radeon_bo(gobj);\r\ndomain = wdomain;\r\nif (!domain) {\r\ndomain = rdomain;\r\n}\r\nif (!domain) {\r\nprintk(KERN_WARNING "Set domain withou domain !\n");\r\nreturn 0;\r\n}\r\nif (domain == RADEON_GEM_DOMAIN_CPU) {\r\nr = radeon_bo_wait(robj, NULL, false);\r\nif (r) {\r\nprintk(KERN_ERR "Failed to wait for object !\n");\r\nreturn r;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint radeon_gem_init(struct radeon_device *rdev)\r\n{\r\nINIT_LIST_HEAD(&rdev->gem.objects);\r\nreturn 0;\r\n}\r\nvoid radeon_gem_fini(struct radeon_device *rdev)\r\n{\r\nradeon_bo_force_delete(rdev);\r\n}\r\nint radeon_gem_info_ioctl(struct drm_device *dev, void *data,\r\nstruct drm_file *filp)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct drm_radeon_gem_info *args = data;\r\nstruct ttm_mem_type_manager *man;\r\nman = &rdev->mman.bdev.man[TTM_PL_VRAM];\r\nargs->vram_size = rdev->mc.real_vram_size;\r\nargs->vram_visible = (u64)man->size << PAGE_SHIFT;\r\nif (rdev->stollen_vga_memory)\r\nargs->vram_visible -= radeon_bo_size(rdev->stollen_vga_memory);\r\nargs->vram_visible -= radeon_fbdev_total_size(rdev);\r\nargs->gart_size = rdev->mc.gtt_size - rdev->cp.ring_size - 4096 -\r\nRADEON_IB_POOL_SIZE*64*1024;\r\nreturn 0;\r\n}\r\nint radeon_gem_pread_ioctl(struct drm_device *dev, void *data,\r\nstruct drm_file *filp)\r\n{\r\nDRM_ERROR("unimplemented %s\n", __func__);\r\nreturn -ENOSYS;\r\n}\r\nint radeon_gem_pwrite_ioctl(struct drm_device *dev, void *data,\r\nstruct drm_file *filp)\r\n{\r\nDRM_ERROR("unimplemented %s\n", __func__);\r\nreturn -ENOSYS;\r\n}\r\nint radeon_gem_create_ioctl(struct drm_device *dev, void *data,\r\nstruct drm_file *filp)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct drm_radeon_gem_create *args = data;\r\nstruct drm_gem_object *gobj;\r\nuint32_t handle;\r\nint r;\r\nargs->size = roundup(args->size, PAGE_SIZE);\r\nr = radeon_gem_object_create(rdev, args->size, args->alignment,\r\nargs->initial_domain, false,\r\nfalse, &gobj);\r\nif (r) {\r\nreturn r;\r\n}\r\nr = drm_gem_handle_create(filp, gobj, &handle);\r\ndrm_gem_object_unreference_unlocked(gobj);\r\nif (r) {\r\nreturn r;\r\n}\r\nargs->handle = handle;\r\nreturn 0;\r\n}\r\nint radeon_gem_set_domain_ioctl(struct drm_device *dev, void *data,\r\nstruct drm_file *filp)\r\n{\r\nstruct drm_radeon_gem_set_domain *args = data;\r\nstruct drm_gem_object *gobj;\r\nstruct radeon_bo *robj;\r\nint r;\r\ngobj = drm_gem_object_lookup(dev, filp, args->handle);\r\nif (gobj == NULL) {\r\nreturn -ENOENT;\r\n}\r\nrobj = gem_to_radeon_bo(gobj);\r\nr = radeon_gem_set_domain(gobj, args->read_domains, args->write_domain);\r\ndrm_gem_object_unreference_unlocked(gobj);\r\nreturn r;\r\n}\r\nint radeon_mode_dumb_mmap(struct drm_file *filp,\r\nstruct drm_device *dev,\r\nuint32_t handle, uint64_t *offset_p)\r\n{\r\nstruct drm_gem_object *gobj;\r\nstruct radeon_bo *robj;\r\ngobj = drm_gem_object_lookup(dev, filp, handle);\r\nif (gobj == NULL) {\r\nreturn -ENOENT;\r\n}\r\nrobj = gem_to_radeon_bo(gobj);\r\n*offset_p = radeon_bo_mmap_offset(robj);\r\ndrm_gem_object_unreference_unlocked(gobj);\r\nreturn 0;\r\n}\r\nint radeon_gem_mmap_ioctl(struct drm_device *dev, void *data,\r\nstruct drm_file *filp)\r\n{\r\nstruct drm_radeon_gem_mmap *args = data;\r\nreturn radeon_mode_dumb_mmap(filp, dev, args->handle, &args->addr_ptr);\r\n}\r\nint radeon_gem_busy_ioctl(struct drm_device *dev, void *data,\r\nstruct drm_file *filp)\r\n{\r\nstruct drm_radeon_gem_busy *args = data;\r\nstruct drm_gem_object *gobj;\r\nstruct radeon_bo *robj;\r\nint r;\r\nuint32_t cur_placement = 0;\r\ngobj = drm_gem_object_lookup(dev, filp, args->handle);\r\nif (gobj == NULL) {\r\nreturn -ENOENT;\r\n}\r\nrobj = gem_to_radeon_bo(gobj);\r\nr = radeon_bo_wait(robj, &cur_placement, true);\r\nswitch (cur_placement) {\r\ncase TTM_PL_VRAM:\r\nargs->domain = RADEON_GEM_DOMAIN_VRAM;\r\nbreak;\r\ncase TTM_PL_TT:\r\nargs->domain = RADEON_GEM_DOMAIN_GTT;\r\nbreak;\r\ncase TTM_PL_SYSTEM:\r\nargs->domain = RADEON_GEM_DOMAIN_CPU;\r\ndefault:\r\nbreak;\r\n}\r\ndrm_gem_object_unreference_unlocked(gobj);\r\nreturn r;\r\n}\r\nint radeon_gem_wait_idle_ioctl(struct drm_device *dev, void *data,\r\nstruct drm_file *filp)\r\n{\r\nstruct drm_radeon_gem_wait_idle *args = data;\r\nstruct drm_gem_object *gobj;\r\nstruct radeon_bo *robj;\r\nint r;\r\ngobj = drm_gem_object_lookup(dev, filp, args->handle);\r\nif (gobj == NULL) {\r\nreturn -ENOENT;\r\n}\r\nrobj = gem_to_radeon_bo(gobj);\r\nr = radeon_bo_wait(robj, NULL, false);\r\nif (robj->rdev->asic->ioctl_wait_idle)\r\nrobj->rdev->asic->ioctl_wait_idle(robj->rdev, robj);\r\ndrm_gem_object_unreference_unlocked(gobj);\r\nreturn r;\r\n}\r\nint radeon_gem_set_tiling_ioctl(struct drm_device *dev, void *data,\r\nstruct drm_file *filp)\r\n{\r\nstruct drm_radeon_gem_set_tiling *args = data;\r\nstruct drm_gem_object *gobj;\r\nstruct radeon_bo *robj;\r\nint r = 0;\r\nDRM_DEBUG("%d \n", args->handle);\r\ngobj = drm_gem_object_lookup(dev, filp, args->handle);\r\nif (gobj == NULL)\r\nreturn -ENOENT;\r\nrobj = gem_to_radeon_bo(gobj);\r\nr = radeon_bo_set_tiling_flags(robj, args->tiling_flags, args->pitch);\r\ndrm_gem_object_unreference_unlocked(gobj);\r\nreturn r;\r\n}\r\nint radeon_gem_get_tiling_ioctl(struct drm_device *dev, void *data,\r\nstruct drm_file *filp)\r\n{\r\nstruct drm_radeon_gem_get_tiling *args = data;\r\nstruct drm_gem_object *gobj;\r\nstruct radeon_bo *rbo;\r\nint r = 0;\r\nDRM_DEBUG("\n");\r\ngobj = drm_gem_object_lookup(dev, filp, args->handle);\r\nif (gobj == NULL)\r\nreturn -ENOENT;\r\nrbo = gem_to_radeon_bo(gobj);\r\nr = radeon_bo_reserve(rbo, false);\r\nif (unlikely(r != 0))\r\ngoto out;\r\nradeon_bo_get_tiling_flags(rbo, &args->tiling_flags, &args->pitch);\r\nradeon_bo_unreserve(rbo);\r\nout:\r\ndrm_gem_object_unreference_unlocked(gobj);\r\nreturn r;\r\n}\r\nint radeon_mode_dumb_create(struct drm_file *file_priv,\r\nstruct drm_device *dev,\r\nstruct drm_mode_create_dumb *args)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct drm_gem_object *gobj;\r\nuint32_t handle;\r\nint r;\r\nargs->pitch = radeon_align_pitch(rdev, args->width, args->bpp, 0) * ((args->bpp + 1) / 8);\r\nargs->size = args->pitch * args->height;\r\nargs->size = ALIGN(args->size, PAGE_SIZE);\r\nr = radeon_gem_object_create(rdev, args->size, 0,\r\nRADEON_GEM_DOMAIN_VRAM,\r\nfalse, ttm_bo_type_device,\r\n&gobj);\r\nif (r)\r\nreturn -ENOMEM;\r\nr = drm_gem_handle_create(file_priv, gobj, &handle);\r\ndrm_gem_object_unreference_unlocked(gobj);\r\nif (r) {\r\nreturn r;\r\n}\r\nargs->handle = handle;\r\nreturn 0;\r\n}\r\nint radeon_mode_dumb_destroy(struct drm_file *file_priv,\r\nstruct drm_device *dev,\r\nuint32_t handle)\r\n{\r\nreturn drm_gem_handle_delete(file_priv, handle);\r\n}

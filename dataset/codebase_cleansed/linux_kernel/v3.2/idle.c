static int __init nohlt_setup(char *__unused)\r\n{\r\nhlt_counter = 1;\r\nreturn 1;\r\n}\r\nstatic int __init hlt_setup(char *__unused)\r\n{\r\nhlt_counter = 0;\r\nreturn 1;\r\n}\r\nstatic inline int hlt_works(void)\r\n{\r\nreturn !hlt_counter;\r\n}\r\nstatic void poll_idle(void)\r\n{\r\nlocal_irq_enable();\r\nwhile (!need_resched())\r\ncpu_relax();\r\n}\r\nvoid default_idle(void)\r\n{\r\nif (hlt_works()) {\r\nclear_thread_flag(TIF_POLLING_NRFLAG);\r\nsmp_mb__after_clear_bit();\r\nset_bl_bit();\r\nif (!need_resched()) {\r\nlocal_irq_enable();\r\ncpu_sleep();\r\n} else\r\nlocal_irq_enable();\r\nset_thread_flag(TIF_POLLING_NRFLAG);\r\nclear_bl_bit();\r\n} else\r\npoll_idle();\r\n}\r\nvoid cpu_idle(void)\r\n{\r\nunsigned int cpu = smp_processor_id();\r\nset_thread_flag(TIF_POLLING_NRFLAG);\r\nwhile (1) {\r\ntick_nohz_stop_sched_tick(1);\r\nwhile (!need_resched()) {\r\ncheck_pgt_cache();\r\nrmb();\r\nif (cpu_is_offline(cpu))\r\nplay_dead();\r\nlocal_irq_disable();\r\nstop_critical_timings();\r\nif (cpuidle_idle_call())\r\npm_idle();\r\nWARN_ON(irqs_disabled());\r\nstart_critical_timings();\r\n}\r\ntick_nohz_restart_sched_tick();\r\npreempt_enable_no_resched();\r\nschedule();\r\npreempt_disable();\r\n}\r\n}\r\nvoid __init select_idle_routine(void)\r\n{\r\nif (pm_idle)\r\nreturn;\r\nif (hlt_works())\r\npm_idle = default_idle;\r\nelse\r\npm_idle = poll_idle;\r\n}\r\nstatic void do_nothing(void *unused)\r\n{\r\n}\r\nvoid stop_this_cpu(void *unused)\r\n{\r\nlocal_irq_disable();\r\nset_cpu_online(smp_processor_id(), false);\r\nfor (;;)\r\ncpu_sleep();\r\n}\r\nvoid cpu_idle_wait(void)\r\n{\r\nsmp_mb();\r\nsmp_call_function(do_nothing, NULL, 1);\r\n}

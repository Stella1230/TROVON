static int adx_backlight_update_status(struct backlight_device *bldev)\r\n{\r\nstruct adxbl *bl = bl_get_data(bldev);\r\nu32 value;\r\nvalue = bldev->props.brightness;\r\nwritel(value, bl->base + ADX_BACKLIGHT_BRIGHTNESS);\r\nvalue = readl(bl->base + ADX_BACKLIGHT_CONTROL);\r\nif (bldev->props.state & BL_CORE_FBBLANK)\r\nvalue &= ~ADX_BACKLIGHT_CONTROL_ENABLE;\r\nelse\r\nvalue |= ADX_BACKLIGHT_CONTROL_ENABLE;\r\nwritel(value, bl->base + ADX_BACKLIGHT_CONTROL);\r\nreturn 0;\r\n}\r\nstatic int adx_backlight_get_brightness(struct backlight_device *bldev)\r\n{\r\nstruct adxbl *bl = bl_get_data(bldev);\r\nu32 brightness;\r\nbrightness = readl(bl->base + ADX_BACKLIGHT_BRIGHTNESS);\r\nreturn brightness & 0xff;\r\n}\r\nstatic int adx_backlight_check_fb(struct backlight_device *bldev, struct fb_info *fb)\r\n{\r\nreturn 1;\r\n}\r\nstatic int __devinit adx_backlight_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_properties props;\r\nstruct backlight_device *bldev;\r\nstruct resource *res;\r\nstruct adxbl *bl;\r\nint ret = 0;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\nret = -ENXIO;\r\ngoto out;\r\n}\r\nres = devm_request_mem_region(&pdev->dev, res->start,\r\nresource_size(res), res->name);\r\nif (!res) {\r\nret = -ENXIO;\r\ngoto out;\r\n}\r\nbl = devm_kzalloc(&pdev->dev, sizeof(*bl), GFP_KERNEL);\r\nif (!bl) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nbl->base = devm_ioremap_nocache(&pdev->dev, res->start,\r\nresource_size(res));\r\nif (!bl->base) {\r\nret = -ENXIO;\r\ngoto out;\r\n}\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = 0xff;\r\nbldev = backlight_device_register(dev_name(&pdev->dev), &pdev->dev,\r\nbl, &adx_backlight_ops, &props);\r\nif (IS_ERR(bldev)) {\r\nret = PTR_ERR(bldev);\r\ngoto out;\r\n}\r\nbldev->props.brightness = 0xff;\r\nbldev->props.power = FB_BLANK_UNBLANK;\r\nplatform_set_drvdata(pdev, bldev);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int __devexit adx_backlight_remove(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bldev;\r\nint ret = 0;\r\nbldev = platform_get_drvdata(pdev);\r\nbldev->props.power = FB_BLANK_UNBLANK;\r\nbldev->props.brightness = 0xff;\r\nbacklight_update_status(bldev);\r\nbacklight_device_unregister(bldev);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn ret;\r\n}\r\nstatic int adx_backlight_suspend(struct platform_device *pdev,\r\npm_message_t state)\r\n{\r\nreturn 0;\r\n}\r\nstatic int adx_backlight_resume(struct platform_device *pdev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __init adx_backlight_init(void)\r\n{\r\nreturn platform_driver_register(&adx_backlight_driver);\r\n}\r\nstatic void __exit adx_backlight_exit(void)\r\n{\r\nplatform_driver_unregister(&adx_backlight_driver);\r\n}

static void dac124s085_led_work(struct work_struct *work)\r\n{\r\nstruct dac124s085_led *led = container_of(work, struct dac124s085_led,\r\nwork);\r\nu16 word;\r\nmutex_lock(&led->mutex);\r\nword = cpu_to_le16(((led->id) << 14) | REG_WRITE_UPDATE |\r\n(led->brightness & 0xfff));\r\nspi_write(led->spi, (const u8 *)&word, sizeof(word));\r\nmutex_unlock(&led->mutex);\r\n}\r\nstatic void dac124s085_set_brightness(struct led_classdev *ldev,\r\nenum led_brightness brightness)\r\n{\r\nstruct dac124s085_led *led = container_of(ldev, struct dac124s085_led,\r\nldev);\r\nspin_lock(&led->lock);\r\nled->brightness = brightness;\r\nschedule_work(&led->work);\r\nspin_unlock(&led->lock);\r\n}\r\nstatic int dac124s085_probe(struct spi_device *spi)\r\n{\r\nstruct dac124s085 *dac;\r\nstruct dac124s085_led *led;\r\nint i, ret;\r\ndac = kzalloc(sizeof(*dac), GFP_KERNEL);\r\nif (!dac)\r\nreturn -ENOMEM;\r\nspi->bits_per_word = 16;\r\nfor (i = 0; i < ARRAY_SIZE(dac->leds); i++) {\r\nled = dac->leds + i;\r\nled->id = i;\r\nled->brightness = LED_OFF;\r\nled->spi = spi;\r\nsnprintf(led->name, sizeof(led->name), "dac124s085-%d", i);\r\nspin_lock_init(&led->lock);\r\nINIT_WORK(&led->work, dac124s085_led_work);\r\nmutex_init(&led->mutex);\r\nled->ldev.name = led->name;\r\nled->ldev.brightness = LED_OFF;\r\nled->ldev.max_brightness = 0xfff;\r\nled->ldev.brightness_set = dac124s085_set_brightness;\r\nret = led_classdev_register(&spi->dev, &led->ldev);\r\nif (ret < 0)\r\ngoto eledcr;\r\n}\r\nspi_set_drvdata(spi, dac);\r\nreturn 0;\r\neledcr:\r\nwhile (i--)\r\nled_classdev_unregister(&dac->leds[i].ldev);\r\nspi_set_drvdata(spi, NULL);\r\nkfree(dac);\r\nreturn ret;\r\n}\r\nstatic int dac124s085_remove(struct spi_device *spi)\r\n{\r\nstruct dac124s085 *dac = spi_get_drvdata(spi);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(dac->leds); i++) {\r\nled_classdev_unregister(&dac->leds[i].ldev);\r\ncancel_work_sync(&dac->leds[i].work);\r\n}\r\nspi_set_drvdata(spi, NULL);\r\nkfree(dac);\r\nreturn 0;\r\n}\r\nstatic int __init dac124s085_leds_init(void)\r\n{\r\nreturn spi_register_driver(&dac124s085_driver);\r\n}\r\nstatic void __exit dac124s085_leds_exit(void)\r\n{\r\nspi_unregister_driver(&dac124s085_driver);\r\n}

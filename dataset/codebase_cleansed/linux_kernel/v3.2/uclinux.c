static int uclinux_point(struct mtd_info *mtd, loff_t from, size_t len,\r\nsize_t *retlen, void **virt, resource_size_t *phys)\r\n{\r\nstruct map_info *map = mtd->priv;\r\n*virt = map->virt + from;\r\nif (phys)\r\n*phys = map->phys + from;\r\n*retlen = len;\r\nreturn(0);\r\n}\r\nstatic int __init uclinux_mtd_init(void)\r\n{\r\nstruct mtd_info *mtd;\r\nstruct map_info *mapp;\r\nmapp = &uclinux_ram_map;\r\nif (!mapp->size)\r\nmapp->size = PAGE_ALIGN(ntohl(*((unsigned long *)(mapp->phys + 8))));\r\nmapp->bankwidth = 4;\r\nprintk("uclinux[mtd]: RAM probe address=0x%x size=0x%x\n",\r\n(int) mapp->phys, (int) mapp->size);\r\nmapp->virt = ioremap_nocache(mapp->phys, mapp->size);\r\nif (mapp->virt == 0) {\r\nprintk("uclinux[mtd]: ioremap_nocache() failed\n");\r\nreturn(-EIO);\r\n}\r\nsimple_map_init(mapp);\r\nmtd = do_map_probe("map_ram", mapp);\r\nif (!mtd) {\r\nprintk("uclinux[mtd]: failed to find a mapping?\n");\r\niounmap(mapp->virt);\r\nreturn(-ENXIO);\r\n}\r\nmtd->owner = THIS_MODULE;\r\nmtd->point = uclinux_point;\r\nmtd->priv = mapp;\r\nuclinux_ram_mtdinfo = mtd;\r\nmtd_device_register(mtd, uclinux_romfs, NUM_PARTITIONS);\r\nreturn(0);\r\n}\r\nstatic void __exit uclinux_mtd_cleanup(void)\r\n{\r\nif (uclinux_ram_mtdinfo) {\r\nmtd_device_unregister(uclinux_ram_mtdinfo);\r\nmap_destroy(uclinux_ram_mtdinfo);\r\nuclinux_ram_mtdinfo = NULL;\r\n}\r\nif (uclinux_ram_map.virt) {\r\niounmap((void *) uclinux_ram_map.virt);\r\nuclinux_ram_map.virt = 0;\r\n}\r\n}

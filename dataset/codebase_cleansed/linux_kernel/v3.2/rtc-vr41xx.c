static inline unsigned long read_elapsed_second(void)\r\n{\r\nunsigned long first_low, first_mid, first_high;\r\nunsigned long second_low, second_mid, second_high;\r\ndo {\r\nfirst_low = rtc1_read(ETIMELREG);\r\nfirst_mid = rtc1_read(ETIMEMREG);\r\nfirst_high = rtc1_read(ETIMEHREG);\r\nsecond_low = rtc1_read(ETIMELREG);\r\nsecond_mid = rtc1_read(ETIMEMREG);\r\nsecond_high = rtc1_read(ETIMEHREG);\r\n} while (first_low != second_low || first_mid != second_mid ||\r\nfirst_high != second_high);\r\nreturn (first_high << 17) | (first_mid << 1) | (first_low >> 15);\r\n}\r\nstatic inline void write_elapsed_second(unsigned long sec)\r\n{\r\nspin_lock_irq(&rtc_lock);\r\nrtc1_write(ETIMELREG, (uint16_t)(sec << 15));\r\nrtc1_write(ETIMEMREG, (uint16_t)(sec >> 1));\r\nrtc1_write(ETIMEHREG, (uint16_t)(sec >> 17));\r\nspin_unlock_irq(&rtc_lock);\r\n}\r\nstatic void vr41xx_rtc_release(struct device *dev)\r\n{\r\nspin_lock_irq(&rtc_lock);\r\nrtc1_write(ECMPLREG, 0);\r\nrtc1_write(ECMPMREG, 0);\r\nrtc1_write(ECMPHREG, 0);\r\nrtc1_write(RTCL1LREG, 0);\r\nrtc1_write(RTCL1HREG, 0);\r\nspin_unlock_irq(&rtc_lock);\r\ndisable_irq(aie_irq);\r\ndisable_irq(pie_irq);\r\n}\r\nstatic int vr41xx_rtc_read_time(struct device *dev, struct rtc_time *time)\r\n{\r\nunsigned long epoch_sec, elapsed_sec;\r\nepoch_sec = mktime(epoch, 1, 1, 0, 0, 0);\r\nelapsed_sec = read_elapsed_second();\r\nrtc_time_to_tm(epoch_sec + elapsed_sec, time);\r\nreturn 0;\r\n}\r\nstatic int vr41xx_rtc_set_time(struct device *dev, struct rtc_time *time)\r\n{\r\nunsigned long epoch_sec, current_sec;\r\nepoch_sec = mktime(epoch, 1, 1, 0, 0, 0);\r\ncurrent_sec = mktime(time->tm_year + 1900, time->tm_mon + 1, time->tm_mday,\r\ntime->tm_hour, time->tm_min, time->tm_sec);\r\nwrite_elapsed_second(current_sec - epoch_sec);\r\nreturn 0;\r\n}\r\nstatic int vr41xx_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *wkalrm)\r\n{\r\nunsigned long low, mid, high;\r\nstruct rtc_time *time = &wkalrm->time;\r\nspin_lock_irq(&rtc_lock);\r\nlow = rtc1_read(ECMPLREG);\r\nmid = rtc1_read(ECMPMREG);\r\nhigh = rtc1_read(ECMPHREG);\r\nwkalrm->enabled = alarm_enabled;\r\nspin_unlock_irq(&rtc_lock);\r\nrtc_time_to_tm((high << 17) | (mid << 1) | (low >> 15), time);\r\nreturn 0;\r\n}\r\nstatic int vr41xx_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *wkalrm)\r\n{\r\nunsigned long alarm_sec;\r\nstruct rtc_time *time = &wkalrm->time;\r\nalarm_sec = mktime(time->tm_year + 1900, time->tm_mon + 1, time->tm_mday,\r\ntime->tm_hour, time->tm_min, time->tm_sec);\r\nspin_lock_irq(&rtc_lock);\r\nif (alarm_enabled)\r\ndisable_irq(aie_irq);\r\nrtc1_write(ECMPLREG, (uint16_t)(alarm_sec << 15));\r\nrtc1_write(ECMPMREG, (uint16_t)(alarm_sec >> 1));\r\nrtc1_write(ECMPHREG, (uint16_t)(alarm_sec >> 17));\r\nif (wkalrm->enabled)\r\nenable_irq(aie_irq);\r\nalarm_enabled = wkalrm->enabled;\r\nspin_unlock_irq(&rtc_lock);\r\nreturn 0;\r\n}\r\nstatic int vr41xx_rtc_ioctl(struct device *dev, unsigned int cmd, unsigned long arg)\r\n{\r\nswitch (cmd) {\r\ncase RTC_EPOCH_READ:\r\nreturn put_user(epoch, (unsigned long __user *)arg);\r\ncase RTC_EPOCH_SET:\r\nif (arg < 1900)\r\nreturn -EINVAL;\r\nepoch = arg;\r\nbreak;\r\ndefault:\r\nreturn -ENOIOCTLCMD;\r\n}\r\nreturn 0;\r\n}\r\nstatic int vr41xx_rtc_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nspin_lock_irq(&rtc_lock);\r\nif (enabled) {\r\nif (!alarm_enabled) {\r\nenable_irq(aie_irq);\r\nalarm_enabled = 1;\r\n}\r\n} else {\r\nif (alarm_enabled) {\r\ndisable_irq(aie_irq);\r\nalarm_enabled = 0;\r\n}\r\n}\r\nspin_unlock_irq(&rtc_lock);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t elapsedtime_interrupt(int irq, void *dev_id)\r\n{\r\nstruct platform_device *pdev = (struct platform_device *)dev_id;\r\nstruct rtc_device *rtc = platform_get_drvdata(pdev);\r\nrtc2_write(RTCINTREG, ELAPSEDTIME_INT);\r\nrtc_update_irq(rtc, 1, RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t rtclong1_interrupt(int irq, void *dev_id)\r\n{\r\nstruct platform_device *pdev = (struct platform_device *)dev_id;\r\nstruct rtc_device *rtc = platform_get_drvdata(pdev);\r\nunsigned long count = periodic_count;\r\nrtc2_write(RTCINTREG, RTCLONG1_INT);\r\nrtc1_write(RTCL1LREG, count);\r\nrtc1_write(RTCL1HREG, count >> 16);\r\nrtc_update_irq(rtc, 1, RTC_PF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __devinit rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct rtc_device *rtc;\r\nint retval;\r\nif (pdev->num_resources != 4)\r\nreturn -EBUSY;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -EBUSY;\r\nrtc1_base = ioremap(res->start, resource_size(res));\r\nif (!rtc1_base)\r\nreturn -EBUSY;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nif (!res) {\r\nretval = -EBUSY;\r\ngoto err_rtc1_iounmap;\r\n}\r\nrtc2_base = ioremap(res->start, resource_size(res));\r\nif (!rtc2_base) {\r\nretval = -EBUSY;\r\ngoto err_rtc1_iounmap;\r\n}\r\nrtc = rtc_device_register(rtc_name, &pdev->dev, &vr41xx_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc)) {\r\nretval = PTR_ERR(rtc);\r\ngoto err_iounmap_all;\r\n}\r\nrtc->max_user_freq = MAX_PERIODIC_RATE;\r\nspin_lock_irq(&rtc_lock);\r\nrtc1_write(ECMPLREG, 0);\r\nrtc1_write(ECMPMREG, 0);\r\nrtc1_write(ECMPHREG, 0);\r\nrtc1_write(RTCL1LREG, 0);\r\nrtc1_write(RTCL1HREG, 0);\r\nspin_unlock_irq(&rtc_lock);\r\naie_irq = platform_get_irq(pdev, 0);\r\nif (aie_irq <= 0) {\r\nretval = -EBUSY;\r\ngoto err_device_unregister;\r\n}\r\nretval = request_irq(aie_irq, elapsedtime_interrupt, IRQF_DISABLED,\r\n"elapsed_time", pdev);\r\nif (retval < 0)\r\ngoto err_device_unregister;\r\npie_irq = platform_get_irq(pdev, 1);\r\nif (pie_irq <= 0)\r\ngoto err_free_irq;\r\nretval = request_irq(pie_irq, rtclong1_interrupt, IRQF_DISABLED,\r\n"rtclong1", pdev);\r\nif (retval < 0)\r\ngoto err_free_irq;\r\nplatform_set_drvdata(pdev, rtc);\r\ndisable_irq(aie_irq);\r\ndisable_irq(pie_irq);\r\nprintk(KERN_INFO "rtc: Real Time Clock of NEC VR4100 series\n");\r\nreturn 0;\r\nerr_free_irq:\r\nfree_irq(aie_irq, pdev);\r\nerr_device_unregister:\r\nrtc_device_unregister(rtc);\r\nerr_iounmap_all:\r\niounmap(rtc2_base);\r\nrtc2_base = NULL;\r\nerr_rtc1_iounmap:\r\niounmap(rtc1_base);\r\nrtc1_base = NULL;\r\nreturn retval;\r\n}\r\nstatic int __devexit rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc;\r\nrtc = platform_get_drvdata(pdev);\r\nif (rtc)\r\nrtc_device_unregister(rtc);\r\nplatform_set_drvdata(pdev, NULL);\r\nfree_irq(aie_irq, pdev);\r\nfree_irq(pie_irq, pdev);\r\nif (rtc1_base)\r\niounmap(rtc1_base);\r\nif (rtc2_base)\r\niounmap(rtc2_base);\r\nreturn 0;\r\n}\r\nstatic int __init vr41xx_rtc_init(void)\r\n{\r\nreturn platform_driver_register(&rtc_platform_driver);\r\n}\r\nstatic void __exit vr41xx_rtc_exit(void)\r\n{\r\nplatform_driver_unregister(&rtc_platform_driver);\r\n}

static u32 mii_get_an(struct mii_if_info *mii, u16 addr)\r\n{\r\nu32 result = 0;\r\nint advert;\r\nadvert = mii->mdio_read(mii->dev, mii->phy_id, addr);\r\nif (advert & LPA_LPACK)\r\nresult |= ADVERTISED_Autoneg;\r\nif (advert & ADVERTISE_10HALF)\r\nresult |= ADVERTISED_10baseT_Half;\r\nif (advert & ADVERTISE_10FULL)\r\nresult |= ADVERTISED_10baseT_Full;\r\nif (advert & ADVERTISE_100HALF)\r\nresult |= ADVERTISED_100baseT_Half;\r\nif (advert & ADVERTISE_100FULL)\r\nresult |= ADVERTISED_100baseT_Full;\r\nif (advert & ADVERTISE_PAUSE_CAP)\r\nresult |= ADVERTISED_Pause;\r\nif (advert & ADVERTISE_PAUSE_ASYM)\r\nresult |= ADVERTISED_Asym_Pause;\r\nreturn result;\r\n}\r\nint mii_ethtool_gset(struct mii_if_info *mii, struct ethtool_cmd *ecmd)\r\n{\r\nstruct net_device *dev = mii->dev;\r\nu16 bmcr, bmsr, ctrl1000 = 0, stat1000 = 0;\r\nu32 nego;\r\necmd->supported =\r\n(SUPPORTED_10baseT_Half | SUPPORTED_10baseT_Full |\r\nSUPPORTED_100baseT_Half | SUPPORTED_100baseT_Full |\r\nSUPPORTED_Autoneg | SUPPORTED_TP | SUPPORTED_MII);\r\nif (mii->supports_gmii)\r\necmd->supported |= SUPPORTED_1000baseT_Half |\r\nSUPPORTED_1000baseT_Full;\r\necmd->port = PORT_MII;\r\necmd->transceiver = XCVR_INTERNAL;\r\necmd->phy_address = mii->phy_id;\r\necmd->mdio_support = MDIO_SUPPORTS_C22;\r\necmd->advertising = ADVERTISED_TP | ADVERTISED_MII;\r\nbmcr = mii->mdio_read(dev, mii->phy_id, MII_BMCR);\r\nbmsr = mii->mdio_read(dev, mii->phy_id, MII_BMSR);\r\nif (mii->supports_gmii) {\r\nctrl1000 = mii->mdio_read(dev, mii->phy_id, MII_CTRL1000);\r\nstat1000 = mii->mdio_read(dev, mii->phy_id, MII_STAT1000);\r\n}\r\nif (bmcr & BMCR_ANENABLE) {\r\necmd->advertising |= ADVERTISED_Autoneg;\r\necmd->autoneg = AUTONEG_ENABLE;\r\necmd->advertising |= mii_get_an(mii, MII_ADVERTISE);\r\nif (ctrl1000 & ADVERTISE_1000HALF)\r\necmd->advertising |= ADVERTISED_1000baseT_Half;\r\nif (ctrl1000 & ADVERTISE_1000FULL)\r\necmd->advertising |= ADVERTISED_1000baseT_Full;\r\nif (bmsr & BMSR_ANEGCOMPLETE) {\r\necmd->lp_advertising = mii_get_an(mii, MII_LPA);\r\nif (stat1000 & LPA_1000HALF)\r\necmd->lp_advertising |=\r\nADVERTISED_1000baseT_Half;\r\nif (stat1000 & LPA_1000FULL)\r\necmd->lp_advertising |=\r\nADVERTISED_1000baseT_Full;\r\n} else {\r\necmd->lp_advertising = 0;\r\n}\r\nnego = ecmd->advertising & ecmd->lp_advertising;\r\nif (nego & (ADVERTISED_1000baseT_Full |\r\nADVERTISED_1000baseT_Half)) {\r\nethtool_cmd_speed_set(ecmd, SPEED_1000);\r\necmd->duplex = !!(nego & ADVERTISED_1000baseT_Full);\r\n} else if (nego & (ADVERTISED_100baseT_Full |\r\nADVERTISED_100baseT_Half)) {\r\nethtool_cmd_speed_set(ecmd, SPEED_100);\r\necmd->duplex = !!(nego & ADVERTISED_100baseT_Full);\r\n} else {\r\nethtool_cmd_speed_set(ecmd, SPEED_10);\r\necmd->duplex = !!(nego & ADVERTISED_10baseT_Full);\r\n}\r\n} else {\r\necmd->autoneg = AUTONEG_DISABLE;\r\nethtool_cmd_speed_set(ecmd,\r\n((bmcr & BMCR_SPEED1000 &&\r\n(bmcr & BMCR_SPEED100) == 0) ?\r\nSPEED_1000 :\r\n((bmcr & BMCR_SPEED100) ?\r\nSPEED_100 : SPEED_10)));\r\necmd->duplex = (bmcr & BMCR_FULLDPLX) ? DUPLEX_FULL : DUPLEX_HALF;\r\n}\r\nmii->full_duplex = ecmd->duplex;\r\nreturn 0;\r\n}\r\nint mii_ethtool_sset(struct mii_if_info *mii, struct ethtool_cmd *ecmd)\r\n{\r\nstruct net_device *dev = mii->dev;\r\nu32 speed = ethtool_cmd_speed(ecmd);\r\nif (speed != SPEED_10 &&\r\nspeed != SPEED_100 &&\r\nspeed != SPEED_1000)\r\nreturn -EINVAL;\r\nif (ecmd->duplex != DUPLEX_HALF && ecmd->duplex != DUPLEX_FULL)\r\nreturn -EINVAL;\r\nif (ecmd->port != PORT_MII)\r\nreturn -EINVAL;\r\nif (ecmd->transceiver != XCVR_INTERNAL)\r\nreturn -EINVAL;\r\nif (ecmd->phy_address != mii->phy_id)\r\nreturn -EINVAL;\r\nif (ecmd->autoneg != AUTONEG_DISABLE && ecmd->autoneg != AUTONEG_ENABLE)\r\nreturn -EINVAL;\r\nif ((speed == SPEED_1000) && (!mii->supports_gmii))\r\nreturn -EINVAL;\r\nif (ecmd->autoneg == AUTONEG_ENABLE) {\r\nu32 bmcr, advert, tmp;\r\nu32 advert2 = 0, tmp2 = 0;\r\nif ((ecmd->advertising & (ADVERTISED_10baseT_Half |\r\nADVERTISED_10baseT_Full |\r\nADVERTISED_100baseT_Half |\r\nADVERTISED_100baseT_Full |\r\nADVERTISED_1000baseT_Half |\r\nADVERTISED_1000baseT_Full)) == 0)\r\nreturn -EINVAL;\r\nadvert = mii->mdio_read(dev, mii->phy_id, MII_ADVERTISE);\r\ntmp = advert & ~(ADVERTISE_ALL | ADVERTISE_100BASE4);\r\nif (mii->supports_gmii) {\r\nadvert2 = mii->mdio_read(dev, mii->phy_id, MII_CTRL1000);\r\ntmp2 = advert2 & ~(ADVERTISE_1000HALF | ADVERTISE_1000FULL);\r\n}\r\nif (ecmd->advertising & ADVERTISED_10baseT_Half)\r\ntmp |= ADVERTISE_10HALF;\r\nif (ecmd->advertising & ADVERTISED_10baseT_Full)\r\ntmp |= ADVERTISE_10FULL;\r\nif (ecmd->advertising & ADVERTISED_100baseT_Half)\r\ntmp |= ADVERTISE_100HALF;\r\nif (ecmd->advertising & ADVERTISED_100baseT_Full)\r\ntmp |= ADVERTISE_100FULL;\r\nif (mii->supports_gmii) {\r\nif (ecmd->advertising & ADVERTISED_1000baseT_Half)\r\ntmp2 |= ADVERTISE_1000HALF;\r\nif (ecmd->advertising & ADVERTISED_1000baseT_Full)\r\ntmp2 |= ADVERTISE_1000FULL;\r\n}\r\nif (advert != tmp) {\r\nmii->mdio_write(dev, mii->phy_id, MII_ADVERTISE, tmp);\r\nmii->advertising = tmp;\r\n}\r\nif ((mii->supports_gmii) && (advert2 != tmp2))\r\nmii->mdio_write(dev, mii->phy_id, MII_CTRL1000, tmp2);\r\nbmcr = mii->mdio_read(dev, mii->phy_id, MII_BMCR);\r\nbmcr |= (BMCR_ANENABLE | BMCR_ANRESTART);\r\nmii->mdio_write(dev, mii->phy_id, MII_BMCR, bmcr);\r\nmii->force_media = 0;\r\n} else {\r\nu32 bmcr, tmp;\r\nbmcr = mii->mdio_read(dev, mii->phy_id, MII_BMCR);\r\ntmp = bmcr & ~(BMCR_ANENABLE | BMCR_SPEED100 |\r\nBMCR_SPEED1000 | BMCR_FULLDPLX);\r\nif (speed == SPEED_1000)\r\ntmp |= BMCR_SPEED1000;\r\nelse if (speed == SPEED_100)\r\ntmp |= BMCR_SPEED100;\r\nif (ecmd->duplex == DUPLEX_FULL) {\r\ntmp |= BMCR_FULLDPLX;\r\nmii->full_duplex = 1;\r\n} else\r\nmii->full_duplex = 0;\r\nif (bmcr != tmp)\r\nmii->mdio_write(dev, mii->phy_id, MII_BMCR, tmp);\r\nmii->force_media = 1;\r\n}\r\nreturn 0;\r\n}\r\nint mii_check_gmii_support(struct mii_if_info *mii)\r\n{\r\nint reg;\r\nreg = mii->mdio_read(mii->dev, mii->phy_id, MII_BMSR);\r\nif (reg & BMSR_ESTATEN) {\r\nreg = mii->mdio_read(mii->dev, mii->phy_id, MII_ESTATUS);\r\nif (reg & (ESTATUS_1000_TFULL | ESTATUS_1000_THALF))\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nint mii_link_ok (struct mii_if_info *mii)\r\n{\r\nmii->mdio_read(mii->dev, mii->phy_id, MII_BMSR);\r\nif (mii->mdio_read(mii->dev, mii->phy_id, MII_BMSR) & BMSR_LSTATUS)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nint mii_nway_restart (struct mii_if_info *mii)\r\n{\r\nint bmcr;\r\nint r = -EINVAL;\r\nbmcr = mii->mdio_read(mii->dev, mii->phy_id, MII_BMCR);\r\nif (bmcr & BMCR_ANENABLE) {\r\nbmcr |= BMCR_ANRESTART;\r\nmii->mdio_write(mii->dev, mii->phy_id, MII_BMCR, bmcr);\r\nr = 0;\r\n}\r\nreturn r;\r\n}\r\nvoid mii_check_link (struct mii_if_info *mii)\r\n{\r\nint cur_link = mii_link_ok(mii);\r\nint prev_link = netif_carrier_ok(mii->dev);\r\nif (cur_link && !prev_link)\r\nnetif_carrier_on(mii->dev);\r\nelse if (prev_link && !cur_link)\r\nnetif_carrier_off(mii->dev);\r\n}\r\nunsigned int mii_check_media (struct mii_if_info *mii,\r\nunsigned int ok_to_print,\r\nunsigned int init_media)\r\n{\r\nunsigned int old_carrier, new_carrier;\r\nint advertise, lpa, media, duplex;\r\nint lpa2 = 0;\r\nif (mii->force_media)\r\nreturn 0;\r\nold_carrier = netif_carrier_ok(mii->dev) ? 1 : 0;\r\nnew_carrier = (unsigned int) mii_link_ok(mii);\r\nif ((!init_media) && (old_carrier == new_carrier))\r\nreturn 0;\r\nif (!new_carrier) {\r\nnetif_carrier_off(mii->dev);\r\nif (ok_to_print)\r\nnetdev_info(mii->dev, "link down\n");\r\nreturn 0;\r\n}\r\nnetif_carrier_on(mii->dev);\r\nif ((!init_media) && (mii->advertising))\r\nadvertise = mii->advertising;\r\nelse {\r\nadvertise = mii->mdio_read(mii->dev, mii->phy_id, MII_ADVERTISE);\r\nmii->advertising = advertise;\r\n}\r\nlpa = mii->mdio_read(mii->dev, mii->phy_id, MII_LPA);\r\nif (mii->supports_gmii)\r\nlpa2 = mii->mdio_read(mii->dev, mii->phy_id, MII_STAT1000);\r\nmedia = mii_nway_result(lpa & advertise);\r\nduplex = (media & ADVERTISE_FULL) ? 1 : 0;\r\nif (lpa2 & LPA_1000FULL)\r\nduplex = 1;\r\nif (ok_to_print)\r\nnetdev_info(mii->dev, "link up, %uMbps, %s-duplex, lpa 0x%04X\n",\r\nlpa2 & (LPA_1000FULL | LPA_1000HALF) ? 1000 :\r\nmedia & (ADVERTISE_100FULL | ADVERTISE_100HALF) ?\r\n100 : 10,\r\nduplex ? "full" : "half",\r\nlpa);\r\nif ((init_media) || (mii->full_duplex != duplex)) {\r\nmii->full_duplex = duplex;\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nint generic_mii_ioctl(struct mii_if_info *mii_if,\r\nstruct mii_ioctl_data *mii_data, int cmd,\r\nunsigned int *duplex_chg_out)\r\n{\r\nint rc = 0;\r\nunsigned int duplex_changed = 0;\r\nif (duplex_chg_out)\r\n*duplex_chg_out = 0;\r\nmii_data->phy_id &= mii_if->phy_id_mask;\r\nmii_data->reg_num &= mii_if->reg_num_mask;\r\nswitch(cmd) {\r\ncase SIOCGMIIPHY:\r\nmii_data->phy_id = mii_if->phy_id;\r\ncase SIOCGMIIREG:\r\nmii_data->val_out =\r\nmii_if->mdio_read(mii_if->dev, mii_data->phy_id,\r\nmii_data->reg_num);\r\nbreak;\r\ncase SIOCSMIIREG: {\r\nu16 val = mii_data->val_in;\r\nif (mii_data->phy_id == mii_if->phy_id) {\r\nswitch(mii_data->reg_num) {\r\ncase MII_BMCR: {\r\nunsigned int new_duplex = 0;\r\nif (val & (BMCR_RESET|BMCR_ANENABLE))\r\nmii_if->force_media = 0;\r\nelse\r\nmii_if->force_media = 1;\r\nif (mii_if->force_media &&\r\n(val & BMCR_FULLDPLX))\r\nnew_duplex = 1;\r\nif (mii_if->full_duplex != new_duplex) {\r\nduplex_changed = 1;\r\nmii_if->full_duplex = new_duplex;\r\n}\r\nbreak;\r\n}\r\ncase MII_ADVERTISE:\r\nmii_if->advertising = val;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nmii_if->mdio_write(mii_if->dev, mii_data->phy_id,\r\nmii_data->reg_num, val);\r\nbreak;\r\n}\r\ndefault:\r\nrc = -EOPNOTSUPP;\r\nbreak;\r\n}\r\nif ((rc == 0) && (duplex_chg_out) && (duplex_changed))\r\n*duplex_chg_out = 1;\r\nreturn rc;\r\n}

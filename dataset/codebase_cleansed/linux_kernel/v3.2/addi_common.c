void fpu_begin(void)\r\n{\r\nkernel_fpu_begin();\r\n}\r\nvoid fpu_end(void)\r\n{\r\nkernel_fpu_end();\r\n}\r\nstatic int __devinit driver_addi_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nreturn comedi_pci_auto_config(dev, driver_addi.driver_name);\r\n}\r\nstatic void __devexit driver_addi_pci_remove(struct pci_dev *dev)\r\n{\r\ncomedi_pci_auto_unconfig(dev);\r\n}\r\nstatic int __init driver_addi_init_module(void)\r\n{\r\nint retval;\r\nretval = comedi_driver_register(&driver_addi);\r\nif (retval < 0)\r\nreturn retval;\r\ndriver_addi_pci_driver.name = (char *)driver_addi.driver_name;\r\nreturn pci_register_driver(&driver_addi_pci_driver);\r\n}\r\nstatic void __exit driver_addi_cleanup_module(void)\r\n{\r\npci_unregister_driver(&driver_addi_pci_driver);\r\ncomedi_driver_unregister(&driver_addi);\r\n}\r\nstatic int i_ADDI_Attach(struct comedi_device *dev, struct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nint ret, pages, i, n_subdevices;\r\nunsigned int dw_Dummy;\r\nresource_size_t io_addr[5];\r\nunsigned int irq;\r\nresource_size_t iobase_a, iobase_main, iobase_addon, iobase_reserved;\r\nstruct pcilst_struct *card = NULL;\r\nunsigned char pci_bus, pci_slot, pci_func;\r\nint i_Dma = 0;\r\nret = alloc_private(dev, sizeof(struct addi_private));\r\nif (ret < 0)\r\nreturn -ENOMEM;\r\nif (!pci_list_builded) {\r\nv_pci_card_list_init(this_board->i_VendorId, 1);\r\npci_list_builded = 1;\r\n}\r\nif ((this_board->i_Dma) && (it->options[2] == 0)) {\r\ni_Dma = 1;\r\n}\r\ncard = ptr_select_and_alloc_pci_card(this_board->i_VendorId,\r\nthis_board->i_DeviceId,\r\nit->options[0],\r\nit->options[1], i_Dma);\r\nif (card == NULL)\r\nreturn -EIO;\r\ndevpriv->allocated = 1;\r\nif ((i_pci_card_data(card, &pci_bus, &pci_slot, &pci_func, &io_addr[0],\r\n&irq)) < 0) {\r\ni_pci_card_free(card);\r\nprintk(" - Can't get AMCC data!\n");\r\nreturn -EIO;\r\n}\r\niobase_a = io_addr[0];\r\niobase_main = io_addr[1];\r\niobase_addon = io_addr[2];\r\niobase_reserved = io_addr[3];\r\nprintk("\nBus %d: Slot %d: Funct%d\nBase0: 0x%8llx\nBase1: 0x%8llx\nBase2: 0x%8llx\nBase3: 0x%8llx\n", pci_bus, pci_slot, pci_func, (unsigned long long)io_addr[0], (unsigned long long)io_addr[1], (unsigned long long)io_addr[2], (unsigned long long)io_addr[3]);\r\nif ((this_board->pc_EepromChip == NULL)\r\n|| (strcmp(this_board->pc_EepromChip, ADDIDATA_9054) != 0)) {\r\nif (this_board->i_IorangeBase1 != 0) {\r\ndev->iobase = (unsigned long)iobase_main;\r\n} else {\r\ndev->iobase = (unsigned long)iobase_a;\r\n}\r\ndev->board_name = this_board->pc_DriverName;\r\ndevpriv->amcc = card;\r\ndevpriv->iobase = (int) dev->iobase;\r\ndevpriv->i_IobaseAmcc = (int) iobase_a;\r\ndevpriv->i_IobaseAddon = (int) iobase_addon;\r\ndevpriv->i_IobaseReserved = (int) iobase_reserved;\r\n} else {\r\ndev->board_name = this_board->pc_DriverName;\r\ndev->iobase = (unsigned long)io_addr[2];\r\ndevpriv->amcc = card;\r\ndevpriv->iobase = (int) io_addr[2];\r\ndevpriv->i_IobaseReserved = (int) io_addr[3];\r\nprintk("\nioremap begin");\r\ndevpriv->dw_AiBase = ioremap(io_addr[3],\r\nthis_board->i_IorangeBase3);\r\nprintk("\nioremap end");\r\n}\r\ndevpriv->s_EeParameters.i_NbrAiChannel = this_board->i_NbrAiChannel;\r\ndevpriv->s_EeParameters.i_NbrAoChannel = this_board->i_NbrAoChannel;\r\ndevpriv->s_EeParameters.i_AiMaxdata = this_board->i_AiMaxdata;\r\ndevpriv->s_EeParameters.i_AoMaxdata = this_board->i_AoMaxdata;\r\ndevpriv->s_EeParameters.i_NbrDiChannel = this_board->i_NbrDiChannel;\r\ndevpriv->s_EeParameters.i_NbrDoChannel = this_board->i_NbrDoChannel;\r\ndevpriv->s_EeParameters.i_DoMaxdata = this_board->i_DoMaxdata;\r\ndevpriv->s_EeParameters.i_Dma = this_board->i_Dma;\r\ndevpriv->s_EeParameters.i_Timer = this_board->i_Timer;\r\ndevpriv->s_EeParameters.ui_MinAcquisitiontimeNs =\r\nthis_board->ui_MinAcquisitiontimeNs;\r\ndevpriv->s_EeParameters.ui_MinDelaytimeNs =\r\nthis_board->ui_MinDelaytimeNs;\r\nif (irq > 0) {\r\nif (request_irq(irq, v_ADDI_Interrupt, IRQF_SHARED,\r\nthis_board->pc_DriverName, dev) < 0) {\r\nprintk(", unable to allocate IRQ %u, DISABLING IT",\r\nirq);\r\nirq = 0;\r\n} else {\r\nprintk("\nirq=%u", irq);\r\n}\r\n} else {\r\nprintk(", IRQ disabled");\r\n}\r\nprintk("\nOption %d %d %d\n", it->options[0], it->options[1],\r\nit->options[2]);\r\ndev->irq = irq;\r\nif (this_board->i_PCIEeprom) {\r\nprintk("\nPCI Eeprom used");\r\nif (!(strcmp(this_board->pc_EepromChip, "S5920"))) {\r\nif (!(strcmp(this_board->pc_DriverName, "apci035"))) {\r\noutl(0x80808082, devpriv->i_IobaseAmcc + 0x60);\r\n} else {\r\noutl(0x83838383, devpriv->i_IobaseAmcc + 0x60);\r\n}\r\ndw_Dummy = inl(devpriv->i_IobaseAmcc + 0x38);\r\noutl(dw_Dummy | 0x2000, devpriv->i_IobaseAmcc + 0x38);\r\nprintk("\nEnable the interrupt for the controller");\r\n}\r\nprintk("\nRead Eeprom");\r\ni_EepromReadMainHeader(io_addr[0], this_board->pc_EepromChip,\r\ndev);\r\n} else {\r\nprintk("\nPCI Eeprom unused");\r\n}\r\nif (it->options[2] > 0) {\r\ndevpriv->us_UseDma = ADDI_DISABLE;\r\n} else {\r\ndevpriv->us_UseDma = ADDI_ENABLE;\r\n}\r\nif (devpriv->s_EeParameters.i_Dma) {\r\nprintk("\nDMA used");\r\nif (devpriv->us_UseDma == ADDI_ENABLE) {\r\ndevpriv->b_DmaDoubleBuffer = 0;\r\nfor (i = 0; i < 2; i++) {\r\nfor (pages = 4; pages >= 0; pages--) {\r\ndevpriv->ul_DmaBufferVirtual[i] =\r\n(void *) __get_free_pages(GFP_KERNEL, pages);\r\nif (devpriv->ul_DmaBufferVirtual[i])\r\nbreak;\r\n}\r\nif (devpriv->ul_DmaBufferVirtual[i]) {\r\ndevpriv->ui_DmaBufferPages[i] = pages;\r\ndevpriv->ui_DmaBufferSize[i] =\r\nPAGE_SIZE * pages;\r\ndevpriv->ui_DmaBufferSamples[i] =\r\ndevpriv->\r\nui_DmaBufferSize[i] >> 1;\r\ndevpriv->ul_DmaBufferHw[i] =\r\nvirt_to_bus((void *)devpriv->\r\nul_DmaBufferVirtual[i]);\r\n}\r\n}\r\nif (!devpriv->ul_DmaBufferVirtual[0]) {\r\nprintk\r\n(", Can't allocate DMA buffer, DMA disabled!");\r\ndevpriv->us_UseDma = ADDI_DISABLE;\r\n}\r\nif (devpriv->ul_DmaBufferVirtual[1]) {\r\ndevpriv->b_DmaDoubleBuffer = 1;\r\n}\r\n}\r\nif ((devpriv->us_UseDma == ADDI_ENABLE)) {\r\nprintk("\nDMA ENABLED\n");\r\n} else {\r\nprintk("\nDMA DISABLED\n");\r\n}\r\n}\r\nif (!strcmp(this_board->pc_DriverName, "apci1710")) {\r\n#ifdef CONFIG_APCI_1710\r\ni_ADDI_AttachPCI1710(dev);\r\ndevpriv->s_BoardInfos.ui_Address = io_addr[2];\r\n#endif\r\n} else {\r\nn_subdevices = 7;\r\nret = alloc_subdevices(dev, n_subdevices);\r\nif (ret < 0)\r\nreturn ret;\r\ns = dev->subdevices + 0;\r\nif ((devpriv->s_EeParameters.i_NbrAiChannel)\r\n|| (this_board->i_NbrAiChannelDiff)) {\r\ndev->read_subdev = s;\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags =\r\nSDF_READABLE | SDF_COMMON | SDF_GROUND\r\n| SDF_DIFF;\r\nif (devpriv->s_EeParameters.i_NbrAiChannel) {\r\ns->n_chan =\r\ndevpriv->s_EeParameters.i_NbrAiChannel;\r\ndevpriv->b_SingelDiff = 0;\r\n} else {\r\ns->n_chan = this_board->i_NbrAiChannelDiff;\r\ndevpriv->b_SingelDiff = 1;\r\n}\r\ns->maxdata = devpriv->s_EeParameters.i_AiMaxdata;\r\ns->len_chanlist = this_board->i_AiChannelList;\r\ns->range_table = this_board->pr_AiRangelist;\r\ndevpriv->b_AiInitialisation = 1;\r\ns->insn_config =\r\nthis_board->i_hwdrv_InsnConfigAnalogInput;\r\ns->insn_read = this_board->i_hwdrv_InsnReadAnalogInput;\r\ns->insn_write =\r\nthis_board->i_hwdrv_InsnWriteAnalogInput;\r\ns->insn_bits = this_board->i_hwdrv_InsnBitsAnalogInput;\r\ns->do_cmdtest =\r\nthis_board->i_hwdrv_CommandTestAnalogInput;\r\ns->do_cmd = this_board->i_hwdrv_CommandAnalogInput;\r\ns->cancel = this_board->i_hwdrv_CancelAnalogInput;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = dev->subdevices + 1;\r\nif (devpriv->s_EeParameters.i_NbrAoChannel) {\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITEABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = devpriv->s_EeParameters.i_NbrAoChannel;\r\ns->maxdata = devpriv->s_EeParameters.i_AoMaxdata;\r\ns->len_chanlist =\r\ndevpriv->s_EeParameters.i_NbrAoChannel;\r\ns->range_table = this_board->pr_AoRangelist;\r\ns->insn_config =\r\nthis_board->i_hwdrv_InsnConfigAnalogOutput;\r\ns->insn_write =\r\nthis_board->i_hwdrv_InsnWriteAnalogOutput;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = dev->subdevices + 2;\r\nif (devpriv->s_EeParameters.i_NbrDiChannel) {\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = devpriv->s_EeParameters.i_NbrDiChannel;\r\ns->maxdata = 1;\r\ns->len_chanlist =\r\ndevpriv->s_EeParameters.i_NbrDiChannel;\r\ns->range_table = &range_digital;\r\ns->io_bits = 0;\r\ns->insn_config =\r\nthis_board->i_hwdrv_InsnConfigDigitalInput;\r\ns->insn_read = this_board->i_hwdrv_InsnReadDigitalInput;\r\ns->insn_write =\r\nthis_board->i_hwdrv_InsnWriteDigitalInput;\r\ns->insn_bits = this_board->i_hwdrv_InsnBitsDigitalInput;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = dev->subdevices + 3;\r\nif (devpriv->s_EeParameters.i_NbrDoChannel) {\r\ns->type = COMEDI_SUBD_DO;\r\ns->subdev_flags =\r\nSDF_READABLE | SDF_WRITEABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = devpriv->s_EeParameters.i_NbrDoChannel;\r\ns->maxdata = devpriv->s_EeParameters.i_DoMaxdata;\r\ns->len_chanlist =\r\ndevpriv->s_EeParameters.i_NbrDoChannel;\r\ns->range_table = &range_digital;\r\ns->io_bits = 0xf;\r\ns->insn_config = this_board->i_hwdrv_InsnConfigDigitalOutput;\r\ns->insn_write =\r\nthis_board->i_hwdrv_InsnWriteDigitalOutput;\r\ns->insn_bits =\r\nthis_board->i_hwdrv_InsnBitsDigitalOutput;\r\ns->insn_read =\r\nthis_board->i_hwdrv_InsnReadDigitalOutput;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = dev->subdevices + 4;\r\nif (devpriv->s_EeParameters.i_Timer) {\r\ns->type = COMEDI_SUBD_TIMER;\r\ns->subdev_flags = SDF_WRITEABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = 1;\r\ns->maxdata = 0;\r\ns->len_chanlist = 1;\r\ns->range_table = &range_digital;\r\ns->insn_write = this_board->i_hwdrv_InsnWriteTimer;\r\ns->insn_read = this_board->i_hwdrv_InsnReadTimer;\r\ns->insn_config = this_board->i_hwdrv_InsnConfigTimer;\r\ns->insn_bits = this_board->i_hwdrv_InsnBitsTimer;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = dev->subdevices + 5;\r\nif (this_board->i_NbrTTLChannel) {\r\ns->type = COMEDI_SUBD_TTLIO;\r\ns->subdev_flags =\r\nSDF_WRITEABLE | SDF_READABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = this_board->i_NbrTTLChannel;\r\ns->maxdata = 1;\r\ns->io_bits = 0;\r\ns->len_chanlist = this_board->i_NbrTTLChannel;\r\ns->range_table = &range_digital;\r\ns->insn_config = this_board->i_hwdr_ConfigInitTTLIO;\r\ns->insn_bits = this_board->i_hwdr_ReadTTLIOBits;\r\ns->insn_read = this_board->i_hwdr_ReadTTLIOAllPortValue;\r\ns->insn_write = this_board->i_hwdr_WriteTTLIOChlOnOff;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = dev->subdevices + 6;\r\nif (this_board->i_PCIEeprom) {\r\ns->type = COMEDI_SUBD_MEMORY;\r\ns->subdev_flags = SDF_READABLE | SDF_INTERNAL;\r\ns->n_chan = 256;\r\ns->maxdata = 0xffff;\r\ns->insn_read = i_ADDIDATA_InsnReadEeprom;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\n}\r\nprintk("\ni_ADDI_Attach end\n");\r\ni_ADDI_Reset(dev);\r\ndevpriv->b_ValidDriver = 1;\r\nreturn 0;\r\n}\r\nstatic int i_ADDI_Detach(struct comedi_device *dev)\r\n{\r\nif (dev->private) {\r\nif (devpriv->b_ValidDriver) {\r\ni_ADDI_Reset(dev);\r\n}\r\nif (dev->irq) {\r\nfree_irq(dev->irq, dev);\r\n}\r\nif ((this_board->pc_EepromChip == NULL)\r\n|| (strcmp(this_board->pc_EepromChip,\r\nADDIDATA_9054) != 0)) {\r\nif (devpriv->allocated) {\r\ni_pci_card_free(devpriv->amcc);\r\n}\r\nif (devpriv->ul_DmaBufferVirtual[0]) {\r\nfree_pages((unsigned long)devpriv->\r\nul_DmaBufferVirtual[0],\r\ndevpriv->ui_DmaBufferPages[0]);\r\n}\r\nif (devpriv->ul_DmaBufferVirtual[1]) {\r\nfree_pages((unsigned long)devpriv->\r\nul_DmaBufferVirtual[1],\r\ndevpriv->ui_DmaBufferPages[1]);\r\n}\r\n} else {\r\niounmap(devpriv->dw_AiBase);\r\nif (devpriv->allocated) {\r\ni_pci_card_free(devpriv->amcc);\r\n}\r\n}\r\nif (pci_list_builded) {\r\nv_pci_card_list_cleanup(this_board->i_VendorId);\r\npci_list_builded = 0;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int i_ADDI_Reset(struct comedi_device *dev)\r\n{\r\nthis_board->i_hwdrv_Reset(dev);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t v_ADDI_Interrupt(int irq, void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nthis_board->v_hwdrv_Interrupt(irq, d);\r\nreturn IRQ_RETVAL(1);\r\n}\r\nstatic int i_ADDIDATA_InsnReadEeprom(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned short w_Data;\r\nunsigned short w_Address;\r\nw_Address = CR_CHAN(insn->chanspec);\r\nw_Data = w_EepromReadWord(devpriv->i_IobaseAmcc,\r\nthis_board->pc_EepromChip, 0x100 + (2 * w_Address));\r\ndata[0] = w_Data;\r\nreturn insn->n;\r\n}

static bool\r\nget_gpio_location(struct dcb_gpio_entry *ent, uint32_t *reg, uint32_t *shift,\r\nuint32_t *mask)\r\n{\r\nif (ent->line < 2) {\r\n*reg = NV_PCRTC_GPIO;\r\n*shift = ent->line * 16;\r\n*mask = 0x11;\r\n} else if (ent->line < 10) {\r\n*reg = NV_PCRTC_GPIO_EXT;\r\n*shift = (ent->line - 2) * 4;\r\n*mask = 0x3;\r\n} else if (ent->line < 14) {\r\n*reg = NV_PCRTC_850;\r\n*shift = (ent->line - 10) * 4;\r\n*mask = 0x3;\r\n} else {\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nint\r\nnv10_gpio_get(struct drm_device *dev, enum dcb_gpio_tag tag)\r\n{\r\nstruct dcb_gpio_entry *ent = nouveau_bios_gpio_entry(dev, tag);\r\nuint32_t reg, shift, mask, value;\r\nif (!ent)\r\nreturn -ENODEV;\r\nif (!get_gpio_location(ent, &reg, &shift, &mask))\r\nreturn -ENODEV;\r\nvalue = NVReadCRTC(dev, 0, reg) >> shift;\r\nreturn (ent->invert ? 1 : 0) ^ (value & 1);\r\n}\r\nint\r\nnv10_gpio_set(struct drm_device *dev, enum dcb_gpio_tag tag, int state)\r\n{\r\nstruct dcb_gpio_entry *ent = nouveau_bios_gpio_entry(dev, tag);\r\nuint32_t reg, shift, mask, value;\r\nif (!ent)\r\nreturn -ENODEV;\r\nif (!get_gpio_location(ent, &reg, &shift, &mask))\r\nreturn -ENODEV;\r\nvalue = ((ent->invert ? 1 : 0) ^ (state ? 1 : 0)) << shift;\r\nmask = ~(mask << shift);\r\nNVWriteCRTC(dev, 0, reg, value | (NVReadCRTC(dev, 0, reg) & mask));\r\nreturn 0;\r\n}

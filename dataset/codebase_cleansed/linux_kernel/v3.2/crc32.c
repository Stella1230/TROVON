u32 __pure crc32_le(u32 crc, unsigned char const *p, size_t len)\r\n{\r\nint i;\r\nwhile (len--) {\r\ncrc ^= *p++;\r\nfor (i = 0; i < 8; i++)\r\ncrc = (crc >> 1) ^ ((crc & 1) ? CRCPOLY_LE : 0);\r\n}\r\nreturn crc;\r\n}\r\nu32 __pure crc32_le(u32 crc, unsigned char const *p, size_t len)\r\n{\r\n# if CRC_LE_BITS == 8\r\nconst u32 (*tab)[] = crc32table_le;\r\ncrc = __cpu_to_le32(crc);\r\ncrc = crc32_body(crc, p, len, tab);\r\nreturn __le32_to_cpu(crc);\r\n# elif CRC_LE_BITS == 4\r\nwhile (len--) {\r\ncrc ^= *p++;\r\ncrc = (crc >> 4) ^ crc32table_le[crc & 15];\r\ncrc = (crc >> 4) ^ crc32table_le[crc & 15];\r\n}\r\nreturn crc;\r\n# elif CRC_LE_BITS == 2\r\nwhile (len--) {\r\ncrc ^= *p++;\r\ncrc = (crc >> 2) ^ crc32table_le[crc & 3];\r\ncrc = (crc >> 2) ^ crc32table_le[crc & 3];\r\ncrc = (crc >> 2) ^ crc32table_le[crc & 3];\r\ncrc = (crc >> 2) ^ crc32table_le[crc & 3];\r\n}\r\nreturn crc;\r\n# endif\r\n}\r\nu32 __pure crc32_be(u32 crc, unsigned char const *p, size_t len)\r\n{\r\nint i;\r\nwhile (len--) {\r\ncrc ^= *p++ << 24;\r\nfor (i = 0; i < 8; i++)\r\ncrc =\r\n(crc << 1) ^ ((crc & 0x80000000) ? CRCPOLY_BE :\r\n0);\r\n}\r\nreturn crc;\r\n}\r\nu32 __pure crc32_be(u32 crc, unsigned char const *p, size_t len)\r\n{\r\n# if CRC_BE_BITS == 8\r\nconst u32 (*tab)[] = crc32table_be;\r\ncrc = __cpu_to_be32(crc);\r\ncrc = crc32_body(crc, p, len, tab);\r\nreturn __be32_to_cpu(crc);\r\n# elif CRC_BE_BITS == 4\r\nwhile (len--) {\r\ncrc ^= *p++ << 24;\r\ncrc = (crc << 4) ^ crc32table_be[crc >> 28];\r\ncrc = (crc << 4) ^ crc32table_be[crc >> 28];\r\n}\r\nreturn crc;\r\n# elif CRC_BE_BITS == 2\r\nwhile (len--) {\r\ncrc ^= *p++ << 24;\r\ncrc = (crc << 2) ^ crc32table_be[crc >> 30];\r\ncrc = (crc << 2) ^ crc32table_be[crc >> 30];\r\ncrc = (crc << 2) ^ crc32table_be[crc >> 30];\r\ncrc = (crc << 2) ^ crc32table_be[crc >> 30];\r\n}\r\nreturn crc;\r\n# endif\r\n}\r\nstatic void bytereverse(unsigned char *buf, size_t len)\r\n{\r\nwhile (len--) {\r\nunsigned char x = bitrev8(*buf);\r\n*buf++ = x;\r\n}\r\n}\r\nstatic void random_garbage(unsigned char *buf, size_t len)\r\n{\r\nwhile (len--)\r\n*buf++ = (unsigned char) random();\r\n}\r\nstatic void store_be(u32 x, unsigned char *buf)\r\n{\r\nbuf[0] = (unsigned char) (x >> 24);\r\nbuf[1] = (unsigned char) (x >> 16);\r\nbuf[2] = (unsigned char) (x >> 8);\r\nbuf[3] = (unsigned char) x;\r\n}\r\nstatic u32 test_step(u32 init, unsigned char *buf, size_t len)\r\n{\r\nu32 crc1, crc2;\r\nsize_t i;\r\ncrc1 = crc32_be(init, buf, len);\r\nstore_be(crc1, buf + len);\r\ncrc2 = crc32_be(init, buf, len + 4);\r\nif (crc2)\r\nprintf("\nCRC cancellation fail: 0x%08x should be 0\n",\r\ncrc2);\r\nfor (i = 0; i <= len + 4; i++) {\r\ncrc2 = crc32_be(init, buf, i);\r\ncrc2 = crc32_be(crc2, buf + i, len + 4 - i);\r\nif (crc2)\r\nprintf("\nCRC split fail: 0x%08x\n", crc2);\r\n}\r\nbytereverse(buf, len + 4);\r\ninit = bitrev32(init);\r\ncrc2 = bitrev32(crc1);\r\nif (crc1 != bitrev32(crc2))\r\nprintf("\nBit reversal fail: 0x%08x -> 0x%08x -> 0x%08x\n",\r\ncrc1, crc2, bitrev32(crc2));\r\ncrc1 = crc32_le(init, buf, len);\r\nif (crc1 != crc2)\r\nprintf("\nCRC endianness fail: 0x%08x != 0x%08x\n", crc1,\r\ncrc2);\r\ncrc2 = crc32_le(init, buf, len + 4);\r\nif (crc2)\r\nprintf("\nCRC cancellation fail: 0x%08x should be 0\n",\r\ncrc2);\r\nfor (i = 0; i <= len + 4; i++) {\r\ncrc2 = crc32_le(init, buf, i);\r\ncrc2 = crc32_le(crc2, buf + i, len + 4 - i);\r\nif (crc2)\r\nprintf("\nCRC split fail: 0x%08x\n", crc2);\r\n}\r\nreturn crc1;\r\n}\r\nint main(void)\r\n{\r\nunsigned char buf1[SIZE + 4];\r\nunsigned char buf2[SIZE + 4];\r\nunsigned char buf3[SIZE + 4];\r\nint i, j;\r\nu32 crc1, crc2, crc3;\r\nfor (i = 0; i <= SIZE; i++) {\r\nprintf("\rTesting length %d...", i);\r\nfflush(stdout);\r\nrandom_garbage(buf1, i);\r\nrandom_garbage(buf2, i);\r\nfor (j = 0; j < i; j++)\r\nbuf3[j] = buf1[j] ^ buf2[j];\r\ncrc1 = test_step(INIT1, buf1, i);\r\ncrc2 = test_step(INIT2, buf2, i);\r\ncrc3 = test_step(INIT1 ^ INIT2, buf3, i);\r\nif (crc3 != (crc1 ^ crc2))\r\nprintf("CRC XOR fail: 0x%08x != 0x%08x ^ 0x%08x\n",\r\ncrc3, crc1, crc2);\r\n}\r\nprintf("\nAll test complete. No failures expected.\n");\r\nreturn 0;\r\n}

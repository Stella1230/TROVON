static inline u8 de600_read_status(struct net_device *dev)\r\n{\r\nu8 status;\r\noutb_p(STATUS, DATA_PORT);\r\nstatus = inb(STATUS_PORT);\r\noutb_p(NULL_COMMAND | HI_NIBBLE, DATA_PORT);\r\nreturn status;\r\n}\r\nstatic inline u8 de600_read_byte(unsigned char type, struct net_device *dev)\r\n{\r\nu8 lo;\r\noutb_p((type), DATA_PORT);\r\nlo = ((unsigned char)inb(STATUS_PORT)) >> 4;\r\noutb_p((type) | HI_NIBBLE, DATA_PORT);\r\nreturn ((unsigned char)inb(STATUS_PORT) & (unsigned char)0xf0) | lo;\r\n}\r\nstatic int de600_open(struct net_device *dev)\r\n{\r\nunsigned long flags;\r\nint ret = request_irq(DE600_IRQ, de600_interrupt, 0, dev->name, dev);\r\nif (ret) {\r\nprintk(KERN_ERR "%s: unable to get IRQ %d\n", dev->name, DE600_IRQ);\r\nreturn ret;\r\n}\r\nspin_lock_irqsave(&de600_lock, flags);\r\nret = adapter_init(dev);\r\nspin_unlock_irqrestore(&de600_lock, flags);\r\nreturn ret;\r\n}\r\nstatic int de600_close(struct net_device *dev)\r\n{\r\nselect_nic();\r\nrx_page = 0;\r\nde600_put_command(RESET);\r\nde600_put_command(STOP_RESET);\r\nde600_put_command(0);\r\nselect_prn();\r\nfree_irq(DE600_IRQ, dev);\r\nreturn 0;\r\n}\r\nstatic inline void trigger_interrupt(struct net_device *dev)\r\n{\r\nde600_put_command(FLIP_IRQ);\r\nselect_prn();\r\nDE600_SLOW_DOWN;\r\nselect_nic();\r\nde600_put_command(0);\r\n}\r\nstatic int de600_start_xmit(struct sk_buff *skb, struct net_device *dev)\r\n{\r\nunsigned long flags;\r\nint transmit_from;\r\nint len;\r\nint tickssofar;\r\nu8 *buffer = skb->data;\r\nint i;\r\nif (free_tx_pages <= 0) {\r\ntickssofar = jiffies - dev_trans_start(dev);\r\nif (tickssofar < HZ/20)\r\nreturn NETDEV_TX_BUSY;\r\nprintk(KERN_WARNING "%s: transmit timed out (%d), %s?\n", dev->name, tickssofar, "network cable problem");\r\nspin_lock_irqsave(&de600_lock, flags);\r\nif (adapter_init(dev)) {\r\nspin_unlock_irqrestore(&de600_lock, flags);\r\nreturn NETDEV_TX_BUSY;\r\n}\r\nspin_unlock_irqrestore(&de600_lock, flags);\r\n}\r\npr_debug("de600_start_xmit:len=%d, page %d/%d\n", skb->len, tx_fifo_in, free_tx_pages);\r\nif ((len = skb->len) < RUNT)\r\nlen = RUNT;\r\nspin_lock_irqsave(&de600_lock, flags);\r\nselect_nic();\r\ntx_fifo[tx_fifo_in] = transmit_from = tx_page_adr(tx_fifo_in) - len;\r\ntx_fifo_in = (tx_fifo_in + 1) % TX_PAGES;\r\nif(check_lost)\r\n{\r\nde600_setup_address(NODE_ADDRESS, RW_ADDR);\r\nde600_read_byte(READ_DATA, dev);\r\nif (was_down || (de600_read_byte(READ_DATA, dev) != 0xde)) {\r\nif (adapter_init(dev)) {\r\nspin_unlock_irqrestore(&de600_lock, flags);\r\nreturn NETDEV_TX_BUSY;\r\n}\r\n}\r\n}\r\nde600_setup_address(transmit_from, RW_ADDR);\r\nfor (i = 0; i < skb->len ; ++i, ++buffer)\r\nde600_put_byte(*buffer);\r\nfor (; i < len; ++i)\r\nde600_put_byte(0);\r\nif (free_tx_pages-- == TX_PAGES) {\r\ndev->trans_start = jiffies;\r\nnetif_start_queue(dev);\r\nde600_setup_address(transmit_from, TX_ADDR);\r\nde600_put_command(TX_ENABLE);\r\n}\r\nelse {\r\nif (free_tx_pages)\r\nnetif_start_queue(dev);\r\nelse\r\nnetif_stop_queue(dev);\r\nselect_prn();\r\n}\r\nspin_unlock_irqrestore(&de600_lock, flags);\r\ndev_kfree_skb(skb);\r\nreturn NETDEV_TX_OK;\r\n}\r\nstatic irqreturn_t de600_interrupt(int irq, void *dev_id)\r\n{\r\nstruct net_device *dev = dev_id;\r\nu8 irq_status;\r\nint retrig = 0;\r\nint boguscount = 0;\r\nspin_lock(&de600_lock);\r\nselect_nic();\r\nirq_status = de600_read_status(dev);\r\ndo {\r\npr_debug("de600_interrupt (%02X)\n", irq_status);\r\nif (irq_status & RX_GOOD)\r\nde600_rx_intr(dev);\r\nelse if (!(irq_status & RX_BUSY))\r\nde600_put_command(RX_ENABLE);\r\nif (free_tx_pages < TX_PAGES)\r\nretrig = de600_tx_intr(dev, irq_status);\r\nelse\r\nretrig = 0;\r\nirq_status = de600_read_status(dev);\r\n} while ( (irq_status & RX_GOOD) || ((++boguscount < 100) && retrig) );\r\nselect_prn();\r\nif (retrig)\r\ntrigger_interrupt(dev);\r\nspin_unlock(&de600_lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int de600_tx_intr(struct net_device *dev, int irq_status)\r\n{\r\nif (irq_status & TX_BUSY)\r\nreturn 1;\r\nif (!(irq_status & TX_FAILED16)) {\r\ntx_fifo_out = (tx_fifo_out + 1) % TX_PAGES;\r\n++free_tx_pages;\r\ndev->stats.tx_packets++;\r\nnetif_wake_queue(dev);\r\n}\r\nif ((free_tx_pages < TX_PAGES) || (irq_status & TX_FAILED16)) {\r\ndev->trans_start = jiffies;\r\nde600_setup_address(tx_fifo[tx_fifo_out], TX_ADDR);\r\nde600_put_command(TX_ENABLE);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void de600_rx_intr(struct net_device *dev)\r\n{\r\nstruct sk_buff *skb;\r\nint i;\r\nint read_from;\r\nint size;\r\nunsigned char *buffer;\r\nsize = de600_read_byte(RX_LEN, dev);\r\nsize += (de600_read_byte(RX_LEN, dev) << 8);\r\nsize -= 4;\r\nread_from = rx_page_adr();\r\nnext_rx_page();\r\nde600_put_command(RX_ENABLE);\r\nif ((size < 32) || (size > 1535)) {\r\nprintk(KERN_WARNING "%s: Bogus packet size %d.\n", dev->name, size);\r\nif (size > 10000)\r\nadapter_init(dev);\r\nreturn;\r\n}\r\nskb = dev_alloc_skb(size+2);\r\nif (skb == NULL) {\r\nprintk("%s: Couldn't allocate a sk_buff of size %d.\n", dev->name, size);\r\nreturn;\r\n}\r\nskb_reserve(skb,2);\r\nbuffer = skb_put(skb,size);\r\nde600_setup_address(read_from, RW_ADDR);\r\nfor (i = size; i > 0; --i, ++buffer)\r\n*buffer = de600_read_byte(READ_DATA, dev);\r\nskb->protocol=eth_type_trans(skb,dev);\r\nnetif_rx(skb);\r\ndev->stats.rx_packets++;\r\ndev->stats.rx_bytes += size;\r\n}\r\nstatic struct net_device * __init de600_probe(void)\r\n{\r\nint i;\r\nstruct net_device *dev;\r\nint err;\r\ndev = alloc_etherdev(0);\r\nif (!dev)\r\nreturn ERR_PTR(-ENOMEM);\r\nif (!request_region(DE600_IO, 3, "de600")) {\r\nprintk(KERN_WARNING "DE600: port 0x%x busy\n", DE600_IO);\r\nerr = -EBUSY;\r\ngoto out;\r\n}\r\nprintk(KERN_INFO "%s: D-Link DE-600 pocket adapter", dev->name);\r\npr_debug("%s", version);\r\nerr = -ENODEV;\r\nrx_page = 0;\r\nselect_nic();\r\n(void)de600_read_status(dev);\r\nde600_put_command(RESET);\r\nde600_put_command(STOP_RESET);\r\nif (de600_read_status(dev) & 0xf0) {\r\nprintk(": not at I/O %#3x.\n", DATA_PORT);\r\ngoto out1;\r\n}\r\nde600_setup_address(NODE_ADDRESS, RW_ADDR);\r\nfor (i = 0; i < ETH_ALEN; i++) {\r\ndev->dev_addr[i] = de600_read_byte(READ_DATA, dev);\r\ndev->broadcast[i] = 0xff;\r\n}\r\nif ((dev->dev_addr[1] == 0xde) && (dev->dev_addr[2] == 0x15)) {\r\ndev->dev_addr[0] = 0x00;\r\ndev->dev_addr[1] = 0x80;\r\ndev->dev_addr[2] = 0xc8;\r\ndev->dev_addr[3] &= 0x0f;\r\ndev->dev_addr[3] |= 0x70;\r\n} else {\r\nprintk(" not identified in the printer port\n");\r\ngoto out1;\r\n}\r\nprintk(", Ethernet Address: %pM\n", dev->dev_addr);\r\ndev->netdev_ops = &de600_netdev_ops;\r\ndev->flags&=~IFF_MULTICAST;\r\nselect_prn();\r\nerr = register_netdev(dev);\r\nif (err)\r\ngoto out1;\r\nreturn dev;\r\nout1:\r\nrelease_region(DE600_IO, 3);\r\nout:\r\nfree_netdev(dev);\r\nreturn ERR_PTR(err);\r\n}\r\nstatic int adapter_init(struct net_device *dev)\r\n{\r\nint i;\r\nselect_nic();\r\nrx_page = 0;\r\nde600_put_command(RESET);\r\nde600_put_command(STOP_RESET);\r\nde600_setup_address(NODE_ADDRESS, RW_ADDR);\r\nde600_read_byte(READ_DATA, dev);\r\nif ((de600_read_byte(READ_DATA, dev) != 0xde) ||\r\n(de600_read_byte(READ_DATA, dev) != 0x15)) {\r\nprintk("Something has happened to the DE-600! Please check it and do a new ifconfig!\n");\r\ndev->flags &= ~IFF_UP;\r\nde600_close(dev);\r\nwas_down = 1;\r\nnetif_stop_queue(dev);\r\nreturn 1;\r\n}\r\nif (was_down) {\r\nprintk(KERN_INFO "%s: Thanks, I feel much better now!\n", dev->name);\r\nwas_down = 0;\r\n}\r\ntx_fifo_in = 0;\r\ntx_fifo_out = 0;\r\nfree_tx_pages = TX_PAGES;\r\nde600_setup_address(NODE_ADDRESS, RW_ADDR);\r\nfor (i = 0; i < ETH_ALEN; i++)\r\nde600_put_byte(dev->dev_addr[i]);\r\nrx_page = RX_BP | RX_BASE_PAGE;\r\nde600_setup_address(MEM_4K, RW_ADDR);\r\nde600_put_command(RX_ENABLE);\r\nselect_prn();\r\nnetif_start_queue(dev);\r\nreturn 0;\r\n}\r\nstatic int __init de600_init(void)\r\n{\r\nde600_dev = de600_probe();\r\nif (IS_ERR(de600_dev))\r\nreturn PTR_ERR(de600_dev);\r\nreturn 0;\r\n}\r\nstatic void __exit de600_exit(void)\r\n{\r\nunregister_netdev(de600_dev);\r\nrelease_region(DE600_IO, 3);\r\nfree_netdev(de600_dev);\r\n}

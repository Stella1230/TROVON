int i_APCI1710_InsnConfigInitTimer(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i_ReturnValue = 0;\r\nunsigned char b_ModulNbr;\r\nunsigned char b_TimerNbr;\r\nunsigned char b_TimerMode;\r\nunsigned int ul_ReloadValue;\r\nunsigned char b_InputClockSelection;\r\nunsigned char b_InputClockLevel;\r\nunsigned char b_OutputLevel;\r\nunsigned char b_HardwareGateLevel;\r\nunsigned int dw_Test = 0;\r\ni_ReturnValue = insn->n;\r\nb_ModulNbr = (unsigned char) CR_AREF(insn->chanspec);\r\nb_TimerNbr = (unsigned char) CR_CHAN(insn->chanspec);\r\nb_TimerMode = (unsigned char) data[0];\r\nul_ReloadValue = (unsigned int) data[1];\r\nb_InputClockSelection = (unsigned char) data[2];\r\nb_InputClockLevel = (unsigned char) data[3];\r\nb_OutputLevel = (unsigned char) data[4];\r\nb_HardwareGateLevel = (unsigned char) data[5];\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.dw_MolduleConfiguration[b_ModulNbr] & 0xFFFF0000UL) == APCI1710_82X54_TIMER) {\r\nif (b_TimerNbr <= 2) {\r\nif (b_TimerMode <= 5) {\r\nif (((b_TimerNbr == 0) &&\r\n(b_InputClockSelection == APCI1710_PCI_BUS_CLOCK)) ||\r\n((b_TimerNbr == 0) &&\r\n(b_InputClockSelection == APCI1710_10MHZ)) ||\r\n((b_TimerNbr != 0) &&\r\n((b_InputClockSelection == APCI1710_PCI_BUS_CLOCK) ||\r\n(b_InputClockSelection == APCI1710_FRONT_CONNECTOR_INPUT) ||\r\n(b_InputClockSelection == APCI1710_10MHZ)))) {\r\nif (((b_InputClockSelection == APCI1710_10MHZ) &&\r\n((devpriv->s_BoardInfos.dw_MolduleConfiguration[b_ModulNbr] & 0x0000FFFFUL) >= 0x3131)) ||\r\n(b_InputClockSelection != APCI1710_10MHZ)) {\r\nif ((b_InputClockLevel == 0) ||\r\n(b_InputClockLevel == 1)) {\r\nif ((b_OutputLevel == 0) || (b_OutputLevel == 1)) {\r\nif ((b_HardwareGateLevel == 0) || (b_HardwareGateLevel == 1)) {\r\nif ((b_InputClockSelection == APCI1710_10MHZ) && ((devpriv->s_BoardInfos.dw_MolduleConfiguration[b_ModulNbr] & 0x0000FFFFUL) > 0x3131)) {\r\ndw_Test = inl(devpriv->s_BoardInfos.ui_Address + (16 + (b_TimerNbr * 4) + (64 * b_ModulNbr)));\r\ndw_Test = (dw_Test >> 16) & 1;\r\n} else {\r\ndw_Test = 1;\r\n}\r\nif (dw_Test == 1) {\r\ndevpriv->s_ModuleInfo[b_ModulNbr].s_82X54ModuleInfo.s_82X54TimerInfo[b_TimerNbr].b_82X54Init = 1;\r\ndevpriv-> s_ModuleInfo[b_ModulNbr].s_82X54ModuleInfo.s_82X54TimerInfo[b_TimerNbr].b_InputClockSelection = b_InputClockSelection;\r\ndevpriv->s_ModuleInfo[b_ModulNbr].s_82X54ModuleInfo.s_82X54TimerInfo[b_TimerNbr].b_InputClockLevel = ~b_InputClockLevel & 1;\r\ndevpriv->s_ModuleInfo[b_ModulNbr].s_82X54ModuleInfo.s_82X54TimerInfo[b_TimerNbr].b_OutputLevel = ~b_OutputLevel & 1;\r\ndevpriv->s_ModuleInfo[b_ModulNbr].s_82X54ModuleInfo.s_82X54TimerInfo[b_TimerNbr].b_HardwareGateLevel = b_HardwareGateLevel;\r\nif (b_InputClockSelection == APCI1710_10MHZ) {\r\nb_InputClockSelection = 2;\r\n}\r\ndevpriv->s_ModuleInfo[b_ModulNbr].s_82X54ModuleInfo.s_82X54TimerInfo[b_TimerNbr].dw_ConfigurationWord = (unsigned int)(((b_HardwareGateLevel << 0) & 0x1) | ((b_InputClockLevel << 1) & 0x2) | (((~b_OutputLevel & 1) << 2) & 0x4) | ((b_InputClockSelection << 4) & 0x30));\r\noutl(devpriv->s_ModuleInfo[b_ModulNbr].s_82X54ModuleInfo.s_82X54TimerInfo[b_TimerNbr].dw_ConfigurationWord, devpriv->s_BoardInfos.ui_Address + 32 + (b_TimerNbr * 4) + (64 * b_ModulNbr));\r\noutl((unsigned int) b_TimerMode, devpriv->s_BoardInfos.ui_Address + 16 + (b_TimerNbr * 4) + (64 * b_ModulNbr));\r\noutl(ul_ReloadValue, devpriv->s_BoardInfos.ui_Address + 0 + (b_TimerNbr * 4) + (64 * b_ModulNbr));\r\n}\r\nelse {\r\ni_ReturnValue = -6;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Selection from hardware gate level is wrong\n");\r\ni_ReturnValue = -9;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Selection from output clock level is wrong\n");\r\ni_ReturnValue = -8;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Selection from input clock level is wrong\n");\r\ni_ReturnValue = -7;\r\n}\r\n} else {\r\nDPRINTK("Input timer clock selection is wrong\n");\r\ni_ReturnValue = -6;\r\n}\r\n} else {\r\nDPRINTK("Input timer clock selection is wrong\n");\r\ni_ReturnValue = -6;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Timer mode selection is wrong\n");\r\ni_ReturnValue = -5;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Timer selection wrong\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("The module is not a TIMER module\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("Module number error\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nint i_APCI1710_InsnBitsTimer(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned char b_BitsType;\r\nint i_ReturnValue = 0;\r\nb_BitsType = data[0];\r\nprintk("\n82X54");\r\nswitch (b_BitsType) {\r\ncase APCI1710_TIMER_READVALUE:\r\ni_ReturnValue = i_APCI1710_ReadTimerValue(dev,\r\n(unsigned char)CR_AREF(insn->chanspec),\r\n(unsigned char)CR_CHAN(insn->chanspec),\r\n(unsigned int *) &data[0]);\r\nbreak;\r\ncase APCI1710_TIMER_GETOUTPUTLEVEL:\r\ni_ReturnValue = i_APCI1710_GetTimerOutputLevel(dev,\r\n(unsigned char)CR_AREF(insn->chanspec),\r\n(unsigned char)CR_CHAN(insn->chanspec),\r\n(unsigned char *) &data[0]);\r\nbreak;\r\ncase APCI1710_TIMER_GETPROGRESSSTATUS:\r\ni_ReturnValue = i_APCI1710_GetTimerProgressStatus(dev,\r\n(unsigned char)CR_AREF(insn->chanspec),\r\n(unsigned char)CR_CHAN(insn->chanspec),\r\n(unsigned char *)&data[0]);\r\nbreak;\r\ncase APCI1710_TIMER_WRITEVALUE:\r\ni_ReturnValue = i_APCI1710_WriteTimerValue(dev,\r\n(unsigned char)CR_AREF(insn->chanspec),\r\n(unsigned char)CR_CHAN(insn->chanspec),\r\n(unsigned int)data[1]);\r\nbreak;\r\ndefault:\r\nprintk("Bits Config Parameter Wrong\n");\r\ni_ReturnValue = -1;\r\n}\r\nif (i_ReturnValue >= 0)\r\ni_ReturnValue = insn->n;\r\nreturn i_ReturnValue;\r\n}\r\nint i_APCI1710_ReadTimerValue(struct comedi_device *dev,\r\nunsigned char b_ModulNbr, unsigned char b_TimerNbr,\r\nunsigned int *pul_TimerValue)\r\n{\r\nint i_ReturnValue = 0;\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_82X54_TIMER) {\r\nif (b_TimerNbr <= 2) {\r\nif (devpriv->\r\ns_ModuleInfo[b_ModulNbr].\r\ns_82X54ModuleInfo.\r\ns_82X54TimerInfo[b_TimerNbr].\r\nb_82X54Init == 1) {\r\noutl((2 << b_TimerNbr) | 0xD0,\r\ndevpriv->s_BoardInfos.\r\nui_Address + 12 +\r\n(64 * b_ModulNbr));\r\n*pul_TimerValue =\r\ninl(devpriv->s_BoardInfos.\r\nui_Address + (b_TimerNbr * 4) +\r\n(64 * b_ModulNbr));\r\n} else {\r\nDPRINTK("Timer not initialised see function\n");\r\ni_ReturnValue = -5;\r\n}\r\n} else {\r\nDPRINTK("Timer selection wrong\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("The module is not a TIMER module\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("Module number error\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nint i_APCI1710_GetTimerOutputLevel(struct comedi_device *dev,\r\nunsigned char b_ModulNbr, unsigned char b_TimerNbr,\r\nunsigned char *pb_OutputLevel)\r\n{\r\nint i_ReturnValue = 0;\r\nunsigned int dw_TimerStatus;\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.dw_MolduleConfiguration[b_ModulNbr] & 0xFFFF0000UL) == APCI1710_82X54_TIMER) {\r\nif (b_TimerNbr <= 2) {\r\nif (devpriv->s_ModuleInfo[b_ModulNbr].s_82X54ModuleInfo.s_82X54TimerInfo[b_TimerNbr].b_82X54Init == 1) {\r\noutl((2 << b_TimerNbr) | 0xE0, devpriv->s_BoardInfos.ui_Address + 12 + (64 * b_ModulNbr));\r\ndw_TimerStatus = inl(devpriv->s_BoardInfos.ui_Address + 16 + (b_TimerNbr * 4) + (64 * b_ModulNbr));\r\n*pb_OutputLevel = (unsigned char) (((dw_TimerStatus >> 7) & 1) ^ devpriv-> s_ModuleInfo[b_ModulNbr].s_82X54ModuleInfo.s_82X54TimerInfo[b_TimerNbr].b_OutputLevel);\r\n} else {\r\nDPRINTK("Timer not initialised see function\n");\r\ni_ReturnValue = -5;\r\n}\r\n} else {\r\nDPRINTK("Timer selection wrong\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("The module is not a TIMER module\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("Module number error\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nint i_APCI1710_GetTimerProgressStatus(struct comedi_device *dev,\r\nunsigned char b_ModulNbr, unsigned char b_TimerNbr,\r\nunsigned char *pb_TimerStatus)\r\n{\r\nint i_ReturnValue = 0;\r\nunsigned int dw_TimerStatus;\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.dw_MolduleConfiguration[b_ModulNbr] & 0xFFFF0000UL) == APCI1710_82X54_TIMER) {\r\nif (b_TimerNbr <= 2) {\r\nif (devpriv->s_ModuleInfo[b_ModulNbr].s_82X54ModuleInfo.s_82X54TimerInfo[b_TimerNbr].b_82X54Init == 1) {\r\noutl((2 << b_TimerNbr) | 0xE0, devpriv->s_BoardInfos.ui_Address + 12 + (64 * b_ModulNbr));\r\ndw_TimerStatus = inl(devpriv->s_BoardInfos.ui_Address + 16 + (b_TimerNbr * 4) + (64 * b_ModulNbr));\r\n*pb_TimerStatus = (unsigned char) ((dw_TimerStatus) >> 8) & 1;\r\nprintk("ProgressStatus : %d", *pb_TimerStatus);\r\n} else {\r\ni_ReturnValue = -5;\r\n}\r\n} else {\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nint i_APCI1710_WriteTimerValue(struct comedi_device *dev,\r\nunsigned char b_ModulNbr, unsigned char b_TimerNbr,\r\nunsigned int ul_WriteValue)\r\n{\r\nint i_ReturnValue = 0;\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.dw_MolduleConfiguration[b_ModulNbr] & 0xFFFF0000UL) == APCI1710_82X54_TIMER) {\r\nif (b_TimerNbr <= 2) {\r\nif (devpriv->s_ModuleInfo[b_ModulNbr].s_82X54ModuleInfo.s_82X54TimerInfo[b_TimerNbr].b_82X54Init == 1) {\r\noutl(ul_WriteValue, devpriv->s_BoardInfos.ui_Address + (b_TimerNbr * 4) + (64 * b_ModulNbr));\r\n} else {\r\nDPRINTK("Timer not initialised see function\n");\r\ni_ReturnValue = -5;\r\n}\r\n} else {\r\nDPRINTK("Timer selection wrong\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("The module is not a TIMER module\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("Module number error\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}

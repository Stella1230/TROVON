static int ipaq_open(struct tty_struct *tty,\r\nstruct usb_serial_port *port)\r\n{\r\nstruct usb_serial *serial = port->serial;\r\nint result = 0;\r\nint retries = connect_retries;\r\ndbg("%s - port %d", __func__, port->number);\r\nmsleep(1000*initial_wait);\r\nwhile (retries--) {\r\nresult = usb_control_msg(serial->dev,\r\nusb_sndctrlpipe(serial->dev, 0), 0x22, 0x21,\r\n0x1, 0, NULL, 0, 100);\r\nif (!result)\r\nbreak;\r\nmsleep(1000);\r\n}\r\nif (!retries && result) {\r\ndev_err(&port->dev, "%s - failed doing control urb, error %d\n",\r\n__func__, result);\r\nreturn result;\r\n}\r\nreturn usb_serial_generic_open(tty, port);\r\n}\r\nstatic int ipaq_calc_num_ports(struct usb_serial *serial)\r\n{\r\nint ipaq_num_ports = 1;\r\ndbg("%s - numberofendpoints: %d", __FUNCTION__,\r\n(int)serial->interface->cur_altsetting->desc.bNumEndpoints);\r\nif (serial->interface->cur_altsetting->desc.bNumEndpoints > 3) {\r\nipaq_num_ports = 2;\r\n}\r\nreturn ipaq_num_ports;\r\n}\r\nstatic int ipaq_startup(struct usb_serial *serial)\r\n{\r\ndbg("%s", __func__);\r\nif (serial->num_bulk_in < serial->num_ports ||\r\nserial->num_bulk_out < serial->num_ports)\r\nreturn -ENODEV;\r\nif (serial->dev->actconfig->desc.bConfigurationValue != 1) {\r\ndev_err(&serial->dev->dev, "active config #%d != 1 ??\n",\r\nserial->dev->actconfig->desc.bConfigurationValue);\r\nreturn -ENODEV;\r\n}\r\ndbg("%s - iPAQ module configured for %d ports",\r\n__FUNCTION__, serial->num_ports);\r\nreturn usb_reset_configuration(serial->dev);\r\n}\r\nstatic int __init ipaq_init(void)\r\n{\r\nint retval;\r\nretval = usb_serial_register(&ipaq_device);\r\nif (retval)\r\ngoto failed_usb_serial_register;\r\nif (vendor) {\r\nipaq_id_table[0].idVendor = vendor;\r\nipaq_id_table[0].idProduct = product;\r\n}\r\nretval = usb_register(&ipaq_driver);\r\nif (retval)\r\ngoto failed_usb_register;\r\nprintk(KERN_INFO KBUILD_MODNAME ": " DRIVER_VERSION ":"\r\nDRIVER_DESC "\n");\r\nreturn 0;\r\nfailed_usb_register:\r\nusb_serial_deregister(&ipaq_device);\r\nfailed_usb_serial_register:\r\nreturn retval;\r\n}\r\nstatic void __exit ipaq_exit(void)\r\n{\r\nusb_deregister(&ipaq_driver);\r\nusb_serial_deregister(&ipaq_device);\r\n}

static cycle_t read_cyclone(struct clocksource *cs)\r\n{\r\nreturn (cycle_t)readl(cyclone_ptr);\r\n}\r\nstatic int __init init_cyclone_clocksource(void)\r\n{\r\nunsigned long base;\r\nunsigned long offset;\r\nu32 __iomem* volatile cyclone_timer;\r\nu32 __iomem* reg;\r\nint i;\r\nif (!use_cyclone)\r\nreturn -ENODEV;\r\nprintk(KERN_INFO "Summit chipset: Starting Cyclone Counter.\n");\r\noffset = CYCLONE_CBAR_ADDR;\r\nreg = ioremap_nocache(offset, sizeof(reg));\r\nif (!reg) {\r\nprintk(KERN_ERR "Summit chipset: Could not find valid CBAR register.\n");\r\nreturn -ENODEV;\r\n}\r\nbase = readl(reg);\r\nif (!base) {\r\nprintk(KERN_ERR "Summit chipset: Could not find valid CBAR value.\n");\r\nreturn -ENODEV;\r\n}\r\niounmap(reg);\r\noffset = base + CYCLONE_PMCC_OFFSET;\r\nreg = ioremap_nocache(offset, sizeof(reg));\r\nif (!reg) {\r\nprintk(KERN_ERR "Summit chipset: Could not find valid PMCC register.\n");\r\nreturn -ENODEV;\r\n}\r\nwritel(0x00000001,reg);\r\niounmap(reg);\r\noffset = base + CYCLONE_MPCS_OFFSET;\r\nreg = ioremap_nocache(offset, sizeof(reg));\r\nif (!reg) {\r\nprintk(KERN_ERR "Summit chipset: Could not find valid MPCS register.\n");\r\nreturn -ENODEV;\r\n}\r\nwritel(0x00000001,reg);\r\niounmap(reg);\r\noffset = base + CYCLONE_MPMC_OFFSET;\r\ncyclone_timer = ioremap_nocache(offset, sizeof(u64));\r\nif (!cyclone_timer) {\r\nprintk(KERN_ERR "Summit chipset: Could not find valid MPMC register.\n");\r\nreturn -ENODEV;\r\n}\r\nfor (i = 0; i < 3; i++){\r\nu32 old = readl(cyclone_timer);\r\nint stall = 100;\r\nwhile (stall--)\r\nbarrier();\r\nif (readl(cyclone_timer) == old) {\r\nprintk(KERN_ERR "Summit chipset: Counter not counting! DISABLED\n");\r\niounmap(cyclone_timer);\r\ncyclone_timer = NULL;\r\nreturn -ENODEV;\r\n}\r\n}\r\ncyclone_ptr = cyclone_timer;\r\nreturn clocksource_register_hz(&clocksource_cyclone,\r\nCYCLONE_TIMER_FREQ);\r\n}

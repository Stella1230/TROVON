static int nwfpe_notify(struct notifier_block *self, unsigned long cmd, void *v)\r\n{\r\nstruct thread_info *thread = v;\r\nif (cmd == THREAD_NOTIFY_FLUSH)\r\nnwfpe_init_fpa(&thread->fpstate);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init fpe_init(void)\r\n{\r\nif (sizeof(FPA11) > sizeof(union fp_state)) {\r\nprintk(KERN_ERR "nwfpe: bad structure size\n");\r\nreturn -EINVAL;\r\n}\r\nif (sizeof(FPREG) != 12) {\r\nprintk(KERN_ERR "nwfpe: bad register size\n");\r\nreturn -EINVAL;\r\n}\r\nif (fpe_type[0] && strcmp(fpe_type, "nwfpe"))\r\nreturn 0;\r\nprintk(KERN_WARNING "NetWinder Floating Point Emulator V0.97 ("\r\nNWFPE_BITS " precision)\n");\r\nthread_register_notifier(&nwfpe_notifier_block);\r\norig_fp_enter = kern_fp_enter;\r\nkern_fp_enter = nwfpe_enter;\r\nreturn 0;\r\n}\r\nstatic void __exit fpe_exit(void)\r\n{\r\nthread_unregister_notifier(&nwfpe_notifier_block);\r\nkern_fp_enter = orig_fp_enter;\r\n}\r\nvoid float_raise(signed char flags)\r\n{\r\nregister unsigned int fpsr, cumulativeTraps;\r\n#ifdef CONFIG_DEBUG_USER\r\nif (flags & debug)\r\nprintk(KERN_DEBUG\r\n"NWFPE: %s[%d] takes exception %08x at %p from %08lx\n",\r\ncurrent->comm, current->pid, flags,\r\n__builtin_return_address(0), GET_USERREG()->ARM_pc);\r\n#endif\r\nfpsr = readFPSR();\r\ncumulativeTraps = 0;\r\nif ((!(fpsr & BIT_IXE)) && (flags & BIT_IXC))\r\ncumulativeTraps |= BIT_IXC;\r\nif ((!(fpsr & BIT_UFE)) && (flags & BIT_UFC))\r\ncumulativeTraps |= BIT_UFC;\r\nif ((!(fpsr & BIT_OFE)) && (flags & BIT_OFC))\r\ncumulativeTraps |= BIT_OFC;\r\nif ((!(fpsr & BIT_DZE)) && (flags & BIT_DZC))\r\ncumulativeTraps |= BIT_DZC;\r\nif ((!(fpsr & BIT_IOE)) && (flags & BIT_IOC))\r\ncumulativeTraps |= BIT_IOC;\r\nif (cumulativeTraps)\r\nwriteFPSR(fpsr | cumulativeTraps);\r\nif (fpsr & (flags << 16))\r\nfp_send_sig(SIGFPE, current, 1);\r\n}

int\r\nnvc0_instmem_suspend(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\ndev_priv->ramin_available = false;\r\nreturn 0;\r\n}\r\nvoid\r\nnvc0_instmem_resume(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nvc0_instmem_priv *priv = dev_priv->engine.instmem.priv;\r\nnv_mask(dev, 0x100c80, 0x00000001, 0x00000000);\r\nnv_wr32(dev, 0x001704, 0x80000000 | priv->bar1->ramin->vinst >> 12);\r\nnv_wr32(dev, 0x001714, 0xc0000000 | priv->bar3->ramin->vinst >> 12);\r\ndev_priv->ramin_available = true;\r\n}\r\nstatic void\r\nnvc0_channel_del(struct nouveau_channel **pchan)\r\n{\r\nstruct nouveau_channel *chan;\r\nchan = *pchan;\r\n*pchan = NULL;\r\nif (!chan)\r\nreturn;\r\nnouveau_vm_ref(NULL, &chan->vm, NULL);\r\nif (drm_mm_initialized(&chan->ramin_heap))\r\ndrm_mm_takedown(&chan->ramin_heap);\r\nnouveau_gpuobj_ref(NULL, &chan->ramin);\r\nkfree(chan);\r\n}\r\nstatic int\r\nnvc0_channel_new(struct drm_device *dev, u32 size, struct nouveau_vm *vm,\r\nstruct nouveau_channel **pchan,\r\nstruct nouveau_gpuobj *pgd, u64 vm_size)\r\n{\r\nstruct nouveau_channel *chan;\r\nint ret;\r\nchan = kzalloc(sizeof(*chan), GFP_KERNEL);\r\nif (!chan)\r\nreturn -ENOMEM;\r\nchan->dev = dev;\r\nret = nouveau_gpuobj_new(dev, NULL, size, 0x1000, 0, &chan->ramin);\r\nif (ret) {\r\nnvc0_channel_del(&chan);\r\nreturn ret;\r\n}\r\nret = drm_mm_init(&chan->ramin_heap, 0x1000, size - 0x1000);\r\nif (ret) {\r\nnvc0_channel_del(&chan);\r\nreturn ret;\r\n}\r\nret = nouveau_vm_ref(vm, &chan->vm, NULL);\r\nif (ret) {\r\nnvc0_channel_del(&chan);\r\nreturn ret;\r\n}\r\nnv_wo32(chan->ramin, 0x0200, lower_32_bits(pgd->vinst));\r\nnv_wo32(chan->ramin, 0x0204, upper_32_bits(pgd->vinst));\r\nnv_wo32(chan->ramin, 0x0208, lower_32_bits(vm_size - 1));\r\nnv_wo32(chan->ramin, 0x020c, upper_32_bits(vm_size - 1));\r\n*pchan = chan;\r\nreturn 0;\r\n}\r\nint\r\nnvc0_instmem_init(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_instmem_engine *pinstmem = &dev_priv->engine.instmem;\r\nstruct pci_dev *pdev = dev->pdev;\r\nstruct nvc0_instmem_priv *priv;\r\nstruct nouveau_vm *vm = NULL;\r\nint ret;\r\npriv = kzalloc(sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npinstmem->priv = priv;\r\nret = nouveau_vm_new(dev, 0, pci_resource_len(pdev, 3), 0,\r\n&dev_priv->bar3_vm);\r\nif (ret)\r\ngoto error;\r\nret = nouveau_gpuobj_new(dev, NULL,\r\n(pci_resource_len(pdev, 3) >> 12) * 8, 0,\r\nNVOBJ_FLAG_DONT_MAP |\r\nNVOBJ_FLAG_ZERO_ALLOC,\r\n&dev_priv->bar3_vm->pgt[0].obj[0]);\r\nif (ret)\r\ngoto error;\r\ndev_priv->bar3_vm->pgt[0].refcount[0] = 1;\r\nnv50_instmem_map(dev_priv->bar3_vm->pgt[0].obj[0]);\r\nret = nouveau_gpuobj_new(dev, NULL, 0x8000, 4096,\r\nNVOBJ_FLAG_ZERO_ALLOC, &priv->bar3_pgd);\r\nif (ret)\r\ngoto error;\r\nret = nouveau_vm_ref(dev_priv->bar3_vm, &vm, priv->bar3_pgd);\r\nif (ret)\r\ngoto error;\r\nnouveau_vm_ref(NULL, &vm, NULL);\r\nret = nvc0_channel_new(dev, 8192, dev_priv->bar3_vm, &priv->bar3,\r\npriv->bar3_pgd, pci_resource_len(dev->pdev, 3));\r\nif (ret)\r\ngoto error;\r\nret = nouveau_vm_new(dev, 0, pci_resource_len(pdev, 1), 0, &vm);\r\nif (ret)\r\ngoto error;\r\nret = nouveau_gpuobj_new(dev, NULL, 0x8000, 4096,\r\nNVOBJ_FLAG_ZERO_ALLOC, &priv->bar1_pgd);\r\nif (ret)\r\ngoto error;\r\nret = nouveau_vm_ref(vm, &dev_priv->bar1_vm, priv->bar1_pgd);\r\nif (ret)\r\ngoto error;\r\nnouveau_vm_ref(NULL, &vm, NULL);\r\nret = nvc0_channel_new(dev, 8192, dev_priv->bar1_vm, &priv->bar1,\r\npriv->bar1_pgd, pci_resource_len(dev->pdev, 1));\r\nif (ret)\r\ngoto error;\r\nret = nouveau_vm_new(dev, 0, (1ULL << 40), 0x0008000000ULL,\r\n&dev_priv->chan_vm);\r\nif (ret)\r\ngoto error;\r\nnvc0_instmem_resume(dev);\r\nreturn 0;\r\nerror:\r\nnvc0_instmem_takedown(dev);\r\nreturn ret;\r\n}\r\nvoid\r\nnvc0_instmem_takedown(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nvc0_instmem_priv *priv = dev_priv->engine.instmem.priv;\r\nstruct nouveau_vm *vm = NULL;\r\nnvc0_instmem_suspend(dev);\r\nnv_wr32(dev, 0x1704, 0x00000000);\r\nnv_wr32(dev, 0x1714, 0x00000000);\r\nnouveau_vm_ref(NULL, &dev_priv->chan_vm, NULL);\r\nnvc0_channel_del(&priv->bar1);\r\nnouveau_vm_ref(NULL, &dev_priv->bar1_vm, priv->bar1_pgd);\r\nnouveau_gpuobj_ref(NULL, &priv->bar1_pgd);\r\nnvc0_channel_del(&priv->bar3);\r\nnouveau_vm_ref(dev_priv->bar3_vm, &vm, NULL);\r\nnouveau_vm_ref(NULL, &vm, priv->bar3_pgd);\r\nnouveau_gpuobj_ref(NULL, &priv->bar3_pgd);\r\nnouveau_gpuobj_ref(NULL, &dev_priv->bar3_vm->pgt[0].obj[0]);\r\nnouveau_vm_ref(NULL, &dev_priv->bar3_vm, NULL);\r\ndev_priv->engine.instmem.priv = NULL;\r\nkfree(priv);\r\n}

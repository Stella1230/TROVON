static int s3c2412_cpufreq_calcdivs(struct s3c_cpufreq_config *cfg)\r\n{\r\nunsigned int hdiv, pdiv, armdiv, dvs;\r\nunsigned long hclk, fclk, armclk, armdiv_clk;\r\nunsigned long hclk_max;\r\nfclk = cfg->freq.fclk;\r\narmclk = cfg->freq.armclk;\r\nhclk_max = cfg->max.hclk;\r\nif (hclk_max > armclk)\r\nhclk_max = armclk;\r\ns3c_freq_dbg("%s: fclk=%lu, armclk=%lu, hclk_max=%lu\n",\r\n__func__, fclk, armclk, hclk_max);\r\ns3c_freq_dbg("%s: want f=%lu, arm=%lu, h=%lu, p=%lu\n",\r\n__func__, cfg->freq.fclk, cfg->freq.armclk,\r\ncfg->freq.hclk, cfg->freq.pclk);\r\narmdiv = fclk / armclk;\r\nif (armdiv < 1)\r\narmdiv = 1;\r\nif (armdiv > 2)\r\narmdiv = 2;\r\ncfg->divs.arm_divisor = armdiv;\r\narmdiv_clk = fclk / armdiv;\r\nhdiv = armdiv_clk / hclk_max;\r\nif (hdiv < 1)\r\nhdiv = 1;\r\ncfg->freq.hclk = hclk = armdiv_clk / hdiv;\r\ncfg->divs.dvs = dvs = armclk < armdiv_clk;\r\ncfg->freq.armclk = dvs ? hclk : armdiv_clk;\r\ns3c_freq_dbg("%s: armclk %lu, hclk %lu, armdiv %d, hdiv %d, dvs %d\n",\r\n__func__, armclk, hclk, armdiv, hdiv, cfg->divs.dvs);\r\nif (hdiv > 4)\r\ngoto invalid;\r\npdiv = (hclk > cfg->max.pclk) ? 2 : 1;\r\nif ((hclk / pdiv) > cfg->max.pclk)\r\npdiv++;\r\ncfg->freq.pclk = hclk / pdiv;\r\ns3c_freq_dbg("%s: pdiv %d\n", __func__, pdiv);\r\nif (pdiv > 2)\r\ngoto invalid;\r\npdiv *= hdiv;\r\ncfg->divs.h_divisor = hdiv * armdiv;\r\ncfg->divs.p_divisor = pdiv * armdiv;\r\nreturn 0;\r\ninvalid:\r\nreturn -EINVAL;\r\n}\r\nstatic void s3c2412_cpufreq_setdivs(struct s3c_cpufreq_config *cfg)\r\n{\r\nunsigned long clkdiv;\r\nunsigned long olddiv;\r\nolddiv = clkdiv = __raw_readl(S3C2410_CLKDIVN);\r\nclkdiv &= ~S3C2412_CLKDIVN_ARMDIVN;\r\nclkdiv &= ~S3C2412_CLKDIVN_HDIVN_MASK;\r\nclkdiv &= ~S3C2412_CLKDIVN_PDIVN;\r\nif (cfg->divs.arm_divisor == 2)\r\nclkdiv |= S3C2412_CLKDIVN_ARMDIVN;\r\nclkdiv |= ((cfg->divs.h_divisor / cfg->divs.arm_divisor) - 1);\r\nif (cfg->divs.p_divisor != cfg->divs.h_divisor)\r\nclkdiv |= S3C2412_CLKDIVN_PDIVN;\r\ns3c_freq_dbg("%s: div %08lx => %08lx\n", __func__, olddiv, clkdiv);\r\n__raw_writel(clkdiv, S3C2410_CLKDIVN);\r\nclk_set_parent(armclk, cfg->divs.dvs ? hclk : fclk);\r\n}\r\nstatic void s3c2412_cpufreq_setrefresh(struct s3c_cpufreq_config *cfg)\r\n{\r\nstruct s3c_cpufreq_board *board = cfg->board;\r\nunsigned long refresh;\r\ns3c_freq_dbg("%s: refresh %u ns, hclk %lu\n", __func__,\r\nboard->refresh, cfg->freq.hclk);\r\nrefresh = (board->refresh / 10);\r\nrefresh *= (cfg->freq.hclk / 100);\r\nrefresh /= (1 * 1000 * 1000);\r\ns3c_freq_dbg("%s: setting refresh 0x%08lx\n", __func__, refresh);\r\n__raw_writel(refresh, S3C2412_REFRESH);\r\n}\r\nstatic int s3c2412_cpufreq_add(struct sys_device *sysdev)\r\n{\r\nunsigned long fclk_rate;\r\nhclk = clk_get(NULL, "hclk");\r\nif (IS_ERR(hclk)) {\r\nprintk(KERN_ERR "%s: cannot find hclk clock\n", __func__);\r\nreturn -ENOENT;\r\n}\r\nfclk = clk_get(NULL, "fclk");\r\nif (IS_ERR(fclk)) {\r\nprintk(KERN_ERR "%s: cannot find fclk clock\n", __func__);\r\ngoto err_fclk;\r\n}\r\nfclk_rate = clk_get_rate(fclk);\r\nif (fclk_rate > 200000000) {\r\nprintk(KERN_INFO\r\n"%s: fclk %ld MHz, assuming 266MHz capable part\n",\r\n__func__, fclk_rate / 1000000);\r\ns3c2412_cpufreq_info.max.fclk = 266000000;\r\ns3c2412_cpufreq_info.max.hclk = 133000000;\r\ns3c2412_cpufreq_info.max.pclk = 66000000;\r\n}\r\narmclk = clk_get(NULL, "armclk");\r\nif (IS_ERR(armclk)) {\r\nprintk(KERN_ERR "%s: cannot find arm clock\n", __func__);\r\ngoto err_armclk;\r\n}\r\nxtal = clk_get(NULL, "xtal");\r\nif (IS_ERR(xtal)) {\r\nprintk(KERN_ERR "%s: cannot find xtal clock\n", __func__);\r\ngoto err_xtal;\r\n}\r\nreturn s3c_cpufreq_register(&s3c2412_cpufreq_info);\r\nerr_xtal:\r\nclk_put(armclk);\r\nerr_armclk:\r\nclk_put(fclk);\r\nerr_fclk:\r\nclk_put(hclk);\r\nreturn -ENOENT;\r\n}\r\nstatic int s3c2412_cpufreq_init(void)\r\n{\r\nreturn sysdev_driver_register(&s3c2412_sysclass,\r\n&s3c2412_cpufreq_driver);\r\n}

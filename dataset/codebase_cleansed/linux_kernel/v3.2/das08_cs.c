static int das08_cs_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nint ret;\r\nunsigned long iobase;\r\nstruct pcmcia_device *link = cur_dev;\r\nret = alloc_private(dev, sizeof(struct das08_private_struct));\r\nif (ret < 0)\r\nreturn ret;\r\nprintk("comedi%d: das08_cs: ", dev->minor);\r\nif (thisboard->bustype == pcmcia) {\r\nif (link == NULL) {\r\nprintk(" no pcmcia cards found\n");\r\nreturn -EIO;\r\n}\r\niobase = link->resource[0]->start;\r\n} else {\r\nprintk(" bug! board does not have PCMCIA bustype\n");\r\nreturn -EINVAL;\r\n}\r\nprintk("\n");\r\nreturn das08_common_attach(dev, iobase);\r\n}\r\nstatic int das08_pcmcia_attach(struct pcmcia_device *link)\r\n{\r\nstruct local_info_t *local;\r\ndev_dbg(&link->dev, "das08_pcmcia_attach()\n");\r\nlocal = kzalloc(sizeof(struct local_info_t), GFP_KERNEL);\r\nif (!local)\r\nreturn -ENOMEM;\r\nlocal->link = link;\r\nlink->priv = local;\r\ncur_dev = link;\r\ndas08_pcmcia_config(link);\r\nreturn 0;\r\n}\r\nstatic void das08_pcmcia_detach(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "das08_pcmcia_detach\n");\r\n((struct local_info_t *)link->priv)->stop = 1;\r\ndas08_pcmcia_release(link);\r\nkfree(link->priv);\r\n}\r\nstatic int das08_pcmcia_config_loop(struct pcmcia_device *p_dev,\r\nvoid *priv_data)\r\n{\r\nif (p_dev->config_index == 0)\r\nreturn -EINVAL;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic void das08_pcmcia_config(struct pcmcia_device *link)\r\n{\r\nint ret;\r\ndev_dbg(&link->dev, "das08_pcmcia_config\n");\r\nlink->config_flags |= CONF_ENABLE_IRQ | CONF_AUTO_SET_IO;\r\nret = pcmcia_loop_config(link, das08_pcmcia_config_loop, NULL);\r\nif (ret) {\r\ndev_warn(&link->dev, "no configuration found\n");\r\ngoto failed;\r\n}\r\nif (!link->irq)\r\ngoto failed;\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\nreturn;\r\nfailed:\r\ndas08_pcmcia_release(link);\r\n}\r\nstatic void das08_pcmcia_release(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "das08_pcmcia_release\n");\r\npcmcia_disable_device(link);\r\n}\r\nstatic int das08_pcmcia_suspend(struct pcmcia_device *link)\r\n{\r\nstruct local_info_t *local = link->priv;\r\nlocal->stop = 1;\r\nreturn 0;\r\n}\r\nstatic int das08_pcmcia_resume(struct pcmcia_device *link)\r\n{\r\nstruct local_info_t *local = link->priv;\r\nlocal->stop = 0;\r\nreturn 0;\r\n}\r\nstatic int __init init_das08_pcmcia_cs(void)\r\n{\r\npcmcia_register_driver(&das08_cs_driver);\r\nreturn 0;\r\n}\r\nstatic void __exit exit_das08_pcmcia_cs(void)\r\n{\r\npr_debug("das08_pcmcia_cs: unloading\n");\r\npcmcia_unregister_driver(&das08_cs_driver);\r\n}\r\nstatic int __init das08_cs_init_module(void)\r\n{\r\nint ret;\r\nret = init_das08_pcmcia_cs();\r\nif (ret < 0)\r\nreturn ret;\r\nreturn comedi_driver_register(&driver_das08_cs);\r\n}\r\nstatic void __exit das08_cs_exit_module(void)\r\n{\r\nexit_das08_pcmcia_cs();\r\ncomedi_driver_unregister(&driver_das08_cs);\r\n}

static inline int max8925_read_device(struct i2c_client *i2c,\r\nint reg, int bytes, void *dest)\r\n{\r\nint ret;\r\nif (bytes > 1)\r\nret = i2c_smbus_read_i2c_block_data(i2c, reg, bytes, dest);\r\nelse {\r\nret = i2c_smbus_read_byte_data(i2c, reg);\r\nif (ret < 0)\r\nreturn ret;\r\n*(unsigned char *)dest = (unsigned char)ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic inline int max8925_write_device(struct i2c_client *i2c,\r\nint reg, int bytes, void *src)\r\n{\r\nunsigned char buf[bytes + 1];\r\nint ret;\r\nbuf[0] = (unsigned char)reg;\r\nmemcpy(&buf[1], src, bytes);\r\nret = i2c_master_send(i2c, buf, bytes + 1);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint max8925_reg_read(struct i2c_client *i2c, int reg)\r\n{\r\nstruct max8925_chip *chip = i2c_get_clientdata(i2c);\r\nunsigned char data = 0;\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = max8925_read_device(i2c, reg, 1, &data);\r\nmutex_unlock(&chip->io_lock);\r\nif (ret < 0)\r\nreturn ret;\r\nelse\r\nreturn (int)data;\r\n}\r\nint max8925_reg_write(struct i2c_client *i2c, int reg,\r\nunsigned char data)\r\n{\r\nstruct max8925_chip *chip = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = max8925_write_device(i2c, reg, 1, &data);\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nint max8925_bulk_read(struct i2c_client *i2c, int reg,\r\nint count, unsigned char *buf)\r\n{\r\nstruct max8925_chip *chip = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = max8925_read_device(i2c, reg, count, buf);\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nint max8925_bulk_write(struct i2c_client *i2c, int reg,\r\nint count, unsigned char *buf)\r\n{\r\nstruct max8925_chip *chip = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = max8925_write_device(i2c, reg, count, buf);\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nint max8925_set_bits(struct i2c_client *i2c, int reg,\r\nunsigned char mask, unsigned char data)\r\n{\r\nstruct max8925_chip *chip = i2c_get_clientdata(i2c);\r\nunsigned char value;\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = max8925_read_device(i2c, reg, 1, &value);\r\nif (ret < 0)\r\ngoto out;\r\nvalue &= ~mask;\r\nvalue |= data;\r\nret = max8925_write_device(i2c, reg, 1, &value);\r\nout:\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nstatic int __devinit max8925_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct max8925_platform_data *pdata = client->dev.platform_data;\r\nstatic struct max8925_chip *chip;\r\nif (!pdata) {\r\npr_info("%s: platform data is missing\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nchip = kzalloc(sizeof(struct max8925_chip), GFP_KERNEL);\r\nif (chip == NULL)\r\nreturn -ENOMEM;\r\nchip->i2c = client;\r\nchip->dev = &client->dev;\r\ni2c_set_clientdata(client, chip);\r\ndev_set_drvdata(chip->dev, chip);\r\nmutex_init(&chip->io_lock);\r\nchip->rtc = i2c_new_dummy(chip->i2c->adapter, RTC_I2C_ADDR);\r\ni2c_set_clientdata(chip->rtc, chip);\r\nchip->adc = i2c_new_dummy(chip->i2c->adapter, ADC_I2C_ADDR);\r\ni2c_set_clientdata(chip->adc, chip);\r\nmax8925_device_init(chip, pdata);\r\nreturn 0;\r\n}\r\nstatic int __devexit max8925_remove(struct i2c_client *client)\r\n{\r\nstruct max8925_chip *chip = i2c_get_clientdata(client);\r\nmax8925_device_exit(chip);\r\ni2c_unregister_device(chip->adc);\r\ni2c_unregister_device(chip->rtc);\r\nkfree(chip);\r\nreturn 0;\r\n}\r\nstatic int __init max8925_i2c_init(void)\r\n{\r\nint ret;\r\nret = i2c_add_driver(&max8925_driver);\r\nif (ret != 0)\r\npr_err("Failed to register MAX8925 I2C driver: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void __exit max8925_i2c_exit(void)\r\n{\r\ni2c_del_driver(&max8925_driver);\r\n}

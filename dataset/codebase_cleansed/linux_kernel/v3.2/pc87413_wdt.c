static inline void pc87413_select_wdt_out(void)\r\n{\r\nunsigned int cr_data = 0;\r\noutb_p(SIOCFG2, WDT_INDEX_IO_PORT);\r\ncr_data = inb(WDT_DATA_IO_PORT);\r\ncr_data |= 0x80;\r\noutb_p(SIOCFG2, WDT_INDEX_IO_PORT);\r\noutb_p(cr_data, WDT_DATA_IO_PORT);\r\n#ifdef DEBUG\r\nprintk(KERN_INFO DPFX\r\n"Select multiple pin,pin55,as WDT output: Bit7 to 1: %d\n",\r\ncr_data);\r\n#endif\r\n}\r\nstatic inline void pc87413_enable_swc(void)\r\n{\r\nunsigned int cr_data = 0;\r\noutb_p(0x07, WDT_INDEX_IO_PORT);\r\noutb_p(SWC_LDN, WDT_DATA_IO_PORT);\r\noutb_p(0x30, WDT_INDEX_IO_PORT);\r\ncr_data = inb(WDT_DATA_IO_PORT);\r\ncr_data |= 0x01;\r\noutb_p(0x30, WDT_INDEX_IO_PORT);\r\noutb_p(cr_data, WDT_DATA_IO_PORT);\r\n#ifdef DEBUG\r\nprintk(KERN_INFO DPFX "pc87413 - Enable SWC functions\n");\r\n#endif\r\n}\r\nstatic void pc87413_get_swc_base_addr(void)\r\n{\r\nunsigned char addr_l, addr_h = 0;\r\noutb_p(0x60, WDT_INDEX_IO_PORT);\r\naddr_h = inb(WDT_DATA_IO_PORT);\r\noutb_p(0x61, WDT_INDEX_IO_PORT);\r\naddr_l = inb(WDT_DATA_IO_PORT);\r\nswc_base_addr = (addr_h << 8) + addr_l;\r\n#ifdef DEBUG\r\nprintk(KERN_INFO DPFX\r\n"Read SWC I/O Base Address: low %d, high %d, res %d\n",\r\naddr_l, addr_h, swc_base_addr);\r\n#endif\r\n}\r\nstatic inline void pc87413_swc_bank3(void)\r\n{\r\noutb_p(inb(swc_base_addr + 0x0f) | 0x03, swc_base_addr + 0x0f);\r\n#ifdef DEBUG\r\nprintk(KERN_INFO DPFX "Select Bank3 of SWC\n");\r\n#endif\r\n}\r\nstatic inline void pc87413_programm_wdto(char pc87413_time)\r\n{\r\noutb_p(pc87413_time, swc_base_addr + WDTO);\r\n#ifdef DEBUG\r\nprintk(KERN_INFO DPFX "Set WDTO to %d minutes\n", pc87413_time);\r\n#endif\r\n}\r\nstatic inline void pc87413_enable_wden(void)\r\n{\r\noutb_p(inb(swc_base_addr + WDCTL) | 0x01, swc_base_addr + WDCTL);\r\n#ifdef DEBUG\r\nprintk(KERN_INFO DPFX "Enable WDEN\n");\r\n#endif\r\n}\r\nstatic inline void pc87413_enable_sw_wd_tren(void)\r\n{\r\noutb_p(inb(swc_base_addr + WDCFG) | 0x80, swc_base_addr + WDCFG);\r\n#ifdef DEBUG\r\nprintk(KERN_INFO DPFX "Enable SW_WD_TREN\n");\r\n#endif\r\n}\r\nstatic inline void pc87413_disable_sw_wd_tren(void)\r\n{\r\noutb_p(inb(swc_base_addr + WDCFG) & 0x7f, swc_base_addr + WDCFG);\r\n#ifdef DEBUG\r\nprintk(KERN_INFO DPFX "pc87413 - Disable SW_WD_TREN\n");\r\n#endif\r\n}\r\nstatic inline void pc87413_enable_sw_wd_trg(void)\r\n{\r\noutb_p(inb(swc_base_addr + WDCTL) | 0x80, swc_base_addr + WDCTL);\r\n#ifdef DEBUG\r\nprintk(KERN_INFO DPFX "pc87413 - Enable SW_WD_TRG\n");\r\n#endif\r\n}\r\nstatic inline void pc87413_disable_sw_wd_trg(void)\r\n{\r\noutb_p(inb(swc_base_addr + WDCTL) & 0x7f, swc_base_addr + WDCTL);\r\n#ifdef DEBUG\r\nprintk(KERN_INFO DPFX "Disable SW_WD_TRG\n");\r\n#endif\r\n}\r\nstatic void pc87413_enable(void)\r\n{\r\nspin_lock(&io_lock);\r\npc87413_swc_bank3();\r\npc87413_programm_wdto(timeout);\r\npc87413_enable_wden();\r\npc87413_enable_sw_wd_tren();\r\npc87413_enable_sw_wd_trg();\r\nspin_unlock(&io_lock);\r\n}\r\nstatic void pc87413_disable(void)\r\n{\r\nspin_lock(&io_lock);\r\npc87413_swc_bank3();\r\npc87413_disable_sw_wd_tren();\r\npc87413_disable_sw_wd_trg();\r\npc87413_programm_wdto(0);\r\nspin_unlock(&io_lock);\r\n}\r\nstatic void pc87413_refresh(void)\r\n{\r\nspin_lock(&io_lock);\r\npc87413_swc_bank3();\r\npc87413_disable_sw_wd_tren();\r\npc87413_disable_sw_wd_trg();\r\npc87413_programm_wdto(timeout);\r\npc87413_enable_wden();\r\npc87413_enable_sw_wd_tren();\r\npc87413_enable_sw_wd_trg();\r\nspin_unlock(&io_lock);\r\n}\r\nstatic int pc87413_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &timer_enabled))\r\nreturn -EBUSY;\r\nif (nowayout)\r\n__module_get(THIS_MODULE);\r\npc87413_refresh();\r\nprintk(KERN_INFO MODNAME\r\n"Watchdog enabled. Timeout set to %d minute(s).\n", timeout);\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int pc87413_release(struct inode *inode, struct file *file)\r\n{\r\nif (expect_close == 42) {\r\npc87413_disable();\r\nprintk(KERN_INFO MODNAME\r\n"Watchdog disabled, sleeping again...\n");\r\n} else {\r\nprintk(KERN_CRIT MODNAME\r\n"Unexpected close, not stopping watchdog!\n");\r\npc87413_refresh();\r\n}\r\nclear_bit(0, &timer_enabled);\r\nexpect_close = 0;\r\nreturn 0;\r\n}\r\nstatic int pc87413_status(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic ssize_t pc87413_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nif (!nowayout) {\r\nsize_t i;\r\nexpect_close = 0;\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nexpect_close = 42;\r\n}\r\n}\r\npc87413_refresh();\r\n}\r\nreturn len;\r\n}\r\nstatic long pc87413_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint new_timeout;\r\nunion {\r\nstruct watchdog_info __user *ident;\r\nint __user *i;\r\n} uarg;\r\nstatic const struct watchdog_info ident = {\r\n.options = WDIOF_KEEPALIVEPING |\r\nWDIOF_SETTIMEOUT |\r\nWDIOF_MAGICCLOSE,\r\n.firmware_version = 1,\r\n.identity = "PC87413(HF/F) watchdog",\r\n};\r\nuarg.i = (int __user *)arg;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nreturn copy_to_user(uarg.ident, &ident,\r\nsizeof(ident)) ? -EFAULT : 0;\r\ncase WDIOC_GETSTATUS:\r\nreturn put_user(pc87413_status(), uarg.i);\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, uarg.i);\r\ncase WDIOC_SETOPTIONS:\r\n{\r\nint options, retval = -EINVAL;\r\nif (get_user(options, uarg.i))\r\nreturn -EFAULT;\r\nif (options & WDIOS_DISABLECARD) {\r\npc87413_disable();\r\nretval = 0;\r\n}\r\nif (options & WDIOS_ENABLECARD) {\r\npc87413_enable();\r\nretval = 0;\r\n}\r\nreturn retval;\r\n}\r\ncase WDIOC_KEEPALIVE:\r\npc87413_refresh();\r\n#ifdef DEBUG\r\nprintk(KERN_INFO DPFX "keepalive\n");\r\n#endif\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT:\r\nif (get_user(new_timeout, uarg.i))\r\nreturn -EFAULT;\r\nnew_timeout /= 60;\r\nif (new_timeout < 0 || new_timeout > MAX_TIMEOUT)\r\nreturn -EINVAL;\r\ntimeout = new_timeout;\r\npc87413_refresh();\r\ncase WDIOC_GETTIMEOUT:\r\nnew_timeout = timeout * 60;\r\nreturn put_user(new_timeout, uarg.i);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\n}\r\nstatic int pc87413_notify_sys(struct notifier_block *this,\r\nunsigned long code,\r\nvoid *unused)\r\n{\r\nif (code == SYS_DOWN || code == SYS_HALT)\r\npc87413_disable();\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init pc87413_init(void)\r\n{\r\nint ret;\r\nprintk(KERN_INFO PFX "Version " VERSION " at io 0x%X\n",\r\nWDT_INDEX_IO_PORT);\r\nif (!request_muxed_region(io, 2, MODNAME))\r\nreturn -EBUSY;\r\nret = register_reboot_notifier(&pc87413_notifier);\r\nif (ret != 0) {\r\nprintk(KERN_ERR PFX\r\n"cannot register reboot notifier (err=%d)\n", ret);\r\n}\r\nret = misc_register(&pc87413_miscdev);\r\nif (ret != 0) {\r\nprintk(KERN_ERR PFX\r\n"cannot register miscdev on minor=%d (err=%d)\n",\r\nWATCHDOG_MINOR, ret);\r\ngoto reboot_unreg;\r\n}\r\nprintk(KERN_INFO PFX "initialized. timeout=%d min \n", timeout);\r\npc87413_select_wdt_out();\r\npc87413_enable_swc();\r\npc87413_get_swc_base_addr();\r\nif (!request_region(swc_base_addr, 0x20, MODNAME)) {\r\nprintk(KERN_ERR PFX\r\n"cannot request SWC region at 0x%x\n", swc_base_addr);\r\nret = -EBUSY;\r\ngoto misc_unreg;\r\n}\r\npc87413_enable();\r\nrelease_region(io, 2);\r\nreturn 0;\r\nmisc_unreg:\r\nmisc_deregister(&pc87413_miscdev);\r\nreboot_unreg:\r\nunregister_reboot_notifier(&pc87413_notifier);\r\nrelease_region(io, 2);\r\nreturn ret;\r\n}\r\nstatic void __exit pc87413_exit(void)\r\n{\r\nif (!nowayout) {\r\npc87413_disable();\r\nprintk(KERN_INFO MODNAME "Watchdog disabled.\n");\r\n}\r\nmisc_deregister(&pc87413_miscdev);\r\nunregister_reboot_notifier(&pc87413_notifier);\r\nrelease_region(swc_base_addr, 0x20);\r\nprintk(KERN_INFO MODNAME " watchdog component driver removed.\n");\r\n}

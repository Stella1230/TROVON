static int i2c_writebytes (struct nxt200x_state* state, u8 addr, u8 *buf, u8 len)\r\n{\r\nint err;\r\nstruct i2c_msg msg = { .addr = addr, .flags = 0, .buf = buf, .len = len };\r\nif ((err = i2c_transfer (state->i2c, &msg, 1)) != 1) {\r\nprintk (KERN_WARNING "nxt200x: %s: i2c write error (addr 0x%02x, err == %i)\n",\r\n__func__, addr, err);\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int i2c_readbytes(struct nxt200x_state *state, u8 addr, u8 *buf, u8 len)\r\n{\r\nint err;\r\nstruct i2c_msg msg = { .addr = addr, .flags = I2C_M_RD, .buf = buf, .len = len };\r\nif ((err = i2c_transfer (state->i2c, &msg, 1)) != 1) {\r\nprintk (KERN_WARNING "nxt200x: %s: i2c read error (addr 0x%02x, err == %i)\n",\r\n__func__, addr, err);\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int nxt200x_writebytes (struct nxt200x_state* state, u8 reg,\r\nconst u8 *buf, u8 len)\r\n{\r\nu8 buf2 [len+1];\r\nint err;\r\nstruct i2c_msg msg = { .addr = state->config->demod_address, .flags = 0, .buf = buf2, .len = len + 1 };\r\nbuf2[0] = reg;\r\nmemcpy(&buf2[1], buf, len);\r\nif ((err = i2c_transfer (state->i2c, &msg, 1)) != 1) {\r\nprintk (KERN_WARNING "nxt200x: %s: i2c write error (addr 0x%02x, err == %i)\n",\r\n__func__, state->config->demod_address, err);\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int nxt200x_readbytes(struct nxt200x_state *state, u8 reg, u8 *buf, u8 len)\r\n{\r\nu8 reg2 [] = { reg };\r\nstruct i2c_msg msg [] = { { .addr = state->config->demod_address, .flags = 0, .buf = reg2, .len = 1 },\r\n{ .addr = state->config->demod_address, .flags = I2C_M_RD, .buf = buf, .len = len } };\r\nint err;\r\nif ((err = i2c_transfer (state->i2c, msg, 2)) != 2) {\r\nprintk (KERN_WARNING "nxt200x: %s: i2c read error (addr 0x%02x, err == %i)\n",\r\n__func__, state->config->demod_address, err);\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic u16 nxt200x_crc(u16 crc, u8 c)\r\n{\r\nu8 i;\r\nu16 input = (u16) c & 0xFF;\r\ninput<<=8;\r\nfor(i=0; i<8; i++) {\r\nif((crc^input) & 0x8000)\r\ncrc=(crc<<1)^CRC_CCIT_MASK;\r\nelse\r\ncrc<<=1;\r\ninput<<=1;\r\n}\r\nreturn crc;\r\n}\r\nstatic int nxt200x_writereg_multibyte (struct nxt200x_state* state, u8 reg, u8* data, u8 len)\r\n{\r\nu8 attr, len2, buf;\r\ndprintk("%s\n", __func__);\r\nnxt200x_writebytes(state, 0x35, &reg, 1);\r\nnxt200x_writebytes(state, 0x36, data, len);\r\nswitch (state->demod_chip) {\r\ncase NXT2002:\r\nlen2 = len;\r\nbuf = 0x02;\r\nbreak;\r\ncase NXT2004:\r\nattr = 0x02;\r\nif (reg & 0x80) {\r\nattr = attr << 1;\r\nif (reg & 0x04)\r\nattr = attr >> 1;\r\n}\r\nlen2 = ((attr << 4) | 0x10) | len;\r\nbuf = 0x80;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nnxt200x_writebytes(state, 0x34, &len2, 1);\r\nnxt200x_writebytes(state, 0x21, &buf, 1);\r\nnxt200x_readbytes(state, 0x21, &buf, 1);\r\nswitch (state->demod_chip) {\r\ncase NXT2002:\r\nif ((buf & 0x02) == 0)\r\nreturn 0;\r\nbreak;\r\ncase NXT2004:\r\nif (buf == 0)\r\nreturn 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nprintk(KERN_WARNING "nxt200x: Error writing multireg register 0x%02X\n",reg);\r\nreturn 0;\r\n}\r\nstatic int nxt200x_readreg_multibyte (struct nxt200x_state* state, u8 reg, u8* data, u8 len)\r\n{\r\nint i;\r\nu8 buf, len2, attr;\r\ndprintk("%s\n", __func__);\r\nnxt200x_writebytes(state, 0x35, &reg, 1);\r\nswitch (state->demod_chip) {\r\ncase NXT2002:\r\nlen2 = len & 0x80;\r\nnxt200x_writebytes(state, 0x34, &len2, 1);\r\nnxt200x_readbytes(state, reg, data, len);\r\nreturn 0;\r\nbreak;\r\ncase NXT2004:\r\nattr = 0x02;\r\nif (reg & 0x80) {\r\nattr = attr << 1;\r\nif (reg & 0x04)\r\nattr = attr >> 1;\r\n}\r\nlen2 = (attr << 4) | len;\r\nnxt200x_writebytes(state, 0x34, &len2, 1);\r\nbuf = 0x80;\r\nnxt200x_writebytes(state, 0x21, &buf, 1);\r\nfor(i = 0; i < len; i++) {\r\nnxt200x_readbytes(state, 0x36 + i, &data[i], 1);\r\n}\r\nreturn 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\n}\r\nstatic void nxt200x_microcontroller_stop (struct nxt200x_state* state)\r\n{\r\nu8 buf, stopval, counter = 0;\r\ndprintk("%s\n", __func__);\r\nswitch (state->demod_chip) {\r\ncase NXT2002:\r\nstopval = 0x40;\r\nbreak;\r\ncase NXT2004:\r\nstopval = 0x10;\r\nbreak;\r\ndefault:\r\nstopval = 0;\r\nbreak;\r\n}\r\nbuf = 0x80;\r\nnxt200x_writebytes(state, 0x22, &buf, 1);\r\nwhile (counter < 20) {\r\nnxt200x_readbytes(state, 0x31, &buf, 1);\r\nif (buf & stopval)\r\nreturn;\r\nmsleep(10);\r\ncounter++;\r\n}\r\nprintk(KERN_WARNING "nxt200x: Timeout waiting for nxt200x to stop. This is ok after firmware upload.\n");\r\nreturn;\r\n}\r\nstatic void nxt200x_microcontroller_start (struct nxt200x_state* state)\r\n{\r\nu8 buf;\r\ndprintk("%s\n", __func__);\r\nbuf = 0x00;\r\nnxt200x_writebytes(state, 0x22, &buf, 1);\r\n}\r\nstatic void nxt2004_microcontroller_init (struct nxt200x_state* state)\r\n{\r\nu8 buf[9];\r\nu8 counter = 0;\r\ndprintk("%s\n", __func__);\r\nbuf[0] = 0x00;\r\nnxt200x_writebytes(state, 0x2b, buf, 1);\r\nbuf[0] = 0x70;\r\nnxt200x_writebytes(state, 0x34, buf, 1);\r\nbuf[0] = 0x04;\r\nnxt200x_writebytes(state, 0x35, buf, 1);\r\nbuf[0] = 0x01; buf[1] = 0x23; buf[2] = 0x45; buf[3] = 0x67; buf[4] = 0x89;\r\nbuf[5] = 0xAB; buf[6] = 0xCD; buf[7] = 0xEF; buf[8] = 0xC0;\r\nnxt200x_writebytes(state, 0x36, buf, 9);\r\nbuf[0] = 0x80;\r\nnxt200x_writebytes(state, 0x21, buf, 1);\r\nwhile (counter < 20) {\r\nnxt200x_readbytes(state, 0x21, buf, 1);\r\nif (buf[0] == 0)\r\nreturn;\r\nmsleep(10);\r\ncounter++;\r\n}\r\nprintk(KERN_WARNING "nxt200x: Timeout waiting for nxt2004 to init.\n");\r\nreturn;\r\n}\r\nstatic int nxt200x_writetuner (struct nxt200x_state* state, u8* data)\r\n{\r\nu8 buf, count = 0;\r\ndprintk("%s\n", __func__);\r\ndprintk("Tuner Bytes: %02X %02X %02X %02X\n", data[1], data[2], data[3], data[4]);\r\nswitch (state->demod_chip) {\r\ncase NXT2004:\r\nif (i2c_writebytes(state, data[0], data+1, 4))\r\nprintk(KERN_WARNING "nxt200x: error writing to tuner\n");\r\nwhile (count < 20) {\r\ni2c_readbytes(state, data[0], &buf, 1);\r\nif (buf & 0x40)\r\nreturn 0;\r\nmsleep(100);\r\ncount++;\r\n}\r\nprintk("nxt2004: timeout waiting for tuner lock\n");\r\nbreak;\r\ncase NXT2002:\r\nbuf = 0x03;\r\nnxt200x_writebytes(state, 0x20, &buf, 1);\r\nbuf = 0x04;\r\nnxt200x_writebytes(state, 0x34, &buf, 1);\r\nnxt200x_writebytes(state, 0x36, data+1, 4);\r\nbuf = data[0] << 1;\r\nnxt200x_writebytes(state, 0x35, &buf, 1);\r\nbuf = 0x80;\r\nnxt200x_writebytes(state, 0x21, &buf, 1);\r\nwhile (count < 20) {\r\nnxt200x_readbytes(state, 0x21, &buf, 1);\r\nif ((buf & 0x80)== 0x00)\r\nreturn 0;\r\nmsleep(100);\r\ncount++;\r\n}\r\nprintk("nxt2002: timeout error writing tuner\n");\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic void nxt200x_agc_reset(struct nxt200x_state* state)\r\n{\r\nu8 buf;\r\ndprintk("%s\n", __func__);\r\nswitch (state->demod_chip) {\r\ncase NXT2002:\r\nbuf = 0x08;\r\nnxt200x_writebytes(state, 0x08, &buf, 1);\r\nbuf = 0x00;\r\nnxt200x_writebytes(state, 0x08, &buf, 1);\r\nbreak;\r\ncase NXT2004:\r\nnxt200x_readreg_multibyte(state, 0x08, &buf, 1);\r\nbuf = 0x08;\r\nnxt200x_writereg_multibyte(state, 0x08, &buf, 1);\r\nbuf = 0x00;\r\nnxt200x_writereg_multibyte(state, 0x08, &buf, 1);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn;\r\n}\r\nstatic int nxt2002_load_firmware (struct dvb_frontend* fe, const struct firmware *fw)\r\n{\r\nstruct nxt200x_state* state = fe->demodulator_priv;\r\nu8 buf[3], written = 0, chunkpos = 0;\r\nu16 rambase, position, crc = 0;\r\ndprintk("%s\n", __func__);\r\ndprintk("Firmware is %zu bytes\n", fw->size);\r\nnxt200x_readbytes(state, 0x10, buf, 1);\r\nif (buf[0] & 0x10)\r\nrambase = 0x1000;\r\nelse\r\nrambase = 0x0000;\r\ndprintk("rambase on this nxt2002 is %04X\n", rambase);\r\nbuf[0] = 0x80;\r\nnxt200x_writebytes(state, 0x2B, buf, 1);\r\nfor (position = 0; position < fw->size; position++) {\r\nif (written == 0) {\r\ncrc = 0;\r\nchunkpos = 0x28;\r\nbuf[0] = ((rambase + position) >> 8);\r\nbuf[1] = (rambase + position) & 0xFF;\r\nbuf[2] = 0x81;\r\nnxt200x_writebytes(state, 0x29, buf, 3);\r\n}\r\nwritten++;\r\nchunkpos++;\r\nif ((written % 4) == 0)\r\nnxt200x_writebytes(state, chunkpos, &fw->data[position-3], 4);\r\ncrc = nxt200x_crc(crc, fw->data[position]);\r\nif ((written == 255) || (position+1 == fw->size)) {\r\nnxt200x_writebytes(state, chunkpos+4-(written %4),\r\n&fw->data[position-(written %4) + 1],\r\nwritten %4);\r\nbuf[0] = crc << 8;\r\nbuf[1] = crc & 0xFF;\r\nnxt200x_writebytes(state, 0x2C, buf, 2);\r\nnxt200x_readbytes(state, 0x2A, buf, 1);\r\nbuf[0] = 0x80;\r\nnxt200x_writebytes(state, 0x2B, buf, 1);\r\nwritten = 0;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int nxt2004_load_firmware (struct dvb_frontend* fe, const struct firmware *fw)\r\n{\r\nstruct nxt200x_state* state = fe->demodulator_priv;\r\nu8 buf[3];\r\nu16 rambase, position, crc=0;\r\ndprintk("%s\n", __func__);\r\ndprintk("Firmware is %zu bytes\n", fw->size);\r\nrambase = 0x1000;\r\nbuf[0] = 0x80;\r\nnxt200x_writebytes(state, 0x2B, buf,1);\r\nfor (position = 0; position < fw->size; position++) {\r\ncrc = nxt200x_crc(crc, fw->data[position]);\r\n}\r\nbuf[0] = rambase >> 8;\r\nbuf[1] = rambase & 0xFF;\r\nbuf[2] = 0x81;\r\nnxt200x_writebytes(state,0x29,buf,3);\r\nfor (position = 0; position < fw->size;) {\r\nnxt200x_writebytes(state, 0x2C, &fw->data[position],\r\nfw->size-position > 255 ? 255 : fw->size-position);\r\nposition += (fw->size-position > 255 ? 255 : fw->size-position);\r\n}\r\nbuf[0] = crc >> 8;\r\nbuf[1] = crc & 0xFF;\r\ndprintk("firmware crc is 0x%02X 0x%02X\n", buf[0], buf[1]);\r\nnxt200x_writebytes(state, 0x2C, buf,2);\r\nnxt200x_readbytes(state, 0x2C, buf, 1);\r\nbuf[0] = 0x80;\r\nnxt200x_writebytes(state, 0x2B, buf,1);\r\nreturn 0;\r\n}\r\nstatic int nxt200x_setup_frontend_parameters (struct dvb_frontend* fe,\r\nstruct dvb_frontend_parameters *p)\r\n{\r\nstruct nxt200x_state* state = fe->demodulator_priv;\r\nu8 buf[5];\r\nnxt200x_microcontroller_stop(state);\r\nif (state->demod_chip == NXT2004) {\r\nbuf[0] = 0x04;\r\nnxt200x_writebytes(state, 0x14, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writebytes(state, 0x17, buf, 1);\r\n}\r\nswitch (p->u.vsb.modulation) {\r\ncase QAM_64:\r\ncase QAM_256:\r\nif (state->config->set_ts_params)\r\nstate->config->set_ts_params(fe, 1);\r\nbreak;\r\ncase VSB_8:\r\nif (state->config->set_ts_params)\r\nstate->config->set_ts_params(fe, 0);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nif (fe->ops.tuner_ops.calc_regs) {\r\nfe->ops.tuner_ops.calc_regs(fe, p, buf, 5);\r\nnxt200x_writetuner(state, buf);\r\n}\r\nnxt200x_agc_reset(state);\r\nswitch (p->u.vsb.modulation) {\r\ncase QAM_64:\r\ncase QAM_256:\r\nbuf[0] = 0x74;\r\nbreak;\r\ncase VSB_8:\r\nbuf[0] = 0x70;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nnxt200x_writebytes(state, 0x42, buf, 1);\r\nswitch (state->demod_chip) {\r\ncase NXT2002:\r\nbuf[0] = 0x87;\r\nbreak;\r\ncase NXT2004:\r\nbuf[0] = 0x07;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nnxt200x_writebytes(state, 0x57, buf, 1);\r\nbuf[0] = 0x10;\r\nbuf[1] = 0x00;\r\nswitch (state->demod_chip) {\r\ncase NXT2002:\r\nnxt200x_writereg_multibyte(state, 0x58, buf, 2);\r\nbreak;\r\ncase NXT2004:\r\nnxt200x_writebytes(state, 0x58, buf, 2);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nswitch (p->u.vsb.modulation) {\r\ncase QAM_64:\r\nbuf[0] = 0x68;\r\nbreak;\r\ncase QAM_256:\r\nbuf[0] = 0x64;\r\nbreak;\r\ncase VSB_8:\r\nbuf[0] = 0x60;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nbuf[1] = 0x00;\r\nswitch (state->demod_chip) {\r\ncase NXT2002:\r\nnxt200x_writereg_multibyte(state, 0x5C, buf, 2);\r\nbreak;\r\ncase NXT2004:\r\nnxt200x_writebytes(state, 0x5C, buf, 2);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nbuf[0] = 0x05;\r\nnxt200x_writebytes(state, 0x43, buf, 1);\r\nif (state->demod_chip == NXT2004) {\r\nbuf[0] = 0x00;\r\nbuf[1] = 0x00;\r\nnxt200x_writebytes(state, 0x46, buf, 2);\r\n}\r\nbuf[0] = 0x80;\r\nbuf[1] = 0x00;\r\nswitch (state->demod_chip) {\r\ncase NXT2002:\r\nnxt200x_writereg_multibyte(state, 0x4B, buf, 2);\r\nbreak;\r\ncase NXT2004:\r\nnxt200x_writebytes(state, 0x4B, buf, 2);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nbuf[0] = 0x00;\r\nnxt200x_writebytes(state, 0x4D, buf, 1);\r\nbuf[0] = 0x44;\r\nnxt200x_writebytes(state, 0x55, buf, 1);\r\nbuf[0] = 0x04;\r\nnxt200x_writebytes(state, 0x41, buf, 1);\r\nif (state->demod_chip == NXT2004) {\r\nnxt200x_readreg_multibyte(state, 0x80, buf, 1);\r\nbuf[0] = 0x24;\r\nnxt200x_writereg_multibyte(state, 0x80, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x08, buf, 1);\r\nbuf[0] = 0x10;\r\nnxt200x_writereg_multibyte(state, 0x08, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x08, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writereg_multibyte(state, 0x08, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x80, buf, 1);\r\nbuf[0] = 0x04;\r\nnxt200x_writereg_multibyte(state, 0x80, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writereg_multibyte(state, 0x81, buf, 1);\r\nbuf[0] = 0x80; buf[1] = 0x00; buf[2] = 0x00;\r\nnxt200x_writereg_multibyte(state, 0x82, buf, 3);\r\nnxt200x_readreg_multibyte(state, 0x88, buf, 1);\r\nbuf[0] = 0x11;\r\nnxt200x_writereg_multibyte(state, 0x88, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x80, buf, 1);\r\nbuf[0] = 0x44;\r\nnxt200x_writereg_multibyte(state, 0x80, buf, 1);\r\n}\r\nswitch (p->u.vsb.modulation) {\r\ncase QAM_64:\r\nbuf[0] = 0x02;\r\nbreak;\r\ncase QAM_256:\r\nbuf[0] = 0x03;\r\nbreak;\r\ncase VSB_8:\r\nbuf[0] = 0x00;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nnxt200x_writebytes(state, 0x30, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writebytes(state, 0x41, buf, 1);\r\nbuf[0] = 0x80;\r\nbuf[1] = 0x00;\r\nswitch (state->demod_chip) {\r\ncase NXT2002:\r\nnxt200x_writereg_multibyte(state, 0x49, buf, 2);\r\nnxt200x_writereg_multibyte(state, 0x4B, buf, 2);\r\nbreak;\r\ncase NXT2004:\r\nnxt200x_writebytes(state, 0x49, buf, 2);\r\nnxt200x_writebytes(state, 0x4B, buf, 2);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nbuf[0] = 0x04;\r\nnxt200x_writebytes(state, 0x41, buf, 1);\r\nnxt200x_microcontroller_start(state);\r\nif (state->demod_chip == NXT2004) {\r\nnxt2004_microcontroller_init(state);\r\nbuf[0] = 0xF0;\r\nbuf[1] = 0x00;\r\nnxt200x_writebytes(state, 0x5C, buf, 2);\r\n}\r\nreturn 0;\r\n}\r\nstatic int nxt200x_read_status(struct dvb_frontend* fe, fe_status_t* status)\r\n{\r\nstruct nxt200x_state* state = fe->demodulator_priv;\r\nu8 lock;\r\nnxt200x_readbytes(state, 0x31, &lock, 1);\r\n*status = 0;\r\nif (lock & 0x20) {\r\n*status |= FE_HAS_SIGNAL;\r\n*status |= FE_HAS_CARRIER;\r\n*status |= FE_HAS_VITERBI;\r\n*status |= FE_HAS_SYNC;\r\n*status |= FE_HAS_LOCK;\r\n}\r\nreturn 0;\r\n}\r\nstatic int nxt200x_read_ber(struct dvb_frontend* fe, u32* ber)\r\n{\r\nstruct nxt200x_state* state = fe->demodulator_priv;\r\nu8 b[3];\r\nnxt200x_readreg_multibyte(state, 0xE6, b, 3);\r\n*ber = ((b[0] << 8) + b[1]) * 8;\r\nreturn 0;\r\n}\r\nstatic int nxt200x_read_signal_strength(struct dvb_frontend* fe, u16* strength)\r\n{\r\nstruct nxt200x_state* state = fe->demodulator_priv;\r\nu8 b[2];\r\nu16 temp = 0;\r\nb[0] = 0x00;\r\nnxt200x_writebytes(state, 0xA1, b, 1);\r\nnxt200x_readreg_multibyte(state, 0xA6, b, 2);\r\ntemp = (b[0] << 8) | b[1];\r\n*strength = ((0x7FFF - temp) & 0x0FFF) * 16;\r\nreturn 0;\r\n}\r\nstatic int nxt200x_read_snr(struct dvb_frontend* fe, u16* snr)\r\n{\r\nstruct nxt200x_state* state = fe->demodulator_priv;\r\nu8 b[2];\r\nu16 temp = 0, temp2;\r\nu32 snrdb = 0;\r\nb[0] = 0x00;\r\nnxt200x_writebytes(state, 0xA1, b, 1);\r\nnxt200x_readreg_multibyte(state, 0xA6, b, 2);\r\ntemp = (b[0] << 8) | b[1];\r\ntemp2 = 0x7FFF - temp;\r\nif (temp2 > 0x7F00)\r\nsnrdb = 1000*24 + ( 1000*(30-24) * ( temp2 - 0x7F00 ) / ( 0x7FFF - 0x7F00 ) );\r\nelse if (temp2 > 0x7EC0)\r\nsnrdb = 1000*18 + ( 1000*(24-18) * ( temp2 - 0x7EC0 ) / ( 0x7F00 - 0x7EC0 ) );\r\nelse if (temp2 > 0x7C00)\r\nsnrdb = 1000*12 + ( 1000*(18-12) * ( temp2 - 0x7C00 ) / ( 0x7EC0 - 0x7C00 ) );\r\nelse\r\nsnrdb = 1000*0 + ( 1000*(12-0) * ( temp2 - 0 ) / ( 0x7C00 - 0 ) );\r\n*snr = snrdb * (0xFFFF/32000);\r\nreturn 0;\r\n}\r\nstatic int nxt200x_read_ucblocks(struct dvb_frontend* fe, u32* ucblocks)\r\n{\r\nstruct nxt200x_state* state = fe->demodulator_priv;\r\nu8 b[3];\r\nnxt200x_readreg_multibyte(state, 0xE6, b, 3);\r\n*ucblocks = b[2];\r\nreturn 0;\r\n}\r\nstatic int nxt200x_sleep(struct dvb_frontend* fe)\r\n{\r\nreturn 0;\r\n}\r\nstatic int nxt2002_init(struct dvb_frontend* fe)\r\n{\r\nstruct nxt200x_state* state = fe->demodulator_priv;\r\nconst struct firmware *fw;\r\nint ret;\r\nu8 buf[2];\r\nprintk("nxt2002: Waiting for firmware upload (%s)...\n", NXT2002_DEFAULT_FIRMWARE);\r\nret = request_firmware(&fw, NXT2002_DEFAULT_FIRMWARE,\r\nstate->i2c->dev.parent);\r\nprintk("nxt2002: Waiting for firmware upload(2)...\n");\r\nif (ret) {\r\nprintk("nxt2002: No firmware uploaded (timeout or file not found?)\n");\r\nreturn ret;\r\n}\r\nret = nxt2002_load_firmware(fe, fw);\r\nrelease_firmware(fw);\r\nif (ret) {\r\nprintk("nxt2002: Writing firmware to device failed\n");\r\nreturn ret;\r\n}\r\nprintk("nxt2002: Firmware upload complete\n");\r\nnxt200x_microcontroller_stop(state);\r\nbuf[0]=0x00;\r\nnxt200x_writebytes(state, 0x2B, buf, 1);\r\nnxt200x_microcontroller_stop(state);\r\nbuf[0] = 0x0F;\r\nnxt200x_writebytes(state, 0x08, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writebytes(state, 0x08, buf, 1);\r\nbuf[0] = 0xF1;\r\nnxt200x_writebytes(state, 0x57, buf, 1);\r\nbuf[0] = 0x20;\r\nnxt200x_writebytes(state, 0x09, buf, 1);\r\nbuf[0] = 0x7E;\r\nbuf[1] = 0x00;\r\nnxt200x_writebytes(state, 0xE9, buf, 2);\r\nbuf[0] = 0x00;\r\nnxt200x_writebytes(state, 0xCC, buf, 1);\r\nreturn 0;\r\n}\r\nstatic int nxt2004_init(struct dvb_frontend* fe)\r\n{\r\nstruct nxt200x_state* state = fe->demodulator_priv;\r\nconst struct firmware *fw;\r\nint ret;\r\nu8 buf[3];\r\nbuf[0]=0x00;\r\nnxt200x_writebytes(state, 0x1E, buf, 1);\r\nprintk("nxt2004: Waiting for firmware upload (%s)...\n", NXT2004_DEFAULT_FIRMWARE);\r\nret = request_firmware(&fw, NXT2004_DEFAULT_FIRMWARE,\r\nstate->i2c->dev.parent);\r\nprintk("nxt2004: Waiting for firmware upload(2)...\n");\r\nif (ret) {\r\nprintk("nxt2004: No firmware uploaded (timeout or file not found?)\n");\r\nreturn ret;\r\n}\r\nret = nxt2004_load_firmware(fe, fw);\r\nrelease_firmware(fw);\r\nif (ret) {\r\nprintk("nxt2004: Writing firmware to device failed\n");\r\nreturn ret;\r\n}\r\nprintk("nxt2004: Firmware upload complete\n");\r\nbuf[0] = 0x01;\r\nnxt200x_writebytes(state, 0x19, buf, 1);\r\nnxt2004_microcontroller_init(state);\r\nnxt200x_microcontroller_stop(state);\r\nnxt200x_microcontroller_stop(state);\r\nnxt2004_microcontroller_init(state);\r\nnxt200x_microcontroller_stop(state);\r\nbuf[0] = 0xFF;\r\nnxt200x_writereg_multibyte(state, 0x08, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writereg_multibyte(state, 0x08, buf, 1);\r\nbuf[0] = 0xD7;\r\nnxt200x_writebytes(state, 0x57, buf, 1);\r\nbuf[0] = 0x07;\r\nbuf[1] = 0xfe;\r\nnxt200x_writebytes(state, 0x35, buf, 2);\r\nbuf[0] = 0x12;\r\nnxt200x_writebytes(state, 0x34, buf, 1);\r\nbuf[0] = 0x80;\r\nnxt200x_writebytes(state, 0x21, buf, 1);\r\nbuf[0] = 0x21;\r\nnxt200x_writebytes(state, 0x0A, buf, 1);\r\nbuf[0] = 0x01;\r\nnxt200x_writereg_multibyte(state, 0x80, buf, 1);\r\nbuf[0] = 0x7E;\r\nbuf[1] = 0x00;\r\nnxt200x_writebytes(state, 0xE9, buf, 2);\r\nbuf[0] = 0x00;\r\nnxt200x_writebytes(state, 0xCC, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x80, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writereg_multibyte(state, 0x80, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x08, buf, 1);\r\nbuf[0] = 0x10;\r\nnxt200x_writereg_multibyte(state, 0x08, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x08, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writereg_multibyte(state, 0x08, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x80, buf, 1);\r\nbuf[0] = 0x01;\r\nnxt200x_writereg_multibyte(state, 0x80, buf, 1);\r\nbuf[0] = 0x70;\r\nnxt200x_writereg_multibyte(state, 0x81, buf, 1);\r\nbuf[0] = 0x31; buf[1] = 0x5E; buf[2] = 0x66;\r\nnxt200x_writereg_multibyte(state, 0x82, buf, 3);\r\nnxt200x_readreg_multibyte(state, 0x88, buf, 1);\r\nbuf[0] = 0x11;\r\nnxt200x_writereg_multibyte(state, 0x88, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x80, buf, 1);\r\nbuf[0] = 0x40;\r\nnxt200x_writereg_multibyte(state, 0x80, buf, 1);\r\nnxt200x_readbytes(state, 0x10, buf, 1);\r\nbuf[0] = 0x10;\r\nnxt200x_writebytes(state, 0x10, buf, 1);\r\nnxt200x_readbytes(state, 0x0A, buf, 1);\r\nbuf[0] = 0x21;\r\nnxt200x_writebytes(state, 0x0A, buf, 1);\r\nnxt2004_microcontroller_init(state);\r\nbuf[0] = 0x21;\r\nnxt200x_writebytes(state, 0x0A, buf, 1);\r\nbuf[0] = 0x7E;\r\nnxt200x_writebytes(state, 0xE9, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writebytes(state, 0xEA, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x80, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writereg_multibyte(state, 0x80, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x80, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writereg_multibyte(state, 0x80, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x08, buf, 1);\r\nbuf[0] = 0x10;\r\nnxt200x_writereg_multibyte(state, 0x08, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x08, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writereg_multibyte(state, 0x08, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x80, buf, 1);\r\nbuf[0] = 0x04;\r\nnxt200x_writereg_multibyte(state, 0x80, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writereg_multibyte(state, 0x81, buf, 1);\r\nbuf[0] = 0x80; buf[1] = 0x00; buf[2] = 0x00;\r\nnxt200x_writereg_multibyte(state, 0x82, buf, 3);\r\nnxt200x_readreg_multibyte(state, 0x88, buf, 1);\r\nbuf[0] = 0x11;\r\nnxt200x_writereg_multibyte(state, 0x88, buf, 1);\r\nnxt200x_readreg_multibyte(state, 0x80, buf, 1);\r\nbuf[0] = 0x44;\r\nnxt200x_writereg_multibyte(state, 0x80, buf, 1);\r\nnxt200x_readbytes(state, 0x10, buf, 1);\r\nbuf[0] = 0x12;\r\nnxt200x_writebytes(state, 0x10, buf, 1);\r\nbuf[0] = 0x04;\r\nnxt200x_writebytes(state, 0x13, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writebytes(state, 0x16, buf, 1);\r\nbuf[0] = 0x04;\r\nnxt200x_writebytes(state, 0x14, buf, 1);\r\nbuf[0] = 0x00;\r\nnxt200x_writebytes(state, 0x14, buf, 1);\r\nnxt200x_writebytes(state, 0x17, buf, 1);\r\nnxt200x_writebytes(state, 0x14, buf, 1);\r\nnxt200x_writebytes(state, 0x17, buf, 1);\r\nreturn 0;\r\n}\r\nstatic int nxt200x_init(struct dvb_frontend* fe)\r\n{\r\nstruct nxt200x_state* state = fe->demodulator_priv;\r\nint ret = 0;\r\nif (!state->initialised) {\r\nswitch (state->demod_chip) {\r\ncase NXT2002:\r\nret = nxt2002_init(fe);\r\nbreak;\r\ncase NXT2004:\r\nret = nxt2004_init(fe);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nstate->initialised = 1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int nxt200x_get_tune_settings(struct dvb_frontend* fe, struct dvb_frontend_tune_settings* fesettings)\r\n{\r\nfesettings->min_delay_ms = 500;\r\nfesettings->step_size = 0;\r\nfesettings->max_drift = 0;\r\nreturn 0;\r\n}\r\nstatic void nxt200x_release(struct dvb_frontend* fe)\r\n{\r\nstruct nxt200x_state* state = fe->demodulator_priv;\r\nkfree(state);\r\n}\r\nstruct dvb_frontend* nxt200x_attach(const struct nxt200x_config* config,\r\nstruct i2c_adapter* i2c)\r\n{\r\nstruct nxt200x_state* state = NULL;\r\nu8 buf [] = {0,0,0,0,0};\r\nstate = kzalloc(sizeof(struct nxt200x_state), GFP_KERNEL);\r\nif (state == NULL)\r\ngoto error;\r\nstate->config = config;\r\nstate->i2c = i2c;\r\nstate->initialised = 0;\r\nnxt200x_readbytes(state, 0x00, buf, 5);\r\ndprintk("NXT info: %02X %02X %02X %02X %02X\n",\r\nbuf[0], buf[1], buf[2], buf[3], buf[4]);\r\nswitch (buf[0]) {\r\ncase 0x04:\r\nstate->demod_chip = NXT2002;\r\nprintk("nxt200x: NXT2002 Detected\n");\r\nbreak;\r\ncase 0x05:\r\nstate->demod_chip = NXT2004;\r\nprintk("nxt200x: NXT2004 Detected\n");\r\nbreak;\r\ndefault:\r\ngoto error;\r\n}\r\nswitch (state->demod_chip) {\r\ncase NXT2002:\r\nif (buf[0] != 0x04) goto error;\r\nif (buf[1] != 0x02) goto error;\r\nif (buf[2] != 0x11) goto error;\r\nif (buf[3] != 0x20) goto error;\r\nif (buf[4] != 0x00) goto error;\r\nbreak;\r\ncase NXT2004:\r\nif (buf[0] != 0x05) goto error;\r\nbreak;\r\ndefault:\r\ngoto error;\r\n}\r\nmemcpy(&state->frontend.ops, &nxt200x_ops, sizeof(struct dvb_frontend_ops));\r\nstate->frontend.demodulator_priv = state;\r\nreturn &state->frontend;\r\nerror:\r\nkfree(state);\r\nprintk("Unknown/Unsupported NXT chip: %02X %02X %02X %02X %02X\n",\r\nbuf[0], buf[1], buf[2], buf[3], buf[4]);\r\nreturn NULL;\r\n}

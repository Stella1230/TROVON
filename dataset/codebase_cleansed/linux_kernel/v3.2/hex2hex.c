static int loadhex(FILE *inf, unsigned char *buf)\r\n{\r\nint l=0, c, i;\r\nwhile ((c=getc(inf))!=EOF)\r\n{\r\nif (c == ':')\r\n{\r\nint n, check;\r\nunsigned char sum;\r\nint addr;\r\nint linetype;\r\nif (fscanf(inf, "%02x", &n) != 1)\r\nABANDON("File format error");\r\nsum = n;\r\nif (fscanf(inf, "%04x", &addr) != 1)\r\nABANDON("File format error");\r\nsum += addr/256;\r\nsum += addr%256;\r\nif (fscanf(inf, "%02x", &linetype) != 1)\r\nABANDON("File format error");\r\nsum += linetype;\r\nif (linetype != 0)\r\ncontinue;\r\nfor (i=0;i<n;i++)\r\n{\r\nif (fscanf(inf, "%02x", &c) != 1)\r\nABANDON("File format error");\r\nif (addr >= MAX_SIZE)\r\nABANDON("File too large");\r\nbuf[addr++] = c;\r\nif (addr > l)\r\nl = addr;\r\nsum += c;\r\n}\r\nif (fscanf(inf, "%02x", &check) != 1)\r\nABANDON("File format error");\r\nsum = ~sum + 1;\r\nif (check != sum)\r\nABANDON("Line checksum error");\r\n}\r\n}\r\nreturn l;\r\n}\r\nint main( int argc, const char * argv [] )\r\n{\r\nconst char * varline;\r\nint i,l;\r\nint id=0;\r\nif(argv[1] && strcmp(argv[1], "-i")==0)\r\n{\r\nargv++;\r\nargc--;\r\nid=1;\r\n}\r\nif(argv[1]==NULL)\r\n{\r\nfprintf(stderr,"hex2hex: [-i] filename\n");\r\nexit(1);\r\n}\r\nvarline = argv[1];\r\nl = loadhex(stdin, buf);\r\nprintf("/*\n *\t Computer generated file. Do not edit.\n */\n");\r\nprintf("static int %s_len = %d;\n", varline, l);\r\nprintf("static unsigned char %s[] %s = {\n", varline, id?"__initdata":"");\r\nfor (i=0;i<l;i++)\r\n{\r\nif (i) printf(",");\r\nif (i && !(i % 16)) printf("\n");\r\nprintf("0x%02x", buf[i]);\r\n}\r\nprintf("\n};\n\n");\r\nreturn 0;\r\n}

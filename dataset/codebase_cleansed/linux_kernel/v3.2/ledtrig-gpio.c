static irqreturn_t gpio_trig_irq(int irq, void *_led)\r\n{\r\nstruct led_classdev *led = _led;\r\nstruct gpio_trig_data *gpio_data = led->trigger_data;\r\nschedule_work(&gpio_data->work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void gpio_trig_work(struct work_struct *work)\r\n{\r\nstruct gpio_trig_data *gpio_data = container_of(work,\r\nstruct gpio_trig_data, work);\r\nint tmp;\r\nif (!gpio_data->gpio)\r\nreturn;\r\ntmp = gpio_get_value(gpio_data->gpio);\r\nif (gpio_data->inverted)\r\ntmp = !tmp;\r\nif (tmp) {\r\nif (gpio_data->desired_brightness)\r\nled_set_brightness(gpio_data->led,\r\ngpio_data->desired_brightness);\r\nelse\r\nled_set_brightness(gpio_data->led, LED_FULL);\r\n} else {\r\nled_set_brightness(gpio_data->led, LED_OFF);\r\n}\r\n}\r\nstatic ssize_t gpio_trig_brightness_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led = dev_get_drvdata(dev);\r\nstruct gpio_trig_data *gpio_data = led->trigger_data;\r\nreturn sprintf(buf, "%u\n", gpio_data->desired_brightness);\r\n}\r\nstatic ssize_t gpio_trig_brightness_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t n)\r\n{\r\nstruct led_classdev *led = dev_get_drvdata(dev);\r\nstruct gpio_trig_data *gpio_data = led->trigger_data;\r\nunsigned desired_brightness;\r\nint ret;\r\nret = sscanf(buf, "%u", &desired_brightness);\r\nif (ret < 1 || desired_brightness > 255) {\r\ndev_err(dev, "invalid value\n");\r\nreturn -EINVAL;\r\n}\r\ngpio_data->desired_brightness = desired_brightness;\r\nreturn n;\r\n}\r\nstatic ssize_t gpio_trig_inverted_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led = dev_get_drvdata(dev);\r\nstruct gpio_trig_data *gpio_data = led->trigger_data;\r\nreturn sprintf(buf, "%u\n", gpio_data->inverted);\r\n}\r\nstatic ssize_t gpio_trig_inverted_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t n)\r\n{\r\nstruct led_classdev *led = dev_get_drvdata(dev);\r\nstruct gpio_trig_data *gpio_data = led->trigger_data;\r\nunsigned long inverted;\r\nint ret;\r\nret = strict_strtoul(buf, 10, &inverted);\r\nif (ret < 0)\r\nreturn ret;\r\nif (inverted > 1)\r\nreturn -EINVAL;\r\ngpio_data->inverted = inverted;\r\nschedule_work(&gpio_data->work);\r\nreturn n;\r\n}\r\nstatic ssize_t gpio_trig_gpio_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led = dev_get_drvdata(dev);\r\nstruct gpio_trig_data *gpio_data = led->trigger_data;\r\nreturn sprintf(buf, "%u\n", gpio_data->gpio);\r\n}\r\nstatic ssize_t gpio_trig_gpio_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t n)\r\n{\r\nstruct led_classdev *led = dev_get_drvdata(dev);\r\nstruct gpio_trig_data *gpio_data = led->trigger_data;\r\nunsigned gpio;\r\nint ret;\r\nret = sscanf(buf, "%u", &gpio);\r\nif (ret < 1) {\r\ndev_err(dev, "couldn't read gpio number\n");\r\nflush_work(&gpio_data->work);\r\nreturn -EINVAL;\r\n}\r\nif (gpio_data->gpio == gpio)\r\nreturn n;\r\nif (!gpio) {\r\nif (gpio_data->gpio != 0)\r\nfree_irq(gpio_to_irq(gpio_data->gpio), led);\r\ngpio_data->gpio = 0;\r\nreturn n;\r\n}\r\nret = request_irq(gpio_to_irq(gpio), gpio_trig_irq,\r\nIRQF_SHARED | IRQF_TRIGGER_RISING\r\n| IRQF_TRIGGER_FALLING, "ledtrig-gpio", led);\r\nif (ret) {\r\ndev_err(dev, "request_irq failed with error %d\n", ret);\r\n} else {\r\nif (gpio_data->gpio != 0)\r\nfree_irq(gpio_to_irq(gpio_data->gpio), led);\r\ngpio_data->gpio = gpio;\r\n}\r\nreturn ret ? ret : n;\r\n}\r\nstatic void gpio_trig_activate(struct led_classdev *led)\r\n{\r\nstruct gpio_trig_data *gpio_data;\r\nint ret;\r\ngpio_data = kzalloc(sizeof(*gpio_data), GFP_KERNEL);\r\nif (!gpio_data)\r\nreturn;\r\nret = device_create_file(led->dev, &dev_attr_gpio);\r\nif (ret)\r\ngoto err_gpio;\r\nret = device_create_file(led->dev, &dev_attr_inverted);\r\nif (ret)\r\ngoto err_inverted;\r\nret = device_create_file(led->dev, &dev_attr_desired_brightness);\r\nif (ret)\r\ngoto err_brightness;\r\ngpio_data->led = led;\r\nled->trigger_data = gpio_data;\r\nINIT_WORK(&gpio_data->work, gpio_trig_work);\r\nreturn;\r\nerr_brightness:\r\ndevice_remove_file(led->dev, &dev_attr_inverted);\r\nerr_inverted:\r\ndevice_remove_file(led->dev, &dev_attr_gpio);\r\nerr_gpio:\r\nkfree(gpio_data);\r\n}\r\nstatic void gpio_trig_deactivate(struct led_classdev *led)\r\n{\r\nstruct gpio_trig_data *gpio_data = led->trigger_data;\r\nif (gpio_data) {\r\ndevice_remove_file(led->dev, &dev_attr_gpio);\r\ndevice_remove_file(led->dev, &dev_attr_inverted);\r\ndevice_remove_file(led->dev, &dev_attr_desired_brightness);\r\nflush_work(&gpio_data->work);\r\nif (gpio_data->gpio != 0)\r\nfree_irq(gpio_to_irq(gpio_data->gpio), led);\r\nkfree(gpio_data);\r\n}\r\n}\r\nstatic int __init gpio_trig_init(void)\r\n{\r\nreturn led_trigger_register(&gpio_led_trigger);\r\n}\r\nstatic void __exit gpio_trig_exit(void)\r\n{\r\nled_trigger_unregister(&gpio_led_trigger);\r\n}

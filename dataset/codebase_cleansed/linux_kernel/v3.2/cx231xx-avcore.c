static int verve_write_byte(struct cx231xx *dev, u8 saddr, u8 data)\r\n{\r\nreturn cx231xx_write_i2c_data(dev, VERVE_I2C_ADDRESS,\r\nsaddr, 1, data, 1);\r\n}\r\nstatic int verve_read_byte(struct cx231xx *dev, u8 saddr, u8 *data)\r\n{\r\nint status;\r\nu32 temp = 0;\r\nstatus = cx231xx_read_i2c_data(dev, VERVE_I2C_ADDRESS,\r\nsaddr, 1, &temp, 1);\r\n*data = (u8) temp;\r\nreturn status;\r\n}\r\nvoid initGPIO(struct cx231xx *dev)\r\n{\r\nu32 _gpio_direction = 0;\r\nu32 value = 0;\r\nu8 val = 0;\r\n_gpio_direction = _gpio_direction & 0xFC0003FF;\r\n_gpio_direction = _gpio_direction | 0x03FDFC00;\r\ncx231xx_send_gpio_cmd(dev, _gpio_direction, (u8 *)&value, 4, 0, 0);\r\nverve_read_byte(dev, 0x07, &val);\r\ncx231xx_info(" verve_read_byte address0x07=0x%x\n", val);\r\nverve_write_byte(dev, 0x07, 0xF4);\r\nverve_read_byte(dev, 0x07, &val);\r\ncx231xx_info(" verve_read_byte address0x07=0x%x\n", val);\r\ncx231xx_capture_start(dev, 1, 2);\r\ncx231xx_mode_register(dev, EP_MODE_SET, 0x0500FE00);\r\ncx231xx_mode_register(dev, GBULK_BIT_EN, 0xFFFDFFFF);\r\n}\r\nvoid uninitGPIO(struct cx231xx *dev)\r\n{\r\nu8 value[4] = { 0, 0, 0, 0 };\r\ncx231xx_capture_start(dev, 0, 2);\r\nverve_write_byte(dev, 0x07, 0x14);\r\ncx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\n0x68, value, 4);\r\n}\r\nstatic int afe_write_byte(struct cx231xx *dev, u16 saddr, u8 data)\r\n{\r\nreturn cx231xx_write_i2c_data(dev, AFE_DEVICE_ADDRESS,\r\nsaddr, 2, data, 1);\r\n}\r\nstatic int afe_read_byte(struct cx231xx *dev, u16 saddr, u8 *data)\r\n{\r\nint status;\r\nu32 temp = 0;\r\nstatus = cx231xx_read_i2c_data(dev, AFE_DEVICE_ADDRESS,\r\nsaddr, 2, &temp, 1);\r\n*data = (u8) temp;\r\nreturn status;\r\n}\r\nint cx231xx_afe_init_super_block(struct cx231xx *dev, u32 ref_count)\r\n{\r\nint status = 0;\r\nu8 temp = 0;\r\nu8 afe_power_status = 0;\r\nint i = 0;\r\ntemp = (u8) (ref_count & 0xff);\r\nstatus = afe_write_byte(dev, SUP_BLK_TUNE2, temp);\r\nif (status < 0)\r\nreturn status;\r\nstatus = afe_read_byte(dev, SUP_BLK_TUNE2, &afe_power_status);\r\nif (status < 0)\r\nreturn status;\r\ntemp = (u8) ((ref_count & 0x300) >> 8);\r\ntemp |= 0x40;\r\nstatus = afe_write_byte(dev, SUP_BLK_TUNE1, temp);\r\nif (status < 0)\r\nreturn status;\r\nstatus = afe_write_byte(dev, SUP_BLK_PLL2, 0x0f);\r\nif (status < 0)\r\nreturn status;\r\nwhile (afe_power_status != 0x18) {\r\nstatus = afe_write_byte(dev, SUP_BLK_PWRDN, 0x18);\r\nif (status < 0) {\r\ncx231xx_info(\r\n": Init Super Block failed in send cmd\n");\r\nbreak;\r\n}\r\nstatus = afe_read_byte(dev, SUP_BLK_PWRDN, &afe_power_status);\r\nafe_power_status &= 0xff;\r\nif (status < 0) {\r\ncx231xx_info(\r\n": Init Super Block failed in receive cmd\n");\r\nbreak;\r\n}\r\ni++;\r\nif (i == 10) {\r\ncx231xx_info(\r\n": Init Super Block force break in loop !!!!\n");\r\nstatus = -1;\r\nbreak;\r\n}\r\n}\r\nif (status < 0)\r\nreturn status;\r\nstatus = afe_write_byte(dev, SUP_BLK_TUNE3, 0x40);\r\nif (status < 0)\r\nreturn status;\r\nmsleep(5);\r\nstatus = afe_write_byte(dev, SUP_BLK_TUNE3, 0x00);\r\nreturn status;\r\n}\r\nint cx231xx_afe_init_channels(struct cx231xx *dev)\r\n{\r\nint status = 0;\r\nstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH1, 0x00);\r\nstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2, 0x00);\r\nstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3, 0x00);\r\nstatus = afe_write_byte(dev, ADC_COM_QUANT, 0x02);\r\nstatus = afe_write_byte(dev, ADC_FB_FRCRST_CH1, 0x17);\r\nstatus = afe_write_byte(dev, ADC_FB_FRCRST_CH2, 0x17);\r\nstatus = afe_write_byte(dev, ADC_FB_FRCRST_CH3, 0x17);\r\nstatus = afe_write_byte(dev, ADC_CAL_ATEST_CH1, 0x10);\r\nstatus = afe_write_byte(dev, ADC_CAL_ATEST_CH2, 0x10);\r\nstatus = afe_write_byte(dev, ADC_CAL_ATEST_CH3, 0x10);\r\nmsleep(5);\r\nstatus = afe_write_byte(dev, ADC_FB_FRCRST_CH1, 0x07);\r\nstatus = afe_write_byte(dev, ADC_FB_FRCRST_CH2, 0x07);\r\nstatus = afe_write_byte(dev, ADC_FB_FRCRST_CH3, 0x07);\r\nstatus = afe_write_byte(dev, ADC_NTF_PRECLMP_EN_CH1, 0xf0);\r\nstatus = afe_write_byte(dev, ADC_NTF_PRECLMP_EN_CH2, 0xf0);\r\nstatus = afe_write_byte(dev, ADC_NTF_PRECLMP_EN_CH3, 0xf0);\r\nstatus = cx231xx_reg_mask_write(dev, AFE_DEVICE_ADDRESS, 8,\r\nADC_QGAIN_RES_TRM_CH1, 3, 7, 0x00);\r\nstatus = cx231xx_reg_mask_write(dev, AFE_DEVICE_ADDRESS, 8,\r\nADC_QGAIN_RES_TRM_CH2, 3, 7, 0x00);\r\nstatus = cx231xx_reg_mask_write(dev, AFE_DEVICE_ADDRESS, 8,\r\nADC_QGAIN_RES_TRM_CH3, 3, 7, 0x00);\r\nstatus = afe_write_byte(dev, ADC_DCSERVO_DEM_CH1, 0x03);\r\nstatus = afe_write_byte(dev, ADC_DCSERVO_DEM_CH2, 0x03);\r\nstatus = afe_write_byte(dev, ADC_DCSERVO_DEM_CH3, 0x03);\r\nreturn status;\r\n}\r\nint cx231xx_afe_setup_AFE_for_baseband(struct cx231xx *dev)\r\n{\r\nu8 c_value = 0;\r\nint status = 0;\r\nstatus = afe_read_byte(dev, ADC_PWRDN_CLAMP_CH2, &c_value);\r\nc_value &= (~(0x50));\r\nstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2, c_value);\r\nreturn status;\r\n}\r\nint cx231xx_afe_set_input_mux(struct cx231xx *dev, u32 input_mux)\r\n{\r\nu8 ch1_setting = (u8) input_mux;\r\nu8 ch2_setting = (u8) (input_mux >> 8);\r\nu8 ch3_setting = (u8) (input_mux >> 16);\r\nint status = 0;\r\nu8 value = 0;\r\nif (ch1_setting != 0) {\r\nstatus = afe_read_byte(dev, ADC_INPUT_CH1, &value);\r\nvalue &= ~INPUT_SEL_MASK;\r\nvalue |= (ch1_setting - 1) << 4;\r\nvalue &= 0xff;\r\nstatus = afe_write_byte(dev, ADC_INPUT_CH1, value);\r\n}\r\nif (ch2_setting != 0) {\r\nstatus = afe_read_byte(dev, ADC_INPUT_CH2, &value);\r\nvalue &= ~INPUT_SEL_MASK;\r\nvalue |= (ch2_setting - 1) << 4;\r\nvalue &= 0xff;\r\nstatus = afe_write_byte(dev, ADC_INPUT_CH2, value);\r\n}\r\nif (ch3_setting != 0) {\r\nstatus = afe_read_byte(dev, ADC_INPUT_CH3, &value);\r\nvalue &= ~INPUT_SEL_MASK;\r\nvalue |= (ch3_setting - 1) << 4;\r\nvalue &= 0xff;\r\nstatus = afe_write_byte(dev, ADC_INPUT_CH3, value);\r\n}\r\nreturn status;\r\n}\r\nint cx231xx_afe_set_mode(struct cx231xx *dev, enum AFE_MODE mode)\r\n{\r\nint status = 0;\r\nswitch (mode) {\r\ncase AFE_MODE_LOW_IF:\r\ncx231xx_Setup_AFE_for_LowIF(dev);\r\nbreak;\r\ncase AFE_MODE_BASEBAND:\r\nstatus = cx231xx_afe_setup_AFE_for_baseband(dev);\r\nbreak;\r\ncase AFE_MODE_EU_HI_IF:\r\nbreak;\r\ncase AFE_MODE_US_HI_IF:\r\nbreak;\r\ncase AFE_MODE_JAPAN_HI_IF:\r\nbreak;\r\n}\r\nif ((mode != dev->afe_mode) &&\r\n(dev->video_input == CX231XX_VMUX_TELEVISION))\r\nstatus = cx231xx_afe_adjust_ref_count(dev,\r\nCX231XX_VMUX_TELEVISION);\r\ndev->afe_mode = mode;\r\nreturn status;\r\n}\r\nint cx231xx_afe_update_power_control(struct cx231xx *dev,\r\nenum AV_MODE avmode)\r\n{\r\nu8 afe_power_status = 0;\r\nint status = 0;\r\nswitch (dev->model) {\r\ncase CX231XX_BOARD_CNXT_CARRAERA:\r\ncase CX231XX_BOARD_CNXT_RDE_250:\r\ncase CX231XX_BOARD_CNXT_SHELBY:\r\ncase CX231XX_BOARD_CNXT_RDU_250:\r\ncase CX231XX_BOARD_CNXT_RDE_253S:\r\ncase CX231XX_BOARD_CNXT_RDU_253S:\r\ncase CX231XX_BOARD_CNXT_VIDEO_GRABBER:\r\ncase CX231XX_BOARD_HAUPPAUGE_EXETER:\r\ncase CX231XX_BOARD_HAUPPAUGE_USBLIVE2:\r\ncase CX231XX_BOARD_PV_PLAYTV_USB_HYBRID:\r\ncase CX231XX_BOARD_HAUPPAUGE_USB2_FM_PAL:\r\ncase CX231XX_BOARD_HAUPPAUGE_USB2_FM_NTSC:\r\nif (avmode == POLARIS_AVMODE_ANALOGT_TV) {\r\nwhile (afe_power_status != (FLD_PWRDN_TUNING_BIAS |\r\nFLD_PWRDN_ENABLE_PLL)) {\r\nstatus = afe_write_byte(dev, SUP_BLK_PWRDN,\r\nFLD_PWRDN_TUNING_BIAS |\r\nFLD_PWRDN_ENABLE_PLL);\r\nstatus |= afe_read_byte(dev, SUP_BLK_PWRDN,\r\n&afe_power_status);\r\nif (status < 0)\r\nbreak;\r\n}\r\nstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH1,\r\n0x00);\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2,\r\n0x00);\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3,\r\n0x00);\r\n} else if (avmode == POLARIS_AVMODE_DIGITAL) {\r\nstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH1,\r\n0x70);\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2,\r\n0x70);\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3,\r\n0x70);\r\nstatus |= afe_read_byte(dev, SUP_BLK_PWRDN,\r\n&afe_power_status);\r\nafe_power_status |= FLD_PWRDN_PD_BANDGAP |\r\nFLD_PWRDN_PD_BIAS |\r\nFLD_PWRDN_PD_TUNECK;\r\nstatus |= afe_write_byte(dev, SUP_BLK_PWRDN,\r\nafe_power_status);\r\n} else if (avmode == POLARIS_AVMODE_ENXTERNAL_AV) {\r\nwhile (afe_power_status != (FLD_PWRDN_TUNING_BIAS |\r\nFLD_PWRDN_ENABLE_PLL)) {\r\nstatus = afe_write_byte(dev, SUP_BLK_PWRDN,\r\nFLD_PWRDN_TUNING_BIAS |\r\nFLD_PWRDN_ENABLE_PLL);\r\nstatus |= afe_read_byte(dev, SUP_BLK_PWRDN,\r\n&afe_power_status);\r\nif (status < 0)\r\nbreak;\r\n}\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH1,\r\n0x00);\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2,\r\n0x00);\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3,\r\n0x00);\r\n} else {\r\ncx231xx_info("Invalid AV mode input\n");\r\nstatus = -1;\r\n}\r\nbreak;\r\ndefault:\r\nif (avmode == POLARIS_AVMODE_ANALOGT_TV) {\r\nwhile (afe_power_status != (FLD_PWRDN_TUNING_BIAS |\r\nFLD_PWRDN_ENABLE_PLL)) {\r\nstatus = afe_write_byte(dev, SUP_BLK_PWRDN,\r\nFLD_PWRDN_TUNING_BIAS |\r\nFLD_PWRDN_ENABLE_PLL);\r\nstatus |= afe_read_byte(dev, SUP_BLK_PWRDN,\r\n&afe_power_status);\r\nif (status < 0)\r\nbreak;\r\n}\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH1,\r\n0x40);\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2,\r\n0x40);\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3,\r\n0x00);\r\n} else if (avmode == POLARIS_AVMODE_DIGITAL) {\r\nstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH1,\r\n0x70);\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2,\r\n0x70);\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3,\r\n0x70);\r\nstatus |= afe_read_byte(dev, SUP_BLK_PWRDN,\r\n&afe_power_status);\r\nafe_power_status |= FLD_PWRDN_PD_BANDGAP |\r\nFLD_PWRDN_PD_BIAS |\r\nFLD_PWRDN_PD_TUNECK;\r\nstatus |= afe_write_byte(dev, SUP_BLK_PWRDN,\r\nafe_power_status);\r\n} else if (avmode == POLARIS_AVMODE_ENXTERNAL_AV) {\r\nwhile (afe_power_status != (FLD_PWRDN_TUNING_BIAS |\r\nFLD_PWRDN_ENABLE_PLL)) {\r\nstatus = afe_write_byte(dev, SUP_BLK_PWRDN,\r\nFLD_PWRDN_TUNING_BIAS |\r\nFLD_PWRDN_ENABLE_PLL);\r\nstatus |= afe_read_byte(dev, SUP_BLK_PWRDN,\r\n&afe_power_status);\r\nif (status < 0)\r\nbreak;\r\n}\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH1,\r\n0x00);\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH2,\r\n0x00);\r\nstatus |= afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3,\r\n0x40);\r\n} else {\r\ncx231xx_info("Invalid AV mode input\n");\r\nstatus = -1;\r\n}\r\n}\r\nreturn status;\r\n}\r\nint cx231xx_afe_adjust_ref_count(struct cx231xx *dev, u32 video_input)\r\n{\r\nu8 input_mode = 0;\r\nu8 ntf_mode = 0;\r\nint status = 0;\r\ndev->video_input = video_input;\r\nif (video_input == CX231XX_VMUX_TELEVISION) {\r\nstatus = afe_read_byte(dev, ADC_INPUT_CH3, &input_mode);\r\nstatus = afe_read_byte(dev, ADC_NTF_PRECLMP_EN_CH3,\r\n&ntf_mode);\r\n} else {\r\nstatus = afe_read_byte(dev, ADC_INPUT_CH1, &input_mode);\r\nstatus = afe_read_byte(dev, ADC_NTF_PRECLMP_EN_CH1,\r\n&ntf_mode);\r\n}\r\ninput_mode = (ntf_mode & 0x3) | ((input_mode & 0x6) << 1);\r\nswitch (input_mode) {\r\ncase SINGLE_ENDED:\r\ndev->afe_ref_count = 0x23C;\r\nbreak;\r\ncase LOW_IF:\r\ndev->afe_ref_count = 0x24C;\r\nbreak;\r\ncase EU_IF:\r\ndev->afe_ref_count = 0x258;\r\nbreak;\r\ncase US_IF:\r\ndev->afe_ref_count = 0x260;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nstatus = cx231xx_afe_init_super_block(dev, dev->afe_ref_count);\r\nreturn status;\r\n}\r\nstatic int vid_blk_write_byte(struct cx231xx *dev, u16 saddr, u8 data)\r\n{\r\nreturn cx231xx_write_i2c_data(dev, VID_BLK_I2C_ADDRESS,\r\nsaddr, 2, data, 1);\r\n}\r\nstatic int vid_blk_read_byte(struct cx231xx *dev, u16 saddr, u8 *data)\r\n{\r\nint status;\r\nu32 temp = 0;\r\nstatus = cx231xx_read_i2c_data(dev, VID_BLK_I2C_ADDRESS,\r\nsaddr, 2, &temp, 1);\r\n*data = (u8) temp;\r\nreturn status;\r\n}\r\nstatic int vid_blk_write_word(struct cx231xx *dev, u16 saddr, u32 data)\r\n{\r\nreturn cx231xx_write_i2c_data(dev, VID_BLK_I2C_ADDRESS,\r\nsaddr, 2, data, 4);\r\n}\r\nstatic int vid_blk_read_word(struct cx231xx *dev, u16 saddr, u32 *data)\r\n{\r\nreturn cx231xx_read_i2c_data(dev, VID_BLK_I2C_ADDRESS,\r\nsaddr, 2, data, 4);\r\n}\r\nint cx231xx_check_fw(struct cx231xx *dev)\r\n{\r\nu8 temp = 0;\r\nint status = 0;\r\nstatus = vid_blk_read_byte(dev, DL_CTL_ADDRESS_LOW, &temp);\r\nif (status < 0)\r\nreturn status;\r\nelse\r\nreturn temp;\r\n}\r\nint cx231xx_set_video_input_mux(struct cx231xx *dev, u8 input)\r\n{\r\nint status = 0;\r\nswitch (INPUT(input)->type) {\r\ncase CX231XX_VMUX_COMPOSITE1:\r\ncase CX231XX_VMUX_SVIDEO:\r\nif ((dev->current_pcb_config.type == USB_BUS_POWER) &&\r\n(dev->power_mode != POLARIS_AVMODE_ENXTERNAL_AV)) {\r\nstatus = cx231xx_set_power_mode(dev,\r\nPOLARIS_AVMODE_ENXTERNAL_AV);\r\nif (status < 0) {\r\ncx231xx_errdev("%s: set_power_mode : Failed to"\r\n" set Power - errCode [%d]!\n",\r\n__func__, status);\r\nreturn status;\r\n}\r\n}\r\nstatus = cx231xx_set_decoder_video_input(dev,\r\nINPUT(input)->type,\r\nINPUT(input)->vmux);\r\nbreak;\r\ncase CX231XX_VMUX_TELEVISION:\r\ncase CX231XX_VMUX_CABLE:\r\nif ((dev->current_pcb_config.type == USB_BUS_POWER) &&\r\n(dev->power_mode != POLARIS_AVMODE_ANALOGT_TV)) {\r\nstatus = cx231xx_set_power_mode(dev,\r\nPOLARIS_AVMODE_ANALOGT_TV);\r\nif (status < 0) {\r\ncx231xx_errdev("%s: set_power_mode:Failed"\r\n" to set Power - errCode [%d]!\n",\r\n__func__, status);\r\nreturn status;\r\n}\r\n}\r\nif (dev->tuner_type == TUNER_NXP_TDA18271)\r\nstatus = cx231xx_set_decoder_video_input(dev,\r\nCX231XX_VMUX_TELEVISION,\r\nINPUT(input)->vmux);\r\nelse\r\nstatus = cx231xx_set_decoder_video_input(dev,\r\nCX231XX_VMUX_COMPOSITE1,\r\nINPUT(input)->vmux);\r\nbreak;\r\ndefault:\r\ncx231xx_errdev("%s: set_power_mode : Unknown Input %d !\n",\r\n__func__, INPUT(input)->type);\r\nbreak;\r\n}\r\ndev->video_input = input;\r\nreturn status;\r\n}\r\nint cx231xx_set_decoder_video_input(struct cx231xx *dev,\r\nu8 pin_type, u8 input)\r\n{\r\nint status = 0;\r\nu32 value = 0;\r\nif (pin_type != dev->video_input) {\r\nstatus = cx231xx_afe_adjust_ref_count(dev, pin_type);\r\nif (status < 0) {\r\ncx231xx_errdev("%s: adjust_ref_count :Failed to set"\r\n"AFE input mux - errCode [%d]!\n",\r\n__func__, status);\r\nreturn status;\r\n}\r\n}\r\nstatus = cx231xx_afe_set_input_mux(dev, input);\r\nif (status < 0) {\r\ncx231xx_errdev("%s: set_input_mux :Failed to set"\r\n" AFE input mux - errCode [%d]!\n",\r\n__func__, status);\r\nreturn status;\r\n}\r\nswitch (pin_type) {\r\ncase CX231XX_VMUX_COMPOSITE1:\r\nstatus = vid_blk_read_word(dev, AFE_CTRL, &value);\r\nvalue |= (0 << 13) | (1 << 4);\r\nvalue &= ~(1 << 5);\r\nvalue &= (~(0x1ff8000));\r\nvalue |= 0x1000000;\r\nstatus = vid_blk_write_word(dev, AFE_CTRL, value);\r\nstatus = vid_blk_read_word(dev, OUT_CTRL1, &value);\r\nvalue |= (1 << 7);\r\nstatus = vid_blk_write_word(dev, OUT_CTRL1, value);\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nOUT_CTRL1,\r\nFLD_OUT_MODE,\r\ndev->board.output_mode);\r\nstatus = cx231xx_dif_set_standard(dev, DIF_USE_BASEBAND);\r\nif (status < 0) {\r\ncx231xx_errdev("%s: cx231xx_dif set to By pass"\r\n" mode- errCode [%d]!\n",\r\n__func__, status);\r\nreturn status;\r\n}\r\nstatus = vid_blk_read_word(dev, DFE_CTRL1, &value);\r\nvalue |= FLD_VBI_GATE_EN;\r\nvalue |= FLD_VGA_AUTO_EN;\r\nstatus = vid_blk_write_word(dev, DFE_CTRL1, value);\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nMODE_CTRL, FLD_ACFG_DIS,\r\ncx231xx_set_field(FLD_ACFG_DIS, 1));\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nMODE_CTRL, FLD_INPUT_MODE,\r\ncx231xx_set_field(FLD_INPUT_MODE, INPUT_MODE_CVBS_0));\r\nbreak;\r\ncase CX231XX_VMUX_SVIDEO:\r\nstatus = vid_blk_read_word(dev, AFE_CTRL, &value);\r\nvalue &= (~(0x1ff8000));\r\nvalue |= 0x1000010;\r\nstatus = vid_blk_write_word(dev, AFE_CTRL, value);\r\nstatus = cx231xx_dif_set_standard(dev, DIF_USE_BASEBAND);\r\nif (status < 0) {\r\ncx231xx_errdev("%s: cx231xx_dif set to By pass"\r\n" mode- errCode [%d]!\n",\r\n__func__, status);\r\nreturn status;\r\n}\r\nstatus = vid_blk_read_word(dev, DFE_CTRL1, &value);\r\nvalue |= FLD_VBI_GATE_EN;\r\nvalue |= FLD_VGA_AUTO_EN;\r\nstatus = vid_blk_write_word(dev, DFE_CTRL1, value);\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nMODE_CTRL, FLD_ACFG_DIS,\r\ncx231xx_set_field(FLD_ACFG_DIS, 1));\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nMODE_CTRL,\r\nFLD_INPUT_MODE,\r\ncx231xx_set_field(FLD_INPUT_MODE, INPUT_MODE_YC_1));\r\nstatus = vid_blk_read_word(dev, AFE_CTRL, &value);\r\nvalue |= FLD_CHROMA_IN_SEL;\r\nvalue &= ~(FLD_VGA_SEL_CH2 | FLD_VGA_SEL_CH3);\r\nstatus = vid_blk_write_word(dev, AFE_CTRL, value);\r\nstatus = cx231xx_afe_set_mode(dev, AFE_MODE_BASEBAND);\r\nbreak;\r\ncase CX231XX_VMUX_TELEVISION:\r\ncase CX231XX_VMUX_CABLE:\r\ndefault:\r\nif (dev->board.tuner_type == TUNER_XC5000) {\r\nstatus = vid_blk_read_word(dev, AFE_CTRL, &value);\r\nvalue |= (0 << 13) | (1 << 4);\r\nvalue &= ~(1 << 5);\r\nvalue &= (~(0x1FF8000));\r\nvalue |= 0x1000000;\r\nstatus = vid_blk_write_word(dev, AFE_CTRL, value);\r\nstatus = vid_blk_read_word(dev, OUT_CTRL1, &value);\r\nvalue |= (1 << 7);\r\nstatus = vid_blk_write_word(dev, OUT_CTRL1, value);\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nOUT_CTRL1, FLD_OUT_MODE,\r\ndev->board.output_mode);\r\nstatus = cx231xx_dif_set_standard(dev,\r\nDIF_USE_BASEBAND);\r\nif (status < 0) {\r\ncx231xx_errdev("%s: cx231xx_dif set to By pass"\r\n" mode- errCode [%d]!\n",\r\n__func__, status);\r\nreturn status;\r\n}\r\nstatus = vid_blk_read_word(dev, DFE_CTRL1, &value);\r\nvalue |= FLD_VBI_GATE_EN;\r\nvalue |= FLD_VGA_AUTO_EN;\r\nstatus = vid_blk_write_word(dev, DFE_CTRL1, value);\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nMODE_CTRL, FLD_ACFG_DIS,\r\ncx231xx_set_field(FLD_ACFG_DIS, 1));\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nMODE_CTRL, FLD_INPUT_MODE,\r\ncx231xx_set_field(FLD_INPUT_MODE,\r\nINPUT_MODE_CVBS_0));\r\n} else {\r\nstatus = cx231xx_dif_set_standard(dev, dev->norm);\r\nif (status < 0) {\r\ncx231xx_errdev("%s: cx231xx_dif set to By pass"\r\n" mode- errCode [%d]!\n",\r\n__func__, status);\r\nreturn status;\r\n}\r\nstatus = vid_blk_read_word(dev, DIF_MISC_CTRL, &value);\r\nvalue &= ~FLD_DIF_DIF_BYPASS;\r\nstatus = vid_blk_write_word(dev, DIF_MISC_CTRL, value);\r\nstatus = vid_blk_read_word(dev, DFE_CTRL1, &value);\r\nvalue &= ~FLD_VBI_GATE_EN;\r\nvalue |= FLD_VGA_AUTO_EN | FLD_AGC_AUTO_EN | 0x00200000;\r\nstatus = vid_blk_write_word(dev, DFE_CTRL1, value);\r\nmsleep(1);\r\nvalue &= ~(FLD_VGA_AUTO_EN);\r\nstatus = vid_blk_write_word(dev, DFE_CTRL1, value);\r\nstatus = vid_blk_read_word(dev, PIN_CTRL, &value);\r\nvalue |= (FLD_OEF_AGC_RF) |\r\n(FLD_OEF_AGC_IFVGA) |\r\n(FLD_OEF_AGC_IF);\r\nstatus = vid_blk_write_word(dev, PIN_CTRL, value);\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nOUT_CTRL1, FLD_OUT_MODE,\r\ndev->board.output_mode);\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nMODE_CTRL, FLD_ACFG_DIS,\r\ncx231xx_set_field(FLD_ACFG_DIS, 1));\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nMODE_CTRL, FLD_INPUT_MODE,\r\ncx231xx_set_field(FLD_INPUT_MODE,\r\nINPUT_MODE_CVBS_0));\r\nstatus = vid_blk_read_word(dev, AFE_CTRL, &value);\r\nvalue &= (~(FLD_FUNC_MODE));\r\nvalue |= 0x800000;\r\nvalue |= FLD_VGA_SEL_CH3 | FLD_VGA_SEL_CH2;\r\nstatus = vid_blk_write_word(dev, AFE_CTRL, value);\r\nif (dev->tuner_type == TUNER_NXP_TDA18271) {\r\nstatus = vid_blk_read_word(dev, PIN_CTRL,\r\n&value);\r\nstatus = vid_blk_write_word(dev, PIN_CTRL,\r\n(value & 0xFFFFFFEF));\r\n}\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nOUT_CTRL1, FLD_VBIHACTRAW_EN,\r\ncx231xx_set_field(FLD_VBIHACTRAW_EN, 1));\r\nstatus = vid_blk_read_word(dev, OUT_CTRL1, &value);\r\nif (value & 0x02) {\r\nvalue |= (1 << 19);\r\nstatus = vid_blk_write_word(dev, OUT_CTRL1, value);\r\n}\r\nreturn status;\r\n}\r\nvoid cx231xx_enable656(struct cx231xx *dev)\r\n{\r\nu8 temp = 0;\r\nint status;\r\nstatus = vid_blk_write_byte(dev, TS1_PIN_CTL0, 0xFF);\r\nstatus = vid_blk_read_byte(dev, TS1_PIN_CTL1, &temp);\r\ntemp = temp|0x04;\r\nstatus = vid_blk_write_byte(dev, TS1_PIN_CTL1, temp);\r\n}\r\nvoid cx231xx_disable656(struct cx231xx *dev)\r\n{\r\nu8 temp = 0;\r\nint status;\r\nstatus = vid_blk_write_byte(dev, TS1_PIN_CTL0, 0x00);\r\nstatus = vid_blk_read_byte(dev, TS1_PIN_CTL1, &temp);\r\ntemp = temp&0xFB;\r\nstatus = vid_blk_write_byte(dev, TS1_PIN_CTL1, temp);\r\n}\r\nint cx231xx_do_mode_ctrl_overrides(struct cx231xx *dev)\r\n{\r\nint status = 0;\r\ncx231xx_info("do_mode_ctrl_overrides : 0x%x\n",\r\n(unsigned int)dev->norm);\r\nstatus = vid_blk_write_word(dev, DFE_CTRL3, 0xCD3F0280);\r\nif (dev->norm & (V4L2_STD_NTSC | V4L2_STD_PAL_M)) {\r\ncx231xx_info("do_mode_ctrl_overrides NTSC\n");\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nVERT_TIM_CTRL,\r\nFLD_VBLANK_CNT, 0x18);\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nVERT_TIM_CTRL,\r\nFLD_VACTIVE_CNT,\r\n0x1E7000);\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nVERT_TIM_CTRL,\r\nFLD_V656BLANK_CNT,\r\n0x1C000000);\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nHORIZ_TIM_CTRL,\r\nFLD_HBLANK_CNT,\r\ncx231xx_set_field\r\n(FLD_HBLANK_CNT, 0x79));\r\n} else if (dev->norm & V4L2_STD_SECAM) {\r\ncx231xx_info("do_mode_ctrl_overrides SECAM\n");\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nVERT_TIM_CTRL,\r\nFLD_VBLANK_CNT, 0x20);\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nVERT_TIM_CTRL,\r\nFLD_VACTIVE_CNT,\r\ncx231xx_set_field\r\n(FLD_VACTIVE_CNT,\r\n0x244));\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nVERT_TIM_CTRL,\r\nFLD_V656BLANK_CNT,\r\ncx231xx_set_field\r\n(FLD_V656BLANK_CNT,\r\n0x24));\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nHORIZ_TIM_CTRL,\r\nFLD_HBLANK_CNT,\r\ncx231xx_set_field\r\n(FLD_HBLANK_CNT, 0x85));\r\n} else {\r\ncx231xx_info("do_mode_ctrl_overrides PAL\n");\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nVERT_TIM_CTRL,\r\nFLD_VBLANK_CNT, 0x20);\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nVERT_TIM_CTRL,\r\nFLD_VACTIVE_CNT,\r\ncx231xx_set_field\r\n(FLD_VACTIVE_CNT,\r\n0x244));\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nVERT_TIM_CTRL,\r\nFLD_V656BLANK_CNT,\r\ncx231xx_set_field\r\n(FLD_V656BLANK_CNT,\r\n0x24));\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nHORIZ_TIM_CTRL,\r\nFLD_HBLANK_CNT,\r\ncx231xx_set_field\r\n(FLD_HBLANK_CNT, 0x85));\r\n}\r\nreturn status;\r\n}\r\nint cx231xx_unmute_audio(struct cx231xx *dev)\r\n{\r\nreturn vid_blk_write_byte(dev, PATH1_VOL_CTL, 0x24);\r\n}\r\nint stopAudioFirmware(struct cx231xx *dev)\r\n{\r\nreturn vid_blk_write_byte(dev, DL_CTL_CONTROL, 0x03);\r\n}\r\nint restartAudioFirmware(struct cx231xx *dev)\r\n{\r\nreturn vid_blk_write_byte(dev, DL_CTL_CONTROL, 0x13);\r\n}\r\nint cx231xx_set_audio_input(struct cx231xx *dev, u8 input)\r\n{\r\nint status = 0;\r\nenum AUDIO_INPUT ainput = AUDIO_INPUT_LINE;\r\nswitch (INPUT(input)->amux) {\r\ncase CX231XX_AMUX_VIDEO:\r\nainput = AUDIO_INPUT_TUNER_TV;\r\nbreak;\r\ncase CX231XX_AMUX_LINE_IN:\r\nstatus = cx231xx_i2s_blk_set_audio_input(dev, input);\r\nainput = AUDIO_INPUT_LINE;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nstatus = cx231xx_set_audio_decoder_input(dev, ainput);\r\nreturn status;\r\n}\r\nint cx231xx_set_audio_decoder_input(struct cx231xx *dev,\r\nenum AUDIO_INPUT audio_input)\r\n{\r\nu32 dwval;\r\nint status;\r\nu8 gen_ctrl;\r\nu32 value = 0;\r\nstatus = vid_blk_read_byte(dev, GENERAL_CTL, &gen_ctrl);\r\ngen_ctrl |= 1;\r\nstatus = vid_blk_write_byte(dev, GENERAL_CTL, gen_ctrl);\r\nswitch (audio_input) {\r\ncase AUDIO_INPUT_LINE:\r\nvalue = cx231xx_set_field(FLD_AUD_CHAN1_SRC,\r\nAUD_CHAN_SRC_PARALLEL);\r\nstatus = vid_blk_write_word(dev, AUD_IO_CTRL, value);\r\nstatus = vid_blk_read_word(dev, AC97_CTL, &dwval);\r\nstatus = vid_blk_write_word(dev, AC97_CTL,\r\n(dwval | FLD_AC97_UP2X_BYPASS));\r\nstatus = vid_blk_write_word(dev, BAND_OUT_SEL,\r\ncx231xx_set_field(FLD_SRC3_IN_SEL, 0x0) |\r\ncx231xx_set_field(FLD_SRC3_CLK_SEL, 0x0) |\r\ncx231xx_set_field(FLD_PARALLEL1_SRC_SEL, 0x0));\r\nstatus = vid_blk_write_word(dev, DL_CTL, 0x3000001);\r\nstatus = vid_blk_write_word(dev, PATH1_CTL1, 0x00063073);\r\nstatus = vid_blk_read_word(dev, PATH1_VOL_CTL, &dwval);\r\nstatus = vid_blk_write_word(dev, PATH1_VOL_CTL,\r\n(dwval | FLD_PATH1_AVC_THRESHOLD));\r\nstatus = vid_blk_read_word(dev, PATH1_SC_CTL, &dwval);\r\nstatus = vid_blk_write_word(dev, PATH1_SC_CTL,\r\n(dwval | FLD_PATH1_SC_THRESHOLD));\r\nbreak;\r\ncase AUDIO_INPUT_TUNER_TV:\r\ndefault:\r\nstatus = stopAudioFirmware(dev);\r\nstatus = vid_blk_write_word(dev, BAND_OUT_SEL,\r\ncx231xx_set_field(FLD_SRC6_IN_SEL, 0x00) |\r\ncx231xx_set_field(FLD_SRC6_CLK_SEL, 0x01) |\r\ncx231xx_set_field(FLD_SRC5_IN_SEL, 0x00) |\r\ncx231xx_set_field(FLD_SRC5_CLK_SEL, 0x02) |\r\ncx231xx_set_field(FLD_SRC4_IN_SEL, 0x02) |\r\ncx231xx_set_field(FLD_SRC4_CLK_SEL, 0x03) |\r\ncx231xx_set_field(FLD_SRC3_IN_SEL, 0x00) |\r\ncx231xx_set_field(FLD_SRC3_CLK_SEL, 0x00) |\r\ncx231xx_set_field(FLD_BASEBAND_BYPASS_CTL, 0x00) |\r\ncx231xx_set_field(FLD_AC97_SRC_SEL, 0x03) |\r\ncx231xx_set_field(FLD_I2S_SRC_SEL, 0x00) |\r\ncx231xx_set_field(FLD_PARALLEL2_SRC_SEL, 0x02) |\r\ncx231xx_set_field(FLD_PARALLEL1_SRC_SEL, 0x01));\r\nstatus = vid_blk_write_word(dev, AUD_IO_CTRL,\r\ncx231xx_set_field(FLD_I2S_PORT_DIR, 0x00) |\r\ncx231xx_set_field(FLD_I2S_OUT_SRC, 0x00) |\r\ncx231xx_set_field(FLD_AUD_CHAN3_SRC, 0x00) |\r\ncx231xx_set_field(FLD_AUD_CHAN2_SRC, 0x00) |\r\ncx231xx_set_field(FLD_AUD_CHAN1_SRC, 0x03));\r\nstatus = vid_blk_write_word(dev, PATH1_CTL1, 0x1F063870);\r\nstatus = vid_blk_write_word(dev, PATH1_CTL1, 0x00063870);\r\nstatus = restartAudioFirmware(dev);\r\nswitch (dev->board.tuner_type) {\r\ncase TUNER_XC5000:\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nCHIP_CTRL,\r\nFLD_SIF_EN,\r\ncx231xx_set_field(FLD_SIF_EN, 1));\r\nbreak;\r\ncase TUNER_NXP_TDA18271:\r\nstatus = cx231xx_read_modify_write_i2c_dword(dev,\r\nVID_BLK_I2C_ADDRESS,\r\nCHIP_CTRL,\r\nFLD_SIF_EN,\r\ncx231xx_set_field(FLD_SIF_EN, 0));\r\nbreak;\r\ndefault:\r\nprintk(KERN_INFO "Unknown tuner type configuring SIF");\r\nbreak;\r\n}\r\nbreak;\r\ncase AUDIO_INPUT_TUNER_FM:\r\nbreak;\r\ncase AUDIO_INPUT_MUTE:\r\nstatus = vid_blk_write_word(dev, PATH1_CTL1, 0x1F011012);\r\nbreak;\r\n}\r\nstatus = vid_blk_read_byte(dev, GENERAL_CTL, &gen_ctrl);\r\ngen_ctrl &= ~1;\r\nstatus = vid_blk_write_byte(dev, GENERAL_CTL, gen_ctrl);\r\nreturn status;\r\n}\r\nint cx231xx_init_ctrl_pin_status(struct cx231xx *dev)\r\n{\r\nu32 value;\r\nint status = 0;\r\nstatus = vid_blk_read_word(dev, PIN_CTRL, &value);\r\nvalue |= (~dev->board.ctl_pin_status_mask);\r\nstatus = vid_blk_write_word(dev, PIN_CTRL, value);\r\nreturn status;\r\n}\r\nint cx231xx_set_agc_analog_digital_mux_select(struct cx231xx *dev,\r\nu8 analog_or_digital)\r\n{\r\nint status = 0;\r\nstatus = cx231xx_set_gpio_direction(dev,\r\ndev->board.\r\nagc_analog_digital_select_gpio, 1);\r\nstatus = cx231xx_set_gpio_value(dev,\r\ndev->board.agc_analog_digital_select_gpio,\r\nanalog_or_digital);\r\nreturn status;\r\n}\r\nint cx231xx_enable_i2c_port_3(struct cx231xx *dev, bool is_port_3)\r\n{\r\nu8 value[4] = { 0, 0, 0, 0 };\r\nint status = 0;\r\nbool current_is_port_3;\r\nif (dev->board.dont_use_port_3)\r\nis_port_3 = false;\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nif (status < 0)\r\nreturn status;\r\ncurrent_is_port_3 = value[0] & I2C_DEMOD_EN ? true : false;\r\nif (current_is_port_3 == is_port_3)\r\nreturn 0;\r\nif (is_port_3)\r\nvalue[0] |= I2C_DEMOD_EN;\r\nelse\r\nvalue[0] &= ~I2C_DEMOD_EN;\r\ncx231xx_info("Changing the i2c master port to %d\n",\r\nis_port_3 ? 3 : 1);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nreturn status;\r\n}\r\nvoid update_HH_register_after_set_DIF(struct cx231xx *dev)\r\n{\r\n}\r\nvoid cx231xx_dump_HH_reg(struct cx231xx *dev)\r\n{\r\nu8 status = 0;\r\nu32 value = 0;\r\nu16 i = 0;\r\nvalue = 0x45005390;\r\nstatus = vid_blk_write_word(dev, 0x104, value);\r\nfor (i = 0x100; i < 0x140; i++) {\r\nstatus = vid_blk_read_word(dev, i, &value);\r\ncx231xx_info("reg0x%x=0x%x\n", i, value);\r\ni = i+3;\r\n}\r\nfor (i = 0x300; i < 0x400; i++) {\r\nstatus = vid_blk_read_word(dev, i, &value);\r\ncx231xx_info("reg0x%x=0x%x\n", i, value);\r\ni = i+3;\r\n}\r\nfor (i = 0x400; i < 0x440; i++) {\r\nstatus = vid_blk_read_word(dev, i, &value);\r\ncx231xx_info("reg0x%x=0x%x\n", i, value);\r\ni = i+3;\r\n}\r\nstatus = vid_blk_read_word(dev, AFE_CTRL_C2HH_SRC_CTRL, &value);\r\ncx231xx_info("AFE_CTRL_C2HH_SRC_CTRL=0x%x\n", value);\r\nvid_blk_write_word(dev, AFE_CTRL_C2HH_SRC_CTRL, 0x4485D390);\r\nstatus = vid_blk_read_word(dev, AFE_CTRL_C2HH_SRC_CTRL, &value);\r\ncx231xx_info("AFE_CTRL_C2HH_SRC_CTRL=0x%x\n", value);\r\n}\r\nvoid cx231xx_dump_SC_reg(struct cx231xx *dev)\r\n{\r\nu8 value[4] = { 0, 0, 0, 0 };\r\nint status = 0;\r\ncx231xx_info("cx231xx_dump_SC_reg!\n");\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, BOARD_CFG_STAT,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", BOARD_CFG_STAT, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, TS_MODE_REG,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", TS_MODE_REG, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, TS1_CFG_REG,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", TS1_CFG_REG, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, TS1_LENGTH_REG,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", TS1_LENGTH_REG, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, TS2_CFG_REG,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", TS2_CFG_REG, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, TS2_LENGTH_REG,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", TS2_LENGTH_REG, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, EP_MODE_SET,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", EP_MODE_SET, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_PWR_PTN1,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", CIR_PWR_PTN1, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_PWR_PTN2,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", CIR_PWR_PTN2, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_PWR_PTN3,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", CIR_PWR_PTN3, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_PWR_MASK0,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", CIR_PWR_MASK0, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_PWR_MASK1,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", CIR_PWR_MASK1, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_PWR_MASK2,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", CIR_PWR_MASK2, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_GAIN,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", CIR_GAIN, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_CAR_REG,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", CIR_CAR_REG, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_OT_CFG1,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", CIR_OT_CFG1, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, CIR_OT_CFG2,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", CIR_OT_CFG2, value[0],\r\nvalue[1], value[2], value[3]);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, PWR_CTL_EN,\r\nvalue, 4);\r\ncx231xx_info("reg0x%x=0x%x 0x%x 0x%x 0x%x\n", PWR_CTL_EN, value[0],\r\nvalue[1], value[2], value[3]);\r\n}\r\nvoid cx231xx_Setup_AFE_for_LowIF(struct cx231xx *dev)\r\n{\r\nu8 status = 0;\r\nu8 value = 0;\r\nstatus = afe_read_byte(dev, ADC_STATUS2_CH3, &value);\r\nvalue = (value & 0xFE)|0x01;\r\nstatus = afe_write_byte(dev, ADC_STATUS2_CH3, value);\r\nstatus = afe_read_byte(dev, ADC_STATUS2_CH3, &value);\r\nvalue = (value & 0xFE)|0x00;\r\nstatus = afe_write_byte(dev, ADC_STATUS2_CH3, value);\r\nstatus = afe_read_byte(dev, ADC_NTF_PRECLMP_EN_CH3, &value);\r\nvalue = (value & 0xFC)|0x00;\r\nstatus = afe_write_byte(dev, ADC_NTF_PRECLMP_EN_CH3, value);\r\nstatus = afe_read_byte(dev, ADC_INPUT_CH3, &value);\r\nvalue = (value & 0xF9)|0x02;\r\nstatus = afe_write_byte(dev, ADC_INPUT_CH3, value);\r\nstatus = afe_read_byte(dev, ADC_FB_FRCRST_CH3, &value);\r\nvalue = (value & 0xFB)|0x04;\r\nstatus = afe_write_byte(dev, ADC_FB_FRCRST_CH3, value);\r\nstatus = afe_read_byte(dev, ADC_DCSERVO_DEM_CH3, &value);\r\nvalue = (value & 0xFC)|0x03;\r\nstatus = afe_write_byte(dev, ADC_DCSERVO_DEM_CH3, value);\r\nstatus = afe_read_byte(dev, ADC_CTRL_DAC1_CH3, &value);\r\nvalue = (value & 0xFB)|0x04;\r\nstatus = afe_write_byte(dev, ADC_CTRL_DAC1_CH3, value);\r\nstatus = afe_read_byte(dev, ADC_CTRL_DAC23_CH3, &value);\r\nvalue = (value & 0xF8)|0x06;\r\nstatus = afe_write_byte(dev, ADC_CTRL_DAC23_CH3, value);\r\nstatus = afe_read_byte(dev, ADC_CTRL_DAC23_CH3, &value);\r\nvalue = (value & 0x8F)|0x40;\r\nstatus = afe_write_byte(dev, ADC_CTRL_DAC23_CH3, value);\r\nstatus = afe_read_byte(dev, ADC_PWRDN_CLAMP_CH3, &value);\r\nvalue = (value & 0xDF)|0x20;\r\nstatus = afe_write_byte(dev, ADC_PWRDN_CLAMP_CH3, value);\r\n}\r\nvoid cx231xx_set_Colibri_For_LowIF(struct cx231xx *dev, u32 if_freq,\r\nu8 spectral_invert, u32 mode)\r\n{\r\nu32 colibri_carrier_offset = 0;\r\nu8 status = 0;\r\nu32 func_mode = 0x01;\r\nu32 standard = 0;\r\nu8 value[4] = { 0, 0, 0, 0 };\r\ncx231xx_info("Enter cx231xx_set_Colibri_For_LowIF()\n");\r\nvalue[0] = (u8) 0x6F;\r\nvalue[1] = (u8) 0x6F;\r\nvalue[2] = (u8) 0x6F;\r\nvalue[3] = (u8) 0x6F;\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nstatus = cx231xx_afe_set_mode(dev, AFE_MODE_LOW_IF);\r\nstandard = dev->norm;\r\nstatus = cx231xx_dif_configure_C2HH_for_low_IF(dev, dev->active_mode,\r\nfunc_mode, standard);\r\ncolibri_carrier_offset = cx231xx_Get_Colibri_CarrierOffset(mode,\r\nstandard);\r\ncx231xx_info("colibri_carrier_offset=%d, standard=0x%x\n",\r\ncolibri_carrier_offset, standard);\r\ncx231xx_set_DIF_bandpass(dev, (if_freq+colibri_carrier_offset),\r\nspectral_invert, mode);\r\n}\r\nu32 cx231xx_Get_Colibri_CarrierOffset(u32 mode, u32 standerd)\r\n{\r\nu32 colibri_carrier_offset = 0;\r\nif (mode == TUNER_MODE_FM_RADIO) {\r\ncolibri_carrier_offset = 1100000;\r\n} else if (standerd & (V4L2_STD_MN | V4L2_STD_NTSC_M_JP)) {\r\ncolibri_carrier_offset = 4832000;\r\n} else if (standerd & (V4L2_STD_PAL_B | V4L2_STD_PAL_G)) {\r\ncolibri_carrier_offset = 2700000;\r\n} else if (standerd & (V4L2_STD_PAL_D | V4L2_STD_PAL_I\r\n| V4L2_STD_SECAM)) {\r\ncolibri_carrier_offset = 2100000;\r\n}\r\nreturn colibri_carrier_offset;\r\n}\r\nvoid cx231xx_set_DIF_bandpass(struct cx231xx *dev, u32 if_freq,\r\nu8 spectral_invert, u32 mode)\r\n{\r\nunsigned long pll_freq_word;\r\nint status = 0;\r\nu32 dif_misc_ctrl_value = 0;\r\nu64 pll_freq_u64 = 0;\r\nu32 i = 0;\r\ncx231xx_info("if_freq=%d;spectral_invert=0x%x;mode=0x%x\n",\r\nif_freq, spectral_invert, mode);\r\nif (mode == TUNER_MODE_FM_RADIO) {\r\npll_freq_word = 0x905A1CAC;\r\nstatus = vid_blk_write_word(dev, DIF_PLL_FREQ_WORD, pll_freq_word);\r\n} else {\r\npll_freq_word = if_freq;\r\npll_freq_u64 = (u64)pll_freq_word << 28L;\r\ndo_div(pll_freq_u64, 50000000);\r\npll_freq_word = (u32)pll_freq_u64;\r\nstatus = vid_blk_write_word(dev, DIF_PLL_FREQ_WORD, pll_freq_word);\r\nif (spectral_invert) {\r\nif_freq -= 400000;\r\nstatus = vid_blk_read_word(dev, DIF_MISC_CTRL,\r\n&dif_misc_ctrl_value);\r\ndif_misc_ctrl_value = dif_misc_ctrl_value | 0x00200000;\r\nstatus = vid_blk_write_word(dev, DIF_MISC_CTRL,\r\ndif_misc_ctrl_value);\r\n} else {\r\nif_freq += 400000;\r\nstatus = vid_blk_read_word(dev, DIF_MISC_CTRL,\r\n&dif_misc_ctrl_value);\r\ndif_misc_ctrl_value = dif_misc_ctrl_value & 0xFFDFFFFF;\r\nstatus = vid_blk_write_word(dev, DIF_MISC_CTRL,\r\ndif_misc_ctrl_value);\r\n}\r\nif_freq = (if_freq/100000)*100000;\r\nif (if_freq < 3000000)\r\nif_freq = 3000000;\r\nif (if_freq > 16000000)\r\nif_freq = 16000000;\r\n}\r\ncx231xx_info("Enter IF=%zd\n",\r\nsizeof(Dif_set_array)/sizeof(struct dif_settings));\r\nfor (i = 0; i < sizeof(Dif_set_array)/sizeof(struct dif_settings); i++) {\r\nif (Dif_set_array[i].if_freq == if_freq) {\r\nstatus = vid_blk_write_word(dev,\r\nDif_set_array[i].register_address, Dif_set_array[i].value);\r\n}\r\n}\r\n}\r\nint cx231xx_dif_configure_C2HH_for_low_IF(struct cx231xx *dev, u32 mode,\r\nu32 function_mode, u32 standard)\r\n{\r\nint status = 0;\r\nif (mode == V4L2_TUNER_RADIO) {\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 30, 31, 0x1);\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 23, 24, function_mode);\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 15, 22, 0xFF);\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 9, 9, 0x1);\r\n} else if (standard != DIF_USE_BASEBAND) {\r\nif (standard & V4L2_STD_MN) {\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 30, 31, 0x1);\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 23, 24,\r\nfunction_mode);\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 15, 22, 0xb);\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 9, 9, 0x1);\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAUD_IO_CTRL, 0, 31, 0x00000003);\r\n} else if ((standard == V4L2_STD_PAL_I) |\r\n(standard & V4L2_STD_PAL_D) |\r\n(standard & V4L2_STD_SECAM)) {\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 30, 31, 0x1);\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 23, 24,\r\nfunction_mode);\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 15, 22, 0xF);\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 9, 9, 0x1);\r\n} else {\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 30, 31, 0x1);\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 23, 24,\r\nfunction_mode);\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 15, 22, 0xE);\r\nstatus = cx231xx_reg_mask_write(dev,\r\nVID_BLK_I2C_ADDRESS, 32,\r\nAFE_CTRL_C2HH_SRC_CTRL, 9, 9, 0x1);\r\n}\r\n}\r\nreturn status;\r\n}\r\nint cx231xx_dif_set_standard(struct cx231xx *dev, u32 standard)\r\n{\r\nint status = 0;\r\nu32 dif_misc_ctrl_value = 0;\r\nu32 func_mode = 0;\r\ncx231xx_info("%s: setStandard to %x\n", __func__, standard);\r\nstatus = vid_blk_read_word(dev, DIF_MISC_CTRL, &dif_misc_ctrl_value);\r\nif (standard != DIF_USE_BASEBAND)\r\ndev->norm = standard;\r\nswitch (dev->model) {\r\ncase CX231XX_BOARD_CNXT_CARRAERA:\r\ncase CX231XX_BOARD_CNXT_RDE_250:\r\ncase CX231XX_BOARD_CNXT_SHELBY:\r\ncase CX231XX_BOARD_CNXT_RDU_250:\r\ncase CX231XX_BOARD_CNXT_VIDEO_GRABBER:\r\ncase CX231XX_BOARD_HAUPPAUGE_EXETER:\r\nfunc_mode = 0x03;\r\nbreak;\r\ncase CX231XX_BOARD_CNXT_RDE_253S:\r\ncase CX231XX_BOARD_CNXT_RDU_253S:\r\ncase CX231XX_BOARD_HAUPPAUGE_USB2_FM_PAL:\r\ncase CX231XX_BOARD_HAUPPAUGE_USB2_FM_NTSC:\r\nfunc_mode = 0x01;\r\nbreak;\r\ndefault:\r\nfunc_mode = 0x01;\r\n}\r\nstatus = cx231xx_dif_configure_C2HH_for_low_IF(dev, dev->active_mode,\r\nfunc_mode, standard);\r\nif (standard == DIF_USE_BASEBAND) {\r\nstatus = vid_blk_write_word(dev, DIF_SRC_PHASE_INC, 0xDF7DF83);\r\nstatus = vid_blk_read_word(dev, DIF_MISC_CTRL,\r\n&dif_misc_ctrl_value);\r\ndif_misc_ctrl_value |= FLD_DIF_DIF_BYPASS;\r\nstatus = vid_blk_write_word(dev, DIF_MISC_CTRL,\r\ndif_misc_ctrl_value);\r\n} else if (standard & V4L2_STD_PAL_D) {\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL, 0, 31, 0x6503bc0c);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL1, 0, 31, 0xbd038c85);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL2, 0, 31, 0x1db4640a);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL3, 0, 31, 0x00008800);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_IF_REF, 0, 31, 0x444C1380);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_IF, 0, 31, 0xDA302600);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_INT, 0, 31, 0xDA261700);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_RF, 0, 31, 0xDA262600);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_IF_INT_CURRENT, 0, 31,\r\n0x26001700);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_RF_CURRENT, 0, 31,\r\n0x00002660);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_VIDEO_AGC_CTRL, 0, 31,\r\n0x72500800);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_VID_AUD_OVERRIDE, 0, 31,\r\n0x27000100);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AV_SEP_CTRL, 0, 31, 0x3F3934EA);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_COMP_FLT_CTRL, 0, 31,\r\n0x00000000);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_SRC_PHASE_INC, 0, 31,\r\n0x1befbf06);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_SRC_GAIN_CONTROL, 0, 31,\r\n0x000035e8);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_RPT_VARIANCE, 0, 31, 0x00000000);\r\ndif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\r\ndif_misc_ctrl_value |= 0x3a023F11;\r\n} else if (standard & V4L2_STD_PAL_I) {\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL, 0, 31, 0x6503bc0c);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL1, 0, 31, 0xbd038c85);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL2, 0, 31, 0x1db4640a);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL3, 0, 31, 0x00008800);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_IF_REF, 0, 31, 0x444C1380);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_IF, 0, 31, 0xDA302600);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_INT, 0, 31, 0xDA261700);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_RF, 0, 31, 0xDA262600);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_IF_INT_CURRENT, 0, 31,\r\n0x26001700);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_RF_CURRENT, 0, 31,\r\n0x00002660);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_VIDEO_AGC_CTRL, 0, 31,\r\n0x72500800);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_VID_AUD_OVERRIDE, 0, 31,\r\n0x27000100);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AV_SEP_CTRL, 0, 31, 0x5F39A934);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_COMP_FLT_CTRL, 0, 31,\r\n0x00000000);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_SRC_PHASE_INC, 0, 31,\r\n0x1befbf06);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_SRC_GAIN_CONTROL, 0, 31,\r\n0x000035e8);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_RPT_VARIANCE, 0, 31, 0x00000000);\r\ndif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\r\ndif_misc_ctrl_value |= 0x3a033F11;\r\n} else if (standard & V4L2_STD_PAL_M) {\r\nstatus = vid_blk_write_word(dev, DIF_PLL_CTRL, 0xFF01FF0C);\r\nstatus = vid_blk_write_word(dev, DIF_PLL_CTRL1, 0xbd038c85);\r\nstatus = vid_blk_write_word(dev, DIF_PLL_CTRL2, 0x1db4640a);\r\nstatus = vid_blk_write_word(dev, DIF_PLL_CTRL3, 0x00008800);\r\nstatus = vid_blk_write_word(dev, DIF_AGC_IF_REF, 0x444C1380);\r\nstatus = vid_blk_write_word(dev, DIF_AGC_IF_INT_CURRENT,\r\n0x26001700);\r\nstatus = vid_blk_write_word(dev, DIF_AGC_RF_CURRENT,\r\n0x00002660);\r\nstatus = vid_blk_write_word(dev, DIF_VIDEO_AGC_CTRL,\r\n0x72500800);\r\nstatus = vid_blk_write_word(dev, DIF_VID_AUD_OVERRIDE,\r\n0x27000100);\r\nstatus = vid_blk_write_word(dev, DIF_AV_SEP_CTRL, 0x012c405d);\r\nstatus = vid_blk_write_word(dev, DIF_COMP_FLT_CTRL,\r\n0x009f50c1);\r\nstatus = vid_blk_write_word(dev, DIF_SRC_PHASE_INC,\r\n0x1befbf06);\r\nstatus = vid_blk_write_word(dev, DIF_SRC_GAIN_CONTROL,\r\n0x000035e8);\r\nstatus = vid_blk_write_word(dev, DIF_SOFT_RST_CTRL_REVB,\r\n0x00000000);\r\ndif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\r\ndif_misc_ctrl_value |= 0x3A0A3F10;\r\n} else if (standard & (V4L2_STD_PAL_N | V4L2_STD_PAL_Nc)) {\r\nstatus = vid_blk_write_word(dev, DIF_PLL_CTRL, 0xFF01FF0C);\r\nstatus = vid_blk_write_word(dev, DIF_PLL_CTRL1, 0xbd038c85);\r\nstatus = vid_blk_write_word(dev, DIF_PLL_CTRL2, 0x1db4640a);\r\nstatus = vid_blk_write_word(dev, DIF_PLL_CTRL3, 0x00008800);\r\nstatus = vid_blk_write_word(dev, DIF_AGC_IF_REF, 0x444C1380);\r\nstatus = vid_blk_write_word(dev, DIF_AGC_IF_INT_CURRENT,\r\n0x26001700);\r\nstatus = vid_blk_write_word(dev, DIF_AGC_RF_CURRENT,\r\n0x00002660);\r\nstatus = vid_blk_write_word(dev, DIF_VIDEO_AGC_CTRL,\r\n0x72500800);\r\nstatus = vid_blk_write_word(dev, DIF_VID_AUD_OVERRIDE,\r\n0x27000100);\r\nstatus = vid_blk_write_word(dev, DIF_AV_SEP_CTRL,\r\n0x012c405d);\r\nstatus = vid_blk_write_word(dev, DIF_COMP_FLT_CTRL,\r\n0x009f50c1);\r\nstatus = vid_blk_write_word(dev, DIF_SRC_PHASE_INC,\r\n0x1befbf06);\r\nstatus = vid_blk_write_word(dev, DIF_SRC_GAIN_CONTROL,\r\n0x000035e8);\r\nstatus = vid_blk_write_word(dev, DIF_SOFT_RST_CTRL_REVB,\r\n0x00000000);\r\ndif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\r\ndif_misc_ctrl_value = 0x3A093F10;\r\n} else if (standard &\r\n(V4L2_STD_SECAM_B | V4L2_STD_SECAM_D | V4L2_STD_SECAM_G |\r\nV4L2_STD_SECAM_K | V4L2_STD_SECAM_K1)) {\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL, 0, 31, 0x6503bc0c);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL1, 0, 31, 0xbd038c85);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL2, 0, 31, 0x1db4640a);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL3, 0, 31, 0x00008800);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_IF_REF, 0, 31, 0x888C0380);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_IF, 0, 31, 0xe0262600);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_INT, 0, 31, 0xc2171700);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_RF, 0, 31, 0xc2262600);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_IF_INT_CURRENT, 0, 31,\r\n0x26001700);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_RF_CURRENT, 0, 31,\r\n0x00002660);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_VID_AUD_OVERRIDE, 0, 31,\r\n0x27000100);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AV_SEP_CTRL, 0, 31, 0x3F3530ec);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_COMP_FLT_CTRL, 0, 31,\r\n0x00000000);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_SRC_PHASE_INC, 0, 31,\r\n0x1befbf06);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_SRC_GAIN_CONTROL, 0, 31,\r\n0x000035e8);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_RPT_VARIANCE, 0, 31, 0x00000000);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_VIDEO_AGC_CTRL, 0, 31,\r\n0xf4000000);\r\ndif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\r\ndif_misc_ctrl_value |= 0x3a023F11;\r\n} else if (standard & (V4L2_STD_SECAM_L | V4L2_STD_SECAM_LC)) {\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL, 0, 31, 0x6503bc0c);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL1, 0, 31, 0xbd038c85);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL2, 0, 31, 0x1db4640a);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL3, 0, 31, 0x00008800);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_IF_REF, 0, 31, 0x888C0380);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_IF, 0, 31, 0xe0262600);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_INT, 0, 31, 0xc2171700);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_RF, 0, 31, 0xc2262600);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_IF_INT_CURRENT, 0, 31,\r\n0x26001700);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_RF_CURRENT, 0, 31,\r\n0x00002660);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_VID_AUD_OVERRIDE, 0, 31,\r\n0x27000100);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AV_SEP_CTRL, 0, 31, 0x3F3530ec);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_COMP_FLT_CTRL, 0, 31,\r\n0x00000000);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_SRC_PHASE_INC, 0, 31,\r\n0x1befbf06);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_SRC_GAIN_CONTROL, 0, 31,\r\n0x000035e8);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_RPT_VARIANCE, 0, 31, 0x00000000);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_VIDEO_AGC_CTRL, 0, 31,\r\n0xf2560000);\r\ndif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\r\ndif_misc_ctrl_value |= 0x3a023F11;\r\n} else if (standard & V4L2_STD_NTSC_M) {\r\nstatus = vid_blk_write_word(dev, DIF_PLL_CTRL, 0x6503BC0C);\r\nstatus = vid_blk_write_word(dev, DIF_PLL_CTRL1, 0xBD038C85);\r\nstatus = vid_blk_write_word(dev, DIF_PLL_CTRL2, 0x1DB4640A);\r\nstatus = vid_blk_write_word(dev, DIF_PLL_CTRL3, 0x00008800);\r\nstatus = vid_blk_write_word(dev, DIF_AGC_IF_REF, 0x444C0380);\r\nstatus = vid_blk_write_word(dev, DIF_AGC_IF_INT_CURRENT,\r\n0x26001700);\r\nstatus = vid_blk_write_word(dev, DIF_AGC_RF_CURRENT,\r\n0x00002660);\r\nstatus = vid_blk_write_word(dev, DIF_VIDEO_AGC_CTRL,\r\n0x04000800);\r\nstatus = vid_blk_write_word(dev, DIF_VID_AUD_OVERRIDE,\r\n0x27000100);\r\nstatus = vid_blk_write_word(dev, DIF_AV_SEP_CTRL, 0x01296e1f);\r\nstatus = vid_blk_write_word(dev, DIF_COMP_FLT_CTRL,\r\n0x009f50c1);\r\nstatus = vid_blk_write_word(dev, DIF_SRC_PHASE_INC,\r\n0x1befbf06);\r\nstatus = vid_blk_write_word(dev, DIF_SRC_GAIN_CONTROL,\r\n0x000035e8);\r\nstatus = vid_blk_write_word(dev, DIF_AGC_CTRL_IF, 0xC2262600);\r\nstatus = vid_blk_write_word(dev, DIF_AGC_CTRL_INT,\r\n0xC2262600);\r\nstatus = vid_blk_write_word(dev, DIF_AGC_CTRL_RF, 0xC2262600);\r\ndif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\r\ndif_misc_ctrl_value |= 0x3a003F10;\r\n} else {\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL, 0, 31, 0x6503bc0c);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL1, 0, 31, 0xbd038c85);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL2, 0, 31, 0x1db4640a);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_PLL_CTRL3, 0, 31, 0x00008800);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_IF_REF, 0, 31, 0x444C1380);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_IF, 0, 31, 0xDA302600);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_INT, 0, 31, 0xDA261700);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_CTRL_RF, 0, 31, 0xDA262600);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_IF_INT_CURRENT, 0, 31,\r\n0x26001700);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AGC_RF_CURRENT, 0, 31,\r\n0x00002660);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_VIDEO_AGC_CTRL, 0, 31,\r\n0x72500800);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_VID_AUD_OVERRIDE, 0, 31,\r\n0x27000100);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_AV_SEP_CTRL, 0, 31, 0x3F3530EC);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_COMP_FLT_CTRL, 0, 31,\r\n0x00A653A8);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_SRC_PHASE_INC, 0, 31,\r\n0x1befbf06);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_SRC_GAIN_CONTROL, 0, 31,\r\n0x000035e8);\r\nstatus = cx231xx_reg_mask_write(dev, VID_BLK_I2C_ADDRESS, 32,\r\nDIF_RPT_VARIANCE, 0, 31, 0x00000000);\r\ndif_misc_ctrl_value &= FLD_DIF_SPEC_INV;\r\ndif_misc_ctrl_value |= 0x3a013F11;\r\n}\r\ndif_misc_ctrl_value &= ~FLD_DIF_AUD_SRC_SEL;\r\nif (dev->active_mode == V4L2_TUNER_RADIO)\r\ndif_misc_ctrl_value = 0x7a080000;\r\nstatus = vid_blk_write_word(dev, DIF_MISC_CTRL, dif_misc_ctrl_value);\r\nreturn status;\r\n}\r\nint cx231xx_tuner_pre_channel_change(struct cx231xx *dev)\r\n{\r\nint status = 0;\r\nu32 dwval;\r\nstatus = vid_blk_read_word(dev, DIF_AGC_IF_REF, &dwval);\r\ndwval &= ~(FLD_DIF_K_AGC_RF | FLD_DIF_K_AGC_IF);\r\ndwval |= 0x33000000;\r\nstatus = vid_blk_write_word(dev, DIF_AGC_IF_REF, dwval);\r\nreturn status;\r\n}\r\nint cx231xx_tuner_post_channel_change(struct cx231xx *dev)\r\n{\r\nint status = 0;\r\nu32 dwval;\r\ncx231xx_info("cx231xx_tuner_post_channel_change dev->tuner_type =0%d\n",\r\ndev->tuner_type);\r\nstatus = vid_blk_read_word(dev, DIF_AGC_IF_REF, &dwval);\r\ndwval &= ~(FLD_DIF_K_AGC_RF | FLD_DIF_K_AGC_IF);\r\nif (dev->norm & (V4L2_STD_SECAM_L | V4L2_STD_SECAM_B |\r\nV4L2_STD_SECAM_D)) {\r\nif (dev->tuner_type == TUNER_NXP_TDA18271) {\r\ndwval &= ~FLD_DIF_IF_REF;\r\ndwval |= 0x88000300;\r\n} else\r\ndwval |= 0x88000000;\r\n} else {\r\nif (dev->tuner_type == TUNER_NXP_TDA18271) {\r\ndwval &= ~FLD_DIF_IF_REF;\r\ndwval |= 0xCC000300;\r\n} else\r\ndwval |= 0x44000000;\r\n}\r\nstatus = vid_blk_write_word(dev, DIF_AGC_IF_REF, dwval);\r\nreturn status;\r\n}\r\nint cx231xx_i2s_blk_initialize(struct cx231xx *dev)\r\n{\r\nint status = 0;\r\nu32 value;\r\nstatus = cx231xx_read_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\r\nCH_PWR_CTRL1, 1, &value, 1);\r\nvalue |= 0x80;\r\nstatus = cx231xx_write_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\r\nCH_PWR_CTRL1, 1, value, 1);\r\nstatus = cx231xx_write_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\r\nCH_PWR_CTRL2, 1, 0x00, 1);\r\nreturn status;\r\n}\r\nint cx231xx_i2s_blk_update_power_control(struct cx231xx *dev,\r\nenum AV_MODE avmode)\r\n{\r\nint status = 0;\r\nu32 value = 0;\r\nif (avmode != POLARIS_AVMODE_ENXTERNAL_AV) {\r\nstatus = cx231xx_read_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\r\nCH_PWR_CTRL2, 1, &value, 1);\r\nvalue |= 0xfe;\r\nstatus = cx231xx_write_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\r\nCH_PWR_CTRL2, 1, value, 1);\r\n} else {\r\nstatus = cx231xx_write_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\r\nCH_PWR_CTRL2, 1, 0x00, 1);\r\n}\r\nreturn status;\r\n}\r\nint cx231xx_i2s_blk_set_audio_input(struct cx231xx *dev, u8 audio_input)\r\n{\r\nint status = 0;\r\nswitch (audio_input) {\r\ncase CX231XX_AMUX_LINE_IN:\r\nstatus = cx231xx_write_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\r\nCH_PWR_CTRL2, 1, 0x00, 1);\r\nstatus = cx231xx_write_i2c_data(dev, I2S_BLK_DEVICE_ADDRESS,\r\nCH_PWR_CTRL1, 1, 0x80, 1);\r\nbreak;\r\ncase CX231XX_AMUX_VIDEO:\r\ndefault:\r\nbreak;\r\n}\r\ndev->ctl_ainput = audio_input;\r\nreturn status;\r\n}\r\nint cx231xx_set_power_mode(struct cx231xx *dev, enum AV_MODE mode)\r\n{\r\nu8 value[4] = { 0, 0, 0, 0 };\r\nu32 tmp = 0;\r\nint status = 0;\r\nif (dev->power_mode != mode)\r\ndev->power_mode = mode;\r\nelse {\r\ncx231xx_info(" setPowerMode::mode = %d, No Change req.\n",\r\nmode);\r\nreturn 0;\r\n}\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, PWR_CTL_EN, value,\r\n4);\r\nif (status < 0)\r\nreturn status;\r\ntmp = *((u32 *) value);\r\nswitch (mode) {\r\ncase POLARIS_AVMODE_ENXTERNAL_AV:\r\ntmp &= (~PWR_MODE_MASK);\r\ntmp |= PWR_AV_EN;\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nmsleep(PWR_SLEEP_INTERVAL);\r\ntmp |= PWR_ISO_EN;\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus =\r\ncx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER, PWR_CTL_EN,\r\nvalue, 4);\r\nmsleep(PWR_SLEEP_INTERVAL);\r\ntmp |= POLARIS_AVMODE_ENXTERNAL_AV;\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\ndev->xc_fw_load_done = 0;\r\nbreak;\r\ncase POLARIS_AVMODE_ANALOGT_TV:\r\ntmp |= PWR_DEMOD_EN;\r\ntmp |= (I2C_DEMOD_EN);\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nmsleep(PWR_SLEEP_INTERVAL);\r\nif (!(tmp & PWR_TUNER_EN)) {\r\ntmp |= (PWR_TUNER_EN);\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nmsleep(PWR_SLEEP_INTERVAL);\r\n}\r\nif (!(tmp & PWR_AV_EN)) {\r\ntmp |= PWR_AV_EN;\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nmsleep(PWR_SLEEP_INTERVAL);\r\n}\r\nif (!(tmp & PWR_ISO_EN)) {\r\ntmp |= PWR_ISO_EN;\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nmsleep(PWR_SLEEP_INTERVAL);\r\n}\r\nif (!(tmp & POLARIS_AVMODE_ANALOGT_TV)) {\r\ntmp |= POLARIS_AVMODE_ANALOGT_TV;\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nmsleep(PWR_SLEEP_INTERVAL);\r\n}\r\nif (dev->board.tuner_type != TUNER_ABSENT) {\r\ncx231xx_enable_i2c_port_3(dev, true);\r\nif (dev->board.tuner_gpio)\r\ncx231xx_gpio_set(dev, dev->board.tuner_gpio);\r\nif (dev->cx231xx_reset_analog_tuner)\r\ndev->cx231xx_reset_analog_tuner(dev);\r\n}\r\nbreak;\r\ncase POLARIS_AVMODE_DIGITAL:\r\nif (!(tmp & PWR_TUNER_EN)) {\r\ntmp |= (PWR_TUNER_EN);\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nmsleep(PWR_SLEEP_INTERVAL);\r\n}\r\nif (!(tmp & PWR_AV_EN)) {\r\ntmp |= PWR_AV_EN;\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nmsleep(PWR_SLEEP_INTERVAL);\r\n}\r\nif (!(tmp & PWR_ISO_EN)) {\r\ntmp |= PWR_ISO_EN;\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nmsleep(PWR_SLEEP_INTERVAL);\r\n}\r\ntmp &= (~PWR_AV_MODE);\r\ntmp |= POLARIS_AVMODE_DIGITAL | I2C_DEMOD_EN;\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nmsleep(PWR_SLEEP_INTERVAL);\r\nif (!(tmp & PWR_DEMOD_EN)) {\r\ntmp |= PWR_DEMOD_EN;\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nmsleep(PWR_SLEEP_INTERVAL);\r\n}\r\nif (dev->board.tuner_type != TUNER_ABSENT) {\r\nif (dev->model == CX231XX_BOARD_HAUPPAUGE_EXETER)\r\ncx231xx_enable_i2c_port_3(dev, false);\r\nelse\r\ncx231xx_enable_i2c_port_3(dev, true);\r\nif (dev->board.tuner_gpio)\r\ncx231xx_gpio_set(dev, dev->board.tuner_gpio);\r\nif (dev->cx231xx_reset_analog_tuner)\r\ndev->cx231xx_reset_analog_tuner(dev);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nmsleep(PWR_SLEEP_INTERVAL);\r\nif (mode == POLARIS_AVMODE_DIGITAL) {\r\ntmp |= PWR_RESETOUT_EN;\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nPWR_CTL_EN, value, 4);\r\nmsleep(PWR_SLEEP_INTERVAL);\r\n}\r\nstatus = cx231xx_afe_update_power_control(dev, mode);\r\nstatus = cx231xx_i2s_blk_update_power_control(dev, mode);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, PWR_CTL_EN, value,\r\n4);\r\nreturn status;\r\n}\r\nint cx231xx_power_suspend(struct cx231xx *dev)\r\n{\r\nu8 value[4] = { 0, 0, 0, 0 };\r\nu32 tmp = 0;\r\nint status = 0;\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, PWR_CTL_EN,\r\nvalue, 4);\r\nif (status > 0)\r\nreturn status;\r\ntmp = *((u32 *) value);\r\ntmp &= (~PWR_MODE_MASK);\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER, PWR_CTL_EN,\r\nvalue, 4);\r\nreturn status;\r\n}\r\nint cx231xx_start_stream(struct cx231xx *dev, u32 ep_mask)\r\n{\r\nu8 value[4] = { 0x0, 0x0, 0x0, 0x0 };\r\nu32 tmp = 0;\r\nint status = 0;\r\ncx231xx_info("cx231xx_start_stream():: ep_mask = %x\n", ep_mask);\r\nstatus = cx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, EP_MODE_SET,\r\nvalue, 4);\r\nif (status < 0)\r\nreturn status;\r\ntmp = *((u32 *) value);\r\ntmp |= ep_mask;\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER, EP_MODE_SET,\r\nvalue, 4);\r\nreturn status;\r\n}\r\nint cx231xx_stop_stream(struct cx231xx *dev, u32 ep_mask)\r\n{\r\nu8 value[4] = { 0x0, 0x0, 0x0, 0x0 };\r\nu32 tmp = 0;\r\nint status = 0;\r\ncx231xx_info("cx231xx_stop_stream():: ep_mask = %x\n", ep_mask);\r\nstatus =\r\ncx231xx_read_ctrl_reg(dev, VRT_GET_REGISTER, EP_MODE_SET, value, 4);\r\nif (status < 0)\r\nreturn status;\r\ntmp = *((u32 *) value);\r\ntmp &= (~ep_mask);\r\nvalue[0] = (u8) tmp;\r\nvalue[1] = (u8) (tmp >> 8);\r\nvalue[2] = (u8) (tmp >> 16);\r\nvalue[3] = (u8) (tmp >> 24);\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER, EP_MODE_SET,\r\nvalue, 4);\r\nreturn status;\r\n}\r\nint cx231xx_initialize_stream_xfer(struct cx231xx *dev, u32 media_type)\r\n{\r\nint status = 0;\r\nu32 value = 0;\r\nu8 val[4] = { 0, 0, 0, 0 };\r\nif (dev->udev->speed == USB_SPEED_HIGH) {\r\nswitch (media_type) {\r\ncase 81:\r\ncx231xx_info("%s: Audio enter HANC\n", __func__);\r\nstatus =\r\ncx231xx_mode_register(dev, TS_MODE_REG, 0x9300);\r\nbreak;\r\ncase 2:\r\ncx231xx_info("%s: set vanc registers\n", __func__);\r\nstatus = cx231xx_mode_register(dev, TS_MODE_REG, 0x300);\r\nbreak;\r\ncase 3:\r\ncx231xx_info("%s: set hanc registers\n", __func__);\r\nstatus =\r\ncx231xx_mode_register(dev, TS_MODE_REG, 0x1300);\r\nbreak;\r\ncase 0:\r\ncx231xx_info("%s: set video registers\n", __func__);\r\nstatus = cx231xx_mode_register(dev, TS_MODE_REG, 0x100);\r\nbreak;\r\ncase 4:\r\ncx231xx_info("%s: set ts1 registers", __func__);\r\nif (dev->board.has_417) {\r\ncx231xx_info(" MPEG\n");\r\nvalue &= 0xFFFFFFFC;\r\nvalue |= 0x3;\r\nstatus = cx231xx_mode_register(dev, TS_MODE_REG, value);\r\nval[0] = 0x04;\r\nval[1] = 0xA3;\r\nval[2] = 0x3B;\r\nval[3] = 0x00;\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nTS1_CFG_REG, val, 4);\r\nval[0] = 0x00;\r\nval[1] = 0x08;\r\nval[2] = 0x00;\r\nval[3] = 0x08;\r\nstatus = cx231xx_write_ctrl_reg(dev, VRT_SET_REGISTER,\r\nTS1_LENGTH_REG, val, 4);\r\n} else {\r\ncx231xx_info(" BDA\n");\r\nstatus = cx231xx_mode_register(dev, TS_MODE_REG, 0x101);\r\nstatus = cx231xx_mode_register(dev, TS1_CFG_REG, 0x010);\r\n}\r\nbreak;\r\ncase 6:\r\ncx231xx_info("%s: set ts1 parallel mode registers\n",\r\n__func__);\r\nstatus = cx231xx_mode_register(dev, TS_MODE_REG, 0x100);\r\nstatus = cx231xx_mode_register(dev, TS1_CFG_REG, 0x400);\r\nbreak;\r\n}\r\n} else {\r\nstatus = cx231xx_mode_register(dev, TS_MODE_REG, 0x101);\r\n}\r\nreturn status;\r\n}\r\nint cx231xx_capture_start(struct cx231xx *dev, int start, u8 media_type)\r\n{\r\nint rc = -1;\r\nu32 ep_mask = -1;\r\nstruct pcb_config *pcb_config;\r\npcb_config = (struct pcb_config *)&dev->current_pcb_config;\r\nif (pcb_config->config_num == 1) {\r\nswitch (media_type) {\r\ncase 0:\r\nep_mask = ENABLE_EP4;\r\nbreak;\r\ncase 1:\r\nep_mask = ENABLE_EP3;\r\nbreak;\r\ncase 2:\r\nep_mask = ENABLE_EP5;\r\nbreak;\r\ncase 3:\r\nep_mask = ENABLE_EP6;\r\nbreak;\r\ncase 4:\r\ncase 6:\r\nep_mask = ENABLE_EP1;\r\nbreak;\r\ncase 5:\r\nep_mask = ENABLE_EP2;\r\nbreak;\r\n}\r\n} else if (pcb_config->config_num > 1) {\r\nswitch (media_type) {\r\ncase 0:\r\nep_mask = ENABLE_EP4;\r\nbreak;\r\ncase 1:\r\nep_mask = ENABLE_EP3;\r\nbreak;\r\ncase 2:\r\nep_mask = ENABLE_EP5;\r\nbreak;\r\ncase 3:\r\nep_mask = ENABLE_EP6;\r\nbreak;\r\ncase 4:\r\ncase 6:\r\nep_mask = ENABLE_EP1;\r\nbreak;\r\ncase 5:\r\nep_mask = ENABLE_EP2;\r\nbreak;\r\n}\r\n}\r\nif (start) {\r\nrc = cx231xx_initialize_stream_xfer(dev, media_type);\r\nif (rc < 0)\r\nreturn rc;\r\nif (ep_mask > 0)\r\nrc = cx231xx_start_stream(dev, ep_mask);\r\n} else {\r\nif (ep_mask > 0)\r\nrc = cx231xx_stop_stream(dev, ep_mask);\r\n}\r\nif (dev->mode == CX231XX_ANALOG_MODE)\r\n;\r\nelse\r\n;\r\nreturn rc;\r\n}\r\nint cx231xx_set_gpio_bit(struct cx231xx *dev, u32 gpio_bit, u8 *gpio_val)\r\n{\r\nint status = 0;\r\nstatus = cx231xx_send_gpio_cmd(dev, gpio_bit, gpio_val, 4, 0, 0);\r\nreturn status;\r\n}\r\nint cx231xx_get_gpio_bit(struct cx231xx *dev, u32 gpio_bit, u8 *gpio_val)\r\n{\r\nint status = 0;\r\nstatus = cx231xx_send_gpio_cmd(dev, gpio_bit, gpio_val, 4, 0, 1);\r\nreturn status;\r\n}\r\nint cx231xx_set_gpio_direction(struct cx231xx *dev,\r\nint pin_number, int pin_value)\r\n{\r\nint status = 0;\r\nu32 value = 0;\r\nif (pin_number >= 32)\r\nreturn -EINVAL;\r\nif (pin_value == 0)\r\nvalue = dev->gpio_dir & (~(1 << pin_number));\r\nelse\r\nvalue = dev->gpio_dir | (1 << pin_number);\r\nstatus = cx231xx_set_gpio_bit(dev, value, (u8 *) &dev->gpio_val);\r\ndev->gpio_dir = value;\r\nreturn status;\r\n}\r\nint cx231xx_set_gpio_value(struct cx231xx *dev, int pin_number, int pin_value)\r\n{\r\nint status = 0;\r\nu32 value = 0;\r\nif (pin_number >= 32)\r\nreturn -EINVAL;\r\nif ((dev->gpio_dir & (1 << pin_number)) == 0x00) {\r\nvalue = dev->gpio_dir | (1 << pin_number);\r\ndev->gpio_dir = value;\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\r\n(u8 *) &dev->gpio_val);\r\nvalue = 0;\r\n}\r\nif (pin_value == 0)\r\nvalue = dev->gpio_val & (~(1 << pin_number));\r\nelse\r\nvalue = dev->gpio_val | (1 << pin_number);\r\ndev->gpio_val = value;\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\nreturn status;\r\n}\r\nint cx231xx_gpio_i2c_start(struct cx231xx *dev)\r\n{\r\nint status = 0;\r\ndev->gpio_dir |= 1 << dev->board.tuner_scl_gpio;\r\ndev->gpio_dir |= 1 << dev->board.tuner_sda_gpio;\r\ndev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\r\ndev->gpio_val |= 1 << dev->board.tuner_sda_gpio;\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\nif (status < 0)\r\nreturn -EINVAL;\r\ndev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\r\ndev->gpio_val &= ~(1 << dev->board.tuner_sda_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\nif (status < 0)\r\nreturn -EINVAL;\r\ndev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\r\ndev->gpio_val &= ~(1 << dev->board.tuner_sda_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\nif (status < 0)\r\nreturn -EINVAL;\r\nreturn status;\r\n}\r\nint cx231xx_gpio_i2c_end(struct cx231xx *dev)\r\n{\r\nint status = 0;\r\ndev->gpio_dir |= 1 << dev->board.tuner_scl_gpio;\r\ndev->gpio_dir |= 1 << dev->board.tuner_sda_gpio;\r\ndev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\r\ndev->gpio_val &= ~(1 << dev->board.tuner_sda_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\nif (status < 0)\r\nreturn -EINVAL;\r\ndev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\r\ndev->gpio_val &= ~(1 << dev->board.tuner_sda_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\nif (status < 0)\r\nreturn -EINVAL;\r\ndev->gpio_dir &= ~(1 << dev->board.tuner_scl_gpio);\r\ndev->gpio_dir &= ~(1 << dev->board.tuner_sda_gpio);\r\nstatus =\r\ncx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\nif (status < 0)\r\nreturn -EINVAL;\r\nreturn status;\r\n}\r\nint cx231xx_gpio_i2c_write_byte(struct cx231xx *dev, u8 data)\r\n{\r\nint status = 0;\r\nu8 i;\r\ndev->gpio_dir |= 1 << dev->board.tuner_scl_gpio;\r\ndev->gpio_dir |= 1 << dev->board.tuner_sda_gpio;\r\nfor (i = 0; i < 8; i++) {\r\nif (((data << i) & 0x80) == 0) {\r\ndev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\r\ndev->gpio_val &= ~(1 << dev->board.tuner_sda_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\r\n(u8 *)&dev->gpio_val);\r\ndev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\r\n(u8 *)&dev->gpio_val);\r\ndev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\r\n(u8 *)&dev->gpio_val);\r\n} else {\r\ndev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\r\ndev->gpio_val |= 1 << dev->board.tuner_sda_gpio;\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\r\n(u8 *)&dev->gpio_val);\r\ndev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\r\n(u8 *)&dev->gpio_val);\r\ndev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\r\n(u8 *)&dev->gpio_val);\r\n}\r\n}\r\nreturn status;\r\n}\r\nint cx231xx_gpio_i2c_read_byte(struct cx231xx *dev, u8 *buf)\r\n{\r\nu8 value = 0;\r\nint status = 0;\r\nu32 gpio_logic_value = 0;\r\nu8 i;\r\nfor (i = 0; i < 8; i++) {\r\ndev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\r\n(u8 *)&dev->gpio_val);\r\ndev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir,\r\n(u8 *)&dev->gpio_val);\r\ngpio_logic_value = dev->gpio_val;\r\nstatus = cx231xx_get_gpio_bit(dev, dev->gpio_dir,\r\n(u8 *)&dev->gpio_val);\r\nif ((dev->gpio_val & (1 << dev->board.tuner_sda_gpio)) != 0)\r\nvalue |= (1 << (8 - i - 1));\r\ndev->gpio_val = gpio_logic_value;\r\n}\r\ndev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\n*buf = value & 0xff;\r\nreturn status;\r\n}\r\nint cx231xx_gpio_i2c_read_ack(struct cx231xx *dev)\r\n{\r\nint status = 0;\r\nu32 gpio_logic_value = 0;\r\nint nCnt = 10;\r\nint nInit = nCnt;\r\ndev->gpio_dir &= ~(1 << dev->board.tuner_sda_gpio);\r\ndev->gpio_dir &= ~(1 << dev->board.tuner_scl_gpio);\r\ngpio_logic_value = dev->gpio_val;\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\ndo {\r\nmsleep(2);\r\nstatus = cx231xx_get_gpio_bit(dev, dev->gpio_dir,\r\n(u8 *)&dev->gpio_val);\r\nnCnt--;\r\n} while (((dev->gpio_val &\r\n(1 << dev->board.tuner_scl_gpio)) == 0) &&\r\n(nCnt > 0));\r\nif (nCnt == 0)\r\ncx231xx_info("No ACK after %d msec -GPIO I2C failed!",\r\nnInit * 10);\r\nstatus = cx231xx_get_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\nif ((dev->gpio_val & 1 << dev->board.tuner_sda_gpio) == 0) {\r\ndev->gpio_val = gpio_logic_value;\r\ndev->gpio_val &= ~(1 << dev->board.tuner_sda_gpio);\r\nstatus = 0;\r\n} else {\r\ndev->gpio_val = gpio_logic_value;\r\ndev->gpio_val |= (1 << dev->board.tuner_sda_gpio);\r\n}\r\ndev->gpio_val = gpio_logic_value;\r\ndev->gpio_dir |= (1 << dev->board.tuner_scl_gpio);\r\ndev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\nreturn status;\r\n}\r\nint cx231xx_gpio_i2c_write_ack(struct cx231xx *dev)\r\n{\r\nint status = 0;\r\ndev->gpio_dir |= 1 << dev->board.tuner_sda_gpio;\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\ndev->gpio_val &= ~(1 << dev->board.tuner_sda_gpio);\r\ndev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\ndev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\ndev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\ndev->gpio_dir &= ~(1 << dev->board.tuner_sda_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\nreturn status;\r\n}\r\nint cx231xx_gpio_i2c_write_nak(struct cx231xx *dev)\r\n{\r\nint status = 0;\r\ndev->gpio_dir |= 1 << dev->board.tuner_scl_gpio;\r\ndev->gpio_dir &= ~(1 << dev->board.tuner_sda_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\ndev->gpio_val &= ~(1 << dev->board.tuner_scl_gpio);\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\ndev->gpio_val |= 1 << dev->board.tuner_scl_gpio;\r\nstatus = cx231xx_set_gpio_bit(dev, dev->gpio_dir, (u8 *)&dev->gpio_val);\r\nreturn status;\r\n}\r\nint cx231xx_gpio_i2c_read(struct cx231xx *dev, u8 dev_addr, u8 *buf, u8 len)\r\n{\r\nint status = 0;\r\nint i = 0;\r\nmutex_lock(&dev->gpio_i2c_lock);\r\nstatus = cx231xx_gpio_i2c_start(dev);\r\nstatus = cx231xx_gpio_i2c_write_byte(dev, (dev_addr << 1) + 1);\r\nstatus = cx231xx_gpio_i2c_read_ack(dev);\r\nfor (i = 0; i < len; i++) {\r\nbuf[i] = 0;\r\nstatus = cx231xx_gpio_i2c_read_byte(dev, &buf[i]);\r\nif ((i + 1) != len) {\r\nstatus = cx231xx_gpio_i2c_write_ack(dev);\r\n}\r\n}\r\nstatus = cx231xx_gpio_i2c_write_nak(dev);\r\nstatus = cx231xx_gpio_i2c_end(dev);\r\nmutex_unlock(&dev->gpio_i2c_lock);\r\nreturn status;\r\n}\r\nint cx231xx_gpio_i2c_write(struct cx231xx *dev, u8 dev_addr, u8 *buf, u8 len)\r\n{\r\nint status = 0;\r\nint i = 0;\r\nmutex_lock(&dev->gpio_i2c_lock);\r\nstatus = cx231xx_gpio_i2c_start(dev);\r\nstatus = cx231xx_gpio_i2c_write_byte(dev, dev_addr << 1);\r\nstatus = cx231xx_gpio_i2c_read_ack(dev);\r\nfor (i = 0; i < len; i++) {\r\nstatus = cx231xx_gpio_i2c_write_byte(dev, buf[i]);\r\nstatus = cx231xx_gpio_i2c_read_ack(dev);\r\n}\r\nstatus = cx231xx_gpio_i2c_end(dev);\r\nmutex_unlock(&dev->gpio_i2c_lock);\r\nreturn 0;\r\n}

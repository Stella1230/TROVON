static int __init\r\nsetup_serial_console(struct pcdp_uart *uart)\r\n{\r\n#ifdef CONFIG_SERIAL_8250_CONSOLE\r\nint mmio;\r\nstatic char options[64], *p = options;\r\nchar parity;\r\nmmio = (uart->addr.space_id == ACPI_ADR_SPACE_SYSTEM_MEMORY);\r\np += sprintf(p, "uart8250,%s,0x%llx",\r\nmmio ? "mmio" : "io", uart->addr.address);\r\nif (uart->baud) {\r\np += sprintf(p, ",%llu", uart->baud);\r\nif (uart->bits) {\r\nswitch (uart->parity) {\r\ncase 0x2: parity = 'e'; break;\r\ncase 0x3: parity = 'o'; break;\r\ndefault: parity = 'n';\r\n}\r\np += sprintf(p, "%c%d", parity, uart->bits);\r\n}\r\n}\r\nadd_preferred_console("uart", 8250, &options[9]);\r\nreturn setup_early_serial8250_console(options);\r\n#else\r\nreturn -ENODEV;\r\n#endif\r\n}\r\nstatic int __init\r\nsetup_vga_console(struct pcdp_device *dev)\r\n{\r\n#if defined(CONFIG_VT) && defined(CONFIG_VGA_CONSOLE)\r\nu8 *if_ptr;\r\nif_ptr = ((u8 *)dev + sizeof(struct pcdp_device));\r\nif (if_ptr[0] == PCDP_IF_PCI) {\r\nstruct pcdp_if_pci if_pci;\r\nmemcpy(&if_pci, if_ptr, sizeof(if_pci));\r\nif (if_pci.trans & PCDP_PCI_TRANS_IOPORT)\r\nvga_console_iobase = if_pci.ioport_tra;\r\nif (if_pci.trans & PCDP_PCI_TRANS_MMIO)\r\nvga_console_membase = if_pci.mmio_tra;\r\n}\r\nif (efi_mem_type(vga_console_membase + 0xA0000) == EFI_CONVENTIONAL_MEMORY) {\r\nprintk(KERN_ERR "PCDP: VGA selected, but frame buffer is not MMIO!\n");\r\nreturn -ENODEV;\r\n}\r\nconswitchp = &vga_con;\r\nprintk(KERN_INFO "PCDP: VGA console\n");\r\nreturn 0;\r\n#else\r\nreturn -ENODEV;\r\n#endif\r\n}\r\nint __init\r\nefi_setup_pcdp_console(char *cmdline)\r\n{\r\nstruct pcdp *pcdp;\r\nstruct pcdp_uart *uart;\r\nstruct pcdp_device *dev, *end;\r\nint i, serial = 0;\r\nint rc = -ENODEV;\r\nif (efi.hcdp == EFI_INVALID_TABLE_ADDR)\r\nreturn -ENODEV;\r\npcdp = ioremap(efi.hcdp, 4096);\r\nprintk(KERN_INFO "PCDP: v%d at 0x%lx\n", pcdp->rev, efi.hcdp);\r\nif (strstr(cmdline, "console=hcdp")) {\r\nif (pcdp->rev < 3)\r\nserial = 1;\r\n} else if (strstr(cmdline, "console=")) {\r\nprintk(KERN_INFO "Explicit \"console=\"; ignoring PCDP\n");\r\ngoto out;\r\n}\r\nif (pcdp->rev < 3 && efi_uart_console_only())\r\nserial = 1;\r\nfor (i = 0, uart = pcdp->uart; i < pcdp->num_uarts; i++, uart++) {\r\nif (uart->flags & PCDP_UART_PRIMARY_CONSOLE || serial) {\r\nif (uart->type == PCDP_CONSOLE_UART) {\r\nrc = setup_serial_console(uart);\r\ngoto out;\r\n}\r\n}\r\n}\r\nend = (struct pcdp_device *) ((u8 *) pcdp + pcdp->length);\r\nfor (dev = (struct pcdp_device *) (pcdp->uart + pcdp->num_uarts);\r\ndev < end;\r\ndev = (struct pcdp_device *) ((u8 *) dev + dev->length)) {\r\nif (dev->flags & PCDP_PRIMARY_CONSOLE) {\r\nif (dev->type == PCDP_CONSOLE_VGA) {\r\nrc = setup_vga_console(dev);\r\ngoto out;\r\n}\r\n}\r\n}\r\nout:\r\niounmap(pcdp);\r\nreturn rc;\r\n}

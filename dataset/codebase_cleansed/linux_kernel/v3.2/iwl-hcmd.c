const char *iwl_legacy_get_cmd_string(u8 cmd)\r\n{\r\nswitch (cmd) {\r\nIWL_CMD(REPLY_ALIVE);\r\nIWL_CMD(REPLY_ERROR);\r\nIWL_CMD(REPLY_RXON);\r\nIWL_CMD(REPLY_RXON_ASSOC);\r\nIWL_CMD(REPLY_QOS_PARAM);\r\nIWL_CMD(REPLY_RXON_TIMING);\r\nIWL_CMD(REPLY_ADD_STA);\r\nIWL_CMD(REPLY_REMOVE_STA);\r\nIWL_CMD(REPLY_WEPKEY);\r\nIWL_CMD(REPLY_3945_RX);\r\nIWL_CMD(REPLY_TX);\r\nIWL_CMD(REPLY_RATE_SCALE);\r\nIWL_CMD(REPLY_LEDS_CMD);\r\nIWL_CMD(REPLY_TX_LINK_QUALITY_CMD);\r\nIWL_CMD(REPLY_CHANNEL_SWITCH);\r\nIWL_CMD(CHANNEL_SWITCH_NOTIFICATION);\r\nIWL_CMD(REPLY_SPECTRUM_MEASUREMENT_CMD);\r\nIWL_CMD(SPECTRUM_MEASURE_NOTIFICATION);\r\nIWL_CMD(POWER_TABLE_CMD);\r\nIWL_CMD(PM_SLEEP_NOTIFICATION);\r\nIWL_CMD(PM_DEBUG_STATISTIC_NOTIFIC);\r\nIWL_CMD(REPLY_SCAN_CMD);\r\nIWL_CMD(REPLY_SCAN_ABORT_CMD);\r\nIWL_CMD(SCAN_START_NOTIFICATION);\r\nIWL_CMD(SCAN_RESULTS_NOTIFICATION);\r\nIWL_CMD(SCAN_COMPLETE_NOTIFICATION);\r\nIWL_CMD(BEACON_NOTIFICATION);\r\nIWL_CMD(REPLY_TX_BEACON);\r\nIWL_CMD(REPLY_TX_PWR_TABLE_CMD);\r\nIWL_CMD(REPLY_BT_CONFIG);\r\nIWL_CMD(REPLY_STATISTICS_CMD);\r\nIWL_CMD(STATISTICS_NOTIFICATION);\r\nIWL_CMD(CARD_STATE_NOTIFICATION);\r\nIWL_CMD(MISSED_BEACONS_NOTIFICATION);\r\nIWL_CMD(REPLY_CT_KILL_CONFIG_CMD);\r\nIWL_CMD(SENSITIVITY_CMD);\r\nIWL_CMD(REPLY_PHY_CALIBRATION_CMD);\r\nIWL_CMD(REPLY_RX_PHY_CMD);\r\nIWL_CMD(REPLY_RX_MPDU_CMD);\r\nIWL_CMD(REPLY_RX);\r\nIWL_CMD(REPLY_COMPRESSED_BA);\r\ndefault:\r\nreturn "UNKNOWN";\r\n}\r\n}\r\nstatic void iwl_legacy_generic_cmd_callback(struct iwl_priv *priv,\r\nstruct iwl_device_cmd *cmd,\r\nstruct iwl_rx_packet *pkt)\r\n{\r\nif (pkt->hdr.flags & IWL_CMD_FAILED_MSK) {\r\nIWL_ERR(priv, "Bad return from %s (0x%08X)\n",\r\niwl_legacy_get_cmd_string(cmd->hdr.cmd), pkt->hdr.flags);\r\nreturn;\r\n}\r\n#ifdef CONFIG_IWLWIFI_LEGACY_DEBUG\r\nswitch (cmd->hdr.cmd) {\r\ncase REPLY_TX_LINK_QUALITY_CMD:\r\ncase SENSITIVITY_CMD:\r\nIWL_DEBUG_HC_DUMP(priv, "back from %s (0x%08X)\n",\r\niwl_legacy_get_cmd_string(cmd->hdr.cmd), pkt->hdr.flags);\r\nbreak;\r\ndefault:\r\nIWL_DEBUG_HC(priv, "back from %s (0x%08X)\n",\r\niwl_legacy_get_cmd_string(cmd->hdr.cmd), pkt->hdr.flags);\r\n}\r\n#endif\r\n}\r\nstatic int\r\niwl_legacy_send_cmd_async(struct iwl_priv *priv, struct iwl_host_cmd *cmd)\r\n{\r\nint ret;\r\nBUG_ON(!(cmd->flags & CMD_ASYNC));\r\nBUG_ON(cmd->flags & CMD_WANT_SKB);\r\nif (!cmd->callback)\r\ncmd->callback = iwl_legacy_generic_cmd_callback;\r\nif (test_bit(STATUS_EXIT_PENDING, &priv->status))\r\nreturn -EBUSY;\r\nret = iwl_legacy_enqueue_hcmd(priv, cmd);\r\nif (ret < 0) {\r\nIWL_ERR(priv, "Error sending %s: enqueue_hcmd failed: %d\n",\r\niwl_legacy_get_cmd_string(cmd->id), ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nint iwl_legacy_send_cmd_sync(struct iwl_priv *priv, struct iwl_host_cmd *cmd)\r\n{\r\nint cmd_idx;\r\nint ret;\r\nlockdep_assert_held(&priv->mutex);\r\nBUG_ON(cmd->flags & CMD_ASYNC);\r\nBUG_ON(cmd->callback);\r\nIWL_DEBUG_INFO(priv, "Attempting to send sync command %s\n",\r\niwl_legacy_get_cmd_string(cmd->id));\r\nset_bit(STATUS_HCMD_ACTIVE, &priv->status);\r\nIWL_DEBUG_INFO(priv, "Setting HCMD_ACTIVE for command %s\n",\r\niwl_legacy_get_cmd_string(cmd->id));\r\ncmd_idx = iwl_legacy_enqueue_hcmd(priv, cmd);\r\nif (cmd_idx < 0) {\r\nret = cmd_idx;\r\nIWL_ERR(priv, "Error sending %s: enqueue_hcmd failed: %d\n",\r\niwl_legacy_get_cmd_string(cmd->id), ret);\r\ngoto out;\r\n}\r\nret = wait_event_timeout(priv->wait_command_queue,\r\n!test_bit(STATUS_HCMD_ACTIVE, &priv->status),\r\nHOST_COMPLETE_TIMEOUT);\r\nif (!ret) {\r\nif (test_bit(STATUS_HCMD_ACTIVE, &priv->status)) {\r\nIWL_ERR(priv,\r\n"Error sending %s: time out after %dms.\n",\r\niwl_legacy_get_cmd_string(cmd->id),\r\njiffies_to_msecs(HOST_COMPLETE_TIMEOUT));\r\nclear_bit(STATUS_HCMD_ACTIVE, &priv->status);\r\nIWL_DEBUG_INFO(priv,\r\n"Clearing HCMD_ACTIVE for command %s\n",\r\niwl_legacy_get_cmd_string(cmd->id));\r\nret = -ETIMEDOUT;\r\ngoto cancel;\r\n}\r\n}\r\nif (test_bit(STATUS_RF_KILL_HW, &priv->status)) {\r\nIWL_ERR(priv, "Command %s aborted: RF KILL Switch\n",\r\niwl_legacy_get_cmd_string(cmd->id));\r\nret = -ECANCELED;\r\ngoto fail;\r\n}\r\nif (test_bit(STATUS_FW_ERROR, &priv->status)) {\r\nIWL_ERR(priv, "Command %s failed: FW Error\n",\r\niwl_legacy_get_cmd_string(cmd->id));\r\nret = -EIO;\r\ngoto fail;\r\n}\r\nif ((cmd->flags & CMD_WANT_SKB) && !cmd->reply_page) {\r\nIWL_ERR(priv, "Error: Response NULL in '%s'\n",\r\niwl_legacy_get_cmd_string(cmd->id));\r\nret = -EIO;\r\ngoto cancel;\r\n}\r\nret = 0;\r\ngoto out;\r\ncancel:\r\nif (cmd->flags & CMD_WANT_SKB) {\r\npriv->txq[priv->cmd_queue].meta[cmd_idx].flags &=\r\n~CMD_WANT_SKB;\r\n}\r\nfail:\r\nif (cmd->reply_page) {\r\niwl_legacy_free_pages(priv, cmd->reply_page);\r\ncmd->reply_page = 0;\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nint iwl_legacy_send_cmd(struct iwl_priv *priv, struct iwl_host_cmd *cmd)\r\n{\r\nif (cmd->flags & CMD_ASYNC)\r\nreturn iwl_legacy_send_cmd_async(priv, cmd);\r\nreturn iwl_legacy_send_cmd_sync(priv, cmd);\r\n}\r\nint\r\niwl_legacy_send_cmd_pdu(struct iwl_priv *priv, u8 id, u16 len, const void *data)\r\n{\r\nstruct iwl_host_cmd cmd = {\r\n.id = id,\r\n.len = len,\r\n.data = data,\r\n};\r\nreturn iwl_legacy_send_cmd_sync(priv, &cmd);\r\n}\r\nint iwl_legacy_send_cmd_pdu_async(struct iwl_priv *priv,\r\nu8 id, u16 len, const void *data,\r\nvoid (*callback)(struct iwl_priv *priv,\r\nstruct iwl_device_cmd *cmd,\r\nstruct iwl_rx_packet *pkt))\r\n{\r\nstruct iwl_host_cmd cmd = {\r\n.id = id,\r\n.len = len,\r\n.data = data,\r\n};\r\ncmd.flags |= CMD_ASYNC;\r\ncmd.callback = callback;\r\nreturn iwl_legacy_send_cmd_async(priv, &cmd);\r\n}

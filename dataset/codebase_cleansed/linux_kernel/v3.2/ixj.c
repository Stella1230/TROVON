static IXJ *ixj_alloc()\r\n{\r\nfor(cnt=0; cnt<IXJMAX; cnt++)\r\n{\r\nif(ixj[cnt] == NULL || !ixj[cnt]->DSPbase)\r\n{\r\nj = kmalloc(sizeof(IXJ), GFP_KERNEL);\r\nif (j == NULL)\r\nreturn NULL;\r\nixj[cnt] = j;\r\nreturn j;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nstatic void ixj_fsk_free(IXJ *j)\r\n{\r\nkfree(j->fskdata);\r\nj->fskdata = NULL;\r\n}\r\nstatic void ixj_fsk_alloc(IXJ *j)\r\n{\r\nif(!j->fskdata) {\r\nj->fskdata = kmalloc(8000, GFP_KERNEL);\r\nif (!j->fskdata) {\r\nif(ixjdebug & 0x0200) {\r\nprintk("IXJ phone%d - allocate failed\n", j->board);\r\n}\r\nreturn;\r\n} else {\r\nj->fsksize = 8000;\r\nif(ixjdebug & 0x0200) {\r\nprintk("IXJ phone%d - allocate succeeded\n", j->board);\r\n}\r\n}\r\n}\r\n}\r\nstatic IXJ *ixj_alloc(void)\r\n{\r\nint cnt;\r\nfor(cnt=0; cnt<IXJMAX; cnt++) {\r\nif(!ixj[cnt].DSPbase)\r\nreturn &ixj[cnt];\r\n}\r\nreturn NULL;\r\n}\r\nstatic inline void ixj_fsk_free(IXJ *j) {;}\r\nstatic inline void ixj_fsk_alloc(IXJ *j)\r\n{\r\nj->fsksize = 8000;\r\n}\r\nstatic int Stub(IXJ * J, unsigned long arg)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline void ixj_read_HSR(IXJ *j)\r\n{\r\nj->hsr.bytes.low = inb_p(j->DSPbase + 8);\r\nj->hsr.bytes.high = inb_p(j->DSPbase + 9);\r\n}\r\nstatic inline int IsControlReady(IXJ *j)\r\n{\r\nixj_read_HSR(j);\r\nreturn j->hsr.bits.controlrdy ? 1 : 0;\r\n}\r\nstatic inline int IsPCControlReady(IXJ *j)\r\n{\r\nj->pccr1.byte = inb_p(j->XILINXbase + 3);\r\nreturn j->pccr1.bits.crr ? 1 : 0;\r\n}\r\nstatic inline int IsStatusReady(IXJ *j)\r\n{\r\nixj_read_HSR(j);\r\nreturn j->hsr.bits.statusrdy ? 1 : 0;\r\n}\r\nstatic inline int IsRxReady(IXJ *j)\r\n{\r\nixj_read_HSR(j);\r\nixj_perfmon(j->rxreadycheck);\r\nreturn j->hsr.bits.rxrdy ? 1 : 0;\r\n}\r\nstatic inline int IsTxReady(IXJ *j)\r\n{\r\nixj_read_HSR(j);\r\nixj_perfmon(j->txreadycheck);\r\nreturn j->hsr.bits.txrdy ? 1 : 0;\r\n}\r\nstatic inline void set_play_volume(IXJ *j, int volume)\r\n{\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "IXJ: /dev/phone%d Setting Play Volume to 0x%4.4x\n", j->board, volume);\r\nixj_WriteDSPCommand(0xCF02, j);\r\nixj_WriteDSPCommand(volume, j);\r\n}\r\nstatic int set_play_volume_linear(IXJ *j, int volume)\r\n{\r\nint newvolume, dspplaymax;\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "IXJ: /dev/phone %d Setting Linear Play Volume to 0x%4.4x\n", j->board, volume);\r\nif(volume > 100 || volume < 0) {\r\nreturn -1;\r\n}\r\nswitch (j->cardtype) {\r\ncase QTI_PHONEJACK:\r\ndspplaymax = 0x380;\r\nbreak;\r\ncase QTI_LINEJACK:\r\nif(j->port == PORT_PSTN) {\r\ndspplaymax = 0x48;\r\n} else {\r\ndspplaymax = 0x100;\r\n}\r\nbreak;\r\ncase QTI_PHONEJACK_LITE:\r\ndspplaymax = 0x380;\r\nbreak;\r\ncase QTI_PHONEJACK_PCI:\r\ndspplaymax = 0x6C;\r\nbreak;\r\ncase QTI_PHONECARD:\r\ndspplaymax = 0x50;\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nnewvolume = (dspplaymax * volume) / 100;\r\nset_play_volume(j, newvolume);\r\nreturn 0;\r\n}\r\nstatic inline void set_play_depth(IXJ *j, int depth)\r\n{\r\nif (depth > 60)\r\ndepth = 60;\r\nif (depth < 0)\r\ndepth = 0;\r\nixj_WriteDSPCommand(0x5280 + depth, j);\r\n}\r\nstatic inline int get_play_volume(IXJ *j)\r\n{\r\nixj_WriteDSPCommand(0xCF00, j);\r\nreturn j->ssr.high << 8 | j->ssr.low;\r\n}\r\nstatic int get_play_volume_linear(IXJ *j)\r\n{\r\nint volume, newvolume, dspplaymax;\r\nswitch (j->cardtype) {\r\ncase QTI_PHONEJACK:\r\ndspplaymax = 0x380;\r\nbreak;\r\ncase QTI_LINEJACK:\r\nif(j->port == PORT_PSTN) {\r\ndspplaymax = 0x48;\r\n} else {\r\ndspplaymax = 0x100;\r\n}\r\nbreak;\r\ncase QTI_PHONEJACK_LITE:\r\ndspplaymax = 0x380;\r\nbreak;\r\ncase QTI_PHONEJACK_PCI:\r\ndspplaymax = 0x6C;\r\nbreak;\r\ncase QTI_PHONECARD:\r\ndspplaymax = 100;\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nvolume = get_play_volume(j);\r\nnewvolume = (volume * 100) / dspplaymax;\r\nif(newvolume > 100)\r\nnewvolume = 100;\r\nreturn newvolume;\r\n}\r\nstatic inline BYTE SLIC_GetState(IXJ *j)\r\n{\r\nif (j->cardtype == QTI_PHONECARD) {\r\nj->pccr1.byte = 0;\r\nj->psccr.bits.dev = 3;\r\nj->psccr.bits.rw = 1;\r\noutw_p(j->psccr.byte << 8, j->XILINXbase + 0x00);\r\nixj_PCcontrol_wait(j);\r\nj->pslic.byte = inw_p(j->XILINXbase + 0x00) & 0xFF;\r\nixj_PCcontrol_wait(j);\r\nif (j->pslic.bits.powerdown)\r\nreturn PLD_SLIC_STATE_OC;\r\nelse if (!j->pslic.bits.ring0 && !j->pslic.bits.ring1)\r\nreturn PLD_SLIC_STATE_ACTIVE;\r\nelse\r\nreturn PLD_SLIC_STATE_RINGING;\r\n} else {\r\nj->pld_slicr.byte = inb_p(j->XILINXbase + 0x01);\r\n}\r\nreturn j->pld_slicr.bits.state;\r\n}\r\nstatic bool SLIC_SetState(BYTE byState, IXJ *j)\r\n{\r\nbool fRetVal = false;\r\nif (j->cardtype == QTI_PHONECARD) {\r\nif (j->flags.pcmciasct) {\r\nswitch (byState) {\r\ncase PLD_SLIC_STATE_TIPOPEN:\r\ncase PLD_SLIC_STATE_OC:\r\nj->pslic.bits.powerdown = 1;\r\nj->pslic.bits.ring0 = j->pslic.bits.ring1 = 0;\r\nfRetVal = true;\r\nbreak;\r\ncase PLD_SLIC_STATE_RINGING:\r\nif (j->readers || j->writers) {\r\nj->pslic.bits.powerdown = 0;\r\nj->pslic.bits.ring0 = 1;\r\nj->pslic.bits.ring1 = 0;\r\nfRetVal = true;\r\n}\r\nbreak;\r\ncase PLD_SLIC_STATE_OHT:\r\ncase PLD_SLIC_STATE_STANDBY:\r\ncase PLD_SLIC_STATE_ACTIVE:\r\nif (j->readers || j->writers) {\r\nj->pslic.bits.powerdown = 0;\r\n} else {\r\nj->pslic.bits.powerdown = 1;\r\n}\r\nj->pslic.bits.ring0 = j->pslic.bits.ring1 = 0;\r\nfRetVal = true;\r\nbreak;\r\ncase PLD_SLIC_STATE_APR:\r\ncase PLD_SLIC_STATE_OHTPR:\r\ndefault:\r\nfRetVal = false;\r\nbreak;\r\n}\r\nj->psccr.bits.dev = 3;\r\nj->psccr.bits.rw = 0;\r\noutw_p(j->psccr.byte << 8 | j->pslic.byte, j->XILINXbase + 0x00);\r\nixj_PCcontrol_wait(j);\r\n}\r\n} else {\r\nswitch (byState) {\r\ncase PLD_SLIC_STATE_OC:\r\nj->pld_slicw.bits.c1 = 0;\r\nj->pld_slicw.bits.c2 = 0;\r\nj->pld_slicw.bits.c3 = 0;\r\nj->pld_slicw.bits.b2en = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nfRetVal = true;\r\nbreak;\r\ncase PLD_SLIC_STATE_RINGING:\r\nj->pld_slicw.bits.c1 = 1;\r\nj->pld_slicw.bits.c2 = 0;\r\nj->pld_slicw.bits.c3 = 0;\r\nj->pld_slicw.bits.b2en = 1;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nfRetVal = true;\r\nbreak;\r\ncase PLD_SLIC_STATE_ACTIVE:\r\nj->pld_slicw.bits.c1 = 0;\r\nj->pld_slicw.bits.c2 = 1;\r\nj->pld_slicw.bits.c3 = 0;\r\nj->pld_slicw.bits.b2en = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nfRetVal = true;\r\nbreak;\r\ncase PLD_SLIC_STATE_OHT:\r\nj->pld_slicw.bits.c1 = 1;\r\nj->pld_slicw.bits.c2 = 1;\r\nj->pld_slicw.bits.c3 = 0;\r\nj->pld_slicw.bits.b2en = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nfRetVal = true;\r\nbreak;\r\ncase PLD_SLIC_STATE_TIPOPEN:\r\nj->pld_slicw.bits.c1 = 0;\r\nj->pld_slicw.bits.c2 = 0;\r\nj->pld_slicw.bits.c3 = 1;\r\nj->pld_slicw.bits.b2en = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nfRetVal = true;\r\nbreak;\r\ncase PLD_SLIC_STATE_STANDBY:\r\nj->pld_slicw.bits.c1 = 1;\r\nj->pld_slicw.bits.c2 = 0;\r\nj->pld_slicw.bits.c3 = 1;\r\nj->pld_slicw.bits.b2en = 1;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nfRetVal = true;\r\nbreak;\r\ncase PLD_SLIC_STATE_APR:\r\nj->pld_slicw.bits.c1 = 0;\r\nj->pld_slicw.bits.c2 = 1;\r\nj->pld_slicw.bits.c3 = 1;\r\nj->pld_slicw.bits.b2en = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nfRetVal = true;\r\nbreak;\r\ncase PLD_SLIC_STATE_OHTPR:\r\nj->pld_slicw.bits.c1 = 1;\r\nj->pld_slicw.bits.c2 = 1;\r\nj->pld_slicw.bits.c3 = 1;\r\nj->pld_slicw.bits.b2en = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nfRetVal = true;\r\nbreak;\r\ndefault:\r\nfRetVal = false;\r\nbreak;\r\n}\r\n}\r\nreturn fRetVal;\r\n}\r\nstatic int ixj_wink(IXJ *j)\r\n{\r\nBYTE slicnow;\r\nslicnow = SLIC_GetState(j);\r\nj->pots_winkstart = jiffies;\r\nSLIC_SetState(PLD_SLIC_STATE_OC, j);\r\nmsleep(jiffies_to_msecs(j->winktime));\r\nSLIC_SetState(slicnow, j);\r\nreturn 0;\r\n}\r\nstatic void ixj_init_timer(IXJ *j)\r\n{\r\ninit_timer(&j->timer);\r\nj->timer.function = ixj_timeout;\r\nj->timer.data = (unsigned long)j;\r\n}\r\nstatic void ixj_add_timer(IXJ *j)\r\n{\r\nj->timer.expires = jiffies + (hertz / samplerate);\r\nadd_timer(&j->timer);\r\n}\r\nstatic void ixj_tone_timeout(IXJ *j)\r\n{\r\nIXJ_TONE ti;\r\nj->tone_state++;\r\nif (j->tone_state == 3) {\r\nj->tone_state = 0;\r\nif (j->cadence_t) {\r\nj->tone_cadence_state++;\r\nif (j->tone_cadence_state >= j->cadence_t->elements_used) {\r\nswitch (j->cadence_t->termination) {\r\ncase PLAY_ONCE:\r\nixj_cpt_stop(j);\r\nbreak;\r\ncase REPEAT_LAST_ELEMENT:\r\nj->tone_cadence_state--;\r\nixj_play_tone(j, j->cadence_t->ce[j->tone_cadence_state].index);\r\nbreak;\r\ncase REPEAT_ALL:\r\nj->tone_cadence_state = 0;\r\nif (j->cadence_t->ce[j->tone_cadence_state].freq0) {\r\nti.tone_index = j->cadence_t->ce[j->tone_cadence_state].index;\r\nti.freq0 = j->cadence_t->ce[j->tone_cadence_state].freq0;\r\nti.gain0 = j->cadence_t->ce[j->tone_cadence_state].gain0;\r\nti.freq1 = j->cadence_t->ce[j->tone_cadence_state].freq1;\r\nti.gain1 = j->cadence_t->ce[j->tone_cadence_state].gain1;\r\nixj_init_tone(j, &ti);\r\n}\r\nixj_set_tone_on(j->cadence_t->ce[0].tone_on_time, j);\r\nixj_set_tone_off(j->cadence_t->ce[0].tone_off_time, j);\r\nixj_play_tone(j, j->cadence_t->ce[0].index);\r\nbreak;\r\n}\r\n} else {\r\nif (j->cadence_t->ce[j->tone_cadence_state].gain0) {\r\nti.tone_index = j->cadence_t->ce[j->tone_cadence_state].index;\r\nti.freq0 = j->cadence_t->ce[j->tone_cadence_state].freq0;\r\nti.gain0 = j->cadence_t->ce[j->tone_cadence_state].gain0;\r\nti.freq1 = j->cadence_t->ce[j->tone_cadence_state].freq1;\r\nti.gain1 = j->cadence_t->ce[j->tone_cadence_state].gain1;\r\nixj_init_tone(j, &ti);\r\n}\r\nixj_set_tone_on(j->cadence_t->ce[j->tone_cadence_state].tone_on_time, j);\r\nixj_set_tone_off(j->cadence_t->ce[j->tone_cadence_state].tone_off_time, j);\r\nixj_play_tone(j, j->cadence_t->ce[j->tone_cadence_state].index);\r\n}\r\n}\r\n}\r\n}\r\nstatic inline void ixj_kill_fasync(IXJ *j, IXJ_SIGEVENT event, int dir)\r\n{\r\nif(j->ixj_signals[event]) {\r\nif(ixjdebug & 0x0100)\r\nprintk("Sending signal for event %d\n", event);\r\nkill_fasync(&(j->async_queue), j->ixj_signals[event], dir);\r\n}\r\n}\r\nstatic void ixj_pstn_state(IXJ *j)\r\n{\r\nint var;\r\nunion XOPXR0 XR0, daaint;\r\nvar = 10;\r\nXR0.reg = j->m_DAAShadowRegs.XOP_REGS.XOP.xr0.reg;\r\ndaaint.reg = 0;\r\nXR0.bitreg.RMR = j->m_DAAShadowRegs.SOP_REGS.SOP.cr1.bitreg.RMR;\r\nj->pld_scrr.byte = inb_p(j->XILINXbase);\r\nif (j->pld_scrr.bits.daaflag) {\r\ndaa_int_read(j);\r\nif(j->m_DAAShadowRegs.XOP_REGS.XOP.xr0.bitreg.RING) {\r\nif(time_after(jiffies, j->pstn_sleeptil) && !(j->flags.pots_pstn && j->hookstate)) {\r\ndaaint.bitreg.RING = 1;\r\nif(ixjdebug & 0x0008) {\r\nprintk(KERN_INFO "IXJ DAA Ring Interrupt /dev/phone%d at %ld\n", j->board, jiffies);\r\n}\r\n} else {\r\ndaa_set_mode(j, SOP_PU_RESET);\r\n}\r\n}\r\nif(j->m_DAAShadowRegs.XOP_REGS.XOP.xr0.bitreg.Caller_ID) {\r\ndaaint.bitreg.Caller_ID = 1;\r\nj->pstn_cid_intr = 1;\r\nj->pstn_cid_received = jiffies;\r\nif(ixjdebug & 0x0008) {\r\nprintk(KERN_INFO "IXJ DAA Caller_ID Interrupt /dev/phone%d at %ld\n", j->board, jiffies);\r\n}\r\n}\r\nif(j->m_DAAShadowRegs.XOP_REGS.XOP.xr0.bitreg.Cadence) {\r\ndaaint.bitreg.Cadence = 1;\r\nif(ixjdebug & 0x0008) {\r\nprintk(KERN_INFO "IXJ DAA Cadence Interrupt /dev/phone%d at %ld\n", j->board, jiffies);\r\n}\r\n}\r\nif(j->m_DAAShadowRegs.XOP_REGS.XOP.xr0.bitreg.VDD_OK != XR0.bitreg.VDD_OK) {\r\ndaaint.bitreg.VDD_OK = 1;\r\ndaaint.bitreg.SI_0 = j->m_DAAShadowRegs.XOP_REGS.XOP.xr0.bitreg.VDD_OK;\r\n}\r\n}\r\ndaa_CR_read(j, 1);\r\nif(j->m_DAAShadowRegs.SOP_REGS.SOP.cr1.bitreg.RMR != XR0.bitreg.RMR && time_after(jiffies, j->pstn_sleeptil) && !(j->flags.pots_pstn && j->hookstate)) {\r\ndaaint.bitreg.RMR = 1;\r\ndaaint.bitreg.SI_1 = j->m_DAAShadowRegs.SOP_REGS.SOP.cr1.bitreg.RMR;\r\nif(ixjdebug & 0x0008) {\r\nprintk(KERN_INFO "IXJ DAA RMR /dev/phone%d was %s for %ld\n", j->board, XR0.bitreg.RMR?"on":"off", jiffies - j->pstn_last_rmr);\r\n}\r\nj->pstn_prev_rmr = j->pstn_last_rmr;\r\nj->pstn_last_rmr = jiffies;\r\n}\r\nswitch(j->daa_mode) {\r\ncase SOP_PU_SLEEP:\r\nif (daaint.bitreg.RING) {\r\nif (!j->flags.pstn_ringing) {\r\nif (j->daa_mode != SOP_PU_RINGING) {\r\nj->pstn_ring_int = jiffies;\r\ndaa_set_mode(j, SOP_PU_RINGING);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase SOP_PU_RINGING:\r\nif (daaint.bitreg.RMR) {\r\nif (ixjdebug & 0x0008) {\r\nprintk(KERN_INFO "IXJ Ring Cadence a state = %d /dev/phone%d at %ld\n", j->cadence_f[4].state, j->board, jiffies);\r\n}\r\nif (daaint.bitreg.SI_1) {\r\nj->flags.pstn_rmr = 1;\r\nj->pstn_ring_start = jiffies;\r\nj->pstn_ring_stop = 0;\r\nj->ex.bits.pstn_ring = 0;\r\nif (j->cadence_f[4].state == 0) {\r\nj->cadence_f[4].state = 1;\r\nj->cadence_f[4].on1min = jiffies + (long)((j->cadence_f[4].on1 * hertz * (100 - var)) / 10000);\r\nj->cadence_f[4].on1dot = jiffies + (long)((j->cadence_f[4].on1 * hertz * (100)) / 10000);\r\nj->cadence_f[4].on1max = jiffies + (long)((j->cadence_f[4].on1 * hertz * (100 + var)) / 10000);\r\n} else if (j->cadence_f[4].state == 2) {\r\nif((time_after(jiffies, j->cadence_f[4].off1min) &&\r\ntime_before(jiffies, j->cadence_f[4].off1max))) {\r\nif (j->cadence_f[4].on2) {\r\nj->cadence_f[4].state = 3;\r\nj->cadence_f[4].on2min = jiffies + (long)((j->cadence_f[4].on2 * (hertz * (100 - var)) / 10000));\r\nj->cadence_f[4].on2dot = jiffies + (long)((j->cadence_f[4].on2 * (hertz * (100)) / 10000));\r\nj->cadence_f[4].on2max = jiffies + (long)((j->cadence_f[4].on2 * (hertz * (100 + var)) / 10000));\r\n} else {\r\nj->cadence_f[4].state = 7;\r\n}\r\n} else {\r\nif (ixjdebug & 0x0008) {\r\nprintk(KERN_INFO "IXJ Ring Cadence fail state = %d /dev/phone%d at %ld should be %d\n",\r\nj->cadence_f[4].state, j->board, jiffies - j->pstn_prev_rmr,\r\nj->cadence_f[4].off1);\r\n}\r\nj->cadence_f[4].state = 0;\r\n}\r\n} else if (j->cadence_f[4].state == 4) {\r\nif((time_after(jiffies, j->cadence_f[4].off2min) &&\r\ntime_before(jiffies, j->cadence_f[4].off2max))) {\r\nif (j->cadence_f[4].on3) {\r\nj->cadence_f[4].state = 5;\r\nj->cadence_f[4].on3min = jiffies + (long)((j->cadence_f[4].on3 * (hertz * (100 - var)) / 10000));\r\nj->cadence_f[4].on3dot = jiffies + (long)((j->cadence_f[4].on3 * (hertz * (100)) / 10000));\r\nj->cadence_f[4].on3max = jiffies + (long)((j->cadence_f[4].on3 * (hertz * (100 + var)) / 10000));\r\n} else {\r\nj->cadence_f[4].state = 7;\r\n}\r\n} else {\r\nif (ixjdebug & 0x0008) {\r\nprintk(KERN_INFO "IXJ Ring Cadence fail state = %d /dev/phone%d at %ld should be %d\n",\r\nj->cadence_f[4].state, j->board, jiffies - j->pstn_prev_rmr,\r\nj->cadence_f[4].off2);\r\n}\r\nj->cadence_f[4].state = 0;\r\n}\r\n} else if (j->cadence_f[4].state == 6) {\r\nif((time_after(jiffies, j->cadence_f[4].off3min) &&\r\ntime_before(jiffies, j->cadence_f[4].off3max))) {\r\nj->cadence_f[4].state = 7;\r\n} else {\r\nif (ixjdebug & 0x0008) {\r\nprintk(KERN_INFO "IXJ Ring Cadence fail state = %d /dev/phone%d at %ld should be %d\n",\r\nj->cadence_f[4].state, j->board, jiffies - j->pstn_prev_rmr,\r\nj->cadence_f[4].off3);\r\n}\r\nj->cadence_f[4].state = 0;\r\n}\r\n} else {\r\nj->cadence_f[4].state = 0;\r\n}\r\n} else {\r\nj->pstn_ring_start = 0;\r\nj->pstn_ring_stop = jiffies;\r\nif (j->cadence_f[4].state == 1) {\r\nif(!j->cadence_f[4].on1) {\r\nj->cadence_f[4].state = 7;\r\n} else if((time_after(jiffies, j->cadence_f[4].on1min) &&\r\ntime_before(jiffies, j->cadence_f[4].on1max))) {\r\nif (j->cadence_f[4].off1) {\r\nj->cadence_f[4].state = 2;\r\nj->cadence_f[4].off1min = jiffies + (long)((j->cadence_f[4].off1 * (hertz * (100 - var)) / 10000));\r\nj->cadence_f[4].off1dot = jiffies + (long)((j->cadence_f[4].off1 * (hertz * (100)) / 10000));\r\nj->cadence_f[4].off1max = jiffies + (long)((j->cadence_f[4].off1 * (hertz * (100 + var)) / 10000));\r\n} else {\r\nj->cadence_f[4].state = 7;\r\n}\r\n} else {\r\nif (ixjdebug & 0x0008) {\r\nprintk(KERN_INFO "IXJ Ring Cadence fail state = %d /dev/phone%d at %ld should be %d\n",\r\nj->cadence_f[4].state, j->board, jiffies - j->pstn_prev_rmr,\r\nj->cadence_f[4].on1);\r\n}\r\nj->cadence_f[4].state = 0;\r\n}\r\n} else if (j->cadence_f[4].state == 3) {\r\nif((time_after(jiffies, j->cadence_f[4].on2min) &&\r\ntime_before(jiffies, j->cadence_f[4].on2max))) {\r\nif (j->cadence_f[4].off2) {\r\nj->cadence_f[4].state = 4;\r\nj->cadence_f[4].off2min = jiffies + (long)((j->cadence_f[4].off2 * (hertz * (100 - var)) / 10000));\r\nj->cadence_f[4].off2dot = jiffies + (long)((j->cadence_f[4].off2 * (hertz * (100)) / 10000));\r\nj->cadence_f[4].off2max = jiffies + (long)((j->cadence_f[4].off2 * (hertz * (100 + var)) / 10000));\r\n} else {\r\nj->cadence_f[4].state = 7;\r\n}\r\n} else {\r\nif (ixjdebug & 0x0008) {\r\nprintk(KERN_INFO "IXJ Ring Cadence fail state = %d /dev/phone%d at %ld should be %d\n",\r\nj->cadence_f[4].state, j->board, jiffies - j->pstn_prev_rmr,\r\nj->cadence_f[4].on2);\r\n}\r\nj->cadence_f[4].state = 0;\r\n}\r\n} else if (j->cadence_f[4].state == 5) {\r\nif((time_after(jiffies, j->cadence_f[4].on3min) &&\r\ntime_before(jiffies, j->cadence_f[4].on3max))) {\r\nif (j->cadence_f[4].off3) {\r\nj->cadence_f[4].state = 6;\r\nj->cadence_f[4].off3min = jiffies + (long)((j->cadence_f[4].off3 * (hertz * (100 - var)) / 10000));\r\nj->cadence_f[4].off3dot = jiffies + (long)((j->cadence_f[4].off3 * (hertz * (100)) / 10000));\r\nj->cadence_f[4].off3max = jiffies + (long)((j->cadence_f[4].off3 * (hertz * (100 + var)) / 10000));\r\n} else {\r\nj->cadence_f[4].state = 7;\r\n}\r\n} else {\r\nj->cadence_f[4].state = 0;\r\n}\r\n} else {\r\nif (ixjdebug & 0x0008) {\r\nprintk(KERN_INFO "IXJ Ring Cadence fail state = %d /dev/phone%d at %ld should be %d\n",\r\nj->cadence_f[4].state, j->board, jiffies - j->pstn_prev_rmr,\r\nj->cadence_f[4].on3);\r\n}\r\nj->cadence_f[4].state = 0;\r\n}\r\n}\r\nif (ixjdebug & 0x0010) {\r\nprintk(KERN_INFO "IXJ Ring Cadence b state = %d /dev/phone%d at %ld\n", j->cadence_f[4].state, j->board, jiffies);\r\n}\r\nif (ixjdebug & 0x0010) {\r\nswitch(j->cadence_f[4].state) {\r\ncase 1:\r\nprintk(KERN_INFO "IXJ /dev/phone%d Next Ring Cadence state at %u min %ld - %ld - max %ld\n", j->board,\r\nj->cadence_f[4].on1, j->cadence_f[4].on1min, j->cadence_f[4].on1dot, j->cadence_f[4].on1max);\r\nbreak;\r\ncase 2:\r\nprintk(KERN_INFO "IXJ /dev/phone%d Next Ring Cadence state at %u min %ld - %ld - max %ld\n", j->board,\r\nj->cadence_f[4].off1, j->cadence_f[4].off1min, j->cadence_f[4].off1dot, j->cadence_f[4].off1max);\r\nbreak;\r\ncase 3:\r\nprintk(KERN_INFO "IXJ /dev/phone%d Next Ring Cadence state at %u min %ld - %ld - max %ld\n", j->board,\r\nj->cadence_f[4].on2, j->cadence_f[4].on2min, j->cadence_f[4].on2dot, j->cadence_f[4].on2max);\r\nbreak;\r\ncase 4:\r\nprintk(KERN_INFO "IXJ /dev/phone%d Next Ring Cadence state at %u min %ld - %ld - max %ld\n", j->board,\r\nj->cadence_f[4].off2, j->cadence_f[4].off2min, j->cadence_f[4].off2dot, j->cadence_f[4].off2max);\r\nbreak;\r\ncase 5:\r\nprintk(KERN_INFO "IXJ /dev/phone%d Next Ring Cadence state at %u min %ld - %ld - max %ld\n", j->board,\r\nj->cadence_f[4].on3, j->cadence_f[4].on3min, j->cadence_f[4].on3dot, j->cadence_f[4].on3max);\r\nbreak;\r\ncase 6:\r\nprintk(KERN_INFO "IXJ /dev/phone%d Next Ring Cadence state at %u min %ld - %ld - max %ld\n", j->board,\r\nj->cadence_f[4].off3, j->cadence_f[4].off3min, j->cadence_f[4].off3dot, j->cadence_f[4].off3max);\r\nbreak;\r\n}\r\n}\r\n}\r\nif (j->cadence_f[4].state == 7) {\r\nj->cadence_f[4].state = 0;\r\nj->pstn_ring_stop = jiffies;\r\nj->ex.bits.pstn_ring = 1;\r\nixj_kill_fasync(j, SIG_PSTN_RING, POLL_IN);\r\nif(ixjdebug & 0x0008) {\r\nprintk(KERN_INFO "IXJ Ring int set /dev/phone%d at %ld\n", j->board, jiffies);\r\n}\r\n}\r\nif((j->pstn_ring_int != 0 && time_after(jiffies, j->pstn_ring_int + (hertz * 5)) && !j->flags.pstn_rmr) ||\r\n(j->pstn_ring_stop != 0 && time_after(jiffies, j->pstn_ring_stop + (hertz * 5)))) {\r\nif(ixjdebug & 0x0008) {\r\nprintk("IXJ DAA no ring in 5 seconds /dev/phone%d at %ld\n", j->board, jiffies);\r\nprintk("IXJ DAA pstn ring int /dev/phone%d at %ld\n", j->board, j->pstn_ring_int);\r\nprintk("IXJ DAA pstn ring stop /dev/phone%d at %ld\n", j->board, j->pstn_ring_stop);\r\n}\r\nj->pstn_ring_stop = j->pstn_ring_int = 0;\r\ndaa_set_mode(j, SOP_PU_SLEEP);\r\n}\r\noutb_p(j->pld_scrw.byte, j->XILINXbase);\r\nif (j->pstn_cid_intr && time_after(jiffies, j->pstn_cid_received + hertz)) {\r\nixj_daa_cid_read(j);\r\nj->ex.bits.caller_id = 1;\r\nixj_kill_fasync(j, SIG_CALLER_ID, POLL_IN);\r\nj->pstn_cid_intr = 0;\r\n}\r\nif (daaint.bitreg.Cadence) {\r\nif(ixjdebug & 0x0008) {\r\nprintk("IXJ DAA Cadence interrupt going to sleep /dev/phone%d\n", j->board);\r\n}\r\ndaa_set_mode(j, SOP_PU_SLEEP);\r\nj->ex.bits.pstn_ring = 0;\r\n}\r\nbreak;\r\ncase SOP_PU_CONVERSATION:\r\nif (daaint.bitreg.VDD_OK) {\r\nif(!daaint.bitreg.SI_0) {\r\nif (!j->pstn_winkstart) {\r\nif(ixjdebug & 0x0008) {\r\nprintk("IXJ DAA possible wink /dev/phone%d %ld\n", j->board, jiffies);\r\n}\r\nj->pstn_winkstart = jiffies;\r\n}\r\n} else {\r\nif (j->pstn_winkstart) {\r\nif(ixjdebug & 0x0008) {\r\nprintk("IXJ DAA possible wink end /dev/phone%d %ld\n", j->board, jiffies);\r\n}\r\nj->pstn_winkstart = 0;\r\n}\r\n}\r\n}\r\nif (j->pstn_winkstart && time_after(jiffies, j->pstn_winkstart + ((hertz * j->winktime) / 1000))) {\r\nif(ixjdebug & 0x0008) {\r\nprintk("IXJ DAA wink detected going to sleep /dev/phone%d %ld\n", j->board, jiffies);\r\n}\r\ndaa_set_mode(j, SOP_PU_SLEEP);\r\nj->pstn_winkstart = 0;\r\nj->ex.bits.pstn_wink = 1;\r\nixj_kill_fasync(j, SIG_PSTN_WINK, POLL_IN);\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic void ixj_timeout(unsigned long ptr)\r\n{\r\nint board;\r\nunsigned long jifon;\r\nIXJ *j = (IXJ *)ptr;\r\nboard = j->board;\r\nif (j->DSPbase && atomic_read(&j->DSPWrite) == 0 && test_and_set_bit(board, (void *)&j->busyflags) == 0) {\r\nixj_perfmon(j->timerchecks);\r\nj->hookstate = ixj_hookstate(j);\r\nif (j->tone_state) {\r\nif (!(j->hookstate)) {\r\nixj_cpt_stop(j);\r\nif (j->m_hook) {\r\nj->m_hook = 0;\r\nj->ex.bits.hookstate = 1;\r\nixj_kill_fasync(j, SIG_HOOKSTATE, POLL_IN);\r\n}\r\nclear_bit(board, &j->busyflags);\r\nixj_add_timer(j);\r\nreturn;\r\n}\r\nif (j->tone_state == 1)\r\njifon = ((hertz * j->tone_on_time) * 25 / 100000);\r\nelse\r\njifon = ((hertz * j->tone_on_time) * 25 / 100000) + ((hertz * j->tone_off_time) * 25 / 100000);\r\nif (time_before(jiffies, j->tone_start_jif + jifon)) {\r\nif (j->tone_state == 1) {\r\nixj_play_tone(j, j->tone_index);\r\nif (j->dsp.low == 0x20) {\r\nclear_bit(board, &j->busyflags);\r\nixj_add_timer(j);\r\nreturn;\r\n}\r\n} else {\r\nixj_play_tone(j, 0);\r\nif (j->dsp.low == 0x20) {\r\nclear_bit(board, &j->busyflags);\r\nixj_add_timer(j);\r\nreturn;\r\n}\r\n}\r\n} else {\r\nixj_tone_timeout(j);\r\nif (j->flags.dialtone) {\r\nixj_dialtone(j);\r\n}\r\nif (j->flags.busytone) {\r\nixj_busytone(j);\r\nif (j->dsp.low == 0x20) {\r\nclear_bit(board, &j->busyflags);\r\nixj_add_timer(j);\r\nreturn;\r\n}\r\n}\r\nif (j->flags.ringback) {\r\nixj_ringback(j);\r\nif (j->dsp.low == 0x20) {\r\nclear_bit(board, &j->busyflags);\r\nixj_add_timer(j);\r\nreturn;\r\n}\r\n}\r\nif (!j->tone_state) {\r\nixj_cpt_stop(j);\r\n}\r\n}\r\n}\r\nif (!(j->tone_state && j->dsp.low == 0x20)) {\r\nif (IsRxReady(j)) {\r\nixj_read_frame(j);\r\n}\r\nif (IsTxReady(j)) {\r\nixj_write_frame(j);\r\n}\r\n}\r\nif (j->flags.cringing) {\r\nif (j->hookstate & 1) {\r\nj->flags.cringing = 0;\r\nixj_ring_off(j);\r\n} else if(j->cadence_f[5].enable && ((!j->cadence_f[5].en_filter) || (j->cadence_f[5].en_filter && j->flags.firstring))) {\r\nswitch(j->cadence_f[5].state) {\r\ncase 0:\r\nj->cadence_f[5].on1dot = jiffies + (long)((j->cadence_f[5].on1 * (hertz * 100) / 10000));\r\nif (time_before(jiffies, j->cadence_f[5].on1dot)) {\r\nif(ixjdebug & 0x0004) {\r\nprintk("Ringing cadence state = %d - %ld\n", j->cadence_f[5].state, jiffies);\r\n}\r\nixj_ring_on(j);\r\n}\r\nj->cadence_f[5].state = 1;\r\nbreak;\r\ncase 1:\r\nif (time_after(jiffies, j->cadence_f[5].on1dot)) {\r\nj->cadence_f[5].off1dot = jiffies + (long)((j->cadence_f[5].off1 * (hertz * 100) / 10000));\r\nif(ixjdebug & 0x0004) {\r\nprintk("Ringing cadence state = %d - %ld\n", j->cadence_f[5].state, jiffies);\r\n}\r\nixj_ring_off(j);\r\nj->cadence_f[5].state = 2;\r\n}\r\nbreak;\r\ncase 2:\r\nif (time_after(jiffies, j->cadence_f[5].off1dot)) {\r\nif(ixjdebug & 0x0004) {\r\nprintk("Ringing cadence state = %d - %ld\n", j->cadence_f[5].state, jiffies);\r\n}\r\nixj_ring_on(j);\r\nif (j->cadence_f[5].on2) {\r\nj->cadence_f[5].on2dot = jiffies + (long)((j->cadence_f[5].on2 * (hertz * 100) / 10000));\r\nj->cadence_f[5].state = 3;\r\n} else {\r\nj->cadence_f[5].state = 7;\r\n}\r\n}\r\nbreak;\r\ncase 3:\r\nif (time_after(jiffies, j->cadence_f[5].on2dot)) {\r\nif(ixjdebug & 0x0004) {\r\nprintk("Ringing cadence state = %d - %ld\n", j->cadence_f[5].state, jiffies);\r\n}\r\nixj_ring_off(j);\r\nif (j->cadence_f[5].off2) {\r\nj->cadence_f[5].off2dot = jiffies + (long)((j->cadence_f[5].off2 * (hertz * 100) / 10000));\r\nj->cadence_f[5].state = 4;\r\n} else {\r\nj->cadence_f[5].state = 7;\r\n}\r\n}\r\nbreak;\r\ncase 4:\r\nif (time_after(jiffies, j->cadence_f[5].off2dot)) {\r\nif(ixjdebug & 0x0004) {\r\nprintk("Ringing cadence state = %d - %ld\n", j->cadence_f[5].state, jiffies);\r\n}\r\nixj_ring_on(j);\r\nif (j->cadence_f[5].on3) {\r\nj->cadence_f[5].on3dot = jiffies + (long)((j->cadence_f[5].on3 * (hertz * 100) / 10000));\r\nj->cadence_f[5].state = 5;\r\n} else {\r\nj->cadence_f[5].state = 7;\r\n}\r\n}\r\nbreak;\r\ncase 5:\r\nif (time_after(jiffies, j->cadence_f[5].on3dot)) {\r\nif(ixjdebug & 0x0004) {\r\nprintk("Ringing cadence state = %d - %ld\n", j->cadence_f[5].state, jiffies);\r\n}\r\nixj_ring_off(j);\r\nif (j->cadence_f[5].off3) {\r\nj->cadence_f[5].off3dot = jiffies + (long)((j->cadence_f[5].off3 * (hertz * 100) / 10000));\r\nj->cadence_f[5].state = 6;\r\n} else {\r\nj->cadence_f[5].state = 7;\r\n}\r\n}\r\nbreak;\r\ncase 6:\r\nif (time_after(jiffies, j->cadence_f[5].off3dot)) {\r\nif(ixjdebug & 0x0004) {\r\nprintk("Ringing cadence state = %d - %ld\n", j->cadence_f[5].state, jiffies);\r\n}\r\nj->cadence_f[5].state = 7;\r\n}\r\nbreak;\r\ncase 7:\r\nif(ixjdebug & 0x0004) {\r\nprintk("Ringing cadence state = %d - %ld\n", j->cadence_f[5].state, jiffies);\r\n}\r\nj->flags.cidring = 1;\r\nj->cadence_f[5].state = 0;\r\nbreak;\r\n}\r\nif (j->flags.cidring && !j->flags.cidsent) {\r\nj->flags.cidsent = 1;\r\nif(j->fskdcnt) {\r\nSLIC_SetState(PLD_SLIC_STATE_OHT, j);\r\nixj_pre_cid(j);\r\n}\r\nj->flags.cidring = 0;\r\n}\r\nclear_bit(board, &j->busyflags);\r\nixj_add_timer(j);\r\nreturn;\r\n} else {\r\nif (time_after(jiffies, j->ring_cadence_jif + (hertz / 2))) {\r\nif (j->flags.cidring && !j->flags.cidsent) {\r\nj->flags.cidsent = 1;\r\nif(j->fskdcnt) {\r\nSLIC_SetState(PLD_SLIC_STATE_OHT, j);\r\nixj_pre_cid(j);\r\n}\r\nj->flags.cidring = 0;\r\n}\r\nj->ring_cadence_t--;\r\nif (j->ring_cadence_t == -1)\r\nj->ring_cadence_t = 15;\r\nj->ring_cadence_jif = jiffies;\r\nif (j->ring_cadence & 1 << j->ring_cadence_t) {\r\nif(j->flags.cidsent && j->cadence_f[5].en_filter)\r\nj->flags.firstring = 1;\r\nelse\r\nixj_ring_on(j);\r\n} else {\r\nixj_ring_off(j);\r\nif(!j->flags.cidsent)\r\nj->flags.cidring = 1;\r\n}\r\n}\r\nclear_bit(board, &j->busyflags);\r\nixj_add_timer(j);\r\nreturn;\r\n}\r\n}\r\nif (!j->flags.ringing) {\r\nif (j->hookstate) {\r\nif (j->dsp.low != 0x20 &&\r\nSLIC_GetState(j) != PLD_SLIC_STATE_ACTIVE) {\r\nSLIC_SetState(PLD_SLIC_STATE_ACTIVE, j);\r\n}\r\nLineMonitor(j);\r\nread_filters(j);\r\nixj_WriteDSPCommand(0x511B, j);\r\nj->proc_load = j->ssr.high << 8 | j->ssr.low;\r\nif (!j->m_hook && (j->hookstate & 1)) {\r\nj->m_hook = j->ex.bits.hookstate = 1;\r\nixj_kill_fasync(j, SIG_HOOKSTATE, POLL_IN);\r\n}\r\n} else {\r\nif (j->ex.bits.dtmf_ready) {\r\nj->dtmf_wp = j->dtmf_rp = j->ex.bits.dtmf_ready = 0;\r\n}\r\nif (j->m_hook) {\r\nj->m_hook = 0;\r\nj->ex.bits.hookstate = 1;\r\nixj_kill_fasync(j, SIG_HOOKSTATE, POLL_IN);\r\n}\r\n}\r\n}\r\nif (j->cardtype == QTI_LINEJACK && !j->flags.pstncheck && j->flags.pstn_present) {\r\nixj_pstn_state(j);\r\n}\r\nif (j->ex.bytes) {\r\nwake_up_interruptible(&j->poll_q);\r\n}\r\nclear_bit(board, &j->busyflags);\r\n}\r\nixj_add_timer(j);\r\n}\r\nstatic int ixj_status_wait(IXJ *j)\r\n{\r\nunsigned long jif;\r\njif = jiffies + ((60 * hertz) / 100);\r\nwhile (!IsStatusReady(j)) {\r\nixj_perfmon(j->statuswait);\r\nif (time_after(jiffies, jif)) {\r\nixj_perfmon(j->statuswaitfail);\r\nreturn -1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int ixj_PCcontrol_wait(IXJ *j)\r\n{\r\nunsigned long jif;\r\njif = jiffies + ((60 * hertz) / 100);\r\nwhile (!IsPCControlReady(j)) {\r\nixj_perfmon(j->pcontrolwait);\r\nif (time_after(jiffies, jif)) {\r\nixj_perfmon(j->pcontrolwaitfail);\r\nreturn -1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int ixj_WriteDSPCommand(unsigned short cmd, IXJ *j)\r\n{\r\nBYTES bytes;\r\nunsigned long jif;\r\natomic_inc(&j->DSPWrite);\r\nif(atomic_read(&j->DSPWrite) > 1) {\r\nprintk("IXJ %d DSP write overlap attempting command 0x%4.4x\n", j->board, cmd);\r\nreturn -1;\r\n}\r\nbytes.high = (cmd & 0xFF00) >> 8;\r\nbytes.low = cmd & 0x00FF;\r\njif = jiffies + ((60 * hertz) / 100);\r\nwhile (!IsControlReady(j)) {\r\nixj_perfmon(j->iscontrolready);\r\nif (time_after(jiffies, jif)) {\r\nixj_perfmon(j->iscontrolreadyfail);\r\natomic_dec(&j->DSPWrite);\r\nif(atomic_read(&j->DSPWrite) > 0) {\r\nprintk("IXJ %d DSP overlaped command 0x%4.4x during control ready failure.\n", j->board, cmd);\r\nwhile(atomic_read(&j->DSPWrite) > 0) {\r\natomic_dec(&j->DSPWrite);\r\n}\r\n}\r\nreturn -1;\r\n}\r\n}\r\noutb(bytes.low, j->DSPbase + 6);\r\noutb(bytes.high, j->DSPbase + 7);\r\nif (ixj_status_wait(j)) {\r\nj->ssr.low = 0xFF;\r\nj->ssr.high = 0xFF;\r\natomic_dec(&j->DSPWrite);\r\nif(atomic_read(&j->DSPWrite) > 0) {\r\nprintk("IXJ %d DSP overlaped command 0x%4.4x during status wait failure.\n", j->board, cmd);\r\nwhile(atomic_read(&j->DSPWrite) > 0) {\r\natomic_dec(&j->DSPWrite);\r\n}\r\n}\r\nreturn -1;\r\n}\r\nj->ssr.low = inb_p(j->DSPbase + 2);\r\nj->ssr.high = inb_p(j->DSPbase + 3);\r\natomic_dec(&j->DSPWrite);\r\nif(atomic_read(&j->DSPWrite) > 0) {\r\nprintk("IXJ %d DSP overlaped command 0x%4.4x\n", j->board, cmd);\r\nwhile(atomic_read(&j->DSPWrite) > 0) {\r\natomic_dec(&j->DSPWrite);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int ixj_gpio_read(IXJ *j)\r\n{\r\nif (ixj_WriteDSPCommand(0x5143, j))\r\nreturn -1;\r\nj->gpio.bytes.low = j->ssr.low;\r\nj->gpio.bytes.high = j->ssr.high;\r\nreturn 0;\r\n}\r\nstatic inline void LED_SetState(int state, IXJ *j)\r\n{\r\nif (j->cardtype == QTI_LINEJACK) {\r\nj->pld_scrw.bits.led1 = state & 0x1 ? 1 : 0;\r\nj->pld_scrw.bits.led2 = state & 0x2 ? 1 : 0;\r\nj->pld_scrw.bits.led3 = state & 0x4 ? 1 : 0;\r\nj->pld_scrw.bits.led4 = state & 0x8 ? 1 : 0;\r\noutb(j->pld_scrw.byte, j->XILINXbase);\r\n}\r\n}\r\nstatic int ixj_set_port(IXJ *j, int arg)\r\n{\r\nif (j->cardtype == QTI_PHONEJACK_LITE) {\r\nif (arg != PORT_POTS)\r\nreturn 10;\r\nelse\r\nreturn 0;\r\n}\r\nswitch (arg) {\r\ncase PORT_POTS:\r\nj->port = PORT_POTS;\r\nswitch (j->cardtype) {\r\ncase QTI_PHONECARD:\r\nif (j->flags.pcmciasct == 1)\r\nSLIC_SetState(PLD_SLIC_STATE_ACTIVE, j);\r\nelse\r\nreturn 11;\r\nbreak;\r\ncase QTI_PHONEJACK_PCI:\r\nj->pld_slicw.pcib.mic = 0;\r\nj->pld_slicw.pcib.spk = 0;\r\noutb(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nbreak;\r\ncase QTI_LINEJACK:\r\nixj_set_pots(j, 0);\r\nif (ixj_WriteDSPCommand(0xC528, j))\r\nreturn 2;\r\nj->pld_scrw.bits.daafsyncen = 0;\r\noutb(j->pld_scrw.byte, j->XILINXbase);\r\nj->pld_clock.byte = 0;\r\noutb(j->pld_clock.byte, j->XILINXbase + 0x04);\r\nj->pld_slicw.bits.rly1 = 1;\r\nj->pld_slicw.bits.spken = 0;\r\noutb(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nixj_mixer(0x1200, j);\r\nixj_mixer(0x1401, j);\r\nixj_mixer(0x1300, j);\r\nixj_mixer(0x1501, j);\r\nixj_mixer(0x0E80, j);\r\nixj_mixer(0x0F00, j);\r\nixj_mixer(0x0080, j);\r\nixj_mixer(0x0180, j);\r\nSLIC_SetState(PLD_SLIC_STATE_STANDBY, j);\r\nbreak;\r\ncase QTI_PHONEJACK:\r\nj->gpio.bytes.high = 0x0B;\r\nj->gpio.bits.gpio6 = 0;\r\nj->gpio.bits.gpio7 = 0;\r\nixj_WriteDSPCommand(j->gpio.word, j);\r\nbreak;\r\n}\r\nbreak;\r\ncase PORT_PSTN:\r\nif (j->cardtype == QTI_LINEJACK) {\r\nixj_WriteDSPCommand(0xC534, j);\r\nj->pld_slicw.bits.rly3 = 0;\r\nj->pld_slicw.bits.rly1 = 1;\r\nj->pld_slicw.bits.spken = 0;\r\noutb(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nj->port = PORT_PSTN;\r\n} else {\r\nreturn 4;\r\n}\r\nbreak;\r\ncase PORT_SPEAKER:\r\nj->port = PORT_SPEAKER;\r\nswitch (j->cardtype) {\r\ncase QTI_PHONECARD:\r\nif (j->flags.pcmciasct) {\r\nSLIC_SetState(PLD_SLIC_STATE_OC, j);\r\n}\r\nbreak;\r\ncase QTI_PHONEJACK_PCI:\r\nj->pld_slicw.pcib.mic = 1;\r\nj->pld_slicw.pcib.spk = 1;\r\noutb(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nbreak;\r\ncase QTI_LINEJACK:\r\nixj_set_pots(j, 0);\r\nif (ixj_WriteDSPCommand(0xC528, j))\r\nreturn 2;\r\nj->pld_scrw.bits.daafsyncen = 0;\r\noutb(j->pld_scrw.byte, j->XILINXbase);\r\nj->pld_clock.byte = 0;\r\noutb(j->pld_clock.byte, j->XILINXbase + 0x04);\r\nj->pld_slicw.bits.rly1 = 1;\r\nj->pld_slicw.bits.spken = 1;\r\noutb(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nixj_mixer(0x1201, j);\r\nixj_mixer(0x1400, j);\r\nixj_mixer(0x1301, j);\r\nixj_mixer(0x1500, j);\r\nixj_mixer(0x0E06, j);\r\nixj_mixer(0x0F80, j);\r\nixj_mixer(0x0000, j);\r\nixj_mixer(0x0100, j);\r\nbreak;\r\ncase QTI_PHONEJACK:\r\nj->gpio.bytes.high = 0x0B;\r\nj->gpio.bits.gpio6 = 0;\r\nj->gpio.bits.gpio7 = 1;\r\nixj_WriteDSPCommand(j->gpio.word, j);\r\nbreak;\r\n}\r\nbreak;\r\ncase PORT_HANDSET:\r\nif (j->cardtype != QTI_PHONEJACK) {\r\nreturn 5;\r\n} else {\r\nj->gpio.bytes.high = 0x0B;\r\nj->gpio.bits.gpio6 = 1;\r\nj->gpio.bits.gpio7 = 0;\r\nixj_WriteDSPCommand(j->gpio.word, j);\r\nj->port = PORT_HANDSET;\r\n}\r\nbreak;\r\ndefault:\r\nreturn 6;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ixj_set_pots(IXJ *j, int arg)\r\n{\r\nif (j->cardtype == QTI_LINEJACK) {\r\nif (arg) {\r\nif (j->port == PORT_PSTN) {\r\nj->pld_slicw.bits.rly1 = 0;\r\noutb(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nj->flags.pots_pstn = 1;\r\nreturn 1;\r\n} else {\r\nj->flags.pots_pstn = 0;\r\nreturn 0;\r\n}\r\n} else {\r\nj->pld_slicw.bits.rly1 = 1;\r\noutb(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nj->flags.pots_pstn = 0;\r\nreturn 1;\r\n}\r\n} else {\r\nreturn 0;\r\n}\r\n}\r\nstatic void ixj_ring_on(IXJ *j)\r\n{\r\nif (j->dsp.low == 0x20)\r\n{\r\nif (ixjdebug & 0x0004)\r\nprintk(KERN_INFO "IXJ Ring On /dev/phone%d\n", j->board);\r\nj->gpio.bytes.high = 0x0B;\r\nj->gpio.bytes.low = 0x00;\r\nj->gpio.bits.gpio1 = 1;\r\nj->gpio.bits.gpio2 = 1;\r\nj->gpio.bits.gpio5 = 0;\r\nixj_WriteDSPCommand(j->gpio.word, j);\r\n} else\r\n{\r\nif (ixjdebug & 0x0004)\r\nprintk(KERN_INFO "IXJ Ring On /dev/phone%d\n", j->board);\r\nSLIC_SetState(PLD_SLIC_STATE_RINGING, j);\r\n}\r\n}\r\nstatic int ixj_siadc(IXJ *j, int val)\r\n{\r\nif(j->cardtype == QTI_PHONECARD){\r\nif(j->flags.pcmciascp){\r\nif(val == -1)\r\nreturn j->siadc.bits.rxg;\r\nif(val < 0 || val > 0x1F)\r\nreturn -1;\r\nj->siadc.bits.hom = 0;\r\nj->siadc.bits.lom = 0;\r\nj->siadc.bits.rxg = val;\r\nj->psccr.bits.addr = 6;\r\nj->psccr.bits.rw = 0;\r\nj->psccr.bits.dev = 0;\r\noutb(j->siadc.byte, j->XILINXbase + 0x00);\r\noutb(j->psccr.byte, j->XILINXbase + 0x01);\r\nixj_PCcontrol_wait(j);\r\nreturn j->siadc.bits.rxg;\r\n}\r\n}\r\nreturn -1;\r\n}\r\nstatic int ixj_sidac(IXJ *j, int val)\r\n{\r\nif(j->cardtype == QTI_PHONECARD){\r\nif(j->flags.pcmciascp){\r\nif(val == -1)\r\nreturn j->sidac.bits.txg;\r\nif(val < 0 || val > 0x1F)\r\nreturn -1;\r\nj->sidac.bits.srm = 1;\r\nj->sidac.bits.slm = 1;\r\nj->sidac.bits.txg = val;\r\nj->psccr.bits.addr = 7;\r\nj->psccr.bits.rw = 0;\r\nj->psccr.bits.dev = 0;\r\noutb(j->sidac.byte, j->XILINXbase + 0x00);\r\noutb(j->psccr.byte, j->XILINXbase + 0x01);\r\nixj_PCcontrol_wait(j);\r\nreturn j->sidac.bits.txg;\r\n}\r\n}\r\nreturn -1;\r\n}\r\nstatic int ixj_pcmcia_cable_check(IXJ *j)\r\n{\r\nj->pccr1.byte = inb_p(j->XILINXbase + 0x03);\r\nif (!j->flags.pcmciastate) {\r\nj->pccr2.byte = inb_p(j->XILINXbase + 0x02);\r\nif (j->pccr1.bits.drf || j->pccr2.bits.rstc) {\r\nj->flags.pcmciastate = 4;\r\nreturn 0;\r\n}\r\nif (j->pccr1.bits.ed) {\r\nj->pccr1.bits.ed = 0;\r\nj->psccr.bits.dev = 3;\r\nj->psccr.bits.rw = 1;\r\noutw_p(j->psccr.byte << 8, j->XILINXbase + 0x00);\r\nixj_PCcontrol_wait(j);\r\nj->pslic.byte = inw_p(j->XILINXbase + 0x00) & 0xFF;\r\nj->pslic.bits.led2 = j->pslic.bits.det ? 1 : 0;\r\nj->psccr.bits.dev = 3;\r\nj->psccr.bits.rw = 0;\r\noutw_p(j->psccr.byte << 8 | j->pslic.byte, j->XILINXbase + 0x00);\r\nixj_PCcontrol_wait(j);\r\nreturn j->pslic.bits.led2 ? 1 : 0;\r\n} else if (j->flags.pcmciasct) {\r\nreturn j->r_hook;\r\n} else {\r\nreturn 1;\r\n}\r\n} else if (j->flags.pcmciastate == 4) {\r\nif (!j->pccr1.bits.drf) {\r\nj->flags.pcmciastate = 3;\r\n}\r\nreturn 0;\r\n} else if (j->flags.pcmciastate == 3) {\r\nj->pccr2.bits.pwr = 0;\r\nj->pccr2.bits.rstc = 1;\r\noutb(j->pccr2.byte, j->XILINXbase + 0x02);\r\nj->checkwait = jiffies + (hertz * 2);\r\nj->flags.incheck = 1;\r\nj->flags.pcmciastate = 2;\r\nreturn 0;\r\n} else if (j->flags.pcmciastate == 2) {\r\nif (j->flags.incheck) {\r\nif (time_before(jiffies, j->checkwait)) {\r\nreturn 0;\r\n} else {\r\nj->flags.incheck = 0;\r\n}\r\n}\r\nj->pccr2.bits.pwr = 0;\r\nj->pccr2.bits.rstc = 0;\r\noutb_p(j->pccr2.byte, j->XILINXbase + 0x02);\r\nj->flags.pcmciastate = 1;\r\nreturn 0;\r\n} else if (j->flags.pcmciastate == 1) {\r\nj->flags.pcmciastate = 0;\r\nif (!j->pccr1.bits.drf) {\r\nj->psccr.bits.dev = 3;\r\nj->psccr.bits.rw = 1;\r\noutb_p(j->psccr.byte, j->XILINXbase + 0x01);\r\nixj_PCcontrol_wait(j);\r\nj->flags.pcmciascp = 1;\r\nj->flags.pcmciasct = (inw_p(j->XILINXbase + 0x00) >> 8) & 0x03;\r\nif (j->flags.pcmciasct == 3) {\r\nj->flags.pcmciastate = 4;\r\nreturn 0;\r\n} else if (j->flags.pcmciasct == 0) {\r\nj->pccr2.bits.pwr = 1;\r\nj->pccr2.bits.rstc = 0;\r\noutb_p(j->pccr2.byte, j->XILINXbase + 0x02);\r\nj->port = PORT_SPEAKER;\r\n} else {\r\nj->port = PORT_POTS;\r\n}\r\nj->sic1.bits.cpd = 0;\r\nj->sic1.bits.mpd = 0;\r\nj->sic1.bits.hpd = 0;\r\nj->sic1.bits.lpd = 0;\r\nj->sic1.bits.spd = 1;\r\nj->psccr.bits.addr = 1;\r\nj->psccr.bits.rw = 0;\r\nj->psccr.bits.dev = 0;\r\noutb(j->sic1.byte, j->XILINXbase + 0x00);\r\noutb(j->psccr.byte, j->XILINXbase + 0x01);\r\nixj_PCcontrol_wait(j);\r\nj->sic2.bits.al = 0;\r\nj->sic2.bits.dl2 = 0;\r\nj->sic2.bits.dl1 = 0;\r\nj->sic2.bits.pll = 0;\r\nj->sic2.bits.hpd = 0;\r\nj->psccr.bits.addr = 2;\r\nj->psccr.bits.rw = 0;\r\nj->psccr.bits.dev = 0;\r\noutb(j->sic2.byte, j->XILINXbase + 0x00);\r\noutb(j->psccr.byte, j->XILINXbase + 0x01);\r\nixj_PCcontrol_wait(j);\r\nj->psccr.bits.addr = 3;\r\nj->psccr.bits.rw = 0;\r\nj->psccr.bits.dev = 0;\r\noutb(0x00, j->XILINXbase + 0x00);\r\noutb(j->psccr.byte, j->XILINXbase + 0x01);\r\nixj_PCcontrol_wait(j);\r\nj->psccr.bits.addr = 4;\r\nj->psccr.bits.rw = 0;\r\nj->psccr.bits.dev = 0;\r\noutb(0x09, j->XILINXbase + 0x00);\r\noutb(j->psccr.byte, j->XILINXbase + 0x01);\r\nixj_PCcontrol_wait(j);\r\nj->sirxg.bits.lig = 1;\r\nj->sirxg.bits.lim = 1;\r\nj->sirxg.bits.mcg = 0;\r\nj->sirxg.bits.mcm = 0;\r\nj->sirxg.bits.him = 0;\r\nj->sirxg.bits.iir = 1;\r\nj->psccr.bits.addr = 5;\r\nj->psccr.bits.rw = 0;\r\nj->psccr.bits.dev = 0;\r\noutb(j->sirxg.byte, j->XILINXbase + 0x00);\r\noutb(j->psccr.byte, j->XILINXbase + 0x01);\r\nixj_PCcontrol_wait(j);\r\nixj_siadc(j, 0x17);\r\nixj_sidac(j, 0x1D);\r\nj->siaatt.bits.sot = 0;\r\nj->psccr.bits.addr = 9;\r\nj->psccr.bits.rw = 0;\r\nj->psccr.bits.dev = 0;\r\noutb(j->siaatt.byte, j->XILINXbase + 0x00);\r\noutb(j->psccr.byte, j->XILINXbase + 0x01);\r\nixj_PCcontrol_wait(j);\r\nif (j->flags.pcmciasct == 1 && !j->readers && !j->writers) {\r\nj->psccr.byte = j->pslic.byte = 0;\r\nj->pslic.bits.powerdown = 1;\r\nj->psccr.bits.dev = 3;\r\nj->psccr.bits.rw = 0;\r\noutw_p(j->psccr.byte << 8 | j->pslic.byte, j->XILINXbase + 0x00);\r\nixj_PCcontrol_wait(j);\r\n}\r\n}\r\nreturn 0;\r\n} else {\r\nj->flags.pcmciascp = 0;\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ixj_hookstate(IXJ *j)\r\n{\r\nint fOffHook = 0;\r\nswitch (j->cardtype) {\r\ncase QTI_PHONEJACK:\r\nixj_gpio_read(j);\r\nfOffHook = j->gpio.bits.gpio3read ? 1 : 0;\r\nbreak;\r\ncase QTI_LINEJACK:\r\ncase QTI_PHONEJACK_LITE:\r\ncase QTI_PHONEJACK_PCI:\r\nSLIC_GetState(j);\r\nif(j->cardtype == QTI_LINEJACK && j->flags.pots_pstn == 1 && (j->readers || j->writers)) {\r\nfOffHook = j->pld_slicr.bits.potspstn ? 1 : 0;\r\nif(fOffHook != j->p_hook) {\r\nif(!j->checkwait) {\r\nj->checkwait = jiffies;\r\n}\r\nif(time_before(jiffies, j->checkwait + 2)) {\r\nfOffHook ^= 1;\r\n} else {\r\nj->checkwait = 0;\r\n}\r\nj->p_hook = fOffHook;\r\nprintk("IXJ : /dev/phone%d pots-pstn hookstate check %d at %ld\n", j->board, fOffHook, jiffies);\r\n}\r\n} else {\r\nif (j->pld_slicr.bits.state == PLD_SLIC_STATE_ACTIVE ||\r\nj->pld_slicr.bits.state == PLD_SLIC_STATE_STANDBY) {\r\nif (j->flags.ringing || j->flags.cringing) {\r\nif (!in_interrupt()) {\r\nmsleep(20);\r\n}\r\nSLIC_GetState(j);\r\nif (j->pld_slicr.bits.state == PLD_SLIC_STATE_RINGING) {\r\nixj_ring_on(j);\r\n}\r\n}\r\nif (j->cardtype == QTI_PHONEJACK_PCI) {\r\nj->pld_scrr.byte = inb_p(j->XILINXbase);\r\nfOffHook = j->pld_scrr.pcib.det ? 1 : 0;\r\n} else\r\nfOffHook = j->pld_slicr.bits.det ? 1 : 0;\r\n}\r\n}\r\nbreak;\r\ncase QTI_PHONECARD:\r\nfOffHook = ixj_pcmcia_cable_check(j);\r\nbreak;\r\n}\r\nif (j->r_hook != fOffHook) {\r\nj->r_hook = fOffHook;\r\nif (j->port == PORT_SPEAKER || j->port == PORT_HANDSET) {\r\nj->ex.bits.hookstate = 1;\r\nixj_kill_fasync(j, SIG_HOOKSTATE, POLL_IN);\r\n} else if (!fOffHook) {\r\nj->flash_end = jiffies + ((60 * hertz) / 100);\r\n}\r\n}\r\nif (fOffHook) {\r\nif(time_before(jiffies, j->flash_end)) {\r\nj->ex.bits.flash = 1;\r\nj->flash_end = 0;\r\nixj_kill_fasync(j, SIG_FLASH, POLL_IN);\r\n}\r\n} else {\r\nif(time_before(jiffies, j->flash_end)) {\r\nfOffHook = 1;\r\n}\r\n}\r\nif (j->port == PORT_PSTN && j->daa_mode == SOP_PU_CONVERSATION)\r\nfOffHook |= 2;\r\nif (j->port == PORT_SPEAKER) {\r\nif(j->cardtype == QTI_PHONECARD) {\r\nif(j->flags.pcmciascp && j->flags.pcmciasct) {\r\nfOffHook |= 2;\r\n}\r\n} else {\r\nfOffHook |= 2;\r\n}\r\n}\r\nif (j->port == PORT_HANDSET)\r\nfOffHook |= 2;\r\nreturn fOffHook;\r\n}\r\nstatic void ixj_ring_off(IXJ *j)\r\n{\r\nif (j->dsp.low == 0x20)\r\n{\r\nif (ixjdebug & 0x0004)\r\nprintk(KERN_INFO "IXJ Ring Off\n");\r\nj->gpio.bytes.high = 0x0B;\r\nj->gpio.bytes.low = 0x00;\r\nj->gpio.bits.gpio1 = 0;\r\nj->gpio.bits.gpio2 = 1;\r\nj->gpio.bits.gpio5 = 0;\r\nixj_WriteDSPCommand(j->gpio.word, j);\r\n} else\r\n{\r\nif (ixjdebug & 0x0004)\r\nprintk(KERN_INFO "IXJ Ring Off\n");\r\nif(!j->flags.cidplay)\r\nSLIC_SetState(PLD_SLIC_STATE_STANDBY, j);\r\nSLIC_GetState(j);\r\n}\r\n}\r\nstatic void ixj_ring_start(IXJ *j)\r\n{\r\nj->flags.cringing = 1;\r\nif (ixjdebug & 0x0004)\r\nprintk(KERN_INFO "IXJ Cadence Ringing Start /dev/phone%d\n", j->board);\r\nif (ixj_hookstate(j) & 1) {\r\nif (j->port == PORT_POTS)\r\nixj_ring_off(j);\r\nj->flags.cringing = 0;\r\nif (ixjdebug & 0x0004)\r\nprintk(KERN_INFO "IXJ Cadence Ringing Stopped /dev/phone%d off hook\n", j->board);\r\n} else if(j->cadence_f[5].enable && (!j->cadence_f[5].en_filter)) {\r\nj->ring_cadence_jif = jiffies;\r\nj->flags.cidsent = j->flags.cidring = 0;\r\nj->cadence_f[5].state = 0;\r\nif(j->cadence_f[5].on1)\r\nixj_ring_on(j);\r\n} else {\r\nj->ring_cadence_jif = jiffies;\r\nj->ring_cadence_t = 15;\r\nif (j->ring_cadence & 1 << j->ring_cadence_t) {\r\nixj_ring_on(j);\r\n} else {\r\nixj_ring_off(j);\r\n}\r\nj->flags.cidsent = j->flags.cidring = j->flags.firstring = 0;\r\n}\r\n}\r\nstatic int ixj_ring(IXJ *j)\r\n{\r\nchar cntr;\r\nunsigned long jif;\r\nj->flags.ringing = 1;\r\nif (ixj_hookstate(j) & 1) {\r\nixj_ring_off(j);\r\nj->flags.ringing = 0;\r\nreturn 1;\r\n}\r\nfor (cntr = 0; cntr < j->maxrings; cntr++) {\r\njif = jiffies + (1 * hertz);\r\nixj_ring_on(j);\r\nwhile (time_before(jiffies, jif)) {\r\nif (ixj_hookstate(j) & 1) {\r\nixj_ring_off(j);\r\nj->flags.ringing = 0;\r\nreturn 1;\r\n}\r\nschedule_timeout_interruptible(1);\r\nif (signal_pending(current))\r\nbreak;\r\n}\r\njif = jiffies + (3 * hertz);\r\nixj_ring_off(j);\r\nwhile (time_before(jiffies, jif)) {\r\nif (ixj_hookstate(j) & 1) {\r\nmsleep(10);\r\nif (ixj_hookstate(j) & 1) {\r\nj->flags.ringing = 0;\r\nreturn 1;\r\n}\r\n}\r\nschedule_timeout_interruptible(1);\r\nif (signal_pending(current))\r\nbreak;\r\n}\r\n}\r\nixj_ring_off(j);\r\nj->flags.ringing = 0;\r\nreturn 0;\r\n}\r\nstatic int ixj_open(struct phone_device *p, struct file *file_p)\r\n{\r\nIXJ *j = get_ixj(p->board);\r\nfile_p->private_data = j;\r\nif (!j->DSPbase)\r\nreturn -ENODEV;\r\nif (file_p->f_mode & FMODE_READ) {\r\nif(!j->readers) {\r\nj->readers++;\r\n} else {\r\nreturn -EBUSY;\r\n}\r\n}\r\nif (file_p->f_mode & FMODE_WRITE) {\r\nif(!j->writers) {\r\nj->writers++;\r\n} else {\r\nif (file_p->f_mode & FMODE_READ){\r\nj->readers--;\r\n}\r\nreturn -EBUSY;\r\n}\r\n}\r\nif (j->cardtype == QTI_PHONECARD) {\r\nj->pslic.bits.powerdown = 0;\r\nj->psccr.bits.dev = 3;\r\nj->psccr.bits.rw = 0;\r\noutw_p(j->psccr.byte << 8 | j->pslic.byte, j->XILINXbase + 0x00);\r\nixj_PCcontrol_wait(j);\r\n}\r\nj->flags.cidplay = 0;\r\nj->flags.cidcw_ack = 0;\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Opening board %d\n", p->board);\r\nj->framesread = j->frameswritten = 0;\r\nreturn 0;\r\n}\r\nstatic int ixj_release(struct inode *inode, struct file *file_p)\r\n{\r\nIXJ_TONE ti;\r\nint cnt;\r\nIXJ *j = file_p->private_data;\r\nint board = j->p.board;\r\nwhile(test_and_set_bit(board, (void *)&j->busyflags) != 0)\r\nschedule_timeout_interruptible(1);\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Closing board %d\n", NUM(inode));\r\nif (j->cardtype == QTI_PHONECARD)\r\nixj_set_port(j, PORT_SPEAKER);\r\nelse\r\nixj_set_port(j, PORT_POTS);\r\naec_stop(j);\r\nixj_play_stop(j);\r\nixj_record_stop(j);\r\nset_play_volume(j, 0x100);\r\nset_rec_volume(j, 0x100);\r\nixj_ring_off(j);\r\nti.tone_index = 10;\r\nti.gain0 = 1;\r\nti.freq0 = hz941;\r\nti.gain1 = 0;\r\nti.freq1 = hz1209;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 11;\r\nti.gain0 = 1;\r\nti.freq0 = hz941;\r\nti.gain1 = 0;\r\nti.freq1 = hz1336;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 12;\r\nti.gain0 = 1;\r\nti.freq0 = hz941;\r\nti.gain1 = 0;\r\nti.freq1 = hz1477;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 13;\r\nti.gain0 = 1;\r\nti.freq0 = hz800;\r\nti.gain1 = 0;\r\nti.freq1 = 0;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 14;\r\nti.gain0 = 1;\r\nti.freq0 = hz1000;\r\nti.gain1 = 0;\r\nti.freq1 = 0;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 15;\r\nti.gain0 = 1;\r\nti.freq0 = hz1250;\r\nti.gain1 = 0;\r\nti.freq1 = 0;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 16;\r\nti.gain0 = 1;\r\nti.freq0 = hz950;\r\nti.gain1 = 0;\r\nti.freq1 = 0;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 17;\r\nti.gain0 = 1;\r\nti.freq0 = hz1100;\r\nti.gain1 = 0;\r\nti.freq1 = 0;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 18;\r\nti.gain0 = 1;\r\nti.freq0 = hz1400;\r\nti.gain1 = 0;\r\nti.freq1 = 0;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 19;\r\nti.gain0 = 1;\r\nti.freq0 = hz1500;\r\nti.gain1 = 0;\r\nti.freq1 = 0;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 20;\r\nti.gain0 = 1;\r\nti.freq0 = hz1600;\r\nti.gain1 = 0;\r\nti.freq1 = 0;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 21;\r\nti.gain0 = 1;\r\nti.freq0 = hz1800;\r\nti.gain1 = 0;\r\nti.freq1 = 0;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 22;\r\nti.gain0 = 1;\r\nti.freq0 = hz2100;\r\nti.gain1 = 0;\r\nti.freq1 = 0;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 23;\r\nti.gain0 = 1;\r\nti.freq0 = hz1300;\r\nti.gain1 = 0;\r\nti.freq1 = 0;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 24;\r\nti.gain0 = 1;\r\nti.freq0 = hz2450;\r\nti.gain1 = 0;\r\nti.freq1 = 0;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 25;\r\nti.gain0 = 1;\r\nti.freq0 = hz350;\r\nti.gain1 = 0;\r\nti.freq1 = hz440;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 26;\r\nti.gain0 = 1;\r\nti.freq0 = hz440;\r\nti.gain1 = 0;\r\nti.freq1 = hz480;\r\nixj_init_tone(j, &ti);\r\nti.tone_index = 27;\r\nti.gain0 = 1;\r\nti.freq0 = hz480;\r\nti.gain1 = 0;\r\nti.freq1 = hz620;\r\nixj_init_tone(j, &ti);\r\nset_rec_depth(j, 2);\r\nset_play_depth(j, 2);\r\nj->ex.bits.dtmf_ready = 0;\r\nj->dtmf_state = 0;\r\nj->dtmf_wp = j->dtmf_rp = 0;\r\nj->rec_mode = j->play_mode = -1;\r\nj->flags.ringing = 0;\r\nj->maxrings = MAXRINGS;\r\nj->ring_cadence = USA_RING_CADENCE;\r\nif(j->cadence_f[5].enable) {\r\nj->cadence_f[5].enable = j->cadence_f[5].en_filter = j->cadence_f[5].state = 0;\r\n}\r\nj->drybuffer = 0;\r\nj->winktime = 320;\r\nj->flags.dtmf_oob = 0;\r\nfor (cnt = 0; cnt < 4; cnt++)\r\nj->cadence_f[cnt].enable = 0;\r\nidle(j);\r\nif(j->cardtype == QTI_PHONECARD) {\r\nSLIC_SetState(PLD_SLIC_STATE_OC, j);\r\n}\r\nif (file_p->f_mode & FMODE_READ)\r\nj->readers--;\r\nif (file_p->f_mode & FMODE_WRITE)\r\nj->writers--;\r\nif (j->read_buffer && !j->readers) {\r\nkfree(j->read_buffer);\r\nj->read_buffer = NULL;\r\nj->read_buffer_size = 0;\r\n}\r\nif (j->write_buffer && !j->writers) {\r\nkfree(j->write_buffer);\r\nj->write_buffer = NULL;\r\nj->write_buffer_size = 0;\r\n}\r\nj->rec_codec = j->play_codec = 0;\r\nj->rec_frame_size = j->play_frame_size = 0;\r\nj->flags.cidsent = j->flags.cidring = 0;\r\nif(j->cardtype == QTI_LINEJACK && !j->readers && !j->writers) {\r\nixj_set_port(j, PORT_PSTN);\r\ndaa_set_mode(j, SOP_PU_SLEEP);\r\nixj_set_pots(j, 1);\r\n}\r\nixj_WriteDSPCommand(0x0FE3, j);\r\nfor (cnt = 0; cnt < 35; cnt++)\r\nj->ixj_signals[cnt] = SIGIO;\r\nj->ex_sig.bits.dtmf_ready = j->ex_sig.bits.hookstate = j->ex_sig.bits.flash = j->ex_sig.bits.pstn_ring =\r\nj->ex_sig.bits.caller_id = j->ex_sig.bits.pstn_wink = j->ex_sig.bits.f0 = j->ex_sig.bits.f1 = j->ex_sig.bits.f2 =\r\nj->ex_sig.bits.f3 = j->ex_sig.bits.fc0 = j->ex_sig.bits.fc1 = j->ex_sig.bits.fc2 = j->ex_sig.bits.fc3 = 1;\r\nfile_p->private_data = NULL;\r\nclear_bit(board, &j->busyflags);\r\nreturn 0;\r\n}\r\nstatic int read_filters(IXJ *j)\r\n{\r\nunsigned short fc, cnt, trg;\r\nint var;\r\ntrg = 0;\r\nif (ixj_WriteDSPCommand(0x5144, j)) {\r\nif(ixjdebug & 0x0001) {\r\nprintk(KERN_INFO "Read Frame Counter failed!\n");\r\n}\r\nreturn -1;\r\n}\r\nfc = j->ssr.high << 8 | j->ssr.low;\r\nif (fc == j->frame_count)\r\nreturn 1;\r\nj->frame_count = fc;\r\nif (j->dtmf_proc)\r\nreturn 1;\r\nvar = 10;\r\nfor (cnt = 0; cnt < 4; cnt++) {\r\nif (ixj_WriteDSPCommand(0x5154 + cnt, j)) {\r\nif(ixjdebug & 0x0001) {\r\nprintk(KERN_INFO "Select Filter %d failed!\n", cnt);\r\n}\r\nreturn -1;\r\n}\r\nif (ixj_WriteDSPCommand(0x515C, j)) {\r\nif(ixjdebug & 0x0001) {\r\nprintk(KERN_INFO "Read Filter History %d failed!\n", cnt);\r\n}\r\nreturn -1;\r\n}\r\nj->filter_hist[cnt] = j->ssr.high << 8 | j->ssr.low;\r\nif (j->cadence_f[cnt].enable) {\r\nif (j->filter_hist[cnt] & 3 && !(j->filter_hist[cnt] & 12)) {\r\nif (j->cadence_f[cnt].state == 0) {\r\nj->cadence_f[cnt].state = 1;\r\nj->cadence_f[cnt].on1min = jiffies + (long)((j->cadence_f[cnt].on1 * (hertz * (100 - var)) / 10000));\r\nj->cadence_f[cnt].on1dot = jiffies + (long)((j->cadence_f[cnt].on1 * (hertz * (100)) / 10000));\r\nj->cadence_f[cnt].on1max = jiffies + (long)((j->cadence_f[cnt].on1 * (hertz * (100 + var)) / 10000));\r\n} else if (j->cadence_f[cnt].state == 2 &&\r\n(time_after(jiffies, j->cadence_f[cnt].off1min) &&\r\ntime_before(jiffies, j->cadence_f[cnt].off1max))) {\r\nif (j->cadence_f[cnt].on2) {\r\nj->cadence_f[cnt].state = 3;\r\nj->cadence_f[cnt].on2min = jiffies + (long)((j->cadence_f[cnt].on2 * (hertz * (100 - var)) / 10000));\r\nj->cadence_f[cnt].on2dot = jiffies + (long)((j->cadence_f[cnt].on2 * (hertz * (100)) / 10000));\r\nj->cadence_f[cnt].on2max = jiffies + (long)((j->cadence_f[cnt].on2 * (hertz * (100 + var)) / 10000));\r\n} else {\r\nj->cadence_f[cnt].state = 7;\r\n}\r\n} else if (j->cadence_f[cnt].state == 4 &&\r\n(time_after(jiffies, j->cadence_f[cnt].off2min) &&\r\ntime_before(jiffies, j->cadence_f[cnt].off2max))) {\r\nif (j->cadence_f[cnt].on3) {\r\nj->cadence_f[cnt].state = 5;\r\nj->cadence_f[cnt].on3min = jiffies + (long)((j->cadence_f[cnt].on3 * (hertz * (100 - var)) / 10000));\r\nj->cadence_f[cnt].on3dot = jiffies + (long)((j->cadence_f[cnt].on3 * (hertz * (100)) / 10000));\r\nj->cadence_f[cnt].on3max = jiffies + (long)((j->cadence_f[cnt].on3 * (hertz * (100 + var)) / 10000));\r\n} else {\r\nj->cadence_f[cnt].state = 7;\r\n}\r\n} else {\r\nj->cadence_f[cnt].state = 0;\r\n}\r\n} else if (j->filter_hist[cnt] & 12 && !(j->filter_hist[cnt] & 3)) {\r\nif (j->cadence_f[cnt].state == 1) {\r\nif(!j->cadence_f[cnt].on1) {\r\nj->cadence_f[cnt].state = 7;\r\n} else if((time_after(jiffies, j->cadence_f[cnt].on1min) &&\r\ntime_before(jiffies, j->cadence_f[cnt].on1max))) {\r\nif(j->cadence_f[cnt].off1) {\r\nj->cadence_f[cnt].state = 2;\r\nj->cadence_f[cnt].off1min = jiffies + (long)((j->cadence_f[cnt].off1 * (hertz * (100 - var)) / 10000));\r\nj->cadence_f[cnt].off1dot = jiffies + (long)((j->cadence_f[cnt].off1 * (hertz * (100)) / 10000));\r\nj->cadence_f[cnt].off1max = jiffies + (long)((j->cadence_f[cnt].off1 * (hertz * (100 + var)) / 10000));\r\n} else {\r\nj->cadence_f[cnt].state = 7;\r\n}\r\n} else {\r\nj->cadence_f[cnt].state = 0;\r\n}\r\n} else if (j->cadence_f[cnt].state == 3) {\r\nif((time_after(jiffies, j->cadence_f[cnt].on2min) &&\r\ntime_before(jiffies, j->cadence_f[cnt].on2max))) {\r\nif(j->cadence_f[cnt].off2) {\r\nj->cadence_f[cnt].state = 4;\r\nj->cadence_f[cnt].off2min = jiffies + (long)((j->cadence_f[cnt].off2 * (hertz * (100 - var)) / 10000));\r\nj->cadence_f[cnt].off2dot = jiffies + (long)((j->cadence_f[cnt].off2 * (hertz * (100)) / 10000));\r\nj->cadence_f[cnt].off2max = jiffies + (long)((j->cadence_f[cnt].off2 * (hertz * (100 + var)) / 10000));\r\n} else {\r\nj->cadence_f[cnt].state = 7;\r\n}\r\n} else {\r\nj->cadence_f[cnt].state = 0;\r\n}\r\n} else if (j->cadence_f[cnt].state == 5) {\r\nif ((time_after(jiffies, j->cadence_f[cnt].on3min) &&\r\ntime_before(jiffies, j->cadence_f[cnt].on3max))) {\r\nif(j->cadence_f[cnt].off3) {\r\nj->cadence_f[cnt].state = 6;\r\nj->cadence_f[cnt].off3min = jiffies + (long)((j->cadence_f[cnt].off3 * (hertz * (100 - var)) / 10000));\r\nj->cadence_f[cnt].off3dot = jiffies + (long)((j->cadence_f[cnt].off3 * (hertz * (100)) / 10000));\r\nj->cadence_f[cnt].off3max = jiffies + (long)((j->cadence_f[cnt].off3 * (hertz * (100 + var)) / 10000));\r\n} else {\r\nj->cadence_f[cnt].state = 7;\r\n}\r\n} else {\r\nj->cadence_f[cnt].state = 0;\r\n}\r\n} else {\r\nj->cadence_f[cnt].state = 0;\r\n}\r\n} else {\r\nswitch(j->cadence_f[cnt].state) {\r\ncase 1:\r\nif(time_after(jiffies, j->cadence_f[cnt].on1dot) &&\r\n!j->cadence_f[cnt].off1 &&\r\n!j->cadence_f[cnt].on2 && !j->cadence_f[cnt].off2 &&\r\n!j->cadence_f[cnt].on3 && !j->cadence_f[cnt].off3) {\r\nj->cadence_f[cnt].state = 7;\r\n}\r\nbreak;\r\ncase 3:\r\nif(time_after(jiffies, j->cadence_f[cnt].on2dot) &&\r\n!j->cadence_f[cnt].off2 &&\r\n!j->cadence_f[cnt].on3 && !j->cadence_f[cnt].off3) {\r\nj->cadence_f[cnt].state = 7;\r\n}\r\nbreak;\r\ncase 5:\r\nif(time_after(jiffies, j->cadence_f[cnt].on3dot) &&\r\n!j->cadence_f[cnt].off3) {\r\nj->cadence_f[cnt].state = 7;\r\n}\r\nbreak;\r\n}\r\n}\r\nif (ixjdebug & 0x0040) {\r\nprintk(KERN_INFO "IXJ Tone Cadence state = %d /dev/phone%d at %ld\n", j->cadence_f[cnt].state, j->board, jiffies);\r\nswitch(j->cadence_f[cnt].state) {\r\ncase 0:\r\nprintk(KERN_INFO "IXJ /dev/phone%d No Tone detected\n", j->board);\r\nbreak;\r\ncase 1:\r\nprintk(KERN_INFO "IXJ /dev/phone%d Next Tone Cadence state at %u %ld - %ld - %ld\n", j->board,\r\nj->cadence_f[cnt].on1, j->cadence_f[cnt].on1min, j->cadence_f[cnt].on1dot, j->cadence_f[cnt].on1max);\r\nbreak;\r\ncase 2:\r\nprintk(KERN_INFO "IXJ /dev/phone%d Next Tone Cadence state at %ld - %ld\n", j->board, j->cadence_f[cnt].off1min,\r\nj->cadence_f[cnt].off1max);\r\nbreak;\r\ncase 3:\r\nprintk(KERN_INFO "IXJ /dev/phone%d Next Tone Cadence state at %ld - %ld\n", j->board, j->cadence_f[cnt].on2min,\r\nj->cadence_f[cnt].on2max);\r\nbreak;\r\ncase 4:\r\nprintk(KERN_INFO "IXJ /dev/phone%d Next Tone Cadence state at %ld - %ld\n", j->board, j->cadence_f[cnt].off2min,\r\nj->cadence_f[cnt].off2max);\r\nbreak;\r\ncase 5:\r\nprintk(KERN_INFO "IXJ /dev/phone%d Next Tone Cadence state at %ld - %ld\n", j->board, j->cadence_f[cnt].on3min,\r\nj->cadence_f[cnt].on3max);\r\nbreak;\r\ncase 6:\r\nprintk(KERN_INFO "IXJ /dev/phone%d Next Tone Cadence state at %ld - %ld\n", j->board, j->cadence_f[cnt].off3min,\r\nj->cadence_f[cnt].off3max);\r\nbreak;\r\n}\r\n}\r\n}\r\nif (j->cadence_f[cnt].state == 7) {\r\nj->cadence_f[cnt].state = 0;\r\nif (j->cadence_f[cnt].enable == 1)\r\nj->cadence_f[cnt].enable = 0;\r\nswitch (cnt) {\r\ncase 0:\r\nif(ixjdebug & 0x0020) {\r\nprintk(KERN_INFO "Filter Cadence 0 triggered %ld\n", jiffies);\r\n}\r\nj->ex.bits.fc0 = 1;\r\nixj_kill_fasync(j, SIG_FC0, POLL_IN);\r\nbreak;\r\ncase 1:\r\nif(ixjdebug & 0x0020) {\r\nprintk(KERN_INFO "Filter Cadence 1 triggered %ld\n", jiffies);\r\n}\r\nj->ex.bits.fc1 = 1;\r\nixj_kill_fasync(j, SIG_FC1, POLL_IN);\r\nbreak;\r\ncase 2:\r\nif(ixjdebug & 0x0020) {\r\nprintk(KERN_INFO "Filter Cadence 2 triggered %ld\n", jiffies);\r\n}\r\nj->ex.bits.fc2 = 1;\r\nixj_kill_fasync(j, SIG_FC2, POLL_IN);\r\nbreak;\r\ncase 3:\r\nif(ixjdebug & 0x0020) {\r\nprintk(KERN_INFO "Filter Cadence 3 triggered %ld\n", jiffies);\r\n}\r\nj->ex.bits.fc3 = 1;\r\nixj_kill_fasync(j, SIG_FC3, POLL_IN);\r\nbreak;\r\n}\r\n}\r\nif (j->filter_en[cnt] && ((j->filter_hist[cnt] & 3 && !(j->filter_hist[cnt] & 12)) ||\r\n(j->filter_hist[cnt] & 12 && !(j->filter_hist[cnt] & 3)))) {\r\nif((j->filter_hist[cnt] & 3 && !(j->filter_hist[cnt] & 12))) {\r\ntrg = 1;\r\n} else if((j->filter_hist[cnt] & 12 && !(j->filter_hist[cnt] & 3))) {\r\ntrg = 0;\r\n}\r\nswitch (cnt) {\r\ncase 0:\r\nif(ixjdebug & 0x0020) {\r\nprintk(KERN_INFO "Filter 0 triggered %d at %ld\n", trg, jiffies);\r\n}\r\nj->ex.bits.f0 = 1;\r\nixj_kill_fasync(j, SIG_F0, POLL_IN);\r\nbreak;\r\ncase 1:\r\nif(ixjdebug & 0x0020) {\r\nprintk(KERN_INFO "Filter 1 triggered %d at %ld\n", trg, jiffies);\r\n}\r\nj->ex.bits.f1 = 1;\r\nixj_kill_fasync(j, SIG_F1, POLL_IN);\r\nbreak;\r\ncase 2:\r\nif(ixjdebug & 0x0020) {\r\nprintk(KERN_INFO "Filter 2 triggered %d at %ld\n", trg, jiffies);\r\n}\r\nj->ex.bits.f2 = 1;\r\nixj_kill_fasync(j, SIG_F2, POLL_IN);\r\nbreak;\r\ncase 3:\r\nif(ixjdebug & 0x0020) {\r\nprintk(KERN_INFO "Filter 3 triggered %d at %ld\n", trg, jiffies);\r\n}\r\nj->ex.bits.f3 = 1;\r\nixj_kill_fasync(j, SIG_F3, POLL_IN);\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int LineMonitor(IXJ *j)\r\n{\r\nif (j->dtmf_proc) {\r\nreturn -1;\r\n}\r\nj->dtmf_proc = 1;\r\nif (ixj_WriteDSPCommand(0x7000, j))\r\nreturn -1;\r\nj->dtmf.bytes.high = j->ssr.high;\r\nj->dtmf.bytes.low = j->ssr.low;\r\nif (!j->dtmf_state && j->dtmf.bits.dtmf_valid) {\r\nj->dtmf_state = 1;\r\nj->dtmf_current = j->dtmf.bits.digit;\r\n}\r\nif (j->dtmf_state && !j->dtmf.bits.dtmf_valid)\r\n{\r\nif(!j->cidcw_wait) {\r\nj->dtmfbuffer[j->dtmf_wp] = j->dtmf_current;\r\nj->dtmf_wp++;\r\nif (j->dtmf_wp == 79)\r\nj->dtmf_wp = 0;\r\nj->ex.bits.dtmf_ready = 1;\r\nif(j->ex_sig.bits.dtmf_ready) {\r\nixj_kill_fasync(j, SIG_DTMF_READY, POLL_IN);\r\n}\r\n}\r\nelse if(j->dtmf_current == 0x00 || j->dtmf_current == 0x0D) {\r\nif(ixjdebug & 0x0020) {\r\nprintk("IXJ phone%d saw CIDCW Ack DTMF %d from display at %ld\n", j->board, j->dtmf_current, jiffies);\r\n}\r\nj->flags.cidcw_ack = 1;\r\n}\r\nj->dtmf_state = 0;\r\n}\r\nj->dtmf_proc = 0;\r\nreturn 0;\r\n}\r\nstatic void ulaw2alaw(unsigned char *buff, unsigned long len)\r\n{\r\nstatic unsigned char table_ulaw2alaw[] =\r\n{\r\n0x2A, 0x2B, 0x28, 0x29, 0x2E, 0x2F, 0x2C, 0x2D,\r\n0x22, 0x23, 0x20, 0x21, 0x26, 0x27, 0x24, 0x25,\r\n0x3A, 0x3B, 0x38, 0x39, 0x3E, 0x3F, 0x3C, 0x3D,\r\n0x32, 0x33, 0x30, 0x31, 0x36, 0x37, 0x34, 0x35,\r\n0x0B, 0x08, 0x09, 0x0E, 0x0F, 0x0C, 0x0D, 0x02,\r\n0x03, 0x00, 0x01, 0x06, 0x07, 0x04, 0x05, 0x1A,\r\n0x1B, 0x18, 0x19, 0x1E, 0x1F, 0x1C, 0x1D, 0x12,\r\n0x13, 0x10, 0x11, 0x16, 0x17, 0x14, 0x15, 0x6B,\r\n0x68, 0x69, 0x6E, 0x6F, 0x6C, 0x6D, 0x62, 0x63,\r\n0x60, 0x61, 0x66, 0x67, 0x64, 0x65, 0x7B, 0x79,\r\n0x7E, 0x7F, 0x7C, 0x7D, 0x72, 0x73, 0x70, 0x71,\r\n0x76, 0x77, 0x74, 0x75, 0x4B, 0x49, 0x4F, 0x4D,\r\n0x42, 0x43, 0x40, 0x41, 0x46, 0x47, 0x44, 0x45,\r\n0x5A, 0x5B, 0x58, 0x59, 0x5E, 0x5F, 0x5C, 0x5D,\r\n0x52, 0x52, 0x53, 0x53, 0x50, 0x50, 0x51, 0x51,\r\n0x56, 0x56, 0x57, 0x57, 0x54, 0x54, 0x55, 0xD5,\r\n0xAA, 0xAB, 0xA8, 0xA9, 0xAE, 0xAF, 0xAC, 0xAD,\r\n0xA2, 0xA3, 0xA0, 0xA1, 0xA6, 0xA7, 0xA4, 0xA5,\r\n0xBA, 0xBB, 0xB8, 0xB9, 0xBE, 0xBF, 0xBC, 0xBD,\r\n0xB2, 0xB3, 0xB0, 0xB1, 0xB6, 0xB7, 0xB4, 0xB5,\r\n0x8B, 0x88, 0x89, 0x8E, 0x8F, 0x8C, 0x8D, 0x82,\r\n0x83, 0x80, 0x81, 0x86, 0x87, 0x84, 0x85, 0x9A,\r\n0x9B, 0x98, 0x99, 0x9E, 0x9F, 0x9C, 0x9D, 0x92,\r\n0x93, 0x90, 0x91, 0x96, 0x97, 0x94, 0x95, 0xEB,\r\n0xE8, 0xE9, 0xEE, 0xEF, 0xEC, 0xED, 0xE2, 0xE3,\r\n0xE0, 0xE1, 0xE6, 0xE7, 0xE4, 0xE5, 0xFB, 0xF9,\r\n0xFE, 0xFF, 0xFC, 0xFD, 0xF2, 0xF3, 0xF0, 0xF1,\r\n0xF6, 0xF7, 0xF4, 0xF5, 0xCB, 0xC9, 0xCF, 0xCD,\r\n0xC2, 0xC3, 0xC0, 0xC1, 0xC6, 0xC7, 0xC4, 0xC5,\r\n0xDA, 0xDB, 0xD8, 0xD9, 0xDE, 0xDF, 0xDC, 0xDD,\r\n0xD2, 0xD2, 0xD3, 0xD3, 0xD0, 0xD0, 0xD1, 0xD1,\r\n0xD6, 0xD6, 0xD7, 0xD7, 0xD4, 0xD4, 0xD5, 0xD5\r\n};\r\nwhile (len--)\r\n{\r\n*buff = table_ulaw2alaw[*(unsigned char *)buff];\r\nbuff++;\r\n}\r\n}\r\nstatic void alaw2ulaw(unsigned char *buff, unsigned long len)\r\n{\r\nstatic unsigned char table_alaw2ulaw[] =\r\n{\r\n0x29, 0x2A, 0x27, 0x28, 0x2D, 0x2E, 0x2B, 0x2C,\r\n0x21, 0x22, 0x1F, 0x20, 0x25, 0x26, 0x23, 0x24,\r\n0x39, 0x3A, 0x37, 0x38, 0x3D, 0x3E, 0x3B, 0x3C,\r\n0x31, 0x32, 0x2F, 0x30, 0x35, 0x36, 0x33, 0x34,\r\n0x0A, 0x0B, 0x08, 0x09, 0x0E, 0x0F, 0x0C, 0x0D,\r\n0x02, 0x03, 0x00, 0x01, 0x06, 0x07, 0x04, 0x05,\r\n0x1A, 0x1B, 0x18, 0x19, 0x1E, 0x1F, 0x1C, 0x1D,\r\n0x12, 0x13, 0x10, 0x11, 0x16, 0x17, 0x14, 0x15,\r\n0x62, 0x63, 0x60, 0x61, 0x66, 0x67, 0x64, 0x65,\r\n0x5D, 0x5D, 0x5C, 0x5C, 0x5F, 0x5F, 0x5E, 0x5E,\r\n0x74, 0x76, 0x70, 0x72, 0x7C, 0x7E, 0x78, 0x7A,\r\n0x6A, 0x6B, 0x68, 0x69, 0x6E, 0x6F, 0x6C, 0x6D,\r\n0x48, 0x49, 0x46, 0x47, 0x4C, 0x4D, 0x4A, 0x4B,\r\n0x40, 0x41, 0x3F, 0x3F, 0x44, 0x45, 0x42, 0x43,\r\n0x56, 0x57, 0x54, 0x55, 0x5A, 0x5B, 0x58, 0x59,\r\n0x4F, 0x4F, 0x4E, 0x4E, 0x52, 0x53, 0x50, 0x51,\r\n0xA9, 0xAA, 0xA7, 0xA8, 0xAD, 0xAE, 0xAB, 0xAC,\r\n0xA1, 0xA2, 0x9F, 0xA0, 0xA5, 0xA6, 0xA3, 0xA4,\r\n0xB9, 0xBA, 0xB7, 0xB8, 0xBD, 0xBE, 0xBB, 0xBC,\r\n0xB1, 0xB2, 0xAF, 0xB0, 0xB5, 0xB6, 0xB3, 0xB4,\r\n0x8A, 0x8B, 0x88, 0x89, 0x8E, 0x8F, 0x8C, 0x8D,\r\n0x82, 0x83, 0x80, 0x81, 0x86, 0x87, 0x84, 0x85,\r\n0x9A, 0x9B, 0x98, 0x99, 0x9E, 0x9F, 0x9C, 0x9D,\r\n0x92, 0x93, 0x90, 0x91, 0x96, 0x97, 0x94, 0x95,\r\n0xE2, 0xE3, 0xE0, 0xE1, 0xE6, 0xE7, 0xE4, 0xE5,\r\n0xDD, 0xDD, 0xDC, 0xDC, 0xDF, 0xDF, 0xDE, 0xDE,\r\n0xF4, 0xF6, 0xF0, 0xF2, 0xFC, 0xFE, 0xF8, 0xFA,\r\n0xEA, 0xEB, 0xE8, 0xE9, 0xEE, 0xEF, 0xEC, 0xED,\r\n0xC8, 0xC9, 0xC6, 0xC7, 0xCC, 0xCD, 0xCA, 0xCB,\r\n0xC0, 0xC1, 0xBF, 0xBF, 0xC4, 0xC5, 0xC2, 0xC3,\r\n0xD6, 0xD7, 0xD4, 0xD5, 0xDA, 0xDB, 0xD8, 0xD9,\r\n0xCF, 0xCF, 0xCE, 0xCE, 0xD2, 0xD3, 0xD0, 0xD1\r\n};\r\nwhile (len--)\r\n{\r\n*buff = table_alaw2ulaw[*(unsigned char *)buff];\r\nbuff++;\r\n}\r\n}\r\nstatic ssize_t ixj_read(struct file * file_p, char __user *buf, size_t length, loff_t * ppos)\r\n{\r\nunsigned long i = *ppos;\r\nIXJ * j = get_ixj(NUM(file_p->f_path.dentry->d_inode));\r\nDECLARE_WAITQUEUE(wait, current);\r\nif (j->flags.inread)\r\nreturn -EALREADY;\r\nj->flags.inread = 1;\r\nadd_wait_queue(&j->read_q, &wait);\r\nset_current_state(TASK_INTERRUPTIBLE);\r\nmb();\r\nwhile (!j->read_buffer_ready || (j->dtmf_state && j->flags.dtmf_oob)) {\r\n++j->read_wait;\r\nif (file_p->f_flags & O_NONBLOCK) {\r\nset_current_state(TASK_RUNNING);\r\nremove_wait_queue(&j->read_q, &wait);\r\nj->flags.inread = 0;\r\nreturn -EAGAIN;\r\n}\r\nif (!ixj_hookstate(j)) {\r\nset_current_state(TASK_RUNNING);\r\nremove_wait_queue(&j->read_q, &wait);\r\nj->flags.inread = 0;\r\nreturn 0;\r\n}\r\ninterruptible_sleep_on(&j->read_q);\r\nif (signal_pending(current)) {\r\nset_current_state(TASK_RUNNING);\r\nremove_wait_queue(&j->read_q, &wait);\r\nj->flags.inread = 0;\r\nreturn -EINTR;\r\n}\r\n}\r\nremove_wait_queue(&j->read_q, &wait);\r\nset_current_state(TASK_RUNNING);\r\nif(j->rec_codec == ALAW)\r\nulaw2alaw(j->read_buffer, min(length, j->read_buffer_size));\r\ni = copy_to_user(buf, j->read_buffer, min(length, j->read_buffer_size));\r\nj->read_buffer_ready = 0;\r\nif (i) {\r\nj->flags.inread = 0;\r\nreturn -EFAULT;\r\n} else {\r\nj->flags.inread = 0;\r\nreturn min(length, j->read_buffer_size);\r\n}\r\n}\r\nstatic ssize_t ixj_enhanced_read(struct file * file_p, char __user *buf, size_t length,\r\nloff_t * ppos)\r\n{\r\nint pre_retval;\r\nssize_t read_retval = 0;\r\nIXJ *j = get_ixj(NUM(file_p->f_path.dentry->d_inode));\r\npre_retval = ixj_PreRead(j, 0L);\r\nswitch (pre_retval) {\r\ncase NORMAL:\r\nread_retval = ixj_read(file_p, buf, length, ppos);\r\nixj_PostRead(j, 0L);\r\nbreak;\r\ncase NOPOST:\r\nread_retval = ixj_read(file_p, buf, length, ppos);\r\nbreak;\r\ncase POSTONLY:\r\nixj_PostRead(j, 0L);\r\nbreak;\r\ndefault:\r\nread_retval = pre_retval;\r\n}\r\nreturn read_retval;\r\n}\r\nstatic ssize_t ixj_write(struct file *file_p, const char __user *buf, size_t count, loff_t * ppos)\r\n{\r\nunsigned long i = *ppos;\r\nIXJ *j = file_p->private_data;\r\nDECLARE_WAITQUEUE(wait, current);\r\nif (j->flags.inwrite)\r\nreturn -EALREADY;\r\nj->flags.inwrite = 1;\r\nadd_wait_queue(&j->write_q, &wait);\r\nset_current_state(TASK_INTERRUPTIBLE);\r\nmb();\r\nwhile (!j->write_buffers_empty) {\r\n++j->write_wait;\r\nif (file_p->f_flags & O_NONBLOCK) {\r\nset_current_state(TASK_RUNNING);\r\nremove_wait_queue(&j->write_q, &wait);\r\nj->flags.inwrite = 0;\r\nreturn -EAGAIN;\r\n}\r\nif (!ixj_hookstate(j)) {\r\nset_current_state(TASK_RUNNING);\r\nremove_wait_queue(&j->write_q, &wait);\r\nj->flags.inwrite = 0;\r\nreturn 0;\r\n}\r\ninterruptible_sleep_on(&j->write_q);\r\nif (signal_pending(current)) {\r\nset_current_state(TASK_RUNNING);\r\nremove_wait_queue(&j->write_q, &wait);\r\nj->flags.inwrite = 0;\r\nreturn -EINTR;\r\n}\r\n}\r\nset_current_state(TASK_RUNNING);\r\nremove_wait_queue(&j->write_q, &wait);\r\nif (j->write_buffer_wp + count >= j->write_buffer_end)\r\nj->write_buffer_wp = j->write_buffer;\r\ni = copy_from_user(j->write_buffer_wp, buf, min(count, j->write_buffer_size));\r\nif (i) {\r\nj->flags.inwrite = 0;\r\nreturn -EFAULT;\r\n}\r\nif(j->play_codec == ALAW)\r\nalaw2ulaw(j->write_buffer_wp, min(count, j->write_buffer_size));\r\nj->flags.inwrite = 0;\r\nreturn min(count, j->write_buffer_size);\r\n}\r\nstatic ssize_t ixj_enhanced_write(struct file * file_p, const char __user *buf, size_t count, loff_t * ppos)\r\n{\r\nint pre_retval;\r\nssize_t write_retval = 0;\r\nIXJ *j = get_ixj(NUM(file_p->f_path.dentry->d_inode));\r\npre_retval = ixj_PreWrite(j, 0L);\r\nswitch (pre_retval) {\r\ncase NORMAL:\r\nwrite_retval = ixj_write(file_p, buf, count, ppos);\r\nif (write_retval > 0) {\r\nixj_PostWrite(j, 0L);\r\nj->write_buffer_wp += write_retval;\r\nj->write_buffers_empty--;\r\n}\r\nbreak;\r\ncase NOPOST:\r\nwrite_retval = ixj_write(file_p, buf, count, ppos);\r\nif (write_retval > 0) {\r\nj->write_buffer_wp += write_retval;\r\nj->write_buffers_empty--;\r\n}\r\nbreak;\r\ncase POSTONLY:\r\nixj_PostWrite(j, 0L);\r\nbreak;\r\ndefault:\r\nwrite_retval = pre_retval;\r\n}\r\nreturn write_retval;\r\n}\r\nstatic void ixj_read_frame(IXJ *j)\r\n{\r\nint cnt, dly;\r\nif (j->read_buffer) {\r\nfor (cnt = 0; cnt < j->rec_frame_size * 2; cnt += 2) {\r\nif (!(cnt % 16) && !IsRxReady(j)) {\r\ndly = 0;\r\nwhile (!IsRxReady(j)) {\r\nif (dly++ > 5) {\r\ndly = 0;\r\nbreak;\r\n}\r\nudelay(10);\r\n}\r\n}\r\nif (j->rec_codec == G729 && (cnt == 0 || cnt == 10 || cnt == 20)) {\r\ninb_p(j->DSPbase + 0x0E);\r\ninb_p(j->DSPbase + 0x0F);\r\n}\r\n*(j->read_buffer + cnt) = inb_p(j->DSPbase + 0x0E);\r\n*(j->read_buffer + cnt + 1) = inb_p(j->DSPbase + 0x0F);\r\n}\r\n++j->framesread;\r\nif (j->intercom != -1) {\r\nif (IsTxReady(get_ixj(j->intercom))) {\r\nfor (cnt = 0; cnt < j->rec_frame_size * 2; cnt += 2) {\r\nif (!(cnt % 16) && !IsTxReady(j)) {\r\ndly = 0;\r\nwhile (!IsTxReady(j)) {\r\nif (dly++ > 5) {\r\ndly = 0;\r\nbreak;\r\n}\r\nudelay(10);\r\n}\r\n}\r\noutb_p(*(j->read_buffer + cnt), get_ixj(j->intercom)->DSPbase + 0x0C);\r\noutb_p(*(j->read_buffer + cnt + 1), get_ixj(j->intercom)->DSPbase + 0x0D);\r\n}\r\nget_ixj(j->intercom)->frameswritten++;\r\n}\r\n} else {\r\nj->read_buffer_ready = 1;\r\nwake_up_interruptible(&j->read_q);\r\nwake_up_interruptible(&j->poll_q);\r\nif(j->ixj_signals[SIG_READ_READY])\r\nixj_kill_fasync(j, SIG_READ_READY, POLL_OUT);\r\n}\r\n}\r\n}\r\nstatic void ixj_write_cid_bit(IXJ *j, int bit)\r\n{\r\nwhile (j->fskcnt < 20) {\r\nif(j->fskdcnt < (j->fsksize - 1))\r\nj->fskdata[j->fskdcnt++] = fsk[bit][j->fskz][j->fskcnt];\r\nj->fskcnt += 3;\r\n}\r\nj->fskcnt %= 20;\r\nif (!bit)\r\nj->fskz++;\r\nif (j->fskz >= 6)\r\nj->fskz = 0;\r\n}\r\nstatic void ixj_write_cid_byte(IXJ *j, char byte)\r\n{\r\nIXJ_CBYTE cb;\r\ncb.cbyte = byte;\r\nixj_write_cid_bit(j, 0);\r\nixj_write_cid_bit(j, cb.cbits.b0 ? 1 : 0);\r\nixj_write_cid_bit(j, cb.cbits.b1 ? 1 : 0);\r\nixj_write_cid_bit(j, cb.cbits.b2 ? 1 : 0);\r\nixj_write_cid_bit(j, cb.cbits.b3 ? 1 : 0);\r\nixj_write_cid_bit(j, cb.cbits.b4 ? 1 : 0);\r\nixj_write_cid_bit(j, cb.cbits.b5 ? 1 : 0);\r\nixj_write_cid_bit(j, cb.cbits.b6 ? 1 : 0);\r\nixj_write_cid_bit(j, cb.cbits.b7 ? 1 : 0);\r\nixj_write_cid_bit(j, 1);\r\n}\r\nstatic void ixj_write_cid_seize(IXJ *j)\r\n{\r\nint cnt;\r\nfor (cnt = 0; cnt < 150; cnt++) {\r\nixj_write_cid_bit(j, 0);\r\nixj_write_cid_bit(j, 1);\r\n}\r\nfor (cnt = 0; cnt < 180; cnt++) {\r\nixj_write_cid_bit(j, 1);\r\n}\r\n}\r\nstatic void ixj_write_cidcw_seize(IXJ *j)\r\n{\r\nint cnt;\r\nfor (cnt = 0; cnt < 80; cnt++) {\r\nixj_write_cid_bit(j, 1);\r\n}\r\n}\r\nstatic int ixj_write_cid_string(IXJ *j, char *s, int checksum)\r\n{\r\nint cnt;\r\nfor (cnt = 0; cnt < strlen(s); cnt++) {\r\nixj_write_cid_byte(j, s[cnt]);\r\nchecksum = (checksum + s[cnt]);\r\n}\r\nreturn checksum;\r\n}\r\nstatic void ixj_pad_fsk(IXJ *j, int pad)\r\n{\r\nint cnt;\r\nfor (cnt = 0; cnt < pad; cnt++) {\r\nif(j->fskdcnt < (j->fsksize - 1))\r\nj->fskdata[j->fskdcnt++] = 0x0000;\r\n}\r\nfor (cnt = 0; cnt < 720; cnt++) {\r\nif(j->fskdcnt < (j->fsksize - 1))\r\nj->fskdata[j->fskdcnt++] = 0x0000;\r\n}\r\n}\r\nstatic void ixj_pre_cid(IXJ *j)\r\n{\r\nj->cid_play_codec = j->play_codec;\r\nj->cid_play_frame_size = j->play_frame_size;\r\nj->cid_play_volume = get_play_volume(j);\r\nj->cid_play_flag = j->flags.playing;\r\nj->cid_rec_codec = j->rec_codec;\r\nj->cid_rec_volume = get_rec_volume(j);\r\nj->cid_rec_flag = j->flags.recording;\r\nj->cid_play_aec_level = j->aec_level;\r\nswitch(j->baseframe.low) {\r\ncase 0xA0:\r\nj->cid_base_frame_size = 20;\r\nbreak;\r\ncase 0x50:\r\nj->cid_base_frame_size = 10;\r\nbreak;\r\ncase 0xF0:\r\nj->cid_base_frame_size = 30;\r\nbreak;\r\n}\r\nixj_play_stop(j);\r\nixj_cpt_stop(j);\r\nj->flags.cidplay = 1;\r\nset_base_frame(j, 30);\r\nset_play_codec(j, LINEAR16);\r\nset_play_volume(j, 0x1B);\r\nixj_play_start(j);\r\n}\r\nstatic void ixj_post_cid(IXJ *j)\r\n{\r\nixj_play_stop(j);\r\nif(j->cidsize > 5000) {\r\nSLIC_SetState(PLD_SLIC_STATE_STANDBY, j);\r\n}\r\nj->flags.cidplay = 0;\r\nif(ixjdebug & 0x0200) {\r\nprintk("IXJ phone%d Finished Playing CallerID data %ld\n", j->board, jiffies);\r\n}\r\nixj_fsk_free(j);\r\nj->fskdcnt = 0;\r\nset_base_frame(j, j->cid_base_frame_size);\r\nset_play_codec(j, j->cid_play_codec);\r\nixj_aec_start(j, j->cid_play_aec_level);\r\nset_play_volume(j, j->cid_play_volume);\r\nset_rec_codec(j, j->cid_rec_codec);\r\nset_rec_volume(j, j->cid_rec_volume);\r\nif(j->cid_rec_flag)\r\nixj_record_start(j);\r\nif(j->cid_play_flag)\r\nixj_play_start(j);\r\nif(j->cid_play_flag) {\r\nwake_up_interruptible(&j->write_q);\r\n}\r\n}\r\nstatic void ixj_write_cid(IXJ *j)\r\n{\r\nchar sdmf1[50];\r\nchar sdmf2[50];\r\nchar sdmf3[80];\r\nchar mdmflen, len1, len2, len3;\r\nint pad;\r\nint checksum = 0;\r\nif (j->dsp.low == 0x20 || j->flags.cidplay)\r\nreturn;\r\nj->fskz = j->fskphase = j->fskcnt = j->fskdcnt = 0;\r\nj->cidsize = j->cidcnt = 0;\r\nixj_fsk_alloc(j);\r\nstrcpy(sdmf1, j->cid_send.month);\r\nstrcat(sdmf1, j->cid_send.day);\r\nstrcat(sdmf1, j->cid_send.hour);\r\nstrcat(sdmf1, j->cid_send.min);\r\nstrcpy(sdmf2, j->cid_send.number);\r\nstrcpy(sdmf3, j->cid_send.name);\r\nlen1 = strlen(sdmf1);\r\nlen2 = strlen(sdmf2);\r\nlen3 = strlen(sdmf3);\r\nmdmflen = len1 + len2 + len3 + 6;\r\nwhile(1){\r\nixj_write_cid_seize(j);\r\nixj_write_cid_byte(j, 0x80);\r\nchecksum = 0x80;\r\nixj_write_cid_byte(j, mdmflen);\r\nchecksum = checksum + mdmflen;\r\nixj_write_cid_byte(j, 0x01);\r\nchecksum = checksum + 0x01;\r\nixj_write_cid_byte(j, len1);\r\nchecksum = checksum + len1;\r\nchecksum = ixj_write_cid_string(j, sdmf1, checksum);\r\nif(ixj_hookstate(j) & 1)\r\nbreak;\r\nixj_write_cid_byte(j, 0x02);\r\nchecksum = checksum + 0x02;\r\nixj_write_cid_byte(j, len2);\r\nchecksum = checksum + len2;\r\nchecksum = ixj_write_cid_string(j, sdmf2, checksum);\r\nif(ixj_hookstate(j) & 1)\r\nbreak;\r\nixj_write_cid_byte(j, 0x07);\r\nchecksum = checksum + 0x07;\r\nixj_write_cid_byte(j, len3);\r\nchecksum = checksum + len3;\r\nchecksum = ixj_write_cid_string(j, sdmf3, checksum);\r\nif(ixj_hookstate(j) & 1)\r\nbreak;\r\nchecksum %= 256;\r\nchecksum ^= 0xFF;\r\nchecksum += 1;\r\nixj_write_cid_byte(j, (char) checksum);\r\npad = j->fskdcnt % 240;\r\nif (pad) {\r\npad = 240 - pad;\r\n}\r\nixj_pad_fsk(j, pad);\r\nbreak;\r\n}\r\nixj_write_frame(j);\r\n}\r\nstatic void ixj_write_cidcw(IXJ *j)\r\n{\r\nIXJ_TONE ti;\r\nchar sdmf1[50];\r\nchar sdmf2[50];\r\nchar sdmf3[80];\r\nchar mdmflen, len1, len2, len3;\r\nint pad;\r\nint checksum = 0;\r\nif (j->dsp.low == 0x20 || j->flags.cidplay)\r\nreturn;\r\nj->fskz = j->fskphase = j->fskcnt = j->fskdcnt = 0;\r\nj->cidsize = j->cidcnt = 0;\r\nixj_fsk_alloc(j);\r\nj->flags.cidcw_ack = 0;\r\nti.tone_index = 23;\r\nti.gain0 = 1;\r\nti.freq0 = hz440;\r\nti.gain1 = 0;\r\nti.freq1 = 0;\r\nixj_init_tone(j, &ti);\r\nixj_set_tone_on(1500, j);\r\nixj_set_tone_off(32, j);\r\nif(ixjdebug & 0x0200) {\r\nprintk("IXJ cidcw phone%d first tone start at %ld\n", j->board, jiffies);\r\n}\r\nixj_play_tone(j, 23);\r\nclear_bit(j->board, &j->busyflags);\r\nwhile(j->tone_state)\r\nschedule_timeout_interruptible(1);\r\nwhile(test_and_set_bit(j->board, (void *)&j->busyflags) != 0)\r\nschedule_timeout_interruptible(1);\r\nif(ixjdebug & 0x0200) {\r\nprintk("IXJ cidcw phone%d first tone end at %ld\n", j->board, jiffies);\r\n}\r\nti.tone_index = 24;\r\nti.gain0 = 1;\r\nti.freq0 = hz2130;\r\nti.gain1 = 0;\r\nti.freq1 = hz2750;\r\nixj_init_tone(j, &ti);\r\nixj_set_tone_off(10, j);\r\nixj_set_tone_on(600, j);\r\nif(ixjdebug & 0x0200) {\r\nprintk("IXJ cidcw phone%d second tone start at %ld\n", j->board, jiffies);\r\n}\r\nixj_play_tone(j, 24);\r\nclear_bit(j->board, &j->busyflags);\r\nwhile(j->tone_state)\r\nschedule_timeout_interruptible(1);\r\nwhile(test_and_set_bit(j->board, (void *)&j->busyflags) != 0)\r\nschedule_timeout_interruptible(1);\r\nif(ixjdebug & 0x0200) {\r\nprintk("IXJ cidcw phone%d sent second tone at %ld\n", j->board, jiffies);\r\n}\r\nj->cidcw_wait = jiffies + ((50 * hertz) / 100);\r\nclear_bit(j->board, &j->busyflags);\r\nwhile(!j->flags.cidcw_ack && time_before(jiffies, j->cidcw_wait))\r\nschedule_timeout_interruptible(1);\r\nwhile(test_and_set_bit(j->board, (void *)&j->busyflags) != 0)\r\nschedule_timeout_interruptible(1);\r\nj->cidcw_wait = 0;\r\nif(!j->flags.cidcw_ack) {\r\nif(ixjdebug & 0x0200) {\r\nprintk("IXJ cidcw phone%d did not receive ACK from display %ld\n", j->board, jiffies);\r\n}\r\nixj_post_cid(j);\r\nif(j->cid_play_flag) {\r\nwake_up_interruptible(&j->write_q);\r\n}\r\nreturn;\r\n} else {\r\nixj_pre_cid(j);\r\n}\r\nj->flags.cidcw_ack = 0;\r\nstrcpy(sdmf1, j->cid_send.month);\r\nstrcat(sdmf1, j->cid_send.day);\r\nstrcat(sdmf1, j->cid_send.hour);\r\nstrcat(sdmf1, j->cid_send.min);\r\nstrcpy(sdmf2, j->cid_send.number);\r\nstrcpy(sdmf3, j->cid_send.name);\r\nlen1 = strlen(sdmf1);\r\nlen2 = strlen(sdmf2);\r\nlen3 = strlen(sdmf3);\r\nmdmflen = len1 + len2 + len3 + 6;\r\nixj_write_cidcw_seize(j);\r\nixj_write_cid_byte(j, 0x80);\r\nchecksum = 0x80;\r\nixj_write_cid_byte(j, mdmflen);\r\nchecksum = checksum + mdmflen;\r\nixj_write_cid_byte(j, 0x01);\r\nchecksum = checksum + 0x01;\r\nixj_write_cid_byte(j, len1);\r\nchecksum = checksum + len1;\r\nchecksum = ixj_write_cid_string(j, sdmf1, checksum);\r\nixj_write_cid_byte(j, 0x02);\r\nchecksum = checksum + 0x02;\r\nixj_write_cid_byte(j, len2);\r\nchecksum = checksum + len2;\r\nchecksum = ixj_write_cid_string(j, sdmf2, checksum);\r\nixj_write_cid_byte(j, 0x07);\r\nchecksum = checksum + 0x07;\r\nixj_write_cid_byte(j, len3);\r\nchecksum = checksum + len3;\r\nchecksum = ixj_write_cid_string(j, sdmf3, checksum);\r\nchecksum %= 256;\r\nchecksum ^= 0xFF;\r\nchecksum += 1;\r\nixj_write_cid_byte(j, (char) checksum);\r\npad = j->fskdcnt % 240;\r\nif (pad) {\r\npad = 240 - pad;\r\n}\r\nixj_pad_fsk(j, pad);\r\nif(ixjdebug & 0x0200) {\r\nprintk("IXJ cidcw phone%d sent FSK data at %ld\n", j->board, jiffies);\r\n}\r\n}\r\nstatic void ixj_write_vmwi(IXJ *j, int msg)\r\n{\r\nchar mdmflen;\r\nint pad;\r\nint checksum = 0;\r\nif (j->dsp.low == 0x20 || j->flags.cidplay)\r\nreturn;\r\nj->fskz = j->fskphase = j->fskcnt = j->fskdcnt = 0;\r\nj->cidsize = j->cidcnt = 0;\r\nixj_fsk_alloc(j);\r\nmdmflen = 3;\r\nif (j->port == PORT_POTS)\r\nSLIC_SetState(PLD_SLIC_STATE_OHT, j);\r\nixj_write_cid_seize(j);\r\nixj_write_cid_byte(j, 0x82);\r\nchecksum = 0x82;\r\nixj_write_cid_byte(j, mdmflen);\r\nchecksum = checksum + mdmflen;\r\nixj_write_cid_byte(j, 0x0B);\r\nchecksum = checksum + 0x0B;\r\nixj_write_cid_byte(j, 1);\r\nchecksum = checksum + 1;\r\nif(msg) {\r\nixj_write_cid_byte(j, 0xFF);\r\nchecksum = checksum + 0xFF;\r\n}\r\nelse {\r\nixj_write_cid_byte(j, 0x00);\r\nchecksum = checksum + 0x00;\r\n}\r\nchecksum %= 256;\r\nchecksum ^= 0xFF;\r\nchecksum += 1;\r\nixj_write_cid_byte(j, (char) checksum);\r\npad = j->fskdcnt % 240;\r\nif (pad) {\r\npad = 240 - pad;\r\n}\r\nixj_pad_fsk(j, pad);\r\n}\r\nstatic void ixj_write_frame(IXJ *j)\r\n{\r\nint cnt, frame_count, dly;\r\nIXJ_WORD dat;\r\nframe_count = 0;\r\nif(j->flags.cidplay) {\r\nfor(cnt = 0; cnt < 480; cnt++) {\r\nif (!(cnt % 16) && !IsTxReady(j)) {\r\ndly = 0;\r\nwhile (!IsTxReady(j)) {\r\nif (dly++ > 5) {\r\ndly = 0;\r\nbreak;\r\n}\r\nudelay(10);\r\n}\r\n}\r\ndat.word = j->fskdata[j->cidcnt++];\r\noutb_p(dat.bytes.low, j->DSPbase + 0x0C);\r\noutb_p(dat.bytes.high, j->DSPbase + 0x0D);\r\ncnt++;\r\n}\r\nif(j->cidcnt >= j->fskdcnt) {\r\nixj_post_cid(j);\r\n}\r\nif (j->write_buffer_rp > j->write_buffer_wp) {\r\nj->write_buffer_rp += j->cid_play_frame_size * 2;\r\nif (j->write_buffer_rp >= j->write_buffer_end) {\r\nj->write_buffer_rp = j->write_buffer;\r\n}\r\nj->write_buffers_empty++;\r\nwake_up_interruptible(&j->write_q);\r\nwake_up_interruptible(&j->poll_q);\r\n}\r\n} else if (j->write_buffer && j->write_buffers_empty < 1) {\r\nif (j->write_buffer_wp > j->write_buffer_rp) {\r\nframe_count =\r\n(j->write_buffer_wp - j->write_buffer_rp) / (j->play_frame_size * 2);\r\n}\r\nif (j->write_buffer_rp > j->write_buffer_wp) {\r\nframe_count =\r\n(j->write_buffer_wp - j->write_buffer) / (j->play_frame_size * 2) +\r\n(j->write_buffer_end - j->write_buffer_rp) / (j->play_frame_size * 2);\r\n}\r\nif (frame_count >= 1) {\r\nif (j->ver.low == 0x12 && j->play_mode && j->flags.play_first_frame) {\r\nBYTES blankword;\r\nswitch (j->play_mode) {\r\ncase PLAYBACK_MODE_ULAW:\r\ncase PLAYBACK_MODE_ALAW:\r\nblankword.low = blankword.high = 0xFF;\r\nbreak;\r\ncase PLAYBACK_MODE_8LINEAR:\r\ncase PLAYBACK_MODE_16LINEAR:\r\ndefault:\r\nblankword.low = blankword.high = 0x00;\r\nbreak;\r\ncase PLAYBACK_MODE_8LINEAR_WSS:\r\nblankword.low = blankword.high = 0x80;\r\nbreak;\r\n}\r\nfor (cnt = 0; cnt < 16; cnt++) {\r\nif (!(cnt % 16) && !IsTxReady(j)) {\r\ndly = 0;\r\nwhile (!IsTxReady(j)) {\r\nif (dly++ > 5) {\r\ndly = 0;\r\nbreak;\r\n}\r\nudelay(10);\r\n}\r\n}\r\noutb_p((blankword.low), j->DSPbase + 0x0C);\r\noutb_p((blankword.high), j->DSPbase + 0x0D);\r\n}\r\nj->flags.play_first_frame = 0;\r\n} else if (j->play_codec == G723_63 && j->flags.play_first_frame) {\r\nfor (cnt = 0; cnt < 24; cnt++) {\r\nBYTES blankword;\r\nif(cnt == 12) {\r\nblankword.low = 0x02;\r\nblankword.high = 0x00;\r\n}\r\nelse {\r\nblankword.low = blankword.high = 0x00;\r\n}\r\nif (!(cnt % 16) && !IsTxReady(j)) {\r\ndly = 0;\r\nwhile (!IsTxReady(j)) {\r\nif (dly++ > 5) {\r\ndly = 0;\r\nbreak;\r\n}\r\nudelay(10);\r\n}\r\n}\r\noutb_p((blankword.low), j->DSPbase + 0x0C);\r\noutb_p((blankword.high), j->DSPbase + 0x0D);\r\n}\r\nj->flags.play_first_frame = 0;\r\n}\r\nfor (cnt = 0; cnt < j->play_frame_size * 2; cnt += 2) {\r\nif (!(cnt % 16) && !IsTxReady(j)) {\r\ndly = 0;\r\nwhile (!IsTxReady(j)) {\r\nif (dly++ > 5) {\r\ndly = 0;\r\nbreak;\r\n}\r\nudelay(10);\r\n}\r\n}\r\nif (j->play_codec == G729 && (cnt == 0 || cnt == 10 || cnt == 20)) {\r\nif (j->write_buffer_rp[cnt] == 0 &&\r\nj->write_buffer_rp[cnt + 1] == 0 &&\r\nj->write_buffer_rp[cnt + 2] == 0 &&\r\nj->write_buffer_rp[cnt + 3] == 0 &&\r\nj->write_buffer_rp[cnt + 4] == 0 &&\r\nj->write_buffer_rp[cnt + 5] == 0 &&\r\nj->write_buffer_rp[cnt + 6] == 0 &&\r\nj->write_buffer_rp[cnt + 7] == 0 &&\r\nj->write_buffer_rp[cnt + 8] == 0 &&\r\nj->write_buffer_rp[cnt + 9] == 0) {\r\noutb_p(0x00, j->DSPbase + 0x0C);\r\noutb_p(0x00, j->DSPbase + 0x0D);\r\n} else {\r\noutb_p(0x01, j->DSPbase + 0x0C);\r\noutb_p(0x00, j->DSPbase + 0x0D);\r\n}\r\n}\r\noutb_p(*(j->write_buffer_rp + cnt), j->DSPbase + 0x0C);\r\noutb_p(*(j->write_buffer_rp + cnt + 1), j->DSPbase + 0x0D);\r\n*(j->write_buffer_rp + cnt) = 0;\r\n*(j->write_buffer_rp + cnt + 1) = 0;\r\n}\r\nj->write_buffer_rp += j->play_frame_size * 2;\r\nif (j->write_buffer_rp >= j->write_buffer_end) {\r\nj->write_buffer_rp = j->write_buffer;\r\n}\r\nj->write_buffers_empty++;\r\nwake_up_interruptible(&j->write_q);\r\nwake_up_interruptible(&j->poll_q);\r\n++j->frameswritten;\r\n}\r\n} else {\r\nj->drybuffer++;\r\n}\r\nif(j->ixj_signals[SIG_WRITE_READY]) {\r\nixj_kill_fasync(j, SIG_WRITE_READY, POLL_OUT);\r\n}\r\n}\r\nstatic int idle(IXJ *j)\r\n{\r\nif (ixj_WriteDSPCommand(0x0000, j))\r\nreturn 0;\r\nif (j->ssr.high || j->ssr.low) {\r\nreturn 0;\r\n} else {\r\nj->play_mode = -1;\r\nj->flags.playing = 0;\r\nj->rec_mode = -1;\r\nj->flags.recording = 0;\r\nreturn 1;\r\n}\r\n}\r\nstatic int set_base_frame(IXJ *j, int size)\r\n{\r\nunsigned short cmd;\r\nint cnt;\r\nidle(j);\r\nj->cid_play_aec_level = j->aec_level;\r\naec_stop(j);\r\nfor (cnt = 0; cnt < 10; cnt++) {\r\nif (idle(j))\r\nbreak;\r\n}\r\nif (j->ssr.high || j->ssr.low)\r\nreturn -1;\r\nif (j->dsp.low != 0x20) {\r\nswitch (size) {\r\ncase 30:\r\ncmd = 0x07F0;\r\nbreak;\r\ncase 20:\r\ncmd = 0x07A0;\r\nbreak;\r\ncase 10:\r\ncmd = 0x0750;\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\n} else {\r\nif (size == 30)\r\nreturn size;\r\nelse\r\nreturn -1;\r\n}\r\nif (ixj_WriteDSPCommand(cmd, j)) {\r\nj->baseframe.high = j->baseframe.low = 0xFF;\r\nreturn -1;\r\n} else {\r\nj->baseframe.high = j->ssr.high;\r\nj->baseframe.low = j->ssr.low;\r\nif(j->baseframe.high == 0x00 && j->baseframe.low == 0x00) {\r\nreturn -1;\r\n}\r\n}\r\nixj_aec_start(j, j->cid_play_aec_level);\r\nreturn size;\r\n}\r\nstatic int set_rec_codec(IXJ *j, int rate)\r\n{\r\nint retval = 0;\r\nj->rec_codec = rate;\r\nswitch (rate) {\r\ncase G723_63:\r\nif (j->ver.low != 0x12 || ixj_convert_loaded) {\r\nj->rec_frame_size = 12;\r\nj->rec_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase G723_53:\r\nif (j->ver.low != 0x12 || ixj_convert_loaded) {\r\nj->rec_frame_size = 10;\r\nj->rec_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase TS85:\r\nif (j->dsp.low == 0x20 || j->flags.ts85_loaded) {\r\nj->rec_frame_size = 16;\r\nj->rec_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase TS48:\r\nif (j->ver.low != 0x12 || ixj_convert_loaded) {\r\nj->rec_frame_size = 9;\r\nj->rec_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase TS41:\r\nif (j->ver.low != 0x12 || ixj_convert_loaded) {\r\nj->rec_frame_size = 8;\r\nj->rec_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase G728:\r\nif (j->dsp.low != 0x20) {\r\nj->rec_frame_size = 48;\r\nj->rec_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase G729:\r\nif (j->dsp.low != 0x20) {\r\nif (!j->flags.g729_loaded) {\r\nretval = 1;\r\nbreak;\r\n}\r\nswitch (j->baseframe.low) {\r\ncase 0xA0:\r\nj->rec_frame_size = 10;\r\nbreak;\r\ncase 0x50:\r\nj->rec_frame_size = 5;\r\nbreak;\r\ndefault:\r\nj->rec_frame_size = 15;\r\nbreak;\r\n}\r\nj->rec_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase G729B:\r\nif (j->dsp.low != 0x20) {\r\nif (!j->flags.g729_loaded) {\r\nretval = 1;\r\nbreak;\r\n}\r\nswitch (j->baseframe.low) {\r\ncase 0xA0:\r\nj->rec_frame_size = 12;\r\nbreak;\r\ncase 0x50:\r\nj->rec_frame_size = 6;\r\nbreak;\r\ndefault:\r\nj->rec_frame_size = 18;\r\nbreak;\r\n}\r\nj->rec_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase ULAW:\r\nswitch (j->baseframe.low) {\r\ncase 0xA0:\r\nj->rec_frame_size = 80;\r\nbreak;\r\ncase 0x50:\r\nj->rec_frame_size = 40;\r\nbreak;\r\ndefault:\r\nj->rec_frame_size = 120;\r\nbreak;\r\n}\r\nj->rec_mode = 4;\r\nbreak;\r\ncase ALAW:\r\nswitch (j->baseframe.low) {\r\ncase 0xA0:\r\nj->rec_frame_size = 80;\r\nbreak;\r\ncase 0x50:\r\nj->rec_frame_size = 40;\r\nbreak;\r\ndefault:\r\nj->rec_frame_size = 120;\r\nbreak;\r\n}\r\nj->rec_mode = 4;\r\nbreak;\r\ncase LINEAR16:\r\nswitch (j->baseframe.low) {\r\ncase 0xA0:\r\nj->rec_frame_size = 160;\r\nbreak;\r\ncase 0x50:\r\nj->rec_frame_size = 80;\r\nbreak;\r\ndefault:\r\nj->rec_frame_size = 240;\r\nbreak;\r\n}\r\nj->rec_mode = 5;\r\nbreak;\r\ncase LINEAR8:\r\nswitch (j->baseframe.low) {\r\ncase 0xA0:\r\nj->rec_frame_size = 80;\r\nbreak;\r\ncase 0x50:\r\nj->rec_frame_size = 40;\r\nbreak;\r\ndefault:\r\nj->rec_frame_size = 120;\r\nbreak;\r\n}\r\nj->rec_mode = 6;\r\nbreak;\r\ncase WSS:\r\nswitch (j->baseframe.low) {\r\ncase 0xA0:\r\nj->rec_frame_size = 80;\r\nbreak;\r\ncase 0x50:\r\nj->rec_frame_size = 40;\r\nbreak;\r\ndefault:\r\nj->rec_frame_size = 120;\r\nbreak;\r\n}\r\nj->rec_mode = 7;\r\nbreak;\r\ndefault:\r\nkfree(j->read_buffer);\r\nj->rec_frame_size = 0;\r\nj->rec_mode = -1;\r\nj->read_buffer = NULL;\r\nj->read_buffer_size = 0;\r\nretval = 1;\r\nbreak;\r\n}\r\nreturn retval;\r\n}\r\nstatic int ixj_record_start(IXJ *j)\r\n{\r\nunsigned short cmd = 0x0000;\r\nif (j->read_buffer) {\r\nixj_record_stop(j);\r\n}\r\nj->flags.recording = 1;\r\nixj_WriteDSPCommand(0x0FE0, j);\r\nif(ixjdebug & 0x0002)\r\nprintk("IXJ %d Starting Record Codec %d at %ld\n", j->board, j->rec_codec, jiffies);\r\nif (!j->rec_mode) {\r\nswitch (j->rec_codec) {\r\ncase G723_63:\r\ncmd = 0x5131;\r\nbreak;\r\ncase G723_53:\r\ncmd = 0x5132;\r\nbreak;\r\ncase TS85:\r\ncmd = 0x5130;\r\nbreak;\r\ncase TS48:\r\ncmd = 0x5133;\r\nbreak;\r\ncase TS41:\r\ncmd = 0x5134;\r\nbreak;\r\ncase G728:\r\ncmd = 0x5135;\r\nbreak;\r\ncase G729:\r\ncase G729B:\r\ncmd = 0x5136;\r\nbreak;\r\ndefault:\r\nreturn 1;\r\n}\r\nif (ixj_WriteDSPCommand(cmd, j))\r\nreturn -1;\r\n}\r\nif (!j->read_buffer) {\r\nif (!j->read_buffer)\r\nj->read_buffer = kmalloc(j->rec_frame_size * 2, GFP_ATOMIC);\r\nif (!j->read_buffer) {\r\nprintk("Read buffer allocation for ixj board %d failed!\n", j->board);\r\nreturn -ENOMEM;\r\n}\r\n}\r\nj->read_buffer_size = j->rec_frame_size * 2;\r\nif (ixj_WriteDSPCommand(0x5102, j))\r\nreturn -1;\r\nswitch (j->rec_mode) {\r\ncase 0:\r\ncmd = 0x1C03;\r\nbreak;\r\ncase 4:\r\nif (j->ver.low == 0x12) {\r\ncmd = 0x1E03;\r\n} else {\r\ncmd = 0x1E01;\r\n}\r\nbreak;\r\ncase 5:\r\nif (j->ver.low == 0x12) {\r\ncmd = 0x1E83;\r\n} else {\r\ncmd = 0x1E81;\r\n}\r\nbreak;\r\ncase 6:\r\nif (j->ver.low == 0x12) {\r\ncmd = 0x1F03;\r\n} else {\r\ncmd = 0x1F01;\r\n}\r\nbreak;\r\ncase 7:\r\nif (j->ver.low == 0x12) {\r\ncmd = 0x1F83;\r\n} else {\r\ncmd = 0x1F81;\r\n}\r\nbreak;\r\n}\r\nif (ixj_WriteDSPCommand(cmd, j))\r\nreturn -1;\r\nif (j->flags.playing) {\r\nixj_aec_start(j, j->aec_level);\r\n}\r\nreturn 0;\r\n}\r\nstatic void ixj_record_stop(IXJ *j)\r\n{\r\nif (ixjdebug & 0x0002)\r\nprintk("IXJ %d Stopping Record Codec %d at %ld\n", j->board, j->rec_codec, jiffies);\r\nkfree(j->read_buffer);\r\nj->read_buffer = NULL;\r\nj->read_buffer_size = 0;\r\nif (j->rec_mode > -1) {\r\nixj_WriteDSPCommand(0x5120, j);\r\nj->rec_mode = -1;\r\n}\r\nj->flags.recording = 0;\r\n}\r\nstatic void ixj_vad(IXJ *j, int arg)\r\n{\r\nif (arg)\r\nixj_WriteDSPCommand(0x513F, j);\r\nelse\r\nixj_WriteDSPCommand(0x513E, j);\r\n}\r\nstatic void set_rec_depth(IXJ *j, int depth)\r\n{\r\nif (depth > 60)\r\ndepth = 60;\r\nif (depth < 0)\r\ndepth = 0;\r\nixj_WriteDSPCommand(0x5180 + depth, j);\r\n}\r\nstatic void set_dtmf_prescale(IXJ *j, int volume)\r\n{\r\nixj_WriteDSPCommand(0xCF07, j);\r\nixj_WriteDSPCommand(volume, j);\r\n}\r\nstatic int get_dtmf_prescale(IXJ *j)\r\n{\r\nixj_WriteDSPCommand(0xCF05, j);\r\nreturn j->ssr.high << 8 | j->ssr.low;\r\n}\r\nstatic void set_rec_volume(IXJ *j, int volume)\r\n{\r\nif(j->aec_level == AEC_AGC) {\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "IXJ: /dev/phone%d Setting AGC Threshold to 0x%4.4x\n", j->board, volume);\r\nixj_WriteDSPCommand(0xCF96, j);\r\nixj_WriteDSPCommand(volume, j);\r\n} else {\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "IXJ: /dev/phone %d Setting Record Volume to 0x%4.4x\n", j->board, volume);\r\nixj_WriteDSPCommand(0xCF03, j);\r\nixj_WriteDSPCommand(volume, j);\r\n}\r\n}\r\nstatic int set_rec_volume_linear(IXJ *j, int volume)\r\n{\r\nint newvolume, dsprecmax;\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "IXJ: /dev/phone %d Setting Linear Record Volume to 0x%4.4x\n", j->board, volume);\r\nif(volume > 100 || volume < 0) {\r\nreturn -1;\r\n}\r\nswitch (j->cardtype) {\r\ncase QTI_PHONEJACK:\r\ndsprecmax = 0x440;\r\nbreak;\r\ncase QTI_LINEJACK:\r\ndsprecmax = 0x180;\r\nixj_mixer(0x0203, j);\r\nixj_mixer(0x0303, j);\r\nixj_mixer(0x0C00, j);\r\nbreak;\r\ncase QTI_PHONEJACK_LITE:\r\ndsprecmax = 0x4C0;\r\nbreak;\r\ncase QTI_PHONEJACK_PCI:\r\ndsprecmax = 0x100;\r\nbreak;\r\ncase QTI_PHONECARD:\r\ndsprecmax = 0x400;\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nnewvolume = (dsprecmax * volume) / 100;\r\nset_rec_volume(j, newvolume);\r\nreturn 0;\r\n}\r\nstatic int get_rec_volume(IXJ *j)\r\n{\r\nif(j->aec_level == AEC_AGC) {\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Getting AGC Threshold\n");\r\nixj_WriteDSPCommand(0xCF86, j);\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "AGC Threshold is 0x%2.2x%2.2x\n", j->ssr.high, j->ssr.low);\r\nreturn j->ssr.high << 8 | j->ssr.low;\r\n} else {\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Getting Record Volume\n");\r\nixj_WriteDSPCommand(0xCF01, j);\r\nreturn j->ssr.high << 8 | j->ssr.low;\r\n}\r\n}\r\nstatic int get_rec_volume_linear(IXJ *j)\r\n{\r\nint volume, newvolume, dsprecmax;\r\nswitch (j->cardtype) {\r\ncase QTI_PHONEJACK:\r\ndsprecmax = 0x440;\r\nbreak;\r\ncase QTI_LINEJACK:\r\ndsprecmax = 0x180;\r\nbreak;\r\ncase QTI_PHONEJACK_LITE:\r\ndsprecmax = 0x4C0;\r\nbreak;\r\ncase QTI_PHONEJACK_PCI:\r\ndsprecmax = 0x100;\r\nbreak;\r\ncase QTI_PHONECARD:\r\ndsprecmax = 0x400;\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nvolume = get_rec_volume(j);\r\nnewvolume = (volume * 100) / dsprecmax;\r\nif(newvolume > 100)\r\nnewvolume = 100;\r\nreturn newvolume;\r\n}\r\nstatic int get_rec_level(IXJ *j)\r\n{\r\nint retval;\r\nixj_WriteDSPCommand(0xCF88, j);\r\nretval = j->ssr.high << 8 | j->ssr.low;\r\nretval = (retval * 256) / 240;\r\nreturn retval;\r\n}\r\nstatic void ixj_aec_start(IXJ *j, int level)\r\n{\r\nj->aec_level = level;\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "AGC set = 0x%2.2x\n", j->aec_level);\r\nif (!level) {\r\naec_stop(j);\r\n} else {\r\nif (j->rec_codec == G729 || j->play_codec == G729 || j->rec_codec == G729B || j->play_codec == G729B) {\r\nixj_WriteDSPCommand(0xE022, j);\r\nixj_WriteDSPCommand(0x0300, j);\r\n}\r\nixj_WriteDSPCommand(0xB001, j);\r\nixj_WriteDSPCommand(0xE013, j);\r\nswitch (level) {\r\ncase AEC_LOW:\r\nixj_WriteDSPCommand(0x0000, j);\r\nixj_WriteDSPCommand(0xE011, j);\r\nixj_WriteDSPCommand(0xFFFF, j);\r\nixj_WriteDSPCommand(0xCF97, j);\r\nixj_WriteDSPCommand(0x0000, j);\r\nbreak;\r\ncase AEC_MED:\r\nixj_WriteDSPCommand(0x0600, j);\r\nixj_WriteDSPCommand(0xE011, j);\r\nixj_WriteDSPCommand(0x0080, j);\r\nixj_WriteDSPCommand(0xCF97, j);\r\nixj_WriteDSPCommand(0x0000, j);\r\nbreak;\r\ncase AEC_HIGH:\r\nixj_WriteDSPCommand(0x0C00, j);\r\nixj_WriteDSPCommand(0xE011, j);\r\nixj_WriteDSPCommand(0x0080, j);\r\nixj_WriteDSPCommand(0xCF97, j);\r\nixj_WriteDSPCommand(0x0000, j);\r\nbreak;\r\ncase AEC_AGC:\r\nixj_WriteDSPCommand(0x0002, j);\r\nixj_WriteDSPCommand(0xE011, j);\r\nixj_WriteDSPCommand(0x0100, j);\r\nixj_WriteDSPCommand(0xE012, j);\r\nif(j->cardtype == QTI_LINEJACK || j->cardtype == QTI_PHONECARD)\r\nixj_WriteDSPCommand(0x0224, j);\r\nelse\r\nixj_WriteDSPCommand(0x1224, j);\r\nixj_WriteDSPCommand(0xE014, j);\r\nixj_WriteDSPCommand(0x0003, j);\r\nixj_WriteDSPCommand(0xE338, j);\r\nixj_WriteDSPCommand(0xCF90, j);\r\nixj_WriteDSPCommand(0x0020, j);\r\nixj_WriteDSPCommand(0xCF91, j);\r\nixj_WriteDSPCommand(0x1000, j);\r\nixj_WriteDSPCommand(0xCF92, j);\r\nixj_WriteDSPCommand(0x0800, j);\r\nixj_WriteDSPCommand(0xCF93, j);\r\nixj_WriteDSPCommand(0x1F40, j);\r\nixj_WriteDSPCommand(0xCF94, j);\r\nixj_WriteDSPCommand(0x0005, j);\r\nixj_WriteDSPCommand(0xCF95, j);\r\nixj_WriteDSPCommand(0x000D, j);\r\nixj_WriteDSPCommand(0xCF96, j);\r\nixj_WriteDSPCommand(0x1200, j);\r\nixj_WriteDSPCommand(0xCF97, j);\r\nixj_WriteDSPCommand(0x0001, j);\r\nbreak;\r\ncase AEC_AUTO:\r\nixj_WriteDSPCommand(0x0002, j);\r\nixj_WriteDSPCommand(0xE011, j);\r\nixj_WriteDSPCommand(0x0100, j);\r\nixj_WriteDSPCommand(0xE012, j);\r\nif(j->cardtype == QTI_LINEJACK || j->cardtype == QTI_PHONECARD)\r\nixj_WriteDSPCommand(0x0224, j);\r\nelse\r\nixj_WriteDSPCommand(0x1224, j);\r\nixj_WriteDSPCommand(0xE014, j);\r\nixj_WriteDSPCommand(0x0003, j);\r\nixj_WriteDSPCommand(0xE338, j);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void aec_stop(IXJ *j)\r\n{\r\nj->aec_level = AEC_OFF;\r\nif (j->rec_codec == G729 || j->play_codec == G729 || j->rec_codec == G729B || j->play_codec == G729B) {\r\nixj_WriteDSPCommand(0xE022, j);\r\nixj_WriteDSPCommand(0x0700, j);\r\n}\r\nif (j->play_mode != -1 && j->rec_mode != -1)\r\n{\r\nixj_WriteDSPCommand(0xB002, j);\r\n}\r\n}\r\nstatic int set_play_codec(IXJ *j, int rate)\r\n{\r\nint retval = 0;\r\nj->play_codec = rate;\r\nswitch (rate) {\r\ncase G723_63:\r\nif (j->ver.low != 0x12 || ixj_convert_loaded) {\r\nj->play_frame_size = 12;\r\nj->play_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase G723_53:\r\nif (j->ver.low != 0x12 || ixj_convert_loaded) {\r\nj->play_frame_size = 10;\r\nj->play_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase TS85:\r\nif (j->dsp.low == 0x20 || j->flags.ts85_loaded) {\r\nj->play_frame_size = 16;\r\nj->play_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase TS48:\r\nif (j->ver.low != 0x12 || ixj_convert_loaded) {\r\nj->play_frame_size = 9;\r\nj->play_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase TS41:\r\nif (j->ver.low != 0x12 || ixj_convert_loaded) {\r\nj->play_frame_size = 8;\r\nj->play_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase G728:\r\nif (j->dsp.low != 0x20) {\r\nj->play_frame_size = 48;\r\nj->play_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase G729:\r\nif (j->dsp.low != 0x20) {\r\nif (!j->flags.g729_loaded) {\r\nretval = 1;\r\nbreak;\r\n}\r\nswitch (j->baseframe.low) {\r\ncase 0xA0:\r\nj->play_frame_size = 10;\r\nbreak;\r\ncase 0x50:\r\nj->play_frame_size = 5;\r\nbreak;\r\ndefault:\r\nj->play_frame_size = 15;\r\nbreak;\r\n}\r\nj->play_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase G729B:\r\nif (j->dsp.low != 0x20) {\r\nif (!j->flags.g729_loaded) {\r\nretval = 1;\r\nbreak;\r\n}\r\nswitch (j->baseframe.low) {\r\ncase 0xA0:\r\nj->play_frame_size = 12;\r\nbreak;\r\ncase 0x50:\r\nj->play_frame_size = 6;\r\nbreak;\r\ndefault:\r\nj->play_frame_size = 18;\r\nbreak;\r\n}\r\nj->play_mode = 0;\r\n} else {\r\nretval = 1;\r\n}\r\nbreak;\r\ncase ULAW:\r\nswitch (j->baseframe.low) {\r\ncase 0xA0:\r\nj->play_frame_size = 80;\r\nbreak;\r\ncase 0x50:\r\nj->play_frame_size = 40;\r\nbreak;\r\ndefault:\r\nj->play_frame_size = 120;\r\nbreak;\r\n}\r\nj->play_mode = 2;\r\nbreak;\r\ncase ALAW:\r\nswitch (j->baseframe.low) {\r\ncase 0xA0:\r\nj->play_frame_size = 80;\r\nbreak;\r\ncase 0x50:\r\nj->play_frame_size = 40;\r\nbreak;\r\ndefault:\r\nj->play_frame_size = 120;\r\nbreak;\r\n}\r\nj->play_mode = 2;\r\nbreak;\r\ncase LINEAR16:\r\nswitch (j->baseframe.low) {\r\ncase 0xA0:\r\nj->play_frame_size = 160;\r\nbreak;\r\ncase 0x50:\r\nj->play_frame_size = 80;\r\nbreak;\r\ndefault:\r\nj->play_frame_size = 240;\r\nbreak;\r\n}\r\nj->play_mode = 6;\r\nbreak;\r\ncase LINEAR8:\r\nswitch (j->baseframe.low) {\r\ncase 0xA0:\r\nj->play_frame_size = 80;\r\nbreak;\r\ncase 0x50:\r\nj->play_frame_size = 40;\r\nbreak;\r\ndefault:\r\nj->play_frame_size = 120;\r\nbreak;\r\n}\r\nj->play_mode = 4;\r\nbreak;\r\ncase WSS:\r\nswitch (j->baseframe.low) {\r\ncase 0xA0:\r\nj->play_frame_size = 80;\r\nbreak;\r\ncase 0x50:\r\nj->play_frame_size = 40;\r\nbreak;\r\ndefault:\r\nj->play_frame_size = 120;\r\nbreak;\r\n}\r\nj->play_mode = 5;\r\nbreak;\r\ndefault:\r\nkfree(j->write_buffer);\r\nj->play_frame_size = 0;\r\nj->play_mode = -1;\r\nj->write_buffer = NULL;\r\nj->write_buffer_size = 0;\r\nretval = 1;\r\nbreak;\r\n}\r\nreturn retval;\r\n}\r\nstatic int ixj_play_start(IXJ *j)\r\n{\r\nunsigned short cmd = 0x0000;\r\nif (j->write_buffer) {\r\nixj_play_stop(j);\r\n}\r\nif(ixjdebug & 0x0002)\r\nprintk("IXJ %d Starting Play Codec %d at %ld\n", j->board, j->play_codec, jiffies);\r\nj->flags.playing = 1;\r\nixj_WriteDSPCommand(0x0FE0, j);\r\nj->flags.play_first_frame = 1;\r\nj->drybuffer = 0;\r\nif (!j->play_mode) {\r\nswitch (j->play_codec) {\r\ncase G723_63:\r\ncmd = 0x5231;\r\nbreak;\r\ncase G723_53:\r\ncmd = 0x5232;\r\nbreak;\r\ncase TS85:\r\ncmd = 0x5230;\r\nbreak;\r\ncase TS48:\r\ncmd = 0x5233;\r\nbreak;\r\ncase TS41:\r\ncmd = 0x5234;\r\nbreak;\r\ncase G728:\r\ncmd = 0x5235;\r\nbreak;\r\ncase G729:\r\ncase G729B:\r\ncmd = 0x5236;\r\nbreak;\r\ndefault:\r\nreturn 1;\r\n}\r\nif (ixj_WriteDSPCommand(cmd, j))\r\nreturn -1;\r\n}\r\nj->write_buffer = kmalloc(j->play_frame_size * 2, GFP_ATOMIC);\r\nif (!j->write_buffer) {\r\nprintk("Write buffer allocation for ixj board %d failed!\n", j->board);\r\nreturn -ENOMEM;\r\n}\r\nj->write_buffers_empty = 1;\r\nj->write_buffer_size = j->play_frame_size * 2;\r\nj->write_buffer_end = j->write_buffer + j->play_frame_size * 2;\r\nj->write_buffer_rp = j->write_buffer_wp = j->write_buffer;\r\nif (ixj_WriteDSPCommand(0x5202, j))\r\nreturn -1;\r\nswitch (j->play_mode) {\r\ncase 0:\r\ncmd = 0x2C03;\r\nbreak;\r\ncase 2:\r\nif (j->ver.low == 0x12) {\r\ncmd = 0x2C23;\r\n} else {\r\ncmd = 0x2C21;\r\n}\r\nbreak;\r\ncase 4:\r\nif (j->ver.low == 0x12) {\r\ncmd = 0x2C43;\r\n} else {\r\ncmd = 0x2C41;\r\n}\r\nbreak;\r\ncase 5:\r\nif (j->ver.low == 0x12) {\r\ncmd = 0x2C53;\r\n} else {\r\ncmd = 0x2C51;\r\n}\r\nbreak;\r\ncase 6:\r\nif (j->ver.low == 0x12) {\r\ncmd = 0x2C63;\r\n} else {\r\ncmd = 0x2C61;\r\n}\r\nbreak;\r\n}\r\nif (ixj_WriteDSPCommand(cmd, j))\r\nreturn -1;\r\nif (ixj_WriteDSPCommand(0x2000, j))\r\nreturn -1;\r\nif (ixj_WriteDSPCommand(0x2000 + j->play_frame_size, j))\r\nreturn -1;\r\nif (j->flags.recording) {\r\nixj_aec_start(j, j->aec_level);\r\n}\r\nreturn 0;\r\n}\r\nstatic void ixj_play_stop(IXJ *j)\r\n{\r\nif (ixjdebug & 0x0002)\r\nprintk("IXJ %d Stopping Play Codec %d at %ld\n", j->board, j->play_codec, jiffies);\r\nkfree(j->write_buffer);\r\nj->write_buffer = NULL;\r\nj->write_buffer_size = 0;\r\nif (j->play_mode > -1) {\r\nixj_WriteDSPCommand(0x5221, j);\r\nj->play_mode = -1;\r\n}\r\nj->flags.playing = 0;\r\n}\r\nstatic inline int get_play_level(IXJ *j)\r\n{\r\nint retval;\r\nixj_WriteDSPCommand(0xCF8F, j);\r\nreturn j->ssr.high << 8 | j->ssr.low;\r\nretval = j->ssr.high << 8 | j->ssr.low;\r\nretval = (retval * 256) / 240;\r\nreturn retval;\r\n}\r\nstatic unsigned int ixj_poll(struct file *file_p, poll_table * wait)\r\n{\r\nunsigned int mask = 0;\r\nIXJ *j = get_ixj(NUM(file_p->f_path.dentry->d_inode));\r\npoll_wait(file_p, &(j->poll_q), wait);\r\nif (j->read_buffer_ready > 0)\r\nmask |= POLLIN | POLLRDNORM;\r\nif (j->write_buffers_empty > 0)\r\nmask |= POLLOUT | POLLWRNORM;\r\nif (j->ex.bytes)\r\nmask |= POLLPRI;\r\nreturn mask;\r\n}\r\nstatic int ixj_play_tone(IXJ *j, char tone)\r\n{\r\nif (!j->tone_state) {\r\nif(ixjdebug & 0x0002) {\r\nprintk("IXJ %d starting tone %d at %ld\n", j->board, tone, jiffies);\r\n}\r\nif (j->dsp.low == 0x20) {\r\nidle(j);\r\n}\r\nj->tone_start_jif = jiffies;\r\nj->tone_state = 1;\r\n}\r\nj->tone_index = tone;\r\nif (ixj_WriteDSPCommand(0x6000 + j->tone_index, j))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int ixj_set_tone_on(unsigned short arg, IXJ *j)\r\n{\r\nj->tone_on_time = arg;\r\nif (ixj_WriteDSPCommand(0x6E04, j))\r\nreturn -1;\r\nif (ixj_WriteDSPCommand(arg, j))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int SCI_WaitHighSCI(IXJ *j)\r\n{\r\nint cnt;\r\nj->pld_scrr.byte = inb_p(j->XILINXbase);\r\nif (!j->pld_scrr.bits.sci) {\r\nfor (cnt = 0; cnt < 10; cnt++) {\r\nudelay(32);\r\nj->pld_scrr.byte = inb_p(j->XILINXbase);\r\nif ((j->pld_scrr.bits.sci))\r\nreturn 1;\r\n}\r\nif (ixjdebug & 0x0001)\r\nprintk(KERN_INFO "SCI Wait High failed %x\n", j->pld_scrr.byte);\r\nreturn 0;\r\n} else\r\nreturn 1;\r\n}\r\nstatic int SCI_WaitLowSCI(IXJ *j)\r\n{\r\nint cnt;\r\nj->pld_scrr.byte = inb_p(j->XILINXbase);\r\nif (j->pld_scrr.bits.sci) {\r\nfor (cnt = 0; cnt < 10; cnt++) {\r\nudelay(32);\r\nj->pld_scrr.byte = inb_p(j->XILINXbase);\r\nif (!(j->pld_scrr.bits.sci))\r\nreturn 1;\r\n}\r\nif (ixjdebug & 0x0001)\r\nprintk(KERN_INFO "SCI Wait Low failed %x\n", j->pld_scrr.byte);\r\nreturn 0;\r\n} else\r\nreturn 1;\r\n}\r\nstatic int SCI_Control(IXJ *j, int control)\r\n{\r\nswitch (control) {\r\ncase SCI_End:\r\nj->pld_scrw.bits.c0 = 0;\r\nj->pld_scrw.bits.c1 = 0;\r\nbreak;\r\ncase SCI_Enable_DAA:\r\nj->pld_scrw.bits.c0 = 1;\r\nj->pld_scrw.bits.c1 = 0;\r\nbreak;\r\ncase SCI_Enable_Mixer:\r\nj->pld_scrw.bits.c0 = 0;\r\nj->pld_scrw.bits.c1 = 1;\r\nbreak;\r\ncase SCI_Enable_EEPROM:\r\nj->pld_scrw.bits.c0 = 1;\r\nj->pld_scrw.bits.c1 = 1;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\nbreak;\r\n}\r\noutb_p(j->pld_scrw.byte, j->XILINXbase);\r\nswitch (control) {\r\ncase SCI_End:\r\nreturn 1;\r\nbreak;\r\ncase SCI_Enable_DAA:\r\ncase SCI_Enable_Mixer:\r\ncase SCI_Enable_EEPROM:\r\nif (!SCI_WaitHighSCI(j))\r\nreturn 0;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\nbreak;\r\n}\r\nreturn 1;\r\n}\r\nstatic int SCI_Prepare(IXJ *j)\r\n{\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int ixj_get_mixer(long val, IXJ *j)\r\n{\r\nint reg = (val & 0x1F00) >> 8;\r\nreturn j->mix.vol[reg];\r\n}\r\nstatic int ixj_mixer(long val, IXJ *j)\r\n{\r\nBYTES bytes;\r\nbytes.high = (val & 0x1F00) >> 8;\r\nbytes.low = val & 0x00FF;\r\nj->mix.vol[bytes.high] = bytes.low;\r\noutb_p(bytes.high & 0x1F, j->XILINXbase + 0x03);\r\noutb_p(bytes.low, j->XILINXbase + 0x02);\r\nSCI_Control(j, SCI_Enable_Mixer);\r\nSCI_Control(j, SCI_End);\r\nreturn 0;\r\n}\r\nstatic int daa_load(BYTES * p_bytes, IXJ *j)\r\n{\r\noutb_p(p_bytes->high, j->XILINXbase + 0x03);\r\noutb_p(p_bytes->low, j->XILINXbase + 0x02);\r\nif (!SCI_Control(j, SCI_Enable_DAA))\r\nreturn 0;\r\nelse\r\nreturn 1;\r\n}\r\nstatic int ixj_daa_cr4(IXJ *j, char reg)\r\n{\r\nBYTES bytes;\r\nswitch (j->daa_mode) {\r\ncase SOP_PU_SLEEP:\r\nbytes.high = 0x14;\r\nbreak;\r\ncase SOP_PU_RINGING:\r\nbytes.high = 0x54;\r\nbreak;\r\ncase SOP_PU_CONVERSATION:\r\nbytes.high = 0x94;\r\nbreak;\r\ncase SOP_PU_PULSEDIALING:\r\nbytes.high = 0xD4;\r\nbreak;\r\n}\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr4.reg = reg;\r\nswitch (j->m_DAAShadowRegs.SOP_REGS.SOP.cr4.bitreg.AGX) {\r\ncase 0:\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr4.bitreg.AGR_Z = 0;\r\nbreak;\r\ncase 1:\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr4.bitreg.AGR_Z = 2;\r\nbreak;\r\ncase 2:\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr4.bitreg.AGR_Z = 1;\r\nbreak;\r\ncase 3:\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr4.bitreg.AGR_Z = 3;\r\nbreak;\r\n}\r\nbytes.low = j->m_DAAShadowRegs.SOP_REGS.SOP.cr4.reg;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic char daa_int_read(IXJ *j)\r\n{\r\nBYTES bytes;\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\nbytes.high = 0x38;\r\nbytes.low = 0x00;\r\noutb_p(bytes.high, j->XILINXbase + 0x03);\r\noutb_p(bytes.low, j->XILINXbase + 0x02);\r\nif (!SCI_Control(j, SCI_Enable_DAA))\r\nreturn 0;\r\nbytes.high = inb_p(j->XILINXbase + 0x03);\r\nbytes.low = inb_p(j->XILINXbase + 0x02);\r\nif (bytes.low != ALISDAA_ID_BYTE) {\r\nif (ixjdebug & 0x0001)\r\nprintk("Cannot read DAA ID Byte high = %d low = %d\n", bytes.high, bytes.low);\r\nreturn 0;\r\n}\r\nif (!SCI_Control(j, SCI_Enable_DAA))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nbytes.high = inb_p(j->XILINXbase + 0x03);\r\nbytes.low = inb_p(j->XILINXbase + 0x02);\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr0.reg = bytes.high;\r\nreturn 1;\r\n}\r\nstatic char daa_CR_read(IXJ *j, int cr)\r\n{\r\nIXJ_WORD wdata;\r\nBYTES bytes;\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\nswitch (j->daa_mode) {\r\ncase SOP_PU_SLEEP:\r\nbytes.high = 0x30 + cr;\r\nbreak;\r\ncase SOP_PU_RINGING:\r\nbytes.high = 0x70 + cr;\r\nbreak;\r\ncase SOP_PU_CONVERSATION:\r\nbytes.high = 0xB0 + cr;\r\nbreak;\r\ncase SOP_PU_PULSEDIALING:\r\ndefault:\r\nbytes.high = 0xF0 + cr;\r\nbreak;\r\n}\r\nbytes.low = 0x00;\r\noutb_p(bytes.high, j->XILINXbase + 0x03);\r\noutb_p(bytes.low, j->XILINXbase + 0x02);\r\nif (!SCI_Control(j, SCI_Enable_DAA))\r\nreturn 0;\r\nbytes.high = inb_p(j->XILINXbase + 0x03);\r\nbytes.low = inb_p(j->XILINXbase + 0x02);\r\nif (bytes.low != ALISDAA_ID_BYTE) {\r\nif (ixjdebug & 0x0001)\r\nprintk("Cannot read DAA ID Byte high = %d low = %d\n", bytes.high, bytes.low);\r\nreturn 0;\r\n}\r\nif (!SCI_Control(j, SCI_Enable_DAA))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nwdata.word = inw_p(j->XILINXbase + 0x02);\r\nswitch(cr){\r\ncase 5:\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr5.reg = wdata.bytes.high;\r\nbreak;\r\ncase 4:\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr4.reg = wdata.bytes.high;\r\nbreak;\r\ncase 3:\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr3.reg = wdata.bytes.high;\r\nbreak;\r\ncase 2:\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr2.reg = wdata.bytes.high;\r\nbreak;\r\ncase 1:\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr1.reg = wdata.bytes.high;\r\nbreak;\r\ncase 0:\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg = wdata.bytes.high;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int ixj_daa_cid_reset(IXJ *j)\r\n{\r\nint i;\r\nBYTES bytes;\r\nif (ixjdebug & 0x0002)\r\nprintk("DAA Clearing CID ram\n");\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\nbytes.high = 0x58;\r\nbytes.low = 0x00;\r\noutb_p(bytes.high, j->XILINXbase + 0x03);\r\noutb_p(bytes.low, j->XILINXbase + 0x02);\r\nif (!SCI_Control(j, SCI_Enable_DAA))\r\nreturn 0;\r\nif (!SCI_WaitHighSCI(j))\r\nreturn 0;\r\nfor (i = 0; i < ALISDAA_CALLERID_SIZE - 1; i += 2) {\r\nbytes.high = bytes.low = 0x00;\r\noutb_p(bytes.high, j->XILINXbase + 0x03);\r\nif (i < ALISDAA_CALLERID_SIZE - 1)\r\noutb_p(bytes.low, j->XILINXbase + 0x02);\r\nif (!SCI_Control(j, SCI_Enable_DAA))\r\nreturn 0;\r\nif (!SCI_WaitHighSCI(j))\r\nreturn 0;\r\n}\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (ixjdebug & 0x0002)\r\nprintk("DAA CID ram cleared\n");\r\nreturn 1;\r\n}\r\nstatic int ixj_daa_cid_read(IXJ *j)\r\n{\r\nint i;\r\nBYTES bytes;\r\nchar CID[ALISDAA_CALLERID_SIZE];\r\nbool mContinue;\r\nchar *pIn, *pOut;\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\nbytes.high = 0x78;\r\nbytes.low = 0x00;\r\noutb_p(bytes.high, j->XILINXbase + 0x03);\r\noutb_p(bytes.low, j->XILINXbase + 0x02);\r\nif (!SCI_Control(j, SCI_Enable_DAA))\r\nreturn 0;\r\nif (!SCI_WaitHighSCI(j))\r\nreturn 0;\r\nbytes.high = inb_p(j->XILINXbase + 0x03);\r\nbytes.low = inb_p(j->XILINXbase + 0x02);\r\nif (bytes.low != ALISDAA_ID_BYTE) {\r\nif (ixjdebug & 0x0001)\r\nprintk("DAA Get Version Cannot read DAA ID Byte high = %d low = %d\n", bytes.high, bytes.low);\r\nreturn 0;\r\n}\r\nfor (i = 0; i < ALISDAA_CALLERID_SIZE; i += 2) {\r\nbytes.high = bytes.low = 0x00;\r\noutb_p(bytes.high, j->XILINXbase + 0x03);\r\noutb_p(bytes.low, j->XILINXbase + 0x02);\r\nif (!SCI_Control(j, SCI_Enable_DAA))\r\nreturn 0;\r\nif (!SCI_WaitHighSCI(j))\r\nreturn 0;\r\nCID[i + 0] = inb_p(j->XILINXbase + 0x03);\r\nCID[i + 1] = inb_p(j->XILINXbase + 0x02);\r\n}\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\npIn = CID;\r\npOut = j->m_DAAShadowRegs.CAO_REGS.CAO.CallerID;\r\nmContinue = true;\r\nwhile (mContinue) {\r\nif ((pIn[1] & 0x03) == 0x01) {\r\npOut[0] = pIn[0];\r\n}\r\nif ((pIn[2] & 0x0c) == 0x04) {\r\npOut[1] = ((pIn[2] & 0x03) << 6) | ((pIn[1] & 0xfc) >> 2);\r\n}\r\nif ((pIn[3] & 0x30) == 0x10) {\r\npOut[2] = ((pIn[3] & 0x0f) << 4) | ((pIn[2] & 0xf0) >> 4);\r\n}\r\nif ((pIn[4] & 0xc0) == 0x40) {\r\npOut[3] = ((pIn[4] & 0x3f) << 2) | ((pIn[3] & 0xc0) >> 6);\r\n} else {\r\nmContinue = false;\r\n}\r\npIn += 5, pOut += 4;\r\n}\r\nmemset(&j->cid, 0, sizeof(PHONE_CID));\r\npOut = j->m_DAAShadowRegs.CAO_REGS.CAO.CallerID;\r\npOut += 4;\r\nstrncpy(j->cid.month, pOut, 2);\r\npOut += 2;\r\nstrncpy(j->cid.day, pOut, 2);\r\npOut += 2;\r\nstrncpy(j->cid.hour, pOut, 2);\r\npOut += 2;\r\nstrncpy(j->cid.min, pOut, 2);\r\npOut += 3;\r\nj->cid.numlen = *pOut;\r\npOut += 1;\r\nstrncpy(j->cid.number, pOut, j->cid.numlen);\r\npOut += j->cid.numlen + 1;\r\nj->cid.namelen = *pOut;\r\npOut += 1;\r\nstrncpy(j->cid.name, pOut, j->cid.namelen);\r\nixj_daa_cid_reset(j);\r\nreturn 1;\r\n}\r\nstatic char daa_get_version(IXJ *j)\r\n{\r\nBYTES bytes;\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\nbytes.high = 0x35;\r\nbytes.low = 0x00;\r\noutb_p(bytes.high, j->XILINXbase + 0x03);\r\noutb_p(bytes.low, j->XILINXbase + 0x02);\r\nif (!SCI_Control(j, SCI_Enable_DAA))\r\nreturn 0;\r\nbytes.high = inb_p(j->XILINXbase + 0x03);\r\nbytes.low = inb_p(j->XILINXbase + 0x02);\r\nif (bytes.low != ALISDAA_ID_BYTE) {\r\nif (ixjdebug & 0x0001)\r\nprintk("DAA Get Version Cannot read DAA ID Byte high = %d low = %d\n", bytes.high, bytes.low);\r\nreturn 0;\r\n}\r\nif (!SCI_Control(j, SCI_Enable_DAA))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nbytes.high = inb_p(j->XILINXbase + 0x03);\r\nbytes.low = inb_p(j->XILINXbase + 0x02);\r\nif (ixjdebug & 0x0002)\r\nprintk("DAA CR5 Byte high = 0x%x low = 0x%x\n", bytes.high, bytes.low);\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr5.reg = bytes.high;\r\nreturn bytes.high;\r\n}\r\nstatic int daa_set_mode(IXJ *j, int mode)\r\n{\r\nBYTES bytes;\r\nj->flags.pstn_rmr = 0;\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\nswitch (mode) {\r\ncase SOP_PU_RESET:\r\nj->pld_scrw.bits.daafsyncen = 0;\r\noutb_p(j->pld_scrw.byte, j->XILINXbase);\r\nj->pld_slicw.bits.rly2 = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nbytes.high = 0x10;\r\nbytes.low = j->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg;\r\ndaa_load(&bytes, j);\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\nj->daa_mode = SOP_PU_SLEEP;\r\nbreak;\r\ncase SOP_PU_SLEEP:\r\nif(j->daa_mode == SOP_PU_SLEEP)\r\n{\r\nbreak;\r\n}\r\nif (ixjdebug & 0x0008)\r\nprintk(KERN_INFO "phone DAA: SOP_PU_SLEEP at %ld\n", jiffies);\r\n{\r\nj->pld_scrw.bits.daafsyncen = 0;\r\noutb_p(j->pld_scrw.byte, j->XILINXbase);\r\nj->pld_slicw.bits.rly2 = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nbytes.high = 0x10;\r\nbytes.low = j->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg;\r\ndaa_load(&bytes, j);\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\n}\r\nj->pld_scrw.bits.daafsyncen = 0;\r\noutb_p(j->pld_scrw.byte, j->XILINXbase);\r\nj->pld_slicw.bits.rly2 = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nbytes.high = 0x10;\r\nbytes.low = j->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg;\r\ndaa_load(&bytes, j);\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\nj->daa_mode = SOP_PU_SLEEP;\r\nj->flags.pstn_ringing = 0;\r\nj->ex.bits.pstn_ring = 0;\r\nj->pstn_sleeptil = jiffies + (hertz / 4);\r\nwake_up_interruptible(&j->read_q);\r\nwake_up_interruptible(&j->write_q);\r\nwake_up_interruptible(&j->poll_q);\r\nbreak;\r\ncase SOP_PU_RINGING:\r\nif (ixjdebug & 0x0008)\r\nprintk(KERN_INFO "phone DAA: SOP_PU_RINGING at %ld\n", jiffies);\r\nj->pld_scrw.bits.daafsyncen = 0;\r\noutb_p(j->pld_scrw.byte, j->XILINXbase);\r\nj->pld_slicw.bits.rly2 = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nbytes.high = 0x50;\r\nbytes.low = j->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg;\r\ndaa_load(&bytes, j);\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\nj->daa_mode = SOP_PU_RINGING;\r\nbreak;\r\ncase SOP_PU_CONVERSATION:\r\nif (ixjdebug & 0x0008)\r\nprintk(KERN_INFO "phone DAA: SOP_PU_CONVERSATION at %ld\n", jiffies);\r\nbytes.high = 0x90;\r\nbytes.low = j->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg;\r\ndaa_load(&bytes, j);\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\nj->pld_slicw.bits.rly2 = 1;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nj->pld_scrw.bits.daafsyncen = 1;\r\noutb_p(j->pld_scrw.byte, j->XILINXbase);\r\nj->daa_mode = SOP_PU_CONVERSATION;\r\nj->flags.pstn_ringing = 0;\r\nj->ex.bits.pstn_ring = 0;\r\nj->pstn_sleeptil = jiffies;\r\nj->pstn_ring_start = j->pstn_ring_stop = j->pstn_ring_int = 0;\r\nbreak;\r\ncase SOP_PU_PULSEDIALING:\r\nif (ixjdebug & 0x0008)\r\nprintk(KERN_INFO "phone DAA: SOP_PU_PULSEDIALING at %ld\n", jiffies);\r\nj->pld_scrw.bits.daafsyncen = 0;\r\noutb_p(j->pld_scrw.byte, j->XILINXbase);\r\nj->pld_slicw.bits.rly2 = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nbytes.high = 0xD0;\r\nbytes.low = j->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg;\r\ndaa_load(&bytes, j);\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\nj->daa_mode = SOP_PU_PULSEDIALING;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 1;\r\n}\r\nstatic int ixj_daa_write(IXJ *j)\r\n{\r\nBYTES bytes;\r\nj->flags.pstncheck = 1;\r\ndaa_set_mode(j, SOP_PU_SLEEP);\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\noutb_p(j->pld_scrw.byte, j->XILINXbase);\r\nbytes.high = 0x14;\r\nbytes.low = j->m_DAAShadowRegs.SOP_REGS.SOP.cr4.reg;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.SOP_REGS.SOP.cr3.reg;\r\nbytes.low = j->m_DAAShadowRegs.SOP_REGS.SOP.cr2.reg;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.SOP_REGS.SOP.cr1.reg;\r\nbytes.low = j->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\nbytes.high = 0x1F;\r\nbytes.low = j->m_DAAShadowRegs.XOP_REGS.XOP.xr7.reg;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.XOP_xr6_W.reg;\r\nbytes.low = j->m_DAAShadowRegs.XOP_REGS.XOP.xr5.reg;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.XOP_REGS.XOP.xr4.reg;\r\nbytes.low = j->m_DAAShadowRegs.XOP_REGS.XOP.xr3.reg;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.XOP_REGS.XOP.xr2.reg;\r\nbytes.low = j->m_DAAShadowRegs.XOP_REGS.XOP.xr1.reg;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.XOP_xr0_W.reg;\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Prepare(j))\r\nreturn 0;\r\nbytes.high = 0x00;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[7];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[6];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[5];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[4];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x01;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[7];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[6];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[5];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[4];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x02;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[7];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[6];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[5];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[4];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x03;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[7];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[6];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[5];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[4];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x04;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[7];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[6];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[5];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[4];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x05;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[7];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[6];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[5];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[4];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x06;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[7];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[6];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[5];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[4];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x07;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[7];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[6];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[5];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[4];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x08;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[7];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[6];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[5];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[4];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x09;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x0A;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x0B;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x0C;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x0D;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x0E;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[7];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[6];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[5];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[4];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\nif (!SCI_WaitLowSCI(j))\r\nreturn 0;\r\nbytes.high = 0x0F;\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[7];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[6];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[5];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[4];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[3];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[2];\r\nbytes.low = j->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[1];\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nbytes.high = j->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[0];\r\nbytes.low = 0x00;\r\nif (!daa_load(&bytes, j))\r\nreturn 0;\r\nudelay(32);\r\nj->pld_scrr.byte = inb_p(j->XILINXbase);\r\nif (!SCI_Control(j, SCI_End))\r\nreturn 0;\r\noutb_p(j->pld_scrw.byte, j->XILINXbase);\r\nif (ixjdebug & 0x0002)\r\nprintk("DAA Coefficients Loaded\n");\r\nj->flags.pstncheck = 0;\r\nreturn 1;\r\n}\r\nstatic int ixj_set_tone_off(unsigned short arg, IXJ *j)\r\n{\r\nj->tone_off_time = arg;\r\nif (ixj_WriteDSPCommand(0x6E05, j))\r\nreturn -1;\r\nif (ixj_WriteDSPCommand(arg, j))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int ixj_get_tone_on(IXJ *j)\r\n{\r\nif (ixj_WriteDSPCommand(0x6E06, j))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int ixj_get_tone_off(IXJ *j)\r\n{\r\nif (ixj_WriteDSPCommand(0x6E07, j))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic void ixj_busytone(IXJ *j)\r\n{\r\nj->flags.ringback = 0;\r\nj->flags.dialtone = 0;\r\nj->flags.busytone = 1;\r\nixj_set_tone_on(0x07D0, j);\r\nixj_set_tone_off(0x07D0, j);\r\nixj_play_tone(j, 27);\r\n}\r\nstatic void ixj_dialtone(IXJ *j)\r\n{\r\nj->flags.ringback = 0;\r\nj->flags.dialtone = 1;\r\nj->flags.busytone = 0;\r\nif (j->dsp.low == 0x20) {\r\nreturn;\r\n} else {\r\nixj_set_tone_on(0xFFFF, j);\r\nixj_set_tone_off(0x0000, j);\r\nixj_play_tone(j, 25);\r\n}\r\n}\r\nstatic void ixj_cpt_stop(IXJ *j)\r\n{\r\nif(j->tone_state || j->tone_cadence_state)\r\n{\r\nj->flags.dialtone = 0;\r\nj->flags.busytone = 0;\r\nj->flags.ringback = 0;\r\nixj_set_tone_on(0x0001, j);\r\nixj_set_tone_off(0x0000, j);\r\nixj_play_tone(j, 0);\r\nj->tone_state = j->tone_cadence_state = 0;\r\nif (j->cadence_t) {\r\nkfree(j->cadence_t->ce);\r\nkfree(j->cadence_t);\r\nj->cadence_t = NULL;\r\n}\r\n}\r\nif (j->play_mode == -1 && j->rec_mode == -1)\r\nidle(j);\r\nif (j->play_mode != -1 && j->dsp.low == 0x20)\r\nixj_play_start(j);\r\nif (j->rec_mode != -1 && j->dsp.low == 0x20)\r\nixj_record_start(j);\r\n}\r\nstatic void ixj_ringback(IXJ *j)\r\n{\r\nj->flags.busytone = 0;\r\nj->flags.dialtone = 0;\r\nj->flags.ringback = 1;\r\nixj_set_tone_on(0x0FA0, j);\r\nixj_set_tone_off(0x2EE0, j);\r\nixj_play_tone(j, 26);\r\n}\r\nstatic void ixj_testram(IXJ *j)\r\n{\r\nixj_WriteDSPCommand(0x3001, j);\r\n}\r\nstatic int ixj_build_cadence(IXJ *j, IXJ_CADENCE __user * cp)\r\n{\r\nixj_cadence *lcp;\r\nIXJ_CADENCE_ELEMENT __user *cep;\r\nIXJ_CADENCE_ELEMENT *lcep;\r\nIXJ_TONE ti;\r\nint err;\r\nlcp = kmalloc(sizeof(ixj_cadence), GFP_KERNEL);\r\nif (lcp == NULL)\r\nreturn -ENOMEM;\r\nerr = -EFAULT;\r\nif (copy_from_user(&lcp->elements_used,\r\n&cp->elements_used, sizeof(int)))\r\ngoto out;\r\nif (copy_from_user(&lcp->termination,\r\n&cp->termination, sizeof(IXJ_CADENCE_TERM)))\r\ngoto out;\r\nif (get_user(cep, &cp->ce))\r\ngoto out;\r\nerr = -EINVAL;\r\nif ((unsigned)lcp->elements_used >= ~0U/sizeof(IXJ_CADENCE_ELEMENT))\r\ngoto out;\r\nerr = -ENOMEM;\r\nlcep = kmalloc(sizeof(IXJ_CADENCE_ELEMENT) * lcp->elements_used, GFP_KERNEL);\r\nif (!lcep)\r\ngoto out;\r\nerr = -EFAULT;\r\nif (copy_from_user(lcep, cep, sizeof(IXJ_CADENCE_ELEMENT) * lcp->elements_used))\r\ngoto out1;\r\nif (j->cadence_t) {\r\nkfree(j->cadence_t->ce);\r\nkfree(j->cadence_t);\r\n}\r\nlcp->ce = (void *) lcep;\r\nj->cadence_t = lcp;\r\nj->tone_cadence_state = 0;\r\nixj_set_tone_on(lcp->ce[0].tone_on_time, j);\r\nixj_set_tone_off(lcp->ce[0].tone_off_time, j);\r\nif (j->cadence_t->ce[j->tone_cadence_state].freq0) {\r\nti.tone_index = j->cadence_t->ce[j->tone_cadence_state].index;\r\nti.freq0 = j->cadence_t->ce[j->tone_cadence_state].freq0;\r\nti.gain0 = j->cadence_t->ce[j->tone_cadence_state].gain0;\r\nti.freq1 = j->cadence_t->ce[j->tone_cadence_state].freq1;\r\nti.gain1 = j->cadence_t->ce[j->tone_cadence_state].gain1;\r\nixj_init_tone(j, &ti);\r\n}\r\nixj_play_tone(j, lcp->ce[0].index);\r\nreturn 1;\r\nout1:\r\nkfree(lcep);\r\nout:\r\nkfree(lcp);\r\nreturn err;\r\n}\r\nstatic int ixj_build_filter_cadence(IXJ *j, IXJ_FILTER_CADENCE __user * cp)\r\n{\r\nIXJ_FILTER_CADENCE *lcp;\r\nlcp = memdup_user(cp, sizeof(IXJ_FILTER_CADENCE));\r\nif (IS_ERR(lcp)) {\r\nif(ixjdebug & 0x0001) {\r\nprintk(KERN_INFO "Could not allocate memory for cadence or could not copy cadence to kernel\n");\r\n}\r\nreturn PTR_ERR(lcp);\r\n}\r\nif (lcp->filter > 5) {\r\nif(ixjdebug & 0x0001) {\r\nprintk(KERN_INFO "Cadence out of range\n");\r\n}\r\nkfree(lcp);\r\nreturn -1;\r\n}\r\nj->cadence_f[lcp->filter].state = 0;\r\nj->cadence_f[lcp->filter].enable = lcp->enable;\r\nj->filter_en[lcp->filter] = j->cadence_f[lcp->filter].en_filter = lcp->en_filter;\r\nj->cadence_f[lcp->filter].on1 = lcp->on1;\r\nj->cadence_f[lcp->filter].on1min = 0;\r\nj->cadence_f[lcp->filter].on1max = 0;\r\nj->cadence_f[lcp->filter].off1 = lcp->off1;\r\nj->cadence_f[lcp->filter].off1min = 0;\r\nj->cadence_f[lcp->filter].off1max = 0;\r\nj->cadence_f[lcp->filter].on2 = lcp->on2;\r\nj->cadence_f[lcp->filter].on2min = 0;\r\nj->cadence_f[lcp->filter].on2max = 0;\r\nj->cadence_f[lcp->filter].off2 = lcp->off2;\r\nj->cadence_f[lcp->filter].off2min = 0;\r\nj->cadence_f[lcp->filter].off2max = 0;\r\nj->cadence_f[lcp->filter].on3 = lcp->on3;\r\nj->cadence_f[lcp->filter].on3min = 0;\r\nj->cadence_f[lcp->filter].on3max = 0;\r\nj->cadence_f[lcp->filter].off3 = lcp->off3;\r\nj->cadence_f[lcp->filter].off3min = 0;\r\nj->cadence_f[lcp->filter].off3max = 0;\r\nif(ixjdebug & 0x0002) {\r\nprintk(KERN_INFO "Cadence %d loaded\n", lcp->filter);\r\n}\r\nkfree(lcp);\r\nreturn 0;\r\n}\r\nstatic void add_caps(IXJ *j)\r\n{\r\nj->caps = 0;\r\nj->caplist[j->caps].cap = PHONE_VENDOR_QUICKNET;\r\nstrcpy(j->caplist[j->caps].desc, "Quicknet Technologies, Inc. (www.quicknet.net)");\r\nj->caplist[j->caps].captype = vendor;\r\nj->caplist[j->caps].handle = j->caps++;\r\nj->caplist[j->caps].captype = device;\r\nswitch (j->cardtype) {\r\ncase QTI_PHONEJACK:\r\nstrcpy(j->caplist[j->caps].desc, "Quicknet Internet PhoneJACK");\r\nbreak;\r\ncase QTI_LINEJACK:\r\nstrcpy(j->caplist[j->caps].desc, "Quicknet Internet LineJACK");\r\nbreak;\r\ncase QTI_PHONEJACK_LITE:\r\nstrcpy(j->caplist[j->caps].desc, "Quicknet Internet PhoneJACK Lite");\r\nbreak;\r\ncase QTI_PHONEJACK_PCI:\r\nstrcpy(j->caplist[j->caps].desc, "Quicknet Internet PhoneJACK PCI");\r\nbreak;\r\ncase QTI_PHONECARD:\r\nstrcpy(j->caplist[j->caps].desc, "Quicknet Internet PhoneCARD");\r\nbreak;\r\n}\r\nj->caplist[j->caps].cap = j->cardtype;\r\nj->caplist[j->caps].handle = j->caps++;\r\nstrcpy(j->caplist[j->caps].desc, "POTS");\r\nj->caplist[j->caps].captype = port;\r\nj->caplist[j->caps].cap = pots;\r\nj->caplist[j->caps].handle = j->caps++;\r\nswitch (j->cardtype) {\r\ncase QTI_PHONEJACK:\r\ncase QTI_LINEJACK:\r\ncase QTI_PHONEJACK_PCI:\r\ncase QTI_PHONECARD:\r\nstrcpy(j->caplist[j->caps].desc, "SPEAKER");\r\nj->caplist[j->caps].captype = port;\r\nj->caplist[j->caps].cap = speaker;\r\nj->caplist[j->caps].handle = j->caps++;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (j->cardtype) {\r\ncase QTI_PHONEJACK:\r\nstrcpy(j->caplist[j->caps].desc, "HANDSET");\r\nj->caplist[j->caps].captype = port;\r\nj->caplist[j->caps].cap = handset;\r\nj->caplist[j->caps].handle = j->caps++;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (j->cardtype) {\r\ncase QTI_LINEJACK:\r\nstrcpy(j->caplist[j->caps].desc, "PSTN");\r\nj->caplist[j->caps].captype = port;\r\nj->caplist[j->caps].cap = pstn;\r\nj->caplist[j->caps].handle = j->caps++;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nstrcpy(j->caplist[j->caps].desc, "ULAW");\r\nj->caplist[j->caps].captype = codec;\r\nj->caplist[j->caps].cap = ULAW;\r\nj->caplist[j->caps].handle = j->caps++;\r\nstrcpy(j->caplist[j->caps].desc, "LINEAR 16 bit");\r\nj->caplist[j->caps].captype = codec;\r\nj->caplist[j->caps].cap = LINEAR16;\r\nj->caplist[j->caps].handle = j->caps++;\r\nstrcpy(j->caplist[j->caps].desc, "LINEAR 8 bit");\r\nj->caplist[j->caps].captype = codec;\r\nj->caplist[j->caps].cap = LINEAR8;\r\nj->caplist[j->caps].handle = j->caps++;\r\nstrcpy(j->caplist[j->caps].desc, "Windows Sound System");\r\nj->caplist[j->caps].captype = codec;\r\nj->caplist[j->caps].cap = WSS;\r\nj->caplist[j->caps].handle = j->caps++;\r\nstrcpy(j->caplist[j->caps].desc, "ALAW");\r\nj->caplist[j->caps].captype = codec;\r\nj->caplist[j->caps].cap = ALAW;\r\nj->caplist[j->caps].handle = j->caps++;\r\nif (j->dsp.low != 0x20 || j->ver.low != 0x12) {\r\nstrcpy(j->caplist[j->caps].desc, "G.723.1 6.3kbps");\r\nj->caplist[j->caps].captype = codec;\r\nj->caplist[j->caps].cap = G723_63;\r\nj->caplist[j->caps].handle = j->caps++;\r\nstrcpy(j->caplist[j->caps].desc, "G.723.1 5.3kbps");\r\nj->caplist[j->caps].captype = codec;\r\nj->caplist[j->caps].cap = G723_53;\r\nj->caplist[j->caps].handle = j->caps++;\r\nstrcpy(j->caplist[j->caps].desc, "TrueSpeech 4.8kbps");\r\nj->caplist[j->caps].captype = codec;\r\nj->caplist[j->caps].cap = TS48;\r\nj->caplist[j->caps].handle = j->caps++;\r\nstrcpy(j->caplist[j->caps].desc, "TrueSpeech 4.1kbps");\r\nj->caplist[j->caps].captype = codec;\r\nj->caplist[j->caps].cap = TS41;\r\nj->caplist[j->caps].handle = j->caps++;\r\n}\r\nif (j->dsp.low == 0x20 || j->flags.ts85_loaded) {\r\nstrcpy(j->caplist[j->caps].desc, "TrueSpeech 8.5kbps");\r\nj->caplist[j->caps].captype = codec;\r\nj->caplist[j->caps].cap = TS85;\r\nj->caplist[j->caps].handle = j->caps++;\r\n}\r\nif (j->dsp.low == 0x21) {\r\nstrcpy(j->caplist[j->caps].desc, "G.728 16kbps");\r\nj->caplist[j->caps].captype = codec;\r\nj->caplist[j->caps].cap = G728;\r\nj->caplist[j->caps].handle = j->caps++;\r\n}\r\nif (j->dsp.low != 0x20 && j->flags.g729_loaded) {\r\nstrcpy(j->caplist[j->caps].desc, "G.729A 8kbps");\r\nj->caplist[j->caps].captype = codec;\r\nj->caplist[j->caps].cap = G729;\r\nj->caplist[j->caps].handle = j->caps++;\r\n}\r\nif (j->dsp.low != 0x20 && j->flags.g729_loaded) {\r\nstrcpy(j->caplist[j->caps].desc, "G.729B 8kbps");\r\nj->caplist[j->caps].captype = codec;\r\nj->caplist[j->caps].cap = G729B;\r\nj->caplist[j->caps].handle = j->caps++;\r\n}\r\n}\r\nstatic int capabilities_check(IXJ *j, struct phone_capability *pcreq)\r\n{\r\nint cnt;\r\nint retval = 0;\r\nfor (cnt = 0; cnt < j->caps; cnt++) {\r\nif (pcreq->captype == j->caplist[cnt].captype\r\n&& pcreq->cap == j->caplist[cnt].cap) {\r\nretval = 1;\r\nbreak;\r\n}\r\n}\r\nreturn retval;\r\n}\r\nstatic long do_ixj_ioctl(struct file *file_p, unsigned int cmd, unsigned long arg)\r\n{\r\nIXJ_TONE ti;\r\nIXJ_FILTER jf;\r\nIXJ_FILTER_RAW jfr;\r\nvoid __user *argp = (void __user *)arg;\r\nstruct inode *inode = file_p->f_path.dentry->d_inode;\r\nunsigned int minor = iminor(inode);\r\nunsigned int raise, mant;\r\nint board = NUM(inode);\r\nIXJ *j = get_ixj(NUM(inode));\r\nint retval = 0;\r\nwhile(test_and_set_bit(board, (void *)&j->busyflags) != 0)\r\nschedule_timeout_interruptible(1);\r\nif (ixjdebug & 0x0040)\r\nprintk("phone%d ioctl, cmd: 0x%x, arg: 0x%lx\n", minor, cmd, arg);\r\nif (minor >= IXJMAX) {\r\nclear_bit(board, &j->busyflags);\r\nreturn -ENODEV;\r\n}\r\nif (!capable(CAP_SYS_ADMIN)) {\r\nswitch (cmd) {\r\ncase IXJCTL_TESTRAM:\r\ncase IXJCTL_HZ:\r\nretval = -EPERM;\r\n}\r\n}\r\nswitch (cmd) {\r\ncase IXJCTL_TESTRAM:\r\nixj_testram(j);\r\nretval = (j->ssr.high << 8) + j->ssr.low;\r\nbreak;\r\ncase IXJCTL_CARDTYPE:\r\nretval = j->cardtype;\r\nbreak;\r\ncase IXJCTL_SERIAL:\r\nretval = j->serial;\r\nbreak;\r\ncase IXJCTL_VERSION:\r\n{\r\nchar arg_str[100];\r\nsnprintf(arg_str, sizeof(arg_str),\r\n"\nDriver version %i.%i.%i", IXJ_VER_MAJOR,\r\nIXJ_VER_MINOR, IXJ_BLD_VER);\r\nif (copy_to_user(argp, arg_str, strlen(arg_str)))\r\nretval = -EFAULT;\r\n}\r\nbreak;\r\ncase PHONE_RING_CADENCE:\r\nj->ring_cadence = arg;\r\nbreak;\r\ncase IXJCTL_CIDCW:\r\nif(arg) {\r\nif (copy_from_user(&j->cid_send, argp, sizeof(PHONE_CID))) {\r\nretval = -EFAULT;\r\nbreak;\r\n}\r\n} else {\r\nmemset(&j->cid_send, 0, sizeof(PHONE_CID));\r\n}\r\nixj_write_cidcw(j);\r\nbreak;\r\ncase OLD_PHONE_RING_START:\r\narg = 0;\r\ncase PHONE_RING_START:\r\nif(arg) {\r\nif (copy_from_user(&j->cid_send, argp, sizeof(PHONE_CID))) {\r\nretval = -EFAULT;\r\nbreak;\r\n}\r\nixj_write_cid(j);\r\n} else {\r\nmemset(&j->cid_send, 0, sizeof(PHONE_CID));\r\n}\r\nixj_ring_start(j);\r\nbreak;\r\ncase PHONE_RING_STOP:\r\nj->flags.cringing = 0;\r\nif(j->cadence_f[5].enable) {\r\nj->cadence_f[5].state = 0;\r\n}\r\nixj_ring_off(j);\r\nbreak;\r\ncase PHONE_RING:\r\nretval = ixj_ring(j);\r\nbreak;\r\ncase PHONE_EXCEPTION:\r\nretval = j->ex.bytes;\r\nif(j->ex.bits.flash) {\r\nj->flash_end = 0;\r\nj->ex.bits.flash = 0;\r\n}\r\nj->ex.bits.pstn_ring = 0;\r\nj->ex.bits.caller_id = 0;\r\nj->ex.bits.pstn_wink = 0;\r\nj->ex.bits.f0 = 0;\r\nj->ex.bits.f1 = 0;\r\nj->ex.bits.f2 = 0;\r\nj->ex.bits.f3 = 0;\r\nj->ex.bits.fc0 = 0;\r\nj->ex.bits.fc1 = 0;\r\nj->ex.bits.fc2 = 0;\r\nj->ex.bits.fc3 = 0;\r\nj->ex.bits.reserved = 0;\r\nbreak;\r\ncase PHONE_HOOKSTATE:\r\nj->ex.bits.hookstate = 0;\r\nretval = j->hookstate;\r\nbreak;\r\ncase IXJCTL_SET_LED:\r\nLED_SetState(arg, j);\r\nbreak;\r\ncase PHONE_FRAME:\r\nretval = set_base_frame(j, arg);\r\nbreak;\r\ncase PHONE_REC_CODEC:\r\nretval = set_rec_codec(j, arg);\r\nbreak;\r\ncase PHONE_VAD:\r\nixj_vad(j, arg);\r\nbreak;\r\ncase PHONE_REC_START:\r\nixj_record_start(j);\r\nbreak;\r\ncase PHONE_REC_STOP:\r\nixj_record_stop(j);\r\nbreak;\r\ncase PHONE_REC_DEPTH:\r\nset_rec_depth(j, arg);\r\nbreak;\r\ncase PHONE_REC_VOLUME:\r\nif(arg == -1) {\r\nretval = get_rec_volume(j);\r\n}\r\nelse {\r\nset_rec_volume(j, arg);\r\nretval = arg;\r\n}\r\nbreak;\r\ncase PHONE_REC_VOLUME_LINEAR:\r\nif(arg == -1) {\r\nretval = get_rec_volume_linear(j);\r\n}\r\nelse {\r\nset_rec_volume_linear(j, arg);\r\nretval = arg;\r\n}\r\nbreak;\r\ncase IXJCTL_DTMF_PRESCALE:\r\nif(arg == -1) {\r\nretval = get_dtmf_prescale(j);\r\n}\r\nelse {\r\nset_dtmf_prescale(j, arg);\r\nretval = arg;\r\n}\r\nbreak;\r\ncase PHONE_REC_LEVEL:\r\nretval = get_rec_level(j);\r\nbreak;\r\ncase IXJCTL_SC_RXG:\r\nretval = ixj_siadc(j, arg);\r\nbreak;\r\ncase IXJCTL_SC_TXG:\r\nretval = ixj_sidac(j, arg);\r\nbreak;\r\ncase IXJCTL_AEC_START:\r\nixj_aec_start(j, arg);\r\nbreak;\r\ncase IXJCTL_AEC_STOP:\r\naec_stop(j);\r\nbreak;\r\ncase IXJCTL_AEC_GET_LEVEL:\r\nretval = j->aec_level;\r\nbreak;\r\ncase PHONE_PLAY_CODEC:\r\nretval = set_play_codec(j, arg);\r\nbreak;\r\ncase PHONE_PLAY_START:\r\nretval = ixj_play_start(j);\r\nbreak;\r\ncase PHONE_PLAY_STOP:\r\nixj_play_stop(j);\r\nbreak;\r\ncase PHONE_PLAY_DEPTH:\r\nset_play_depth(j, arg);\r\nbreak;\r\ncase PHONE_PLAY_VOLUME:\r\nif(arg == -1) {\r\nretval = get_play_volume(j);\r\n}\r\nelse {\r\nset_play_volume(j, arg);\r\nretval = arg;\r\n}\r\nbreak;\r\ncase PHONE_PLAY_VOLUME_LINEAR:\r\nif(arg == -1) {\r\nretval = get_play_volume_linear(j);\r\n}\r\nelse {\r\nset_play_volume_linear(j, arg);\r\nretval = arg;\r\n}\r\nbreak;\r\ncase PHONE_PLAY_LEVEL:\r\nretval = get_play_level(j);\r\nbreak;\r\ncase IXJCTL_DSP_TYPE:\r\nretval = (j->dsp.high << 8) + j->dsp.low;\r\nbreak;\r\ncase IXJCTL_DSP_VERSION:\r\nretval = (j->ver.high << 8) + j->ver.low;\r\nbreak;\r\ncase IXJCTL_HZ:\r\nhertz = arg;\r\nbreak;\r\ncase IXJCTL_RATE:\r\nif (arg > hertz)\r\nretval = -1;\r\nelse\r\nsamplerate = arg;\r\nbreak;\r\ncase IXJCTL_DRYBUFFER_READ:\r\nput_user(j->drybuffer, (unsigned long __user *) argp);\r\nbreak;\r\ncase IXJCTL_DRYBUFFER_CLEAR:\r\nj->drybuffer = 0;\r\nbreak;\r\ncase IXJCTL_FRAMES_READ:\r\nput_user(j->framesread, (unsigned long __user *) argp);\r\nbreak;\r\ncase IXJCTL_FRAMES_WRITTEN:\r\nput_user(j->frameswritten, (unsigned long __user *) argp);\r\nbreak;\r\ncase IXJCTL_READ_WAIT:\r\nput_user(j->read_wait, (unsigned long __user *) argp);\r\nbreak;\r\ncase IXJCTL_WRITE_WAIT:\r\nput_user(j->write_wait, (unsigned long __user *) argp);\r\nbreak;\r\ncase PHONE_MAXRINGS:\r\nj->maxrings = arg;\r\nbreak;\r\ncase PHONE_SET_TONE_ON_TIME:\r\nixj_set_tone_on(arg, j);\r\nbreak;\r\ncase PHONE_SET_TONE_OFF_TIME:\r\nixj_set_tone_off(arg, j);\r\nbreak;\r\ncase PHONE_GET_TONE_ON_TIME:\r\nif (ixj_get_tone_on(j)) {\r\nretval = -1;\r\n} else {\r\nretval = (j->ssr.high << 8) + j->ssr.low;\r\n}\r\nbreak;\r\ncase PHONE_GET_TONE_OFF_TIME:\r\nif (ixj_get_tone_off(j)) {\r\nretval = -1;\r\n} else {\r\nretval = (j->ssr.high << 8) + j->ssr.low;\r\n}\r\nbreak;\r\ncase PHONE_PLAY_TONE:\r\nif (!j->tone_state)\r\nretval = ixj_play_tone(j, arg);\r\nelse\r\nretval = -1;\r\nbreak;\r\ncase PHONE_GET_TONE_STATE:\r\nretval = j->tone_state;\r\nbreak;\r\ncase PHONE_DTMF_READY:\r\nretval = j->ex.bits.dtmf_ready;\r\nbreak;\r\ncase PHONE_GET_DTMF:\r\nif (ixj_hookstate(j)) {\r\nif (j->dtmf_rp != j->dtmf_wp) {\r\nretval = j->dtmfbuffer[j->dtmf_rp];\r\nj->dtmf_rp++;\r\nif (j->dtmf_rp == 79)\r\nj->dtmf_rp = 0;\r\nif (j->dtmf_rp == j->dtmf_wp) {\r\nj->ex.bits.dtmf_ready = j->dtmf_rp = j->dtmf_wp = 0;\r\n}\r\n}\r\n}\r\nbreak;\r\ncase PHONE_GET_DTMF_ASCII:\r\nif (ixj_hookstate(j)) {\r\nif (j->dtmf_rp != j->dtmf_wp) {\r\nswitch (j->dtmfbuffer[j->dtmf_rp]) {\r\ncase 10:\r\nretval = 42;\r\nbreak;\r\ncase 11:\r\nretval = 48;\r\nbreak;\r\ncase 12:\r\nretval = 35;\r\nbreak;\r\ncase 28:\r\nretval = 65;\r\nbreak;\r\ncase 29:\r\nretval = 66;\r\nbreak;\r\ncase 30:\r\nretval = 67;\r\nbreak;\r\ncase 31:\r\nretval = 68;\r\nbreak;\r\ndefault:\r\nretval = 48 + j->dtmfbuffer[j->dtmf_rp];\r\nbreak;\r\n}\r\nj->dtmf_rp++;\r\nif (j->dtmf_rp == 79)\r\nj->dtmf_rp = 0;\r\nif(j->dtmf_rp == j->dtmf_wp)\r\n{\r\nj->ex.bits.dtmf_ready = j->dtmf_rp = j->dtmf_wp = 0;\r\n}\r\n}\r\n}\r\nbreak;\r\ncase PHONE_DTMF_OOB:\r\nj->flags.dtmf_oob = arg;\r\nbreak;\r\ncase PHONE_DIALTONE:\r\nixj_dialtone(j);\r\nbreak;\r\ncase PHONE_BUSY:\r\nixj_busytone(j);\r\nbreak;\r\ncase PHONE_RINGBACK:\r\nixj_ringback(j);\r\nbreak;\r\ncase PHONE_WINK:\r\nif(j->cardtype == QTI_PHONEJACK)\r\nretval = -1;\r\nelse\r\nretval = ixj_wink(j);\r\nbreak;\r\ncase PHONE_CPT_STOP:\r\nixj_cpt_stop(j);\r\nbreak;\r\ncase PHONE_QUERY_CODEC:\r\n{\r\nstruct phone_codec_data pd;\r\nint val;\r\nint proto_size[] = {\r\n-1,\r\n12, 10, 16, 9, 8, 48, 5,\r\n40, 40, 80, 40, 40, 6\r\n};\r\nif(copy_from_user(&pd, argp, sizeof(pd))) {\r\nretval = -EFAULT;\r\nbreak;\r\n}\r\nif(pd.type<1 || pd.type>13) {\r\nretval = -EPROTONOSUPPORT;\r\nbreak;\r\n}\r\nif(pd.type<G729)\r\nval=proto_size[pd.type];\r\nelse switch(j->baseframe.low)\r\n{\r\ncase 0xA0:val=2*proto_size[pd.type];break;\r\ncase 0x50:val=proto_size[pd.type];break;\r\ndefault:val=proto_size[pd.type]*3;break;\r\n}\r\npd.buf_min=pd.buf_max=pd.buf_opt=val;\r\nif(copy_to_user(argp, &pd, sizeof(pd)))\r\nretval = -EFAULT;\r\nbreak;\r\n}\r\ncase IXJCTL_DSP_IDLE:\r\nidle(j);\r\nbreak;\r\ncase IXJCTL_MIXER:\r\nif ((arg & 0xff) == 0xff)\r\nretval = ixj_get_mixer(arg, j);\r\nelse\r\nixj_mixer(arg, j);\r\nbreak;\r\ncase IXJCTL_DAA_COEFF_SET:\r\nswitch (arg) {\r\ncase DAA_US:\r\nDAA_Coeff_US(j);\r\nretval = ixj_daa_write(j);\r\nbreak;\r\ncase DAA_UK:\r\nDAA_Coeff_UK(j);\r\nretval = ixj_daa_write(j);\r\nbreak;\r\ncase DAA_FRANCE:\r\nDAA_Coeff_France(j);\r\nretval = ixj_daa_write(j);\r\nbreak;\r\ncase DAA_GERMANY:\r\nDAA_Coeff_Germany(j);\r\nretval = ixj_daa_write(j);\r\nbreak;\r\ncase DAA_AUSTRALIA:\r\nDAA_Coeff_Australia(j);\r\nretval = ixj_daa_write(j);\r\nbreak;\r\ncase DAA_JAPAN:\r\nDAA_Coeff_Japan(j);\r\nretval = ixj_daa_write(j);\r\nbreak;\r\ndefault:\r\nretval = 1;\r\nbreak;\r\n}\r\nbreak;\r\ncase IXJCTL_DAA_AGAIN:\r\nixj_daa_cr4(j, arg | 0x02);\r\nbreak;\r\ncase IXJCTL_PSTN_LINETEST:\r\nretval = ixj_linetest(j);\r\nbreak;\r\ncase IXJCTL_VMWI:\r\nixj_write_vmwi(j, arg);\r\nbreak;\r\ncase IXJCTL_CID:\r\nif (copy_to_user(argp, &j->cid, sizeof(PHONE_CID)))\r\nretval = -EFAULT;\r\nj->ex.bits.caller_id = 0;\r\nbreak;\r\ncase IXJCTL_WINK_DURATION:\r\nj->winktime = arg;\r\nbreak;\r\ncase IXJCTL_PORT:\r\nif (arg)\r\nretval = ixj_set_port(j, arg);\r\nelse\r\nretval = j->port;\r\nbreak;\r\ncase IXJCTL_POTS_PSTN:\r\nretval = ixj_set_pots(j, arg);\r\nbreak;\r\ncase PHONE_CAPABILITIES:\r\nadd_caps(j);\r\nretval = j->caps;\r\nbreak;\r\ncase PHONE_CAPABILITIES_LIST:\r\nadd_caps(j);\r\nif (copy_to_user(argp, j->caplist, sizeof(struct phone_capability) * j->caps))\r\nretval = -EFAULT;\r\nbreak;\r\ncase PHONE_CAPABILITIES_CHECK:\r\n{\r\nstruct phone_capability cap;\r\nif (copy_from_user(&cap, argp, sizeof(cap)))\r\nretval = -EFAULT;\r\nelse {\r\nadd_caps(j);\r\nretval = capabilities_check(j, &cap);\r\n}\r\n}\r\nbreak;\r\ncase PHONE_PSTN_SET_STATE:\r\ndaa_set_mode(j, arg);\r\nbreak;\r\ncase PHONE_PSTN_GET_STATE:\r\nretval = j->daa_mode;\r\nj->ex.bits.pstn_ring = 0;\r\nbreak;\r\ncase IXJCTL_SET_FILTER:\r\nif (copy_from_user(&jf, argp, sizeof(jf)))\r\nretval = -EFAULT;\r\nelse\r\nretval = ixj_init_filter(j, &jf);\r\nbreak;\r\ncase IXJCTL_SET_FILTER_RAW:\r\nif (copy_from_user(&jfr, argp, sizeof(jfr)))\r\nretval = -EFAULT;\r\nelse\r\nretval = ixj_init_filter_raw(j, &jfr);\r\nbreak;\r\ncase IXJCTL_GET_FILTER_HIST:\r\nif(arg<0||arg>3)\r\nretval = -EINVAL;\r\nelse\r\nretval = j->filter_hist[arg];\r\nbreak;\r\ncase IXJCTL_INIT_TONE:\r\nif (copy_from_user(&ti, argp, sizeof(ti)))\r\nretval = -EFAULT;\r\nelse\r\nretval = ixj_init_tone(j, &ti);\r\nbreak;\r\ncase IXJCTL_TONE_CADENCE:\r\nretval = ixj_build_cadence(j, argp);\r\nbreak;\r\ncase IXJCTL_FILTER_CADENCE:\r\nretval = ixj_build_filter_cadence(j, argp);\r\nbreak;\r\ncase IXJCTL_SIGCTL:\r\nif (copy_from_user(&j->sigdef, argp, sizeof(IXJ_SIGDEF))) {\r\nretval = -EFAULT;\r\nbreak;\r\n}\r\nj->ixj_signals[j->sigdef.event] = j->sigdef.signal;\r\nif(j->sigdef.event < 33) {\r\nraise = 1;\r\nfor(mant = 0; mant < j->sigdef.event; mant++){\r\nraise *= 2;\r\n}\r\nif(j->sigdef.signal)\r\nj->ex_sig.bytes |= raise;\r\nelse\r\nj->ex_sig.bytes &= (raise^0xffff);\r\n}\r\nbreak;\r\ncase IXJCTL_INTERCOM_STOP:\r\nif(arg < 0 || arg >= IXJMAX)\r\nreturn -EINVAL;\r\nj->intercom = -1;\r\nixj_record_stop(j);\r\nixj_play_stop(j);\r\nidle(j);\r\nget_ixj(arg)->intercom = -1;\r\nixj_record_stop(get_ixj(arg));\r\nixj_play_stop(get_ixj(arg));\r\nidle(get_ixj(arg));\r\nbreak;\r\ncase IXJCTL_INTERCOM_START:\r\nif(arg < 0 || arg >= IXJMAX)\r\nreturn -EINVAL;\r\nj->intercom = arg;\r\nixj_record_start(j);\r\nixj_play_start(j);\r\nget_ixj(arg)->intercom = board;\r\nixj_play_start(get_ixj(arg));\r\nixj_record_start(get_ixj(arg));\r\nbreak;\r\n}\r\nif (ixjdebug & 0x0040)\r\nprintk("phone%d ioctl end, cmd: 0x%x, arg: 0x%lx\n", minor, cmd, arg);\r\nclear_bit(board, &j->busyflags);\r\nreturn retval;\r\n}\r\nstatic long ixj_ioctl(struct file *file_p, unsigned int cmd, unsigned long arg)\r\n{\r\nlong ret;\r\nmutex_lock(&ixj_mutex);\r\nret = do_ixj_ioctl(file_p, cmd, arg);\r\nmutex_unlock(&ixj_mutex);\r\nreturn ret;\r\n}\r\nstatic int ixj_fasync(int fd, struct file *file_p, int mode)\r\n{\r\nIXJ *j = get_ixj(NUM(file_p->f_path.dentry->d_inode));\r\nreturn fasync_helper(fd, file_p, mode, &j->async_queue);\r\n}\r\nstatic int ixj_linetest(IXJ *j)\r\n{\r\nj->flags.pstncheck = 1;\r\nj->flags.pstn_present = 0;\r\ndaa_int_read(j);\r\nj->pld_slicw.bits.rly1 = 0;\r\nj->pld_slicw.bits.rly2 = 0;\r\nj->pld_slicw.bits.rly3 = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nj->pld_scrw.bits.daafsyncen = 0;\r\noutb_p(j->pld_scrw.byte, j->XILINXbase);\r\nj->pld_slicr.byte = inb_p(j->XILINXbase + 0x01);\r\nif (j->pld_slicr.bits.potspstn) {\r\nj->flags.pots_pstn = 1;\r\nj->flags.pots_correct = 0;\r\nLED_SetState(0x4, j);\r\n} else {\r\nj->flags.pots_pstn = 0;\r\nj->pld_slicw.bits.rly1 = 0;\r\nj->pld_slicw.bits.rly2 = 0;\r\nj->pld_slicw.bits.rly3 = 1;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nj->pld_scrw.bits.daafsyncen = 0;\r\noutb_p(j->pld_scrw.byte, j->XILINXbase);\r\ndaa_set_mode(j, SOP_PU_CONVERSATION);\r\nmsleep(1000);\r\ndaa_int_read(j);\r\ndaa_set_mode(j, SOP_PU_RESET);\r\nif (j->m_DAAShadowRegs.XOP_REGS.XOP.xr0.bitreg.VDD_OK) {\r\nj->flags.pots_correct = 0;\r\nLED_SetState(0x4, j);\r\nj->pld_slicw.bits.rly3 = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\n} else {\r\nj->flags.pots_correct = 1;\r\nLED_SetState(0x8, j);\r\nj->pld_slicw.bits.rly1 = 1;\r\nj->pld_slicw.bits.rly2 = 0;\r\nj->pld_slicw.bits.rly3 = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\n}\r\n}\r\nj->pld_slicw.bits.rly3 = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\ndaa_set_mode(j, SOP_PU_CONVERSATION);\r\nmsleep(1000);\r\ndaa_int_read(j);\r\ndaa_set_mode(j, SOP_PU_RESET);\r\nif (j->m_DAAShadowRegs.XOP_REGS.XOP.xr0.bitreg.VDD_OK) {\r\nj->pstn_sleeptil = jiffies + (hertz / 4);\r\nj->flags.pstn_present = 1;\r\n} else {\r\nj->flags.pstn_present = 0;\r\n}\r\nif (j->flags.pstn_present) {\r\nif (j->flags.pots_correct) {\r\nLED_SetState(0xA, j);\r\n} else {\r\nLED_SetState(0x6, j);\r\n}\r\n} else {\r\nif (j->flags.pots_correct) {\r\nLED_SetState(0x9, j);\r\n} else {\r\nLED_SetState(0x5, j);\r\n}\r\n}\r\nj->flags.pstncheck = 0;\r\nreturn j->flags.pstn_present;\r\n}\r\nstatic int ixj_selfprobe(IXJ *j)\r\n{\r\nunsigned short cmd;\r\nint cnt;\r\nBYTES bytes;\r\ninit_waitqueue_head(&j->poll_q);\r\ninit_waitqueue_head(&j->read_q);\r\ninit_waitqueue_head(&j->write_q);\r\nwhile(atomic_read(&j->DSPWrite) > 0)\r\natomic_dec(&j->DSPWrite);\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Write IDLE to Software Control Register\n");\r\nixj_WriteDSPCommand(0x0FE0, j);\r\nif (ixj_WriteDSPCommand(0x0000, j))\r\nreturn -1;\r\nif (j->ssr.low || j->ssr.high)\r\nreturn -1;\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Get Device ID Code\n");\r\nif (ixj_WriteDSPCommand(0x3400, j))\r\nreturn -1;\r\nj->dsp.low = j->ssr.low;\r\nj->dsp.high = j->ssr.high;\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Get Device Version Code\n");\r\nif (ixj_WriteDSPCommand(0x3800, j))\r\nreturn -1;\r\nj->ver.low = j->ssr.low;\r\nj->ver.high = j->ssr.high;\r\nif (!j->cardtype) {\r\nif (j->dsp.low == 0x21) {\r\nbytes.high = bytes.low = inb_p(j->XILINXbase + 0x02);\r\noutb_p(bytes.low ^ 0xFF, j->XILINXbase + 0x02);\r\nbytes.low = inb_p(j->XILINXbase + 0x02);\r\nif (bytes.low == bytes.high)\r\n{\r\nj->cardtype = QTI_PHONEJACK_LITE;\r\nif (!request_region(j->XILINXbase, 4, "ixj control")) {\r\nprintk(KERN_INFO "ixj: can't get I/O address 0x%x\n", j->XILINXbase);\r\nreturn -1;\r\n}\r\nj->pld_slicw.pcib.e1 = 1;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase);\r\n} else {\r\nj->cardtype = QTI_LINEJACK;\r\nif (!request_region(j->XILINXbase, 8, "ixj control")) {\r\nprintk(KERN_INFO "ixj: can't get I/O address 0x%x\n", j->XILINXbase);\r\nreturn -1;\r\n}\r\n}\r\n} else if (j->dsp.low == 0x22) {\r\nj->cardtype = QTI_PHONEJACK_PCI;\r\nrequest_region(j->XILINXbase, 4, "ixj control");\r\nj->pld_slicw.pcib.e1 = 1;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase);\r\n} else\r\nj->cardtype = QTI_PHONEJACK;\r\n} else {\r\nswitch (j->cardtype) {\r\ncase QTI_PHONEJACK:\r\nif (!j->dsp.low != 0x20) {\r\nj->dsp.high = 0x80;\r\nj->dsp.low = 0x20;\r\nixj_WriteDSPCommand(0x3800, j);\r\nj->ver.low = j->ssr.low;\r\nj->ver.high = j->ssr.high;\r\n}\r\nbreak;\r\ncase QTI_LINEJACK:\r\nif (!request_region(j->XILINXbase, 8, "ixj control")) {\r\nprintk(KERN_INFO "ixj: can't get I/O address 0x%x\n", j->XILINXbase);\r\nreturn -1;\r\n}\r\nbreak;\r\ncase QTI_PHONEJACK_LITE:\r\ncase QTI_PHONEJACK_PCI:\r\nif (!request_region(j->XILINXbase, 4, "ixj control")) {\r\nprintk(KERN_INFO "ixj: can't get I/O address 0x%x\n", j->XILINXbase);\r\nreturn -1;\r\n}\r\nj->pld_slicw.pcib.e1 = 1;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase);\r\nbreak;\r\ncase QTI_PHONECARD:\r\nbreak;\r\n}\r\n}\r\nif (j->dsp.low == 0x20 || j->cardtype == QTI_PHONEJACK_LITE || j->cardtype == QTI_PHONEJACK_PCI) {\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Write CODEC config to Software Control Register\n");\r\nif (ixj_WriteDSPCommand(0xC462, j))\r\nreturn -1;\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Write CODEC timing to Software Control Register\n");\r\nif (j->cardtype == QTI_PHONEJACK) {\r\ncmd = 0x9FF2;\r\n} else {\r\ncmd = 0x9FF5;\r\n}\r\nif (ixj_WriteDSPCommand(cmd, j))\r\nreturn -1;\r\n} else {\r\nif (set_base_frame(j, 30) != 30)\r\nreturn -1;\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Write CODEC config to Software Control Register\n");\r\nif (j->cardtype == QTI_PHONECARD) {\r\nif (ixj_WriteDSPCommand(0xC528, j))\r\nreturn -1;\r\n}\r\nif (j->cardtype == QTI_LINEJACK) {\r\nif (ixj_WriteDSPCommand(0xC528, j))\r\nreturn -1;\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Turn on the PLD Clock at 8Khz\n");\r\nj->pld_clock.byte = 0;\r\noutb_p(j->pld_clock.byte, j->XILINXbase + 0x04);\r\n}\r\n}\r\nif (j->dsp.low == 0x20) {\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Configure GPIO pins\n");\r\nj->gpio.bytes.high = 0x09;\r\nj->gpio.bits.gpio1 = 1;\r\nj->gpio.bits.gpio2 = 1;\r\nj->gpio.bits.gpio3 = 0;\r\nj->gpio.bits.gpio4 = 1;\r\nj->gpio.bits.gpio5 = 1;\r\nj->gpio.bits.gpio6 = 1;\r\nj->gpio.bits.gpio7 = 1;\r\nixj_WriteDSPCommand(j->gpio.word, j);\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Enable SLIC\n");\r\nj->gpio.bytes.high = 0x0B;\r\nj->gpio.bytes.low = 0x00;\r\nj->gpio.bits.gpio1 = 0;\r\nj->gpio.bits.gpio2 = 1;\r\nj->gpio.bits.gpio5 = 0;\r\nixj_WriteDSPCommand(j->gpio.word, j);\r\nj->port = PORT_POTS;\r\n} else {\r\nif (j->cardtype == QTI_LINEJACK) {\r\nLED_SetState(0x1, j);\r\nmsleep(100);\r\nLED_SetState(0x2, j);\r\nmsleep(100);\r\nLED_SetState(0x4, j);\r\nmsleep(100);\r\nLED_SetState(0x8, j);\r\nmsleep(100);\r\nLED_SetState(0x0, j);\r\ndaa_get_version(j);\r\nif (ixjdebug & 0x0002)\r\nprintk("Loading DAA Coefficients\n");\r\nDAA_Coeff_US(j);\r\nif (!ixj_daa_write(j)) {\r\nprintk("DAA write failed on board %d\n", j->board);\r\nreturn -1;\r\n}\r\nif(!ixj_daa_cid_reset(j)) {\r\nprintk("DAA CID reset failed on board %d\n", j->board);\r\nreturn -1;\r\n}\r\nj->flags.pots_correct = 0;\r\nj->flags.pstn_present = 0;\r\nixj_linetest(j);\r\nif (j->flags.pots_correct) {\r\nj->pld_scrw.bits.daafsyncen = 0;\r\noutb_p(j->pld_scrw.byte, j->XILINXbase);\r\nj->pld_slicw.bits.rly1 = 1;\r\nj->pld_slicw.bits.spken = 1;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nSLIC_SetState(PLD_SLIC_STATE_STANDBY, j);\r\nj->port = PORT_POTS;\r\n}\r\nixj_set_port(j, PORT_PSTN);\r\nixj_set_pots(j, 1);\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Enable Mixer\n");\r\nixj_mixer(0x0000, j);\r\nixj_mixer(0x0100, j);\r\nixj_mixer(0x0203, j);\r\nixj_mixer(0x0303, j);\r\nixj_mixer(0x0480, j);\r\nixj_mixer(0x0580, j);\r\nixj_mixer(0x0680, j);\r\nixj_mixer(0x0780, j);\r\nixj_mixer(0x0880, j);\r\nixj_mixer(0x0980, j);\r\nixj_mixer(0x0A80, j);\r\nixj_mixer(0x0B80, j);\r\nixj_mixer(0x0C00, j);\r\nixj_mixer(0x0D80, j);\r\nixj_mixer(0x0E80, j);\r\nixj_mixer(0x0F00, j);\r\nixj_mixer(0x1000, j);\r\nixj_mixer(0x110C, j);\r\nixj_mixer(0x1200, j);\r\nixj_mixer(0x1401, j);\r\nixj_mixer(0x1300, j);\r\nixj_mixer(0x1501, j);\r\nixj_mixer(0x1700, j);\r\nixj_mixer(0x1800, j);\r\nixj_mixer(0x1901, j);\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Setting Default US Ring Cadence Detection\n");\r\nj->cadence_f[4].state = 0;\r\nj->cadence_f[4].on1 = 0;\r\nj->cadence_f[4].off1 = 0;\r\nj->cadence_f[4].on2 = 0;\r\nj->cadence_f[4].off2 = 0;\r\nj->cadence_f[4].on3 = 0;\r\nj->cadence_f[4].off3 = 0;\r\nj->pstn_last_rmr = jiffies;\r\n} else {\r\nif (j->cardtype == QTI_PHONECARD) {\r\nixj_WriteDSPCommand(0xCF07, j);\r\nixj_WriteDSPCommand(0x00B0, j);\r\nixj_set_port(j, PORT_SPEAKER);\r\n} else {\r\nixj_set_port(j, PORT_POTS);\r\nSLIC_SetState(PLD_SLIC_STATE_STANDBY, j);\r\n}\r\n}\r\n}\r\nj->intercom = -1;\r\nj->framesread = j->frameswritten = 0;\r\nj->read_wait = j->write_wait = 0;\r\nj->rxreadycheck = j->txreadycheck = 0;\r\nif (j->cardtype == QTI_LINEJACK) {\r\nset_dtmf_prescale(j, 0x10);\r\n} else {\r\nset_dtmf_prescale(j, 0x40);\r\n}\r\nset_play_volume(j, 0x100);\r\nset_rec_volume(j, 0x100);\r\nif (ixj_WriteDSPCommand(0x0000, j))\r\nreturn -1;\r\nif (j->ssr.low || j->ssr.high)\r\nreturn -1;\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Enable Line Monitor\n");\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "Set Line Monitor to Asyncronous Mode\n");\r\nif (ixj_WriteDSPCommand(0x7E01, j))\r\nreturn -1;\r\nif (ixjdebug & 0x002)\r\nprintk(KERN_INFO "Enable DTMF Detectors\n");\r\nif (ixj_WriteDSPCommand(0x5151, j))\r\nreturn -1;\r\nif (ixj_WriteDSPCommand(0x6E01, j))\r\nreturn -1;\r\nset_rec_depth(j, 2);\r\nset_play_depth(j, 2);\r\nj->ex.bits.dtmf_ready = 0;\r\nj->dtmf_state = 0;\r\nj->dtmf_wp = j->dtmf_rp = 0;\r\nj->rec_mode = j->play_mode = -1;\r\nj->flags.ringing = 0;\r\nj->maxrings = MAXRINGS;\r\nj->ring_cadence = USA_RING_CADENCE;\r\nj->drybuffer = 0;\r\nj->winktime = 320;\r\nj->flags.dtmf_oob = 0;\r\nfor (cnt = 0; cnt < 4; cnt++)\r\nj->cadence_f[cnt].enable = 0;\r\nixj_WriteDSPCommand(0x0FE3, j);\r\nfor (cnt = 0; cnt < 35; cnt++)\r\nj->ixj_signals[cnt] = SIGIO;\r\nj->ex_sig.bits.dtmf_ready = j->ex_sig.bits.hookstate = j->ex_sig.bits.flash = j->ex_sig.bits.pstn_ring =\r\nj->ex_sig.bits.caller_id = j->ex_sig.bits.pstn_wink = j->ex_sig.bits.f0 = j->ex_sig.bits.f1 = j->ex_sig.bits.f2 =\r\nj->ex_sig.bits.f3 = j->ex_sig.bits.fc0 = j->ex_sig.bits.fc1 = j->ex_sig.bits.fc2 = j->ex_sig.bits.fc3 = 1;\r\n#ifdef IXJ_DYN_ALLOC\r\nj->fskdata = NULL;\r\n#endif\r\nj->fskdcnt = 0;\r\nj->cidcw_wait = 0;\r\nj->p.f_op = &ixj_fops;\r\nj->p.open = ixj_open;\r\nj->p.board = j->board;\r\nphone_register_device(&j->p, PHONE_UNIT_ANY);\r\nixj_init_timer(j);\r\nixj_add_timer(j);\r\nreturn 0;\r\n}\r\nIXJ *ixj_pcmcia_probe(unsigned long dsp, unsigned long xilinx)\r\n{\r\nIXJ *j = ixj_alloc();\r\nj->board = 0;\r\nj->DSPbase = dsp;\r\nj->XILINXbase = xilinx;\r\nj->cardtype = QTI_PHONECARD;\r\nixj_selfprobe(j);\r\nreturn j;\r\n}\r\nstatic int ixj_get_status_proc(char *buf)\r\n{\r\nint len;\r\nint cnt;\r\nIXJ *j;\r\nlen = 0;\r\nlen += sprintf(buf + len, "\nDriver version %i.%i.%i", IXJ_VER_MAJOR, IXJ_VER_MINOR, IXJ_BLD_VER);\r\nlen += sprintf(buf + len, "\nsizeof IXJ struct %Zd bytes", sizeof(IXJ));\r\nlen += sprintf(buf + len, "\nsizeof DAA struct %Zd bytes", sizeof(DAA_REGS));\r\nlen += sprintf(buf + len, "\nUsing old telephony API");\r\nlen += sprintf(buf + len, "\nDebug Level %d\n", ixjdebug);\r\nfor (cnt = 0; cnt < IXJMAX; cnt++) {\r\nj = get_ixj(cnt);\r\nif(j==NULL)\r\ncontinue;\r\nif (j->DSPbase) {\r\nlen += sprintf(buf + len, "\nCard Num %d", cnt);\r\nlen += sprintf(buf + len, "\nDSP Base Address 0x%4.4x", j->DSPbase);\r\nif (j->cardtype != QTI_PHONEJACK)\r\nlen += sprintf(buf + len, "\nXILINX Base Address 0x%4.4x", j->XILINXbase);\r\nlen += sprintf(buf + len, "\nDSP Type %2.2x%2.2x", j->dsp.high, j->dsp.low);\r\nlen += sprintf(buf + len, "\nDSP Version %2.2x.%2.2x", j->ver.high, j->ver.low);\r\nlen += sprintf(buf + len, "\nSerial Number %8.8x", j->serial);\r\nswitch (j->cardtype) {\r\ncase (QTI_PHONEJACK):\r\nlen += sprintf(buf + len, "\nCard Type = Internet PhoneJACK");\r\nbreak;\r\ncase (QTI_LINEJACK):\r\nlen += sprintf(buf + len, "\nCard Type = Internet LineJACK");\r\nif (j->flags.g729_loaded)\r\nlen += sprintf(buf + len, " w/G.729 A/B");\r\nlen += sprintf(buf + len, " Country = %d", j->daa_country);\r\nbreak;\r\ncase (QTI_PHONEJACK_LITE):\r\nlen += sprintf(buf + len, "\nCard Type = Internet PhoneJACK Lite");\r\nif (j->flags.g729_loaded)\r\nlen += sprintf(buf + len, " w/G.729 A/B");\r\nbreak;\r\ncase (QTI_PHONEJACK_PCI):\r\nlen += sprintf(buf + len, "\nCard Type = Internet PhoneJACK PCI");\r\nif (j->flags.g729_loaded)\r\nlen += sprintf(buf + len, " w/G.729 A/B");\r\nbreak;\r\ncase (QTI_PHONECARD):\r\nlen += sprintf(buf + len, "\nCard Type = Internet PhoneCARD");\r\nif (j->flags.g729_loaded)\r\nlen += sprintf(buf + len, " w/G.729 A/B");\r\nlen += sprintf(buf + len, "\nSmart Cable %spresent", j->pccr1.bits.drf ? "not " : "");\r\nif (!j->pccr1.bits.drf)\r\nlen += sprintf(buf + len, "\nSmart Cable type %d", j->flags.pcmciasct);\r\nlen += sprintf(buf + len, "\nSmart Cable state %d", j->flags.pcmciastate);\r\nbreak;\r\ndefault:\r\nlen += sprintf(buf + len, "\nCard Type = %d", j->cardtype);\r\nbreak;\r\n}\r\nlen += sprintf(buf + len, "\nReaders %d", j->readers);\r\nlen += sprintf(buf + len, "\nWriters %d", j->writers);\r\nadd_caps(j);\r\nlen += sprintf(buf + len, "\nCapabilities %d", j->caps);\r\nif (j->dsp.low != 0x20)\r\nlen += sprintf(buf + len, "\nDSP Processor load %d", j->proc_load);\r\nif (j->flags.cidsent)\r\nlen += sprintf(buf + len, "\nCaller ID data sent");\r\nelse\r\nlen += sprintf(buf + len, "\nCaller ID data not sent");\r\nlen += sprintf(buf + len, "\nPlay CODEC ");\r\nswitch (j->play_codec) {\r\ncase G723_63:\r\nlen += sprintf(buf + len, "G.723.1 6.3");\r\nbreak;\r\ncase G723_53:\r\nlen += sprintf(buf + len, "G.723.1 5.3");\r\nbreak;\r\ncase TS85:\r\nlen += sprintf(buf + len, "TrueSpeech 8.5");\r\nbreak;\r\ncase TS48:\r\nlen += sprintf(buf + len, "TrueSpeech 4.8");\r\nbreak;\r\ncase TS41:\r\nlen += sprintf(buf + len, "TrueSpeech 4.1");\r\nbreak;\r\ncase G728:\r\nlen += sprintf(buf + len, "G.728");\r\nbreak;\r\ncase G729:\r\nlen += sprintf(buf + len, "G.729");\r\nbreak;\r\ncase G729B:\r\nlen += sprintf(buf + len, "G.729B");\r\nbreak;\r\ncase ULAW:\r\nlen += sprintf(buf + len, "uLaw");\r\nbreak;\r\ncase ALAW:\r\nlen += sprintf(buf + len, "aLaw");\r\nbreak;\r\ncase LINEAR16:\r\nlen += sprintf(buf + len, "16 bit Linear");\r\nbreak;\r\ncase LINEAR8:\r\nlen += sprintf(buf + len, "8 bit Linear");\r\nbreak;\r\ncase WSS:\r\nlen += sprintf(buf + len, "Windows Sound System");\r\nbreak;\r\ndefault:\r\nlen += sprintf(buf + len, "NO CODEC CHOSEN");\r\nbreak;\r\n}\r\nlen += sprintf(buf + len, "\nRecord CODEC ");\r\nswitch (j->rec_codec) {\r\ncase G723_63:\r\nlen += sprintf(buf + len, "G.723.1 6.3");\r\nbreak;\r\ncase G723_53:\r\nlen += sprintf(buf + len, "G.723.1 5.3");\r\nbreak;\r\ncase TS85:\r\nlen += sprintf(buf + len, "TrueSpeech 8.5");\r\nbreak;\r\ncase TS48:\r\nlen += sprintf(buf + len, "TrueSpeech 4.8");\r\nbreak;\r\ncase TS41:\r\nlen += sprintf(buf + len, "TrueSpeech 4.1");\r\nbreak;\r\ncase G728:\r\nlen += sprintf(buf + len, "G.728");\r\nbreak;\r\ncase G729:\r\nlen += sprintf(buf + len, "G.729");\r\nbreak;\r\ncase G729B:\r\nlen += sprintf(buf + len, "G.729B");\r\nbreak;\r\ncase ULAW:\r\nlen += sprintf(buf + len, "uLaw");\r\nbreak;\r\ncase ALAW:\r\nlen += sprintf(buf + len, "aLaw");\r\nbreak;\r\ncase LINEAR16:\r\nlen += sprintf(buf + len, "16 bit Linear");\r\nbreak;\r\ncase LINEAR8:\r\nlen += sprintf(buf + len, "8 bit Linear");\r\nbreak;\r\ncase WSS:\r\nlen += sprintf(buf + len, "Windows Sound System");\r\nbreak;\r\ndefault:\r\nlen += sprintf(buf + len, "NO CODEC CHOSEN");\r\nbreak;\r\n}\r\nlen += sprintf(buf + len, "\nAEC ");\r\nswitch (j->aec_level) {\r\ncase AEC_OFF:\r\nlen += sprintf(buf + len, "Off");\r\nbreak;\r\ncase AEC_LOW:\r\nlen += sprintf(buf + len, "Low");\r\nbreak;\r\ncase AEC_MED:\r\nlen += sprintf(buf + len, "Med");\r\nbreak;\r\ncase AEC_HIGH:\r\nlen += sprintf(buf + len, "High");\r\nbreak;\r\ncase AEC_AUTO:\r\nlen += sprintf(buf + len, "Auto");\r\nbreak;\r\ncase AEC_AGC:\r\nlen += sprintf(buf + len, "AEC/AGC");\r\nbreak;\r\ndefault:\r\nlen += sprintf(buf + len, "unknown(%i)", j->aec_level);\r\nbreak;\r\n}\r\nlen += sprintf(buf + len, "\nRec volume 0x%x", get_rec_volume(j));\r\nlen += sprintf(buf + len, "\nPlay volume 0x%x", get_play_volume(j));\r\nlen += sprintf(buf + len, "\nDTMF prescale 0x%x", get_dtmf_prescale(j));\r\nlen += sprintf(buf + len, "\nHook state %d", j->hookstate);\r\nif (j->cardtype == QTI_LINEJACK) {\r\nlen += sprintf(buf + len, "\nPOTS Correct %d", j->flags.pots_correct);\r\nlen += sprintf(buf + len, "\nPSTN Present %d", j->flags.pstn_present);\r\nlen += sprintf(buf + len, "\nPSTN Check %d", j->flags.pstncheck);\r\nlen += sprintf(buf + len, "\nPOTS to PSTN %d", j->flags.pots_pstn);\r\nswitch (j->daa_mode) {\r\ncase SOP_PU_SLEEP:\r\nlen += sprintf(buf + len, "\nDAA PSTN On Hook");\r\nbreak;\r\ncase SOP_PU_RINGING:\r\nlen += sprintf(buf + len, "\nDAA PSTN Ringing");\r\nlen += sprintf(buf + len, "\nRinging state = %d", j->cadence_f[4].state);\r\nbreak;\r\ncase SOP_PU_CONVERSATION:\r\nlen += sprintf(buf + len, "\nDAA PSTN Off Hook");\r\nbreak;\r\ncase SOP_PU_PULSEDIALING:\r\nlen += sprintf(buf + len, "\nDAA PSTN Pulse Dialing");\r\nbreak;\r\n}\r\nlen += sprintf(buf + len, "\nDAA RMR = %d", j->m_DAAShadowRegs.SOP_REGS.SOP.cr1.bitreg.RMR);\r\nlen += sprintf(buf + len, "\nDAA VDD OK = %d", j->m_DAAShadowRegs.XOP_REGS.XOP.xr0.bitreg.VDD_OK);\r\nlen += sprintf(buf + len, "\nDAA CR0 = 0x%02x", j->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg);\r\nlen += sprintf(buf + len, "\nDAA CR1 = 0x%02x", j->m_DAAShadowRegs.SOP_REGS.SOP.cr1.reg);\r\nlen += sprintf(buf + len, "\nDAA CR2 = 0x%02x", j->m_DAAShadowRegs.SOP_REGS.SOP.cr2.reg);\r\nlen += sprintf(buf + len, "\nDAA CR3 = 0x%02x", j->m_DAAShadowRegs.SOP_REGS.SOP.cr3.reg);\r\nlen += sprintf(buf + len, "\nDAA CR4 = 0x%02x", j->m_DAAShadowRegs.SOP_REGS.SOP.cr4.reg);\r\nlen += sprintf(buf + len, "\nDAA CR5 = 0x%02x", j->m_DAAShadowRegs.SOP_REGS.SOP.cr5.reg);\r\nlen += sprintf(buf + len, "\nDAA XR0 = 0x%02x", j->m_DAAShadowRegs.XOP_REGS.XOP.xr0.reg);\r\nlen += sprintf(buf + len, "\nDAA ringstop %ld - jiffies %ld", j->pstn_ring_stop, jiffies);\r\n}\r\nswitch (j->port) {\r\ncase PORT_POTS:\r\nlen += sprintf(buf + len, "\nPort POTS");\r\nbreak;\r\ncase PORT_PSTN:\r\nlen += sprintf(buf + len, "\nPort PSTN");\r\nbreak;\r\ncase PORT_SPEAKER:\r\nlen += sprintf(buf + len, "\nPort SPEAKER/MIC");\r\nbreak;\r\ncase PORT_HANDSET:\r\nlen += sprintf(buf + len, "\nPort HANDSET");\r\nbreak;\r\n}\r\nif (j->dsp.low == 0x21 || j->dsp.low == 0x22) {\r\nlen += sprintf(buf + len, "\nSLIC state ");\r\nswitch (SLIC_GetState(j)) {\r\ncase PLD_SLIC_STATE_OC:\r\nlen += sprintf(buf + len, "OC");\r\nbreak;\r\ncase PLD_SLIC_STATE_RINGING:\r\nlen += sprintf(buf + len, "RINGING");\r\nbreak;\r\ncase PLD_SLIC_STATE_ACTIVE:\r\nlen += sprintf(buf + len, "ACTIVE");\r\nbreak;\r\ncase PLD_SLIC_STATE_OHT:\r\nlen += sprintf(buf + len, "OHT");\r\nbreak;\r\ncase PLD_SLIC_STATE_TIPOPEN:\r\nlen += sprintf(buf + len, "TIPOPEN");\r\nbreak;\r\ncase PLD_SLIC_STATE_STANDBY:\r\nlen += sprintf(buf + len, "STANDBY");\r\nbreak;\r\ncase PLD_SLIC_STATE_APR:\r\nlen += sprintf(buf + len, "APR");\r\nbreak;\r\ncase PLD_SLIC_STATE_OHTPR:\r\nlen += sprintf(buf + len, "OHTPR");\r\nbreak;\r\ndefault:\r\nlen += sprintf(buf + len, "%d", SLIC_GetState(j));\r\nbreak;\r\n}\r\n}\r\nlen += sprintf(buf + len, "\nBase Frame %2.2x.%2.2x", j->baseframe.high, j->baseframe.low);\r\nlen += sprintf(buf + len, "\nCID Base Frame %2d", j->cid_base_frame_size);\r\n#ifdef PERFMON_STATS\r\nlen += sprintf(buf + len, "\nTimer Checks %ld", j->timerchecks);\r\nlen += sprintf(buf + len, "\nRX Ready Checks %ld", j->rxreadycheck);\r\nlen += sprintf(buf + len, "\nTX Ready Checks %ld", j->txreadycheck);\r\nlen += sprintf(buf + len, "\nFrames Read %ld", j->framesread);\r\nlen += sprintf(buf + len, "\nFrames Written %ld", j->frameswritten);\r\nlen += sprintf(buf + len, "\nDry Buffer %ld", j->drybuffer);\r\nlen += sprintf(buf + len, "\nRead Waits %ld", j->read_wait);\r\nlen += sprintf(buf + len, "\nWrite Waits %ld", j->write_wait);\r\nlen += sprintf(buf + len, "\nStatus Waits %ld", j->statuswait);\r\nlen += sprintf(buf + len, "\nStatus Wait Fails %ld", j->statuswaitfail);\r\nlen += sprintf(buf + len, "\nPControl Waits %ld", j->pcontrolwait);\r\nlen += sprintf(buf + len, "\nPControl Wait Fails %ld", j->pcontrolwaitfail);\r\nlen += sprintf(buf + len, "\nIs Control Ready Checks %ld", j->iscontrolready);\r\nlen += sprintf(buf + len, "\nIs Control Ready Check failures %ld", j->iscontrolreadyfail);\r\n#endif\r\nlen += sprintf(buf + len, "\n");\r\n}\r\n}\r\nreturn len;\r\n}\r\nstatic int ixj_read_proc(char *page, char **start, off_t off,\r\nint count, int *eof, void *data)\r\n{\r\nint len = ixj_get_status_proc(page);\r\nif (len <= off+count) *eof = 1;\r\n*start = page + off;\r\nlen -= off;\r\nif (len>count) len = count;\r\nif (len<0) len = 0;\r\nreturn len;\r\n}\r\nstatic void cleanup(void)\r\n{\r\nint cnt;\r\nIXJ *j;\r\nfor (cnt = 0; cnt < IXJMAX; cnt++) {\r\nj = get_ixj(cnt);\r\nif(j != NULL && j->DSPbase) {\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "IXJ: Deleting timer for /dev/phone%d\n", cnt);\r\ndel_timer(&j->timer);\r\nif (j->cardtype == QTI_LINEJACK) {\r\nj->pld_scrw.bits.daafsyncen = 0;\r\noutb_p(j->pld_scrw.byte, j->XILINXbase);\r\nj->pld_slicw.bits.rly1 = 0;\r\nj->pld_slicw.bits.rly2 = 0;\r\nj->pld_slicw.bits.rly3 = 0;\r\noutb_p(j->pld_slicw.byte, j->XILINXbase + 0x01);\r\nLED_SetState(0x0, j);\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "IXJ: Releasing XILINX address for /dev/phone%d\n", cnt);\r\nrelease_region(j->XILINXbase, 8);\r\n} else if (j->cardtype == QTI_PHONEJACK_LITE || j->cardtype == QTI_PHONEJACK_PCI) {\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "IXJ: Releasing XILINX address for /dev/phone%d\n", cnt);\r\nrelease_region(j->XILINXbase, 4);\r\n}\r\nkfree(j->read_buffer);\r\nkfree(j->write_buffer);\r\nif (j->dev)\r\npnp_device_detach(j->dev);\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "IXJ: Unregistering /dev/phone%d from LTAPI\n", cnt);\r\nphone_unregister_device(&j->p);\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "IXJ: Releasing DSP address for /dev/phone%d\n", cnt);\r\nrelease_region(j->DSPbase, 16);\r\n#ifdef IXJ_DYN_ALLOC\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "IXJ: Freeing memory for /dev/phone%d\n", cnt);\r\nkfree(j);\r\nixj[cnt] = NULL;\r\n#endif\r\n}\r\n}\r\nif (ixjdebug & 0x0002)\r\nprintk(KERN_INFO "IXJ: Removing /proc/ixj\n");\r\nremove_proc_entry ("ixj", NULL);\r\n}\r\nstatic void PCIEE_WriteBit(WORD wEEPROMAddress, BYTE lastLCC, BYTE byData)\r\n{\r\nlastLCC = lastLCC & 0xfb;\r\nlastLCC = lastLCC | (byData ? 4 : 0);\r\noutb(lastLCC, wEEPROMAddress);\r\nmdelay(1);\r\nlastLCC = lastLCC | 0x01;\r\noutb(lastLCC, wEEPROMAddress);\r\nbyData = byData << 1;\r\nlastLCC = lastLCC & 0xfe;\r\nmdelay(1);\r\noutb(lastLCC, wEEPROMAddress);\r\n}\r\nstatic BYTE PCIEE_ReadBit(WORD wEEPROMAddress, BYTE lastLCC)\r\n{\r\nmdelay(1);\r\nlastLCC = lastLCC | 0x01;\r\noutb(lastLCC, wEEPROMAddress);\r\nlastLCC = lastLCC & 0xfe;\r\nmdelay(1);\r\noutb(lastLCC, wEEPROMAddress);\r\nreturn ((inb(wEEPROMAddress) >> 3) & 1);\r\n}\r\nstatic bool PCIEE_ReadWord(WORD wAddress, WORD wLoc, WORD * pwResult)\r\n{\r\nBYTE lastLCC;\r\nWORD wEEPROMAddress = wAddress + 3;\r\nDWORD i;\r\nBYTE byResult;\r\n*pwResult = 0;\r\nlastLCC = inb(wEEPROMAddress);\r\nlastLCC = lastLCC | 0x02;\r\nlastLCC = lastLCC & 0xfe;\r\noutb(lastLCC, wEEPROMAddress);\r\nmdelay(1);\r\nPCIEE_WriteBit(wEEPROMAddress, lastLCC, 1);\r\nPCIEE_WriteBit(wEEPROMAddress, lastLCC, 1);\r\nPCIEE_WriteBit(wEEPROMAddress, lastLCC, 0);\r\nfor (i = 0; i < 8; i++) {\r\nPCIEE_WriteBit(wEEPROMAddress, lastLCC, wLoc & 0x80 ? 1 : 0);\r\nwLoc <<= 1;\r\n}\r\nfor (i = 0; i < 16; i++) {\r\nbyResult = PCIEE_ReadBit(wEEPROMAddress, lastLCC);\r\n*pwResult = (*pwResult << 1) | byResult;\r\n}\r\nmdelay(1);\r\nlastLCC = lastLCC & 0xfd;\r\noutb(lastLCC, wEEPROMAddress);\r\nreturn 0;\r\n}\r\nstatic DWORD PCIEE_GetSerialNumber(WORD wAddress)\r\n{\r\nWORD wLo, wHi;\r\nif (PCIEE_ReadWord(wAddress, 62, &wLo))\r\nreturn 0;\r\nif (PCIEE_ReadWord(wAddress, 63, &wHi))\r\nreturn 0;\r\nreturn (((DWORD) wHi << 16) | wLo);\r\n}\r\nstatic void __exit ixj_exit(void)\r\n{\r\ncleanup();\r\n}\r\nstatic IXJ *new_ixj(unsigned long port)\r\n{\r\nIXJ *res;\r\nif (!request_region(port, 16, "ixj DSP")) {\r\nprintk(KERN_INFO "ixj: can't get I/O address 0x%lx\n", port);\r\nreturn NULL;\r\n}\r\nres = ixj_alloc();\r\nif (!res) {\r\nrelease_region(port, 16);\r\nprintk(KERN_INFO "ixj: out of memory\n");\r\nreturn NULL;\r\n}\r\nres->DSPbase = port;\r\nreturn res;\r\n}\r\nstatic int __init ixj_probe_isapnp(int *cnt)\r\n{\r\nint probe = 0;\r\nint func = 0x110;\r\nstruct pnp_dev *dev = NULL, *old_dev = NULL;\r\nwhile (1) {\r\ndo {\r\nIXJ *j;\r\nint result;\r\nold_dev = dev;\r\ndev = pnp_find_dev(NULL, ISAPNP_VENDOR('Q', 'T', 'I'),\r\nISAPNP_FUNCTION(func), old_dev);\r\nif (!dev || !dev->card)\r\nbreak;\r\nresult = pnp_device_attach(dev);\r\nif (result < 0) {\r\nprintk("pnp attach failed %d \n", result);\r\nbreak;\r\n}\r\nif (pnp_activate_dev(dev) < 0) {\r\nprintk("pnp activate failed (out of resources?)\n");\r\npnp_device_detach(dev);\r\nreturn -ENOMEM;\r\n}\r\nif (!pnp_port_valid(dev, 0)) {\r\npnp_device_detach(dev);\r\nreturn -ENODEV;\r\n}\r\nj = new_ixj(pnp_port_start(dev, 0));\r\nif (!j)\r\nbreak;\r\nif (func != 0x110)\r\nj->XILINXbase = pnp_port_start(dev, 1);\r\nswitch (func) {\r\ncase (0x110):\r\nj->cardtype = QTI_PHONEJACK;\r\nbreak;\r\ncase (0x310):\r\nj->cardtype = QTI_LINEJACK;\r\nbreak;\r\ncase (0x410):\r\nj->cardtype = QTI_PHONEJACK_LITE;\r\nbreak;\r\n}\r\nj->board = *cnt;\r\nprobe = ixj_selfprobe(j);\r\nif(!probe) {\r\nj->serial = dev->card->serial;\r\nj->dev = dev;\r\nswitch (func) {\r\ncase 0x110:\r\nprintk(KERN_INFO "ixj: found Internet PhoneJACK at 0x%x\n", j->DSPbase);\r\nbreak;\r\ncase 0x310:\r\nprintk(KERN_INFO "ixj: found Internet LineJACK at 0x%x\n", j->DSPbase);\r\nbreak;\r\ncase 0x410:\r\nprintk(KERN_INFO "ixj: found Internet PhoneJACK Lite at 0x%x\n", j->DSPbase);\r\nbreak;\r\n}\r\n}\r\n++*cnt;\r\n} while (dev);\r\nif (func == 0x410)\r\nbreak;\r\nif (func == 0x310)\r\nfunc = 0x410;\r\nif (func == 0x110)\r\nfunc = 0x310;\r\ndev = NULL;\r\n}\r\nreturn probe;\r\n}\r\nstatic int __init ixj_probe_isa(int *cnt)\r\n{\r\nint i, probe;\r\nfor (i = 0; i < IXJMAX; i++) {\r\nif (dspio[i]) {\r\nIXJ *j = new_ixj(dspio[i]);\r\nif (!j)\r\nbreak;\r\nj->XILINXbase = xio[i];\r\nj->cardtype = 0;\r\nj->board = *cnt;\r\nprobe = ixj_selfprobe(j);\r\nj->dev = NULL;\r\n++*cnt;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init ixj_probe_pci(int *cnt)\r\n{\r\nstruct pci_dev *pci = NULL;\r\nint i, probe = 0;\r\nIXJ *j = NULL;\r\nfor (i = 0; i < IXJMAX - *cnt; i++) {\r\npci = pci_get_device(PCI_VENDOR_ID_QUICKNET,\r\nPCI_DEVICE_ID_QUICKNET_XJ, pci);\r\nif (!pci)\r\nbreak;\r\nif (pci_enable_device(pci))\r\nbreak;\r\nj = new_ixj(pci_resource_start(pci, 0));\r\nif (!j)\r\nbreak;\r\nj->serial = (PCIEE_GetSerialNumber)pci_resource_start(pci, 2);\r\nj->XILINXbase = j->DSPbase + 0x10;\r\nj->cardtype = QTI_PHONEJACK_PCI;\r\nj->board = *cnt;\r\nprobe = ixj_selfprobe(j);\r\nif (!probe)\r\nprintk(KERN_INFO "ixj: found Internet PhoneJACK PCI at 0x%x\n", j->DSPbase);\r\n++*cnt;\r\n}\r\npci_dev_put(pci);\r\nreturn probe;\r\n}\r\nstatic int __init ixj_init(void)\r\n{\r\nint cnt = 0;\r\nint probe = 0;\r\ncnt = 0;\r\nif ((probe = ixj_probe_isapnp(&cnt)) < 0) {\r\nreturn probe;\r\n}\r\nif ((probe = ixj_probe_isa(&cnt)) < 0) {\r\nreturn probe;\r\n}\r\nif ((probe = ixj_probe_pci(&cnt)) < 0) {\r\nreturn probe;\r\n}\r\nprintk(KERN_INFO "ixj driver initialized.\n");\r\ncreate_proc_read_entry ("ixj", 0, NULL, ixj_read_proc, NULL);\r\nreturn probe;\r\n}\r\nstatic void DAA_Coeff_US(IXJ *j)\r\n{\r\nint i;\r\nj->daa_country = DAA_US;\r\nfor (i = 0; i < ALISDAA_CALLERID_SIZE; i++) {\r\nj->m_DAAShadowRegs.CAO_REGS.CAO.CallerID[i] = 0;\r\n}\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[7] = 0x03;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[6] = 0x4B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[5] = 0x5D;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[4] = 0xCD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[3] = 0x24;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[2] = 0xC5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[1] = 0xA0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[0] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[7] = 0x71;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[6] = 0x1A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[5] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[4] = 0x0A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[3] = 0xB5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[2] = 0x33;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[1] = 0xE0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[7] = 0x05;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[6] = 0xA3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[5] = 0x72;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[4] = 0x34;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[3] = 0x3F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[2] = 0x3B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[1] = 0x30;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[7] = 0x05;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[6] = 0x87;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[5] = 0xF9;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[4] = 0x3E;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[3] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[2] = 0xDA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[1] = 0xB0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[3] = 0x41;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[2] = 0xB5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[1] = 0xDD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[0] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[3] = 0x25;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[2] = 0xC7;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[1] = 0x10;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[0] = 0xD6;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[7] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[6] = 0x42;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[5] = 0x48;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[4] = 0x81;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[3] = 0xA5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[2] = 0x80;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[1] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[0] = 0x98;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[7] = 0x02;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[6] = 0xA2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[5] = 0x2B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[4] = 0xB0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[3] = 0xE8;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[2] = 0xAB;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[1] = 0x81;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[0] = 0xCC;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[7] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[6] = 0x88;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[5] = 0xD2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[4] = 0x24;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[3] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[2] = 0xA9;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[1] = 0x3B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[0] = 0xA6;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[7] = 0x1B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[6] = 0x3C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[5] = 0x93;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[4] = 0x3A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[3] = 0x22;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[2] = 0x12;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[1] = 0xA3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[0] = 0x23;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[7] = 0x12;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[6] = 0xA2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[5] = 0xA6;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[4] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[3] = 0x22;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[2] = 0x7A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[1] = 0x0A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[0] = 0xD5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[3] = 0xAA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[2] = 0x35;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[1] = 0x0F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[0] = 0x8E;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[7] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[6] = 0x0E;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[5] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[4] = 0x09;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[3] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[2] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[1] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[0] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[7] = 0xFD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[6] = 0xB5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[5] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[4] = 0x07;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[3] = 0xDA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[2] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[1] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[0] = 0x00;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg = 0xFF;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr1.reg = 0x05;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr2.reg = 0x04;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr3.reg = 0x00;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr4.reg = 0x02;\r\nj->m_DAAShadowRegs.XOP_xr0_W.reg = 0x02;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr1.reg = 0x3C;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr2.reg = 0x7D;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr3.reg = 0x3B;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr4.reg = 0x00;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr5.reg = 0x22;\r\nj->m_DAAShadowRegs.XOP_xr6_W.reg = 0x00;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr7.reg = 0x40;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[3] = 0x11;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[2] = 0xB3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[1] = 0x5A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[0] = 0x2C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[3] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[2] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[1] = 0x52;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[0] = 0xB3;\r\n}\r\nstatic void DAA_Coeff_UK(IXJ *j)\r\n{\r\nint i;\r\nj->daa_country = DAA_UK;\r\nfor (i = 0; i < ALISDAA_CALLERID_SIZE; i++) {\r\nj->m_DAAShadowRegs.CAO_REGS.CAO.CallerID[i] = 0;\r\n}\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[7] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[6] = 0xC2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[5] = 0xBB;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[4] = 0xA8;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[3] = 0xCB;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[2] = 0x81;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[1] = 0xA0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[0] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[7] = 0x40;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[6] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[5] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[4] = 0x0A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[3] = 0xA4;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[2] = 0x33;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[1] = 0xE0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[7] = 0x07;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[6] = 0x9B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[5] = 0xED;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[4] = 0x24;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[3] = 0xB2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[2] = 0xA2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[1] = 0xA0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[7] = 0x0F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[6] = 0x92;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[5] = 0xF2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[4] = 0xB2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[3] = 0x87;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[2] = 0xD2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[1] = 0x30;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[3] = 0x1B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[2] = 0xA5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[1] = 0xDD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[0] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[3] = 0xE2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[2] = 0x27;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[1] = 0x10;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[0] = 0xD6;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[7] = 0x80;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[6] = 0x2D;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[5] = 0x38;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[4] = 0x8B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[3] = 0xD0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[2] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[1] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[0] = 0x98;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[7] = 0x02;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[6] = 0x5A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[5] = 0x53;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[4] = 0xF0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[3] = 0x0B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[2] = 0x5F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[1] = 0x84;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[0] = 0xD4;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[7] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[6] = 0x88;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[5] = 0x6A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[4] = 0xA4;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[3] = 0x8F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[2] = 0x52;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[1] = 0xF5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[0] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[7] = 0x1B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[6] = 0x3C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[5] = 0x93;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[4] = 0x3A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[3] = 0x22;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[2] = 0x12;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[1] = 0xA3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[0] = 0x23;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[7] = 0x12;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[6] = 0xA2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[5] = 0xA6;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[4] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[3] = 0x22;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[2] = 0x7A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[1] = 0x0A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[0] = 0xD5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[3] = 0xAA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[2] = 0x35;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[1] = 0x0F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[0] = 0x8E;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[7] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[6] = 0x0E;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[5] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[4] = 0x09;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[3] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[2] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[1] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[0] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[7] = 0xFD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[6] = 0xB5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[5] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[4] = 0x07;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[3] = 0xDA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[2] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[1] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[0] = 0x00;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg = 0xFF;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr1.reg = 0x05;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr2.reg = 0x04;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr3.reg = 0x00;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr4.reg = 0x02;\r\nj->m_DAAShadowRegs.XOP_xr0_W.reg = 0x02;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr1.reg = 0x1C;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr2.reg = 0x7D;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr3.reg = 0x36;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr4.reg = 0x00;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr5.reg = 0x22;\r\nj->m_DAAShadowRegs.XOP_xr6_W.reg = 0x00;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr7.reg = 0x46;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[3] = 0x11;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[2] = 0xB3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[1] = 0x5A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[0] = 0x2C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[3] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[2] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[1] = 0x52;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[0] = 0xB3;\r\n}\r\nstatic void DAA_Coeff_France(IXJ *j)\r\n{\r\nint i;\r\nj->daa_country = DAA_FRANCE;\r\nfor (i = 0; i < ALISDAA_CALLERID_SIZE; i++) {\r\nj->m_DAAShadowRegs.CAO_REGS.CAO.CallerID[i] = 0;\r\n}\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[7] = 0x02;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[6] = 0xA2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[5] = 0x43;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[4] = 0x2C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[3] = 0x22;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[2] = 0xAF;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[1] = 0xA0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[0] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[7] = 0x67;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[6] = 0xCE;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[5] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[4] = 0x2C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[3] = 0x22;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[2] = 0x33;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[1] = 0xE0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[7] = 0x07;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[6] = 0x9A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[5] = 0x28;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[4] = 0xF6;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[3] = 0x23;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[2] = 0x4A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[1] = 0xB0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[7] = 0x03;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[6] = 0x8F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[5] = 0xF9;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[4] = 0x2F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[3] = 0x9E;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[2] = 0xFA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[1] = 0x20;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[3] = 0x16;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[2] = 0xB5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[1] = 0xDD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[0] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[3] = 0xE2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[2] = 0xC7;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[1] = 0x10;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[0] = 0xD6;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[7] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[6] = 0x42;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[5] = 0x48;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[4] = 0x81;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[3] = 0xA6;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[2] = 0x80;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[1] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[0] = 0x98;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[7] = 0x02;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[6] = 0xAC;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[5] = 0x2A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[4] = 0x30;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[3] = 0x78;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[2] = 0xAC;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[1] = 0x8A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[0] = 0x2C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[7] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[6] = 0x88;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[5] = 0xDA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[4] = 0xA5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[3] = 0x22;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[2] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[1] = 0x2C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[0] = 0x45;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[7] = 0x1B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[6] = 0x3C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[5] = 0x93;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[4] = 0x3A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[3] = 0x22;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[2] = 0x12;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[1] = 0xA3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[0] = 0x23;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[7] = 0x12;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[6] = 0xA2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[5] = 0xA6;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[4] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[3] = 0x22;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[2] = 0x7A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[1] = 0x0A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[0] = 0xD5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[3] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[2] = 0x45;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[1] = 0xB5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[0] = 0x84;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[7] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[6] = 0x0E;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[5] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[4] = 0x09;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[3] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[2] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[1] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[0] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[7] = 0xFD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[6] = 0xB5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[5] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[4] = 0x07;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[3] = 0xDA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[2] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[1] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[0] = 0x00;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg = 0xFF;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr1.reg = 0x05;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr2.reg = 0x04;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr3.reg = 0x00;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr4.reg = 0x02;\r\nj->m_DAAShadowRegs.XOP_xr0_W.reg = 0x02;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr1.reg = 0x1C;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr2.reg = 0x7D;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr3.reg = 0x36;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr4.reg = 0x00;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr5.reg = 0x22;\r\nj->m_DAAShadowRegs.XOP_xr6_W.reg = 0x00;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr7.reg = 0x46;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[3] = 0x11;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[2] = 0xB3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[1] = 0x5A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[0] = 0x2C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[3] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[2] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[1] = 0x52;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[0] = 0xB3;\r\n}\r\nstatic void DAA_Coeff_Germany(IXJ *j)\r\n{\r\nint i;\r\nj->daa_country = DAA_GERMANY;\r\nfor (i = 0; i < ALISDAA_CALLERID_SIZE; i++) {\r\nj->m_DAAShadowRegs.CAO_REGS.CAO.CallerID[i] = 0;\r\n}\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[7] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[6] = 0xCE;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[5] = 0xBB;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[4] = 0xB8;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[3] = 0xD2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[2] = 0x81;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[1] = 0xB0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[0] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[7] = 0x45;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[6] = 0x8F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[5] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[4] = 0x0C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[3] = 0xD2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[2] = 0x3A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[1] = 0xD0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[7] = 0x07;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[6] = 0xAA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[5] = 0xE2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[4] = 0x34;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[3] = 0x24;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[2] = 0x89;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[1] = 0x20;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[7] = 0x02;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[6] = 0x87;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[5] = 0xFA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[4] = 0x37;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[3] = 0x9A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[2] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[1] = 0xB0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[3] = 0x72;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[2] = 0xD5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[1] = 0xDD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[0] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[3] = 0x72;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[2] = 0x42;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[1] = 0x13;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[0] = 0x4B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[7] = 0x80;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[6] = 0x52;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[5] = 0x48;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[4] = 0x81;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[3] = 0xAD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[2] = 0x80;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[1] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[0] = 0x98;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[7] = 0x02;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[6] = 0x42;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[5] = 0x5A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[4] = 0x20;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[3] = 0xE8;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[2] = 0x1A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[1] = 0x81;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[0] = 0x27;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[7] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[6] = 0x88;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[5] = 0x63;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[4] = 0x26;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[3] = 0xBD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[2] = 0x4B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[1] = 0xA3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[0] = 0xC2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[7] = 0x1B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[6] = 0x3B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[5] = 0x9B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[4] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[3] = 0xD4;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[2] = 0x1C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[1] = 0xB3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[0] = 0x23;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[7] = 0x13;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[6] = 0x42;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[5] = 0xA6;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[4] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[3] = 0xD4;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[2] = 0x73;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[1] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[0] = 0xD5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[3] = 0xB2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[2] = 0x45;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[1] = 0x0F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[0] = 0x8E;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[7] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[6] = 0x0E;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[5] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[4] = 0x09;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[3] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[2] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[1] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[0] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[7] = 0xFD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[6] = 0xB5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[5] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[4] = 0x07;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[3] = 0xDA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[2] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[1] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[0] = 0x00;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg = 0xFF;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr1.reg = 0x05;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr2.reg = 0x04;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr3.reg = 0x00;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr4.reg = 0x02;\r\nj->m_DAAShadowRegs.XOP_xr0_W.reg = 0x02;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr1.reg = 0x1C;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr2.reg = 0x7D;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr3.reg = 0x32;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr4.reg = 0x00;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr5.reg = 0x22;\r\nj->m_DAAShadowRegs.XOP_xr6_W.reg = 0x00;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr7.reg = 0x40;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[3] = 0x11;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[2] = 0xB3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[1] = 0x5A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[0] = 0x2C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[3] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[2] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[1] = 0x52;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[0] = 0xB3;\r\n}\r\nstatic void DAA_Coeff_Australia(IXJ *j)\r\n{\r\nint i;\r\nj->daa_country = DAA_AUSTRALIA;\r\nfor (i = 0; i < ALISDAA_CALLERID_SIZE; i++) {\r\nj->m_DAAShadowRegs.CAO_REGS.CAO.CallerID[i] = 0;\r\n}\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[7] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[6] = 0xA3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[5] = 0xAA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[4] = 0x28;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[3] = 0xB3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[2] = 0x82;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[1] = 0xD0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[0] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[7] = 0x70;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[6] = 0x96;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[5] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[4] = 0x09;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[3] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[2] = 0x6B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[1] = 0xC0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[7] = 0x07;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[6] = 0x96;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[5] = 0xE2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[4] = 0x34;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[3] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[2] = 0x9B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[1] = 0x30;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[7] = 0x0F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[6] = 0x9A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[5] = 0xE9;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[4] = 0x2F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[3] = 0x22;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[2] = 0xCC;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[1] = 0xA0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[3] = 0xCB;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[2] = 0x45;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[1] = 0xDD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[0] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[3] = 0x1B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[2] = 0x67;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[1] = 0x10;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[0] = 0xD6;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[7] = 0x80;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[6] = 0x52;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[5] = 0x48;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[4] = 0x81;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[3] = 0xAF;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[2] = 0x80;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[1] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[0] = 0x98;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[7] = 0x02;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[6] = 0xDB;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[5] = 0x52;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[4] = 0xB0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[3] = 0x38;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[2] = 0x01;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[1] = 0x82;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[0] = 0xAC;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[7] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[6] = 0x88;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[5] = 0x4A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[4] = 0x3E;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[3] = 0x2C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[2] = 0x3B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[1] = 0x24;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[0] = 0x46;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[7] = 0x1B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[6] = 0x3C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[5] = 0x93;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[4] = 0x3A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[3] = 0x22;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[2] = 0x12;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[1] = 0xA3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[0] = 0x23;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[7] = 0x12;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[6] = 0xA2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[5] = 0xA6;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[4] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[3] = 0x22;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[2] = 0x7A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[1] = 0x0A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[0] = 0xD5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[3] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[2] = 0x45;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[1] = 0xB5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[0] = 0x84;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[7] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[6] = 0x0E;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[5] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[4] = 0x09;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[3] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[2] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[1] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[0] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[7] = 0xFD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[6] = 0xB5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[5] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[4] = 0x07;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[3] = 0xDA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[2] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[1] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[0] = 0x00;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg = 0xFF;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr1.reg = 0x05;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr2.reg = 0x04;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr3.reg = 0x00;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr4.reg = 0x02;\r\nj->m_DAAShadowRegs.XOP_xr0_W.reg = 0x02;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr1.reg = 0x1C;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr2.reg = 0x7D;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr3.reg = 0x2B;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr4.reg = 0x00;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr5.reg = 0x22;\r\nj->m_DAAShadowRegs.XOP_xr6_W.reg = 0x00;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr7.reg = 0x40;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[3] = 0x11;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[2] = 0xB3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[1] = 0x5A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[0] = 0x2C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[3] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[2] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[1] = 0x52;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[0] = 0xB3;\r\n}\r\nstatic void DAA_Coeff_Japan(IXJ *j)\r\n{\r\nint i;\r\nj->daa_country = DAA_JAPAN;\r\nfor (i = 0; i < ALISDAA_CALLERID_SIZE; i++) {\r\nj->m_DAAShadowRegs.CAO_REGS.CAO.CallerID[i] = 0;\r\n}\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[7] = 0x06;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[6] = 0xBD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[5] = 0xE2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[4] = 0x2D;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[3] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[2] = 0xF9;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[1] = 0xA0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_1[0] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[7] = 0x6F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[6] = 0xF7;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[5] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[4] = 0x0E;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[3] = 0x34;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[2] = 0x33;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[1] = 0xE0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.IMFilterCoeff_2[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[7] = 0x02;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[6] = 0x8F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[5] = 0x68;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[4] = 0x77;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[3] = 0x9C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[2] = 0x58;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[1] = 0xF0;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRXFilterCoeff[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[7] = 0x03;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[6] = 0x8F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[5] = 0x38;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[4] = 0x73;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[3] = 0x87;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[2] = 0xEA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[1] = 0x20;\r\nj->m_DAAShadowRegs.COP_REGS.COP.FRRFilterCoeff[0] = 0x08;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[3] = 0x51;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[2] = 0xC5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[1] = 0xDD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.AXFilterCoeff[0] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[3] = 0x25;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[2] = 0xA7;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[1] = 0x10;\r\nj->m_DAAShadowRegs.COP_REGS.COP.ARFilterCoeff[0] = 0xD6;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[7] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[6] = 0x42;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[5] = 0x48;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[4] = 0x81;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[3] = 0xAE;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[2] = 0x80;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[1] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_1[0] = 0x98;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[7] = 0x02;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[6] = 0xAB;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[5] = 0x2A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[4] = 0x20;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[3] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[2] = 0x5B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[1] = 0x89;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_2[0] = 0x28;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[7] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[6] = 0x88;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[5] = 0xDA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[4] = 0x25;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[3] = 0x34;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[2] = 0xC5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[1] = 0x4C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.THFilterCoeff_3[0] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[7] = 0x1B;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[6] = 0x3C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[5] = 0x93;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[4] = 0x3A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[3] = 0x22;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[2] = 0x12;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[1] = 0xA3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_1[0] = 0x23;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[7] = 0x12;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[6] = 0xA2;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[5] = 0xA6;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[4] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[3] = 0x22;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[2] = 0x7A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[1] = 0x0A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.RingerImpendance_2[0] = 0xD5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[3] = 0xAA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[2] = 0x35;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[1] = 0x0F;\r\nj->m_DAAShadowRegs.COP_REGS.COP.LevelmeteringRinging[0] = 0x8E;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[7] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[6] = 0x0E;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[5] = 0xCA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[4] = 0x09;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[3] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[2] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[1] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID1stTone[0] = 0x99;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[7] = 0xFD;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[6] = 0xB5;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[5] = 0xBA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[4] = 0x07;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[3] = 0xDA;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[2] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[1] = 0x00;\r\nj->m_DAAShadowRegs.COP_REGS.COP.CallerID2ndTone[0] = 0x00;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr0.reg = 0xFF;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr1.reg = 0x05;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr2.reg = 0x04;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr3.reg = 0x00;\r\nj->m_DAAShadowRegs.SOP_REGS.SOP.cr4.reg = 0x02;\r\nj->m_DAAShadowRegs.XOP_xr0_W.reg = 0x02;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr1.reg = 0x1C;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr2.reg = 0x7D;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr3.reg = 0x22;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr4.reg = 0x00;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr5.reg = 0x22;\r\nj->m_DAAShadowRegs.XOP_xr6_W.reg = 0x00;\r\nj->m_DAAShadowRegs.XOP_REGS.XOP.xr7.reg = 0x40;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[3] = 0x11;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[2] = 0xB3;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[1] = 0x5A;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone1Coeff[0] = 0x2C;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[3] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[2] = 0x32;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[1] = 0x52;\r\nj->m_DAAShadowRegs.COP_REGS.COP.Tone2Coeff[0] = 0xB3;\r\n}\r\nstatic int ixj_init_filter(IXJ *j, IXJ_FILTER * jf)\r\n{\r\nunsigned short cmd;\r\nint cnt, max;\r\nif (jf->filter > 3) {\r\nreturn -1;\r\n}\r\nif (ixj_WriteDSPCommand(0x5154 + jf->filter, j))\r\nreturn -1;\r\nif (!jf->enable) {\r\nif (ixj_WriteDSPCommand(0x5152, j))\r\nreturn -1;\r\nelse\r\nreturn 0;\r\n} else {\r\nif (ixj_WriteDSPCommand(0x5153, j))\r\nreturn -1;\r\nif (ixj_WriteDSPCommand(0x5154 + jf->filter, j))\r\nreturn -1;\r\n}\r\nif (jf->freq < 12 && jf->freq > 3) {\r\nif (ixj_WriteDSPCommand(0x5170 + jf->freq, j))\r\nreturn -1;\r\n} else if (jf->freq > 11) {\r\nif (ixj_WriteDSPCommand(0x5170 + jf->filter, j))\r\nreturn -1;\r\nif (j->ver.low != 0x12) {\r\ncmd = 0x515B;\r\nmax = 19;\r\n} else {\r\ncmd = 0x515E;\r\nmax = 15;\r\n}\r\nif (ixj_WriteDSPCommand(cmd, j))\r\nreturn -1;\r\nfor (cnt = 0; cnt < max; cnt++) {\r\nif (ixj_WriteDSPCommand(tone_table[jf->freq - 12][cnt], j))\r\nreturn -1;\r\n}\r\n}\r\nj->filter_en[jf->filter] = jf->enable;\r\nreturn 0;\r\n}\r\nstatic int ixj_init_filter_raw(IXJ *j, IXJ_FILTER_RAW * jfr)\r\n{\r\nunsigned short cmd;\r\nint cnt, max;\r\nif (jfr->filter > 3) {\r\nreturn -1;\r\n}\r\nif (ixj_WriteDSPCommand(0x5154 + jfr->filter, j))\r\nreturn -1;\r\nif (!jfr->enable) {\r\nif (ixj_WriteDSPCommand(0x5152, j))\r\nreturn -1;\r\nelse\r\nreturn 0;\r\n} else {\r\nif (ixj_WriteDSPCommand(0x5153, j))\r\nreturn -1;\r\nif (ixj_WriteDSPCommand(0x5154 + jfr->filter, j))\r\nreturn -1;\r\n}\r\nif (ixj_WriteDSPCommand(0x5170 + jfr->filter, j))\r\nreturn -1;\r\nif (j->ver.low != 0x12) {\r\ncmd = 0x515B;\r\nmax = 19;\r\n} else {\r\ncmd = 0x515E;\r\nmax = 15;\r\n}\r\nif (ixj_WriteDSPCommand(cmd, j))\r\nreturn -1;\r\nfor (cnt = 0; cnt < max; cnt++) {\r\nif (ixj_WriteDSPCommand(jfr->coeff[cnt], j))\r\nreturn -1;\r\n}\r\nj->filter_en[jfr->filter] = jfr->enable;\r\nreturn 0;\r\n}\r\nstatic int ixj_init_tone(IXJ *j, IXJ_TONE * ti)\r\n{\r\nint freq0, freq1;\r\nunsigned short data;\r\nif (ti->freq0) {\r\nfreq0 = ti->freq0;\r\n} else {\r\nfreq0 = 0x7FFF;\r\n}\r\nif (ti->freq1) {\r\nfreq1 = ti->freq1;\r\n} else {\r\nfreq1 = 0x7FFF;\r\n}\r\nif(ti->tone_index > 12 && ti->tone_index < 28)\r\n{\r\nif (ixj_WriteDSPCommand(0x6800 + ti->tone_index, j))\r\nreturn -1;\r\nif (ixj_WriteDSPCommand(0x6000 + (ti->gain1 << 4) + ti->gain0, j))\r\nreturn -1;\r\ndata = freq0;\r\nif (ixj_WriteDSPCommand(data, j))\r\nreturn -1;\r\ndata = freq1;\r\nif (ixj_WriteDSPCommand(data, j))\r\nreturn -1;\r\n}\r\nreturn freq0;\r\n}

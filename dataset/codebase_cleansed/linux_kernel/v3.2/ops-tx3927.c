static int mkaddr(struct pci_bus *bus, unsigned char devfn, unsigned char where)\r\n{\r\nif (bus->parent == NULL &&\r\ndevfn >= PCI_DEVFN(TX3927_PCIC_MAX_DEVNU, 0))\r\nreturn -1;\r\ntx3927_pcicptr->ica =\r\n((bus->number & 0xff) << 0x10) |\r\n((devfn & 0xff) << 0x08) |\r\n(where & 0xfc) | (bus->parent ? 1 : 0);\r\ntx3927_pcicptr->pcistat |= PCI_STATUS_REC_MASTER_ABORT;\r\ntx3927_pcicptr->pcistatim &= ~PCI_STATUS_REC_MASTER_ABORT;\r\nreturn 0;\r\n}\r\nstatic inline int check_abort(void)\r\n{\r\nif (tx3927_pcicptr->pcistat & PCI_STATUS_REC_MASTER_ABORT) {\r\ntx3927_pcicptr->pcistat |= PCI_STATUS_REC_MASTER_ABORT;\r\ntx3927_pcicptr->pcistatim |= PCI_STATUS_REC_MASTER_ABORT;\r\niob();\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int tx3927_pci_read_config(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 * val)\r\n{\r\nif (mkaddr(bus, devfn, where)) {\r\n*val = 0xffffffff;\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\n}\r\nswitch (size) {\r\ncase 1:\r\n*val = *(volatile u8 *) ((unsigned long) & tx3927_pcicptr->icd | (where & 3));\r\nbreak;\r\ncase 2:\r\n*val = le16_to_cpu(*(volatile u16 *) ((unsigned long) & tx3927_pcicptr->icd | (where & 3)));\r\nbreak;\r\ncase 4:\r\n*val = le32_to_cpu(tx3927_pcicptr->icd);\r\nbreak;\r\n}\r\nreturn check_abort();\r\n}\r\nstatic int tx3927_pci_write_config(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 val)\r\n{\r\nif (mkaddr(bus, devfn, where))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nswitch (size) {\r\ncase 1:\r\n*(volatile u8 *) ((unsigned long) & tx3927_pcicptr->icd | (where & 3)) = val;\r\nbreak;\r\ncase 2:\r\n*(volatile u16 *) ((unsigned long) & tx3927_pcicptr->icd | (where & 2)) =\r\ncpu_to_le16(val);\r\nbreak;\r\ncase 4:\r\ntx3927_pcicptr->icd = cpu_to_le32(val);\r\n}\r\nreturn check_abort();\r\n}\r\nvoid __init tx3927_pcic_setup(struct pci_controller *channel,\r\nunsigned long sdram_size, int extarb)\r\n{\r\nunsigned long flags;\r\nunsigned long io_base =\r\nchannel->io_resource->start + mips_io_port_base - IO_BASE;\r\nunsigned long io_size =\r\nchannel->io_resource->end - channel->io_resource->start;\r\nunsigned long io_pciaddr =\r\nchannel->io_resource->start - channel->io_offset;\r\nunsigned long mem_base =\r\nchannel->mem_resource->start;\r\nunsigned long mem_size =\r\nchannel->mem_resource->end - channel->mem_resource->start;\r\nunsigned long mem_pciaddr =\r\nchannel->mem_resource->start - channel->mem_offset;\r\nprintk(KERN_INFO "TX3927 PCIC -- DID:%04x VID:%04x RID:%02x Arbiter:%s",\r\ntx3927_pcicptr->did, tx3927_pcicptr->vid,\r\ntx3927_pcicptr->rid,\r\nextarb ? "External" : "Internal");\r\nchannel->pci_ops = &tx3927_pci_ops;\r\nlocal_irq_save(flags);\r\ntx3927_pcicptr->lbc = TX3927_PCIC_LBC_EPCAD;\r\n#ifdef __BIG_ENDIAN\r\ntx3927_pcicptr->lbc |= TX3927_PCIC_LBC_IBSE |\r\nTX3927_PCIC_LBC_TIBSE |\r\nTX3927_PCIC_LBC_TMFBSE | TX3927_PCIC_LBC_MSDSE;\r\n#endif\r\ntx3927_pcicptr->iomas = ~(io_size - 1);\r\ntx3927_pcicptr->ilbioma = io_base;\r\ntx3927_pcicptr->ipbioma = io_pciaddr;\r\ntx3927_pcicptr->mmas = ~(mem_size - 1);\r\ntx3927_pcicptr->ilbmma = mem_base;\r\ntx3927_pcicptr->ipbmma = mem_pciaddr;\r\ntx3927_pcicptr->iobas = 0xffffffff;\r\ntx3927_pcicptr->ioba = 0;\r\ntx3927_pcicptr->tlbioma = 0;\r\ntx3927_pcicptr->mbas = ~(sdram_size - 1);\r\ntx3927_pcicptr->mba = 0;\r\ntx3927_pcicptr->tlbmma = 0;\r\ntx3927_pcicptr->lbc |= TX3927_PCIC_LBC_ILMDE | TX3927_PCIC_LBC_ILIDE;\r\ntx3927_pcicptr->lbstat = TX3927_PCIC_LBIM_ALL;\r\ntx3927_pcicptr->lbim = TX3927_PCIC_LBIM_ALL;\r\ntx3927_pcicptr->pcistat = TX3927_PCIC_PCISTATIM_ALL;\r\ntx3927_pcicptr->pcistatim = TX3927_PCIC_PCISTATIM_ALL;\r\ntx3927_pcicptr->il = TX3927_IR_PCI;\r\ntx3927_pcicptr->tc = TX3927_PCIC_TC_OF8E | TX3927_PCIC_TC_IF8E;\r\nif (!extarb)\r\ntx3927_pcicptr->pbapmc = TX3927_PCIC_PBAPMC_PBAEN;\r\ntx3927_pcicptr->pcicmd = PCI_COMMAND_MASTER |\r\nPCI_COMMAND_MEMORY |\r\nPCI_COMMAND_IO |\r\nPCI_COMMAND_PARITY | PCI_COMMAND_SERR;\r\nlocal_irq_restore(flags);\r\n}\r\nstatic irqreturn_t tx3927_pcierr_interrupt(int irq, void *dev_id)\r\n{\r\nstruct pt_regs *regs = get_irq_regs();\r\nif (txx9_pci_err_action != TXX9_PCI_ERR_IGNORE) {\r\nprintk(KERN_WARNING "PCI error interrupt at 0x%08lx.\n",\r\nregs->cp0_epc);\r\nprintk(KERN_WARNING "pcistat:%02x, lbstat:%04lx\n",\r\ntx3927_pcicptr->pcistat, tx3927_pcicptr->lbstat);\r\n}\r\nif (txx9_pci_err_action != TXX9_PCI_ERR_PANIC) {\r\ntx3927_pcicptr->pcistat |= TX3927_PCIC_PCISTATIM_ALL;\r\ntx3927_pcicptr->istat = TX3927_PCIC_IIM_ALL;\r\ntx3927_pcicptr->tstat = TX3927_PCIC_TIM_ALL;\r\ntx3927_pcicptr->lbstat = TX3927_PCIC_LBIM_ALL;\r\nreturn IRQ_HANDLED;\r\n}\r\nconsole_verbose();\r\npanic("PCI error.");\r\n}\r\nvoid __init tx3927_setup_pcierr_irq(void)\r\n{\r\nif (request_irq(TXX9_IRQ_BASE + TX3927_IR_PCI,\r\ntx3927_pcierr_interrupt,\r\nIRQF_DISABLED, "PCI error",\r\n(void *)TX3927_PCIC_REG))\r\nprintk(KERN_WARNING "Failed to request irq for PCIERR\n");\r\n}

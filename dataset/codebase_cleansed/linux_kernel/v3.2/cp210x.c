static int cp210x_get_config(struct usb_serial_port *port, u8 request,\r\nunsigned int *data, int size)\r\n{\r\nstruct usb_serial *serial = port->serial;\r\n__le32 *buf;\r\nint result, i, length;\r\nlength = (((size - 1) | 3) + 1)/4;\r\nbuf = kcalloc(length, sizeof(__le32), GFP_KERNEL);\r\nif (!buf) {\r\ndev_err(&port->dev, "%s - out of memory.\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\nresult = usb_control_msg(serial->dev, usb_rcvctrlpipe(serial->dev, 0),\r\nrequest, REQTYPE_DEVICE_TO_HOST, 0x0000,\r\n0, buf, size, 300);\r\nfor (i = 0; i < length; i++)\r\ndata[i] = le32_to_cpu(buf[i]);\r\nkfree(buf);\r\nif (result != size) {\r\ndbg("%s - Unable to send config request, "\r\n"request=0x%x size=%d result=%d\n",\r\n__func__, request, size, result);\r\nreturn -EPROTO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cp210x_set_config(struct usb_serial_port *port, u8 request,\r\nunsigned int *data, int size)\r\n{\r\nstruct usb_serial *serial = port->serial;\r\n__le32 *buf;\r\nint result, i, length;\r\nlength = (((size - 1) | 3) + 1)/4;\r\nbuf = kmalloc(length * sizeof(__le32), GFP_KERNEL);\r\nif (!buf) {\r\ndev_err(&port->dev, "%s - out of memory.\n",\r\n__func__);\r\nreturn -ENOMEM;\r\n}\r\nfor (i = 0; i < length; i++)\r\nbuf[i] = cpu_to_le32(data[i]);\r\nif (size > 2) {\r\nresult = usb_control_msg(serial->dev,\r\nusb_sndctrlpipe(serial->dev, 0),\r\nrequest, REQTYPE_HOST_TO_DEVICE, 0x0000,\r\n0, buf, size, 300);\r\n} else {\r\nresult = usb_control_msg(serial->dev,\r\nusb_sndctrlpipe(serial->dev, 0),\r\nrequest, REQTYPE_HOST_TO_DEVICE, data[0],\r\n0, NULL, 0, 300);\r\n}\r\nkfree(buf);\r\nif ((size > 2 && result != size) || result < 0) {\r\ndbg("%s - Unable to send request, "\r\n"request=0x%x size=%d result=%d\n",\r\n__func__, request, size, result);\r\nreturn -EPROTO;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int cp210x_set_config_single(struct usb_serial_port *port,\r\nu8 request, unsigned int data)\r\n{\r\nreturn cp210x_set_config(port, request, &data, 2);\r\n}\r\nstatic unsigned int cp210x_quantise_baudrate(unsigned int baud) {\r\nif (baud <= 56) baud = 0;\r\nelse if (baud <= 300) baud = 300;\r\nelse if (baud <= 600) baud = 600;\r\nelse if (baud <= 1200) baud = 1200;\r\nelse if (baud <= 1800) baud = 1800;\r\nelse if (baud <= 2400) baud = 2400;\r\nelse if (baud <= 4000) baud = 4000;\r\nelse if (baud <= 4803) baud = 4800;\r\nelse if (baud <= 7207) baud = 7200;\r\nelse if (baud <= 9612) baud = 9600;\r\nelse if (baud <= 14428) baud = 14400;\r\nelse if (baud <= 16062) baud = 16000;\r\nelse if (baud <= 19250) baud = 19200;\r\nelse if (baud <= 28912) baud = 28800;\r\nelse if (baud <= 38601) baud = 38400;\r\nelse if (baud <= 51558) baud = 51200;\r\nelse if (baud <= 56280) baud = 56000;\r\nelse if (baud <= 58053) baud = 57600;\r\nelse if (baud <= 64111) baud = 64000;\r\nelse if (baud <= 77608) baud = 76800;\r\nelse if (baud <= 117028) baud = 115200;\r\nelse if (baud <= 129347) baud = 128000;\r\nelse if (baud <= 156868) baud = 153600;\r\nelse if (baud <= 237832) baud = 230400;\r\nelse if (baud <= 254234) baud = 250000;\r\nelse if (baud <= 273066) baud = 256000;\r\nelse if (baud <= 491520) baud = 460800;\r\nelse if (baud <= 567138) baud = 500000;\r\nelse if (baud <= 670254) baud = 576000;\r\nelse if (baud <= 1053257) baud = 921600;\r\nelse if (baud <= 1474560) baud = 1228800;\r\nelse if (baud <= 2457600) baud = 1843200;\r\nelse baud = 3686400;\r\nreturn baud;\r\n}\r\nstatic int cp210x_open(struct tty_struct *tty, struct usb_serial_port *port)\r\n{\r\nint result;\r\ndbg("%s - port %d", __func__, port->number);\r\nif (cp210x_set_config_single(port, CP210X_IFC_ENABLE, UART_ENABLE)) {\r\ndev_err(&port->dev, "%s - Unable to enable UART\n",\r\n__func__);\r\nreturn -EPROTO;\r\n}\r\nresult = usb_serial_generic_open(tty, port);\r\nif (result)\r\nreturn result;\r\ncp210x_get_termios(tty, port);\r\nreturn 0;\r\n}\r\nstatic void cp210x_close(struct usb_serial_port *port)\r\n{\r\ndbg("%s - port %d", __func__, port->number);\r\nusb_serial_generic_close(port);\r\nmutex_lock(&port->serial->disc_mutex);\r\nif (!port->serial->disconnected)\r\ncp210x_set_config_single(port, CP210X_IFC_ENABLE, UART_DISABLE);\r\nmutex_unlock(&port->serial->disc_mutex);\r\n}\r\nstatic void cp210x_get_termios(struct tty_struct *tty,\r\nstruct usb_serial_port *port)\r\n{\r\nunsigned int baud;\r\nif (tty) {\r\ncp210x_get_termios_port(tty->driver_data,\r\n&tty->termios->c_cflag, &baud);\r\ntty_encode_baud_rate(tty, baud, baud);\r\n}\r\nelse {\r\nunsigned int cflag;\r\ncflag = 0;\r\ncp210x_get_termios_port(port, &cflag, &baud);\r\n}\r\n}\r\nstatic void cp210x_get_termios_port(struct usb_serial_port *port,\r\nunsigned int *cflagp, unsigned int *baudp)\r\n{\r\nunsigned int cflag, modem_ctl[4];\r\nunsigned int baud;\r\nunsigned int bits;\r\ndbg("%s - port %d", __func__, port->number);\r\ncp210x_get_config(port, CP210X_GET_BAUDDIV, &baud, 2);\r\nif (baud)\r\nbaud = cp210x_quantise_baudrate((BAUD_RATE_GEN_FREQ + baud/2)/ baud);\r\ndbg("%s - baud rate = %d", __func__, baud);\r\n*baudp = baud;\r\ncflag = *cflagp;\r\ncp210x_get_config(port, CP210X_GET_LINE_CTL, &bits, 2);\r\ncflag &= ~CSIZE;\r\nswitch (bits & BITS_DATA_MASK) {\r\ncase BITS_DATA_5:\r\ndbg("%s - data bits = 5", __func__);\r\ncflag |= CS5;\r\nbreak;\r\ncase BITS_DATA_6:\r\ndbg("%s - data bits = 6", __func__);\r\ncflag |= CS6;\r\nbreak;\r\ncase BITS_DATA_7:\r\ndbg("%s - data bits = 7", __func__);\r\ncflag |= CS7;\r\nbreak;\r\ncase BITS_DATA_8:\r\ndbg("%s - data bits = 8", __func__);\r\ncflag |= CS8;\r\nbreak;\r\ncase BITS_DATA_9:\r\ndbg("%s - data bits = 9 (not supported, using 8 data bits)",\r\n__func__);\r\ncflag |= CS8;\r\nbits &= ~BITS_DATA_MASK;\r\nbits |= BITS_DATA_8;\r\ncp210x_set_config(port, CP210X_SET_LINE_CTL, &bits, 2);\r\nbreak;\r\ndefault:\r\ndbg("%s - Unknown number of data bits, using 8", __func__);\r\ncflag |= CS8;\r\nbits &= ~BITS_DATA_MASK;\r\nbits |= BITS_DATA_8;\r\ncp210x_set_config(port, CP210X_SET_LINE_CTL, &bits, 2);\r\nbreak;\r\n}\r\nswitch (bits & BITS_PARITY_MASK) {\r\ncase BITS_PARITY_NONE:\r\ndbg("%s - parity = NONE", __func__);\r\ncflag &= ~PARENB;\r\nbreak;\r\ncase BITS_PARITY_ODD:\r\ndbg("%s - parity = ODD", __func__);\r\ncflag |= (PARENB|PARODD);\r\nbreak;\r\ncase BITS_PARITY_EVEN:\r\ndbg("%s - parity = EVEN", __func__);\r\ncflag &= ~PARODD;\r\ncflag |= PARENB;\r\nbreak;\r\ncase BITS_PARITY_MARK:\r\ndbg("%s - parity = MARK (not supported, disabling parity)",\r\n__func__);\r\ncflag &= ~PARENB;\r\nbits &= ~BITS_PARITY_MASK;\r\ncp210x_set_config(port, CP210X_SET_LINE_CTL, &bits, 2);\r\nbreak;\r\ncase BITS_PARITY_SPACE:\r\ndbg("%s - parity = SPACE (not supported, disabling parity)",\r\n__func__);\r\ncflag &= ~PARENB;\r\nbits &= ~BITS_PARITY_MASK;\r\ncp210x_set_config(port, CP210X_SET_LINE_CTL, &bits, 2);\r\nbreak;\r\ndefault:\r\ndbg("%s - Unknown parity mode, disabling parity", __func__);\r\ncflag &= ~PARENB;\r\nbits &= ~BITS_PARITY_MASK;\r\ncp210x_set_config(port, CP210X_SET_LINE_CTL, &bits, 2);\r\nbreak;\r\n}\r\ncflag &= ~CSTOPB;\r\nswitch (bits & BITS_STOP_MASK) {\r\ncase BITS_STOP_1:\r\ndbg("%s - stop bits = 1", __func__);\r\nbreak;\r\ncase BITS_STOP_1_5:\r\ndbg("%s - stop bits = 1.5 (not supported, using 1 stop bit)",\r\n__func__);\r\nbits &= ~BITS_STOP_MASK;\r\ncp210x_set_config(port, CP210X_SET_LINE_CTL, &bits, 2);\r\nbreak;\r\ncase BITS_STOP_2:\r\ndbg("%s - stop bits = 2", __func__);\r\ncflag |= CSTOPB;\r\nbreak;\r\ndefault:\r\ndbg("%s - Unknown number of stop bits, using 1 stop bit",\r\n__func__);\r\nbits &= ~BITS_STOP_MASK;\r\ncp210x_set_config(port, CP210X_SET_LINE_CTL, &bits, 2);\r\nbreak;\r\n}\r\ncp210x_get_config(port, CP210X_GET_FLOW, modem_ctl, 16);\r\nif (modem_ctl[0] & 0x0008) {\r\ndbg("%s - flow control = CRTSCTS", __func__);\r\ncflag |= CRTSCTS;\r\n} else {\r\ndbg("%s - flow control = NONE", __func__);\r\ncflag &= ~CRTSCTS;\r\n}\r\n*cflagp = cflag;\r\n}\r\nstatic void cp210x_set_termios(struct tty_struct *tty,\r\nstruct usb_serial_port *port, struct ktermios *old_termios)\r\n{\r\nunsigned int cflag, old_cflag;\r\nunsigned int baud = 0, bits;\r\nunsigned int modem_ctl[4];\r\ndbg("%s - port %d", __func__, port->number);\r\nif (!tty)\r\nreturn;\r\ntty->termios->c_cflag &= ~CMSPAR;\r\ncflag = tty->termios->c_cflag;\r\nold_cflag = old_termios->c_cflag;\r\nbaud = cp210x_quantise_baudrate(tty_get_baud_rate(tty));\r\nif (baud != tty_termios_baud_rate(old_termios) && baud != 0) {\r\ndbg("%s - Setting baud rate to %d baud", __func__,\r\nbaud);\r\nif (cp210x_set_config_single(port, CP210X_SET_BAUDDIV,\r\n((BAUD_RATE_GEN_FREQ + baud/2) / baud))) {\r\ndbg("Baud rate requested not supported by device");\r\nbaud = tty_termios_baud_rate(old_termios);\r\n}\r\n}\r\ntty_encode_baud_rate(tty, baud, baud);\r\nif ((cflag & CSIZE) != (old_cflag & CSIZE)) {\r\ncp210x_get_config(port, CP210X_GET_LINE_CTL, &bits, 2);\r\nbits &= ~BITS_DATA_MASK;\r\nswitch (cflag & CSIZE) {\r\ncase CS5:\r\nbits |= BITS_DATA_5;\r\ndbg("%s - data bits = 5", __func__);\r\nbreak;\r\ncase CS6:\r\nbits |= BITS_DATA_6;\r\ndbg("%s - data bits = 6", __func__);\r\nbreak;\r\ncase CS7:\r\nbits |= BITS_DATA_7;\r\ndbg("%s - data bits = 7", __func__);\r\nbreak;\r\ncase CS8:\r\nbits |= BITS_DATA_8;\r\ndbg("%s - data bits = 8", __func__);\r\nbreak;\r\ndefault:\r\ndbg("cp210x driver does not "\r\n"support the number of bits requested,"\r\n" using 8 bit mode\n");\r\nbits |= BITS_DATA_8;\r\nbreak;\r\n}\r\nif (cp210x_set_config(port, CP210X_SET_LINE_CTL, &bits, 2))\r\ndbg("Number of data bits requested "\r\n"not supported by device\n");\r\n}\r\nif ((cflag & (PARENB|PARODD)) != (old_cflag & (PARENB|PARODD))) {\r\ncp210x_get_config(port, CP210X_GET_LINE_CTL, &bits, 2);\r\nbits &= ~BITS_PARITY_MASK;\r\nif (cflag & PARENB) {\r\nif (cflag & PARODD) {\r\nbits |= BITS_PARITY_ODD;\r\ndbg("%s - parity = ODD", __func__);\r\n} else {\r\nbits |= BITS_PARITY_EVEN;\r\ndbg("%s - parity = EVEN", __func__);\r\n}\r\n}\r\nif (cp210x_set_config(port, CP210X_SET_LINE_CTL, &bits, 2))\r\ndbg("Parity mode not supported "\r\n"by device\n");\r\n}\r\nif ((cflag & CSTOPB) != (old_cflag & CSTOPB)) {\r\ncp210x_get_config(port, CP210X_GET_LINE_CTL, &bits, 2);\r\nbits &= ~BITS_STOP_MASK;\r\nif (cflag & CSTOPB) {\r\nbits |= BITS_STOP_2;\r\ndbg("%s - stop bits = 2", __func__);\r\n} else {\r\nbits |= BITS_STOP_1;\r\ndbg("%s - stop bits = 1", __func__);\r\n}\r\nif (cp210x_set_config(port, CP210X_SET_LINE_CTL, &bits, 2))\r\ndbg("Number of stop bits requested "\r\n"not supported by device\n");\r\n}\r\nif ((cflag & CRTSCTS) != (old_cflag & CRTSCTS)) {\r\ncp210x_get_config(port, CP210X_GET_FLOW, modem_ctl, 16);\r\ndbg("%s - read modem controls = 0x%.4x 0x%.4x 0x%.4x 0x%.4x",\r\n__func__, modem_ctl[0], modem_ctl[1],\r\nmodem_ctl[2], modem_ctl[3]);\r\nif (cflag & CRTSCTS) {\r\nmodem_ctl[0] &= ~0x7B;\r\nmodem_ctl[0] |= 0x09;\r\nmodem_ctl[1] = 0x80;\r\ndbg("%s - flow control = CRTSCTS", __func__);\r\n} else {\r\nmodem_ctl[0] &= ~0x7B;\r\nmodem_ctl[0] |= 0x01;\r\nmodem_ctl[1] |= 0x40;\r\ndbg("%s - flow control = NONE", __func__);\r\n}\r\ndbg("%s - write modem controls = 0x%.4x 0x%.4x 0x%.4x 0x%.4x",\r\n__func__, modem_ctl[0], modem_ctl[1],\r\nmodem_ctl[2], modem_ctl[3]);\r\ncp210x_set_config(port, CP210X_SET_FLOW, modem_ctl, 16);\r\n}\r\n}\r\nstatic int cp210x_tiocmset (struct tty_struct *tty,\r\nunsigned int set, unsigned int clear)\r\n{\r\nstruct usb_serial_port *port = tty->driver_data;\r\nreturn cp210x_tiocmset_port(port, set, clear);\r\n}\r\nstatic int cp210x_tiocmset_port(struct usb_serial_port *port,\r\nunsigned int set, unsigned int clear)\r\n{\r\nunsigned int control = 0;\r\ndbg("%s - port %d", __func__, port->number);\r\nif (set & TIOCM_RTS) {\r\ncontrol |= CONTROL_RTS;\r\ncontrol |= CONTROL_WRITE_RTS;\r\n}\r\nif (set & TIOCM_DTR) {\r\ncontrol |= CONTROL_DTR;\r\ncontrol |= CONTROL_WRITE_DTR;\r\n}\r\nif (clear & TIOCM_RTS) {\r\ncontrol &= ~CONTROL_RTS;\r\ncontrol |= CONTROL_WRITE_RTS;\r\n}\r\nif (clear & TIOCM_DTR) {\r\ncontrol &= ~CONTROL_DTR;\r\ncontrol |= CONTROL_WRITE_DTR;\r\n}\r\ndbg("%s - control = 0x%.4x", __func__, control);\r\nreturn cp210x_set_config(port, CP210X_SET_MHS, &control, 2);\r\n}\r\nstatic void cp210x_dtr_rts(struct usb_serial_port *p, int on)\r\n{\r\nif (on)\r\ncp210x_tiocmset_port(p, TIOCM_DTR|TIOCM_RTS, 0);\r\nelse\r\ncp210x_tiocmset_port(p, 0, TIOCM_DTR|TIOCM_RTS);\r\n}\r\nstatic int cp210x_tiocmget (struct tty_struct *tty)\r\n{\r\nstruct usb_serial_port *port = tty->driver_data;\r\nunsigned int control;\r\nint result;\r\ndbg("%s - port %d", __func__, port->number);\r\ncp210x_get_config(port, CP210X_GET_MDMSTS, &control, 1);\r\nresult = ((control & CONTROL_DTR) ? TIOCM_DTR : 0)\r\n|((control & CONTROL_RTS) ? TIOCM_RTS : 0)\r\n|((control & CONTROL_CTS) ? TIOCM_CTS : 0)\r\n|((control & CONTROL_DSR) ? TIOCM_DSR : 0)\r\n|((control & CONTROL_RING)? TIOCM_RI : 0)\r\n|((control & CONTROL_DCD) ? TIOCM_CD : 0);\r\ndbg("%s - control = 0x%.2x", __func__, control);\r\nreturn result;\r\n}\r\nstatic void cp210x_break_ctl (struct tty_struct *tty, int break_state)\r\n{\r\nstruct usb_serial_port *port = tty->driver_data;\r\nunsigned int state;\r\ndbg("%s - port %d", __func__, port->number);\r\nif (break_state == 0)\r\nstate = BREAK_OFF;\r\nelse\r\nstate = BREAK_ON;\r\ndbg("%s - turning break %s", __func__,\r\nstate == BREAK_OFF ? "off" : "on");\r\ncp210x_set_config(port, CP210X_SET_BREAK, &state, 2);\r\n}\r\nstatic int cp210x_startup(struct usb_serial *serial)\r\n{\r\nusb_reset_device(serial->dev);\r\nreturn 0;\r\n}\r\nstatic int __init cp210x_init(void)\r\n{\r\nint retval;\r\nretval = usb_serial_register(&cp210x_device);\r\nif (retval)\r\nreturn retval;\r\nretval = usb_register(&cp210x_driver);\r\nif (retval) {\r\nusb_serial_deregister(&cp210x_device);\r\nreturn retval;\r\n}\r\nprintk(KERN_INFO KBUILD_MODNAME ": " DRIVER_VERSION ":"\r\nDRIVER_DESC "\n");\r\nreturn 0;\r\n}\r\nstatic void __exit cp210x_exit(void)\r\n{\r\nusb_deregister(&cp210x_driver);\r\nusb_serial_deregister(&cp210x_device);\r\n}

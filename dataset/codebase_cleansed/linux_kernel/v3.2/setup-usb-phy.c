static int exynos4_usb_phy1_init(struct platform_device *pdev)\r\n{\r\nstruct clk *otg_clk;\r\nstruct clk *xusbxti_clk;\r\nu32 phyclk;\r\nu32 rstcon;\r\nint err;\r\notg_clk = clk_get(&pdev->dev, "otg");\r\nif (IS_ERR(otg_clk)) {\r\ndev_err(&pdev->dev, "Failed to get otg clock\n");\r\nreturn PTR_ERR(otg_clk);\r\n}\r\nerr = clk_enable(otg_clk);\r\nif (err) {\r\nclk_put(otg_clk);\r\nreturn err;\r\n}\r\nwritel(readl(S5P_USBHOST_PHY_CONTROL) | S5P_USBHOST_PHY_ENABLE,\r\nS5P_USBHOST_PHY_CONTROL);\r\nphyclk = readl(EXYNOS4_PHYCLK) & ~CLKSEL_MASK;\r\nxusbxti_clk = clk_get(&pdev->dev, "xusbxti");\r\nif (xusbxti_clk && !IS_ERR(xusbxti_clk)) {\r\nswitch (clk_get_rate(xusbxti_clk)) {\r\ncase 12 * MHZ:\r\nphyclk |= CLKSEL_12M;\r\nbreak;\r\ncase 24 * MHZ:\r\nphyclk |= CLKSEL_24M;\r\nbreak;\r\ndefault:\r\ncase 48 * MHZ:\r\nbreak;\r\n}\r\nclk_put(xusbxti_clk);\r\n}\r\nwritel(phyclk, EXYNOS4_PHYCLK);\r\nwritel((readl(EXYNOS4_PHY1CON) | FPENABLEN), EXYNOS4_PHY1CON);\r\nwritel((readl(EXYNOS4_PHYPWR) & ~PHY1_HSIC_NORMAL_MASK),\r\nEXYNOS4_PHYPWR);\r\nwritel((readl(EXYNOS4_PHYPWR) & ~PHY1_STD_NORMAL_MASK), EXYNOS4_PHYPWR);\r\nrstcon = readl(EXYNOS4_RSTCON) | HOST_LINK_PORT_SWRST_MASK |\r\nPHY1_SWRST_MASK;\r\nwritel(rstcon, EXYNOS4_RSTCON);\r\nudelay(10);\r\nrstcon &= ~(HOST_LINK_PORT_SWRST_MASK | PHY1_SWRST_MASK);\r\nwritel(rstcon, EXYNOS4_RSTCON);\r\nudelay(80);\r\nclk_disable(otg_clk);\r\nclk_put(otg_clk);\r\nreturn 0;\r\n}\r\nstatic int exynos4_usb_phy1_exit(struct platform_device *pdev)\r\n{\r\nstruct clk *otg_clk;\r\nint err;\r\notg_clk = clk_get(&pdev->dev, "otg");\r\nif (IS_ERR(otg_clk)) {\r\ndev_err(&pdev->dev, "Failed to get otg clock\n");\r\nreturn PTR_ERR(otg_clk);\r\n}\r\nerr = clk_enable(otg_clk);\r\nif (err) {\r\nclk_put(otg_clk);\r\nreturn err;\r\n}\r\nwritel((readl(EXYNOS4_PHYPWR) | PHY1_STD_ANALOG_POWERDOWN),\r\nEXYNOS4_PHYPWR);\r\nwritel(readl(S5P_USBHOST_PHY_CONTROL) & ~S5P_USBHOST_PHY_ENABLE,\r\nS5P_USBHOST_PHY_CONTROL);\r\nclk_disable(otg_clk);\r\nclk_put(otg_clk);\r\nreturn 0;\r\n}\r\nint s5p_usb_phy_init(struct platform_device *pdev, int type)\r\n{\r\nif (type == S5P_USB_PHY_HOST)\r\nreturn exynos4_usb_phy1_init(pdev);\r\nreturn -EINVAL;\r\n}\r\nint s5p_usb_phy_exit(struct platform_device *pdev, int type)\r\n{\r\nif (type == S5P_USB_PHY_HOST)\r\nreturn exynos4_usb_phy1_exit(pdev);\r\nreturn -EINVAL;\r\n}

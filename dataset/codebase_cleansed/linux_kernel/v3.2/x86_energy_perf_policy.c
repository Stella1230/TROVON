void usage(void)\r\n{\r\nprintf("%s: [-c cpu] [-v] "\r\n"(-r | 'performance' | 'normal' | 'powersave' | n)\n",\r\nprogname);\r\nexit(1);\r\n}\r\nvoid cmdline(int argc, char **argv)\r\n{\r\nint opt;\r\nprogname = argv[0];\r\nwhile ((opt = getopt(argc, argv, "+rvc:")) != -1) {\r\nswitch (opt) {\r\ncase 'c':\r\ncpu = atoi(optarg);\r\nbreak;\r\ncase 'r':\r\nread_only = 1;\r\nbreak;\r\ncase 'v':\r\nverbose++;\r\nbreak;\r\ndefault:\r\nusage();\r\n}\r\n}\r\nif (read_only && (argc > optind))\r\nusage();\r\nif (!read_only) {\r\nif (argc != optind + 1) {\r\nprintf("must supply -r or policy param\n");\r\nusage();\r\n}\r\nif (!strcmp("performance", argv[optind])) {\r\nnew_bias = BIAS_PERFORMANCE;\r\n} else if (!strcmp("normal", argv[optind])) {\r\nnew_bias = BIAS_BALANCE;\r\n} else if (!strcmp("powersave", argv[optind])) {\r\nnew_bias = BIAS_POWERSAVE;\r\n} else {\r\nchar *endptr;\r\nnew_bias = strtoull(argv[optind], &endptr, 0);\r\nif (endptr == argv[optind] ||\r\nnew_bias > BIAS_POWERSAVE) {\r\nfprintf(stderr, "invalid value: %s\n",\r\nargv[optind]);\r\nusage();\r\n}\r\n}\r\n}\r\n}\r\nvoid validate_cpuid(void)\r\n{\r\nunsigned int eax, ebx, ecx, edx, max_level;\r\nunsigned int fms, family, model, stepping;\r\neax = ebx = ecx = edx = 0;\r\nasm("cpuid" : "=a" (max_level), "=b" (ebx), "=c" (ecx),\r\n"=d" (edx) : "a" (0));\r\nif (ebx != 0x756e6547 || edx != 0x49656e69 || ecx != 0x6c65746e) {\r\nif (verbose)\r\nfprintf(stderr, "%.4s%.4s%.4s != GenuineIntel",\r\n(char *)&ebx, (char *)&edx, (char *)&ecx);\r\nexit(1);\r\n}\r\nasm("cpuid" : "=a" (fms), "=c" (ecx), "=d" (edx) : "a" (1) : "ebx");\r\nfamily = (fms >> 8) & 0xf;\r\nmodel = (fms >> 4) & 0xf;\r\nstepping = fms & 0xf;\r\nif (family == 6 || family == 0xf)\r\nmodel += ((fms >> 16) & 0xf) << 4;\r\nif (verbose > 1)\r\nprintf("CPUID %d levels family:model:stepping "\r\n"0x%x:%x:%x (%d:%d:%d)\n", max_level,\r\nfamily, model, stepping, family, model, stepping);\r\nif (!(edx & (1 << 5))) {\r\nif (verbose)\r\nprintf("CPUID: no MSR\n");\r\nexit(1);\r\n}\r\nasm("cpuid" : "=a" (eax), "=b" (ebx), "=c" (ecx), "=d" (edx) : "a" (6));\r\nif (verbose)\r\nprintf("CPUID.06H.ECX: 0x%x\n", ecx);\r\nif (!(ecx & (1 << 3))) {\r\nif (verbose)\r\nprintf("CPUID: No MSR_IA32_ENERGY_PERF_BIAS\n");\r\nexit(1);\r\n}\r\nreturn;\r\n}\r\nunsigned long long get_msr(int cpu, int offset)\r\n{\r\nunsigned long long msr;\r\nchar msr_path[32];\r\nint retval;\r\nint fd;\r\nsprintf(msr_path, "/dev/cpu/%d/msr", cpu);\r\nfd = open(msr_path, O_RDONLY);\r\nif (fd < 0) {\r\nprintf("Try \"# modprobe msr\"\n");\r\nperror(msr_path);\r\nexit(1);\r\n}\r\nretval = pread(fd, &msr, sizeof msr, offset);\r\nif (retval != sizeof msr) {\r\nprintf("pread cpu%d 0x%x = %d\n", cpu, offset, retval);\r\nexit(-2);\r\n}\r\nclose(fd);\r\nreturn msr;\r\n}\r\nunsigned long long put_msr(int cpu, unsigned long long new_msr, int offset)\r\n{\r\nunsigned long long old_msr;\r\nchar msr_path[32];\r\nint retval;\r\nint fd;\r\nsprintf(msr_path, "/dev/cpu/%d/msr", cpu);\r\nfd = open(msr_path, O_RDWR);\r\nif (fd < 0) {\r\nperror(msr_path);\r\nexit(1);\r\n}\r\nretval = pread(fd, &old_msr, sizeof old_msr, offset);\r\nif (retval != sizeof old_msr) {\r\nperror("pwrite");\r\nprintf("pread cpu%d 0x%x = %d\n", cpu, offset, retval);\r\nexit(-2);\r\n}\r\nretval = pwrite(fd, &new_msr, sizeof new_msr, offset);\r\nif (retval != sizeof new_msr) {\r\nperror("pwrite");\r\nprintf("pwrite cpu%d 0x%x = %d\n", cpu, offset, retval);\r\nexit(-2);\r\n}\r\nclose(fd);\r\nreturn old_msr;\r\n}\r\nvoid print_msr(int cpu)\r\n{\r\nprintf("cpu%d: 0x%016llx\n",\r\ncpu, get_msr(cpu, MSR_IA32_ENERGY_PERF_BIAS));\r\n}\r\nvoid update_msr(int cpu)\r\n{\r\nunsigned long long previous_msr;\r\nprevious_msr = put_msr(cpu, new_bias, MSR_IA32_ENERGY_PERF_BIAS);\r\nif (verbose)\r\nprintf("cpu%d msr0x%x 0x%016llx -> 0x%016llx\n",\r\ncpu, MSR_IA32_ENERGY_PERF_BIAS, previous_msr, new_bias);\r\nreturn;\r\n}\r\nvoid for_every_cpu(void (func)(int))\r\n{\r\nFILE *fp;\r\nint retval;\r\nfp = fopen(proc_stat, "r");\r\nif (fp == NULL) {\r\nperror(proc_stat);\r\nexit(1);\r\n}\r\nretval = fscanf(fp, "cpu %*d %*d %*d %*d %*d %*d %*d %*d %*d %*d\n");\r\nif (retval != 0) {\r\nperror("/proc/stat format");\r\nexit(1);\r\n}\r\nwhile (1) {\r\nint cpu;\r\nretval = fscanf(fp,\r\n"cpu%u %*d %*d %*d %*d %*d %*d %*d %*d %*d %*d\n",\r\n&cpu);\r\nif (retval != 1)\r\nreturn;\r\nfunc(cpu);\r\n}\r\nfclose(fp);\r\n}\r\nint main(int argc, char **argv)\r\n{\r\ncmdline(argc, argv);\r\nif (verbose > 1)\r\nprintf("x86_energy_perf_policy Nov 24, 2010"\r\n" - Len Brown <lenb@kernel.org>\n");\r\nif (verbose > 1 && !read_only)\r\nprintf("new_bias %lld\n", new_bias);\r\nvalidate_cpuid();\r\nif (cpu != -1) {\r\nif (read_only)\r\nprint_msr(cpu);\r\nelse\r\nupdate_msr(cpu);\r\n} else {\r\nif (read_only)\r\nfor_every_cpu(print_msr);\r\nelse\r\nfor_every_cpu(update_msr);\r\n}\r\nreturn 0;\r\n}

static int build_id__mark_dso_hit(union perf_event *event,\r\nstruct perf_sample *sample __used,\r\nstruct perf_evsel *evsel __used,\r\nstruct perf_session *session)\r\n{\r\nstruct addr_location al;\r\nu8 cpumode = event->header.misc & PERF_RECORD_MISC_CPUMODE_MASK;\r\nstruct thread *thread = perf_session__findnew(session, event->ip.pid);\r\nif (thread == NULL) {\r\npr_err("problem processing %d event, skipping it.\n",\r\nevent->header.type);\r\nreturn -1;\r\n}\r\nthread__find_addr_map(thread, session, cpumode, MAP__FUNCTION,\r\nevent->ip.pid, event->ip.ip, &al);\r\nif (al.map != NULL)\r\nal.map->dso->hit = 1;\r\nreturn 0;\r\n}\r\nstatic int perf_event__exit_del_thread(union perf_event *event,\r\nstruct perf_sample *sample __used,\r\nstruct perf_session *session)\r\n{\r\nstruct thread *thread = perf_session__findnew(session, event->fork.tid);\r\ndump_printf("(%d:%d):(%d:%d)\n", event->fork.pid, event->fork.tid,\r\nevent->fork.ppid, event->fork.ptid);\r\nif (thread) {\r\nrb_erase(&thread->rb_node, &session->threads);\r\nsession->last_match = NULL;\r\nthread__delete(thread);\r\n}\r\nreturn 0;\r\n}\r\nchar *dso__build_id_filename(struct dso *self, char *bf, size_t size)\r\n{\r\nchar build_id_hex[BUILD_ID_SIZE * 2 + 1];\r\nif (!self->has_build_id)\r\nreturn NULL;\r\nbuild_id__sprintf(self->build_id, sizeof(self->build_id), build_id_hex);\r\nif (bf == NULL) {\r\nif (asprintf(&bf, "%s/.build-id/%.2s/%s", buildid_dir,\r\nbuild_id_hex, build_id_hex + 2) < 0)\r\nreturn NULL;\r\n} else\r\nsnprintf(bf, size, "%s/.build-id/%.2s/%s", buildid_dir,\r\nbuild_id_hex, build_id_hex + 2);\r\nreturn bf;\r\n}

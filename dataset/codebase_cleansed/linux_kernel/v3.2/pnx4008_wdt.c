static void wdt_enable(void)\r\n{\r\nspin_lock(&io_lock);\r\n__raw_writel(RESET_COUNT, WDTIM_CTRL(wdt_base));\r\nwhile (__raw_readl(WDTIM_COUNTER(wdt_base)))\r\ncpu_relax();\r\n__raw_writel(M_RES2 | STOP_COUNT0 | RESET_COUNT0,\r\nWDTIM_MCTRL(wdt_base));\r\n__raw_writel(MATCH_OUTPUT_HIGH, WDTIM_EMR(wdt_base));\r\n__raw_writel(MATCH_INT, WDTIM_INT(wdt_base));\r\n__raw_writel(0xFFFF, WDTIM_PULSE(wdt_base));\r\n__raw_writel(heartbeat * WDOG_COUNTER_RATE, WDTIM_MATCH0(wdt_base));\r\n__raw_writel(COUNT_ENAB | DEBUG_EN, WDTIM_CTRL(wdt_base));\r\nspin_unlock(&io_lock);\r\n}\r\nstatic void wdt_disable(void)\r\n{\r\nspin_lock(&io_lock);\r\n__raw_writel(0, WDTIM_CTRL(wdt_base));\r\nspin_unlock(&io_lock);\r\n}\r\nstatic int pnx4008_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nint ret;\r\nif (test_and_set_bit(WDT_IN_USE, &wdt_status))\r\nreturn -EBUSY;\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nret = clk_enable(wdt_clk);\r\nif (ret) {\r\nclear_bit(WDT_IN_USE, &wdt_status);\r\nreturn ret;\r\n}\r\nwdt_enable();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic ssize_t pnx4008_wdt_write(struct file *file, const char *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nif (!nowayout) {\r\nsize_t i;\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nset_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\n}\r\n}\r\nwdt_enable();\r\n}\r\nreturn len;\r\n}\r\nstatic long pnx4008_wdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint ret = -ENOTTY;\r\nint time;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nret = copy_to_user((struct watchdog_info *)arg, &ident,\r\nsizeof(ident)) ? -EFAULT : 0;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\nret = put_user(0, (int *)arg);\r\nbreak;\r\ncase WDIOC_GETBOOTSTATUS:\r\nret = put_user(boot_status, (int *)arg);\r\nbreak;\r\ncase WDIOC_KEEPALIVE:\r\nwdt_enable();\r\nret = 0;\r\nbreak;\r\ncase WDIOC_SETTIMEOUT:\r\nret = get_user(time, (int *)arg);\r\nif (ret)\r\nbreak;\r\nif (time <= 0 || time > MAX_HEARTBEAT) {\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nheartbeat = time;\r\nwdt_enable();\r\ncase WDIOC_GETTIMEOUT:\r\nret = put_user(heartbeat, (int *)arg);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int pnx4008_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nif (!test_bit(WDT_OK_TO_CLOSE, &wdt_status))\r\nprintk(KERN_WARNING "WATCHDOG: Device closed unexpectdly\n");\r\nwdt_disable();\r\nclk_disable(wdt_clk);\r\nclear_bit(WDT_IN_USE, &wdt_status);\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nreturn 0;\r\n}\r\nstatic int __devinit pnx4008_wdt_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0, size;\r\nif (heartbeat < 1 || heartbeat > MAX_HEARTBEAT)\r\nheartbeat = DEFAULT_HEARTBEAT;\r\nprintk(KERN_INFO MODULE_NAME\r\n"PNX4008 Watchdog Timer: heartbeat %d sec\n", heartbeat);\r\nwdt_mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (wdt_mem == NULL) {\r\nprintk(KERN_INFO MODULE_NAME\r\n"failed to get memory region resouce\n");\r\nreturn -ENOENT;\r\n}\r\nsize = resource_size(wdt_mem);\r\nif (!request_mem_region(wdt_mem->start, size, pdev->name)) {\r\nprintk(KERN_INFO MODULE_NAME "failed to get memory region\n");\r\nreturn -ENOENT;\r\n}\r\nwdt_base = (void __iomem *)IO_ADDRESS(wdt_mem->start);\r\nwdt_clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(wdt_clk)) {\r\nret = PTR_ERR(wdt_clk);\r\nrelease_mem_region(wdt_mem->start, size);\r\nwdt_mem = NULL;\r\ngoto out;\r\n}\r\nret = clk_enable(wdt_clk);\r\nif (ret) {\r\nrelease_mem_region(wdt_mem->start, size);\r\nwdt_mem = NULL;\r\nclk_put(wdt_clk);\r\ngoto out;\r\n}\r\nret = misc_register(&pnx4008_wdt_miscdev);\r\nif (ret < 0) {\r\nprintk(KERN_ERR MODULE_NAME "cannot register misc device\n");\r\nrelease_mem_region(wdt_mem->start, size);\r\nwdt_mem = NULL;\r\nclk_disable(wdt_clk);\r\nclk_put(wdt_clk);\r\n} else {\r\nboot_status = (__raw_readl(WDTIM_RES(wdt_base)) & WDOG_RESET) ?\r\nWDIOF_CARDRESET : 0;\r\nwdt_disable();\r\nclk_disable(wdt_clk);\r\nset_bit(WDT_DEVICE_INITED, &wdt_status);\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nstatic int __devexit pnx4008_wdt_remove(struct platform_device *pdev)\r\n{\r\nmisc_deregister(&pnx4008_wdt_miscdev);\r\nclk_disable(wdt_clk);\r\nclk_put(wdt_clk);\r\nif (wdt_mem) {\r\nrelease_mem_region(wdt_mem->start, resource_size(wdt_mem));\r\nwdt_mem = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init pnx4008_wdt_init(void)\r\n{\r\nreturn platform_driver_register(&platform_wdt_driver);\r\n}\r\nstatic void __exit pnx4008_wdt_exit(void)\r\n{\r\nplatform_driver_unregister(&platform_wdt_driver);\r\n}

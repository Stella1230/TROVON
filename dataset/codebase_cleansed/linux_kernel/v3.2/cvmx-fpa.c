int cvmx_fpa_setup_pool(uint64_t pool, const char *name, void *buffer,\r\nuint64_t block_size, uint64_t num_blocks)\r\n{\r\nchar *ptr;\r\nif (!buffer) {\r\ncvmx_dprintf\r\n("ERROR: cvmx_fpa_setup_pool: NULL buffer pointer!\n");\r\nreturn -1;\r\n}\r\nif (pool >= CVMX_FPA_NUM_POOLS) {\r\ncvmx_dprintf("ERROR: cvmx_fpa_setup_pool: Illegal pool!\n");\r\nreturn -1;\r\n}\r\nif (block_size < CVMX_FPA_MIN_BLOCK_SIZE) {\r\ncvmx_dprintf\r\n("ERROR: cvmx_fpa_setup_pool: Block size too small.\n");\r\nreturn -1;\r\n}\r\nif (((unsigned long)buffer & (CVMX_FPA_ALIGNMENT - 1)) != 0) {\r\ncvmx_dprintf\r\n("ERROR: cvmx_fpa_setup_pool: Buffer not aligned properly.\n");\r\nreturn -1;\r\n}\r\ncvmx_fpa_pool_info[pool].name = name;\r\ncvmx_fpa_pool_info[pool].size = block_size;\r\ncvmx_fpa_pool_info[pool].starting_element_count = num_blocks;\r\ncvmx_fpa_pool_info[pool].base = buffer;\r\nptr = (char *)buffer;\r\nwhile (num_blocks--) {\r\ncvmx_fpa_free(ptr, pool, 0);\r\nptr += block_size;\r\n}\r\nreturn 0;\r\n}\r\nuint64_t cvmx_fpa_shutdown_pool(uint64_t pool)\r\n{\r\nuint64_t errors = 0;\r\nuint64_t count = 0;\r\nuint64_t base = cvmx_ptr_to_phys(cvmx_fpa_pool_info[pool].base);\r\nuint64_t finish =\r\nbase +\r\ncvmx_fpa_pool_info[pool].size *\r\ncvmx_fpa_pool_info[pool].starting_element_count;\r\nvoid *ptr;\r\nuint64_t address;\r\ncount = 0;\r\ndo {\r\nptr = cvmx_fpa_alloc(pool);\r\nif (ptr)\r\naddress = cvmx_ptr_to_phys(ptr);\r\nelse\r\naddress = 0;\r\nif (address) {\r\nif ((address >= base) && (address < finish) &&\r\n(((address -\r\nbase) % cvmx_fpa_pool_info[pool].size) == 0)) {\r\ncount++;\r\n} else {\r\ncvmx_dprintf\r\n("ERROR: cvmx_fpa_shutdown_pool: Illegal address 0x%llx in pool %s(%d)\n",\r\n(unsigned long long)address,\r\ncvmx_fpa_pool_info[pool].name, (int)pool);\r\nerrors++;\r\n}\r\n}\r\n} while (address);\r\n#ifdef CVMX_ENABLE_PKO_FUNCTIONS\r\nif (pool == 0)\r\ncvmx_ipd_free_ptr();\r\n#endif\r\nif (errors) {\r\ncvmx_dprintf\r\n("ERROR: cvmx_fpa_shutdown_pool: Pool %s(%d) started at 0x%llx, ended at 0x%llx, with a step of 0x%llx\n",\r\ncvmx_fpa_pool_info[pool].name, (int)pool,\r\n(unsigned long long)base, (unsigned long long)finish,\r\n(unsigned long long)cvmx_fpa_pool_info[pool].size);\r\nreturn -errors;\r\n} else\r\nreturn 0;\r\n}\r\nuint64_t cvmx_fpa_get_block_size(uint64_t pool)\r\n{\r\nswitch (pool) {\r\ncase 0:\r\nreturn CVMX_FPA_POOL_0_SIZE;\r\ncase 1:\r\nreturn CVMX_FPA_POOL_1_SIZE;\r\ncase 2:\r\nreturn CVMX_FPA_POOL_2_SIZE;\r\ncase 3:\r\nreturn CVMX_FPA_POOL_3_SIZE;\r\ncase 4:\r\nreturn CVMX_FPA_POOL_4_SIZE;\r\ncase 5:\r\nreturn CVMX_FPA_POOL_5_SIZE;\r\ncase 6:\r\nreturn CVMX_FPA_POOL_6_SIZE;\r\ncase 7:\r\nreturn CVMX_FPA_POOL_7_SIZE;\r\ndefault:\r\nreturn 0;\r\n}\r\n}

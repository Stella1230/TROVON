int __hash_page_huge(unsigned long ea, unsigned long access, unsigned long vsid,\r\npte_t *ptep, unsigned long trap, int local, int ssize,\r\nunsigned int shift, unsigned int mmu_psize)\r\n{\r\nunsigned long old_pte, new_pte;\r\nunsigned long va, rflags, pa, sz;\r\nlong slot;\r\nBUG_ON(shift != mmu_psize_defs[mmu_psize].shift);\r\nva = hpt_va(ea, vsid, ssize);\r\ndo {\r\nold_pte = pte_val(*ptep);\r\nif (unlikely(old_pte & _PAGE_BUSY))\r\nreturn 0;\r\nif (unlikely(access & ~old_pte))\r\nreturn 1;\r\nnew_pte = old_pte | _PAGE_BUSY | _PAGE_ACCESSED;\r\nif (access & _PAGE_RW)\r\nnew_pte |= _PAGE_DIRTY;\r\n} while(old_pte != __cmpxchg_u64((unsigned long *)ptep,\r\nold_pte, new_pte));\r\nrflags = 0x2 | (!(new_pte & _PAGE_RW));\r\nrflags |= ((new_pte & _PAGE_EXEC) ? 0 : HPTE_R_N);\r\nsz = ((1UL) << shift);\r\nif (!cpu_has_feature(CPU_FTR_COHERENT_ICACHE))\r\nrflags = hash_page_do_lazy_icache(rflags, __pte(old_pte), trap);\r\nif (unlikely(old_pte & _PAGE_HASHPTE)) {\r\nunsigned long hash, slot;\r\nhash = hpt_hash(va, shift, ssize);\r\nif (old_pte & _PAGE_F_SECOND)\r\nhash = ~hash;\r\nslot = (hash & htab_hash_mask) * HPTES_PER_GROUP;\r\nslot += (old_pte & _PAGE_F_GIX) >> 12;\r\nif (ppc_md.hpte_updatepp(slot, rflags, va, mmu_psize,\r\nssize, local) == -1)\r\nold_pte &= ~_PAGE_HPTEFLAGS;\r\n}\r\nif (likely(!(old_pte & _PAGE_HASHPTE))) {\r\nunsigned long hash = hpt_hash(va, shift, ssize);\r\nunsigned long hpte_group;\r\npa = pte_pfn(__pte(old_pte)) << PAGE_SHIFT;\r\nrepeat:\r\nhpte_group = ((hash & htab_hash_mask) *\r\nHPTES_PER_GROUP) & ~0x7UL;\r\n#ifdef CONFIG_PPC_64K_PAGES\r\nnew_pte = (new_pte & ~_PAGE_HPTEFLAGS) | _PAGE_HPTE_SUB0;\r\n#else\r\nnew_pte = (new_pte & ~_PAGE_HPTEFLAGS) | _PAGE_HASHPTE;\r\n#endif\r\nrflags |= (new_pte & (_PAGE_WRITETHRU | _PAGE_NO_CACHE |\r\n_PAGE_COHERENT | _PAGE_GUARDED));\r\nslot = ppc_md.hpte_insert(hpte_group, va, pa, rflags, 0,\r\nmmu_psize, ssize);\r\nif (unlikely(slot == -1)) {\r\nhpte_group = ((~hash & htab_hash_mask) *\r\nHPTES_PER_GROUP) & ~0x7UL;\r\nslot = ppc_md.hpte_insert(hpte_group, va, pa, rflags,\r\nHPTE_V_SECONDARY,\r\nmmu_psize, ssize);\r\nif (slot == -1) {\r\nif (mftb() & 0x1)\r\nhpte_group = ((hash & htab_hash_mask) *\r\nHPTES_PER_GROUP)&~0x7UL;\r\nppc_md.hpte_remove(hpte_group);\r\ngoto repeat;\r\n}\r\n}\r\nif (unlikely(slot == -2)) {\r\n*ptep = __pte(old_pte);\r\nhash_failure_debug(ea, access, vsid, trap, ssize,\r\nmmu_psize, old_pte);\r\nreturn -1;\r\n}\r\nnew_pte |= (slot << 12) & (_PAGE_F_SECOND | _PAGE_F_GIX);\r\n}\r\n*ptep = __pte(new_pte & ~_PAGE_BUSY);\r\nreturn 0;\r\n}

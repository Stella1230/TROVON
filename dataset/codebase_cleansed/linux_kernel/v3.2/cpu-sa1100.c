static void sa1100_update_dram_timings(int current_speed, int new_speed)\r\n{\r\nstruct sa1100_dram_regs *settings = sa1100_dram_settings;\r\nwhile (settings->speed != 0) {\r\nif (new_speed == settings->speed)\r\nbreak;\r\nsettings++;\r\n}\r\nif (settings->speed == 0) {\r\npanic("%s: couldn't find dram setting for speed %d\n",\r\n__func__, new_speed);\r\n}\r\nif (new_speed > current_speed) {\r\nMDCNFG |= MDCNFG_CDB2;\r\nMDCAS2 = settings->mdcas2;\r\nMDCAS1 = settings->mdcas1;\r\nMDCAS0 = settings->mdcas0;\r\nMDCNFG = settings->mdcnfg;\r\n} else {\r\nMDCNFG |= MDCNFG_CDB2;\r\nMDCAS0 = settings->mdcas0;\r\nMDCAS1 = settings->mdcas1;\r\nMDCAS2 = settings->mdcas2;\r\nMDCNFG = settings->mdcnfg;\r\n}\r\n}\r\nstatic int sa1100_target(struct cpufreq_policy *policy,\r\nunsigned int target_freq,\r\nunsigned int relation)\r\n{\r\nunsigned int cur = sa11x0_getspeed(0);\r\nunsigned int new_ppcr;\r\nstruct cpufreq_freqs freqs;\r\nnew_ppcr = sa11x0_freq_to_ppcr(target_freq);\r\nswitch (relation) {\r\ncase CPUFREQ_RELATION_L:\r\nif (sa11x0_ppcr_to_freq(new_ppcr) > policy->max)\r\nnew_ppcr--;\r\nbreak;\r\ncase CPUFREQ_RELATION_H:\r\nif ((sa11x0_ppcr_to_freq(new_ppcr) > target_freq) &&\r\n(sa11x0_ppcr_to_freq(new_ppcr - 1) >= policy->min))\r\nnew_ppcr--;\r\nbreak;\r\n}\r\nfreqs.old = cur;\r\nfreqs.new = sa11x0_ppcr_to_freq(new_ppcr);\r\nfreqs.cpu = 0;\r\ncpufreq_notify_transition(&freqs, CPUFREQ_PRECHANGE);\r\nif (freqs.new > cur)\r\nsa1100_update_dram_timings(cur, freqs.new);\r\nPPCR = new_ppcr;\r\nif (freqs.new < cur)\r\nsa1100_update_dram_timings(cur, freqs.new);\r\ncpufreq_notify_transition(&freqs, CPUFREQ_POSTCHANGE);\r\nreturn 0;\r\n}\r\nstatic int __init sa1100_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nif (policy->cpu != 0)\r\nreturn -EINVAL;\r\npolicy->cur = policy->min = policy->max = sa11x0_getspeed(0);\r\npolicy->cpuinfo.min_freq = 59000;\r\npolicy->cpuinfo.max_freq = 287000;\r\npolicy->cpuinfo.transition_latency = CPUFREQ_ETERNAL;\r\nreturn 0;\r\n}\r\nstatic int __init sa1100_dram_init(void)\r\n{\r\nif (cpu_is_sa1100())\r\nreturn cpufreq_register_driver(&sa1100_driver);\r\nelse\r\nreturn -ENODEV;\r\n}

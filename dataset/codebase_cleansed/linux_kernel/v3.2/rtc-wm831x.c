static int wm831x_rtc_readtime(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct wm831x_rtc *wm831x_rtc = dev_get_drvdata(dev);\r\nstruct wm831x *wm831x = wm831x_rtc->wm831x;\r\nu16 time1[2], time2[2];\r\nint ret;\r\nint count = 0;\r\nret = wm831x_reg_read(wm831x, WM831X_RTC_CONTROL);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to read RTC control: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (!(ret & WM831X_RTC_VALID)) {\r\ndev_dbg(dev, "RTC not yet configured\n");\r\nreturn -EINVAL;\r\n}\r\ndo {\r\nret = wm831x_bulk_read(wm831x, WM831X_RTC_TIME_1,\r\n2, time1);\r\nif (ret != 0)\r\ncontinue;\r\nret = wm831x_bulk_read(wm831x, WM831X_RTC_TIME_1,\r\n2, time2);\r\nif (ret != 0)\r\ncontinue;\r\nif (memcmp(time1, time2, sizeof(time1)) == 0) {\r\nu32 time = (time1[0] << 16) | time1[1];\r\nrtc_time_to_tm(time, tm);\r\nreturn rtc_valid_tm(tm);\r\n}\r\n} while (++count < WM831X_GET_TIME_RETRIES);\r\ndev_err(dev, "Timed out reading current time\n");\r\nreturn -EIO;\r\n}\r\nstatic int wm831x_rtc_set_mmss(struct device *dev, unsigned long time)\r\n{\r\nstruct wm831x_rtc *wm831x_rtc = dev_get_drvdata(dev);\r\nstruct wm831x *wm831x = wm831x_rtc->wm831x;\r\nstruct rtc_time new_tm;\r\nunsigned long new_time;\r\nint ret;\r\nint count = 0;\r\nret = wm831x_reg_write(wm831x, WM831X_RTC_TIME_1,\r\n(time >> 16) & 0xffff);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to write TIME_1: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = wm831x_reg_write(wm831x, WM831X_RTC_TIME_2, time & 0xffff);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to write TIME_2: %d\n", ret);\r\nreturn ret;\r\n}\r\ndo {\r\nmsleep(1);\r\nret = wm831x_reg_read(wm831x, WM831X_RTC_CONTROL);\r\nif (ret < 0)\r\nret = WM831X_RTC_SYNC_BUSY;\r\n} while (!(ret & WM831X_RTC_SYNC_BUSY) &&\r\n++count < WM831X_SET_TIME_RETRIES);\r\nif (ret & WM831X_RTC_SYNC_BUSY) {\r\ndev_err(dev, "Timed out writing RTC update\n");\r\nreturn -EIO;\r\n}\r\nret = wm831x_rtc_readtime(dev, &new_tm);\r\nif (ret < 0)\r\nreturn ret;\r\nret = rtc_tm_to_time(&new_tm, &new_time);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to convert time: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (new_time - time > 1) {\r\ndev_err(dev, "RTC update not permitted by hardware\n");\r\nreturn -EPERM;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wm831x_rtc_readalarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct wm831x_rtc *wm831x_rtc = dev_get_drvdata(dev);\r\nint ret;\r\nu16 data[2];\r\nu32 time;\r\nret = wm831x_bulk_read(wm831x_rtc->wm831x, WM831X_RTC_ALARM_1,\r\n2, data);\r\nif (ret != 0) {\r\ndev_err(dev, "Failed to read alarm time: %d\n", ret);\r\nreturn ret;\r\n}\r\ntime = (data[0] << 16) | data[1];\r\nrtc_time_to_tm(time, &alrm->time);\r\nret = wm831x_reg_read(wm831x_rtc->wm831x, WM831X_RTC_CONTROL);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to read RTC control: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (ret & WM831X_RTC_ALM_ENA)\r\nalrm->enabled = 1;\r\nelse\r\nalrm->enabled = 0;\r\nreturn 0;\r\n}\r\nstatic int wm831x_rtc_stop_alarm(struct wm831x_rtc *wm831x_rtc)\r\n{\r\nwm831x_rtc->alarm_enabled = 0;\r\nreturn wm831x_set_bits(wm831x_rtc->wm831x, WM831X_RTC_CONTROL,\r\nWM831X_RTC_ALM_ENA, 0);\r\n}\r\nstatic int wm831x_rtc_start_alarm(struct wm831x_rtc *wm831x_rtc)\r\n{\r\nwm831x_rtc->alarm_enabled = 1;\r\nreturn wm831x_set_bits(wm831x_rtc->wm831x, WM831X_RTC_CONTROL,\r\nWM831X_RTC_ALM_ENA, WM831X_RTC_ALM_ENA);\r\n}\r\nstatic int wm831x_rtc_setalarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct wm831x_rtc *wm831x_rtc = dev_get_drvdata(dev);\r\nstruct wm831x *wm831x = wm831x_rtc->wm831x;\r\nint ret;\r\nunsigned long time;\r\nret = rtc_tm_to_time(&alrm->time, &time);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to convert time: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = wm831x_rtc_stop_alarm(wm831x_rtc);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to stop alarm: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = wm831x_reg_write(wm831x, WM831X_RTC_ALARM_1,\r\n(time >> 16) & 0xffff);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to write ALARM_1: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = wm831x_reg_write(wm831x, WM831X_RTC_ALARM_2, time & 0xffff);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to write ALARM_2: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (alrm->enabled) {\r\nret = wm831x_rtc_start_alarm(wm831x_rtc);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to start alarm: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int wm831x_rtc_alarm_irq_enable(struct device *dev,\r\nunsigned int enabled)\r\n{\r\nstruct wm831x_rtc *wm831x_rtc = dev_get_drvdata(dev);\r\nif (enabled)\r\nreturn wm831x_rtc_start_alarm(wm831x_rtc);\r\nelse\r\nreturn wm831x_rtc_stop_alarm(wm831x_rtc);\r\n}\r\nstatic irqreturn_t wm831x_alm_irq(int irq, void *data)\r\n{\r\nstruct wm831x_rtc *wm831x_rtc = data;\r\nrtc_update_irq(wm831x_rtc->rtc, 1, RTC_IRQF | RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t wm831x_per_irq(int irq, void *data)\r\n{\r\nstruct wm831x_rtc *wm831x_rtc = data;\r\nrtc_update_irq(wm831x_rtc->rtc, 1, RTC_IRQF | RTC_UF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int wm831x_rtc_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct wm831x_rtc *wm831x_rtc = dev_get_drvdata(&pdev->dev);\r\nint ret, enable;\r\nif (wm831x_rtc->alarm_enabled && device_may_wakeup(&pdev->dev))\r\nenable = WM831X_RTC_ALM_ENA;\r\nelse\r\nenable = 0;\r\nret = wm831x_set_bits(wm831x_rtc->wm831x, WM831X_RTC_CONTROL,\r\nWM831X_RTC_ALM_ENA, enable);\r\nif (ret != 0)\r\ndev_err(&pdev->dev, "Failed to update RTC alarm: %d\n", ret);\r\nreturn 0;\r\n}\r\nstatic int wm831x_rtc_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct wm831x_rtc *wm831x_rtc = dev_get_drvdata(&pdev->dev);\r\nint ret;\r\nif (wm831x_rtc->alarm_enabled) {\r\nret = wm831x_rtc_start_alarm(wm831x_rtc);\r\nif (ret != 0)\r\ndev_err(&pdev->dev,\r\n"Failed to restart RTC alarm: %d\n", ret);\r\n}\r\nreturn 0;\r\n}\r\nstatic int wm831x_rtc_freeze(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct wm831x_rtc *wm831x_rtc = dev_get_drvdata(&pdev->dev);\r\nint ret;\r\nret = wm831x_set_bits(wm831x_rtc->wm831x, WM831X_RTC_CONTROL,\r\nWM831X_RTC_ALM_ENA, 0);\r\nif (ret != 0)\r\ndev_err(&pdev->dev, "Failed to stop RTC alarm: %d\n", ret);\r\nreturn 0;\r\n}\r\nstatic int wm831x_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct wm831x *wm831x = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm831x_rtc *wm831x_rtc;\r\nint per_irq = platform_get_irq_byname(pdev, "PER");\r\nint alm_irq = platform_get_irq_byname(pdev, "ALM");\r\nint ret = 0;\r\nwm831x_rtc = kzalloc(sizeof(*wm831x_rtc), GFP_KERNEL);\r\nif (wm831x_rtc == NULL)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, wm831x_rtc);\r\nwm831x_rtc->wm831x = wm831x;\r\nret = wm831x_reg_read(wm831x, WM831X_RTC_CONTROL);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to read RTC control: %d\n", ret);\r\ngoto err;\r\n}\r\nif (ret & WM831X_RTC_ALM_ENA)\r\nwm831x_rtc->alarm_enabled = 1;\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nwm831x_rtc->rtc = rtc_device_register("wm831x", &pdev->dev,\r\n&wm831x_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(wm831x_rtc->rtc)) {\r\nret = PTR_ERR(wm831x_rtc->rtc);\r\ngoto err;\r\n}\r\nret = request_threaded_irq(per_irq, NULL, wm831x_per_irq,\r\nIRQF_TRIGGER_RISING, "RTC period",\r\nwm831x_rtc);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev, "Failed to request periodic IRQ %d: %d\n",\r\nper_irq, ret);\r\n}\r\nret = request_threaded_irq(alm_irq, NULL, wm831x_alm_irq,\r\nIRQF_TRIGGER_RISING, "RTC alarm",\r\nwm831x_rtc);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev, "Failed to request alarm IRQ %d: %d\n",\r\nalm_irq, ret);\r\n}\r\nreturn 0;\r\nerr:\r\nkfree(wm831x_rtc);\r\nreturn ret;\r\n}\r\nstatic int __devexit wm831x_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct wm831x_rtc *wm831x_rtc = platform_get_drvdata(pdev);\r\nint per_irq = platform_get_irq_byname(pdev, "PER");\r\nint alm_irq = platform_get_irq_byname(pdev, "ALM");\r\nfree_irq(alm_irq, wm831x_rtc);\r\nfree_irq(per_irq, wm831x_rtc);\r\nrtc_device_unregister(wm831x_rtc->rtc);\r\nkfree(wm831x_rtc);\r\nreturn 0;\r\n}\r\nstatic int __init wm831x_rtc_init(void)\r\n{\r\nreturn platform_driver_register(&wm831x_rtc_driver);\r\n}\r\nstatic void __exit wm831x_rtc_exit(void)\r\n{\r\nplatform_driver_unregister(&wm831x_rtc_driver);\r\n}

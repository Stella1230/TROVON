static int init_hw(struct echoaudio *chip, u16 device_id, u16 subdevice_id)\r\n{\r\nint err;\r\nDE_INIT(("init_hw() - Gina20\n"));\r\nif (snd_BUG_ON((subdevice_id & 0xfff0) != GINA20))\r\nreturn -ENODEV;\r\nif ((err = init_dsp_comm_page(chip))) {\r\nDE_INIT(("init_hw - could not initialize DSP comm page\n"));\r\nreturn err;\r\n}\r\nchip->device_id = device_id;\r\nchip->subdevice_id = subdevice_id;\r\nchip->bad_board = TRUE;\r\nchip->dsp_code_to_load = FW_GINA20_DSP;\r\nchip->spdif_status = GD_SPDIF_STATUS_UNDEF;\r\nchip->clock_state = GD_CLOCK_UNDEF;\r\nchip->asic_loaded = TRUE;\r\nchip->input_clock_types = ECHO_CLOCK_BIT_INTERNAL |\r\nECHO_CLOCK_BIT_SPDIF;\r\nif ((err = load_firmware(chip)) < 0)\r\nreturn err;\r\nchip->bad_board = FALSE;\r\nDE_INIT(("init_hw done\n"));\r\nreturn err;\r\n}\r\nstatic int set_mixer_defaults(struct echoaudio *chip)\r\n{\r\nchip->professional_spdif = FALSE;\r\nreturn init_line_levels(chip);\r\n}\r\nstatic u32 detect_input_clocks(const struct echoaudio *chip)\r\n{\r\nu32 clocks_from_dsp, clock_bits;\r\nclocks_from_dsp = le32_to_cpu(chip->comm_page->status_clocks);\r\nclock_bits = ECHO_CLOCK_BIT_INTERNAL;\r\nif (clocks_from_dsp & GLDM_CLOCK_DETECT_BIT_SPDIF)\r\nclock_bits |= ECHO_CLOCK_BIT_SPDIF;\r\nreturn clock_bits;\r\n}\r\nstatic int load_asic(struct echoaudio *chip)\r\n{\r\nreturn 0;\r\n}\r\nstatic int set_sample_rate(struct echoaudio *chip, u32 rate)\r\n{\r\nu8 clock_state, spdif_status;\r\nif (wait_handshake(chip))\r\nreturn -EIO;\r\nswitch (rate) {\r\ncase 44100:\r\nclock_state = GD_CLOCK_44;\r\nspdif_status = GD_SPDIF_STATUS_44;\r\nbreak;\r\ncase 48000:\r\nclock_state = GD_CLOCK_48;\r\nspdif_status = GD_SPDIF_STATUS_48;\r\nbreak;\r\ndefault:\r\nclock_state = GD_CLOCK_NOCHANGE;\r\nspdif_status = GD_SPDIF_STATUS_NOCHANGE;\r\nbreak;\r\n}\r\nif (chip->clock_state == clock_state)\r\nclock_state = GD_CLOCK_NOCHANGE;\r\nif (spdif_status == chip->spdif_status)\r\nspdif_status = GD_SPDIF_STATUS_NOCHANGE;\r\nchip->comm_page->sample_rate = cpu_to_le32(rate);\r\nchip->comm_page->gd_clock_state = clock_state;\r\nchip->comm_page->gd_spdif_status = spdif_status;\r\nchip->comm_page->gd_resampler_state = 3;\r\nif (clock_state != GD_CLOCK_NOCHANGE)\r\nchip->clock_state = clock_state;\r\nif (spdif_status != GD_SPDIF_STATUS_NOCHANGE)\r\nchip->spdif_status = spdif_status;\r\nchip->sample_rate = rate;\r\nclear_handshake(chip);\r\nreturn send_vector(chip, DSP_VC_SET_GD_AUDIO_STATE);\r\n}\r\nstatic int set_input_clock(struct echoaudio *chip, u16 clock)\r\n{\r\nDE_ACT(("set_input_clock:\n"));\r\nswitch (clock) {\r\ncase ECHO_CLOCK_INTERNAL:\r\nchip->clock_state = GD_CLOCK_UNDEF;\r\nchip->spdif_status = GD_SPDIF_STATUS_UNDEF;\r\nset_sample_rate(chip, chip->sample_rate);\r\nchip->input_clock = clock;\r\nDE_ACT(("Set Gina clock to INTERNAL\n"));\r\nbreak;\r\ncase ECHO_CLOCK_SPDIF:\r\nchip->comm_page->gd_clock_state = GD_CLOCK_SPDIFIN;\r\nchip->comm_page->gd_spdif_status = GD_SPDIF_STATUS_NOCHANGE;\r\nclear_handshake(chip);\r\nsend_vector(chip, DSP_VC_SET_GD_AUDIO_STATE);\r\nchip->clock_state = GD_CLOCK_SPDIFIN;\r\nDE_ACT(("Set Gina20 clock to SPDIF\n"));\r\nchip->input_clock = clock;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int set_input_gain(struct echoaudio *chip, u16 input, int gain)\r\n{\r\nif (snd_BUG_ON(input >= num_busses_in(chip)))\r\nreturn -EINVAL;\r\nif (wait_handshake(chip))\r\nreturn -EIO;\r\nchip->input_gain[input] = gain;\r\ngain += GL20_INPUT_GAIN_MAGIC_NUMBER;\r\nchip->comm_page->line_in_level[input] = gain;\r\nreturn 0;\r\n}\r\nstatic int update_flags(struct echoaudio *chip)\r\n{\r\nif (wait_handshake(chip))\r\nreturn -EIO;\r\nclear_handshake(chip);\r\nreturn send_vector(chip, DSP_VC_UPDATE_FLAGS);\r\n}\r\nstatic int set_professional_spdif(struct echoaudio *chip, char prof)\r\n{\r\nDE_ACT(("set_professional_spdif %d\n", prof));\r\nif (prof)\r\nchip->comm_page->flags |=\r\ncpu_to_le32(DSP_FLAG_PROFESSIONAL_SPDIF);\r\nelse\r\nchip->comm_page->flags &=\r\n~cpu_to_le32(DSP_FLAG_PROFESSIONAL_SPDIF);\r\nchip->professional_spdif = prof;\r\nreturn update_flags(chip);\r\n}

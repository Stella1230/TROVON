static int rdc_gpio_get_value(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nstruct rdc321x_gpio *gpch;\r\nu32 value = 0;\r\nint reg;\r\ngpch = container_of(chip, struct rdc321x_gpio, chip);\r\nreg = gpio < 32 ? gpch->reg1_data_base : gpch->reg2_data_base;\r\nspin_lock(&gpch->lock);\r\npci_write_config_dword(gpch->sb_pdev, reg,\r\ngpch->data_reg[gpio < 32 ? 0 : 1]);\r\npci_read_config_dword(gpch->sb_pdev, reg, &value);\r\nspin_unlock(&gpch->lock);\r\nreturn (1 << (gpio & 0x1f)) & value ? 1 : 0;\r\n}\r\nstatic void rdc_gpio_set_value_impl(struct gpio_chip *chip,\r\nunsigned gpio, int value)\r\n{\r\nstruct rdc321x_gpio *gpch;\r\nint reg = (gpio < 32) ? 0 : 1;\r\ngpch = container_of(chip, struct rdc321x_gpio, chip);\r\nif (value)\r\ngpch->data_reg[reg] |= 1 << (gpio & 0x1f);\r\nelse\r\ngpch->data_reg[reg] &= ~(1 << (gpio & 0x1f));\r\npci_write_config_dword(gpch->sb_pdev,\r\nreg ? gpch->reg2_data_base : gpch->reg1_data_base,\r\ngpch->data_reg[reg]);\r\n}\r\nstatic void rdc_gpio_set_value(struct gpio_chip *chip,\r\nunsigned gpio, int value)\r\n{\r\nstruct rdc321x_gpio *gpch;\r\ngpch = container_of(chip, struct rdc321x_gpio, chip);\r\nspin_lock(&gpch->lock);\r\nrdc_gpio_set_value_impl(chip, gpio, value);\r\nspin_unlock(&gpch->lock);\r\n}\r\nstatic int rdc_gpio_config(struct gpio_chip *chip,\r\nunsigned gpio, int value)\r\n{\r\nstruct rdc321x_gpio *gpch;\r\nint err;\r\nu32 reg;\r\ngpch = container_of(chip, struct rdc321x_gpio, chip);\r\nspin_lock(&gpch->lock);\r\nerr = pci_read_config_dword(gpch->sb_pdev, gpio < 32 ?\r\ngpch->reg1_ctrl_base : gpch->reg2_ctrl_base, &reg);\r\nif (err)\r\ngoto unlock;\r\nreg |= 1 << (gpio & 0x1f);\r\nerr = pci_write_config_dword(gpch->sb_pdev, gpio < 32 ?\r\ngpch->reg1_ctrl_base : gpch->reg2_ctrl_base, reg);\r\nif (err)\r\ngoto unlock;\r\nrdc_gpio_set_value_impl(chip, gpio, value);\r\nunlock:\r\nspin_unlock(&gpch->lock);\r\nreturn err;\r\n}\r\nstatic int rdc_gpio_direction_input(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nreturn rdc_gpio_config(chip, gpio, 1);\r\n}\r\nstatic int __devinit rdc321x_gpio_probe(struct platform_device *pdev)\r\n{\r\nint err;\r\nstruct resource *r;\r\nstruct rdc321x_gpio *rdc321x_gpio_dev;\r\nstruct rdc321x_gpio_pdata *pdata;\r\npdata = pdev->dev.platform_data;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "no platform data supplied\n");\r\nreturn -ENODEV;\r\n}\r\nrdc321x_gpio_dev = kzalloc(sizeof(struct rdc321x_gpio), GFP_KERNEL);\r\nif (!rdc321x_gpio_dev) {\r\ndev_err(&pdev->dev, "failed to allocate private data\n");\r\nreturn -ENOMEM;\r\n}\r\nr = platform_get_resource_byname(pdev, IORESOURCE_IO, "gpio-reg1");\r\nif (!r) {\r\ndev_err(&pdev->dev, "failed to get gpio-reg1 resource\n");\r\nerr = -ENODEV;\r\ngoto out_free;\r\n}\r\nspin_lock_init(&rdc321x_gpio_dev->lock);\r\nrdc321x_gpio_dev->sb_pdev = pdata->sb_pdev;\r\nrdc321x_gpio_dev->reg1_ctrl_base = r->start;\r\nrdc321x_gpio_dev->reg1_data_base = r->start + 0x4;\r\nr = platform_get_resource_byname(pdev, IORESOURCE_IO, "gpio-reg2");\r\nif (!r) {\r\ndev_err(&pdev->dev, "failed to get gpio-reg2 resource\n");\r\nerr = -ENODEV;\r\ngoto out_free;\r\n}\r\nrdc321x_gpio_dev->reg2_ctrl_base = r->start;\r\nrdc321x_gpio_dev->reg2_data_base = r->start + 0x4;\r\nrdc321x_gpio_dev->chip.label = "rdc321x-gpio";\r\nrdc321x_gpio_dev->chip.direction_input = rdc_gpio_direction_input;\r\nrdc321x_gpio_dev->chip.direction_output = rdc_gpio_config;\r\nrdc321x_gpio_dev->chip.get = rdc_gpio_get_value;\r\nrdc321x_gpio_dev->chip.set = rdc_gpio_set_value;\r\nrdc321x_gpio_dev->chip.base = 0;\r\nrdc321x_gpio_dev->chip.ngpio = pdata->max_gpios;\r\nplatform_set_drvdata(pdev, rdc321x_gpio_dev);\r\nerr = pci_read_config_dword(rdc321x_gpio_dev->sb_pdev,\r\nrdc321x_gpio_dev->reg1_data_base,\r\n&rdc321x_gpio_dev->data_reg[0]);\r\nif (err)\r\ngoto out_drvdata;\r\nerr = pci_read_config_dword(rdc321x_gpio_dev->sb_pdev,\r\nrdc321x_gpio_dev->reg2_data_base,\r\n&rdc321x_gpio_dev->data_reg[1]);\r\nif (err)\r\ngoto out_drvdata;\r\ndev_info(&pdev->dev, "registering %d GPIOs\n",\r\nrdc321x_gpio_dev->chip.ngpio);\r\nreturn gpiochip_add(&rdc321x_gpio_dev->chip);\r\nout_drvdata:\r\nplatform_set_drvdata(pdev, NULL);\r\nout_free:\r\nkfree(rdc321x_gpio_dev);\r\nreturn err;\r\n}\r\nstatic int __devexit rdc321x_gpio_remove(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct rdc321x_gpio *rdc321x_gpio_dev = platform_get_drvdata(pdev);\r\nret = gpiochip_remove(&rdc321x_gpio_dev->chip);\r\nif (ret)\r\ndev_err(&pdev->dev, "failed to unregister chip\n");\r\nkfree(rdc321x_gpio_dev);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn ret;\r\n}\r\nstatic int __init rdc321x_gpio_init(void)\r\n{\r\nreturn platform_driver_register(&rdc321x_gpio_driver);\r\n}\r\nstatic void __exit rdc321x_gpio_exit(void)\r\n{\r\nplatform_driver_unregister(&rdc321x_gpio_driver);\r\n}

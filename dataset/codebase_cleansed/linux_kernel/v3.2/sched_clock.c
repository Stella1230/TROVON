static void sched_clock_poll(unsigned long wrap_ticks)\r\n{\r\nmod_timer(&sched_clock_timer, round_jiffies(jiffies + wrap_ticks));\r\nsched_clock_update_fn();\r\n}\r\nvoid __init init_sched_clock(struct clock_data *cd, void (*update)(void),\r\nunsigned int clock_bits, unsigned long rate)\r\n{\r\nunsigned long r, w;\r\nu64 res, wrap;\r\nchar r_unit;\r\nsched_clock_update_fn = update;\r\nclocks_calc_mult_shift(&cd->mult, &cd->shift, rate, NSEC_PER_SEC, 0);\r\nr = rate;\r\nif (r >= 4000000) {\r\nr /= 1000000;\r\nr_unit = 'M';\r\n} else {\r\nr /= 1000;\r\nr_unit = 'k';\r\n}\r\nwrap = cyc_to_ns((1ULL << clock_bits) - 1, cd->mult, cd->shift);\r\ndo_div(wrap, NSEC_PER_MSEC);\r\nw = wrap;\r\nres = cyc_to_ns(1ULL, cd->mult, cd->shift);\r\npr_info("sched_clock: %u bits at %lu%cHz, resolution %lluns, wraps every %lums\n",\r\nclock_bits, r, r_unit, res, w);\r\nsched_clock_timer.data = msecs_to_jiffies(w - (w / 10));\r\nupdate();\r\ncd->epoch_ns = 0;\r\n}\r\nvoid __init sched_clock_postinit(void)\r\n{\r\nsched_clock_poll(sched_clock_timer.data);\r\n}

static int fan_get_max_state(struct thermal_cooling_device *cdev, unsigned long\r\n*state)\r\n{\r\n*state = 1;\r\nreturn 0;\r\n}\r\nstatic int fan_get_cur_state(struct thermal_cooling_device *cdev, unsigned long\r\n*state)\r\n{\r\nstruct acpi_device *device = cdev->devdata;\r\nint result;\r\nint acpi_state;\r\nif (!device)\r\nreturn -EINVAL;\r\nresult = acpi_bus_update_power(device->handle, &acpi_state);\r\nif (result)\r\nreturn result;\r\n*state = (acpi_state == ACPI_STATE_D3 ? 0 :\r\n(acpi_state == ACPI_STATE_D0 ? 1 : -1));\r\nreturn 0;\r\n}\r\nstatic int\r\nfan_set_cur_state(struct thermal_cooling_device *cdev, unsigned long state)\r\n{\r\nstruct acpi_device *device = cdev->devdata;\r\nint result;\r\nif (!device || (state != 0 && state != 1))\r\nreturn -EINVAL;\r\nresult = acpi_bus_set_power(device->handle,\r\nstate ? ACPI_STATE_D0 : ACPI_STATE_D3);\r\nreturn result;\r\n}\r\nstatic int acpi_fan_add(struct acpi_device *device)\r\n{\r\nint result = 0;\r\nstruct thermal_cooling_device *cdev;\r\nif (!device)\r\nreturn -EINVAL;\r\nstrcpy(acpi_device_name(device), "Fan");\r\nstrcpy(acpi_device_class(device), ACPI_FAN_CLASS);\r\nresult = acpi_bus_update_power(device->handle, NULL);\r\nif (result) {\r\nprintk(KERN_ERR PREFIX "Setting initial power state\n");\r\ngoto end;\r\n}\r\ncdev = thermal_cooling_device_register("Fan", device,\r\n&fan_cooling_ops);\r\nif (IS_ERR(cdev)) {\r\nresult = PTR_ERR(cdev);\r\ngoto end;\r\n}\r\ndev_dbg(&device->dev, "registered as cooling_device%d\n", cdev->id);\r\ndevice->driver_data = cdev;\r\nresult = sysfs_create_link(&device->dev.kobj,\r\n&cdev->device.kobj,\r\n"thermal_cooling");\r\nif (result)\r\ndev_err(&device->dev, "Failed to create sysfs link "\r\n"'thermal_cooling'\n");\r\nresult = sysfs_create_link(&cdev->device.kobj,\r\n&device->dev.kobj,\r\n"device");\r\nif (result)\r\ndev_err(&device->dev, "Failed to create sysfs link "\r\n"'device'\n");\r\nprintk(KERN_INFO PREFIX "%s [%s] (%s)\n",\r\nacpi_device_name(device), acpi_device_bid(device),\r\n!device->power.state ? "on" : "off");\r\nend:\r\nreturn result;\r\n}\r\nstatic int acpi_fan_remove(struct acpi_device *device, int type)\r\n{\r\nstruct thermal_cooling_device *cdev = acpi_driver_data(device);\r\nif (!device || !cdev)\r\nreturn -EINVAL;\r\nsysfs_remove_link(&device->dev.kobj, "thermal_cooling");\r\nsysfs_remove_link(&cdev->device.kobj, "device");\r\nthermal_cooling_device_unregister(cdev);\r\nreturn 0;\r\n}\r\nstatic int acpi_fan_suspend(struct acpi_device *device, pm_message_t state)\r\n{\r\nif (!device)\r\nreturn -EINVAL;\r\nacpi_bus_set_power(device->handle, ACPI_STATE_D0);\r\nreturn AE_OK;\r\n}\r\nstatic int acpi_fan_resume(struct acpi_device *device)\r\n{\r\nint result;\r\nif (!device)\r\nreturn -EINVAL;\r\nresult = acpi_bus_update_power(device->handle, NULL);\r\nif (result)\r\nprintk(KERN_ERR PREFIX "Error updating fan power state\n");\r\nreturn result;\r\n}\r\nstatic int __init acpi_fan_init(void)\r\n{\r\nint result = 0;\r\nresult = acpi_bus_register_driver(&acpi_fan_driver);\r\nif (result < 0)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic void __exit acpi_fan_exit(void)\r\n{\r\nacpi_bus_unregister_driver(&acpi_fan_driver);\r\nreturn;\r\n}

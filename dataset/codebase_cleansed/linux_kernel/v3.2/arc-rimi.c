static int __init arcrimi_probe(struct net_device *dev)\r\n{\r\nBUGLVL(D_NORMAL) printk(VERSION);\r\nBUGLVL(D_NORMAL) printk("E-mail me if you actually test the RIM I driver, please!\n");\r\nBUGMSG(D_NORMAL, "Given: node %02Xh, shmem %lXh, irq %d\n",\r\ndev->dev_addr[0], dev->mem_start, dev->irq);\r\nif (dev->mem_start <= 0 || dev->irq <= 0) {\r\nBUGMSG(D_NORMAL, "No autoprobe for RIM I; you "\r\n"must specify the shmem and irq!\n");\r\nreturn -ENODEV;\r\n}\r\nif (dev->dev_addr[0] == 0) {\r\nBUGMSG(D_NORMAL, "You need to specify your card's station "\r\n"ID!\n");\r\nreturn -ENODEV;\r\n}\r\nif (!request_mem_region(dev->mem_start, MIRROR_SIZE, "arcnet (90xx)")) {\r\nBUGMSG(D_NORMAL, "Card memory already allocated\n");\r\nreturn -ENODEV;\r\n}\r\nreturn arcrimi_found(dev);\r\n}\r\nstatic int check_mirror(unsigned long addr, size_t size)\r\n{\r\nvoid __iomem *p;\r\nint res = -1;\r\nif (!request_mem_region(addr, size, "arcnet (90xx)"))\r\nreturn -1;\r\np = ioremap(addr, size);\r\nif (p) {\r\nif (readb(p) == TESTvalue)\r\nres = 1;\r\nelse\r\nres = 0;\r\niounmap(p);\r\n}\r\nrelease_mem_region(addr, size);\r\nreturn res;\r\n}\r\nstatic int __init arcrimi_found(struct net_device *dev)\r\n{\r\nstruct arcnet_local *lp;\r\nunsigned long first_mirror, last_mirror, shmem;\r\nvoid __iomem *p;\r\nint mirror_size;\r\nint err;\r\np = ioremap(dev->mem_start, MIRROR_SIZE);\r\nif (!p) {\r\nrelease_mem_region(dev->mem_start, MIRROR_SIZE);\r\nBUGMSG(D_NORMAL, "Can't ioremap\n");\r\nreturn -ENODEV;\r\n}\r\nif (request_irq(dev->irq, arcnet_interrupt, 0, "arcnet (RIM I)", dev)) {\r\niounmap(p);\r\nrelease_mem_region(dev->mem_start, MIRROR_SIZE);\r\nBUGMSG(D_NORMAL, "Can't get IRQ %d!\n", dev->irq);\r\nreturn -ENODEV;\r\n}\r\nshmem = dev->mem_start;\r\nwriteb(TESTvalue, p);\r\nwriteb(dev->dev_addr[0], p + 1);\r\nmirror_size = MIRROR_SIZE;\r\nif (readb(p) == TESTvalue &&\r\ncheck_mirror(shmem - MIRROR_SIZE, MIRROR_SIZE) == 0 &&\r\ncheck_mirror(shmem - 2 * MIRROR_SIZE, MIRROR_SIZE) == 1)\r\nmirror_size = 2 * MIRROR_SIZE;\r\nfirst_mirror = shmem - mirror_size;\r\nwhile (check_mirror(first_mirror, mirror_size) == 1)\r\nfirst_mirror -= mirror_size;\r\nfirst_mirror += mirror_size;\r\nlast_mirror = shmem + mirror_size;\r\nwhile (check_mirror(last_mirror, mirror_size) == 1)\r\nlast_mirror += mirror_size;\r\nlast_mirror -= mirror_size;\r\ndev->mem_start = first_mirror;\r\ndev->mem_end = last_mirror + MIRROR_SIZE - 1;\r\nlp = netdev_priv(dev);\r\nlp->card_name = "RIM I";\r\nlp->hw.command = arcrimi_command;\r\nlp->hw.status = arcrimi_status;\r\nlp->hw.intmask = arcrimi_setmask;\r\nlp->hw.reset = arcrimi_reset;\r\nlp->hw.owner = THIS_MODULE;\r\nlp->hw.copy_to_card = arcrimi_copy_to_card;\r\nlp->hw.copy_from_card = arcrimi_copy_from_card;\r\niounmap(p);\r\nrelease_mem_region(shmem, MIRROR_SIZE);\r\nif (!request_mem_region(dev->mem_start,\r\ndev->mem_end - dev->mem_start + 1,\r\n"arcnet (90xx)")) {\r\nBUGMSG(D_NORMAL, "Card memory already allocated\n");\r\ngoto err_free_irq;\r\n}\r\nlp->mem_start = ioremap(dev->mem_start, dev->mem_end - dev->mem_start + 1);\r\nif (!lp->mem_start) {\r\nBUGMSG(D_NORMAL, "Can't remap device memory!\n");\r\ngoto err_release_mem;\r\n}\r\ndev->dev_addr[0] = readb(lp->mem_start + 1);\r\nBUGMSG(D_NORMAL, "ARCnet RIM I: station %02Xh found at IRQ %d, "\r\n"ShMem %lXh (%ld*%d bytes).\n",\r\ndev->dev_addr[0],\r\ndev->irq, dev->mem_start,\r\n(dev->mem_end - dev->mem_start + 1) / mirror_size, mirror_size);\r\nerr = register_netdev(dev);\r\nif (err)\r\ngoto err_unmap;\r\nreturn 0;\r\nerr_unmap:\r\niounmap(lp->mem_start);\r\nerr_release_mem:\r\nrelease_mem_region(dev->mem_start, dev->mem_end - dev->mem_start + 1);\r\nerr_free_irq:\r\nfree_irq(dev->irq, dev);\r\nreturn -EIO;\r\n}\r\nstatic int arcrimi_reset(struct net_device *dev, int really_reset)\r\n{\r\nstruct arcnet_local *lp = netdev_priv(dev);\r\nvoid __iomem *ioaddr = lp->mem_start + 0x800;\r\nBUGMSG(D_INIT, "Resetting %s (status=%02Xh)\n", dev->name, ASTATUS());\r\nif (really_reset) {\r\nwriteb(TESTvalue, ioaddr - 0x800);\r\nreturn 0;\r\n}\r\nACOMMAND(CFLAGScmd | RESETclear);\r\nACOMMAND(CFLAGScmd | CONFIGclear);\r\nACOMMAND(CONFIGcmd | EXTconf);\r\nreturn 0;\r\n}\r\nstatic void arcrimi_setmask(struct net_device *dev, int mask)\r\n{\r\nstruct arcnet_local *lp = netdev_priv(dev);\r\nvoid __iomem *ioaddr = lp->mem_start + 0x800;\r\nAINTMASK(mask);\r\n}\r\nstatic int arcrimi_status(struct net_device *dev)\r\n{\r\nstruct arcnet_local *lp = netdev_priv(dev);\r\nvoid __iomem *ioaddr = lp->mem_start + 0x800;\r\nreturn ASTATUS();\r\n}\r\nstatic void arcrimi_command(struct net_device *dev, int cmd)\r\n{\r\nstruct arcnet_local *lp = netdev_priv(dev);\r\nvoid __iomem *ioaddr = lp->mem_start + 0x800;\r\nACOMMAND(cmd);\r\n}\r\nstatic void arcrimi_copy_to_card(struct net_device *dev, int bufnum, int offset,\r\nvoid *buf, int count)\r\n{\r\nstruct arcnet_local *lp = netdev_priv(dev);\r\nvoid __iomem *memaddr = lp->mem_start + 0x800 + bufnum * 512 + offset;\r\nTIME("memcpy_toio", count, memcpy_toio(memaddr, buf, count));\r\n}\r\nstatic void arcrimi_copy_from_card(struct net_device *dev, int bufnum, int offset,\r\nvoid *buf, int count)\r\n{\r\nstruct arcnet_local *lp = netdev_priv(dev);\r\nvoid __iomem *memaddr = lp->mem_start + 0x800 + bufnum * 512 + offset;\r\nTIME("memcpy_fromio", count, memcpy_fromio(buf, memaddr, count));\r\n}\r\nstatic int __init arc_rimi_init(void)\r\n{\r\nstruct net_device *dev;\r\ndev = alloc_arcdev(device);\r\nif (!dev)\r\nreturn -ENOMEM;\r\nif (node && node != 0xff)\r\ndev->dev_addr[0] = node;\r\ndev->mem_start = io;\r\ndev->irq = irq;\r\nif (dev->irq == 2)\r\ndev->irq = 9;\r\nif (arcrimi_probe(dev)) {\r\nfree_netdev(dev);\r\nreturn -EIO;\r\n}\r\nmy_dev = dev;\r\nreturn 0;\r\n}\r\nstatic void __exit arc_rimi_exit(void)\r\n{\r\nstruct net_device *dev = my_dev;\r\nstruct arcnet_local *lp = netdev_priv(dev);\r\nunregister_netdev(dev);\r\niounmap(lp->mem_start);\r\nrelease_mem_region(dev->mem_start, dev->mem_end - dev->mem_start + 1);\r\nfree_irq(dev->irq, dev);\r\nfree_netdev(dev);\r\n}\r\nstatic int __init arcrimi_setup(char *s)\r\n{\r\nint ints[8];\r\ns = get_options(s, 8, ints);\r\nif (!ints[0])\r\nreturn 1;\r\nswitch (ints[0]) {\r\ndefault:\r\nprintk("arcrimi: Too many arguments.\n");\r\ncase 3:\r\nnode = ints[3];\r\ncase 2:\r\nirq = ints[2];\r\ncase 1:\r\nio = ints[1];\r\n}\r\nif (*s)\r\nsnprintf(device, sizeof(device), "%s", s);\r\nreturn 1;\r\n}

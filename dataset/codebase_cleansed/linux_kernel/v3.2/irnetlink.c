static struct net_device * ifname_to_netdev(struct net *net, struct genl_info *info)\r\n{\r\nchar * ifname;\r\nif (!info->attrs[IRDA_NL_ATTR_IFNAME])\r\nreturn NULL;\r\nifname = nla_data(info->attrs[IRDA_NL_ATTR_IFNAME]);\r\nIRDA_DEBUG(5, "%s(): Looking for %s\n", __func__, ifname);\r\nreturn dev_get_by_name(net, ifname);\r\n}\r\nstatic int irda_nl_set_mode(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net_device * dev;\r\nstruct irlap_cb * irlap;\r\nu32 mode;\r\nif (!info->attrs[IRDA_NL_ATTR_MODE])\r\nreturn -EINVAL;\r\nmode = nla_get_u32(info->attrs[IRDA_NL_ATTR_MODE]);\r\nIRDA_DEBUG(5, "%s(): Switching to mode: %d\n", __func__, mode);\r\ndev = ifname_to_netdev(&init_net, info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nirlap = (struct irlap_cb *)dev->atalk_ptr;\r\nif (!irlap) {\r\ndev_put(dev);\r\nreturn -ENODEV;\r\n}\r\nirlap->mode = mode;\r\ndev_put(dev);\r\nreturn 0;\r\n}\r\nstatic int irda_nl_get_mode(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net_device * dev;\r\nstruct irlap_cb * irlap;\r\nstruct sk_buff *msg;\r\nvoid *hdr;\r\nint ret = -ENOBUFS;\r\ndev = ifname_to_netdev(&init_net, info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nmsg = nlmsg_new(NLMSG_DEFAULT_SIZE, GFP_KERNEL);\r\nif (!msg) {\r\ndev_put(dev);\r\nreturn -ENOMEM;\r\n}\r\nirlap = (struct irlap_cb *)dev->atalk_ptr;\r\nif (!irlap) {\r\nret = -ENODEV;\r\ngoto err_out;\r\n}\r\nhdr = genlmsg_put(msg, info->snd_pid, info->snd_seq,\r\n&irda_nl_family, 0, IRDA_NL_CMD_GET_MODE);\r\nif (hdr == NULL) {\r\nret = -EMSGSIZE;\r\ngoto err_out;\r\n}\r\nif(nla_put_string(msg, IRDA_NL_ATTR_IFNAME,\r\ndev->name))\r\ngoto err_out;\r\nif(nla_put_u32(msg, IRDA_NL_ATTR_MODE, irlap->mode))\r\ngoto err_out;\r\ngenlmsg_end(msg, hdr);\r\nreturn genlmsg_reply(msg, info);\r\nerr_out:\r\nnlmsg_free(msg);\r\ndev_put(dev);\r\nreturn ret;\r\n}\r\nint irda_nl_register(void)\r\n{\r\nreturn genl_register_family_with_ops(&irda_nl_family,\r\nirda_nl_ops, ARRAY_SIZE(irda_nl_ops));\r\n}\r\nvoid irda_nl_unregister(void)\r\n{\r\ngenl_unregister_family(&irda_nl_family);\r\n}

static void cvm_oct_get_drvinfo(struct net_device *dev,\r\nstruct ethtool_drvinfo *info)\r\n{\r\nstrcpy(info->driver, "cavium-ethernet");\r\nstrcpy(info->version, OCTEON_ETHERNET_VERSION);\r\nstrcpy(info->bus_info, "Builtin");\r\n}\r\nstatic int cvm_oct_get_settings(struct net_device *dev, struct ethtool_cmd *cmd)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nif (priv->phydev)\r\nreturn phy_ethtool_gset(priv->phydev, cmd);\r\nreturn -EINVAL;\r\n}\r\nstatic int cvm_oct_set_settings(struct net_device *dev, struct ethtool_cmd *cmd)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nif (priv->phydev)\r\nreturn phy_ethtool_sset(priv->phydev, cmd);\r\nreturn -EINVAL;\r\n}\r\nstatic int cvm_oct_nway_reset(struct net_device *dev)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nif (priv->phydev)\r\nreturn phy_start_aneg(priv->phydev);\r\nreturn -EINVAL;\r\n}\r\nint cvm_oct_ioctl(struct net_device *dev, struct ifreq *rq, int cmd)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nif (!netif_running(dev))\r\nreturn -EINVAL;\r\nif (!priv->phydev)\r\nreturn -EINVAL;\r\nreturn phy_mii_ioctl(priv->phydev, rq, cmd);\r\n}\r\nstatic void cvm_oct_adjust_link(struct net_device *dev)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\ncvmx_helper_link_info_t link_info;\r\nif (priv->last_link != priv->phydev->link) {\r\npriv->last_link = priv->phydev->link;\r\nlink_info.u64 = 0;\r\nlink_info.s.link_up = priv->last_link ? 1 : 0;\r\nlink_info.s.full_duplex = priv->phydev->duplex ? 1 : 0;\r\nlink_info.s.speed = priv->phydev->speed;\r\ncvmx_helper_link_set( priv->port, link_info);\r\nif (priv->last_link) {\r\nnetif_carrier_on(dev);\r\nif (priv->queue != -1)\r\nprintk_ratelimited("%s: %u Mbps %s duplex, "\r\n"port %2d, queue %2d\n",\r\ndev->name, priv->phydev->speed,\r\npriv->phydev->duplex ?\r\n"Full" : "Half",\r\npriv->port, priv->queue);\r\nelse\r\nprintk_ratelimited("%s: %u Mbps %s duplex, "\r\n"port %2d, POW\n",\r\ndev->name, priv->phydev->speed,\r\npriv->phydev->duplex ?\r\n"Full" : "Half",\r\npriv->port);\r\n} else {\r\nnetif_carrier_off(dev);\r\nprintk_ratelimited("%s: Link down\n", dev->name);\r\n}\r\n}\r\n}\r\nint cvm_oct_phy_setup_device(struct net_device *dev)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nint phy_addr = cvmx_helper_board_get_mii_address(priv->port);\r\nif (phy_addr != -1) {\r\nchar phy_id[20];\r\nsnprintf(phy_id, sizeof(phy_id), PHY_ID_FMT, "0", phy_addr);\r\npriv->phydev = phy_connect(dev, phy_id, cvm_oct_adjust_link, 0,\r\nPHY_INTERFACE_MODE_GMII);\r\nif (IS_ERR(priv->phydev)) {\r\npriv->phydev = NULL;\r\nreturn -1;\r\n}\r\npriv->last_link = 0;\r\nphy_start_aneg(priv->phydev);\r\n}\r\nreturn 0;\r\n}

struct arm_vmregion *\r\narm_vmregion_alloc(struct arm_vmregion_head *head, size_t align,\r\nsize_t size, gfp_t gfp)\r\n{\r\nunsigned long start = head->vm_start, addr = head->vm_end;\r\nunsigned long flags;\r\nstruct arm_vmregion *c, *new;\r\nif (head->vm_end - head->vm_start < size) {\r\nprintk(KERN_WARNING "%s: allocation too big (requested %#x)\n",\r\n__func__, size);\r\ngoto out;\r\n}\r\nnew = kmalloc(sizeof(struct arm_vmregion), gfp);\r\nif (!new)\r\ngoto out;\r\nspin_lock_irqsave(&head->vm_lock, flags);\r\naddr = rounddown(addr - size, align);\r\nlist_for_each_entry_reverse(c, &head->vm_list, vm_list) {\r\nif (addr >= c->vm_end)\r\ngoto found;\r\naddr = rounddown(c->vm_start - size, align);\r\nif (addr < start)\r\ngoto nospc;\r\n}\r\nfound:\r\nlist_add(&new->vm_list, &c->vm_list);\r\nnew->vm_start = addr;\r\nnew->vm_end = addr + size;\r\nnew->vm_active = 1;\r\nspin_unlock_irqrestore(&head->vm_lock, flags);\r\nreturn new;\r\nnospc:\r\nspin_unlock_irqrestore(&head->vm_lock, flags);\r\nkfree(new);\r\nout:\r\nreturn NULL;\r\n}\r\nstatic struct arm_vmregion *__arm_vmregion_find(struct arm_vmregion_head *head, unsigned long addr)\r\n{\r\nstruct arm_vmregion *c;\r\nlist_for_each_entry(c, &head->vm_list, vm_list) {\r\nif (c->vm_active && c->vm_start == addr)\r\ngoto out;\r\n}\r\nc = NULL;\r\nout:\r\nreturn c;\r\n}\r\nstruct arm_vmregion *arm_vmregion_find(struct arm_vmregion_head *head, unsigned long addr)\r\n{\r\nstruct arm_vmregion *c;\r\nunsigned long flags;\r\nspin_lock_irqsave(&head->vm_lock, flags);\r\nc = __arm_vmregion_find(head, addr);\r\nspin_unlock_irqrestore(&head->vm_lock, flags);\r\nreturn c;\r\n}\r\nstruct arm_vmregion *arm_vmregion_find_remove(struct arm_vmregion_head *head, unsigned long addr)\r\n{\r\nstruct arm_vmregion *c;\r\nunsigned long flags;\r\nspin_lock_irqsave(&head->vm_lock, flags);\r\nc = __arm_vmregion_find(head, addr);\r\nif (c)\r\nc->vm_active = 0;\r\nspin_unlock_irqrestore(&head->vm_lock, flags);\r\nreturn c;\r\n}\r\nvoid arm_vmregion_free(struct arm_vmregion_head *head, struct arm_vmregion *c)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&head->vm_lock, flags);\r\nlist_del(&c->vm_list);\r\nspin_unlock_irqrestore(&head->vm_lock, flags);\r\nkfree(c);\r\n}

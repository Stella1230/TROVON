int kvmppc_core_emulate_op(struct kvm_run *run, struct kvm_vcpu *vcpu,\r\nunsigned int inst, int *advance)\r\n{\r\nint emulated = EMULATE_DONE;\r\nint dcrn;\r\nint ra;\r\nint rb;\r\nint rc;\r\nint rs;\r\nint rt;\r\nint ws;\r\nswitch (get_op(inst)) {\r\ncase 31:\r\nswitch (get_xop(inst)) {\r\ncase XOP_MFDCR:\r\ndcrn = get_dcrn(inst);\r\nrt = get_rt(inst);\r\nswitch (dcrn) {\r\ncase DCRN_CPR0_CONFIG_ADDR:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.cpr0_cfgaddr);\r\nbreak;\r\ncase DCRN_CPR0_CONFIG_DATA:\r\nlocal_irq_disable();\r\nmtdcr(DCRN_CPR0_CONFIG_ADDR,\r\nvcpu->arch.cpr0_cfgaddr);\r\nkvmppc_set_gpr(vcpu, rt,\r\nmfdcr(DCRN_CPR0_CONFIG_DATA));\r\nlocal_irq_enable();\r\nbreak;\r\ndefault:\r\nrun->dcr.dcrn = dcrn;\r\nrun->dcr.data = 0;\r\nrun->dcr.is_write = 0;\r\nvcpu->arch.io_gpr = rt;\r\nvcpu->arch.dcr_needed = 1;\r\nkvmppc_account_exit(vcpu, DCR_EXITS);\r\nemulated = EMULATE_DO_DCR;\r\n}\r\nbreak;\r\ncase XOP_MTDCR:\r\ndcrn = get_dcrn(inst);\r\nrs = get_rs(inst);\r\nswitch (dcrn) {\r\ncase DCRN_CPR0_CONFIG_ADDR:\r\nvcpu->arch.cpr0_cfgaddr = kvmppc_get_gpr(vcpu, rs);\r\nbreak;\r\ndefault:\r\nrun->dcr.dcrn = dcrn;\r\nrun->dcr.data = kvmppc_get_gpr(vcpu, rs);\r\nrun->dcr.is_write = 1;\r\nvcpu->arch.dcr_needed = 1;\r\nkvmppc_account_exit(vcpu, DCR_EXITS);\r\nemulated = EMULATE_DO_DCR;\r\n}\r\nbreak;\r\ncase XOP_TLBWE:\r\nra = get_ra(inst);\r\nrs = get_rs(inst);\r\nws = get_ws(inst);\r\nemulated = kvmppc_44x_emul_tlbwe(vcpu, ra, rs, ws);\r\nbreak;\r\ncase XOP_TLBSX:\r\nrt = get_rt(inst);\r\nra = get_ra(inst);\r\nrb = get_rb(inst);\r\nrc = get_rc(inst);\r\nemulated = kvmppc_44x_emul_tlbsx(vcpu, rt, ra, rb, rc);\r\nbreak;\r\ncase XOP_ICCCI:\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\n}\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\n}\r\nif (emulated == EMULATE_FAIL)\r\nemulated = kvmppc_booke_emulate_op(run, vcpu, inst, advance);\r\nreturn emulated;\r\n}\r\nint kvmppc_core_emulate_mtspr(struct kvm_vcpu *vcpu, int sprn, int rs)\r\n{\r\nint emulated = EMULATE_DONE;\r\nswitch (sprn) {\r\ncase SPRN_PID:\r\nkvmppc_set_pid(vcpu, kvmppc_get_gpr(vcpu, rs)); break;\r\ncase SPRN_MMUCR:\r\nvcpu->arch.mmucr = kvmppc_get_gpr(vcpu, rs); break;\r\ncase SPRN_CCR0:\r\nvcpu->arch.ccr0 = kvmppc_get_gpr(vcpu, rs); break;\r\ncase SPRN_CCR1:\r\nvcpu->arch.ccr1 = kvmppc_get_gpr(vcpu, rs); break;\r\ndefault:\r\nemulated = kvmppc_booke_emulate_mtspr(vcpu, sprn, rs);\r\n}\r\nreturn emulated;\r\n}\r\nint kvmppc_core_emulate_mfspr(struct kvm_vcpu *vcpu, int sprn, int rt)\r\n{\r\nint emulated = EMULATE_DONE;\r\nswitch (sprn) {\r\ncase SPRN_PID:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.pid); break;\r\ncase SPRN_MMUCR:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.mmucr); break;\r\ncase SPRN_CCR0:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ccr0); break;\r\ncase SPRN_CCR1:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ccr1); break;\r\ndefault:\r\nemulated = kvmppc_booke_emulate_mfspr(vcpu, sprn, rt);\r\n}\r\nreturn emulated;\r\n}

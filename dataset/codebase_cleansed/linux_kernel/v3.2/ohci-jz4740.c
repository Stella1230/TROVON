static inline struct jz4740_ohci_hcd *hcd_to_jz4740_hcd(struct usb_hcd *hcd)\r\n{\r\nreturn (struct jz4740_ohci_hcd *)(hcd->hcd_priv);\r\n}\r\nstatic inline struct usb_hcd *jz4740_hcd_to_hcd(struct jz4740_ohci_hcd *jz4740_ohci)\r\n{\r\nreturn container_of((void *)jz4740_ohci, struct usb_hcd, hcd_priv);\r\n}\r\nstatic int ohci_jz4740_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint ret;\r\nret = ohci_init(ohci);\r\nif (ret < 0)\r\nreturn ret;\r\nohci->num_ports = 1;\r\nret = ohci_run(ohci);\r\nif (ret < 0) {\r\ndev_err(hcd->self.controller, "Can not start %s",\r\nhcd->self.bus_name);\r\nohci_stop(hcd);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ohci_jz4740_set_vbus_power(struct jz4740_ohci_hcd *jz4740_ohci,\r\nbool enabled)\r\n{\r\nint ret = 0;\r\nif (!jz4740_ohci->vbus)\r\nreturn 0;\r\nif (enabled && !jz4740_ohci->vbus_enabled) {\r\nret = regulator_enable(jz4740_ohci->vbus);\r\nif (ret)\r\ndev_err(jz4740_hcd_to_hcd(jz4740_ohci)->self.controller,\r\n"Could not power vbus\n");\r\n} else if (!enabled && jz4740_ohci->vbus_enabled) {\r\nret = regulator_disable(jz4740_ohci->vbus);\r\n}\r\nif (ret == 0)\r\njz4740_ohci->vbus_enabled = enabled;\r\nreturn ret;\r\n}\r\nstatic int ohci_jz4740_hub_control(struct usb_hcd *hcd, u16 typeReq, u16 wValue,\r\nu16 wIndex, char *buf, u16 wLength)\r\n{\r\nstruct jz4740_ohci_hcd *jz4740_ohci = hcd_to_jz4740_hcd(hcd);\r\nint ret;\r\nswitch (typeReq) {\r\ncase SetHubFeature:\r\nif (wValue == USB_PORT_FEAT_POWER)\r\nret = ohci_jz4740_set_vbus_power(jz4740_ohci, true);\r\nbreak;\r\ncase ClearHubFeature:\r\nif (wValue == USB_PORT_FEAT_POWER)\r\nret = ohci_jz4740_set_vbus_power(jz4740_ohci, false);\r\nbreak;\r\n}\r\nif (ret)\r\nreturn ret;\r\nreturn ohci_hub_control(hcd, typeReq, wValue, wIndex, buf, wLength);\r\n}\r\nstatic __devinit int jz4740_ohci_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct usb_hcd *hcd;\r\nstruct jz4740_ohci_hcd *jz4740_ohci;\r\nstruct resource *res;\r\nint irq;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "Failed to get platform resource\n");\r\nreturn -ENOENT;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "Failed to get platform irq\n");\r\nreturn irq;\r\n}\r\nhcd = usb_create_hcd(&ohci_jz4740_hc_driver, &pdev->dev, "jz4740");\r\nif (!hcd) {\r\ndev_err(&pdev->dev, "Failed to create hcd.\n");\r\nreturn -ENOMEM;\r\n}\r\njz4740_ohci = hcd_to_jz4740_hcd(hcd);\r\nres = request_mem_region(res->start, resource_size(res), hcd_name);\r\nif (!res) {\r\ndev_err(&pdev->dev, "Failed to request mem region.\n");\r\nret = -EBUSY;\r\ngoto err_free;\r\n}\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nhcd->regs = ioremap(res->start, resource_size(res));\r\nif (!hcd->regs) {\r\ndev_err(&pdev->dev, "Failed to ioremap registers.\n");\r\nret = -EBUSY;\r\ngoto err_release_mem;\r\n}\r\njz4740_ohci->clk = clk_get(&pdev->dev, "uhc");\r\nif (IS_ERR(jz4740_ohci->clk)) {\r\nret = PTR_ERR(jz4740_ohci->clk);\r\ndev_err(&pdev->dev, "Failed to get clock: %d\n", ret);\r\ngoto err_iounmap;\r\n}\r\njz4740_ohci->vbus = regulator_get(&pdev->dev, "vbus");\r\nif (IS_ERR(jz4740_ohci->vbus))\r\njz4740_ohci->vbus = NULL;\r\nclk_set_rate(jz4740_ohci->clk, 48000000);\r\nclk_enable(jz4740_ohci->clk);\r\nif (jz4740_ohci->vbus)\r\nohci_jz4740_set_vbus_power(jz4740_ohci, true);\r\nplatform_set_drvdata(pdev, hcd);\r\nohci_hcd_init(hcd_to_ohci(hcd));\r\nret = usb_add_hcd(hcd, irq, 0);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to add hcd: %d\n", ret);\r\ngoto err_disable;\r\n}\r\nreturn 0;\r\nerr_disable:\r\nplatform_set_drvdata(pdev, NULL);\r\nif (jz4740_ohci->vbus) {\r\nregulator_disable(jz4740_ohci->vbus);\r\nregulator_put(jz4740_ohci->vbus);\r\n}\r\nclk_disable(jz4740_ohci->clk);\r\nclk_put(jz4740_ohci->clk);\r\nerr_iounmap:\r\niounmap(hcd->regs);\r\nerr_release_mem:\r\nrelease_mem_region(res->start, resource_size(res));\r\nerr_free:\r\nusb_put_hcd(hcd);\r\nreturn ret;\r\n}\r\nstatic __devexit int jz4740_ohci_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nstruct jz4740_ohci_hcd *jz4740_ohci = hcd_to_jz4740_hcd(hcd);\r\nusb_remove_hcd(hcd);\r\nplatform_set_drvdata(pdev, NULL);\r\nif (jz4740_ohci->vbus) {\r\nregulator_disable(jz4740_ohci->vbus);\r\nregulator_put(jz4740_ohci->vbus);\r\n}\r\nclk_disable(jz4740_ohci->clk);\r\nclk_put(jz4740_ohci->clk);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}

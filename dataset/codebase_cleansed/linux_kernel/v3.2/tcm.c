void *tcm_alloc(size_t len)\r\n{\r\nunsigned long vaddr;\r\nif (!tcm_pool)\r\nreturn NULL;\r\nvaddr = gen_pool_alloc(tcm_pool, len);\r\nif (!vaddr)\r\nreturn NULL;\r\nreturn (void *) vaddr;\r\n}\r\nvoid tcm_free(void *addr, size_t len)\r\n{\r\ngen_pool_free(tcm_pool, (unsigned long) addr, len);\r\n}\r\nbool tcm_dtcm_present(void)\r\n{\r\nreturn dtcm_present;\r\n}\r\nbool tcm_itcm_present(void)\r\n{\r\nreturn itcm_present;\r\n}\r\nstatic int __init setup_tcm_bank(u8 type, u8 bank, u8 banks,\r\nu32 *offset)\r\n{\r\nconst int tcm_sizes[16] = { 0, -1, -1, 4, 8, 16, 32, 64, 128,\r\n256, 512, 1024, -1, -1, -1, -1 };\r\nu32 tcm_region;\r\nint tcm_size;\r\nif (banks > 1)\r\nasm("mcr p15, 0, %0, c9, c2, 0"\r\n:\r\n: "r" (bank));\r\nif (!type)\r\nasm("mrc p15, 0, %0, c9, c1, 0"\r\n: "=r" (tcm_region));\r\nelse\r\nasm("mrc p15, 0, %0, c9, c1, 1"\r\n: "=r" (tcm_region));\r\ntcm_size = tcm_sizes[(tcm_region >> 2) & 0x0f];\r\nif (tcm_size < 0) {\r\npr_err("CPU: %sTCM%d of unknown size\n",\r\ntype ? "I" : "D", bank);\r\nreturn -EINVAL;\r\n} else if (tcm_size > 32) {\r\npr_err("CPU: %sTCM%d larger than 32k found\n",\r\ntype ? "I" : "D", bank);\r\nreturn -EINVAL;\r\n} else {\r\npr_info("CPU: found %sTCM%d %dk @ %08x, %senabled\n",\r\ntype ? "I" : "D",\r\nbank,\r\ntcm_size,\r\n(tcm_region & 0xfffff000U),\r\n(tcm_region & 1) ? "" : "not ");\r\n}\r\nif (tcm_size == 0)\r\nreturn 0;\r\ntcm_region = *offset | (tcm_region & 0x00000ffeU) | 1;\r\nif (!type)\r\nasm("mcr p15, 0, %0, c9, c1, 0"\r\n:\r\n: "r" (tcm_region));\r\nelse\r\nasm("mcr p15, 0, %0, c9, c1, 1"\r\n:\r\n: "r" (tcm_region));\r\n*offset += (tcm_size << 10);\r\npr_info("CPU: moved %sTCM%d %dk to %08x, enabled\n",\r\ntype ? "I" : "D",\r\nbank,\r\ntcm_size,\r\n(tcm_region & 0xfffff000U));\r\nreturn 0;\r\n}\r\nvoid __init tcm_init(void)\r\n{\r\nu32 tcm_status = read_cpuid_tcmstatus();\r\nu8 dtcm_banks = (tcm_status >> 16) & 0x03;\r\nu8 itcm_banks = (tcm_status & 0x03);\r\nsize_t dtcm_code_sz = &__edtcm_data - &__sdtcm_data;\r\nsize_t itcm_code_sz = &__eitcm_text - &__sitcm_text;\r\nchar *start;\r\nchar *end;\r\nchar *ram;\r\nint ret;\r\nint i;\r\nif (dtcm_banks > 2)\r\ndtcm_banks = 0;\r\nif (itcm_banks > 2)\r\nitcm_banks = 0;\r\nif (dtcm_banks > 0) {\r\nfor (i = 0; i < dtcm_banks; i++) {\r\nret = setup_tcm_bank(0, i, dtcm_banks, &dtcm_end);\r\nif (ret)\r\nreturn;\r\n}\r\nif (dtcm_code_sz > (dtcm_end - DTCM_OFFSET)) {\r\npr_info("CPU DTCM: %u bytes of code compiled to "\r\n"DTCM but only %lu bytes of DTCM present\n",\r\ndtcm_code_sz, (dtcm_end - DTCM_OFFSET));\r\ngoto no_dtcm;\r\n}\r\ndtcm_res.end = dtcm_end - 1;\r\nrequest_resource(&iomem_resource, &dtcm_res);\r\ndtcm_iomap[0].length = dtcm_end - DTCM_OFFSET;\r\niotable_init(dtcm_iomap, 1);\r\nstart = &__sdtcm_data;\r\nend = &__edtcm_data;\r\nram = &__dtcm_start;\r\nmemcpy(start, ram, dtcm_code_sz);\r\npr_debug("CPU DTCM: copied data from %p - %p\n",\r\nstart, end);\r\ndtcm_present = true;\r\n} else if (dtcm_code_sz) {\r\npr_info("CPU DTCM: %u bytes of code compiled to DTCM but no "\r\n"DTCM banks present in CPU\n", dtcm_code_sz);\r\n}\r\nno_dtcm:\r\nif (itcm_banks > 0) {\r\nfor (i = 0; i < itcm_banks; i++) {\r\nret = setup_tcm_bank(1, i, itcm_banks, &itcm_end);\r\nif (ret)\r\nreturn;\r\n}\r\nif (itcm_code_sz > (itcm_end - ITCM_OFFSET)) {\r\npr_info("CPU ITCM: %u bytes of code compiled to "\r\n"ITCM but only %lu bytes of ITCM present\n",\r\nitcm_code_sz, (itcm_end - ITCM_OFFSET));\r\nreturn;\r\n}\r\nitcm_res.end = itcm_end - 1;\r\nrequest_resource(&iomem_resource, &itcm_res);\r\nitcm_iomap[0].length = itcm_end - ITCM_OFFSET;\r\niotable_init(itcm_iomap, 1);\r\nstart = &__sitcm_text;\r\nend = &__eitcm_text;\r\nram = &__itcm_start;\r\nmemcpy(start, ram, itcm_code_sz);\r\npr_debug("CPU ITCM: copied code from %p - %p\n",\r\nstart, end);\r\nitcm_present = true;\r\n} else if (itcm_code_sz) {\r\npr_info("CPU ITCM: %u bytes of code compiled to ITCM but no "\r\n"ITCM banks present in CPU\n", itcm_code_sz);\r\n}\r\n}\r\nstatic int __init setup_tcm_pool(void)\r\n{\r\nu32 dtcm_pool_start = (u32) &__edtcm_data;\r\nu32 itcm_pool_start = (u32) &__eitcm_text;\r\nint ret;\r\ntcm_pool = gen_pool_create(2, -1);\r\npr_debug("Setting up TCM memory pool\n");\r\nif (dtcm_present) {\r\nif (dtcm_pool_start < dtcm_end) {\r\nret = gen_pool_add(tcm_pool, dtcm_pool_start,\r\ndtcm_end - dtcm_pool_start, -1);\r\nif (ret) {\r\npr_err("CPU DTCM: could not add DTCM " \\r\n"remainder to pool!\n");\r\nreturn ret;\r\n}\r\npr_debug("CPU DTCM: Added %08x bytes @ %08x to " \\r\n"the TCM memory pool\n",\r\ndtcm_end - dtcm_pool_start,\r\ndtcm_pool_start);\r\n}\r\n}\r\nif (itcm_present) {\r\nif (itcm_pool_start < itcm_end) {\r\nret = gen_pool_add(tcm_pool, itcm_pool_start,\r\nitcm_end - itcm_pool_start, -1);\r\nif (ret) {\r\npr_err("CPU ITCM: could not add ITCM " \\r\n"remainder to pool!\n");\r\nreturn ret;\r\n}\r\npr_debug("CPU ITCM: Added %08x bytes @ %08x to " \\r\n"the TCM memory pool\n",\r\nitcm_end - itcm_pool_start,\r\nitcm_pool_start);\r\n}\r\n}\r\nreturn 0;\r\n}

static void tcp_diag_get_info(struct sock *sk, struct inet_diag_msg *r,\r\nvoid *_info)\r\n{\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nstruct tcp_info *info = _info;\r\nif (sk->sk_state == TCP_LISTEN) {\r\nr->idiag_rqueue = sk->sk_ack_backlog;\r\nr->idiag_wqueue = sk->sk_max_ack_backlog;\r\n} else {\r\nr->idiag_rqueue = max_t(int, tp->rcv_nxt - tp->copied_seq, 0);\r\nr->idiag_wqueue = tp->write_seq - tp->snd_una;\r\n}\r\nif (info != NULL)\r\ntcp_get_info(sk, info);\r\n}\r\nstatic int __init tcp_diag_init(void)\r\n{\r\nreturn inet_diag_register(&tcp_diag_handler);\r\n}\r\nstatic void __exit tcp_diag_exit(void)\r\n{\r\ninet_diag_unregister(&tcp_diag_handler);\r\n}

static irqreturn_t xtkbd_interrupt(struct serio *serio,\r\nunsigned char data, unsigned int flags)\r\n{\r\nstruct xtkbd *xtkbd = serio_get_drvdata(serio);\r\nswitch (data) {\r\ncase XTKBD_EMUL0:\r\ncase XTKBD_EMUL1:\r\nbreak;\r\ndefault:\r\nif (xtkbd->keycode[data & XTKBD_KEY]) {\r\ninput_report_key(xtkbd->dev, xtkbd->keycode[data & XTKBD_KEY], !(data & XTKBD_RELEASE));\r\ninput_sync(xtkbd->dev);\r\n} else {\r\nprintk(KERN_WARNING "xtkbd.c: Unknown key (scancode %#x) %s.\n",\r\ndata & XTKBD_KEY, data & XTKBD_RELEASE ? "released" : "pressed");\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int xtkbd_connect(struct serio *serio, struct serio_driver *drv)\r\n{\r\nstruct xtkbd *xtkbd;\r\nstruct input_dev *input_dev;\r\nint err = -ENOMEM;\r\nint i;\r\nxtkbd = kmalloc(sizeof(struct xtkbd), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!xtkbd || !input_dev)\r\ngoto fail1;\r\nxtkbd->serio = serio;\r\nxtkbd->dev = input_dev;\r\nsnprintf(xtkbd->phys, sizeof(xtkbd->phys), "%s/input0", serio->phys);\r\nmemcpy(xtkbd->keycode, xtkbd_keycode, sizeof(xtkbd->keycode));\r\ninput_dev->name = "XT Keyboard";\r\ninput_dev->phys = xtkbd->phys;\r\ninput_dev->id.bustype = BUS_XTKBD;\r\ninput_dev->id.vendor = 0x0001;\r\ninput_dev->id.product = 0x0001;\r\ninput_dev->id.version = 0x0100;\r\ninput_dev->dev.parent = &serio->dev;\r\ninput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REP);\r\ninput_dev->keycode = xtkbd->keycode;\r\ninput_dev->keycodesize = sizeof(unsigned char);\r\ninput_dev->keycodemax = ARRAY_SIZE(xtkbd_keycode);\r\nfor (i = 0; i < 255; i++)\r\nset_bit(xtkbd->keycode[i], input_dev->keybit);\r\nclear_bit(0, input_dev->keybit);\r\nserio_set_drvdata(serio, xtkbd);\r\nerr = serio_open(serio, drv);\r\nif (err)\r\ngoto fail2;\r\nerr = input_register_device(xtkbd->dev);\r\nif (err)\r\ngoto fail3;\r\nreturn 0;\r\nfail3: serio_close(serio);\r\nfail2: serio_set_drvdata(serio, NULL);\r\nfail1: input_free_device(input_dev);\r\nkfree(xtkbd);\r\nreturn err;\r\n}\r\nstatic void xtkbd_disconnect(struct serio *serio)\r\n{\r\nstruct xtkbd *xtkbd = serio_get_drvdata(serio);\r\nserio_close(serio);\r\nserio_set_drvdata(serio, NULL);\r\ninput_unregister_device(xtkbd->dev);\r\nkfree(xtkbd);\r\n}\r\nstatic int __init xtkbd_init(void)\r\n{\r\nreturn serio_register_driver(&xtkbd_drv);\r\n}\r\nstatic void __exit xtkbd_exit(void)\r\n{\r\nserio_unregister_driver(&xtkbd_drv);\r\n}

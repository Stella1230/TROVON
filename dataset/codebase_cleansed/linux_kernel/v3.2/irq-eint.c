static inline void s3c_irq_eint_mask(struct irq_data *data)\r\n{\r\nu32 mask;\r\nmask = __raw_readl(S3C64XX_EINT0MASK);\r\nmask |= (u32)data->chip_data;\r\n__raw_writel(mask, S3C64XX_EINT0MASK);\r\n}\r\nstatic void s3c_irq_eint_unmask(struct irq_data *data)\r\n{\r\nu32 mask;\r\nmask = __raw_readl(S3C64XX_EINT0MASK);\r\nmask &= ~((u32)data->chip_data);\r\n__raw_writel(mask, S3C64XX_EINT0MASK);\r\n}\r\nstatic inline void s3c_irq_eint_ack(struct irq_data *data)\r\n{\r\n__raw_writel((u32)data->chip_data, S3C64XX_EINT0PEND);\r\n}\r\nstatic void s3c_irq_eint_maskack(struct irq_data *data)\r\n{\r\ns3c_irq_eint_mask(data);\r\ns3c_irq_eint_ack(data);\r\n}\r\nstatic int s3c_irq_eint_set_type(struct irq_data *data, unsigned int type)\r\n{\r\nint offs = eint_offset(data->irq);\r\nint pin, pin_val;\r\nint shift;\r\nu32 ctrl, mask;\r\nu32 newvalue = 0;\r\nvoid __iomem *reg;\r\nif (offs > 27)\r\nreturn -EINVAL;\r\nif (offs <= 15)\r\nreg = S3C64XX_EINT0CON0;\r\nelse\r\nreg = S3C64XX_EINT0CON1;\r\nswitch (type) {\r\ncase IRQ_TYPE_NONE:\r\nprintk(KERN_WARNING "No edge setting!\n");\r\nbreak;\r\ncase IRQ_TYPE_EDGE_RISING:\r\nnewvalue = S3C2410_EXTINT_RISEEDGE;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_FALLING:\r\nnewvalue = S3C2410_EXTINT_FALLEDGE;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_BOTH:\r\nnewvalue = S3C2410_EXTINT_BOTHEDGE;\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_LOW:\r\nnewvalue = S3C2410_EXTINT_LOWLEV;\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_HIGH:\r\nnewvalue = S3C2410_EXTINT_HILEV;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "No such irq type %d", type);\r\nreturn -1;\r\n}\r\nif (offs <= 15)\r\nshift = (offs / 2) * 4;\r\nelse\r\nshift = ((offs - 16) / 2) * 4;\r\nmask = 0x7 << shift;\r\nctrl = __raw_readl(reg);\r\nctrl &= ~mask;\r\nctrl |= newvalue << shift;\r\n__raw_writel(ctrl, reg);\r\nif (offs < 16) {\r\npin = S3C64XX_GPN(offs);\r\npin_val = S3C_GPIO_SFN(2);\r\n} else if (offs < 23) {\r\npin = S3C64XX_GPL(offs + 8 - 16);\r\npin_val = S3C_GPIO_SFN(3);\r\n} else {\r\npin = S3C64XX_GPM(offs - 23);\r\npin_val = S3C_GPIO_SFN(3);\r\n}\r\ns3c_gpio_cfgpin(pin, pin_val);\r\nreturn 0;\r\n}\r\nstatic inline void s3c_irq_demux_eint(unsigned int start, unsigned int end)\r\n{\r\nu32 status = __raw_readl(S3C64XX_EINT0PEND);\r\nu32 mask = __raw_readl(S3C64XX_EINT0MASK);\r\nunsigned int irq;\r\nstatus &= ~mask;\r\nstatus >>= start;\r\nstatus &= (1 << (end - start + 1)) - 1;\r\nfor (irq = IRQ_EINT(start); irq <= IRQ_EINT(end); irq++) {\r\nif (status & 1)\r\ngeneric_handle_irq(irq);\r\nstatus >>= 1;\r\n}\r\n}\r\nstatic void s3c_irq_demux_eint0_3(unsigned int irq, struct irq_desc *desc)\r\n{\r\ns3c_irq_demux_eint(0, 3);\r\n}\r\nstatic void s3c_irq_demux_eint4_11(unsigned int irq, struct irq_desc *desc)\r\n{\r\ns3c_irq_demux_eint(4, 11);\r\n}\r\nstatic void s3c_irq_demux_eint12_19(unsigned int irq, struct irq_desc *desc)\r\n{\r\ns3c_irq_demux_eint(12, 19);\r\n}\r\nstatic void s3c_irq_demux_eint20_27(unsigned int irq, struct irq_desc *desc)\r\n{\r\ns3c_irq_demux_eint(20, 27);\r\n}\r\nstatic int __init s3c64xx_init_irq_eint(void)\r\n{\r\nint irq;\r\nfor (irq = IRQ_EINT(0); irq <= IRQ_EINT(27); irq++) {\r\nirq_set_chip_and_handler(irq, &s3c_irq_eint, handle_level_irq);\r\nirq_set_chip_data(irq, (void *)eint_irq_to_bit(irq));\r\nset_irq_flags(irq, IRQF_VALID);\r\n}\r\nirq_set_chained_handler(IRQ_EINT0_3, s3c_irq_demux_eint0_3);\r\nirq_set_chained_handler(IRQ_EINT4_11, s3c_irq_demux_eint4_11);\r\nirq_set_chained_handler(IRQ_EINT12_19, s3c_irq_demux_eint12_19);\r\nirq_set_chained_handler(IRQ_EINT20_27, s3c_irq_demux_eint20_27);\r\nreturn 0;\r\n}

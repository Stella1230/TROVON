int suspend_nvs_register(unsigned long start, unsigned long size)\r\n{\r\nstruct nvs_page *entry, *next;\r\npr_info("PM: Registering ACPI NVS region at %lx (%ld bytes)\n",\r\nstart, size);\r\nwhile (size > 0) {\r\nunsigned int nr_bytes;\r\nentry = kzalloc(sizeof(struct nvs_page), GFP_KERNEL);\r\nif (!entry)\r\ngoto Error;\r\nlist_add_tail(&entry->node, &nvs_list);\r\nentry->phys_start = start;\r\nnr_bytes = PAGE_SIZE - (start & ~PAGE_MASK);\r\nentry->size = (size < nr_bytes) ? size : nr_bytes;\r\nstart += entry->size;\r\nsize -= entry->size;\r\n}\r\nreturn 0;\r\nError:\r\nlist_for_each_entry_safe(entry, next, &nvs_list, node) {\r\nlist_del(&entry->node);\r\nkfree(entry);\r\n}\r\nreturn -ENOMEM;\r\n}\r\nvoid suspend_nvs_free(void)\r\n{\r\nstruct nvs_page *entry;\r\nlist_for_each_entry(entry, &nvs_list, node)\r\nif (entry->data) {\r\nfree_page((unsigned long)entry->data);\r\nentry->data = NULL;\r\nif (entry->kaddr) {\r\nif (entry->unmap) {\r\niounmap(entry->kaddr);\r\nentry->unmap = false;\r\n} else {\r\nacpi_os_unmap_memory(entry->kaddr,\r\nentry->size);\r\n}\r\nentry->kaddr = NULL;\r\n}\r\n}\r\n}\r\nint suspend_nvs_alloc(void)\r\n{\r\nstruct nvs_page *entry;\r\nlist_for_each_entry(entry, &nvs_list, node) {\r\nentry->data = (void *)__get_free_page(GFP_KERNEL);\r\nif (!entry->data) {\r\nsuspend_nvs_free();\r\nreturn -ENOMEM;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint suspend_nvs_save(void)\r\n{\r\nstruct nvs_page *entry;\r\nprintk(KERN_INFO "PM: Saving platform NVS memory\n");\r\nlist_for_each_entry(entry, &nvs_list, node)\r\nif (entry->data) {\r\nunsigned long phys = entry->phys_start;\r\nunsigned int size = entry->size;\r\nentry->kaddr = acpi_os_get_iomem(phys, size);\r\nif (!entry->kaddr) {\r\nentry->kaddr = acpi_os_ioremap(phys, size);\r\nentry->unmap = !!entry->kaddr;\r\n}\r\nif (!entry->kaddr) {\r\nsuspend_nvs_free();\r\nreturn -ENOMEM;\r\n}\r\nmemcpy(entry->data, entry->kaddr, entry->size);\r\n}\r\nreturn 0;\r\n}\r\nvoid suspend_nvs_restore(void)\r\n{\r\nstruct nvs_page *entry;\r\nprintk(KERN_INFO "PM: Restoring platform NVS memory\n");\r\nlist_for_each_entry(entry, &nvs_list, node)\r\nif (entry->data)\r\nmemcpy(entry->kaddr, entry->data, entry->size);\r\n}

int ultrix_partition(struct parsed_partitions *state)\r\n{\r\nint i;\r\nSector sect;\r\nunsigned char *data;\r\nstruct ultrix_disklabel {\r\ns32 pt_magic;\r\ns32 pt_valid;\r\nstruct pt_info {\r\ns32 pi_nblocks;\r\nu32 pi_blkoff;\r\n} pt_part[8];\r\n} *label;\r\n#define PT_MAGIC 0x032957\r\n#define PT_VALID 1\r\ndata = read_part_sector(state, (16384 - sizeof(*label))/512, &sect);\r\nif (!data)\r\nreturn -1;\r\nlabel = (struct ultrix_disklabel *)(data + 512 - sizeof(*label));\r\nif (label->pt_magic == PT_MAGIC && label->pt_valid == PT_VALID) {\r\nfor (i=0; i<8; i++)\r\nif (label->pt_part[i].pi_nblocks)\r\nput_partition(state, i+1,\r\nlabel->pt_part[i].pi_blkoff,\r\nlabel->pt_part[i].pi_nblocks);\r\nput_dev_sector(sect);\r\nstrlcat(state->pp_buf, "\n", PAGE_SIZE);\r\nreturn 1;\r\n} else {\r\nput_dev_sector(sect);\r\nreturn 0;\r\n}\r\n}

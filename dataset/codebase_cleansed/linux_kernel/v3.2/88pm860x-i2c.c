static inline int pm860x_read_device(struct i2c_client *i2c,\r\nint reg, int bytes, void *dest)\r\n{\r\nunsigned char data;\r\nint ret;\r\ndata = (unsigned char)reg;\r\nret = i2c_master_send(i2c, &data, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nret = i2c_master_recv(i2c, dest, bytes);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic inline int pm860x_write_device(struct i2c_client *i2c,\r\nint reg, int bytes, void *src)\r\n{\r\nunsigned char buf[bytes + 1];\r\nint ret;\r\nbuf[0] = (unsigned char)reg;\r\nmemcpy(&buf[1], src, bytes);\r\nret = i2c_master_send(i2c, buf, bytes + 1);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint pm860x_reg_read(struct i2c_client *i2c, int reg)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nunsigned char data;\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = pm860x_read_device(i2c, reg, 1, &data);\r\nmutex_unlock(&chip->io_lock);\r\nif (ret < 0)\r\nreturn ret;\r\nelse\r\nreturn (int)data;\r\n}\r\nint pm860x_reg_write(struct i2c_client *i2c, int reg,\r\nunsigned char data)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = pm860x_write_device(i2c, reg, 1, &data);\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nint pm860x_bulk_read(struct i2c_client *i2c, int reg,\r\nint count, unsigned char *buf)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = pm860x_read_device(i2c, reg, count, buf);\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nint pm860x_bulk_write(struct i2c_client *i2c, int reg,\r\nint count, unsigned char *buf)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = pm860x_write_device(i2c, reg, count, buf);\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nint pm860x_set_bits(struct i2c_client *i2c, int reg,\r\nunsigned char mask, unsigned char data)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nunsigned char value;\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = pm860x_read_device(i2c, reg, 1, &value);\r\nif (ret < 0)\r\ngoto out;\r\nvalue &= ~mask;\r\nvalue |= data;\r\nret = pm860x_write_device(i2c, reg, 1, &value);\r\nout:\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nint pm860x_page_reg_read(struct i2c_client *i2c, int reg)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nunsigned char zero = 0;\r\nunsigned char data;\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\npm860x_write_device(i2c, 0xFA, 0, &zero);\r\npm860x_write_device(i2c, 0xFB, 0, &zero);\r\npm860x_write_device(i2c, 0xFF, 0, &zero);\r\nret = pm860x_read_device(i2c, reg, 1, &data);\r\nif (ret >= 0)\r\nret = (int)data;\r\npm860x_write_device(i2c, 0xFE, 0, &zero);\r\npm860x_write_device(i2c, 0xFC, 0, &zero);\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nint pm860x_page_reg_write(struct i2c_client *i2c, int reg,\r\nunsigned char data)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nunsigned char zero;\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\npm860x_write_device(i2c, 0xFA, 0, &zero);\r\npm860x_write_device(i2c, 0xFB, 0, &zero);\r\npm860x_write_device(i2c, 0xFF, 0, &zero);\r\nret = pm860x_write_device(i2c, reg, 1, &data);\r\npm860x_write_device(i2c, 0xFE, 0, &zero);\r\npm860x_write_device(i2c, 0xFC, 0, &zero);\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nint pm860x_page_bulk_read(struct i2c_client *i2c, int reg,\r\nint count, unsigned char *buf)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nunsigned char zero = 0;\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\npm860x_write_device(i2c, 0xFA, 0, &zero);\r\npm860x_write_device(i2c, 0xFB, 0, &zero);\r\npm860x_write_device(i2c, 0xFF, 0, &zero);\r\nret = pm860x_read_device(i2c, reg, count, buf);\r\npm860x_write_device(i2c, 0xFE, 0, &zero);\r\npm860x_write_device(i2c, 0xFC, 0, &zero);\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nint pm860x_page_bulk_write(struct i2c_client *i2c, int reg,\r\nint count, unsigned char *buf)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nunsigned char zero = 0;\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\npm860x_write_device(i2c, 0xFA, 0, &zero);\r\npm860x_write_device(i2c, 0xFB, 0, &zero);\r\npm860x_write_device(i2c, 0xFF, 0, &zero);\r\nret = pm860x_write_device(i2c, reg, count, buf);\r\npm860x_write_device(i2c, 0xFE, 0, &zero);\r\npm860x_write_device(i2c, 0xFC, 0, &zero);\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nint pm860x_page_set_bits(struct i2c_client *i2c, int reg,\r\nunsigned char mask, unsigned char data)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(i2c);\r\nunsigned char zero;\r\nunsigned char value;\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\npm860x_write_device(i2c, 0xFA, 0, &zero);\r\npm860x_write_device(i2c, 0xFB, 0, &zero);\r\npm860x_write_device(i2c, 0xFF, 0, &zero);\r\nret = pm860x_read_device(i2c, reg, 1, &value);\r\nif (ret < 0)\r\ngoto out;\r\nvalue &= ~mask;\r\nvalue |= data;\r\nret = pm860x_write_device(i2c, reg, 1, &value);\r\nout:\r\npm860x_write_device(i2c, 0xFE, 0, &zero);\r\npm860x_write_device(i2c, 0xFC, 0, &zero);\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nstatic int verify_addr(struct i2c_client *i2c)\r\n{\r\nunsigned short addr_8607[] = {0x30, 0x34};\r\nunsigned short addr_8606[] = {0x10, 0x11};\r\nint size, i;\r\nif (i2c == NULL)\r\nreturn 0;\r\nsize = ARRAY_SIZE(addr_8606);\r\nfor (i = 0; i < size; i++) {\r\nif (i2c->addr == *(addr_8606 + i))\r\nreturn CHIP_PM8606;\r\n}\r\nsize = ARRAY_SIZE(addr_8607);\r\nfor (i = 0; i < size; i++) {\r\nif (i2c->addr == *(addr_8607 + i))\r\nreturn CHIP_PM8607;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit pm860x_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct pm860x_platform_data *pdata = client->dev.platform_data;\r\nstruct pm860x_chip *chip;\r\nif (!pdata) {\r\npr_info("No platform data in %s!\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nchip = kzalloc(sizeof(struct pm860x_chip), GFP_KERNEL);\r\nif (chip == NULL)\r\nreturn -ENOMEM;\r\nchip->id = verify_addr(client);\r\nchip->client = client;\r\ni2c_set_clientdata(client, chip);\r\nchip->dev = &client->dev;\r\nmutex_init(&chip->io_lock);\r\ndev_set_drvdata(chip->dev, chip);\r\nif (pdata->companion_addr && (pdata->companion_addr != client->addr)) {\r\nchip->companion_addr = pdata->companion_addr;\r\nchip->companion = i2c_new_dummy(chip->client->adapter,\r\nchip->companion_addr);\r\ni2c_set_clientdata(chip->companion, chip);\r\n}\r\npm860x_device_init(chip, pdata);\r\nreturn 0;\r\n}\r\nstatic int __devexit pm860x_remove(struct i2c_client *client)\r\n{\r\nstruct pm860x_chip *chip = i2c_get_clientdata(client);\r\npm860x_device_exit(chip);\r\ni2c_unregister_device(chip->companion);\r\nkfree(chip);\r\nreturn 0;\r\n}\r\nstatic int __init pm860x_i2c_init(void)\r\n{\r\nint ret;\r\nret = i2c_add_driver(&pm860x_driver);\r\nif (ret != 0)\r\npr_err("Failed to register 88PM860x I2C driver: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void __exit pm860x_i2c_exit(void)\r\n{\r\ni2c_del_driver(&pm860x_driver);\r\n}

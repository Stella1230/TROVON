u8 acpi_ev_is_notify_object(struct acpi_namespace_node *node)\r\n{\r\nswitch (node->type) {\r\ncase ACPI_TYPE_DEVICE:\r\ncase ACPI_TYPE_PROCESSOR:\r\ncase ACPI_TYPE_THERMAL:\r\nreturn (TRUE);\r\ndefault:\r\nreturn (FALSE);\r\n}\r\n}\r\nacpi_status\r\nacpi_ev_queue_notify_request(struct acpi_namespace_node * node,\r\nu32 notify_value)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_operand_object *handler_obj = NULL;\r\nunion acpi_generic_state *notify_info;\r\nacpi_status status = AE_OK;\r\nACPI_FUNCTION_NAME(ev_queue_notify_request);\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"Dispatching Notify on [%4.4s] Node %p Value 0x%2.2X (%s)\n",\r\nacpi_ut_get_node_name(node), node, notify_value,\r\nacpi_ut_get_notify_name(notify_value)));\r\nobj_desc = acpi_ns_get_attached_object(node);\r\nif (obj_desc) {\r\nswitch (node->type) {\r\ncase ACPI_TYPE_DEVICE:\r\ncase ACPI_TYPE_THERMAL:\r\ncase ACPI_TYPE_PROCESSOR:\r\nif (notify_value <= ACPI_MAX_SYS_NOTIFY) {\r\nhandler_obj =\r\nobj_desc->common_notify.system_notify;\r\n} else {\r\nhandler_obj =\r\nobj_desc->common_notify.device_notify;\r\n}\r\nbreak;\r\ndefault:\r\nreturn (AE_TYPE);\r\n}\r\n}\r\nif ((acpi_gbl_system_notify.handler &&\r\n(notify_value <= ACPI_MAX_SYS_NOTIFY)) ||\r\n(acpi_gbl_device_notify.handler &&\r\n(notify_value > ACPI_MAX_SYS_NOTIFY)) || handler_obj) {\r\nnotify_info = acpi_ut_create_generic_state();\r\nif (!notify_info) {\r\nreturn (AE_NO_MEMORY);\r\n}\r\nif (!handler_obj) {\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"Executing system notify handler for Notify (%4.4s, %X) "\r\n"node %p\n",\r\nacpi_ut_get_node_name(node),\r\nnotify_value, node));\r\n}\r\nnotify_info->common.descriptor_type =\r\nACPI_DESC_TYPE_STATE_NOTIFY;\r\nnotify_info->notify.node = node;\r\nnotify_info->notify.value = (u16) notify_value;\r\nnotify_info->notify.handler_obj = handler_obj;\r\nstatus =\r\nacpi_os_execute(OSL_NOTIFY_HANDLER, acpi_ev_notify_dispatch,\r\nnotify_info);\r\nif (ACPI_FAILURE(status)) {\r\nacpi_ut_delete_generic_state(notify_info);\r\n}\r\n} else {\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"No notify handler for Notify (%4.4s, %X) node %p\n",\r\nacpi_ut_get_node_name(node), notify_value,\r\nnode));\r\n}\r\nreturn (status);\r\n}\r\nstatic void ACPI_SYSTEM_XFACE acpi_ev_notify_dispatch(void *context)\r\n{\r\nunion acpi_generic_state *notify_info =\r\n(union acpi_generic_state *)context;\r\nacpi_notify_handler global_handler = NULL;\r\nvoid *global_context = NULL;\r\nunion acpi_operand_object *handler_obj;\r\nACPI_FUNCTION_ENTRY();\r\nif (notify_info->notify.value <= ACPI_MAX_SYS_NOTIFY) {\r\nif (acpi_gbl_system_notify.handler) {\r\nglobal_handler = acpi_gbl_system_notify.handler;\r\nglobal_context = acpi_gbl_system_notify.context;\r\n}\r\n} else {\r\nif (acpi_gbl_device_notify.handler) {\r\nglobal_handler = acpi_gbl_device_notify.handler;\r\nglobal_context = acpi_gbl_device_notify.context;\r\n}\r\n}\r\nif (global_handler) {\r\nglobal_handler(notify_info->notify.node,\r\nnotify_info->notify.value, global_context);\r\n}\r\nhandler_obj = notify_info->notify.handler_obj;\r\nif (handler_obj) {\r\nstruct acpi_object_notify_handler *notifier;\r\nnotifier = &handler_obj->notify;\r\nwhile (notifier) {\r\nnotifier->handler(notify_info->notify.node,\r\nnotify_info->notify.value,\r\nnotifier->context);\r\nnotifier = notifier->next;\r\n}\r\n}\r\nacpi_ut_delete_generic_state(notify_info);\r\n}\r\nvoid acpi_ev_terminate(void)\r\n{\r\nu32 i;\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(ev_terminate);\r\nif (acpi_gbl_events_initialized) {\r\nfor (i = 0; i < ACPI_NUM_FIXED_EVENTS; i++) {\r\nstatus = acpi_disable_event(i, 0);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR((AE_INFO,\r\n"Could not disable fixed event %u",\r\n(u32) i));\r\n}\r\n}\r\nstatus = acpi_ev_walk_gpe_list(acpi_hw_disable_gpe_block, NULL);\r\nstatus = acpi_ev_remove_sci_handler();\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR((AE_INFO, "Could not remove SCI handler"));\r\n}\r\nstatus = acpi_ev_remove_global_lock_handler();\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR((AE_INFO,\r\n"Could not remove Global Lock handler"));\r\n}\r\n}\r\nstatus = acpi_ev_walk_gpe_list(acpi_ev_delete_gpe_handlers, NULL);\r\nif (acpi_gbl_original_mode == ACPI_SYS_MODE_LEGACY) {\r\nstatus = acpi_disable();\r\nif (ACPI_FAILURE(status)) {\r\nACPI_WARNING((AE_INFO, "AcpiDisable failed"));\r\n}\r\n}\r\nreturn_VOID;\r\n}

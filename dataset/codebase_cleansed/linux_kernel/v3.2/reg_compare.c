static int compare(FPU_REG const *b, int tagb)\r\n{\r\nint diff, exp0, expb;\r\nu_char st0_tag;\r\nFPU_REG *st0_ptr;\r\nFPU_REG x, y;\r\nu_char st0_sign, signb = getsign(b);\r\nst0_ptr = &st(0);\r\nst0_tag = FPU_gettag0();\r\nst0_sign = getsign(st0_ptr);\r\nif (tagb == TAG_Special)\r\ntagb = FPU_Special(b);\r\nif (st0_tag == TAG_Special)\r\nst0_tag = FPU_Special(st0_ptr);\r\nif (((st0_tag != TAG_Valid) && (st0_tag != TW_Denormal))\r\n|| ((tagb != TAG_Valid) && (tagb != TW_Denormal))) {\r\nif (st0_tag == TAG_Zero) {\r\nif (tagb == TAG_Zero)\r\nreturn COMP_A_eq_B;\r\nif (tagb == TAG_Valid)\r\nreturn ((signb ==\r\nSIGN_POS) ? COMP_A_lt_B : COMP_A_gt_B);\r\nif (tagb == TW_Denormal)\r\nreturn ((signb ==\r\nSIGN_POS) ? COMP_A_lt_B : COMP_A_gt_B)\r\n| COMP_Denormal;\r\n} else if (tagb == TAG_Zero) {\r\nif (st0_tag == TAG_Valid)\r\nreturn ((st0_sign ==\r\nSIGN_POS) ? COMP_A_gt_B : COMP_A_lt_B);\r\nif (st0_tag == TW_Denormal)\r\nreturn ((st0_sign ==\r\nSIGN_POS) ? COMP_A_gt_B : COMP_A_lt_B)\r\n| COMP_Denormal;\r\n}\r\nif (st0_tag == TW_Infinity) {\r\nif ((tagb == TAG_Valid) || (tagb == TAG_Zero))\r\nreturn ((st0_sign ==\r\nSIGN_POS) ? COMP_A_gt_B : COMP_A_lt_B);\r\nelse if (tagb == TW_Denormal)\r\nreturn ((st0_sign ==\r\nSIGN_POS) ? COMP_A_gt_B : COMP_A_lt_B)\r\n| COMP_Denormal;\r\nelse if (tagb == TW_Infinity) {\r\nreturn (st0_sign == signb) ? COMP_A_eq_B :\r\n((st0_sign ==\r\nSIGN_POS) ? COMP_A_gt_B : COMP_A_lt_B);\r\n}\r\n} else if (tagb == TW_Infinity) {\r\nif ((st0_tag == TAG_Valid) || (st0_tag == TAG_Zero))\r\nreturn ((signb ==\r\nSIGN_POS) ? COMP_A_lt_B : COMP_A_gt_B);\r\nif (st0_tag == TW_Denormal)\r\nreturn ((signb ==\r\nSIGN_POS) ? COMP_A_lt_B : COMP_A_gt_B)\r\n| COMP_Denormal;\r\n}\r\nif ((st0_tag == TW_NaN) || (tagb == TW_NaN)) {\r\nint signalling = 0, unsupported = 0;\r\nif (st0_tag == TW_NaN) {\r\nsignalling =\r\n(st0_ptr->sigh & 0xc0000000) == 0x80000000;\r\nunsupported = !((exponent(st0_ptr) == EXP_OVER)\r\n&& (st0_ptr->\r\nsigh & 0x80000000));\r\n}\r\nif (tagb == TW_NaN) {\r\nsignalling |=\r\n(b->sigh & 0xc0000000) == 0x80000000;\r\nunsupported |= !((exponent(b) == EXP_OVER)\r\n&& (b->sigh & 0x80000000));\r\n}\r\nif (signalling || unsupported)\r\nreturn COMP_No_Comp | COMP_SNaN | COMP_NaN;\r\nelse\r\nreturn COMP_No_Comp | COMP_NaN;\r\n}\r\nEXCEPTION(EX_Invalid);\r\n}\r\nif (st0_sign != signb) {\r\nreturn ((st0_sign == SIGN_POS) ? COMP_A_gt_B : COMP_A_lt_B)\r\n| (((st0_tag == TW_Denormal) || (tagb == TW_Denormal)) ?\r\nCOMP_Denormal : 0);\r\n}\r\nif ((st0_tag == TW_Denormal) || (tagb == TW_Denormal)) {\r\nFPU_to_exp16(st0_ptr, &x);\r\nFPU_to_exp16(b, &y);\r\nst0_ptr = &x;\r\nb = &y;\r\nexp0 = exponent16(st0_ptr);\r\nexpb = exponent16(b);\r\n} else {\r\nexp0 = exponent(st0_ptr);\r\nexpb = exponent(b);\r\n}\r\n#ifdef PARANOID\r\nif (!(st0_ptr->sigh & 0x80000000))\r\nEXCEPTION(EX_Invalid);\r\nif (!(b->sigh & 0x80000000))\r\nEXCEPTION(EX_Invalid);\r\n#endif\r\ndiff = exp0 - expb;\r\nif (diff == 0) {\r\ndiff = st0_ptr->sigh - b->sigh;\r\nif (diff == 0) {\r\ndiff = st0_ptr->sigl > b->sigl;\r\nif (diff == 0)\r\ndiff = -(st0_ptr->sigl < b->sigl);\r\n}\r\n}\r\nif (diff > 0) {\r\nreturn ((st0_sign == SIGN_POS) ? COMP_A_gt_B : COMP_A_lt_B)\r\n| (((st0_tag == TW_Denormal) || (tagb == TW_Denormal)) ?\r\nCOMP_Denormal : 0);\r\n}\r\nif (diff < 0) {\r\nreturn ((st0_sign == SIGN_POS) ? COMP_A_lt_B : COMP_A_gt_B)\r\n| (((st0_tag == TW_Denormal) || (tagb == TW_Denormal)) ?\r\nCOMP_Denormal : 0);\r\n}\r\nreturn COMP_A_eq_B\r\n| (((st0_tag == TW_Denormal) || (tagb == TW_Denormal)) ?\r\nCOMP_Denormal : 0);\r\n}\r\nint FPU_compare_st_data(FPU_REG const *loaded_data, u_char loaded_tag)\r\n{\r\nint f = 0, c;\r\nc = compare(loaded_data, loaded_tag);\r\nif (c & COMP_NaN) {\r\nEXCEPTION(EX_Invalid);\r\nf = SW_C3 | SW_C2 | SW_C0;\r\n} else\r\nswitch (c & 7) {\r\ncase COMP_A_lt_B:\r\nf = SW_C0;\r\nbreak;\r\ncase COMP_A_eq_B:\r\nf = SW_C3;\r\nbreak;\r\ncase COMP_A_gt_B:\r\nf = 0;\r\nbreak;\r\ncase COMP_No_Comp:\r\nf = SW_C3 | SW_C2 | SW_C0;\r\nbreak;\r\n#ifdef PARANOID\r\ndefault:\r\nEXCEPTION(EX_INTERNAL | 0x121);\r\nf = SW_C3 | SW_C2 | SW_C0;\r\nbreak;\r\n#endif\r\n}\r\nsetcc(f);\r\nif (c & COMP_Denormal) {\r\nreturn denormal_operand() < 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int compare_st_st(int nr)\r\n{\r\nint f = 0, c;\r\nFPU_REG *st_ptr;\r\nif (!NOT_EMPTY(0) || !NOT_EMPTY(nr)) {\r\nsetcc(SW_C3 | SW_C2 | SW_C0);\r\nEXCEPTION(EX_StackUnder);\r\nreturn !(control_word & CW_Invalid);\r\n}\r\nst_ptr = &st(nr);\r\nc = compare(st_ptr, FPU_gettagi(nr));\r\nif (c & COMP_NaN) {\r\nsetcc(SW_C3 | SW_C2 | SW_C0);\r\nEXCEPTION(EX_Invalid);\r\nreturn !(control_word & CW_Invalid);\r\n} else\r\nswitch (c & 7) {\r\ncase COMP_A_lt_B:\r\nf = SW_C0;\r\nbreak;\r\ncase COMP_A_eq_B:\r\nf = SW_C3;\r\nbreak;\r\ncase COMP_A_gt_B:\r\nf = 0;\r\nbreak;\r\ncase COMP_No_Comp:\r\nf = SW_C3 | SW_C2 | SW_C0;\r\nbreak;\r\n#ifdef PARANOID\r\ndefault:\r\nEXCEPTION(EX_INTERNAL | 0x122);\r\nf = SW_C3 | SW_C2 | SW_C0;\r\nbreak;\r\n#endif\r\n}\r\nsetcc(f);\r\nif (c & COMP_Denormal) {\r\nreturn denormal_operand() < 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int compare_u_st_st(int nr)\r\n{\r\nint f = 0, c;\r\nFPU_REG *st_ptr;\r\nif (!NOT_EMPTY(0) || !NOT_EMPTY(nr)) {\r\nsetcc(SW_C3 | SW_C2 | SW_C0);\r\nEXCEPTION(EX_StackUnder);\r\nreturn !(control_word & CW_Invalid);\r\n}\r\nst_ptr = &st(nr);\r\nc = compare(st_ptr, FPU_gettagi(nr));\r\nif (c & COMP_NaN) {\r\nsetcc(SW_C3 | SW_C2 | SW_C0);\r\nif (c & COMP_SNaN) {\r\nEXCEPTION(EX_Invalid);\r\nreturn !(control_word & CW_Invalid);\r\n}\r\nreturn 0;\r\n} else\r\nswitch (c & 7) {\r\ncase COMP_A_lt_B:\r\nf = SW_C0;\r\nbreak;\r\ncase COMP_A_eq_B:\r\nf = SW_C3;\r\nbreak;\r\ncase COMP_A_gt_B:\r\nf = 0;\r\nbreak;\r\ncase COMP_No_Comp:\r\nf = SW_C3 | SW_C2 | SW_C0;\r\nbreak;\r\n#ifdef PARANOID\r\ndefault:\r\nEXCEPTION(EX_INTERNAL | 0x123);\r\nf = SW_C3 | SW_C2 | SW_C0;\r\nbreak;\r\n#endif\r\n}\r\nsetcc(f);\r\nif (c & COMP_Denormal) {\r\nreturn denormal_operand() < 0;\r\n}\r\nreturn 0;\r\n}\r\nvoid fcom_st(void)\r\n{\r\ncompare_st_st(FPU_rm);\r\n}\r\nvoid fcompst(void)\r\n{\r\nif (!compare_st_st(FPU_rm))\r\nFPU_pop();\r\n}\r\nvoid fcompp(void)\r\n{\r\nif (FPU_rm != 1) {\r\nFPU_illegal();\r\nreturn;\r\n}\r\nif (!compare_st_st(1))\r\npoppop();\r\n}\r\nvoid fucom_(void)\r\n{\r\ncompare_u_st_st(FPU_rm);\r\n}\r\nvoid fucomp(void)\r\n{\r\nif (!compare_u_st_st(FPU_rm))\r\nFPU_pop();\r\n}\r\nvoid fucompp(void)\r\n{\r\nif (FPU_rm == 1) {\r\nif (!compare_u_st_st(1))\r\npoppop();\r\n} else\r\nFPU_illegal();\r\n}

acpi_status\r\nacpi_debug_trace(char *name, u32 debug_level, u32 debug_layer, u32 flags)\r\n{\r\nacpi_status status;\r\nstatus = acpi_ut_acquire_mutex(ACPI_MTX_NAMESPACE);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\nacpi_gbl_trace_method_name = *ACPI_CAST_PTR(u32, name);\r\nacpi_gbl_trace_flags = flags;\r\nif (debug_level) {\r\nacpi_gbl_trace_dbg_level = debug_level;\r\n}\r\nif (debug_layer) {\r\nacpi_gbl_trace_dbg_layer = debug_layer;\r\n}\r\n(void)acpi_ut_release_mutex(ACPI_MTX_NAMESPACE);\r\nreturn (AE_OK);\r\n}\r\nstatic void acpi_ps_start_trace(struct acpi_evaluate_info *info)\r\n{\r\nacpi_status status;\r\nACPI_FUNCTION_ENTRY();\r\nstatus = acpi_ut_acquire_mutex(ACPI_MTX_NAMESPACE);\r\nif (ACPI_FAILURE(status)) {\r\nreturn;\r\n}\r\nif ((!acpi_gbl_trace_method_name) ||\r\n(acpi_gbl_trace_method_name != info->resolved_node->name.integer)) {\r\ngoto exit;\r\n}\r\nacpi_gbl_original_dbg_level = acpi_dbg_level;\r\nacpi_gbl_original_dbg_layer = acpi_dbg_layer;\r\nacpi_dbg_level = 0x00FFFFFF;\r\nacpi_dbg_layer = ACPI_UINT32_MAX;\r\nif (acpi_gbl_trace_dbg_level) {\r\nacpi_dbg_level = acpi_gbl_trace_dbg_level;\r\n}\r\nif (acpi_gbl_trace_dbg_layer) {\r\nacpi_dbg_layer = acpi_gbl_trace_dbg_layer;\r\n}\r\nexit:\r\n(void)acpi_ut_release_mutex(ACPI_MTX_NAMESPACE);\r\n}\r\nstatic void acpi_ps_stop_trace(struct acpi_evaluate_info *info)\r\n{\r\nacpi_status status;\r\nACPI_FUNCTION_ENTRY();\r\nstatus = acpi_ut_acquire_mutex(ACPI_MTX_NAMESPACE);\r\nif (ACPI_FAILURE(status)) {\r\nreturn;\r\n}\r\nif ((!acpi_gbl_trace_method_name) ||\r\n(acpi_gbl_trace_method_name != info->resolved_node->name.integer)) {\r\ngoto exit;\r\n}\r\nif (acpi_gbl_trace_flags & 1) {\r\nacpi_gbl_trace_method_name = 0;\r\nacpi_gbl_trace_dbg_level = 0;\r\nacpi_gbl_trace_dbg_layer = 0;\r\n}\r\nacpi_dbg_level = acpi_gbl_original_dbg_level;\r\nacpi_dbg_layer = acpi_gbl_original_dbg_layer;\r\nexit:\r\n(void)acpi_ut_release_mutex(ACPI_MTX_NAMESPACE);\r\n}\r\nacpi_status acpi_ps_execute_method(struct acpi_evaluate_info *info)\r\n{\r\nacpi_status status;\r\nunion acpi_parse_object *op;\r\nstruct acpi_walk_state *walk_state;\r\nACPI_FUNCTION_TRACE(ps_execute_method);\r\nacpi_tb_check_dsdt_header();\r\nif (!info || !info->resolved_node) {\r\nreturn_ACPI_STATUS(AE_NULL_ENTRY);\r\n}\r\nstatus =\r\nacpi_ds_begin_method_execution(info->resolved_node, info->obj_desc,\r\nNULL);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_ps_update_parameter_list(info, REF_INCREMENT);\r\nacpi_ps_start_trace(info);\r\nACPI_DEBUG_PRINT((ACPI_DB_PARSE,\r\n"**** Begin Method Parse/Execute [%4.4s] **** Node=%p Obj=%p\n",\r\ninfo->resolved_node->name.ascii, info->resolved_node,\r\ninfo->obj_desc));\r\nop = acpi_ps_create_scope_op();\r\nif (!op) {\r\nstatus = AE_NO_MEMORY;\r\ngoto cleanup;\r\n}\r\ninfo->pass_number = ACPI_IMODE_EXECUTE;\r\nwalk_state =\r\nacpi_ds_create_walk_state(info->obj_desc->method.owner_id, NULL,\r\nNULL, NULL);\r\nif (!walk_state) {\r\nstatus = AE_NO_MEMORY;\r\ngoto cleanup;\r\n}\r\nstatus = acpi_ds_init_aml_walk(walk_state, op, info->resolved_node,\r\ninfo->obj_desc->method.aml_start,\r\ninfo->obj_desc->method.aml_length, info,\r\ninfo->pass_number);\r\nif (ACPI_FAILURE(status)) {\r\nacpi_ds_delete_walk_state(walk_state);\r\ngoto cleanup;\r\n}\r\nif (info->obj_desc->method.info_flags & ACPI_METHOD_MODULE_LEVEL) {\r\nwalk_state->parse_flags |= ACPI_PARSE_MODULE_LEVEL;\r\n}\r\nif (info->obj_desc->method.info_flags & ACPI_METHOD_INTERNAL_ONLY) {\r\nstatus =\r\ninfo->obj_desc->method.dispatch.implementation(walk_state);\r\ninfo->return_object = walk_state->return_desc;\r\nacpi_ds_scope_stack_clear(walk_state);\r\nacpi_ps_cleanup_scope(&walk_state->parser_state);\r\nacpi_ds_terminate_control_method(walk_state->method_desc,\r\nwalk_state);\r\nacpi_ds_delete_walk_state(walk_state);\r\ngoto cleanup;\r\n}\r\nif (acpi_gbl_enable_interpreter_slack) {\r\nwalk_state->implicit_return_obj =\r\nacpi_ut_create_integer_object((u64) 0);\r\nif (!walk_state->implicit_return_obj) {\r\nstatus = AE_NO_MEMORY;\r\nacpi_ds_delete_walk_state(walk_state);\r\ngoto cleanup;\r\n}\r\n}\r\nstatus = acpi_ps_parse_aml(walk_state);\r\ncleanup:\r\nacpi_ps_delete_parse_tree(op);\r\nacpi_ps_stop_trace(info);\r\nacpi_ps_update_parameter_list(info, REF_DECREMENT);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif (info->return_object) {\r\nACPI_DEBUG_PRINT((ACPI_DB_PARSE, "Method returned ObjDesc=%p\n",\r\ninfo->return_object));\r\nACPI_DUMP_STACK_ENTRY(info->return_object);\r\nstatus = AE_CTRL_RETURN_VALUE;\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatic void\r\nacpi_ps_update_parameter_list(struct acpi_evaluate_info *info, u16 action)\r\n{\r\nu32 i;\r\nif (info->parameters) {\r\nfor (i = 0; info->parameters[i]; i++) {\r\n(void)acpi_ut_update_object_reference(info->\r\nparameters[i],\r\naction);\r\n}\r\n}\r\n}

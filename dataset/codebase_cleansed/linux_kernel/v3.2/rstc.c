static int __init sirfsoc_of_rstc_init(void)\r\n{\r\nstruct device_node *np;\r\nnp = of_find_matching_node(NULL, rstc_ids);\r\nif (!np)\r\npanic("unable to find compatible rstc node in dtb\n");\r\nsirfsoc_rstc_base = of_iomap(np, 0);\r\nif (!sirfsoc_rstc_base)\r\npanic("unable to map rstc cpu registers\n");\r\nof_node_put(np);\r\nreturn 0;\r\n}\r\nint sirfsoc_reset_device(struct device *dev)\r\n{\r\nconst unsigned int *prop = of_get_property(dev->of_node, "reset-bit", NULL);\r\nunsigned int reset_bit;\r\nif (!prop)\r\nreturn -ENODEV;\r\nreset_bit = be32_to_cpup(prop);\r\nmutex_lock(&rstc_lock);\r\nwritel(readl(sirfsoc_rstc_base + (reset_bit / 32) * 4) | reset_bit,\r\nsirfsoc_rstc_base + (reset_bit / 32) * 4);\r\nmsleep(10);\r\nwritel(readl(sirfsoc_rstc_base + (reset_bit / 32) * 4) & ~reset_bit,\r\nsirfsoc_rstc_base + (reset_bit / 32) * 4);\r\nmutex_unlock(&rstc_lock);\r\nreturn 0;\r\n}

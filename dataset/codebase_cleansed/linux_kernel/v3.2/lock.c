static int pohmelfs_send_lock_trans(struct pohmelfs_inode *pi,\r\nu64 id, u64 start, u32 size, int type)\r\n{\r\nstruct inode *inode = &pi->vfs_inode;\r\nstruct pohmelfs_sb *psb = POHMELFS_SB(inode->i_sb);\r\nstruct netfs_trans *t;\r\nstruct netfs_cmd *cmd;\r\nint path_len, err;\r\nvoid *data;\r\nstruct netfs_lock *l;\r\nint isize = (type & POHMELFS_LOCK_GRAB) ? 0 : sizeof(struct netfs_inode_info);\r\nerr = pohmelfs_path_length(pi);\r\nif (err < 0)\r\ngoto err_out_exit;\r\npath_len = err;\r\nerr = -ENOMEM;\r\nt = netfs_trans_alloc(psb, path_len + sizeof(struct netfs_lock) + isize,\r\nNETFS_TRANS_SINGLE_DST, 0);\r\nif (!t)\r\ngoto err_out_exit;\r\ncmd = netfs_trans_current(t);\r\ndata = cmd + 1;\r\nerr = pohmelfs_construct_path_string(pi, data, path_len);\r\nif (err < 0)\r\ngoto err_out_free;\r\npath_len = err;\r\nl = data + path_len;\r\nl->start = start;\r\nl->size = size;\r\nl->type = type;\r\nl->ino = pi->ino;\r\ncmd->cmd = NETFS_LOCK;\r\ncmd->start = 0;\r\ncmd->id = id;\r\ncmd->size = sizeof(struct netfs_lock) + path_len + isize;\r\ncmd->ext = path_len;\r\ncmd->csize = 0;\r\nnetfs_convert_cmd(cmd);\r\nnetfs_convert_lock(l);\r\nif (isize) {\r\nstruct netfs_inode_info *info = (struct netfs_inode_info *)(l + 1);\r\ninfo->mode = inode->i_mode;\r\ninfo->nlink = inode->i_nlink;\r\ninfo->uid = inode->i_uid;\r\ninfo->gid = inode->i_gid;\r\ninfo->blocks = inode->i_blocks;\r\ninfo->rdev = inode->i_rdev;\r\ninfo->size = inode->i_size;\r\ninfo->version = inode->i_version;\r\nnetfs_convert_inode_info(info);\r\n}\r\nnetfs_trans_update(cmd, t, path_len + sizeof(struct netfs_lock) + isize);\r\nreturn netfs_trans_finish(t, psb);\r\nerr_out_free:\r\nnetfs_trans_free(t);\r\nerr_out_exit:\r\nprintk("%s: err: %d.\n", __func__, err);\r\nreturn err;\r\n}\r\nint pohmelfs_data_lock(struct pohmelfs_inode *pi, u64 start, u32 size, int type)\r\n{\r\nstruct pohmelfs_sb *psb = POHMELFS_SB(pi->vfs_inode.i_sb);\r\nstruct pohmelfs_mcache *m;\r\nint err = -ENOMEM;\r\nstruct iattr iattr;\r\nstruct inode *inode = &pi->vfs_inode;\r\ndprintk("%s: %p: ino: %llu, start: %llu, size: %u, "\r\n"type: %d, locked as: %d, owned: %d.\n",\r\n__func__, &pi->vfs_inode, pi->ino,\r\nstart, size, type, pi->lock_type,\r\n!!test_bit(NETFS_INODE_OWNED, &pi->state));\r\nif (!pohmelfs_need_lock(pi, type))\r\nreturn 0;\r\nm = pohmelfs_mcache_alloc(psb, start, size, NULL);\r\nif (IS_ERR(m))\r\nreturn PTR_ERR(m);\r\nerr = pohmelfs_send_lock_trans(pi, m->gen, start, size,\r\ntype | POHMELFS_LOCK_GRAB);\r\nif (err)\r\ngoto err_out_put;\r\nerr = wait_for_completion_timeout(&m->complete, psb->mcache_timeout);\r\nif (err)\r\nerr = m->err;\r\nelse\r\nerr = -ETIMEDOUT;\r\nif (err) {\r\nprintk("%s: %p: ino: %llu, mgen: %llu, start: %llu, size: %u, err: %d.\n",\r\n__func__, &pi->vfs_inode, pi->ino, m->gen, start, size, err);\r\n}\r\nif (err && (err != -ENOENT))\r\ngoto err_out_put;\r\nif (!err) {\r\nnetfs_convert_inode_info(&m->info);\r\niattr.ia_valid = ATTR_MODE | ATTR_UID | ATTR_GID | ATTR_SIZE | ATTR_ATIME;\r\niattr.ia_mode = m->info.mode;\r\niattr.ia_uid = m->info.uid;\r\niattr.ia_gid = m->info.gid;\r\niattr.ia_size = m->info.size;\r\niattr.ia_atime = CURRENT_TIME;\r\ndprintk("%s: %p: ino: %llu, mgen: %llu, start: %llu, isize: %llu -> %llu.\n",\r\n__func__, &pi->vfs_inode, pi->ino, m->gen, start, inode->i_size, m->info.size);\r\nerr = pohmelfs_setattr_raw(inode, &iattr);\r\nif (!err) {\r\nstruct dentry *dentry = d_find_alias(inode);\r\nif (dentry) {\r\nfsnotify_change(dentry, iattr.ia_valid);\r\ndput(dentry);\r\n}\r\n}\r\n}\r\npi->lock_type = type;\r\nset_bit(NETFS_INODE_OWNED, &pi->state);\r\npohmelfs_mcache_put(psb, m);\r\nreturn 0;\r\nerr_out_put:\r\npohmelfs_mcache_put(psb, m);\r\nreturn err;\r\n}\r\nint pohmelfs_data_unlock(struct pohmelfs_inode *pi, u64 start, u32 size, int type)\r\n{\r\ndprintk("%s: %p: ino: %llu, start: %llu, size: %u, type: %d.\n",\r\n__func__, &pi->vfs_inode, pi->ino, start, size, type);\r\npi->lock_type = 0;\r\nclear_bit(NETFS_INODE_REMOTE_DIR_SYNCED, &pi->state);\r\nclear_bit(NETFS_INODE_OWNED, &pi->state);\r\nreturn pohmelfs_send_lock_trans(pi, pi->ino, start, size, type);\r\n}

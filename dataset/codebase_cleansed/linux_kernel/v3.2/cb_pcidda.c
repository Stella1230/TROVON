static int cb_pcidda_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nstruct pci_dev *pcidev = NULL;\r\nint index;\r\nprintk("comedi%d: cb_pcidda: ", dev->minor);\r\nif (alloc_private(dev, sizeof(struct cb_pcidda_private)) < 0)\r\nreturn -ENOMEM;\r\nprintk("\n");\r\nfor_each_pci_dev(pcidev) {\r\nif (pcidev->vendor == PCI_VENDOR_ID_CB) {\r\nif (it->options[0] || it->options[1]) {\r\nif (pcidev->bus->number != it->options[0] ||\r\nPCI_SLOT(pcidev->devfn) != it->options[1]) {\r\ncontinue;\r\n}\r\n}\r\nfor (index = 0; index < ARRAY_SIZE(cb_pcidda_boards); index++) {\r\nif (cb_pcidda_boards[index].device_id ==\r\npcidev->device) {\r\ngoto found;\r\n}\r\n}\r\n}\r\n}\r\nif (!pcidev) {\r\nprintk\r\n("Not a ComputerBoards/MeasurementComputing card on requested position\n");\r\nreturn -EIO;\r\n}\r\nfound:\r\ndevpriv->pci_dev = pcidev;\r\ndev->board_ptr = cb_pcidda_boards + index;\r\nprintk("Found %s at requested position\n", thisboard->name);\r\nif (comedi_pci_enable(pcidev, thisboard->name)) {\r\nprintk\r\n("cb_pcidda: failed to enable PCI device and request regions\n");\r\nreturn -EIO;\r\n}\r\ndevpriv->digitalio =\r\npci_resource_start(devpriv->pci_dev, DIGITALIO_BADRINDEX);\r\ndevpriv->dac = pci_resource_start(devpriv->pci_dev, DAC_BADRINDEX);\r\nif (thisboard->status == 2)\r\nprintk\r\n("WARNING: DRIVER FOR THIS BOARD NOT CHECKED WITH MANUAL. "\r\n"WORKS ASSUMING FULL COMPATIBILITY WITH PCI-DDA08/12. "\r\n"PLEASE REPORT USAGE TO <ivanmr@altavista.com>.\n");\r\ndev->board_name = thisboard->name;\r\nif (alloc_subdevices(dev, 3) < 0)\r\nreturn -ENOMEM;\r\ns = dev->subdevices + 0;\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = thisboard->ao_chans;\r\ns->maxdata = (1 << thisboard->ao_bits) - 1;\r\ns->range_table = thisboard->ranges;\r\ns->insn_write = cb_pcidda_ao_winsn;\r\ns = dev->subdevices + 1;\r\nsubdev_8255_init(dev, s, NULL, devpriv->digitalio);\r\ns = dev->subdevices + 2;\r\nsubdev_8255_init(dev, s, NULL, devpriv->digitalio + PORT2A);\r\nprintk(" eeprom:");\r\nfor (index = 0; index < EEPROM_SIZE; index++) {\r\ndevpriv->eeprom_data[index] = cb_pcidda_read_eeprom(dev, index);\r\nprintk(" %i:0x%x ", index, devpriv->eeprom_data[index]);\r\n}\r\nprintk("\n");\r\nfor (index = 0; index < thisboard->ao_chans; index++)\r\ncb_pcidda_calibrate(dev, index, devpriv->ao_range[index]);\r\nreturn 1;\r\n}\r\nstatic int cb_pcidda_detach(struct comedi_device *dev)\r\n{\r\nif (devpriv) {\r\nif (devpriv->pci_dev) {\r\nif (devpriv->dac)\r\ncomedi_pci_disable(devpriv->pci_dev);\r\npci_dev_put(devpriv->pci_dev);\r\n}\r\n}\r\nif (dev->subdevices) {\r\nsubdev_8255_cleanup(dev, dev->subdevices + 1);\r\nsubdev_8255_cleanup(dev, dev->subdevices + 2);\r\n}\r\nprintk("comedi%d: cb_pcidda: remove\n", dev->minor);\r\nreturn 0;\r\n}\r\nstatic int cb_pcidda_ao_winsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int command;\r\nunsigned int channel, range;\r\nchannel = CR_CHAN(insn->chanspec);\r\nrange = CR_RANGE(insn->chanspec);\r\nif (range != devpriv->ao_range[channel])\r\ncb_pcidda_calibrate(dev, channel, range);\r\ncommand = NOSU | ENABLEDAC;\r\nswitch (range) {\r\ncase 0:\r\ncommand |= BIP | RANGE10V;\r\nbreak;\r\ncase 1:\r\ncommand |= BIP | RANGE5V;\r\nbreak;\r\ncase 2:\r\ncommand |= BIP | RANGE2V5;\r\nbreak;\r\ncase 3:\r\ncommand |= UNIP | RANGE10V;\r\nbreak;\r\ncase 4:\r\ncommand |= UNIP | RANGE5V;\r\nbreak;\r\ncase 5:\r\ncommand |= UNIP | RANGE2V5;\r\nbreak;\r\n}\r\ncommand |= channel << 2;\r\noutw(command, devpriv->dac + DACONTROL);\r\noutw(data[0], devpriv->dac + DADATA + channel * 2);\r\nreturn 1;\r\n}\r\nstatic unsigned int cb_pcidda_serial_in(struct comedi_device *dev)\r\n{\r\nunsigned int value = 0;\r\nint i;\r\nconst int value_width = 16;\r\nfor (i = 1; i <= value_width; i++) {\r\nif (inw_p(devpriv->dac + DACALIBRATION1) & SERIAL_OUT_BIT)\r\nvalue |= 1 << (value_width - i);\r\n}\r\nreturn value;\r\n}\r\nstatic void cb_pcidda_serial_out(struct comedi_device *dev, unsigned int value,\r\nunsigned int num_bits)\r\n{\r\nint i;\r\nfor (i = 1; i <= num_bits; i++) {\r\nif (value & (1 << (num_bits - i)))\r\ndevpriv->dac_cal1_bits |= SERIAL_IN_BIT;\r\nelse\r\ndevpriv->dac_cal1_bits &= ~SERIAL_IN_BIT;\r\noutw_p(devpriv->dac_cal1_bits, devpriv->dac + DACALIBRATION1);\r\n}\r\n}\r\nstatic unsigned int cb_pcidda_read_eeprom(struct comedi_device *dev,\r\nunsigned int address)\r\n{\r\nunsigned int i;\r\nunsigned int cal2_bits;\r\nunsigned int value;\r\nconst int max_num_caldacs = 4;\r\nconst int read_instruction = 0x6;\r\nconst int instruction_length = 3;\r\nconst int address_length = 8;\r\ncal2_bits = SELECT_EEPROM_BIT | DESELECT_REF_DAC_BIT | DUMMY_BIT;\r\nfor (i = 0; i < max_num_caldacs; i++)\r\ncal2_bits |= DESELECT_CALDAC_BIT(i);\r\noutw_p(cal2_bits, devpriv->dac + DACALIBRATION2);\r\ncb_pcidda_serial_out(dev, read_instruction, instruction_length);\r\ncb_pcidda_serial_out(dev, address, address_length);\r\nvalue = cb_pcidda_serial_in(dev);\r\ncal2_bits &= ~SELECT_EEPROM_BIT;\r\noutw_p(cal2_bits, devpriv->dac + DACALIBRATION2);\r\nreturn value;\r\n}\r\nstatic void cb_pcidda_write_caldac(struct comedi_device *dev,\r\nunsigned int caldac, unsigned int channel,\r\nunsigned int value)\r\n{\r\nunsigned int cal2_bits;\r\nunsigned int i;\r\nconst int num_channel_bits = 3;\r\nconst int num_caldac_bits = 8;\r\nconst int max_num_caldacs = 4;\r\ncb_pcidda_serial_out(dev, channel, num_channel_bits);\r\ncb_pcidda_serial_out(dev, value, num_caldac_bits);\r\ncal2_bits = DESELECT_REF_DAC_BIT | DUMMY_BIT;\r\nfor (i = 0; i < max_num_caldacs; i++)\r\ncal2_bits |= DESELECT_CALDAC_BIT(i);\r\ncal2_bits &= ~DESELECT_CALDAC_BIT(caldac);\r\noutw_p(cal2_bits, devpriv->dac + DACALIBRATION2);\r\ncal2_bits |= DESELECT_CALDAC_BIT(caldac);\r\noutw_p(cal2_bits, devpriv->dac + DACALIBRATION2);\r\n}\r\nstatic unsigned int caldac_number(unsigned int channel)\r\n{\r\nreturn channel / 2;\r\n}\r\nstatic unsigned int fine_gain_channel(unsigned int ao_channel)\r\n{\r\nreturn 4 * (ao_channel % 2);\r\n}\r\nstatic unsigned int coarse_gain_channel(unsigned int ao_channel)\r\n{\r\nreturn 1 + 4 * (ao_channel % 2);\r\n}\r\nstatic unsigned int coarse_offset_channel(unsigned int ao_channel)\r\n{\r\nreturn 2 + 4 * (ao_channel % 2);\r\n}\r\nstatic unsigned int fine_offset_channel(unsigned int ao_channel)\r\n{\r\nreturn 3 + 4 * (ao_channel % 2);\r\n}\r\nstatic unsigned int offset_eeprom_address(unsigned int ao_channel,\r\nunsigned int range)\r\n{\r\nreturn 0x7 + 2 * range + 12 * ao_channel;\r\n}\r\nstatic unsigned int gain_eeprom_address(unsigned int ao_channel,\r\nunsigned int range)\r\n{\r\nreturn 0x8 + 2 * range + 12 * ao_channel;\r\n}\r\nstatic unsigned int eeprom_coarse_byte(unsigned int word)\r\n{\r\nreturn (word >> 8) & 0xff;\r\n}\r\nstatic unsigned int eeprom_fine_byte(unsigned int word)\r\n{\r\nreturn word & 0xff;\r\n}\r\nstatic void cb_pcidda_calibrate(struct comedi_device *dev, unsigned int channel,\r\nunsigned int range)\r\n{\r\nunsigned int coarse_offset, fine_offset, coarse_gain, fine_gain;\r\ndevpriv->ao_range[channel] = range;\r\ncoarse_offset =\r\neeprom_coarse_byte(devpriv->eeprom_data\r\n[offset_eeprom_address(channel, range)]);\r\nfine_offset =\r\neeprom_fine_byte(devpriv->eeprom_data\r\n[offset_eeprom_address(channel, range)]);\r\ncoarse_gain =\r\neeprom_coarse_byte(devpriv->eeprom_data\r\n[gain_eeprom_address(channel, range)]);\r\nfine_gain =\r\neeprom_fine_byte(devpriv->eeprom_data\r\n[gain_eeprom_address(channel, range)]);\r\ncb_pcidda_write_caldac(dev, caldac_number(channel),\r\ncoarse_offset_channel(channel), coarse_offset);\r\ncb_pcidda_write_caldac(dev, caldac_number(channel),\r\nfine_offset_channel(channel), fine_offset);\r\ncb_pcidda_write_caldac(dev, caldac_number(channel),\r\ncoarse_gain_channel(channel), coarse_gain);\r\ncb_pcidda_write_caldac(dev, caldac_number(channel),\r\nfine_gain_channel(channel), fine_gain);\r\n}\r\nstatic int __devinit driver_cb_pcidda_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nreturn comedi_pci_auto_config(dev, driver_cb_pcidda.driver_name);\r\n}\r\nstatic void __devexit driver_cb_pcidda_pci_remove(struct pci_dev *dev)\r\n{\r\ncomedi_pci_auto_unconfig(dev);\r\n}\r\nstatic int __init driver_cb_pcidda_init_module(void)\r\n{\r\nint retval;\r\nretval = comedi_driver_register(&driver_cb_pcidda);\r\nif (retval < 0)\r\nreturn retval;\r\ndriver_cb_pcidda_pci_driver.name = (char *)driver_cb_pcidda.driver_name;\r\nreturn pci_register_driver(&driver_cb_pcidda_pci_driver);\r\n}\r\nstatic void __exit driver_cb_pcidda_cleanup_module(void)\r\n{\r\npci_unregister_driver(&driver_cb_pcidda_pci_driver);\r\ncomedi_driver_unregister(&driver_cb_pcidda);\r\n}

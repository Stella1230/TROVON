static inline uint32_t jz4740_i2s_read(const struct jz4740_i2s *i2s,\r\nunsigned int reg)\r\n{\r\nreturn readl(i2s->base + reg);\r\n}\r\nstatic inline void jz4740_i2s_write(const struct jz4740_i2s *i2s,\r\nunsigned int reg, uint32_t value)\r\n{\r\nwritel(value, i2s->base + reg);\r\n}\r\nstatic int jz4740_i2s_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t conf, ctrl;\r\nif (dai->active)\r\nreturn 0;\r\nctrl = jz4740_i2s_read(i2s, JZ_REG_AIC_CTRL);\r\nctrl |= JZ_AIC_CTRL_FLUSH;\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CTRL, ctrl);\r\nclk_enable(i2s->clk_i2s);\r\nconf = jz4740_i2s_read(i2s, JZ_REG_AIC_CONF);\r\nconf |= JZ_AIC_CONF_ENABLE;\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CONF, conf);\r\nreturn 0;\r\n}\r\nstatic void jz4740_i2s_shutdown(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t conf;\r\nif (dai->active)\r\nreturn;\r\nconf = jz4740_i2s_read(i2s, JZ_REG_AIC_CONF);\r\nconf &= ~JZ_AIC_CONF_ENABLE;\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CONF, conf);\r\nclk_disable(i2s->clk_i2s);\r\n}\r\nstatic int jz4740_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t ctrl;\r\nuint32_t mask;\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nmask = JZ_AIC_CTRL_ENABLE_PLAYBACK | JZ_AIC_CTRL_ENABLE_TX_DMA;\r\nelse\r\nmask = JZ_AIC_CTRL_ENABLE_CAPTURE | JZ_AIC_CTRL_ENABLE_RX_DMA;\r\nctrl = jz4740_i2s_read(i2s, JZ_REG_AIC_CTRL);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nctrl |= mask;\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nctrl &= ~mask;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CTRL, ctrl);\r\nreturn 0;\r\n}\r\nstatic int jz4740_i2s_set_fmt(struct snd_soc_dai *dai, unsigned int fmt)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t format = 0;\r\nuint32_t conf;\r\nconf = jz4740_i2s_read(i2s, JZ_REG_AIC_CONF);\r\nconf &= ~(JZ_AIC_CONF_BIT_CLK_MASTER | JZ_AIC_CONF_SYNC_CLK_MASTER);\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\nconf |= JZ_AIC_CONF_BIT_CLK_MASTER | JZ_AIC_CONF_SYNC_CLK_MASTER;\r\nformat |= JZ_AIC_I2S_FMT_ENABLE_SYS_CLK;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFS:\r\nconf |= JZ_AIC_CONF_SYNC_CLK_MASTER;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBS_CFM:\r\nconf |= JZ_AIC_CONF_BIT_CLK_MASTER;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_MSB:\r\nformat |= JZ_AIC_I2S_FMT_MSB;\r\nbreak;\r\ncase SND_SOC_DAIFMT_I2S:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\r\ncase SND_SOC_DAIFMT_NB_NF:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CONF, conf);\r\njz4740_i2s_write(i2s, JZ_REG_AIC_I2S_FMT, format);\r\nreturn 0;\r\n}\r\nstatic int jz4740_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nenum jz4740_dma_width dma_width;\r\nstruct jz4740_pcm_config *pcm_config;\r\nunsigned int sample_size;\r\nuint32_t ctrl;\r\nctrl = jz4740_i2s_read(i2s, JZ_REG_AIC_CTRL);\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S8:\r\nsample_size = 0;\r\ndma_width = JZ4740_DMA_WIDTH_8BIT;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S16:\r\nsample_size = 1;\r\ndma_width = JZ4740_DMA_WIDTH_16BIT;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nctrl &= ~JZ_AIC_CTRL_OUTPUT_SAMPLE_SIZE_MASK;\r\nctrl |= sample_size << JZ_AIC_CTRL_OUTPUT_SAMPLE_SIZE_OFFSET;\r\nif (params_channels(params) == 1)\r\nctrl |= JZ_AIC_CTRL_MONO_TO_STEREO;\r\nelse\r\nctrl &= ~JZ_AIC_CTRL_MONO_TO_STEREO;\r\npcm_config = &i2s->pcm_config_playback;\r\npcm_config->dma_config.dst_width = dma_width;\r\n} else {\r\nctrl &= ~JZ_AIC_CTRL_INPUT_SAMPLE_SIZE_MASK;\r\nctrl |= sample_size << JZ_AIC_CTRL_INPUT_SAMPLE_SIZE_OFFSET;\r\npcm_config = &i2s->pcm_config_capture;\r\npcm_config->dma_config.src_width = dma_width;\r\n}\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CTRL, ctrl);\r\nsnd_soc_dai_set_dma_data(dai, substream, pcm_config);\r\nreturn 0;\r\n}\r\nstatic int jz4740_i2s_set_sysclk(struct snd_soc_dai *dai, int clk_id,\r\nunsigned int freq, int dir)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nstruct clk *parent;\r\nint ret = 0;\r\nswitch (clk_id) {\r\ncase JZ4740_I2S_CLKSRC_EXT:\r\nparent = clk_get(NULL, "ext");\r\nclk_set_parent(i2s->clk_i2s, parent);\r\nbreak;\r\ncase JZ4740_I2S_CLKSRC_PLL:\r\nparent = clk_get(NULL, "pll half");\r\nclk_set_parent(i2s->clk_i2s, parent);\r\nret = clk_set_rate(i2s->clk_i2s, freq);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nclk_put(parent);\r\nreturn ret;\r\n}\r\nstatic int jz4740_i2s_suspend(struct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t conf;\r\nif (dai->active) {\r\nconf = jz4740_i2s_read(i2s, JZ_REG_AIC_CONF);\r\nconf &= ~JZ_AIC_CONF_ENABLE;\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CONF, conf);\r\nclk_disable(i2s->clk_i2s);\r\n}\r\nclk_disable(i2s->clk_aic);\r\nreturn 0;\r\n}\r\nstatic int jz4740_i2s_resume(struct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t conf;\r\nclk_enable(i2s->clk_aic);\r\nif (dai->active) {\r\nclk_enable(i2s->clk_i2s);\r\nconf = jz4740_i2s_read(i2s, JZ_REG_AIC_CONF);\r\nconf |= JZ_AIC_CONF_ENABLE;\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CONF, conf);\r\n}\r\nreturn 0;\r\n}\r\nstatic void jz4740_i2c_init_pcm_config(struct jz4740_i2s *i2s)\r\n{\r\nstruct jz4740_dma_config *dma_config;\r\ndma_config = &i2s->pcm_config_playback.dma_config;\r\ndma_config->src_width = JZ4740_DMA_WIDTH_32BIT,\r\ndma_config->transfer_size = JZ4740_DMA_TRANSFER_SIZE_16BYTE;\r\ndma_config->request_type = JZ4740_DMA_TYPE_AIC_TRANSMIT;\r\ndma_config->flags = JZ4740_DMA_SRC_AUTOINC;\r\ndma_config->mode = JZ4740_DMA_MODE_SINGLE;\r\ni2s->pcm_config_playback.fifo_addr = i2s->phys_base + JZ_REG_AIC_FIFO;\r\ndma_config = &i2s->pcm_config_capture.dma_config;\r\ndma_config->dst_width = JZ4740_DMA_WIDTH_32BIT,\r\ndma_config->transfer_size = JZ4740_DMA_TRANSFER_SIZE_16BYTE;\r\ndma_config->request_type = JZ4740_DMA_TYPE_AIC_RECEIVE;\r\ndma_config->flags = JZ4740_DMA_DST_AUTOINC;\r\ndma_config->mode = JZ4740_DMA_MODE_SINGLE;\r\ni2s->pcm_config_capture.fifo_addr = i2s->phys_base + JZ_REG_AIC_FIFO;\r\n}\r\nstatic int jz4740_i2s_dai_probe(struct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t conf;\r\nclk_enable(i2s->clk_aic);\r\njz4740_i2c_init_pcm_config(i2s);\r\nconf = (7 << JZ_AIC_CONF_FIFO_RX_THRESHOLD_OFFSET) |\r\n(8 << JZ_AIC_CONF_FIFO_TX_THRESHOLD_OFFSET) |\r\nJZ_AIC_CONF_OVERFLOW_PLAY_LAST |\r\nJZ_AIC_CONF_I2S |\r\nJZ_AIC_CONF_INTERNAL_CODEC;\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CONF, JZ_AIC_CONF_RESET);\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CONF, conf);\r\nreturn 0;\r\n}\r\nstatic int jz4740_i2s_dai_remove(struct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nclk_disable(i2s->clk_aic);\r\nreturn 0;\r\n}\r\nstatic int __devinit jz4740_i2s_dev_probe(struct platform_device *pdev)\r\n{\r\nstruct jz4740_i2s *i2s;\r\nint ret;\r\ni2s = kzalloc(sizeof(*i2s), GFP_KERNEL);\r\nif (!i2s)\r\nreturn -ENOMEM;\r\ni2s->mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!i2s->mem) {\r\nret = -ENOENT;\r\ngoto err_free;\r\n}\r\ni2s->mem = request_mem_region(i2s->mem->start, resource_size(i2s->mem),\r\npdev->name);\r\nif (!i2s->mem) {\r\nret = -EBUSY;\r\ngoto err_free;\r\n}\r\ni2s->base = ioremap_nocache(i2s->mem->start, resource_size(i2s->mem));\r\nif (!i2s->base) {\r\nret = -EBUSY;\r\ngoto err_release_mem_region;\r\n}\r\ni2s->phys_base = i2s->mem->start;\r\ni2s->clk_aic = clk_get(&pdev->dev, "aic");\r\nif (IS_ERR(i2s->clk_aic)) {\r\nret = PTR_ERR(i2s->clk_aic);\r\ngoto err_iounmap;\r\n}\r\ni2s->clk_i2s = clk_get(&pdev->dev, "i2s");\r\nif (IS_ERR(i2s->clk_i2s)) {\r\nret = PTR_ERR(i2s->clk_i2s);\r\ngoto err_clk_put_aic;\r\n}\r\nplatform_set_drvdata(pdev, i2s);\r\nret = snd_soc_register_dai(&pdev->dev, &jz4740_i2s_dai);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to register DAI\n");\r\ngoto err_clk_put_i2s;\r\n}\r\nreturn 0;\r\nerr_clk_put_i2s:\r\nclk_put(i2s->clk_i2s);\r\nerr_clk_put_aic:\r\nclk_put(i2s->clk_aic);\r\nerr_iounmap:\r\niounmap(i2s->base);\r\nerr_release_mem_region:\r\nrelease_mem_region(i2s->mem->start, resource_size(i2s->mem));\r\nerr_free:\r\nkfree(i2s);\r\nreturn ret;\r\n}\r\nstatic int __devexit jz4740_i2s_dev_remove(struct platform_device *pdev)\r\n{\r\nstruct jz4740_i2s *i2s = platform_get_drvdata(pdev);\r\nsnd_soc_unregister_dai(&pdev->dev);\r\nclk_put(i2s->clk_i2s);\r\nclk_put(i2s->clk_aic);\r\niounmap(i2s->base);\r\nrelease_mem_region(i2s->mem->start, resource_size(i2s->mem));\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(i2s);\r\nreturn 0;\r\n}\r\nstatic int __init jz4740_i2s_init(void)\r\n{\r\nreturn platform_driver_register(&jz4740_i2s_driver);\r\n}\r\nstatic void __exit jz4740_i2s_exit(void)\r\n{\r\nplatform_driver_unregister(&jz4740_i2s_driver);\r\n}

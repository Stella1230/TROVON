static int isight_firmware_load(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_device *dev = interface_to_usbdev(intf);\r\nint llen, len, req, ret = 0;\r\nconst struct firmware *firmware;\r\nunsigned char *buf = kmalloc(50, GFP_KERNEL);\r\nunsigned char data[4];\r\nconst u8 *ptr;\r\nif (!buf)\r\nreturn -ENOMEM;\r\nif (request_firmware(&firmware, "isight.fw", &dev->dev) != 0) {\r\nprintk(KERN_ERR "Unable to load isight firmware\n");\r\nret = -ENODEV;\r\ngoto out;\r\n}\r\nptr = firmware->data;\r\nif (usb_control_msg\r\n(dev, usb_sndctrlpipe(dev, 0), 0xa0, 0x40, 0xe600, 0, "\1", 1,\r\n300) != 1) {\r\nprintk(KERN_ERR\r\n"Failed to initialise isight firmware loader\n");\r\nret = -ENODEV;\r\ngoto out;\r\n}\r\nwhile (ptr+4 <= firmware->data+firmware->size) {\r\nmemcpy(data, ptr, 4);\r\nlen = (data[0] << 8 | data[1]);\r\nreq = (data[2] << 8 | data[3]);\r\nptr += 4;\r\nif (len == 0x8001)\r\nbreak;\r\nelse if (len == 0)\r\ncontinue;\r\nfor (; len > 0; req += 50) {\r\nllen = min(len, 50);\r\nlen -= llen;\r\nif (ptr+llen > firmware->data+firmware->size) {\r\nprintk(KERN_ERR\r\n"Malformed isight firmware");\r\nret = -ENODEV;\r\ngoto out;\r\n}\r\nmemcpy(buf, ptr, llen);\r\nptr += llen;\r\nif (usb_control_msg\r\n(dev, usb_sndctrlpipe(dev, 0), 0xa0, 0x40, req, 0,\r\nbuf, llen, 300) != llen) {\r\nprintk(KERN_ERR\r\n"Failed to load isight firmware\n");\r\nret = -ENODEV;\r\ngoto out;\r\n}\r\n}\r\n}\r\nif (usb_control_msg\r\n(dev, usb_sndctrlpipe(dev, 0), 0xa0, 0x40, 0xe600, 0, "\0", 1,\r\n300) != 1) {\r\nprintk(KERN_ERR "isight firmware loading completion failed\n");\r\nret = -ENODEV;\r\n}\r\nout:\r\nkfree(buf);\r\nrelease_firmware(firmware);\r\nreturn ret;\r\n}\r\nstatic void isight_firmware_disconnect(struct usb_interface *intf)\r\n{\r\n}\r\nstatic int __init isight_firmware_init(void)\r\n{\r\nreturn usb_register(&isight_firmware_driver);\r\n}\r\nstatic void __exit isight_firmware_exit(void)\r\n{\r\nusb_deregister(&isight_firmware_driver);\r\n}

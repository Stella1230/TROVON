int ircomm_param_request(struct ircomm_tty_cb *self, __u8 pi, int flush)\r\n{\r\nstruct tty_struct *tty;\r\nunsigned long flags;\r\nstruct sk_buff *skb;\r\nint count;\r\nIRDA_DEBUG(2, "%s()\n", __func__ );\r\nIRDA_ASSERT(self != NULL, return -1;);\r\nIRDA_ASSERT(self->magic == IRCOMM_TTY_MAGIC, return -1;);\r\ntty = self->tty;\r\nif (!tty)\r\nreturn 0;\r\nif (self->service_type == IRCOMM_3_WIRE_RAW)\r\nreturn 0;\r\nspin_lock_irqsave(&self->spinlock, flags);\r\nskb = self->ctrl_skb;\r\nif (!skb) {\r\nskb = alloc_skb(256, GFP_ATOMIC);\r\nif (!skb) {\r\nspin_unlock_irqrestore(&self->spinlock, flags);\r\nreturn -ENOMEM;\r\n}\r\nskb_reserve(skb, self->max_header_size);\r\nself->ctrl_skb = skb;\r\n}\r\ncount = irda_param_insert(self, pi, skb_tail_pointer(skb),\r\nskb_tailroom(skb), &ircomm_param_info);\r\nif (count < 0) {\r\nIRDA_WARNING("%s(), no room for parameter!\n", __func__);\r\nspin_unlock_irqrestore(&self->spinlock, flags);\r\nreturn -1;\r\n}\r\nskb_put(skb, count);\r\nspin_unlock_irqrestore(&self->spinlock, flags);\r\nIRDA_DEBUG(2, "%s(), skb->len=%d\n", __func__ , skb->len);\r\nif (flush) {\r\nschedule_work(&self->tqueue);\r\n}\r\nreturn count;\r\n}\r\nstatic int ircomm_param_service_type(void *instance, irda_param_t *param,\r\nint get)\r\n{\r\nstruct ircomm_tty_cb *self = (struct ircomm_tty_cb *) instance;\r\n__u8 service_type = (__u8) param->pv.i;\r\nIRDA_ASSERT(self != NULL, return -1;);\r\nIRDA_ASSERT(self->magic == IRCOMM_TTY_MAGIC, return -1;);\r\nif (get) {\r\nparam->pv.i = self->settings.service_type;\r\nreturn 0;\r\n}\r\nservice_type &= self->service_type;\r\nif (!service_type) {\r\nIRDA_DEBUG(2,\r\n"%s(), No common service type to use!\n", __func__ );\r\nreturn -1;\r\n}\r\nIRDA_DEBUG(0, "%s(), services in common=%02x\n", __func__ ,\r\nservice_type);\r\nif (service_type & IRCOMM_CENTRONICS)\r\nself->settings.service_type = IRCOMM_CENTRONICS;\r\nelse if (service_type & IRCOMM_9_WIRE)\r\nself->settings.service_type = IRCOMM_9_WIRE;\r\nelse if (service_type & IRCOMM_3_WIRE)\r\nself->settings.service_type = IRCOMM_3_WIRE;\r\nelse if (service_type & IRCOMM_3_WIRE_RAW)\r\nself->settings.service_type = IRCOMM_3_WIRE_RAW;\r\nIRDA_DEBUG(0, "%s(), resulting service type=0x%02x\n", __func__ ,\r\nself->settings.service_type);\r\nif ((self->max_header_size != IRCOMM_TTY_HDR_UNINITIALISED) &&\r\n(!self->client) &&\r\n(self->settings.service_type != IRCOMM_3_WIRE_RAW))\r\n{\r\nircomm_tty_send_initial_parameters(self);\r\nircomm_tty_link_established(self);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ircomm_param_port_type(void *instance, irda_param_t *param, int get)\r\n{\r\nstruct ircomm_tty_cb *self = (struct ircomm_tty_cb *) instance;\r\nIRDA_ASSERT(self != NULL, return -1;);\r\nIRDA_ASSERT(self->magic == IRCOMM_TTY_MAGIC, return -1;);\r\nif (get)\r\nparam->pv.i = IRCOMM_SERIAL;\r\nelse {\r\nself->settings.port_type = (__u8) param->pv.i;\r\nIRDA_DEBUG(0, "%s(), port type=%d\n", __func__ ,\r\nself->settings.port_type);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ircomm_param_port_name(void *instance, irda_param_t *param, int get)\r\n{\r\nstruct ircomm_tty_cb *self = (struct ircomm_tty_cb *) instance;\r\nIRDA_ASSERT(self != NULL, return -1;);\r\nIRDA_ASSERT(self->magic == IRCOMM_TTY_MAGIC, return -1;);\r\nif (get) {\r\nIRDA_DEBUG(0, "%s(), not imp!\n", __func__ );\r\n} else {\r\nIRDA_DEBUG(0, "%s(), port-name=%s\n", __func__ , param->pv.c);\r\nstrncpy(self->settings.port_name, param->pv.c, 32);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ircomm_param_data_rate(void *instance, irda_param_t *param, int get)\r\n{\r\nstruct ircomm_tty_cb *self = (struct ircomm_tty_cb *) instance;\r\nIRDA_ASSERT(self != NULL, return -1;);\r\nIRDA_ASSERT(self->magic == IRCOMM_TTY_MAGIC, return -1;);\r\nif (get)\r\nparam->pv.i = self->settings.data_rate;\r\nelse\r\nself->settings.data_rate = param->pv.i;\r\nIRDA_DEBUG(2, "%s(), data rate = %d\n", __func__ , param->pv.i);\r\nreturn 0;\r\n}\r\nstatic int ircomm_param_data_format(void *instance, irda_param_t *param,\r\nint get)\r\n{\r\nstruct ircomm_tty_cb *self = (struct ircomm_tty_cb *) instance;\r\nIRDA_ASSERT(self != NULL, return -1;);\r\nIRDA_ASSERT(self->magic == IRCOMM_TTY_MAGIC, return -1;);\r\nif (get)\r\nparam->pv.i = self->settings.data_format;\r\nelse\r\nself->settings.data_format = (__u8) param->pv.i;\r\nreturn 0;\r\n}\r\nstatic int ircomm_param_flow_control(void *instance, irda_param_t *param,\r\nint get)\r\n{\r\nstruct ircomm_tty_cb *self = (struct ircomm_tty_cb *) instance;\r\nIRDA_ASSERT(self != NULL, return -1;);\r\nIRDA_ASSERT(self->magic == IRCOMM_TTY_MAGIC, return -1;);\r\nif (get)\r\nparam->pv.i = self->settings.flow_control;\r\nelse\r\nself->settings.flow_control = (__u8) param->pv.i;\r\nIRDA_DEBUG(1, "%s(), flow control = 0x%02x\n", __func__ , (__u8) param->pv.i);\r\nreturn 0;\r\n}\r\nstatic int ircomm_param_xon_xoff(void *instance, irda_param_t *param, int get)\r\n{\r\nstruct ircomm_tty_cb *self = (struct ircomm_tty_cb *) instance;\r\nIRDA_ASSERT(self != NULL, return -1;);\r\nIRDA_ASSERT(self->magic == IRCOMM_TTY_MAGIC, return -1;);\r\nif (get) {\r\nparam->pv.i = self->settings.xonxoff[0];\r\nparam->pv.i |= self->settings.xonxoff[1] << 8;\r\n} else {\r\nself->settings.xonxoff[0] = (__u16) param->pv.i & 0xff;\r\nself->settings.xonxoff[1] = (__u16) param->pv.i >> 8;\r\n}\r\nIRDA_DEBUG(0, "%s(), XON/XOFF = 0x%02x,0x%02x\n", __func__ ,\r\nparam->pv.i & 0xff, param->pv.i >> 8);\r\nreturn 0;\r\n}\r\nstatic int ircomm_param_enq_ack(void *instance, irda_param_t *param, int get)\r\n{\r\nstruct ircomm_tty_cb *self = (struct ircomm_tty_cb *) instance;\r\nIRDA_ASSERT(self != NULL, return -1;);\r\nIRDA_ASSERT(self->magic == IRCOMM_TTY_MAGIC, return -1;);\r\nif (get) {\r\nparam->pv.i = self->settings.enqack[0];\r\nparam->pv.i |= self->settings.enqack[1] << 8;\r\n} else {\r\nself->settings.enqack[0] = (__u16) param->pv.i & 0xff;\r\nself->settings.enqack[1] = (__u16) param->pv.i >> 8;\r\n}\r\nIRDA_DEBUG(0, "%s(), ENQ/ACK = 0x%02x,0x%02x\n", __func__ ,\r\nparam->pv.i & 0xff, param->pv.i >> 8);\r\nreturn 0;\r\n}\r\nstatic int ircomm_param_line_status(void *instance, irda_param_t *param,\r\nint get)\r\n{\r\nIRDA_DEBUG(2, "%s(), not impl.\n", __func__ );\r\nreturn 0;\r\n}\r\nstatic int ircomm_param_dte(void *instance, irda_param_t *param, int get)\r\n{\r\nstruct ircomm_tty_cb *self = (struct ircomm_tty_cb *) instance;\r\n__u8 dte;\r\nIRDA_ASSERT(self != NULL, return -1;);\r\nIRDA_ASSERT(self->magic == IRCOMM_TTY_MAGIC, return -1;);\r\nif (get)\r\nparam->pv.i = self->settings.dte;\r\nelse {\r\ndte = (__u8) param->pv.i;\r\nself->settings.dce = 0;\r\nif (dte & IRCOMM_DELTA_DTR)\r\nself->settings.dce |= (IRCOMM_DELTA_DSR|\r\nIRCOMM_DELTA_RI |\r\nIRCOMM_DELTA_CD);\r\nif (dte & IRCOMM_DTR)\r\nself->settings.dce |= (IRCOMM_DSR|\r\nIRCOMM_RI |\r\nIRCOMM_CD);\r\nif (dte & IRCOMM_DELTA_RTS)\r\nself->settings.dce |= IRCOMM_DELTA_CTS;\r\nif (dte & IRCOMM_RTS)\r\nself->settings.dce |= IRCOMM_CTS;\r\nircomm_tty_check_modem_status(self);\r\nself->settings.null_modem = TRUE;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ircomm_param_dce(void *instance, irda_param_t *param, int get)\r\n{\r\nstruct ircomm_tty_cb *self = (struct ircomm_tty_cb *) instance;\r\n__u8 dce;\r\nIRDA_DEBUG(1, "%s(), dce = 0x%02x\n", __func__ , (__u8) param->pv.i);\r\ndce = (__u8) param->pv.i;\r\nIRDA_ASSERT(self != NULL, return -1;);\r\nIRDA_ASSERT(self->magic == IRCOMM_TTY_MAGIC, return -1;);\r\nself->settings.dce = dce;\r\nif (dce & 0x0f) {\r\nif (dce & IRCOMM_DELTA_CTS) {\r\nIRDA_DEBUG(2, "%s(), CTS\n", __func__ );\r\n}\r\n}\r\nircomm_tty_check_modem_status(self);\r\nreturn 0;\r\n}\r\nstatic int ircomm_param_poll(void *instance, irda_param_t *param, int get)\r\n{\r\nstruct ircomm_tty_cb *self = (struct ircomm_tty_cb *) instance;\r\nIRDA_ASSERT(self != NULL, return -1;);\r\nIRDA_ASSERT(self->magic == IRCOMM_TTY_MAGIC, return -1;);\r\nif (!get) {\r\nircomm_param_request(self, IRCOMM_DTE, TRUE);\r\n}\r\nreturn 0;\r\n}

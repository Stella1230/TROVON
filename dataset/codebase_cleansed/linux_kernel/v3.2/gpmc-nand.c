static int omap2_nand_gpmc_retime(struct omap_nand_platform_data *gpmc_nand_data)\r\n{\r\nstruct gpmc_timings t;\r\nint err;\r\nif (!gpmc_nand_data->gpmc_t)\r\nreturn 0;\r\nmemset(&t, 0, sizeof(t));\r\nt.sync_clk = gpmc_nand_data->gpmc_t->sync_clk;\r\nt.cs_on = gpmc_round_ns_to_ticks(gpmc_nand_data->gpmc_t->cs_on);\r\nt.adv_on = gpmc_round_ns_to_ticks(gpmc_nand_data->gpmc_t->adv_on);\r\nt.adv_rd_off = gpmc_round_ns_to_ticks(\r\ngpmc_nand_data->gpmc_t->adv_rd_off);\r\nt.oe_on = t.adv_on;\r\nt.access = gpmc_round_ns_to_ticks(gpmc_nand_data->gpmc_t->access);\r\nt.oe_off = gpmc_round_ns_to_ticks(gpmc_nand_data->gpmc_t->oe_off);\r\nt.cs_rd_off = gpmc_round_ns_to_ticks(gpmc_nand_data->gpmc_t->cs_rd_off);\r\nt.rd_cycle = gpmc_round_ns_to_ticks(gpmc_nand_data->gpmc_t->rd_cycle);\r\nt.adv_wr_off = gpmc_round_ns_to_ticks(\r\ngpmc_nand_data->gpmc_t->adv_wr_off);\r\nt.we_on = t.oe_on;\r\nif (cpu_is_omap34xx()) {\r\nt.wr_data_mux_bus = gpmc_round_ns_to_ticks(\r\ngpmc_nand_data->gpmc_t->wr_data_mux_bus);\r\nt.wr_access = gpmc_round_ns_to_ticks(\r\ngpmc_nand_data->gpmc_t->wr_access);\r\n}\r\nt.we_off = gpmc_round_ns_to_ticks(gpmc_nand_data->gpmc_t->we_off);\r\nt.cs_wr_off = gpmc_round_ns_to_ticks(gpmc_nand_data->gpmc_t->cs_wr_off);\r\nt.wr_cycle = gpmc_round_ns_to_ticks(gpmc_nand_data->gpmc_t->wr_cycle);\r\nif (gpmc_nand_data->devsize == NAND_BUSWIDTH_16)\r\ngpmc_cs_configure(gpmc_nand_data->cs, GPMC_CONFIG_DEV_SIZE, 1);\r\nelse\r\ngpmc_cs_configure(gpmc_nand_data->cs, GPMC_CONFIG_DEV_SIZE, 0);\r\ngpmc_cs_configure(gpmc_nand_data->cs,\r\nGPMC_CONFIG_DEV_TYPE, GPMC_DEVICETYPE_NAND);\r\nerr = gpmc_cs_set_timings(gpmc_nand_data->cs, &t);\r\nif (err)\r\nreturn err;\r\nreturn 0;\r\n}\r\nint __init gpmc_nand_init(struct omap_nand_platform_data *gpmc_nand_data)\r\n{\r\nint err = 0;\r\nstruct device *dev = &gpmc_nand_device.dev;\r\ngpmc_nand_device.dev.platform_data = gpmc_nand_data;\r\nerr = gpmc_cs_request(gpmc_nand_data->cs, NAND_IO_SIZE,\r\n&gpmc_nand_data->phys_base);\r\nif (err < 0) {\r\ndev_err(dev, "Cannot request GPMC CS\n");\r\nreturn err;\r\n}\r\nerr = omap2_nand_gpmc_retime(gpmc_nand_data);\r\nif (err < 0) {\r\ndev_err(dev, "Unable to set gpmc timings: %d\n", err);\r\nreturn err;\r\n}\r\nif (gpmc_nand_data->dev_ready) {\r\ngpmc_cs_configure(gpmc_nand_data->cs, GPMC_CONFIG_RDY_BSY, 1);\r\n}\r\nerr = platform_device_register(&gpmc_nand_device);\r\nif (err < 0) {\r\ndev_err(dev, "Unable to register NAND device\n");\r\ngoto out_free_cs;\r\n}\r\nreturn 0;\r\nout_free_cs:\r\ngpmc_cs_free(gpmc_nand_data->cs);\r\nreturn err;\r\n}

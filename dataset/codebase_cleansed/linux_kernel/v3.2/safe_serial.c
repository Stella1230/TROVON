static __u16 __inline__ fcs_compute10(unsigned char *sp, int len, __u16 fcs)\r\n{\r\nfor (; len-- > 0; fcs = CRC10_FCS(fcs, *sp++));\r\nreturn fcs;\r\n}\r\nstatic void safe_process_read_urb(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nunsigned char *data = urb->transfer_buffer;\r\nunsigned char length = urb->actual_length;\r\nint actual_length;\r\nstruct tty_struct *tty;\r\n__u16 fcs;\r\nif (!length)\r\nreturn;\r\ntty = tty_port_tty_get(&port->port);\r\nif (!tty)\r\nreturn;\r\nif (!safe)\r\ngoto out;\r\nfcs = fcs_compute10(data, length, CRC10_INITFCS);\r\nif (fcs) {\r\ndev_err(&port->dev, "%s - bad CRC %x\n", __func__, fcs);\r\ngoto err;\r\n}\r\nactual_length = data[length - 2] >> 2;\r\nif (actual_length > (length - 2)) {\r\ndev_err(&port->dev, "%s - inconsistent lengths %d:%d\n",\r\n__func__, actual_length, length);\r\ngoto err;\r\n}\r\ndev_info(&urb->dev->dev, "%s - actual: %d\n", __func__, actual_length);\r\nlength = actual_length;\r\nout:\r\ntty_insert_flip_string(tty, data, length);\r\ntty_flip_buffer_push(tty);\r\nerr:\r\ntty_kref_put(tty);\r\n}\r\nstatic int safe_prepare_write_buffer(struct usb_serial_port *port,\r\nvoid *dest, size_t size)\r\n{\r\nunsigned char *buf = dest;\r\nint count;\r\nint trailer_len;\r\nint pkt_len;\r\n__u16 fcs;\r\ntrailer_len = safe ? 2 : 0;\r\ncount = kfifo_out_locked(&port->write_fifo, buf, size - trailer_len,\r\n&port->lock);\r\nif (!safe)\r\nreturn count;\r\nif (padded) {\r\npkt_len = size;\r\nmemset(buf + count, '0', pkt_len - count - trailer_len);\r\n} else {\r\npkt_len = count + trailer_len;\r\n}\r\nbuf[pkt_len - 2] = count << 2;\r\nbuf[pkt_len - 1] = 0;\r\nfcs = fcs_compute10(buf, pkt_len, CRC10_INITFCS);\r\nbuf[pkt_len - 2] |= fcs >> 8;\r\nbuf[pkt_len - 1] |= fcs & 0xff;\r\nreturn pkt_len;\r\n}\r\nstatic int safe_startup(struct usb_serial *serial)\r\n{\r\nswitch (serial->interface->cur_altsetting->desc.bInterfaceProtocol) {\r\ncase LINEO_SAFESERIAL_CRC:\r\nbreak;\r\ncase LINEO_SAFESERIAL_CRC_PADDED:\r\npadded = 1;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init safe_init(void)\r\n{\r\nint i, retval;\r\nprintk(KERN_INFO KBUILD_MODNAME ": " DRIVER_VERSION ":"\r\nDRIVER_DESC "\n");\r\nif (vendor || product) {\r\nprintk(KERN_INFO KBUILD_MODNAME ": vendor: %x product: %x\n",\r\nvendor, product);\r\nfor (i = 0; i < ARRAY_SIZE(id_table); i++) {\r\nif (!id_table[i].idVendor && !id_table[i].idProduct) {\r\nid_table[i].idVendor = vendor;\r\nid_table[i].idProduct = product;\r\nbreak;\r\n}\r\n}\r\n}\r\nretval = usb_serial_register(&safe_device);\r\nif (retval)\r\ngoto failed_usb_serial_register;\r\nretval = usb_register(&safe_driver);\r\nif (retval)\r\ngoto failed_usb_register;\r\nreturn 0;\r\nfailed_usb_register:\r\nusb_serial_deregister(&safe_device);\r\nfailed_usb_serial_register:\r\nreturn retval;\r\n}\r\nstatic void __exit safe_exit(void)\r\n{\r\nusb_deregister(&safe_driver);\r\nusb_serial_deregister(&safe_device);\r\n}

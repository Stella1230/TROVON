static int __init wanrouter_init(void)\r\n{\r\nint err;\r\nprintk(KERN_INFO "%s v%u.%u %s\n",\r\nwanrouter_fullname, ROUTER_VERSION, ROUTER_RELEASE,\r\nwanrouter_copyright);\r\nerr = wanrouter_proc_init();\r\nif (err)\r\nprintk(KERN_INFO "%s: can't create entry in proc filesystem!\n",\r\nwanrouter_modname);\r\nreturn err;\r\n}\r\nstatic void __exit wanrouter_cleanup (void)\r\n{\r\nwanrouter_proc_cleanup();\r\n}\r\nint register_wan_device(struct wan_device *wandev)\r\n{\r\nint err, namelen;\r\nif ((wandev == NULL) || (wandev->magic != ROUTER_MAGIC) ||\r\n(wandev->name == NULL))\r\nreturn -EINVAL;\r\nnamelen = strlen(wandev->name);\r\nif (!namelen || (namelen > WAN_DRVNAME_SZ))\r\nreturn -EINVAL;\r\nif (wanrouter_find_device(wandev->name))\r\nreturn -EEXIST;\r\n#ifdef WANDEBUG\r\nprintk(KERN_INFO "%s: registering WAN device %s\n",\r\nwanrouter_modname, wandev->name);\r\n#endif\r\nerr = wanrouter_proc_add(wandev);\r\nif (err) {\r\nprintk(KERN_INFO\r\n"%s: can't create /proc/net/router/%s entry!\n",\r\nwanrouter_modname, wandev->name);\r\nreturn err;\r\n}\r\nwandev->ndev = 0;\r\nwandev->dev = NULL;\r\nwandev->next = wanrouter_router_devlist;\r\nwanrouter_router_devlist = wandev;\r\nreturn 0;\r\n}\r\nint unregister_wan_device(char *name)\r\n{\r\nstruct wan_device *wandev, *prev;\r\nif (name == NULL)\r\nreturn -EINVAL;\r\nfor (wandev = wanrouter_router_devlist, prev = NULL;\r\nwandev && strcmp(wandev->name, name);\r\nprev = wandev, wandev = wandev->next)\r\n;\r\nif (wandev == NULL)\r\nreturn -ENODEV;\r\n#ifdef WANDEBUG\r\nprintk(KERN_INFO "%s: unregistering WAN device %s\n",\r\nwanrouter_modname, name);\r\n#endif\r\nif (wandev->state != WAN_UNCONFIGURED)\r\nwanrouter_device_shutdown(wandev);\r\nif (prev)\r\nprev->next = wandev->next;\r\nelse\r\nwanrouter_router_devlist = wandev->next;\r\nwanrouter_proc_delete(wandev);\r\nreturn 0;\r\n}\r\nlong wanrouter_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nstruct inode *inode = file->f_path.dentry->d_inode;\r\nint err = 0;\r\nstruct proc_dir_entry *dent;\r\nstruct wan_device *wandev;\r\nvoid __user *data = (void __user *)arg;\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nif ((cmd >> 8) != ROUTER_IOCTL)\r\nreturn -EINVAL;\r\ndent = PDE(inode);\r\nif ((dent == NULL) || (dent->data == NULL))\r\nreturn -EINVAL;\r\nwandev = dent->data;\r\nif (wandev->magic != ROUTER_MAGIC)\r\nreturn -EINVAL;\r\nmutex_lock(&wanrouter_mutex);\r\nswitch (cmd) {\r\ncase ROUTER_SETUP:\r\nerr = wanrouter_device_setup(wandev, data);\r\nbreak;\r\ncase ROUTER_DOWN:\r\nerr = wanrouter_device_shutdown(wandev);\r\nbreak;\r\ncase ROUTER_STAT:\r\nerr = wanrouter_device_stat(wandev, data);\r\nbreak;\r\ncase ROUTER_IFNEW:\r\nerr = wanrouter_device_new_if(wandev, data);\r\nbreak;\r\ncase ROUTER_IFDEL:\r\nerr = wanrouter_device_del_if(wandev, data);\r\nbreak;\r\ncase ROUTER_IFSTAT:\r\nbreak;\r\ndefault:\r\nif ((cmd >= ROUTER_USER) &&\r\n(cmd <= ROUTER_USER_MAX) &&\r\nwandev->ioctl)\r\nerr = wandev->ioctl(wandev, cmd, arg);\r\nelse err = -EINVAL;\r\n}\r\nmutex_unlock(&wanrouter_mutex);\r\nreturn err;\r\n}\r\nstatic int wanrouter_device_setup(struct wan_device *wandev,\r\nwandev_conf_t __user *u_conf)\r\n{\r\nvoid *data = NULL;\r\nwandev_conf_t *conf;\r\nint err = -EINVAL;\r\nif (wandev->setup == NULL) {\r\nprintk(KERN_INFO "%s: ERROR, No setup script: wandev->setup()\n",\r\nwandev->name);\r\nreturn 0;\r\n}\r\nconf = kmalloc(sizeof(wandev_conf_t), GFP_KERNEL);\r\nif (conf == NULL){\r\nprintk(KERN_INFO "%s: ERROR, Failed to allocate kernel memory !\n",\r\nwandev->name);\r\nreturn -ENOBUFS;\r\n}\r\nif (copy_from_user(conf, u_conf, sizeof(wandev_conf_t))) {\r\nprintk(KERN_INFO "%s: Failed to copy user config data to kernel space!\n",\r\nwandev->name);\r\nkfree(conf);\r\nreturn -EFAULT;\r\n}\r\nif (conf->magic != ROUTER_MAGIC) {\r\nkfree(conf);\r\nprintk(KERN_INFO "%s: ERROR, Invalid MAGIC Number\n",\r\nwandev->name);\r\nreturn -EINVAL;\r\n}\r\nif (conf->data_size && conf->data) {\r\nif (conf->data_size > 128000) {\r\nprintk(KERN_INFO\r\n"%s: ERROR, Invalid firmware data size %i !\n",\r\nwandev->name, conf->data_size);\r\nkfree(conf);\r\nreturn -EINVAL;\r\n}\r\ndata = vmalloc(conf->data_size);\r\nif (!data) {\r\nprintk(KERN_INFO\r\n"%s: ERROR, Failed allocate kernel memory !\n",\r\nwandev->name);\r\nkfree(conf);\r\nreturn -ENOBUFS;\r\n}\r\nif (!copy_from_user(data, conf->data, conf->data_size)) {\r\nconf->data = data;\r\nerr = wandev->setup(wandev, conf);\r\n} else {\r\nprintk(KERN_INFO\r\n"%s: ERROR, Failed to copy from user data !\n",\r\nwandev->name);\r\nerr = -EFAULT;\r\n}\r\nvfree(data);\r\n} else {\r\nprintk(KERN_INFO\r\n"%s: ERROR, No firmware found ! Firmware size = %i !\n",\r\nwandev->name, conf->data_size);\r\n}\r\nkfree(conf);\r\nreturn err;\r\n}\r\nstatic int wanrouter_device_shutdown(struct wan_device *wandev)\r\n{\r\nstruct net_device *dev;\r\nint err=0;\r\nif (wandev->state == WAN_UNCONFIGURED)\r\nreturn 0;\r\nprintk(KERN_INFO "\n%s: Shutting Down!\n",wandev->name);\r\nfor (dev = wandev->dev; dev;) {\r\nerr = wanrouter_delete_interface(wandev, dev->name);\r\nif (err)\r\nreturn err;\r\ndev = wandev->dev;\r\n}\r\nif (wandev->ndev)\r\nreturn -EBUSY;\r\nif (wandev->shutdown)\r\nerr=wandev->shutdown(wandev);\r\nreturn err;\r\n}\r\nstatic int wanrouter_device_stat(struct wan_device *wandev,\r\nwandev_stat_t __user *u_stat)\r\n{\r\nwandev_stat_t stat;\r\nmemset(&stat, 0, sizeof(stat));\r\nif ((wandev->state != WAN_UNCONFIGURED) && wandev->update)\r\nwandev->update(wandev);\r\nstat.ndev = wandev->ndev;\r\nstat.state = wandev->state;\r\nif (copy_to_user(u_stat, &stat, sizeof(stat)))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nstatic int wanrouter_device_new_if(struct wan_device *wandev,\r\nwanif_conf_t __user *u_conf)\r\n{\r\nwanif_conf_t *cnf;\r\nstruct net_device *dev = NULL;\r\nint err;\r\nif ((wandev->state == WAN_UNCONFIGURED) || (wandev->new_if == NULL))\r\nreturn -ENODEV;\r\ncnf = kmalloc(sizeof(wanif_conf_t), GFP_KERNEL);\r\nif (!cnf)\r\nreturn -ENOBUFS;\r\nerr = -EFAULT;\r\nif (copy_from_user(cnf, u_conf, sizeof(wanif_conf_t)))\r\ngoto out;\r\nerr = -EINVAL;\r\nif (cnf->magic != ROUTER_MAGIC)\r\ngoto out;\r\nif (cnf->config_id == WANCONFIG_MPPP) {\r\nprintk(KERN_INFO "%s: Wanpipe Mulit-Port PPP support has not been compiled in!\n",\r\nwandev->name);\r\nerr = -EPROTONOSUPPORT;\r\ngoto out;\r\n} else {\r\nerr = wandev->new_if(wandev, dev, cnf);\r\n}\r\nif (!err) {\r\nif (dev->name == NULL) {\r\nerr = -EINVAL;\r\n} else {\r\n#ifdef WANDEBUG\r\nprintk(KERN_INFO "%s: registering interface %s...\n",\r\nwanrouter_modname, dev->name);\r\n#endif\r\nerr = register_netdev(dev);\r\nif (!err) {\r\nstruct net_device *slave = NULL;\r\nunsigned long smp_flags=0;\r\nlock_adapter_irq(&wandev->lock, &smp_flags);\r\nif (wandev->dev == NULL) {\r\nwandev->dev = dev;\r\n} else {\r\nfor (slave=wandev->dev;\r\nDEV_TO_SLAVE(slave);\r\nslave = DEV_TO_SLAVE(slave))\r\nDEV_TO_SLAVE(slave) = dev;\r\n}\r\n++wandev->ndev;\r\nunlock_adapter_irq(&wandev->lock, &smp_flags);\r\nerr = 0;\r\ngoto out;\r\n}\r\n}\r\nif (wandev->del_if)\r\nwandev->del_if(wandev, dev);\r\nfree_netdev(dev);\r\n}\r\nout:\r\nkfree(cnf);\r\nreturn err;\r\n}\r\nstatic int wanrouter_device_del_if(struct wan_device *wandev, char __user *u_name)\r\n{\r\nchar name[WAN_IFNAME_SZ + 1];\r\nint err = 0;\r\nif (wandev->state == WAN_UNCONFIGURED)\r\nreturn -ENODEV;\r\nmemset(name, 0, sizeof(name));\r\nif (copy_from_user(name, u_name, WAN_IFNAME_SZ))\r\nreturn -EFAULT;\r\nerr = wanrouter_delete_interface(wandev, name);\r\nif (err)\r\nreturn err;\r\nif (!wandev->ndev && wandev->shutdown)\r\nerr = wandev->shutdown(wandev);\r\nreturn err;\r\n}\r\nstatic struct wan_device *wanrouter_find_device(char *name)\r\n{\r\nstruct wan_device *wandev;\r\nfor (wandev = wanrouter_router_devlist;\r\nwandev && strcmp(wandev->name, name);\r\nwandev = wandev->next);\r\nreturn wandev;\r\n}\r\nstatic int wanrouter_delete_interface(struct wan_device *wandev, char *name)\r\n{\r\nstruct net_device *dev = NULL, *prev = NULL;\r\nunsigned long smp_flags=0;\r\nlock_adapter_irq(&wandev->lock, &smp_flags);\r\ndev = wandev->dev;\r\nprev = NULL;\r\nwhile (dev && strcmp(name, dev->name)) {\r\nstruct net_device **slave = netdev_priv(dev);\r\nprev = dev;\r\ndev = *slave;\r\n}\r\nunlock_adapter_irq(&wandev->lock, &smp_flags);\r\nif (dev == NULL)\r\nreturn -ENODEV;\r\nif (netif_running(dev))\r\nreturn -EBUSY;\r\nif (wandev->del_if)\r\nwandev->del_if(wandev, dev);\r\nlock_adapter_irq(&wandev->lock, &smp_flags);\r\nif (prev) {\r\nstruct net_device **prev_slave = netdev_priv(prev);\r\nstruct net_device **slave = netdev_priv(dev);\r\n*prev_slave = *slave;\r\n} else {\r\nstruct net_device **slave = netdev_priv(dev);\r\nwandev->dev = *slave;\r\n}\r\n--wandev->ndev;\r\nunlock_adapter_irq(&wandev->lock, &smp_flags);\r\nprintk(KERN_INFO "%s: unregistering '%s'\n", wandev->name, dev->name);\r\nunregister_netdev(dev);\r\nfree_netdev(dev);\r\nreturn 0;\r\n}\r\nstatic void lock_adapter_irq(spinlock_t *lock, unsigned long *smp_flags)\r\n__acquires(lock)\r\n{\r\nspin_lock_irqsave(lock, *smp_flags);\r\n}\r\nstatic void unlock_adapter_irq(spinlock_t *lock, unsigned long *smp_flags)\r\n__releases(lock)\r\n{\r\nspin_unlock_irqrestore(lock, *smp_flags);\r\n}

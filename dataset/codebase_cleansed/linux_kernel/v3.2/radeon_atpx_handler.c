static int radeon_atrm_call(acpi_handle atrm_handle, uint8_t *bios,\r\nint offset, int len)\r\n{\r\nacpi_status status;\r\nunion acpi_object atrm_arg_elements[2], *obj;\r\nstruct acpi_object_list atrm_arg;\r\nstruct acpi_buffer buffer = { ACPI_ALLOCATE_BUFFER, NULL};\r\natrm_arg.count = 2;\r\natrm_arg.pointer = &atrm_arg_elements[0];\r\natrm_arg_elements[0].type = ACPI_TYPE_INTEGER;\r\natrm_arg_elements[0].integer.value = offset;\r\natrm_arg_elements[1].type = ACPI_TYPE_INTEGER;\r\natrm_arg_elements[1].integer.value = len;\r\nstatus = acpi_evaluate_object(atrm_handle, NULL, &atrm_arg, &buffer);\r\nif (ACPI_FAILURE(status)) {\r\nprintk("failed to evaluate ATRM got %s\n", acpi_format_exception(status));\r\nreturn -ENODEV;\r\n}\r\nobj = (union acpi_object *)buffer.pointer;\r\nmemcpy(bios+offset, obj->buffer.pointer, len);\r\nkfree(buffer.pointer);\r\nreturn len;\r\n}\r\nbool radeon_atrm_supported(struct pci_dev *pdev)\r\n{\r\nif (!radeon_atpx_priv.atpx_detected)\r\nreturn false;\r\nif (radeon_atpx_priv.dhandle == DEVICE_ACPI_HANDLE(&pdev->dev))\r\nreturn false;\r\nreturn true;\r\n}\r\nint radeon_atrm_get_bios_chunk(uint8_t *bios, int offset, int len)\r\n{\r\nreturn radeon_atrm_call(radeon_atpx_priv.atrm_handle, bios, offset, len);\r\n}\r\nstatic int radeon_atpx_get_version(acpi_handle handle)\r\n{\r\nacpi_status status;\r\nunion acpi_object atpx_arg_elements[2], *obj;\r\nstruct acpi_object_list atpx_arg;\r\nstruct acpi_buffer buffer = { ACPI_ALLOCATE_BUFFER, NULL };\r\natpx_arg.count = 2;\r\natpx_arg.pointer = &atpx_arg_elements[0];\r\natpx_arg_elements[0].type = ACPI_TYPE_INTEGER;\r\natpx_arg_elements[0].integer.value = ATPX_VERSION;\r\natpx_arg_elements[1].type = ACPI_TYPE_INTEGER;\r\natpx_arg_elements[1].integer.value = ATPX_VERSION;\r\nstatus = acpi_evaluate_object(handle, NULL, &atpx_arg, &buffer);\r\nif (ACPI_FAILURE(status)) {\r\nprintk("%s: failed to call ATPX: %s\n", __func__, acpi_format_exception(status));\r\nreturn -ENOSYS;\r\n}\r\nobj = (union acpi_object *)buffer.pointer;\r\nif (obj && (obj->type == ACPI_TYPE_BUFFER))\r\nprintk(KERN_INFO "radeon atpx: version is %d\n", *((u8 *)(obj->buffer.pointer) + 2));\r\nkfree(buffer.pointer);\r\nreturn 0;\r\n}\r\nstatic int radeon_atpx_execute(acpi_handle handle, int cmd_id, u16 value)\r\n{\r\nacpi_status status;\r\nunion acpi_object atpx_arg_elements[2];\r\nstruct acpi_object_list atpx_arg;\r\nstruct acpi_buffer buffer = { ACPI_ALLOCATE_BUFFER, NULL };\r\nuint8_t buf[4] = {0};\r\nif (!handle)\r\nreturn -EINVAL;\r\natpx_arg.count = 2;\r\natpx_arg.pointer = &atpx_arg_elements[0];\r\natpx_arg_elements[0].type = ACPI_TYPE_INTEGER;\r\natpx_arg_elements[0].integer.value = cmd_id;\r\nbuf[2] = value & 0xff;\r\nbuf[3] = (value >> 8) & 0xff;\r\natpx_arg_elements[1].type = ACPI_TYPE_BUFFER;\r\natpx_arg_elements[1].buffer.length = 4;\r\natpx_arg_elements[1].buffer.pointer = buf;\r\nstatus = acpi_evaluate_object(handle, NULL, &atpx_arg, &buffer);\r\nif (ACPI_FAILURE(status)) {\r\nprintk("%s: failed to call ATPX: %s\n", __func__, acpi_format_exception(status));\r\nreturn -ENOSYS;\r\n}\r\nkfree(buffer.pointer);\r\nreturn 0;\r\n}\r\nstatic int radeon_atpx_set_discrete_state(acpi_handle handle, int state)\r\n{\r\nreturn radeon_atpx_execute(handle, ATPX_GPU_PWR, state);\r\n}\r\nstatic int radeon_atpx_switch_mux(acpi_handle handle, int mux_id)\r\n{\r\nreturn radeon_atpx_execute(handle, ATPX_MUX_SELECT, mux_id);\r\n}\r\nstatic int radeon_atpx_switch_i2c_mux(acpi_handle handle, int mux_id)\r\n{\r\nreturn radeon_atpx_execute(handle, ATPX_I2C_MUX_SELECT, mux_id);\r\n}\r\nstatic int radeon_atpx_switch_start(acpi_handle handle, int gpu_id)\r\n{\r\nreturn radeon_atpx_execute(handle, ATPX_SWITCH_START, gpu_id);\r\n}\r\nstatic int radeon_atpx_switch_end(acpi_handle handle, int gpu_id)\r\n{\r\nreturn radeon_atpx_execute(handle, ATPX_SWITCH_END, gpu_id);\r\n}\r\nstatic int radeon_atpx_switchto(enum vga_switcheroo_client_id id)\r\n{\r\nint gpu_id;\r\nif (id == VGA_SWITCHEROO_IGD)\r\ngpu_id = ATPX_INTEGRATED;\r\nelse\r\ngpu_id = ATPX_DISCRETE;\r\nradeon_atpx_switch_start(radeon_atpx_priv.atpx_handle, gpu_id);\r\nradeon_atpx_switch_mux(radeon_atpx_priv.atpx_handle, gpu_id);\r\nradeon_atpx_switch_i2c_mux(radeon_atpx_priv.atpx_handle, gpu_id);\r\nradeon_atpx_switch_end(radeon_atpx_priv.atpx_handle, gpu_id);\r\nreturn 0;\r\n}\r\nstatic int radeon_atpx_power_state(enum vga_switcheroo_client_id id,\r\nenum vga_switcheroo_state state)\r\n{\r\nif (id == VGA_SWITCHEROO_IGD)\r\nreturn 0;\r\nradeon_atpx_set_discrete_state(radeon_atpx_priv.atpx_handle, state);\r\nreturn 0;\r\n}\r\nstatic bool radeon_atpx_pci_probe_handle(struct pci_dev *pdev)\r\n{\r\nacpi_handle dhandle, atpx_handle, atrm_handle;\r\nacpi_status status;\r\ndhandle = DEVICE_ACPI_HANDLE(&pdev->dev);\r\nif (!dhandle)\r\nreturn false;\r\nstatus = acpi_get_handle(dhandle, "ATPX", &atpx_handle);\r\nif (ACPI_FAILURE(status))\r\nreturn false;\r\nstatus = acpi_get_handle(dhandle, "ATRM", &atrm_handle);\r\nif (ACPI_FAILURE(status))\r\nreturn false;\r\nradeon_atpx_priv.dhandle = dhandle;\r\nradeon_atpx_priv.atpx_handle = atpx_handle;\r\nradeon_atpx_priv.atrm_handle = atrm_handle;\r\nreturn true;\r\n}\r\nstatic int radeon_atpx_init(void)\r\n{\r\nradeon_atpx_get_version(radeon_atpx_priv.atpx_handle);\r\nreturn 0;\r\n}\r\nstatic int radeon_atpx_get_client_id(struct pci_dev *pdev)\r\n{\r\nif (radeon_atpx_priv.dhandle == DEVICE_ACPI_HANDLE(&pdev->dev))\r\nreturn VGA_SWITCHEROO_IGD;\r\nelse\r\nreturn VGA_SWITCHEROO_DIS;\r\n}\r\nstatic bool radeon_atpx_detect(void)\r\n{\r\nchar acpi_method_name[255] = { 0 };\r\nstruct acpi_buffer buffer = {sizeof(acpi_method_name), acpi_method_name};\r\nstruct pci_dev *pdev = NULL;\r\nbool has_atpx = false;\r\nint vga_count = 0;\r\nwhile ((pdev = pci_get_class(PCI_CLASS_DISPLAY_VGA << 8, pdev)) != NULL) {\r\nvga_count++;\r\nhas_atpx |= (radeon_atpx_pci_probe_handle(pdev) == true);\r\n}\r\nif (has_atpx && vga_count == 2) {\r\nacpi_get_name(radeon_atpx_priv.atpx_handle, ACPI_FULL_PATHNAME, &buffer);\r\nprintk(KERN_INFO "VGA switcheroo: detected switching method %s handle\n",\r\nacpi_method_name);\r\nradeon_atpx_priv.atpx_detected = true;\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nvoid radeon_register_atpx_handler(void)\r\n{\r\nbool r;\r\nr = radeon_atpx_detect();\r\nif (!r)\r\nreturn;\r\nvga_switcheroo_register_handler(&radeon_atpx_handler);\r\n}\r\nvoid radeon_unregister_atpx_handler(void)\r\n{\r\nvga_switcheroo_unregister_handler();\r\n}

static void print_input(struct remote_input *input)\r\n{\r\nif (input->type == INPUT_TYPE_MOUSE) {\r\nunsigned char buttons = input->mouse_buttons;\r\ndbg("remote mouse movement: (x,y)=(%d,%d)%s%s%s%s\n",\r\ninput->data.mouse.x, input->data.mouse.y,\r\n(buttons) ? " -- buttons:" : "",\r\n(buttons & REMOTE_BUTTON_LEFT) ? "left " : "",\r\n(buttons & REMOTE_BUTTON_MIDDLE) ? "middle " : "",\r\n(buttons & REMOTE_BUTTON_RIGHT) ? "right" : ""\r\n);\r\n} else {\r\ndbg("remote keypress (code, flag, down):"\r\n"%d (0x%x) [0x%x] [0x%x]\n",\r\ninput->data.keyboard.key_code,\r\ninput->data.keyboard.key_code,\r\ninput->data.keyboard.key_flag,\r\ninput->data.keyboard.key_down\r\n);\r\n}\r\n}\r\nstatic void send_mouse_event(struct input_dev *dev, struct remote_input *input)\r\n{\r\nunsigned char buttons = input->mouse_buttons;\r\ninput_report_abs(dev, ABS_X, input->data.mouse.x);\r\ninput_report_abs(dev, ABS_Y, input->data.mouse.y);\r\ninput_report_key(dev, BTN_LEFT, buttons & REMOTE_BUTTON_LEFT);\r\ninput_report_key(dev, BTN_MIDDLE, buttons & REMOTE_BUTTON_MIDDLE);\r\ninput_report_key(dev, BTN_RIGHT, buttons & REMOTE_BUTTON_RIGHT);\r\ninput_sync(dev);\r\n}\r\nstatic void send_keyboard_event(struct input_dev *dev,\r\nstruct remote_input *input)\r\n{\r\nunsigned int key;\r\nunsigned short code = input->data.keyboard.key_code;\r\nif (code & 0xff00)\r\nkey = xlate_high[code & 0xff];\r\nelse\r\nkey = xlate[code];\r\ninput_report_key(dev, key, input->data.keyboard.key_down);\r\ninput_sync(dev);\r\n}\r\nvoid ibmasm_handle_mouse_interrupt(struct service_processor *sp)\r\n{\r\nunsigned long reader;\r\nunsigned long writer;\r\nstruct remote_input input;\r\nreader = get_queue_reader(sp);\r\nwriter = get_queue_writer(sp);\r\nwhile (reader != writer) {\r\nmemcpy_fromio(&input, get_queue_entry(sp, reader),\r\nsizeof(struct remote_input));\r\nprint_input(&input);\r\nif (input.type == INPUT_TYPE_MOUSE) {\r\nsend_mouse_event(sp->remote.mouse_dev, &input);\r\n} else if (input.type == INPUT_TYPE_KEYBOARD) {\r\nsend_keyboard_event(sp->remote.keybd_dev, &input);\r\n} else\r\nbreak;\r\nreader = advance_queue_reader(sp, reader);\r\nwriter = get_queue_writer(sp);\r\n}\r\n}\r\nint ibmasm_init_remote_input_dev(struct service_processor *sp)\r\n{\r\nstruct input_dev *mouse_dev, *keybd_dev;\r\nstruct pci_dev *pdev = to_pci_dev(sp->dev);\r\nint error = -ENOMEM;\r\nint i;\r\nsp->remote.mouse_dev = mouse_dev = input_allocate_device();\r\nsp->remote.keybd_dev = keybd_dev = input_allocate_device();\r\nif (!mouse_dev || !keybd_dev)\r\ngoto err_free_devices;\r\nmouse_dev->id.bustype = BUS_PCI;\r\nmouse_dev->id.vendor = pdev->vendor;\r\nmouse_dev->id.product = pdev->device;\r\nmouse_dev->id.version = 1;\r\nmouse_dev->dev.parent = sp->dev;\r\nmouse_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\r\nmouse_dev->keybit[BIT_WORD(BTN_MOUSE)] = BIT_MASK(BTN_LEFT) |\r\nBIT_MASK(BTN_RIGHT) | BIT_MASK(BTN_MIDDLE);\r\nset_bit(BTN_TOUCH, mouse_dev->keybit);\r\nmouse_dev->name = "ibmasm RSA I remote mouse";\r\ninput_set_abs_params(mouse_dev, ABS_X, 0, MOUSE_X_MAX, 0, 0);\r\ninput_set_abs_params(mouse_dev, ABS_Y, 0, MOUSE_Y_MAX, 0, 0);\r\nkeybd_dev->id.bustype = BUS_PCI;\r\nkeybd_dev->id.vendor = pdev->vendor;\r\nkeybd_dev->id.product = pdev->device;\r\nkeybd_dev->id.version = 2;\r\nkeybd_dev->dev.parent = sp->dev;\r\nkeybd_dev->evbit[0] = BIT_MASK(EV_KEY);\r\nkeybd_dev->name = "ibmasm RSA I remote keyboard";\r\nfor (i = 0; i < XLATE_SIZE; i++) {\r\nif (xlate_high[i])\r\nset_bit(xlate_high[i], keybd_dev->keybit);\r\nif (xlate[i])\r\nset_bit(xlate[i], keybd_dev->keybit);\r\n}\r\nerror = input_register_device(mouse_dev);\r\nif (error)\r\ngoto err_free_devices;\r\nerror = input_register_device(keybd_dev);\r\nif (error)\r\ngoto err_unregister_mouse_dev;\r\nenable_mouse_interrupts(sp);\r\nprintk(KERN_INFO "ibmasm remote responding to events on RSA card %d\n", sp->number);\r\nreturn 0;\r\nerr_unregister_mouse_dev:\r\ninput_unregister_device(mouse_dev);\r\nmouse_dev = NULL;\r\nerr_free_devices:\r\ninput_free_device(mouse_dev);\r\ninput_free_device(keybd_dev);\r\nreturn error;\r\n}\r\nvoid ibmasm_free_remote_input_dev(struct service_processor *sp)\r\n{\r\ndisable_mouse_interrupts(sp);\r\ninput_unregister_device(sp->remote.mouse_dev);\r\ninput_unregister_device(sp->remote.keybd_dev);\r\n}

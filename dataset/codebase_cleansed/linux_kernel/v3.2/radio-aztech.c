static int volconvert(int level)\r\n{\r\nlevel >>= 14;\r\nlevel &= 3;\r\nswitch (level) {\r\ncase 0:\r\nreturn 0;\r\ncase 1:\r\nreturn 1;\r\ncase 2:\r\nreturn 4;\r\ncase 3:\r\nreturn 5;\r\n}\r\nreturn 0;\r\n}\r\nstatic void send_0_byte(struct aztech *az)\r\n{\r\nudelay(radio_wait_time);\r\noutb_p(2 + volconvert(az->curvol), az->io);\r\noutb_p(64 + 2 + volconvert(az->curvol), az->io);\r\n}\r\nstatic void send_1_byte(struct aztech *az)\r\n{\r\nudelay (radio_wait_time);\r\noutb_p(128 + 2 + volconvert(az->curvol), az->io);\r\noutb_p(128 + 64 + 2 + volconvert(az->curvol), az->io);\r\n}\r\nstatic int az_setvol(struct aztech *az, int vol)\r\n{\r\nmutex_lock(&az->lock);\r\noutb(volconvert(vol), az->io);\r\nmutex_unlock(&az->lock);\r\nreturn 0;\r\n}\r\nstatic int az_getsigstr(struct aztech *az)\r\n{\r\nint sig = 1;\r\nmutex_lock(&az->lock);\r\nif (inb(az->io) & 2)\r\nsig = 0;\r\nmutex_unlock(&az->lock);\r\nreturn sig;\r\n}\r\nstatic int az_getstereo(struct aztech *az)\r\n{\r\nint stereo = 1;\r\nmutex_lock(&az->lock);\r\nif (inb(az->io) & 1)\r\nstereo = 0;\r\nmutex_unlock(&az->lock);\r\nreturn stereo;\r\n}\r\nstatic int az_setfreq(struct aztech *az, unsigned long frequency)\r\n{\r\nint i;\r\nmutex_lock(&az->lock);\r\naz->curfreq = frequency;\r\nfrequency += 171200;\r\nfrequency /= 800;\r\nsend_0_byte(az);\r\nfor (i = 0; i < 13; i++)\r\nif (frequency & (1 << i))\r\nsend_1_byte(az);\r\nelse\r\nsend_0_byte(az);\r\nsend_0_byte(az);\r\nsend_0_byte(az);\r\nsend_0_byte(az);\r\nif (az->stereo)\r\nsend_1_byte(az);\r\nelse\r\nsend_0_byte(az);\r\nsend_1_byte(az);\r\nsend_0_byte(az);\r\nsend_0_byte(az);\r\nsend_1_byte(az);\r\nsend_0_byte(az);\r\nsend_1_byte(az);\r\nudelay(radio_wait_time);\r\noutb_p(128 + 64 + volconvert(az->curvol), az->io);\r\nmutex_unlock(&az->lock);\r\nreturn 0;\r\n}\r\nstatic int vidioc_querycap(struct file *file, void *priv,\r\nstruct v4l2_capability *v)\r\n{\r\nstrlcpy(v->driver, "radio-aztech", sizeof(v->driver));\r\nstrlcpy(v->card, "Aztech Radio", sizeof(v->card));\r\nstrlcpy(v->bus_info, "ISA", sizeof(v->bus_info));\r\nv->capabilities = V4L2_CAP_TUNER | V4L2_CAP_RADIO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nstruct aztech *az = video_drvdata(file);\r\nif (v->index > 0)\r\nreturn -EINVAL;\r\nstrlcpy(v->name, "FM", sizeof(v->name));\r\nv->type = V4L2_TUNER_RADIO;\r\nv->rangelow = 87 * 16000;\r\nv->rangehigh = 108 * 16000;\r\nv->rxsubchans = V4L2_TUNER_SUB_MONO | V4L2_TUNER_SUB_STEREO;\r\nv->capability = V4L2_TUNER_CAP_LOW;\r\nif (az_getstereo(az))\r\nv->audmode = V4L2_TUNER_MODE_STEREO;\r\nelse\r\nv->audmode = V4L2_TUNER_MODE_MONO;\r\nv->signal = 0xFFFF * az_getsigstr(az);\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nreturn v->index ? -EINVAL : 0;\r\n}\r\nstatic int vidioc_g_input(struct file *filp, void *priv, unsigned int *i)\r\n{\r\n*i = 0;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_input(struct file *filp, void *priv, unsigned int i)\r\n{\r\nreturn i ? -EINVAL : 0;\r\n}\r\nstatic int vidioc_g_audio(struct file *file, void *priv,\r\nstruct v4l2_audio *a)\r\n{\r\na->index = 0;\r\nstrlcpy(a->name, "Radio", sizeof(a->name));\r\na->capability = V4L2_AUDCAP_STEREO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_audio(struct file *file, void *priv,\r\nstruct v4l2_audio *a)\r\n{\r\nreturn a->index ? -EINVAL : 0;\r\n}\r\nstatic int vidioc_s_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct aztech *az = video_drvdata(file);\r\nif (f->tuner != 0 || f->type != V4L2_TUNER_RADIO)\r\nreturn -EINVAL;\r\naz_setfreq(az, f->frequency);\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct aztech *az = video_drvdata(file);\r\nif (f->tuner != 0)\r\nreturn -EINVAL;\r\nf->type = V4L2_TUNER_RADIO;\r\nf->frequency = az->curfreq;\r\nreturn 0;\r\n}\r\nstatic int vidioc_queryctrl(struct file *file, void *priv,\r\nstruct v4l2_queryctrl *qc)\r\n{\r\nswitch (qc->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nreturn v4l2_ctrl_query_fill(qc, 0, 1, 1, 1);\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nreturn v4l2_ctrl_query_fill(qc, 0, 0xff, 1, 0xff);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_g_ctrl(struct file *file, void *priv,\r\nstruct v4l2_control *ctrl)\r\n{\r\nstruct aztech *az = video_drvdata(file);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nif (az->curvol == 0)\r\nctrl->value = 1;\r\nelse\r\nctrl->value = 0;\r\nreturn 0;\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nctrl->value = az->curvol * 6554;\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_s_ctrl(struct file *file, void *priv,\r\nstruct v4l2_control *ctrl)\r\n{\r\nstruct aztech *az = video_drvdata(file);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nif (ctrl->value)\r\naz_setvol(az, 0);\r\nelse\r\naz_setvol(az, az->curvol);\r\nreturn 0;\r\ncase V4L2_CID_AUDIO_VOLUME:\r\naz_setvol(az, ctrl->value);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int __init aztech_init(void)\r\n{\r\nstruct aztech *az = &aztech_card;\r\nstruct v4l2_device *v4l2_dev = &az->v4l2_dev;\r\nint res;\r\nstrlcpy(v4l2_dev->name, "aztech", sizeof(v4l2_dev->name));\r\naz->io = io;\r\nif (az->io == -1) {\r\nv4l2_err(v4l2_dev, "you must set an I/O address with io=0x350 or 0x358\n");\r\nreturn -EINVAL;\r\n}\r\nif (!request_region(az->io, 2, "aztech")) {\r\nv4l2_err(v4l2_dev, "port 0x%x already in use\n", az->io);\r\nreturn -EBUSY;\r\n}\r\nres = v4l2_device_register(NULL, v4l2_dev);\r\nif (res < 0) {\r\nrelease_region(az->io, 2);\r\nv4l2_err(v4l2_dev, "Could not register v4l2_device\n");\r\nreturn res;\r\n}\r\nmutex_init(&az->lock);\r\nstrlcpy(az->vdev.name, v4l2_dev->name, sizeof(az->vdev.name));\r\naz->vdev.v4l2_dev = v4l2_dev;\r\naz->vdev.fops = &aztech_fops;\r\naz->vdev.ioctl_ops = &aztech_ioctl_ops;\r\naz->vdev.release = video_device_release_empty;\r\nvideo_set_drvdata(&az->vdev, az);\r\noutb(0, az->io);\r\nif (video_register_device(&az->vdev, VFL_TYPE_RADIO, radio_nr) < 0) {\r\nv4l2_device_unregister(v4l2_dev);\r\nrelease_region(az->io, 2);\r\nreturn -EINVAL;\r\n}\r\nv4l2_info(v4l2_dev, "Aztech radio card driver v1.00/19990224 rkroll@exploits.org\n");\r\nreturn 0;\r\n}\r\nstatic void __exit aztech_exit(void)\r\n{\r\nstruct aztech *az = &aztech_card;\r\nvideo_unregister_device(&az->vdev);\r\nv4l2_device_unregister(&az->v4l2_dev);\r\nrelease_region(az->io, 2);\r\n}

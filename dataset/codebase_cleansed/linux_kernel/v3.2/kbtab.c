static void kbtab_irq(struct urb *urb)\r\n{\r\nstruct kbtab *kbtab = urb->context;\r\nunsigned char *data = kbtab->data;\r\nstruct input_dev *dev = kbtab->dev;\r\nint pressure;\r\nint retval;\r\nswitch (urb->status) {\r\ncase 0:\r\nbreak;\r\ncase -ECONNRESET:\r\ncase -ENOENT:\r\ncase -ESHUTDOWN:\r\ndbg("%s - urb shutting down with status: %d", __func__, urb->status);\r\nreturn;\r\ndefault:\r\ndbg("%s - nonzero urb status received: %d", __func__, urb->status);\r\ngoto exit;\r\n}\r\ninput_report_key(dev, BTN_TOOL_PEN, 1);\r\ninput_report_abs(dev, ABS_X, get_unaligned_le16(&data[1]));\r\ninput_report_abs(dev, ABS_Y, get_unaligned_le16(&data[3]));\r\ninput_report_key(dev, BTN_RIGHT, data[0] & 0x02);\r\npressure = data[5];\r\nif (kb_pressure_click == -1)\r\ninput_report_abs(dev, ABS_PRESSURE, pressure);\r\nelse\r\ninput_report_key(dev, BTN_LEFT, pressure > kb_pressure_click ? 1 : 0);\r\ninput_sync(dev);\r\nexit:\r\nretval = usb_submit_urb(urb, GFP_ATOMIC);\r\nif (retval)\r\nerr("%s - usb_submit_urb failed with result %d",\r\n__func__, retval);\r\n}\r\nstatic int kbtab_open(struct input_dev *dev)\r\n{\r\nstruct kbtab *kbtab = input_get_drvdata(dev);\r\nkbtab->irq->dev = kbtab->usbdev;\r\nif (usb_submit_urb(kbtab->irq, GFP_KERNEL))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic void kbtab_close(struct input_dev *dev)\r\n{\r\nstruct kbtab *kbtab = input_get_drvdata(dev);\r\nusb_kill_urb(kbtab->irq);\r\n}\r\nstatic int kbtab_probe(struct usb_interface *intf, const struct usb_device_id *id)\r\n{\r\nstruct usb_device *dev = interface_to_usbdev(intf);\r\nstruct usb_endpoint_descriptor *endpoint;\r\nstruct kbtab *kbtab;\r\nstruct input_dev *input_dev;\r\nint error = -ENOMEM;\r\nkbtab = kzalloc(sizeof(struct kbtab), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!kbtab || !input_dev)\r\ngoto fail1;\r\nkbtab->data = usb_alloc_coherent(dev, 8, GFP_KERNEL, &kbtab->data_dma);\r\nif (!kbtab->data)\r\ngoto fail1;\r\nkbtab->irq = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!kbtab->irq)\r\ngoto fail2;\r\nkbtab->usbdev = dev;\r\nkbtab->dev = input_dev;\r\nusb_make_path(dev, kbtab->phys, sizeof(kbtab->phys));\r\nstrlcat(kbtab->phys, "/input0", sizeof(kbtab->phys));\r\ninput_dev->name = "KB Gear Tablet";\r\ninput_dev->phys = kbtab->phys;\r\nusb_to_input_id(dev, &input_dev->id);\r\ninput_dev->dev.parent = &intf->dev;\r\ninput_set_drvdata(input_dev, kbtab);\r\ninput_dev->open = kbtab_open;\r\ninput_dev->close = kbtab_close;\r\ninput_dev->evbit[0] |= BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\r\ninput_dev->keybit[BIT_WORD(BTN_LEFT)] |=\r\nBIT_MASK(BTN_LEFT) | BIT_MASK(BTN_RIGHT);\r\ninput_dev->keybit[BIT_WORD(BTN_DIGI)] |=\r\nBIT_MASK(BTN_TOOL_PEN) | BIT_MASK(BTN_TOUCH);\r\ninput_set_abs_params(input_dev, ABS_X, 0, 0x2000, 4, 0);\r\ninput_set_abs_params(input_dev, ABS_Y, 0, 0x1750, 4, 0);\r\ninput_set_abs_params(input_dev, ABS_PRESSURE, 0, 0xff, 0, 0);\r\nendpoint = &intf->cur_altsetting->endpoint[0].desc;\r\nusb_fill_int_urb(kbtab->irq, dev,\r\nusb_rcvintpipe(dev, endpoint->bEndpointAddress),\r\nkbtab->data, 8,\r\nkbtab_irq, kbtab, endpoint->bInterval);\r\nkbtab->irq->transfer_dma = kbtab->data_dma;\r\nkbtab->irq->transfer_flags |= URB_NO_TRANSFER_DMA_MAP;\r\nerror = input_register_device(kbtab->dev);\r\nif (error)\r\ngoto fail3;\r\nusb_set_intfdata(intf, kbtab);\r\nreturn 0;\r\nfail3: usb_free_urb(kbtab->irq);\r\nfail2: usb_free_coherent(dev, 8, kbtab->data, kbtab->data_dma);\r\nfail1: input_free_device(input_dev);\r\nkfree(kbtab);\r\nreturn error;\r\n}\r\nstatic void kbtab_disconnect(struct usb_interface *intf)\r\n{\r\nstruct kbtab *kbtab = usb_get_intfdata(intf);\r\nusb_set_intfdata(intf, NULL);\r\ninput_unregister_device(kbtab->dev);\r\nusb_free_urb(kbtab->irq);\r\nusb_free_coherent(kbtab->usbdev, 8, kbtab->data, kbtab->data_dma);\r\nkfree(kbtab);\r\n}\r\nstatic int __init kbtab_init(void)\r\n{\r\nint retval;\r\nretval = usb_register(&kbtab_driver);\r\nif (retval)\r\ngoto out;\r\nprintk(KERN_INFO KBUILD_MODNAME ": " DRIVER_VERSION ":"\r\nDRIVER_DESC "\n");\r\nout:\r\nreturn retval;\r\n}\r\nstatic void __exit kbtab_exit(void)\r\n{\r\nusb_deregister(&kbtab_driver);\r\n}

static void print_binary(unsigned int number)\r\n{\r\nint i,i2;\r\nchar buffer[64];\r\nmemset(buffer,0,64);\r\ni2=0;\r\nfor (i=31;i>=0;i--) {\r\nif (number & (1<<i))\r\nbuffer[i2++]='1';\r\nelse\r\nbuffer[i2++]='0';\r\nif ((i&3)==0)\r\nbuffer[i2++]=' ';\r\n}\r\npr_debug("%s\n",buffer);\r\n}\r\nstatic int __devinit xircom_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstruct net_device *dev = NULL;\r\nstruct xircom_private *private;\r\nunsigned long flags;\r\nunsigned short tmp16;\r\nif (pci_enable_device(pdev))\r\nreturn -ENODEV;\r\npci_write_config_dword(pdev, PCI_POWERMGMT, 0x0000);\r\npci_set_master(pdev);\r\npci_read_config_word (pdev,PCI_STATUS, &tmp16);\r\npci_write_config_word (pdev, PCI_STATUS,tmp16);\r\nif (!request_region(pci_resource_start(pdev, 0), 128, "xircom_cb")) {\r\npr_err("%s: failed to allocate io-region\n", __func__);\r\nreturn -ENODEV;\r\n}\r\ndev = alloc_etherdev(sizeof(struct xircom_private));\r\nif (!dev) {\r\npr_err("%s: failed to allocate etherdev\n", __func__);\r\ngoto device_fail;\r\n}\r\nprivate = netdev_priv(dev);\r\nprivate->rx_buffer = pci_alloc_consistent(pdev,8192,&private->rx_dma_handle);\r\nif (private->rx_buffer == NULL) {\r\npr_err("%s: no memory for rx buffer\n", __func__);\r\ngoto rx_buf_fail;\r\n}\r\nprivate->tx_buffer = pci_alloc_consistent(pdev,8192,&private->tx_dma_handle);\r\nif (private->tx_buffer == NULL) {\r\npr_err("%s: no memory for tx buffer\n", __func__);\r\ngoto tx_buf_fail;\r\n}\r\nSET_NETDEV_DEV(dev, &pdev->dev);\r\nprivate->dev = dev;\r\nprivate->pdev = pdev;\r\nprivate->io_port = pci_resource_start(pdev, 0);\r\nspin_lock_init(&private->lock);\r\ndev->irq = pdev->irq;\r\ndev->base_addr = private->io_port;\r\ninitialize_card(private);\r\nread_mac_address(private);\r\nsetup_descriptors(private);\r\ndev->netdev_ops = &netdev_ops;\r\npci_set_drvdata(pdev, dev);\r\nif (register_netdev(dev)) {\r\npr_err("%s: netdevice registration failed\n", __func__);\r\ngoto reg_fail;\r\n}\r\nnetdev_info(dev, "Xircom cardbus revision %i at irq %i\n",\r\npdev->revision, pdev->irq);\r\ntransceiver_voodoo(private);\r\nspin_lock_irqsave(&private->lock,flags);\r\nactivate_transmitter(private);\r\nactivate_receiver(private);\r\nspin_unlock_irqrestore(&private->lock,flags);\r\ntrigger_receive(private);\r\nreturn 0;\r\nreg_fail:\r\nkfree(private->tx_buffer);\r\ntx_buf_fail:\r\nkfree(private->rx_buffer);\r\nrx_buf_fail:\r\nfree_netdev(dev);\r\ndevice_fail:\r\nreturn -ENODEV;\r\n}\r\nstatic void __devexit xircom_remove(struct pci_dev *pdev)\r\n{\r\nstruct net_device *dev = pci_get_drvdata(pdev);\r\nstruct xircom_private *card = netdev_priv(dev);\r\npci_free_consistent(pdev,8192,card->rx_buffer,card->rx_dma_handle);\r\npci_free_consistent(pdev,8192,card->tx_buffer,card->tx_dma_handle);\r\nrelease_region(dev->base_addr, 128);\r\nunregister_netdev(dev);\r\nfree_netdev(dev);\r\npci_set_drvdata(pdev, NULL);\r\n}\r\nstatic irqreturn_t xircom_interrupt(int irq, void *dev_instance)\r\n{\r\nstruct net_device *dev = (struct net_device *) dev_instance;\r\nstruct xircom_private *card = netdev_priv(dev);\r\nunsigned int status;\r\nint i;\r\nspin_lock(&card->lock);\r\nstatus = inl(card->io_port+CSR5);\r\n#if defined DEBUG && DEBUG > 1\r\nprint_binary(status);\r\npr_debug("tx status 0x%08x 0x%08x\n",\r\ncard->tx_buffer[0], card->tx_buffer[4]);\r\npr_debug("rx status 0x%08x 0x%08x\n",\r\ncard->rx_buffer[0], card->rx_buffer[4]);\r\n#endif\r\nif (status == 0 || status == 0xffffffff) {\r\nspin_unlock(&card->lock);\r\nreturn IRQ_NONE;\r\n}\r\nif (link_status_changed(card)) {\r\nint newlink;\r\nnetdev_dbg(dev, "Link status has changed\n");\r\nnewlink = link_status(card);\r\nnetdev_info(dev, "Link is %d mbit\n", newlink);\r\nif (newlink)\r\nnetif_carrier_on(dev);\r\nelse\r\nnetif_carrier_off(dev);\r\n}\r\nstatus |= 0xffffffff;\r\noutl(status,card->io_port+CSR5);\r\nfor (i=0;i<NUMDESCRIPTORS;i++)\r\ninvestigate_write_descriptor(dev,card,i,bufferoffsets[i]);\r\nfor (i=0;i<NUMDESCRIPTORS;i++)\r\ninvestigate_read_descriptor(dev,card,i,bufferoffsets[i]);\r\nspin_unlock(&card->lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic netdev_tx_t xircom_start_xmit(struct sk_buff *skb,\r\nstruct net_device *dev)\r\n{\r\nstruct xircom_private *card;\r\nunsigned long flags;\r\nint nextdescriptor;\r\nint desc;\r\ncard = netdev_priv(dev);\r\nspin_lock_irqsave(&card->lock,flags);\r\nfor (desc=0;desc<NUMDESCRIPTORS;desc++)\r\ninvestigate_write_descriptor(dev,card,desc,bufferoffsets[desc]);\r\nnextdescriptor = (card->transmit_used +1) % (NUMDESCRIPTORS);\r\ndesc = card->transmit_used;\r\nif (card->tx_buffer[4*desc]==0) {\r\nmemset(&card->tx_buffer[bufferoffsets[desc]/4],0,1536);\r\nskb_copy_from_linear_data(skb,\r\n&(card->tx_buffer[bufferoffsets[desc] / 4]),\r\nskb->len);\r\ncard->tx_buffer[4*desc+1] = cpu_to_le32(skb->len);\r\nif (desc == NUMDESCRIPTORS - 1)\r\ncard->tx_buffer[4*desc+1] |= cpu_to_le32(1<<25);\r\ncard->tx_buffer[4*desc+1] |= cpu_to_le32(0xF0000000);\r\ncard->tx_skb[desc] = skb;\r\nwmb();\r\ncard->tx_buffer[4*desc] = cpu_to_le32(0x80000000);\r\ntrigger_transmit(card);\r\nif (card->tx_buffer[nextdescriptor*4] & cpu_to_le32(0x8000000)) {\r\nnetif_stop_queue(dev);\r\n}\r\ncard->transmit_used = nextdescriptor;\r\nspin_unlock_irqrestore(&card->lock,flags);\r\nreturn NETDEV_TX_OK;\r\n}\r\nnetif_stop_queue(dev);\r\nspin_unlock_irqrestore(&card->lock,flags);\r\ntrigger_transmit(card);\r\nreturn NETDEV_TX_BUSY;\r\n}\r\nstatic int xircom_open(struct net_device *dev)\r\n{\r\nstruct xircom_private *xp = netdev_priv(dev);\r\nint retval;\r\nnetdev_info(dev, "xircom cardbus adaptor found, using irq %i\n",\r\ndev->irq);\r\nretval = request_irq(dev->irq, xircom_interrupt, IRQF_SHARED, dev->name, dev);\r\nif (retval)\r\nreturn retval;\r\nxircom_up(xp);\r\nxp->open = 1;\r\nreturn 0;\r\n}\r\nstatic int xircom_close(struct net_device *dev)\r\n{\r\nstruct xircom_private *card;\r\nunsigned long flags;\r\ncard = netdev_priv(dev);\r\nnetif_stop_queue(dev);\r\nspin_lock_irqsave(&card->lock,flags);\r\ndisable_all_interrupts(card);\r\n#if 0\r\ndeactivate_receiver(card);\r\ndeactivate_transmitter(card);\r\n#endif\r\nremove_descriptors(card);\r\nspin_unlock_irqrestore(&card->lock,flags);\r\ncard->open = 0;\r\nfree_irq(dev->irq,dev);\r\nreturn 0;\r\n}\r\nstatic void xircom_poll_controller(struct net_device *dev)\r\n{\r\ndisable_irq(dev->irq);\r\nxircom_interrupt(dev->irq, dev);\r\nenable_irq(dev->irq);\r\n}\r\nstatic void initialize_card(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nunsigned long flags;\r\nspin_lock_irqsave(&card->lock, flags);\r\nval = inl(card->io_port + CSR0);\r\nval |= 0x01;\r\noutl(val, card->io_port + CSR0);\r\nudelay(100);\r\nval = inl(card->io_port + CSR0);\r\nval &= ~0x01;\r\noutl(val, card->io_port + CSR0);\r\nval = 0;\r\noutl(val, card->io_port + CSR0);\r\ndisable_all_interrupts(card);\r\ndeactivate_receiver(card);\r\ndeactivate_transmitter(card);\r\nspin_unlock_irqrestore(&card->lock, flags);\r\n}\r\nstatic void trigger_transmit(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nval = 0;\r\noutl(val, card->io_port + CSR1);\r\n}\r\nstatic void trigger_receive(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nval = 0;\r\noutl(val, card->io_port + CSR2);\r\n}\r\nstatic void setup_descriptors(struct xircom_private *card)\r\n{\r\nu32 address;\r\nint i;\r\nBUG_ON(card->rx_buffer == NULL);\r\nBUG_ON(card->tx_buffer == NULL);\r\nmemset(card->rx_buffer, 0, 128);\r\nfor (i=0;i<NUMDESCRIPTORS;i++ ) {\r\ncard->rx_buffer[i*4 + 0] = cpu_to_le32(0x80000000);\r\ncard->rx_buffer[i*4 + 1] = cpu_to_le32(1536);\r\nif (i == NUMDESCRIPTORS - 1)\r\ncard->rx_buffer[i*4 + 1] |= cpu_to_le32(1 << 25);\r\naddress = card->rx_dma_handle;\r\ncard->rx_buffer[i*4 + 2] = cpu_to_le32(address + bufferoffsets[i]);\r\ncard->rx_buffer[i*4 + 3] = 0;\r\n}\r\nwmb();\r\naddress = card->rx_dma_handle;\r\noutl(address, card->io_port + CSR3);\r\nmemset(card->tx_buffer, 0, 128);\r\nfor (i=0;i<NUMDESCRIPTORS;i++ ) {\r\ncard->tx_buffer[i*4 + 0] = 0x00000000;\r\ncard->tx_buffer[i*4 + 1] = cpu_to_le32(1536);\r\nif (i == NUMDESCRIPTORS - 1)\r\ncard->tx_buffer[i*4 + 1] |= cpu_to_le32(1 << 25);\r\naddress = card->tx_dma_handle;\r\ncard->tx_buffer[i*4 + 2] = cpu_to_le32(address + bufferoffsets[i]);\r\ncard->tx_buffer[i*4 + 3] = 0;\r\n}\r\nwmb();\r\naddress = card->tx_dma_handle;\r\noutl(address, card->io_port + CSR4);\r\n}\r\nstatic void remove_descriptors(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nval = 0;\r\noutl(val, card->io_port + CSR3);\r\noutl(val, card->io_port + CSR4);\r\n}\r\nstatic int link_status_changed(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nval = inl(card->io_port + CSR5);\r\nif ((val & (1 << 27)) == 0)\r\nreturn 0;\r\nval = (1 << 27);\r\noutl(val, card->io_port + CSR5);\r\nreturn 1;\r\n}\r\nstatic int transmit_active(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nval = inl(card->io_port + CSR5);\r\nif ((val & (7 << 20)) == 0)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int receive_active(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nval = inl(card->io_port + CSR5);\r\nif ((val & (7 << 17)) == 0)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic void activate_receiver(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nint counter;\r\nval = inl(card->io_port + CSR6);\r\nif ((val&2) && (receive_active(card)))\r\nreturn;\r\nval = val & ~2;\r\noutl(val, card->io_port + CSR6);\r\ncounter = 10;\r\nwhile (counter > 0) {\r\nif (!receive_active(card))\r\nbreak;\r\nudelay(50);\r\ncounter--;\r\nif (counter <= 0)\r\nnetdev_err(card->dev, "Receiver failed to deactivate\n");\r\n}\r\nval = inl(card->io_port + CSR6);\r\nval = val | 2;\r\noutl(val, card->io_port + CSR6);\r\ncounter = 10;\r\nwhile (counter > 0) {\r\nif (receive_active(card))\r\nbreak;\r\nudelay(50);\r\ncounter--;\r\nif (counter <= 0)\r\nnetdev_err(card->dev,\r\n"Receiver failed to re-activate\n");\r\n}\r\n}\r\nstatic void deactivate_receiver(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nint counter;\r\nval = inl(card->io_port + CSR6);\r\nval = val & ~2;\r\noutl(val, card->io_port + CSR6);\r\ncounter = 10;\r\nwhile (counter > 0) {\r\nif (!receive_active(card))\r\nbreak;\r\nudelay(50);\r\ncounter--;\r\nif (counter <= 0)\r\nnetdev_err(card->dev, "Receiver failed to deactivate\n");\r\n}\r\n}\r\nstatic void activate_transmitter(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nint counter;\r\nval = inl(card->io_port + CSR6);\r\nif ((val&(1<<13)) && (transmit_active(card)))\r\nreturn;\r\nval = val & ~(1 << 13);\r\noutl(val, card->io_port + CSR6);\r\ncounter = 10;\r\nwhile (counter > 0) {\r\nif (!transmit_active(card))\r\nbreak;\r\nudelay(50);\r\ncounter--;\r\nif (counter <= 0)\r\nnetdev_err(card->dev,\r\n"Transmitter failed to deactivate\n");\r\n}\r\nval = inl(card->io_port + CSR6);\r\nval = val | (1 << 13);\r\noutl(val, card->io_port + CSR6);\r\ncounter = 10;\r\nwhile (counter > 0) {\r\nif (transmit_active(card))\r\nbreak;\r\nudelay(50);\r\ncounter--;\r\nif (counter <= 0)\r\nnetdev_err(card->dev,\r\n"Transmitter failed to re-activate\n");\r\n}\r\n}\r\nstatic void deactivate_transmitter(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nint counter;\r\nval = inl(card->io_port + CSR6);\r\nval = val & ~2;\r\noutl(val, card->io_port + CSR6);\r\ncounter = 20;\r\nwhile (counter > 0) {\r\nif (!transmit_active(card))\r\nbreak;\r\nudelay(50);\r\ncounter--;\r\nif (counter <= 0)\r\nnetdev_err(card->dev,\r\n"Transmitter failed to deactivate\n");\r\n}\r\n}\r\nstatic void enable_transmit_interrupt(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nval = inl(card->io_port + CSR7);\r\nval |= 1;\r\noutl(val, card->io_port + CSR7);\r\n}\r\nstatic void enable_receive_interrupt(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nval = inl(card->io_port + CSR7);\r\nval = val | (1 << 6);\r\noutl(val, card->io_port + CSR7);\r\n}\r\nstatic void enable_link_interrupt(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nval = inl(card->io_port + CSR7);\r\nval = val | (1 << 27);\r\noutl(val, card->io_port + CSR7);\r\n}\r\nstatic void disable_all_interrupts(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nval = 0;\r\noutl(val, card->io_port + CSR7);\r\n}\r\nstatic void enable_common_interrupts(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nval = inl(card->io_port + CSR7);\r\nval |= (1<<16);\r\nval |= (1<<15);\r\nval |= (1<<13);\r\nval |= (1<<8);\r\nval |= (1<<7);\r\nval |= (1<<5);\r\nval |= (1<<2);\r\nval |= (1<<1);\r\noutl(val, card->io_port + CSR7);\r\n}\r\nstatic int enable_promisc(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nval = inl(card->io_port + CSR6);\r\nval = val | (1 << 6);\r\noutl(val, card->io_port + CSR6);\r\nreturn 1;\r\n}\r\nstatic int link_status(struct xircom_private *card)\r\n{\r\nunsigned int val;\r\nval = inb(card->io_port + CSR12);\r\nif (!(val&(1<<2)))\r\nreturn 10;\r\nif (!(val&(1<<1)))\r\nreturn 100;\r\nreturn 0;\r\n}\r\nstatic void read_mac_address(struct xircom_private *card)\r\n{\r\nunsigned char j, tuple, link, data_id, data_count;\r\nunsigned long flags;\r\nint i;\r\nspin_lock_irqsave(&card->lock, flags);\r\noutl(1 << 12, card->io_port + CSR9);\r\nfor (i = 0x100; i < 0x1f7; i += link + 2) {\r\noutl(i, card->io_port + CSR10);\r\ntuple = inl(card->io_port + CSR9) & 0xff;\r\noutl(i + 1, card->io_port + CSR10);\r\nlink = inl(card->io_port + CSR9) & 0xff;\r\noutl(i + 2, card->io_port + CSR10);\r\ndata_id = inl(card->io_port + CSR9) & 0xff;\r\noutl(i + 3, card->io_port + CSR10);\r\ndata_count = inl(card->io_port + CSR9) & 0xff;\r\nif ((tuple == 0x22) && (data_id == 0x04) && (data_count == 0x06)) {\r\nfor (j = 0; j < 6; j++) {\r\noutl(i + j + 4, card->io_port + CSR10);\r\ncard->dev->dev_addr[j] = inl(card->io_port + CSR9) & 0xff;\r\n}\r\nbreak;\r\n} else if (link == 0) {\r\nbreak;\r\n}\r\n}\r\nspin_unlock_irqrestore(&card->lock, flags);\r\npr_debug(" %pM\n", card->dev->dev_addr);\r\n}\r\nstatic void transceiver_voodoo(struct xircom_private *card)\r\n{\r\nunsigned long flags;\r\npci_write_config_dword(card->pdev, PCI_POWERMGMT, 0x0000);\r\nsetup_descriptors(card);\r\nspin_lock_irqsave(&card->lock, flags);\r\noutl(0x0008, card->io_port + CSR15);\r\nudelay(25);\r\noutl(0xa8050000, card->io_port + CSR15);\r\nudelay(25);\r\noutl(0xa00f0000, card->io_port + CSR15);\r\nudelay(25);\r\nspin_unlock_irqrestore(&card->lock, flags);\r\nnetif_start_queue(card->dev);\r\n}\r\nstatic void xircom_up(struct xircom_private *card)\r\n{\r\nunsigned long flags;\r\nint i;\r\npci_write_config_dword(card->pdev, PCI_POWERMGMT, 0x0000);\r\nsetup_descriptors(card);\r\nspin_lock_irqsave(&card->lock, flags);\r\nenable_link_interrupt(card);\r\nenable_transmit_interrupt(card);\r\nenable_receive_interrupt(card);\r\nenable_common_interrupts(card);\r\nenable_promisc(card);\r\nfor (i=0;i<NUMDESCRIPTORS;i++)\r\ninvestigate_read_descriptor(card->dev,card,i,bufferoffsets[i]);\r\nspin_unlock_irqrestore(&card->lock, flags);\r\ntrigger_receive(card);\r\ntrigger_transmit(card);\r\nnetif_start_queue(card->dev);\r\n}\r\nstatic void\r\ninvestigate_read_descriptor(struct net_device *dev, struct xircom_private *card,\r\nint descnr, unsigned int bufferoffset)\r\n{\r\nint status;\r\nstatus = le32_to_cpu(card->rx_buffer[4*descnr]);\r\nif (status > 0) {\r\nshort pkt_len = ((status >> 16) & 0x7ff) - 4;\r\nstruct sk_buff *skb;\r\nif (pkt_len > 1518) {\r\nnetdev_err(dev, "Packet length %i is bogus\n", pkt_len);\r\npkt_len = 1518;\r\n}\r\nskb = dev_alloc_skb(pkt_len + 2);\r\nif (skb == NULL) {\r\ndev->stats.rx_dropped++;\r\ngoto out;\r\n}\r\nskb_reserve(skb, 2);\r\nskb_copy_to_linear_data(skb,\r\n&card->rx_buffer[bufferoffset / 4],\r\npkt_len);\r\nskb_put(skb, pkt_len);\r\nskb->protocol = eth_type_trans(skb, dev);\r\nnetif_rx(skb);\r\ndev->stats.rx_packets++;\r\ndev->stats.rx_bytes += pkt_len;\r\nout:\r\ncard->rx_buffer[4*descnr] = cpu_to_le32(0x80000000);\r\ntrigger_receive(card);\r\n}\r\n}\r\nstatic void\r\ninvestigate_write_descriptor(struct net_device *dev,\r\nstruct xircom_private *card,\r\nint descnr, unsigned int bufferoffset)\r\n{\r\nint status;\r\nstatus = le32_to_cpu(card->tx_buffer[4*descnr]);\r\n#if 0\r\nif (status & 0x8000) {\r\npr_err("Major transmit error status %x\n", status);\r\ncard->tx_buffer[4*descnr] = 0;\r\nnetif_wake_queue (dev);\r\n}\r\n#endif\r\nif (status > 0) {\r\nif (card->tx_skb[descnr]!=NULL) {\r\ndev->stats.tx_bytes += card->tx_skb[descnr]->len;\r\ndev_kfree_skb_irq(card->tx_skb[descnr]);\r\n}\r\ncard->tx_skb[descnr] = NULL;\r\nif (status & (1 << 8))\r\ndev->stats.collisions++;\r\ncard->tx_buffer[4*descnr] = 0;\r\nnetif_wake_queue (dev);\r\ndev->stats.tx_packets++;\r\n}\r\n}\r\nstatic int __init xircom_init(void)\r\n{\r\nreturn pci_register_driver(&xircom_ops);\r\n}\r\nstatic void __exit xircom_exit(void)\r\n{\r\npci_unregister_driver(&xircom_ops);\r\n}

static int cb_pcimdas_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nstruct pci_dev *pcidev = NULL;\r\nint index;\r\nprintk("comedi%d: cb_pcimdas: ", dev->minor);\r\nif (alloc_private(dev, sizeof(struct cb_pcimdas_private)) < 0)\r\nreturn -ENOMEM;\r\nprintk("\n");\r\nfor_each_pci_dev(pcidev) {\r\nif (pcidev->vendor != PCI_VENDOR_ID_COMPUTERBOARDS)\r\ncontinue;\r\nfor (index = 0; index < N_BOARDS; index++) {\r\nif (cb_pcimdas_boards[index].device_id !=\r\npcidev->device)\r\ncontinue;\r\nif (it->options[0] || it->options[1]) {\r\nif (pcidev->bus->number != it->options[0] ||\r\nPCI_SLOT(pcidev->devfn) != it->options[1]) {\r\ncontinue;\r\n}\r\n}\r\ndevpriv->pci_dev = pcidev;\r\ndev->board_ptr = cb_pcimdas_boards + index;\r\ngoto found;\r\n}\r\n}\r\nprintk("No supported ComputerBoards/MeasurementComputing card found on "\r\n"requested position\n");\r\nreturn -EIO;\r\nfound:\r\nprintk("Found %s on bus %i, slot %i\n", cb_pcimdas_boards[index].name,\r\npcidev->bus->number, PCI_SLOT(pcidev->devfn));\r\nswitch (thisboard->device_id) {\r\ncase 0x56:\r\nbreak;\r\ndefault:\r\nprintk("THIS CARD IS UNSUPPORTED.\n"\r\n"PLEASE REPORT USAGE TO <mocelet@sucs.org>\n");\r\n}\r\nif (comedi_pci_enable(pcidev, "cb_pcimdas")) {\r\nprintk(" Failed to enable PCI device and request regions\n");\r\nreturn -EIO;\r\n}\r\ndevpriv->BADR0 = pci_resource_start(devpriv->pci_dev, 0);\r\ndevpriv->BADR1 = pci_resource_start(devpriv->pci_dev, 1);\r\ndevpriv->BADR2 = pci_resource_start(devpriv->pci_dev, 2);\r\ndevpriv->BADR3 = pci_resource_start(devpriv->pci_dev, 3);\r\ndevpriv->BADR4 = pci_resource_start(devpriv->pci_dev, 4);\r\n#ifdef CBPCIMDAS_DEBUG\r\nprintk("devpriv->BADR0 = 0x%lx\n", devpriv->BADR0);\r\nprintk("devpriv->BADR1 = 0x%lx\n", devpriv->BADR1);\r\nprintk("devpriv->BADR2 = 0x%lx\n", devpriv->BADR2);\r\nprintk("devpriv->BADR3 = 0x%lx\n", devpriv->BADR3);\r\nprintk("devpriv->BADR4 = 0x%lx\n", devpriv->BADR4);\r\n#endif\r\ndev->board_name = thisboard->name;\r\nif (alloc_subdevices(dev, 3) < 0)\r\nreturn -ENOMEM;\r\ns = dev->subdevices + 0;\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND;\r\ns->n_chan = thisboard->ai_se_chans;\r\ns->maxdata = (1 << thisboard->ai_bits) - 1;\r\ns->range_table = &range_unknown;\r\ns->len_chanlist = 1;\r\ns->insn_read = cb_pcimdas_ai_rinsn;\r\ns = dev->subdevices + 1;\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = thisboard->ao_nchan;\r\ns->maxdata = 1 << thisboard->ao_bits;\r\ns->range_table = &range_unknown;\r\ns->insn_write = &cb_pcimdas_ao_winsn;\r\ns->insn_read = &cb_pcimdas_ao_rinsn;\r\ns = dev->subdevices + 2;\r\nif (thisboard->has_dio)\r\nsubdev_8255_init(dev, s, NULL, devpriv->BADR4);\r\nelse\r\ns->type = COMEDI_SUBD_UNUSED;\r\nprintk("attached\n");\r\nreturn 1;\r\n}\r\nstatic int cb_pcimdas_detach(struct comedi_device *dev)\r\n{\r\n#ifdef CBPCIMDAS_DEBUG\r\nif (devpriv) {\r\nprintk("devpriv->BADR0 = 0x%lx\n", devpriv->BADR0);\r\nprintk("devpriv->BADR1 = 0x%lx\n", devpriv->BADR1);\r\nprintk("devpriv->BADR2 = 0x%lx\n", devpriv->BADR2);\r\nprintk("devpriv->BADR3 = 0x%lx\n", devpriv->BADR3);\r\nprintk("devpriv->BADR4 = 0x%lx\n", devpriv->BADR4);\r\n}\r\n#endif\r\nprintk("comedi%d: cb_pcimdas: remove\n", dev->minor);\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\nif (devpriv) {\r\nif (devpriv->pci_dev) {\r\nif (devpriv->BADR0)\r\ncomedi_pci_disable(devpriv->pci_dev);\r\npci_dev_put(devpriv->pci_dev);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int cb_pcimdas_ai_rinsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint n, i;\r\nunsigned int d;\r\nunsigned int busy;\r\nint chan = CR_CHAN(insn->chanspec);\r\nunsigned short chanlims;\r\nint maxchans;\r\nif ((inb(devpriv->BADR3 + 2) & 0x20) == 0)\r\nmaxchans = thisboard->ai_diff_chans;\r\nelse\r\nmaxchans = thisboard->ai_se_chans;\r\nif (chan > (maxchans - 1))\r\nreturn -ETIMEDOUT;\r\nd = inb(devpriv->BADR3 + 5);\r\nif ((d & 0x03) > 0) {\r\nd = d & 0xfd;\r\noutb(d, devpriv->BADR3 + 5);\r\n}\r\noutb(0x01, devpriv->BADR3 + 6);\r\noutb(0x00, devpriv->BADR3 + 7);\r\nchanlims = chan | (chan << 4);\r\noutb(chanlims, devpriv->BADR3 + 0);\r\nfor (n = 0; n < insn->n; n++) {\r\noutw(0, devpriv->BADR2 + 0);\r\n#define TIMEOUT 1000\r\nfor (i = 0; i < TIMEOUT; i++) {\r\nbusy = inb(devpriv->BADR3 + 2) & 0x80;\r\nif (!busy)\r\nbreak;\r\n}\r\nif (i == TIMEOUT) {\r\nprintk("timeout\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nd = inw(devpriv->BADR2 + 0);\r\ndata[n] = d;\r\n}\r\nreturn n;\r\n}\r\nstatic int cb_pcimdas_ao_winsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++) {\r\nswitch (chan) {\r\ncase 0:\r\noutw(data[i] & 0x0FFF, devpriv->BADR2 + DAC0_OFFSET);\r\nbreak;\r\ncase 1:\r\noutw(data[i] & 0x0FFF, devpriv->BADR2 + DAC1_OFFSET);\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\ndevpriv->ao_readback[chan] = data[i];\r\n}\r\nreturn i;\r\n}\r\nstatic int cb_pcimdas_ao_rinsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = devpriv->ao_readback[chan];\r\nreturn i;\r\n}\r\nstatic int __devinit driver_cb_pcimdas_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id\r\n*ent)\r\n{\r\nreturn comedi_pci_auto_config(dev, driver_cb_pcimdas.driver_name);\r\n}\r\nstatic void __devexit driver_cb_pcimdas_pci_remove(struct pci_dev *dev)\r\n{\r\ncomedi_pci_auto_unconfig(dev);\r\n}\r\nstatic int __init driver_cb_pcimdas_init_module(void)\r\n{\r\nint retval;\r\nretval = comedi_driver_register(&driver_cb_pcimdas);\r\nif (retval < 0)\r\nreturn retval;\r\ndriver_cb_pcimdas_pci_driver.name =\r\n(char *)driver_cb_pcimdas.driver_name;\r\nreturn pci_register_driver(&driver_cb_pcimdas_pci_driver);\r\n}\r\nstatic void __exit driver_cb_pcimdas_cleanup_module(void)\r\n{\r\npci_unregister_driver(&driver_cb_pcimdas_pci_driver);\r\ncomedi_driver_unregister(&driver_cb_pcimdas);\r\n}

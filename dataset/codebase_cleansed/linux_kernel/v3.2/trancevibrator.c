static ssize_t show_speed(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(dev);\r\nstruct trancevibrator *tv = usb_get_intfdata(intf);\r\nreturn sprintf(buf, "%d\n", tv->speed);\r\n}\r\nstatic ssize_t set_speed(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(dev);\r\nstruct trancevibrator *tv = usb_get_intfdata(intf);\r\nint temp, retval, old;\r\ntemp = simple_strtoul(buf, NULL, 10);\r\nif (temp > 255)\r\ntemp = 255;\r\nelse if (temp < 0)\r\ntemp = 0;\r\nold = tv->speed;\r\ntv->speed = temp;\r\ndev_dbg(&tv->udev->dev, "speed = %d\n", tv->speed);\r\nretval = usb_control_msg(tv->udev, usb_sndctrlpipe(tv->udev, 0),\r\n0x01,\r\nUSB_DIR_IN | USB_TYPE_VENDOR | USB_RECIP_OTHER,\r\ntv->speed,\r\n0, NULL, 0, USB_CTRL_GET_TIMEOUT);\r\nif (retval) {\r\ntv->speed = old;\r\ndev_dbg(&tv->udev->dev, "retval = %d\n", retval);\r\nreturn retval;\r\n}\r\nreturn count;\r\n}\r\nstatic int tv_probe(struct usb_interface *interface,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_device *udev = interface_to_usbdev(interface);\r\nstruct trancevibrator *dev;\r\nint retval;\r\ndev = kzalloc(sizeof(struct trancevibrator), GFP_KERNEL);\r\nif (dev == NULL) {\r\ndev_err(&interface->dev, "Out of memory\n");\r\nretval = -ENOMEM;\r\ngoto error;\r\n}\r\ndev->udev = usb_get_dev(udev);\r\nusb_set_intfdata(interface, dev);\r\nretval = device_create_file(&interface->dev, &dev_attr_speed);\r\nif (retval)\r\ngoto error_create_file;\r\nreturn 0;\r\nerror_create_file:\r\nusb_put_dev(udev);\r\nusb_set_intfdata(interface, NULL);\r\nerror:\r\nkfree(dev);\r\nreturn retval;\r\n}\r\nstatic void tv_disconnect(struct usb_interface *interface)\r\n{\r\nstruct trancevibrator *dev;\r\ndev = usb_get_intfdata (interface);\r\ndevice_remove_file(&interface->dev, &dev_attr_speed);\r\nusb_set_intfdata(interface, NULL);\r\nusb_put_dev(dev->udev);\r\nkfree(dev);\r\n}\r\nstatic int __init tv_init(void)\r\n{\r\nint retval = usb_register(&tv_driver);\r\nif (retval) {\r\nerr("usb_register failed. Error number %d", retval);\r\nreturn retval;\r\n}\r\nprintk(KERN_INFO KBUILD_MODNAME ": " DRIVER_VERSION ":"\r\nDRIVER_DESC "\n");\r\nreturn 0;\r\n}\r\nstatic void __exit tv_exit(void)\r\n{\r\nusb_deregister(&tv_driver);\r\n}

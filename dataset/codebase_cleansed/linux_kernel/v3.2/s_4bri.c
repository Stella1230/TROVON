static void qBri_cpu_trapped (PISDN_ADAPTER IoAdapter) {\r\nbyte __iomem *base ;\r\nword *Xlog ;\r\ndword regs[4], TrapID, offset, size ;\r\nXdesc xlogDesc ;\r\nint factor = (IoAdapter->tasks == 1) ? 1 : 2;\r\nbase = DIVA_OS_MEM_ATTACH_CONTROL(IoAdapter);\r\noffset = IoAdapter->ControllerNumber * (IoAdapter->MemorySize >> factor) ;\r\nTrapID = READ_DWORD(&base[0x80]) ;\r\nif ( (TrapID == 0x99999999) || (TrapID == 0x99999901) )\r\n{\r\ndump_trap_frame (IoAdapter, &base[0x90]) ;\r\nIoAdapter->trapped = 1 ;\r\n}\r\nregs[0] = READ_DWORD((base + offset) + 0x70);\r\nregs[1] = READ_DWORD((base + offset) + 0x74);\r\nregs[2] = READ_DWORD((base + offset) + 0x78);\r\nregs[3] = READ_DWORD((base + offset) + 0x7c);\r\nregs[0] &= IoAdapter->MemorySize - 1 ;\r\nif ( (regs[0] >= offset)\r\n&& (regs[0] < offset + (IoAdapter->MemorySize >> factor) - 1) )\r\n{\r\nif ( !(Xlog = (word *)diva_os_malloc (0, MAX_XLOG_SIZE)) ) {\r\nDIVA_OS_MEM_DETACH_CONTROL(IoAdapter, base);\r\nreturn ;\r\n}\r\nsize = offset + (IoAdapter->MemorySize >> factor) - regs[0] ;\r\nif ( size > MAX_XLOG_SIZE )\r\nsize = MAX_XLOG_SIZE ;\r\nmemcpy_fromio (Xlog, &base[regs[0]], size) ;\r\nxlogDesc.buf = Xlog ;\r\nxlogDesc.cnt = READ_WORD(&base[regs[1] & (IoAdapter->MemorySize - 1)]) ;\r\nxlogDesc.out = READ_WORD(&base[regs[2] & (IoAdapter->MemorySize - 1)]) ;\r\ndump_xlog_buffer (IoAdapter, &xlogDesc) ;\r\ndiva_os_free (0, Xlog) ;\r\nIoAdapter->trapped = 2 ;\r\n}\r\nDIVA_OS_MEM_DETACH_CONTROL(IoAdapter, base);\r\n}\r\nstatic void reset_qBri_hardware (PISDN_ADAPTER IoAdapter) {\r\nword volatile __iomem *qBriReset ;\r\nbyte volatile __iomem *qBriCntrl ;\r\nbyte volatile __iomem *p ;\r\nqBriReset = (word volatile __iomem *)DIVA_OS_MEM_ATTACH_PROM(IoAdapter);\r\nWRITE_WORD(qBriReset, READ_WORD(qBriReset) | PLX9054_SOFT_RESET) ;\r\ndiva_os_wait (1) ;\r\nWRITE_WORD(qBriReset, READ_WORD(qBriReset) & ~PLX9054_SOFT_RESET) ;\r\ndiva_os_wait (1);\r\nWRITE_WORD(qBriReset, READ_WORD(qBriReset) | PLX9054_RELOAD_EEPROM) ;\r\ndiva_os_wait (1) ;\r\nWRITE_WORD(qBriReset, READ_WORD(qBriReset) & ~PLX9054_RELOAD_EEPROM) ;\r\ndiva_os_wait (1);\r\nDIVA_OS_MEM_DETACH_PROM(IoAdapter, qBriReset);\r\nqBriCntrl = DIVA_OS_MEM_ATTACH_CTLREG(IoAdapter);\r\np = &qBriCntrl[DIVA_4BRI_REVISION(IoAdapter) ? (MQ2_BREG_RISC) : (MQ_BREG_RISC)];\r\nWRITE_DWORD(p, 0) ;\r\nDIVA_OS_MEM_DETACH_CTLREG(IoAdapter, qBriCntrl);\r\nDBG_TRC(("resetted board @ reset addr 0x%08lx", qBriReset))\r\nDBG_TRC(("resetted board @ cntrl addr 0x%08lx", p))\r\n}\r\nvoid start_qBri_hardware (PISDN_ADAPTER IoAdapter) {\r\nbyte volatile __iomem *qBriReset ;\r\nbyte volatile __iomem *p ;\r\np = DIVA_OS_MEM_ATTACH_CTLREG(IoAdapter);\r\nqBriReset = &p[(DIVA_4BRI_REVISION(IoAdapter)) ? (MQ2_BREG_RISC) : (MQ_BREG_RISC)];\r\nWRITE_DWORD(qBriReset, MQ_RISC_COLD_RESET_MASK) ;\r\ndiva_os_wait (2) ;\r\nWRITE_DWORD(qBriReset, MQ_RISC_WARM_RESET_MASK | MQ_RISC_COLD_RESET_MASK) ;\r\ndiva_os_wait (10) ;\r\nDIVA_OS_MEM_DETACH_CTLREG(IoAdapter, p);\r\nDBG_TRC(("started processor @ addr 0x%08lx", qBriReset))\r\n}\r\nstatic void stop_qBri_hardware (PISDN_ADAPTER IoAdapter) {\r\nbyte volatile __iomem *p ;\r\ndword volatile __iomem *qBriReset ;\r\ndword volatile __iomem *qBriIrq ;\r\ndword volatile __iomem *qBriIsacDspReset ;\r\nint rev2 = DIVA_4BRI_REVISION(IoAdapter);\r\nint reset_offset = rev2 ? (MQ2_BREG_RISC) : (MQ_BREG_RISC);\r\nint irq_offset = rev2 ? (MQ2_BREG_IRQ_TEST) : (MQ_BREG_IRQ_TEST);\r\nint hw_offset = rev2 ? (MQ2_ISAC_DSP_RESET) : (MQ_ISAC_DSP_RESET);\r\nif ( IoAdapter->ControllerNumber > 0 )\r\nreturn ;\r\np = DIVA_OS_MEM_ATTACH_CTLREG(IoAdapter);\r\nqBriReset = (dword volatile __iomem *)&p[reset_offset];\r\nqBriIsacDspReset = (dword volatile __iomem *)&p[hw_offset];\r\nWRITE_DWORD(qBriReset, 0) ;\r\nWRITE_DWORD(qBriIsacDspReset, 0) ;\r\nDIVA_OS_MEM_DETACH_CTLREG(IoAdapter, p);\r\np = DIVA_OS_MEM_ATTACH_RESET(IoAdapter);\r\nWRITE_BYTE(&p[PLX9054_INTCSR], 0x00);\r\nDIVA_OS_MEM_DETACH_RESET(IoAdapter, p);\r\np = DIVA_OS_MEM_ATTACH_CTLREG(IoAdapter);\r\nqBriIrq = (dword volatile __iomem *)&p[irq_offset];\r\nWRITE_DWORD(qBriIrq, MQ_IRQ_REQ_OFF) ;\r\nDIVA_OS_MEM_DETACH_CTLREG(IoAdapter, p);\r\nDBG_TRC(("stopped processor @ addr 0x%08lx", qBriReset))\r\n}\r\nstatic byte * qBri_check_FPGAsrc (PISDN_ADAPTER IoAdapter, char *FileName,\r\ndword *Length, dword *code) {\r\nbyte *File ;\r\nchar *fpgaFile, *fpgaType, *fpgaDate, *fpgaTime ;\r\ndword fpgaFlen, fpgaTlen, fpgaDlen, cnt, year, i ;\r\nif (!(File = (byte *)xdiLoadFile (FileName, Length, 0))) {\r\nreturn (NULL) ;\r\n}\r\nfor ( i = 0 ; File[i] != 0xff ; )\r\n{\r\nif ( ++i >= *Length )\r\n{\r\nDBG_FTL(("FPGA download: start of data header not found"))\r\nxdiFreeFile (File) ;\r\nreturn (NULL) ;\r\n}\r\n}\r\n*code = i++ ;\r\nif ( (File[i] & 0xF0) != 0x20 )\r\n{\r\nDBG_FTL(("FPGA download: data header corrupted"))\r\nxdiFreeFile (File) ;\r\nreturn (NULL) ;\r\n}\r\nfpgaFlen = (dword) File[FPGA_NAME_OFFSET - 1] ;\r\nif ( fpgaFlen == 0 )\r\nfpgaFlen = 12 ;\r\nfpgaFile = (char *)&File[FPGA_NAME_OFFSET] ;\r\nfpgaTlen = (dword) fpgaFile[fpgaFlen + 2] ;\r\nif ( fpgaTlen == 0 )\r\nfpgaTlen = 10 ;\r\nfpgaType = (char *)&fpgaFile[fpgaFlen + 3] ;\r\nfpgaDlen = (dword) fpgaType[fpgaTlen + 2] ;\r\nif ( fpgaDlen == 0 )\r\nfpgaDlen = 11 ;\r\nfpgaDate = (char *)&fpgaType[fpgaTlen + 3] ;\r\nfpgaTime = (char *)&fpgaDate[fpgaDlen + 3] ;\r\ncnt = (dword)(((File[ i ] & 0x0F) << 20) + (File[i + 1] << 12)\r\n+ (File[i + 2] << 4) + (File[i + 3] >> 4)) ;\r\nif ( (dword)(i + (cnt / 8)) > *Length )\r\n{\r\nDBG_FTL(("FPGA download: '%s' file too small (%ld < %ld)",\r\nFileName, *Length, code + ((cnt + 7) / 8) ))\r\nxdiFreeFile (File) ;\r\nreturn (NULL) ;\r\n}\r\ni = 0 ;\r\ndo\r\n{\r\nwhile ( (fpgaDate[i] != '\0')\r\n&& ((fpgaDate[i] < '0') || (fpgaDate[i] > '9')) )\r\n{\r\ni++;\r\n}\r\nyear = 0 ;\r\nwhile ( (fpgaDate[i] >= '0') && (fpgaDate[i] <= '9') )\r\nyear = year * 10 + (fpgaDate[i++] - '0') ;\r\n} while ( (year < 2000) && (fpgaDate[i] != '\0') );\r\nswitch (IoAdapter->cardType) {\r\ncase CARDTYPE_DIVASRV_B_2F_PCI:\r\nbreak;\r\ndefault:\r\nif ( year >= 2001 ) {\r\nIoAdapter->fpga_features |= PCINIT_FPGA_PLX_ACCESS_SUPPORTED ;\r\n}\r\n}\r\nDBG_LOG(("FPGA[%s] file %s (%s %s) len %d",\r\nfpgaType, fpgaFile, fpgaDate, fpgaTime, cnt))\r\nreturn (File) ;\r\n}\r\nint qBri_FPGA_download (PISDN_ADAPTER IoAdapter) {\r\nint bit ;\r\nbyte *File ;\r\ndword code, FileLength ;\r\nword volatile __iomem *addr = (word volatile __iomem *)DIVA_OS_MEM_ATTACH_PROM(IoAdapter);\r\nword val, baseval = FPGA_CS | FPGA_PROG ;\r\nif (DIVA_4BRI_REVISION(IoAdapter))\r\n{\r\nchar* name;\r\nswitch (IoAdapter->cardType) {\r\ncase CARDTYPE_DIVASRV_B_2F_PCI:\r\nname = "dsbri2f.bit";\r\nbreak;\r\ncase CARDTYPE_DIVASRV_B_2M_V2_PCI:\r\ncase CARDTYPE_DIVASRV_VOICE_B_2M_V2_PCI:\r\nname = "dsbri2m.bit";\r\nbreak;\r\ndefault:\r\nname = "ds4bri2.bit";\r\n}\r\nFile = qBri_check_FPGAsrc (IoAdapter, name,\r\n&FileLength, &code);\r\n}\r\nelse\r\n{\r\nFile = qBri_check_FPGAsrc (IoAdapter, "ds4bri.bit",\r\n&FileLength, &code) ;\r\n}\r\nif ( !File ) {\r\nDIVA_OS_MEM_DETACH_PROM(IoAdapter, addr);\r\nreturn (0) ;\r\n}\r\nWRITE_WORD(addr, baseval & ~FPGA_PROG) ;\r\nWRITE_WORD(addr, baseval) ;\r\ndiva_os_wait (50) ;\r\nif ( READ_WORD(addr) & FPGA_BUSY )\r\n{\r\nDBG_FTL(("FPGA download: acknowledge for FPGA memory clear missing"))\r\nxdiFreeFile (File) ;\r\nDIVA_OS_MEM_DETACH_PROM(IoAdapter, addr);\r\nreturn (0) ;\r\n}\r\nwhile ( code < FileLength )\r\n{\r\nval = ((word)File[code++]) << 3 ;\r\nfor ( bit = 8 ; bit-- > 0 ; val <<= 1 )\r\n{\r\nbaseval &= ~FPGA_DOUT ;\r\nbaseval |= (val & FPGA_DOUT) ;\r\nWRITE_WORD(addr, baseval) ;\r\nWRITE_WORD(addr, baseval | FPGA_CCLK) ;\r\nWRITE_WORD(addr, baseval | FPGA_CCLK) ;\r\nWRITE_WORD(addr, baseval) ;\r\n}\r\n}\r\nxdiFreeFile (File) ;\r\ndiva_os_wait (100) ;\r\nval = READ_WORD(addr) ;\r\nDIVA_OS_MEM_DETACH_PROM(IoAdapter, addr);\r\nif ( !(val & FPGA_BUSY) )\r\n{\r\nDBG_FTL(("FPGA download: chip remains in busy state (0x%04x)", val))\r\nreturn (0) ;\r\n}\r\nreturn (1) ;\r\n}\r\nstatic int load_qBri_hardware (PISDN_ADAPTER IoAdapter) {\r\nreturn (0);\r\n}\r\nstatic int qBri_ISR (struct _ISDN_ADAPTER* IoAdapter) {\r\ndword volatile __iomem *qBriIrq ;\r\nPADAPTER_LIST_ENTRY QuadroList = IoAdapter->QuadroList ;\r\nword i ;\r\nint serviced = 0 ;\r\nbyte __iomem *p;\r\np = DIVA_OS_MEM_ATTACH_RESET(IoAdapter);\r\nif ( !(READ_BYTE(&p[PLX9054_INTCSR]) & 0x80) ) {\r\nDIVA_OS_MEM_DETACH_RESET(IoAdapter, p);\r\nreturn (0) ;\r\n}\r\nDIVA_OS_MEM_DETACH_RESET(IoAdapter, p);\r\np = DIVA_OS_MEM_ATTACH_CTLREG(IoAdapter);\r\nqBriIrq = (dword volatile __iomem *)(&p[DIVA_4BRI_REVISION(IoAdapter) ? (MQ2_BREG_IRQ_TEST) : (MQ_BREG_IRQ_TEST)]);\r\nWRITE_DWORD(qBriIrq, MQ_IRQ_REQ_OFF) ;\r\nDIVA_OS_MEM_DETACH_CTLREG(IoAdapter, p);\r\nfor ( i = 0 ; i < IoAdapter->tasks; ++i )\r\n{\r\nIoAdapter = QuadroList->QuadroAdapter[i] ;\r\nif ( IoAdapter && IoAdapter->Initialized\r\n&& IoAdapter->tst_irq (&IoAdapter->a) )\r\n{\r\nIoAdapter->IrqCount++ ;\r\nserviced = 1 ;\r\ndiva_os_schedule_soft_isr (&IoAdapter->isr_soft_isr);\r\n}\r\n}\r\nreturn (serviced) ;\r\n}\r\nstatic void disable_qBri_interrupt (PISDN_ADAPTER IoAdapter) {\r\ndword volatile __iomem *qBriIrq ;\r\nbyte __iomem *p;\r\nif ( IoAdapter->ControllerNumber > 0 )\r\nreturn ;\r\np = DIVA_OS_MEM_ATTACH_RESET(IoAdapter);\r\nWRITE_BYTE(&p[PLX9054_INTCSR], 0x00);\r\nDIVA_OS_MEM_DETACH_RESET(IoAdapter, p);\r\np = DIVA_OS_MEM_ATTACH_CTLREG(IoAdapter);\r\nqBriIrq = (dword volatile __iomem *)(&p[DIVA_4BRI_REVISION(IoAdapter) ? (MQ2_BREG_IRQ_TEST) : (MQ_BREG_IRQ_TEST)]);\r\nWRITE_DWORD(qBriIrq, MQ_IRQ_REQ_OFF) ;\r\nDIVA_OS_MEM_DETACH_CTLREG(IoAdapter, p);\r\n}\r\nstatic void set_common_qBri_functions (PISDN_ADAPTER IoAdapter) {\r\nADAPTER *a;\r\na = &IoAdapter->a ;\r\na->ram_in = mem_in ;\r\na->ram_inw = mem_inw ;\r\na->ram_in_buffer = mem_in_buffer ;\r\na->ram_look_ahead = mem_look_ahead ;\r\na->ram_out = mem_out ;\r\na->ram_outw = mem_outw ;\r\na->ram_out_buffer = mem_out_buffer ;\r\na->ram_inc = mem_inc ;\r\nIoAdapter->out = pr_out ;\r\nIoAdapter->dpc = pr_dpc ;\r\nIoAdapter->tst_irq = scom_test_int ;\r\nIoAdapter->clr_irq = scom_clear_int ;\r\nIoAdapter->pcm = (struct pc_maint *)MIPS_MAINT_OFFS ;\r\nIoAdapter->load = load_qBri_hardware ;\r\nIoAdapter->disIrq = disable_qBri_interrupt ;\r\nIoAdapter->rstFnc = reset_qBri_hardware ;\r\nIoAdapter->stop = stop_qBri_hardware ;\r\nIoAdapter->trapFnc = qBri_cpu_trapped ;\r\nIoAdapter->diva_isr_handler = qBri_ISR;\r\nIoAdapter->a.io = (void*)IoAdapter ;\r\n}\r\nstatic void set_qBri_functions (PISDN_ADAPTER IoAdapter) {\r\nif (!IoAdapter->tasks) {\r\nIoAdapter->tasks = MQ_INSTANCE_COUNT;\r\n}\r\nIoAdapter->MemorySize = MQ_MEMORY_SIZE ;\r\nset_common_qBri_functions (IoAdapter) ;\r\ndiva_os_set_qBri_functions (IoAdapter) ;\r\n}\r\nstatic void set_qBri2_functions (PISDN_ADAPTER IoAdapter) {\r\nif (!IoAdapter->tasks) {\r\nIoAdapter->tasks = MQ_INSTANCE_COUNT;\r\n}\r\nIoAdapter->MemorySize = (IoAdapter->tasks == 1) ? BRI2_MEMORY_SIZE : MQ2_MEMORY_SIZE;\r\nset_common_qBri_functions (IoAdapter) ;\r\ndiva_os_set_qBri2_functions (IoAdapter) ;\r\n}\r\nvoid prepare_qBri_functions (PISDN_ADAPTER IoAdapter) {\r\nset_qBri_functions (IoAdapter->QuadroList->QuadroAdapter[0]) ;\r\nset_qBri_functions (IoAdapter->QuadroList->QuadroAdapter[1]) ;\r\nset_qBri_functions (IoAdapter->QuadroList->QuadroAdapter[2]) ;\r\nset_qBri_functions (IoAdapter->QuadroList->QuadroAdapter[3]) ;\r\n}\r\nvoid prepare_qBri2_functions (PISDN_ADAPTER IoAdapter) {\r\nif (!IoAdapter->tasks) {\r\nIoAdapter->tasks = MQ_INSTANCE_COUNT;\r\n}\r\nset_qBri2_functions (IoAdapter->QuadroList->QuadroAdapter[0]) ;\r\nif (IoAdapter->tasks > 1) {\r\nset_qBri2_functions (IoAdapter->QuadroList->QuadroAdapter[1]) ;\r\nset_qBri2_functions (IoAdapter->QuadroList->QuadroAdapter[2]) ;\r\nset_qBri2_functions (IoAdapter->QuadroList->QuadroAdapter[3]) ;\r\n}\r\n}

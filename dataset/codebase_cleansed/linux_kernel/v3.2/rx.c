static void wl1251_rx_header(struct wl1251 *wl,\r\nstruct wl1251_rx_descriptor *desc)\r\n{\r\nu32 rx_packet_ring_addr;\r\nrx_packet_ring_addr = wl->data_path->rx_packet_ring_addr;\r\nif (wl->rx_current_buffer)\r\nrx_packet_ring_addr += wl->data_path->rx_packet_ring_chunk_size;\r\nwl1251_mem_read(wl, rx_packet_ring_addr, desc, sizeof(*desc));\r\n}\r\nstatic void wl1251_rx_status(struct wl1251 *wl,\r\nstruct wl1251_rx_descriptor *desc,\r\nstruct ieee80211_rx_status *status,\r\nu8 beacon)\r\n{\r\nu64 mactime;\r\nint ret;\r\nmemset(status, 0, sizeof(struct ieee80211_rx_status));\r\nstatus->band = IEEE80211_BAND_2GHZ;\r\nstatus->mactime = desc->timestamp;\r\nif ((wl->bss_type == BSS_TYPE_IBSS) && beacon) {\r\nret = wl1251_acx_tsf_info(wl, &mactime);\r\nif (ret == 0)\r\nstatus->mactime = mactime;\r\n}\r\nstatus->signal = desc->rssi;\r\nwl->noise = desc->rssi - desc->snr / 2;\r\nstatus->freq = ieee80211_channel_to_frequency(desc->channel,\r\nstatus->band);\r\nstatus->flag |= RX_FLAG_MACTIME_MPDU;\r\nif (desc->flags & RX_DESC_ENCRYPTION_MASK) {\r\nstatus->flag |= RX_FLAG_IV_STRIPPED | RX_FLAG_MMIC_STRIPPED;\r\nif (likely(!(desc->flags & RX_DESC_DECRYPT_FAIL)))\r\nstatus->flag |= RX_FLAG_DECRYPTED;\r\nif (unlikely(desc->flags & RX_DESC_MIC_FAIL))\r\nstatus->flag |= RX_FLAG_MMIC_ERROR;\r\n}\r\nif (unlikely(!(desc->flags & RX_DESC_VALID_FCS)))\r\nstatus->flag |= RX_FLAG_FAILED_FCS_CRC;\r\nswitch (desc->rate) {\r\ncase RATE_2MBPS:\r\nstatus->rate_idx = 1;\r\nbreak;\r\ncase RATE_5_5MBPS:\r\nstatus->rate_idx = 2;\r\nbreak;\r\ncase RATE_11MBPS:\r\nstatus->rate_idx = 3;\r\nbreak;\r\ncase RATE_6MBPS:\r\nstatus->rate_idx = 4;\r\nbreak;\r\ncase RATE_9MBPS:\r\nstatus->rate_idx = 5;\r\nbreak;\r\ncase RATE_18MBPS:\r\nstatus->rate_idx = 7;\r\nbreak;\r\ncase RATE_24MBPS:\r\nstatus->rate_idx = 8;\r\nbreak;\r\ncase RATE_36MBPS:\r\nstatus->rate_idx = 9;\r\nbreak;\r\ncase RATE_48MBPS:\r\nstatus->rate_idx = 10;\r\nbreak;\r\ncase RATE_54MBPS:\r\nstatus->rate_idx = 11;\r\nbreak;\r\n}\r\nif (desc->rate == RATE_1MBPS) {\r\nif (!(desc->mod_pre & OFDM_RATE_BIT))\r\nstatus->rate_idx = 0;\r\nelse\r\nstatus->rate_idx = 6;\r\n}\r\nif (desc->mod_pre & SHORT_PREAMBLE_BIT)\r\nstatus->flag |= RX_FLAG_SHORTPRE;\r\n}\r\nstatic void wl1251_rx_body(struct wl1251 *wl,\r\nstruct wl1251_rx_descriptor *desc)\r\n{\r\nstruct sk_buff *skb;\r\nstruct ieee80211_rx_status status;\r\nu8 *rx_buffer, beacon = 0;\r\nu16 length, *fc;\r\nu32 curr_id, last_id_inc, rx_packet_ring_addr;\r\nlength = WL1251_RX_ALIGN(desc->length - PLCP_HEADER_LENGTH);\r\ncurr_id = (desc->flags & RX_DESC_SEQNUM_MASK) >> RX_DESC_PACKETID_SHIFT;\r\nlast_id_inc = (wl->rx_last_id + 1) % (RX_MAX_PACKET_ID + 1);\r\nif (last_id_inc != curr_id) {\r\nwl1251_warning("curr ID:%d, last ID inc:%d",\r\ncurr_id, last_id_inc);\r\nwl->rx_last_id = curr_id;\r\n} else {\r\nwl->rx_last_id = last_id_inc;\r\n}\r\nrx_packet_ring_addr = wl->data_path->rx_packet_ring_addr +\r\nsizeof(struct wl1251_rx_descriptor) + 20;\r\nif (wl->rx_current_buffer)\r\nrx_packet_ring_addr += wl->data_path->rx_packet_ring_chunk_size;\r\nskb = __dev_alloc_skb(length, GFP_KERNEL);\r\nif (!skb) {\r\nwl1251_error("Couldn't allocate RX frame");\r\nreturn;\r\n}\r\nrx_buffer = skb_put(skb, length);\r\nwl1251_mem_read(wl, rx_packet_ring_addr, rx_buffer, length);\r\nskb->len = desc->length - PLCP_HEADER_LENGTH;\r\nfc = (u16 *)skb->data;\r\nif ((*fc & IEEE80211_FCTL_STYPE) == IEEE80211_STYPE_BEACON)\r\nbeacon = 1;\r\nwl1251_rx_status(wl, desc, &status, beacon);\r\nwl1251_debug(DEBUG_RX, "rx skb 0x%p: %d B %s", skb, skb->len,\r\nbeacon ? "beacon" : "");\r\nmemcpy(IEEE80211_SKB_RXCB(skb), &status, sizeof(status));\r\nieee80211_rx_ni(wl->hw, skb);\r\n}\r\nstatic void wl1251_rx_ack(struct wl1251 *wl)\r\n{\r\nu32 data, addr;\r\nif (wl->rx_current_buffer) {\r\naddr = ACX_REG_INTERRUPT_TRIG_H;\r\ndata = INTR_TRIG_RX_PROC1;\r\n} else {\r\naddr = ACX_REG_INTERRUPT_TRIG;\r\ndata = INTR_TRIG_RX_PROC0;\r\n}\r\nwl1251_reg_write32(wl, addr, data);\r\nwl->rx_current_buffer = !wl->rx_current_buffer;\r\n}\r\nvoid wl1251_rx(struct wl1251 *wl)\r\n{\r\nstruct wl1251_rx_descriptor *rx_desc;\r\nif (wl->state != WL1251_STATE_ON)\r\nreturn;\r\nrx_desc = wl->rx_descriptor;\r\nwl1251_rx_header(wl, rx_desc);\r\nwl1251_rx_body(wl, rx_desc);\r\nwl1251_rx_ack(wl);\r\n}

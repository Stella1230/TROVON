struct videocodec *\r\nvideocodec_attach (struct videocodec_master *master)\r\n{\r\nstruct codec_list *h = codeclist_top;\r\nstruct attached_list *a, *ptr;\r\nstruct videocodec *codec;\r\nint res;\r\nif (!master) {\r\ndprintk(1, KERN_ERR "videocodec_attach: no data\n");\r\nreturn NULL;\r\n}\r\ndprintk(2,\r\n"videocodec_attach: '%s', flags %lx, magic %lx\n",\r\nmaster->name, master->flags, master->magic);\r\nif (!h) {\r\ndprintk(1,\r\nKERN_ERR\r\n"videocodec_attach: no device available\n");\r\nreturn NULL;\r\n}\r\nwhile (h) {\r\nif ((master->flags & h->codec->flags) == master->flags) {\r\ndprintk(4, "videocodec_attach: try '%s'\n",\r\nh->codec->name);\r\nif (!try_module_get(h->codec->owner))\r\nreturn NULL;\r\ncodec = kmemdup(h->codec, sizeof(struct videocodec),\r\nGFP_KERNEL);\r\nif (!codec) {\r\ndprintk(1,\r\nKERN_ERR\r\n"videocodec_attach: no mem\n");\r\ngoto out_module_put;\r\n}\r\nsnprintf(codec->name, sizeof(codec->name),\r\n"%s[%d]", codec->name, h->attached);\r\ncodec->master_data = master;\r\nres = codec->setup(codec);\r\nif (res == 0) {\r\ndprintk(3, "videocodec_attach '%s'\n",\r\ncodec->name);\r\nptr = kzalloc(sizeof(struct attached_list), GFP_KERNEL);\r\nif (!ptr) {\r\ndprintk(1,\r\nKERN_ERR\r\n"videocodec_attach: no memory\n");\r\ngoto out_kfree;\r\n}\r\nptr->codec = codec;\r\na = h->list;\r\nif (!a) {\r\nh->list = ptr;\r\ndprintk(4,\r\n"videocodec: first element\n");\r\n} else {\r\nwhile (a->next)\r\na = a->next;\r\na->next = ptr;\r\ndprintk(4,\r\n"videocodec: in after '%s'\n",\r\nh->codec->name);\r\n}\r\nh->attached += 1;\r\nreturn codec;\r\n} else {\r\nkfree(codec);\r\n}\r\n}\r\nh = h->next;\r\n}\r\ndprintk(1, KERN_ERR "videocodec_attach: no codec found!\n");\r\nreturn NULL;\r\nout_module_put:\r\nmodule_put(h->codec->owner);\r\nout_kfree:\r\nkfree(codec);\r\nreturn NULL;\r\n}\r\nint\r\nvideocodec_detach (struct videocodec *codec)\r\n{\r\nstruct codec_list *h = codeclist_top;\r\nstruct attached_list *a, *prev;\r\nint res;\r\nif (!codec) {\r\ndprintk(1, KERN_ERR "videocodec_detach: no data\n");\r\nreturn -EINVAL;\r\n}\r\ndprintk(2,\r\n"videocodec_detach: '%s', type: %x, flags %lx, magic %lx\n",\r\ncodec->name, codec->type, codec->flags, codec->magic);\r\nif (!h) {\r\ndprintk(1,\r\nKERN_ERR "videocodec_detach: no device left...\n");\r\nreturn -ENXIO;\r\n}\r\nwhile (h) {\r\na = h->list;\r\nprev = NULL;\r\nwhile (a) {\r\nif (codec == a->codec) {\r\nres = a->codec->unset(a->codec);\r\nif (res >= 0) {\r\ndprintk(3,\r\n"videocodec_detach: '%s'\n",\r\na->codec->name);\r\na->codec->master_data = NULL;\r\n} else {\r\ndprintk(1,\r\nKERN_ERR\r\n"videocodec_detach: '%s'\n",\r\na->codec->name);\r\na->codec->master_data = NULL;\r\n}\r\nif (prev == NULL) {\r\nh->list = a->next;\r\ndprintk(4,\r\n"videocodec: delete first\n");\r\n} else {\r\nprev->next = a->next;\r\ndprintk(4,\r\n"videocodec: delete middle\n");\r\n}\r\nmodule_put(a->codec->owner);\r\nkfree(a->codec);\r\nkfree(a);\r\nh->attached -= 1;\r\nreturn 0;\r\n}\r\nprev = a;\r\na = a->next;\r\n}\r\nh = h->next;\r\n}\r\ndprintk(1, KERN_ERR "videocodec_detach: given codec not found!\n");\r\nreturn -EINVAL;\r\n}\r\nint\r\nvideocodec_register (const struct videocodec *codec)\r\n{\r\nstruct codec_list *ptr, *h = codeclist_top;\r\nif (!codec) {\r\ndprintk(1, KERN_ERR "videocodec_register: no data!\n");\r\nreturn -EINVAL;\r\n}\r\ndprintk(2,\r\n"videocodec: register '%s', type: %x, flags %lx, magic %lx\n",\r\ncodec->name, codec->type, codec->flags, codec->magic);\r\nptr = kzalloc(sizeof(struct codec_list), GFP_KERNEL);\r\nif (!ptr) {\r\ndprintk(1, KERN_ERR "videocodec_register: no memory\n");\r\nreturn -ENOMEM;\r\n}\r\nptr->codec = codec;\r\nif (!h) {\r\ncodeclist_top = ptr;\r\ndprintk(4, "videocodec: hooked in as first element\n");\r\n} else {\r\nwhile (h->next)\r\nh = h->next;\r\nh->next = ptr;\r\ndprintk(4, "videocodec: hooked in after '%s'\n",\r\nh->codec->name);\r\n}\r\nreturn 0;\r\n}\r\nint\r\nvideocodec_unregister (const struct videocodec *codec)\r\n{\r\nstruct codec_list *prev = NULL, *h = codeclist_top;\r\nif (!codec) {\r\ndprintk(1, KERN_ERR "videocodec_unregister: no data!\n");\r\nreturn -EINVAL;\r\n}\r\ndprintk(2,\r\n"videocodec: unregister '%s', type: %x, flags %lx, magic %lx\n",\r\ncodec->name, codec->type, codec->flags, codec->magic);\r\nif (!h) {\r\ndprintk(1,\r\nKERN_ERR\r\n"videocodec_unregister: no device left...\n");\r\nreturn -ENXIO;\r\n}\r\nwhile (h) {\r\nif (codec == h->codec) {\r\nif (h->attached) {\r\ndprintk(1,\r\nKERN_ERR\r\n"videocodec: '%s' is used\n",\r\nh->codec->name);\r\nreturn -EBUSY;\r\n}\r\ndprintk(3, "videocodec: unregister '%s' is ok.\n",\r\nh->codec->name);\r\nif (prev == NULL) {\r\ncodeclist_top = h->next;\r\ndprintk(4,\r\n"videocodec: delete first element\n");\r\n} else {\r\nprev->next = h->next;\r\ndprintk(4,\r\n"videocodec: delete middle element\n");\r\n}\r\nkfree(h);\r\nreturn 0;\r\n}\r\nprev = h;\r\nh = h->next;\r\n}\r\ndprintk(1,\r\nKERN_ERR\r\n"videocodec_unregister: given codec not found!\n");\r\nreturn -EINVAL;\r\n}\r\nstatic int proc_videocodecs_show(struct seq_file *m, void *v)\r\n{\r\nstruct codec_list *h = codeclist_top;\r\nstruct attached_list *a;\r\nseq_printf(m, "<S>lave or attached <M>aster name type flags magic ");\r\nseq_printf(m, "(connected as)\n");\r\nh = codeclist_top;\r\nwhile (h) {\r\nseq_printf(m, "S %32s %04x %08lx %08lx (TEMPLATE)\n",\r\nh->codec->name, h->codec->type,\r\nh->codec->flags, h->codec->magic);\r\na = h->list;\r\nwhile (a) {\r\nseq_printf(m, "M %32s %04x %08lx %08lx (%s)\n",\r\na->codec->master_data->name,\r\na->codec->master_data->type,\r\na->codec->master_data->flags,\r\na->codec->master_data->magic,\r\na->codec->name);\r\na = a->next;\r\n}\r\nh = h->next;\r\n}\r\nreturn 0;\r\n}\r\nstatic int proc_videocodecs_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, proc_videocodecs_show, NULL);\r\n}\r\nstatic int __init\r\nvideocodec_init (void)\r\n{\r\n#ifdef CONFIG_PROC_FS\r\nstatic struct proc_dir_entry *videocodec_proc_entry;\r\n#endif\r\nprintk(KERN_INFO "Linux video codec intermediate layer: %s\n",\r\nVIDEOCODEC_VERSION);\r\n#ifdef CONFIG_PROC_FS\r\nvideocodec_proc_entry = proc_create("videocodecs", 0, NULL, &videocodecs_proc_fops);\r\nif (!videocodec_proc_entry) {\r\ndprintk(1, KERN_ERR "videocodec: can't init procfs.\n");\r\n}\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void __exit\r\nvideocodec_exit (void)\r\n{\r\n#ifdef CONFIG_PROC_FS\r\nremove_proc_entry("videocodecs", NULL);\r\n#endif\r\n}

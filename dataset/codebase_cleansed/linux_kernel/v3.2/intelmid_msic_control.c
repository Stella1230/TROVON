static int msic_init_card(void)\r\n{\r\nstruct sc_reg_access sc_access[] = {\r\n{0x241, 0x85, 0},\r\n{0x242, 0x02, 0},\r\n{0x24C, 0x10, 0},\r\n{0x24D, 0x32, 0},\r\n{0x272, 0x10, 0},\r\n{0x273, 0x32, 0},\r\n{0x274, 0xFF, 0},\r\n{0x275, 0x10, 0},\r\n{0x276, 0x32, 0},\r\n{0x277, 0x54, 0},\r\n{0x24E, 0x28, 0},\r\n{0x384, 0x80, 0},\r\n{0x385, 0x80, 0},\r\n{0x267, 0x00, 0},\r\n{0x261, 0x00, 0},\r\n{0x278, 0x00, 0},\r\n{0x27B, 0x01, 0},\r\n{0x27C, 0x0a, 0},\r\n{0x259, 0x08, 0},\r\n{0x25A, 0x08, 0},\r\n{0x25B, 0x08, 0},\r\n{0x25C, 0x08, 0},\r\n{0x250, 0x30, 0},\r\n{0x256, 0x11, 0},\r\n{0x249, 0x01, 0x0},\r\n{0x24A, 0x01, 0x0},\r\n{0x1d, 0x00, 0x00},\r\n{0x1e, 0x00, 0x00},\r\n};\r\nsnd_msic_ops.card_status = SND_CARD_INIT_DONE;\r\nsst_sc_reg_access(sc_access, PMIC_WRITE, 28);\r\nsnd_msic_ops.pb_on = 0;\r\nsnd_msic_ops.pbhs_on = 0;\r\nsnd_msic_ops.cap_on = 0;\r\nsnd_msic_ops.input_dev_id = DMIC;\r\nsnd_msic_ops.output_dev_id = STEREO_HEADPHONE;\r\nsnd_msic_ops.jack_interrupt_status = false;\r\npr_debug("msic init complete!!\n");\r\nreturn 0;\r\n}\r\nstatic int msic_line_out_restore(u8 value)\r\n{\r\nstruct sc_reg_access hs_drv_en[] = {\r\n{0x25d, 0x03, 0x03},\r\n};\r\nstruct sc_reg_access ep_drv_en[] = {\r\n{0x25d, 0x40, 0x40},\r\n};\r\nstruct sc_reg_access ihf_drv_en[] = {\r\n{0x25d, 0x0c, 0x0c},\r\n};\r\nstruct sc_reg_access vib1_drv_en[] = {\r\n{0x25d, 0x10, 0x10},\r\n};\r\nstruct sc_reg_access vib2_drv_en[] = {\r\n{0x25d, 0x20, 0x20},\r\n};\r\nstruct sc_reg_access pmode_enable[] = {\r\n{0x381, 0x10, 0x10},\r\n};\r\nint retval = 0;\r\npr_debug("msic_lineout_restore_lineout_dev:%d\n", value);\r\nswitch (value) {\r\ncase HEADSET:\r\npr_debug("Selecting Lineout-HEADSET-restore\n");\r\nif (snd_msic_ops.output_dev_id == STEREO_HEADPHONE)\r\nretval = sst_sc_reg_access(hs_drv_en,\r\nPMIC_READ_MODIFY, 1);\r\nelse\r\nretval = sst_sc_reg_access(ep_drv_en,\r\nPMIC_READ_MODIFY, 1);\r\nbreak;\r\ncase IHF:\r\npr_debug("Selecting Lineout-IHF-restore\n");\r\nretval = sst_sc_reg_access(ihf_drv_en, PMIC_READ_MODIFY, 1);\r\nif (retval)\r\nreturn retval;\r\nretval = sst_sc_reg_access(pmode_enable, PMIC_READ_MODIFY, 1);\r\nbreak;\r\ncase VIBRA1:\r\npr_debug("Selecting Lineout-Vibra1-restore\n");\r\nretval = sst_sc_reg_access(vib1_drv_en, PMIC_READ_MODIFY, 1);\r\nbreak;\r\ncase VIBRA2:\r\npr_debug("Selecting Lineout-VIBRA2-restore\n");\r\nretval = sst_sc_reg_access(vib2_drv_en, PMIC_READ_MODIFY, 1);\r\nbreak;\r\ncase NONE:\r\npr_debug("Selecting Lineout-NONE-restore\n");\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn retval;\r\n}\r\nstatic int msic_get_lineout_prvstate(void)\r\n{\r\nstruct sc_reg_access hs_ihf_drv[2] = {\r\n{0x257, 0x0, 0x0},\r\n{0x25d, 0x0, 0x0},\r\n};\r\nstruct sc_reg_access vib1drv[2] = {\r\n{0x264, 0x0, 0x0},\r\n{0x25D, 0x0, 0x0},\r\n};\r\nstruct sc_reg_access vib2drv[2] = {\r\n{0x26A, 0x0, 0x0},\r\n{0x25D, 0x0, 0x0},\r\n};\r\nint retval = 0, drv_en, dac_en, dev_id, mask;\r\nfor (dev_id = 0; dev_id < snd_msic_ops.line_out_names_cnt; dev_id++) {\r\nswitch (dev_id) {\r\ncase HEADSET:\r\npr_debug("msic_get_lineout_prvs_state: HEADSET\n");\r\nsst_sc_reg_access(hs_ihf_drv, PMIC_READ, 2);\r\nmask = (MASK0|MASK1);\r\ndac_en = (hs_ihf_drv[0].value) & mask;\r\nmask = ((MASK0|MASK1)|MASK6);\r\ndrv_en = (hs_ihf_drv[1].value) & mask;\r\nif (dac_en && (!drv_en)) {\r\nsnd_msic_ops.prev_lineout_dev_id = HEADSET;\r\nreturn retval;\r\n}\r\nbreak;\r\ncase IHF:\r\npr_debug("msic_get_lineout_prvstate: IHF\n");\r\nsst_sc_reg_access(hs_ihf_drv, PMIC_READ, 2);\r\nmask = (MASK2 | MASK3);\r\ndac_en = (hs_ihf_drv[0].value) & mask;\r\nmask = (MASK2 | MASK3);\r\ndrv_en = (hs_ihf_drv[1].value) & mask;\r\nif (dac_en && (!drv_en)) {\r\nsnd_msic_ops.prev_lineout_dev_id = IHF;\r\nreturn retval;\r\n}\r\nbreak;\r\ncase VIBRA1:\r\npr_debug("msic_get_lineout_prvstate: vibra1\n");\r\nsst_sc_reg_access(vib1drv, PMIC_READ, 2);\r\nmask = MASK1;\r\ndac_en = (vib1drv[0].value) & mask;\r\nmask = MASK4;\r\ndrv_en = (vib1drv[1].value) & mask;\r\nif (dac_en && (!drv_en)) {\r\nsnd_msic_ops.prev_lineout_dev_id = VIBRA1;\r\nreturn retval;\r\n}\r\nbreak;\r\ncase VIBRA2:\r\npr_debug("msic_get_lineout_prvstate: vibra2\n");\r\nsst_sc_reg_access(vib2drv, PMIC_READ, 2);\r\nmask = MASK1;\r\ndac_en = (vib2drv[0].value) & mask;\r\nmask = MASK5;\r\ndrv_en = ((vib2drv[1].value) & mask);\r\nif (dac_en && (!drv_en)) {\r\nsnd_msic_ops.prev_lineout_dev_id = VIBRA2;\r\nreturn retval;\r\n}\r\nbreak;\r\ncase NONE:\r\npr_debug("msic_get_lineout_prvstate: NONE\n");\r\nsnd_msic_ops.prev_lineout_dev_id = NONE;\r\nreturn retval;\r\ndefault:\r\npr_debug("Invalid device id\n");\r\nsnd_msic_ops.prev_lineout_dev_id = NONE;\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn retval;\r\n}\r\nstatic int msic_set_selected_lineout_dev(u8 value)\r\n{\r\nstruct sc_reg_access lout_hs[] = {\r\n{0x25e, 0x33, 0xFF},\r\n{0x25d, 0x0, 0x43},\r\n};\r\nstruct sc_reg_access lout_ihf[] = {\r\n{0x25e, 0x55, 0xff},\r\n{0x25d, 0x0, 0x0c},\r\n};\r\nstruct sc_reg_access lout_vibra1[] = {\r\n{0x25e, 0x61, 0xff},\r\n{0x25d, 0x0, 0x10},\r\n};\r\nstruct sc_reg_access lout_vibra2[] = {\r\n{0x25e, 0x16, 0xff},\r\n{0x25d, 0x0, 0x20},\r\n};\r\nstruct sc_reg_access lout_def[] = {\r\n{0x25e, 0x66, 0x0},\r\n};\r\nstruct sc_reg_access pmode_disable[] = {\r\n{0x381, 0x00, 0x10},\r\n};\r\nstruct sc_reg_access pmode_enable[] = {\r\n{0x381, 0x10, 0x10},\r\n};\r\nint retval = 0;\r\npr_debug("msic_set_selected_lineout_dev:%d\n", value);\r\nmsic_get_lineout_prvstate();\r\nmsic_line_out_restore(snd_msic_ops.prev_lineout_dev_id);\r\nsnd_msic_ops.lineout_dev_id = value;\r\nswitch (value) {\r\ncase HEADSET:\r\npr_debug("Selecting Lineout-HEADSET\n");\r\nif (snd_msic_ops.pb_on)\r\nretval = sst_sc_reg_access(lout_hs,\r\nPMIC_READ_MODIFY, 2);\r\nif (retval)\r\nreturn retval;\r\nretval = sst_sc_reg_access(pmode_disable,\r\nPMIC_READ_MODIFY, 1);\r\nbreak;\r\ncase IHF:\r\npr_debug("Selecting Lineout-IHF\n");\r\nif (snd_msic_ops.pb_on)\r\nretval = sst_sc_reg_access(lout_ihf,\r\nPMIC_READ_MODIFY, 2);\r\nif (retval)\r\nreturn retval;\r\nretval = sst_sc_reg_access(pmode_enable,\r\nPMIC_READ_MODIFY, 1);\r\nbreak;\r\ncase VIBRA1:\r\npr_debug("Selecting Lineout-Vibra1\n");\r\nif (snd_msic_ops.pb_on)\r\nretval = sst_sc_reg_access(lout_vibra1,\r\nPMIC_READ_MODIFY, 2);\r\nif (retval)\r\nreturn retval;\r\nretval = sst_sc_reg_access(pmode_disable,\r\nPMIC_READ_MODIFY, 1);\r\nbreak;\r\ncase VIBRA2:\r\npr_debug("Selecting Lineout-VIBRA2\n");\r\nif (snd_msic_ops.pb_on)\r\nretval = sst_sc_reg_access(lout_vibra2,\r\nPMIC_READ_MODIFY, 2);\r\nif (retval)\r\nreturn retval;\r\nretval = sst_sc_reg_access(pmode_disable,\r\nPMIC_READ_MODIFY, 1);\r\nbreak;\r\ncase NONE:\r\npr_debug("Selecting Lineout-NONE\n");\r\nretval = sst_sc_reg_access(lout_def,\r\nPMIC_WRITE, 1);\r\nif (retval)\r\nreturn retval;\r\nretval = sst_sc_reg_access(pmode_disable,\r\nPMIC_READ_MODIFY, 1);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn retval;\r\n}\r\nstatic int msic_power_up_pb(unsigned int device)\r\n{\r\nstruct sc_reg_access vaud[] = {\r\n{0x0DB, 0x07, 0},\r\n};\r\nstruct sc_reg_access pll[] = {\r\n{0x240, 0x20, 0},\r\n};\r\nstruct sc_reg_access vhs[] = {\r\n{0x0DC, 0x3D, 0},\r\n{0x0DD, 0x3F, 0},\r\n};\r\nstruct sc_reg_access hsdac[] = {\r\n{0x382, 0x40, 0x40},\r\n{0x25D, 0x0, 0x43},\r\n{0x257, 0x03, 0x03},\r\n};\r\nstruct sc_reg_access hs_filter[] = {\r\n{0x250, 0x30, 0},\r\n{0x256, 0x11, 0},\r\n};\r\nstruct sc_reg_access hs_enable[] = {\r\n{0x25D, 0x3, 0x3},\r\n{0x26C, 0x0, 0x2},\r\n{ 0x259, 0x80, 0x80},\r\n{ 0x25A, 0x80, 0x80},\r\n};\r\nstruct sc_reg_access vihf[] = {\r\n{0x0C9, 0x27, 0x00},\r\n};\r\nstruct sc_reg_access ihf_filter[] = {\r\n{0x25D, 0x00, 0x0C},\r\n{0x251, 0x03, 0x03},\r\n{0x257, 0x0C, 0x0C},\r\n};\r\nstruct sc_reg_access ihf_en[] = {\r\n{0x25D, 0x0C, 0x0c},\r\n};\r\nstruct sc_reg_access ihf_unmute[] = {\r\n{0x25B, 0x80, 0x80},\r\n{0x25C, 0x80, 0x80},\r\n};\r\nstruct sc_reg_access epdac[] = {\r\n{0x25D, 0x0, 0x43},\r\n{0x257, 0x03, 0x03},\r\n};\r\nstruct sc_reg_access ep_enable[] = {\r\n{0x25D, 0x40, 0x40},\r\n{ 0x259, 0x80, 0x80},\r\n{ 0x25A, 0x80, 0x80},\r\n};\r\nstruct sc_reg_access vib1_en[] = {\r\n{0x25D, 0x10, 0x10},\r\n{0x264, 0x02, 0x82},\r\n};\r\nstruct sc_reg_access vib2_en[] = {\r\n{0x25D, 0x20, 0x20},\r\n{0x26A, 0x02, 0x82},\r\n};\r\nstruct sc_reg_access pcm2_en[] = {\r\n{0x27C, 0x1, 0x1},\r\n};\r\nint retval = 0;\r\nif (snd_msic_ops.card_status == SND_CARD_UN_INIT) {\r\nretval = msic_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\npr_debug("powering up pb.... Device %d\n", device);\r\nsst_sc_reg_access(vaud, PMIC_WRITE, 1);\r\nmsleep(1);\r\nsst_sc_reg_access(pll, PMIC_WRITE, 1);\r\nmsleep(1);\r\nswitch (device) {\r\ncase SND_SST_DEVICE_HEADSET:\r\nsnd_msic_ops.pb_on = 1;\r\nsnd_msic_ops.pbhs_on = 1;\r\nif (snd_msic_ops.output_dev_id == STEREO_HEADPHONE) {\r\nsst_sc_reg_access(vhs, PMIC_WRITE, 2);\r\nsst_sc_reg_access(hsdac, PMIC_READ_MODIFY, 3);\r\nsst_sc_reg_access(hs_filter, PMIC_WRITE, 2);\r\nsst_sc_reg_access(hs_enable, PMIC_READ_MODIFY, 4);\r\n} else {\r\nsst_sc_reg_access(epdac, PMIC_READ_MODIFY, 2);\r\nsst_sc_reg_access(hs_filter, PMIC_WRITE, 2);\r\nsst_sc_reg_access(ep_enable, PMIC_READ_MODIFY, 3);\r\n}\r\nif (snd_msic_ops.lineout_dev_id == HEADSET)\r\nmsic_set_selected_lineout_dev(HEADSET);\r\nbreak;\r\ncase SND_SST_DEVICE_IHF:\r\nsnd_msic_ops.pb_on = 1;\r\nsst_sc_reg_access(vihf, PMIC_WRITE, 1);\r\nsst_sc_reg_access(ihf_filter, PMIC_READ_MODIFY, 3);\r\nsst_sc_reg_access(ihf_en, PMIC_READ_MODIFY, 1);\r\nsst_sc_reg_access(ihf_unmute, PMIC_READ_MODIFY, 2);\r\nif (snd_msic_ops.lineout_dev_id == IHF)\r\nmsic_set_selected_lineout_dev(IHF);\r\nbreak;\r\ncase SND_SST_DEVICE_VIBRA:\r\nsnd_msic_ops.pb_on = 1;\r\nsst_sc_reg_access(vib1_en, PMIC_READ_MODIFY, 2);\r\nif (snd_msic_ops.lineout_dev_id == VIBRA1)\r\nmsic_set_selected_lineout_dev(VIBRA1);\r\nbreak;\r\ncase SND_SST_DEVICE_HAPTIC:\r\nsnd_msic_ops.pb_on = 1;\r\nsst_sc_reg_access(vib2_en, PMIC_READ_MODIFY, 2);\r\nif (snd_msic_ops.lineout_dev_id == VIBRA2)\r\nmsic_set_selected_lineout_dev(VIBRA2);\r\nbreak;\r\ndefault:\r\npr_warn("Wrong Device %d, selected %d\n",\r\ndevice, snd_msic_ops.output_dev_id);\r\n}\r\nreturn sst_sc_reg_access(pcm2_en, PMIC_READ_MODIFY, 1);\r\n}\r\nstatic int msic_power_up_cp(unsigned int device)\r\n{\r\nstruct sc_reg_access vaud[] = {\r\n{0x0DB, 0x07, 0},\r\n};\r\nstruct sc_reg_access pll[] = {\r\n{0x240, 0x20, 0},\r\n};\r\nstruct sc_reg_access dmic_bias[] = {\r\n{0x247, 0xA0, 0xA0},\r\n};\r\nstruct sc_reg_access dmic[] = {\r\n{0x245, 0x3F, 0x3F},\r\n{0x246, 0x07, 0x07},\r\n};\r\nstruct sc_reg_access amic_bias[] = {\r\n{0x247, 0xFC, 0xFC},\r\n};\r\nstruct sc_reg_access amic[] = {\r\n{0x249, 0x01, 0x01},\r\n{0x24A, 0x01, 0x01},\r\n{0x248, 0x05, 0x0F},\r\n};\r\nstruct sc_reg_access pcm2[] = {\r\n{0x27C, 0x1, 0x1},\r\n};\r\nstruct sc_reg_access tx_on[] = {\r\n{0x24F, 0x3C, 0x0},\r\n};\r\nint retval = 0;\r\nif (snd_msic_ops.card_status == SND_CARD_UN_INIT) {\r\nretval = msic_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\npr_debug("powering up cp....%d\n", snd_msic_ops.input_dev_id);\r\nsst_sc_reg_access(vaud, PMIC_WRITE, 1);\r\nmsleep(500);\r\nsst_sc_reg_access(pll, PMIC_WRITE, 1);\r\nmsleep(1);\r\nsnd_msic_ops.cap_on = 1;\r\nif (snd_msic_ops.input_dev_id == AMIC) {\r\nsst_sc_reg_access(amic_bias, PMIC_READ_MODIFY, 1);\r\nmsleep(1);\r\nsst_sc_reg_access(amic, PMIC_READ_MODIFY, 3);\r\n} else {\r\nsst_sc_reg_access(dmic_bias, PMIC_READ_MODIFY, 1);\r\nmsleep(1);\r\nsst_sc_reg_access(dmic, PMIC_READ_MODIFY, 2);\r\n}\r\nmsleep(1);\r\nsst_sc_reg_access(tx_on, PMIC_WRITE, 1);\r\nreturn sst_sc_reg_access(pcm2, PMIC_READ_MODIFY, 1);\r\n}\r\nstatic int msic_power_down(void)\r\n{\r\nstruct sc_reg_access power_dn[] = {\r\n{0x0DC, 0xC4, 0},\r\n{0x0DD, 0x04, 0},\r\n{0x0C9, 0x24, 0},\r\n};\r\nstruct sc_reg_access pll[] = {\r\n{0x240, 0x00, 0x0},\r\n};\r\nstruct sc_reg_access vaud[] = {\r\n{0x0DB, 0x04, 0},\r\n};\r\npr_debug("powering dn msic\n");\r\nsnd_msic_ops.pbhs_on = 0;\r\nsnd_msic_ops.pb_on = 0;\r\nsnd_msic_ops.cap_on = 0;\r\nsst_sc_reg_access(power_dn, PMIC_WRITE, 3);\r\nmsleep(1);\r\nsst_sc_reg_access(pll, PMIC_WRITE, 1);\r\nmsleep(1);\r\nsst_sc_reg_access(vaud, PMIC_WRITE, 1);\r\nreturn 0;\r\n}\r\nstatic int msic_power_down_pb(unsigned int device)\r\n{\r\nstruct sc_reg_access drv_enable[] = {\r\n{0x25D, 0x00, 0x00},\r\n};\r\nstruct sc_reg_access hs_mute[] = {\r\n{0x259, 0x80, 0x80},\r\n{0x25A, 0x80, 0x80},\r\n{0x26C, 0x02, 0x02},\r\n};\r\nstruct sc_reg_access hs_off[] = {\r\n{0x257, 0x00, 0x03},\r\n{0x250, 0x00, 0x30},\r\n{0x382, 0x00, 0x40},\r\n};\r\nstruct sc_reg_access ihf_mute[] = {\r\n{0x25B, 0x80, 0x80},\r\n{0x25C, 0x80, 0x80},\r\n};\r\nstruct sc_reg_access ihf_off[] = {\r\n{0x257, 0x00, 0x0C},\r\n{0x251, 0x00, 0x03},\r\n};\r\nstruct sc_reg_access vib1_off[] = {\r\n{0x264, 0x00, 0x82},\r\n};\r\nstruct sc_reg_access vib2_off[] = {\r\n{0x26A, 0x00, 0x82},\r\n};\r\nstruct sc_reg_access lout_off[] = {\r\n{0x25e, 0x66, 0x00},\r\n};\r\nstruct sc_reg_access pmode_disable[] = {\r\n{0x381, 0x00, 0x10},\r\n};\r\npr_debug("powering dn pb for device %d\n", device);\r\nswitch (device) {\r\ncase SND_SST_DEVICE_HEADSET:\r\nsnd_msic_ops.pbhs_on = 0;\r\nsst_sc_reg_access(hs_mute, PMIC_READ_MODIFY, 3);\r\ndrv_enable[0].mask = 0x43;\r\nsst_sc_reg_access(drv_enable, PMIC_READ_MODIFY, 1);\r\nsst_sc_reg_access(hs_off, PMIC_READ_MODIFY, 3);\r\nif (snd_msic_ops.lineout_dev_id == HEADSET)\r\nsst_sc_reg_access(lout_off, PMIC_WRITE, 1);\r\nbreak;\r\ncase SND_SST_DEVICE_IHF:\r\nsst_sc_reg_access(ihf_mute, PMIC_READ_MODIFY, 2);\r\ndrv_enable[0].mask = 0x0C;\r\nsst_sc_reg_access(drv_enable, PMIC_READ_MODIFY, 1);\r\nsst_sc_reg_access(ihf_off, PMIC_READ_MODIFY, 2);\r\nif (snd_msic_ops.lineout_dev_id == IHF) {\r\nsst_sc_reg_access(lout_off, PMIC_WRITE, 1);\r\nsst_sc_reg_access(pmode_disable, PMIC_READ_MODIFY, 1);\r\n}\r\nbreak;\r\ncase SND_SST_DEVICE_VIBRA:\r\nsst_sc_reg_access(vib1_off, PMIC_READ_MODIFY, 1);\r\ndrv_enable[0].mask = 0x10;\r\nsst_sc_reg_access(drv_enable, PMIC_READ_MODIFY, 1);\r\nif (snd_msic_ops.lineout_dev_id == VIBRA1)\r\nsst_sc_reg_access(lout_off, PMIC_WRITE, 1);\r\nbreak;\r\ncase SND_SST_DEVICE_HAPTIC:\r\nsst_sc_reg_access(vib2_off, PMIC_READ_MODIFY, 1);\r\ndrv_enable[0].mask = 0x20;\r\nsst_sc_reg_access(drv_enable, PMIC_READ_MODIFY, 1);\r\nif (snd_msic_ops.lineout_dev_id == VIBRA2)\r\nsst_sc_reg_access(lout_off, PMIC_WRITE, 1);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int msic_power_down_cp(unsigned int device)\r\n{\r\nstruct sc_reg_access dmic[] = {\r\n{0x247, 0x00, 0xA0},\r\n{0x245, 0x00, 0x38},\r\n{0x246, 0x00, 0x07},\r\n};\r\nstruct sc_reg_access amic[] = {\r\n{0x248, 0x00, 0x05},\r\n{0x249, 0x00, 0x01},\r\n{0x24A, 0x00, 0x01},\r\n{0x247, 0x00, 0xA3},\r\n};\r\nstruct sc_reg_access tx_off[] = {\r\n{0x24F, 0x00, 0x3C},\r\n};\r\npr_debug("powering dn cp....\n");\r\nsnd_msic_ops.cap_on = 0;\r\nsst_sc_reg_access(tx_off, PMIC_READ_MODIFY, 1);\r\nif (snd_msic_ops.input_dev_id == DMIC)\r\nsst_sc_reg_access(dmic, PMIC_READ_MODIFY, 3);\r\nelse\r\nsst_sc_reg_access(amic, PMIC_READ_MODIFY, 4);\r\nreturn 0;\r\n}\r\nstatic int msic_set_selected_output_dev(u8 value)\r\n{\r\nint retval = 0;\r\npr_debug("msic set selected output:%d\n", value);\r\nsnd_msic_ops.output_dev_id = value;\r\nif (snd_msic_ops.pbhs_on)\r\nmsic_power_up_pb(SND_SST_DEVICE_HEADSET);\r\nreturn retval;\r\n}\r\nstatic int msic_set_selected_input_dev(u8 value)\r\n{\r\nstruct sc_reg_access sc_access_dmic[] = {\r\n{0x24C, 0x10, 0x0},\r\n};\r\nstruct sc_reg_access sc_access_amic[] = {\r\n{0x24C, 0x76, 0x0},\r\n};\r\nint retval = 0;\r\npr_debug("msic_set_selected_input_dev:%d\n", value);\r\nsnd_msic_ops.input_dev_id = value;\r\nswitch (value) {\r\ncase AMIC:\r\npr_debug("Selecting AMIC1\n");\r\nretval = sst_sc_reg_access(sc_access_amic, PMIC_WRITE, 1);\r\nbreak;\r\ncase DMIC:\r\npr_debug("Selecting DMIC1\n");\r\nretval = sst_sc_reg_access(sc_access_dmic, PMIC_WRITE, 1);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (snd_msic_ops.cap_on)\r\nretval = msic_power_up_cp(SND_SST_DEVICE_CAPTURE);\r\nreturn retval;\r\n}\r\nstatic int msic_set_hw_dmic_route(u8 hw_ch_index)\r\n{\r\nstruct sc_reg_access sc_access_router;\r\nint retval = -EINVAL;\r\nswitch (hw_ch_index) {\r\ncase HW_CH0:\r\nsc_access_router.reg_addr = AUDIOMUX12;\r\nsc_access_router.value = snd_msic_ops.hw_dmic_map[0];\r\nsc_access_router.mask = (MASK2 | MASK1 | MASK0);\r\npr_debug("hw_ch0. value = 0x%x\n",\r\nsc_access_router.value);\r\nretval = sst_sc_reg_access(&sc_access_router,\r\nPMIC_READ_MODIFY, 1);\r\nbreak;\r\ncase HW_CH1:\r\nsc_access_router.reg_addr = AUDIOMUX12;\r\nsc_access_router.value = (snd_msic_ops.hw_dmic_map[1]) << 4;\r\nsc_access_router.mask = (MASK6 | MASK5 | MASK4);\r\npr_debug("### hw_ch1. value = 0x%x\n",\r\nsc_access_router.value);\r\nretval = sst_sc_reg_access(&sc_access_router,\r\nPMIC_READ_MODIFY, 1);\r\nbreak;\r\ncase HW_CH2:\r\nsc_access_router.reg_addr = AUDIOMUX34;\r\nsc_access_router.value = snd_msic_ops.hw_dmic_map[2];\r\nsc_access_router.mask = (MASK2 | MASK1 | MASK0);\r\npr_debug("hw_ch2. value = 0x%x\n",\r\nsc_access_router.value);\r\nretval = sst_sc_reg_access(&sc_access_router,\r\nPMIC_READ_MODIFY, 1);\r\nbreak;\r\ncase HW_CH3:\r\nsc_access_router.reg_addr = AUDIOMUX34;\r\nsc_access_router.value = (snd_msic_ops.hw_dmic_map[3]) << 4;\r\nsc_access_router.mask = (MASK6 | MASK5 | MASK4);\r\npr_debug("hw_ch3. value = 0x%x\n",\r\nsc_access_router.value);\r\nretval = sst_sc_reg_access(&sc_access_router,\r\nPMIC_READ_MODIFY, 1);\r\nbreak;\r\n}\r\nreturn retval;\r\n}\r\nstatic int msic_set_pcm_voice_params(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic int msic_set_pcm_audio_params(int sfreq, int word_size, int num_channel)\r\n{\r\nreturn 0;\r\n}\r\nstatic int msic_set_audio_port(int status)\r\n{\r\nreturn 0;\r\n}\r\nstatic int msic_set_voice_port(int status)\r\n{\r\nreturn 0;\r\n}\r\nstatic int msic_set_mute(int dev_id, u8 value)\r\n{\r\nreturn 0;\r\n}\r\nstatic int msic_set_vol(int dev_id, int value)\r\n{\r\nreturn 0;\r\n}\r\nstatic int msic_get_mute(int dev_id, u8 *value)\r\n{\r\nreturn 0;\r\n}\r\nstatic int msic_get_vol(int dev_id, int *value)\r\n{\r\nreturn 0;\r\n}\r\nstatic int msic_set_headset_state(int state)\r\n{\r\nstruct sc_reg_access hs_enable[] = {\r\n{0x25D, 0x03, 0x03},\r\n};\r\nif (state)\r\nsst_sc_reg_access(hs_enable, PMIC_READ_MODIFY, 1);\r\nelse {\r\nhs_enable[0].value = 0;\r\nsst_sc_reg_access(hs_enable, PMIC_READ_MODIFY, 1);\r\n}\r\nreturn 0;\r\n}\r\nstatic int msic_enable_mic_bias(void)\r\n{\r\nstruct sc_reg_access jack_interrupt_reg[] = {\r\n{0x0DB, 0x07, 0x00},\r\n};\r\nstruct sc_reg_access jack_bias_reg[] = {\r\n{0x247, 0x0C, 0x0C},\r\n};\r\nsst_sc_reg_access(jack_interrupt_reg, PMIC_WRITE, 1);\r\nsst_sc_reg_access(jack_bias_reg, PMIC_READ_MODIFY, 1);\r\nreturn 0;\r\n}\r\nstatic int msic_disable_mic_bias(void)\r\n{\r\nif (snd_msic_ops.jack_interrupt_status == true)\r\nreturn 0;\r\nif (!(snd_msic_ops.pb_on || snd_msic_ops.cap_on))\r\nmsic_power_down();\r\nreturn 0;\r\n}\r\nstatic int msic_disable_jack_btn(void)\r\n{\r\nstruct sc_reg_access btn_disable[] = {\r\n{0x26C, 0x00, 0x01}\r\n};\r\nif (!(snd_msic_ops.pb_on || snd_msic_ops.cap_on))\r\nmsic_power_down();\r\nsnd_msic_ops.jack_interrupt_status = false;\r\nreturn sst_sc_reg_access(btn_disable, PMIC_READ_MODIFY, 1);\r\n}\r\nstatic int msic_enable_jack_btn(void)\r\n{\r\nstruct sc_reg_access btn_enable[] = {\r\n{0x26b, 0x77, 0x00},\r\n{0x26C, 0x01, 0x00},\r\n};\r\nreturn sst_sc_reg_access(btn_enable, PMIC_WRITE, 2);\r\n}\r\nstatic int msic_convert_adc_to_mvolt(unsigned int mic_bias)\r\n{\r\nreturn (ADC_ONE_LSB_MULTIPLIER * mic_bias) / 1000;\r\n}\r\nint msic_get_headset_state(int mic_bias)\r\n{\r\nstruct sc_reg_access msic_hs_toggle[] = {\r\n{0x070, 0x00, 0x01},\r\n};\r\nif (mic_bias >= 0 && mic_bias < 400) {\r\npr_debug("Detected Headphone!!!\n");\r\nsst_sc_reg_access(msic_hs_toggle, PMIC_READ_MODIFY, 1);\r\n} else if (mic_bias > 400 && mic_bias < 650) {\r\npr_debug("Detected American headset\n");\r\nmsic_hs_toggle[0].value = 0x01;\r\nsst_sc_reg_access(msic_hs_toggle, PMIC_READ_MODIFY, 1);\r\n} else if (mic_bias >= 650 && mic_bias < 2000) {\r\npr_debug("Detected Headset!!!\n");\r\nsst_sc_reg_access(msic_hs_toggle, PMIC_READ_MODIFY, 1);\r\nsnd_msic_ops.jack_interrupt_status = true;\r\nmsic_enable_jack_btn();\r\nmsic_enable_mic_bias();\r\nreturn SND_JACK_HEADSET;\r\n} else\r\npr_debug("Detected Open Cable!!!\n");\r\nreturn SND_JACK_HEADPHONE;\r\n}\r\nstatic int msic_get_mic_bias(void *arg)\r\n{\r\nstruct snd_intelmad *intelmad_drv = (struct snd_intelmad *)arg;\r\nu16 adc_adr = intelmad_drv->adc_address;\r\nu16 adc_val;\r\nint ret;\r\nstruct sc_reg_access adc_ctrl3[2] = {\r\n{0x1C2, 0x05, 0x0},\r\n};\r\nstruct sc_reg_access audio_adc_reg1 = {0,};\r\nstruct sc_reg_access audio_adc_reg2 = {0,};\r\nmsic_enable_mic_bias();\r\nret = sst_sc_reg_access(adc_ctrl3, PMIC_WRITE, 1);\r\nif (ret)\r\nreturn ret;\r\nadc_ctrl3[0].value = 0x04;\r\nret = sst_sc_reg_access(adc_ctrl3, PMIC_WRITE, 1);\r\nif (ret)\r\nreturn ret;\r\naudio_adc_reg1.reg_addr = adc_adr;\r\nmsleep(1000);\r\nret = sst_sc_reg_access(&audio_adc_reg1, PMIC_READ, 1);\r\nif (ret)\r\nreturn ret;\r\npr_debug("adc read value %x", audio_adc_reg1.value);\r\nadc_val = (audio_adc_reg1.value << 2);\r\nadc_adr++;\r\naudio_adc_reg2. reg_addr = adc_adr;\r\nret = sst_sc_reg_access(&audio_adc_reg2, PMIC_READ, 1);\r\nif (ret)\r\nreturn ret;\r\npr_debug("adc read value %x", audio_adc_reg2.value);\r\naudio_adc_reg2.value &= 03;\r\nadc_val += audio_adc_reg2.value;\r\npr_debug("ADC value 0x%x", adc_val);\r\nmsic_disable_mic_bias();\r\nreturn adc_val;\r\n}\r\nstatic void msic_pmic_irq_cb(void *cb_data, u8 intsts)\r\n{\r\nstruct mad_jack *mjack = NULL;\r\nunsigned int present = 0, jack_event_flag = 0, buttonpressflag = 0;\r\nstruct snd_intelmad *intelmaddata = cb_data;\r\nint retval = 0;\r\npr_debug("value returned = 0x%x\n", intsts);\r\nif (snd_msic_ops.card_status == SND_CARD_UN_INIT) {\r\nretval = msic_init_card();\r\nif (retval)\r\nreturn;\r\n}\r\nmjack = &intelmaddata->jack[0];\r\nif (intsts & 0x1) {\r\npr_debug("MAD short_push detected\n");\r\npresent = SND_JACK_BTN_0;\r\njack_event_flag = buttonpressflag = 1;\r\nmjack->jack.type = SND_JACK_BTN_0;\r\nmjack->jack.key[0] = BTN_0 ;\r\n}\r\nif (intsts & 0x2) {\r\npr_debug(":MAD long_push detected\n");\r\njack_event_flag = buttonpressflag = 1;\r\nmjack->jack.type = present = SND_JACK_BTN_1;\r\nmjack->jack.key[1] = BTN_1;\r\n}\r\nif (intsts & 0x4) {\r\nunsigned int mic_bias;\r\njack_event_flag = 1;\r\nbuttonpressflag = 0;\r\nmic_bias = msic_get_mic_bias(intelmaddata);\r\npr_debug("mic_bias = %d\n", mic_bias);\r\nmic_bias = msic_convert_adc_to_mvolt(mic_bias);\r\npr_debug("mic_bias after conversion = %d mV\n", mic_bias);\r\nmjack->jack_dev_state = msic_get_headset_state(mic_bias);\r\nmjack->jack.type = present = mjack->jack_dev_state;\r\n}\r\nif (intsts & 0x8) {\r\nmjack->jack.type = mjack->jack_dev_state;\r\npresent = 0;\r\njack_event_flag = 1;\r\nbuttonpressflag = 0;\r\nmsic_disable_jack_btn();\r\nmsic_disable_mic_bias();\r\n}\r\nif (jack_event_flag)\r\nsst_mad_send_jack_report(&mjack->jack,\r\nbuttonpressflag, present);\r\n}

static void bond_glean_dev_ipv6(struct net_device *dev, struct in6_addr *addr)\r\n{\r\nstruct inet6_dev *idev;\r\nif (!dev)\r\nreturn;\r\nidev = in6_dev_get(dev);\r\nif (!idev)\r\nreturn;\r\nread_lock_bh(&idev->lock);\r\nif (!list_empty(&idev->addr_list)) {\r\nstruct inet6_ifaddr *ifa\r\n= list_first_entry(&idev->addr_list,\r\nstruct inet6_ifaddr, if_list);\r\nipv6_addr_copy(addr, &ifa->addr);\r\n} else\r\nipv6_addr_set(addr, 0, 0, 0, 0);\r\nread_unlock_bh(&idev->lock);\r\nin6_dev_put(idev);\r\n}\r\nstatic void bond_na_send(struct net_device *slave_dev,\r\nstruct in6_addr *daddr,\r\nint router,\r\nunsigned short vlan_id)\r\n{\r\nstruct in6_addr mcaddr;\r\nstruct icmp6hdr icmp6h = {\r\n.icmp6_type = NDISC_NEIGHBOUR_ADVERTISEMENT,\r\n};\r\nstruct sk_buff *skb;\r\nicmp6h.icmp6_router = router;\r\nicmp6h.icmp6_solicited = 0;\r\nicmp6h.icmp6_override = 1;\r\naddrconf_addr_solict_mult(daddr, &mcaddr);\r\npr_debug("ipv6 na on slave %s: dest %pI6, src %pI6\n",\r\nslave_dev->name, &mcaddr, daddr);\r\nskb = ndisc_build_skb(slave_dev, &mcaddr, daddr, &icmp6h, daddr,\r\nND_OPT_TARGET_LL_ADDR);\r\nif (!skb) {\r\npr_err("NA packet allocation failed\n");\r\nreturn;\r\n}\r\nif (vlan_id) {\r\nskb = __vlan_hwaccel_put_tag(skb, vlan_id);\r\nif (!skb) {\r\npr_err("failed to insert VLAN tag\n");\r\nreturn;\r\n}\r\n}\r\nndisc_send_skb(skb, slave_dev, NULL, &mcaddr, daddr, &icmp6h);\r\n}\r\nvoid bond_send_unsolicited_na(struct bonding *bond)\r\n{\r\nstruct slave *slave = bond->curr_active_slave;\r\nstruct vlan_entry *vlan;\r\nstruct inet6_dev *idev;\r\nint is_router;\r\npr_debug("%s: bond %s slave %s\n", bond->dev->name,\r\n__func__, slave ? slave->dev->name : "NULL");\r\nif (!slave || !bond->send_unsol_na ||\r\ntest_bit(__LINK_STATE_LINKWATCH_PENDING, &slave->dev->state))\r\nreturn;\r\nbond->send_unsol_na--;\r\nidev = in6_dev_get(bond->dev);\r\nif (!idev)\r\nreturn;\r\nis_router = !!idev->cnf.forwarding;\r\nin6_dev_put(idev);\r\nif (!ipv6_addr_any(&bond->master_ipv6))\r\nbond_na_send(slave->dev, &bond->master_ipv6, is_router, 0);\r\nlist_for_each_entry(vlan, &bond->vlan_list, vlan_list) {\r\nif (!ipv6_addr_any(&vlan->vlan_ipv6)) {\r\nbond_na_send(slave->dev, &vlan->vlan_ipv6, is_router,\r\nvlan->vlan_id);\r\n}\r\n}\r\n}\r\nstatic int bond_inet6addr_event(struct notifier_block *this,\r\nunsigned long event,\r\nvoid *ptr)\r\n{\r\nstruct inet6_ifaddr *ifa = ptr;\r\nstruct net_device *vlan_dev, *event_dev = ifa->idev->dev;\r\nstruct bonding *bond;\r\nstruct vlan_entry *vlan;\r\nstruct bond_net *bn = net_generic(dev_net(event_dev), bond_net_id);\r\nlist_for_each_entry(bond, &bn->dev_list, bond_list) {\r\nif (bond->dev == event_dev) {\r\nswitch (event) {\r\ncase NETDEV_UP:\r\nif (ipv6_addr_any(&bond->master_ipv6))\r\nipv6_addr_copy(&bond->master_ipv6,\r\n&ifa->addr);\r\nreturn NOTIFY_OK;\r\ncase NETDEV_DOWN:\r\nif (ipv6_addr_equal(&bond->master_ipv6,\r\n&ifa->addr))\r\nbond_glean_dev_ipv6(bond->dev,\r\n&bond->master_ipv6);\r\nreturn NOTIFY_OK;\r\ndefault:\r\nreturn NOTIFY_DONE;\r\n}\r\n}\r\nlist_for_each_entry(vlan, &bond->vlan_list, vlan_list) {\r\nrcu_read_lock();\r\nvlan_dev = __vlan_find_dev_deep(bond->dev,\r\nvlan->vlan_id);\r\nrcu_read_unlock();\r\nif (vlan_dev == event_dev) {\r\nswitch (event) {\r\ncase NETDEV_UP:\r\nif (ipv6_addr_any(&vlan->vlan_ipv6))\r\nipv6_addr_copy(&vlan->vlan_ipv6,\r\n&ifa->addr);\r\nreturn NOTIFY_OK;\r\ncase NETDEV_DOWN:\r\nif (ipv6_addr_equal(&vlan->vlan_ipv6,\r\n&ifa->addr))\r\nbond_glean_dev_ipv6(vlan_dev,\r\n&vlan->vlan_ipv6);\r\nreturn NOTIFY_OK;\r\ndefault:\r\nreturn NOTIFY_DONE;\r\n}\r\n}\r\n}\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nvoid bond_register_ipv6_notifier(void)\r\n{\r\nregister_inet6addr_notifier(&bond_inet6addr_notifier);\r\n}\r\nvoid bond_unregister_ipv6_notifier(void)\r\n{\r\nunregister_inet6addr_notifier(&bond_inet6addr_notifier);\r\n}

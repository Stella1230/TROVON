static inline int atomic_futex_op_xchg_set(int oparg, u32 __user *uaddr, int *_oldval)\r\n{\r\nint oldval, ret;\r\nasm("0: \n"\r\n" orcc gr0,gr0,gr0,icc3 \n"\r\n" ckeq icc3,cc7 \n"\r\n"1: ld.p %M0,%1 \n"\r\n" orcr cc7,cc7,cc3 \n"\r\n"2: cst.p %3,%M0 ,cc3,#1 \n"\r\n" corcc gr29,gr29,gr0 ,cc3,#1 \n"\r\n" beq icc3,#0,0b \n"\r\n" setlos 0,%2 \n"\r\n"3: \n"\r\n".subsection 2 \n"\r\n"4: setlos %5,%2 \n"\r\n" bra 3b \n"\r\n".previous \n"\r\n".section __ex_table,\"a\" \n"\r\n" .balign 8 \n"\r\n" .long 1b,4b \n"\r\n" .long 2b,4b \n"\r\n".previous"\r\n: "+U"(*uaddr), "=&r"(oldval), "=&r"(ret), "=r"(oparg)\r\n: "3"(oparg), "i"(-EFAULT)\r\n: "memory", "cc7", "cc3", "icc3"\r\n);\r\n*_oldval = oldval;\r\nreturn ret;\r\n}\r\nstatic inline int atomic_futex_op_xchg_add(int oparg, u32 __user *uaddr, int *_oldval)\r\n{\r\nint oldval, ret;\r\nasm("0: \n"\r\n" orcc gr0,gr0,gr0,icc3 \n"\r\n" ckeq icc3,cc7 \n"\r\n"1: ld.p %M0,%1 \n"\r\n" orcr cc7,cc7,cc3 \n"\r\n" add %1,%3,%3 \n"\r\n"2: cst.p %3,%M0 ,cc3,#1 \n"\r\n" corcc gr29,gr29,gr0 ,cc3,#1 \n"\r\n" beq icc3,#0,0b \n"\r\n" setlos 0,%2 \n"\r\n"3: \n"\r\n".subsection 2 \n"\r\n"4: setlos %5,%2 \n"\r\n" bra 3b \n"\r\n".previous \n"\r\n".section __ex_table,\"a\" \n"\r\n" .balign 8 \n"\r\n" .long 1b,4b \n"\r\n" .long 2b,4b \n"\r\n".previous"\r\n: "+U"(*uaddr), "=&r"(oldval), "=&r"(ret), "=r"(oparg)\r\n: "3"(oparg), "i"(-EFAULT)\r\n: "memory", "cc7", "cc3", "icc3"\r\n);\r\n*_oldval = oldval;\r\nreturn ret;\r\n}\r\nstatic inline int atomic_futex_op_xchg_or(int oparg, u32 __user *uaddr, int *_oldval)\r\n{\r\nint oldval, ret;\r\nasm("0: \n"\r\n" orcc gr0,gr0,gr0,icc3 \n"\r\n" ckeq icc3,cc7 \n"\r\n"1: ld.p %M0,%1 \n"\r\n" orcr cc7,cc7,cc3 \n"\r\n" or %1,%3,%3 \n"\r\n"2: cst.p %3,%M0 ,cc3,#1 \n"\r\n" corcc gr29,gr29,gr0 ,cc3,#1 \n"\r\n" beq icc3,#0,0b \n"\r\n" setlos 0,%2 \n"\r\n"3: \n"\r\n".subsection 2 \n"\r\n"4: setlos %5,%2 \n"\r\n" bra 3b \n"\r\n".previous \n"\r\n".section __ex_table,\"a\" \n"\r\n" .balign 8 \n"\r\n" .long 1b,4b \n"\r\n" .long 2b,4b \n"\r\n".previous"\r\n: "+U"(*uaddr), "=&r"(oldval), "=&r"(ret), "=r"(oparg)\r\n: "3"(oparg), "i"(-EFAULT)\r\n: "memory", "cc7", "cc3", "icc3"\r\n);\r\n*_oldval = oldval;\r\nreturn ret;\r\n}\r\nstatic inline int atomic_futex_op_xchg_and(int oparg, u32 __user *uaddr, int *_oldval)\r\n{\r\nint oldval, ret;\r\nasm("0: \n"\r\n" orcc gr0,gr0,gr0,icc3 \n"\r\n" ckeq icc3,cc7 \n"\r\n"1: ld.p %M0,%1 \n"\r\n" orcr cc7,cc7,cc3 \n"\r\n" and %1,%3,%3 \n"\r\n"2: cst.p %3,%M0 ,cc3,#1 \n"\r\n" corcc gr29,gr29,gr0 ,cc3,#1 \n"\r\n" beq icc3,#0,0b \n"\r\n" setlos 0,%2 \n"\r\n"3: \n"\r\n".subsection 2 \n"\r\n"4: setlos %5,%2 \n"\r\n" bra 3b \n"\r\n".previous \n"\r\n".section __ex_table,\"a\" \n"\r\n" .balign 8 \n"\r\n" .long 1b,4b \n"\r\n" .long 2b,4b \n"\r\n".previous"\r\n: "+U"(*uaddr), "=&r"(oldval), "=&r"(ret), "=r"(oparg)\r\n: "3"(oparg), "i"(-EFAULT)\r\n: "memory", "cc7", "cc3", "icc3"\r\n);\r\n*_oldval = oldval;\r\nreturn ret;\r\n}\r\nstatic inline int atomic_futex_op_xchg_xor(int oparg, u32 __user *uaddr, int *_oldval)\r\n{\r\nint oldval, ret;\r\nasm("0: \n"\r\n" orcc gr0,gr0,gr0,icc3 \n"\r\n" ckeq icc3,cc7 \n"\r\n"1: ld.p %M0,%1 \n"\r\n" orcr cc7,cc7,cc3 \n"\r\n" xor %1,%3,%3 \n"\r\n"2: cst.p %3,%M0 ,cc3,#1 \n"\r\n" corcc gr29,gr29,gr0 ,cc3,#1 \n"\r\n" beq icc3,#0,0b \n"\r\n" setlos 0,%2 \n"\r\n"3: \n"\r\n".subsection 2 \n"\r\n"4: setlos %5,%2 \n"\r\n" bra 3b \n"\r\n".previous \n"\r\n".section __ex_table,\"a\" \n"\r\n" .balign 8 \n"\r\n" .long 1b,4b \n"\r\n" .long 2b,4b \n"\r\n".previous"\r\n: "+U"(*uaddr), "=&r"(oldval), "=&r"(ret), "=r"(oparg)\r\n: "3"(oparg), "i"(-EFAULT)\r\n: "memory", "cc7", "cc3", "icc3"\r\n);\r\n*_oldval = oldval;\r\nreturn ret;\r\n}\r\nint futex_atomic_op_inuser(int encoded_op, u32 __user *uaddr)\r\n{\r\nint op = (encoded_op >> 28) & 7;\r\nint cmp = (encoded_op >> 24) & 15;\r\nint oparg = (encoded_op << 8) >> 20;\r\nint cmparg = (encoded_op << 20) >> 20;\r\nint oldval = 0, ret;\r\nif (encoded_op & (FUTEX_OP_OPARG_SHIFT << 28))\r\noparg = 1 << oparg;\r\nif (!access_ok(VERIFY_WRITE, uaddr, sizeof(u32)))\r\nreturn -EFAULT;\r\npagefault_disable();\r\nswitch (op) {\r\ncase FUTEX_OP_SET:\r\nret = atomic_futex_op_xchg_set(oparg, uaddr, &oldval);\r\nbreak;\r\ncase FUTEX_OP_ADD:\r\nret = atomic_futex_op_xchg_add(oparg, uaddr, &oldval);\r\nbreak;\r\ncase FUTEX_OP_OR:\r\nret = atomic_futex_op_xchg_or(oparg, uaddr, &oldval);\r\nbreak;\r\ncase FUTEX_OP_ANDN:\r\nret = atomic_futex_op_xchg_and(~oparg, uaddr, &oldval);\r\nbreak;\r\ncase FUTEX_OP_XOR:\r\nret = atomic_futex_op_xchg_xor(oparg, uaddr, &oldval);\r\nbreak;\r\ndefault:\r\nret = -ENOSYS;\r\nbreak;\r\n}\r\npagefault_enable();\r\nif (!ret) {\r\nswitch (cmp) {\r\ncase FUTEX_OP_CMP_EQ: ret = (oldval == cmparg); break;\r\ncase FUTEX_OP_CMP_NE: ret = (oldval != cmparg); break;\r\ncase FUTEX_OP_CMP_LT: ret = (oldval < cmparg); break;\r\ncase FUTEX_OP_CMP_GE: ret = (oldval >= cmparg); break;\r\ncase FUTEX_OP_CMP_LE: ret = (oldval <= cmparg); break;\r\ncase FUTEX_OP_CMP_GT: ret = (oldval > cmparg); break;\r\ndefault: ret = -ENOSYS; break;\r\n}\r\n}\r\nreturn ret;\r\n}

static inline void\r\npyxis_update_irq_hw(unsigned long mask)\r\n{\r\n*(vulp)PYXIS_INT_MASK = mask;\r\nmb();\r\n*(vulp)PYXIS_INT_MASK;\r\n}\r\nstatic inline void\r\npyxis_enable_irq(struct irq_data *d)\r\n{\r\npyxis_update_irq_hw(cached_irq_mask |= 1UL << (d->irq - 16));\r\n}\r\nstatic void\r\npyxis_disable_irq(struct irq_data *d)\r\n{\r\npyxis_update_irq_hw(cached_irq_mask &= ~(1UL << (d->irq - 16)));\r\n}\r\nstatic void\r\npyxis_mask_and_ack_irq(struct irq_data *d)\r\n{\r\nunsigned long bit = 1UL << (d->irq - 16);\r\nunsigned long mask = cached_irq_mask &= ~bit;\r\n*(vulp)PYXIS_INT_MASK = mask;\r\nwmb();\r\n*(vulp)PYXIS_INT_REQ = bit;\r\nmb();\r\n*(vulp)PYXIS_INT_MASK;\r\n}\r\nvoid\r\npyxis_device_interrupt(unsigned long vector)\r\n{\r\nunsigned long pld;\r\nunsigned int i;\r\npld = *(vulp)PYXIS_INT_REQ;\r\npld &= cached_irq_mask;\r\nwhile (pld) {\r\ni = ffz(~pld);\r\npld &= pld - 1;\r\nif (i == 7)\r\nisa_device_interrupt(vector);\r\nelse\r\nhandle_irq(16+i);\r\n}\r\n}\r\nvoid __init\r\ninit_pyxis_irqs(unsigned long ignore_mask)\r\n{\r\nlong i;\r\n*(vulp)PYXIS_INT_MASK = 0;\r\n*(vulp)PYXIS_INT_REQ = -1;\r\nmb();\r\n*(vuip) CIA_IACK_SC;\r\nfor (i = 16; i < 48; ++i) {\r\nif ((ignore_mask >> i) & 1)\r\ncontinue;\r\nirq_set_chip_and_handler(i, &pyxis_irq_type, handle_level_irq);\r\nirq_set_status_flags(i, IRQ_LEVEL);\r\n}\r\nsetup_irq(16+7, &isa_cascade_irqaction);\r\n}

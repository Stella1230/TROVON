static void wl1251_debugfs_update_stats(struct wl1251 *wl)\r\n{\r\nint ret;\r\nmutex_lock(&wl->mutex);\r\nret = wl1251_ps_elp_wakeup(wl);\r\nif (ret < 0)\r\ngoto out;\r\nif (wl->state == WL1251_STATE_ON &&\r\ntime_after(jiffies, wl->stats.fw_stats_update +\r\nmsecs_to_jiffies(WL1251_DEBUGFS_STATS_LIFETIME))) {\r\nwl1251_acx_statistics(wl, wl->stats.fw_stats);\r\nwl->stats.fw_stats_update = jiffies;\r\n}\r\nwl1251_ps_elp_sleep(wl);\r\nout:\r\nmutex_unlock(&wl->mutex);\r\n}\r\nstatic int wl1251_open_file_generic(struct inode *inode, struct file *file)\r\n{\r\nfile->private_data = inode->i_private;\r\nreturn 0;\r\n}\r\nstatic ssize_t tx_queue_len_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct wl1251 *wl = file->private_data;\r\nu32 queue_len;\r\nchar buf[20];\r\nint res;\r\nqueue_len = skb_queue_len(&wl->tx_queue);\r\nres = scnprintf(buf, sizeof(buf), "%u\n", queue_len);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, res);\r\n}\r\nstatic ssize_t tx_queue_status_read(struct file *file, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct wl1251 *wl = file->private_data;\r\nchar buf[3], status;\r\nint len;\r\nif (wl->tx_queue_stopped)\r\nstatus = 's';\r\nelse\r\nstatus = 'r';\r\nlen = scnprintf(buf, sizeof(buf), "%c\n", status);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, len);\r\n}\r\nstatic void wl1251_debugfs_delete_files(struct wl1251 *wl)\r\n{\r\nDEBUGFS_FWSTATS_DEL(tx, internal_desc_overflow);\r\nDEBUGFS_FWSTATS_DEL(rx, out_of_mem);\r\nDEBUGFS_FWSTATS_DEL(rx, hdr_overflow);\r\nDEBUGFS_FWSTATS_DEL(rx, hw_stuck);\r\nDEBUGFS_FWSTATS_DEL(rx, dropped);\r\nDEBUGFS_FWSTATS_DEL(rx, fcs_err);\r\nDEBUGFS_FWSTATS_DEL(rx, xfr_hint_trig);\r\nDEBUGFS_FWSTATS_DEL(rx, path_reset);\r\nDEBUGFS_FWSTATS_DEL(rx, reset_counter);\r\nDEBUGFS_FWSTATS_DEL(dma, rx_requested);\r\nDEBUGFS_FWSTATS_DEL(dma, rx_errors);\r\nDEBUGFS_FWSTATS_DEL(dma, tx_requested);\r\nDEBUGFS_FWSTATS_DEL(dma, tx_errors);\r\nDEBUGFS_FWSTATS_DEL(isr, cmd_cmplt);\r\nDEBUGFS_FWSTATS_DEL(isr, fiqs);\r\nDEBUGFS_FWSTATS_DEL(isr, rx_headers);\r\nDEBUGFS_FWSTATS_DEL(isr, rx_mem_overflow);\r\nDEBUGFS_FWSTATS_DEL(isr, rx_rdys);\r\nDEBUGFS_FWSTATS_DEL(isr, irqs);\r\nDEBUGFS_FWSTATS_DEL(isr, tx_procs);\r\nDEBUGFS_FWSTATS_DEL(isr, decrypt_done);\r\nDEBUGFS_FWSTATS_DEL(isr, dma0_done);\r\nDEBUGFS_FWSTATS_DEL(isr, dma1_done);\r\nDEBUGFS_FWSTATS_DEL(isr, tx_exch_complete);\r\nDEBUGFS_FWSTATS_DEL(isr, commands);\r\nDEBUGFS_FWSTATS_DEL(isr, rx_procs);\r\nDEBUGFS_FWSTATS_DEL(isr, hw_pm_mode_changes);\r\nDEBUGFS_FWSTATS_DEL(isr, host_acknowledges);\r\nDEBUGFS_FWSTATS_DEL(isr, pci_pm);\r\nDEBUGFS_FWSTATS_DEL(isr, wakeups);\r\nDEBUGFS_FWSTATS_DEL(isr, low_rssi);\r\nDEBUGFS_FWSTATS_DEL(wep, addr_key_count);\r\nDEBUGFS_FWSTATS_DEL(wep, default_key_count);\r\nDEBUGFS_FWSTATS_DEL(wep, key_not_found);\r\nDEBUGFS_FWSTATS_DEL(wep, decrypt_fail);\r\nDEBUGFS_FWSTATS_DEL(wep, packets);\r\nDEBUGFS_FWSTATS_DEL(wep, interrupt);\r\nDEBUGFS_FWSTATS_DEL(pwr, ps_enter);\r\nDEBUGFS_FWSTATS_DEL(pwr, elp_enter);\r\nDEBUGFS_FWSTATS_DEL(pwr, missing_bcns);\r\nDEBUGFS_FWSTATS_DEL(pwr, wake_on_host);\r\nDEBUGFS_FWSTATS_DEL(pwr, wake_on_timer_exp);\r\nDEBUGFS_FWSTATS_DEL(pwr, tx_with_ps);\r\nDEBUGFS_FWSTATS_DEL(pwr, tx_without_ps);\r\nDEBUGFS_FWSTATS_DEL(pwr, rcvd_beacons);\r\nDEBUGFS_FWSTATS_DEL(pwr, power_save_off);\r\nDEBUGFS_FWSTATS_DEL(pwr, enable_ps);\r\nDEBUGFS_FWSTATS_DEL(pwr, disable_ps);\r\nDEBUGFS_FWSTATS_DEL(pwr, fix_tsf_ps);\r\nDEBUGFS_FWSTATS_DEL(pwr, rcvd_awake_beacons);\r\nDEBUGFS_FWSTATS_DEL(mic, rx_pkts);\r\nDEBUGFS_FWSTATS_DEL(mic, calc_failure);\r\nDEBUGFS_FWSTATS_DEL(aes, encrypt_fail);\r\nDEBUGFS_FWSTATS_DEL(aes, decrypt_fail);\r\nDEBUGFS_FWSTATS_DEL(aes, encrypt_packets);\r\nDEBUGFS_FWSTATS_DEL(aes, decrypt_packets);\r\nDEBUGFS_FWSTATS_DEL(aes, encrypt_interrupt);\r\nDEBUGFS_FWSTATS_DEL(aes, decrypt_interrupt);\r\nDEBUGFS_FWSTATS_DEL(event, heart_beat);\r\nDEBUGFS_FWSTATS_DEL(event, calibration);\r\nDEBUGFS_FWSTATS_DEL(event, rx_mismatch);\r\nDEBUGFS_FWSTATS_DEL(event, rx_mem_empty);\r\nDEBUGFS_FWSTATS_DEL(event, rx_pool);\r\nDEBUGFS_FWSTATS_DEL(event, oom_late);\r\nDEBUGFS_FWSTATS_DEL(event, phy_transmit_error);\r\nDEBUGFS_FWSTATS_DEL(event, tx_stuck);\r\nDEBUGFS_FWSTATS_DEL(ps, pspoll_timeouts);\r\nDEBUGFS_FWSTATS_DEL(ps, upsd_timeouts);\r\nDEBUGFS_FWSTATS_DEL(ps, upsd_max_sptime);\r\nDEBUGFS_FWSTATS_DEL(ps, upsd_max_apturn);\r\nDEBUGFS_FWSTATS_DEL(ps, pspoll_max_apturn);\r\nDEBUGFS_FWSTATS_DEL(ps, pspoll_utilization);\r\nDEBUGFS_FWSTATS_DEL(ps, upsd_utilization);\r\nDEBUGFS_FWSTATS_DEL(rxpipe, rx_prep_beacon_drop);\r\nDEBUGFS_FWSTATS_DEL(rxpipe, descr_host_int_trig_rx_data);\r\nDEBUGFS_FWSTATS_DEL(rxpipe, beacon_buffer_thres_host_int_trig_rx_data);\r\nDEBUGFS_FWSTATS_DEL(rxpipe, missed_beacon_host_int_trig_rx_data);\r\nDEBUGFS_FWSTATS_DEL(rxpipe, tx_xfr_host_int_trig_rx_data);\r\nDEBUGFS_DEL(tx_queue_len);\r\nDEBUGFS_DEL(tx_queue_status);\r\nDEBUGFS_DEL(retry_count);\r\nDEBUGFS_DEL(excessive_retries);\r\n}\r\nstatic int wl1251_debugfs_add_files(struct wl1251 *wl)\r\n{\r\nint ret = 0;\r\nDEBUGFS_FWSTATS_ADD(tx, internal_desc_overflow);\r\nDEBUGFS_FWSTATS_ADD(rx, out_of_mem);\r\nDEBUGFS_FWSTATS_ADD(rx, hdr_overflow);\r\nDEBUGFS_FWSTATS_ADD(rx, hw_stuck);\r\nDEBUGFS_FWSTATS_ADD(rx, dropped);\r\nDEBUGFS_FWSTATS_ADD(rx, fcs_err);\r\nDEBUGFS_FWSTATS_ADD(rx, xfr_hint_trig);\r\nDEBUGFS_FWSTATS_ADD(rx, path_reset);\r\nDEBUGFS_FWSTATS_ADD(rx, reset_counter);\r\nDEBUGFS_FWSTATS_ADD(dma, rx_requested);\r\nDEBUGFS_FWSTATS_ADD(dma, rx_errors);\r\nDEBUGFS_FWSTATS_ADD(dma, tx_requested);\r\nDEBUGFS_FWSTATS_ADD(dma, tx_errors);\r\nDEBUGFS_FWSTATS_ADD(isr, cmd_cmplt);\r\nDEBUGFS_FWSTATS_ADD(isr, fiqs);\r\nDEBUGFS_FWSTATS_ADD(isr, rx_headers);\r\nDEBUGFS_FWSTATS_ADD(isr, rx_mem_overflow);\r\nDEBUGFS_FWSTATS_ADD(isr, rx_rdys);\r\nDEBUGFS_FWSTATS_ADD(isr, irqs);\r\nDEBUGFS_FWSTATS_ADD(isr, tx_procs);\r\nDEBUGFS_FWSTATS_ADD(isr, decrypt_done);\r\nDEBUGFS_FWSTATS_ADD(isr, dma0_done);\r\nDEBUGFS_FWSTATS_ADD(isr, dma1_done);\r\nDEBUGFS_FWSTATS_ADD(isr, tx_exch_complete);\r\nDEBUGFS_FWSTATS_ADD(isr, commands);\r\nDEBUGFS_FWSTATS_ADD(isr, rx_procs);\r\nDEBUGFS_FWSTATS_ADD(isr, hw_pm_mode_changes);\r\nDEBUGFS_FWSTATS_ADD(isr, host_acknowledges);\r\nDEBUGFS_FWSTATS_ADD(isr, pci_pm);\r\nDEBUGFS_FWSTATS_ADD(isr, wakeups);\r\nDEBUGFS_FWSTATS_ADD(isr, low_rssi);\r\nDEBUGFS_FWSTATS_ADD(wep, addr_key_count);\r\nDEBUGFS_FWSTATS_ADD(wep, default_key_count);\r\nDEBUGFS_FWSTATS_ADD(wep, key_not_found);\r\nDEBUGFS_FWSTATS_ADD(wep, decrypt_fail);\r\nDEBUGFS_FWSTATS_ADD(wep, packets);\r\nDEBUGFS_FWSTATS_ADD(wep, interrupt);\r\nDEBUGFS_FWSTATS_ADD(pwr, ps_enter);\r\nDEBUGFS_FWSTATS_ADD(pwr, elp_enter);\r\nDEBUGFS_FWSTATS_ADD(pwr, missing_bcns);\r\nDEBUGFS_FWSTATS_ADD(pwr, wake_on_host);\r\nDEBUGFS_FWSTATS_ADD(pwr, wake_on_timer_exp);\r\nDEBUGFS_FWSTATS_ADD(pwr, tx_with_ps);\r\nDEBUGFS_FWSTATS_ADD(pwr, tx_without_ps);\r\nDEBUGFS_FWSTATS_ADD(pwr, rcvd_beacons);\r\nDEBUGFS_FWSTATS_ADD(pwr, power_save_off);\r\nDEBUGFS_FWSTATS_ADD(pwr, enable_ps);\r\nDEBUGFS_FWSTATS_ADD(pwr, disable_ps);\r\nDEBUGFS_FWSTATS_ADD(pwr, fix_tsf_ps);\r\nDEBUGFS_FWSTATS_ADD(pwr, rcvd_awake_beacons);\r\nDEBUGFS_FWSTATS_ADD(mic, rx_pkts);\r\nDEBUGFS_FWSTATS_ADD(mic, calc_failure);\r\nDEBUGFS_FWSTATS_ADD(aes, encrypt_fail);\r\nDEBUGFS_FWSTATS_ADD(aes, decrypt_fail);\r\nDEBUGFS_FWSTATS_ADD(aes, encrypt_packets);\r\nDEBUGFS_FWSTATS_ADD(aes, decrypt_packets);\r\nDEBUGFS_FWSTATS_ADD(aes, encrypt_interrupt);\r\nDEBUGFS_FWSTATS_ADD(aes, decrypt_interrupt);\r\nDEBUGFS_FWSTATS_ADD(event, heart_beat);\r\nDEBUGFS_FWSTATS_ADD(event, calibration);\r\nDEBUGFS_FWSTATS_ADD(event, rx_mismatch);\r\nDEBUGFS_FWSTATS_ADD(event, rx_mem_empty);\r\nDEBUGFS_FWSTATS_ADD(event, rx_pool);\r\nDEBUGFS_FWSTATS_ADD(event, oom_late);\r\nDEBUGFS_FWSTATS_ADD(event, phy_transmit_error);\r\nDEBUGFS_FWSTATS_ADD(event, tx_stuck);\r\nDEBUGFS_FWSTATS_ADD(ps, pspoll_timeouts);\r\nDEBUGFS_FWSTATS_ADD(ps, upsd_timeouts);\r\nDEBUGFS_FWSTATS_ADD(ps, upsd_max_sptime);\r\nDEBUGFS_FWSTATS_ADD(ps, upsd_max_apturn);\r\nDEBUGFS_FWSTATS_ADD(ps, pspoll_max_apturn);\r\nDEBUGFS_FWSTATS_ADD(ps, pspoll_utilization);\r\nDEBUGFS_FWSTATS_ADD(ps, upsd_utilization);\r\nDEBUGFS_FWSTATS_ADD(rxpipe, rx_prep_beacon_drop);\r\nDEBUGFS_FWSTATS_ADD(rxpipe, descr_host_int_trig_rx_data);\r\nDEBUGFS_FWSTATS_ADD(rxpipe, beacon_buffer_thres_host_int_trig_rx_data);\r\nDEBUGFS_FWSTATS_ADD(rxpipe, missed_beacon_host_int_trig_rx_data);\r\nDEBUGFS_FWSTATS_ADD(rxpipe, tx_xfr_host_int_trig_rx_data);\r\nDEBUGFS_ADD(tx_queue_len, wl->debugfs.rootdir);\r\nDEBUGFS_ADD(tx_queue_status, wl->debugfs.rootdir);\r\nDEBUGFS_ADD(retry_count, wl->debugfs.rootdir);\r\nDEBUGFS_ADD(excessive_retries, wl->debugfs.rootdir);\r\nout:\r\nif (ret < 0)\r\nwl1251_debugfs_delete_files(wl);\r\nreturn ret;\r\n}\r\nvoid wl1251_debugfs_reset(struct wl1251 *wl)\r\n{\r\nif (wl->stats.fw_stats != NULL)\r\nmemset(wl->stats.fw_stats, 0, sizeof(*wl->stats.fw_stats));\r\nwl->stats.retry_count = 0;\r\nwl->stats.excessive_retries = 0;\r\n}\r\nint wl1251_debugfs_init(struct wl1251 *wl)\r\n{\r\nint ret;\r\nwl->debugfs.rootdir = debugfs_create_dir(KBUILD_MODNAME, NULL);\r\nif (IS_ERR(wl->debugfs.rootdir)) {\r\nret = PTR_ERR(wl->debugfs.rootdir);\r\nwl->debugfs.rootdir = NULL;\r\ngoto err;\r\n}\r\nwl->debugfs.fw_statistics = debugfs_create_dir("fw-statistics",\r\nwl->debugfs.rootdir);\r\nif (IS_ERR(wl->debugfs.fw_statistics)) {\r\nret = PTR_ERR(wl->debugfs.fw_statistics);\r\nwl->debugfs.fw_statistics = NULL;\r\ngoto err_root;\r\n}\r\nwl->stats.fw_stats = kzalloc(sizeof(*wl->stats.fw_stats),\r\nGFP_KERNEL);\r\nif (!wl->stats.fw_stats) {\r\nret = -ENOMEM;\r\ngoto err_fw;\r\n}\r\nwl->stats.fw_stats_update = jiffies;\r\nret = wl1251_debugfs_add_files(wl);\r\nif (ret < 0)\r\ngoto err_file;\r\nreturn 0;\r\nerr_file:\r\nkfree(wl->stats.fw_stats);\r\nwl->stats.fw_stats = NULL;\r\nerr_fw:\r\ndebugfs_remove(wl->debugfs.fw_statistics);\r\nwl->debugfs.fw_statistics = NULL;\r\nerr_root:\r\ndebugfs_remove(wl->debugfs.rootdir);\r\nwl->debugfs.rootdir = NULL;\r\nerr:\r\nreturn ret;\r\n}\r\nvoid wl1251_debugfs_exit(struct wl1251 *wl)\r\n{\r\nwl1251_debugfs_delete_files(wl);\r\nkfree(wl->stats.fw_stats);\r\nwl->stats.fw_stats = NULL;\r\ndebugfs_remove(wl->debugfs.fw_statistics);\r\nwl->debugfs.fw_statistics = NULL;\r\ndebugfs_remove(wl->debugfs.rootdir);\r\nwl->debugfs.rootdir = NULL;\r\n}

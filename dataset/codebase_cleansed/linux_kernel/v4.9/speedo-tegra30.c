static void __init fuse_speedo_calib(u32 *speedo_g, u32 *speedo_lp)\r\n{\r\nu32 reg;\r\nint ate_ver;\r\nint bit_minus1;\r\nint bit_minus2;\r\nreg = tegra_fuse_read_early(FUSE_SPEEDO_CALIB_0);\r\n*speedo_lp = (reg & 0xFFFF) * 4;\r\n*speedo_g = ((reg >> 16) & 0xFFFF) * 4;\r\nate_ver = tegra_fuse_read_early(FUSE_TEST_PROG_VER);\r\npr_debug("Tegra ATE prog ver %d.%d\n", ate_ver/10, ate_ver%10);\r\nif (ate_ver >= 26) {\r\nbit_minus1 = tegra_fuse_read_spare(LP_SPEEDO_BIT_MINUS1);\r\nbit_minus1 |= tegra_fuse_read_spare(LP_SPEEDO_BIT_MINUS1_R);\r\nbit_minus2 = tegra_fuse_read_spare(LP_SPEEDO_BIT_MINUS2);\r\nbit_minus2 |= tegra_fuse_read_spare(LP_SPEEDO_BIT_MINUS2_R);\r\n*speedo_lp |= (bit_minus1 << 1) | bit_minus2;\r\nbit_minus1 = tegra_fuse_read_spare(G_SPEEDO_BIT_MINUS1);\r\nbit_minus1 |= tegra_fuse_read_spare(G_SPEEDO_BIT_MINUS1_R);\r\nbit_minus2 = tegra_fuse_read_spare(G_SPEEDO_BIT_MINUS2);\r\nbit_minus2 |= tegra_fuse_read_spare(G_SPEEDO_BIT_MINUS2_R);\r\n*speedo_g |= (bit_minus1 << 1) | bit_minus2;\r\n} else {\r\n*speedo_lp |= 0x3;\r\n*speedo_g |= 0x3;\r\n}\r\n}\r\nstatic void __init rev_sku_to_speedo_ids(struct tegra_sku_info *sku_info)\r\n{\r\nint package_id = tegra_fuse_read_early(FUSE_PACKAGE_INFO) & 0x0F;\r\nswitch (sku_info->revision) {\r\ncase TEGRA_REVISION_A01:\r\nsku_info->cpu_speedo_id = 0;\r\nsku_info->soc_speedo_id = 0;\r\nthreshold_index = THRESHOLD_INDEX_0;\r\nbreak;\r\ncase TEGRA_REVISION_A02:\r\ncase TEGRA_REVISION_A03:\r\nswitch (sku_info->sku_id) {\r\ncase 0x87:\r\ncase 0x82:\r\nsku_info->cpu_speedo_id = 1;\r\nsku_info->soc_speedo_id = 1;\r\nthreshold_index = THRESHOLD_INDEX_1;\r\nbreak;\r\ncase 0x81:\r\nswitch (package_id) {\r\ncase 1:\r\nsku_info->cpu_speedo_id = 2;\r\nsku_info->soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_2;\r\nbreak;\r\ncase 2:\r\nsku_info->cpu_speedo_id = 4;\r\nsku_info->soc_speedo_id = 1;\r\nthreshold_index = THRESHOLD_INDEX_7;\r\nbreak;\r\ndefault:\r\npr_err("Tegra Unknown pkg %d\n", package_id);\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x80:\r\nswitch (package_id) {\r\ncase 1:\r\nsku_info->cpu_speedo_id = 5;\r\nsku_info->soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_8;\r\nbreak;\r\ncase 2:\r\nsku_info->cpu_speedo_id = 6;\r\nsku_info->soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_9;\r\nbreak;\r\ndefault:\r\npr_err("Tegra Unknown pkg %d\n", package_id);\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x83:\r\nswitch (package_id) {\r\ncase 1:\r\nsku_info->cpu_speedo_id = 7;\r\nsku_info->soc_speedo_id = 1;\r\nthreshold_index = THRESHOLD_INDEX_10;\r\nbreak;\r\ncase 2:\r\nsku_info->cpu_speedo_id = 3;\r\nsku_info->soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_3;\r\nbreak;\r\ndefault:\r\npr_err("Tegra Unknown pkg %d\n", package_id);\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x8F:\r\nsku_info->cpu_speedo_id = 8;\r\nsku_info->soc_speedo_id = 1;\r\nthreshold_index = THRESHOLD_INDEX_11;\r\nbreak;\r\ncase 0x08:\r\nsku_info->cpu_speedo_id = 1;\r\nsku_info->soc_speedo_id = 1;\r\nthreshold_index = THRESHOLD_INDEX_4;\r\nbreak;\r\ncase 0x02:\r\nsku_info->cpu_speedo_id = 2;\r\nsku_info->soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_5;\r\nbreak;\r\ncase 0x04:\r\nsku_info->cpu_speedo_id = 3;\r\nsku_info->soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_6;\r\nbreak;\r\ncase 0:\r\nswitch (package_id) {\r\ncase 1:\r\nsku_info->cpu_speedo_id = 2;\r\nsku_info->soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_2;\r\nbreak;\r\ncase 2:\r\nsku_info->cpu_speedo_id = 3;\r\nsku_info->soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_3;\r\nbreak;\r\ndefault:\r\npr_err("Tegra Unknown pkg %d\n", package_id);\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\npr_warn("Tegra Unknown SKU %d\n", sku_info->sku_id);\r\nsku_info->cpu_speedo_id = 0;\r\nsku_info->soc_speedo_id = 0;\r\nthreshold_index = THRESHOLD_INDEX_0;\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\npr_warn("Tegra Unknown chip rev %d\n", sku_info->revision);\r\nsku_info->cpu_speedo_id = 0;\r\nsku_info->soc_speedo_id = 0;\r\nthreshold_index = THRESHOLD_INDEX_0;\r\nbreak;\r\n}\r\n}\r\nvoid __init tegra30_init_speedo_data(struct tegra_sku_info *sku_info)\r\n{\r\nu32 cpu_speedo_val;\r\nu32 soc_speedo_val;\r\nint i;\r\nBUILD_BUG_ON(ARRAY_SIZE(cpu_process_speedos) !=\r\nTHRESHOLD_INDEX_COUNT);\r\nBUILD_BUG_ON(ARRAY_SIZE(soc_process_speedos) !=\r\nTHRESHOLD_INDEX_COUNT);\r\nrev_sku_to_speedo_ids(sku_info);\r\nfuse_speedo_calib(&cpu_speedo_val, &soc_speedo_val);\r\npr_debug("Tegra CPU speedo value %u\n", cpu_speedo_val);\r\npr_debug("Tegra Core speedo value %u\n", soc_speedo_val);\r\nfor (i = 0; i < CPU_PROCESS_CORNERS; i++) {\r\nif (cpu_speedo_val < cpu_process_speedos[threshold_index][i])\r\nbreak;\r\n}\r\nsku_info->cpu_process_id = i - 1;\r\nif (sku_info->cpu_process_id == -1) {\r\npr_warn("Tegra CPU speedo value %3d out of range",\r\ncpu_speedo_val);\r\nsku_info->cpu_process_id = 0;\r\nsku_info->cpu_speedo_id = 1;\r\n}\r\nfor (i = 0; i < SOC_PROCESS_CORNERS; i++) {\r\nif (soc_speedo_val < soc_process_speedos[threshold_index][i])\r\nbreak;\r\n}\r\nsku_info->soc_process_id = i - 1;\r\nif (sku_info->soc_process_id == -1) {\r\npr_warn("Tegra SoC speedo value %3d out of range",\r\nsoc_speedo_val);\r\nsku_info->soc_process_id = 0;\r\nsku_info->soc_speedo_id = 1;\r\n}\r\n}

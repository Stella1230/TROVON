int ath9k_cmn_init_channels_rates(struct ath_common *common)\r\n{\r\nstruct ath_hw *ah = (struct ath_hw *)common->ah;\r\nvoid *channels;\r\nBUILD_BUG_ON(ARRAY_SIZE(ath9k_2ghz_chantable) +\r\nARRAY_SIZE(ath9k_5ghz_chantable) !=\r\nATH9K_NUM_CHANNELS);\r\nif (ah->caps.hw_caps & ATH9K_HW_CAP_2GHZ) {\r\nchannels = devm_kzalloc(ah->dev,\r\nsizeof(ath9k_2ghz_chantable), GFP_KERNEL);\r\nif (!channels)\r\nreturn -ENOMEM;\r\nmemcpy(channels, ath9k_2ghz_chantable,\r\nsizeof(ath9k_2ghz_chantable));\r\ncommon->sbands[NL80211_BAND_2GHZ].channels = channels;\r\ncommon->sbands[NL80211_BAND_2GHZ].band = NL80211_BAND_2GHZ;\r\ncommon->sbands[NL80211_BAND_2GHZ].n_channels =\r\nARRAY_SIZE(ath9k_2ghz_chantable);\r\ncommon->sbands[NL80211_BAND_2GHZ].bitrates = ath9k_legacy_rates;\r\ncommon->sbands[NL80211_BAND_2GHZ].n_bitrates =\r\nARRAY_SIZE(ath9k_legacy_rates);\r\n}\r\nif (ah->caps.hw_caps & ATH9K_HW_CAP_5GHZ) {\r\nchannels = devm_kzalloc(ah->dev,\r\nsizeof(ath9k_5ghz_chantable), GFP_KERNEL);\r\nif (!channels)\r\nreturn -ENOMEM;\r\nmemcpy(channels, ath9k_5ghz_chantable,\r\nsizeof(ath9k_5ghz_chantable));\r\ncommon->sbands[NL80211_BAND_5GHZ].channels = channels;\r\ncommon->sbands[NL80211_BAND_5GHZ].band = NL80211_BAND_5GHZ;\r\ncommon->sbands[NL80211_BAND_5GHZ].n_channels =\r\nARRAY_SIZE(ath9k_5ghz_chantable);\r\ncommon->sbands[NL80211_BAND_5GHZ].bitrates =\r\nath9k_legacy_rates + 4;\r\ncommon->sbands[NL80211_BAND_5GHZ].n_bitrates =\r\nARRAY_SIZE(ath9k_legacy_rates) - 4;\r\n}\r\nreturn 0;\r\n}\r\nvoid ath9k_cmn_setup_ht_cap(struct ath_hw *ah,\r\nstruct ieee80211_sta_ht_cap *ht_info)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu8 tx_streams, rx_streams;\r\nint i, max_streams;\r\nht_info->ht_supported = true;\r\nht_info->cap = IEEE80211_HT_CAP_SUP_WIDTH_20_40 |\r\nIEEE80211_HT_CAP_SM_PS |\r\nIEEE80211_HT_CAP_SGI_40 |\r\nIEEE80211_HT_CAP_DSSSCCK40;\r\nif (ah->caps.hw_caps & ATH9K_HW_CAP_LDPC)\r\nht_info->cap |= IEEE80211_HT_CAP_LDPC_CODING;\r\nif (ah->caps.hw_caps & ATH9K_HW_CAP_SGI_20)\r\nht_info->cap |= IEEE80211_HT_CAP_SGI_20;\r\nht_info->ampdu_factor = IEEE80211_HT_MAX_AMPDU_64K;\r\nht_info->ampdu_density = IEEE80211_HT_MPDU_DENSITY_8;\r\nif (AR_SREV_9271(ah) || AR_SREV_9330(ah) || AR_SREV_9485(ah) || AR_SREV_9565(ah))\r\nmax_streams = 1;\r\nelse if (AR_SREV_9462(ah))\r\nmax_streams = 2;\r\nelse if (AR_SREV_9300_20_OR_LATER(ah))\r\nmax_streams = 3;\r\nelse\r\nmax_streams = 2;\r\nif (AR_SREV_9280_20_OR_LATER(ah)) {\r\nif (max_streams >= 2)\r\nht_info->cap |= IEEE80211_HT_CAP_TX_STBC;\r\nht_info->cap |= (1 << IEEE80211_HT_CAP_RX_STBC_SHIFT);\r\n}\r\nmemset(&ht_info->mcs, 0, sizeof(ht_info->mcs));\r\ntx_streams = ath9k_cmn_count_streams(ah->txchainmask, max_streams);\r\nrx_streams = ath9k_cmn_count_streams(ah->rxchainmask, max_streams);\r\nath_dbg(common, CONFIG, "TX streams %d, RX streams: %d\n",\r\ntx_streams, rx_streams);\r\nif (tx_streams != rx_streams) {\r\nht_info->mcs.tx_params |= IEEE80211_HT_MCS_TX_RX_DIFF;\r\nht_info->mcs.tx_params |= ((tx_streams - 1) <<\r\nIEEE80211_HT_MCS_TX_MAX_STREAMS_SHIFT);\r\n}\r\nfor (i = 0; i < rx_streams; i++)\r\nht_info->mcs.rx_mask[i] = 0xff;\r\nht_info->mcs.tx_params |= IEEE80211_HT_MCS_TX_DEFINED;\r\n}\r\nvoid ath9k_cmn_reload_chainmask(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nif (!(ah->caps.hw_caps & ATH9K_HW_CAP_HT))\r\nreturn;\r\nif (ah->caps.hw_caps & ATH9K_HW_CAP_2GHZ)\r\nath9k_cmn_setup_ht_cap(ah,\r\n&common->sbands[NL80211_BAND_2GHZ].ht_cap);\r\nif (ah->caps.hw_caps & ATH9K_HW_CAP_5GHZ)\r\nath9k_cmn_setup_ht_cap(ah,\r\n&common->sbands[NL80211_BAND_5GHZ].ht_cap);\r\n}

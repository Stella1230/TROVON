static inline u32 dwc3_omap_readl(void __iomem *base, u32 offset)\r\n{\r\nreturn readl(base + offset);\r\n}\r\nstatic inline void dwc3_omap_writel(void __iomem *base, u32 offset, u32 value)\r\n{\r\nwritel(value, base + offset);\r\n}\r\nstatic u32 dwc3_omap_read_utmi_ctrl(struct dwc3_omap *omap)\r\n{\r\nreturn dwc3_omap_readl(omap->base, USBOTGSS_UTMI_OTG_CTRL +\r\nomap->utmi_otg_offset);\r\n}\r\nstatic void dwc3_omap_write_utmi_ctrl(struct dwc3_omap *omap, u32 value)\r\n{\r\ndwc3_omap_writel(omap->base, USBOTGSS_UTMI_OTG_CTRL +\r\nomap->utmi_otg_offset, value);\r\n}\r\nstatic u32 dwc3_omap_read_irq0_status(struct dwc3_omap *omap)\r\n{\r\nreturn dwc3_omap_readl(omap->base, USBOTGSS_IRQSTATUS_RAW_0 -\r\nomap->irq0_offset);\r\n}\r\nstatic void dwc3_omap_write_irq0_status(struct dwc3_omap *omap, u32 value)\r\n{\r\ndwc3_omap_writel(omap->base, USBOTGSS_IRQSTATUS_0 -\r\nomap->irq0_offset, value);\r\n}\r\nstatic u32 dwc3_omap_read_irqmisc_status(struct dwc3_omap *omap)\r\n{\r\nreturn dwc3_omap_readl(omap->base, USBOTGSS_IRQSTATUS_RAW_MISC +\r\nomap->irqmisc_offset);\r\n}\r\nstatic void dwc3_omap_write_irqmisc_status(struct dwc3_omap *omap, u32 value)\r\n{\r\ndwc3_omap_writel(omap->base, USBOTGSS_IRQSTATUS_MISC +\r\nomap->irqmisc_offset, value);\r\n}\r\nstatic void dwc3_omap_write_irqmisc_set(struct dwc3_omap *omap, u32 value)\r\n{\r\ndwc3_omap_writel(omap->base, USBOTGSS_IRQENABLE_SET_MISC +\r\nomap->irqmisc_offset, value);\r\n}\r\nstatic void dwc3_omap_write_irq0_set(struct dwc3_omap *omap, u32 value)\r\n{\r\ndwc3_omap_writel(omap->base, USBOTGSS_IRQENABLE_SET_0 -\r\nomap->irq0_offset, value);\r\n}\r\nstatic void dwc3_omap_write_irqmisc_clr(struct dwc3_omap *omap, u32 value)\r\n{\r\ndwc3_omap_writel(omap->base, USBOTGSS_IRQENABLE_CLR_MISC +\r\nomap->irqmisc_offset, value);\r\n}\r\nstatic void dwc3_omap_write_irq0_clr(struct dwc3_omap *omap, u32 value)\r\n{\r\ndwc3_omap_writel(omap->base, USBOTGSS_IRQENABLE_CLR_0 -\r\nomap->irq0_offset, value);\r\n}\r\nstatic void dwc3_omap_set_mailbox(struct dwc3_omap *omap,\r\nenum omap_dwc3_vbus_id_status status)\r\n{\r\nint ret;\r\nu32 val;\r\nswitch (status) {\r\ncase OMAP_DWC3_ID_GROUND:\r\nif (omap->vbus_reg) {\r\nret = regulator_enable(omap->vbus_reg);\r\nif (ret) {\r\ndev_err(omap->dev, "regulator enable failed\n");\r\nreturn;\r\n}\r\n}\r\nval = dwc3_omap_read_utmi_ctrl(omap);\r\nval &= ~USBOTGSS_UTMI_OTG_CTRL_IDDIG;\r\ndwc3_omap_write_utmi_ctrl(omap, val);\r\nbreak;\r\ncase OMAP_DWC3_VBUS_VALID:\r\nval = dwc3_omap_read_utmi_ctrl(omap);\r\nval &= ~USBOTGSS_UTMI_OTG_CTRL_SESSEND;\r\nval |= USBOTGSS_UTMI_OTG_CTRL_VBUSVALID\r\n| USBOTGSS_UTMI_OTG_CTRL_SESSVALID;\r\ndwc3_omap_write_utmi_ctrl(omap, val);\r\nbreak;\r\ncase OMAP_DWC3_ID_FLOAT:\r\nif (omap->vbus_reg)\r\nregulator_disable(omap->vbus_reg);\r\nval = dwc3_omap_read_utmi_ctrl(omap);\r\nval |= USBOTGSS_UTMI_OTG_CTRL_IDDIG;\r\ndwc3_omap_write_utmi_ctrl(omap, val);\r\ncase OMAP_DWC3_VBUS_OFF:\r\nval = dwc3_omap_read_utmi_ctrl(omap);\r\nval &= ~(USBOTGSS_UTMI_OTG_CTRL_SESSVALID\r\n| USBOTGSS_UTMI_OTG_CTRL_VBUSVALID);\r\nval |= USBOTGSS_UTMI_OTG_CTRL_SESSEND;\r\ndwc3_omap_write_utmi_ctrl(omap, val);\r\nbreak;\r\ndefault:\r\ndev_WARN(omap->dev, "invalid state\n");\r\n}\r\n}\r\nstatic irqreturn_t dwc3_omap_interrupt(int irq, void *_omap)\r\n{\r\nstruct dwc3_omap *omap = _omap;\r\nif (dwc3_omap_read_irqmisc_status(omap) ||\r\ndwc3_omap_read_irq0_status(omap)) {\r\ndwc3_omap_disable_irqs(omap);\r\nreturn IRQ_WAKE_THREAD;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic irqreturn_t dwc3_omap_interrupt_thread(int irq, void *_omap)\r\n{\r\nstruct dwc3_omap *omap = _omap;\r\nu32 reg;\r\nreg = dwc3_omap_read_irqmisc_status(omap);\r\ndwc3_omap_write_irqmisc_status(omap, reg);\r\nreg = dwc3_omap_read_irq0_status(omap);\r\ndwc3_omap_write_irq0_status(omap, reg);\r\ndwc3_omap_enable_irqs(omap);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void dwc3_omap_enable_irqs(struct dwc3_omap *omap)\r\n{\r\nu32 reg;\r\nreg = USBOTGSS_IRQO_COREIRQ_ST;\r\ndwc3_omap_write_irq0_set(omap, reg);\r\nreg = (USBOTGSS_IRQMISC_OEVT |\r\nUSBOTGSS_IRQMISC_DRVVBUS_RISE |\r\nUSBOTGSS_IRQMISC_CHRGVBUS_RISE |\r\nUSBOTGSS_IRQMISC_DISCHRGVBUS_RISE |\r\nUSBOTGSS_IRQMISC_IDPULLUP_RISE |\r\nUSBOTGSS_IRQMISC_DRVVBUS_FALL |\r\nUSBOTGSS_IRQMISC_CHRGVBUS_FALL |\r\nUSBOTGSS_IRQMISC_DISCHRGVBUS_FALL |\r\nUSBOTGSS_IRQMISC_IDPULLUP_FALL);\r\ndwc3_omap_write_irqmisc_set(omap, reg);\r\n}\r\nstatic void dwc3_omap_disable_irqs(struct dwc3_omap *omap)\r\n{\r\nu32 reg;\r\nreg = USBOTGSS_IRQO_COREIRQ_ST;\r\ndwc3_omap_write_irq0_clr(omap, reg);\r\nreg = (USBOTGSS_IRQMISC_OEVT |\r\nUSBOTGSS_IRQMISC_DRVVBUS_RISE |\r\nUSBOTGSS_IRQMISC_CHRGVBUS_RISE |\r\nUSBOTGSS_IRQMISC_DISCHRGVBUS_RISE |\r\nUSBOTGSS_IRQMISC_IDPULLUP_RISE |\r\nUSBOTGSS_IRQMISC_DRVVBUS_FALL |\r\nUSBOTGSS_IRQMISC_CHRGVBUS_FALL |\r\nUSBOTGSS_IRQMISC_DISCHRGVBUS_FALL |\r\nUSBOTGSS_IRQMISC_IDPULLUP_FALL);\r\ndwc3_omap_write_irqmisc_clr(omap, reg);\r\n}\r\nstatic int dwc3_omap_id_notifier(struct notifier_block *nb,\r\nunsigned long event, void *ptr)\r\n{\r\nstruct dwc3_omap *omap = container_of(nb, struct dwc3_omap, id_nb);\r\nif (event)\r\ndwc3_omap_set_mailbox(omap, OMAP_DWC3_ID_GROUND);\r\nelse\r\ndwc3_omap_set_mailbox(omap, OMAP_DWC3_ID_FLOAT);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int dwc3_omap_vbus_notifier(struct notifier_block *nb,\r\nunsigned long event, void *ptr)\r\n{\r\nstruct dwc3_omap *omap = container_of(nb, struct dwc3_omap, vbus_nb);\r\nif (event)\r\ndwc3_omap_set_mailbox(omap, OMAP_DWC3_VBUS_VALID);\r\nelse\r\ndwc3_omap_set_mailbox(omap, OMAP_DWC3_VBUS_OFF);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic void dwc3_omap_map_offset(struct dwc3_omap *omap)\r\n{\r\nstruct device_node *node = omap->dev->of_node;\r\nif (of_device_is_compatible(node, "ti,am437x-dwc3")) {\r\nomap->irq_eoi_offset = USBOTGSS_EOI_OFFSET;\r\nomap->irq0_offset = USBOTGSS_IRQ0_OFFSET;\r\nomap->irqmisc_offset = USBOTGSS_IRQMISC_OFFSET;\r\nomap->utmi_otg_offset = USBOTGSS_UTMI_OTG_OFFSET;\r\nomap->debug_offset = USBOTGSS_DEBUG_OFFSET;\r\n}\r\n}\r\nstatic void dwc3_omap_set_utmi_mode(struct dwc3_omap *omap)\r\n{\r\nu32 reg;\r\nstruct device_node *node = omap->dev->of_node;\r\nint utmi_mode = 0;\r\nreg = dwc3_omap_read_utmi_ctrl(omap);\r\nof_property_read_u32(node, "utmi-mode", &utmi_mode);\r\nswitch (utmi_mode) {\r\ncase DWC3_OMAP_UTMI_MODE_SW:\r\nreg |= USBOTGSS_UTMI_OTG_CTRL_SW_MODE;\r\nbreak;\r\ncase DWC3_OMAP_UTMI_MODE_HW:\r\nreg &= ~USBOTGSS_UTMI_OTG_CTRL_SW_MODE;\r\nbreak;\r\ndefault:\r\ndev_WARN(omap->dev, "UNKNOWN utmi mode %d\n", utmi_mode);\r\n}\r\ndwc3_omap_write_utmi_ctrl(omap, reg);\r\n}\r\nstatic int dwc3_omap_extcon_register(struct dwc3_omap *omap)\r\n{\r\nint ret;\r\nstruct device_node *node = omap->dev->of_node;\r\nstruct extcon_dev *edev;\r\nif (of_property_read_bool(node, "extcon")) {\r\nedev = extcon_get_edev_by_phandle(omap->dev, 0);\r\nif (IS_ERR(edev)) {\r\ndev_vdbg(omap->dev, "couldn't get extcon device\n");\r\nreturn -EPROBE_DEFER;\r\n}\r\nomap->vbus_nb.notifier_call = dwc3_omap_vbus_notifier;\r\nret = extcon_register_notifier(edev, EXTCON_USB,\r\n&omap->vbus_nb);\r\nif (ret < 0)\r\ndev_vdbg(omap->dev, "failed to register notifier for USB\n");\r\nomap->id_nb.notifier_call = dwc3_omap_id_notifier;\r\nret = extcon_register_notifier(edev, EXTCON_USB_HOST,\r\n&omap->id_nb);\r\nif (ret < 0)\r\ndev_vdbg(omap->dev, "failed to register notifier for USB-HOST\n");\r\nif (extcon_get_cable_state_(edev, EXTCON_USB) == true)\r\ndwc3_omap_set_mailbox(omap, OMAP_DWC3_VBUS_VALID);\r\nif (extcon_get_cable_state_(edev, EXTCON_USB_HOST) == true)\r\ndwc3_omap_set_mailbox(omap, OMAP_DWC3_ID_GROUND);\r\nomap->edev = edev;\r\n}\r\nreturn 0;\r\n}\r\nstatic int dwc3_omap_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct dwc3_omap *omap;\r\nstruct resource *res;\r\nstruct device *dev = &pdev->dev;\r\nstruct regulator *vbus_reg = NULL;\r\nint ret;\r\nint irq;\r\nu32 reg;\r\nvoid __iomem *base;\r\nif (!node) {\r\ndev_err(dev, "device node not found\n");\r\nreturn -EINVAL;\r\n}\r\nomap = devm_kzalloc(dev, sizeof(*omap), GFP_KERNEL);\r\nif (!omap)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, omap);\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(dev, "missing IRQ resource\n");\r\nreturn -EINVAL;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\nif (of_property_read_bool(node, "vbus-supply")) {\r\nvbus_reg = devm_regulator_get(dev, "vbus");\r\nif (IS_ERR(vbus_reg)) {\r\ndev_err(dev, "vbus init failed\n");\r\nreturn PTR_ERR(vbus_reg);\r\n}\r\n}\r\nomap->dev = dev;\r\nomap->irq = irq;\r\nomap->base = base;\r\nomap->vbus_reg = vbus_reg;\r\npm_runtime_enable(dev);\r\nret = pm_runtime_get_sync(dev);\r\nif (ret < 0) {\r\ndev_err(dev, "get_sync failed with err %d\n", ret);\r\ngoto err1;\r\n}\r\ndwc3_omap_map_offset(omap);\r\ndwc3_omap_set_utmi_mode(omap);\r\nreg = dwc3_omap_readl(omap->base, USBOTGSS_SYSCONFIG);\r\nret = devm_request_threaded_irq(dev, omap->irq, dwc3_omap_interrupt,\r\ndwc3_omap_interrupt_thread, IRQF_SHARED,\r\n"dwc3-omap", omap);\r\nif (ret) {\r\ndev_err(dev, "failed to request IRQ #%d --> %d\n",\r\nomap->irq, ret);\r\ngoto err1;\r\n}\r\nret = dwc3_omap_extcon_register(omap);\r\nif (ret < 0)\r\ngoto err1;\r\nret = of_platform_populate(node, NULL, NULL, dev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to create dwc3 core\n");\r\ngoto err2;\r\n}\r\ndwc3_omap_enable_irqs(omap);\r\nreturn 0;\r\nerr2:\r\nextcon_unregister_notifier(omap->edev, EXTCON_USB, &omap->vbus_nb);\r\nextcon_unregister_notifier(omap->edev, EXTCON_USB_HOST, &omap->id_nb);\r\nerr1:\r\npm_runtime_put_sync(dev);\r\npm_runtime_disable(dev);\r\nreturn ret;\r\n}\r\nstatic int dwc3_omap_remove(struct platform_device *pdev)\r\n{\r\nstruct dwc3_omap *omap = platform_get_drvdata(pdev);\r\nextcon_unregister_notifier(omap->edev, EXTCON_USB, &omap->vbus_nb);\r\nextcon_unregister_notifier(omap->edev, EXTCON_USB_HOST, &omap->id_nb);\r\ndwc3_omap_disable_irqs(omap);\r\nof_platform_depopulate(omap->dev);\r\npm_runtime_put_sync(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\nreturn 0;\r\n}\r\nstatic int dwc3_omap_suspend(struct device *dev)\r\n{\r\nstruct dwc3_omap *omap = dev_get_drvdata(dev);\r\nomap->utmi_otg_ctrl = dwc3_omap_read_utmi_ctrl(omap);\r\ndwc3_omap_disable_irqs(omap);\r\nreturn 0;\r\n}\r\nstatic int dwc3_omap_resume(struct device *dev)\r\n{\r\nstruct dwc3_omap *omap = dev_get_drvdata(dev);\r\ndwc3_omap_write_utmi_ctrl(omap, omap->utmi_otg_ctrl);\r\ndwc3_omap_enable_irqs(omap);\r\npm_runtime_disable(dev);\r\npm_runtime_set_active(dev);\r\npm_runtime_enable(dev);\r\nreturn 0;\r\n}

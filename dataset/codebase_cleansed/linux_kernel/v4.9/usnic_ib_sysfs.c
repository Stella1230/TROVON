static ssize_t usnic_ib_show_board(struct device *device,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usnic_ib_dev *us_ibdev =\r\ncontainer_of(device, struct usnic_ib_dev, ib_dev.dev);\r\nunsigned short subsystem_device_id;\r\nmutex_lock(&us_ibdev->usdev_lock);\r\nsubsystem_device_id = us_ibdev->pdev->subsystem_device;\r\nmutex_unlock(&us_ibdev->usdev_lock);\r\nreturn scnprintf(buf, PAGE_SIZE, "%hu\n", subsystem_device_id);\r\n}\r\nstatic ssize_t\r\nusnic_ib_show_config(struct device *device, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usnic_ib_dev *us_ibdev;\r\nchar *ptr;\r\nunsigned left;\r\nunsigned n;\r\nenum usnic_vnic_res_type res_type;\r\nus_ibdev = container_of(device, struct usnic_ib_dev, ib_dev.dev);\r\nptr = buf;\r\nleft = PAGE_SIZE;\r\nmutex_lock(&us_ibdev->usdev_lock);\r\nif (atomic_read(&us_ibdev->vf_cnt.refcount) > 0) {\r\nchar *busname;\r\nbusname = us_ibdev->pdev->bus->name;\r\nif (strncmp(busname, "PCI Bus ", 8) == 0)\r\nbusname += 8;\r\nn = scnprintf(ptr, left,\r\n"%s: %s:%d.%d, %s, %pM, %u VFs\n Per VF:",\r\nus_ibdev->ib_dev.name,\r\nbusname,\r\nPCI_SLOT(us_ibdev->pdev->devfn),\r\nPCI_FUNC(us_ibdev->pdev->devfn),\r\nnetdev_name(us_ibdev->netdev),\r\nus_ibdev->ufdev->mac,\r\natomic_read(&us_ibdev->vf_cnt.refcount));\r\nUPDATE_PTR_LEFT(n, ptr, left);\r\nfor (res_type = USNIC_VNIC_RES_TYPE_EOL;\r\nres_type < USNIC_VNIC_RES_TYPE_MAX;\r\nres_type++) {\r\nif (us_ibdev->vf_res_cnt[res_type] == 0)\r\ncontinue;\r\nn = scnprintf(ptr, left, " %d %s%s",\r\nus_ibdev->vf_res_cnt[res_type],\r\nusnic_vnic_res_type_to_str(res_type),\r\n(res_type < (USNIC_VNIC_RES_TYPE_MAX - 1)) ?\r\n"," : "");\r\nUPDATE_PTR_LEFT(n, ptr, left);\r\n}\r\nn = scnprintf(ptr, left, "\n");\r\nUPDATE_PTR_LEFT(n, ptr, left);\r\n} else {\r\nn = scnprintf(ptr, left, "%s: no VFs\n",\r\nus_ibdev->ib_dev.name);\r\nUPDATE_PTR_LEFT(n, ptr, left);\r\n}\r\nmutex_unlock(&us_ibdev->usdev_lock);\r\nreturn ptr - buf;\r\n}\r\nstatic ssize_t\r\nusnic_ib_show_iface(struct device *device, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usnic_ib_dev *us_ibdev;\r\nus_ibdev = container_of(device, struct usnic_ib_dev, ib_dev.dev);\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n",\r\nnetdev_name(us_ibdev->netdev));\r\n}\r\nstatic ssize_t\r\nusnic_ib_show_max_vf(struct device *device, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usnic_ib_dev *us_ibdev;\r\nus_ibdev = container_of(device, struct usnic_ib_dev, ib_dev.dev);\r\nreturn scnprintf(buf, PAGE_SIZE, "%u\n",\r\natomic_read(&us_ibdev->vf_cnt.refcount));\r\n}\r\nstatic ssize_t\r\nusnic_ib_show_qp_per_vf(struct device *device, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usnic_ib_dev *us_ibdev;\r\nint qp_per_vf;\r\nus_ibdev = container_of(device, struct usnic_ib_dev, ib_dev.dev);\r\nqp_per_vf = max(us_ibdev->vf_res_cnt[USNIC_VNIC_RES_TYPE_WQ],\r\nus_ibdev->vf_res_cnt[USNIC_VNIC_RES_TYPE_RQ]);\r\nreturn scnprintf(buf, PAGE_SIZE,\r\n"%d\n", qp_per_vf);\r\n}\r\nstatic ssize_t\r\nusnic_ib_show_cq_per_vf(struct device *device, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usnic_ib_dev *us_ibdev;\r\nus_ibdev = container_of(device, struct usnic_ib_dev, ib_dev.dev);\r\nreturn scnprintf(buf, PAGE_SIZE, "%d\n",\r\nus_ibdev->vf_res_cnt[USNIC_VNIC_RES_TYPE_CQ]);\r\n}\r\nstatic ssize_t\r\nusnic_ib_qpn_attr_show(struct kobject *kobj, struct attribute *attr, char *buf)\r\n{\r\nstruct usnic_ib_qp_grp *qp_grp;\r\nstruct qpn_attribute *qpn_attr;\r\nqp_grp = container_of(kobj, struct usnic_ib_qp_grp, kobj);\r\nqpn_attr = container_of(attr, struct qpn_attribute, attr);\r\nreturn qpn_attr->show(qp_grp, buf);\r\n}\r\nstatic ssize_t context_show(struct usnic_ib_qp_grp *qp_grp, char *buf)\r\n{\r\nreturn scnprintf(buf, PAGE_SIZE, "0x%p\n", qp_grp->ctx);\r\n}\r\nstatic ssize_t summary_show(struct usnic_ib_qp_grp *qp_grp, char *buf)\r\n{\r\nint i, j, n;\r\nint left;\r\nchar *ptr;\r\nstruct usnic_vnic_res_chunk *res_chunk;\r\nstruct usnic_vnic_res *vnic_res;\r\nleft = PAGE_SIZE;\r\nptr = buf;\r\nn = scnprintf(ptr, left,\r\n"QPN: %d State: (%s) PID: %u VF Idx: %hu ",\r\nqp_grp->ibqp.qp_num,\r\nusnic_ib_qp_grp_state_to_string(qp_grp->state),\r\nqp_grp->owner_pid,\r\nusnic_vnic_get_index(qp_grp->vf->vnic));\r\nUPDATE_PTR_LEFT(n, ptr, left);\r\nfor (i = 0; qp_grp->res_chunk_list[i]; i++) {\r\nres_chunk = qp_grp->res_chunk_list[i];\r\nfor (j = 0; j < res_chunk->cnt; j++) {\r\nvnic_res = res_chunk->res[j];\r\nn = scnprintf(ptr, left, "%s[%d] ",\r\nusnic_vnic_res_type_to_str(vnic_res->type),\r\nvnic_res->vnic_idx);\r\nUPDATE_PTR_LEFT(n, ptr, left);\r\n}\r\n}\r\nn = scnprintf(ptr, left, "\n");\r\nUPDATE_PTR_LEFT(n, ptr, left);\r\nreturn ptr - buf;\r\n}\r\nint usnic_ib_sysfs_register_usdev(struct usnic_ib_dev *us_ibdev)\r\n{\r\nint i;\r\nint err;\r\nfor (i = 0; i < ARRAY_SIZE(usnic_class_attributes); ++i) {\r\nerr = device_create_file(&us_ibdev->ib_dev.dev,\r\nusnic_class_attributes[i]);\r\nif (err) {\r\nusnic_err("Failed to create device file %d for %s eith err %d",\r\ni, us_ibdev->ib_dev.name, err);\r\nreturn -EINVAL;\r\n}\r\n}\r\nkobject_get(&us_ibdev->ib_dev.dev.kobj);\r\nus_ibdev->qpn_kobj = kobject_create_and_add("qpn",\r\n&us_ibdev->ib_dev.dev.kobj);\r\nif (us_ibdev->qpn_kobj == NULL) {\r\nkobject_put(&us_ibdev->ib_dev.dev.kobj);\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nvoid usnic_ib_sysfs_unregister_usdev(struct usnic_ib_dev *us_ibdev)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(usnic_class_attributes); ++i) {\r\ndevice_remove_file(&us_ibdev->ib_dev.dev,\r\nusnic_class_attributes[i]);\r\n}\r\nkobject_put(us_ibdev->qpn_kobj);\r\n}\r\nvoid usnic_ib_sysfs_qpn_add(struct usnic_ib_qp_grp *qp_grp)\r\n{\r\nstruct usnic_ib_dev *us_ibdev;\r\nint err;\r\nus_ibdev = qp_grp->vf->pf;\r\nerr = kobject_init_and_add(&qp_grp->kobj, &usnic_ib_qpn_type,\r\nkobject_get(us_ibdev->qpn_kobj),\r\n"%d", qp_grp->grp_id);\r\nif (err) {\r\nkobject_put(us_ibdev->qpn_kobj);\r\nreturn;\r\n}\r\n}\r\nvoid usnic_ib_sysfs_qpn_remove(struct usnic_ib_qp_grp *qp_grp)\r\n{\r\nstruct usnic_ib_dev *us_ibdev;\r\nus_ibdev = qp_grp->vf->pf;\r\nkobject_put(&qp_grp->kobj);\r\nkobject_put(us_ibdev->qpn_kobj);\r\n}

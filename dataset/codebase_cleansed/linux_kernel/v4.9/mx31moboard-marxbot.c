static int marxbot_sdhc2_get_ro(struct device *dev)\r\n{\r\nreturn !gpio_get_value(SDHC2_WP);\r\n}\r\nstatic int marxbot_sdhc2_init(struct device *dev, irq_handler_t detect_irq,\r\nvoid *data)\r\n{\r\nint ret;\r\nret = gpio_request(SDHC2_CD, "sdhc-detect");\r\nif (ret)\r\nreturn ret;\r\ngpio_direction_input(SDHC2_CD);\r\nret = gpio_request(SDHC2_WP, "sdhc-wp");\r\nif (ret)\r\ngoto err_gpio_free;\r\ngpio_direction_input(SDHC2_WP);\r\nret = request_irq(gpio_to_irq(SDHC2_CD), detect_irq,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\r\n"sdhc2-card-detect", data);\r\nif (ret)\r\ngoto err_gpio_free_2;\r\nreturn 0;\r\nerr_gpio_free_2:\r\ngpio_free(SDHC2_WP);\r\nerr_gpio_free:\r\ngpio_free(SDHC2_CD);\r\nreturn ret;\r\n}\r\nstatic void marxbot_sdhc2_exit(struct device *dev, void *data)\r\n{\r\nfree_irq(gpio_to_irq(SDHC2_CD), data);\r\ngpio_free(SDHC2_WP);\r\ngpio_free(SDHC2_CD);\r\n}\r\nstatic void dspics_resets_init(void)\r\n{\r\nif (!gpio_request(TRSLAT_RST_B, "translator-rst")) {\r\ngpio_direction_output(TRSLAT_RST_B, 0);\r\ngpio_export(TRSLAT_RST_B, false);\r\n}\r\nif (!gpio_request(DSPICS_RST_B, "dspics-rst")) {\r\ngpio_direction_output(DSPICS_RST_B, 0);\r\ngpio_export(DSPICS_RST_B, false);\r\n}\r\n}\r\nstatic int marxbot_basecam_power(struct device *dev, int on)\r\n{\r\ngpio_set_value(BASECAM_POWER, !on);\r\nreturn 0;\r\n}\r\nstatic int marxbot_basecam_reset(struct device *dev)\r\n{\r\ngpio_set_value(BASECAM_RST_B, 0);\r\nudelay(100);\r\ngpio_set_value(BASECAM_RST_B, 1);\r\nreturn 0;\r\n}\r\nstatic int __init marxbot_cam_init(void)\r\n{\r\nint ret = gpio_request(CAM_CHOICE, "cam-choice");\r\nif (ret)\r\nreturn ret;\r\ngpio_direction_output(CAM_CHOICE, 0);\r\nret = gpio_request(BASECAM_RST_B, "basecam-reset");\r\nif (ret)\r\nreturn ret;\r\ngpio_direction_output(BASECAM_RST_B, 1);\r\nret = gpio_request(BASECAM_POWER, "basecam-standby");\r\nif (ret)\r\nreturn ret;\r\ngpio_direction_output(BASECAM_POWER, 0);\r\nret = gpio_request(TURRETCAM_RST_B, "turretcam-reset");\r\nif (ret)\r\nreturn ret;\r\ngpio_direction_output(TURRETCAM_RST_B, 1);\r\nret = gpio_request(TURRETCAM_POWER, "turretcam-standby");\r\nif (ret)\r\nreturn ret;\r\ngpio_direction_output(TURRETCAM_POWER, 0);\r\nreturn 0;\r\n}\r\nstatic void marxbot_init_sel_gpios(void)\r\n{\r\nif (!gpio_request(SEL0, "sel0")) {\r\ngpio_direction_input(SEL0);\r\ngpio_export(SEL0, true);\r\n}\r\nif (!gpio_request(SEL1, "sel1")) {\r\ngpio_direction_input(SEL1);\r\ngpio_export(SEL1, true);\r\n}\r\nif (!gpio_request(SEL2, "sel2")) {\r\ngpio_direction_input(SEL2);\r\ngpio_export(SEL2, true);\r\n}\r\nif (!gpio_request(SEL3, "sel3")) {\r\ngpio_direction_input(SEL3);\r\ngpio_export(SEL3, true);\r\n}\r\n}\r\nstatic int marxbot_usbh1_hw_init(struct platform_device *pdev)\r\n{\r\nmxc_iomux_set_gpr(MUX_PGP_USB_SUSPEND, true);\r\nmxc_iomux_set_pad(MX31_PIN_CSPI1_MISO, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_CSPI1_MOSI, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_CSPI1_SS0, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_CSPI1_SS1, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_CSPI1_SS2, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_CSPI1_SCLK, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_CSPI1_SPI_RDY, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_SFS6, USB_PAD_CFG);\r\nmdelay(10);\r\nreturn mx31_initialize_usb_hw(pdev->id, MXC_EHCI_POWER_PINS_ENABLED |\r\nMXC_EHCI_INTERFACE_SINGLE_UNI);\r\n}\r\nstatic int marxbot_isp1105_init(struct usb_phy *otg)\r\n{\r\nint ret = gpio_request(USBH1_MODE, "usbh1-mode");\r\nif (ret)\r\nreturn ret;\r\ngpio_direction_output(USBH1_MODE, 0);\r\nret = gpio_request(USBH1_VBUSEN_B, "usbh1-vbusen");\r\nif (ret) {\r\ngpio_free(USBH1_MODE);\r\nreturn ret;\r\n}\r\ngpio_direction_output(USBH1_VBUSEN_B, 1);\r\nreturn 0;\r\n}\r\nstatic int marxbot_isp1105_set_vbus(struct usb_otg *otg, bool on)\r\n{\r\nif (on)\r\ngpio_set_value(USBH1_VBUSEN_B, 0);\r\nelse\r\ngpio_set_value(USBH1_VBUSEN_B, 1);\r\nreturn 0;\r\n}\r\nstatic int __init marxbot_usbh1_init(void)\r\n{\r\nstruct usb_phy *phy;\r\nstruct platform_device *pdev;\r\nphy = kzalloc(sizeof(*phy), GFP_KERNEL);\r\nif (!phy)\r\nreturn -ENOMEM;\r\nphy->otg = kzalloc(sizeof(struct usb_otg), GFP_KERNEL);\r\nif (!phy->otg) {\r\nkfree(phy);\r\nreturn -ENOMEM;\r\n}\r\nphy->label = "ISP1105";\r\nphy->init = marxbot_isp1105_init;\r\nphy->otg->set_vbus = marxbot_isp1105_set_vbus;\r\nusbh1_pdata.otg = phy;\r\npdev = imx31_add_mxc_ehci_hs(1, &usbh1_pdata);\r\nreturn PTR_ERR_OR_ZERO(pdev);\r\n}\r\nvoid __init mx31moboard_marxbot_init(void)\r\n{\r\nprintk(KERN_INFO "Initializing mx31marxbot peripherals\n");\r\nmxc_iomux_setup_multiple_pins(marxbot_pins, ARRAY_SIZE(marxbot_pins),\r\n"marxbot");\r\nmarxbot_init_sel_gpios();\r\ndspics_resets_init();\r\nimx31_add_mxc_mmc(1, &sdhc2_pdata);\r\nspi_register_board_info(marxbot_spi_board_info,\r\nARRAY_SIZE(marxbot_spi_board_info));\r\nmarxbot_cam_init();\r\nplatform_add_devices(marxbot_cameras, ARRAY_SIZE(marxbot_cameras));\r\ngpio_request(IOMUX_TO_GPIO(MX31_PIN_LCS0), "bat-present");\r\ngpio_direction_input(IOMUX_TO_GPIO(MX31_PIN_LCS0));\r\ngpio_export(IOMUX_TO_GPIO(MX31_PIN_LCS0), false);\r\nimx31_add_fsl_usb2_udc(&usb_pdata);\r\nmarxbot_usbh1_init();\r\n}

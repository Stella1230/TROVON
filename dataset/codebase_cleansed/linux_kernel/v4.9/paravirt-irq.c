static int cpunum_for_cpu(int cpu)\r\n{\r\n#ifdef CONFIG_SMP\r\nreturn cpu_logical_map(cpu);\r\n#else\r\nreturn get_ebase_cpunum();\r\n#endif\r\n}\r\nstatic void irq_core_ack(struct irq_data *data)\r\n{\r\nstruct core_chip_data *cd = irq_data_get_irq_chip_data(data);\r\nunsigned int bit = cd->bit;\r\nclear_c0_status(0x100 << bit);\r\nif (bit < 2)\r\nclear_c0_cause(0x100 << bit);\r\n}\r\nstatic void irq_core_eoi(struct irq_data *data)\r\n{\r\nstruct core_chip_data *cd = irq_data_get_irq_chip_data(data);\r\nset_c0_status(0x100 << cd->bit);\r\n}\r\nstatic void irq_core_set_enable_local(void *arg)\r\n{\r\nstruct irq_data *data = arg;\r\nstruct core_chip_data *cd = irq_data_get_irq_chip_data(data);\r\nunsigned int mask = 0x100 << cd->bit;\r\nif (cd->desired_en)\r\nset_c0_status(mask);\r\nelse\r\nclear_c0_status(mask);\r\n}\r\nstatic void irq_core_disable(struct irq_data *data)\r\n{\r\nstruct core_chip_data *cd = irq_data_get_irq_chip_data(data);\r\ncd->desired_en = false;\r\n}\r\nstatic void irq_core_enable(struct irq_data *data)\r\n{\r\nstruct core_chip_data *cd = irq_data_get_irq_chip_data(data);\r\ncd->desired_en = true;\r\n}\r\nstatic void irq_core_bus_lock(struct irq_data *data)\r\n{\r\nstruct core_chip_data *cd = irq_data_get_irq_chip_data(data);\r\nmutex_lock(&cd->core_irq_mutex);\r\n}\r\nstatic void irq_core_bus_sync_unlock(struct irq_data *data)\r\n{\r\nstruct core_chip_data *cd = irq_data_get_irq_chip_data(data);\r\nif (cd->desired_en != cd->current_en) {\r\non_each_cpu(irq_core_set_enable_local, data, 1);\r\ncd->current_en = cd->desired_en;\r\n}\r\nmutex_unlock(&cd->core_irq_mutex);\r\n}\r\nstatic void __init irq_init_core(void)\r\n{\r\nint i;\r\nint irq;\r\nstruct core_chip_data *cd;\r\nclear_c0_status(ST0_IM);\r\nclear_c0_cause(CAUSEF_IP0 | CAUSEF_IP1);\r\nfor (i = 0; i < ARRAY_SIZE(irq_core_chip_data); i++) {\r\ncd = irq_core_chip_data + i;\r\ncd->current_en = false;\r\ncd->desired_en = false;\r\ncd->bit = i;\r\nmutex_init(&cd->core_irq_mutex);\r\nirq = MIPS_CPU_IRQ_BASE + i;\r\nswitch (i) {\r\ncase 0:\r\ncase 1:\r\ncase 5:\r\ncase 6:\r\ncase 7:\r\nirq_set_chip_data(irq, cd);\r\nirq_set_chip_and_handler(irq, &irq_chip_core,\r\nhandle_percpu_irq);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void irq_pci_enable(struct irq_data *data)\r\n{\r\nu32 mask = 1u << data->irq;\r\n__raw_writel(mask, mips_irq_chip + mips_irq_chip_reg_en_w1s);\r\n}\r\nstatic void irq_pci_disable(struct irq_data *data)\r\n{\r\nu32 mask = 1u << data->irq;\r\n__raw_writel(mask, mips_irq_chip + mips_irq_chip_reg_en_w1c);\r\n}\r\nstatic void irq_pci_ack(struct irq_data *data)\r\n{\r\n}\r\nstatic void irq_pci_mask(struct irq_data *data)\r\n{\r\nu32 mask = 1u << data->irq;\r\n__raw_writel(mask, mips_irq_chip + mips_irq_chip_reg_en_w1c);\r\n}\r\nstatic void irq_pci_unmask(struct irq_data *data)\r\n{\r\nu32 mask = 1u << data->irq;\r\n__raw_writel(mask, mips_irq_chip + mips_irq_chip_reg_en_w1s);\r\n}\r\nstatic void irq_mbox_all(struct irq_data *data, void __iomem *base)\r\n{\r\nint cpu;\r\nunsigned int mbox = data->irq - MIPS_IRQ_MBOX0;\r\nu32 mask;\r\nWARN_ON(mbox >= MBOX_BITS_PER_CPU);\r\nfor_each_online_cpu(cpu) {\r\nunsigned int cpuid = cpunum_for_cpu(cpu);\r\nmask = 1 << (cpuid * MBOX_BITS_PER_CPU + mbox);\r\n__raw_writel(mask, base + (cpuid * mips_irq_cpu_stride));\r\n}\r\n}\r\nstatic void irq_mbox_enable(struct irq_data *data)\r\n{\r\nirq_mbox_all(data, mips_irq_chip + mips_irq_chip_reg_en_w1s + sizeof(u32));\r\n}\r\nstatic void irq_mbox_disable(struct irq_data *data)\r\n{\r\nirq_mbox_all(data, mips_irq_chip + mips_irq_chip_reg_en_w1c + sizeof(u32));\r\n}\r\nstatic void irq_mbox_ack(struct irq_data *data)\r\n{\r\nu32 mask;\r\nunsigned int mbox = data->irq - MIPS_IRQ_MBOX0;\r\nWARN_ON(mbox >= MBOX_BITS_PER_CPU);\r\nmask = 1 << (get_ebase_cpunum() * MBOX_BITS_PER_CPU + mbox);\r\n__raw_writel(mask, mips_irq_chip + mips_irq_chip_reg_raw_w1c + sizeof(u32));\r\n}\r\nvoid irq_mbox_ipi(int cpu, unsigned int actions)\r\n{\r\nunsigned int cpuid = cpunum_for_cpu(cpu);\r\nu32 mask;\r\nWARN_ON(actions >= (1 << MBOX_BITS_PER_CPU));\r\nmask = actions << (cpuid * MBOX_BITS_PER_CPU);\r\n__raw_writel(mask, mips_irq_chip + mips_irq_chip_reg_raw_w1s + sizeof(u32));\r\n}\r\nstatic void irq_mbox_cpu_onoffline(struct irq_data *data, void __iomem *base)\r\n{\r\nunsigned int mbox = data->irq - MIPS_IRQ_MBOX0;\r\nunsigned int cpuid = get_ebase_cpunum();\r\nu32 mask;\r\nWARN_ON(mbox >= MBOX_BITS_PER_CPU);\r\nmask = 1 << (cpuid * MBOX_BITS_PER_CPU + mbox);\r\n__raw_writel(mask, base + (cpuid * mips_irq_cpu_stride));\r\n}\r\nstatic void irq_mbox_cpu_online(struct irq_data *data)\r\n{\r\nirq_mbox_cpu_onoffline(data, mips_irq_chip + mips_irq_chip_reg_en_w1s + sizeof(u32));\r\n}\r\nstatic void irq_mbox_cpu_offline(struct irq_data *data)\r\n{\r\nirq_mbox_cpu_onoffline(data, mips_irq_chip + mips_irq_chip_reg_en_w1c + sizeof(u32));\r\n}\r\nstatic void __init irq_pci_init(void)\r\n{\r\nint i, stride;\r\nu32 num_bits;\r\nmips_irq_chip = ioremap(0x1e010000, 4096);\r\nnum_bits = __raw_readl(mips_irq_chip + MIPS_IRQ_CHIP_NUM_BITS);\r\nstride = 8 * (1 + ((num_bits - 1) / 64));\r\npr_notice("mips_irq_chip: %u bits, reg stride: %d\n", num_bits, stride);\r\nmips_irq_chip_reg_raw = MIPS_IRQ_CHIP_REGS + 0 * stride;\r\nmips_irq_chip_reg_raw_w1s = MIPS_IRQ_CHIP_REGS + 1 * stride;\r\nmips_irq_chip_reg_raw_w1c = MIPS_IRQ_CHIP_REGS + 2 * stride;\r\nmips_irq_chip_reg_src = MIPS_IRQ_CHIP_REGS + 3 * stride;\r\nmips_irq_chip_reg_en = MIPS_IRQ_CHIP_REGS + 4 * stride;\r\nmips_irq_chip_reg_en_w1s = MIPS_IRQ_CHIP_REGS + 5 * stride;\r\nmips_irq_chip_reg_en_w1c = MIPS_IRQ_CHIP_REGS + 6 * stride;\r\nmips_irq_cpu_stride = stride * 4;\r\nfor (i = 0; i < 4; i++)\r\nirq_set_chip_and_handler(i + MIPS_IRQ_PCIA, &irq_chip_pci, handle_level_irq);\r\nfor (i = 0; i < 2; i++)\r\nirq_set_chip_and_handler(i + MIPS_IRQ_MBOX0, &irq_chip_mbox, handle_percpu_irq);\r\nset_c0_status(STATUSF_IP2);\r\n}\r\nstatic void irq_pci_dispatch(void)\r\n{\r\nunsigned int cpuid = get_ebase_cpunum();\r\nu32 en;\r\nen = __raw_readl(mips_irq_chip + mips_irq_chip_reg_src +\r\n(cpuid * mips_irq_cpu_stride));\r\nif (!en) {\r\nen = __raw_readl(mips_irq_chip + mips_irq_chip_reg_src + (cpuid * mips_irq_cpu_stride) + sizeof(u32));\r\nen = (en >> (2 * cpuid)) & 3;\r\nif (!en)\r\nspurious_interrupt();\r\nelse\r\ndo_IRQ(__ffs(en) + MIPS_IRQ_MBOX0);\r\n} else {\r\ndo_IRQ(__ffs(en));\r\n}\r\n}\r\nvoid __init arch_init_irq(void)\r\n{\r\nirq_init_core();\r\nirq_pci_init();\r\n}\r\nasmlinkage void plat_irq_dispatch(void)\r\n{\r\nunsigned int pending = read_c0_cause() & read_c0_status() & ST0_IM;\r\nint ip;\r\nif (unlikely(!pending)) {\r\nspurious_interrupt();\r\nreturn;\r\n}\r\nip = ffs(pending) - 1 - STATUSB_IP0;\r\nif (ip == 2)\r\nirq_pci_dispatch();\r\nelse\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + ip);\r\n}

static int tc6393xb_nand_enable(struct platform_device *nand)\r\n{\r\nstruct platform_device *dev = to_platform_device(nand->dev.parent);\r\nstruct tc6393xb *tc6393xb = platform_get_drvdata(dev);\r\nunsigned long flags;\r\nspin_lock_irqsave(&tc6393xb->lock, flags);\r\ndev_dbg(&dev->dev, "SMD buffer on\n");\r\ntmio_iowrite8(0xff, tc6393xb->scr + SCR_GPI_BCR(1));\r\nspin_unlock_irqrestore(&tc6393xb->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int tc6393xb_ohci_enable(struct platform_device *dev)\r\n{\r\nstruct tc6393xb *tc6393xb = dev_get_drvdata(dev->dev.parent);\r\nunsigned long flags;\r\nu16 ccr;\r\nu8 fer;\r\nspin_lock_irqsave(&tc6393xb->lock, flags);\r\nccr = tmio_ioread16(tc6393xb->scr + SCR_CCR);\r\nccr |= SCR_CCR_USBCK;\r\ntmio_iowrite16(ccr, tc6393xb->scr + SCR_CCR);\r\nfer = tmio_ioread8(tc6393xb->scr + SCR_FER);\r\nfer |= SCR_FER_USBEN;\r\ntmio_iowrite8(fer, tc6393xb->scr + SCR_FER);\r\nspin_unlock_irqrestore(&tc6393xb->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int tc6393xb_ohci_disable(struct platform_device *dev)\r\n{\r\nstruct tc6393xb *tc6393xb = dev_get_drvdata(dev->dev.parent);\r\nunsigned long flags;\r\nu16 ccr;\r\nu8 fer;\r\nspin_lock_irqsave(&tc6393xb->lock, flags);\r\nfer = tmio_ioread8(tc6393xb->scr + SCR_FER);\r\nfer &= ~SCR_FER_USBEN;\r\ntmio_iowrite8(fer, tc6393xb->scr + SCR_FER);\r\nccr = tmio_ioread16(tc6393xb->scr + SCR_CCR);\r\nccr &= ~SCR_CCR_USBCK;\r\ntmio_iowrite16(ccr, tc6393xb->scr + SCR_CCR);\r\nspin_unlock_irqrestore(&tc6393xb->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int tc6393xb_ohci_suspend(struct platform_device *dev)\r\n{\r\nstruct tc6393xb_platform_data *tcpd = dev_get_platdata(dev->dev.parent);\r\nif (tcpd->resume_restore)\r\nreturn -EBUSY;\r\nreturn tc6393xb_ohci_disable(dev);\r\n}\r\nstatic int tc6393xb_fb_enable(struct platform_device *dev)\r\n{\r\nstruct tc6393xb *tc6393xb = dev_get_drvdata(dev->dev.parent);\r\nunsigned long flags;\r\nu16 ccr;\r\nspin_lock_irqsave(&tc6393xb->lock, flags);\r\nccr = tmio_ioread16(tc6393xb->scr + SCR_CCR);\r\nccr &= ~SCR_CCR_MCLK_MASK;\r\nccr |= SCR_CCR_MCLK_48;\r\ntmio_iowrite16(ccr, tc6393xb->scr + SCR_CCR);\r\nspin_unlock_irqrestore(&tc6393xb->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int tc6393xb_fb_disable(struct platform_device *dev)\r\n{\r\nstruct tc6393xb *tc6393xb = dev_get_drvdata(dev->dev.parent);\r\nunsigned long flags;\r\nu16 ccr;\r\nspin_lock_irqsave(&tc6393xb->lock, flags);\r\nccr = tmio_ioread16(tc6393xb->scr + SCR_CCR);\r\nccr &= ~SCR_CCR_MCLK_MASK;\r\nccr |= SCR_CCR_MCLK_OFF;\r\ntmio_iowrite16(ccr, tc6393xb->scr + SCR_CCR);\r\nspin_unlock_irqrestore(&tc6393xb->lock, flags);\r\nreturn 0;\r\n}\r\nint tc6393xb_lcd_set_power(struct platform_device *fb, bool on)\r\n{\r\nstruct platform_device *dev = to_platform_device(fb->dev.parent);\r\nstruct tc6393xb *tc6393xb = platform_get_drvdata(dev);\r\nu8 fer;\r\nunsigned long flags;\r\nspin_lock_irqsave(&tc6393xb->lock, flags);\r\nfer = ioread8(tc6393xb->scr + SCR_FER);\r\nif (on)\r\nfer |= SCR_FER_SLCDEN;\r\nelse\r\nfer &= ~SCR_FER_SLCDEN;\r\niowrite8(fer, tc6393xb->scr + SCR_FER);\r\nspin_unlock_irqrestore(&tc6393xb->lock, flags);\r\nreturn 0;\r\n}\r\nint tc6393xb_lcd_mode(struct platform_device *fb,\r\nconst struct fb_videomode *mode) {\r\nstruct platform_device *dev = to_platform_device(fb->dev.parent);\r\nstruct tc6393xb *tc6393xb = platform_get_drvdata(dev);\r\nunsigned long flags;\r\nspin_lock_irqsave(&tc6393xb->lock, flags);\r\niowrite16(mode->pixclock, tc6393xb->scr + SCR_PLL1CR + 0);\r\niowrite16(mode->pixclock >> 16, tc6393xb->scr + SCR_PLL1CR + 2);\r\nspin_unlock_irqrestore(&tc6393xb->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int tc6393xb_mmc_enable(struct platform_device *mmc)\r\n{\r\nstruct platform_device *dev = to_platform_device(mmc->dev.parent);\r\nstruct tc6393xb *tc6393xb = platform_get_drvdata(dev);\r\ntmio_core_mmc_enable(tc6393xb->scr + 0x200, 0,\r\ntc6393xb_mmc_resources[0].start & 0xfffe);\r\nreturn 0;\r\n}\r\nstatic int tc6393xb_mmc_resume(struct platform_device *mmc)\r\n{\r\nstruct platform_device *dev = to_platform_device(mmc->dev.parent);\r\nstruct tc6393xb *tc6393xb = platform_get_drvdata(dev);\r\ntmio_core_mmc_resume(tc6393xb->scr + 0x200, 0,\r\ntc6393xb_mmc_resources[0].start & 0xfffe);\r\nreturn 0;\r\n}\r\nstatic void tc6393xb_mmc_pwr(struct platform_device *mmc, int state)\r\n{\r\nstruct platform_device *dev = to_platform_device(mmc->dev.parent);\r\nstruct tc6393xb *tc6393xb = platform_get_drvdata(dev);\r\ntmio_core_mmc_pwr(tc6393xb->scr + 0x200, 0, state);\r\n}\r\nstatic void tc6393xb_mmc_clk_div(struct platform_device *mmc, int state)\r\n{\r\nstruct platform_device *dev = to_platform_device(mmc->dev.parent);\r\nstruct tc6393xb *tc6393xb = platform_get_drvdata(dev);\r\ntmio_core_mmc_clk_div(tc6393xb->scr + 0x200, 0, state);\r\n}\r\nstatic int tc6393xb_gpio_get(struct gpio_chip *chip,\r\nunsigned offset)\r\n{\r\nstruct tc6393xb *tc6393xb = gpiochip_get_data(chip);\r\nreturn !!(tmio_ioread8(tc6393xb->scr + SCR_GPO_DSR(offset / 8))\r\n& TC_GPIO_BIT(offset));\r\n}\r\nstatic void __tc6393xb_gpio_set(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nstruct tc6393xb *tc6393xb = gpiochip_get_data(chip);\r\nu8 dsr;\r\ndsr = tmio_ioread8(tc6393xb->scr + SCR_GPO_DSR(offset / 8));\r\nif (value)\r\ndsr |= TC_GPIO_BIT(offset);\r\nelse\r\ndsr &= ~TC_GPIO_BIT(offset);\r\ntmio_iowrite8(dsr, tc6393xb->scr + SCR_GPO_DSR(offset / 8));\r\n}\r\nstatic void tc6393xb_gpio_set(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nstruct tc6393xb *tc6393xb = gpiochip_get_data(chip);\r\nunsigned long flags;\r\nspin_lock_irqsave(&tc6393xb->lock, flags);\r\n__tc6393xb_gpio_set(chip, offset, value);\r\nspin_unlock_irqrestore(&tc6393xb->lock, flags);\r\n}\r\nstatic int tc6393xb_gpio_direction_input(struct gpio_chip *chip,\r\nunsigned offset)\r\n{\r\nstruct tc6393xb *tc6393xb = gpiochip_get_data(chip);\r\nunsigned long flags;\r\nu8 doecr;\r\nspin_lock_irqsave(&tc6393xb->lock, flags);\r\ndoecr = tmio_ioread8(tc6393xb->scr + SCR_GPO_DOECR(offset / 8));\r\ndoecr &= ~TC_GPIO_BIT(offset);\r\ntmio_iowrite8(doecr, tc6393xb->scr + SCR_GPO_DOECR(offset / 8));\r\nspin_unlock_irqrestore(&tc6393xb->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int tc6393xb_gpio_direction_output(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nstruct tc6393xb *tc6393xb = gpiochip_get_data(chip);\r\nunsigned long flags;\r\nu8 doecr;\r\nspin_lock_irqsave(&tc6393xb->lock, flags);\r\n__tc6393xb_gpio_set(chip, offset, value);\r\ndoecr = tmio_ioread8(tc6393xb->scr + SCR_GPO_DOECR(offset / 8));\r\ndoecr |= TC_GPIO_BIT(offset);\r\ntmio_iowrite8(doecr, tc6393xb->scr + SCR_GPO_DOECR(offset / 8));\r\nspin_unlock_irqrestore(&tc6393xb->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int tc6393xb_register_gpio(struct tc6393xb *tc6393xb, int gpio_base)\r\n{\r\ntc6393xb->gpio.label = "tc6393xb";\r\ntc6393xb->gpio.base = gpio_base;\r\ntc6393xb->gpio.ngpio = 16;\r\ntc6393xb->gpio.set = tc6393xb_gpio_set;\r\ntc6393xb->gpio.get = tc6393xb_gpio_get;\r\ntc6393xb->gpio.direction_input = tc6393xb_gpio_direction_input;\r\ntc6393xb->gpio.direction_output = tc6393xb_gpio_direction_output;\r\nreturn gpiochip_add_data(&tc6393xb->gpio, tc6393xb);\r\n}\r\nstatic void tc6393xb_irq(struct irq_desc *desc)\r\n{\r\nstruct tc6393xb *tc6393xb = irq_desc_get_handler_data(desc);\r\nunsigned int isr;\r\nunsigned int i, irq_base;\r\nirq_base = tc6393xb->irq_base;\r\nwhile ((isr = tmio_ioread8(tc6393xb->scr + SCR_ISR) &\r\n~tmio_ioread8(tc6393xb->scr + SCR_IMR)))\r\nfor (i = 0; i < TC6393XB_NR_IRQS; i++) {\r\nif (isr & (1 << i))\r\ngeneric_handle_irq(irq_base + i);\r\n}\r\n}\r\nstatic void tc6393xb_irq_ack(struct irq_data *data)\r\n{\r\n}\r\nstatic void tc6393xb_irq_mask(struct irq_data *data)\r\n{\r\nstruct tc6393xb *tc6393xb = irq_data_get_irq_chip_data(data);\r\nunsigned long flags;\r\nu8 imr;\r\nspin_lock_irqsave(&tc6393xb->lock, flags);\r\nimr = tmio_ioread8(tc6393xb->scr + SCR_IMR);\r\nimr |= 1 << (data->irq - tc6393xb->irq_base);\r\ntmio_iowrite8(imr, tc6393xb->scr + SCR_IMR);\r\nspin_unlock_irqrestore(&tc6393xb->lock, flags);\r\n}\r\nstatic void tc6393xb_irq_unmask(struct irq_data *data)\r\n{\r\nstruct tc6393xb *tc6393xb = irq_data_get_irq_chip_data(data);\r\nunsigned long flags;\r\nu8 imr;\r\nspin_lock_irqsave(&tc6393xb->lock, flags);\r\nimr = tmio_ioread8(tc6393xb->scr + SCR_IMR);\r\nimr &= ~(1 << (data->irq - tc6393xb->irq_base));\r\ntmio_iowrite8(imr, tc6393xb->scr + SCR_IMR);\r\nspin_unlock_irqrestore(&tc6393xb->lock, flags);\r\n}\r\nstatic void tc6393xb_attach_irq(struct platform_device *dev)\r\n{\r\nstruct tc6393xb *tc6393xb = platform_get_drvdata(dev);\r\nunsigned int irq, irq_base;\r\nirq_base = tc6393xb->irq_base;\r\nfor (irq = irq_base; irq < irq_base + TC6393XB_NR_IRQS; irq++) {\r\nirq_set_chip_and_handler(irq, &tc6393xb_chip, handle_edge_irq);\r\nirq_set_chip_data(irq, tc6393xb);\r\nirq_clear_status_flags(irq, IRQ_NOREQUEST | IRQ_NOPROBE);\r\n}\r\nirq_set_irq_type(tc6393xb->irq, IRQ_TYPE_EDGE_FALLING);\r\nirq_set_chained_handler_and_data(tc6393xb->irq, tc6393xb_irq,\r\ntc6393xb);\r\n}\r\nstatic void tc6393xb_detach_irq(struct platform_device *dev)\r\n{\r\nstruct tc6393xb *tc6393xb = platform_get_drvdata(dev);\r\nunsigned int irq, irq_base;\r\nirq_set_chained_handler_and_data(tc6393xb->irq, NULL, NULL);\r\nirq_base = tc6393xb->irq_base;\r\nfor (irq = irq_base; irq < irq_base + TC6393XB_NR_IRQS; irq++) {\r\nirq_set_status_flags(irq, IRQ_NOREQUEST | IRQ_NOPROBE);\r\nirq_set_chip(irq, NULL);\r\nirq_set_chip_data(irq, NULL);\r\n}\r\n}\r\nstatic int tc6393xb_probe(struct platform_device *dev)\r\n{\r\nstruct tc6393xb_platform_data *tcpd = dev_get_platdata(&dev->dev);\r\nstruct tc6393xb *tc6393xb;\r\nstruct resource *iomem, *rscr;\r\nint ret;\r\niomem = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!iomem)\r\nreturn -EINVAL;\r\ntc6393xb = kzalloc(sizeof *tc6393xb, GFP_KERNEL);\r\nif (!tc6393xb) {\r\nret = -ENOMEM;\r\ngoto err_kzalloc;\r\n}\r\nspin_lock_init(&tc6393xb->lock);\r\nplatform_set_drvdata(dev, tc6393xb);\r\nret = platform_get_irq(dev, 0);\r\nif (ret >= 0)\r\ntc6393xb->irq = ret;\r\nelse\r\ngoto err_noirq;\r\ntc6393xb->iomem = iomem;\r\ntc6393xb->irq_base = tcpd->irq_base;\r\ntc6393xb->clk = clk_get(&dev->dev, "CLK_CK3P6MI");\r\nif (IS_ERR(tc6393xb->clk)) {\r\nret = PTR_ERR(tc6393xb->clk);\r\ngoto err_clk_get;\r\n}\r\nrscr = &tc6393xb->rscr;\r\nrscr->name = "tc6393xb-core";\r\nrscr->start = iomem->start;\r\nrscr->end = iomem->start + 0xff;\r\nrscr->flags = IORESOURCE_MEM;\r\nret = request_resource(iomem, rscr);\r\nif (ret)\r\ngoto err_request_scr;\r\ntc6393xb->scr = ioremap(rscr->start, resource_size(rscr));\r\nif (!tc6393xb->scr) {\r\nret = -ENOMEM;\r\ngoto err_ioremap;\r\n}\r\nret = clk_prepare_enable(tc6393xb->clk);\r\nif (ret)\r\ngoto err_clk_enable;\r\nret = tcpd->enable(dev);\r\nif (ret)\r\ngoto err_enable;\r\niowrite8(0, tc6393xb->scr + SCR_FER);\r\niowrite16(tcpd->scr_pll2cr, tc6393xb->scr + SCR_PLL2CR);\r\niowrite16(SCR_CCR_UNK1 | SCR_CCR_HCLK_48,\r\ntc6393xb->scr + SCR_CCR);\r\niowrite16(SCR_MCR_RDY_OPENDRAIN | SCR_MCR_RDY_UNK | SCR_MCR_RDY_EN |\r\nSCR_MCR_INT_OPENDRAIN | SCR_MCR_INT_UNK | SCR_MCR_INT_EN |\r\nBIT(15), tc6393xb->scr + SCR_MCR);\r\niowrite16(tcpd->scr_gper, tc6393xb->scr + SCR_GPER);\r\niowrite8(0, tc6393xb->scr + SCR_IRR);\r\niowrite8(0xbf, tc6393xb->scr + SCR_IMR);\r\nprintk(KERN_INFO "Toshiba tc6393xb revision %d at 0x%08lx, irq %d\n",\r\ntmio_ioread8(tc6393xb->scr + SCR_REVID),\r\n(unsigned long) iomem->start, tc6393xb->irq);\r\ntc6393xb->gpio.base = -1;\r\nif (tcpd->gpio_base >= 0) {\r\nret = tc6393xb_register_gpio(tc6393xb, tcpd->gpio_base);\r\nif (ret)\r\ngoto err_gpio_add;\r\n}\r\ntc6393xb_attach_irq(dev);\r\nif (tcpd->setup) {\r\nret = tcpd->setup(dev);\r\nif (ret)\r\ngoto err_setup;\r\n}\r\ntc6393xb_cells[TC6393XB_CELL_NAND].platform_data = tcpd->nand_data;\r\ntc6393xb_cells[TC6393XB_CELL_NAND].pdata_size =\r\nsizeof(*tcpd->nand_data);\r\ntc6393xb_cells[TC6393XB_CELL_FB].platform_data = tcpd->fb_data;\r\ntc6393xb_cells[TC6393XB_CELL_FB].pdata_size = sizeof(*tcpd->fb_data);\r\nret = mfd_add_devices(&dev->dev, dev->id,\r\ntc6393xb_cells, ARRAY_SIZE(tc6393xb_cells),\r\niomem, tcpd->irq_base, NULL);\r\nif (!ret)\r\nreturn 0;\r\nif (tcpd->teardown)\r\ntcpd->teardown(dev);\r\nerr_setup:\r\ntc6393xb_detach_irq(dev);\r\nerr_gpio_add:\r\nif (tc6393xb->gpio.base != -1)\r\ngpiochip_remove(&tc6393xb->gpio);\r\ntcpd->disable(dev);\r\nerr_enable:\r\nclk_disable_unprepare(tc6393xb->clk);\r\nerr_clk_enable:\r\niounmap(tc6393xb->scr);\r\nerr_ioremap:\r\nrelease_resource(&tc6393xb->rscr);\r\nerr_request_scr:\r\nclk_put(tc6393xb->clk);\r\nerr_noirq:\r\nerr_clk_get:\r\nkfree(tc6393xb);\r\nerr_kzalloc:\r\nreturn ret;\r\n}\r\nstatic int tc6393xb_remove(struct platform_device *dev)\r\n{\r\nstruct tc6393xb_platform_data *tcpd = dev_get_platdata(&dev->dev);\r\nstruct tc6393xb *tc6393xb = platform_get_drvdata(dev);\r\nint ret;\r\nmfd_remove_devices(&dev->dev);\r\nif (tcpd->teardown)\r\ntcpd->teardown(dev);\r\ntc6393xb_detach_irq(dev);\r\nif (tc6393xb->gpio.base != -1)\r\ngpiochip_remove(&tc6393xb->gpio);\r\nret = tcpd->disable(dev);\r\nclk_disable_unprepare(tc6393xb->clk);\r\niounmap(tc6393xb->scr);\r\nrelease_resource(&tc6393xb->rscr);\r\nclk_put(tc6393xb->clk);\r\nkfree(tc6393xb);\r\nreturn ret;\r\n}\r\nstatic int tc6393xb_suspend(struct platform_device *dev, pm_message_t state)\r\n{\r\nstruct tc6393xb_platform_data *tcpd = dev_get_platdata(&dev->dev);\r\nstruct tc6393xb *tc6393xb = platform_get_drvdata(dev);\r\nint i, ret;\r\ntc6393xb->suspend_state.ccr = ioread16(tc6393xb->scr + SCR_CCR);\r\ntc6393xb->suspend_state.fer = ioread8(tc6393xb->scr + SCR_FER);\r\nfor (i = 0; i < 3; i++) {\r\ntc6393xb->suspend_state.gpo_dsr[i] =\r\nioread8(tc6393xb->scr + SCR_GPO_DSR(i));\r\ntc6393xb->suspend_state.gpo_doecr[i] =\r\nioread8(tc6393xb->scr + SCR_GPO_DOECR(i));\r\ntc6393xb->suspend_state.gpi_bcr[i] =\r\nioread8(tc6393xb->scr + SCR_GPI_BCR(i));\r\n}\r\nret = tcpd->suspend(dev);\r\nclk_disable_unprepare(tc6393xb->clk);\r\nreturn ret;\r\n}\r\nstatic int tc6393xb_resume(struct platform_device *dev)\r\n{\r\nstruct tc6393xb_platform_data *tcpd = dev_get_platdata(&dev->dev);\r\nstruct tc6393xb *tc6393xb = platform_get_drvdata(dev);\r\nint ret;\r\nint i;\r\nclk_prepare_enable(tc6393xb->clk);\r\nret = tcpd->resume(dev);\r\nif (ret)\r\nreturn ret;\r\nif (!tcpd->resume_restore)\r\nreturn 0;\r\niowrite8(tc6393xb->suspend_state.fer, tc6393xb->scr + SCR_FER);\r\niowrite16(tcpd->scr_pll2cr, tc6393xb->scr + SCR_PLL2CR);\r\niowrite16(tc6393xb->suspend_state.ccr, tc6393xb->scr + SCR_CCR);\r\niowrite16(SCR_MCR_RDY_OPENDRAIN | SCR_MCR_RDY_UNK | SCR_MCR_RDY_EN |\r\nSCR_MCR_INT_OPENDRAIN | SCR_MCR_INT_UNK | SCR_MCR_INT_EN |\r\nBIT(15), tc6393xb->scr + SCR_MCR);\r\niowrite16(tcpd->scr_gper, tc6393xb->scr + SCR_GPER);\r\niowrite8(0, tc6393xb->scr + SCR_IRR);\r\niowrite8(0xbf, tc6393xb->scr + SCR_IMR);\r\nfor (i = 0; i < 3; i++) {\r\niowrite8(tc6393xb->suspend_state.gpo_dsr[i],\r\ntc6393xb->scr + SCR_GPO_DSR(i));\r\niowrite8(tc6393xb->suspend_state.gpo_doecr[i],\r\ntc6393xb->scr + SCR_GPO_DOECR(i));\r\niowrite8(tc6393xb->suspend_state.gpi_bcr[i],\r\ntc6393xb->scr + SCR_GPI_BCR(i));\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init tc6393xb_init(void)\r\n{\r\nreturn platform_driver_register(&tc6393xb_driver);\r\n}\r\nstatic void __exit tc6393xb_exit(void)\r\n{\r\nplatform_driver_unregister(&tc6393xb_driver);\r\n}

int __hash_page_huge(unsigned long ea, unsigned long access, unsigned long vsid,\r\npte_t *ptep, unsigned long trap, unsigned long flags,\r\nint ssize, unsigned int shift, unsigned int mmu_psize)\r\n{\r\nunsigned long vpn;\r\nunsigned long old_pte, new_pte;\r\nunsigned long rflags, pa, sz;\r\nlong slot;\r\nBUG_ON(shift != mmu_psize_defs[mmu_psize].shift);\r\nvpn = hpt_vpn(ea, vsid, ssize);\r\ndo {\r\nold_pte = pte_val(*ptep);\r\nif (unlikely(old_pte & H_PAGE_BUSY))\r\nreturn 0;\r\nif (unlikely(!check_pte_access(access, old_pte)))\r\nreturn 1;\r\nnew_pte = old_pte | H_PAGE_BUSY | _PAGE_ACCESSED;\r\nif (access & _PAGE_WRITE)\r\nnew_pte |= _PAGE_DIRTY;\r\n} while(!pte_xchg(ptep, __pte(old_pte), __pte(new_pte)));\r\nrflags = htab_convert_pte_flags(new_pte);\r\nsz = ((1UL) << shift);\r\nif (!cpu_has_feature(CPU_FTR_COHERENT_ICACHE))\r\nrflags = hash_page_do_lazy_icache(rflags, __pte(old_pte), trap);\r\nif (unlikely(old_pte & H_PAGE_HASHPTE)) {\r\nunsigned long hash, slot;\r\nhash = hpt_hash(vpn, shift, ssize);\r\nif (old_pte & H_PAGE_F_SECOND)\r\nhash = ~hash;\r\nslot = (hash & htab_hash_mask) * HPTES_PER_GROUP;\r\nslot += (old_pte & H_PAGE_F_GIX) >> H_PAGE_F_GIX_SHIFT;\r\nif (mmu_hash_ops.hpte_updatepp(slot, rflags, vpn, mmu_psize,\r\nmmu_psize, ssize, flags) == -1)\r\nold_pte &= ~_PAGE_HPTEFLAGS;\r\n}\r\nif (likely(!(old_pte & H_PAGE_HASHPTE))) {\r\nunsigned long hash = hpt_hash(vpn, shift, ssize);\r\npa = pte_pfn(__pte(old_pte)) << PAGE_SHIFT;\r\nnew_pte = (new_pte & ~_PAGE_HPTEFLAGS) | H_PAGE_HASHPTE;\r\nslot = hpte_insert_repeating(hash, vpn, pa, rflags, 0,\r\nmmu_psize, ssize);\r\nif (unlikely(slot == -2)) {\r\n*ptep = __pte(old_pte);\r\nhash_failure_debug(ea, access, vsid, trap, ssize,\r\nmmu_psize, mmu_psize, old_pte);\r\nreturn -1;\r\n}\r\nnew_pte |= (slot << H_PAGE_F_GIX_SHIFT) &\r\n(H_PAGE_F_SECOND | H_PAGE_F_GIX);\r\n}\r\n*ptep = __pte(new_pte & ~H_PAGE_BUSY);\r\nreturn 0;\r\n}\r\nint hugepd_ok(hugepd_t hpd)\r\n{\r\nbool is_hugepd;\r\nis_hugepd = (((hpd.pd & 0x3) == 0x0) && ((hpd.pd & HUGEPD_SHIFT_MASK) != 0));\r\nWARN(is_hugepd, "Found wrong page directory format\n");\r\nreturn 0;\r\n}

static struct pci_bus *find_pci_root_bus(struct pci_bus *bus)\r\n{\r\nwhile (bus->parent)\r\nbus = bus->parent;\r\nreturn bus;\r\n}\r\nstruct pci_host_bridge *pci_find_host_bridge(struct pci_bus *bus)\r\n{\r\nstruct pci_bus *root_bus = find_pci_root_bus(bus);\r\nreturn to_pci_host_bridge(root_bus->bridge);\r\n}\r\nstruct device *pci_get_host_bridge_device(struct pci_dev *dev)\r\n{\r\nstruct pci_bus *root_bus = find_pci_root_bus(dev->bus);\r\nstruct device *bridge = root_bus->bridge;\r\nkobject_get(&bridge->kobj);\r\nreturn bridge;\r\n}\r\nvoid pci_put_host_bridge_device(struct device *dev)\r\n{\r\nkobject_put(&dev->kobj);\r\n}\r\nvoid pci_set_host_bridge_release(struct pci_host_bridge *bridge,\r\nvoid (*release_fn)(struct pci_host_bridge *),\r\nvoid *release_data)\r\n{\r\nbridge->release_fn = release_fn;\r\nbridge->release_data = release_data;\r\n}\r\nvoid pcibios_resource_to_bus(struct pci_bus *bus, struct pci_bus_region *region,\r\nstruct resource *res)\r\n{\r\nstruct pci_host_bridge *bridge = pci_find_host_bridge(bus);\r\nstruct resource_entry *window;\r\nresource_size_t offset = 0;\r\nresource_list_for_each_entry(window, &bridge->windows) {\r\nif (resource_contains(window->res, res)) {\r\noffset = window->offset;\r\nbreak;\r\n}\r\n}\r\nregion->start = res->start - offset;\r\nregion->end = res->end - offset;\r\n}\r\nstatic bool region_contains(struct pci_bus_region *region1,\r\nstruct pci_bus_region *region2)\r\n{\r\nreturn region1->start <= region2->start && region1->end >= region2->end;\r\n}\r\nvoid pcibios_bus_to_resource(struct pci_bus *bus, struct resource *res,\r\nstruct pci_bus_region *region)\r\n{\r\nstruct pci_host_bridge *bridge = pci_find_host_bridge(bus);\r\nstruct resource_entry *window;\r\nresource_size_t offset = 0;\r\nresource_list_for_each_entry(window, &bridge->windows) {\r\nstruct pci_bus_region bus_region;\r\nif (resource_type(res) != resource_type(window->res))\r\ncontinue;\r\nbus_region.start = window->res->start - window->offset;\r\nbus_region.end = window->res->end - window->offset;\r\nif (region_contains(&bus_region, region)) {\r\noffset = window->offset;\r\nbreak;\r\n}\r\n}\r\nres->start = region->start + offset;\r\nres->end = region->end + offset;\r\n}

static int pxa2xx_pctrl_get_groups_count(struct pinctrl_dev *pctldev)\r\n{\r\nstruct pxa_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\r\nreturn pctl->ngroups;\r\n}\r\nstatic const char *pxa2xx_pctrl_get_group_name(struct pinctrl_dev *pctldev,\r\nunsigned tgroup)\r\n{\r\nstruct pxa_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\r\nstruct pxa_pinctrl_group *group = pctl->groups + tgroup;\r\nreturn group->name;\r\n}\r\nstatic int pxa2xx_pctrl_get_group_pins(struct pinctrl_dev *pctldev,\r\nunsigned tgroup,\r\nconst unsigned **pins,\r\nunsigned *num_pins)\r\n{\r\nstruct pxa_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\r\nstruct pxa_pinctrl_group *group = pctl->groups + tgroup;\r\n*pins = (unsigned *)&group->pin;\r\n*num_pins = 1;\r\nreturn 0;\r\n}\r\nstatic struct pxa_desc_function *\r\npxa_desc_by_func_group(struct pxa_pinctrl *pctl, const char *pin_name,\r\nconst char *func_name)\r\n{\r\nint i;\r\nstruct pxa_desc_function *df;\r\nfor (i = 0; i < pctl->npins; i++) {\r\nconst struct pxa_desc_pin *pin = pctl->ppins + i;\r\nif (!strcmp(pin->pin.name, pin_name))\r\nfor (df = pin->functions; df->name; df++)\r\nif (!strcmp(df->name, func_name))\r\nreturn df;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int pxa2xx_pmx_gpio_set_direction(struct pinctrl_dev *pctldev,\r\nstruct pinctrl_gpio_range *range,\r\nunsigned pin,\r\nbool input)\r\n{\r\nstruct pxa_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\r\nunsigned long flags;\r\nuint32_t val;\r\nvoid __iomem *gpdr;\r\ngpdr = pctl->base_gpdr[pin / 32];\r\ndev_dbg(pctl->dev, "set_direction(pin=%d): dir=%d\n",\r\npin, !input);\r\nspin_lock_irqsave(&pctl->lock, flags);\r\nval = readl_relaxed(gpdr);\r\nval = (val & ~BIT(pin % 32)) | (input ? 0 : BIT(pin % 32));\r\nwritel_relaxed(val, gpdr);\r\nspin_unlock_irqrestore(&pctl->lock, flags);\r\nreturn 0;\r\n}\r\nstatic const char *pxa2xx_pmx_get_func_name(struct pinctrl_dev *pctldev,\r\nunsigned function)\r\n{\r\nstruct pxa_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\r\nstruct pxa_pinctrl_function *pf = pctl->functions + function;\r\nreturn pf->name;\r\n}\r\nstatic int pxa2xx_get_functions_count(struct pinctrl_dev *pctldev)\r\n{\r\nstruct pxa_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\r\nreturn pctl->nfuncs;\r\n}\r\nstatic int pxa2xx_pmx_get_func_groups(struct pinctrl_dev *pctldev,\r\nunsigned function,\r\nconst char * const **groups,\r\nunsigned * const num_groups)\r\n{\r\nstruct pxa_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\r\nstruct pxa_pinctrl_function *pf = pctl->functions + function;\r\n*groups = pf->groups;\r\n*num_groups = pf->ngroups;\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_pmx_set_mux(struct pinctrl_dev *pctldev, unsigned function,\r\nunsigned tgroup)\r\n{\r\nstruct pxa_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\r\nstruct pxa_pinctrl_group *group = pctl->groups + tgroup;\r\nstruct pxa_desc_function *df;\r\nint pin, shift;\r\nunsigned long flags;\r\nvoid __iomem *gafr, *gpdr;\r\nu32 val;\r\ndf = pxa_desc_by_func_group(pctl, group->name,\r\n(pctl->functions + function)->name);\r\nif (!df)\r\nreturn -EINVAL;\r\npin = group->pin;\r\ngafr = pctl->base_gafr[pin / 16];\r\ngpdr = pctl->base_gpdr[pin / 32];\r\nshift = (pin % 16) << 1;\r\ndev_dbg(pctl->dev, "set_mux(pin=%d): af=%d dir=%d\n",\r\npin, df->muxval >> 1, df->muxval & 0x1);\r\nspin_lock_irqsave(&pctl->lock, flags);\r\nval = readl_relaxed(gafr);\r\nval = (val & ~(0x3 << shift)) | ((df->muxval >> 1) << shift);\r\nwritel_relaxed(val, gafr);\r\nval = readl_relaxed(gpdr);\r\nval = (val & ~BIT(pin % 32)) | ((df->muxval & 1) ? BIT(pin % 32) : 0);\r\nwritel_relaxed(val, gpdr);\r\nspin_unlock_irqrestore(&pctl->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_pconf_group_get(struct pinctrl_dev *pctldev,\r\nunsigned group,\r\nunsigned long *config)\r\n{\r\nstruct pxa_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\r\nstruct pxa_pinctrl_group *g = pctl->groups + group;\r\nunsigned long flags;\r\nunsigned pin = g->pin;\r\nvoid __iomem *pgsr = pctl->base_pgsr[pin / 32];\r\nu32 val;\r\nspin_lock_irqsave(&pctl->lock, flags);\r\nval = readl_relaxed(pgsr) & BIT(pin % 32);\r\n*config = val ? PIN_CONFIG_LOW_POWER_MODE : 0;\r\nspin_unlock_irqrestore(&pctl->lock, flags);\r\ndev_dbg(pctl->dev, "get sleep gpio state(pin=%d) %d\n",\r\npin, !!val);\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_pconf_group_set(struct pinctrl_dev *pctldev,\r\nunsigned group,\r\nunsigned long *configs,\r\nunsigned num_configs)\r\n{\r\nstruct pxa_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\r\nstruct pxa_pinctrl_group *g = pctl->groups + group;\r\nunsigned long flags;\r\nunsigned pin = g->pin;\r\nvoid __iomem *pgsr = pctl->base_pgsr[pin / 32];\r\nint i, is_set = 0;\r\nu32 val;\r\nfor (i = 0; i < num_configs; i++) {\r\nswitch (pinconf_to_config_param(configs[i])) {\r\ncase PIN_CONFIG_LOW_POWER_MODE:\r\nis_set = pinconf_to_config_argument(configs[i]);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\ndev_dbg(pctl->dev, "set sleep gpio state(pin=%d) %d\n",\r\npin, is_set);\r\nspin_lock_irqsave(&pctl->lock, flags);\r\nval = readl_relaxed(pgsr);\r\nval = (val & ~BIT(pin % 32)) | (is_set ? BIT(pin % 32) : 0);\r\nwritel_relaxed(val, pgsr);\r\nspin_unlock_irqrestore(&pctl->lock, flags);\r\nreturn 0;\r\n}\r\nstatic const struct pxa_pinctrl_function *\r\npxa2xx_find_function(struct pxa_pinctrl *pctl, const char *fname,\r\nconst struct pxa_pinctrl_function *functions)\r\n{\r\nconst struct pxa_pinctrl_function *func;\r\nfor (func = functions; func->name; func++)\r\nif (!strcmp(fname, func->name))\r\nreturn func;\r\nreturn NULL;\r\n}\r\nstatic int pxa2xx_build_functions(struct pxa_pinctrl *pctl)\r\n{\r\nint i;\r\nstruct pxa_pinctrl_function *functions;\r\nstruct pxa_desc_function *df;\r\nfunctions = devm_kcalloc(pctl->dev, pctl->npins * 6,\r\nsizeof(*functions), GFP_KERNEL);\r\nif (!functions)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < pctl->npins; i++)\r\nfor (df = pctl->ppins[i].functions; df->name; df++)\r\nif (!pxa2xx_find_function(pctl, df->name, functions))\r\n(functions + pctl->nfuncs++)->name = df->name;\r\npctl->functions = devm_kmemdup(pctl->dev, functions,\r\npctl->nfuncs * sizeof(*functions),\r\nGFP_KERNEL);\r\nif (!pctl->functions)\r\nreturn -ENOMEM;\r\ndevm_kfree(pctl->dev, functions);\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_build_groups(struct pxa_pinctrl *pctl)\r\n{\r\nint i, j, ngroups;\r\nstruct pxa_pinctrl_function *func;\r\nstruct pxa_desc_function *df;\r\nchar **gtmp;\r\ngtmp = devm_kmalloc_array(pctl->dev, pctl->npins, sizeof(*gtmp),\r\nGFP_KERNEL);\r\nif (!gtmp)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < pctl->nfuncs; i++) {\r\nngroups = 0;\r\nfor (j = 0; j < pctl->npins; j++)\r\nfor (df = pctl->ppins[j].functions; df->name;\r\ndf++)\r\nif (!strcmp(pctl->functions[i].name,\r\ndf->name))\r\ngtmp[ngroups++] = (char *)\r\npctl->ppins[j].pin.name;\r\nfunc = pctl->functions + i;\r\nfunc->ngroups = ngroups;\r\nfunc->groups =\r\ndevm_kmalloc_array(pctl->dev, ngroups,\r\nsizeof(char *), GFP_KERNEL);\r\nif (!func->groups)\r\nreturn -ENOMEM;\r\nmemcpy(func->groups, gtmp, ngroups * sizeof(*gtmp));\r\n}\r\ndevm_kfree(pctl->dev, gtmp);\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_build_state(struct pxa_pinctrl *pctl,\r\nconst struct pxa_desc_pin *ppins, int npins)\r\n{\r\nstruct pxa_pinctrl_group *group;\r\nstruct pinctrl_pin_desc *pins;\r\nint ret, i;\r\npctl->npins = npins;\r\npctl->ppins = ppins;\r\npctl->ngroups = npins;\r\npctl->desc.npins = npins;\r\npins = devm_kcalloc(pctl->dev, npins, sizeof(*pins), GFP_KERNEL);\r\nif (!pins)\r\nreturn -ENOMEM;\r\npctl->desc.pins = pins;\r\nfor (i = 0; i < npins; i++)\r\npins[i] = ppins[i].pin;\r\npctl->groups = devm_kmalloc_array(pctl->dev, pctl->ngroups,\r\nsizeof(*pctl->groups), GFP_KERNEL);\r\nif (!pctl->groups)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < npins; i++) {\r\ngroup = pctl->groups + i;\r\ngroup->name = ppins[i].pin.name;\r\ngroup->pin = ppins[i].pin.number;\r\n}\r\nret = pxa2xx_build_functions(pctl);\r\nif (ret)\r\nreturn ret;\r\nret = pxa2xx_build_groups(pctl);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint pxa2xx_pinctrl_init(struct platform_device *pdev,\r\nconst struct pxa_desc_pin *ppins, int npins,\r\nvoid __iomem *base_gafr[], void __iomem *base_gpdr[],\r\nvoid __iomem *base_pgsr[])\r\n{\r\nstruct pxa_pinctrl *pctl;\r\nint ret, i, maxpin = 0;\r\nfor (i = 0; i < npins; i++)\r\nmaxpin = max_t(int, ppins[i].pin.number, maxpin);\r\npctl = devm_kzalloc(&pdev->dev, sizeof(*pctl), GFP_KERNEL);\r\nif (!pctl)\r\nreturn -ENOMEM;\r\npctl->base_gafr = devm_kcalloc(&pdev->dev, roundup(maxpin, 16),\r\nsizeof(*pctl->base_gafr), GFP_KERNEL);\r\npctl->base_gpdr = devm_kcalloc(&pdev->dev, roundup(maxpin, 32),\r\nsizeof(*pctl->base_gpdr), GFP_KERNEL);\r\npctl->base_pgsr = devm_kcalloc(&pdev->dev, roundup(maxpin, 32),\r\nsizeof(*pctl->base_pgsr), GFP_KERNEL);\r\nif (!pctl->base_gafr || !pctl->base_gpdr || !pctl->base_pgsr)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, pctl);\r\nspin_lock_init(&pctl->lock);\r\npctl->dev = &pdev->dev;\r\npctl->desc = pxa2xx_pinctrl_desc;\r\npctl->desc.name = dev_name(&pdev->dev);\r\npctl->desc.owner = THIS_MODULE;\r\nfor (i = 0; i < roundup(maxpin, 16); i += 16)\r\npctl->base_gafr[i / 16] = base_gafr[i / 16];\r\nfor (i = 0; i < roundup(maxpin, 32); i += 32) {\r\npctl->base_gpdr[i / 32] = base_gpdr[i / 32];\r\npctl->base_pgsr[i / 32] = base_pgsr[i / 32];\r\n}\r\nret = pxa2xx_build_state(pctl, ppins, npins);\r\nif (ret)\r\nreturn ret;\r\npctl->pctl_dev = devm_pinctrl_register(&pdev->dev, &pctl->desc, pctl);\r\nif (IS_ERR(pctl->pctl_dev)) {\r\ndev_err(&pdev->dev, "couldn't register pinctrl driver\n");\r\nreturn PTR_ERR(pctl->pctl_dev);\r\n}\r\ndev_info(&pdev->dev, "initialized pxa2xx pinctrl driver\n");\r\nreturn 0;\r\n}\r\nint pxa2xx_pinctrl_exit(struct platform_device *pdev)\r\n{\r\nstruct pxa_pinctrl *pctl = platform_get_drvdata(pdev);\r\npinctrl_unregister(pctl->pctl_dev);\r\nreturn 0;\r\n}

static void __init tegra30_pll_init(void)\r\n{\r\nstruct clk *clk;\r\nclk = tegra_clk_register_pll("pll_c", "pll_ref", clk_base, pmc_base, 0,\r\n&pll_c_params, NULL);\r\nclks[TEGRA30_CLK_PLL_C] = clk;\r\nclk = tegra_clk_register_divider("pll_c_out1_div", "pll_c",\r\nclk_base + PLLC_OUT, 0, TEGRA_DIVIDER_ROUND_UP,\r\n8, 8, 1, NULL);\r\nclk = tegra_clk_register_pll_out("pll_c_out1", "pll_c_out1_div",\r\nclk_base + PLLC_OUT, 1, 0, CLK_SET_RATE_PARENT,\r\n0, NULL);\r\nclks[TEGRA30_CLK_PLL_C_OUT1] = clk;\r\nclk = tegra_clk_register_pll("pll_m", "pll_ref", clk_base, pmc_base,\r\nCLK_IGNORE_UNUSED | CLK_SET_RATE_GATE,\r\n&pll_m_params, NULL);\r\nclks[TEGRA30_CLK_PLL_M] = clk;\r\nclk = tegra_clk_register_divider("pll_m_out1_div", "pll_m",\r\nclk_base + PLLM_OUT, 0, TEGRA_DIVIDER_ROUND_UP,\r\n8, 8, 1, NULL);\r\nclk = tegra_clk_register_pll_out("pll_m_out1", "pll_m_out1_div",\r\nclk_base + PLLM_OUT, 1, 0, CLK_IGNORE_UNUSED |\r\nCLK_SET_RATE_PARENT, 0, NULL);\r\nclks[TEGRA30_CLK_PLL_M_OUT1] = clk;\r\nclk = tegra_clk_register_pll("pll_x", "pll_ref", clk_base, pmc_base, 0,\r\n&pll_x_params, NULL);\r\nclks[TEGRA30_CLK_PLL_X] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_x_out0", "pll_x",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclks[TEGRA30_CLK_PLL_X_OUT0] = clk;\r\nclk = tegra_clk_register_pllu("pll_u", "pll_ref", clk_base, 0,\r\n&pll_u_params, NULL);\r\nclks[TEGRA30_CLK_PLL_U] = clk;\r\nclk = tegra_clk_register_pll("pll_d", "pll_ref", clk_base, pmc_base, 0,\r\n&pll_d_params, &pll_d_lock);\r\nclks[TEGRA30_CLK_PLL_D] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_d_out0", "pll_d",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclks[TEGRA30_CLK_PLL_D_OUT0] = clk;\r\nclk = tegra_clk_register_pll("pll_d2", "pll_ref", clk_base, pmc_base, 0,\r\n&pll_d2_params, NULL);\r\nclks[TEGRA30_CLK_PLL_D2] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_d2_out0", "pll_d2",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclks[TEGRA30_CLK_PLL_D2_OUT0] = clk;\r\nclk = clk_register_mux(NULL, "pll_e_mux", pll_e_parents,\r\nARRAY_SIZE(pll_e_parents),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + PLLE_AUX, 2, 1, 0, NULL);\r\nclk = tegra_clk_register_plle("pll_e", "pll_e_mux", clk_base, pmc_base,\r\nCLK_GET_RATE_NOCACHE, &pll_e_params, NULL);\r\nclks[TEGRA30_CLK_PLL_E] = clk;\r\n}\r\nstatic void __init tegra30_super_clk_init(void)\r\n{\r\nstruct clk *clk;\r\nclk = tegra_clk_register_divider("pll_p_cclkg", "pll_p",\r\nclk_base + SUPER_CCLKG_DIVIDER, 0,\r\nTEGRA_DIVIDER_INT, 16, 8, 1, NULL);\r\nclk_register_clkdev(clk, "pll_p_cclkg", NULL);\r\nclk = tegra_clk_register_divider("pll_p_out3_cclkg", "pll_p_out3",\r\nclk_base + SUPER_CCLKG_DIVIDER, 0,\r\nTEGRA_DIVIDER_INT, 16, 8, 1, NULL);\r\nclk_register_clkdev(clk, "pll_p_out3_cclkg", NULL);\r\nclk = tegra_clk_register_divider("pll_p_out4_cclkg", "pll_p_out4",\r\nclk_base + SUPER_CCLKG_DIVIDER, 0,\r\nTEGRA_DIVIDER_INT, 16, 8, 1, NULL);\r\nclk_register_clkdev(clk, "pll_p_out4_cclkg", NULL);\r\nclk = tegra_clk_register_super_mux("cclk_g", cclk_g_parents,\r\nARRAY_SIZE(cclk_g_parents),\r\nCLK_SET_RATE_PARENT,\r\nclk_base + CCLKG_BURST_POLICY,\r\n0, 4, 0, 0, NULL);\r\nclks[TEGRA30_CLK_CCLK_G] = clk;\r\nclk = tegra_clk_register_divider("pll_p_cclklp", "pll_p",\r\nclk_base + SUPER_CCLKLP_DIVIDER, 0,\r\nTEGRA_DIVIDER_INT, 16, 8, 1, NULL);\r\nclk_register_clkdev(clk, "pll_p_cclklp", NULL);\r\nclk = tegra_clk_register_divider("pll_p_out3_cclklp", "pll_p_out3",\r\nclk_base + SUPER_CCLKG_DIVIDER, 0,\r\nTEGRA_DIVIDER_INT, 16, 8, 1, NULL);\r\nclk_register_clkdev(clk, "pll_p_out3_cclklp", NULL);\r\nclk = tegra_clk_register_divider("pll_p_out4_cclklp", "pll_p_out4",\r\nclk_base + SUPER_CCLKLP_DIVIDER, 0,\r\nTEGRA_DIVIDER_INT, 16, 8, 1, NULL);\r\nclk_register_clkdev(clk, "pll_p_out4_cclklp", NULL);\r\nclk = tegra_clk_register_super_mux("cclk_lp", cclk_lp_parents,\r\nARRAY_SIZE(cclk_lp_parents),\r\nCLK_SET_RATE_PARENT,\r\nclk_base + CCLKLP_BURST_POLICY,\r\nTEGRA_DIVIDER_2, 4, 8, 9,\r\nNULL);\r\nclks[TEGRA30_CLK_CCLK_LP] = clk;\r\nclk = tegra_clk_register_super_mux("sclk", sclk_parents,\r\nARRAY_SIZE(sclk_parents),\r\nCLK_SET_RATE_PARENT,\r\nclk_base + SCLK_BURST_POLICY,\r\n0, 4, 0, 0, NULL);\r\nclks[TEGRA30_CLK_SCLK] = clk;\r\nclk = clk_register_fixed_factor(NULL, "twd", "cclk_g",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclks[TEGRA30_CLK_TWD] = clk;\r\ntegra_super_clk_gen4_init(clk_base, pmc_base, tegra30_clks, NULL);\r\n}\r\nstatic void __init tegra30_periph_clk_init(void)\r\n{\r\nstruct tegra_periph_init_data *data;\r\nstruct clk *clk;\r\nunsigned int i;\r\nclk = tegra_clk_register_periph_gate("dsia", "pll_d_out0", 0, clk_base,\r\n0, 48, periph_clk_enb_refcnt);\r\nclks[TEGRA30_CLK_DSIA] = clk;\r\nclk = tegra_clk_register_periph_gate("pcie", "clk_m", 0, clk_base, 0,\r\n70, periph_clk_enb_refcnt);\r\nclks[TEGRA30_CLK_PCIE] = clk;\r\nclk = tegra_clk_register_periph_gate("afi", "clk_m", 0, clk_base, 0, 72,\r\nperiph_clk_enb_refcnt);\r\nclks[TEGRA30_CLK_AFI] = clk;\r\nclk = clk_register_mux(NULL, "emc_mux", mux_pllmcp_clkm,\r\nARRAY_SIZE(mux_pllmcp_clkm),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + CLK_SOURCE_EMC,\r\n30, 2, 0, &emc_lock);\r\nclk = tegra_clk_register_periph_gate("emc", "emc_mux", 0, clk_base, 0,\r\n57, periph_clk_enb_refcnt);\r\nclks[TEGRA30_CLK_EMC] = clk;\r\nclk = tegra_clk_register_mc("mc", "emc_mux", clk_base + CLK_SOURCE_EMC,\r\n&emc_lock);\r\nclks[TEGRA30_CLK_MC] = clk;\r\nclk = clk_register_gate(NULL, "cml0", "pll_e", 0, clk_base + PLLE_AUX,\r\n0, 0, &cml_lock);\r\nclks[TEGRA30_CLK_CML0] = clk;\r\nclk = clk_register_gate(NULL, "cml1", "pll_e", 0, clk_base + PLLE_AUX,\r\n1, 0, &cml_lock);\r\nclks[TEGRA30_CLK_CML1] = clk;\r\nfor (i = 0; i < ARRAY_SIZE(tegra_periph_clk_list); i++) {\r\ndata = &tegra_periph_clk_list[i];\r\nclk = tegra_clk_register_periph(data->name, data->p.parent_names,\r\ndata->num_parents, &data->periph,\r\nclk_base, data->offset, data->flags);\r\nclks[data->clk_id] = clk;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(tegra_periph_nodiv_clk_list); i++) {\r\ndata = &tegra_periph_nodiv_clk_list[i];\r\nclk = tegra_clk_register_periph_nodiv(data->name,\r\ndata->p.parent_names,\r\ndata->num_parents, &data->periph,\r\nclk_base, data->offset);\r\nclks[data->clk_id] = clk;\r\n}\r\ntegra_periph_clk_init(clk_base, pmc_base, tegra30_clks, &pll_p_params);\r\n}\r\nstatic void tegra30_wait_cpu_in_reset(u32 cpu)\r\n{\r\nunsigned int reg;\r\ndo {\r\nreg = readl(clk_base +\r\nTEGRA30_CLK_RST_CONTROLLER_CPU_CMPLX_STATUS);\r\ncpu_relax();\r\n} while (!(reg & (1 << cpu)));\r\nreturn;\r\n}\r\nstatic void tegra30_put_cpu_in_reset(u32 cpu)\r\n{\r\nwritel(CPU_RESET(cpu),\r\nclk_base + TEGRA_CLK_RST_CONTROLLER_RST_CPU_CMPLX_SET);\r\ndmb();\r\n}\r\nstatic void tegra30_cpu_out_of_reset(u32 cpu)\r\n{\r\nwritel(CPU_RESET(cpu),\r\nclk_base + TEGRA_CLK_RST_CONTROLLER_RST_CPU_CMPLX_CLR);\r\nwmb();\r\n}\r\nstatic void tegra30_enable_cpu_clock(u32 cpu)\r\n{\r\nunsigned int reg;\r\nwritel(CPU_CLOCK(cpu),\r\nclk_base + TEGRA30_CLK_RST_CONTROLLER_CLK_CPU_CMPLX_CLR);\r\nreg = readl(clk_base +\r\nTEGRA30_CLK_RST_CONTROLLER_CLK_CPU_CMPLX_CLR);\r\n}\r\nstatic void tegra30_disable_cpu_clock(u32 cpu)\r\n{\r\nunsigned int reg;\r\nreg = readl(clk_base + TEGRA_CLK_RST_CONTROLLER_CLK_CPU_CMPLX);\r\nwritel(reg | CPU_CLOCK(cpu),\r\nclk_base + TEGRA_CLK_RST_CONTROLLER_CLK_CPU_CMPLX);\r\n}\r\nstatic bool tegra30_cpu_rail_off_ready(void)\r\n{\r\nunsigned int cpu_rst_status;\r\nint cpu_pwr_status;\r\ncpu_rst_status = readl(clk_base +\r\nTEGRA30_CLK_RST_CONTROLLER_CPU_CMPLX_STATUS);\r\ncpu_pwr_status = tegra_powergate_is_powered(TEGRA_POWERGATE_CPU1) ||\r\ntegra_powergate_is_powered(TEGRA_POWERGATE_CPU2) ||\r\ntegra_powergate_is_powered(TEGRA_POWERGATE_CPU3);\r\nif (((cpu_rst_status & 0xE) != 0xE) || cpu_pwr_status)\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic void tegra30_cpu_clock_suspend(void)\r\n{\r\ntegra30_cpu_clk_sctx.clk_csite_src =\r\nreadl(clk_base + CLK_RESET_SOURCE_CSITE);\r\nwritel(3 << 30, clk_base + CLK_RESET_SOURCE_CSITE);\r\ntegra30_cpu_clk_sctx.cpu_burst =\r\nreadl(clk_base + CLK_RESET_CCLK_BURST);\r\ntegra30_cpu_clk_sctx.pllx_base =\r\nreadl(clk_base + CLK_RESET_PLLX_BASE);\r\ntegra30_cpu_clk_sctx.pllx_misc =\r\nreadl(clk_base + CLK_RESET_PLLX_MISC);\r\ntegra30_cpu_clk_sctx.cclk_divider =\r\nreadl(clk_base + CLK_RESET_CCLK_DIVIDER);\r\n}\r\nstatic void tegra30_cpu_clock_resume(void)\r\n{\r\nunsigned int reg, policy;\r\nreg = readl(clk_base + CLK_RESET_CCLK_BURST);\r\npolicy = (reg >> CLK_RESET_CCLK_BURST_POLICY_SHIFT) & 0xF;\r\nif (policy == CLK_RESET_CCLK_IDLE_POLICY)\r\nreg = (reg >> CLK_RESET_CCLK_IDLE_POLICY_SHIFT) & 0xF;\r\nelse if (policy == CLK_RESET_CCLK_RUN_POLICY)\r\nreg = (reg >> CLK_RESET_CCLK_RUN_POLICY_SHIFT) & 0xF;\r\nelse\r\nBUG();\r\nif (reg != CLK_RESET_CCLK_BURST_POLICY_PLLX) {\r\nwritel(tegra30_cpu_clk_sctx.pllx_misc,\r\nclk_base + CLK_RESET_PLLX_MISC);\r\nwritel(tegra30_cpu_clk_sctx.pllx_base,\r\nclk_base + CLK_RESET_PLLX_BASE);\r\nif (tegra30_cpu_clk_sctx.pllx_base & (1 << 30))\r\nudelay(300);\r\n}\r\nwritel(tegra30_cpu_clk_sctx.cclk_divider,\r\nclk_base + CLK_RESET_CCLK_DIVIDER);\r\nwritel(tegra30_cpu_clk_sctx.cpu_burst,\r\nclk_base + CLK_RESET_CCLK_BURST);\r\nwritel(tegra30_cpu_clk_sctx.clk_csite_src,\r\nclk_base + CLK_RESET_SOURCE_CSITE);\r\n}\r\nstatic void __init tegra30_clock_apply_init_table(void)\r\n{\r\ntegra_init_from_table(init_table, clks, TEGRA30_CLK_CLK_MAX);\r\n}\r\nstatic void __init tegra30_clock_init(struct device_node *np)\r\n{\r\nstruct device_node *node;\r\nclk_base = of_iomap(np, 0);\r\nif (!clk_base) {\r\npr_err("ioremap tegra30 CAR failed\n");\r\nreturn;\r\n}\r\nnode = of_find_matching_node(NULL, pmc_match);\r\nif (!node) {\r\npr_err("Failed to find pmc node\n");\r\nBUG();\r\n}\r\npmc_base = of_iomap(node, 0);\r\nif (!pmc_base) {\r\npr_err("Can't map pmc registers\n");\r\nBUG();\r\n}\r\nclks = tegra_clk_init(clk_base, TEGRA30_CLK_CLK_MAX,\r\nTEGRA30_CLK_PERIPH_BANKS);\r\nif (!clks)\r\nreturn;\r\nif (tegra_osc_clk_init(clk_base, tegra30_clks, tegra30_input_freq,\r\nARRAY_SIZE(tegra30_input_freq), 1, &input_freq,\r\nNULL) < 0)\r\nreturn;\r\ntegra_fixed_clk_init(tegra30_clks);\r\ntegra30_pll_init();\r\ntegra30_super_clk_init();\r\ntegra30_periph_clk_init();\r\ntegra_audio_clk_init(clk_base, pmc_base, tegra30_clks,\r\ntegra30_audio_plls,\r\nARRAY_SIZE(tegra30_audio_plls));\r\ntegra_pmc_clk_init(pmc_base, tegra30_clks);\r\ntegra_init_dup_clks(tegra_clk_duplicates, clks, TEGRA30_CLK_CLK_MAX);\r\ntegra_add_of_provider(np);\r\ntegra_register_devclks(devclks, ARRAY_SIZE(devclks));\r\ntegra_clk_apply_init_table = tegra30_clock_apply_init_table;\r\ntegra_cpu_car_ops = &tegra30_cpu_car_ops;\r\n}

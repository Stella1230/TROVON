static u64 notrace clps711x_sched_clock_read(void)\r\n{\r\nreturn ~readw(tcd);\r\n}\r\nstatic int __init _clps711x_clksrc_init(struct clk *clock, void __iomem *base)\r\n{\r\nunsigned long rate;\r\nif (!base)\r\nreturn -ENOMEM;\r\nif (IS_ERR(clock))\r\nreturn PTR_ERR(clock);\r\nrate = clk_get_rate(clock);\r\ntcd = base;\r\nclocksource_mmio_init(tcd, "clps711x-clocksource", rate, 300, 16,\r\nclocksource_mmio_readw_down);\r\nsched_clock_register(clps711x_sched_clock_read, 16, rate);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t clps711x_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = dev_id;\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init _clps711x_clkevt_init(struct clk *clock, void __iomem *base,\r\nunsigned int irq)\r\n{\r\nstruct clock_event_device *clkevt;\r\nunsigned long rate;\r\nif (!irq)\r\nreturn -EINVAL;\r\nif (!base)\r\nreturn -ENOMEM;\r\nif (IS_ERR(clock))\r\nreturn PTR_ERR(clock);\r\nclkevt = kzalloc(sizeof(*clkevt), GFP_KERNEL);\r\nif (!clkevt)\r\nreturn -ENOMEM;\r\nrate = clk_get_rate(clock);\r\nwritew(DIV_ROUND_CLOSEST(rate, HZ), base);\r\nclkevt->name = "clps711x-clockevent";\r\nclkevt->rating = 300;\r\nclkevt->features = CLOCK_EVT_FEAT_PERIODIC | CLOCK_EVT_FEAT_C3STOP;\r\nclkevt->cpumask = cpumask_of(0);\r\nclockevents_config_and_register(clkevt, HZ, 0, 0);\r\nreturn request_irq(irq, clps711x_timer_interrupt, IRQF_TIMER,\r\n"clps711x-timer", clkevt);\r\n}\r\nvoid __init clps711x_clksrc_init(void __iomem *tc1_base, void __iomem *tc2_base,\r\nunsigned int irq)\r\n{\r\nstruct clk *tc1 = clk_get_sys("clps711x-timer.0", NULL);\r\nstruct clk *tc2 = clk_get_sys("clps711x-timer.1", NULL);\r\nBUG_ON(_clps711x_clksrc_init(tc1, tc1_base));\r\nBUG_ON(_clps711x_clkevt_init(tc2, tc2_base, irq));\r\n}\r\nstatic int __init clps711x_timer_init(struct device_node *np)\r\n{\r\nunsigned int irq = irq_of_parse_and_map(np, 0);\r\nstruct clk *clock = of_clk_get(np, 0);\r\nvoid __iomem *base = of_iomap(np, 0);\r\nswitch (of_alias_get_id(np, "timer")) {\r\ncase CLPS711X_CLKSRC_CLOCKSOURCE:\r\nreturn _clps711x_clksrc_init(clock, base);\r\ncase CLPS711X_CLKSRC_CLOCKEVENT:\r\nreturn _clps711x_clkevt_init(clock, base, irq);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}

static int arcpgu_drm_connector_get_modes(struct drm_connector *connector)\r\n{\r\nint count;\r\ncount = drm_add_modes_noedid(connector, XRES_MAX, YRES_MAX);\r\ndrm_set_preferred_mode(connector, XRES_DEF, YRES_DEF);\r\nreturn count;\r\n}\r\nstatic enum drm_connector_status\r\narcpgu_drm_connector_detect(struct drm_connector *connector, bool force)\r\n{\r\nreturn connector_status_connected;\r\n}\r\nstatic void arcpgu_drm_connector_destroy(struct drm_connector *connector)\r\n{\r\ndrm_connector_unregister(connector);\r\ndrm_connector_cleanup(connector);\r\n}\r\nint arcpgu_drm_sim_init(struct drm_device *drm, struct device_node *np)\r\n{\r\nstruct arcpgu_drm_connector *arcpgu_connector;\r\nstruct drm_encoder_slave *encoder;\r\nstruct drm_connector *connector;\r\nint ret;\r\nencoder = devm_kzalloc(drm->dev, sizeof(*encoder), GFP_KERNEL);\r\nif (encoder == NULL)\r\nreturn -ENOMEM;\r\nencoder->base.possible_crtcs = 1;\r\nencoder->base.possible_clones = 0;\r\nret = drm_encoder_init(drm, &encoder->base, &arcpgu_drm_encoder_funcs,\r\nDRM_MODE_ENCODER_VIRTUAL, NULL);\r\nif (ret)\r\nreturn ret;\r\narcpgu_connector = devm_kzalloc(drm->dev, sizeof(*arcpgu_connector),\r\nGFP_KERNEL);\r\nif (!arcpgu_connector) {\r\nret = -ENOMEM;\r\ngoto error_encoder_cleanup;\r\n}\r\nconnector = &arcpgu_connector->connector;\r\ndrm_connector_helper_add(connector, &arcpgu_drm_connector_helper_funcs);\r\nret = drm_connector_init(drm, connector, &arcpgu_drm_connector_funcs,\r\nDRM_MODE_CONNECTOR_VIRTUAL);\r\nif (ret < 0) {\r\ndev_err(drm->dev, "failed to initialize drm connector\n");\r\ngoto error_encoder_cleanup;\r\n}\r\nret = drm_mode_connector_attach_encoder(connector, &encoder->base);\r\nif (ret < 0) {\r\ndev_err(drm->dev, "could not attach connector to encoder\n");\r\ndrm_connector_unregister(connector);\r\ngoto error_connector_cleanup;\r\n}\r\narcpgu_connector->encoder_slave = encoder;\r\nreturn 0;\r\nerror_connector_cleanup:\r\ndrm_connector_cleanup(connector);\r\nerror_encoder_cleanup:\r\ndrm_encoder_cleanup(&encoder->base);\r\nreturn ret;\r\n}

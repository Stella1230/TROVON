static int\r\ngp100_ram_init(struct nvkm_ram *ram)\r\n{\r\nstruct nvkm_subdev *subdev = &ram->fb->subdev;\r\nstruct nvkm_device *device = subdev->device;\r\nstruct nvkm_bios *bios = device->bios;\r\nu8 ver, hdr, cnt, len, snr, ssz;\r\nu32 data;\r\nint i;\r\ndata = nvbios_rammapTe(bios, &ver, &hdr, &cnt, &len, &snr, &ssz);\r\nif (!data || hdr < 0x15)\r\nreturn -EINVAL;\r\ncnt = nvbios_rd08(bios, data + 0x14);\r\ndata = nvbios_rd32(bios, data + 0x10);\r\nif (cnt) {\r\nu32 save = nvkm_rd32(device, 0x9a065c) & 0x000000f0;\r\nfor (i = 0; i < cnt; i++, data += 4) {\r\nif (i != save >> 4) {\r\nnvkm_mask(device, 0x9a065c, 0x000000f0, i << 4);\r\nnvbios_exec(&(struct nvbios_init) {\r\n.subdev = subdev,\r\n.bios = bios,\r\n.offset = nvbios_rd32(bios, data),\r\n.execute = 1,\r\n});\r\n}\r\n}\r\nnvkm_mask(device, 0x9a065c, 0x000000f0, save);\r\n}\r\nnvkm_mask(device, 0x9a0584, 0x11000000, 0x00000000);\r\nnvkm_wr32(device, 0x10ecc0, 0xffffffff);\r\nnvkm_mask(device, 0x9a0160, 0x00000010, 0x00000010);\r\nreturn 0;\r\n}\r\nint\r\ngp100_ram_new(struct nvkm_fb *fb, struct nvkm_ram **pram)\r\n{\r\nstruct nvkm_ram *ram;\r\nstruct nvkm_subdev *subdev = &fb->subdev;\r\nstruct nvkm_device *device = subdev->device;\r\nenum nvkm_ram_type type = nvkm_fb_bios_memtype(device->bios);\r\nconst u32 rsvd_head = ( 256 * 1024);\r\nconst u32 rsvd_tail = (1024 * 1024);\r\nu32 fbpa_num = nvkm_rd32(device, 0x022438), fbpa;\r\nu32 fbio_opt = nvkm_rd32(device, 0x021c14);\r\nu64 part, size = 0, comm = ~0ULL;\r\nbool mixed = false;\r\nint ret;\r\nnvkm_debug(subdev, "022438: %08x\n", fbpa_num);\r\nnvkm_debug(subdev, "021c14: %08x\n", fbio_opt);\r\nfor (fbpa = 0; fbpa < fbpa_num; fbpa++) {\r\nif (!(fbio_opt & (1 << fbpa))) {\r\npart = nvkm_rd32(device, 0x90020c + (fbpa * 0x4000));\r\nnvkm_debug(subdev, "fbpa %02x: %lld MiB\n", fbpa, part);\r\npart = part << 20;\r\nif (part != comm) {\r\nif (comm != ~0ULL)\r\nmixed = true;\r\ncomm = min(comm, part);\r\n}\r\nsize = size + part;\r\n}\r\n}\r\nret = nvkm_ram_new_(&gp100_ram_func, fb, type, size, 0, &ram);\r\n*pram = ram;\r\nif (ret)\r\nreturn ret;\r\nnvkm_mm_fini(&ram->vram);\r\nif (mixed) {\r\nret = nvkm_mm_init(&ram->vram, rsvd_head >> NVKM_RAM_MM_SHIFT,\r\n((comm * fbpa_num) - rsvd_head) >>\r\nNVKM_RAM_MM_SHIFT, 1);\r\nif (ret)\r\nreturn ret;\r\nret = nvkm_mm_init(&ram->vram, (0x1000000000ULL + comm) >>\r\nNVKM_RAM_MM_SHIFT,\r\n(size - (comm * fbpa_num) - rsvd_tail) >>\r\nNVKM_RAM_MM_SHIFT, 1);\r\nif (ret)\r\nreturn ret;\r\n} else {\r\nret = nvkm_mm_init(&ram->vram, rsvd_head >> NVKM_RAM_MM_SHIFT,\r\n(size - rsvd_head - rsvd_tail) >>\r\nNVKM_RAM_MM_SHIFT, 1);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

void lbs_mac_event_disconnected(struct lbs_private *priv,\r\nbool locally_generated)\r\n{\r\nunsigned long flags;\r\nif (priv->connect_status != LBS_CONNECTED)\r\nreturn;\r\nlbs_deb_enter(LBS_DEB_ASSOC);\r\nmsleep_interruptible(1000);\r\nif (priv->wdev->iftype == NL80211_IFTYPE_STATION)\r\nlbs_send_disconnect_notification(priv, locally_generated);\r\nnetif_stop_queue(priv->dev);\r\nnetif_carrier_off(priv->dev);\r\nspin_lock_irqsave(&priv->driver_lock, flags);\r\nkfree_skb(priv->currenttxskb);\r\npriv->currenttxskb = NULL;\r\npriv->tx_pending_len = 0;\r\nspin_unlock_irqrestore(&priv->driver_lock, flags);\r\npriv->connect_status = LBS_DISCONNECTED;\r\nif (priv->psstate != PS_STATE_FULL_POWER) {\r\nlbs_deb_cmd("disconnected, so exit PS mode\n");\r\nlbs_set_ps_mode(priv, PS_MODE_ACTION_EXIT_PS, false);\r\n}\r\nlbs_deb_leave(LBS_DEB_ASSOC);\r\n}\r\nint lbs_process_command_response(struct lbs_private *priv, u8 *data, u32 len)\r\n{\r\nuint16_t respcmd, curcmd;\r\nstruct cmd_header *resp;\r\nint ret = 0;\r\nunsigned long flags;\r\nuint16_t result;\r\nlbs_deb_enter(LBS_DEB_HOST);\r\nmutex_lock(&priv->lock);\r\nspin_lock_irqsave(&priv->driver_lock, flags);\r\nif (!priv->cur_cmd) {\r\nlbs_deb_host("CMD_RESP: cur_cmd is NULL\n");\r\nret = -1;\r\nspin_unlock_irqrestore(&priv->driver_lock, flags);\r\ngoto done;\r\n}\r\nresp = (void *)data;\r\ncurcmd = le16_to_cpu(priv->cur_cmd->cmdbuf->command);\r\nrespcmd = le16_to_cpu(resp->command);\r\nresult = le16_to_cpu(resp->result);\r\nlbs_deb_cmd("CMD_RESP: response 0x%04x, seq %d, size %d\n",\r\nrespcmd, le16_to_cpu(resp->seqnum), len);\r\nlbs_deb_hex(LBS_DEB_CMD, "CMD_RESP", (void *) resp, len);\r\nif (resp->seqnum != priv->cur_cmd->cmdbuf->seqnum) {\r\nnetdev_info(priv->dev,\r\n"Received CMD_RESP with invalid sequence %d (expected %d)\n",\r\nle16_to_cpu(resp->seqnum),\r\nle16_to_cpu(priv->cur_cmd->cmdbuf->seqnum));\r\nspin_unlock_irqrestore(&priv->driver_lock, flags);\r\nret = -1;\r\ngoto done;\r\n}\r\nif (respcmd != CMD_RET(curcmd) &&\r\nrespcmd != CMD_RET_802_11_ASSOCIATE && curcmd != CMD_802_11_ASSOCIATE) {\r\nnetdev_info(priv->dev, "Invalid CMD_RESP %x to command %x!\n",\r\nrespcmd, curcmd);\r\nspin_unlock_irqrestore(&priv->driver_lock, flags);\r\nret = -1;\r\ngoto done;\r\n}\r\nif (resp->result == cpu_to_le16(0x0004)) {\r\nnetdev_info(priv->dev,\r\n"Firmware returns DEFER to command %x. Will let it time out...\n",\r\nle16_to_cpu(resp->command));\r\nspin_unlock_irqrestore(&priv->driver_lock, flags);\r\nret = -1;\r\ngoto done;\r\n}\r\ndel_timer(&priv->command_timer);\r\npriv->cmd_timed_out = 0;\r\nif (respcmd == CMD_RET(CMD_802_11_PS_MODE)) {\r\nstruct cmd_ds_802_11_ps_mode *psmode = (void *)resp;\r\nu16 action = le16_to_cpu(psmode->action);\r\nlbs_deb_host(\r\n"CMD_RESP: PS_MODE cmd reply result 0x%x, action 0x%x\n",\r\nresult, action);\r\nif (result) {\r\nlbs_deb_host("CMD_RESP: PS command failed with 0x%x\n",\r\nresult);\r\nif (priv->wdev->iftype == NL80211_IFTYPE_MONITOR &&\r\naction == PS_MODE_ACTION_ENTER_PS)\r\npriv->psmode = LBS802_11POWERMODECAM;\r\n} else if (action == PS_MODE_ACTION_ENTER_PS) {\r\npriv->needtowakeup = 0;\r\npriv->psstate = PS_STATE_AWAKE;\r\nlbs_deb_host("CMD_RESP: ENTER_PS command response\n");\r\nif (priv->connect_status != LBS_CONNECTED) {\r\nlbs_deb_host(\r\n"disconnected, invoking lbs_ps_wakeup\n");\r\nspin_unlock_irqrestore(&priv->driver_lock, flags);\r\nmutex_unlock(&priv->lock);\r\nlbs_set_ps_mode(priv, PS_MODE_ACTION_EXIT_PS,\r\nfalse);\r\nmutex_lock(&priv->lock);\r\nspin_lock_irqsave(&priv->driver_lock, flags);\r\n}\r\n} else if (action == PS_MODE_ACTION_EXIT_PS) {\r\npriv->needtowakeup = 0;\r\npriv->psstate = PS_STATE_FULL_POWER;\r\nlbs_deb_host("CMD_RESP: EXIT_PS command response\n");\r\n} else {\r\nlbs_deb_host("CMD_RESP: PS action 0x%X\n", action);\r\n}\r\n__lbs_complete_command(priv, priv->cur_cmd, result);\r\nspin_unlock_irqrestore(&priv->driver_lock, flags);\r\nret = 0;\r\ngoto done;\r\n}\r\nif ((result != 0 || !(respcmd & 0x8000))) {\r\nlbs_deb_host("CMD_RESP: error 0x%04x in command reply 0x%04x\n",\r\nresult, respcmd);\r\nswitch (respcmd) {\r\ncase CMD_RET(CMD_GET_HW_SPEC):\r\ncase CMD_RET(CMD_802_11_RESET):\r\nlbs_deb_host("CMD_RESP: reset failed\n");\r\nbreak;\r\n}\r\n__lbs_complete_command(priv, priv->cur_cmd, result);\r\nspin_unlock_irqrestore(&priv->driver_lock, flags);\r\nret = -1;\r\ngoto done;\r\n}\r\nspin_unlock_irqrestore(&priv->driver_lock, flags);\r\nif (priv->cur_cmd && priv->cur_cmd->callback) {\r\nret = priv->cur_cmd->callback(priv, priv->cur_cmd->callback_arg,\r\nresp);\r\n}\r\nspin_lock_irqsave(&priv->driver_lock, flags);\r\nif (priv->cur_cmd) {\r\n__lbs_complete_command(priv, priv->cur_cmd, result);\r\n}\r\nspin_unlock_irqrestore(&priv->driver_lock, flags);\r\ndone:\r\nmutex_unlock(&priv->lock);\r\nlbs_deb_leave_args(LBS_DEB_HOST, "ret %d", ret);\r\nreturn ret;\r\n}\r\nint lbs_process_event(struct lbs_private *priv, u32 event)\r\n{\r\nint ret = 0;\r\nstruct cmd_header cmd;\r\nlbs_deb_enter(LBS_DEB_CMD);\r\nswitch (event) {\r\ncase MACREG_INT_CODE_LINK_SENSED:\r\nlbs_deb_cmd("EVENT: link sensed\n");\r\nbreak;\r\ncase MACREG_INT_CODE_DEAUTHENTICATED:\r\nlbs_deb_cmd("EVENT: deauthenticated\n");\r\nlbs_mac_event_disconnected(priv, false);\r\nbreak;\r\ncase MACREG_INT_CODE_DISASSOCIATED:\r\nlbs_deb_cmd("EVENT: disassociated\n");\r\nlbs_mac_event_disconnected(priv, false);\r\nbreak;\r\ncase MACREG_INT_CODE_LINK_LOST_NO_SCAN:\r\nlbs_deb_cmd("EVENT: link lost\n");\r\nlbs_mac_event_disconnected(priv, true);\r\nbreak;\r\ncase MACREG_INT_CODE_PS_SLEEP:\r\nlbs_deb_cmd("EVENT: ps sleep\n");\r\nif (priv->psstate == PS_STATE_FULL_POWER) {\r\nlbs_deb_cmd(\r\n"EVENT: in FULL POWER mode, ignoring PS_SLEEP\n");\r\nbreak;\r\n}\r\nif (!list_empty(&priv->cmdpendingq)) {\r\nlbs_deb_cmd("EVENT: commands in queue, do not sleep\n");\r\nbreak;\r\n}\r\npriv->psstate = PS_STATE_PRE_SLEEP;\r\nlbs_ps_confirm_sleep(priv);\r\nbreak;\r\ncase MACREG_INT_CODE_HOST_AWAKE:\r\nlbs_deb_cmd("EVENT: host awake\n");\r\nif (priv->reset_deep_sleep_wakeup)\r\npriv->reset_deep_sleep_wakeup(priv);\r\npriv->is_deep_sleep = 0;\r\nlbs_cmd_async(priv, CMD_802_11_WAKEUP_CONFIRM, &cmd,\r\nsizeof(cmd));\r\npriv->is_host_sleep_activated = 0;\r\nwake_up_interruptible(&priv->host_sleep_q);\r\nbreak;\r\ncase MACREG_INT_CODE_DEEP_SLEEP_AWAKE:\r\nif (priv->reset_deep_sleep_wakeup)\r\npriv->reset_deep_sleep_wakeup(priv);\r\nlbs_deb_cmd("EVENT: ds awake\n");\r\npriv->is_deep_sleep = 0;\r\npriv->wakeup_dev_required = 0;\r\nwake_up_interruptible(&priv->ds_awake_q);\r\nbreak;\r\ncase MACREG_INT_CODE_PS_AWAKE:\r\nlbs_deb_cmd("EVENT: ps awake\n");\r\nif (priv->psstate == PS_STATE_FULL_POWER) {\r\nlbs_deb_cmd(\r\n"EVENT: In FULL POWER mode - ignore PS AWAKE\n");\r\nbreak;\r\n}\r\npriv->psstate = PS_STATE_AWAKE;\r\nif (priv->needtowakeup) {\r\nlbs_deb_cmd("waking up ...\n");\r\nlbs_set_ps_mode(priv, PS_MODE_ACTION_EXIT_PS, false);\r\n}\r\nbreak;\r\ncase MACREG_INT_CODE_MIC_ERR_UNICAST:\r\nlbs_deb_cmd("EVENT: UNICAST MIC ERROR\n");\r\nlbs_send_mic_failureevent(priv, event);\r\nbreak;\r\ncase MACREG_INT_CODE_MIC_ERR_MULTICAST:\r\nlbs_deb_cmd("EVENT: MULTICAST MIC ERROR\n");\r\nlbs_send_mic_failureevent(priv, event);\r\nbreak;\r\ncase MACREG_INT_CODE_MIB_CHANGED:\r\nlbs_deb_cmd("EVENT: MIB CHANGED\n");\r\nbreak;\r\ncase MACREG_INT_CODE_INIT_DONE:\r\nlbs_deb_cmd("EVENT: INIT DONE\n");\r\nbreak;\r\ncase MACREG_INT_CODE_ADHOC_BCN_LOST:\r\nlbs_deb_cmd("EVENT: ADHOC beacon lost\n");\r\nbreak;\r\ncase MACREG_INT_CODE_RSSI_LOW:\r\nnetdev_alert(priv->dev, "EVENT: rssi low\n");\r\nbreak;\r\ncase MACREG_INT_CODE_SNR_LOW:\r\nnetdev_alert(priv->dev, "EVENT: snr low\n");\r\nbreak;\r\ncase MACREG_INT_CODE_MAX_FAIL:\r\nnetdev_alert(priv->dev, "EVENT: max fail\n");\r\nbreak;\r\ncase MACREG_INT_CODE_RSSI_HIGH:\r\nnetdev_alert(priv->dev, "EVENT: rssi high\n");\r\nbreak;\r\ncase MACREG_INT_CODE_SNR_HIGH:\r\nnetdev_alert(priv->dev, "EVENT: snr high\n");\r\nbreak;\r\ncase MACREG_INT_CODE_MESH_AUTO_STARTED:\r\nnetdev_info(priv->dev, "EVENT: MESH_AUTO_STARTED (ignoring)\n");\r\nbreak;\r\ndefault:\r\nnetdev_alert(priv->dev, "EVENT: unknown event id %d\n", event);\r\nbreak;\r\n}\r\nlbs_deb_leave_args(LBS_DEB_CMD, "ret %d", ret);\r\nreturn ret;\r\n}

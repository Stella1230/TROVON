int rxe_mcast_get_grp(struct rxe_dev *rxe, union ib_gid *mgid,\r\nstruct rxe_mc_grp **grp_p)\r\n{\r\nint err;\r\nstruct rxe_mc_grp *grp;\r\nif (rxe->attr.max_mcast_qp_attach == 0) {\r\nerr = -EINVAL;\r\ngoto err1;\r\n}\r\ngrp = rxe_pool_get_key(&rxe->mc_grp_pool, mgid);\r\nif (grp)\r\ngoto done;\r\ngrp = rxe_alloc(&rxe->mc_grp_pool);\r\nif (!grp) {\r\nerr = -ENOMEM;\r\ngoto err1;\r\n}\r\nINIT_LIST_HEAD(&grp->qp_list);\r\nspin_lock_init(&grp->mcg_lock);\r\ngrp->rxe = rxe;\r\nrxe_add_key(grp, mgid);\r\nerr = rxe->ifc_ops->mcast_add(rxe, mgid);\r\nif (err)\r\ngoto err2;\r\ndone:\r\n*grp_p = grp;\r\nreturn 0;\r\nerr2:\r\nrxe_drop_ref(grp);\r\nerr1:\r\nreturn err;\r\n}\r\nint rxe_mcast_add_grp_elem(struct rxe_dev *rxe, struct rxe_qp *qp,\r\nstruct rxe_mc_grp *grp)\r\n{\r\nint err;\r\nstruct rxe_mc_elem *elem;\r\nspin_lock_bh(&qp->grp_lock);\r\nspin_lock_bh(&grp->mcg_lock);\r\nlist_for_each_entry(elem, &grp->qp_list, qp_list) {\r\nif (elem->qp == qp) {\r\nerr = 0;\r\ngoto out;\r\n}\r\n}\r\nif (grp->num_qp >= rxe->attr.max_mcast_qp_attach) {\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\nelem = rxe_alloc(&rxe->mc_elem_pool);\r\nif (!elem) {\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\nrxe_add_ref(grp);\r\ngrp->num_qp++;\r\nelem->qp = qp;\r\nelem->grp = grp;\r\nlist_add(&elem->qp_list, &grp->qp_list);\r\nlist_add(&elem->grp_list, &qp->grp_list);\r\nerr = 0;\r\nout:\r\nspin_unlock_bh(&grp->mcg_lock);\r\nspin_unlock_bh(&qp->grp_lock);\r\nreturn err;\r\n}\r\nint rxe_mcast_drop_grp_elem(struct rxe_dev *rxe, struct rxe_qp *qp,\r\nunion ib_gid *mgid)\r\n{\r\nstruct rxe_mc_grp *grp;\r\nstruct rxe_mc_elem *elem, *tmp;\r\ngrp = rxe_pool_get_key(&rxe->mc_grp_pool, mgid);\r\nif (!grp)\r\ngoto err1;\r\nspin_lock_bh(&qp->grp_lock);\r\nspin_lock_bh(&grp->mcg_lock);\r\nlist_for_each_entry_safe(elem, tmp, &grp->qp_list, qp_list) {\r\nif (elem->qp == qp) {\r\nlist_del(&elem->qp_list);\r\nlist_del(&elem->grp_list);\r\ngrp->num_qp--;\r\nspin_unlock_bh(&grp->mcg_lock);\r\nspin_unlock_bh(&qp->grp_lock);\r\nrxe_drop_ref(elem);\r\nrxe_drop_ref(grp);\r\nrxe_drop_ref(grp);\r\nreturn 0;\r\n}\r\n}\r\nspin_unlock_bh(&grp->mcg_lock);\r\nspin_unlock_bh(&qp->grp_lock);\r\nrxe_drop_ref(grp);\r\nerr1:\r\nreturn -EINVAL;\r\n}\r\nvoid rxe_drop_all_mcast_groups(struct rxe_qp *qp)\r\n{\r\nstruct rxe_mc_grp *grp;\r\nstruct rxe_mc_elem *elem;\r\nwhile (1) {\r\nspin_lock_bh(&qp->grp_lock);\r\nif (list_empty(&qp->grp_list)) {\r\nspin_unlock_bh(&qp->grp_lock);\r\nbreak;\r\n}\r\nelem = list_first_entry(&qp->grp_list, struct rxe_mc_elem,\r\ngrp_list);\r\nlist_del(&elem->grp_list);\r\nspin_unlock_bh(&qp->grp_lock);\r\ngrp = elem->grp;\r\nspin_lock_bh(&grp->mcg_lock);\r\nlist_del(&elem->qp_list);\r\ngrp->num_qp--;\r\nspin_unlock_bh(&grp->mcg_lock);\r\nrxe_drop_ref(grp);\r\nrxe_drop_ref(elem);\r\n}\r\n}\r\nvoid rxe_mc_cleanup(void *arg)\r\n{\r\nstruct rxe_mc_grp *grp = arg;\r\nstruct rxe_dev *rxe = grp->rxe;\r\nrxe_drop_key(grp);\r\nrxe->ifc_ops->mcast_delete(rxe, &grp->mgid);\r\n}

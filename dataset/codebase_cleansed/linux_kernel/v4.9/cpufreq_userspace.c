static int cpufreq_set(struct cpufreq_policy *policy, unsigned int freq)\r\n{\r\nint ret = -EINVAL;\r\nunsigned int *setspeed = policy->governor_data;\r\npr_debug("cpufreq_set for cpu %u, freq %u kHz\n", policy->cpu, freq);\r\nmutex_lock(&userspace_mutex);\r\nif (!per_cpu(cpu_is_managed, policy->cpu))\r\ngoto err;\r\n*setspeed = freq;\r\nret = __cpufreq_driver_target(policy, freq, CPUFREQ_RELATION_L);\r\nerr:\r\nmutex_unlock(&userspace_mutex);\r\nreturn ret;\r\n}\r\nstatic ssize_t show_speed(struct cpufreq_policy *policy, char *buf)\r\n{\r\nreturn sprintf(buf, "%u\n", policy->cur);\r\n}\r\nstatic int cpufreq_userspace_policy_init(struct cpufreq_policy *policy)\r\n{\r\nunsigned int *setspeed;\r\nsetspeed = kzalloc(sizeof(*setspeed), GFP_KERNEL);\r\nif (!setspeed)\r\nreturn -ENOMEM;\r\npolicy->governor_data = setspeed;\r\nreturn 0;\r\n}\r\nstatic void cpufreq_userspace_policy_exit(struct cpufreq_policy *policy)\r\n{\r\nmutex_lock(&userspace_mutex);\r\nkfree(policy->governor_data);\r\npolicy->governor_data = NULL;\r\nmutex_unlock(&userspace_mutex);\r\n}\r\nstatic int cpufreq_userspace_policy_start(struct cpufreq_policy *policy)\r\n{\r\nunsigned int *setspeed = policy->governor_data;\r\nBUG_ON(!policy->cur);\r\npr_debug("started managing cpu %u\n", policy->cpu);\r\nmutex_lock(&userspace_mutex);\r\nper_cpu(cpu_is_managed, policy->cpu) = 1;\r\n*setspeed = policy->cur;\r\nmutex_unlock(&userspace_mutex);\r\nreturn 0;\r\n}\r\nstatic void cpufreq_userspace_policy_stop(struct cpufreq_policy *policy)\r\n{\r\nunsigned int *setspeed = policy->governor_data;\r\npr_debug("managing cpu %u stopped\n", policy->cpu);\r\nmutex_lock(&userspace_mutex);\r\nper_cpu(cpu_is_managed, policy->cpu) = 0;\r\n*setspeed = 0;\r\nmutex_unlock(&userspace_mutex);\r\n}\r\nstatic void cpufreq_userspace_policy_limits(struct cpufreq_policy *policy)\r\n{\r\nunsigned int *setspeed = policy->governor_data;\r\nmutex_lock(&userspace_mutex);\r\npr_debug("limit event for cpu %u: %u - %u kHz, currently %u kHz, last set to %u kHz\n",\r\npolicy->cpu, policy->min, policy->max, policy->cur, *setspeed);\r\nif (policy->max < *setspeed)\r\n__cpufreq_driver_target(policy, policy->max, CPUFREQ_RELATION_H);\r\nelse if (policy->min > *setspeed)\r\n__cpufreq_driver_target(policy, policy->min, CPUFREQ_RELATION_L);\r\nelse\r\n__cpufreq_driver_target(policy, *setspeed, CPUFREQ_RELATION_L);\r\nmutex_unlock(&userspace_mutex);\r\n}\r\nstatic int __init cpufreq_gov_userspace_init(void)\r\n{\r\nreturn cpufreq_register_governor(&cpufreq_gov_userspace);\r\n}\r\nstatic void __exit cpufreq_gov_userspace_exit(void)\r\n{\r\ncpufreq_unregister_governor(&cpufreq_gov_userspace);\r\n}\r\nstruct cpufreq_governor *cpufreq_default_governor(void)\r\n{\r\nreturn &cpufreq_gov_userspace;\r\n}

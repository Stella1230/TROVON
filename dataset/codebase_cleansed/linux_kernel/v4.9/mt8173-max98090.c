static int mt8173_max98090_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nreturn snd_soc_dai_set_sysclk(codec_dai, 0, params_rate(params) * 256,\r\nSND_SOC_CLOCK_IN);\r\n}\r\nstatic int mt8173_max98090_init(struct snd_soc_pcm_runtime *runtime)\r\n{\r\nint ret;\r\nstruct snd_soc_card *card = runtime->card;\r\nstruct snd_soc_codec *codec = runtime->codec;\r\nret = snd_soc_card_jack_new(card, "Headphone", SND_JACK_HEADPHONE,\r\n&mt8173_max98090_jack, NULL, 0);\r\nif (ret) {\r\ndev_err(card->dev, "Can't snd_soc_jack_new %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_jack_add_pins(&mt8173_max98090_jack,\r\nARRAY_SIZE(mt8173_max98090_jack_pins),\r\nmt8173_max98090_jack_pins);\r\nif (ret) {\r\ndev_err(card->dev, "Can't snd_soc_jack_add_pins %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn max98090_mic_detect(codec, &mt8173_max98090_jack);\r\n}\r\nstatic int mt8173_max98090_dev_probe(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = &mt8173_max98090_card;\r\nstruct device_node *codec_node, *platform_node;\r\nint ret, i;\r\nplatform_node = of_parse_phandle(pdev->dev.of_node,\r\n"mediatek,platform", 0);\r\nif (!platform_node) {\r\ndev_err(&pdev->dev, "Property 'platform' missing or invalid\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < card->num_links; i++) {\r\nif (mt8173_max98090_dais[i].platform_name)\r\ncontinue;\r\nmt8173_max98090_dais[i].platform_of_node = platform_node;\r\n}\r\ncodec_node = of_parse_phandle(pdev->dev.of_node,\r\n"mediatek,audio-codec", 0);\r\nif (!codec_node) {\r\ndev_err(&pdev->dev,\r\n"Property 'audio-codec' missing or invalid\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < card->num_links; i++) {\r\nif (mt8173_max98090_dais[i].codec_name)\r\ncontinue;\r\nmt8173_max98090_dais[i].codec_of_node = codec_node;\r\n}\r\ncard->dev = &pdev->dev;\r\nret = devm_snd_soc_register_card(&pdev->dev, card);\r\nif (ret)\r\ndev_err(&pdev->dev, "%s snd_soc_register_card fail %d\n",\r\n__func__, ret);\r\nreturn ret;\r\n}

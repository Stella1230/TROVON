static inline struct drm_fbdev_cma *to_fbdev_cma(struct drm_fb_helper *helper)\r\n{\r\nreturn container_of(helper, struct drm_fbdev_cma, fb_helper);\r\n}\r\nstatic inline struct drm_fb_cma *to_fb_cma(struct drm_framebuffer *fb)\r\n{\r\nreturn container_of(fb, struct drm_fb_cma, fb);\r\n}\r\nvoid drm_fb_cma_destroy(struct drm_framebuffer *fb)\r\n{\r\nstruct drm_fb_cma *fb_cma = to_fb_cma(fb);\r\nint i;\r\nfor (i = 0; i < 4; i++) {\r\nif (fb_cma->obj[i])\r\ndrm_gem_object_unreference_unlocked(&fb_cma->obj[i]->base);\r\n}\r\ndrm_framebuffer_cleanup(fb);\r\nkfree(fb_cma);\r\n}\r\nint drm_fb_cma_create_handle(struct drm_framebuffer *fb,\r\nstruct drm_file *file_priv, unsigned int *handle)\r\n{\r\nstruct drm_fb_cma *fb_cma = to_fb_cma(fb);\r\nreturn drm_gem_handle_create(file_priv,\r\n&fb_cma->obj[0]->base, handle);\r\n}\r\nstatic struct drm_fb_cma *drm_fb_cma_alloc(struct drm_device *dev,\r\nconst struct drm_mode_fb_cmd2 *mode_cmd,\r\nstruct drm_gem_cma_object **obj,\r\nunsigned int num_planes, const struct drm_framebuffer_funcs *funcs)\r\n{\r\nstruct drm_fb_cma *fb_cma;\r\nint ret;\r\nint i;\r\nfb_cma = kzalloc(sizeof(*fb_cma), GFP_KERNEL);\r\nif (!fb_cma)\r\nreturn ERR_PTR(-ENOMEM);\r\ndrm_helper_mode_fill_fb_struct(&fb_cma->fb, mode_cmd);\r\nfor (i = 0; i < num_planes; i++)\r\nfb_cma->obj[i] = obj[i];\r\nret = drm_framebuffer_init(dev, &fb_cma->fb, funcs);\r\nif (ret) {\r\ndev_err(dev->dev, "Failed to initialize framebuffer: %d\n", ret);\r\nkfree(fb_cma);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn fb_cma;\r\n}\r\nstruct drm_framebuffer *drm_fb_cma_create_with_funcs(struct drm_device *dev,\r\nstruct drm_file *file_priv, const struct drm_mode_fb_cmd2 *mode_cmd,\r\nconst struct drm_framebuffer_funcs *funcs)\r\n{\r\nstruct drm_fb_cma *fb_cma;\r\nstruct drm_gem_cma_object *objs[4];\r\nstruct drm_gem_object *obj;\r\nunsigned int hsub;\r\nunsigned int vsub;\r\nint ret;\r\nint i;\r\nhsub = drm_format_horz_chroma_subsampling(mode_cmd->pixel_format);\r\nvsub = drm_format_vert_chroma_subsampling(mode_cmd->pixel_format);\r\nfor (i = 0; i < drm_format_num_planes(mode_cmd->pixel_format); i++) {\r\nunsigned int width = mode_cmd->width / (i ? hsub : 1);\r\nunsigned int height = mode_cmd->height / (i ? vsub : 1);\r\nunsigned int min_size;\r\nobj = drm_gem_object_lookup(file_priv, mode_cmd->handles[i]);\r\nif (!obj) {\r\ndev_err(dev->dev, "Failed to lookup GEM object\n");\r\nret = -ENXIO;\r\ngoto err_gem_object_unreference;\r\n}\r\nmin_size = (height - 1) * mode_cmd->pitches[i]\r\n+ width * drm_format_plane_cpp(mode_cmd->pixel_format, i)\r\n+ mode_cmd->offsets[i];\r\nif (obj->size < min_size) {\r\ndrm_gem_object_unreference_unlocked(obj);\r\nret = -EINVAL;\r\ngoto err_gem_object_unreference;\r\n}\r\nobjs[i] = to_drm_gem_cma_obj(obj);\r\n}\r\nfb_cma = drm_fb_cma_alloc(dev, mode_cmd, objs, i, funcs);\r\nif (IS_ERR(fb_cma)) {\r\nret = PTR_ERR(fb_cma);\r\ngoto err_gem_object_unreference;\r\n}\r\nreturn &fb_cma->fb;\r\nerr_gem_object_unreference:\r\nfor (i--; i >= 0; i--)\r\ndrm_gem_object_unreference_unlocked(&objs[i]->base);\r\nreturn ERR_PTR(ret);\r\n}\r\nstruct drm_framebuffer *drm_fb_cma_create(struct drm_device *dev,\r\nstruct drm_file *file_priv, const struct drm_mode_fb_cmd2 *mode_cmd)\r\n{\r\nreturn drm_fb_cma_create_with_funcs(dev, file_priv, mode_cmd,\r\n&drm_fb_cma_funcs);\r\n}\r\nstruct drm_gem_cma_object *drm_fb_cma_get_gem_obj(struct drm_framebuffer *fb,\r\nunsigned int plane)\r\n{\r\nstruct drm_fb_cma *fb_cma = to_fb_cma(fb);\r\nif (plane >= 4)\r\nreturn NULL;\r\nreturn fb_cma->obj[plane];\r\n}\r\nstatic void drm_fb_cma_describe(struct drm_framebuffer *fb, struct seq_file *m)\r\n{\r\nstruct drm_fb_cma *fb_cma = to_fb_cma(fb);\r\nint i, n = drm_format_num_planes(fb->pixel_format);\r\nseq_printf(m, "fb: %dx%d@%4.4s\n", fb->width, fb->height,\r\n(char *)&fb->pixel_format);\r\nfor (i = 0; i < n; i++) {\r\nseq_printf(m, " %d: offset=%d pitch=%d, obj: ",\r\ni, fb->offsets[i], fb->pitches[i]);\r\ndrm_gem_cma_describe(fb_cma->obj[i], m);\r\n}\r\n}\r\nint drm_fb_cma_debugfs_show(struct seq_file *m, void *arg)\r\n{\r\nstruct drm_info_node *node = (struct drm_info_node *) m->private;\r\nstruct drm_device *dev = node->minor->dev;\r\nstruct drm_framebuffer *fb;\r\nmutex_lock(&dev->mode_config.fb_lock);\r\ndrm_for_each_fb(fb, dev)\r\ndrm_fb_cma_describe(fb, m);\r\nmutex_unlock(&dev->mode_config.fb_lock);\r\nreturn 0;\r\n}\r\nstatic int drm_fb_cma_mmap(struct fb_info *info, struct vm_area_struct *vma)\r\n{\r\nreturn dma_mmap_writecombine(info->device, vma, info->screen_base,\r\ninfo->fix.smem_start, info->fix.smem_len);\r\n}\r\nstatic int drm_fbdev_cma_deferred_io_mmap(struct fb_info *info,\r\nstruct vm_area_struct *vma)\r\n{\r\nfb_deferred_io_mmap(info, vma);\r\nvma->vm_page_prot = pgprot_writecombine(vma->vm_page_prot);\r\nreturn 0;\r\n}\r\nstatic int drm_fbdev_cma_defio_init(struct fb_info *fbi,\r\nstruct drm_gem_cma_object *cma_obj)\r\n{\r\nstruct fb_deferred_io *fbdefio;\r\nstruct fb_ops *fbops;\r\nfbdefio = kzalloc(sizeof(*fbdefio), GFP_KERNEL);\r\nfbops = kzalloc(sizeof(*fbops), GFP_KERNEL);\r\nif (!fbdefio || !fbops) {\r\nkfree(fbdefio);\r\nkfree(fbops);\r\nreturn -ENOMEM;\r\n}\r\nfbi->screen_buffer = cma_obj->vaddr;\r\nfbi->fix.smem_start = page_to_phys(virt_to_page(fbi->screen_buffer));\r\n*fbops = *fbi->fbops;\r\nfbi->fbops = fbops;\r\nfbdefio->delay = msecs_to_jiffies(DEFAULT_FBDEFIO_DELAY_MS);\r\nfbdefio->deferred_io = drm_fb_helper_deferred_io;\r\nfbi->fbdefio = fbdefio;\r\nfb_deferred_io_init(fbi);\r\nfbi->fbops->fb_mmap = drm_fbdev_cma_deferred_io_mmap;\r\nreturn 0;\r\n}\r\nstatic void drm_fbdev_cma_defio_fini(struct fb_info *fbi)\r\n{\r\nif (!fbi->fbdefio)\r\nreturn;\r\nfb_deferred_io_cleanup(fbi);\r\nkfree(fbi->fbdefio);\r\nkfree(fbi->fbops);\r\n}\r\nint drm_fbdev_cma_create_with_funcs(struct drm_fb_helper *helper,\r\nstruct drm_fb_helper_surface_size *sizes,\r\nconst struct drm_framebuffer_funcs *funcs)\r\n{\r\nstruct drm_fbdev_cma *fbdev_cma = to_fbdev_cma(helper);\r\nstruct drm_mode_fb_cmd2 mode_cmd = { 0 };\r\nstruct drm_device *dev = helper->dev;\r\nstruct drm_gem_cma_object *obj;\r\nstruct drm_framebuffer *fb;\r\nunsigned int bytes_per_pixel;\r\nunsigned long offset;\r\nstruct fb_info *fbi;\r\nsize_t size;\r\nint ret;\r\nDRM_DEBUG_KMS("surface width(%d), height(%d) and bpp(%d)\n",\r\nsizes->surface_width, sizes->surface_height,\r\nsizes->surface_bpp);\r\nbytes_per_pixel = DIV_ROUND_UP(sizes->surface_bpp, 8);\r\nmode_cmd.width = sizes->surface_width;\r\nmode_cmd.height = sizes->surface_height;\r\nmode_cmd.pitches[0] = sizes->surface_width * bytes_per_pixel;\r\nmode_cmd.pixel_format = drm_mode_legacy_fb_format(sizes->surface_bpp,\r\nsizes->surface_depth);\r\nsize = mode_cmd.pitches[0] * mode_cmd.height;\r\nobj = drm_gem_cma_create(dev, size);\r\nif (IS_ERR(obj))\r\nreturn -ENOMEM;\r\nfbi = drm_fb_helper_alloc_fbi(helper);\r\nif (IS_ERR(fbi)) {\r\nret = PTR_ERR(fbi);\r\ngoto err_gem_free_object;\r\n}\r\nfbdev_cma->fb = drm_fb_cma_alloc(dev, &mode_cmd, &obj, 1, funcs);\r\nif (IS_ERR(fbdev_cma->fb)) {\r\ndev_err(dev->dev, "Failed to allocate DRM framebuffer.\n");\r\nret = PTR_ERR(fbdev_cma->fb);\r\ngoto err_fb_info_destroy;\r\n}\r\nfb = &fbdev_cma->fb->fb;\r\nhelper->fb = fb;\r\nfbi->par = helper;\r\nfbi->flags = FBINFO_FLAG_DEFAULT;\r\nfbi->fbops = &drm_fbdev_cma_ops;\r\ndrm_fb_helper_fill_fix(fbi, fb->pitches[0], fb->depth);\r\ndrm_fb_helper_fill_var(fbi, helper, sizes->fb_width, sizes->fb_height);\r\noffset = fbi->var.xoffset * bytes_per_pixel;\r\noffset += fbi->var.yoffset * fb->pitches[0];\r\ndev->mode_config.fb_base = (resource_size_t)obj->paddr;\r\nfbi->screen_base = obj->vaddr + offset;\r\nfbi->fix.smem_start = (unsigned long)(obj->paddr + offset);\r\nfbi->screen_size = size;\r\nfbi->fix.smem_len = size;\r\nif (funcs->dirty) {\r\nret = drm_fbdev_cma_defio_init(fbi, obj);\r\nif (ret)\r\ngoto err_cma_destroy;\r\n}\r\nreturn 0;\r\nerr_cma_destroy:\r\ndrm_framebuffer_unregister_private(&fbdev_cma->fb->fb);\r\ndrm_fb_cma_destroy(&fbdev_cma->fb->fb);\r\nerr_fb_info_destroy:\r\ndrm_fb_helper_release_fbi(helper);\r\nerr_gem_free_object:\r\ndrm_gem_object_unreference_unlocked(&obj->base);\r\nreturn ret;\r\n}\r\nstatic int drm_fbdev_cma_create(struct drm_fb_helper *helper,\r\nstruct drm_fb_helper_surface_size *sizes)\r\n{\r\nreturn drm_fbdev_cma_create_with_funcs(helper, sizes, &drm_fb_cma_funcs);\r\n}\r\nstruct drm_fbdev_cma *drm_fbdev_cma_init_with_funcs(struct drm_device *dev,\r\nunsigned int preferred_bpp, unsigned int num_crtc,\r\nunsigned int max_conn_count, const struct drm_fb_helper_funcs *funcs)\r\n{\r\nstruct drm_fbdev_cma *fbdev_cma;\r\nstruct drm_fb_helper *helper;\r\nint ret;\r\nfbdev_cma = kzalloc(sizeof(*fbdev_cma), GFP_KERNEL);\r\nif (!fbdev_cma) {\r\ndev_err(dev->dev, "Failed to allocate drm fbdev.\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nhelper = &fbdev_cma->fb_helper;\r\ndrm_fb_helper_prepare(dev, helper, funcs);\r\nret = drm_fb_helper_init(dev, helper, num_crtc, max_conn_count);\r\nif (ret < 0) {\r\ndev_err(dev->dev, "Failed to initialize drm fb helper.\n");\r\ngoto err_free;\r\n}\r\nret = drm_fb_helper_single_add_all_connectors(helper);\r\nif (ret < 0) {\r\ndev_err(dev->dev, "Failed to add connectors.\n");\r\ngoto err_drm_fb_helper_fini;\r\n}\r\nret = drm_fb_helper_initial_config(helper, preferred_bpp);\r\nif (ret < 0) {\r\ndev_err(dev->dev, "Failed to set initial hw configuration.\n");\r\ngoto err_drm_fb_helper_fini;\r\n}\r\nreturn fbdev_cma;\r\nerr_drm_fb_helper_fini:\r\ndrm_fb_helper_fini(helper);\r\nerr_free:\r\nkfree(fbdev_cma);\r\nreturn ERR_PTR(ret);\r\n}\r\nstruct drm_fbdev_cma *drm_fbdev_cma_init(struct drm_device *dev,\r\nunsigned int preferred_bpp, unsigned int num_crtc,\r\nunsigned int max_conn_count)\r\n{\r\nreturn drm_fbdev_cma_init_with_funcs(dev, preferred_bpp, num_crtc,\r\nmax_conn_count, &drm_fb_cma_helper_funcs);\r\n}\r\nvoid drm_fbdev_cma_fini(struct drm_fbdev_cma *fbdev_cma)\r\n{\r\ndrm_fb_helper_unregister_fbi(&fbdev_cma->fb_helper);\r\ndrm_fbdev_cma_defio_fini(fbdev_cma->fb_helper.fbdev);\r\ndrm_fb_helper_release_fbi(&fbdev_cma->fb_helper);\r\nif (fbdev_cma->fb) {\r\ndrm_framebuffer_unregister_private(&fbdev_cma->fb->fb);\r\ndrm_fb_cma_destroy(&fbdev_cma->fb->fb);\r\n}\r\ndrm_fb_helper_fini(&fbdev_cma->fb_helper);\r\nkfree(fbdev_cma);\r\n}\r\nvoid drm_fbdev_cma_restore_mode(struct drm_fbdev_cma *fbdev_cma)\r\n{\r\nif (fbdev_cma)\r\ndrm_fb_helper_restore_fbdev_mode_unlocked(&fbdev_cma->fb_helper);\r\n}\r\nvoid drm_fbdev_cma_hotplug_event(struct drm_fbdev_cma *fbdev_cma)\r\n{\r\nif (fbdev_cma)\r\ndrm_fb_helper_hotplug_event(&fbdev_cma->fb_helper);\r\n}\r\nvoid drm_fbdev_cma_set_suspend(struct drm_fbdev_cma *fbdev_cma, int state)\r\n{\r\nif (fbdev_cma)\r\ndrm_fb_helper_set_suspend(&fbdev_cma->fb_helper, state);\r\n}

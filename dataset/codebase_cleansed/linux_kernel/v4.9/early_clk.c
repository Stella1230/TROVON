u32 pic32_get_sysclk(void)\r\n{\r\nu32 osc_freq = 0;\r\nu32 pllclk;\r\nu32 frcdivn;\r\nu32 osccon;\r\nu32 spllcon;\r\nint curr_osc;\r\nu32 plliclk;\r\nu32 pllidiv;\r\nu32 pllodiv;\r\nu32 pllmult;\r\nu32 frcdiv;\r\nvoid __iomem *osc_base = ioremap(PIC32_BASE_OSC, 0x200);\r\nosccon = __raw_readl(osc_base + OSCCON);\r\nspllcon = __raw_readl(osc_base + SPLLCON);\r\nplliclk = (spllcon & ICLK_MASK);\r\npllidiv = ((spllcon >> 8) & PLLDIV_MASK) + 1;\r\npllodiv = ((spllcon >> 24) & PLLDIV_MASK);\r\npllmult = ((spllcon >> 16) & PLLMUL_MASK) + 1;\r\nfrcdiv = ((osccon >> 24) & PLLDIV_MASK);\r\npllclk = plliclk ? FRC_CLK : PIC32_POSC_FREQ;\r\nfrcdivn = ((1 << frcdiv) + 1) + (128 * (frcdiv == 7));\r\nif (pllodiv < 2)\r\npllodiv = 2;\r\nelse if (pllodiv < 5)\r\npllodiv = (1 << pllodiv);\r\nelse\r\npllodiv = 32;\r\ncurr_osc = (int)((osccon >> 12) & CUROSC_MASK);\r\nswitch (curr_osc) {\r\ncase FRC1:\r\ncase FRC2:\r\nosc_freq = FRC_CLK / frcdivn;\r\nbreak;\r\ncase SPLL:\r\nosc_freq = ((pllclk / pllidiv) * pllmult) / pllodiv;\r\nbreak;\r\ncase POSC:\r\nosc_freq = PIC32_POSC_FREQ;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\niounmap(osc_base);\r\nreturn osc_freq;\r\n}\r\nu32 pic32_get_pbclk(int bus)\r\n{\r\nu32 clk_freq;\r\nvoid __iomem *osc_base = ioremap(PIC32_BASE_OSC, 0x200);\r\nu32 pbxdiv = PB1DIV + ((bus - 1) * 0x10);\r\nu32 pbdiv = (__raw_readl(osc_base + pbxdiv) & PB_MASK) + 1;\r\niounmap(osc_base);\r\nclk_freq = pic32_get_sysclk();\r\nreturn clk_freq / pbdiv;\r\n}

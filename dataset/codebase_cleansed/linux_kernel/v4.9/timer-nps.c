static cycle_t nps_clksrc_read(struct clocksource *clksrc)\r\n{\r\nint cluster = raw_smp_processor_id() >> NPS_CLUSTER_OFFSET;\r\nreturn (cycle_t)ioread32be(nps_msu_reg_low_addr[cluster]);\r\n}\r\nstatic int __init nps_setup_clocksource(struct device_node *node,\r\nstruct clk *clk)\r\n{\r\nint ret, cluster;\r\nfor (cluster = 0; cluster < NPS_CLUSTER_NUM; cluster++)\r\nnps_msu_reg_low_addr[cluster] =\r\nnps_host_reg((cluster << NPS_CLUSTER_OFFSET),\r\nNPS_MSU_BLKID, NPS_MSU_TICK_LOW);\r\nret = clk_prepare_enable(clk);\r\nif (ret) {\r\npr_err("Couldn't enable parent clock\n");\r\nreturn ret;\r\n}\r\nnps_timer_rate = clk_get_rate(clk);\r\nret = clocksource_mmio_init(nps_msu_reg_low_addr, "EZnps-tick",\r\nnps_timer_rate, 301, 32, nps_clksrc_read);\r\nif (ret) {\r\npr_err("Couldn't register clock source.\n");\r\nclk_disable_unprepare(clk);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init nps_timer_init(struct device_node *node)\r\n{\r\nstruct clk *clk;\r\nclk = of_clk_get(node, 0);\r\nif (IS_ERR(clk)) {\r\npr_err("Can't get timer clock.\n");\r\nreturn PTR_ERR(clk);\r\n}\r\nreturn nps_setup_clocksource(node, clk);\r\n}

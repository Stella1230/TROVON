static int sun4i_i2s_get_bclk_div(struct sun4i_i2s *i2s,\r\nunsigned int oversample_rate,\r\nunsigned int word_size)\r\n{\r\nint div = oversample_rate / word_size / 2;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(sun4i_i2s_bclk_div); i++) {\r\nconst struct sun4i_i2s_clk_div *bdiv = &sun4i_i2s_bclk_div[i];\r\nif (bdiv->div == div)\r\nreturn bdiv->val;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int sun4i_i2s_get_mclk_div(struct sun4i_i2s *i2s,\r\nunsigned int oversample_rate,\r\nunsigned int module_rate,\r\nunsigned int sampling_rate)\r\n{\r\nint div = module_rate / sampling_rate / oversample_rate;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(sun4i_i2s_mclk_div); i++) {\r\nconst struct sun4i_i2s_clk_div *mdiv = &sun4i_i2s_mclk_div[i];\r\nif (mdiv->div == div)\r\nreturn mdiv->val;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int sun4i_i2s_set_clk_rate(struct sun4i_i2s *i2s,\r\nunsigned int rate,\r\nunsigned int word_size)\r\n{\r\nunsigned int clk_rate;\r\nint bclk_div, mclk_div;\r\nint ret, i;\r\nswitch (rate) {\r\ncase 176400:\r\ncase 88200:\r\ncase 44100:\r\ncase 22050:\r\ncase 11025:\r\nclk_rate = 22579200;\r\nbreak;\r\ncase 192000:\r\ncase 128000:\r\ncase 96000:\r\ncase 64000:\r\ncase 48000:\r\ncase 32000:\r\ncase 24000:\r\ncase 16000:\r\ncase 12000:\r\ncase 8000:\r\nclk_rate = 24576000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret = clk_set_rate(i2s->mod_clk, clk_rate);\r\nif (ret)\r\nreturn ret;\r\nfor (i = (ARRAY_SIZE(sun4i_i2s_oversample_rates) - 1); i >= 0; i--) {\r\nunsigned int oversample_rate = sun4i_i2s_oversample_rates[i];\r\nbclk_div = sun4i_i2s_get_bclk_div(i2s, oversample_rate,\r\nword_size);\r\nmclk_div = sun4i_i2s_get_mclk_div(i2s, oversample_rate,\r\nclk_rate,\r\nrate);\r\nif ((bclk_div >= 0) && (mclk_div >= 0))\r\nbreak;\r\n}\r\nif ((bclk_div < 0) || (mclk_div < 0))\r\nreturn -EINVAL;\r\nregmap_write(i2s->regmap, SUN4I_I2S_CLK_DIV_REG,\r\nSUN4I_I2S_CLK_DIV_BCLK(bclk_div) |\r\nSUN4I_I2S_CLK_DIV_MCLK(mclk_div) |\r\nSUN4I_I2S_CLK_DIV_MCLK_EN);\r\nreturn 0;\r\n}\r\nstatic int sun4i_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct sun4i_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nint sr, wss;\r\nu32 width;\r\nif (params_channels(params) != 2)\r\nreturn -EINVAL;\r\nswitch (params_physical_width(params)) {\r\ncase 16:\r\nwidth = DMA_SLAVE_BUSWIDTH_2_BYTES;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ni2s->playback_dma_data.addr_width = width;\r\nswitch (params_width(params)) {\r\ncase 16:\r\nsr = 0;\r\nwss = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nregmap_update_bits(i2s->regmap, SUN4I_I2S_FMT0_REG,\r\nSUN4I_I2S_FMT0_WSS_MASK | SUN4I_I2S_FMT0_SR_MASK,\r\nSUN4I_I2S_FMT0_WSS(wss) | SUN4I_I2S_FMT0_SR(sr));\r\nreturn sun4i_i2s_set_clk_rate(i2s, params_rate(params),\r\nparams_width(params));\r\n}\r\nstatic int sun4i_i2s_set_fmt(struct snd_soc_dai *dai, unsigned int fmt)\r\n{\r\nstruct sun4i_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nu32 val;\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\nval = SUN4I_I2S_FMT0_FMT_I2S;\r\nbreak;\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\nval = SUN4I_I2S_FMT0_FMT_LEFT_J;\r\nbreak;\r\ncase SND_SOC_DAIFMT_RIGHT_J:\r\nval = SUN4I_I2S_FMT0_FMT_RIGHT_J;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nregmap_update_bits(i2s->regmap, SUN4I_I2S_FMT0_REG,\r\nSUN4I_I2S_FMT0_FMT_MASK,\r\nval);\r\nswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\r\ncase SND_SOC_DAIFMT_IB_IF:\r\nval = SUN4I_I2S_FMT0_BCLK_POLARITY_INVERTED |\r\nSUN4I_I2S_FMT0_LRCLK_POLARITY_INVERTED;\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_NF:\r\nval = SUN4I_I2S_FMT0_BCLK_POLARITY_INVERTED |\r\nSUN4I_I2S_FMT0_LRCLK_POLARITY_NORMAL;\r\nbreak;\r\ncase SND_SOC_DAIFMT_NB_IF:\r\nval = SUN4I_I2S_FMT0_LRCLK_POLARITY_INVERTED |\r\nSUN4I_I2S_FMT0_BCLK_POLARITY_NORMAL;\r\nbreak;\r\ncase SND_SOC_DAIFMT_NB_NF:\r\nval = SUN4I_I2S_FMT0_BCLK_POLARITY_NORMAL |\r\nSUN4I_I2S_FMT0_LRCLK_POLARITY_NORMAL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nregmap_update_bits(i2s->regmap, SUN4I_I2S_FMT0_REG,\r\nSUN4I_I2S_FMT0_BCLK_POLARITY_MASK |\r\nSUN4I_I2S_FMT0_LRCLK_POLARITY_MASK,\r\nval);\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\nval = SUN4I_I2S_CTRL_MODE_MASTER;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\nval = SUN4I_I2S_CTRL_MODE_SLAVE;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\r\nSUN4I_I2S_CTRL_MODE_MASK,\r\nval);\r\nregmap_update_bits(i2s->regmap, SUN4I_I2S_FIFO_CTRL_REG,\r\nSUN4I_I2S_FIFO_CTRL_TX_MODE_MASK |\r\nSUN4I_I2S_FIFO_CTRL_RX_MODE_MASK,\r\nSUN4I_I2S_FIFO_CTRL_TX_MODE(1) |\r\nSUN4I_I2S_FIFO_CTRL_RX_MODE(1));\r\nreturn 0;\r\n}\r\nstatic void sun4i_i2s_start_playback(struct sun4i_i2s *i2s)\r\n{\r\nregmap_update_bits(i2s->regmap, SUN4I_I2S_FIFO_CTRL_REG,\r\nSUN4I_I2S_FIFO_CTRL_FLUSH_TX,\r\nSUN4I_I2S_FIFO_CTRL_FLUSH_TX);\r\nregmap_write(i2s->regmap, SUN4I_I2S_TX_CNT_REG, 0);\r\nregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\r\nSUN4I_I2S_CTRL_TX_EN,\r\nSUN4I_I2S_CTRL_TX_EN);\r\nregmap_update_bits(i2s->regmap, SUN4I_I2S_DMA_INT_CTRL_REG,\r\nSUN4I_I2S_DMA_INT_CTRL_TX_DRQ_EN,\r\nSUN4I_I2S_DMA_INT_CTRL_TX_DRQ_EN);\r\n}\r\nstatic void sun4i_i2s_stop_playback(struct sun4i_i2s *i2s)\r\n{\r\nregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\r\nSUN4I_I2S_CTRL_TX_EN,\r\n0);\r\nregmap_update_bits(i2s->regmap, SUN4I_I2S_DMA_INT_CTRL_REG,\r\nSUN4I_I2S_DMA_INT_CTRL_TX_DRQ_EN,\r\n0);\r\n}\r\nstatic int sun4i_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct sun4i_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nsun4i_i2s_start_playback(i2s);\r\nelse\r\nreturn -EINVAL;\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nsun4i_i2s_stop_playback(i2s);\r\nelse\r\nreturn -EINVAL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sun4i_i2s_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct sun4i_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nregmap_write(i2s->regmap, SUN4I_I2S_CTRL_REG,\r\nSUN4I_I2S_CTRL_GL_EN);\r\nregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\r\nSUN4I_I2S_CTRL_SDO_EN_MASK,\r\nSUN4I_I2S_CTRL_SDO_EN(0));\r\nregmap_write(i2s->regmap, SUN4I_I2S_TX_CHAN_SEL_REG,\r\nSUN4I_I2S_TX_CHAN_SEL(2));\r\nregmap_write(i2s->regmap, SUN4I_I2S_TX_CHAN_MAP_REG,\r\nSUN4I_I2S_TX_CHAN_MAP(0, 0) | SUN4I_I2S_TX_CHAN_MAP(1, 1));\r\nreturn clk_prepare_enable(i2s->mod_clk);\r\n}\r\nstatic void sun4i_i2s_shutdown(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct sun4i_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nclk_disable_unprepare(i2s->mod_clk);\r\nregmap_update_bits(i2s->regmap, SUN4I_I2S_CTRL_REG,\r\nSUN4I_I2S_CTRL_SDO_EN_MASK, 0);\r\nregmap_write(i2s->regmap, SUN4I_I2S_CTRL_REG, 0);\r\n}\r\nstatic int sun4i_i2s_dai_probe(struct snd_soc_dai *dai)\r\n{\r\nstruct sun4i_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nsnd_soc_dai_init_dma_data(dai, &i2s->playback_dma_data, NULL);\r\nsnd_soc_dai_set_drvdata(dai, i2s);\r\nreturn 0;\r\n}\r\nstatic bool sun4i_i2s_rd_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase SUN4I_I2S_FIFO_TX_REG:\r\nreturn false;\r\ndefault:\r\nreturn true;\r\n}\r\n}\r\nstatic bool sun4i_i2s_wr_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase SUN4I_I2S_FIFO_RX_REG:\r\ncase SUN4I_I2S_FIFO_STA_REG:\r\nreturn false;\r\ndefault:\r\nreturn true;\r\n}\r\n}\r\nstatic bool sun4i_i2s_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase SUN4I_I2S_FIFO_RX_REG:\r\ncase SUN4I_I2S_INT_STA_REG:\r\ncase SUN4I_I2S_RX_CNT_REG:\r\ncase SUN4I_I2S_TX_CNT_REG:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic int sun4i_i2s_runtime_resume(struct device *dev)\r\n{\r\nstruct sun4i_i2s *i2s = dev_get_drvdata(dev);\r\nint ret;\r\nret = clk_prepare_enable(i2s->bus_clk);\r\nif (ret) {\r\ndev_err(dev, "Failed to enable bus clock\n");\r\nreturn ret;\r\n}\r\nregcache_cache_only(i2s->regmap, false);\r\nregcache_mark_dirty(i2s->regmap);\r\nret = regcache_sync(i2s->regmap);\r\nif (ret) {\r\ndev_err(dev, "Failed to sync regmap cache\n");\r\ngoto err_disable_clk;\r\n}\r\nreturn 0;\r\nerr_disable_clk:\r\nclk_disable_unprepare(i2s->bus_clk);\r\nreturn ret;\r\n}\r\nstatic int sun4i_i2s_runtime_suspend(struct device *dev)\r\n{\r\nstruct sun4i_i2s *i2s = dev_get_drvdata(dev);\r\nregcache_cache_only(i2s->regmap, true);\r\nclk_disable_unprepare(i2s->bus_clk);\r\nreturn 0;\r\n}\r\nstatic int sun4i_i2s_probe(struct platform_device *pdev)\r\n{\r\nstruct sun4i_i2s *i2s;\r\nstruct resource *res;\r\nvoid __iomem *regs;\r\nint irq, ret;\r\ni2s = devm_kzalloc(&pdev->dev, sizeof(*i2s), GFP_KERNEL);\r\nif (!i2s)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, i2s);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nregs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(regs))\r\nreturn PTR_ERR(regs);\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "Can't retrieve our interrupt\n");\r\nreturn irq;\r\n}\r\ni2s->bus_clk = devm_clk_get(&pdev->dev, "apb");\r\nif (IS_ERR(i2s->bus_clk)) {\r\ndev_err(&pdev->dev, "Can't get our bus clock\n");\r\nreturn PTR_ERR(i2s->bus_clk);\r\n}\r\ni2s->regmap = devm_regmap_init_mmio(&pdev->dev, regs,\r\n&sun4i_i2s_regmap_config);\r\nif (IS_ERR(i2s->regmap)) {\r\ndev_err(&pdev->dev, "Regmap initialisation failed\n");\r\nreturn PTR_ERR(i2s->regmap);\r\n}\r\ni2s->mod_clk = devm_clk_get(&pdev->dev, "mod");\r\nif (IS_ERR(i2s->mod_clk)) {\r\ndev_err(&pdev->dev, "Can't get our mod clock\n");\r\nreturn PTR_ERR(i2s->mod_clk);\r\n}\r\ni2s->playback_dma_data.addr = res->start + SUN4I_I2S_FIFO_TX_REG;\r\ni2s->playback_dma_data.maxburst = 4;\r\npm_runtime_enable(&pdev->dev);\r\nif (!pm_runtime_enabled(&pdev->dev)) {\r\nret = sun4i_i2s_runtime_resume(&pdev->dev);\r\nif (ret)\r\ngoto err_pm_disable;\r\n}\r\nret = devm_snd_soc_register_component(&pdev->dev,\r\n&sun4i_i2s_component,\r\n&sun4i_i2s_dai, 1);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Could not register DAI\n");\r\ngoto err_suspend;\r\n}\r\nret = snd_dmaengine_pcm_register(&pdev->dev, NULL, 0);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Could not register PCM\n");\r\ngoto err_suspend;\r\n}\r\nreturn 0;\r\nerr_suspend:\r\nif (!pm_runtime_status_suspended(&pdev->dev))\r\nsun4i_i2s_runtime_suspend(&pdev->dev);\r\nerr_pm_disable:\r\npm_runtime_disable(&pdev->dev);\r\nreturn ret;\r\n}\r\nstatic int sun4i_i2s_remove(struct platform_device *pdev)\r\n{\r\nsnd_dmaengine_pcm_unregister(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\nif (!pm_runtime_status_suspended(&pdev->dev))\r\nsun4i_i2s_runtime_suspend(&pdev->dev);\r\nreturn 0;\r\n}

static int apq8016_lpass_alloc_dma_channel(struct lpass_data *drvdata,\r\nint direction)\r\n{\r\nstruct lpass_variant *v = drvdata->variant;\r\nint chan = 0;\r\nif (direction == SNDRV_PCM_STREAM_PLAYBACK) {\r\nchan = find_first_zero_bit(&drvdata->dma_ch_bit_map,\r\nv->rdma_channels);\r\nif (chan >= v->rdma_channels)\r\nreturn -EBUSY;\r\n} else {\r\nchan = find_next_zero_bit(&drvdata->dma_ch_bit_map,\r\nv->wrdma_channel_start +\r\nv->wrdma_channels,\r\nv->wrdma_channel_start);\r\nif (chan >= v->wrdma_channel_start + v->wrdma_channels)\r\nreturn -EBUSY;\r\n}\r\nset_bit(chan, &drvdata->dma_ch_bit_map);\r\nreturn chan;\r\n}\r\nstatic int apq8016_lpass_free_dma_channel(struct lpass_data *drvdata, int chan)\r\n{\r\nclear_bit(chan, &drvdata->dma_ch_bit_map);\r\nreturn 0;\r\n}\r\nstatic int apq8016_lpass_init(struct platform_device *pdev)\r\n{\r\nstruct lpass_data *drvdata = platform_get_drvdata(pdev);\r\nstruct device *dev = &pdev->dev;\r\nint ret;\r\ndrvdata->pcnoc_mport_clk = devm_clk_get(dev, "pcnoc-mport-clk");\r\nif (IS_ERR(drvdata->pcnoc_mport_clk)) {\r\ndev_err(&pdev->dev, "%s() error getting pcnoc-mport-clk: %ld\n",\r\n__func__, PTR_ERR(drvdata->pcnoc_mport_clk));\r\nreturn PTR_ERR(drvdata->pcnoc_mport_clk);\r\n}\r\nret = clk_prepare_enable(drvdata->pcnoc_mport_clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "%s() Error enabling pcnoc-mport-clk: %d\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\ndrvdata->pcnoc_sway_clk = devm_clk_get(dev, "pcnoc-sway-clk");\r\nif (IS_ERR(drvdata->pcnoc_sway_clk)) {\r\ndev_err(&pdev->dev, "%s() error getting pcnoc-sway-clk: %ld\n",\r\n__func__, PTR_ERR(drvdata->pcnoc_sway_clk));\r\nreturn PTR_ERR(drvdata->pcnoc_sway_clk);\r\n}\r\nret = clk_prepare_enable(drvdata->pcnoc_sway_clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "%s() Error enabling pcnoc_sway_clk: %d\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int apq8016_lpass_exit(struct platform_device *pdev)\r\n{\r\nstruct lpass_data *drvdata = platform_get_drvdata(pdev);\r\nclk_disable_unprepare(drvdata->pcnoc_mport_clk);\r\nclk_disable_unprepare(drvdata->pcnoc_sway_clk);\r\nreturn 0;\r\n}

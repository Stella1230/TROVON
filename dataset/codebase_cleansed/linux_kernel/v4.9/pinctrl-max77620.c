static int max77620_pinctrl_get_groups_count(struct pinctrl_dev *pctldev)\r\n{\r\nstruct max77620_pctrl_info *mpci = pinctrl_dev_get_drvdata(pctldev);\r\nreturn mpci->num_pin_groups;\r\n}\r\nstatic const char *max77620_pinctrl_get_group_name(\r\nstruct pinctrl_dev *pctldev, unsigned int group)\r\n{\r\nstruct max77620_pctrl_info *mpci = pinctrl_dev_get_drvdata(pctldev);\r\nreturn mpci->pin_groups[group].name;\r\n}\r\nstatic int max77620_pinctrl_get_group_pins(\r\nstruct pinctrl_dev *pctldev, unsigned int group,\r\nconst unsigned int **pins, unsigned int *num_pins)\r\n{\r\nstruct max77620_pctrl_info *mpci = pinctrl_dev_get_drvdata(pctldev);\r\n*pins = mpci->pin_groups[group].pins;\r\n*num_pins = mpci->pin_groups[group].npins;\r\nreturn 0;\r\n}\r\nstatic int max77620_pinctrl_get_funcs_count(struct pinctrl_dev *pctldev)\r\n{\r\nstruct max77620_pctrl_info *mpci = pinctrl_dev_get_drvdata(pctldev);\r\nreturn mpci->num_functions;\r\n}\r\nstatic const char *max77620_pinctrl_get_func_name(struct pinctrl_dev *pctldev,\r\nunsigned int function)\r\n{\r\nstruct max77620_pctrl_info *mpci = pinctrl_dev_get_drvdata(pctldev);\r\nreturn mpci->functions[function].name;\r\n}\r\nstatic int max77620_pinctrl_get_func_groups(struct pinctrl_dev *pctldev,\r\nunsigned int function,\r\nconst char * const **groups,\r\nunsigned int * const num_groups)\r\n{\r\nstruct max77620_pctrl_info *mpci = pinctrl_dev_get_drvdata(pctldev);\r\n*groups = mpci->functions[function].groups;\r\n*num_groups = mpci->functions[function].ngroups;\r\nreturn 0;\r\n}\r\nstatic int max77620_pinctrl_enable(struct pinctrl_dev *pctldev,\r\nunsigned int function, unsigned int group)\r\n{\r\nstruct max77620_pctrl_info *mpci = pinctrl_dev_get_drvdata(pctldev);\r\nu8 val;\r\nint ret;\r\nif (function == MAX77620_PINMUX_GPIO) {\r\nval = 0;\r\n} else if (function == mpci->pin_groups[group].alt_option) {\r\nval = 1 << group;\r\n} else {\r\ndev_err(mpci->dev, "GPIO %u doesn't have function %u\n",\r\ngroup, function);\r\nreturn -EINVAL;\r\n}\r\nret = regmap_update_bits(mpci->rmap, MAX77620_REG_AME_GPIO,\r\nBIT(group), val);\r\nif (ret < 0)\r\ndev_err(mpci->dev, "REG AME GPIO update failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int max77620_pinconf_get(struct pinctrl_dev *pctldev,\r\nunsigned int pin, unsigned long *config)\r\n{\r\nstruct max77620_pctrl_info *mpci = pinctrl_dev_get_drvdata(pctldev);\r\nstruct device *dev = mpci->dev;\r\nenum pin_config_param param = pinconf_to_config_param(*config);\r\nunsigned int val;\r\nint arg = 0;\r\nint ret;\r\nswitch (param) {\r\ncase PIN_CONFIG_DRIVE_OPEN_DRAIN:\r\nif (mpci->pin_info[pin].drv_type == MAX77620_PIN_OD_DRV)\r\narg = 1;\r\nbreak;\r\ncase PIN_CONFIG_DRIVE_PUSH_PULL:\r\nif (mpci->pin_info[pin].drv_type == MAX77620_PIN_PP_DRV)\r\narg = 1;\r\nbreak;\r\ncase PIN_CONFIG_BIAS_PULL_UP:\r\nret = regmap_read(mpci->rmap, MAX77620_REG_PUE_GPIO, &val);\r\nif (ret < 0) {\r\ndev_err(dev, "Reg PUE_GPIO read failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (val & BIT(pin))\r\narg = 1;\r\nbreak;\r\ncase PIN_CONFIG_BIAS_PULL_DOWN:\r\nret = regmap_read(mpci->rmap, MAX77620_REG_PDE_GPIO, &val);\r\nif (ret < 0) {\r\ndev_err(dev, "Reg PDE_GPIO read failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (val & BIT(pin))\r\narg = 1;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "Properties not supported\n");\r\nreturn -ENOTSUPP;\r\n}\r\n*config = pinconf_to_config_packed(param, (u16)arg);\r\nreturn 0;\r\n}\r\nstatic int max77620_get_default_fps(struct max77620_pctrl_info *mpci,\r\nint addr, int *fps)\r\n{\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(mpci->rmap, addr, &val);\r\nif (ret < 0) {\r\ndev_err(mpci->dev, "Reg PUE_GPIO read failed: %d\n", ret);\r\nreturn ret;\r\n}\r\n*fps = (val & MAX77620_FPS_SRC_MASK) >> MAX77620_FPS_SRC_SHIFT;\r\nreturn 0;\r\n}\r\nstatic int max77620_set_fps_param(struct max77620_pctrl_info *mpci,\r\nint pin, int param)\r\n{\r\nstruct max77620_fps_config *fps_config = &mpci->fps_config[pin];\r\nint addr, ret;\r\nint param_val;\r\nint mask, shift;\r\nif ((pin < MAX77620_GPIO1) || (pin > MAX77620_GPIO3))\r\nreturn 0;\r\naddr = MAX77620_REG_FPS_GPIO1 + pin - 1;\r\nswitch (param) {\r\ncase MAX77620_ACTIVE_FPS_SOURCE:\r\ncase MAX77620_SUSPEND_FPS_SOURCE:\r\nmask = MAX77620_FPS_SRC_MASK;\r\nshift = MAX77620_FPS_SRC_SHIFT;\r\nparam_val = fps_config->active_fps_src;\r\nif (param == MAX77620_SUSPEND_FPS_SOURCE)\r\nparam_val = fps_config->suspend_fps_src;\r\nbreak;\r\ncase MAX77620_ACTIVE_FPS_POWER_ON_SLOTS:\r\ncase MAX77620_SUSPEND_FPS_POWER_ON_SLOTS:\r\nmask = MAX77620_FPS_PU_PERIOD_MASK;\r\nshift = MAX77620_FPS_PU_PERIOD_SHIFT;\r\nparam_val = fps_config->active_power_up_slots;\r\nif (param == MAX77620_SUSPEND_FPS_POWER_ON_SLOTS)\r\nparam_val = fps_config->suspend_power_up_slots;\r\nbreak;\r\ncase MAX77620_ACTIVE_FPS_POWER_DOWN_SLOTS:\r\ncase MAX77620_SUSPEND_FPS_POWER_DOWN_SLOTS:\r\nmask = MAX77620_FPS_PD_PERIOD_MASK;\r\nshift = MAX77620_FPS_PD_PERIOD_SHIFT;\r\nparam_val = fps_config->active_power_down_slots;\r\nif (param == MAX77620_SUSPEND_FPS_POWER_DOWN_SLOTS)\r\nparam_val = fps_config->suspend_power_down_slots;\r\nbreak;\r\ndefault:\r\ndev_err(mpci->dev, "Invalid parameter %d for pin %d\n",\r\nparam, pin);\r\nreturn -EINVAL;\r\n}\r\nif (param_val < 0)\r\nreturn 0;\r\nret = regmap_update_bits(mpci->rmap, addr, mask, param_val << shift);\r\nif (ret < 0)\r\ndev_err(mpci->dev, "Reg 0x%02x update failed %d\n", addr, ret);\r\nreturn ret;\r\n}\r\nstatic int max77620_pinconf_set(struct pinctrl_dev *pctldev,\r\nunsigned int pin, unsigned long *configs,\r\nunsigned int num_configs)\r\n{\r\nstruct max77620_pctrl_info *mpci = pinctrl_dev_get_drvdata(pctldev);\r\nstruct device *dev = mpci->dev;\r\nstruct max77620_fps_config *fps_config;\r\nint param;\r\nu16 param_val;\r\nunsigned int val;\r\nunsigned int pu_val;\r\nunsigned int pd_val;\r\nint addr, ret;\r\nint i;\r\nfor (i = 0; i < num_configs; i++) {\r\nparam = pinconf_to_config_param(configs[i]);\r\nparam_val = pinconf_to_config_argument(configs[i]);\r\nswitch (param) {\r\ncase PIN_CONFIG_DRIVE_OPEN_DRAIN:\r\nval = param_val ? 0 : 1;\r\nret = regmap_update_bits(mpci->rmap,\r\nMAX77620_REG_GPIO0 + pin,\r\nMAX77620_CNFG_GPIO_DRV_MASK,\r\nval);\r\nif (ret < 0) {\r\ndev_err(dev, "Reg 0x%02x update failed %d\n",\r\nMAX77620_REG_GPIO0 + pin, ret);\r\nreturn ret;\r\n}\r\nmpci->pin_info[pin].drv_type = val ?\r\nMAX77620_PIN_PP_DRV : MAX77620_PIN_OD_DRV;\r\nbreak;\r\ncase PIN_CONFIG_DRIVE_PUSH_PULL:\r\nval = param_val ? 1 : 0;\r\nret = regmap_update_bits(mpci->rmap,\r\nMAX77620_REG_GPIO0 + pin,\r\nMAX77620_CNFG_GPIO_DRV_MASK,\r\nval);\r\nif (ret < 0) {\r\ndev_err(dev, "Reg 0x%02x update failed %d\n",\r\nMAX77620_REG_GPIO0 + pin, ret);\r\nreturn ret;\r\n}\r\nmpci->pin_info[pin].drv_type = val ?\r\nMAX77620_PIN_PP_DRV : MAX77620_PIN_OD_DRV;\r\nbreak;\r\ncase MAX77620_ACTIVE_FPS_SOURCE:\r\ncase MAX77620_ACTIVE_FPS_POWER_ON_SLOTS:\r\ncase MAX77620_ACTIVE_FPS_POWER_DOWN_SLOTS:\r\nif ((pin < MAX77620_GPIO1) || (pin > MAX77620_GPIO3))\r\nreturn -EINVAL;\r\nfps_config = &mpci->fps_config[pin];\r\nif ((param == MAX77620_ACTIVE_FPS_SOURCE) &&\r\n(param_val == MAX77620_FPS_SRC_DEF)) {\r\naddr = MAX77620_REG_FPS_GPIO1 + pin - 1;\r\nret = max77620_get_default_fps(\r\nmpci, addr,\r\n&fps_config->active_fps_src);\r\nif (ret < 0)\r\nreturn ret;\r\nbreak;\r\n}\r\nif (param == MAX77620_ACTIVE_FPS_SOURCE)\r\nfps_config->active_fps_src = param_val;\r\nelse if (param == MAX77620_ACTIVE_FPS_POWER_ON_SLOTS)\r\nfps_config->active_power_up_slots = param_val;\r\nelse\r\nfps_config->active_power_down_slots = param_val;\r\nret = max77620_set_fps_param(mpci, pin, param);\r\nif (ret < 0)\r\nreturn ret;\r\nbreak;\r\ncase MAX77620_SUSPEND_FPS_SOURCE:\r\ncase MAX77620_SUSPEND_FPS_POWER_ON_SLOTS:\r\ncase MAX77620_SUSPEND_FPS_POWER_DOWN_SLOTS:\r\nif ((pin < MAX77620_GPIO1) || (pin > MAX77620_GPIO3))\r\nreturn -EINVAL;\r\nfps_config = &mpci->fps_config[pin];\r\nif ((param == MAX77620_SUSPEND_FPS_SOURCE) &&\r\n(param_val == MAX77620_FPS_SRC_DEF)) {\r\naddr = MAX77620_REG_FPS_GPIO1 + pin - 1;\r\nret = max77620_get_default_fps(\r\nmpci, addr,\r\n&fps_config->suspend_fps_src);\r\nif (ret < 0)\r\nreturn ret;\r\nbreak;\r\n}\r\nif (param == MAX77620_SUSPEND_FPS_SOURCE)\r\nfps_config->suspend_fps_src = param_val;\r\nelse if (param == MAX77620_SUSPEND_FPS_POWER_ON_SLOTS)\r\nfps_config->suspend_power_up_slots = param_val;\r\nelse\r\nfps_config->suspend_power_down_slots =\r\nparam_val;\r\nbreak;\r\ncase PIN_CONFIG_BIAS_PULL_UP:\r\ncase PIN_CONFIG_BIAS_PULL_DOWN:\r\npu_val = (param == PIN_CONFIG_BIAS_PULL_UP) ?\r\nBIT(pin) : 0;\r\npd_val = (param == PIN_CONFIG_BIAS_PULL_DOWN) ?\r\nBIT(pin) : 0;\r\nret = regmap_update_bits(mpci->rmap,\r\nMAX77620_REG_PUE_GPIO,\r\nBIT(pin), pu_val);\r\nif (ret < 0) {\r\ndev_err(dev, "PUE_GPIO update failed: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = regmap_update_bits(mpci->rmap,\r\nMAX77620_REG_PDE_GPIO,\r\nBIT(pin), pd_val);\r\nif (ret < 0) {\r\ndev_err(dev, "PDE_GPIO update failed: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nbreak;\r\ndefault:\r\ndev_err(dev, "Properties not supported\n");\r\nreturn -ENOTSUPP;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77620_pinctrl_probe(struct platform_device *pdev)\r\n{\r\nstruct max77620_chip *max77620 = dev_get_drvdata(pdev->dev.parent);\r\nstruct max77620_pctrl_info *mpci;\r\nint i;\r\nmpci = devm_kzalloc(&pdev->dev, sizeof(*mpci), GFP_KERNEL);\r\nif (!mpci)\r\nreturn -ENOMEM;\r\nmpci->dev = &pdev->dev;\r\nmpci->dev->of_node = pdev->dev.parent->of_node;\r\nmpci->rmap = max77620->rmap;\r\nmpci->pins = max77620_pins_desc;\r\nmpci->num_pins = ARRAY_SIZE(max77620_pins_desc);\r\nmpci->functions = max77620_pin_function;\r\nmpci->num_functions = ARRAY_SIZE(max77620_pin_function);\r\nmpci->pin_groups = max77620_pingroups;\r\nmpci->num_pin_groups = ARRAY_SIZE(max77620_pingroups);\r\nplatform_set_drvdata(pdev, mpci);\r\nmax77620_pinctrl_desc.name = dev_name(&pdev->dev);\r\nmax77620_pinctrl_desc.pins = max77620_pins_desc;\r\nmax77620_pinctrl_desc.npins = ARRAY_SIZE(max77620_pins_desc);\r\nmax77620_pinctrl_desc.num_custom_params =\r\nARRAY_SIZE(max77620_cfg_params);\r\nmax77620_pinctrl_desc.custom_params = max77620_cfg_params;\r\nfor (i = 0; i < MAX77620_PIN_NUM; ++i) {\r\nmpci->fps_config[i].active_fps_src = -1;\r\nmpci->fps_config[i].active_power_up_slots = -1;\r\nmpci->fps_config[i].active_power_down_slots = -1;\r\nmpci->fps_config[i].suspend_fps_src = -1;\r\nmpci->fps_config[i].suspend_power_up_slots = -1;\r\nmpci->fps_config[i].suspend_power_down_slots = -1;\r\n}\r\nmpci->pctl = devm_pinctrl_register(&pdev->dev, &max77620_pinctrl_desc,\r\nmpci);\r\nif (IS_ERR(mpci->pctl)) {\r\ndev_err(&pdev->dev, "Couldn't register pinctrl driver\n");\r\nreturn PTR_ERR(mpci->pctl);\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77620_pinctrl_suspend(struct device *dev)\r\n{\r\nstruct max77620_pctrl_info *mpci = dev_get_drvdata(dev);\r\nint pin, p;\r\nfor (pin = 0; pin < MAX77620_PIN_NUM; ++pin) {\r\nif ((pin < MAX77620_GPIO1) || (pin > MAX77620_GPIO3))\r\ncontinue;\r\nfor (p = 0; p < 3; ++p)\r\nmax77620_set_fps_param(\r\nmpci, pin, max77620_suspend_fps_param[p]);\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77620_pinctrl_resume(struct device *dev)\r\n{\r\nstruct max77620_pctrl_info *mpci = dev_get_drvdata(dev);\r\nint pin, p;\r\nfor (pin = 0; pin < MAX77620_PIN_NUM; ++pin) {\r\nif ((pin < MAX77620_GPIO1) || (pin > MAX77620_GPIO3))\r\ncontinue;\r\nfor (p = 0; p < 3; ++p)\r\nmax77620_set_fps_param(\r\nmpci, pin, max77620_active_fps_param[p]);\r\n}\r\nreturn 0;\r\n}

static u16 d11n_sb(enum brcmu_chan_sb sb)\r\n{\r\nswitch (sb) {\r\ncase BRCMU_CHAN_SB_NONE:\r\nreturn BRCMU_CHSPEC_D11N_SB_N;\r\ncase BRCMU_CHAN_SB_L:\r\nreturn BRCMU_CHSPEC_D11N_SB_L;\r\ncase BRCMU_CHAN_SB_U:\r\nreturn BRCMU_CHSPEC_D11N_SB_U;\r\ndefault:\r\nWARN_ON(1);\r\n}\r\nreturn 0;\r\n}\r\nstatic u16 d11n_bw(enum brcmu_chan_bw bw)\r\n{\r\nswitch (bw) {\r\ncase BRCMU_CHAN_BW_20:\r\nreturn BRCMU_CHSPEC_D11N_BW_20;\r\ncase BRCMU_CHAN_BW_40:\r\nreturn BRCMU_CHSPEC_D11N_BW_40;\r\ndefault:\r\nWARN_ON(1);\r\n}\r\nreturn 0;\r\n}\r\nstatic void brcmu_d11n_encchspec(struct brcmu_chan *ch)\r\n{\r\nif (ch->bw == BRCMU_CHAN_BW_20)\r\nch->sb = BRCMU_CHAN_SB_NONE;\r\nch->chspec = 0;\r\nbrcmu_maskset16(&ch->chspec, BRCMU_CHSPEC_CH_MASK,\r\nBRCMU_CHSPEC_CH_SHIFT, ch->chnum);\r\nbrcmu_maskset16(&ch->chspec, BRCMU_CHSPEC_D11N_SB_MASK,\r\n0, d11n_sb(ch->sb));\r\nbrcmu_maskset16(&ch->chspec, BRCMU_CHSPEC_D11N_BW_MASK,\r\n0, d11n_bw(ch->bw));\r\nif (ch->chnum <= CH_MAX_2G_CHANNEL)\r\nch->chspec |= BRCMU_CHSPEC_D11N_BND_2G;\r\nelse\r\nch->chspec |= BRCMU_CHSPEC_D11N_BND_5G;\r\n}\r\nstatic u16 d11ac_bw(enum brcmu_chan_bw bw)\r\n{\r\nswitch (bw) {\r\ncase BRCMU_CHAN_BW_20:\r\nreturn BRCMU_CHSPEC_D11AC_BW_20;\r\ncase BRCMU_CHAN_BW_40:\r\nreturn BRCMU_CHSPEC_D11AC_BW_40;\r\ncase BRCMU_CHAN_BW_80:\r\nreturn BRCMU_CHSPEC_D11AC_BW_80;\r\ndefault:\r\nWARN_ON(1);\r\n}\r\nreturn 0;\r\n}\r\nstatic void brcmu_d11ac_encchspec(struct brcmu_chan *ch)\r\n{\r\nif (ch->bw == BRCMU_CHAN_BW_20 || ch->sb == BRCMU_CHAN_SB_NONE)\r\nch->sb = BRCMU_CHAN_SB_L;\r\nbrcmu_maskset16(&ch->chspec, BRCMU_CHSPEC_CH_MASK,\r\nBRCMU_CHSPEC_CH_SHIFT, ch->chnum);\r\nbrcmu_maskset16(&ch->chspec, BRCMU_CHSPEC_D11AC_SB_MASK,\r\nBRCMU_CHSPEC_D11AC_SB_SHIFT, ch->sb);\r\nbrcmu_maskset16(&ch->chspec, BRCMU_CHSPEC_D11AC_BW_MASK,\r\n0, d11ac_bw(ch->bw));\r\nch->chspec &= ~BRCMU_CHSPEC_D11AC_BND_MASK;\r\nif (ch->chnum <= CH_MAX_2G_CHANNEL)\r\nch->chspec |= BRCMU_CHSPEC_D11AC_BND_2G;\r\nelse\r\nch->chspec |= BRCMU_CHSPEC_D11AC_BND_5G;\r\n}\r\nstatic void brcmu_d11n_decchspec(struct brcmu_chan *ch)\r\n{\r\nu16 val;\r\nch->chnum = (u8)(ch->chspec & BRCMU_CHSPEC_CH_MASK);\r\nch->control_ch_num = ch->chnum;\r\nswitch (ch->chspec & BRCMU_CHSPEC_D11N_BW_MASK) {\r\ncase BRCMU_CHSPEC_D11N_BW_20:\r\nch->bw = BRCMU_CHAN_BW_20;\r\nch->sb = BRCMU_CHAN_SB_NONE;\r\nbreak;\r\ncase BRCMU_CHSPEC_D11N_BW_40:\r\nch->bw = BRCMU_CHAN_BW_40;\r\nval = ch->chspec & BRCMU_CHSPEC_D11N_SB_MASK;\r\nif (val == BRCMU_CHSPEC_D11N_SB_L) {\r\nch->sb = BRCMU_CHAN_SB_L;\r\nch->control_ch_num -= CH_10MHZ_APART;\r\n} else {\r\nch->sb = BRCMU_CHAN_SB_U;\r\nch->control_ch_num += CH_10MHZ_APART;\r\n}\r\nbreak;\r\ndefault:\r\nWARN_ON_ONCE(1);\r\nbreak;\r\n}\r\nswitch (ch->chspec & BRCMU_CHSPEC_D11N_BND_MASK) {\r\ncase BRCMU_CHSPEC_D11N_BND_5G:\r\nch->band = BRCMU_CHAN_BAND_5G;\r\nbreak;\r\ncase BRCMU_CHSPEC_D11N_BND_2G:\r\nch->band = BRCMU_CHAN_BAND_2G;\r\nbreak;\r\ndefault:\r\nWARN_ON_ONCE(1);\r\nbreak;\r\n}\r\n}\r\nstatic void brcmu_d11ac_decchspec(struct brcmu_chan *ch)\r\n{\r\nu16 val;\r\nch->chnum = (u8)(ch->chspec & BRCMU_CHSPEC_CH_MASK);\r\nch->control_ch_num = ch->chnum;\r\nswitch (ch->chspec & BRCMU_CHSPEC_D11AC_BW_MASK) {\r\ncase BRCMU_CHSPEC_D11AC_BW_20:\r\nch->bw = BRCMU_CHAN_BW_20;\r\nch->sb = BRCMU_CHAN_SB_NONE;\r\nbreak;\r\ncase BRCMU_CHSPEC_D11AC_BW_40:\r\nch->bw = BRCMU_CHAN_BW_40;\r\nval = ch->chspec & BRCMU_CHSPEC_D11AC_SB_MASK;\r\nif (val == BRCMU_CHSPEC_D11AC_SB_L) {\r\nch->sb = BRCMU_CHAN_SB_L;\r\nch->control_ch_num -= CH_10MHZ_APART;\r\n} else if (val == BRCMU_CHSPEC_D11AC_SB_U) {\r\nch->sb = BRCMU_CHAN_SB_U;\r\nch->control_ch_num += CH_10MHZ_APART;\r\n} else {\r\nWARN_ON_ONCE(1);\r\n}\r\nbreak;\r\ncase BRCMU_CHSPEC_D11AC_BW_80:\r\nch->bw = BRCMU_CHAN_BW_80;\r\nch->sb = brcmu_maskget16(ch->chspec, BRCMU_CHSPEC_D11AC_SB_MASK,\r\nBRCMU_CHSPEC_D11AC_SB_SHIFT);\r\nswitch (ch->sb) {\r\ncase BRCMU_CHAN_SB_LL:\r\nch->control_ch_num -= CH_30MHZ_APART;\r\nbreak;\r\ncase BRCMU_CHAN_SB_LU:\r\nch->control_ch_num -= CH_10MHZ_APART;\r\nbreak;\r\ncase BRCMU_CHAN_SB_UL:\r\nch->control_ch_num += CH_10MHZ_APART;\r\nbreak;\r\ncase BRCMU_CHAN_SB_UU:\r\nch->control_ch_num += CH_30MHZ_APART;\r\nbreak;\r\ndefault:\r\nWARN_ON_ONCE(1);\r\nbreak;\r\n}\r\nbreak;\r\ncase BRCMU_CHSPEC_D11AC_BW_8080:\r\ncase BRCMU_CHSPEC_D11AC_BW_160:\r\ndefault:\r\nWARN_ON_ONCE(1);\r\nbreak;\r\n}\r\nswitch (ch->chspec & BRCMU_CHSPEC_D11AC_BND_MASK) {\r\ncase BRCMU_CHSPEC_D11AC_BND_5G:\r\nch->band = BRCMU_CHAN_BAND_5G;\r\nbreak;\r\ncase BRCMU_CHSPEC_D11AC_BND_2G:\r\nch->band = BRCMU_CHAN_BAND_2G;\r\nbreak;\r\ndefault:\r\nWARN_ON_ONCE(1);\r\nbreak;\r\n}\r\n}\r\nvoid brcmu_d11_attach(struct brcmu_d11inf *d11inf)\r\n{\r\nif (d11inf->io_type == BRCMU_D11N_IOTYPE) {\r\nd11inf->encchspec = brcmu_d11n_encchspec;\r\nd11inf->decchspec = brcmu_d11n_decchspec;\r\n} else {\r\nd11inf->encchspec = brcmu_d11ac_encchspec;\r\nd11inf->decchspec = brcmu_d11ac_decchspec;\r\n}\r\n}

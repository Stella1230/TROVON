static unsigned long f_extend(unsigned long address)\r\n{\r\n#ifdef CONFIG_64BIT\r\nif(unlikely(parisc_narrow_firmware)) {\r\nif((address & 0xff000000) == 0xf0000000)\r\nreturn 0xf0f0f0f000000000UL | (u32)address;\r\nif((address & 0xf0000000) == 0xf0000000)\r\nreturn 0xffffffff00000000UL | (u32)address;\r\n}\r\n#endif\r\nreturn address;\r\n}\r\nstatic void convert_to_wide(unsigned long *addr)\r\n{\r\n#ifdef CONFIG_64BIT\r\nint i;\r\nunsigned int *p = (unsigned int *)addr;\r\nif(unlikely(parisc_narrow_firmware)) {\r\nfor(i = 31; i >= 0; --i)\r\naddr[i] = p[i];\r\n}\r\n#endif\r\n}\r\nvoid set_firmware_width_unlocked(void)\r\n{\r\nint ret;\r\nret = mem_pdc_call(PDC_MODEL, PDC_MODEL_CAPABILITIES,\r\n__pa(pdc_result), 0);\r\nconvert_to_wide(pdc_result);\r\nif (pdc_result[0] != NARROW_FIRMWARE)\r\nparisc_narrow_firmware = 0;\r\n}\r\nvoid set_firmware_width(void)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nset_firmware_width_unlocked();\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\n}\r\nvoid set_firmware_width_unlocked(void)\r\n{\r\nreturn;\r\n}\r\nvoid set_firmware_width(void)\r\n{\r\nreturn;\r\n}\r\nvoid pdc_emergency_unlock(void)\r\n{\r\nif (spin_is_locked(&pdc_lock))\r\nspin_unlock(&pdc_lock);\r\n}\r\nint pdc_add_valid(unsigned long address)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_ADD_VALID, PDC_ADD_VALID_VERIFY, address);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint __init pdc_chassis_info(struct pdc_chassis_info *chassis_info, void *led_info, unsigned long len)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nmemcpy(&pdc_result, chassis_info, sizeof(*chassis_info));\r\nmemcpy(&pdc_result2, led_info, len);\r\nretval = mem_pdc_call(PDC_CHASSIS, PDC_RETURN_CHASSIS_INFO,\r\n__pa(pdc_result), __pa(pdc_result2), len);\r\nmemcpy(chassis_info, pdc_result, sizeof(*chassis_info));\r\nmemcpy(led_info, pdc_result2, len);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_pat_chassis_send_log(unsigned long state, unsigned long data)\r\n{\r\nint retval = 0;\r\nunsigned long flags;\r\nif (!is_pdc_pat())\r\nreturn -1;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_PAT_CHASSIS_LOG, PDC_PAT_CHASSIS_WRITE_LOG, __pa(&state), __pa(&data));\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_chassis_disp(unsigned long disp)\r\n{\r\nint retval = 0;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_CHASSIS, PDC_CHASSIS_DISP, disp);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_chassis_warn(unsigned long *warn)\r\n{\r\nint retval = 0;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_CHASSIS, PDC_CHASSIS_WARN, __pa(pdc_result));\r\n*warn = pdc_result[0];\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_coproc_cfg_unlocked(struct pdc_coproc_cfg *pdc_coproc_info)\r\n{\r\nint ret;\r\nret = mem_pdc_call(PDC_COPROC, PDC_COPROC_CFG, __pa(pdc_result));\r\nconvert_to_wide(pdc_result);\r\npdc_coproc_info->ccr_functional = pdc_result[0];\r\npdc_coproc_info->ccr_present = pdc_result[1];\r\npdc_coproc_info->revision = pdc_result[17];\r\npdc_coproc_info->model = pdc_result[18];\r\nreturn ret;\r\n}\r\nint pdc_coproc_cfg(struct pdc_coproc_cfg *pdc_coproc_info)\r\n{\r\nint ret;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nret = pdc_coproc_cfg_unlocked(pdc_coproc_info);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn ret;\r\n}\r\nint pdc_iodc_read(unsigned long *actcnt, unsigned long hpa, unsigned int index,\r\nvoid *iodc_data, unsigned int iodc_data_size)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_IODC, PDC_IODC_READ, __pa(pdc_result), hpa,\r\nindex, __pa(pdc_result2), iodc_data_size);\r\nconvert_to_wide(pdc_result);\r\n*actcnt = pdc_result[0];\r\nmemcpy(iodc_data, pdc_result2, iodc_data_size);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_system_map_find_mods(struct pdc_system_map_mod_info *pdc_mod_info,\r\nstruct pdc_module_path *mod_path, long mod_index)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_SYSTEM_MAP, PDC_FIND_MODULE, __pa(pdc_result),\r\n__pa(pdc_result2), mod_index);\r\nconvert_to_wide(pdc_result);\r\nmemcpy(pdc_mod_info, pdc_result, sizeof(*pdc_mod_info));\r\nmemcpy(mod_path, pdc_result2, sizeof(*mod_path));\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\npdc_mod_info->mod_addr = f_extend(pdc_mod_info->mod_addr);\r\nreturn retval;\r\n}\r\nint pdc_system_map_find_addrs(struct pdc_system_map_addr_info *pdc_addr_info,\r\nlong mod_index, long addr_index)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_SYSTEM_MAP, PDC_FIND_ADDRESS, __pa(pdc_result),\r\nmod_index, addr_index);\r\nconvert_to_wide(pdc_result);\r\nmemcpy(pdc_addr_info, pdc_result, sizeof(*pdc_addr_info));\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\npdc_addr_info->mod_addr = f_extend(pdc_addr_info->mod_addr);\r\nreturn retval;\r\n}\r\nint pdc_model_info(struct pdc_model *model)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_MODEL, PDC_MODEL_INFO, __pa(pdc_result), 0);\r\nconvert_to_wide(pdc_result);\r\nmemcpy(model, pdc_result, sizeof(*model));\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_model_sysmodel(char *name)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_MODEL, PDC_MODEL_SYSMODEL, __pa(pdc_result),\r\nOS_ID_HPUX, __pa(name));\r\nconvert_to_wide(pdc_result);\r\nif (retval == PDC_OK) {\r\nname[pdc_result[0]] = '\0';\r\n} else {\r\nname[0] = 0;\r\n}\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_model_versions(unsigned long *versions, int id)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_MODEL, PDC_MODEL_VERSIONS, __pa(pdc_result), id);\r\nconvert_to_wide(pdc_result);\r\n*versions = pdc_result[0];\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_model_cpuid(unsigned long *cpu_id)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\npdc_result[0] = 0;\r\nretval = mem_pdc_call(PDC_MODEL, PDC_MODEL_CPU_ID, __pa(pdc_result), 0);\r\nconvert_to_wide(pdc_result);\r\n*cpu_id = pdc_result[0];\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_model_capabilities(unsigned long *capabilities)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\npdc_result[0] = 0;\r\nretval = mem_pdc_call(PDC_MODEL, PDC_MODEL_CAPABILITIES, __pa(pdc_result), 0);\r\nconvert_to_wide(pdc_result);\r\nif (retval == PDC_OK) {\r\n*capabilities = pdc_result[0];\r\n} else {\r\n*capabilities = PDC_MODEL_OS32;\r\n}\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_cache_info(struct pdc_cache_info *cache_info)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_CACHE, PDC_CACHE_INFO, __pa(pdc_result), 0);\r\nconvert_to_wide(pdc_result);\r\nmemcpy(cache_info, pdc_result, sizeof(*cache_info));\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_spaceid_bits(unsigned long *space_bits)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\npdc_result[0] = 0;\r\nretval = mem_pdc_call(PDC_CACHE, PDC_CACHE_RET_SPID, __pa(pdc_result), 0);\r\nconvert_to_wide(pdc_result);\r\n*space_bits = pdc_result[0];\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_btlb_info(struct pdc_btlb_info *btlb)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_BLOCK_TLB, PDC_BTLB_INFO, __pa(pdc_result), 0);\r\nmemcpy(btlb, pdc_result, sizeof(*btlb));\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nif(retval < 0) {\r\nbtlb->max_size = 0;\r\n}\r\nreturn retval;\r\n}\r\nint pdc_mem_map_hpa(struct pdc_memory_map *address,\r\nstruct pdc_module_path *mod_path)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nmemcpy(pdc_result2, mod_path, sizeof(*mod_path));\r\nretval = mem_pdc_call(PDC_MEM_MAP, PDC_MEM_MAP_HPA, __pa(pdc_result),\r\n__pa(pdc_result2));\r\nmemcpy(address, pdc_result, sizeof(*address));\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_lan_station_id(char *lan_addr, unsigned long hpa)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_LAN_STATION_ID, PDC_LAN_STATION_ID_READ,\r\n__pa(pdc_result), hpa);\r\nif (retval < 0) {\r\nmemset(lan_addr, 0, PDC_LAN_STATION_ID_SIZE);\r\n} else {\r\nmemcpy(lan_addr, pdc_result, PDC_LAN_STATION_ID_SIZE);\r\n}\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_stable_read(unsigned long staddr, void *memaddr, unsigned long count)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_STABLE, PDC_STABLE_READ, staddr,\r\n__pa(pdc_result), count);\r\nconvert_to_wide(pdc_result);\r\nmemcpy(memaddr, pdc_result, count);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_stable_write(unsigned long staddr, void *memaddr, unsigned long count)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nmemcpy(pdc_result, memaddr, count);\r\nconvert_to_wide(pdc_result);\r\nretval = mem_pdc_call(PDC_STABLE, PDC_STABLE_WRITE, staddr,\r\n__pa(pdc_result), count);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_stable_get_size(unsigned long *size)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_STABLE, PDC_STABLE_RETURN_SIZE, __pa(pdc_result));\r\n*size = pdc_result[0];\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_stable_verify_contents(void)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_STABLE, PDC_STABLE_VERIFY_CONTENTS);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_stable_initialize(void)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_STABLE, PDC_STABLE_INITIALIZE);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_get_initiator(struct hardware_path *hwpath, struct pdc_initiator *initiator)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\n#define IS_SPROCKETS() (strlen(boot_cpu_data.pdc.sys_model_name) == 14 && \\r\nstrncmp(boot_cpu_data.pdc.sys_model_name, "9000/785", 8) == 0)\r\nretval = mem_pdc_call(PDC_INITIATOR, PDC_GET_INITIATOR,\r\n__pa(pdc_result), __pa(hwpath));\r\nif (retval < PDC_OK)\r\ngoto out;\r\nif (pdc_result[0] < 16) {\r\ninitiator->host_id = pdc_result[0];\r\n} else {\r\ninitiator->host_id = -1;\r\n}\r\nswitch (pdc_result[1]) {\r\ncase 1: initiator->factor = 50; break;\r\ncase 2: initiator->factor = 25; break;\r\ncase 5: initiator->factor = 12; break;\r\ncase 25: initiator->factor = 10; break;\r\ncase 20: initiator->factor = 12; break;\r\ncase 40: initiator->factor = 10; break;\r\ndefault: initiator->factor = -1; break;\r\n}\r\nif (IS_SPROCKETS()) {\r\ninitiator->width = pdc_result[4];\r\ninitiator->mode = pdc_result[5];\r\n} else {\r\ninitiator->width = -1;\r\ninitiator->mode = -1;\r\n}\r\nout:\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn (retval >= PDC_OK);\r\n}\r\nint pdc_pci_irt_size(unsigned long *num_entries, unsigned long hpa)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_PCI_INDEX, PDC_PCI_GET_INT_TBL_SIZE,\r\n__pa(pdc_result), hpa);\r\nconvert_to_wide(pdc_result);\r\n*num_entries = pdc_result[0];\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_pci_irt(unsigned long num_entries, unsigned long hpa, void *tbl)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nBUG_ON((unsigned long)tbl & 0x7);\r\nspin_lock_irqsave(&pdc_lock, flags);\r\npdc_result[0] = num_entries;\r\nretval = mem_pdc_call(PDC_PCI_INDEX, PDC_PCI_GET_INT_TBL,\r\n__pa(pdc_result), hpa, __pa(tbl));\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_tod_read(struct pdc_tod *tod)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_TOD, PDC_TOD_READ, __pa(pdc_result), 0);\r\nconvert_to_wide(pdc_result);\r\nmemcpy(tod, pdc_result, sizeof(*tod));\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_tod_set(unsigned long sec, unsigned long usec)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_TOD, PDC_TOD_WRITE, sec, usec);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_mem_mem_table(struct pdc_memory_table_raddr *r_addr,\r\nstruct pdc_memory_table *tbl, unsigned long entries)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_MEM, PDC_MEM_TABLE, __pa(pdc_result), __pa(pdc_result2), entries);\r\nconvert_to_wide(pdc_result);\r\nmemcpy(r_addr, pdc_result, sizeof(*r_addr));\r\nmemcpy(tbl, pdc_result2, entries * sizeof(*tbl));\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_do_firm_test_reset(unsigned long ftc_bitmap)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_BROADCAST_RESET, PDC_DO_FIRM_TEST_RESET,\r\nPDC_FIRM_TEST_MAGIC, ftc_bitmap);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_do_reset(void)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_BROADCAST_RESET, PDC_DO_RESET);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint __init pdc_soft_power_info(unsigned long *power_reg)\r\n{\r\nint retval;\r\nunsigned long flags;\r\n*power_reg = (unsigned long) (-1);\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_SOFT_POWER, PDC_SOFT_POWER_INFO, __pa(pdc_result), 0);\r\nif (retval == PDC_OK) {\r\nconvert_to_wide(pdc_result);\r\n*power_reg = f_extend(pdc_result[0]);\r\n}\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_soft_power_button(int sw_control)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_SOFT_POWER, PDC_SOFT_POWER_ENABLE, __pa(pdc_result), sw_control);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nvoid pdc_io_reset(void)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nmem_pdc_call(PDC_IO, PDC_IO_RESET, 0);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\n}\r\nvoid pdc_io_reset_devices(void)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nmem_pdc_call(PDC_IO, PDC_IO_RESET_DEVICES, 0);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\n}\r\nint pdc_iodc_print(const unsigned char *str, unsigned count)\r\n{\r\nunsigned int i;\r\nunsigned long flags;\r\nfor (i = 0; i < count;) {\r\nswitch(str[i]) {\r\ncase '\n':\r\niodc_dbuf[i+0] = '\r';\r\niodc_dbuf[i+1] = '\n';\r\ni += 2;\r\ngoto print;\r\ndefault:\r\niodc_dbuf[i] = str[i];\r\ni++;\r\nbreak;\r\n}\r\n}\r\nprint:\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nreal32_call(PAGE0->mem_cons.iodc_io,\r\n(unsigned long)PAGE0->mem_cons.hpa, ENTRY_IO_COUT,\r\nPAGE0->mem_cons.spa, __pa(PAGE0->mem_cons.dp.layers),\r\n__pa(iodc_retbuf), 0, __pa(iodc_dbuf), i, 0);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn i;\r\n}\r\nint pdc_iodc_getc(void)\r\n{\r\nint ch;\r\nint status;\r\nunsigned long flags;\r\nif (!PAGE0->mem_kbd.iodc_io)\r\nreturn 0;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nreal32_call(PAGE0->mem_kbd.iodc_io,\r\n(unsigned long)PAGE0->mem_kbd.hpa, ENTRY_IO_CIN,\r\nPAGE0->mem_kbd.spa, __pa(PAGE0->mem_kbd.dp.layers),\r\n__pa(iodc_retbuf), 0, __pa(iodc_dbuf), 1, 0);\r\nch = *iodc_dbuf;\r\nstatus = *iodc_retbuf;\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nif (status == 0)\r\nreturn -1;\r\nreturn ch;\r\n}\r\nint pdc_sti_call(unsigned long func, unsigned long flags,\r\nunsigned long inptr, unsigned long outputr,\r\nunsigned long glob_cfg)\r\n{\r\nint retval;\r\nunsigned long irqflags;\r\nspin_lock_irqsave(&pdc_lock, irqflags);\r\nretval = real32_call(func, flags, inptr, outputr, glob_cfg);\r\nspin_unlock_irqrestore(&pdc_lock, irqflags);\r\nreturn retval;\r\n}\r\nint pdc_pat_cell_get_number(struct pdc_pat_cell_num *cell_info)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_PAT_CELL, PDC_PAT_CELL_GET_NUMBER, __pa(pdc_result));\r\nmemcpy(cell_info, pdc_result, sizeof(*cell_info));\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_pat_cell_module(unsigned long *actcnt, unsigned long ploc, unsigned long mod,\r\nunsigned long view_type, void *mem_addr)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nstatic struct pdc_pat_cell_mod_maddr_block result __attribute__ ((aligned (8)));\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_PAT_CELL, PDC_PAT_CELL_MODULE, __pa(pdc_result),\r\nploc, mod, view_type, __pa(&result));\r\nif(!retval) {\r\n*actcnt = pdc_result[0];\r\nmemcpy(mem_addr, &result, *actcnt);\r\n}\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_pat_cpu_get_number(struct pdc_pat_cpu_num *cpu_info, void *hpa)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_PAT_CPU, PDC_PAT_CPU_GET_NUMBER,\r\n__pa(&pdc_result), hpa);\r\nmemcpy(cpu_info, pdc_result, sizeof(*cpu_info));\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_pat_get_irt_size(unsigned long *num_entries, unsigned long cell_num)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_PAT_IO, PDC_PAT_IO_GET_PCI_ROUTING_TABLE_SIZE,\r\n__pa(pdc_result), cell_num);\r\n*num_entries = pdc_result[0];\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_pat_get_irt(void *r_addr, unsigned long cell_num)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_PAT_IO, PDC_PAT_IO_GET_PCI_ROUTING_TABLE,\r\n__pa(r_addr), cell_num);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_pat_pd_get_addr_map(unsigned long *actual_len, void *mem_addr,\r\nunsigned long count, unsigned long offset)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_PAT_PD, PDC_PAT_PD_GET_ADDR_MAP, __pa(pdc_result),\r\n__pa(pdc_result2), count, offset);\r\n*actual_len = pdc_result[0];\r\nmemcpy(mem_addr, pdc_result2, *actual_len);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_pat_io_pci_cfg_read(unsigned long pci_addr, int pci_size, u32 *mem_addr)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_PAT_IO, PDC_PAT_IO_PCI_CONFIG_READ,\r\n__pa(pdc_result), pci_addr, pci_size);\r\nswitch(pci_size) {\r\ncase 1: *(u8 *) mem_addr = (u8) pdc_result[0]; break;\r\ncase 2: *(u16 *)mem_addr = (u16) pdc_result[0]; break;\r\ncase 4: *(u32 *)mem_addr = (u32) pdc_result[0]; break;\r\n}\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nint pdc_pat_io_pci_cfg_write(unsigned long pci_addr, int pci_size, u32 val)\r\n{\r\nint retval;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_lock, flags);\r\nretval = mem_pdc_call(PDC_PAT_IO, PDC_PAT_IO_PCI_CONFIG_WRITE,\r\npci_addr, pci_size, val);\r\nspin_unlock_irqrestore(&pdc_lock, flags);\r\nreturn retval;\r\n}\r\nlong real32_call(unsigned long fn, ...)\r\n{\r\nva_list args;\r\nextern struct narrow_stack real_stack;\r\nextern unsigned long real32_call_asm(unsigned int *,\r\nunsigned int *,\r\nunsigned int);\r\nva_start(args, fn);\r\nreal_stack.arg0 = va_arg(args, unsigned int);\r\nreal_stack.arg1 = va_arg(args, unsigned int);\r\nreal_stack.arg2 = va_arg(args, unsigned int);\r\nreal_stack.arg3 = va_arg(args, unsigned int);\r\nreal_stack.arg4 = va_arg(args, unsigned int);\r\nreal_stack.arg5 = va_arg(args, unsigned int);\r\nreal_stack.arg6 = va_arg(args, unsigned int);\r\nreal_stack.arg7 = va_arg(args, unsigned int);\r\nreal_stack.arg8 = va_arg(args, unsigned int);\r\nreal_stack.arg9 = va_arg(args, unsigned int);\r\nreal_stack.arg10 = va_arg(args, unsigned int);\r\nreal_stack.arg11 = va_arg(args, unsigned int);\r\nreal_stack.arg12 = va_arg(args, unsigned int);\r\nreal_stack.arg13 = va_arg(args, unsigned int);\r\nva_end(args);\r\nreturn real32_call_asm(&real_stack.sp, &real_stack.arg0, fn);\r\n}\r\nlong real64_call(unsigned long fn, ...)\r\n{\r\nva_list args;\r\nextern struct wide_stack real64_stack;\r\nextern unsigned long real64_call_asm(unsigned long *,\r\nunsigned long *,\r\nunsigned long);\r\nva_start(args, fn);\r\nreal64_stack.arg0 = va_arg(args, unsigned long);\r\nreal64_stack.arg1 = va_arg(args, unsigned long);\r\nreal64_stack.arg2 = va_arg(args, unsigned long);\r\nreal64_stack.arg3 = va_arg(args, unsigned long);\r\nreal64_stack.arg4 = va_arg(args, unsigned long);\r\nreal64_stack.arg5 = va_arg(args, unsigned long);\r\nreal64_stack.arg6 = va_arg(args, unsigned long);\r\nreal64_stack.arg7 = va_arg(args, unsigned long);\r\nreal64_stack.arg8 = va_arg(args, unsigned long);\r\nreal64_stack.arg9 = va_arg(args, unsigned long);\r\nreal64_stack.arg10 = va_arg(args, unsigned long);\r\nreal64_stack.arg11 = va_arg(args, unsigned long);\r\nreal64_stack.arg12 = va_arg(args, unsigned long);\r\nreal64_stack.arg13 = va_arg(args, unsigned long);\r\nva_end(args);\r\nreturn real64_call_asm(&real64_stack.sp, &real64_stack.arg0, fn);\r\n}

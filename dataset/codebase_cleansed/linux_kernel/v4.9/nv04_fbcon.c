int\r\nnv04_fbcon_copyarea(struct fb_info *info, const struct fb_copyarea *region)\r\n{\r\nstruct nouveau_fbdev *nfbdev = info->par;\r\nstruct nouveau_drm *drm = nouveau_drm(nfbdev->dev);\r\nstruct nouveau_channel *chan = drm->channel;\r\nint ret;\r\nret = RING_SPACE(chan, 4);\r\nif (ret)\r\nreturn ret;\r\nBEGIN_NV04(chan, NvSubImageBlit, 0x0300, 3);\r\nOUT_RING(chan, (region->sy << 16) | region->sx);\r\nOUT_RING(chan, (region->dy << 16) | region->dx);\r\nOUT_RING(chan, (region->height << 16) | region->width);\r\nFIRE_RING(chan);\r\nreturn 0;\r\n}\r\nint\r\nnv04_fbcon_fillrect(struct fb_info *info, const struct fb_fillrect *rect)\r\n{\r\nstruct nouveau_fbdev *nfbdev = info->par;\r\nstruct nouveau_drm *drm = nouveau_drm(nfbdev->dev);\r\nstruct nouveau_channel *chan = drm->channel;\r\nint ret;\r\nret = RING_SPACE(chan, 7);\r\nif (ret)\r\nreturn ret;\r\nBEGIN_NV04(chan, NvSubGdiRect, 0x02fc, 1);\r\nOUT_RING(chan, (rect->rop != ROP_COPY) ? 1 : 3);\r\nBEGIN_NV04(chan, NvSubGdiRect, 0x03fc, 1);\r\nif (info->fix.visual == FB_VISUAL_TRUECOLOR ||\r\ninfo->fix.visual == FB_VISUAL_DIRECTCOLOR)\r\nOUT_RING(chan, ((uint32_t *)info->pseudo_palette)[rect->color]);\r\nelse\r\nOUT_RING(chan, rect->color);\r\nBEGIN_NV04(chan, NvSubGdiRect, 0x0400, 2);\r\nOUT_RING(chan, (rect->dx << 16) | rect->dy);\r\nOUT_RING(chan, (rect->width << 16) | rect->height);\r\nFIRE_RING(chan);\r\nreturn 0;\r\n}\r\nint\r\nnv04_fbcon_imageblit(struct fb_info *info, const struct fb_image *image)\r\n{\r\nstruct nouveau_fbdev *nfbdev = info->par;\r\nstruct nouveau_drm *drm = nouveau_drm(nfbdev->dev);\r\nstruct nouveau_channel *chan = drm->channel;\r\nuint32_t fg;\r\nuint32_t bg;\r\nuint32_t dsize;\r\nuint32_t *data = (uint32_t *)image->data;\r\nint ret;\r\nif (image->depth != 1)\r\nreturn -ENODEV;\r\nret = RING_SPACE(chan, 8);\r\nif (ret)\r\nreturn ret;\r\nif (info->fix.visual == FB_VISUAL_TRUECOLOR ||\r\ninfo->fix.visual == FB_VISUAL_DIRECTCOLOR) {\r\nfg = ((uint32_t *) info->pseudo_palette)[image->fg_color];\r\nbg = ((uint32_t *) info->pseudo_palette)[image->bg_color];\r\n} else {\r\nfg = image->fg_color;\r\nbg = image->bg_color;\r\n}\r\nBEGIN_NV04(chan, NvSubGdiRect, 0x0be4, 7);\r\nOUT_RING(chan, (image->dy << 16) | (image->dx & 0xffff));\r\nOUT_RING(chan, ((image->dy + image->height) << 16) |\r\n((image->dx + image->width) & 0xffff));\r\nOUT_RING(chan, bg);\r\nOUT_RING(chan, fg);\r\nOUT_RING(chan, (image->height << 16) | ALIGN(image->width, 8));\r\nOUT_RING(chan, (image->height << 16) | image->width);\r\nOUT_RING(chan, (image->dy << 16) | (image->dx & 0xffff));\r\ndsize = ALIGN(ALIGN(image->width, 8) * image->height, 32) >> 5;\r\nwhile (dsize) {\r\nint iter_len = dsize > 128 ? 128 : dsize;\r\nret = RING_SPACE(chan, iter_len + 1);\r\nif (ret)\r\nreturn ret;\r\nBEGIN_NV04(chan, NvSubGdiRect, 0x0c00, iter_len);\r\nOUT_RINGp(chan, data, iter_len);\r\ndata += iter_len;\r\ndsize -= iter_len;\r\n}\r\nFIRE_RING(chan);\r\nreturn 0;\r\n}\r\nint\r\nnv04_fbcon_accel_init(struct fb_info *info)\r\n{\r\nstruct nouveau_fbdev *nfbdev = info->par;\r\nstruct drm_device *dev = nfbdev->dev;\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_channel *chan = drm->channel;\r\nstruct nvif_device *device = &drm->device;\r\nint surface_fmt, pattern_fmt, rect_fmt;\r\nint ret;\r\nswitch (info->var.bits_per_pixel) {\r\ncase 8:\r\nsurface_fmt = 1;\r\npattern_fmt = 3;\r\nrect_fmt = 3;\r\nbreak;\r\ncase 16:\r\nsurface_fmt = 4;\r\npattern_fmt = 1;\r\nrect_fmt = 1;\r\nbreak;\r\ncase 32:\r\nswitch (info->var.transp.length) {\r\ncase 0:\r\ncase 8:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nsurface_fmt = 6;\r\npattern_fmt = 3;\r\nrect_fmt = 3;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret = nvif_object_init(&chan->user, 0x0062,\r\ndevice->info.family >= NV_DEVICE_INFO_V0_CELSIUS ?\r\n0x0062 : 0x0042, NULL, 0, &nfbdev->surf2d);\r\nif (ret)\r\nreturn ret;\r\nret = nvif_object_init(&chan->user, 0x0019, 0x0019, NULL, 0,\r\n&nfbdev->clip);\r\nif (ret)\r\nreturn ret;\r\nret = nvif_object_init(&chan->user, 0x0043, 0x0043, NULL, 0,\r\n&nfbdev->rop);\r\nif (ret)\r\nreturn ret;\r\nret = nvif_object_init(&chan->user, 0x0044, 0x0044, NULL, 0,\r\n&nfbdev->patt);\r\nif (ret)\r\nreturn ret;\r\nret = nvif_object_init(&chan->user, 0x004a, 0x004a, NULL, 0,\r\n&nfbdev->gdi);\r\nif (ret)\r\nreturn ret;\r\nret = nvif_object_init(&chan->user, 0x005f,\r\ndevice->info.chipset >= 0x11 ? 0x009f : 0x005f,\r\nNULL, 0, &nfbdev->blit);\r\nif (ret)\r\nreturn ret;\r\nif (RING_SPACE(chan, 49 + (device->info.chipset >= 0x11 ? 4 : 0))) {\r\nnouveau_fbcon_gpu_lockup(info);\r\nreturn 0;\r\n}\r\nBEGIN_NV04(chan, NvSubCtxSurf2D, 0x0000, 1);\r\nOUT_RING(chan, nfbdev->surf2d.handle);\r\nBEGIN_NV04(chan, NvSubCtxSurf2D, 0x0184, 2);\r\nOUT_RING(chan, chan->vram.handle);\r\nOUT_RING(chan, chan->vram.handle);\r\nBEGIN_NV04(chan, NvSubCtxSurf2D, 0x0300, 4);\r\nOUT_RING(chan, surface_fmt);\r\nOUT_RING(chan, info->fix.line_length | (info->fix.line_length << 16));\r\nOUT_RING(chan, info->fix.smem_start - dev->mode_config.fb_base);\r\nOUT_RING(chan, info->fix.smem_start - dev->mode_config.fb_base);\r\nBEGIN_NV04(chan, NvSubCtxSurf2D, 0x0000, 1);\r\nOUT_RING(chan, nfbdev->rop.handle);\r\nBEGIN_NV04(chan, NvSubCtxSurf2D, 0x0300, 1);\r\nOUT_RING(chan, 0x55);\r\nBEGIN_NV04(chan, NvSubCtxSurf2D, 0x0000, 1);\r\nOUT_RING(chan, nfbdev->patt.handle);\r\nBEGIN_NV04(chan, NvSubCtxSurf2D, 0x0300, 8);\r\nOUT_RING(chan, pattern_fmt);\r\n#ifdef __BIG_ENDIAN\r\nOUT_RING(chan, 2);\r\n#else\r\nOUT_RING(chan, 1);\r\n#endif\r\nOUT_RING(chan, 0);\r\nOUT_RING(chan, 1);\r\nOUT_RING(chan, ~0);\r\nOUT_RING(chan, ~0);\r\nOUT_RING(chan, ~0);\r\nOUT_RING(chan, ~0);\r\nBEGIN_NV04(chan, NvSubCtxSurf2D, 0x0000, 1);\r\nOUT_RING(chan, nfbdev->clip.handle);\r\nBEGIN_NV04(chan, NvSubCtxSurf2D, 0x0300, 2);\r\nOUT_RING(chan, 0);\r\nOUT_RING(chan, (info->var.yres_virtual << 16) | info->var.xres_virtual);\r\nBEGIN_NV04(chan, NvSubImageBlit, 0x0000, 1);\r\nOUT_RING(chan, nfbdev->blit.handle);\r\nBEGIN_NV04(chan, NvSubImageBlit, 0x019c, 1);\r\nOUT_RING(chan, nfbdev->surf2d.handle);\r\nBEGIN_NV04(chan, NvSubImageBlit, 0x02fc, 1);\r\nOUT_RING(chan, 3);\r\nif (device->info.chipset >= 0x11 ) {\r\nBEGIN_NV04(chan, NvSubImageBlit, 0x0120, 3);\r\nOUT_RING(chan, 0);\r\nOUT_RING(chan, 1);\r\nOUT_RING(chan, 2);\r\n}\r\nBEGIN_NV04(chan, NvSubGdiRect, 0x0000, 1);\r\nOUT_RING(chan, nfbdev->gdi.handle);\r\nBEGIN_NV04(chan, NvSubGdiRect, 0x0198, 1);\r\nOUT_RING(chan, nfbdev->surf2d.handle);\r\nBEGIN_NV04(chan, NvSubGdiRect, 0x0188, 2);\r\nOUT_RING(chan, nfbdev->patt.handle);\r\nOUT_RING(chan, nfbdev->rop.handle);\r\nBEGIN_NV04(chan, NvSubGdiRect, 0x0304, 1);\r\nOUT_RING(chan, 1);\r\nBEGIN_NV04(chan, NvSubGdiRect, 0x0300, 1);\r\nOUT_RING(chan, rect_fmt);\r\nBEGIN_NV04(chan, NvSubGdiRect, 0x02fc, 1);\r\nOUT_RING(chan, 3);\r\nFIRE_RING(chan);\r\nreturn 0;\r\n}

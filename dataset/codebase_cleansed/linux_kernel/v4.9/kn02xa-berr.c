static inline void dec_kn02xa_be_ack(void)\r\n{\r\nvolatile u32 *mer = (void *)CKSEG1ADDR(KN02XA_MER);\r\nvolatile u32 *mem_intr = (void *)CKSEG1ADDR(KN02XA_MEM_INTR);\r\n*mer = KN02CA_MER_INTR;\r\n*mem_intr = 0;\r\niob();\r\n}\r\nstatic int dec_kn02xa_be_backend(struct pt_regs *regs, int is_fixup,\r\nint invoker)\r\n{\r\nvolatile u32 *kn02xa_mer = (void *)CKSEG1ADDR(KN02XA_MER);\r\nvolatile u32 *kn02xa_ear = (void *)CKSEG1ADDR(KN02XA_EAR);\r\nstatic const char excstr[] = "exception";\r\nstatic const char intstr[] = "interrupt";\r\nstatic const char cpustr[] = "CPU";\r\nstatic const char mreadstr[] = "memory read";\r\nstatic const char readstr[] = "read";\r\nstatic const char writestr[] = "write";\r\nstatic const char timestr[] = "timeout";\r\nstatic const char paritystr[] = "parity error";\r\nstatic const char lanestat[][4] = { " OK", "BAD" };\r\nconst char *kind, *agent, *cycle, *event;\r\nunsigned long address;\r\nu32 mer = *kn02xa_mer;\r\nu32 ear = *kn02xa_ear;\r\nint action = MIPS_BE_FATAL;\r\ndec_kn02xa_be_ack();\r\nkind = invoker ? intstr : excstr;\r\nagent = cpustr;\r\naddress = ear & KN02XA_EAR_ADDRESS;\r\nif (address < 0x10000000) {\r\ncycle = mreadstr;\r\nevent = paritystr;\r\n} else {\r\ncycle = invoker ? writestr : readstr;\r\nevent = timestr;\r\n}\r\nif (is_fixup)\r\naction = MIPS_BE_FIXUP;\r\nif (action != MIPS_BE_FIXUP)\r\nprintk(KERN_ALERT "Bus error %s: %s %s %s at %#010lx\n",\r\nkind, agent, cycle, event, address);\r\nif (action != MIPS_BE_FIXUP && address < 0x10000000)\r\nprintk(KERN_ALERT " Byte lane status %#3x -- "\r\n"#3: %s, #2: %s, #1: %s, #0: %s\n",\r\n(mer & KN02XA_MER_BYTERR) >> 8,\r\nlanestat[(mer & KN02XA_MER_BYTERR_3) != 0],\r\nlanestat[(mer & KN02XA_MER_BYTERR_2) != 0],\r\nlanestat[(mer & KN02XA_MER_BYTERR_1) != 0],\r\nlanestat[(mer & KN02XA_MER_BYTERR_0) != 0]);\r\nreturn action;\r\n}\r\nint dec_kn02xa_be_handler(struct pt_regs *regs, int is_fixup)\r\n{\r\nreturn dec_kn02xa_be_backend(regs, is_fixup, 0);\r\n}\r\nirqreturn_t dec_kn02xa_be_interrupt(int irq, void *dev_id)\r\n{\r\nstruct pt_regs *regs = get_irq_regs();\r\nint action = dec_kn02xa_be_backend(regs, 0, 1);\r\nif (action == MIPS_BE_DISCARD)\r\nreturn IRQ_HANDLED;\r\nprintk(KERN_ALERT "Fatal bus interrupt, epc == %08lx, ra == %08lx\n",\r\nregs->cp0_epc, regs->regs[31]);\r\ndie("Unrecoverable bus error", regs);\r\n}\r\nvoid __init dec_kn02xa_be_init(void)\r\n{\r\nvolatile u32 *mbcs = (void *)CKSEG1ADDR(KN4K_SLOT_BASE + KN4K_MB_CSR);\r\nif (current_cpu_type() == CPU_R4000SC)\r\n*mbcs |= KN4K_MB_CSR_EE;\r\nfast_iob();\r\ndec_kn02xa_be_ack();\r\n}

static void snd_gf1_interrupt_midi_in(struct snd_gus_card * gus)\r\n{\r\nint count;\r\nunsigned char stat, data, byte;\r\nunsigned long flags;\r\ncount = 10;\r\nwhile (count) {\r\nspin_lock_irqsave(&gus->uart_cmd_lock, flags);\r\nstat = snd_gf1_uart_stat(gus);\r\nif (!(stat & 0x01)) {\r\nspin_unlock_irqrestore(&gus->uart_cmd_lock, flags);\r\ncount--;\r\ncontinue;\r\n}\r\ncount = 100;\r\ndata = snd_gf1_uart_get(gus);\r\nif (!(gus->gf1.uart_cmd & 0x80)) {\r\nspin_unlock_irqrestore(&gus->uart_cmd_lock, flags);\r\ncontinue;\r\n}\r\nif (stat & 0x10) {\r\ngus->gf1.uart_framing++;\r\nspin_unlock_irqrestore(&gus->uart_cmd_lock, flags);\r\ncontinue;\r\n}\r\nbyte = snd_gf1_uart_get(gus);\r\nspin_unlock_irqrestore(&gus->uart_cmd_lock, flags);\r\nsnd_rawmidi_receive(gus->midi_substream_input, &byte, 1);\r\nif (stat & 0x20) {\r\ngus->gf1.uart_overrun++;\r\n}\r\n}\r\n}\r\nstatic void snd_gf1_interrupt_midi_out(struct snd_gus_card * gus)\r\n{\r\nchar byte;\r\nunsigned long flags;\r\nif (snd_gf1_uart_stat(gus) & 0x01)\r\nsnd_gf1_interrupt_midi_in(gus);\r\nspin_lock_irqsave(&gus->uart_cmd_lock, flags);\r\nif (snd_gf1_uart_stat(gus) & 0x02) {\r\nif (snd_rawmidi_transmit(gus->midi_substream_output, &byte, 1) != 1) {\r\nsnd_gf1_uart_cmd(gus, gus->gf1.uart_cmd & ~0x20);\r\n} else {\r\nsnd_gf1_uart_put(gus, byte);\r\n}\r\n}\r\nspin_unlock_irqrestore(&gus->uart_cmd_lock, flags);\r\n}\r\nstatic void snd_gf1_uart_reset(struct snd_gus_card * gus, int close)\r\n{\r\nsnd_gf1_uart_cmd(gus, 0x03);\r\nif (!close && gus->uart_enable) {\r\nudelay(160);\r\nsnd_gf1_uart_cmd(gus, 0x00);\r\n}\r\n}\r\nstatic int snd_gf1_uart_output_open(struct snd_rawmidi_substream *substream)\r\n{\r\nunsigned long flags;\r\nstruct snd_gus_card *gus;\r\ngus = substream->rmidi->private_data;\r\nspin_lock_irqsave(&gus->uart_cmd_lock, flags);\r\nif (!(gus->gf1.uart_cmd & 0x80)) {\r\nsnd_gf1_uart_reset(gus, 0);\r\n}\r\ngus->gf1.interrupt_handler_midi_out = snd_gf1_interrupt_midi_out;\r\ngus->midi_substream_output = substream;\r\nspin_unlock_irqrestore(&gus->uart_cmd_lock, flags);\r\n#if 0\r\nsnd_printk(KERN_DEBUG "write init - cmd = 0x%x, stat = 0x%x\n", gus->gf1.uart_cmd, snd_gf1_uart_stat(gus));\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int snd_gf1_uart_input_open(struct snd_rawmidi_substream *substream)\r\n{\r\nunsigned long flags;\r\nstruct snd_gus_card *gus;\r\nint i;\r\ngus = substream->rmidi->private_data;\r\nspin_lock_irqsave(&gus->uart_cmd_lock, flags);\r\nif (gus->gf1.interrupt_handler_midi_out != snd_gf1_interrupt_midi_out) {\r\nsnd_gf1_uart_reset(gus, 0);\r\n}\r\ngus->gf1.interrupt_handler_midi_in = snd_gf1_interrupt_midi_in;\r\ngus->midi_substream_input = substream;\r\nif (gus->uart_enable) {\r\nfor (i = 0; i < 1000 && (snd_gf1_uart_stat(gus) & 0x01); i++)\r\nsnd_gf1_uart_get(gus);\r\nif (i >= 1000)\r\nsnd_printk(KERN_ERR "gus midi uart init read - cleanup error\n");\r\n}\r\nspin_unlock_irqrestore(&gus->uart_cmd_lock, flags);\r\n#if 0\r\nsnd_printk(KERN_DEBUG\r\n"read init - enable = %i, cmd = 0x%x, stat = 0x%x\n",\r\ngus->uart_enable, gus->gf1.uart_cmd, snd_gf1_uart_stat(gus));\r\nsnd_printk(KERN_DEBUG\r\n"[0x%x] reg (ctrl/status) = 0x%x, reg (data) = 0x%x "\r\n"(page = 0x%x)\n",\r\ngus->gf1.port + 0x100, inb(gus->gf1.port + 0x100),\r\ninb(gus->gf1.port + 0x101), inb(gus->gf1.port + 0x102));\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int snd_gf1_uart_output_close(struct snd_rawmidi_substream *substream)\r\n{\r\nunsigned long flags;\r\nstruct snd_gus_card *gus;\r\ngus = substream->rmidi->private_data;\r\nspin_lock_irqsave(&gus->uart_cmd_lock, flags);\r\nif (gus->gf1.interrupt_handler_midi_in != snd_gf1_interrupt_midi_in)\r\nsnd_gf1_uart_reset(gus, 1);\r\nsnd_gf1_set_default_handlers(gus, SNDRV_GF1_HANDLER_MIDI_OUT);\r\ngus->midi_substream_output = NULL;\r\nspin_unlock_irqrestore(&gus->uart_cmd_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int snd_gf1_uart_input_close(struct snd_rawmidi_substream *substream)\r\n{\r\nunsigned long flags;\r\nstruct snd_gus_card *gus;\r\ngus = substream->rmidi->private_data;\r\nspin_lock_irqsave(&gus->uart_cmd_lock, flags);\r\nif (gus->gf1.interrupt_handler_midi_out != snd_gf1_interrupt_midi_out)\r\nsnd_gf1_uart_reset(gus, 1);\r\nsnd_gf1_set_default_handlers(gus, SNDRV_GF1_HANDLER_MIDI_IN);\r\ngus->midi_substream_input = NULL;\r\nspin_unlock_irqrestore(&gus->uart_cmd_lock, flags);\r\nreturn 0;\r\n}\r\nstatic void snd_gf1_uart_input_trigger(struct snd_rawmidi_substream *substream, int up)\r\n{\r\nstruct snd_gus_card *gus;\r\nunsigned long flags;\r\ngus = substream->rmidi->private_data;\r\nspin_lock_irqsave(&gus->uart_cmd_lock, flags);\r\nif (up) {\r\nif ((gus->gf1.uart_cmd & 0x80) == 0)\r\nsnd_gf1_uart_cmd(gus, gus->gf1.uart_cmd | 0x80);\r\n} else {\r\nif (gus->gf1.uart_cmd & 0x80)\r\nsnd_gf1_uart_cmd(gus, gus->gf1.uart_cmd & ~0x80);\r\n}\r\nspin_unlock_irqrestore(&gus->uart_cmd_lock, flags);\r\n}\r\nstatic void snd_gf1_uart_output_trigger(struct snd_rawmidi_substream *substream, int up)\r\n{\r\nunsigned long flags;\r\nstruct snd_gus_card *gus;\r\nchar byte;\r\nint timeout;\r\ngus = substream->rmidi->private_data;\r\nspin_lock_irqsave(&gus->uart_cmd_lock, flags);\r\nif (up) {\r\nif ((gus->gf1.uart_cmd & 0x20) == 0) {\r\nspin_unlock_irqrestore(&gus->uart_cmd_lock, flags);\r\ntimeout = 10000;\r\nwhile (timeout-- > 0 && snd_gf1_uart_stat(gus) & 0x01);\r\nspin_lock_irqsave(&gus->uart_cmd_lock, flags);\r\nif (gus->gf1.uart_cmd & 0x20) {\r\nspin_unlock_irqrestore(&gus->uart_cmd_lock, flags);\r\nreturn;\r\n}\r\nif (snd_gf1_uart_stat(gus) & 0x02) {\r\nif (snd_rawmidi_transmit(substream, &byte, 1) != 1) {\r\nspin_unlock_irqrestore(&gus->uart_cmd_lock, flags);\r\nreturn;\r\n}\r\nsnd_gf1_uart_put(gus, byte);\r\n}\r\nsnd_gf1_uart_cmd(gus, gus->gf1.uart_cmd | 0x20);\r\n}\r\n} else {\r\nif (gus->gf1.uart_cmd & 0x20)\r\nsnd_gf1_uart_cmd(gus, gus->gf1.uart_cmd & ~0x20);\r\n}\r\nspin_unlock_irqrestore(&gus->uart_cmd_lock, flags);\r\n}\r\nint snd_gf1_rawmidi_new(struct snd_gus_card *gus, int device)\r\n{\r\nstruct snd_rawmidi *rmidi;\r\nint err;\r\nif ((err = snd_rawmidi_new(gus->card, "GF1", device, 1, 1, &rmidi)) < 0)\r\nreturn err;\r\nstrcpy(rmidi->name, gus->interwave ? "AMD InterWave" : "GF1");\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT, &snd_gf1_uart_output);\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT, &snd_gf1_uart_input);\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_OUTPUT | SNDRV_RAWMIDI_INFO_INPUT | SNDRV_RAWMIDI_INFO_DUPLEX;\r\nrmidi->private_data = gus;\r\ngus->midi_uart = rmidi;\r\nreturn err;\r\n}

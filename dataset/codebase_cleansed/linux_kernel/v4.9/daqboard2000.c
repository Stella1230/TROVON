static void daqboard2000_write_acq_scan_list_entry(struct comedi_device *dev,\r\nu16 entry)\r\n{\r\nwritew(entry & 0x00ff, dev->mmio + DB2K_REG_ACQ_SCAN_LIST_FIFO);\r\nwritew((entry >> 8) & 0x00ff,\r\ndev->mmio + DB2K_REG_ACQ_SCAN_LIST_FIFO);\r\n}\r\nstatic void daqboard2000_setup_sampling(struct comedi_device *dev, int chan,\r\nint gain)\r\n{\r\nu16 word0, word1, word2, word3;\r\nword0 = 0;\r\nword1 = 0x0004;\r\nword2 = (chan << 6) & 0x00c0;\r\nswitch (chan / 4) {\r\ncase 0:\r\nword3 = 0x0001;\r\nbreak;\r\ncase 1:\r\nword3 = 0x0002;\r\nbreak;\r\ncase 2:\r\nword3 = 0x0005;\r\nbreak;\r\ncase 3:\r\nword3 = 0x0006;\r\nbreak;\r\ncase 4:\r\nword3 = 0x0041;\r\nbreak;\r\ncase 5:\r\nword3 = 0x0042;\r\nbreak;\r\ndefault:\r\nword3 = 0;\r\nbreak;\r\n}\r\nword2 |= 0x0800;\r\nword3 |= 0xc000;\r\ndaqboard2000_write_acq_scan_list_entry(dev, word0);\r\ndaqboard2000_write_acq_scan_list_entry(dev, word1);\r\ndaqboard2000_write_acq_scan_list_entry(dev, word2);\r\ndaqboard2000_write_acq_scan_list_entry(dev, word3);\r\n}\r\nstatic int daqboard2000_ai_status(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned long context)\r\n{\r\nunsigned int status;\r\nstatus = readw(dev->mmio + DB2K_REG_ACQ_STATUS);\r\nif (status & context)\r\nreturn 0;\r\nreturn -EBUSY;\r\n}\r\nstatic int daqboard2000_ai_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nint gain, chan;\r\nint ret;\r\nint i;\r\nwritew(DB2K_ACQ_CONTROL_RESET_SCAN_LIST_FIFO |\r\nDB2K_ACQ_CONTROL_RESET_RESULTS_FIFO |\r\nDB2K_ACQ_CONTROL_RESET_CONFIG_PIPE,\r\ndev->mmio + DB2K_REG_ACQ_CONTROL);\r\nwritel(1000000, dev->mmio + DB2K_REG_ACQ_PACER_CLOCK_DIV_LOW);\r\nwritew(0, dev->mmio + DB2K_REG_ACQ_PACER_CLOCK_DIV_HIGH);\r\ngain = CR_RANGE(insn->chanspec);\r\nchan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++) {\r\ndaqboard2000_setup_sampling(dev, chan, gain);\r\nwritew(DB2K_ACQ_CONTROL_SEQ_START_SCAN_LIST,\r\ndev->mmio + DB2K_REG_ACQ_CONTROL);\r\nret = comedi_timeout(dev, s, insn, daqboard2000_ai_status,\r\nDB2K_ACQ_STATUS_CONFIG_PIPE_FULL);\r\nif (ret)\r\nreturn ret;\r\nwritew(DB2K_ACQ_CONTROL_ADC_PACER_ENABLE,\r\ndev->mmio + DB2K_REG_ACQ_CONTROL);\r\nret = comedi_timeout(dev, s, insn, daqboard2000_ai_status,\r\nDB2K_ACQ_STATUS_LOGIC_SCANNING);\r\nif (ret)\r\nreturn ret;\r\nret =\r\ncomedi_timeout(dev, s, insn, daqboard2000_ai_status,\r\nDB2K_ACQ_STATUS_RESULTS_FIFO_HAS_DATA);\r\nif (ret)\r\nreturn ret;\r\ndata[i] = readw(dev->mmio + DB2K_REG_ACQ_RESULTS_FIFO);\r\nwritew(DB2K_ACQ_CONTROL_ADC_PACER_DISABLE,\r\ndev->mmio + DB2K_REG_ACQ_CONTROL);\r\nwritew(DB2K_ACQ_CONTROL_SEQ_STOP_SCAN_LIST,\r\ndev->mmio + DB2K_REG_ACQ_CONTROL);\r\n}\r\nreturn i;\r\n}\r\nstatic int daqboard2000_ao_eoc(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned long context)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int status;\r\nstatus = readw(dev->mmio + DB2K_REG_DAC_STATUS);\r\nif ((status & DB2K_DAC_STATUS_DAC_BUSY(chan)) == 0)\r\nreturn 0;\r\nreturn -EBUSY;\r\n}\r\nstatic int daqboard2000_ao_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nint i;\r\nfor (i = 0; i < insn->n; i++) {\r\nunsigned int val = data[i];\r\nint ret;\r\nwritew(val, dev->mmio + DB2K_REG_DAC_SETTING(chan));\r\nret = comedi_timeout(dev, s, insn, daqboard2000_ao_eoc, 0);\r\nif (ret)\r\nreturn ret;\r\ns->readback[chan] = val;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic void daqboard2000_reset_local_bus(struct comedi_device *dev)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nwritel(DB2K_SECR_LOCAL_BUS_HI, devpriv->plx + 0x6c);\r\nmdelay(10);\r\nwritel(DB2K_SECR_LOCAL_BUS_LO, devpriv->plx + 0x6c);\r\nmdelay(10);\r\n}\r\nstatic void daqboard2000_reload_plx(struct comedi_device *dev)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nwritel(DB2K_SECR_RELOAD_LO, devpriv->plx + 0x6c);\r\nmdelay(10);\r\nwritel(DB2K_SECR_RELOAD_HI, devpriv->plx + 0x6c);\r\nmdelay(10);\r\nwritel(DB2K_SECR_RELOAD_LO, devpriv->plx + 0x6c);\r\nmdelay(10);\r\n}\r\nstatic void daqboard2000_pulse_prog_pin(struct comedi_device *dev)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nwritel(DB2K_SECR_PROG_PIN_HI, devpriv->plx + 0x6c);\r\nmdelay(10);\r\nwritel(DB2K_SECR_PROG_PIN_LO, devpriv->plx + 0x6c);\r\nmdelay(10);\r\n}\r\nstatic int daqboard2000_poll_cpld(struct comedi_device *dev, int mask)\r\n{\r\nint result = 0;\r\nint i;\r\nint cpld;\r\nfor (i = 0; i < 50; i++) {\r\ncpld = readw(dev->mmio + 0x1000);\r\nif ((cpld & mask) == mask) {\r\nresult = 1;\r\nbreak;\r\n}\r\nusleep_range(100, 1000);\r\n}\r\nudelay(5);\r\nreturn result;\r\n}\r\nstatic int daqboard2000_write_cpld(struct comedi_device *dev, int data)\r\n{\r\nint result = 0;\r\nusleep_range(10, 20);\r\nwritew(data, dev->mmio + 0x1000);\r\nif ((readw(dev->mmio + 0x1000) & DAQBOARD2000_CPLD_INIT) ==\r\nDAQBOARD2000_CPLD_INIT) {\r\nresult = 1;\r\n}\r\nreturn result;\r\n}\r\nstatic int daqboard2000_load_firmware(struct comedi_device *dev,\r\nconst u8 *cpld_array, size_t len,\r\nunsigned long context)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nint result = -EIO;\r\nint secr;\r\nint retry;\r\nsize_t i;\r\nsecr = readl(devpriv->plx + 0x6c);\r\nif (!(secr & DAQBOARD2000_EEPROM_PRESENT))\r\nreturn -EIO;\r\nfor (retry = 0; retry < 3; retry++) {\r\ndaqboard2000_reset_local_bus(dev);\r\ndaqboard2000_reload_plx(dev);\r\ndaqboard2000_pulse_prog_pin(dev);\r\nif (daqboard2000_poll_cpld(dev, DAQBOARD2000_CPLD_INIT)) {\r\nfor (i = 0; i < len; i++) {\r\nif (cpld_array[i] == 0xff &&\r\ncpld_array[i + 1] == 0x20)\r\nbreak;\r\n}\r\nfor (; i < len; i += 2) {\r\nint data =\r\n(cpld_array[i] << 8) + cpld_array[i + 1];\r\nif (!daqboard2000_write_cpld(dev, data))\r\nbreak;\r\n}\r\nif (i >= len) {\r\ndaqboard2000_reset_local_bus(dev);\r\ndaqboard2000_reload_plx(dev);\r\nresult = 0;\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn result;\r\n}\r\nstatic void daqboard2000_adc_stop_dma_transfer(struct comedi_device *dev)\r\n{\r\n}\r\nstatic void daqboard2000_adc_disarm(struct comedi_device *dev)\r\n{\r\nudelay(2);\r\nwritew(DB2K_TRIG_CONTROL_TYPE_ANALOG | DB2K_TRIG_CONTROL_DISABLE,\r\ndev->mmio + DB2K_REG_TRIG_CONTROL);\r\nudelay(2);\r\nwritew(DB2K_TRIG_CONTROL_TYPE_TTL | DB2K_TRIG_CONTROL_DISABLE,\r\ndev->mmio + DB2K_REG_TRIG_CONTROL);\r\nudelay(2);\r\nwritew(DB2K_ACQ_CONTROL_SEQ_STOP_SCAN_LIST,\r\ndev->mmio + DB2K_REG_ACQ_CONTROL);\r\nudelay(2);\r\nwritew(DB2K_ACQ_CONTROL_ADC_PACER_DISABLE,\r\ndev->mmio + DB2K_REG_ACQ_CONTROL);\r\ndaqboard2000_adc_stop_dma_transfer(dev);\r\n}\r\nstatic void daqboard2000_activate_reference_dacs(struct comedi_device *dev)\r\n{\r\nunsigned int val;\r\nint timeout;\r\nwritew(DB2K_REF_DACS_SET | DB2K_REF_DACS_SELECT_POS_REF,\r\ndev->mmio + DB2K_REG_REF_DACS);\r\nfor (timeout = 0; timeout < 20; timeout++) {\r\nval = readw(dev->mmio + DB2K_REG_DAC_STATUS);\r\nif ((val & DB2K_DAC_STATUS_REF_BUSY) == 0)\r\nbreak;\r\nudelay(2);\r\n}\r\nwritew(DB2K_REF_DACS_SET | DB2K_REF_DACS_SELECT_NEG_REF,\r\ndev->mmio + DB2K_REG_REF_DACS);\r\nfor (timeout = 0; timeout < 20; timeout++) {\r\nval = readw(dev->mmio + DB2K_REG_DAC_STATUS);\r\nif ((val & DB2K_DAC_STATUS_REF_BUSY) == 0)\r\nbreak;\r\nudelay(2);\r\n}\r\n}\r\nstatic void daqboard2000_initialize_ctrs(struct comedi_device *dev)\r\n{\r\n}\r\nstatic void daqboard2000_initialize_tmrs(struct comedi_device *dev)\r\n{\r\n}\r\nstatic void daqboard2000_dac_disarm(struct comedi_device *dev)\r\n{\r\n}\r\nstatic void daqboard2000_initialize_adc(struct comedi_device *dev)\r\n{\r\ndaqboard2000_adc_disarm(dev);\r\ndaqboard2000_activate_reference_dacs(dev);\r\ndaqboard2000_initialize_ctrs(dev);\r\ndaqboard2000_initialize_tmrs(dev);\r\n}\r\nstatic void daqboard2000_initialize_dac(struct comedi_device *dev)\r\n{\r\ndaqboard2000_dac_disarm(dev);\r\n}\r\nstatic int daqboard2000_8255_cb(struct comedi_device *dev,\r\nint dir, int port, int data,\r\nunsigned long iobase)\r\n{\r\nif (dir) {\r\nwritew(data, dev->mmio + iobase + port * 2);\r\nreturn 0;\r\n}\r\nreturn readw(dev->mmio + iobase + port * 2);\r\n}\r\nstatic const void *daqboard2000_find_boardinfo(struct comedi_device *dev,\r\nstruct pci_dev *pcidev)\r\n{\r\nconst struct daq200_boardtype *board;\r\nint i;\r\nif (pcidev->subsystem_vendor != PCI_VENDOR_ID_IOTECH)\r\nreturn NULL;\r\nfor (i = 0; i < ARRAY_SIZE(boardtypes); i++) {\r\nboard = &boardtypes[i];\r\nif (pcidev->subsystem_device == board->id)\r\nreturn board;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int daqboard2000_auto_attach(struct comedi_device *dev,\r\nunsigned long context_unused)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nconst struct daq200_boardtype *board;\r\nstruct daqboard2000_private *devpriv;\r\nstruct comedi_subdevice *s;\r\nint result;\r\nboard = daqboard2000_find_boardinfo(dev, pcidev);\r\nif (!board)\r\nreturn -ENODEV;\r\ndev->board_ptr = board;\r\ndev->board_name = board->name;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\nresult = comedi_pci_enable(dev);\r\nif (result)\r\nreturn result;\r\ndevpriv->plx = pci_ioremap_bar(pcidev, 0);\r\ndev->mmio = pci_ioremap_bar(pcidev, 2);\r\nif (!devpriv->plx || !dev->mmio)\r\nreturn -ENOMEM;\r\nresult = comedi_alloc_subdevices(dev, 3);\r\nif (result)\r\nreturn result;\r\nreadl(devpriv->plx + 0x6c);\r\nresult = comedi_load_firmware(dev, &comedi_to_pci_dev(dev)->dev,\r\nDAQBOARD2000_FIRMWARE,\r\ndaqboard2000_load_firmware, 0);\r\nif (result < 0)\r\nreturn result;\r\ndaqboard2000_initialize_adc(dev);\r\ndaqboard2000_initialize_dac(dev);\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND;\r\ns->n_chan = 24;\r\ns->maxdata = 0xffff;\r\ns->insn_read = daqboard2000_ai_insn_read;\r\ns->range_table = &range_daqboard2000_ai;\r\ns = &dev->subdevices[1];\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = 2;\r\ns->maxdata = 0xffff;\r\ns->insn_write = daqboard2000_ao_insn_write;\r\ns->range_table = &range_bipolar10;\r\nresult = comedi_alloc_subdev_readback(s);\r\nif (result)\r\nreturn result;\r\ns = &dev->subdevices[2];\r\nreturn subdev_8255_init(dev, s, daqboard2000_8255_cb,\r\nDB2K_REG_DIO_P2_EXP_IO_8_BIT);\r\n}\r\nstatic void daqboard2000_detach(struct comedi_device *dev)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nif (devpriv && devpriv->plx)\r\niounmap(devpriv->plx);\r\ncomedi_pci_detach(dev);\r\n}\r\nstatic int daqboard2000_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &daqboard2000_driver,\r\nid->driver_data);\r\n}

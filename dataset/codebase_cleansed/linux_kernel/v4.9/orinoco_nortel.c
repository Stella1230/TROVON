static int orinoco_nortel_cor_reset(struct orinoco_private *priv)\r\n{\r\nstruct orinoco_pci_card *card = priv->card;\r\niowrite16(8, card->bridge_io + 2);\r\nioread16(card->attr_io + COR_OFFSET);\r\niowrite16(0x80, card->attr_io + COR_OFFSET);\r\nmdelay(1);\r\niowrite16(0, card->attr_io + COR_OFFSET);\r\niowrite16(0, card->attr_io + COR_OFFSET);\r\nmdelay(1);\r\niowrite16(COR_VALUE, card->attr_io + COR_OFFSET);\r\niowrite16(COR_VALUE, card->attr_io + COR_OFFSET);\r\nmdelay(1);\r\niowrite16(0x228, card->bridge_io + 2);\r\nreturn 0;\r\n}\r\nstatic int orinoco_nortel_hw_init(struct orinoco_pci_card *card)\r\n{\r\nint i;\r\nu32 reg;\r\nif (ioread16(card->bridge_io) & 1) {\r\nprintk(KERN_ERR PFX "brg1 answer1 wrong\n");\r\nreturn -EBUSY;\r\n}\r\niowrite16(0x118, card->bridge_io + 2);\r\niowrite16(0x108, card->bridge_io + 2);\r\nmdelay(30);\r\niowrite16(0x8, card->bridge_io + 2);\r\nfor (i = 0; i < 30; i++) {\r\nmdelay(30);\r\nif (ioread16(card->bridge_io) & 0x10)\r\nbreak;\r\n}\r\nif (i == 30) {\r\nprintk(KERN_ERR PFX "brg1 timed out\n");\r\nreturn -EBUSY;\r\n}\r\nif (ioread16(card->attr_io + COR_OFFSET) & 1) {\r\nprintk(KERN_ERR PFX "brg2 answer1 wrong\n");\r\nreturn -EBUSY;\r\n}\r\nif (ioread16(card->attr_io + COR_OFFSET + 2) & 1) {\r\nprintk(KERN_ERR PFX "brg2 answer2 wrong\n");\r\nreturn -EBUSY;\r\n}\r\nif (ioread16(card->attr_io + COR_OFFSET + 4) & 1) {\r\nprintk(KERN_ERR PFX "brg2 answer3 wrong\n");\r\nreturn -EBUSY;\r\n}\r\niowrite16(COR_VALUE, card->attr_io + COR_OFFSET);\r\nmdelay(1);\r\nreg = ioread16(card->attr_io + COR_OFFSET);\r\nif (reg != COR_VALUE) {\r\nprintk(KERN_ERR PFX "Error setting COR value (reg=%x)\n",\r\nreg);\r\nreturn -EBUSY;\r\n}\r\niowrite16(1, card->bridge_io + 10);\r\nreturn 0;\r\n}\r\nstatic int orinoco_nortel_init_one(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nint err;\r\nstruct orinoco_private *priv;\r\nstruct orinoco_pci_card *card;\r\nvoid __iomem *hermes_io, *bridge_io, *attr_io;\r\nerr = pci_enable_device(pdev);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Cannot enable PCI device\n");\r\nreturn err;\r\n}\r\nerr = pci_request_regions(pdev, DRIVER_NAME);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Cannot obtain PCI resources\n");\r\ngoto fail_resources;\r\n}\r\nbridge_io = pci_iomap(pdev, 0, 0);\r\nif (!bridge_io) {\r\nprintk(KERN_ERR PFX "Cannot map bridge registers\n");\r\nerr = -EIO;\r\ngoto fail_map_bridge;\r\n}\r\nattr_io = pci_iomap(pdev, 1, 0);\r\nif (!attr_io) {\r\nprintk(KERN_ERR PFX "Cannot map PCMCIA attributes\n");\r\nerr = -EIO;\r\ngoto fail_map_attr;\r\n}\r\nhermes_io = pci_iomap(pdev, 2, 0);\r\nif (!hermes_io) {\r\nprintk(KERN_ERR PFX "Cannot map chipset registers\n");\r\nerr = -EIO;\r\ngoto fail_map_hermes;\r\n}\r\npriv = alloc_orinocodev(sizeof(*card), &pdev->dev,\r\norinoco_nortel_cor_reset, NULL);\r\nif (!priv) {\r\nprintk(KERN_ERR PFX "Cannot allocate network device\n");\r\nerr = -ENOMEM;\r\ngoto fail_alloc;\r\n}\r\ncard = priv->card;\r\ncard->bridge_io = bridge_io;\r\ncard->attr_io = attr_io;\r\nhermes_struct_init(&priv->hw, hermes_io, HERMES_16BIT_REGSPACING);\r\nerr = request_irq(pdev->irq, orinoco_interrupt, IRQF_SHARED,\r\nDRIVER_NAME, priv);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Cannot allocate IRQ %d\n", pdev->irq);\r\nerr = -EBUSY;\r\ngoto fail_irq;\r\n}\r\nerr = orinoco_nortel_hw_init(card);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Hardware initialization failed\n");\r\ngoto fail;\r\n}\r\nerr = orinoco_nortel_cor_reset(priv);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Initial reset failed\n");\r\ngoto fail;\r\n}\r\nerr = orinoco_init(priv);\r\nif (err) {\r\nprintk(KERN_ERR PFX "orinoco_init() failed\n");\r\ngoto fail;\r\n}\r\nerr = orinoco_if_add(priv, 0, 0, NULL);\r\nif (err) {\r\nprintk(KERN_ERR PFX "orinoco_if_add() failed\n");\r\ngoto fail_wiphy;\r\n}\r\npci_set_drvdata(pdev, priv);\r\nreturn 0;\r\nfail_wiphy:\r\nwiphy_unregister(priv_to_wiphy(priv));\r\nfail:\r\nfree_irq(pdev->irq, priv);\r\nfail_irq:\r\nfree_orinocodev(priv);\r\nfail_alloc:\r\npci_iounmap(pdev, hermes_io);\r\nfail_map_hermes:\r\npci_iounmap(pdev, attr_io);\r\nfail_map_attr:\r\npci_iounmap(pdev, bridge_io);\r\nfail_map_bridge:\r\npci_release_regions(pdev);\r\nfail_resources:\r\npci_disable_device(pdev);\r\nreturn err;\r\n}\r\nstatic void orinoco_nortel_remove_one(struct pci_dev *pdev)\r\n{\r\nstruct orinoco_private *priv = pci_get_drvdata(pdev);\r\nstruct orinoco_pci_card *card = priv->card;\r\niowrite16(0, card->bridge_io + 10);\r\norinoco_if_del(priv);\r\nwiphy_unregister(priv_to_wiphy(priv));\r\nfree_irq(pdev->irq, priv);\r\nfree_orinocodev(priv);\r\npci_iounmap(pdev, priv->hw.iobase);\r\npci_iounmap(pdev, card->attr_io);\r\npci_iounmap(pdev, card->bridge_io);\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\n}\r\nstatic int __init orinoco_nortel_init(void)\r\n{\r\nprintk(KERN_DEBUG "%s\n", version);\r\nreturn pci_register_driver(&orinoco_nortel_driver);\r\n}\r\nstatic void __exit orinoco_nortel_exit(void)\r\n{\r\npci_unregister_driver(&orinoco_nortel_driver);\r\n}

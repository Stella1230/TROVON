void virtio_gpu_gem_free_object(struct drm_gem_object *gem_obj)\r\n{\r\nstruct virtio_gpu_object *obj = gem_to_virtio_gpu_obj(gem_obj);\r\nif (obj)\r\nvirtio_gpu_object_unref(&obj);\r\n}\r\nstruct virtio_gpu_object *virtio_gpu_alloc_object(struct drm_device *dev,\r\nsize_t size, bool kernel,\r\nbool pinned)\r\n{\r\nstruct virtio_gpu_device *vgdev = dev->dev_private;\r\nstruct virtio_gpu_object *obj;\r\nint ret;\r\nret = virtio_gpu_object_create(vgdev, size, kernel, pinned, &obj);\r\nif (ret)\r\nreturn ERR_PTR(ret);\r\nreturn obj;\r\n}\r\nint virtio_gpu_gem_create(struct drm_file *file,\r\nstruct drm_device *dev,\r\nuint64_t size,\r\nstruct drm_gem_object **obj_p,\r\nuint32_t *handle_p)\r\n{\r\nstruct virtio_gpu_object *obj;\r\nint ret;\r\nu32 handle;\r\nobj = virtio_gpu_alloc_object(dev, size, false, false);\r\nif (IS_ERR(obj))\r\nreturn PTR_ERR(obj);\r\nret = drm_gem_handle_create(file, &obj->gem_base, &handle);\r\nif (ret) {\r\ndrm_gem_object_release(&obj->gem_base);\r\nreturn ret;\r\n}\r\n*obj_p = &obj->gem_base;\r\ndrm_gem_object_unreference_unlocked(&obj->gem_base);\r\n*handle_p = handle;\r\nreturn 0;\r\n}\r\nint virtio_gpu_mode_dumb_create(struct drm_file *file_priv,\r\nstruct drm_device *dev,\r\nstruct drm_mode_create_dumb *args)\r\n{\r\nstruct virtio_gpu_device *vgdev = dev->dev_private;\r\nstruct drm_gem_object *gobj;\r\nstruct virtio_gpu_object *obj;\r\nint ret;\r\nuint32_t pitch;\r\nuint32_t resid;\r\npitch = args->width * ((args->bpp + 1) / 8);\r\nargs->size = pitch * args->height;\r\nargs->size = ALIGN(args->size, PAGE_SIZE);\r\nret = virtio_gpu_gem_create(file_priv, dev, args->size, &gobj,\r\n&args->handle);\r\nif (ret)\r\ngoto fail;\r\nvirtio_gpu_resource_id_get(vgdev, &resid);\r\nvirtio_gpu_cmd_create_resource(vgdev, resid,\r\n2, args->width, args->height);\r\nobj = gem_to_virtio_gpu_obj(gobj);\r\nret = virtio_gpu_object_attach(vgdev, obj, resid, NULL);\r\nif (ret)\r\ngoto fail;\r\nobj->dumb = true;\r\nargs->pitch = pitch;\r\nreturn ret;\r\nfail:\r\nreturn ret;\r\n}\r\nint virtio_gpu_mode_dumb_destroy(struct drm_file *file_priv,\r\nstruct drm_device *dev,\r\nuint32_t handle)\r\n{\r\nreturn drm_gem_handle_delete(file_priv, handle);\r\n}\r\nint virtio_gpu_mode_dumb_mmap(struct drm_file *file_priv,\r\nstruct drm_device *dev,\r\nuint32_t handle, uint64_t *offset_p)\r\n{\r\nstruct drm_gem_object *gobj;\r\nstruct virtio_gpu_object *obj;\r\nBUG_ON(!offset_p);\r\ngobj = drm_gem_object_lookup(file_priv, handle);\r\nif (gobj == NULL)\r\nreturn -ENOENT;\r\nobj = gem_to_virtio_gpu_obj(gobj);\r\n*offset_p = virtio_gpu_object_mmap_offset(obj);\r\ndrm_gem_object_unreference_unlocked(gobj);\r\nreturn 0;\r\n}\r\nint virtio_gpu_gem_object_open(struct drm_gem_object *obj,\r\nstruct drm_file *file)\r\n{\r\nstruct virtio_gpu_device *vgdev = obj->dev->dev_private;\r\nstruct virtio_gpu_fpriv *vfpriv = file->driver_priv;\r\nstruct virtio_gpu_object *qobj = gem_to_virtio_gpu_obj(obj);\r\nint r;\r\nif (!vgdev->has_virgl_3d)\r\nreturn 0;\r\nr = virtio_gpu_object_reserve(qobj, false);\r\nif (r)\r\nreturn r;\r\nvirtio_gpu_cmd_context_attach_resource(vgdev, vfpriv->ctx_id,\r\nqobj->hw_res_handle);\r\nvirtio_gpu_object_unreserve(qobj);\r\nreturn 0;\r\n}\r\nvoid virtio_gpu_gem_object_close(struct drm_gem_object *obj,\r\nstruct drm_file *file)\r\n{\r\nstruct virtio_gpu_device *vgdev = obj->dev->dev_private;\r\nstruct virtio_gpu_fpriv *vfpriv = file->driver_priv;\r\nstruct virtio_gpu_object *qobj = gem_to_virtio_gpu_obj(obj);\r\nint r;\r\nif (!vgdev->has_virgl_3d)\r\nreturn;\r\nr = virtio_gpu_object_reserve(qobj, false);\r\nif (r)\r\nreturn;\r\nvirtio_gpu_cmd_context_detach_resource(vgdev, vfpriv->ctx_id,\r\nqobj->hw_res_handle);\r\nvirtio_gpu_object_unreserve(qobj);\r\n}

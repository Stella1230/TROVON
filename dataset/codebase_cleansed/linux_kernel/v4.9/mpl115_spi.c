static int mpl115_spi_init(struct device *dev)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct mpl115_spi_buf *buf;\r\nbuf = devm_kzalloc(dev, sizeof(*buf), GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nspi_set_drvdata(spi, buf);\r\nreturn 0;\r\n}\r\nstatic int mpl115_spi_read(struct device *dev, u8 address)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct mpl115_spi_buf *buf = spi_get_drvdata(spi);\r\nstruct spi_transfer xfer = {\r\n.tx_buf = buf->tx,\r\n.rx_buf = buf->rx,\r\n.len = 4,\r\n};\r\nint ret;\r\nbuf->tx[0] = MPL115_SPI_READ(address);\r\nbuf->tx[2] = MPL115_SPI_READ(address + 1);\r\nret = spi_sync_transfer(spi, &xfer, 1);\r\nif (ret)\r\nreturn ret;\r\nreturn (buf->rx[1] << 8) | buf->rx[3];\r\n}\r\nstatic int mpl115_spi_write(struct device *dev, u8 address, u8 value)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct mpl115_spi_buf *buf = spi_get_drvdata(spi);\r\nstruct spi_transfer xfer = {\r\n.tx_buf = buf->tx,\r\n.len = 2,\r\n};\r\nbuf->tx[0] = MPL115_SPI_WRITE(address);\r\nbuf->tx[1] = value;\r\nreturn spi_sync_transfer(spi, &xfer, 1);\r\n}\r\nstatic int mpl115_spi_probe(struct spi_device *spi)\r\n{\r\nconst struct spi_device_id *id = spi_get_device_id(spi);\r\nreturn mpl115_probe(&spi->dev, id->name, &mpl115_spi_ops);\r\n}

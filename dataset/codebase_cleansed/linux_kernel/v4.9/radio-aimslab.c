static struct radio_isa_card *rtrack_alloc(void)\r\n{\r\nstruct rtrack *rt = kzalloc(sizeof(struct rtrack), GFP_KERNEL);\r\nif (rt)\r\nrt->curvol = 0xff;\r\nreturn rt ? &rt->isa : NULL;\r\n}\r\nstatic void rtrack_set_pins(void *handle, u8 pins)\r\n{\r\nstruct radio_isa_card *isa = handle;\r\nstruct rtrack *rt = container_of(isa, struct rtrack, isa);\r\nu8 bits = AIMS_BIT_VOL_DN | AIMS_BIT_VOL_UP | AIMS_BIT_TUN_STRQ;\r\nif (!v4l2_ctrl_g_ctrl(rt->isa.mute))\r\nbits |= AIMS_BIT_VOL_CE;\r\nif (pins & LM7000_DATA)\r\nbits |= AIMS_BIT_TUN_DATA;\r\nif (pins & LM7000_CLK)\r\nbits |= AIMS_BIT_TUN_CLK;\r\nif (pins & LM7000_CE)\r\nbits |= AIMS_BIT_TUN_CE;\r\noutb_p(bits, rt->isa.io);\r\n}\r\nstatic int rtrack_s_frequency(struct radio_isa_card *isa, u32 freq)\r\n{\r\nlm7000_set_freq(freq, isa, rtrack_set_pins);\r\nreturn 0;\r\n}\r\nstatic u32 rtrack_g_signal(struct radio_isa_card *isa)\r\n{\r\nreturn 0xffff * !(inb(isa->io) & 2);\r\n}\r\nstatic int rtrack_s_mute_volume(struct radio_isa_card *isa, bool mute, int vol)\r\n{\r\nstruct rtrack *rt = container_of(isa, struct rtrack, isa);\r\nint curvol = rt->curvol;\r\nif (mute) {\r\noutb(0xd0, isa->io);\r\nreturn 0;\r\n}\r\nif (vol == 0) {\r\noutb(0x48, isa->io);\r\nmsleep(curvol * 3);\r\n} else if (curvol < vol) {\r\noutb(0x98, isa->io);\r\nfor (; curvol < vol; curvol++)\r\nmdelay(3);\r\n} else if (curvol > vol) {\r\noutb(0x58, isa->io);\r\nfor (; curvol > vol; curvol--)\r\nmdelay(3);\r\n}\r\noutb(0xd8, isa->io);\r\nrt->curvol = vol;\r\nreturn 0;\r\n}\r\nstatic int rtrack_initialize(struct radio_isa_card *isa)\r\n{\r\noutb(0x90, isa->io);\r\nmsleep(3000);\r\noutb(0xc0, isa->io);\r\nreturn 0;\r\n}\r\nstatic int __init rtrack_init(void)\r\n{\r\nreturn isa_register_driver(&rtrack_driver.driver, RTRACK_MAX);\r\n}\r\nstatic void __exit rtrack_exit(void)\r\n{\r\nisa_unregister_driver(&rtrack_driver.driver);\r\n}

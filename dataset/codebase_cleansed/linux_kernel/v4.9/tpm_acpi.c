int read_log(struct tpm_bios_log *log)\r\n{\r\nstruct acpi_tcpa *buff;\r\nacpi_status status;\r\nvoid __iomem *virt;\r\nu64 len, start;\r\nif (log->bios_event_log != NULL) {\r\nprintk(KERN_ERR\r\n"%s: ERROR - Eventlog already initialized\n",\r\n__func__);\r\nreturn -EFAULT;\r\n}\r\nstatus = acpi_get_table(ACPI_SIG_TCPA, 1,\r\n(struct acpi_table_header **)&buff);\r\nif (ACPI_FAILURE(status)) {\r\nprintk(KERN_ERR "%s: ERROR - Could not get TCPA table\n",\r\n__func__);\r\nreturn -EIO;\r\n}\r\nswitch(buff->platform_class) {\r\ncase BIOS_SERVER:\r\nlen = buff->server.log_max_len;\r\nstart = buff->server.log_start_addr;\r\nbreak;\r\ncase BIOS_CLIENT:\r\ndefault:\r\nlen = buff->client.log_max_len;\r\nstart = buff->client.log_start_addr;\r\nbreak;\r\n}\r\nif (!len) {\r\nprintk(KERN_ERR "%s: ERROR - TCPA log area empty\n", __func__);\r\nreturn -EIO;\r\n}\r\nlog->bios_event_log = kmalloc(len, GFP_KERNEL);\r\nif (!log->bios_event_log) {\r\nprintk("%s: ERROR - Not enough Memory for BIOS measurements\n",\r\n__func__);\r\nreturn -ENOMEM;\r\n}\r\nlog->bios_event_log_end = log->bios_event_log + len;\r\nvirt = acpi_os_map_iomem(start, len);\r\nif (!virt) {\r\nkfree(log->bios_event_log);\r\nprintk("%s: ERROR - Unable to map memory\n", __func__);\r\nreturn -EIO;\r\n}\r\nmemcpy_fromio(log->bios_event_log, virt, len);\r\nacpi_os_unmap_iomem(virt, len);\r\nreturn 0;\r\n}

phys_addr_t pci_mcfg_lookup(u16 seg, struct resource *bus_res)\r\n{\r\nstruct mcfg_entry *e;\r\nlist_for_each_entry(e, &pci_mcfg_list, list) {\r\nif (e->segment == seg && e->bus_start == bus_res->start &&\r\ne->bus_end >= bus_res->end)\r\nreturn e->addr;\r\n}\r\nreturn 0;\r\n}\r\nstatic __init int pci_mcfg_parse(struct acpi_table_header *header)\r\n{\r\nstruct acpi_table_mcfg *mcfg;\r\nstruct acpi_mcfg_allocation *mptr;\r\nstruct mcfg_entry *e, *arr;\r\nint i, n;\r\nif (header->length < sizeof(struct acpi_table_mcfg))\r\nreturn -EINVAL;\r\nn = (header->length - sizeof(struct acpi_table_mcfg)) /\r\nsizeof(struct acpi_mcfg_allocation);\r\nmcfg = (struct acpi_table_mcfg *)header;\r\nmptr = (struct acpi_mcfg_allocation *) &mcfg[1];\r\narr = kcalloc(n, sizeof(*arr), GFP_KERNEL);\r\nif (!arr)\r\nreturn -ENOMEM;\r\nfor (i = 0, e = arr; i < n; i++, mptr++, e++) {\r\ne->segment = mptr->pci_segment;\r\ne->addr = mptr->address;\r\ne->bus_start = mptr->start_bus_number;\r\ne->bus_end = mptr->end_bus_number;\r\nlist_add(&e->list, &pci_mcfg_list);\r\n}\r\npr_info("MCFG table detected, %d entries\n", n);\r\nreturn 0;\r\n}\r\nvoid __init pci_mmcfg_late_init(void)\r\n{\r\nint err = acpi_table_parse(ACPI_SIG_MCFG, pci_mcfg_parse);\r\nif (err)\r\npr_err("Failed to parse MCFG (%d)\n", err);\r\n}

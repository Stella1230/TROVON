int ps2_sendbyte(struct ps2dev *ps2dev, unsigned char byte, int timeout)\r\n{\r\nserio_pause_rx(ps2dev->serio);\r\nps2dev->nak = 1;\r\nps2dev->flags |= PS2_FLAG_ACK;\r\nserio_continue_rx(ps2dev->serio);\r\nif (serio_write(ps2dev->serio, byte) == 0)\r\nwait_event_timeout(ps2dev->wait,\r\n!(ps2dev->flags & PS2_FLAG_ACK),\r\nmsecs_to_jiffies(timeout));\r\nserio_pause_rx(ps2dev->serio);\r\nps2dev->flags &= ~PS2_FLAG_ACK;\r\nserio_continue_rx(ps2dev->serio);\r\nreturn -ps2dev->nak;\r\n}\r\nvoid ps2_begin_command(struct ps2dev *ps2dev)\r\n{\r\nstruct mutex *m = ps2dev->serio->ps2_cmd_mutex ?: &ps2dev->cmd_mutex;\r\nmutex_lock(m);\r\n}\r\nvoid ps2_end_command(struct ps2dev *ps2dev)\r\n{\r\nstruct mutex *m = ps2dev->serio->ps2_cmd_mutex ?: &ps2dev->cmd_mutex;\r\nmutex_unlock(m);\r\n}\r\nvoid ps2_drain(struct ps2dev *ps2dev, int maxbytes, int timeout)\r\n{\r\nif (maxbytes > sizeof(ps2dev->cmdbuf)) {\r\nWARN_ON(1);\r\nmaxbytes = sizeof(ps2dev->cmdbuf);\r\n}\r\nps2_begin_command(ps2dev);\r\nserio_pause_rx(ps2dev->serio);\r\nps2dev->flags = PS2_FLAG_CMD;\r\nps2dev->cmdcnt = maxbytes;\r\nserio_continue_rx(ps2dev->serio);\r\nwait_event_timeout(ps2dev->wait,\r\n!(ps2dev->flags & PS2_FLAG_CMD),\r\nmsecs_to_jiffies(timeout));\r\nps2_end_command(ps2dev);\r\n}\r\nint ps2_is_keyboard_id(char id_byte)\r\n{\r\nstatic const char keyboard_ids[] = {\r\n0xab,\r\n0xac,\r\n0x2b,\r\n0x5d,\r\n0x60,\r\n0x47,\r\n};\r\nreturn memchr(keyboard_ids, id_byte, sizeof(keyboard_ids)) != NULL;\r\n}\r\nstatic int ps2_adjust_timeout(struct ps2dev *ps2dev, int command, int timeout)\r\n{\r\nswitch (command) {\r\ncase PS2_CMD_RESET_BAT:\r\nif (timeout > msecs_to_jiffies(100))\r\ntimeout = msecs_to_jiffies(100);\r\nbreak;\r\ncase PS2_CMD_GETID:\r\nif (ps2dev->cmdbuf[1] == 0xaa) {\r\nserio_pause_rx(ps2dev->serio);\r\nps2dev->flags = 0;\r\nserio_continue_rx(ps2dev->serio);\r\ntimeout = 0;\r\n}\r\nif (!ps2_is_keyboard_id(ps2dev->cmdbuf[1])) {\r\nserio_pause_rx(ps2dev->serio);\r\nps2dev->flags = ps2dev->cmdcnt = 0;\r\nserio_continue_rx(ps2dev->serio);\r\ntimeout = 0;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn timeout;\r\n}\r\nint __ps2_command(struct ps2dev *ps2dev, unsigned char *param, int command)\r\n{\r\nint timeout;\r\nint send = (command >> 12) & 0xf;\r\nint receive = (command >> 8) & 0xf;\r\nint rc = -1;\r\nint i;\r\nif (receive > sizeof(ps2dev->cmdbuf)) {\r\nWARN_ON(1);\r\nreturn -1;\r\n}\r\nif (send && !param) {\r\nWARN_ON(1);\r\nreturn -1;\r\n}\r\nserio_pause_rx(ps2dev->serio);\r\nps2dev->flags = command == PS2_CMD_GETID ? PS2_FLAG_WAITID : 0;\r\nps2dev->cmdcnt = receive;\r\nif (receive && param)\r\nfor (i = 0; i < receive; i++)\r\nps2dev->cmdbuf[(receive - 1) - i] = param[i];\r\nserio_continue_rx(ps2dev->serio);\r\nif (ps2_sendbyte(ps2dev, command & 0xff,\r\ncommand == PS2_CMD_RESET_BAT ? 1000 : 200)) {\r\nserio_pause_rx(ps2dev->serio);\r\ngoto out_reset_flags;\r\n}\r\nfor (i = 0; i < send; i++) {\r\nif (ps2_sendbyte(ps2dev, param[i], 200)) {\r\nserio_pause_rx(ps2dev->serio);\r\ngoto out_reset_flags;\r\n}\r\n}\r\ntimeout = msecs_to_jiffies(command == PS2_CMD_RESET_BAT ? 4000 : 500);\r\ntimeout = wait_event_timeout(ps2dev->wait,\r\n!(ps2dev->flags & PS2_FLAG_CMD1), timeout);\r\nif (ps2dev->cmdcnt && !(ps2dev->flags & PS2_FLAG_CMD1)) {\r\ntimeout = ps2_adjust_timeout(ps2dev, command, timeout);\r\nwait_event_timeout(ps2dev->wait,\r\n!(ps2dev->flags & PS2_FLAG_CMD), timeout);\r\n}\r\nserio_pause_rx(ps2dev->serio);\r\nif (param)\r\nfor (i = 0; i < receive; i++)\r\nparam[i] = ps2dev->cmdbuf[(receive - 1) - i];\r\nif (ps2dev->cmdcnt && (command != PS2_CMD_RESET_BAT || ps2dev->cmdcnt != 1))\r\ngoto out_reset_flags;\r\nrc = 0;\r\nout_reset_flags:\r\nps2dev->flags = 0;\r\nserio_continue_rx(ps2dev->serio);\r\nreturn rc;\r\n}\r\nint ps2_command(struct ps2dev *ps2dev, unsigned char *param, int command)\r\n{\r\nint rc;\r\nps2_begin_command(ps2dev);\r\nrc = __ps2_command(ps2dev, param, command);\r\nps2_end_command(ps2dev);\r\nreturn rc;\r\n}\r\nvoid ps2_init(struct ps2dev *ps2dev, struct serio *serio)\r\n{\r\nmutex_init(&ps2dev->cmd_mutex);\r\nlockdep_set_subclass(&ps2dev->cmd_mutex, serio->depth);\r\ninit_waitqueue_head(&ps2dev->wait);\r\nps2dev->serio = serio;\r\n}\r\nint ps2_handle_ack(struct ps2dev *ps2dev, unsigned char data)\r\n{\r\nswitch (data) {\r\ncase PS2_RET_ACK:\r\nps2dev->nak = 0;\r\nbreak;\r\ncase PS2_RET_NAK:\r\nps2dev->flags |= PS2_FLAG_NAK;\r\nps2dev->nak = PS2_RET_NAK;\r\nbreak;\r\ncase PS2_RET_ERR:\r\nif (ps2dev->flags & PS2_FLAG_NAK) {\r\nps2dev->flags &= ~PS2_FLAG_NAK;\r\nps2dev->nak = PS2_RET_ERR;\r\nbreak;\r\n}\r\ncase 0x00:\r\ncase 0x03:\r\ncase 0x04:\r\nif (ps2dev->flags & PS2_FLAG_WAITID) {\r\nps2dev->nak = 0;\r\nbreak;\r\n}\r\ndefault:\r\nreturn 0;\r\n}\r\nif (!ps2dev->nak) {\r\nps2dev->flags &= ~PS2_FLAG_NAK;\r\nif (ps2dev->cmdcnt)\r\nps2dev->flags |= PS2_FLAG_CMD | PS2_FLAG_CMD1;\r\n}\r\nps2dev->flags &= ~PS2_FLAG_ACK;\r\nwake_up(&ps2dev->wait);\r\nif (data != PS2_RET_ACK)\r\nps2_handle_response(ps2dev, data);\r\nreturn 1;\r\n}\r\nint ps2_handle_response(struct ps2dev *ps2dev, unsigned char data)\r\n{\r\nif (ps2dev->cmdcnt)\r\nps2dev->cmdbuf[--ps2dev->cmdcnt] = data;\r\nif (ps2dev->flags & PS2_FLAG_CMD1) {\r\nps2dev->flags &= ~PS2_FLAG_CMD1;\r\nif (ps2dev->cmdcnt)\r\nwake_up(&ps2dev->wait);\r\n}\r\nif (!ps2dev->cmdcnt) {\r\nps2dev->flags &= ~PS2_FLAG_CMD;\r\nwake_up(&ps2dev->wait);\r\n}\r\nreturn 1;\r\n}\r\nvoid ps2_cmd_aborted(struct ps2dev *ps2dev)\r\n{\r\nif (ps2dev->flags & PS2_FLAG_ACK)\r\nps2dev->nak = 1;\r\nif (ps2dev->flags & (PS2_FLAG_ACK | PS2_FLAG_CMD))\r\nwake_up(&ps2dev->wait);\r\nps2dev->flags &= PS2_FLAG_NAK;\r\n}

static int devfreq_passive_get_target_freq(struct devfreq *devfreq,\r\nunsigned long *freq)\r\n{\r\nstruct devfreq_passive_data *p_data\r\n= (struct devfreq_passive_data *)devfreq->data;\r\nstruct devfreq *parent_devfreq = (struct devfreq *)p_data->parent;\r\nunsigned long child_freq = ULONG_MAX;\r\nstruct dev_pm_opp *opp;\r\nint i, count, ret = 0;\r\nif (p_data->get_target_freq) {\r\nret = p_data->get_target_freq(devfreq, freq);\r\ngoto out;\r\n}\r\nif (!devfreq->profile || !devfreq->profile->freq_table\r\n|| devfreq->profile->max_state <= 0)\r\nreturn -EINVAL;\r\nrcu_read_lock();\r\nopp = devfreq_recommended_opp(parent_devfreq->dev.parent, freq, 0);\r\nrcu_read_unlock();\r\nif (IS_ERR(opp)) {\r\nret = PTR_ERR(opp);\r\ngoto out;\r\n}\r\nfor (i = 0; i < parent_devfreq->profile->max_state; i++)\r\nif (parent_devfreq->profile->freq_table[i] == *freq)\r\nbreak;\r\nif (i == parent_devfreq->profile->max_state) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nif (i < devfreq->profile->max_state) {\r\nchild_freq = devfreq->profile->freq_table[i];\r\n} else {\r\ncount = devfreq->profile->max_state;\r\nchild_freq = devfreq->profile->freq_table[count - 1];\r\n}\r\n*freq = child_freq;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int update_devfreq_passive(struct devfreq *devfreq, unsigned long freq)\r\n{\r\nint ret;\r\nif (!devfreq->governor)\r\nreturn -EINVAL;\r\nmutex_lock_nested(&devfreq->lock, SINGLE_DEPTH_NESTING);\r\nret = devfreq->governor->get_target_freq(devfreq, &freq);\r\nif (ret < 0)\r\ngoto out;\r\nret = devfreq->profile->target(devfreq->dev.parent, &freq, 0);\r\nif (ret < 0)\r\ngoto out;\r\ndevfreq->previous_freq = freq;\r\nout:\r\nmutex_unlock(&devfreq->lock);\r\nreturn 0;\r\n}\r\nstatic int devfreq_passive_notifier_call(struct notifier_block *nb,\r\nunsigned long event, void *ptr)\r\n{\r\nstruct devfreq_passive_data *data\r\n= container_of(nb, struct devfreq_passive_data, nb);\r\nstruct devfreq *devfreq = (struct devfreq *)data->this;\r\nstruct devfreq *parent = (struct devfreq *)data->parent;\r\nstruct devfreq_freqs *freqs = (struct devfreq_freqs *)ptr;\r\nunsigned long freq = freqs->new;\r\nswitch (event) {\r\ncase DEVFREQ_PRECHANGE:\r\nif (parent->previous_freq > freq)\r\nupdate_devfreq_passive(devfreq, freq);\r\nbreak;\r\ncase DEVFREQ_POSTCHANGE:\r\nif (parent->previous_freq < freq)\r\nupdate_devfreq_passive(devfreq, freq);\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int devfreq_passive_event_handler(struct devfreq *devfreq,\r\nunsigned int event, void *data)\r\n{\r\nstruct device *dev = devfreq->dev.parent;\r\nstruct devfreq_passive_data *p_data\r\n= (struct devfreq_passive_data *)devfreq->data;\r\nstruct devfreq *parent = (struct devfreq *)p_data->parent;\r\nstruct notifier_block *nb = &p_data->nb;\r\nint ret = 0;\r\nif (!parent)\r\nreturn -EPROBE_DEFER;\r\nswitch (event) {\r\ncase DEVFREQ_GOV_START:\r\nif (!p_data->this)\r\np_data->this = devfreq;\r\nnb->notifier_call = devfreq_passive_notifier_call;\r\nret = devm_devfreq_register_notifier(dev, parent, nb,\r\nDEVFREQ_TRANSITION_NOTIFIER);\r\nbreak;\r\ncase DEVFREQ_GOV_STOP:\r\ndevm_devfreq_unregister_notifier(dev, parent, nb,\r\nDEVFREQ_TRANSITION_NOTIFIER);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init devfreq_passive_init(void)\r\n{\r\nreturn devfreq_add_governor(&devfreq_passive);\r\n}\r\nstatic void __exit devfreq_passive_exit(void)\r\n{\r\nint ret;\r\nret = devfreq_remove_governor(&devfreq_passive);\r\nif (ret)\r\npr_err("%s: failed remove governor %d\n", __func__, ret);\r\n}

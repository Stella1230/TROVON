static unsigned int hi6220_acpu_get_freq(struct hi6220_stub_clk *stub_clk)\r\n{\r\nunsigned int freq;\r\nregmap_read(stub_clk->dfs_map, ACPU_DFS_CUR_FREQ, &freq);\r\nreturn freq;\r\n}\r\nstatic int hi6220_acpu_set_freq(struct hi6220_stub_clk *stub_clk,\r\nunsigned int freq)\r\n{\r\nunion hi6220_mbox_data data;\r\nregmap_write(stub_clk->dfs_map, ACPU_DFS_FREQ_REQ, freq);\r\ndata.msg.type = HI6220_MBOX_FREQ;\r\ndata.msg.cmd = HI6220_MBOX_CMD_SET;\r\ndata.msg.obj = HI6220_MBOX_OBJ_AP;\r\ndata.msg.src = HI6220_MBOX_OBJ_AP;\r\nmbox_send_message(stub_clk->mbox, &data);\r\nreturn 0;\r\n}\r\nstatic int hi6220_acpu_round_freq(struct hi6220_stub_clk *stub_clk,\r\nunsigned int freq)\r\n{\r\nunsigned int limit_flag, limit_freq = UINT_MAX;\r\nunsigned int max_freq;\r\nregmap_read(stub_clk->dfs_map, ACPU_DFS_FLAG, &limit_flag);\r\nif (limit_flag == ACPU_DFS_LOCK_FLAG)\r\nregmap_read(stub_clk->dfs_map, ACPU_DFS_FREQ_LMT, &limit_freq);\r\nregmap_read(stub_clk->dfs_map, ACPU_DFS_FREQ_MAX, &max_freq);\r\nmax_freq = min(max_freq, limit_freq);\r\nif (WARN_ON(freq > max_freq))\r\nfreq = max_freq;\r\nreturn freq;\r\n}\r\nstatic unsigned long hi6220_stub_clk_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nu32 rate = 0;\r\nstruct hi6220_stub_clk *stub_clk = to_stub_clk(hw);\r\nswitch (stub_clk->id) {\r\ncase HI6220_STUB_ACPU0:\r\nrate = hi6220_acpu_get_freq(stub_clk);\r\nrate *= 1000;\r\nbreak;\r\ndefault:\r\ndev_err(stub_clk->dev, "%s: un-supported clock id %d\n",\r\n__func__, stub_clk->id);\r\nbreak;\r\n}\r\nreturn rate;\r\n}\r\nstatic int hi6220_stub_clk_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct hi6220_stub_clk *stub_clk = to_stub_clk(hw);\r\nunsigned long new_rate = rate / 1000;\r\nint ret = 0;\r\nswitch (stub_clk->id) {\r\ncase HI6220_STUB_ACPU0:\r\nret = hi6220_acpu_set_freq(stub_clk, new_rate);\r\nif (ret < 0)\r\nreturn ret;\r\nbreak;\r\ndefault:\r\ndev_err(stub_clk->dev, "%s: un-supported clock id %d\n",\r\n__func__, stub_clk->id);\r\nbreak;\r\n}\r\npr_debug("%s: set rate=%ldkHz\n", __func__, new_rate);\r\nreturn ret;\r\n}\r\nstatic long hi6220_stub_clk_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nstruct hi6220_stub_clk *stub_clk = to_stub_clk(hw);\r\nunsigned long new_rate = rate / 1000;\r\nswitch (stub_clk->id) {\r\ncase HI6220_STUB_ACPU0:\r\nnew_rate = hi6220_acpu_round_freq(stub_clk, new_rate);\r\nnew_rate *= 1000;\r\nbreak;\r\ndefault:\r\ndev_err(stub_clk->dev, "%s: un-supported clock id %d\n",\r\n__func__, stub_clk->id);\r\nbreak;\r\n}\r\nreturn new_rate;\r\n}\r\nstatic int hi6220_stub_clk_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct clk_init_data init;\r\nstruct hi6220_stub_clk *stub_clk;\r\nstruct clk *clk;\r\nstruct device_node *np = pdev->dev.of_node;\r\nint ret;\r\nstub_clk = devm_kzalloc(dev, sizeof(*stub_clk), GFP_KERNEL);\r\nif (!stub_clk)\r\nreturn -ENOMEM;\r\nstub_clk->dfs_map = syscon_regmap_lookup_by_phandle(np,\r\n"hisilicon,hi6220-clk-sram");\r\nif (IS_ERR(stub_clk->dfs_map)) {\r\ndev_err(dev, "failed to get sram regmap\n");\r\nreturn PTR_ERR(stub_clk->dfs_map);\r\n}\r\nstub_clk->hw.init = &init;\r\nstub_clk->dev = dev;\r\nstub_clk->id = HI6220_STUB_ACPU0;\r\nstub_clk->cl.dev = dev;\r\nstub_clk->cl.tx_done = NULL;\r\nstub_clk->cl.tx_block = true;\r\nstub_clk->cl.tx_tout = 500;\r\nstub_clk->cl.knows_txdone = false;\r\nstub_clk->mbox = mbox_request_channel(&stub_clk->cl, 0);\r\nif (IS_ERR(stub_clk->mbox)) {\r\ndev_err(dev, "failed get mailbox channel\n");\r\nreturn PTR_ERR(stub_clk->mbox);\r\n}\r\ninit.name = "acpu0";\r\ninit.ops = &hi6220_stub_clk_ops;\r\ninit.num_parents = 0;\r\ninit.flags = 0;\r\nclk = devm_clk_register(dev, &stub_clk->hw);\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nret = of_clk_add_provider(np, of_clk_src_simple_get, clk);\r\nif (ret) {\r\ndev_err(dev, "failed to register OF clock provider\n");\r\nreturn ret;\r\n}\r\nregmap_write(stub_clk->dfs_map, ACPU_DFS_FLAG, 0x0);\r\nregmap_write(stub_clk->dfs_map, ACPU_DFS_FREQ_REQ, 0x0);\r\nregmap_write(stub_clk->dfs_map, ACPU_DFS_FREQ_LMT, 0x0);\r\ndev_dbg(dev, "Registered clock '%s'\n", init.name);\r\nreturn 0;\r\n}\r\nstatic int __init hi6220_stub_clk_init(void)\r\n{\r\nreturn platform_driver_register(&hi6220_stub_clk_driver);\r\n}

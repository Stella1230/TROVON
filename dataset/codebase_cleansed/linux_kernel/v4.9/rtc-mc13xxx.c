static int mc13xxx_rtc_irq_enable_unlocked(struct device *dev,\r\nunsigned int enabled, int irq)\r\n{\r\nstruct mc13xxx_rtc *priv = dev_get_drvdata(dev);\r\nint (*func)(struct mc13xxx *mc13xxx, int irq);\r\nif (!priv->valid)\r\nreturn -ENODATA;\r\nfunc = enabled ? mc13xxx_irq_unmask : mc13xxx_irq_mask;\r\nreturn func(priv->mc13xxx, irq);\r\n}\r\nstatic int mc13xxx_rtc_alarm_irq_enable(struct device *dev,\r\nunsigned int enabled)\r\n{\r\nstruct mc13xxx_rtc *priv = dev_get_drvdata(dev);\r\nint ret;\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_rtc_irq_enable_unlocked(dev, enabled, MC13XXX_IRQ_TODA);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nreturn ret;\r\n}\r\nstatic int mc13xxx_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct mc13xxx_rtc *priv = dev_get_drvdata(dev);\r\nunsigned int seconds, days1, days2;\r\nif (!priv->valid)\r\nreturn -ENODATA;\r\ndo {\r\nint ret;\r\nret = mc13xxx_reg_read(priv->mc13xxx, MC13XXX_RTCDAY, &days1);\r\nif (ret)\r\nreturn ret;\r\nret = mc13xxx_reg_read(priv->mc13xxx, MC13XXX_RTCTOD, &seconds);\r\nif (ret)\r\nreturn ret;\r\nret = mc13xxx_reg_read(priv->mc13xxx, MC13XXX_RTCDAY, &days2);\r\nif (ret)\r\nreturn ret;\r\n} while (days1 != days2);\r\nrtc_time64_to_tm((time64_t)days1 * SEC_PER_DAY + seconds, tm);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int mc13xxx_rtc_set_mmss(struct device *dev, time64_t secs)\r\n{\r\nstruct mc13xxx_rtc *priv = dev_get_drvdata(dev);\r\nunsigned int seconds, days;\r\nunsigned int alarmseconds;\r\nint ret;\r\ndays = div_s64_rem(secs, SEC_PER_DAY, &seconds);\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_read(priv->mc13xxx, MC13XXX_RTCTODA, &alarmseconds);\r\nif (unlikely(ret))\r\ngoto out;\r\nif (alarmseconds < SEC_PER_DAY) {\r\nret = mc13xxx_reg_write(priv->mc13xxx,\r\nMC13XXX_RTCTODA, 0x1ffff);\r\nif (unlikely(ret))\r\ngoto out;\r\n}\r\nret = mc13xxx_reg_write(priv->mc13xxx, MC13XXX_RTCTOD, 0);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = mc13xxx_reg_write(priv->mc13xxx, MC13XXX_RTCDAY, days);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = mc13xxx_reg_write(priv->mc13xxx, MC13XXX_RTCTOD, seconds);\r\nif (unlikely(ret))\r\ngoto out;\r\nif (alarmseconds < SEC_PER_DAY) {\r\nret = mc13xxx_reg_write(priv->mc13xxx,\r\nMC13XXX_RTCTODA, alarmseconds);\r\nif (unlikely(ret))\r\ngoto out;\r\n}\r\nif (!priv->valid) {\r\nret = mc13xxx_irq_ack(priv->mc13xxx, MC13XXX_IRQ_RTCRST);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = mc13xxx_irq_unmask(priv->mc13xxx, MC13XXX_IRQ_RTCRST);\r\n}\r\nout:\r\npriv->valid = !ret;\r\nmc13xxx_unlock(priv->mc13xxx);\r\nreturn ret;\r\n}\r\nstatic int mc13xxx_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nstruct mc13xxx_rtc *priv = dev_get_drvdata(dev);\r\nunsigned seconds, days;\r\ntime64_t s1970;\r\nint enabled, pending;\r\nint ret;\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_read(priv->mc13xxx, MC13XXX_RTCTODA, &seconds);\r\nif (unlikely(ret))\r\ngoto out;\r\nif (seconds >= SEC_PER_DAY) {\r\nret = -ENODATA;\r\ngoto out;\r\n}\r\nret = mc13xxx_reg_read(priv->mc13xxx, MC13XXX_RTCDAY, &days);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = mc13xxx_irq_status(priv->mc13xxx, MC13XXX_IRQ_TODA,\r\n&enabled, &pending);\r\nout:\r\nmc13xxx_unlock(priv->mc13xxx);\r\nif (ret)\r\nreturn ret;\r\nalarm->enabled = enabled;\r\nalarm->pending = pending;\r\ns1970 = (time64_t)days * SEC_PER_DAY + seconds;\r\nrtc_time64_to_tm(s1970, &alarm->time);\r\ndev_dbg(dev, "%s: %lld\n", __func__, (long long)s1970);\r\nreturn 0;\r\n}\r\nstatic int mc13xxx_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nstruct mc13xxx_rtc *priv = dev_get_drvdata(dev);\r\ntime64_t s1970;\r\nu32 seconds, days;\r\nint ret;\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_write(priv->mc13xxx, MC13XXX_RTCTODA, 0x1ffff);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = mc13xxx_irq_ack(priv->mc13xxx, MC13XXX_IRQ_TODA);\r\nif (unlikely(ret))\r\ngoto out;\r\ns1970 = rtc_tm_to_time64(&alarm->time);\r\ndev_dbg(dev, "%s: %s %lld\n", __func__, alarm->enabled ? "on" : "off",\r\n(long long)s1970);\r\nret = mc13xxx_rtc_irq_enable_unlocked(dev, alarm->enabled,\r\nMC13XXX_IRQ_TODA);\r\nif (unlikely(ret))\r\ngoto out;\r\ndays = div_s64_rem(s1970, SEC_PER_DAY, &seconds);\r\nret = mc13xxx_reg_write(priv->mc13xxx, MC13XXX_RTCDAYA, days);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = mc13xxx_reg_write(priv->mc13xxx, MC13XXX_RTCTODA, seconds);\r\nout:\r\nmc13xxx_unlock(priv->mc13xxx);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t mc13xxx_rtc_alarm_handler(int irq, void *dev)\r\n{\r\nstruct mc13xxx_rtc *priv = dev;\r\nstruct mc13xxx *mc13xxx = priv->mc13xxx;\r\nrtc_update_irq(priv->rtc, 1, RTC_IRQF | RTC_AF);\r\nmc13xxx_irq_ack(mc13xxx, irq);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t mc13xxx_rtc_reset_handler(int irq, void *dev)\r\n{\r\nstruct mc13xxx_rtc *priv = dev;\r\nstruct mc13xxx *mc13xxx = priv->mc13xxx;\r\npriv->valid = 0;\r\nmc13xxx_irq_mask(mc13xxx, irq);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init mc13xxx_rtc_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct mc13xxx_rtc *priv;\r\nstruct mc13xxx *mc13xxx;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nmc13xxx = dev_get_drvdata(pdev->dev.parent);\r\npriv->mc13xxx = mc13xxx;\r\npriv->valid = 1;\r\nplatform_set_drvdata(pdev, priv);\r\nmc13xxx_lock(mc13xxx);\r\nmc13xxx_irq_ack(mc13xxx, MC13XXX_IRQ_RTCRST);\r\nret = mc13xxx_irq_request(mc13xxx, MC13XXX_IRQ_RTCRST,\r\nmc13xxx_rtc_reset_handler, DRIVER_NAME, priv);\r\nif (ret)\r\ngoto err_irq_request;\r\nret = mc13xxx_irq_request_nounmask(mc13xxx, MC13XXX_IRQ_TODA,\r\nmc13xxx_rtc_alarm_handler, DRIVER_NAME, priv);\r\nif (ret)\r\ngoto err_irq_request;\r\nmc13xxx_unlock(mc13xxx);\r\npriv->rtc = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&mc13xxx_rtc_ops, THIS_MODULE);\r\nreturn 0;\r\nerr_irq_request:\r\nmc13xxx_irq_free(mc13xxx, MC13XXX_IRQ_TODA, priv);\r\nmc13xxx_irq_free(mc13xxx, MC13XXX_IRQ_RTCRST, priv);\r\nmc13xxx_unlock(mc13xxx);\r\nreturn ret;\r\n}\r\nstatic int mc13xxx_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct mc13xxx_rtc *priv = platform_get_drvdata(pdev);\r\nmc13xxx_lock(priv->mc13xxx);\r\nmc13xxx_irq_free(priv->mc13xxx, MC13XXX_IRQ_TODA, priv);\r\nmc13xxx_irq_free(priv->mc13xxx, MC13XXX_IRQ_RTCRST, priv);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nreturn 0;\r\n}

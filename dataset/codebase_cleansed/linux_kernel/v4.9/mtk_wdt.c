static int mtk_wdt_restart(struct watchdog_device *wdt_dev,\r\nunsigned long action, void *data)\r\n{\r\nstruct mtk_wdt_dev *mtk_wdt = watchdog_get_drvdata(wdt_dev);\r\nvoid __iomem *wdt_base;\r\nwdt_base = mtk_wdt->wdt_base;\r\nwhile (1) {\r\nwritel(WDT_SWRST_KEY, wdt_base + WDT_SWRST);\r\nmdelay(5);\r\n}\r\nreturn 0;\r\n}\r\nstatic int mtk_wdt_ping(struct watchdog_device *wdt_dev)\r\n{\r\nstruct mtk_wdt_dev *mtk_wdt = watchdog_get_drvdata(wdt_dev);\r\nvoid __iomem *wdt_base = mtk_wdt->wdt_base;\r\niowrite32(WDT_RST_RELOAD, wdt_base + WDT_RST);\r\nreturn 0;\r\n}\r\nstatic int mtk_wdt_set_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int timeout)\r\n{\r\nstruct mtk_wdt_dev *mtk_wdt = watchdog_get_drvdata(wdt_dev);\r\nvoid __iomem *wdt_base = mtk_wdt->wdt_base;\r\nu32 reg;\r\nwdt_dev->timeout = timeout;\r\nreg = WDT_LENGTH_TIMEOUT(timeout << 6) | WDT_LENGTH_KEY;\r\niowrite32(reg, wdt_base + WDT_LENGTH);\r\nmtk_wdt_ping(wdt_dev);\r\nreturn 0;\r\n}\r\nstatic int mtk_wdt_stop(struct watchdog_device *wdt_dev)\r\n{\r\nstruct mtk_wdt_dev *mtk_wdt = watchdog_get_drvdata(wdt_dev);\r\nvoid __iomem *wdt_base = mtk_wdt->wdt_base;\r\nu32 reg;\r\nreg = readl(wdt_base + WDT_MODE);\r\nreg &= ~WDT_MODE_EN;\r\nreg |= WDT_MODE_KEY;\r\niowrite32(reg, wdt_base + WDT_MODE);\r\nreturn 0;\r\n}\r\nstatic int mtk_wdt_start(struct watchdog_device *wdt_dev)\r\n{\r\nu32 reg;\r\nstruct mtk_wdt_dev *mtk_wdt = watchdog_get_drvdata(wdt_dev);\r\nvoid __iomem *wdt_base = mtk_wdt->wdt_base;\r\nint ret;\r\nret = mtk_wdt_set_timeout(wdt_dev, wdt_dev->timeout);\r\nif (ret < 0)\r\nreturn ret;\r\nreg = ioread32(wdt_base + WDT_MODE);\r\nreg &= ~(WDT_MODE_IRQ_EN | WDT_MODE_DUAL_EN);\r\nreg |= (WDT_MODE_EN | WDT_MODE_KEY);\r\niowrite32(reg, wdt_base + WDT_MODE);\r\nreturn 0;\r\n}\r\nstatic int mtk_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct mtk_wdt_dev *mtk_wdt;\r\nstruct resource *res;\r\nint err;\r\nmtk_wdt = devm_kzalloc(&pdev->dev, sizeof(*mtk_wdt), GFP_KERNEL);\r\nif (!mtk_wdt)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, mtk_wdt);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nmtk_wdt->wdt_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(mtk_wdt->wdt_base))\r\nreturn PTR_ERR(mtk_wdt->wdt_base);\r\nmtk_wdt->wdt_dev.info = &mtk_wdt_info;\r\nmtk_wdt->wdt_dev.ops = &mtk_wdt_ops;\r\nmtk_wdt->wdt_dev.timeout = WDT_MAX_TIMEOUT;\r\nmtk_wdt->wdt_dev.max_timeout = WDT_MAX_TIMEOUT;\r\nmtk_wdt->wdt_dev.min_timeout = WDT_MIN_TIMEOUT;\r\nmtk_wdt->wdt_dev.parent = &pdev->dev;\r\nwatchdog_init_timeout(&mtk_wdt->wdt_dev, timeout, &pdev->dev);\r\nwatchdog_set_nowayout(&mtk_wdt->wdt_dev, nowayout);\r\nwatchdog_set_restart_priority(&mtk_wdt->wdt_dev, 128);\r\nwatchdog_set_drvdata(&mtk_wdt->wdt_dev, mtk_wdt);\r\nmtk_wdt_stop(&mtk_wdt->wdt_dev);\r\nerr = watchdog_register_device(&mtk_wdt->wdt_dev);\r\nif (unlikely(err))\r\nreturn err;\r\ndev_info(&pdev->dev, "Watchdog enabled (timeout=%d sec, nowayout=%d)\n",\r\nmtk_wdt->wdt_dev.timeout, nowayout);\r\nreturn 0;\r\n}\r\nstatic void mtk_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nstruct mtk_wdt_dev *mtk_wdt = platform_get_drvdata(pdev);\r\nif (watchdog_active(&mtk_wdt->wdt_dev))\r\nmtk_wdt_stop(&mtk_wdt->wdt_dev);\r\n}\r\nstatic int mtk_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct mtk_wdt_dev *mtk_wdt = platform_get_drvdata(pdev);\r\nwatchdog_unregister_device(&mtk_wdt->wdt_dev);\r\nreturn 0;\r\n}\r\nstatic int mtk_wdt_suspend(struct device *dev)\r\n{\r\nstruct mtk_wdt_dev *mtk_wdt = dev_get_drvdata(dev);\r\nif (watchdog_active(&mtk_wdt->wdt_dev))\r\nmtk_wdt_stop(&mtk_wdt->wdt_dev);\r\nreturn 0;\r\n}\r\nstatic int mtk_wdt_resume(struct device *dev)\r\n{\r\nstruct mtk_wdt_dev *mtk_wdt = dev_get_drvdata(dev);\r\nif (watchdog_active(&mtk_wdt->wdt_dev)) {\r\nmtk_wdt_start(&mtk_wdt->wdt_dev);\r\nmtk_wdt_ping(&mtk_wdt->wdt_dev);\r\n}\r\nreturn 0;\r\n}

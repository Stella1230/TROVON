int intel_gvt_init_host(void)\r\n{\r\nif (intel_gvt_host.initialized)\r\nreturn 0;\r\nif (xen_domain() && !xen_initial_domain())\r\nreturn -ENODEV;\r\nif (xen_initial_domain()) {\r\nintel_gvt_host.mpt = try_then_request_module(\r\nsymbol_get(xengt_mpt), "xengt");\r\nintel_gvt_host.hypervisor_type = INTEL_GVT_HYPERVISOR_XEN;\r\n} else {\r\nintel_gvt_host.mpt = try_then_request_module(\r\nsymbol_get(kvmgt_mpt), "kvm");\r\nintel_gvt_host.hypervisor_type = INTEL_GVT_HYPERVISOR_KVM;\r\n}\r\nif (!intel_gvt_host.mpt)\r\nreturn -EINVAL;\r\nif (!intel_gvt_hypervisor_detect_host())\r\nreturn -ENODEV;\r\ngvt_dbg_core("Running with hypervisor %s in host mode\n",\r\nsupported_hypervisors[intel_gvt_host.hypervisor_type]);\r\nintel_gvt_host.initialized = true;\r\nreturn 0;\r\n}\r\nstatic void init_device_info(struct intel_gvt *gvt)\r\n{\r\nif (IS_BROADWELL(gvt->dev_priv))\r\ngvt->device_info.max_support_vgpus = 8;\r\n}\r\nvoid intel_gvt_clean_device(struct drm_i915_private *dev_priv)\r\n{\r\nstruct intel_gvt *gvt = &dev_priv->gvt;\r\nif (WARN_ON(!gvt->initialized))\r\nreturn;\r\ngvt->initialized = false;\r\n}\r\nint intel_gvt_init_device(struct drm_i915_private *dev_priv)\r\n{\r\nstruct intel_gvt *gvt = &dev_priv->gvt;\r\nif (WARN_ON(!intel_gvt_host.initialized))\r\nreturn -EINVAL;\r\nif (WARN_ON(gvt->initialized))\r\nreturn -EEXIST;\r\ngvt_dbg_core("init gvt device\n");\r\ninit_device_info(gvt);\r\ngvt_dbg_core("gvt device creation is done\n");\r\ngvt->initialized = true;\r\nreturn 0;\r\n}

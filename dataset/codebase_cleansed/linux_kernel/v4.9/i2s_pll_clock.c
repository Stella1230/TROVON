static inline void i2s_pll_write(struct i2s_pll_clk *clk, unsigned int reg,\r\nunsigned int val)\r\n{\r\nwritel_relaxed(val, clk->base + reg);\r\n}\r\nstatic inline unsigned int i2s_pll_read(struct i2s_pll_clk *clk,\r\nunsigned int reg)\r\n{\r\nreturn readl_relaxed(clk->base + reg);\r\n}\r\nstatic inline struct i2s_pll_clk *to_i2s_pll_clk(struct clk_hw *hw)\r\n{\r\nreturn container_of(hw, struct i2s_pll_clk, hw);\r\n}\r\nstatic inline unsigned int i2s_pll_get_value(unsigned int val)\r\n{\r\nreturn (val & 0x3F) + ((val >> 6) & 0x3F);\r\n}\r\nstatic const struct i2s_pll_cfg *i2s_pll_get_cfg(unsigned long prate)\r\n{\r\nswitch (prate) {\r\ncase 27000000:\r\nreturn i2s_pll_cfg_27m;\r\ncase 28224000:\r\nreturn i2s_pll_cfg_28m;\r\ndefault:\r\nreturn NULL;\r\n}\r\n}\r\nstatic unsigned long i2s_pll_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct i2s_pll_clk *clk = to_i2s_pll_clk(hw);\r\nunsigned int idiv, fbdiv, odiv;\r\nidiv = i2s_pll_get_value(i2s_pll_read(clk, PLL_IDIV_REG));\r\nfbdiv = i2s_pll_get_value(i2s_pll_read(clk, PLL_FBDIV_REG));\r\nodiv = i2s_pll_get_value(i2s_pll_read(clk, PLL_ODIV0_REG));\r\nreturn ((parent_rate / idiv) * fbdiv) / odiv;\r\n}\r\nstatic long i2s_pll_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *prate)\r\n{\r\nstruct i2s_pll_clk *clk = to_i2s_pll_clk(hw);\r\nconst struct i2s_pll_cfg *pll_cfg = i2s_pll_get_cfg(*prate);\r\nint i;\r\nif (!pll_cfg) {\r\ndev_err(clk->dev, "invalid parent rate=%ld\n", *prate);\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; pll_cfg[i].rate != 0; i++)\r\nif (pll_cfg[i].rate == rate)\r\nreturn rate;\r\nreturn -EINVAL;\r\n}\r\nstatic int i2s_pll_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct i2s_pll_clk *clk = to_i2s_pll_clk(hw);\r\nconst struct i2s_pll_cfg *pll_cfg = i2s_pll_get_cfg(parent_rate);\r\nint i;\r\nif (!pll_cfg) {\r\ndev_err(clk->dev, "invalid parent rate=%ld\n", parent_rate);\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; pll_cfg[i].rate != 0; i++) {\r\nif (pll_cfg[i].rate == rate) {\r\ni2s_pll_write(clk, PLL_IDIV_REG, pll_cfg[i].idiv);\r\ni2s_pll_write(clk, PLL_FBDIV_REG, pll_cfg[i].fbdiv);\r\ni2s_pll_write(clk, PLL_ODIV0_REG, pll_cfg[i].odiv0);\r\ni2s_pll_write(clk, PLL_ODIV1_REG, pll_cfg[i].odiv1);\r\nreturn 0;\r\n}\r\n}\r\ndev_err(clk->dev, "invalid rate=%ld, parent_rate=%ld\n", rate,\r\nparent_rate);\r\nreturn -EINVAL;\r\n}\r\nstatic int i2s_pll_clk_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *node = dev->of_node;\r\nconst char *clk_name;\r\nconst char *parent_name;\r\nstruct clk *clk;\r\nstruct i2s_pll_clk *pll_clk;\r\nstruct clk_init_data init;\r\nstruct resource *mem;\r\npll_clk = devm_kzalloc(dev, sizeof(*pll_clk), GFP_KERNEL);\r\nif (!pll_clk)\r\nreturn -ENOMEM;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npll_clk->base = devm_ioremap_resource(dev, mem);\r\nif (IS_ERR(pll_clk->base))\r\nreturn PTR_ERR(pll_clk->base);\r\nclk_name = node->name;\r\ninit.name = clk_name;\r\ninit.ops = &i2s_pll_ops;\r\nparent_name = of_clk_get_parent_name(node, 0);\r\ninit.parent_names = &parent_name;\r\ninit.num_parents = 1;\r\npll_clk->hw.init = &init;\r\npll_clk->dev = dev;\r\nclk = devm_clk_register(dev, &pll_clk->hw);\r\nif (IS_ERR(clk)) {\r\ndev_err(dev, "failed to register %s clock (%ld)\n",\r\nclk_name, PTR_ERR(clk));\r\nreturn PTR_ERR(clk);\r\n}\r\nreturn of_clk_add_provider(node, of_clk_src_simple_get, clk);\r\n}\r\nstatic int i2s_pll_clk_remove(struct platform_device *pdev)\r\n{\r\nof_clk_del_provider(pdev->dev.of_node);\r\nreturn 0;\r\n}

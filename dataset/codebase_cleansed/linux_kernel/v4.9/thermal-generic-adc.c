static int gadc_thermal_adc_to_temp(struct gadc_thermal_info *gti, int val)\r\n{\r\nint temp, adc_hi, adc_lo;\r\nint i;\r\nfor (i = 0; i < gti->nlookup_table; i++) {\r\nif (val >= gti->lookup_table[2 * i + 1])\r\nbreak;\r\n}\r\nif (i == 0) {\r\ntemp = gti->lookup_table[0];\r\n} else if (i >= (gti->nlookup_table - 1)) {\r\ntemp = gti->lookup_table[2 * (gti->nlookup_table - 1)];\r\n} else {\r\nadc_hi = gti->lookup_table[2 * i - 1];\r\nadc_lo = gti->lookup_table[2 * i + 1];\r\ntemp = gti->lookup_table[2 * i];\r\ntemp -= ((val - adc_lo) * 1000) / (adc_hi - adc_lo);\r\n}\r\nreturn temp;\r\n}\r\nstatic int gadc_thermal_get_temp(void *data, int *temp)\r\n{\r\nstruct gadc_thermal_info *gti = data;\r\nint val;\r\nint ret;\r\nret = iio_read_channel_processed(gti->channel, &val);\r\nif (ret < 0) {\r\ndev_err(gti->dev, "IIO channel read failed %d\n", ret);\r\nreturn ret;\r\n}\r\n*temp = gadc_thermal_adc_to_temp(gti, val);\r\nreturn 0;\r\n}\r\nstatic int gadc_thermal_read_linear_lookup_table(struct device *dev,\r\nstruct gadc_thermal_info *gti)\r\n{\r\nstruct device_node *np = dev->of_node;\r\nint ntable;\r\nint ret;\r\nntable = of_property_count_elems_of_size(np, "temperature-lookup-table",\r\nsizeof(u32));\r\nif (ntable < 0) {\r\ndev_err(dev, "Lookup table is not provided\n");\r\nreturn ntable;\r\n}\r\nif (ntable % 2) {\r\ndev_err(dev, "Pair of temperature vs ADC read value missing\n");\r\nreturn -EINVAL;\r\n}\r\ngti->lookup_table = devm_kzalloc(dev, sizeof(*gti->lookup_table) *\r\nntable, GFP_KERNEL);\r\nif (!gti->lookup_table)\r\nreturn -ENOMEM;\r\nret = of_property_read_u32_array(np, "temperature-lookup-table",\r\n(u32 *)gti->lookup_table, ntable);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to read temperature lookup table: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\ngti->nlookup_table = ntable / 2;\r\nreturn 0;\r\n}\r\nstatic int gadc_thermal_probe(struct platform_device *pdev)\r\n{\r\nstruct gadc_thermal_info *gti;\r\nint ret;\r\nif (!pdev->dev.of_node) {\r\ndev_err(&pdev->dev, "Only DT based supported\n");\r\nreturn -ENODEV;\r\n}\r\ngti = devm_kzalloc(&pdev->dev, sizeof(*gti), GFP_KERNEL);\r\nif (!gti)\r\nreturn -ENOMEM;\r\nret = gadc_thermal_read_linear_lookup_table(&pdev->dev, gti);\r\nif (ret < 0)\r\nreturn ret;\r\ngti->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, gti);\r\ngti->channel = iio_channel_get(&pdev->dev, "sensor-channel");\r\nif (IS_ERR(gti->channel)) {\r\nret = PTR_ERR(gti->channel);\r\ndev_err(&pdev->dev, "IIO channel not found: %d\n", ret);\r\nreturn ret;\r\n}\r\ngti->tz_dev = thermal_zone_of_sensor_register(&pdev->dev, 0,\r\ngti, &gadc_thermal_ops);\r\nif (IS_ERR(gti->tz_dev)) {\r\nret = PTR_ERR(gti->tz_dev);\r\ndev_err(&pdev->dev, "Thermal zone sensor register failed: %d\n",\r\nret);\r\ngoto sensor_fail;\r\n}\r\nreturn 0;\r\nsensor_fail:\r\niio_channel_release(gti->channel);\r\nreturn ret;\r\n}\r\nstatic int gadc_thermal_remove(struct platform_device *pdev)\r\n{\r\nstruct gadc_thermal_info *gti = platform_get_drvdata(pdev);\r\nthermal_zone_of_sensor_unregister(&pdev->dev, gti->tz_dev);\r\niio_channel_release(gti->channel);\r\nreturn 0;\r\n}

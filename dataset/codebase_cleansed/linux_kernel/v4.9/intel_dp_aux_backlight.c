static void set_aux_backlight_enable(struct intel_dp *intel_dp, bool enable)\r\n{\r\nuint8_t reg_val = 0;\r\nif (drm_dp_dpcd_readb(&intel_dp->aux, DP_EDP_DISPLAY_CONTROL_REGISTER,\r\n&reg_val) < 0) {\r\nDRM_DEBUG_KMS("Failed to read DPCD register 0x%x\n",\r\nDP_EDP_DISPLAY_CONTROL_REGISTER);\r\nreturn;\r\n}\r\nif (enable)\r\nreg_val |= DP_EDP_BACKLIGHT_ENABLE;\r\nelse\r\nreg_val &= ~(DP_EDP_BACKLIGHT_ENABLE);\r\nif (drm_dp_dpcd_writeb(&intel_dp->aux, DP_EDP_DISPLAY_CONTROL_REGISTER,\r\nreg_val) != 1) {\r\nDRM_DEBUG_KMS("Failed to %s aux backlight\n",\r\nenable ? "enable" : "disable");\r\n}\r\n}\r\nstatic uint32_t intel_dp_aux_get_backlight(struct intel_connector *connector)\r\n{\r\nstruct intel_dp *intel_dp = enc_to_intel_dp(&connector->encoder->base);\r\nuint8_t read_val[2] = { 0x0 };\r\nuint16_t level = 0;\r\nif (drm_dp_dpcd_read(&intel_dp->aux, DP_EDP_BACKLIGHT_BRIGHTNESS_MSB,\r\n&read_val, sizeof(read_val)) < 0) {\r\nDRM_DEBUG_KMS("Failed to read DPCD register 0x%x\n",\r\nDP_EDP_BACKLIGHT_BRIGHTNESS_MSB);\r\nreturn 0;\r\n}\r\nlevel = read_val[0];\r\nif (intel_dp->edp_dpcd[2] & DP_EDP_BACKLIGHT_BRIGHTNESS_BYTE_COUNT)\r\nlevel = (read_val[0] << 8 | read_val[1]);\r\nreturn level;\r\n}\r\nstatic void\r\nintel_dp_aux_set_backlight(struct intel_connector *connector, u32 level)\r\n{\r\nstruct intel_dp *intel_dp = enc_to_intel_dp(&connector->encoder->base);\r\nuint8_t vals[2] = { 0x0 };\r\nvals[0] = level;\r\nif (intel_dp->edp_dpcd[2] & DP_EDP_BACKLIGHT_BRIGHTNESS_BYTE_COUNT) {\r\nvals[0] = (level & 0xFF00) >> 8;\r\nvals[1] = (level & 0xFF);\r\n}\r\nif (drm_dp_dpcd_write(&intel_dp->aux, DP_EDP_BACKLIGHT_BRIGHTNESS_MSB,\r\nvals, sizeof(vals)) < 0) {\r\nDRM_DEBUG_KMS("Failed to write aux backlight level\n");\r\nreturn;\r\n}\r\n}\r\nstatic void intel_dp_aux_enable_backlight(struct intel_connector *connector)\r\n{\r\nstruct intel_dp *intel_dp = enc_to_intel_dp(&connector->encoder->base);\r\nuint8_t dpcd_buf = 0;\r\nset_aux_backlight_enable(intel_dp, true);\r\nif ((drm_dp_dpcd_readb(&intel_dp->aux,\r\nDP_EDP_BACKLIGHT_MODE_SET_REGISTER, &dpcd_buf) == 1) &&\r\n((dpcd_buf & DP_EDP_BACKLIGHT_CONTROL_MODE_MASK) ==\r\nDP_EDP_BACKLIGHT_CONTROL_MODE_PRESET))\r\ndrm_dp_dpcd_writeb(&intel_dp->aux, DP_EDP_BACKLIGHT_MODE_SET_REGISTER,\r\n(dpcd_buf | DP_EDP_BACKLIGHT_CONTROL_MODE_DPCD));\r\n}\r\nstatic void intel_dp_aux_disable_backlight(struct intel_connector *connector)\r\n{\r\nset_aux_backlight_enable(enc_to_intel_dp(&connector->encoder->base), false);\r\n}\r\nstatic int intel_dp_aux_setup_backlight(struct intel_connector *connector,\r\nenum pipe pipe)\r\n{\r\nstruct intel_dp *intel_dp = enc_to_intel_dp(&connector->encoder->base);\r\nstruct intel_panel *panel = &connector->panel;\r\nintel_dp_aux_enable_backlight(connector);\r\nif (intel_dp->edp_dpcd[2] & DP_EDP_BACKLIGHT_BRIGHTNESS_BYTE_COUNT)\r\npanel->backlight.max = 0xFFFF;\r\nelse\r\npanel->backlight.max = 0xFF;\r\npanel->backlight.min = 0;\r\npanel->backlight.level = intel_dp_aux_get_backlight(connector);\r\npanel->backlight.enabled = panel->backlight.level != 0;\r\nreturn 0;\r\n}\r\nstatic bool\r\nintel_dp_aux_display_control_capable(struct intel_connector *connector)\r\n{\r\nstruct intel_dp *intel_dp = enc_to_intel_dp(&connector->encoder->base);\r\nif (intel_dp->edp_dpcd[1] & DP_EDP_TCON_BACKLIGHT_ADJUSTMENT_CAP &&\r\n(intel_dp->edp_dpcd[1] & DP_EDP_BACKLIGHT_AUX_ENABLE_CAP) &&\r\n!((intel_dp->edp_dpcd[1] & DP_EDP_BACKLIGHT_PIN_ENABLE_CAP) ||\r\n(intel_dp->edp_dpcd[2] & DP_EDP_BACKLIGHT_BRIGHTNESS_PWM_PIN_CAP))) {\r\nDRM_DEBUG_KMS("AUX Backlight Control Supported!\n");\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nint intel_dp_aux_init_backlight_funcs(struct intel_connector *intel_connector)\r\n{\r\nstruct intel_panel *panel = &intel_connector->panel;\r\nif (!i915.enable_dpcd_backlight)\r\nreturn -ENODEV;\r\nif (!intel_dp_aux_display_control_capable(intel_connector))\r\nreturn -ENODEV;\r\npanel->backlight.setup = intel_dp_aux_setup_backlight;\r\npanel->backlight.enable = intel_dp_aux_enable_backlight;\r\npanel->backlight.disable = intel_dp_aux_disable_backlight;\r\npanel->backlight.set = intel_dp_aux_set_backlight;\r\npanel->backlight.get = intel_dp_aux_get_backlight;\r\nreturn 0;\r\n}

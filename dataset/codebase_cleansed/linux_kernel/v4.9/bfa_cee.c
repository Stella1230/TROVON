static void\r\nbfa_cee_format_cee_cfg(void *buffer)\r\n{\r\nstruct bfa_cee_attr *cee_cfg = buffer;\r\nbfa_cee_format_lldp_cfg(&cee_cfg->lldp_remote);\r\n}\r\nstatic void\r\nbfa_cee_stats_swap(struct bfa_cee_stats *stats)\r\n{\r\nu32 *buffer = (u32 *)stats;\r\nint i;\r\nfor (i = 0; i < (sizeof(struct bfa_cee_stats) / sizeof(u32));\r\ni++) {\r\nbuffer[i] = ntohl(buffer[i]);\r\n}\r\n}\r\nstatic void\r\nbfa_cee_format_lldp_cfg(struct bfa_cee_lldp_cfg *lldp_cfg)\r\n{\r\nlldp_cfg->time_to_live =\r\nntohs(lldp_cfg->time_to_live);\r\nlldp_cfg->enabled_system_cap =\r\nntohs(lldp_cfg->enabled_system_cap);\r\n}\r\nstatic u32\r\nbfa_cee_attr_meminfo(void)\r\n{\r\nreturn roundup(sizeof(struct bfa_cee_attr), BFA_DMA_ALIGN_SZ);\r\n}\r\nstatic u32\r\nbfa_cee_stats_meminfo(void)\r\n{\r\nreturn roundup(sizeof(struct bfa_cee_stats), BFA_DMA_ALIGN_SZ);\r\n}\r\nstatic void\r\nbfa_cee_get_attr_isr(struct bfa_cee *cee, enum bfa_status status)\r\n{\r\ncee->get_attr_status = status;\r\nif (status == BFA_STATUS_OK) {\r\nmemcpy(cee->attr, cee->attr_dma.kva,\r\nsizeof(struct bfa_cee_attr));\r\nbfa_cee_format_cee_cfg(cee->attr);\r\n}\r\ncee->get_attr_pending = false;\r\nif (cee->cbfn.get_attr_cbfn)\r\ncee->cbfn.get_attr_cbfn(cee->cbfn.get_attr_cbarg, status);\r\n}\r\nstatic void\r\nbfa_cee_get_stats_isr(struct bfa_cee *cee, enum bfa_status status)\r\n{\r\ncee->get_stats_status = status;\r\nif (status == BFA_STATUS_OK) {\r\nmemcpy(cee->stats, cee->stats_dma.kva,\r\nsizeof(struct bfa_cee_stats));\r\nbfa_cee_stats_swap(cee->stats);\r\n}\r\ncee->get_stats_pending = false;\r\nif (cee->cbfn.get_stats_cbfn)\r\ncee->cbfn.get_stats_cbfn(cee->cbfn.get_stats_cbarg, status);\r\n}\r\nstatic void\r\nbfa_cee_reset_stats_isr(struct bfa_cee *cee, enum bfa_status status)\r\n{\r\ncee->reset_stats_status = status;\r\ncee->reset_stats_pending = false;\r\nif (cee->cbfn.reset_stats_cbfn)\r\ncee->cbfn.reset_stats_cbfn(cee->cbfn.reset_stats_cbarg, status);\r\n}\r\nu32\r\nbfa_nw_cee_meminfo(void)\r\n{\r\nreturn bfa_cee_attr_meminfo() + bfa_cee_stats_meminfo();\r\n}\r\nvoid\r\nbfa_nw_cee_mem_claim(struct bfa_cee *cee, u8 *dma_kva, u64 dma_pa)\r\n{\r\ncee->attr_dma.kva = dma_kva;\r\ncee->attr_dma.pa = dma_pa;\r\ncee->stats_dma.kva = dma_kva + bfa_cee_attr_meminfo();\r\ncee->stats_dma.pa = dma_pa + bfa_cee_attr_meminfo();\r\ncee->attr = (struct bfa_cee_attr *) dma_kva;\r\ncee->stats = (struct bfa_cee_stats *)\r\n(dma_kva + bfa_cee_attr_meminfo());\r\n}\r\nenum bfa_status\r\nbfa_nw_cee_get_attr(struct bfa_cee *cee, struct bfa_cee_attr *attr,\r\nbfa_cee_get_attr_cbfn_t cbfn, void *cbarg)\r\n{\r\nstruct bfi_cee_get_req *cmd;\r\nBUG_ON(!((cee != NULL) && (cee->ioc != NULL)));\r\nif (!bfa_nw_ioc_is_operational(cee->ioc))\r\nreturn BFA_STATUS_IOC_FAILURE;\r\nif (cee->get_attr_pending)\r\nreturn BFA_STATUS_DEVBUSY;\r\ncee->get_attr_pending = true;\r\ncmd = (struct bfi_cee_get_req *) cee->get_cfg_mb.msg;\r\ncee->attr = attr;\r\ncee->cbfn.get_attr_cbfn = cbfn;\r\ncee->cbfn.get_attr_cbarg = cbarg;\r\nbfi_h2i_set(cmd->mh, BFI_MC_CEE, BFI_CEE_H2I_GET_CFG_REQ,\r\nbfa_ioc_portid(cee->ioc));\r\nbfa_dma_be_addr_set(cmd->dma_addr, cee->attr_dma.pa);\r\nbfa_nw_ioc_mbox_queue(cee->ioc, &cee->get_cfg_mb, NULL, NULL);\r\nreturn BFA_STATUS_OK;\r\n}\r\nstatic void\r\nbfa_cee_isr(void *cbarg, struct bfi_mbmsg *m)\r\n{\r\nunion bfi_cee_i2h_msg_u *msg;\r\nstruct bfi_cee_get_rsp *get_rsp;\r\nstruct bfa_cee *cee = (struct bfa_cee *) cbarg;\r\nmsg = (union bfi_cee_i2h_msg_u *) m;\r\nget_rsp = (struct bfi_cee_get_rsp *) m;\r\nswitch (msg->mh.msg_id) {\r\ncase BFI_CEE_I2H_GET_CFG_RSP:\r\nbfa_cee_get_attr_isr(cee, get_rsp->cmd_status);\r\nbreak;\r\ncase BFI_CEE_I2H_GET_STATS_RSP:\r\nbfa_cee_get_stats_isr(cee, get_rsp->cmd_status);\r\nbreak;\r\ncase BFI_CEE_I2H_RESET_STATS_RSP:\r\nbfa_cee_reset_stats_isr(cee, get_rsp->cmd_status);\r\nbreak;\r\ndefault:\r\nBUG_ON(1);\r\n}\r\n}\r\nstatic void\r\nbfa_cee_notify(void *arg, enum bfa_ioc_event event)\r\n{\r\nstruct bfa_cee *cee;\r\ncee = (struct bfa_cee *) arg;\r\nswitch (event) {\r\ncase BFA_IOC_E_DISABLED:\r\ncase BFA_IOC_E_FAILED:\r\nif (cee->get_attr_pending) {\r\ncee->get_attr_status = BFA_STATUS_FAILED;\r\ncee->get_attr_pending = false;\r\nif (cee->cbfn.get_attr_cbfn) {\r\ncee->cbfn.get_attr_cbfn(\r\ncee->cbfn.get_attr_cbarg,\r\nBFA_STATUS_FAILED);\r\n}\r\n}\r\nif (cee->get_stats_pending) {\r\ncee->get_stats_status = BFA_STATUS_FAILED;\r\ncee->get_stats_pending = false;\r\nif (cee->cbfn.get_stats_cbfn) {\r\ncee->cbfn.get_stats_cbfn(\r\ncee->cbfn.get_stats_cbarg,\r\nBFA_STATUS_FAILED);\r\n}\r\n}\r\nif (cee->reset_stats_pending) {\r\ncee->reset_stats_status = BFA_STATUS_FAILED;\r\ncee->reset_stats_pending = false;\r\nif (cee->cbfn.reset_stats_cbfn) {\r\ncee->cbfn.reset_stats_cbfn(\r\ncee->cbfn.reset_stats_cbarg,\r\nBFA_STATUS_FAILED);\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nvoid\r\nbfa_nw_cee_attach(struct bfa_cee *cee, struct bfa_ioc *ioc,\r\nvoid *dev)\r\n{\r\nBUG_ON(!(cee != NULL));\r\ncee->dev = dev;\r\ncee->ioc = ioc;\r\nbfa_nw_ioc_mbox_regisr(cee->ioc, BFI_MC_CEE, bfa_cee_isr, cee);\r\nbfa_ioc_notify_init(&cee->ioc_notify, bfa_cee_notify, cee);\r\nbfa_nw_ioc_notify_register(cee->ioc, &cee->ioc_notify);\r\n}

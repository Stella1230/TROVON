int ucc_set_qe_mux_mii_mng(unsigned int ucc_num)\r\n{\r\nunsigned long flags;\r\nif (ucc_num > UCC_MAX_NUM - 1)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&cmxgcr_lock, flags);\r\nclrsetbits_be32(&qe_immr->qmx.cmxgcr, QE_CMXGCR_MII_ENET_MNG,\r\nucc_num << QE_CMXGCR_MII_ENET_MNG_SHIFT);\r\nspin_unlock_irqrestore(&cmxgcr_lock, flags);\r\nreturn 0;\r\n}\r\nint ucc_set_type(unsigned int ucc_num, enum ucc_speed_type speed)\r\n{\r\nu8 __iomem *guemr;\r\nswitch (ucc_num) {\r\ncase 0: guemr = &qe_immr->ucc1.slow.guemr;\r\nbreak;\r\ncase 1: guemr = &qe_immr->ucc2.slow.guemr;\r\nbreak;\r\ncase 2: guemr = &qe_immr->ucc3.slow.guemr;\r\nbreak;\r\ncase 3: guemr = &qe_immr->ucc4.slow.guemr;\r\nbreak;\r\ncase 4: guemr = &qe_immr->ucc5.slow.guemr;\r\nbreak;\r\ncase 5: guemr = &qe_immr->ucc6.slow.guemr;\r\nbreak;\r\ncase 6: guemr = &qe_immr->ucc7.slow.guemr;\r\nbreak;\r\ncase 7: guemr = &qe_immr->ucc8.slow.guemr;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nclrsetbits_8(guemr, UCC_GUEMR_MODE_MASK,\r\nUCC_GUEMR_SET_RESERVED3 | speed);\r\nreturn 0;\r\n}\r\nstatic void get_cmxucr_reg(unsigned int ucc_num, __be32 __iomem **cmxucr,\r\nunsigned int *reg_num, unsigned int *shift)\r\n{\r\nunsigned int cmx = ((ucc_num & 1) << 1) + (ucc_num > 3);\r\n*reg_num = cmx + 1;\r\n*cmxucr = &qe_immr->qmx.cmxucr[cmx];\r\n*shift = 16 - 8 * (ucc_num & 2);\r\n}\r\nint ucc_mux_set_grant_tsa_bkpt(unsigned int ucc_num, int set, u32 mask)\r\n{\r\n__be32 __iomem *cmxucr;\r\nunsigned int reg_num;\r\nunsigned int shift;\r\nif (ucc_num > UCC_MAX_NUM - 1)\r\nreturn -EINVAL;\r\nget_cmxucr_reg(ucc_num, &cmxucr, &reg_num, &shift);\r\nif (set)\r\nsetbits32(cmxucr, mask << shift);\r\nelse\r\nclrbits32(cmxucr, mask << shift);\r\nreturn 0;\r\n}\r\nint ucc_set_qe_mux_rxtx(unsigned int ucc_num, enum qe_clock clock,\r\nenum comm_dir mode)\r\n{\r\n__be32 __iomem *cmxucr;\r\nunsigned int reg_num;\r\nunsigned int shift;\r\nu32 clock_bits = 0;\r\nif (ucc_num > UCC_MAX_NUM - 1)\r\nreturn -EINVAL;\r\nif (!((mode == COMM_DIR_RX) || (mode == COMM_DIR_TX)))\r\nreturn -EINVAL;\r\nget_cmxucr_reg(ucc_num, &cmxucr, &reg_num, &shift);\r\nswitch (reg_num) {\r\ncase 1:\r\nswitch (clock) {\r\ncase QE_BRG1: clock_bits = 1; break;\r\ncase QE_BRG2: clock_bits = 2; break;\r\ncase QE_BRG7: clock_bits = 3; break;\r\ncase QE_BRG8: clock_bits = 4; break;\r\ncase QE_CLK9: clock_bits = 5; break;\r\ncase QE_CLK10: clock_bits = 6; break;\r\ncase QE_CLK11: clock_bits = 7; break;\r\ncase QE_CLK12: clock_bits = 8; break;\r\ncase QE_CLK15: clock_bits = 9; break;\r\ncase QE_CLK16: clock_bits = 10; break;\r\ndefault: break;\r\n}\r\nbreak;\r\ncase 2:\r\nswitch (clock) {\r\ncase QE_BRG5: clock_bits = 1; break;\r\ncase QE_BRG6: clock_bits = 2; break;\r\ncase QE_BRG7: clock_bits = 3; break;\r\ncase QE_BRG8: clock_bits = 4; break;\r\ncase QE_CLK13: clock_bits = 5; break;\r\ncase QE_CLK14: clock_bits = 6; break;\r\ncase QE_CLK19: clock_bits = 7; break;\r\ncase QE_CLK20: clock_bits = 8; break;\r\ncase QE_CLK15: clock_bits = 9; break;\r\ncase QE_CLK16: clock_bits = 10; break;\r\ndefault: break;\r\n}\r\nbreak;\r\ncase 3:\r\nswitch (clock) {\r\ncase QE_BRG9: clock_bits = 1; break;\r\ncase QE_BRG10: clock_bits = 2; break;\r\ncase QE_BRG15: clock_bits = 3; break;\r\ncase QE_BRG16: clock_bits = 4; break;\r\ncase QE_CLK3: clock_bits = 5; break;\r\ncase QE_CLK4: clock_bits = 6; break;\r\ncase QE_CLK17: clock_bits = 7; break;\r\ncase QE_CLK18: clock_bits = 8; break;\r\ncase QE_CLK7: clock_bits = 9; break;\r\ncase QE_CLK8: clock_bits = 10; break;\r\ncase QE_CLK16: clock_bits = 11; break;\r\ndefault: break;\r\n}\r\nbreak;\r\ncase 4:\r\nswitch (clock) {\r\ncase QE_BRG13: clock_bits = 1; break;\r\ncase QE_BRG14: clock_bits = 2; break;\r\ncase QE_BRG15: clock_bits = 3; break;\r\ncase QE_BRG16: clock_bits = 4; break;\r\ncase QE_CLK5: clock_bits = 5; break;\r\ncase QE_CLK6: clock_bits = 6; break;\r\ncase QE_CLK21: clock_bits = 7; break;\r\ncase QE_CLK22: clock_bits = 8; break;\r\ncase QE_CLK7: clock_bits = 9; break;\r\ncase QE_CLK8: clock_bits = 10; break;\r\ncase QE_CLK16: clock_bits = 11; break;\r\ndefault: break;\r\n}\r\nbreak;\r\ndefault: break;\r\n}\r\nif (!clock_bits)\r\nreturn -ENOENT;\r\nif (mode == COMM_DIR_RX)\r\nshift += 4;\r\nclrsetbits_be32(cmxucr, QE_CMXUCR_TX_CLK_SRC_MASK << shift,\r\nclock_bits << shift);\r\nreturn 0;\r\n}\r\nstatic int ucc_get_tdm_common_clk(u32 tdm_num, enum qe_clock clock)\r\n{\r\nint clock_bits = -EINVAL;\r\nswitch (tdm_num) {\r\ncase 0:\r\ncase 1:\r\ncase 2:\r\ncase 3:\r\nswitch (clock) {\r\ncase QE_BRG3:\r\nclock_bits = 1;\r\nbreak;\r\ncase QE_BRG4:\r\nclock_bits = 2;\r\nbreak;\r\ncase QE_CLK1:\r\nclock_bits = 4;\r\nbreak;\r\ncase QE_CLK2:\r\nclock_bits = 5;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 4:\r\ncase 5:\r\ncase 6:\r\ncase 7:\r\nswitch (clock) {\r\ncase QE_BRG12:\r\nclock_bits = 1;\r\nbreak;\r\ncase QE_BRG13:\r\nclock_bits = 2;\r\nbreak;\r\ncase QE_CLK23:\r\nclock_bits = 4;\r\nbreak;\r\ncase QE_CLK24:\r\nclock_bits = 5;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn clock_bits;\r\n}\r\nstatic int ucc_get_tdm_rx_clk(u32 tdm_num, enum qe_clock clock)\r\n{\r\nint clock_bits = -EINVAL;\r\nswitch (tdm_num) {\r\ncase 0:\r\nswitch (clock) {\r\ncase QE_CLK3:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK8:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 1:\r\nswitch (clock) {\r\ncase QE_CLK5:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK10:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 2:\r\nswitch (clock) {\r\ncase QE_CLK7:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK12:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 3:\r\nswitch (clock) {\r\ncase QE_CLK9:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK14:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 4:\r\nswitch (clock) {\r\ncase QE_CLK11:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK16:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 5:\r\nswitch (clock) {\r\ncase QE_CLK13:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK18:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 6:\r\nswitch (clock) {\r\ncase QE_CLK15:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK20:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 7:\r\nswitch (clock) {\r\ncase QE_CLK17:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK22:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nreturn clock_bits;\r\n}\r\nstatic int ucc_get_tdm_tx_clk(u32 tdm_num, enum qe_clock clock)\r\n{\r\nint clock_bits = -EINVAL;\r\nswitch (tdm_num) {\r\ncase 0:\r\nswitch (clock) {\r\ncase QE_CLK4:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK9:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 1:\r\nswitch (clock) {\r\ncase QE_CLK6:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK11:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 2:\r\nswitch (clock) {\r\ncase QE_CLK8:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK13:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 3:\r\nswitch (clock) {\r\ncase QE_CLK10:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK15:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 4:\r\nswitch (clock) {\r\ncase QE_CLK12:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK17:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 5:\r\nswitch (clock) {\r\ncase QE_CLK14:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK19:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 6:\r\nswitch (clock) {\r\ncase QE_CLK16:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK21:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 7:\r\nswitch (clock) {\r\ncase QE_CLK18:\r\nclock_bits = 6;\r\nbreak;\r\ncase QE_CLK3:\r\nclock_bits = 7;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nreturn clock_bits;\r\n}\r\nstatic int ucc_get_tdm_rxtx_clk(enum comm_dir mode, u32 tdm_num,\r\nenum qe_clock clock)\r\n{\r\nint clock_bits;\r\nclock_bits = ucc_get_tdm_common_clk(tdm_num, clock);\r\nif (clock_bits > 0)\r\nreturn clock_bits;\r\nif (mode == COMM_DIR_RX)\r\nclock_bits = ucc_get_tdm_rx_clk(tdm_num, clock);\r\nif (mode == COMM_DIR_TX)\r\nclock_bits = ucc_get_tdm_tx_clk(tdm_num, clock);\r\nreturn clock_bits;\r\n}\r\nstatic u32 ucc_get_tdm_clk_shift(enum comm_dir mode, u32 tdm_num)\r\n{\r\nu32 shift;\r\nshift = (mode == COMM_DIR_RX) ? RX_CLK_SHIFT_BASE : TX_CLK_SHIFT_BASE;\r\nif (tdm_num < 4)\r\nshift -= tdm_num * 4;\r\nelse\r\nshift -= (tdm_num - 4) * 4;\r\nreturn shift;\r\n}\r\nint ucc_set_tdm_rxtx_clk(u32 tdm_num, enum qe_clock clock,\r\nenum comm_dir mode)\r\n{\r\nint clock_bits;\r\nu32 shift;\r\nstruct qe_mux __iomem *qe_mux_reg;\r\n__be32 __iomem *cmxs1cr;\r\nqe_mux_reg = &qe_immr->qmx;\r\nif (tdm_num > 7 || tdm_num < 0)\r\nreturn -EINVAL;\r\nif (mode != COMM_DIR_RX && mode != COMM_DIR_TX)\r\nreturn -EINVAL;\r\nclock_bits = ucc_get_tdm_rxtx_clk(mode, tdm_num, clock);\r\nif (clock_bits < 0)\r\nreturn -EINVAL;\r\nshift = ucc_get_tdm_clk_shift(mode, tdm_num);\r\ncmxs1cr = (tdm_num < 4) ? &qe_mux_reg->cmxsi1cr_l :\r\n&qe_mux_reg->cmxsi1cr_h;\r\nqe_clrsetbits32(cmxs1cr, QE_CMXUCR_TX_CLK_SRC_MASK << shift,\r\nclock_bits << shift);\r\nreturn 0;\r\n}\r\nstatic int ucc_get_tdm_sync_source(u32 tdm_num, enum qe_clock clock,\r\nenum comm_dir mode)\r\n{\r\nint source = -EINVAL;\r\nif (mode == COMM_DIR_RX && clock == QE_RSYNC_PIN) {\r\nsource = 0;\r\nreturn source;\r\n}\r\nif (mode == COMM_DIR_TX && clock == QE_TSYNC_PIN) {\r\nsource = 0;\r\nreturn source;\r\n}\r\nswitch (tdm_num) {\r\ncase 0:\r\ncase 1:\r\nswitch (clock) {\r\ncase QE_BRG9:\r\nsource = 1;\r\nbreak;\r\ncase QE_BRG10:\r\nsource = 2;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 2:\r\ncase 3:\r\nswitch (clock) {\r\ncase QE_BRG9:\r\nsource = 1;\r\nbreak;\r\ncase QE_BRG11:\r\nsource = 2;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 4:\r\ncase 5:\r\nswitch (clock) {\r\ncase QE_BRG13:\r\nsource = 1;\r\nbreak;\r\ncase QE_BRG14:\r\nsource = 2;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase 6:\r\ncase 7:\r\nswitch (clock) {\r\ncase QE_BRG13:\r\nsource = 1;\r\nbreak;\r\ncase QE_BRG15:\r\nsource = 2;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nreturn source;\r\n}\r\nstatic u32 ucc_get_tdm_sync_shift(enum comm_dir mode, u32 tdm_num)\r\n{\r\nu32 shift;\r\nshift = (mode == COMM_DIR_RX) ? RX_SYNC_SHIFT_BASE : RX_SYNC_SHIFT_BASE;\r\nshift -= tdm_num * 2;\r\nreturn shift;\r\n}\r\nint ucc_set_tdm_rxtx_sync(u32 tdm_num, enum qe_clock clock,\r\nenum comm_dir mode)\r\n{\r\nint source;\r\nu32 shift;\r\nstruct qe_mux *qe_mux_reg;\r\nqe_mux_reg = &qe_immr->qmx;\r\nif (tdm_num >= UCC_TDM_NUM)\r\nreturn -EINVAL;\r\nif (mode != COMM_DIR_RX && mode != COMM_DIR_TX)\r\nreturn -EINVAL;\r\nsource = ucc_get_tdm_sync_source(tdm_num, clock, mode);\r\nif (source < 0)\r\nreturn -EINVAL;\r\nshift = ucc_get_tdm_sync_shift(mode, tdm_num);\r\nqe_clrsetbits32(&qe_mux_reg->cmxsi1syr,\r\nQE_CMXUCR_TX_CLK_SRC_MASK << shift,\r\nsource << shift);\r\nreturn 0;\r\n}

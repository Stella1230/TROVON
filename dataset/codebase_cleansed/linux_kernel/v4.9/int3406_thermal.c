static int int3406_thermal_to_raw(int level, struct int3406_thermal_data *d)\r\n{\r\nint max_level = d->br->levels[d->br->count - 1];\r\nint raw_max = d->raw_bd->props.max_brightness;\r\nreturn level * raw_max / max_level;\r\n}\r\nstatic int int3406_thermal_to_acpi(int level, struct int3406_thermal_data *d)\r\n{\r\nint raw_max = d->raw_bd->props.max_brightness;\r\nint max_level = d->br->levels[d->br->count - 1];\r\nreturn level * max_level / raw_max;\r\n}\r\nstatic int\r\nint3406_thermal_get_max_state(struct thermal_cooling_device *cooling_dev,\r\nunsigned long *state)\r\n{\r\nstruct int3406_thermal_data *d = cooling_dev->devdata;\r\nint index = d->lower_limit_index ? d->lower_limit_index : 2;\r\n*state = d->br->count - 1 - index;\r\nreturn 0;\r\n}\r\nstatic int\r\nint3406_thermal_set_cur_state(struct thermal_cooling_device *cooling_dev,\r\nunsigned long state)\r\n{\r\nstruct int3406_thermal_data *d = cooling_dev->devdata;\r\nint level, raw_level;\r\nif (state > d->br->count - 3)\r\nreturn -EINVAL;\r\nstate = d->br->count - 1 - state;\r\nlevel = d->br->levels[state];\r\nif ((d->upper_limit && level > d->upper_limit) ||\r\n(d->lower_limit && level < d->lower_limit))\r\nreturn -EINVAL;\r\nraw_level = int3406_thermal_to_raw(level, d);\r\nreturn backlight_device_set_brightness(d->raw_bd, raw_level);\r\n}\r\nstatic int\r\nint3406_thermal_get_cur_state(struct thermal_cooling_device *cooling_dev,\r\nunsigned long *state)\r\n{\r\nstruct int3406_thermal_data *d = cooling_dev->devdata;\r\nint raw_level, level, i;\r\nint *levels = d->br->levels;\r\nraw_level = d->raw_bd->props.brightness;\r\nlevel = int3406_thermal_to_acpi(raw_level, d);\r\nfor (i = 2; i < d->br->count; i++) {\r\nif (level < levels[i]) {\r\nif (i == 2)\r\nbreak;\r\nif ((level - levels[i - 1]) < (levels[i] - level))\r\ni--;\r\nbreak;\r\n}\r\n}\r\n*state = d->br->count - 1 - i;\r\nreturn 0;\r\n}\r\nstatic int int3406_thermal_get_index(int *array, int nr, int value)\r\n{\r\nint i;\r\nfor (i = 0; i < nr; i++) {\r\nif (array[i] == value)\r\nbreak;\r\n}\r\nreturn i == nr ? -ENOENT : i;\r\n}\r\nstatic void int3406_thermal_get_limit(struct int3406_thermal_data *d)\r\n{\r\nacpi_status status;\r\nunsigned long long lower_limit, upper_limit;\r\nint index;\r\nstatus = acpi_evaluate_integer(d->handle, "DDDL", NULL, &lower_limit);\r\nif (ACPI_SUCCESS(status)) {\r\nindex = int3406_thermal_get_index(d->br->levels, d->br->count,\r\nlower_limit);\r\nif (index > 0) {\r\nd->lower_limit = (int)lower_limit;\r\nd->lower_limit_index = index;\r\n}\r\n}\r\nstatus = acpi_evaluate_integer(d->handle, "DDPC", NULL, &upper_limit);\r\nif (ACPI_SUCCESS(status)) {\r\nindex = int3406_thermal_get_index(d->br->levels, d->br->count,\r\nupper_limit);\r\nif (index > 0) {\r\nd->upper_limit = (int)upper_limit;\r\nd->upper_limit_index = index;\r\n}\r\n}\r\n}\r\nstatic void int3406_notify(acpi_handle handle, u32 event, void *data)\r\n{\r\nif (event == INT3406_BRIGHTNESS_LIMITS_CHANGED)\r\nint3406_thermal_get_limit(data);\r\n}\r\nstatic int int3406_thermal_probe(struct platform_device *pdev)\r\n{\r\nstruct acpi_device *adev = ACPI_COMPANION(&pdev->dev);\r\nstruct int3406_thermal_data *d;\r\nstruct backlight_device *bd;\r\nint ret;\r\nif (!ACPI_HANDLE(&pdev->dev))\r\nreturn -ENODEV;\r\nd = devm_kzalloc(&pdev->dev, sizeof(*d), GFP_KERNEL);\r\nif (!d)\r\nreturn -ENOMEM;\r\nd->handle = ACPI_HANDLE(&pdev->dev);\r\nbd = backlight_device_get_by_type(BACKLIGHT_RAW);\r\nif (!bd)\r\nreturn -ENODEV;\r\nd->raw_bd = bd;\r\nret = acpi_video_get_levels(ACPI_COMPANION(&pdev->dev), &d->br, NULL);\r\nif (ret)\r\nreturn ret;\r\nint3406_thermal_get_limit(d);\r\nd->cooling_dev = thermal_cooling_device_register(acpi_device_bid(adev),\r\nd, &video_cooling_ops);\r\nif (IS_ERR(d->cooling_dev))\r\ngoto err;\r\nret = acpi_install_notify_handler(adev->handle, ACPI_DEVICE_NOTIFY,\r\nint3406_notify, d);\r\nif (ret)\r\ngoto err_cdev;\r\nplatform_set_drvdata(pdev, d);\r\nreturn 0;\r\nerr_cdev:\r\nthermal_cooling_device_unregister(d->cooling_dev);\r\nerr:\r\nkfree(d->br);\r\nreturn -ENODEV;\r\n}\r\nstatic int int3406_thermal_remove(struct platform_device *pdev)\r\n{\r\nstruct int3406_thermal_data *d = platform_get_drvdata(pdev);\r\nthermal_cooling_device_unregister(d->cooling_dev);\r\nkfree(d->br);\r\nreturn 0;\r\n}

static inline void __iomem *hdmi_av_base(struct hdmi_core_data *core)\r\n{\r\nreturn core->base + HDMI_CORE_AV;\r\n}\r\nstatic int hdmi_core_ddc_init(struct hdmi_core_data *core)\r\n{\r\nvoid __iomem *base = core->base;\r\nREG_FLD_MOD(base, HDMI_CORE_AV_DPD, 0x7, 2, 0);\r\nif (REG_GET(base, HDMI_CORE_DDC_STATUS, 4, 4) == 1) {\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_CMD, 0xf, 3, 0);\r\nif (hdmi_wait_for_bit_change(base, HDMI_CORE_DDC_STATUS,\r\n4, 4, 0) != 0) {\r\nDSSERR("Timeout aborting DDC transaction\n");\r\nreturn -ETIMEDOUT;\r\n}\r\n}\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_CMD, 0xA, 3, 0);\r\nif (hdmi_wait_for_bit_change(base, HDMI_CORE_DDC_STATUS,\r\n4, 4, 0) != 0) {\r\nDSSERR("Timeout starting SCL clock\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_CMD, 0x9, 3, 0);\r\nif (hdmi_wait_for_bit_change(base, HDMI_CORE_DDC_STATUS,\r\n4, 4, 0) != 0) {\r\nDSSERR("Timeout clearing DDC fifo\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hdmi_core_ddc_edid(struct hdmi_core_data *core,\r\nu8 *pedid, int ext)\r\n{\r\nvoid __iomem *base = core->base;\r\nu32 i;\r\nchar checksum;\r\nu32 offset = 0;\r\nif (hdmi_wait_for_bit_change(base, HDMI_CORE_DDC_STATUS,\r\n4, 4, 0) != 0) {\r\nDSSERR("Timeout waiting DDC to be ready\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nif (ext % 2 != 0)\r\noffset = 0x80;\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_SEGM, ext / 2, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_ADDR, 0xA0 >> 1, 7, 1);\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_OFFSET, offset, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_COUNT1, 0x80, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_COUNT2, 0x0, 1, 0);\r\nif (ext)\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_CMD, 0x4, 3, 0);\r\nelse\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_CMD, 0x2, 3, 0);\r\nif (REG_GET(base, HDMI_CORE_DDC_STATUS, 6, 6) == 1) {\r\nDSSERR("I2C Bus Low?\n");\r\nreturn -EIO;\r\n}\r\nif (REG_GET(base, HDMI_CORE_DDC_STATUS, 5, 5) == 1) {\r\nDSSERR("I2C No Ack\n");\r\nreturn -EIO;\r\n}\r\nfor (i = 0; i < 0x80; ++i) {\r\nint t;\r\nif (REG_GET(base, HDMI_CORE_DDC_STATUS, 4, 4) == 0) {\r\nDSSERR("operation stopped when reading edid\n");\r\nreturn -EIO;\r\n}\r\nt = 0;\r\nwhile (REG_GET(base, HDMI_CORE_DDC_STATUS, 2, 2) == 1) {\r\nif (t++ > 10000) {\r\nDSSERR("timeout reading edid\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nudelay(1);\r\n}\r\npedid[i] = REG_GET(base, HDMI_CORE_DDC_DATA, 7, 0);\r\n}\r\nchecksum = 0;\r\nfor (i = 0; i < 0x80; ++i)\r\nchecksum += pedid[i];\r\nif (checksum != 0) {\r\nDSSERR("E-EDID checksum failed!!\n");\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nint hdmi4_read_edid(struct hdmi_core_data *core, u8 *edid, int len)\r\n{\r\nint r, l;\r\nif (len < 128)\r\nreturn -EINVAL;\r\nr = hdmi_core_ddc_init(core);\r\nif (r)\r\nreturn r;\r\nr = hdmi_core_ddc_edid(core, edid, 0);\r\nif (r)\r\nreturn r;\r\nl = 128;\r\nif (len >= 128 * 2 && edid[0x7e] > 0) {\r\nr = hdmi_core_ddc_edid(core, edid + 0x80, 1);\r\nif (r)\r\nreturn r;\r\nl += 128;\r\n}\r\nreturn l;\r\n}\r\nstatic void hdmi_core_init(struct hdmi_core_video_config *video_cfg)\r\n{\r\nDSSDBG("Enter hdmi_core_init\n");\r\nvideo_cfg->ip_bus_width = HDMI_INPUT_8BIT;\r\nvideo_cfg->op_dither_truc = HDMI_OUTPUTTRUNCATION_8BIT;\r\nvideo_cfg->deep_color_pkt = HDMI_DEEPCOLORPACKECTDISABLE;\r\nvideo_cfg->pkt_mode = HDMI_PACKETMODERESERVEDVALUE;\r\nvideo_cfg->hdmi_dvi = HDMI_DVI;\r\nvideo_cfg->tclk_sel_clkmult = HDMI_FPLL10IDCK;\r\n}\r\nstatic void hdmi_core_powerdown_disable(struct hdmi_core_data *core)\r\n{\r\nDSSDBG("Enter hdmi_core_powerdown_disable\n");\r\nREG_FLD_MOD(core->base, HDMI_CORE_SYS_SYS_CTRL1, 0x0, 0, 0);\r\n}\r\nstatic void hdmi_core_swreset_release(struct hdmi_core_data *core)\r\n{\r\nDSSDBG("Enter hdmi_core_swreset_release\n");\r\nREG_FLD_MOD(core->base, HDMI_CORE_SYS_SRST, 0x0, 0, 0);\r\n}\r\nstatic void hdmi_core_swreset_assert(struct hdmi_core_data *core)\r\n{\r\nDSSDBG("Enter hdmi_core_swreset_assert\n");\r\nREG_FLD_MOD(core->base, HDMI_CORE_SYS_SRST, 0x1, 0, 0);\r\n}\r\nstatic void hdmi_core_video_config(struct hdmi_core_data *core,\r\nstruct hdmi_core_video_config *cfg)\r\n{\r\nu32 r = 0;\r\nvoid __iomem *core_sys_base = core->base;\r\nvoid __iomem *core_av_base = hdmi_av_base(core);\r\nr = hdmi_read_reg(core_sys_base, HDMI_CORE_SYS_SYS_CTRL1);\r\nr = FLD_MOD(r, HDMI_CORE_SYS_SYS_CTRL1_VEN_FOLLOWVSYNC, 5, 5);\r\nr = FLD_MOD(r, HDMI_CORE_SYS_SYS_CTRL1_HEN_FOLLOWHSYNC, 4, 4);\r\nr = FLD_MOD(r, HDMI_CORE_SYS_SYS_CTRL1_BSEL_24BITBUS, 2, 2);\r\nr = FLD_MOD(r, HDMI_CORE_SYS_SYS_CTRL1_EDGE_RISINGEDGE, 1, 1);\r\nhdmi_write_reg(core_sys_base, HDMI_CORE_SYS_SYS_CTRL1, r);\r\nREG_FLD_MOD(core_sys_base,\r\nHDMI_CORE_SYS_VID_ACEN, cfg->ip_bus_width, 7, 6);\r\nr = hdmi_read_reg(core_sys_base, HDMI_CORE_SYS_VID_MODE);\r\nif (cfg->op_dither_truc > HDMI_OUTPUTTRUNCATION_12BIT) {\r\nr = FLD_MOD(r, cfg->op_dither_truc - 3, 7, 6);\r\nr = FLD_MOD(r, 1, 5, 5);\r\n} else {\r\nr = FLD_MOD(r, cfg->op_dither_truc, 7, 6);\r\nr = FLD_MOD(r, 0, 5, 5);\r\n}\r\nhdmi_write_reg(core_sys_base, HDMI_CORE_SYS_VID_MODE, r);\r\nr = hdmi_read_reg(core_av_base, HDMI_CORE_AV_HDMI_CTRL);\r\nr = FLD_MOD(r, cfg->deep_color_pkt, 6, 6);\r\nr = FLD_MOD(r, cfg->pkt_mode, 5, 3);\r\nr = FLD_MOD(r, cfg->hdmi_dvi, 0, 0);\r\nhdmi_write_reg(core_av_base, HDMI_CORE_AV_HDMI_CTRL, r);\r\nREG_FLD_MOD(core_sys_base,\r\nHDMI_CORE_SYS_TMDS_CTRL, cfg->tclk_sel_clkmult, 6, 5);\r\n}\r\nstatic void hdmi_core_write_avi_infoframe(struct hdmi_core_data *core,\r\nstruct hdmi_avi_infoframe *frame)\r\n{\r\nvoid __iomem *av_base = hdmi_av_base(core);\r\nu8 data[HDMI_INFOFRAME_SIZE(AVI)];\r\nint i;\r\nhdmi_avi_infoframe_pack(frame, data, sizeof(data));\r\nprint_hex_dump_debug("AVI: ", DUMP_PREFIX_NONE, 16, 1, data,\r\nHDMI_INFOFRAME_SIZE(AVI), false);\r\nfor (i = 0; i < sizeof(data); ++i) {\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_BASE + i * 4,\r\ndata[i]);\r\n}\r\n}\r\nstatic void hdmi_core_av_packet_config(struct hdmi_core_data *core,\r\nstruct hdmi_core_packet_enable_repeat repeat_cfg)\r\n{\r\nhdmi_write_reg(hdmi_av_base(core), HDMI_CORE_AV_PB_CTRL1,\r\n(repeat_cfg.audio_pkt << 5) |\r\n(repeat_cfg.audio_pkt_repeat << 4) |\r\n(repeat_cfg.avi_infoframe << 1) |\r\n(repeat_cfg.avi_infoframe_repeat));\r\nhdmi_write_reg(hdmi_av_base(core), HDMI_CORE_AV_PB_CTRL2,\r\n(repeat_cfg.gen_cntrl_pkt << 3) |\r\n(repeat_cfg.gen_cntrl_pkt_repeat << 2) |\r\n(repeat_cfg.generic_pkt << 1) |\r\n(repeat_cfg.generic_pkt_repeat));\r\n}\r\nvoid hdmi4_configure(struct hdmi_core_data *core,\r\nstruct hdmi_wp_data *wp, struct hdmi_config *cfg)\r\n{\r\nstruct omap_video_timings video_timing;\r\nstruct hdmi_video_format video_format;\r\nstruct hdmi_core_video_config v_core_cfg;\r\nstruct hdmi_core_packet_enable_repeat repeat_cfg = { 0 };\r\nhdmi_core_init(&v_core_cfg);\r\nhdmi_wp_init_vid_fmt_timings(&video_format, &video_timing, cfg);\r\nhdmi_wp_video_config_timing(wp, &video_timing);\r\nvideo_format.packing_mode = HDMI_PACK_24b_RGB_YUV444_YUV422;\r\nhdmi_wp_video_config_format(wp, &video_format);\r\nhdmi_wp_video_config_interface(wp, &video_timing);\r\nhdmi_core_swreset_assert(core);\r\nhdmi_core_powerdown_disable(core);\r\nv_core_cfg.pkt_mode = HDMI_PACKETMODE24BITPERPIXEL;\r\nv_core_cfg.hdmi_dvi = cfg->hdmi_dvi_mode;\r\nhdmi_core_video_config(core, &v_core_cfg);\r\nhdmi_core_swreset_release(core);\r\nif (cfg->hdmi_dvi_mode == HDMI_HDMI) {\r\nhdmi_core_write_avi_infoframe(core, &cfg->infoframe);\r\nrepeat_cfg.avi_infoframe = HDMI_PACKETENABLE;\r\nrepeat_cfg.avi_infoframe_repeat = HDMI_PACKETREPEATON;\r\nrepeat_cfg.audio_pkt = HDMI_PACKETENABLE;\r\nrepeat_cfg.audio_pkt_repeat = HDMI_PACKETREPEATON;\r\n}\r\nhdmi_core_av_packet_config(core, repeat_cfg);\r\n}\r\nvoid hdmi4_core_dump(struct hdmi_core_data *core, struct seq_file *s)\r\n{\r\nint i;\r\n#define CORE_REG(i, name) name(i)\r\n#define DUMPCORE(r) seq_printf(s, "%-35s %08x\n", #r,\\r\nhdmi_read_reg(core->base, r))\r\n#define DUMPCOREAV(r) seq_printf(s, "%-35s %08x\n", #r,\\r\nhdmi_read_reg(hdmi_av_base(core), r))\r\n#define DUMPCOREAV2(i, r) seq_printf(s, "%s[%d]%*s %08x\n", #r, i, \\r\n(i < 10) ? 32 - (int)strlen(#r) : 31 - (int)strlen(#r), " ", \\r\nhdmi_read_reg(hdmi_av_base(core), CORE_REG(i, r)))\r\nDUMPCORE(HDMI_CORE_SYS_VND_IDL);\r\nDUMPCORE(HDMI_CORE_SYS_DEV_IDL);\r\nDUMPCORE(HDMI_CORE_SYS_DEV_IDH);\r\nDUMPCORE(HDMI_CORE_SYS_DEV_REV);\r\nDUMPCORE(HDMI_CORE_SYS_SRST);\r\nDUMPCORE(HDMI_CORE_SYS_SYS_CTRL1);\r\nDUMPCORE(HDMI_CORE_SYS_SYS_STAT);\r\nDUMPCORE(HDMI_CORE_SYS_SYS_CTRL3);\r\nDUMPCORE(HDMI_CORE_SYS_DE_DLY);\r\nDUMPCORE(HDMI_CORE_SYS_DE_CTRL);\r\nDUMPCORE(HDMI_CORE_SYS_DE_TOP);\r\nDUMPCORE(HDMI_CORE_SYS_DE_CNTL);\r\nDUMPCORE(HDMI_CORE_SYS_DE_CNTH);\r\nDUMPCORE(HDMI_CORE_SYS_DE_LINL);\r\nDUMPCORE(HDMI_CORE_SYS_DE_LINH_1);\r\nDUMPCORE(HDMI_CORE_SYS_HRES_L);\r\nDUMPCORE(HDMI_CORE_SYS_HRES_H);\r\nDUMPCORE(HDMI_CORE_SYS_VRES_L);\r\nDUMPCORE(HDMI_CORE_SYS_VRES_H);\r\nDUMPCORE(HDMI_CORE_SYS_IADJUST);\r\nDUMPCORE(HDMI_CORE_SYS_POLDETECT);\r\nDUMPCORE(HDMI_CORE_SYS_HWIDTH1);\r\nDUMPCORE(HDMI_CORE_SYS_HWIDTH2);\r\nDUMPCORE(HDMI_CORE_SYS_VWIDTH);\r\nDUMPCORE(HDMI_CORE_SYS_VID_CTRL);\r\nDUMPCORE(HDMI_CORE_SYS_VID_ACEN);\r\nDUMPCORE(HDMI_CORE_SYS_VID_MODE);\r\nDUMPCORE(HDMI_CORE_SYS_VID_BLANK1);\r\nDUMPCORE(HDMI_CORE_SYS_VID_BLANK3);\r\nDUMPCORE(HDMI_CORE_SYS_VID_BLANK1);\r\nDUMPCORE(HDMI_CORE_SYS_DC_HEADER);\r\nDUMPCORE(HDMI_CORE_SYS_VID_DITHER);\r\nDUMPCORE(HDMI_CORE_SYS_RGB2XVYCC_CT);\r\nDUMPCORE(HDMI_CORE_SYS_R2Y_COEFF_LOW);\r\nDUMPCORE(HDMI_CORE_SYS_R2Y_COEFF_UP);\r\nDUMPCORE(HDMI_CORE_SYS_G2Y_COEFF_LOW);\r\nDUMPCORE(HDMI_CORE_SYS_G2Y_COEFF_UP);\r\nDUMPCORE(HDMI_CORE_SYS_B2Y_COEFF_LOW);\r\nDUMPCORE(HDMI_CORE_SYS_B2Y_COEFF_UP);\r\nDUMPCORE(HDMI_CORE_SYS_R2CB_COEFF_LOW);\r\nDUMPCORE(HDMI_CORE_SYS_R2CB_COEFF_UP);\r\nDUMPCORE(HDMI_CORE_SYS_G2CB_COEFF_LOW);\r\nDUMPCORE(HDMI_CORE_SYS_G2CB_COEFF_UP);\r\nDUMPCORE(HDMI_CORE_SYS_B2CB_COEFF_LOW);\r\nDUMPCORE(HDMI_CORE_SYS_B2CB_COEFF_UP);\r\nDUMPCORE(HDMI_CORE_SYS_R2CR_COEFF_LOW);\r\nDUMPCORE(HDMI_CORE_SYS_R2CR_COEFF_UP);\r\nDUMPCORE(HDMI_CORE_SYS_G2CR_COEFF_LOW);\r\nDUMPCORE(HDMI_CORE_SYS_G2CR_COEFF_UP);\r\nDUMPCORE(HDMI_CORE_SYS_B2CR_COEFF_LOW);\r\nDUMPCORE(HDMI_CORE_SYS_B2CR_COEFF_UP);\r\nDUMPCORE(HDMI_CORE_SYS_RGB_OFFSET_LOW);\r\nDUMPCORE(HDMI_CORE_SYS_RGB_OFFSET_UP);\r\nDUMPCORE(HDMI_CORE_SYS_Y_OFFSET_LOW);\r\nDUMPCORE(HDMI_CORE_SYS_Y_OFFSET_UP);\r\nDUMPCORE(HDMI_CORE_SYS_CBCR_OFFSET_LOW);\r\nDUMPCORE(HDMI_CORE_SYS_CBCR_OFFSET_UP);\r\nDUMPCORE(HDMI_CORE_SYS_INTR_STATE);\r\nDUMPCORE(HDMI_CORE_SYS_INTR1);\r\nDUMPCORE(HDMI_CORE_SYS_INTR2);\r\nDUMPCORE(HDMI_CORE_SYS_INTR3);\r\nDUMPCORE(HDMI_CORE_SYS_INTR4);\r\nDUMPCORE(HDMI_CORE_SYS_INTR_UNMASK1);\r\nDUMPCORE(HDMI_CORE_SYS_INTR_UNMASK2);\r\nDUMPCORE(HDMI_CORE_SYS_INTR_UNMASK3);\r\nDUMPCORE(HDMI_CORE_SYS_INTR_UNMASK4);\r\nDUMPCORE(HDMI_CORE_SYS_INTR_CTRL);\r\nDUMPCORE(HDMI_CORE_SYS_TMDS_CTRL);\r\nDUMPCORE(HDMI_CORE_DDC_ADDR);\r\nDUMPCORE(HDMI_CORE_DDC_SEGM);\r\nDUMPCORE(HDMI_CORE_DDC_OFFSET);\r\nDUMPCORE(HDMI_CORE_DDC_COUNT1);\r\nDUMPCORE(HDMI_CORE_DDC_COUNT2);\r\nDUMPCORE(HDMI_CORE_DDC_STATUS);\r\nDUMPCORE(HDMI_CORE_DDC_CMD);\r\nDUMPCORE(HDMI_CORE_DDC_DATA);\r\nDUMPCOREAV(HDMI_CORE_AV_ACR_CTRL);\r\nDUMPCOREAV(HDMI_CORE_AV_FREQ_SVAL);\r\nDUMPCOREAV(HDMI_CORE_AV_N_SVAL1);\r\nDUMPCOREAV(HDMI_CORE_AV_N_SVAL2);\r\nDUMPCOREAV(HDMI_CORE_AV_N_SVAL3);\r\nDUMPCOREAV(HDMI_CORE_AV_CTS_SVAL1);\r\nDUMPCOREAV(HDMI_CORE_AV_CTS_SVAL2);\r\nDUMPCOREAV(HDMI_CORE_AV_CTS_SVAL3);\r\nDUMPCOREAV(HDMI_CORE_AV_CTS_HVAL1);\r\nDUMPCOREAV(HDMI_CORE_AV_CTS_HVAL2);\r\nDUMPCOREAV(HDMI_CORE_AV_CTS_HVAL3);\r\nDUMPCOREAV(HDMI_CORE_AV_AUD_MODE);\r\nDUMPCOREAV(HDMI_CORE_AV_SPDIF_CTRL);\r\nDUMPCOREAV(HDMI_CORE_AV_HW_SPDIF_FS);\r\nDUMPCOREAV(HDMI_CORE_AV_SWAP_I2S);\r\nDUMPCOREAV(HDMI_CORE_AV_SPDIF_ERTH);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_IN_MAP);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_IN_CTRL);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_CHST0);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_CHST1);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_CHST2);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_CHST4);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_CHST5);\r\nDUMPCOREAV(HDMI_CORE_AV_ASRC);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_IN_LEN);\r\nDUMPCOREAV(HDMI_CORE_AV_HDMI_CTRL);\r\nDUMPCOREAV(HDMI_CORE_AV_AUDO_TXSTAT);\r\nDUMPCOREAV(HDMI_CORE_AV_AUD_PAR_BUSCLK_1);\r\nDUMPCOREAV(HDMI_CORE_AV_AUD_PAR_BUSCLK_2);\r\nDUMPCOREAV(HDMI_CORE_AV_AUD_PAR_BUSCLK_3);\r\nDUMPCOREAV(HDMI_CORE_AV_TEST_TXCTRL);\r\nDUMPCOREAV(HDMI_CORE_AV_DPD);\r\nDUMPCOREAV(HDMI_CORE_AV_PB_CTRL1);\r\nDUMPCOREAV(HDMI_CORE_AV_PB_CTRL2);\r\nDUMPCOREAV(HDMI_CORE_AV_AVI_TYPE);\r\nDUMPCOREAV(HDMI_CORE_AV_AVI_VERS);\r\nDUMPCOREAV(HDMI_CORE_AV_AVI_LEN);\r\nDUMPCOREAV(HDMI_CORE_AV_AVI_CHSUM);\r\nfor (i = 0; i < HDMI_CORE_AV_AVI_DBYTE_NELEMS; i++)\r\nDUMPCOREAV2(i, HDMI_CORE_AV_AVI_DBYTE);\r\nDUMPCOREAV(HDMI_CORE_AV_SPD_TYPE);\r\nDUMPCOREAV(HDMI_CORE_AV_SPD_VERS);\r\nDUMPCOREAV(HDMI_CORE_AV_SPD_LEN);\r\nDUMPCOREAV(HDMI_CORE_AV_SPD_CHSUM);\r\nfor (i = 0; i < HDMI_CORE_AV_SPD_DBYTE_NELEMS; i++)\r\nDUMPCOREAV2(i, HDMI_CORE_AV_SPD_DBYTE);\r\nDUMPCOREAV(HDMI_CORE_AV_AUDIO_TYPE);\r\nDUMPCOREAV(HDMI_CORE_AV_AUDIO_VERS);\r\nDUMPCOREAV(HDMI_CORE_AV_AUDIO_LEN);\r\nDUMPCOREAV(HDMI_CORE_AV_AUDIO_CHSUM);\r\nfor (i = 0; i < HDMI_CORE_AV_AUD_DBYTE_NELEMS; i++)\r\nDUMPCOREAV2(i, HDMI_CORE_AV_AUD_DBYTE);\r\nDUMPCOREAV(HDMI_CORE_AV_MPEG_TYPE);\r\nDUMPCOREAV(HDMI_CORE_AV_MPEG_VERS);\r\nDUMPCOREAV(HDMI_CORE_AV_MPEG_LEN);\r\nDUMPCOREAV(HDMI_CORE_AV_MPEG_CHSUM);\r\nfor (i = 0; i < HDMI_CORE_AV_MPEG_DBYTE_NELEMS; i++)\r\nDUMPCOREAV2(i, HDMI_CORE_AV_MPEG_DBYTE);\r\nfor (i = 0; i < HDMI_CORE_AV_GEN_DBYTE_NELEMS; i++)\r\nDUMPCOREAV2(i, HDMI_CORE_AV_GEN_DBYTE);\r\nDUMPCOREAV(HDMI_CORE_AV_CP_BYTE1);\r\nfor (i = 0; i < HDMI_CORE_AV_GEN2_DBYTE_NELEMS; i++)\r\nDUMPCOREAV2(i, HDMI_CORE_AV_GEN2_DBYTE);\r\nDUMPCOREAV(HDMI_CORE_AV_CEC_ADDR_ID);\r\n}\r\nstatic void hdmi_core_audio_config(struct hdmi_core_data *core,\r\nstruct hdmi_core_audio_config *cfg)\r\n{\r\nu32 r;\r\nvoid __iomem *av_base = hdmi_av_base(core);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_N_SVAL1, cfg->n, 7, 0);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_N_SVAL2, cfg->n >> 8, 7, 0);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_N_SVAL3, cfg->n >> 16, 7, 0);\r\nif (cfg->cts_mode == HDMI_AUDIO_CTS_MODE_SW) {\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_CTS_SVAL1, cfg->cts, 7, 0);\r\nREG_FLD_MOD(av_base,\r\nHDMI_CORE_AV_CTS_SVAL2, cfg->cts >> 8, 7, 0);\r\nREG_FLD_MOD(av_base,\r\nHDMI_CORE_AV_CTS_SVAL3, cfg->cts >> 16, 7, 0);\r\n} else {\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_AUD_PAR_BUSCLK_1,\r\ncfg->aud_par_busclk, 7, 0);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_AUD_PAR_BUSCLK_2,\r\n(cfg->aud_par_busclk >> 8), 7, 0);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_AUD_PAR_BUSCLK_3,\r\n(cfg->aud_par_busclk >> 16), 7, 0);\r\n}\r\nREG_FLD_MOD(av_base,\r\nHDMI_CORE_AV_FREQ_SVAL, cfg->mclk_mode, 2, 0);\r\nr = hdmi_read_reg(av_base, HDMI_CORE_AV_ACR_CTRL);\r\nr = FLD_MOD(r, 0, 2, 2);\r\nr = FLD_MOD(r, cfg->en_acr_pkt, 1, 1);\r\nr = FLD_MOD(r, cfg->cts_mode, 0, 0);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_ACR_CTRL, r);\r\nif (cfg->use_mclk)\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_ACR_CTRL, 1, 2, 2);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_SPDIF_CTRL,\r\ncfg->fs_override, 1, 1);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_I2S_CHST0,\r\ncfg->iec60958_cfg->status[0]);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_I2S_CHST1,\r\ncfg->iec60958_cfg->status[1]);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_I2S_CHST2,\r\ncfg->iec60958_cfg->status[2]);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_I2S_CHST4,\r\ncfg->iec60958_cfg->status[3]);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_I2S_CHST5,\r\ncfg->iec60958_cfg->status[4]);\r\nr = hdmi_read_reg(av_base, HDMI_CORE_AV_I2S_IN_CTRL);\r\nr = FLD_MOD(r, cfg->i2s_cfg.sck_edge_mode, 6, 6);\r\nr = FLD_MOD(r, cfg->i2s_cfg.vbit, 4, 4);\r\nr = FLD_MOD(r, cfg->i2s_cfg.justification, 2, 2);\r\nr = FLD_MOD(r, cfg->i2s_cfg.direction, 1, 1);\r\nr = FLD_MOD(r, cfg->i2s_cfg.shift, 0, 0);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_I2S_IN_CTRL, r);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_I2S_IN_LEN,\r\ncfg->i2s_cfg.in_length_bits, 3, 0);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_HDMI_CTRL, cfg->layout, 2, 1);\r\nr = hdmi_read_reg(av_base, HDMI_CORE_AV_AUD_MODE);\r\nr = FLD_MOD(r, cfg->i2s_cfg.active_sds, 7, 4);\r\nr = FLD_MOD(r, cfg->en_dsd_audio, 3, 3);\r\nr = FLD_MOD(r, cfg->en_parallel_aud_input, 2, 2);\r\nr = FLD_MOD(r, cfg->en_spdif, 1, 1);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_MODE, r);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_I2S_IN_MAP, 0x78);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_SWAP_I2S, 1, 5, 5);\r\n}\r\nstatic void hdmi_core_audio_infoframe_cfg(struct hdmi_core_data *core,\r\nstruct snd_cea_861_aud_if *info_aud)\r\n{\r\nu8 sum = 0, checksum = 0;\r\nvoid __iomem *av_base = hdmi_av_base(core);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUDIO_TYPE, 0x84);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUDIO_VERS, 0x01);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUDIO_LEN, 0x0a);\r\nsum += 0x84 + 0x001 + 0x00a;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(0),\r\ninfo_aud->db1_ct_cc);\r\nsum += info_aud->db1_ct_cc;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(1),\r\ninfo_aud->db2_sf_ss);\r\nsum += info_aud->db2_sf_ss;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(2), info_aud->db3);\r\nsum += info_aud->db3;\r\nif (info_aud->db4_ca != 0x00)\r\ninfo_aud->db4_ca = 0x13;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(3), info_aud->db4_ca);\r\nsum += info_aud->db4_ca;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(4),\r\ninfo_aud->db5_dminh_lsv);\r\nsum += info_aud->db5_dminh_lsv;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(5), 0x00);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(6), 0x00);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(7), 0x00);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(8), 0x00);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(9), 0x00);\r\nchecksum = 0x100 - sum;\r\nhdmi_write_reg(av_base,\r\nHDMI_CORE_AV_AUDIO_CHSUM, checksum);\r\n}\r\nint hdmi4_audio_config(struct hdmi_core_data *core, struct hdmi_wp_data *wp,\r\nstruct omap_dss_audio *audio, u32 pclk)\r\n{\r\nstruct hdmi_audio_format audio_format;\r\nstruct hdmi_audio_dma audio_dma;\r\nstruct hdmi_core_audio_config acore;\r\nint err, n, cts, channel_count;\r\nunsigned int fs_nr;\r\nbool word_length_16b = false;\r\nif (!audio || !audio->iec || !audio->cea || !core)\r\nreturn -EINVAL;\r\nacore.iec60958_cfg = audio->iec;\r\nif (!(audio->iec->status[4] & IEC958_AES4_CON_MAX_WORDLEN_24))\r\nif (audio->iec->status[4] & IEC958_AES4_CON_WORDLEN_20_16)\r\nword_length_16b = true;\r\nif (word_length_16b)\r\nacore.i2s_cfg.justification = HDMI_AUDIO_JUSTIFY_LEFT;\r\nelse\r\nacore.i2s_cfg.justification = HDMI_AUDIO_JUSTIFY_RIGHT;\r\nacore.i2s_cfg.in_length_bits = audio->iec->status[4]\r\n& IEC958_AES4_CON_WORDLEN;\r\nif (audio->iec->status[4] & IEC958_AES4_CON_MAX_WORDLEN_24)\r\nacore.i2s_cfg.in_length_bits++;\r\nacore.i2s_cfg.sck_edge_mode = HDMI_AUDIO_I2S_SCK_EDGE_RISING;\r\nacore.i2s_cfg.vbit = HDMI_AUDIO_I2S_VBIT_FOR_PCM;\r\nacore.i2s_cfg.direction = HDMI_AUDIO_I2S_MSB_SHIFTED_FIRST;\r\nacore.i2s_cfg.shift = HDMI_AUDIO_I2S_FIRST_BIT_SHIFT;\r\nswitch (audio->iec->status[3] & IEC958_AES3_CON_FS) {\r\ncase IEC958_AES3_CON_FS_32000:\r\nfs_nr = 32000;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_44100:\r\nfs_nr = 44100;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_48000:\r\nfs_nr = 48000;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_88200:\r\nfs_nr = 88200;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_96000:\r\nfs_nr = 96000;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_176400:\r\nfs_nr = 176400;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_192000:\r\nfs_nr = 192000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nerr = hdmi_compute_acr(pclk, fs_nr, &n, &cts);\r\nacore.n = n;\r\nacore.cts = cts;\r\nif (dss_has_feature(FEAT_HDMI_CTS_SWMODE)) {\r\nacore.aud_par_busclk = 0;\r\nacore.cts_mode = HDMI_AUDIO_CTS_MODE_SW;\r\nacore.use_mclk = dss_has_feature(FEAT_HDMI_AUDIO_USE_MCLK);\r\n} else {\r\nacore.aud_par_busclk = (((128 * 31) - 1) << 8);\r\nacore.cts_mode = HDMI_AUDIO_CTS_MODE_HW;\r\nacore.use_mclk = true;\r\n}\r\nif (acore.use_mclk)\r\nacore.mclk_mode = HDMI_AUDIO_MCLK_128FS;\r\nchannel_count = (audio->cea->db1_ct_cc &\r\nCEA861_AUDIO_INFOFRAME_DB1CC) + 1;\r\nswitch (channel_count) {\r\ncase 2:\r\naudio_format.active_chnnls_msk = 0x03;\r\nbreak;\r\ncase 3:\r\naudio_format.active_chnnls_msk = 0x07;\r\nbreak;\r\ncase 4:\r\naudio_format.active_chnnls_msk = 0x0f;\r\nbreak;\r\ncase 5:\r\naudio_format.active_chnnls_msk = 0x1f;\r\nbreak;\r\ncase 6:\r\naudio_format.active_chnnls_msk = 0x3f;\r\nbreak;\r\ncase 7:\r\naudio_format.active_chnnls_msk = 0x7f;\r\nbreak;\r\ncase 8:\r\naudio_format.active_chnnls_msk = 0xff;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (channel_count == 2) {\r\naudio_format.stereo_channels = HDMI_AUDIO_STEREO_ONECHANNEL;\r\nacore.i2s_cfg.active_sds = HDMI_AUDIO_I2S_SD0_EN;\r\nacore.layout = HDMI_AUDIO_LAYOUT_2CH;\r\n} else {\r\naudio_format.stereo_channels = HDMI_AUDIO_STEREO_FOURCHANNELS;\r\nacore.i2s_cfg.active_sds = HDMI_AUDIO_I2S_SD0_EN |\r\nHDMI_AUDIO_I2S_SD1_EN | HDMI_AUDIO_I2S_SD2_EN |\r\nHDMI_AUDIO_I2S_SD3_EN;\r\nacore.layout = HDMI_AUDIO_LAYOUT_8CH;\r\naudio->cea->db1_ct_cc = 7;\r\n}\r\nacore.en_spdif = false;\r\nacore.fs_override = true;\r\nacore.en_acr_pkt = true;\r\nacore.en_dsd_audio = false;\r\nacore.en_parallel_aud_input = true;\r\nif (word_length_16b)\r\naudio_dma.transfer_size = 0x10;\r\nelse\r\naudio_dma.transfer_size = 0x20;\r\naudio_dma.block_size = 0xC0;\r\naudio_dma.mode = HDMI_AUDIO_TRANSF_DMA;\r\naudio_dma.fifo_threshold = 0x20;\r\nif (word_length_16b) {\r\naudio_format.samples_per_word = HDMI_AUDIO_ONEWORD_TWOSAMPLES;\r\naudio_format.sample_size = HDMI_AUDIO_SAMPLE_16BITS;\r\naudio_format.justification = HDMI_AUDIO_JUSTIFY_LEFT;\r\n} else {\r\naudio_format.samples_per_word = HDMI_AUDIO_ONEWORD_ONESAMPLE;\r\naudio_format.sample_size = HDMI_AUDIO_SAMPLE_24BITS;\r\naudio_format.justification = HDMI_AUDIO_JUSTIFY_RIGHT;\r\n}\r\naudio_format.type = HDMI_AUDIO_TYPE_LPCM;\r\naudio_format.sample_order = HDMI_AUDIO_SAMPLE_LEFT_FIRST;\r\naudio_format.en_sig_blk_strt_end = HDMI_AUDIO_BLOCK_SIG_STARTEND_ON;\r\nhdmi_wp_audio_config_dma(wp, &audio_dma);\r\nhdmi_wp_audio_config_format(wp, &audio_format);\r\nhdmi_core_audio_config(core, &acore);\r\nhdmi_core_audio_infoframe_cfg(core, audio->cea);\r\nreturn 0;\r\n}\r\nint hdmi4_audio_start(struct hdmi_core_data *core, struct hdmi_wp_data *wp)\r\n{\r\nREG_FLD_MOD(hdmi_av_base(core),\r\nHDMI_CORE_AV_AUD_MODE, true, 0, 0);\r\nhdmi_wp_audio_core_req_enable(wp, true);\r\nreturn 0;\r\n}\r\nvoid hdmi4_audio_stop(struct hdmi_core_data *core, struct hdmi_wp_data *wp)\r\n{\r\nREG_FLD_MOD(hdmi_av_base(core),\r\nHDMI_CORE_AV_AUD_MODE, false, 0, 0);\r\nhdmi_wp_audio_core_req_enable(wp, false);\r\n}\r\nint hdmi4_core_init(struct platform_device *pdev, struct hdmi_core_data *core)\r\n{\r\nstruct resource *res;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "core");\r\nif (!res) {\r\nDSSERR("can't get CORE mem resource\n");\r\nreturn -EINVAL;\r\n}\r\ncore->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(core->base)) {\r\nDSSERR("can't ioremap CORE\n");\r\nreturn PTR_ERR(core->base);\r\n}\r\nreturn 0;\r\n}

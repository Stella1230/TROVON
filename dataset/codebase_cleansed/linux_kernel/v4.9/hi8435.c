static int hi8435_readb(struct hi8435_priv *priv, u8 reg, u8 *val)\r\n{\r\nreg |= HI8435_READ_OPCODE;\r\nreturn spi_write_then_read(priv->spi, &reg, 1, val, 1);\r\n}\r\nstatic int hi8435_readw(struct hi8435_priv *priv, u8 reg, u16 *val)\r\n{\r\nint ret;\r\n__be16 be_val;\r\nreg |= HI8435_READ_OPCODE;\r\nret = spi_write_then_read(priv->spi, &reg, 1, &be_val, 2);\r\n*val = be16_to_cpu(be_val);\r\nreturn ret;\r\n}\r\nstatic int hi8435_readl(struct hi8435_priv *priv, u8 reg, u32 *val)\r\n{\r\nint ret;\r\n__be32 be_val;\r\nreg |= HI8435_READ_OPCODE;\r\nret = spi_write_then_read(priv->spi, &reg, 1, &be_val, 4);\r\n*val = be32_to_cpu(be_val);\r\nreturn ret;\r\n}\r\nstatic int hi8435_writeb(struct hi8435_priv *priv, u8 reg, u8 val)\r\n{\r\npriv->reg_buffer[0] = reg | HI8435_WRITE_OPCODE;\r\npriv->reg_buffer[1] = val;\r\nreturn spi_write(priv->spi, priv->reg_buffer, 2);\r\n}\r\nstatic int hi8435_writew(struct hi8435_priv *priv, u8 reg, u16 val)\r\n{\r\npriv->reg_buffer[0] = reg | HI8435_WRITE_OPCODE;\r\npriv->reg_buffer[1] = (val >> 8) & 0xff;\r\npriv->reg_buffer[2] = val & 0xff;\r\nreturn spi_write(priv->spi, priv->reg_buffer, 3);\r\n}\r\nstatic int hi8435_read_event_config(struct iio_dev *idev,\r\nconst struct iio_chan_spec *chan,\r\nenum iio_event_type type,\r\nenum iio_event_direction dir)\r\n{\r\nstruct hi8435_priv *priv = iio_priv(idev);\r\nreturn !!(priv->event_scan_mask & BIT(chan->channel));\r\n}\r\nstatic int hi8435_write_event_config(struct iio_dev *idev,\r\nconst struct iio_chan_spec *chan,\r\nenum iio_event_type type,\r\nenum iio_event_direction dir, int state)\r\n{\r\nstruct hi8435_priv *priv = iio_priv(idev);\r\npriv->event_scan_mask &= ~BIT(chan->channel);\r\nif (state)\r\npriv->event_scan_mask |= BIT(chan->channel);\r\nreturn 0;\r\n}\r\nstatic int hi8435_read_event_value(struct iio_dev *idev,\r\nconst struct iio_chan_spec *chan,\r\nenum iio_event_type type,\r\nenum iio_event_direction dir,\r\nenum iio_event_info info,\r\nint *val, int *val2)\r\n{\r\nstruct hi8435_priv *priv = iio_priv(idev);\r\nint ret;\r\nu8 mode, psen;\r\nu16 reg;\r\nret = hi8435_readb(priv, HI8435_PSEN_REG, &psen);\r\nif (ret < 0)\r\nreturn ret;\r\nmode = !!(psen & BIT(chan->channel / 8));\r\nret = hi8435_readw(priv, mode ? HI8435_SOCENHYS_REG :\r\nHI8435_GOCENHYS_REG, &reg);\r\nif (ret < 0)\r\nreturn ret;\r\nif (dir == IIO_EV_DIR_FALLING)\r\n*val = ((reg & 0xff) - (reg >> 8)) / 2;\r\nelse if (dir == IIO_EV_DIR_RISING)\r\n*val = ((reg & 0xff) + (reg >> 8)) / 2;\r\nreturn IIO_VAL_INT;\r\n}\r\nstatic int hi8435_write_event_value(struct iio_dev *idev,\r\nconst struct iio_chan_spec *chan,\r\nenum iio_event_type type,\r\nenum iio_event_direction dir,\r\nenum iio_event_info info,\r\nint val, int val2)\r\n{\r\nstruct hi8435_priv *priv = iio_priv(idev);\r\nint ret;\r\nu8 mode, psen;\r\nu16 reg;\r\nret = hi8435_readb(priv, HI8435_PSEN_REG, &psen);\r\nif (ret < 0)\r\nreturn ret;\r\nmode = !!(psen & BIT(chan->channel / 8));\r\nret = hi8435_readw(priv, mode ? HI8435_SOCENHYS_REG :\r\nHI8435_GOCENHYS_REG, &reg);\r\nif (ret < 0)\r\nreturn ret;\r\nif (dir == IIO_EV_DIR_FALLING) {\r\nif (val < 2 || val > 21 || (val + 2) > priv->threshold_hi[mode])\r\nreturn -EINVAL;\r\nif (val == priv->threshold_lo[mode])\r\nreturn 0;\r\npriv->threshold_lo[mode] = val;\r\nif ((priv->threshold_hi[mode] - priv->threshold_lo[mode]) % 2)\r\npriv->threshold_hi[mode]--;\r\n} else if (dir == IIO_EV_DIR_RISING) {\r\nif (val < 3 || val > 22 || val < (priv->threshold_lo[mode] + 2))\r\nreturn -EINVAL;\r\nif (val == priv->threshold_hi[mode])\r\nreturn 0;\r\npriv->threshold_hi[mode] = val;\r\nif ((priv->threshold_hi[mode] - priv->threshold_lo[mode]) % 2)\r\npriv->threshold_lo[mode]++;\r\n}\r\nmutex_lock(&priv->lock);\r\nret = hi8435_readw(priv, mode ? HI8435_SOCENHYS_REG :\r\nHI8435_GOCENHYS_REG, &reg);\r\nif (ret < 0) {\r\nmutex_unlock(&priv->lock);\r\nreturn ret;\r\n}\r\nreg = priv->threshold_hi[mode] - priv->threshold_lo[mode];\r\nreg <<= 8;\r\nreg |= (priv->threshold_hi[mode] + priv->threshold_lo[mode]);\r\nret = hi8435_writew(priv, mode ? HI8435_SOCENHYS_REG :\r\nHI8435_GOCENHYS_REG, reg);\r\nmutex_unlock(&priv->lock);\r\nreturn ret;\r\n}\r\nstatic int hi8435_debugfs_reg_access(struct iio_dev *idev,\r\nunsigned reg, unsigned writeval,\r\nunsigned *readval)\r\n{\r\nstruct hi8435_priv *priv = iio_priv(idev);\r\nint ret;\r\nu8 val;\r\nif (readval != NULL) {\r\nret = hi8435_readb(priv, reg, &val);\r\n*readval = val;\r\n} else {\r\nval = (u8)writeval;\r\nret = hi8435_writeb(priv, reg, val);\r\n}\r\nreturn ret;\r\n}\r\nstatic int hi8435_get_sensing_mode(struct iio_dev *idev,\r\nconst struct iio_chan_spec *chan)\r\n{\r\nstruct hi8435_priv *priv = iio_priv(idev);\r\nint ret;\r\nu8 reg;\r\nret = hi8435_readb(priv, HI8435_PSEN_REG, &reg);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn !!(reg & BIT(chan->channel / 8));\r\n}\r\nstatic int hi8435_set_sensing_mode(struct iio_dev *idev,\r\nconst struct iio_chan_spec *chan,\r\nunsigned int mode)\r\n{\r\nstruct hi8435_priv *priv = iio_priv(idev);\r\nint ret;\r\nu8 reg;\r\nmutex_lock(&priv->lock);\r\nret = hi8435_readb(priv, HI8435_PSEN_REG, &reg);\r\nif (ret < 0) {\r\nmutex_unlock(&priv->lock);\r\nreturn ret;\r\n}\r\nreg &= ~BIT(chan->channel / 8);\r\nif (mode)\r\nreg |= BIT(chan->channel / 8);\r\nret = hi8435_writeb(priv, HI8435_PSEN_REG, reg);\r\nmutex_unlock(&priv->lock);\r\nreturn ret;\r\n}\r\nstatic void hi8435_iio_push_event(struct iio_dev *idev, unsigned int val)\r\n{\r\nstruct hi8435_priv *priv = iio_priv(idev);\r\nenum iio_event_direction dir;\r\nunsigned int i;\r\nunsigned int status = priv->event_prev_val ^ val;\r\nif (!status)\r\nreturn;\r\nfor_each_set_bit(i, &priv->event_scan_mask, 32) {\r\nif (status & BIT(i)) {\r\ndir = val & BIT(i) ? IIO_EV_DIR_RISING :\r\nIIO_EV_DIR_FALLING;\r\niio_push_event(idev,\r\nIIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, i,\r\nIIO_EV_TYPE_THRESH, dir),\r\niio_get_time_ns(idev));\r\n}\r\n}\r\npriv->event_prev_val = val;\r\n}\r\nstatic irqreturn_t hi8435_trigger_handler(int irq, void *private)\r\n{\r\nstruct iio_poll_func *pf = private;\r\nstruct iio_dev *idev = pf->indio_dev;\r\nstruct hi8435_priv *priv = iio_priv(idev);\r\nu32 val;\r\nint ret;\r\nret = hi8435_readl(priv, HI8435_SO31_0_REG, &val);\r\nif (ret < 0)\r\ngoto err_read;\r\nhi8435_iio_push_event(idev, val);\r\nerr_read:\r\niio_trigger_notify_done(idev->trig);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int hi8435_probe(struct spi_device *spi)\r\n{\r\nstruct iio_dev *idev;\r\nstruct hi8435_priv *priv;\r\nstruct gpio_desc *reset_gpio;\r\nint ret;\r\nidev = devm_iio_device_alloc(&spi->dev, sizeof(*priv));\r\nif (!idev)\r\nreturn -ENOMEM;\r\npriv = iio_priv(idev);\r\npriv->spi = spi;\r\nreset_gpio = devm_gpiod_get(&spi->dev, NULL, GPIOD_OUT_LOW);\r\nif (IS_ERR(reset_gpio)) {\r\nhi8435_writeb(priv, HI8435_CTRL_REG, HI8435_CTRL_SRST);\r\nhi8435_writeb(priv, HI8435_CTRL_REG, 0);\r\n} else {\r\nudelay(5);\r\ngpiod_set_value(reset_gpio, 1);\r\n}\r\nspi_set_drvdata(spi, idev);\r\nmutex_init(&priv->lock);\r\nidev->dev.parent = &spi->dev;\r\nidev->dev.of_node = spi->dev.of_node;\r\nidev->name = spi_get_device_id(spi)->name;\r\nidev->modes = INDIO_DIRECT_MODE;\r\nidev->info = &hi8435_info;\r\nidev->channels = hi8435_channels;\r\nidev->num_channels = ARRAY_SIZE(hi8435_channels);\r\npriv->event_scan_mask = ~(0);\r\npriv->threshold_lo[0] = priv->threshold_lo[1] = 2;\r\npriv->threshold_hi[0] = priv->threshold_hi[1] = 4;\r\nhi8435_writew(priv, HI8435_GOCENHYS_REG, 0x206);\r\nhi8435_writew(priv, HI8435_SOCENHYS_REG, 0x206);\r\nret = iio_triggered_event_setup(idev, NULL, hi8435_trigger_handler);\r\nif (ret)\r\nreturn ret;\r\nret = iio_device_register(idev);\r\nif (ret < 0) {\r\ndev_err(&spi->dev, "unable to register device\n");\r\ngoto unregister_triggered_event;\r\n}\r\nreturn 0;\r\nunregister_triggered_event:\r\niio_triggered_event_cleanup(idev);\r\nreturn ret;\r\n}\r\nstatic int hi8435_remove(struct spi_device *spi)\r\n{\r\nstruct iio_dev *idev = spi_get_drvdata(spi);\r\niio_device_unregister(idev);\r\niio_triggered_event_cleanup(idev);\r\nreturn 0;\r\n}

int init_module(void)\r\n{\r\nsave_emul_imprecise = alpha_fp_emul_imprecise;\r\nsave_emul = alpha_fp_emul;\r\nalpha_fp_emul_imprecise = do_alpha_fp_emul_imprecise;\r\nalpha_fp_emul = do_alpha_fp_emul;\r\nreturn 0;\r\n}\r\nvoid cleanup_module(void)\r\n{\r\nalpha_fp_emul_imprecise = save_emul_imprecise;\r\nalpha_fp_emul = save_emul;\r\n}\r\nlong\r\nalpha_fp_emul (unsigned long pc)\r\n{\r\nFP_DECL_EX;\r\nFP_DECL_S(SA); FP_DECL_S(SB); FP_DECL_S(SR);\r\nFP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DR);\r\nunsigned long fa, fb, fc, func, mode, src;\r\nunsigned long res, va, vb, vc, swcr, fpcr;\r\n__u32 insn;\r\nlong si_code;\r\nget_user(insn, (__u32 __user *)pc);\r\nfc = (insn >> 0) & 0x1f;\r\nfb = (insn >> 16) & 0x1f;\r\nfa = (insn >> 21) & 0x1f;\r\nfunc = (insn >> 5) & 0xf;\r\nsrc = (insn >> 9) & 0x3;\r\nmode = (insn >> 11) & 0x3;\r\nfpcr = rdfpcr();\r\nswcr = swcr_update_status(current_thread_info()->ieee_state, fpcr);\r\nif (mode == 3) {\r\nmode = (fpcr >> FPCR_DYN_SHIFT) & 3;\r\n}\r\nswitch (src) {\r\ncase FOP_SRC_S:\r\nva = alpha_read_fp_reg_s(fa);\r\nvb = alpha_read_fp_reg_s(fb);\r\nFP_UNPACK_SP(SA, &va);\r\nFP_UNPACK_SP(SB, &vb);\r\nswitch (func) {\r\ncase FOP_FNC_SUBx:\r\nFP_SUB_S(SR, SA, SB);\r\ngoto pack_s;\r\ncase FOP_FNC_ADDx:\r\nFP_ADD_S(SR, SA, SB);\r\ngoto pack_s;\r\ncase FOP_FNC_MULx:\r\nFP_MUL_S(SR, SA, SB);\r\ngoto pack_s;\r\ncase FOP_FNC_DIVx:\r\nFP_DIV_S(SR, SA, SB);\r\ngoto pack_s;\r\ncase FOP_FNC_SQRTx:\r\nFP_SQRT_S(SR, SB);\r\ngoto pack_s;\r\n}\r\ngoto bad_insn;\r\ncase FOP_SRC_T:\r\nva = alpha_read_fp_reg(fa);\r\nvb = alpha_read_fp_reg(fb);\r\nif ((func & ~3) == FOP_FNC_CMPxUN) {\r\nFP_UNPACK_RAW_DP(DA, &va);\r\nFP_UNPACK_RAW_DP(DB, &vb);\r\nif (!DA_e && !_FP_FRAC_ZEROP_1(DA)) {\r\nFP_SET_EXCEPTION(FP_EX_DENORM);\r\nif (FP_DENORM_ZERO)\r\n_FP_FRAC_SET_1(DA, _FP_ZEROFRAC_1);\r\n}\r\nif (!DB_e && !_FP_FRAC_ZEROP_1(DB)) {\r\nFP_SET_EXCEPTION(FP_EX_DENORM);\r\nif (FP_DENORM_ZERO)\r\n_FP_FRAC_SET_1(DB, _FP_ZEROFRAC_1);\r\n}\r\nFP_CMP_D(res, DA, DB, 3);\r\nvc = 0x4000000000000000UL;\r\nif (res == 3\r\n&& ((func & 3) >= 2\r\n|| FP_ISSIGNAN_D(DA)\r\n|| FP_ISSIGNAN_D(DB))) {\r\nFP_SET_EXCEPTION(FP_EX_INVALID);\r\n}\r\nswitch (func) {\r\ncase FOP_FNC_CMPxUN: if (res != 3) vc = 0; break;\r\ncase FOP_FNC_CMPxEQ: if (res) vc = 0; break;\r\ncase FOP_FNC_CMPxLT: if (res != -1) vc = 0; break;\r\ncase FOP_FNC_CMPxLE: if ((long)res > 0) vc = 0; break;\r\n}\r\ngoto done_d;\r\n}\r\nFP_UNPACK_DP(DA, &va);\r\nFP_UNPACK_DP(DB, &vb);\r\nswitch (func) {\r\ncase FOP_FNC_SUBx:\r\nFP_SUB_D(DR, DA, DB);\r\ngoto pack_d;\r\ncase FOP_FNC_ADDx:\r\nFP_ADD_D(DR, DA, DB);\r\ngoto pack_d;\r\ncase FOP_FNC_MULx:\r\nFP_MUL_D(DR, DA, DB);\r\ngoto pack_d;\r\ncase FOP_FNC_DIVx:\r\nFP_DIV_D(DR, DA, DB);\r\ngoto pack_d;\r\ncase FOP_FNC_SQRTx:\r\nFP_SQRT_D(DR, DB);\r\ngoto pack_d;\r\ncase FOP_FNC_CVTxS:\r\nif (insn & 0x2000) {\r\nFP_CONV(S,D,1,1,SR,DB);\r\ngoto pack_s;\r\n} else {\r\nvb = alpha_read_fp_reg_s(fb);\r\nFP_UNPACK_SP(SB, &vb);\r\nDR_c = DB_c;\r\nDR_s = DB_s;\r\nDR_e = DB_e + (1024 - 128);\r\nDR_f = SB_f << (52 - 23);\r\ngoto pack_d;\r\n}\r\ncase FOP_FNC_CVTxQ:\r\nif (DB_c == FP_CLS_NAN\r\n&& (_FP_FRAC_HIGH_RAW_D(DB) & _FP_QNANBIT_D)) {\r\nvc = 0;\r\n} else\r\nFP_TO_INT_ROUND_D(vc, DB, 64, 2);\r\ngoto done_d;\r\n}\r\ngoto bad_insn;\r\ncase FOP_SRC_Q:\r\nvb = alpha_read_fp_reg(fb);\r\nswitch (func) {\r\ncase FOP_FNC_CVTQL:\r\nvc = ((vb & 0xc0000000) << 32 |\r\n(vb & 0x3fffffff) << 29);\r\nFP_SET_EXCEPTION (FP_EX_INVALID);\r\ngoto done_d;\r\ncase FOP_FNC_CVTxS:\r\nFP_FROM_INT_S(SR, ((long)vb), 64, long);\r\ngoto pack_s;\r\ncase FOP_FNC_CVTxT:\r\nFP_FROM_INT_D(DR, ((long)vb), 64, long);\r\ngoto pack_d;\r\n}\r\ngoto bad_insn;\r\n}\r\ngoto bad_insn;\r\npack_s:\r\nFP_PACK_SP(&vc, SR);\r\nif ((_fex & FP_EX_UNDERFLOW) && (swcr & IEEE_MAP_UMZ))\r\nvc = 0;\r\nalpha_write_fp_reg_s(fc, vc);\r\ngoto done;\r\npack_d:\r\nFP_PACK_DP(&vc, DR);\r\nif ((_fex & FP_EX_UNDERFLOW) && (swcr & IEEE_MAP_UMZ))\r\nvc = 0;\r\ndone_d:\r\nalpha_write_fp_reg(fc, vc);\r\ngoto done;\r\ndone:\r\nif (_fex) {\r\nswcr |= (_fex << IEEE_STATUS_TO_EXCSUM_SHIFT);\r\ncurrent_thread_info()->ieee_state\r\n|= (_fex << IEEE_STATUS_TO_EXCSUM_SHIFT);\r\nfpcr &= (~FPCR_MASK | FPCR_DYN_MASK);\r\nfpcr |= ieee_swcr_to_fpcr(swcr);\r\nwrfpcr(fpcr);\r\n_fex = _fex & swcr & IEEE_TRAP_ENABLE_MASK;\r\nsi_code = 0;\r\nif (_fex) {\r\nif (_fex & IEEE_TRAP_ENABLE_DNO) si_code = FPE_FLTUND;\r\nif (_fex & IEEE_TRAP_ENABLE_INE) si_code = FPE_FLTRES;\r\nif (_fex & IEEE_TRAP_ENABLE_UNF) si_code = FPE_FLTUND;\r\nif (_fex & IEEE_TRAP_ENABLE_OVF) si_code = FPE_FLTOVF;\r\nif (_fex & IEEE_TRAP_ENABLE_DZE) si_code = FPE_FLTDIV;\r\nif (_fex & IEEE_TRAP_ENABLE_INV) si_code = FPE_FLTINV;\r\n}\r\nreturn si_code;\r\n}\r\nreturn 0;\r\nbad_insn:\r\nprintk(KERN_ERR "alpha_fp_emul: Invalid FP insn %#x at %#lx\n",\r\ninsn, pc);\r\nreturn -1;\r\n}\r\nlong\r\nalpha_fp_emul_imprecise (struct pt_regs *regs, unsigned long write_mask)\r\n{\r\nunsigned long trigger_pc = regs->pc - 4;\r\nunsigned long insn, opcode, rc, si_code = 0;\r\nwhile (write_mask) {\r\nget_user(insn, (__u32 __user *)(trigger_pc));\r\nopcode = insn >> 26;\r\nrc = insn & 0x1f;\r\nswitch (opcode) {\r\ncase OPC_PAL:\r\ncase OPC_JSR:\r\ncase 0x30 ... 0x3f:\r\ngoto egress;\r\ncase OPC_MISC:\r\nswitch (insn & 0xffff) {\r\ncase MISC_TRAPB:\r\ncase MISC_EXCB:\r\ngoto egress;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase OPC_INTA:\r\ncase OPC_INTL:\r\ncase OPC_INTS:\r\ncase OPC_INTM:\r\nwrite_mask &= ~(1UL << rc);\r\nbreak;\r\ncase OPC_FLTC:\r\ncase OPC_FLTV:\r\ncase OPC_FLTI:\r\ncase OPC_FLTL:\r\nwrite_mask &= ~(1UL << (rc + 32));\r\nbreak;\r\n}\r\nif (!write_mask) {\r\nregs->pc = trigger_pc + 4;\r\nsi_code = alpha_fp_emul(trigger_pc);\r\ngoto egress;\r\n}\r\ntrigger_pc -= 4;\r\n}\r\negress:\r\nreturn si_code;\r\n}

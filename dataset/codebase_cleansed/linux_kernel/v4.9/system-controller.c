void mvebu_restart(enum reboot_mode mode, const char *cmd)\r\n{\r\nif (!system_controller_base) {\r\npr_err("Cannot restart, system-controller not available: check the device tree\n");\r\n} else {\r\nwritel(mvebu_sc->rstoutn_mask_reset_out_en,\r\nsystem_controller_base +\r\nmvebu_sc->rstoutn_mask_offset);\r\nwritel(mvebu_sc->system_soft_reset,\r\nsystem_controller_base +\r\nmvebu_sc->system_soft_reset_offset);\r\n}\r\nwhile (1)\r\n;\r\n}\r\nint mvebu_system_controller_get_soc_id(u32 *dev, u32 *rev)\r\n{\r\nif (of_machine_is_compatible("marvell,armada380") &&\r\nsystem_controller_base) {\r\n*dev = readl(system_controller_base + mvebu_sc->dev_id) >> 16;\r\n*rev = (readl(system_controller_base + mvebu_sc->rev_id) >> 8)\r\n& 0xF;\r\nreturn 0;\r\n} else\r\nreturn -ENODEV;\r\n}\r\nstatic void mvebu_armada375_smp_wa_init(void)\r\n{\r\nu32 dev, rev;\r\nphys_addr_t resume_addr_reg;\r\nif (mvebu_get_soc_id(&dev, &rev) != 0)\r\nreturn;\r\nif (rev != ARMADA_375_Z1_REV)\r\nreturn;\r\nresume_addr_reg = system_controller_phys_base +\r\nmvebu_sc->resume_boot_addr;\r\nmvebu_setup_boot_addr_wa(ARMADA_375_CRYPT0_ENG_TARGET,\r\nARMADA_375_CRYPT0_ENG_ATTR,\r\nresume_addr_reg);\r\n}\r\nvoid mvebu_system_controller_set_cpu_boot_addr(void *boot_addr)\r\n{\r\nBUG_ON(system_controller_base == NULL);\r\nBUG_ON(mvebu_sc->resume_boot_addr == 0);\r\nif (of_machine_is_compatible("marvell,armada375"))\r\nmvebu_armada375_smp_wa_init();\r\nwritel(virt_to_phys(boot_addr), system_controller_base +\r\nmvebu_sc->resume_boot_addr);\r\n}\r\nstatic int __init mvebu_system_controller_init(void)\r\n{\r\nconst struct of_device_id *match;\r\nstruct device_node *np;\r\nnp = of_find_matching_node_and_match(NULL, of_system_controller_table,\r\n&match);\r\nif (np) {\r\nstruct resource res;\r\nsystem_controller_base = of_iomap(np, 0);\r\nof_address_to_resource(np, 0, &res);\r\nsystem_controller_phys_base = res.start;\r\nmvebu_sc = (struct mvebu_system_controller *)match->data;\r\nof_node_put(np);\r\n}\r\nreturn 0;\r\n}

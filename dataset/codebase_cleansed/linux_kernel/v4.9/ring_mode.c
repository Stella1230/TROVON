static int stmmac_jumbo_frm(void *p, struct sk_buff *skb, int csum)\r\n{\r\nstruct stmmac_priv *priv = (struct stmmac_priv *)p;\r\nunsigned int entry = priv->cur_tx;\r\nstruct dma_desc *desc;\r\nunsigned int nopaged_len = skb_headlen(skb);\r\nunsigned int bmax, len;\r\nif (priv->extend_desc)\r\ndesc = (struct dma_desc *)(priv->dma_etx + entry);\r\nelse\r\ndesc = priv->dma_tx + entry;\r\nif (priv->plat->enh_desc)\r\nbmax = BUF_SIZE_8KiB;\r\nelse\r\nbmax = BUF_SIZE_2KiB;\r\nlen = nopaged_len - bmax;\r\nif (nopaged_len > BUF_SIZE_8KiB) {\r\ndesc->des2 = dma_map_single(priv->device, skb->data,\r\nbmax, DMA_TO_DEVICE);\r\nif (dma_mapping_error(priv->device, desc->des2))\r\nreturn -1;\r\npriv->tx_skbuff_dma[entry].buf = desc->des2;\r\npriv->tx_skbuff_dma[entry].len = bmax;\r\npriv->tx_skbuff_dma[entry].is_jumbo = true;\r\ndesc->des3 = desc->des2 + BUF_SIZE_4KiB;\r\npriv->hw->desc->prepare_tx_desc(desc, 1, bmax, csum,\r\nSTMMAC_RING_MODE, 0, false);\r\npriv->tx_skbuff[entry] = NULL;\r\nentry = STMMAC_GET_ENTRY(entry, DMA_TX_SIZE);\r\nif (priv->extend_desc)\r\ndesc = (struct dma_desc *)(priv->dma_etx + entry);\r\nelse\r\ndesc = priv->dma_tx + entry;\r\ndesc->des2 = dma_map_single(priv->device, skb->data + bmax,\r\nlen, DMA_TO_DEVICE);\r\nif (dma_mapping_error(priv->device, desc->des2))\r\nreturn -1;\r\npriv->tx_skbuff_dma[entry].buf = desc->des2;\r\npriv->tx_skbuff_dma[entry].len = len;\r\npriv->tx_skbuff_dma[entry].is_jumbo = true;\r\ndesc->des3 = desc->des2 + BUF_SIZE_4KiB;\r\npriv->hw->desc->prepare_tx_desc(desc, 0, len, csum,\r\nSTMMAC_RING_MODE, 1, true);\r\n} else {\r\ndesc->des2 = dma_map_single(priv->device, skb->data,\r\nnopaged_len, DMA_TO_DEVICE);\r\nif (dma_mapping_error(priv->device, desc->des2))\r\nreturn -1;\r\npriv->tx_skbuff_dma[entry].buf = desc->des2;\r\npriv->tx_skbuff_dma[entry].len = nopaged_len;\r\npriv->tx_skbuff_dma[entry].is_jumbo = true;\r\ndesc->des3 = desc->des2 + BUF_SIZE_4KiB;\r\npriv->hw->desc->prepare_tx_desc(desc, 1, nopaged_len, csum,\r\nSTMMAC_RING_MODE, 0, true);\r\n}\r\npriv->cur_tx = entry;\r\nreturn entry;\r\n}\r\nstatic unsigned int stmmac_is_jumbo_frm(int len, int enh_desc)\r\n{\r\nunsigned int ret = 0;\r\nif (len >= BUF_SIZE_4KiB)\r\nret = 1;\r\nreturn ret;\r\n}\r\nstatic void stmmac_refill_desc3(void *priv_ptr, struct dma_desc *p)\r\n{\r\nstruct stmmac_priv *priv = (struct stmmac_priv *)priv_ptr;\r\nif (priv->dma_buf_sz >= BUF_SIZE_8KiB)\r\np->des3 = p->des2 + BUF_SIZE_8KiB;\r\n}\r\nstatic void stmmac_init_desc3(struct dma_desc *p)\r\n{\r\np->des3 = p->des2 + BUF_SIZE_8KiB;\r\n}\r\nstatic void stmmac_clean_desc3(void *priv_ptr, struct dma_desc *p)\r\n{\r\nstruct stmmac_priv *priv = (struct stmmac_priv *)priv_ptr;\r\nunsigned int entry = priv->dirty_tx;\r\nif (unlikely(priv->tx_skbuff_dma[entry].is_jumbo ||\r\n(priv->tx_skbuff_dma[entry].last_segment &&\r\n!priv->extend_desc && priv->hwts_tx_en)))\r\np->des3 = 0;\r\n}\r\nstatic int stmmac_set_16kib_bfsize(int mtu)\r\n{\r\nint ret = 0;\r\nif (unlikely(mtu >= BUF_SIZE_8KiB))\r\nret = BUF_SIZE_16KiB;\r\nreturn ret;\r\n}

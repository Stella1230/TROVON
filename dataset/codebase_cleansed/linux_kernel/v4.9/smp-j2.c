static irqreturn_t j2_ipi_interrupt_handler(int irq, void *arg)\r\n{\r\nunsigned cpu = hard_smp_processor_id();\r\nvolatile unsigned *pmsg = &per_cpu(j2_ipi_messages, cpu);\r\nunsigned messages, i;\r\ndo messages = *pmsg;\r\nwhile (cmpxchg(pmsg, messages, 0) != messages);\r\nif (!messages) return IRQ_NONE;\r\nfor (i=0; i<SMP_MSG_NR; i++)\r\nif (messages & (1U<<i))\r\nsmp_message_recv(i);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void j2_smp_setup(void)\r\n{\r\n}\r\nstatic void j2_prepare_cpus(unsigned int max_cpus)\r\n{\r\nstruct device_node *np;\r\nunsigned i, max = 1;\r\nnp = of_find_compatible_node(NULL, NULL, "jcore,ipi-controller");\r\nif (!np)\r\ngoto out;\r\nj2_ipi_irq = irq_of_parse_and_map(np, 0);\r\nj2_ipi_trigger = of_iomap(np, 0);\r\nif (!j2_ipi_irq || !j2_ipi_trigger)\r\ngoto out;\r\nnp = of_find_compatible_node(NULL, NULL, "jcore,cpuid-mmio");\r\nif (!np)\r\ngoto out;\r\nsh2_cpuid_addr = of_iomap(np, 0);\r\nif (!sh2_cpuid_addr)\r\ngoto out;\r\nif (request_irq(j2_ipi_irq, j2_ipi_interrupt_handler, IRQF_PERCPU,\r\n"ipi", (void *)j2_ipi_interrupt_handler) != 0)\r\ngoto out;\r\nmax = max_cpus;\r\nout:\r\nfor (i=max; i<NR_CPUS; i++) {\r\nset_cpu_possible(i, false);\r\nset_cpu_present(i, false);\r\n}\r\n}\r\nstatic void j2_start_cpu(unsigned int cpu, unsigned long entry_point)\r\n{\r\nstruct device_node *np;\r\nu32 regs[2];\r\nvoid __iomem *release, *initpc;\r\nif (!cpu) return;\r\nnp = of_get_cpu_node(cpu, NULL);\r\nif (!np) return;\r\nif (of_property_read_u32_array(np, "cpu-release-addr", regs, 2)) return;\r\nrelease = ioremap_nocache(regs[0], sizeof(u32));\r\ninitpc = ioremap_nocache(regs[1], sizeof(u32));\r\n__raw_writel(entry_point, initpc);\r\n__raw_writel(1, release);\r\niounmap(initpc);\r\niounmap(release);\r\npr_info("J2 SMP: requested start of cpu %u\n", cpu);\r\n}\r\nstatic unsigned int j2_smp_processor_id(void)\r\n{\r\nreturn __raw_readl(sh2_cpuid_addr);\r\n}\r\nstatic void j2_send_ipi(unsigned int cpu, unsigned int message)\r\n{\r\nvolatile unsigned *pmsg;\r\nunsigned old;\r\nunsigned long val;\r\npmsg = &per_cpu(j2_ipi_messages, cpu);\r\ndo old = *pmsg;\r\nwhile (cmpxchg(pmsg, old, old|(1U<<message)) != old);\r\nval = __raw_readl(j2_ipi_trigger + cpu);\r\n__raw_writel(val | (1U<<28), j2_ipi_trigger + cpu);\r\n}

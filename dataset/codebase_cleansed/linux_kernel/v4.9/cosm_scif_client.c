static int cosm_reboot_event(struct notifier_block *this, unsigned long event,\r\nvoid *ptr)\r\n{\r\nstruct cosm_msg msg = { .id = COSM_MSG_SHUTDOWN_STATUS };\r\nint rc;\r\nevent = (event == SYS_RESTART) ? SYSTEM_RESTART : event;\r\ndev_info(&client_spdev->dev, "%s %d received event %ld\n",\r\n__func__, __LINE__, event);\r\nmsg.shutdown_status = event;\r\nrc = scif_send(client_epd, &msg, sizeof(msg), SCIF_SEND_BLOCK);\r\nif (rc < 0)\r\ndev_err(&client_spdev->dev, "%s %d scif_send rc %d\n",\r\n__func__, __LINE__, rc);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic void cosm_set_time(struct cosm_msg *msg)\r\n{\r\nint rc = do_settimeofday64(&msg->timespec);\r\nif (rc)\r\ndev_err(&client_spdev->dev, "%s: %d settimeofday rc %d\n",\r\n__func__, __LINE__, rc);\r\n}\r\nstatic void cosm_client_recv(void)\r\n{\r\nstruct cosm_msg msg;\r\nint rc;\r\nwhile (1) {\r\nrc = scif_recv(client_epd, &msg, sizeof(msg), 0);\r\nif (!rc) {\r\nreturn;\r\n} else if (rc < 0) {\r\ndev_err(&client_spdev->dev, "%s: %d rc %d\n",\r\n__func__, __LINE__, rc);\r\nreturn;\r\n}\r\ndev_dbg(&client_spdev->dev, "%s: %d rc %d id 0x%llx\n",\r\n__func__, __LINE__, rc, msg.id);\r\nswitch (msg.id) {\r\ncase COSM_MSG_SYNC_TIME:\r\ncosm_set_time(&msg);\r\nbreak;\r\ncase COSM_MSG_SHUTDOWN:\r\norderly_poweroff(true);\r\nbreak;\r\ndefault:\r\ndev_err(&client_spdev->dev, "%s: %d unknown id %lld\n",\r\n__func__, __LINE__, msg.id);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic int cosm_scif_connect(void)\r\n{\r\nstruct scif_port_id port_id;\r\nint i, rc;\r\nclient_epd = scif_open();\r\nif (!client_epd) {\r\ndev_err(&client_spdev->dev, "%s %d scif_open failed\n",\r\n__func__, __LINE__);\r\nreturn -ENOMEM;\r\n}\r\nport_id.node = 0;\r\nport_id.port = SCIF_COSM_LISTEN_PORT;\r\nfor (i = 0; i < COSM_SCIF_MAX_RETRIES; i++) {\r\nrc = scif_connect(client_epd, &port_id);\r\nif (rc < 0)\r\nmsleep(1000);\r\nelse\r\nbreak;\r\n}\r\nif (rc < 0) {\r\ndev_err(&client_spdev->dev, "%s %d scif_connect rc %d\n",\r\n__func__, __LINE__, rc);\r\nscif_close(client_epd);\r\nclient_epd = NULL;\r\n}\r\nreturn rc < 0 ? rc : 0;\r\n}\r\nstatic void cosm_scif_connect_exit(void)\r\n{\r\nif (client_epd) {\r\nscif_close(client_epd);\r\nclient_epd = NULL;\r\n}\r\n}\r\nstatic int cosm_scif_client(void *unused)\r\n{\r\nstruct cosm_msg msg = { .id = COSM_MSG_HEARTBEAT };\r\nstruct scif_pollepd pollepd;\r\nint rc;\r\nallow_signal(SIGKILL);\r\nwhile (!kthread_should_stop()) {\r\npollepd.epd = client_epd;\r\npollepd.events = POLLIN;\r\nrc = scif_poll(&pollepd, 1, COSM_HEARTBEAT_SEND_MSEC);\r\nif (rc < 0) {\r\nif (-EINTR != rc)\r\ndev_err(&client_spdev->dev,\r\n"%s %d scif_poll rc %d\n",\r\n__func__, __LINE__, rc);\r\ncontinue;\r\n}\r\nif (pollepd.revents & POLLIN)\r\ncosm_client_recv();\r\nmsg.id = COSM_MSG_HEARTBEAT;\r\nrc = scif_send(client_epd, &msg, sizeof(msg), SCIF_SEND_BLOCK);\r\nif (rc < 0)\r\ndev_err(&client_spdev->dev, "%s %d scif_send rc %d\n",\r\n__func__, __LINE__, rc);\r\n}\r\ndev_dbg(&client_spdev->dev, "%s %d Client thread stopped\n",\r\n__func__, __LINE__);\r\nreturn 0;\r\n}\r\nstatic void cosm_scif_probe(struct scif_peer_dev *spdev)\r\n{\r\nint rc;\r\ndev_dbg(&spdev->dev, "%s %d: dnode %d\n",\r\n__func__, __LINE__, spdev->dnode);\r\nif (spdev->dnode)\r\nreturn;\r\nclient_spdev = spdev;\r\nrc = cosm_scif_connect();\r\nif (rc)\r\ngoto exit;\r\nrc = register_reboot_notifier(&cosm_reboot);\r\nif (rc) {\r\ndev_err(&spdev->dev,\r\n"reboot notifier registration failed rc %d\n", rc);\r\ngoto connect_exit;\r\n}\r\nclient_thread = kthread_run(cosm_scif_client, NULL, "cosm_client");\r\nif (IS_ERR(client_thread)) {\r\nrc = PTR_ERR(client_thread);\r\ndev_err(&spdev->dev, "%s %d kthread_run rc %d\n",\r\n__func__, __LINE__, rc);\r\ngoto unreg_reboot;\r\n}\r\nreturn;\r\nunreg_reboot:\r\nunregister_reboot_notifier(&cosm_reboot);\r\nconnect_exit:\r\ncosm_scif_connect_exit();\r\nexit:\r\nclient_spdev = NULL;\r\n}\r\nstatic void cosm_scif_remove(struct scif_peer_dev *spdev)\r\n{\r\nint rc;\r\ndev_dbg(&spdev->dev, "%s %d: dnode %d\n",\r\n__func__, __LINE__, spdev->dnode);\r\nif (spdev->dnode)\r\nreturn;\r\nif (!IS_ERR_OR_NULL(client_thread)) {\r\nrc = send_sig(SIGKILL, client_thread, 0);\r\nif (rc) {\r\npr_err("%s %d send_sig rc %d\n",\r\n__func__, __LINE__, rc);\r\nreturn;\r\n}\r\nkthread_stop(client_thread);\r\n}\r\nunregister_reboot_notifier(&cosm_reboot);\r\ncosm_scif_connect_exit();\r\nclient_spdev = NULL;\r\n}\r\nstatic int __init cosm_client_init(void)\r\n{\r\nint rc = scif_client_register(&scif_client_cosm);\r\nif (rc)\r\npr_err("scif_client_register failed rc %d\n", rc);\r\nreturn rc;\r\n}\r\nstatic void __exit cosm_client_exit(void)\r\n{\r\nscif_client_unregister(&scif_client_cosm);\r\n}

static void xilinx_intc_mask(struct irq_data *d)\r\n{\r\nint irq = irqd_to_hwirq(d);\r\nvoid * regs = irq_data_get_irq_chip_data(d);\r\npr_debug("mask: %d\n", irq);\r\nout_be32(regs + XINTC_CIE, 1 << irq);\r\n}\r\nstatic int xilinx_intc_set_type(struct irq_data *d, unsigned int flow_type)\r\n{\r\nreturn 0;\r\n}\r\nstatic void xilinx_intc_level_unmask(struct irq_data *d)\r\n{\r\nint irq = irqd_to_hwirq(d);\r\nvoid * regs = irq_data_get_irq_chip_data(d);\r\npr_debug("unmask: %d\n", irq);\r\nout_be32(regs + XINTC_SIE, 1 << irq);\r\nout_be32(regs + XINTC_IAR, 1 << irq);\r\n}\r\nstatic void xilinx_intc_edge_unmask(struct irq_data *d)\r\n{\r\nint irq = irqd_to_hwirq(d);\r\nvoid *regs = irq_data_get_irq_chip_data(d);\r\npr_debug("unmask: %d\n", irq);\r\nout_be32(regs + XINTC_SIE, 1 << irq);\r\n}\r\nstatic void xilinx_intc_edge_ack(struct irq_data *d)\r\n{\r\nint irq = irqd_to_hwirq(d);\r\nvoid * regs = irq_data_get_irq_chip_data(d);\r\npr_debug("ack: %d\n", irq);\r\nout_be32(regs + XINTC_IAR, 1 << irq);\r\n}\r\nstatic int xilinx_intc_xlate(struct irq_domain *h, struct device_node *ct,\r\nconst u32 *intspec, unsigned int intsize,\r\nirq_hw_number_t *out_hwirq,\r\nunsigned int *out_flags)\r\n{\r\nif ((intsize < 2) || (intspec[0] >= XILINX_INTC_MAXIRQS))\r\nreturn -EINVAL;\r\nxilinx_intc_typetable[intspec[0]] = xilinx_intc_map_senses[intspec[1]];\r\n*out_hwirq = intspec[0];\r\n*out_flags = xilinx_intc_map_senses[intspec[1]];\r\nreturn 0;\r\n}\r\nstatic int xilinx_intc_map(struct irq_domain *h, unsigned int virq,\r\nirq_hw_number_t irq)\r\n{\r\nirq_set_chip_data(virq, h->host_data);\r\nif (xilinx_intc_typetable[irq] == IRQ_TYPE_LEVEL_HIGH ||\r\nxilinx_intc_typetable[irq] == IRQ_TYPE_LEVEL_LOW) {\r\nirq_set_chip_and_handler(virq, &xilinx_intc_level_irqchip,\r\nhandle_level_irq);\r\n} else {\r\nirq_set_chip_and_handler(virq, &xilinx_intc_edge_irqchip,\r\nhandle_edge_irq);\r\n}\r\nreturn 0;\r\n}\r\nstruct irq_domain * __init\r\nxilinx_intc_init(struct device_node *np)\r\n{\r\nstruct irq_domain * irq;\r\nvoid * regs;\r\nregs = of_iomap(np, 0);\r\nif (!regs) {\r\npr_err("xilinx_intc: could not map registers\n");\r\nreturn NULL;\r\n}\r\nout_be32(regs + XINTC_IER, 0);\r\nout_be32(regs + XINTC_IAR, ~(u32) 0);\r\nout_be32(regs + XINTC_MER, 0x3UL);\r\nirq = irq_domain_add_linear(np, XILINX_INTC_MAXIRQS, &xilinx_intc_ops,\r\nregs);\r\nif (!irq)\r\npanic(__FILE__ ": Cannot allocate IRQ host\n");\r\nreturn irq;\r\n}\r\nint xilinx_intc_get_irq(void)\r\n{\r\nvoid * regs = master_irqhost->host_data;\r\npr_debug("get_irq:\n");\r\nreturn irq_linear_revmap(master_irqhost, in_be32(regs + XINTC_IVR));\r\n}\r\nstatic void xilinx_i8259_cascade(struct irq_desc *desc)\r\n{\r\nstruct irq_chip *chip = irq_desc_get_chip(desc);\r\nunsigned int cascade_irq = i8259_irq();\r\nif (cascade_irq)\r\ngeneric_handle_irq(cascade_irq);\r\nchip->irq_unmask(&desc->irq_data);\r\n}\r\nstatic void __init xilinx_i8259_setup_cascade(void)\r\n{\r\nstruct device_node *cascade_node;\r\nint cascade_irq;\r\ncascade_node = of_find_compatible_node(NULL, NULL, "chrp,iic");\r\nif (!cascade_node)\r\nreturn;\r\ncascade_irq = irq_of_parse_and_map(cascade_node, 0);\r\nif (!cascade_irq) {\r\npr_err("virtex_ml510: Failed to map cascade interrupt\n");\r\ngoto out;\r\n}\r\ni8259_init(cascade_node, 0);\r\nirq_set_chained_handler(cascade_irq, xilinx_i8259_cascade);\r\noutb(0xc0, 0x4d0);\r\noutb(0xc0, 0x4d1);\r\nout:\r\nof_node_put(cascade_node);\r\n}\r\nstatic inline void xilinx_i8259_setup_cascade(void) { return; }\r\nvoid __init xilinx_intc_init_tree(void)\r\n{\r\nstruct device_node *np;\r\nfor_each_matching_node(np, xilinx_intc_match) {\r\nif (!of_get_property(np, "interrupts", NULL))\r\nbreak;\r\n}\r\nBUG_ON(!np);\r\nmaster_irqhost = xilinx_intc_init(np);\r\nBUG_ON(!master_irqhost);\r\nirq_set_default_host(master_irqhost);\r\nof_node_put(np);\r\nxilinx_i8259_setup_cascade();\r\n}

static inline u32 rotl32(u32 v, u8 n)\r\n{\r\nreturn (v << n) | (v >> (sizeof(v) * 8 - n));\r\n}\r\nextern void chacha20_block(u32 *state, void *stream)\r\n{\r\nu32 x[16], *out = stream;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(x); i++)\r\nx[i] = state[i];\r\nfor (i = 0; i < 20; i += 2) {\r\nx[0] += x[4]; x[12] = rotl32(x[12] ^ x[0], 16);\r\nx[1] += x[5]; x[13] = rotl32(x[13] ^ x[1], 16);\r\nx[2] += x[6]; x[14] = rotl32(x[14] ^ x[2], 16);\r\nx[3] += x[7]; x[15] = rotl32(x[15] ^ x[3], 16);\r\nx[8] += x[12]; x[4] = rotl32(x[4] ^ x[8], 12);\r\nx[9] += x[13]; x[5] = rotl32(x[5] ^ x[9], 12);\r\nx[10] += x[14]; x[6] = rotl32(x[6] ^ x[10], 12);\r\nx[11] += x[15]; x[7] = rotl32(x[7] ^ x[11], 12);\r\nx[0] += x[4]; x[12] = rotl32(x[12] ^ x[0], 8);\r\nx[1] += x[5]; x[13] = rotl32(x[13] ^ x[1], 8);\r\nx[2] += x[6]; x[14] = rotl32(x[14] ^ x[2], 8);\r\nx[3] += x[7]; x[15] = rotl32(x[15] ^ x[3], 8);\r\nx[8] += x[12]; x[4] = rotl32(x[4] ^ x[8], 7);\r\nx[9] += x[13]; x[5] = rotl32(x[5] ^ x[9], 7);\r\nx[10] += x[14]; x[6] = rotl32(x[6] ^ x[10], 7);\r\nx[11] += x[15]; x[7] = rotl32(x[7] ^ x[11], 7);\r\nx[0] += x[5]; x[15] = rotl32(x[15] ^ x[0], 16);\r\nx[1] += x[6]; x[12] = rotl32(x[12] ^ x[1], 16);\r\nx[2] += x[7]; x[13] = rotl32(x[13] ^ x[2], 16);\r\nx[3] += x[4]; x[14] = rotl32(x[14] ^ x[3], 16);\r\nx[10] += x[15]; x[5] = rotl32(x[5] ^ x[10], 12);\r\nx[11] += x[12]; x[6] = rotl32(x[6] ^ x[11], 12);\r\nx[8] += x[13]; x[7] = rotl32(x[7] ^ x[8], 12);\r\nx[9] += x[14]; x[4] = rotl32(x[4] ^ x[9], 12);\r\nx[0] += x[5]; x[15] = rotl32(x[15] ^ x[0], 8);\r\nx[1] += x[6]; x[12] = rotl32(x[12] ^ x[1], 8);\r\nx[2] += x[7]; x[13] = rotl32(x[13] ^ x[2], 8);\r\nx[3] += x[4]; x[14] = rotl32(x[14] ^ x[3], 8);\r\nx[10] += x[15]; x[5] = rotl32(x[5] ^ x[10], 7);\r\nx[11] += x[12]; x[6] = rotl32(x[6] ^ x[11], 7);\r\nx[8] += x[13]; x[7] = rotl32(x[7] ^ x[8], 7);\r\nx[9] += x[14]; x[4] = rotl32(x[4] ^ x[9], 7);\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(x); i++)\r\nout[i] = cpu_to_le32(x[i] + state[i]);\r\nstate[12]++;\r\n}

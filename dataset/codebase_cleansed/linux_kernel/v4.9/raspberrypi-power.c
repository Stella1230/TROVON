static int rpi_firmware_set_power(struct rpi_power_domain *rpi_domain, bool on)\r\n{\r\nstruct rpi_power_domain_packet packet;\r\npacket.domain = rpi_domain->domain;\r\npacket.on = on;\r\nreturn rpi_firmware_property(rpi_domain->fw,\r\nrpi_domain->old_interface ?\r\nRPI_FIRMWARE_SET_POWER_STATE :\r\nRPI_FIRMWARE_SET_DOMAIN_STATE,\r\n&packet, sizeof(packet));\r\n}\r\nstatic int rpi_domain_off(struct generic_pm_domain *domain)\r\n{\r\nstruct rpi_power_domain *rpi_domain =\r\ncontainer_of(domain, struct rpi_power_domain, base);\r\nreturn rpi_firmware_set_power(rpi_domain, false);\r\n}\r\nstatic int rpi_domain_on(struct generic_pm_domain *domain)\r\n{\r\nstruct rpi_power_domain *rpi_domain =\r\ncontainer_of(domain, struct rpi_power_domain, base);\r\nreturn rpi_firmware_set_power(rpi_domain, true);\r\n}\r\nstatic void rpi_common_init_power_domain(struct rpi_power_domains *rpi_domains,\r\nint xlate_index, const char *name)\r\n{\r\nstruct rpi_power_domain *dom = &rpi_domains->domains[xlate_index];\r\ndom->fw = rpi_domains->fw;\r\ndom->base.name = name;\r\ndom->base.power_on = rpi_domain_on;\r\ndom->base.power_off = rpi_domain_off;\r\npm_genpd_init(&dom->base, NULL, true);\r\nrpi_domains->xlate.domains[xlate_index] = &dom->base;\r\n}\r\nstatic void rpi_init_power_domain(struct rpi_power_domains *rpi_domains,\r\nint xlate_index, const char *name)\r\n{\r\nstruct rpi_power_domain *dom = &rpi_domains->domains[xlate_index];\r\nif (!rpi_domains->has_new_interface)\r\nreturn;\r\ndom->domain = xlate_index + 1;\r\nrpi_common_init_power_domain(rpi_domains, xlate_index, name);\r\n}\r\nstatic void rpi_init_old_power_domain(struct rpi_power_domains *rpi_domains,\r\nint xlate_index, int domain,\r\nconst char *name)\r\n{\r\nstruct rpi_power_domain *dom = &rpi_domains->domains[xlate_index];\r\ndom->old_interface = true;\r\ndom->domain = domain;\r\nrpi_common_init_power_domain(rpi_domains, xlate_index, name);\r\n}\r\nstatic bool\r\nrpi_has_new_domain_support(struct rpi_power_domains *rpi_domains)\r\n{\r\nstruct rpi_power_domain_packet packet;\r\nint ret;\r\npacket.domain = RPI_POWER_DOMAIN_ARM;\r\npacket.on = ~0;\r\nret = rpi_firmware_property(rpi_domains->fw,\r\nRPI_FIRMWARE_GET_DOMAIN_STATE,\r\n&packet, sizeof(packet));\r\nreturn ret == 0 && packet.on != ~0;\r\n}\r\nstatic int rpi_power_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *fw_np;\r\nstruct device *dev = &pdev->dev;\r\nstruct rpi_power_domains *rpi_domains;\r\nrpi_domains = devm_kzalloc(dev, sizeof(*rpi_domains), GFP_KERNEL);\r\nif (!rpi_domains)\r\nreturn -ENOMEM;\r\nrpi_domains->xlate.domains =\r\ndevm_kzalloc(dev, sizeof(*rpi_domains->xlate.domains) *\r\nRPI_POWER_DOMAIN_COUNT, GFP_KERNEL);\r\nif (!rpi_domains->xlate.domains)\r\nreturn -ENOMEM;\r\nrpi_domains->xlate.num_domains = RPI_POWER_DOMAIN_COUNT;\r\nfw_np = of_parse_phandle(pdev->dev.of_node, "firmware", 0);\r\nif (!fw_np) {\r\ndev_err(&pdev->dev, "no firmware node\n");\r\nreturn -ENODEV;\r\n}\r\nrpi_domains->fw = rpi_firmware_get(fw_np);\r\nof_node_put(fw_np);\r\nif (!rpi_domains->fw)\r\nreturn -EPROBE_DEFER;\r\nrpi_domains->has_new_interface =\r\nrpi_has_new_domain_support(rpi_domains);\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_I2C0, "I2C0");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_I2C1, "I2C1");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_I2C2, "I2C2");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_VIDEO_SCALER,\r\n"VIDEO_SCALER");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_VPU1, "VPU1");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_HDMI, "HDMI");\r\nrpi_init_old_power_domain(rpi_domains, RPI_POWER_DOMAIN_USB,\r\nRPI_OLD_POWER_DOMAIN_USB, "USB");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_VEC, "VEC");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_JPEG, "JPEG");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_H264, "H264");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_V3D, "V3D");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_ISP, "ISP");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_UNICAM0, "UNICAM0");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_UNICAM1, "UNICAM1");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_CCP2RX, "CCP2RX");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_CSI2, "CSI2");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_CPI, "CPI");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_DSI0, "DSI0");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_DSI1, "DSI1");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_TRANSPOSER,\r\n"TRANSPOSER");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_CCP2TX, "CCP2TX");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_CDP, "CDP");\r\nrpi_init_power_domain(rpi_domains, RPI_POWER_DOMAIN_ARM, "ARM");\r\nof_genpd_add_provider_onecell(dev->of_node, &rpi_domains->xlate);\r\nplatform_set_drvdata(pdev, rpi_domains);\r\nreturn 0;\r\n}

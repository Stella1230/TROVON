void\r\nnvkm_subdev_intr(struct nvkm_subdev *subdev)\r\n{\r\nif (subdev->func->intr)\r\nsubdev->func->intr(subdev);\r\n}\r\nint\r\nnvkm_subdev_fini(struct nvkm_subdev *subdev, bool suspend)\r\n{\r\nstruct nvkm_device *device = subdev->device;\r\nconst char *action = suspend ? "suspend" : "fini";\r\ns64 time;\r\nnvkm_trace(subdev, "%s running...\n", action);\r\ntime = ktime_to_us(ktime_get());\r\nif (subdev->func->fini) {\r\nint ret = subdev->func->fini(subdev, suspend);\r\nif (ret) {\r\nnvkm_error(subdev, "%s failed, %d\n", action, ret);\r\nif (suspend)\r\nreturn ret;\r\n}\r\n}\r\nnvkm_mc_reset(device, subdev->index);\r\ntime = ktime_to_us(ktime_get()) - time;\r\nnvkm_trace(subdev, "%s completed in %lldus\n", action, time);\r\nreturn 0;\r\n}\r\nint\r\nnvkm_subdev_preinit(struct nvkm_subdev *subdev)\r\n{\r\ns64 time;\r\nnvkm_trace(subdev, "preinit running...\n");\r\ntime = ktime_to_us(ktime_get());\r\nif (subdev->func->preinit) {\r\nint ret = subdev->func->preinit(subdev);\r\nif (ret) {\r\nnvkm_error(subdev, "preinit failed, %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\ntime = ktime_to_us(ktime_get()) - time;\r\nnvkm_trace(subdev, "preinit completed in %lldus\n", time);\r\nreturn 0;\r\n}\r\nint\r\nnvkm_subdev_init(struct nvkm_subdev *subdev)\r\n{\r\ns64 time;\r\nint ret;\r\nnvkm_trace(subdev, "init running...\n");\r\ntime = ktime_to_us(ktime_get());\r\nif (subdev->func->oneinit && !subdev->oneinit) {\r\ns64 time;\r\nnvkm_trace(subdev, "one-time init running...\n");\r\ntime = ktime_to_us(ktime_get());\r\nret = subdev->func->oneinit(subdev);\r\nif (ret) {\r\nnvkm_error(subdev, "one-time init failed, %d\n", ret);\r\nreturn ret;\r\n}\r\nsubdev->oneinit = true;\r\ntime = ktime_to_us(ktime_get()) - time;\r\nnvkm_trace(subdev, "one-time init completed in %lldus\n", time);\r\n}\r\nif (subdev->func->init) {\r\nret = subdev->func->init(subdev);\r\nif (ret) {\r\nnvkm_error(subdev, "init failed, %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\ntime = ktime_to_us(ktime_get()) - time;\r\nnvkm_trace(subdev, "init completed in %lldus\n", time);\r\nreturn 0;\r\n}\r\nvoid\r\nnvkm_subdev_del(struct nvkm_subdev **psubdev)\r\n{\r\nstruct nvkm_subdev *subdev = *psubdev;\r\ns64 time;\r\nif (subdev && !WARN_ON(!subdev->func)) {\r\nnvkm_trace(subdev, "destroy running...\n");\r\ntime = ktime_to_us(ktime_get());\r\nif (subdev->func->dtor)\r\n*psubdev = subdev->func->dtor(subdev);\r\ntime = ktime_to_us(ktime_get()) - time;\r\nnvkm_trace(subdev, "destroy completed in %lldus\n", time);\r\nkfree(*psubdev);\r\n*psubdev = NULL;\r\n}\r\n}\r\nvoid\r\nnvkm_subdev_ctor(const struct nvkm_subdev_func *func,\r\nstruct nvkm_device *device, int index,\r\nstruct nvkm_subdev *subdev)\r\n{\r\nconst char *name = nvkm_subdev_name[index];\r\nsubdev->func = func;\r\nsubdev->device = device;\r\nsubdev->index = index;\r\n__mutex_init(&subdev->mutex, name, &nvkm_subdev_lock_class[index]);\r\nsubdev->debug = nvkm_dbgopt(device->dbgopt, name);\r\n}

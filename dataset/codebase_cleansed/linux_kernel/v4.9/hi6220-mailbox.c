static void mbox_set_state(struct hi6220_mbox *mbox,\r\nunsigned int slot, u32 val)\r\n{\r\nu32 status;\r\nstatus = readl(mbox->base + MBOX_MODE_REG(slot));\r\nstatus = (status & ~MBOX_STATE_MASK) | val;\r\nwritel(status, mbox->base + MBOX_MODE_REG(slot));\r\n}\r\nstatic void mbox_set_mode(struct hi6220_mbox *mbox,\r\nunsigned int slot, u32 val)\r\n{\r\nu32 mode;\r\nmode = readl(mbox->base + MBOX_MODE_REG(slot));\r\nmode = (mode & ~MBOX_ACK_CONFIG_MASK) | val;\r\nwritel(mode, mbox->base + MBOX_MODE_REG(slot));\r\n}\r\nstatic bool hi6220_mbox_last_tx_done(struct mbox_chan *chan)\r\n{\r\nstruct hi6220_mbox_chan *mchan = chan->con_priv;\r\nstruct hi6220_mbox *mbox = mchan->parent;\r\nu32 state;\r\nBUG_ON(mbox->tx_irq_mode);\r\nstate = readl(mbox->base + MBOX_MODE_REG(mchan->slot));\r\nreturn ((state & MBOX_STATE_MASK) == MBOX_STATE_IDLE);\r\n}\r\nstatic int hi6220_mbox_send_data(struct mbox_chan *chan, void *msg)\r\n{\r\nstruct hi6220_mbox_chan *mchan = chan->con_priv;\r\nstruct hi6220_mbox *mbox = mchan->parent;\r\nunsigned int slot = mchan->slot;\r\nu32 *buf = msg;\r\nint i;\r\nmchan->dir = MBOX_TX;\r\nmbox_set_state(mbox, slot, MBOX_STATE_TX);\r\nif (mbox->tx_irq_mode)\r\nmbox_set_mode(mbox, slot, MBOX_ACK_IRQ);\r\nelse\r\nmbox_set_mode(mbox, slot, MBOX_ACK_AUTOMATIC);\r\nfor (i = 0; i < MBOX_MSG_LEN; i++)\r\nwritel(buf[i], mbox->base + MBOX_DATA_REG(slot) + i * 4);\r\nwritel(BIT(mchan->dst_irq), DST_INT_RAW_REG(mbox->ipc));\r\nreturn 0;\r\n}\r\nstatic irqreturn_t hi6220_mbox_interrupt(int irq, void *p)\r\n{\r\nstruct hi6220_mbox *mbox = p;\r\nstruct hi6220_mbox_chan *mchan;\r\nstruct mbox_chan *chan;\r\nunsigned int state, intr_bit, i;\r\nu32 msg[MBOX_MSG_LEN];\r\nstate = readl(ACK_INT_STAT_REG(mbox->ipc));\r\nif (!state) {\r\ndev_warn(mbox->dev, "%s: spurious interrupt\n",\r\n__func__);\r\nreturn IRQ_HANDLED;\r\n}\r\nwhile (state) {\r\nintr_bit = __ffs(state);\r\nstate &= (state - 1);\r\nchan = mbox->irq_map_chan[intr_bit];\r\nif (!chan) {\r\ndev_warn(mbox->dev, "%s: unexpected irq vector %d\n",\r\n__func__, intr_bit);\r\ncontinue;\r\n}\r\nmchan = chan->con_priv;\r\nif (mchan->dir == MBOX_TX)\r\nmbox_chan_txdone(chan, 0);\r\nelse {\r\nfor (i = 0; i < MBOX_MSG_LEN; i++)\r\nmsg[i] = readl(mbox->base +\r\nMBOX_DATA_REG(mchan->slot) + i * 4);\r\nmbox_chan_received_data(chan, (void *)msg);\r\n}\r\nwritel(BIT(mchan->ack_irq), ACK_INT_CLR_REG(mbox->ipc));\r\nmbox_set_state(mbox, mchan->slot, MBOX_STATE_IDLE);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int hi6220_mbox_startup(struct mbox_chan *chan)\r\n{\r\nstruct hi6220_mbox_chan *mchan = chan->con_priv;\r\nstruct hi6220_mbox *mbox = mchan->parent;\r\nmchan->dir = 0;\r\nwritel(BIT(mchan->ack_irq), ACK_INT_ENA_REG(mbox->ipc));\r\nreturn 0;\r\n}\r\nstatic void hi6220_mbox_shutdown(struct mbox_chan *chan)\r\n{\r\nstruct hi6220_mbox_chan *mchan = chan->con_priv;\r\nstruct hi6220_mbox *mbox = mchan->parent;\r\nwritel(BIT(mchan->ack_irq), ACK_INT_DIS_REG(mbox->ipc));\r\nmbox->irq_map_chan[mchan->ack_irq] = NULL;\r\n}\r\nstatic struct mbox_chan *hi6220_mbox_xlate(struct mbox_controller *controller,\r\nconst struct of_phandle_args *spec)\r\n{\r\nstruct hi6220_mbox *mbox = dev_get_drvdata(controller->dev);\r\nstruct hi6220_mbox_chan *mchan;\r\nstruct mbox_chan *chan;\r\nunsigned int i = spec->args[0];\r\nunsigned int dst_irq = spec->args[1];\r\nunsigned int ack_irq = spec->args[2];\r\nif (i >= mbox->chan_num || dst_irq >= mbox->chan_num ||\r\nack_irq >= mbox->chan_num) {\r\ndev_err(mbox->dev,\r\n"Invalid channel idx %d dst_irq %d ack_irq %d\n",\r\ni, dst_irq, ack_irq);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nchan = &mbox->chan[i];\r\nif (mbox->irq_map_chan[ack_irq] == (void *)chan) {\r\ndev_err(mbox->dev, "Channel in use\n");\r\nreturn ERR_PTR(-EBUSY);\r\n}\r\nmchan = chan->con_priv;\r\nmchan->dst_irq = dst_irq;\r\nmchan->ack_irq = ack_irq;\r\nmbox->irq_map_chan[ack_irq] = (void *)chan;\r\nreturn chan;\r\n}\r\nstatic int hi6220_mbox_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct device *dev = &pdev->dev;\r\nstruct hi6220_mbox *mbox;\r\nstruct resource *res;\r\nint i, err;\r\nmbox = devm_kzalloc(dev, sizeof(*mbox), GFP_KERNEL);\r\nif (!mbox)\r\nreturn -ENOMEM;\r\nmbox->dev = dev;\r\nmbox->chan_num = MBOX_CHAN_MAX;\r\nmbox->mchan = devm_kzalloc(dev,\r\nmbox->chan_num * sizeof(*mbox->mchan), GFP_KERNEL);\r\nif (!mbox->mchan)\r\nreturn -ENOMEM;\r\nmbox->chan = devm_kzalloc(dev,\r\nmbox->chan_num * sizeof(*mbox->chan), GFP_KERNEL);\r\nif (!mbox->chan)\r\nreturn -ENOMEM;\r\nmbox->irq = platform_get_irq(pdev, 0);\r\nif (mbox->irq < 0)\r\nreturn mbox->irq;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nmbox->ipc = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(mbox->ipc)) {\r\ndev_err(dev, "ioremap ipc failed\n");\r\nreturn PTR_ERR(mbox->ipc);\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nmbox->base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(mbox->base)) {\r\ndev_err(dev, "ioremap buffer failed\n");\r\nreturn PTR_ERR(mbox->base);\r\n}\r\nerr = devm_request_irq(dev, mbox->irq, hi6220_mbox_interrupt, 0,\r\ndev_name(dev), mbox);\r\nif (err) {\r\ndev_err(dev, "Failed to register a mailbox IRQ handler: %d\n",\r\nerr);\r\nreturn -ENODEV;\r\n}\r\nmbox->controller.dev = dev;\r\nmbox->controller.chans = &mbox->chan[0];\r\nmbox->controller.num_chans = mbox->chan_num;\r\nmbox->controller.ops = &hi6220_mbox_ops;\r\nmbox->controller.of_xlate = hi6220_mbox_xlate;\r\nfor (i = 0; i < mbox->chan_num; i++) {\r\nmbox->chan[i].con_priv = &mbox->mchan[i];\r\nmbox->irq_map_chan[i] = NULL;\r\nmbox->mchan[i].parent = mbox;\r\nmbox->mchan[i].slot = i;\r\n}\r\nwritel(0x0, ACK_INT_MSK_REG(mbox->ipc));\r\nwritel(~0x0, ACK_INT_CLR_REG(mbox->ipc));\r\nif (of_find_property(node, "hi6220,mbox-tx-noirq", NULL))\r\nmbox->tx_irq_mode = false;\r\nelse\r\nmbox->tx_irq_mode = true;\r\nif (mbox->tx_irq_mode)\r\nmbox->controller.txdone_irq = true;\r\nelse {\r\nmbox->controller.txdone_poll = true;\r\nmbox->controller.txpoll_period = 5;\r\n}\r\nerr = mbox_controller_register(&mbox->controller);\r\nif (err) {\r\ndev_err(dev, "Failed to register mailbox %d\n", err);\r\nreturn err;\r\n}\r\nplatform_set_drvdata(pdev, mbox);\r\ndev_info(dev, "Mailbox enabled\n");\r\nreturn 0;\r\n}\r\nstatic int hi6220_mbox_remove(struct platform_device *pdev)\r\n{\r\nstruct hi6220_mbox *mbox = platform_get_drvdata(pdev);\r\nmbox_controller_unregister(&mbox->controller);\r\nreturn 0;\r\n}\r\nstatic int __init hi6220_mbox_init(void)\r\n{\r\nreturn platform_driver_register(&hi6220_mbox_driver);\r\n}\r\nstatic void __exit hi6220_mbox_exit(void)\r\n{\r\nplatform_driver_unregister(&hi6220_mbox_driver);\r\n}

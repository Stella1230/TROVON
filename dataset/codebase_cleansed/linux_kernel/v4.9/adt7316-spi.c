static int adt7316_spi_multi_read(void *client, u8 reg, u8 count, u8 *data)\r\n{\r\nstruct spi_device *spi_dev = client;\r\nu8 cmd[2];\r\nint ret = 0;\r\nif (count > ADT7316_REG_MAX_ADDR)\r\ncount = ADT7316_REG_MAX_ADDR;\r\ncmd[0] = ADT7316_SPI_CMD_WRITE;\r\ncmd[1] = reg;\r\nret = spi_write(spi_dev, cmd, 2);\r\nif (ret < 0) {\r\ndev_err(&spi_dev->dev, "SPI fail to select reg\n");\r\nreturn ret;\r\n}\r\ncmd[0] = ADT7316_SPI_CMD_READ;\r\nret = spi_write_then_read(spi_dev, cmd, 1, data, count);\r\nif (ret < 0) {\r\ndev_err(&spi_dev->dev, "SPI read data error\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int adt7316_spi_multi_write(void *client, u8 reg, u8 count, u8 *data)\r\n{\r\nstruct spi_device *spi_dev = client;\r\nu8 buf[ADT7316_REG_MAX_ADDR + 2];\r\nint i, ret = 0;\r\nif (count > ADT7316_REG_MAX_ADDR)\r\ncount = ADT7316_REG_MAX_ADDR;\r\nbuf[0] = ADT7316_SPI_CMD_WRITE;\r\nbuf[1] = reg;\r\nfor (i = 0; i < count; i++)\r\nbuf[i + 2] = data[i];\r\nret = spi_write(spi_dev, buf, count + 2);\r\nif (ret < 0) {\r\ndev_err(&spi_dev->dev, "SPI write error\n");\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic int adt7316_spi_read(void *client, u8 reg, u8 *data)\r\n{\r\nreturn adt7316_spi_multi_read(client, reg, 1, data);\r\n}\r\nstatic int adt7316_spi_write(void *client, u8 reg, u8 val)\r\n{\r\nreturn adt7316_spi_multi_write(client, reg, 1, &val);\r\n}\r\nstatic int adt7316_spi_probe(struct spi_device *spi_dev)\r\n{\r\nstruct adt7316_bus bus = {\r\n.client = spi_dev,\r\n.irq = spi_dev->irq,\r\n.irq_flags = IRQF_TRIGGER_LOW,\r\n.read = adt7316_spi_read,\r\n.write = adt7316_spi_write,\r\n.multi_read = adt7316_spi_multi_read,\r\n.multi_write = adt7316_spi_multi_write,\r\n};\r\nif (spi_dev->max_speed_hz > ADT7316_SPI_MAX_FREQ_HZ) {\r\ndev_err(&spi_dev->dev, "SPI CLK %d Hz?\n",\r\nspi_dev->max_speed_hz);\r\nreturn -EINVAL;\r\n}\r\nadt7316_spi_write(spi_dev, 0, 0);\r\nadt7316_spi_write(spi_dev, 0, 0);\r\nadt7316_spi_write(spi_dev, 0, 0);\r\nreturn adt7316_probe(&spi_dev->dev, &bus, spi_dev->modalias);\r\n}

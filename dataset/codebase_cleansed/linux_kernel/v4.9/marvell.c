static int marvell_ack_interrupt(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_read(phydev, MII_M1011_IEVENT);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int marvell_config_intr(struct phy_device *phydev)\r\n{\r\nint err;\r\nif (phydev->interrupts == PHY_INTERRUPT_ENABLED)\r\nerr = phy_write(phydev, MII_M1011_IMASK, MII_M1011_IMASK_INIT);\r\nelse\r\nerr = phy_write(phydev, MII_M1011_IMASK, MII_M1011_IMASK_CLEAR);\r\nreturn err;\r\n}\r\nstatic int marvell_set_polarity(struct phy_device *phydev, int polarity)\r\n{\r\nint reg;\r\nint err;\r\nint val;\r\nreg = phy_read(phydev, MII_M1011_PHY_SCR);\r\nif (reg < 0)\r\nreturn reg;\r\nval = reg;\r\nval &= ~MII_M1011_PHY_SCR_AUTO_CROSS;\r\nswitch (polarity) {\r\ncase ETH_TP_MDI:\r\nval |= MII_M1011_PHY_SCR_MDI;\r\nbreak;\r\ncase ETH_TP_MDI_X:\r\nval |= MII_M1011_PHY_SCR_MDI_X;\r\nbreak;\r\ncase ETH_TP_MDI_AUTO:\r\ncase ETH_TP_MDI_INVALID:\r\ndefault:\r\nval |= MII_M1011_PHY_SCR_AUTO_CROSS;\r\nbreak;\r\n}\r\nif (val != reg) {\r\nerr = phy_write(phydev, MII_M1011_PHY_SCR, val);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int marvell_config_aneg(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_write(phydev, MII_BMCR, BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1d, 0x1f);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1e, 0x200c);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1d, 0x5);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1e, 0);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1e, 0x100);\r\nif (err < 0)\r\nreturn err;\r\nerr = marvell_set_polarity(phydev, phydev->mdix);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_M1111_PHY_LED_CONTROL,\r\nMII_M1111_PHY_LED_DIRECT);\r\nif (err < 0)\r\nreturn err;\r\nerr = genphy_config_aneg(phydev);\r\nif (err < 0)\r\nreturn err;\r\nif (phydev->autoneg != AUTONEG_ENABLE) {\r\nint bmcr;\r\nbmcr = phy_read(phydev, MII_BMCR);\r\nif (bmcr < 0)\r\nreturn bmcr;\r\nerr = phy_write(phydev, MII_BMCR, bmcr | BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int m88e1111_config_aneg(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_write(phydev, MII_BMCR, BMCR_RESET);\r\nerr = marvell_set_polarity(phydev, phydev->mdix);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_M1111_PHY_LED_CONTROL,\r\nMII_M1111_PHY_LED_DIRECT);\r\nif (err < 0)\r\nreturn err;\r\nerr = genphy_config_aneg(phydev);\r\nif (err < 0)\r\nreturn err;\r\nif (phydev->autoneg != AUTONEG_ENABLE) {\r\nint bmcr;\r\nbmcr = phy_read(phydev, MII_BMCR);\r\nif (bmcr < 0)\r\nreturn bmcr;\r\nerr = phy_write(phydev, MII_BMCR, bmcr | BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int marvell_of_reg_init(struct phy_device *phydev)\r\n{\r\nconst __be32 *paddr;\r\nint len, i, saved_page, current_page, page_changed, ret;\r\nif (!phydev->mdio.dev.of_node)\r\nreturn 0;\r\npaddr = of_get_property(phydev->mdio.dev.of_node,\r\n"marvell,reg-init", &len);\r\nif (!paddr || len < (4 * sizeof(*paddr)))\r\nreturn 0;\r\nsaved_page = phy_read(phydev, MII_MARVELL_PHY_PAGE);\r\nif (saved_page < 0)\r\nreturn saved_page;\r\npage_changed = 0;\r\ncurrent_page = saved_page;\r\nret = 0;\r\nlen /= sizeof(*paddr);\r\nfor (i = 0; i < len - 3; i += 4) {\r\nu16 reg_page = be32_to_cpup(paddr + i);\r\nu16 reg = be32_to_cpup(paddr + i + 1);\r\nu16 mask = be32_to_cpup(paddr + i + 2);\r\nu16 val_bits = be32_to_cpup(paddr + i + 3);\r\nint val;\r\nif (reg_page != current_page) {\r\ncurrent_page = reg_page;\r\npage_changed = 1;\r\nret = phy_write(phydev, MII_MARVELL_PHY_PAGE, reg_page);\r\nif (ret < 0)\r\ngoto err;\r\n}\r\nval = 0;\r\nif (mask) {\r\nval = phy_read(phydev, reg);\r\nif (val < 0) {\r\nret = val;\r\ngoto err;\r\n}\r\nval &= mask;\r\n}\r\nval |= val_bits;\r\nret = phy_write(phydev, reg, val);\r\nif (ret < 0)\r\ngoto err;\r\n}\r\nerr:\r\nif (page_changed) {\r\ni = phy_write(phydev, MII_MARVELL_PHY_PAGE, saved_page);\r\nif (ret == 0)\r\nret = i;\r\n}\r\nreturn ret;\r\n}\r\nstatic int marvell_of_reg_init(struct phy_device *phydev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int m88e1121_config_aneg(struct phy_device *phydev)\r\n{\r\nint err, oldpage, mscr;\r\noldpage = phy_read(phydev, MII_MARVELL_PHY_PAGE);\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE,\r\nMII_88E1121_PHY_MSCR_PAGE);\r\nif (err < 0)\r\nreturn err;\r\nif (phy_interface_is_rgmii(phydev)) {\r\nmscr = phy_read(phydev, MII_88E1121_PHY_MSCR_REG) &\r\nMII_88E1121_PHY_MSCR_DELAY_MASK;\r\nif (phydev->interface == PHY_INTERFACE_MODE_RGMII_ID)\r\nmscr |= (MII_88E1121_PHY_MSCR_RX_DELAY |\r\nMII_88E1121_PHY_MSCR_TX_DELAY);\r\nelse if (phydev->interface == PHY_INTERFACE_MODE_RGMII_RXID)\r\nmscr |= MII_88E1121_PHY_MSCR_RX_DELAY;\r\nelse if (phydev->interface == PHY_INTERFACE_MODE_RGMII_TXID)\r\nmscr |= MII_88E1121_PHY_MSCR_TX_DELAY;\r\nerr = phy_write(phydev, MII_88E1121_PHY_MSCR_REG, mscr);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nphy_write(phydev, MII_MARVELL_PHY_PAGE, oldpage);\r\nerr = phy_write(phydev, MII_BMCR, BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_M1011_PHY_SCR,\r\nMII_M1011_PHY_SCR_AUTO_CROSS);\r\nif (err < 0)\r\nreturn err;\r\nreturn genphy_config_aneg(phydev);\r\n}\r\nstatic int m88e1318_config_aneg(struct phy_device *phydev)\r\n{\r\nint err, oldpage, mscr;\r\noldpage = phy_read(phydev, MII_MARVELL_PHY_PAGE);\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE,\r\nMII_88E1121_PHY_MSCR_PAGE);\r\nif (err < 0)\r\nreturn err;\r\nmscr = phy_read(phydev, MII_88E1318S_PHY_MSCR1_REG);\r\nmscr |= MII_88E1318S_PHY_MSCR1_PAD_ODD;\r\nerr = phy_write(phydev, MII_88E1318S_PHY_MSCR1_REG, mscr);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, oldpage);\r\nif (err < 0)\r\nreturn err;\r\nreturn m88e1121_config_aneg(phydev);\r\n}\r\nstatic inline u32 ethtool_adv_to_fiber_adv_t(u32 ethadv)\r\n{\r\nu32 result = 0;\r\nif (ethadv & ADVERTISED_1000baseT_Half)\r\nresult |= ADVERTISE_FIBER_1000HALF;\r\nif (ethadv & ADVERTISED_1000baseT_Full)\r\nresult |= ADVERTISE_FIBER_1000FULL;\r\nif ((ethadv & ADVERTISE_PAUSE_ASYM) && (ethadv & ADVERTISE_PAUSE_CAP))\r\nresult |= LPA_PAUSE_ASYM_FIBER;\r\nelse if (ethadv & ADVERTISE_PAUSE_CAP)\r\nresult |= (ADVERTISE_PAUSE_FIBER\r\n& (~ADVERTISE_PAUSE_ASYM_FIBER));\r\nreturn result;\r\n}\r\nstatic int marvell_config_aneg_fiber(struct phy_device *phydev)\r\n{\r\nint changed = 0;\r\nint err;\r\nint adv, oldadv;\r\nu32 advertise;\r\nif (phydev->autoneg != AUTONEG_ENABLE)\r\nreturn genphy_setup_forced(phydev);\r\nphydev->advertising &= phydev->supported;\r\nadvertise = phydev->advertising;\r\nadv = phy_read(phydev, MII_ADVERTISE);\r\nif (adv < 0)\r\nreturn adv;\r\noldadv = adv;\r\nadv &= ~(ADVERTISE_FIBER_1000HALF | ADVERTISE_FIBER_1000FULL\r\n| LPA_PAUSE_FIBER);\r\nadv |= ethtool_adv_to_fiber_adv_t(advertise);\r\nif (adv != oldadv) {\r\nerr = phy_write(phydev, MII_ADVERTISE, adv);\r\nif (err < 0)\r\nreturn err;\r\nchanged = 1;\r\n}\r\nif (changed == 0) {\r\nint ctl = phy_read(phydev, MII_BMCR);\r\nif (ctl < 0)\r\nreturn ctl;\r\nif (!(ctl & BMCR_ANENABLE) || (ctl & BMCR_ISOLATE))\r\nchanged = 1;\r\n}\r\nif (changed > 0)\r\nchanged = genphy_restart_aneg(phydev);\r\nreturn changed;\r\n}\r\nstatic int m88e1510_config_aneg(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, MII_M1111_COPPER);\r\nif (err < 0)\r\ngoto error;\r\nerr = m88e1318_config_aneg(phydev);\r\nif (err < 0)\r\ngoto error;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, MII_M1111_FIBER);\r\nif (err < 0)\r\ngoto error;\r\nerr = marvell_config_aneg_fiber(phydev);\r\nif (err < 0)\r\ngoto error;\r\nreturn phy_write(phydev, MII_MARVELL_PHY_PAGE, MII_M1111_COPPER);\r\nerror:\r\nphy_write(phydev, MII_MARVELL_PHY_PAGE, MII_M1111_COPPER);\r\nreturn err;\r\n}\r\nstatic int marvell_config_init(struct phy_device *phydev)\r\n{\r\nreturn marvell_of_reg_init(phydev);\r\n}\r\nstatic int m88e1116r_config_init(struct phy_device *phydev)\r\n{\r\nint temp;\r\nint err;\r\ntemp = phy_read(phydev, MII_BMCR);\r\ntemp |= BMCR_RESET;\r\nerr = phy_write(phydev, MII_BMCR, temp);\r\nif (err < 0)\r\nreturn err;\r\nmdelay(500);\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 0);\r\nif (err < 0)\r\nreturn err;\r\ntemp = phy_read(phydev, MII_M1011_PHY_SCR);\r\ntemp |= (7 << 12);\r\ntemp |= (1 << 11);\r\ntemp |= MII_M1011_PHY_SCR_AUTO_CROSS;\r\nerr = phy_write(phydev, MII_M1011_PHY_SCR, temp);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 2);\r\nif (err < 0)\r\nreturn err;\r\ntemp = phy_read(phydev, MII_M1116R_CONTROL_REG_MAC);\r\ntemp |= (1 << 5);\r\ntemp |= (1 << 4);\r\nerr = phy_write(phydev, MII_M1116R_CONTROL_REG_MAC, temp);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 0);\r\nif (err < 0)\r\nreturn err;\r\ntemp = phy_read(phydev, MII_BMCR);\r\ntemp |= BMCR_RESET;\r\nerr = phy_write(phydev, MII_BMCR, temp);\r\nif (err < 0)\r\nreturn err;\r\nmdelay(500);\r\nreturn marvell_config_init(phydev);\r\n}\r\nstatic int m88e3016_config_init(struct phy_device *phydev)\r\n{\r\nint reg;\r\nreg = phy_read(phydev, MII_88E3016_PHY_SPEC_CTRL);\r\nif (reg < 0)\r\nreturn reg;\r\nreg &= ~MII_88E3016_DISABLE_SCRAMBLER;\r\nreg |= MII_88E3016_AUTO_MDIX_CROSSOVER;\r\nreg = phy_write(phydev, MII_88E3016_PHY_SPEC_CTRL, reg);\r\nif (reg < 0)\r\nreturn reg;\r\nreturn marvell_config_init(phydev);\r\n}\r\nstatic int m88e1111_config_init(struct phy_device *phydev)\r\n{\r\nint err;\r\nint temp;\r\nif (phy_interface_is_rgmii(phydev)) {\r\ntemp = phy_read(phydev, MII_M1111_PHY_EXT_CR);\r\nif (temp < 0)\r\nreturn temp;\r\nif (phydev->interface == PHY_INTERFACE_MODE_RGMII_ID) {\r\ntemp |= (MII_M1111_RX_DELAY | MII_M1111_TX_DELAY);\r\n} else if (phydev->interface == PHY_INTERFACE_MODE_RGMII_RXID) {\r\ntemp &= ~MII_M1111_TX_DELAY;\r\ntemp |= MII_M1111_RX_DELAY;\r\n} else if (phydev->interface == PHY_INTERFACE_MODE_RGMII_TXID) {\r\ntemp &= ~MII_M1111_RX_DELAY;\r\ntemp |= MII_M1111_TX_DELAY;\r\n}\r\nerr = phy_write(phydev, MII_M1111_PHY_EXT_CR, temp);\r\nif (err < 0)\r\nreturn err;\r\ntemp = phy_read(phydev, MII_M1111_PHY_EXT_SR);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp &= ~(MII_M1111_HWCFG_MODE_MASK);\r\nif (temp & MII_M1111_HWCFG_FIBER_COPPER_RES)\r\ntemp |= MII_M1111_HWCFG_MODE_FIBER_RGMII;\r\nelse\r\ntemp |= MII_M1111_HWCFG_MODE_COPPER_RGMII;\r\nerr = phy_write(phydev, MII_M1111_PHY_EXT_SR, temp);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nif (phydev->interface == PHY_INTERFACE_MODE_SGMII) {\r\ntemp = phy_read(phydev, MII_M1111_PHY_EXT_SR);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp &= ~(MII_M1111_HWCFG_MODE_MASK);\r\ntemp |= MII_M1111_HWCFG_MODE_SGMII_NO_CLK;\r\ntemp |= MII_M1111_HWCFG_FIBER_COPPER_AUTO;\r\nerr = phy_write(phydev, MII_M1111_PHY_EXT_SR, temp);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_read(phydev, MII_M1145_PHY_EXT_ADDR_PAGE);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_M1145_PHY_EXT_ADDR_PAGE,\r\nerr & (~0xff));\r\nif (err < 0)\r\nreturn err;\r\n}\r\nif (phydev->interface == PHY_INTERFACE_MODE_RTBI) {\r\ntemp = phy_read(phydev, MII_M1111_PHY_EXT_CR);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp |= (MII_M1111_RX_DELAY | MII_M1111_TX_DELAY);\r\nerr = phy_write(phydev, MII_M1111_PHY_EXT_CR, temp);\r\nif (err < 0)\r\nreturn err;\r\ntemp = phy_read(phydev, MII_M1111_PHY_EXT_SR);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp &= ~(MII_M1111_HWCFG_MODE_MASK | MII_M1111_HWCFG_FIBER_COPPER_RES);\r\ntemp |= 0x7 | MII_M1111_HWCFG_FIBER_COPPER_AUTO;\r\nerr = phy_write(phydev, MII_M1111_PHY_EXT_SR, temp);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_BMCR, BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\ndo\r\ntemp = phy_read(phydev, MII_BMCR);\r\nwhile (temp & BMCR_RESET);\r\ntemp = phy_read(phydev, MII_M1111_PHY_EXT_SR);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp &= ~(MII_M1111_HWCFG_MODE_MASK | MII_M1111_HWCFG_FIBER_COPPER_RES);\r\ntemp |= MII_M1111_HWCFG_MODE_COPPER_RTBI | MII_M1111_HWCFG_FIBER_COPPER_AUTO;\r\nerr = phy_write(phydev, MII_M1111_PHY_EXT_SR, temp);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nerr = marvell_of_reg_init(phydev);\r\nif (err < 0)\r\nreturn err;\r\nreturn phy_write(phydev, MII_BMCR, BMCR_RESET);\r\n}\r\nstatic int m88e1121_config_init(struct phy_device *phydev)\r\n{\r\nint err, oldpage;\r\noldpage = phy_read(phydev, MII_MARVELL_PHY_PAGE);\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, MII_88E1121_PHY_LED_PAGE);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_88E1121_PHY_LED_CTRL,\r\nMII_88E1121_PHY_LED_DEF);\r\nif (err < 0)\r\nreturn err;\r\nphy_write(phydev, MII_MARVELL_PHY_PAGE, oldpage);\r\nreturn marvell_config_init(phydev);\r\n}\r\nstatic int m88e1510_config_init(struct phy_device *phydev)\r\n{\r\nint err;\r\nint temp;\r\nif (phydev->interface == PHY_INTERFACE_MODE_SGMII) {\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 18);\r\nif (err < 0)\r\nreturn err;\r\ntemp = phy_read(phydev, MII_88E1510_GEN_CTRL_REG_1);\r\ntemp &= ~MII_88E1510_GEN_CTRL_REG_1_MODE_MASK;\r\ntemp |= MII_88E1510_GEN_CTRL_REG_1_MODE_SGMII;\r\nerr = phy_write(phydev, MII_88E1510_GEN_CTRL_REG_1, temp);\r\nif (err < 0)\r\nreturn err;\r\ntemp |= MII_88E1510_GEN_CTRL_REG_1_RESET;\r\nerr = phy_write(phydev, MII_88E1510_GEN_CTRL_REG_1, temp);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 0);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nreturn m88e1121_config_init(phydev);\r\n}\r\nstatic int m88e1118_config_aneg(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_write(phydev, MII_BMCR, BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_M1011_PHY_SCR,\r\nMII_M1011_PHY_SCR_AUTO_CROSS);\r\nif (err < 0)\r\nreturn err;\r\nerr = genphy_config_aneg(phydev);\r\nreturn 0;\r\n}\r\nstatic int m88e1118_config_init(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 0x0002);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x15, 0x1070);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 0x0003);\r\nif (err < 0)\r\nreturn err;\r\nif (phydev->dev_flags & MARVELL_PHY_M1118_DNS323_LEDS)\r\nerr = phy_write(phydev, 0x10, 0x1100);\r\nelse\r\nerr = phy_write(phydev, 0x10, 0x021e);\r\nif (err < 0)\r\nreturn err;\r\nerr = marvell_of_reg_init(phydev);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 0x0);\r\nif (err < 0)\r\nreturn err;\r\nreturn phy_write(phydev, MII_BMCR, BMCR_RESET);\r\n}\r\nstatic int m88e1149_config_init(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 0x0002);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x15, 0x1048);\r\nif (err < 0)\r\nreturn err;\r\nerr = marvell_of_reg_init(phydev);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 0x0);\r\nif (err < 0)\r\nreturn err;\r\nreturn phy_write(phydev, MII_BMCR, BMCR_RESET);\r\n}\r\nstatic int m88e1145_config_init(struct phy_device *phydev)\r\n{\r\nint err;\r\nint temp;\r\nerr = phy_write(phydev, 0x1d, 0x001b);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1e, 0x418f);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1d, 0x0016);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1e, 0xa2da);\r\nif (err < 0)\r\nreturn err;\r\nif (phydev->interface == PHY_INTERFACE_MODE_RGMII_ID) {\r\nint temp = phy_read(phydev, MII_M1145_PHY_EXT_CR);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp |= (MII_M1145_RGMII_RX_DELAY | MII_M1145_RGMII_TX_DELAY);\r\nerr = phy_write(phydev, MII_M1145_PHY_EXT_CR, temp);\r\nif (err < 0)\r\nreturn err;\r\nif (phydev->dev_flags & MARVELL_PHY_M1145_FLAGS_RESISTANCE) {\r\nerr = phy_write(phydev, 0x1d, 0x0012);\r\nif (err < 0)\r\nreturn err;\r\ntemp = phy_read(phydev, 0x1e);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp &= 0xf03f;\r\ntemp |= 2 << 9;\r\ntemp |= 2 << 6;\r\nerr = phy_write(phydev, 0x1e, temp);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1d, 0x3);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1e, 0x8000);\r\nif (err < 0)\r\nreturn err;\r\n}\r\n}\r\nif (phydev->interface == PHY_INTERFACE_MODE_SGMII) {\r\ntemp = phy_read(phydev, MII_M1145_PHY_EXT_SR);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp &= ~MII_M1145_HWCFG_MODE_MASK;\r\ntemp |= MII_M1145_HWCFG_MODE_SGMII_NO_CLK;\r\ntemp |= MII_M1145_HWCFG_FIBER_COPPER_AUTO;\r\nerr = phy_write(phydev, MII_M1145_PHY_EXT_SR, temp);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nerr = marvell_of_reg_init(phydev);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic u32 fiber_lpa_to_ethtool_lpa_t(u32 lpa)\r\n{\r\nu32 result = 0;\r\nif (lpa & LPA_FIBER_1000HALF)\r\nresult |= ADVERTISED_1000baseT_Half;\r\nif (lpa & LPA_FIBER_1000FULL)\r\nresult |= ADVERTISED_1000baseT_Full;\r\nreturn result;\r\n}\r\nstatic int marvell_update_link(struct phy_device *phydev, int fiber)\r\n{\r\nint status;\r\nif (fiber) {\r\nstatus = phy_read(phydev, MII_M1011_PHY_STATUS);\r\nif (status < 0)\r\nreturn status;\r\nif ((status & REGISTER_LINK_STATUS) == 0)\r\nphydev->link = 0;\r\nelse\r\nphydev->link = 1;\r\n} else {\r\nreturn genphy_update_link(phydev);\r\n}\r\nreturn 0;\r\n}\r\nstatic int marvell_read_status_page(struct phy_device *phydev, int page)\r\n{\r\nint adv;\r\nint err;\r\nint lpa;\r\nint lpagb;\r\nint status = 0;\r\nint fiber;\r\nif (page == MII_M1111_FIBER)\r\nfiber = 1;\r\nelse\r\nfiber = 0;\r\nerr = marvell_update_link(phydev, fiber);\r\nif (err)\r\nreturn err;\r\nif (AUTONEG_ENABLE == phydev->autoneg) {\r\nstatus = phy_read(phydev, MII_M1011_PHY_STATUS);\r\nif (status < 0)\r\nreturn status;\r\nlpa = phy_read(phydev, MII_LPA);\r\nif (lpa < 0)\r\nreturn lpa;\r\nlpagb = phy_read(phydev, MII_STAT1000);\r\nif (lpagb < 0)\r\nreturn lpagb;\r\nadv = phy_read(phydev, MII_ADVERTISE);\r\nif (adv < 0)\r\nreturn adv;\r\nlpa &= adv;\r\nif (status & MII_M1011_PHY_STATUS_FULLDUPLEX)\r\nphydev->duplex = DUPLEX_FULL;\r\nelse\r\nphydev->duplex = DUPLEX_HALF;\r\nstatus = status & MII_M1011_PHY_STATUS_SPD_MASK;\r\nphydev->pause = phydev->asym_pause = 0;\r\nswitch (status) {\r\ncase MII_M1011_PHY_STATUS_1000:\r\nphydev->speed = SPEED_1000;\r\nbreak;\r\ncase MII_M1011_PHY_STATUS_100:\r\nphydev->speed = SPEED_100;\r\nbreak;\r\ndefault:\r\nphydev->speed = SPEED_10;\r\nbreak;\r\n}\r\nif (!fiber) {\r\nphydev->lp_advertising = mii_stat1000_to_ethtool_lpa_t(lpagb) |\r\nmii_lpa_to_ethtool_lpa_t(lpa);\r\nif (phydev->duplex == DUPLEX_FULL) {\r\nphydev->pause = lpa & LPA_PAUSE_CAP ? 1 : 0;\r\nphydev->asym_pause = lpa & LPA_PAUSE_ASYM ? 1 : 0;\r\n}\r\n} else {\r\nphydev->lp_advertising = fiber_lpa_to_ethtool_lpa_t(lpa);\r\nif (phydev->duplex == DUPLEX_FULL) {\r\nif (!(lpa & LPA_PAUSE_FIBER)) {\r\nphydev->pause = 0;\r\nphydev->asym_pause = 0;\r\n} else if ((lpa & LPA_PAUSE_ASYM_FIBER)) {\r\nphydev->pause = 1;\r\nphydev->asym_pause = 1;\r\n} else {\r\nphydev->pause = 1;\r\nphydev->asym_pause = 0;\r\n}\r\n}\r\n}\r\n} else {\r\nint bmcr = phy_read(phydev, MII_BMCR);\r\nif (bmcr < 0)\r\nreturn bmcr;\r\nif (bmcr & BMCR_FULLDPLX)\r\nphydev->duplex = DUPLEX_FULL;\r\nelse\r\nphydev->duplex = DUPLEX_HALF;\r\nif (bmcr & BMCR_SPEED1000)\r\nphydev->speed = SPEED_1000;\r\nelse if (bmcr & BMCR_SPEED100)\r\nphydev->speed = SPEED_100;\r\nelse\r\nphydev->speed = SPEED_10;\r\nphydev->pause = phydev->asym_pause = 0;\r\nphydev->lp_advertising = 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int marvell_read_status(struct phy_device *phydev)\r\n{\r\nint err;\r\nif (phydev->supported & SUPPORTED_FIBRE) {\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, MII_M1111_FIBER);\r\nif (err < 0)\r\ngoto error;\r\nerr = marvell_read_status_page(phydev, MII_M1111_FIBER);\r\nif (err < 0)\r\ngoto error;\r\nif (phydev->link)\r\nreturn 0;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, MII_M1111_COPPER);\r\nif (err < 0)\r\ngoto error;\r\n}\r\nreturn marvell_read_status_page(phydev, MII_M1111_COPPER);\r\nerror:\r\nphy_write(phydev, MII_MARVELL_PHY_PAGE, MII_M1111_COPPER);\r\nreturn err;\r\n}\r\nstatic int marvell_suspend(struct phy_device *phydev)\r\n{\r\nint err;\r\nif (!(phydev->supported & SUPPORTED_FIBRE)) {\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, MII_M1111_FIBER);\r\nif (err < 0)\r\ngoto error;\r\nerr = genphy_suspend(phydev);\r\nif (err < 0)\r\ngoto error;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, MII_M1111_COPPER);\r\nif (err < 0)\r\ngoto error;\r\n}\r\nreturn genphy_suspend(phydev);\r\nerror:\r\nphy_write(phydev, MII_MARVELL_PHY_PAGE, MII_M1111_COPPER);\r\nreturn err;\r\n}\r\nstatic int marvell_resume(struct phy_device *phydev)\r\n{\r\nint err;\r\nif (!(phydev->supported & SUPPORTED_FIBRE)) {\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, MII_M1111_FIBER);\r\nif (err < 0)\r\ngoto error;\r\nerr = genphy_resume(phydev);\r\nif (err < 0)\r\ngoto error;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, MII_M1111_COPPER);\r\nif (err < 0)\r\ngoto error;\r\n}\r\nreturn genphy_resume(phydev);\r\nerror:\r\nphy_write(phydev, MII_MARVELL_PHY_PAGE, MII_M1111_COPPER);\r\nreturn err;\r\n}\r\nstatic int marvell_aneg_done(struct phy_device *phydev)\r\n{\r\nint retval = phy_read(phydev, MII_M1011_PHY_STATUS);\r\nreturn (retval < 0) ? retval : (retval & MII_M1011_PHY_STATUS_RESOLVED);\r\n}\r\nstatic int m88e1121_did_interrupt(struct phy_device *phydev)\r\n{\r\nint imask;\r\nimask = phy_read(phydev, MII_M1011_IEVENT);\r\nif (imask & MII_M1011_IMASK_INIT)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void m88e1318_get_wol(struct phy_device *phydev, struct ethtool_wolinfo *wol)\r\n{\r\nwol->supported = WAKE_MAGIC;\r\nwol->wolopts = 0;\r\nif (phy_write(phydev, MII_MARVELL_PHY_PAGE,\r\nMII_88E1318S_PHY_WOL_PAGE) < 0)\r\nreturn;\r\nif (phy_read(phydev, MII_88E1318S_PHY_WOL_CTRL) &\r\nMII_88E1318S_PHY_WOL_CTRL_MAGIC_PACKET_MATCH_ENABLE)\r\nwol->wolopts |= WAKE_MAGIC;\r\nif (phy_write(phydev, MII_MARVELL_PHY_PAGE, 0x00) < 0)\r\nreturn;\r\n}\r\nstatic int m88e1318_set_wol(struct phy_device *phydev, struct ethtool_wolinfo *wol)\r\n{\r\nint err, oldpage, temp;\r\noldpage = phy_read(phydev, MII_MARVELL_PHY_PAGE);\r\nif (wol->wolopts & WAKE_MAGIC) {\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 0x00);\r\nif (err < 0)\r\nreturn err;\r\ntemp = phy_read(phydev, MII_88E1318S_PHY_CSIER);\r\ntemp |= MII_88E1318S_PHY_CSIER_WOL_EIE;\r\nerr = phy_write(phydev, MII_88E1318S_PHY_CSIER, temp);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE,\r\nMII_88E1318S_PHY_LED_PAGE);\r\nif (err < 0)\r\nreturn err;\r\ntemp = phy_read(phydev, MII_88E1318S_PHY_LED_TCR);\r\ntemp &= ~MII_88E1318S_PHY_LED_TCR_FORCE_INT;\r\ntemp |= MII_88E1318S_PHY_LED_TCR_INTn_ENABLE;\r\ntemp |= MII_88E1318S_PHY_LED_TCR_INT_ACTIVE_LOW;\r\nerr = phy_write(phydev, MII_88E1318S_PHY_LED_TCR, temp);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE,\r\nMII_88E1318S_PHY_WOL_PAGE);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_88E1318S_PHY_MAGIC_PACKET_WORD2,\r\n((phydev->attached_dev->dev_addr[5] << 8) |\r\nphydev->attached_dev->dev_addr[4]));\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_88E1318S_PHY_MAGIC_PACKET_WORD1,\r\n((phydev->attached_dev->dev_addr[3] << 8) |\r\nphydev->attached_dev->dev_addr[2]));\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_88E1318S_PHY_MAGIC_PACKET_WORD0,\r\n((phydev->attached_dev->dev_addr[1] << 8) |\r\nphydev->attached_dev->dev_addr[0]));\r\nif (err < 0)\r\nreturn err;\r\ntemp = phy_read(phydev, MII_88E1318S_PHY_WOL_CTRL);\r\ntemp |= MII_88E1318S_PHY_WOL_CTRL_CLEAR_WOL_STATUS;\r\ntemp |= MII_88E1318S_PHY_WOL_CTRL_MAGIC_PACKET_MATCH_ENABLE;\r\nerr = phy_write(phydev, MII_88E1318S_PHY_WOL_CTRL, temp);\r\nif (err < 0)\r\nreturn err;\r\n} else {\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE,\r\nMII_88E1318S_PHY_WOL_PAGE);\r\nif (err < 0)\r\nreturn err;\r\ntemp = phy_read(phydev, MII_88E1318S_PHY_WOL_CTRL);\r\ntemp |= MII_88E1318S_PHY_WOL_CTRL_CLEAR_WOL_STATUS;\r\ntemp &= ~MII_88E1318S_PHY_WOL_CTRL_MAGIC_PACKET_MATCH_ENABLE;\r\nerr = phy_write(phydev, MII_88E1318S_PHY_WOL_CTRL, temp);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, oldpage);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int marvell_get_sset_count(struct phy_device *phydev)\r\n{\r\nif (phydev->supported & SUPPORTED_FIBRE)\r\nreturn ARRAY_SIZE(marvell_hw_stats);\r\nelse\r\nreturn ARRAY_SIZE(marvell_hw_stats) - NB_FIBER_STATS;\r\n}\r\nstatic void marvell_get_strings(struct phy_device *phydev, u8 *data)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(marvell_hw_stats); i++) {\r\nmemcpy(data + i * ETH_GSTRING_LEN,\r\nmarvell_hw_stats[i].string, ETH_GSTRING_LEN);\r\n}\r\n}\r\nstatic u64 marvell_get_stat(struct phy_device *phydev, int i)\r\n{\r\nstruct marvell_hw_stat stat = marvell_hw_stats[i];\r\nstruct marvell_priv *priv = phydev->priv;\r\nint err, oldpage, val;\r\nu64 ret;\r\noldpage = phy_read(phydev, MII_MARVELL_PHY_PAGE);\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE,\r\nstat.page);\r\nif (err < 0)\r\nreturn UINT64_MAX;\r\nval = phy_read(phydev, stat.reg);\r\nif (val < 0) {\r\nret = UINT64_MAX;\r\n} else {\r\nval = val & ((1 << stat.bits) - 1);\r\npriv->stats[i] += val;\r\nret = priv->stats[i];\r\n}\r\nphy_write(phydev, MII_MARVELL_PHY_PAGE, oldpage);\r\nreturn ret;\r\n}\r\nstatic void marvell_get_stats(struct phy_device *phydev,\r\nstruct ethtool_stats *stats, u64 *data)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(marvell_hw_stats); i++)\r\ndata[i] = marvell_get_stat(phydev, i);\r\n}\r\nstatic int marvell_probe(struct phy_device *phydev)\r\n{\r\nstruct marvell_priv *priv;\r\npriv = devm_kzalloc(&phydev->mdio.dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nphydev->priv = priv;\r\nreturn 0;\r\n}

static u8 clk_sp810_timerclken_get_parent(struct clk_hw *hw)\r\n{\r\nstruct clk_sp810_timerclken *timerclken = to_clk_sp810_timerclken(hw);\r\nu32 val = readl(timerclken->sp810->base + SCCTRL);\r\nreturn !!(val & (1 << SCCTRL_TIMERENnSEL_SHIFT(timerclken->channel)));\r\n}\r\nstatic int clk_sp810_timerclken_set_parent(struct clk_hw *hw, u8 index)\r\n{\r\nstruct clk_sp810_timerclken *timerclken = to_clk_sp810_timerclken(hw);\r\nstruct clk_sp810 *sp810 = timerclken->sp810;\r\nu32 val, shift = SCCTRL_TIMERENnSEL_SHIFT(timerclken->channel);\r\nunsigned long flags = 0;\r\nif (WARN_ON(index > 1))\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&sp810->lock, flags);\r\nval = readl(sp810->base + SCCTRL);\r\nval &= ~(1 << shift);\r\nval |= index << shift;\r\nwritel(val, sp810->base + SCCTRL);\r\nspin_unlock_irqrestore(&sp810->lock, flags);\r\nreturn 0;\r\n}\r\nstatic struct clk *clk_sp810_timerclken_of_get(struct of_phandle_args *clkspec,\r\nvoid *data)\r\n{\r\nstruct clk_sp810 *sp810 = data;\r\nif (WARN_ON(clkspec->args_count != 1 ||\r\nclkspec->args[0] >= ARRAY_SIZE(sp810->timerclken)))\r\nreturn NULL;\r\nreturn sp810->timerclken[clkspec->args[0]].clk;\r\n}\r\nstatic void __init clk_sp810_of_setup(struct device_node *node)\r\n{\r\nstruct clk_sp810 *sp810 = kzalloc(sizeof(*sp810), GFP_KERNEL);\r\nconst char *parent_names[2];\r\nint num = ARRAY_SIZE(parent_names);\r\nchar name[12];\r\nstruct clk_init_data init;\r\nstatic int instance;\r\nint i;\r\nbool deprecated;\r\nif (!sp810)\r\nreturn;\r\nif (of_clk_parent_fill(node, parent_names, num) != num) {\r\npr_warn("Failed to obtain parent clocks for SP810!\n");\r\nkfree(sp810);\r\nreturn;\r\n}\r\nsp810->node = node;\r\nsp810->base = of_iomap(node, 0);\r\nspin_lock_init(&sp810->lock);\r\ninit.name = name;\r\ninit.ops = &clk_sp810_timerclken_ops;\r\ninit.flags = CLK_IS_BASIC;\r\ninit.parent_names = parent_names;\r\ninit.num_parents = num;\r\ndeprecated = !of_find_property(node, "assigned-clock-parents", NULL);\r\nfor (i = 0; i < ARRAY_SIZE(sp810->timerclken); i++) {\r\nsnprintf(name, sizeof(name), "sp810_%d_%d", instance, i);\r\nsp810->timerclken[i].sp810 = sp810;\r\nsp810->timerclken[i].channel = i;\r\nsp810->timerclken[i].hw.init = &init;\r\nif (deprecated)\r\ninit.ops->set_parent(&sp810->timerclken[i].hw, 1);\r\nsp810->timerclken[i].clk = clk_register(NULL,\r\n&sp810->timerclken[i].hw);\r\nWARN_ON(IS_ERR(sp810->timerclken[i].clk));\r\n}\r\nof_clk_add_provider(node, clk_sp810_timerclken_of_get, sp810);\r\ninstance++;\r\n}

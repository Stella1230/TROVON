static int ltc4260_get_value(struct device *dev, u8 reg)\r\n{\r\nstruct regmap *regmap = dev_get_drvdata(dev);\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(regmap, reg, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nswitch (reg) {\r\ncase LTC4260_ADIN:\r\nval = val * 10;\r\nbreak;\r\ncase LTC4260_SOURCE:\r\nval = val * 400;\r\nbreak;\r\ncase LTC4260_SENSE:\r\nval = val * 300;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn val;\r\n}\r\nstatic ssize_t ltc4260_show_value(struct device *dev,\r\nstruct device_attribute *da, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nint value;\r\nvalue = ltc4260_get_value(dev, attr->index);\r\nif (value < 0)\r\nreturn value;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", value);\r\n}\r\nstatic ssize_t ltc4260_show_bool(struct device *dev,\r\nstruct device_attribute *da, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nstruct regmap *regmap = dev_get_drvdata(dev);\r\nunsigned int fault;\r\nint ret;\r\nret = regmap_read(regmap, LTC4260_FAULT, &fault);\r\nif (ret < 0)\r\nreturn ret;\r\nfault &= attr->index;\r\nif (fault)\r\nregmap_update_bits(regmap, LTC4260_FAULT, attr->index, 0);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", !!fault);\r\n}\r\nstatic int ltc4260_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct device *hwmon_dev;\r\nstruct regmap *regmap;\r\nregmap = devm_regmap_init_i2c(client, &ltc4260_regmap_config);\r\nif (IS_ERR(regmap)) {\r\ndev_err(dev, "failed to allocate register map\n");\r\nreturn PTR_ERR(regmap);\r\n}\r\nregmap_write(regmap, LTC4260_FAULT, 0x00);\r\nhwmon_dev = devm_hwmon_device_register_with_groups(dev, client->name,\r\nregmap,\r\nltc4260_groups);\r\nreturn PTR_ERR_OR_ZERO(hwmon_dev);\r\n}

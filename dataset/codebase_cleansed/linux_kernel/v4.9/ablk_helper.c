int ablk_set_key(struct crypto_ablkcipher *tfm, const u8 *key,\r\nunsigned int key_len)\r\n{\r\nstruct async_helper_ctx *ctx = crypto_ablkcipher_ctx(tfm);\r\nstruct crypto_ablkcipher *child = &ctx->cryptd_tfm->base;\r\nint err;\r\ncrypto_ablkcipher_clear_flags(child, CRYPTO_TFM_REQ_MASK);\r\ncrypto_ablkcipher_set_flags(child, crypto_ablkcipher_get_flags(tfm)\r\n& CRYPTO_TFM_REQ_MASK);\r\nerr = crypto_ablkcipher_setkey(child, key, key_len);\r\ncrypto_ablkcipher_set_flags(tfm, crypto_ablkcipher_get_flags(child)\r\n& CRYPTO_TFM_RES_MASK);\r\nreturn err;\r\n}\r\nint __ablk_encrypt(struct ablkcipher_request *req)\r\n{\r\nstruct crypto_ablkcipher *tfm = crypto_ablkcipher_reqtfm(req);\r\nstruct async_helper_ctx *ctx = crypto_ablkcipher_ctx(tfm);\r\nstruct blkcipher_desc desc;\r\ndesc.tfm = cryptd_ablkcipher_child(ctx->cryptd_tfm);\r\ndesc.info = req->info;\r\ndesc.flags = 0;\r\nreturn crypto_blkcipher_crt(desc.tfm)->encrypt(\r\n&desc, req->dst, req->src, req->nbytes);\r\n}\r\nint ablk_encrypt(struct ablkcipher_request *req)\r\n{\r\nstruct crypto_ablkcipher *tfm = crypto_ablkcipher_reqtfm(req);\r\nstruct async_helper_ctx *ctx = crypto_ablkcipher_ctx(tfm);\r\nif (!may_use_simd() ||\r\n(in_atomic() && cryptd_ablkcipher_queued(ctx->cryptd_tfm))) {\r\nstruct ablkcipher_request *cryptd_req =\r\nablkcipher_request_ctx(req);\r\n*cryptd_req = *req;\r\nablkcipher_request_set_tfm(cryptd_req, &ctx->cryptd_tfm->base);\r\nreturn crypto_ablkcipher_encrypt(cryptd_req);\r\n} else {\r\nreturn __ablk_encrypt(req);\r\n}\r\n}\r\nint ablk_decrypt(struct ablkcipher_request *req)\r\n{\r\nstruct crypto_ablkcipher *tfm = crypto_ablkcipher_reqtfm(req);\r\nstruct async_helper_ctx *ctx = crypto_ablkcipher_ctx(tfm);\r\nif (!may_use_simd() ||\r\n(in_atomic() && cryptd_ablkcipher_queued(ctx->cryptd_tfm))) {\r\nstruct ablkcipher_request *cryptd_req =\r\nablkcipher_request_ctx(req);\r\n*cryptd_req = *req;\r\nablkcipher_request_set_tfm(cryptd_req, &ctx->cryptd_tfm->base);\r\nreturn crypto_ablkcipher_decrypt(cryptd_req);\r\n} else {\r\nstruct blkcipher_desc desc;\r\ndesc.tfm = cryptd_ablkcipher_child(ctx->cryptd_tfm);\r\ndesc.info = req->info;\r\ndesc.flags = 0;\r\nreturn crypto_blkcipher_crt(desc.tfm)->decrypt(\r\n&desc, req->dst, req->src, req->nbytes);\r\n}\r\n}\r\nvoid ablk_exit(struct crypto_tfm *tfm)\r\n{\r\nstruct async_helper_ctx *ctx = crypto_tfm_ctx(tfm);\r\ncryptd_free_ablkcipher(ctx->cryptd_tfm);\r\n}\r\nint ablk_init_common(struct crypto_tfm *tfm, const char *drv_name)\r\n{\r\nstruct async_helper_ctx *ctx = crypto_tfm_ctx(tfm);\r\nstruct cryptd_ablkcipher *cryptd_tfm;\r\ncryptd_tfm = cryptd_alloc_ablkcipher(drv_name, CRYPTO_ALG_INTERNAL,\r\nCRYPTO_ALG_INTERNAL);\r\nif (IS_ERR(cryptd_tfm))\r\nreturn PTR_ERR(cryptd_tfm);\r\nctx->cryptd_tfm = cryptd_tfm;\r\ntfm->crt_ablkcipher.reqsize = sizeof(struct ablkcipher_request) +\r\ncrypto_ablkcipher_reqsize(&cryptd_tfm->base);\r\nreturn 0;\r\n}\r\nint ablk_init(struct crypto_tfm *tfm)\r\n{\r\nchar drv_name[CRYPTO_MAX_ALG_NAME];\r\nsnprintf(drv_name, sizeof(drv_name), "__driver-%s",\r\ncrypto_tfm_alg_driver_name(tfm));\r\nreturn ablk_init_common(tfm, drv_name);\r\n}

static void rsnd_dvc_activation(struct rsnd_mod *mod)\r\n{\r\nrsnd_mod_write(mod, DVC_SWRSR, 0);\r\nrsnd_mod_write(mod, DVC_SWRSR, 1);\r\n}\r\nstatic void rsnd_dvc_halt(struct rsnd_mod *mod)\r\n{\r\nrsnd_mod_write(mod, DVC_DVUIR, 1);\r\nrsnd_mod_write(mod, DVC_SWRSR, 0);\r\n}\r\nstatic void rsnd_dvc_volume_parameter(struct rsnd_dai_stream *io,\r\nstruct rsnd_mod *mod)\r\n{\r\nstruct rsnd_dvc *dvc = rsnd_mod_to_dvc(mod);\r\nu32 val[RSND_MAX_CHANNELS];\r\nint i;\r\nif (dvc->ren.val)\r\nfor (i = 0; i < RSND_MAX_CHANNELS; i++)\r\nval[i] = dvc->volume.cfg.max;\r\nelse\r\nfor (i = 0; i < RSND_MAX_CHANNELS; i++)\r\nval[i] = dvc->volume.val[i];\r\nrsnd_mod_write(mod, DVC_VOL0R, val[0]);\r\nrsnd_mod_write(mod, DVC_VOL1R, val[1]);\r\nrsnd_mod_write(mod, DVC_VOL2R, val[2]);\r\nrsnd_mod_write(mod, DVC_VOL3R, val[3]);\r\nrsnd_mod_write(mod, DVC_VOL4R, val[4]);\r\nrsnd_mod_write(mod, DVC_VOL5R, val[5]);\r\nrsnd_mod_write(mod, DVC_VOL6R, val[6]);\r\nrsnd_mod_write(mod, DVC_VOL7R, val[7]);\r\n}\r\nstatic void rsnd_dvc_volume_init(struct rsnd_dai_stream *io,\r\nstruct rsnd_mod *mod)\r\n{\r\nstruct rsnd_dvc *dvc = rsnd_mod_to_dvc(mod);\r\nu32 adinr = 0;\r\nu32 dvucr = 0;\r\nu32 vrctr = 0;\r\nu32 vrpdr = 0;\r\nu32 vrdbr = 0;\r\nadinr = rsnd_get_adinr_bit(mod, io) |\r\nrsnd_runtime_channel_after_ctu(io);\r\ndvucr |= 0x101;\r\nif (dvc->ren.val) {\r\ndvucr |= 0x10;\r\nvrctr = 0xff;\r\nvrpdr = rsnd_dvc_get_vrpdr(dvc);\r\nvrdbr = rsnd_dvc_get_vrdbr(dvc);\r\n}\r\nrsnd_mod_write(mod, DVC_DVUIR, 1);\r\nrsnd_mod_write(mod, DVC_ADINR, adinr);\r\nrsnd_mod_write(mod, DVC_DVUCR, dvucr);\r\nrsnd_mod_write(mod, DVC_VRCTR, vrctr);\r\nrsnd_mod_write(mod, DVC_VRPDR, vrpdr);\r\nrsnd_mod_write(mod, DVC_VRDBR, vrdbr);\r\nrsnd_dvc_volume_parameter(io, mod);\r\nrsnd_mod_write(mod, DVC_DVUIR, 0);\r\n}\r\nstatic void rsnd_dvc_volume_update(struct rsnd_dai_stream *io,\r\nstruct rsnd_mod *mod)\r\n{\r\nstruct rsnd_dvc *dvc = rsnd_mod_to_dvc(mod);\r\nu32 zcmcr = 0;\r\nu32 vrpdr = 0;\r\nu32 vrdbr = 0;\r\nint i;\r\nfor (i = 0; i < dvc->mute.cfg.size; i++)\r\nzcmcr |= (!!dvc->mute.cfg.val[i]) << i;\r\nif (dvc->ren.val) {\r\nvrpdr = rsnd_dvc_get_vrpdr(dvc);\r\nvrdbr = rsnd_dvc_get_vrdbr(dvc);\r\n}\r\nrsnd_mod_write(mod, DVC_DVUER, 0);\r\nrsnd_mod_write(mod, DVC_ZCMCR, zcmcr);\r\nrsnd_mod_write(mod, DVC_VRPDR, vrpdr);\r\nrsnd_mod_write(mod, DVC_VRDBR, vrdbr);\r\nrsnd_dvc_volume_parameter(io, mod);\r\nrsnd_mod_write(mod, DVC_DVUER, 1);\r\n}\r\nstatic int rsnd_dvc_probe_(struct rsnd_mod *mod,\r\nstruct rsnd_dai_stream *io,\r\nstruct rsnd_priv *priv)\r\n{\r\nreturn rsnd_cmd_attach(io, rsnd_mod_id(mod));\r\n}\r\nstatic int rsnd_dvc_remove_(struct rsnd_mod *mod,\r\nstruct rsnd_dai_stream *io,\r\nstruct rsnd_priv *priv)\r\n{\r\nstruct rsnd_dvc *dvc = rsnd_mod_to_dvc(mod);\r\nrsnd_kctrl_remove(dvc->volume);\r\nrsnd_kctrl_remove(dvc->mute);\r\nrsnd_kctrl_remove(dvc->ren);\r\nrsnd_kctrl_remove(dvc->rup);\r\nrsnd_kctrl_remove(dvc->rdown);\r\nreturn 0;\r\n}\r\nstatic int rsnd_dvc_init(struct rsnd_mod *mod,\r\nstruct rsnd_dai_stream *io,\r\nstruct rsnd_priv *priv)\r\n{\r\nrsnd_mod_power_on(mod);\r\nrsnd_dvc_activation(mod);\r\nrsnd_dvc_volume_init(io, mod);\r\nrsnd_dvc_volume_update(io, mod);\r\nreturn 0;\r\n}\r\nstatic int rsnd_dvc_quit(struct rsnd_mod *mod,\r\nstruct rsnd_dai_stream *io,\r\nstruct rsnd_priv *priv)\r\n{\r\nrsnd_dvc_halt(mod);\r\nrsnd_mod_power_off(mod);\r\nreturn 0;\r\n}\r\nstatic int rsnd_dvc_pcm_new(struct rsnd_mod *mod,\r\nstruct rsnd_dai_stream *io,\r\nstruct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct rsnd_dvc *dvc = rsnd_mod_to_dvc(mod);\r\nint is_play = rsnd_io_is_play(io);\r\nint slots = rsnd_get_slot(io);\r\nint ret;\r\nret = rsnd_kctrl_new_m(mod, io, rtd,\r\nis_play ?\r\n"DVC Out Playback Volume" : "DVC In Capture Volume",\r\nrsnd_dvc_volume_update,\r\n&dvc->volume, slots,\r\n0x00800000 - 1);\r\nif (ret < 0)\r\nreturn ret;\r\nret = rsnd_kctrl_new_m(mod, io, rtd,\r\nis_play ?\r\n"DVC Out Mute Switch" : "DVC In Mute Switch",\r\nrsnd_dvc_volume_update,\r\n&dvc->mute, slots,\r\n1);\r\nif (ret < 0)\r\nreturn ret;\r\nret = rsnd_kctrl_new_s(mod, io, rtd,\r\nis_play ?\r\n"DVC Out Ramp Switch" : "DVC In Ramp Switch",\r\nrsnd_dvc_volume_update,\r\n&dvc->ren, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nret = rsnd_kctrl_new_e(mod, io, rtd,\r\nis_play ?\r\n"DVC Out Ramp Up Rate" : "DVC In Ramp Up Rate",\r\n&dvc->rup,\r\nrsnd_dvc_volume_update,\r\ndvc_ramp_rate, ARRAY_SIZE(dvc_ramp_rate));\r\nif (ret < 0)\r\nreturn ret;\r\nret = rsnd_kctrl_new_e(mod, io, rtd,\r\nis_play ?\r\n"DVC Out Ramp Down Rate" : "DVC In Ramp Down Rate",\r\n&dvc->rdown,\r\nrsnd_dvc_volume_update,\r\ndvc_ramp_rate, ARRAY_SIZE(dvc_ramp_rate));\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic struct dma_chan *rsnd_dvc_dma_req(struct rsnd_dai_stream *io,\r\nstruct rsnd_mod *mod)\r\n{\r\nstruct rsnd_priv *priv = rsnd_mod_to_priv(mod);\r\nreturn rsnd_dma_request_channel(rsnd_dvc_of_node(priv),\r\nmod, "tx");\r\n}\r\nstruct rsnd_mod *rsnd_dvc_mod_get(struct rsnd_priv *priv, int id)\r\n{\r\nif (WARN_ON(id < 0 || id >= rsnd_dvc_nr(priv)))\r\nid = 0;\r\nreturn rsnd_mod_get(rsnd_dvc_get(priv, id));\r\n}\r\nint rsnd_dvc_probe(struct rsnd_priv *priv)\r\n{\r\nstruct device_node *node;\r\nstruct device_node *np;\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\nstruct rsnd_dvc *dvc;\r\nstruct clk *clk;\r\nchar name[RSND_DVC_NAME_SIZE];\r\nint i, nr, ret;\r\nif (rsnd_is_gen1(priv))\r\nreturn 0;\r\nnode = rsnd_dvc_of_node(priv);\r\nif (!node)\r\nreturn 0;\r\nnr = of_get_child_count(node);\r\nif (!nr) {\r\nret = -EINVAL;\r\ngoto rsnd_dvc_probe_done;\r\n}\r\ndvc = devm_kzalloc(dev, sizeof(*dvc) * nr, GFP_KERNEL);\r\nif (!dvc) {\r\nret = -ENOMEM;\r\ngoto rsnd_dvc_probe_done;\r\n}\r\npriv->dvc_nr = nr;\r\npriv->dvc = dvc;\r\ni = 0;\r\nret = 0;\r\nfor_each_child_of_node(node, np) {\r\ndvc = rsnd_dvc_get(priv, i);\r\nsnprintf(name, RSND_DVC_NAME_SIZE, "%s.%d",\r\nDVC_NAME, i);\r\nclk = devm_clk_get(dev, name);\r\nif (IS_ERR(clk)) {\r\nret = PTR_ERR(clk);\r\ngoto rsnd_dvc_probe_done;\r\n}\r\nret = rsnd_mod_init(priv, rsnd_mod_get(dvc), &rsnd_dvc_ops,\r\nclk, rsnd_mod_get_status, RSND_MOD_DVC, i);\r\nif (ret)\r\ngoto rsnd_dvc_probe_done;\r\ni++;\r\n}\r\nrsnd_dvc_probe_done:\r\nof_node_put(node);\r\nreturn ret;\r\n}\r\nvoid rsnd_dvc_remove(struct rsnd_priv *priv)\r\n{\r\nstruct rsnd_dvc *dvc;\r\nint i;\r\nfor_each_rsnd_dvc(dvc, priv, i) {\r\nrsnd_mod_quit(rsnd_mod_get(dvc));\r\n}\r\n}

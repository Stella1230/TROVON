static int madc_read(struct iio_channel *channel)\r\n{\r\nint val, err;\r\nerr = iio_read_channel_processed(channel, &val);\r\nif (err < 0)\r\nreturn err;\r\nreturn val;\r\n}\r\nstatic int twl4030_madc_bat_get_charging_status(struct twl4030_madc_battery *bt)\r\n{\r\nreturn (madc_read(bt->channel_ichg) > 0) ? 1 : 0;\r\n}\r\nstatic int twl4030_madc_bat_get_voltage(struct twl4030_madc_battery *bt)\r\n{\r\nreturn madc_read(bt->channel_vbat);\r\n}\r\nstatic int twl4030_madc_bat_get_current(struct twl4030_madc_battery *bt)\r\n{\r\nreturn madc_read(bt->channel_ichg) * 1000;\r\n}\r\nstatic int twl4030_madc_bat_get_temp(struct twl4030_madc_battery *bt)\r\n{\r\nreturn madc_read(bt->channel_temp) * 10;\r\n}\r\nstatic int twl4030_madc_bat_voltscale(struct twl4030_madc_battery *bat,\r\nint volt)\r\n{\r\nstruct twl4030_madc_bat_calibration *calibration;\r\nint i, res = 0;\r\nif (twl4030_madc_bat_get_charging_status(bat))\r\ncalibration = bat->pdata->charging;\r\nelse\r\ncalibration = bat->pdata->discharging;\r\nif (volt > calibration[0].voltage) {\r\nres = calibration[0].level;\r\n} else {\r\nfor (i = 0; calibration[i+1].voltage >= 0; i++) {\r\nif (volt <= calibration[i].voltage &&\r\nvolt >= calibration[i+1].voltage) {\r\nres = calibration[i].level -\r\n((calibration[i].voltage - volt) *\r\n(calibration[i].level -\r\ncalibration[i+1].level)) /\r\n(calibration[i].voltage -\r\ncalibration[i+1].voltage);\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn res;\r\n}\r\nstatic int twl4030_madc_bat_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct twl4030_madc_battery *bat = power_supply_get_drvdata(psy);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nif (twl4030_madc_bat_voltscale(bat,\r\ntwl4030_madc_bat_get_voltage(bat)) > 95)\r\nval->intval = POWER_SUPPLY_STATUS_FULL;\r\nelse {\r\nif (twl4030_madc_bat_get_charging_status(bat))\r\nval->intval = POWER_SUPPLY_STATUS_CHARGING;\r\nelse\r\nval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\r\n}\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nval->intval = twl4030_madc_bat_get_voltage(bat) * 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_NOW:\r\nval->intval = twl4030_madc_bat_get_current(bat);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = 1;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_NOW: {\r\nint percent = twl4030_madc_bat_voltscale(bat,\r\ntwl4030_madc_bat_get_voltage(bat));\r\nval->intval = (percent * bat->pdata->capacity) / 100;\r\nbreak;\r\n}\r\ncase POWER_SUPPLY_PROP_CAPACITY:\r\nval->intval = twl4030_madc_bat_voltscale(bat,\r\ntwl4030_madc_bat_get_voltage(bat));\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_FULL:\r\nval->intval = bat->pdata->capacity;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP:\r\nval->intval = twl4030_madc_bat_get_temp(bat);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW: {\r\nint percent = twl4030_madc_bat_voltscale(bat,\r\ntwl4030_madc_bat_get_voltage(bat));\r\nint chg = (percent * (bat->pdata->capacity/1000))/100;\r\nval->intval = (3600l * chg) / 400;\r\nbreak;\r\n}\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void twl4030_madc_bat_ext_changed(struct power_supply *psy)\r\n{\r\npower_supply_changed(psy);\r\n}\r\nstatic int twl4030_cmp(const void *a, const void *b)\r\n{\r\nreturn ((struct twl4030_madc_bat_calibration *)b)->voltage -\r\n((struct twl4030_madc_bat_calibration *)a)->voltage;\r\n}\r\nstatic int twl4030_madc_battery_probe(struct platform_device *pdev)\r\n{\r\nstruct twl4030_madc_battery *twl4030_madc_bat;\r\nstruct twl4030_madc_bat_platform_data *pdata = pdev->dev.platform_data;\r\nstruct power_supply_config psy_cfg = {};\r\nint ret = 0;\r\ntwl4030_madc_bat = devm_kzalloc(&pdev->dev, sizeof(*twl4030_madc_bat),\r\nGFP_KERNEL);\r\nif (!twl4030_madc_bat)\r\nreturn -ENOMEM;\r\ntwl4030_madc_bat->channel_temp = iio_channel_get(&pdev->dev, "temp");\r\nif (IS_ERR(twl4030_madc_bat->channel_temp)) {\r\nret = PTR_ERR(twl4030_madc_bat->channel_temp);\r\ngoto err;\r\n}\r\ntwl4030_madc_bat->channel_ichg = iio_channel_get(&pdev->dev, "ichg");\r\nif (IS_ERR(twl4030_madc_bat->channel_ichg)) {\r\nret = PTR_ERR(twl4030_madc_bat->channel_ichg);\r\ngoto err_temp;\r\n}\r\ntwl4030_madc_bat->channel_vbat = iio_channel_get(&pdev->dev, "vbat");\r\nif (IS_ERR(twl4030_madc_bat->channel_vbat)) {\r\nret = PTR_ERR(twl4030_madc_bat->channel_vbat);\r\ngoto err_ichg;\r\n}\r\nsort(pdata->charging, pdata->charging_size,\r\nsizeof(struct twl4030_madc_bat_calibration),\r\ntwl4030_cmp, NULL);\r\nsort(pdata->discharging, pdata->discharging_size,\r\nsizeof(struct twl4030_madc_bat_calibration),\r\ntwl4030_cmp, NULL);\r\ntwl4030_madc_bat->pdata = pdata;\r\nplatform_set_drvdata(pdev, twl4030_madc_bat);\r\npsy_cfg.drv_data = twl4030_madc_bat;\r\ntwl4030_madc_bat->psy = power_supply_register(&pdev->dev,\r\n&twl4030_madc_bat_desc,\r\n&psy_cfg);\r\nif (IS_ERR(twl4030_madc_bat->psy)) {\r\nret = PTR_ERR(twl4030_madc_bat->psy);\r\ngoto err_vbat;\r\n}\r\nreturn 0;\r\nerr_vbat:\r\niio_channel_release(twl4030_madc_bat->channel_vbat);\r\nerr_ichg:\r\niio_channel_release(twl4030_madc_bat->channel_ichg);\r\nerr_temp:\r\niio_channel_release(twl4030_madc_bat->channel_temp);\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int twl4030_madc_battery_remove(struct platform_device *pdev)\r\n{\r\nstruct twl4030_madc_battery *bat = platform_get_drvdata(pdev);\r\npower_supply_unregister(bat->psy);\r\niio_channel_release(bat->channel_vbat);\r\niio_channel_release(bat->channel_ichg);\r\niio_channel_release(bat->channel_temp);\r\nreturn 0;\r\n}

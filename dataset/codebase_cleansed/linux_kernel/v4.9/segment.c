static void build_segment_config(char *str, unsigned int cfg)\r\n{\r\nunsigned int am;\r\nstatic const char * const am_str[] = {\r\n"UK", "MK", "MSK", "MUSK", "MUSUK", "USK",\r\n"RSRVD", "UUSK"};\r\nam = (cfg & MIPS_SEGCFG_AM) >> MIPS_SEGCFG_AM_SHIFT;\r\nstr += sprintf(str, "%-5s", am_str[am]);\r\nif ((am == 0) || (am > 3) || (cfg & MIPS_SEGCFG_EU))\r\nstr += sprintf(str, " %03lx",\r\n((cfg & MIPS_SEGCFG_PA) >> MIPS_SEGCFG_PA_SHIFT));\r\nelse\r\nstr += sprintf(str, " UND");\r\nif ((am == 0) || (am > 3))\r\nstr += sprintf(str, " %01ld",\r\n((cfg & MIPS_SEGCFG_C) >> MIPS_SEGCFG_C_SHIFT));\r\nelse\r\nstr += sprintf(str, " U");\r\nstr += sprintf(str, " %01ld\n",\r\n((cfg & MIPS_SEGCFG_EU) >> MIPS_SEGCFG_EU_SHIFT));\r\n}\r\nstatic int show_segments(struct seq_file *m, void *v)\r\n{\r\nunsigned int segcfg;\r\nchar str[42];\r\nseq_puts(m, "Segment Virtual Size Access Mode Physical Caching EU\n");\r\nseq_puts(m, "------- ------- ---- ----------- -------- ------- --\n");\r\nsegcfg = read_c0_segctl0();\r\nbuild_segment_config(str, segcfg);\r\nseq_printf(m, " 0 e0000000 512M %s", str);\r\nsegcfg >>= 16;\r\nbuild_segment_config(str, segcfg);\r\nseq_printf(m, " 1 c0000000 512M %s", str);\r\nsegcfg = read_c0_segctl1();\r\nbuild_segment_config(str, segcfg);\r\nseq_printf(m, " 2 a0000000 512M %s", str);\r\nsegcfg >>= 16;\r\nbuild_segment_config(str, segcfg);\r\nseq_printf(m, " 3 80000000 512M %s", str);\r\nsegcfg = read_c0_segctl2();\r\nbuild_segment_config(str, segcfg);\r\nseq_printf(m, " 4 40000000 1G %s", str);\r\nsegcfg >>= 16;\r\nbuild_segment_config(str, segcfg);\r\nseq_printf(m, " 5 00000000 1G %s\n", str);\r\nreturn 0;\r\n}\r\nstatic int segments_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, show_segments, NULL);\r\n}\r\nstatic int __init segments_info(void)\r\n{\r\nstruct dentry *segments;\r\nif (cpu_has_segments) {\r\nif (!mips_debugfs_dir)\r\nreturn -ENODEV;\r\nsegments = debugfs_create_file("segments", S_IRUGO,\r\nmips_debugfs_dir, NULL,\r\n&segments_fops);\r\nif (!segments)\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}

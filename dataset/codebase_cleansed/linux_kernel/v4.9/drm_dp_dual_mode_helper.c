ssize_t drm_dp_dual_mode_read(struct i2c_adapter *adapter,\r\nu8 offset, void *buffer, size_t size)\r\n{\r\nstruct i2c_msg msgs[] = {\r\n{\r\n.addr = DP_DUAL_MODE_SLAVE_ADDRESS,\r\n.flags = 0,\r\n.len = 1,\r\n.buf = &offset,\r\n},\r\n{\r\n.addr = DP_DUAL_MODE_SLAVE_ADDRESS,\r\n.flags = I2C_M_RD,\r\n.len = size,\r\n.buf = buffer,\r\n},\r\n};\r\nint ret;\r\nret = i2c_transfer(adapter, msgs, ARRAY_SIZE(msgs));\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret != ARRAY_SIZE(msgs))\r\nreturn -EPROTO;\r\nreturn 0;\r\n}\r\nssize_t drm_dp_dual_mode_write(struct i2c_adapter *adapter,\r\nu8 offset, const void *buffer, size_t size)\r\n{\r\nstruct i2c_msg msg = {\r\n.addr = DP_DUAL_MODE_SLAVE_ADDRESS,\r\n.flags = 0,\r\n.len = 1 + size,\r\n.buf = NULL,\r\n};\r\nvoid *data;\r\nint ret;\r\ndata = kmalloc(msg.len, GFP_TEMPORARY);\r\nif (!data)\r\nreturn -ENOMEM;\r\nmsg.buf = data;\r\nmemcpy(data, &offset, 1);\r\nmemcpy(data + 1, buffer, size);\r\nret = i2c_transfer(adapter, &msg, 1);\r\nkfree(data);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret != 1)\r\nreturn -EPROTO;\r\nreturn 0;\r\n}\r\nstatic bool is_hdmi_adaptor(const char hdmi_id[DP_DUAL_MODE_HDMI_ID_LEN])\r\n{\r\nstatic const char dp_dual_mode_hdmi_id[DP_DUAL_MODE_HDMI_ID_LEN] =\r\n"DP-HDMI ADAPTOR\x04";\r\nreturn memcmp(hdmi_id, dp_dual_mode_hdmi_id,\r\nsizeof(dp_dual_mode_hdmi_id)) == 0;\r\n}\r\nstatic bool is_type2_adaptor(uint8_t adaptor_id)\r\n{\r\nreturn adaptor_id == (DP_DUAL_MODE_TYPE_TYPE2 |\r\nDP_DUAL_MODE_REV_TYPE2);\r\n}\r\nenum drm_dp_dual_mode_type drm_dp_dual_mode_detect(struct i2c_adapter *adapter)\r\n{\r\nchar hdmi_id[DP_DUAL_MODE_HDMI_ID_LEN] = {};\r\nuint8_t adaptor_id = 0x00;\r\nssize_t ret;\r\nret = drm_dp_dual_mode_read(adapter, DP_DUAL_MODE_HDMI_ID,\r\nhdmi_id, sizeof(hdmi_id));\r\nif (ret)\r\nreturn DRM_DP_DUAL_MODE_UNKNOWN;\r\nret = drm_dp_dual_mode_read(adapter, DP_DUAL_MODE_ADAPTOR_ID,\r\n&adaptor_id, sizeof(adaptor_id));\r\nif (ret == 0) {\r\nif (is_type2_adaptor(adaptor_id)) {\r\nif (is_hdmi_adaptor(hdmi_id))\r\nreturn DRM_DP_DUAL_MODE_TYPE2_HDMI;\r\nelse\r\nreturn DRM_DP_DUAL_MODE_TYPE2_DVI;\r\n}\r\n}\r\nif (is_hdmi_adaptor(hdmi_id))\r\nreturn DRM_DP_DUAL_MODE_TYPE1_HDMI;\r\nelse\r\nreturn DRM_DP_DUAL_MODE_TYPE1_DVI;\r\n}\r\nint drm_dp_dual_mode_max_tmds_clock(enum drm_dp_dual_mode_type type,\r\nstruct i2c_adapter *adapter)\r\n{\r\nuint8_t max_tmds_clock;\r\nssize_t ret;\r\nif (type == DRM_DP_DUAL_MODE_NONE)\r\nreturn 0;\r\nif (type < DRM_DP_DUAL_MODE_TYPE2_DVI)\r\nreturn 165000;\r\nret = drm_dp_dual_mode_read(adapter, DP_DUAL_MODE_MAX_TMDS_CLOCK,\r\n&max_tmds_clock, sizeof(max_tmds_clock));\r\nif (ret || max_tmds_clock == 0x00 || max_tmds_clock == 0xff) {\r\nDRM_DEBUG_KMS("Failed to query max TMDS clock\n");\r\nreturn 165000;\r\n}\r\nreturn max_tmds_clock * 5000 / 2;\r\n}\r\nint drm_dp_dual_mode_get_tmds_output(enum drm_dp_dual_mode_type type,\r\nstruct i2c_adapter *adapter,\r\nbool *enabled)\r\n{\r\nuint8_t tmds_oen;\r\nssize_t ret;\r\nif (type < DRM_DP_DUAL_MODE_TYPE2_DVI) {\r\n*enabled = true;\r\nreturn 0;\r\n}\r\nret = drm_dp_dual_mode_read(adapter, DP_DUAL_MODE_TMDS_OEN,\r\n&tmds_oen, sizeof(tmds_oen));\r\nif (ret) {\r\nDRM_DEBUG_KMS("Failed to query state of TMDS output buffers\n");\r\nreturn ret;\r\n}\r\n*enabled = !(tmds_oen & DP_DUAL_MODE_TMDS_DISABLE);\r\nreturn 0;\r\n}\r\nint drm_dp_dual_mode_set_tmds_output(enum drm_dp_dual_mode_type type,\r\nstruct i2c_adapter *adapter, bool enable)\r\n{\r\nuint8_t tmds_oen = enable ? 0 : DP_DUAL_MODE_TMDS_DISABLE;\r\nssize_t ret;\r\nif (type < DRM_DP_DUAL_MODE_TYPE2_DVI)\r\nreturn 0;\r\nret = drm_dp_dual_mode_write(adapter, DP_DUAL_MODE_TMDS_OEN,\r\n&tmds_oen, sizeof(tmds_oen));\r\nif (ret) {\r\nDRM_DEBUG_KMS("Failed to %s TMDS output buffers\n",\r\nenable ? "enable" : "disable");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nconst char *drm_dp_get_dual_mode_type_name(enum drm_dp_dual_mode_type type)\r\n{\r\nswitch (type) {\r\ncase DRM_DP_DUAL_MODE_NONE:\r\nreturn "none";\r\ncase DRM_DP_DUAL_MODE_TYPE1_DVI:\r\nreturn "type 1 DVI";\r\ncase DRM_DP_DUAL_MODE_TYPE1_HDMI:\r\nreturn "type 1 HDMI";\r\ncase DRM_DP_DUAL_MODE_TYPE2_DVI:\r\nreturn "type 2 DVI";\r\ncase DRM_DP_DUAL_MODE_TYPE2_HDMI:\r\nreturn "type 2 HDMI";\r\ndefault:\r\nWARN_ON(type != DRM_DP_DUAL_MODE_UNKNOWN);\r\nreturn "unknown";\r\n}\r\n}

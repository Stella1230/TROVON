int ds1287_timer_state(void)\r\n{\r\nreturn (CMOS_READ(RTC_REG_C) & RTC_PF) != 0;\r\n}\r\nint ds1287_set_base_clock(unsigned int hz)\r\n{\r\nu8 rate;\r\nswitch (hz) {\r\ncase 128:\r\nrate = 0x9;\r\nbreak;\r\ncase 256:\r\nrate = 0x8;\r\nbreak;\r\ncase 1024:\r\nrate = 0x6;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nCMOS_WRITE(RTC_REF_CLCK_32KHZ | rate, RTC_REG_A);\r\nreturn 0;\r\n}\r\nstatic int ds1287_set_next_event(unsigned long delta,\r\nstruct clock_event_device *evt)\r\n{\r\nreturn -EINVAL;\r\n}\r\nstatic int ds1287_shutdown(struct clock_event_device *evt)\r\n{\r\nu8 val;\r\nspin_lock(&rtc_lock);\r\nval = CMOS_READ(RTC_REG_B);\r\nval &= ~RTC_PIE;\r\nCMOS_WRITE(val, RTC_REG_B);\r\nspin_unlock(&rtc_lock);\r\nreturn 0;\r\n}\r\nstatic int ds1287_set_periodic(struct clock_event_device *evt)\r\n{\r\nu8 val;\r\nspin_lock(&rtc_lock);\r\nval = CMOS_READ(RTC_REG_B);\r\nval |= RTC_PIE;\r\nCMOS_WRITE(val, RTC_REG_B);\r\nspin_unlock(&rtc_lock);\r\nreturn 0;\r\n}\r\nstatic void ds1287_event_handler(struct clock_event_device *dev)\r\n{\r\n}\r\nstatic irqreturn_t ds1287_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *cd = &ds1287_clockevent;\r\nCMOS_READ(RTC_REG_C);\r\ncd->event_handler(cd);\r\nreturn IRQ_HANDLED;\r\n}\r\nint __init ds1287_clockevent_init(int irq)\r\n{\r\nstruct clock_event_device *cd;\r\ncd = &ds1287_clockevent;\r\ncd->rating = 100;\r\ncd->irq = irq;\r\nclockevent_set_clock(cd, 32768);\r\ncd->max_delta_ns = clockevent_delta2ns(0x7fffffff, cd);\r\ncd->min_delta_ns = clockevent_delta2ns(0x300, cd);\r\ncd->cpumask = cpumask_of(0);\r\nclockevents_register_device(&ds1287_clockevent);\r\nreturn setup_irq(irq, &ds1287_irqaction);\r\n}

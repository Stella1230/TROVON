int prefixcmp(const char *str, const char *prefix)\r\n{\r\nfor (; ; str++, prefix++)\r\nif (!*prefix)\r\nreturn 0;\r\nelse if (*str != *prefix)\r\nreturn (unsigned char)*prefix - (unsigned char)*str;\r\n}\r\nint strbuf_init(struct strbuf *sb, ssize_t hint)\r\n{\r\nsb->alloc = sb->len = 0;\r\nsb->buf = strbuf_slopbuf;\r\nif (hint)\r\nreturn strbuf_grow(sb, hint);\r\nreturn 0;\r\n}\r\nvoid strbuf_release(struct strbuf *sb)\r\n{\r\nif (sb->alloc) {\r\nzfree(&sb->buf);\r\nstrbuf_init(sb, 0);\r\n}\r\n}\r\nchar *strbuf_detach(struct strbuf *sb, size_t *sz)\r\n{\r\nchar *res = sb->alloc ? sb->buf : NULL;\r\nif (sz)\r\n*sz = sb->len;\r\nstrbuf_init(sb, 0);\r\nreturn res;\r\n}\r\nint strbuf_grow(struct strbuf *sb, size_t extra)\r\n{\r\nchar *buf;\r\nsize_t nr = sb->len + extra + 1;\r\nif (nr < sb->alloc)\r\nreturn 0;\r\nif (nr <= sb->len)\r\nreturn -E2BIG;\r\nif (alloc_nr(sb->alloc) > nr)\r\nnr = alloc_nr(sb->alloc);\r\nbuf = realloc(sb->alloc ? sb->buf : NULL, nr * sizeof(*buf));\r\nif (!buf)\r\nreturn -ENOMEM;\r\nsb->buf = buf;\r\nsb->alloc = nr;\r\nreturn 0;\r\n}\r\nint strbuf_addch(struct strbuf *sb, int c)\r\n{\r\nint ret = strbuf_grow(sb, 1);\r\nif (ret)\r\nreturn ret;\r\nsb->buf[sb->len++] = c;\r\nsb->buf[sb->len] = '\0';\r\nreturn 0;\r\n}\r\nint strbuf_add(struct strbuf *sb, const void *data, size_t len)\r\n{\r\nint ret = strbuf_grow(sb, len);\r\nif (ret)\r\nreturn ret;\r\nmemcpy(sb->buf + sb->len, data, len);\r\nreturn strbuf_setlen(sb, sb->len + len);\r\n}\r\nstatic int strbuf_addv(struct strbuf *sb, const char *fmt, va_list ap)\r\n{\r\nint len, ret;\r\nva_list ap_saved;\r\nif (!strbuf_avail(sb)) {\r\nret = strbuf_grow(sb, 64);\r\nif (ret)\r\nreturn ret;\r\n}\r\nva_copy(ap_saved, ap);\r\nlen = vsnprintf(sb->buf + sb->len, sb->alloc - sb->len, fmt, ap);\r\nif (len < 0)\r\nreturn len;\r\nif (len > strbuf_avail(sb)) {\r\nret = strbuf_grow(sb, len);\r\nif (ret)\r\nreturn ret;\r\nlen = vsnprintf(sb->buf + sb->len, sb->alloc - sb->len, fmt, ap_saved);\r\nva_end(ap_saved);\r\nif (len > strbuf_avail(sb)) {\r\npr_debug("this should not happen, your vsnprintf is broken");\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn strbuf_setlen(sb, sb->len + len);\r\n}\r\nint strbuf_addf(struct strbuf *sb, const char *fmt, ...)\r\n{\r\nva_list ap;\r\nint ret;\r\nva_start(ap, fmt);\r\nret = strbuf_addv(sb, fmt, ap);\r\nva_end(ap);\r\nreturn ret;\r\n}\r\nssize_t strbuf_read(struct strbuf *sb, int fd, ssize_t hint)\r\n{\r\nsize_t oldlen = sb->len;\r\nsize_t oldalloc = sb->alloc;\r\nint ret;\r\nret = strbuf_grow(sb, hint ? hint : 8192);\r\nif (ret)\r\nreturn ret;\r\nfor (;;) {\r\nssize_t cnt;\r\ncnt = read(fd, sb->buf + sb->len, sb->alloc - sb->len - 1);\r\nif (cnt < 0) {\r\nif (oldalloc == 0)\r\nstrbuf_release(sb);\r\nelse\r\nstrbuf_setlen(sb, oldlen);\r\nreturn cnt;\r\n}\r\nif (!cnt)\r\nbreak;\r\nsb->len += cnt;\r\nret = strbuf_grow(sb, 8192);\r\nif (ret)\r\nreturn ret;\r\n}\r\nsb->buf[sb->len] = '\0';\r\nreturn sb->len - oldlen;\r\n}

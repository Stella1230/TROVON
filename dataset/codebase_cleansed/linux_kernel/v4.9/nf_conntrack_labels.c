static int replace_u32(u32 *address, u32 mask, u32 new)\r\n{\r\nu32 old, tmp;\r\ndo {\r\nold = *address;\r\ntmp = (old & mask) ^ new;\r\nif (old == tmp)\r\nreturn 0;\r\n} while (cmpxchg(address, old, tmp) != old);\r\nreturn 1;\r\n}\r\nint nf_connlabels_replace(struct nf_conn *ct,\r\nconst u32 *data,\r\nconst u32 *mask, unsigned int words32)\r\n{\r\nstruct nf_conn_labels *labels;\r\nunsigned int size, i;\r\nint changed = 0;\r\nu32 *dst;\r\nlabels = nf_ct_labels_find(ct);\r\nif (!labels)\r\nreturn -ENOSPC;\r\nsize = sizeof(labels->bits);\r\nif (size < (words32 * sizeof(u32)))\r\nwords32 = size / sizeof(u32);\r\ndst = (u32 *) labels->bits;\r\nfor (i = 0; i < words32; i++)\r\nchanged |= replace_u32(&dst[i], mask ? ~mask[i] : 0, data[i]);\r\nsize /= sizeof(u32);\r\nfor (i = words32; i < size; i++)\r\nreplace_u32(&dst[i], 0, 0);\r\nif (changed)\r\nnf_conntrack_event_cache(IPCT_LABEL, ct);\r\nreturn 0;\r\n}\r\nint nf_connlabels_get(struct net *net, unsigned int bits)\r\n{\r\nif (BIT_WORD(bits) >= NF_CT_LABELS_MAX_SIZE / sizeof(long))\r\nreturn -ERANGE;\r\nspin_lock(&nf_connlabels_lock);\r\nnet->ct.labels_used++;\r\nspin_unlock(&nf_connlabels_lock);\r\nreturn 0;\r\n}\r\nvoid nf_connlabels_put(struct net *net)\r\n{\r\nspin_lock(&nf_connlabels_lock);\r\nnet->ct.labels_used--;\r\nspin_unlock(&nf_connlabels_lock);\r\n}\r\nint nf_conntrack_labels_init(void)\r\n{\r\nBUILD_BUG_ON(NF_CT_LABELS_MAX_SIZE / sizeof(long) >= U8_MAX);\r\nspin_lock_init(&nf_connlabels_lock);\r\nreturn nf_ct_extend_register(&labels_extend);\r\n}\r\nvoid nf_conntrack_labels_fini(void)\r\n{\r\nnf_ct_extend_unregister(&labels_extend);\r\n}

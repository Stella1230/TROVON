static inline void blast_r5000_scache(void)\r\n{\r\nunsigned long start = INDEX_BASE;\r\nunsigned long end = start + scache_size;\r\nwhile(start < end) {\r\ncache_op(R5K_Page_Invalidate_S, start);\r\nstart += SC_PAGE;\r\n}\r\n}\r\nstatic void r5k_dma_cache_inv_sc(unsigned long addr, unsigned long size)\r\n{\r\nunsigned long end, a;\r\nBUG_ON(size == 0);\r\nif (size >= scache_size) {\r\nblast_r5000_scache();\r\nreturn;\r\n}\r\na = addr & ~(SC_PAGE - 1);\r\nend = (addr + size - 1) & ~(SC_PAGE - 1);\r\nwhile (a <= end) {\r\ncache_op(R5K_Page_Invalidate_S, a);\r\na += SC_PAGE;\r\n}\r\n}\r\nstatic void r5k_sc_enable(void)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nset_c0_config(R5K_CONF_SE);\r\nblast_r5000_scache();\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void r5k_sc_disable(void)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nblast_r5000_scache();\r\nclear_c0_config(R5K_CONF_SE);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic inline int __init r5k_sc_probe(void)\r\n{\r\nunsigned long config = read_c0_config();\r\nif (config & CONF_SC)\r\nreturn 0;\r\nscache_size = (512 * 1024) << ((config & R5K_CONF_SS) >> 20);\r\nprintk("R5000 SCACHE size %ldkB, linesize 32 bytes.\n",\r\nscache_size >> 10);\r\nreturn 1;\r\n}\r\nvoid r5k_sc_init(void)\r\n{\r\nif (r5k_sc_probe()) {\r\nr5k_sc_enable();\r\nbcops = &r5k_sc_ops;\r\n}\r\n}

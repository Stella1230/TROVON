static void __init bert_print_all(struct acpi_bert_region *region,\r\nunsigned int region_len)\r\n{\r\nstruct acpi_hest_generic_status *estatus =\r\n(struct acpi_hest_generic_status *)region;\r\nint remain = region_len;\r\nu32 estatus_len;\r\nif (!estatus->block_status)\r\nreturn;\r\nwhile (remain > sizeof(struct acpi_bert_region)) {\r\nif (cper_estatus_check(estatus)) {\r\npr_err(FW_BUG "Invalid error record.\n");\r\nreturn;\r\n}\r\nestatus_len = cper_estatus_len(estatus);\r\nif (remain < estatus_len) {\r\npr_err(FW_BUG "Truncated status block (length: %u).\n",\r\nestatus_len);\r\nreturn;\r\n}\r\npr_info_once("Error records from previous boot:\n");\r\ncper_estatus_print(KERN_INFO HW_ERR, estatus);\r\nestatus->block_status = 0;\r\nestatus = (void *)estatus + estatus_len;\r\nif (!estatus->block_status)\r\nreturn;\r\nremain -= estatus_len;\r\n}\r\n}\r\nstatic int __init setup_bert_disable(char *str)\r\n{\r\nbert_disable = 1;\r\nreturn 0;\r\n}\r\nstatic int __init bert_check_table(struct acpi_table_bert *bert_tab)\r\n{\r\nif (bert_tab->header.length < sizeof(struct acpi_table_bert) ||\r\nbert_tab->region_length < sizeof(struct acpi_bert_region))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int __init bert_init(void)\r\n{\r\nstruct acpi_bert_region *boot_error_region;\r\nstruct acpi_table_bert *bert_tab;\r\nunsigned int region_len;\r\nacpi_status status;\r\nint rc = 0;\r\nif (acpi_disabled)\r\nreturn 0;\r\nif (bert_disable) {\r\npr_info("Boot Error Record Table support is disabled.\n");\r\nreturn 0;\r\n}\r\nstatus = acpi_get_table(ACPI_SIG_BERT, 0, (struct acpi_table_header **)&bert_tab);\r\nif (status == AE_NOT_FOUND)\r\nreturn 0;\r\nif (ACPI_FAILURE(status)) {\r\npr_err("get table failed, %s.\n", acpi_format_exception(status));\r\nreturn -EINVAL;\r\n}\r\nrc = bert_check_table(bert_tab);\r\nif (rc) {\r\npr_err(FW_BUG "table invalid.\n");\r\nreturn rc;\r\n}\r\nregion_len = bert_tab->region_length;\r\nif (!request_mem_region(bert_tab->address, region_len, "APEI BERT")) {\r\npr_err("Can't request iomem region <%016llx-%016llx>.\n",\r\n(unsigned long long)bert_tab->address,\r\n(unsigned long long)bert_tab->address + region_len - 1);\r\nreturn -EIO;\r\n}\r\nboot_error_region = ioremap_cache(bert_tab->address, region_len);\r\nif (boot_error_region) {\r\nbert_print_all(boot_error_region, region_len);\r\niounmap(boot_error_region);\r\n} else {\r\nrc = -ENOMEM;\r\n}\r\nrelease_mem_region(bert_tab->address, region_len);\r\nreturn rc;\r\n}

asmlinkage int __kprobes\r\nhandle_tlbmiss(struct pt_regs *regs, unsigned long error_code,\r\nunsigned long address)\r\n{\r\npgd_t *pgd;\r\npud_t *pud;\r\npmd_t *pmd;\r\npte_t *pte;\r\npte_t entry;\r\nif (address >= P3SEG && address < P3_ADDR_MAX) {\r\npgd = pgd_offset_k(address);\r\n} else {\r\nif (unlikely(address >= TASK_SIZE || !current->mm))\r\nreturn 1;\r\npgd = pgd_offset(current->mm, address);\r\n}\r\npud = pud_offset(pgd, address);\r\nif (pud_none_or_clear_bad(pud))\r\nreturn 1;\r\npmd = pmd_offset(pud, address);\r\nif (pmd_none_or_clear_bad(pmd))\r\nreturn 1;\r\npte = pte_offset_kernel(pmd, address);\r\nentry = *pte;\r\nif (unlikely(pte_none(entry) || pte_not_present(entry)))\r\nreturn 1;\r\nif (unlikely(error_code && !pte_write(entry)))\r\nreturn 1;\r\nif (error_code)\r\nentry = pte_mkdirty(entry);\r\nentry = pte_mkyoung(entry);\r\nset_pte(pte, entry);\r\n#if defined(CONFIG_CPU_SH4) && !defined(CONFIG_SMP)\r\nif (error_code == FAULT_CODE_INITIAL)\r\nlocal_flush_tlb_one(get_asid(), address & PAGE_MASK);\r\n#endif\r\nset_thread_fault_code(error_code);\r\nupdate_mmu_cache(NULL, address, pte);\r\nreturn 0;\r\n}

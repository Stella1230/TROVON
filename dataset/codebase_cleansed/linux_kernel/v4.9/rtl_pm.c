int rtl92e_suspend(struct pci_dev *pdev, pm_message_t state)\r\n{\r\nstruct net_device *dev = pci_get_drvdata(pdev);\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nu32 ulRegRead;\r\nnetdev_info(dev, "============> r8192E suspend call.\n");\r\ndel_timer_sync(&priv->gpio_polling_timer);\r\ncancel_delayed_work_sync(&priv->gpio_change_rf_wq);\r\npriv->polling_timer_on = 0;\r\nif (!netif_running(dev)) {\r\nnetdev_info(dev,\r\n"RTL819XE:UI is open out of suspend function\n");\r\ngoto out_pci_suspend;\r\n}\r\nif (dev->netdev_ops->ndo_stop)\r\ndev->netdev_ops->ndo_stop(dev);\r\nnetif_device_detach(dev);\r\nif (!priv->rtllib->bSupportRemoteWakeUp) {\r\nrtl92e_set_rf_state(dev, eRfOff, RF_CHANGE_BY_INIT);\r\nulRegRead = rtl92e_readl(dev, CPU_GEN);\r\nulRegRead |= CPU_GEN_SYSTEM_RESET;\r\nrtl92e_writel(dev, CPU_GEN, ulRegRead);\r\n} else {\r\nrtl92e_writel(dev, WFCRC0, 0xffffffff);\r\nrtl92e_writel(dev, WFCRC1, 0xffffffff);\r\nrtl92e_writel(dev, WFCRC2, 0xffffffff);\r\nrtl92e_writeb(dev, PMR, 0x5);\r\nrtl92e_writeb(dev, MacBlkCtrl, 0xa);\r\n}\r\nout_pci_suspend:\r\nnetdev_info(dev, "WOL is %s\n", priv->rtllib->bSupportRemoteWakeUp ?\r\n"Supported" : "Not supported");\r\npci_save_state(pdev);\r\npci_disable_device(pdev);\r\npci_enable_wake(pdev, pci_choose_state(pdev, state),\r\npriv->rtllib->bSupportRemoteWakeUp ? 1 : 0);\r\npci_set_power_state(pdev, pci_choose_state(pdev, state));\r\nmdelay(20);\r\nreturn 0;\r\n}\r\nint rtl92e_resume(struct pci_dev *pdev)\r\n{\r\nstruct net_device *dev = pci_get_drvdata(pdev);\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nint err;\r\nu32 val;\r\nnetdev_info(dev, "================>r8192E resume call.\n");\r\npci_set_power_state(pdev, PCI_D0);\r\nerr = pci_enable_device(pdev);\r\nif (err) {\r\nnetdev_err(dev, "pci_enable_device failed on resume\n");\r\nreturn err;\r\n}\r\npci_restore_state(pdev);\r\npci_read_config_dword(pdev, 0x40, &val);\r\nif ((val & 0x0000ff00) != 0)\r\npci_write_config_dword(pdev, 0x40, val & 0xffff00ff);\r\npci_enable_wake(pdev, PCI_D0, 0);\r\nif (priv->polling_timer_on == 0)\r\nrtl92e_check_rfctrl_gpio_timer((unsigned long)dev);\r\nif (!netif_running(dev)) {\r\nnetdev_info(dev,\r\n"RTL819XE:UI is open out of resume function\n");\r\ngoto out;\r\n}\r\nnetif_device_attach(dev);\r\nif (dev->netdev_ops->ndo_open)\r\ndev->netdev_ops->ndo_open(dev);\r\nif (!priv->rtllib->bSupportRemoteWakeUp)\r\nrtl92e_set_rf_state(dev, eRfOn, RF_CHANGE_BY_INIT);\r\nout:\r\nRT_TRACE(COMP_POWER, "<================r8192E resume call.\n");\r\nreturn 0;\r\n}

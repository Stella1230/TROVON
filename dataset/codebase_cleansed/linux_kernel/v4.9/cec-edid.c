static unsigned int cec_get_edid_spa_location(const u8 *edid, unsigned int size)\r\n{\r\nunsigned int blocks = size / 128;\r\nunsigned int block;\r\nu8 d;\r\nif (blocks < 2 || size % 128)\r\nreturn 0;\r\nif (edid[0x7e] + 1 < blocks)\r\nblocks = edid[0x7e] + 1;\r\nfor (block = 1; block < blocks; block++) {\r\nunsigned int offset = block * 128;\r\nif (edid[offset] != 0x02 || edid[offset + 1] != 0x03)\r\ncontinue;\r\nd = edid[offset + 2] & 0x7f;\r\nif (d <= 4)\r\ncontinue;\r\nif (d > 4) {\r\nunsigned int i = offset + 4;\r\nunsigned int end = offset + d;\r\ndo {\r\nu8 tag = edid[i] >> 5;\r\nu8 len = edid[i] & 0x1f;\r\nif (tag == 3 && len >= 5 && i + len <= end &&\r\nedid[i + 1] == 0x03 &&\r\nedid[i + 2] == 0x0c &&\r\nedid[i + 3] == 0x00)\r\nreturn i + 4;\r\ni += len + 1;\r\n} while (i < end);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nu16 cec_get_edid_phys_addr(const u8 *edid, unsigned int size,\r\nunsigned int *offset)\r\n{\r\nunsigned int loc = cec_get_edid_spa_location(edid, size);\r\nif (offset)\r\n*offset = loc;\r\nif (loc == 0)\r\nreturn CEC_PHYS_ADDR_INVALID;\r\nreturn (edid[loc] << 8) | edid[loc + 1];\r\n}\r\nvoid cec_set_edid_phys_addr(u8 *edid, unsigned int size, u16 phys_addr)\r\n{\r\nunsigned int loc = cec_get_edid_spa_location(edid, size);\r\nu8 sum = 0;\r\nunsigned int i;\r\nif (loc == 0)\r\nreturn;\r\nedid[loc] = phys_addr >> 8;\r\nedid[loc + 1] = phys_addr & 0xff;\r\nloc &= ~0x7f;\r\nfor (i = loc; i < loc + 127; i++)\r\nsum += edid[i];\r\nedid[i] = 256 - sum;\r\n}\r\nu16 cec_phys_addr_for_input(u16 phys_addr, u8 input)\r\n{\r\nif (WARN_ON(input == 0 || input > 0xf))\r\nreturn CEC_PHYS_ADDR_INVALID;\r\nif (phys_addr == 0)\r\nreturn input << 12;\r\nif ((phys_addr & 0x0fff) == 0)\r\nreturn phys_addr | (input << 8);\r\nif ((phys_addr & 0x00ff) == 0)\r\nreturn phys_addr | (input << 4);\r\nif ((phys_addr & 0x000f) == 0)\r\nreturn phys_addr | input;\r\nreturn CEC_PHYS_ADDR_INVALID;\r\n}\r\nint cec_phys_addr_validate(u16 phys_addr, u16 *parent, u16 *port)\r\n{\r\nint i;\r\nif (parent)\r\n*parent = phys_addr;\r\nif (port)\r\n*port = 0;\r\nif (phys_addr == CEC_PHYS_ADDR_INVALID)\r\nreturn 0;\r\nfor (i = 0; i < 16; i += 4)\r\nif (phys_addr & (0xf << i))\r\nbreak;\r\nif (i == 16)\r\nreturn 0;\r\nif (parent)\r\n*parent = phys_addr & (0xfff0 << i);\r\nif (port)\r\n*port = (phys_addr >> i) & 0xf;\r\nfor (i += 4; i < 16; i += 4)\r\nif ((phys_addr & (0xf << i)) == 0)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}

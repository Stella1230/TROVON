static int rsnd_ssiu_init(struct rsnd_mod *mod,\r\nstruct rsnd_dai_stream *io,\r\nstruct rsnd_priv *priv)\r\n{\r\nstruct rsnd_dai *rdai = rsnd_io_to_rdai(io);\r\nu32 multi_ssi_slaves = rsnd_ssi_multi_slaves_runtime(io);\r\nint use_busif = rsnd_ssi_use_busif(io);\r\nint id = rsnd_mod_id(mod);\r\nu32 mask1, val1;\r\nu32 mask2, val2;\r\nrsnd_mod_bset(mod, SSI_MODE0, (1 << id), !use_busif << id);\r\nmask1 = (1 << 4) | (1 << 20);\r\nmask2 = (1 << 4);\r\nval1 = val2 = 0;\r\nif (rsnd_ssi_is_pin_sharing(io)) {\r\nint shift = -1;\r\nswitch (id) {\r\ncase 1:\r\nshift = 0;\r\nbreak;\r\ncase 2:\r\nshift = 2;\r\nbreak;\r\ncase 4:\r\nshift = 16;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nmask1 |= 0x3 << shift;\r\nval1 = rsnd_rdai_is_clk_master(rdai) ?\r\n0x2 << shift : 0x1 << shift;\r\n} else if (multi_ssi_slaves) {\r\nmask2 |= 0x00000007;\r\nmask1 |= 0x0000000f;\r\nswitch (multi_ssi_slaves) {\r\ncase 0x0206:\r\nval2 = (1 << 4) |\r\n(rsnd_rdai_is_clk_master(rdai) ? 0x2 : 0x1);\r\ncase 0x0006:\r\nval1 = rsnd_rdai_is_clk_master(rdai) ?\r\n0xa : 0x5;\r\nif (!val2)\r\nval1 |= (1 << 4);\r\n}\r\n}\r\nrsnd_mod_bset(mod, SSI_MODE1, mask1, val1);\r\nrsnd_mod_bset(mod, SSI_MODE2, mask2, val2);\r\nreturn 0;\r\n}\r\nstatic int rsnd_ssiu_init_gen2(struct rsnd_mod *mod,\r\nstruct rsnd_dai_stream *io,\r\nstruct rsnd_priv *priv)\r\n{\r\nint ret;\r\nret = rsnd_ssiu_init(mod, io, priv);\r\nif (ret < 0)\r\nreturn ret;\r\nif (rsnd_runtime_is_ssi_tdm(io)) {\r\nrsnd_mod_write(mod, SSI_MODE, 0x1);\r\n}\r\nif (rsnd_ssi_use_busif(io)) {\r\nrsnd_mod_write(mod, SSI_BUSIF_ADINR,\r\nrsnd_get_adinr_bit(mod, io) |\r\n(rsnd_io_is_play(io) ?\r\nrsnd_runtime_channel_after_ctu(io) :\r\nrsnd_runtime_channel_original(io)));\r\nrsnd_mod_write(mod, SSI_BUSIF_MODE, 1);\r\nrsnd_mod_write(mod, SSI_BUSIF_DALIGN,\r\nrsnd_get_dalign(mod, io));\r\n}\r\nreturn 0;\r\n}\r\nstatic int rsnd_ssiu_start_gen2(struct rsnd_mod *mod,\r\nstruct rsnd_dai_stream *io,\r\nstruct rsnd_priv *priv)\r\n{\r\nif (!rsnd_ssi_use_busif(io))\r\nreturn 0;\r\nrsnd_mod_write(mod, SSI_CTRL, 0x1);\r\nif (rsnd_ssi_multi_slaves_runtime(io))\r\nrsnd_mod_write(mod, SSI_CONTROL, 0x1);\r\nreturn 0;\r\n}\r\nstatic int rsnd_ssiu_stop_gen2(struct rsnd_mod *mod,\r\nstruct rsnd_dai_stream *io,\r\nstruct rsnd_priv *priv)\r\n{\r\nif (!rsnd_ssi_use_busif(io))\r\nreturn 0;\r\nrsnd_mod_write(mod, SSI_CTRL, 0);\r\nif (rsnd_ssi_multi_slaves_runtime(io))\r\nrsnd_mod_write(mod, SSI_CONTROL, 0);\r\nreturn 0;\r\n}\r\nstatic struct rsnd_mod *rsnd_ssiu_mod_get(struct rsnd_priv *priv, int id)\r\n{\r\nif (WARN_ON(id < 0 || id >= rsnd_ssiu_nr(priv)))\r\nid = 0;\r\nreturn rsnd_mod_get((struct rsnd_ssiu *)(priv->ssiu) + id);\r\n}\r\nint rsnd_ssiu_attach(struct rsnd_dai_stream *io,\r\nstruct rsnd_mod *ssi_mod)\r\n{\r\nstruct rsnd_priv *priv = rsnd_io_to_priv(io);\r\nstruct rsnd_mod *mod = rsnd_ssiu_mod_get(priv, rsnd_mod_id(ssi_mod));\r\nrsnd_mod_confirm_ssi(ssi_mod);\r\nreturn rsnd_dai_connect(mod, io, mod->type);\r\n}\r\nint rsnd_ssiu_probe(struct rsnd_priv *priv)\r\n{\r\nstruct device *dev = rsnd_priv_to_dev(priv);\r\nstruct rsnd_ssiu *ssiu;\r\nstatic struct rsnd_mod_ops *ops;\r\nint i, nr, ret;\r\nnr = priv->ssi_nr;\r\nssiu = devm_kzalloc(dev, sizeof(*ssiu) * nr, GFP_KERNEL);\r\nif (!ssiu)\r\nreturn -ENOMEM;\r\npriv->ssiu = ssiu;\r\npriv->ssiu_nr = nr;\r\nif (rsnd_is_gen1(priv))\r\nops = &rsnd_ssiu_ops_gen1;\r\nelse\r\nops = &rsnd_ssiu_ops_gen2;\r\nfor_each_rsnd_ssiu(ssiu, priv, i) {\r\nret = rsnd_mod_init(priv, rsnd_mod_get(ssiu),\r\nops, NULL, rsnd_mod_get_status,\r\nRSND_MOD_SSIU, i);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nvoid rsnd_ssiu_remove(struct rsnd_priv *priv)\r\n{\r\nstruct rsnd_ssiu *ssiu;\r\nint i;\r\nfor_each_rsnd_ssiu(ssiu, priv, i) {\r\nrsnd_mod_quit(rsnd_mod_get(ssiu));\r\n}\r\n}

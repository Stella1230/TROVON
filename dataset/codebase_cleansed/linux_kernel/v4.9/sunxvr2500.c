static int s3d_get_props(struct s3d_info *sp)\r\n{\r\nsp->width = of_getintprop_default(sp->of_node, "width", 0);\r\nsp->height = of_getintprop_default(sp->of_node, "height", 0);\r\nsp->depth = of_getintprop_default(sp->of_node, "depth", 8);\r\nif (!sp->width || !sp->height) {\r\nprintk(KERN_ERR "s3d: Critical properties missing for %s\n",\r\npci_name(sp->pdev));\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int s3d_setcolreg(unsigned regno,\r\nunsigned red, unsigned green, unsigned blue,\r\nunsigned transp, struct fb_info *info)\r\n{\r\nu32 value;\r\nif (regno < 16) {\r\nred >>= 8;\r\ngreen >>= 8;\r\nblue >>= 8;\r\nvalue = (blue << 24) | (green << 16) | (red << 8);\r\n((u32 *)info->pseudo_palette)[regno] = value;\r\n}\r\nreturn 0;\r\n}\r\nstatic int s3d_set_fbinfo(struct s3d_info *sp)\r\n{\r\nstruct fb_info *info = sp->info;\r\nstruct fb_var_screeninfo *var = &info->var;\r\ninfo->flags = FBINFO_DEFAULT;\r\ninfo->fbops = &s3d_ops;\r\ninfo->screen_base = sp->fb_base;\r\ninfo->screen_size = sp->fb_size;\r\ninfo->pseudo_palette = sp->pseudo_palette;\r\nstrlcpy(info->fix.id, "s3d", sizeof(info->fix.id));\r\ninfo->fix.smem_start = sp->fb_base_phys;\r\ninfo->fix.smem_len = sp->fb_size;\r\ninfo->fix.type = FB_TYPE_PACKED_PIXELS;\r\nif (sp->depth == 32 || sp->depth == 24)\r\ninfo->fix.visual = FB_VISUAL_TRUECOLOR;\r\nelse\r\ninfo->fix.visual = FB_VISUAL_PSEUDOCOLOR;\r\nvar->xres = sp->width;\r\nvar->yres = sp->height;\r\nvar->xres_virtual = var->xres;\r\nvar->yres_virtual = var->yres;\r\nvar->bits_per_pixel = sp->depth;\r\nvar->red.offset = 8;\r\nvar->red.length = 8;\r\nvar->green.offset = 16;\r\nvar->green.length = 8;\r\nvar->blue.offset = 24;\r\nvar->blue.length = 8;\r\nvar->transp.offset = 0;\r\nvar->transp.length = 0;\r\nif (fb_alloc_cmap(&info->cmap, 256, 0)) {\r\nprintk(KERN_ERR "s3d: Cannot allocate color map.\n");\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nstatic int s3d_pci_register(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct fb_info *info;\r\nstruct s3d_info *sp;\r\nint err;\r\nerr = pci_enable_device(pdev);\r\nif (err < 0) {\r\nprintk(KERN_ERR "s3d: Cannot enable PCI device %s\n",\r\npci_name(pdev));\r\ngoto err_out;\r\n}\r\ninfo = framebuffer_alloc(sizeof(struct s3d_info), &pdev->dev);\r\nif (!info) {\r\nprintk(KERN_ERR "s3d: Cannot allocate fb_info\n");\r\nerr = -ENOMEM;\r\ngoto err_disable;\r\n}\r\nsp = info->par;\r\nsp->info = info;\r\nsp->pdev = pdev;\r\nsp->of_node = pci_device_to_OF_node(pdev);\r\nif (!sp->of_node) {\r\nprintk(KERN_ERR "s3d: Cannot find OF node of %s\n",\r\npci_name(pdev));\r\nerr = -ENODEV;\r\ngoto err_release_fb;\r\n}\r\nsp->fb_base_phys = pci_resource_start (pdev, 1);\r\nerr = pci_request_region(pdev, 1, "s3d framebuffer");\r\nif (err < 0) {\r\nprintk("s3d: Cannot request region 1 for %s\n",\r\npci_name(pdev));\r\ngoto err_release_fb;\r\n}\r\nerr = s3d_get_props(sp);\r\nif (err)\r\ngoto err_release_pci;\r\nswitch (sp->depth) {\r\ncase 8:\r\ninfo->fix.line_length = sp->width;\r\nbreak;\r\ncase 16:\r\ninfo->fix.line_length = sp->width * 2;\r\nbreak;\r\ncase 24:\r\ninfo->fix.line_length = sp->width * 3;\r\nbreak;\r\ncase 32:\r\ninfo->fix.line_length = sp->width * 4;\r\nbreak;\r\n}\r\nsp->fb_size = info->fix.line_length * sp->height;\r\nsp->fb_base = ioremap(sp->fb_base_phys, sp->fb_size);\r\nif (!sp->fb_base) {\r\nerr = -ENOMEM;\r\ngoto err_release_pci;\r\n}\r\nerr = s3d_set_fbinfo(sp);\r\nif (err)\r\ngoto err_unmap_fb;\r\npci_set_drvdata(pdev, info);\r\nprintk("s3d: Found device at %s\n", pci_name(pdev));\r\nerr = register_framebuffer(info);\r\nif (err < 0) {\r\nprintk(KERN_ERR "s3d: Could not register framebuffer %s\n",\r\npci_name(pdev));\r\ngoto err_unmap_fb;\r\n}\r\nreturn 0;\r\nerr_unmap_fb:\r\niounmap(sp->fb_base);\r\nerr_release_pci:\r\npci_release_region(pdev, 1);\r\nerr_release_fb:\r\nframebuffer_release(info);\r\nerr_disable:\r\npci_disable_device(pdev);\r\nerr_out:\r\nreturn err;\r\n}\r\nstatic int __init s3d_init(void)\r\n{\r\nif (fb_get_options("s3d", NULL))\r\nreturn -ENODEV;\r\nreturn pci_register_driver(&s3d_driver);\r\n}

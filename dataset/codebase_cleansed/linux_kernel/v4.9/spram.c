static unsigned int bis_c0_errctl(unsigned int set)\r\n{\r\nunsigned int res;\r\nres = read_c0_errctl();\r\nwrite_c0_errctl(res | set);\r\nreturn res;\r\n}\r\nstatic void ispram_store_tag(unsigned int offset, unsigned int data)\r\n{\r\nunsigned int errctl;\r\nerrctl = bis_c0_errctl(ERRCTL_SPRAM);\r\nehb();\r\nwrite_c0_taglo(data);\r\nehb();\r\ncache_op(Index_Store_Tag_I, CKSEG0|offset);\r\nehb();\r\nwrite_c0_errctl(errctl);\r\nehb();\r\n}\r\nstatic unsigned int ispram_load_tag(unsigned int offset)\r\n{\r\nunsigned int data;\r\nunsigned int errctl;\r\nerrctl = bis_c0_errctl(ERRCTL_SPRAM);\r\nehb();\r\ncache_op(Index_Load_Tag_I, CKSEG0 | offset);\r\nehb();\r\ndata = read_c0_taglo();\r\nehb();\r\nwrite_c0_errctl(errctl);\r\nehb();\r\nreturn data;\r\n}\r\nstatic void dspram_store_tag(unsigned int offset, unsigned int data)\r\n{\r\nunsigned int errctl;\r\nerrctl = bis_c0_errctl(ERRCTL_SPRAM);\r\nehb();\r\nwrite_c0_dtaglo(data);\r\nehb();\r\ncache_op(Index_Store_Tag_D, CKSEG0 | offset);\r\nehb();\r\nwrite_c0_errctl(errctl);\r\nehb();\r\n}\r\nstatic unsigned int dspram_load_tag(unsigned int offset)\r\n{\r\nunsigned int data;\r\nunsigned int errctl;\r\nerrctl = bis_c0_errctl(ERRCTL_SPRAM);\r\nehb();\r\ncache_op(Index_Load_Tag_D, CKSEG0 | offset);\r\nehb();\r\ndata = read_c0_dtaglo();\r\nehb();\r\nwrite_c0_errctl(errctl);\r\nehb();\r\nreturn data;\r\n}\r\nvoid spram_config(void)\r\n{\r\nunsigned int config0;\r\nswitch (current_cpu_type()) {\r\ncase CPU_24K:\r\ncase CPU_34K:\r\ncase CPU_74K:\r\ncase CPU_1004K:\r\ncase CPU_1074K:\r\ncase CPU_INTERAPTIV:\r\ncase CPU_PROAPTIV:\r\ncase CPU_P5600:\r\ncase CPU_QEMU_GENERIC:\r\ncase CPU_I6400:\r\ncase CPU_P6600:\r\nconfig0 = read_c0_config();\r\nif (config0 & (1<<24)) {\r\nprobe_spram("ISPRAM", 0x1c000000,\r\n&ispram_load_tag, &ispram_store_tag);\r\n}\r\nif (config0 & (1<<23))\r\nprobe_spram("DSPRAM", 0x1c100000,\r\n&dspram_load_tag, &dspram_store_tag);\r\n}\r\n}

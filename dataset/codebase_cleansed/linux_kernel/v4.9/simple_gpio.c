static u8 u8_pin2mask(unsigned int pin)\r\n{\r\nreturn 1 << (8 - 1 - pin);\r\n}\r\nstatic int u8_gpio_get(struct gpio_chip *gc, unsigned int gpio)\r\n{\r\nstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\r\nreturn !!(in_8(mm_gc->regs) & u8_pin2mask(gpio));\r\n}\r\nstatic void u8_gpio_set(struct gpio_chip *gc, unsigned int gpio, int val)\r\n{\r\nstruct of_mm_gpio_chip *mm_gc = to_of_mm_gpio_chip(gc);\r\nstruct u8_gpio_chip *u8_gc = gpiochip_get_data(gc);\r\nunsigned long flags;\r\nspin_lock_irqsave(&u8_gc->lock, flags);\r\nif (val)\r\nu8_gc->data |= u8_pin2mask(gpio);\r\nelse\r\nu8_gc->data &= ~u8_pin2mask(gpio);\r\nout_8(mm_gc->regs, u8_gc->data);\r\nspin_unlock_irqrestore(&u8_gc->lock, flags);\r\n}\r\nstatic int u8_gpio_dir_in(struct gpio_chip *gc, unsigned int gpio)\r\n{\r\nreturn 0;\r\n}\r\nstatic int u8_gpio_dir_out(struct gpio_chip *gc, unsigned int gpio, int val)\r\n{\r\nu8_gpio_set(gc, gpio, val);\r\nreturn 0;\r\n}\r\nstatic void u8_gpio_save_regs(struct of_mm_gpio_chip *mm_gc)\r\n{\r\nstruct u8_gpio_chip *u8_gc = gpiochip_get_data(&mm_gc->gc);\r\nu8_gc->data = in_8(mm_gc->regs);\r\n}\r\nstatic int __init u8_simple_gpiochip_add(struct device_node *np)\r\n{\r\nint ret;\r\nstruct u8_gpio_chip *u8_gc;\r\nstruct of_mm_gpio_chip *mm_gc;\r\nstruct gpio_chip *gc;\r\nu8_gc = kzalloc(sizeof(*u8_gc), GFP_KERNEL);\r\nif (!u8_gc)\r\nreturn -ENOMEM;\r\nspin_lock_init(&u8_gc->lock);\r\nmm_gc = &u8_gc->mm_gc;\r\ngc = &mm_gc->gc;\r\nmm_gc->save_regs = u8_gpio_save_regs;\r\ngc->ngpio = 8;\r\ngc->direction_input = u8_gpio_dir_in;\r\ngc->direction_output = u8_gpio_dir_out;\r\ngc->get = u8_gpio_get;\r\ngc->set = u8_gpio_set;\r\nret = of_mm_gpiochip_add_data(np, mm_gc, u8_gc);\r\nif (ret)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\nkfree(u8_gc);\r\nreturn ret;\r\n}\r\nvoid __init simple_gpiochip_init(const char *compatible)\r\n{\r\nstruct device_node *np;\r\nfor_each_compatible_node(np, NULL, compatible) {\r\nint ret;\r\nstruct resource r;\r\nret = of_address_to_resource(np, 0, &r);\r\nif (ret)\r\ngoto err;\r\nswitch (resource_size(&r)) {\r\ncase 1:\r\nret = u8_simple_gpiochip_add(np);\r\nif (ret)\r\ngoto err;\r\nbreak;\r\ndefault:\r\nret = -ENOSYS;\r\ngoto err;\r\n}\r\ncontinue;\r\nerr:\r\npr_err("%s: registration failed, status %d\n",\r\nnp->full_name, ret);\r\n}\r\n}

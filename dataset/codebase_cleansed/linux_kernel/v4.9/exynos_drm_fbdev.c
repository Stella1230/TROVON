static int exynos_drm_fb_mmap(struct fb_info *info,\r\nstruct vm_area_struct *vma)\r\n{\r\nstruct drm_fb_helper *helper = info->par;\r\nstruct exynos_drm_fbdev *exynos_fbd = to_exynos_fbdev(helper);\r\nstruct exynos_drm_gem *exynos_gem = exynos_fbd->exynos_gem;\r\nunsigned long vm_size;\r\nint ret;\r\nvma->vm_flags |= VM_IO | VM_DONTEXPAND | VM_DONTDUMP;\r\nvm_size = vma->vm_end - vma->vm_start;\r\nif (vm_size > exynos_gem->size)\r\nreturn -EINVAL;\r\nret = dma_mmap_attrs(to_dma_dev(helper->dev), vma, exynos_gem->cookie,\r\nexynos_gem->dma_addr, exynos_gem->size,\r\nexynos_gem->dma_attrs);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to mmap.\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int exynos_drm_fbdev_update(struct drm_fb_helper *helper,\r\nstruct drm_fb_helper_surface_size *sizes,\r\nstruct exynos_drm_gem *exynos_gem)\r\n{\r\nstruct fb_info *fbi;\r\nstruct drm_framebuffer *fb = helper->fb;\r\nunsigned int size = fb->width * fb->height * (fb->bits_per_pixel >> 3);\r\nunsigned int nr_pages;\r\nunsigned long offset;\r\nfbi = drm_fb_helper_alloc_fbi(helper);\r\nif (IS_ERR(fbi)) {\r\nDRM_ERROR("failed to allocate fb info.\n");\r\nreturn PTR_ERR(fbi);\r\n}\r\nfbi->par = helper;\r\nfbi->flags = FBINFO_FLAG_DEFAULT;\r\nfbi->fbops = &exynos_drm_fb_ops;\r\ndrm_fb_helper_fill_fix(fbi, fb->pitches[0], fb->depth);\r\ndrm_fb_helper_fill_var(fbi, helper, sizes->fb_width, sizes->fb_height);\r\nnr_pages = exynos_gem->size >> PAGE_SHIFT;\r\nexynos_gem->kvaddr = (void __iomem *) vmap(exynos_gem->pages, nr_pages,\r\nVM_MAP, pgprot_writecombine(PAGE_KERNEL));\r\nif (!exynos_gem->kvaddr) {\r\nDRM_ERROR("failed to map pages to kernel space.\n");\r\ndrm_fb_helper_release_fbi(helper);\r\nreturn -EIO;\r\n}\r\noffset = fbi->var.xoffset * (fb->bits_per_pixel >> 3);\r\noffset += fbi->var.yoffset * fb->pitches[0];\r\nfbi->screen_base = exynos_gem->kvaddr + offset;\r\nfbi->screen_size = size;\r\nfbi->fix.smem_len = size;\r\nreturn 0;\r\n}\r\nstatic int exynos_drm_fbdev_create(struct drm_fb_helper *helper,\r\nstruct drm_fb_helper_surface_size *sizes)\r\n{\r\nstruct exynos_drm_fbdev *exynos_fbdev = to_exynos_fbdev(helper);\r\nstruct exynos_drm_gem *exynos_gem;\r\nstruct drm_device *dev = helper->dev;\r\nstruct drm_mode_fb_cmd2 mode_cmd = { 0 };\r\nstruct platform_device *pdev = dev->platformdev;\r\nunsigned long size;\r\nint ret;\r\nDRM_DEBUG_KMS("surface width(%d), height(%d) and bpp(%d\n",\r\nsizes->surface_width, sizes->surface_height,\r\nsizes->surface_bpp);\r\nmode_cmd.width = sizes->surface_width;\r\nmode_cmd.height = sizes->surface_height;\r\nmode_cmd.pitches[0] = sizes->surface_width * (sizes->surface_bpp >> 3);\r\nmode_cmd.pixel_format = drm_mode_legacy_fb_format(sizes->surface_bpp,\r\nsizes->surface_depth);\r\nsize = mode_cmd.pitches[0] * mode_cmd.height;\r\nexynos_gem = exynos_drm_gem_create(dev, EXYNOS_BO_CONTIG, size);\r\nif (IS_ERR(exynos_gem) && is_drm_iommu_supported(dev)) {\r\ndev_warn(&pdev->dev, "contiguous FB allocation failed, falling back to non-contiguous\n");\r\nexynos_gem = exynos_drm_gem_create(dev, EXYNOS_BO_NONCONTIG,\r\nsize);\r\n}\r\nif (IS_ERR(exynos_gem))\r\nreturn PTR_ERR(exynos_gem);\r\nexynos_fbdev->exynos_gem = exynos_gem;\r\nhelper->fb =\r\nexynos_drm_framebuffer_init(dev, &mode_cmd, &exynos_gem, 1);\r\nif (IS_ERR(helper->fb)) {\r\nDRM_ERROR("failed to create drm framebuffer.\n");\r\nret = PTR_ERR(helper->fb);\r\ngoto err_destroy_gem;\r\n}\r\nret = exynos_drm_fbdev_update(helper, sizes, exynos_gem);\r\nif (ret < 0)\r\ngoto err_destroy_framebuffer;\r\nreturn ret;\r\nerr_destroy_framebuffer:\r\ndrm_framebuffer_cleanup(helper->fb);\r\nerr_destroy_gem:\r\nexynos_drm_gem_destroy(exynos_gem);\r\nreturn ret;\r\n}\r\nstatic bool exynos_drm_fbdev_is_anything_connected(struct drm_device *dev)\r\n{\r\nstruct drm_connector *connector;\r\nbool ret = false;\r\nmutex_lock(&dev->mode_config.mutex);\r\nlist_for_each_entry(connector, &dev->mode_config.connector_list, head) {\r\nif (connector->status != connector_status_connected)\r\ncontinue;\r\nret = true;\r\nbreak;\r\n}\r\nmutex_unlock(&dev->mode_config.mutex);\r\nreturn ret;\r\n}\r\nint exynos_drm_fbdev_init(struct drm_device *dev)\r\n{\r\nstruct exynos_drm_fbdev *fbdev;\r\nstruct exynos_drm_private *private = dev->dev_private;\r\nstruct drm_fb_helper *helper;\r\nunsigned int num_crtc;\r\nint ret;\r\nif (!dev->mode_config.num_crtc || !dev->mode_config.num_connector)\r\nreturn 0;\r\nif (!exynos_drm_fbdev_is_anything_connected(dev))\r\nreturn 0;\r\nfbdev = kzalloc(sizeof(*fbdev), GFP_KERNEL);\r\nif (!fbdev)\r\nreturn -ENOMEM;\r\nprivate->fb_helper = helper = &fbdev->drm_fb_helper;\r\ndrm_fb_helper_prepare(dev, helper, &exynos_drm_fb_helper_funcs);\r\nnum_crtc = dev->mode_config.num_crtc;\r\nret = drm_fb_helper_init(dev, helper, num_crtc, MAX_CONNECTOR);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to initialize drm fb helper.\n");\r\ngoto err_init;\r\n}\r\nret = drm_fb_helper_single_add_all_connectors(helper);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to register drm_fb_helper_connector.\n");\r\ngoto err_setup;\r\n}\r\nret = drm_fb_helper_initial_config(helper, PREFERRED_BPP);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to set up hw configuration.\n");\r\ngoto err_setup;\r\n}\r\nreturn 0;\r\nerr_setup:\r\ndrm_fb_helper_fini(helper);\r\nerr_init:\r\nprivate->fb_helper = NULL;\r\nkfree(fbdev);\r\nreturn ret;\r\n}\r\nstatic void exynos_drm_fbdev_destroy(struct drm_device *dev,\r\nstruct drm_fb_helper *fb_helper)\r\n{\r\nstruct exynos_drm_fbdev *exynos_fbd = to_exynos_fbdev(fb_helper);\r\nstruct exynos_drm_gem *exynos_gem = exynos_fbd->exynos_gem;\r\nstruct drm_framebuffer *fb;\r\nvunmap(exynos_gem->kvaddr);\r\nif (fb_helper->fb && fb_helper->fb->funcs) {\r\nfb = fb_helper->fb;\r\nif (fb) {\r\ndrm_framebuffer_unregister_private(fb);\r\ndrm_framebuffer_remove(fb);\r\n}\r\n}\r\ndrm_fb_helper_unregister_fbi(fb_helper);\r\ndrm_fb_helper_release_fbi(fb_helper);\r\ndrm_fb_helper_fini(fb_helper);\r\n}\r\nvoid exynos_drm_fbdev_fini(struct drm_device *dev)\r\n{\r\nstruct exynos_drm_private *private = dev->dev_private;\r\nstruct exynos_drm_fbdev *fbdev;\r\nif (!private || !private->fb_helper)\r\nreturn;\r\nfbdev = to_exynos_fbdev(private->fb_helper);\r\nexynos_drm_fbdev_destroy(dev, private->fb_helper);\r\nkfree(fbdev);\r\nprivate->fb_helper = NULL;\r\n}\r\nvoid exynos_drm_fbdev_restore_mode(struct drm_device *dev)\r\n{\r\nstruct exynos_drm_private *private = dev->dev_private;\r\nif (!private || !private->fb_helper)\r\nreturn;\r\ndrm_fb_helper_restore_fbdev_mode_unlocked(private->fb_helper);\r\n}\r\nvoid exynos_drm_output_poll_changed(struct drm_device *dev)\r\n{\r\nstruct exynos_drm_private *private = dev->dev_private;\r\nstruct drm_fb_helper *fb_helper = private->fb_helper;\r\nif (fb_helper)\r\ndrm_fb_helper_hotplug_event(fb_helper);\r\nelse\r\nexynos_drm_fbdev_init(dev);\r\n}

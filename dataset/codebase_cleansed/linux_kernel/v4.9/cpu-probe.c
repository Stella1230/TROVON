static inline unsigned long cpu_get_fpu_id(void)\r\n{\r\nunsigned long tmp, fpu_id;\r\ntmp = read_c0_status();\r\n__enable_fpu(FPU_AS_IS);\r\nfpu_id = read_32bit_cp1_register(CP1_REVISION);\r\nwrite_c0_status(tmp);\r\nreturn fpu_id;\r\n}\r\nstatic inline int __cpu_has_fpu(void)\r\n{\r\nreturn (cpu_get_fpu_id() & FPIR_IMP_MASK) != FPIR_IMP_NONE;\r\n}\r\nstatic inline unsigned long cpu_get_msa_id(void)\r\n{\r\nunsigned long status, msa_id;\r\nstatus = read_c0_status();\r\n__enable_fpu(FPU_64BIT);\r\nenable_msa();\r\nmsa_id = read_msa_ir();\r\ndisable_msa();\r\nwrite_c0_status(status);\r\nreturn msa_id;\r\n}\r\nstatic inline void cpu_set_fpu_fcsr_mask(struct cpuinfo_mips *c)\r\n{\r\nunsigned long sr, mask, fcsr, fcsr0, fcsr1;\r\nfcsr = c->fpu_csr31;\r\nmask = FPU_CSR_ALL_X | FPU_CSR_ALL_E | FPU_CSR_ALL_S | FPU_CSR_RM;\r\nsr = read_c0_status();\r\n__enable_fpu(FPU_AS_IS);\r\nfcsr0 = fcsr & mask;\r\nwrite_32bit_cp1_register(CP1_STATUS, fcsr0);\r\nfcsr0 = read_32bit_cp1_register(CP1_STATUS);\r\nfcsr1 = fcsr | ~mask;\r\nwrite_32bit_cp1_register(CP1_STATUS, fcsr1);\r\nfcsr1 = read_32bit_cp1_register(CP1_STATUS);\r\nwrite_32bit_cp1_register(CP1_STATUS, fcsr);\r\nwrite_c0_status(sr);\r\nc->fpu_msk31 = ~(fcsr0 ^ fcsr1) & ~mask;\r\n}\r\nstatic void cpu_set_fpu_2008(struct cpuinfo_mips *c)\r\n{\r\nif (c->isa_level & (MIPS_CPU_ISA_M32R1 | MIPS_CPU_ISA_M64R1 |\r\nMIPS_CPU_ISA_M32R2 | MIPS_CPU_ISA_M64R2 |\r\nMIPS_CPU_ISA_M32R6 | MIPS_CPU_ISA_M64R6)) {\r\nunsigned long sr, fir, fcsr, fcsr0, fcsr1;\r\nsr = read_c0_status();\r\n__enable_fpu(FPU_AS_IS);\r\nfir = read_32bit_cp1_register(CP1_REVISION);\r\nif (fir & MIPS_FPIR_HAS2008) {\r\nfcsr = read_32bit_cp1_register(CP1_STATUS);\r\nfcsr0 = fcsr & ~(FPU_CSR_ABS2008 | FPU_CSR_NAN2008);\r\nwrite_32bit_cp1_register(CP1_STATUS, fcsr0);\r\nfcsr0 = read_32bit_cp1_register(CP1_STATUS);\r\nfcsr1 = fcsr | FPU_CSR_ABS2008 | FPU_CSR_NAN2008;\r\nwrite_32bit_cp1_register(CP1_STATUS, fcsr1);\r\nfcsr1 = read_32bit_cp1_register(CP1_STATUS);\r\nwrite_32bit_cp1_register(CP1_STATUS, fcsr);\r\nif (!(fcsr0 & FPU_CSR_NAN2008))\r\nc->options |= MIPS_CPU_NAN_LEGACY;\r\nif (fcsr1 & FPU_CSR_NAN2008)\r\nc->options |= MIPS_CPU_NAN_2008;\r\nif ((fcsr0 ^ fcsr1) & FPU_CSR_ABS2008)\r\nc->fpu_msk31 &= ~FPU_CSR_ABS2008;\r\nelse\r\nc->fpu_csr31 |= fcsr & FPU_CSR_ABS2008;\r\nif ((fcsr0 ^ fcsr1) & FPU_CSR_NAN2008)\r\nc->fpu_msk31 &= ~FPU_CSR_NAN2008;\r\nelse\r\nc->fpu_csr31 |= fcsr & FPU_CSR_NAN2008;\r\n} else {\r\nc->options |= MIPS_CPU_NAN_LEGACY;\r\n}\r\nwrite_c0_status(sr);\r\n} else {\r\nc->options |= MIPS_CPU_NAN_LEGACY;\r\n}\r\n}\r\nstatic void cpu_set_nofpu_2008(struct cpuinfo_mips *c)\r\n{\r\nc->options &= ~(MIPS_CPU_NAN_2008 | MIPS_CPU_NAN_LEGACY);\r\nc->fpu_csr31 &= ~(FPU_CSR_ABS2008 | FPU_CSR_NAN2008);\r\nc->fpu_msk31 &= ~(FPU_CSR_ABS2008 | FPU_CSR_NAN2008);\r\nswitch (ieee754) {\r\ncase STRICT:\r\nif (c->isa_level & (MIPS_CPU_ISA_M32R1 | MIPS_CPU_ISA_M64R1 |\r\nMIPS_CPU_ISA_M32R2 | MIPS_CPU_ISA_M64R2 |\r\nMIPS_CPU_ISA_M32R6 | MIPS_CPU_ISA_M64R6)) {\r\nc->options |= MIPS_CPU_NAN_2008 | MIPS_CPU_NAN_LEGACY;\r\n} else {\r\nc->options |= MIPS_CPU_NAN_LEGACY;\r\nc->fpu_msk31 |= FPU_CSR_ABS2008 | FPU_CSR_NAN2008;\r\n}\r\nbreak;\r\ncase LEGACY:\r\nc->options |= MIPS_CPU_NAN_LEGACY;\r\nc->fpu_msk31 |= FPU_CSR_ABS2008 | FPU_CSR_NAN2008;\r\nbreak;\r\ncase STD2008:\r\nc->options |= MIPS_CPU_NAN_2008;\r\nc->fpu_csr31 |= FPU_CSR_ABS2008 | FPU_CSR_NAN2008;\r\nc->fpu_msk31 |= FPU_CSR_ABS2008 | FPU_CSR_NAN2008;\r\nbreak;\r\ncase RELAXED:\r\nc->options |= MIPS_CPU_NAN_2008 | MIPS_CPU_NAN_LEGACY;\r\nbreak;\r\n}\r\n}\r\nstatic void cpu_set_nan_2008(struct cpuinfo_mips *c)\r\n{\r\nswitch (ieee754) {\r\ncase STRICT:\r\nmips_use_nan_legacy = !!cpu_has_nan_legacy;\r\nmips_use_nan_2008 = !!cpu_has_nan_2008;\r\nbreak;\r\ncase LEGACY:\r\nmips_use_nan_legacy = !!cpu_has_nan_legacy;\r\nmips_use_nan_2008 = !cpu_has_nan_legacy;\r\nbreak;\r\ncase STD2008:\r\nmips_use_nan_legacy = !cpu_has_nan_2008;\r\nmips_use_nan_2008 = !!cpu_has_nan_2008;\r\nbreak;\r\ncase RELAXED:\r\nmips_use_nan_legacy = true;\r\nmips_use_nan_2008 = true;\r\nbreak;\r\n}\r\n}\r\nstatic int __init ieee754_setup(char *s)\r\n{\r\nif (!s)\r\nreturn -1;\r\nelse if (!strcmp(s, "strict"))\r\nieee754 = STRICT;\r\nelse if (!strcmp(s, "legacy"))\r\nieee754 = LEGACY;\r\nelse if (!strcmp(s, "2008"))\r\nieee754 = STD2008;\r\nelse if (!strcmp(s, "relaxed"))\r\nieee754 = RELAXED;\r\nelse\r\nreturn -1;\r\nif (!(boot_cpu_data.options & MIPS_CPU_FPU))\r\ncpu_set_nofpu_2008(&boot_cpu_data);\r\ncpu_set_nan_2008(&boot_cpu_data);\r\nreturn 0;\r\n}\r\nstatic void cpu_set_nofpu_id(struct cpuinfo_mips *c)\r\n{\r\nu32 value;\r\nvalue = 0;\r\nif (c->isa_level & (MIPS_CPU_ISA_M32R1 | MIPS_CPU_ISA_M64R1 |\r\nMIPS_CPU_ISA_M32R2 | MIPS_CPU_ISA_M64R2 |\r\nMIPS_CPU_ISA_M32R6 | MIPS_CPU_ISA_M64R6))\r\nvalue |= MIPS_FPIR_D | MIPS_FPIR_S;\r\nif (c->isa_level & (MIPS_CPU_ISA_M32R2 | MIPS_CPU_ISA_M64R2 |\r\nMIPS_CPU_ISA_M32R6 | MIPS_CPU_ISA_M64R6))\r\nvalue |= MIPS_FPIR_F64 | MIPS_FPIR_L | MIPS_FPIR_W;\r\nif (c->options & MIPS_CPU_NAN_2008)\r\nvalue |= MIPS_FPIR_HAS2008;\r\nc->fpu_id = value;\r\n}\r\nstatic void cpu_set_fpu_opts(struct cpuinfo_mips *c)\r\n{\r\nc->fpu_id = cpu_get_fpu_id();\r\nmips_nofpu_msk31 = c->fpu_msk31;\r\nif (c->isa_level & (MIPS_CPU_ISA_M32R1 | MIPS_CPU_ISA_M64R1 |\r\nMIPS_CPU_ISA_M32R2 | MIPS_CPU_ISA_M64R2 |\r\nMIPS_CPU_ISA_M32R6 | MIPS_CPU_ISA_M64R6)) {\r\nif (c->fpu_id & MIPS_FPIR_3D)\r\nc->ases |= MIPS_ASE_MIPS3D;\r\nif (c->fpu_id & MIPS_FPIR_FREP)\r\nc->options |= MIPS_CPU_FRE;\r\n}\r\ncpu_set_fpu_fcsr_mask(c);\r\ncpu_set_fpu_2008(c);\r\ncpu_set_nan_2008(c);\r\n}\r\nstatic void cpu_set_nofpu_opts(struct cpuinfo_mips *c)\r\n{\r\nc->options &= ~MIPS_CPU_FPU;\r\nc->fpu_msk31 = mips_nofpu_msk31;\r\ncpu_set_nofpu_2008(c);\r\ncpu_set_nan_2008(c);\r\ncpu_set_nofpu_id(c);\r\n}\r\nstatic int __init fpu_disable(char *s)\r\n{\r\ncpu_set_nofpu_opts(&boot_cpu_data);\r\nmips_fpu_disabled = 1;\r\nreturn 1;\r\n}\r\nstatic int __init dsp_disable(char *s)\r\n{\r\ncpu_data[0].ases &= ~(MIPS_ASE_DSP | MIPS_ASE_DSP2P);\r\nmips_dsp_disabled = 1;\r\nreturn 1;\r\n}\r\nstatic int __init htw_disable(char *s)\r\n{\r\nmips_htw_disabled = 1;\r\ncpu_data[0].options &= ~MIPS_CPU_HTW;\r\nwrite_c0_pwctl(read_c0_pwctl() &\r\n~(1 << MIPS_PWCTL_PWEN_SHIFT));\r\nreturn 1;\r\n}\r\nstatic int __init ftlb_disable(char *s)\r\n{\r\nunsigned int config4, mmuextdef;\r\nif (!mips_has_ftlb_configured)\r\nreturn 1;\r\nif (set_ftlb_enable(&cpu_data[0], 0)) {\r\npr_warn("Can't turn FTLB off\n");\r\nreturn 1;\r\n}\r\nconfig4 = read_c0_config4();\r\nmmuextdef = config4 & MIPS_CONF4_MMUEXTDEF;\r\nif (mmuextdef == MIPS_CONF4_MMUEXTDEF_FTLBSIZEEXT) {\r\npr_warn("FTLB could not be disabled!\n");\r\nreturn 1;\r\n}\r\nmips_ftlb_disabled = 1;\r\nmips_has_ftlb_configured = 0;\r\npr_info("FTLB has been disabled\n");\r\ncpu_data[0].tlbsize -= cpu_data[0].tlbsizeftlbways *\r\ncpu_data[0].tlbsizeftlbsets;\r\ncpu_data[0].tlbsizeftlbsets = 0;\r\ncpu_data[0].tlbsizeftlbways = 0;\r\nreturn 1;\r\n}\r\nstatic inline void check_errata(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nswitch (current_cpu_type()) {\r\ncase CPU_34K:\r\nif ((c->processor_id & PRID_REV_MASK) <= PRID_REV_34K_V1_0_2)\r\nwrite_c0_config7(read_c0_config7() | MIPS_CONF7_RPS);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nvoid __init check_bugs32(void)\r\n{\r\ncheck_errata();\r\n}\r\nstatic inline int cpu_has_confreg(void)\r\n{\r\n#ifdef CONFIG_CPU_R3000\r\nextern unsigned long r3k_cache_size(unsigned long);\r\nunsigned long size1, size2;\r\nunsigned long cfg = read_c0_conf();\r\nsize1 = r3k_cache_size(ST0_ISC);\r\nwrite_c0_conf(cfg ^ R30XX_CONF_AC);\r\nsize2 = r3k_cache_size(ST0_ISC);\r\nwrite_c0_conf(cfg);\r\nreturn size1 != size2;\r\n#else\r\nreturn 0;\r\n#endif\r\n}\r\nstatic inline void set_elf_platform(int cpu, const char *plat)\r\n{\r\nif (cpu == 0)\r\n__elf_platform = plat;\r\n}\r\nstatic inline void cpu_probe_vmbits(struct cpuinfo_mips *c)\r\n{\r\n#ifdef __NEED_VMBITS_PROBE\r\nwrite_c0_entryhi(0x3fffffffffffe000ULL);\r\nback_to_back_c0_hazard();\r\nc->vmbits = fls64(read_c0_entryhi() & 0x3fffffffffffe000ULL);\r\n#endif\r\n}\r\nstatic void set_isa(struct cpuinfo_mips *c, unsigned int isa)\r\n{\r\nswitch (isa) {\r\ncase MIPS_CPU_ISA_M64R2:\r\nc->isa_level |= MIPS_CPU_ISA_M32R2 | MIPS_CPU_ISA_M64R2;\r\ncase MIPS_CPU_ISA_M64R1:\r\nc->isa_level |= MIPS_CPU_ISA_M32R1 | MIPS_CPU_ISA_M64R1;\r\ncase MIPS_CPU_ISA_V:\r\nc->isa_level |= MIPS_CPU_ISA_V;\r\ncase MIPS_CPU_ISA_IV:\r\nc->isa_level |= MIPS_CPU_ISA_IV;\r\ncase MIPS_CPU_ISA_III:\r\nc->isa_level |= MIPS_CPU_ISA_II | MIPS_CPU_ISA_III;\r\nbreak;\r\ncase MIPS_CPU_ISA_M64R6:\r\nc->isa_level |= MIPS_CPU_ISA_M32R6 | MIPS_CPU_ISA_M64R6;\r\ncase MIPS_CPU_ISA_M32R6:\r\nc->isa_level |= MIPS_CPU_ISA_M32R6;\r\nbreak;\r\ncase MIPS_CPU_ISA_M32R2:\r\nc->isa_level |= MIPS_CPU_ISA_M32R2;\r\ncase MIPS_CPU_ISA_M32R1:\r\nc->isa_level |= MIPS_CPU_ISA_M32R1;\r\ncase MIPS_CPU_ISA_II:\r\nc->isa_level |= MIPS_CPU_ISA_II;\r\nbreak;\r\n}\r\n}\r\nstatic unsigned int calculate_ftlb_probability(struct cpuinfo_mips *c)\r\n{\r\nunsigned int probability = c->tlbsize / c->tlbsizevtlb;\r\nif (probability >= 12)\r\nreturn 1;\r\nelse if (probability >= 6)\r\nreturn 2;\r\nelse\r\nreturn 3;\r\n}\r\nstatic int set_ftlb_enable(struct cpuinfo_mips *c, enum ftlb_flags flags)\r\n{\r\nunsigned int config;\r\nswitch (c->cputype) {\r\ncase CPU_PROAPTIV:\r\ncase CPU_P5600:\r\ncase CPU_P6600:\r\nconfig = read_c0_config6();\r\nif (flags & FTLB_EN)\r\nconfig |= MIPS_CONF6_FTLBEN;\r\nelse\r\nconfig &= ~MIPS_CONF6_FTLBEN;\r\nif (flags & FTLB_SET_PROB) {\r\nconfig &= ~(3 << MIPS_CONF6_FTLBP_SHIFT);\r\nconfig |= calculate_ftlb_probability(c)\r\n<< MIPS_CONF6_FTLBP_SHIFT;\r\n}\r\nwrite_c0_config6(config);\r\nback_to_back_c0_hazard();\r\nbreak;\r\ncase CPU_I6400:\r\nif (!(flags & FTLB_EN))\r\nreturn 1;\r\nreturn 0;\r\ncase CPU_LOONGSON3:\r\nwrite_c0_diag(LOONGSON_DIAG_ITLB | LOONGSON_DIAG_DTLB |\r\nLOONGSON_DIAG_VTLB | LOONGSON_DIAG_FTLB);\r\nconfig = read_c0_config6();\r\nif (flags & FTLB_EN)\r\nwrite_c0_config6(config & ~MIPS_CONF6_FTLBDIS);\r\nelse\r\nwrite_c0_config6(config | MIPS_CONF6_FTLBDIS);\r\nbreak;\r\ndefault:\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline unsigned int decode_config0(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config0;\r\nint isa, mt;\r\nconfig0 = read_c0_config();\r\nmt = config0 & MIPS_CONF_MT;\r\nif (mt == MIPS_CONF_MT_TLB)\r\nc->options |= MIPS_CPU_TLB;\r\nelse if (mt == MIPS_CONF_MT_FTLB)\r\nc->options |= MIPS_CPU_TLB | MIPS_CPU_FTLB;\r\nisa = (config0 & MIPS_CONF_AT) >> 13;\r\nswitch (isa) {\r\ncase 0:\r\nswitch ((config0 & MIPS_CONF_AR) >> 10) {\r\ncase 0:\r\nset_isa(c, MIPS_CPU_ISA_M32R1);\r\nbreak;\r\ncase 1:\r\nset_isa(c, MIPS_CPU_ISA_M32R2);\r\nbreak;\r\ncase 2:\r\nset_isa(c, MIPS_CPU_ISA_M32R6);\r\nbreak;\r\ndefault:\r\ngoto unknown;\r\n}\r\nbreak;\r\ncase 2:\r\nswitch ((config0 & MIPS_CONF_AR) >> 10) {\r\ncase 0:\r\nset_isa(c, MIPS_CPU_ISA_M64R1);\r\nbreak;\r\ncase 1:\r\nset_isa(c, MIPS_CPU_ISA_M64R2);\r\nbreak;\r\ncase 2:\r\nset_isa(c, MIPS_CPU_ISA_M64R6);\r\nbreak;\r\ndefault:\r\ngoto unknown;\r\n}\r\nbreak;\r\ndefault:\r\ngoto unknown;\r\n}\r\nreturn config0 & MIPS_CONF_M;\r\nunknown:\r\npanic(unknown_isa, config0);\r\n}\r\nstatic inline unsigned int decode_config1(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config1;\r\nconfig1 = read_c0_config1();\r\nif (config1 & MIPS_CONF1_MD)\r\nc->ases |= MIPS_ASE_MDMX;\r\nif (config1 & MIPS_CONF1_PC)\r\nc->options |= MIPS_CPU_PERF;\r\nif (config1 & MIPS_CONF1_WR)\r\nc->options |= MIPS_CPU_WATCH;\r\nif (config1 & MIPS_CONF1_CA)\r\nc->ases |= MIPS_ASE_MIPS16;\r\nif (config1 & MIPS_CONF1_EP)\r\nc->options |= MIPS_CPU_EJTAG;\r\nif (config1 & MIPS_CONF1_FP) {\r\nc->options |= MIPS_CPU_FPU;\r\nc->options |= MIPS_CPU_32FPR;\r\n}\r\nif (cpu_has_tlb) {\r\nc->tlbsize = ((config1 & MIPS_CONF1_TLBS) >> 25) + 1;\r\nc->tlbsizevtlb = c->tlbsize;\r\nc->tlbsizeftlbsets = 0;\r\n}\r\nreturn config1 & MIPS_CONF_M;\r\n}\r\nstatic inline unsigned int decode_config2(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config2;\r\nconfig2 = read_c0_config2();\r\nif (config2 & MIPS_CONF2_SL)\r\nc->scache.flags &= ~MIPS_CACHE_NOT_PRESENT;\r\nreturn config2 & MIPS_CONF_M;\r\n}\r\nstatic inline unsigned int decode_config3(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config3;\r\nconfig3 = read_c0_config3();\r\nif (config3 & MIPS_CONF3_SM) {\r\nc->ases |= MIPS_ASE_SMARTMIPS;\r\nc->options |= MIPS_CPU_RIXI | MIPS_CPU_CTXTC;\r\n}\r\nif (config3 & MIPS_CONF3_RXI)\r\nc->options |= MIPS_CPU_RIXI;\r\nif (config3 & MIPS_CONF3_CTXTC)\r\nc->options |= MIPS_CPU_CTXTC;\r\nif (config3 & MIPS_CONF3_DSP)\r\nc->ases |= MIPS_ASE_DSP;\r\nif (config3 & MIPS_CONF3_DSP2P) {\r\nc->ases |= MIPS_ASE_DSP2P;\r\nif (cpu_has_mips_r6)\r\nc->ases |= MIPS_ASE_DSP3;\r\n}\r\nif (config3 & MIPS_CONF3_VINT)\r\nc->options |= MIPS_CPU_VINT;\r\nif (config3 & MIPS_CONF3_VEIC)\r\nc->options |= MIPS_CPU_VEIC;\r\nif (config3 & MIPS_CONF3_LPA)\r\nc->options |= MIPS_CPU_LPA;\r\nif (config3 & MIPS_CONF3_MT)\r\nc->ases |= MIPS_ASE_MIPSMT;\r\nif (config3 & MIPS_CONF3_ULRI)\r\nc->options |= MIPS_CPU_ULRI;\r\nif (config3 & MIPS_CONF3_ISA)\r\nc->options |= MIPS_CPU_MICROMIPS;\r\nif (config3 & MIPS_CONF3_VZ)\r\nc->ases |= MIPS_ASE_VZ;\r\nif (config3 & MIPS_CONF3_SC)\r\nc->options |= MIPS_CPU_SEGMENTS;\r\nif (config3 & MIPS_CONF3_BI)\r\nc->options |= MIPS_CPU_BADINSTR;\r\nif (config3 & MIPS_CONF3_BP)\r\nc->options |= MIPS_CPU_BADINSTRP;\r\nif (config3 & MIPS_CONF3_MSA)\r\nc->ases |= MIPS_ASE_MSA;\r\nif (config3 & MIPS_CONF3_PW) {\r\nc->htw_seq = 0;\r\nc->options |= MIPS_CPU_HTW;\r\n}\r\nif (config3 & MIPS_CONF3_CDMM)\r\nc->options |= MIPS_CPU_CDMM;\r\nif (config3 & MIPS_CONF3_SP)\r\nc->options |= MIPS_CPU_SP;\r\nreturn config3 & MIPS_CONF_M;\r\n}\r\nstatic inline unsigned int decode_config4(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config4;\r\nunsigned int newcf4;\r\nunsigned int mmuextdef;\r\nunsigned int ftlb_page = MIPS_CONF4_FTLBPAGESIZE;\r\nunsigned long asid_mask;\r\nconfig4 = read_c0_config4();\r\nif (cpu_has_tlb) {\r\nif (((config4 & MIPS_CONF4_IE) >> 29) == 2)\r\nc->options |= MIPS_CPU_TLBINV;\r\nif (!cpu_has_mips_r6)\r\nmmuextdef = config4 & MIPS_CONF4_MMUEXTDEF;\r\nelse if (cpu_has_ftlb)\r\nmmuextdef = MIPS_CONF4_MMUEXTDEF_VTLBSIZEEXT;\r\nelse\r\nmmuextdef = 0;\r\nswitch (mmuextdef) {\r\ncase MIPS_CONF4_MMUEXTDEF_MMUSIZEEXT:\r\nc->tlbsize += (config4 & MIPS_CONF4_MMUSIZEEXT) * 0x40;\r\nc->tlbsizevtlb = c->tlbsize;\r\nbreak;\r\ncase MIPS_CONF4_MMUEXTDEF_VTLBSIZEEXT:\r\nc->tlbsizevtlb +=\r\n((config4 & MIPS_CONF4_VTLBSIZEEXT) >>\r\nMIPS_CONF4_VTLBSIZEEXT_SHIFT) * 0x40;\r\nc->tlbsize = c->tlbsizevtlb;\r\nftlb_page = MIPS_CONF4_VFTLBPAGESIZE;\r\ncase MIPS_CONF4_MMUEXTDEF_FTLBSIZEEXT:\r\nif (mips_ftlb_disabled)\r\nbreak;\r\nnewcf4 = (config4 & ~ftlb_page) |\r\n(page_size_ftlb(mmuextdef) <<\r\nMIPS_CONF4_FTLBPAGESIZE_SHIFT);\r\nwrite_c0_config4(newcf4);\r\nback_to_back_c0_hazard();\r\nconfig4 = read_c0_config4();\r\nif (config4 != newcf4) {\r\npr_err("PAGE_SIZE 0x%lx is not supported by FTLB (config4=0x%x)\n",\r\nPAGE_SIZE, config4);\r\nset_ftlb_enable(c, 0);\r\nmips_ftlb_disabled = 1;\r\nbreak;\r\n}\r\nc->tlbsizeftlbsets = 1 <<\r\n((config4 & MIPS_CONF4_FTLBSETS) >>\r\nMIPS_CONF4_FTLBSETS_SHIFT);\r\nc->tlbsizeftlbways = ((config4 & MIPS_CONF4_FTLBWAYS) >>\r\nMIPS_CONF4_FTLBWAYS_SHIFT) + 2;\r\nc->tlbsize += c->tlbsizeftlbways * c->tlbsizeftlbsets;\r\nmips_has_ftlb_configured = 1;\r\nbreak;\r\n}\r\n}\r\nc->kscratch_mask = (config4 & MIPS_CONF4_KSCREXIST)\r\n>> MIPS_CONF4_KSCREXIST_SHIFT;\r\nasid_mask = MIPS_ENTRYHI_ASID;\r\nif (config4 & MIPS_CONF4_AE)\r\nasid_mask |= MIPS_ENTRYHI_ASIDX;\r\nset_cpu_asid_mask(c, asid_mask);\r\nWARN_ON(asid_mask != cpu_asid_mask(c));\r\nreturn config4 & MIPS_CONF_M;\r\n}\r\nstatic inline unsigned int decode_config5(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config5;\r\nconfig5 = read_c0_config5();\r\nconfig5 &= ~(MIPS_CONF5_UFR | MIPS_CONF5_UFE);\r\nwrite_c0_config5(config5);\r\nif (config5 & MIPS_CONF5_EVA)\r\nc->options |= MIPS_CPU_EVA;\r\nif (config5 & MIPS_CONF5_MRP)\r\nc->options |= MIPS_CPU_MAAR;\r\nif (config5 & MIPS_CONF5_LLB)\r\nc->options |= MIPS_CPU_RW_LLB;\r\nif (config5 & MIPS_CONF5_MVH)\r\nc->options |= MIPS_CPU_MVH;\r\nif (cpu_has_mips_r6 && (config5 & MIPS_CONF5_VP))\r\nc->options |= MIPS_CPU_VP;\r\nreturn config5 & MIPS_CONF_M;\r\n}\r\nstatic void decode_configs(struct cpuinfo_mips *c)\r\n{\r\nint ok;\r\nc->options = MIPS_CPU_4KEX | MIPS_CPU_4K_CACHE | MIPS_CPU_COUNTER |\r\nMIPS_CPU_DIVEC | MIPS_CPU_LLSC | MIPS_CPU_MCHECK;\r\nc->scache.flags = MIPS_CACHE_NOT_PRESENT;\r\nset_ftlb_enable(c, mips_ftlb_disabled ? 0 : FTLB_EN);\r\nok = decode_config0(c);\r\nBUG_ON(!ok);\r\nif (ok)\r\nok = decode_config1(c);\r\nif (ok)\r\nok = decode_config2(c);\r\nif (ok)\r\nok = decode_config3(c);\r\nif (ok)\r\nok = decode_config4(c);\r\nif (ok)\r\nok = decode_config5(c);\r\nif (cpu_has_mips_r2_r6) {\r\nu64 ebase;\r\nunsigned int status;\r\nebase = cpu_has_mips64r6 ? read_c0_ebase_64()\r\n: (s32)read_c0_ebase();\r\nif (ebase & MIPS_EBASE_WG) {\r\nc->options |= MIPS_CPU_EBASE_WG;\r\n} else {\r\nstatus = read_c0_status();\r\nwrite_c0_status(status | ST0_BEV);\r\nirq_enable_hazard();\r\nif (cpu_has_mips64r6)\r\nwrite_c0_ebase_64(ebase | MIPS_EBASE_WG);\r\nelse\r\nwrite_c0_ebase(ebase | MIPS_EBASE_WG);\r\nback_to_back_c0_hazard();\r\nwrite_c0_status(status);\r\nif (read_c0_ebase() & MIPS_EBASE_WG) {\r\nc->options |= MIPS_CPU_EBASE_WG;\r\nwrite_c0_ebase(ebase);\r\n}\r\n}\r\n}\r\nset_ftlb_enable(c, (mips_ftlb_disabled ? 0 : FTLB_EN) | FTLB_SET_PROB);\r\nmips_probe_watch_registers(c);\r\n#ifndef CONFIG_MIPS_CPS\r\nif (cpu_has_mips_r2_r6) {\r\nc->core = get_ebase_cpunum();\r\nif (cpu_has_mipsmt)\r\nc->core >>= fls(core_nvpes()) - 1;\r\n}\r\n#endif\r\n}\r\nstatic inline unsigned int decode_guest_config0(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config0;\r\nprobe_gc0_config(config, config0, MIPS_CONF_M);\r\nif (config0 & MIPS_CONF_M)\r\nc->guest.conf |= BIT(1);\r\nreturn config0 & MIPS_CONF_M;\r\n}\r\nstatic inline unsigned int decode_guest_config1(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config1, config1_dyn;\r\nprobe_gc0_config_dyn(config1, config1, config1_dyn,\r\nMIPS_CONF_M | MIPS_CONF1_PC | MIPS_CONF1_WR |\r\nMIPS_CONF1_FP);\r\nif (config1 & MIPS_CONF1_FP)\r\nc->guest.options |= MIPS_CPU_FPU;\r\nif (config1_dyn & MIPS_CONF1_FP)\r\nc->guest.options_dyn |= MIPS_CPU_FPU;\r\nif (config1 & MIPS_CONF1_WR)\r\nc->guest.options |= MIPS_CPU_WATCH;\r\nif (config1_dyn & MIPS_CONF1_WR)\r\nc->guest.options_dyn |= MIPS_CPU_WATCH;\r\nif (config1 & MIPS_CONF1_PC)\r\nc->guest.options |= MIPS_CPU_PERF;\r\nif (config1_dyn & MIPS_CONF1_PC)\r\nc->guest.options_dyn |= MIPS_CPU_PERF;\r\nif (config1 & MIPS_CONF_M)\r\nc->guest.conf |= BIT(2);\r\nreturn config1 & MIPS_CONF_M;\r\n}\r\nstatic inline unsigned int decode_guest_config2(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config2;\r\nprobe_gc0_config(config2, config2, MIPS_CONF_M);\r\nif (config2 & MIPS_CONF_M)\r\nc->guest.conf |= BIT(3);\r\nreturn config2 & MIPS_CONF_M;\r\n}\r\nstatic inline unsigned int decode_guest_config3(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config3, config3_dyn;\r\nprobe_gc0_config_dyn(config3, config3, config3_dyn,\r\nMIPS_CONF_M | MIPS_CONF3_MSA | MIPS_CONF3_CTXTC);\r\nif (config3 & MIPS_CONF3_CTXTC)\r\nc->guest.options |= MIPS_CPU_CTXTC;\r\nif (config3_dyn & MIPS_CONF3_CTXTC)\r\nc->guest.options_dyn |= MIPS_CPU_CTXTC;\r\nif (config3 & MIPS_CONF3_PW)\r\nc->guest.options |= MIPS_CPU_HTW;\r\nif (config3 & MIPS_CONF3_SC)\r\nc->guest.options |= MIPS_CPU_SEGMENTS;\r\nif (config3 & MIPS_CONF3_BI)\r\nc->guest.options |= MIPS_CPU_BADINSTR;\r\nif (config3 & MIPS_CONF3_BP)\r\nc->guest.options |= MIPS_CPU_BADINSTRP;\r\nif (config3 & MIPS_CONF3_MSA)\r\nc->guest.ases |= MIPS_ASE_MSA;\r\nif (config3_dyn & MIPS_CONF3_MSA)\r\nc->guest.ases_dyn |= MIPS_ASE_MSA;\r\nif (config3 & MIPS_CONF_M)\r\nc->guest.conf |= BIT(4);\r\nreturn config3 & MIPS_CONF_M;\r\n}\r\nstatic inline unsigned int decode_guest_config4(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config4;\r\nprobe_gc0_config(config4, config4,\r\nMIPS_CONF_M | MIPS_CONF4_KSCREXIST);\r\nc->guest.kscratch_mask = (config4 & MIPS_CONF4_KSCREXIST)\r\n>> MIPS_CONF4_KSCREXIST_SHIFT;\r\nif (config4 & MIPS_CONF_M)\r\nc->guest.conf |= BIT(5);\r\nreturn config4 & MIPS_CONF_M;\r\n}\r\nstatic inline unsigned int decode_guest_config5(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config5, config5_dyn;\r\nprobe_gc0_config_dyn(config5, config5, config5_dyn,\r\nMIPS_CONF_M | MIPS_CONF5_MRP);\r\nif (config5 & MIPS_CONF5_MRP)\r\nc->guest.options |= MIPS_CPU_MAAR;\r\nif (config5_dyn & MIPS_CONF5_MRP)\r\nc->guest.options_dyn |= MIPS_CPU_MAAR;\r\nif (config5 & MIPS_CONF5_LLB)\r\nc->guest.options |= MIPS_CPU_RW_LLB;\r\nif (config5 & MIPS_CONF_M)\r\nc->guest.conf |= BIT(6);\r\nreturn config5 & MIPS_CONF_M;\r\n}\r\nstatic inline void decode_guest_configs(struct cpuinfo_mips *c)\r\n{\r\nunsigned int ok;\r\nok = decode_guest_config0(c);\r\nif (ok)\r\nok = decode_guest_config1(c);\r\nif (ok)\r\nok = decode_guest_config2(c);\r\nif (ok)\r\nok = decode_guest_config3(c);\r\nif (ok)\r\nok = decode_guest_config4(c);\r\nif (ok)\r\ndecode_guest_config5(c);\r\n}\r\nstatic inline void cpu_probe_guestctl0(struct cpuinfo_mips *c)\r\n{\r\nunsigned int guestctl0, temp;\r\nguestctl0 = read_c0_guestctl0();\r\nif (guestctl0 & MIPS_GCTL0_G0E)\r\nc->options |= MIPS_CPU_GUESTCTL0EXT;\r\nif (guestctl0 & MIPS_GCTL0_G1)\r\nc->options |= MIPS_CPU_GUESTCTL1;\r\nif (guestctl0 & MIPS_GCTL0_G2)\r\nc->options |= MIPS_CPU_GUESTCTL2;\r\nif (!(guestctl0 & MIPS_GCTL0_RAD)) {\r\nc->options |= MIPS_CPU_GUESTID;\r\nwrite_c0_guestctl1(0);\r\ntlbw_use_hazard();\r\nwrite_c0_guestctl0(guestctl0 | MIPS_GCTL0_DRG);\r\nback_to_back_c0_hazard();\r\ntemp = read_c0_guestctl0();\r\nif (temp & MIPS_GCTL0_DRG) {\r\nwrite_c0_guestctl0(guestctl0);\r\nc->options |= MIPS_CPU_DRG;\r\n}\r\n}\r\n}\r\nstatic inline void cpu_probe_guestctl1(struct cpuinfo_mips *c)\r\n{\r\nif (cpu_has_guestid) {\r\nwrite_c0_guestctl1(MIPS_GCTL1_ID);\r\nback_to_back_c0_hazard();\r\nc->guestid_mask = (read_c0_guestctl1() & MIPS_GCTL1_ID)\r\n>> MIPS_GCTL1_ID_SHIFT;\r\nwrite_c0_guestctl1(0);\r\n}\r\n}\r\nstatic inline void cpu_probe_gtoffset(struct cpuinfo_mips *c)\r\n{\r\nwrite_c0_gtoffset(0xffffffff);\r\nback_to_back_c0_hazard();\r\nc->gtoffset_mask = read_c0_gtoffset();\r\nwrite_c0_gtoffset(0);\r\n}\r\nstatic inline void cpu_probe_vz(struct cpuinfo_mips *c)\r\n{\r\ncpu_probe_guestctl0(c);\r\nif (cpu_has_guestctl1)\r\ncpu_probe_guestctl1(c);\r\ncpu_probe_gtoffset(c);\r\ndecode_guest_configs(c);\r\n}\r\nstatic inline void cpu_probe_legacy(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\nswitch (c->processor_id & PRID_IMP_MASK) {\r\ncase PRID_IMP_R2000:\r\nc->cputype = CPU_R2000;\r\n__cpu_name[cpu] = "R2000";\r\nc->fpu_msk31 |= FPU_CSR_CONDX | FPU_CSR_FS;\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_3K_CACHE |\r\nMIPS_CPU_NOFPUEX;\r\nif (__cpu_has_fpu())\r\nc->options |= MIPS_CPU_FPU;\r\nc->tlbsize = 64;\r\nbreak;\r\ncase PRID_IMP_R3000:\r\nif ((c->processor_id & PRID_REV_MASK) == PRID_REV_R3000A) {\r\nif (cpu_has_confreg()) {\r\nc->cputype = CPU_R3081E;\r\n__cpu_name[cpu] = "R3081";\r\n} else {\r\nc->cputype = CPU_R3000A;\r\n__cpu_name[cpu] = "R3000A";\r\n}\r\n} else {\r\nc->cputype = CPU_R3000;\r\n__cpu_name[cpu] = "R3000";\r\n}\r\nc->fpu_msk31 |= FPU_CSR_CONDX | FPU_CSR_FS;\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_3K_CACHE |\r\nMIPS_CPU_NOFPUEX;\r\nif (__cpu_has_fpu())\r\nc->options |= MIPS_CPU_FPU;\r\nc->tlbsize = 64;\r\nbreak;\r\ncase PRID_IMP_R4000:\r\nif (read_c0_config() & CONF_SC) {\r\nif ((c->processor_id & PRID_REV_MASK) >=\r\nPRID_REV_R4400) {\r\nc->cputype = CPU_R4400PC;\r\n__cpu_name[cpu] = "R4400PC";\r\n} else {\r\nc->cputype = CPU_R4000PC;\r\n__cpu_name[cpu] = "R4000PC";\r\n}\r\n} else {\r\nint cca = read_c0_config() & CONF_CM_CMASK;\r\nint mc;\r\nswitch (cca) {\r\ncase CONF_CM_CACHABLE_CE:\r\ncase CONF_CM_CACHABLE_COW:\r\ncase CONF_CM_CACHABLE_CUW:\r\nmc = 1;\r\nbreak;\r\ndefault:\r\nmc = 0;\r\nbreak;\r\n}\r\nif ((c->processor_id & PRID_REV_MASK) >=\r\nPRID_REV_R4400) {\r\nc->cputype = mc ? CPU_R4400MC : CPU_R4400SC;\r\n__cpu_name[cpu] = mc ? "R4400MC" : "R4400SC";\r\n} else {\r\nc->cputype = mc ? CPU_R4000MC : CPU_R4000SC;\r\n__cpu_name[cpu] = mc ? "R4000MC" : "R4000SC";\r\n}\r\n}\r\nset_isa(c, MIPS_CPU_ISA_III);\r\nc->fpu_msk31 |= FPU_CSR_CONDX;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_WATCH | MIPS_CPU_VCE |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\ncase PRID_IMP_VR41XX:\r\nset_isa(c, MIPS_CPU_ISA_III);\r\nc->fpu_msk31 |= FPU_CSR_CONDX;\r\nc->options = R4K_OPTS;\r\nc->tlbsize = 32;\r\nswitch (c->processor_id & 0xf0) {\r\ncase PRID_REV_VR4111:\r\nc->cputype = CPU_VR4111;\r\n__cpu_name[cpu] = "NEC VR4111";\r\nbreak;\r\ncase PRID_REV_VR4121:\r\nc->cputype = CPU_VR4121;\r\n__cpu_name[cpu] = "NEC VR4121";\r\nbreak;\r\ncase PRID_REV_VR4122:\r\nif ((c->processor_id & 0xf) < 0x3) {\r\nc->cputype = CPU_VR4122;\r\n__cpu_name[cpu] = "NEC VR4122";\r\n} else {\r\nc->cputype = CPU_VR4181A;\r\n__cpu_name[cpu] = "NEC VR4181A";\r\n}\r\nbreak;\r\ncase PRID_REV_VR4130:\r\nif ((c->processor_id & 0xf) < 0x4) {\r\nc->cputype = CPU_VR4131;\r\n__cpu_name[cpu] = "NEC VR4131";\r\n} else {\r\nc->cputype = CPU_VR4133;\r\nc->options |= MIPS_CPU_LLSC;\r\n__cpu_name[cpu] = "NEC VR4133";\r\n}\r\nbreak;\r\ndefault:\r\nprintk(KERN_INFO "Unexpected CPU of NEC VR4100 series\n");\r\nc->cputype = CPU_VR41XX;\r\n__cpu_name[cpu] = "NEC Vr41xx";\r\nbreak;\r\n}\r\nbreak;\r\ncase PRID_IMP_R4300:\r\nc->cputype = CPU_R4300;\r\n__cpu_name[cpu] = "R4300";\r\nset_isa(c, MIPS_CPU_ISA_III);\r\nc->fpu_msk31 |= FPU_CSR_CONDX;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 32;\r\nbreak;\r\ncase PRID_IMP_R4600:\r\nc->cputype = CPU_R4600;\r\n__cpu_name[cpu] = "R4600";\r\nset_isa(c, MIPS_CPU_ISA_III);\r\nc->fpu_msk31 |= FPU_CSR_CONDX;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\n#if 0\r\ncase PRID_IMP_R4650:\r\nc->cputype = CPU_R4650;\r\n__cpu_name[cpu] = "R4650";\r\nset_isa(c, MIPS_CPU_ISA_III);\r\nc->fpu_msk31 |= FPU_CSR_CONDX;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\n#endif\r\ncase PRID_IMP_TX39:\r\nc->fpu_msk31 |= FPU_CSR_CONDX | FPU_CSR_FS;\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_TX39_CACHE;\r\nif ((c->processor_id & 0xf0) == (PRID_REV_TX3927 & 0xf0)) {\r\nc->cputype = CPU_TX3927;\r\n__cpu_name[cpu] = "TX3927";\r\nc->tlbsize = 64;\r\n} else {\r\nswitch (c->processor_id & PRID_REV_MASK) {\r\ncase PRID_REV_TX3912:\r\nc->cputype = CPU_TX3912;\r\n__cpu_name[cpu] = "TX3912";\r\nc->tlbsize = 32;\r\nbreak;\r\ncase PRID_REV_TX3922:\r\nc->cputype = CPU_TX3922;\r\n__cpu_name[cpu] = "TX3922";\r\nc->tlbsize = 64;\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ncase PRID_IMP_R4700:\r\nc->cputype = CPU_R4700;\r\n__cpu_name[cpu] = "R4700";\r\nset_isa(c, MIPS_CPU_ISA_III);\r\nc->fpu_msk31 |= FPU_CSR_CONDX;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\ncase PRID_IMP_TX49:\r\nc->cputype = CPU_TX49XX;\r\n__cpu_name[cpu] = "R49XX";\r\nset_isa(c, MIPS_CPU_ISA_III);\r\nc->fpu_msk31 |= FPU_CSR_CONDX;\r\nc->options = R4K_OPTS | MIPS_CPU_LLSC;\r\nif (!(c->processor_id & 0x08))\r\nc->options |= MIPS_CPU_FPU | MIPS_CPU_32FPR;\r\nc->tlbsize = 48;\r\nbreak;\r\ncase PRID_IMP_R5000:\r\nc->cputype = CPU_R5000;\r\n__cpu_name[cpu] = "R5000";\r\nset_isa(c, MIPS_CPU_ISA_IV);\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\ncase PRID_IMP_R5432:\r\nc->cputype = CPU_R5432;\r\n__cpu_name[cpu] = "R5432";\r\nset_isa(c, MIPS_CPU_ISA_IV);\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_WATCH | MIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\ncase PRID_IMP_R5500:\r\nc->cputype = CPU_R5500;\r\n__cpu_name[cpu] = "R5500";\r\nset_isa(c, MIPS_CPU_ISA_IV);\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_WATCH | MIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\ncase PRID_IMP_NEVADA:\r\nc->cputype = CPU_NEVADA;\r\n__cpu_name[cpu] = "Nevada";\r\nset_isa(c, MIPS_CPU_ISA_IV);\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_DIVEC | MIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\ncase PRID_IMP_R6000:\r\nc->cputype = CPU_R6000;\r\n__cpu_name[cpu] = "R6000";\r\nset_isa(c, MIPS_CPU_ISA_II);\r\nc->fpu_msk31 |= FPU_CSR_CONDX | FPU_CSR_FS;\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_FPU |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 32;\r\nbreak;\r\ncase PRID_IMP_R6000A:\r\nc->cputype = CPU_R6000A;\r\n__cpu_name[cpu] = "R6000A";\r\nset_isa(c, MIPS_CPU_ISA_II);\r\nc->fpu_msk31 |= FPU_CSR_CONDX | FPU_CSR_FS;\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_FPU |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 32;\r\nbreak;\r\ncase PRID_IMP_RM7000:\r\nc->cputype = CPU_RM7000;\r\n__cpu_name[cpu] = "RM7000";\r\nset_isa(c, MIPS_CPU_ISA_IV);\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = (read_c0_info() & (1 << 29)) ? 64 : 48;\r\nbreak;\r\ncase PRID_IMP_R8000:\r\nc->cputype = CPU_R8000;\r\n__cpu_name[cpu] = "RM8000";\r\nset_isa(c, MIPS_CPU_ISA_IV);\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_4KEX |\r\nMIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 384;\r\nbreak;\r\ncase PRID_IMP_R10000:\r\nc->cputype = CPU_R10000;\r\n__cpu_name[cpu] = "R10000";\r\nset_isa(c, MIPS_CPU_ISA_IV);\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_4K_CACHE | MIPS_CPU_4KEX |\r\nMIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_COUNTER | MIPS_CPU_WATCH |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 64;\r\nbreak;\r\ncase PRID_IMP_R12000:\r\nc->cputype = CPU_R12000;\r\n__cpu_name[cpu] = "R12000";\r\nset_isa(c, MIPS_CPU_ISA_IV);\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_4K_CACHE | MIPS_CPU_4KEX |\r\nMIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_COUNTER | MIPS_CPU_WATCH |\r\nMIPS_CPU_LLSC | MIPS_CPU_BP_GHIST;\r\nc->tlbsize = 64;\r\nbreak;\r\ncase PRID_IMP_R14000:\r\nif (((c->processor_id >> 4) & 0x0f) > 2) {\r\nc->cputype = CPU_R16000;\r\n__cpu_name[cpu] = "R16000";\r\n} else {\r\nc->cputype = CPU_R14000;\r\n__cpu_name[cpu] = "R14000";\r\n}\r\nset_isa(c, MIPS_CPU_ISA_IV);\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_4K_CACHE | MIPS_CPU_4KEX |\r\nMIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_COUNTER | MIPS_CPU_WATCH |\r\nMIPS_CPU_LLSC | MIPS_CPU_BP_GHIST;\r\nc->tlbsize = 64;\r\nbreak;\r\ncase PRID_IMP_LOONGSON_64:\r\nswitch (c->processor_id & PRID_REV_MASK) {\r\ncase PRID_REV_LOONGSON2E:\r\nc->cputype = CPU_LOONGSON2;\r\n__cpu_name[cpu] = "ICT Loongson-2";\r\nset_elf_platform(cpu, "loongson2e");\r\nset_isa(c, MIPS_CPU_ISA_III);\r\nc->fpu_msk31 |= FPU_CSR_CONDX;\r\nbreak;\r\ncase PRID_REV_LOONGSON2F:\r\nc->cputype = CPU_LOONGSON2;\r\n__cpu_name[cpu] = "ICT Loongson-2";\r\nset_elf_platform(cpu, "loongson2f");\r\nset_isa(c, MIPS_CPU_ISA_III);\r\nc->fpu_msk31 |= FPU_CSR_CONDX;\r\nbreak;\r\ncase PRID_REV_LOONGSON3A_R1:\r\nc->cputype = CPU_LOONGSON3;\r\n__cpu_name[cpu] = "ICT Loongson-3";\r\nset_elf_platform(cpu, "loongson3a");\r\nset_isa(c, MIPS_CPU_ISA_M64R1);\r\nbreak;\r\ncase PRID_REV_LOONGSON3B_R1:\r\ncase PRID_REV_LOONGSON3B_R2:\r\nc->cputype = CPU_LOONGSON3;\r\n__cpu_name[cpu] = "ICT Loongson-3";\r\nset_elf_platform(cpu, "loongson3b");\r\nset_isa(c, MIPS_CPU_ISA_M64R1);\r\nbreak;\r\n}\r\nc->options = R4K_OPTS |\r\nMIPS_CPU_FPU | MIPS_CPU_LLSC |\r\nMIPS_CPU_32FPR;\r\nc->tlbsize = 64;\r\nc->writecombine = _CACHE_UNCACHED_ACCELERATED;\r\nbreak;\r\ncase PRID_IMP_LOONGSON_32:\r\ndecode_configs(c);\r\nc->cputype = CPU_LOONGSON1;\r\nswitch (c->processor_id & PRID_REV_MASK) {\r\ncase PRID_REV_LOONGSON1B:\r\n__cpu_name[cpu] = "Loongson 1B";\r\nbreak;\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_mips(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\nc->writecombine = _CACHE_UNCACHED_ACCELERATED;\r\nswitch (c->processor_id & PRID_IMP_MASK) {\r\ncase PRID_IMP_QEMU_GENERIC:\r\nc->writecombine = _CACHE_UNCACHED;\r\nc->cputype = CPU_QEMU_GENERIC;\r\n__cpu_name[cpu] = "MIPS GENERIC QEMU";\r\nbreak;\r\ncase PRID_IMP_4KC:\r\nc->cputype = CPU_4KC;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS 4Kc";\r\nbreak;\r\ncase PRID_IMP_4KEC:\r\ncase PRID_IMP_4KECR2:\r\nc->cputype = CPU_4KEC;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS 4KEc";\r\nbreak;\r\ncase PRID_IMP_4KSC:\r\ncase PRID_IMP_4KSD:\r\nc->cputype = CPU_4KSC;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS 4KSc";\r\nbreak;\r\ncase PRID_IMP_5KC:\r\nc->cputype = CPU_5KC;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS 5Kc";\r\nbreak;\r\ncase PRID_IMP_5KE:\r\nc->cputype = CPU_5KE;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS 5KE";\r\nbreak;\r\ncase PRID_IMP_20KC:\r\nc->cputype = CPU_20KC;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS 20Kc";\r\nbreak;\r\ncase PRID_IMP_24K:\r\nc->cputype = CPU_24K;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS 24Kc";\r\nbreak;\r\ncase PRID_IMP_24KE:\r\nc->cputype = CPU_24K;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS 24KEc";\r\nbreak;\r\ncase PRID_IMP_25KF:\r\nc->cputype = CPU_25KF;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS 25Kc";\r\nbreak;\r\ncase PRID_IMP_34K:\r\nc->cputype = CPU_34K;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS 34Kc";\r\nbreak;\r\ncase PRID_IMP_74K:\r\nc->cputype = CPU_74K;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS 74Kc";\r\nbreak;\r\ncase PRID_IMP_M14KC:\r\nc->cputype = CPU_M14KC;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS M14Kc";\r\nbreak;\r\ncase PRID_IMP_M14KEC:\r\nc->cputype = CPU_M14KEC;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS M14KEc";\r\nbreak;\r\ncase PRID_IMP_1004K:\r\nc->cputype = CPU_1004K;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS 1004Kc";\r\nbreak;\r\ncase PRID_IMP_1074K:\r\nc->cputype = CPU_1074K;\r\nc->writecombine = _CACHE_UNCACHED;\r\n__cpu_name[cpu] = "MIPS 1074Kc";\r\nbreak;\r\ncase PRID_IMP_INTERAPTIV_UP:\r\nc->cputype = CPU_INTERAPTIV;\r\n__cpu_name[cpu] = "MIPS interAptiv";\r\nbreak;\r\ncase PRID_IMP_INTERAPTIV_MP:\r\nc->cputype = CPU_INTERAPTIV;\r\n__cpu_name[cpu] = "MIPS interAptiv (multi)";\r\nbreak;\r\ncase PRID_IMP_PROAPTIV_UP:\r\nc->cputype = CPU_PROAPTIV;\r\n__cpu_name[cpu] = "MIPS proAptiv";\r\nbreak;\r\ncase PRID_IMP_PROAPTIV_MP:\r\nc->cputype = CPU_PROAPTIV;\r\n__cpu_name[cpu] = "MIPS proAptiv (multi)";\r\nbreak;\r\ncase PRID_IMP_P5600:\r\nc->cputype = CPU_P5600;\r\n__cpu_name[cpu] = "MIPS P5600";\r\nbreak;\r\ncase PRID_IMP_P6600:\r\nc->cputype = CPU_P6600;\r\n__cpu_name[cpu] = "MIPS P6600";\r\nbreak;\r\ncase PRID_IMP_I6400:\r\nc->cputype = CPU_I6400;\r\n__cpu_name[cpu] = "MIPS I6400";\r\nbreak;\r\ncase PRID_IMP_M5150:\r\nc->cputype = CPU_M5150;\r\n__cpu_name[cpu] = "MIPS M5150";\r\nbreak;\r\ncase PRID_IMP_M6250:\r\nc->cputype = CPU_M6250;\r\n__cpu_name[cpu] = "MIPS M6250";\r\nbreak;\r\n}\r\ndecode_configs(c);\r\nspram_config();\r\n}\r\nstatic inline void cpu_probe_alchemy(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nswitch (c->processor_id & PRID_IMP_MASK) {\r\ncase PRID_IMP_AU1_REV1:\r\ncase PRID_IMP_AU1_REV2:\r\nc->cputype = CPU_ALCHEMY;\r\nswitch ((c->processor_id >> 24) & 0xff) {\r\ncase 0:\r\n__cpu_name[cpu] = "Au1000";\r\nbreak;\r\ncase 1:\r\n__cpu_name[cpu] = "Au1500";\r\nbreak;\r\ncase 2:\r\n__cpu_name[cpu] = "Au1100";\r\nbreak;\r\ncase 3:\r\n__cpu_name[cpu] = "Au1550";\r\nbreak;\r\ncase 4:\r\n__cpu_name[cpu] = "Au1200";\r\nif ((c->processor_id & PRID_REV_MASK) == 2)\r\n__cpu_name[cpu] = "Au1250";\r\nbreak;\r\ncase 5:\r\n__cpu_name[cpu] = "Au1210";\r\nbreak;\r\ndefault:\r\n__cpu_name[cpu] = "Au1xxx";\r\nbreak;\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_sibyte(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nc->writecombine = _CACHE_UNCACHED_ACCELERATED;\r\nswitch (c->processor_id & PRID_IMP_MASK) {\r\ncase PRID_IMP_SB1:\r\nc->cputype = CPU_SB1;\r\n__cpu_name[cpu] = "SiByte SB1";\r\nif ((c->processor_id & PRID_REV_MASK) < 0x02)\r\nc->options &= ~(MIPS_CPU_FPU | MIPS_CPU_32FPR);\r\nbreak;\r\ncase PRID_IMP_SB1A:\r\nc->cputype = CPU_SB1A;\r\n__cpu_name[cpu] = "SiByte SB1A";\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_sandcraft(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nswitch (c->processor_id & PRID_IMP_MASK) {\r\ncase PRID_IMP_SR71000:\r\nc->cputype = CPU_SR71000;\r\n__cpu_name[cpu] = "Sandcraft SR71000";\r\nc->scache.ways = 8;\r\nc->tlbsize = 64;\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_nxp(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nswitch (c->processor_id & PRID_IMP_MASK) {\r\ncase PRID_IMP_PR4450:\r\nc->cputype = CPU_PR4450;\r\n__cpu_name[cpu] = "Philips PR4450";\r\nset_isa(c, MIPS_CPU_ISA_M32R1);\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_broadcom(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nswitch (c->processor_id & PRID_IMP_MASK) {\r\ncase PRID_IMP_BMIPS32_REV4:\r\ncase PRID_IMP_BMIPS32_REV8:\r\nc->cputype = CPU_BMIPS32;\r\n__cpu_name[cpu] = "Broadcom BMIPS32";\r\nset_elf_platform(cpu, "bmips32");\r\nbreak;\r\ncase PRID_IMP_BMIPS3300:\r\ncase PRID_IMP_BMIPS3300_ALT:\r\ncase PRID_IMP_BMIPS3300_BUG:\r\nc->cputype = CPU_BMIPS3300;\r\n__cpu_name[cpu] = "Broadcom BMIPS3300";\r\nset_elf_platform(cpu, "bmips3300");\r\nbreak;\r\ncase PRID_IMP_BMIPS43XX: {\r\nint rev = c->processor_id & PRID_REV_MASK;\r\nif (rev >= PRID_REV_BMIPS4380_LO &&\r\nrev <= PRID_REV_BMIPS4380_HI) {\r\nc->cputype = CPU_BMIPS4380;\r\n__cpu_name[cpu] = "Broadcom BMIPS4380";\r\nset_elf_platform(cpu, "bmips4380");\r\nc->options |= MIPS_CPU_RIXI;\r\n} else {\r\nc->cputype = CPU_BMIPS4350;\r\n__cpu_name[cpu] = "Broadcom BMIPS4350";\r\nset_elf_platform(cpu, "bmips4350");\r\n}\r\nbreak;\r\n}\r\ncase PRID_IMP_BMIPS5000:\r\ncase PRID_IMP_BMIPS5200:\r\nc->cputype = CPU_BMIPS5000;\r\nif ((c->processor_id & PRID_IMP_MASK) == PRID_IMP_BMIPS5200)\r\n__cpu_name[cpu] = "Broadcom BMIPS5200";\r\nelse\r\n__cpu_name[cpu] = "Broadcom BMIPS5000";\r\nset_elf_platform(cpu, "bmips5000");\r\nc->options |= MIPS_CPU_ULRI | MIPS_CPU_RIXI;\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_cavium(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nswitch (c->processor_id & PRID_IMP_MASK) {\r\ncase PRID_IMP_CAVIUM_CN38XX:\r\ncase PRID_IMP_CAVIUM_CN31XX:\r\ncase PRID_IMP_CAVIUM_CN30XX:\r\nc->cputype = CPU_CAVIUM_OCTEON;\r\n__cpu_name[cpu] = "Cavium Octeon";\r\ngoto platform;\r\ncase PRID_IMP_CAVIUM_CN58XX:\r\ncase PRID_IMP_CAVIUM_CN56XX:\r\ncase PRID_IMP_CAVIUM_CN50XX:\r\ncase PRID_IMP_CAVIUM_CN52XX:\r\nc->cputype = CPU_CAVIUM_OCTEON_PLUS;\r\n__cpu_name[cpu] = "Cavium Octeon+";\r\nplatform:\r\nset_elf_platform(cpu, "octeon");\r\nbreak;\r\ncase PRID_IMP_CAVIUM_CN61XX:\r\ncase PRID_IMP_CAVIUM_CN63XX:\r\ncase PRID_IMP_CAVIUM_CN66XX:\r\ncase PRID_IMP_CAVIUM_CN68XX:\r\ncase PRID_IMP_CAVIUM_CNF71XX:\r\nc->cputype = CPU_CAVIUM_OCTEON2;\r\n__cpu_name[cpu] = "Cavium Octeon II";\r\nset_elf_platform(cpu, "octeon2");\r\nbreak;\r\ncase PRID_IMP_CAVIUM_CN70XX:\r\ncase PRID_IMP_CAVIUM_CN73XX:\r\ncase PRID_IMP_CAVIUM_CNF75XX:\r\ncase PRID_IMP_CAVIUM_CN78XX:\r\nc->cputype = CPU_CAVIUM_OCTEON3;\r\n__cpu_name[cpu] = "Cavium Octeon III";\r\nset_elf_platform(cpu, "octeon3");\r\nbreak;\r\ndefault:\r\nprintk(KERN_INFO "Unknown Octeon chip!\n");\r\nc->cputype = CPU_UNKNOWN;\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_loongson(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\nswitch (c->processor_id & PRID_IMP_MASK) {\r\ncase PRID_IMP_LOONGSON_64:\r\nswitch (c->processor_id & PRID_REV_MASK) {\r\ncase PRID_REV_LOONGSON3A_R2:\r\nc->cputype = CPU_LOONGSON3;\r\n__cpu_name[cpu] = "ICT Loongson-3";\r\nset_elf_platform(cpu, "loongson3a");\r\nset_isa(c, MIPS_CPU_ISA_M64R2);\r\nbreak;\r\n}\r\ndecode_configs(c);\r\nc->options |= MIPS_CPU_TLBINV | MIPS_CPU_LDPTE;\r\nc->writecombine = _CACHE_UNCACHED_ACCELERATED;\r\nbreak;\r\ndefault:\r\npanic("Unknown Loongson Processor ID!");\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_ingenic(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nc->options &= ~MIPS_CPU_COUNTER;\r\nBUG_ON(!__builtin_constant_p(cpu_has_counter) || cpu_has_counter);\r\nswitch (c->processor_id & PRID_IMP_MASK) {\r\ncase PRID_IMP_JZRISC:\r\nc->cputype = CPU_JZRISC;\r\nc->writecombine = _CACHE_UNCACHED_ACCELERATED;\r\n__cpu_name[cpu] = "Ingenic JZRISC";\r\nbreak;\r\ndefault:\r\npanic("Unknown Ingenic Processor ID!");\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_netlogic(struct cpuinfo_mips *c, int cpu)\r\n{\r\ndecode_configs(c);\r\nif ((c->processor_id & PRID_IMP_MASK) == PRID_IMP_NETLOGIC_AU13XX) {\r\nc->cputype = CPU_ALCHEMY;\r\n__cpu_name[cpu] = "Au1300";\r\nreturn;\r\n}\r\nc->options = (MIPS_CPU_TLB |\r\nMIPS_CPU_4KEX |\r\nMIPS_CPU_COUNTER |\r\nMIPS_CPU_DIVEC |\r\nMIPS_CPU_WATCH |\r\nMIPS_CPU_EJTAG |\r\nMIPS_CPU_LLSC);\r\nswitch (c->processor_id & PRID_IMP_MASK) {\r\ncase PRID_IMP_NETLOGIC_XLP2XX:\r\ncase PRID_IMP_NETLOGIC_XLP9XX:\r\ncase PRID_IMP_NETLOGIC_XLP5XX:\r\nc->cputype = CPU_XLP;\r\n__cpu_name[cpu] = "Broadcom XLPII";\r\nbreak;\r\ncase PRID_IMP_NETLOGIC_XLP8XX:\r\ncase PRID_IMP_NETLOGIC_XLP3XX:\r\nc->cputype = CPU_XLP;\r\n__cpu_name[cpu] = "Netlogic XLP";\r\nbreak;\r\ncase PRID_IMP_NETLOGIC_XLR732:\r\ncase PRID_IMP_NETLOGIC_XLR716:\r\ncase PRID_IMP_NETLOGIC_XLR532:\r\ncase PRID_IMP_NETLOGIC_XLR308:\r\ncase PRID_IMP_NETLOGIC_XLR532C:\r\ncase PRID_IMP_NETLOGIC_XLR516C:\r\ncase PRID_IMP_NETLOGIC_XLR508C:\r\ncase PRID_IMP_NETLOGIC_XLR308C:\r\nc->cputype = CPU_XLR;\r\n__cpu_name[cpu] = "Netlogic XLR";\r\nbreak;\r\ncase PRID_IMP_NETLOGIC_XLS608:\r\ncase PRID_IMP_NETLOGIC_XLS408:\r\ncase PRID_IMP_NETLOGIC_XLS404:\r\ncase PRID_IMP_NETLOGIC_XLS208:\r\ncase PRID_IMP_NETLOGIC_XLS204:\r\ncase PRID_IMP_NETLOGIC_XLS108:\r\ncase PRID_IMP_NETLOGIC_XLS104:\r\ncase PRID_IMP_NETLOGIC_XLS616B:\r\ncase PRID_IMP_NETLOGIC_XLS608B:\r\ncase PRID_IMP_NETLOGIC_XLS416B:\r\ncase PRID_IMP_NETLOGIC_XLS412B:\r\ncase PRID_IMP_NETLOGIC_XLS408B:\r\ncase PRID_IMP_NETLOGIC_XLS404B:\r\nc->cputype = CPU_XLR;\r\n__cpu_name[cpu] = "Netlogic XLS";\r\nbreak;\r\ndefault:\r\npr_info("Unknown Netlogic chip id [%02x]!\n",\r\nc->processor_id);\r\nc->cputype = CPU_XLR;\r\nbreak;\r\n}\r\nif (c->cputype == CPU_XLP) {\r\nset_isa(c, MIPS_CPU_ISA_M64R2);\r\nc->options |= (MIPS_CPU_FPU | MIPS_CPU_ULRI | MIPS_CPU_MCHECK);\r\nc->tlbsize = ((read_c0_config6() >> 16) & 0xffff) + 1;\r\n} else {\r\nset_isa(c, MIPS_CPU_ISA_M64R1);\r\nc->tlbsize = ((read_c0_config1() >> 25) & 0x3f) + 1;\r\n}\r\nc->kscratch_mask = 0xf;\r\n}\r\nvoid cpu_probe(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nunsigned int cpu = smp_processor_id();\r\nc->processor_id = PRID_IMP_UNKNOWN;\r\nc->fpu_id = FPIR_IMP_NONE;\r\nc->cputype = CPU_UNKNOWN;\r\nc->writecombine = _CACHE_UNCACHED;\r\nc->fpu_csr31 = FPU_CSR_RN;\r\nc->fpu_msk31 = FPU_CSR_RSVD | FPU_CSR_ABS2008 | FPU_CSR_NAN2008;\r\nc->processor_id = read_c0_prid();\r\nswitch (c->processor_id & PRID_COMP_MASK) {\r\ncase PRID_COMP_LEGACY:\r\ncpu_probe_legacy(c, cpu);\r\nbreak;\r\ncase PRID_COMP_MIPS:\r\ncpu_probe_mips(c, cpu);\r\nbreak;\r\ncase PRID_COMP_ALCHEMY:\r\ncpu_probe_alchemy(c, cpu);\r\nbreak;\r\ncase PRID_COMP_SIBYTE:\r\ncpu_probe_sibyte(c, cpu);\r\nbreak;\r\ncase PRID_COMP_BROADCOM:\r\ncpu_probe_broadcom(c, cpu);\r\nbreak;\r\ncase PRID_COMP_SANDCRAFT:\r\ncpu_probe_sandcraft(c, cpu);\r\nbreak;\r\ncase PRID_COMP_NXP:\r\ncpu_probe_nxp(c, cpu);\r\nbreak;\r\ncase PRID_COMP_CAVIUM:\r\ncpu_probe_cavium(c, cpu);\r\nbreak;\r\ncase PRID_COMP_LOONGSON:\r\ncpu_probe_loongson(c, cpu);\r\nbreak;\r\ncase PRID_COMP_INGENIC_D0:\r\ncase PRID_COMP_INGENIC_D1:\r\ncase PRID_COMP_INGENIC_E1:\r\ncpu_probe_ingenic(c, cpu);\r\nbreak;\r\ncase PRID_COMP_NETLOGIC:\r\ncpu_probe_netlogic(c, cpu);\r\nbreak;\r\n}\r\nBUG_ON(!__cpu_name[cpu]);\r\nBUG_ON(c->cputype == CPU_UNKNOWN);\r\nBUG_ON(current_cpu_type() != c->cputype);\r\nif (cpu_has_rixi) {\r\nset_c0_pagegrain(PG_IEC);\r\nback_to_back_c0_hazard();\r\nif (read_c0_pagegrain() & PG_IEC)\r\nc->options |= MIPS_CPU_RIXIEX;\r\n}\r\nif (mips_fpu_disabled)\r\nc->options &= ~MIPS_CPU_FPU;\r\nif (mips_dsp_disabled)\r\nc->ases &= ~(MIPS_ASE_DSP | MIPS_ASE_DSP2P);\r\nif (mips_htw_disabled) {\r\nc->options &= ~MIPS_CPU_HTW;\r\nwrite_c0_pwctl(read_c0_pwctl() &\r\n~(1 << MIPS_PWCTL_PWEN_SHIFT));\r\n}\r\nif (c->options & MIPS_CPU_FPU)\r\ncpu_set_fpu_opts(c);\r\nelse\r\ncpu_set_nofpu_opts(c);\r\nif (cpu_has_bp_ghist)\r\nwrite_c0_r10k_diag(read_c0_r10k_diag() |\r\nR10K_DIAG_E_GHIST);\r\nif (cpu_has_mips_r2_r6) {\r\nc->srsets = ((read_c0_srsctl() >> 26) & 0x0f) + 1;\r\nc->options |= MIPS_CPU_PCI;\r\n}\r\nelse\r\nc->srsets = 1;\r\nif (cpu_has_mips_r6)\r\nelf_hwcap |= HWCAP_MIPS_R6;\r\nif (cpu_has_msa) {\r\nc->msa_id = cpu_get_msa_id();\r\nWARN(c->msa_id & MSA_IR_WRPF,\r\n"Vector register partitioning unimplemented!");\r\nelf_hwcap |= HWCAP_MIPS_MSA;\r\n}\r\nif (cpu_has_vz)\r\ncpu_probe_vz(c);\r\ncpu_probe_vmbits(c);\r\n#ifdef CONFIG_64BIT\r\nif (cpu == 0)\r\n__ua_limit = ~((1ull << cpu_vmbits) - 1);\r\n#endif\r\n}\r\nvoid cpu_report(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\npr_info("CPU%d revision is: %08x (%s)\n",\r\nsmp_processor_id(), c->processor_id, cpu_name_string());\r\nif (c->options & MIPS_CPU_FPU)\r\nprintk(KERN_INFO "FPU revision is: %08x\n", c->fpu_id);\r\nif (cpu_has_msa)\r\npr_info("MSA revision is: %08x\n", c->msa_id);\r\n}

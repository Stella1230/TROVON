static inline void lirc_rx51_on(struct lirc_rx51 *lirc_rx51)\r\n{\r\npwm_enable(lirc_rx51->pwm);\r\n}\r\nstatic inline void lirc_rx51_off(struct lirc_rx51 *lirc_rx51)\r\n{\r\npwm_disable(lirc_rx51->pwm);\r\n}\r\nstatic int init_timing_params(struct lirc_rx51 *lirc_rx51)\r\n{\r\nstruct pwm_device *pwm = lirc_rx51->pwm;\r\nint duty, period = DIV_ROUND_CLOSEST(NSEC_PER_SEC, lirc_rx51->freq);\r\nduty = DIV_ROUND_CLOSEST(lirc_rx51->duty_cycle * period, 100);\r\npwm_config(pwm, duty, period);\r\nreturn 0;\r\n}\r\nstatic enum hrtimer_restart lirc_rx51_timer_cb(struct hrtimer *timer)\r\n{\r\nstruct lirc_rx51 *lirc_rx51 =\r\ncontainer_of(timer, struct lirc_rx51, timer);\r\nktime_t now;\r\nif (lirc_rx51->wbuf_index < 0) {\r\ndev_err_ratelimited(lirc_rx51->dev,\r\n"BUG wbuf_index has value of %i\n",\r\nlirc_rx51->wbuf_index);\r\ngoto end;\r\n}\r\ndo {\r\nu64 ns;\r\nif (lirc_rx51->wbuf_index >= WBUF_LEN)\r\ngoto end;\r\nif (lirc_rx51->wbuf[lirc_rx51->wbuf_index] == -1)\r\ngoto end;\r\nif (lirc_rx51->wbuf_index % 2)\r\nlirc_rx51_off(lirc_rx51);\r\nelse\r\nlirc_rx51_on(lirc_rx51);\r\nns = 1000 * lirc_rx51->wbuf[lirc_rx51->wbuf_index];\r\nhrtimer_add_expires_ns(timer, ns);\r\nlirc_rx51->wbuf_index++;\r\nnow = timer->base->get_time();\r\n} while (hrtimer_get_expires_tv64(timer) < now.tv64);\r\nreturn HRTIMER_RESTART;\r\nend:\r\nlirc_rx51_off(lirc_rx51);\r\nlirc_rx51->wbuf_index = -1;\r\nwake_up_interruptible(&lirc_rx51->wqueue);\r\nreturn HRTIMER_NORESTART;\r\n}\r\nstatic ssize_t lirc_rx51_write(struct file *file, const char *buf,\r\nsize_t n, loff_t *ppos)\r\n{\r\nint count, i;\r\nstruct lirc_rx51 *lirc_rx51 = file->private_data;\r\nif (n % sizeof(int))\r\nreturn -EINVAL;\r\ncount = n / sizeof(int);\r\nif ((count > WBUF_LEN) || (count % 2 == 0))\r\nreturn -EINVAL;\r\nwait_event_interruptible(lirc_rx51->wqueue, lirc_rx51->wbuf_index < 0);\r\nif (copy_from_user(lirc_rx51->wbuf, buf, n))\r\nreturn -EFAULT;\r\nfor (i = 0; i < count; i++)\r\nif (lirc_rx51->wbuf[i] < 0)\r\nreturn -EINVAL;\r\ninit_timing_params(lirc_rx51);\r\nif (count < WBUF_LEN)\r\nlirc_rx51->wbuf[count] = -1;\r\nlirc_rx51->pdata->set_max_mpu_wakeup_lat(lirc_rx51->dev, 50);\r\nlirc_rx51_on(lirc_rx51);\r\nlirc_rx51->wbuf_index = 1;\r\nhrtimer_start(&lirc_rx51->timer,\r\nns_to_ktime(1000 * lirc_rx51->wbuf[0]),\r\nHRTIMER_MODE_REL);\r\nwait_event_interruptible(lirc_rx51->wqueue, lirc_rx51->wbuf_index < 0);\r\nlirc_rx51->pdata->set_max_mpu_wakeup_lat(lirc_rx51->dev, -1);\r\nreturn n;\r\n}\r\nstatic long lirc_rx51_ioctl(struct file *filep,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nint result;\r\nunsigned long value;\r\nunsigned int ivalue;\r\nstruct lirc_rx51 *lirc_rx51 = filep->private_data;\r\nswitch (cmd) {\r\ncase LIRC_GET_SEND_MODE:\r\nresult = put_user(LIRC_MODE_PULSE, (unsigned long *)arg);\r\nif (result)\r\nreturn result;\r\nbreak;\r\ncase LIRC_SET_SEND_MODE:\r\nresult = get_user(value, (unsigned long *)arg);\r\nif (result)\r\nreturn result;\r\nif (value != LIRC_MODE_PULSE)\r\nreturn -ENOSYS;\r\nbreak;\r\ncase LIRC_GET_REC_MODE:\r\nresult = put_user(0, (unsigned long *) arg);\r\nif (result)\r\nreturn result;\r\nbreak;\r\ncase LIRC_GET_LENGTH:\r\nreturn -ENOSYS;\r\nbreak;\r\ncase LIRC_SET_SEND_DUTY_CYCLE:\r\nresult = get_user(ivalue, (unsigned int *) arg);\r\nif (result)\r\nreturn result;\r\nif (ivalue <= 0 || ivalue > 100) {\r\ndev_err(lirc_rx51->dev, ": invalid duty cycle %d\n",\r\nivalue);\r\nreturn -EINVAL;\r\n}\r\nlirc_rx51->duty_cycle = ivalue;\r\nbreak;\r\ncase LIRC_SET_SEND_CARRIER:\r\nresult = get_user(ivalue, (unsigned int *) arg);\r\nif (result)\r\nreturn result;\r\nif (ivalue > 500000 || ivalue < 20000) {\r\ndev_err(lirc_rx51->dev, ": invalid carrier freq %d\n",\r\nivalue);\r\nreturn -EINVAL;\r\n}\r\nlirc_rx51->freq = ivalue;\r\nbreak;\r\ncase LIRC_GET_FEATURES:\r\nresult = put_user(LIRC_RX51_DRIVER_FEATURES,\r\n(unsigned long *) arg);\r\nif (result)\r\nreturn result;\r\nbreak;\r\ndefault:\r\nreturn -ENOIOCTLCMD;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lirc_rx51_open(struct inode *inode, struct file *file)\r\n{\r\nstruct lirc_rx51 *lirc_rx51 = lirc_get_pdata(file);\r\nBUG_ON(!lirc_rx51);\r\nfile->private_data = lirc_rx51;\r\nif (test_and_set_bit(1, &lirc_rx51->device_is_open))\r\nreturn -EBUSY;\r\nlirc_rx51->pwm = pwm_get(lirc_rx51->dev, NULL);\r\nif (IS_ERR(lirc_rx51->pwm)) {\r\nint res = PTR_ERR(lirc_rx51->pwm);\r\ndev_err(lirc_rx51->dev, "pwm_get failed: %d\n", res);\r\nreturn res;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lirc_rx51_release(struct inode *inode, struct file *file)\r\n{\r\nstruct lirc_rx51 *lirc_rx51 = file->private_data;\r\nhrtimer_cancel(&lirc_rx51->timer);\r\nlirc_rx51_off(lirc_rx51);\r\npwm_put(lirc_rx51->pwm);\r\nclear_bit(1, &lirc_rx51->device_is_open);\r\nreturn 0;\r\n}\r\nstatic int lirc_rx51_suspend(struct platform_device *dev, pm_message_t state)\r\n{\r\nif (test_and_set_bit(1, &lirc_rx51.device_is_open))\r\nreturn -EAGAIN;\r\nclear_bit(1, &lirc_rx51.device_is_open);\r\nreturn 0;\r\n}\r\nstatic int lirc_rx51_resume(struct platform_device *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int lirc_rx51_probe(struct platform_device *dev)\r\n{\r\nstruct pwm_device *pwm;\r\nlirc_rx51_driver.features = LIRC_RX51_DRIVER_FEATURES;\r\nlirc_rx51.pdata = dev->dev.platform_data;\r\nif (!lirc_rx51.pdata) {\r\ndev_err(&dev->dev, "Platform Data is missing\n");\r\nreturn -ENXIO;\r\n}\r\npwm = pwm_get(&dev->dev, NULL);\r\nif (IS_ERR(pwm)) {\r\nint err = PTR_ERR(pwm);\r\nif (err != -EPROBE_DEFER)\r\ndev_err(&dev->dev, "pwm_get failed: %d\n", err);\r\nreturn err;\r\n}\r\nlirc_rx51.freq = DIV_ROUND_CLOSEST(pwm_get_period(pwm), NSEC_PER_SEC);\r\npwm_put(pwm);\r\nhrtimer_init(&lirc_rx51.timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);\r\nlirc_rx51.timer.function = lirc_rx51_timer_cb;\r\nlirc_rx51.dev = &dev->dev;\r\nlirc_rx51_driver.dev = &dev->dev;\r\nlirc_rx51_driver.minor = lirc_register_driver(&lirc_rx51_driver);\r\ninit_waitqueue_head(&lirc_rx51.wqueue);\r\nif (lirc_rx51_driver.minor < 0) {\r\ndev_err(lirc_rx51.dev, ": lirc_register_driver failed: %d\n",\r\nlirc_rx51_driver.minor);\r\nreturn lirc_rx51_driver.minor;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lirc_rx51_remove(struct platform_device *dev)\r\n{\r\nreturn lirc_unregister_driver(lirc_rx51_driver.minor);\r\n}

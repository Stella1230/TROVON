static void seq_printf_with_thousands_grouping(struct seq_file *seq, long v)\r\n{\r\nif (unlikely(v >= 1000000)) {\r\nseq_printf(seq, "%ld,", v / 1000000);\r\nv %= 1000000;\r\nseq_printf(seq, "%03ld,%03ld", v/1000, v % 1000);\r\n} else if (likely(v >= 1000))\r\nseq_printf(seq, "%ld,%03ld", v/1000, v % 1000);\r\nelse\r\nseq_printf(seq, "%ld", v);\r\n}\r\nstatic void drbd_get_syncer_progress(struct drbd_device *device,\r\nunion drbd_dev_state state, unsigned long *rs_total,\r\nunsigned long *bits_left, unsigned int *per_mil_done)\r\n{\r\ntypecheck(unsigned long, device->rs_total);\r\n*rs_total = device->rs_total;\r\nif (state.conn == C_VERIFY_S || state.conn == C_VERIFY_T)\r\n*bits_left = device->ov_left;\r\nelse\r\n*bits_left = drbd_bm_total_weight(device) - device->rs_failed;\r\nif (*bits_left > *rs_total) {\r\n*bits_left = *rs_total;\r\n*per_mil_done = *rs_total ? 0 : 1000;\r\n} else {\r\nunsigned int shift = *rs_total > UINT_MAX ? 16 : 10;\r\nunsigned long left = *bits_left >> shift;\r\nunsigned long total = 1UL + (*rs_total >> shift);\r\nunsigned long tmp = 1000UL - left * 1000UL/total;\r\n*per_mil_done = tmp;\r\n}\r\n}\r\nstatic void drbd_syncer_progress(struct drbd_device *device, struct seq_file *seq,\r\nunion drbd_dev_state state)\r\n{\r\nunsigned long db, dt, dbdt, rt, rs_total, rs_left;\r\nunsigned int res;\r\nint i, x, y;\r\nint stalled = 0;\r\ndrbd_get_syncer_progress(device, state, &rs_total, &rs_left, &res);\r\nx = res/50;\r\ny = 20-x;\r\nseq_puts(seq, "\t[");\r\nfor (i = 1; i < x; i++)\r\nseq_putc(seq, '=');\r\nseq_putc(seq, '>');\r\nfor (i = 0; i < y; i++)\r\nseq_printf(seq, ".");\r\nseq_puts(seq, "] ");\r\nif (state.conn == C_VERIFY_S || state.conn == C_VERIFY_T)\r\nseq_puts(seq, "verified:");\r\nelse\r\nseq_puts(seq, "sync'ed:");\r\nseq_printf(seq, "%3u.%u%% ", res / 10, res % 10);\r\nif (rs_total > (4UL << (30 - BM_BLOCK_SHIFT)))\r\nseq_printf(seq, "(%lu/%lu)M",\r\n(unsigned long) Bit2KB(rs_left >> 10),\r\n(unsigned long) Bit2KB(rs_total >> 10));\r\nelse\r\nseq_printf(seq, "(%lu/%lu)K",\r\n(unsigned long) Bit2KB(rs_left),\r\n(unsigned long) Bit2KB(rs_total));\r\nseq_puts(seq, "\n\t");\r\ni = (device->rs_last_mark + 2) % DRBD_SYNC_MARKS;\r\ndt = (jiffies - device->rs_mark_time[i]) / HZ;\r\nif (dt > 180)\r\nstalled = 1;\r\nif (!dt)\r\ndt++;\r\ndb = device->rs_mark_left[i] - rs_left;\r\nrt = (dt * (rs_left / (db/100+1)))/100;\r\nseq_printf(seq, "finish: %lu:%02lu:%02lu",\r\nrt / 3600, (rt % 3600) / 60, rt % 60);\r\ndbdt = Bit2KB(db/dt);\r\nseq_puts(seq, " speed: ");\r\nseq_printf_with_thousands_grouping(seq, dbdt);\r\nseq_puts(seq, " (");\r\nif (proc_details >= 1) {\r\ni = (device->rs_last_mark + DRBD_SYNC_MARKS-1) % DRBD_SYNC_MARKS;\r\ndt = (jiffies - device->rs_mark_time[i]) / HZ;\r\nif (!dt)\r\ndt++;\r\ndb = device->rs_mark_left[i] - rs_left;\r\ndbdt = Bit2KB(db/dt);\r\nseq_printf_with_thousands_grouping(seq, dbdt);\r\nseq_puts(seq, " -- ");\r\n}\r\ndt = (jiffies - device->rs_start - device->rs_paused) / HZ;\r\nif (dt == 0)\r\ndt = 1;\r\ndb = rs_total - rs_left;\r\ndbdt = Bit2KB(db/dt);\r\nseq_printf_with_thousands_grouping(seq, dbdt);\r\nseq_putc(seq, ')');\r\nif (state.conn == C_SYNC_TARGET ||\r\nstate.conn == C_VERIFY_S) {\r\nseq_puts(seq, " want: ");\r\nseq_printf_with_thousands_grouping(seq, device->c_sync_rate);\r\n}\r\nseq_printf(seq, " K/sec%s\n", stalled ? " (stalled)" : "");\r\nif (proc_details >= 1) {\r\nunsigned long bm_bits = drbd_bm_bits(device);\r\nunsigned long bit_pos;\r\nunsigned long long stop_sector = 0;\r\nif (state.conn == C_VERIFY_S ||\r\nstate.conn == C_VERIFY_T) {\r\nbit_pos = bm_bits - device->ov_left;\r\nif (verify_can_do_stop_sector(device))\r\nstop_sector = device->ov_stop_sector;\r\n} else\r\nbit_pos = device->bm_resync_fo;\r\nseq_printf(seq,\r\n"\t%3d%% sector pos: %llu/%llu",\r\n(int)(bit_pos / (bm_bits/100+1)),\r\n(unsigned long long)bit_pos * BM_SECT_PER_BIT,\r\n(unsigned long long)bm_bits * BM_SECT_PER_BIT);\r\nif (stop_sector != 0 && stop_sector != ULLONG_MAX)\r\nseq_printf(seq, " stop sector: %llu", stop_sector);\r\nseq_putc(seq, '\n');\r\n}\r\n}\r\nstatic int drbd_seq_show(struct seq_file *seq, void *v)\r\n{\r\nint i, prev_i = -1;\r\nconst char *sn;\r\nstruct drbd_device *device;\r\nstruct net_conf *nc;\r\nunion drbd_dev_state state;\r\nchar wp;\r\nstatic char write_ordering_chars[] = {\r\n[WO_NONE] = 'n',\r\n[WO_DRAIN_IO] = 'd',\r\n[WO_BDEV_FLUSH] = 'f',\r\n};\r\nseq_printf(seq, "version: " REL_VERSION " (api:%d/proto:%d-%d)\n%s\n",\r\nAPI_VERSION, PRO_VERSION_MIN, PRO_VERSION_MAX, drbd_buildtag());\r\nrcu_read_lock();\r\nidr_for_each_entry(&drbd_devices, device, i) {\r\nif (prev_i != i - 1)\r\nseq_putc(seq, '\n');\r\nprev_i = i;\r\nstate = device->state;\r\nsn = drbd_conn_str(state.conn);\r\nif (state.conn == C_STANDALONE &&\r\nstate.disk == D_DISKLESS &&\r\nstate.role == R_SECONDARY) {\r\nseq_printf(seq, "%2d: cs:Unconfigured\n", i);\r\n} else {\r\nbdi_rw_congested(&device->rq_queue->backing_dev_info);\r\nnc = rcu_dereference(first_peer_device(device)->connection->net_conf);\r\nwp = nc ? nc->wire_protocol - DRBD_PROT_A + 'A' : ' ';\r\nseq_printf(seq,\r\n"%2d: cs:%s ro:%s/%s ds:%s/%s %c %c%c%c%c%c%c\n"\r\n" ns:%u nr:%u dw:%u dr:%u al:%u bm:%u "\r\n"lo:%d pe:%d ua:%d ap:%d ep:%d wo:%c",\r\ni, sn,\r\ndrbd_role_str(state.role),\r\ndrbd_role_str(state.peer),\r\ndrbd_disk_str(state.disk),\r\ndrbd_disk_str(state.pdsk),\r\nwp,\r\ndrbd_suspended(device) ? 's' : 'r',\r\nstate.aftr_isp ? 'a' : '-',\r\nstate.peer_isp ? 'p' : '-',\r\nstate.user_isp ? 'u' : '-',\r\ndevice->congestion_reason ?: '-',\r\ntest_bit(AL_SUSPENDED, &device->flags) ? 's' : '-',\r\ndevice->send_cnt/2,\r\ndevice->recv_cnt/2,\r\ndevice->writ_cnt/2,\r\ndevice->read_cnt/2,\r\ndevice->al_writ_cnt,\r\ndevice->bm_writ_cnt,\r\natomic_read(&device->local_cnt),\r\natomic_read(&device->ap_pending_cnt) +\r\natomic_read(&device->rs_pending_cnt),\r\natomic_read(&device->unacked_cnt),\r\natomic_read(&device->ap_bio_cnt),\r\nfirst_peer_device(device)->connection->epochs,\r\nwrite_ordering_chars[device->resource->write_ordering]\r\n);\r\nseq_printf(seq, " oos:%llu\n",\r\nBit2KB((unsigned long long)\r\ndrbd_bm_total_weight(device)));\r\n}\r\nif (state.conn == C_SYNC_SOURCE ||\r\nstate.conn == C_SYNC_TARGET ||\r\nstate.conn == C_VERIFY_S ||\r\nstate.conn == C_VERIFY_T)\r\ndrbd_syncer_progress(device, seq, state);\r\nif (proc_details >= 1 && get_ldev_if_state(device, D_FAILED)) {\r\nlc_seq_printf_stats(seq, device->resync);\r\nlc_seq_printf_stats(seq, device->act_log);\r\nput_ldev(device);\r\n}\r\nif (proc_details >= 2)\r\nseq_printf(seq, "\tblocked on activity log: %d\n", atomic_read(&device->ap_actlog_cnt));\r\n}\r\nrcu_read_unlock();\r\nreturn 0;\r\n}\r\nstatic int drbd_proc_open(struct inode *inode, struct file *file)\r\n{\r\nint err;\r\nif (try_module_get(THIS_MODULE)) {\r\nerr = single_open(file, drbd_seq_show, NULL);\r\nif (err)\r\nmodule_put(THIS_MODULE);\r\nreturn err;\r\n}\r\nreturn -ENODEV;\r\n}\r\nstatic int drbd_proc_release(struct inode *inode, struct file *file)\r\n{\r\nmodule_put(THIS_MODULE);\r\nreturn single_release(inode, file);\r\n}

int post_read_mst_fixup(NTFS_RECORD *b, const u32 size)\r\n{\r\nu16 usa_ofs, usa_count, usn;\r\nu16 *usa_pos, *data_pos;\r\nusa_ofs = le16_to_cpu(b->usa_ofs);\r\nusa_count = le16_to_cpu(b->usa_count) - 1;\r\nif ( size & (NTFS_BLOCK_SIZE - 1) ||\r\nusa_ofs & 1 ||\r\nusa_ofs + (usa_count * 2) > size ||\r\n(size >> NTFS_BLOCK_SIZE_BITS) != usa_count)\r\nreturn 0;\r\nusa_pos = (u16*)b + usa_ofs/sizeof(u16);\r\nusn = *usa_pos;\r\ndata_pos = (u16*)b + NTFS_BLOCK_SIZE/sizeof(u16) - 1;\r\nwhile (usa_count--) {\r\nif (*data_pos != usn) {\r\nb->magic = magic_BAAD;\r\nreturn -EINVAL;\r\n}\r\ndata_pos += NTFS_BLOCK_SIZE/sizeof(u16);\r\n}\r\nusa_count = le16_to_cpu(b->usa_count) - 1;\r\ndata_pos = (u16*)b + NTFS_BLOCK_SIZE/sizeof(u16) - 1;\r\nwhile (usa_count--) {\r\n*data_pos = *(++usa_pos);\r\ndata_pos += NTFS_BLOCK_SIZE/sizeof(u16);\r\n}\r\nreturn 0;\r\n}\r\nint pre_write_mst_fixup(NTFS_RECORD *b, const u32 size)\r\n{\r\nle16 *usa_pos, *data_pos;\r\nu16 usa_ofs, usa_count, usn;\r\nle16 le_usn;\r\nif (!b || ntfs_is_baad_record(b->magic) ||\r\nntfs_is_hole_record(b->magic))\r\nreturn -EINVAL;\r\nusa_ofs = le16_to_cpu(b->usa_ofs);\r\nusa_count = le16_to_cpu(b->usa_count) - 1;\r\nif ( size & (NTFS_BLOCK_SIZE - 1) ||\r\nusa_ofs & 1 ||\r\nusa_ofs + (usa_count * 2) > size ||\r\n(size >> NTFS_BLOCK_SIZE_BITS) != usa_count)\r\nreturn -EINVAL;\r\nusa_pos = (le16*)((u8*)b + usa_ofs);\r\nusn = le16_to_cpup(usa_pos) + 1;\r\nif (usn == 0xffff || !usn)\r\nusn = 1;\r\nle_usn = cpu_to_le16(usn);\r\n*usa_pos = le_usn;\r\ndata_pos = (le16*)b + NTFS_BLOCK_SIZE/sizeof(le16) - 1;\r\nwhile (usa_count--) {\r\n*(++usa_pos) = *data_pos;\r\n*data_pos = le_usn;\r\ndata_pos += NTFS_BLOCK_SIZE/sizeof(le16);\r\n}\r\nreturn 0;\r\n}\r\nvoid post_write_mst_fixup(NTFS_RECORD *b)\r\n{\r\nle16 *usa_pos, *data_pos;\r\nu16 usa_ofs = le16_to_cpu(b->usa_ofs);\r\nu16 usa_count = le16_to_cpu(b->usa_count) - 1;\r\nusa_pos = (le16*)b + usa_ofs/sizeof(le16);\r\ndata_pos = (le16*)b + NTFS_BLOCK_SIZE/sizeof(le16) - 1;\r\nwhile (usa_count--) {\r\n*data_pos = *(++usa_pos);\r\ndata_pos += NTFS_BLOCK_SIZE/sizeof(le16);\r\n}\r\n}

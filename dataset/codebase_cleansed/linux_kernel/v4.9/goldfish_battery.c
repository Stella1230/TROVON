static int goldfish_ac_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct goldfish_battery_data *data = power_supply_get_drvdata(psy);\r\nint ret = 0;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_AC_ONLINE);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int goldfish_battery_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct goldfish_battery_data *data = power_supply_get_drvdata(psy);\r\nint ret = 0;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_STATUS);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_HEALTH);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_PRESENT);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CAPACITY:\r\nval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_CAPACITY);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic irqreturn_t goldfish_battery_interrupt(int irq, void *dev_id)\r\n{\r\nunsigned long irq_flags;\r\nstruct goldfish_battery_data *data = dev_id;\r\nuint32_t status;\r\nspin_lock_irqsave(&data->lock, irq_flags);\r\nstatus = GOLDFISH_BATTERY_READ(data, BATTERY_INT_STATUS);\r\nstatus &= BATTERY_INT_MASK;\r\nif (status & BATTERY_STATUS_CHANGED)\r\npower_supply_changed(data->battery);\r\nif (status & AC_STATUS_CHANGED)\r\npower_supply_changed(data->ac);\r\nspin_unlock_irqrestore(&data->lock, irq_flags);\r\nreturn status ? IRQ_HANDLED : IRQ_NONE;\r\n}\r\nstatic int goldfish_battery_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct resource *r;\r\nstruct goldfish_battery_data *data;\r\nstruct power_supply_config psy_cfg = {};\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (data == NULL)\r\nreturn -ENOMEM;\r\nspin_lock_init(&data->lock);\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (r == NULL) {\r\ndev_err(&pdev->dev, "platform_get_resource failed\n");\r\nreturn -ENODEV;\r\n}\r\ndata->reg_base = devm_ioremap(&pdev->dev, r->start, resource_size(r));\r\nif (data->reg_base == NULL) {\r\ndev_err(&pdev->dev, "unable to remap MMIO\n");\r\nreturn -ENOMEM;\r\n}\r\ndata->irq = platform_get_irq(pdev, 0);\r\nif (data->irq < 0) {\r\ndev_err(&pdev->dev, "platform_get_irq failed\n");\r\nreturn -ENODEV;\r\n}\r\nret = devm_request_irq(&pdev->dev, data->irq, goldfish_battery_interrupt,\r\nIRQF_SHARED, pdev->name, data);\r\nif (ret)\r\nreturn ret;\r\npsy_cfg.drv_data = data;\r\ndata->ac = power_supply_register(&pdev->dev, &ac_desc, &psy_cfg);\r\nif (IS_ERR(data->ac))\r\nreturn PTR_ERR(data->ac);\r\ndata->battery = power_supply_register(&pdev->dev, &battery_desc,\r\n&psy_cfg);\r\nif (IS_ERR(data->battery)) {\r\npower_supply_unregister(data->ac);\r\nreturn PTR_ERR(data->battery);\r\n}\r\nplatform_set_drvdata(pdev, data);\r\nbattery_data = data;\r\nGOLDFISH_BATTERY_WRITE(data, BATTERY_INT_ENABLE, BATTERY_INT_MASK);\r\nreturn 0;\r\n}\r\nstatic int goldfish_battery_remove(struct platform_device *pdev)\r\n{\r\nstruct goldfish_battery_data *data = platform_get_drvdata(pdev);\r\npower_supply_unregister(data->battery);\r\npower_supply_unregister(data->ac);\r\nbattery_data = NULL;\r\nreturn 0;\r\n}

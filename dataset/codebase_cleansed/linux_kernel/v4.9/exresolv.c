acpi_status\r\nacpi_ex_resolve_to_value(union acpi_operand_object **stack_ptr,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE_PTR(ex_resolve_to_value, stack_ptr);\r\nif (!stack_ptr || !*stack_ptr) {\r\nACPI_ERROR((AE_INFO, "Internal - null pointer"));\r\nreturn_ACPI_STATUS(AE_AML_NO_OPERAND);\r\n}\r\nif (ACPI_GET_DESCRIPTOR_TYPE(*stack_ptr) == ACPI_DESC_TYPE_OPERAND) {\r\nstatus = acpi_ex_resolve_object_to_value(stack_ptr, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif (!*stack_ptr) {\r\nACPI_ERROR((AE_INFO, "Internal - null pointer"));\r\nreturn_ACPI_STATUS(AE_AML_NO_OPERAND);\r\n}\r\n}\r\nif (ACPI_GET_DESCRIPTOR_TYPE(*stack_ptr) == ACPI_DESC_TYPE_NAMED) {\r\nstatus =\r\nacpi_ex_resolve_node_to_value(ACPI_CAST_INDIRECT_PTR\r\n(struct acpi_namespace_node,\r\nstack_ptr), walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "Resolved object %p\n", *stack_ptr));\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nstatic acpi_status\r\nacpi_ex_resolve_object_to_value(union acpi_operand_object **stack_ptr,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status = AE_OK;\r\nunion acpi_operand_object *stack_desc;\r\nunion acpi_operand_object *obj_desc = NULL;\r\nu8 ref_type;\r\nACPI_FUNCTION_TRACE(ex_resolve_object_to_value);\r\nstack_desc = *stack_ptr;\r\nswitch (stack_desc->common.type) {\r\ncase ACPI_TYPE_LOCAL_REFERENCE:\r\nref_type = stack_desc->reference.class;\r\nswitch (ref_type) {\r\ncase ACPI_REFCLASS_LOCAL:\r\ncase ACPI_REFCLASS_ARG:\r\nstatus = acpi_ds_method_data_get_value(ref_type,\r\nstack_desc->\r\nreference.value,\r\nwalk_state,\r\n&obj_desc);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"[Arg/Local %X] ValueObj is %p\n",\r\nstack_desc->reference.value,\r\nobj_desc));\r\nacpi_ut_remove_reference(stack_desc);\r\n*stack_ptr = obj_desc;\r\nbreak;\r\ncase ACPI_REFCLASS_INDEX:\r\nswitch (stack_desc->reference.target_type) {\r\ncase ACPI_TYPE_BUFFER_FIELD:\r\nbreak;\r\ncase ACPI_TYPE_PACKAGE:\r\nif ((walk_state->opcode ==\r\nAML_INT_METHODCALL_OP)\r\n|| (walk_state->opcode == AML_COPY_OP)) {\r\nbreak;\r\n}\r\nobj_desc = *stack_desc->reference.where;\r\nif (obj_desc) {\r\nacpi_ut_add_reference(obj_desc);\r\n*stack_ptr = obj_desc;\r\n} else {\r\nACPI_ERROR((AE_INFO,\r\n"Attempt to dereference an Index to "\r\n"NULL package element Idx=%p",\r\nstack_desc));\r\nstatus = AE_AML_UNINITIALIZED_ELEMENT;\r\n}\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Unknown TargetType 0x%X in Index/Reference object %p",\r\nstack_desc->reference.target_type,\r\nstack_desc));\r\nstatus = AE_AML_INTERNAL;\r\nbreak;\r\n}\r\nbreak;\r\ncase ACPI_REFCLASS_REFOF:\r\ncase ACPI_REFCLASS_DEBUG:\r\ncase ACPI_REFCLASS_TABLE:\r\nbreak;\r\ncase ACPI_REFCLASS_NAME:\r\nif ((stack_desc->reference.node->type ==\r\nACPI_TYPE_DEVICE)\r\n|| (stack_desc->reference.node->type ==\r\nACPI_TYPE_THERMAL)) {\r\n*stack_ptr = (void *)stack_desc->reference.node;\r\n} else {\r\n*stack_ptr =\r\n(stack_desc->reference.node)->object;\r\nacpi_ut_add_reference(*stack_ptr);\r\n}\r\nacpi_ut_remove_reference(stack_desc);\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Unknown Reference type 0x%X in %p",\r\nref_type, stack_desc));\r\nstatus = AE_AML_INTERNAL;\r\nbreak;\r\n}\r\nbreak;\r\ncase ACPI_TYPE_BUFFER:\r\nstatus = acpi_ds_get_buffer_arguments(stack_desc);\r\nbreak;\r\ncase ACPI_TYPE_PACKAGE:\r\nstatus = acpi_ds_get_package_arguments(stack_desc);\r\nbreak;\r\ncase ACPI_TYPE_BUFFER_FIELD:\r\ncase ACPI_TYPE_LOCAL_REGION_FIELD:\r\ncase ACPI_TYPE_LOCAL_BANK_FIELD:\r\ncase ACPI_TYPE_LOCAL_INDEX_FIELD:\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"FieldRead SourceDesc=%p Type=%X\n",\r\nstack_desc, stack_desc->common.type));\r\nstatus =\r\nacpi_ex_read_data_from_field(walk_state, stack_desc,\r\n&obj_desc);\r\nacpi_ut_remove_reference(*stack_ptr);\r\n*stack_ptr = (void *)obj_desc;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ex_resolve_multiple(struct acpi_walk_state *walk_state,\r\nunion acpi_operand_object *operand,\r\nacpi_object_type *return_type,\r\nunion acpi_operand_object **return_desc)\r\n{\r\nunion acpi_operand_object *obj_desc = ACPI_CAST_PTR(void, operand);\r\nstruct acpi_namespace_node *node =\r\nACPI_CAST_PTR(struct acpi_namespace_node, operand);\r\nacpi_object_type type;\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(acpi_ex_resolve_multiple);\r\nswitch (ACPI_GET_DESCRIPTOR_TYPE(obj_desc)) {\r\ncase ACPI_DESC_TYPE_OPERAND:\r\ntype = obj_desc->common.type;\r\nbreak;\r\ncase ACPI_DESC_TYPE_NAMED:\r\ntype = ((struct acpi_namespace_node *)obj_desc)->type;\r\nobj_desc = acpi_ns_get_attached_object(node);\r\nif (type == ACPI_TYPE_LOCAL_ALIAS) {\r\ntype = ((struct acpi_namespace_node *)obj_desc)->type;\r\nobj_desc = acpi_ns_get_attached_object((struct\r\nacpi_namespace_node\r\n*)obj_desc);\r\n}\r\nif (!obj_desc) {\r\nACPI_ERROR((AE_INFO,\r\n"[%4.4s] Node is unresolved or uninitialized",\r\nacpi_ut_get_node_name(node)));\r\nreturn_ACPI_STATUS(AE_AML_UNINITIALIZED_NODE);\r\n}\r\nbreak;\r\ndefault:\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nif (type != ACPI_TYPE_LOCAL_REFERENCE) {\r\ngoto exit;\r\n}\r\nwhile (obj_desc->common.type == ACPI_TYPE_LOCAL_REFERENCE) {\r\nswitch (obj_desc->reference.class) {\r\ncase ACPI_REFCLASS_REFOF:\r\ncase ACPI_REFCLASS_NAME:\r\nif (obj_desc->reference.class == ACPI_REFCLASS_REFOF) {\r\nnode = obj_desc->reference.object;\r\n} else {\r\nnode = obj_desc->reference.node;\r\n}\r\nif (ACPI_GET_DESCRIPTOR_TYPE(node) !=\r\nACPI_DESC_TYPE_NAMED) {\r\nACPI_ERROR((AE_INFO,\r\n"Not a namespace node %p [%s]",\r\nnode,\r\nacpi_ut_get_descriptor_name(node)));\r\nreturn_ACPI_STATUS(AE_AML_INTERNAL);\r\n}\r\nobj_desc = acpi_ns_get_attached_object(node);\r\nif (!obj_desc) {\r\ntype = acpi_ns_get_type(node);\r\ngoto exit;\r\n}\r\nif (obj_desc == operand) {\r\nreturn_ACPI_STATUS(AE_AML_CIRCULAR_REFERENCE);\r\n}\r\nbreak;\r\ncase ACPI_REFCLASS_INDEX:\r\ntype = obj_desc->reference.target_type;\r\nif (type != ACPI_TYPE_PACKAGE) {\r\ngoto exit;\r\n}\r\nobj_desc = *(obj_desc->reference.where);\r\nif (!obj_desc) {\r\ntype = 0;\r\ngoto exit;\r\n}\r\nbreak;\r\ncase ACPI_REFCLASS_TABLE:\r\ntype = ACPI_TYPE_DDB_HANDLE;\r\ngoto exit;\r\ncase ACPI_REFCLASS_LOCAL:\r\ncase ACPI_REFCLASS_ARG:\r\nif (return_desc) {\r\nstatus =\r\nacpi_ds_method_data_get_value(obj_desc->\r\nreference.\r\nclass,\r\nobj_desc->\r\nreference.\r\nvalue,\r\nwalk_state,\r\n&obj_desc);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_ut_remove_reference(obj_desc);\r\n} else {\r\nstatus =\r\nacpi_ds_method_data_get_node(obj_desc->\r\nreference.\r\nclass,\r\nobj_desc->\r\nreference.\r\nvalue,\r\nwalk_state,\r\n&node);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nobj_desc = acpi_ns_get_attached_object(node);\r\nif (!obj_desc) {\r\ntype = ACPI_TYPE_ANY;\r\ngoto exit;\r\n}\r\n}\r\nbreak;\r\ncase ACPI_REFCLASS_DEBUG:\r\ntype = ACPI_TYPE_DEBUG_OBJECT;\r\ngoto exit;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Unknown Reference Class 0x%2.2X",\r\nobj_desc->reference.class));\r\nreturn_ACPI_STATUS(AE_AML_INTERNAL);\r\n}\r\n}\r\ntype = obj_desc->common.type;\r\nexit:\r\nswitch (type) {\r\ncase ACPI_TYPE_LOCAL_REGION_FIELD:\r\ncase ACPI_TYPE_LOCAL_BANK_FIELD:\r\ncase ACPI_TYPE_LOCAL_INDEX_FIELD:\r\ntype = ACPI_TYPE_FIELD_UNIT;\r\nbreak;\r\ncase ACPI_TYPE_LOCAL_SCOPE:\r\ntype = ACPI_TYPE_ANY;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n*return_type = type;\r\nif (return_desc) {\r\n*return_desc = obj_desc;\r\n}\r\nreturn_ACPI_STATUS(AE_OK);\r\n}

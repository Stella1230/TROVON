static int xfrm4_tunnel_check_size(struct sk_buff *skb)\r\n{\r\nint mtu, ret = 0;\r\nif (IPCB(skb)->flags & IPSKB_XFRM_TUNNEL_SIZE)\r\ngoto out;\r\nif (!(ip_hdr(skb)->frag_off & htons(IP_DF)) || skb->ignore_df)\r\ngoto out;\r\nmtu = dst_mtu(skb_dst(skb));\r\nif (skb->len > mtu) {\r\nskb->protocol = htons(ETH_P_IP);\r\nif (skb->sk)\r\nxfrm_local_error(skb, mtu);\r\nelse\r\nicmp_send(skb, ICMP_DEST_UNREACH,\r\nICMP_FRAG_NEEDED, htonl(mtu));\r\nret = -EMSGSIZE;\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nint xfrm4_extract_output(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nint err;\r\nerr = xfrm4_tunnel_check_size(skb);\r\nif (err)\r\nreturn err;\r\nXFRM_MODE_SKB_CB(skb)->protocol = ip_hdr(skb)->protocol;\r\nreturn xfrm4_extract_header(skb);\r\n}\r\nint xfrm4_prepare_output(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nint err;\r\nerr = xfrm_inner_extract_output(x, skb);\r\nif (err)\r\nreturn err;\r\nIPCB(skb)->flags |= IPSKB_XFRM_TUNNEL_SIZE;\r\nskb->protocol = htons(ETH_P_IP);\r\nreturn x->outer_mode->output2(x, skb);\r\n}\r\nint xfrm4_output_finish(struct sock *sk, struct sk_buff *skb)\r\n{\r\nmemset(IPCB(skb), 0, sizeof(*IPCB(skb)));\r\n#ifdef CONFIG_NETFILTER\r\nIPCB(skb)->flags |= IPSKB_XFRM_TRANSFORMED;\r\n#endif\r\nreturn xfrm_output(sk, skb);\r\n}\r\nstatic int __xfrm4_output(struct net *net, struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct xfrm_state *x = skb_dst(skb)->xfrm;\r\n#ifdef CONFIG_NETFILTER\r\nif (!x) {\r\nIPCB(skb)->flags |= IPSKB_REROUTED;\r\nreturn dst_output(net, sk, skb);\r\n}\r\n#endif\r\nreturn x->outer_mode->afinfo->output_finish(sk, skb);\r\n}\r\nint xfrm4_output(struct net *net, struct sock *sk, struct sk_buff *skb)\r\n{\r\nreturn NF_HOOK_COND(NFPROTO_IPV4, NF_INET_POST_ROUTING,\r\nnet, sk, skb, NULL, skb_dst(skb)->dev,\r\n__xfrm4_output,\r\n!(IPCB(skb)->flags & IPSKB_REROUTED));\r\n}\r\nvoid xfrm4_local_error(struct sk_buff *skb, u32 mtu)\r\n{\r\nstruct iphdr *hdr;\r\nhdr = skb->encapsulation ? inner_ip_hdr(skb) : ip_hdr(skb);\r\nip_local_error(skb->sk, EMSGSIZE, hdr->daddr,\r\ninet_sk(skb->sk)->inet_dport, mtu);\r\n}

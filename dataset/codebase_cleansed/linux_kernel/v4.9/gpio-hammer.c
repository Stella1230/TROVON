int hammer_device(const char *device_name, unsigned int *lines, int nlines,\r\nunsigned int loops)\r\n{\r\nstruct gpiohandle_request req;\r\nstruct gpiohandle_data data;\r\nchar *chrdev_name;\r\nchar swirr[] = "-\\|/";\r\nint fd;\r\nint ret;\r\nint i, j;\r\nunsigned int iteration = 0;\r\nret = asprintf(&chrdev_name, "/dev/%s", device_name);\r\nif (ret < 0)\r\nreturn -ENOMEM;\r\nfd = open(chrdev_name, 0);\r\nif (fd == -1) {\r\nret = -errno;\r\nfprintf(stderr, "Failed to open %s\n", chrdev_name);\r\ngoto exit_close_error;\r\n}\r\nfor (i = 0; i < nlines; i++)\r\nreq.lineoffsets[i] = lines[i];\r\nreq.flags = GPIOHANDLE_REQUEST_OUTPUT;\r\nstrcpy(req.consumer_label, "gpio-hammer");\r\nreq.lines = nlines;\r\nret = ioctl(fd, GPIO_GET_LINEHANDLE_IOCTL, &req);\r\nif (ret == -1) {\r\nret = -errno;\r\nfprintf(stderr, "Failed to issue GET LINEHANDLE "\r\n"IOCTL (%d)\n",\r\nret);\r\ngoto exit_close_error;\r\n}\r\nret = ioctl(req.fd, GPIOHANDLE_GET_LINE_VALUES_IOCTL, &data);\r\nif (ret == -1) {\r\nret = -errno;\r\nfprintf(stderr, "Failed to issue GPIOHANDLE GET LINE "\r\n"VALUES IOCTL (%d)\n",\r\nret);\r\ngoto exit_close_error;\r\n}\r\nfprintf(stdout, "Hammer lines [");\r\nfor (i = 0; i < nlines; i++) {\r\nfprintf(stdout, "%d", lines[i]);\r\nif (i != (nlines - 1))\r\nfprintf(stdout, ", ");\r\n}\r\nfprintf(stdout, "] on %s, initial states: [", device_name);\r\nfor (i = 0; i < nlines; i++) {\r\nfprintf(stdout, "%d", data.values[i]);\r\nif (i != (nlines - 1))\r\nfprintf(stdout, ", ");\r\n}\r\nfprintf(stdout, "]\n");\r\nj = 0;\r\nwhile (1) {\r\nfor (i = 0; i < nlines; i++)\r\ndata.values[i] = !data.values[i];\r\nret = ioctl(req.fd, GPIOHANDLE_SET_LINE_VALUES_IOCTL, &data);\r\nif (ret == -1) {\r\nret = -errno;\r\nfprintf(stderr, "Failed to issue GPIOHANDLE SET LINE "\r\n"VALUES IOCTL (%d)\n",\r\nret);\r\ngoto exit_close_error;\r\n}\r\nret = ioctl(req.fd, GPIOHANDLE_GET_LINE_VALUES_IOCTL, &data);\r\nif (ret == -1) {\r\nret = -errno;\r\nfprintf(stderr, "Failed to issue GPIOHANDLE GET LINE "\r\n"VALUES IOCTL (%d)\n",\r\nret);\r\ngoto exit_close_error;\r\n}\r\nfprintf(stdout, "[%c] ", swirr[j]);\r\nj++;\r\nif (j == sizeof(swirr)-1)\r\nj = 0;\r\nfprintf(stdout, "[");\r\nfor (i = 0; i < nlines; i++) {\r\nfprintf(stdout, "%d: %d", lines[i], data.values[i]);\r\nif (i != (nlines - 1))\r\nfprintf(stdout, ", ");\r\n}\r\nfprintf(stdout, "]\r");\r\nfflush(stdout);\r\nsleep(1);\r\niteration++;\r\nif (loops && iteration == loops)\r\nbreak;\r\n}\r\nfprintf(stdout, "\n");\r\nret = 0;\r\nexit_close_error:\r\nif (close(fd) == -1)\r\nperror("Failed to close GPIO character device file");\r\nfree(chrdev_name);\r\nreturn ret;\r\n}\r\nvoid print_usage(void)\r\n{\r\nfprintf(stderr, "Usage: gpio-hammer [options]...\n"\r\n"Hammer GPIO lines, 0->1->0->1...\n"\r\n" -n <name> Hammer GPIOs on a named device (must be stated)\n"\r\n" -o <n> Offset[s] to hammer, at least one, several can be stated\n"\r\n" [-c <n>] Do <n> loops (optional, infinite loop if not stated)\n"\r\n" -? This helptext\n"\r\n"\n"\r\n"Example:\n"\r\n"gpio-hammer -n gpiochip0 -o 4\n"\r\n);\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nconst char *device_name = NULL;\r\nunsigned int lines[GPIOHANDLES_MAX];\r\nunsigned int loops = 0;\r\nint nlines;\r\nint c;\r\nint i;\r\ni = 0;\r\nwhile ((c = getopt(argc, argv, "c:n:o:?")) != -1) {\r\nswitch (c) {\r\ncase 'c':\r\nloops = strtoul(optarg, NULL, 10);\r\nbreak;\r\ncase 'n':\r\ndevice_name = optarg;\r\nbreak;\r\ncase 'o':\r\nlines[i] = strtoul(optarg, NULL, 10);\r\ni++;\r\nbreak;\r\ncase '?':\r\nprint_usage();\r\nreturn -1;\r\n}\r\n}\r\nnlines = i;\r\nif (!device_name || !nlines) {\r\nprint_usage();\r\nreturn -1;\r\n}\r\nreturn hammer_device(device_name, lines, nlines, loops);\r\n}

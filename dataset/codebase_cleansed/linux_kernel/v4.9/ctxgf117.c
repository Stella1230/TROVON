void\r\ngf117_grctx_generate_attrib(struct gf100_grctx *info)\r\n{\r\nstruct gf100_gr *gr = info->gr;\r\nconst struct gf100_grctx_func *grctx = gr->func->grctx;\r\nconst u32 alpha = grctx->alpha_nr;\r\nconst u32 beta = grctx->attrib_nr;\r\nconst u32 size = 0x20 * (grctx->attrib_nr_max + grctx->alpha_nr_max);\r\nconst u32 access = NV_MEM_ACCESS_RW;\r\nconst int s = 12;\r\nconst int b = mmio_vram(info, size * gr->tpc_total, (1 << s), access);\r\nconst int timeslice_mode = 1;\r\nconst int max_batches = 0xffff;\r\nu32 bo = 0;\r\nu32 ao = bo + grctx->attrib_nr_max * gr->tpc_total;\r\nint gpc, ppc;\r\nmmio_refn(info, 0x418810, 0x80000000, s, b);\r\nmmio_refn(info, 0x419848, 0x10000000, s, b);\r\nmmio_wr32(info, 0x405830, (beta << 16) | alpha);\r\nmmio_wr32(info, 0x4064c4, ((alpha / 4) << 16) | max_batches);\r\nfor (gpc = 0; gpc < gr->gpc_nr; gpc++) {\r\nfor (ppc = 0; ppc < gr->ppc_nr[gpc]; ppc++) {\r\nconst u32 a = alpha * gr->ppc_tpc_nr[gpc][ppc];\r\nconst u32 b = beta * gr->ppc_tpc_nr[gpc][ppc];\r\nconst u32 t = timeslice_mode;\r\nconst u32 o = PPC_UNIT(gpc, ppc, 0);\r\nif (!(gr->ppc_mask[gpc] & (1 << ppc)))\r\ncontinue;\r\nmmio_skip(info, o + 0xc0, (t << 28) | (b << 16) | ++bo);\r\nmmio_wr32(info, o + 0xc0, (t << 28) | (b << 16) | --bo);\r\nbo += grctx->attrib_nr_max * gr->ppc_tpc_nr[gpc][ppc];\r\nmmio_wr32(info, o + 0xe4, (a << 16) | ao);\r\nao += grctx->alpha_nr_max * gr->ppc_tpc_nr[gpc][ppc];\r\n}\r\n}\r\n}\r\nvoid\r\ngf117_grctx_generate_main(struct gf100_gr *gr, struct gf100_grctx *info)\r\n{\r\nstruct nvkm_device *device = gr->base.engine.subdev.device;\r\nconst struct gf100_grctx_func *grctx = gr->func->grctx;\r\nu32 idle_timeout;\r\nint i;\r\nnvkm_mc_unk260(device, 0);\r\ngf100_gr_mmio(gr, grctx->hub);\r\ngf100_gr_mmio(gr, grctx->gpc);\r\ngf100_gr_mmio(gr, grctx->zcull);\r\ngf100_gr_mmio(gr, grctx->tpc);\r\ngf100_gr_mmio(gr, grctx->ppc);\r\nidle_timeout = nvkm_mask(device, 0x404154, 0xffffffff, 0x00000000);\r\ngrctx->bundle(info);\r\ngrctx->pagepool(info);\r\ngrctx->attrib(info);\r\ngrctx->unkn(gr);\r\ngf100_grctx_generate_tpcid(gr);\r\ngf100_grctx_generate_r406028(gr);\r\ngf100_grctx_generate_r4060a8(gr);\r\ngk104_grctx_generate_r418bb8(gr);\r\ngf100_grctx_generate_r406800(gr);\r\nfor (i = 0; i < 8; i++)\r\nnvkm_wr32(device, 0x4064d0 + (i * 0x04), 0x00000000);\r\ngf100_gr_icmd(gr, grctx->icmd);\r\nnvkm_wr32(device, 0x404154, idle_timeout);\r\ngf100_gr_mthd(gr, grctx->mthd);\r\nnvkm_mc_unk260(device, 1);\r\n}

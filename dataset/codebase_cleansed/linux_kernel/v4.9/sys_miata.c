static void\r\nmiata_srm_device_interrupt(unsigned long vector)\r\n{\r\nint irq;\r\nirq = (vector - 0x800) >> 4;\r\nif (irq >= 16)\r\nirq = irq + 8;\r\nhandle_irq(irq);\r\n}\r\nstatic void __init\r\nmiata_init_irq(void)\r\n{\r\nif (alpha_using_srm)\r\nalpha_mv.device_interrupt = miata_srm_device_interrupt;\r\n#if 0\r\n*(vulp)PYXIS_INT_HILO = 0x000000B2UL; mb();\r\n*(vulp)PYXIS_RT_COUNT = 0UL; mb();\r\n#endif\r\ninit_i8259a_irqs();\r\ninit_pyxis_irqs(0x63b0000);\r\ncommon_init_isa_dma();\r\nsetup_irq(16+2, &halt_switch_irqaction);\r\nsetup_irq(16+6, &timer_cascade_irqaction);\r\n}\r\nstatic int __init\r\nmiata_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstatic char irq_tab[18][5] __initdata = {\r\n{16+ 8, 16+ 8, 16+ 8, 16+ 8, 16+ 8},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{16+12, 16+12, 16+13, 16+14, 16+15},\r\n{16+16, 16+16, 16+17, 16+18, 16+19},\r\n{16+11, 16+11, 16+11, 16+11, 16+11},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{16+20, 16+20, 16+21, 16+22, 16+23},\r\n{16+24, 16+24, 16+25, 16+26, 16+27},\r\n{16+28, 16+28, 16+29, 16+30, 16+31},\r\n{ -1, -1, -1, -1, -1},\r\n};\r\nconst long min_idsel = 3, max_idsel = 20, irqs_per_slot = 5;\r\nif((slot == 7) && (PCI_FUNC(dev->devfn) == 3)) {\r\nu8 irq=0;\r\nstruct pci_dev *pdev = pci_get_slot(dev->bus, dev->devfn & ~7);\r\nif(pdev == NULL || pci_read_config_byte(pdev, 0x40,&irq) != PCIBIOS_SUCCESSFUL) {\r\npci_dev_put(pdev);\r\nreturn -1;\r\n}\r\nelse {\r\npci_dev_put(pdev);\r\nreturn irq;\r\n}\r\n}\r\nreturn COMMON_TABLE_LOOKUP;\r\n}\r\nstatic u8 __init\r\nmiata_swizzle(struct pci_dev *dev, u8 *pinp)\r\n{\r\nint slot, pin = *pinp;\r\nif (dev->bus->number == 0) {\r\nslot = PCI_SLOT(dev->devfn);\r\n}\r\nelse if ((PCI_SLOT(dev->bus->self->devfn) == 8) ||\r\n(PCI_SLOT(dev->bus->self->devfn) == 20)) {\r\nslot = PCI_SLOT(dev->devfn) + 9;\r\n}\r\nelse\r\n{\r\ndo {\r\nif ((PCI_SLOT(dev->bus->self->devfn) == 8) ||\r\n(PCI_SLOT(dev->bus->self->devfn) == 20)) {\r\nslot = PCI_SLOT(dev->devfn) + 9;\r\nbreak;\r\n}\r\npin = pci_swizzle_interrupt_pin(dev, pin);\r\ndev = dev->bus->self;\r\nslot = PCI_SLOT(dev->devfn);\r\n} while (dev->bus->self);\r\n}\r\n*pinp = pin;\r\nreturn slot;\r\n}\r\nstatic void __init\r\nmiata_init_pci(void)\r\n{\r\ncia_init_pci();\r\nSMC669_Init(0);\r\nes1888_init();\r\n}\r\nstatic void\r\nmiata_kill_arch(int mode)\r\n{\r\ncia_kill_arch(mode);\r\n#ifndef ALPHA_RESTORE_SRM_SETUP\r\nswitch(mode) {\r\ncase LINUX_REBOOT_CMD_RESTART:\r\nif (alpha_using_srm) {\r\n*(vuip) PYXIS_RESET = 0x0000dead;\r\nmb();\r\n}\r\nbreak;\r\ncase LINUX_REBOOT_CMD_HALT:\r\nbreak;\r\ncase LINUX_REBOOT_CMD_POWER_OFF:\r\nbreak;\r\n}\r\nhalt();\r\n#endif\r\n}

void error(char *x)\r\n{\r\nputs("\n\n");\r\nputs(x);\r\nputs("\n\n -- System halted");\r\nwhile (1)\r\n;\r\n}\r\nvoid __stack_chk_guard_setup(void)\r\n{\r\n__stack_chk_guard = 0x000a0dff;\r\n}\r\nvoid __stack_chk_fail(void)\r\n{\r\nerror("stack-protector: Kernel stack is corrupted\n");\r\n}\r\nvoid decompress_kernel(unsigned long boot_heap_start)\r\n{\r\nunsigned long zimage_start, zimage_size;\r\n__stack_chk_guard_setup();\r\nzimage_start = (unsigned long)(&__image_begin);\r\nzimage_size = (unsigned long)(&__image_end) -\r\n(unsigned long)(&__image_begin);\r\nputs("zimage at: ");\r\nputhex(zimage_start);\r\nputs(" ");\r\nputhex(zimage_size + zimage_start);\r\nputs("\n");\r\nfree_mem_ptr = boot_heap_start;\r\nfree_mem_end_ptr = boot_heap_start + BOOT_HEAP_SIZE;\r\nputs("Uncompressing Linux at load address ");\r\nputhex(VMLINUX_LOAD_ADDRESS_ULL);\r\nputs("\n");\r\n__decompress((char *)zimage_start, zimage_size, 0, 0,\r\n(void *)VMLINUX_LOAD_ADDRESS_ULL, 0, 0, error);\r\nif (IS_ENABLED(CONFIG_MIPS_RAW_APPENDED_DTB) &&\r\nfdt_magic((void *)&__appended_dtb) == FDT_MAGIC) {\r\nunsigned int image_size, dtb_size;\r\ndtb_size = fdt_totalsize((void *)&__appended_dtb);\r\nimage_size = le32_to_cpup((void *)&__image_end - 4);\r\nmemcpy((void *)VMLINUX_LOAD_ADDRESS_ULL + image_size,\r\n__appended_dtb, dtb_size);\r\n}\r\nputs("Now, booting the kernel...\n");\r\n}

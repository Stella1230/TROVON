static void handle_enc_init_msg(struct venc_vpu_inst *vpu, void *data)\r\n{\r\nstruct venc_vpu_ipi_msg_init *msg = data;\r\nvpu->inst_addr = msg->vpu_inst_addr;\r\nvpu->vsi = vpu_mapping_dm_addr(vpu->dev, msg->vpu_inst_addr);\r\n}\r\nstatic void handle_enc_encode_msg(struct venc_vpu_inst *vpu, void *data)\r\n{\r\nstruct venc_vpu_ipi_msg_enc *msg = data;\r\nvpu->state = msg->state;\r\nvpu->bs_size = msg->bs_size;\r\nvpu->is_key_frm = msg->is_key_frm;\r\n}\r\nstatic void vpu_enc_ipi_handler(void *data, unsigned int len, void *priv)\r\n{\r\nstruct venc_vpu_ipi_msg_common *msg = data;\r\nstruct venc_vpu_inst *vpu =\r\n(struct venc_vpu_inst *)(unsigned long)msg->venc_inst;\r\nmtk_vcodec_debug(vpu, "msg_id %x inst %p status %d",\r\nmsg->msg_id, vpu, msg->status);\r\nswitch (msg->msg_id) {\r\ncase VPU_IPIMSG_ENC_INIT_DONE:\r\nhandle_enc_init_msg(vpu, data);\r\nbreak;\r\ncase VPU_IPIMSG_ENC_SET_PARAM_DONE:\r\nbreak;\r\ncase VPU_IPIMSG_ENC_ENCODE_DONE:\r\nhandle_enc_encode_msg(vpu, data);\r\nbreak;\r\ncase VPU_IPIMSG_ENC_DEINIT_DONE:\r\nbreak;\r\ndefault:\r\nmtk_vcodec_err(vpu, "unknown msg id %x", msg->msg_id);\r\nbreak;\r\n}\r\nvpu->signaled = 1;\r\nvpu->failure = (msg->status != VENC_IPI_MSG_STATUS_OK);\r\nmtk_vcodec_debug_leave(vpu);\r\n}\r\nstatic int vpu_enc_send_msg(struct venc_vpu_inst *vpu, void *msg,\r\nint len)\r\n{\r\nint status;\r\nmtk_vcodec_debug_enter(vpu);\r\nif (!vpu->dev) {\r\nmtk_vcodec_err(vpu, "inst dev is NULL");\r\nreturn -EINVAL;\r\n}\r\nstatus = vpu_ipi_send(vpu->dev, vpu->id, msg, len);\r\nif (status) {\r\nuint32_t msg_id = *(uint32_t *)msg;\r\nmtk_vcodec_err(vpu, "vpu_ipi_send msg_id %x len %d fail %d",\r\nmsg_id, len, status);\r\nreturn -EINVAL;\r\n}\r\nif (vpu->failure)\r\nreturn -EINVAL;\r\nmtk_vcodec_debug_leave(vpu);\r\nreturn 0;\r\n}\r\nint vpu_enc_init(struct venc_vpu_inst *vpu)\r\n{\r\nint status;\r\nstruct venc_ap_ipi_msg_init out;\r\nmtk_vcodec_debug_enter(vpu);\r\ninit_waitqueue_head(&vpu->wq_hd);\r\nvpu->signaled = 0;\r\nvpu->failure = 0;\r\nstatus = vpu_ipi_register(vpu->dev, vpu->id, vpu_enc_ipi_handler,\r\nNULL, NULL);\r\nif (status) {\r\nmtk_vcodec_err(vpu, "vpu_ipi_register fail %d", status);\r\nreturn -EINVAL;\r\n}\r\nmemset(&out, 0, sizeof(out));\r\nout.msg_id = AP_IPIMSG_ENC_INIT;\r\nout.venc_inst = (unsigned long)vpu;\r\nif (vpu_enc_send_msg(vpu, &out, sizeof(out))) {\r\nmtk_vcodec_err(vpu, "AP_IPIMSG_ENC_INIT fail");\r\nreturn -EINVAL;\r\n}\r\nmtk_vcodec_debug_leave(vpu);\r\nreturn 0;\r\n}\r\nint vpu_enc_set_param(struct venc_vpu_inst *vpu,\r\nenum venc_set_param_type id,\r\nstruct venc_enc_param *enc_param)\r\n{\r\nstruct venc_ap_ipi_msg_set_param out;\r\nmtk_vcodec_debug(vpu, "id %d ->", id);\r\nmemset(&out, 0, sizeof(out));\r\nout.msg_id = AP_IPIMSG_ENC_SET_PARAM;\r\nout.vpu_inst_addr = vpu->inst_addr;\r\nout.param_id = id;\r\nswitch (id) {\r\ncase VENC_SET_PARAM_ENC:\r\nout.data_item = 0;\r\nbreak;\r\ncase VENC_SET_PARAM_FORCE_INTRA:\r\nout.data_item = 0;\r\nbreak;\r\ncase VENC_SET_PARAM_ADJUST_BITRATE:\r\nout.data_item = 1;\r\nout.data[0] = enc_param->bitrate;\r\nbreak;\r\ncase VENC_SET_PARAM_ADJUST_FRAMERATE:\r\nout.data_item = 1;\r\nout.data[0] = enc_param->frm_rate;\r\nbreak;\r\ncase VENC_SET_PARAM_GOP_SIZE:\r\nout.data_item = 1;\r\nout.data[0] = enc_param->gop_size;\r\nbreak;\r\ncase VENC_SET_PARAM_INTRA_PERIOD:\r\nout.data_item = 1;\r\nout.data[0] = enc_param->intra_period;\r\nbreak;\r\ncase VENC_SET_PARAM_SKIP_FRAME:\r\nout.data_item = 0;\r\nbreak;\r\ndefault:\r\nmtk_vcodec_err(vpu, "id %d not supported", id);\r\nreturn -EINVAL;\r\n}\r\nif (vpu_enc_send_msg(vpu, &out, sizeof(out))) {\r\nmtk_vcodec_err(vpu,\r\n"AP_IPIMSG_ENC_SET_PARAM %d fail", id);\r\nreturn -EINVAL;\r\n}\r\nmtk_vcodec_debug(vpu, "id %d <-", id);\r\nreturn 0;\r\n}\r\nint vpu_enc_encode(struct venc_vpu_inst *vpu, unsigned int bs_mode,\r\nstruct venc_frm_buf *frm_buf,\r\nstruct mtk_vcodec_mem *bs_buf,\r\nunsigned int *bs_size)\r\n{\r\nstruct venc_ap_ipi_msg_enc out;\r\nmtk_vcodec_debug(vpu, "bs_mode %d ->", bs_mode);\r\nmemset(&out, 0, sizeof(out));\r\nout.msg_id = AP_IPIMSG_ENC_ENCODE;\r\nout.vpu_inst_addr = vpu->inst_addr;\r\nout.bs_mode = bs_mode;\r\nif (frm_buf) {\r\nif ((frm_buf->fb_addr[0].dma_addr % 16 == 0) &&\r\n(frm_buf->fb_addr[1].dma_addr % 16 == 0) &&\r\n(frm_buf->fb_addr[2].dma_addr % 16 == 0)) {\r\nout.input_addr[0] = frm_buf->fb_addr[0].dma_addr;\r\nout.input_addr[1] = frm_buf->fb_addr[1].dma_addr;\r\nout.input_addr[2] = frm_buf->fb_addr[2].dma_addr;\r\n} else {\r\nmtk_vcodec_err(vpu, "dma_addr not align to 16");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (bs_buf) {\r\nout.bs_addr = bs_buf->dma_addr;\r\nout.bs_size = bs_buf->size;\r\n}\r\nif (vpu_enc_send_msg(vpu, &out, sizeof(out))) {\r\nmtk_vcodec_err(vpu, "AP_IPIMSG_ENC_ENCODE %d fail",\r\nbs_mode);\r\nreturn -EINVAL;\r\n}\r\nmtk_vcodec_debug(vpu, "bs_mode %d state %d size %d key_frm %d <-",\r\nbs_mode, vpu->state, vpu->bs_size, vpu->is_key_frm);\r\nreturn 0;\r\n}\r\nint vpu_enc_deinit(struct venc_vpu_inst *vpu)\r\n{\r\nstruct venc_ap_ipi_msg_deinit out;\r\nmtk_vcodec_debug_enter(vpu);\r\nmemset(&out, 0, sizeof(out));\r\nout.msg_id = AP_IPIMSG_ENC_DEINIT;\r\nout.vpu_inst_addr = vpu->inst_addr;\r\nif (vpu_enc_send_msg(vpu, &out, sizeof(out))) {\r\nmtk_vcodec_err(vpu, "AP_IPIMSG_ENC_DEINIT fail");\r\nreturn -EINVAL;\r\n}\r\nmtk_vcodec_debug_leave(vpu);\r\nreturn 0;\r\n}

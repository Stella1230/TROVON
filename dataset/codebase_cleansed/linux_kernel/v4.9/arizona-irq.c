static int arizona_map_irq(struct arizona *arizona, int irq)\r\n{\r\nint ret;\r\nif (arizona->aod_irq_chip) {\r\nret = regmap_irq_get_virq(arizona->aod_irq_chip, irq);\r\nif (ret >= 0)\r\nreturn ret;\r\n}\r\nreturn regmap_irq_get_virq(arizona->irq_chip, irq);\r\n}\r\nint arizona_request_irq(struct arizona *arizona, int irq, char *name,\r\nirq_handler_t handler, void *data)\r\n{\r\nirq = arizona_map_irq(arizona, irq);\r\nif (irq < 0)\r\nreturn irq;\r\nreturn request_threaded_irq(irq, NULL, handler, IRQF_ONESHOT,\r\nname, data);\r\n}\r\nvoid arizona_free_irq(struct arizona *arizona, int irq, void *data)\r\n{\r\nirq = arizona_map_irq(arizona, irq);\r\nif (irq < 0)\r\nreturn;\r\nfree_irq(irq, data);\r\n}\r\nint arizona_set_irq_wake(struct arizona *arizona, int irq, int on)\r\n{\r\nirq = arizona_map_irq(arizona, irq);\r\nif (irq < 0)\r\nreturn irq;\r\nreturn irq_set_irq_wake(irq, on);\r\n}\r\nstatic irqreturn_t arizona_boot_done(int irq, void *data)\r\n{\r\nstruct arizona *arizona = data;\r\ndev_dbg(arizona->dev, "Boot done\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t arizona_ctrlif_err(int irq, void *data)\r\n{\r\nstruct arizona *arizona = data;\r\ndev_err(arizona->dev, "Control interface error\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t arizona_irq_thread(int irq, void *data)\r\n{\r\nstruct arizona *arizona = data;\r\nbool poll;\r\nunsigned int val;\r\nint ret;\r\nret = pm_runtime_get_sync(arizona->dev);\r\nif (ret < 0) {\r\ndev_err(arizona->dev, "Failed to resume device: %d\n", ret);\r\nreturn IRQ_NONE;\r\n}\r\ndo {\r\npoll = false;\r\nif (arizona->aod_irq_chip) {\r\nret = regmap_read(arizona->regmap,\r\nARIZONA_AOD_IRQ1, &val);\r\nif (ret)\r\ndev_warn(arizona->dev,\r\n"Failed to read AOD IRQ1 %d\n", ret);\r\nelse if (val)\r\nhandle_nested_irq(\r\nirq_find_mapping(arizona->virq, 0));\r\n}\r\nret = regmap_read(arizona->regmap, ARIZONA_IRQ_PIN_STATUS,\r\n&val);\r\nif (ret == 0 && val & ARIZONA_IRQ1_STS) {\r\nhandle_nested_irq(irq_find_mapping(arizona->virq, 1));\r\n} else if (ret != 0) {\r\ndev_err(arizona->dev,\r\n"Failed to read main IRQ status: %d\n", ret);\r\n}\r\nif (!arizona->pdata.irq_gpio) {\r\nbreak;\r\n} else if (arizona->pdata.irq_flags & IRQF_TRIGGER_RISING &&\r\ngpio_get_value_cansleep(arizona->pdata.irq_gpio)) {\r\npoll = true;\r\n} else if (arizona->pdata.irq_flags & IRQF_TRIGGER_FALLING &&\r\n!gpio_get_value_cansleep(arizona->pdata.irq_gpio)) {\r\npoll = true;\r\n}\r\n} while (poll);\r\npm_runtime_mark_last_busy(arizona->dev);\r\npm_runtime_put_autosuspend(arizona->dev);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void arizona_irq_enable(struct irq_data *data)\r\n{\r\n}\r\nstatic void arizona_irq_disable(struct irq_data *data)\r\n{\r\n}\r\nstatic int arizona_irq_set_wake(struct irq_data *data, unsigned int on)\r\n{\r\nstruct arizona *arizona = irq_data_get_irq_chip_data(data);\r\nreturn irq_set_irq_wake(arizona->irq, on);\r\n}\r\nstatic int arizona_irq_map(struct irq_domain *h, unsigned int virq,\r\nirq_hw_number_t hw)\r\n{\r\nstruct arizona *data = h->host_data;\r\nirq_set_chip_data(virq, data);\r\nirq_set_lockdep_class(virq, &arizona_irq_lock_class);\r\nirq_set_chip_and_handler(virq, &arizona_irq_chip, handle_simple_irq);\r\nirq_set_nested_thread(virq, 1);\r\nirq_set_noprobe(virq);\r\nreturn 0;\r\n}\r\nint arizona_irq_init(struct arizona *arizona)\r\n{\r\nint flags = IRQF_ONESHOT;\r\nint ret, i;\r\nconst struct regmap_irq_chip *aod, *irq;\r\nstruct irq_data *irq_data;\r\narizona->ctrlif_error = true;\r\nswitch (arizona->type) {\r\n#ifdef CONFIG_MFD_WM5102\r\ncase WM5102:\r\naod = &wm5102_aod;\r\nirq = &wm5102_irq;\r\narizona->ctrlif_error = false;\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_MFD_WM5110\r\ncase WM5110:\r\ncase WM8280:\r\naod = &wm5110_aod;\r\nswitch (arizona->rev) {\r\ncase 0 ... 2:\r\nirq = &wm5110_irq;\r\nbreak;\r\ndefault:\r\nirq = &wm5110_revd_irq;\r\nbreak;\r\n}\r\narizona->ctrlif_error = false;\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_MFD_CS47L24\r\ncase WM1831:\r\ncase CS47L24:\r\naod = NULL;\r\nirq = &cs47l24_irq;\r\narizona->ctrlif_error = false;\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_MFD_WM8997\r\ncase WM8997:\r\naod = &wm8997_aod;\r\nirq = &wm8997_irq;\r\narizona->ctrlif_error = false;\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_MFD_WM8998\r\ncase WM8998:\r\ncase WM1814:\r\naod = &wm8998_aod;\r\nirq = &wm8998_irq;\r\narizona->ctrlif_error = false;\r\nbreak;\r\n#endif\r\ndefault:\r\nBUG_ON("Unknown Arizona class device" == NULL);\r\nreturn -EINVAL;\r\n}\r\nregmap_write(arizona->regmap, ARIZONA_WAKE_CONTROL, 0);\r\nif (!arizona->pdata.irq_flags) {\r\nirq_data = irq_get_irq_data(arizona->irq);\r\nif (!irq_data) {\r\ndev_err(arizona->dev, "Invalid IRQ: %d\n",\r\narizona->irq);\r\nreturn -EINVAL;\r\n}\r\narizona->pdata.irq_flags = irqd_get_trigger_type(irq_data);\r\nswitch (arizona->pdata.irq_flags) {\r\ncase IRQF_TRIGGER_LOW:\r\ncase IRQF_TRIGGER_HIGH:\r\ncase IRQF_TRIGGER_RISING:\r\ncase IRQF_TRIGGER_FALLING:\r\nbreak;\r\ncase IRQ_TYPE_NONE:\r\ndefault:\r\narizona->pdata.irq_flags = IRQF_TRIGGER_LOW;\r\nbreak;\r\n}\r\n}\r\nif (arizona->pdata.irq_flags & (IRQF_TRIGGER_HIGH |\r\nIRQF_TRIGGER_RISING)) {\r\nret = regmap_update_bits(arizona->regmap, ARIZONA_IRQ_CTRL_1,\r\nARIZONA_IRQ_POL, 0);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Couldn't set IRQ polarity: %d\n",\r\nret);\r\ngoto err;\r\n}\r\n}\r\nflags |= arizona->pdata.irq_flags;\r\narizona->virq = irq_domain_add_linear(NULL, 2, &arizona_domain_ops,\r\narizona);\r\nif (!arizona->virq) {\r\ndev_err(arizona->dev, "Failed to add core IRQ domain\n");\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\nif (aod) {\r\nret = regmap_add_irq_chip(arizona->regmap,\r\nirq_create_mapping(arizona->virq, 0),\r\nIRQF_ONESHOT, 0, aod,\r\n&arizona->aod_irq_chip);\r\nif (ret != 0) {\r\ndev_err(arizona->dev,\r\n"Failed to add AOD IRQs: %d\n", ret);\r\ngoto err;\r\n}\r\n}\r\nret = regmap_add_irq_chip(arizona->regmap,\r\nirq_create_mapping(arizona->virq, 1),\r\nIRQF_ONESHOT, 0, irq,\r\n&arizona->irq_chip);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to add main IRQs: %d\n", ret);\r\ngoto err_aod;\r\n}\r\nif (arizona->pdata.irq_gpio) {\r\nif (gpio_to_irq(arizona->pdata.irq_gpio) != arizona->irq) {\r\ndev_warn(arizona->dev, "IRQ %d is not GPIO %d (%d)\n",\r\narizona->irq, arizona->pdata.irq_gpio,\r\ngpio_to_irq(arizona->pdata.irq_gpio));\r\narizona->irq = gpio_to_irq(arizona->pdata.irq_gpio);\r\n}\r\nret = devm_gpio_request_one(arizona->dev,\r\narizona->pdata.irq_gpio,\r\nGPIOF_IN, "arizona IRQ");\r\nif (ret != 0) {\r\ndev_err(arizona->dev,\r\n"Failed to request IRQ GPIO %d:: %d\n",\r\narizona->pdata.irq_gpio, ret);\r\narizona->pdata.irq_gpio = 0;\r\n}\r\n}\r\nret = request_threaded_irq(arizona->irq, NULL, arizona_irq_thread,\r\nflags, "arizona", arizona);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to request primary IRQ %d: %d\n",\r\narizona->irq, ret);\r\ngoto err_main_irq;\r\n}\r\ni = arizona_map_irq(arizona, ARIZONA_IRQ_BOOT_DONE);\r\nret = request_threaded_irq(i, NULL, arizona_boot_done, IRQF_ONESHOT,\r\n"Boot done", arizona);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to request boot done %d: %d\n",\r\narizona->irq, ret);\r\ngoto err_boot_done;\r\n}\r\nif (arizona->ctrlif_error) {\r\ni = arizona_map_irq(arizona, ARIZONA_IRQ_CTRLIF_ERR);\r\nret = request_threaded_irq(i, NULL, arizona_ctrlif_err,\r\nIRQF_ONESHOT,\r\n"Control interface error", arizona);\r\nif (ret != 0) {\r\ndev_err(arizona->dev,\r\n"Failed to request CTRLIF_ERR %d: %d\n",\r\narizona->irq, ret);\r\ngoto err_ctrlif;\r\n}\r\n}\r\nreturn 0;\r\nerr_ctrlif:\r\nfree_irq(arizona_map_irq(arizona, ARIZONA_IRQ_BOOT_DONE), arizona);\r\nerr_boot_done:\r\nfree_irq(arizona->irq, arizona);\r\nerr_main_irq:\r\nregmap_del_irq_chip(irq_create_mapping(arizona->virq, 1),\r\narizona->irq_chip);\r\nerr_aod:\r\nregmap_del_irq_chip(irq_create_mapping(arizona->virq, 0),\r\narizona->aod_irq_chip);\r\nerr:\r\nreturn ret;\r\n}\r\nint arizona_irq_exit(struct arizona *arizona)\r\n{\r\nif (arizona->ctrlif_error)\r\nfree_irq(arizona_map_irq(arizona, ARIZONA_IRQ_CTRLIF_ERR),\r\narizona);\r\nfree_irq(arizona_map_irq(arizona, ARIZONA_IRQ_BOOT_DONE), arizona);\r\nregmap_del_irq_chip(irq_create_mapping(arizona->virq, 1),\r\narizona->irq_chip);\r\nregmap_del_irq_chip(irq_create_mapping(arizona->virq, 0),\r\narizona->aod_irq_chip);\r\nfree_irq(arizona->irq, arizona);\r\nreturn 0;\r\n}

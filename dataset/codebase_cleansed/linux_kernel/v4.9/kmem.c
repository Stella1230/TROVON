void *\r\nkmem_zalloc_greedy(size_t *size, size_t minsize, size_t maxsize)\r\n{\r\nvoid *ptr;\r\nsize_t kmsize = maxsize;\r\nwhile (!(ptr = vzalloc(kmsize))) {\r\nif ((kmsize >>= 1) <= minsize)\r\nkmsize = minsize;\r\n}\r\nif (ptr)\r\n*size = kmsize;\r\nreturn ptr;\r\n}\r\nvoid *\r\nkmem_alloc(size_t size, xfs_km_flags_t flags)\r\n{\r\nint retries = 0;\r\ngfp_t lflags = kmem_flags_convert(flags);\r\nvoid *ptr;\r\ndo {\r\nptr = kmalloc(size, lflags);\r\nif (ptr || (flags & (KM_MAYFAIL|KM_NOSLEEP)))\r\nreturn ptr;\r\nif (!(++retries % 100))\r\nxfs_err(NULL,\r\n"%s(%u) possible memory allocation deadlock size %u in %s (mode:0x%x)",\r\ncurrent->comm, current->pid,\r\n(unsigned int)size, __func__, lflags);\r\ncongestion_wait(BLK_RW_ASYNC, HZ/50);\r\n} while (1);\r\n}\r\nvoid *\r\nkmem_zalloc_large(size_t size, xfs_km_flags_t flags)\r\n{\r\nunsigned noio_flag = 0;\r\nvoid *ptr;\r\ngfp_t lflags;\r\nptr = kmem_zalloc(size, flags | KM_MAYFAIL);\r\nif (ptr)\r\nreturn ptr;\r\nif ((current->flags & PF_FSTRANS) || (flags & KM_NOFS))\r\nnoio_flag = memalloc_noio_save();\r\nlflags = kmem_flags_convert(flags);\r\nptr = __vmalloc(size, lflags | __GFP_HIGHMEM | __GFP_ZERO, PAGE_KERNEL);\r\nif ((current->flags & PF_FSTRANS) || (flags & KM_NOFS))\r\nmemalloc_noio_restore(noio_flag);\r\nreturn ptr;\r\n}\r\nvoid *\r\nkmem_realloc(const void *old, size_t newsize, xfs_km_flags_t flags)\r\n{\r\nint retries = 0;\r\ngfp_t lflags = kmem_flags_convert(flags);\r\nvoid *ptr;\r\ndo {\r\nptr = krealloc(old, newsize, lflags);\r\nif (ptr || (flags & (KM_MAYFAIL|KM_NOSLEEP)))\r\nreturn ptr;\r\nif (!(++retries % 100))\r\nxfs_err(NULL,\r\n"%s(%u) possible memory allocation deadlock size %zu in %s (mode:0x%x)",\r\ncurrent->comm, current->pid,\r\nnewsize, __func__, lflags);\r\ncongestion_wait(BLK_RW_ASYNC, HZ/50);\r\n} while (1);\r\n}\r\nvoid *\r\nkmem_zone_alloc(kmem_zone_t *zone, xfs_km_flags_t flags)\r\n{\r\nint retries = 0;\r\ngfp_t lflags = kmem_flags_convert(flags);\r\nvoid *ptr;\r\ndo {\r\nptr = kmem_cache_alloc(zone, lflags);\r\nif (ptr || (flags & (KM_MAYFAIL|KM_NOSLEEP)))\r\nreturn ptr;\r\nif (!(++retries % 100))\r\nxfs_err(NULL,\r\n"%s(%u) possible memory allocation deadlock in %s (mode:0x%x)",\r\ncurrent->comm, current->pid,\r\n__func__, lflags);\r\ncongestion_wait(BLK_RW_ASYNC, HZ/50);\r\n} while (1);\r\n}

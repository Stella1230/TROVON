static int wilc_wlan_cfg_set_byte(u8 *frame, u32 offset, u16 id, u8 val8)\r\n{\r\nu8 *buf;\r\nif ((offset + 4) >= MAX_CFG_FRAME_SIZE)\r\nreturn 0;\r\nbuf = &frame[offset];\r\nbuf[0] = (u8)id;\r\nbuf[1] = (u8)(id >> 8);\r\nbuf[2] = 1;\r\nbuf[3] = val8;\r\nreturn 4;\r\n}\r\nstatic int wilc_wlan_cfg_set_hword(u8 *frame, u32 offset, u16 id, u16 val16)\r\n{\r\nu8 *buf;\r\nif ((offset + 5) >= MAX_CFG_FRAME_SIZE)\r\nreturn 0;\r\nbuf = &frame[offset];\r\nbuf[0] = (u8)id;\r\nbuf[1] = (u8)(id >> 8);\r\nbuf[2] = 2;\r\nbuf[3] = (u8)val16;\r\nbuf[4] = (u8)(val16 >> 8);\r\nreturn 5;\r\n}\r\nstatic int wilc_wlan_cfg_set_word(u8 *frame, u32 offset, u16 id, u32 val32)\r\n{\r\nu8 *buf;\r\nif ((offset + 7) >= MAX_CFG_FRAME_SIZE)\r\nreturn 0;\r\nbuf = &frame[offset];\r\nbuf[0] = (u8)id;\r\nbuf[1] = (u8)(id >> 8);\r\nbuf[2] = 4;\r\nbuf[3] = (u8)val32;\r\nbuf[4] = (u8)(val32 >> 8);\r\nbuf[5] = (u8)(val32 >> 16);\r\nbuf[6] = (u8)(val32 >> 24);\r\nreturn 7;\r\n}\r\nstatic int wilc_wlan_cfg_set_str(u8 *frame, u32 offset, u16 id, u8 *str, u32 size)\r\n{\r\nu8 *buf;\r\nif ((offset + size + 3) >= MAX_CFG_FRAME_SIZE)\r\nreturn 0;\r\nbuf = &frame[offset];\r\nbuf[0] = (u8)id;\r\nbuf[1] = (u8)(id >> 8);\r\nbuf[2] = (u8)size;\r\nif ((str) && (size != 0))\r\nmemcpy(&buf[3], str, size);\r\nreturn (size + 3);\r\n}\r\nstatic int wilc_wlan_cfg_set_bin(u8 *frame, u32 offset, u16 id, u8 *b, u32 size)\r\n{\r\nu8 *buf;\r\nu32 i;\r\nu8 checksum = 0;\r\nif ((offset + size + 5) >= MAX_CFG_FRAME_SIZE)\r\nreturn 0;\r\nbuf = &frame[offset];\r\nbuf[0] = (u8)id;\r\nbuf[1] = (u8)(id >> 8);\r\nbuf[2] = (u8)size;\r\nbuf[3] = (u8)(size >> 8);\r\nif ((b) && (size != 0)) {\r\nmemcpy(&buf[4], b, size);\r\nfor (i = 0; i < size; i++)\r\nchecksum += buf[i + 4];\r\n}\r\nbuf[size + 4] = checksum;\r\nreturn (size + 5);\r\n}\r\nstatic void wilc_wlan_parse_response_frame(u8 *info, int size)\r\n{\r\nu32 wid, len = 0, i = 0;\r\nwhile (size > 0) {\r\ni = 0;\r\nwid = info[0] | (info[1] << 8);\r\nwid = cpu_to_le32(wid);\r\nswitch ((wid >> 12) & 0x7) {\r\ncase WID_CHAR:\r\ndo {\r\nif (g_cfg_byte[i].id == WID_NIL)\r\nbreak;\r\nif (g_cfg_byte[i].id == wid) {\r\ng_cfg_byte[i].val = info[3];\r\nbreak;\r\n}\r\ni++;\r\n} while (1);\r\nlen = 2;\r\nbreak;\r\ncase WID_SHORT:\r\ndo {\r\nif (g_cfg_hword[i].id == WID_NIL)\r\nbreak;\r\nif (g_cfg_hword[i].id == wid) {\r\ng_cfg_hword[i].val = cpu_to_le16(info[3] | (info[4] << 8));\r\nbreak;\r\n}\r\ni++;\r\n} while (1);\r\nlen = 3;\r\nbreak;\r\ncase WID_INT:\r\ndo {\r\nif (g_cfg_word[i].id == WID_NIL)\r\nbreak;\r\nif (g_cfg_word[i].id == wid) {\r\ng_cfg_word[i].val = cpu_to_le32(info[3] | (info[4] << 8) | (info[5] << 16) | (info[6] << 24));\r\nbreak;\r\n}\r\ni++;\r\n} while (1);\r\nlen = 5;\r\nbreak;\r\ncase WID_STR:\r\ndo {\r\nif (g_cfg_str[i].id == WID_NIL)\r\nbreak;\r\nif (g_cfg_str[i].id == wid) {\r\nif (wid == WID_SITE_SURVEY_RESULTS) {\r\nstatic int toggle;\r\ni += toggle;\r\ntoggle ^= 1;\r\n}\r\nmemcpy(g_cfg_str[i].str, &info[2], (info[2] + 1));\r\nbreak;\r\n}\r\ni++;\r\n} while (1);\r\nlen = 1 + info[2];\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nsize -= (2 + len);\r\ninfo += (2 + len);\r\n}\r\n}\r\nstatic int wilc_wlan_parse_info_frame(u8 *info, int size)\r\n{\r\nstruct wilc_mac_cfg *pd = &g_mac;\r\nu32 wid, len;\r\nint type = WILC_CFG_RSP_STATUS;\r\nwid = info[0] | (info[1] << 8);\r\nlen = info[2];\r\nif ((len == 1) && (wid == WID_STATUS)) {\r\npd->mac_status = info[3];\r\ntype = WILC_CFG_RSP_STATUS;\r\n}\r\nreturn type;\r\n}\r\nint wilc_wlan_cfg_set_wid(u8 *frame, u32 offset, u16 id, u8 *buf, int size)\r\n{\r\nu8 type = (id >> 12) & 0xf;\r\nint ret = 0;\r\nswitch (type) {\r\ncase CFG_BYTE_CMD:\r\nif (size >= 1)\r\nret = wilc_wlan_cfg_set_byte(frame, offset, id, *buf);\r\nbreak;\r\ncase CFG_HWORD_CMD:\r\nif (size >= 2)\r\nret = wilc_wlan_cfg_set_hword(frame, offset, id,\r\n*((u16 *)buf));\r\nbreak;\r\ncase CFG_WORD_CMD:\r\nif (size >= 4)\r\nret = wilc_wlan_cfg_set_word(frame, offset, id,\r\n*((u32 *)buf));\r\nbreak;\r\ncase CFG_STR_CMD:\r\nret = wilc_wlan_cfg_set_str(frame, offset, id, buf, size);\r\nbreak;\r\ncase CFG_BIN_CMD:\r\nret = wilc_wlan_cfg_set_bin(frame, offset, id, buf, size);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nint wilc_wlan_cfg_get_wid(u8 *frame, u32 offset, u16 id)\r\n{\r\nu8 *buf;\r\nif ((offset + 2) >= MAX_CFG_FRAME_SIZE)\r\nreturn 0;\r\nbuf = &frame[offset];\r\nbuf[0] = (u8)id;\r\nbuf[1] = (u8)(id >> 8);\r\nreturn 2;\r\n}\r\nint wilc_wlan_cfg_get_wid_value(u16 wid, u8 *buffer, u32 buffer_size)\r\n{\r\nu32 type = (wid >> 12) & 0xf;\r\nint i, ret = 0;\r\nif (wid == WID_STATUS) {\r\n*((u32 *)buffer) = g_mac.mac_status;\r\nreturn 4;\r\n}\r\ni = 0;\r\nif (type == CFG_BYTE_CMD) {\r\ndo {\r\nif (g_cfg_byte[i].id == WID_NIL)\r\nbreak;\r\nif (g_cfg_byte[i].id == wid) {\r\nmemcpy(buffer, &g_cfg_byte[i].val, 1);\r\nret = 1;\r\nbreak;\r\n}\r\ni++;\r\n} while (1);\r\n} else if (type == CFG_HWORD_CMD) {\r\ndo {\r\nif (g_cfg_hword[i].id == WID_NIL)\r\nbreak;\r\nif (g_cfg_hword[i].id == wid) {\r\nmemcpy(buffer, &g_cfg_hword[i].val, 2);\r\nret = 2;\r\nbreak;\r\n}\r\ni++;\r\n} while (1);\r\n} else if (type == CFG_WORD_CMD) {\r\ndo {\r\nif (g_cfg_word[i].id == WID_NIL)\r\nbreak;\r\nif (g_cfg_word[i].id == wid) {\r\nmemcpy(buffer, &g_cfg_word[i].val, 4);\r\nret = 4;\r\nbreak;\r\n}\r\ni++;\r\n} while (1);\r\n} else if (type == CFG_STR_CMD) {\r\ndo {\r\nif (g_cfg_str[i].id == WID_NIL)\r\nbreak;\r\nif (g_cfg_str[i].id == wid) {\r\nu32 size = g_cfg_str[i].str[0];\r\nif (buffer_size >= size) {\r\nif (g_cfg_str[i].id == WID_SITE_SURVEY_RESULTS) {\r\nstatic int toggle;\r\ni += toggle;\r\ntoggle ^= 1;\r\n}\r\nmemcpy(buffer, &g_cfg_str[i].str[1], size);\r\nret = size;\r\n}\r\nbreak;\r\n}\r\ni++;\r\n} while (1);\r\n}\r\nreturn ret;\r\n}\r\nint wilc_wlan_cfg_indicate_rx(struct wilc *wilc, u8 *frame, int size,\r\nstruct wilc_cfg_rsp *rsp)\r\n{\r\nint ret = 1;\r\nu8 msg_type;\r\nu8 msg_id;\r\nmsg_type = frame[0];\r\nmsg_id = frame[1];\r\nframe += 4;\r\nsize -= 4;\r\nswitch (msg_type) {\r\ncase 'R':\r\nwilc_wlan_parse_response_frame(frame, size);\r\nrsp->type = WILC_CFG_RSP;\r\nrsp->seq_no = msg_id;\r\nbreak;\r\ncase 'I':\r\nrsp->type = wilc_wlan_parse_info_frame(frame, size);\r\nrsp->seq_no = msg_id;\r\nwilc_gnrl_async_info_received(wilc, frame - 4, size + 4);\r\nbreak;\r\ncase 'N':\r\nwilc_network_info_received(wilc, frame - 4, size + 4);\r\nrsp->type = 0;\r\nbreak;\r\ncase 'S':\r\nwilc_scan_complete_received(wilc, frame - 4, size + 4);\r\nbreak;\r\ndefault:\r\nrsp->type = 0;\r\nrsp->seq_no = msg_id;\r\nret = 0;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nint wilc_wlan_cfg_init(void)\r\n{\r\nmemset((void *)&g_mac, 0, sizeof(struct wilc_mac_cfg));\r\nreturn 1;\r\n}

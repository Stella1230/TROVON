static u8\r\namdgpu_atombios_encoder_get_backlight_level_from_reg(struct amdgpu_device *adev)\r\n{\r\nu8 backlight_level;\r\nu32 bios_2_scratch;\r\nbios_2_scratch = RREG32(mmBIOS_SCRATCH_2);\r\nbacklight_level = ((bios_2_scratch & ATOM_S2_CURRENT_BL_LEVEL_MASK) >>\r\nATOM_S2_CURRENT_BL_LEVEL_SHIFT);\r\nreturn backlight_level;\r\n}\r\nstatic void\r\namdgpu_atombios_encoder_set_backlight_level_to_reg(struct amdgpu_device *adev,\r\nu8 backlight_level)\r\n{\r\nu32 bios_2_scratch;\r\nbios_2_scratch = RREG32(mmBIOS_SCRATCH_2);\r\nbios_2_scratch &= ~ATOM_S2_CURRENT_BL_LEVEL_MASK;\r\nbios_2_scratch |= ((backlight_level << ATOM_S2_CURRENT_BL_LEVEL_SHIFT) &\r\nATOM_S2_CURRENT_BL_LEVEL_MASK);\r\nWREG32(mmBIOS_SCRATCH_2, bios_2_scratch);\r\n}\r\nu8\r\namdgpu_atombios_encoder_get_backlight_level(struct amdgpu_encoder *amdgpu_encoder)\r\n{\r\nstruct drm_device *dev = amdgpu_encoder->base.dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nif (!(adev->mode_info.firmware_flags & ATOM_BIOS_INFO_BL_CONTROLLED_BY_GPU))\r\nreturn 0;\r\nreturn amdgpu_atombios_encoder_get_backlight_level_from_reg(adev);\r\n}\r\nvoid\r\namdgpu_atombios_encoder_set_backlight_level(struct amdgpu_encoder *amdgpu_encoder,\r\nu8 level)\r\n{\r\nstruct drm_encoder *encoder = &amdgpu_encoder->base;\r\nstruct drm_device *dev = amdgpu_encoder->base.dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct amdgpu_encoder_atom_dig *dig;\r\nif (!(adev->mode_info.firmware_flags & ATOM_BIOS_INFO_BL_CONTROLLED_BY_GPU))\r\nreturn;\r\nif ((amdgpu_encoder->devices & (ATOM_DEVICE_LCD_SUPPORT)) &&\r\namdgpu_encoder->enc_priv) {\r\ndig = amdgpu_encoder->enc_priv;\r\ndig->backlight_level = level;\r\namdgpu_atombios_encoder_set_backlight_level_to_reg(adev, dig->backlight_level);\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\r\nif (dig->backlight_level == 0)\r\namdgpu_atombios_encoder_setup_dig_transmitter(encoder,\r\nATOM_TRANSMITTER_ACTION_LCD_BLOFF, 0, 0);\r\nelse {\r\namdgpu_atombios_encoder_setup_dig_transmitter(encoder,\r\nATOM_TRANSMITTER_ACTION_BL_BRIGHTNESS_CONTROL, 0, 0);\r\namdgpu_atombios_encoder_setup_dig_transmitter(encoder,\r\nATOM_TRANSMITTER_ACTION_LCD_BLON, 0, 0);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic u8 amdgpu_atombios_encoder_backlight_level(struct backlight_device *bd)\r\n{\r\nu8 level;\r\nif (bd->props.brightness < 0)\r\nlevel = 0;\r\nelse if (bd->props.brightness > AMDGPU_MAX_BL_LEVEL)\r\nlevel = AMDGPU_MAX_BL_LEVEL;\r\nelse\r\nlevel = bd->props.brightness;\r\nreturn level;\r\n}\r\nstatic int amdgpu_atombios_encoder_update_backlight_status(struct backlight_device *bd)\r\n{\r\nstruct amdgpu_backlight_privdata *pdata = bl_get_data(bd);\r\nstruct amdgpu_encoder *amdgpu_encoder = pdata->encoder;\r\namdgpu_atombios_encoder_set_backlight_level(amdgpu_encoder,\r\namdgpu_atombios_encoder_backlight_level(bd));\r\nreturn 0;\r\n}\r\nstatic int\r\namdgpu_atombios_encoder_get_backlight_brightness(struct backlight_device *bd)\r\n{\r\nstruct amdgpu_backlight_privdata *pdata = bl_get_data(bd);\r\nstruct amdgpu_encoder *amdgpu_encoder = pdata->encoder;\r\nstruct drm_device *dev = amdgpu_encoder->base.dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nreturn amdgpu_atombios_encoder_get_backlight_level_from_reg(adev);\r\n}\r\nvoid amdgpu_atombios_encoder_init_backlight(struct amdgpu_encoder *amdgpu_encoder,\r\nstruct drm_connector *drm_connector)\r\n{\r\nstruct drm_device *dev = amdgpu_encoder->base.dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct backlight_device *bd;\r\nstruct backlight_properties props;\r\nstruct amdgpu_backlight_privdata *pdata;\r\nstruct amdgpu_encoder_atom_dig *dig;\r\nu8 backlight_level;\r\nchar bl_name[16];\r\nif ((adev->pdev->subsystem_vendor == PCI_VENDOR_ID_APPLE) &&\r\n(adev->pdev->device == 0x6741))\r\nreturn;\r\nif (!amdgpu_encoder->enc_priv)\r\nreturn;\r\nif (!adev->is_atom_bios)\r\nreturn;\r\nif (!(adev->mode_info.firmware_flags & ATOM_BIOS_INFO_BL_CONTROLLED_BY_GPU))\r\nreturn;\r\npdata = kmalloc(sizeof(struct amdgpu_backlight_privdata), GFP_KERNEL);\r\nif (!pdata) {\r\nDRM_ERROR("Memory allocation failed\n");\r\ngoto error;\r\n}\r\nmemset(&props, 0, sizeof(props));\r\nprops.max_brightness = AMDGPU_MAX_BL_LEVEL;\r\nprops.type = BACKLIGHT_RAW;\r\nsnprintf(bl_name, sizeof(bl_name),\r\n"amdgpu_bl%d", dev->primary->index);\r\nbd = backlight_device_register(bl_name, drm_connector->kdev,\r\npdata, &amdgpu_atombios_encoder_backlight_ops, &props);\r\nif (IS_ERR(bd)) {\r\nDRM_ERROR("Backlight registration failed\n");\r\ngoto error;\r\n}\r\npdata->encoder = amdgpu_encoder;\r\nbacklight_level = amdgpu_atombios_encoder_get_backlight_level_from_reg(adev);\r\ndig = amdgpu_encoder->enc_priv;\r\ndig->bl_dev = bd;\r\nbd->props.brightness = amdgpu_atombios_encoder_get_backlight_brightness(bd);\r\nbd->props.power = FB_BLANK_UNBLANK;\r\nbacklight_update_status(bd);\r\nDRM_INFO("amdgpu atom DIG backlight initialized\n");\r\nreturn;\r\nerror:\r\nkfree(pdata);\r\nreturn;\r\n}\r\nvoid\r\namdgpu_atombios_encoder_fini_backlight(struct amdgpu_encoder *amdgpu_encoder)\r\n{\r\nstruct drm_device *dev = amdgpu_encoder->base.dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct backlight_device *bd = NULL;\r\nstruct amdgpu_encoder_atom_dig *dig;\r\nif (!amdgpu_encoder->enc_priv)\r\nreturn;\r\nif (!adev->is_atom_bios)\r\nreturn;\r\nif (!(adev->mode_info.firmware_flags & ATOM_BIOS_INFO_BL_CONTROLLED_BY_GPU))\r\nreturn;\r\ndig = amdgpu_encoder->enc_priv;\r\nbd = dig->bl_dev;\r\ndig->bl_dev = NULL;\r\nif (bd) {\r\nstruct amdgpu_legacy_backlight_privdata *pdata;\r\npdata = bl_get_data(bd);\r\nbacklight_device_unregister(bd);\r\nkfree(pdata);\r\nDRM_INFO("amdgpu atom LVDS backlight unloaded\n");\r\n}\r\n}\r\nvoid amdgpu_atombios_encoder_init_backlight(struct amdgpu_encoder *encoder)\r\n{\r\n}\r\nvoid amdgpu_atombios_encoder_fini_backlight(struct amdgpu_encoder *encoder)\r\n{\r\n}\r\nbool amdgpu_atombios_encoder_is_digital(struct drm_encoder *encoder)\r\n{\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nbool amdgpu_atombios_encoder_mode_fixup(struct drm_encoder *encoder,\r\nconst struct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\namdgpu_encoder_set_active_device(encoder);\r\ndrm_mode_set_crtcinfo(adjusted_mode, 0);\r\nif ((mode->flags & DRM_MODE_FLAG_INTERLACE)\r\n&& (mode->crtc_vsync_start < (mode->crtc_vdisplay + 2)))\r\nadjusted_mode->crtc_vsync_start = adjusted_mode->crtc_vdisplay + 2;\r\nif (mode->crtc_vsync_start == mode->crtc_vdisplay)\r\nadjusted_mode->crtc_vsync_start++;\r\nif (amdgpu_encoder->active_device & (ATOM_DEVICE_LCD_SUPPORT))\r\namdgpu_panel_mode_fixup(encoder, adjusted_mode);\r\nelse if (amdgpu_encoder->rmx_type != RMX_OFF)\r\namdgpu_panel_mode_fixup(encoder, adjusted_mode);\r\nif ((amdgpu_encoder->active_device & (ATOM_DEVICE_DFP_SUPPORT | ATOM_DEVICE_LCD_SUPPORT)) ||\r\n(amdgpu_encoder_get_dp_bridge_encoder_id(encoder) != ENCODER_OBJECT_ID_NONE)) {\r\nstruct drm_connector *connector = amdgpu_get_connector_for_encoder(encoder);\r\namdgpu_atombios_dp_set_link_config(connector, adjusted_mode);\r\n}\r\nreturn true;\r\n}\r\nstatic void\r\namdgpu_atombios_encoder_setup_dac(struct drm_encoder *encoder, int action)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nDAC_ENCODER_CONTROL_PS_ALLOCATION args;\r\nint index = 0;\r\nmemset(&args, 0, sizeof(args));\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_DAC1:\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1:\r\nindex = GetIndexIntoMasterTable(COMMAND, DAC1EncoderControl);\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_DAC2:\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2:\r\nindex = GetIndexIntoMasterTable(COMMAND, DAC2EncoderControl);\r\nbreak;\r\n}\r\nargs.ucAction = action;\r\nargs.ucDacStandard = ATOM_DAC1_PS2;\r\nargs.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\r\namdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\r\n}\r\nstatic u8 amdgpu_atombios_encoder_get_bpc(struct drm_encoder *encoder)\r\n{\r\nint bpc = 8;\r\nif (encoder->crtc) {\r\nstruct amdgpu_crtc *amdgpu_crtc = to_amdgpu_crtc(encoder->crtc);\r\nbpc = amdgpu_crtc->bpc;\r\n}\r\nswitch (bpc) {\r\ncase 0:\r\nreturn PANEL_BPC_UNDEFINE;\r\ncase 6:\r\nreturn PANEL_6BIT_PER_COLOR;\r\ncase 8:\r\ndefault:\r\nreturn PANEL_8BIT_PER_COLOR;\r\ncase 10:\r\nreturn PANEL_10BIT_PER_COLOR;\r\ncase 12:\r\nreturn PANEL_12BIT_PER_COLOR;\r\ncase 16:\r\nreturn PANEL_16BIT_PER_COLOR;\r\n}\r\n}\r\nstatic void\r\namdgpu_atombios_encoder_setup_dvo(struct drm_encoder *encoder, int action)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nunion dvo_encoder_control args;\r\nint index = GetIndexIntoMasterTable(COMMAND, DVOEncoderControl);\r\nuint8_t frev, crev;\r\nmemset(&args, 0, sizeof(args));\r\nif (!amdgpu_atom_parse_cmd_header(adev->mode_info.atom_context, index, &frev, &crev))\r\nreturn;\r\nswitch (frev) {\r\ncase 1:\r\nswitch (crev) {\r\ncase 1:\r\nargs.ext_tmds.sXTmdsEncoder.ucEnable = action;\r\nif (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.ext_tmds.sXTmdsEncoder.ucMisc |= PANEL_ENCODER_MISC_DUAL;\r\nargs.ext_tmds.sXTmdsEncoder.ucMisc |= ATOM_PANEL_MISC_888RGB;\r\nbreak;\r\ncase 2:\r\nargs.dvo.sDVOEncoder.ucAction = action;\r\nargs.dvo.sDVOEncoder.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\r\nargs.dvo.sDVOEncoder.ucDeviceType = ATOM_DEVICE_DFP1_INDEX;\r\nif (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.dvo.sDVOEncoder.usDevAttr.sDigAttrib.ucAttribute |= PANEL_ENCODER_MISC_DUAL;\r\nbreak;\r\ncase 3:\r\nargs.dvo_v3.ucAction = action;\r\nargs.dvo_v3.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\r\nargs.dvo_v3.ucDVOConfig = 0;\r\nbreak;\r\ncase 4:\r\nargs.dvo_v4.ucAction = action;\r\nargs.dvo_v4.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\r\nargs.dvo_v4.ucDVOConfig = 0;\r\nargs.dvo_v4.ucBitPerColor = amdgpu_atombios_encoder_get_bpc(encoder);\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Unknown table version %d, %d\n", frev, crev);\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Unknown table version %d, %d\n", frev, crev);\r\nbreak;\r\n}\r\namdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\r\n}\r\nint amdgpu_atombios_encoder_get_encoder_mode(struct drm_encoder *encoder)\r\n{\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nstruct drm_connector *connector;\r\nstruct amdgpu_connector *amdgpu_connector;\r\nstruct amdgpu_connector_atom_dig *dig_connector;\r\nif (amdgpu_encoder_get_dp_bridge_encoder_id(encoder) != ENCODER_OBJECT_ID_NONE)\r\nreturn ATOM_ENCODER_MODE_DP;\r\nif ((amdgpu_encoder->encoder_id == ENCODER_OBJECT_ID_INTERNAL_DVO1) ||\r\n(amdgpu_encoder->encoder_id == ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1))\r\nreturn ATOM_ENCODER_MODE_DVO;\r\nconnector = amdgpu_get_connector_for_encoder(encoder);\r\nif (!connector)\r\nconnector = amdgpu_get_connector_for_encoder_init(encoder);\r\namdgpu_connector = to_amdgpu_connector(connector);\r\nswitch (connector->connector_type) {\r\ncase DRM_MODE_CONNECTOR_DVII:\r\ncase DRM_MODE_CONNECTOR_HDMIB:\r\nif (amdgpu_audio != 0) {\r\nif (amdgpu_connector->use_digital &&\r\n(amdgpu_connector->audio == AMDGPU_AUDIO_ENABLE))\r\nreturn ATOM_ENCODER_MODE_HDMI;\r\nelse if (drm_detect_hdmi_monitor(amdgpu_connector_edid(connector)) &&\r\n(amdgpu_connector->audio == AMDGPU_AUDIO_AUTO))\r\nreturn ATOM_ENCODER_MODE_HDMI;\r\nelse if (amdgpu_connector->use_digital)\r\nreturn ATOM_ENCODER_MODE_DVI;\r\nelse\r\nreturn ATOM_ENCODER_MODE_CRT;\r\n} else if (amdgpu_connector->use_digital) {\r\nreturn ATOM_ENCODER_MODE_DVI;\r\n} else {\r\nreturn ATOM_ENCODER_MODE_CRT;\r\n}\r\nbreak;\r\ncase DRM_MODE_CONNECTOR_DVID:\r\ncase DRM_MODE_CONNECTOR_HDMIA:\r\ndefault:\r\nif (amdgpu_audio != 0) {\r\nif (amdgpu_connector->audio == AMDGPU_AUDIO_ENABLE)\r\nreturn ATOM_ENCODER_MODE_HDMI;\r\nelse if (drm_detect_hdmi_monitor(amdgpu_connector_edid(connector)) &&\r\n(amdgpu_connector->audio == AMDGPU_AUDIO_AUTO))\r\nreturn ATOM_ENCODER_MODE_HDMI;\r\nelse\r\nreturn ATOM_ENCODER_MODE_DVI;\r\n} else {\r\nreturn ATOM_ENCODER_MODE_DVI;\r\n}\r\nbreak;\r\ncase DRM_MODE_CONNECTOR_LVDS:\r\nreturn ATOM_ENCODER_MODE_LVDS;\r\nbreak;\r\ncase DRM_MODE_CONNECTOR_DisplayPort:\r\ndig_connector = amdgpu_connector->con_priv;\r\nif ((dig_connector->dp_sink_type == CONNECTOR_OBJECT_ID_DISPLAYPORT) ||\r\n(dig_connector->dp_sink_type == CONNECTOR_OBJECT_ID_eDP)) {\r\nreturn ATOM_ENCODER_MODE_DP;\r\n} else if (amdgpu_audio != 0) {\r\nif (amdgpu_connector->audio == AMDGPU_AUDIO_ENABLE)\r\nreturn ATOM_ENCODER_MODE_HDMI;\r\nelse if (drm_detect_hdmi_monitor(amdgpu_connector_edid(connector)) &&\r\n(amdgpu_connector->audio == AMDGPU_AUDIO_AUTO))\r\nreturn ATOM_ENCODER_MODE_HDMI;\r\nelse\r\nreturn ATOM_ENCODER_MODE_DVI;\r\n} else {\r\nreturn ATOM_ENCODER_MODE_DVI;\r\n}\r\nbreak;\r\ncase DRM_MODE_CONNECTOR_eDP:\r\nreturn ATOM_ENCODER_MODE_DP;\r\ncase DRM_MODE_CONNECTOR_DVIA:\r\ncase DRM_MODE_CONNECTOR_VGA:\r\nreturn ATOM_ENCODER_MODE_CRT;\r\nbreak;\r\ncase DRM_MODE_CONNECTOR_Composite:\r\ncase DRM_MODE_CONNECTOR_SVIDEO:\r\ncase DRM_MODE_CONNECTOR_9PinDIN:\r\nreturn ATOM_ENCODER_MODE_TV;\r\nbreak;\r\n}\r\n}\r\nvoid\r\namdgpu_atombios_encoder_setup_dig_encoder(struct drm_encoder *encoder,\r\nint action, int panel_mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nstruct amdgpu_encoder_atom_dig *dig = amdgpu_encoder->enc_priv;\r\nstruct drm_connector *connector = amdgpu_get_connector_for_encoder(encoder);\r\nunion dig_encoder_control args;\r\nint index = GetIndexIntoMasterTable(COMMAND, DIGxEncoderControl);\r\nuint8_t frev, crev;\r\nint dp_clock = 0;\r\nint dp_lane_count = 0;\r\nint hpd_id = AMDGPU_HPD_NONE;\r\nif (connector) {\r\nstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\r\nstruct amdgpu_connector_atom_dig *dig_connector =\r\namdgpu_connector->con_priv;\r\ndp_clock = dig_connector->dp_clock;\r\ndp_lane_count = dig_connector->dp_lane_count;\r\nhpd_id = amdgpu_connector->hpd.hpd;\r\n}\r\nif (dig->dig_encoder == -1)\r\nreturn;\r\nmemset(&args, 0, sizeof(args));\r\nif (!amdgpu_atom_parse_cmd_header(adev->mode_info.atom_context, index, &frev, &crev))\r\nreturn;\r\nswitch (frev) {\r\ncase 1:\r\nswitch (crev) {\r\ncase 1:\r\nargs.v1.ucAction = action;\r\nargs.v1.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\r\nif (action == ATOM_ENCODER_CMD_SETUP_PANEL_MODE)\r\nargs.v3.ucPanelMode = panel_mode;\r\nelse\r\nargs.v1.ucEncoderMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\r\nif (ENCODER_MODE_IS_DP(args.v1.ucEncoderMode))\r\nargs.v1.ucLaneNum = dp_lane_count;\r\nelse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v1.ucLaneNum = 8;\r\nelse\r\nargs.v1.ucLaneNum = 4;\r\nif (ENCODER_MODE_IS_DP(args.v1.ucEncoderMode) && (dp_clock == 270000))\r\nargs.v1.ucConfig |= ATOM_ENCODER_CONFIG_DPLINKRATE_2_70GHZ;\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\r\nargs.v1.ucConfig = ATOM_ENCODER_CONFIG_V2_TRANSMITTER1;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA:\r\nargs.v1.ucConfig = ATOM_ENCODER_CONFIG_V2_TRANSMITTER2;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\r\nargs.v1.ucConfig = ATOM_ENCODER_CONFIG_V2_TRANSMITTER3;\r\nbreak;\r\n}\r\nif (dig->linkb)\r\nargs.v1.ucConfig |= ATOM_ENCODER_CONFIG_LINKB;\r\nelse\r\nargs.v1.ucConfig |= ATOM_ENCODER_CONFIG_LINKA;\r\nbreak;\r\ncase 2:\r\ncase 3:\r\nargs.v3.ucAction = action;\r\nargs.v3.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\r\nif (action == ATOM_ENCODER_CMD_SETUP_PANEL_MODE)\r\nargs.v3.ucPanelMode = panel_mode;\r\nelse\r\nargs.v3.ucEncoderMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\r\nif (ENCODER_MODE_IS_DP(args.v3.ucEncoderMode))\r\nargs.v3.ucLaneNum = dp_lane_count;\r\nelse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v3.ucLaneNum = 8;\r\nelse\r\nargs.v3.ucLaneNum = 4;\r\nif (ENCODER_MODE_IS_DP(args.v3.ucEncoderMode) && (dp_clock == 270000))\r\nargs.v1.ucConfig |= ATOM_ENCODER_CONFIG_V3_DPLINKRATE_2_70GHZ;\r\nargs.v3.acConfig.ucDigSel = dig->dig_encoder;\r\nargs.v3.ucBitPerColor = amdgpu_atombios_encoder_get_bpc(encoder);\r\nbreak;\r\ncase 4:\r\nargs.v4.ucAction = action;\r\nargs.v4.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\r\nif (action == ATOM_ENCODER_CMD_SETUP_PANEL_MODE)\r\nargs.v4.ucPanelMode = panel_mode;\r\nelse\r\nargs.v4.ucEncoderMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\r\nif (ENCODER_MODE_IS_DP(args.v4.ucEncoderMode))\r\nargs.v4.ucLaneNum = dp_lane_count;\r\nelse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v4.ucLaneNum = 8;\r\nelse\r\nargs.v4.ucLaneNum = 4;\r\nif (ENCODER_MODE_IS_DP(args.v4.ucEncoderMode)) {\r\nif (dp_clock == 540000)\r\nargs.v1.ucConfig |= ATOM_ENCODER_CONFIG_V4_DPLINKRATE_5_40GHZ;\r\nelse if (dp_clock == 324000)\r\nargs.v1.ucConfig |= ATOM_ENCODER_CONFIG_V4_DPLINKRATE_3_24GHZ;\r\nelse if (dp_clock == 270000)\r\nargs.v1.ucConfig |= ATOM_ENCODER_CONFIG_V4_DPLINKRATE_2_70GHZ;\r\nelse\r\nargs.v1.ucConfig |= ATOM_ENCODER_CONFIG_V4_DPLINKRATE_1_62GHZ;\r\n}\r\nargs.v4.acConfig.ucDigSel = dig->dig_encoder;\r\nargs.v4.ucBitPerColor = amdgpu_atombios_encoder_get_bpc(encoder);\r\nif (hpd_id == AMDGPU_HPD_NONE)\r\nargs.v4.ucHPD_ID = 0;\r\nelse\r\nargs.v4.ucHPD_ID = hpd_id + 1;\r\nbreak;\r\ncase 5:\r\nswitch (action) {\r\ncase ATOM_ENCODER_CMD_SETUP_PANEL_MODE:\r\nargs.v5.asDPPanelModeParam.ucAction = action;\r\nargs.v5.asDPPanelModeParam.ucPanelMode = panel_mode;\r\nargs.v5.asDPPanelModeParam.ucDigId = dig->dig_encoder;\r\nbreak;\r\ncase ATOM_ENCODER_CMD_STREAM_SETUP:\r\nargs.v5.asStreamParam.ucAction = action;\r\nargs.v5.asStreamParam.ucDigId = dig->dig_encoder;\r\nargs.v5.asStreamParam.ucDigMode =\r\namdgpu_atombios_encoder_get_encoder_mode(encoder);\r\nif (ENCODER_MODE_IS_DP(args.v5.asStreamParam.ucDigMode))\r\nargs.v5.asStreamParam.ucLaneNum = dp_lane_count;\r\nelse if (amdgpu_dig_monitor_is_duallink(encoder,\r\namdgpu_encoder->pixel_clock))\r\nargs.v5.asStreamParam.ucLaneNum = 8;\r\nelse\r\nargs.v5.asStreamParam.ucLaneNum = 4;\r\nargs.v5.asStreamParam.ulPixelClock =\r\ncpu_to_le32(amdgpu_encoder->pixel_clock / 10);\r\nargs.v5.asStreamParam.ucBitPerColor =\r\namdgpu_atombios_encoder_get_bpc(encoder);\r\nargs.v5.asStreamParam.ucLinkRateIn270Mhz = dp_clock / 27000;\r\nbreak;\r\ncase ATOM_ENCODER_CMD_DP_LINK_TRAINING_START:\r\ncase ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN1:\r\ncase ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN2:\r\ncase ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN3:\r\ncase ATOM_ENCODER_CMD_DP_LINK_TRAINING_PATTERN4:\r\ncase ATOM_ENCODER_CMD_DP_LINK_TRAINING_COMPLETE:\r\ncase ATOM_ENCODER_CMD_DP_VIDEO_OFF:\r\ncase ATOM_ENCODER_CMD_DP_VIDEO_ON:\r\nargs.v5.asCmdParam.ucAction = action;\r\nargs.v5.asCmdParam.ucDigId = dig->dig_encoder;\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Unsupported action 0x%x\n", action);\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Unknown table version %d, %d\n", frev, crev);\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Unknown table version %d, %d\n", frev, crev);\r\nbreak;\r\n}\r\namdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\r\n}\r\nvoid\r\namdgpu_atombios_encoder_setup_dig_transmitter(struct drm_encoder *encoder, int action,\r\nuint8_t lane_num, uint8_t lane_set)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nstruct amdgpu_encoder_atom_dig *dig = amdgpu_encoder->enc_priv;\r\nstruct drm_connector *connector;\r\nunion dig_transmitter_control args;\r\nint index = 0;\r\nuint8_t frev, crev;\r\nbool is_dp = false;\r\nint pll_id = 0;\r\nint dp_clock = 0;\r\nint dp_lane_count = 0;\r\nint connector_object_id = 0;\r\nint igp_lane_info = 0;\r\nint dig_encoder = dig->dig_encoder;\r\nint hpd_id = AMDGPU_HPD_NONE;\r\nif (action == ATOM_TRANSMITTER_ACTION_INIT) {\r\nconnector = amdgpu_get_connector_for_encoder_init(encoder);\r\ndig_encoder = 0;\r\n} else\r\nconnector = amdgpu_get_connector_for_encoder(encoder);\r\nif (connector) {\r\nstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\r\nstruct amdgpu_connector_atom_dig *dig_connector =\r\namdgpu_connector->con_priv;\r\nhpd_id = amdgpu_connector->hpd.hpd;\r\ndp_clock = dig_connector->dp_clock;\r\ndp_lane_count = dig_connector->dp_lane_count;\r\nconnector_object_id =\r\n(amdgpu_connector->connector_object_id & OBJECT_ID_MASK) >> OBJECT_ID_SHIFT;\r\n}\r\nif (encoder->crtc) {\r\nstruct amdgpu_crtc *amdgpu_crtc = to_amdgpu_crtc(encoder->crtc);\r\npll_id = amdgpu_crtc->pll_id;\r\n}\r\nif (dig_encoder == -1)\r\nreturn;\r\nif (ENCODER_MODE_IS_DP(amdgpu_atombios_encoder_get_encoder_mode(encoder)))\r\nis_dp = true;\r\nmemset(&args, 0, sizeof(args));\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1:\r\nindex = GetIndexIntoMasterTable(COMMAND, DVOOutputControl);\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\r\nindex = GetIndexIntoMasterTable(COMMAND, UNIPHYTransmitterControl);\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA:\r\nindex = GetIndexIntoMasterTable(COMMAND, LVTMATransmitterControl);\r\nbreak;\r\n}\r\nif (!amdgpu_atom_parse_cmd_header(adev->mode_info.atom_context, index, &frev, &crev))\r\nreturn;\r\nswitch (frev) {\r\ncase 1:\r\nswitch (crev) {\r\ncase 1:\r\nargs.v1.ucAction = action;\r\nif (action == ATOM_TRANSMITTER_ACTION_INIT) {\r\nargs.v1.usInitInfo = cpu_to_le16(connector_object_id);\r\n} else if (action == ATOM_TRANSMITTER_ACTION_SETUP_VSEMPH) {\r\nargs.v1.asMode.ucLaneSel = lane_num;\r\nargs.v1.asMode.ucLaneSet = lane_set;\r\n} else {\r\nif (is_dp)\r\nargs.v1.usPixelClock = cpu_to_le16(dp_clock / 10);\r\nelse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v1.usPixelClock = cpu_to_le16((amdgpu_encoder->pixel_clock / 2) / 10);\r\nelse\r\nargs.v1.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\r\n}\r\nargs.v1.ucConfig = ATOM_TRANSMITTER_CONFIG_CLKSRC_PPLL;\r\nif (dig_encoder)\r\nargs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_DIG2_ENCODER;\r\nelse\r\nargs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_DIG1_ENCODER;\r\nif ((adev->flags & AMD_IS_APU) &&\r\n(amdgpu_encoder->encoder_id == ENCODER_OBJECT_ID_INTERNAL_UNIPHY)) {\r\nif (is_dp ||\r\n!amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock)) {\r\nif (igp_lane_info & 0x1)\r\nargs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_0_3;\r\nelse if (igp_lane_info & 0x2)\r\nargs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_4_7;\r\nelse if (igp_lane_info & 0x4)\r\nargs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_8_11;\r\nelse if (igp_lane_info & 0x8)\r\nargs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_12_15;\r\n} else {\r\nif (igp_lane_info & 0x3)\r\nargs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_0_7;\r\nelse if (igp_lane_info & 0xc)\r\nargs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LANE_8_15;\r\n}\r\n}\r\nif (dig->linkb)\r\nargs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LINKB;\r\nelse\r\nargs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_LINKA;\r\nif (is_dp)\r\nargs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_COHERENT;\r\nelse if (amdgpu_encoder->devices & (ATOM_DEVICE_DFP_SUPPORT)) {\r\nif (dig->coherent_mode)\r\nargs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_COHERENT;\r\nif (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v1.ucConfig |= ATOM_TRANSMITTER_CONFIG_8LANE_LINK;\r\n}\r\nbreak;\r\ncase 2:\r\nargs.v2.ucAction = action;\r\nif (action == ATOM_TRANSMITTER_ACTION_INIT) {\r\nargs.v2.usInitInfo = cpu_to_le16(connector_object_id);\r\n} else if (action == ATOM_TRANSMITTER_ACTION_SETUP_VSEMPH) {\r\nargs.v2.asMode.ucLaneSel = lane_num;\r\nargs.v2.asMode.ucLaneSet = lane_set;\r\n} else {\r\nif (is_dp)\r\nargs.v2.usPixelClock = cpu_to_le16(dp_clock / 10);\r\nelse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v2.usPixelClock = cpu_to_le16((amdgpu_encoder->pixel_clock / 2) / 10);\r\nelse\r\nargs.v2.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\r\n}\r\nargs.v2.acConfig.ucEncoderSel = dig_encoder;\r\nif (dig->linkb)\r\nargs.v2.acConfig.ucLinkSel = 1;\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\r\nargs.v2.acConfig.ucTransmitterSel = 0;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\r\nargs.v2.acConfig.ucTransmitterSel = 1;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\r\nargs.v2.acConfig.ucTransmitterSel = 2;\r\nbreak;\r\n}\r\nif (is_dp) {\r\nargs.v2.acConfig.fCoherentMode = 1;\r\nargs.v2.acConfig.fDPConnector = 1;\r\n} else if (amdgpu_encoder->devices & (ATOM_DEVICE_DFP_SUPPORT)) {\r\nif (dig->coherent_mode)\r\nargs.v2.acConfig.fCoherentMode = 1;\r\nif (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v2.acConfig.fDualLinkConnector = 1;\r\n}\r\nbreak;\r\ncase 3:\r\nargs.v3.ucAction = action;\r\nif (action == ATOM_TRANSMITTER_ACTION_INIT) {\r\nargs.v3.usInitInfo = cpu_to_le16(connector_object_id);\r\n} else if (action == ATOM_TRANSMITTER_ACTION_SETUP_VSEMPH) {\r\nargs.v3.asMode.ucLaneSel = lane_num;\r\nargs.v3.asMode.ucLaneSet = lane_set;\r\n} else {\r\nif (is_dp)\r\nargs.v3.usPixelClock = cpu_to_le16(dp_clock / 10);\r\nelse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v3.usPixelClock = cpu_to_le16((amdgpu_encoder->pixel_clock / 2) / 10);\r\nelse\r\nargs.v3.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\r\n}\r\nif (is_dp)\r\nargs.v3.ucLaneNum = dp_lane_count;\r\nelse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v3.ucLaneNum = 8;\r\nelse\r\nargs.v3.ucLaneNum = 4;\r\nif (dig->linkb)\r\nargs.v3.acConfig.ucLinkSel = 1;\r\nif (dig_encoder & 1)\r\nargs.v3.acConfig.ucEncoderSel = 1;\r\nif (is_dp && adev->clock.dp_extclk)\r\nargs.v3.acConfig.ucRefClkSource = 2;\r\nelse\r\nargs.v3.acConfig.ucRefClkSource = pll_id;\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\r\nargs.v3.acConfig.ucTransmitterSel = 0;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\r\nargs.v3.acConfig.ucTransmitterSel = 1;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\r\nargs.v3.acConfig.ucTransmitterSel = 2;\r\nbreak;\r\n}\r\nif (is_dp)\r\nargs.v3.acConfig.fCoherentMode = 1;\r\nelse if (amdgpu_encoder->devices & (ATOM_DEVICE_DFP_SUPPORT)) {\r\nif (dig->coherent_mode)\r\nargs.v3.acConfig.fCoherentMode = 1;\r\nif (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v3.acConfig.fDualLinkConnector = 1;\r\n}\r\nbreak;\r\ncase 4:\r\nargs.v4.ucAction = action;\r\nif (action == ATOM_TRANSMITTER_ACTION_INIT) {\r\nargs.v4.usInitInfo = cpu_to_le16(connector_object_id);\r\n} else if (action == ATOM_TRANSMITTER_ACTION_SETUP_VSEMPH) {\r\nargs.v4.asMode.ucLaneSel = lane_num;\r\nargs.v4.asMode.ucLaneSet = lane_set;\r\n} else {\r\nif (is_dp)\r\nargs.v4.usPixelClock = cpu_to_le16(dp_clock / 10);\r\nelse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v4.usPixelClock = cpu_to_le16((amdgpu_encoder->pixel_clock / 2) / 10);\r\nelse\r\nargs.v4.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\r\n}\r\nif (is_dp)\r\nargs.v4.ucLaneNum = dp_lane_count;\r\nelse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v4.ucLaneNum = 8;\r\nelse\r\nargs.v4.ucLaneNum = 4;\r\nif (dig->linkb)\r\nargs.v4.acConfig.ucLinkSel = 1;\r\nif (dig_encoder & 1)\r\nargs.v4.acConfig.ucEncoderSel = 1;\r\nif (is_dp) {\r\nif (adev->clock.dp_extclk)\r\nargs.v4.acConfig.ucRefClkSource = ENCODER_REFCLK_SRC_EXTCLK;\r\nelse\r\nargs.v4.acConfig.ucRefClkSource = ENCODER_REFCLK_SRC_DCPLL;\r\n} else\r\nargs.v4.acConfig.ucRefClkSource = pll_id;\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\r\nargs.v4.acConfig.ucTransmitterSel = 0;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\r\nargs.v4.acConfig.ucTransmitterSel = 1;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\r\nargs.v4.acConfig.ucTransmitterSel = 2;\r\nbreak;\r\n}\r\nif (is_dp)\r\nargs.v4.acConfig.fCoherentMode = 1;\r\nelse if (amdgpu_encoder->devices & (ATOM_DEVICE_DFP_SUPPORT)) {\r\nif (dig->coherent_mode)\r\nargs.v4.acConfig.fCoherentMode = 1;\r\nif (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v4.acConfig.fDualLinkConnector = 1;\r\n}\r\nbreak;\r\ncase 5:\r\nargs.v5.ucAction = action;\r\nif (is_dp)\r\nargs.v5.usSymClock = cpu_to_le16(dp_clock / 10);\r\nelse\r\nargs.v5.usSymClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\r\nif (dig->linkb)\r\nargs.v5.ucPhyId = ATOM_PHY_ID_UNIPHYB;\r\nelse\r\nargs.v5.ucPhyId = ATOM_PHY_ID_UNIPHYA;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\r\nif (dig->linkb)\r\nargs.v5.ucPhyId = ATOM_PHY_ID_UNIPHYD;\r\nelse\r\nargs.v5.ucPhyId = ATOM_PHY_ID_UNIPHYC;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\r\nif (dig->linkb)\r\nargs.v5.ucPhyId = ATOM_PHY_ID_UNIPHYF;\r\nelse\r\nargs.v5.ucPhyId = ATOM_PHY_ID_UNIPHYE;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\r\nargs.v5.ucPhyId = ATOM_PHY_ID_UNIPHYG;\r\nbreak;\r\n}\r\nif (is_dp)\r\nargs.v5.ucLaneNum = dp_lane_count;\r\nelse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v5.ucLaneNum = 8;\r\nelse\r\nargs.v5.ucLaneNum = 4;\r\nargs.v5.ucConnObjId = connector_object_id;\r\nargs.v5.ucDigMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\r\nif (is_dp && adev->clock.dp_extclk)\r\nargs.v5.asConfig.ucPhyClkSrcId = ENCODER_REFCLK_SRC_EXTCLK;\r\nelse\r\nargs.v5.asConfig.ucPhyClkSrcId = pll_id;\r\nif (is_dp)\r\nargs.v5.asConfig.ucCoherentMode = 1;\r\nelse if (amdgpu_encoder->devices & (ATOM_DEVICE_DFP_SUPPORT)) {\r\nif (dig->coherent_mode)\r\nargs.v5.asConfig.ucCoherentMode = 1;\r\n}\r\nif (hpd_id == AMDGPU_HPD_NONE)\r\nargs.v5.asConfig.ucHPDSel = 0;\r\nelse\r\nargs.v5.asConfig.ucHPDSel = hpd_id + 1;\r\nargs.v5.ucDigEncoderSel = 1 << dig_encoder;\r\nargs.v5.ucDPLaneSet = lane_set;\r\nbreak;\r\ncase 6:\r\nargs.v6.ucAction = action;\r\nif (is_dp)\r\nargs.v6.ulSymClock = cpu_to_le32(dp_clock / 10);\r\nelse\r\nargs.v6.ulSymClock = cpu_to_le32(amdgpu_encoder->pixel_clock / 10);\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\r\nif (dig->linkb)\r\nargs.v6.ucPhyId = ATOM_PHY_ID_UNIPHYB;\r\nelse\r\nargs.v6.ucPhyId = ATOM_PHY_ID_UNIPHYA;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\r\nif (dig->linkb)\r\nargs.v6.ucPhyId = ATOM_PHY_ID_UNIPHYD;\r\nelse\r\nargs.v6.ucPhyId = ATOM_PHY_ID_UNIPHYC;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\r\nif (dig->linkb)\r\nargs.v6.ucPhyId = ATOM_PHY_ID_UNIPHYF;\r\nelse\r\nargs.v6.ucPhyId = ATOM_PHY_ID_UNIPHYE;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\r\nargs.v6.ucPhyId = ATOM_PHY_ID_UNIPHYG;\r\nbreak;\r\n}\r\nif (is_dp)\r\nargs.v6.ucLaneNum = dp_lane_count;\r\nelse if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v6.ucLaneNum = 8;\r\nelse\r\nargs.v6.ucLaneNum = 4;\r\nargs.v6.ucConnObjId = connector_object_id;\r\nif (action == ATOM_TRANSMITTER_ACTION_SETUP_VSEMPH)\r\nargs.v6.ucDPLaneSet = lane_set;\r\nelse\r\nargs.v6.ucDigMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\r\nif (hpd_id == AMDGPU_HPD_NONE)\r\nargs.v6.ucHPDSel = 0;\r\nelse\r\nargs.v6.ucHPDSel = hpd_id + 1;\r\nargs.v6.ucDigEncoderSel = 1 << dig_encoder;\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Unknown table version %d, %d\n", frev, crev);\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Unknown table version %d, %d\n", frev, crev);\r\nbreak;\r\n}\r\namdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\r\n}\r\nbool\r\namdgpu_atombios_encoder_set_edp_panel_power(struct drm_connector *connector,\r\nint action)\r\n{\r\nstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\r\nstruct drm_device *dev = amdgpu_connector->base.dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nunion dig_transmitter_control args;\r\nint index = GetIndexIntoMasterTable(COMMAND, UNIPHYTransmitterControl);\r\nuint8_t frev, crev;\r\nif (connector->connector_type != DRM_MODE_CONNECTOR_eDP)\r\ngoto done;\r\nif ((action != ATOM_TRANSMITTER_ACTION_POWER_ON) &&\r\n(action != ATOM_TRANSMITTER_ACTION_POWER_OFF))\r\ngoto done;\r\nif (!amdgpu_atom_parse_cmd_header(adev->mode_info.atom_context, index, &frev, &crev))\r\ngoto done;\r\nmemset(&args, 0, sizeof(args));\r\nargs.v1.ucAction = action;\r\namdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\r\nif (action == ATOM_TRANSMITTER_ACTION_POWER_ON) {\r\nint i;\r\nfor (i = 0; i < 300; i++) {\r\nif (amdgpu_display_hpd_sense(adev, amdgpu_connector->hpd.hpd))\r\nreturn true;\r\nmdelay(1);\r\n}\r\nreturn false;\r\n}\r\ndone:\r\nreturn true;\r\n}\r\nstatic void\r\namdgpu_atombios_encoder_setup_external_encoder(struct drm_encoder *encoder,\r\nstruct drm_encoder *ext_encoder,\r\nint action)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nstruct amdgpu_encoder *ext_amdgpu_encoder = to_amdgpu_encoder(ext_encoder);\r\nunion external_encoder_control args;\r\nstruct drm_connector *connector;\r\nint index = GetIndexIntoMasterTable(COMMAND, ExternalEncoderControl);\r\nu8 frev, crev;\r\nint dp_clock = 0;\r\nint dp_lane_count = 0;\r\nint connector_object_id = 0;\r\nu32 ext_enum = (ext_amdgpu_encoder->encoder_enum & ENUM_ID_MASK) >> ENUM_ID_SHIFT;\r\nif (action == EXTERNAL_ENCODER_ACTION_V3_ENCODER_INIT)\r\nconnector = amdgpu_get_connector_for_encoder_init(encoder);\r\nelse\r\nconnector = amdgpu_get_connector_for_encoder(encoder);\r\nif (connector) {\r\nstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\r\nstruct amdgpu_connector_atom_dig *dig_connector =\r\namdgpu_connector->con_priv;\r\ndp_clock = dig_connector->dp_clock;\r\ndp_lane_count = dig_connector->dp_lane_count;\r\nconnector_object_id =\r\n(amdgpu_connector->connector_object_id & OBJECT_ID_MASK) >> OBJECT_ID_SHIFT;\r\n}\r\nmemset(&args, 0, sizeof(args));\r\nif (!amdgpu_atom_parse_cmd_header(adev->mode_info.atom_context, index, &frev, &crev))\r\nreturn;\r\nswitch (frev) {\r\ncase 1:\r\nbreak;\r\ncase 2:\r\nswitch (crev) {\r\ncase 1:\r\ncase 2:\r\nargs.v1.sDigEncoder.ucAction = action;\r\nargs.v1.sDigEncoder.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\r\nargs.v1.sDigEncoder.ucEncoderMode =\r\namdgpu_atombios_encoder_get_encoder_mode(encoder);\r\nif (ENCODER_MODE_IS_DP(args.v1.sDigEncoder.ucEncoderMode)) {\r\nif (dp_clock == 270000)\r\nargs.v1.sDigEncoder.ucConfig |= ATOM_ENCODER_CONFIG_DPLINKRATE_2_70GHZ;\r\nargs.v1.sDigEncoder.ucLaneNum = dp_lane_count;\r\n} else if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v1.sDigEncoder.ucLaneNum = 8;\r\nelse\r\nargs.v1.sDigEncoder.ucLaneNum = 4;\r\nbreak;\r\ncase 3:\r\nargs.v3.sExtEncoder.ucAction = action;\r\nif (action == EXTERNAL_ENCODER_ACTION_V3_ENCODER_INIT)\r\nargs.v3.sExtEncoder.usConnectorId = cpu_to_le16(connector_object_id);\r\nelse\r\nargs.v3.sExtEncoder.usPixelClock = cpu_to_le16(amdgpu_encoder->pixel_clock / 10);\r\nargs.v3.sExtEncoder.ucEncoderMode =\r\namdgpu_atombios_encoder_get_encoder_mode(encoder);\r\nif (ENCODER_MODE_IS_DP(args.v3.sExtEncoder.ucEncoderMode)) {\r\nif (dp_clock == 270000)\r\nargs.v3.sExtEncoder.ucConfig |= EXTERNAL_ENCODER_CONFIG_V3_DPLINKRATE_2_70GHZ;\r\nelse if (dp_clock == 540000)\r\nargs.v3.sExtEncoder.ucConfig |= EXTERNAL_ENCODER_CONFIG_V3_DPLINKRATE_5_40GHZ;\r\nargs.v3.sExtEncoder.ucLaneNum = dp_lane_count;\r\n} else if (amdgpu_dig_monitor_is_duallink(encoder, amdgpu_encoder->pixel_clock))\r\nargs.v3.sExtEncoder.ucLaneNum = 8;\r\nelse\r\nargs.v3.sExtEncoder.ucLaneNum = 4;\r\nswitch (ext_enum) {\r\ncase GRAPH_OBJECT_ENUM_ID1:\r\nargs.v3.sExtEncoder.ucConfig |= EXTERNAL_ENCODER_CONFIG_V3_ENCODER1;\r\nbreak;\r\ncase GRAPH_OBJECT_ENUM_ID2:\r\nargs.v3.sExtEncoder.ucConfig |= EXTERNAL_ENCODER_CONFIG_V3_ENCODER2;\r\nbreak;\r\ncase GRAPH_OBJECT_ENUM_ID3:\r\nargs.v3.sExtEncoder.ucConfig |= EXTERNAL_ENCODER_CONFIG_V3_ENCODER3;\r\nbreak;\r\n}\r\nargs.v3.sExtEncoder.ucBitPerColor = amdgpu_atombios_encoder_get_bpc(encoder);\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Unknown table version: %d, %d\n", frev, crev);\r\nreturn;\r\n}\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Unknown table version: %d, %d\n", frev, crev);\r\nreturn;\r\n}\r\namdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\r\n}\r\nstatic void\r\namdgpu_atombios_encoder_setup_dig(struct drm_encoder *encoder, int action)\r\n{\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nstruct drm_encoder *ext_encoder = amdgpu_get_external_encoder(encoder);\r\nstruct amdgpu_encoder_atom_dig *dig = amdgpu_encoder->enc_priv;\r\nstruct drm_connector *connector = amdgpu_get_connector_for_encoder(encoder);\r\nstruct amdgpu_connector *amdgpu_connector = NULL;\r\nstruct amdgpu_connector_atom_dig *amdgpu_dig_connector = NULL;\r\nif (connector) {\r\namdgpu_connector = to_amdgpu_connector(connector);\r\namdgpu_dig_connector = amdgpu_connector->con_priv;\r\n}\r\nif (action == ATOM_ENABLE) {\r\nif (!connector)\r\ndig->panel_mode = DP_PANEL_MODE_EXTERNAL_DP_MODE;\r\nelse\r\ndig->panel_mode = amdgpu_atombios_dp_get_panel_mode(encoder, connector);\r\namdgpu_atombios_encoder_setup_dig_encoder(encoder, ATOM_ENCODER_CMD_SETUP, 0);\r\namdgpu_atombios_encoder_setup_dig_encoder(encoder,\r\nATOM_ENCODER_CMD_SETUP_PANEL_MODE,\r\ndig->panel_mode);\r\nif (ext_encoder)\r\namdgpu_atombios_encoder_setup_external_encoder(encoder, ext_encoder,\r\nEXTERNAL_ENCODER_ACTION_V3_ENCODER_SETUP);\r\nif (ENCODER_MODE_IS_DP(amdgpu_atombios_encoder_get_encoder_mode(encoder)) &&\r\nconnector) {\r\nif (connector->connector_type == DRM_MODE_CONNECTOR_eDP) {\r\namdgpu_atombios_encoder_set_edp_panel_power(connector,\r\nATOM_TRANSMITTER_ACTION_POWER_ON);\r\namdgpu_dig_connector->edp_on = true;\r\n}\r\n}\r\namdgpu_atombios_encoder_setup_dig_transmitter(encoder,\r\nATOM_TRANSMITTER_ACTION_ENABLE,\r\n0, 0);\r\nif (ENCODER_MODE_IS_DP(amdgpu_atombios_encoder_get_encoder_mode(encoder)) &&\r\nconnector) {\r\namdgpu_atombios_dp_link_train(encoder, connector);\r\namdgpu_atombios_encoder_setup_dig_encoder(encoder, ATOM_ENCODER_CMD_DP_VIDEO_ON, 0);\r\n}\r\nif (amdgpu_encoder->devices & (ATOM_DEVICE_LCD_SUPPORT))\r\namdgpu_atombios_encoder_set_backlight_level(amdgpu_encoder, dig->backlight_level);\r\nif (ext_encoder)\r\namdgpu_atombios_encoder_setup_external_encoder(encoder, ext_encoder, ATOM_ENABLE);\r\n} else {\r\nif (ENCODER_MODE_IS_DP(amdgpu_atombios_encoder_get_encoder_mode(encoder)) &&\r\nconnector)\r\namdgpu_atombios_encoder_setup_dig_encoder(encoder,\r\nATOM_ENCODER_CMD_DP_VIDEO_OFF, 0);\r\nif (ext_encoder)\r\namdgpu_atombios_encoder_setup_external_encoder(encoder, ext_encoder, ATOM_DISABLE);\r\nif (amdgpu_encoder->devices & (ATOM_DEVICE_LCD_SUPPORT))\r\namdgpu_atombios_encoder_setup_dig_transmitter(encoder,\r\nATOM_TRANSMITTER_ACTION_LCD_BLOFF, 0, 0);\r\nif (ENCODER_MODE_IS_DP(amdgpu_atombios_encoder_get_encoder_mode(encoder)) &&\r\nconnector)\r\namdgpu_atombios_dp_set_rx_power_state(connector, DP_SET_POWER_D3);\r\namdgpu_atombios_encoder_setup_dig_transmitter(encoder,\r\nATOM_TRANSMITTER_ACTION_DISABLE, 0, 0);\r\nif (ENCODER_MODE_IS_DP(amdgpu_atombios_encoder_get_encoder_mode(encoder)) &&\r\nconnector) {\r\nif (connector->connector_type == DRM_MODE_CONNECTOR_eDP) {\r\namdgpu_atombios_encoder_set_edp_panel_power(connector,\r\nATOM_TRANSMITTER_ACTION_POWER_OFF);\r\namdgpu_dig_connector->edp_on = false;\r\n}\r\n}\r\n}\r\n}\r\nvoid\r\namdgpu_atombios_encoder_dpms(struct drm_encoder *encoder, int mode)\r\n{\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nDRM_DEBUG_KMS("encoder dpms %d to mode %d, devices %08x, active_devices %08x\n",\r\namdgpu_encoder->encoder_id, mode, amdgpu_encoder->devices,\r\namdgpu_encoder->active_device);\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\r\nswitch (mode) {\r\ncase DRM_MODE_DPMS_ON:\r\namdgpu_atombios_encoder_setup_dig(encoder, ATOM_ENABLE);\r\nbreak;\r\ncase DRM_MODE_DPMS_STANDBY:\r\ncase DRM_MODE_DPMS_SUSPEND:\r\ncase DRM_MODE_DPMS_OFF:\r\namdgpu_atombios_encoder_setup_dig(encoder, ATOM_DISABLE);\r\nbreak;\r\n}\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1:\r\nswitch (mode) {\r\ncase DRM_MODE_DPMS_ON:\r\namdgpu_atombios_encoder_setup_dvo(encoder, ATOM_ENABLE);\r\nbreak;\r\ncase DRM_MODE_DPMS_STANDBY:\r\ncase DRM_MODE_DPMS_SUSPEND:\r\ncase DRM_MODE_DPMS_OFF:\r\namdgpu_atombios_encoder_setup_dvo(encoder, ATOM_DISABLE);\r\nbreak;\r\n}\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1:\r\nswitch (mode) {\r\ncase DRM_MODE_DPMS_ON:\r\namdgpu_atombios_encoder_setup_dac(encoder, ATOM_ENABLE);\r\nbreak;\r\ncase DRM_MODE_DPMS_STANDBY:\r\ncase DRM_MODE_DPMS_SUSPEND:\r\ncase DRM_MODE_DPMS_OFF:\r\namdgpu_atombios_encoder_setup_dac(encoder, ATOM_DISABLE);\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\n}\r\nvoid\r\namdgpu_atombios_encoder_set_crtc_source(struct drm_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nstruct amdgpu_crtc *amdgpu_crtc = to_amdgpu_crtc(encoder->crtc);\r\nunion crtc_source_param args;\r\nint index = GetIndexIntoMasterTable(COMMAND, SelectCRTC_Source);\r\nuint8_t frev, crev;\r\nstruct amdgpu_encoder_atom_dig *dig;\r\nmemset(&args, 0, sizeof(args));\r\nif (!amdgpu_atom_parse_cmd_header(adev->mode_info.atom_context, index, &frev, &crev))\r\nreturn;\r\nswitch (frev) {\r\ncase 1:\r\nswitch (crev) {\r\ncase 1:\r\ndefault:\r\nargs.v1.ucCRTC = amdgpu_crtc->crtc_id;\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_TMDS1:\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_TMDS1:\r\nargs.v1.ucDevice = ATOM_DEVICE_DFP1_INDEX;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_LVDS:\r\ncase ENCODER_OBJECT_ID_INTERNAL_LVTM1:\r\nif (amdgpu_encoder->devices & ATOM_DEVICE_LCD1_SUPPORT)\r\nargs.v1.ucDevice = ATOM_DEVICE_LCD1_INDEX;\r\nelse\r\nargs.v1.ucDevice = ATOM_DEVICE_DFP3_INDEX;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_DVO1:\r\ncase ENCODER_OBJECT_ID_INTERNAL_DDI:\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1:\r\nargs.v1.ucDevice = ATOM_DEVICE_DFP2_INDEX;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_DAC1:\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1:\r\nif (amdgpu_encoder->active_device & (ATOM_DEVICE_TV_SUPPORT))\r\nargs.v1.ucDevice = ATOM_DEVICE_TV1_INDEX;\r\nelse if (amdgpu_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT))\r\nargs.v1.ucDevice = ATOM_DEVICE_CV_INDEX;\r\nelse\r\nargs.v1.ucDevice = ATOM_DEVICE_CRT1_INDEX;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_DAC2:\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2:\r\nif (amdgpu_encoder->active_device & (ATOM_DEVICE_TV_SUPPORT))\r\nargs.v1.ucDevice = ATOM_DEVICE_TV1_INDEX;\r\nelse if (amdgpu_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT))\r\nargs.v1.ucDevice = ATOM_DEVICE_CV_INDEX;\r\nelse\r\nargs.v1.ucDevice = ATOM_DEVICE_CRT2_INDEX;\r\nbreak;\r\n}\r\nbreak;\r\ncase 2:\r\nargs.v2.ucCRTC = amdgpu_crtc->crtc_id;\r\nif (amdgpu_encoder_get_dp_bridge_encoder_id(encoder) != ENCODER_OBJECT_ID_NONE) {\r\nstruct drm_connector *connector = amdgpu_get_connector_for_encoder(encoder);\r\nif (connector->connector_type == DRM_MODE_CONNECTOR_LVDS)\r\nargs.v2.ucEncodeMode = ATOM_ENCODER_MODE_LVDS;\r\nelse if (connector->connector_type == DRM_MODE_CONNECTOR_VGA)\r\nargs.v2.ucEncodeMode = ATOM_ENCODER_MODE_CRT;\r\nelse\r\nargs.v2.ucEncodeMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\r\n} else if (amdgpu_encoder->devices & (ATOM_DEVICE_LCD_SUPPORT)) {\r\nargs.v2.ucEncodeMode = ATOM_ENCODER_MODE_LVDS;\r\n} else {\r\nargs.v2.ucEncodeMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\r\n}\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA:\r\ndig = amdgpu_encoder->enc_priv;\r\nswitch (dig->dig_encoder) {\r\ncase 0:\r\nargs.v2.ucEncoderID = ASIC_INT_DIG1_ENCODER_ID;\r\nbreak;\r\ncase 1:\r\nargs.v2.ucEncoderID = ASIC_INT_DIG2_ENCODER_ID;\r\nbreak;\r\ncase 2:\r\nargs.v2.ucEncoderID = ASIC_INT_DIG3_ENCODER_ID;\r\nbreak;\r\ncase 3:\r\nargs.v2.ucEncoderID = ASIC_INT_DIG4_ENCODER_ID;\r\nbreak;\r\ncase 4:\r\nargs.v2.ucEncoderID = ASIC_INT_DIG5_ENCODER_ID;\r\nbreak;\r\ncase 5:\r\nargs.v2.ucEncoderID = ASIC_INT_DIG6_ENCODER_ID;\r\nbreak;\r\ncase 6:\r\nargs.v2.ucEncoderID = ASIC_INT_DIG7_ENCODER_ID;\r\nbreak;\r\n}\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1:\r\nargs.v2.ucEncoderID = ASIC_INT_DVO_ENCODER_ID;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1:\r\nif (amdgpu_encoder->active_device & (ATOM_DEVICE_TV_SUPPORT))\r\nargs.v2.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\r\nelse if (amdgpu_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT))\r\nargs.v2.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\r\nelse\r\nargs.v2.ucEncoderID = ASIC_INT_DAC1_ENCODER_ID;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2:\r\nif (amdgpu_encoder->active_device & (ATOM_DEVICE_TV_SUPPORT))\r\nargs.v2.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\r\nelse if (amdgpu_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT))\r\nargs.v2.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\r\nelse\r\nargs.v2.ucEncoderID = ASIC_INT_DAC2_ENCODER_ID;\r\nbreak;\r\n}\r\nbreak;\r\ncase 3:\r\nargs.v3.ucCRTC = amdgpu_crtc->crtc_id;\r\nif (amdgpu_encoder_get_dp_bridge_encoder_id(encoder) != ENCODER_OBJECT_ID_NONE) {\r\nstruct drm_connector *connector = amdgpu_get_connector_for_encoder(encoder);\r\nif (connector->connector_type == DRM_MODE_CONNECTOR_LVDS)\r\nargs.v2.ucEncodeMode = ATOM_ENCODER_MODE_LVDS;\r\nelse if (connector->connector_type == DRM_MODE_CONNECTOR_VGA)\r\nargs.v2.ucEncodeMode = ATOM_ENCODER_MODE_CRT;\r\nelse\r\nargs.v2.ucEncodeMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\r\n} else if (amdgpu_encoder->devices & (ATOM_DEVICE_LCD_SUPPORT)) {\r\nargs.v2.ucEncodeMode = ATOM_ENCODER_MODE_LVDS;\r\n} else {\r\nargs.v2.ucEncodeMode = amdgpu_atombios_encoder_get_encoder_mode(encoder);\r\n}\r\nargs.v3.ucDstBpc = amdgpu_atombios_encoder_get_bpc(encoder);\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_LVTMA:\r\ndig = amdgpu_encoder->enc_priv;\r\nswitch (dig->dig_encoder) {\r\ncase 0:\r\nargs.v3.ucEncoderID = ASIC_INT_DIG1_ENCODER_ID;\r\nbreak;\r\ncase 1:\r\nargs.v3.ucEncoderID = ASIC_INT_DIG2_ENCODER_ID;\r\nbreak;\r\ncase 2:\r\nargs.v3.ucEncoderID = ASIC_INT_DIG3_ENCODER_ID;\r\nbreak;\r\ncase 3:\r\nargs.v3.ucEncoderID = ASIC_INT_DIG4_ENCODER_ID;\r\nbreak;\r\ncase 4:\r\nargs.v3.ucEncoderID = ASIC_INT_DIG5_ENCODER_ID;\r\nbreak;\r\ncase 5:\r\nargs.v3.ucEncoderID = ASIC_INT_DIG6_ENCODER_ID;\r\nbreak;\r\ncase 6:\r\nargs.v3.ucEncoderID = ASIC_INT_DIG7_ENCODER_ID;\r\nbreak;\r\n}\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DVO1:\r\nargs.v3.ucEncoderID = ASIC_INT_DVO_ENCODER_ID;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1:\r\nif (amdgpu_encoder->active_device & (ATOM_DEVICE_TV_SUPPORT))\r\nargs.v3.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\r\nelse if (amdgpu_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT))\r\nargs.v3.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\r\nelse\r\nargs.v3.ucEncoderID = ASIC_INT_DAC1_ENCODER_ID;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC2:\r\nif (amdgpu_encoder->active_device & (ATOM_DEVICE_TV_SUPPORT))\r\nargs.v3.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\r\nelse if (amdgpu_encoder->active_device & (ATOM_DEVICE_CV_SUPPORT))\r\nargs.v3.ucEncoderID = ASIC_INT_TV_ENCODER_ID;\r\nelse\r\nargs.v3.ucEncoderID = ASIC_INT_DAC2_ENCODER_ID;\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Unknown table version: %d, %d\n", frev, crev);\r\nreturn;\r\n}\r\namdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\r\n}\r\nvoid\r\namdgpu_atombios_encoder_init_dig(struct amdgpu_device *adev)\r\n{\r\nstruct drm_device *dev = adev->ddev;\r\nstruct drm_encoder *encoder;\r\nlist_for_each_entry(encoder, &dev->mode_config.encoder_list, head) {\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nstruct drm_encoder *ext_encoder = amdgpu_get_external_encoder(encoder);\r\nswitch (amdgpu_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY1:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY2:\r\ncase ENCODER_OBJECT_ID_INTERNAL_UNIPHY3:\r\namdgpu_atombios_encoder_setup_dig_transmitter(encoder, ATOM_TRANSMITTER_ACTION_INIT,\r\n0, 0);\r\nbreak;\r\n}\r\nif (ext_encoder)\r\namdgpu_atombios_encoder_setup_external_encoder(encoder, ext_encoder,\r\nEXTERNAL_ENCODER_ACTION_V3_ENCODER_INIT);\r\n}\r\n}\r\nstatic bool\r\namdgpu_atombios_encoder_dac_load_detect(struct drm_encoder *encoder,\r\nstruct drm_connector *connector)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\r\nif (amdgpu_encoder->devices & (ATOM_DEVICE_TV_SUPPORT |\r\nATOM_DEVICE_CV_SUPPORT |\r\nATOM_DEVICE_CRT_SUPPORT)) {\r\nDAC_LOAD_DETECTION_PS_ALLOCATION args;\r\nint index = GetIndexIntoMasterTable(COMMAND, DAC_LoadDetection);\r\nuint8_t frev, crev;\r\nmemset(&args, 0, sizeof(args));\r\nif (!amdgpu_atom_parse_cmd_header(adev->mode_info.atom_context, index, &frev, &crev))\r\nreturn false;\r\nargs.sDacload.ucMisc = 0;\r\nif ((amdgpu_encoder->encoder_id == ENCODER_OBJECT_ID_INTERNAL_DAC1) ||\r\n(amdgpu_encoder->encoder_id == ENCODER_OBJECT_ID_INTERNAL_KLDSCP_DAC1))\r\nargs.sDacload.ucDacType = ATOM_DAC_A;\r\nelse\r\nargs.sDacload.ucDacType = ATOM_DAC_B;\r\nif (amdgpu_connector->devices & ATOM_DEVICE_CRT1_SUPPORT)\r\nargs.sDacload.usDeviceID = cpu_to_le16(ATOM_DEVICE_CRT1_SUPPORT);\r\nelse if (amdgpu_connector->devices & ATOM_DEVICE_CRT2_SUPPORT)\r\nargs.sDacload.usDeviceID = cpu_to_le16(ATOM_DEVICE_CRT2_SUPPORT);\r\nelse if (amdgpu_connector->devices & ATOM_DEVICE_CV_SUPPORT) {\r\nargs.sDacload.usDeviceID = cpu_to_le16(ATOM_DEVICE_CV_SUPPORT);\r\nif (crev >= 3)\r\nargs.sDacload.ucMisc = DAC_LOAD_MISC_YPrPb;\r\n} else if (amdgpu_connector->devices & ATOM_DEVICE_TV1_SUPPORT) {\r\nargs.sDacload.usDeviceID = cpu_to_le16(ATOM_DEVICE_TV1_SUPPORT);\r\nif (crev >= 3)\r\nargs.sDacload.ucMisc = DAC_LOAD_MISC_YPrPb;\r\n}\r\namdgpu_atom_execute_table(adev->mode_info.atom_context, index, (uint32_t *)&args);\r\nreturn true;\r\n} else\r\nreturn false;\r\n}\r\nenum drm_connector_status\r\namdgpu_atombios_encoder_dac_detect(struct drm_encoder *encoder,\r\nstruct drm_connector *connector)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\r\nuint32_t bios_0_scratch;\r\nif (!amdgpu_atombios_encoder_dac_load_detect(encoder, connector)) {\r\nDRM_DEBUG_KMS("detect returned false \n");\r\nreturn connector_status_unknown;\r\n}\r\nbios_0_scratch = RREG32(mmBIOS_SCRATCH_0);\r\nDRM_DEBUG_KMS("Bios 0 scratch %x %08x\n", bios_0_scratch, amdgpu_encoder->devices);\r\nif (amdgpu_connector->devices & ATOM_DEVICE_CRT1_SUPPORT) {\r\nif (bios_0_scratch & ATOM_S0_CRT1_MASK)\r\nreturn connector_status_connected;\r\n}\r\nif (amdgpu_connector->devices & ATOM_DEVICE_CRT2_SUPPORT) {\r\nif (bios_0_scratch & ATOM_S0_CRT2_MASK)\r\nreturn connector_status_connected;\r\n}\r\nif (amdgpu_connector->devices & ATOM_DEVICE_CV_SUPPORT) {\r\nif (bios_0_scratch & (ATOM_S0_CV_MASK|ATOM_S0_CV_MASK_A))\r\nreturn connector_status_connected;\r\n}\r\nif (amdgpu_connector->devices & ATOM_DEVICE_TV1_SUPPORT) {\r\nif (bios_0_scratch & (ATOM_S0_TV1_COMPOSITE | ATOM_S0_TV1_COMPOSITE_A))\r\nreturn connector_status_connected;\r\nelse if (bios_0_scratch & (ATOM_S0_TV1_SVIDEO | ATOM_S0_TV1_SVIDEO_A))\r\nreturn connector_status_connected;\r\n}\r\nreturn connector_status_disconnected;\r\n}\r\nenum drm_connector_status\r\namdgpu_atombios_encoder_dig_detect(struct drm_encoder *encoder,\r\nstruct drm_connector *connector)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nstruct amdgpu_connector *amdgpu_connector = to_amdgpu_connector(connector);\r\nstruct drm_encoder *ext_encoder = amdgpu_get_external_encoder(encoder);\r\nu32 bios_0_scratch;\r\nif (!ext_encoder)\r\nreturn connector_status_unknown;\r\nif ((amdgpu_connector->devices & ATOM_DEVICE_CRT_SUPPORT) == 0)\r\nreturn connector_status_unknown;\r\namdgpu_atombios_encoder_setup_external_encoder(encoder, ext_encoder,\r\nEXTERNAL_ENCODER_ACTION_V3_DACLOAD_DETECTION);\r\nbios_0_scratch = RREG32(mmBIOS_SCRATCH_0);\r\nDRM_DEBUG_KMS("Bios 0 scratch %x %08x\n", bios_0_scratch, amdgpu_encoder->devices);\r\nif (amdgpu_connector->devices & ATOM_DEVICE_CRT1_SUPPORT) {\r\nif (bios_0_scratch & ATOM_S0_CRT1_MASK)\r\nreturn connector_status_connected;\r\n}\r\nif (amdgpu_connector->devices & ATOM_DEVICE_CRT2_SUPPORT) {\r\nif (bios_0_scratch & ATOM_S0_CRT2_MASK)\r\nreturn connector_status_connected;\r\n}\r\nif (amdgpu_connector->devices & ATOM_DEVICE_CV_SUPPORT) {\r\nif (bios_0_scratch & (ATOM_S0_CV_MASK|ATOM_S0_CV_MASK_A))\r\nreturn connector_status_connected;\r\n}\r\nif (amdgpu_connector->devices & ATOM_DEVICE_TV1_SUPPORT) {\r\nif (bios_0_scratch & (ATOM_S0_TV1_COMPOSITE | ATOM_S0_TV1_COMPOSITE_A))\r\nreturn connector_status_connected;\r\nelse if (bios_0_scratch & (ATOM_S0_TV1_SVIDEO | ATOM_S0_TV1_SVIDEO_A))\r\nreturn connector_status_connected;\r\n}\r\nreturn connector_status_disconnected;\r\n}\r\nvoid\r\namdgpu_atombios_encoder_setup_ext_encoder_ddc(struct drm_encoder *encoder)\r\n{\r\nstruct drm_encoder *ext_encoder = amdgpu_get_external_encoder(encoder);\r\nif (ext_encoder)\r\namdgpu_atombios_encoder_setup_external_encoder(encoder, ext_encoder,\r\nEXTERNAL_ENCODER_ACTION_V3_DDC_SETUP);\r\n}\r\nvoid\r\namdgpu_atombios_encoder_set_bios_scratch_regs(struct drm_connector *connector,\r\nstruct drm_encoder *encoder,\r\nbool connected)\r\n{\r\nstruct drm_device *dev = connector->dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct amdgpu_connector *amdgpu_connector =\r\nto_amdgpu_connector(connector);\r\nstruct amdgpu_encoder *amdgpu_encoder = to_amdgpu_encoder(encoder);\r\nuint32_t bios_0_scratch, bios_3_scratch, bios_6_scratch;\r\nbios_0_scratch = RREG32(mmBIOS_SCRATCH_0);\r\nbios_3_scratch = RREG32(mmBIOS_SCRATCH_3);\r\nbios_6_scratch = RREG32(mmBIOS_SCRATCH_6);\r\nif ((amdgpu_encoder->devices & ATOM_DEVICE_LCD1_SUPPORT) &&\r\n(amdgpu_connector->devices & ATOM_DEVICE_LCD1_SUPPORT)) {\r\nif (connected) {\r\nDRM_DEBUG_KMS("LCD1 connected\n");\r\nbios_0_scratch |= ATOM_S0_LCD1;\r\nbios_3_scratch |= ATOM_S3_LCD1_ACTIVE;\r\nbios_6_scratch |= ATOM_S6_ACC_REQ_LCD1;\r\n} else {\r\nDRM_DEBUG_KMS("LCD1 disconnected\n");\r\nbios_0_scratch &= ~ATOM_S0_LCD1;\r\nbios_3_scratch &= ~ATOM_S3_LCD1_ACTIVE;\r\nbios_6_scratch &= ~ATOM_S6_ACC_REQ_LCD1;\r\n}\r\n}\r\nif ((amdgpu_encoder->devices & ATOM_DEVICE_CRT1_SUPPORT) &&\r\n(amdgpu_connector->devices & ATOM_DEVICE_CRT1_SUPPORT)) {\r\nif (connected) {\r\nDRM_DEBUG_KMS("CRT1 connected\n");\r\nbios_0_scratch |= ATOM_S0_CRT1_COLOR;\r\nbios_3_scratch |= ATOM_S3_CRT1_ACTIVE;\r\nbios_6_scratch |= ATOM_S6_ACC_REQ_CRT1;\r\n} else {\r\nDRM_DEBUG_KMS("CRT1 disconnected\n");\r\nbios_0_scratch &= ~ATOM_S0_CRT1_MASK;\r\nbios_3_scratch &= ~ATOM_S3_CRT1_ACTIVE;\r\nbios_6_scratch &= ~ATOM_S6_ACC_REQ_CRT1;\r\n}\r\n}\r\nif ((amdgpu_encoder->devices & ATOM_DEVICE_CRT2_SUPPORT) &&\r\n(amdgpu_connector->devices & ATOM_DEVICE_CRT2_SUPPORT)) {\r\nif (connected) {\r\nDRM_DEBUG_KMS("CRT2 connected\n");\r\nbios_0_scratch |= ATOM_S0_CRT2_COLOR;\r\nbios_3_scratch |= ATOM_S3_CRT2_ACTIVE;\r\nbios_6_scratch |= ATOM_S6_ACC_REQ_CRT2;\r\n} else {\r\nDRM_DEBUG_KMS("CRT2 disconnected\n");\r\nbios_0_scratch &= ~ATOM_S0_CRT2_MASK;\r\nbios_3_scratch &= ~ATOM_S3_CRT2_ACTIVE;\r\nbios_6_scratch &= ~ATOM_S6_ACC_REQ_CRT2;\r\n}\r\n}\r\nif ((amdgpu_encoder->devices & ATOM_DEVICE_DFP1_SUPPORT) &&\r\n(amdgpu_connector->devices & ATOM_DEVICE_DFP1_SUPPORT)) {\r\nif (connected) {\r\nDRM_DEBUG_KMS("DFP1 connected\n");\r\nbios_0_scratch |= ATOM_S0_DFP1;\r\nbios_3_scratch |= ATOM_S3_DFP1_ACTIVE;\r\nbios_6_scratch |= ATOM_S6_ACC_REQ_DFP1;\r\n} else {\r\nDRM_DEBUG_KMS("DFP1 disconnected\n");\r\nbios_0_scratch &= ~ATOM_S0_DFP1;\r\nbios_3_scratch &= ~ATOM_S3_DFP1_ACTIVE;\r\nbios_6_scratch &= ~ATOM_S6_ACC_REQ_DFP1;\r\n}\r\n}\r\nif ((amdgpu_encoder->devices & ATOM_DEVICE_DFP2_SUPPORT) &&\r\n(amdgpu_connector->devices & ATOM_DEVICE_DFP2_SUPPORT)) {\r\nif (connected) {\r\nDRM_DEBUG_KMS("DFP2 connected\n");\r\nbios_0_scratch |= ATOM_S0_DFP2;\r\nbios_3_scratch |= ATOM_S3_DFP2_ACTIVE;\r\nbios_6_scratch |= ATOM_S6_ACC_REQ_DFP2;\r\n} else {\r\nDRM_DEBUG_KMS("DFP2 disconnected\n");\r\nbios_0_scratch &= ~ATOM_S0_DFP2;\r\nbios_3_scratch &= ~ATOM_S3_DFP2_ACTIVE;\r\nbios_6_scratch &= ~ATOM_S6_ACC_REQ_DFP2;\r\n}\r\n}\r\nif ((amdgpu_encoder->devices & ATOM_DEVICE_DFP3_SUPPORT) &&\r\n(amdgpu_connector->devices & ATOM_DEVICE_DFP3_SUPPORT)) {\r\nif (connected) {\r\nDRM_DEBUG_KMS("DFP3 connected\n");\r\nbios_0_scratch |= ATOM_S0_DFP3;\r\nbios_3_scratch |= ATOM_S3_DFP3_ACTIVE;\r\nbios_6_scratch |= ATOM_S6_ACC_REQ_DFP3;\r\n} else {\r\nDRM_DEBUG_KMS("DFP3 disconnected\n");\r\nbios_0_scratch &= ~ATOM_S0_DFP3;\r\nbios_3_scratch &= ~ATOM_S3_DFP3_ACTIVE;\r\nbios_6_scratch &= ~ATOM_S6_ACC_REQ_DFP3;\r\n}\r\n}\r\nif ((amdgpu_encoder->devices & ATOM_DEVICE_DFP4_SUPPORT) &&\r\n(amdgpu_connector->devices & ATOM_DEVICE_DFP4_SUPPORT)) {\r\nif (connected) {\r\nDRM_DEBUG_KMS("DFP4 connected\n");\r\nbios_0_scratch |= ATOM_S0_DFP4;\r\nbios_3_scratch |= ATOM_S3_DFP4_ACTIVE;\r\nbios_6_scratch |= ATOM_S6_ACC_REQ_DFP4;\r\n} else {\r\nDRM_DEBUG_KMS("DFP4 disconnected\n");\r\nbios_0_scratch &= ~ATOM_S0_DFP4;\r\nbios_3_scratch &= ~ATOM_S3_DFP4_ACTIVE;\r\nbios_6_scratch &= ~ATOM_S6_ACC_REQ_DFP4;\r\n}\r\n}\r\nif ((amdgpu_encoder->devices & ATOM_DEVICE_DFP5_SUPPORT) &&\r\n(amdgpu_connector->devices & ATOM_DEVICE_DFP5_SUPPORT)) {\r\nif (connected) {\r\nDRM_DEBUG_KMS("DFP5 connected\n");\r\nbios_0_scratch |= ATOM_S0_DFP5;\r\nbios_3_scratch |= ATOM_S3_DFP5_ACTIVE;\r\nbios_6_scratch |= ATOM_S6_ACC_REQ_DFP5;\r\n} else {\r\nDRM_DEBUG_KMS("DFP5 disconnected\n");\r\nbios_0_scratch &= ~ATOM_S0_DFP5;\r\nbios_3_scratch &= ~ATOM_S3_DFP5_ACTIVE;\r\nbios_6_scratch &= ~ATOM_S6_ACC_REQ_DFP5;\r\n}\r\n}\r\nif ((amdgpu_encoder->devices & ATOM_DEVICE_DFP6_SUPPORT) &&\r\n(amdgpu_connector->devices & ATOM_DEVICE_DFP6_SUPPORT)) {\r\nif (connected) {\r\nDRM_DEBUG_KMS("DFP6 connected\n");\r\nbios_0_scratch |= ATOM_S0_DFP6;\r\nbios_3_scratch |= ATOM_S3_DFP6_ACTIVE;\r\nbios_6_scratch |= ATOM_S6_ACC_REQ_DFP6;\r\n} else {\r\nDRM_DEBUG_KMS("DFP6 disconnected\n");\r\nbios_0_scratch &= ~ATOM_S0_DFP6;\r\nbios_3_scratch &= ~ATOM_S3_DFP6_ACTIVE;\r\nbios_6_scratch &= ~ATOM_S6_ACC_REQ_DFP6;\r\n}\r\n}\r\nWREG32(mmBIOS_SCRATCH_0, bios_0_scratch);\r\nWREG32(mmBIOS_SCRATCH_3, bios_3_scratch);\r\nWREG32(mmBIOS_SCRATCH_6, bios_6_scratch);\r\n}\r\nstruct amdgpu_encoder_atom_dig *\r\namdgpu_atombios_encoder_get_lcd_info(struct amdgpu_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->base.dev;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct amdgpu_mode_info *mode_info = &adev->mode_info;\r\nint index = GetIndexIntoMasterTable(DATA, LVDS_Info);\r\nuint16_t data_offset, misc;\r\nunion lvds_info *lvds_info;\r\nuint8_t frev, crev;\r\nstruct amdgpu_encoder_atom_dig *lvds = NULL;\r\nint encoder_enum = (encoder->encoder_enum & ENUM_ID_MASK) >> ENUM_ID_SHIFT;\r\nif (amdgpu_atom_parse_data_header(mode_info->atom_context, index, NULL,\r\n&frev, &crev, &data_offset)) {\r\nlvds_info =\r\n(union lvds_info *)(mode_info->atom_context->bios + data_offset);\r\nlvds =\r\nkzalloc(sizeof(struct amdgpu_encoder_atom_dig), GFP_KERNEL);\r\nif (!lvds)\r\nreturn NULL;\r\nlvds->native_mode.clock =\r\nle16_to_cpu(lvds_info->info.sLCDTiming.usPixClk) * 10;\r\nlvds->native_mode.hdisplay =\r\nle16_to_cpu(lvds_info->info.sLCDTiming.usHActive);\r\nlvds->native_mode.vdisplay =\r\nle16_to_cpu(lvds_info->info.sLCDTiming.usVActive);\r\nlvds->native_mode.htotal = lvds->native_mode.hdisplay +\r\nle16_to_cpu(lvds_info->info.sLCDTiming.usHBlanking_Time);\r\nlvds->native_mode.hsync_start = lvds->native_mode.hdisplay +\r\nle16_to_cpu(lvds_info->info.sLCDTiming.usHSyncOffset);\r\nlvds->native_mode.hsync_end = lvds->native_mode.hsync_start +\r\nle16_to_cpu(lvds_info->info.sLCDTiming.usHSyncWidth);\r\nlvds->native_mode.vtotal = lvds->native_mode.vdisplay +\r\nle16_to_cpu(lvds_info->info.sLCDTiming.usVBlanking_Time);\r\nlvds->native_mode.vsync_start = lvds->native_mode.vdisplay +\r\nle16_to_cpu(lvds_info->info.sLCDTiming.usVSyncOffset);\r\nlvds->native_mode.vsync_end = lvds->native_mode.vsync_start +\r\nle16_to_cpu(lvds_info->info.sLCDTiming.usVSyncWidth);\r\nlvds->panel_pwr_delay =\r\nle16_to_cpu(lvds_info->info.usOffDelayInMs);\r\nlvds->lcd_misc = lvds_info->info.ucLVDS_Misc;\r\nmisc = le16_to_cpu(lvds_info->info.sLCDTiming.susModeMiscInfo.usAccess);\r\nif (misc & ATOM_VSYNC_POLARITY)\r\nlvds->native_mode.flags |= DRM_MODE_FLAG_NVSYNC;\r\nif (misc & ATOM_HSYNC_POLARITY)\r\nlvds->native_mode.flags |= DRM_MODE_FLAG_NHSYNC;\r\nif (misc & ATOM_COMPOSITESYNC)\r\nlvds->native_mode.flags |= DRM_MODE_FLAG_CSYNC;\r\nif (misc & ATOM_INTERLACE)\r\nlvds->native_mode.flags |= DRM_MODE_FLAG_INTERLACE;\r\nif (misc & ATOM_DOUBLE_CLOCK_MODE)\r\nlvds->native_mode.flags |= DRM_MODE_FLAG_DBLSCAN;\r\nlvds->native_mode.width_mm = le16_to_cpu(lvds_info->info.sLCDTiming.usImageHSize);\r\nlvds->native_mode.height_mm = le16_to_cpu(lvds_info->info.sLCDTiming.usImageVSize);\r\ndrm_mode_set_crtcinfo(&lvds->native_mode, CRTC_INTERLACE_HALVE_V);\r\nlvds->lcd_ss_id = lvds_info->info.ucSS_Id;\r\nencoder->native_mode = lvds->native_mode;\r\nif (encoder_enum == 2)\r\nlvds->linkb = true;\r\nelse\r\nlvds->linkb = false;\r\nif (le16_to_cpu(lvds_info->info.usModePatchTableOffset)) {\r\nATOM_FAKE_EDID_PATCH_RECORD *fake_edid_record;\r\nATOM_PANEL_RESOLUTION_PATCH_RECORD *panel_res_record;\r\nbool bad_record = false;\r\nu8 *record;\r\nif ((frev == 1) && (crev < 2))\r\nrecord = (u8 *)(mode_info->atom_context->bios +\r\nle16_to_cpu(lvds_info->info.usModePatchTableOffset));\r\nelse\r\nrecord = (u8 *)(mode_info->atom_context->bios +\r\ndata_offset +\r\nle16_to_cpu(lvds_info->info.usModePatchTableOffset));\r\nwhile (*record != ATOM_RECORD_END_TYPE) {\r\nswitch (*record) {\r\ncase LCD_MODE_PATCH_RECORD_MODE_TYPE:\r\nrecord += sizeof(ATOM_PATCH_RECORD_MODE);\r\nbreak;\r\ncase LCD_RTS_RECORD_TYPE:\r\nrecord += sizeof(ATOM_LCD_RTS_RECORD);\r\nbreak;\r\ncase LCD_CAP_RECORD_TYPE:\r\nrecord += sizeof(ATOM_LCD_MODE_CONTROL_CAP);\r\nbreak;\r\ncase LCD_FAKE_EDID_PATCH_RECORD_TYPE:\r\nfake_edid_record = (ATOM_FAKE_EDID_PATCH_RECORD *)record;\r\nif (fake_edid_record->ucFakeEDIDLength) {\r\nstruct edid *edid;\r\nint edid_size =\r\nmax((int)EDID_LENGTH, (int)fake_edid_record->ucFakeEDIDLength);\r\nedid = kmalloc(edid_size, GFP_KERNEL);\r\nif (edid) {\r\nmemcpy((u8 *)edid, (u8 *)&fake_edid_record->ucFakeEDIDString[0],\r\nfake_edid_record->ucFakeEDIDLength);\r\nif (drm_edid_is_valid(edid)) {\r\nadev->mode_info.bios_hardcoded_edid = edid;\r\nadev->mode_info.bios_hardcoded_edid_size = edid_size;\r\n} else\r\nkfree(edid);\r\n}\r\n}\r\nrecord += fake_edid_record->ucFakeEDIDLength ?\r\nfake_edid_record->ucFakeEDIDLength + 2 :\r\nsizeof(ATOM_FAKE_EDID_PATCH_RECORD);\r\nbreak;\r\ncase LCD_PANEL_RESOLUTION_RECORD_TYPE:\r\npanel_res_record = (ATOM_PANEL_RESOLUTION_PATCH_RECORD *)record;\r\nlvds->native_mode.width_mm = panel_res_record->usHSize;\r\nlvds->native_mode.height_mm = panel_res_record->usVSize;\r\nrecord += sizeof(ATOM_PANEL_RESOLUTION_PATCH_RECORD);\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Bad LCD record %d\n", *record);\r\nbad_record = true;\r\nbreak;\r\n}\r\nif (bad_record)\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn lvds;\r\n}\r\nstruct amdgpu_encoder_atom_dig *\r\namdgpu_atombios_encoder_get_dig_info(struct amdgpu_encoder *amdgpu_encoder)\r\n{\r\nint encoder_enum = (amdgpu_encoder->encoder_enum & ENUM_ID_MASK) >> ENUM_ID_SHIFT;\r\nstruct amdgpu_encoder_atom_dig *dig = kzalloc(sizeof(struct amdgpu_encoder_atom_dig), GFP_KERNEL);\r\nif (!dig)\r\nreturn NULL;\r\ndig->coherent_mode = true;\r\ndig->dig_encoder = -1;\r\nif (encoder_enum == 2)\r\ndig->linkb = true;\r\nelse\r\ndig->linkb = false;\r\nreturn dig;\r\n}

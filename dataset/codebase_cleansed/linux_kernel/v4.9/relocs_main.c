void die(char *fmt, ...)\r\n{\r\nva_list ap;\r\nva_start(ap, fmt);\r\nvfprintf(stderr, fmt, ap);\r\nva_end(ap);\r\nexit(1);\r\n}\r\nstatic void usage(void)\r\n{\r\ndie("relocs [--reloc-info|--text|--bin|--keep] vmlinux\n");\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nint show_reloc_info, as_text, as_bin, keep_relocs;\r\nconst char *fname;\r\nFILE *fp;\r\nint i;\r\nunsigned char e_ident[EI_NIDENT];\r\nshow_reloc_info = 0;\r\nas_text = 0;\r\nas_bin = 0;\r\nkeep_relocs = 0;\r\nfname = NULL;\r\nfor (i = 1; i < argc; i++) {\r\nchar *arg = argv[i];\r\nif (*arg == '-') {\r\nif (strcmp(arg, "--reloc-info") == 0) {\r\nshow_reloc_info = 1;\r\ncontinue;\r\n}\r\nif (strcmp(arg, "--text") == 0) {\r\nas_text = 1;\r\ncontinue;\r\n}\r\nif (strcmp(arg, "--bin") == 0) {\r\nas_bin = 1;\r\ncontinue;\r\n}\r\nif (strcmp(arg, "--keep") == 0) {\r\nkeep_relocs = 1;\r\ncontinue;\r\n}\r\n} else if (!fname) {\r\nfname = arg;\r\ncontinue;\r\n}\r\nusage();\r\n}\r\nif (!fname)\r\nusage();\r\nfp = fopen(fname, "r+");\r\nif (!fp)\r\ndie("Cannot open %s: %s\n", fname, strerror(errno));\r\nif (fread(&e_ident, 1, EI_NIDENT, fp) != EI_NIDENT)\r\ndie("Cannot read %s: %s", fname, strerror(errno));\r\nrewind(fp);\r\nif (e_ident[EI_CLASS] == ELFCLASS64)\r\nprocess_64(fp, as_text, as_bin, show_reloc_info, keep_relocs);\r\nelse\r\nprocess_32(fp, as_text, as_bin, show_reloc_info, keep_relocs);\r\nfclose(fp);\r\nreturn 0;\r\n}

static int get_cache_sram_params(struct sram_parameters *sram_params)\r\n{\r\nunsigned long long addr;\r\nunsigned int size;\r\nif (!sram_size || (kstrtouint(sram_size, 0, &size) < 0))\r\nreturn -EINVAL;\r\nif (!sram_offset || (kstrtoull(sram_offset, 0, &addr) < 0))\r\nreturn -EINVAL;\r\nsram_params->sram_offset = addr;\r\nsram_params->sram_size = size;\r\nreturn 0;\r\n}\r\nstatic int __init get_size_from_cmdline(char *str)\r\n{\r\nif (!str)\r\nreturn 0;\r\nsram_size = str;\r\nreturn 1;\r\n}\r\nstatic int __init get_offset_from_cmdline(char *str)\r\n{\r\nif (!str)\r\nreturn 0;\r\nsram_offset = str;\r\nreturn 1;\r\n}\r\nstatic int mpc85xx_l2ctlr_of_probe(struct platform_device *dev)\r\n{\r\nlong rval;\r\nunsigned int rem;\r\nunsigned char ways;\r\nconst unsigned int *prop;\r\nunsigned int l2cache_size;\r\nstruct sram_parameters sram_params;\r\nif (!dev->dev.of_node) {\r\ndev_err(&dev->dev, "Device's OF-node is NULL\n");\r\nreturn -EINVAL;\r\n}\r\nprop = of_get_property(dev->dev.of_node, "cache-size", NULL);\r\nif (!prop) {\r\ndev_err(&dev->dev, "Missing L2 cache-size\n");\r\nreturn -EINVAL;\r\n}\r\nl2cache_size = *prop;\r\nif (get_cache_sram_params(&sram_params))\r\nreturn 0;\r\nrem = l2cache_size % sram_params.sram_size;\r\nways = LOCK_WAYS_FULL * sram_params.sram_size / l2cache_size;\r\nif (rem || (ways & (ways - 1))) {\r\ndev_err(&dev->dev, "Illegal cache-sram-size in command line\n");\r\nreturn -EINVAL;\r\n}\r\nl2ctlr = of_iomap(dev->dev.of_node, 0);\r\nif (!l2ctlr) {\r\ndev_err(&dev->dev, "Can't map L2 controller\n");\r\nreturn -EINVAL;\r\n}\r\nout_be32(&l2ctlr->srbar0,\r\nlower_32_bits(sram_params.sram_offset) & L2SRAM_BAR_MSK_LO18);\r\n#ifdef CONFIG_PHYS_64BIT\r\nout_be32(&l2ctlr->srbarea0,\r\nupper_32_bits(sram_params.sram_offset) & L2SRAM_BARE_MSK_HI4);\r\n#endif\r\nclrsetbits_be32(&l2ctlr->ctl, L2CR_L2E, L2CR_L2FI);\r\nswitch (ways) {\r\ncase LOCK_WAYS_EIGHTH:\r\nsetbits32(&l2ctlr->ctl,\r\nL2CR_L2E | L2CR_L2FI | L2CR_SRAM_EIGHTH);\r\nbreak;\r\ncase LOCK_WAYS_TWO_EIGHTH:\r\nsetbits32(&l2ctlr->ctl,\r\nL2CR_L2E | L2CR_L2FI | L2CR_SRAM_QUART);\r\nbreak;\r\ncase LOCK_WAYS_HALF:\r\nsetbits32(&l2ctlr->ctl,\r\nL2CR_L2E | L2CR_L2FI | L2CR_SRAM_HALF);\r\nbreak;\r\ncase LOCK_WAYS_FULL:\r\ndefault:\r\nsetbits32(&l2ctlr->ctl,\r\nL2CR_L2E | L2CR_L2FI | L2CR_SRAM_FULL);\r\nbreak;\r\n}\r\neieio();\r\nrval = instantiate_cache_sram(dev, sram_params);\r\nif (rval < 0) {\r\ndev_err(&dev->dev, "Can't instantiate Cache-SRAM\n");\r\niounmap(l2ctlr);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mpc85xx_l2ctlr_of_remove(struct platform_device *dev)\r\n{\r\nBUG_ON(!l2ctlr);\r\niounmap(l2ctlr);\r\nremove_cache_sram(dev);\r\ndev_info(&dev->dev, "MPC85xx L2 controller unloaded\n");\r\nreturn 0;\r\n}\r\nstatic __init int mpc85xx_l2ctlr_of_init(void)\r\n{\r\nreturn platform_driver_register(&mpc85xx_l2ctlr_of_platform_driver);\r\n}\r\nstatic void __exit mpc85xx_l2ctlr_of_exit(void)\r\n{\r\nplatform_driver_unregister(&mpc85xx_l2ctlr_of_platform_driver);\r\n}

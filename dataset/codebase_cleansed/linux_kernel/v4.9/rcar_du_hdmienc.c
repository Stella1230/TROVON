static void rcar_du_hdmienc_disable(struct drm_encoder *encoder)\r\n{\r\nstruct rcar_du_hdmienc *hdmienc = to_rcar_hdmienc(encoder);\r\nif (hdmienc->renc->lvds)\r\nrcar_du_lvdsenc_enable(hdmienc->renc->lvds, encoder->crtc,\r\nfalse);\r\nhdmienc->enabled = false;\r\n}\r\nstatic void rcar_du_hdmienc_enable(struct drm_encoder *encoder)\r\n{\r\nstruct rcar_du_hdmienc *hdmienc = to_rcar_hdmienc(encoder);\r\nif (hdmienc->renc->lvds)\r\nrcar_du_lvdsenc_enable(hdmienc->renc->lvds, encoder->crtc,\r\ntrue);\r\nhdmienc->enabled = true;\r\n}\r\nstatic int rcar_du_hdmienc_atomic_check(struct drm_encoder *encoder,\r\nstruct drm_crtc_state *crtc_state,\r\nstruct drm_connector_state *conn_state)\r\n{\r\nstruct rcar_du_hdmienc *hdmienc = to_rcar_hdmienc(encoder);\r\nstruct drm_display_mode *adjusted_mode = &crtc_state->adjusted_mode;\r\nif (hdmienc->renc->lvds)\r\nrcar_du_lvdsenc_atomic_check(hdmienc->renc->lvds,\r\nadjusted_mode);\r\nreturn 0;\r\n}\r\nstatic void rcar_du_hdmienc_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct rcar_du_hdmienc *hdmienc = to_rcar_hdmienc(encoder);\r\nrcar_du_crtc_route_output(encoder->crtc, hdmienc->renc->output);\r\n}\r\nstatic void rcar_du_hdmienc_cleanup(struct drm_encoder *encoder)\r\n{\r\nstruct rcar_du_hdmienc *hdmienc = to_rcar_hdmienc(encoder);\r\nif (hdmienc->enabled)\r\nrcar_du_hdmienc_disable(encoder);\r\ndrm_encoder_cleanup(encoder);\r\n}\r\nint rcar_du_hdmienc_init(struct rcar_du_device *rcdu,\r\nstruct rcar_du_encoder *renc, struct device_node *np)\r\n{\r\nstruct drm_encoder *encoder = rcar_encoder_to_drm_encoder(renc);\r\nstruct drm_bridge *bridge;\r\nstruct rcar_du_hdmienc *hdmienc;\r\nint ret;\r\nhdmienc = devm_kzalloc(rcdu->dev, sizeof(*hdmienc), GFP_KERNEL);\r\nif (hdmienc == NULL)\r\nreturn -ENOMEM;\r\nbridge = of_drm_find_bridge(np);\r\nif (!bridge)\r\nreturn -EPROBE_DEFER;\r\nret = drm_encoder_init(rcdu->ddev, encoder, &encoder_funcs,\r\nDRM_MODE_ENCODER_TMDS, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\ndrm_encoder_helper_add(encoder, &encoder_helper_funcs);\r\nrenc->hdmi = hdmienc;\r\nhdmienc->renc = renc;\r\nbridge->encoder = encoder;\r\nencoder->bridge = bridge;\r\nret = drm_bridge_attach(rcdu->ddev, bridge);\r\nif (ret) {\r\ndrm_encoder_cleanup(encoder);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

static void clear_stats(int fd)\r\n{\r\nunsigned int nr_cpus = sysconf(_SC_NPROCESSORS_CONF);\r\n__u64 values[nr_cpus];\r\n__u32 key;\r\nmemset(values, 0, sizeof(values));\r\nfor (key = 0; key < SLOTS; key++)\r\nbpf_update_elem(fd, &key, values, BPF_ANY);\r\n}\r\nstatic void print_banner(void)\r\n{\r\nif (full_range)\r\nprintf("|1ns |10ns |100ns |1us |10us |100us"\r\n" |1ms |10ms |100ms |1s |10s\n");\r\nelse\r\nprintf("|1us |10us |100us |1ms |10ms "\r\n"|100ms |1s |10s\n");\r\n}\r\nstatic void print_hist(int fd)\r\n{\r\nunsigned int nr_cpus = sysconf(_SC_NPROCESSORS_CONF);\r\n__u64 total_events = 0;\r\nlong values[nr_cpus];\r\n__u64 max_cnt = 0;\r\n__u64 cnt[SLOTS];\r\n__u64 value;\r\n__u32 key;\r\nint i;\r\nfor (key = 0; key < SLOTS; key++) {\r\nbpf_lookup_elem(fd, &key, values);\r\nvalue = 0;\r\nfor (i = 0; i < nr_cpus; i++)\r\nvalue += values[i];\r\ncnt[key] = value;\r\ntotal_events += value;\r\nif (value > max_cnt)\r\nmax_cnt = value;\r\n}\r\nclear_stats(fd);\r\nfor (key = full_range ? 0 : 29; key < SLOTS; key++) {\r\nint c = num_colors * cnt[key] / (max_cnt + 1);\r\nif (text_only)\r\nprintf("%s", sym[c]);\r\nelse\r\nprintf("%s %s", color[c], nocolor);\r\n}\r\nprintf(" # %lld\n", total_events);\r\n}\r\nint main(int ac, char **argv)\r\n{\r\nchar filename[256];\r\nint i;\r\nsnprintf(filename, sizeof(filename), "%s_kern.o", argv[0]);\r\nif (load_bpf_file(filename)) {\r\nprintf("%s", bpf_log_buf);\r\nreturn 1;\r\n}\r\nfor (i = 1; i < ac; i++) {\r\nif (strcmp(argv[i], "-a") == 0) {\r\nfull_range = true;\r\n} else if (strcmp(argv[i], "-t") == 0) {\r\ntext_only = true;\r\n} else if (strcmp(argv[i], "-h") == 0) {\r\nprintf("Usage:\n"\r\n" -a display wider latency range\n"\r\n" -t text only\n");\r\nreturn 1;\r\n}\r\n}\r\nprintf(" heatmap of IO latency\n");\r\nif (text_only)\r\nprintf(" %s", sym[num_colors - 1]);\r\nelse\r\nprintf(" %s %s", color[num_colors - 1], nocolor);\r\nprintf(" - many events with this latency\n");\r\nif (text_only)\r\nprintf(" %s", sym[0]);\r\nelse\r\nprintf(" %s %s", color[0], nocolor);\r\nprintf(" - few events\n");\r\nfor (i = 0; ; i++) {\r\nif (i % 20 == 0)\r\nprint_banner();\r\nprint_hist(map_fd[1]);\r\nsleep(2);\r\n}\r\nreturn 0;\r\n}

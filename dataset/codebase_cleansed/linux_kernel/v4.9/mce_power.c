static void flush_tlb_206(unsigned int num_sets, unsigned int action)\r\n{\r\nunsigned long rb;\r\nunsigned int i;\r\nswitch (action) {\r\ncase TLB_INVAL_SCOPE_GLOBAL:\r\nrb = TLBIEL_INVAL_SET;\r\nbreak;\r\ncase TLB_INVAL_SCOPE_LPID:\r\nrb = TLBIEL_INVAL_SET_LPID;\r\nbreak;\r\ndefault:\r\nBUG();\r\nbreak;\r\n}\r\nasm volatile("ptesync" : : : "memory");\r\nfor (i = 0; i < num_sets; i++) {\r\nasm volatile("tlbiel %0" : : "r" (rb));\r\nrb += 1 << TLBIEL_INVAL_SET_SHIFT;\r\n}\r\nasm volatile("ptesync" : : : "memory");\r\n}\r\nvoid __flush_tlb_power7(unsigned int action)\r\n{\r\nflush_tlb_206(POWER7_TLB_SETS, action);\r\n}\r\nvoid __flush_tlb_power8(unsigned int action)\r\n{\r\nflush_tlb_206(POWER8_TLB_SETS, action);\r\n}\r\nvoid __flush_tlb_power9(unsigned int action)\r\n{\r\nif (radix_enabled())\r\nflush_tlb_206(POWER9_TLB_SETS_RADIX, action);\r\nflush_tlb_206(POWER9_TLB_SETS_HASH, action);\r\n}\r\nstatic void flush_and_reload_slb(void)\r\n{\r\nstruct slb_shadow *slb;\r\nunsigned long i, n;\r\nasm volatile("slbmte %0,%0; slbia" : : "r" (0));\r\n#ifdef CONFIG_KVM_BOOK3S_HANDLER\r\nif (get_paca()->kvm_hstate.in_guest)\r\nreturn;\r\n#endif\r\nslb = get_slb_shadow();\r\nif (!slb)\r\nreturn;\r\nn = min_t(u32, be32_to_cpu(slb->persistent), SLB_MIN_SIZE);\r\nfor (i = 0; i < n; i++) {\r\nunsigned long rb = be64_to_cpu(slb->save_area[i].esid);\r\nunsigned long rs = be64_to_cpu(slb->save_area[i].vsid);\r\nrb = (rb & ~0xFFFul) | i;\r\nasm volatile("slbmte %0,%1" : : "r" (rs), "r" (rb));\r\n}\r\n}\r\nstatic long mce_handle_derror(uint64_t dsisr, uint64_t slb_error_bits)\r\n{\r\nlong handled = 1;\r\n#ifdef CONFIG_PPC_STD_MMU_64\r\nif (dsisr & slb_error_bits) {\r\nflush_and_reload_slb();\r\ndsisr &= ~(slb_error_bits);\r\n}\r\nif (dsisr & P7_DSISR_MC_TLB_MULTIHIT_MFTLB) {\r\nif (cur_cpu_spec && cur_cpu_spec->flush_tlb)\r\ncur_cpu_spec->flush_tlb(TLB_INVAL_SCOPE_GLOBAL);\r\ndsisr &= ~P7_DSISR_MC_TLB_MULTIHIT_MFTLB;\r\n}\r\n#endif\r\nif (dsisr & 0xffffffffUL)\r\nhandled = 0;\r\nreturn handled;\r\n}\r\nstatic long mce_handle_derror_p7(uint64_t dsisr)\r\n{\r\nreturn mce_handle_derror(dsisr, P7_DSISR_MC_SLB_ERRORS);\r\n}\r\nstatic long mce_handle_common_ierror(uint64_t srr1)\r\n{\r\nlong handled = 0;\r\nswitch (P7_SRR1_MC_IFETCH(srr1)) {\r\ncase 0:\r\nbreak;\r\n#ifdef CONFIG_PPC_STD_MMU_64\r\ncase P7_SRR1_MC_IFETCH_SLB_PARITY:\r\ncase P7_SRR1_MC_IFETCH_SLB_MULTIHIT:\r\nflush_and_reload_slb();\r\nhandled = 1;\r\nbreak;\r\ncase P7_SRR1_MC_IFETCH_TLB_MULTIHIT:\r\nif (cur_cpu_spec && cur_cpu_spec->flush_tlb) {\r\ncur_cpu_spec->flush_tlb(TLB_INVAL_SCOPE_GLOBAL);\r\nhandled = 1;\r\n}\r\nbreak;\r\n#endif\r\ndefault:\r\nbreak;\r\n}\r\nreturn handled;\r\n}\r\nstatic long mce_handle_ierror_p7(uint64_t srr1)\r\n{\r\nlong handled = 0;\r\nhandled = mce_handle_common_ierror(srr1);\r\n#ifdef CONFIG_PPC_STD_MMU_64\r\nif (P7_SRR1_MC_IFETCH(srr1) == P7_SRR1_MC_IFETCH_SLB_BOTH) {\r\nflush_and_reload_slb();\r\nhandled = 1;\r\n}\r\n#endif\r\nreturn handled;\r\n}\r\nstatic void mce_get_common_ierror(struct mce_error_info *mce_err, uint64_t srr1)\r\n{\r\nswitch (P7_SRR1_MC_IFETCH(srr1)) {\r\ncase P7_SRR1_MC_IFETCH_SLB_PARITY:\r\nmce_err->error_type = MCE_ERROR_TYPE_SLB;\r\nmce_err->u.slb_error_type = MCE_SLB_ERROR_PARITY;\r\nbreak;\r\ncase P7_SRR1_MC_IFETCH_SLB_MULTIHIT:\r\nmce_err->error_type = MCE_ERROR_TYPE_SLB;\r\nmce_err->u.slb_error_type = MCE_SLB_ERROR_MULTIHIT;\r\nbreak;\r\ncase P7_SRR1_MC_IFETCH_TLB_MULTIHIT:\r\nmce_err->error_type = MCE_ERROR_TYPE_TLB;\r\nmce_err->u.tlb_error_type = MCE_TLB_ERROR_MULTIHIT;\r\nbreak;\r\ncase P7_SRR1_MC_IFETCH_UE:\r\ncase P7_SRR1_MC_IFETCH_UE_IFU_INTERNAL:\r\nmce_err->error_type = MCE_ERROR_TYPE_UE;\r\nmce_err->u.ue_error_type = MCE_UE_ERROR_IFETCH;\r\nbreak;\r\ncase P7_SRR1_MC_IFETCH_UE_TLB_RELOAD:\r\nmce_err->error_type = MCE_ERROR_TYPE_UE;\r\nmce_err->u.ue_error_type =\r\nMCE_UE_ERROR_PAGE_TABLE_WALK_IFETCH;\r\nbreak;\r\n}\r\n}\r\nstatic void mce_get_ierror_p7(struct mce_error_info *mce_err, uint64_t srr1)\r\n{\r\nmce_get_common_ierror(mce_err, srr1);\r\nif (P7_SRR1_MC_IFETCH(srr1) == P7_SRR1_MC_IFETCH_SLB_BOTH) {\r\nmce_err->error_type = MCE_ERROR_TYPE_SLB;\r\nmce_err->u.slb_error_type = MCE_SLB_ERROR_INDETERMINATE;\r\n}\r\n}\r\nstatic void mce_get_derror_p7(struct mce_error_info *mce_err, uint64_t dsisr)\r\n{\r\nif (dsisr & P7_DSISR_MC_UE) {\r\nmce_err->error_type = MCE_ERROR_TYPE_UE;\r\nmce_err->u.ue_error_type = MCE_UE_ERROR_LOAD_STORE;\r\n} else if (dsisr & P7_DSISR_MC_UE_TABLEWALK) {\r\nmce_err->error_type = MCE_ERROR_TYPE_UE;\r\nmce_err->u.ue_error_type =\r\nMCE_UE_ERROR_PAGE_TABLE_WALK_LOAD_STORE;\r\n} else if (dsisr & P7_DSISR_MC_ERAT_MULTIHIT) {\r\nmce_err->error_type = MCE_ERROR_TYPE_ERAT;\r\nmce_err->u.erat_error_type = MCE_ERAT_ERROR_MULTIHIT;\r\n} else if (dsisr & P7_DSISR_MC_SLB_MULTIHIT) {\r\nmce_err->error_type = MCE_ERROR_TYPE_SLB;\r\nmce_err->u.slb_error_type = MCE_SLB_ERROR_MULTIHIT;\r\n} else if (dsisr & P7_DSISR_MC_SLB_PARITY_MFSLB) {\r\nmce_err->error_type = MCE_ERROR_TYPE_SLB;\r\nmce_err->u.slb_error_type = MCE_SLB_ERROR_PARITY;\r\n} else if (dsisr & P7_DSISR_MC_TLB_MULTIHIT_MFTLB) {\r\nmce_err->error_type = MCE_ERROR_TYPE_TLB;\r\nmce_err->u.tlb_error_type = MCE_TLB_ERROR_MULTIHIT;\r\n} else if (dsisr & P7_DSISR_MC_SLB_MULTIHIT_PARITY) {\r\nmce_err->error_type = MCE_ERROR_TYPE_SLB;\r\nmce_err->u.slb_error_type = MCE_SLB_ERROR_INDETERMINATE;\r\n}\r\n}\r\nstatic long mce_handle_ue_error(struct pt_regs *regs)\r\n{\r\nlong handled = 0;\r\nif (ppc_md.mce_check_early_recovery) {\r\nif (ppc_md.mce_check_early_recovery(regs))\r\nhandled = 1;\r\n}\r\nreturn handled;\r\n}\r\nlong __machine_check_early_realmode_p7(struct pt_regs *regs)\r\n{\r\nuint64_t srr1, nip, addr;\r\nlong handled = 1;\r\nstruct mce_error_info mce_error_info = { 0 };\r\nsrr1 = regs->msr;\r\nnip = regs->nip;\r\nif (P7_SRR1_MC_LOADSTORE(srr1)) {\r\nhandled = mce_handle_derror_p7(regs->dsisr);\r\nmce_get_derror_p7(&mce_error_info, regs->dsisr);\r\naddr = regs->dar;\r\n} else {\r\nhandled = mce_handle_ierror_p7(srr1);\r\nmce_get_ierror_p7(&mce_error_info, srr1);\r\naddr = regs->nip;\r\n}\r\nif (mce_error_info.error_type == MCE_ERROR_TYPE_UE)\r\nhandled = mce_handle_ue_error(regs);\r\nsave_mce_event(regs, handled, &mce_error_info, nip, addr);\r\nreturn handled;\r\n}\r\nstatic void mce_get_ierror_p8(struct mce_error_info *mce_err, uint64_t srr1)\r\n{\r\nmce_get_common_ierror(mce_err, srr1);\r\nif (P7_SRR1_MC_IFETCH(srr1) == P8_SRR1_MC_IFETCH_ERAT_MULTIHIT) {\r\nmce_err->error_type = MCE_ERROR_TYPE_ERAT;\r\nmce_err->u.erat_error_type = MCE_ERAT_ERROR_MULTIHIT;\r\n}\r\n}\r\nstatic void mce_get_derror_p8(struct mce_error_info *mce_err, uint64_t dsisr)\r\n{\r\nmce_get_derror_p7(mce_err, dsisr);\r\nif (dsisr & P8_DSISR_MC_ERAT_MULTIHIT_SEC) {\r\nmce_err->error_type = MCE_ERROR_TYPE_ERAT;\r\nmce_err->u.erat_error_type = MCE_ERAT_ERROR_MULTIHIT;\r\n}\r\n}\r\nstatic long mce_handle_ierror_p8(uint64_t srr1)\r\n{\r\nlong handled = 0;\r\nhandled = mce_handle_common_ierror(srr1);\r\n#ifdef CONFIG_PPC_STD_MMU_64\r\nif (P7_SRR1_MC_IFETCH(srr1) == P8_SRR1_MC_IFETCH_ERAT_MULTIHIT) {\r\nflush_and_reload_slb();\r\nhandled = 1;\r\n}\r\n#endif\r\nreturn handled;\r\n}\r\nstatic long mce_handle_derror_p8(uint64_t dsisr)\r\n{\r\nreturn mce_handle_derror(dsisr, P8_DSISR_MC_SLB_ERRORS);\r\n}\r\nlong __machine_check_early_realmode_p8(struct pt_regs *regs)\r\n{\r\nuint64_t srr1, nip, addr;\r\nlong handled = 1;\r\nstruct mce_error_info mce_error_info = { 0 };\r\nsrr1 = regs->msr;\r\nnip = regs->nip;\r\nif (P7_SRR1_MC_LOADSTORE(srr1)) {\r\nhandled = mce_handle_derror_p8(regs->dsisr);\r\nmce_get_derror_p8(&mce_error_info, regs->dsisr);\r\naddr = regs->dar;\r\n} else {\r\nhandled = mce_handle_ierror_p8(srr1);\r\nmce_get_ierror_p8(&mce_error_info, srr1);\r\naddr = regs->nip;\r\n}\r\nif (mce_error_info.error_type == MCE_ERROR_TYPE_UE)\r\nhandled = mce_handle_ue_error(regs);\r\nsave_mce_event(regs, handled, &mce_error_info, nip, addr);\r\nreturn handled;\r\n}

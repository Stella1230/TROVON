static void __init at91_wakeup_status(void)\r\n{\r\nu32 reg = readl(at91_shdwc_base + AT91_SHDW_SR);\r\nchar *reason = "unknown";\r\nif (!reg)\r\nreturn;\r\nif (reg & AT91_SHDW_RTTWK)\r\nreason = "RTT";\r\nelse if (reg & AT91_SHDW_RTCWK)\r\nreason = "RTC";\r\npr_info("AT91: Wake-Up source: %s\n", reason);\r\n}\r\nstatic void at91_poweroff(void)\r\n{\r\nwritel(AT91_SHDW_KEY | AT91_SHDW_SHDW, at91_shdwc_base + AT91_SHDW_CR);\r\n}\r\nstatic int at91_poweroff_get_wakeup_mode(struct device_node *np)\r\n{\r\nconst char *pm;\r\nunsigned int i;\r\nint err;\r\nerr = of_property_read_string(np, "atmel,wakeup-mode", &pm);\r\nif (err < 0)\r\nreturn AT91_SHDW_WKMODE0_ANYLEVEL;\r\nfor (i = 0; i < ARRAY_SIZE(shdwc_wakeup_modes); i++)\r\nif (!strcasecmp(pm, shdwc_wakeup_modes[i]))\r\nreturn i;\r\nreturn -ENODEV;\r\n}\r\nstatic void at91_poweroff_dt_set_wakeup_mode(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nint wakeup_mode;\r\nu32 mode = 0, tmp;\r\nwakeup_mode = at91_poweroff_get_wakeup_mode(np);\r\nif (wakeup_mode < 0) {\r\ndev_warn(&pdev->dev, "shdwc unknown wakeup mode\n");\r\nreturn;\r\n}\r\nif (!of_property_read_u32(np, "atmel,wakeup-counter", &tmp)) {\r\nif (tmp > AT91_SHDW_CPTWK0_MAX) {\r\ndev_warn(&pdev->dev,\r\n"shdwc wakeup counter 0x%x > 0x%x reduce it to 0x%x\n",\r\ntmp, AT91_SHDW_CPTWK0_MAX, AT91_SHDW_CPTWK0_MAX);\r\ntmp = AT91_SHDW_CPTWK0_MAX;\r\n}\r\nmode |= AT91_SHDW_CPTWK0_(tmp);\r\n}\r\nif (of_property_read_bool(np, "atmel,wakeup-rtc-timer"))\r\nmode |= AT91_SHDW_RTCWKEN;\r\nif (of_property_read_bool(np, "atmel,wakeup-rtt-timer"))\r\nmode |= AT91_SHDW_RTTWKEN;\r\nwritel(wakeup_mode | mode, at91_shdwc_base + AT91_SHDW_MR);\r\n}\r\nstatic int __init at91_poweroff_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nint ret;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nat91_shdwc_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(at91_shdwc_base)) {\r\ndev_err(&pdev->dev, "Could not map reset controller address\n");\r\nreturn PTR_ERR(at91_shdwc_base);\r\n}\r\nsclk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(sclk))\r\nreturn PTR_ERR(sclk);\r\nret = clk_prepare_enable(sclk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Could not enable slow clock\n");\r\nreturn ret;\r\n}\r\nat91_wakeup_status();\r\nif (pdev->dev.of_node)\r\nat91_poweroff_dt_set_wakeup_mode(pdev);\r\npm_power_off = at91_poweroff;\r\nreturn 0;\r\n}\r\nstatic int __exit at91_poweroff_remove(struct platform_device *pdev)\r\n{\r\nif (pm_power_off == at91_poweroff)\r\npm_power_off = NULL;\r\nclk_disable_unprepare(sclk);\r\nreturn 0;\r\n}

static int\r\nmcp77_ram_init(struct nvkm_ram *base)\r\n{\r\nstruct mcp77_ram *ram = mcp77_ram(base);\r\nstruct nvkm_device *device = ram->base.fb->subdev.device;\r\nu32 dniso = ((ram->base.size - (ram->poller_base + 0x00)) >> 5) - 1;\r\nu32 hostnb = ((ram->base.size - (ram->poller_base + 0x20)) >> 5) - 1;\r\nu32 flush = ((ram->base.size - (ram->poller_base + 0x40)) >> 5) - 1;\r\nnvkm_wr32(device, 0x100c18, dniso);\r\nnvkm_mask(device, 0x100c14, 0x00000000, 0x00000001);\r\nnvkm_wr32(device, 0x100c1c, hostnb);\r\nnvkm_mask(device, 0x100c14, 0x00000000, 0x00000002);\r\nnvkm_wr32(device, 0x100c24, flush);\r\nnvkm_mask(device, 0x100c14, 0x00000000, 0x00010000);\r\nreturn 0;\r\n}\r\nint\r\nmcp77_ram_new(struct nvkm_fb *fb, struct nvkm_ram **pram)\r\n{\r\nstruct nvkm_device *device = fb->subdev.device;\r\nu32 rsvd_head = ( 256 * 1024);\r\nu32 rsvd_tail = (1024 * 1024) + 0x1000;\r\nu64 base = (u64)nvkm_rd32(device, 0x100e10) << 12;\r\nu64 size = (u64)nvkm_rd32(device, 0x100e14) << 12;\r\nstruct mcp77_ram *ram;\r\nint ret;\r\nif (!(ram = kzalloc(sizeof(*ram), GFP_KERNEL)))\r\nreturn -ENOMEM;\r\n*pram = &ram->base;\r\nret = nvkm_ram_ctor(&mcp77_ram_func, fb, NVKM_RAM_TYPE_STOLEN,\r\nsize, 0, &ram->base);\r\nif (ret)\r\nreturn ret;\r\nram->poller_base = size - rsvd_tail;\r\nram->base.stolen = base;\r\nnvkm_mm_fini(&ram->base.vram);\r\nreturn nvkm_mm_init(&ram->base.vram, rsvd_head >> NVKM_RAM_MM_SHIFT,\r\n(size - rsvd_head - rsvd_tail) >>\r\nNVKM_RAM_MM_SHIFT, 1);\r\n}

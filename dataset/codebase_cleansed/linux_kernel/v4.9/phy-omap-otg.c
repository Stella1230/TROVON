static void omap_otg_ctrl(struct otg_device *otg_dev, u32 outputs)\r\n{\r\nu32 l;\r\nl = readl(otg_dev->base + OMAP_OTG_CTRL);\r\nl &= ~OMAP_OTG_XCEIV_OUTPUTS;\r\nl |= outputs;\r\nwritel(l, otg_dev->base + OMAP_OTG_CTRL);\r\n}\r\nstatic void omap_otg_set_mode(struct otg_device *otg_dev)\r\n{\r\nif (!otg_dev->id && otg_dev->vbus)\r\nomap_otg_ctrl(otg_dev, OMAP_OTG_ID | OMAP_OTG_BSESSVLD);\r\nelse if (otg_dev->vbus)\r\nomap_otg_ctrl(otg_dev, OMAP_OTG_ASESSVLD);\r\nelse if (!otg_dev->id)\r\nomap_otg_ctrl(otg_dev, OMAP_OTG_ID | OMAP_OTG_BSESSEND);\r\n}\r\nstatic int omap_otg_id_notifier(struct notifier_block *nb,\r\nunsigned long event, void *ptr)\r\n{\r\nstruct otg_device *otg_dev = container_of(nb, struct otg_device, id_nb);\r\notg_dev->id = event;\r\nomap_otg_set_mode(otg_dev);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int omap_otg_vbus_notifier(struct notifier_block *nb,\r\nunsigned long event, void *ptr)\r\n{\r\nstruct otg_device *otg_dev = container_of(nb, struct otg_device,\r\nvbus_nb);\r\notg_dev->vbus = event;\r\nomap_otg_set_mode(otg_dev);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int omap_otg_probe(struct platform_device *pdev)\r\n{\r\nconst struct omap_usb_config *config = pdev->dev.platform_data;\r\nstruct otg_device *otg_dev;\r\nstruct extcon_dev *extcon;\r\nint ret;\r\nu32 rev;\r\nif (!config || !config->extcon)\r\nreturn -ENODEV;\r\nextcon = extcon_get_extcon_dev(config->extcon);\r\nif (!extcon)\r\nreturn -EPROBE_DEFER;\r\notg_dev = devm_kzalloc(&pdev->dev, sizeof(*otg_dev), GFP_KERNEL);\r\nif (!otg_dev)\r\nreturn -ENOMEM;\r\notg_dev->base = devm_ioremap_resource(&pdev->dev, &pdev->resource[0]);\r\nif (IS_ERR(otg_dev->base))\r\nreturn PTR_ERR(otg_dev->base);\r\notg_dev->extcon = extcon;\r\notg_dev->id_nb.notifier_call = omap_otg_id_notifier;\r\notg_dev->vbus_nb.notifier_call = omap_otg_vbus_notifier;\r\nret = extcon_register_notifier(extcon, EXTCON_USB_HOST, &otg_dev->id_nb);\r\nif (ret)\r\nreturn ret;\r\nret = extcon_register_notifier(extcon, EXTCON_USB, &otg_dev->vbus_nb);\r\nif (ret) {\r\nextcon_unregister_notifier(extcon, EXTCON_USB_HOST,\r\n&otg_dev->id_nb);\r\nreturn ret;\r\n}\r\notg_dev->id = extcon_get_cable_state_(extcon, EXTCON_USB_HOST);\r\notg_dev->vbus = extcon_get_cable_state_(extcon, EXTCON_USB);\r\nomap_otg_set_mode(otg_dev);\r\nrev = readl(otg_dev->base);\r\ndev_info(&pdev->dev,\r\n"OMAP USB OTG controller rev %d.%d (%s, id=%d, vbus=%d)\n",\r\n(rev >> 4) & 0xf, rev & 0xf, config->extcon, otg_dev->id,\r\notg_dev->vbus);\r\nplatform_set_drvdata(pdev, otg_dev);\r\nreturn 0;\r\n}\r\nstatic int omap_otg_remove(struct platform_device *pdev)\r\n{\r\nstruct otg_device *otg_dev = platform_get_drvdata(pdev);\r\nstruct extcon_dev *edev = otg_dev->extcon;\r\nextcon_unregister_notifier(edev, EXTCON_USB_HOST, &otg_dev->id_nb);\r\nextcon_unregister_notifier(edev, EXTCON_USB, &otg_dev->vbus_nb);\r\nreturn 0;\r\n}

static int mt8173_rt5650_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nunsigned int mclk_clock;\r\nint i, ret;\r\nswitch (mt8173_rt5650_priv.pll_from) {\r\ncase MT8173_RT5650_MCLK_EXTERNAL:\r\nmclk_clock = MCLK_FOR_CODECS;\r\nbreak;\r\ncase MT8173_RT5650_MCLK_INTERNAL:\r\nmclk_clock = params_rate(params) * 256;\r\nbreak;\r\ndefault:\r\nmclk_clock = MCLK_FOR_CODECS;\r\nbreak;\r\n}\r\nfor (i = 0; i < rtd->num_codecs; i++) {\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dais[i];\r\nret = snd_soc_dai_set_pll(codec_dai, 0, 0, mclk_clock,\r\nparams_rate(params) * 512);\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, 1,\r\nparams_rate(params) * 512,\r\nSND_SOC_CLOCK_IN);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mt8173_rt5650_init(struct snd_soc_pcm_runtime *runtime)\r\n{\r\nstruct snd_soc_card *card = runtime->card;\r\nstruct snd_soc_codec *codec = runtime->codec_dais[0]->codec;\r\nconst char *codec_capture_dai = runtime->codec_dais[1]->name;\r\nint ret;\r\nrt5645_sel_asrc_clk_src(codec,\r\nRT5645_DA_STEREO_FILTER,\r\nRT5645_CLK_SEL_I2S1_ASRC);\r\nif (!strcmp(codec_capture_dai, "rt5645-aif1")) {\r\nrt5645_sel_asrc_clk_src(codec,\r\nRT5645_AD_STEREO_FILTER,\r\nRT5645_CLK_SEL_I2S1_ASRC);\r\n} else if (!strcmp(codec_capture_dai, "rt5645-aif2")) {\r\nrt5645_sel_asrc_clk_src(codec,\r\nRT5645_AD_STEREO_FILTER,\r\nRT5645_CLK_SEL_I2S2_ASRC);\r\n} else {\r\ndev_warn(card->dev,\r\n"Only one dai codec found in DTS, enabled rt5645 AD filter\n");\r\nrt5645_sel_asrc_clk_src(codec,\r\nRT5645_AD_STEREO_FILTER,\r\nRT5645_CLK_SEL_I2S1_ASRC);\r\n}\r\nret = snd_soc_card_jack_new(card, "Headset Jack",\r\nSND_JACK_HEADPHONE | SND_JACK_MICROPHONE |\r\nSND_JACK_BTN_0 | SND_JACK_BTN_1 |\r\nSND_JACK_BTN_2 | SND_JACK_BTN_3,\r\n&mt8173_rt5650_jack, NULL, 0);\r\nif (ret) {\r\ndev_err(card->dev, "Can't new Headset Jack %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn rt5645_set_jack_detect(codec,\r\n&mt8173_rt5650_jack,\r\n&mt8173_rt5650_jack,\r\n&mt8173_rt5650_jack);\r\n}\r\nstatic int mt8173_rt5650_dev_probe(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = &mt8173_rt5650_card;\r\nstruct device_node *platform_node;\r\nstruct device_node *np;\r\nconst char *codec_capture_dai;\r\nint i, ret;\r\nplatform_node = of_parse_phandle(pdev->dev.of_node,\r\n"mediatek,platform", 0);\r\nif (!platform_node) {\r\ndev_err(&pdev->dev, "Property 'platform' missing or invalid\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < card->num_links; i++) {\r\nif (mt8173_rt5650_dais[i].platform_name)\r\ncontinue;\r\nmt8173_rt5650_dais[i].platform_of_node = platform_node;\r\n}\r\nmt8173_rt5650_codecs[0].of_node =\r\nof_parse_phandle(pdev->dev.of_node, "mediatek,audio-codec", 0);\r\nif (!mt8173_rt5650_codecs[0].of_node) {\r\ndev_err(&pdev->dev,\r\n"Property 'audio-codec' missing or invalid\n");\r\nreturn -EINVAL;\r\n}\r\nmt8173_rt5650_codecs[1].of_node = mt8173_rt5650_codecs[0].of_node;\r\nif (of_find_node_by_name(platform_node, "codec-capture")) {\r\nnp = of_get_child_by_name(pdev->dev.of_node, "codec-capture");\r\nif (!np) {\r\ndev_err(&pdev->dev,\r\n"%s: Can't find codec-capture DT node\n",\r\n__func__);\r\nreturn -EINVAL;\r\n}\r\nret = snd_soc_of_get_dai_name(np, &codec_capture_dai);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev,\r\n"%s codec_capture_dai name fail %d\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\nmt8173_rt5650_codecs[1].dai_name = codec_capture_dai;\r\n}\r\nif (device_property_present(&pdev->dev, "mediatek,mclk")) {\r\nret = device_property_read_u32(&pdev->dev,\r\n"mediatek,mclk",\r\n&mt8173_rt5650_priv.pll_from);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"%s snd_soc_register_card fail %d\n",\r\n__func__, ret);\r\n}\r\n}\r\nmt8173_rt5650_dais[DAI_LINK_HDMI_I2S].codec_of_node =\r\nof_parse_phandle(pdev->dev.of_node, "mediatek,audio-codec", 1);\r\nif (!mt8173_rt5650_dais[DAI_LINK_HDMI_I2S].codec_of_node) {\r\ndev_err(&pdev->dev,\r\n"Property 'audio-codec' missing or invalid\n");\r\nreturn -EINVAL;\r\n}\r\ncard->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, card);\r\nret = devm_snd_soc_register_card(&pdev->dev, card);\r\nif (ret)\r\ndev_err(&pdev->dev, "%s snd_soc_register_card fail %d\n",\r\n__func__, ret);\r\nreturn ret;\r\n}

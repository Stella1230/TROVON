static void flexcop_rcv_data_ctrl(struct flexcop_device *fc, int onoff)\r\n{\r\nflexcop_set_ibi_value(ctrl_208, Rcv_Data_sig, onoff);\r\ndeb_ts("rcv_data is now: '%s'\n", onoff ? "on" : "off");\r\n}\r\nvoid flexcop_smc_ctrl(struct flexcop_device *fc, int onoff)\r\n{\r\nflexcop_set_ibi_value(ctrl_208, SMC_Enable_sig, onoff);\r\n}\r\nstatic void flexcop_null_filter_ctrl(struct flexcop_device *fc, int onoff)\r\n{\r\nflexcop_set_ibi_value(ctrl_208, Null_filter_sig, onoff);\r\n}\r\nvoid flexcop_set_mac_filter(struct flexcop_device *fc, u8 mac[6])\r\n{\r\nflexcop_ibi_value v418, v41c;\r\nv41c = fc->read_ibi_reg(fc, mac_address_41c);\r\nv418.mac_address_418.MAC1 = mac[0];\r\nv418.mac_address_418.MAC2 = mac[1];\r\nv418.mac_address_418.MAC3 = mac[2];\r\nv418.mac_address_418.MAC6 = mac[3];\r\nv41c.mac_address_41c.MAC7 = mac[4];\r\nv41c.mac_address_41c.MAC8 = mac[5];\r\nfc->write_ibi_reg(fc, mac_address_418, v418);\r\nfc->write_ibi_reg(fc, mac_address_41c, v41c);\r\n}\r\nvoid flexcop_mac_filter_ctrl(struct flexcop_device *fc, int onoff)\r\n{\r\nflexcop_set_ibi_value(ctrl_208, MAC_filter_Mode_sig, onoff);\r\n}\r\nstatic void flexcop_pid_group_filter(struct flexcop_device *fc,\r\nu16 pid, u16 mask)\r\n{\r\nflexcop_ibi_value v30c;\r\nv30c.pid_filter_30c_ext_ind_0_7.Group_PID = pid;\r\nv30c.pid_filter_30c_ext_ind_0_7.Group_mask = mask;\r\nfc->write_ibi_reg(fc, pid_filter_30c, v30c);\r\n}\r\nstatic void flexcop_pid_group_filter_ctrl(struct flexcop_device *fc, int onoff)\r\n{\r\nflexcop_set_ibi_value(ctrl_208, Mask_filter_sig, onoff);\r\n}\r\nstatic void flexcop_pid_Stream1_PID_ctrl(struct flexcop_device *fc,\r\nu16 pid, int onoff)\r\n{\r\npid_ctrl(pid_filter_300, Stream1_PID, Stream1_filter_sig,\r\nStream1_trans, 0);\r\n}\r\nstatic void flexcop_pid_Stream2_PID_ctrl(struct flexcop_device *fc,\r\nu16 pid, int onoff)\r\n{\r\npid_ctrl(pid_filter_300, Stream2_PID, Stream2_filter_sig,\r\nStream2_trans, 0);\r\n}\r\nstatic void flexcop_pid_PCR_PID_ctrl(struct flexcop_device *fc,\r\nu16 pid, int onoff)\r\n{\r\npid_ctrl(pid_filter_304, PCR_PID, PCR_filter_sig, PCR_trans, 0);\r\n}\r\nstatic void flexcop_pid_PMT_PID_ctrl(struct flexcop_device *fc,\r\nu16 pid, int onoff)\r\n{\r\npid_ctrl(pid_filter_304, PMT_PID, PMT_filter_sig, PMT_trans, 0);\r\n}\r\nstatic void flexcop_pid_EMM_PID_ctrl(struct flexcop_device *fc,\r\nu16 pid, int onoff)\r\n{\r\npid_ctrl(pid_filter_308, EMM_PID, EMM_filter_sig, EMM_trans, 0);\r\n}\r\nstatic void flexcop_pid_ECM_PID_ctrl(struct flexcop_device *fc,\r\nu16 pid, int onoff)\r\n{\r\npid_ctrl(pid_filter_308, ECM_PID, ECM_filter_sig, ECM_trans, 0);\r\n}\r\nstatic void flexcop_pid_control(struct flexcop_device *fc,\r\nint index, u16 pid, int onoff)\r\n{\r\nif (pid == 0x2000)\r\nreturn;\r\ndeb_ts("setting pid: %5d %04x at index %d '%s'\n",\r\npid, pid, index, onoff ? "on" : "off");\r\nif (fc->skip_6_hw_pid_filter)\r\nindex += 6;\r\nswitch (index) {\r\ncase 0:\r\nflexcop_pid_Stream1_PID_ctrl(fc, pid, onoff);\r\nbreak;\r\ncase 1:\r\nflexcop_pid_Stream2_PID_ctrl(fc, pid, onoff);\r\nbreak;\r\ncase 2:\r\nflexcop_pid_PCR_PID_ctrl(fc, pid, onoff);\r\nbreak;\r\ncase 3:\r\nflexcop_pid_PMT_PID_ctrl(fc, pid, onoff);\r\nbreak;\r\ncase 4:\r\nflexcop_pid_EMM_PID_ctrl(fc, pid, onoff);\r\nbreak;\r\ncase 5:\r\nflexcop_pid_ECM_PID_ctrl(fc, pid, onoff);\r\nbreak;\r\ndefault:\r\nif (fc->has_32_hw_pid_filter && index < 38) {\r\nflexcop_ibi_value vpid, vid;\r\nvid = fc->read_ibi_reg(fc, index_reg_310);\r\nvid.index_reg_310.index_reg = index - 6;\r\nfc->write_ibi_reg(fc, index_reg_310, vid);\r\nvpid = fc->read_ibi_reg(fc, pid_n_reg_314);\r\nvpid.pid_n_reg_314.PID = onoff ? pid : 0x1fff;\r\nvpid.pid_n_reg_314.PID_enable_bit = onoff;\r\nfc->write_ibi_reg(fc, pid_n_reg_314, vpid);\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic int flexcop_toggle_fullts_streaming(struct flexcop_device *fc, int onoff)\r\n{\r\nif (fc->fullts_streaming_state != onoff) {\r\ndeb_ts("%s full TS transfer\n",onoff ? "enabling" : "disabling");\r\nflexcop_pid_group_filter(fc, 0, 0x1fe0 * (!onoff));\r\nflexcop_pid_group_filter_ctrl(fc, onoff);\r\nfc->fullts_streaming_state = onoff;\r\n}\r\nreturn 0;\r\n}\r\nint flexcop_pid_feed_control(struct flexcop_device *fc,\r\nstruct dvb_demux_feed *dvbdmxfeed, int onoff)\r\n{\r\nint max_pid_filter = 6;\r\nmax_pid_filter -= 6 * fc->skip_6_hw_pid_filter;\r\nmax_pid_filter += 32 * fc->has_32_hw_pid_filter;\r\nfc->feedcount += onoff ? 1 : -1;\r\nif (dvbdmxfeed->index >= max_pid_filter)\r\nfc->extra_feedcount += onoff ? 1 : -1;\r\nif (!fc->pid_filtering && fc->feedcount == onoff)\r\nflexcop_toggle_fullts_streaming(fc, onoff);\r\nif (fc->pid_filtering) {\r\nflexcop_pid_control \\r\n(fc, dvbdmxfeed->index, dvbdmxfeed->pid, onoff);\r\nif (fc->extra_feedcount > 0)\r\nflexcop_toggle_fullts_streaming(fc, 1);\r\nelse if (dvbdmxfeed->pid == 0x2000)\r\nflexcop_toggle_fullts_streaming(fc, onoff);\r\nelse\r\nflexcop_toggle_fullts_streaming(fc, 0);\r\n}\r\nif (fc->feedcount == onoff) {\r\nflexcop_rcv_data_ctrl(fc, onoff);\r\nif (fc->stream_control)\r\nfc->stream_control(fc, onoff);\r\nif (onoff == 0) {\r\nflexcop_reset_block_300(fc);\r\nflexcop_hw_filter_init(fc);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid flexcop_hw_filter_init(struct flexcop_device *fc)\r\n{\r\nint i;\r\nflexcop_ibi_value v;\r\nint max_pid_filter = 6;\r\nmax_pid_filter -= 6 * fc->skip_6_hw_pid_filter;\r\nmax_pid_filter += 32 * fc->has_32_hw_pid_filter;\r\nfor (i = 0; i < max_pid_filter; i++)\r\nflexcop_pid_control(fc, i, 0x1fff, 0);\r\nflexcop_pid_group_filter(fc, 0, 0x1fe0);\r\nflexcop_pid_group_filter_ctrl(fc, 0);\r\nv = fc->read_ibi_reg(fc, pid_filter_308);\r\nv.pid_filter_308.EMM_filter_4 = 1;\r\nv.pid_filter_308.EMM_filter_6 = 0;\r\nfc->write_ibi_reg(fc, pid_filter_308, v);\r\nflexcop_null_filter_ctrl(fc, 1);\r\n}

void mips_install_watch_registers(struct task_struct *t)\r\n{\r\nstruct mips3264_watch_reg_state *watches = &t->thread.watch.mips3264;\r\nswitch (current_cpu_data.watch_reg_use_cnt) {\r\ndefault:\r\nBUG();\r\ncase 4:\r\nwrite_c0_watchlo3(watches->watchlo[3]);\r\nwrite_c0_watchhi3(MIPS_WATCHHI_G | MIPS_WATCHHI_IRW |\r\nwatches->watchhi[3]);\r\ncase 3:\r\nwrite_c0_watchlo2(watches->watchlo[2]);\r\nwrite_c0_watchhi2(MIPS_WATCHHI_G | MIPS_WATCHHI_IRW |\r\nwatches->watchhi[2]);\r\ncase 2:\r\nwrite_c0_watchlo1(watches->watchlo[1]);\r\nwrite_c0_watchhi1(MIPS_WATCHHI_G | MIPS_WATCHHI_IRW |\r\nwatches->watchhi[1]);\r\ncase 1:\r\nwrite_c0_watchlo0(watches->watchlo[0]);\r\nwrite_c0_watchhi0(MIPS_WATCHHI_G | MIPS_WATCHHI_IRW |\r\nwatches->watchhi[0]);\r\n}\r\n}\r\nvoid mips_read_watch_registers(void)\r\n{\r\nstruct mips3264_watch_reg_state *watches =\r\n&current->thread.watch.mips3264;\r\nswitch (current_cpu_data.watch_reg_use_cnt) {\r\ndefault:\r\nBUG();\r\ncase 4:\r\nwatches->watchhi[3] = (read_c0_watchhi3() &\r\n(MIPS_WATCHHI_MASK | MIPS_WATCHHI_IRW));\r\ncase 3:\r\nwatches->watchhi[2] = (read_c0_watchhi2() &\r\n(MIPS_WATCHHI_MASK | MIPS_WATCHHI_IRW));\r\ncase 2:\r\nwatches->watchhi[1] = (read_c0_watchhi1() &\r\n(MIPS_WATCHHI_MASK | MIPS_WATCHHI_IRW));\r\ncase 1:\r\nwatches->watchhi[0] = (read_c0_watchhi0() &\r\n(MIPS_WATCHHI_MASK | MIPS_WATCHHI_IRW));\r\n}\r\nif (current_cpu_data.watch_reg_use_cnt == 1 &&\r\n(watches->watchhi[0] & MIPS_WATCHHI_IRW) == 0) {\r\nwatches->watchhi[0] |= (watches->watchlo[0] & MIPS_WATCHHI_IRW);\r\n}\r\n}\r\nvoid mips_clear_watch_registers(void)\r\n{\r\nswitch (current_cpu_data.watch_reg_count) {\r\ndefault:\r\nBUG();\r\ncase 8:\r\nwrite_c0_watchlo7(0);\r\ncase 7:\r\nwrite_c0_watchlo6(0);\r\ncase 6:\r\nwrite_c0_watchlo5(0);\r\ncase 5:\r\nwrite_c0_watchlo4(0);\r\ncase 4:\r\nwrite_c0_watchlo3(0);\r\ncase 3:\r\nwrite_c0_watchlo2(0);\r\ncase 2:\r\nwrite_c0_watchlo1(0);\r\ncase 1:\r\nwrite_c0_watchlo0(0);\r\n}\r\n}\r\nvoid mips_probe_watch_registers(struct cpuinfo_mips *c)\r\n{\r\nunsigned int t;\r\nif ((c->options & MIPS_CPU_WATCH) == 0)\r\nreturn;\r\nwrite_c0_watchlo0(MIPS_WATCHLO_IRW);\r\nback_to_back_c0_hazard();\r\nt = read_c0_watchlo0();\r\nwrite_c0_watchlo0(0);\r\nc->watch_reg_masks[0] = t & MIPS_WATCHLO_IRW;\r\nc->watch_reg_count = 1;\r\nc->watch_reg_use_cnt = 1;\r\nt = read_c0_watchhi0();\r\nwrite_c0_watchhi0(t | MIPS_WATCHHI_MASK);\r\nback_to_back_c0_hazard();\r\nt = read_c0_watchhi0();\r\nc->watch_reg_masks[0] |= (t & MIPS_WATCHHI_MASK);\r\nif ((t & MIPS_WATCHHI_M) == 0)\r\nreturn;\r\nwrite_c0_watchlo1(MIPS_WATCHLO_IRW);\r\nback_to_back_c0_hazard();\r\nt = read_c0_watchlo1();\r\nwrite_c0_watchlo1(0);\r\nc->watch_reg_masks[1] = t & MIPS_WATCHLO_IRW;\r\nc->watch_reg_count = 2;\r\nc->watch_reg_use_cnt = 2;\r\nt = read_c0_watchhi1();\r\nwrite_c0_watchhi1(t | MIPS_WATCHHI_MASK);\r\nback_to_back_c0_hazard();\r\nt = read_c0_watchhi1();\r\nc->watch_reg_masks[1] |= (t & MIPS_WATCHHI_MASK);\r\nif ((t & MIPS_WATCHHI_M) == 0)\r\nreturn;\r\nwrite_c0_watchlo2(MIPS_WATCHLO_IRW);\r\nback_to_back_c0_hazard();\r\nt = read_c0_watchlo2();\r\nwrite_c0_watchlo2(0);\r\nc->watch_reg_masks[2] = t & MIPS_WATCHLO_IRW;\r\nc->watch_reg_count = 3;\r\nc->watch_reg_use_cnt = 3;\r\nt = read_c0_watchhi2();\r\nwrite_c0_watchhi2(t | MIPS_WATCHHI_MASK);\r\nback_to_back_c0_hazard();\r\nt = read_c0_watchhi2();\r\nc->watch_reg_masks[2] |= (t & MIPS_WATCHHI_MASK);\r\nif ((t & MIPS_WATCHHI_M) == 0)\r\nreturn;\r\nwrite_c0_watchlo3(MIPS_WATCHLO_IRW);\r\nback_to_back_c0_hazard();\r\nt = read_c0_watchlo3();\r\nwrite_c0_watchlo3(0);\r\nc->watch_reg_masks[3] = t & MIPS_WATCHLO_IRW;\r\nc->watch_reg_count = 4;\r\nc->watch_reg_use_cnt = 4;\r\nt = read_c0_watchhi3();\r\nwrite_c0_watchhi3(t | MIPS_WATCHHI_MASK);\r\nback_to_back_c0_hazard();\r\nt = read_c0_watchhi3();\r\nc->watch_reg_masks[3] |= (t & MIPS_WATCHHI_MASK);\r\nif ((t & MIPS_WATCHHI_M) == 0)\r\nreturn;\r\nc->watch_reg_count = 5;\r\nt = read_c0_watchhi4();\r\nif ((t & MIPS_WATCHHI_M) == 0)\r\nreturn;\r\nc->watch_reg_count = 6;\r\nt = read_c0_watchhi5();\r\nif ((t & MIPS_WATCHHI_M) == 0)\r\nreturn;\r\nc->watch_reg_count = 7;\r\nt = read_c0_watchhi6();\r\nif ((t & MIPS_WATCHHI_M) == 0)\r\nreturn;\r\nc->watch_reg_count = 8;\r\n}

void dvb_ringbuffer_init(struct dvb_ringbuffer *rbuf, void *data, size_t len)\r\n{\r\nrbuf->pread=rbuf->pwrite=0;\r\nrbuf->data=data;\r\nrbuf->size=len;\r\nrbuf->error=0;\r\ninit_waitqueue_head(&rbuf->queue);\r\nspin_lock_init(&(rbuf->lock));\r\n}\r\nint dvb_ringbuffer_empty(struct dvb_ringbuffer *rbuf)\r\n{\r\nreturn (rbuf->pread == smp_load_acquire(&rbuf->pwrite));\r\n}\r\nssize_t dvb_ringbuffer_free(struct dvb_ringbuffer *rbuf)\r\n{\r\nssize_t free;\r\nfree = ACCESS_ONCE(rbuf->pread) - rbuf->pwrite;\r\nif (free <= 0)\r\nfree += rbuf->size;\r\nreturn free-1;\r\n}\r\nssize_t dvb_ringbuffer_avail(struct dvb_ringbuffer *rbuf)\r\n{\r\nssize_t avail;\r\navail = smp_load_acquire(&rbuf->pwrite) - rbuf->pread;\r\nif (avail < 0)\r\navail += rbuf->size;\r\nreturn avail;\r\n}\r\nvoid dvb_ringbuffer_flush(struct dvb_ringbuffer *rbuf)\r\n{\r\nsmp_store_release(&rbuf->pread, smp_load_acquire(&rbuf->pwrite));\r\nrbuf->error = 0;\r\n}\r\nvoid dvb_ringbuffer_reset(struct dvb_ringbuffer *rbuf)\r\n{\r\nsmp_store_release(&rbuf->pread, 0);\r\nsmp_store_release(&rbuf->pwrite, 0);\r\nrbuf->error = 0;\r\n}\r\nvoid dvb_ringbuffer_flush_spinlock_wakeup(struct dvb_ringbuffer *rbuf)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&rbuf->lock, flags);\r\ndvb_ringbuffer_flush(rbuf);\r\nspin_unlock_irqrestore(&rbuf->lock, flags);\r\nwake_up(&rbuf->queue);\r\n}\r\nssize_t dvb_ringbuffer_read_user(struct dvb_ringbuffer *rbuf, u8 __user *buf, size_t len)\r\n{\r\nsize_t todo = len;\r\nsize_t split;\r\nsplit = (rbuf->pread + len > rbuf->size) ? rbuf->size - rbuf->pread : 0;\r\nif (split > 0) {\r\nif (copy_to_user(buf, rbuf->data+rbuf->pread, split))\r\nreturn -EFAULT;\r\nbuf += split;\r\ntodo -= split;\r\nsmp_store_release(&rbuf->pread, 0);\r\n}\r\nif (copy_to_user(buf, rbuf->data+rbuf->pread, todo))\r\nreturn -EFAULT;\r\nsmp_store_release(&rbuf->pread, (rbuf->pread + todo) % rbuf->size);\r\nreturn len;\r\n}\r\nvoid dvb_ringbuffer_read(struct dvb_ringbuffer *rbuf, u8 *buf, size_t len)\r\n{\r\nsize_t todo = len;\r\nsize_t split;\r\nsplit = (rbuf->pread + len > rbuf->size) ? rbuf->size - rbuf->pread : 0;\r\nif (split > 0) {\r\nmemcpy(buf, rbuf->data+rbuf->pread, split);\r\nbuf += split;\r\ntodo -= split;\r\nsmp_store_release(&rbuf->pread, 0);\r\n}\r\nmemcpy(buf, rbuf->data+rbuf->pread, todo);\r\nsmp_store_release(&rbuf->pread, (rbuf->pread + todo) % rbuf->size);\r\n}\r\nssize_t dvb_ringbuffer_write(struct dvb_ringbuffer *rbuf, const u8 *buf, size_t len)\r\n{\r\nsize_t todo = len;\r\nsize_t split;\r\nsplit = (rbuf->pwrite + len > rbuf->size) ? rbuf->size - rbuf->pwrite : 0;\r\nif (split > 0) {\r\nmemcpy(rbuf->data+rbuf->pwrite, buf, split);\r\nbuf += split;\r\ntodo -= split;\r\nsmp_store_release(&rbuf->pwrite, 0);\r\n}\r\nmemcpy(rbuf->data+rbuf->pwrite, buf, todo);\r\nsmp_store_release(&rbuf->pwrite, (rbuf->pwrite + todo) % rbuf->size);\r\nreturn len;\r\n}\r\nssize_t dvb_ringbuffer_write_user(struct dvb_ringbuffer *rbuf,\r\nconst u8 __user *buf, size_t len)\r\n{\r\nint status;\r\nsize_t todo = len;\r\nsize_t split;\r\nsplit = (rbuf->pwrite + len > rbuf->size) ? rbuf->size - rbuf->pwrite : 0;\r\nif (split > 0) {\r\nstatus = copy_from_user(rbuf->data+rbuf->pwrite, buf, split);\r\nif (status)\r\nreturn len - todo;\r\nbuf += split;\r\ntodo -= split;\r\nsmp_store_release(&rbuf->pwrite, 0);\r\n}\r\nstatus = copy_from_user(rbuf->data+rbuf->pwrite, buf, todo);\r\nif (status)\r\nreturn len - todo;\r\nsmp_store_release(&rbuf->pwrite, (rbuf->pwrite + todo) % rbuf->size);\r\nreturn len;\r\n}\r\nssize_t dvb_ringbuffer_pkt_write(struct dvb_ringbuffer *rbuf, u8* buf, size_t len)\r\n{\r\nint status;\r\nssize_t oldpwrite = rbuf->pwrite;\r\nDVB_RINGBUFFER_WRITE_BYTE(rbuf, len >> 8);\r\nDVB_RINGBUFFER_WRITE_BYTE(rbuf, len & 0xff);\r\nDVB_RINGBUFFER_WRITE_BYTE(rbuf, PKT_READY);\r\nstatus = dvb_ringbuffer_write(rbuf, buf, len);\r\nif (status < 0) rbuf->pwrite = oldpwrite;\r\nreturn status;\r\n}\r\nssize_t dvb_ringbuffer_pkt_read_user(struct dvb_ringbuffer *rbuf, size_t idx,\r\nint offset, u8 __user *buf, size_t len)\r\n{\r\nsize_t todo;\r\nsize_t split;\r\nsize_t pktlen;\r\npktlen = rbuf->data[idx] << 8;\r\npktlen |= rbuf->data[(idx + 1) % rbuf->size];\r\nif (offset > pktlen) return -EINVAL;\r\nif ((offset + len) > pktlen) len = pktlen - offset;\r\nidx = (idx + DVB_RINGBUFFER_PKTHDRSIZE + offset) % rbuf->size;\r\ntodo = len;\r\nsplit = ((idx + len) > rbuf->size) ? rbuf->size - idx : 0;\r\nif (split > 0) {\r\nif (copy_to_user(buf, rbuf->data+idx, split))\r\nreturn -EFAULT;\r\nbuf += split;\r\ntodo -= split;\r\nidx = 0;\r\n}\r\nif (copy_to_user(buf, rbuf->data+idx, todo))\r\nreturn -EFAULT;\r\nreturn len;\r\n}\r\nssize_t dvb_ringbuffer_pkt_read(struct dvb_ringbuffer *rbuf, size_t idx,\r\nint offset, u8* buf, size_t len)\r\n{\r\nsize_t todo;\r\nsize_t split;\r\nsize_t pktlen;\r\npktlen = rbuf->data[idx] << 8;\r\npktlen |= rbuf->data[(idx + 1) % rbuf->size];\r\nif (offset > pktlen) return -EINVAL;\r\nif ((offset + len) > pktlen) len = pktlen - offset;\r\nidx = (idx + DVB_RINGBUFFER_PKTHDRSIZE + offset) % rbuf->size;\r\ntodo = len;\r\nsplit = ((idx + len) > rbuf->size) ? rbuf->size - idx : 0;\r\nif (split > 0) {\r\nmemcpy(buf, rbuf->data+idx, split);\r\nbuf += split;\r\ntodo -= split;\r\nidx = 0;\r\n}\r\nmemcpy(buf, rbuf->data+idx, todo);\r\nreturn len;\r\n}\r\nvoid dvb_ringbuffer_pkt_dispose(struct dvb_ringbuffer *rbuf, size_t idx)\r\n{\r\nsize_t pktlen;\r\nrbuf->data[(idx + 2) % rbuf->size] = PKT_DISPOSED;\r\nwhile(dvb_ringbuffer_avail(rbuf) > DVB_RINGBUFFER_PKTHDRSIZE) {\r\nif (DVB_RINGBUFFER_PEEK(rbuf, 2) == PKT_DISPOSED) {\r\npktlen = DVB_RINGBUFFER_PEEK(rbuf, 0) << 8;\r\npktlen |= DVB_RINGBUFFER_PEEK(rbuf, 1);\r\nDVB_RINGBUFFER_SKIP(rbuf, pktlen + DVB_RINGBUFFER_PKTHDRSIZE);\r\n} else {\r\nbreak;\r\n}\r\n}\r\n}\r\nssize_t dvb_ringbuffer_pkt_next(struct dvb_ringbuffer *rbuf, size_t idx, size_t* pktlen)\r\n{\r\nint consumed;\r\nint curpktlen;\r\nint curpktstatus;\r\nif (idx == -1) {\r\nidx = rbuf->pread;\r\n} else {\r\ncurpktlen = rbuf->data[idx] << 8;\r\ncurpktlen |= rbuf->data[(idx + 1) % rbuf->size];\r\nidx = (idx + curpktlen + DVB_RINGBUFFER_PKTHDRSIZE) % rbuf->size;\r\n}\r\nconsumed = (idx - rbuf->pread) % rbuf->size;\r\nwhile((dvb_ringbuffer_avail(rbuf) - consumed) > DVB_RINGBUFFER_PKTHDRSIZE) {\r\ncurpktlen = rbuf->data[idx] << 8;\r\ncurpktlen |= rbuf->data[(idx + 1) % rbuf->size];\r\ncurpktstatus = rbuf->data[(idx + 2) % rbuf->size];\r\nif (curpktstatus == PKT_READY) {\r\n*pktlen = curpktlen;\r\nreturn idx;\r\n}\r\nconsumed += curpktlen + DVB_RINGBUFFER_PKTHDRSIZE;\r\nidx = (idx + curpktlen + DVB_RINGBUFFER_PKTHDRSIZE) % rbuf->size;\r\n}\r\nreturn -1;\r\n}

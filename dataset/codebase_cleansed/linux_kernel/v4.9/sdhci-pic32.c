static unsigned int pic32_sdhci_get_max_clock(struct sdhci_host *host)\r\n{\r\nstruct pic32_sdhci_priv *sdhci_pdata = sdhci_priv(host);\r\nreturn clk_get_rate(sdhci_pdata->base_clk);\r\n}\r\nstatic void pic32_sdhci_set_bus_width(struct sdhci_host *host, int width)\r\n{\r\nu8 ctrl;\r\nctrl = sdhci_readb(host, SDHCI_HOST_CONTROL);\r\nif (width == MMC_BUS_WIDTH_8) {\r\nctrl &= ~SDHCI_CTRL_4BITBUS;\r\nif (host->version >= SDHCI_SPEC_300)\r\nctrl |= SDHCI_CTRL_8BITBUS;\r\n} else {\r\nif (host->version >= SDHCI_SPEC_300)\r\nctrl &= ~SDHCI_CTRL_8BITBUS;\r\nif (width == MMC_BUS_WIDTH_4)\r\nctrl |= SDHCI_CTRL_4BITBUS;\r\nelse\r\nctrl &= ~SDHCI_CTRL_4BITBUS;\r\n}\r\nctrl &= ~SDHCI_CTRL_CDTLVL;\r\nctrl |= SDHCI_CTRL_CDSSEL;\r\nsdhci_writeb(host, ctrl, SDHCI_HOST_CONTROL);\r\n}\r\nstatic unsigned int pic32_sdhci_get_ro(struct sdhci_host *host)\r\n{\r\nreturn 0;\r\n}\r\nstatic void pic32_sdhci_shared_bus(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nu32 bus = readl(host->ioaddr + SDH_SHARED_BUS_CTRL);\r\nu32 clk_pins = (bus & SDH_SHARED_BUS_NR_CLK_PINS_MASK) >> 0;\r\nu32 irq_pins = (bus & SDH_SHARED_BUS_NR_IRQ_PINS_MASK) >> 4;\r\nif (clk_pins & 1)\r\nbus |= (1 << SDH_SHARED_BUS_CLK_PINS);\r\nif (irq_pins & 1)\r\nbus |= (1 << SDH_SHARED_BUS_IRQ_PINS);\r\nwritel(bus, host->ioaddr + SDH_SHARED_BUS_CTRL);\r\n}\r\nstatic int pic32_sdhci_probe_platform(struct platform_device *pdev,\r\nstruct pic32_sdhci_priv *pdata)\r\n{\r\nint ret = 0;\r\nu32 caps_slot_type;\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nhost->caps = readl(host->ioaddr + SDHCI_CAPABILITIES);\r\ncaps_slot_type = (host->caps & SDH_CAPS_SDH_SLOT_TYPE_MASK) >> 30;\r\nif (caps_slot_type == SDH_SLOT_TYPE_SHARED_BUS)\r\npic32_sdhci_shared_bus(pdev);\r\nreturn ret;\r\n}\r\nstatic int pic32_sdhci_probe(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host;\r\nstruct sdhci_pltfm_host *pltfm_host;\r\nstruct pic32_sdhci_priv *sdhci_pdata;\r\nstruct pic32_sdhci_platform_data *plat_data;\r\nint ret;\r\nhost = sdhci_pltfm_init(pdev, &sdhci_pic32_pdata,\r\nsizeof(struct pic32_sdhci_priv));\r\nif (IS_ERR(host)) {\r\nret = PTR_ERR(host);\r\ngoto err;\r\n}\r\npltfm_host = sdhci_priv(host);\r\nsdhci_pdata = sdhci_pltfm_priv(pltfm_host);\r\nplat_data = pdev->dev.platform_data;\r\nif (plat_data && plat_data->setup_dma) {\r\nret = plat_data->setup_dma(ADMA_FIFO_RD_THSHLD,\r\nADMA_FIFO_WR_THSHLD);\r\nif (ret)\r\ngoto err_host;\r\n}\r\nsdhci_pdata->sys_clk = devm_clk_get(&pdev->dev, "sys_clk");\r\nif (IS_ERR(sdhci_pdata->sys_clk)) {\r\nret = PTR_ERR(sdhci_pdata->sys_clk);\r\ndev_err(&pdev->dev, "Error getting clock\n");\r\ngoto err_host;\r\n}\r\nret = clk_prepare_enable(sdhci_pdata->sys_clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Error enabling clock\n");\r\ngoto err_host;\r\n}\r\nsdhci_pdata->base_clk = devm_clk_get(&pdev->dev, "base_clk");\r\nif (IS_ERR(sdhci_pdata->base_clk)) {\r\nret = PTR_ERR(sdhci_pdata->base_clk);\r\ndev_err(&pdev->dev, "Error getting clock\n");\r\ngoto err_sys_clk;\r\n}\r\nret = clk_prepare_enable(sdhci_pdata->base_clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Error enabling clock\n");\r\ngoto err_base_clk;\r\n}\r\nret = mmc_of_parse(host->mmc);\r\nif (ret)\r\ngoto err_base_clk;\r\nret = pic32_sdhci_probe_platform(pdev, sdhci_pdata);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to probe platform!\n");\r\ngoto err_base_clk;\r\n}\r\nret = sdhci_add_host(host);\r\nif (ret) {\r\ndev_err(&pdev->dev, "error adding host\n");\r\ngoto err_base_clk;\r\n}\r\ndev_info(&pdev->dev, "Successfully added sdhci host\n");\r\nreturn 0;\r\nerr_base_clk:\r\nclk_disable_unprepare(sdhci_pdata->base_clk);\r\nerr_sys_clk:\r\nclk_disable_unprepare(sdhci_pdata->sys_clk);\r\nerr_host:\r\nsdhci_pltfm_free(pdev);\r\nerr:\r\ndev_err(&pdev->dev, "pic32-sdhci probe failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int pic32_sdhci_remove(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nstruct pic32_sdhci_priv *sdhci_pdata = sdhci_priv(host);\r\nu32 scratch;\r\nscratch = readl(host->ioaddr + SDHCI_INT_STATUS);\r\nsdhci_remove_host(host, scratch == (u32)~0);\r\nclk_disable_unprepare(sdhci_pdata->base_clk);\r\nclk_disable_unprepare(sdhci_pdata->sys_clk);\r\nsdhci_pltfm_free(pdev);\r\nreturn 0;\r\n}

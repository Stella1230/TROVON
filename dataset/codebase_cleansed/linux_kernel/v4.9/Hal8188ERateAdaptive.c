static void odm_SetTxRPTTiming_8188E(\r\nstruct odm_dm_struct *dm_odm,\r\nstruct odm_ra_info *pRaInfo,\r\nu8 extend\r\n)\r\n{\r\nu8 idx = 0;\r\nfor (idx = 0; idx < 5; idx++)\r\nif (DynamicTxRPTTiming[idx] == pRaInfo->RptTime)\r\nbreak;\r\nif (extend == 0) {\r\nidx = 0;\r\n} else if (extend == 1) {\r\nidx += 1;\r\nif (idx > 5)\r\nidx = 5;\r\n} else if (extend == 2) {\r\nif (idx != 0)\r\nidx -= 1;\r\n}\r\npRaInfo->RptTime = DynamicTxRPTTiming[idx];\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD,\r\n("pRaInfo->RptTime = 0x%x\n", pRaInfo->RptTime));\r\n}\r\nstatic int odm_RateDown_8188E(struct odm_dm_struct *dm_odm,\r\nstruct odm_ra_info *pRaInfo)\r\n{\r\nu8 RateID, LowestRate, HighestRate;\r\nu8 i;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE,\r\nODM_DBG_TRACE, ("=====>odm_RateDown_8188E()\n"));\r\nif (!pRaInfo) {\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD,\r\n("odm_RateDown_8188E(): pRaInfo is NULL\n"));\r\nreturn -1;\r\n}\r\nRateID = pRaInfo->PreRate;\r\nLowestRate = pRaInfo->LowestRate;\r\nHighestRate = pRaInfo->HighestRate;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE,\r\n(" RateID =%d LowestRate =%d HighestRate =%d RateSGI =%d\n",\r\nRateID, LowestRate, HighestRate, pRaInfo->RateSGI));\r\nif (RateID > HighestRate) {\r\nRateID = HighestRate;\r\n} else if (pRaInfo->RateSGI) {\r\npRaInfo->RateSGI = 0;\r\n} else if (RateID > LowestRate) {\r\nif (RateID > 0) {\r\nfor (i = RateID-1; i > LowestRate; i--) {\r\nif (pRaInfo->RAUseRate & BIT(i)) {\r\nRateID = i;\r\ngoto RateDownFinish;\r\n}\r\n}\r\n}\r\n} else if (RateID <= LowestRate) {\r\nRateID = LowestRate;\r\n}\r\nRateDownFinish:\r\nif (pRaInfo->RAWaitingCounter == 1) {\r\npRaInfo->RAWaitingCounter += 1;\r\npRaInfo->RAPendingCounter += 1;\r\n} else if (pRaInfo->RAWaitingCounter == 0) {\r\n;\r\n} else {\r\npRaInfo->RAWaitingCounter = 0;\r\npRaInfo->RAPendingCounter = 0;\r\n}\r\nif (pRaInfo->RAPendingCounter >= 4)\r\npRaInfo->RAPendingCounter = 4;\r\npRaInfo->DecisionRate = RateID;\r\nodm_SetTxRPTTiming_8188E(dm_odm, pRaInfo, 2);\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE,\r\nODM_DBG_LOUD, ("Rate down, RPT Timing default\n"));\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE,\r\n("RAWaitingCounter %d, RAPendingCounter %d",\r\npRaInfo->RAWaitingCounter, pRaInfo->RAPendingCounter));\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD,\r\n("Rate down to RateID %d RateSGI %d\n", RateID, pRaInfo->RateSGI));\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE,\r\n("<===== odm_RateDown_8188E()\n"));\r\nreturn 0;\r\n}\r\nstatic int odm_RateUp_8188E(\r\nstruct odm_dm_struct *dm_odm,\r\nstruct odm_ra_info *pRaInfo\r\n)\r\n{\r\nu8 RateID, HighestRate;\r\nu8 i;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE,\r\nODM_DBG_TRACE, ("=====>odm_RateUp_8188E()\n"));\r\nif (!pRaInfo) {\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD,\r\n("odm_RateUp_8188E(): pRaInfo is NULL\n"));\r\nreturn -1;\r\n}\r\nRateID = pRaInfo->PreRate;\r\nHighestRate = pRaInfo->HighestRate;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE,\r\n(" RateID =%d HighestRate =%d\n",\r\nRateID, HighestRate));\r\nif (pRaInfo->RAWaitingCounter == 1) {\r\npRaInfo->RAWaitingCounter = 0;\r\npRaInfo->RAPendingCounter = 0;\r\n} else if (pRaInfo->RAWaitingCounter > 1) {\r\npRaInfo->PreRssiStaRA = pRaInfo->RssiStaRA;\r\ngoto RateUpfinish;\r\n}\r\nodm_SetTxRPTTiming_8188E(dm_odm, pRaInfo, 0);\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD,\r\n("odm_RateUp_8188E():Decrease RPT Timing\n"));\r\nif (RateID < HighestRate) {\r\nfor (i = RateID+1; i <= HighestRate; i++) {\r\nif (pRaInfo->RAUseRate & BIT(i)) {\r\nRateID = i;\r\ngoto RateUpfinish;\r\n}\r\n}\r\n} else if (RateID == HighestRate) {\r\nif (pRaInfo->SGIEnable && (pRaInfo->RateSGI != 1))\r\npRaInfo->RateSGI = 1;\r\nelse if ((pRaInfo->SGIEnable) != 1)\r\npRaInfo->RateSGI = 0;\r\n} else {\r\nRateID = HighestRate;\r\n}\r\nRateUpfinish:\r\nif (pRaInfo->RAWaitingCounter ==\r\n(4+PendingForRateUpFail[pRaInfo->RAPendingCounter]))\r\npRaInfo->RAWaitingCounter = 0;\r\nelse\r\npRaInfo->RAWaitingCounter++;\r\npRaInfo->DecisionRate = RateID;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD,\r\n("Rate up to RateID %d\n", RateID));\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE,\r\n("RAWaitingCounter %d, RAPendingCounter %d",\r\npRaInfo->RAWaitingCounter, pRaInfo->RAPendingCounter));\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE,\r\nODM_DBG_TRACE, ("<===== odm_RateUp_8188E()\n"));\r\nreturn 0;\r\n}\r\nstatic void odm_ResetRaCounter_8188E(struct odm_ra_info *pRaInfo)\r\n{\r\nu8 RateID;\r\nRateID = pRaInfo->DecisionRate;\r\npRaInfo->NscUp = (N_THRESHOLD_HIGH[RateID]+N_THRESHOLD_LOW[RateID])>>1;\r\npRaInfo->NscDown = (N_THRESHOLD_HIGH[RateID]+N_THRESHOLD_LOW[RateID])>>1;\r\n}\r\nstatic void odm_RateDecision_8188E(struct odm_dm_struct *dm_odm,\r\nstruct odm_ra_info *pRaInfo\r\n)\r\n{\r\nu8 RateID = 0, RtyPtID = 0, PenaltyID1 = 0, PenaltyID2 = 0, i = 0;\r\nstatic u8 DynamicTxRPTTimingCounter;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE,\r\n("=====>odm_RateDecision_8188E()\n"));\r\nif (pRaInfo->Active && (pRaInfo->TOTAL > 0)) {\r\nif ((pRaInfo->RssiStaRA < (pRaInfo->PreRssiStaRA - 3)) ||\r\n(pRaInfo->RssiStaRA > (pRaInfo->PreRssiStaRA + 3))) {\r\npRaInfo->RAWaitingCounter = 0;\r\npRaInfo->RAPendingCounter = 0;\r\n}\r\nif (pRaInfo->PreRate > pRaInfo->HighestRate)\r\nRateID = pRaInfo->HighestRate;\r\nelse\r\nRateID = pRaInfo->PreRate;\r\nif (pRaInfo->RssiStaRA > RSSI_THRESHOLD[RateID])\r\nRtyPtID = 0;\r\nelse\r\nRtyPtID = 1;\r\nPenaltyID1 = RETRY_PENALTY_IDX[RtyPtID][RateID];\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE,\r\n(" NscDown init is %d\n", pRaInfo->NscDown));\r\nfor (i = 0 ; i <= 4 ; i++)\r\npRaInfo->NscDown += pRaInfo->RTY[i] * RETRY_PENALTY[PenaltyID1][i];\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE,\r\n(" NscDown is %d, total*penalty[5] is %d\n", pRaInfo->NscDown,\r\n(pRaInfo->TOTAL * RETRY_PENALTY[PenaltyID1][5])));\r\nif (pRaInfo->NscDown > (pRaInfo->TOTAL * RETRY_PENALTY[PenaltyID1][5]))\r\npRaInfo->NscDown -= pRaInfo->TOTAL * RETRY_PENALTY[PenaltyID1][5];\r\nelse\r\npRaInfo->NscDown = 0;\r\nPenaltyID2 = RETRY_PENALTY_UP_IDX[RateID];\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE,\r\n(" NscUp init is %d\n", pRaInfo->NscUp));\r\nfor (i = 0 ; i <= 4 ; i++)\r\npRaInfo->NscUp += pRaInfo->RTY[i] * RETRY_PENALTY[PenaltyID2][i];\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE,\r\n("NscUp is %d, total*up[5] is %d\n",\r\npRaInfo->NscUp, (pRaInfo->TOTAL * RETRY_PENALTY[PenaltyID2][5])));\r\nif (pRaInfo->NscUp > (pRaInfo->TOTAL * RETRY_PENALTY[PenaltyID2][5]))\r\npRaInfo->NscUp -= pRaInfo->TOTAL * RETRY_PENALTY[PenaltyID2][5];\r\nelse\r\npRaInfo->NscUp = 0;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE|ODM_COMP_INIT, ODM_DBG_LOUD,\r\n(" RssiStaRa = %d RtyPtID =%d PenaltyID1 = 0x%x PenaltyID2 = 0x%x RateID =%d NscDown =%d NscUp =%d SGI =%d\n",\r\npRaInfo->RssiStaRA, RtyPtID, PenaltyID1, PenaltyID2, RateID, pRaInfo->NscDown, pRaInfo->NscUp, pRaInfo->RateSGI));\r\nif ((pRaInfo->NscDown < N_THRESHOLD_LOW[RateID]) ||\r\n(pRaInfo->DROP > DROPING_NECESSARY[RateID]))\r\nodm_RateDown_8188E(dm_odm, pRaInfo);\r\nelse if (pRaInfo->NscUp > N_THRESHOLD_HIGH[RateID])\r\nodm_RateUp_8188E(dm_odm, pRaInfo);\r\nif (pRaInfo->DecisionRate > pRaInfo->HighestRate)\r\npRaInfo->DecisionRate = pRaInfo->HighestRate;\r\nif ((pRaInfo->DecisionRate) == (pRaInfo->PreRate))\r\nDynamicTxRPTTimingCounter += 1;\r\nelse\r\nDynamicTxRPTTimingCounter = 0;\r\nif (DynamicTxRPTTimingCounter >= 4) {\r\nodm_SetTxRPTTiming_8188E(dm_odm, pRaInfo, 1);\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE,\r\nODM_DBG_LOUD, ("<===== Rate don't change 4 times, Extend RPT Timing\n"));\r\nDynamicTxRPTTimingCounter = 0;\r\n}\r\npRaInfo->PreRate = pRaInfo->DecisionRate;\r\nodm_ResetRaCounter_8188E(pRaInfo);\r\n}\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE, ("<===== odm_RateDecision_8188E()\n"));\r\n}\r\nstatic int odm_ARFBRefresh_8188E(struct odm_dm_struct *dm_odm, struct odm_ra_info *pRaInfo)\r\n{\r\nstruct adapter *adapt = dm_odm->Adapter;\r\nu32 MaskFromReg;\r\ns8 i;\r\nswitch (pRaInfo->RateID) {\r\ncase RATR_INX_WIRELESS_NGB:\r\npRaInfo->RAUseRate = (pRaInfo->RateMask)&0x0f8ff015;\r\nbreak;\r\ncase RATR_INX_WIRELESS_NG:\r\npRaInfo->RAUseRate = (pRaInfo->RateMask)&0x0f8ff010;\r\nbreak;\r\ncase RATR_INX_WIRELESS_NB:\r\npRaInfo->RAUseRate = (pRaInfo->RateMask)&0x0f8ff005;\r\nbreak;\r\ncase RATR_INX_WIRELESS_N:\r\npRaInfo->RAUseRate = (pRaInfo->RateMask)&0x0f8ff000;\r\nbreak;\r\ncase RATR_INX_WIRELESS_GB:\r\npRaInfo->RAUseRate = (pRaInfo->RateMask)&0x00000ff5;\r\nbreak;\r\ncase RATR_INX_WIRELESS_G:\r\npRaInfo->RAUseRate = (pRaInfo->RateMask)&0x00000ff0;\r\nbreak;\r\ncase RATR_INX_WIRELESS_B:\r\npRaInfo->RAUseRate = (pRaInfo->RateMask)&0x0000000d;\r\nbreak;\r\ncase 12:\r\nMaskFromReg = usb_read32(adapt, REG_ARFR0);\r\npRaInfo->RAUseRate = (pRaInfo->RateMask)&MaskFromReg;\r\nbreak;\r\ncase 13:\r\nMaskFromReg = usb_read32(adapt, REG_ARFR1);\r\npRaInfo->RAUseRate = (pRaInfo->RateMask)&MaskFromReg;\r\nbreak;\r\ncase 14:\r\nMaskFromReg = usb_read32(adapt, REG_ARFR2);\r\npRaInfo->RAUseRate = (pRaInfo->RateMask)&MaskFromReg;\r\nbreak;\r\ncase 15:\r\nMaskFromReg = usb_read32(adapt, REG_ARFR3);\r\npRaInfo->RAUseRate = (pRaInfo->RateMask)&MaskFromReg;\r\nbreak;\r\ndefault:\r\npRaInfo->RAUseRate = (pRaInfo->RateMask);\r\nbreak;\r\n}\r\nif (pRaInfo->RAUseRate) {\r\nfor (i = RATESIZE; i >= 0; i--) {\r\nif ((pRaInfo->RAUseRate)&BIT(i)) {\r\npRaInfo->HighestRate = i;\r\nbreak;\r\n}\r\n}\r\n} else {\r\npRaInfo->HighestRate = 0;\r\n}\r\nif (pRaInfo->RAUseRate) {\r\nfor (i = 0; i < RATESIZE; i++) {\r\nif ((pRaInfo->RAUseRate) & BIT(i)) {\r\npRaInfo->LowestRate = i;\r\nbreak;\r\n}\r\n}\r\n} else {\r\npRaInfo->LowestRate = 0;\r\n}\r\nif (pRaInfo->HighestRate > 0x13)\r\npRaInfo->PTModeSS = 3;\r\nelse if (pRaInfo->HighestRate > 0x0b)\r\npRaInfo->PTModeSS = 2;\r\nelse if (pRaInfo->HighestRate > 0x0b)\r\npRaInfo->PTModeSS = 1;\r\nelse\r\npRaInfo->PTModeSS = 0;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD,\r\n("ODM_ARFBRefresh_8188E(): PTModeSS =%d\n", pRaInfo->PTModeSS));\r\nif (pRaInfo->DecisionRate > pRaInfo->HighestRate)\r\npRaInfo->DecisionRate = pRaInfo->HighestRate;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD,\r\n("ODM_ARFBRefresh_8188E(): RateID =%d RateMask =%8.8x RAUseRate =%8.8x HighestRate =%d, DecisionRate =%d\n",\r\npRaInfo->RateID, pRaInfo->RateMask, pRaInfo->RAUseRate, pRaInfo->HighestRate, pRaInfo->DecisionRate));\r\nreturn 0;\r\n}\r\nstatic void odm_PTTryState_8188E(struct odm_ra_info *pRaInfo)\r\n{\r\npRaInfo->PTTryState = 0;\r\nswitch (pRaInfo->PTModeSS) {\r\ncase 3:\r\nif (pRaInfo->DecisionRate >= 0x19)\r\npRaInfo->PTTryState = 1;\r\nbreak;\r\ncase 2:\r\nif (pRaInfo->DecisionRate >= 0x11)\r\npRaInfo->PTTryState = 1;\r\nbreak;\r\ncase 1:\r\nif (pRaInfo->DecisionRate >= 0x0a)\r\npRaInfo->PTTryState = 1;\r\nbreak;\r\ncase 0:\r\nif (pRaInfo->DecisionRate >= 0x03)\r\npRaInfo->PTTryState = 1;\r\nbreak;\r\ndefault:\r\npRaInfo->PTTryState = 0;\r\nbreak;\r\n}\r\nif (pRaInfo->RssiStaRA < 48) {\r\npRaInfo->PTStage = 0;\r\n} else if (pRaInfo->PTTryState == 1) {\r\nif ((pRaInfo->PTStopCount >= 10) ||\r\n(pRaInfo->PTPreRssi > pRaInfo->RssiStaRA + 5) ||\r\n(pRaInfo->PTPreRssi < pRaInfo->RssiStaRA - 5) ||\r\n(pRaInfo->DecisionRate != pRaInfo->PTPreRate)) {\r\nif (pRaInfo->PTStage == 0)\r\npRaInfo->PTStage = 1;\r\nelse if (pRaInfo->PTStage == 1)\r\npRaInfo->PTStage = 3;\r\nelse\r\npRaInfo->PTStage = 5;\r\npRaInfo->PTPreRssi = pRaInfo->RssiStaRA;\r\npRaInfo->PTStopCount = 0;\r\n} else {\r\npRaInfo->RAstage = 0;\r\npRaInfo->PTStopCount++;\r\n}\r\n} else {\r\npRaInfo->PTStage = 0;\r\npRaInfo->RAstage = 0;\r\n}\r\npRaInfo->PTPreRate = pRaInfo->DecisionRate;\r\n}\r\nstatic void odm_PTDecision_8188E(struct odm_ra_info *pRaInfo)\r\n{\r\nu8 j;\r\nu8 temp_stage;\r\nu32 numsc;\r\nu32 num_total;\r\nu8 stage_id;\r\nnumsc = 0;\r\nnum_total = pRaInfo->TOTAL * PT_PENALTY[5];\r\nfor (j = 0; j <= 4; j++) {\r\nnumsc += pRaInfo->RTY[j] * PT_PENALTY[j];\r\nif (numsc > num_total)\r\nbreak;\r\n}\r\nj >>= 1;\r\ntemp_stage = (pRaInfo->PTStage + 1) >> 1;\r\nif (temp_stage > j)\r\nstage_id = temp_stage-j;\r\nelse\r\nstage_id = 0;\r\npRaInfo->PTSmoothFactor = (pRaInfo->PTSmoothFactor>>1) + (pRaInfo->PTSmoothFactor>>2) + stage_id*16+2;\r\nif (pRaInfo->PTSmoothFactor > 192)\r\npRaInfo->PTSmoothFactor = 192;\r\nstage_id = pRaInfo->PTSmoothFactor >> 6;\r\ntemp_stage = stage_id*2;\r\nif (temp_stage != 0)\r\ntemp_stage -= 1;\r\nif (pRaInfo->DROP > 3)\r\ntemp_stage = 0;\r\npRaInfo->PTStage = temp_stage;\r\n}\r\nstatic void\r\nodm_RATxRPTTimerSetting(\r\nstruct odm_dm_struct *dm_odm,\r\nu16 minRptTime\r\n)\r\n{\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE, (" =====>odm_RATxRPTTimerSetting()\n"));\r\nif (dm_odm->CurrminRptTime != minRptTime) {\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD,\r\n(" CurrminRptTime = 0x%04x minRptTime = 0x%04x\n", dm_odm->CurrminRptTime, minRptTime));\r\nrtw_rpt_timer_cfg_cmd(dm_odm->Adapter, minRptTime);\r\ndm_odm->CurrminRptTime = minRptTime;\r\n}\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE, (" <===== odm_RATxRPTTimerSetting()\n"));\r\n}\r\nvoid\r\nODM_RASupport_Init(\r\nstruct odm_dm_struct *dm_odm\r\n)\r\n{\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD, ("=====>ODM_RASupport_Init()\n"));\r\ndm_odm->RaSupport88E = true;\r\n}\r\nint ODM_RAInfo_Init(struct odm_dm_struct *dm_odm, u8 macid)\r\n{\r\nstruct odm_ra_info *pRaInfo = &dm_odm->RAInfo[macid];\r\nu8 WirelessMode = 0xFF;\r\nu8 max_rate_idx = 0x13;\r\nif (dm_odm->pWirelessMode)\r\nWirelessMode = *(dm_odm->pWirelessMode);\r\nif (WirelessMode != 0xFF) {\r\nif (WirelessMode & ODM_WM_N24G)\r\nmax_rate_idx = 0x13;\r\nelse if (WirelessMode & ODM_WM_G)\r\nmax_rate_idx = 0x0b;\r\nelse if (WirelessMode & ODM_WM_B)\r\nmax_rate_idx = 0x03;\r\n}\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD,\r\n("ODM_RAInfo_Init(): WirelessMode:0x%08x , max_raid_idx:0x%02x\n",\r\nWirelessMode, max_rate_idx));\r\npRaInfo->DecisionRate = max_rate_idx;\r\npRaInfo->PreRate = max_rate_idx;\r\npRaInfo->HighestRate = max_rate_idx;\r\npRaInfo->LowestRate = 0;\r\npRaInfo->RateID = 0;\r\npRaInfo->RateMask = 0xffffffff;\r\npRaInfo->RssiStaRA = 0;\r\npRaInfo->PreRssiStaRA = 0;\r\npRaInfo->SGIEnable = 0;\r\npRaInfo->RAUseRate = 0xffffffff;\r\npRaInfo->NscDown = (N_THRESHOLD_HIGH[0x13]+N_THRESHOLD_LOW[0x13])/2;\r\npRaInfo->NscUp = (N_THRESHOLD_HIGH[0x13]+N_THRESHOLD_LOW[0x13])/2;\r\npRaInfo->RateSGI = 0;\r\npRaInfo->Active = 1;\r\npRaInfo->RptTime = 0x927c;\r\npRaInfo->DROP = 0;\r\npRaInfo->RTY[0] = 0;\r\npRaInfo->RTY[1] = 0;\r\npRaInfo->RTY[2] = 0;\r\npRaInfo->RTY[3] = 0;\r\npRaInfo->RTY[4] = 0;\r\npRaInfo->TOTAL = 0;\r\npRaInfo->RAWaitingCounter = 0;\r\npRaInfo->RAPendingCounter = 0;\r\npRaInfo->PTActive = 1;\r\npRaInfo->PTTryState = 0;\r\npRaInfo->PTStage = 5;\r\npRaInfo->PTSmoothFactor = 192;\r\npRaInfo->PTStopCount = 0;\r\npRaInfo->PTPreRate = 0;\r\npRaInfo->PTPreRssi = 0;\r\npRaInfo->PTModeSS = 0;\r\npRaInfo->RAstage = 0;\r\nreturn 0;\r\n}\r\nint ODM_RAInfo_Init_all(struct odm_dm_struct *dm_odm)\r\n{\r\nu8 macid = 0;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD, ("=====>\n"));\r\ndm_odm->CurrminRptTime = 0;\r\nfor (macid = 0; macid < ODM_ASSOCIATE_ENTRY_NUM; macid++)\r\nODM_RAInfo_Init(dm_odm, macid);\r\nreturn 0;\r\n}\r\nu8 ODM_RA_GetShortGI_8188E(struct odm_dm_struct *dm_odm, u8 macid)\r\n{\r\nif ((!dm_odm) || (macid >= ASSOCIATE_ENTRY_NUM))\r\nreturn 0;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE,\r\n("macid =%d SGI =%d\n", macid, dm_odm->RAInfo[macid].RateSGI));\r\nreturn dm_odm->RAInfo[macid].RateSGI;\r\n}\r\nu8 ODM_RA_GetDecisionRate_8188E(struct odm_dm_struct *dm_odm, u8 macid)\r\n{\r\nu8 DecisionRate = 0;\r\nif ((!dm_odm) || (macid >= ASSOCIATE_ENTRY_NUM))\r\nreturn 0;\r\nDecisionRate = dm_odm->RAInfo[macid].DecisionRate;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE,\r\n(" macid =%d DecisionRate = 0x%x\n", macid, DecisionRate));\r\nreturn DecisionRate;\r\n}\r\nu8 ODM_RA_GetHwPwrStatus_8188E(struct odm_dm_struct *dm_odm, u8 macid)\r\n{\r\nu8 PTStage = 5;\r\nif ((!dm_odm) || (macid >= ASSOCIATE_ENTRY_NUM))\r\nreturn 0;\r\nPTStage = dm_odm->RAInfo[macid].PTStage;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE,\r\n("macid =%d PTStage = 0x%x\n", macid, PTStage));\r\nreturn PTStage;\r\n}\r\nvoid ODM_RA_UpdateRateInfo_8188E(struct odm_dm_struct *dm_odm, u8 macid, u8 RateID, u32 RateMask, u8 SGIEnable)\r\n{\r\nstruct odm_ra_info *pRaInfo = NULL;\r\nif ((!dm_odm) || (macid >= ASSOCIATE_ENTRY_NUM))\r\nreturn;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD,\r\n("macid =%d RateID = 0x%x RateMask = 0x%x SGIEnable =%d\n",\r\nmacid, RateID, RateMask, SGIEnable));\r\npRaInfo = &(dm_odm->RAInfo[macid]);\r\npRaInfo->RateID = RateID;\r\npRaInfo->RateMask = RateMask;\r\npRaInfo->SGIEnable = SGIEnable;\r\nodm_ARFBRefresh_8188E(dm_odm, pRaInfo);\r\n}\r\nvoid ODM_RA_SetRSSI_8188E(struct odm_dm_struct *dm_odm, u8 macid, u8 Rssi)\r\n{\r\nstruct odm_ra_info *pRaInfo = NULL;\r\nif ((!dm_odm) || (macid >= ASSOCIATE_ENTRY_NUM))\r\nreturn;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_TRACE,\r\n(" macid =%d Rssi =%d\n", macid, Rssi));\r\npRaInfo = &(dm_odm->RAInfo[macid]);\r\npRaInfo->RssiStaRA = Rssi;\r\n}\r\nvoid ODM_RA_Set_TxRPT_Time(struct odm_dm_struct *dm_odm, u16 minRptTime)\r\n{\r\nstruct adapter *adapt = dm_odm->Adapter;\r\nusb_write16(adapt, REG_TX_RPT_TIME, minRptTime);\r\n}\r\nvoid ODM_RA_TxRPT2Handle_8188E(struct odm_dm_struct *dm_odm, u8 *TxRPT_Buf, u16 TxRPT_Len, u32 macid_entry0, u32 macid_entry1)\r\n{\r\nstruct odm_ra_info *pRAInfo = NULL;\r\nu8 MacId = 0;\r\nu8 *pBuffer = NULL;\r\nu32 valid = 0, ItemNum = 0;\r\nu16 minRptTime = 0x927c;\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD,\r\n("=====>ODM_RA_TxRPT2Handle_8188E(): valid0 =%d valid1 =%d BufferLength =%d\n",\r\nmacid_entry0, macid_entry1, TxRPT_Len));\r\nItemNum = TxRPT_Len >> 3;\r\npBuffer = TxRPT_Buf;\r\ndo {\r\nif (MacId >= ASSOCIATE_ENTRY_NUM)\r\nvalid = 0;\r\nelse if (MacId >= 32)\r\nvalid = (1 << (MacId - 32)) & macid_entry1;\r\nelse\r\nvalid = (1 << MacId) & macid_entry0;\r\npRAInfo = &(dm_odm->RAInfo[MacId]);\r\nif (valid) {\r\npRAInfo->RTY[0] = (u16)GET_TX_REPORT_TYPE1_RERTY_0(pBuffer);\r\npRAInfo->RTY[1] = (u16)GET_TX_REPORT_TYPE1_RERTY_1(pBuffer);\r\npRAInfo->RTY[2] = (u16)GET_TX_REPORT_TYPE1_RERTY_2(pBuffer);\r\npRAInfo->RTY[3] = (u16)GET_TX_REPORT_TYPE1_RERTY_3(pBuffer);\r\npRAInfo->RTY[4] = (u16)GET_TX_REPORT_TYPE1_RERTY_4(pBuffer);\r\npRAInfo->DROP = (u16)GET_TX_REPORT_TYPE1_DROP_0(pBuffer);\r\npRAInfo->TOTAL = pRAInfo->RTY[0] + pRAInfo->RTY[1] +\r\npRAInfo->RTY[2] + pRAInfo->RTY[3] +\r\npRAInfo->RTY[4] + pRAInfo->DROP;\r\nif (pRAInfo->TOTAL != 0) {\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD,\r\n("macid =%d Total =%d R0 =%d R1 =%d R2 =%d R3 =%d R4 =%d D0 =%d valid0 =%x valid1 =%x\n",\r\nMacId, pRAInfo->TOTAL,\r\npRAInfo->RTY[0], pRAInfo->RTY[1],\r\npRAInfo->RTY[2], pRAInfo->RTY[3],\r\npRAInfo->RTY[4], pRAInfo->DROP,\r\nmacid_entry0 , macid_entry1));\r\nif (pRAInfo->PTActive) {\r\nif (pRAInfo->RAstage < 5)\r\nodm_RateDecision_8188E(dm_odm, pRAInfo);\r\nelse if (pRAInfo->RAstage == 5)\r\nodm_PTTryState_8188E(pRAInfo);\r\nelse\r\nodm_PTDecision_8188E(pRAInfo);\r\nif (pRAInfo->RAstage <= 5)\r\npRAInfo->RAstage++;\r\nelse\r\npRAInfo->RAstage = 0;\r\n} else {\r\nodm_RateDecision_8188E(dm_odm, pRAInfo);\r\n}\r\nODM_RT_TRACE(dm_odm, ODM_COMP_INIT, ODM_DBG_LOUD,\r\n("macid =%d R0 =%d R1 =%d R2 =%d R3 =%d R4 =%d drop =%d valid0 =%x RateID =%d SGI =%d\n",\r\nMacId,\r\npRAInfo->RTY[0],\r\npRAInfo->RTY[1],\r\npRAInfo->RTY[2],\r\npRAInfo->RTY[3],\r\npRAInfo->RTY[4],\r\npRAInfo->DROP,\r\nmacid_entry0,\r\npRAInfo->DecisionRate,\r\npRAInfo->RateSGI));\r\n} else {\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD, (" TOTAL = 0!!!!\n"));\r\n}\r\n}\r\nif (minRptTime > pRAInfo->RptTime)\r\nminRptTime = pRAInfo->RptTime;\r\npBuffer += TX_RPT2_ITEM_SIZE;\r\nMacId++;\r\n} while (MacId < ItemNum);\r\nodm_RATxRPTTimerSetting(dm_odm, minRptTime);\r\nODM_RT_TRACE(dm_odm, ODM_COMP_RATE_ADAPTIVE, ODM_DBG_LOUD, ("<===== ODM_RA_TxRPT2Handle_8188E()\n"));\r\n}

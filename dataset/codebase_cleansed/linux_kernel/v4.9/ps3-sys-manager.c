static void __maybe_unused _dump_sm_header(\r\nconst struct ps3_sys_manager_header *h, const char *func, int line)\r\n{\r\npr_debug("%s:%d: version: %xh\n", func, line, h->version);\r\npr_debug("%s:%d: size: %xh\n", func, line, h->size);\r\npr_debug("%s:%d: payload_size: %xh\n", func, line, h->payload_size);\r\npr_debug("%s:%d: service_id: %xh\n", func, line, h->service_id);\r\npr_debug("%s:%d: request_tag: %xh\n", func, line, h->request_tag);\r\n}\r\nstatic int ps3_sys_manager_write(struct ps3_system_bus_device *dev,\r\nconst struct ps3_sys_manager_header *header, const void *payload)\r\n{\r\nint result;\r\nBUG_ON(header->version != 1);\r\nBUG_ON(header->size != 16);\r\nBUG_ON(header->payload_size != 8 && header->payload_size != 16);\r\nBUG_ON(header->service_id > 8);\r\nresult = ps3_vuart_write(dev, header,\r\nsizeof(struct ps3_sys_manager_header));\r\nif (!result)\r\nresult = ps3_vuart_write(dev, payload, header->payload_size);\r\nreturn result;\r\n}\r\nstatic int ps3_sys_manager_send_attr(struct ps3_system_bus_device *dev,\r\nenum ps3_sys_manager_attr attr)\r\n{\r\nstruct ps3_sys_manager_header header;\r\nstruct {\r\nu8 version;\r\nu8 reserved_1[3];\r\nu32 attribute;\r\n} payload;\r\nBUILD_BUG_ON(sizeof(payload) != 8);\r\ndev_dbg(&dev->core, "%s:%d: %xh\n", __func__, __LINE__, attr);\r\nmemset(&header, 0, sizeof(header));\r\nheader.version = 1;\r\nheader.size = 16;\r\nheader.payload_size = 16;\r\nheader.service_id = PS3_SM_SERVICE_ID_SET_ATTR;\r\nmemset(&payload, 0, sizeof(payload));\r\npayload.version = 1;\r\npayload.attribute = attr;\r\nreturn ps3_sys_manager_write(dev, &header, &payload);\r\n}\r\nstatic int ps3_sys_manager_send_next_op(struct ps3_system_bus_device *dev,\r\nenum ps3_sys_manager_next_op op,\r\nenum ps3_sys_manager_wake_source wake_source)\r\n{\r\nstruct ps3_sys_manager_header header;\r\nstruct {\r\nu8 version;\r\nu8 type;\r\nu8 gos_id;\r\nu8 reserved_1;\r\nu32 wake_source;\r\nu8 reserved_2[8];\r\n} payload;\r\nBUILD_BUG_ON(sizeof(payload) != 16);\r\ndev_dbg(&dev->core, "%s:%d: (%xh)\n", __func__, __LINE__, op);\r\nmemset(&header, 0, sizeof(header));\r\nheader.version = 1;\r\nheader.size = 16;\r\nheader.payload_size = 16;\r\nheader.service_id = PS3_SM_SERVICE_ID_SET_NEXT_OP;\r\nmemset(&payload, 0, sizeof(payload));\r\npayload.version = 3;\r\npayload.type = op;\r\npayload.gos_id = 3;\r\npayload.wake_source = wake_source;\r\nreturn ps3_sys_manager_write(dev, &header, &payload);\r\n}\r\nstatic int ps3_sys_manager_send_request_shutdown(\r\nstruct ps3_system_bus_device *dev)\r\n{\r\nstruct ps3_sys_manager_header header;\r\nstruct {\r\nu8 version;\r\nu8 type;\r\nu8 gos_id;\r\nu8 reserved_1[13];\r\n} payload;\r\nBUILD_BUG_ON(sizeof(payload) != 16);\r\ndev_dbg(&dev->core, "%s:%d\n", __func__, __LINE__);\r\nmemset(&header, 0, sizeof(header));\r\nheader.version = 1;\r\nheader.size = 16;\r\nheader.payload_size = 16;\r\nheader.service_id = PS3_SM_SERVICE_ID_REQUEST;\r\nmemset(&payload, 0, sizeof(payload));\r\npayload.version = 1;\r\npayload.type = 1;\r\npayload.gos_id = 0;\r\nreturn ps3_sys_manager_write(dev, &header, &payload);\r\n}\r\nstatic int ps3_sys_manager_send_response(struct ps3_system_bus_device *dev,\r\nu64 status)\r\n{\r\nstruct ps3_sys_manager_header header;\r\nstruct {\r\nu8 version;\r\nu8 reserved_1[3];\r\nu8 status;\r\nu8 reserved_2[11];\r\n} payload;\r\nBUILD_BUG_ON(sizeof(payload) != 16);\r\ndev_dbg(&dev->core, "%s:%d: (%s)\n", __func__, __LINE__,\r\n(status ? "nak" : "ack"));\r\nmemset(&header, 0, sizeof(header));\r\nheader.version = 1;\r\nheader.size = 16;\r\nheader.payload_size = 16;\r\nheader.service_id = PS3_SM_SERVICE_ID_RESPONSE;\r\nmemset(&payload, 0, sizeof(payload));\r\npayload.version = 1;\r\npayload.status = status;\r\nreturn ps3_sys_manager_write(dev, &header, &payload);\r\n}\r\nstatic int ps3_sys_manager_handle_event(struct ps3_system_bus_device *dev)\r\n{\r\nint result;\r\nstruct {\r\nu8 version;\r\nu8 type;\r\nu8 reserved_1[2];\r\nu32 value;\r\nu8 reserved_2[8];\r\n} event;\r\nBUILD_BUG_ON(sizeof(event) != 16);\r\nresult = ps3_vuart_read(dev, &event, sizeof(event));\r\nBUG_ON(result && "need to retry here");\r\nif (event.version != 1) {\r\ndev_dbg(&dev->core, "%s:%d: unsupported event version (%u)\n",\r\n__func__, __LINE__, event.version);\r\nreturn -EIO;\r\n}\r\nswitch (event.type) {\r\ncase PS3_SM_EVENT_POWER_PRESSED:\r\ndev_dbg(&dev->core, "%s:%d: POWER_PRESSED (%s)\n",\r\n__func__, __LINE__,\r\n(event.value == PS3_SM_BUTTON_EVENT_SOFT ? "soft"\r\n: "hard"));\r\nps3_sm_force_power_off = 1;\r\nwmb();\r\nkill_cad_pid(SIGINT, 1);\r\nbreak;\r\ncase PS3_SM_EVENT_POWER_RELEASED:\r\ndev_dbg(&dev->core, "%s:%d: POWER_RELEASED (%u ms)\n",\r\n__func__, __LINE__, event.value);\r\nbreak;\r\ncase PS3_SM_EVENT_RESET_PRESSED:\r\ndev_dbg(&dev->core, "%s:%d: RESET_PRESSED (%s)\n",\r\n__func__, __LINE__,\r\n(event.value == PS3_SM_BUTTON_EVENT_SOFT ? "soft"\r\n: "hard"));\r\nps3_sm_force_power_off = 0;\r\nwmb();\r\nkill_cad_pid(SIGINT, 1);\r\nbreak;\r\ncase PS3_SM_EVENT_RESET_RELEASED:\r\ndev_dbg(&dev->core, "%s:%d: RESET_RELEASED (%u ms)\n",\r\n__func__, __LINE__, event.value);\r\nbreak;\r\ncase PS3_SM_EVENT_THERMAL_ALERT:\r\ndev_dbg(&dev->core, "%s:%d: THERMAL_ALERT (zone %u)\n",\r\n__func__, __LINE__, event.value);\r\npr_info("PS3 Thermal Alert Zone %u\n", event.value);\r\nbreak;\r\ncase PS3_SM_EVENT_THERMAL_CLEARED:\r\ndev_dbg(&dev->core, "%s:%d: THERMAL_CLEARED (zone %u)\n",\r\n__func__, __LINE__, event.value);\r\nbreak;\r\ndefault:\r\ndev_dbg(&dev->core, "%s:%d: unknown event (%u)\n",\r\n__func__, __LINE__, event.type);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ps3_sys_manager_handle_cmd(struct ps3_system_bus_device *dev)\r\n{\r\nint result;\r\nstruct {\r\nu8 version;\r\nu8 type;\r\nu8 reserved_1[14];\r\n} cmd;\r\nBUILD_BUG_ON(sizeof(cmd) != 16);\r\ndev_dbg(&dev->core, "%s:%d\n", __func__, __LINE__);\r\nresult = ps3_vuart_read(dev, &cmd, sizeof(cmd));\r\nBUG_ON(result && "need to retry here");\r\nif (result)\r\nreturn result;\r\nif (cmd.version != 1) {\r\ndev_dbg(&dev->core, "%s:%d: unsupported cmd version (%u)\n",\r\n__func__, __LINE__, cmd.version);\r\nreturn -EIO;\r\n}\r\nif (cmd.type != PS3_SM_CMD_SHUTDOWN) {\r\ndev_dbg(&dev->core, "%s:%d: unknown cmd (%u)\n",\r\n__func__, __LINE__, cmd.type);\r\nreturn -EIO;\r\n}\r\nps3_sys_manager_send_response(dev, 0);\r\nreturn 0;\r\n}\r\nstatic int ps3_sys_manager_handle_msg(struct ps3_system_bus_device *dev)\r\n{\r\nint result;\r\nstruct ps3_sys_manager_header header;\r\nresult = ps3_vuart_read(dev, &header,\r\nsizeof(struct ps3_sys_manager_header));\r\nif (result)\r\nreturn result;\r\nif (header.version != 1) {\r\ndev_dbg(&dev->core, "%s:%d: unsupported header version (%u)\n",\r\n__func__, __LINE__, header.version);\r\ndump_sm_header(&header);\r\ngoto fail_header;\r\n}\r\nBUILD_BUG_ON(sizeof(header) != 16);\r\nif (header.size != 16 || (header.payload_size != 8\r\n&& header.payload_size != 16)) {\r\ndump_sm_header(&header);\r\nBUG();\r\n}\r\nswitch (header.service_id) {\r\ncase PS3_SM_SERVICE_ID_EXTERN_EVENT:\r\ndev_dbg(&dev->core, "%s:%d: EVENT\n", __func__, __LINE__);\r\nreturn ps3_sys_manager_handle_event(dev);\r\ncase PS3_SM_SERVICE_ID_COMMAND:\r\ndev_dbg(&dev->core, "%s:%d: COMMAND\n", __func__, __LINE__);\r\nreturn ps3_sys_manager_handle_cmd(dev);\r\ncase PS3_SM_SERVICE_ID_REQUEST_ERROR:\r\ndev_dbg(&dev->core, "%s:%d: REQUEST_ERROR\n", __func__,\r\n__LINE__);\r\ndump_sm_header(&header);\r\nbreak;\r\ndefault:\r\ndev_dbg(&dev->core, "%s:%d: unknown service_id (%u)\n",\r\n__func__, __LINE__, header.service_id);\r\nbreak;\r\n}\r\ngoto fail_id;\r\nfail_header:\r\nps3_vuart_clear_rx_bytes(dev, 0);\r\nreturn -EIO;\r\nfail_id:\r\nps3_vuart_clear_rx_bytes(dev, header.payload_size);\r\nreturn -EIO;\r\n}\r\nstatic void ps3_sys_manager_fin(struct ps3_system_bus_device *dev)\r\n{\r\nps3_sys_manager_send_request_shutdown(dev);\r\npr_emerg("System Halted, OK to turn off power\n");\r\nwhile (ps3_sys_manager_handle_msg(dev)) {\r\nlv1_pause(0);\r\n}\r\nwhile (1) {\r\nlv1_pause(1);\r\n}\r\n}\r\nstatic void ps3_sys_manager_final_power_off(struct ps3_system_bus_device *dev)\r\n{\r\nBUG_ON(!dev);\r\ndev_dbg(&dev->core, "%s:%d\n", __func__, __LINE__);\r\nps3_vuart_cancel_async(dev);\r\nps3_sys_manager_send_next_op(dev, PS3_SM_NEXT_OP_SYS_SHUTDOWN,\r\nuser_wake_sources);\r\nps3_sys_manager_fin(dev);\r\n}\r\nstatic void ps3_sys_manager_final_restart(struct ps3_system_bus_device *dev)\r\n{\r\nBUG_ON(!dev);\r\ndev_dbg(&dev->core, "%s:%d\n", __func__, __LINE__);\r\nif (ps3_sm_force_power_off) {\r\ndev_dbg(&dev->core, "%s:%d: forcing poweroff\n",\r\n__func__, __LINE__);\r\nps3_sys_manager_final_power_off(dev);\r\n}\r\nps3_vuart_cancel_async(dev);\r\nps3_sys_manager_send_attr(dev, 0);\r\nps3_sys_manager_send_next_op(dev, PS3_SM_NEXT_OP_SYS_REBOOT,\r\nuser_wake_sources);\r\nps3_sys_manager_fin(dev);\r\n}\r\nint ps3_sys_manager_get_wol(void)\r\n{\r\npr_debug("%s:%d\n", __func__, __LINE__);\r\nreturn (user_wake_sources & PS3_SM_WAKE_W_O_L) != 0;\r\n}\r\nvoid ps3_sys_manager_set_wol(int state)\r\n{\r\nstatic DEFINE_MUTEX(mutex);\r\nmutex_lock(&mutex);\r\npr_debug("%s:%d: %d\n", __func__, __LINE__, state);\r\nif (state)\r\nuser_wake_sources |= PS3_SM_WAKE_W_O_L;\r\nelse\r\nuser_wake_sources &= ~PS3_SM_WAKE_W_O_L;\r\nmutex_unlock(&mutex);\r\n}\r\nstatic void ps3_sys_manager_work(struct ps3_system_bus_device *dev)\r\n{\r\nps3_sys_manager_handle_msg(dev);\r\nps3_vuart_read_async(dev, PS3_SM_RX_MSG_LEN_MIN);\r\n}\r\nstatic int ps3_sys_manager_probe(struct ps3_system_bus_device *dev)\r\n{\r\nint result;\r\nstruct ps3_sys_manager_ops ops;\r\ndev_dbg(&dev->core, "%s:%d\n", __func__, __LINE__);\r\nops.power_off = ps3_sys_manager_final_power_off;\r\nops.restart = ps3_sys_manager_final_restart;\r\nops.dev = dev;\r\nps3_sys_manager_register_ops(&ops);\r\nresult = ps3_sys_manager_send_attr(dev, PS3_SM_ATTR_ALL);\r\nBUG_ON(result);\r\nresult = ps3_vuart_read_async(dev, PS3_SM_RX_MSG_LEN_MIN);\r\nBUG_ON(result);\r\nreturn result;\r\n}\r\nstatic int ps3_sys_manager_remove(struct ps3_system_bus_device *dev)\r\n{\r\ndev_dbg(&dev->core, "%s:%d\n", __func__, __LINE__);\r\nreturn 0;\r\n}\r\nstatic void ps3_sys_manager_shutdown(struct ps3_system_bus_device *dev)\r\n{\r\ndev_dbg(&dev->core, "%s:%d\n", __func__, __LINE__);\r\n}\r\nstatic int __init ps3_sys_manager_init(void)\r\n{\r\nif (!firmware_has_feature(FW_FEATURE_PS3_LV1))\r\nreturn -ENODEV;\r\nreturn ps3_vuart_port_driver_register(&ps3_sys_manager);\r\n}

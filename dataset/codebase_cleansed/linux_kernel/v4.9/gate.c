static int omap36xx_gate_clk_enable_with_hsdiv_restore(struct clk_hw *hw)\r\n{\r\nstruct clk_divider *parent;\r\nstruct clk_hw *parent_hw;\r\nu32 dummy_v, orig_v;\r\nint ret;\r\nret = omap2_dflt_clk_enable(hw);\r\nparent_hw = clk_hw_get_parent(clk_hw_get_parent(hw));\r\nparent = to_clk_divider(parent_hw);\r\nif (!ret) {\r\norig_v = ti_clk_ll_ops->clk_readl(parent->reg);\r\ndummy_v = orig_v;\r\ndummy_v ^= (1 << parent->shift);\r\nti_clk_ll_ops->clk_writel(dummy_v, parent->reg);\r\nti_clk_ll_ops->clk_writel(orig_v, parent->reg);\r\n}\r\nreturn ret;\r\n}\r\nstatic struct clk *_register_gate(struct device *dev, const char *name,\r\nconst char *parent_name, unsigned long flags,\r\nvoid __iomem *reg, u8 bit_idx,\r\nu8 clk_gate_flags, const struct clk_ops *ops,\r\nconst struct clk_hw_omap_ops *hw_ops)\r\n{\r\nstruct clk_init_data init = { NULL };\r\nstruct clk_hw_omap *clk_hw;\r\nstruct clk *clk;\r\nclk_hw = kzalloc(sizeof(*clk_hw), GFP_KERNEL);\r\nif (!clk_hw)\r\nreturn ERR_PTR(-ENOMEM);\r\nclk_hw->hw.init = &init;\r\ninit.name = name;\r\ninit.ops = ops;\r\nclk_hw->enable_reg = reg;\r\nclk_hw->enable_bit = bit_idx;\r\nclk_hw->ops = hw_ops;\r\nclk_hw->flags = MEMMAP_ADDRESSING | clk_gate_flags;\r\ninit.parent_names = &parent_name;\r\ninit.num_parents = 1;\r\ninit.flags = flags;\r\nclk = clk_register(NULL, &clk_hw->hw);\r\nif (IS_ERR(clk))\r\nkfree(clk_hw);\r\nreturn clk;\r\n}\r\nstruct clk *ti_clk_register_gate(struct ti_clk *setup)\r\n{\r\nconst struct clk_ops *ops = &omap_gate_clk_ops;\r\nconst struct clk_hw_omap_ops *hw_ops = NULL;\r\nu32 reg;\r\nstruct clk_omap_reg *reg_setup;\r\nu32 flags = 0;\r\nu8 clk_gate_flags = 0;\r\nstruct ti_clk_gate *gate;\r\ngate = setup->data;\r\nif (gate->flags & CLKF_INTERFACE)\r\nreturn ti_clk_register_interface(setup);\r\nreg_setup = (struct clk_omap_reg *)&reg;\r\nif (gate->flags & CLKF_SET_RATE_PARENT)\r\nflags |= CLK_SET_RATE_PARENT;\r\nif (gate->flags & CLKF_SET_BIT_TO_DISABLE)\r\nclk_gate_flags |= INVERT_ENABLE;\r\nif (gate->flags & CLKF_HSDIV) {\r\nops = &omap_gate_clk_hsdiv_restore_ops;\r\nhw_ops = &clkhwops_wait;\r\n}\r\nif (gate->flags & CLKF_DSS)\r\nhw_ops = &clkhwops_omap3430es2_dss_usbhost_wait;\r\nif (gate->flags & CLKF_WAIT)\r\nhw_ops = &clkhwops_wait;\r\nif (gate->flags & CLKF_CLKDM)\r\nops = &omap_gate_clkdm_clk_ops;\r\nif (gate->flags & CLKF_AM35XX)\r\nhw_ops = &clkhwops_am35xx_ipss_module_wait;\r\nreg_setup->index = gate->module;\r\nreg_setup->offset = gate->reg;\r\nreturn _register_gate(NULL, setup->name, gate->parent, flags,\r\n(void __iomem *)reg, gate->bit_shift,\r\nclk_gate_flags, ops, hw_ops);\r\n}\r\nstruct clk_hw *ti_clk_build_component_gate(struct ti_clk_gate *setup)\r\n{\r\nstruct clk_hw_omap *gate;\r\nstruct clk_omap_reg *reg;\r\nconst struct clk_hw_omap_ops *ops = &clkhwops_wait;\r\nif (!setup)\r\nreturn NULL;\r\ngate = kzalloc(sizeof(*gate), GFP_KERNEL);\r\nif (!gate)\r\nreturn ERR_PTR(-ENOMEM);\r\nreg = (struct clk_omap_reg *)&gate->enable_reg;\r\nreg->index = setup->module;\r\nreg->offset = setup->reg;\r\ngate->enable_bit = setup->bit_shift;\r\nif (setup->flags & CLKF_NO_WAIT)\r\nops = NULL;\r\nif (setup->flags & CLKF_INTERFACE)\r\nops = &clkhwops_iclk_wait;\r\ngate->ops = ops;\r\ngate->flags = MEMMAP_ADDRESSING;\r\nreturn &gate->hw;\r\n}\r\nstatic void __init _of_ti_gate_clk_setup(struct device_node *node,\r\nconst struct clk_ops *ops,\r\nconst struct clk_hw_omap_ops *hw_ops)\r\n{\r\nstruct clk *clk;\r\nconst char *parent_name;\r\nvoid __iomem *reg = NULL;\r\nu8 enable_bit = 0;\r\nu32 val;\r\nu32 flags = 0;\r\nu8 clk_gate_flags = 0;\r\nif (ops != &omap_gate_clkdm_clk_ops) {\r\nreg = ti_clk_get_reg_addr(node, 0);\r\nif (IS_ERR(reg))\r\nreturn;\r\nif (!of_property_read_u32(node, "ti,bit-shift", &val))\r\nenable_bit = val;\r\n}\r\nif (of_clk_get_parent_count(node) != 1) {\r\npr_err("%s must have 1 parent\n", node->name);\r\nreturn;\r\n}\r\nparent_name = of_clk_get_parent_name(node, 0);\r\nif (of_property_read_bool(node, "ti,set-rate-parent"))\r\nflags |= CLK_SET_RATE_PARENT;\r\nif (of_property_read_bool(node, "ti,set-bit-to-disable"))\r\nclk_gate_flags |= INVERT_ENABLE;\r\nclk = _register_gate(NULL, node->name, parent_name, flags, reg,\r\nenable_bit, clk_gate_flags, ops, hw_ops);\r\nif (!IS_ERR(clk))\r\nof_clk_add_provider(node, of_clk_src_simple_get, clk);\r\n}\r\nstatic void __init\r\n_of_ti_composite_gate_clk_setup(struct device_node *node,\r\nconst struct clk_hw_omap_ops *hw_ops)\r\n{\r\nstruct clk_hw_omap *gate;\r\nu32 val = 0;\r\ngate = kzalloc(sizeof(*gate), GFP_KERNEL);\r\nif (!gate)\r\nreturn;\r\ngate->enable_reg = ti_clk_get_reg_addr(node, 0);\r\nif (IS_ERR(gate->enable_reg))\r\ngoto cleanup;\r\nof_property_read_u32(node, "ti,bit-shift", &val);\r\ngate->enable_bit = val;\r\ngate->ops = hw_ops;\r\ngate->flags = MEMMAP_ADDRESSING;\r\nif (!ti_clk_add_component(node, &gate->hw, CLK_COMPONENT_TYPE_GATE))\r\nreturn;\r\ncleanup:\r\nkfree(gate);\r\n}\r\nstatic void __init\r\nof_ti_composite_no_wait_gate_clk_setup(struct device_node *node)\r\n{\r\n_of_ti_composite_gate_clk_setup(node, NULL);\r\n}\r\nstatic void __init of_ti_composite_interface_clk_setup(struct device_node *node)\r\n{\r\n_of_ti_composite_gate_clk_setup(node, &clkhwops_iclk_wait);\r\n}\r\nstatic void __init of_ti_composite_gate_clk_setup(struct device_node *node)\r\n{\r\n_of_ti_composite_gate_clk_setup(node, &clkhwops_wait);\r\n}\r\nstatic void __init of_ti_clkdm_gate_clk_setup(struct device_node *node)\r\n{\r\n_of_ti_gate_clk_setup(node, &omap_gate_clkdm_clk_ops, NULL);\r\n}\r\nstatic void __init of_ti_hsdiv_gate_clk_setup(struct device_node *node)\r\n{\r\n_of_ti_gate_clk_setup(node, &omap_gate_clk_hsdiv_restore_ops,\r\n&clkhwops_wait);\r\n}\r\nstatic void __init of_ti_gate_clk_setup(struct device_node *node)\r\n{\r\n_of_ti_gate_clk_setup(node, &omap_gate_clk_ops, NULL);\r\n}\r\nstatic void __init of_ti_wait_gate_clk_setup(struct device_node *node)\r\n{\r\n_of_ti_gate_clk_setup(node, &omap_gate_clk_ops, &clkhwops_wait);\r\n}\r\nstatic void __init of_ti_am35xx_gate_clk_setup(struct device_node *node)\r\n{\r\n_of_ti_gate_clk_setup(node, &omap_gate_clk_ops,\r\n&clkhwops_am35xx_ipss_module_wait);\r\n}\r\nstatic void __init of_ti_dss_gate_clk_setup(struct device_node *node)\r\n{\r\n_of_ti_gate_clk_setup(node, &omap_gate_clk_ops,\r\n&clkhwops_omap3430es2_dss_usbhost_wait);\r\n}

static bool detect_epow(void)\r\n{\r\nu16 epow;\r\nint i, rc;\r\n__be16 epow_classes;\r\n__be16 opal_epow_status[OPAL_SYSEPOW_MAX] = {0};\r\nepow_classes = cpu_to_be16(OPAL_SYSEPOW_MAX);\r\nrc = opal_get_epow_status(opal_epow_status, &epow_classes);\r\nif (rc != OPAL_SUCCESS) {\r\npr_err("Failed to get EPOW event information\n");\r\nreturn false;\r\n}\r\nfor (i = 0; i < be16_to_cpu(epow_classes); i++) {\r\nepow = be16_to_cpu(opal_epow_status[i]);\r\nif (i == OPAL_SYSEPOW_POWER)\r\nepow &= ~(OPAL_SYSPOWER_CHNG | OPAL_SYSPOWER_FAIL |\r\nOPAL_SYSPOWER_INCL);\r\nif (epow)\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool poweroff_pending(void)\r\n{\r\nint rc;\r\n__be64 opal_dpo_timeout;\r\nrc = opal_get_dpo_status(&opal_dpo_timeout);\r\nif (rc == OPAL_SUCCESS) {\r\npr_info("Existing DPO event detected.\n");\r\nreturn true;\r\n}\r\nif (detect_epow()) {\r\npr_info("Existing EPOW event detected.\n");\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic int opal_power_control_event(struct notifier_block *nb,\r\nunsigned long msg_type, void *msg)\r\n{\r\nuint64_t type;\r\nswitch (msg_type) {\r\ncase OPAL_MSG_EPOW:\r\nif (detect_epow()) {\r\npr_info("EPOW msg received. Powering off system\n");\r\norderly_poweroff(true);\r\n}\r\nbreak;\r\ncase OPAL_MSG_DPO:\r\npr_info("DPO msg received. Powering off system\n");\r\norderly_poweroff(true);\r\nbreak;\r\ncase OPAL_MSG_SHUTDOWN:\r\ntype = be64_to_cpu(((struct opal_msg *)msg)->params[0]);\r\nswitch (type) {\r\ncase SOFT_REBOOT:\r\npr_info("Reboot requested\n");\r\norderly_reboot();\r\nbreak;\r\ncase SOFT_OFF:\r\npr_info("Poweroff requested\n");\r\norderly_poweroff(true);\r\nbreak;\r\ndefault:\r\npr_err("Unknown power-control type %llu\n", type);\r\n}\r\nbreak;\r\ndefault:\r\npr_err("Unknown OPAL message type %lu\n", msg_type);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init opal_power_control_init(void)\r\n{\r\nint ret, supported = 0;\r\nstruct device_node *np;\r\nret = opal_message_notifier_register(OPAL_MSG_SHUTDOWN,\r\n&opal_power_control_nb);\r\nif (ret)\r\npr_err("Failed to register SHUTDOWN notifier, ret = %d\n", ret);\r\nnp = of_find_node_by_path("/ibm,opal/epow");\r\nif (np) {\r\nsupported = of_device_is_compatible(np, "ibm,opal-v3-epow");\r\nof_node_put(np);\r\n}\r\nif (!supported)\r\nreturn 0;\r\npr_info("OPAL EPOW, DPO support detected.\n");\r\nret = opal_message_notifier_register(OPAL_MSG_EPOW, &opal_epow_nb);\r\nif (ret)\r\npr_err("Failed to register EPOW notifier, ret = %d\n", ret);\r\nret = opal_message_notifier_register(OPAL_MSG_DPO, &opal_dpo_nb);\r\nif (ret)\r\npr_err("Failed to register DPO notifier, ret = %d\n", ret);\r\nif (poweroff_pending())\r\norderly_poweroff(true);\r\nreturn 0;\r\n}

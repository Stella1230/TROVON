static int ndesc_get_tx_status(void *data, struct stmmac_extra_stats *x,\r\nstruct dma_desc *p, void __iomem *ioaddr)\r\n{\r\nstruct net_device_stats *stats = (struct net_device_stats *)data;\r\nunsigned int tdes0 = p->des0;\r\nunsigned int tdes1 = p->des1;\r\nint ret = tx_done;\r\nif (unlikely(tdes0 & TDES0_OWN))\r\nreturn tx_dma_own;\r\nif (likely(!(tdes1 & TDES1_LAST_SEGMENT)))\r\nreturn tx_not_ls;\r\nif (unlikely(tdes0 & TDES0_ERROR_SUMMARY)) {\r\nif (unlikely(tdes0 & TDES0_UNDERFLOW_ERROR)) {\r\nx->tx_underflow++;\r\nstats->tx_fifo_errors++;\r\n}\r\nif (unlikely(tdes0 & TDES0_NO_CARRIER)) {\r\nx->tx_carrier++;\r\nstats->tx_carrier_errors++;\r\n}\r\nif (unlikely(tdes0 & TDES0_LOSS_CARRIER)) {\r\nx->tx_losscarrier++;\r\nstats->tx_carrier_errors++;\r\n}\r\nif (unlikely((tdes0 & TDES0_EXCESSIVE_DEFERRAL) ||\r\n(tdes0 & TDES0_EXCESSIVE_COLLISIONS) ||\r\n(tdes0 & TDES0_LATE_COLLISION))) {\r\nunsigned int collisions;\r\ncollisions = (tdes0 & TDES0_COLLISION_COUNT_MASK) >> 3;\r\nstats->collisions += collisions;\r\n}\r\nret = tx_err;\r\n}\r\nif (tdes0 & TDES0_VLAN_FRAME)\r\nx->tx_vlan++;\r\nif (unlikely(tdes0 & TDES0_DEFERRED))\r\nx->tx_deferred++;\r\nreturn ret;\r\n}\r\nstatic int ndesc_get_tx_len(struct dma_desc *p)\r\n{\r\nreturn (p->des1 & RDES1_BUFFER1_SIZE_MASK);\r\n}\r\nstatic int ndesc_get_rx_status(void *data, struct stmmac_extra_stats *x,\r\nstruct dma_desc *p)\r\n{\r\nint ret = good_frame;\r\nunsigned int rdes0 = p->des0;\r\nstruct net_device_stats *stats = (struct net_device_stats *)data;\r\nif (unlikely(rdes0 & RDES0_OWN))\r\nreturn dma_own;\r\nif (unlikely(!(rdes0 & RDES0_LAST_DESCRIPTOR))) {\r\npr_warn("%s: Oversized frame spanned multiple buffers\n",\r\n__func__);\r\nstats->rx_length_errors++;\r\nreturn discard_frame;\r\n}\r\nif (unlikely(rdes0 & RDES0_ERROR_SUMMARY)) {\r\nif (unlikely(rdes0 & RDES0_DESCRIPTOR_ERROR))\r\nx->rx_desc++;\r\nif (unlikely(rdes0 & RDES0_SA_FILTER_FAIL))\r\nx->sa_filter_fail++;\r\nif (unlikely(rdes0 & RDES0_OVERFLOW_ERROR))\r\nx->overflow_error++;\r\nif (unlikely(rdes0 & RDES0_IPC_CSUM_ERROR))\r\nx->ipc_csum_error++;\r\nif (unlikely(rdes0 & RDES0_COLLISION)) {\r\nx->rx_collision++;\r\nstats->collisions++;\r\n}\r\nif (unlikely(rdes0 & RDES0_CRC_ERROR)) {\r\nx->rx_crc++;\r\nstats->rx_crc_errors++;\r\n}\r\nret = discard_frame;\r\n}\r\nif (unlikely(rdes0 & RDES0_DRIBBLING))\r\nx->dribbling_bit++;\r\nif (unlikely(rdes0 & RDES0_LENGTH_ERROR)) {\r\nx->rx_length++;\r\nret = discard_frame;\r\n}\r\nif (unlikely(rdes0 & RDES0_MII_ERROR)) {\r\nx->rx_mii++;\r\nret = discard_frame;\r\n}\r\n#ifdef STMMAC_VLAN_TAG_USED\r\nif (rdes0 & RDES0_VLAN_TAG)\r\nx->vlan_tag++;\r\n#endif\r\nreturn ret;\r\n}\r\nstatic void ndesc_init_rx_desc(struct dma_desc *p, int disable_rx_ic, int mode,\r\nint end)\r\n{\r\np->des0 |= RDES0_OWN;\r\np->des1 |= (BUF_SIZE_2KiB - 1) & RDES1_BUFFER1_SIZE_MASK;\r\nif (mode == STMMAC_CHAIN_MODE)\r\nndesc_rx_set_on_chain(p, end);\r\nelse\r\nndesc_rx_set_on_ring(p, end);\r\nif (disable_rx_ic)\r\np->des1 |= RDES1_DISABLE_IC;\r\n}\r\nstatic void ndesc_init_tx_desc(struct dma_desc *p, int mode, int end)\r\n{\r\np->des0 &= ~TDES0_OWN;\r\nif (mode == STMMAC_CHAIN_MODE)\r\nndesc_tx_set_on_chain(p);\r\nelse\r\nndesc_end_tx_desc_on_ring(p, end);\r\n}\r\nstatic int ndesc_get_tx_owner(struct dma_desc *p)\r\n{\r\nreturn (p->des0 & TDES0_OWN) >> 31;\r\n}\r\nstatic void ndesc_set_tx_owner(struct dma_desc *p)\r\n{\r\np->des0 |= TDES0_OWN;\r\n}\r\nstatic void ndesc_set_rx_owner(struct dma_desc *p)\r\n{\r\np->des0 |= RDES0_OWN;\r\n}\r\nstatic int ndesc_get_tx_ls(struct dma_desc *p)\r\n{\r\nreturn (p->des1 & TDES1_LAST_SEGMENT) >> 30;\r\n}\r\nstatic void ndesc_release_tx_desc(struct dma_desc *p, int mode)\r\n{\r\nint ter = (p->des1 & TDES1_END_RING) >> 25;\r\nmemset(p, 0, offsetof(struct dma_desc, des2));\r\nif (mode == STMMAC_CHAIN_MODE)\r\nndesc_tx_set_on_chain(p);\r\nelse\r\nndesc_end_tx_desc_on_ring(p, ter);\r\n}\r\nstatic void ndesc_prepare_tx_desc(struct dma_desc *p, int is_fs, int len,\r\nbool csum_flag, int mode, bool tx_own,\r\nbool ls)\r\n{\r\nunsigned int tdes1 = p->des1;\r\nif (is_fs)\r\ntdes1 |= TDES1_FIRST_SEGMENT;\r\nelse\r\ntdes1 &= ~TDES1_FIRST_SEGMENT;\r\nif (likely(csum_flag))\r\ntdes1 |= (TX_CIC_FULL) << TDES1_CHECKSUM_INSERTION_SHIFT;\r\nelse\r\ntdes1 &= ~(TX_CIC_FULL << TDES1_CHECKSUM_INSERTION_SHIFT);\r\nif (ls)\r\ntdes1 |= TDES1_LAST_SEGMENT;\r\np->des1 = tdes1;\r\nif (mode == STMMAC_CHAIN_MODE)\r\nnorm_set_tx_desc_len_on_chain(p, len);\r\nelse\r\nnorm_set_tx_desc_len_on_ring(p, len);\r\nif (tx_own)\r\np->des0 |= TDES0_OWN;\r\n}\r\nstatic void ndesc_set_tx_ic(struct dma_desc *p)\r\n{\r\np->des1 |= TDES1_INTERRUPT;\r\n}\r\nstatic int ndesc_get_rx_frame_len(struct dma_desc *p, int rx_coe_type)\r\n{\r\nunsigned int csum = 0;\r\nif (rx_coe_type == STMMAC_RX_COE_TYPE1)\r\ncsum = 2;\r\nreturn (((p->des0 & RDES0_FRAME_LEN_MASK) >> RDES0_FRAME_LEN_SHIFT) -\r\ncsum);\r\n}\r\nstatic void ndesc_enable_tx_timestamp(struct dma_desc *p)\r\n{\r\np->des1 |= TDES1_TIME_STAMP_ENABLE;\r\n}\r\nstatic int ndesc_get_tx_timestamp_status(struct dma_desc *p)\r\n{\r\nreturn (p->des0 & TDES0_TIME_STAMP_STATUS) >> 17;\r\n}\r\nstatic u64 ndesc_get_timestamp(void *desc, u32 ats)\r\n{\r\nstruct dma_desc *p = (struct dma_desc *)desc;\r\nu64 ns;\r\nns = p->des2;\r\nns += p->des3 * 1000000000ULL;\r\nreturn ns;\r\n}\r\nstatic int ndesc_get_rx_timestamp_status(void *desc, u32 ats)\r\n{\r\nstruct dma_desc *p = (struct dma_desc *)desc;\r\nif ((p->des2 == 0xffffffff) && (p->des3 == 0xffffffff))\r\nreturn 0;\r\nelse\r\nreturn 1;\r\n}\r\nstatic void ndesc_display_ring(void *head, unsigned int size, bool rx)\r\n{\r\nstruct dma_desc *p = (struct dma_desc *)head;\r\nint i;\r\npr_info("%s descriptor ring:\n", rx ? "RX" : "TX");\r\nfor (i = 0; i < size; i++) {\r\nu64 x;\r\nx = *(u64 *)p;\r\npr_info("%d [0x%x]: 0x%x 0x%x 0x%x 0x%x",\r\ni, (unsigned int)virt_to_phys(p),\r\n(unsigned int)x, (unsigned int)(x >> 32),\r\np->des2, p->des3);\r\np++;\r\n}\r\npr_info("\n");\r\n}

static void trace_do_benchmark(void)\r\n{\r\nu64 start;\r\nu64 stop;\r\nu64 delta;\r\nu64 stddev;\r\nu64 seed;\r\nu64 last_seed;\r\nunsigned int avg;\r\nunsigned int std = 0;\r\nif (!trace_benchmark_event_enabled() || !tracing_is_on())\r\nreturn;\r\nlocal_irq_disable();\r\nstart = trace_clock_local();\r\ntrace_benchmark_event(bm_str);\r\nstop = trace_clock_local();\r\nlocal_irq_enable();\r\nbm_cnt++;\r\ndelta = stop - start;\r\nif (bm_cnt == 1) {\r\nbm_first = delta;\r\nscnprintf(bm_str, BENCHMARK_EVENT_STRLEN,\r\n"first=%llu [COLD CACHED]", bm_first);\r\nreturn;\r\n}\r\nbm_last = delta;\r\nif (delta > bm_max)\r\nbm_max = delta;\r\nif (!bm_min || delta < bm_min)\r\nbm_min = delta;\r\nif (bm_cnt > UINT_MAX) {\r\nscnprintf(bm_str, BENCHMARK_EVENT_STRLEN,\r\n"last=%llu first=%llu max=%llu min=%llu ** avg=%u std=%d std^2=%lld",\r\nbm_last, bm_first, bm_max, bm_min, bm_avg, bm_std, bm_stddev);\r\nreturn;\r\n}\r\nbm_total += delta;\r\nbm_totalsq += delta * delta;\r\nif (bm_cnt > 1) {\r\nstddev = (u64)bm_cnt * bm_totalsq - bm_total * bm_total;\r\ndo_div(stddev, (u32)bm_cnt);\r\ndo_div(stddev, (u32)bm_cnt - 1);\r\n} else\r\nstddev = 0;\r\ndelta = bm_total;\r\ndo_div(delta, bm_cnt);\r\navg = delta;\r\nif (stddev > 0) {\r\nint i = 0;\r\nseed = avg;\r\ndo {\r\nlast_seed = seed;\r\nseed = stddev;\r\nif (!last_seed)\r\nbreak;\r\ndo_div(seed, last_seed);\r\nseed += last_seed;\r\ndo_div(seed, 2);\r\n} while (i++ < 10 && last_seed != seed);\r\nstd = seed;\r\n}\r\nscnprintf(bm_str, BENCHMARK_EVENT_STRLEN,\r\n"last=%llu first=%llu max=%llu min=%llu avg=%u std=%d std^2=%lld",\r\nbm_last, bm_first, bm_max, bm_min, avg, std, stddev);\r\nbm_std = std;\r\nbm_avg = avg;\r\nbm_stddev = stddev;\r\n}\r\nstatic int benchmark_event_kthread(void *arg)\r\n{\r\nmsleep(100);\r\nwhile (!kthread_should_stop()) {\r\ntrace_do_benchmark();\r\ncond_resched();\r\n}\r\nreturn 0;\r\n}\r\nvoid trace_benchmark_reg(void)\r\n{\r\nbm_event_thread = kthread_run(benchmark_event_kthread,\r\nNULL, "event_benchmark");\r\nWARN_ON(!bm_event_thread);\r\n}\r\nvoid trace_benchmark_unreg(void)\r\n{\r\nif (!bm_event_thread)\r\nreturn;\r\nkthread_stop(bm_event_thread);\r\nstrcpy(bm_str, "START");\r\nbm_total = 0;\r\nbm_totalsq = 0;\r\nbm_last = 0;\r\nbm_max = 0;\r\nbm_min = 0;\r\nbm_cnt = 0;\r\nbm_first = 0;\r\nbm_std = 0;\r\nbm_avg = 0;\r\nbm_stddev = 0;\r\n}

static void hi6220_phy_init(struct hi6220_priv *priv)\r\n{\r\nstruct regmap *reg = priv->reg;\r\nu32 val, mask;\r\nval = RST0_USBOTG_BUS | RST0_POR_PICOPHY |\r\nRST0_USBOTG | RST0_USBOTG_32K;\r\nmask = val;\r\nregmap_update_bits(reg, SC_PERIPH_RSTEN0, mask, val);\r\nregmap_update_bits(reg, SC_PERIPH_RSTDIS0, mask, val);\r\n}\r\nstatic int hi6220_phy_setup(struct hi6220_priv *priv, bool on)\r\n{\r\nstruct regmap *reg = priv->reg;\r\nu32 val, mask;\r\nint ret;\r\nif (on) {\r\nval = CTRL5_USBOTG_RES_SEL | CTRL5_PICOPHY_ACAENB;\r\nmask = val | CTRL5_PICOPHY_BC_MODE;\r\nret = regmap_update_bits(reg, SC_PERIPH_CTRL5, mask, val);\r\nif (ret)\r\ngoto out;\r\nval = CTRL4_PICO_VBUSVLDEXT | CTRL4_PICO_VBUSVLDEXTSEL |\r\nCTRL4_OTG_PHY_SEL;\r\nmask = val | CTRL4_PICO_SIDDQ | CTRL4_PICO_OGDISABLE;\r\nret = regmap_update_bits(reg, SC_PERIPH_CTRL4, mask, val);\r\nif (ret)\r\ngoto out;\r\nret = regmap_write(reg, SC_PERIPH_CTRL8, EYE_PATTERN_PARA);\r\nif (ret)\r\ngoto out;\r\n} else {\r\nval = CTRL4_PICO_SIDDQ;\r\nmask = val;\r\nret = regmap_update_bits(reg, SC_PERIPH_CTRL4, mask, val);\r\nif (ret)\r\ngoto out;\r\n}\r\nreturn 0;\r\nout:\r\ndev_err(priv->dev, "failed to setup phy ret: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int hi6220_phy_start(struct phy *phy)\r\n{\r\nstruct hi6220_priv *priv = phy_get_drvdata(phy);\r\nreturn hi6220_phy_setup(priv, true);\r\n}\r\nstatic int hi6220_phy_exit(struct phy *phy)\r\n{\r\nstruct hi6220_priv *priv = phy_get_drvdata(phy);\r\nreturn hi6220_phy_setup(priv, false);\r\n}\r\nstatic int hi6220_phy_probe(struct platform_device *pdev)\r\n{\r\nstruct phy_provider *phy_provider;\r\nstruct device *dev = &pdev->dev;\r\nstruct phy *phy;\r\nstruct hi6220_priv *priv;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->dev = dev;\r\npriv->reg = syscon_regmap_lookup_by_phandle(dev->of_node,\r\n"hisilicon,peripheral-syscon");\r\nif (IS_ERR(priv->reg)) {\r\ndev_err(dev, "no hisilicon,peripheral-syscon\n");\r\nreturn PTR_ERR(priv->reg);\r\n}\r\nhi6220_phy_init(priv);\r\nphy = devm_phy_create(dev, NULL, &hi6220_phy_ops);\r\nif (IS_ERR(phy))\r\nreturn PTR_ERR(phy);\r\nphy_set_drvdata(phy, priv);\r\nphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\r\nreturn PTR_ERR_OR_ZERO(phy_provider);\r\n}

static int\r\nnvc0_fence_emit32(struct nouveau_channel *chan, u64 virtual, u32 sequence)\r\n{\r\nint ret = RING_SPACE(chan, 6);\r\nif (ret == 0) {\r\nBEGIN_NVC0(chan, 0, NV84_SUBCHAN_SEMAPHORE_ADDRESS_HIGH, 5);\r\nOUT_RING (chan, upper_32_bits(virtual));\r\nOUT_RING (chan, lower_32_bits(virtual));\r\nOUT_RING (chan, sequence);\r\nOUT_RING (chan, NV84_SUBCHAN_SEMAPHORE_TRIGGER_WRITE_LONG);\r\nOUT_RING (chan, 0x00000000);\r\nFIRE_RING (chan);\r\n}\r\nreturn ret;\r\n}\r\nstatic int\r\nnvc0_fence_sync32(struct nouveau_channel *chan, u64 virtual, u32 sequence)\r\n{\r\nint ret = RING_SPACE(chan, 5);\r\nif (ret == 0) {\r\nBEGIN_NVC0(chan, 0, NV84_SUBCHAN_SEMAPHORE_ADDRESS_HIGH, 4);\r\nOUT_RING (chan, upper_32_bits(virtual));\r\nOUT_RING (chan, lower_32_bits(virtual));\r\nOUT_RING (chan, sequence);\r\nOUT_RING (chan, NV84_SUBCHAN_SEMAPHORE_TRIGGER_ACQUIRE_GEQUAL |\r\nNVC0_SUBCHAN_SEMAPHORE_TRIGGER_YIELD);\r\nFIRE_RING (chan);\r\n}\r\nreturn ret;\r\n}\r\nstatic int\r\nnvc0_fence_context_new(struct nouveau_channel *chan)\r\n{\r\nint ret = nv84_fence_context_new(chan);\r\nif (ret == 0) {\r\nstruct nv84_fence_chan *fctx = chan->fence;\r\nfctx->base.emit32 = nvc0_fence_emit32;\r\nfctx->base.sync32 = nvc0_fence_sync32;\r\n}\r\nreturn ret;\r\n}\r\nint\r\nnvc0_fence_create(struct nouveau_drm *drm)\r\n{\r\nint ret = nv84_fence_create(drm);\r\nif (ret == 0) {\r\nstruct nv84_fence_priv *priv = drm->fence;\r\npriv->base.context_new = nvc0_fence_context_new;\r\n}\r\nreturn ret;\r\n}

static ssize_t dump_id_show(struct dump_obj *dump_obj,\r\nstruct dump_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "0x%x\n", dump_obj->id);\r\n}\r\nstatic const char* dump_type_to_string(uint32_t type)\r\n{\r\nswitch (type) {\r\ncase 0x01: return "SP Dump";\r\ncase 0x02: return "System/Platform Dump";\r\ncase 0x03: return "SMA Dump";\r\ndefault: return "unknown";\r\n}\r\n}\r\nstatic ssize_t dump_type_show(struct dump_obj *dump_obj,\r\nstruct dump_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "0x%x %s\n", dump_obj->type,\r\ndump_type_to_string(dump_obj->type));\r\n}\r\nstatic ssize_t dump_ack_show(struct dump_obj *dump_obj,\r\nstruct dump_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "ack - acknowledge dump\n");\r\n}\r\nstatic int64_t dump_send_ack(uint32_t dump_id)\r\n{\r\nint rc;\r\nrc = opal_dump_ack(dump_id);\r\nif (rc)\r\npr_warn("%s: Failed to send ack to Dump ID 0x%x (%d)\n",\r\n__func__, dump_id, rc);\r\nreturn rc;\r\n}\r\nstatic ssize_t dump_ack_store(struct dump_obj *dump_obj,\r\nstruct dump_attribute *attr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\ndump_send_ack(dump_obj->id);\r\nsysfs_remove_file_self(&dump_obj->kobj, &attr->attr);\r\nkobject_put(&dump_obj->kobj);\r\nreturn count;\r\n}\r\nstatic ssize_t init_dump_show(struct dump_obj *dump_obj,\r\nstruct dump_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "1 - initiate Service Processor(FSP) dump\n");\r\n}\r\nstatic int64_t dump_fips_init(uint8_t type)\r\n{\r\nint rc;\r\nrc = opal_dump_init(type);\r\nif (rc)\r\npr_warn("%s: Failed to initiate FSP dump (%d)\n",\r\n__func__, rc);\r\nreturn rc;\r\n}\r\nstatic ssize_t init_dump_store(struct dump_obj *dump_obj,\r\nstruct dump_attribute *attr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nint rc;\r\nrc = dump_fips_init(DUMP_TYPE_FSP);\r\nif (rc == OPAL_SUCCESS)\r\npr_info("%s: Initiated FSP dump\n", __func__);\r\nreturn count;\r\n}\r\nstatic ssize_t dump_attr_show(struct kobject *kobj,\r\nstruct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct dump_attribute *attribute;\r\nstruct dump_obj *dump;\r\nattribute = to_dump_attr(attr);\r\ndump = to_dump_obj(kobj);\r\nif (!attribute->show)\r\nreturn -EIO;\r\nreturn attribute->show(dump, attribute, buf);\r\n}\r\nstatic ssize_t dump_attr_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct dump_attribute *attribute;\r\nstruct dump_obj *dump;\r\nattribute = to_dump_attr(attr);\r\ndump = to_dump_obj(kobj);\r\nif (!attribute->store)\r\nreturn -EIO;\r\nreturn attribute->store(dump, attribute, buf, len);\r\n}\r\nstatic void dump_release(struct kobject *kobj)\r\n{\r\nstruct dump_obj *dump;\r\ndump = to_dump_obj(kobj);\r\nvfree(dump->buffer);\r\nkfree(dump);\r\n}\r\nstatic int64_t dump_read_info(uint32_t *dump_id, uint32_t *dump_size, uint32_t *dump_type)\r\n{\r\n__be32 id, size, type;\r\nint rc;\r\ntype = cpu_to_be32(0xffffffff);\r\nrc = opal_dump_info2(&id, &size, &type);\r\nif (rc == OPAL_PARAMETER)\r\nrc = opal_dump_info(&id, &size);\r\n*dump_id = be32_to_cpu(id);\r\n*dump_size = be32_to_cpu(size);\r\n*dump_type = be32_to_cpu(type);\r\nif (rc)\r\npr_warn("%s: Failed to get dump info (%d)\n",\r\n__func__, rc);\r\nreturn rc;\r\n}\r\nstatic int64_t dump_read_data(struct dump_obj *dump)\r\n{\r\nstruct opal_sg_list *list;\r\nuint64_t addr;\r\nint64_t rc;\r\ndump->buffer = vzalloc(PAGE_ALIGN(dump->size));\r\nif (!dump->buffer) {\r\npr_err("%s : Failed to allocate memory\n", __func__);\r\nrc = -ENOMEM;\r\ngoto out;\r\n}\r\nlist = opal_vmalloc_to_sg_list(dump->buffer, dump->size);\r\nif (!list) {\r\nrc = -ENOMEM;\r\ngoto out;\r\n}\r\naddr = __pa(list);\r\nrc = OPAL_BUSY_EVENT;\r\nwhile (rc == OPAL_BUSY || rc == OPAL_BUSY_EVENT) {\r\nrc = opal_dump_read(dump->id, addr);\r\nif (rc == OPAL_BUSY_EVENT) {\r\nopal_poll_events(NULL);\r\nmsleep(20);\r\n}\r\n}\r\nif (rc != OPAL_SUCCESS && rc != OPAL_PARTIAL)\r\npr_warn("%s: Extract dump failed for ID 0x%x\n",\r\n__func__, dump->id);\r\nopal_free_sg_list(list);\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t dump_attr_read(struct file *filep, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buffer, loff_t pos, size_t count)\r\n{\r\nssize_t rc;\r\nstruct dump_obj *dump = to_dump_obj(kobj);\r\nif (!dump->buffer) {\r\nrc = dump_read_data(dump);\r\nif (rc != OPAL_SUCCESS && rc != OPAL_PARTIAL) {\r\nvfree(dump->buffer);\r\ndump->buffer = NULL;\r\nreturn -EIO;\r\n}\r\nif (rc == OPAL_PARTIAL) {\r\npr_info("%s: Platform dump partially read. ID = 0x%x\n",\r\n__func__, dump->id);\r\nreturn -EIO;\r\n}\r\n}\r\nmemcpy(buffer, dump->buffer + pos, count);\r\nreturn count;\r\n}\r\nstatic struct dump_obj *create_dump_obj(uint32_t id, size_t size,\r\nuint32_t type)\r\n{\r\nstruct dump_obj *dump;\r\nint rc;\r\ndump = kzalloc(sizeof(*dump), GFP_KERNEL);\r\nif (!dump)\r\nreturn NULL;\r\ndump->kobj.kset = dump_kset;\r\nkobject_init(&dump->kobj, &dump_ktype);\r\nsysfs_bin_attr_init(&dump->dump_attr);\r\ndump->dump_attr.attr.name = "dump";\r\ndump->dump_attr.attr.mode = 0400;\r\ndump->dump_attr.size = size;\r\ndump->dump_attr.read = dump_attr_read;\r\ndump->id = id;\r\ndump->size = size;\r\ndump->type = type;\r\nrc = kobject_add(&dump->kobj, NULL, "0x%x-0x%x", type, id);\r\nif (rc) {\r\nkobject_put(&dump->kobj);\r\nreturn NULL;\r\n}\r\nrc = sysfs_create_bin_file(&dump->kobj, &dump->dump_attr);\r\nif (rc) {\r\nkobject_put(&dump->kobj);\r\nreturn NULL;\r\n}\r\npr_info("%s: New platform dump. ID = 0x%x Size %u\n",\r\n__func__, dump->id, dump->size);\r\nkobject_uevent(&dump->kobj, KOBJ_ADD);\r\nreturn dump;\r\n}\r\nstatic irqreturn_t process_dump(int irq, void *data)\r\n{\r\nint rc;\r\nuint32_t dump_id, dump_size, dump_type;\r\nstruct dump_obj *dump;\r\nchar name[22];\r\nstruct kobject *kobj;\r\nrc = dump_read_info(&dump_id, &dump_size, &dump_type);\r\nif (rc != OPAL_SUCCESS)\r\nreturn rc;\r\nsprintf(name, "0x%x-0x%x", dump_type, dump_id);\r\nkobj = kset_find_obj(dump_kset, name);\r\nif (kobj) {\r\nkobject_put(kobj);\r\nreturn 0;\r\n}\r\ndump = create_dump_obj(dump_id, dump_size, dump_type);\r\nif (!dump)\r\nreturn -1;\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid __init opal_platform_dump_init(void)\r\n{\r\nint rc;\r\nint dump_irq;\r\nif (!opal_check_token(OPAL_DUMP_READ))\r\nreturn;\r\ndump_kset = kset_create_and_add("dump", NULL, opal_kobj);\r\nif (!dump_kset) {\r\npr_warn("%s: Failed to create dump kset\n", __func__);\r\nreturn;\r\n}\r\nrc = sysfs_create_group(&dump_kset->kobj, &initiate_attr_group);\r\nif (rc) {\r\npr_warn("%s: Failed to create initiate dump attr group\n",\r\n__func__);\r\nkobject_put(&dump_kset->kobj);\r\nreturn;\r\n}\r\ndump_irq = opal_event_request(ilog2(OPAL_EVENT_DUMP_AVAIL));\r\nif (!dump_irq) {\r\npr_err("%s: Can't register OPAL event irq (%d)\n",\r\n__func__, dump_irq);\r\nreturn;\r\n}\r\nrc = request_threaded_irq(dump_irq, NULL, process_dump,\r\nIRQF_TRIGGER_HIGH | IRQF_ONESHOT,\r\n"opal-dump", NULL);\r\nif (rc) {\r\npr_err("%s: Can't request OPAL event irq (%d)\n",\r\n__func__, rc);\r\nreturn;\r\n}\r\nif (opal_check_token(OPAL_DUMP_RESEND))\r\nopal_dump_resend_notification();\r\n}

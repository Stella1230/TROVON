static u16 am2315_crc(u8 *data, u8 nr_bytes)\r\n{\r\nint i;\r\nu16 crc = 0xffff;\r\nwhile (nr_bytes--) {\r\ncrc ^= *data++;\r\nfor (i = 0; i < 8; i++) {\r\nif (crc & 0x01) {\r\ncrc >>= 1;\r\ncrc ^= 0xA001;\r\n} else {\r\ncrc >>= 1;\r\n}\r\n}\r\n}\r\nreturn crc;\r\n}\r\nstatic void am2315_ping(struct i2c_client *client)\r\n{\r\ni2c_smbus_read_byte_data(client, AM2315_REG_HUM_MSB);\r\n}\r\nstatic int am2315_read_data(struct am2315_data *data,\r\nstruct am2315_sensor_data *sensor_data)\r\n{\r\nint ret;\r\nu8 tx_buf[3] = { AM2315_FUNCTION_READ, AM2315_REG_HUM_MSB, 4 };\r\nu8 rx_buf[8];\r\nu16 crc;\r\nam2315_ping(data->client);\r\nmutex_lock(&data->lock);\r\nret = i2c_master_send(data->client, tx_buf, sizeof(tx_buf));\r\nif (ret < 0) {\r\ndev_err(&data->client->dev, "failed to send read request\n");\r\ngoto exit_unlock;\r\n}\r\nusleep_range(2000, 3000);\r\nret = i2c_master_recv(data->client, rx_buf, sizeof(rx_buf));\r\nif (ret < 0) {\r\ndev_err(&data->client->dev, "failed to read sensor data\n");\r\ngoto exit_unlock;\r\n}\r\nmutex_unlock(&data->lock);\r\ncrc = am2315_crc(rx_buf, sizeof(rx_buf) - 2);\r\nif ((crc & 0xff) != rx_buf[6] || (crc >> 8) != rx_buf[7]) {\r\ndev_err(&data->client->dev, "failed to verify sensor data\n");\r\nreturn -EIO;\r\n}\r\nsensor_data->hum_data = (rx_buf[AM2315_HUM_OFFSET] << 8) |\r\nrx_buf[AM2315_HUM_OFFSET + 1];\r\nsensor_data->temp_data = (rx_buf[AM2315_TEMP_OFFSET] << 8) |\r\nrx_buf[AM2315_TEMP_OFFSET + 1];\r\nreturn ret;\r\nexit_unlock:\r\nmutex_unlock(&data->lock);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t am2315_trigger_handler(int irq, void *p)\r\n{\r\nint i;\r\nint ret;\r\nint bit;\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->indio_dev;\r\nstruct am2315_data *data = iio_priv(indio_dev);\r\nstruct am2315_sensor_data sensor_data;\r\nret = am2315_read_data(data, &sensor_data);\r\nif (ret < 0)\r\ngoto err;\r\nmutex_lock(&data->lock);\r\nif (*(indio_dev->active_scan_mask) == AM2315_ALL_CHANNEL_MASK) {\r\ndata->buffer[0] = sensor_data.hum_data;\r\ndata->buffer[1] = sensor_data.temp_data;\r\n} else {\r\ni = 0;\r\nfor_each_set_bit(bit, indio_dev->active_scan_mask,\r\nindio_dev->masklength) {\r\ndata->buffer[i] = (bit ? sensor_data.temp_data :\r\nsensor_data.hum_data);\r\ni++;\r\n}\r\n}\r\nmutex_unlock(&data->lock);\r\niio_push_to_buffers_with_timestamp(indio_dev, data->buffer,\r\npf->timestamp);\r\nerr:\r\niio_trigger_notify_done(indio_dev->trig);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int am2315_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val, int *val2, long mask)\r\n{\r\nint ret;\r\nstruct am2315_sensor_data sensor_data;\r\nstruct am2315_data *data = iio_priv(indio_dev);\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nret = am2315_read_data(data, &sensor_data);\r\nif (ret < 0)\r\nreturn ret;\r\n*val = (chan->type == IIO_HUMIDITYRELATIVE) ?\r\nsensor_data.hum_data : sensor_data.temp_data;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_SCALE:\r\n*val = 100;\r\nreturn IIO_VAL_INT;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int am2315_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev;\r\nstruct am2315_data *data;\r\nindio_dev = devm_iio_device_alloc(&client->dev, sizeof(*data));\r\nif (!indio_dev) {\r\ndev_err(&client->dev, "iio allocation failed!\n");\r\nreturn -ENOMEM;\r\n}\r\ndata = iio_priv(indio_dev);\r\ndata->client = client;\r\ni2c_set_clientdata(client, indio_dev);\r\nmutex_init(&data->lock);\r\nindio_dev->dev.parent = &client->dev;\r\nindio_dev->info = &am2315_info;\r\nindio_dev->name = AM2315_DRIVER_NAME;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = am2315_channels;\r\nindio_dev->num_channels = ARRAY_SIZE(am2315_channels);\r\nret = iio_triggered_buffer_setup(indio_dev, iio_pollfunc_store_time,\r\nam2315_trigger_handler, NULL);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "iio triggered buffer setup failed\n");\r\nreturn ret;\r\n}\r\nret = iio_device_register(indio_dev);\r\nif (ret < 0)\r\ngoto err_buffer_cleanup;\r\nreturn 0;\r\nerr_buffer_cleanup:\r\niio_triggered_buffer_cleanup(indio_dev);\r\nreturn ret;\r\n}\r\nstatic int am2315_remove(struct i2c_client *client)\r\n{\r\nstruct iio_dev *indio_dev = i2c_get_clientdata(client);\r\niio_device_unregister(indio_dev);\r\niio_triggered_buffer_cleanup(indio_dev);\r\nreturn 0;\r\n}

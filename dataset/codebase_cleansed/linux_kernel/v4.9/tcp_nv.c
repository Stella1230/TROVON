static inline void tcpnv_reset(struct tcpnv *ca, struct sock *sk)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nca->nv_reset = 0;\r\nca->loss_cwnd = 0;\r\nca->nv_no_cong_cnt = 0;\r\nca->nv_rtt_cnt = 0;\r\nca->nv_last_rtt = 0;\r\nca->nv_rtt_max_rate = 0;\r\nca->nv_rtt_start_seq = tp->snd_una;\r\nca->nv_eval_call_cnt = 0;\r\nca->nv_last_snd_una = tp->snd_una;\r\n}\r\nstatic void tcpnv_init(struct sock *sk)\r\n{\r\nstruct tcpnv *ca = inet_csk_ca(sk);\r\ntcpnv_reset(ca, sk);\r\nca->nv_allow_cwnd_growth = 1;\r\nca->nv_min_rtt_reset_jiffies = jiffies + 2 * HZ;\r\nca->nv_min_rtt = NV_INIT_RTT;\r\nca->nv_min_rtt_new = NV_INIT_RTT;\r\nca->nv_min_cwnd = NV_MIN_CWND;\r\nca->nv_catchup = 0;\r\nca->cwnd_growth_factor = 0;\r\n}\r\nstatic void tcpnv_cong_avoid(struct sock *sk, u32 ack, u32 acked)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct tcpnv *ca = inet_csk_ca(sk);\r\nu32 cnt;\r\nif (!tcp_is_cwnd_limited(sk))\r\nreturn;\r\nif (!ca->nv_allow_cwnd_growth)\r\nreturn;\r\nif (tcp_in_slow_start(tp)) {\r\nacked = tcp_slow_start(tp, acked);\r\nif (!acked)\r\nreturn;\r\n}\r\nif (ca->cwnd_growth_factor < 0) {\r\ncnt = tp->snd_cwnd << -ca->cwnd_growth_factor;\r\ntcp_cong_avoid_ai(tp, cnt, acked);\r\n} else {\r\ncnt = max(4U, tp->snd_cwnd >> ca->cwnd_growth_factor);\r\ntcp_cong_avoid_ai(tp, cnt, acked);\r\n}\r\n}\r\nstatic u32 tcpnv_recalc_ssthresh(struct sock *sk)\r\n{\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nstruct tcpnv *ca = inet_csk_ca(sk);\r\nca->loss_cwnd = tp->snd_cwnd;\r\nreturn max((tp->snd_cwnd * nv_loss_dec_factor) >> 10, 2U);\r\n}\r\nstatic u32 tcpnv_undo_cwnd(struct sock *sk)\r\n{\r\nstruct tcpnv *ca = inet_csk_ca(sk);\r\nreturn max(tcp_sk(sk)->snd_cwnd, ca->loss_cwnd);\r\n}\r\nstatic void tcpnv_state(struct sock *sk, u8 new_state)\r\n{\r\nstruct tcpnv *ca = inet_csk_ca(sk);\r\nif (new_state == TCP_CA_Open && ca->nv_reset) {\r\ntcpnv_reset(ca, sk);\r\n} else if (new_state == TCP_CA_Loss || new_state == TCP_CA_CWR ||\r\nnew_state == TCP_CA_Recovery) {\r\nca->nv_reset = 1;\r\nca->nv_allow_cwnd_growth = 0;\r\nif (new_state == TCP_CA_Loss) {\r\nif (ca->cwnd_growth_factor > 0)\r\nca->cwnd_growth_factor = 0;\r\nif (nv_cwnd_growth_rate_neg > 0 &&\r\nca->cwnd_growth_factor > -8)\r\nca->cwnd_growth_factor--;\r\n}\r\n}\r\n}\r\nstatic void tcpnv_acked(struct sock *sk, const struct ack_sample *sample)\r\n{\r\nconst struct inet_connection_sock *icsk = inet_csk(sk);\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct tcpnv *ca = inet_csk_ca(sk);\r\nunsigned long now = jiffies;\r\ns64 rate64 = 0;\r\nu32 rate, max_win, cwnd_by_slope;\r\nu32 avg_rtt;\r\nu32 bytes_acked = 0;\r\nif (sample->rtt_us < 0)\r\nreturn;\r\nif (icsk->icsk_ca_state != TCP_CA_Open &&\r\nicsk->icsk_ca_state != TCP_CA_Disorder)\r\nreturn;\r\nif (ca->nv_catchup && tp->snd_cwnd >= nv_min_cwnd) {\r\nca->nv_catchup = 0;\r\nca->nv_allow_cwnd_growth = 0;\r\n}\r\nbytes_acked = tp->snd_una - ca->nv_last_snd_una;\r\nca->nv_last_snd_una = tp->snd_una;\r\nif (sample->in_flight == 0)\r\nreturn;\r\nif (nv_rtt_factor > 0) {\r\nif (ca->nv_last_rtt > 0) {\r\navg_rtt = (((u64)sample->rtt_us) * nv_rtt_factor +\r\n((u64)ca->nv_last_rtt)\r\n* (256 - nv_rtt_factor)) >> 8;\r\n} else {\r\navg_rtt = sample->rtt_us;\r\nca->nv_min_rtt = avg_rtt << 1;\r\n}\r\nca->nv_last_rtt = avg_rtt;\r\n} else {\r\navg_rtt = sample->rtt_us;\r\n}\r\nrate64 = ((u64)sample->in_flight) * 8000000;\r\nrate = (u32)div64_u64(rate64, (u64)(avg_rtt * 100));\r\nif (ca->nv_rtt_max_rate < rate)\r\nca->nv_rtt_max_rate = rate;\r\nif (ca->nv_eval_call_cnt < 255)\r\nca->nv_eval_call_cnt++;\r\nif (avg_rtt < ca->nv_min_rtt)\r\nca->nv_min_rtt = avg_rtt;\r\nif (avg_rtt < ca->nv_min_rtt_new)\r\nca->nv_min_rtt_new = avg_rtt;\r\nif (time_after_eq(now, ca->nv_min_rtt_reset_jiffies)) {\r\nunsigned char rand;\r\nca->nv_min_rtt = ca->nv_min_rtt_new;\r\nca->nv_min_rtt_new = NV_INIT_RTT;\r\nget_random_bytes(&rand, 1);\r\nca->nv_min_rtt_reset_jiffies =\r\nnow + ((nv_reset_period * (384 + rand) * HZ) >> 9);\r\nca->nv_min_cwnd = max(ca->nv_min_cwnd / 2, NV_MIN_CWND);\r\n}\r\nif (before(ca->nv_rtt_start_seq, tp->snd_una)) {\r\nca->nv_rtt_start_seq = tp->snd_nxt;\r\nif (ca->nv_rtt_cnt < 0xff)\r\nca->nv_rtt_cnt++;\r\nif (ca->nv_eval_call_cnt == 1 &&\r\nbytes_acked >= (ca->nv_min_cwnd - 1) * tp->mss_cache &&\r\nca->nv_min_cwnd < (NV_TSO_CWND_BOUND + 1)) {\r\nca->nv_min_cwnd = min(ca->nv_min_cwnd\r\n+ NV_MIN_CWND_GROW,\r\nNV_TSO_CWND_BOUND + 1);\r\nca->nv_rtt_start_seq = tp->snd_nxt +\r\nca->nv_min_cwnd * tp->mss_cache;\r\nca->nv_eval_call_cnt = 0;\r\nca->nv_allow_cwnd_growth = 1;\r\nreturn;\r\n}\r\ncwnd_by_slope = (u32)\r\ndiv64_u64(((u64)ca->nv_rtt_max_rate) * ca->nv_min_rtt,\r\n(u64)(80000 * tp->mss_cache));\r\nmax_win = cwnd_by_slope + nv_pad;\r\nif (tp->snd_cwnd > max_win) {\r\nif (ca->nv_rtt_cnt < nv_rtt_min_cnt) {\r\nreturn;\r\n} else if (tp->snd_ssthresh == TCP_INFINITE_SSTHRESH) {\r\nif (ca->nv_eval_call_cnt <\r\nnv_ssthresh_eval_min_calls)\r\nreturn;\r\n} else if (ca->nv_eval_call_cnt <\r\nnv_dec_eval_min_calls) {\r\nif (ca->nv_allow_cwnd_growth &&\r\nca->nv_rtt_cnt > nv_stop_rtt_cnt)\r\nca->nv_allow_cwnd_growth = 0;\r\nreturn;\r\n}\r\nca->nv_allow_cwnd_growth = 0;\r\ntp->snd_ssthresh =\r\n(nv_ssthresh_factor * max_win) >> 3;\r\nif (tp->snd_cwnd - max_win > 2) {\r\nint dec;\r\ndec = max(2U, ((tp->snd_cwnd - max_win) *\r\nnv_cong_dec_mult) >> 7);\r\ntp->snd_cwnd -= dec;\r\n} else if (nv_cong_dec_mult > 0) {\r\ntp->snd_cwnd = max_win;\r\n}\r\nif (ca->cwnd_growth_factor > 0)\r\nca->cwnd_growth_factor = 0;\r\nca->nv_no_cong_cnt = 0;\r\n} else if (tp->snd_cwnd <= max_win - nv_pad_buffer) {\r\nif (ca->nv_eval_call_cnt < nv_inc_eval_min_calls)\r\nreturn;\r\nca->nv_allow_cwnd_growth = 1;\r\nca->nv_no_cong_cnt++;\r\nif (ca->cwnd_growth_factor < 0 &&\r\nnv_cwnd_growth_rate_neg > 0 &&\r\nca->nv_no_cong_cnt > nv_cwnd_growth_rate_neg) {\r\nca->cwnd_growth_factor++;\r\nca->nv_no_cong_cnt = 0;\r\n} else if (ca->cwnd_growth_factor >= 0 &&\r\nnv_cwnd_growth_rate_pos > 0 &&\r\nca->nv_no_cong_cnt >\r\nnv_cwnd_growth_rate_pos) {\r\nca->cwnd_growth_factor++;\r\nca->nv_no_cong_cnt = 0;\r\n}\r\n} else {\r\nreturn;\r\n}\r\nca->nv_eval_call_cnt = 0;\r\nca->nv_rtt_cnt = 0;\r\nca->nv_rtt_max_rate = 0;\r\nif (tp->snd_cwnd < nv_min_cwnd)\r\ntp->snd_cwnd = nv_min_cwnd;\r\n}\r\n}\r\nsize_t tcpnv_get_info(struct sock *sk, u32 ext, int *attr,\r\nunion tcp_cc_info *info)\r\n{\r\nconst struct tcpnv *ca = inet_csk_ca(sk);\r\nif (ext & (1 << (INET_DIAG_VEGASINFO - 1))) {\r\ninfo->vegas.tcpv_enabled = 1;\r\ninfo->vegas.tcpv_rttcnt = ca->nv_rtt_cnt;\r\ninfo->vegas.tcpv_rtt = ca->nv_last_rtt;\r\ninfo->vegas.tcpv_minrtt = ca->nv_min_rtt;\r\n*attr = INET_DIAG_VEGASINFO;\r\nreturn sizeof(struct tcpvegas_info);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init tcpnv_register(void)\r\n{\r\nBUILD_BUG_ON(sizeof(struct tcpnv) > ICSK_CA_PRIV_SIZE);\r\nreturn tcp_register_congestion_control(&tcpnv);\r\n}\r\nstatic void __exit tcpnv_unregister(void)\r\n{\r\ntcp_unregister_congestion_control(&tcpnv);\r\n}

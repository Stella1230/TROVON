static int nfc_sock_create(struct net *net, struct socket *sock, int proto,\r\nint kern)\r\n{\r\nint rc = -EPROTONOSUPPORT;\r\nif (net != &init_net)\r\nreturn -EAFNOSUPPORT;\r\nif (proto < 0 || proto >= NFC_SOCKPROTO_MAX)\r\nreturn -EINVAL;\r\nread_lock(&proto_tab_lock);\r\nif (proto_tab[proto] && try_module_get(proto_tab[proto]->owner)) {\r\nrc = proto_tab[proto]->create(net, sock, proto_tab[proto], kern);\r\nmodule_put(proto_tab[proto]->owner);\r\n}\r\nread_unlock(&proto_tab_lock);\r\nreturn rc;\r\n}\r\nint nfc_proto_register(const struct nfc_protocol *nfc_proto)\r\n{\r\nint rc;\r\nif (nfc_proto->id < 0 || nfc_proto->id >= NFC_SOCKPROTO_MAX)\r\nreturn -EINVAL;\r\nrc = proto_register(nfc_proto->proto, 0);\r\nif (rc)\r\nreturn rc;\r\nwrite_lock(&proto_tab_lock);\r\nif (proto_tab[nfc_proto->id])\r\nrc = -EBUSY;\r\nelse\r\nproto_tab[nfc_proto->id] = nfc_proto;\r\nwrite_unlock(&proto_tab_lock);\r\nreturn rc;\r\n}\r\nvoid nfc_proto_unregister(const struct nfc_protocol *nfc_proto)\r\n{\r\nwrite_lock(&proto_tab_lock);\r\nproto_tab[nfc_proto->id] = NULL;\r\nwrite_unlock(&proto_tab_lock);\r\nproto_unregister(nfc_proto->proto);\r\n}\r\nint __init af_nfc_init(void)\r\n{\r\nreturn sock_register(&nfc_sock_family_ops);\r\n}\r\nvoid af_nfc_exit(void)\r\n{\r\nsock_unregister(PF_NFC);\r\n}

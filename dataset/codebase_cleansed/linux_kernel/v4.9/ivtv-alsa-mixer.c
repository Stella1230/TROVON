static inline int dB_to_cx25840_vol(int dB)\r\n{\r\nif (dB < -96)\r\ndB = -96;\r\nelse if (dB > 8)\r\ndB = 8;\r\nreturn (dB + 119) << 9;\r\n}\r\nstatic inline int cx25840_vol_to_dB(int v)\r\n{\r\nif (v < (23 << 9))\r\nv = (23 << 9);\r\nelse if (v > (127 << 9))\r\nv = (127 << 9);\r\nreturn (v >> 9) - 119;\r\n}\r\nstatic int snd_ivtv_mixer_tv_vol_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 1;\r\nuinfo->value.integer.min = -96;\r\nuinfo->value.integer.max = 8;\r\nuinfo->value.integer.step = 1;\r\nreturn 0;\r\n}\r\nstatic int snd_ivtv_mixer_tv_vol_get(struct snd_kcontrol *kctl,\r\nstruct snd_ctl_elem_value *uctl)\r\n{\r\nstruct snd_ivtv_card *itvsc = snd_kcontrol_chip(kctl);\r\nstruct ivtv *itv = to_ivtv(itvsc->v4l2_dev);\r\nstruct v4l2_control vctrl;\r\nint ret;\r\nvctrl.id = V4L2_CID_AUDIO_VOLUME;\r\nvctrl.value = dB_to_cx25840_vol(uctl->value.integer.value[0]);\r\nsnd_ivtv_lock(itvsc);\r\nret = v4l2_g_ctrl(itv->sd_audio->ctrl_handler, &vctrl);\r\nsnd_ivtv_unlock(itvsc);\r\nif (!ret)\r\nuctl->value.integer.value[0] = cx25840_vol_to_dB(vctrl.value);\r\nreturn ret;\r\n}\r\nstatic int snd_ivtv_mixer_tv_vol_put(struct snd_kcontrol *kctl,\r\nstruct snd_ctl_elem_value *uctl)\r\n{\r\nstruct snd_ivtv_card *itvsc = snd_kcontrol_chip(kctl);\r\nstruct ivtv *itv = to_ivtv(itvsc->v4l2_dev);\r\nstruct v4l2_control vctrl;\r\nint ret;\r\nvctrl.id = V4L2_CID_AUDIO_VOLUME;\r\nvctrl.value = dB_to_cx25840_vol(uctl->value.integer.value[0]);\r\nsnd_ivtv_lock(itvsc);\r\nret = v4l2_g_ctrl(itv->sd_audio->ctrl_handler, &vctrl);\r\nif (ret ||\r\n(cx25840_vol_to_dB(vctrl.value) != uctl->value.integer.value[0])) {\r\nvctrl.value = dB_to_cx25840_vol(uctl->value.integer.value[0]);\r\nret = v4l2_s_ctrl(itv->sd_audio->ctrl_handler, &vctrl);\r\nif (!ret)\r\nret = 1;\r\n}\r\nsnd_ivtv_unlock(itvsc);\r\nreturn ret;\r\n}\r\nint __init snd_ivtv_mixer_create(struct snd_ivtv_card *itvsc)\r\n{\r\nstruct v4l2_device *v4l2_dev = itvsc->v4l2_dev;\r\nstruct snd_card *sc = itvsc->sc;\r\nint ret;\r\nstrlcpy(sc->mixername, "CX2341[56] Mixer", sizeof(sc->mixername));\r\nret = snd_ctl_add(sc, snd_ctl_new1(snd_ivtv_mixer_tv_vol, itvsc));\r\nif (ret) {\r\nIVTV_ALSA_WARN("%s: failed to add %s control, err %d\n",\r\n__func__, snd_ivtv_mixer_tv_vol.name, ret);\r\n}\r\nreturn ret;\r\n}

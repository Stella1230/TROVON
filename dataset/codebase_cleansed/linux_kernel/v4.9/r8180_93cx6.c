static void eprom_cs(struct net_device *dev, short bit)\r\n{\r\nu8 cmdreg;\r\nint err;\r\nerr = read_nic_byte_E(dev, EPROM_CMD, &cmdreg);\r\nif (err)\r\nreturn;\r\nif (bit)\r\nwrite_nic_byte_E(dev, EPROM_CMD, cmdreg | EPROM_CS_BIT);\r\nelse\r\nwrite_nic_byte_E(dev, EPROM_CMD, cmdreg & ~EPROM_CS_BIT);\r\nforce_pci_posting(dev);\r\nudelay(EPROM_DELAY);\r\n}\r\nstatic void eprom_ck_cycle(struct net_device *dev)\r\n{\r\nu8 cmdreg;\r\nint err;\r\nerr = read_nic_byte_E(dev, EPROM_CMD, &cmdreg);\r\nif (err)\r\nreturn;\r\nwrite_nic_byte_E(dev, EPROM_CMD, cmdreg | EPROM_CK_BIT);\r\nforce_pci_posting(dev);\r\nudelay(EPROM_DELAY);\r\nread_nic_byte_E(dev, EPROM_CMD, &cmdreg);\r\nwrite_nic_byte_E(dev, EPROM_CMD, cmdreg & ~EPROM_CK_BIT);\r\nforce_pci_posting(dev);\r\nudelay(EPROM_DELAY);\r\n}\r\nstatic void eprom_w(struct net_device *dev, short bit)\r\n{\r\nu8 cmdreg;\r\nint err;\r\nerr = read_nic_byte_E(dev, EPROM_CMD, &cmdreg);\r\nif (err)\r\nreturn;\r\nif (bit)\r\nwrite_nic_byte_E(dev, EPROM_CMD, cmdreg | EPROM_W_BIT);\r\nelse\r\nwrite_nic_byte_E(dev, EPROM_CMD, cmdreg & ~EPROM_W_BIT);\r\nforce_pci_posting(dev);\r\nudelay(EPROM_DELAY);\r\n}\r\nstatic short eprom_r(struct net_device *dev)\r\n{\r\nu8 bit;\r\nint err;\r\nerr = read_nic_byte_E(dev, EPROM_CMD, &bit);\r\nif (err)\r\nreturn err;\r\nudelay(EPROM_DELAY);\r\nif (bit & EPROM_R_BIT)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void eprom_send_bits_string(struct net_device *dev, short b[], int len)\r\n{\r\nint i;\r\nfor (i = 0; i < len; i++) {\r\neprom_w(dev, b[i]);\r\neprom_ck_cycle(dev);\r\n}\r\n}\r\nint eprom_read(struct net_device *dev, u32 addr)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nshort read_cmd[] = {1, 1, 0};\r\nshort addr_str[8];\r\nint i;\r\nint addr_len;\r\nu32 ret;\r\nint err;\r\nret = 0;\r\nwrite_nic_byte_E(dev, EPROM_CMD,\r\n(EPROM_CMD_PROGRAM<<EPROM_CMD_OPERATING_MODE_SHIFT));\r\nforce_pci_posting(dev);\r\nudelay(EPROM_DELAY);\r\nif (priv->epromtype == EPROM_93c56) {\r\naddr_str[7] = addr & 1;\r\naddr_str[6] = addr & (1<<1);\r\naddr_str[5] = addr & (1<<2);\r\naddr_str[4] = addr & (1<<3);\r\naddr_str[3] = addr & (1<<4);\r\naddr_str[2] = addr & (1<<5);\r\naddr_str[1] = addr & (1<<6);\r\naddr_str[0] = addr & (1<<7);\r\naddr_len = 8;\r\n} else {\r\naddr_str[5] = addr & 1;\r\naddr_str[4] = addr & (1<<1);\r\naddr_str[3] = addr & (1<<2);\r\naddr_str[2] = addr & (1<<3);\r\naddr_str[1] = addr & (1<<4);\r\naddr_str[0] = addr & (1<<5);\r\naddr_len = 6;\r\n}\r\neprom_cs(dev, 1);\r\neprom_ck_cycle(dev);\r\neprom_send_bits_string(dev, read_cmd, 3);\r\neprom_send_bits_string(dev, addr_str, addr_len);\r\neprom_w(dev, 0);\r\nfor (i = 0; i < 16; i++) {\r\neprom_ck_cycle(dev);\r\nerr = eprom_r(dev);\r\nif (err < 0)\r\nreturn err;\r\nret |= err<<(15-i);\r\n}\r\neprom_cs(dev, 0);\r\neprom_ck_cycle(dev);\r\nwrite_nic_byte_E(dev, EPROM_CMD,\r\n(EPROM_CMD_NORMAL<<EPROM_CMD_OPERATING_MODE_SHIFT));\r\nreturn ret;\r\n}

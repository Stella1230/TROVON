static inline void i40iw_insert_wqe_hdr(u64 *wqe, u64 header)\r\n{\r\nwmb();\r\nset_64bit_val(wqe, 24, header);\r\n}\r\nstatic inline void i40iw_get_cqp_reg_info(struct i40iw_sc_cqp *cqp,\r\nu32 *val,\r\nu32 *tail,\r\nu32 *error)\r\n{\r\nif (cqp->dev->is_pf) {\r\n*val = i40iw_rd32(cqp->dev->hw, I40E_PFPE_CQPTAIL);\r\n*tail = RS_32(*val, I40E_PFPE_CQPTAIL_WQTAIL);\r\n*error = RS_32(*val, I40E_PFPE_CQPTAIL_CQP_OP_ERR);\r\n} else {\r\n*val = i40iw_rd32(cqp->dev->hw, I40E_VFPE_CQPTAIL1);\r\n*tail = RS_32(*val, I40E_VFPE_CQPTAIL_WQTAIL);\r\n*error = RS_32(*val, I40E_VFPE_CQPTAIL_CQP_OP_ERR);\r\n}\r\n}\r\nstatic enum i40iw_status_code i40iw_cqp_poll_registers(\r\nstruct i40iw_sc_cqp *cqp,\r\nu32 tail,\r\nu32 count)\r\n{\r\nu32 i = 0;\r\nu32 newtail, error, val;\r\nwhile (i < count) {\r\ni++;\r\ni40iw_get_cqp_reg_info(cqp, &val, &newtail, &error);\r\nif (error) {\r\nerror = (cqp->dev->is_pf) ?\r\ni40iw_rd32(cqp->dev->hw, I40E_PFPE_CQPERRCODES) :\r\ni40iw_rd32(cqp->dev->hw, I40E_VFPE_CQPERRCODES1);\r\nreturn I40IW_ERR_CQP_COMPL_ERROR;\r\n}\r\nif (newtail != tail) {\r\nI40IW_RING_MOVE_TAIL(cqp->sq_ring);\r\nreturn 0;\r\n}\r\nudelay(I40IW_SLEEP_COUNT);\r\n}\r\nreturn I40IW_ERR_TIMEOUT;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_parse_fpm_commit_buf(\r\nu64 *buf,\r\nstruct i40iw_hmc_obj_info *info,\r\nu32 *sd)\r\n{\r\nu64 temp;\r\nu64 size;\r\nu64 base = 0;\r\nu32 i, j;\r\nu32 k = 0;\r\nu32 low;\r\nfor (i = I40IW_HMC_IW_QP, j = 0;\r\ni <= I40IW_HMC_IW_PBLE; i++, j += 8) {\r\nget_64bit_val(buf, j, &temp);\r\ninfo[i].base = RS_64_1(temp, 32) * 512;\r\nif (info[i].base > base) {\r\nbase = info[i].base;\r\nk = i;\r\n}\r\nlow = (u32)(temp);\r\nif (low)\r\ninfo[i].cnt = low;\r\n}\r\nsize = info[k].cnt * info[k].size + info[k].base;\r\nif (size & 0x1FFFFF)\r\n*sd = (u32)((size >> 21) + 1);\r\nelse\r\n*sd = (u32)(size >> 21);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_parse_fpm_query_buf(\r\nu64 *buf,\r\nstruct i40iw_hmc_info *hmc_info,\r\nstruct i40iw_hmc_fpm_misc *hmc_fpm_misc)\r\n{\r\nu64 temp;\r\nstruct i40iw_hmc_obj_info *obj_info;\r\nu32 i, j, size;\r\nu16 max_pe_sds;\r\nobj_info = hmc_info->hmc_obj;\r\nget_64bit_val(buf, 0, &temp);\r\nhmc_info->first_sd_index = (u16)RS_64(temp, I40IW_QUERY_FPM_FIRST_PE_SD_INDEX);\r\nmax_pe_sds = (u16)RS_64(temp, I40IW_QUERY_FPM_MAX_PE_SDS);\r\nif (hmc_info->hmc_fn_id >= I40IW_FIRST_VF_FPM_ID)\r\nmax_pe_sds--;\r\nhmc_fpm_misc->max_sds = max_pe_sds;\r\nhmc_info->sd_table.sd_cnt = max_pe_sds + hmc_info->first_sd_index;\r\nfor (i = I40IW_HMC_IW_QP, j = 8;\r\ni <= I40IW_HMC_IW_ARP; i++, j += 8) {\r\nget_64bit_val(buf, j, &temp);\r\nif (i == I40IW_HMC_IW_QP)\r\nobj_info[i].max_cnt = (u32)RS_64(temp, I40IW_QUERY_FPM_MAX_QPS);\r\nelse if (i == I40IW_HMC_IW_CQ)\r\nobj_info[i].max_cnt = (u32)RS_64(temp, I40IW_QUERY_FPM_MAX_CQS);\r\nelse\r\nobj_info[i].max_cnt = (u32)temp;\r\nsize = (u32)RS_64_1(temp, 32);\r\nobj_info[i].size = ((u64)1 << size);\r\n}\r\nfor (i = I40IW_HMC_IW_MR, j = 48;\r\ni <= I40IW_HMC_IW_PBLE; i++, j += 8) {\r\nget_64bit_val(buf, j, &temp);\r\nobj_info[i].max_cnt = (u32)temp;\r\nsize = (u32)RS_64_1(temp, 32);\r\nobj_info[i].size = LS_64_1(1, size);\r\n}\r\nget_64bit_val(buf, 120, &temp);\r\nhmc_fpm_misc->max_ceqs = (u8)RS_64(temp, I40IW_QUERY_FPM_MAX_CEQS);\r\nget_64bit_val(buf, 120, &temp);\r\nhmc_fpm_misc->ht_multiplier = RS_64(temp, I40IW_QUERY_FPM_HTMULTIPLIER);\r\nget_64bit_val(buf, 120, &temp);\r\nhmc_fpm_misc->timer_bucket = RS_64(temp, I40IW_QUERY_FPM_TIMERBUCKET);\r\nget_64bit_val(buf, 64, &temp);\r\nhmc_fpm_misc->xf_block_size = RS_64(temp, I40IW_QUERY_FPM_XFBLOCKSIZE);\r\nif (!hmc_fpm_misc->xf_block_size)\r\nreturn I40IW_ERR_INVALID_SIZE;\r\nget_64bit_val(buf, 80, &temp);\r\nhmc_fpm_misc->q1_block_size = RS_64(temp, I40IW_QUERY_FPM_Q1BLOCKSIZE);\r\nif (!hmc_fpm_misc->q1_block_size)\r\nreturn I40IW_ERR_INVALID_SIZE;\r\nreturn 0;\r\n}\r\nstatic void i40iw_sc_pd_init(struct i40iw_sc_dev *dev,\r\nstruct i40iw_sc_pd *pd,\r\nu16 pd_id)\r\n{\r\npd->size = sizeof(*pd);\r\npd->pd_id = pd_id;\r\npd->dev = dev;\r\n}\r\nu8 i40iw_get_encoded_wqe_size(u32 wqsize, bool cqpsq)\r\n{\r\nu8 encoded_size = 0;\r\nif (cqpsq)\r\nencoded_size = 1;\r\nwqsize >>= 2;\r\nwhile (wqsize >>= 1)\r\nencoded_size++;\r\nreturn encoded_size;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_cqp_init(struct i40iw_sc_cqp *cqp,\r\nstruct i40iw_cqp_init_info *info)\r\n{\r\nu8 hw_sq_size;\r\nif ((info->sq_size > I40IW_CQP_SW_SQSIZE_2048) ||\r\n(info->sq_size < I40IW_CQP_SW_SQSIZE_4) ||\r\n((info->sq_size & (info->sq_size - 1))))\r\nreturn I40IW_ERR_INVALID_SIZE;\r\nhw_sq_size = i40iw_get_encoded_wqe_size(info->sq_size, true);\r\ncqp->size = sizeof(*cqp);\r\ncqp->sq_size = info->sq_size;\r\ncqp->hw_sq_size = hw_sq_size;\r\ncqp->sq_base = info->sq;\r\ncqp->host_ctx = info->host_ctx;\r\ncqp->sq_pa = info->sq_pa;\r\ncqp->host_ctx_pa = info->host_ctx_pa;\r\ncqp->dev = info->dev;\r\ncqp->struct_ver = info->struct_ver;\r\ncqp->scratch_array = info->scratch_array;\r\ncqp->polarity = 0;\r\ncqp->en_datacenter_tcp = info->en_datacenter_tcp;\r\ncqp->enabled_vf_count = info->enabled_vf_count;\r\ncqp->hmc_profile = info->hmc_profile;\r\ninfo->dev->cqp = cqp;\r\nI40IW_RING_INIT(cqp->sq_ring, cqp->sq_size);\r\ni40iw_debug(cqp->dev, I40IW_DEBUG_WQE,\r\n"%s: sq_size[%04d] hw_sq_size[%04d] sq_base[%p] sq_pa[%llxh] cqp[%p] polarity[x%04X]\n",\r\n__func__, cqp->sq_size, cqp->hw_sq_size,\r\ncqp->sq_base, cqp->sq_pa, cqp, cqp->polarity);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_cqp_create(struct i40iw_sc_cqp *cqp,\r\nbool disable_pfpdus,\r\nu16 *maj_err,\r\nu16 *min_err)\r\n{\r\nu64 temp;\r\nu32 cnt = 0, p1, p2, val = 0, err_code;\r\nenum i40iw_status_code ret_code;\r\nret_code = i40iw_allocate_dma_mem(cqp->dev->hw,\r\n&cqp->sdbuf,\r\n128,\r\nI40IW_SD_BUF_ALIGNMENT);\r\nif (ret_code)\r\ngoto exit;\r\ntemp = LS_64(cqp->hw_sq_size, I40IW_CQPHC_SQSIZE) |\r\nLS_64(cqp->struct_ver, I40IW_CQPHC_SVER);\r\nif (disable_pfpdus)\r\ntemp |= LS_64(1, I40IW_CQPHC_DISABLE_PFPDUS);\r\nset_64bit_val(cqp->host_ctx, 0, temp);\r\nset_64bit_val(cqp->host_ctx, 8, cqp->sq_pa);\r\ntemp = LS_64(cqp->enabled_vf_count, I40IW_CQPHC_ENABLED_VFS) |\r\nLS_64(cqp->hmc_profile, I40IW_CQPHC_HMC_PROFILE);\r\nset_64bit_val(cqp->host_ctx, 16, temp);\r\nset_64bit_val(cqp->host_ctx, 24, (uintptr_t)cqp);\r\nset_64bit_val(cqp->host_ctx, 32, 0);\r\nset_64bit_val(cqp->host_ctx, 40, 0);\r\nset_64bit_val(cqp->host_ctx, 48, 0);\r\nset_64bit_val(cqp->host_ctx, 56, 0);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "CQP_HOST_CTX",\r\ncqp->host_ctx, I40IW_CQP_CTX_SIZE * 8);\r\np1 = RS_32_1(cqp->host_ctx_pa, 32);\r\np2 = (u32)cqp->host_ctx_pa;\r\nif (cqp->dev->is_pf) {\r\ni40iw_wr32(cqp->dev->hw, I40E_PFPE_CCQPHIGH, p1);\r\ni40iw_wr32(cqp->dev->hw, I40E_PFPE_CCQPLOW, p2);\r\n} else {\r\ni40iw_wr32(cqp->dev->hw, I40E_VFPE_CCQPHIGH1, p1);\r\ni40iw_wr32(cqp->dev->hw, I40E_VFPE_CCQPLOW1, p2);\r\n}\r\ndo {\r\nif (cnt++ > I40IW_DONE_COUNT) {\r\ni40iw_free_dma_mem(cqp->dev->hw, &cqp->sdbuf);\r\nret_code = I40IW_ERR_TIMEOUT;\r\nif (cqp->dev->is_pf)\r\nerr_code = i40iw_rd32(cqp->dev->hw, I40E_PFPE_CQPERRCODES);\r\nelse\r\nerr_code = i40iw_rd32(cqp->dev->hw, I40E_VFPE_CQPERRCODES1);\r\n*min_err = RS_32(err_code, I40E_PFPE_CQPERRCODES_CQP_MINOR_CODE);\r\n*maj_err = RS_32(err_code, I40E_PFPE_CQPERRCODES_CQP_MAJOR_CODE);\r\ngoto exit;\r\n}\r\nudelay(I40IW_SLEEP_COUNT);\r\nif (cqp->dev->is_pf)\r\nval = i40iw_rd32(cqp->dev->hw, I40E_PFPE_CCQPSTATUS);\r\nelse\r\nval = i40iw_rd32(cqp->dev->hw, I40E_VFPE_CCQPSTATUS1);\r\n} while (!val);\r\nexit:\r\nif (!ret_code)\r\ncqp->process_cqp_sds = i40iw_update_sds_noccq;\r\nreturn ret_code;\r\n}\r\nvoid i40iw_sc_cqp_post_sq(struct i40iw_sc_cqp *cqp)\r\n{\r\nif (cqp->dev->is_pf)\r\ni40iw_wr32(cqp->dev->hw, I40E_PFPE_CQPDB, I40IW_RING_GETCURRENT_HEAD(cqp->sq_ring));\r\nelse\r\ni40iw_wr32(cqp->dev->hw, I40E_VFPE_CQPDB1, I40IW_RING_GETCURRENT_HEAD(cqp->sq_ring));\r\ni40iw_debug(cqp->dev,\r\nI40IW_DEBUG_WQE,\r\n"%s: HEAD_TAIL[%04d,%04d,%04d]\n",\r\n__func__,\r\ncqp->sq_ring.head,\r\ncqp->sq_ring.tail,\r\ncqp->sq_ring.size);\r\n}\r\nu64 *i40iw_sc_cqp_get_next_send_wqe(struct i40iw_sc_cqp *cqp, u64 scratch)\r\n{\r\nu64 *wqe = NULL;\r\nu32 wqe_idx;\r\nenum i40iw_status_code ret_code;\r\nif (I40IW_RING_FULL_ERR(cqp->sq_ring)) {\r\ni40iw_debug(cqp->dev,\r\nI40IW_DEBUG_WQE,\r\n"%s: ring is full head %x tail %x size %x\n",\r\n__func__,\r\ncqp->sq_ring.head,\r\ncqp->sq_ring.tail,\r\ncqp->sq_ring.size);\r\nreturn NULL;\r\n}\r\nI40IW_ATOMIC_RING_MOVE_HEAD(cqp->sq_ring, wqe_idx, ret_code);\r\nif (ret_code)\r\nreturn NULL;\r\nif (!wqe_idx)\r\ncqp->polarity = !cqp->polarity;\r\nwqe = cqp->sq_base[wqe_idx].elem;\r\ncqp->scratch_array[wqe_idx] = scratch;\r\nI40IW_CQP_INIT_WQE(wqe);\r\nreturn wqe;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_cqp_destroy(struct i40iw_sc_cqp *cqp)\r\n{\r\nu32 cnt = 0, val = 1;\r\nenum i40iw_status_code ret_code = 0;\r\nu32 cqpstat_addr;\r\nif (cqp->dev->is_pf) {\r\ni40iw_wr32(cqp->dev->hw, I40E_PFPE_CCQPHIGH, 0);\r\ni40iw_wr32(cqp->dev->hw, I40E_PFPE_CCQPLOW, 0);\r\ncqpstat_addr = I40E_PFPE_CCQPSTATUS;\r\n} else {\r\ni40iw_wr32(cqp->dev->hw, I40E_VFPE_CCQPHIGH1, 0);\r\ni40iw_wr32(cqp->dev->hw, I40E_VFPE_CCQPLOW1, 0);\r\ncqpstat_addr = I40E_VFPE_CCQPSTATUS1;\r\n}\r\ndo {\r\nif (cnt++ > I40IW_DONE_COUNT) {\r\nret_code = I40IW_ERR_TIMEOUT;\r\nbreak;\r\n}\r\nudelay(I40IW_SLEEP_COUNT);\r\nval = i40iw_rd32(cqp->dev->hw, cqpstat_addr);\r\n} while (val);\r\ni40iw_free_dma_mem(cqp->dev->hw, &cqp->sdbuf);\r\nreturn ret_code;\r\n}\r\nstatic void i40iw_sc_ccq_arm(struct i40iw_sc_cq *ccq)\r\n{\r\nu64 temp_val;\r\nu16 sw_cq_sel;\r\nu8 arm_next_se;\r\nu8 arm_seq_num;\r\nget_64bit_val(ccq->cq_uk.shadow_area, 32, &temp_val);\r\nsw_cq_sel = (u16)RS_64(temp_val, I40IW_CQ_DBSA_SW_CQ_SELECT);\r\narm_next_se = (u8)RS_64(temp_val, I40IW_CQ_DBSA_ARM_NEXT_SE);\r\narm_seq_num = (u8)RS_64(temp_val, I40IW_CQ_DBSA_ARM_SEQ_NUM);\r\narm_seq_num++;\r\ntemp_val = LS_64(arm_seq_num, I40IW_CQ_DBSA_ARM_SEQ_NUM) |\r\nLS_64(sw_cq_sel, I40IW_CQ_DBSA_SW_CQ_SELECT) |\r\nLS_64(arm_next_se, I40IW_CQ_DBSA_ARM_NEXT_SE) |\r\nLS_64(1, I40IW_CQ_DBSA_ARM_NEXT);\r\nset_64bit_val(ccq->cq_uk.shadow_area, 32, temp_val);\r\nwmb();\r\nif (ccq->dev->is_pf)\r\ni40iw_wr32(ccq->dev->hw, I40E_PFPE_CQARM, ccq->cq_uk.cq_id);\r\nelse\r\ni40iw_wr32(ccq->dev->hw, I40E_VFPE_CQARM1, ccq->cq_uk.cq_id);\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_ccq_get_cqe_info(\r\nstruct i40iw_sc_cq *ccq,\r\nstruct i40iw_ccq_cqe_info *info)\r\n{\r\nu64 qp_ctx, temp, temp1;\r\nu64 *cqe;\r\nstruct i40iw_sc_cqp *cqp;\r\nu32 wqe_idx;\r\nu8 polarity;\r\nenum i40iw_status_code ret_code = 0;\r\nif (ccq->cq_uk.avoid_mem_cflct)\r\ncqe = (u64 *)I40IW_GET_CURRENT_EXTENDED_CQ_ELEMENT(&ccq->cq_uk);\r\nelse\r\ncqe = (u64 *)I40IW_GET_CURRENT_CQ_ELEMENT(&ccq->cq_uk);\r\nget_64bit_val(cqe, 24, &temp);\r\npolarity = (u8)RS_64(temp, I40IW_CQ_VALID);\r\nif (polarity != ccq->cq_uk.polarity)\r\nreturn I40IW_ERR_QUEUE_EMPTY;\r\nget_64bit_val(cqe, 8, &qp_ctx);\r\ncqp = (struct i40iw_sc_cqp *)(unsigned long)qp_ctx;\r\ninfo->error = (bool)RS_64(temp, I40IW_CQ_ERROR);\r\ninfo->min_err_code = (u16)RS_64(temp, I40IW_CQ_MINERR);\r\nif (info->error) {\r\ninfo->maj_err_code = (u16)RS_64(temp, I40IW_CQ_MAJERR);\r\ninfo->min_err_code = (u16)RS_64(temp, I40IW_CQ_MINERR);\r\n}\r\nwqe_idx = (u32)RS_64(temp, I40IW_CQ_WQEIDX);\r\ninfo->scratch = cqp->scratch_array[wqe_idx];\r\nget_64bit_val(cqe, 16, &temp1);\r\ninfo->op_ret_val = (u32)RS_64(temp1, I40IW_CCQ_OPRETVAL);\r\nget_64bit_val(cqp->sq_base[wqe_idx].elem, 24, &temp1);\r\ninfo->op_code = (u8)RS_64(temp1, I40IW_CQPSQ_OPCODE);\r\ninfo->cqp = cqp;\r\nI40IW_RING_MOVE_HEAD(ccq->cq_uk.cq_ring, ret_code);\r\nif (I40IW_RING_GETCURRENT_HEAD(ccq->cq_uk.cq_ring) == 0)\r\nccq->cq_uk.polarity ^= 1;\r\nI40IW_RING_MOVE_TAIL(ccq->cq_uk.cq_ring);\r\nset_64bit_val(ccq->cq_uk.shadow_area,\r\n0,\r\nI40IW_RING_GETCURRENT_HEAD(ccq->cq_uk.cq_ring));\r\nwmb();\r\nI40IW_RING_MOVE_TAIL(cqp->sq_ring);\r\nreturn ret_code;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_poll_for_cqp_op_done(\r\nstruct i40iw_sc_cqp *cqp,\r\nu8 op_code,\r\nstruct i40iw_ccq_cqe_info *compl_info)\r\n{\r\nstruct i40iw_ccq_cqe_info info;\r\nstruct i40iw_sc_cq *ccq;\r\nenum i40iw_status_code ret_code = 0;\r\nu32 cnt = 0;\r\nmemset(&info, 0, sizeof(info));\r\nccq = cqp->dev->ccq;\r\nwhile (1) {\r\nif (cnt++ > I40IW_DONE_COUNT)\r\nreturn I40IW_ERR_TIMEOUT;\r\nif (i40iw_sc_ccq_get_cqe_info(ccq, &info)) {\r\nudelay(I40IW_SLEEP_COUNT);\r\ncontinue;\r\n}\r\nif (info.error) {\r\nret_code = I40IW_ERR_CQP_COMPL_ERROR;\r\nbreak;\r\n}\r\nif (op_code != info.op_code) {\r\ni40iw_debug(cqp->dev, I40IW_DEBUG_WQE,\r\n"%s: opcode mismatch for my op code 0x%x, returned opcode %x\n",\r\n__func__, op_code, info.op_code);\r\n}\r\nif (op_code == info.op_code)\r\nbreak;\r\n}\r\nif (compl_info)\r\nmemcpy(compl_info, &info, sizeof(*compl_info));\r\nreturn ret_code;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_manage_push_page(\r\nstruct i40iw_sc_cqp *cqp,\r\nstruct i40iw_cqp_manage_push_page_info *info,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nif (info->push_idx >= I40IW_MAX_PUSH_PAGE_COUNT)\r\nreturn I40IW_ERR_INVALID_PUSH_PAGE_INDEX;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 16, info->qs_handle);\r\nheader = LS_64(info->push_idx, I40IW_CQPSQ_MPP_PPIDX) |\r\nLS_64(I40IW_CQP_OP_MANAGE_PUSH_PAGES, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID) |\r\nLS_64(info->free_page, I40IW_CQPSQ_MPP_FREE_PAGE);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "MANAGE_PUSH_PAGES WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_manage_hmc_pm_func_table(\r\nstruct i40iw_sc_cqp *cqp,\r\nu64 scratch,\r\nu8 vf_index,\r\nbool free_pm_fcn,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nif (vf_index >= I40IW_MAX_VF_PER_PF)\r\nreturn I40IW_ERR_INVALID_VF_ID;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nheader = LS_64(vf_index, I40IW_CQPSQ_MHMC_VFIDX) |\r\nLS_64(I40IW_CQP_OP_MANAGE_HMC_PM_FUNC_TABLE, I40IW_CQPSQ_OPCODE) |\r\nLS_64(free_pm_fcn, I40IW_CQPSQ_MHMC_FREEPMFN) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "MANAGE_HMC_PM_FUNC_TABLE WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_set_hmc_resource_profile(\r\nstruct i40iw_sc_cqp *cqp,\r\nu64 scratch,\r\nu8 hmc_profile_type,\r\nu8 vf_num, bool post_sq,\r\nbool poll_registers)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nu32 val, tail, error;\r\nenum i40iw_status_code ret_code = 0;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 16,\r\n(LS_64(hmc_profile_type, I40IW_CQPSQ_SHMCRP_HMC_PROFILE) |\r\nLS_64(vf_num, I40IW_CQPSQ_SHMCRP_VFNUM)));\r\nheader = LS_64(I40IW_CQP_OP_SET_HMC_RESOURCE_PROFILE, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "MANAGE_HMC_PM_FUNC_TABLE WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\ni40iw_get_cqp_reg_info(cqp, &val, &tail, &error);\r\nif (error)\r\nreturn I40IW_ERR_CQP_COMPL_ERROR;\r\nif (post_sq) {\r\ni40iw_sc_cqp_post_sq(cqp);\r\nif (poll_registers)\r\nret_code = i40iw_cqp_poll_registers(cqp, tail, 1000000);\r\nelse\r\nret_code = i40iw_sc_poll_for_cqp_op_done(cqp,\r\nI40IW_CQP_OP_SHMC_PAGES_ALLOCATED,\r\nNULL);\r\n}\r\nreturn ret_code;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_manage_hmc_pm_func_table_done(struct i40iw_sc_cqp *cqp)\r\n{\r\nreturn i40iw_sc_poll_for_cqp_op_done(cqp, I40IW_CQP_OP_MANAGE_HMC_PM_FUNC_TABLE, NULL);\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_commit_fpm_values_done(struct i40iw_sc_cqp *cqp)\r\n{\r\nreturn i40iw_sc_poll_for_cqp_op_done(cqp, I40IW_CQP_OP_COMMIT_FPM_VALUES, NULL);\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_commit_fpm_values(\r\nstruct i40iw_sc_cqp *cqp,\r\nu64 scratch,\r\nu8 hmc_fn_id,\r\nstruct i40iw_dma_mem *commit_fpm_mem,\r\nbool post_sq,\r\nu8 wait_type)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nu32 tail, val, error;\r\nenum i40iw_status_code ret_code = 0;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 16, hmc_fn_id);\r\nset_64bit_val(wqe, 32, commit_fpm_mem->pa);\r\nheader = LS_64(I40IW_CQP_OP_COMMIT_FPM_VALUES, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "COMMIT_FPM_VALUES WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\ni40iw_get_cqp_reg_info(cqp, &val, &tail, &error);\r\nif (error)\r\nreturn I40IW_ERR_CQP_COMPL_ERROR;\r\nif (post_sq) {\r\ni40iw_sc_cqp_post_sq(cqp);\r\nif (wait_type == I40IW_CQP_WAIT_POLL_REGS)\r\nret_code = i40iw_cqp_poll_registers(cqp, tail, I40IW_DONE_COUNT);\r\nelse if (wait_type == I40IW_CQP_WAIT_POLL_CQ)\r\nret_code = i40iw_sc_commit_fpm_values_done(cqp);\r\n}\r\nreturn ret_code;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_query_fpm_values_done(struct i40iw_sc_cqp *cqp)\r\n{\r\nreturn i40iw_sc_poll_for_cqp_op_done(cqp, I40IW_CQP_OP_QUERY_FPM_VALUES, NULL);\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_query_fpm_values(\r\nstruct i40iw_sc_cqp *cqp,\r\nu64 scratch,\r\nu8 hmc_fn_id,\r\nstruct i40iw_dma_mem *query_fpm_mem,\r\nbool post_sq,\r\nu8 wait_type)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nu32 tail, val, error;\r\nenum i40iw_status_code ret_code = 0;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 16, hmc_fn_id);\r\nset_64bit_val(wqe, 32, query_fpm_mem->pa);\r\nheader = LS_64(I40IW_CQP_OP_QUERY_FPM_VALUES, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "QUERY_FPM WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\ni40iw_get_cqp_reg_info(cqp, &val, &tail, &error);\r\nif (error)\r\nreturn I40IW_ERR_CQP_COMPL_ERROR;\r\nif (post_sq) {\r\ni40iw_sc_cqp_post_sq(cqp);\r\nif (wait_type == I40IW_CQP_WAIT_POLL_REGS)\r\nret_code = i40iw_cqp_poll_registers(cqp, tail, I40IW_DONE_COUNT);\r\nelse if (wait_type == I40IW_CQP_WAIT_POLL_CQ)\r\nret_code = i40iw_sc_query_fpm_values_done(cqp);\r\n}\r\nreturn ret_code;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_add_arp_cache_entry(\r\nstruct i40iw_sc_cqp *cqp,\r\nstruct i40iw_add_arp_cache_entry_info *info,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nu64 temp, header;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 8, info->reach_max);\r\ntemp = info->mac_addr[5] |\r\nLS_64_1(info->mac_addr[4], 8) |\r\nLS_64_1(info->mac_addr[3], 16) |\r\nLS_64_1(info->mac_addr[2], 24) |\r\nLS_64_1(info->mac_addr[1], 32) |\r\nLS_64_1(info->mac_addr[0], 40);\r\nset_64bit_val(wqe, 16, temp);\r\nheader = info->arp_index |\r\nLS_64(I40IW_CQP_OP_MANAGE_ARP, I40IW_CQPSQ_OPCODE) |\r\nLS_64((info->permanent ? 1 : 0), I40IW_CQPSQ_MAT_PERMANENT) |\r\nLS_64(1, I40IW_CQPSQ_MAT_ENTRYVALID) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "ARP_CACHE_ENTRY WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_del_arp_cache_entry(\r\nstruct i40iw_sc_cqp *cqp,\r\nu64 scratch,\r\nu16 arp_index,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nheader = arp_index |\r\nLS_64(I40IW_CQP_OP_MANAGE_ARP, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "ARP_CACHE_DEL_ENTRY WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_query_arp_cache_entry(\r\nstruct i40iw_sc_cqp *cqp,\r\nu64 scratch,\r\nu16 arp_index,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nheader = arp_index |\r\nLS_64(I40IW_CQP_OP_MANAGE_ARP, I40IW_CQPSQ_OPCODE) |\r\nLS_64(1, I40IW_CQPSQ_MAT_QUERY) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "QUERY_ARP_CACHE_ENTRY WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_manage_apbvt_entry(\r\nstruct i40iw_sc_cqp *cqp,\r\nstruct i40iw_apbvt_info *info,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 16, info->port);\r\nheader = LS_64(I40IW_CQP_OP_MANAGE_APBVT, I40IW_CQPSQ_OPCODE) |\r\nLS_64(info->add, I40IW_CQPSQ_MAPT_ADDPORT) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "MANAGE_APBVT WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_manage_qhash_table_entry(\r\nstruct i40iw_sc_cqp *cqp,\r\nstruct i40iw_qhash_table_info *info,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nu64 qw1 = 0;\r\nu64 qw2 = 0;\r\nu64 temp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\ntemp = info->mac_addr[5] |\r\nLS_64_1(info->mac_addr[4], 8) |\r\nLS_64_1(info->mac_addr[3], 16) |\r\nLS_64_1(info->mac_addr[2], 24) |\r\nLS_64_1(info->mac_addr[1], 32) |\r\nLS_64_1(info->mac_addr[0], 40);\r\nset_64bit_val(wqe, 0, temp);\r\nqw1 = LS_64(info->qp_num, I40IW_CQPSQ_QHASH_QPN) |\r\nLS_64(info->dest_port, I40IW_CQPSQ_QHASH_DEST_PORT);\r\nif (info->ipv4_valid) {\r\nset_64bit_val(wqe,\r\n48,\r\nLS_64(info->dest_ip[0], I40IW_CQPSQ_QHASH_ADDR3));\r\n} else {\r\nset_64bit_val(wqe,\r\n56,\r\nLS_64(info->dest_ip[0], I40IW_CQPSQ_QHASH_ADDR0) |\r\nLS_64(info->dest_ip[1], I40IW_CQPSQ_QHASH_ADDR1));\r\nset_64bit_val(wqe,\r\n48,\r\nLS_64(info->dest_ip[2], I40IW_CQPSQ_QHASH_ADDR2) |\r\nLS_64(info->dest_ip[3], I40IW_CQPSQ_QHASH_ADDR3));\r\n}\r\nqw2 = LS_64(cqp->dev->qs_handle, I40IW_CQPSQ_QHASH_QS_HANDLE);\r\nif (info->vlan_valid)\r\nqw2 |= LS_64(info->vlan_id, I40IW_CQPSQ_QHASH_VLANID);\r\nset_64bit_val(wqe, 16, qw2);\r\nif (info->entry_type == I40IW_QHASH_TYPE_TCP_ESTABLISHED) {\r\nqw1 |= LS_64(info->src_port, I40IW_CQPSQ_QHASH_SRC_PORT);\r\nif (!info->ipv4_valid) {\r\nset_64bit_val(wqe,\r\n40,\r\nLS_64(info->src_ip[0], I40IW_CQPSQ_QHASH_ADDR0) |\r\nLS_64(info->src_ip[1], I40IW_CQPSQ_QHASH_ADDR1));\r\nset_64bit_val(wqe,\r\n32,\r\nLS_64(info->src_ip[2], I40IW_CQPSQ_QHASH_ADDR2) |\r\nLS_64(info->src_ip[3], I40IW_CQPSQ_QHASH_ADDR3));\r\n} else {\r\nset_64bit_val(wqe,\r\n32,\r\nLS_64(info->src_ip[0], I40IW_CQPSQ_QHASH_ADDR3));\r\n}\r\n}\r\nset_64bit_val(wqe, 8, qw1);\r\ntemp = LS_64(cqp->polarity, I40IW_CQPSQ_QHASH_WQEVALID) |\r\nLS_64(I40IW_CQP_OP_MANAGE_QUAD_HASH_TABLE_ENTRY, I40IW_CQPSQ_QHASH_OPCODE) |\r\nLS_64(info->manage, I40IW_CQPSQ_QHASH_MANAGE) |\r\nLS_64(info->ipv4_valid, I40IW_CQPSQ_QHASH_IPV4VALID) |\r\nLS_64(info->vlan_valid, I40IW_CQPSQ_QHASH_VLANVALID) |\r\nLS_64(info->entry_type, I40IW_CQPSQ_QHASH_ENTRYTYPE);\r\ni40iw_insert_wqe_hdr(wqe, temp);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "MANAGE_QHASH WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_alloc_local_mac_ipaddr_entry(\r\nstruct i40iw_sc_cqp *cqp,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nheader = LS_64(I40IW_CQP_OP_ALLOCATE_LOC_MAC_IP_TABLE_ENTRY, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "ALLOCATE_LOCAL_MAC_IPADDR WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_add_local_mac_ipaddr_entry(\r\nstruct i40iw_sc_cqp *cqp,\r\nstruct i40iw_local_mac_ipaddr_entry_info *info,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nu64 temp, header;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\ntemp = info->mac_addr[5] |\r\nLS_64_1(info->mac_addr[4], 8) |\r\nLS_64_1(info->mac_addr[3], 16) |\r\nLS_64_1(info->mac_addr[2], 24) |\r\nLS_64_1(info->mac_addr[1], 32) |\r\nLS_64_1(info->mac_addr[0], 40);\r\nset_64bit_val(wqe, 32, temp);\r\nheader = LS_64(info->entry_idx, I40IW_CQPSQ_MLIPA_IPTABLEIDX) |\r\nLS_64(I40IW_CQP_OP_MANAGE_LOC_MAC_IP_TABLE, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "ADD_LOCAL_MAC_IPADDR WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_del_local_mac_ipaddr_entry(\r\nstruct i40iw_sc_cqp *cqp,\r\nu64 scratch,\r\nu8 entry_idx,\r\nu8 ignore_ref_count,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nheader = LS_64(entry_idx, I40IW_CQPSQ_MLIPA_IPTABLEIDX) |\r\nLS_64(I40IW_CQP_OP_MANAGE_LOC_MAC_IP_TABLE, I40IW_CQPSQ_OPCODE) |\r\nLS_64(1, I40IW_CQPSQ_MLIPA_FREEENTRY) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID) |\r\nLS_64(ignore_ref_count, I40IW_CQPSQ_MLIPA_IGNORE_REF_CNT);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "DEL_LOCAL_MAC_IPADDR WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_cqp_nop(struct i40iw_sc_cqp *cqp,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nheader = LS_64(I40IW_CQP_OP_NOP, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "NOP WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_ceq_init(struct i40iw_sc_ceq *ceq,\r\nstruct i40iw_ceq_init_info *info)\r\n{\r\nu32 pble_obj_cnt;\r\nif ((info->elem_cnt < I40IW_MIN_CEQ_ENTRIES) ||\r\n(info->elem_cnt > I40IW_MAX_CEQ_ENTRIES))\r\nreturn I40IW_ERR_INVALID_SIZE;\r\nif (info->ceq_id >= I40IW_MAX_CEQID)\r\nreturn I40IW_ERR_INVALID_CEQ_ID;\r\npble_obj_cnt = info->dev->hmc_info->hmc_obj[I40IW_HMC_IW_PBLE].cnt;\r\nif (info->virtual_map && (info->first_pm_pbl_idx >= pble_obj_cnt))\r\nreturn I40IW_ERR_INVALID_PBLE_INDEX;\r\nceq->size = sizeof(*ceq);\r\nceq->ceqe_base = (struct i40iw_ceqe *)info->ceqe_base;\r\nceq->ceq_id = info->ceq_id;\r\nceq->dev = info->dev;\r\nceq->elem_cnt = info->elem_cnt;\r\nceq->ceq_elem_pa = info->ceqe_pa;\r\nceq->virtual_map = info->virtual_map;\r\nceq->pbl_chunk_size = (ceq->virtual_map ? info->pbl_chunk_size : 0);\r\nceq->first_pm_pbl_idx = (ceq->virtual_map ? info->first_pm_pbl_idx : 0);\r\nceq->pbl_list = (ceq->virtual_map ? info->pbl_list : NULL);\r\nceq->tph_en = info->tph_en;\r\nceq->tph_val = info->tph_val;\r\nceq->polarity = 1;\r\nI40IW_RING_INIT(ceq->ceq_ring, ceq->elem_cnt);\r\nceq->dev->ceq[info->ceq_id] = ceq;\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_ceq_create(struct i40iw_sc_ceq *ceq,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 *wqe;\r\nu64 header;\r\ncqp = ceq->dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 16, ceq->elem_cnt);\r\nset_64bit_val(wqe, 32, (ceq->virtual_map ? 0 : ceq->ceq_elem_pa));\r\nset_64bit_val(wqe, 48, (ceq->virtual_map ? ceq->first_pm_pbl_idx : 0));\r\nset_64bit_val(wqe, 56, LS_64(ceq->tph_val, I40IW_CQPSQ_TPHVAL));\r\nheader = ceq->ceq_id |\r\nLS_64(I40IW_CQP_OP_CREATE_CEQ, I40IW_CQPSQ_OPCODE) |\r\nLS_64(ceq->pbl_chunk_size, I40IW_CQPSQ_CEQ_LPBLSIZE) |\r\nLS_64(ceq->virtual_map, I40IW_CQPSQ_CEQ_VMAP) |\r\nLS_64(ceq->tph_en, I40IW_CQPSQ_TPHEN) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "CEQ_CREATE WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_cceq_create_done(struct i40iw_sc_ceq *ceq)\r\n{\r\nstruct i40iw_sc_cqp *cqp;\r\ncqp = ceq->dev->cqp;\r\nreturn i40iw_sc_poll_for_cqp_op_done(cqp, I40IW_CQP_OP_CREATE_CEQ, NULL);\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_cceq_destroy_done(struct i40iw_sc_ceq *ceq)\r\n{\r\nstruct i40iw_sc_cqp *cqp;\r\ncqp = ceq->dev->cqp;\r\ncqp->process_cqp_sds = i40iw_update_sds_noccq;\r\nreturn i40iw_sc_poll_for_cqp_op_done(cqp, I40IW_CQP_OP_DESTROY_CEQ, NULL);\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_cceq_create(struct i40iw_sc_ceq *ceq, u64 scratch)\r\n{\r\nenum i40iw_status_code ret_code;\r\nret_code = i40iw_sc_ceq_create(ceq, scratch, true);\r\nif (!ret_code)\r\nret_code = i40iw_sc_cceq_create_done(ceq);\r\nreturn ret_code;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_ceq_destroy(struct i40iw_sc_ceq *ceq,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 *wqe;\r\nu64 header;\r\ncqp = ceq->dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 16, ceq->elem_cnt);\r\nset_64bit_val(wqe, 48, ceq->first_pm_pbl_idx);\r\nheader = ceq->ceq_id |\r\nLS_64(I40IW_CQP_OP_DESTROY_CEQ, I40IW_CQPSQ_OPCODE) |\r\nLS_64(ceq->pbl_chunk_size, I40IW_CQPSQ_CEQ_LPBLSIZE) |\r\nLS_64(ceq->virtual_map, I40IW_CQPSQ_CEQ_VMAP) |\r\nLS_64(ceq->tph_en, I40IW_CQPSQ_TPHEN) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "CEQ_DESTROY WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic void *i40iw_sc_process_ceq(struct i40iw_sc_dev *dev, struct i40iw_sc_ceq *ceq)\r\n{\r\nu64 temp;\r\nu64 *ceqe;\r\nstruct i40iw_sc_cq *cq = NULL;\r\nu8 polarity;\r\nceqe = (u64 *)I40IW_GET_CURRENT_CEQ_ELEMENT(ceq);\r\nget_64bit_val(ceqe, 0, &temp);\r\npolarity = (u8)RS_64(temp, I40IW_CEQE_VALID);\r\nif (polarity != ceq->polarity)\r\nreturn cq;\r\ncq = (struct i40iw_sc_cq *)(unsigned long)LS_64_1(temp, 1);\r\nI40IW_RING_MOVE_TAIL(ceq->ceq_ring);\r\nif (I40IW_RING_GETCURRENT_TAIL(ceq->ceq_ring) == 0)\r\nceq->polarity ^= 1;\r\nif (dev->is_pf)\r\ni40iw_wr32(dev->hw, I40E_PFPE_CQACK, cq->cq_uk.cq_id);\r\nelse\r\ni40iw_wr32(dev->hw, I40E_VFPE_CQACK1, cq->cq_uk.cq_id);\r\nreturn cq;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_aeq_init(struct i40iw_sc_aeq *aeq,\r\nstruct i40iw_aeq_init_info *info)\r\n{\r\nu32 pble_obj_cnt;\r\nif ((info->elem_cnt < I40IW_MIN_AEQ_ENTRIES) ||\r\n(info->elem_cnt > I40IW_MAX_AEQ_ENTRIES))\r\nreturn I40IW_ERR_INVALID_SIZE;\r\npble_obj_cnt = info->dev->hmc_info->hmc_obj[I40IW_HMC_IW_PBLE].cnt;\r\nif (info->virtual_map && (info->first_pm_pbl_idx >= pble_obj_cnt))\r\nreturn I40IW_ERR_INVALID_PBLE_INDEX;\r\naeq->size = sizeof(*aeq);\r\naeq->polarity = 1;\r\naeq->aeqe_base = (struct i40iw_sc_aeqe *)info->aeqe_base;\r\naeq->dev = info->dev;\r\naeq->elem_cnt = info->elem_cnt;\r\naeq->aeq_elem_pa = info->aeq_elem_pa;\r\nI40IW_RING_INIT(aeq->aeq_ring, aeq->elem_cnt);\r\ninfo->dev->aeq = aeq;\r\naeq->virtual_map = info->virtual_map;\r\naeq->pbl_list = (aeq->virtual_map ? info->pbl_list : NULL);\r\naeq->pbl_chunk_size = (aeq->virtual_map ? info->pbl_chunk_size : 0);\r\naeq->first_pm_pbl_idx = (aeq->virtual_map ? info->first_pm_pbl_idx : 0);\r\ninfo->dev->aeq = aeq;\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_aeq_create(struct i40iw_sc_aeq *aeq,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 header;\r\ncqp = aeq->dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 16, aeq->elem_cnt);\r\nset_64bit_val(wqe, 32,\r\n(aeq->virtual_map ? 0 : aeq->aeq_elem_pa));\r\nset_64bit_val(wqe, 48,\r\n(aeq->virtual_map ? aeq->first_pm_pbl_idx : 0));\r\nheader = LS_64(I40IW_CQP_OP_CREATE_AEQ, I40IW_CQPSQ_OPCODE) |\r\nLS_64(aeq->pbl_chunk_size, I40IW_CQPSQ_AEQ_LPBLSIZE) |\r\nLS_64(aeq->virtual_map, I40IW_CQPSQ_AEQ_VMAP) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "AEQ_CREATE WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_aeq_destroy(struct i40iw_sc_aeq *aeq,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 header;\r\ncqp = aeq->dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 16, aeq->elem_cnt);\r\nset_64bit_val(wqe, 48, aeq->first_pm_pbl_idx);\r\nheader = LS_64(I40IW_CQP_OP_DESTROY_AEQ, I40IW_CQPSQ_OPCODE) |\r\nLS_64(aeq->pbl_chunk_size, I40IW_CQPSQ_AEQ_LPBLSIZE) |\r\nLS_64(aeq->virtual_map, I40IW_CQPSQ_AEQ_VMAP) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "AEQ_DESTROY WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_get_next_aeqe(struct i40iw_sc_aeq *aeq,\r\nstruct i40iw_aeqe_info *info)\r\n{\r\nu64 temp, compl_ctx;\r\nu64 *aeqe;\r\nu16 wqe_idx;\r\nu8 ae_src;\r\nu8 polarity;\r\naeqe = (u64 *)I40IW_GET_CURRENT_AEQ_ELEMENT(aeq);\r\nget_64bit_val(aeqe, 0, &compl_ctx);\r\nget_64bit_val(aeqe, 8, &temp);\r\npolarity = (u8)RS_64(temp, I40IW_AEQE_VALID);\r\nif (aeq->polarity != polarity)\r\nreturn I40IW_ERR_QUEUE_EMPTY;\r\ni40iw_debug_buf(aeq->dev, I40IW_DEBUG_WQE, "AEQ_ENTRY", aeqe, 16);\r\nae_src = (u8)RS_64(temp, I40IW_AEQE_AESRC);\r\nwqe_idx = (u16)RS_64(temp, I40IW_AEQE_WQDESCIDX);\r\ninfo->qp_cq_id = (u32)RS_64(temp, I40IW_AEQE_QPCQID);\r\ninfo->ae_id = (u16)RS_64(temp, I40IW_AEQE_AECODE);\r\ninfo->tcp_state = (u8)RS_64(temp, I40IW_AEQE_TCPSTATE);\r\ninfo->iwarp_state = (u8)RS_64(temp, I40IW_AEQE_IWSTATE);\r\ninfo->q2_data_written = (u8)RS_64(temp, I40IW_AEQE_Q2DATA);\r\ninfo->aeqe_overflow = (bool)RS_64(temp, I40IW_AEQE_OVERFLOW);\r\nswitch (ae_src) {\r\ncase I40IW_AE_SOURCE_RQ:\r\ncase I40IW_AE_SOURCE_RQ_0011:\r\ninfo->qp = true;\r\ninfo->wqe_idx = wqe_idx;\r\ninfo->compl_ctx = compl_ctx;\r\nbreak;\r\ncase I40IW_AE_SOURCE_CQ:\r\ncase I40IW_AE_SOURCE_CQ_0110:\r\ncase I40IW_AE_SOURCE_CQ_1010:\r\ncase I40IW_AE_SOURCE_CQ_1110:\r\ninfo->cq = true;\r\ninfo->compl_ctx = LS_64_1(compl_ctx, 1);\r\nbreak;\r\ncase I40IW_AE_SOURCE_SQ:\r\ncase I40IW_AE_SOURCE_SQ_0111:\r\ninfo->qp = true;\r\ninfo->sq = true;\r\ninfo->wqe_idx = wqe_idx;\r\ninfo->compl_ctx = compl_ctx;\r\nbreak;\r\ncase I40IW_AE_SOURCE_IN_RR_WR:\r\ncase I40IW_AE_SOURCE_IN_RR_WR_1011:\r\ninfo->qp = true;\r\ninfo->compl_ctx = compl_ctx;\r\ninfo->in_rdrsp_wr = true;\r\nbreak;\r\ncase I40IW_AE_SOURCE_OUT_RR:\r\ncase I40IW_AE_SOURCE_OUT_RR_1111:\r\ninfo->qp = true;\r\ninfo->compl_ctx = compl_ctx;\r\ninfo->out_rdrsp = true;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nI40IW_RING_MOVE_TAIL(aeq->aeq_ring);\r\nif (I40IW_RING_GETCURRENT_TAIL(aeq->aeq_ring) == 0)\r\naeq->polarity ^= 1;\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_repost_aeq_entries(struct i40iw_sc_dev *dev,\r\nu32 count)\r\n{\r\nif (count > I40IW_MAX_AEQ_ALLOCATE_COUNT)\r\nreturn I40IW_ERR_INVALID_SIZE;\r\nif (dev->is_pf)\r\ni40iw_wr32(dev->hw, I40E_PFPE_AEQALLOC, count);\r\nelse\r\ni40iw_wr32(dev->hw, I40E_VFPE_AEQALLOC1, count);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_aeq_create_done(struct i40iw_sc_aeq *aeq)\r\n{\r\nstruct i40iw_sc_cqp *cqp;\r\ncqp = aeq->dev->cqp;\r\nreturn i40iw_sc_poll_for_cqp_op_done(cqp, I40IW_CQP_OP_CREATE_AEQ, NULL);\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_aeq_destroy_done(struct i40iw_sc_aeq *aeq)\r\n{\r\nstruct i40iw_sc_cqp *cqp;\r\ncqp = aeq->dev->cqp;\r\nreturn i40iw_sc_poll_for_cqp_op_done(cqp, I40IW_CQP_OP_DESTROY_AEQ, NULL);\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_ccq_init(struct i40iw_sc_cq *cq,\r\nstruct i40iw_ccq_init_info *info)\r\n{\r\nu32 pble_obj_cnt;\r\nif (info->num_elem < I40IW_MIN_CQ_SIZE || info->num_elem > I40IW_MAX_CQ_SIZE)\r\nreturn I40IW_ERR_INVALID_SIZE;\r\nif (info->ceq_id > I40IW_MAX_CEQID)\r\nreturn I40IW_ERR_INVALID_CEQ_ID;\r\npble_obj_cnt = info->dev->hmc_info->hmc_obj[I40IW_HMC_IW_PBLE].cnt;\r\nif (info->virtual_map && (info->first_pm_pbl_idx >= pble_obj_cnt))\r\nreturn I40IW_ERR_INVALID_PBLE_INDEX;\r\ncq->cq_pa = info->cq_pa;\r\ncq->cq_uk.cq_base = info->cq_base;\r\ncq->shadow_area_pa = info->shadow_area_pa;\r\ncq->cq_uk.shadow_area = info->shadow_area;\r\ncq->shadow_read_threshold = info->shadow_read_threshold;\r\ncq->dev = info->dev;\r\ncq->ceq_id = info->ceq_id;\r\ncq->cq_uk.cq_size = info->num_elem;\r\ncq->cq_type = I40IW_CQ_TYPE_CQP;\r\ncq->ceqe_mask = info->ceqe_mask;\r\nI40IW_RING_INIT(cq->cq_uk.cq_ring, info->num_elem);\r\ncq->cq_uk.cq_id = 0;\r\ncq->ceq_id_valid = info->ceq_id_valid;\r\ncq->tph_en = info->tph_en;\r\ncq->tph_val = info->tph_val;\r\ncq->cq_uk.avoid_mem_cflct = info->avoid_mem_cflct;\r\ncq->pbl_list = info->pbl_list;\r\ncq->virtual_map = info->virtual_map;\r\ncq->pbl_chunk_size = info->pbl_chunk_size;\r\ncq->first_pm_pbl_idx = info->first_pm_pbl_idx;\r\ncq->cq_uk.polarity = true;\r\ncq->cq_uk.cqe_alloc_reg = NULL;\r\ninfo->dev->ccq = cq;\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_ccq_create_done(struct i40iw_sc_cq *ccq)\r\n{\r\nstruct i40iw_sc_cqp *cqp;\r\ncqp = ccq->dev->cqp;\r\nreturn i40iw_sc_poll_for_cqp_op_done(cqp, I40IW_CQP_OP_CREATE_CQ, NULL);\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_ccq_create(struct i40iw_sc_cq *ccq,\r\nu64 scratch,\r\nbool check_overflow,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 header;\r\nenum i40iw_status_code ret_code;\r\ncqp = ccq->dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 0, ccq->cq_uk.cq_size);\r\nset_64bit_val(wqe, 8, RS_64_1(ccq, 1));\r\nset_64bit_val(wqe, 16,\r\nLS_64(ccq->shadow_read_threshold, I40IW_CQPSQ_CQ_SHADOW_READ_THRESHOLD));\r\nset_64bit_val(wqe, 32, (ccq->virtual_map ? 0 : ccq->cq_pa));\r\nset_64bit_val(wqe, 40, ccq->shadow_area_pa);\r\nset_64bit_val(wqe, 48,\r\n(ccq->virtual_map ? ccq->first_pm_pbl_idx : 0));\r\nset_64bit_val(wqe, 56,\r\nLS_64(ccq->tph_val, I40IW_CQPSQ_TPHVAL));\r\nheader = ccq->cq_uk.cq_id |\r\nLS_64((ccq->ceq_id_valid ? ccq->ceq_id : 0), I40IW_CQPSQ_CQ_CEQID) |\r\nLS_64(I40IW_CQP_OP_CREATE_CQ, I40IW_CQPSQ_OPCODE) |\r\nLS_64(ccq->pbl_chunk_size, I40IW_CQPSQ_CQ_LPBLSIZE) |\r\nLS_64(check_overflow, I40IW_CQPSQ_CQ_CHKOVERFLOW) |\r\nLS_64(ccq->virtual_map, I40IW_CQPSQ_CQ_VIRTMAP) |\r\nLS_64(ccq->ceqe_mask, I40IW_CQPSQ_CQ_ENCEQEMASK) |\r\nLS_64(ccq->ceq_id_valid, I40IW_CQPSQ_CQ_CEQIDVALID) |\r\nLS_64(ccq->tph_en, I40IW_CQPSQ_TPHEN) |\r\nLS_64(ccq->cq_uk.avoid_mem_cflct, I40IW_CQPSQ_CQ_AVOIDMEMCNFLCT) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "CCQ_CREATE WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq) {\r\ni40iw_sc_cqp_post_sq(cqp);\r\nret_code = i40iw_sc_ccq_create_done(ccq);\r\nif (ret_code)\r\nreturn ret_code;\r\n}\r\ncqp->process_cqp_sds = i40iw_cqp_sds_cmd;\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_ccq_destroy(struct i40iw_sc_cq *ccq,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 *wqe;\r\nu64 header;\r\nenum i40iw_status_code ret_code = 0;\r\nu32 tail, val, error;\r\ncqp = ccq->dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 0, ccq->cq_uk.cq_size);\r\nset_64bit_val(wqe, 8, RS_64_1(ccq, 1));\r\nset_64bit_val(wqe, 40, ccq->shadow_area_pa);\r\nheader = ccq->cq_uk.cq_id |\r\nLS_64((ccq->ceq_id_valid ? ccq->ceq_id : 0), I40IW_CQPSQ_CQ_CEQID) |\r\nLS_64(I40IW_CQP_OP_DESTROY_CQ, I40IW_CQPSQ_OPCODE) |\r\nLS_64(ccq->ceqe_mask, I40IW_CQPSQ_CQ_ENCEQEMASK) |\r\nLS_64(ccq->ceq_id_valid, I40IW_CQPSQ_CQ_CEQIDVALID) |\r\nLS_64(ccq->tph_en, I40IW_CQPSQ_TPHEN) |\r\nLS_64(ccq->cq_uk.avoid_mem_cflct, I40IW_CQPSQ_CQ_AVOIDMEMCNFLCT) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "CCQ_DESTROY WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\ni40iw_get_cqp_reg_info(cqp, &val, &tail, &error);\r\nif (error)\r\nreturn I40IW_ERR_CQP_COMPL_ERROR;\r\nif (post_sq) {\r\ni40iw_sc_cqp_post_sq(cqp);\r\nret_code = i40iw_cqp_poll_registers(cqp, tail, 1000);\r\n}\r\nreturn ret_code;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_cq_init(struct i40iw_sc_cq *cq,\r\nstruct i40iw_cq_init_info *info)\r\n{\r\nu32 __iomem *cqe_alloc_reg = NULL;\r\nenum i40iw_status_code ret_code;\r\nu32 pble_obj_cnt;\r\nu32 arm_offset;\r\npble_obj_cnt = info->dev->hmc_info->hmc_obj[I40IW_HMC_IW_PBLE].cnt;\r\nif (info->virtual_map && (info->first_pm_pbl_idx >= pble_obj_cnt))\r\nreturn I40IW_ERR_INVALID_PBLE_INDEX;\r\ncq->cq_pa = info->cq_base_pa;\r\ncq->dev = info->dev;\r\ncq->ceq_id = info->ceq_id;\r\narm_offset = (info->dev->is_pf) ? I40E_PFPE_CQARM : I40E_VFPE_CQARM1;\r\nif (i40iw_get_hw_addr(cq->dev))\r\ncqe_alloc_reg = (u32 __iomem *)(i40iw_get_hw_addr(cq->dev) +\r\narm_offset);\r\ninfo->cq_uk_init_info.cqe_alloc_reg = cqe_alloc_reg;\r\nret_code = i40iw_cq_uk_init(&cq->cq_uk, &info->cq_uk_init_info);\r\nif (ret_code)\r\nreturn ret_code;\r\ncq->virtual_map = info->virtual_map;\r\ncq->pbl_chunk_size = info->pbl_chunk_size;\r\ncq->ceqe_mask = info->ceqe_mask;\r\ncq->cq_type = (info->type) ? info->type : I40IW_CQ_TYPE_IWARP;\r\ncq->shadow_area_pa = info->shadow_area_pa;\r\ncq->shadow_read_threshold = info->shadow_read_threshold;\r\ncq->ceq_id_valid = info->ceq_id_valid;\r\ncq->tph_en = info->tph_en;\r\ncq->tph_val = info->tph_val;\r\ncq->first_pm_pbl_idx = info->first_pm_pbl_idx;\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_cq_create(struct i40iw_sc_cq *cq,\r\nu64 scratch,\r\nbool check_overflow,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 header;\r\nif (cq->cq_uk.cq_id > I40IW_MAX_CQID)\r\nreturn I40IW_ERR_INVALID_CQ_ID;\r\nif (cq->ceq_id > I40IW_MAX_CEQID)\r\nreturn I40IW_ERR_INVALID_CEQ_ID;\r\ncqp = cq->dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 0, cq->cq_uk.cq_size);\r\nset_64bit_val(wqe, 8, RS_64_1(cq, 1));\r\nset_64bit_val(wqe,\r\n16,\r\nLS_64(cq->shadow_read_threshold, I40IW_CQPSQ_CQ_SHADOW_READ_THRESHOLD));\r\nset_64bit_val(wqe, 32, (cq->virtual_map ? 0 : cq->cq_pa));\r\nset_64bit_val(wqe, 40, cq->shadow_area_pa);\r\nset_64bit_val(wqe, 48, (cq->virtual_map ? cq->first_pm_pbl_idx : 0));\r\nset_64bit_val(wqe, 56, LS_64(cq->tph_val, I40IW_CQPSQ_TPHVAL));\r\nheader = cq->cq_uk.cq_id |\r\nLS_64((cq->ceq_id_valid ? cq->ceq_id : 0), I40IW_CQPSQ_CQ_CEQID) |\r\nLS_64(I40IW_CQP_OP_CREATE_CQ, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cq->pbl_chunk_size, I40IW_CQPSQ_CQ_LPBLSIZE) |\r\nLS_64(check_overflow, I40IW_CQPSQ_CQ_CHKOVERFLOW) |\r\nLS_64(cq->virtual_map, I40IW_CQPSQ_CQ_VIRTMAP) |\r\nLS_64(cq->ceqe_mask, I40IW_CQPSQ_CQ_ENCEQEMASK) |\r\nLS_64(cq->ceq_id_valid, I40IW_CQPSQ_CQ_CEQIDVALID) |\r\nLS_64(cq->tph_en, I40IW_CQPSQ_TPHEN) |\r\nLS_64(cq->cq_uk.avoid_mem_cflct, I40IW_CQPSQ_CQ_AVOIDMEMCNFLCT) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "CQ_CREATE WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_cq_destroy(struct i40iw_sc_cq *cq,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 *wqe;\r\nu64 header;\r\ncqp = cq->dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 0, cq->cq_uk.cq_size);\r\nset_64bit_val(wqe, 8, RS_64_1(cq, 1));\r\nset_64bit_val(wqe, 40, cq->shadow_area_pa);\r\nset_64bit_val(wqe, 48, (cq->virtual_map ? cq->first_pm_pbl_idx : 0));\r\nheader = cq->cq_uk.cq_id |\r\nLS_64((cq->ceq_id_valid ? cq->ceq_id : 0), I40IW_CQPSQ_CQ_CEQID) |\r\nLS_64(I40IW_CQP_OP_DESTROY_CQ, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cq->pbl_chunk_size, I40IW_CQPSQ_CQ_LPBLSIZE) |\r\nLS_64(cq->virtual_map, I40IW_CQPSQ_CQ_VIRTMAP) |\r\nLS_64(cq->ceqe_mask, I40IW_CQPSQ_CQ_ENCEQEMASK) |\r\nLS_64(cq->ceq_id_valid, I40IW_CQPSQ_CQ_CEQIDVALID) |\r\nLS_64(cq->tph_en, I40IW_CQPSQ_TPHEN) |\r\nLS_64(cq->cq_uk.avoid_mem_cflct, I40IW_CQPSQ_CQ_AVOIDMEMCNFLCT) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "CQ_DESTROY WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_cq_modify(struct i40iw_sc_cq *cq,\r\nstruct i40iw_modify_cq_info *info,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 *wqe;\r\nu64 header;\r\nu32 cq_size, ceq_id, first_pm_pbl_idx;\r\nu8 pbl_chunk_size;\r\nbool virtual_map, ceq_id_valid, check_overflow;\r\nu32 pble_obj_cnt;\r\nif (info->ceq_valid && (info->ceq_id > I40IW_MAX_CEQID))\r\nreturn I40IW_ERR_INVALID_CEQ_ID;\r\npble_obj_cnt = cq->dev->hmc_info->hmc_obj[I40IW_HMC_IW_PBLE].cnt;\r\nif (info->cq_resize && info->virtual_map &&\r\n(info->first_pm_pbl_idx >= pble_obj_cnt))\r\nreturn I40IW_ERR_INVALID_PBLE_INDEX;\r\ncqp = cq->dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\ncq->pbl_list = info->pbl_list;\r\ncq->cq_pa = info->cq_pa;\r\ncq->first_pm_pbl_idx = info->first_pm_pbl_idx;\r\ncq_size = info->cq_resize ? info->cq_size : cq->cq_uk.cq_size;\r\nif (info->ceq_change) {\r\nceq_id_valid = true;\r\nceq_id = info->ceq_id;\r\n} else {\r\nceq_id_valid = cq->ceq_id_valid;\r\nceq_id = ceq_id_valid ? cq->ceq_id : 0;\r\n}\r\nvirtual_map = info->cq_resize ? info->virtual_map : cq->virtual_map;\r\nfirst_pm_pbl_idx = (info->cq_resize ?\r\n(info->virtual_map ? info->first_pm_pbl_idx : 0) :\r\n(cq->virtual_map ? cq->first_pm_pbl_idx : 0));\r\npbl_chunk_size = (info->cq_resize ?\r\n(info->virtual_map ? info->pbl_chunk_size : 0) :\r\n(cq->virtual_map ? cq->pbl_chunk_size : 0));\r\ncheck_overflow = info->check_overflow_change ? info->check_overflow :\r\ncq->check_overflow;\r\ncq->cq_uk.cq_size = cq_size;\r\ncq->ceq_id_valid = ceq_id_valid;\r\ncq->ceq_id = ceq_id;\r\ncq->virtual_map = virtual_map;\r\ncq->first_pm_pbl_idx = first_pm_pbl_idx;\r\ncq->pbl_chunk_size = pbl_chunk_size;\r\ncq->check_overflow = check_overflow;\r\nset_64bit_val(wqe, 0, cq_size);\r\nset_64bit_val(wqe, 8, RS_64_1(cq, 1));\r\nset_64bit_val(wqe, 16,\r\nLS_64(info->shadow_read_threshold, I40IW_CQPSQ_CQ_SHADOW_READ_THRESHOLD));\r\nset_64bit_val(wqe, 32, (cq->virtual_map ? 0 : cq->cq_pa));\r\nset_64bit_val(wqe, 40, cq->shadow_area_pa);\r\nset_64bit_val(wqe, 48, (cq->virtual_map ? first_pm_pbl_idx : 0));\r\nset_64bit_val(wqe, 56, LS_64(cq->tph_val, I40IW_CQPSQ_TPHVAL));\r\nheader = cq->cq_uk.cq_id |\r\nLS_64(ceq_id, I40IW_CQPSQ_CQ_CEQID) |\r\nLS_64(I40IW_CQP_OP_MODIFY_CQ, I40IW_CQPSQ_OPCODE) |\r\nLS_64(info->cq_resize, I40IW_CQPSQ_CQ_CQRESIZE) |\r\nLS_64(pbl_chunk_size, I40IW_CQPSQ_CQ_LPBLSIZE) |\r\nLS_64(check_overflow, I40IW_CQPSQ_CQ_CHKOVERFLOW) |\r\nLS_64(virtual_map, I40IW_CQPSQ_CQ_VIRTMAP) |\r\nLS_64(cq->ceqe_mask, I40IW_CQPSQ_CQ_ENCEQEMASK) |\r\nLS_64(ceq_id_valid, I40IW_CQPSQ_CQ_CEQIDVALID) |\r\nLS_64(cq->tph_en, I40IW_CQPSQ_TPHEN) |\r\nLS_64(cq->cq_uk.avoid_mem_cflct, I40IW_CQPSQ_CQ_AVOIDMEMCNFLCT) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "CQ_MODIFY WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_qp_init(struct i40iw_sc_qp *qp,\r\nstruct i40iw_qp_init_info *info)\r\n{\r\nu32 __iomem *wqe_alloc_reg = NULL;\r\nenum i40iw_status_code ret_code;\r\nu32 pble_obj_cnt;\r\nu8 wqe_size;\r\nu32 offset;\r\nqp->dev = info->pd->dev;\r\nqp->sq_pa = info->sq_pa;\r\nqp->rq_pa = info->rq_pa;\r\nqp->hw_host_ctx_pa = info->host_ctx_pa;\r\nqp->q2_pa = info->q2_pa;\r\nqp->shadow_area_pa = info->shadow_area_pa;\r\nqp->q2_buf = info->q2;\r\nqp->pd = info->pd;\r\nqp->hw_host_ctx = info->host_ctx;\r\noffset = (qp->pd->dev->is_pf) ? I40E_PFPE_WQEALLOC : I40E_VFPE_WQEALLOC1;\r\nif (i40iw_get_hw_addr(qp->pd->dev))\r\nwqe_alloc_reg = (u32 __iomem *)(i40iw_get_hw_addr(qp->pd->dev) +\r\noffset);\r\ninfo->qp_uk_init_info.wqe_alloc_reg = wqe_alloc_reg;\r\nret_code = i40iw_qp_uk_init(&qp->qp_uk, &info->qp_uk_init_info);\r\nif (ret_code)\r\nreturn ret_code;\r\nqp->virtual_map = info->virtual_map;\r\npble_obj_cnt = info->pd->dev->hmc_info->hmc_obj[I40IW_HMC_IW_PBLE].cnt;\r\nif ((info->virtual_map && (info->sq_pa >= pble_obj_cnt)) ||\r\n(info->virtual_map && (info->rq_pa >= pble_obj_cnt)))\r\nreturn I40IW_ERR_INVALID_PBLE_INDEX;\r\nqp->llp_stream_handle = (void *)(-1);\r\nqp->qp_type = (info->type) ? info->type : I40IW_QP_TYPE_IWARP;\r\nqp->hw_sq_size = i40iw_get_encoded_wqe_size(qp->qp_uk.sq_ring.size,\r\nfalse);\r\ni40iw_debug(qp->dev, I40IW_DEBUG_WQE, "%s: hw_sq_size[%04d] sq_ring.size[%04d]\n",\r\n__func__, qp->hw_sq_size, qp->qp_uk.sq_ring.size);\r\nret_code = i40iw_fragcnt_to_wqesize_rq(qp->qp_uk.max_rq_frag_cnt,\r\n&wqe_size);\r\nif (ret_code)\r\nreturn ret_code;\r\nqp->hw_rq_size = i40iw_get_encoded_wqe_size(qp->qp_uk.rq_size *\r\n(wqe_size / I40IW_QP_WQE_MIN_SIZE), false);\r\ni40iw_debug(qp->dev, I40IW_DEBUG_WQE,\r\n"%s: hw_rq_size[%04d] qp_uk.rq_size[%04d] wqe_size[%04d]\n",\r\n__func__, qp->hw_rq_size, qp->qp_uk.rq_size, wqe_size);\r\nqp->sq_tph_val = info->sq_tph_val;\r\nqp->rq_tph_val = info->rq_tph_val;\r\nqp->sq_tph_en = info->sq_tph_en;\r\nqp->rq_tph_en = info->rq_tph_en;\r\nqp->rcv_tph_en = info->rcv_tph_en;\r\nqp->xmit_tph_en = info->xmit_tph_en;\r\nqp->qs_handle = qp->pd->dev->qs_handle;\r\nqp->exception_lan_queue = qp->pd->dev->exception_lan_queue;\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_qp_create(\r\nstruct i40iw_sc_qp *qp,\r\nstruct i40iw_create_qp_info *info,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 *wqe;\r\nu64 header;\r\nif ((qp->qp_uk.qp_id < I40IW_MIN_IW_QP_ID) ||\r\n(qp->qp_uk.qp_id > I40IW_MAX_IW_QP_ID))\r\nreturn I40IW_ERR_INVALID_QP_ID;\r\ncqp = qp->pd->dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 16, qp->hw_host_ctx_pa);\r\nset_64bit_val(wqe, 40, qp->shadow_area_pa);\r\nheader = qp->qp_uk.qp_id |\r\nLS_64(I40IW_CQP_OP_CREATE_QP, I40IW_CQPSQ_OPCODE) |\r\nLS_64((info->ord_valid ? 1 : 0), I40IW_CQPSQ_QP_ORDVALID) |\r\nLS_64(info->tcp_ctx_valid, I40IW_CQPSQ_QP_TOECTXVALID) |\r\nLS_64(qp->qp_type, I40IW_CQPSQ_QP_QPTYPE) |\r\nLS_64(qp->virtual_map, I40IW_CQPSQ_QP_VQ) |\r\nLS_64(info->cq_num_valid, I40IW_CQPSQ_QP_CQNUMVALID) |\r\nLS_64(info->static_rsrc, I40IW_CQPSQ_QP_STATRSRC) |\r\nLS_64(info->arp_cache_idx_valid, I40IW_CQPSQ_QP_ARPTABIDXVALID) |\r\nLS_64(info->next_iwarp_state, I40IW_CQPSQ_QP_NEXTIWSTATE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "QP_CREATE WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_qp_modify(\r\nstruct i40iw_sc_qp *qp,\r\nstruct i40iw_modify_qp_info *info,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 header;\r\nu8 term_actions = 0;\r\nu8 term_len = 0;\r\ncqp = qp->pd->dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nif (info->next_iwarp_state == I40IW_QP_STATE_TERMINATE) {\r\nif (info->dont_send_fin)\r\nterm_actions += I40IWQP_TERM_SEND_TERM_ONLY;\r\nif (info->dont_send_term)\r\nterm_actions += I40IWQP_TERM_SEND_FIN_ONLY;\r\nif ((term_actions == I40IWQP_TERM_SEND_TERM_AND_FIN) ||\r\n(term_actions == I40IWQP_TERM_SEND_TERM_ONLY))\r\nterm_len = info->termlen;\r\n}\r\nset_64bit_val(wqe,\r\n8,\r\nLS_64(info->new_mss, I40IW_CQPSQ_QP_NEWMSS) |\r\nLS_64(term_len, I40IW_CQPSQ_QP_TERMLEN));\r\nset_64bit_val(wqe, 16, qp->hw_host_ctx_pa);\r\nset_64bit_val(wqe, 40, qp->shadow_area_pa);\r\nheader = qp->qp_uk.qp_id |\r\nLS_64(I40IW_CQP_OP_MODIFY_QP, I40IW_CQPSQ_OPCODE) |\r\nLS_64(info->ord_valid, I40IW_CQPSQ_QP_ORDVALID) |\r\nLS_64(info->tcp_ctx_valid, I40IW_CQPSQ_QP_TOECTXVALID) |\r\nLS_64(info->cached_var_valid, I40IW_CQPSQ_QP_CACHEDVARVALID) |\r\nLS_64(qp->virtual_map, I40IW_CQPSQ_QP_VQ) |\r\nLS_64(info->cq_num_valid, I40IW_CQPSQ_QP_CQNUMVALID) |\r\nLS_64(info->force_loopback, I40IW_CQPSQ_QP_FORCELOOPBACK) |\r\nLS_64(qp->qp_type, I40IW_CQPSQ_QP_QPTYPE) |\r\nLS_64(info->mss_change, I40IW_CQPSQ_QP_MSSCHANGE) |\r\nLS_64(info->static_rsrc, I40IW_CQPSQ_QP_STATRSRC) |\r\nLS_64(info->remove_hash_idx, I40IW_CQPSQ_QP_REMOVEHASHENTRY) |\r\nLS_64(term_actions, I40IW_CQPSQ_QP_TERMACT) |\r\nLS_64(info->reset_tcp_conn, I40IW_CQPSQ_QP_RESETCON) |\r\nLS_64(info->arp_cache_idx_valid, I40IW_CQPSQ_QP_ARPTABIDXVALID) |\r\nLS_64(info->next_iwarp_state, I40IW_CQPSQ_QP_NEXTIWSTATE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "QP_MODIFY WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_qp_destroy(\r\nstruct i40iw_sc_qp *qp,\r\nu64 scratch,\r\nbool remove_hash_idx,\r\nbool ignore_mw_bnd,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 header;\r\ncqp = qp->pd->dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 16, qp->hw_host_ctx_pa);\r\nset_64bit_val(wqe, 40, qp->shadow_area_pa);\r\nheader = qp->qp_uk.qp_id |\r\nLS_64(I40IW_CQP_OP_DESTROY_QP, I40IW_CQPSQ_OPCODE) |\r\nLS_64(qp->qp_type, I40IW_CQPSQ_QP_QPTYPE) |\r\nLS_64(ignore_mw_bnd, I40IW_CQPSQ_QP_IGNOREMWBOUND) |\r\nLS_64(remove_hash_idx, I40IW_CQPSQ_QP_REMOVEHASHENTRY) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "QP_DESTROY WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_qp_flush_wqes(\r\nstruct i40iw_sc_qp *qp,\r\nstruct i40iw_qp_flush_info *info,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 temp = 0;\r\nu64 *wqe;\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 header;\r\nbool flush_sq = false, flush_rq = false;\r\nif (info->rq && !qp->flush_rq)\r\nflush_rq = true;\r\nif (info->sq && !qp->flush_sq)\r\nflush_sq = true;\r\nqp->flush_sq |= flush_sq;\r\nqp->flush_rq |= flush_rq;\r\nif (!flush_sq && !flush_rq) {\r\nif (info->ae_code != I40IW_AE_LLP_RECEIVED_MPA_CRC_ERROR)\r\nreturn 0;\r\n}\r\ncqp = qp->pd->dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nif (info->userflushcode) {\r\nif (flush_rq) {\r\ntemp |= LS_64(info->rq_minor_code, I40IW_CQPSQ_FWQE_RQMNERR) |\r\nLS_64(info->rq_major_code, I40IW_CQPSQ_FWQE_RQMJERR);\r\n}\r\nif (flush_sq) {\r\ntemp |= LS_64(info->sq_minor_code, I40IW_CQPSQ_FWQE_SQMNERR) |\r\nLS_64(info->sq_major_code, I40IW_CQPSQ_FWQE_SQMJERR);\r\n}\r\n}\r\nset_64bit_val(wqe, 16, temp);\r\ntemp = (info->generate_ae) ?\r\ninfo->ae_code | LS_64(info->ae_source, I40IW_CQPSQ_FWQE_AESOURCE) : 0;\r\nset_64bit_val(wqe, 8, temp);\r\nheader = qp->qp_uk.qp_id |\r\nLS_64(I40IW_CQP_OP_FLUSH_WQES, I40IW_CQPSQ_OPCODE) |\r\nLS_64(info->generate_ae, I40IW_CQPSQ_FWQE_GENERATE_AE) |\r\nLS_64(info->userflushcode, I40IW_CQPSQ_FWQE_USERFLCODE) |\r\nLS_64(flush_sq, I40IW_CQPSQ_FWQE_FLUSHSQ) |\r\nLS_64(flush_rq, I40IW_CQPSQ_FWQE_FLUSHRQ) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "QP_FLUSH WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_qp_upload_context(\r\nstruct i40iw_sc_dev *dev,\r\nstruct i40iw_upload_context_info *info,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 header;\r\ncqp = dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 16, info->buf_pa);\r\nheader = LS_64(info->qp_id, I40IW_CQPSQ_UCTX_QPID) |\r\nLS_64(I40IW_CQP_OP_UPLOAD_CONTEXT, I40IW_CQPSQ_OPCODE) |\r\nLS_64(info->qp_type, I40IW_CQPSQ_UCTX_QPTYPE) |\r\nLS_64(info->raw_format, I40IW_CQPSQ_UCTX_RAWFORMAT) |\r\nLS_64(info->freeze_qp, I40IW_CQPSQ_UCTX_FREEZEQP) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(dev, I40IW_DEBUG_WQE, "QP_UPLOAD_CTX WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_qp_setctx(\r\nstruct i40iw_sc_qp *qp,\r\nu64 *qp_ctx,\r\nstruct i40iw_qp_host_ctx_info *info)\r\n{\r\nstruct i40iwarp_offload_info *iw;\r\nstruct i40iw_tcp_offload_info *tcp;\r\nu64 qw0, qw3, qw7 = 0;\r\niw = info->iwarp_info;\r\ntcp = info->tcp_info;\r\nqw0 = LS_64(qp->qp_uk.rq_wqe_size, I40IWQPC_RQWQESIZE) |\r\nLS_64(info->err_rq_idx_valid, I40IWQPC_ERR_RQ_IDX_VALID) |\r\nLS_64(qp->rcv_tph_en, I40IWQPC_RCVTPHEN) |\r\nLS_64(qp->xmit_tph_en, I40IWQPC_XMITTPHEN) |\r\nLS_64(qp->rq_tph_en, I40IWQPC_RQTPHEN) |\r\nLS_64(qp->sq_tph_en, I40IWQPC_SQTPHEN) |\r\nLS_64(info->push_idx, I40IWQPC_PPIDX) |\r\nLS_64(info->push_mode_en, I40IWQPC_PMENA);\r\nset_64bit_val(qp_ctx, 8, qp->sq_pa);\r\nset_64bit_val(qp_ctx, 16, qp->rq_pa);\r\nqw3 = LS_64(qp->src_mac_addr_idx, I40IWQPC_SRCMACADDRIDX) |\r\nLS_64(qp->hw_rq_size, I40IWQPC_RQSIZE) |\r\nLS_64(qp->hw_sq_size, I40IWQPC_SQSIZE);\r\nset_64bit_val(qp_ctx,\r\n128,\r\nLS_64(info->err_rq_idx, I40IWQPC_ERR_RQ_IDX));\r\nset_64bit_val(qp_ctx,\r\n136,\r\nLS_64(info->send_cq_num, I40IWQPC_TXCQNUM) |\r\nLS_64(info->rcv_cq_num, I40IWQPC_RXCQNUM));\r\nset_64bit_val(qp_ctx,\r\n168,\r\nLS_64(info->qp_compl_ctx, I40IWQPC_QPCOMPCTX));\r\nset_64bit_val(qp_ctx,\r\n176,\r\nLS_64(qp->sq_tph_val, I40IWQPC_SQTPHVAL) |\r\nLS_64(qp->rq_tph_val, I40IWQPC_RQTPHVAL) |\r\nLS_64(qp->qs_handle, I40IWQPC_QSHANDLE) |\r\nLS_64(qp->exception_lan_queue, I40IWQPC_EXCEPTION_LAN_QUEUE));\r\nif (info->iwarp_info_valid) {\r\nqw0 |= LS_64(iw->ddp_ver, I40IWQPC_DDP_VER) |\r\nLS_64(iw->rdmap_ver, I40IWQPC_RDMAP_VER);\r\nqw7 |= LS_64(iw->pd_id, I40IWQPC_PDIDX);\r\nset_64bit_val(qp_ctx, 144, qp->q2_pa);\r\nset_64bit_val(qp_ctx,\r\n152,\r\nLS_64(iw->last_byte_sent, I40IWQPC_LASTBYTESENT));\r\niw->ird_size = I40IW_QPCTX_ENCD_MAXIRD;\r\nset_64bit_val(qp_ctx,\r\n160,\r\nLS_64(iw->ord_size, I40IWQPC_ORDSIZE) |\r\nLS_64(iw->ird_size, I40IWQPC_IRDSIZE) |\r\nLS_64(iw->wr_rdresp_en, I40IWQPC_WRRDRSPOK) |\r\nLS_64(iw->rd_enable, I40IWQPC_RDOK) |\r\nLS_64(iw->snd_mark_en, I40IWQPC_SNDMARKERS) |\r\nLS_64(iw->bind_en, I40IWQPC_BINDEN) |\r\nLS_64(iw->fast_reg_en, I40IWQPC_FASTREGEN) |\r\nLS_64(iw->priv_mode_en, I40IWQPC_PRIVEN) |\r\nLS_64(1, I40IWQPC_IWARPMODE) |\r\nLS_64(iw->rcv_mark_en, I40IWQPC_RCVMARKERS) |\r\nLS_64(iw->align_hdrs, I40IWQPC_ALIGNHDRS) |\r\nLS_64(iw->rcv_no_mpa_crc, I40IWQPC_RCVNOMPACRC) |\r\nLS_64(iw->rcv_mark_offset, I40IWQPC_RCVMARKOFFSET) |\r\nLS_64(iw->snd_mark_offset, I40IWQPC_SNDMARKOFFSET));\r\n}\r\nif (info->tcp_info_valid) {\r\nqw0 |= LS_64(tcp->ipv4, I40IWQPC_IPV4) |\r\nLS_64(tcp->no_nagle, I40IWQPC_NONAGLE) |\r\nLS_64(tcp->insert_vlan_tag, I40IWQPC_INSERTVLANTAG) |\r\nLS_64(tcp->time_stamp, I40IWQPC_TIMESTAMP) |\r\nLS_64(tcp->cwnd_inc_limit, I40IWQPC_LIMIT) |\r\nLS_64(tcp->drop_ooo_seg, I40IWQPC_DROPOOOSEG) |\r\nLS_64(tcp->dup_ack_thresh, I40IWQPC_DUPACK_THRESH);\r\nqw3 |= LS_64(tcp->ttl, I40IWQPC_TTL) |\r\nLS_64(tcp->src_mac_addr_idx, I40IWQPC_SRCMACADDRIDX) |\r\nLS_64(tcp->avoid_stretch_ack, I40IWQPC_AVOIDSTRETCHACK) |\r\nLS_64(tcp->tos, I40IWQPC_TOS) |\r\nLS_64(tcp->src_port, I40IWQPC_SRCPORTNUM) |\r\nLS_64(tcp->dst_port, I40IWQPC_DESTPORTNUM);\r\nqp->src_mac_addr_idx = tcp->src_mac_addr_idx;\r\nset_64bit_val(qp_ctx,\r\n32,\r\nLS_64(tcp->dest_ip_addr2, I40IWQPC_DESTIPADDR2) |\r\nLS_64(tcp->dest_ip_addr3, I40IWQPC_DESTIPADDR3));\r\nset_64bit_val(qp_ctx,\r\n40,\r\nLS_64(tcp->dest_ip_addr0, I40IWQPC_DESTIPADDR0) |\r\nLS_64(tcp->dest_ip_addr1, I40IWQPC_DESTIPADDR1));\r\nset_64bit_val(qp_ctx,\r\n48,\r\nLS_64(tcp->snd_mss, I40IWQPC_SNDMSS) |\r\nLS_64(tcp->vlan_tag, I40IWQPC_VLANTAG) |\r\nLS_64(tcp->arp_idx, I40IWQPC_ARPIDX));\r\nqw7 |= LS_64(tcp->flow_label, I40IWQPC_FLOWLABEL) |\r\nLS_64(tcp->wscale, I40IWQPC_WSCALE) |\r\nLS_64(tcp->ignore_tcp_opt, I40IWQPC_IGNORE_TCP_OPT) |\r\nLS_64(tcp->ignore_tcp_uns_opt, I40IWQPC_IGNORE_TCP_UNS_OPT) |\r\nLS_64(tcp->tcp_state, I40IWQPC_TCPSTATE) |\r\nLS_64(tcp->rcv_wscale, I40IWQPC_RCVSCALE) |\r\nLS_64(tcp->snd_wscale, I40IWQPC_SNDSCALE);\r\nset_64bit_val(qp_ctx,\r\n72,\r\nLS_64(tcp->time_stamp_recent, I40IWQPC_TIMESTAMP_RECENT) |\r\nLS_64(tcp->time_stamp_age, I40IWQPC_TIMESTAMP_AGE));\r\nset_64bit_val(qp_ctx,\r\n80,\r\nLS_64(tcp->snd_nxt, I40IWQPC_SNDNXT) |\r\nLS_64(tcp->snd_wnd, I40IWQPC_SNDWND));\r\nset_64bit_val(qp_ctx,\r\n88,\r\nLS_64(tcp->rcv_nxt, I40IWQPC_RCVNXT) |\r\nLS_64(tcp->rcv_wnd, I40IWQPC_RCVWND));\r\nset_64bit_val(qp_ctx,\r\n96,\r\nLS_64(tcp->snd_max, I40IWQPC_SNDMAX) |\r\nLS_64(tcp->snd_una, I40IWQPC_SNDUNA));\r\nset_64bit_val(qp_ctx,\r\n104,\r\nLS_64(tcp->srtt, I40IWQPC_SRTT) |\r\nLS_64(tcp->rtt_var, I40IWQPC_RTTVAR));\r\nset_64bit_val(qp_ctx,\r\n112,\r\nLS_64(tcp->ss_thresh, I40IWQPC_SSTHRESH) |\r\nLS_64(tcp->cwnd, I40IWQPC_CWND));\r\nset_64bit_val(qp_ctx,\r\n120,\r\nLS_64(tcp->snd_wl1, I40IWQPC_SNDWL1) |\r\nLS_64(tcp->snd_wl2, I40IWQPC_SNDWL2));\r\nset_64bit_val(qp_ctx,\r\n128,\r\nLS_64(tcp->max_snd_window, I40IWQPC_MAXSNDWND) |\r\nLS_64(tcp->rexmit_thresh, I40IWQPC_REXMIT_THRESH));\r\nset_64bit_val(qp_ctx,\r\n184,\r\nLS_64(tcp->local_ipaddr3, I40IWQPC_LOCAL_IPADDR3) |\r\nLS_64(tcp->local_ipaddr2, I40IWQPC_LOCAL_IPADDR2));\r\nset_64bit_val(qp_ctx,\r\n192,\r\nLS_64(tcp->local_ipaddr1, I40IWQPC_LOCAL_IPADDR1) |\r\nLS_64(tcp->local_ipaddr0, I40IWQPC_LOCAL_IPADDR0));\r\n}\r\nset_64bit_val(qp_ctx, 0, qw0);\r\nset_64bit_val(qp_ctx, 24, qw3);\r\nset_64bit_val(qp_ctx, 56, qw7);\r\ni40iw_debug_buf(qp->dev, I40IW_DEBUG_WQE, "QP_HOST)CTX WQE",\r\nqp_ctx, I40IW_QP_CTX_SIZE);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_alloc_stag(\r\nstruct i40iw_sc_dev *dev,\r\nstruct i40iw_allocate_stag_info *info,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 header;\r\ncqp = dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe,\r\n8,\r\nLS_64(info->pd_id, I40IW_CQPSQ_STAG_PDID) |\r\nLS_64(info->total_len, I40IW_CQPSQ_STAG_STAGLEN));\r\nset_64bit_val(wqe,\r\n16,\r\nLS_64(info->stag_idx, I40IW_CQPSQ_STAG_IDX));\r\nset_64bit_val(wqe,\r\n40,\r\nLS_64(info->hmc_fcn_index, I40IW_CQPSQ_STAG_HMCFNIDX));\r\nheader = LS_64(I40IW_CQP_OP_ALLOC_STAG, I40IW_CQPSQ_OPCODE) |\r\nLS_64(1, I40IW_CQPSQ_STAG_MR) |\r\nLS_64(info->access_rights, I40IW_CQPSQ_STAG_ARIGHTS) |\r\nLS_64(info->chunk_size, I40IW_CQPSQ_STAG_LPBLSIZE) |\r\nLS_64(info->page_size, I40IW_CQPSQ_STAG_HPAGESIZE) |\r\nLS_64(info->remote_access, I40IW_CQPSQ_STAG_REMACCENABLED) |\r\nLS_64(info->use_hmc_fcn_index, I40IW_CQPSQ_STAG_USEHMCFNIDX) |\r\nLS_64(info->use_pf_rid, I40IW_CQPSQ_STAG_USEPFRID) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(dev, I40IW_DEBUG_WQE, "ALLOC_STAG WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_mr_reg_non_shared(\r\nstruct i40iw_sc_dev *dev,\r\nstruct i40iw_reg_ns_stag_info *info,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nu64 temp;\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 header;\r\nu32 pble_obj_cnt;\r\nbool remote_access;\r\nu8 addr_type;\r\nif (info->access_rights & (I40IW_ACCESS_FLAGS_REMOTEREAD_ONLY |\r\nI40IW_ACCESS_FLAGS_REMOTEWRITE_ONLY))\r\nremote_access = true;\r\nelse\r\nremote_access = false;\r\npble_obj_cnt = dev->hmc_info->hmc_obj[I40IW_HMC_IW_PBLE].cnt;\r\nif (info->chunk_size && (info->first_pm_pbl_index >= pble_obj_cnt))\r\nreturn I40IW_ERR_INVALID_PBLE_INDEX;\r\ncqp = dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\ntemp = (info->addr_type == I40IW_ADDR_TYPE_VA_BASED) ? (uintptr_t)info->va : info->fbo;\r\nset_64bit_val(wqe, 0, temp);\r\nset_64bit_val(wqe,\r\n8,\r\nLS_64(info->total_len, I40IW_CQPSQ_STAG_STAGLEN) |\r\nLS_64(info->pd_id, I40IW_CQPSQ_STAG_PDID));\r\nset_64bit_val(wqe,\r\n16,\r\nLS_64(info->stag_key, I40IW_CQPSQ_STAG_KEY) |\r\nLS_64(info->stag_idx, I40IW_CQPSQ_STAG_IDX));\r\nif (!info->chunk_size) {\r\nset_64bit_val(wqe, 32, info->reg_addr_pa);\r\nset_64bit_val(wqe, 48, 0);\r\n} else {\r\nset_64bit_val(wqe, 32, 0);\r\nset_64bit_val(wqe, 48, info->first_pm_pbl_index);\r\n}\r\nset_64bit_val(wqe, 40, info->hmc_fcn_index);\r\nset_64bit_val(wqe, 56, 0);\r\naddr_type = (info->addr_type == I40IW_ADDR_TYPE_VA_BASED) ? 1 : 0;\r\nheader = LS_64(I40IW_CQP_OP_REG_MR, I40IW_CQPSQ_OPCODE) |\r\nLS_64(1, I40IW_CQPSQ_STAG_MR) |\r\nLS_64(info->chunk_size, I40IW_CQPSQ_STAG_LPBLSIZE) |\r\nLS_64(info->page_size, I40IW_CQPSQ_STAG_HPAGESIZE) |\r\nLS_64(info->access_rights, I40IW_CQPSQ_STAG_ARIGHTS) |\r\nLS_64(remote_access, I40IW_CQPSQ_STAG_REMACCENABLED) |\r\nLS_64(addr_type, I40IW_CQPSQ_STAG_VABASEDTO) |\r\nLS_64(info->use_hmc_fcn_index, I40IW_CQPSQ_STAG_USEHMCFNIDX) |\r\nLS_64(info->use_pf_rid, I40IW_CQPSQ_STAG_USEPFRID) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(dev, I40IW_DEBUG_WQE, "MR_REG_NS WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_mr_reg_shared(\r\nstruct i40iw_sc_dev *dev,\r\nstruct i40iw_register_shared_stag *info,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 *wqe;\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 temp, va64, fbo, header;\r\nu32 va32;\r\nbool remote_access;\r\nu8 addr_type;\r\nif (info->access_rights & (I40IW_ACCESS_FLAGS_REMOTEREAD_ONLY |\r\nI40IW_ACCESS_FLAGS_REMOTEWRITE_ONLY))\r\nremote_access = true;\r\nelse\r\nremote_access = false;\r\ncqp = dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nva64 = (uintptr_t)(info->va);\r\nva32 = (u32)(va64 & 0x00000000FFFFFFFF);\r\nfbo = (u64)(va32 & (4096 - 1));\r\nset_64bit_val(wqe,\r\n0,\r\n(info->addr_type == I40IW_ADDR_TYPE_VA_BASED ? (uintptr_t)info->va : fbo));\r\nset_64bit_val(wqe,\r\n8,\r\nLS_64(info->pd_id, I40IW_CQPSQ_STAG_PDID));\r\ntemp = LS_64(info->new_stag_key, I40IW_CQPSQ_STAG_KEY) |\r\nLS_64(info->new_stag_idx, I40IW_CQPSQ_STAG_IDX) |\r\nLS_64(info->parent_stag_idx, I40IW_CQPSQ_STAG_PARENTSTAGIDX);\r\nset_64bit_val(wqe, 16, temp);\r\naddr_type = (info->addr_type == I40IW_ADDR_TYPE_VA_BASED) ? 1 : 0;\r\nheader = LS_64(I40IW_CQP_OP_REG_SMR, I40IW_CQPSQ_OPCODE) |\r\nLS_64(1, I40IW_CQPSQ_STAG_MR) |\r\nLS_64(info->access_rights, I40IW_CQPSQ_STAG_ARIGHTS) |\r\nLS_64(remote_access, I40IW_CQPSQ_STAG_REMACCENABLED) |\r\nLS_64(addr_type, I40IW_CQPSQ_STAG_VABASEDTO) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(dev, I40IW_DEBUG_WQE, "MR_REG_SHARED WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_dealloc_stag(\r\nstruct i40iw_sc_dev *dev,\r\nstruct i40iw_dealloc_stag_info *info,\r\nu64 scratch,\r\nbool post_sq)\r\n{\r\nu64 header;\r\nu64 *wqe;\r\nstruct i40iw_sc_cqp *cqp;\r\ncqp = dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe,\r\n8,\r\nLS_64(info->pd_id, I40IW_CQPSQ_STAG_PDID));\r\nset_64bit_val(wqe,\r\n16,\r\nLS_64(info->stag_idx, I40IW_CQPSQ_STAG_IDX));\r\nheader = LS_64(I40IW_CQP_OP_DEALLOC_STAG, I40IW_CQPSQ_OPCODE) |\r\nLS_64(info->mr, I40IW_CQPSQ_STAG_MR) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(dev, I40IW_DEBUG_WQE, "DEALLOC_STAG WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_query_stag(struct i40iw_sc_dev *dev,\r\nu64 scratch,\r\nu32 stag_index,\r\nbool post_sq)\r\n{\r\nu64 header;\r\nu64 *wqe;\r\nstruct i40iw_sc_cqp *cqp;\r\ncqp = dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe,\r\n16,\r\nLS_64(stag_index, I40IW_CQPSQ_QUERYSTAG_IDX));\r\nheader = LS_64(I40IW_CQP_OP_QUERY_STAG, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(dev, I40IW_DEBUG_WQE, "QUERY_STAG WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_mw_alloc(\r\nstruct i40iw_sc_dev *dev,\r\nu64 scratch,\r\nu32 mw_stag_index,\r\nu16 pd_id,\r\nbool post_sq)\r\n{\r\nu64 header;\r\nstruct i40iw_sc_cqp *cqp;\r\nu64 *wqe;\r\ncqp = dev->cqp;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe, 8, LS_64(pd_id, I40IW_CQPSQ_STAG_PDID));\r\nset_64bit_val(wqe,\r\n16,\r\nLS_64(mw_stag_index, I40IW_CQPSQ_STAG_IDX));\r\nheader = LS_64(I40IW_CQP_OP_ALLOC_STAG, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(dev, I40IW_DEBUG_WQE, "MW_ALLOC WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nif (post_sq)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nenum i40iw_status_code i40iw_sc_mr_fast_register(\r\nstruct i40iw_sc_qp *qp,\r\nstruct i40iw_fast_reg_stag_info *info,\r\nbool post_sq)\r\n{\r\nu64 temp, header;\r\nu64 *wqe;\r\nu32 wqe_idx;\r\nwqe = i40iw_qp_get_next_send_wqe(&qp->qp_uk, &wqe_idx, I40IW_QP_WQE_MIN_SIZE,\r\n0, info->wr_id);\r\nif (!wqe)\r\nreturn I40IW_ERR_QP_TOOMANY_WRS_POSTED;\r\ni40iw_debug(qp->dev, I40IW_DEBUG_MR, "%s: wr_id[%llxh] wqe_idx[%04d] location[%p]\n",\r\n__func__, info->wr_id, wqe_idx,\r\n&qp->qp_uk.sq_wrtrk_array[wqe_idx].wrid);\r\ntemp = (info->addr_type == I40IW_ADDR_TYPE_VA_BASED) ? (uintptr_t)info->va : info->fbo;\r\nset_64bit_val(wqe, 0, temp);\r\ntemp = RS_64(info->first_pm_pbl_index >> 16, I40IWQPSQ_FIRSTPMPBLIDXHI);\r\nset_64bit_val(wqe,\r\n8,\r\nLS_64(temp, I40IWQPSQ_FIRSTPMPBLIDXHI) |\r\nLS_64(info->reg_addr_pa >> I40IWQPSQ_PBLADDR_SHIFT, I40IWQPSQ_PBLADDR));\r\nset_64bit_val(wqe,\r\n16,\r\ninfo->total_len |\r\nLS_64(info->first_pm_pbl_index, I40IWQPSQ_FIRSTPMPBLIDXLO));\r\nheader = LS_64(info->stag_key, I40IWQPSQ_STAGKEY) |\r\nLS_64(info->stag_idx, I40IWQPSQ_STAGINDEX) |\r\nLS_64(I40IWQP_OP_FAST_REGISTER, I40IWQPSQ_OPCODE) |\r\nLS_64(info->chunk_size, I40IWQPSQ_LPBLSIZE) |\r\nLS_64(info->page_size, I40IWQPSQ_HPAGESIZE) |\r\nLS_64(info->access_rights, I40IWQPSQ_STAGRIGHTS) |\r\nLS_64(info->addr_type, I40IWQPSQ_VABASEDTO) |\r\nLS_64(info->read_fence, I40IWQPSQ_READFENCE) |\r\nLS_64(info->local_fence, I40IWQPSQ_LOCALFENCE) |\r\nLS_64(info->signaled, I40IWQPSQ_SIGCOMPL) |\r\nLS_64(qp->qp_uk.swqe_polarity, I40IWQPSQ_VALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(qp->dev, I40IW_DEBUG_WQE, "FAST_REG WQE",\r\nwqe, I40IW_QP_WQE_MIN_SIZE);\r\nif (post_sq)\r\ni40iw_qp_post_wr(&qp->qp_uk);\r\nreturn 0;\r\n}\r\nstatic void i40iw_sc_send_lsmm(struct i40iw_sc_qp *qp,\r\nvoid *lsmm_buf,\r\nu32 size,\r\ni40iw_stag stag)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nstruct i40iw_qp_uk *qp_uk;\r\nqp_uk = &qp->qp_uk;\r\nwqe = qp_uk->sq_base->elem;\r\nset_64bit_val(wqe, 0, (uintptr_t)lsmm_buf);\r\nset_64bit_val(wqe, 8, (size | LS_64(stag, I40IWQPSQ_FRAG_STAG)));\r\nset_64bit_val(wqe, 16, 0);\r\nheader = LS_64(I40IWQP_OP_RDMA_SEND, I40IWQPSQ_OPCODE) |\r\nLS_64(1, I40IWQPSQ_STREAMMODE) |\r\nLS_64(1, I40IWQPSQ_WAITFORRCVPDU) |\r\nLS_64(qp->qp_uk.swqe_polarity, I40IWQPSQ_VALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(qp->dev, I40IW_DEBUG_QP, "SEND_LSMM WQE",\r\nwqe, I40IW_QP_WQE_MIN_SIZE);\r\n}\r\nstatic void i40iw_sc_send_lsmm_nostag(struct i40iw_sc_qp *qp,\r\nvoid *lsmm_buf,\r\nu32 size)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nstruct i40iw_qp_uk *qp_uk;\r\nqp_uk = &qp->qp_uk;\r\nwqe = qp_uk->sq_base->elem;\r\nset_64bit_val(wqe, 0, (uintptr_t)lsmm_buf);\r\nset_64bit_val(wqe, 8, size);\r\nset_64bit_val(wqe, 16, 0);\r\nheader = LS_64(I40IWQP_OP_RDMA_SEND, I40IWQPSQ_OPCODE) |\r\nLS_64(1, I40IWQPSQ_STREAMMODE) |\r\nLS_64(1, I40IWQPSQ_WAITFORRCVPDU) |\r\nLS_64(qp->qp_uk.swqe_polarity, I40IWQPSQ_VALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(qp->dev, I40IW_DEBUG_WQE, "SEND_LSMM_NOSTAG WQE",\r\nwqe, I40IW_QP_WQE_MIN_SIZE);\r\n}\r\nstatic void i40iw_sc_send_rtt(struct i40iw_sc_qp *qp, bool read)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nstruct i40iw_qp_uk *qp_uk;\r\nqp_uk = &qp->qp_uk;\r\nwqe = qp_uk->sq_base->elem;\r\nset_64bit_val(wqe, 0, 0);\r\nset_64bit_val(wqe, 8, 0);\r\nset_64bit_val(wqe, 16, 0);\r\nif (read) {\r\nheader = LS_64(0x1234, I40IWQPSQ_REMSTAG) |\r\nLS_64(I40IWQP_OP_RDMA_READ, I40IWQPSQ_OPCODE) |\r\nLS_64(qp->qp_uk.swqe_polarity, I40IWQPSQ_VALID);\r\nset_64bit_val(wqe, 8, ((u64)0xabcd << 32));\r\n} else {\r\nheader = LS_64(I40IWQP_OP_RDMA_WRITE, I40IWQPSQ_OPCODE) |\r\nLS_64(qp->qp_uk.swqe_polarity, I40IWQPSQ_VALID);\r\n}\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(qp->dev, I40IW_DEBUG_WQE, "RTR WQE",\r\nwqe, I40IW_QP_WQE_MIN_SIZE);\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_post_wqe0(struct i40iw_sc_qp *qp, u8 opcode)\r\n{\r\nu64 *wqe;\r\nu64 header;\r\nstruct i40iw_qp_uk *qp_uk;\r\nqp_uk = &qp->qp_uk;\r\nwqe = qp_uk->sq_base->elem;\r\nif (!wqe)\r\nreturn I40IW_ERR_QP_TOOMANY_WRS_POSTED;\r\nswitch (opcode) {\r\ncase I40IWQP_OP_NOP:\r\nset_64bit_val(wqe, 0, 0);\r\nset_64bit_val(wqe, 8, 0);\r\nset_64bit_val(wqe, 16, 0);\r\nheader = LS_64(I40IWQP_OP_NOP, I40IWQPSQ_OPCODE) |\r\nLS_64(qp->qp_uk.swqe_polarity, I40IWQPSQ_VALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\nbreak;\r\ncase I40IWQP_OP_RDMA_SEND:\r\nset_64bit_val(wqe, 0, 0);\r\nset_64bit_val(wqe, 8, 0);\r\nset_64bit_val(wqe, 16, 0);\r\nheader = LS_64(I40IWQP_OP_RDMA_SEND, I40IWQPSQ_OPCODE) |\r\nLS_64(qp->qp_uk.swqe_polarity, I40IWQPSQ_VALID) |\r\nLS_64(1, I40IWQPSQ_STREAMMODE) |\r\nLS_64(1, I40IWQPSQ_WAITFORRCVPDU);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\nbreak;\r\ndefault:\r\ni40iw_debug(qp->dev, I40IW_DEBUG_QP, "%s: Invalid WQE zero opcode\n",\r\n__func__);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nenum i40iw_status_code i40iw_sc_init_iw_hmc(struct i40iw_sc_dev *dev, u8 hmc_fn_id)\r\n{\r\nstruct i40iw_hmc_info *hmc_info;\r\nstruct i40iw_dma_mem query_fpm_mem;\r\nstruct i40iw_virt_mem virt_mem;\r\nstruct i40iw_vfdev *vf_dev = NULL;\r\nu32 mem_size;\r\nenum i40iw_status_code ret_code = 0;\r\nbool poll_registers = true;\r\nu16 iw_vf_idx;\r\nu8 wait_type;\r\nif (hmc_fn_id >= I40IW_MAX_VF_FPM_ID ||\r\n(dev->hmc_fn_id != hmc_fn_id && hmc_fn_id < I40IW_FIRST_VF_FPM_ID))\r\nreturn I40IW_ERR_INVALID_HMCFN_ID;\r\ni40iw_debug(dev, I40IW_DEBUG_HMC, "hmc_fn_id %u, dev->hmc_fn_id %u\n", hmc_fn_id,\r\ndev->hmc_fn_id);\r\nif (hmc_fn_id == dev->hmc_fn_id) {\r\nhmc_info = dev->hmc_info;\r\nquery_fpm_mem.pa = dev->fpm_query_buf_pa;\r\nquery_fpm_mem.va = dev->fpm_query_buf;\r\n} else {\r\nvf_dev = i40iw_vfdev_from_fpm(dev, hmc_fn_id);\r\nif (!vf_dev)\r\nreturn I40IW_ERR_INVALID_VF_ID;\r\nhmc_info = &vf_dev->hmc_info;\r\niw_vf_idx = vf_dev->iw_vf_idx;\r\ni40iw_debug(dev, I40IW_DEBUG_HMC, "vf_dev %p, hmc_info %p, hmc_obj %p\n", vf_dev,\r\nhmc_info, hmc_info->hmc_obj);\r\nif (!vf_dev->fpm_query_buf) {\r\nif (!dev->vf_fpm_query_buf[iw_vf_idx].va) {\r\nret_code = i40iw_alloc_query_fpm_buf(dev,\r\n&dev->vf_fpm_query_buf[iw_vf_idx]);\r\nif (ret_code)\r\nreturn ret_code;\r\n}\r\nvf_dev->fpm_query_buf = dev->vf_fpm_query_buf[iw_vf_idx].va;\r\nvf_dev->fpm_query_buf_pa = dev->vf_fpm_query_buf[iw_vf_idx].pa;\r\n}\r\nquery_fpm_mem.pa = vf_dev->fpm_query_buf_pa;\r\nquery_fpm_mem.va = vf_dev->fpm_query_buf;\r\npoll_registers = false;\r\n}\r\nhmc_info->hmc_fn_id = hmc_fn_id;\r\nif (hmc_fn_id != dev->hmc_fn_id) {\r\nret_code =\r\ni40iw_cqp_query_fpm_values_cmd(dev, &query_fpm_mem, hmc_fn_id);\r\n} else {\r\nwait_type = poll_registers ? (u8)I40IW_CQP_WAIT_POLL_REGS :\r\n(u8)I40IW_CQP_WAIT_POLL_CQ;\r\nret_code = i40iw_sc_query_fpm_values(\r\ndev->cqp,\r\n0,\r\nhmc_info->hmc_fn_id,\r\n&query_fpm_mem,\r\ntrue,\r\nwait_type);\r\n}\r\nif (ret_code)\r\nreturn ret_code;\r\nret_code =\r\ni40iw_sc_parse_fpm_query_buf((u64 *)query_fpm_mem.va,\r\nhmc_info,\r\n&dev->hmc_fpm_misc);\r\nif (ret_code)\r\nreturn ret_code;\r\ni40iw_debug_buf(dev, I40IW_DEBUG_HMC, "QUERY FPM BUFFER",\r\nquery_fpm_mem.va, I40IW_QUERY_FPM_BUF_SIZE);\r\nif (hmc_fn_id != dev->hmc_fn_id) {\r\ni40iw_cqp_commit_fpm_values_cmd(dev, &query_fpm_mem, hmc_fn_id);\r\ni40iw_sc_parse_fpm_commit_buf((u64 *)query_fpm_mem.va, hmc_info->hmc_obj, &hmc_info->sd_table.sd_cnt);\r\nmem_size = sizeof(struct i40iw_hmc_sd_entry) *\r\n(hmc_info->sd_table.sd_cnt + hmc_info->first_sd_index);\r\nret_code = i40iw_allocate_virt_mem(dev->hw, &virt_mem, mem_size);\r\nif (ret_code)\r\nreturn ret_code;\r\nhmc_info->sd_table.sd_entry = virt_mem.va;\r\n}\r\nhmc_info->hmc_obj[I40IW_HMC_IW_XFFL].size = 4;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_Q1FL].size = 4;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_PBLE].size = 8;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_APBVT_ENTRY].size = 8192;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_APBVT_ENTRY].max_cnt = 1;\r\nreturn ret_code;\r\n}\r\nstatic enum i40iw_status_code i40iw_sc_configure_iw_fpm(struct i40iw_sc_dev *dev,\r\nu8 hmc_fn_id)\r\n{\r\nstruct i40iw_hmc_info *hmc_info;\r\nstruct i40iw_hmc_obj_info *obj_info;\r\nu64 *buf;\r\nstruct i40iw_dma_mem commit_fpm_mem;\r\nu32 i, j;\r\nenum i40iw_status_code ret_code = 0;\r\nbool poll_registers = true;\r\nu8 wait_type;\r\nif (hmc_fn_id >= I40IW_MAX_VF_FPM_ID ||\r\n(dev->hmc_fn_id != hmc_fn_id && hmc_fn_id < I40IW_FIRST_VF_FPM_ID))\r\nreturn I40IW_ERR_INVALID_HMCFN_ID;\r\nif (hmc_fn_id == dev->hmc_fn_id) {\r\nhmc_info = dev->hmc_info;\r\n} else {\r\nhmc_info = i40iw_vf_hmcinfo_from_fpm(dev, hmc_fn_id);\r\npoll_registers = false;\r\n}\r\nif (!hmc_info)\r\nreturn I40IW_ERR_BAD_PTR;\r\nobj_info = hmc_info->hmc_obj;\r\nbuf = dev->fpm_commit_buf;\r\nfor (i = I40IW_HMC_IW_QP, j = 0; i <= I40IW_HMC_IW_PBLE;\r\ni++, j += 8)\r\nset_64bit_val(buf, j, (u64)obj_info[i].cnt);\r\nset_64bit_val(buf, 40, 0);\r\ncommit_fpm_mem.pa = dev->fpm_commit_buf_pa;\r\ncommit_fpm_mem.va = dev->fpm_commit_buf;\r\nwait_type = poll_registers ? (u8)I40IW_CQP_WAIT_POLL_REGS :\r\n(u8)I40IW_CQP_WAIT_POLL_CQ;\r\nret_code = i40iw_sc_commit_fpm_values(\r\ndev->cqp,\r\n0,\r\nhmc_info->hmc_fn_id,\r\n&commit_fpm_mem,\r\ntrue,\r\nwait_type);\r\nif (!ret_code)\r\nret_code = i40iw_sc_parse_fpm_commit_buf(dev->fpm_commit_buf,\r\nhmc_info->hmc_obj,\r\n&hmc_info->sd_table.sd_cnt);\r\ni40iw_debug_buf(dev, I40IW_DEBUG_HMC, "COMMIT FPM BUFFER",\r\ncommit_fpm_mem.va, I40IW_COMMIT_FPM_BUF_SIZE);\r\nreturn ret_code;\r\n}\r\nstatic enum i40iw_status_code cqp_sds_wqe_fill(struct i40iw_sc_cqp *cqp,\r\nstruct i40iw_update_sds_info *info,\r\nu64 scratch)\r\n{\r\nu64 data;\r\nu64 header;\r\nu64 *wqe;\r\nint mem_entries, wqe_entries;\r\nstruct i40iw_dma_mem *sdbuf = &cqp->sdbuf;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nI40IW_CQP_INIT_WQE(wqe);\r\nwqe_entries = (info->cnt > 3) ? 3 : info->cnt;\r\nmem_entries = info->cnt - wqe_entries;\r\nheader = LS_64(I40IW_CQP_OP_UPDATE_PE_SDS, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID) |\r\nLS_64(mem_entries, I40IW_CQPSQ_UPESD_ENTRY_COUNT);\r\nif (mem_entries) {\r\nmemcpy(sdbuf->va, &info->entry[3], (mem_entries << 4));\r\ndata = sdbuf->pa;\r\n} else {\r\ndata = 0;\r\n}\r\ndata |= LS_64(info->hmc_fn_id, I40IW_CQPSQ_UPESD_HMCFNID);\r\nset_64bit_val(wqe, 16, data);\r\nswitch (wqe_entries) {\r\ncase 3:\r\nset_64bit_val(wqe, 48,\r\n(LS_64(info->entry[2].cmd, I40IW_CQPSQ_UPESD_SDCMD) |\r\nLS_64(1, I40IW_CQPSQ_UPESD_ENTRY_VALID)));\r\nset_64bit_val(wqe, 56, info->entry[2].data);\r\ncase 2:\r\nset_64bit_val(wqe, 32,\r\n(LS_64(info->entry[1].cmd, I40IW_CQPSQ_UPESD_SDCMD) |\r\nLS_64(1, I40IW_CQPSQ_UPESD_ENTRY_VALID)));\r\nset_64bit_val(wqe, 40, info->entry[1].data);\r\ncase 1:\r\nset_64bit_val(wqe, 0,\r\nLS_64(info->entry[0].cmd, I40IW_CQPSQ_UPESD_SDCMD));\r\nset_64bit_val(wqe, 8, info->entry[0].data);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "UPDATE_PE_SDS WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\nreturn 0;\r\n}\r\nstatic enum i40iw_status_code i40iw_update_pe_sds(struct i40iw_sc_dev *dev,\r\nstruct i40iw_update_sds_info *info,\r\nu64 scratch)\r\n{\r\nstruct i40iw_sc_cqp *cqp = dev->cqp;\r\nenum i40iw_status_code ret_code;\r\nret_code = cqp_sds_wqe_fill(cqp, info, scratch);\r\nif (!ret_code)\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn ret_code;\r\n}\r\nenum i40iw_status_code i40iw_update_sds_noccq(struct i40iw_sc_dev *dev,\r\nstruct i40iw_update_sds_info *info)\r\n{\r\nu32 error, val, tail;\r\nstruct i40iw_sc_cqp *cqp = dev->cqp;\r\nenum i40iw_status_code ret_code;\r\nret_code = cqp_sds_wqe_fill(cqp, info, 0);\r\nif (ret_code)\r\nreturn ret_code;\r\ni40iw_get_cqp_reg_info(cqp, &val, &tail, &error);\r\nif (error)\r\nreturn I40IW_ERR_CQP_COMPL_ERROR;\r\ni40iw_sc_cqp_post_sq(cqp);\r\nret_code = i40iw_cqp_poll_registers(cqp, tail, I40IW_DONE_COUNT);\r\nreturn ret_code;\r\n}\r\nenum i40iw_status_code i40iw_sc_suspend_qp(struct i40iw_sc_cqp *cqp,\r\nstruct i40iw_sc_qp *qp,\r\nu64 scratch)\r\n{\r\nu64 header;\r\nu64 *wqe;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nheader = LS_64(qp->qp_uk.qp_id, I40IW_CQPSQ_SUSPENDQP_QPID) |\r\nLS_64(I40IW_CQP_OP_SUSPEND_QP, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "SUSPEND_QP WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nenum i40iw_status_code i40iw_sc_resume_qp(struct i40iw_sc_cqp *cqp,\r\nstruct i40iw_sc_qp *qp,\r\nu64 scratch)\r\n{\r\nu64 header;\r\nu64 *wqe;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe,\r\n16,\r\nLS_64(qp->qs_handle, I40IW_CQPSQ_RESUMEQP_QSHANDLE));\r\nheader = LS_64(qp->qp_uk.qp_id, I40IW_CQPSQ_RESUMEQP_QPID) |\r\nLS_64(I40IW_CQP_OP_RESUME_QP, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "RESUME_QP WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\ni40iw_sc_cqp_post_sq(cqp);\r\nreturn 0;\r\n}\r\nenum i40iw_status_code i40iw_sc_static_hmc_pages_allocated(\r\nstruct i40iw_sc_cqp *cqp,\r\nu64 scratch,\r\nu8 hmc_fn_id,\r\nbool post_sq,\r\nbool poll_registers)\r\n{\r\nu64 header;\r\nu64 *wqe;\r\nu32 tail, val, error;\r\nenum i40iw_status_code ret_code = 0;\r\nwqe = i40iw_sc_cqp_get_next_send_wqe(cqp, scratch);\r\nif (!wqe)\r\nreturn I40IW_ERR_RING_FULL;\r\nset_64bit_val(wqe,\r\n16,\r\nLS_64(hmc_fn_id, I40IW_SHMC_PAGE_ALLOCATED_HMC_FN_ID));\r\nheader = LS_64(I40IW_CQP_OP_SHMC_PAGES_ALLOCATED, I40IW_CQPSQ_OPCODE) |\r\nLS_64(cqp->polarity, I40IW_CQPSQ_WQEVALID);\r\ni40iw_insert_wqe_hdr(wqe, header);\r\ni40iw_debug_buf(cqp->dev, I40IW_DEBUG_WQE, "SHMC_PAGES_ALLOCATED WQE",\r\nwqe, I40IW_CQP_WQE_SIZE * 8);\r\ni40iw_get_cqp_reg_info(cqp, &val, &tail, &error);\r\nif (error) {\r\nret_code = I40IW_ERR_CQP_COMPL_ERROR;\r\nreturn ret_code;\r\n}\r\nif (post_sq) {\r\ni40iw_sc_cqp_post_sq(cqp);\r\nif (poll_registers)\r\nret_code = i40iw_cqp_poll_registers(cqp, tail, 1000);\r\nelse\r\nret_code = i40iw_sc_poll_for_cqp_op_done(cqp,\r\nI40IW_CQP_OP_SHMC_PAGES_ALLOCATED,\r\nNULL);\r\n}\r\nreturn ret_code;\r\n}\r\nstatic bool i40iw_ring_full(struct i40iw_sc_cqp *cqp)\r\n{\r\nreturn I40IW_RING_FULL_ERR(cqp->sq_ring);\r\n}\r\nstatic u64 i40iw_est_sd(struct i40iw_sc_dev *dev, struct i40iw_hmc_info *hmc_info)\r\n{\r\nint i;\r\nu64 size = 0;\r\nu64 sd;\r\nfor (i = I40IW_HMC_IW_QP; i < I40IW_HMC_IW_PBLE; i++)\r\nsize += hmc_info->hmc_obj[i].cnt * hmc_info->hmc_obj[i].size;\r\nif (dev->is_pf)\r\nsize += hmc_info->hmc_obj[I40IW_HMC_IW_PBLE].cnt * hmc_info->hmc_obj[I40IW_HMC_IW_PBLE].size;\r\nif (size & 0x1FFFFF)\r\nsd = (size >> 21) + 1;\r\nelse\r\nsd = size >> 21;\r\nif (!dev->is_pf) {\r\nsize = hmc_info->hmc_obj[I40IW_HMC_IW_PBLE].cnt * hmc_info->hmc_obj[I40IW_HMC_IW_PBLE].size;\r\nif (size & 0x1FFFFF)\r\nsd += (size >> 21) + 1;\r\nelse\r\nsd += size >> 21;\r\n}\r\nreturn sd;\r\n}\r\nenum i40iw_status_code i40iw_config_fpm_values(struct i40iw_sc_dev *dev, u32 qp_count)\r\n{\r\nstruct i40iw_virt_mem virt_mem;\r\nu32 i, mem_size;\r\nu32 qpwantedoriginal, qpwanted, mrwanted, pblewanted;\r\nu32 powerof2;\r\nu64 sd_needed;\r\nu32 loop_count = 0;\r\nstruct i40iw_hmc_info *hmc_info;\r\nstruct i40iw_hmc_fpm_misc *hmc_fpm_misc;\r\nenum i40iw_status_code ret_code = 0;\r\nhmc_info = dev->hmc_info;\r\nhmc_fpm_misc = &dev->hmc_fpm_misc;\r\nret_code = i40iw_sc_init_iw_hmc(dev, dev->hmc_fn_id);\r\nif (ret_code) {\r\ni40iw_debug(dev, I40IW_DEBUG_HMC,\r\n"i40iw_sc_init_iw_hmc returned error_code = %d\n",\r\nret_code);\r\nreturn ret_code;\r\n}\r\nfor (i = I40IW_HMC_IW_QP; i < I40IW_HMC_IW_MAX; i++)\r\nhmc_info->hmc_obj[i].cnt = hmc_info->hmc_obj[i].max_cnt;\r\nsd_needed = i40iw_est_sd(dev, hmc_info);\r\ni40iw_debug(dev, I40IW_DEBUG_HMC,\r\n"%s: FW initial max sd_count[%08lld] first_sd_index[%04d]\n",\r\n__func__, sd_needed, hmc_info->first_sd_index);\r\ni40iw_debug(dev, I40IW_DEBUG_HMC,\r\n"%s: sd count %d where max sd is %d\n",\r\n__func__, hmc_info->sd_table.sd_cnt,\r\nhmc_fpm_misc->max_sds);\r\nqpwanted = min(qp_count, hmc_info->hmc_obj[I40IW_HMC_IW_QP].max_cnt);\r\nqpwantedoriginal = qpwanted;\r\nmrwanted = hmc_info->hmc_obj[I40IW_HMC_IW_MR].max_cnt;\r\npblewanted = hmc_info->hmc_obj[I40IW_HMC_IW_PBLE].max_cnt;\r\ni40iw_debug(dev, I40IW_DEBUG_HMC,\r\n"req_qp=%d max_sd=%d, max_qp = %d, max_cq=%d, max_mr=%d, max_pble=%d\n",\r\nqp_count, hmc_fpm_misc->max_sds,\r\nhmc_info->hmc_obj[I40IW_HMC_IW_QP].max_cnt,\r\nhmc_info->hmc_obj[I40IW_HMC_IW_CQ].max_cnt,\r\nhmc_info->hmc_obj[I40IW_HMC_IW_MR].max_cnt,\r\nhmc_info->hmc_obj[I40IW_HMC_IW_PBLE].max_cnt);\r\ndo {\r\n++loop_count;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_QP].cnt = qpwanted;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_CQ].cnt =\r\nmin(2 * qpwanted, hmc_info->hmc_obj[I40IW_HMC_IW_CQ].cnt);\r\nhmc_info->hmc_obj[I40IW_HMC_IW_SRQ].cnt = 0x00;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_HTE].cnt =\r\nqpwanted * hmc_fpm_misc->ht_multiplier;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_ARP].cnt =\r\nhmc_info->hmc_obj[I40IW_HMC_IW_ARP].max_cnt;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_APBVT_ENTRY].cnt = 1;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_MR].cnt = mrwanted;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_XF].cnt = I40IW_MAX_WQ_ENTRIES * qpwanted;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_Q1].cnt = 4 * I40IW_MAX_IRD_SIZE * qpwanted;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_XFFL].cnt =\r\nhmc_info->hmc_obj[I40IW_HMC_IW_XF].cnt / hmc_fpm_misc->xf_block_size;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_Q1FL].cnt =\r\nhmc_info->hmc_obj[I40IW_HMC_IW_Q1].cnt / hmc_fpm_misc->q1_block_size;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_TIMER].cnt =\r\n((qpwanted) / 512 + 1) * hmc_fpm_misc->timer_bucket;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_FSIMC].cnt = 0x00;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_FSIAV].cnt = 0x00;\r\nhmc_info->hmc_obj[I40IW_HMC_IW_PBLE].cnt = pblewanted;\r\nsd_needed = i40iw_est_sd(dev, hmc_info);\r\nif ((loop_count > 1000) ||\r\n((!(loop_count % 10)) &&\r\n(qpwanted > qpwantedoriginal * 2 / 3))) {\r\nif (qpwanted > FPM_MULTIPLIER) {\r\nqpwanted -= FPM_MULTIPLIER;\r\npowerof2 = 1;\r\nwhile (powerof2 < qpwanted)\r\npowerof2 *= 2;\r\npowerof2 /= 2;\r\nqpwanted = powerof2;\r\n} else {\r\nqpwanted /= 2;\r\n}\r\n}\r\nif (mrwanted > FPM_MULTIPLIER * 10)\r\nmrwanted -= FPM_MULTIPLIER * 10;\r\nif (pblewanted > FPM_MULTIPLIER * 1000)\r\npblewanted -= FPM_MULTIPLIER * 1000;\r\n} while (sd_needed > hmc_fpm_misc->max_sds && loop_count < 2000);\r\nsd_needed = i40iw_est_sd(dev, hmc_info);\r\ni40iw_debug(dev, I40IW_DEBUG_HMC,\r\n"loop_cnt=%d, sd_needed=%lld, qpcnt = %d, cqcnt=%d, mrcnt=%d, pblecnt=%d\n",\r\nloop_count, sd_needed,\r\nhmc_info->hmc_obj[I40IW_HMC_IW_QP].cnt,\r\nhmc_info->hmc_obj[I40IW_HMC_IW_CQ].cnt,\r\nhmc_info->hmc_obj[I40IW_HMC_IW_MR].cnt,\r\nhmc_info->hmc_obj[I40IW_HMC_IW_PBLE].cnt);\r\nret_code = i40iw_sc_configure_iw_fpm(dev, dev->hmc_fn_id);\r\nif (ret_code) {\r\ni40iw_debug(dev, I40IW_DEBUG_HMC,\r\n"configure_iw_fpm returned error_code[x%08X]\n",\r\ni40iw_rd32(dev->hw, dev->is_pf ? I40E_PFPE_CQPERRCODES : I40E_VFPE_CQPERRCODES1));\r\nreturn ret_code;\r\n}\r\nmem_size = sizeof(struct i40iw_hmc_sd_entry) *\r\n(hmc_info->sd_table.sd_cnt + hmc_info->first_sd_index + 1);\r\nret_code = i40iw_allocate_virt_mem(dev->hw, &virt_mem, mem_size);\r\nif (ret_code) {\r\ni40iw_debug(dev, I40IW_DEBUG_HMC,\r\n"%s: failed to allocate memory for sd_entry buffer\n",\r\n__func__);\r\nreturn ret_code;\r\n}\r\nhmc_info->sd_table.sd_entry = virt_mem.va;\r\nreturn ret_code;\r\n}\r\nstatic enum i40iw_status_code i40iw_exec_cqp_cmd(struct i40iw_sc_dev *dev,\r\nstruct cqp_commands_info *pcmdinfo)\r\n{\r\nenum i40iw_status_code status;\r\nstruct i40iw_dma_mem values_mem;\r\ndev->cqp_cmd_stats[pcmdinfo->cqp_cmd]++;\r\nswitch (pcmdinfo->cqp_cmd) {\r\ncase OP_DELETE_LOCAL_MAC_IPADDR_ENTRY:\r\nstatus = i40iw_sc_del_local_mac_ipaddr_entry(\r\npcmdinfo->in.u.del_local_mac_ipaddr_entry.cqp,\r\npcmdinfo->in.u.del_local_mac_ipaddr_entry.scratch,\r\npcmdinfo->in.u.del_local_mac_ipaddr_entry.entry_idx,\r\npcmdinfo->in.u.del_local_mac_ipaddr_entry.ignore_ref_count,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_CEQ_DESTROY:\r\nstatus = i40iw_sc_ceq_destroy(pcmdinfo->in.u.ceq_destroy.ceq,\r\npcmdinfo->in.u.ceq_destroy.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_AEQ_DESTROY:\r\nstatus = i40iw_sc_aeq_destroy(pcmdinfo->in.u.aeq_destroy.aeq,\r\npcmdinfo->in.u.aeq_destroy.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_DELETE_ARP_CACHE_ENTRY:\r\nstatus = i40iw_sc_del_arp_cache_entry(\r\npcmdinfo->in.u.del_arp_cache_entry.cqp,\r\npcmdinfo->in.u.del_arp_cache_entry.scratch,\r\npcmdinfo->in.u.del_arp_cache_entry.arp_index,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_MANAGE_APBVT_ENTRY:\r\nstatus = i40iw_sc_manage_apbvt_entry(\r\npcmdinfo->in.u.manage_apbvt_entry.cqp,\r\n&pcmdinfo->in.u.manage_apbvt_entry.info,\r\npcmdinfo->in.u.manage_apbvt_entry.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_CEQ_CREATE:\r\nstatus = i40iw_sc_ceq_create(pcmdinfo->in.u.ceq_create.ceq,\r\npcmdinfo->in.u.ceq_create.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_AEQ_CREATE:\r\nstatus = i40iw_sc_aeq_create(pcmdinfo->in.u.aeq_create.aeq,\r\npcmdinfo->in.u.aeq_create.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_ALLOC_LOCAL_MAC_IPADDR_ENTRY:\r\nstatus = i40iw_sc_alloc_local_mac_ipaddr_entry(\r\npcmdinfo->in.u.alloc_local_mac_ipaddr_entry.cqp,\r\npcmdinfo->in.u.alloc_local_mac_ipaddr_entry.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_ADD_LOCAL_MAC_IPADDR_ENTRY:\r\nstatus = i40iw_sc_add_local_mac_ipaddr_entry(\r\npcmdinfo->in.u.add_local_mac_ipaddr_entry.cqp,\r\n&pcmdinfo->in.u.add_local_mac_ipaddr_entry.info,\r\npcmdinfo->in.u.add_local_mac_ipaddr_entry.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_MANAGE_QHASH_TABLE_ENTRY:\r\nstatus = i40iw_sc_manage_qhash_table_entry(\r\npcmdinfo->in.u.manage_qhash_table_entry.cqp,\r\n&pcmdinfo->in.u.manage_qhash_table_entry.info,\r\npcmdinfo->in.u.manage_qhash_table_entry.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_QP_MODIFY:\r\nstatus = i40iw_sc_qp_modify(\r\npcmdinfo->in.u.qp_modify.qp,\r\n&pcmdinfo->in.u.qp_modify.info,\r\npcmdinfo->in.u.qp_modify.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_QP_UPLOAD_CONTEXT:\r\nstatus = i40iw_sc_qp_upload_context(\r\npcmdinfo->in.u.qp_upload_context.dev,\r\n&pcmdinfo->in.u.qp_upload_context.info,\r\npcmdinfo->in.u.qp_upload_context.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_CQ_CREATE:\r\nstatus = i40iw_sc_cq_create(\r\npcmdinfo->in.u.cq_create.cq,\r\npcmdinfo->in.u.cq_create.scratch,\r\npcmdinfo->in.u.cq_create.check_overflow,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_CQ_DESTROY:\r\nstatus = i40iw_sc_cq_destroy(\r\npcmdinfo->in.u.cq_destroy.cq,\r\npcmdinfo->in.u.cq_destroy.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_QP_CREATE:\r\nstatus = i40iw_sc_qp_create(\r\npcmdinfo->in.u.qp_create.qp,\r\n&pcmdinfo->in.u.qp_create.info,\r\npcmdinfo->in.u.qp_create.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_QP_DESTROY:\r\nstatus = i40iw_sc_qp_destroy(\r\npcmdinfo->in.u.qp_destroy.qp,\r\npcmdinfo->in.u.qp_destroy.scratch,\r\npcmdinfo->in.u.qp_destroy.remove_hash_idx,\r\npcmdinfo->in.u.qp_destroy.\r\nignore_mw_bnd,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_ALLOC_STAG:\r\nstatus = i40iw_sc_alloc_stag(\r\npcmdinfo->in.u.alloc_stag.dev,\r\n&pcmdinfo->in.u.alloc_stag.info,\r\npcmdinfo->in.u.alloc_stag.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_MR_REG_NON_SHARED:\r\nstatus = i40iw_sc_mr_reg_non_shared(\r\npcmdinfo->in.u.mr_reg_non_shared.dev,\r\n&pcmdinfo->in.u.mr_reg_non_shared.info,\r\npcmdinfo->in.u.mr_reg_non_shared.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_DEALLOC_STAG:\r\nstatus = i40iw_sc_dealloc_stag(\r\npcmdinfo->in.u.dealloc_stag.dev,\r\n&pcmdinfo->in.u.dealloc_stag.info,\r\npcmdinfo->in.u.dealloc_stag.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_MW_ALLOC:\r\nstatus = i40iw_sc_mw_alloc(\r\npcmdinfo->in.u.mw_alloc.dev,\r\npcmdinfo->in.u.mw_alloc.scratch,\r\npcmdinfo->in.u.mw_alloc.mw_stag_index,\r\npcmdinfo->in.u.mw_alloc.pd_id,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_QP_FLUSH_WQES:\r\nstatus = i40iw_sc_qp_flush_wqes(\r\npcmdinfo->in.u.qp_flush_wqes.qp,\r\n&pcmdinfo->in.u.qp_flush_wqes.info,\r\npcmdinfo->in.u.qp_flush_wqes.\r\nscratch, pcmdinfo->post_sq);\r\nbreak;\r\ncase OP_ADD_ARP_CACHE_ENTRY:\r\nstatus = i40iw_sc_add_arp_cache_entry(\r\npcmdinfo->in.u.add_arp_cache_entry.cqp,\r\n&pcmdinfo->in.u.add_arp_cache_entry.info,\r\npcmdinfo->in.u.add_arp_cache_entry.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_MANAGE_PUSH_PAGE:\r\nstatus = i40iw_sc_manage_push_page(\r\npcmdinfo->in.u.manage_push_page.cqp,\r\n&pcmdinfo->in.u.manage_push_page.info,\r\npcmdinfo->in.u.manage_push_page.scratch,\r\npcmdinfo->post_sq);\r\nbreak;\r\ncase OP_UPDATE_PE_SDS:\r\nstatus = i40iw_update_pe_sds(\r\npcmdinfo->in.u.update_pe_sds.dev,\r\n&pcmdinfo->in.u.update_pe_sds.info,\r\npcmdinfo->in.u.update_pe_sds.\r\nscratch);\r\nbreak;\r\ncase OP_MANAGE_HMC_PM_FUNC_TABLE:\r\nstatus = i40iw_sc_manage_hmc_pm_func_table(\r\npcmdinfo->in.u.manage_hmc_pm.dev->cqp,\r\npcmdinfo->in.u.manage_hmc_pm.scratch,\r\n(u8)pcmdinfo->in.u.manage_hmc_pm.info.vf_id,\r\npcmdinfo->in.u.manage_hmc_pm.info.free_fcn,\r\ntrue);\r\nbreak;\r\ncase OP_SUSPEND:\r\nstatus = i40iw_sc_suspend_qp(\r\npcmdinfo->in.u.suspend_resume.cqp,\r\npcmdinfo->in.u.suspend_resume.qp,\r\npcmdinfo->in.u.suspend_resume.scratch);\r\nbreak;\r\ncase OP_RESUME:\r\nstatus = i40iw_sc_resume_qp(\r\npcmdinfo->in.u.suspend_resume.cqp,\r\npcmdinfo->in.u.suspend_resume.qp,\r\npcmdinfo->in.u.suspend_resume.scratch);\r\nbreak;\r\ncase OP_MANAGE_VF_PBLE_BP:\r\nstatus = i40iw_manage_vf_pble_bp(\r\npcmdinfo->in.u.manage_vf_pble_bp.cqp,\r\n&pcmdinfo->in.u.manage_vf_pble_bp.info,\r\npcmdinfo->in.u.manage_vf_pble_bp.scratch, true);\r\nbreak;\r\ncase OP_QUERY_FPM_VALUES:\r\nvalues_mem.pa = pcmdinfo->in.u.query_fpm_values.fpm_values_pa;\r\nvalues_mem.va = pcmdinfo->in.u.query_fpm_values.fpm_values_va;\r\nstatus = i40iw_sc_query_fpm_values(\r\npcmdinfo->in.u.query_fpm_values.cqp,\r\npcmdinfo->in.u.query_fpm_values.scratch,\r\npcmdinfo->in.u.query_fpm_values.hmc_fn_id,\r\n&values_mem, true, I40IW_CQP_WAIT_EVENT);\r\nbreak;\r\ncase OP_COMMIT_FPM_VALUES:\r\nvalues_mem.pa = pcmdinfo->in.u.commit_fpm_values.fpm_values_pa;\r\nvalues_mem.va = pcmdinfo->in.u.commit_fpm_values.fpm_values_va;\r\nstatus = i40iw_sc_commit_fpm_values(\r\npcmdinfo->in.u.commit_fpm_values.cqp,\r\npcmdinfo->in.u.commit_fpm_values.scratch,\r\npcmdinfo->in.u.commit_fpm_values.hmc_fn_id,\r\n&values_mem,\r\ntrue,\r\nI40IW_CQP_WAIT_EVENT);\r\nbreak;\r\ndefault:\r\nstatus = I40IW_NOT_SUPPORTED;\r\nbreak;\r\n}\r\nreturn status;\r\n}\r\nenum i40iw_status_code i40iw_process_cqp_cmd(struct i40iw_sc_dev *dev,\r\nstruct cqp_commands_info *pcmdinfo)\r\n{\r\nenum i40iw_status_code status = 0;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->cqp_lock, flags);\r\nif (list_empty(&dev->cqp_cmd_head) && !i40iw_ring_full(dev->cqp))\r\nstatus = i40iw_exec_cqp_cmd(dev, pcmdinfo);\r\nelse\r\nlist_add_tail(&pcmdinfo->cqp_cmd_entry, &dev->cqp_cmd_head);\r\nspin_unlock_irqrestore(&dev->cqp_lock, flags);\r\nreturn status;\r\n}\r\nenum i40iw_status_code i40iw_process_bh(struct i40iw_sc_dev *dev)\r\n{\r\nenum i40iw_status_code status = 0;\r\nstruct cqp_commands_info *pcmdinfo;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->cqp_lock, flags);\r\nwhile (!list_empty(&dev->cqp_cmd_head) && !i40iw_ring_full(dev->cqp)) {\r\npcmdinfo = (struct cqp_commands_info *)i40iw_remove_head(&dev->cqp_cmd_head);\r\nstatus = i40iw_exec_cqp_cmd(dev, pcmdinfo);\r\nif (status)\r\nbreak;\r\n}\r\nspin_unlock_irqrestore(&dev->cqp_lock, flags);\r\nreturn status;\r\n}\r\nstatic u32 i40iw_iwarp_opcode(struct i40iw_aeqe_info *info, u8 *pkt)\r\n{\r\n__be16 *mpa;\r\nu32 opcode = 0xffffffff;\r\nif (info->q2_data_written) {\r\nmpa = (__be16 *)pkt;\r\nopcode = ntohs(mpa[1]) & 0xf;\r\n}\r\nreturn opcode;\r\n}\r\nstatic u8 *i40iw_locate_mpa(u8 *pkt)\r\n{\r\npkt += I40IW_MAC_HLEN;\r\npkt += 4 * (pkt[0] & 0x0f);\r\npkt += 4 * ((pkt[12] >> 4) & 0x0f);\r\nreturn pkt;\r\n}\r\nstatic void i40iw_setup_termhdr(struct i40iw_sc_qp *qp,\r\nstruct i40iw_terminate_hdr *hdr,\r\nenum i40iw_flush_opcode opcode,\r\nu8 layer_etype,\r\nu8 err)\r\n{\r\nqp->flush_code = opcode;\r\nhdr->layer_etype = layer_etype;\r\nhdr->error_code = err;\r\n}\r\nstatic int i40iw_bld_terminate_hdr(struct i40iw_sc_qp *qp,\r\nstruct i40iw_aeqe_info *info)\r\n{\r\nu8 *pkt = qp->q2_buf + Q2_BAD_FRAME_OFFSET;\r\nu16 ddp_seg_len;\r\nint copy_len = 0;\r\nu8 is_tagged = 0;\r\nenum i40iw_flush_opcode flush_code = FLUSH_INVALID;\r\nu32 opcode;\r\nstruct i40iw_terminate_hdr *termhdr;\r\ntermhdr = (struct i40iw_terminate_hdr *)qp->q2_buf;\r\nmemset(termhdr, 0, Q2_BAD_FRAME_OFFSET);\r\nif (info->q2_data_written) {\r\npkt = i40iw_locate_mpa(pkt);\r\nddp_seg_len = ntohs(*(__be16 *)pkt);\r\nif (ddp_seg_len) {\r\ncopy_len = 2;\r\ntermhdr->hdrct = DDP_LEN_FLAG;\r\nif (pkt[2] & 0x80) {\r\nis_tagged = 1;\r\nif (ddp_seg_len >= TERM_DDP_LEN_TAGGED) {\r\ncopy_len += TERM_DDP_LEN_TAGGED;\r\ntermhdr->hdrct |= DDP_HDR_FLAG;\r\n}\r\n} else {\r\nif (ddp_seg_len >= TERM_DDP_LEN_UNTAGGED) {\r\ncopy_len += TERM_DDP_LEN_UNTAGGED;\r\ntermhdr->hdrct |= DDP_HDR_FLAG;\r\n}\r\nif (ddp_seg_len >= (TERM_DDP_LEN_UNTAGGED + TERM_RDMA_LEN)) {\r\nif ((pkt[3] & RDMA_OPCODE_MASK) == RDMA_READ_REQ_OPCODE) {\r\ncopy_len += TERM_RDMA_LEN;\r\ntermhdr->hdrct |= RDMA_HDR_FLAG;\r\n}\r\n}\r\n}\r\n}\r\n}\r\nopcode = i40iw_iwarp_opcode(info, pkt);\r\nswitch (info->ae_id) {\r\ncase I40IW_AE_AMP_UNALLOCATED_STAG:\r\nqp->eventtype = TERM_EVENT_QP_ACCESS_ERR;\r\nif (opcode == I40IW_OP_TYPE_RDMA_WRITE)\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_PROT_ERR,\r\n(LAYER_DDP << 4) | DDP_TAGGED_BUFFER, DDP_TAGGED_INV_STAG);\r\nelse\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_REM_ACCESS_ERR,\r\n(LAYER_RDMA << 4) | RDMAP_REMOTE_PROT, RDMAP_INV_STAG);\r\nbreak;\r\ncase I40IW_AE_AMP_BOUNDS_VIOLATION:\r\nqp->eventtype = TERM_EVENT_QP_ACCESS_ERR;\r\nif (info->q2_data_written)\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_PROT_ERR,\r\n(LAYER_DDP << 4) | DDP_TAGGED_BUFFER, DDP_TAGGED_BOUNDS);\r\nelse\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_REM_ACCESS_ERR,\r\n(LAYER_RDMA << 4) | RDMAP_REMOTE_PROT, RDMAP_INV_BOUNDS);\r\nbreak;\r\ncase I40IW_AE_AMP_BAD_PD:\r\nswitch (opcode) {\r\ncase I40IW_OP_TYPE_RDMA_WRITE:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_PROT_ERR,\r\n(LAYER_DDP << 4) | DDP_TAGGED_BUFFER, DDP_TAGGED_UNASSOC_STAG);\r\nbreak;\r\ncase I40IW_OP_TYPE_SEND_INV:\r\ncase I40IW_OP_TYPE_SEND_SOL_INV:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_REM_ACCESS_ERR,\r\n(LAYER_RDMA << 4) | RDMAP_REMOTE_PROT, RDMAP_CANT_INV_STAG);\r\nbreak;\r\ndefault:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_REM_ACCESS_ERR,\r\n(LAYER_RDMA << 4) | RDMAP_REMOTE_PROT, RDMAP_UNASSOC_STAG);\r\n}\r\nbreak;\r\ncase I40IW_AE_AMP_INVALID_STAG:\r\nqp->eventtype = TERM_EVENT_QP_ACCESS_ERR;\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_REM_ACCESS_ERR,\r\n(LAYER_RDMA << 4) | RDMAP_REMOTE_PROT, RDMAP_INV_STAG);\r\nbreak;\r\ncase I40IW_AE_AMP_BAD_QP:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_LOC_QP_OP_ERR,\r\n(LAYER_DDP << 4) | DDP_UNTAGGED_BUFFER, DDP_UNTAGGED_INV_QN);\r\nbreak;\r\ncase I40IW_AE_AMP_BAD_STAG_KEY:\r\ncase I40IW_AE_AMP_BAD_STAG_INDEX:\r\nqp->eventtype = TERM_EVENT_QP_ACCESS_ERR;\r\nswitch (opcode) {\r\ncase I40IW_OP_TYPE_SEND_INV:\r\ncase I40IW_OP_TYPE_SEND_SOL_INV:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_REM_OP_ERR,\r\n(LAYER_RDMA << 4) | RDMAP_REMOTE_OP, RDMAP_CANT_INV_STAG);\r\nbreak;\r\ndefault:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_REM_ACCESS_ERR,\r\n(LAYER_RDMA << 4) | RDMAP_REMOTE_OP, RDMAP_INV_STAG);\r\n}\r\nbreak;\r\ncase I40IW_AE_AMP_RIGHTS_VIOLATION:\r\ncase I40IW_AE_AMP_INVALIDATE_NO_REMOTE_ACCESS_RIGHTS:\r\ncase I40IW_AE_PRIV_OPERATION_DENIED:\r\nqp->eventtype = TERM_EVENT_QP_ACCESS_ERR;\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_REM_ACCESS_ERR,\r\n(LAYER_RDMA << 4) | RDMAP_REMOTE_PROT, RDMAP_ACCESS);\r\nbreak;\r\ncase I40IW_AE_AMP_TO_WRAP:\r\nqp->eventtype = TERM_EVENT_QP_ACCESS_ERR;\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_REM_ACCESS_ERR,\r\n(LAYER_RDMA << 4) | RDMAP_REMOTE_PROT, RDMAP_TO_WRAP);\r\nbreak;\r\ncase I40IW_AE_LLP_RECEIVED_MARKER_AND_LENGTH_FIELDS_DONT_MATCH:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_LOC_LEN_ERR,\r\n(LAYER_MPA << 4) | DDP_LLP, MPA_MARKER);\r\nbreak;\r\ncase I40IW_AE_LLP_RECEIVED_MPA_CRC_ERROR:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_GENERAL_ERR,\r\n(LAYER_MPA << 4) | DDP_LLP, MPA_CRC);\r\nbreak;\r\ncase I40IW_AE_LLP_SEGMENT_TOO_LARGE:\r\ncase I40IW_AE_LLP_SEGMENT_TOO_SMALL:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_LOC_LEN_ERR,\r\n(LAYER_DDP << 4) | DDP_CATASTROPHIC, DDP_CATASTROPHIC_LOCAL);\r\nbreak;\r\ncase I40IW_AE_LCE_QP_CATASTROPHIC:\r\ncase I40IW_AE_DDP_NO_L_BIT:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_FATAL_ERR,\r\n(LAYER_DDP << 4) | DDP_CATASTROPHIC, DDP_CATASTROPHIC_LOCAL);\r\nbreak;\r\ncase I40IW_AE_DDP_INVALID_MSN_GAP_IN_MSN:\r\ncase I40IW_AE_DDP_INVALID_MSN_RANGE_IS_NOT_VALID:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_GENERAL_ERR,\r\n(LAYER_DDP << 4) | DDP_UNTAGGED_BUFFER, DDP_UNTAGGED_INV_MSN_RANGE);\r\nbreak;\r\ncase I40IW_AE_DDP_UBE_DDP_MESSAGE_TOO_LONG_FOR_AVAILABLE_BUFFER:\r\nqp->eventtype = TERM_EVENT_QP_ACCESS_ERR;\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_LOC_LEN_ERR,\r\n(LAYER_DDP << 4) | DDP_UNTAGGED_BUFFER, DDP_UNTAGGED_INV_TOO_LONG);\r\nbreak;\r\ncase I40IW_AE_DDP_UBE_INVALID_DDP_VERSION:\r\nif (is_tagged)\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_GENERAL_ERR,\r\n(LAYER_DDP << 4) | DDP_TAGGED_BUFFER, DDP_TAGGED_INV_DDP_VER);\r\nelse\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_GENERAL_ERR,\r\n(LAYER_DDP << 4) | DDP_UNTAGGED_BUFFER, DDP_UNTAGGED_INV_DDP_VER);\r\nbreak;\r\ncase I40IW_AE_DDP_UBE_INVALID_MO:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_GENERAL_ERR,\r\n(LAYER_DDP << 4) | DDP_UNTAGGED_BUFFER, DDP_UNTAGGED_INV_MO);\r\nbreak;\r\ncase I40IW_AE_DDP_UBE_INVALID_MSN_NO_BUFFER_AVAILABLE:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_REM_OP_ERR,\r\n(LAYER_DDP << 4) | DDP_UNTAGGED_BUFFER, DDP_UNTAGGED_INV_MSN_NO_BUF);\r\nbreak;\r\ncase I40IW_AE_DDP_UBE_INVALID_QN:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_GENERAL_ERR,\r\n(LAYER_DDP << 4) | DDP_UNTAGGED_BUFFER, DDP_UNTAGGED_INV_QN);\r\nbreak;\r\ncase I40IW_AE_RDMAP_ROE_INVALID_RDMAP_VERSION:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_GENERAL_ERR,\r\n(LAYER_RDMA << 4) | RDMAP_REMOTE_OP, RDMAP_INV_RDMAP_VER);\r\nbreak;\r\ncase I40IW_AE_RDMAP_ROE_UNEXPECTED_OPCODE:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_LOC_QP_OP_ERR,\r\n(LAYER_RDMA << 4) | RDMAP_REMOTE_OP, RDMAP_UNEXPECTED_OP);\r\nbreak;\r\ndefault:\r\ni40iw_setup_termhdr(qp, termhdr, FLUSH_FATAL_ERR,\r\n(LAYER_RDMA << 4) | RDMAP_REMOTE_OP, RDMAP_UNSPECIFIED);\r\nbreak;\r\n}\r\nif (copy_len)\r\nmemcpy(termhdr + 1, pkt, copy_len);\r\nif (flush_code && !info->in_rdrsp_wr)\r\nqp->sq_flush = (info->sq) ? true : false;\r\nreturn sizeof(struct i40iw_terminate_hdr) + copy_len;\r\n}\r\nvoid i40iw_terminate_send_fin(struct i40iw_sc_qp *qp)\r\n{\r\ni40iw_term_modify_qp(qp,\r\nI40IW_QP_STATE_TERMINATE,\r\nI40IWQP_TERM_SEND_FIN_ONLY,\r\n0);\r\n}\r\nvoid i40iw_terminate_connection(struct i40iw_sc_qp *qp, struct i40iw_aeqe_info *info)\r\n{\r\nu8 termlen = 0;\r\nif (qp->term_flags & I40IW_TERM_SENT)\r\nreturn;\r\nqp->eventtype = TERM_EVENT_QP_FATAL;\r\ntermlen = i40iw_bld_terminate_hdr(qp, info);\r\ni40iw_terminate_start_timer(qp);\r\nqp->term_flags |= I40IW_TERM_SENT;\r\ni40iw_term_modify_qp(qp, I40IW_QP_STATE_TERMINATE,\r\nI40IWQP_TERM_SEND_TERM_ONLY, termlen);\r\n}\r\nvoid i40iw_terminate_received(struct i40iw_sc_qp *qp, struct i40iw_aeqe_info *info)\r\n{\r\nu8 *pkt = qp->q2_buf + Q2_BAD_FRAME_OFFSET;\r\n__be32 *mpa;\r\nu8 ddp_ctl;\r\nu8 rdma_ctl;\r\nu16 aeq_id = 0;\r\nstruct i40iw_terminate_hdr *termhdr;\r\nmpa = (__be32 *)i40iw_locate_mpa(pkt);\r\nif (info->q2_data_written) {\r\nddp_ctl = (ntohl(mpa[0]) >> 8) & 0xff;\r\nrdma_ctl = ntohl(mpa[0]) & 0xff;\r\nif ((ddp_ctl & 0xc0) != 0x40)\r\naeq_id = I40IW_AE_LCE_QP_CATASTROPHIC;\r\nelse if ((ddp_ctl & 0x03) != 1)\r\naeq_id = I40IW_AE_DDP_UBE_INVALID_DDP_VERSION;\r\nelse if (ntohl(mpa[2]) != 2)\r\naeq_id = I40IW_AE_DDP_UBE_INVALID_QN;\r\nelse if (ntohl(mpa[3]) != 1)\r\naeq_id = I40IW_AE_DDP_INVALID_MSN_GAP_IN_MSN;\r\nelse if (ntohl(mpa[4]) != 0)\r\naeq_id = I40IW_AE_DDP_UBE_INVALID_MO;\r\nelse if ((rdma_ctl & 0xc0) != 0x40)\r\naeq_id = I40IW_AE_RDMAP_ROE_INVALID_RDMAP_VERSION;\r\ninfo->ae_id = aeq_id;\r\nif (info->ae_id) {\r\ni40iw_terminate_connection(qp, info);\r\nreturn;\r\n}\r\n}\r\nqp->term_flags |= I40IW_TERM_RCVD;\r\nqp->eventtype = TERM_EVENT_QP_FATAL;\r\ntermhdr = (struct i40iw_terminate_hdr *)&mpa[5];\r\nif (termhdr->layer_etype == RDMAP_REMOTE_PROT ||\r\ntermhdr->layer_etype == RDMAP_REMOTE_OP) {\r\ni40iw_terminate_done(qp, 0);\r\n} else {\r\ni40iw_terminate_start_timer(qp);\r\ni40iw_terminate_send_fin(qp);\r\n}\r\n}\r\nstatic void i40iw_hw_stat_init(struct i40iw_dev_pestat *devstat,\r\nu8 fcn_idx,\r\nstruct i40iw_hw *hw, bool is_pf)\r\n{\r\nu32 stat_reg_offset;\r\nu32 stat_index;\r\nstruct i40iw_dev_hw_stat_offsets *stat_table =\r\n&devstat->hw_stat_offsets;\r\nstruct i40iw_dev_hw_stats *last_rd_stats = &devstat->last_read_hw_stats;\r\ndevstat->hw = hw;\r\nif (is_pf) {\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_IP4RXDISCARD] =\r\nI40E_GLPES_PFIP4RXDISCARD(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_IP4RXTRUNC] =\r\nI40E_GLPES_PFIP4RXTRUNC(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_IP4TXNOROUTE] =\r\nI40E_GLPES_PFIP4TXNOROUTE(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_IP6RXDISCARD] =\r\nI40E_GLPES_PFIP6RXDISCARD(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_IP6RXTRUNC] =\r\nI40E_GLPES_PFIP6RXTRUNC(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_IP6TXNOROUTE] =\r\nI40E_GLPES_PFIP6TXNOROUTE(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_TCPRTXSEG] =\r\nI40E_GLPES_PFTCPRTXSEG(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_TCPRXOPTERR] =\r\nI40E_GLPES_PFTCPRXOPTERR(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_TCPRXPROTOERR] =\r\nI40E_GLPES_PFTCPRXPROTOERR(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4RXOCTS] =\r\nI40E_GLPES_PFIP4RXOCTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4RXPKTS] =\r\nI40E_GLPES_PFIP4RXPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4RXFRAGS] =\r\nI40E_GLPES_PFIP4RXFRAGSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4RXMCPKTS] =\r\nI40E_GLPES_PFIP4RXMCPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4TXOCTS] =\r\nI40E_GLPES_PFIP4TXOCTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4TXPKTS] =\r\nI40E_GLPES_PFIP4TXPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4TXFRAGS] =\r\nI40E_GLPES_PFIP4TXFRAGSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4TXMCPKTS] =\r\nI40E_GLPES_PFIP4TXMCPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6RXOCTS] =\r\nI40E_GLPES_PFIP6RXOCTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6RXPKTS] =\r\nI40E_GLPES_PFIP6RXPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6RXFRAGS] =\r\nI40E_GLPES_PFIP6RXFRAGSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6RXMCPKTS] =\r\nI40E_GLPES_PFIP6RXMCPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6TXOCTS] =\r\nI40E_GLPES_PFIP6TXOCTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6TXPKTS] =\r\nI40E_GLPES_PFIP6TXPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6TXPKTS] =\r\nI40E_GLPES_PFIP6TXPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6TXFRAGS] =\r\nI40E_GLPES_PFIP6TXFRAGSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_TCPRXSEGS] =\r\nI40E_GLPES_PFTCPRXSEGSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_TCPTXSEG] =\r\nI40E_GLPES_PFTCPTXSEGLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMARXRDS] =\r\nI40E_GLPES_PFRDMARXRDSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMARXSNDS] =\r\nI40E_GLPES_PFRDMARXSNDSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMARXWRS] =\r\nI40E_GLPES_PFRDMARXWRSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMATXRDS] =\r\nI40E_GLPES_PFRDMATXRDSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMATXSNDS] =\r\nI40E_GLPES_PFRDMATXSNDSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMATXWRS] =\r\nI40E_GLPES_PFRDMATXWRSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMAVBND] =\r\nI40E_GLPES_PFRDMAVBNDLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMAVINV] =\r\nI40E_GLPES_PFRDMAVINVLO(fcn_idx);\r\n} else {\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_IP4RXDISCARD] =\r\nI40E_GLPES_VFIP4RXDISCARD(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_IP4RXTRUNC] =\r\nI40E_GLPES_VFIP4RXTRUNC(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_IP4TXNOROUTE] =\r\nI40E_GLPES_VFIP4TXNOROUTE(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_IP6RXDISCARD] =\r\nI40E_GLPES_VFIP6RXDISCARD(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_IP6RXTRUNC] =\r\nI40E_GLPES_VFIP6RXTRUNC(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_IP6TXNOROUTE] =\r\nI40E_GLPES_VFIP6TXNOROUTE(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_TCPRTXSEG] =\r\nI40E_GLPES_VFTCPRTXSEG(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_TCPRXOPTERR] =\r\nI40E_GLPES_VFTCPRXOPTERR(fcn_idx);\r\nstat_table->stat_offset_32[I40IW_HW_STAT_INDEX_TCPRXPROTOERR] =\r\nI40E_GLPES_VFTCPRXPROTOERR(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4RXOCTS] =\r\nI40E_GLPES_VFIP4RXOCTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4RXPKTS] =\r\nI40E_GLPES_VFIP4RXPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4RXFRAGS] =\r\nI40E_GLPES_VFIP4RXFRAGSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4RXMCPKTS] =\r\nI40E_GLPES_VFIP4RXMCPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4TXOCTS] =\r\nI40E_GLPES_VFIP4TXOCTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4TXPKTS] =\r\nI40E_GLPES_VFIP4TXPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4TXFRAGS] =\r\nI40E_GLPES_VFIP4TXFRAGSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP4TXMCPKTS] =\r\nI40E_GLPES_VFIP4TXMCPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6RXOCTS] =\r\nI40E_GLPES_VFIP6RXOCTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6RXPKTS] =\r\nI40E_GLPES_VFIP6RXPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6RXFRAGS] =\r\nI40E_GLPES_VFIP6RXFRAGSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6RXMCPKTS] =\r\nI40E_GLPES_VFIP6RXMCPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6TXOCTS] =\r\nI40E_GLPES_VFIP6TXOCTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6TXPKTS] =\r\nI40E_GLPES_VFIP6TXPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6TXPKTS] =\r\nI40E_GLPES_VFIP6TXPKTSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_IP6TXFRAGS] =\r\nI40E_GLPES_VFIP6TXFRAGSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_TCPRXSEGS] =\r\nI40E_GLPES_VFTCPRXSEGSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_TCPTXSEG] =\r\nI40E_GLPES_VFTCPTXSEGLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMARXRDS] =\r\nI40E_GLPES_VFRDMARXRDSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMARXSNDS] =\r\nI40E_GLPES_VFRDMARXSNDSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMARXWRS] =\r\nI40E_GLPES_VFRDMARXWRSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMATXRDS] =\r\nI40E_GLPES_VFRDMATXRDSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMATXSNDS] =\r\nI40E_GLPES_VFRDMATXSNDSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMATXWRS] =\r\nI40E_GLPES_VFRDMATXWRSLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMAVBND] =\r\nI40E_GLPES_VFRDMAVBNDLO(fcn_idx);\r\nstat_table->stat_offset_64[I40IW_HW_STAT_INDEX_RDMAVINV] =\r\nI40E_GLPES_VFRDMAVINVLO(fcn_idx);\r\n}\r\nfor (stat_index = 0; stat_index < I40IW_HW_STAT_INDEX_MAX_64;\r\nstat_index++) {\r\nstat_reg_offset = stat_table->stat_offset_64[stat_index];\r\nlast_rd_stats->stat_value_64[stat_index] =\r\nreadq(devstat->hw->hw_addr + stat_reg_offset);\r\n}\r\nfor (stat_index = 0; stat_index < I40IW_HW_STAT_INDEX_MAX_32;\r\nstat_index++) {\r\nstat_reg_offset = stat_table->stat_offset_32[stat_index];\r\nlast_rd_stats->stat_value_32[stat_index] =\r\ni40iw_rd32(devstat->hw, stat_reg_offset);\r\n}\r\n}\r\nstatic void i40iw_hw_stat_read_32(struct i40iw_dev_pestat *devstat,\r\nenum i40iw_hw_stat_index_32b index,\r\nu64 *value)\r\n{\r\nstruct i40iw_dev_hw_stat_offsets *stat_table =\r\n&devstat->hw_stat_offsets;\r\nstruct i40iw_dev_hw_stats *last_rd_stats = &devstat->last_read_hw_stats;\r\nstruct i40iw_dev_hw_stats *hw_stats = &devstat->hw_stats;\r\nu64 new_stat_value = 0;\r\nu32 stat_reg_offset = stat_table->stat_offset_32[index];\r\nnew_stat_value = i40iw_rd32(devstat->hw, stat_reg_offset);\r\nif (new_stat_value < last_rd_stats->stat_value_32[index])\r\nhw_stats->stat_value_32[index] += new_stat_value;\r\nelse\r\nhw_stats->stat_value_32[index] +=\r\nnew_stat_value - last_rd_stats->stat_value_32[index];\r\nlast_rd_stats->stat_value_32[index] = new_stat_value;\r\n*value = hw_stats->stat_value_32[index];\r\n}\r\nstatic void i40iw_hw_stat_read_64(struct i40iw_dev_pestat *devstat,\r\nenum i40iw_hw_stat_index_64b index,\r\nu64 *value)\r\n{\r\nstruct i40iw_dev_hw_stat_offsets *stat_table =\r\n&devstat->hw_stat_offsets;\r\nstruct i40iw_dev_hw_stats *last_rd_stats = &devstat->last_read_hw_stats;\r\nstruct i40iw_dev_hw_stats *hw_stats = &devstat->hw_stats;\r\nu64 new_stat_value = 0;\r\nu32 stat_reg_offset = stat_table->stat_offset_64[index];\r\nnew_stat_value = readq(devstat->hw->hw_addr + stat_reg_offset);\r\nif (new_stat_value < last_rd_stats->stat_value_64[index])\r\nhw_stats->stat_value_64[index] += new_stat_value;\r\nelse\r\nhw_stats->stat_value_64[index] +=\r\nnew_stat_value - last_rd_stats->stat_value_64[index];\r\nlast_rd_stats->stat_value_64[index] = new_stat_value;\r\n*value = hw_stats->stat_value_64[index];\r\n}\r\nstatic void i40iw_hw_stat_read_all(struct i40iw_dev_pestat *devstat,\r\nstruct i40iw_dev_hw_stats *stat_values)\r\n{\r\nu32 stat_index;\r\nfor (stat_index = 0; stat_index < I40IW_HW_STAT_INDEX_MAX_32;\r\nstat_index++)\r\ni40iw_hw_stat_read_32(devstat, stat_index,\r\n&stat_values->stat_value_32[stat_index]);\r\nfor (stat_index = 0; stat_index < I40IW_HW_STAT_INDEX_MAX_64;\r\nstat_index++)\r\ni40iw_hw_stat_read_64(devstat, stat_index,\r\n&stat_values->stat_value_64[stat_index]);\r\n}\r\nstatic void i40iw_hw_stat_refresh_all(struct i40iw_dev_pestat *devstat)\r\n{\r\nu64 stat_value;\r\nu32 stat_index;\r\nfor (stat_index = 0; stat_index < I40IW_HW_STAT_INDEX_MAX_32;\r\nstat_index++)\r\ni40iw_hw_stat_read_32(devstat, stat_index, &stat_value);\r\nfor (stat_index = 0; stat_index < I40IW_HW_STAT_INDEX_MAX_64;\r\nstat_index++)\r\ni40iw_hw_stat_read_64(devstat, stat_index, &stat_value);\r\n}\r\nenum i40iw_status_code i40iw_device_init_pestat(struct i40iw_dev_pestat *devstat)\r\n{\r\ndevstat->ops = iw_device_pestat_ops;\r\nreturn 0;\r\n}\r\nenum i40iw_status_code i40iw_device_init(struct i40iw_sc_dev *dev,\r\nstruct i40iw_device_init_info *info)\r\n{\r\nu32 val;\r\nu32 vchnl_ver = 0;\r\nu16 hmc_fcn = 0;\r\nenum i40iw_status_code ret_code = 0;\r\nu8 db_size;\r\nspin_lock_init(&dev->cqp_lock);\r\nINIT_LIST_HEAD(&dev->cqp_cmd_head);\r\ni40iw_device_init_uk(&dev->dev_uk);\r\ndev->debug_mask = info->debug_mask;\r\nret_code = i40iw_device_init_pestat(&dev->dev_pestat);\r\nif (ret_code) {\r\ni40iw_debug(dev, I40IW_DEBUG_DEV,\r\n"%s: i40iw_device_init_pestat failed\n", __func__);\r\nreturn ret_code;\r\n}\r\ndev->hmc_fn_id = info->hmc_fn_id;\r\ndev->qs_handle = info->qs_handle;\r\ndev->exception_lan_queue = info->exception_lan_queue;\r\ndev->is_pf = info->is_pf;\r\ndev->fpm_query_buf_pa = info->fpm_query_buf_pa;\r\ndev->fpm_query_buf = info->fpm_query_buf;\r\ndev->fpm_commit_buf_pa = info->fpm_commit_buf_pa;\r\ndev->fpm_commit_buf = info->fpm_commit_buf;\r\ndev->hw = info->hw;\r\ndev->hw->hw_addr = info->bar0;\r\nval = i40iw_rd32(dev->hw, I40E_GLPCI_DREVID);\r\ndev->hw_rev = (u8)RS_32(val, I40E_GLPCI_DREVID_DEFAULT_REVID);\r\nif (dev->is_pf) {\r\ndev->dev_pestat.ops.iw_hw_stat_init(&dev->dev_pestat,\r\ndev->hmc_fn_id, dev->hw, true);\r\nspin_lock_init(&dev->dev_pestat.stats_lock);\r\ni40iw_hw_stats_start_timer(dev);\r\nval = i40iw_rd32(dev->hw, I40E_GLPCI_LBARCTRL);\r\ndb_size = (u8)RS_32(val, I40E_GLPCI_LBARCTRL_PE_DB_SIZE);\r\nif ((db_size != I40IW_PE_DB_SIZE_4M) &&\r\n(db_size != I40IW_PE_DB_SIZE_8M)) {\r\ni40iw_debug(dev, I40IW_DEBUG_DEV,\r\n"%s: PE doorbell is not enabled in CSR val 0x%x\n",\r\n__func__, val);\r\nret_code = I40IW_ERR_PE_DOORBELL_NOT_ENABLED;\r\nreturn ret_code;\r\n}\r\ndev->db_addr = dev->hw->hw_addr + I40IW_DB_ADDR_OFFSET;\r\ndev->vchnl_if.vchnl_recv = i40iw_vchnl_recv_pf;\r\n} else {\r\ndev->db_addr = dev->hw->hw_addr + I40IW_VF_DB_ADDR_OFFSET;\r\n}\r\ndev->cqp_ops = &iw_cqp_ops;\r\ndev->ccq_ops = &iw_ccq_ops;\r\ndev->ceq_ops = &iw_ceq_ops;\r\ndev->aeq_ops = &iw_aeq_ops;\r\ndev->cqp_misc_ops = &iw_cqp_misc_ops;\r\ndev->iw_pd_ops = &iw_pd_ops;\r\ndev->iw_priv_qp_ops = &iw_priv_qp_ops;\r\ndev->iw_priv_cq_ops = &iw_priv_cq_ops;\r\ndev->mr_ops = &iw_mr_ops;\r\ndev->hmc_ops = &iw_hmc_ops;\r\ndev->vchnl_if.vchnl_send = info->vchnl_send;\r\nif (dev->vchnl_if.vchnl_send)\r\ndev->vchnl_up = true;\r\nelse\r\ndev->vchnl_up = false;\r\nif (!dev->is_pf) {\r\ndev->vchnl_if.vchnl_recv = i40iw_vchnl_recv_vf;\r\nret_code = i40iw_vchnl_vf_get_ver(dev, &vchnl_ver);\r\nif (!ret_code) {\r\ni40iw_debug(dev, I40IW_DEBUG_DEV,\r\n"%s: Get Channel version rc = 0x%0x, version is %u\n",\r\n__func__, ret_code, vchnl_ver);\r\nret_code = i40iw_vchnl_vf_get_hmc_fcn(dev, &hmc_fcn);\r\nif (!ret_code) {\r\ni40iw_debug(dev, I40IW_DEBUG_DEV,\r\n"%s Get HMC function rc = 0x%0x, hmc fcn is %u\n",\r\n__func__, ret_code, hmc_fcn);\r\ndev->hmc_fn_id = (u8)hmc_fcn;\r\n}\r\n}\r\n}\r\ndev->iw_vf_cqp_ops = &iw_vf_cqp_ops;\r\nreturn ret_code;\r\n}

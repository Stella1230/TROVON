static int probe_one_port(nasid_t nasid, int widget, int masterwid)\r\n{\r\nwidgetreg_t widget_id;\r\nxwidget_part_num_t partnum;\r\nwidget_id = *(volatile widgetreg_t *)\r\n(RAW_NODE_SWIN_BASE(nasid, widget) + WIDGET_ID);\r\npartnum = XWIDGET_PART_NUM(widget_id);\r\nprintk(KERN_INFO "Cpu %d, Nasid 0x%x, widget 0x%x (partnum 0x%x) is ",\r\nsmp_processor_id(), nasid, widget, partnum);\r\nswitch (partnum) {\r\ncase BRIDGE_WIDGET_PART_NUM:\r\ncase XBRIDGE_WIDGET_PART_NUM:\r\nbridge_probe(nasid, widget, masterwid);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int xbow_probe(nasid_t nasid)\r\n{\r\nlboard_t *brd;\r\nklxbow_t *xbow_p;\r\nunsigned masterwid, i;\r\nprintk("is xbow\n");\r\nbrd = find_lboard((lboard_t *)KL_CONFIG_INFO(nasid), KLTYPE_MIDPLANE8);\r\nif (!brd)\r\nreturn -ENODEV;\r\nxbow_p = (klxbow_t *)find_component(brd, NULL, KLSTRUCT_XBOW);\r\nif (!xbow_p)\r\nreturn -ENODEV;\r\n#ifdef WIDGET_A\r\ni = HUB_WIDGET_ID_MAX + 1;\r\ndo {\r\ni--;\r\n} while ((!XBOW_PORT_TYPE_HUB(xbow_p, i)) ||\r\n(!XBOW_PORT_IS_ENABLED(xbow_p, i)));\r\n#else\r\ni = HUB_WIDGET_ID_MIN - 1;\r\ndo {\r\ni++;\r\n} while ((!XBOW_PORT_TYPE_HUB(xbow_p, i)) ||\r\n(!XBOW_PORT_IS_ENABLED(xbow_p, i)));\r\n#endif\r\nmasterwid = i;\r\nif (nasid != XBOW_PORT_NASID(xbow_p, i))\r\nreturn 1;\r\nfor (i = HUB_WIDGET_ID_MIN; i <= HUB_WIDGET_ID_MAX; i++) {\r\nif (XBOW_PORT_IS_ENABLED(xbow_p, i) &&\r\nXBOW_PORT_TYPE_IO(xbow_p, i))\r\nprobe_one_port(nasid, i, masterwid);\r\n}\r\nreturn 0;\r\n}\r\nvoid xtalk_probe_node(cnodeid_t nid)\r\n{\r\nvolatile u64 hubreg;\r\nnasid_t nasid;\r\nxwidget_part_num_t partnum;\r\nwidgetreg_t widget_id;\r\nnasid = COMPACT_TO_NASID_NODEID(nid);\r\nhubreg = REMOTE_HUB_L(nasid, IIO_LLP_CSR);\r\nif (!(hubreg & IIO_LLP_CSR_IS_UP))\r\nreturn;\r\nwidget_id = *(volatile widgetreg_t *)\r\n(RAW_NODE_SWIN_BASE(nasid, 0x0) + WIDGET_ID);\r\npartnum = XWIDGET_PART_NUM(widget_id);\r\nprintk(KERN_INFO "Cpu %d, Nasid 0x%x: partnum 0x%x is ",\r\nsmp_processor_id(), nasid, partnum);\r\nswitch (partnum) {\r\ncase BRIDGE_WIDGET_PART_NUM:\r\nbridge_probe(nasid, 0x8, 0xa);\r\nbreak;\r\ncase XBOW_WIDGET_PART_NUM:\r\ncase XXBOW_WIDGET_PART_NUM:\r\nxbow_probe(nasid);\r\nbreak;\r\ndefault:\r\nprintk(" unknown widget??\n");\r\nbreak;\r\n}\r\n}

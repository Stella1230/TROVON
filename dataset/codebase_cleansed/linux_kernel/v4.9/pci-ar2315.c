static inline struct ar2315_pci_ctrl *ar2315_pci_bus_to_apc(struct pci_bus *bus)\r\n{\r\nstruct pci_controller *hose = bus->sysdata;\r\nreturn container_of(hose, struct ar2315_pci_ctrl, pci_ctrl);\r\n}\r\nstatic inline u32 ar2315_pci_reg_read(struct ar2315_pci_ctrl *apc, u32 reg)\r\n{\r\nreturn __raw_readl(apc->mmr_mem + reg);\r\n}\r\nstatic inline void ar2315_pci_reg_write(struct ar2315_pci_ctrl *apc, u32 reg,\r\nu32 val)\r\n{\r\n__raw_writel(val, apc->mmr_mem + reg);\r\n}\r\nstatic inline void ar2315_pci_reg_mask(struct ar2315_pci_ctrl *apc, u32 reg,\r\nu32 mask, u32 val)\r\n{\r\nu32 ret = ar2315_pci_reg_read(apc, reg);\r\nret &= ~mask;\r\nret |= val;\r\nar2315_pci_reg_write(apc, reg, ret);\r\n}\r\nstatic int ar2315_pci_cfg_access(struct ar2315_pci_ctrl *apc, unsigned devfn,\r\nint where, int size, u32 *ptr, bool write)\r\n{\r\nint func = PCI_FUNC(devfn);\r\nint dev = PCI_SLOT(devfn);\r\nu32 addr = (1 << (13 + dev)) | (func << 8) | (where & ~3);\r\nu32 mask = 0xffffffff >> 8 * (4 - size);\r\nu32 sh = (where & 3) * 8;\r\nu32 value, isr;\r\nif (addr >= AR2315_PCI_CFG_SIZE || dev > 18)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nar2315_pci_reg_write(apc, AR2315_PCI_ISR, AR2315_PCI_INT_ABORT);\r\nar2315_pci_reg_mask(apc, AR2315_PCI_MISC_CONFIG, 0,\r\nAR2315_PCIMISC_CFG_SEL);\r\nmb();\r\nvalue = __raw_readl(apc->cfg_mem + addr);\r\nisr = ar2315_pci_reg_read(apc, AR2315_PCI_ISR);\r\nif (isr & AR2315_PCI_INT_ABORT)\r\ngoto exit_err;\r\nif (write) {\r\nvalue = (value & ~(mask << sh)) | *ptr << sh;\r\n__raw_writel(value, apc->cfg_mem + addr);\r\nisr = ar2315_pci_reg_read(apc, AR2315_PCI_ISR);\r\nif (isr & AR2315_PCI_INT_ABORT)\r\ngoto exit_err;\r\n} else {\r\n*ptr = (value >> sh) & mask;\r\n}\r\ngoto exit;\r\nexit_err:\r\nar2315_pci_reg_write(apc, AR2315_PCI_ISR, AR2315_PCI_INT_ABORT);\r\nif (!write)\r\n*ptr = 0xffffffff;\r\nexit:\r\nar2315_pci_reg_mask(apc, AR2315_PCI_MISC_CONFIG, AR2315_PCIMISC_CFG_SEL,\r\n0);\r\nreturn isr & AR2315_PCI_INT_ABORT ? PCIBIOS_DEVICE_NOT_FOUND :\r\nPCIBIOS_SUCCESSFUL;\r\n}\r\nstatic inline int ar2315_pci_local_cfg_rd(struct ar2315_pci_ctrl *apc,\r\nunsigned devfn, int where, u32 *val)\r\n{\r\nreturn ar2315_pci_cfg_access(apc, devfn, where, sizeof(u32), val,\r\nfalse);\r\n}\r\nstatic inline int ar2315_pci_local_cfg_wr(struct ar2315_pci_ctrl *apc,\r\nunsigned devfn, int where, u32 val)\r\n{\r\nreturn ar2315_pci_cfg_access(apc, devfn, where, sizeof(u32), &val,\r\ntrue);\r\n}\r\nstatic int ar2315_pci_cfg_read(struct pci_bus *bus, unsigned devfn, int where,\r\nint size, u32 *value)\r\n{\r\nstruct ar2315_pci_ctrl *apc = ar2315_pci_bus_to_apc(bus);\r\nif (PCI_SLOT(devfn) == AR2315_PCI_HOST_SLOT)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nreturn ar2315_pci_cfg_access(apc, devfn, where, size, value, false);\r\n}\r\nstatic int ar2315_pci_cfg_write(struct pci_bus *bus, unsigned devfn, int where,\r\nint size, u32 value)\r\n{\r\nstruct ar2315_pci_ctrl *apc = ar2315_pci_bus_to_apc(bus);\r\nif (PCI_SLOT(devfn) == AR2315_PCI_HOST_SLOT)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nreturn ar2315_pci_cfg_access(apc, devfn, where, size, &value, true);\r\n}\r\nstatic int ar2315_pci_host_setup(struct ar2315_pci_ctrl *apc)\r\n{\r\nunsigned devfn = PCI_DEVFN(AR2315_PCI_HOST_SLOT, 0);\r\nint res;\r\nu32 id;\r\nres = ar2315_pci_local_cfg_rd(apc, devfn, PCI_VENDOR_ID, &id);\r\nif (res != PCIBIOS_SUCCESSFUL || id != AR2315_PCI_HOST_DEVID)\r\nreturn -ENODEV;\r\nar2315_pci_local_cfg_wr(apc, devfn, PCI_BASE_ADDRESS_0,\r\nAR2315_PCI_HOST_MBAR0);\r\nar2315_pci_local_cfg_wr(apc, devfn, PCI_BASE_ADDRESS_1,\r\nAR2315_PCI_HOST_MBAR1);\r\nar2315_pci_local_cfg_wr(apc, devfn, PCI_BASE_ADDRESS_2,\r\nAR2315_PCI_HOST_MBAR2);\r\nar2315_pci_local_cfg_wr(apc, devfn, PCI_COMMAND, PCI_COMMAND_MEMORY |\r\nPCI_COMMAND_MASTER | PCI_COMMAND_SPECIAL |\r\nPCI_COMMAND_INVALIDATE | PCI_COMMAND_PARITY |\r\nPCI_COMMAND_SERR | PCI_COMMAND_FAST_BACK);\r\nreturn 0;\r\n}\r\nstatic void ar2315_pci_irq_handler(struct irq_desc *desc)\r\n{\r\nstruct ar2315_pci_ctrl *apc = irq_desc_get_handler_data(desc);\r\nu32 pending = ar2315_pci_reg_read(apc, AR2315_PCI_ISR) &\r\nar2315_pci_reg_read(apc, AR2315_PCI_IMR);\r\nunsigned pci_irq = 0;\r\nif (pending)\r\npci_irq = irq_find_mapping(apc->domain, __ffs(pending));\r\nif (pci_irq)\r\ngeneric_handle_irq(pci_irq);\r\nelse\r\nspurious_interrupt();\r\n}\r\nstatic void ar2315_pci_irq_mask(struct irq_data *d)\r\n{\r\nstruct ar2315_pci_ctrl *apc = irq_data_get_irq_chip_data(d);\r\nar2315_pci_reg_mask(apc, AR2315_PCI_IMR, BIT(d->hwirq), 0);\r\n}\r\nstatic void ar2315_pci_irq_mask_ack(struct irq_data *d)\r\n{\r\nstruct ar2315_pci_ctrl *apc = irq_data_get_irq_chip_data(d);\r\nu32 m = BIT(d->hwirq);\r\nar2315_pci_reg_mask(apc, AR2315_PCI_IMR, m, 0);\r\nar2315_pci_reg_write(apc, AR2315_PCI_ISR, m);\r\n}\r\nstatic void ar2315_pci_irq_unmask(struct irq_data *d)\r\n{\r\nstruct ar2315_pci_ctrl *apc = irq_data_get_irq_chip_data(d);\r\nar2315_pci_reg_mask(apc, AR2315_PCI_IMR, 0, BIT(d->hwirq));\r\n}\r\nstatic int ar2315_pci_irq_map(struct irq_domain *d, unsigned irq,\r\nirq_hw_number_t hw)\r\n{\r\nirq_set_chip_and_handler(irq, &ar2315_pci_irq_chip, handle_level_irq);\r\nirq_set_chip_data(irq, d->host_data);\r\nreturn 0;\r\n}\r\nstatic void ar2315_pci_irq_init(struct ar2315_pci_ctrl *apc)\r\n{\r\nar2315_pci_reg_mask(apc, AR2315_PCI_IER, AR2315_PCI_IER_ENABLE, 0);\r\nar2315_pci_reg_mask(apc, AR2315_PCI_IMR, (AR2315_PCI_INT_ABORT |\r\nAR2315_PCI_INT_EXT), 0);\r\napc->irq_ext = irq_create_mapping(apc->domain, AR2315_PCI_IRQ_EXT);\r\nirq_set_chained_handler_and_data(apc->irq, ar2315_pci_irq_handler,\r\napc);\r\nar2315_pci_reg_write(apc, AR2315_PCI_ISR, AR2315_PCI_INT_ABORT |\r\nAR2315_PCI_INT_EXT);\r\nar2315_pci_reg_mask(apc, AR2315_PCI_IER, 0, AR2315_PCI_IER_ENABLE);\r\n}\r\nstatic int ar2315_pci_probe(struct platform_device *pdev)\r\n{\r\nstruct ar2315_pci_ctrl *apc;\r\nstruct device *dev = &pdev->dev;\r\nstruct resource *res;\r\nint irq, err;\r\napc = devm_kzalloc(dev, sizeof(*apc), GFP_KERNEL);\r\nif (!apc)\r\nreturn -ENOMEM;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0)\r\nreturn -EINVAL;\r\napc->irq = irq;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM,\r\n"ar2315-pci-ctrl");\r\napc->mmr_mem = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(apc->mmr_mem))\r\nreturn PTR_ERR(apc->mmr_mem);\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM,\r\n"ar2315-pci-ext");\r\nif (!res)\r\nreturn -EINVAL;\r\napc->mem_res.name = "AR2315 PCI mem space";\r\napc->mem_res.parent = res;\r\napc->mem_res.start = res->start;\r\napc->mem_res.end = res->end;\r\napc->mem_res.flags = IORESOURCE_MEM;\r\napc->cfg_mem = devm_ioremap_nocache(dev, res->start,\r\nAR2315_PCI_CFG_SIZE);\r\nif (!apc->cfg_mem) {\r\ndev_err(dev, "failed to remap PCI config space\n");\r\nreturn -ENOMEM;\r\n}\r\nar2315_pci_reg_mask(apc, AR2315_PCI_MISC_CONFIG,\r\nAR2315_PCIMISC_RST_MODE,\r\nAR2315_PCIRST_LOW);\r\nmsleep(100);\r\nar2315_pci_reg_mask(apc, AR2315_PCI_MISC_CONFIG,\r\nAR2315_PCIMISC_RST_MODE,\r\nAR2315_PCIRST_HIGH | AR2315_PCICACHE_DIS | 0x8);\r\nar2315_pci_reg_write(apc, AR2315_PCI_UNCACHE_CFG,\r\n0x1E |\r\n(1 << 5) |\r\n(0x2 << 30) );\r\nar2315_pci_reg_read(apc, AR2315_PCI_UNCACHE_CFG);\r\nmsleep(500);\r\nerr = ar2315_pci_host_setup(apc);\r\nif (err)\r\nreturn err;\r\napc->domain = irq_domain_add_linear(NULL, AR2315_PCI_IRQ_COUNT,\r\n&ar2315_pci_irq_domain_ops, apc);\r\nif (!apc->domain) {\r\ndev_err(dev, "failed to add IRQ domain\n");\r\nreturn -ENOMEM;\r\n}\r\nar2315_pci_irq_init(apc);\r\napc->io_res.name = "AR2315 IO space";\r\napc->io_res.start = 0;\r\napc->io_res.end = 0;\r\napc->io_res.flags = IORESOURCE_IO,\r\napc->pci_ctrl.pci_ops = &ar2315_pci_ops;\r\napc->pci_ctrl.mem_resource = &apc->mem_res,\r\napc->pci_ctrl.io_resource = &apc->io_res,\r\nregister_pci_controller(&apc->pci_ctrl);\r\ndev_info(dev, "register PCI controller\n");\r\nreturn 0;\r\n}\r\nstatic int __init ar2315_pci_init(void)\r\n{\r\nreturn platform_driver_register(&ar2315_pci_driver);\r\n}\r\nint pcibios_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstruct ar2315_pci_ctrl *apc = ar2315_pci_bus_to_apc(dev->bus);\r\nreturn slot ? 0 : apc->irq_ext;\r\n}\r\nint pcibios_plat_dev_init(struct pci_dev *dev)\r\n{\r\nreturn 0;\r\n}

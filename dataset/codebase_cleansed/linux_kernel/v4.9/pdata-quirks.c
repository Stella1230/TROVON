static void __init omap2420_n8x0_legacy_init(void)\r\n{\r\nomap_auxdata_lookup[0].platform_data = n8x0_legacy_init();\r\n}\r\nstatic void __init omap3_gpio126_127_129(void)\r\n{\r\nu32 reg;\r\nreg = omap_ctrl_readl(OMAP343X_CONTROL_PBIAS_LITE);\r\nreg &= ~OMAP343X_PBIASLITEVMODE1;\r\nreg |= OMAP343X_PBIASLITEPWRDNZ1;\r\nomap_ctrl_writel(reg, OMAP343X_CONTROL_PBIAS_LITE);\r\nif (cpu_is_omap3630()) {\r\nreg = omap_ctrl_readl(OMAP34XX_CONTROL_WKUP_CTRL);\r\nreg |= OMAP36XX_GPIO_IO_PWRDNZ;\r\nomap_ctrl_writel(reg, OMAP34XX_CONTROL_WKUP_CTRL);\r\n}\r\n}\r\nstatic void __init hsmmc2_internal_input_clk(void)\r\n{\r\nu32 reg;\r\nreg = omap_ctrl_readl(OMAP343X_CONTROL_DEVCONF1);\r\nreg |= OMAP2_MMCSDIO2ADPCLKISEL;\r\nomap_ctrl_writel(reg, OMAP343X_CONTROL_DEVCONF1);\r\n}\r\nstatic int omap3_sbc_t3730_twl_callback(struct device *dev,\r\nunsigned gpio,\r\nunsigned ngpio)\r\n{\r\nint res;\r\nres = gpio_request_one(gpio + 2, GPIOF_OUT_INIT_HIGH,\r\n"wlan pwr");\r\nif (res)\r\nreturn res;\r\ngpio_export(gpio, 0);\r\nreturn 0;\r\n}\r\nstatic void __init omap3_sbc_t3x_usb_hub_init(int gpio, char *hub_name)\r\n{\r\nint err = gpio_request_one(gpio, GPIOF_OUT_INIT_LOW, hub_name);\r\nif (err) {\r\npr_err("SBC-T3x: %s reset gpio request failed: %d\n",\r\nhub_name, err);\r\nreturn;\r\n}\r\ngpio_export(gpio, 0);\r\nudelay(10);\r\ngpio_set_value(gpio, 1);\r\nmsleep(1);\r\n}\r\nstatic void __init omap3_sbc_t3730_twl_init(void)\r\n{\r\ntwl_gpio_auxdata.setup = omap3_sbc_t3730_twl_callback;\r\n}\r\nstatic void __init omap3_sbc_t3730_legacy_init(void)\r\n{\r\nomap3_sbc_t3x_usb_hub_init(167, "sb-t35 usb hub");\r\n}\r\nstatic void __init omap3_sbc_t3530_legacy_init(void)\r\n{\r\nomap3_sbc_t3x_usb_hub_init(167, "sb-t35 usb hub");\r\n}\r\nstatic void __init omap3_igep0020_rev_f_legacy_init(void)\r\n{\r\nplatform_device_register(&wl18xx_device);\r\nplatform_device_register(&btwilink_device);\r\n}\r\nstatic void __init omap3_igep0030_rev_g_legacy_init(void)\r\n{\r\nplatform_device_register(&wl18xx_device);\r\nplatform_device_register(&btwilink_device);\r\n}\r\nstatic void __init omap3_evm_legacy_init(void)\r\n{\r\nhsmmc2_internal_input_clk();\r\n}\r\nstatic void am35xx_enable_emac_int(void)\r\n{\r\nu32 v;\r\nv = omap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR);\r\nv |= (AM35XX_CPGMAC_C0_RX_PULSE_CLR | AM35XX_CPGMAC_C0_TX_PULSE_CLR |\r\nAM35XX_CPGMAC_C0_MISC_PULSE_CLR | AM35XX_CPGMAC_C0_RX_THRESH_CLR);\r\nomap_ctrl_writel(v, AM35XX_CONTROL_LVL_INTR_CLEAR);\r\nomap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR);\r\n}\r\nstatic void am35xx_disable_emac_int(void)\r\n{\r\nu32 v;\r\nv = omap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR);\r\nv |= (AM35XX_CPGMAC_C0_RX_PULSE_CLR | AM35XX_CPGMAC_C0_TX_PULSE_CLR);\r\nomap_ctrl_writel(v, AM35XX_CONTROL_LVL_INTR_CLEAR);\r\nomap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR);\r\n}\r\nstatic void __init am35xx_emac_reset(void)\r\n{\r\nu32 v;\r\nv = omap_ctrl_readl(AM35XX_CONTROL_IP_SW_RESET);\r\nv &= ~AM35XX_CPGMACSS_SW_RST;\r\nomap_ctrl_writel(v, AM35XX_CONTROL_IP_SW_RESET);\r\nomap_ctrl_readl(AM35XX_CONTROL_IP_SW_RESET);\r\n}\r\nstatic void __init omap3_sbc_t3517_wifi_init(void)\r\n{\r\nint err = gpio_request_array(cm_t3517_wlan_gpios,\r\nARRAY_SIZE(cm_t3517_wlan_gpios));\r\nif (err) {\r\npr_err("SBC-T3517: wl12xx gpios request failed: %d\n", err);\r\nreturn;\r\n}\r\ngpio_export(cm_t3517_wlan_gpios[0].gpio, 0);\r\ngpio_export(cm_t3517_wlan_gpios[1].gpio, 0);\r\nmsleep(100);\r\ngpio_set_value(cm_t3517_wlan_gpios[1].gpio, 0);\r\n}\r\nstatic void __init omap3_sbc_t3517_legacy_init(void)\r\n{\r\nomap3_sbc_t3x_usb_hub_init(152, "cm-t3517 usb hub");\r\nomap3_sbc_t3x_usb_hub_init(98, "sb-t35 usb hub");\r\nam35xx_emac_reset();\r\nhsmmc2_internal_input_clk();\r\nomap3_sbc_t3517_wifi_init();\r\n}\r\nstatic void __init am3517_evm_legacy_init(void)\r\n{\r\nam35xx_emac_reset();\r\n}\r\nstatic void __init nokia_n900_legacy_init(void)\r\n{\r\nhsmmc2_internal_input_clk();\r\nmmc_pdata[0].name = "external";\r\nmmc_pdata[1].name = "internal";\r\nif (omap_type() == OMAP2_DEVICE_TYPE_SEC) {\r\nif (IS_ENABLED(CONFIG_ARM_ERRATA_430973)) {\r\npr_info("RX-51: Enabling ARM errata 430973 workaround\n");\r\nrx51_secure_update_aux_cr(BIT(6), 0);\r\n} else {\r\npr_warn("RX-51: Not enabling ARM errata 430973 workaround\n");\r\npr_warn("Thumb binaries may crash randomly without this workaround\n");\r\n}\r\npr_info("RX-51: Registering OMAP3 HWRNG device\n");\r\nplatform_device_register(&omap3_rom_rng_device);\r\n}\r\n}\r\nstatic void __init omap3_tao3530_legacy_init(void)\r\n{\r\nhsmmc2_internal_input_clk();\r\n}\r\nstatic void __init omap3_logicpd_torpedo_init(void)\r\n{\r\nomap3_gpio126_127_129();\r\nplatform_device_register(&wl128x_device);\r\nplatform_device_register(&btwilink_device);\r\n}\r\nstatic void pandora_wl1251_init_card(struct mmc_card *card)\r\n{\r\nif (card->type == MMC_TYPE_SDIO || card->type == MMC_TYPE_SD_COMBO) {\r\ncard->quirks |= MMC_QUIRK_NONSTD_SDIO;\r\ncard->cccr.wide_bus = 1;\r\ncard->cis.vendor = 0x104c;\r\ncard->cis.device = 0x9066;\r\ncard->cis.blksize = 512;\r\ncard->cis.max_dtr = 24000000;\r\ncard->ocr = 0x80;\r\n}\r\n}\r\nstatic void __init pandora_wl1251_init(void)\r\n{\r\nstruct wl1251_platform_data pandora_wl1251_pdata;\r\nint ret;\r\nmemset(&pandora_wl1251_pdata, 0, sizeof(pandora_wl1251_pdata));\r\npandora_wl1251_pdata.power_gpio = -1;\r\nret = gpio_request_one(PANDORA_WIFI_IRQ_GPIO, GPIOF_IN, "wl1251 irq");\r\nif (ret < 0)\r\ngoto fail;\r\npandora_wl1251_pdata.irq = gpio_to_irq(PANDORA_WIFI_IRQ_GPIO);\r\nif (pandora_wl1251_pdata.irq < 0)\r\ngoto fail_irq;\r\npandora_wl1251_pdata.use_eeprom = true;\r\nret = wl1251_set_platform_data(&pandora_wl1251_pdata);\r\nif (ret < 0)\r\ngoto fail_irq;\r\nreturn;\r\nfail_irq:\r\ngpio_free(PANDORA_WIFI_IRQ_GPIO);\r\nfail:\r\npr_err("wl1251 board initialisation failed\n");\r\n}\r\nstatic void __init omap3_pandora_legacy_init(void)\r\n{\r\nplatform_device_register(&pandora_backlight);\r\nplatform_device_register(&pandora_vwlan_device);\r\nomap_hsmmc_init(pandora_mmc3);\r\nomap_hsmmc_late_init(pandora_mmc3);\r\npandora_wl1251_init();\r\n}\r\nstatic void __init omap5_uevm_legacy_init(void)\r\n{\r\n}\r\nvoid omap_pcs_legacy_init(int irq, void (*rearm)(void))\r\n{\r\npcs_pdata.irq = irq;\r\npcs_pdata.rearm = rearm;\r\n}\r\nvoid omap_auxdata_legacy_init(struct device *dev)\r\n{\r\nif (dev->platform_data)\r\nreturn;\r\nif (strcmp("twl4030-gpio", dev_name(dev)))\r\nreturn;\r\ndev->platform_data = &twl_gpio_auxdata;\r\n}\r\nstatic void __init omap3_mcbsp_init(void)\r\n{\r\nomap3_mcbsp_init_pdata_callback(&mcbsp_pdata);\r\n}\r\nstatic void __init omap3_mcbsp_init(void) {}\r\nstatic void pdata_quirks_check(struct pdata_init *quirks)\r\n{\r\nwhile (quirks->compatible) {\r\nif (of_machine_is_compatible(quirks->compatible)) {\r\nif (quirks->fn)\r\nquirks->fn();\r\nbreak;\r\n}\r\nquirks++;\r\n}\r\n}\r\nvoid __init pdata_quirks_init(const struct of_device_id *omap_dt_match_table)\r\n{\r\nif (of_machine_is_compatible("ti,omap2420") ||\r\nof_machine_is_compatible("ti,omap3"))\r\nomap_sdrc_init(NULL, NULL);\r\nif (of_machine_is_compatible("ti,omap3"))\r\nomap3_mcbsp_init();\r\npdata_quirks_check(auxdata_quirks);\r\nof_platform_populate(NULL, omap_dt_match_table,\r\nomap_auxdata_lookup, NULL);\r\npdata_quirks_check(pdata_quirks);\r\n}

static int mips_next_event(unsigned long delta,\r\nstruct clock_event_device *evt)\r\n{\r\nunsigned int cnt;\r\nint res;\r\ncnt = read_c0_count();\r\ncnt += delta;\r\nwrite_c0_compare(cnt);\r\nres = ((int)(read_c0_count() - cnt) >= 0) ? -ETIME : 0;\r\nreturn res;\r\n}\r\nstatic unsigned int calculate_min_delta(void)\r\n{\r\nunsigned int cnt, i, j, k, l;\r\nunsigned int buf1[4], buf2[3];\r\nunsigned int min_delta;\r\nfor (i = 0; i < 5; ++i) {\r\nfor (j = 0; j < 5; ++j) {\r\ncnt = read_c0_count();\r\nwrite_c0_compare(cnt);\r\ncnt = read_c0_count() - cnt;\r\nfor (k = 0; k < j; ++k) {\r\nif (cnt < buf1[k]) {\r\nl = min_t(unsigned int,\r\nj, ARRAY_SIZE(buf1) - 1);\r\nfor (; l > k; --l)\r\nbuf1[l] = buf1[l - 1];\r\nbreak;\r\n}\r\n}\r\nif (k < ARRAY_SIZE(buf1))\r\nbuf1[k] = cnt;\r\n}\r\nfor (k = 0; k < i; ++k) {\r\nif (buf1[ARRAY_SIZE(buf1) - 1] < buf2[k]) {\r\nl = min_t(unsigned int,\r\ni, ARRAY_SIZE(buf2) - 1);\r\nfor (; l > k; --l)\r\nbuf2[l] = buf2[l - 1];\r\nbreak;\r\n}\r\n}\r\nif (k < ARRAY_SIZE(buf2))\r\nbuf2[k] = buf1[ARRAY_SIZE(buf1) - 1];\r\n}\r\nmin_delta = buf2[ARRAY_SIZE(buf2) - 1] * 2;\r\nif (min_delta < 0x300)\r\nmin_delta = 0x300;\r\npr_debug("%s: median 75th percentile=%#x, min_delta=%#x\n",\r\n__func__, buf2[ARRAY_SIZE(buf2) - 1], min_delta);\r\nreturn min_delta;\r\n}\r\nstatic inline int handle_perf_irq(int r2)\r\n{\r\nreturn (cp0_perfcount_irq < 0) &&\r\nperf_irq() == IRQ_HANDLED &&\r\n!r2;\r\n}\r\nirqreturn_t c0_compare_interrupt(int irq, void *dev_id)\r\n{\r\nconst int r2 = cpu_has_mips_r2_r6;\r\nstruct clock_event_device *cd;\r\nint cpu = smp_processor_id();\r\nif (handle_perf_irq(r2))\r\nreturn IRQ_HANDLED;\r\nif (!r2 || (read_c0_cause() & CAUSEF_TI)) {\r\nwrite_c0_compare(read_c0_compare());\r\ncd = &per_cpu(mips_clockevent_device, cpu);\r\ncd->event_handler(cd);\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nvoid mips_event_handler(struct clock_event_device *dev)\r\n{\r\n}\r\nstatic int c0_compare_int_pending(void)\r\n{\r\nreturn (read_c0_cause() >> cp0_compare_irq_shift) & (1ul << CAUSEB_IP);\r\n}\r\nint c0_compare_int_usable(void)\r\n{\r\nunsigned int delta;\r\nunsigned int cnt;\r\n#ifdef CONFIG_KVM_GUEST\r\nreturn 1;\r\n#endif\r\nif (c0_compare_int_pending()) {\r\ncnt = read_c0_count();\r\nwrite_c0_compare(cnt);\r\nback_to_back_c0_hazard();\r\nwhile (read_c0_count() < (cnt + COMPARE_INT_SEEN_TICKS))\r\nif (!c0_compare_int_pending())\r\nbreak;\r\nif (c0_compare_int_pending())\r\nreturn 0;\r\n}\r\nfor (delta = 0x10; delta <= 0x400000; delta <<= 1) {\r\ncnt = read_c0_count();\r\ncnt += delta;\r\nwrite_c0_compare(cnt);\r\nback_to_back_c0_hazard();\r\nif ((int)(read_c0_count() - cnt) < 0)\r\nbreak;\r\n}\r\nwhile ((int)(read_c0_count() - cnt) <= 0)\r\n;\r\nwhile (read_c0_count() < (cnt + COMPARE_INT_SEEN_TICKS))\r\nif (c0_compare_int_pending())\r\nbreak;\r\nif (!c0_compare_int_pending())\r\nreturn 0;\r\ncnt = read_c0_count();\r\nwrite_c0_compare(cnt);\r\nback_to_back_c0_hazard();\r\nwhile (read_c0_count() < (cnt + COMPARE_INT_SEEN_TICKS))\r\nif (!c0_compare_int_pending())\r\nbreak;\r\nif (c0_compare_int_pending())\r\nreturn 0;\r\nreturn 1;\r\n}\r\nunsigned int __weak get_c0_compare_int(void)\r\n{\r\nreturn MIPS_CPU_IRQ_BASE + cp0_compare_irq;\r\n}\r\nint r4k_clockevent_init(void)\r\n{\r\nunsigned int cpu = smp_processor_id();\r\nstruct clock_event_device *cd;\r\nunsigned int irq, min_delta;\r\nif (!cpu_has_counter || !mips_hpt_frequency)\r\nreturn -ENXIO;\r\nif (!c0_compare_int_usable())\r\nreturn -ENXIO;\r\nirq = get_c0_compare_int();\r\ncd = &per_cpu(mips_clockevent_device, cpu);\r\ncd->name = "MIPS";\r\ncd->features = CLOCK_EVT_FEAT_ONESHOT |\r\nCLOCK_EVT_FEAT_C3STOP |\r\nCLOCK_EVT_FEAT_PERCPU;\r\nmin_delta = calculate_min_delta();\r\ncd->rating = 300;\r\ncd->irq = irq;\r\ncd->cpumask = cpumask_of(cpu);\r\ncd->set_next_event = mips_next_event;\r\ncd->event_handler = mips_event_handler;\r\nclockevents_config_and_register(cd, mips_hpt_frequency, min_delta, 0x7fffffff);\r\nif (cp0_timer_irq_installed)\r\nreturn 0;\r\ncp0_timer_irq_installed = 1;\r\nsetup_irq(irq, &c0_compare_irqaction);\r\nreturn 0;\r\n}

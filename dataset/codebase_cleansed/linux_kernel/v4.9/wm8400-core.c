static bool wm8400_volatile(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase WM8400_INTERRUPT_STATUS_1:\r\ncase WM8400_INTERRUPT_LEVELS:\r\ncase WM8400_SHUTDOWN_REASON:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nint wm8400_block_read(struct wm8400 *wm8400, u8 reg, int count, u16 *data)\r\n{\r\nreturn regmap_bulk_read(wm8400->regmap, reg, data, count);\r\n}\r\nstatic int wm8400_register_codec(struct wm8400 *wm8400)\r\n{\r\nconst struct mfd_cell cell = {\r\n.name = "wm8400-codec",\r\n.platform_data = wm8400,\r\n.pdata_size = sizeof(*wm8400),\r\n};\r\nreturn devm_mfd_add_devices(wm8400->dev, -1, &cell, 1, NULL, 0, NULL);\r\n}\r\nstatic int wm8400_init(struct wm8400 *wm8400,\r\nstruct wm8400_platform_data *pdata)\r\n{\r\nunsigned int reg;\r\nint ret;\r\ndev_set_drvdata(wm8400->dev, wm8400);\r\nret = regmap_read(wm8400->regmap, WM8400_RESET_ID, &reg);\r\nif (ret != 0) {\r\ndev_err(wm8400->dev, "Chip ID register read failed\n");\r\nreturn -EIO;\r\n}\r\nif (reg != 0x6172) {\r\ndev_err(wm8400->dev, "Device is not a WM8400, ID is %x\n",\r\nreg);\r\nreturn -ENODEV;\r\n}\r\nret = regmap_read(wm8400->regmap, WM8400_ID, &reg);\r\nif (ret != 0) {\r\ndev_err(wm8400->dev, "ID register read failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nreg = (reg & WM8400_CHIP_REV_MASK) >> WM8400_CHIP_REV_SHIFT;\r\ndev_info(wm8400->dev, "WM8400 revision %x\n", reg);\r\nret = wm8400_register_codec(wm8400);\r\nif (ret != 0) {\r\ndev_err(wm8400->dev, "Failed to register codec\n");\r\nreturn ret;\r\n}\r\nif (pdata && pdata->platform_init) {\r\nret = pdata->platform_init(wm8400->dev);\r\nif (ret != 0) {\r\ndev_err(wm8400->dev, "Platform init failed: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\n} else\r\ndev_warn(wm8400->dev, "No platform initialisation supplied\n");\r\nreturn 0;\r\n}\r\nvoid wm8400_reset_codec_reg_cache(struct wm8400 *wm8400)\r\n{\r\nregmap_reinit_cache(wm8400->regmap, &wm8400_regmap_config);\r\n}\r\nstatic int wm8400_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct wm8400 *wm8400;\r\nwm8400 = devm_kzalloc(&i2c->dev, sizeof(struct wm8400), GFP_KERNEL);\r\nif (!wm8400)\r\nreturn -ENOMEM;\r\nwm8400->regmap = devm_regmap_init_i2c(i2c, &wm8400_regmap_config);\r\nif (IS_ERR(wm8400->regmap))\r\nreturn PTR_ERR(wm8400->regmap);\r\nwm8400->dev = &i2c->dev;\r\ni2c_set_clientdata(i2c, wm8400);\r\nreturn wm8400_init(wm8400, dev_get_platdata(&i2c->dev));\r\n}\r\nstatic int __init wm8400_module_init(void)\r\n{\r\nint ret = -ENODEV;\r\n#if IS_ENABLED(CONFIG_I2C)\r\nret = i2c_add_driver(&wm8400_i2c_driver);\r\nif (ret != 0)\r\npr_err("Failed to register I2C driver: %d\n", ret);\r\n#endif\r\nreturn ret;\r\n}\r\nstatic void __exit wm8400_module_exit(void)\r\n{\r\n#if IS_ENABLED(CONFIG_I2C)\r\ni2c_del_driver(&wm8400_i2c_driver);\r\n#endif\r\n}

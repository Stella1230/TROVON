void wimax_report_rfkill_hw(struct wimax_dev *wimax_dev,\r\nenum wimax_rf_state state)\r\n{\r\nint result;\r\nstruct device *dev = wimax_dev_to_dev(wimax_dev);\r\nenum wimax_st wimax_state;\r\nd_fnstart(3, dev, "(wimax_dev %p state %u)\n", wimax_dev, state);\r\nBUG_ON(state == WIMAX_RF_QUERY);\r\nBUG_ON(state != WIMAX_RF_ON && state != WIMAX_RF_OFF);\r\nmutex_lock(&wimax_dev->mutex);\r\nresult = wimax_dev_is_ready(wimax_dev);\r\nif (result < 0)\r\ngoto error_not_ready;\r\nif (state != wimax_dev->rf_hw) {\r\nwimax_dev->rf_hw = state;\r\nif (wimax_dev->rf_hw == WIMAX_RF_ON &&\r\nwimax_dev->rf_sw == WIMAX_RF_ON)\r\nwimax_state = WIMAX_ST_READY;\r\nelse\r\nwimax_state = WIMAX_ST_RADIO_OFF;\r\nresult = rfkill_set_hw_state(wimax_dev->rfkill,\r\nstate == WIMAX_RF_OFF);\r\n__wimax_state_change(wimax_dev, wimax_state);\r\n}\r\nerror_not_ready:\r\nmutex_unlock(&wimax_dev->mutex);\r\nd_fnend(3, dev, "(wimax_dev %p state %u) = void [%d]\n",\r\nwimax_dev, state, result);\r\n}\r\nvoid wimax_report_rfkill_sw(struct wimax_dev *wimax_dev,\r\nenum wimax_rf_state state)\r\n{\r\nint result;\r\nstruct device *dev = wimax_dev_to_dev(wimax_dev);\r\nenum wimax_st wimax_state;\r\nd_fnstart(3, dev, "(wimax_dev %p state %u)\n", wimax_dev, state);\r\nBUG_ON(state == WIMAX_RF_QUERY);\r\nBUG_ON(state != WIMAX_RF_ON && state != WIMAX_RF_OFF);\r\nmutex_lock(&wimax_dev->mutex);\r\nresult = wimax_dev_is_ready(wimax_dev);\r\nif (result < 0)\r\ngoto error_not_ready;\r\nif (state != wimax_dev->rf_sw) {\r\nwimax_dev->rf_sw = state;\r\nif (wimax_dev->rf_hw == WIMAX_RF_ON &&\r\nwimax_dev->rf_sw == WIMAX_RF_ON)\r\nwimax_state = WIMAX_ST_READY;\r\nelse\r\nwimax_state = WIMAX_ST_RADIO_OFF;\r\n__wimax_state_change(wimax_dev, wimax_state);\r\nrfkill_set_sw_state(wimax_dev->rfkill, state == WIMAX_RF_OFF);\r\n}\r\nerror_not_ready:\r\nmutex_unlock(&wimax_dev->mutex);\r\nd_fnend(3, dev, "(wimax_dev %p state %u) = void [%d]\n",\r\nwimax_dev, state, result);\r\n}\r\nstatic\r\nint __wimax_rf_toggle_radio(struct wimax_dev *wimax_dev,\r\nenum wimax_rf_state state)\r\n{\r\nint result = 0;\r\nstruct device *dev = wimax_dev_to_dev(wimax_dev);\r\nenum wimax_st wimax_state;\r\nmight_sleep();\r\nd_fnstart(3, dev, "(wimax_dev %p state %u)\n", wimax_dev, state);\r\nif (wimax_dev->rf_sw == state)\r\ngoto out_no_change;\r\nif (wimax_dev->op_rfkill_sw_toggle != NULL)\r\nresult = wimax_dev->op_rfkill_sw_toggle(wimax_dev, state);\r\nelse if (state == WIMAX_RF_OFF)\r\nresult = -ENXIO;\r\nelse\r\nresult = 0;\r\nif (result >= 0) {\r\nresult = 0;\r\nwimax_dev->rf_sw = state;\r\nwimax_state = state == WIMAX_RF_ON ?\r\nWIMAX_ST_READY : WIMAX_ST_RADIO_OFF;\r\n__wimax_state_change(wimax_dev, wimax_state);\r\n}\r\nout_no_change:\r\nd_fnend(3, dev, "(wimax_dev %p state %u) = %d\n",\r\nwimax_dev, state, result);\r\nreturn result;\r\n}\r\nstatic int wimax_rfkill_set_radio_block(void *data, bool blocked)\r\n{\r\nint result;\r\nstruct wimax_dev *wimax_dev = data;\r\nstruct device *dev = wimax_dev_to_dev(wimax_dev);\r\nenum wimax_rf_state rf_state;\r\nd_fnstart(3, dev, "(wimax_dev %p blocked %u)\n", wimax_dev, blocked);\r\nrf_state = WIMAX_RF_ON;\r\nif (blocked)\r\nrf_state = WIMAX_RF_OFF;\r\nmutex_lock(&wimax_dev->mutex);\r\nif (wimax_dev->state <= __WIMAX_ST_QUIESCING)\r\nresult = 0;\r\nelse\r\nresult = __wimax_rf_toggle_radio(wimax_dev, rf_state);\r\nmutex_unlock(&wimax_dev->mutex);\r\nd_fnend(3, dev, "(wimax_dev %p blocked %u) = %d\n",\r\nwimax_dev, blocked, result);\r\nreturn result;\r\n}\r\nint wimax_rfkill(struct wimax_dev *wimax_dev, enum wimax_rf_state state)\r\n{\r\nint result;\r\nstruct device *dev = wimax_dev_to_dev(wimax_dev);\r\nd_fnstart(3, dev, "(wimax_dev %p state %u)\n", wimax_dev, state);\r\nmutex_lock(&wimax_dev->mutex);\r\nresult = wimax_dev_is_ready(wimax_dev);\r\nif (result < 0) {\r\nif (result == -ENOMEDIUM && state == WIMAX_RF_QUERY)\r\nresult = WIMAX_RF_OFF << 1 | WIMAX_RF_OFF;\r\ngoto error_not_ready;\r\n}\r\nswitch (state) {\r\ncase WIMAX_RF_ON:\r\ncase WIMAX_RF_OFF:\r\nresult = __wimax_rf_toggle_radio(wimax_dev, state);\r\nif (result < 0)\r\ngoto error;\r\nrfkill_set_sw_state(wimax_dev->rfkill, state == WIMAX_RF_OFF);\r\nbreak;\r\ncase WIMAX_RF_QUERY:\r\nbreak;\r\ndefault:\r\nresult = -EINVAL;\r\ngoto error;\r\n}\r\nresult = wimax_dev->rf_sw << 1 | wimax_dev->rf_hw;\r\nerror:\r\nerror_not_ready:\r\nmutex_unlock(&wimax_dev->mutex);\r\nd_fnend(3, dev, "(wimax_dev %p state %u) = %d\n",\r\nwimax_dev, state, result);\r\nreturn result;\r\n}\r\nint wimax_rfkill_add(struct wimax_dev *wimax_dev)\r\n{\r\nint result;\r\nstruct rfkill *rfkill;\r\nstruct device *dev = wimax_dev_to_dev(wimax_dev);\r\nd_fnstart(3, dev, "(wimax_dev %p)\n", wimax_dev);\r\nresult = -ENOMEM;\r\nrfkill = rfkill_alloc(wimax_dev->name, dev, RFKILL_TYPE_WIMAX,\r\n&wimax_rfkill_ops, wimax_dev);\r\nif (rfkill == NULL)\r\ngoto error_rfkill_allocate;\r\nd_printf(1, dev, "rfkill %p\n", rfkill);\r\nwimax_dev->rfkill = rfkill;\r\nrfkill_init_sw_state(rfkill, 1);\r\nresult = rfkill_register(wimax_dev->rfkill);\r\nif (result < 0)\r\ngoto error_rfkill_register;\r\nif (wimax_dev->op_rfkill_sw_toggle == NULL)\r\nwimax_dev->rf_sw = WIMAX_RF_ON;\r\nd_fnend(3, dev, "(wimax_dev %p) = 0\n", wimax_dev);\r\nreturn 0;\r\nerror_rfkill_register:\r\nrfkill_destroy(wimax_dev->rfkill);\r\nerror_rfkill_allocate:\r\nd_fnend(3, dev, "(wimax_dev %p) = %d\n", wimax_dev, result);\r\nreturn result;\r\n}\r\nvoid wimax_rfkill_rm(struct wimax_dev *wimax_dev)\r\n{\r\nstruct device *dev = wimax_dev_to_dev(wimax_dev);\r\nd_fnstart(3, dev, "(wimax_dev %p)\n", wimax_dev);\r\nrfkill_unregister(wimax_dev->rfkill);\r\nrfkill_destroy(wimax_dev->rfkill);\r\nd_fnend(3, dev, "(wimax_dev %p)\n", wimax_dev);\r\n}\r\nint wimax_gnl_doit_rfkill(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nint result, ifindex;\r\nstruct wimax_dev *wimax_dev;\r\nstruct device *dev;\r\nenum wimax_rf_state new_state;\r\nd_fnstart(3, NULL, "(skb %p info %p)\n", skb, info);\r\nresult = -ENODEV;\r\nif (info->attrs[WIMAX_GNL_RFKILL_IFIDX] == NULL) {\r\npr_err("WIMAX_GNL_OP_RFKILL: can't find IFIDX attribute\n");\r\ngoto error_no_wimax_dev;\r\n}\r\nifindex = nla_get_u32(info->attrs[WIMAX_GNL_RFKILL_IFIDX]);\r\nwimax_dev = wimax_dev_get_by_genl_info(info, ifindex);\r\nif (wimax_dev == NULL)\r\ngoto error_no_wimax_dev;\r\ndev = wimax_dev_to_dev(wimax_dev);\r\nresult = -EINVAL;\r\nif (info->attrs[WIMAX_GNL_RFKILL_STATE] == NULL) {\r\ndev_err(dev, "WIMAX_GNL_RFKILL: can't find RFKILL_STATE "\r\n"attribute\n");\r\ngoto error_no_pid;\r\n}\r\nnew_state = nla_get_u32(info->attrs[WIMAX_GNL_RFKILL_STATE]);\r\nresult = wimax_rfkill(wimax_dev, new_state);\r\nerror_no_pid:\r\ndev_put(wimax_dev->net_dev);\r\nerror_no_wimax_dev:\r\nd_fnend(3, NULL, "(skb %p info %p) = %d\n", skb, info, result);\r\nreturn result;\r\n}

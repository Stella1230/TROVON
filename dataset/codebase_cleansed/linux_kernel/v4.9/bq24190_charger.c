static u8 bq24190_find_idx(const int tbl[], int tbl_size, int v)\r\n{\r\nint i;\r\nfor (i = 1; i < tbl_size; i++)\r\nif (v < tbl[i])\r\nbreak;\r\nreturn i - 1;\r\n}\r\nstatic int bq24190_read(struct bq24190_dev_info *bdi, u8 reg, u8 *data)\r\n{\r\nint ret;\r\nret = i2c_smbus_read_byte_data(bdi->client, reg);\r\nif (ret < 0)\r\nreturn ret;\r\n*data = ret;\r\nreturn 0;\r\n}\r\nstatic int bq24190_write(struct bq24190_dev_info *bdi, u8 reg, u8 data)\r\n{\r\nreturn i2c_smbus_write_byte_data(bdi->client, reg, data);\r\n}\r\nstatic int bq24190_read_mask(struct bq24190_dev_info *bdi, u8 reg,\r\nu8 mask, u8 shift, u8 *data)\r\n{\r\nu8 v;\r\nint ret;\r\nret = bq24190_read(bdi, reg, &v);\r\nif (ret < 0)\r\nreturn ret;\r\nv &= mask;\r\nv >>= shift;\r\n*data = v;\r\nreturn 0;\r\n}\r\nstatic int bq24190_write_mask(struct bq24190_dev_info *bdi, u8 reg,\r\nu8 mask, u8 shift, u8 data)\r\n{\r\nu8 v;\r\nint ret;\r\nret = bq24190_read(bdi, reg, &v);\r\nif (ret < 0)\r\nreturn ret;\r\nv &= ~mask;\r\nv |= ((data << shift) & mask);\r\nreturn bq24190_write(bdi, reg, v);\r\n}\r\nstatic int bq24190_get_field_val(struct bq24190_dev_info *bdi,\r\nu8 reg, u8 mask, u8 shift,\r\nconst int tbl[], int tbl_size,\r\nint *val)\r\n{\r\nu8 v;\r\nint ret;\r\nret = bq24190_read_mask(bdi, reg, mask, shift, &v);\r\nif (ret < 0)\r\nreturn ret;\r\nv = (v >= tbl_size) ? (tbl_size - 1) : v;\r\n*val = tbl[v];\r\nreturn 0;\r\n}\r\nstatic int bq24190_set_field_val(struct bq24190_dev_info *bdi,\r\nu8 reg, u8 mask, u8 shift,\r\nconst int tbl[], int tbl_size,\r\nint val)\r\n{\r\nu8 idx;\r\nidx = bq24190_find_idx(tbl, tbl_size, val);\r\nreturn bq24190_write_mask(bdi, reg, mask, shift, idx);\r\n}\r\nstatic void bq24190_sysfs_init_attrs(void)\r\n{\r\nint i, limit = ARRAY_SIZE(bq24190_sysfs_field_tbl);\r\nfor (i = 0; i < limit; i++)\r\nbq24190_sysfs_attrs[i] = &bq24190_sysfs_field_tbl[i].attr.attr;\r\nbq24190_sysfs_attrs[limit] = NULL;\r\n}\r\nstatic struct bq24190_sysfs_field_info *bq24190_sysfs_field_lookup(\r\nconst char *name)\r\n{\r\nint i, limit = ARRAY_SIZE(bq24190_sysfs_field_tbl);\r\nfor (i = 0; i < limit; i++)\r\nif (!strcmp(name, bq24190_sysfs_field_tbl[i].attr.attr.name))\r\nbreak;\r\nif (i >= limit)\r\nreturn NULL;\r\nreturn &bq24190_sysfs_field_tbl[i];\r\n}\r\nstatic ssize_t bq24190_sysfs_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct power_supply *psy = dev_get_drvdata(dev);\r\nstruct bq24190_dev_info *bdi = power_supply_get_drvdata(psy);\r\nstruct bq24190_sysfs_field_info *info;\r\nint ret;\r\nu8 v;\r\ninfo = bq24190_sysfs_field_lookup(attr->attr.name);\r\nif (!info)\r\nreturn -EINVAL;\r\nret = bq24190_read_mask(bdi, info->reg, info->mask, info->shift, &v);\r\nif (ret)\r\nreturn ret;\r\nreturn scnprintf(buf, PAGE_SIZE, "%hhx\n", v);\r\n}\r\nstatic ssize_t bq24190_sysfs_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct power_supply *psy = dev_get_drvdata(dev);\r\nstruct bq24190_dev_info *bdi = power_supply_get_drvdata(psy);\r\nstruct bq24190_sysfs_field_info *info;\r\nint ret;\r\nu8 v;\r\ninfo = bq24190_sysfs_field_lookup(attr->attr.name);\r\nif (!info)\r\nreturn -EINVAL;\r\nret = kstrtou8(buf, 0, &v);\r\nif (ret < 0)\r\nreturn ret;\r\nret = bq24190_write_mask(bdi, info->reg, info->mask, info->shift, v);\r\nif (ret)\r\nreturn ret;\r\nreturn count;\r\n}\r\nstatic int bq24190_sysfs_create_group(struct bq24190_dev_info *bdi)\r\n{\r\nbq24190_sysfs_init_attrs();\r\nreturn sysfs_create_group(&bdi->charger->dev.kobj,\r\n&bq24190_sysfs_attr_group);\r\n}\r\nstatic void bq24190_sysfs_remove_group(struct bq24190_dev_info *bdi)\r\n{\r\nsysfs_remove_group(&bdi->charger->dev.kobj, &bq24190_sysfs_attr_group);\r\n}\r\nstatic int bq24190_sysfs_create_group(struct bq24190_dev_info *bdi)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline void bq24190_sysfs_remove_group(struct bq24190_dev_info *bdi) {}\r\nstatic int bq24190_set_mode_host(struct bq24190_dev_info *bdi)\r\n{\r\nint ret;\r\nu8 v;\r\nret = bq24190_read(bdi, BQ24190_REG_CTTC, &v);\r\nif (ret < 0)\r\nreturn ret;\r\nbdi->watchdog = ((v & BQ24190_REG_CTTC_WATCHDOG_MASK) >>\r\nBQ24190_REG_CTTC_WATCHDOG_SHIFT);\r\nv &= ~BQ24190_REG_CTTC_WATCHDOG_MASK;\r\nreturn bq24190_write(bdi, BQ24190_REG_CTTC, v);\r\n}\r\nstatic int bq24190_register_reset(struct bq24190_dev_info *bdi)\r\n{\r\nint ret, limit = 100;\r\nu8 v;\r\nret = bq24190_write_mask(bdi, BQ24190_REG_POC,\r\nBQ24190_REG_POC_RESET_MASK,\r\nBQ24190_REG_POC_RESET_SHIFT,\r\n0x1);\r\nif (ret < 0)\r\nreturn ret;\r\ndo {\r\nret = bq24190_read_mask(bdi, BQ24190_REG_POC,\r\nBQ24190_REG_POC_RESET_MASK,\r\nBQ24190_REG_POC_RESET_SHIFT,\r\n&v);\r\nif (ret < 0)\r\nreturn ret;\r\nif (!v)\r\nbreak;\r\nudelay(10);\r\n} while (--limit);\r\nif (!limit)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int bq24190_charger_get_charge_type(struct bq24190_dev_info *bdi,\r\nunion power_supply_propval *val)\r\n{\r\nu8 v;\r\nint type, ret;\r\nret = bq24190_read_mask(bdi, BQ24190_REG_POC,\r\nBQ24190_REG_POC_CHG_CONFIG_MASK,\r\nBQ24190_REG_POC_CHG_CONFIG_SHIFT,\r\n&v);\r\nif (ret < 0)\r\nreturn ret;\r\nif (!v) {\r\ntype = POWER_SUPPLY_CHARGE_TYPE_NONE;\r\n} else {\r\nret = bq24190_read_mask(bdi, BQ24190_REG_CCC,\r\nBQ24190_REG_CCC_FORCE_20PCT_MASK,\r\nBQ24190_REG_CCC_FORCE_20PCT_SHIFT,\r\n&v);\r\nif (ret < 0)\r\nreturn ret;\r\ntype = (v) ? POWER_SUPPLY_CHARGE_TYPE_TRICKLE :\r\nPOWER_SUPPLY_CHARGE_TYPE_FAST;\r\n}\r\nval->intval = type;\r\nreturn 0;\r\n}\r\nstatic int bq24190_charger_set_charge_type(struct bq24190_dev_info *bdi,\r\nconst union power_supply_propval *val)\r\n{\r\nu8 chg_config, force_20pct, en_term;\r\nint ret;\r\nswitch (val->intval) {\r\ncase POWER_SUPPLY_CHARGE_TYPE_NONE:\r\nchg_config = 0x0;\r\nbreak;\r\ncase POWER_SUPPLY_CHARGE_TYPE_TRICKLE:\r\nchg_config = 0x1;\r\nforce_20pct = 0x1;\r\nen_term = 0x0;\r\nbreak;\r\ncase POWER_SUPPLY_CHARGE_TYPE_FAST:\r\nchg_config = 0x1;\r\nforce_20pct = 0x0;\r\nen_term = 0x1;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (chg_config) {\r\nret = bq24190_write_mask(bdi, BQ24190_REG_CCC,\r\nBQ24190_REG_CCC_FORCE_20PCT_MASK,\r\nBQ24190_REG_CCC_FORCE_20PCT_SHIFT,\r\nforce_20pct);\r\nif (ret < 0)\r\nreturn ret;\r\nret = bq24190_write_mask(bdi, BQ24190_REG_CTTC,\r\nBQ24190_REG_CTTC_EN_TERM_MASK,\r\nBQ24190_REG_CTTC_EN_TERM_SHIFT,\r\nen_term);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn bq24190_write_mask(bdi, BQ24190_REG_POC,\r\nBQ24190_REG_POC_CHG_CONFIG_MASK,\r\nBQ24190_REG_POC_CHG_CONFIG_SHIFT, chg_config);\r\n}\r\nstatic int bq24190_charger_get_health(struct bq24190_dev_info *bdi,\r\nunion power_supply_propval *val)\r\n{\r\nu8 v;\r\nint health, ret;\r\nmutex_lock(&bdi->f_reg_lock);\r\nif (bdi->charger_health_valid) {\r\nv = bdi->f_reg;\r\nbdi->charger_health_valid = false;\r\nmutex_unlock(&bdi->f_reg_lock);\r\n} else {\r\nmutex_unlock(&bdi->f_reg_lock);\r\nret = bq24190_read(bdi, BQ24190_REG_F, &v);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nif (v & BQ24190_REG_F_BOOST_FAULT_MASK) {\r\nhealth = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\r\n} else {\r\nv &= BQ24190_REG_F_CHRG_FAULT_MASK;\r\nv >>= BQ24190_REG_F_CHRG_FAULT_SHIFT;\r\nswitch (v) {\r\ncase 0x0:\r\nhealth = POWER_SUPPLY_HEALTH_GOOD;\r\nbreak;\r\ncase 0x1:\r\nhealth = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\r\nbreak;\r\ncase 0x2:\r\nhealth = POWER_SUPPLY_HEALTH_OVERHEAT;\r\nbreak;\r\ncase 0x3:\r\nhealth = POWER_SUPPLY_HEALTH_SAFETY_TIMER_EXPIRE;\r\nbreak;\r\ndefault:\r\nhealth = POWER_SUPPLY_HEALTH_UNKNOWN;\r\n}\r\n}\r\nval->intval = health;\r\nreturn 0;\r\n}\r\nstatic int bq24190_charger_get_online(struct bq24190_dev_info *bdi,\r\nunion power_supply_propval *val)\r\n{\r\nu8 v;\r\nint ret;\r\nret = bq24190_read_mask(bdi, BQ24190_REG_SS,\r\nBQ24190_REG_SS_PG_STAT_MASK,\r\nBQ24190_REG_SS_PG_STAT_SHIFT, &v);\r\nif (ret < 0)\r\nreturn ret;\r\nval->intval = v;\r\nreturn 0;\r\n}\r\nstatic int bq24190_charger_get_current(struct bq24190_dev_info *bdi,\r\nunion power_supply_propval *val)\r\n{\r\nu8 v;\r\nint curr, ret;\r\nret = bq24190_get_field_val(bdi, BQ24190_REG_CCC,\r\nBQ24190_REG_CCC_ICHG_MASK, BQ24190_REG_CCC_ICHG_SHIFT,\r\nbq24190_ccc_ichg_values,\r\nARRAY_SIZE(bq24190_ccc_ichg_values), &curr);\r\nif (ret < 0)\r\nreturn ret;\r\nret = bq24190_read_mask(bdi, BQ24190_REG_CCC,\r\nBQ24190_REG_CCC_FORCE_20PCT_MASK,\r\nBQ24190_REG_CCC_FORCE_20PCT_SHIFT, &v);\r\nif (ret < 0)\r\nreturn ret;\r\nif (v)\r\ncurr /= 5;\r\nval->intval = curr;\r\nreturn 0;\r\n}\r\nstatic int bq24190_charger_get_current_max(struct bq24190_dev_info *bdi,\r\nunion power_supply_propval *val)\r\n{\r\nint idx = ARRAY_SIZE(bq24190_ccc_ichg_values) - 1;\r\nval->intval = bq24190_ccc_ichg_values[idx];\r\nreturn 0;\r\n}\r\nstatic int bq24190_charger_set_current(struct bq24190_dev_info *bdi,\r\nconst union power_supply_propval *val)\r\n{\r\nu8 v;\r\nint ret, curr = val->intval;\r\nret = bq24190_read_mask(bdi, BQ24190_REG_CCC,\r\nBQ24190_REG_CCC_FORCE_20PCT_MASK,\r\nBQ24190_REG_CCC_FORCE_20PCT_SHIFT, &v);\r\nif (ret < 0)\r\nreturn ret;\r\nif (v)\r\ncurr *= 5;\r\nreturn bq24190_set_field_val(bdi, BQ24190_REG_CCC,\r\nBQ24190_REG_CCC_ICHG_MASK, BQ24190_REG_CCC_ICHG_SHIFT,\r\nbq24190_ccc_ichg_values,\r\nARRAY_SIZE(bq24190_ccc_ichg_values), curr);\r\n}\r\nstatic int bq24190_charger_get_voltage(struct bq24190_dev_info *bdi,\r\nunion power_supply_propval *val)\r\n{\r\nint voltage, ret;\r\nret = bq24190_get_field_val(bdi, BQ24190_REG_CVC,\r\nBQ24190_REG_CVC_VREG_MASK, BQ24190_REG_CVC_VREG_SHIFT,\r\nbq24190_cvc_vreg_values,\r\nARRAY_SIZE(bq24190_cvc_vreg_values), &voltage);\r\nif (ret < 0)\r\nreturn ret;\r\nval->intval = voltage;\r\nreturn 0;\r\n}\r\nstatic int bq24190_charger_get_voltage_max(struct bq24190_dev_info *bdi,\r\nunion power_supply_propval *val)\r\n{\r\nint idx = ARRAY_SIZE(bq24190_cvc_vreg_values) - 1;\r\nval->intval = bq24190_cvc_vreg_values[idx];\r\nreturn 0;\r\n}\r\nstatic int bq24190_charger_set_voltage(struct bq24190_dev_info *bdi,\r\nconst union power_supply_propval *val)\r\n{\r\nreturn bq24190_set_field_val(bdi, BQ24190_REG_CVC,\r\nBQ24190_REG_CVC_VREG_MASK, BQ24190_REG_CVC_VREG_SHIFT,\r\nbq24190_cvc_vreg_values,\r\nARRAY_SIZE(bq24190_cvc_vreg_values), val->intval);\r\n}\r\nstatic int bq24190_charger_get_property(struct power_supply *psy,\r\nenum power_supply_property psp, union power_supply_propval *val)\r\n{\r\nstruct bq24190_dev_info *bdi = power_supply_get_drvdata(psy);\r\nint ret;\r\ndev_dbg(bdi->dev, "prop: %d\n", psp);\r\npm_runtime_get_sync(bdi->dev);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_CHARGE_TYPE:\r\nret = bq24190_charger_get_charge_type(bdi, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nret = bq24190_charger_get_health(bdi, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nret = bq24190_charger_get_online(bdi, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT:\r\nret = bq24190_charger_get_current(bdi, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX:\r\nret = bq24190_charger_get_current_max(bdi, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE:\r\nret = bq24190_charger_get_voltage(bdi, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE_MAX:\r\nret = bq24190_charger_get_voltage_max(bdi, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_SCOPE:\r\nval->intval = POWER_SUPPLY_SCOPE_SYSTEM;\r\nret = 0;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MODEL_NAME:\r\nval->strval = bdi->model_name;\r\nret = 0;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MANUFACTURER:\r\nval->strval = BQ24190_MANUFACTURER;\r\nret = 0;\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\n}\r\npm_runtime_put_sync(bdi->dev);\r\nreturn ret;\r\n}\r\nstatic int bq24190_charger_set_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nconst union power_supply_propval *val)\r\n{\r\nstruct bq24190_dev_info *bdi = power_supply_get_drvdata(psy);\r\nint ret;\r\ndev_dbg(bdi->dev, "prop: %d\n", psp);\r\npm_runtime_get_sync(bdi->dev);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_CHARGE_TYPE:\r\nret = bq24190_charger_set_charge_type(bdi, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT:\r\nret = bq24190_charger_set_current(bdi, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE:\r\nret = bq24190_charger_set_voltage(bdi, val);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\npm_runtime_put_sync(bdi->dev);\r\nreturn ret;\r\n}\r\nstatic int bq24190_charger_property_is_writeable(struct power_supply *psy,\r\nenum power_supply_property psp)\r\n{\r\nint ret;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_CHARGE_TYPE:\r\ncase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT:\r\ncase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE:\r\nret = 1;\r\nbreak;\r\ndefault:\r\nret = 0;\r\n}\r\nreturn ret;\r\n}\r\nstatic int bq24190_battery_get_status(struct bq24190_dev_info *bdi,\r\nunion power_supply_propval *val)\r\n{\r\nu8 ss_reg, chrg_fault;\r\nint status, ret;\r\nmutex_lock(&bdi->f_reg_lock);\r\nif (bdi->battery_status_valid) {\r\nchrg_fault = bdi->f_reg;\r\nbdi->battery_status_valid = false;\r\nmutex_unlock(&bdi->f_reg_lock);\r\n} else {\r\nmutex_unlock(&bdi->f_reg_lock);\r\nret = bq24190_read(bdi, BQ24190_REG_F, &chrg_fault);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nchrg_fault &= BQ24190_REG_F_CHRG_FAULT_MASK;\r\nchrg_fault >>= BQ24190_REG_F_CHRG_FAULT_SHIFT;\r\nret = bq24190_read(bdi, BQ24190_REG_SS, &ss_reg);\r\nif (ret < 0)\r\nreturn ret;\r\nif (!(ss_reg & BQ24190_REG_SS_PG_STAT_MASK) || chrg_fault) {\r\nstatus = POWER_SUPPLY_STATUS_DISCHARGING;\r\n} else {\r\nss_reg &= BQ24190_REG_SS_CHRG_STAT_MASK;\r\nss_reg >>= BQ24190_REG_SS_CHRG_STAT_SHIFT;\r\nswitch (ss_reg) {\r\ncase 0x0:\r\nstatus = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\nbreak;\r\ncase 0x1:\r\ncase 0x2:\r\nstatus = POWER_SUPPLY_STATUS_CHARGING;\r\nbreak;\r\ncase 0x3:\r\nstatus = POWER_SUPPLY_STATUS_FULL;\r\nbreak;\r\ndefault:\r\nret = -EIO;\r\n}\r\n}\r\nif (!ret)\r\nval->intval = status;\r\nreturn ret;\r\n}\r\nstatic int bq24190_battery_get_health(struct bq24190_dev_info *bdi,\r\nunion power_supply_propval *val)\r\n{\r\nu8 v;\r\nint health, ret;\r\nmutex_lock(&bdi->f_reg_lock);\r\nif (bdi->battery_health_valid) {\r\nv = bdi->f_reg;\r\nbdi->battery_health_valid = false;\r\nmutex_unlock(&bdi->f_reg_lock);\r\n} else {\r\nmutex_unlock(&bdi->f_reg_lock);\r\nret = bq24190_read(bdi, BQ24190_REG_F, &v);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nif (v & BQ24190_REG_F_BAT_FAULT_MASK) {\r\nhealth = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\r\n} else {\r\nv &= BQ24190_REG_F_NTC_FAULT_MASK;\r\nv >>= BQ24190_REG_F_NTC_FAULT_SHIFT;\r\nswitch (v) {\r\ncase 0x0:\r\nhealth = POWER_SUPPLY_HEALTH_GOOD;\r\nbreak;\r\ncase 0x1:\r\ncase 0x3:\r\ncase 0x5:\r\nhealth = POWER_SUPPLY_HEALTH_COLD;\r\nbreak;\r\ncase 0x2:\r\ncase 0x4:\r\ncase 0x6:\r\nhealth = POWER_SUPPLY_HEALTH_OVERHEAT;\r\nbreak;\r\ndefault:\r\nhealth = POWER_SUPPLY_HEALTH_UNKNOWN;\r\n}\r\n}\r\nval->intval = health;\r\nreturn 0;\r\n}\r\nstatic int bq24190_battery_get_online(struct bq24190_dev_info *bdi,\r\nunion power_supply_propval *val)\r\n{\r\nu8 batfet_disable;\r\nint ret;\r\nret = bq24190_read_mask(bdi, BQ24190_REG_MOC,\r\nBQ24190_REG_MOC_BATFET_DISABLE_MASK,\r\nBQ24190_REG_MOC_BATFET_DISABLE_SHIFT, &batfet_disable);\r\nif (ret < 0)\r\nreturn ret;\r\nval->intval = !batfet_disable;\r\nreturn 0;\r\n}\r\nstatic int bq24190_battery_set_online(struct bq24190_dev_info *bdi,\r\nconst union power_supply_propval *val)\r\n{\r\nreturn bq24190_write_mask(bdi, BQ24190_REG_MOC,\r\nBQ24190_REG_MOC_BATFET_DISABLE_MASK,\r\nBQ24190_REG_MOC_BATFET_DISABLE_SHIFT, !val->intval);\r\n}\r\nstatic int bq24190_battery_get_temp_alert_max(struct bq24190_dev_info *bdi,\r\nunion power_supply_propval *val)\r\n{\r\nint temp, ret;\r\nret = bq24190_get_field_val(bdi, BQ24190_REG_ICTRC,\r\nBQ24190_REG_ICTRC_TREG_MASK,\r\nBQ24190_REG_ICTRC_TREG_SHIFT,\r\nbq24190_ictrc_treg_values,\r\nARRAY_SIZE(bq24190_ictrc_treg_values), &temp);\r\nif (ret < 0)\r\nreturn ret;\r\nval->intval = temp;\r\nreturn 0;\r\n}\r\nstatic int bq24190_battery_set_temp_alert_max(struct bq24190_dev_info *bdi,\r\nconst union power_supply_propval *val)\r\n{\r\nreturn bq24190_set_field_val(bdi, BQ24190_REG_ICTRC,\r\nBQ24190_REG_ICTRC_TREG_MASK,\r\nBQ24190_REG_ICTRC_TREG_SHIFT,\r\nbq24190_ictrc_treg_values,\r\nARRAY_SIZE(bq24190_ictrc_treg_values), val->intval);\r\n}\r\nstatic int bq24190_battery_get_property(struct power_supply *psy,\r\nenum power_supply_property psp, union power_supply_propval *val)\r\n{\r\nstruct bq24190_dev_info *bdi = power_supply_get_drvdata(psy);\r\nint ret;\r\ndev_dbg(bdi->dev, "prop: %d\n", psp);\r\npm_runtime_get_sync(bdi->dev);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nret = bq24190_battery_get_status(bdi, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nret = bq24190_battery_get_health(bdi, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nret = bq24190_battery_get_online(bdi, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_UNKNOWN;\r\nret = 0;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP_ALERT_MAX:\r\nret = bq24190_battery_get_temp_alert_max(bdi, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_SCOPE:\r\nval->intval = POWER_SUPPLY_SCOPE_SYSTEM;\r\nret = 0;\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\n}\r\npm_runtime_put_sync(bdi->dev);\r\nreturn ret;\r\n}\r\nstatic int bq24190_battery_set_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nconst union power_supply_propval *val)\r\n{\r\nstruct bq24190_dev_info *bdi = power_supply_get_drvdata(psy);\r\nint ret;\r\ndev_dbg(bdi->dev, "prop: %d\n", psp);\r\npm_runtime_put_sync(bdi->dev);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nret = bq24190_battery_set_online(bdi, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP_ALERT_MAX:\r\nret = bq24190_battery_set_temp_alert_max(bdi, val);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\npm_runtime_put_sync(bdi->dev);\r\nreturn ret;\r\n}\r\nstatic int bq24190_battery_property_is_writeable(struct power_supply *psy,\r\nenum power_supply_property psp)\r\n{\r\nint ret;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\ncase POWER_SUPPLY_PROP_TEMP_ALERT_MAX:\r\nret = 1;\r\nbreak;\r\ndefault:\r\nret = 0;\r\n}\r\nreturn ret;\r\n}\r\nstatic irqreturn_t bq24190_irq_handler_thread(int irq, void *data)\r\n{\r\nstruct bq24190_dev_info *bdi = data;\r\nbool alert_userspace = false;\r\nu8 ss_reg = 0, f_reg = 0;\r\nint ret;\r\npm_runtime_get_sync(bdi->dev);\r\nret = bq24190_read(bdi, BQ24190_REG_SS, &ss_reg);\r\nif (ret < 0) {\r\ndev_err(bdi->dev, "Can't read SS reg: %d\n", ret);\r\ngoto out;\r\n}\r\nif (ss_reg != bdi->ss_reg) {\r\nif ((bdi->ss_reg & BQ24190_REG_SS_PG_STAT_MASK) &&\r\n!(ss_reg & BQ24190_REG_SS_PG_STAT_MASK)) {\r\nret = bq24190_write_mask(bdi, BQ24190_REG_ISC,\r\nBQ24190_REG_ISC_EN_HIZ_MASK,\r\nBQ24190_REG_ISC_EN_HIZ_SHIFT,\r\n0);\r\nif (ret < 0)\r\ndev_err(bdi->dev, "Can't access ISC reg: %d\n",\r\nret);\r\n}\r\nbdi->ss_reg = ss_reg;\r\nalert_userspace = true;\r\n}\r\nmutex_lock(&bdi->f_reg_lock);\r\nret = bq24190_read(bdi, BQ24190_REG_F, &f_reg);\r\nif (ret < 0) {\r\nmutex_unlock(&bdi->f_reg_lock);\r\ndev_err(bdi->dev, "Can't read F reg: %d\n", ret);\r\ngoto out;\r\n}\r\nif (f_reg != bdi->f_reg) {\r\nbdi->f_reg = f_reg;\r\nbdi->charger_health_valid = true;\r\nbdi->battery_health_valid = true;\r\nbdi->battery_status_valid = true;\r\nalert_userspace = true;\r\n}\r\nmutex_unlock(&bdi->f_reg_lock);\r\nif (alert_userspace) {\r\nif (!bdi->first_time) {\r\npower_supply_changed(bdi->charger);\r\npower_supply_changed(bdi->battery);\r\n} else {\r\nbdi->first_time = false;\r\n}\r\n}\r\nout:\r\npm_runtime_put_sync(bdi->dev);\r\ndev_dbg(bdi->dev, "ss_reg: 0x%02x, f_reg: 0x%02x\n", ss_reg, f_reg);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int bq24190_hw_init(struct bq24190_dev_info *bdi)\r\n{\r\nu8 v;\r\nint ret;\r\npm_runtime_get_sync(bdi->dev);\r\nret = bq24190_read_mask(bdi, BQ24190_REG_VPRS,\r\nBQ24190_REG_VPRS_PN_MASK,\r\nBQ24190_REG_VPRS_PN_SHIFT,\r\n&v);\r\nif (ret < 0)\r\ngoto out;\r\nif (v != bdi->model) {\r\nret = -ENODEV;\r\ngoto out;\r\n}\r\nret = bq24190_register_reset(bdi);\r\nif (ret < 0)\r\ngoto out;\r\nret = bq24190_set_mode_host(bdi);\r\nout:\r\npm_runtime_put_sync(bdi->dev);\r\nreturn ret;\r\n}\r\nstatic int bq24190_setup_dt(struct bq24190_dev_info *bdi)\r\n{\r\nbdi->irq = irq_of_parse_and_map(bdi->dev->of_node, 0);\r\nif (bdi->irq <= 0)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int bq24190_setup_dt(struct bq24190_dev_info *bdi)\r\n{\r\nreturn -1;\r\n}\r\nstatic int bq24190_setup_pdata(struct bq24190_dev_info *bdi,\r\nstruct bq24190_platform_data *pdata)\r\n{\r\nint ret;\r\nif (!gpio_is_valid(pdata->gpio_int))\r\nreturn -1;\r\nret = gpio_request(pdata->gpio_int, dev_name(bdi->dev));\r\nif (ret < 0)\r\nreturn -1;\r\nret = gpio_direction_input(pdata->gpio_int);\r\nif (ret < 0)\r\ngoto out;\r\nbdi->irq = gpio_to_irq(pdata->gpio_int);\r\nif (!bdi->irq)\r\ngoto out;\r\nbdi->gpio_int = pdata->gpio_int;\r\nreturn 0;\r\nout:\r\ngpio_free(pdata->gpio_int);\r\nreturn -1;\r\n}\r\nstatic int bq24190_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct i2c_adapter *adapter = to_i2c_adapter(client->dev.parent);\r\nstruct device *dev = &client->dev;\r\nstruct bq24190_platform_data *pdata = client->dev.platform_data;\r\nstruct power_supply_config charger_cfg = {}, battery_cfg = {};\r\nstruct bq24190_dev_info *bdi;\r\nint ret;\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE_DATA)) {\r\ndev_err(dev, "No support for SMBUS_BYTE_DATA\n");\r\nreturn -ENODEV;\r\n}\r\nbdi = devm_kzalloc(dev, sizeof(*bdi), GFP_KERNEL);\r\nif (!bdi) {\r\ndev_err(dev, "Can't alloc bdi struct\n");\r\nreturn -ENOMEM;\r\n}\r\nbdi->client = client;\r\nbdi->dev = dev;\r\nbdi->model = id->driver_data;\r\nstrncpy(bdi->model_name, id->name, I2C_NAME_SIZE);\r\nmutex_init(&bdi->f_reg_lock);\r\nbdi->first_time = true;\r\nbdi->charger_health_valid = false;\r\nbdi->battery_health_valid = false;\r\nbdi->battery_status_valid = false;\r\ni2c_set_clientdata(client, bdi);\r\nif (dev->of_node)\r\nret = bq24190_setup_dt(bdi);\r\nelse\r\nret = bq24190_setup_pdata(bdi, pdata);\r\nif (ret) {\r\ndev_err(dev, "Can't get irq info\n");\r\nreturn -EINVAL;\r\n}\r\nret = devm_request_threaded_irq(dev, bdi->irq, NULL,\r\nbq24190_irq_handler_thread,\r\nIRQF_TRIGGER_RISING | IRQF_ONESHOT,\r\n"bq24190-charger", bdi);\r\nif (ret < 0) {\r\ndev_err(dev, "Can't set up irq handler\n");\r\ngoto out1;\r\n}\r\npm_runtime_enable(dev);\r\npm_runtime_resume(dev);\r\nret = bq24190_hw_init(bdi);\r\nif (ret < 0) {\r\ndev_err(dev, "Hardware init failed\n");\r\ngoto out2;\r\n}\r\ncharger_cfg.drv_data = bdi;\r\ncharger_cfg.supplied_to = bq24190_charger_supplied_to;\r\ncharger_cfg.num_supplicants = ARRAY_SIZE(bq24190_charger_supplied_to),\r\nbdi->charger = power_supply_register(dev, &bq24190_charger_desc,\r\n&charger_cfg);\r\nif (IS_ERR(bdi->charger)) {\r\ndev_err(dev, "Can't register charger\n");\r\nret = PTR_ERR(bdi->charger);\r\ngoto out2;\r\n}\r\nbattery_cfg.drv_data = bdi;\r\nbdi->battery = power_supply_register(dev, &bq24190_battery_desc,\r\n&battery_cfg);\r\nif (IS_ERR(bdi->battery)) {\r\ndev_err(dev, "Can't register battery\n");\r\nret = PTR_ERR(bdi->battery);\r\ngoto out3;\r\n}\r\nret = bq24190_sysfs_create_group(bdi);\r\nif (ret) {\r\ndev_err(dev, "Can't create sysfs entries\n");\r\ngoto out4;\r\n}\r\nreturn 0;\r\nout4:\r\npower_supply_unregister(bdi->battery);\r\nout3:\r\npower_supply_unregister(bdi->charger);\r\nout2:\r\npm_runtime_disable(dev);\r\nout1:\r\nif (bdi->gpio_int)\r\ngpio_free(bdi->gpio_int);\r\nreturn ret;\r\n}\r\nstatic int bq24190_remove(struct i2c_client *client)\r\n{\r\nstruct bq24190_dev_info *bdi = i2c_get_clientdata(client);\r\npm_runtime_get_sync(bdi->dev);\r\nbq24190_register_reset(bdi);\r\npm_runtime_put_sync(bdi->dev);\r\nbq24190_sysfs_remove_group(bdi);\r\npower_supply_unregister(bdi->battery);\r\npower_supply_unregister(bdi->charger);\r\npm_runtime_disable(bdi->dev);\r\nif (bdi->gpio_int)\r\ngpio_free(bdi->gpio_int);\r\nreturn 0;\r\n}\r\nstatic int bq24190_pm_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct bq24190_dev_info *bdi = i2c_get_clientdata(client);\r\npm_runtime_get_sync(bdi->dev);\r\nbq24190_register_reset(bdi);\r\npm_runtime_put_sync(bdi->dev);\r\nreturn 0;\r\n}\r\nstatic int bq24190_pm_resume(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct bq24190_dev_info *bdi = i2c_get_clientdata(client);\r\nbdi->charger_health_valid = false;\r\nbdi->battery_health_valid = false;\r\nbdi->battery_status_valid = false;\r\npm_runtime_get_sync(bdi->dev);\r\nbq24190_register_reset(bdi);\r\npm_runtime_put_sync(bdi->dev);\r\npower_supply_changed(bdi->charger);\r\npower_supply_changed(bdi->battery);\r\nreturn 0;\r\n}

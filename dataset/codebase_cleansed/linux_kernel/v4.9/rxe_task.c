int __rxe_do_task(struct rxe_task *task)\r\n{\r\nint ret;\r\nwhile ((ret = task->func(task->arg)) == 0)\r\n;\r\ntask->ret = ret;\r\nreturn ret;\r\n}\r\nvoid rxe_do_task(unsigned long data)\r\n{\r\nint cont;\r\nint ret;\r\nunsigned long flags;\r\nstruct rxe_task *task = (struct rxe_task *)data;\r\nspin_lock_irqsave(&task->state_lock, flags);\r\nswitch (task->state) {\r\ncase TASK_STATE_START:\r\ntask->state = TASK_STATE_BUSY;\r\nspin_unlock_irqrestore(&task->state_lock, flags);\r\nbreak;\r\ncase TASK_STATE_BUSY:\r\ntask->state = TASK_STATE_ARMED;\r\ncase TASK_STATE_ARMED:\r\nspin_unlock_irqrestore(&task->state_lock, flags);\r\nreturn;\r\ndefault:\r\nspin_unlock_irqrestore(&task->state_lock, flags);\r\npr_warn("bad state = %d in rxe_do_task\n", task->state);\r\nreturn;\r\n}\r\ndo {\r\ncont = 0;\r\nret = task->func(task->arg);\r\nspin_lock_irqsave(&task->state_lock, flags);\r\nswitch (task->state) {\r\ncase TASK_STATE_BUSY:\r\nif (ret)\r\ntask->state = TASK_STATE_START;\r\nelse\r\ncont = 1;\r\nbreak;\r\ncase TASK_STATE_ARMED:\r\ntask->state = TASK_STATE_BUSY;\r\ncont = 1;\r\nbreak;\r\ndefault:\r\npr_warn("bad state = %d in rxe_do_task\n",\r\ntask->state);\r\n}\r\nspin_unlock_irqrestore(&task->state_lock, flags);\r\n} while (cont);\r\ntask->ret = ret;\r\n}\r\nint rxe_init_task(void *obj, struct rxe_task *task,\r\nvoid *arg, int (*func)(void *), char *name)\r\n{\r\ntask->obj = obj;\r\ntask->arg = arg;\r\ntask->func = func;\r\nsnprintf(task->name, sizeof(task->name), "%s", name);\r\ntasklet_init(&task->tasklet, rxe_do_task, (unsigned long)task);\r\ntask->state = TASK_STATE_START;\r\nspin_lock_init(&task->state_lock);\r\nreturn 0;\r\n}\r\nvoid rxe_cleanup_task(struct rxe_task *task)\r\n{\r\ntasklet_kill(&task->tasklet);\r\n}\r\nvoid rxe_run_task(struct rxe_task *task, int sched)\r\n{\r\nif (sched)\r\ntasklet_schedule(&task->tasklet);\r\nelse\r\nrxe_do_task((unsigned long)task);\r\n}\r\nvoid rxe_disable_task(struct rxe_task *task)\r\n{\r\ntasklet_disable(&task->tasklet);\r\n}\r\nvoid rxe_enable_task(struct rxe_task *task)\r\n{\r\ntasklet_enable(&task->tasklet);\r\n}

static int virtio_gpu_dirty_update(struct virtio_gpu_framebuffer *fb,\r\nbool store, int x, int y,\r\nint width, int height)\r\n{\r\nstruct drm_device *dev = fb->base.dev;\r\nstruct virtio_gpu_device *vgdev = dev->dev_private;\r\nbool store_for_later = false;\r\nint bpp = fb->base.bits_per_pixel / 8;\r\nint x2, y2;\r\nunsigned long flags;\r\nstruct virtio_gpu_object *obj = gem_to_virtio_gpu_obj(fb->obj);\r\nif ((width <= 0) ||\r\n(x + width > fb->base.width) ||\r\n(y + height > fb->base.height)) {\r\nDRM_DEBUG("values out of range %dx%d+%d+%d, fb %dx%d\n",\r\nwidth, height, x, y,\r\nfb->base.width, fb->base.height);\r\nreturn -EINVAL;\r\n}\r\nif (in_atomic() || store)\r\nstore_for_later = true;\r\nx2 = x + width - 1;\r\ny2 = y + height - 1;\r\nspin_lock_irqsave(&fb->dirty_lock, flags);\r\nif (fb->y1 < y)\r\ny = fb->y1;\r\nif (fb->y2 > y2)\r\ny2 = fb->y2;\r\nif (fb->x1 < x)\r\nx = fb->x1;\r\nif (fb->x2 > x2)\r\nx2 = fb->x2;\r\nif (store_for_later) {\r\nfb->x1 = x;\r\nfb->x2 = x2;\r\nfb->y1 = y;\r\nfb->y2 = y2;\r\nspin_unlock_irqrestore(&fb->dirty_lock, flags);\r\nreturn 0;\r\n}\r\nfb->x1 = fb->y1 = INT_MAX;\r\nfb->x2 = fb->y2 = 0;\r\nspin_unlock_irqrestore(&fb->dirty_lock, flags);\r\n{\r\nuint32_t offset;\r\nuint32_t w = x2 - x + 1;\r\nuint32_t h = y2 - y + 1;\r\noffset = (y * fb->base.pitches[0]) + x * bpp;\r\nvirtio_gpu_cmd_transfer_to_host_2d(vgdev, obj->hw_res_handle,\r\noffset,\r\ncpu_to_le32(w),\r\ncpu_to_le32(h),\r\ncpu_to_le32(x),\r\ncpu_to_le32(y),\r\nNULL);\r\n}\r\nvirtio_gpu_cmd_resource_flush(vgdev, obj->hw_res_handle,\r\nx, y, x2 - x + 1, y2 - y + 1);\r\nreturn 0;\r\n}\r\nint virtio_gpu_surface_dirty(struct virtio_gpu_framebuffer *vgfb,\r\nstruct drm_clip_rect *clips,\r\nunsigned num_clips)\r\n{\r\nstruct virtio_gpu_device *vgdev = vgfb->base.dev->dev_private;\r\nstruct virtio_gpu_object *obj = gem_to_virtio_gpu_obj(vgfb->obj);\r\nstruct drm_clip_rect norect;\r\nstruct drm_clip_rect *clips_ptr;\r\nint left, right, top, bottom;\r\nint i;\r\nint inc = 1;\r\nif (!num_clips) {\r\nnum_clips = 1;\r\nclips = &norect;\r\nnorect.x1 = norect.y1 = 0;\r\nnorect.x2 = vgfb->base.width;\r\nnorect.y2 = vgfb->base.height;\r\n}\r\nleft = clips->x1;\r\nright = clips->x2;\r\ntop = clips->y1;\r\nbottom = clips->y2;\r\nfor (i = 1, clips_ptr = clips + inc;\r\ni < num_clips; i++, clips_ptr += inc) {\r\nleft = min_t(int, left, (int)clips_ptr->x1);\r\nright = max_t(int, right, (int)clips_ptr->x2);\r\ntop = min_t(int, top, (int)clips_ptr->y1);\r\nbottom = max_t(int, bottom, (int)clips_ptr->y2);\r\n}\r\nif (obj->dumb)\r\nreturn virtio_gpu_dirty_update(vgfb, false, left, top,\r\nright - left, bottom - top);\r\nvirtio_gpu_cmd_resource_flush(vgdev, obj->hw_res_handle,\r\nleft, top, right - left, bottom - top);\r\nreturn 0;\r\n}\r\nstatic void virtio_gpu_fb_dirty_work(struct work_struct *work)\r\n{\r\nstruct delayed_work *delayed_work = to_delayed_work(work);\r\nstruct virtio_gpu_fbdev *vfbdev =\r\ncontainer_of(delayed_work, struct virtio_gpu_fbdev, work);\r\nstruct virtio_gpu_framebuffer *vgfb = &vfbdev->vgfb;\r\nvirtio_gpu_dirty_update(&vfbdev->vgfb, false, vgfb->x1, vgfb->y1,\r\nvgfb->x2 - vgfb->x1, vgfb->y2 - vgfb->y1);\r\n}\r\nstatic void virtio_gpu_3d_fillrect(struct fb_info *info,\r\nconst struct fb_fillrect *rect)\r\n{\r\nstruct virtio_gpu_fbdev *vfbdev = info->par;\r\ndrm_fb_helper_sys_fillrect(info, rect);\r\nvirtio_gpu_dirty_update(&vfbdev->vgfb, true, rect->dx, rect->dy,\r\nrect->width, rect->height);\r\nschedule_delayed_work(&vfbdev->work, VIRTIO_GPU_FBCON_POLL_PERIOD);\r\n}\r\nstatic void virtio_gpu_3d_copyarea(struct fb_info *info,\r\nconst struct fb_copyarea *area)\r\n{\r\nstruct virtio_gpu_fbdev *vfbdev = info->par;\r\ndrm_fb_helper_sys_copyarea(info, area);\r\nvirtio_gpu_dirty_update(&vfbdev->vgfb, true, area->dx, area->dy,\r\narea->width, area->height);\r\nschedule_delayed_work(&vfbdev->work, VIRTIO_GPU_FBCON_POLL_PERIOD);\r\n}\r\nstatic void virtio_gpu_3d_imageblit(struct fb_info *info,\r\nconst struct fb_image *image)\r\n{\r\nstruct virtio_gpu_fbdev *vfbdev = info->par;\r\ndrm_fb_helper_sys_imageblit(info, image);\r\nvirtio_gpu_dirty_update(&vfbdev->vgfb, true, image->dx, image->dy,\r\nimage->width, image->height);\r\nschedule_delayed_work(&vfbdev->work, VIRTIO_GPU_FBCON_POLL_PERIOD);\r\n}\r\nstatic int virtio_gpu_vmap_fb(struct virtio_gpu_device *vgdev,\r\nstruct virtio_gpu_object *obj)\r\n{\r\nreturn virtio_gpu_object_kmap(obj, NULL);\r\n}\r\nstatic int virtio_gpufb_create(struct drm_fb_helper *helper,\r\nstruct drm_fb_helper_surface_size *sizes)\r\n{\r\nstruct virtio_gpu_fbdev *vfbdev =\r\ncontainer_of(helper, struct virtio_gpu_fbdev, helper);\r\nstruct drm_device *dev = helper->dev;\r\nstruct virtio_gpu_device *vgdev = dev->dev_private;\r\nstruct fb_info *info;\r\nstruct drm_framebuffer *fb;\r\nstruct drm_mode_fb_cmd2 mode_cmd = {};\r\nstruct virtio_gpu_object *obj;\r\nuint32_t resid, format, size;\r\nint ret;\r\nmode_cmd.width = sizes->surface_width;\r\nmode_cmd.height = sizes->surface_height;\r\nmode_cmd.pitches[0] = mode_cmd.width * 4;\r\nmode_cmd.pixel_format = drm_mode_legacy_fb_format(32, 24);\r\nswitch (mode_cmd.pixel_format) {\r\n#ifdef __BIG_ENDIAN\r\ncase DRM_FORMAT_XRGB8888:\r\nformat = VIRTIO_GPU_FORMAT_X8R8G8B8_UNORM;\r\nbreak;\r\ncase DRM_FORMAT_ARGB8888:\r\nformat = VIRTIO_GPU_FORMAT_A8R8G8B8_UNORM;\r\nbreak;\r\ncase DRM_FORMAT_BGRX8888:\r\nformat = VIRTIO_GPU_FORMAT_B8G8R8X8_UNORM;\r\nbreak;\r\ncase DRM_FORMAT_BGRA8888:\r\nformat = VIRTIO_GPU_FORMAT_B8G8R8A8_UNORM;\r\nbreak;\r\ncase DRM_FORMAT_RGBX8888:\r\nformat = VIRTIO_GPU_FORMAT_R8G8B8X8_UNORM;\r\nbreak;\r\ncase DRM_FORMAT_RGBA8888:\r\nformat = VIRTIO_GPU_FORMAT_R8G8B8A8_UNORM;\r\nbreak;\r\ncase DRM_FORMAT_XBGR8888:\r\nformat = VIRTIO_GPU_FORMAT_X8B8G8R8_UNORM;\r\nbreak;\r\ncase DRM_FORMAT_ABGR8888:\r\nformat = VIRTIO_GPU_FORMAT_A8B8G8R8_UNORM;\r\nbreak;\r\n#else\r\ncase DRM_FORMAT_XRGB8888:\r\nformat = VIRTIO_GPU_FORMAT_B8G8R8X8_UNORM;\r\nbreak;\r\ncase DRM_FORMAT_ARGB8888:\r\nformat = VIRTIO_GPU_FORMAT_B8G8R8A8_UNORM;\r\nbreak;\r\ncase DRM_FORMAT_BGRX8888:\r\nformat = VIRTIO_GPU_FORMAT_X8R8G8B8_UNORM;\r\nbreak;\r\ncase DRM_FORMAT_BGRA8888:\r\nformat = VIRTIO_GPU_FORMAT_A8R8G8B8_UNORM;\r\nbreak;\r\ncase DRM_FORMAT_RGBX8888:\r\nformat = VIRTIO_GPU_FORMAT_X8B8G8R8_UNORM;\r\nbreak;\r\ncase DRM_FORMAT_RGBA8888:\r\nformat = VIRTIO_GPU_FORMAT_A8B8G8R8_UNORM;\r\nbreak;\r\ncase DRM_FORMAT_XBGR8888:\r\nformat = VIRTIO_GPU_FORMAT_R8G8B8X8_UNORM;\r\nbreak;\r\ncase DRM_FORMAT_ABGR8888:\r\nformat = VIRTIO_GPU_FORMAT_R8G8B8A8_UNORM;\r\nbreak;\r\n#endif\r\ndefault:\r\nDRM_ERROR("failed to find virtio gpu format for %d\n",\r\nmode_cmd.pixel_format);\r\nreturn -EINVAL;\r\n}\r\nsize = mode_cmd.pitches[0] * mode_cmd.height;\r\nobj = virtio_gpu_alloc_object(dev, size, false, true);\r\nif (IS_ERR(obj))\r\nreturn PTR_ERR(obj);\r\nvirtio_gpu_resource_id_get(vgdev, &resid);\r\nvirtio_gpu_cmd_create_resource(vgdev, resid, format,\r\nmode_cmd.width, mode_cmd.height);\r\nret = virtio_gpu_vmap_fb(vgdev, obj);\r\nif (ret) {\r\nDRM_ERROR("failed to vmap fb %d\n", ret);\r\ngoto err_obj_vmap;\r\n}\r\nret = virtio_gpu_object_attach(vgdev, obj, resid, NULL);\r\nif (ret)\r\ngoto err_obj_attach;\r\ninfo = drm_fb_helper_alloc_fbi(helper);\r\nif (IS_ERR(info)) {\r\nret = PTR_ERR(info);\r\ngoto err_fb_alloc;\r\n}\r\ninfo->par = helper;\r\nret = virtio_gpu_framebuffer_init(dev, &vfbdev->vgfb,\r\n&mode_cmd, &obj->gem_base);\r\nif (ret)\r\ngoto err_fb_init;\r\nfb = &vfbdev->vgfb.base;\r\nvfbdev->helper.fb = fb;\r\nstrcpy(info->fix.id, "virtiodrmfb");\r\ninfo->flags = FBINFO_DEFAULT;\r\ninfo->fbops = &virtio_gpufb_ops;\r\ninfo->pixmap.flags = FB_PIXMAP_SYSTEM;\r\ninfo->screen_base = obj->vmap;\r\ninfo->screen_size = obj->gem_base.size;\r\ndrm_fb_helper_fill_fix(info, fb->pitches[0], fb->depth);\r\ndrm_fb_helper_fill_var(info, &vfbdev->helper,\r\nsizes->fb_width, sizes->fb_height);\r\ninfo->fix.mmio_start = 0;\r\ninfo->fix.mmio_len = 0;\r\nreturn 0;\r\nerr_fb_init:\r\ndrm_fb_helper_release_fbi(helper);\r\nerr_fb_alloc:\r\nvirtio_gpu_cmd_resource_inval_backing(vgdev, resid);\r\nerr_obj_attach:\r\nerr_obj_vmap:\r\nvirtio_gpu_gem_free_object(&obj->gem_base);\r\nreturn ret;\r\n}\r\nstatic int virtio_gpu_fbdev_destroy(struct drm_device *dev,\r\nstruct virtio_gpu_fbdev *vgfbdev)\r\n{\r\nstruct virtio_gpu_framebuffer *vgfb = &vgfbdev->vgfb;\r\ndrm_fb_helper_unregister_fbi(&vgfbdev->helper);\r\ndrm_fb_helper_release_fbi(&vgfbdev->helper);\r\nif (vgfb->obj)\r\nvgfb->obj = NULL;\r\ndrm_fb_helper_fini(&vgfbdev->helper);\r\ndrm_framebuffer_cleanup(&vgfb->base);\r\nreturn 0;\r\n}\r\nint virtio_gpu_fbdev_init(struct virtio_gpu_device *vgdev)\r\n{\r\nstruct virtio_gpu_fbdev *vgfbdev;\r\nint bpp_sel = 32;\r\nint ret;\r\nvgfbdev = kzalloc(sizeof(struct virtio_gpu_fbdev), GFP_KERNEL);\r\nif (!vgfbdev)\r\nreturn -ENOMEM;\r\nvgfbdev->vgdev = vgdev;\r\nvgdev->vgfbdev = vgfbdev;\r\nINIT_DELAYED_WORK(&vgfbdev->work, virtio_gpu_fb_dirty_work);\r\ndrm_fb_helper_prepare(vgdev->ddev, &vgfbdev->helper,\r\n&virtio_gpu_fb_helper_funcs);\r\nret = drm_fb_helper_init(vgdev->ddev, &vgfbdev->helper,\r\nvgdev->num_scanouts,\r\nVIRTIO_GPUFB_CONN_LIMIT);\r\nif (ret) {\r\nkfree(vgfbdev);\r\nreturn ret;\r\n}\r\ndrm_fb_helper_single_add_all_connectors(&vgfbdev->helper);\r\ndrm_fb_helper_initial_config(&vgfbdev->helper, bpp_sel);\r\nreturn 0;\r\n}\r\nvoid virtio_gpu_fbdev_fini(struct virtio_gpu_device *vgdev)\r\n{\r\nif (!vgdev->vgfbdev)\r\nreturn;\r\nvirtio_gpu_fbdev_destroy(vgdev->ddev, vgdev->vgfbdev);\r\nkfree(vgdev->vgfbdev);\r\nvgdev->vgfbdev = NULL;\r\n}

static int build_id_cache__kcore_buildid(const char *proc_dir, char *sbuildid)\r\n{\r\nchar root_dir[PATH_MAX];\r\nchar *p;\r\nstrlcpy(root_dir, proc_dir, sizeof(root_dir));\r\np = strrchr(root_dir, '/');\r\nif (!p)\r\nreturn -1;\r\n*p = '\0';\r\nreturn sysfs__sprintf_build_id(root_dir, sbuildid);\r\n}\r\nstatic int build_id_cache__kcore_dir(char *dir, size_t sz)\r\n{\r\nreturn fetch_current_timestamp(dir, sz);\r\n}\r\nstatic bool same_kallsyms_reloc(const char *from_dir, char *to_dir)\r\n{\r\nchar from[PATH_MAX];\r\nchar to[PATH_MAX];\r\nconst char *name;\r\nu64 addr1 = 0, addr2 = 0;\r\nint i;\r\nscnprintf(from, sizeof(from), "%s/kallsyms", from_dir);\r\nscnprintf(to, sizeof(to), "%s/kallsyms", to_dir);\r\nfor (i = 0; (name = ref_reloc_sym_names[i]) != NULL; i++) {\r\naddr1 = kallsyms__get_function_start(from, name);\r\nif (addr1)\r\nbreak;\r\n}\r\nif (name)\r\naddr2 = kallsyms__get_function_start(to, name);\r\nreturn addr1 == addr2;\r\n}\r\nstatic int build_id_cache__kcore_existing(const char *from_dir, char *to_dir,\r\nsize_t to_dir_sz)\r\n{\r\nchar from[PATH_MAX];\r\nchar to[PATH_MAX];\r\nchar to_subdir[PATH_MAX];\r\nstruct dirent *dent;\r\nint ret = -1;\r\nDIR *d;\r\nd = opendir(to_dir);\r\nif (!d)\r\nreturn -1;\r\nscnprintf(from, sizeof(from), "%s/modules", from_dir);\r\nwhile (1) {\r\ndent = readdir(d);\r\nif (!dent)\r\nbreak;\r\nif (dent->d_type != DT_DIR)\r\ncontinue;\r\nscnprintf(to, sizeof(to), "%s/%s/modules", to_dir,\r\ndent->d_name);\r\nscnprintf(to_subdir, sizeof(to_subdir), "%s/%s",\r\nto_dir, dent->d_name);\r\nif (!compare_proc_modules(from, to) &&\r\nsame_kallsyms_reloc(from_dir, to_subdir)) {\r\nstrlcpy(to_dir, to_subdir, to_dir_sz);\r\nret = 0;\r\nbreak;\r\n}\r\n}\r\nclosedir(d);\r\nreturn ret;\r\n}\r\nstatic int build_id_cache__add_kcore(const char *filename, bool force)\r\n{\r\nchar dir[32], sbuildid[SBUILD_ID_SIZE];\r\nchar from_dir[PATH_MAX], to_dir[PATH_MAX];\r\nchar *p;\r\nstrlcpy(from_dir, filename, sizeof(from_dir));\r\np = strrchr(from_dir, '/');\r\nif (!p || strcmp(p + 1, "kcore"))\r\nreturn -1;\r\n*p = '\0';\r\nif (build_id_cache__kcore_buildid(from_dir, sbuildid) < 0)\r\nreturn -1;\r\nscnprintf(to_dir, sizeof(to_dir), "%s/%s/%s",\r\nbuildid_dir, DSO__NAME_KCORE, sbuildid);\r\nif (!force &&\r\n!build_id_cache__kcore_existing(from_dir, to_dir, sizeof(to_dir))) {\r\npr_debug("same kcore found in %s\n", to_dir);\r\nreturn 0;\r\n}\r\nif (build_id_cache__kcore_dir(dir, sizeof(dir)))\r\nreturn -1;\r\nscnprintf(to_dir, sizeof(to_dir), "%s/%s/%s/%s",\r\nbuildid_dir, DSO__NAME_KCORE, sbuildid, dir);\r\nif (mkdir_p(to_dir, 0755))\r\nreturn -1;\r\nif (kcore_copy(from_dir, to_dir)) {\r\nif (!rmdir(to_dir)) {\r\np = strrchr(to_dir, '/');\r\nif (p)\r\n*p = '\0';\r\nif (!rmdir(to_dir)) {\r\np = strrchr(to_dir, '/');\r\nif (p)\r\n*p = '\0';\r\nrmdir(to_dir);\r\n}\r\n}\r\nreturn -1;\r\n}\r\npr_debug("kcore added to build-id cache directory %s\n", to_dir);\r\nreturn 0;\r\n}\r\nstatic int build_id_cache__add_file(const char *filename)\r\n{\r\nchar sbuild_id[SBUILD_ID_SIZE];\r\nu8 build_id[BUILD_ID_SIZE];\r\nint err;\r\nif (filename__read_build_id(filename, &build_id, sizeof(build_id)) < 0) {\r\npr_debug("Couldn't read a build-id in %s\n", filename);\r\nreturn -1;\r\n}\r\nbuild_id__sprintf(build_id, sizeof(build_id), sbuild_id);\r\nerr = build_id_cache__add_s(sbuild_id, filename,\r\nfalse, false);\r\npr_debug("Adding %s %s: %s\n", sbuild_id, filename,\r\nerr ? "FAIL" : "Ok");\r\nreturn err;\r\n}\r\nstatic int build_id_cache__remove_file(const char *filename)\r\n{\r\nu8 build_id[BUILD_ID_SIZE];\r\nchar sbuild_id[SBUILD_ID_SIZE];\r\nint err;\r\nif (filename__read_build_id(filename, &build_id, sizeof(build_id)) < 0) {\r\npr_debug("Couldn't read a build-id in %s\n", filename);\r\nreturn -1;\r\n}\r\nbuild_id__sprintf(build_id, sizeof(build_id), sbuild_id);\r\nerr = build_id_cache__remove_s(sbuild_id);\r\npr_debug("Removing %s %s: %s\n", sbuild_id, filename,\r\nerr ? "FAIL" : "Ok");\r\nreturn err;\r\n}\r\nstatic int build_id_cache__purge_path(const char *pathname)\r\n{\r\nstruct strlist *list;\r\nstruct str_node *pos;\r\nint err;\r\nerr = build_id_cache__list_build_ids(pathname, &list);\r\nif (err)\r\ngoto out;\r\nstrlist__for_each_entry(pos, list) {\r\nerr = build_id_cache__remove_s(pos->s);\r\npr_debug("Removing %s %s: %s\n", pos->s, pathname,\r\nerr ? "FAIL" : "Ok");\r\nif (err)\r\nbreak;\r\n}\r\nstrlist__delete(list);\r\nout:\r\npr_debug("Purging %s: %s\n", pathname, err ? "FAIL" : "Ok");\r\nreturn err;\r\n}\r\nstatic bool dso__missing_buildid_cache(struct dso *dso, int parm __maybe_unused)\r\n{\r\nchar filename[PATH_MAX];\r\nu8 build_id[BUILD_ID_SIZE];\r\nif (dso__build_id_filename(dso, filename, sizeof(filename)) &&\r\nfilename__read_build_id(filename, build_id,\r\nsizeof(build_id)) != sizeof(build_id)) {\r\nif (errno == ENOENT)\r\nreturn false;\r\npr_warning("Problems with %s file, consider removing it from the cache\n",\r\nfilename);\r\n} else if (memcmp(dso->build_id, build_id, sizeof(dso->build_id))) {\r\npr_warning("Problems with %s file, consider removing it from the cache\n",\r\nfilename);\r\n}\r\nreturn true;\r\n}\r\nstatic int build_id_cache__fprintf_missing(struct perf_session *session, FILE *fp)\r\n{\r\nperf_session__fprintf_dsos_buildid(session, fp, dso__missing_buildid_cache, 0);\r\nreturn 0;\r\n}\r\nstatic int build_id_cache__update_file(const char *filename)\r\n{\r\nu8 build_id[BUILD_ID_SIZE];\r\nchar sbuild_id[SBUILD_ID_SIZE];\r\nint err = 0;\r\nif (filename__read_build_id(filename, &build_id, sizeof(build_id)) < 0) {\r\npr_debug("Couldn't read a build-id in %s\n", filename);\r\nreturn -1;\r\n}\r\nbuild_id__sprintf(build_id, sizeof(build_id), sbuild_id);\r\nif (build_id_cache__cached(sbuild_id))\r\nerr = build_id_cache__remove_s(sbuild_id);\r\nif (!err)\r\nerr = build_id_cache__add_s(sbuild_id, filename, false, false);\r\npr_debug("Updating %s %s: %s\n", sbuild_id, filename,\r\nerr ? "FAIL" : "Ok");\r\nreturn err;\r\n}\r\nint cmd_buildid_cache(int argc, const char **argv,\r\nconst char *prefix __maybe_unused)\r\n{\r\nstruct strlist *list;\r\nstruct str_node *pos;\r\nint ret = 0;\r\nbool force = false;\r\nchar const *add_name_list_str = NULL,\r\n*remove_name_list_str = NULL,\r\n*purge_name_list_str = NULL,\r\n*missing_filename = NULL,\r\n*update_name_list_str = NULL,\r\n*kcore_filename = NULL;\r\nchar sbuf[STRERR_BUFSIZE];\r\nstruct perf_data_file file = {\r\n.mode = PERF_DATA_MODE_READ,\r\n};\r\nstruct perf_session *session = NULL;\r\nconst struct option buildid_cache_options[] = {\r\nOPT_STRING('a', "add", &add_name_list_str,\r\n"file list", "file(s) to add"),\r\nOPT_STRING('k', "kcore", &kcore_filename,\r\n"file", "kcore file to add"),\r\nOPT_STRING('r', "remove", &remove_name_list_str, "file list",\r\n"file(s) to remove"),\r\nOPT_STRING('p', "purge", &purge_name_list_str, "path list",\r\n"path(s) to remove (remove old caches too)"),\r\nOPT_STRING('M', "missing", &missing_filename, "file",\r\n"to find missing build ids in the cache"),\r\nOPT_BOOLEAN('f', "force", &force, "don't complain, do it"),\r\nOPT_STRING('u', "update", &update_name_list_str, "file list",\r\n"file(s) to update"),\r\nOPT_INCR('v', "verbose", &verbose, "be more verbose"),\r\nOPT_END()\r\n};\r\nconst char * const buildid_cache_usage[] = {\r\n"perf buildid-cache [<options>]",\r\nNULL\r\n};\r\nargc = parse_options(argc, argv, buildid_cache_options,\r\nbuildid_cache_usage, 0);\r\nif (argc || (!add_name_list_str && !kcore_filename &&\r\n!remove_name_list_str && !purge_name_list_str &&\r\n!missing_filename && !update_name_list_str))\r\nusage_with_options(buildid_cache_usage, buildid_cache_options);\r\nif (missing_filename) {\r\nfile.path = missing_filename;\r\nfile.force = force;\r\nsession = perf_session__new(&file, false, NULL);\r\nif (session == NULL)\r\nreturn -1;\r\n}\r\nif (symbol__init(session ? &session->header.env : NULL) < 0)\r\ngoto out;\r\nsetup_pager();\r\nif (add_name_list_str) {\r\nlist = strlist__new(add_name_list_str, NULL);\r\nif (list) {\r\nstrlist__for_each_entry(pos, list)\r\nif (build_id_cache__add_file(pos->s)) {\r\nif (errno == EEXIST) {\r\npr_debug("%s already in the cache\n",\r\npos->s);\r\ncontinue;\r\n}\r\npr_warning("Couldn't add %s: %s\n",\r\npos->s, str_error_r(errno, sbuf, sizeof(sbuf)));\r\n}\r\nstrlist__delete(list);\r\n}\r\n}\r\nif (remove_name_list_str) {\r\nlist = strlist__new(remove_name_list_str, NULL);\r\nif (list) {\r\nstrlist__for_each_entry(pos, list)\r\nif (build_id_cache__remove_file(pos->s)) {\r\nif (errno == ENOENT) {\r\npr_debug("%s wasn't in the cache\n",\r\npos->s);\r\ncontinue;\r\n}\r\npr_warning("Couldn't remove %s: %s\n",\r\npos->s, str_error_r(errno, sbuf, sizeof(sbuf)));\r\n}\r\nstrlist__delete(list);\r\n}\r\n}\r\nif (purge_name_list_str) {\r\nlist = strlist__new(purge_name_list_str, NULL);\r\nif (list) {\r\nstrlist__for_each_entry(pos, list)\r\nif (build_id_cache__purge_path(pos->s)) {\r\nif (errno == ENOENT) {\r\npr_debug("%s wasn't in the cache\n",\r\npos->s);\r\ncontinue;\r\n}\r\npr_warning("Couldn't remove %s: %s\n",\r\npos->s, str_error_r(errno, sbuf, sizeof(sbuf)));\r\n}\r\nstrlist__delete(list);\r\n}\r\n}\r\nif (missing_filename)\r\nret = build_id_cache__fprintf_missing(session, stdout);\r\nif (update_name_list_str) {\r\nlist = strlist__new(update_name_list_str, NULL);\r\nif (list) {\r\nstrlist__for_each_entry(pos, list)\r\nif (build_id_cache__update_file(pos->s)) {\r\nif (errno == ENOENT) {\r\npr_debug("%s wasn't in the cache\n",\r\npos->s);\r\ncontinue;\r\n}\r\npr_warning("Couldn't update %s: %s\n",\r\npos->s, str_error_r(errno, sbuf, sizeof(sbuf)));\r\n}\r\nstrlist__delete(list);\r\n}\r\n}\r\nif (kcore_filename && build_id_cache__add_kcore(kcore_filename, force))\r\npr_warning("Couldn't add %s\n", kcore_filename);\r\nout:\r\nperf_session__delete(session);\r\nreturn ret;\r\n}

static int __set_clk_parents(struct device_node *node, bool clk_supplier)\r\n{\r\nstruct of_phandle_args clkspec;\r\nint index, rc, num_parents;\r\nstruct clk *clk, *pclk;\r\nnum_parents = of_count_phandle_with_args(node, "assigned-clock-parents",\r\n"#clock-cells");\r\nif (num_parents == -EINVAL)\r\npr_err("clk: invalid value of clock-parents property at %s\n",\r\nnode->full_name);\r\nfor (index = 0; index < num_parents; index++) {\r\nrc = of_parse_phandle_with_args(node, "assigned-clock-parents",\r\n"#clock-cells", index, &clkspec);\r\nif (rc < 0) {\r\nif (rc == -ENOENT)\r\ncontinue;\r\nelse\r\nreturn rc;\r\n}\r\nif (clkspec.np == node && !clk_supplier)\r\nreturn 0;\r\npclk = of_clk_get_from_provider(&clkspec);\r\nif (IS_ERR(pclk)) {\r\npr_warn("clk: couldn't get parent clock %d for %s\n",\r\nindex, node->full_name);\r\nreturn PTR_ERR(pclk);\r\n}\r\nrc = of_parse_phandle_with_args(node, "assigned-clocks",\r\n"#clock-cells", index, &clkspec);\r\nif (rc < 0)\r\ngoto err;\r\nif (clkspec.np == node && !clk_supplier) {\r\nrc = 0;\r\ngoto err;\r\n}\r\nclk = of_clk_get_from_provider(&clkspec);\r\nif (IS_ERR(clk)) {\r\npr_warn("clk: couldn't get assigned clock %d for %s\n",\r\nindex, node->full_name);\r\nrc = PTR_ERR(clk);\r\ngoto err;\r\n}\r\nrc = clk_set_parent(clk, pclk);\r\nif (rc < 0)\r\npr_err("clk: failed to reparent %s to %s: %d\n",\r\n__clk_get_name(clk), __clk_get_name(pclk), rc);\r\nclk_put(clk);\r\nclk_put(pclk);\r\n}\r\nreturn 0;\r\nerr:\r\nclk_put(pclk);\r\nreturn rc;\r\n}\r\nstatic int __set_clk_rates(struct device_node *node, bool clk_supplier)\r\n{\r\nstruct of_phandle_args clkspec;\r\nstruct property *prop;\r\nconst __be32 *cur;\r\nint rc, index = 0;\r\nstruct clk *clk;\r\nu32 rate;\r\nof_property_for_each_u32(node, "assigned-clock-rates", prop, cur, rate) {\r\nif (rate) {\r\nrc = of_parse_phandle_with_args(node, "assigned-clocks",\r\n"#clock-cells", index, &clkspec);\r\nif (rc < 0) {\r\nif (rc == -ENOENT)\r\ncontinue;\r\nelse\r\nreturn rc;\r\n}\r\nif (clkspec.np == node && !clk_supplier)\r\nreturn 0;\r\nclk = of_clk_get_from_provider(&clkspec);\r\nif (IS_ERR(clk)) {\r\npr_warn("clk: couldn't get clock %d for %s\n",\r\nindex, node->full_name);\r\nreturn PTR_ERR(clk);\r\n}\r\nrc = clk_set_rate(clk, rate);\r\nif (rc < 0)\r\npr_err("clk: couldn't set %s clk rate to %d (%d), current rate: %ld\n",\r\n__clk_get_name(clk), rate, rc,\r\nclk_get_rate(clk));\r\nclk_put(clk);\r\n}\r\nindex++;\r\n}\r\nreturn 0;\r\n}\r\nint of_clk_set_defaults(struct device_node *node, bool clk_supplier)\r\n{\r\nint rc;\r\nif (!node)\r\nreturn 0;\r\nrc = __set_clk_parents(node, clk_supplier);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn __set_clk_rates(node, clk_supplier);\r\n}

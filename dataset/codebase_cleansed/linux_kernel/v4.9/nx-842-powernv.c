static void setup_indirect_dde(struct data_descriptor_entry *dde,\r\nstruct data_descriptor_entry *ddl,\r\nunsigned int dde_count, unsigned int byte_count)\r\n{\r\ndde->flags = 0;\r\ndde->count = dde_count;\r\ndde->index = 0;\r\ndde->length = cpu_to_be32(byte_count);\r\ndde->address = cpu_to_be64(nx842_get_pa(ddl));\r\n}\r\nstatic unsigned int setup_direct_dde(struct data_descriptor_entry *dde,\r\nunsigned long pa, unsigned int len)\r\n{\r\nunsigned int l = min_t(unsigned int, len, LEN_ON_PAGE(pa));\r\ndde->flags = 0;\r\ndde->count = 0;\r\ndde->index = 0;\r\ndde->length = cpu_to_be32(l);\r\ndde->address = cpu_to_be64(pa);\r\nreturn l;\r\n}\r\nstatic int setup_ddl(struct data_descriptor_entry *dde,\r\nstruct data_descriptor_entry *ddl,\r\nunsigned char *buf, unsigned int len,\r\nbool in)\r\n{\r\nunsigned long pa = nx842_get_pa(buf);\r\nint i, ret, total_len = len;\r\nif (!IS_ALIGNED(pa, DDE_BUFFER_ALIGN)) {\r\npr_debug("%s buffer pa 0x%lx not 0x%x-byte aligned\n",\r\nin ? "input" : "output", pa, DDE_BUFFER_ALIGN);\r\nreturn -EINVAL;\r\n}\r\nif (len % DDE_BUFFER_LAST_MULT) {\r\npr_debug("%s buffer len 0x%x not a multiple of 0x%x\n",\r\nin ? "input" : "output", len, DDE_BUFFER_LAST_MULT);\r\nif (in)\r\nreturn -EINVAL;\r\nlen = round_down(len, DDE_BUFFER_LAST_MULT);\r\n}\r\nif (len <= LEN_ON_PAGE(pa)) {\r\nret = setup_direct_dde(dde, pa, len);\r\nWARN_ON(ret < len);\r\nreturn 0;\r\n}\r\nfor (i = 0; i < DDL_LEN_MAX && len > 0; i++) {\r\nret = setup_direct_dde(&ddl[i], pa, len);\r\nbuf += ret;\r\nlen -= ret;\r\npa = nx842_get_pa(buf);\r\n}\r\nif (len > 0) {\r\npr_debug("0x%x total %s bytes 0x%x too many for DDL.\n",\r\ntotal_len, in ? "input" : "output", len);\r\nif (in)\r\nreturn -EMSGSIZE;\r\ntotal_len -= len;\r\n}\r\nsetup_indirect_dde(dde, ddl, i, total_len);\r\nreturn 0;\r\n}\r\nstatic int wait_for_csb(struct nx842_workmem *wmem,\r\nstruct coprocessor_status_block *csb)\r\n{\r\nktime_t start = wmem->start, now = ktime_get();\r\nktime_t timeout = ktime_add_ms(start, CSB_WAIT_MAX);\r\nwhile (!(ACCESS_ONCE(csb->flags) & CSB_V)) {\r\ncpu_relax();\r\nnow = ktime_get();\r\nif (ktime_after(now, timeout))\r\nbreak;\r\n}\r\nbarrier();\r\nif (!(csb->flags & CSB_V)) {\r\nCSB_ERR(csb, "CSB still not valid after %ld us, giving up",\r\n(long)ktime_us_delta(now, start));\r\nreturn -ETIMEDOUT;\r\n}\r\nif (csb->flags & CSB_F) {\r\nCSB_ERR(csb, "Invalid CSB format");\r\nreturn -EPROTO;\r\n}\r\nif (csb->flags & CSB_CH) {\r\nCSB_ERR(csb, "Invalid CSB chaining state");\r\nreturn -EPROTO;\r\n}\r\nif (csb->cs) {\r\nCSB_ERR(csb, "Invalid CSB completion sequence");\r\nreturn -EPROTO;\r\n}\r\nswitch (csb->cc) {\r\ncase CSB_CC_SUCCESS:\r\nbreak;\r\ncase CSB_CC_TPBC_GT_SPBC:\r\nbreak;\r\ncase CSB_CC_OPERAND_OVERLAP:\r\nCSB_ERR(csb, "Operand Overlap error");\r\nreturn -EINVAL;\r\ncase CSB_CC_INVALID_OPERAND:\r\nCSB_ERR(csb, "Invalid operand");\r\nreturn -EINVAL;\r\ncase CSB_CC_NOSPC:\r\nreturn -ENOSPC;\r\ncase CSB_CC_ABORT:\r\nCSB_ERR(csb, "Function aborted");\r\nreturn -EINTR;\r\ncase CSB_CC_CRC_MISMATCH:\r\nCSB_ERR(csb, "CRC mismatch");\r\nreturn -EINVAL;\r\ncase CSB_CC_TEMPL_INVALID:\r\nCSB_ERR(csb, "Compressed data template invalid");\r\nreturn -EINVAL;\r\ncase CSB_CC_TEMPL_OVERFLOW:\r\nCSB_ERR(csb, "Compressed data template shows data past end");\r\nreturn -EINVAL;\r\ncase CSB_CC_INVALID_ALIGN:\r\nCSB_ERR_ADDR(csb, "Invalid alignment");\r\nreturn -EINVAL;\r\ncase CSB_CC_DATA_LENGTH:\r\nCSB_ERR(csb, "Invalid data length");\r\nreturn -EINVAL;\r\ncase CSB_CC_WR_TRANSLATION:\r\ncase CSB_CC_TRANSLATION:\r\ncase CSB_CC_TRANSLATION_DUP1:\r\ncase CSB_CC_TRANSLATION_DUP2:\r\ncase CSB_CC_TRANSLATION_DUP3:\r\ncase CSB_CC_TRANSLATION_DUP4:\r\ncase CSB_CC_TRANSLATION_DUP5:\r\ncase CSB_CC_TRANSLATION_DUP6:\r\nCSB_ERR_ADDR(csb, "Translation error");\r\nreturn -EPROTO;\r\ncase CSB_CC_WR_PROTECTION:\r\ncase CSB_CC_PROTECTION:\r\ncase CSB_CC_PROTECTION_DUP1:\r\ncase CSB_CC_PROTECTION_DUP2:\r\ncase CSB_CC_PROTECTION_DUP3:\r\ncase CSB_CC_PROTECTION_DUP4:\r\ncase CSB_CC_PROTECTION_DUP5:\r\ncase CSB_CC_PROTECTION_DUP6:\r\nCSB_ERR_ADDR(csb, "Protection error");\r\nreturn -EPROTO;\r\ncase CSB_CC_PRIVILEGE:\r\nCSB_ERR(csb, "Insufficient Privilege error");\r\nreturn -EPROTO;\r\ncase CSB_CC_EXCESSIVE_DDE:\r\nCSB_ERR(csb, "Too many DDEs in DDL");\r\nreturn -EINVAL;\r\ncase CSB_CC_TRANSPORT:\r\nCSB_ERR(csb, "Invalid CRB");\r\nreturn -EINVAL;\r\ncase CSB_CC_SEGMENTED_DDL:\r\nCSB_ERR(csb, "Segmented DDL error");\r\nreturn -EINVAL;\r\ncase CSB_CC_DDE_OVERFLOW:\r\nCSB_ERR(csb, "DDE overflow error");\r\nreturn -EINVAL;\r\ncase CSB_CC_SESSION:\r\nCSB_ERR(csb, "Session violation error");\r\nreturn -EPROTO;\r\ncase CSB_CC_CHAIN:\r\nCSB_ERR(csb, "Chained CRB error");\r\nreturn -EPROTO;\r\ncase CSB_CC_SEQUENCE:\r\nCSB_ERR(csb, "CRB seqeunce number error");\r\nreturn -EPROTO;\r\ncase CSB_CC_UNKNOWN_CODE:\r\nCSB_ERR(csb, "Unknown subfunction code");\r\nreturn -EPROTO;\r\ncase CSB_CC_RD_EXTERNAL:\r\ncase CSB_CC_RD_EXTERNAL_DUP1:\r\ncase CSB_CC_RD_EXTERNAL_DUP2:\r\ncase CSB_CC_RD_EXTERNAL_DUP3:\r\nCSB_ERR_ADDR(csb, "Read error outside coprocessor");\r\nreturn -EPROTO;\r\ncase CSB_CC_WR_EXTERNAL:\r\nCSB_ERR_ADDR(csb, "Write error outside coprocessor");\r\nreturn -EPROTO;\r\ncase CSB_CC_INTERNAL:\r\nCSB_ERR(csb, "Internal error in coprocessor");\r\nreturn -EPROTO;\r\ncase CSB_CC_PROVISION:\r\nCSB_ERR(csb, "Storage provision error");\r\nreturn -EPROTO;\r\ncase CSB_CC_HW:\r\nCSB_ERR(csb, "Correctable hardware error");\r\nreturn -EPROTO;\r\ndefault:\r\nCSB_ERR(csb, "Invalid CC %d", csb->cc);\r\nreturn -EPROTO;\r\n}\r\nif (csb->ce & CSB_CE_TERMINATION) {\r\nCSB_ERR(csb, "CSB request was terminated");\r\nreturn -EPROTO;\r\n}\r\nif (csb->ce & CSB_CE_INCOMPLETE) {\r\nCSB_ERR(csb, "CSB request not complete");\r\nreturn -EPROTO;\r\n}\r\nif (!(csb->ce & CSB_CE_TPBC)) {\r\nCSB_ERR(csb, "TPBC not provided, unknown target length");\r\nreturn -EPROTO;\r\n}\r\npr_debug_ratelimited("Processed %u bytes in %lu us\n",\r\nbe32_to_cpu(csb->count),\r\n(unsigned long)ktime_us_delta(now, start));\r\nreturn 0;\r\n}\r\nstatic int nx842_powernv_function(const unsigned char *in, unsigned int inlen,\r\nunsigned char *out, unsigned int *outlenp,\r\nvoid *workmem, int fc)\r\n{\r\nstruct coprocessor_request_block *crb;\r\nstruct coprocessor_status_block *csb;\r\nstruct nx842_workmem *wmem;\r\nint ret;\r\nu64 csb_addr;\r\nu32 ccw;\r\nunsigned int outlen = *outlenp;\r\nwmem = PTR_ALIGN(workmem, WORKMEM_ALIGN);\r\n*outlenp = 0;\r\nif (!nx842_ct) {\r\npr_err_ratelimited("coprocessor CT is 0");\r\nreturn -ENODEV;\r\n}\r\ncrb = &wmem->crb;\r\ncsb = &crb->csb;\r\nmemset(crb, 0, sizeof(*crb));\r\nret = setup_ddl(&crb->source, wmem->ddl_in,\r\n(unsigned char *)in, inlen, true);\r\nif (ret)\r\nreturn ret;\r\nret = setup_ddl(&crb->target, wmem->ddl_out,\r\nout, outlen, false);\r\nif (ret)\r\nreturn ret;\r\nccw = 0;\r\nccw = SET_FIELD(ccw, CCW_CT, nx842_ct);\r\nccw = SET_FIELD(ccw, CCW_CI_842, 0);\r\nccw = SET_FIELD(ccw, CCW_FC_842, fc);\r\ncsb_addr = nx842_get_pa(csb) & CRB_CSB_ADDRESS;\r\ncsb_addr |= CRB_CSB_AT;\r\ncrb->csb_addr = cpu_to_be64(csb_addr);\r\nwmem->start = ktime_get();\r\nret = icswx(cpu_to_be32(ccw), crb);\r\npr_debug_ratelimited("icswx CR %x ccw %x crb->ccw %x\n", ret,\r\n(unsigned int)ccw,\r\n(unsigned int)be32_to_cpu(crb->ccw));\r\nret &= ~ICSWX_XERS0;\r\nswitch (ret) {\r\ncase ICSWX_INITIATED:\r\nret = wait_for_csb(wmem, csb);\r\nbreak;\r\ncase ICSWX_BUSY:\r\npr_debug_ratelimited("842 Coprocessor busy\n");\r\nret = -EBUSY;\r\nbreak;\r\ncase ICSWX_REJECTED:\r\npr_err_ratelimited("ICSWX rejected\n");\r\nret = -EPROTO;\r\nbreak;\r\n}\r\nif (!ret)\r\n*outlenp = be32_to_cpu(csb->count);\r\nreturn ret;\r\n}\r\nstatic int nx842_powernv_compress(const unsigned char *in, unsigned int inlen,\r\nunsigned char *out, unsigned int *outlenp,\r\nvoid *wmem)\r\n{\r\nreturn nx842_powernv_function(in, inlen, out, outlenp,\r\nwmem, CCW_FC_842_COMP_CRC);\r\n}\r\nstatic int nx842_powernv_decompress(const unsigned char *in, unsigned int inlen,\r\nunsigned char *out, unsigned int *outlenp,\r\nvoid *wmem)\r\n{\r\nreturn nx842_powernv_function(in, inlen, out, outlenp,\r\nwmem, CCW_FC_842_DECOMP_CRC);\r\n}\r\nstatic int __init nx842_powernv_probe(struct device_node *dn)\r\n{\r\nstruct nx842_coproc *coproc;\r\nunsigned int ct, ci;\r\nint chip_id;\r\nchip_id = of_get_ibm_chip_id(dn);\r\nif (chip_id < 0) {\r\npr_err("ibm,chip-id missing\n");\r\nreturn -EINVAL;\r\n}\r\nif (of_property_read_u32(dn, "ibm,842-coprocessor-type", &ct)) {\r\npr_err("ibm,842-coprocessor-type missing\n");\r\nreturn -EINVAL;\r\n}\r\nif (of_property_read_u32(dn, "ibm,842-coprocessor-instance", &ci)) {\r\npr_err("ibm,842-coprocessor-instance missing\n");\r\nreturn -EINVAL;\r\n}\r\ncoproc = kmalloc(sizeof(*coproc), GFP_KERNEL);\r\nif (!coproc)\r\nreturn -ENOMEM;\r\ncoproc->chip_id = chip_id;\r\ncoproc->ct = ct;\r\ncoproc->ci = ci;\r\nINIT_LIST_HEAD(&coproc->list);\r\nlist_add(&coproc->list, &nx842_coprocs);\r\npr_info("coprocessor found on chip %d, CT %d CI %d\n", chip_id, ct, ci);\r\nif (!nx842_ct)\r\nnx842_ct = ct;\r\nelse if (nx842_ct != ct)\r\npr_err("NX842 chip %d, CT %d != first found CT %d\n",\r\nchip_id, ct, nx842_ct);\r\nreturn 0;\r\n}\r\nstatic int nx842_powernv_crypto_init(struct crypto_tfm *tfm)\r\n{\r\nreturn nx842_crypto_init(tfm, &nx842_powernv_driver);\r\n}\r\nstatic __init int nx842_powernv_init(void)\r\n{\r\nstruct device_node *dn;\r\nint ret;\r\nBUILD_BUG_ON(WORKMEM_ALIGN % CRB_ALIGN);\r\nBUILD_BUG_ON(CRB_ALIGN % DDE_ALIGN);\r\nBUILD_BUG_ON(CRB_SIZE % DDE_ALIGN);\r\nBUILD_BUG_ON(PAGE_SIZE % DDE_BUFFER_ALIGN);\r\nBUILD_BUG_ON(DDE_BUFFER_ALIGN % DDE_BUFFER_SIZE_MULT);\r\nBUILD_BUG_ON(DDE_BUFFER_SIZE_MULT % DDE_BUFFER_LAST_MULT);\r\nfor_each_compatible_node(dn, NULL, "ibm,power-nx")\r\nnx842_powernv_probe(dn);\r\nif (!nx842_ct)\r\nreturn -ENODEV;\r\nret = crypto_register_alg(&nx842_powernv_alg);\r\nif (ret) {\r\nstruct nx842_coproc *coproc, *n;\r\nlist_for_each_entry_safe(coproc, n, &nx842_coprocs, list) {\r\nlist_del(&coproc->list);\r\nkfree(coproc);\r\n}\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit nx842_powernv_exit(void)\r\n{\r\nstruct nx842_coproc *coproc, *n;\r\ncrypto_unregister_alg(&nx842_powernv_alg);\r\nlist_for_each_entry_safe(coproc, n, &nx842_coprocs, list) {\r\nlist_del(&coproc->list);\r\nkfree(coproc);\r\n}\r\n}

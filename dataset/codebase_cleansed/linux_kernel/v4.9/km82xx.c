static void __init km82xx_pic_init(void)\r\n{\r\nstruct device_node *np = of_find_compatible_node(NULL, NULL,\r\n"fsl,pq2-pic");\r\nif (!np) {\r\npr_err("PIC init: can not find cpm-pic node\n");\r\nreturn;\r\n}\r\ncpm2_pic_init(np);\r\nof_node_put(np);\r\n}\r\nstatic void __init init_ioports(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(km82xx_pins); i++) {\r\nconst struct cpm_pin *pin = &km82xx_pins[i];\r\ncpm2_set_pin(pin->port, pin->pin, pin->flags);\r\n}\r\ncpm2_smc_clk_setup(CPM_CLK_SMC2, CPM_BRG8);\r\ncpm2_smc_clk_setup(CPM_CLK_SMC1, CPM_BRG7);\r\ncpm2_clk_setup(CPM_CLK_SCC1, CPM_CLK11, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_SCC1, CPM_CLK11, CPM_CLK_TX);\r\ncpm2_clk_setup(CPM_CLK_SCC3, CPM_CLK5, CPM_CLK_RTX);\r\ncpm2_clk_setup(CPM_CLK_SCC4, CPM_CLK7, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_SCC4, CPM_CLK8, CPM_CLK_TX);\r\ncpm2_clk_setup(CPM_CLK_FCC1, CPM_CLK10, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_FCC1, CPM_CLK9, CPM_CLK_TX);\r\ncpm2_clk_setup(CPM_CLK_FCC2, CPM_CLK13, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_FCC2, CPM_CLK14, CPM_CLK_TX);\r\nsetbits32(&cpm2_immr->im_ioport.iop_pdata, 1 << (31 - 10));\r\nclrbits32(&cpm2_immr->im_ioport.iop_pdata, 1 << (31 - 11));\r\n}\r\nstatic void __init km82xx_setup_arch(void)\r\n{\r\nif (ppc_md.progress)\r\nppc_md.progress("km82xx_setup_arch()", 0);\r\ncpm2_reset();\r\nclrbits32(&cpm2_immr->im_siu_conf.siu_82xx.sc_bcr, MPC82XX_BCR_PLDP);\r\ninit_ioports();\r\nif (ppc_md.progress)\r\nppc_md.progress("km82xx_setup_arch(), finish", 0);\r\n}\r\nstatic int __init declare_of_platform_devices(void)\r\n{\r\nof_platform_bus_probe(NULL, of_bus_ids, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init km82xx_probe(void)\r\n{\r\nreturn of_machine_is_compatible("keymile,km82xx");\r\n}

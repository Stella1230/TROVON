static irqreturn_t hi65xx_power_press_isr(int irq, void *q)\r\n{\r\nstruct input_dev *input = q;\r\npm_wakeup_event(input->dev.parent, MAX_HELD_TIME);\r\ninput_report_key(input, KEY_POWER, 1);\r\ninput_sync(input);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t hi65xx_power_release_isr(int irq, void *q)\r\n{\r\nstruct input_dev *input = q;\r\npm_wakeup_event(input->dev.parent, MAX_HELD_TIME);\r\ninput_report_key(input, KEY_POWER, 0);\r\ninput_sync(input);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t hi65xx_restart_toggle_isr(int irq, void *q)\r\n{\r\nstruct input_dev *input = q;\r\nint value = test_bit(KEY_RESTART, input->key);\r\npm_wakeup_event(input->dev.parent, MAX_HELD_TIME);\r\ninput_report_key(input, KEY_RESTART, !value);\r\ninput_sync(input);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int hi65xx_powerkey_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct input_dev *input;\r\nint irq, i, error;\r\ninput = devm_input_allocate_device(&pdev->dev);\r\nif (!input) {\r\ndev_err(&pdev->dev, "failed to allocate input device\n");\r\nreturn -ENOMEM;\r\n}\r\ninput->phys = "hisi_on/input0";\r\ninput->name = "HISI 65xx PowerOn Key";\r\ninput_set_capability(input, EV_KEY, KEY_POWER);\r\ninput_set_capability(input, EV_KEY, KEY_RESTART);\r\nfor (i = 0; i < ARRAY_SIZE(hi65xx_irq_info); i++) {\r\nirq = platform_get_irq_byname(pdev, hi65xx_irq_info[i].name);\r\nif (irq < 0) {\r\nerror = irq;\r\ndev_err(dev, "couldn't get irq %s: %d\n",\r\nhi65xx_irq_info[i].name, error);\r\nreturn error;\r\n}\r\nerror = devm_request_any_context_irq(dev, irq,\r\nhi65xx_irq_info[i].handler,\r\nIRQF_ONESHOT,\r\nhi65xx_irq_info[i].name,\r\ninput);\r\nif (error < 0) {\r\ndev_err(dev, "couldn't request irq %s: %d\n",\r\nhi65xx_irq_info[i].name, error);\r\nreturn error;\r\n}\r\n}\r\nerror = input_register_device(input);\r\nif (error) {\r\ndev_err(&pdev->dev, "failed to register input device: %d\n",\r\nerror);\r\nreturn error;\r\n}\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nreturn 0;\r\n}\r\nstatic int hi65xx_powerkey_remove(struct platform_device *pdev)\r\n{\r\ndevice_init_wakeup(&pdev->dev, 0);\r\nreturn 0;\r\n}

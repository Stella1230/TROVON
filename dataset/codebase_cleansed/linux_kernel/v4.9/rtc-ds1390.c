static void ds1390_set_reg(struct device *dev, unsigned char address,\r\nunsigned char data)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nunsigned char buf[2];\r\nbuf[0] = address | 0x80;\r\nbuf[1] = data;\r\nspi_write(spi, buf, 2);\r\n}\r\nstatic int ds1390_get_reg(struct device *dev, unsigned char address,\r\nunsigned char *data)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct ds1390 *chip = dev_get_drvdata(dev);\r\nint status;\r\nif (!data)\r\nreturn -EINVAL;\r\nchip->txrx_buf[0] = address & 0x7f;\r\nstatus = spi_write_then_read(spi, chip->txrx_buf, 1, chip->txrx_buf, 1);\r\nif (status != 0)\r\nreturn status;\r\n*data = chip->txrx_buf[0];\r\nreturn 0;\r\n}\r\nstatic void ds1390_trickle_of_init(struct spi_device *spi)\r\n{\r\nu32 ohms = 0;\r\nu8 value;\r\nif (of_property_read_u32(spi->dev.of_node, "trickle-resistor-ohms",\r\n&ohms))\r\ngoto out;\r\nvalue = DS1390_TRICKLE_CHARGER_ENABLE;\r\nif (of_property_read_bool(spi->dev.of_node, "trickle-diode-disable"))\r\nvalue |= DS1390_TRICKLE_CHARGER_NO_DIODE;\r\nelse\r\nvalue |= DS1390_TRICKLE_CHARGER_DIODE;\r\nswitch (ohms) {\r\ncase 250:\r\nvalue |= DS1390_TRICKLE_CHARGER_250_OHM;\r\nbreak;\r\ncase 2000:\r\nvalue |= DS1390_TRICKLE_CHARGER_2K_OHM;\r\nbreak;\r\ncase 4000:\r\nvalue |= DS1390_TRICKLE_CHARGER_4K_OHM;\r\nbreak;\r\ndefault:\r\ndev_warn(&spi->dev,\r\n"Unsupported ohm value %02ux in dt\n", ohms);\r\nreturn;\r\n}\r\nds1390_set_reg(&spi->dev, DS1390_REG_TRICKLE, value);\r\nout:\r\nreturn;\r\n}\r\nstatic int ds1390_read_time(struct device *dev, struct rtc_time *dt)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct ds1390 *chip = dev_get_drvdata(dev);\r\nint status;\r\nchip->txrx_buf[0] = DS1390_REG_SECONDS;\r\nstatus = spi_write_then_read(spi, chip->txrx_buf, 1, chip->txrx_buf, 8);\r\nif (status != 0)\r\nreturn status;\r\ndt->tm_sec = bcd2bin(chip->txrx_buf[0]);\r\ndt->tm_min = bcd2bin(chip->txrx_buf[1]);\r\ndt->tm_hour = bcd2bin(chip->txrx_buf[2]);\r\ndt->tm_wday = bcd2bin(chip->txrx_buf[3]);\r\ndt->tm_mday = bcd2bin(chip->txrx_buf[4]);\r\ndt->tm_mon = bcd2bin(chip->txrx_buf[5] & 0x7f) - 1;\r\ndt->tm_year = bcd2bin(chip->txrx_buf[6]) + ((chip->txrx_buf[5] & 0x80) ? 100 : 0);\r\nreturn rtc_valid_tm(dt);\r\n}\r\nstatic int ds1390_set_time(struct device *dev, struct rtc_time *dt)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct ds1390 *chip = dev_get_drvdata(dev);\r\nchip->txrx_buf[0] = DS1390_REG_SECONDS | 0x80;\r\nchip->txrx_buf[1] = bin2bcd(dt->tm_sec);\r\nchip->txrx_buf[2] = bin2bcd(dt->tm_min);\r\nchip->txrx_buf[3] = bin2bcd(dt->tm_hour);\r\nchip->txrx_buf[4] = bin2bcd(dt->tm_wday);\r\nchip->txrx_buf[5] = bin2bcd(dt->tm_mday);\r\nchip->txrx_buf[6] = bin2bcd(dt->tm_mon + 1) |\r\n((dt->tm_year > 99) ? 0x80 : 0x00);\r\nchip->txrx_buf[7] = bin2bcd(dt->tm_year % 100);\r\nreturn spi_write_then_read(spi, chip->txrx_buf, 8, NULL, 0);\r\n}\r\nstatic int ds1390_probe(struct spi_device *spi)\r\n{\r\nunsigned char tmp;\r\nstruct ds1390 *chip;\r\nint res;\r\nspi->mode = SPI_MODE_3;\r\nspi->bits_per_word = 8;\r\nspi_setup(spi);\r\nchip = devm_kzalloc(&spi->dev, sizeof(*chip), GFP_KERNEL);\r\nif (!chip)\r\nreturn -ENOMEM;\r\nspi_set_drvdata(spi, chip);\r\nres = ds1390_get_reg(&spi->dev, DS1390_REG_SECONDS, &tmp);\r\nif (res != 0) {\r\ndev_err(&spi->dev, "unable to read device\n");\r\nreturn res;\r\n}\r\nif (spi->dev.of_node)\r\nds1390_trickle_of_init(spi);\r\nchip->rtc = devm_rtc_device_register(&spi->dev, "ds1390",\r\n&ds1390_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(chip->rtc)) {\r\ndev_err(&spi->dev, "unable to register device\n");\r\nres = PTR_ERR(chip->rtc);\r\n}\r\nreturn res;\r\n}

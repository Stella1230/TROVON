static int\r\nqla2x00_dfs_tgt_sess_show(struct seq_file *s, void *unused)\r\n{\r\nscsi_qla_host_t *vha = s->private;\r\nstruct qla_hw_data *ha = vha->hw;\r\nunsigned long flags;\r\nstruct qla_tgt_sess *sess = NULL;\r\nstruct qla_tgt *tgt= vha->vha_tgt.qla_tgt;\r\nseq_printf(s, "%s\n",vha->host_str);\r\nif (tgt) {\r\nseq_printf(s, "Port ID Port Name Handle\n");\r\nspin_lock_irqsave(&ha->tgt.sess_lock, flags);\r\nlist_for_each_entry(sess, &tgt->sess_list, sess_list_entry) {\r\nseq_printf(s, "%02x:%02x:%02x %8phC %d\n",\r\nsess->s_id.b.domain,sess->s_id.b.area,\r\nsess->s_id.b.al_pa, sess->port_name,\r\nsess->loop_id);\r\n}\r\nspin_unlock_irqrestore(&ha->tgt.sess_lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nqla2x00_dfs_tgt_sess_open(struct inode *inode, struct file *file)\r\n{\r\nscsi_qla_host_t *vha = inode->i_private;\r\nreturn single_open(file, qla2x00_dfs_tgt_sess_show, vha);\r\n}\r\nstatic int\r\nqla_dfs_fw_resource_cnt_show(struct seq_file *s, void *unused)\r\n{\r\nstruct scsi_qla_host *vha = s->private;\r\nstruct qla_hw_data *ha = vha->hw;\r\nseq_puts(s, "FW Resource count\n\n");\r\nseq_printf(s, "Original TGT exchg count[%d]\n",\r\nha->orig_fw_tgt_xcb_count);\r\nseq_printf(s, "current TGT exchg count[%d]\n",\r\nha->cur_fw_tgt_xcb_count);\r\nseq_printf(s, "original Initiator Exchange count[%d]\n",\r\nha->orig_fw_xcb_count);\r\nseq_printf(s, "Current Initiator Exchange count[%d]\n",\r\nha->cur_fw_xcb_count);\r\nseq_printf(s, "Original IOCB count[%d]\n", ha->orig_fw_iocb_count);\r\nseq_printf(s, "Current IOCB count[%d]\n", ha->cur_fw_iocb_count);\r\nseq_printf(s, "MAX VP count[%d]\n", ha->max_npiv_vports);\r\nseq_printf(s, "MAX FCF count[%d]\n", ha->fw_max_fcf_count);\r\nreturn 0;\r\n}\r\nstatic int\r\nqla_dfs_fw_resource_cnt_open(struct inode *inode, struct file *file)\r\n{\r\nstruct scsi_qla_host *vha = inode->i_private;\r\nreturn single_open(file, qla_dfs_fw_resource_cnt_show, vha);\r\n}\r\nstatic int\r\nqla_dfs_tgt_counters_show(struct seq_file *s, void *unused)\r\n{\r\nstruct scsi_qla_host *vha = s->private;\r\nseq_puts(s, "Target Counters\n");\r\nseq_printf(s, "qla_core_sbt_cmd = %lld\n",\r\nvha->tgt_counters.qla_core_sbt_cmd);\r\nseq_printf(s, "qla_core_ret_sta_ctio = %lld\n",\r\nvha->tgt_counters.qla_core_ret_sta_ctio);\r\nseq_printf(s, "qla_core_ret_ctio = %lld\n",\r\nvha->tgt_counters.qla_core_ret_ctio);\r\nseq_printf(s, "core_qla_que_buf = %lld\n",\r\nvha->tgt_counters.core_qla_que_buf);\r\nseq_printf(s, "core_qla_snd_status = %lld\n",\r\nvha->tgt_counters.core_qla_snd_status);\r\nseq_printf(s, "core_qla_free_cmd = %lld\n",\r\nvha->tgt_counters.core_qla_free_cmd);\r\nseq_printf(s, "num alloc iocb failed = %lld\n",\r\nvha->tgt_counters.num_alloc_iocb_failed);\r\nseq_printf(s, "num term exchange sent = %lld\n",\r\nvha->tgt_counters.num_term_xchg_sent);\r\nseq_printf(s, "num Q full sent = %lld\n",\r\nvha->tgt_counters.num_q_full_sent);\r\nreturn 0;\r\n}\r\nstatic int\r\nqla_dfs_tgt_counters_open(struct inode *inode, struct file *file)\r\n{\r\nstruct scsi_qla_host *vha = inode->i_private;\r\nreturn single_open(file, qla_dfs_tgt_counters_show, vha);\r\n}\r\nstatic int\r\nqla2x00_dfs_fce_show(struct seq_file *s, void *unused)\r\n{\r\nscsi_qla_host_t *vha = s->private;\r\nuint32_t cnt;\r\nuint32_t *fce;\r\nuint64_t fce_start;\r\nstruct qla_hw_data *ha = vha->hw;\r\nmutex_lock(&ha->fce_mutex);\r\nseq_puts(s, "FCE Trace Buffer\n");\r\nseq_printf(s, "In Pointer = %llx\n\n", (unsigned long long)ha->fce_wr);\r\nseq_printf(s, "Base = %llx\n\n", (unsigned long long) ha->fce_dma);\r\nseq_puts(s, "FCE Enable Registers\n");\r\nseq_printf(s, "%08x %08x %08x %08x %08x %08x\n",\r\nha->fce_mb[0], ha->fce_mb[2], ha->fce_mb[3], ha->fce_mb[4],\r\nha->fce_mb[5], ha->fce_mb[6]);\r\nfce = (uint32_t *) ha->fce;\r\nfce_start = (unsigned long long) ha->fce_dma;\r\nfor (cnt = 0; cnt < fce_calc_size(ha->fce_bufs) / 4; cnt++) {\r\nif (cnt % 8 == 0)\r\nseq_printf(s, "\n%llx: ",\r\n(unsigned long long)((cnt * 4) + fce_start));\r\nelse\r\nseq_putc(s, ' ');\r\nseq_printf(s, "%08x", *fce++);\r\n}\r\nseq_puts(s, "\nEnd\n");\r\nmutex_unlock(&ha->fce_mutex);\r\nreturn 0;\r\n}\r\nstatic int\r\nqla2x00_dfs_fce_open(struct inode *inode, struct file *file)\r\n{\r\nscsi_qla_host_t *vha = inode->i_private;\r\nstruct qla_hw_data *ha = vha->hw;\r\nint rval;\r\nif (!ha->flags.fce_enabled)\r\ngoto out;\r\nmutex_lock(&ha->fce_mutex);\r\nrval = qla2x00_disable_fce_trace(vha, &ha->fce_wr, &ha->fce_rd);\r\nif (rval)\r\nql_dbg(ql_dbg_user, vha, 0x705c,\r\n"DebugFS: Unable to disable FCE (%d).\n", rval);\r\nha->flags.fce_enabled = 0;\r\nmutex_unlock(&ha->fce_mutex);\r\nout:\r\nreturn single_open(file, qla2x00_dfs_fce_show, vha);\r\n}\r\nstatic int\r\nqla2x00_dfs_fce_release(struct inode *inode, struct file *file)\r\n{\r\nscsi_qla_host_t *vha = inode->i_private;\r\nstruct qla_hw_data *ha = vha->hw;\r\nint rval;\r\nif (ha->flags.fce_enabled)\r\ngoto out;\r\nmutex_lock(&ha->fce_mutex);\r\nha->flags.fce_enabled = 1;\r\nmemset(ha->fce, 0, fce_calc_size(ha->fce_bufs));\r\nrval = qla2x00_enable_fce_trace(vha, ha->fce_dma, ha->fce_bufs,\r\nha->fce_mb, &ha->fce_bufs);\r\nif (rval) {\r\nql_dbg(ql_dbg_user, vha, 0x700d,\r\n"DebugFS: Unable to reinitialize FCE (%d).\n", rval);\r\nha->flags.fce_enabled = 0;\r\n}\r\nmutex_unlock(&ha->fce_mutex);\r\nout:\r\nreturn single_release(inode, file);\r\n}\r\nint\r\nqla2x00_dfs_setup(scsi_qla_host_t *vha)\r\n{\r\nstruct qla_hw_data *ha = vha->hw;\r\nif (!IS_QLA25XX(ha) && !IS_QLA81XX(ha) && !IS_QLA83XX(ha) &&\r\n!IS_QLA27XX(ha))\r\ngoto out;\r\nif (!ha->fce)\r\ngoto out;\r\nif (qla2x00_dfs_root)\r\ngoto create_dir;\r\natomic_set(&qla2x00_dfs_root_count, 0);\r\nqla2x00_dfs_root = debugfs_create_dir(QLA2XXX_DRIVER_NAME, NULL);\r\nif (!qla2x00_dfs_root) {\r\nql_log(ql_log_warn, vha, 0x00f7,\r\n"Unable to create debugfs root directory.\n");\r\ngoto out;\r\n}\r\ncreate_dir:\r\nif (ha->dfs_dir)\r\ngoto create_nodes;\r\nmutex_init(&ha->fce_mutex);\r\nha->dfs_dir = debugfs_create_dir(vha->host_str, qla2x00_dfs_root);\r\nif (!ha->dfs_dir) {\r\nql_log(ql_log_warn, vha, 0x00f8,\r\n"Unable to create debugfs ha directory.\n");\r\ngoto out;\r\n}\r\natomic_inc(&qla2x00_dfs_root_count);\r\ncreate_nodes:\r\nha->dfs_fw_resource_cnt = debugfs_create_file("fw_resource_count",\r\nS_IRUSR, ha->dfs_dir, vha, &dfs_fw_resource_cnt_ops);\r\nif (!ha->dfs_fw_resource_cnt) {\r\nql_log(ql_log_warn, vha, 0x00fd,\r\n"Unable to create debugFS fw_resource_count node.\n");\r\ngoto out;\r\n}\r\nha->dfs_tgt_counters = debugfs_create_file("tgt_counters", S_IRUSR,\r\nha->dfs_dir, vha, &dfs_tgt_counters_ops);\r\nif (!ha->dfs_tgt_counters) {\r\nql_log(ql_log_warn, vha, 0xd301,\r\n"Unable to create debugFS tgt_counters node.\n");\r\ngoto out;\r\n}\r\nha->dfs_fce = debugfs_create_file("fce", S_IRUSR, ha->dfs_dir, vha,\r\n&dfs_fce_ops);\r\nif (!ha->dfs_fce) {\r\nql_log(ql_log_warn, vha, 0x00f9,\r\n"Unable to create debugfs fce node.\n");\r\ngoto out;\r\n}\r\nha->tgt.dfs_tgt_sess = debugfs_create_file("tgt_sess",\r\nS_IRUSR, ha->dfs_dir, vha, &dfs_tgt_sess_ops);\r\nif (!ha->tgt.dfs_tgt_sess) {\r\nql_log(ql_log_warn, vha, 0xffff,\r\n"Unable to create debugFS tgt_sess node.\n");\r\ngoto out;\r\n}\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nqla2x00_dfs_remove(scsi_qla_host_t *vha)\r\n{\r\nstruct qla_hw_data *ha = vha->hw;\r\nif (ha->tgt.dfs_tgt_sess) {\r\ndebugfs_remove(ha->tgt.dfs_tgt_sess);\r\nha->tgt.dfs_tgt_sess = NULL;\r\n}\r\nif (ha->dfs_fw_resource_cnt) {\r\ndebugfs_remove(ha->dfs_fw_resource_cnt);\r\nha->dfs_fw_resource_cnt = NULL;\r\n}\r\nif (ha->dfs_tgt_counters) {\r\ndebugfs_remove(ha->dfs_tgt_counters);\r\nha->dfs_tgt_counters = NULL;\r\n}\r\nif (ha->dfs_fce) {\r\ndebugfs_remove(ha->dfs_fce);\r\nha->dfs_fce = NULL;\r\n}\r\nif (ha->dfs_dir) {\r\ndebugfs_remove(ha->dfs_dir);\r\nha->dfs_dir = NULL;\r\natomic_dec(&qla2x00_dfs_root_count);\r\n}\r\nif (atomic_read(&qla2x00_dfs_root_count) == 0 &&\r\nqla2x00_dfs_root) {\r\ndebugfs_remove(qla2x00_dfs_root);\r\nqla2x00_dfs_root = NULL;\r\n}\r\nreturn 0;\r\n}

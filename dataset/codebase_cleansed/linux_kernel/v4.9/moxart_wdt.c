static int moxart_wdt_restart(struct watchdog_device *wdt_dev,\r\nunsigned long action, void *data)\r\n{\r\nstruct moxart_wdt_dev *moxart_wdt = watchdog_get_drvdata(wdt_dev);\r\nwritel(1, moxart_wdt->base + REG_COUNT);\r\nwritel(0x5ab9, moxart_wdt->base + REG_MODE);\r\nwritel(0x03, moxart_wdt->base + REG_ENABLE);\r\nreturn 0;\r\n}\r\nstatic int moxart_wdt_stop(struct watchdog_device *wdt_dev)\r\n{\r\nstruct moxart_wdt_dev *moxart_wdt = watchdog_get_drvdata(wdt_dev);\r\nwritel(0, moxart_wdt->base + REG_ENABLE);\r\nreturn 0;\r\n}\r\nstatic int moxart_wdt_start(struct watchdog_device *wdt_dev)\r\n{\r\nstruct moxart_wdt_dev *moxart_wdt = watchdog_get_drvdata(wdt_dev);\r\nwritel(moxart_wdt->clock_frequency * wdt_dev->timeout,\r\nmoxart_wdt->base + REG_COUNT);\r\nwritel(0x5ab9, moxart_wdt->base + REG_MODE);\r\nwritel(0x03, moxart_wdt->base + REG_ENABLE);\r\nreturn 0;\r\n}\r\nstatic int moxart_wdt_set_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int timeout)\r\n{\r\nwdt_dev->timeout = timeout;\r\nreturn 0;\r\n}\r\nstatic int moxart_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct moxart_wdt_dev *moxart_wdt;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *node = dev->of_node;\r\nstruct resource *res;\r\nstruct clk *clk;\r\nint err;\r\nunsigned int max_timeout;\r\nbool nowayout = WATCHDOG_NOWAYOUT;\r\nmoxart_wdt = devm_kzalloc(dev, sizeof(*moxart_wdt), GFP_KERNEL);\r\nif (!moxart_wdt)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, moxart_wdt);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nmoxart_wdt->base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(moxart_wdt->base))\r\nreturn PTR_ERR(moxart_wdt->base);\r\nclk = of_clk_get(node, 0);\r\nif (IS_ERR(clk)) {\r\npr_err("%s: of_clk_get failed\n", __func__);\r\nreturn PTR_ERR(clk);\r\n}\r\nmoxart_wdt->clock_frequency = clk_get_rate(clk);\r\nif (moxart_wdt->clock_frequency == 0) {\r\npr_err("%s: incorrect clock frequency\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nmax_timeout = UINT_MAX / moxart_wdt->clock_frequency;\r\nmoxart_wdt->dev.info = &moxart_wdt_info;\r\nmoxart_wdt->dev.ops = &moxart_wdt_ops;\r\nmoxart_wdt->dev.timeout = max_timeout;\r\nmoxart_wdt->dev.min_timeout = 1;\r\nmoxart_wdt->dev.max_timeout = max_timeout;\r\nmoxart_wdt->dev.parent = dev;\r\nwatchdog_init_timeout(&moxart_wdt->dev, heartbeat, dev);\r\nwatchdog_set_nowayout(&moxart_wdt->dev, nowayout);\r\nwatchdog_set_restart_priority(&moxart_wdt->dev, 128);\r\nwatchdog_set_drvdata(&moxart_wdt->dev, moxart_wdt);\r\nerr = watchdog_register_device(&moxart_wdt->dev);\r\nif (err)\r\nreturn err;\r\ndev_dbg(dev, "Watchdog enabled (heartbeat=%d sec, nowayout=%d)\n",\r\nmoxart_wdt->dev.timeout, nowayout);\r\nreturn 0;\r\n}\r\nstatic int moxart_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct moxart_wdt_dev *moxart_wdt = platform_get_drvdata(pdev);\r\nmoxart_wdt_stop(&moxart_wdt->dev);\r\nreturn 0;\r\n}

static irqreturn_t acpi_ged_irq_handler(int irq, void *data)\r\n{\r\nstruct acpi_ged_event *event = data;\r\nacpi_status acpi_ret;\r\nacpi_ret = acpi_execute_simple_method(event->handle, NULL, event->gsi);\r\nif (ACPI_FAILURE(acpi_ret))\r\ndev_err_once(event->dev, "IRQ method execution failed\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic acpi_status acpi_ged_request_interrupt(struct acpi_resource *ares,\r\nvoid *context)\r\n{\r\nstruct acpi_ged_event *event;\r\nunsigned int irq;\r\nunsigned int gsi;\r\nunsigned int irqflags = IRQF_ONESHOT;\r\nstruct device *dev = context;\r\nacpi_handle handle = ACPI_HANDLE(dev);\r\nacpi_handle evt_handle;\r\nstruct resource r;\r\nstruct acpi_resource_irq *p = &ares->data.irq;\r\nstruct acpi_resource_extended_irq *pext = &ares->data.extended_irq;\r\nif (ares->type == ACPI_RESOURCE_TYPE_END_TAG)\r\nreturn AE_OK;\r\nif (!acpi_dev_resource_interrupt(ares, 0, &r)) {\r\ndev_err(dev, "unable to parse IRQ resource\n");\r\nreturn AE_ERROR;\r\n}\r\nif (ares->type == ACPI_RESOURCE_TYPE_IRQ)\r\ngsi = p->interrupts[0];\r\nelse\r\ngsi = pext->interrupts[0];\r\nirq = r.start;\r\nif (ACPI_FAILURE(acpi_get_handle(handle, "_EVT", &evt_handle))) {\r\ndev_err(dev, "cannot locate _EVT method\n");\r\nreturn AE_ERROR;\r\n}\r\ndev_info(dev, "GED listening GSI %u @ IRQ %u\n", gsi, irq);\r\nevent = devm_kzalloc(dev, sizeof(*event), GFP_KERNEL);\r\nif (!event)\r\nreturn AE_ERROR;\r\nevent->gsi = gsi;\r\nevent->dev = dev;\r\nevent->irq = irq;\r\nevent->handle = evt_handle;\r\nif (r.flags & IORESOURCE_IRQ_SHAREABLE)\r\nirqflags |= IRQF_SHARED;\r\nif (devm_request_threaded_irq(dev, irq, NULL, acpi_ged_irq_handler,\r\nirqflags, "ACPI:Ged", event)) {\r\ndev_err(dev, "failed to setup event handler for irq %u\n", irq);\r\nreturn AE_ERROR;\r\n}\r\nreturn AE_OK;\r\n}\r\nstatic int ged_probe(struct platform_device *pdev)\r\n{\r\nacpi_status acpi_ret;\r\nacpi_ret = acpi_walk_resources(ACPI_HANDLE(&pdev->dev), "_CRS",\r\nacpi_ged_request_interrupt, &pdev->dev);\r\nif (ACPI_FAILURE(acpi_ret)) {\r\ndev_err(&pdev->dev, "unable to parse the _CRS record\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}

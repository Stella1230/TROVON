static int rds_loop_xmit(struct rds_connection *conn, struct rds_message *rm,\r\nunsigned int hdr_off, unsigned int sg,\r\nunsigned int off)\r\n{\r\nstruct scatterlist *sgp = &rm->data.op_sg[sg];\r\nint ret = sizeof(struct rds_header) +\r\nbe32_to_cpu(rm->m_inc.i_hdr.h_len);\r\nif (rm->m_inc.i_hdr.h_flags & RDS_FLAG_CONG_BITMAP) {\r\nrds_cong_map_updated(conn->c_fcong, ~(u64) 0);\r\nret = min_t(int, ret, sgp->length - conn->c_xmit_data_off);\r\ngoto out;\r\n}\r\nBUG_ON(hdr_off || sg || off);\r\nrds_inc_init(&rm->m_inc, conn, conn->c_laddr);\r\nrds_message_addref(rm);\r\nrds_recv_incoming(conn, conn->c_laddr, conn->c_faddr, &rm->m_inc,\r\nGFP_KERNEL);\r\nrds_send_drop_acked(conn, be64_to_cpu(rm->m_inc.i_hdr.h_sequence),\r\nNULL);\r\nrds_inc_put(&rm->m_inc);\r\nout:\r\nreturn ret;\r\n}\r\nstatic void rds_loop_inc_free(struct rds_incoming *inc)\r\n{\r\nstruct rds_message *rm = container_of(inc, struct rds_message, m_inc);\r\nrds_message_put(rm);\r\n}\r\nstatic int rds_loop_recv_path(struct rds_conn_path *cp)\r\n{\r\nreturn 0;\r\n}\r\nstatic int rds_loop_conn_alloc(struct rds_connection *conn, gfp_t gfp)\r\n{\r\nstruct rds_loop_connection *lc;\r\nunsigned long flags;\r\nlc = kzalloc(sizeof(struct rds_loop_connection), gfp);\r\nif (!lc)\r\nreturn -ENOMEM;\r\nINIT_LIST_HEAD(&lc->loop_node);\r\nlc->conn = conn;\r\nconn->c_transport_data = lc;\r\nspin_lock_irqsave(&loop_conns_lock, flags);\r\nlist_add_tail(&lc->loop_node, &loop_conns);\r\nspin_unlock_irqrestore(&loop_conns_lock, flags);\r\nreturn 0;\r\n}\r\nstatic void rds_loop_conn_free(void *arg)\r\n{\r\nstruct rds_loop_connection *lc = arg;\r\nunsigned long flags;\r\nrdsdebug("lc %p\n", lc);\r\nspin_lock_irqsave(&loop_conns_lock, flags);\r\nlist_del(&lc->loop_node);\r\nspin_unlock_irqrestore(&loop_conns_lock, flags);\r\nkfree(lc);\r\n}\r\nstatic int rds_loop_conn_path_connect(struct rds_conn_path *cp)\r\n{\r\nrds_connect_complete(cp->cp_conn);\r\nreturn 0;\r\n}\r\nstatic void rds_loop_conn_path_shutdown(struct rds_conn_path *cp)\r\n{\r\n}\r\nvoid rds_loop_exit(void)\r\n{\r\nstruct rds_loop_connection *lc, *_lc;\r\nLIST_HEAD(tmp_list);\r\nspin_lock_irq(&loop_conns_lock);\r\nlist_splice(&loop_conns, &tmp_list);\r\nINIT_LIST_HEAD(&loop_conns);\r\nspin_unlock_irq(&loop_conns_lock);\r\nlist_for_each_entry_safe(lc, _lc, &tmp_list, loop_node) {\r\nWARN_ON(lc->conn->c_passive);\r\nrds_conn_destroy(lc->conn);\r\n}\r\n}

static int mlx5e_dcbnl_ieee_getets(struct net_device *netdev,\r\nstruct ieee_ets *ets)\r\n{\r\nstruct mlx5e_priv *priv = netdev_priv(netdev);\r\nif (!MLX5_CAP_GEN(priv->mdev, ets))\r\nreturn -ENOTSUPP;\r\nmemcpy(ets, &priv->params.ets, sizeof(*ets));\r\nreturn 0;\r\n}\r\nstatic void mlx5e_build_tc_group(struct ieee_ets *ets, u8 *tc_group, int max_tc)\r\n{\r\nbool any_tc_mapped_to_ets = false;\r\nint strict_group;\r\nint i;\r\nfor (i = 0; i <= max_tc; i++)\r\nif (ets->tc_tsa[i] == IEEE_8021QAZ_TSA_ETS)\r\nany_tc_mapped_to_ets = true;\r\nstrict_group = any_tc_mapped_to_ets ? 1 : 0;\r\nfor (i = 0; i <= max_tc; i++) {\r\nswitch (ets->tc_tsa[i]) {\r\ncase IEEE_8021QAZ_TSA_VENDOR:\r\ntc_group[i] = MLX5E_VENDOR_TC_GROUP_NUM;\r\nbreak;\r\ncase IEEE_8021QAZ_TSA_STRICT:\r\ntc_group[i] = strict_group++;\r\nbreak;\r\ncase IEEE_8021QAZ_TSA_ETS:\r\ntc_group[i] = MLX5E_ETS_TC_GROUP_NUM;\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void mlx5e_build_tc_tx_bw(struct ieee_ets *ets, u8 *tc_tx_bw,\r\nu8 *tc_group, int max_tc)\r\n{\r\nint i;\r\nfor (i = 0; i <= max_tc; i++) {\r\nswitch (ets->tc_tsa[i]) {\r\ncase IEEE_8021QAZ_TSA_VENDOR:\r\ntc_tx_bw[i] = MLX5E_MAX_BW_ALLOC;\r\nbreak;\r\ncase IEEE_8021QAZ_TSA_STRICT:\r\ntc_tx_bw[i] = MLX5E_MAX_BW_ALLOC;\r\nbreak;\r\ncase IEEE_8021QAZ_TSA_ETS:\r\ntc_tx_bw[i] = ets->tc_tx_bw[i];\r\nbreak;\r\n}\r\n}\r\n}\r\nint mlx5e_dcbnl_ieee_setets_core(struct mlx5e_priv *priv, struct ieee_ets *ets)\r\n{\r\nstruct mlx5_core_dev *mdev = priv->mdev;\r\nu8 tc_tx_bw[IEEE_8021QAZ_MAX_TCS];\r\nu8 tc_group[IEEE_8021QAZ_MAX_TCS];\r\nint max_tc = mlx5_max_tc(mdev);\r\nint err;\r\nif (!MLX5_CAP_GEN(mdev, ets))\r\nreturn -ENOTSUPP;\r\nmlx5e_build_tc_group(ets, tc_group, max_tc);\r\nmlx5e_build_tc_tx_bw(ets, tc_tx_bw, tc_group, max_tc);\r\nerr = mlx5_set_port_prio_tc(mdev, ets->prio_tc);\r\nif (err)\r\nreturn err;\r\nerr = mlx5_set_port_tc_group(mdev, tc_group);\r\nif (err)\r\nreturn err;\r\nreturn mlx5_set_port_tc_bw_alloc(mdev, tc_tx_bw);\r\n}\r\nstatic int mlx5e_dbcnl_validate_ets(struct net_device *netdev,\r\nstruct ieee_ets *ets)\r\n{\r\nint bw_sum = 0;\r\nint i;\r\nfor (i = 0; i < IEEE_8021QAZ_MAX_TCS; i++) {\r\nif (ets->prio_tc[i] >= MLX5E_MAX_PRIORITY) {\r\nnetdev_err(netdev,\r\n"Failed to validate ETS: priority value greater than max(%d)\n",\r\nMLX5E_MAX_PRIORITY);\r\nreturn -EINVAL;\r\n}\r\n}\r\nfor (i = 0; i < IEEE_8021QAZ_MAX_TCS; i++) {\r\nif (ets->tc_tsa[i] == IEEE_8021QAZ_TSA_ETS) {\r\nif (!ets->tc_tx_bw[i]) {\r\nnetdev_err(netdev,\r\n"Failed to validate ETS: BW 0 is illegal\n");\r\nreturn -EINVAL;\r\n}\r\nbw_sum += ets->tc_tx_bw[i];\r\n}\r\n}\r\nif (bw_sum != 0 && bw_sum != 100) {\r\nnetdev_err(netdev,\r\n"Failed to validate ETS: BW sum is illegal\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mlx5e_dcbnl_ieee_setets(struct net_device *netdev,\r\nstruct ieee_ets *ets)\r\n{\r\nstruct mlx5e_priv *priv = netdev_priv(netdev);\r\nint err;\r\nerr = mlx5e_dbcnl_validate_ets(netdev, ets);\r\nif (err)\r\nreturn err;\r\nerr = mlx5e_dcbnl_ieee_setets_core(priv, ets);\r\nif (err)\r\nreturn err;\r\nmemcpy(&priv->params.ets, ets, sizeof(*ets));\r\npriv->params.ets.ets_cap = mlx5_max_tc(priv->mdev) + 1;\r\nreturn 0;\r\n}\r\nstatic int mlx5e_dcbnl_ieee_getpfc(struct net_device *dev,\r\nstruct ieee_pfc *pfc)\r\n{\r\nstruct mlx5e_priv *priv = netdev_priv(dev);\r\nstruct mlx5_core_dev *mdev = priv->mdev;\r\nstruct mlx5e_pport_stats *pstats = &priv->stats.pport;\r\nint i;\r\npfc->pfc_cap = mlx5_max_tc(mdev) + 1;\r\nfor (i = 0; i < IEEE_8021QAZ_MAX_TCS; i++) {\r\npfc->requests[i] = PPORT_PER_PRIO_GET(pstats, i, tx_pause);\r\npfc->indications[i] = PPORT_PER_PRIO_GET(pstats, i, rx_pause);\r\n}\r\nreturn mlx5_query_port_pfc(mdev, &pfc->pfc_en, NULL);\r\n}\r\nstatic int mlx5e_dcbnl_ieee_setpfc(struct net_device *dev,\r\nstruct ieee_pfc *pfc)\r\n{\r\nstruct mlx5e_priv *priv = netdev_priv(dev);\r\nstruct mlx5_core_dev *mdev = priv->mdev;\r\nu8 curr_pfc_en;\r\nint ret;\r\nmlx5_query_port_pfc(mdev, &curr_pfc_en, NULL);\r\nif (pfc->pfc_en == curr_pfc_en)\r\nreturn 0;\r\nret = mlx5_set_port_pfc(mdev, pfc->pfc_en, pfc->pfc_en);\r\nmlx5_toggle_port_link(mdev);\r\nreturn ret;\r\n}\r\nstatic u8 mlx5e_dcbnl_getdcbx(struct net_device *dev)\r\n{\r\nreturn DCB_CAP_DCBX_HOST | DCB_CAP_DCBX_VER_IEEE;\r\n}\r\nstatic u8 mlx5e_dcbnl_setdcbx(struct net_device *dev, u8 mode)\r\n{\r\nif ((mode & DCB_CAP_DCBX_LLD_MANAGED) ||\r\n(mode & DCB_CAP_DCBX_VER_CEE) ||\r\n!(mode & DCB_CAP_DCBX_VER_IEEE) ||\r\n!(mode & DCB_CAP_DCBX_HOST))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int mlx5e_dcbnl_ieee_getmaxrate(struct net_device *netdev,\r\nstruct ieee_maxrate *maxrate)\r\n{\r\nstruct mlx5e_priv *priv = netdev_priv(netdev);\r\nstruct mlx5_core_dev *mdev = priv->mdev;\r\nu8 max_bw_value[IEEE_8021QAZ_MAX_TCS];\r\nu8 max_bw_unit[IEEE_8021QAZ_MAX_TCS];\r\nint err;\r\nint i;\r\nerr = mlx5_query_port_ets_rate_limit(mdev, max_bw_value, max_bw_unit);\r\nif (err)\r\nreturn err;\r\nmemset(maxrate->tc_maxrate, 0, sizeof(maxrate->tc_maxrate));\r\nfor (i = 0; i <= mlx5_max_tc(mdev); i++) {\r\nswitch (max_bw_unit[i]) {\r\ncase MLX5_100_MBPS_UNIT:\r\nmaxrate->tc_maxrate[i] = max_bw_value[i] * MLX5E_100MB;\r\nbreak;\r\ncase MLX5_GBPS_UNIT:\r\nmaxrate->tc_maxrate[i] = max_bw_value[i] * MLX5E_1GB;\r\nbreak;\r\ncase MLX5_BW_NO_LIMIT:\r\nbreak;\r\ndefault:\r\nWARN(true, "non-supported BW unit");\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int mlx5e_dcbnl_ieee_setmaxrate(struct net_device *netdev,\r\nstruct ieee_maxrate *maxrate)\r\n{\r\nstruct mlx5e_priv *priv = netdev_priv(netdev);\r\nstruct mlx5_core_dev *mdev = priv->mdev;\r\nu8 max_bw_value[IEEE_8021QAZ_MAX_TCS];\r\nu8 max_bw_unit[IEEE_8021QAZ_MAX_TCS];\r\n__u64 upper_limit_mbps = roundup(255 * MLX5E_100MB, MLX5E_1GB);\r\nint i;\r\nmemset(max_bw_value, 0, sizeof(max_bw_value));\r\nmemset(max_bw_unit, 0, sizeof(max_bw_unit));\r\nfor (i = 0; i <= mlx5_max_tc(mdev); i++) {\r\nif (!maxrate->tc_maxrate[i]) {\r\nmax_bw_unit[i] = MLX5_BW_NO_LIMIT;\r\ncontinue;\r\n}\r\nif (maxrate->tc_maxrate[i] < upper_limit_mbps) {\r\nmax_bw_value[i] = div_u64(maxrate->tc_maxrate[i],\r\nMLX5E_100MB);\r\nmax_bw_value[i] = max_bw_value[i] ? max_bw_value[i] : 1;\r\nmax_bw_unit[i] = MLX5_100_MBPS_UNIT;\r\n} else {\r\nmax_bw_value[i] = div_u64(maxrate->tc_maxrate[i],\r\nMLX5E_1GB);\r\nmax_bw_unit[i] = MLX5_GBPS_UNIT;\r\n}\r\n}\r\nreturn mlx5_modify_port_ets_rate_limit(mdev, max_bw_value, max_bw_unit);\r\n}

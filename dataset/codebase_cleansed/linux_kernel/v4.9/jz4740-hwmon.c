static irqreturn_t jz4740_hwmon_irq(int irq, void *data)\r\n{\r\nstruct jz4740_hwmon *hwmon = data;\r\ncomplete(&hwmon->read_completion);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic ssize_t jz4740_hwmon_read_adcin(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buf)\r\n{\r\nstruct jz4740_hwmon *hwmon = dev_get_drvdata(dev);\r\nstruct platform_device *pdev = hwmon->pdev;\r\nstruct completion *completion = &hwmon->read_completion;\r\nlong t;\r\nunsigned long val;\r\nint ret;\r\nmutex_lock(&hwmon->lock);\r\nreinit_completion(completion);\r\nenable_irq(hwmon->irq);\r\nhwmon->cell->enable(pdev);\r\nt = wait_for_completion_interruptible_timeout(completion, HZ);\r\nif (t > 0) {\r\nval = readw(hwmon->base) & 0xfff;\r\nval = (val * 3300) >> 12;\r\nret = sprintf(buf, "%lu\n", val);\r\n} else {\r\nret = t ? t : -ETIMEDOUT;\r\n}\r\nhwmon->cell->disable(pdev);\r\ndisable_irq(hwmon->irq);\r\nmutex_unlock(&hwmon->lock);\r\nreturn ret;\r\n}\r\nstatic int jz4740_hwmon_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct device *dev = &pdev->dev;\r\nstruct jz4740_hwmon *hwmon;\r\nstruct device *hwmon_dev;\r\nstruct resource *mem;\r\nhwmon = devm_kzalloc(dev, sizeof(*hwmon), GFP_KERNEL);\r\nif (!hwmon)\r\nreturn -ENOMEM;\r\nhwmon->cell = mfd_get_cell(pdev);\r\nhwmon->irq = platform_get_irq(pdev, 0);\r\nif (hwmon->irq < 0) {\r\ndev_err(&pdev->dev, "Failed to get platform irq: %d\n",\r\nhwmon->irq);\r\nreturn hwmon->irq;\r\n}\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nhwmon->base = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(hwmon->base))\r\nreturn PTR_ERR(hwmon->base);\r\nhwmon->pdev = pdev;\r\ninit_completion(&hwmon->read_completion);\r\nmutex_init(&hwmon->lock);\r\nret = devm_request_irq(dev, hwmon->irq, jz4740_hwmon_irq, 0,\r\npdev->name, hwmon);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to request irq: %d\n", ret);\r\nreturn ret;\r\n}\r\ndisable_irq(hwmon->irq);\r\nhwmon_dev = devm_hwmon_device_register_with_groups(dev, "jz4740", hwmon,\r\njz4740_groups);\r\nreturn PTR_ERR_OR_ZERO(hwmon_dev);\r\n}

int ssb_watchdog_timer_set(struct ssb_bus *bus, u32 ticks)\r\n{\r\nif (ssb_chipco_available(&bus->chipco)) {\r\nssb_chipco_watchdog_timer_set(&bus->chipco, ticks);\r\nreturn 0;\r\n}\r\nif (ssb_extif_available(&bus->extif)) {\r\nssb_extif_watchdog_timer_set(&bus->extif, ticks);\r\nreturn 0;\r\n}\r\nreturn -ENODEV;\r\n}\r\nint ssb_watchdog_register(struct ssb_bus *bus)\r\n{\r\nstruct bcm47xx_wdt wdt = {};\r\nstruct platform_device *pdev;\r\nif (ssb_chipco_available(&bus->chipco)) {\r\nwdt.driver_data = &bus->chipco;\r\nwdt.timer_set = ssb_chipco_watchdog_timer_set_wdt;\r\nwdt.timer_set_ms = ssb_chipco_watchdog_timer_set_ms;\r\nwdt.max_timer_ms = bus->chipco.max_timer_ms;\r\n} else if (ssb_extif_available(&bus->extif)) {\r\nwdt.driver_data = &bus->extif;\r\nwdt.timer_set = ssb_extif_watchdog_timer_set_wdt;\r\nwdt.timer_set_ms = ssb_extif_watchdog_timer_set_ms;\r\nwdt.max_timer_ms = SSB_EXTIF_WATCHDOG_MAX_TIMER_MS;\r\n} else {\r\nreturn -ENODEV;\r\n}\r\npdev = platform_device_register_data(NULL, "bcm47xx-wdt",\r\nbus->busnumber, &wdt,\r\nsizeof(wdt));\r\nif (IS_ERR(pdev)) {\r\nssb_dbg("can not register watchdog device, err: %li\n",\r\nPTR_ERR(pdev));\r\nreturn PTR_ERR(pdev);\r\n}\r\nbus->watchdog = pdev;\r\nreturn 0;\r\n}\r\nu32 ssb_gpio_in(struct ssb_bus *bus, u32 mask)\r\n{\r\nunsigned long flags;\r\nu32 res = 0;\r\nspin_lock_irqsave(&bus->gpio_lock, flags);\r\nif (ssb_chipco_available(&bus->chipco))\r\nres = ssb_chipco_gpio_in(&bus->chipco, mask);\r\nelse if (ssb_extif_available(&bus->extif))\r\nres = ssb_extif_gpio_in(&bus->extif, mask);\r\nelse\r\nSSB_WARN_ON(1);\r\nspin_unlock_irqrestore(&bus->gpio_lock, flags);\r\nreturn res;\r\n}\r\nu32 ssb_gpio_out(struct ssb_bus *bus, u32 mask, u32 value)\r\n{\r\nunsigned long flags;\r\nu32 res = 0;\r\nspin_lock_irqsave(&bus->gpio_lock, flags);\r\nif (ssb_chipco_available(&bus->chipco))\r\nres = ssb_chipco_gpio_out(&bus->chipco, mask, value);\r\nelse if (ssb_extif_available(&bus->extif))\r\nres = ssb_extif_gpio_out(&bus->extif, mask, value);\r\nelse\r\nSSB_WARN_ON(1);\r\nspin_unlock_irqrestore(&bus->gpio_lock, flags);\r\nreturn res;\r\n}\r\nu32 ssb_gpio_outen(struct ssb_bus *bus, u32 mask, u32 value)\r\n{\r\nunsigned long flags;\r\nu32 res = 0;\r\nspin_lock_irqsave(&bus->gpio_lock, flags);\r\nif (ssb_chipco_available(&bus->chipco))\r\nres = ssb_chipco_gpio_outen(&bus->chipco, mask, value);\r\nelse if (ssb_extif_available(&bus->extif))\r\nres = ssb_extif_gpio_outen(&bus->extif, mask, value);\r\nelse\r\nSSB_WARN_ON(1);\r\nspin_unlock_irqrestore(&bus->gpio_lock, flags);\r\nreturn res;\r\n}\r\nu32 ssb_gpio_control(struct ssb_bus *bus, u32 mask, u32 value)\r\n{\r\nunsigned long flags;\r\nu32 res = 0;\r\nspin_lock_irqsave(&bus->gpio_lock, flags);\r\nif (ssb_chipco_available(&bus->chipco))\r\nres = ssb_chipco_gpio_control(&bus->chipco, mask, value);\r\nspin_unlock_irqrestore(&bus->gpio_lock, flags);\r\nreturn res;\r\n}\r\nu32 ssb_gpio_intmask(struct ssb_bus *bus, u32 mask, u32 value)\r\n{\r\nunsigned long flags;\r\nu32 res = 0;\r\nspin_lock_irqsave(&bus->gpio_lock, flags);\r\nif (ssb_chipco_available(&bus->chipco))\r\nres = ssb_chipco_gpio_intmask(&bus->chipco, mask, value);\r\nelse if (ssb_extif_available(&bus->extif))\r\nres = ssb_extif_gpio_intmask(&bus->extif, mask, value);\r\nelse\r\nSSB_WARN_ON(1);\r\nspin_unlock_irqrestore(&bus->gpio_lock, flags);\r\nreturn res;\r\n}\r\nu32 ssb_gpio_polarity(struct ssb_bus *bus, u32 mask, u32 value)\r\n{\r\nunsigned long flags;\r\nu32 res = 0;\r\nspin_lock_irqsave(&bus->gpio_lock, flags);\r\nif (ssb_chipco_available(&bus->chipco))\r\nres = ssb_chipco_gpio_polarity(&bus->chipco, mask, value);\r\nelse if (ssb_extif_available(&bus->extif))\r\nres = ssb_extif_gpio_polarity(&bus->extif, mask, value);\r\nelse\r\nSSB_WARN_ON(1);\r\nspin_unlock_irqrestore(&bus->gpio_lock, flags);\r\nreturn res;\r\n}\r\nstatic int gige_pci_init_callback(struct ssb_bus *bus, unsigned long data)\r\n{\r\nstruct pci_dev *pdev = (struct pci_dev *)data;\r\nstruct ssb_device *dev;\r\nunsigned int i;\r\nint res;\r\nfor (i = 0; i < bus->nr_devices; i++) {\r\ndev = &(bus->devices[i]);\r\nif (dev->id.coreid != SSB_DEV_ETHERNET_GBIT)\r\ncontinue;\r\nif (!dev->dev ||\r\n!dev->dev->driver ||\r\n!device_is_registered(dev->dev))\r\ncontinue;\r\nres = ssb_gige_pcibios_plat_dev_init(dev, pdev);\r\nif (res >= 0)\r\nreturn res;\r\n}\r\nreturn -ENODEV;\r\n}\r\nint ssb_pcibios_plat_dev_init(struct pci_dev *dev)\r\n{\r\nint err;\r\nerr = ssb_pcicore_plat_dev_init(dev);\r\nif (!err)\r\nreturn 0;\r\n#ifdef CONFIG_SSB_DRIVER_GIGE\r\nerr = ssb_for_each_bus_call((unsigned long)dev, gige_pci_init_callback);\r\nif (err >= 0)\r\nreturn err;\r\n#endif\r\nreturn -ENODEV;\r\n}\r\nstatic int gige_map_irq_callback(struct ssb_bus *bus, unsigned long data)\r\n{\r\nconst struct pci_dev *pdev = (const struct pci_dev *)data;\r\nstruct ssb_device *dev;\r\nunsigned int i;\r\nint res;\r\nfor (i = 0; i < bus->nr_devices; i++) {\r\ndev = &(bus->devices[i]);\r\nif (dev->id.coreid != SSB_DEV_ETHERNET_GBIT)\r\ncontinue;\r\nif (!dev->dev ||\r\n!dev->dev->driver ||\r\n!device_is_registered(dev->dev))\r\ncontinue;\r\nres = ssb_gige_map_irq(dev, pdev);\r\nif (res >= 0)\r\nreturn res;\r\n}\r\nreturn -ENODEV;\r\n}\r\nint ssb_pcibios_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nint res;\r\nres = ssb_pcicore_pcibios_map_irq(dev, slot, pin);\r\nif (res >= 0)\r\nreturn res;\r\n#ifdef CONFIG_SSB_DRIVER_GIGE\r\nres = ssb_for_each_bus_call((unsigned long)dev, gige_map_irq_callback);\r\nif (res >= 0)\r\nreturn res;\r\n#endif\r\nreturn -ENODEV;\r\n}

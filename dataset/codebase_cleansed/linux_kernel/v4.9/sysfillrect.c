static void\r\nbitfill_aligned(struct fb_info *p, unsigned long *dst, int dst_idx,\r\nunsigned long pat, unsigned n, int bits)\r\n{\r\nunsigned long first, last;\r\nif (!n)\r\nreturn;\r\nfirst = FB_SHIFT_HIGH(p, ~0UL, dst_idx);\r\nlast = ~(FB_SHIFT_HIGH(p, ~0UL, (dst_idx+n) % bits));\r\nif (dst_idx+n <= bits) {\r\nif (last)\r\nfirst &= last;\r\n*dst = comp(pat, *dst, first);\r\n} else {\r\nif (first!= ~0UL) {\r\n*dst = comp(pat, *dst, first);\r\ndst++;\r\nn -= bits - dst_idx;\r\n}\r\nn /= bits;\r\nwhile (n >= 8) {\r\n*dst++ = pat;\r\n*dst++ = pat;\r\n*dst++ = pat;\r\n*dst++ = pat;\r\n*dst++ = pat;\r\n*dst++ = pat;\r\n*dst++ = pat;\r\n*dst++ = pat;\r\nn -= 8;\r\n}\r\nwhile (n--)\r\n*dst++ = pat;\r\nif (last)\r\n*dst = comp(pat, *dst, last);\r\n}\r\n}\r\nstatic void\r\nbitfill_unaligned(struct fb_info *p, unsigned long *dst, int dst_idx,\r\nunsigned long pat, int left, int right, unsigned n, int bits)\r\n{\r\nunsigned long first, last;\r\nif (!n)\r\nreturn;\r\nfirst = FB_SHIFT_HIGH(p, ~0UL, dst_idx);\r\nlast = ~(FB_SHIFT_HIGH(p, ~0UL, (dst_idx+n) % bits));\r\nif (dst_idx+n <= bits) {\r\nif (last)\r\nfirst &= last;\r\n*dst = comp(pat, *dst, first);\r\n} else {\r\nif (first) {\r\n*dst = comp(pat, *dst, first);\r\ndst++;\r\npat = pat << left | pat >> right;\r\nn -= bits - dst_idx;\r\n}\r\nn /= bits;\r\nwhile (n >= 4) {\r\n*dst++ = pat;\r\npat = pat << left | pat >> right;\r\n*dst++ = pat;\r\npat = pat << left | pat >> right;\r\n*dst++ = pat;\r\npat = pat << left | pat >> right;\r\n*dst++ = pat;\r\npat = pat << left | pat >> right;\r\nn -= 4;\r\n}\r\nwhile (n--) {\r\n*dst++ = pat;\r\npat = pat << left | pat >> right;\r\n}\r\nif (last)\r\n*dst = comp(pat, *dst, last);\r\n}\r\n}\r\nstatic void\r\nbitfill_aligned_rev(struct fb_info *p, unsigned long *dst, int dst_idx,\r\nunsigned long pat, unsigned n, int bits)\r\n{\r\nunsigned long val = pat;\r\nunsigned long first, last;\r\nif (!n)\r\nreturn;\r\nfirst = FB_SHIFT_HIGH(p, ~0UL, dst_idx);\r\nlast = ~(FB_SHIFT_HIGH(p, ~0UL, (dst_idx+n) % bits));\r\nif (dst_idx+n <= bits) {\r\nif (last)\r\nfirst &= last;\r\n*dst = comp(*dst ^ val, *dst, first);\r\n} else {\r\nif (first!=0UL) {\r\n*dst = comp(*dst ^ val, *dst, first);\r\ndst++;\r\nn -= bits - dst_idx;\r\n}\r\nn /= bits;\r\nwhile (n >= 8) {\r\n*dst++ ^= val;\r\n*dst++ ^= val;\r\n*dst++ ^= val;\r\n*dst++ ^= val;\r\n*dst++ ^= val;\r\n*dst++ ^= val;\r\n*dst++ ^= val;\r\n*dst++ ^= val;\r\nn -= 8;\r\n}\r\nwhile (n--)\r\n*dst++ ^= val;\r\nif (last)\r\n*dst = comp(*dst ^ val, *dst, last);\r\n}\r\n}\r\nstatic void\r\nbitfill_unaligned_rev(struct fb_info *p, unsigned long *dst, int dst_idx,\r\nunsigned long pat, int left, int right, unsigned n,\r\nint bits)\r\n{\r\nunsigned long first, last;\r\nif (!n)\r\nreturn;\r\nfirst = FB_SHIFT_HIGH(p, ~0UL, dst_idx);\r\nlast = ~(FB_SHIFT_HIGH(p, ~0UL, (dst_idx+n) % bits));\r\nif (dst_idx+n <= bits) {\r\nif (last)\r\nfirst &= last;\r\n*dst = comp(*dst ^ pat, *dst, first);\r\n} else {\r\nif (first != 0UL) {\r\n*dst = comp(*dst ^ pat, *dst, first);\r\ndst++;\r\npat = pat << left | pat >> right;\r\nn -= bits - dst_idx;\r\n}\r\nn /= bits;\r\nwhile (n >= 4) {\r\n*dst++ ^= pat;\r\npat = pat << left | pat >> right;\r\n*dst++ ^= pat;\r\npat = pat << left | pat >> right;\r\n*dst++ ^= pat;\r\npat = pat << left | pat >> right;\r\n*dst++ ^= pat;\r\npat = pat << left | pat >> right;\r\nn -= 4;\r\n}\r\nwhile (n--) {\r\n*dst ^= pat;\r\npat = pat << left | pat >> right;\r\n}\r\nif (last)\r\n*dst = comp(*dst ^ pat, *dst, last);\r\n}\r\n}\r\nvoid sys_fillrect(struct fb_info *p, const struct fb_fillrect *rect)\r\n{\r\nunsigned long pat, pat2, fg;\r\nunsigned long width = rect->width, height = rect->height;\r\nint bits = BITS_PER_LONG, bytes = bits >> 3;\r\nu32 bpp = p->var.bits_per_pixel;\r\nunsigned long *dst;\r\nint dst_idx, left;\r\nif (p->state != FBINFO_STATE_RUNNING)\r\nreturn;\r\nif (p->fix.visual == FB_VISUAL_TRUECOLOR ||\r\np->fix.visual == FB_VISUAL_DIRECTCOLOR )\r\nfg = ((u32 *) (p->pseudo_palette))[rect->color];\r\nelse\r\nfg = rect->color;\r\npat = pixel_to_pat( bpp, fg);\r\ndst = (unsigned long *)((unsigned long)p->screen_base & ~(bytes-1));\r\ndst_idx = ((unsigned long)p->screen_base & (bytes - 1))*8;\r\ndst_idx += rect->dy*p->fix.line_length*8+rect->dx*bpp;\r\nleft = bits % bpp;\r\nif (p->fbops->fb_sync)\r\np->fbops->fb_sync(p);\r\nif (!left) {\r\nvoid (*fill_op32)(struct fb_info *p, unsigned long *dst,\r\nint dst_idx, unsigned long pat, unsigned n,\r\nint bits) = NULL;\r\nswitch (rect->rop) {\r\ncase ROP_XOR:\r\nfill_op32 = bitfill_aligned_rev;\r\nbreak;\r\ncase ROP_COPY:\r\nfill_op32 = bitfill_aligned;\r\nbreak;\r\ndefault:\r\nprintk( KERN_ERR "cfb_fillrect(): unknown rop, "\r\n"defaulting to ROP_COPY\n");\r\nfill_op32 = bitfill_aligned;\r\nbreak;\r\n}\r\nwhile (height--) {\r\ndst += dst_idx >> (ffs(bits) - 1);\r\ndst_idx &= (bits - 1);\r\nfill_op32(p, dst, dst_idx, pat, width*bpp, bits);\r\ndst_idx += p->fix.line_length*8;\r\n}\r\n} else {\r\nint right, r;\r\nvoid (*fill_op)(struct fb_info *p, unsigned long *dst,\r\nint dst_idx, unsigned long pat, int left,\r\nint right, unsigned n, int bits) = NULL;\r\n#ifdef __LITTLE_ENDIAN\r\nright = left;\r\nleft = bpp - right;\r\n#else\r\nright = bpp - left;\r\n#endif\r\nswitch (rect->rop) {\r\ncase ROP_XOR:\r\nfill_op = bitfill_unaligned_rev;\r\nbreak;\r\ncase ROP_COPY:\r\nfill_op = bitfill_unaligned;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "sys_fillrect(): unknown rop, "\r\n"defaulting to ROP_COPY\n");\r\nfill_op = bitfill_unaligned;\r\nbreak;\r\n}\r\nwhile (height--) {\r\ndst += dst_idx / bits;\r\ndst_idx &= (bits - 1);\r\nr = dst_idx % bpp;\r\npat2 = le_long_to_cpu(rolx(cpu_to_le_long(pat), r, bpp));\r\nfill_op(p, dst, dst_idx, pat2, left, right,\r\nwidth*bpp, bits);\r\ndst_idx += p->fix.line_length*8;\r\n}\r\n}\r\n}

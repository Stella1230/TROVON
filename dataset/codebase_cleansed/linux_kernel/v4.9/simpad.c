long simpad_get_cs3_ro(void)\r\n{\r\nreturn readl(CS3_BASE);\r\n}\r\nlong simpad_get_cs3_shadow(void)\r\n{\r\nreturn cs3_shadow;\r\n}\r\nstatic void __simpad_write_cs3(void)\r\n{\r\nwritel(cs3_shadow, CS3_BASE);\r\n}\r\nvoid simpad_set_cs3_bit(int value)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&cs3_lock, flags);\r\ncs3_shadow |= value;\r\n__simpad_write_cs3();\r\nspin_unlock_irqrestore(&cs3_lock, flags);\r\n}\r\nvoid simpad_clear_cs3_bit(int value)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&cs3_lock, flags);\r\ncs3_shadow &= ~value;\r\n__simpad_write_cs3();\r\nspin_unlock_irqrestore(&cs3_lock, flags);\r\n}\r\nstatic void cs3_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nif (offset > 15)\r\nreturn;\r\nif (value)\r\nsimpad_set_cs3_bit(1 << offset);\r\nelse\r\nsimpad_clear_cs3_bit(1 << offset);\r\n}\r\nstatic int cs3_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nif (offset > 15)\r\nreturn !!(simpad_get_cs3_ro() & (1 << (offset - 16)));\r\nreturn !!(simpad_get_cs3_shadow() & (1 << offset));\r\n}\r\nstatic int cs3_gpio_direction_input(struct gpio_chip *chip, unsigned offset)\r\n{\r\nif (offset > 15)\r\nreturn 0;\r\nreturn -EINVAL;\r\n}\r\nstatic int cs3_gpio_direction_output(struct gpio_chip *chip, unsigned offset,\r\nint value)\r\n{\r\nif (offset > 15)\r\nreturn -EINVAL;\r\ncs3_gpio_set(chip, offset, value);\r\nreturn 0;\r\n}\r\nstatic void simpad_uart_pm(struct uart_port *port, u_int state, u_int oldstate)\r\n{\r\nif (port->mapbase == (u_int)&Ser1UTCR0) {\r\nif (state)\r\n{\r\nsimpad_clear_cs3_bit(RS232_ON);\r\nsimpad_clear_cs3_bit(DECT_POWER_ON);\r\n}else\r\n{\r\nsimpad_set_cs3_bit(RS232_ON);\r\nsimpad_set_cs3_bit(DECT_POWER_ON);\r\n}\r\n}\r\n}\r\nstatic void __init simpad_map_io(void)\r\n{\r\nsa1100_map_io();\r\niotable_init(simpad_io_desc, ARRAY_SIZE(simpad_io_desc));\r\ncs3_shadow = (EN1 | EN0 | LED2_ON | DISPLAY_ON |\r\nRS232_ON | ENABLE_5V | RESET_SIMCARD | DECT_POWER_ON);\r\n__simpad_write_cs3();\r\nsa1100_register_uart_fns(&simpad_port_fns);\r\nsa1100_register_uart(0, 3);\r\nsa1100_register_uart(1, 1);\r\nGAFR |= GPIO_UART_TXD | GPIO_UART_RXD;\r\nGPDR |= GPIO_UART_TXD | GPIO_LDD13 | GPIO_LDD15;\r\nGPDR &= ~GPIO_UART_RXD;\r\nPPAR |= PPAR_UPR;\r\nPWER = PWER_GPIO0| PWER_RTC;\r\nPGSR = 0x818;\r\nPCFR = 0;\r\nPSDR = 0;\r\n}\r\nstatic void simpad_power_off(void)\r\n{\r\nlocal_irq_disable();\r\ncs3_shadow = SD_MEDIAQ;\r\n__simpad_write_cs3();\r\nPCFR = (PCFR_OPDE | PCFR_FP | PCFR_FS);\r\nPWER = GFER = GRER = PWER_GPIO0;\r\nPSPR = 0;\r\nPGSR = 0;\r\nPMCR = PMCR_SF;\r\nwhile(1);\r\nlocal_irq_enable();\r\n}\r\nstatic int __init simpad_init(void)\r\n{\r\nint ret;\r\nspin_lock_init(&cs3_lock);\r\ncs3_gpio.label = "simpad_cs3";\r\ncs3_gpio.base = SIMPAD_CS3_GPIO_BASE;\r\ncs3_gpio.ngpio = 24;\r\ncs3_gpio.set = cs3_gpio_set;\r\ncs3_gpio.get = cs3_gpio_get;\r\ncs3_gpio.direction_input = cs3_gpio_direction_input;\r\ncs3_gpio.direction_output = cs3_gpio_direction_output;\r\nret = gpiochip_add_data(&cs3_gpio, NULL);\r\nif (ret)\r\nprintk(KERN_WARNING "simpad: Unable to register cs3 GPIO device");\r\npm_power_off = simpad_power_off;\r\nsa11x0_ppc_configure_mcp();\r\nsa11x0_register_mtd(&simpad_flash_data, simpad_flash_resources,\r\nARRAY_SIZE(simpad_flash_resources));\r\nsa11x0_register_mcp(&simpad_mcp_data);\r\nret = platform_add_devices(devices, ARRAY_SIZE(devices));\r\nif(ret)\r\nprintk(KERN_WARNING "simpad: Unable to register mq200 framebuffer device");\r\nreturn 0;\r\n}

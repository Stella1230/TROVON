static int nfs4_write_inode(struct inode *inode, struct writeback_control *wbc)\r\n{\r\nint ret = nfs_write_inode(inode, wbc);\r\nif (ret == 0)\r\nret = pnfs_layoutcommit_inode(inode,\r\nwbc->sync_mode == WB_SYNC_ALL);\r\nreturn ret;\r\n}\r\nstatic void nfs4_evict_inode(struct inode *inode)\r\n{\r\ntruncate_inode_pages_final(&inode->i_data);\r\nclear_inode(inode);\r\nnfs_inode_return_delegation_noreclaim(inode);\r\npnfs_return_layout(inode);\r\npnfs_destroy_layout(NFS_I(inode));\r\nnfs_clear_inode(inode);\r\n}\r\nstatic struct dentry *\r\nnfs4_remote_mount(struct file_system_type *fs_type, int flags,\r\nconst char *dev_name, void *info)\r\n{\r\nstruct nfs_mount_info *mount_info = info;\r\nstruct nfs_server *server;\r\nstruct dentry *mntroot = ERR_PTR(-ENOMEM);\r\nmount_info->set_security = nfs_set_sb_security;\r\nserver = nfs4_create_server(mount_info, &nfs_v4);\r\nif (IS_ERR(server)) {\r\nmntroot = ERR_CAST(server);\r\ngoto out;\r\n}\r\nmntroot = nfs_fs_mount_common(server, flags, dev_name, mount_info, &nfs_v4);\r\nout:\r\nreturn mntroot;\r\n}\r\nstatic struct vfsmount *nfs_do_root_mount(struct file_system_type *fs_type,\r\nint flags, void *data, const char *hostname)\r\n{\r\nstruct vfsmount *root_mnt;\r\nchar *root_devname;\r\nsize_t len;\r\nlen = strlen(hostname) + 5;\r\nroot_devname = kmalloc(len, GFP_KERNEL);\r\nif (root_devname == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nif (strchr(hostname, ':'))\r\nsnprintf(root_devname, len, "[%s]:/", hostname);\r\nelse\r\nsnprintf(root_devname, len, "%s:/", hostname);\r\nroot_mnt = vfs_kern_mount(fs_type, flags, root_devname, data);\r\nkfree(root_devname);\r\nreturn root_mnt;\r\n}\r\nstatic struct nfs_referral_count *nfs_find_referral_count(void)\r\n{\r\nstruct nfs_referral_count *p;\r\nlist_for_each_entry(p, &nfs_referral_count_list, list) {\r\nif (p->task == current)\r\nreturn p;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int nfs_referral_loop_protect(void)\r\n{\r\nstruct nfs_referral_count *p, *new;\r\nint ret = -ENOMEM;\r\nnew = kmalloc(sizeof(*new), GFP_KERNEL);\r\nif (!new)\r\ngoto out;\r\nnew->task = current;\r\nnew->referral_count = 1;\r\nret = 0;\r\nspin_lock(&nfs_referral_count_list_lock);\r\np = nfs_find_referral_count();\r\nif (p != NULL) {\r\nif (p->referral_count >= NFS_MAX_NESTED_REFERRALS)\r\nret = -ELOOP;\r\nelse\r\np->referral_count++;\r\n} else {\r\nlist_add(&new->list, &nfs_referral_count_list);\r\nnew = NULL;\r\n}\r\nspin_unlock(&nfs_referral_count_list_lock);\r\nkfree(new);\r\nout:\r\nreturn ret;\r\n}\r\nstatic void nfs_referral_loop_unprotect(void)\r\n{\r\nstruct nfs_referral_count *p;\r\nspin_lock(&nfs_referral_count_list_lock);\r\np = nfs_find_referral_count();\r\np->referral_count--;\r\nif (p->referral_count == 0)\r\nlist_del(&p->list);\r\nelse\r\np = NULL;\r\nspin_unlock(&nfs_referral_count_list_lock);\r\nkfree(p);\r\n}\r\nstatic struct dentry *nfs_follow_remote_path(struct vfsmount *root_mnt,\r\nconst char *export_path)\r\n{\r\nstruct dentry *dentry;\r\nint err;\r\nif (IS_ERR(root_mnt))\r\nreturn ERR_CAST(root_mnt);\r\nerr = nfs_referral_loop_protect();\r\nif (err) {\r\nmntput(root_mnt);\r\nreturn ERR_PTR(err);\r\n}\r\ndentry = mount_subtree(root_mnt, export_path);\r\nnfs_referral_loop_unprotect();\r\nreturn dentry;\r\n}\r\nstruct dentry *nfs4_try_mount(int flags, const char *dev_name,\r\nstruct nfs_mount_info *mount_info,\r\nstruct nfs_subversion *nfs_mod)\r\n{\r\nchar *export_path;\r\nstruct vfsmount *root_mnt;\r\nstruct dentry *res;\r\nstruct nfs_parsed_mount_data *data = mount_info->parsed;\r\ndfprintk(MOUNT, "--> nfs4_try_mount()\n");\r\nexport_path = data->nfs_server.export_path;\r\ndata->nfs_server.export_path = "/";\r\nroot_mnt = nfs_do_root_mount(&nfs4_remote_fs_type, flags, mount_info,\r\ndata->nfs_server.hostname);\r\ndata->nfs_server.export_path = export_path;\r\nres = nfs_follow_remote_path(root_mnt, export_path);\r\ndfprintk(MOUNT, "<-- nfs4_try_mount() = %d%s\n",\r\nPTR_ERR_OR_ZERO(res),\r\nIS_ERR(res) ? " [error]" : "");\r\nreturn res;\r\n}\r\nstatic struct dentry *\r\nnfs4_remote_referral_mount(struct file_system_type *fs_type, int flags,\r\nconst char *dev_name, void *raw_data)\r\n{\r\nstruct nfs_mount_info mount_info = {\r\n.fill_super = nfs_fill_super,\r\n.set_security = nfs_clone_sb_security,\r\n.cloned = raw_data,\r\n};\r\nstruct nfs_server *server;\r\nstruct dentry *mntroot = ERR_PTR(-ENOMEM);\r\ndprintk("--> nfs4_referral_get_sb()\n");\r\nmount_info.mntfh = nfs_alloc_fhandle();\r\nif (mount_info.cloned == NULL || mount_info.mntfh == NULL)\r\ngoto out;\r\nserver = nfs4_create_referral_server(mount_info.cloned, mount_info.mntfh);\r\nif (IS_ERR(server)) {\r\nmntroot = ERR_CAST(server);\r\ngoto out;\r\n}\r\nmntroot = nfs_fs_mount_common(server, flags, dev_name, &mount_info, &nfs_v4);\r\nout:\r\nnfs_free_fhandle(mount_info.mntfh);\r\nreturn mntroot;\r\n}\r\nstatic struct dentry *nfs4_referral_mount(struct file_system_type *fs_type,\r\nint flags, const char *dev_name, void *raw_data)\r\n{\r\nstruct nfs_clone_mount *data = raw_data;\r\nchar *export_path;\r\nstruct vfsmount *root_mnt;\r\nstruct dentry *res;\r\ndprintk("--> nfs4_referral_mount()\n");\r\nexport_path = data->mnt_path;\r\ndata->mnt_path = "/";\r\nroot_mnt = nfs_do_root_mount(&nfs4_remote_referral_fs_type,\r\nflags, data, data->hostname);\r\ndata->mnt_path = export_path;\r\nres = nfs_follow_remote_path(root_mnt, export_path);\r\ndprintk("<-- nfs4_referral_mount() = %d%s\n",\r\nPTR_ERR_OR_ZERO(res),\r\nIS_ERR(res) ? " [error]" : "");\r\nreturn res;\r\n}\r\nstatic int __init init_nfs_v4(void)\r\n{\r\nint err;\r\nerr = nfs_dns_resolver_init();\r\nif (err)\r\ngoto out;\r\nerr = nfs_idmap_init();\r\nif (err)\r\ngoto out1;\r\nerr = nfs4_register_sysctl();\r\nif (err)\r\ngoto out2;\r\nregister_nfs_version(&nfs_v4);\r\nreturn 0;\r\nout2:\r\nnfs_idmap_quit();\r\nout1:\r\nnfs_dns_resolver_destroy();\r\nout:\r\nreturn err;\r\n}\r\nstatic void __exit exit_nfs_v4(void)\r\n{\r\nnfs4_pnfs_v3_ds_connect_unload();\r\nunregister_nfs_version(&nfs_v4);\r\nnfs4_unregister_sysctl();\r\nnfs_idmap_quit();\r\nnfs_dns_resolver_destroy();\r\n}

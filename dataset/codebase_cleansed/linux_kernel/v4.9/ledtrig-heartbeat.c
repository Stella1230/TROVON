static void led_heartbeat_function(unsigned long data)\r\n{\r\nstruct led_classdev *led_cdev = (struct led_classdev *) data;\r\nstruct heartbeat_trig_data *heartbeat_data = led_cdev->trigger_data;\r\nunsigned long brightness = LED_OFF;\r\nunsigned long delay = 0;\r\nif (unlikely(panic_heartbeats)) {\r\nled_set_brightness_nosleep(led_cdev, LED_OFF);\r\nreturn;\r\n}\r\nswitch (heartbeat_data->phase) {\r\ncase 0:\r\nheartbeat_data->period = 300 +\r\n(6720 << FSHIFT) / (5 * avenrun[0] + (7 << FSHIFT));\r\nheartbeat_data->period =\r\nmsecs_to_jiffies(heartbeat_data->period);\r\ndelay = msecs_to_jiffies(70);\r\nheartbeat_data->phase++;\r\nif (!heartbeat_data->invert)\r\nbrightness = led_cdev->max_brightness;\r\nbreak;\r\ncase 1:\r\ndelay = heartbeat_data->period / 4 - msecs_to_jiffies(70);\r\nheartbeat_data->phase++;\r\nif (heartbeat_data->invert)\r\nbrightness = led_cdev->max_brightness;\r\nbreak;\r\ncase 2:\r\ndelay = msecs_to_jiffies(70);\r\nheartbeat_data->phase++;\r\nif (!heartbeat_data->invert)\r\nbrightness = led_cdev->max_brightness;\r\nbreak;\r\ndefault:\r\ndelay = heartbeat_data->period - heartbeat_data->period / 4 -\r\nmsecs_to_jiffies(70);\r\nheartbeat_data->phase = 0;\r\nif (heartbeat_data->invert)\r\nbrightness = led_cdev->max_brightness;\r\nbreak;\r\n}\r\nled_set_brightness_nosleep(led_cdev, brightness);\r\nmod_timer(&heartbeat_data->timer, jiffies + delay);\r\n}\r\nstatic ssize_t led_invert_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct heartbeat_trig_data *heartbeat_data = led_cdev->trigger_data;\r\nreturn sprintf(buf, "%u\n", heartbeat_data->invert);\r\n}\r\nstatic ssize_t led_invert_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct heartbeat_trig_data *heartbeat_data = led_cdev->trigger_data;\r\nunsigned long state;\r\nint ret;\r\nret = kstrtoul(buf, 0, &state);\r\nif (ret)\r\nreturn ret;\r\nheartbeat_data->invert = !!state;\r\nreturn size;\r\n}\r\nstatic void heartbeat_trig_activate(struct led_classdev *led_cdev)\r\n{\r\nstruct heartbeat_trig_data *heartbeat_data;\r\nint rc;\r\nheartbeat_data = kzalloc(sizeof(*heartbeat_data), GFP_KERNEL);\r\nif (!heartbeat_data)\r\nreturn;\r\nled_cdev->trigger_data = heartbeat_data;\r\nrc = device_create_file(led_cdev->dev, &dev_attr_invert);\r\nif (rc) {\r\nkfree(led_cdev->trigger_data);\r\nreturn;\r\n}\r\nsetup_timer(&heartbeat_data->timer,\r\nled_heartbeat_function, (unsigned long) led_cdev);\r\nheartbeat_data->phase = 0;\r\nled_heartbeat_function(heartbeat_data->timer.data);\r\nled_cdev->activated = true;\r\n}\r\nstatic void heartbeat_trig_deactivate(struct led_classdev *led_cdev)\r\n{\r\nstruct heartbeat_trig_data *heartbeat_data = led_cdev->trigger_data;\r\nif (led_cdev->activated) {\r\ndel_timer_sync(&heartbeat_data->timer);\r\ndevice_remove_file(led_cdev->dev, &dev_attr_invert);\r\nkfree(heartbeat_data);\r\nled_cdev->activated = false;\r\n}\r\n}\r\nstatic int heartbeat_pm_notifier(struct notifier_block *nb,\r\nunsigned long pm_event, void *unused)\r\n{\r\nint rc;\r\nswitch (pm_event) {\r\ncase PM_SUSPEND_PREPARE:\r\ncase PM_HIBERNATION_PREPARE:\r\ncase PM_RESTORE_PREPARE:\r\nled_trigger_unregister(&heartbeat_led_trigger);\r\nbreak;\r\ncase PM_POST_SUSPEND:\r\ncase PM_POST_HIBERNATION:\r\ncase PM_POST_RESTORE:\r\nrc = led_trigger_register(&heartbeat_led_trigger);\r\nif (rc)\r\npr_err("could not re-register heartbeat trigger\n");\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int heartbeat_reboot_notifier(struct notifier_block *nb,\r\nunsigned long code, void *unused)\r\n{\r\nled_trigger_unregister(&heartbeat_led_trigger);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int heartbeat_panic_notifier(struct notifier_block *nb,\r\nunsigned long code, void *unused)\r\n{\r\npanic_heartbeats = 1;\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init heartbeat_trig_init(void)\r\n{\r\nint rc = led_trigger_register(&heartbeat_led_trigger);\r\nif (!rc) {\r\natomic_notifier_chain_register(&panic_notifier_list,\r\n&heartbeat_panic_nb);\r\nregister_reboot_notifier(&heartbeat_reboot_nb);\r\nregister_pm_notifier(&heartbeat_pm_nb);\r\n}\r\nreturn rc;\r\n}\r\nstatic void __exit heartbeat_trig_exit(void)\r\n{\r\nunregister_pm_notifier(&heartbeat_pm_nb);\r\nunregister_reboot_notifier(&heartbeat_reboot_nb);\r\natomic_notifier_chain_unregister(&panic_notifier_list,\r\n&heartbeat_panic_nb);\r\nled_trigger_unregister(&heartbeat_led_trigger);\r\n}

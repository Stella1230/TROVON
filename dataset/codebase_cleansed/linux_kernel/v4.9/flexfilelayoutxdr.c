__be32\r\nnfsd4_ff_encode_layoutget(struct xdr_stream *xdr,\r\nstruct nfsd4_layoutget *lgp)\r\n{\r\nstruct pnfs_ff_layout *fl = lgp->lg_content;\r\nint len, mirror_len, ds_len, fh_len;\r\n__be32 *p;\r\nstruct ff_idmap uid;\r\nstruct ff_idmap gid;\r\nfh_len = 4 + fl->fh.size;\r\nuid.len = sprintf(uid.buf, "%u", from_kuid(&init_user_ns, fl->uid));\r\ngid.len = sprintf(gid.buf, "%u", from_kgid(&init_user_ns, fl->gid));\r\nds_len = 20 + sizeof(stateid_opaque_t) + 4 + fh_len +\r\n8 + uid.len + 8 + gid.len;\r\nmirror_len = 4 + ds_len;\r\nlen = 20 + mirror_len;\r\np = xdr_reserve_space(xdr, sizeof(__be32) + len);\r\nif (!p)\r\nreturn nfserr_toosmall;\r\n*p++ = cpu_to_be32(len);\r\np = xdr_encode_hyper(p, 0);\r\n*p++ = cpu_to_be32(1);\r\n*p++ = cpu_to_be32(1);\r\np = xdr_encode_opaque_fixed(p, &fl->deviceid,\r\nsizeof(struct nfsd4_deviceid));\r\n*p++ = cpu_to_be32(1);\r\n*p++ = cpu_to_be32(fl->stateid.si_generation);\r\np = xdr_encode_opaque_fixed(p, &fl->stateid.si_opaque,\r\nsizeof(stateid_opaque_t));\r\n*p++ = cpu_to_be32(1);\r\np = xdr_encode_opaque(p, fl->fh.data, fl->fh.size);\r\np = xdr_encode_opaque(p, uid.buf, uid.len);\r\np = xdr_encode_opaque(p, gid.buf, gid.len);\r\n*p++ = cpu_to_be32(fl->flags);\r\n*p++ = cpu_to_be32(0);\r\nreturn 0;\r\n}\r\n__be32\r\nnfsd4_ff_encode_getdeviceinfo(struct xdr_stream *xdr,\r\nstruct nfsd4_getdeviceinfo *gdp)\r\n{\r\nstruct pnfs_ff_device_addr *da = gdp->gd_device;\r\nint len;\r\nint ver_len;\r\nint addr_len;\r\n__be32 *p;\r\naddr_len = 16 + da->netaddr.netid_len + da->netaddr.addr_len;\r\nver_len = 20;\r\nlen = 4 + ver_len + 4 + addr_len;\r\np = xdr_reserve_space(xdr, len + sizeof(__be32));\r\nif (!p)\r\nreturn nfserr_resource;\r\n*p++ = cpu_to_be32(len);\r\n*p++ = cpu_to_be32(1);\r\np = xdr_encode_opaque(p, da->netaddr.netid, da->netaddr.netid_len);\r\np = xdr_encode_opaque(p, da->netaddr.addr, da->netaddr.addr_len);\r\n*p++ = cpu_to_be32(1);\r\n*p++ = cpu_to_be32(da->version);\r\n*p++ = cpu_to_be32(da->minor_version);\r\n*p++ = cpu_to_be32(da->rsize);\r\n*p++ = cpu_to_be32(da->wsize);\r\n*p++ = cpu_to_be32(da->tightly_coupled);\r\nreturn 0;\r\n}

static acpi_size acpi_os_get_page_size(void)\r\n{\r\n#ifdef PAGE_SIZE\r\nreturn PAGE_SIZE;\r\n#else\r\nreturn sysconf(_SC_PAGESIZE);\r\n#endif\r\n}\r\nvoid *acpi_os_map_memory(acpi_physical_address where, acpi_size length)\r\n{\r\nu8 *mapped_memory;\r\nacpi_physical_address offset;\r\nacpi_size page_size;\r\nint fd;\r\nfd = open(SYSTEM_MEMORY, O_RDONLY | O_BINARY);\r\nif (fd < 0) {\r\nfprintf(stderr, "Cannot open %s\n", SYSTEM_MEMORY);\r\nreturn (NULL);\r\n}\r\npage_size = acpi_os_get_page_size();\r\noffset = where % page_size;\r\nmapped_memory = mmap(NULL, (length + offset), PROT_READ, MMAP_FLAGS,\r\nfd, (where - offset));\r\nif (mapped_memory == MAP_FAILED) {\r\nfprintf(stderr, "Cannot map %s\n", SYSTEM_MEMORY);\r\nclose(fd);\r\nreturn (NULL);\r\n}\r\nclose(fd);\r\nreturn (ACPI_CAST8(mapped_memory + offset));\r\n}\r\nvoid acpi_os_unmap_memory(void *where, acpi_size length)\r\n{\r\nacpi_physical_address offset;\r\nacpi_size page_size;\r\npage_size = acpi_os_get_page_size();\r\noffset = ACPI_TO_INTEGER(where) % page_size;\r\nmunmap((u8 *)where - offset, (length + offset));\r\n}

static int max8952_read_reg(struct max8952_data *max8952, u8 reg)\r\n{\r\nint ret = i2c_smbus_read_byte_data(max8952->client, reg);\r\nif (ret > 0)\r\nret &= 0xff;\r\nreturn ret;\r\n}\r\nstatic int max8952_write_reg(struct max8952_data *max8952,\r\nu8 reg, u8 value)\r\n{\r\nreturn i2c_smbus_write_byte_data(max8952->client, reg, value);\r\n}\r\nstatic int max8952_list_voltage(struct regulator_dev *rdev,\r\nunsigned int selector)\r\n{\r\nstruct max8952_data *max8952 = rdev_get_drvdata(rdev);\r\nif (rdev_get_id(rdev) != 0)\r\nreturn -EINVAL;\r\nreturn (max8952->pdata->dvs_mode[selector] * 10 + 770) * 1000;\r\n}\r\nstatic int max8952_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct max8952_data *max8952 = rdev_get_drvdata(rdev);\r\nu8 vid = 0;\r\nif (max8952->vid0)\r\nvid += 1;\r\nif (max8952->vid1)\r\nvid += 2;\r\nreturn vid;\r\n}\r\nstatic int max8952_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct max8952_data *max8952 = rdev_get_drvdata(rdev);\r\nif (!gpio_is_valid(max8952->pdata->gpio_vid0) ||\r\n!gpio_is_valid(max8952->pdata->gpio_vid1)) {\r\nreturn -EPERM;\r\n}\r\nmax8952->vid0 = selector & 0x1;\r\nmax8952->vid1 = (selector >> 1) & 0x1;\r\ngpio_set_value(max8952->pdata->gpio_vid0, max8952->vid0);\r\ngpio_set_value(max8952->pdata->gpio_vid1, max8952->vid1);\r\nreturn 0;\r\n}\r\nstatic struct max8952_platform_data *max8952_parse_dt(struct device *dev)\r\n{\r\nstruct max8952_platform_data *pd;\r\nstruct device_node *np = dev->of_node;\r\nint ret;\r\nint i;\r\npd = devm_kzalloc(dev, sizeof(*pd), GFP_KERNEL);\r\nif (!pd)\r\nreturn NULL;\r\npd->gpio_vid0 = of_get_named_gpio(np, "max8952,vid-gpios", 0);\r\npd->gpio_vid1 = of_get_named_gpio(np, "max8952,vid-gpios", 1);\r\npd->gpio_en = of_get_named_gpio(np, "max8952,en-gpio", 0);\r\nif (of_property_read_u32(np, "max8952,default-mode", &pd->default_mode))\r\ndev_warn(dev, "Default mode not specified, assuming 0\n");\r\nret = of_property_read_u32_array(np, "max8952,dvs-mode-microvolt",\r\npd->dvs_mode, ARRAY_SIZE(pd->dvs_mode));\r\nif (ret) {\r\ndev_err(dev, "max8952,dvs-mode-microvolt property not specified");\r\nreturn NULL;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(pd->dvs_mode); ++i) {\r\nif (pd->dvs_mode[i] < 770000 || pd->dvs_mode[i] > 1400000) {\r\ndev_err(dev, "DVS voltage %d out of range\n", i);\r\nreturn NULL;\r\n}\r\npd->dvs_mode[i] = (pd->dvs_mode[i] - 770000) / 10000;\r\n}\r\nif (of_property_read_u32(np, "max8952,sync-freq", &pd->sync_freq))\r\ndev_warn(dev, "max8952,sync-freq property not specified, defaulting to 26MHz\n");\r\nif (of_property_read_u32(np, "max8952,ramp-speed", &pd->ramp_speed))\r\ndev_warn(dev, "max8952,ramp-speed property not specified, defaulting to 32mV/us\n");\r\npd->reg_data = of_get_regulator_init_data(dev, np, &regulator);\r\nif (!pd->reg_data) {\r\ndev_err(dev, "Failed to parse regulator init data\n");\r\nreturn NULL;\r\n}\r\nreturn pd;\r\n}\r\nstatic struct max8952_platform_data *max8952_parse_dt(struct device *dev)\r\n{\r\nreturn NULL;\r\n}\r\nstatic int max8952_pmic_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *i2c_id)\r\n{\r\nstruct i2c_adapter *adapter = to_i2c_adapter(client->dev.parent);\r\nstruct max8952_platform_data *pdata = dev_get_platdata(&client->dev);\r\nstruct regulator_config config = { };\r\nstruct max8952_data *max8952;\r\nstruct regulator_dev *rdev;\r\nint ret = 0, err = 0;\r\nif (client->dev.of_node)\r\npdata = max8952_parse_dt(&client->dev);\r\nif (!pdata) {\r\ndev_err(&client->dev, "Require the platform data\n");\r\nreturn -EINVAL;\r\n}\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE))\r\nreturn -EIO;\r\nmax8952 = devm_kzalloc(&client->dev, sizeof(struct max8952_data),\r\nGFP_KERNEL);\r\nif (!max8952)\r\nreturn -ENOMEM;\r\nmax8952->client = client;\r\nmax8952->pdata = pdata;\r\nconfig.dev = &client->dev;\r\nconfig.init_data = pdata->reg_data;\r\nconfig.driver_data = max8952;\r\nconfig.of_node = client->dev.of_node;\r\nconfig.ena_gpio = pdata->gpio_en;\r\nif (client->dev.of_node)\r\nconfig.ena_gpio_initialized = true;\r\nif (pdata->reg_data->constraints.boot_on)\r\nconfig.ena_gpio_flags |= GPIOF_OUT_INIT_HIGH;\r\nrdev = devm_regulator_register(&client->dev, &regulator, &config);\r\nif (IS_ERR(rdev)) {\r\nret = PTR_ERR(rdev);\r\ndev_err(&client->dev, "regulator init failed (%d)\n", ret);\r\nreturn ret;\r\n}\r\nmax8952->vid0 = pdata->default_mode & 0x1;\r\nmax8952->vid1 = (pdata->default_mode >> 1) & 0x1;\r\nif (gpio_is_valid(pdata->gpio_vid0) &&\r\ngpio_is_valid(pdata->gpio_vid1)) {\r\nunsigned long gpio_flags;\r\ngpio_flags = max8952->vid0 ?\r\nGPIOF_OUT_INIT_HIGH : GPIOF_OUT_INIT_LOW;\r\nif (devm_gpio_request_one(&client->dev, pdata->gpio_vid0,\r\ngpio_flags, "MAX8952 VID0"))\r\nerr = 1;\r\ngpio_flags = max8952->vid1 ?\r\nGPIOF_OUT_INIT_HIGH : GPIOF_OUT_INIT_LOW;\r\nif (devm_gpio_request_one(&client->dev, pdata->gpio_vid1,\r\ngpio_flags, "MAX8952 VID1"))\r\nerr = 2;\r\n} else\r\nerr = 3;\r\nif (err) {\r\ndev_warn(&client->dev, "VID0/1 gpio invalid: "\r\n"DVS not available.\n");\r\nmax8952->vid0 = 0;\r\nmax8952->vid1 = 0;\r\npdata->gpio_vid0 = -1;\r\npdata->gpio_vid1 = -1;\r\nmax8952_write_reg(max8952, MAX8952_REG_CONTROL, 0x60);\r\ndev_err(&client->dev, "DVS modes disabled because VID0 and VID1"\r\n" do not have proper controls.\n");\r\n} else {\r\nmax8952_write_reg(max8952, MAX8952_REG_CONTROL, 0x0);\r\n}\r\nmax8952_write_reg(max8952, MAX8952_REG_MODE0,\r\n(max8952_read_reg(max8952,\r\nMAX8952_REG_MODE0) & 0xC0) |\r\n(pdata->dvs_mode[0] & 0x3F));\r\nmax8952_write_reg(max8952, MAX8952_REG_MODE1,\r\n(max8952_read_reg(max8952,\r\nMAX8952_REG_MODE1) & 0xC0) |\r\n(pdata->dvs_mode[1] & 0x3F));\r\nmax8952_write_reg(max8952, MAX8952_REG_MODE2,\r\n(max8952_read_reg(max8952,\r\nMAX8952_REG_MODE2) & 0xC0) |\r\n(pdata->dvs_mode[2] & 0x3F));\r\nmax8952_write_reg(max8952, MAX8952_REG_MODE3,\r\n(max8952_read_reg(max8952,\r\nMAX8952_REG_MODE3) & 0xC0) |\r\n(pdata->dvs_mode[3] & 0x3F));\r\nmax8952_write_reg(max8952, MAX8952_REG_SYNC,\r\n(max8952_read_reg(max8952, MAX8952_REG_SYNC) & 0x3F) |\r\n((pdata->sync_freq & 0x3) << 6));\r\nmax8952_write_reg(max8952, MAX8952_REG_RAMP,\r\n(max8952_read_reg(max8952, MAX8952_REG_RAMP) & 0x1F) |\r\n((pdata->ramp_speed & 0x7) << 5));\r\ni2c_set_clientdata(client, max8952);\r\nreturn 0;\r\n}\r\nstatic int __init max8952_pmic_init(void)\r\n{\r\nreturn i2c_add_driver(&max8952_pmic_driver);\r\n}\r\nstatic void __exit max8952_pmic_exit(void)\r\n{\r\ni2c_del_driver(&max8952_pmic_driver);\r\n}

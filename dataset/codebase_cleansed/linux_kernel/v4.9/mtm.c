static void mtm_init_nat(int cpu)\r\n{\r\nstruct nps_host_reg_mtm_cfg mtm_cfg;\r\nstruct nps_host_reg_aux_udmc udmc;\r\nint log_nat, nat = 0, i, t;\r\nfor (i = 0, t = cpu; i < NPS_NUM_HW_THREADS; i++, t++)\r\nnat += test_bit(t, cpumask_bits(cpu_possible_mask));\r\nlog_nat = ilog2(nat);\r\nudmc.value = read_aux_reg(CTOP_AUX_UDMC);\r\nudmc.nat = log_nat;\r\nwrite_aux_reg(CTOP_AUX_UDMC, udmc.value);\r\nmtm_cfg.value = ioread32be(MTM_CFG(cpu));\r\nmtm_cfg.nat = log_nat;\r\niowrite32be(mtm_cfg.value, MTM_CFG(cpu));\r\n}\r\nstatic void mtm_init_thread(int cpu)\r\n{\r\nint i, tries = 5;\r\nstruct nps_host_reg_thr_init thr_init;\r\nstruct nps_host_reg_thr_init_sts thr_init_sts;\r\nthr_init.value = 0;\r\niowrite32be(thr_init.value, MTM_THR_INIT(cpu));\r\nthr_init.thr_id = NPS_CPU_TO_THREAD_NUM(cpu);\r\nthr_init.str = 1;\r\niowrite32be(thr_init.value, MTM_THR_INIT(cpu));\r\nfor (i = 0; i < tries; i++) {\r\nthr_init_sts.value = ioread32be(MTM_THR_INIT_STS(cpu));\r\nif (thr_init_sts.thr_id == thr_init.thr_id) {\r\nif (thr_init_sts.bsy)\r\ncontinue;\r\nelse if (thr_init_sts.err)\r\npr_warn("Failed to thread init cpu %u\n", cpu);\r\nbreak;\r\n}\r\npr_warn("Wrong thread id in thread init for cpu %u\n", cpu);\r\nbreak;\r\n}\r\nif (i == tries)\r\npr_warn("Got thread init timeout for cpu %u\n", cpu);\r\n}\r\nint mtm_enable_thread(int cpu)\r\n{\r\nstruct nps_host_reg_mtm_cfg mtm_cfg;\r\nif (NPS_CPU_TO_THREAD_NUM(cpu) == 0)\r\nreturn 1;\r\nmtm_cfg.value = ioread32be(MTM_CFG(cpu));\r\nmtm_cfg.ten |= (1 << (NPS_CPU_TO_THREAD_NUM(cpu)));\r\niowrite32be(mtm_cfg.value, MTM_CFG(cpu));\r\nreturn 0;\r\n}\r\nvoid mtm_enable_core(unsigned int cpu)\r\n{\r\nint i;\r\nstruct nps_host_reg_aux_mt_ctrl mt_ctrl;\r\nstruct nps_host_reg_mtm_cfg mtm_cfg;\r\nif (NPS_CPU_TO_THREAD_NUM(cpu) != 0)\r\nreturn;\r\nmtm_init_nat(cpu);\r\nmtm_cfg.value = ioread32be(MTM_CFG(cpu));\r\nmtm_cfg.ten = 1;\r\niowrite32be(mtm_cfg.value, MTM_CFG(cpu));\r\nfor (i = 1; i < NPS_NUM_HW_THREADS; i++)\r\nmtm_init_thread(cpu + i);\r\nmt_ctrl.value = 0;\r\nmt_ctrl.hsen = 1;\r\nmt_ctrl.hs_cnt = MT_CTRL_HS_CNT;\r\nmt_ctrl.sten = 1;\r\nmt_ctrl.st_cnt = MT_CTRL_ST_CNT;\r\nmt_ctrl.mten = 1;\r\nwrite_aux_reg(CTOP_AUX_MT_CTRL, mt_ctrl.value);\r\ncpu_relax();\r\n}

void\r\ndo_midi_msg(int synthno, unsigned char *msg, int mlen)\r\n{\r\nswitch (msg[0] & 0xf0)\r\n{\r\ncase 0x90:\r\nif (msg[2] != 0)\r\n{\r\nSTORE(SEQ_START_NOTE(synthno, msg[0] & 0x0f, msg[1], msg[2]));\r\nbreak;\r\n}\r\nmsg[2] = 64;\r\ncase 0x80:\r\nSTORE(SEQ_STOP_NOTE(synthno, msg[0] & 0x0f, msg[1], msg[2]));\r\nbreak;\r\ncase 0xA0:\r\nSTORE(SEQ_KEY_PRESSURE(synthno, msg[0] & 0x0f, msg[1], msg[2]));\r\nbreak;\r\ncase 0xB0:\r\nSTORE(SEQ_CONTROL(synthno, msg[0] & 0x0f,\r\nmsg[1], msg[2]));\r\nbreak;\r\ncase 0xC0:\r\nSTORE(SEQ_SET_PATCH(synthno, msg[0] & 0x0f, msg[1]));\r\nbreak;\r\ncase 0xD0:\r\nSTORE(SEQ_CHN_PRESSURE(synthno, msg[0] & 0x0f, msg[1]));\r\nbreak;\r\ncase 0xE0:\r\nSTORE(SEQ_BENDER(synthno, msg[0] & 0x0f,\r\n(msg[1] & 0x7f) | ((msg[2] & 0x7f) << 7)));\r\nbreak;\r\ndefault:\r\n;\r\n}\r\n}\r\nstatic void\r\nmidi_outc(int midi_dev, int data)\r\n{\r\nint timeout;\r\nfor (timeout = 0; timeout < 3200; timeout++)\r\nif (midi_devs[midi_dev]->outputc(midi_dev, (unsigned char) (data & 0xff)))\r\n{\r\nif (data & 0x80)\r\nprev_out_status[midi_dev] =\r\n(unsigned char) (data & 0xff);\r\nreturn;\r\n}\r\nprintk("Midi send timed out\n");\r\n}\r\nstatic int\r\nprefix_cmd(int midi_dev, unsigned char status)\r\n{\r\nif ((char *) midi_devs[midi_dev]->prefix_cmd == NULL)\r\nreturn 1;\r\nreturn midi_devs[midi_dev]->prefix_cmd(midi_dev, status);\r\n}\r\nstatic void\r\nmidi_synth_input(int orig_dev, unsigned char data)\r\n{\r\nint dev;\r\nstruct midi_input_info *inc;\r\nstatic unsigned char len_tab[] =\r\n{\r\n2,\r\n2,\r\n2,\r\n2,\r\n1,\r\n1,\r\n2,\r\n0\r\n};\r\nif (orig_dev < 0 || orig_dev > num_midis || midi_devs[orig_dev] == NULL)\r\nreturn;\r\nif (data == 0xfe)\r\nreturn;\r\ndev = midi2synth[orig_dev];\r\ninc = &midi_devs[orig_dev]->in_info;\r\nswitch (inc->m_state)\r\n{\r\ncase MST_INIT:\r\nif (data & 0x80)\r\n{\r\nif ((data & 0xf0) == 0xf0)\r\n{\r\nswitch (data)\r\n{\r\ncase 0xf0:\r\ninc->m_state = MST_SYSEX;\r\nbreak;\r\ncase 0xf1:\r\ncase 0xf3:\r\ninc->m_state = MST_DATA;\r\ninc->m_ptr = 1;\r\ninc->m_left = 1;\r\ninc->m_buf[0] = data;\r\nbreak;\r\ncase 0xf2:\r\ninc->m_state = MST_DATA;\r\ninc->m_ptr = 1;\r\ninc->m_left = 2;\r\ninc->m_buf[0] = data;\r\nbreak;\r\ndefault:\r\ninc->m_buf[0] = data;\r\ninc->m_ptr = 1;\r\ndo_midi_msg(dev, inc->m_buf, inc->m_ptr);\r\ninc->m_ptr = 0;\r\ninc->m_left = 0;\r\n}\r\n} else\r\n{\r\ninc->m_state = MST_DATA;\r\ninc->m_ptr = 1;\r\ninc->m_left = len_tab[(data >> 4) - 8];\r\ninc->m_buf[0] = inc->m_prev_status = data;\r\n}\r\n} else if (inc->m_prev_status & 0x80) {\r\ninc->m_ptr = 2;\r\ninc->m_buf[1] = data;\r\ninc->m_buf[0] = inc->m_prev_status;\r\ninc->m_left = len_tab[(inc->m_buf[0] >> 4) - 8] - 1;\r\nif (inc->m_left > 0)\r\ninc->m_state = MST_DATA;\r\nelse {\r\ninc->m_state = MST_INIT;\r\ndo_midi_msg(dev, inc->m_buf, inc->m_ptr);\r\ninc->m_ptr = 0;\r\n}\r\n}\r\nbreak;\r\ncase MST_DATA:\r\ninc->m_buf[inc->m_ptr++] = data;\r\nif (--inc->m_left <= 0)\r\n{\r\ninc->m_state = MST_INIT;\r\ndo_midi_msg(dev, inc->m_buf, inc->m_ptr);\r\ninc->m_ptr = 0;\r\n}\r\nbreak;\r\ncase MST_SYSEX:\r\nif (data == 0xf7)\r\n{\r\ninc->m_state = MST_INIT;\r\ninc->m_left = 0;\r\ninc->m_ptr = 0;\r\n}\r\nbreak;\r\ndefault:\r\nprintk("MIDI%d: Unexpected state %d (%02x)\n", orig_dev, inc->m_state, (int) data);\r\ninc->m_state = MST_INIT;\r\n}\r\n}\r\nstatic void\r\nleave_sysex(int dev)\r\n{\r\nint orig_dev = synth_devs[dev]->midi_dev;\r\nint timeout = 0;\r\nif (!sysex_state[dev])\r\nreturn;\r\nsysex_state[dev] = 0;\r\nwhile (!midi_devs[orig_dev]->outputc(orig_dev, 0xf7) &&\r\ntimeout < 1000)\r\ntimeout++;\r\nsysex_state[dev] = 0;\r\n}\r\nstatic void\r\nmidi_synth_output(int dev)\r\n{\r\n}\r\nint midi_synth_ioctl(int dev, unsigned int cmd, void __user *arg)\r\n{\r\nswitch (cmd) {\r\ncase SNDCTL_SYNTH_INFO:\r\nif (__copy_to_user(arg, synth_devs[dev]->info, sizeof(struct synth_info)))\r\nreturn -EFAULT;\r\nreturn 0;\r\ncase SNDCTL_SYNTH_MEMAVL:\r\nreturn 0x7fffffff;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nint\r\nmidi_synth_kill_note(int dev, int channel, int note, int velocity)\r\n{\r\nint orig_dev = synth_devs[dev]->midi_dev;\r\nint msg, chn;\r\nif (note < 0 || note > 127)\r\nreturn 0;\r\nif (channel < 0 || channel > 15)\r\nreturn 0;\r\nif (velocity < 0)\r\nvelocity = 0;\r\nif (velocity > 127)\r\nvelocity = 127;\r\nleave_sysex(dev);\r\nmsg = prev_out_status[orig_dev] & 0xf0;\r\nchn = prev_out_status[orig_dev] & 0x0f;\r\nif (chn == channel && ((msg == 0x90 && velocity == 64) || msg == 0x80))\r\n{\r\nif (!prefix_cmd(orig_dev, note))\r\nreturn 0;\r\nmidi_outc(orig_dev, note);\r\nif (msg == 0x90)\r\nmidi_outc(orig_dev, 0);\r\nelse\r\nmidi_outc(orig_dev, velocity);\r\n} else\r\n{\r\nif (velocity == 64)\r\n{\r\nif (!prefix_cmd(orig_dev, 0x90 | (channel & 0x0f)))\r\nreturn 0;\r\nmidi_outc(orig_dev, 0x90 | (channel & 0x0f));\r\nmidi_outc(orig_dev, note);\r\nmidi_outc(orig_dev, 0);\r\n} else\r\n{\r\nif (!prefix_cmd(orig_dev, 0x80 | (channel & 0x0f)))\r\nreturn 0;\r\nmidi_outc(orig_dev, 0x80 | (channel & 0x0f));\r\nmidi_outc(orig_dev, note);\r\nmidi_outc(orig_dev, velocity);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint\r\nmidi_synth_set_instr(int dev, int channel, int instr_no)\r\n{\r\nint orig_dev = synth_devs[dev]->midi_dev;\r\nif (instr_no < 0 || instr_no > 127)\r\ninstr_no = 0;\r\nif (channel < 0 || channel > 15)\r\nreturn 0;\r\nleave_sysex(dev);\r\nif (!prefix_cmd(orig_dev, 0xc0 | (channel & 0x0f)))\r\nreturn 0;\r\nmidi_outc(orig_dev, 0xc0 | (channel & 0x0f));\r\nmidi_outc(orig_dev, instr_no);\r\nreturn 0;\r\n}\r\nint\r\nmidi_synth_start_note(int dev, int channel, int note, int velocity)\r\n{\r\nint orig_dev = synth_devs[dev]->midi_dev;\r\nint msg, chn;\r\nif (note < 0 || note > 127)\r\nreturn 0;\r\nif (channel < 0 || channel > 15)\r\nreturn 0;\r\nif (velocity < 0)\r\nvelocity = 0;\r\nif (velocity > 127)\r\nvelocity = 127;\r\nleave_sysex(dev);\r\nmsg = prev_out_status[orig_dev] & 0xf0;\r\nchn = prev_out_status[orig_dev] & 0x0f;\r\nif (chn == channel && msg == 0x90)\r\n{\r\nif (!prefix_cmd(orig_dev, note))\r\nreturn 0;\r\nmidi_outc(orig_dev, note);\r\nmidi_outc(orig_dev, velocity);\r\n} else\r\n{\r\nif (!prefix_cmd(orig_dev, 0x90 | (channel & 0x0f)))\r\nreturn 0;\r\nmidi_outc(orig_dev, 0x90 | (channel & 0x0f));\r\nmidi_outc(orig_dev, note);\r\nmidi_outc(orig_dev, velocity);\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nmidi_synth_reset(int dev)\r\n{\r\nleave_sysex(dev);\r\n}\r\nint\r\nmidi_synth_open(int dev, int mode)\r\n{\r\nint orig_dev = synth_devs[dev]->midi_dev;\r\nint err;\r\nstruct midi_input_info *inc;\r\nif (orig_dev < 0 || orig_dev >= num_midis || midi_devs[orig_dev] == NULL)\r\nreturn -ENXIO;\r\nmidi2synth[orig_dev] = dev;\r\nsysex_state[dev] = 0;\r\nprev_out_status[orig_dev] = 0;\r\nif ((err = midi_devs[orig_dev]->open(orig_dev, mode,\r\nmidi_synth_input, midi_synth_output)) < 0)\r\nreturn err;\r\ninc = &midi_devs[orig_dev]->in_info;\r\ninc->m_busy = 0;\r\ninc->m_state = MST_INIT;\r\ninc->m_ptr = 0;\r\ninc->m_left = 0;\r\ninc->m_prev_status = 0x00;\r\nreturn 1;\r\n}\r\nvoid\r\nmidi_synth_close(int dev)\r\n{\r\nint orig_dev = synth_devs[dev]->midi_dev;\r\nleave_sysex(dev);\r\nmidi_devs[orig_dev]->outputc(orig_dev, 0xfe);\r\nmidi_devs[orig_dev]->close(orig_dev);\r\n}\r\nvoid\r\nmidi_synth_hw_control(int dev, unsigned char *event)\r\n{\r\n}\r\nint\r\nmidi_synth_load_patch(int dev, int format, const char __user *addr,\r\nint count, int pmgr_flag)\r\n{\r\nint orig_dev = synth_devs[dev]->midi_dev;\r\nstruct sysex_info sysex;\r\nint i;\r\nunsigned long left, src_offs, eox_seen = 0;\r\nint first_byte = 1;\r\nint hdr_size = (unsigned long) &sysex.data[0] - (unsigned long) &sysex;\r\nleave_sysex(dev);\r\nif (!prefix_cmd(orig_dev, 0xf0))\r\nreturn 0;\r\nif (format != SYSEX_PATCH)\r\nreturn -EINVAL;\r\nif (count < hdr_size)\r\nreturn -EINVAL;\r\ncount -= hdr_size;\r\nif (copy_from_user(&sysex, addr, hdr_size))\r\nreturn -EFAULT;\r\nif ((unsigned)count < (unsigned)sysex.len)\r\nsysex.len = count;\r\nleft = sysex.len;\r\nsrc_offs = 0;\r\nfor (i = 0; i < left && !signal_pending(current); i++)\r\n{\r\nunsigned char data;\r\nif (get_user(data,\r\n(unsigned char __user *)(addr + hdr_size + i)))\r\nreturn -EFAULT;\r\neox_seen = (i > 0 && data & 0x80);\r\nif (eox_seen && data != 0xf7)\r\ndata = 0xf7;\r\nif (i == 0)\r\n{\r\nif (data != 0xf0)\r\n{\r\nprintk(KERN_WARNING "midi_synth: Sysex start missing\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nwhile (!midi_devs[orig_dev]->outputc(orig_dev, (unsigned char) (data & 0xff)) &&\r\n!signal_pending(current))\r\nschedule();\r\nif (!first_byte && data & 0x80)\r\nreturn 0;\r\nfirst_byte = 0;\r\n}\r\nif (!eox_seen)\r\nmidi_outc(orig_dev, 0xf7);\r\nreturn 0;\r\n}\r\nvoid midi_synth_panning(int dev, int channel, int pressure)\r\n{\r\n}\r\nvoid midi_synth_aftertouch(int dev, int channel, int pressure)\r\n{\r\nint orig_dev = synth_devs[dev]->midi_dev;\r\nint msg, chn;\r\nif (pressure < 0 || pressure > 127)\r\nreturn;\r\nif (channel < 0 || channel > 15)\r\nreturn;\r\nleave_sysex(dev);\r\nmsg = prev_out_status[orig_dev] & 0xf0;\r\nchn = prev_out_status[orig_dev] & 0x0f;\r\nif (msg != 0xd0 || chn != channel)\r\n{\r\nif (!prefix_cmd(orig_dev, 0xd0 | (channel & 0x0f)))\r\nreturn;\r\nmidi_outc(orig_dev, 0xd0 | (channel & 0x0f));\r\n} else if (!prefix_cmd(orig_dev, pressure))\r\nreturn;\r\nmidi_outc(orig_dev, pressure);\r\n}\r\nvoid\r\nmidi_synth_controller(int dev, int channel, int ctrl_num, int value)\r\n{\r\nint orig_dev = synth_devs[dev]->midi_dev;\r\nint chn, msg;\r\nif (ctrl_num < 0 || ctrl_num > 127)\r\nreturn;\r\nif (channel < 0 || channel > 15)\r\nreturn;\r\nleave_sysex(dev);\r\nmsg = prev_out_status[orig_dev] & 0xf0;\r\nchn = prev_out_status[orig_dev] & 0x0f;\r\nif (msg != 0xb0 || chn != channel)\r\n{\r\nif (!prefix_cmd(orig_dev, 0xb0 | (channel & 0x0f)))\r\nreturn;\r\nmidi_outc(orig_dev, 0xb0 | (channel & 0x0f));\r\n} else if (!prefix_cmd(orig_dev, ctrl_num))\r\nreturn;\r\nmidi_outc(orig_dev, ctrl_num);\r\nmidi_outc(orig_dev, value & 0x7f);\r\n}\r\nvoid\r\nmidi_synth_bender(int dev, int channel, int value)\r\n{\r\nint orig_dev = synth_devs[dev]->midi_dev;\r\nint msg, prev_chn;\r\nif (channel < 0 || channel > 15)\r\nreturn;\r\nif (value < 0 || value > 16383)\r\nreturn;\r\nleave_sysex(dev);\r\nmsg = prev_out_status[orig_dev] & 0xf0;\r\nprev_chn = prev_out_status[orig_dev] & 0x0f;\r\nif (msg != 0xd0 || prev_chn != channel)\r\n{\r\nif (!prefix_cmd(orig_dev, 0xe0 | (channel & 0x0f)))\r\nreturn;\r\nmidi_outc(orig_dev, 0xe0 | (channel & 0x0f));\r\n} else if (!prefix_cmd(orig_dev, value & 0x7f))\r\nreturn;\r\nmidi_outc(orig_dev, value & 0x7f);\r\nmidi_outc(orig_dev, (value >> 7) & 0x7f);\r\n}\r\nvoid\r\nmidi_synth_setup_voice(int dev, int voice, int channel)\r\n{\r\n}\r\nint\r\nmidi_synth_send_sysex(int dev, unsigned char *bytes, int len)\r\n{\r\nint orig_dev = synth_devs[dev]->midi_dev;\r\nint i;\r\nfor (i = 0; i < len; i++)\r\n{\r\nswitch (bytes[i])\r\n{\r\ncase 0xf0:\r\nif (!prefix_cmd(orig_dev, 0xf0))\r\nreturn 0;\r\nsysex_state[dev] = 1;\r\nbreak;\r\ncase 0xf7:\r\nif (!sysex_state[dev])\r\nreturn 0;\r\nsysex_state[dev] = 0;\r\nbreak;\r\ndefault:\r\nif (!sysex_state[dev])\r\nreturn 0;\r\nif (bytes[i] & 0x80)\r\n{\r\nbytes[i] = 0xf7;\r\nsysex_state[dev] = 0;\r\n}\r\n}\r\nif (!midi_devs[orig_dev]->outputc(orig_dev, bytes[i]))\r\n{\r\nint timeout = 0;\r\nbytes[i] = 0xf7;\r\nsysex_state[dev] = 0;\r\nwhile (!midi_devs[orig_dev]->outputc(orig_dev, bytes[i]) &&\r\ntimeout < 1000)\r\ntimeout++;\r\n}\r\nif (!sysex_state[dev])\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}

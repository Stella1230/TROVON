void rds_connect_path_complete(struct rds_conn_path *cp, int curr)\r\n{\r\nif (!rds_conn_path_transition(cp, curr, RDS_CONN_UP)) {\r\nprintk(KERN_WARNING "%s: Cannot transition to state UP, "\r\n"current state is %d\n",\r\n__func__,\r\natomic_read(&cp->cp_state));\r\nrds_conn_path_drop(cp);\r\nreturn;\r\n}\r\nrdsdebug("conn %p for %pI4 to %pI4 complete\n",\r\ncp->cp_conn, &cp->cp_conn->c_laddr, &cp->cp_conn->c_faddr);\r\ncp->cp_reconnect_jiffies = 0;\r\nset_bit(0, &cp->cp_conn->c_map_queued);\r\nqueue_delayed_work(rds_wq, &cp->cp_send_w, 0);\r\nqueue_delayed_work(rds_wq, &cp->cp_recv_w, 0);\r\n}\r\nvoid rds_connect_complete(struct rds_connection *conn)\r\n{\r\nrds_connect_path_complete(&conn->c_path[0], RDS_CONN_CONNECTING);\r\n}\r\nvoid rds_queue_reconnect(struct rds_conn_path *cp)\r\n{\r\nunsigned long rand;\r\nstruct rds_connection *conn = cp->cp_conn;\r\nrdsdebug("conn %p for %pI4 to %pI4 reconnect jiffies %lu\n",\r\nconn, &conn->c_laddr, &conn->c_faddr,\r\ncp->cp_reconnect_jiffies);\r\nif (conn->c_trans->t_type == RDS_TRANS_TCP &&\r\nconn->c_laddr > conn->c_faddr)\r\nreturn;\r\nset_bit(RDS_RECONNECT_PENDING, &cp->cp_flags);\r\nif (cp->cp_reconnect_jiffies == 0) {\r\ncp->cp_reconnect_jiffies = rds_sysctl_reconnect_min_jiffies;\r\nqueue_delayed_work(rds_wq, &cp->cp_conn_w, 0);\r\nreturn;\r\n}\r\nget_random_bytes(&rand, sizeof(rand));\r\nrdsdebug("%lu delay %lu ceil conn %p for %pI4 -> %pI4\n",\r\nrand % cp->cp_reconnect_jiffies, cp->cp_reconnect_jiffies,\r\nconn, &conn->c_laddr, &conn->c_faddr);\r\nqueue_delayed_work(rds_wq, &cp->cp_conn_w,\r\nrand % cp->cp_reconnect_jiffies);\r\ncp->cp_reconnect_jiffies = min(cp->cp_reconnect_jiffies * 2,\r\nrds_sysctl_reconnect_max_jiffies);\r\n}\r\nvoid rds_connect_worker(struct work_struct *work)\r\n{\r\nstruct rds_conn_path *cp = container_of(work,\r\nstruct rds_conn_path,\r\ncp_conn_w.work);\r\nstruct rds_connection *conn = cp->cp_conn;\r\nint ret;\r\nif (cp->cp_index > 1 && cp->cp_conn->c_laddr > cp->cp_conn->c_faddr)\r\nreturn;\r\nclear_bit(RDS_RECONNECT_PENDING, &cp->cp_flags);\r\nret = rds_conn_path_transition(cp, RDS_CONN_DOWN, RDS_CONN_CONNECTING);\r\nif (ret) {\r\nret = conn->c_trans->conn_path_connect(cp);\r\nrdsdebug("conn %p for %pI4 to %pI4 dispatched, ret %d\n",\r\nconn, &conn->c_laddr, &conn->c_faddr, ret);\r\nif (ret) {\r\nif (rds_conn_path_transition(cp,\r\nRDS_CONN_CONNECTING,\r\nRDS_CONN_DOWN))\r\nrds_queue_reconnect(cp);\r\nelse\r\nrds_conn_path_error(cp,\r\n"RDS: connect failed\n");\r\n}\r\n}\r\n}\r\nvoid rds_send_worker(struct work_struct *work)\r\n{\r\nstruct rds_conn_path *cp = container_of(work,\r\nstruct rds_conn_path,\r\ncp_send_w.work);\r\nint ret;\r\nif (rds_conn_path_state(cp) == RDS_CONN_UP) {\r\nclear_bit(RDS_LL_SEND_FULL, &cp->cp_flags);\r\nret = rds_send_xmit(cp);\r\ncond_resched();\r\nrdsdebug("conn %p ret %d\n", cp->cp_conn, ret);\r\nswitch (ret) {\r\ncase -EAGAIN:\r\nrds_stats_inc(s_send_immediate_retry);\r\nqueue_delayed_work(rds_wq, &cp->cp_send_w, 0);\r\nbreak;\r\ncase -ENOMEM:\r\nrds_stats_inc(s_send_delayed_retry);\r\nqueue_delayed_work(rds_wq, &cp->cp_send_w, 2);\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid rds_recv_worker(struct work_struct *work)\r\n{\r\nstruct rds_conn_path *cp = container_of(work,\r\nstruct rds_conn_path,\r\ncp_recv_w.work);\r\nint ret;\r\nif (rds_conn_path_state(cp) == RDS_CONN_UP) {\r\nret = cp->cp_conn->c_trans->recv_path(cp);\r\nrdsdebug("conn %p ret %d\n", cp->cp_conn, ret);\r\nswitch (ret) {\r\ncase -EAGAIN:\r\nrds_stats_inc(s_recv_immediate_retry);\r\nqueue_delayed_work(rds_wq, &cp->cp_recv_w, 0);\r\nbreak;\r\ncase -ENOMEM:\r\nrds_stats_inc(s_recv_delayed_retry);\r\nqueue_delayed_work(rds_wq, &cp->cp_recv_w, 2);\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid rds_shutdown_worker(struct work_struct *work)\r\n{\r\nstruct rds_conn_path *cp = container_of(work,\r\nstruct rds_conn_path,\r\ncp_down_w);\r\nrds_conn_shutdown(cp);\r\n}\r\nvoid rds_threads_exit(void)\r\n{\r\ndestroy_workqueue(rds_wq);\r\n}\r\nint rds_threads_init(void)\r\n{\r\nrds_wq = create_singlethread_workqueue("krdsd");\r\nif (!rds_wq)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}

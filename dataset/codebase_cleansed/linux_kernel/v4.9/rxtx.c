static struct vnt_usb_send_context\r\n*vnt_get_free_context(struct vnt_private *priv)\r\n{\r\nstruct vnt_usb_send_context *context = NULL;\r\nint ii;\r\ndev_dbg(&priv->usb->dev, "%s\n", __func__);\r\nfor (ii = 0; ii < priv->num_tx_context; ii++) {\r\nif (!priv->tx_context[ii])\r\nreturn NULL;\r\ncontext = priv->tx_context[ii];\r\nif (!context->in_use) {\r\ncontext->in_use = true;\r\nmemset(context->data, 0,\r\nMAX_TOTAL_SIZE_WITH_ALL_HEADERS);\r\ncontext->hdr = NULL;\r\nreturn context;\r\n}\r\n}\r\nif (ii == priv->num_tx_context) {\r\ndev_dbg(&priv->usb->dev, "%s No Free Tx Context\n", __func__);\r\nieee80211_stop_queues(priv->hw);\r\n}\r\nreturn NULL;\r\n}\r\nstatic __le16 vnt_time_stamp_off(struct vnt_private *priv, u16 rate)\r\n{\r\nreturn cpu_to_le16(vnt_time_stampoff[priv->preamble_type % 2]\r\n[rate % MAX_RATE]);\r\n}\r\nstatic u32 vnt_get_rsvtime(struct vnt_private *priv, u8 pkt_type,\r\nu32 frame_length, u16 rate, int need_ack)\r\n{\r\nu32 data_time, ack_time;\r\ndata_time = vnt_get_frame_time(priv->preamble_type, pkt_type,\r\nframe_length, rate);\r\nif (pkt_type == PK_TYPE_11B)\r\nack_time = vnt_get_frame_time(priv->preamble_type, pkt_type,\r\n14, (u16)priv->top_cck_basic_rate);\r\nelse\r\nack_time = vnt_get_frame_time(priv->preamble_type, pkt_type,\r\n14, (u16)priv->top_ofdm_basic_rate);\r\nif (need_ack)\r\nreturn data_time + priv->sifs + ack_time;\r\nreturn data_time;\r\n}\r\nstatic __le16 vnt_rxtx_rsvtime_le16(struct vnt_private *priv, u8 pkt_type,\r\nu32 frame_length, u16 rate, int need_ack)\r\n{\r\nreturn cpu_to_le16((u16)vnt_get_rsvtime(priv, pkt_type,\r\nframe_length, rate, need_ack));\r\n}\r\nstatic __le16 vnt_get_rtscts_rsvtime_le(struct vnt_private *priv,\r\nu8 rsv_type, u8 pkt_type, u32 frame_length, u16 current_rate)\r\n{\r\nu32 rrv_time, rts_time, cts_time, ack_time, data_time;\r\nrrv_time = rts_time = cts_time = ack_time = data_time = 0;\r\ndata_time = vnt_get_frame_time(priv->preamble_type, pkt_type,\r\nframe_length, current_rate);\r\nif (rsv_type == 0) {\r\nrts_time = vnt_get_frame_time(priv->preamble_type,\r\npkt_type, 20, priv->top_cck_basic_rate);\r\ncts_time = ack_time = vnt_get_frame_time(priv->preamble_type,\r\npkt_type, 14, priv->top_cck_basic_rate);\r\n} else if (rsv_type == 1) {\r\nrts_time = vnt_get_frame_time(priv->preamble_type,\r\npkt_type, 20, priv->top_cck_basic_rate);\r\ncts_time = vnt_get_frame_time(priv->preamble_type, pkt_type,\r\n14, priv->top_cck_basic_rate);\r\nack_time = vnt_get_frame_time(priv->preamble_type, pkt_type,\r\n14, priv->top_ofdm_basic_rate);\r\n} else if (rsv_type == 2) {\r\nrts_time = vnt_get_frame_time(priv->preamble_type, pkt_type,\r\n20, priv->top_ofdm_basic_rate);\r\ncts_time = ack_time = vnt_get_frame_time(priv->preamble_type,\r\npkt_type, 14, priv->top_ofdm_basic_rate);\r\n} else if (rsv_type == 3) {\r\ncts_time = vnt_get_frame_time(priv->preamble_type, pkt_type,\r\n14, priv->top_cck_basic_rate);\r\nack_time = vnt_get_frame_time(priv->preamble_type, pkt_type,\r\n14, priv->top_ofdm_basic_rate);\r\nrrv_time = cts_time + ack_time + data_time + 2 * priv->sifs;\r\nreturn cpu_to_le16((u16)rrv_time);\r\n}\r\nrrv_time = rts_time + cts_time + ack_time + data_time + 3 * priv->sifs;\r\nreturn cpu_to_le16((u16)rrv_time);\r\n}\r\nstatic __le16 vnt_get_duration_le(struct vnt_private *priv,\r\nu8 pkt_type, int need_ack)\r\n{\r\nu32 ack_time = 0;\r\nif (need_ack) {\r\nif (pkt_type == PK_TYPE_11B)\r\nack_time = vnt_get_frame_time(priv->preamble_type,\r\npkt_type, 14, priv->top_cck_basic_rate);\r\nelse\r\nack_time = vnt_get_frame_time(priv->preamble_type,\r\npkt_type, 14, priv->top_ofdm_basic_rate);\r\nreturn cpu_to_le16((u16)(priv->sifs + ack_time));\r\n}\r\nreturn 0;\r\n}\r\nstatic __le16 vnt_get_rtscts_duration_le(struct vnt_usb_send_context *context,\r\nu8 dur_type, u8 pkt_type, u16 rate)\r\n{\r\nstruct vnt_private *priv = context->priv;\r\nu32 cts_time = 0, dur_time = 0;\r\nu32 frame_length = context->frame_len;\r\nu8 need_ack = context->need_ack;\r\nswitch (dur_type) {\r\ncase RTSDUR_BB:\r\ncase RTSDUR_BA:\r\ncase RTSDUR_BA_F0:\r\ncase RTSDUR_BA_F1:\r\ncts_time = vnt_get_frame_time(priv->preamble_type,\r\npkt_type, 14, priv->top_cck_basic_rate);\r\ndur_time = cts_time + 2 * priv->sifs +\r\nvnt_get_rsvtime(priv, pkt_type,\r\nframe_length, rate, need_ack);\r\nbreak;\r\ncase RTSDUR_AA:\r\ncase RTSDUR_AA_F0:\r\ncase RTSDUR_AA_F1:\r\ncts_time = vnt_get_frame_time(priv->preamble_type,\r\npkt_type, 14, priv->top_ofdm_basic_rate);\r\ndur_time = cts_time + 2 * priv->sifs +\r\nvnt_get_rsvtime(priv, pkt_type,\r\nframe_length, rate, need_ack);\r\nbreak;\r\ncase CTSDUR_BA:\r\ncase CTSDUR_BA_F0:\r\ncase CTSDUR_BA_F1:\r\ndur_time = priv->sifs + vnt_get_rsvtime(priv,\r\npkt_type, frame_length, rate, need_ack);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn cpu_to_le16((u16)dur_time);\r\n}\r\nstatic u16 vnt_mac_hdr_pos(struct vnt_usb_send_context *tx_context,\r\nstruct ieee80211_hdr *hdr)\r\n{\r\nu8 *head = tx_context->data + offsetof(struct vnt_tx_buffer, fifo_head);\r\nu8 *hdr_pos = (u8 *)hdr;\r\ntx_context->hdr = hdr;\r\nif (!tx_context->hdr)\r\nreturn 0;\r\nreturn (u16)(hdr_pos - head);\r\n}\r\nstatic u16 vnt_rxtx_datahead_g(struct vnt_usb_send_context *tx_context,\r\nstruct vnt_tx_datahead_g *buf)\r\n{\r\nstruct vnt_private *priv = tx_context->priv;\r\nstruct ieee80211_hdr *hdr =\r\n(struct ieee80211_hdr *)tx_context->skb->data;\r\nu32 frame_len = tx_context->frame_len;\r\nu16 rate = tx_context->tx_rate;\r\nu8 need_ack = tx_context->need_ack;\r\nvnt_get_phy_field(priv, frame_len, rate, tx_context->pkt_type, &buf->a);\r\nvnt_get_phy_field(priv, frame_len, priv->top_cck_basic_rate,\r\nPK_TYPE_11B, &buf->b);\r\nif (ieee80211_is_pspoll(hdr->frame_control)) {\r\n__le16 dur = cpu_to_le16(priv->current_aid | BIT(14) | BIT(15));\r\nbuf->duration_a = dur;\r\nbuf->duration_b = dur;\r\n} else {\r\nbuf->duration_a = vnt_get_duration_le(priv,\r\ntx_context->pkt_type, need_ack);\r\nbuf->duration_b = vnt_get_duration_le(priv,\r\nPK_TYPE_11B, need_ack);\r\n}\r\nbuf->time_stamp_off_a = vnt_time_stamp_off(priv, rate);\r\nbuf->time_stamp_off_b = vnt_time_stamp_off(priv,\r\npriv->top_cck_basic_rate);\r\ntx_context->tx_hdr_size = vnt_mac_hdr_pos(tx_context, &buf->hdr);\r\nreturn le16_to_cpu(buf->duration_a);\r\n}\r\nstatic u16 vnt_rxtx_datahead_g_fb(struct vnt_usb_send_context *tx_context,\r\nstruct vnt_tx_datahead_g_fb *buf)\r\n{\r\nstruct vnt_private *priv = tx_context->priv;\r\nu32 frame_len = tx_context->frame_len;\r\nu16 rate = tx_context->tx_rate;\r\nu8 need_ack = tx_context->need_ack;\r\nvnt_get_phy_field(priv, frame_len, rate, tx_context->pkt_type, &buf->a);\r\nvnt_get_phy_field(priv, frame_len, priv->top_cck_basic_rate,\r\nPK_TYPE_11B, &buf->b);\r\nbuf->duration_a = vnt_get_duration_le(priv, tx_context->pkt_type,\r\nneed_ack);\r\nbuf->duration_b = vnt_get_duration_le(priv, PK_TYPE_11B, need_ack);\r\nbuf->duration_a_f0 = vnt_get_duration_le(priv, tx_context->pkt_type,\r\nneed_ack);\r\nbuf->duration_a_f1 = vnt_get_duration_le(priv, tx_context->pkt_type,\r\nneed_ack);\r\nbuf->time_stamp_off_a = vnt_time_stamp_off(priv, rate);\r\nbuf->time_stamp_off_b = vnt_time_stamp_off(priv,\r\npriv->top_cck_basic_rate);\r\ntx_context->tx_hdr_size = vnt_mac_hdr_pos(tx_context, &buf->hdr);\r\nreturn le16_to_cpu(buf->duration_a);\r\n}\r\nstatic u16 vnt_rxtx_datahead_a_fb(struct vnt_usb_send_context *tx_context,\r\nstruct vnt_tx_datahead_a_fb *buf)\r\n{\r\nstruct vnt_private *priv = tx_context->priv;\r\nu16 rate = tx_context->tx_rate;\r\nu8 pkt_type = tx_context->pkt_type;\r\nu8 need_ack = tx_context->need_ack;\r\nu32 frame_len = tx_context->frame_len;\r\nvnt_get_phy_field(priv, frame_len, rate, pkt_type, &buf->a);\r\nbuf->duration = vnt_get_duration_le(priv, pkt_type, need_ack);\r\nbuf->duration_f0 = vnt_get_duration_le(priv, pkt_type, need_ack);\r\nbuf->duration_f1 = vnt_get_duration_le(priv, pkt_type, need_ack);\r\nbuf->time_stamp_off = vnt_time_stamp_off(priv, rate);\r\ntx_context->tx_hdr_size = vnt_mac_hdr_pos(tx_context, &buf->hdr);\r\nreturn le16_to_cpu(buf->duration);\r\n}\r\nstatic u16 vnt_rxtx_datahead_ab(struct vnt_usb_send_context *tx_context,\r\nstruct vnt_tx_datahead_ab *buf)\r\n{\r\nstruct vnt_private *priv = tx_context->priv;\r\nstruct ieee80211_hdr *hdr =\r\n(struct ieee80211_hdr *)tx_context->skb->data;\r\nu32 frame_len = tx_context->frame_len;\r\nu16 rate = tx_context->tx_rate;\r\nu8 need_ack = tx_context->need_ack;\r\nvnt_get_phy_field(priv, frame_len, rate,\r\ntx_context->pkt_type, &buf->ab);\r\nif (ieee80211_is_pspoll(hdr->frame_control)) {\r\n__le16 dur = cpu_to_le16(priv->current_aid | BIT(14) | BIT(15));\r\nbuf->duration = dur;\r\n} else {\r\nbuf->duration = vnt_get_duration_le(priv, tx_context->pkt_type,\r\nneed_ack);\r\n}\r\nbuf->time_stamp_off = vnt_time_stamp_off(priv, rate);\r\ntx_context->tx_hdr_size = vnt_mac_hdr_pos(tx_context, &buf->hdr);\r\nreturn le16_to_cpu(buf->duration);\r\n}\r\nstatic int vnt_fill_ieee80211_rts(struct vnt_usb_send_context *tx_context,\r\nstruct ieee80211_rts *rts, __le16 duration)\r\n{\r\nstruct ieee80211_hdr *hdr =\r\n(struct ieee80211_hdr *)tx_context->skb->data;\r\nrts->duration = duration;\r\nrts->frame_control =\r\ncpu_to_le16(IEEE80211_FTYPE_CTL | IEEE80211_STYPE_RTS);\r\nether_addr_copy(rts->ra, hdr->addr1);\r\nether_addr_copy(rts->ta, hdr->addr2);\r\nreturn 0;\r\n}\r\nstatic u16 vnt_rxtx_rts_g_head(struct vnt_usb_send_context *tx_context,\r\nstruct vnt_rts_g *buf)\r\n{\r\nstruct vnt_private *priv = tx_context->priv;\r\nu16 rts_frame_len = 20;\r\nu16 current_rate = tx_context->tx_rate;\r\nvnt_get_phy_field(priv, rts_frame_len, priv->top_cck_basic_rate,\r\nPK_TYPE_11B, &buf->b);\r\nvnt_get_phy_field(priv, rts_frame_len, priv->top_ofdm_basic_rate,\r\ntx_context->pkt_type, &buf->a);\r\nbuf->duration_bb = vnt_get_rtscts_duration_le(tx_context, RTSDUR_BB,\r\nPK_TYPE_11B,\r\npriv->top_cck_basic_rate);\r\nbuf->duration_aa = vnt_get_rtscts_duration_le(tx_context, RTSDUR_AA,\r\ntx_context->pkt_type,\r\ncurrent_rate);\r\nbuf->duration_ba = vnt_get_rtscts_duration_le(tx_context, RTSDUR_BA,\r\ntx_context->pkt_type,\r\ncurrent_rate);\r\nvnt_fill_ieee80211_rts(tx_context, &buf->data, buf->duration_aa);\r\nreturn vnt_rxtx_datahead_g(tx_context, &buf->data_head);\r\n}\r\nstatic u16 vnt_rxtx_rts_g_fb_head(struct vnt_usb_send_context *tx_context,\r\nstruct vnt_rts_g_fb *buf)\r\n{\r\nstruct vnt_private *priv = tx_context->priv;\r\nu16 current_rate = tx_context->tx_rate;\r\nu16 rts_frame_len = 20;\r\nvnt_get_phy_field(priv, rts_frame_len, priv->top_cck_basic_rate,\r\nPK_TYPE_11B, &buf->b);\r\nvnt_get_phy_field(priv, rts_frame_len, priv->top_ofdm_basic_rate,\r\ntx_context->pkt_type, &buf->a);\r\nbuf->duration_bb = vnt_get_rtscts_duration_le(tx_context, RTSDUR_BB,\r\nPK_TYPE_11B,\r\npriv->top_cck_basic_rate);\r\nbuf->duration_aa = vnt_get_rtscts_duration_le(tx_context, RTSDUR_AA,\r\ntx_context->pkt_type,\r\ncurrent_rate);\r\nbuf->duration_ba = vnt_get_rtscts_duration_le(tx_context, RTSDUR_BA,\r\ntx_context->pkt_type,\r\ncurrent_rate);\r\nbuf->rts_duration_ba_f0 =\r\nvnt_get_rtscts_duration_le(tx_context, RTSDUR_BA_F0,\r\ntx_context->pkt_type,\r\npriv->tx_rate_fb0);\r\nbuf->rts_duration_aa_f0 =\r\nvnt_get_rtscts_duration_le(tx_context, RTSDUR_AA_F0,\r\ntx_context->pkt_type,\r\npriv->tx_rate_fb0);\r\nbuf->rts_duration_ba_f1 =\r\nvnt_get_rtscts_duration_le(tx_context, RTSDUR_BA_F1,\r\ntx_context->pkt_type,\r\npriv->tx_rate_fb1);\r\nbuf->rts_duration_aa_f1 =\r\nvnt_get_rtscts_duration_le(tx_context, RTSDUR_AA_F1,\r\ntx_context->pkt_type,\r\npriv->tx_rate_fb1);\r\nvnt_fill_ieee80211_rts(tx_context, &buf->data, buf->duration_aa);\r\nreturn vnt_rxtx_datahead_g_fb(tx_context, &buf->data_head);\r\n}\r\nstatic u16 vnt_rxtx_rts_ab_head(struct vnt_usb_send_context *tx_context,\r\nstruct vnt_rts_ab *buf)\r\n{\r\nstruct vnt_private *priv = tx_context->priv;\r\nu16 current_rate = tx_context->tx_rate;\r\nu16 rts_frame_len = 20;\r\nvnt_get_phy_field(priv, rts_frame_len, priv->top_ofdm_basic_rate,\r\ntx_context->pkt_type, &buf->ab);\r\nbuf->duration = vnt_get_rtscts_duration_le(tx_context, RTSDUR_AA,\r\ntx_context->pkt_type,\r\ncurrent_rate);\r\nvnt_fill_ieee80211_rts(tx_context, &buf->data, buf->duration);\r\nreturn vnt_rxtx_datahead_ab(tx_context, &buf->data_head);\r\n}\r\nstatic u16 vnt_rxtx_rts_a_fb_head(struct vnt_usb_send_context *tx_context,\r\nstruct vnt_rts_a_fb *buf)\r\n{\r\nstruct vnt_private *priv = tx_context->priv;\r\nu16 current_rate = tx_context->tx_rate;\r\nu16 rts_frame_len = 20;\r\nvnt_get_phy_field(priv, rts_frame_len,\r\npriv->top_ofdm_basic_rate, tx_context->pkt_type, &buf->a);\r\nbuf->duration = vnt_get_rtscts_duration_le(tx_context, RTSDUR_AA,\r\ntx_context->pkt_type,\r\ncurrent_rate);\r\nbuf->rts_duration_f0 =\r\nvnt_get_rtscts_duration_le(tx_context, RTSDUR_AA_F0,\r\ntx_context->pkt_type,\r\npriv->tx_rate_fb0);\r\nbuf->rts_duration_f1 =\r\nvnt_get_rtscts_duration_le(tx_context, RTSDUR_AA_F1,\r\ntx_context->pkt_type,\r\npriv->tx_rate_fb1);\r\nvnt_fill_ieee80211_rts(tx_context, &buf->data, buf->duration);\r\nreturn vnt_rxtx_datahead_a_fb(tx_context, &buf->data_head);\r\n}\r\nstatic u16 vnt_fill_cts_fb_head(struct vnt_usb_send_context *tx_context,\r\nunion vnt_tx_data_head *head)\r\n{\r\nstruct vnt_private *priv = tx_context->priv;\r\nstruct vnt_cts_fb *buf = &head->cts_g_fb;\r\nu32 cts_frame_len = 14;\r\nu16 current_rate = tx_context->tx_rate;\r\nvnt_get_phy_field(priv, cts_frame_len, priv->top_cck_basic_rate,\r\nPK_TYPE_11B, &buf->b);\r\nbuf->duration_ba =\r\nvnt_get_rtscts_duration_le(tx_context, CTSDUR_BA,\r\ntx_context->pkt_type,\r\ncurrent_rate);\r\nbuf->cts_duration_ba_f0 =\r\nvnt_get_rtscts_duration_le(tx_context, CTSDUR_BA_F0,\r\ntx_context->pkt_type,\r\npriv->tx_rate_fb0);\r\nbuf->cts_duration_ba_f1 =\r\nvnt_get_rtscts_duration_le(tx_context, CTSDUR_BA_F1,\r\ntx_context->pkt_type,\r\npriv->tx_rate_fb1);\r\nbuf->data.duration = buf->duration_ba;\r\nbuf->data.frame_control =\r\ncpu_to_le16(IEEE80211_FTYPE_CTL | IEEE80211_STYPE_CTS);\r\nether_addr_copy(buf->data.ra, priv->current_net_addr);\r\nreturn vnt_rxtx_datahead_g_fb(tx_context, &buf->data_head);\r\n}\r\nstatic u16 vnt_fill_cts_head(struct vnt_usb_send_context *tx_context,\r\nunion vnt_tx_data_head *head)\r\n{\r\nstruct vnt_private *priv = tx_context->priv;\r\nstruct vnt_cts *buf = &head->cts_g;\r\nu32 cts_frame_len = 14;\r\nu16 current_rate = tx_context->tx_rate;\r\nvnt_get_phy_field(priv, cts_frame_len, priv->top_cck_basic_rate,\r\nPK_TYPE_11B, &buf->b);\r\nbuf->duration_ba =\r\nvnt_get_rtscts_duration_le(tx_context, CTSDUR_BA,\r\ntx_context->pkt_type,\r\ncurrent_rate);\r\nbuf->data.duration = buf->duration_ba;\r\nbuf->data.frame_control =\r\ncpu_to_le16(IEEE80211_FTYPE_CTL | IEEE80211_STYPE_CTS);\r\nether_addr_copy(buf->data.ra, priv->current_net_addr);\r\nreturn vnt_rxtx_datahead_g(tx_context, &buf->data_head);\r\n}\r\nstatic u16 vnt_rxtx_rts(struct vnt_usb_send_context *tx_context,\r\nunion vnt_tx_head *tx_head, bool need_mic)\r\n{\r\nstruct vnt_private *priv = tx_context->priv;\r\nstruct vnt_rrv_time_rts *buf = &tx_head->tx_rts.rts;\r\nunion vnt_tx_data_head *head = &tx_head->tx_rts.tx.head;\r\nu32 frame_len = tx_context->frame_len;\r\nu16 current_rate = tx_context->tx_rate;\r\nu8 need_ack = tx_context->need_ack;\r\nbuf->rts_rrv_time_aa = vnt_get_rtscts_rsvtime_le(priv, 2,\r\ntx_context->pkt_type, frame_len, current_rate);\r\nbuf->rts_rrv_time_ba = vnt_get_rtscts_rsvtime_le(priv, 1,\r\ntx_context->pkt_type, frame_len, current_rate);\r\nbuf->rts_rrv_time_bb = vnt_get_rtscts_rsvtime_le(priv, 0,\r\ntx_context->pkt_type, frame_len, current_rate);\r\nbuf->rrv_time_a = vnt_rxtx_rsvtime_le16(priv, tx_context->pkt_type,\r\nframe_len, current_rate,\r\nneed_ack);\r\nbuf->rrv_time_b = vnt_rxtx_rsvtime_le16(priv, PK_TYPE_11B, frame_len,\r\npriv->top_cck_basic_rate, need_ack);\r\nif (need_mic)\r\nhead = &tx_head->tx_rts.tx.mic.head;\r\nif (tx_context->fb_option)\r\nreturn vnt_rxtx_rts_g_fb_head(tx_context, &head->rts_g_fb);\r\nreturn vnt_rxtx_rts_g_head(tx_context, &head->rts_g);\r\n}\r\nstatic u16 vnt_rxtx_cts(struct vnt_usb_send_context *tx_context,\r\nunion vnt_tx_head *tx_head, bool need_mic)\r\n{\r\nstruct vnt_private *priv = tx_context->priv;\r\nstruct vnt_rrv_time_cts *buf = &tx_head->tx_cts.cts;\r\nunion vnt_tx_data_head *head = &tx_head->tx_cts.tx.head;\r\nu32 frame_len = tx_context->frame_len;\r\nu16 current_rate = tx_context->tx_rate;\r\nu8 need_ack = tx_context->need_ack;\r\nbuf->rrv_time_a = vnt_rxtx_rsvtime_le16(priv, tx_context->pkt_type,\r\nframe_len, current_rate, need_ack);\r\nbuf->rrv_time_b = vnt_rxtx_rsvtime_le16(priv, PK_TYPE_11B,\r\nframe_len, priv->top_cck_basic_rate, need_ack);\r\nbuf->cts_rrv_time_ba = vnt_get_rtscts_rsvtime_le(priv, 3,\r\ntx_context->pkt_type, frame_len, current_rate);\r\nif (need_mic)\r\nhead = &tx_head->tx_cts.tx.mic.head;\r\nif (tx_context->fb_option)\r\nreturn vnt_fill_cts_fb_head(tx_context, head);\r\nreturn vnt_fill_cts_head(tx_context, head);\r\n}\r\nstatic u16 vnt_rxtx_ab(struct vnt_usb_send_context *tx_context,\r\nunion vnt_tx_head *tx_head, bool need_rts, bool need_mic)\r\n{\r\nstruct vnt_private *priv = tx_context->priv;\r\nstruct vnt_rrv_time_ab *buf = &tx_head->tx_ab.ab;\r\nunion vnt_tx_data_head *head = &tx_head->tx_ab.tx.head;\r\nu32 frame_len = tx_context->frame_len;\r\nu16 current_rate = tx_context->tx_rate;\r\nu8 need_ack = tx_context->need_ack;\r\nbuf->rrv_time = vnt_rxtx_rsvtime_le16(priv, tx_context->pkt_type,\r\nframe_len, current_rate, need_ack);\r\nif (need_mic)\r\nhead = &tx_head->tx_ab.tx.mic.head;\r\nif (need_rts) {\r\nif (tx_context->pkt_type == PK_TYPE_11B)\r\nbuf->rts_rrv_time = vnt_get_rtscts_rsvtime_le(priv, 0,\r\ntx_context->pkt_type, frame_len, current_rate);\r\nelse\r\nbuf->rts_rrv_time = vnt_get_rtscts_rsvtime_le(priv, 2,\r\ntx_context->pkt_type, frame_len, current_rate);\r\nif (tx_context->fb_option &&\r\ntx_context->pkt_type == PK_TYPE_11A)\r\nreturn vnt_rxtx_rts_a_fb_head(tx_context,\r\n&head->rts_a_fb);\r\nreturn vnt_rxtx_rts_ab_head(tx_context, &head->rts_ab);\r\n}\r\nif (tx_context->pkt_type == PK_TYPE_11A)\r\nreturn vnt_rxtx_datahead_a_fb(tx_context,\r\n&head->data_head_a_fb);\r\nreturn vnt_rxtx_datahead_ab(tx_context, &head->data_head_ab);\r\n}\r\nstatic u16 vnt_generate_tx_parameter(struct vnt_usb_send_context *tx_context,\r\nstruct vnt_tx_buffer *tx_buffer,\r\nstruct vnt_mic_hdr **mic_hdr, u32 need_mic,\r\nbool need_rts)\r\n{\r\nif (tx_context->pkt_type == PK_TYPE_11GB ||\r\ntx_context->pkt_type == PK_TYPE_11GA) {\r\nif (need_rts) {\r\nif (need_mic)\r\n*mic_hdr = &tx_buffer->\r\ntx_head.tx_rts.tx.mic.hdr;\r\nreturn vnt_rxtx_rts(tx_context, &tx_buffer->tx_head,\r\nneed_mic);\r\n}\r\nif (need_mic)\r\n*mic_hdr = &tx_buffer->tx_head.tx_cts.tx.mic.hdr;\r\nreturn vnt_rxtx_cts(tx_context, &tx_buffer->tx_head, need_mic);\r\n}\r\nif (need_mic)\r\n*mic_hdr = &tx_buffer->tx_head.tx_ab.tx.mic.hdr;\r\nreturn vnt_rxtx_ab(tx_context, &tx_buffer->tx_head, need_rts, need_mic);\r\n}\r\nstatic void vnt_fill_txkey(struct vnt_usb_send_context *tx_context,\r\nu8 *key_buffer, struct ieee80211_key_conf *tx_key, struct sk_buff *skb,\r\nu16 payload_len, struct vnt_mic_hdr *mic_hdr)\r\n{\r\nstruct ieee80211_hdr *hdr = tx_context->hdr;\r\nu64 pn64;\r\nu8 *iv = ((u8 *)hdr + ieee80211_get_hdrlen_from_skb(skb));\r\npayload_len -= ieee80211_get_hdrlen_from_skb(skb);\r\npayload_len -= tx_key->icv_len;\r\nswitch (tx_key->cipher) {\r\ncase WLAN_CIPHER_SUITE_WEP40:\r\ncase WLAN_CIPHER_SUITE_WEP104:\r\nmemcpy(key_buffer, iv, 3);\r\nmemcpy(key_buffer + 3, tx_key->key, tx_key->keylen);\r\nif (tx_key->keylen == WLAN_KEY_LEN_WEP40) {\r\nmemcpy(key_buffer + 8, iv, 3);\r\nmemcpy(key_buffer + 11,\r\ntx_key->key, WLAN_KEY_LEN_WEP40);\r\n}\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_TKIP:\r\nieee80211_get_tkip_p2k(tx_key, skb, key_buffer);\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_CCMP:\r\nif (!mic_hdr)\r\nreturn;\r\nmic_hdr->id = 0x59;\r\nmic_hdr->payload_len = cpu_to_be16(payload_len);\r\nether_addr_copy(mic_hdr->mic_addr2, hdr->addr2);\r\npn64 = atomic64_read(&tx_key->tx_pn);\r\nmic_hdr->ccmp_pn[5] = pn64;\r\nmic_hdr->ccmp_pn[4] = pn64 >> 8;\r\nmic_hdr->ccmp_pn[3] = pn64 >> 16;\r\nmic_hdr->ccmp_pn[2] = pn64 >> 24;\r\nmic_hdr->ccmp_pn[1] = pn64 >> 32;\r\nmic_hdr->ccmp_pn[0] = pn64 >> 40;\r\nif (ieee80211_has_a4(hdr->frame_control))\r\nmic_hdr->hlen = cpu_to_be16(28);\r\nelse\r\nmic_hdr->hlen = cpu_to_be16(22);\r\nether_addr_copy(mic_hdr->addr1, hdr->addr1);\r\nether_addr_copy(mic_hdr->addr2, hdr->addr2);\r\nether_addr_copy(mic_hdr->addr3, hdr->addr3);\r\nmic_hdr->frame_control = cpu_to_le16(\r\nle16_to_cpu(hdr->frame_control) & 0xc78f);\r\nmic_hdr->seq_ctrl = cpu_to_le16(\r\nle16_to_cpu(hdr->seq_ctrl) & 0xf);\r\nif (ieee80211_has_a4(hdr->frame_control))\r\nether_addr_copy(mic_hdr->addr4, hdr->addr4);\r\nmemcpy(key_buffer, tx_key->key, WLAN_KEY_LEN_CCMP);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nint vnt_tx_packet(struct vnt_private *priv, struct sk_buff *skb)\r\n{\r\nstruct ieee80211_tx_info *info = IEEE80211_SKB_CB(skb);\r\nstruct ieee80211_tx_rate *tx_rate = &info->control.rates[0];\r\nstruct ieee80211_rate *rate;\r\nstruct ieee80211_key_conf *tx_key;\r\nstruct ieee80211_hdr *hdr;\r\nstruct vnt_mic_hdr *mic_hdr = NULL;\r\nstruct vnt_tx_buffer *tx_buffer;\r\nstruct vnt_tx_fifo_head *tx_buffer_head;\r\nstruct vnt_usb_send_context *tx_context;\r\nunsigned long flags;\r\nu16 tx_bytes, tx_header_size, tx_body_size, current_rate, duration_id;\r\nu8 pkt_type, fb_option = AUTO_FB_NONE;\r\nbool need_rts = false, is_pspoll = false;\r\nbool need_mic = false;\r\nhdr = (struct ieee80211_hdr *)(skb->data);\r\nrate = ieee80211_get_tx_rate(priv->hw, info);\r\ncurrent_rate = rate->hw_value;\r\nif (priv->current_rate != current_rate &&\r\n!(priv->hw->conf.flags & IEEE80211_CONF_OFFCHANNEL)) {\r\npriv->current_rate = current_rate;\r\nvnt_schedule_command(priv, WLAN_CMD_SETPOWER);\r\n}\r\nif (current_rate > RATE_11M) {\r\nif (info->band == NL80211_BAND_5GHZ) {\r\npkt_type = PK_TYPE_11A;\r\n} else {\r\nif (tx_rate->flags & IEEE80211_TX_RC_USE_CTS_PROTECT)\r\npkt_type = PK_TYPE_11GB;\r\nelse\r\npkt_type = PK_TYPE_11GA;\r\n}\r\n} else {\r\npkt_type = PK_TYPE_11B;\r\n}\r\nspin_lock_irqsave(&priv->lock, flags);\r\ntx_context = vnt_get_free_context(priv);\r\nif (!tx_context) {\r\ndev_dbg(&priv->usb->dev, "%s No free context\n", __func__);\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nreturn -ENOMEM;\r\n}\r\ntx_context->skb = skb;\r\ntx_context->pkt_type = pkt_type;\r\ntx_context->need_ack = false;\r\ntx_context->frame_len = skb->len + 4;\r\ntx_context->tx_rate = current_rate;\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\ntx_buffer = (struct vnt_tx_buffer *)tx_context->data;\r\ntx_buffer_head = &tx_buffer->fifo_head;\r\ntx_body_size = skb->len;\r\nif (pkt_type == PK_TYPE_11A)\r\ntx_buffer_head->fifo_ctl = 0;\r\nelse if (pkt_type == PK_TYPE_11B)\r\ntx_buffer_head->fifo_ctl = cpu_to_le16(FIFOCTL_11B);\r\nelse if (pkt_type == PK_TYPE_11GB)\r\ntx_buffer_head->fifo_ctl = cpu_to_le16(FIFOCTL_11GB);\r\nelse if (pkt_type == PK_TYPE_11GA)\r\ntx_buffer_head->fifo_ctl = cpu_to_le16(FIFOCTL_11GA);\r\nif (!ieee80211_is_data(hdr->frame_control)) {\r\ntx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_GENINT |\r\nFIFOCTL_ISDMA0);\r\ntx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_TMOEN);\r\ntx_buffer_head->time_stamp =\r\ncpu_to_le16(DEFAULT_MGN_LIFETIME_RES_64us);\r\n} else {\r\ntx_buffer_head->time_stamp =\r\ncpu_to_le16(DEFAULT_MSDU_LIFETIME_RES_64us);\r\n}\r\nif (!(info->flags & IEEE80211_TX_CTL_NO_ACK)) {\r\ntx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_NEEDACK);\r\ntx_context->need_ack = true;\r\n}\r\nif (ieee80211_has_retry(hdr->frame_control))\r\ntx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_LRETRY);\r\nif (tx_rate->flags & IEEE80211_TX_RC_USE_SHORT_PREAMBLE)\r\npriv->preamble_type = PREAMBLE_SHORT;\r\nelse\r\npriv->preamble_type = PREAMBLE_LONG;\r\nif (tx_rate->flags & IEEE80211_TX_RC_USE_RTS_CTS) {\r\nneed_rts = true;\r\ntx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_RTS);\r\n}\r\nif (ieee80211_has_a4(hdr->frame_control))\r\ntx_buffer_head->fifo_ctl |= cpu_to_le16(FIFOCTL_LHEAD);\r\nif (info->flags & IEEE80211_TX_CTL_NO_PS_BUFFER)\r\nis_pspoll = true;\r\ntx_buffer_head->frag_ctl =\r\ncpu_to_le16(ieee80211_get_hdrlen_from_skb(skb) << 10);\r\nif (info->control.hw_key) {\r\ntx_key = info->control.hw_key;\r\nswitch (info->control.hw_key->cipher) {\r\ncase WLAN_CIPHER_SUITE_WEP40:\r\ncase WLAN_CIPHER_SUITE_WEP104:\r\ntx_buffer_head->frag_ctl |= cpu_to_le16(FRAGCTL_LEGACY);\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_TKIP:\r\ntx_buffer_head->frag_ctl |= cpu_to_le16(FRAGCTL_TKIP);\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_CCMP:\r\ntx_buffer_head->frag_ctl |= cpu_to_le16(FRAGCTL_AES);\r\nneed_mic = true;\r\ndefault:\r\nbreak;\r\n}\r\ntx_context->frame_len += tx_key->icv_len;\r\n}\r\ntx_buffer_head->current_rate = cpu_to_le16(current_rate);\r\nif (current_rate >= RATE_18M && ieee80211_is_data(hdr->frame_control)) {\r\nif (priv->auto_fb_ctrl == AUTO_FB_0) {\r\ntx_buffer_head->fifo_ctl |=\r\ncpu_to_le16(FIFOCTL_AUTO_FB_0);\r\npriv->tx_rate_fb0 =\r\nvnt_fb_opt0[FB_RATE0][current_rate - RATE_18M];\r\npriv->tx_rate_fb1 =\r\nvnt_fb_opt0[FB_RATE1][current_rate - RATE_18M];\r\nfb_option = AUTO_FB_0;\r\n} else if (priv->auto_fb_ctrl == AUTO_FB_1) {\r\ntx_buffer_head->fifo_ctl |=\r\ncpu_to_le16(FIFOCTL_AUTO_FB_1);\r\npriv->tx_rate_fb0 =\r\nvnt_fb_opt1[FB_RATE0][current_rate - RATE_18M];\r\npriv->tx_rate_fb1 =\r\nvnt_fb_opt1[FB_RATE1][current_rate - RATE_18M];\r\nfb_option = AUTO_FB_1;\r\n}\r\n}\r\ntx_context->fb_option = fb_option;\r\nduration_id = vnt_generate_tx_parameter(tx_context, tx_buffer, &mic_hdr,\r\nneed_mic, need_rts);\r\ntx_header_size = tx_context->tx_hdr_size;\r\nif (!tx_header_size) {\r\ntx_context->in_use = false;\r\nreturn -ENOMEM;\r\n}\r\ntx_buffer_head->frag_ctl |= cpu_to_le16(FRAGCTL_NONFRAG);\r\ntx_bytes = tx_header_size + tx_body_size;\r\nmemcpy(tx_context->hdr, skb->data, tx_body_size);\r\nhdr->duration_id = cpu_to_le16(duration_id);\r\nif (info->control.hw_key) {\r\ntx_key = info->control.hw_key;\r\nif (tx_key->keylen > 0)\r\nvnt_fill_txkey(tx_context, tx_buffer_head->tx_key,\r\ntx_key, skb, tx_body_size, mic_hdr);\r\n}\r\npriv->seq_counter = (le16_to_cpu(hdr->seq_ctrl) &\r\nIEEE80211_SCTL_SEQ) >> 4;\r\ntx_buffer->tx_byte_count = cpu_to_le16(tx_bytes);\r\ntx_buffer->pkt_no = tx_context->pkt_no;\r\ntx_buffer->type = 0x00;\r\ntx_bytes += 4;\r\ntx_context->type = CONTEXT_DATA_PACKET;\r\ntx_context->buf_len = tx_bytes;\r\nspin_lock_irqsave(&priv->lock, flags);\r\nif (vnt_tx_context(priv, tx_context) != STATUS_PENDING) {\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nreturn -EIO;\r\n}\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int vnt_beacon_xmit(struct vnt_private *priv,\r\nstruct sk_buff *skb)\r\n{\r\nstruct vnt_beacon_buffer *beacon_buffer;\r\nstruct vnt_tx_short_buf_head *short_head;\r\nstruct ieee80211_tx_info *info;\r\nstruct vnt_usb_send_context *context;\r\nstruct ieee80211_mgmt *mgmt_hdr;\r\nunsigned long flags;\r\nu32 frame_size = skb->len + 4;\r\nu16 current_rate, count;\r\nspin_lock_irqsave(&priv->lock, flags);\r\ncontext = vnt_get_free_context(priv);\r\nif (!context) {\r\ndev_dbg(&priv->usb->dev, "%s No free context!\n", __func__);\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nreturn -ENOMEM;\r\n}\r\ncontext->skb = skb;\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nbeacon_buffer = (struct vnt_beacon_buffer *)&context->data[0];\r\nshort_head = &beacon_buffer->short_head;\r\nif (priv->bb_type == BB_TYPE_11A) {\r\ncurrent_rate = RATE_6M;\r\nvnt_get_phy_field(priv, frame_size, current_rate,\r\nPK_TYPE_11A, &short_head->ab);\r\nshort_head->duration = vnt_get_duration_le(priv,\r\nPK_TYPE_11A, false);\r\nshort_head->time_stamp_off =\r\nvnt_time_stamp_off(priv, current_rate);\r\n} else {\r\ncurrent_rate = RATE_1M;\r\nshort_head->fifo_ctl |= cpu_to_le16(FIFOCTL_11B);\r\nvnt_get_phy_field(priv, frame_size, current_rate,\r\nPK_TYPE_11B, &short_head->ab);\r\nshort_head->duration = vnt_get_duration_le(priv,\r\nPK_TYPE_11B, false);\r\nshort_head->time_stamp_off =\r\nvnt_time_stamp_off(priv, current_rate);\r\n}\r\nmgmt_hdr = &beacon_buffer->mgmt_hdr;\r\nmemcpy(mgmt_hdr, skb->data, skb->len);\r\nmgmt_hdr->u.beacon.timestamp = 0;\r\ninfo = IEEE80211_SKB_CB(skb);\r\nif (info->flags & IEEE80211_TX_CTL_ASSIGN_SEQ) {\r\nstruct ieee80211_hdr *hdr = (struct ieee80211_hdr *)mgmt_hdr;\r\nhdr->duration_id = 0;\r\nhdr->seq_ctrl = cpu_to_le16(priv->seq_counter << 4);\r\n}\r\npriv->seq_counter++;\r\nif (priv->seq_counter > 0x0fff)\r\npriv->seq_counter = 0;\r\ncount = sizeof(struct vnt_tx_short_buf_head) + skb->len;\r\nbeacon_buffer->tx_byte_count = cpu_to_le16(count);\r\nbeacon_buffer->pkt_no = context->pkt_no;\r\nbeacon_buffer->type = 0x01;\r\ncontext->type = CONTEXT_BEACON_PACKET;\r\ncontext->buf_len = count + 4;\r\nspin_lock_irqsave(&priv->lock, flags);\r\nif (vnt_tx_context(priv, context) != STATUS_PENDING)\r\nieee80211_free_txskb(priv->hw, context->skb);\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nreturn 0;\r\n}\r\nint vnt_beacon_make(struct vnt_private *priv, struct ieee80211_vif *vif)\r\n{\r\nstruct sk_buff *beacon;\r\nbeacon = ieee80211_beacon_get(priv->hw, vif);\r\nif (!beacon)\r\nreturn -ENOMEM;\r\nif (vnt_beacon_xmit(priv, beacon)) {\r\nieee80211_free_txskb(priv->hw, beacon);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nint vnt_beacon_enable(struct vnt_private *priv, struct ieee80211_vif *vif,\r\nstruct ieee80211_bss_conf *conf)\r\n{\r\nvnt_mac_reg_bits_off(priv, MAC_REG_TCR, TCR_AUTOBCNTX);\r\nvnt_mac_reg_bits_off(priv, MAC_REG_TFTCTL, TFTCTL_TSFCNTREN);\r\nvnt_mac_set_beacon_interval(priv, conf->beacon_int);\r\nvnt_clear_current_tsf(priv);\r\nvnt_mac_reg_bits_on(priv, MAC_REG_TFTCTL, TFTCTL_TSFCNTREN);\r\nvnt_reset_next_tbtt(priv, conf->beacon_int);\r\nreturn vnt_beacon_make(priv, vif);\r\n}

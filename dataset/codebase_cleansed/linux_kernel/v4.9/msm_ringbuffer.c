struct msm_ringbuffer *msm_ringbuffer_new(struct msm_gpu *gpu, int size)\r\n{\r\nstruct msm_ringbuffer *ring;\r\nint ret;\r\nsize = ALIGN(size, 4);\r\nring = kzalloc(sizeof(*ring), GFP_KERNEL);\r\nif (!ring) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\nring->gpu = gpu;\r\nring->bo = msm_gem_new(gpu->dev, size, MSM_BO_WC);\r\nif (IS_ERR(ring->bo)) {\r\nret = PTR_ERR(ring->bo);\r\nring->bo = NULL;\r\ngoto fail;\r\n}\r\nring->start = msm_gem_get_vaddr_locked(ring->bo);\r\nif (IS_ERR(ring->start)) {\r\nret = PTR_ERR(ring->start);\r\ngoto fail;\r\n}\r\nring->end = ring->start + (size / 4);\r\nring->cur = ring->start;\r\nring->size = size;\r\nreturn ring;\r\nfail:\r\nif (ring)\r\nmsm_ringbuffer_destroy(ring);\r\nreturn ERR_PTR(ret);\r\n}\r\nvoid msm_ringbuffer_destroy(struct msm_ringbuffer *ring)\r\n{\r\nif (ring->bo) {\r\nmsm_gem_put_vaddr(ring->bo);\r\ndrm_gem_object_unreference_unlocked(ring->bo);\r\n}\r\nkfree(ring);\r\n}

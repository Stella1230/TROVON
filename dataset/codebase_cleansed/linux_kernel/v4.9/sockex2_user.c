int main(int ac, char **argv)\r\n{\r\nstruct rlimit r = {RLIM_INFINITY, RLIM_INFINITY};\r\nchar filename[256];\r\nFILE *f;\r\nint i, sock;\r\nsnprintf(filename, sizeof(filename), "%s_kern.o", argv[0]);\r\nsetrlimit(RLIMIT_MEMLOCK, &r);\r\nif (load_bpf_file(filename)) {\r\nprintf("%s", bpf_log_buf);\r\nreturn 1;\r\n}\r\nsock = open_raw_sock("lo");\r\nassert(setsockopt(sock, SOL_SOCKET, SO_ATTACH_BPF, prog_fd,\r\nsizeof(prog_fd[0])) == 0);\r\nf = popen("ping -c5 localhost", "r");\r\n(void) f;\r\nfor (i = 0; i < 5; i++) {\r\nint key = 0, next_key;\r\nstruct pair value;\r\nwhile (bpf_get_next_key(map_fd[0], &key, &next_key) == 0) {\r\nbpf_lookup_elem(map_fd[0], &next_key, &value);\r\nprintf("ip %s bytes %lld packets %lld\n",\r\ninet_ntoa((struct in_addr){htonl(next_key)}),\r\nvalue.bytes, value.packets);\r\nkey = next_key;\r\n}\r\nsleep(1);\r\n}\r\nreturn 0;\r\n}

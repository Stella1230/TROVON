static int mmio_74xx_get_direction(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct mmio_74xx_gpio_priv *priv = gpiochip_get_data(gc);\r\nreturn !(priv->flags & MMIO_74XX_DIR_OUT);\r\n}\r\nstatic int mmio_74xx_dir_in(struct gpio_chip *gc, unsigned int gpio)\r\n{\r\nstruct mmio_74xx_gpio_priv *priv = gpiochip_get_data(gc);\r\nreturn (priv->flags & MMIO_74XX_DIR_OUT) ? -ENOTSUPP : 0;\r\n}\r\nstatic int mmio_74xx_dir_out(struct gpio_chip *gc, unsigned int gpio, int val)\r\n{\r\nstruct mmio_74xx_gpio_priv *priv = gpiochip_get_data(gc);\r\nif (priv->flags & MMIO_74XX_DIR_OUT) {\r\ngc->set(gc, gpio, val);\r\nreturn 0;\r\n}\r\nreturn -ENOTSUPP;\r\n}\r\nstatic int mmio_74xx_gpio_probe(struct platform_device *pdev)\r\n{\r\nconst struct of_device_id *of_id;\r\nstruct mmio_74xx_gpio_priv *priv;\r\nstruct resource *res;\r\nvoid __iomem *dat;\r\nint err;\r\nof_id = of_match_device(mmio_74xx_gpio_ids, &pdev->dev);\r\nif (!of_id)\r\nreturn -ENODEV;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndat = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(dat))\r\nreturn PTR_ERR(dat);\r\npriv->flags = (uintptr_t) of_id->data;\r\nerr = bgpio_init(&priv->gc, &pdev->dev,\r\nDIV_ROUND_UP(MMIO_74XX_BIT_CNT(priv->flags), 8),\r\ndat, NULL, NULL, NULL, NULL, 0);\r\nif (err)\r\nreturn err;\r\npriv->gc.direction_input = mmio_74xx_dir_in;\r\npriv->gc.direction_output = mmio_74xx_dir_out;\r\npriv->gc.get_direction = mmio_74xx_get_direction;\r\npriv->gc.ngpio = MMIO_74XX_BIT_CNT(priv->flags);\r\npriv->gc.owner = THIS_MODULE;\r\nplatform_set_drvdata(pdev, priv);\r\nreturn devm_gpiochip_add_data(&pdev->dev, &priv->gc, priv);\r\n}

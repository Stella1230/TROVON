int gzip_decompress_to_file(const char *input, int output_fd)\r\n{\r\nint ret = Z_STREAM_ERROR;\r\nint input_fd;\r\nvoid *ptr;\r\nint len;\r\nstruct stat stbuf;\r\nunsigned char buf[CHUNK_SIZE];\r\nz_stream zs = {\r\n.zalloc = Z_NULL,\r\n.zfree = Z_NULL,\r\n.opaque = Z_NULL,\r\n.avail_in = 0,\r\n.next_in = Z_NULL,\r\n};\r\ninput_fd = open(input, O_RDONLY);\r\nif (input_fd < 0)\r\nreturn -1;\r\nif (fstat(input_fd, &stbuf) < 0)\r\ngoto out_close;\r\nptr = mmap(NULL, stbuf.st_size, PROT_READ, MAP_PRIVATE, input_fd, 0);\r\nif (ptr == MAP_FAILED)\r\ngoto out_close;\r\nif (inflateInit2(&zs, 16 + MAX_WBITS) != Z_OK)\r\ngoto out_unmap;\r\nzs.next_in = ptr;\r\nzs.avail_in = stbuf.st_size;\r\ndo {\r\nzs.next_out = buf;\r\nzs.avail_out = CHUNK_SIZE;\r\nret = inflate(&zs, Z_NO_FLUSH);\r\nswitch (ret) {\r\ncase Z_NEED_DICT:\r\nret = Z_DATA_ERROR;\r\ncase Z_DATA_ERROR:\r\ncase Z_MEM_ERROR:\r\ngoto out;\r\ndefault:\r\nbreak;\r\n}\r\nlen = CHUNK_SIZE - zs.avail_out;\r\nif (writen(output_fd, buf, len) != len) {\r\nret = Z_DATA_ERROR;\r\ngoto out;\r\n}\r\n} while (ret != Z_STREAM_END);\r\nout:\r\ninflateEnd(&zs);\r\nout_unmap:\r\nmunmap(ptr, stbuf.st_size);\r\nout_close:\r\nclose(input_fd);\r\nreturn ret == Z_STREAM_END ? 0 : -1;\r\n}

int speakup_add_virtual_keyboard(void)\r\n{\r\nint err;\r\nvirt_keyboard = input_allocate_device();\r\nif (!virt_keyboard)\r\nreturn -ENOMEM;\r\nvirt_keyboard->name = "Speakup";\r\nvirt_keyboard->id.bustype = BUS_VIRTUAL;\r\nvirt_keyboard->phys = "speakup/input0";\r\nvirt_keyboard->dev.parent = NULL;\r\n__set_bit(EV_KEY, virt_keyboard->evbit);\r\n__set_bit(KEY_DOWN, virt_keyboard->keybit);\r\nerr = input_register_device(virt_keyboard);\r\nif (err) {\r\ninput_free_device(virt_keyboard);\r\nvirt_keyboard = NULL;\r\n}\r\nreturn err;\r\n}\r\nvoid speakup_remove_virtual_keyboard(void)\r\n{\r\nif (virt_keyboard != NULL) {\r\ninput_unregister_device(virt_keyboard);\r\nvirt_keyboard = NULL;\r\n}\r\n}\r\nvoid speakup_fake_down_arrow(void)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\npreempt_disable();\r\n__this_cpu_write(reporting_keystroke, true);\r\ninput_report_key(virt_keyboard, KEY_DOWN, PRESSED);\r\ninput_report_key(virt_keyboard, KEY_DOWN, RELEASED);\r\ninput_sync(virt_keyboard);\r\n__this_cpu_write(reporting_keystroke, false);\r\npreempt_enable();\r\nlocal_irq_restore(flags);\r\n}\r\nbool speakup_fake_key_pressed(void)\r\n{\r\nreturn this_cpu_read(reporting_keystroke);\r\n}

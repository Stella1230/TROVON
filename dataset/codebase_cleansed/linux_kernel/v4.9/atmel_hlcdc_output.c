static inline struct atmel_hlcdc_rgb_output *\r\ndrm_connector_to_atmel_hlcdc_rgb_output(struct drm_connector *connector)\r\n{\r\nreturn container_of(connector, struct atmel_hlcdc_rgb_output,\r\nconnector);\r\n}\r\nstatic inline struct atmel_hlcdc_rgb_output *\r\ndrm_encoder_to_atmel_hlcdc_rgb_output(struct drm_encoder *encoder)\r\n{\r\nreturn container_of(encoder, struct atmel_hlcdc_rgb_output, encoder);\r\n}\r\nstatic void atmel_hlcdc_rgb_encoder_enable(struct drm_encoder *encoder)\r\n{\r\nstruct atmel_hlcdc_rgb_output *rgb =\r\ndrm_encoder_to_atmel_hlcdc_rgb_output(encoder);\r\nif (rgb->panel) {\r\ndrm_panel_prepare(rgb->panel);\r\ndrm_panel_enable(rgb->panel);\r\n}\r\n}\r\nstatic void atmel_hlcdc_rgb_encoder_disable(struct drm_encoder *encoder)\r\n{\r\nstruct atmel_hlcdc_rgb_output *rgb =\r\ndrm_encoder_to_atmel_hlcdc_rgb_output(encoder);\r\nif (rgb->panel) {\r\ndrm_panel_disable(rgb->panel);\r\ndrm_panel_unprepare(rgb->panel);\r\n}\r\n}\r\nstatic void atmel_hlcdc_rgb_encoder_destroy(struct drm_encoder *encoder)\r\n{\r\ndrm_encoder_cleanup(encoder);\r\nmemset(encoder, 0, sizeof(*encoder));\r\n}\r\nstatic int atmel_hlcdc_panel_get_modes(struct drm_connector *connector)\r\n{\r\nstruct atmel_hlcdc_rgb_output *rgb =\r\ndrm_connector_to_atmel_hlcdc_rgb_output(connector);\r\nif (rgb->panel)\r\nreturn rgb->panel->funcs->get_modes(rgb->panel);\r\nreturn 0;\r\n}\r\nstatic int atmel_hlcdc_rgb_mode_valid(struct drm_connector *connector,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct atmel_hlcdc_rgb_output *rgb =\r\ndrm_connector_to_atmel_hlcdc_rgb_output(connector);\r\nreturn atmel_hlcdc_dc_mode_valid(rgb->dc, mode);\r\n}\r\nstatic enum drm_connector_status\r\natmel_hlcdc_panel_connector_detect(struct drm_connector *connector, bool force)\r\n{\r\nstruct atmel_hlcdc_rgb_output *rgb =\r\ndrm_connector_to_atmel_hlcdc_rgb_output(connector);\r\nif (rgb->panel)\r\nreturn connector_status_connected;\r\nreturn connector_status_disconnected;\r\n}\r\nstatic void\r\natmel_hlcdc_panel_connector_destroy(struct drm_connector *connector)\r\n{\r\nstruct atmel_hlcdc_rgb_output *rgb =\r\ndrm_connector_to_atmel_hlcdc_rgb_output(connector);\r\nif (rgb->panel)\r\ndrm_panel_detach(rgb->panel);\r\ndrm_connector_cleanup(connector);\r\n}\r\nstatic int atmel_hlcdc_check_endpoint(struct drm_device *dev,\r\nconst struct of_endpoint *ep)\r\n{\r\nstruct device_node *np;\r\nvoid *obj;\r\nnp = of_graph_get_remote_port_parent(ep->local_node);\r\nobj = of_drm_find_panel(np);\r\nif (!obj)\r\nobj = of_drm_find_bridge(np);\r\nof_node_put(np);\r\nreturn obj ? 0 : -EPROBE_DEFER;\r\n}\r\nstatic int atmel_hlcdc_attach_endpoint(struct drm_device *dev,\r\nconst struct of_endpoint *ep)\r\n{\r\nstruct atmel_hlcdc_dc *dc = dev->dev_private;\r\nstruct atmel_hlcdc_rgb_output *output;\r\nstruct device_node *np;\r\nstruct drm_panel *panel;\r\nstruct drm_bridge *bridge;\r\nint ret;\r\noutput = devm_kzalloc(dev->dev, sizeof(*output), GFP_KERNEL);\r\nif (!output)\r\nreturn -EINVAL;\r\noutput->dc = dc;\r\ndrm_encoder_helper_add(&output->encoder,\r\n&atmel_hlcdc_panel_encoder_helper_funcs);\r\nret = drm_encoder_init(dev, &output->encoder,\r\n&atmel_hlcdc_panel_encoder_funcs,\r\nDRM_MODE_ENCODER_NONE, NULL);\r\nif (ret)\r\nreturn ret;\r\noutput->encoder.possible_crtcs = 0x1;\r\nnp = of_graph_get_remote_port_parent(ep->local_node);\r\nret = -EPROBE_DEFER;\r\npanel = of_drm_find_panel(np);\r\nif (panel) {\r\nof_node_put(np);\r\noutput->connector.dpms = DRM_MODE_DPMS_OFF;\r\noutput->connector.polled = DRM_CONNECTOR_POLL_CONNECT;\r\ndrm_connector_helper_add(&output->connector,\r\n&atmel_hlcdc_panel_connector_helper_funcs);\r\nret = drm_connector_init(dev, &output->connector,\r\n&atmel_hlcdc_panel_connector_funcs,\r\nDRM_MODE_CONNECTOR_Unknown);\r\nif (ret)\r\ngoto err_encoder_cleanup;\r\ndrm_mode_connector_attach_encoder(&output->connector,\r\n&output->encoder);\r\nret = drm_panel_attach(panel, &output->connector);\r\nif (ret) {\r\ndrm_connector_cleanup(&output->connector);\r\ngoto err_encoder_cleanup;\r\n}\r\noutput->panel = panel;\r\nreturn 0;\r\n}\r\nbridge = of_drm_find_bridge(np);\r\nof_node_put(np);\r\nif (bridge) {\r\noutput->encoder.bridge = bridge;\r\nbridge->encoder = &output->encoder;\r\nret = drm_bridge_attach(dev, bridge);\r\nif (!ret)\r\nreturn 0;\r\n}\r\nerr_encoder_cleanup:\r\ndrm_encoder_cleanup(&output->encoder);\r\nreturn ret;\r\n}\r\nint atmel_hlcdc_create_outputs(struct drm_device *dev)\r\n{\r\nstruct device_node *ep_np = NULL;\r\nstruct of_endpoint ep;\r\nint ret;\r\nfor_each_endpoint_of_node(dev->dev->of_node, ep_np) {\r\nret = of_graph_parse_endpoint(ep_np, &ep);\r\nif (!ret)\r\nret = atmel_hlcdc_check_endpoint(dev, &ep);\r\nif (ret) {\r\nof_node_put(ep_np);\r\nreturn ret;\r\n}\r\n}\r\nfor_each_endpoint_of_node(dev->dev->of_node, ep_np) {\r\nret = of_graph_parse_endpoint(ep_np, &ep);\r\nif (!ret)\r\nret = atmel_hlcdc_attach_endpoint(dev, &ep);\r\nif (ret) {\r\nof_node_put(ep_np);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}

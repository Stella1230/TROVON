static int rockchip_emmc_phy_power(struct phy *phy, bool on_off)\r\n{\r\nstruct rockchip_emmc_phy *rk_phy = phy_get_drvdata(phy);\r\nunsigned int caldone;\r\nunsigned int dllrdy;\r\nunsigned int freqsel = PHYCTRL_FREQSEL_200M;\r\nunsigned long rate;\r\nunsigned long timeout;\r\nregmap_write(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_CON6,\r\nHIWORD_UPDATE(PHYCTRL_PDB_PWR_OFF,\r\nPHYCTRL_PDB_MASK,\r\nPHYCTRL_PDB_SHIFT));\r\nregmap_write(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_CON6,\r\nHIWORD_UPDATE(PHYCTRL_ENDLL_DISABLE,\r\nPHYCTRL_ENDLL_MASK,\r\nPHYCTRL_ENDLL_SHIFT));\r\nif (on_off == PHYCTRL_PDB_PWR_OFF)\r\nreturn 0;\r\nrate = clk_get_rate(rk_phy->emmcclk);\r\nif (rate != 0) {\r\nunsigned long ideal_rate;\r\nunsigned long diff;\r\nswitch (rate) {\r\ncase 1 ... 74999999:\r\nideal_rate = 50000000;\r\nfreqsel = PHYCTRL_FREQSEL_50M;\r\nbreak;\r\ncase 75000000 ... 124999999:\r\nideal_rate = 100000000;\r\nfreqsel = PHYCTRL_FREQSEL_100M;\r\nbreak;\r\ncase 125000000 ... 174999999:\r\nideal_rate = 150000000;\r\nfreqsel = PHYCTRL_FREQSEL_150M;\r\nbreak;\r\ndefault:\r\nideal_rate = 200000000;\r\nbreak;\r\n};\r\ndiff = (rate > ideal_rate) ?\r\nrate - ideal_rate : ideal_rate - rate;\r\nif ((rate > 50000000 && diff > 15000000) || (rate > 200000000))\r\ndev_warn(&phy->dev, "Unsupported rate: %lu\n", rate);\r\n}\r\nudelay(3);\r\nregmap_write(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_CON6,\r\nHIWORD_UPDATE(PHYCTRL_PDB_PWR_ON,\r\nPHYCTRL_PDB_MASK,\r\nPHYCTRL_PDB_SHIFT));\r\nudelay(5);\r\nregmap_read(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_STATUS,\r\n&caldone);\r\ncaldone = (caldone >> PHYCTRL_CALDONE_SHIFT) & PHYCTRL_CALDONE_MASK;\r\nif (caldone != PHYCTRL_CALDONE_DONE) {\r\npr_err("rockchip_emmc_phy_power: caldone timeout.\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nregmap_write(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_CON0,\r\nHIWORD_UPDATE(freqsel, PHYCTRL_FREQSEL_MASK,\r\nPHYCTRL_FREQSEL_SHIFT));\r\nregmap_write(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_CON6,\r\nHIWORD_UPDATE(PHYCTRL_ENDLL_ENABLE,\r\nPHYCTRL_ENDLL_MASK,\r\nPHYCTRL_ENDLL_SHIFT));\r\nif (rate == 0)\r\nreturn 0;\r\ntimeout = jiffies + msecs_to_jiffies(50);\r\ndo {\r\nudelay(1);\r\nregmap_read(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_STATUS,\r\n&dllrdy);\r\ndllrdy = (dllrdy >> PHYCTRL_DLLRDY_SHIFT) & PHYCTRL_DLLRDY_MASK;\r\nif (dllrdy == PHYCTRL_DLLRDY_DONE)\r\nbreak;\r\n} while (!time_after(jiffies, timeout));\r\nif (dllrdy != PHYCTRL_DLLRDY_DONE) {\r\npr_err("rockchip_emmc_phy_power: dllrdy timeout.\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rockchip_emmc_phy_init(struct phy *phy)\r\n{\r\nstruct rockchip_emmc_phy *rk_phy = phy_get_drvdata(phy);\r\nint ret = 0;\r\nrk_phy->emmcclk = clk_get(&phy->dev, "emmcclk");\r\nif (IS_ERR(rk_phy->emmcclk)) {\r\ndev_dbg(&phy->dev, "Error getting emmcclk: %d\n", ret);\r\nrk_phy->emmcclk = NULL;\r\n}\r\nreturn ret;\r\n}\r\nstatic int rockchip_emmc_phy_exit(struct phy *phy)\r\n{\r\nstruct rockchip_emmc_phy *rk_phy = phy_get_drvdata(phy);\r\nclk_put(rk_phy->emmcclk);\r\nreturn 0;\r\n}\r\nstatic int rockchip_emmc_phy_power_off(struct phy *phy)\r\n{\r\nreturn rockchip_emmc_phy_power(phy, PHYCTRL_PDB_PWR_OFF);\r\n}\r\nstatic int rockchip_emmc_phy_power_on(struct phy *phy)\r\n{\r\nstruct rockchip_emmc_phy *rk_phy = phy_get_drvdata(phy);\r\nregmap_write(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_CON6,\r\nHIWORD_UPDATE(PHYCTRL_DR_50OHM,\r\nPHYCTRL_DR_MASK,\r\nPHYCTRL_DR_SHIFT));\r\nregmap_write(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_CON0,\r\nHIWORD_UPDATE(PHYCTRL_OTAPDLYENA,\r\nPHYCTRL_OTAPDLYENA_MASK,\r\nPHYCTRL_OTAPDLYENA_SHIFT));\r\nregmap_write(rk_phy->reg_base,\r\nrk_phy->reg_offset + GRF_EMMCPHY_CON0,\r\nHIWORD_UPDATE(4,\r\nPHYCTRL_OTAPDLYSEL_MASK,\r\nPHYCTRL_OTAPDLYSEL_SHIFT));\r\nreturn rockchip_emmc_phy_power(phy, PHYCTRL_PDB_PWR_ON);\r\n}\r\nstatic int rockchip_emmc_phy_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct rockchip_emmc_phy *rk_phy;\r\nstruct phy *generic_phy;\r\nstruct phy_provider *phy_provider;\r\nstruct regmap *grf;\r\nunsigned int reg_offset;\r\nif (!dev->parent || !dev->parent->of_node)\r\nreturn -ENODEV;\r\ngrf = syscon_node_to_regmap(dev->parent->of_node);\r\nif (IS_ERR(grf)) {\r\ndev_err(dev, "Missing rockchip,grf property\n");\r\nreturn PTR_ERR(grf);\r\n}\r\nrk_phy = devm_kzalloc(dev, sizeof(*rk_phy), GFP_KERNEL);\r\nif (!rk_phy)\r\nreturn -ENOMEM;\r\nif (of_property_read_u32(dev->of_node, "reg", &reg_offset)) {\r\ndev_err(dev, "missing reg property in node %s\n",\r\ndev->of_node->name);\r\nreturn -EINVAL;\r\n}\r\nrk_phy->reg_offset = reg_offset;\r\nrk_phy->reg_base = grf;\r\ngeneric_phy = devm_phy_create(dev, dev->of_node, &ops);\r\nif (IS_ERR(generic_phy)) {\r\ndev_err(dev, "failed to create PHY\n");\r\nreturn PTR_ERR(generic_phy);\r\n}\r\nphy_set_drvdata(generic_phy, rk_phy);\r\nphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\r\nreturn PTR_ERR_OR_ZERO(phy_provider);\r\n}

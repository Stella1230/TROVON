static inline int iproc_mdio_wait_for_idle(void __iomem *base)\r\n{\r\nu32 val;\r\nunsigned int timeout = 1000;\r\ndo {\r\nval = readl(base + MII_CTRL_OFFSET);\r\nif ((val & BIT(MII_CTRL_BUSY_SHIFT)) == 0)\r\nreturn 0;\r\nusleep_range(1000, 2000);\r\n} while (timeout--);\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic inline void iproc_mdio_config_clk(void __iomem *base)\r\n{\r\nu32 val;\r\nval = (IPROC_GPHY_MDCDIV << MII_CTRL_DIV_SHIFT) |\r\nBIT(MII_CTRL_PRE_SHIFT);\r\nwritel(val, base + MII_CTRL_OFFSET);\r\n}\r\nstatic int iproc_mdio_read(struct mii_bus *bus, int phy_id, int reg)\r\n{\r\nstruct iproc_mdio_priv *priv = bus->priv;\r\nu32 cmd;\r\nint rc;\r\nrc = iproc_mdio_wait_for_idle(priv->base);\r\nif (rc)\r\nreturn rc;\r\niproc_mdio_config_clk(priv->base);\r\ncmd = (MII_DATA_TA_VAL << MII_DATA_TA_SHIFT) |\r\n(reg << MII_DATA_RA_SHIFT) |\r\n(phy_id << MII_DATA_PA_SHIFT) |\r\nBIT(MII_DATA_SB_SHIFT) |\r\n(MII_DATA_OP_READ << MII_DATA_OP_SHIFT);\r\nwritel(cmd, priv->base + MII_DATA_OFFSET);\r\nrc = iproc_mdio_wait_for_idle(priv->base);\r\nif (rc)\r\nreturn rc;\r\ncmd = readl(priv->base + MII_DATA_OFFSET) & MII_DATA_MASK;\r\nreturn cmd;\r\n}\r\nstatic int iproc_mdio_write(struct mii_bus *bus, int phy_id,\r\nint reg, u16 val)\r\n{\r\nstruct iproc_mdio_priv *priv = bus->priv;\r\nu32 cmd;\r\nint rc;\r\nrc = iproc_mdio_wait_for_idle(priv->base);\r\nif (rc)\r\nreturn rc;\r\niproc_mdio_config_clk(priv->base);\r\ncmd = (MII_DATA_TA_VAL << MII_DATA_TA_SHIFT) |\r\n(reg << MII_DATA_RA_SHIFT) |\r\n(phy_id << MII_DATA_PA_SHIFT) |\r\nBIT(MII_DATA_SB_SHIFT) |\r\n(MII_DATA_OP_WRITE << MII_DATA_OP_SHIFT) |\r\n((u32)(val) & MII_DATA_MASK);\r\nwritel(cmd, priv->base + MII_DATA_OFFSET);\r\nrc = iproc_mdio_wait_for_idle(priv->base);\r\nif (rc)\r\nreturn rc;\r\nreturn 0;\r\n}\r\nstatic int iproc_mdio_probe(struct platform_device *pdev)\r\n{\r\nstruct iproc_mdio_priv *priv;\r\nstruct mii_bus *bus;\r\nstruct resource *res;\r\nint rc;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->base)) {\r\ndev_err(&pdev->dev, "failed to ioremap register\n");\r\nreturn PTR_ERR(priv->base);\r\n}\r\npriv->mii_bus = mdiobus_alloc();\r\nif (!priv->mii_bus) {\r\ndev_err(&pdev->dev, "MDIO bus alloc failed\n");\r\nreturn -ENOMEM;\r\n}\r\nbus = priv->mii_bus;\r\nbus->priv = priv;\r\nbus->name = "iProc MDIO bus";\r\nsnprintf(bus->id, MII_BUS_ID_SIZE, "%s-%d", pdev->name, pdev->id);\r\nbus->parent = &pdev->dev;\r\nbus->read = iproc_mdio_read;\r\nbus->write = iproc_mdio_write;\r\nrc = of_mdiobus_register(bus, pdev->dev.of_node);\r\nif (rc) {\r\ndev_err(&pdev->dev, "MDIO bus registration failed\n");\r\ngoto err_iproc_mdio;\r\n}\r\nplatform_set_drvdata(pdev, priv);\r\ndev_info(&pdev->dev, "Broadcom iProc MDIO bus at 0x%p\n", priv->base);\r\nreturn 0;\r\nerr_iproc_mdio:\r\nmdiobus_free(bus);\r\nreturn rc;\r\n}\r\nstatic int iproc_mdio_remove(struct platform_device *pdev)\r\n{\r\nstruct iproc_mdio_priv *priv = platform_get_drvdata(pdev);\r\nmdiobus_unregister(priv->mii_bus);\r\nmdiobus_free(priv->mii_bus);\r\nreturn 0;\r\n}

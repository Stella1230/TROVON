void snd_pcm_indirect2_stat(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_indirect2 *rec)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nint i;\r\nint j;\r\nint k;\r\nint seconds = (rec->lastbytetime - rec->firstbytetime) / HZ;\r\nsnd_printk(KERN_DEBUG "STAT: mul_elapsed: %u, mul_elapsed_real: %d, "\r\n"irq_occurred: %d\n",\r\nrec->mul_elapsed, rec->mul_elapsed_real, rec->irq_occured);\r\nsnd_printk(KERN_DEBUG "STAT: min_multiple: %d (irqs/period)\n",\r\nrec->min_multiple);\r\nsnd_printk(KERN_DEBUG "STAT: firstbytetime: %lu, lastbytetime: %lu, "\r\n"firstzerotime: %lu\n",\r\nrec->firstbytetime, rec->lastbytetime, rec->firstzerotime);\r\nsnd_printk(KERN_DEBUG "STAT: bytes2hw: %u Bytes => (by runtime->rate) "\r\n"length: %d s\n",\r\nrec->bytes2hw, rec->bytes2hw / 2 / 2 / runtime->rate);\r\nsnd_printk(KERN_DEBUG "STAT: (by measurement) length: %d => "\r\n"rate: %d Bytes/s = %d Frames/s|Hz\n",\r\nseconds, rec->bytes2hw / seconds,\r\nrec->bytes2hw / 2 / 2 / seconds);\r\nsnd_printk(KERN_DEBUG\r\n"STAT: zeros2hw: %u = %d ms ~ %d * %d zero copies\n",\r\nrec->zeros2hw, ((rec->zeros2hw / 2 / 2) * 1000) /\r\nruntime->rate,\r\nrec->zeros2hw / (rec->hw_buffer_size / 2),\r\n(rec->hw_buffer_size / 2));\r\nsnd_printk(KERN_DEBUG "STAT: pointer_calls: %u, lastdifftime: %u\n",\r\nrec->pointer_calls, rec->lastdifftime);\r\nsnd_printk(KERN_DEBUG "STAT: sw_io: %d, sw_data: %d\n", rec->sw_io,\r\nrec->sw_data);\r\nsnd_printk(KERN_DEBUG "STAT: byte_sizes[]:\n");\r\nk = 0;\r\nfor (j = 0; j < 8; j++) {\r\nfor (i = j * 8; i < (j + 1) * 8; i++)\r\nif (rec->byte_sizes[i] != 0) {\r\nsnd_printk(KERN_DEBUG "%u: %u",\r\ni, rec->byte_sizes[i]);\r\nk++;\r\n}\r\nif (((k % 8) == 0) && (k != 0)) {\r\nsnd_printk(KERN_DEBUG "\n");\r\nk = 0;\r\n}\r\n}\r\nsnd_printk(KERN_DEBUG "\n");\r\nsnd_printk(KERN_DEBUG "STAT: zero_sizes[]:\n");\r\nfor (j = 0; j < 8; j++) {\r\nk = 0;\r\nfor (i = j * 8; i < (j + 1) * 8; i++)\r\nif (rec->zero_sizes[i] != 0)\r\nsnd_printk(KERN_DEBUG "%u: %u",\r\ni, rec->zero_sizes[i]);\r\nelse\r\nk++;\r\nif (!k)\r\nsnd_printk(KERN_DEBUG "\n");\r\n}\r\nsnd_printk(KERN_DEBUG "\n");\r\nsnd_printk(KERN_DEBUG "STAT: min_adds[]:\n");\r\nfor (j = 0; j < 8; j++) {\r\nif (rec->min_adds[j] != 0)\r\nsnd_printk(KERN_DEBUG "%u: %u", j, rec->min_adds[j]);\r\n}\r\nsnd_printk(KERN_DEBUG "\n");\r\nsnd_printk(KERN_DEBUG "STAT: mul_adds[]:\n");\r\nfor (j = 0; j < 8; j++) {\r\nif (rec->mul_adds[j] != 0)\r\nsnd_printk(KERN_DEBUG "%u: %u", j, rec->mul_adds[j]);\r\n}\r\nsnd_printk(KERN_DEBUG "\n");\r\nsnd_printk(KERN_DEBUG\r\n"STAT: zero_times_saved: %d, zero_times_notsaved: %d\n",\r\nrec->zero_times_saved, rec->zero_times_notsaved);\r\nreturn;\r\n}\r\nstatic void\r\nsnd_pcm_indirect2_increase_min_periods(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_indirect2 *rec,\r\nint isplay, int iscopy,\r\nunsigned int bytes)\r\n{\r\nif (rec->min_periods >= 0) {\r\nif (iscopy) {\r\nrec->sw_io += bytes;\r\nif (rec->sw_io >= rec->sw_buffer_size)\r\nrec->sw_io -= rec->sw_buffer_size;\r\n} else if (isplay) {\r\nif (!rec->check_alignment) {\r\nif (rec->bytes2hw %\r\nsnd_pcm_lib_period_bytes(substream)) {\r\nunsigned bytes2hw_aligned =\r\n(1 +\r\n(rec->bytes2hw /\r\nsnd_pcm_lib_period_bytes\r\n(substream))) *\r\nsnd_pcm_lib_period_bytes\r\n(substream);\r\nrec->sw_data =\r\nbytes2hw_aligned %\r\nrec->sw_buffer_size;\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nsnd_printk(KERN_DEBUG\r\n"STAT: @re-align: aligned "\r\n"bytes2hw to next period "\r\n"size boundary: %d "\r\n"(instead of %d)\n",\r\nbytes2hw_aligned,\r\nrec->bytes2hw);\r\nsnd_printk(KERN_DEBUG\r\n"STAT: @re-align: sw_data "\r\n"moves to: %d\n",\r\nrec->sw_data);\r\n#endif\r\n}\r\nrec->check_alignment = 1;\r\n}\r\nif (rec->sw_io != rec->sw_data) {\r\nunsigned int diff;\r\nif (rec->sw_data > rec->sw_io)\r\ndiff = rec->sw_data - rec->sw_io;\r\nelse\r\ndiff = (rec->sw_buffer_size -\r\nrec->sw_io) +\r\nrec->sw_data;\r\nif (bytes >= diff)\r\nrec->sw_io = rec->sw_data;\r\nelse {\r\nrec->sw_io += bytes;\r\nif (rec->sw_io >= rec->sw_buffer_size)\r\nrec->sw_io -=\r\nrec->sw_buffer_size;\r\n}\r\n}\r\n}\r\nrec->min_period_count += bytes;\r\nif (rec->min_period_count >= (rec->hw_buffer_size / 2)) {\r\nrec->min_periods += (rec->min_period_count /\r\n(rec->hw_buffer_size / 2));\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nif ((rec->min_period_count /\r\n(rec->hw_buffer_size / 2)) > 7)\r\nsnd_printk(KERN_DEBUG\r\n"STAT: more than 7 (%d) min_adds "\r\n"at once - too big to save!\n",\r\n(rec->min_period_count /\r\n(rec->hw_buffer_size / 2)));\r\nelse\r\nrec->min_adds[(rec->min_period_count /\r\n(rec->hw_buffer_size / 2))]++;\r\n#endif\r\nrec->min_period_count = (rec->min_period_count %\r\n(rec->hw_buffer_size / 2));\r\n}\r\n} else if (isplay && iscopy)\r\nrec->min_periods = 0;\r\n}\r\nsnd_pcm_uframes_t\r\nsnd_pcm_indirect2_pointer(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_indirect2 *rec)\r\n{\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nrec->pointer_calls++;\r\n#endif\r\nreturn bytes_to_frames(substream->runtime, rec->sw_io);\r\n}\r\nstatic void\r\nsnd_pcm_indirect2_playback_transfer(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_indirect2 *rec,\r\nsnd_pcm_indirect2_copy_t copy,\r\nsnd_pcm_indirect2_zero_t zero)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nsnd_pcm_uframes_t appl_ptr = runtime->control->appl_ptr;\r\nsnd_pcm_sframes_t diff = appl_ptr - rec->appl_ptr;\r\nif (diff) {\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nrec->lastdifftime = jiffies;\r\n#endif\r\nif (diff < -(snd_pcm_sframes_t) (runtime->boundary / 2))\r\ndiff += runtime->boundary;\r\nrec->sw_ready += (int)frames_to_bytes(runtime, diff);\r\nrec->appl_ptr = appl_ptr;\r\n}\r\nif (rec->hw_ready && (rec->sw_ready <= 0)) {\r\nunsigned int bytes;\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nif (rec->firstzerotime == 0) {\r\nrec->firstzerotime = jiffies;\r\nsnd_printk(KERN_DEBUG\r\n"STAT: @firstzerotime: mul_elapsed: %d, "\r\n"min_period_count: %d\n",\r\nrec->mul_elapsed, rec->min_period_count);\r\nsnd_printk(KERN_DEBUG\r\n"STAT: @firstzerotime: sw_io: %d, "\r\n"sw_data: %d, appl_ptr: %u\n",\r\nrec->sw_io, rec->sw_data,\r\n(unsigned int)appl_ptr);\r\n}\r\nif ((jiffies - rec->firstzerotime) < 3750) {\r\nrec->zero_times[(jiffies - rec->firstzerotime)]++;\r\nrec->zero_times_saved++;\r\n} else\r\nrec->zero_times_notsaved++;\r\n#endif\r\nbytes = zero(substream, rec);\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nrec->zeros2hw += bytes;\r\nif (bytes < 64)\r\nrec->zero_sizes[bytes]++;\r\nelse\r\nsnd_printk(KERN_DEBUG\r\n"STAT: %d zero Bytes copied to hardware at "\r\n"once - too big to save!\n",\r\nbytes);\r\n#endif\r\nsnd_pcm_indirect2_increase_min_periods(substream, rec, 1, 0,\r\nbytes);\r\nreturn;\r\n}\r\nwhile (rec->hw_ready && (rec->sw_ready > 0)) {\r\nunsigned int sw_to_end = rec->sw_buffer_size - rec->sw_data;\r\nunsigned int bytes = rec->sw_ready;\r\nif (sw_to_end < bytes)\r\nbytes = sw_to_end;\r\nif (!bytes)\r\nbreak;\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nif (rec->firstbytetime == 0)\r\nrec->firstbytetime = jiffies;\r\nrec->lastbytetime = jiffies;\r\n#endif\r\nbytes = copy(substream, rec, bytes);\r\nrec->bytes2hw += bytes;\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nif (bytes < 64)\r\nrec->byte_sizes[bytes]++;\r\nelse\r\nsnd_printk(KERN_DEBUG\r\n"STAT: %d Bytes copied to hardware at once "\r\n"- too big to save!\n",\r\nbytes);\r\n#endif\r\nrec->sw_data += bytes;\r\nif (rec->sw_data == rec->sw_buffer_size)\r\nrec->sw_data = 0;\r\nsnd_pcm_indirect2_increase_min_periods(substream, rec, 1, 1,\r\nbytes);\r\nrec->sw_ready -= bytes;\r\n}\r\nreturn;\r\n}\r\nvoid\r\nsnd_pcm_indirect2_playback_interrupt(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_indirect2 *rec,\r\nsnd_pcm_indirect2_copy_t copy,\r\nsnd_pcm_indirect2_zero_t zero)\r\n{\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nrec->irq_occured++;\r\n#endif\r\nrec->hw_ready = 1;\r\nsnd_pcm_indirect2_playback_transfer(substream, rec, copy, zero);\r\nif (rec->min_periods >= rec->min_multiple) {\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nif ((rec->min_periods / rec->min_multiple) > 7)\r\nsnd_printk(KERN_DEBUG\r\n"STAT: more than 7 (%d) mul_adds - too big "\r\n"to save!\n",\r\n(rec->min_periods / rec->min_multiple));\r\nelse\r\nrec->mul_adds[(rec->min_periods /\r\nrec->min_multiple)]++;\r\nrec->mul_elapsed_real += (rec->min_periods /\r\nrec->min_multiple);\r\nrec->mul_elapsed++;\r\n#endif\r\nrec->min_periods = (rec->min_periods % rec->min_multiple);\r\nsnd_pcm_period_elapsed(substream);\r\n}\r\n}\r\nstatic void\r\nsnd_pcm_indirect2_capture_transfer(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_indirect2 *rec,\r\nsnd_pcm_indirect2_copy_t copy,\r\nsnd_pcm_indirect2_zero_t null)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nsnd_pcm_uframes_t appl_ptr = runtime->control->appl_ptr;\r\nsnd_pcm_sframes_t diff = appl_ptr - rec->appl_ptr;\r\nif (diff) {\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nrec->lastdifftime = jiffies;\r\n#endif\r\nif (diff < -(snd_pcm_sframes_t) (runtime->boundary / 2))\r\ndiff += runtime->boundary;\r\nrec->sw_ready -= frames_to_bytes(runtime, diff);\r\nrec->appl_ptr = appl_ptr;\r\n}\r\nif (rec->hw_ready && (rec->sw_ready >= (int)rec->sw_buffer_size)) {\r\nunsigned int bytes;\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nif (rec->firstzerotime == 0) {\r\nrec->firstzerotime = jiffies;\r\nsnd_printk(KERN_DEBUG "STAT: (capture) "\r\n"@firstzerotime: mul_elapsed: %d, "\r\n"min_period_count: %d\n",\r\nrec->mul_elapsed, rec->min_period_count);\r\nsnd_printk(KERN_DEBUG "STAT: (capture) "\r\n"@firstzerotime: sw_io: %d, sw_data: %d, "\r\n"appl_ptr: %u\n",\r\nrec->sw_io, rec->sw_data,\r\n(unsigned int)appl_ptr);\r\n}\r\nif ((jiffies - rec->firstzerotime) < 3750) {\r\nrec->zero_times[(jiffies - rec->firstzerotime)]++;\r\nrec->zero_times_saved++;\r\n} else\r\nrec->zero_times_notsaved++;\r\n#endif\r\nbytes = null(substream, rec);\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nrec->zeros2hw += bytes;\r\nif (bytes < 64)\r\nrec->zero_sizes[bytes]++;\r\nelse\r\nsnd_printk(KERN_DEBUG\r\n"STAT: (capture) %d zero Bytes copied to "\r\n"hardware at once - too big to save!\n",\r\nbytes);\r\n#endif\r\nsnd_pcm_indirect2_increase_min_periods(substream, rec, 0, 0,\r\nbytes);\r\nrec->sw_io = SNDRV_PCM_POS_XRUN;\r\nreturn;\r\n}\r\nwhile (rec->hw_ready && (rec->sw_ready < (int)rec->sw_buffer_size)) {\r\nsize_t sw_to_end = rec->sw_buffer_size - rec->sw_data;\r\nsize_t bytes = rec->sw_buffer_size - rec->sw_ready;\r\nif (sw_to_end < bytes)\r\nbytes = sw_to_end;\r\nif (!bytes)\r\nbreak;\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nif (rec->firstbytetime == 0)\r\nrec->firstbytetime = jiffies;\r\nrec->lastbytetime = jiffies;\r\n#endif\r\nbytes = copy(substream, rec, bytes);\r\nrec->bytes2hw += bytes;\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nif (bytes < 64)\r\nrec->byte_sizes[bytes]++;\r\nelse\r\nsnd_printk(KERN_DEBUG\r\n"STAT: (capture) %d Bytes copied to "\r\n"hardware at once - too big to save!\n",\r\nbytes);\r\n#endif\r\nrec->sw_data += bytes;\r\nif (rec->sw_data == rec->sw_buffer_size)\r\nrec->sw_data = 0;\r\nsnd_pcm_indirect2_increase_min_periods(substream, rec, 0, 1,\r\nbytes);\r\nrec->sw_ready += bytes;\r\n}\r\nreturn;\r\n}\r\nvoid\r\nsnd_pcm_indirect2_capture_interrupt(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_indirect2 *rec,\r\nsnd_pcm_indirect2_copy_t copy,\r\nsnd_pcm_indirect2_zero_t null)\r\n{\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nrec->irq_occured++;\r\n#endif\r\nrec->hw_ready = 1;\r\nsnd_pcm_indirect2_capture_transfer(substream, rec, copy, null);\r\nif (rec->min_periods >= rec->min_multiple) {\r\n#ifdef SND_PCM_INDIRECT2_STAT\r\nif ((rec->min_periods / rec->min_multiple) > 7)\r\nsnd_printk(KERN_DEBUG\r\n"STAT: more than 7 (%d) mul_adds - "\r\n"too big to save!\n",\r\n(rec->min_periods / rec->min_multiple));\r\nelse\r\nrec->mul_adds[(rec->min_periods /\r\nrec->min_multiple)]++;\r\nrec->mul_elapsed_real += (rec->min_periods /\r\nrec->min_multiple);\r\nrec->mul_elapsed++;\r\n#endif\r\nrec->min_periods = (rec->min_periods % rec->min_multiple);\r\nsnd_pcm_period_elapsed(substream);\r\n}\r\n}

static void ipoib_get_drvinfo(struct net_device *netdev,\r\nstruct ethtool_drvinfo *drvinfo)\r\n{\r\nstruct ipoib_dev_priv *priv = netdev_priv(netdev);\r\nib_get_device_fw_str(priv->ca, drvinfo->fw_version,\r\nsizeof(drvinfo->fw_version));\r\nstrlcpy(drvinfo->bus_info, dev_name(priv->ca->dma_device),\r\nsizeof(drvinfo->bus_info));\r\nstrlcpy(drvinfo->version, ipoib_driver_version,\r\nsizeof(drvinfo->version));\r\nstrlcpy(drvinfo->driver, "ib_ipoib", sizeof(drvinfo->driver));\r\n}\r\nstatic int ipoib_get_coalesce(struct net_device *dev,\r\nstruct ethtool_coalesce *coal)\r\n{\r\nstruct ipoib_dev_priv *priv = netdev_priv(dev);\r\ncoal->rx_coalesce_usecs = priv->ethtool.coalesce_usecs;\r\ncoal->rx_max_coalesced_frames = priv->ethtool.max_coalesced_frames;\r\nreturn 0;\r\n}\r\nstatic int ipoib_set_coalesce(struct net_device *dev,\r\nstruct ethtool_coalesce *coal)\r\n{\r\nstruct ipoib_dev_priv *priv = netdev_priv(dev);\r\nint ret;\r\nif (coal->rx_coalesce_usecs > 0xffff ||\r\ncoal->rx_max_coalesced_frames > 0xffff)\r\nreturn -EINVAL;\r\nret = ib_modify_cq(priv->recv_cq, coal->rx_max_coalesced_frames,\r\ncoal->rx_coalesce_usecs);\r\nif (ret && ret != -ENOSYS) {\r\nipoib_warn(priv, "failed modifying CQ (%d)\n", ret);\r\nreturn ret;\r\n}\r\npriv->ethtool.coalesce_usecs = coal->rx_coalesce_usecs;\r\npriv->ethtool.max_coalesced_frames = coal->rx_max_coalesced_frames;\r\nreturn 0;\r\n}\r\nstatic void ipoib_get_ethtool_stats(struct net_device *dev,\r\nstruct ethtool_stats __always_unused *stats,\r\nu64 *data)\r\n{\r\nint i;\r\nstruct net_device_stats *net_stats = &dev->stats;\r\nu8 *p = (u8 *)net_stats;\r\nfor (i = 0; i < IPOIB_GLOBAL_STATS_LEN; i++)\r\ndata[i] = *(u64 *)(p + ipoib_gstrings_stats[i].stat_offset);\r\n}\r\nstatic void ipoib_get_strings(struct net_device __always_unused *dev,\r\nu32 stringset, u8 *data)\r\n{\r\nu8 *p = data;\r\nint i;\r\nswitch (stringset) {\r\ncase ETH_SS_STATS:\r\nfor (i = 0; i < IPOIB_GLOBAL_STATS_LEN; i++) {\r\nmemcpy(p, ipoib_gstrings_stats[i].stat_string,\r\nETH_GSTRING_LEN);\r\np += ETH_GSTRING_LEN;\r\n}\r\nbreak;\r\ncase ETH_SS_TEST:\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic int ipoib_get_sset_count(struct net_device __always_unused *dev,\r\nint sset)\r\n{\r\nswitch (sset) {\r\ncase ETH_SS_STATS:\r\nreturn IPOIB_GLOBAL_STATS_LEN;\r\ncase ETH_SS_TEST:\r\ndefault:\r\nbreak;\r\n}\r\nreturn -EOPNOTSUPP;\r\n}\r\nvoid ipoib_set_ethtool_ops(struct net_device *dev)\r\n{\r\ndev->ethtool_ops = &ipoib_ethtool_ops;\r\n}

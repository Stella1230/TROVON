static u8 vivid_get_di(const struct vivid_rds_gen *rds, unsigned grp)\r\n{\r\nswitch (grp) {\r\ncase 0:\r\nreturn (rds->dyn_pty << 2) | (grp & 3);\r\ncase 1:\r\nreturn (rds->compressed << 2) | (grp & 3);\r\ncase 2:\r\nreturn (rds->art_head << 2) | (grp & 3);\r\ncase 3:\r\nreturn (rds->mono_stereo << 2) | (grp & 3);\r\n}\r\nreturn 0;\r\n}\r\nvoid vivid_rds_generate(struct vivid_rds_gen *rds)\r\n{\r\nstruct v4l2_rds_data *data = rds->data;\r\nunsigned grp;\r\nunsigned idx;\r\nstruct tm tm;\r\nunsigned date;\r\nunsigned time;\r\nint l;\r\nfor (grp = 0; grp < VIVID_RDS_GEN_GROUPS; grp++, data += VIVID_RDS_GEN_BLKS_PER_GRP) {\r\ndata[0].lsb = rds->picode & 0xff;\r\ndata[0].msb = rds->picode >> 8;\r\ndata[0].block = V4L2_RDS_BLOCK_A | (V4L2_RDS_BLOCK_A << 3);\r\ndata[1].lsb = rds->pty << 5;\r\ndata[1].msb = (rds->pty >> 3) | (rds->tp << 2);\r\ndata[1].block = V4L2_RDS_BLOCK_B | (V4L2_RDS_BLOCK_B << 3);\r\ndata[3].block = V4L2_RDS_BLOCK_D | (V4L2_RDS_BLOCK_D << 3);\r\nswitch (grp) {\r\ncase 0 ... 3:\r\ncase 22 ... 25:\r\ncase 44 ... 47:\r\nidx = (grp % 22) % 4;\r\ndata[1].lsb |= (rds->ta << 4) | (rds->ms << 3);\r\ndata[1].lsb |= vivid_get_di(rds, idx);\r\ndata[1].msb |= 1 << 3;\r\ndata[2].lsb = rds->picode & 0xff;\r\ndata[2].msb = rds->picode >> 8;\r\ndata[2].block = V4L2_RDS_BLOCK_C_ALT | (V4L2_RDS_BLOCK_C_ALT << 3);\r\ndata[3].lsb = rds->psname[2 * idx + 1];\r\ndata[3].msb = rds->psname[2 * idx];\r\nbreak;\r\ncase 4 ... 19:\r\ncase 26 ... 41:\r\nidx = ((grp - 4) % 22) % 16;\r\ndata[1].lsb |= idx;\r\ndata[1].msb |= 4 << 3;\r\ndata[2].msb = rds->radiotext[4 * idx];\r\ndata[2].lsb = rds->radiotext[4 * idx + 1];\r\ndata[2].block = V4L2_RDS_BLOCK_C | (V4L2_RDS_BLOCK_C << 3);\r\ndata[3].msb = rds->radiotext[4 * idx + 2];\r\ndata[3].lsb = rds->radiotext[4 * idx + 3];\r\nbreak;\r\ncase 56:\r\ntime_to_tm(get_seconds(), 0, &tm);\r\nl = tm.tm_mon <= 1;\r\ndate = 14956 + tm.tm_mday + ((tm.tm_year - l) * 1461) / 4 +\r\n((tm.tm_mon + 2 + l * 12) * 306001) / 10000;\r\ntime = (tm.tm_hour << 12) |\r\n(tm.tm_min << 6) |\r\n(sys_tz.tz_minuteswest >= 0 ? 0x20 : 0) |\r\n(abs(sys_tz.tz_minuteswest) / 30);\r\ndata[1].lsb &= ~3;\r\ndata[1].lsb |= date >> 15;\r\ndata[1].msb |= 8 << 3;\r\ndata[2].lsb = (date << 1) & 0xfe;\r\ndata[2].lsb |= (time >> 16) & 1;\r\ndata[2].msb = (date >> 7) & 0xff;\r\ndata[2].block = V4L2_RDS_BLOCK_C | (V4L2_RDS_BLOCK_C << 3);\r\ndata[3].lsb = time & 0xff;\r\ndata[3].msb = (time >> 8) & 0xff;\r\nbreak;\r\ndefault:\r\ndata[1].lsb |= (rds->ta << 4) | (rds->ms << 3);\r\ndata[1].lsb |= vivid_get_di(rds, grp % 22);\r\ndata[1].msb |= 0x1f << 3;\r\ndata[2].lsb = rds->picode & 0xff;\r\ndata[2].msb = rds->picode >> 8;\r\ndata[2].block = V4L2_RDS_BLOCK_C_ALT | (V4L2_RDS_BLOCK_C_ALT << 3);\r\ndata[3].lsb = rds->pty << 5;\r\ndata[3].lsb |= (rds->ta << 4) | (rds->ms << 3);\r\ndata[3].lsb |= vivid_get_di(rds, grp % 22);\r\ndata[3].msb |= rds->pty >> 3;\r\ndata[3].msb |= 0x1f << 3;\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid vivid_rds_gen_fill(struct vivid_rds_gen *rds, unsigned freq,\r\nbool alt)\r\n{\r\nif (rds->use_rbds) {\r\nrds->picode = 0x2e75;\r\nrds->pty = alt ? 29 : 2;\r\n} else {\r\nrds->picode = 0x8088;\r\nrds->pty = alt ? 16 : 3;\r\n}\r\nrds->mono_stereo = true;\r\nrds->art_head = false;\r\nrds->compressed = false;\r\nrds->dyn_pty = false;\r\nrds->tp = true;\r\nrds->ta = alt;\r\nrds->ms = true;\r\nsnprintf(rds->psname, sizeof(rds->psname), "%6d.%1d",\r\nfreq / 16, ((freq & 0xf) * 10) / 16);\r\nif (alt)\r\nstrlcpy(rds->radiotext,\r\n" The Radio Data System can switch between different Radio Texts ",\r\nsizeof(rds->radiotext));\r\nelse\r\nstrlcpy(rds->radiotext,\r\n"An example of Radio Text as transmitted by the Radio Data System",\r\nsizeof(rds->radiotext));\r\n}

static inline void cursor_undrawn(void)\r\n{\r\nvbl_cursor_cnt = 0;\r\ncursor_drawn = 0;\r\n}\r\nstatic const char *sticon_startup(void)\r\n{\r\nreturn "STI console";\r\n}\r\nstatic void sticon_putc(struct vc_data *conp, int c, int ypos, int xpos)\r\n{\r\nint redraw_cursor = 0;\r\nif (vga_is_gfx || console_blanked)\r\nreturn;\r\nif (conp->vc_mode != KD_TEXT)\r\nreturn;\r\n#if 0\r\nif ((p->cursor_x == xpos) && (p->cursor_y == ypos)) {\r\ncursor_undrawn();\r\nredraw_cursor = 1;\r\n}\r\n#endif\r\nsti_putc(sticon_sti, c, ypos, xpos);\r\nif (redraw_cursor)\r\nvbl_cursor_cnt = CURSOR_DRAW_DELAY;\r\n}\r\nstatic void sticon_putcs(struct vc_data *conp, const unsigned short *s,\r\nint count, int ypos, int xpos)\r\n{\r\nint redraw_cursor = 0;\r\nif (vga_is_gfx || console_blanked)\r\nreturn;\r\nif (conp->vc_mode != KD_TEXT)\r\nreturn;\r\n#if 0\r\nif ((p->cursor_y == ypos) && (xpos <= p->cursor_x) &&\r\n(p->cursor_x < (xpos + count))) {\r\ncursor_undrawn();\r\nredraw_cursor = 1;\r\n}\r\n#endif\r\nwhile (count--) {\r\nsti_putc(sticon_sti, scr_readw(s++), ypos, xpos++);\r\n}\r\nif (redraw_cursor)\r\nvbl_cursor_cnt = CURSOR_DRAW_DELAY;\r\n}\r\nstatic void sticon_cursor(struct vc_data *conp, int mode)\r\n{\r\nunsigned short car1;\r\ncar1 = conp->vc_screenbuf[conp->vc_x + conp->vc_y * conp->vc_cols];\r\nswitch (mode) {\r\ncase CM_ERASE:\r\nsti_putc(sticon_sti, car1, conp->vc_y, conp->vc_x);\r\nbreak;\r\ncase CM_MOVE:\r\ncase CM_DRAW:\r\nswitch (conp->vc_cursor_type & 0x0f) {\r\ncase CUR_UNDERLINE:\r\ncase CUR_LOWER_THIRD:\r\ncase CUR_LOWER_HALF:\r\ncase CUR_TWO_THIRDS:\r\ncase CUR_BLOCK:\r\nsti_putc(sticon_sti, (car1 & 255) + (0 << 8) + (7 << 11),\r\nconp->vc_y, conp->vc_x);\r\nbreak;\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic int sticon_scroll(struct vc_data *conp, int t, int b, int dir, int count)\r\n{\r\nstruct sti_struct *sti = sticon_sti;\r\nif (vga_is_gfx)\r\nreturn 0;\r\nsticon_cursor(conp, CM_ERASE);\r\nswitch (dir) {\r\ncase SM_UP:\r\nsti_bmove(sti, t + count, 0, t, 0, b - t - count, conp->vc_cols);\r\nsti_clear(sti, b - count, 0, count, conp->vc_cols, conp->vc_video_erase_char);\r\nbreak;\r\ncase SM_DOWN:\r\nsti_bmove(sti, t, 0, t + count, 0, b - t - count, conp->vc_cols);\r\nsti_clear(sti, t, 0, count, conp->vc_cols, conp->vc_video_erase_char);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic void sticon_init(struct vc_data *c, int init)\r\n{\r\nstruct sti_struct *sti = sticon_sti;\r\nint vc_cols, vc_rows;\r\nsti_set(sti, 0, 0, sti_onscreen_y(sti), sti_onscreen_x(sti), 0);\r\nvc_cols = sti_onscreen_x(sti) / sti->font_width;\r\nvc_rows = sti_onscreen_y(sti) / sti->font_height;\r\nc->vc_can_do_color = 1;\r\nif (init) {\r\nc->vc_cols = vc_cols;\r\nc->vc_rows = vc_rows;\r\n} else {\r\nvc_resize(c, vc_cols, vc_rows);\r\n}\r\n}\r\nstatic void sticon_deinit(struct vc_data *c)\r\n{\r\n}\r\nstatic void sticon_clear(struct vc_data *conp, int sy, int sx, int height,\r\nint width)\r\n{\r\nif (!height || !width)\r\nreturn;\r\nsti_clear(sticon_sti, sy, sx, height, width, conp->vc_video_erase_char);\r\n}\r\nstatic int sticon_switch(struct vc_data *conp)\r\n{\r\nreturn 1;\r\n}\r\nstatic int sticon_set_origin(struct vc_data *conp)\r\n{\r\nreturn 0;\r\n}\r\nstatic int sticon_blank(struct vc_data *c, int blank, int mode_switch)\r\n{\r\nif (blank == 0) {\r\nif (mode_switch)\r\nvga_is_gfx = 0;\r\nreturn 1;\r\n}\r\nsticon_set_origin(c);\r\nsti_clear(sticon_sti, 0,0, c->vc_rows, c->vc_cols, BLANK);\r\nif (mode_switch)\r\nvga_is_gfx = 1;\r\nreturn 1;\r\n}\r\nstatic u16 *sticon_screen_pos(struct vc_data *conp, int offset)\r\n{\r\nint line;\r\nunsigned long p;\r\nif (conp->vc_num != fg_console || !softback_lines)\r\nreturn (u16 *)(conp->vc_origin + offset);\r\nline = offset / conp->vc_size_row;\r\nif (line >= softback_lines)\r\nreturn (u16 *)(conp->vc_origin + offset - softback_lines * conp->vc_size_row);\r\np = softback_curr + offset;\r\nif (p >= softback_end)\r\np += softback_buf - softback_end;\r\nreturn (u16 *)p;\r\n}\r\nstatic unsigned long sticon_getxy(struct vc_data *conp, unsigned long pos,\r\nint *px, int *py)\r\n{\r\nint x, y;\r\nunsigned long ret;\r\nif (pos >= conp->vc_origin && pos < conp->vc_scr_end) {\r\nunsigned long offset = (pos - conp->vc_origin) / 2;\r\nx = offset % conp->vc_cols;\r\ny = offset / conp->vc_cols;\r\nif (conp->vc_num == fg_console)\r\ny += softback_lines;\r\nret = pos + (conp->vc_cols - x) * 2;\r\n} else if (conp->vc_num == fg_console && softback_lines) {\r\nunsigned long offset = pos - softback_curr;\r\nif (pos < softback_curr)\r\noffset += softback_end - softback_buf;\r\noffset /= 2;\r\nx = offset % conp->vc_cols;\r\ny = offset / conp->vc_cols;\r\nret = pos + (conp->vc_cols - x) * 2;\r\nif (ret == softback_end)\r\nret = softback_buf;\r\nif (ret == softback_in)\r\nret = conp->vc_origin;\r\n} else {\r\nx = y = 0;\r\nret = conp->vc_origin;\r\n}\r\nif (px) *px = x;\r\nif (py) *py = y;\r\nreturn ret;\r\n}\r\nstatic u8 sticon_build_attr(struct vc_data *conp, u8 color, u8 intens,\r\nu8 blink, u8 underline, u8 reverse, u8 italic)\r\n{\r\nu8 attr = ((color & 0x70) >> 1) | ((color & 7));\r\nif (reverse) {\r\ncolor = ((color >> 3) & 0x7) | ((color & 0x7) << 3);\r\n}\r\nreturn attr;\r\n}\r\nstatic void sticon_invert_region(struct vc_data *conp, u16 *p, int count)\r\n{\r\nint col = 1;\r\nwhile (count--) {\r\nu16 a = scr_readw(p);\r\nif (col)\r\na = ((a) & 0x88ff) | (((a) & 0x7000) >> 4) | (((a) & 0x0700) << 4);\r\nelse\r\na = ((a & 0x0700) == 0x0100) ? 0x7000 : 0x7700;\r\nscr_writew(a, p++);\r\n}\r\n}\r\nstatic void sticon_save_screen(struct vc_data *conp)\r\n{\r\n}\r\nstatic int __init sticonsole_init(void)\r\n{\r\nint err;\r\nif (sticon_sti)\r\nreturn 0;\r\nsticon_sti = sti_get_rom(0);\r\nif (!sticon_sti)\r\nreturn -ENODEV;\r\nif (conswitchp == &dummy_con) {\r\nprintk(KERN_INFO "sticon: Initializing STI text console.\n");\r\nconsole_lock();\r\nerr = do_take_over_console(&sti_con, 0, MAX_NR_CONSOLES - 1, 1);\r\nconsole_unlock();\r\nreturn err;\r\n}\r\nreturn 0;\r\n}

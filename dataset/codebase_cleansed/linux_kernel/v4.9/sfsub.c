int\r\nsgl_fsub(\r\nsgl_floating_point *leftptr,\r\nsgl_floating_point *rightptr,\r\nsgl_floating_point *dstptr,\r\nunsigned int *status)\r\n{\r\nregister unsigned int left, right, result, extent;\r\nregister unsigned int signless_upper_left, signless_upper_right, save;\r\nregister int result_exponent, right_exponent, diff_exponent;\r\nregister int sign_save, jumpsize;\r\nregister boolean inexact = FALSE, underflowtrap;\r\nleft = *leftptr;\r\nright = *rightptr;\r\nSgl_xortointp1(left,right,save);\r\nif ((result_exponent = Sgl_exponent(left)) == SGL_INFINITY_EXPONENT)\r\n{\r\nif (Sgl_iszero_mantissa(left))\r\n{\r\nif (Sgl_isnotnan(right))\r\n{\r\nif (Sgl_isinfinity(right) && save==0)\r\n{\r\nif (Is_invalidtrap_enabled()) return(INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nSgl_makequietnan(result);\r\n*dstptr = result;\r\nreturn(NOEXCEPTION);\r\n}\r\n*dstptr = left;\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nelse\r\n{\r\nif (Sgl_isone_signaling(left))\r\n{\r\nif (Is_invalidtrap_enabled()) return(INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nSgl_set_quiet(left);\r\n}\r\nelse if (Sgl_is_signalingnan(right))\r\n{\r\nif (Is_invalidtrap_enabled()) return(INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nSgl_set_quiet(right);\r\n*dstptr = right;\r\nreturn(NOEXCEPTION);\r\n}\r\n*dstptr = left;\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nif (Sgl_isinfinity_exponent(right))\r\n{\r\nif (Sgl_iszero_mantissa(right))\r\n{\r\nSgl_invert_sign(right);\r\n*dstptr = right;\r\nreturn(NOEXCEPTION);\r\n}\r\nif (Sgl_isone_signaling(right))\r\n{\r\nif (Is_invalidtrap_enabled()) return(INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nSgl_set_quiet(right);\r\n}\r\n*dstptr = right;\r\nreturn(NOEXCEPTION);\r\n}\r\nSgl_copytoint_exponentmantissa(left,signless_upper_left);\r\nSgl_copytoint_exponentmantissa(right,signless_upper_right);\r\nif(Sgl_ismagnitudeless(signless_upper_left,signless_upper_right))\r\n{\r\nSgl_xorfromintp1(save,right,right);\r\nSgl_xorfromintp1(save,left,left);\r\nresult_exponent = Sgl_exponent(left);\r\nSgl_invert_sign(left);\r\n}\r\nif((right_exponent = Sgl_exponent(right)) == 0)\r\n{\r\nif(Sgl_iszero_mantissa(right))\r\n{\r\nif(Sgl_iszero_exponentmantissa(left))\r\n{\r\nSgl_invert_sign(right);\r\nif(Is_rounding_mode(ROUNDMINUS))\r\n{\r\nSgl_or_signs(left,right);\r\n}\r\nelse\r\n{\r\nSgl_and_signs(left,right);\r\n}\r\n}\r\nelse\r\n{\r\nif( (result_exponent == 0) && Is_underflowtrap_enabled() )\r\n{\r\nsign_save = Sgl_signextendedsign(left);\r\nSgl_leftshiftby1(left);\r\nSgl_normalize(left,result_exponent);\r\nSgl_set_sign(left,sign_save);\r\nSgl_setwrapped_exponent(left,result_exponent,unfl);\r\n*dstptr = left;\r\nreturn(UNDERFLOWEXCEPTION);\r\n}\r\n}\r\n*dstptr = left;\r\nreturn(NOEXCEPTION);\r\n}\r\nSgl_clear_sign(right);\r\nif(result_exponent == 0 )\r\n{\r\nif( (int) save >= 0 )\r\n{\r\nSgl_subtract(left,right,result);\r\nif(Sgl_iszero_mantissa(result))\r\n{\r\nif(Is_rounding_mode(ROUNDMINUS))\r\n{\r\nSgl_setone_sign(result);\r\n}\r\nelse\r\n{\r\nSgl_setzero_sign(result);\r\n}\r\n*dstptr = result;\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nelse\r\n{\r\nSgl_addition(left,right,result);\r\nif(Sgl_isone_hidden(result))\r\n{\r\n*dstptr = result;\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nif(Is_underflowtrap_enabled())\r\n{\r\nsign_save = Sgl_signextendedsign(result);\r\nSgl_leftshiftby1(result);\r\nSgl_normalize(result,result_exponent);\r\nSgl_set_sign(result,sign_save);\r\nSgl_setwrapped_exponent(result,result_exponent,unfl);\r\n*dstptr = result;\r\nreturn(UNDERFLOWEXCEPTION);\r\n}\r\n*dstptr = result;\r\nreturn(NOEXCEPTION);\r\n}\r\nright_exponent = 1;\r\n}\r\nelse\r\n{\r\nSgl_clear_signexponent_set_hidden(right);\r\n}\r\nSgl_clear_exponent_set_hidden(left);\r\ndiff_exponent = result_exponent - right_exponent;\r\nif(diff_exponent > SGL_THRESHOLD)\r\n{\r\ndiff_exponent = SGL_THRESHOLD;\r\n}\r\nSgl_right_align(right,diff_exponent,\r\nextent);\r\nif( (int) save >= 0 )\r\n{\r\nSgl_subtract_withextension(left,right,extent,result);\r\nif(Sgl_iszero_hidden(result))\r\n{\r\nsign_save = Sgl_signextendedsign(result);\r\nSgl_leftshiftby1_withextent(result,extent,result);\r\nif(Sgl_iszero(result))\r\n{\r\nif(Is_rounding_mode(ROUNDMINUS)) Sgl_setone_sign(result);\r\n*dstptr = result;\r\nreturn(NOEXCEPTION);\r\n}\r\nresult_exponent--;\r\nif(Sgl_isone_hidden(result))\r\n{\r\nif(result_exponent==0)\r\n{\r\ngoto underflow;\r\n}\r\nelse\r\n{\r\nSgl_set_sign(result,sign_save);\r\nExt_leftshiftby1(extent);\r\ngoto round;\r\n}\r\n}\r\nif(!(underflowtrap = Is_underflowtrap_enabled()) &&\r\nresult_exponent==0) goto underflow;\r\nExt_leftshiftby1(extent);\r\nwhile(Sgl_iszero_hiddenhigh7mantissa(result))\r\n{\r\nSgl_leftshiftby8(result);\r\nif((result_exponent -= 8) <= 0 && !underflowtrap)\r\ngoto underflow;\r\n}\r\nif(Sgl_iszero_hiddenhigh3mantissa(result))\r\n{\r\nSgl_leftshiftby4(result);\r\nif((result_exponent -= 4) <= 0 && !underflowtrap)\r\ngoto underflow;\r\n}\r\nif((jumpsize = Sgl_hiddenhigh3mantissa(result)) > 7)\r\n{\r\nif(result_exponent <= 0) goto underflow;\r\nSgl_set_sign(result,sign_save);\r\nSgl_set_exponent(result,result_exponent);\r\n*dstptr = result;\r\nreturn(NOEXCEPTION);\r\n}\r\nSgl_sethigh4bits(result,sign_save);\r\nswitch(jumpsize)\r\n{\r\ncase 1:\r\n{\r\nSgl_leftshiftby3(result);\r\nresult_exponent -= 3;\r\nbreak;\r\n}\r\ncase 2:\r\ncase 3:\r\n{\r\nSgl_leftshiftby2(result);\r\nresult_exponent -= 2;\r\nbreak;\r\n}\r\ncase 4:\r\ncase 5:\r\ncase 6:\r\ncase 7:\r\n{\r\nSgl_leftshiftby1(result);\r\nresult_exponent -= 1;\r\nbreak;\r\n}\r\n}\r\nif(result_exponent > 0)\r\n{\r\nSgl_set_exponent(result,result_exponent);\r\n*dstptr = result;\r\nreturn(NOEXCEPTION);\r\n}\r\nunderflow:\r\nif(Is_underflowtrap_enabled())\r\n{\r\nSgl_set_sign(result,sign_save);\r\nSgl_setwrapped_exponent(result,result_exponent,unfl);\r\n*dstptr = result;\r\nreturn(UNDERFLOWEXCEPTION);\r\n}\r\nSgl_right_align(result,(1-result_exponent),extent);\r\nSgl_clear_signexponent(result);\r\nSgl_set_sign(result,sign_save);\r\n*dstptr = result;\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nelse\r\n{\r\nSgl_addition(left,right,result);\r\nif(Sgl_isone_hiddenoverflow(result))\r\n{\r\nSgl_rightshiftby1_withextent(result,extent,extent);\r\nSgl_arithrightshiftby1(result);\r\nresult_exponent++;\r\n}\r\n}\r\nround:\r\nif(Ext_isnotzero(extent))\r\n{\r\ninexact = TRUE;\r\nswitch(Rounding_mode())\r\n{\r\ncase ROUNDNEAREST:\r\nif(Ext_isone_sign(extent))\r\n{\r\nif(Ext_isnotzero_lower(extent) ||\r\nSgl_isone_lowmantissa(result))\r\n{\r\nSgl_increment(result);\r\n}\r\n}\r\nbreak;\r\ncase ROUNDPLUS:\r\nif(Sgl_iszero_sign(result))\r\n{\r\nSgl_increment(result);\r\n}\r\nbreak;\r\ncase ROUNDMINUS:\r\nif(Sgl_isone_sign(result))\r\n{\r\nSgl_increment(result);\r\n}\r\ncase ROUNDZERO:;\r\n}\r\nif(Sgl_isone_hiddenoverflow(result)) result_exponent++;\r\n}\r\nif(result_exponent == SGL_INFINITY_EXPONENT)\r\n{\r\nif(Is_overflowtrap_enabled())\r\n{\r\nSgl_setwrapped_exponent(result,result_exponent,ovfl);\r\n*dstptr = result;\r\nif (inexact)\r\nif (Is_inexacttrap_enabled())\r\nreturn(OVERFLOWEXCEPTION | INEXACTEXCEPTION);\r\nelse Set_inexactflag();\r\nreturn(OVERFLOWEXCEPTION);\r\n}\r\nelse\r\n{\r\nSet_overflowflag();\r\ninexact = TRUE;\r\nSgl_setoverflow(result);\r\n}\r\n}\r\nelse Sgl_set_exponent(result,result_exponent);\r\n*dstptr = result;\r\nif(inexact)\r\nif(Is_inexacttrap_enabled()) return(INEXACTEXCEPTION);\r\nelse Set_inexactflag();\r\nreturn(NOEXCEPTION);\r\n}

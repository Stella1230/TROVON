static void encode_fallocate(struct xdr_stream *xdr,\r\nstruct nfs42_falloc_args *args)\r\n{\r\nencode_nfs4_stateid(xdr, &args->falloc_stateid);\r\nencode_uint64(xdr, args->falloc_offset);\r\nencode_uint64(xdr, args->falloc_length);\r\n}\r\nstatic void encode_allocate(struct xdr_stream *xdr,\r\nstruct nfs42_falloc_args *args,\r\nstruct compound_hdr *hdr)\r\n{\r\nencode_op_hdr(xdr, OP_ALLOCATE, decode_allocate_maxsz, hdr);\r\nencode_fallocate(xdr, args);\r\n}\r\nstatic void encode_copy(struct xdr_stream *xdr,\r\nstruct nfs42_copy_args *args,\r\nstruct compound_hdr *hdr)\r\n{\r\nencode_op_hdr(xdr, OP_COPY, decode_copy_maxsz, hdr);\r\nencode_nfs4_stateid(xdr, &args->src_stateid);\r\nencode_nfs4_stateid(xdr, &args->dst_stateid);\r\nencode_uint64(xdr, args->src_pos);\r\nencode_uint64(xdr, args->dst_pos);\r\nencode_uint64(xdr, args->count);\r\nencode_uint32(xdr, 1);\r\nencode_uint32(xdr, 1);\r\nencode_uint32(xdr, 0);\r\n}\r\nstatic void encode_deallocate(struct xdr_stream *xdr,\r\nstruct nfs42_falloc_args *args,\r\nstruct compound_hdr *hdr)\r\n{\r\nencode_op_hdr(xdr, OP_DEALLOCATE, decode_deallocate_maxsz, hdr);\r\nencode_fallocate(xdr, args);\r\n}\r\nstatic void encode_seek(struct xdr_stream *xdr,\r\nstruct nfs42_seek_args *args,\r\nstruct compound_hdr *hdr)\r\n{\r\nencode_op_hdr(xdr, OP_SEEK, decode_seek_maxsz, hdr);\r\nencode_nfs4_stateid(xdr, &args->sa_stateid);\r\nencode_uint64(xdr, args->sa_offset);\r\nencode_uint32(xdr, args->sa_what);\r\n}\r\nstatic void encode_layoutstats(struct xdr_stream *xdr,\r\nstruct nfs42_layoutstat_args *args,\r\nstruct nfs42_layoutstat_devinfo *devinfo,\r\nstruct compound_hdr *hdr)\r\n{\r\n__be32 *p;\r\nencode_op_hdr(xdr, OP_LAYOUTSTATS, decode_layoutstats_maxsz, hdr);\r\np = reserve_space(xdr, 8 + 8);\r\np = xdr_encode_hyper(p, devinfo->offset);\r\np = xdr_encode_hyper(p, devinfo->length);\r\nencode_nfs4_stateid(xdr, &args->stateid);\r\np = reserve_space(xdr, 4*8 + NFS4_DEVICEID4_SIZE + 4);\r\np = xdr_encode_hyper(p, devinfo->read_count);\r\np = xdr_encode_hyper(p, devinfo->read_bytes);\r\np = xdr_encode_hyper(p, devinfo->write_count);\r\np = xdr_encode_hyper(p, devinfo->write_bytes);\r\np = xdr_encode_opaque_fixed(p, devinfo->dev_id.data,\r\nNFS4_DEVICEID4_SIZE);\r\n*p++ = cpu_to_be32(devinfo->layout_type);\r\nif (devinfo->layoutstats_encode != NULL)\r\ndevinfo->layoutstats_encode(xdr, args, devinfo);\r\nelse\r\nencode_uint32(xdr, 0);\r\n}\r\nstatic void encode_clone(struct xdr_stream *xdr,\r\nstruct nfs42_clone_args *args,\r\nstruct compound_hdr *hdr)\r\n{\r\n__be32 *p;\r\nencode_op_hdr(xdr, OP_CLONE, decode_clone_maxsz, hdr);\r\nencode_nfs4_stateid(xdr, &args->src_stateid);\r\nencode_nfs4_stateid(xdr, &args->dst_stateid);\r\np = reserve_space(xdr, 3*8);\r\np = xdr_encode_hyper(p, args->src_offset);\r\np = xdr_encode_hyper(p, args->dst_offset);\r\nxdr_encode_hyper(p, args->count);\r\n}\r\nstatic void nfs4_xdr_enc_allocate(struct rpc_rqst *req,\r\nstruct xdr_stream *xdr,\r\nstruct nfs42_falloc_args *args)\r\n{\r\nstruct compound_hdr hdr = {\r\n.minorversion = nfs4_xdr_minorversion(&args->seq_args),\r\n};\r\nencode_compound_hdr(xdr, req, &hdr);\r\nencode_sequence(xdr, &args->seq_args, &hdr);\r\nencode_putfh(xdr, args->falloc_fh, &hdr);\r\nencode_allocate(xdr, args, &hdr);\r\nencode_getfattr(xdr, args->falloc_bitmask, &hdr);\r\nencode_nops(&hdr);\r\n}\r\nstatic void nfs4_xdr_enc_copy(struct rpc_rqst *req,\r\nstruct xdr_stream *xdr,\r\nstruct nfs42_copy_args *args)\r\n{\r\nstruct compound_hdr hdr = {\r\n.minorversion = nfs4_xdr_minorversion(&args->seq_args),\r\n};\r\nencode_compound_hdr(xdr, req, &hdr);\r\nencode_sequence(xdr, &args->seq_args, &hdr);\r\nencode_putfh(xdr, args->src_fh, &hdr);\r\nencode_savefh(xdr, &hdr);\r\nencode_putfh(xdr, args->dst_fh, &hdr);\r\nencode_copy(xdr, args, &hdr);\r\nencode_nops(&hdr);\r\n}\r\nstatic void nfs4_xdr_enc_deallocate(struct rpc_rqst *req,\r\nstruct xdr_stream *xdr,\r\nstruct nfs42_falloc_args *args)\r\n{\r\nstruct compound_hdr hdr = {\r\n.minorversion = nfs4_xdr_minorversion(&args->seq_args),\r\n};\r\nencode_compound_hdr(xdr, req, &hdr);\r\nencode_sequence(xdr, &args->seq_args, &hdr);\r\nencode_putfh(xdr, args->falloc_fh, &hdr);\r\nencode_deallocate(xdr, args, &hdr);\r\nencode_getfattr(xdr, args->falloc_bitmask, &hdr);\r\nencode_nops(&hdr);\r\n}\r\nstatic void nfs4_xdr_enc_seek(struct rpc_rqst *req,\r\nstruct xdr_stream *xdr,\r\nstruct nfs42_seek_args *args)\r\n{\r\nstruct compound_hdr hdr = {\r\n.minorversion = nfs4_xdr_minorversion(&args->seq_args),\r\n};\r\nencode_compound_hdr(xdr, req, &hdr);\r\nencode_sequence(xdr, &args->seq_args, &hdr);\r\nencode_putfh(xdr, args->sa_fh, &hdr);\r\nencode_seek(xdr, args, &hdr);\r\nencode_nops(&hdr);\r\n}\r\nstatic void nfs4_xdr_enc_layoutstats(struct rpc_rqst *req,\r\nstruct xdr_stream *xdr,\r\nstruct nfs42_layoutstat_args *args)\r\n{\r\nint i;\r\nstruct compound_hdr hdr = {\r\n.minorversion = nfs4_xdr_minorversion(&args->seq_args),\r\n};\r\nencode_compound_hdr(xdr, req, &hdr);\r\nencode_sequence(xdr, &args->seq_args, &hdr);\r\nencode_putfh(xdr, args->fh, &hdr);\r\nWARN_ON(args->num_dev > PNFS_LAYOUTSTATS_MAXDEV);\r\nfor (i = 0; i < args->num_dev; i++)\r\nencode_layoutstats(xdr, args, &args->devinfo[i], &hdr);\r\nencode_nops(&hdr);\r\n}\r\nstatic void nfs4_xdr_enc_clone(struct rpc_rqst *req,\r\nstruct xdr_stream *xdr,\r\nstruct nfs42_clone_args *args)\r\n{\r\nstruct compound_hdr hdr = {\r\n.minorversion = nfs4_xdr_minorversion(&args->seq_args),\r\n};\r\nencode_compound_hdr(xdr, req, &hdr);\r\nencode_sequence(xdr, &args->seq_args, &hdr);\r\nencode_putfh(xdr, args->src_fh, &hdr);\r\nencode_savefh(xdr, &hdr);\r\nencode_putfh(xdr, args->dst_fh, &hdr);\r\nencode_clone(xdr, args, &hdr);\r\nencode_getfattr(xdr, args->dst_bitmask, &hdr);\r\nencode_nops(&hdr);\r\n}\r\nstatic int decode_allocate(struct xdr_stream *xdr, struct nfs42_falloc_res *res)\r\n{\r\nreturn decode_op_hdr(xdr, OP_ALLOCATE);\r\n}\r\nstatic int decode_write_response(struct xdr_stream *xdr,\r\nstruct nfs42_write_res *res)\r\n{\r\n__be32 *p;\r\np = xdr_inline_decode(xdr, 4 + 8 + 4);\r\nif (unlikely(!p))\r\ngoto out_overflow;\r\nif (unlikely(*p != 0)) {\r\npr_err_once("%s: server has set unrequested "\r\n"asynchronous mode\n", __func__);\r\nreturn -EREMOTEIO;\r\n}\r\np++;\r\np = xdr_decode_hyper(p, &res->count);\r\nres->verifier.committed = be32_to_cpup(p);\r\nreturn decode_verifier(xdr, &res->verifier.verifier);\r\nout_overflow:\r\nprint_overflow_msg(__func__, xdr);\r\nreturn -EIO;\r\n}\r\nstatic int decode_copy_requirements(struct xdr_stream *xdr,\r\nstruct nfs42_copy_res *res) {\r\n__be32 *p;\r\np = xdr_inline_decode(xdr, 4 + 4);\r\nif (unlikely(!p))\r\ngoto out_overflow;\r\nres->consecutive = be32_to_cpup(p++);\r\nres->synchronous = be32_to_cpup(p++);\r\nreturn 0;\r\nout_overflow:\r\nprint_overflow_msg(__func__, xdr);\r\nreturn -EIO;\r\n}\r\nstatic int decode_copy(struct xdr_stream *xdr, struct nfs42_copy_res *res)\r\n{\r\nint status;\r\nstatus = decode_op_hdr(xdr, OP_COPY);\r\nif (status == NFS4ERR_OFFLOAD_NO_REQS) {\r\nstatus = decode_copy_requirements(xdr, res);\r\nif (status)\r\nreturn status;\r\nreturn NFS4ERR_OFFLOAD_NO_REQS;\r\n} else if (status)\r\nreturn status;\r\nstatus = decode_write_response(xdr, &res->write_res);\r\nif (status)\r\nreturn status;\r\nreturn decode_copy_requirements(xdr, res);\r\n}\r\nstatic int decode_deallocate(struct xdr_stream *xdr, struct nfs42_falloc_res *res)\r\n{\r\nreturn decode_op_hdr(xdr, OP_DEALLOCATE);\r\n}\r\nstatic int decode_seek(struct xdr_stream *xdr, struct nfs42_seek_res *res)\r\n{\r\nint status;\r\n__be32 *p;\r\nstatus = decode_op_hdr(xdr, OP_SEEK);\r\nif (status)\r\nreturn status;\r\np = xdr_inline_decode(xdr, 4 + 8);\r\nif (unlikely(!p))\r\ngoto out_overflow;\r\nres->sr_eof = be32_to_cpup(p++);\r\np = xdr_decode_hyper(p, &res->sr_offset);\r\nreturn 0;\r\nout_overflow:\r\nprint_overflow_msg(__func__, xdr);\r\nreturn -EIO;\r\n}\r\nstatic int decode_layoutstats(struct xdr_stream *xdr)\r\n{\r\nreturn decode_op_hdr(xdr, OP_LAYOUTSTATS);\r\n}\r\nstatic int decode_clone(struct xdr_stream *xdr)\r\n{\r\nreturn decode_op_hdr(xdr, OP_CLONE);\r\n}\r\nstatic int nfs4_xdr_dec_allocate(struct rpc_rqst *rqstp,\r\nstruct xdr_stream *xdr,\r\nstruct nfs42_falloc_res *res)\r\n{\r\nstruct compound_hdr hdr;\r\nint status;\r\nstatus = decode_compound_hdr(xdr, &hdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_sequence(xdr, &res->seq_res, rqstp);\r\nif (status)\r\ngoto out;\r\nstatus = decode_putfh(xdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_allocate(xdr, res);\r\nif (status)\r\ngoto out;\r\ndecode_getfattr(xdr, res->falloc_fattr, res->falloc_server);\r\nout:\r\nreturn status;\r\n}\r\nstatic int nfs4_xdr_dec_copy(struct rpc_rqst *rqstp,\r\nstruct xdr_stream *xdr,\r\nstruct nfs42_copy_res *res)\r\n{\r\nstruct compound_hdr hdr;\r\nint status;\r\nstatus = decode_compound_hdr(xdr, &hdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_sequence(xdr, &res->seq_res, rqstp);\r\nif (status)\r\ngoto out;\r\nstatus = decode_putfh(xdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_savefh(xdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_putfh(xdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_copy(xdr, res);\r\nout:\r\nreturn status;\r\n}\r\nstatic int nfs4_xdr_dec_deallocate(struct rpc_rqst *rqstp,\r\nstruct xdr_stream *xdr,\r\nstruct nfs42_falloc_res *res)\r\n{\r\nstruct compound_hdr hdr;\r\nint status;\r\nstatus = decode_compound_hdr(xdr, &hdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_sequence(xdr, &res->seq_res, rqstp);\r\nif (status)\r\ngoto out;\r\nstatus = decode_putfh(xdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_deallocate(xdr, res);\r\nif (status)\r\ngoto out;\r\ndecode_getfattr(xdr, res->falloc_fattr, res->falloc_server);\r\nout:\r\nreturn status;\r\n}\r\nstatic int nfs4_xdr_dec_seek(struct rpc_rqst *rqstp,\r\nstruct xdr_stream *xdr,\r\nstruct nfs42_seek_res *res)\r\n{\r\nstruct compound_hdr hdr;\r\nint status;\r\nstatus = decode_compound_hdr(xdr, &hdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_sequence(xdr, &res->seq_res, rqstp);\r\nif (status)\r\ngoto out;\r\nstatus = decode_putfh(xdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_seek(xdr, res);\r\nout:\r\nreturn status;\r\n}\r\nstatic int nfs4_xdr_dec_layoutstats(struct rpc_rqst *rqstp,\r\nstruct xdr_stream *xdr,\r\nstruct nfs42_layoutstat_res *res)\r\n{\r\nstruct compound_hdr hdr;\r\nint status, i;\r\nstatus = decode_compound_hdr(xdr, &hdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_sequence(xdr, &res->seq_res, rqstp);\r\nif (status)\r\ngoto out;\r\nstatus = decode_putfh(xdr);\r\nif (status)\r\ngoto out;\r\nWARN_ON(res->num_dev > PNFS_LAYOUTSTATS_MAXDEV);\r\nfor (i = 0; i < res->num_dev; i++) {\r\nstatus = decode_layoutstats(xdr);\r\nif (status)\r\ngoto out;\r\n}\r\nout:\r\nres->rpc_status = status;\r\nreturn status;\r\n}\r\nstatic int nfs4_xdr_dec_clone(struct rpc_rqst *rqstp,\r\nstruct xdr_stream *xdr,\r\nstruct nfs42_clone_res *res)\r\n{\r\nstruct compound_hdr hdr;\r\nint status;\r\nstatus = decode_compound_hdr(xdr, &hdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_sequence(xdr, &res->seq_res, rqstp);\r\nif (status)\r\ngoto out;\r\nstatus = decode_putfh(xdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_savefh(xdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_putfh(xdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_clone(xdr);\r\nif (status)\r\ngoto out;\r\nstatus = decode_getfattr(xdr, res->dst_fattr, res->server);\r\nout:\r\nres->rpc_status = status;\r\nreturn status;\r\n}

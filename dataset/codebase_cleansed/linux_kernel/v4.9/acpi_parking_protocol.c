void __init acpi_set_mailbox_entry(int cpu,\r\nstruct acpi_madt_generic_interrupt *p)\r\n{\r\nstruct cpu_mailbox_entry *cpu_entry = &cpu_mailbox_entries[cpu];\r\ncpu_entry->mailbox_addr = p->parked_address;\r\ncpu_entry->version = p->parking_version;\r\ncpu_entry->gic_cpu_id = p->cpu_interface_number;\r\n}\r\nbool acpi_parking_protocol_valid(int cpu)\r\n{\r\nstruct cpu_mailbox_entry *cpu_entry = &cpu_mailbox_entries[cpu];\r\nreturn cpu_entry->mailbox_addr && cpu_entry->version;\r\n}\r\nstatic int acpi_parking_protocol_cpu_init(unsigned int cpu)\r\n{\r\npr_debug("%s: ACPI parked addr=%llx\n", __func__,\r\ncpu_mailbox_entries[cpu].mailbox_addr);\r\nreturn 0;\r\n}\r\nstatic int acpi_parking_protocol_cpu_prepare(unsigned int cpu)\r\n{\r\nreturn 0;\r\n}\r\nstatic int acpi_parking_protocol_cpu_boot(unsigned int cpu)\r\n{\r\nstruct cpu_mailbox_entry *cpu_entry = &cpu_mailbox_entries[cpu];\r\nstruct parking_protocol_mailbox __iomem *mailbox;\r\n__le32 cpu_id;\r\nmailbox = ioremap(cpu_entry->mailbox_addr, sizeof(*mailbox));\r\nif (!mailbox)\r\nreturn -EIO;\r\ncpu_id = readl_relaxed(&mailbox->cpu_id);\r\nif (cpu_id != ~0U) {\r\niounmap(mailbox);\r\nreturn -ENXIO;\r\n}\r\ncpu_entry->mailbox = mailbox;\r\nwriteq_relaxed(__pa(secondary_entry), &mailbox->entry_point);\r\nwritel_relaxed(cpu_entry->gic_cpu_id, &mailbox->cpu_id);\r\narch_send_wakeup_ipi_mask(cpumask_of(cpu));\r\nreturn 0;\r\n}\r\nstatic void acpi_parking_protocol_cpu_postboot(void)\r\n{\r\nint cpu = smp_processor_id();\r\nstruct cpu_mailbox_entry *cpu_entry = &cpu_mailbox_entries[cpu];\r\nstruct parking_protocol_mailbox __iomem *mailbox = cpu_entry->mailbox;\r\n__le64 entry_point;\r\nentry_point = readl_relaxed(&mailbox->entry_point);\r\nWARN_ON(entry_point);\r\n}

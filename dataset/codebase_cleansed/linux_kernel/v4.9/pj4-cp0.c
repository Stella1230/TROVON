static int iwmmxt_do(struct notifier_block *self, unsigned long cmd, void *t)\r\n{\r\nstruct thread_info *thread = t;\r\nswitch (cmd) {\r\ncase THREAD_NOTIFY_FLUSH:\r\ncase THREAD_NOTIFY_EXIT:\r\niwmmxt_task_release(thread);\r\nbreak;\r\ncase THREAD_NOTIFY_SWITCH:\r\niwmmxt_task_switch(thread);\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic u32 __init pj4_cp_access_read(void)\r\n{\r\nu32 value;\r\n__asm__ __volatile__ (\r\n"mrc p15, 0, %0, c1, c0, 2\n\t"\r\n: "=r" (value));\r\nreturn value;\r\n}\r\nstatic void __init pj4_cp_access_write(u32 value)\r\n{\r\nu32 temp;\r\n__asm__ __volatile__ (\r\n"mcr p15, 0, %1, c1, c0, 2\n\t"\r\n#ifdef CONFIG_THUMB2_KERNEL\r\n"isb\n\t"\r\n#else\r\n"mrc p15, 0, %0, c1, c0, 2\n\t"\r\n"mov %0, %0\n\t"\r\n"sub pc, pc, #4\n\t"\r\n#endif\r\n: "=r" (temp) : "r" (value));\r\n}\r\nstatic int __init pj4_get_iwmmxt_version(void)\r\n{\r\nu32 cp_access, wcid;\r\ncp_access = pj4_cp_access_read();\r\npj4_cp_access_write(cp_access | 0xf);\r\nif ((pj4_cp_access_read() & 0xf) != 0xf) {\r\npj4_cp_access_write(cp_access);\r\nreturn -ENODEV;\r\n}\r\n__asm__ __volatile__ ("mrc p1, 0, %0, c0, c0, 0\n" : "=r" (wcid));\r\npj4_cp_access_write(cp_access);\r\nif ((wcid & 0xffffff00) == 0x56051000)\r\nreturn 1;\r\nif ((wcid & 0xffffff00) == 0x56052000)\r\nreturn 2;\r\nreturn -EINVAL;\r\n}\r\nstatic int __init pj4_cp0_init(void)\r\n{\r\nu32 __maybe_unused cp_access;\r\nint vers;\r\nif (!cpu_is_pj4())\r\nreturn 0;\r\nvers = pj4_get_iwmmxt_version();\r\nif (vers < 0)\r\nreturn 0;\r\n#ifndef CONFIG_IWMMXT\r\npr_info("PJ4 iWMMXt coprocessor detected, but kernel support is missing.\n");\r\n#else\r\ncp_access = pj4_cp_access_read() & ~0xf;\r\npj4_cp_access_write(cp_access);\r\npr_info("PJ4 iWMMXt v%d coprocessor enabled.\n", vers);\r\nelf_hwcap |= HWCAP_IWMMXT;\r\nthread_register_notifier(&iwmmxt_notifier_block);\r\n#endif\r\nreturn 0;\r\n}

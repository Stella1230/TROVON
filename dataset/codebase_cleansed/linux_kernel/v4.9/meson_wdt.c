static int meson_wdt_restart(struct watchdog_device *wdt_dev,\r\nunsigned long action, void *data)\r\n{\r\nstruct meson_wdt_dev *meson_wdt = watchdog_get_drvdata(wdt_dev);\r\nu32 tc_reboot = MESON_WDT_DC_RESET;\r\ntc_reboot |= meson_wdt->data->enable;\r\nwhile (1) {\r\nwritel(tc_reboot, meson_wdt->wdt_base + MESON_WDT_TC);\r\nmdelay(5);\r\n}\r\nreturn 0;\r\n}\r\nstatic int meson_wdt_ping(struct watchdog_device *wdt_dev)\r\n{\r\nstruct meson_wdt_dev *meson_wdt = watchdog_get_drvdata(wdt_dev);\r\nwritel(0, meson_wdt->wdt_base + MESON_WDT_RESET);\r\nreturn 0;\r\n}\r\nstatic void meson_wdt_change_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int timeout)\r\n{\r\nstruct meson_wdt_dev *meson_wdt = watchdog_get_drvdata(wdt_dev);\r\nu32 reg;\r\nreg = readl(meson_wdt->wdt_base + MESON_WDT_TC);\r\nreg &= ~meson_wdt->data->terminal_count_mask;\r\nreg |= MESON_SEC_TO_TC(timeout, meson_wdt->data->count_unit);\r\nwritel(reg, meson_wdt->wdt_base + MESON_WDT_TC);\r\n}\r\nstatic int meson_wdt_set_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int timeout)\r\n{\r\nwdt_dev->timeout = timeout;\r\nmeson_wdt_change_timeout(wdt_dev, timeout);\r\nmeson_wdt_ping(wdt_dev);\r\nreturn 0;\r\n}\r\nstatic int meson_wdt_stop(struct watchdog_device *wdt_dev)\r\n{\r\nstruct meson_wdt_dev *meson_wdt = watchdog_get_drvdata(wdt_dev);\r\nu32 reg;\r\nreg = readl(meson_wdt->wdt_base + MESON_WDT_TC);\r\nreg &= ~meson_wdt->data->enable;\r\nwritel(reg, meson_wdt->wdt_base + MESON_WDT_TC);\r\nreturn 0;\r\n}\r\nstatic int meson_wdt_start(struct watchdog_device *wdt_dev)\r\n{\r\nstruct meson_wdt_dev *meson_wdt = watchdog_get_drvdata(wdt_dev);\r\nu32 reg;\r\nmeson_wdt_change_timeout(wdt_dev, meson_wdt->wdt_dev.timeout);\r\nmeson_wdt_ping(wdt_dev);\r\nreg = readl(meson_wdt->wdt_base + MESON_WDT_TC);\r\nreg |= meson_wdt->data->enable;\r\nwritel(reg, meson_wdt->wdt_base + MESON_WDT_TC);\r\nreturn 0;\r\n}\r\nstatic int meson_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct meson_wdt_dev *meson_wdt;\r\nconst struct of_device_id *of_id;\r\nint err;\r\nmeson_wdt = devm_kzalloc(&pdev->dev, sizeof(*meson_wdt), GFP_KERNEL);\r\nif (!meson_wdt)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nmeson_wdt->wdt_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(meson_wdt->wdt_base))\r\nreturn PTR_ERR(meson_wdt->wdt_base);\r\nof_id = of_match_device(meson_wdt_dt_ids, &pdev->dev);\r\nif (!of_id) {\r\ndev_err(&pdev->dev, "Unable to initialize WDT data\n");\r\nreturn -ENODEV;\r\n}\r\nmeson_wdt->data = of_id->data;\r\nmeson_wdt->wdt_dev.parent = &pdev->dev;\r\nmeson_wdt->wdt_dev.info = &meson_wdt_info;\r\nmeson_wdt->wdt_dev.ops = &meson_wdt_ops;\r\nmeson_wdt->wdt_dev.max_timeout =\r\nmeson_wdt->data->terminal_count_mask / meson_wdt->data->count_unit;\r\nmeson_wdt->wdt_dev.min_timeout = MESON_WDT_MIN_TIMEOUT;\r\nmeson_wdt->wdt_dev.timeout = min_t(unsigned int,\r\nMESON_WDT_TIMEOUT,\r\nmeson_wdt->wdt_dev.max_timeout);\r\nwatchdog_set_drvdata(&meson_wdt->wdt_dev, meson_wdt);\r\nwatchdog_init_timeout(&meson_wdt->wdt_dev, timeout, &pdev->dev);\r\nwatchdog_set_nowayout(&meson_wdt->wdt_dev, nowayout);\r\nwatchdog_set_restart_priority(&meson_wdt->wdt_dev, 128);\r\nmeson_wdt_stop(&meson_wdt->wdt_dev);\r\nerr = watchdog_register_device(&meson_wdt->wdt_dev);\r\nif (err)\r\nreturn err;\r\nplatform_set_drvdata(pdev, meson_wdt);\r\ndev_info(&pdev->dev, "Watchdog enabled (timeout=%d sec, nowayout=%d)",\r\nmeson_wdt->wdt_dev.timeout, nowayout);\r\nreturn 0;\r\n}\r\nstatic int meson_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct meson_wdt_dev *meson_wdt = platform_get_drvdata(pdev);\r\nwatchdog_unregister_device(&meson_wdt->wdt_dev);\r\nreturn 0;\r\n}\r\nstatic void meson_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nstruct meson_wdt_dev *meson_wdt = platform_get_drvdata(pdev);\r\nmeson_wdt_stop(&meson_wdt->wdt_dev);\r\n}

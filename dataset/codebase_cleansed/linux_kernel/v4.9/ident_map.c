static void ident_pmd_init(struct x86_mapping_info *info, pmd_t *pmd_page,\r\nunsigned long addr, unsigned long end)\r\n{\r\naddr &= PMD_MASK;\r\nfor (; addr < end; addr += PMD_SIZE) {\r\npmd_t *pmd = pmd_page + pmd_index(addr);\r\nif (pmd_present(*pmd))\r\ncontinue;\r\nset_pmd(pmd, __pmd((addr - info->offset) | info->pmd_flag));\r\n}\r\n}\r\nstatic int ident_pud_init(struct x86_mapping_info *info, pud_t *pud_page,\r\nunsigned long addr, unsigned long end)\r\n{\r\nunsigned long next;\r\nfor (; addr < end; addr = next) {\r\npud_t *pud = pud_page + pud_index(addr);\r\npmd_t *pmd;\r\nnext = (addr & PUD_MASK) + PUD_SIZE;\r\nif (next > end)\r\nnext = end;\r\nif (pud_present(*pud)) {\r\npmd = pmd_offset(pud, 0);\r\nident_pmd_init(info, pmd, addr, next);\r\ncontinue;\r\n}\r\npmd = (pmd_t *)info->alloc_pgt_page(info->context);\r\nif (!pmd)\r\nreturn -ENOMEM;\r\nident_pmd_init(info, pmd, addr, next);\r\nset_pud(pud, __pud(__pa(pmd) | _KERNPG_TABLE));\r\n}\r\nreturn 0;\r\n}\r\nint kernel_ident_mapping_init(struct x86_mapping_info *info, pgd_t *pgd_page,\r\nunsigned long pstart, unsigned long pend)\r\n{\r\nunsigned long addr = pstart + info->offset;\r\nunsigned long end = pend + info->offset;\r\nunsigned long next;\r\nint result;\r\nfor (; addr < end; addr = next) {\r\npgd_t *pgd = pgd_page + pgd_index(addr);\r\npud_t *pud;\r\nnext = (addr & PGDIR_MASK) + PGDIR_SIZE;\r\nif (next > end)\r\nnext = end;\r\nif (pgd_present(*pgd)) {\r\npud = pud_offset(pgd, 0);\r\nresult = ident_pud_init(info, pud, addr, next);\r\nif (result)\r\nreturn result;\r\ncontinue;\r\n}\r\npud = (pud_t *)info->alloc_pgt_page(info->context);\r\nif (!pud)\r\nreturn -ENOMEM;\r\nresult = ident_pud_init(info, pud, addr, next);\r\nif (result)\r\nreturn result;\r\nset_pgd(pgd, __pgd(__pa(pud) | _KERNPG_TABLE));\r\n}\r\nreturn 0;\r\n}

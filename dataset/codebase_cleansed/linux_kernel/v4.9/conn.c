static int\r\nnvkm_connector_hpd(struct nvkm_notify *notify)\r\n{\r\nstruct nvkm_connector *conn = container_of(notify, typeof(*conn), hpd);\r\nstruct nvkm_disp *disp = conn->disp;\r\nstruct nvkm_gpio *gpio = disp->engine.subdev.device->gpio;\r\nconst struct nvkm_gpio_ntfy_rep *line = notify->data;\r\nstruct nvif_notify_conn_rep_v0 rep;\r\nint index = conn->index;\r\nCONN_DBG(conn, "HPD: %d", line->mask);\r\nif (!nvkm_gpio_get(gpio, 0, DCB_GPIO_UNUSED, conn->hpd.index))\r\nrep.mask = NVIF_NOTIFY_CONN_V0_UNPLUG;\r\nelse\r\nrep.mask = NVIF_NOTIFY_CONN_V0_PLUG;\r\nrep.version = 0;\r\nnvkm_event_send(&disp->hpd, rep.mask, index, &rep, sizeof(rep));\r\nreturn NVKM_NOTIFY_KEEP;\r\n}\r\nvoid\r\nnvkm_connector_fini(struct nvkm_connector *conn)\r\n{\r\nnvkm_notify_put(&conn->hpd);\r\n}\r\nvoid\r\nnvkm_connector_init(struct nvkm_connector *conn)\r\n{\r\nnvkm_notify_get(&conn->hpd);\r\n}\r\nvoid\r\nnvkm_connector_del(struct nvkm_connector **pconn)\r\n{\r\nstruct nvkm_connector *conn = *pconn;\r\nif (conn) {\r\nnvkm_notify_fini(&conn->hpd);\r\nkfree(*pconn);\r\n*pconn = NULL;\r\n}\r\n}\r\nstatic void\r\nnvkm_connector_ctor(struct nvkm_disp *disp, int index,\r\nstruct nvbios_connE *info, struct nvkm_connector *conn)\r\n{\r\nstatic const u8 hpd[] = { 0x07, 0x08, 0x51, 0x52, 0x5e, 0x5f, 0x60 };\r\nstruct nvkm_gpio *gpio = disp->engine.subdev.device->gpio;\r\nstruct dcb_gpio_func func;\r\nint ret;\r\nconn->disp = disp;\r\nconn->index = index;\r\nconn->info = *info;\r\nCONN_DBG(conn, "type %02x loc %d hpd %02x dp %x di %x sr %x lcdid %x",\r\ninfo->type, info->location, info->hpd, info->dp,\r\ninfo->di, info->sr, info->lcdid);\r\nif ((info->hpd = ffs(info->hpd))) {\r\nif (--info->hpd >= ARRAY_SIZE(hpd)) {\r\nCONN_ERR(conn, "hpd %02x unknown", info->hpd);\r\nreturn;\r\n}\r\ninfo->hpd = hpd[info->hpd];\r\nret = nvkm_gpio_find(gpio, 0, info->hpd, DCB_GPIO_UNUSED, &func);\r\nif (ret) {\r\nCONN_ERR(conn, "func %02x lookup failed, %d",\r\ninfo->hpd, ret);\r\nreturn;\r\n}\r\nret = nvkm_notify_init(NULL, &gpio->event, nvkm_connector_hpd,\r\ntrue, &(struct nvkm_gpio_ntfy_req) {\r\n.mask = NVKM_GPIO_TOGGLED,\r\n.line = func.line,\r\n},\r\nsizeof(struct nvkm_gpio_ntfy_req),\r\nsizeof(struct nvkm_gpio_ntfy_rep),\r\n&conn->hpd);\r\nif (ret) {\r\nCONN_ERR(conn, "func %02x failed, %d", info->hpd, ret);\r\n} else {\r\nCONN_DBG(conn, "func %02x (HPD)", info->hpd);\r\n}\r\n}\r\n}\r\nint\r\nnvkm_connector_new(struct nvkm_disp *disp, int index,\r\nstruct nvbios_connE *info, struct nvkm_connector **pconn)\r\n{\r\nif (!(*pconn = kzalloc(sizeof(**pconn), GFP_KERNEL)))\r\nreturn -ENOMEM;\r\nnvkm_connector_ctor(disp, index, info, *pconn);\r\nreturn 0;\r\n}

static int gpio_ir_recv_get_devtree_pdata(struct device *dev,\r\nstruct gpio_ir_recv_platform_data *pdata)\r\n{\r\nstruct device_node *np = dev->of_node;\r\nenum of_gpio_flags flags;\r\nint gpio;\r\ngpio = of_get_gpio_flags(np, 0, &flags);\r\nif (gpio < 0) {\r\nif (gpio != -EPROBE_DEFER)\r\ndev_err(dev, "Failed to get gpio flags (%d)\n", gpio);\r\nreturn gpio;\r\n}\r\npdata->gpio_nr = gpio;\r\npdata->active_low = (flags & OF_GPIO_ACTIVE_LOW);\r\npdata->map_name = of_get_property(np, "linux,rc-map-name", NULL);\r\npdata->allowed_protos = 0;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t gpio_ir_recv_irq(int irq, void *dev_id)\r\n{\r\nstruct gpio_rc_dev *gpio_dev = dev_id;\r\nint gval;\r\nint rc = 0;\r\nenum raw_event_type type = IR_SPACE;\r\ngval = gpio_get_value(gpio_dev->gpio_nr);\r\nif (gval < 0)\r\ngoto err_get_value;\r\nif (gpio_dev->active_low)\r\ngval = !gval;\r\nif (gval == 1)\r\ntype = IR_PULSE;\r\nrc = ir_raw_event_store_edge(gpio_dev->rcdev, type);\r\nif (rc < 0)\r\ngoto err_get_value;\r\nmod_timer(&gpio_dev->flush_timer,\r\njiffies + nsecs_to_jiffies(gpio_dev->rcdev->timeout));\r\nir_raw_event_handle(gpio_dev->rcdev);\r\nerr_get_value:\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void flush_timer(unsigned long arg)\r\n{\r\nstruct gpio_rc_dev *gpio_dev = (struct gpio_rc_dev *)arg;\r\nDEFINE_IR_RAW_EVENT(ev);\r\nev.timeout = true;\r\nev.duration = gpio_dev->rcdev->timeout;\r\nir_raw_event_store(gpio_dev->rcdev, &ev);\r\nir_raw_event_handle(gpio_dev->rcdev);\r\n}\r\nstatic int gpio_ir_recv_probe(struct platform_device *pdev)\r\n{\r\nstruct gpio_rc_dev *gpio_dev;\r\nstruct rc_dev *rcdev;\r\nconst struct gpio_ir_recv_platform_data *pdata =\r\npdev->dev.platform_data;\r\nint rc;\r\nif (pdev->dev.of_node) {\r\nstruct gpio_ir_recv_platform_data *dtpdata =\r\ndevm_kzalloc(&pdev->dev, sizeof(*dtpdata), GFP_KERNEL);\r\nif (!dtpdata)\r\nreturn -ENOMEM;\r\nrc = gpio_ir_recv_get_devtree_pdata(&pdev->dev, dtpdata);\r\nif (rc)\r\nreturn rc;\r\npdata = dtpdata;\r\n}\r\nif (!pdata)\r\nreturn -EINVAL;\r\nif (pdata->gpio_nr < 0)\r\nreturn -EINVAL;\r\ngpio_dev = kzalloc(sizeof(struct gpio_rc_dev), GFP_KERNEL);\r\nif (!gpio_dev)\r\nreturn -ENOMEM;\r\nrcdev = rc_allocate_device();\r\nif (!rcdev) {\r\nrc = -ENOMEM;\r\ngoto err_allocate_device;\r\n}\r\nrcdev->priv = gpio_dev;\r\nrcdev->driver_type = RC_DRIVER_IR_RAW;\r\nrcdev->input_name = GPIO_IR_DEVICE_NAME;\r\nrcdev->input_phys = GPIO_IR_DEVICE_NAME "/input0";\r\nrcdev->input_id.bustype = BUS_HOST;\r\nrcdev->input_id.vendor = 0x0001;\r\nrcdev->input_id.product = 0x0001;\r\nrcdev->input_id.version = 0x0100;\r\nrcdev->dev.parent = &pdev->dev;\r\nrcdev->driver_name = GPIO_IR_DRIVER_NAME;\r\nrcdev->min_timeout = 0;\r\nrcdev->timeout = IR_DEFAULT_TIMEOUT;\r\nrcdev->max_timeout = 10 * IR_DEFAULT_TIMEOUT;\r\nif (pdata->allowed_protos)\r\nrcdev->allowed_protocols = pdata->allowed_protos;\r\nelse\r\nrcdev->allowed_protocols = RC_BIT_ALL;\r\nrcdev->map_name = pdata->map_name ?: RC_MAP_EMPTY;\r\ngpio_dev->rcdev = rcdev;\r\ngpio_dev->gpio_nr = pdata->gpio_nr;\r\ngpio_dev->active_low = pdata->active_low;\r\nsetup_timer(&gpio_dev->flush_timer, flush_timer,\r\n(unsigned long)gpio_dev);\r\nrc = gpio_request(pdata->gpio_nr, "gpio-ir-recv");\r\nif (rc < 0)\r\ngoto err_gpio_request;\r\nrc = gpio_direction_input(pdata->gpio_nr);\r\nif (rc < 0)\r\ngoto err_gpio_direction_input;\r\nrc = rc_register_device(rcdev);\r\nif (rc < 0) {\r\ndev_err(&pdev->dev, "failed to register rc device\n");\r\ngoto err_register_rc_device;\r\n}\r\nplatform_set_drvdata(pdev, gpio_dev);\r\nrc = request_any_context_irq(gpio_to_irq(pdata->gpio_nr),\r\ngpio_ir_recv_irq,\r\nIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING,\r\n"gpio-ir-recv-irq", gpio_dev);\r\nif (rc < 0)\r\ngoto err_request_irq;\r\nreturn 0;\r\nerr_request_irq:\r\nrc_unregister_device(rcdev);\r\nrcdev = NULL;\r\nerr_register_rc_device:\r\nerr_gpio_direction_input:\r\ngpio_free(pdata->gpio_nr);\r\nerr_gpio_request:\r\nrc_free_device(rcdev);\r\nerr_allocate_device:\r\nkfree(gpio_dev);\r\nreturn rc;\r\n}\r\nstatic int gpio_ir_recv_remove(struct platform_device *pdev)\r\n{\r\nstruct gpio_rc_dev *gpio_dev = platform_get_drvdata(pdev);\r\nfree_irq(gpio_to_irq(gpio_dev->gpio_nr), gpio_dev);\r\ndel_timer_sync(&gpio_dev->flush_timer);\r\nrc_unregister_device(gpio_dev->rcdev);\r\ngpio_free(gpio_dev->gpio_nr);\r\nkfree(gpio_dev);\r\nreturn 0;\r\n}\r\nstatic int gpio_ir_recv_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct gpio_rc_dev *gpio_dev = platform_get_drvdata(pdev);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(gpio_to_irq(gpio_dev->gpio_nr));\r\nelse\r\ndisable_irq(gpio_to_irq(gpio_dev->gpio_nr));\r\nreturn 0;\r\n}\r\nstatic int gpio_ir_recv_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct gpio_rc_dev *gpio_dev = platform_get_drvdata(pdev);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(gpio_to_irq(gpio_dev->gpio_nr));\r\nelse\r\nenable_irq(gpio_to_irq(gpio_dev->gpio_nr));\r\nreturn 0;\r\n}

static int konepure_init_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct usb_device *usb_dev = interface_to_usbdev(intf);\r\nstruct roccat_common2_device *konepure;\r\nint retval;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n!= USB_INTERFACE_PROTOCOL_MOUSE) {\r\nhid_set_drvdata(hdev, NULL);\r\nreturn 0;\r\n}\r\nkonepure = kzalloc(sizeof(*konepure), GFP_KERNEL);\r\nif (!konepure) {\r\nhid_err(hdev, "can't alloc device descriptor\n");\r\nreturn -ENOMEM;\r\n}\r\nhid_set_drvdata(hdev, konepure);\r\nretval = roccat_common2_device_init_struct(usb_dev, konepure);\r\nif (retval) {\r\nhid_err(hdev, "couldn't init KonePure device\n");\r\ngoto exit_free;\r\n}\r\nretval = roccat_connect(konepure_class, hdev,\r\nsizeof(struct konepure_mouse_report_button));\r\nif (retval < 0) {\r\nhid_err(hdev, "couldn't init char dev\n");\r\n} else {\r\nkonepure->chrdev_minor = retval;\r\nkonepure->roccat_claimed = 1;\r\n}\r\nreturn 0;\r\nexit_free:\r\nkfree(konepure);\r\nreturn retval;\r\n}\r\nstatic void konepure_remove_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct roccat_common2_device *konepure;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n!= USB_INTERFACE_PROTOCOL_MOUSE)\r\nreturn;\r\nkonepure = hid_get_drvdata(hdev);\r\nif (konepure->roccat_claimed)\r\nroccat_disconnect(konepure->chrdev_minor);\r\nkfree(konepure);\r\n}\r\nstatic int konepure_probe(struct hid_device *hdev,\r\nconst struct hid_device_id *id)\r\n{\r\nint retval;\r\nretval = hid_parse(hdev);\r\nif (retval) {\r\nhid_err(hdev, "parse failed\n");\r\ngoto exit;\r\n}\r\nretval = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\r\nif (retval) {\r\nhid_err(hdev, "hw start failed\n");\r\ngoto exit;\r\n}\r\nretval = konepure_init_specials(hdev);\r\nif (retval) {\r\nhid_err(hdev, "couldn't install mouse\n");\r\ngoto exit_stop;\r\n}\r\nreturn 0;\r\nexit_stop:\r\nhid_hw_stop(hdev);\r\nexit:\r\nreturn retval;\r\n}\r\nstatic void konepure_remove(struct hid_device *hdev)\r\n{\r\nkonepure_remove_specials(hdev);\r\nhid_hw_stop(hdev);\r\n}\r\nstatic int konepure_raw_event(struct hid_device *hdev,\r\nstruct hid_report *report, u8 *data, int size)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct roccat_common2_device *konepure = hid_get_drvdata(hdev);\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n!= USB_INTERFACE_PROTOCOL_MOUSE)\r\nreturn 0;\r\nif (data[0] != KONEPURE_MOUSE_REPORT_NUMBER_BUTTON)\r\nreturn 0;\r\nif (konepure != NULL && konepure->roccat_claimed)\r\nroccat_report_event(konepure->chrdev_minor, data);\r\nreturn 0;\r\n}\r\nstatic int __init konepure_init(void)\r\n{\r\nint retval;\r\nkonepure_class = class_create(THIS_MODULE, "konepure");\r\nif (IS_ERR(konepure_class))\r\nreturn PTR_ERR(konepure_class);\r\nkonepure_class->dev_groups = konepure_groups;\r\nretval = hid_register_driver(&konepure_driver);\r\nif (retval)\r\nclass_destroy(konepure_class);\r\nreturn retval;\r\n}\r\nstatic void __exit konepure_exit(void)\r\n{\r\nhid_unregister_driver(&konepure_driver);\r\nclass_destroy(konepure_class);\r\n}

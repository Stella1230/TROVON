resource_size_t pcibios_align_resource(void *data, const struct resource *res,\r\nresource_size_t size, resource_size_t align)\r\n{\r\nresource_size_t start = res->start;\r\n#if 0\r\nstruct pci_dev *dev = data;\r\nprintk(KERN_DEBUG\r\n"### PCIBIOS_ALIGN_RESOURCE(%s,,{%08lx-%08lx,%08lx},%lx)\n",\r\npci_name(dev),\r\nres->start,\r\nres->end,\r\nres->flags,\r\nsize\r\n);\r\n#endif\r\nif ((res->flags & IORESOURCE_IO) && (start & 0x300))\r\nstart = (start + 0x3ff) & ~0x3ff;\r\nreturn start;\r\n}\r\nstatic void __init pcibios_allocate_bus_resources(struct list_head *bus_list)\r\n{\r\nstruct pci_bus *bus;\r\nstruct pci_dev *dev;\r\nint idx;\r\nstruct resource *r;\r\nlist_for_each_entry(bus, bus_list, node) {\r\ndev = bus->self;\r\nif (dev) {\r\nfor (idx = PCI_BRIDGE_RESOURCES;\r\nidx < PCI_NUM_RESOURCES;\r\nidx++) {\r\nr = &dev->resource[idx];\r\nif (!r->flags)\r\ncontinue;\r\nif (!r->start ||\r\npci_claim_bridge_resource(dev, idx) < 0) {\r\nprintk(KERN_ERR "PCI:"\r\n" Cannot allocate resource"\r\n" region %d of bridge %s\n",\r\nidx, pci_name(dev));\r\nr->start = r->end = 0;\r\nr->flags = 0;\r\n}\r\n}\r\n}\r\npcibios_allocate_bus_resources(&bus->children);\r\n}\r\n}\r\nstatic void __init pcibios_allocate_resources(int pass)\r\n{\r\nstruct pci_dev *dev = NULL;\r\nint idx, disabled;\r\nu16 command;\r\nstruct resource *r;\r\nfor_each_pci_dev(dev) {\r\npci_read_config_word(dev, PCI_COMMAND, &command);\r\nfor (idx = 0; idx < 6; idx++) {\r\nr = &dev->resource[idx];\r\nif (r->parent)\r\ncontinue;\r\nif (!r->start)\r\ncontinue;\r\nif (r->flags & IORESOURCE_IO)\r\ndisabled = !(command & PCI_COMMAND_IO);\r\nelse\r\ndisabled = !(command & PCI_COMMAND_MEMORY);\r\nif (pass == disabled) {\r\nDBG("PCI[%s]: Resource %08lx-%08lx"\r\n" (f=%lx, d=%d, p=%d)\n",\r\npci_name(dev), r->start, r->end, r->flags,\r\ndisabled, pass);\r\nif (pci_claim_resource(dev, idx) < 0) {\r\nprintk(KERN_ERR "PCI:"\r\n" Cannot allocate resource"\r\n" region %d of device %s\n",\r\nidx, pci_name(dev));\r\nr->end -= r->start;\r\nr->start = 0;\r\n}\r\n}\r\n}\r\nif (!pass) {\r\nr = &dev->resource[PCI_ROM_RESOURCE];\r\nif (r->flags & IORESOURCE_ROM_ENABLE) {\r\nu32 reg;\r\nDBG("PCI: Switching off ROM of %s\n",\r\npci_name(dev));\r\nr->flags &= ~IORESOURCE_ROM_ENABLE;\r\npci_read_config_dword(\r\ndev, dev->rom_base_reg, &reg);\r\npci_write_config_dword(\r\ndev, dev->rom_base_reg,\r\nreg & ~PCI_ROM_ADDRESS_ENABLE);\r\n}\r\n}\r\n}\r\n}\r\nstatic int __init pcibios_assign_resources(void)\r\n{\r\nstruct pci_dev *dev = NULL;\r\nstruct resource *r;\r\nfor_each_pci_dev(dev) {\r\nr = &dev->resource[PCI_ROM_RESOURCE];\r\nif (!r->flags || !r->start)\r\ncontinue;\r\nif (pci_claim_resource(dev, PCI_ROM_RESOURCE) < 0) {\r\nr->end -= r->start;\r\nr->start = 0;\r\n}\r\n}\r\npci_assign_unassigned_resources();\r\nreturn 0;\r\n}\r\nvoid __init pcibios_resource_survey(void)\r\n{\r\nDBG("PCI: Allocating resources\n");\r\npcibios_allocate_bus_resources(&pci_root_buses);\r\npcibios_allocate_resources(0);\r\npcibios_allocate_resources(1);\r\n}\r\nint pci_mmap_page_range(struct pci_dev *dev, struct vm_area_struct *vma,\r\nenum pci_mmap_state mmap_state, int write_combine)\r\n{\r\nunsigned long prot;\r\nvma->vm_flags |= VM_LOCKED;\r\nprot = pgprot_val(vma->vm_page_prot);\r\nprot &= ~_PAGE_CACHE;\r\nvma->vm_page_prot = __pgprot(prot);\r\nif (io_remap_pfn_range(vma, vma->vm_start, vma->vm_pgoff,\r\nvma->vm_end - vma->vm_start,\r\nvma->vm_page_prot))\r\nreturn -EAGAIN;\r\nreturn 0;\r\n}

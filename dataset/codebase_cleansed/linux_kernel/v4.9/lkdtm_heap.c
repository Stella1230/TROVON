void lkdtm_OVERWRITE_ALLOCATION(void)\r\n{\r\nsize_t len = 1020;\r\nu32 *data = kmalloc(len, GFP_KERNEL);\r\ndata[1024 / sizeof(u32)] = 0x12345678;\r\nkfree(data);\r\n}\r\nvoid lkdtm_WRITE_AFTER_FREE(void)\r\n{\r\nint *base, *again;\r\nsize_t len = 1024;\r\nsize_t offset = (len / sizeof(*base)) / 2;\r\nbase = kmalloc(len, GFP_KERNEL);\r\npr_info("Allocated memory %p-%p\n", base, &base[offset * 2]);\r\npr_info("Attempting bad write to freed memory at %p\n",\r\n&base[offset]);\r\nkfree(base);\r\nbase[offset] = 0x0abcdef0;\r\nagain = kmalloc(len, GFP_KERNEL);\r\nkfree(again);\r\nif (again != base)\r\npr_info("Hmm, didn't get the same memory range.\n");\r\n}\r\nvoid lkdtm_READ_AFTER_FREE(void)\r\n{\r\nint *base, *val, saw;\r\nsize_t len = 1024;\r\nsize_t offset = (len / sizeof(*base)) / 2;\r\nbase = kmalloc(len, GFP_KERNEL);\r\nif (!base) {\r\npr_info("Unable to allocate base memory.\n");\r\nreturn;\r\n}\r\nval = kmalloc(len, GFP_KERNEL);\r\nif (!val) {\r\npr_info("Unable to allocate val memory.\n");\r\nkfree(base);\r\nreturn;\r\n}\r\n*val = 0x12345678;\r\nbase[offset] = *val;\r\npr_info("Value in memory before free: %x\n", base[offset]);\r\nkfree(base);\r\npr_info("Attempting bad read from freed memory\n");\r\nsaw = base[offset];\r\nif (saw != *val) {\r\npr_info("Memory correctly poisoned (%x)\n", saw);\r\nBUG();\r\n}\r\npr_info("Memory was not poisoned\n");\r\nkfree(val);\r\n}\r\nvoid lkdtm_WRITE_BUDDY_AFTER_FREE(void)\r\n{\r\nunsigned long p = __get_free_page(GFP_KERNEL);\r\nif (!p) {\r\npr_info("Unable to allocate free page\n");\r\nreturn;\r\n}\r\npr_info("Writing to the buddy page before free\n");\r\nmemset((void *)p, 0x3, PAGE_SIZE);\r\nfree_page(p);\r\nschedule();\r\npr_info("Attempting bad write to the buddy page after free\n");\r\nmemset((void *)p, 0x78, PAGE_SIZE);\r\np = __get_free_page(GFP_KERNEL);\r\nfree_page(p);\r\nschedule();\r\n}\r\nvoid lkdtm_READ_BUDDY_AFTER_FREE(void)\r\n{\r\nunsigned long p = __get_free_page(GFP_KERNEL);\r\nint saw, *val;\r\nint *base;\r\nif (!p) {\r\npr_info("Unable to allocate free page\n");\r\nreturn;\r\n}\r\nval = kmalloc(1024, GFP_KERNEL);\r\nif (!val) {\r\npr_info("Unable to allocate val memory.\n");\r\nfree_page(p);\r\nreturn;\r\n}\r\nbase = (int *)p;\r\n*val = 0x12345678;\r\nbase[0] = *val;\r\npr_info("Value in memory before free: %x\n", base[0]);\r\nfree_page(p);\r\npr_info("Attempting to read from freed memory\n");\r\nsaw = base[0];\r\nif (saw != *val) {\r\npr_info("Memory correctly poisoned (%x)\n", saw);\r\nBUG();\r\n}\r\npr_info("Buddy page was not poisoned\n");\r\nkfree(val);\r\n}

static int mt6323_get_status(struct regulator_dev *rdev)\r\n{\r\nint ret;\r\nu32 regval;\r\nstruct mt6323_regulator_info *info = rdev_get_drvdata(rdev);\r\nret = regmap_read(rdev->regmap, info->desc.enable_reg, &regval);\r\nif (ret != 0) {\r\ndev_err(&rdev->dev, "Failed to get enable reg: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn (regval & info->qi) ? REGULATOR_STATUS_ON : REGULATOR_STATUS_OFF;\r\n}\r\nstatic int mt6323_ldo_set_mode(struct regulator_dev *rdev, unsigned int mode)\r\n{\r\nint ret, val = 0;\r\nstruct mt6323_regulator_info *info = rdev_get_drvdata(rdev);\r\nif (!info->modeset_mask) {\r\ndev_err(&rdev->dev, "regulator %s doesn't support set_mode\n",\r\ninfo->desc.name);\r\nreturn -EINVAL;\r\n}\r\nswitch (mode) {\r\ncase REGULATOR_MODE_STANDBY:\r\nval = MT6323_LDO_MODE_LP;\r\nbreak;\r\ncase REGULATOR_MODE_NORMAL:\r\nval = MT6323_LDO_MODE_NORMAL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nval <<= ffs(info->modeset_mask) - 1;\r\nret = regmap_update_bits(rdev->regmap, info->modeset_reg,\r\ninfo->modeset_mask, val);\r\nreturn ret;\r\n}\r\nstatic unsigned int mt6323_ldo_get_mode(struct regulator_dev *rdev)\r\n{\r\nunsigned int val;\r\nunsigned int mode;\r\nint ret;\r\nstruct mt6323_regulator_info *info = rdev_get_drvdata(rdev);\r\nif (!info->modeset_mask) {\r\ndev_err(&rdev->dev, "regulator %s doesn't support get_mode\n",\r\ninfo->desc.name);\r\nreturn -EINVAL;\r\n}\r\nret = regmap_read(rdev->regmap, info->modeset_reg, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nval &= info->modeset_mask;\r\nval >>= ffs(info->modeset_mask) - 1;\r\nif (val & 0x1)\r\nmode = REGULATOR_MODE_STANDBY;\r\nelse\r\nmode = REGULATOR_MODE_NORMAL;\r\nreturn mode;\r\n}\r\nstatic int mt6323_set_buck_vosel_reg(struct platform_device *pdev)\r\n{\r\nstruct mt6397_chip *mt6323 = dev_get_drvdata(pdev->dev.parent);\r\nint i;\r\nu32 regval;\r\nfor (i = 0; i < MT6323_MAX_REGULATOR; i++) {\r\nif (mt6323_regulators[i].vselctrl_reg) {\r\nif (regmap_read(mt6323->regmap,\r\nmt6323_regulators[i].vselctrl_reg,\r\n&regval) < 0) {\r\ndev_err(&pdev->dev,\r\n"Failed to read buck ctrl\n");\r\nreturn -EIO;\r\n}\r\nif (regval & mt6323_regulators[i].vselctrl_mask) {\r\nmt6323_regulators[i].desc.vsel_reg =\r\nmt6323_regulators[i].vselon_reg;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int mt6323_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct mt6397_chip *mt6323 = dev_get_drvdata(pdev->dev.parent);\r\nstruct regulator_config config = {};\r\nstruct regulator_dev *rdev;\r\nint i;\r\nu32 reg_value;\r\nif (mt6323_set_buck_vosel_reg(pdev))\r\nreturn -EIO;\r\nif (regmap_read(mt6323->regmap, MT6323_CID, &reg_value) < 0) {\r\ndev_err(&pdev->dev, "Failed to read Chip ID\n");\r\nreturn -EIO;\r\n}\r\ndev_info(&pdev->dev, "Chip ID = 0x%x\n", reg_value);\r\nfor (i = 0; i < MT6323_MAX_REGULATOR; i++) {\r\nconfig.dev = &pdev->dev;\r\nconfig.driver_data = &mt6323_regulators[i];\r\nconfig.regmap = mt6323->regmap;\r\nrdev = devm_regulator_register(&pdev->dev,\r\n&mt6323_regulators[i].desc, &config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(&pdev->dev, "failed to register %s\n",\r\nmt6323_regulators[i].desc.name);\r\nreturn PTR_ERR(rdev);\r\n}\r\n}\r\nreturn 0;\r\n}

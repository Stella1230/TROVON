static inline uint32_t jz4740_i2s_read(const struct jz4740_i2s *i2s,\r\nunsigned int reg)\r\n{\r\nreturn readl(i2s->base + reg);\r\n}\r\nstatic inline void jz4740_i2s_write(const struct jz4740_i2s *i2s,\r\nunsigned int reg, uint32_t value)\r\n{\r\nwritel(value, i2s->base + reg);\r\n}\r\nstatic int jz4740_i2s_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t conf, ctrl;\r\nif (dai->active)\r\nreturn 0;\r\nctrl = jz4740_i2s_read(i2s, JZ_REG_AIC_CTRL);\r\nctrl |= JZ_AIC_CTRL_FLUSH;\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CTRL, ctrl);\r\nclk_prepare_enable(i2s->clk_i2s);\r\nconf = jz4740_i2s_read(i2s, JZ_REG_AIC_CONF);\r\nconf |= JZ_AIC_CONF_ENABLE;\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CONF, conf);\r\nreturn 0;\r\n}\r\nstatic void jz4740_i2s_shutdown(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t conf;\r\nif (dai->active)\r\nreturn;\r\nconf = jz4740_i2s_read(i2s, JZ_REG_AIC_CONF);\r\nconf &= ~JZ_AIC_CONF_ENABLE;\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CONF, conf);\r\nclk_disable_unprepare(i2s->clk_i2s);\r\n}\r\nstatic int jz4740_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t ctrl;\r\nuint32_t mask;\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nmask = JZ_AIC_CTRL_ENABLE_PLAYBACK | JZ_AIC_CTRL_ENABLE_TX_DMA;\r\nelse\r\nmask = JZ_AIC_CTRL_ENABLE_CAPTURE | JZ_AIC_CTRL_ENABLE_RX_DMA;\r\nctrl = jz4740_i2s_read(i2s, JZ_REG_AIC_CTRL);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nctrl |= mask;\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nctrl &= ~mask;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CTRL, ctrl);\r\nreturn 0;\r\n}\r\nstatic int jz4740_i2s_set_fmt(struct snd_soc_dai *dai, unsigned int fmt)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t format = 0;\r\nuint32_t conf;\r\nconf = jz4740_i2s_read(i2s, JZ_REG_AIC_CONF);\r\nconf &= ~(JZ_AIC_CONF_BIT_CLK_MASTER | JZ_AIC_CONF_SYNC_CLK_MASTER);\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\nconf |= JZ_AIC_CONF_BIT_CLK_MASTER | JZ_AIC_CONF_SYNC_CLK_MASTER;\r\nformat |= JZ_AIC_I2S_FMT_ENABLE_SYS_CLK;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFS:\r\nconf |= JZ_AIC_CONF_SYNC_CLK_MASTER;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBS_CFM:\r\nconf |= JZ_AIC_CONF_BIT_CLK_MASTER;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_MSB:\r\nformat |= JZ_AIC_I2S_FMT_MSB;\r\nbreak;\r\ncase SND_SOC_DAIFMT_I2S:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\r\ncase SND_SOC_DAIFMT_NB_NF:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CONF, conf);\r\njz4740_i2s_write(i2s, JZ_REG_AIC_I2S_FMT, format);\r\nreturn 0;\r\n}\r\nstatic int jz4740_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nunsigned int sample_size;\r\nuint32_t ctrl, div_reg;\r\nint div;\r\nctrl = jz4740_i2s_read(i2s, JZ_REG_AIC_CTRL);\r\ndiv_reg = jz4740_i2s_read(i2s, JZ_REG_AIC_CLK_DIV);\r\ndiv = clk_get_rate(i2s->clk_i2s) / (64 * params_rate(params));\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S8:\r\nsample_size = 0;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S16:\r\nsample_size = 1;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nctrl &= ~JZ_AIC_CTRL_OUTPUT_SAMPLE_SIZE_MASK;\r\nctrl |= sample_size << JZ_AIC_CTRL_OUTPUT_SAMPLE_SIZE_OFFSET;\r\nif (params_channels(params) == 1)\r\nctrl |= JZ_AIC_CTRL_MONO_TO_STEREO;\r\nelse\r\nctrl &= ~JZ_AIC_CTRL_MONO_TO_STEREO;\r\ndiv_reg &= ~I2SDIV_DV_MASK;\r\ndiv_reg |= (div - 1) << I2SDIV_DV_SHIFT;\r\n} else {\r\nctrl &= ~JZ_AIC_CTRL_INPUT_SAMPLE_SIZE_MASK;\r\nctrl |= sample_size << JZ_AIC_CTRL_INPUT_SAMPLE_SIZE_OFFSET;\r\nif (i2s->version >= JZ_I2S_JZ4780) {\r\ndiv_reg &= ~I2SDIV_IDV_MASK;\r\ndiv_reg |= (div - 1) << I2SDIV_IDV_SHIFT;\r\n} else {\r\ndiv_reg &= ~I2SDIV_DV_MASK;\r\ndiv_reg |= (div - 1) << I2SDIV_DV_SHIFT;\r\n}\r\n}\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CTRL, ctrl);\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CLK_DIV, div_reg);\r\nreturn 0;\r\n}\r\nstatic int jz4740_i2s_set_sysclk(struct snd_soc_dai *dai, int clk_id,\r\nunsigned int freq, int dir)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nstruct clk *parent;\r\nint ret = 0;\r\nswitch (clk_id) {\r\ncase JZ4740_I2S_CLKSRC_EXT:\r\nparent = clk_get(NULL, "ext");\r\nclk_set_parent(i2s->clk_i2s, parent);\r\nbreak;\r\ncase JZ4740_I2S_CLKSRC_PLL:\r\nparent = clk_get(NULL, "pll half");\r\nclk_set_parent(i2s->clk_i2s, parent);\r\nret = clk_set_rate(i2s->clk_i2s, freq);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nclk_put(parent);\r\nreturn ret;\r\n}\r\nstatic int jz4740_i2s_suspend(struct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t conf;\r\nif (dai->active) {\r\nconf = jz4740_i2s_read(i2s, JZ_REG_AIC_CONF);\r\nconf &= ~JZ_AIC_CONF_ENABLE;\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CONF, conf);\r\nclk_disable_unprepare(i2s->clk_i2s);\r\n}\r\nclk_disable_unprepare(i2s->clk_aic);\r\nreturn 0;\r\n}\r\nstatic int jz4740_i2s_resume(struct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t conf;\r\nclk_prepare_enable(i2s->clk_aic);\r\nif (dai->active) {\r\nclk_prepare_enable(i2s->clk_i2s);\r\nconf = jz4740_i2s_read(i2s, JZ_REG_AIC_CONF);\r\nconf |= JZ_AIC_CONF_ENABLE;\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CONF, conf);\r\n}\r\nreturn 0;\r\n}\r\nstatic void jz4740_i2c_init_pcm_config(struct jz4740_i2s *i2s)\r\n{\r\nstruct snd_dmaengine_dai_dma_data *dma_data;\r\ndma_data = &i2s->playback_dma_data;\r\ndma_data->maxburst = 16;\r\ndma_data->slave_id = JZ4740_DMA_TYPE_AIC_TRANSMIT;\r\ndma_data->addr = i2s->phys_base + JZ_REG_AIC_FIFO;\r\ndma_data = &i2s->capture_dma_data;\r\ndma_data->maxburst = 16;\r\ndma_data->slave_id = JZ4740_DMA_TYPE_AIC_RECEIVE;\r\ndma_data->addr = i2s->phys_base + JZ_REG_AIC_FIFO;\r\n}\r\nstatic int jz4740_i2s_dai_probe(struct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t conf;\r\nclk_prepare_enable(i2s->clk_aic);\r\njz4740_i2c_init_pcm_config(i2s);\r\nsnd_soc_dai_init_dma_data(dai, &i2s->playback_dma_data,\r\n&i2s->capture_dma_data);\r\nif (i2s->version >= JZ_I2S_JZ4780) {\r\nconf = (7 << JZ4780_AIC_CONF_FIFO_RX_THRESHOLD_OFFSET) |\r\n(8 << JZ4780_AIC_CONF_FIFO_TX_THRESHOLD_OFFSET) |\r\nJZ_AIC_CONF_OVERFLOW_PLAY_LAST |\r\nJZ_AIC_CONF_I2S |\r\nJZ_AIC_CONF_INTERNAL_CODEC;\r\n} else {\r\nconf = (7 << JZ_AIC_CONF_FIFO_RX_THRESHOLD_OFFSET) |\r\n(8 << JZ_AIC_CONF_FIFO_TX_THRESHOLD_OFFSET) |\r\nJZ_AIC_CONF_OVERFLOW_PLAY_LAST |\r\nJZ_AIC_CONF_I2S |\r\nJZ_AIC_CONF_INTERNAL_CODEC;\r\n}\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CONF, JZ_AIC_CONF_RESET);\r\njz4740_i2s_write(i2s, JZ_REG_AIC_CONF, conf);\r\nreturn 0;\r\n}\r\nstatic int jz4740_i2s_dai_remove(struct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nclk_disable_unprepare(i2s->clk_aic);\r\nreturn 0;\r\n}\r\nstatic int jz4740_i2s_dev_probe(struct platform_device *pdev)\r\n{\r\nstruct jz4740_i2s *i2s;\r\nstruct resource *mem;\r\nint ret;\r\nconst struct of_device_id *match;\r\ni2s = devm_kzalloc(&pdev->dev, sizeof(*i2s), GFP_KERNEL);\r\nif (!i2s)\r\nreturn -ENOMEM;\r\nmatch = of_match_device(jz4740_of_matches, &pdev->dev);\r\nif (match)\r\ni2s->version = (enum jz47xx_i2s_version)match->data;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ni2s->base = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(i2s->base))\r\nreturn PTR_ERR(i2s->base);\r\ni2s->phys_base = mem->start;\r\ni2s->clk_aic = devm_clk_get(&pdev->dev, "aic");\r\nif (IS_ERR(i2s->clk_aic))\r\nreturn PTR_ERR(i2s->clk_aic);\r\ni2s->clk_i2s = devm_clk_get(&pdev->dev, "i2s");\r\nif (IS_ERR(i2s->clk_i2s))\r\nreturn PTR_ERR(i2s->clk_i2s);\r\nplatform_set_drvdata(pdev, i2s);\r\nif (i2s->version == JZ_I2S_JZ4780)\r\nret = devm_snd_soc_register_component(&pdev->dev,\r\n&jz4740_i2s_component, &jz4780_i2s_dai, 1);\r\nelse\r\nret = devm_snd_soc_register_component(&pdev->dev,\r\n&jz4740_i2s_component, &jz4740_i2s_dai, 1);\r\nif (ret)\r\nreturn ret;\r\nreturn devm_snd_dmaengine_pcm_register(&pdev->dev, NULL,\r\nSND_DMAENGINE_PCM_FLAG_COMPAT);\r\n}

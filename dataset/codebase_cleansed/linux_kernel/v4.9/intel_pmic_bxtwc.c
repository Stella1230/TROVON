static int intel_bxtwc_pmic_get_power(struct regmap *regmap, int reg,\r\nint bit, u64 *value)\r\n{\r\nint data;\r\nif (regmap_read(regmap, reg, &data))\r\nreturn -EIO;\r\n*value = (data & bit) ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic int intel_bxtwc_pmic_update_power(struct regmap *regmap, int reg,\r\nint bit, bool on)\r\n{\r\nu8 val, mask = bit;\r\nif (on)\r\nval = 0xFF;\r\nelse\r\nval = 0x0;\r\nreturn regmap_update_bits(regmap, reg, mask, val);\r\n}\r\nstatic int intel_bxtwc_pmic_get_raw_temp(struct regmap *regmap, int reg)\r\n{\r\nunsigned int val, adc_val, reg_val;\r\nu8 temp_l, temp_h, cursrc;\r\nunsigned long rlsb;\r\nstatic const unsigned long rlsb_array[] = {\r\n0, 260420, 130210, 65100, 32550, 16280,\r\n8140, 4070, 2030, 0, 260420, 130210 };\r\nif (regmap_read(regmap, reg, &val))\r\nreturn -EIO;\r\ntemp_l = (u8) val;\r\nif (regmap_read(regmap, (reg - 1), &val))\r\nreturn -EIO;\r\ntemp_h = (u8) val;\r\nreg_val = temp_l | WHISKEY_COVE_ADC_HIGH_BIT(temp_h);\r\ncursrc = WHISKEY_COVE_ADC_CURSRC(temp_h);\r\nrlsb = rlsb_array[cursrc];\r\nadc_val = reg_val * rlsb / 1000;\r\nreturn adc_val;\r\n}\r\nstatic int\r\nintel_bxtwc_pmic_update_aux(struct regmap *regmap, int reg, int raw)\r\n{\r\nu32 bsr_num;\r\nu16 resi_val, count = 0, thrsh = 0;\r\nu8 alrt_h, alrt_l, cursel = 0;\r\nbsr_num = raw;\r\nbsr_num /= (1 << 5);\r\ncount = fls(bsr_num) - 1;\r\ncursel = clamp_t(s8, (count - 7), 0, 7);\r\nthrsh = raw / (1 << (4 + cursel));\r\nresi_val = (cursel << 9) | thrsh;\r\nalrt_h = (resi_val >> 8) & WHISKEY_COVE_ALRT_HIGH_BIT_MASK;\r\nif (regmap_update_bits(regmap,\r\nreg - 1,\r\nWHISKEY_COVE_ALRT_HIGH_BIT_MASK,\r\nalrt_h))\r\nreturn -EIO;\r\nalrt_l = (u8)resi_val;\r\nreturn regmap_write(regmap, reg, alrt_l);\r\n}\r\nstatic int\r\nintel_bxtwc_pmic_get_policy(struct regmap *regmap, int reg, int bit, u64 *value)\r\n{\r\nu8 mask = BIT(bit);\r\nunsigned int val;\r\nif (regmap_read(regmap, reg, &val))\r\nreturn -EIO;\r\n*value = (val & mask) >> bit;\r\nreturn 0;\r\n}\r\nstatic int\r\nintel_bxtwc_pmic_update_policy(struct regmap *regmap,\r\nint reg, int bit, int enable)\r\n{\r\nu8 mask = BIT(bit), val = enable << bit;\r\nreturn regmap_update_bits(regmap, reg, mask, val);\r\n}\r\nstatic int intel_bxtwc_pmic_opregion_probe(struct platform_device *pdev)\r\n{\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(pdev->dev.parent);\r\nreturn intel_pmic_install_opregion_handler(&pdev->dev,\r\nACPI_HANDLE(pdev->dev.parent),\r\npmic->regmap,\r\n&intel_bxtwc_pmic_opregion_data);\r\n}\r\nstatic int __init intel_bxtwc_pmic_opregion_driver_init(void)\r\n{\r\nreturn platform_driver_register(&intel_bxtwc_pmic_opregion_driver);\r\n}

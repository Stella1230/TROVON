static bool _rtl92e_wait_for_fw(struct net_device *dev, u32 mask, u32 timeout)\r\n{\r\nunsigned long deadline = jiffies + msecs_to_jiffies(timeout);\r\nwhile (time_before(jiffies, deadline)) {\r\nif (rtl92e_readl(dev, CPU_GEN) & mask)\r\nreturn true;\r\nmdelay(2);\r\n}\r\nreturn false;\r\n}\r\nstatic bool _rtl92e_fw_boot_cpu(struct net_device *dev)\r\n{\r\nu32 CPU_status = 0;\r\nif (!_rtl92e_wait_for_fw(dev, CPU_GEN_PUT_CODE_OK, 200)) {\r\nnetdev_err(dev, "Firmware download failed.\n");\r\nreturn false;\r\n}\r\nnetdev_dbg(dev, "Download Firmware: Put code ok!\n");\r\nCPU_status = rtl92e_readl(dev, CPU_GEN);\r\nrtl92e_writeb(dev, CPU_GEN,\r\n(u8)((CPU_status|CPU_GEN_PWR_STB_CPU)&0xff));\r\nmdelay(1);\r\nif (!_rtl92e_wait_for_fw(dev, CPU_GEN_BOOT_RDY, 200)) {\r\nnetdev_err(dev, "Firmware boot failed.\n");\r\nreturn false;\r\n}\r\nnetdev_dbg(dev, "Download Firmware: Boot ready!\n");\r\nreturn true;\r\n}\r\nstatic bool _rtl92e_fw_check_ready(struct net_device *dev,\r\nu8 load_fw_status)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nstruct rt_firmware *pfirmware = priv->pFirmware;\r\nbool rt_status = true;\r\nswitch (load_fw_status) {\r\ncase FW_INIT_STEP0_BOOT:\r\npfirmware->status = FW_STATUS_1_MOVE_BOOT_CODE;\r\nbreak;\r\ncase FW_INIT_STEP1_MAIN:\r\npfirmware->status = FW_STATUS_2_MOVE_MAIN_CODE;\r\nrt_status = _rtl92e_fw_boot_cpu(dev);\r\nif (rt_status)\r\npfirmware->status = FW_STATUS_3_TURNON_CPU;\r\nelse\r\nnetdev_dbg(dev, "_rtl92e_fw_boot_cpu fail!\n");\r\nbreak;\r\ncase FW_INIT_STEP2_DATA:\r\npfirmware->status = FW_STATUS_4_MOVE_DATA_CODE;\r\nmdelay(1);\r\nrt_status = _rtl92e_wait_for_fw(dev, CPU_GEN_FIRM_RDY, 20);\r\nif (rt_status)\r\npfirmware->status = FW_STATUS_5_READY;\r\nelse\r\nRT_TRACE(COMP_FIRMWARE,\r\n"_rtl92e_is_fw_ready fail(%d)!\n",\r\nrt_status);\r\nbreak;\r\ndefault:\r\nrt_status = false;\r\nnetdev_dbg(dev, "Unknown firmware status");\r\nbreak;\r\n}\r\nreturn rt_status;\r\n}\r\nstatic bool _rtl92e_fw_prepare(struct net_device *dev, struct rt_fw_blob *blob,\r\nconst char *name, u8 padding)\r\n{\r\nconst struct firmware *fw;\r\nint rc, i;\r\nbool ret = true;\r\nrc = request_firmware(&fw, name, &dev->dev);\r\nif (rc < 0)\r\nreturn false;\r\nif (round_up(fw->size, 4) > MAX_FW_SIZE - padding) {\r\nnetdev_err(dev, "Firmware image %s too big for the device.\n",\r\nname);\r\nret = false;\r\ngoto out;\r\n}\r\nif (padding)\r\nmemset(blob->data, 0, padding);\r\nif (fw->size % 4)\r\nmemset(blob->data + padding + fw->size, 0, 4);\r\nmemcpy(blob->data + padding, fw->data, fw->size);\r\nblob->size = round_up(fw->size, 4) + padding;\r\nfor (i = padding; i < blob->size; i += 4) {\r\nu32 *data = (u32 *)(blob->data + i);\r\n*data = swab32p(data);\r\n}\r\nout:\r\nrelease_firmware(fw);\r\nreturn ret;\r\n}\r\nbool rtl92e_init_fw(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nbool rt_status = true;\r\nu32 file_length = 0;\r\nu8 *mapped_file = NULL;\r\nu8 i = 0;\r\nenum opt_rst_type rst_opt = OPT_SYSTEM_RESET;\r\nenum firmware_init_step starting_state = FW_INIT_STEP0_BOOT;\r\nstruct rt_firmware *pfirmware = priv->pFirmware;\r\nnetdev_dbg(dev, " PlatformInitFirmware()==>\n");\r\nif (pfirmware->status == FW_STATUS_0_INIT) {\r\nrst_opt = OPT_SYSTEM_RESET;\r\nstarting_state = FW_INIT_STEP0_BOOT;\r\n} else if (pfirmware->status == FW_STATUS_5_READY) {\r\nrst_opt = OPT_FIRMWARE_RESET;\r\nstarting_state = FW_INIT_STEP2_DATA;\r\n} else {\r\nRT_TRACE(COMP_FIRMWARE,\r\n"PlatformInitFirmware: undefined firmware state\n");\r\n}\r\nfor (i = starting_state; i <= FW_INIT_STEP2_DATA; i++) {\r\nif (rst_opt == OPT_SYSTEM_RESET) {\r\nif (pfirmware->blobs[i].size == 0) {\r\nconst char *fw_name[3] = {\r\nRTL8192E_BOOT_IMG_FW,\r\nRTL8192E_MAIN_IMG_FW,\r\nRTL8192E_DATA_IMG_FW\r\n};\r\nint pad = 0;\r\nif (i == FW_INIT_STEP1_MAIN)\r\npad = 128;\r\nif (!_rtl92e_fw_prepare(dev,\r\n&pfirmware->blobs[i],\r\nfw_name[i],\r\npad))\r\ngoto download_firmware_fail;\r\n}\r\n}\r\nmapped_file = pfirmware->blobs[i].data;\r\nfile_length = pfirmware->blobs[i].size;\r\nrt_status = rtl92e_send_cmd_pkt(dev, DESC_PACKET_TYPE_INIT,\r\nmapped_file, file_length);\r\nif (!rt_status)\r\ngoto download_firmware_fail;\r\nif (!_rtl92e_fw_check_ready(dev, i))\r\ngoto download_firmware_fail;\r\n}\r\nnetdev_dbg(dev, "Firmware Download Success\n");\r\nreturn rt_status;\r\ndownload_firmware_fail:\r\nnetdev_err(dev, "%s: Failed to initialize firmware.\n", __func__);\r\nrt_status = false;\r\nreturn rt_status;\r\n}

static inline void __iomem *\r\nqla27xx_isp_reg(struct scsi_qla_host *vha)\r\n{\r\nreturn &vha->hw->iobase->isp24;\r\n}\r\nstatic inline void\r\nqla27xx_insert16(uint16_t value, void *buf, ulong *len)\r\n{\r\nif (buf) {\r\nbuf += *len;\r\n*(__le16 *)buf = cpu_to_le16(value);\r\n}\r\n*len += sizeof(value);\r\n}\r\nstatic inline void\r\nqla27xx_insert32(uint32_t value, void *buf, ulong *len)\r\n{\r\nif (buf) {\r\nbuf += *len;\r\n*(__le32 *)buf = cpu_to_le32(value);\r\n}\r\n*len += sizeof(value);\r\n}\r\nstatic inline void\r\nqla27xx_insertbuf(void *mem, ulong size, void *buf, ulong *len)\r\n{\r\nif (buf && mem && size) {\r\nbuf += *len;\r\nmemcpy(buf, mem, size);\r\n}\r\n*len += size;\r\n}\r\nstatic inline void\r\nqla27xx_read8(void __iomem *window, void *buf, ulong *len)\r\n{\r\nuint8_t value = ~0;\r\nif (buf) {\r\nvalue = RD_REG_BYTE(window);\r\n}\r\nqla27xx_insert32(value, buf, len);\r\n}\r\nstatic inline void\r\nqla27xx_read16(void __iomem *window, void *buf, ulong *len)\r\n{\r\nuint16_t value = ~0;\r\nif (buf) {\r\nvalue = RD_REG_WORD(window);\r\n}\r\nqla27xx_insert32(value, buf, len);\r\n}\r\nstatic inline void\r\nqla27xx_read32(void __iomem *window, void *buf, ulong *len)\r\n{\r\nuint32_t value = ~0;\r\nif (buf) {\r\nvalue = RD_REG_DWORD(window);\r\n}\r\nqla27xx_insert32(value, buf, len);\r\n}\r\nstatic inline void\r\nqla27xx_read_reg(__iomem struct device_reg_24xx *reg,\r\nuint offset, void *buf, ulong *len)\r\n{\r\nvoid __iomem *window = (void __iomem *)reg + offset;\r\nqla27xx_read32(window, buf, len);\r\n}\r\nstatic inline void\r\nqla27xx_write_reg(__iomem struct device_reg_24xx *reg,\r\nuint offset, uint32_t data, void *buf)\r\n{\r\n__iomem void *window = (void __iomem *)reg + offset;\r\nif (buf) {\r\nWRT_REG_DWORD(window, data);\r\n}\r\n}\r\nstatic inline void\r\nqla27xx_read_window(__iomem struct device_reg_24xx *reg,\r\nuint32_t addr, uint offset, uint count, uint width, void *buf,\r\nulong *len)\r\n{\r\nvoid __iomem *window = (void __iomem *)reg + offset;\r\nvoid (*readn)(void __iomem*, void *, ulong *) = qla27xx_read_vector(width);\r\nqla27xx_write_reg(reg, IOBASE_ADDR, addr, buf);\r\nwhile (count--) {\r\nqla27xx_insert32(addr, buf, len);\r\nreadn(window, buf, len);\r\nwindow += width;\r\naddr++;\r\n}\r\n}\r\nstatic inline void\r\nqla27xx_skip_entry(struct qla27xx_fwdt_entry *ent, void *buf)\r\n{\r\nif (buf)\r\nent->hdr.driver_flags |= DRIVER_FLAG_SKIP_ENTRY;\r\nql_dbg(ql_dbg_misc + ql_dbg_verbose, NULL, 0xd011,\r\n"Skipping entry %d\n", ent->hdr.entry_type);\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t0(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nql_dbg(ql_dbg_misc, vha, 0xd100,\r\n"%s: nop [%lx]\n", __func__, *len);\r\nqla27xx_skip_entry(ent, buf);\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t255(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nql_dbg(ql_dbg_misc, vha, 0xd1ff,\r\n"%s: end [%lx]\n", __func__, *len);\r\nqla27xx_skip_entry(ent, buf);\r\nreturn true;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t256(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nstruct device_reg_24xx __iomem *reg = qla27xx_isp_reg(vha);\r\nql_dbg(ql_dbg_misc, vha, 0xd200,\r\n"%s: rdio t1 [%lx]\n", __func__, *len);\r\nqla27xx_read_window(reg, ent->t256.base_addr, ent->t256.pci_offset,\r\nent->t256.reg_count, ent->t256.reg_width, buf, len);\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t257(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nstruct device_reg_24xx __iomem *reg = qla27xx_isp_reg(vha);\r\nql_dbg(ql_dbg_misc, vha, 0xd201,\r\n"%s: wrio t1 [%lx]\n", __func__, *len);\r\nqla27xx_write_reg(reg, IOBASE_ADDR, ent->t257.base_addr, buf);\r\nqla27xx_write_reg(reg, ent->t257.pci_offset, ent->t257.write_data, buf);\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t258(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nstruct device_reg_24xx __iomem *reg = qla27xx_isp_reg(vha);\r\nql_dbg(ql_dbg_misc, vha, 0xd202,\r\n"%s: rdio t2 [%lx]\n", __func__, *len);\r\nqla27xx_write_reg(reg, ent->t258.banksel_offset, ent->t258.bank, buf);\r\nqla27xx_read_window(reg, ent->t258.base_addr, ent->t258.pci_offset,\r\nent->t258.reg_count, ent->t258.reg_width, buf, len);\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t259(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nstruct device_reg_24xx __iomem *reg = qla27xx_isp_reg(vha);\r\nql_dbg(ql_dbg_misc, vha, 0xd203,\r\n"%s: wrio t2 [%lx]\n", __func__, *len);\r\nqla27xx_write_reg(reg, IOBASE_ADDR, ent->t259.base_addr, buf);\r\nqla27xx_write_reg(reg, ent->t259.banksel_offset, ent->t259.bank, buf);\r\nqla27xx_write_reg(reg, ent->t259.pci_offset, ent->t259.write_data, buf);\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t260(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nstruct device_reg_24xx __iomem *reg = qla27xx_isp_reg(vha);\r\nql_dbg(ql_dbg_misc, vha, 0xd204,\r\n"%s: rdpci [%lx]\n", __func__, *len);\r\nqla27xx_insert32(ent->t260.pci_offset, buf, len);\r\nqla27xx_read_reg(reg, ent->t260.pci_offset, buf, len);\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t261(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nstruct device_reg_24xx __iomem *reg = qla27xx_isp_reg(vha);\r\nql_dbg(ql_dbg_misc, vha, 0xd205,\r\n"%s: wrpci [%lx]\n", __func__, *len);\r\nqla27xx_write_reg(reg, ent->t261.pci_offset, ent->t261.write_data, buf);\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t262(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nulong dwords;\r\nulong start;\r\nulong end;\r\nql_dbg(ql_dbg_misc, vha, 0xd206,\r\n"%s: rdram(%x) [%lx]\n", __func__, ent->t262.ram_area, *len);\r\nstart = ent->t262.start_addr;\r\nend = ent->t262.end_addr;\r\nif (ent->t262.ram_area == T262_RAM_AREA_CRITICAL_RAM) {\r\n;\r\n} else if (ent->t262.ram_area == T262_RAM_AREA_EXTERNAL_RAM) {\r\nend = vha->hw->fw_memory_size;\r\nif (buf)\r\nent->t262.end_addr = end;\r\n} else if (ent->t262.ram_area == T262_RAM_AREA_SHARED_RAM) {\r\nstart = vha->hw->fw_shared_ram_start;\r\nend = vha->hw->fw_shared_ram_end;\r\nif (buf) {\r\nent->t262.start_addr = start;\r\nent->t262.end_addr = end;\r\n}\r\n} else if (ent->t262.ram_area == T262_RAM_AREA_DDR_RAM) {\r\nstart = vha->hw->fw_ddr_ram_start;\r\nend = vha->hw->fw_ddr_ram_end;\r\nif (buf) {\r\nent->t262.start_addr = start;\r\nent->t262.end_addr = end;\r\n}\r\n} else {\r\nql_dbg(ql_dbg_misc, vha, 0xd022,\r\n"%s: unknown area %x\n", __func__, ent->t262.ram_area);\r\nqla27xx_skip_entry(ent, buf);\r\ngoto done;\r\n}\r\nif (end <= start || start == 0 || end == 0) {\r\nql_dbg(ql_dbg_misc, vha, 0xd023,\r\n"%s: unusable range (start=%x end=%x)\n", __func__,\r\nent->t262.end_addr, ent->t262.start_addr);\r\nqla27xx_skip_entry(ent, buf);\r\ngoto done;\r\n}\r\ndwords = end - start + 1;\r\nif (buf) {\r\nbuf += *len;\r\nqla24xx_dump_ram(vha->hw, start, buf, dwords, &buf);\r\n}\r\n*len += dwords * sizeof(uint32_t);\r\ndone:\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t263(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nuint count = 0;\r\nuint i;\r\nuint length;\r\nql_dbg(ql_dbg_misc, vha, 0xd207,\r\n"%s: getq(%x) [%lx]\n", __func__, ent->t263.queue_type, *len);\r\nif (ent->t263.queue_type == T263_QUEUE_TYPE_REQ) {\r\nfor (i = 0; i < vha->hw->max_req_queues; i++) {\r\nstruct req_que *req = vha->hw->req_q_map[i];\r\nif (!test_bit(i, vha->hw->req_qid_map))\r\ncontinue;\r\nif (req || !buf) {\r\nlength = req ?\r\nreq->length : REQUEST_ENTRY_CNT_24XX;\r\nqla27xx_insert16(i, buf, len);\r\nqla27xx_insert16(length, buf, len);\r\nqla27xx_insertbuf(req ? req->ring : NULL,\r\nlength * sizeof(*req->ring), buf, len);\r\ncount++;\r\n}\r\n}\r\n} else if (ent->t263.queue_type == T263_QUEUE_TYPE_RSP) {\r\nfor (i = 0; i < vha->hw->max_rsp_queues; i++) {\r\nstruct rsp_que *rsp = vha->hw->rsp_q_map[i];\r\nif (!test_bit(i, vha->hw->rsp_qid_map))\r\ncontinue;\r\nif (rsp || !buf) {\r\nlength = rsp ?\r\nrsp->length : RESPONSE_ENTRY_CNT_MQ;\r\nqla27xx_insert16(i, buf, len);\r\nqla27xx_insert16(length, buf, len);\r\nqla27xx_insertbuf(rsp ? rsp->ring : NULL,\r\nlength * sizeof(*rsp->ring), buf, len);\r\ncount++;\r\n}\r\n}\r\n} else {\r\nql_dbg(ql_dbg_misc, vha, 0xd026,\r\n"%s: unknown queue %x\n", __func__, ent->t263.queue_type);\r\nqla27xx_skip_entry(ent, buf);\r\n}\r\nif (buf)\r\nent->t263.num_queues = count;\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t264(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nql_dbg(ql_dbg_misc, vha, 0xd208,\r\n"%s: getfce [%lx]\n", __func__, *len);\r\nif (vha->hw->fce) {\r\nif (buf) {\r\nent->t264.fce_trace_size = FCE_SIZE;\r\nent->t264.write_pointer = vha->hw->fce_wr;\r\nent->t264.base_pointer = vha->hw->fce_dma;\r\nent->t264.fce_enable_mb0 = vha->hw->fce_mb[0];\r\nent->t264.fce_enable_mb2 = vha->hw->fce_mb[2];\r\nent->t264.fce_enable_mb3 = vha->hw->fce_mb[3];\r\nent->t264.fce_enable_mb4 = vha->hw->fce_mb[4];\r\nent->t264.fce_enable_mb5 = vha->hw->fce_mb[5];\r\nent->t264.fce_enable_mb6 = vha->hw->fce_mb[6];\r\n}\r\nqla27xx_insertbuf(vha->hw->fce, FCE_SIZE, buf, len);\r\n} else {\r\nql_dbg(ql_dbg_misc, vha, 0xd027,\r\n"%s: missing fce\n", __func__);\r\nqla27xx_skip_entry(ent, buf);\r\n}\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t265(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nstruct device_reg_24xx __iomem *reg = qla27xx_isp_reg(vha);\r\nql_dbg(ql_dbg_misc, vha, 0xd209,\r\n"%s: pause risc [%lx]\n", __func__, *len);\r\nif (buf)\r\nqla24xx_pause_risc(reg, vha->hw);\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t266(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nql_dbg(ql_dbg_misc, vha, 0xd20a,\r\n"%s: reset risc [%lx]\n", __func__, *len);\r\nif (buf)\r\nqla24xx_soft_reset(vha->hw);\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t267(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nstruct device_reg_24xx __iomem *reg = qla27xx_isp_reg(vha);\r\nql_dbg(ql_dbg_misc, vha, 0xd20b,\r\n"%s: dis intr [%lx]\n", __func__, *len);\r\nqla27xx_write_reg(reg, ent->t267.pci_offset, ent->t267.data, buf);\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t268(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nql_dbg(ql_dbg_misc, vha, 0xd20c,\r\n"%s: gethb(%x) [%lx]\n", __func__, ent->t268.buf_type, *len);\r\nif (ent->t268.buf_type == T268_BUF_TYPE_EXTD_TRACE) {\r\nif (vha->hw->eft) {\r\nif (buf) {\r\nent->t268.buf_size = EFT_SIZE;\r\nent->t268.start_addr = vha->hw->eft_dma;\r\n}\r\nqla27xx_insertbuf(vha->hw->eft, EFT_SIZE, buf, len);\r\n} else {\r\nql_dbg(ql_dbg_misc, vha, 0xd028,\r\n"%s: missing eft\n", __func__);\r\nqla27xx_skip_entry(ent, buf);\r\n}\r\n} else {\r\nql_dbg(ql_dbg_misc, vha, 0xd02b,\r\n"%s: unknown buffer %x\n", __func__, ent->t268.buf_type);\r\nqla27xx_skip_entry(ent, buf);\r\n}\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t269(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nql_dbg(ql_dbg_misc, vha, 0xd20d,\r\n"%s: scratch [%lx]\n", __func__, *len);\r\nqla27xx_insert32(0xaaaaaaaa, buf, len);\r\nqla27xx_insert32(0xbbbbbbbb, buf, len);\r\nqla27xx_insert32(0xcccccccc, buf, len);\r\nqla27xx_insert32(0xdddddddd, buf, len);\r\nqla27xx_insert32(*len + sizeof(uint32_t), buf, len);\r\nif (buf)\r\nent->t269.scratch_size = 5 * sizeof(uint32_t);\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t270(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nstruct device_reg_24xx __iomem *reg = qla27xx_isp_reg(vha);\r\nulong dwords = ent->t270.count;\r\nulong addr = ent->t270.addr;\r\nql_dbg(ql_dbg_misc, vha, 0xd20e,\r\n"%s: rdremreg [%lx]\n", __func__, *len);\r\nqla27xx_write_reg(reg, IOBASE_ADDR, 0x40, buf);\r\nwhile (dwords--) {\r\nqla27xx_write_reg(reg, 0xc0, addr|0x80000000, buf);\r\nqla27xx_insert32(addr, buf, len);\r\nqla27xx_read_reg(reg, 0xc4, buf, len);\r\naddr += sizeof(uint32_t);\r\n}\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t271(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nstruct device_reg_24xx __iomem *reg = qla27xx_isp_reg(vha);\r\nulong addr = ent->t271.addr;\r\nulong data = ent->t271.data;\r\nql_dbg(ql_dbg_misc, vha, 0xd20f,\r\n"%s: wrremreg [%lx]\n", __func__, *len);\r\nqla27xx_write_reg(reg, IOBASE_ADDR, 0x40, buf);\r\nqla27xx_write_reg(reg, 0xc4, data, buf);\r\nqla27xx_write_reg(reg, 0xc0, addr, buf);\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t272(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nulong dwords = ent->t272.count;\r\nulong start = ent->t272.addr;\r\nql_dbg(ql_dbg_misc, vha, 0xd210,\r\n"%s: rdremram [%lx]\n", __func__, *len);\r\nif (buf) {\r\nql_dbg(ql_dbg_misc, vha, 0xd02c,\r\n"%s: @%lx -> (%lx dwords)\n", __func__, start, dwords);\r\nbuf += *len;\r\nqla27xx_dump_mpi_ram(vha->hw, start, buf, dwords, &buf);\r\n}\r\n*len += dwords * sizeof(uint32_t);\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t273(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nulong dwords = ent->t273.count;\r\nulong addr = ent->t273.addr;\r\nuint32_t value;\r\nql_dbg(ql_dbg_misc, vha, 0xd211,\r\n"%s: pcicfg [%lx]\n", __func__, *len);\r\nwhile (dwords--) {\r\nvalue = ~0;\r\nif (pci_read_config_dword(vha->hw->pdev, addr, &value))\r\nql_dbg(ql_dbg_misc, vha, 0xd02d,\r\n"%s: failed pcicfg read at %lx\n", __func__, addr);\r\nqla27xx_insert32(addr, buf, len);\r\nqla27xx_insert32(value, buf, len);\r\naddr += sizeof(uint32_t);\r\n}\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t274(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nuint count = 0;\r\nuint i;\r\nql_dbg(ql_dbg_misc, vha, 0xd212,\r\n"%s: getqsh(%x) [%lx]\n", __func__, ent->t274.queue_type, *len);\r\nif (ent->t274.queue_type == T274_QUEUE_TYPE_REQ_SHAD) {\r\nfor (i = 0; i < vha->hw->max_req_queues; i++) {\r\nstruct req_que *req = vha->hw->req_q_map[i];\r\nif (!test_bit(i, vha->hw->req_qid_map))\r\ncontinue;\r\nif (req || !buf) {\r\nqla27xx_insert16(i, buf, len);\r\nqla27xx_insert16(1, buf, len);\r\nqla27xx_insert32(req && req->out_ptr ?\r\n*req->out_ptr : 0, buf, len);\r\ncount++;\r\n}\r\n}\r\n} else if (ent->t274.queue_type == T274_QUEUE_TYPE_RSP_SHAD) {\r\nfor (i = 0; i < vha->hw->max_rsp_queues; i++) {\r\nstruct rsp_que *rsp = vha->hw->rsp_q_map[i];\r\nif (!test_bit(i, vha->hw->rsp_qid_map))\r\ncontinue;\r\nif (rsp || !buf) {\r\nqla27xx_insert16(i, buf, len);\r\nqla27xx_insert16(1, buf, len);\r\nqla27xx_insert32(rsp && rsp->in_ptr ?\r\n*rsp->in_ptr : 0, buf, len);\r\ncount++;\r\n}\r\n}\r\n} else {\r\nql_dbg(ql_dbg_misc, vha, 0xd02f,\r\n"%s: unknown queue %x\n", __func__, ent->t274.queue_type);\r\nqla27xx_skip_entry(ent, buf);\r\n}\r\nif (buf)\r\nent->t274.num_queues = count;\r\nif (!count)\r\nqla27xx_skip_entry(ent, buf);\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_t275(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nulong offset = offsetof(typeof(*ent), t275.buffer);\r\nql_dbg(ql_dbg_misc, vha, 0xd213,\r\n"%s: buffer(%x) [%lx]\n", __func__, ent->t275.length, *len);\r\nif (!ent->t275.length) {\r\nql_dbg(ql_dbg_misc, vha, 0xd020,\r\n"%s: buffer zero length\n", __func__);\r\nqla27xx_skip_entry(ent, buf);\r\ngoto done;\r\n}\r\nif (offset + ent->t275.length > ent->hdr.entry_size) {\r\nql_dbg(ql_dbg_misc, vha, 0xd030,\r\n"%s: buffer overflow\n", __func__);\r\nqla27xx_skip_entry(ent, buf);\r\ngoto done;\r\n}\r\nqla27xx_insertbuf(ent->t275.buffer, ent->t275.length, buf, len);\r\ndone:\r\nreturn false;\r\n}\r\nstatic int\r\nqla27xx_fwdt_entry_other(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_entry *ent, void *buf, ulong *len)\r\n{\r\nql_dbg(ql_dbg_misc, vha, 0xd2ff,\r\n"%s: type %x [%lx]\n", __func__, ent->hdr.entry_type, *len);\r\nqla27xx_skip_entry(ent, buf);\r\nreturn false;\r\n}\r\ninline void *\r\nqla27xx_next_entry(void *p)\r\n{\r\nstruct qla27xx_fwdt_entry *ent = p;\r\nreturn p + ent->hdr.entry_size;\r\n}\r\nstatic void\r\nqla27xx_walk_template(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_template *tmp, void *buf, ulong *len)\r\n{\r\nstruct qla27xx_fwdt_entry *ent = (void *)tmp + tmp->entry_offset;\r\nulong count = tmp->entry_count;\r\nql_dbg(ql_dbg_misc, vha, 0xd01a,\r\n"%s: entry count %lx\n", __func__, count);\r\nwhile (count--) {\r\nif (qla27xx_find_entry(ent->hdr.entry_type)(vha, ent, buf, len))\r\nbreak;\r\nent = qla27xx_next_entry(ent);\r\n}\r\nif (count)\r\nql_dbg(ql_dbg_misc, vha, 0xd018,\r\n"%s: residual count (%lx)\n", __func__, count);\r\nif (ent->hdr.entry_type != ENTRY_TYPE_TMP_END)\r\nql_dbg(ql_dbg_misc, vha, 0xd019,\r\n"%s: missing end (%lx)\n", __func__, count);\r\nql_dbg(ql_dbg_misc, vha, 0xd01b,\r\n"%s: len=%lx\n", __func__, *len);\r\nif (buf) {\r\nql_log(ql_log_warn, vha, 0xd015,\r\n"Firmware dump saved to temp buffer (%ld/%p)\n",\r\nvha->host_no, vha->hw->fw_dump);\r\nqla2x00_post_uevent_work(vha, QLA_UEVENT_CODE_FW_DUMP);\r\n}\r\n}\r\nstatic void\r\nqla27xx_time_stamp(struct qla27xx_fwdt_template *tmp)\r\n{\r\ntmp->capture_timestamp = jiffies;\r\n}\r\nstatic void\r\nqla27xx_driver_info(struct qla27xx_fwdt_template *tmp)\r\n{\r\nuint8_t v[] = { 0, 0, 0, 0, 0, 0 };\r\nsscanf(qla2x00_version_str, "%hhu.%hhu.%hhu.%hhu.%hhu.%hhu",\r\nv+0, v+1, v+2, v+3, v+4, v+5);\r\ntmp->driver_info[0] = v[3] << 24 | v[2] << 16 | v[1] << 8 | v[0];\r\ntmp->driver_info[1] = v[5] << 8 | v[4];\r\ntmp->driver_info[2] = 0x12345678;\r\n}\r\nstatic void\r\nqla27xx_firmware_info(struct qla27xx_fwdt_template *tmp,\r\nstruct scsi_qla_host *vha)\r\n{\r\ntmp->firmware_version[0] = vha->hw->fw_major_version;\r\ntmp->firmware_version[1] = vha->hw->fw_minor_version;\r\ntmp->firmware_version[2] = vha->hw->fw_subminor_version;\r\ntmp->firmware_version[3] =\r\nvha->hw->fw_attributes_h << 16 | vha->hw->fw_attributes;\r\ntmp->firmware_version[4] =\r\nvha->hw->fw_attributes_ext[1] << 16 | vha->hw->fw_attributes_ext[0];\r\n}\r\nstatic void\r\nql27xx_edit_template(struct scsi_qla_host *vha,\r\nstruct qla27xx_fwdt_template *tmp)\r\n{\r\nqla27xx_time_stamp(tmp);\r\nqla27xx_driver_info(tmp);\r\nqla27xx_firmware_info(tmp, vha);\r\n}\r\nstatic inline uint32_t\r\nqla27xx_template_checksum(void *p, ulong size)\r\n{\r\nuint32_t *buf = p;\r\nuint64_t sum = 0;\r\nsize /= sizeof(*buf);\r\nwhile (size--)\r\nsum += *buf++;\r\nsum = (sum & 0xffffffff) + (sum >> 32);\r\nreturn ~sum;\r\n}\r\nstatic inline int\r\nqla27xx_verify_template_checksum(struct qla27xx_fwdt_template *tmp)\r\n{\r\nreturn qla27xx_template_checksum(tmp, tmp->template_size) == 0;\r\n}\r\nstatic inline int\r\nqla27xx_verify_template_header(struct qla27xx_fwdt_template *tmp)\r\n{\r\nreturn tmp->template_type == TEMPLATE_TYPE_FWDUMP;\r\n}\r\nstatic void\r\nqla27xx_execute_fwdt_template(struct scsi_qla_host *vha)\r\n{\r\nstruct qla27xx_fwdt_template *tmp = vha->hw->fw_dump_template;\r\nulong len;\r\nif (qla27xx_fwdt_template_valid(tmp)) {\r\nlen = tmp->template_size;\r\ntmp = memcpy(vha->hw->fw_dump, tmp, len);\r\nql27xx_edit_template(vha, tmp);\r\nqla27xx_walk_template(vha, tmp, tmp, &len);\r\nvha->hw->fw_dump_len = len;\r\nvha->hw->fw_dumped = 1;\r\n}\r\n}\r\nulong\r\nqla27xx_fwdt_calculate_dump_size(struct scsi_qla_host *vha)\r\n{\r\nstruct qla27xx_fwdt_template *tmp = vha->hw->fw_dump_template;\r\nulong len = 0;\r\nif (qla27xx_fwdt_template_valid(tmp)) {\r\nlen = tmp->template_size;\r\nqla27xx_walk_template(vha, tmp, NULL, &len);\r\n}\r\nreturn len;\r\n}\r\nulong\r\nqla27xx_fwdt_template_size(void *p)\r\n{\r\nstruct qla27xx_fwdt_template *tmp = p;\r\nreturn tmp->template_size;\r\n}\r\nulong\r\nqla27xx_fwdt_template_default_size(void)\r\n{\r\nreturn sizeof(ql27xx_fwdt_default_template);\r\n}\r\nconst void *\r\nqla27xx_fwdt_template_default(void)\r\n{\r\nreturn ql27xx_fwdt_default_template;\r\n}\r\nint\r\nqla27xx_fwdt_template_valid(void *p)\r\n{\r\nstruct qla27xx_fwdt_template *tmp = p;\r\nif (!qla27xx_verify_template_header(tmp)) {\r\nql_log(ql_log_warn, NULL, 0xd01c,\r\n"%s: template type %x\n", __func__, tmp->template_type);\r\nreturn false;\r\n}\r\nif (!qla27xx_verify_template_checksum(tmp)) {\r\nql_log(ql_log_warn, NULL, 0xd01d,\r\n"%s: failed template checksum\n", __func__);\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nvoid\r\nqla27xx_fwdump(scsi_qla_host_t *vha, int hardware_locked)\r\n{\r\nulong flags = 0;\r\n#ifndef __CHECKER__\r\nif (!hardware_locked)\r\nspin_lock_irqsave(&vha->hw->hardware_lock, flags);\r\n#endif\r\nif (!vha->hw->fw_dump)\r\nql_log(ql_log_warn, vha, 0xd01e, "fwdump buffer missing.\n");\r\nelse if (!vha->hw->fw_dump_template)\r\nql_log(ql_log_warn, vha, 0xd01f, "fwdump template missing.\n");\r\nelse if (vha->hw->fw_dumped)\r\nql_log(ql_log_warn, vha, 0xd300,\r\n"Firmware has been previously dumped (%p),"\r\n" -- ignoring request\n", vha->hw->fw_dump);\r\nelse\r\nqla27xx_execute_fwdt_template(vha);\r\n#ifndef __CHECKER__\r\nif (!hardware_locked)\r\nspin_unlock_irqrestore(&vha->hw->hardware_lock, flags);\r\n#endif\r\n}

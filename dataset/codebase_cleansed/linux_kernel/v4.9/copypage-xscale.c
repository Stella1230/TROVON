static void __naked\r\nmc_copy_user_page(void *from, void *to)\r\n{\r\nasm volatile(\r\n"stmfd sp!, {r4, r5, lr} \n\\r\nmov lr, %2 \n\\r\npld [r0, #0] \n\\r\npld [r0, #32] \n\\r\npld [r1, #0] \n\\r\npld [r1, #32] \n\\r\n1: pld [r0, #64] \n\\r\npld [r0, #96] \n\\r\npld [r1, #64] \n\\r\npld [r1, #96] \n\\r\n2: ldrd r2, [r0], #8 \n\\r\nldrd r4, [r0], #8 \n\\r\nmov ip, r1 \n\\r\nstrd r2, [r1], #8 \n\\r\nldrd r2, [r0], #8 \n\\r\nstrd r4, [r1], #8 \n\\r\nldrd r4, [r0], #8 \n\\r\nstrd r2, [r1], #8 \n\\r\nstrd r4, [r1], #8 \n\\r\nmcr p15, 0, ip, c7, c10, 1 @ clean D line\n\\r\nldrd r2, [r0], #8 \n\\r\nmcr p15, 0, ip, c7, c6, 1 @ invalidate D line\n\\r\nldrd r4, [r0], #8 \n\\r\nmov ip, r1 \n\\r\nstrd r2, [r1], #8 \n\\r\nldrd r2, [r0], #8 \n\\r\nstrd r4, [r1], #8 \n\\r\nldrd r4, [r0], #8 \n\\r\nstrd r2, [r1], #8 \n\\r\nstrd r4, [r1], #8 \n\\r\nmcr p15, 0, ip, c7, c10, 1 @ clean D line\n\\r\nsubs lr, lr, #1 \n\\r\nmcr p15, 0, ip, c7, c6, 1 @ invalidate D line\n\\r\nbgt 1b \n\\r\nbeq 2b \n\\r\nldmfd sp!, {r4, r5, pc} "\r\n:\r\n: "r" (from), "r" (to), "I" (PAGE_SIZE / 64 - 1));\r\n}\r\nvoid xscale_mc_copy_user_highpage(struct page *to, struct page *from,\r\nunsigned long vaddr, struct vm_area_struct *vma)\r\n{\r\nvoid *kto = kmap_atomic(to);\r\nif (!test_and_set_bit(PG_dcache_clean, &from->flags))\r\n__flush_dcache_page(page_mapping(from), from);\r\nraw_spin_lock(&minicache_lock);\r\nset_top_pte(COPYPAGE_MINICACHE, mk_pte(from, minicache_pgprot));\r\nmc_copy_user_page((void *)COPYPAGE_MINICACHE, kto);\r\nraw_spin_unlock(&minicache_lock);\r\nkunmap_atomic(kto);\r\n}\r\nvoid\r\nxscale_mc_clear_user_highpage(struct page *page, unsigned long vaddr)\r\n{\r\nvoid *ptr, *kaddr = kmap_atomic(page);\r\nasm volatile(\r\n"mov r1, %2 \n\\r\nmov r2, #0 \n\\r\nmov r3, #0 \n\\r\n1: mov ip, %0 \n\\r\nstrd r2, [%0], #8 \n\\r\nstrd r2, [%0], #8 \n\\r\nstrd r2, [%0], #8 \n\\r\nstrd r2, [%0], #8 \n\\r\nmcr p15, 0, ip, c7, c10, 1 @ clean D line\n\\r\nsubs r1, r1, #1 \n\\r\nmcr p15, 0, ip, c7, c6, 1 @ invalidate D line\n\\r\nbne 1b"\r\n: "=r" (ptr)\r\n: "0" (kaddr), "I" (PAGE_SIZE / 32)\r\n: "r1", "r2", "r3", "ip");\r\nkunmap_atomic(kaddr);\r\n}

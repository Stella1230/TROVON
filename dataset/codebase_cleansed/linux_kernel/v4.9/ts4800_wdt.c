static void ts4800_write_feed(struct ts4800_wdt *wdt, u32 val)\r\n{\r\nregmap_write(wdt->regmap, wdt->feed_offset, val);\r\n}\r\nstatic int ts4800_wdt_start(struct watchdog_device *wdd)\r\n{\r\nstruct ts4800_wdt *wdt = watchdog_get_drvdata(wdd);\r\nts4800_write_feed(wdt, wdt->feed_val);\r\nreturn 0;\r\n}\r\nstatic int ts4800_wdt_stop(struct watchdog_device *wdd)\r\n{\r\nstruct ts4800_wdt *wdt = watchdog_get_drvdata(wdd);\r\nts4800_write_feed(wdt, TS4800_WDT_DISABLE);\r\nreturn 0;\r\n}\r\nstatic int ts4800_wdt_set_timeout(struct watchdog_device *wdd,\r\nunsigned int timeout)\r\n{\r\nstruct ts4800_wdt *wdt = watchdog_get_drvdata(wdd);\r\nint i;\r\nfor (i = 0; i < MAX_TIMEOUT_INDEX; i++) {\r\nif (ts4800_wdt_map[i].timeout >= timeout)\r\nbreak;\r\n}\r\nwdd->timeout = ts4800_wdt_map[i].timeout;\r\nwdt->feed_val = ts4800_wdt_map[i].regval;\r\nreturn 0;\r\n}\r\nstatic int ts4800_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct device_node *syscon_np;\r\nstruct watchdog_device *wdd;\r\nstruct ts4800_wdt *wdt;\r\nu32 reg;\r\nint ret;\r\nsyscon_np = of_parse_phandle(np, "syscon", 0);\r\nif (!syscon_np) {\r\ndev_err(&pdev->dev, "no syscon property\n");\r\nreturn -ENODEV;\r\n}\r\nret = of_property_read_u32_index(np, "syscon", 1, &reg);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "no offset in syscon\n");\r\nreturn ret;\r\n}\r\nwdt = devm_kzalloc(&pdev->dev, sizeof(*wdt), GFP_KERNEL);\r\nif (!wdt)\r\nreturn -ENOMEM;\r\nwdt->feed_offset = reg;\r\nwdt->regmap = syscon_node_to_regmap(syscon_np);\r\nif (IS_ERR(wdt->regmap)) {\r\ndev_err(&pdev->dev, "cannot get parent's regmap\n");\r\nreturn PTR_ERR(wdt->regmap);\r\n}\r\nwdd = &wdt->wdd;\r\nwdd->parent = &pdev->dev;\r\nwdd->info = &ts4800_wdt_info;\r\nwdd->ops = &ts4800_wdt_ops;\r\nwdd->min_timeout = ts4800_wdt_map[0].timeout;\r\nwdd->max_timeout = ts4800_wdt_map[MAX_TIMEOUT_INDEX].timeout;\r\nwatchdog_set_drvdata(wdd, wdt);\r\nwatchdog_set_nowayout(wdd, nowayout);\r\nwatchdog_init_timeout(wdd, 0, &pdev->dev);\r\nif (!wdd->timeout)\r\nwdd->timeout = wdd->max_timeout;\r\nts4800_wdt_set_timeout(wdd, wdd->timeout);\r\nts4800_wdt_stop(wdd);\r\nret = watchdog_register_device(wdd);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"failed to register watchdog device\n");\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, wdt);\r\ndev_info(&pdev->dev,\r\n"initialized (timeout = %d sec, nowayout = %d)\n",\r\nwdd->timeout, nowayout);\r\nreturn 0;\r\n}\r\nstatic int ts4800_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct ts4800_wdt *wdt = platform_get_drvdata(pdev);\r\nwatchdog_unregister_device(&wdt->wdd);\r\nreturn 0;\r\n}

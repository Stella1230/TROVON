static inline int is_mt76x8(void)\r\n{\r\nreturn ralink_soc == MT762X_SOC_MT7628AN ||\r\nralink_soc == MT762X_SOC_MT7688;\r\n}\r\nstatic __init u32\r\nmt7620_calc_rate(u32 ref_rate, u32 mul, u32 div)\r\n{\r\nu64 t;\r\nt = ref_rate;\r\nt *= mul;\r\ndo_div(t, div);\r\nreturn t;\r\n}\r\nstatic __init unsigned long\r\nmt7620_get_xtal_rate(void)\r\n{\r\nu32 reg;\r\nreg = rt_sysc_r32(SYSC_REG_SYSTEM_CONFIG0);\r\nif (reg & SYSCFG0_XTAL_FREQ_SEL)\r\nreturn MHZ(40);\r\nreturn MHZ(20);\r\n}\r\nstatic __init unsigned long\r\nmt7620_get_periph_rate(unsigned long xtal_rate)\r\n{\r\nu32 reg;\r\nreg = rt_sysc_r32(SYSC_REG_CLKCFG0);\r\nif (reg & CLKCFG0_PERI_CLK_SEL)\r\nreturn xtal_rate;\r\nreturn MHZ(40);\r\n}\r\nstatic __init unsigned long\r\nmt7620_get_cpu_pll_rate(unsigned long xtal_rate)\r\n{\r\nu32 reg;\r\nu32 mul;\r\nu32 div;\r\nreg = rt_sysc_r32(SYSC_REG_CPLL_CONFIG0);\r\nif (reg & CPLL_CFG0_BYPASS_REF_CLK)\r\nreturn xtal_rate;\r\nif ((reg & CPLL_CFG0_SW_CFG) == 0)\r\nreturn MHZ(600);\r\nmul = (reg >> CPLL_CFG0_PLL_MULT_RATIO_SHIFT) &\r\nCPLL_CFG0_PLL_MULT_RATIO_MASK;\r\nmul += 24;\r\nif (reg & CPLL_CFG0_LC_CURFCK)\r\nmul *= 2;\r\ndiv = (reg >> CPLL_CFG0_PLL_DIV_RATIO_SHIFT) &\r\nCPLL_CFG0_PLL_DIV_RATIO_MASK;\r\nWARN_ON(div >= ARRAY_SIZE(mt7620_clk_divider));\r\nreturn mt7620_calc_rate(xtal_rate, mul, mt7620_clk_divider[div]);\r\n}\r\nstatic __init unsigned long\r\nmt7620_get_pll_rate(unsigned long xtal_rate, unsigned long cpu_pll_rate)\r\n{\r\nu32 reg;\r\nreg = rt_sysc_r32(SYSC_REG_CPLL_CONFIG1);\r\nif (reg & CPLL_CFG1_CPU_AUX1)\r\nreturn xtal_rate;\r\nif (reg & CPLL_CFG1_CPU_AUX0)\r\nreturn MHZ(480);\r\nreturn cpu_pll_rate;\r\n}\r\nstatic __init unsigned long\r\nmt7620_get_cpu_rate(unsigned long pll_rate)\r\n{\r\nu32 reg;\r\nu32 mul;\r\nu32 div;\r\nreg = rt_sysc_r32(SYSC_REG_CPU_SYS_CLKCFG);\r\nmul = reg & CPU_SYS_CLKCFG_CPU_FFRAC_MASK;\r\ndiv = (reg >> CPU_SYS_CLKCFG_CPU_FDIV_SHIFT) &\r\nCPU_SYS_CLKCFG_CPU_FDIV_MASK;\r\nreturn mt7620_calc_rate(pll_rate, mul, div);\r\n}\r\nstatic __init unsigned long\r\nmt7620_get_dram_rate(unsigned long pll_rate)\r\n{\r\nif (dram_type == SYSCFG0_DRAM_TYPE_SDRAM)\r\nreturn pll_rate / 4;\r\nreturn pll_rate / 3;\r\n}\r\nstatic __init unsigned long\r\nmt7620_get_sys_rate(unsigned long cpu_rate)\r\n{\r\nu32 reg;\r\nu32 ocp_ratio;\r\nu32 div;\r\nreg = rt_sysc_r32(SYSC_REG_CPU_SYS_CLKCFG);\r\nocp_ratio = (reg >> CPU_SYS_CLKCFG_OCP_RATIO_SHIFT) &\r\nCPU_SYS_CLKCFG_OCP_RATIO_MASK;\r\nif (WARN_ON(ocp_ratio >= ARRAY_SIZE(mt7620_ocp_dividers)))\r\nreturn cpu_rate;\r\ndiv = mt7620_ocp_dividers[ocp_ratio];\r\nif (WARN(!div, "invalid divider for OCP ratio %u", ocp_ratio))\r\nreturn cpu_rate;\r\nreturn cpu_rate / div;\r\n}\r\nvoid __init ralink_clk_init(void)\r\n{\r\nunsigned long xtal_rate;\r\nunsigned long cpu_pll_rate;\r\nunsigned long pll_rate;\r\nunsigned long cpu_rate;\r\nunsigned long sys_rate;\r\nunsigned long dram_rate;\r\nunsigned long periph_rate;\r\nxtal_rate = mt7620_get_xtal_rate();\r\n#define RFMT(label) label ":%lu.%03luMHz "\r\n#define RINT(x) ((x) / 1000000)\r\n#define RFRAC(x) (((x) / 1000) % 1000)\r\nif (is_mt76x8()) {\r\nif (xtal_rate == MHZ(40))\r\ncpu_rate = MHZ(580);\r\nelse\r\ncpu_rate = MHZ(575);\r\ndram_rate = sys_rate = cpu_rate / 3;\r\nperiph_rate = MHZ(40);\r\nralink_clk_add("10000d00.uartlite", periph_rate);\r\nralink_clk_add("10000e00.uartlite", periph_rate);\r\n} else {\r\ncpu_pll_rate = mt7620_get_cpu_pll_rate(xtal_rate);\r\npll_rate = mt7620_get_pll_rate(xtal_rate, cpu_pll_rate);\r\ncpu_rate = mt7620_get_cpu_rate(pll_rate);\r\ndram_rate = mt7620_get_dram_rate(pll_rate);\r\nsys_rate = mt7620_get_sys_rate(cpu_rate);\r\nperiph_rate = mt7620_get_periph_rate(xtal_rate);\r\npr_debug(RFMT("XTAL") RFMT("CPU_PLL") RFMT("PLL"),\r\nRINT(xtal_rate), RFRAC(xtal_rate),\r\nRINT(cpu_pll_rate), RFRAC(cpu_pll_rate),\r\nRINT(pll_rate), RFRAC(pll_rate));\r\nralink_clk_add("10000500.uart", periph_rate);\r\n}\r\npr_debug(RFMT("CPU") RFMT("DRAM") RFMT("SYS") RFMT("PERIPH"),\r\nRINT(cpu_rate), RFRAC(cpu_rate),\r\nRINT(dram_rate), RFRAC(dram_rate),\r\nRINT(sys_rate), RFRAC(sys_rate),\r\nRINT(periph_rate), RFRAC(periph_rate));\r\n#undef RFRAC\r\n#undef RINT\r\n#undef RFMT\r\nralink_clk_add("cpu", cpu_rate);\r\nralink_clk_add("10000100.timer", periph_rate);\r\nralink_clk_add("10000120.watchdog", periph_rate);\r\nralink_clk_add("10000b00.spi", sys_rate);\r\nralink_clk_add("10000b40.spi", sys_rate);\r\nralink_clk_add("10000c00.uartlite", periph_rate);\r\nralink_clk_add("10000d00.uart1", periph_rate);\r\nralink_clk_add("10000e00.uart2", periph_rate);\r\nralink_clk_add("10180000.wmac", xtal_rate);\r\nif (IS_ENABLED(CONFIG_USB) && !is_mt76x8()) {\r\nu32 val = rt_sysc_r32(SYSC_REG_CPU_SYS_CLKCFG);\r\nval &= ~(CLKCFG_FDIV_MASK | CLKCFG_FFRAC_MASK);\r\nval |= CLKCFG_FDIV_USB_VAL | CLKCFG_FFRAC_USB_VAL;\r\nrt_sysc_w32(val, SYSC_REG_CPU_SYS_CLKCFG);\r\n}\r\n}\r\nvoid __init ralink_of_remap(void)\r\n{\r\nrt_sysc_membase = plat_of_remap_node("ralink,mt7620a-sysc");\r\nrt_memc_membase = plat_of_remap_node("ralink,mt7620a-memc");\r\nif (!rt_sysc_membase || !rt_memc_membase)\r\npanic("Failed to remap core resources");\r\n}\r\nstatic __init void\r\nmt7620_dram_init(struct ralink_soc_info *soc_info)\r\n{\r\nswitch (dram_type) {\r\ncase SYSCFG0_DRAM_TYPE_SDRAM:\r\npr_info("Board has SDRAM\n");\r\nsoc_info->mem_size_min = MT7620_SDRAM_SIZE_MIN;\r\nsoc_info->mem_size_max = MT7620_SDRAM_SIZE_MAX;\r\nbreak;\r\ncase SYSCFG0_DRAM_TYPE_DDR1:\r\npr_info("Board has DDR1\n");\r\nsoc_info->mem_size_min = MT7620_DDR1_SIZE_MIN;\r\nsoc_info->mem_size_max = MT7620_DDR1_SIZE_MAX;\r\nbreak;\r\ncase SYSCFG0_DRAM_TYPE_DDR2:\r\npr_info("Board has DDR2\n");\r\nsoc_info->mem_size_min = MT7620_DDR2_SIZE_MIN;\r\nsoc_info->mem_size_max = MT7620_DDR2_SIZE_MAX;\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\n}\r\nstatic __init void\r\nmt7628_dram_init(struct ralink_soc_info *soc_info)\r\n{\r\nswitch (dram_type) {\r\ncase SYSCFG0_DRAM_TYPE_DDR1_MT7628:\r\npr_info("Board has DDR1\n");\r\nsoc_info->mem_size_min = MT7620_DDR1_SIZE_MIN;\r\nsoc_info->mem_size_max = MT7620_DDR1_SIZE_MAX;\r\nbreak;\r\ncase SYSCFG0_DRAM_TYPE_DDR2_MT7628:\r\npr_info("Board has DDR2\n");\r\nsoc_info->mem_size_min = MT7620_DDR2_SIZE_MIN;\r\nsoc_info->mem_size_max = MT7620_DDR2_SIZE_MAX;\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\n}\r\nvoid prom_soc_init(struct ralink_soc_info *soc_info)\r\n{\r\nvoid __iomem *sysc = (void __iomem *) KSEG1ADDR(MT7620_SYSC_BASE);\r\nunsigned char *name = NULL;\r\nu32 n0;\r\nu32 n1;\r\nu32 rev;\r\nu32 cfg0;\r\nu32 pmu0;\r\nu32 pmu1;\r\nu32 bga;\r\nn0 = __raw_readl(sysc + SYSC_REG_CHIP_NAME0);\r\nn1 = __raw_readl(sysc + SYSC_REG_CHIP_NAME1);\r\nrev = __raw_readl(sysc + SYSC_REG_CHIP_REV);\r\nbga = (rev >> CHIP_REV_PKG_SHIFT) & CHIP_REV_PKG_MASK;\r\nif (n0 == MT7620_CHIP_NAME0 && n1 == MT7620_CHIP_NAME1) {\r\nif (bga) {\r\nralink_soc = MT762X_SOC_MT7620A;\r\nname = "MT7620A";\r\nsoc_info->compatible = "ralink,mt7620a-soc";\r\n} else {\r\nralink_soc = MT762X_SOC_MT7620N;\r\nname = "MT7620N";\r\nsoc_info->compatible = "ralink,mt7620n-soc";\r\n}\r\n} else if (n0 == MT7620_CHIP_NAME0 && n1 == MT7628_CHIP_NAME1) {\r\nu32 efuse = __raw_readl(sysc + SYSC_REG_EFUSE_CFG);\r\nif (efuse & EFUSE_MT7688) {\r\nralink_soc = MT762X_SOC_MT7688;\r\nname = "MT7688";\r\n} else {\r\nralink_soc = MT762X_SOC_MT7628AN;\r\nname = "MT7628AN";\r\n}\r\nsoc_info->compatible = "ralink,mt7628an-soc";\r\n} else {\r\npanic("mt762x: unknown SoC, n0:%08x n1:%08x\n", n0, n1);\r\n}\r\nsnprintf(soc_info->sys_type, RAMIPS_SYS_TYPE_LEN,\r\n"MediaTek %s ver:%u eco:%u",\r\nname,\r\n(rev >> CHIP_REV_VER_SHIFT) & CHIP_REV_VER_MASK,\r\n(rev & CHIP_REV_ECO_MASK));\r\ncfg0 = __raw_readl(sysc + SYSC_REG_SYSTEM_CONFIG0);\r\nif (is_mt76x8()) {\r\ndram_type = cfg0 & DRAM_TYPE_MT7628_MASK;\r\n} else {\r\ndram_type = (cfg0 >> SYSCFG0_DRAM_TYPE_SHIFT) &\r\nSYSCFG0_DRAM_TYPE_MASK;\r\nif (dram_type == SYSCFG0_DRAM_TYPE_UNKNOWN)\r\ndram_type = SYSCFG0_DRAM_TYPE_SDRAM;\r\n}\r\nsoc_info->mem_base = MT7620_DRAM_BASE;\r\nif (is_mt76x8())\r\nmt7628_dram_init(soc_info);\r\nelse\r\nmt7620_dram_init(soc_info);\r\npmu0 = __raw_readl(sysc + PMU0_CFG);\r\npmu1 = __raw_readl(sysc + PMU1_CFG);\r\npr_info("Analog PMU set to %s control\n",\r\n(pmu0 & PMU_SW_SET) ? ("sw") : ("hw"));\r\npr_info("Digital PMU set to %s control\n",\r\n(pmu1 & DIG_SW_SEL) ? ("sw") : ("hw"));\r\nif (is_mt76x8())\r\nrt2880_pinmux_data = mt7628an_pinmux_data;\r\nelse\r\nrt2880_pinmux_data = mt7620a_pinmux_data;\r\n}

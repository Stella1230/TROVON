static void radeon_lock_cursor(struct drm_crtc *crtc, bool lock)\r\n{\r\nstruct radeon_device *rdev = crtc->dev->dev_private;\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\r\nuint32_t cur_lock;\r\nif (ASIC_IS_DCE4(rdev)) {\r\ncur_lock = RREG32(EVERGREEN_CUR_UPDATE + radeon_crtc->crtc_offset);\r\nif (lock)\r\ncur_lock |= EVERGREEN_CURSOR_UPDATE_LOCK;\r\nelse\r\ncur_lock &= ~EVERGREEN_CURSOR_UPDATE_LOCK;\r\nWREG32(EVERGREEN_CUR_UPDATE + radeon_crtc->crtc_offset, cur_lock);\r\n} else if (ASIC_IS_AVIVO(rdev)) {\r\ncur_lock = RREG32(AVIVO_D1CUR_UPDATE + radeon_crtc->crtc_offset);\r\nif (lock)\r\ncur_lock |= AVIVO_D1CURSOR_UPDATE_LOCK;\r\nelse\r\ncur_lock &= ~AVIVO_D1CURSOR_UPDATE_LOCK;\r\nWREG32(AVIVO_D1CUR_UPDATE + radeon_crtc->crtc_offset, cur_lock);\r\n} else {\r\ncur_lock = RREG32(RADEON_CUR_OFFSET + radeon_crtc->crtc_offset);\r\nif (lock)\r\ncur_lock |= RADEON_CUR_LOCK;\r\nelse\r\ncur_lock &= ~RADEON_CUR_LOCK;\r\nWREG32(RADEON_CUR_OFFSET + radeon_crtc->crtc_offset, cur_lock);\r\n}\r\n}\r\nstatic void radeon_hide_cursor(struct drm_crtc *crtc)\r\n{\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\r\nstruct radeon_device *rdev = crtc->dev->dev_private;\r\nif (ASIC_IS_DCE4(rdev)) {\r\nWREG32_IDX(EVERGREEN_CUR_CONTROL + radeon_crtc->crtc_offset,\r\nEVERGREEN_CURSOR_MODE(EVERGREEN_CURSOR_24_8_PRE_MULT) |\r\nEVERGREEN_CURSOR_URGENT_CONTROL(EVERGREEN_CURSOR_URGENT_1_2));\r\n} else if (ASIC_IS_AVIVO(rdev)) {\r\nWREG32_IDX(AVIVO_D1CUR_CONTROL + radeon_crtc->crtc_offset,\r\n(AVIVO_D1CURSOR_MODE_24BPP << AVIVO_D1CURSOR_MODE_SHIFT));\r\n} else {\r\nu32 reg;\r\nswitch (radeon_crtc->crtc_id) {\r\ncase 0:\r\nreg = RADEON_CRTC_GEN_CNTL;\r\nbreak;\r\ncase 1:\r\nreg = RADEON_CRTC2_GEN_CNTL;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nWREG32_IDX(reg, RREG32_IDX(reg) & ~RADEON_CRTC_CUR_EN);\r\n}\r\n}\r\nstatic void radeon_show_cursor(struct drm_crtc *crtc)\r\n{\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\r\nstruct radeon_device *rdev = crtc->dev->dev_private;\r\nif (ASIC_IS_DCE4(rdev)) {\r\nWREG32(EVERGREEN_CUR_SURFACE_ADDRESS_HIGH + radeon_crtc->crtc_offset,\r\nupper_32_bits(radeon_crtc->cursor_addr));\r\nWREG32(EVERGREEN_CUR_SURFACE_ADDRESS + radeon_crtc->crtc_offset,\r\nlower_32_bits(radeon_crtc->cursor_addr));\r\nWREG32(RADEON_MM_INDEX, EVERGREEN_CUR_CONTROL + radeon_crtc->crtc_offset);\r\nWREG32(RADEON_MM_DATA, EVERGREEN_CURSOR_EN |\r\nEVERGREEN_CURSOR_MODE(EVERGREEN_CURSOR_24_8_PRE_MULT) |\r\nEVERGREEN_CURSOR_URGENT_CONTROL(EVERGREEN_CURSOR_URGENT_1_2));\r\n} else if (ASIC_IS_AVIVO(rdev)) {\r\nif (rdev->family >= CHIP_RV770) {\r\nif (radeon_crtc->crtc_id)\r\nWREG32(R700_D2CUR_SURFACE_ADDRESS_HIGH,\r\nupper_32_bits(radeon_crtc->cursor_addr));\r\nelse\r\nWREG32(R700_D1CUR_SURFACE_ADDRESS_HIGH,\r\nupper_32_bits(radeon_crtc->cursor_addr));\r\n}\r\nWREG32(AVIVO_D1CUR_SURFACE_ADDRESS + radeon_crtc->crtc_offset,\r\nlower_32_bits(radeon_crtc->cursor_addr));\r\nWREG32(RADEON_MM_INDEX, AVIVO_D1CUR_CONTROL + radeon_crtc->crtc_offset);\r\nWREG32(RADEON_MM_DATA, AVIVO_D1CURSOR_EN |\r\n(AVIVO_D1CURSOR_MODE_24BPP << AVIVO_D1CURSOR_MODE_SHIFT));\r\n} else {\r\nWREG32(RADEON_CUR_OFFSET + radeon_crtc->crtc_offset,\r\nradeon_crtc->cursor_addr - radeon_crtc->legacy_display_base_addr);\r\nswitch (radeon_crtc->crtc_id) {\r\ncase 0:\r\nWREG32(RADEON_MM_INDEX, RADEON_CRTC_GEN_CNTL);\r\nbreak;\r\ncase 1:\r\nWREG32(RADEON_MM_INDEX, RADEON_CRTC2_GEN_CNTL);\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nWREG32_P(RADEON_MM_DATA, (RADEON_CRTC_CUR_EN |\r\n(RADEON_CRTC_CUR_MODE_24BPP << RADEON_CRTC_CUR_MODE_SHIFT)),\r\n~(RADEON_CRTC_CUR_EN | RADEON_CRTC_CUR_MODE_MASK));\r\n}\r\n}\r\nstatic int radeon_cursor_move_locked(struct drm_crtc *crtc, int x, int y)\r\n{\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\r\nstruct radeon_device *rdev = crtc->dev->dev_private;\r\nint xorigin = 0, yorigin = 0;\r\nint w = radeon_crtc->cursor_width;\r\nif (ASIC_IS_AVIVO(rdev)) {\r\nx += crtc->x;\r\ny += crtc->y;\r\n}\r\nDRM_DEBUG("x %d y %d c->x %d c->y %d\n", x, y, crtc->x, crtc->y);\r\nif (x < 0) {\r\nxorigin = min(-x, radeon_crtc->max_cursor_width - 1);\r\nx = 0;\r\n}\r\nif (y < 0) {\r\nyorigin = min(-y, radeon_crtc->max_cursor_height - 1);\r\ny = 0;\r\n}\r\nif (ASIC_IS_AVIVO(rdev) && !ASIC_IS_DCE6(rdev)) {\r\nint i = 0;\r\nstruct drm_crtc *crtc_p;\r\nlist_for_each_entry(crtc_p, &crtc->dev->mode_config.crtc_list, head) {\r\nif (crtc_p->enabled)\r\ni++;\r\n}\r\nif (i > 1) {\r\nint cursor_end, frame_end;\r\ncursor_end = x - xorigin + w;\r\nframe_end = crtc->x + crtc->mode.crtc_hdisplay;\r\nif (cursor_end >= frame_end) {\r\nw = w - (cursor_end - frame_end);\r\nif (!(frame_end & 0x7f))\r\nw--;\r\n} else {\r\nif (!(cursor_end & 0x7f))\r\nw--;\r\n}\r\nif (w <= 0) {\r\nw = 1;\r\ncursor_end = x - xorigin + w;\r\nif (!(cursor_end & 0x7f)) {\r\nx--;\r\nWARN_ON_ONCE(x < 0);\r\n}\r\n}\r\n}\r\n}\r\nif (ASIC_IS_DCE4(rdev)) {\r\nWREG32(EVERGREEN_CUR_POSITION + radeon_crtc->crtc_offset, (x << 16) | y);\r\nWREG32(EVERGREEN_CUR_HOT_SPOT + radeon_crtc->crtc_offset, (xorigin << 16) | yorigin);\r\nWREG32(EVERGREEN_CUR_SIZE + radeon_crtc->crtc_offset,\r\n((w - 1) << 16) | (radeon_crtc->cursor_height - 1));\r\n} else if (ASIC_IS_AVIVO(rdev)) {\r\nWREG32(AVIVO_D1CUR_POSITION + radeon_crtc->crtc_offset, (x << 16) | y);\r\nWREG32(AVIVO_D1CUR_HOT_SPOT + radeon_crtc->crtc_offset, (xorigin << 16) | yorigin);\r\nWREG32(AVIVO_D1CUR_SIZE + radeon_crtc->crtc_offset,\r\n((w - 1) << 16) | (radeon_crtc->cursor_height - 1));\r\n} else {\r\nif (crtc->mode.flags & DRM_MODE_FLAG_DBLSCAN)\r\ny *= 2;\r\nWREG32(RADEON_CUR_HORZ_VERT_OFF + radeon_crtc->crtc_offset,\r\n(RADEON_CUR_LOCK\r\n| (xorigin << 16)\r\n| yorigin));\r\nWREG32(RADEON_CUR_HORZ_VERT_POSN + radeon_crtc->crtc_offset,\r\n(RADEON_CUR_LOCK\r\n| (x << 16)\r\n| y));\r\nWREG32(RADEON_CUR_OFFSET + radeon_crtc->crtc_offset,\r\nradeon_crtc->cursor_addr - radeon_crtc->legacy_display_base_addr +\r\nyorigin * 256);\r\n}\r\nradeon_crtc->cursor_x = x;\r\nradeon_crtc->cursor_y = y;\r\nreturn 0;\r\n}\r\nint radeon_crtc_cursor_move(struct drm_crtc *crtc,\r\nint x, int y)\r\n{\r\nint ret;\r\nradeon_lock_cursor(crtc, true);\r\nret = radeon_cursor_move_locked(crtc, x, y);\r\nradeon_lock_cursor(crtc, false);\r\nreturn ret;\r\n}\r\nint radeon_crtc_cursor_set2(struct drm_crtc *crtc,\r\nstruct drm_file *file_priv,\r\nuint32_t handle,\r\nuint32_t width,\r\nuint32_t height,\r\nint32_t hot_x,\r\nint32_t hot_y)\r\n{\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\r\nstruct radeon_device *rdev = crtc->dev->dev_private;\r\nstruct drm_gem_object *obj;\r\nstruct radeon_bo *robj;\r\nint ret;\r\nif (!handle) {\r\nradeon_hide_cursor(crtc);\r\nobj = NULL;\r\ngoto unpin;\r\n}\r\nif ((width > radeon_crtc->max_cursor_width) ||\r\n(height > radeon_crtc->max_cursor_height)) {\r\nDRM_ERROR("bad cursor width or height %d x %d\n", width, height);\r\nreturn -EINVAL;\r\n}\r\nobj = drm_gem_object_lookup(file_priv, handle);\r\nif (!obj) {\r\nDRM_ERROR("Cannot find cursor object %x for crtc %d\n", handle, radeon_crtc->crtc_id);\r\nreturn -ENOENT;\r\n}\r\nrobj = gem_to_radeon_bo(obj);\r\nret = radeon_bo_reserve(robj, false);\r\nif (ret != 0) {\r\ndrm_gem_object_unreference_unlocked(obj);\r\nreturn ret;\r\n}\r\nret = radeon_bo_pin_restricted(robj, RADEON_GEM_DOMAIN_VRAM,\r\nASIC_IS_AVIVO(rdev) ? 0 : 1 << 27,\r\n&radeon_crtc->cursor_addr);\r\nradeon_bo_unreserve(robj);\r\nif (ret) {\r\nDRM_ERROR("Failed to pin new cursor BO (%d)\n", ret);\r\ndrm_gem_object_unreference_unlocked(obj);\r\nreturn ret;\r\n}\r\nradeon_crtc->cursor_width = width;\r\nradeon_crtc->cursor_height = height;\r\nradeon_lock_cursor(crtc, true);\r\nif (hot_x != radeon_crtc->cursor_hot_x ||\r\nhot_y != radeon_crtc->cursor_hot_y) {\r\nint x, y;\r\nx = radeon_crtc->cursor_x + radeon_crtc->cursor_hot_x - hot_x;\r\ny = radeon_crtc->cursor_y + radeon_crtc->cursor_hot_y - hot_y;\r\nradeon_cursor_move_locked(crtc, x, y);\r\nradeon_crtc->cursor_hot_x = hot_x;\r\nradeon_crtc->cursor_hot_y = hot_y;\r\n}\r\nradeon_show_cursor(crtc);\r\nradeon_lock_cursor(crtc, false);\r\nunpin:\r\nif (radeon_crtc->cursor_bo) {\r\nstruct radeon_bo *robj = gem_to_radeon_bo(radeon_crtc->cursor_bo);\r\nret = radeon_bo_reserve(robj, false);\r\nif (likely(ret == 0)) {\r\nradeon_bo_unpin(robj);\r\nradeon_bo_unreserve(robj);\r\n}\r\ndrm_gem_object_unreference_unlocked(radeon_crtc->cursor_bo);\r\n}\r\nradeon_crtc->cursor_bo = obj;\r\nreturn 0;\r\n}\r\nvoid radeon_cursor_reset(struct drm_crtc *crtc)\r\n{\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\r\nif (radeon_crtc->cursor_bo) {\r\nradeon_lock_cursor(crtc, true);\r\nradeon_cursor_move_locked(crtc, radeon_crtc->cursor_x,\r\nradeon_crtc->cursor_y);\r\nradeon_show_cursor(crtc);\r\nradeon_lock_cursor(crtc, false);\r\n}\r\n}

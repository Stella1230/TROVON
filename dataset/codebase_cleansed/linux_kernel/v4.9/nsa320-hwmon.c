static s32 nsa320_hwmon_update(struct device *dev)\r\n{\r\nu32 mcu_data;\r\nu32 mask;\r\nstruct nsa320_hwmon *hwmon = dev_get_drvdata(dev);\r\nmutex_lock(&hwmon->update_lock);\r\nmcu_data = hwmon->mcu_data;\r\nif (time_after(jiffies, hwmon->last_updated + HZ) || mcu_data == 0) {\r\ngpiod_set_value(hwmon->act, 1);\r\nmsleep(100);\r\nmcu_data = 0;\r\nfor (mask = BIT(31); mask; mask >>= 1) {\r\ngpiod_set_value(hwmon->clk, 0);\r\nusleep_range(100, 200);\r\ngpiod_set_value(hwmon->clk, 1);\r\nusleep_range(100, 200);\r\nif (gpiod_get_value(hwmon->data))\r\nmcu_data |= mask;\r\n}\r\ngpiod_set_value(hwmon->act, 0);\r\ndev_dbg(dev, "Read raw MCU data %08x\n", mcu_data);\r\nif ((mcu_data >> 24) != MAGIC_NUMBER) {\r\ndev_dbg(dev, "Read invalid MCU data %08x\n", mcu_data);\r\nmcu_data = -EIO;\r\n} else {\r\nhwmon->mcu_data = mcu_data;\r\nhwmon->last_updated = jiffies;\r\n}\r\n}\r\nmutex_unlock(&hwmon->update_lock);\r\nreturn mcu_data;\r\n}\r\nstatic ssize_t show_label(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nint channel = to_sensor_dev_attr(attr)->index;\r\nreturn sprintf(buf, "%s\n", nsa320_input_names[channel]);\r\n}\r\nstatic ssize_t show_temp(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\ns32 mcu_data = nsa320_hwmon_update(dev);\r\nif (mcu_data < 0)\r\nreturn mcu_data;\r\nreturn sprintf(buf, "%d\n", (mcu_data & 0xffff) * 100);\r\n}\r\nstatic ssize_t show_fan(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\ns32 mcu_data = nsa320_hwmon_update(dev);\r\nif (mcu_data < 0)\r\nreturn mcu_data;\r\nreturn sprintf(buf, "%d\n", ((mcu_data & 0xff0000) >> 16) * 100);\r\n}\r\nstatic int nsa320_hwmon_probe(struct platform_device *pdev)\r\n{\r\nstruct nsa320_hwmon *hwmon;\r\nstruct device *classdev;\r\nhwmon = devm_kzalloc(&pdev->dev, sizeof(*hwmon), GFP_KERNEL);\r\nif (!hwmon)\r\nreturn -ENOMEM;\r\nhwmon->act = devm_gpiod_get(&pdev->dev, "act", GPIOD_OUT_LOW);\r\nif (IS_ERR(hwmon->act))\r\nreturn PTR_ERR(hwmon->act);\r\nhwmon->clk = devm_gpiod_get(&pdev->dev, "clk", GPIOD_OUT_HIGH);\r\nif (IS_ERR(hwmon->clk))\r\nreturn PTR_ERR(hwmon->clk);\r\nhwmon->data = devm_gpiod_get(&pdev->dev, "data", GPIOD_IN);\r\nif (IS_ERR(hwmon->data))\r\nreturn PTR_ERR(hwmon->data);\r\nmutex_init(&hwmon->update_lock);\r\nclassdev = devm_hwmon_device_register_with_groups(&pdev->dev,\r\n"nsa320", hwmon, nsa320_groups);\r\nreturn PTR_ERR_OR_ZERO(classdev);\r\n}

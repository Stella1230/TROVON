int kgd2kfd_init(unsigned interface_version, const struct kgd2kfd_calls **g2f)\r\n{\r\nif (!amdkfd_init_completed)\r\nreturn -EPROBE_DEFER;\r\nif (interface_version != KFD_INTERFACE_VERSION)\r\nreturn -EINVAL;\r\n*g2f = &kgd2kfd;\r\nreturn 0;\r\n}\r\nvoid kgd2kfd_exit(void)\r\n{\r\n}\r\nstatic int __init kfd_module_init(void)\r\n{\r\nint err;\r\nif ((sched_policy < KFD_SCHED_POLICY_HWS) ||\r\n(sched_policy > KFD_SCHED_POLICY_NO_HWS)) {\r\npr_err("kfd: sched_policy has invalid value\n");\r\nreturn -1;\r\n}\r\nif ((max_num_of_queues_per_device < 1) ||\r\n(max_num_of_queues_per_device >\r\nKFD_MAX_NUM_OF_QUEUES_PER_DEVICE)) {\r\npr_err("kfd: max_num_of_queues_per_device must be between 1 to KFD_MAX_NUM_OF_QUEUES_PER_DEVICE\n");\r\nreturn -1;\r\n}\r\nerr = kfd_pasid_init();\r\nif (err < 0)\r\ngoto err_pasid;\r\nerr = kfd_chardev_init();\r\nif (err < 0)\r\ngoto err_ioctl;\r\nerr = kfd_topology_init();\r\nif (err < 0)\r\ngoto err_topology;\r\nkfd_process_create_wq();\r\namdkfd_init_completed = 1;\r\ndev_info(kfd_device, "Initialized module\n");\r\nreturn 0;\r\nerr_topology:\r\nkfd_chardev_exit();\r\nerr_ioctl:\r\nkfd_pasid_exit();\r\nerr_pasid:\r\nreturn err;\r\n}\r\nstatic void __exit kfd_module_exit(void)\r\n{\r\namdkfd_init_completed = 0;\r\nkfd_process_destroy_wq();\r\nkfd_topology_shutdown();\r\nkfd_chardev_exit();\r\nkfd_pasid_exit();\r\ndev_info(kfd_device, "Removed module\n");\r\n}

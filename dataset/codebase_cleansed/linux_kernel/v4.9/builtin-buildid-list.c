static int sysfs__fprintf_build_id(FILE *fp)\r\n{\r\nchar sbuild_id[SBUILD_ID_SIZE];\r\nint ret;\r\nret = sysfs__sprintf_build_id("/", sbuild_id);\r\nif (ret != sizeof(sbuild_id))\r\nreturn ret < 0 ? ret : -EINVAL;\r\nreturn fprintf(fp, "%s\n", sbuild_id);\r\n}\r\nstatic int filename__fprintf_build_id(const char *name, FILE *fp)\r\n{\r\nchar sbuild_id[SBUILD_ID_SIZE];\r\nint ret;\r\nret = filename__sprintf_build_id(name, sbuild_id);\r\nif (ret != sizeof(sbuild_id))\r\nreturn ret < 0 ? ret : -EINVAL;\r\nreturn fprintf(fp, "%s\n", sbuild_id);\r\n}\r\nstatic bool dso__skip_buildid(struct dso *dso, int with_hits)\r\n{\r\nreturn with_hits && !dso->hit;\r\n}\r\nstatic int perf_session__list_build_ids(bool force, bool with_hits)\r\n{\r\nstruct perf_session *session;\r\nstruct perf_data_file file = {\r\n.path = input_name,\r\n.mode = PERF_DATA_MODE_READ,\r\n.force = force,\r\n};\r\nsymbol__elf_init();\r\nif (filename__fprintf_build_id(input_name, stdout) > 0)\r\ngoto out;\r\nsession = perf_session__new(&file, false, &build_id__mark_dso_hit_ops);\r\nif (session == NULL)\r\nreturn -1;\r\nif (!perf_data_file__is_pipe(&file) &&\r\nperf_header__has_feat(&session->header, HEADER_AUXTRACE))\r\nwith_hits = false;\r\nif (with_hits || perf_data_file__is_pipe(&file))\r\nperf_session__process_events(session);\r\nperf_session__fprintf_dsos_buildid(session, stdout, dso__skip_buildid, with_hits);\r\nperf_session__delete(session);\r\nout:\r\nreturn 0;\r\n}\r\nint cmd_buildid_list(int argc, const char **argv,\r\nconst char *prefix __maybe_unused)\r\n{\r\nbool show_kernel = false;\r\nbool with_hits = false;\r\nbool force = false;\r\nconst struct option options[] = {\r\nOPT_BOOLEAN('H', "with-hits", &with_hits, "Show only DSOs with hits"),\r\nOPT_STRING('i', "input", &input_name, "file", "input file name"),\r\nOPT_BOOLEAN('f', "force", &force, "don't complain, do it"),\r\nOPT_BOOLEAN('k', "kernel", &show_kernel, "Show current kernel build id"),\r\nOPT_INCR('v', "verbose", &verbose, "be more verbose"),\r\nOPT_END()\r\n};\r\nconst char * const buildid_list_usage[] = {\r\n"perf buildid-list [<options>]",\r\nNULL\r\n};\r\nargc = parse_options(argc, argv, options, buildid_list_usage, 0);\r\nsetup_pager();\r\nif (show_kernel)\r\nreturn !(sysfs__fprintf_build_id(stdout) > 0);\r\nreturn perf_session__list_build_ids(force, with_hits);\r\n}

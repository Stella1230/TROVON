static int pci_8255_mite_init(struct pci_dev *pcidev)\r\n{\r\nvoid __iomem *mite_base;\r\nu32 main_phys_addr;\r\nmite_base = pci_ioremap_bar(pcidev, 0);\r\nif (!mite_base)\r\nreturn -ENOMEM;\r\nmain_phys_addr = pci_resource_start(pcidev, 1);\r\nwritel(main_phys_addr | WENAB, mite_base + MITE_IODWBSR);\r\niounmap(mite_base);\r\nreturn 0;\r\n}\r\nstatic int pci_8255_auto_attach(struct comedi_device *dev,\r\nunsigned long context)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nconst struct pci_8255_boardinfo *board = NULL;\r\nstruct comedi_subdevice *s;\r\nint ret;\r\nint i;\r\nif (context < ARRAY_SIZE(pci_8255_boards))\r\nboard = &pci_8255_boards[context];\r\nif (!board)\r\nreturn -ENODEV;\r\ndev->board_ptr = board;\r\ndev->board_name = board->name;\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\nif (board->has_mite) {\r\nret = pci_8255_mite_init(pcidev);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif ((pci_resource_flags(pcidev, board->dio_badr) & IORESOURCE_MEM)) {\r\ndev->mmio = pci_ioremap_bar(pcidev, board->dio_badr);\r\nif (!dev->mmio)\r\nreturn -ENOMEM;\r\n} else {\r\ndev->iobase = pci_resource_start(pcidev, board->dio_badr);\r\n}\r\nret = comedi_alloc_subdevices(dev, board->n_8255);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < board->n_8255; i++) {\r\ns = &dev->subdevices[i];\r\nif (dev->mmio)\r\nret = subdev_8255_mm_init(dev, s, NULL, i * I8255_SIZE);\r\nelse\r\nret = subdev_8255_init(dev, s, NULL, i * I8255_SIZE);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pci_8255_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &pci_8255_driver, id->driver_data);\r\n}

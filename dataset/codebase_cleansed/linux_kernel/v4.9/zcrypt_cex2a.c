static int zcrypt_cex2a_probe(struct ap_device *ap_dev)\r\n{\r\nstruct zcrypt_device *zdev = NULL;\r\nint rc = 0;\r\nswitch (ap_dev->device_type) {\r\ncase AP_DEVICE_TYPE_CEX2A:\r\nzdev = zcrypt_device_alloc(CEX2A_MAX_RESPONSE_SIZE);\r\nif (!zdev)\r\nreturn -ENOMEM;\r\nzdev->user_space_type = ZCRYPT_CEX2A;\r\nzdev->type_string = "CEX2A";\r\nzdev->min_mod_size = CEX2A_MIN_MOD_SIZE;\r\nzdev->max_mod_size = CEX2A_MAX_MOD_SIZE;\r\nzdev->short_crt = 1;\r\nzdev->speed_rating = CEX2A_SPEED_RATING;\r\nzdev->max_exp_bit_length = CEX2A_MAX_MOD_SIZE;\r\nbreak;\r\ncase AP_DEVICE_TYPE_CEX3A:\r\nzdev = zcrypt_device_alloc(CEX3A_MAX_RESPONSE_SIZE);\r\nif (!zdev)\r\nreturn -ENOMEM;\r\nzdev->user_space_type = ZCRYPT_CEX3A;\r\nzdev->type_string = "CEX3A";\r\nzdev->min_mod_size = CEX2A_MIN_MOD_SIZE;\r\nzdev->max_mod_size = CEX2A_MAX_MOD_SIZE;\r\nzdev->max_exp_bit_length = CEX2A_MAX_MOD_SIZE;\r\nif (ap_test_bit(&ap_dev->functions, AP_FUNC_MEX4K) &&\r\nap_test_bit(&ap_dev->functions, AP_FUNC_CRT4K)) {\r\nzdev->max_mod_size = CEX3A_MAX_MOD_SIZE;\r\nzdev->max_exp_bit_length = CEX3A_MAX_MOD_SIZE;\r\n}\r\nzdev->short_crt = 1;\r\nzdev->speed_rating = CEX3A_SPEED_RATING;\r\nbreak;\r\n}\r\nif (!zdev)\r\nreturn -ENODEV;\r\nzdev->ops = zcrypt_msgtype_request(MSGTYPE50_NAME,\r\nMSGTYPE50_VARIANT_DEFAULT);\r\nzdev->ap_dev = ap_dev;\r\nzdev->online = 1;\r\nap_device_init_reply(ap_dev, &zdev->reply);\r\nap_dev->private = zdev;\r\nrc = zcrypt_device_register(zdev);\r\nif (rc) {\r\nap_dev->private = NULL;\r\nzcrypt_msgtype_release(zdev->ops);\r\nzcrypt_device_free(zdev);\r\n}\r\nreturn rc;\r\n}\r\nstatic void zcrypt_cex2a_remove(struct ap_device *ap_dev)\r\n{\r\nstruct zcrypt_device *zdev = ap_dev->private;\r\nstruct zcrypt_ops *zops = zdev->ops;\r\nzcrypt_device_unregister(zdev);\r\nzcrypt_msgtype_release(zops);\r\n}\r\nint __init zcrypt_cex2a_init(void)\r\n{\r\nreturn ap_driver_register(&zcrypt_cex2a_driver, THIS_MODULE, "cex2a");\r\n}\r\nvoid __exit zcrypt_cex2a_exit(void)\r\n{\r\nap_driver_unregister(&zcrypt_cex2a_driver);\r\n}

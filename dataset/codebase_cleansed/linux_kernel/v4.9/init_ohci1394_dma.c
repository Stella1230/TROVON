static inline void reg_write(const struct ohci *ohci, int offset, u32 data)\r\n{\r\nwritel(data, ohci->registers + offset);\r\n}\r\nstatic inline u32 reg_read(const struct ohci *ohci, int offset)\r\n{\r\nreturn readl(ohci->registers + offset);\r\n}\r\nstatic inline u8 __init get_phy_reg(struct ohci *ohci, u8 addr)\r\n{\r\nint i;\r\nu32 r;\r\nreg_write(ohci, OHCI1394_PhyControl, (addr << 8) | 0x00008000);\r\nfor (i = 0; i < OHCI_LOOP_COUNT; i++) {\r\nif (reg_read(ohci, OHCI1394_PhyControl) & 0x80000000)\r\nbreak;\r\nmdelay(1);\r\n}\r\nr = reg_read(ohci, OHCI1394_PhyControl);\r\nreturn (r & 0x00ff0000) >> 16;\r\n}\r\nstatic inline void __init set_phy_reg(struct ohci *ohci, u8 addr, u8 data)\r\n{\r\nint i;\r\nreg_write(ohci, OHCI1394_PhyControl, (addr << 8) | data | 0x00004000);\r\nfor (i = 0; i < OHCI_LOOP_COUNT; i++) {\r\nif (!(reg_read(ohci, OHCI1394_PhyControl) & 0x00004000))\r\nbreak;\r\nmdelay(1);\r\n}\r\n}\r\nstatic inline void __init init_ohci1394_soft_reset(struct ohci *ohci)\r\n{\r\nint i;\r\nreg_write(ohci, OHCI1394_HCControlSet, OHCI1394_HCControl_softReset);\r\nfor (i = 0; i < OHCI_LOOP_COUNT; i++) {\r\nif (!(reg_read(ohci, OHCI1394_HCControlSet)\r\n& OHCI1394_HCControl_softReset))\r\nbreak;\r\nmdelay(1);\r\n}\r\n}\r\nstatic inline void __init init_ohci1394_initialize(struct ohci *ohci)\r\n{\r\nu32 bus_options;\r\nint num_ports, i;\r\nbus_options = reg_read(ohci, OHCI1394_BusOptions);\r\nbus_options |= 0x60000000;\r\nbus_options &= ~0x00ff0000;\r\nbus_options &= ~0x18000000;\r\nreg_write(ohci, OHCI1394_BusOptions, bus_options);\r\nreg_write(ohci, OHCI1394_NodeID, 0x0000ffc0);\r\nreg_write(ohci, OHCI1394_HCControlSet,\r\nOHCI1394_HCControl_postedWriteEnable);\r\nreg_write(ohci, OHCI1394_LinkControlClear, 0xffffffff);\r\nreg_write(ohci, OHCI1394_LinkControlSet,\r\nOHCI1394_LinkControl_rcvPhyPkt);\r\nreg_write(ohci, OHCI1394_LinkControlClear, 0x00000400);\r\nreg_write(ohci, OHCI1394_IsoRecvIntMaskClear, 0xffffffff);\r\nreg_write(ohci, OHCI1394_IsoRecvIntEventClear, 0xffffffff);\r\nreg_write(ohci, OHCI1394_IsoXmitIntMaskClear, 0xffffffff);\r\nreg_write(ohci, OHCI1394_IsoXmitIntEventClear, 0xffffffff);\r\nreg_write(ohci, OHCI1394_AsReqFilterHiSet, 0x80000000);\r\nreg_write(ohci, OHCI1394_ATRetries,\r\nOHCI1394_MAX_AT_REQ_RETRIES |\r\n(OHCI1394_MAX_AT_RESP_RETRIES<<4) |\r\n(OHCI1394_MAX_PHYS_RESP_RETRIES<<8));\r\nreg_write(ohci, OHCI1394_HCControlClear,\r\nOHCI1394_HCControl_noByteSwapData);\r\nreg_write(ohci, OHCI1394_HCControlSet, OHCI1394_HCControl_linkEnable);\r\nnum_ports = get_phy_reg(ohci, 2) & 0xf;\r\nfor (i = 0; i < num_ports; i++) {\r\nunsigned int status;\r\nset_phy_reg(ohci, 7, i);\r\nstatus = get_phy_reg(ohci, 8);\r\nif (status & 0x20)\r\nset_phy_reg(ohci, 8, status & ~1);\r\n}\r\n}\r\nstatic inline void __init init_ohci1394_wait_for_busresets(struct ohci *ohci)\r\n{\r\nint i, events;\r\nfor (i = 0; i < 9; i++) {\r\nmdelay(200);\r\nevents = reg_read(ohci, OHCI1394_IntEventSet);\r\nif (events & OHCI1394_busReset)\r\nreg_write(ohci, OHCI1394_IntEventClear,\r\nOHCI1394_busReset);\r\n}\r\n}\r\nstatic inline void __init init_ohci1394_enable_physical_dma(struct ohci *ohci)\r\n{\r\nreg_write(ohci, OHCI1394_PhyReqFilterHiSet, 0xffffffff);\r\nreg_write(ohci, OHCI1394_PhyReqFilterLoSet, 0xffffffff);\r\nreg_write(ohci, OHCI1394_PhyUpperBound, 0xffff0000);\r\n}\r\nstatic inline void __init init_ohci1394_reset_and_init_dma(struct ohci *ohci)\r\n{\r\ninit_ohci1394_soft_reset(ohci);\r\nreg_write(ohci, OHCI1394_HCControlSet, OHCI1394_HCControl_LPS);\r\nreg_write(ohci, OHCI1394_IntEventClear, 0xffffffff);\r\nreg_write(ohci, OHCI1394_IntMaskClear, 0xffffffff);\r\nmdelay(50);\r\ninit_ohci1394_initialize(ohci);\r\ninit_ohci1394_wait_for_busresets(ohci);\r\ninit_ohci1394_enable_physical_dma(ohci);\r\n}\r\nstatic inline void __init init_ohci1394_controller(int num, int slot, int func)\r\n{\r\nunsigned long ohci_base;\r\nstruct ohci ohci;\r\nprintk(KERN_INFO "init_ohci1394_dma: initializing OHCI-1394"\r\n" at %02x:%02x.%x\n", num, slot, func);\r\nohci_base = read_pci_config(num, slot, func, PCI_BASE_ADDRESS_0+(0<<2))\r\n& PCI_BASE_ADDRESS_MEM_MASK;\r\nset_fixmap_nocache(FIX_OHCI1394_BASE, ohci_base);\r\nohci.registers = (void __iomem *)fix_to_virt(FIX_OHCI1394_BASE);\r\ninit_ohci1394_reset_and_init_dma(&ohci);\r\n}\r\nvoid __init init_ohci1394_dma_on_all_controllers(void)\r\n{\r\nint num, slot, func;\r\nu32 class;\r\nif (!early_pci_allowed())\r\nreturn;\r\nfor (num = 0; num < 32; num++) {\r\nfor (slot = 0; slot < 32; slot++) {\r\nfor (func = 0; func < 8; func++) {\r\nclass = read_pci_config(num, slot, func,\r\nPCI_CLASS_REVISION);\r\nif (class == 0xffffffff)\r\ncontinue;\r\nif (class>>8 != PCI_CLASS_SERIAL_FIREWIRE_OHCI)\r\ncontinue;\r\ninit_ohci1394_controller(num, slot, func);\r\nbreak;\r\n}\r\n}\r\n}\r\nprintk(KERN_INFO "init_ohci1394_dma: finished initializing OHCI DMA\n");\r\n}\r\nstatic int __init setup_ohci1394_dma(char *opt)\r\n{\r\nif (!strcmp(opt, "early"))\r\ninit_ohci1394_dma_early = 1;\r\nreturn 0;\r\n}

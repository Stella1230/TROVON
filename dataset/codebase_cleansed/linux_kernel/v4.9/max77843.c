static int max77843_chg_init(struct max77693_dev *max77843)\r\n{\r\nint ret;\r\nmax77843->i2c_chg = i2c_new_dummy(max77843->i2c->adapter, I2C_ADDR_CHG);\r\nif (!max77843->i2c_chg) {\r\ndev_err(&max77843->i2c->dev,\r\n"Cannot allocate I2C device for Charger\n");\r\nreturn -ENODEV;\r\n}\r\ni2c_set_clientdata(max77843->i2c_chg, max77843);\r\nmax77843->regmap_chg = devm_regmap_init_i2c(max77843->i2c_chg,\r\n&max77843_charger_regmap_config);\r\nif (IS_ERR(max77843->regmap_chg)) {\r\nret = PTR_ERR(max77843->regmap_chg);\r\ngoto err_chg_i2c;\r\n}\r\nreturn 0;\r\nerr_chg_i2c:\r\ni2c_unregister_device(max77843->i2c_chg);\r\nreturn ret;\r\n}\r\nstatic int max77843_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct max77693_dev *max77843;\r\nunsigned int reg_data;\r\nint ret;\r\nmax77843 = devm_kzalloc(&i2c->dev, sizeof(*max77843), GFP_KERNEL);\r\nif (!max77843)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(i2c, max77843);\r\nmax77843->dev = &i2c->dev;\r\nmax77843->i2c = i2c;\r\nmax77843->irq = i2c->irq;\r\nmax77843->type = id->driver_data;\r\nmax77843->regmap = devm_regmap_init_i2c(i2c,\r\n&max77843_regmap_config);\r\nif (IS_ERR(max77843->regmap)) {\r\ndev_err(&i2c->dev, "Failed to allocate topsys register map\n");\r\nreturn PTR_ERR(max77843->regmap);\r\n}\r\nret = regmap_add_irq_chip(max77843->regmap, max77843->irq,\r\nIRQF_TRIGGER_LOW | IRQF_ONESHOT | IRQF_SHARED,\r\n0, &max77843_irq_chip, &max77843->irq_data_topsys);\r\nif (ret) {\r\ndev_err(&i2c->dev, "Failed to add TOPSYS IRQ chip\n");\r\nreturn ret;\r\n}\r\nret = regmap_read(max77843->regmap,\r\nMAX77843_SYS_REG_PMICID, &reg_data);\r\nif (ret < 0) {\r\ndev_err(&i2c->dev, "Failed to read PMIC ID\n");\r\ngoto err_pmic_id;\r\n}\r\ndev_info(&i2c->dev, "device ID: 0x%x\n", reg_data);\r\nret = max77843_chg_init(max77843);\r\nif (ret) {\r\ndev_err(&i2c->dev, "Failed to init Charger\n");\r\ngoto err_pmic_id;\r\n}\r\nret = regmap_update_bits(max77843->regmap,\r\nMAX77843_SYS_REG_INTSRCMASK,\r\nMAX77843_INTSRC_MASK_MASK,\r\n(unsigned int)~MAX77843_INTSRC_MASK_MASK);\r\nif (ret < 0) {\r\ndev_err(&i2c->dev, "Failed to unmask interrupt source\n");\r\ngoto err_pmic_id;\r\n}\r\nret = mfd_add_devices(max77843->dev, -1, max77843_devs,\r\nARRAY_SIZE(max77843_devs), NULL, 0, NULL);\r\nif (ret < 0) {\r\ndev_err(&i2c->dev, "Failed to add mfd device\n");\r\ngoto err_pmic_id;\r\n}\r\ndevice_init_wakeup(max77843->dev, true);\r\nreturn 0;\r\nerr_pmic_id:\r\nregmap_del_irq_chip(max77843->irq, max77843->irq_data_topsys);\r\nreturn ret;\r\n}\r\nstatic int __maybe_unused max77843_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct max77693_dev *max77843 = i2c_get_clientdata(i2c);\r\ndisable_irq(max77843->irq);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(max77843->irq);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused max77843_resume(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct max77693_dev *max77843 = i2c_get_clientdata(i2c);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(max77843->irq);\r\nenable_irq(max77843->irq);\r\nreturn 0;\r\n}\r\nstatic int __init max77843_i2c_init(void)\r\n{\r\nreturn i2c_add_driver(&max77843_i2c_driver);\r\n}

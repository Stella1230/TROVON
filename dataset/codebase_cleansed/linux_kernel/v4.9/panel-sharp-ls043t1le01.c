static inline struct sharp_nt_panel *to_sharp_nt_panel(struct drm_panel *panel)\r\n{\r\nreturn container_of(panel, struct sharp_nt_panel, base);\r\n}\r\nstatic int sharp_nt_panel_init(struct sharp_nt_panel *sharp_nt)\r\n{\r\nstruct mipi_dsi_device *dsi = sharp_nt->dsi;\r\nint ret;\r\ndsi->mode_flags |= MIPI_DSI_MODE_LPM;\r\nret = mipi_dsi_dcs_exit_sleep_mode(dsi);\r\nif (ret < 0)\r\nreturn ret;\r\nmsleep(120);\r\nret = mipi_dsi_dcs_write(dsi, 0xae, (u8[]){ 0x03 }, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nret = mipi_dsi_dcs_set_pixel_format(dsi, MIPI_DCS_PIXEL_FMT_24BIT |\r\n(MIPI_DCS_PIXEL_FMT_24BIT << 4));\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int sharp_nt_panel_on(struct sharp_nt_panel *sharp_nt)\r\n{\r\nstruct mipi_dsi_device *dsi = sharp_nt->dsi;\r\nint ret;\r\ndsi->mode_flags |= MIPI_DSI_MODE_LPM;\r\nret = mipi_dsi_dcs_set_display_on(dsi);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int sharp_nt_panel_off(struct sharp_nt_panel *sharp_nt)\r\n{\r\nstruct mipi_dsi_device *dsi = sharp_nt->dsi;\r\nint ret;\r\ndsi->mode_flags &= ~MIPI_DSI_MODE_LPM;\r\nret = mipi_dsi_dcs_set_display_off(dsi);\r\nif (ret < 0)\r\nreturn ret;\r\nret = mipi_dsi_dcs_enter_sleep_mode(dsi);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int sharp_nt_panel_disable(struct drm_panel *panel)\r\n{\r\nstruct sharp_nt_panel *sharp_nt = to_sharp_nt_panel(panel);\r\nif (!sharp_nt->enabled)\r\nreturn 0;\r\nif (sharp_nt->backlight) {\r\nsharp_nt->backlight->props.power = FB_BLANK_POWERDOWN;\r\nbacklight_update_status(sharp_nt->backlight);\r\n}\r\nsharp_nt->enabled = false;\r\nreturn 0;\r\n}\r\nstatic int sharp_nt_panel_unprepare(struct drm_panel *panel)\r\n{\r\nstruct sharp_nt_panel *sharp_nt = to_sharp_nt_panel(panel);\r\nint ret;\r\nif (!sharp_nt->prepared)\r\nreturn 0;\r\nret = sharp_nt_panel_off(sharp_nt);\r\nif (ret < 0) {\r\ndev_err(panel->dev, "failed to set panel off: %d\n", ret);\r\nreturn ret;\r\n}\r\nregulator_disable(sharp_nt->supply);\r\nif (sharp_nt->reset_gpio)\r\ngpiod_set_value(sharp_nt->reset_gpio, 0);\r\nsharp_nt->prepared = false;\r\nreturn 0;\r\n}\r\nstatic int sharp_nt_panel_prepare(struct drm_panel *panel)\r\n{\r\nstruct sharp_nt_panel *sharp_nt = to_sharp_nt_panel(panel);\r\nint ret;\r\nif (sharp_nt->prepared)\r\nreturn 0;\r\nret = regulator_enable(sharp_nt->supply);\r\nif (ret < 0)\r\nreturn ret;\r\nmsleep(20);\r\nif (sharp_nt->reset_gpio) {\r\ngpiod_set_value(sharp_nt->reset_gpio, 1);\r\nmsleep(1);\r\ngpiod_set_value(sharp_nt->reset_gpio, 0);\r\nmsleep(1);\r\ngpiod_set_value(sharp_nt->reset_gpio, 1);\r\nmsleep(10);\r\n}\r\nret = sharp_nt_panel_init(sharp_nt);\r\nif (ret < 0) {\r\ndev_err(panel->dev, "failed to init panel: %d\n", ret);\r\ngoto poweroff;\r\n}\r\nret = sharp_nt_panel_on(sharp_nt);\r\nif (ret < 0) {\r\ndev_err(panel->dev, "failed to set panel on: %d\n", ret);\r\ngoto poweroff;\r\n}\r\nsharp_nt->prepared = true;\r\nreturn 0;\r\npoweroff:\r\nregulator_disable(sharp_nt->supply);\r\nif (sharp_nt->reset_gpio)\r\ngpiod_set_value(sharp_nt->reset_gpio, 0);\r\nreturn ret;\r\n}\r\nstatic int sharp_nt_panel_enable(struct drm_panel *panel)\r\n{\r\nstruct sharp_nt_panel *sharp_nt = to_sharp_nt_panel(panel);\r\nif (sharp_nt->enabled)\r\nreturn 0;\r\nif (sharp_nt->backlight) {\r\nsharp_nt->backlight->props.power = FB_BLANK_UNBLANK;\r\nbacklight_update_status(sharp_nt->backlight);\r\n}\r\nsharp_nt->enabled = true;\r\nreturn 0;\r\n}\r\nstatic int sharp_nt_panel_get_modes(struct drm_panel *panel)\r\n{\r\nstruct drm_display_mode *mode;\r\nmode = drm_mode_duplicate(panel->drm, &default_mode);\r\nif (!mode) {\r\ndev_err(panel->drm->dev, "failed to add mode %ux%ux@%u\n",\r\ndefault_mode.hdisplay, default_mode.vdisplay,\r\ndefault_mode.vrefresh);\r\nreturn -ENOMEM;\r\n}\r\ndrm_mode_set_name(mode);\r\ndrm_mode_probed_add(panel->connector, mode);\r\npanel->connector->display_info.width_mm = 54;\r\npanel->connector->display_info.height_mm = 95;\r\nreturn 1;\r\n}\r\nstatic int sharp_nt_panel_add(struct sharp_nt_panel *sharp_nt)\r\n{\r\nstruct device *dev = &sharp_nt->dsi->dev;\r\nstruct device_node *np;\r\nint ret;\r\nsharp_nt->mode = &default_mode;\r\nsharp_nt->supply = devm_regulator_get(dev, "avdd");\r\nif (IS_ERR(sharp_nt->supply))\r\nreturn PTR_ERR(sharp_nt->supply);\r\nsharp_nt->reset_gpio = devm_gpiod_get(dev, "reset", GPIOD_OUT_LOW);\r\nif (IS_ERR(sharp_nt->reset_gpio)) {\r\ndev_err(dev, "cannot get reset-gpios %ld\n",\r\nPTR_ERR(sharp_nt->reset_gpio));\r\nsharp_nt->reset_gpio = NULL;\r\n} else {\r\ngpiod_set_value(sharp_nt->reset_gpio, 0);\r\n}\r\nnp = of_parse_phandle(dev->of_node, "backlight", 0);\r\nif (np) {\r\nsharp_nt->backlight = of_find_backlight_by_node(np);\r\nof_node_put(np);\r\nif (!sharp_nt->backlight)\r\nreturn -EPROBE_DEFER;\r\n}\r\ndrm_panel_init(&sharp_nt->base);\r\nsharp_nt->base.funcs = &sharp_nt_panel_funcs;\r\nsharp_nt->base.dev = &sharp_nt->dsi->dev;\r\nret = drm_panel_add(&sharp_nt->base);\r\nif (ret < 0)\r\ngoto put_backlight;\r\nreturn 0;\r\nput_backlight:\r\nif (sharp_nt->backlight)\r\nput_device(&sharp_nt->backlight->dev);\r\nreturn ret;\r\n}\r\nstatic void sharp_nt_panel_del(struct sharp_nt_panel *sharp_nt)\r\n{\r\nif (sharp_nt->base.dev)\r\ndrm_panel_remove(&sharp_nt->base);\r\nif (sharp_nt->backlight)\r\nput_device(&sharp_nt->backlight->dev);\r\n}\r\nstatic int sharp_nt_panel_probe(struct mipi_dsi_device *dsi)\r\n{\r\nstruct sharp_nt_panel *sharp_nt;\r\nint ret;\r\ndsi->lanes = 2;\r\ndsi->format = MIPI_DSI_FMT_RGB888;\r\ndsi->mode_flags = MIPI_DSI_MODE_VIDEO |\r\nMIPI_DSI_MODE_VIDEO_HSE |\r\nMIPI_DSI_CLOCK_NON_CONTINUOUS |\r\nMIPI_DSI_MODE_EOT_PACKET;\r\nsharp_nt = devm_kzalloc(&dsi->dev, sizeof(*sharp_nt), GFP_KERNEL);\r\nif (!sharp_nt)\r\nreturn -ENOMEM;\r\nmipi_dsi_set_drvdata(dsi, sharp_nt);\r\nsharp_nt->dsi = dsi;\r\nret = sharp_nt_panel_add(sharp_nt);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn mipi_dsi_attach(dsi);\r\n}\r\nstatic int sharp_nt_panel_remove(struct mipi_dsi_device *dsi)\r\n{\r\nstruct sharp_nt_panel *sharp_nt = mipi_dsi_get_drvdata(dsi);\r\nint ret;\r\nret = sharp_nt_panel_disable(&sharp_nt->base);\r\nif (ret < 0)\r\ndev_err(&dsi->dev, "failed to disable panel: %d\n", ret);\r\nret = mipi_dsi_detach(dsi);\r\nif (ret < 0)\r\ndev_err(&dsi->dev, "failed to detach from DSI host: %d\n", ret);\r\ndrm_panel_detach(&sharp_nt->base);\r\nsharp_nt_panel_del(sharp_nt);\r\nreturn 0;\r\n}\r\nstatic void sharp_nt_panel_shutdown(struct mipi_dsi_device *dsi)\r\n{\r\nstruct sharp_nt_panel *sharp_nt = mipi_dsi_get_drvdata(dsi);\r\nsharp_nt_panel_disable(&sharp_nt->base);\r\n}

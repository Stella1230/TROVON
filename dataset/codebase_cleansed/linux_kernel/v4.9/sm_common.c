static int oob_sm_ooblayout_ecc(struct mtd_info *mtd, int section,\r\nstruct mtd_oob_region *oobregion)\r\n{\r\nif (section > 1)\r\nreturn -ERANGE;\r\noobregion->length = 3;\r\noobregion->offset = ((section + 1) * 8) - 3;\r\nreturn 0;\r\n}\r\nstatic int oob_sm_ooblayout_free(struct mtd_info *mtd, int section,\r\nstruct mtd_oob_region *oobregion)\r\n{\r\nswitch (section) {\r\ncase 0:\r\noobregion->offset = 0;\r\noobregion->length = 4;\r\nbreak;\r\ncase 1:\r\noobregion->offset = 6;\r\noobregion->length = 2;\r\nbreak;\r\ncase 2:\r\noobregion->offset = 11;\r\noobregion->length = 2;\r\nbreak;\r\ndefault:\r\nreturn -ERANGE;\r\n}\r\nreturn 0;\r\n}\r\nstatic int oob_sm_small_ooblayout_ecc(struct mtd_info *mtd, int section,\r\nstruct mtd_oob_region *oobregion)\r\n{\r\nif (section)\r\nreturn -ERANGE;\r\noobregion->length = 3;\r\noobregion->offset = 0;\r\nreturn 0;\r\n}\r\nstatic int oob_sm_small_ooblayout_free(struct mtd_info *mtd, int section,\r\nstruct mtd_oob_region *oobregion)\r\n{\r\nswitch (section) {\r\ncase 0:\r\noobregion->offset = 3;\r\noobregion->length = 2;\r\nbreak;\r\ncase 1:\r\noobregion->offset = 6;\r\noobregion->length = 2;\r\nbreak;\r\ndefault:\r\nreturn -ERANGE;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sm_block_markbad(struct mtd_info *mtd, loff_t ofs)\r\n{\r\nstruct mtd_oob_ops ops;\r\nstruct sm_oob oob;\r\nint ret;\r\nmemset(&oob, -1, SM_OOB_SIZE);\r\noob.block_status = 0x0F;\r\nops.mode = MTD_OPS_PLACE_OOB;\r\nops.ooboffs = 0;\r\nops.ooblen = mtd->oobsize;\r\nops.oobbuf = (void *)&oob;\r\nops.datbuf = NULL;\r\nret = mtd_write_oob(mtd, ofs, &ops);\r\nif (ret < 0 || ops.oobretlen != SM_OOB_SIZE) {\r\nprintk(KERN_NOTICE\r\n"sm_common: can't mark sector at %i as bad\n",\r\n(int)ofs);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nint sm_register_device(struct mtd_info *mtd, int smartmedia)\r\n{\r\nstruct nand_chip *chip = mtd_to_nand(mtd);\r\nint ret;\r\nchip->options |= NAND_SKIP_BBTSCAN;\r\nret = nand_scan_ident(mtd, 1, smartmedia ?\r\nnand_smartmedia_flash_ids : nand_xd_flash_ids);\r\nif (ret)\r\nreturn ret;\r\nchip->badblockpos = 0x05;\r\nchip->badblockbits = 7;\r\nchip->block_markbad = sm_block_markbad;\r\nif (mtd->writesize == SM_SECTOR_SIZE)\r\nmtd_set_ooblayout(mtd, &oob_sm_ops);\r\nelse if (mtd->writesize == SM_SMALL_PAGE)\r\nmtd_set_ooblayout(mtd, &oob_sm_small_ops);\r\nelse\r\nreturn -ENODEV;\r\nret = nand_scan_tail(mtd);\r\nif (ret)\r\nreturn ret;\r\nreturn mtd_device_register(mtd, NULL, 0);\r\n}

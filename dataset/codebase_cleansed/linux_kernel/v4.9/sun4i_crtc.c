static void sun4i_crtc_atomic_begin(struct drm_crtc *crtc,\r\nstruct drm_crtc_state *old_state)\r\n{\r\nstruct sun4i_crtc *scrtc = drm_crtc_to_sun4i_crtc(crtc);\r\nstruct drm_device *dev = crtc->dev;\r\nunsigned long flags;\r\nif (crtc->state->event) {\r\nWARN_ON(drm_crtc_vblank_get(crtc) != 0);\r\nspin_lock_irqsave(&dev->event_lock, flags);\r\nscrtc->event = crtc->state->event;\r\nspin_unlock_irqrestore(&dev->event_lock, flags);\r\ncrtc->state->event = NULL;\r\n}\r\n}\r\nstatic void sun4i_crtc_atomic_flush(struct drm_crtc *crtc,\r\nstruct drm_crtc_state *old_state)\r\n{\r\nstruct sun4i_crtc *scrtc = drm_crtc_to_sun4i_crtc(crtc);\r\nstruct sun4i_drv *drv = scrtc->drv;\r\nstruct drm_pending_vblank_event *event = crtc->state->event;\r\nDRM_DEBUG_DRIVER("Committing plane changes\n");\r\nsun4i_backend_commit(drv->backend);\r\nif (event) {\r\ncrtc->state->event = NULL;\r\nspin_lock_irq(&crtc->dev->event_lock);\r\nif (drm_crtc_vblank_get(crtc) == 0)\r\ndrm_crtc_arm_vblank_event(crtc, event);\r\nelse\r\ndrm_crtc_send_vblank_event(crtc, event);\r\nspin_unlock_irq(&crtc->dev->event_lock);\r\n}\r\n}\r\nstatic void sun4i_crtc_disable(struct drm_crtc *crtc)\r\n{\r\nstruct sun4i_crtc *scrtc = drm_crtc_to_sun4i_crtc(crtc);\r\nstruct sun4i_drv *drv = scrtc->drv;\r\nDRM_DEBUG_DRIVER("Disabling the CRTC\n");\r\nsun4i_tcon_disable(drv->tcon);\r\nif (crtc->state->event && !crtc->state->active) {\r\nspin_lock_irq(&crtc->dev->event_lock);\r\ndrm_crtc_send_vblank_event(crtc, crtc->state->event);\r\nspin_unlock_irq(&crtc->dev->event_lock);\r\ncrtc->state->event = NULL;\r\n}\r\n}\r\nstatic void sun4i_crtc_enable(struct drm_crtc *crtc)\r\n{\r\nstruct sun4i_crtc *scrtc = drm_crtc_to_sun4i_crtc(crtc);\r\nstruct sun4i_drv *drv = scrtc->drv;\r\nDRM_DEBUG_DRIVER("Enabling the CRTC\n");\r\nsun4i_tcon_enable(drv->tcon);\r\n}\r\nstruct sun4i_crtc *sun4i_crtc_init(struct drm_device *drm)\r\n{\r\nstruct sun4i_drv *drv = drm->dev_private;\r\nstruct sun4i_crtc *scrtc;\r\nint ret;\r\nscrtc = devm_kzalloc(drm->dev, sizeof(*scrtc), GFP_KERNEL);\r\nif (!scrtc)\r\nreturn NULL;\r\nscrtc->drv = drv;\r\nret = drm_crtc_init_with_planes(drm, &scrtc->crtc,\r\ndrv->primary,\r\nNULL,\r\n&sun4i_crtc_funcs,\r\nNULL);\r\nif (ret) {\r\ndev_err(drm->dev, "Couldn't init DRM CRTC\n");\r\nreturn NULL;\r\n}\r\ndrm_crtc_helper_add(&scrtc->crtc, &sun4i_crtc_helper_funcs);\r\nreturn scrtc;\r\n}

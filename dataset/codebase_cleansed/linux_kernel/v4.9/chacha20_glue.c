static void chacha20_dosimd(u32 *state, u8 *dst, const u8 *src,\r\nunsigned int bytes)\r\n{\r\nu8 buf[CHACHA20_BLOCK_SIZE];\r\n#ifdef CONFIG_AS_AVX2\r\nif (chacha20_use_avx2) {\r\nwhile (bytes >= CHACHA20_BLOCK_SIZE * 8) {\r\nchacha20_8block_xor_avx2(state, dst, src);\r\nbytes -= CHACHA20_BLOCK_SIZE * 8;\r\nsrc += CHACHA20_BLOCK_SIZE * 8;\r\ndst += CHACHA20_BLOCK_SIZE * 8;\r\nstate[12] += 8;\r\n}\r\n}\r\n#endif\r\nwhile (bytes >= CHACHA20_BLOCK_SIZE * 4) {\r\nchacha20_4block_xor_ssse3(state, dst, src);\r\nbytes -= CHACHA20_BLOCK_SIZE * 4;\r\nsrc += CHACHA20_BLOCK_SIZE * 4;\r\ndst += CHACHA20_BLOCK_SIZE * 4;\r\nstate[12] += 4;\r\n}\r\nwhile (bytes >= CHACHA20_BLOCK_SIZE) {\r\nchacha20_block_xor_ssse3(state, dst, src);\r\nbytes -= CHACHA20_BLOCK_SIZE;\r\nsrc += CHACHA20_BLOCK_SIZE;\r\ndst += CHACHA20_BLOCK_SIZE;\r\nstate[12]++;\r\n}\r\nif (bytes) {\r\nmemcpy(buf, src, bytes);\r\nchacha20_block_xor_ssse3(state, buf, buf);\r\nmemcpy(dst, buf, bytes);\r\n}\r\n}\r\nstatic int chacha20_simd(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nu32 *state, state_buf[16 + (CHACHA20_STATE_ALIGN / sizeof(u32)) - 1];\r\nstruct blkcipher_walk walk;\r\nint err;\r\nif (nbytes <= CHACHA20_BLOCK_SIZE || !may_use_simd())\r\nreturn crypto_chacha20_crypt(desc, dst, src, nbytes);\r\nstate = (u32 *)roundup((uintptr_t)state_buf, CHACHA20_STATE_ALIGN);\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nerr = blkcipher_walk_virt_block(desc, &walk, CHACHA20_BLOCK_SIZE);\r\ncrypto_chacha20_init(state, crypto_blkcipher_ctx(desc->tfm), walk.iv);\r\nkernel_fpu_begin();\r\nwhile (walk.nbytes >= CHACHA20_BLOCK_SIZE) {\r\nchacha20_dosimd(state, walk.dst.virt.addr, walk.src.virt.addr,\r\nrounddown(walk.nbytes, CHACHA20_BLOCK_SIZE));\r\nerr = blkcipher_walk_done(desc, &walk,\r\nwalk.nbytes % CHACHA20_BLOCK_SIZE);\r\n}\r\nif (walk.nbytes) {\r\nchacha20_dosimd(state, walk.dst.virt.addr, walk.src.virt.addr,\r\nwalk.nbytes);\r\nerr = blkcipher_walk_done(desc, &walk, 0);\r\n}\r\nkernel_fpu_end();\r\nreturn err;\r\n}\r\nstatic int __init chacha20_simd_mod_init(void)\r\n{\r\nif (!boot_cpu_has(X86_FEATURE_SSSE3))\r\nreturn -ENODEV;\r\n#ifdef CONFIG_AS_AVX2\r\nchacha20_use_avx2 = boot_cpu_has(X86_FEATURE_AVX) &&\r\nboot_cpu_has(X86_FEATURE_AVX2) &&\r\ncpu_has_xfeatures(XFEATURE_MASK_SSE | XFEATURE_MASK_YMM, NULL);\r\n#endif\r\nreturn crypto_register_alg(&alg);\r\n}\r\nstatic void __exit chacha20_simd_mod_fini(void)\r\n{\r\ncrypto_unregister_alg(&alg);\r\n}

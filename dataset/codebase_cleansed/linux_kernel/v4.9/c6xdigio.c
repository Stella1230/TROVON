static int c6xdigio_chk_status(struct comedi_device *dev, unsigned long context)\r\n{\r\nunsigned int status;\r\nint timeout = 0;\r\ndo {\r\nstatus = inb(dev->iobase + C6XDIGIO_STATUS_REG);\r\nif ((status & 0x80) != context)\r\nreturn 0;\r\ntimeout++;\r\n} while (timeout < C6XDIGIO_TIME_OUT);\r\nreturn -EBUSY;\r\n}\r\nstatic int c6xdigio_write_data(struct comedi_device *dev,\r\nunsigned int val, unsigned int status)\r\n{\r\noutb_p(val, dev->iobase + C6XDIGIO_DATA_REG);\r\nreturn c6xdigio_chk_status(dev, status);\r\n}\r\nstatic int c6xdigio_get_encoder_bits(struct comedi_device *dev,\r\nunsigned int *bits,\r\nunsigned int cmd,\r\nunsigned int status)\r\n{\r\nunsigned int val;\r\nval = inb(dev->iobase + C6XDIGIO_STATUS_REG);\r\nval >>= 3;\r\nval &= 0x07;\r\n*bits = val;\r\nreturn c6xdigio_write_data(dev, cmd, status);\r\n}\r\nstatic void c6xdigio_pwm_write(struct comedi_device *dev,\r\nunsigned int chan, unsigned int val)\r\n{\r\nunsigned int cmd = C6XDIGIO_DATA_PWM | C6XDIGIO_DATA_CHAN(chan);\r\nunsigned int bits;\r\nif (val > 498)\r\nval = 498;\r\nif (val < 2)\r\nval = 2;\r\nbits = (val >> 0) & 0x03;\r\nc6xdigio_write_data(dev, cmd | bits | (0 << 2), 0x00);\r\nbits = (val >> 2) & 0x03;\r\nc6xdigio_write_data(dev, cmd | bits | (1 << 2), 0x80);\r\nbits = (val >> 4) & 0x03;\r\nc6xdigio_write_data(dev, cmd | bits | (0 << 2), 0x00);\r\nbits = (val >> 6) & 0x03;\r\nc6xdigio_write_data(dev, cmd | bits | (1 << 2), 0x80);\r\nbits = (val >> 8) & 0x03;\r\nc6xdigio_write_data(dev, cmd | bits | (0 << 2), 0x00);\r\nc6xdigio_write_data(dev, 0x00, 0x80);\r\n}\r\nstatic int c6xdigio_encoder_read(struct comedi_device *dev,\r\nunsigned int chan)\r\n{\r\nunsigned int cmd = C6XDIGIO_DATA_ENCODER | C6XDIGIO_DATA_CHAN(chan);\r\nunsigned int val = 0;\r\nunsigned int bits;\r\nc6xdigio_write_data(dev, cmd, 0x00);\r\nc6xdigio_get_encoder_bits(dev, &bits, cmd | (1 << 2), 0x80);\r\nval |= (bits << 0);\r\nc6xdigio_get_encoder_bits(dev, &bits, cmd | (0 << 2), 0x00);\r\nval |= (bits << 3);\r\nc6xdigio_get_encoder_bits(dev, &bits, cmd | (1 << 2), 0x80);\r\nval |= (bits << 6);\r\nc6xdigio_get_encoder_bits(dev, &bits, cmd | (0 << 2), 0x00);\r\nval |= (bits << 9);\r\nc6xdigio_get_encoder_bits(dev, &bits, cmd | (1 << 2), 0x80);\r\nval |= (bits << 12);\r\nc6xdigio_get_encoder_bits(dev, &bits, cmd | (0 << 2), 0x00);\r\nval |= (bits << 15);\r\nc6xdigio_get_encoder_bits(dev, &bits, cmd | (1 << 2), 0x80);\r\nval |= (bits << 18);\r\nc6xdigio_get_encoder_bits(dev, &bits, cmd | (0 << 2), 0x00);\r\nval |= (bits << 21);\r\nc6xdigio_write_data(dev, 0x00, 0x80);\r\nreturn val;\r\n}\r\nstatic int c6xdigio_pwm_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int val = (s->state >> (16 * chan)) & 0xffff;\r\nint i;\r\nfor (i = 0; i < insn->n; i++) {\r\nval = data[i];\r\nc6xdigio_pwm_write(dev, chan, val);\r\n}\r\ns->state &= (0xffff << (16 * chan));\r\ns->state |= (val << (16 * chan));\r\nreturn insn->n;\r\n}\r\nstatic int c6xdigio_pwm_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int val;\r\nint i;\r\nval = (s->state >> (16 * chan)) & 0xffff;\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = val;\r\nreturn insn->n;\r\n}\r\nstatic int c6xdigio_encoder_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int val;\r\nint i;\r\nfor (i = 0; i < insn->n; i++) {\r\nval = c6xdigio_encoder_read(dev, chan);\r\ndata[i] = comedi_offset_munge(s, val);\r\n}\r\nreturn insn->n;\r\n}\r\nstatic void c6xdigio_init(struct comedi_device *dev)\r\n{\r\nc6xdigio_write_data(dev, 0x70, 0x00);\r\nc6xdigio_write_data(dev, 0x74, 0x80);\r\nc6xdigio_write_data(dev, 0x70, 0x00);\r\nc6xdigio_write_data(dev, 0x00, 0x80);\r\nc6xdigio_write_data(dev, 0x68, 0x00);\r\nc6xdigio_write_data(dev, 0x6c, 0x80);\r\nc6xdigio_write_data(dev, 0x68, 0x00);\r\nc6xdigio_write_data(dev, 0x00, 0x80);\r\n}\r\nstatic int c6xdigio_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nint ret;\r\nret = comedi_request_region(dev, it->options[0], 0x03);\r\nif (ret)\r\nreturn ret;\r\nret = comedi_alloc_subdevices(dev, 2);\r\nif (ret)\r\nreturn ret;\r\npnp_register_driver(&c6xdigio_pnp_driver);\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_PWM;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = 2;\r\ns->maxdata = 500;\r\ns->range_table = &range_unknown;\r\ns->insn_write = c6xdigio_pwm_insn_write;\r\ns->insn_read = c6xdigio_pwm_insn_read;\r\ns = &dev->subdevices[1];\r\ns->type = COMEDI_SUBD_COUNTER;\r\ns->subdev_flags = SDF_READABLE | SDF_LSAMPL;\r\ns->n_chan = 2;\r\ns->maxdata = 0xffffff;\r\ns->range_table = &range_unknown;\r\ns->insn_read = c6xdigio_encoder_insn_read;\r\nc6xdigio_init(dev);\r\nreturn 0;\r\n}\r\nstatic void c6xdigio_detach(struct comedi_device *dev)\r\n{\r\ncomedi_legacy_detach(dev);\r\npnp_unregister_driver(&c6xdigio_pnp_driver);\r\n}

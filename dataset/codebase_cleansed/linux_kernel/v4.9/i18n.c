char *spk_msg_get(enum msg_index_t index)\r\n{\r\nreturn speakup_msgs[index];\r\n}\r\nstatic char *next_specifier(char *input)\r\n{\r\nint found = 0;\r\nchar *next_percent = input;\r\nwhile ((next_percent != NULL) && !found) {\r\nnext_percent = strchr(next_percent, '%');\r\nif (next_percent != NULL) {\r\nwhile ((next_percent[0] == '%')\r\n&& (next_percent[1] == '%'))\r\nnext_percent += 2;\r\nif (*next_percent == '%')\r\nfound = 1;\r\nelse if (*next_percent == '\0')\r\nnext_percent = NULL;\r\n}\r\n}\r\nreturn next_percent;\r\n}\r\nstatic char *skip_flags(char *input)\r\n{\r\nwhile ((*input != '\0') && strchr(" 0+-#", *input))\r\ninput++;\r\nreturn input;\r\n}\r\nstatic char *skip_width(char *input)\r\n{\r\nwhile (isdigit(*input))\r\ninput++;\r\nif (*input == '.') {\r\ninput++;\r\nwhile (isdigit(*input))\r\ninput++;\r\n}\r\nreturn input;\r\n}\r\nstatic char *skip_conversion(char *input)\r\n{\r\nif ((input[0] == 'l') && (input[1] == 'd'))\r\ninput += 2;\r\nelse if ((*input != '\0') && strchr("cdsx", *input))\r\ninput++;\r\nreturn input;\r\n}\r\nstatic char *find_specifier_end(char *input)\r\n{\r\ninput++;\r\ninput = skip_flags(input);\r\ninput = skip_width(input);\r\ninput = skip_conversion(input);\r\nreturn input;\r\n}\r\nstatic int compare_specifiers(char **input1, char **input2)\r\n{\r\nint same = 0;\r\nchar *end1 = find_specifier_end(*input1);\r\nchar *end2 = find_specifier_end(*input2);\r\nsize_t length1 = end1 - *input1;\r\nsize_t length2 = end2 - *input2;\r\nif ((length1 == length2) && !memcmp(*input1, *input2, length1))\r\nsame = 1;\r\n*input1 = end1;\r\n*input2 = end2;\r\nreturn same;\r\n}\r\nstatic int fmt_validate(char *template, char *user)\r\n{\r\nint valid = 1;\r\nint still_comparing = 1;\r\nchar *template_ptr = template;\r\nchar *user_ptr = user;\r\nwhile (still_comparing && valid) {\r\ntemplate_ptr = next_specifier(template_ptr);\r\nuser_ptr = next_specifier(user_ptr);\r\nif (template_ptr && user_ptr) {\r\nvalid = compare_specifiers(&template_ptr, &user_ptr);\r\n} else {\r\nstill_comparing = 0;\r\nif (template_ptr || user_ptr)\r\nvalid = 0;\r\n}\r\n}\r\nreturn valid;\r\n}\r\nssize_t spk_msg_set(enum msg_index_t index, char *text, size_t length)\r\n{\r\nint rc = 0;\r\nchar *newstr = NULL;\r\nunsigned long flags;\r\nif ((index >= MSG_FIRST_INDEX) && (index < MSG_LAST_INDEX)) {\r\nnewstr = kmalloc(length + 1, GFP_KERNEL);\r\nif (newstr) {\r\nmemcpy(newstr, text, length);\r\nnewstr[length] = '\0';\r\nif ((index >= MSG_FORMATTED_START\r\n&& index <= MSG_FORMATTED_END)\r\n&& !fmt_validate(speakup_default_msgs[index],\r\nnewstr)) {\r\nkfree(newstr);\r\nreturn -EINVAL;\r\n}\r\nspin_lock_irqsave(&speakup_info.spinlock, flags);\r\nif (speakup_msgs[index] != speakup_default_msgs[index])\r\nkfree(speakup_msgs[index]);\r\nspeakup_msgs[index] = newstr;\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\n} else {\r\nrc = -ENOMEM;\r\n}\r\n} else {\r\nrc = -EINVAL;\r\n}\r\nreturn rc;\r\n}\r\nstruct msg_group_t *spk_find_msg_group(const char *group_name)\r\n{\r\nstruct msg_group_t *group = NULL;\r\nint i;\r\nfor (i = 0; i < num_groups; i++) {\r\nif (!strcmp(all_groups[i].name, group_name)) {\r\ngroup = &all_groups[i];\r\nbreak;\r\n}\r\n}\r\nreturn group;\r\n}\r\nvoid spk_reset_msg_group(struct msg_group_t *group)\r\n{\r\nunsigned long flags;\r\nenum msg_index_t i;\r\nspin_lock_irqsave(&speakup_info.spinlock, flags);\r\nfor (i = group->start; i <= group->end; i++) {\r\nif (speakup_msgs[i] != speakup_default_msgs[i])\r\nkfree(speakup_msgs[i]);\r\nspeakup_msgs[i] = speakup_default_msgs[i];\r\n}\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\n}\r\nvoid spk_initialize_msgs(void)\r\n{\r\nmemcpy(speakup_msgs, speakup_default_msgs,\r\nsizeof(speakup_default_msgs));\r\n}\r\nvoid spk_free_user_msgs(void)\r\n{\r\nenum msg_index_t index;\r\nunsigned long flags;\r\nspin_lock_irqsave(&speakup_info.spinlock, flags);\r\nfor (index = MSG_FIRST_INDEX; index < MSG_LAST_INDEX; index++) {\r\nif (speakup_msgs[index] != speakup_default_msgs[index]) {\r\nkfree(speakup_msgs[index]);\r\nspeakup_msgs[index] = speakup_default_msgs[index];\r\n}\r\n}\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\n}

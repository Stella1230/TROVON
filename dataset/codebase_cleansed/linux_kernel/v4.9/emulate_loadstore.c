int kvmppc_emulate_loadstore(struct kvm_vcpu *vcpu)\r\n{\r\nstruct kvm_run *run = vcpu->run;\r\nu32 inst;\r\nint ra, rs, rt;\r\nenum emulation_result emulated;\r\nint advance = 1;\r\nkvmppc_set_exit_type(vcpu, EMULATED_INST_EXITS);\r\nemulated = kvmppc_get_last_inst(vcpu, INST_GENERIC, &inst);\r\nif (emulated != EMULATE_DONE)\r\nreturn emulated;\r\nra = get_ra(inst);\r\nrs = get_rs(inst);\r\nrt = get_rt(inst);\r\nswitch (get_op(inst)) {\r\ncase 31:\r\nswitch (get_xop(inst)) {\r\ncase OP_31_XOP_LWZX:\r\nemulated = kvmppc_handle_load(run, vcpu, rt, 4, 1);\r\nbreak;\r\ncase OP_31_XOP_LBZX:\r\nemulated = kvmppc_handle_load(run, vcpu, rt, 1, 1);\r\nbreak;\r\ncase OP_31_XOP_LBZUX:\r\nemulated = kvmppc_handle_load(run, vcpu, rt, 1, 1);\r\nkvmppc_set_gpr(vcpu, ra, vcpu->arch.vaddr_accessed);\r\nbreak;\r\ncase OP_31_XOP_STWX:\r\nemulated = kvmppc_handle_store(run, vcpu,\r\nkvmppc_get_gpr(vcpu, rs),\r\n4, 1);\r\nbreak;\r\ncase OP_31_XOP_STBX:\r\nemulated = kvmppc_handle_store(run, vcpu,\r\nkvmppc_get_gpr(vcpu, rs),\r\n1, 1);\r\nbreak;\r\ncase OP_31_XOP_STBUX:\r\nemulated = kvmppc_handle_store(run, vcpu,\r\nkvmppc_get_gpr(vcpu, rs),\r\n1, 1);\r\nkvmppc_set_gpr(vcpu, ra, vcpu->arch.vaddr_accessed);\r\nbreak;\r\ncase OP_31_XOP_LHAX:\r\nemulated = kvmppc_handle_loads(run, vcpu, rt, 2, 1);\r\nbreak;\r\ncase OP_31_XOP_LHZX:\r\nemulated = kvmppc_handle_load(run, vcpu, rt, 2, 1);\r\nbreak;\r\ncase OP_31_XOP_LHZUX:\r\nemulated = kvmppc_handle_load(run, vcpu, rt, 2, 1);\r\nkvmppc_set_gpr(vcpu, ra, vcpu->arch.vaddr_accessed);\r\nbreak;\r\ncase OP_31_XOP_STHX:\r\nemulated = kvmppc_handle_store(run, vcpu,\r\nkvmppc_get_gpr(vcpu, rs),\r\n2, 1);\r\nbreak;\r\ncase OP_31_XOP_STHUX:\r\nemulated = kvmppc_handle_store(run, vcpu,\r\nkvmppc_get_gpr(vcpu, rs),\r\n2, 1);\r\nkvmppc_set_gpr(vcpu, ra, vcpu->arch.vaddr_accessed);\r\nbreak;\r\ncase OP_31_XOP_DCBST:\r\ncase OP_31_XOP_DCBF:\r\ncase OP_31_XOP_DCBI:\r\nbreak;\r\ncase OP_31_XOP_LWBRX:\r\nemulated = kvmppc_handle_load(run, vcpu, rt, 4, 0);\r\nbreak;\r\ncase OP_31_XOP_STWBRX:\r\nemulated = kvmppc_handle_store(run, vcpu,\r\nkvmppc_get_gpr(vcpu, rs),\r\n4, 0);\r\nbreak;\r\ncase OP_31_XOP_LHBRX:\r\nemulated = kvmppc_handle_load(run, vcpu, rt, 2, 0);\r\nbreak;\r\ncase OP_31_XOP_STHBRX:\r\nemulated = kvmppc_handle_store(run, vcpu,\r\nkvmppc_get_gpr(vcpu, rs),\r\n2, 0);\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\nbreak;\r\n}\r\nbreak;\r\ncase OP_LWZ:\r\nemulated = kvmppc_handle_load(run, vcpu, rt, 4, 1);\r\nbreak;\r\ncase OP_LD:\r\nrt = get_rt(inst);\r\nemulated = kvmppc_handle_load(run, vcpu, rt, 8, 1);\r\nbreak;\r\ncase OP_LWZU:\r\nemulated = kvmppc_handle_load(run, vcpu, rt, 4, 1);\r\nkvmppc_set_gpr(vcpu, ra, vcpu->arch.vaddr_accessed);\r\nbreak;\r\ncase OP_LBZ:\r\nemulated = kvmppc_handle_load(run, vcpu, rt, 1, 1);\r\nbreak;\r\ncase OP_LBZU:\r\nemulated = kvmppc_handle_load(run, vcpu, rt, 1, 1);\r\nkvmppc_set_gpr(vcpu, ra, vcpu->arch.vaddr_accessed);\r\nbreak;\r\ncase OP_STW:\r\nemulated = kvmppc_handle_store(run, vcpu,\r\nkvmppc_get_gpr(vcpu, rs),\r\n4, 1);\r\nbreak;\r\ncase OP_STD:\r\nrs = get_rs(inst);\r\nemulated = kvmppc_handle_store(run, vcpu,\r\nkvmppc_get_gpr(vcpu, rs),\r\n8, 1);\r\nbreak;\r\ncase OP_STWU:\r\nemulated = kvmppc_handle_store(run, vcpu,\r\nkvmppc_get_gpr(vcpu, rs),\r\n4, 1);\r\nkvmppc_set_gpr(vcpu, ra, vcpu->arch.vaddr_accessed);\r\nbreak;\r\ncase OP_STB:\r\nemulated = kvmppc_handle_store(run, vcpu,\r\nkvmppc_get_gpr(vcpu, rs),\r\n1, 1);\r\nbreak;\r\ncase OP_STBU:\r\nemulated = kvmppc_handle_store(run, vcpu,\r\nkvmppc_get_gpr(vcpu, rs),\r\n1, 1);\r\nkvmppc_set_gpr(vcpu, ra, vcpu->arch.vaddr_accessed);\r\nbreak;\r\ncase OP_LHZ:\r\nemulated = kvmppc_handle_load(run, vcpu, rt, 2, 1);\r\nbreak;\r\ncase OP_LHZU:\r\nemulated = kvmppc_handle_load(run, vcpu, rt, 2, 1);\r\nkvmppc_set_gpr(vcpu, ra, vcpu->arch.vaddr_accessed);\r\nbreak;\r\ncase OP_LHA:\r\nemulated = kvmppc_handle_loads(run, vcpu, rt, 2, 1);\r\nbreak;\r\ncase OP_LHAU:\r\nemulated = kvmppc_handle_loads(run, vcpu, rt, 2, 1);\r\nkvmppc_set_gpr(vcpu, ra, vcpu->arch.vaddr_accessed);\r\nbreak;\r\ncase OP_STH:\r\nemulated = kvmppc_handle_store(run, vcpu,\r\nkvmppc_get_gpr(vcpu, rs),\r\n2, 1);\r\nbreak;\r\ncase OP_STHU:\r\nemulated = kvmppc_handle_store(run, vcpu,\r\nkvmppc_get_gpr(vcpu, rs),\r\n2, 1);\r\nkvmppc_set_gpr(vcpu, ra, vcpu->arch.vaddr_accessed);\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\nbreak;\r\n}\r\nif (emulated == EMULATE_FAIL) {\r\nadvance = 0;\r\nkvmppc_core_queue_program(vcpu, 0);\r\n}\r\ntrace_kvm_ppc_instr(inst, kvmppc_get_pc(vcpu), emulated);\r\nif (advance)\r\nkvmppc_set_pc(vcpu, kvmppc_get_pc(vcpu) + 4);\r\nreturn emulated;\r\n}

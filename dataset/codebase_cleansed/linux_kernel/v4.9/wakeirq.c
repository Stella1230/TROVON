static int dev_pm_attach_wake_irq(struct device *dev, int irq,\r\nstruct wake_irq *wirq)\r\n{\r\nunsigned long flags;\r\nint err;\r\nif (!dev || !wirq)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&dev->power.lock, flags);\r\nif (dev_WARN_ONCE(dev, dev->power.wakeirq,\r\n"wake irq already initialized\n")) {\r\nspin_unlock_irqrestore(&dev->power.lock, flags);\r\nreturn -EEXIST;\r\n}\r\nerr = device_wakeup_attach_irq(dev, wirq);\r\nif (!err)\r\ndev->power.wakeirq = wirq;\r\nspin_unlock_irqrestore(&dev->power.lock, flags);\r\nreturn err;\r\n}\r\nint dev_pm_set_wake_irq(struct device *dev, int irq)\r\n{\r\nstruct wake_irq *wirq;\r\nint err;\r\nif (irq < 0)\r\nreturn -EINVAL;\r\nwirq = kzalloc(sizeof(*wirq), GFP_KERNEL);\r\nif (!wirq)\r\nreturn -ENOMEM;\r\nwirq->dev = dev;\r\nwirq->irq = irq;\r\nerr = dev_pm_attach_wake_irq(dev, irq, wirq);\r\nif (err)\r\nkfree(wirq);\r\nreturn err;\r\n}\r\nvoid dev_pm_clear_wake_irq(struct device *dev)\r\n{\r\nstruct wake_irq *wirq = dev->power.wakeirq;\r\nunsigned long flags;\r\nif (!wirq)\r\nreturn;\r\nspin_lock_irqsave(&dev->power.lock, flags);\r\ndevice_wakeup_detach_irq(dev);\r\ndev->power.wakeirq = NULL;\r\nspin_unlock_irqrestore(&dev->power.lock, flags);\r\nif (wirq->dedicated_irq)\r\nfree_irq(wirq->irq, wirq);\r\nkfree(wirq);\r\n}\r\nstatic irqreturn_t handle_threaded_wake_irq(int irq, void *_wirq)\r\n{\r\nstruct wake_irq *wirq = _wirq;\r\nint res;\r\nres = pm_runtime_resume(wirq->dev);\r\nif (res < 0)\r\ndev_warn(wirq->dev,\r\n"wake IRQ with no resume: %i\n", res);\r\nreturn IRQ_HANDLED;\r\n}\r\nint dev_pm_set_dedicated_wake_irq(struct device *dev, int irq)\r\n{\r\nstruct wake_irq *wirq;\r\nint err;\r\nif (irq < 0)\r\nreturn -EINVAL;\r\nwirq = kzalloc(sizeof(*wirq), GFP_KERNEL);\r\nif (!wirq)\r\nreturn -ENOMEM;\r\nwirq->dev = dev;\r\nwirq->irq = irq;\r\nwirq->dedicated_irq = true;\r\nirq_set_status_flags(irq, IRQ_NOAUTOEN);\r\nerr = request_threaded_irq(irq, NULL, handle_threaded_wake_irq,\r\nIRQF_ONESHOT, dev_name(dev), wirq);\r\nif (err)\r\ngoto err_free;\r\nerr = dev_pm_attach_wake_irq(dev, irq, wirq);\r\nif (err)\r\ngoto err_free_irq;\r\nreturn err;\r\nerr_free_irq:\r\nfree_irq(irq, wirq);\r\nerr_free:\r\nkfree(wirq);\r\nreturn err;\r\n}\r\nvoid dev_pm_enable_wake_irq(struct device *dev)\r\n{\r\nstruct wake_irq *wirq = dev->power.wakeirq;\r\nif (wirq && wirq->dedicated_irq)\r\nenable_irq(wirq->irq);\r\n}\r\nvoid dev_pm_disable_wake_irq(struct device *dev)\r\n{\r\nstruct wake_irq *wirq = dev->power.wakeirq;\r\nif (wirq && wirq->dedicated_irq)\r\ndisable_irq_nosync(wirq->irq);\r\n}\r\nvoid dev_pm_arm_wake_irq(struct wake_irq *wirq)\r\n{\r\nif (!wirq)\r\nreturn;\r\nif (device_may_wakeup(wirq->dev))\r\nenable_irq_wake(wirq->irq);\r\n}\r\nvoid dev_pm_disarm_wake_irq(struct wake_irq *wirq)\r\n{\r\nif (!wirq)\r\nreturn;\r\nif (device_may_wakeup(wirq->dev))\r\ndisable_irq_wake(wirq->irq);\r\n}

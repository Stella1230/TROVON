static void pmu_apm_get_power_status(struct apm_power_info *info)\r\n{\r\nint percentage = -1;\r\nint batteries = 0;\r\nint time_units = -1;\r\nint real_count = 0;\r\nint i;\r\nchar charging = 0;\r\nlong charge = -1;\r\nlong amperage = 0;\r\nunsigned long btype = 0;\r\ninfo->battery_status = APM_BATTERY_STATUS_UNKNOWN;\r\ninfo->battery_flag = APM_BATTERY_FLAG_UNKNOWN;\r\ninfo->units = APM_UNITS_MINS;\r\nif (pmu_power_flags & PMU_PWR_AC_PRESENT)\r\ninfo->ac_line_status = APM_AC_ONLINE;\r\nelse\r\ninfo->ac_line_status = APM_AC_OFFLINE;\r\nfor (i=0; i<pmu_battery_count; i++) {\r\nif (pmu_batteries[i].flags & PMU_BATT_PRESENT) {\r\nbatteries++;\r\nif (percentage < 0)\r\npercentage = 0;\r\nif (charge < 0)\r\ncharge = 0;\r\npercentage += (pmu_batteries[i].charge * 100) /\r\npmu_batteries[i].max_charge;\r\ncharge += pmu_batteries[i].charge;\r\namperage += pmu_batteries[i].amperage;\r\nif (btype == 0)\r\nbtype = (pmu_batteries[i].flags & PMU_BATT_TYPE_MASK);\r\nreal_count++;\r\nif ((pmu_batteries[i].flags & PMU_BATT_CHARGING))\r\ncharging++;\r\n}\r\n}\r\nif (batteries == 0)\r\ninfo->ac_line_status = APM_AC_ONLINE;\r\nif (real_count) {\r\nif (amperage < 0) {\r\nif (btype == PMU_BATT_TYPE_SMART)\r\ntime_units = (charge * 59) / (amperage * -1);\r\nelse\r\ntime_units = (charge * 16440) / (amperage * -60);\r\n}\r\npercentage /= real_count;\r\nif (charging > 0) {\r\ninfo->battery_status = APM_BATTERY_STATUS_CHARGING;\r\ninfo->battery_flag = APM_BATTERY_FLAG_CHARGING;\r\n} else if (percentage <= APM_CRITICAL) {\r\ninfo->battery_status = APM_BATTERY_STATUS_CRITICAL;\r\ninfo->battery_flag = APM_BATTERY_FLAG_CRITICAL;\r\n} else if (percentage <= APM_LOW) {\r\ninfo->battery_status = APM_BATTERY_STATUS_LOW;\r\ninfo->battery_flag = APM_BATTERY_FLAG_LOW;\r\n} else {\r\ninfo->battery_status = APM_BATTERY_STATUS_HIGH;\r\ninfo->battery_flag = APM_BATTERY_FLAG_HIGH;\r\n}\r\n}\r\ninfo->battery_life = percentage;\r\ninfo->time = time_units;\r\n}\r\nstatic int __init apm_emu_init(void)\r\n{\r\napm_get_power_status = pmu_apm_get_power_status;\r\nprintk(KERN_INFO "apm_emu: PMU APM Emulation initialized.\n");\r\nreturn 0;\r\n}\r\nstatic void __exit apm_emu_exit(void)\r\n{\r\nif (apm_get_power_status == pmu_apm_get_power_status)\r\napm_get_power_status = NULL;\r\nprintk(KERN_INFO "apm_emu: PMU APM Emulation removed.\n");\r\n}

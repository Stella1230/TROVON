unsigned long run_uncached(void *func)\r\n{\r\nregister long sp __asm__("$sp");\r\nregister long ret __asm__("$2");\r\nlong lfunc = (long)func, ufunc;\r\nlong usp;\r\nif (sp >= (long)CKSEG0 && sp < (long)CKSEG2)\r\nusp = CKSEG1ADDR(sp);\r\n#ifdef CONFIG_64BIT\r\nelse if ((long long)sp >= (long long)PHYS_TO_XKPHYS(0, 0) &&\r\n(long long)sp < (long long)PHYS_TO_XKPHYS(8, 0))\r\nusp = PHYS_TO_XKPHYS(K_CALG_UNCACHED,\r\nXKPHYS_TO_PHYS((long long)sp));\r\n#endif\r\nelse {\r\nBUG();\r\nusp = sp;\r\n}\r\nif (lfunc >= (long)CKSEG0 && lfunc < (long)CKSEG2)\r\nufunc = CKSEG1ADDR(lfunc);\r\n#ifdef CONFIG_64BIT\r\nelse if ((long long)lfunc >= (long long)PHYS_TO_XKPHYS(0, 0) &&\r\n(long long)lfunc < (long long)PHYS_TO_XKPHYS(8, 0))\r\nufunc = PHYS_TO_XKPHYS(K_CALG_UNCACHED,\r\nXKPHYS_TO_PHYS((long long)lfunc));\r\n#endif\r\nelse {\r\nBUG();\r\nufunc = lfunc;\r\n}\r\n__asm__ __volatile__ (\r\n" move $16, $sp\n"\r\n" move $sp, %1\n"\r\n" jalr %2\n"\r\n" move $sp, $16"\r\n: "=r" (ret)\r\n: "r" (usp), "r" (ufunc)\r\n: "$16", "$31");\r\nreturn ret;\r\n}

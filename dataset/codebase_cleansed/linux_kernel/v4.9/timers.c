static void init_timer_irq(void)\r\n{\r\n#ifdef MCFSIM_ICR_AUTOVEC\r\nwriteb(MCFSIM_ICR_AUTOVEC | MCFSIM_ICR_LEVEL6 | MCFSIM_ICR_PRI3,\r\nMCFSIM_TIMER1ICR);\r\nmcf_mapirq2imr(MCF_IRQ_TIMER, MCFINTC_TIMER1);\r\n#ifdef CONFIG_HIGHPROFILE\r\nwriteb(MCFSIM_ICR_AUTOVEC | MCFSIM_ICR_LEVEL7 | MCFSIM_ICR_PRI3,\r\nMCFSIM_TIMER2ICR);\r\nmcf_mapirq2imr(MCF_IRQ_PROFILER, MCFINTC_TIMER2);\r\n#endif\r\n#endif\r\n}\r\nstatic irqreturn_t mcftmr_tick(int irq, void *dummy)\r\n{\r\n__raw_writeb(MCFTIMER_TER_CAP | MCFTIMER_TER_REF, TA(MCFTIMER_TER));\r\nmcftmr_cnt += mcftmr_cycles_per_jiffy;\r\nreturn timer_interrupt(irq, dummy);\r\n}\r\nstatic cycle_t mcftmr_read_clk(struct clocksource *cs)\r\n{\r\nunsigned long flags;\r\nu32 cycles;\r\nu16 tcn;\r\nlocal_irq_save(flags);\r\ntcn = __raw_readw(TA(MCFTIMER_TCN));\r\ncycles = mcftmr_cnt;\r\nlocal_irq_restore(flags);\r\nreturn cycles + tcn;\r\n}\r\nvoid hw_timer_init(irq_handler_t handler)\r\n{\r\n__raw_writew(MCFTIMER_TMR_DISABLE, TA(MCFTIMER_TMR));\r\nmcftmr_cycles_per_jiffy = FREQ / HZ;\r\n__raw_writetrr(mcftmr_cycles_per_jiffy - 1, TA(MCFTIMER_TRR));\r\n__raw_writew(MCFTIMER_TMR_ENORI | MCFTIMER_TMR_CLK16 |\r\nMCFTIMER_TMR_RESTART | MCFTIMER_TMR_ENABLE, TA(MCFTIMER_TMR));\r\nclocksource_register_hz(&mcftmr_clk, FREQ);\r\ntimer_interrupt = handler;\r\ninit_timer_irq();\r\nsetup_irq(MCF_IRQ_TIMER, &mcftmr_timer_irq);\r\n#ifdef CONFIG_HIGHPROFILE\r\ncoldfire_profile_init();\r\n#endif\r\n}\r\nirqreturn_t coldfire_profile_tick(int irq, void *dummy)\r\n{\r\n__raw_writeb(MCFTIMER_TER_CAP | MCFTIMER_TER_REF, PA(MCFTIMER_TER));\r\nif (current->pid)\r\nprofile_tick(CPU_PROFILING);\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid coldfire_profile_init(void)\r\n{\r\nprintk(KERN_INFO "PROFILE: lodging TIMER2 @ %dHz as profile timer\n",\r\nPROFILEHZ);\r\n__raw_writew(MCFTIMER_TMR_DISABLE, PA(MCFTIMER_TMR));\r\n__raw_writetrr(((MCF_BUSCLK / 16) / PROFILEHZ), PA(MCFTIMER_TRR));\r\n__raw_writew(MCFTIMER_TMR_ENORI | MCFTIMER_TMR_CLK16 |\r\nMCFTIMER_TMR_RESTART | MCFTIMER_TMR_ENABLE, PA(MCFTIMER_TMR));\r\nsetup_irq(MCF_IRQ_PROFILER, &coldfire_profile_irq);\r\n}

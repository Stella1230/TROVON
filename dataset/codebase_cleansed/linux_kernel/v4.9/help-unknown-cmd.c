static int perf_unknown_cmd_config(const char *var, const char *value,\r\nvoid *cb __maybe_unused)\r\n{\r\nif (!strcmp(var, "help.autocorrect"))\r\nautocorrect = perf_config_int(var,value);\r\nif (!prefixcmp(var, "alias."))\r\nadd_cmdname(&aliases, var + 6, strlen(var + 6));\r\nreturn 0;\r\n}\r\nstatic int levenshtein_compare(const void *p1, const void *p2)\r\n{\r\nconst struct cmdname *const *c1 = p1, *const *c2 = p2;\r\nconst char *s1 = (*c1)->name, *s2 = (*c2)->name;\r\nint l1 = (*c1)->len;\r\nint l2 = (*c2)->len;\r\nreturn l1 != l2 ? l1 - l2 : strcmp(s1, s2);\r\n}\r\nstatic int add_cmd_list(struct cmdnames *cmds, struct cmdnames *old)\r\n{\r\nunsigned int i, nr = cmds->cnt + old->cnt;\r\nvoid *tmp;\r\nif (nr > cmds->alloc) {\r\nif (alloc_nr(cmds->alloc) < nr)\r\ncmds->alloc = nr;\r\nelse\r\ncmds->alloc = alloc_nr(cmds->alloc);\r\ntmp = realloc(cmds->names, cmds->alloc * sizeof(*cmds->names));\r\nif (!tmp)\r\nreturn -1;\r\ncmds->names = tmp;\r\n}\r\nfor (i = 0; i < old->cnt; i++)\r\ncmds->names[cmds->cnt++] = old->names[i];\r\nzfree(&old->names);\r\nold->cnt = 0;\r\nreturn 0;\r\n}\r\nconst char *help_unknown_cmd(const char *cmd)\r\n{\r\nunsigned int i, n = 0, best_similarity = 0;\r\nstruct cmdnames main_cmds, other_cmds;\r\nmemset(&main_cmds, 0, sizeof(main_cmds));\r\nmemset(&other_cmds, 0, sizeof(main_cmds));\r\nmemset(&aliases, 0, sizeof(aliases));\r\nperf_config(perf_unknown_cmd_config, NULL);\r\nload_command_list("perf-", &main_cmds, &other_cmds);\r\nif (add_cmd_list(&main_cmds, &aliases) < 0 ||\r\nadd_cmd_list(&main_cmds, &other_cmds) < 0) {\r\nfprintf(stderr, "ERROR: Failed to allocate command list for unknown command.\n");\r\ngoto end;\r\n}\r\nqsort(main_cmds.names, main_cmds.cnt,\r\nsizeof(main_cmds.names), cmdname_compare);\r\nuniq(&main_cmds);\r\nif (main_cmds.cnt) {\r\nfor (i = 0; i < main_cmds.cnt; ++i)\r\nmain_cmds.names[i]->len =\r\nlevenshtein(cmd, main_cmds.names[i]->name, 0, 2, 1, 4);\r\nqsort(main_cmds.names, main_cmds.cnt,\r\nsizeof(*main_cmds.names), levenshtein_compare);\r\nbest_similarity = main_cmds.names[0]->len;\r\nn = 1;\r\nwhile (n < main_cmds.cnt && best_similarity == main_cmds.names[n]->len)\r\n++n;\r\n}\r\nif (autocorrect && n == 1) {\r\nconst char *assumed = main_cmds.names[0]->name;\r\nmain_cmds.names[0] = NULL;\r\nclean_cmdnames(&main_cmds);\r\nfprintf(stderr, "WARNING: You called a perf program named '%s', "\r\n"which does not exist.\n"\r\n"Continuing under the assumption that you meant '%s'\n",\r\ncmd, assumed);\r\nif (autocorrect > 0) {\r\nfprintf(stderr, "in %0.1f seconds automatically...\n",\r\n(float)autocorrect/10.0);\r\npoll(NULL, 0, autocorrect * 100);\r\n}\r\nreturn assumed;\r\n}\r\nfprintf(stderr, "perf: '%s' is not a perf-command. See 'perf --help'.\n", cmd);\r\nif (main_cmds.cnt && best_similarity < 6) {\r\nfprintf(stderr, "\nDid you mean %s?\n",\r\nn < 2 ? "this": "one of these");\r\nfor (i = 0; i < n; i++)\r\nfprintf(stderr, "\t%s\n", main_cmds.names[i]->name);\r\n}\r\nend:\r\nexit(1);\r\n}

int karma_partition(struct parsed_partitions *state)\r\n{\r\nint i;\r\nint slot = 1;\r\nSector sect;\r\nunsigned char *data;\r\nstruct disklabel {\r\nu8 d_reserved[270];\r\nstruct d_partition {\r\n__le32 p_res;\r\nu8 p_fstype;\r\nu8 p_res2[3];\r\n__le32 p_offset;\r\n__le32 p_size;\r\n} d_partitions[2];\r\nu8 d_blank[208];\r\n__le16 d_magic;\r\n} __packed *label;\r\nstruct d_partition *p;\r\ndata = read_part_sector(state, 0, &sect);\r\nif (!data)\r\nreturn -1;\r\nlabel = (struct disklabel *)data;\r\nif (le16_to_cpu(label->d_magic) != KARMA_LABEL_MAGIC) {\r\nput_dev_sector(sect);\r\nreturn 0;\r\n}\r\np = label->d_partitions;\r\nfor (i = 0 ; i < 2; i++, p++) {\r\nif (slot == state->limit)\r\nbreak;\r\nif (p->p_fstype == 0x4d && le32_to_cpu(p->p_size)) {\r\nput_partition(state, slot, le32_to_cpu(p->p_offset),\r\nle32_to_cpu(p->p_size));\r\n}\r\nslot++;\r\n}\r\nstrlcat(state->pp_buf, "\n", PAGE_SIZE);\r\nput_dev_sector(sect);\r\nreturn 1;\r\n}

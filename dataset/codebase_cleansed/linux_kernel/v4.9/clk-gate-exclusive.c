static int clk_gate_exclusive_enable(struct clk_hw *hw)\r\n{\r\nstruct clk_gate *gate = to_clk_gate(hw);\r\nstruct clk_gate_exclusive *exgate = container_of(gate,\r\nstruct clk_gate_exclusive, gate);\r\nu32 val = readl(gate->reg);\r\nif (val & exgate->exclusive_mask)\r\nreturn -EBUSY;\r\nreturn clk_gate_ops.enable(hw);\r\n}\r\nstatic void clk_gate_exclusive_disable(struct clk_hw *hw)\r\n{\r\nclk_gate_ops.disable(hw);\r\n}\r\nstatic int clk_gate_exclusive_is_enabled(struct clk_hw *hw)\r\n{\r\nreturn clk_gate_ops.is_enabled(hw);\r\n}\r\nstruct clk *imx_clk_gate_exclusive(const char *name, const char *parent,\r\nvoid __iomem *reg, u8 shift, u32 exclusive_mask)\r\n{\r\nstruct clk_gate_exclusive *exgate;\r\nstruct clk_gate *gate;\r\nstruct clk *clk;\r\nstruct clk_init_data init;\r\nif (exclusive_mask == 0)\r\nreturn ERR_PTR(-EINVAL);\r\nexgate = kzalloc(sizeof(*exgate), GFP_KERNEL);\r\nif (!exgate)\r\nreturn ERR_PTR(-ENOMEM);\r\ngate = &exgate->gate;\r\ninit.name = name;\r\ninit.ops = &clk_gate_exclusive_ops;\r\ninit.flags = CLK_SET_RATE_PARENT;\r\ninit.parent_names = parent ? &parent : NULL;\r\ninit.num_parents = parent ? 1 : 0;\r\ngate->reg = reg;\r\ngate->bit_idx = shift;\r\ngate->lock = &imx_ccm_lock;\r\ngate->hw.init = &init;\r\nexgate->exclusive_mask = exclusive_mask;\r\nclk = clk_register(NULL, &gate->hw);\r\nif (IS_ERR(clk))\r\nkfree(exgate);\r\nreturn clk;\r\n}

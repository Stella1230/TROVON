static void\r\nxfs_qm_fill_state(\r\nstruct qc_type_state *tstate,\r\nstruct xfs_mount *mp,\r\nstruct xfs_inode *ip,\r\nxfs_ino_t ino)\r\n{\r\nstruct xfs_quotainfo *q = mp->m_quotainfo;\r\nbool tempqip = false;\r\ntstate->ino = ino;\r\nif (!ip && ino == NULLFSINO)\r\nreturn;\r\nif (!ip) {\r\nif (xfs_iget(mp, NULL, ino, 0, 0, &ip))\r\nreturn;\r\ntempqip = true;\r\n}\r\ntstate->flags |= QCI_SYSFILE;\r\ntstate->blocks = ip->i_d.di_nblocks;\r\ntstate->nextents = ip->i_d.di_nextents;\r\ntstate->spc_timelimit = q->qi_btimelimit;\r\ntstate->ino_timelimit = q->qi_itimelimit;\r\ntstate->rt_spc_timelimit = q->qi_rtbtimelimit;\r\ntstate->spc_warnlimit = q->qi_bwarnlimit;\r\ntstate->ino_warnlimit = q->qi_iwarnlimit;\r\ntstate->rt_spc_warnlimit = q->qi_rtbwarnlimit;\r\nif (tempqip)\r\nIRELE(ip);\r\n}\r\nstatic int\r\nxfs_fs_get_quota_state(\r\nstruct super_block *sb,\r\nstruct qc_state *state)\r\n{\r\nstruct xfs_mount *mp = XFS_M(sb);\r\nstruct xfs_quotainfo *q = mp->m_quotainfo;\r\nmemset(state, 0, sizeof(*state));\r\nif (!XFS_IS_QUOTA_RUNNING(mp))\r\nreturn 0;\r\nstate->s_incoredqs = q->qi_dquots;\r\nif (XFS_IS_UQUOTA_RUNNING(mp))\r\nstate->s_state[USRQUOTA].flags |= QCI_ACCT_ENABLED;\r\nif (XFS_IS_UQUOTA_ENFORCED(mp))\r\nstate->s_state[USRQUOTA].flags |= QCI_LIMITS_ENFORCED;\r\nif (XFS_IS_GQUOTA_RUNNING(mp))\r\nstate->s_state[GRPQUOTA].flags |= QCI_ACCT_ENABLED;\r\nif (XFS_IS_GQUOTA_ENFORCED(mp))\r\nstate->s_state[GRPQUOTA].flags |= QCI_LIMITS_ENFORCED;\r\nif (XFS_IS_PQUOTA_RUNNING(mp))\r\nstate->s_state[PRJQUOTA].flags |= QCI_ACCT_ENABLED;\r\nif (XFS_IS_PQUOTA_ENFORCED(mp))\r\nstate->s_state[PRJQUOTA].flags |= QCI_LIMITS_ENFORCED;\r\nxfs_qm_fill_state(&state->s_state[USRQUOTA], mp, q->qi_uquotaip,\r\nmp->m_sb.sb_uquotino);\r\nxfs_qm_fill_state(&state->s_state[GRPQUOTA], mp, q->qi_gquotaip,\r\nmp->m_sb.sb_gquotino);\r\nxfs_qm_fill_state(&state->s_state[PRJQUOTA], mp, q->qi_pquotaip,\r\nmp->m_sb.sb_pquotino);\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_quota_type(int type)\r\n{\r\nswitch (type) {\r\ncase USRQUOTA:\r\nreturn XFS_DQ_USER;\r\ncase GRPQUOTA:\r\nreturn XFS_DQ_GROUP;\r\ndefault:\r\nreturn XFS_DQ_PROJ;\r\n}\r\n}\r\nstatic int\r\nxfs_fs_set_info(\r\nstruct super_block *sb,\r\nint type,\r\nstruct qc_info *info)\r\n{\r\nstruct xfs_mount *mp = XFS_M(sb);\r\nstruct qc_dqblk newlim;\r\nif (sb->s_flags & MS_RDONLY)\r\nreturn -EROFS;\r\nif (!XFS_IS_QUOTA_RUNNING(mp))\r\nreturn -ENOSYS;\r\nif (!XFS_IS_QUOTA_ON(mp))\r\nreturn -ESRCH;\r\nif (info->i_fieldmask & ~XFS_QC_SETINFO_MASK)\r\nreturn -EINVAL;\r\nif ((info->i_fieldmask & XFS_QC_SETINFO_MASK) == 0)\r\nreturn 0;\r\nnewlim.d_fieldmask = info->i_fieldmask;\r\nnewlim.d_spc_timer = info->i_spc_timelimit;\r\nnewlim.d_ino_timer = info->i_ino_timelimit;\r\nnewlim.d_rt_spc_timer = info->i_rt_spc_timelimit;\r\nnewlim.d_ino_warns = info->i_ino_warnlimit;\r\nnewlim.d_spc_warns = info->i_spc_warnlimit;\r\nnewlim.d_rt_spc_warns = info->i_rt_spc_warnlimit;\r\nreturn xfs_qm_scall_setqlim(mp, 0, xfs_quota_type(type), &newlim);\r\n}\r\nstatic unsigned int\r\nxfs_quota_flags(unsigned int uflags)\r\n{\r\nunsigned int flags = 0;\r\nif (uflags & FS_QUOTA_UDQ_ACCT)\r\nflags |= XFS_UQUOTA_ACCT;\r\nif (uflags & FS_QUOTA_PDQ_ACCT)\r\nflags |= XFS_PQUOTA_ACCT;\r\nif (uflags & FS_QUOTA_GDQ_ACCT)\r\nflags |= XFS_GQUOTA_ACCT;\r\nif (uflags & FS_QUOTA_UDQ_ENFD)\r\nflags |= XFS_UQUOTA_ENFD;\r\nif (uflags & FS_QUOTA_GDQ_ENFD)\r\nflags |= XFS_GQUOTA_ENFD;\r\nif (uflags & FS_QUOTA_PDQ_ENFD)\r\nflags |= XFS_PQUOTA_ENFD;\r\nreturn flags;\r\n}\r\nSTATIC int\r\nxfs_quota_enable(\r\nstruct super_block *sb,\r\nunsigned int uflags)\r\n{\r\nstruct xfs_mount *mp = XFS_M(sb);\r\nif (sb->s_flags & MS_RDONLY)\r\nreturn -EROFS;\r\nif (!XFS_IS_QUOTA_RUNNING(mp))\r\nreturn -ENOSYS;\r\nreturn xfs_qm_scall_quotaon(mp, xfs_quota_flags(uflags));\r\n}\r\nSTATIC int\r\nxfs_quota_disable(\r\nstruct super_block *sb,\r\nunsigned int uflags)\r\n{\r\nstruct xfs_mount *mp = XFS_M(sb);\r\nif (sb->s_flags & MS_RDONLY)\r\nreturn -EROFS;\r\nif (!XFS_IS_QUOTA_RUNNING(mp))\r\nreturn -ENOSYS;\r\nif (!XFS_IS_QUOTA_ON(mp))\r\nreturn -EINVAL;\r\nreturn xfs_qm_scall_quotaoff(mp, xfs_quota_flags(uflags));\r\n}\r\nSTATIC int\r\nxfs_fs_rm_xquota(\r\nstruct super_block *sb,\r\nunsigned int uflags)\r\n{\r\nstruct xfs_mount *mp = XFS_M(sb);\r\nunsigned int flags = 0;\r\nif (sb->s_flags & MS_RDONLY)\r\nreturn -EROFS;\r\nif (XFS_IS_QUOTA_ON(mp))\r\nreturn -EINVAL;\r\nif (uflags & FS_USER_QUOTA)\r\nflags |= XFS_DQ_USER;\r\nif (uflags & FS_GROUP_QUOTA)\r\nflags |= XFS_DQ_GROUP;\r\nif (uflags & FS_PROJ_QUOTA)\r\nflags |= XFS_DQ_PROJ;\r\nreturn xfs_qm_scall_trunc_qfiles(mp, flags);\r\n}\r\nSTATIC int\r\nxfs_fs_get_dqblk(\r\nstruct super_block *sb,\r\nstruct kqid qid,\r\nstruct qc_dqblk *qdq)\r\n{\r\nstruct xfs_mount *mp = XFS_M(sb);\r\nxfs_dqid_t id;\r\nif (!XFS_IS_QUOTA_RUNNING(mp))\r\nreturn -ENOSYS;\r\nif (!XFS_IS_QUOTA_ON(mp))\r\nreturn -ESRCH;\r\nid = from_kqid(&init_user_ns, qid);\r\nreturn xfs_qm_scall_getquota(mp, &id,\r\nxfs_quota_type(qid.type), qdq, 0);\r\n}\r\nSTATIC int\r\nxfs_fs_get_nextdqblk(\r\nstruct super_block *sb,\r\nstruct kqid *qid,\r\nstruct qc_dqblk *qdq)\r\n{\r\nint ret;\r\nstruct xfs_mount *mp = XFS_M(sb);\r\nxfs_dqid_t id;\r\nif (!XFS_IS_QUOTA_RUNNING(mp))\r\nreturn -ENOSYS;\r\nif (!XFS_IS_QUOTA_ON(mp))\r\nreturn -ESRCH;\r\nid = from_kqid(&init_user_ns, *qid);\r\nret = xfs_qm_scall_getquota(mp, &id,\r\nxfs_quota_type(qid->type), qdq,\r\nXFS_QMOPT_DQNEXT);\r\nif (ret)\r\nreturn ret;\r\n*qid = make_kqid(current_user_ns(), qid->type, id);\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_fs_set_dqblk(\r\nstruct super_block *sb,\r\nstruct kqid qid,\r\nstruct qc_dqblk *qdq)\r\n{\r\nstruct xfs_mount *mp = XFS_M(sb);\r\nif (sb->s_flags & MS_RDONLY)\r\nreturn -EROFS;\r\nif (!XFS_IS_QUOTA_RUNNING(mp))\r\nreturn -ENOSYS;\r\nif (!XFS_IS_QUOTA_ON(mp))\r\nreturn -ESRCH;\r\nreturn xfs_qm_scall_setqlim(mp, from_kqid(&init_user_ns, qid),\r\nxfs_quota_type(qid.type), qdq);\r\n}

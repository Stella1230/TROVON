static inline u32 build_rs(u32 arg)\r\n{\r\nWARN(arg & ~RS_MASK, KERN_WARNING "Micro-assembler field overflow\n");\r\nreturn (arg & RS_MASK) << RS_SH;\r\n}\r\nstatic inline u32 build_rt(u32 arg)\r\n{\r\nWARN(arg & ~RT_MASK, KERN_WARNING "Micro-assembler field overflow\n");\r\nreturn (arg & RT_MASK) << RT_SH;\r\n}\r\nstatic inline u32 build_rd(u32 arg)\r\n{\r\nWARN(arg & ~RD_MASK, KERN_WARNING "Micro-assembler field overflow\n");\r\nreturn (arg & RD_MASK) << RD_SH;\r\n}\r\nstatic inline u32 build_re(u32 arg)\r\n{\r\nWARN(arg & ~RE_MASK, KERN_WARNING "Micro-assembler field overflow\n");\r\nreturn (arg & RE_MASK) << RE_SH;\r\n}\r\nstatic inline u32 build_simm(s32 arg)\r\n{\r\nWARN(arg > 0x7fff || arg < -0x8000,\r\nKERN_WARNING "Micro-assembler field overflow\n");\r\nreturn arg & 0xffff;\r\n}\r\nstatic inline u32 build_uimm(u32 arg)\r\n{\r\nWARN(arg & ~IMM_MASK, KERN_WARNING "Micro-assembler field overflow\n");\r\nreturn arg & IMM_MASK;\r\n}\r\nstatic inline u32 build_scimm(u32 arg)\r\n{\r\nWARN(arg & ~SCIMM_MASK,\r\nKERN_WARNING "Micro-assembler field overflow\n");\r\nreturn (arg & SCIMM_MASK) << SCIMM_SH;\r\n}\r\nstatic inline u32 build_func(u32 arg)\r\n{\r\nWARN(arg & ~FUNC_MASK, KERN_WARNING "Micro-assembler field overflow\n");\r\nreturn arg & FUNC_MASK;\r\n}\r\nstatic inline u32 build_set(u32 arg)\r\n{\r\nWARN(arg & ~SET_MASK, KERN_WARNING "Micro-assembler field overflow\n");\r\nreturn arg & SET_MASK;\r\n}\r\nvoid ISAFUNC(uasm_i_pref)(u32 **buf, unsigned int a, signed int b,\r\nunsigned int c)\r\n{\r\nif (OCTEON_IS_MODEL(OCTEON_CN63XX_PASS1_X) && a <= 24 && a != 5)\r\nbuild_insn(buf, insn_pref, c, 28, b);\r\nelse\r\nbuild_insn(buf, insn_pref, c, a, b);\r\n}\r\nvoid ISAFUNC(uasm_build_label)(struct uasm_label **lab, u32 *addr, int lid)\r\n{\r\n(*lab)->addr = addr;\r\n(*lab)->lab = lid;\r\n(*lab)++;\r\n}\r\nint ISAFUNC(uasm_in_compat_space_p)(long addr)\r\n{\r\n#ifdef CONFIG_64BIT\r\nreturn (((addr) & 0xffffffff00000000L) == 0xffffffff00000000L);\r\n#else\r\nreturn 1;\r\n#endif\r\n}\r\nstatic int uasm_rel_highest(long val)\r\n{\r\n#ifdef CONFIG_64BIT\r\nreturn ((((val + 0x800080008000L) >> 48) & 0xffff) ^ 0x8000) - 0x8000;\r\n#else\r\nreturn 0;\r\n#endif\r\n}\r\nstatic int uasm_rel_higher(long val)\r\n{\r\n#ifdef CONFIG_64BIT\r\nreturn ((((val + 0x80008000L) >> 32) & 0xffff) ^ 0x8000) - 0x8000;\r\n#else\r\nreturn 0;\r\n#endif\r\n}\r\nint ISAFUNC(uasm_rel_hi)(long val)\r\n{\r\nreturn ((((val + 0x8000L) >> 16) & 0xffff) ^ 0x8000) - 0x8000;\r\n}\r\nint ISAFUNC(uasm_rel_lo)(long val)\r\n{\r\nreturn ((val & 0xffff) ^ 0x8000) - 0x8000;\r\n}\r\nvoid ISAFUNC(UASM_i_LA_mostly)(u32 **buf, unsigned int rs, long addr)\r\n{\r\nif (!ISAFUNC(uasm_in_compat_space_p)(addr)) {\r\nISAFUNC(uasm_i_lui)(buf, rs, uasm_rel_highest(addr));\r\nif (uasm_rel_higher(addr))\r\nISAFUNC(uasm_i_daddiu)(buf, rs, rs, uasm_rel_higher(addr));\r\nif (ISAFUNC(uasm_rel_hi(addr))) {\r\nISAFUNC(uasm_i_dsll)(buf, rs, rs, 16);\r\nISAFUNC(uasm_i_daddiu)(buf, rs, rs,\r\nISAFUNC(uasm_rel_hi)(addr));\r\nISAFUNC(uasm_i_dsll)(buf, rs, rs, 16);\r\n} else\r\nISAFUNC(uasm_i_dsll32)(buf, rs, rs, 0);\r\n} else\r\nISAFUNC(uasm_i_lui)(buf, rs, ISAFUNC(uasm_rel_hi(addr)));\r\n}\r\nvoid ISAFUNC(UASM_i_LA)(u32 **buf, unsigned int rs, long addr)\r\n{\r\nISAFUNC(UASM_i_LA_mostly)(buf, rs, addr);\r\nif (ISAFUNC(uasm_rel_lo(addr))) {\r\nif (!ISAFUNC(uasm_in_compat_space_p)(addr))\r\nISAFUNC(uasm_i_daddiu)(buf, rs, rs,\r\nISAFUNC(uasm_rel_lo(addr)));\r\nelse\r\nISAFUNC(uasm_i_addiu)(buf, rs, rs,\r\nISAFUNC(uasm_rel_lo(addr)));\r\n}\r\n}\r\nvoid ISAFUNC(uasm_r_mips_pc16)(struct uasm_reloc **rel, u32 *addr, int lid)\r\n{\r\n(*rel)->addr = addr;\r\n(*rel)->type = R_MIPS_PC16;\r\n(*rel)->lab = lid;\r\n(*rel)++;\r\n}\r\nvoid ISAFUNC(uasm_resolve_relocs)(struct uasm_reloc *rel,\r\nstruct uasm_label *lab)\r\n{\r\nstruct uasm_label *l;\r\nfor (; rel->lab != UASM_LABEL_INVALID; rel++)\r\nfor (l = lab; l->lab != UASM_LABEL_INVALID; l++)\r\nif (rel->lab == l->lab)\r\n__resolve_relocs(rel, l);\r\n}\r\nvoid ISAFUNC(uasm_move_relocs)(struct uasm_reloc *rel, u32 *first, u32 *end,\r\nlong off)\r\n{\r\nfor (; rel->lab != UASM_LABEL_INVALID; rel++)\r\nif (rel->addr >= first && rel->addr < end)\r\nrel->addr += off;\r\n}\r\nvoid ISAFUNC(uasm_move_labels)(struct uasm_label *lab, u32 *first, u32 *end,\r\nlong off)\r\n{\r\nfor (; lab->lab != UASM_LABEL_INVALID; lab++)\r\nif (lab->addr >= first && lab->addr < end)\r\nlab->addr += off;\r\n}\r\nvoid ISAFUNC(uasm_copy_handler)(struct uasm_reloc *rel, struct uasm_label *lab,\r\nu32 *first, u32 *end, u32 *target)\r\n{\r\nlong off = (long)(target - first);\r\nmemcpy(target, first, (end - first) * sizeof(u32));\r\nISAFUNC(uasm_move_relocs(rel, first, end, off));\r\nISAFUNC(uasm_move_labels(lab, first, end, off));\r\n}\r\nint ISAFUNC(uasm_insn_has_bdelay)(struct uasm_reloc *rel, u32 *addr)\r\n{\r\nfor (; rel->lab != UASM_LABEL_INVALID; rel++) {\r\nif (rel->addr == addr\r\n&& (rel->type == R_MIPS_PC16\r\n|| rel->type == R_MIPS_26))\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nvoid ISAFUNC(uasm_il_bltz)(u32 **p, struct uasm_reloc **r, unsigned int reg,\r\nint lid)\r\n{\r\nuasm_r_mips_pc16(r, *p, lid);\r\nISAFUNC(uasm_i_bltz)(p, reg, 0);\r\n}\r\nvoid ISAFUNC(uasm_il_b)(u32 **p, struct uasm_reloc **r, int lid)\r\n{\r\nuasm_r_mips_pc16(r, *p, lid);\r\nISAFUNC(uasm_i_b)(p, 0);\r\n}\r\nvoid ISAFUNC(uasm_il_beqz)(u32 **p, struct uasm_reloc **r, unsigned int reg,\r\nint lid)\r\n{\r\nuasm_r_mips_pc16(r, *p, lid);\r\nISAFUNC(uasm_i_beqz)(p, reg, 0);\r\n}\r\nvoid ISAFUNC(uasm_il_beqzl)(u32 **p, struct uasm_reloc **r, unsigned int reg,\r\nint lid)\r\n{\r\nuasm_r_mips_pc16(r, *p, lid);\r\nISAFUNC(uasm_i_beqzl)(p, reg, 0);\r\n}\r\nvoid ISAFUNC(uasm_il_bne)(u32 **p, struct uasm_reloc **r, unsigned int reg1,\r\nunsigned int reg2, int lid)\r\n{\r\nuasm_r_mips_pc16(r, *p, lid);\r\nISAFUNC(uasm_i_bne)(p, reg1, reg2, 0);\r\n}\r\nvoid ISAFUNC(uasm_il_bnez)(u32 **p, struct uasm_reloc **r, unsigned int reg,\r\nint lid)\r\n{\r\nuasm_r_mips_pc16(r, *p, lid);\r\nISAFUNC(uasm_i_bnez)(p, reg, 0);\r\n}\r\nvoid ISAFUNC(uasm_il_bgezl)(u32 **p, struct uasm_reloc **r, unsigned int reg,\r\nint lid)\r\n{\r\nuasm_r_mips_pc16(r, *p, lid);\r\nISAFUNC(uasm_i_bgezl)(p, reg, 0);\r\n}\r\nvoid ISAFUNC(uasm_il_bgez)(u32 **p, struct uasm_reloc **r, unsigned int reg,\r\nint lid)\r\n{\r\nuasm_r_mips_pc16(r, *p, lid);\r\nISAFUNC(uasm_i_bgez)(p, reg, 0);\r\n}\r\nvoid ISAFUNC(uasm_il_bbit0)(u32 **p, struct uasm_reloc **r, unsigned int reg,\r\nunsigned int bit, int lid)\r\n{\r\nuasm_r_mips_pc16(r, *p, lid);\r\nISAFUNC(uasm_i_bbit0)(p, reg, bit, 0);\r\n}\r\nvoid ISAFUNC(uasm_il_bbit1)(u32 **p, struct uasm_reloc **r, unsigned int reg,\r\nunsigned int bit, int lid)\r\n{\r\nuasm_r_mips_pc16(r, *p, lid);\r\nISAFUNC(uasm_i_bbit1)(p, reg, bit, 0);\r\n}

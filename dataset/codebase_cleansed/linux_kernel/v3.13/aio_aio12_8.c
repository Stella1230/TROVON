static int aio_aio12_8_ai_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int range = CR_RANGE(insn->chanspec);\r\nunsigned int val;\r\nunsigned char control;\r\nint n;\r\ncontrol = AIO12_8_ADC_MODE_NORMAL | AIO12_8_ADC_ACQ_3USEC |\r\nAIO12_8_ADC_RANGE(range) | AIO12_8_ADC_CHAN(chan);\r\ninb(dev->iobase + AIO12_8_STATUS_REG);\r\nfor (n = 0; n < insn->n; n++) {\r\nint timeout = 5;\r\noutb(control, dev->iobase + AIO12_8_ADC_REG);\r\ndo {\r\nval = inb(dev->iobase + AIO12_8_STATUS_REG);\r\ntimeout--;\r\nif (timeout == 0) {\r\ndev_err(dev->class_dev, "ADC timeout\n");\r\nreturn -ETIMEDOUT;\r\n}\r\n} while (!(val & AIO12_8_STATUS_ADC_EOC));\r\ndata[n] = inw(dev->iobase + AIO12_8_ADC_REG) & s->maxdata;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int aio_aio12_8_ao_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nstruct aio12_8_private *devpriv = dev->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nint val = devpriv->ao_readback[chan];\r\nint i;\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = val;\r\nreturn insn->n;\r\n}\r\nstatic int aio_aio12_8_ao_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nstruct aio12_8_private *devpriv = dev->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned long port = dev->iobase + AIO12_8_DAC_REG(chan);\r\nunsigned int val = 0;\r\nint i;\r\noutb(AIO12_8_DAC_ENABLE_REF_ENA, dev->iobase + AIO12_8_DAC_ENABLE_REG);\r\nfor (i = 0; i < insn->n; i++) {\r\nval = data[i];\r\noutw(val, port);\r\n}\r\ndevpriv->ao_readback[chan] = val;\r\nreturn insn->n;\r\n}\r\nstatic int aio_aio12_8_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nconst struct aio12_8_boardtype *board = comedi_board(dev);\r\nstruct aio12_8_private *devpriv;\r\nstruct comedi_subdevice *s;\r\nint ret;\r\nret = comedi_request_region(dev, it->options[0], 32);\r\nif (ret)\r\nreturn ret;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\nret = comedi_alloc_subdevices(dev, 4);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\nif (board->ai_nchan) {\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND | SDF_DIFF;\r\ns->n_chan = board->ai_nchan;\r\ns->maxdata = 0x0fff;\r\ns->range_table = &range_aio_aio12_8;\r\ns->insn_read = aio_aio12_8_ai_read;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[1];\r\nif (board->ao_nchan) {\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE | SDF_GROUND | SDF_DIFF;\r\ns->n_chan = 4;\r\ns->maxdata = 0x0fff;\r\ns->range_table = &range_aio_aio12_8;\r\ns->insn_read = aio_aio12_8_ao_read;\r\ns->insn_write = aio_aio12_8_ao_write;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[2];\r\nret = subdev_8255_init(dev, s, NULL,\r\ndev->iobase + AIO12_8_8255_BASE_REG);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[3];\r\ns->type = COMEDI_SUBD_UNUSED;\r\ndev_info(dev->class_dev, "%s: %s attached\n",\r\ndev->driver->driver_name, dev->board_name);\r\nreturn 0;\r\n}

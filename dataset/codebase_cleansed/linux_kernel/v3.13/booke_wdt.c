static unsigned long long period_to_sec(unsigned int period)\r\n{\r\nunsigned long long tmp = 1ULL << (64 - period);\r\nunsigned long tmp2 = ppc_tb_freq;\r\ntmp2 = tmp2 / 5 * 2;\r\ndo_div(tmp, tmp2);\r\nreturn tmp;\r\n}\r\nstatic unsigned int sec_to_period(unsigned int secs)\r\n{\r\nunsigned int period;\r\nfor (period = 63; period > 0; period--) {\r\nif (period_to_sec(period) >= secs)\r\nreturn period;\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned long long period_to_sec(unsigned int period)\r\n{\r\nreturn period;\r\n}\r\nstatic unsigned int sec_to_period(unsigned int secs)\r\n{\r\nreturn secs;\r\n}\r\nstatic void __booke_wdt_set(void *data)\r\n{\r\nu32 val;\r\nval = mfspr(SPRN_TCR);\r\nval &= ~WDTP_MASK;\r\nval |= WDTP(booke_wdt_period);\r\nmtspr(SPRN_TCR, val);\r\n}\r\nstatic void booke_wdt_set(void)\r\n{\r\non_each_cpu(__booke_wdt_set, NULL, 0);\r\n}\r\nstatic void __booke_wdt_ping(void *data)\r\n{\r\nmtspr(SPRN_TSR, TSR_ENW|TSR_WIS);\r\n}\r\nstatic int booke_wdt_ping(struct watchdog_device *wdog)\r\n{\r\non_each_cpu(__booke_wdt_ping, NULL, 0);\r\nreturn 0;\r\n}\r\nstatic void __booke_wdt_enable(void *data)\r\n{\r\nu32 val;\r\n__booke_wdt_ping(NULL);\r\nval = mfspr(SPRN_TCR);\r\nval &= ~WDTP_MASK;\r\nval |= (TCR_WIE|TCR_WRC(WRC_CHIP)|WDTP(booke_wdt_period));\r\n#ifdef CONFIG_PPC_BOOK3E_64\r\nval &= ~TCR_WIE;\r\n#endif\r\nmtspr(SPRN_TCR, val);\r\n}\r\nstatic void __booke_wdt_disable(void *data)\r\n{\r\nu32 val;\r\nval = mfspr(SPRN_TCR);\r\nval &= ~(TCR_WIE | WDTP_MASK);\r\nmtspr(SPRN_TCR, val);\r\n__booke_wdt_ping(NULL);\r\n}\r\nstatic void __booke_wdt_start(struct watchdog_device *wdog)\r\n{\r\non_each_cpu(__booke_wdt_enable, NULL, 0);\r\npr_debug("watchdog enabled (timeout = %u sec)\n", wdog->timeout);\r\n}\r\nstatic int booke_wdt_start(struct watchdog_device *wdog)\r\n{\r\nif (booke_wdt_enabled == 0) {\r\nbooke_wdt_enabled = 1;\r\n__booke_wdt_start(wdog);\r\n}\r\nreturn 0;\r\n}\r\nstatic int booke_wdt_stop(struct watchdog_device *wdog)\r\n{\r\non_each_cpu(__booke_wdt_disable, NULL, 0);\r\nbooke_wdt_enabled = 0;\r\npr_debug("watchdog disabled\n");\r\nreturn 0;\r\n}\r\nstatic int booke_wdt_set_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int timeout)\r\n{\r\nif (timeout > MAX_WDT_TIMEOUT)\r\nreturn -EINVAL;\r\nbooke_wdt_period = sec_to_period(timeout);\r\nwdt_dev->timeout = timeout;\r\nbooke_wdt_set();\r\nreturn 0;\r\n}\r\nstatic void __exit booke_wdt_exit(void)\r\n{\r\nwatchdog_unregister_device(&booke_wdt_dev);\r\n}\r\nstatic int __init booke_wdt_init(void)\r\n{\r\nint ret = 0;\r\nbool nowayout = WATCHDOG_NOWAYOUT;\r\npr_info("powerpc book-e watchdog driver loaded\n");\r\nbooke_wdt_info.firmware_version = cur_cpu_spec->pvr_value;\r\nbooke_wdt_set_timeout(&booke_wdt_dev,\r\nperiod_to_sec(CONFIG_BOOKE_WDT_DEFAULT_TIMEOUT));\r\nwatchdog_set_nowayout(&booke_wdt_dev, nowayout);\r\nif (booke_wdt_enabled)\r\n__booke_wdt_start(&booke_wdt_dev);\r\nret = watchdog_register_device(&booke_wdt_dev);\r\nreturn ret;\r\n}

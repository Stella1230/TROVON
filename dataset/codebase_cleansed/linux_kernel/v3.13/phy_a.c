static inline u16 channel2freq_a(u8 channel)\r\n{\r\nB43_WARN_ON(channel > 200);\r\nreturn (5000 + 5 * channel);\r\n}\r\nstatic inline u16 freq_r3A_value(u16 frequency)\r\n{\r\nu16 value;\r\nif (frequency < 5091)\r\nvalue = 0x0040;\r\nelse if (frequency < 5321)\r\nvalue = 0x0000;\r\nelse if (frequency < 5806)\r\nvalue = 0x0080;\r\nelse\r\nvalue = 0x0040;\r\nreturn value;\r\n}\r\nstatic void b43_radio_set_tx_iq(struct b43_wldev *dev)\r\n{\r\nstatic const u8 data_high[5] = { 0x00, 0x40, 0x80, 0x90, 0xD0 };\r\nstatic const u8 data_low[5] = { 0x00, 0x01, 0x05, 0x06, 0x0A };\r\nu16 tmp = b43_radio_read16(dev, 0x001E);\r\nint i, j;\r\nfor (i = 0; i < 5; i++) {\r\nfor (j = 0; j < 5; j++) {\r\nif (tmp == (data_high[i] << 4 | data_low[j])) {\r\nb43_phy_write(dev, 0x0069,\r\n(i - j) << 8 | 0x00C0);\r\nreturn;\r\n}\r\n}\r\n}\r\n}\r\nstatic void aphy_channel_switch(struct b43_wldev *dev, unsigned int channel)\r\n{\r\nu16 freq, r8, tmp;\r\nfreq = channel2freq_a(channel);\r\nr8 = b43_radio_read16(dev, 0x0008);\r\nb43_write16(dev, 0x03F0, freq);\r\nb43_radio_write16(dev, 0x0008, r8);\r\ntmp = b43_radio_read16(dev, 0x002E);\r\ntmp &= 0x0080;\r\nb43_radio_write16(dev, 0x002E, tmp);\r\nif (freq >= 4920 && freq <= 5500) {\r\nr8 = 3 * freq / 116;\r\n}\r\nb43_radio_write16(dev, 0x0007, (r8 << 4) | r8);\r\nb43_radio_write16(dev, 0x0020, (r8 << 4) | r8);\r\nb43_radio_write16(dev, 0x0021, (r8 << 4) | r8);\r\nb43_radio_maskset(dev, 0x0022, 0x000F, (r8 << 4));\r\nb43_radio_write16(dev, 0x002A, (r8 << 4));\r\nb43_radio_write16(dev, 0x002B, (r8 << 4));\r\nb43_radio_maskset(dev, 0x0008, 0x00F0, (r8 << 4));\r\nb43_radio_maskset(dev, 0x0029, 0xFF0F, 0x00B0);\r\nb43_radio_write16(dev, 0x0035, 0x00AA);\r\nb43_radio_write16(dev, 0x0036, 0x0085);\r\nb43_radio_maskset(dev, 0x003A, 0xFF20, freq_r3A_value(freq));\r\nb43_radio_mask(dev, 0x003D, 0x00FF);\r\nb43_radio_maskset(dev, 0x0081, 0xFF7F, 0x0080);\r\nb43_radio_mask(dev, 0x0035, 0xFFEF);\r\nb43_radio_maskset(dev, 0x0035, 0xFFEF, 0x0010);\r\nb43_radio_set_tx_iq(dev);\r\n}\r\nstatic void b43_radio_init2060(struct b43_wldev *dev)\r\n{\r\nb43_radio_write16(dev, 0x0004, 0x00C0);\r\nb43_radio_write16(dev, 0x0005, 0x0008);\r\nb43_radio_write16(dev, 0x0009, 0x0040);\r\nb43_radio_write16(dev, 0x0005, 0x00AA);\r\nb43_radio_write16(dev, 0x0032, 0x008F);\r\nb43_radio_write16(dev, 0x0006, 0x008F);\r\nb43_radio_write16(dev, 0x0034, 0x008F);\r\nb43_radio_write16(dev, 0x002C, 0x0007);\r\nb43_radio_write16(dev, 0x0082, 0x0080);\r\nb43_radio_write16(dev, 0x0080, 0x0000);\r\nb43_radio_write16(dev, 0x003F, 0x00DA);\r\nb43_radio_mask(dev, 0x0005, ~0x0008);\r\nb43_radio_mask(dev, 0x0081, ~0x0010);\r\nb43_radio_mask(dev, 0x0081, ~0x0020);\r\nb43_radio_mask(dev, 0x0081, ~0x0020);\r\nmsleep(1);\r\nb43_radio_maskset(dev, 0x0081, ~0x0020, 0x0010);\r\nmsleep(1);\r\nb43_radio_maskset(dev, 0x0005, ~0x0008, 0x0008);\r\nb43_radio_mask(dev, 0x0085, ~0x0010);\r\nb43_radio_mask(dev, 0x0005, ~0x0008);\r\nb43_radio_mask(dev, 0x0081, ~0x0040);\r\nb43_radio_maskset(dev, 0x0081, ~0x0040, 0x0040);\r\nb43_radio_write16(dev, 0x0005,\r\n(b43_radio_read16(dev, 0x0081) & ~0x0008) | 0x0008);\r\nb43_phy_write(dev, 0x0063, 0xDDC6);\r\nb43_phy_write(dev, 0x0069, 0x07BE);\r\nb43_phy_write(dev, 0x006A, 0x0000);\r\naphy_channel_switch(dev, dev->phy.ops->get_default_chan(dev));\r\nmsleep(1);\r\n}\r\nstatic void b43_phy_rssiagc(struct b43_wldev *dev, u8 enable)\r\n{\r\nint i;\r\nif (dev->phy.rev < 3) {\r\nif (enable)\r\nfor (i = 0; i < B43_TAB_RSSIAGC1_SIZE; i++) {\r\nb43_ofdmtab_write16(dev,\r\nB43_OFDMTAB_LNAHPFGAIN1, i, 0xFFF8);\r\nb43_ofdmtab_write16(dev,\r\nB43_OFDMTAB_WRSSI, i, 0xFFF8);\r\n}\r\nelse\r\nfor (i = 0; i < B43_TAB_RSSIAGC1_SIZE; i++) {\r\nb43_ofdmtab_write16(dev,\r\nB43_OFDMTAB_LNAHPFGAIN1, i, b43_tab_rssiagc1[i]);\r\nb43_ofdmtab_write16(dev,\r\nB43_OFDMTAB_WRSSI, i, b43_tab_rssiagc1[i]);\r\n}\r\n} else {\r\nif (enable)\r\nfor (i = 0; i < B43_TAB_RSSIAGC1_SIZE; i++)\r\nb43_ofdmtab_write16(dev,\r\nB43_OFDMTAB_WRSSI, i, 0x0820);\r\nelse\r\nfor (i = 0; i < B43_TAB_RSSIAGC2_SIZE; i++)\r\nb43_ofdmtab_write16(dev,\r\nB43_OFDMTAB_WRSSI, i, b43_tab_rssiagc2[i]);\r\n}\r\n}\r\nstatic void b43_phy_ww(struct b43_wldev *dev)\r\n{\r\nu16 b, curr_s, best_s = 0xFFFF;\r\nint i;\r\nb43_phy_mask(dev, B43_PHY_CRS0, ~B43_PHY_CRS0_EN);\r\nb43_phy_set(dev, B43_PHY_OFDM(0x1B), 0x1000);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0x82), 0xF0FF, 0x0300);\r\nb43_radio_set(dev, 0x0009, 0x0080);\r\nb43_radio_maskset(dev, 0x0012, 0xFFFC, 0x0002);\r\nb43_wa_initgains(dev);\r\nb43_phy_write(dev, B43_PHY_OFDM(0xBA), 0x3ED5);\r\nb = b43_phy_read(dev, B43_PHY_PWRDOWN);\r\nb43_phy_write(dev, B43_PHY_PWRDOWN, (b & 0xFFF8) | 0x0005);\r\nb43_radio_set(dev, 0x0004, 0x0004);\r\nfor (i = 0x10; i <= 0x20; i++) {\r\nb43_radio_write16(dev, 0x0013, i);\r\ncurr_s = b43_phy_read(dev, B43_PHY_OTABLEQ) & 0x00FF;\r\nif (!curr_s) {\r\nbest_s = 0x0000;\r\nbreak;\r\n} else if (curr_s >= 0x0080)\r\ncurr_s = 0x0100 - curr_s;\r\nif (curr_s < best_s)\r\nbest_s = curr_s;\r\n}\r\nb43_phy_write(dev, B43_PHY_PWRDOWN, b);\r\nb43_radio_mask(dev, 0x0004, 0xFFFB);\r\nb43_radio_write16(dev, 0x0013, best_s);\r\nb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC1_R1, 0, 0xFFEC);\r\nb43_phy_write(dev, B43_PHY_OFDM(0xB7), 0x1E80);\r\nb43_phy_write(dev, B43_PHY_OFDM(0xB6), 0x1C00);\r\nb43_phy_write(dev, B43_PHY_OFDM(0xB5), 0x0EC0);\r\nb43_phy_write(dev, B43_PHY_OFDM(0xB2), 0x00C0);\r\nb43_phy_write(dev, B43_PHY_OFDM(0xB9), 0x1FFF);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xBB), 0xF000, 0x0053);\r\nb43_phy_maskset(dev, B43_PHY_OFDM61, 0xFE1F, 0x0120);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0x13), 0x0FFF, 0x3000);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0x14), 0x0FFF, 0x3000);\r\nb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC1, 6, 0x0017);\r\nfor (i = 0; i < 6; i++)\r\nb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC1, i, 0x000F);\r\nb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC1, 0x0D, 0x000E);\r\nb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC1, 0x0E, 0x0011);\r\nb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC1, 0x0F, 0x0013);\r\nb43_phy_write(dev, B43_PHY_OFDM(0x33), 0x5030);\r\nb43_phy_set(dev, B43_PHY_CRS0, B43_PHY_CRS0_EN);\r\n}\r\nstatic void hardware_pctl_init_aphy(struct b43_wldev *dev)\r\n{\r\n}\r\nvoid b43_phy_inita(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nB43_WARN_ON((phy->type != B43_PHYTYPE_A) &&\r\n(phy->type != B43_PHYTYPE_G));\r\nmight_sleep();\r\nif (phy->rev >= 6) {\r\nif (phy->type == B43_PHYTYPE_A)\r\nb43_phy_mask(dev, B43_PHY_OFDM(0x1B), ~0x1000);\r\nif (b43_phy_read(dev, B43_PHY_ENCORE) & B43_PHY_ENCORE_EN)\r\nb43_phy_set(dev, B43_PHY_ENCORE, 0x0010);\r\nelse\r\nb43_phy_mask(dev, B43_PHY_ENCORE, ~0x1010);\r\n}\r\nb43_wa_all(dev);\r\nif (phy->type == B43_PHYTYPE_A) {\r\nif (phy->gmode && (phy->rev < 3))\r\nb43_phy_set(dev, 0x0034, 0x0001);\r\nb43_phy_rssiagc(dev, 0);\r\nb43_phy_set(dev, B43_PHY_CRS0, B43_PHY_CRS0_EN);\r\nb43_radio_init2060(dev);\r\nif ((dev->dev->board_vendor == SSB_BOARDVENDOR_BCM) &&\r\n((dev->dev->board_type == SSB_BOARD_BU4306) ||\r\n(dev->dev->board_type == SSB_BOARD_BU4309))) {\r\n;\r\n}\r\nif (phy->rev >= 3)\r\nb43_phy_ww(dev);\r\nhardware_pctl_init_aphy(dev);\r\n}\r\nif ((phy->type == B43_PHYTYPE_G) &&\r\n(dev->dev->bus_sprom->boardflags_lo & B43_BFL_PACTRL)) {\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0x6E), 0xE000, 0x3CF);\r\n}\r\n}\r\nstatic int b43_aphy_init_tssi2dbm_table(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_a *aphy = phy->a;\r\ns16 pab0, pab1, pab2;\r\npab0 = (s16) (dev->dev->bus_sprom->pa1b0);\r\npab1 = (s16) (dev->dev->bus_sprom->pa1b1);\r\npab2 = (s16) (dev->dev->bus_sprom->pa1b2);\r\nif (pab0 != 0 && pab1 != 0 && pab2 != 0 &&\r\npab0 != -1 && pab1 != -1 && pab2 != -1) {\r\nif ((s8) dev->dev->bus_sprom->itssi_a != 0 &&\r\n(s8) dev->dev->bus_sprom->itssi_a != -1)\r\naphy->tgt_idle_tssi =\r\n(s8) (dev->dev->bus_sprom->itssi_a);\r\nelse\r\naphy->tgt_idle_tssi = 62;\r\naphy->tssi2dbm = b43_generate_dyn_tssi2dbm_tab(dev, pab0,\r\npab1, pab2);\r\nif (!aphy->tssi2dbm)\r\nreturn -ENOMEM;\r\n} else {\r\naphy->tssi2dbm = NULL;\r\nb43err(dev->wl, "Could not generate tssi2dBm "\r\n"table (wrong SPROM info)!\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int b43_aphy_op_allocate(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_a *aphy;\r\nint err;\r\naphy = kzalloc(sizeof(*aphy), GFP_KERNEL);\r\nif (!aphy)\r\nreturn -ENOMEM;\r\ndev->phy.a = aphy;\r\nerr = b43_aphy_init_tssi2dbm_table(dev);\r\nif (err)\r\ngoto err_free_aphy;\r\nreturn 0;\r\nerr_free_aphy:\r\nkfree(aphy);\r\ndev->phy.a = NULL;\r\nreturn err;\r\n}\r\nstatic void b43_aphy_op_prepare_structs(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_a *aphy = phy->a;\r\nconst void *tssi2dbm;\r\nint tgt_idle_tssi;\r\ntssi2dbm = aphy->tssi2dbm;\r\ntgt_idle_tssi = aphy->tgt_idle_tssi;\r\nmemset(aphy, 0, sizeof(*aphy));\r\naphy->tssi2dbm = tssi2dbm;\r\naphy->tgt_idle_tssi = tgt_idle_tssi;\r\n}\r\nstatic void b43_aphy_op_free(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_a *aphy = phy->a;\r\nkfree(aphy->tssi2dbm);\r\naphy->tssi2dbm = NULL;\r\nkfree(aphy);\r\ndev->phy.a = NULL;\r\n}\r\nstatic int b43_aphy_op_init(struct b43_wldev *dev)\r\n{\r\nb43_phy_inita(dev);\r\nreturn 0;\r\n}\r\nstatic inline u16 adjust_phyreg(struct b43_wldev *dev, u16 offset)\r\n{\r\nif ((offset & B43_PHYROUTE) == B43_PHYROUTE_OFDM_GPHY) {\r\noffset &= ~B43_PHYROUTE;\r\noffset |= B43_PHYROUTE_BASE;\r\n}\r\n#if B43_DEBUG\r\nif ((offset & B43_PHYROUTE) == B43_PHYROUTE_EXT_GPHY) {\r\nb43err(dev->wl, "Invalid EXT-G PHY access at "\r\n"0x%04X on A-PHY\n", offset);\r\ndump_stack();\r\n}\r\nif ((offset & B43_PHYROUTE) == B43_PHYROUTE_N_BMODE) {\r\nb43err(dev->wl, "Invalid N-BMODE PHY access at "\r\n"0x%04X on A-PHY\n", offset);\r\ndump_stack();\r\n}\r\n#endif\r\nreturn offset;\r\n}\r\nstatic u16 b43_aphy_op_read(struct b43_wldev *dev, u16 reg)\r\n{\r\nreg = adjust_phyreg(dev, reg);\r\nb43_write16(dev, B43_MMIO_PHY_CONTROL, reg);\r\nreturn b43_read16(dev, B43_MMIO_PHY_DATA);\r\n}\r\nstatic void b43_aphy_op_write(struct b43_wldev *dev, u16 reg, u16 value)\r\n{\r\nreg = adjust_phyreg(dev, reg);\r\nb43_write16(dev, B43_MMIO_PHY_CONTROL, reg);\r\nb43_write16(dev, B43_MMIO_PHY_DATA, value);\r\n}\r\nstatic u16 b43_aphy_op_radio_read(struct b43_wldev *dev, u16 reg)\r\n{\r\nB43_WARN_ON(reg == 1);\r\nreg |= 0x40;\r\nb43_write16(dev, B43_MMIO_RADIO_CONTROL, reg);\r\nreturn b43_read16(dev, B43_MMIO_RADIO_DATA_LOW);\r\n}\r\nstatic void b43_aphy_op_radio_write(struct b43_wldev *dev, u16 reg, u16 value)\r\n{\r\nB43_WARN_ON(reg == 1);\r\nb43_write16(dev, B43_MMIO_RADIO_CONTROL, reg);\r\nb43_write16(dev, B43_MMIO_RADIO_DATA_LOW, value);\r\n}\r\nstatic bool b43_aphy_op_supports_hwpctl(struct b43_wldev *dev)\r\n{\r\nreturn (dev->phy.rev >= 5);\r\n}\r\nstatic void b43_aphy_op_software_rfkill(struct b43_wldev *dev,\r\nbool blocked)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nif (!blocked) {\r\nif (phy->radio_on)\r\nreturn;\r\nb43_radio_write16(dev, 0x0004, 0x00C0);\r\nb43_radio_write16(dev, 0x0005, 0x0008);\r\nb43_phy_mask(dev, 0x0010, 0xFFF7);\r\nb43_phy_mask(dev, 0x0011, 0xFFF7);\r\nb43_radio_init2060(dev);\r\n} else {\r\nb43_radio_write16(dev, 0x0004, 0x00FF);\r\nb43_radio_write16(dev, 0x0005, 0x00FB);\r\nb43_phy_set(dev, 0x0010, 0x0008);\r\nb43_phy_set(dev, 0x0011, 0x0008);\r\n}\r\n}\r\nstatic int b43_aphy_op_switch_channel(struct b43_wldev *dev,\r\nunsigned int new_channel)\r\n{\r\nif (new_channel > 200)\r\nreturn -EINVAL;\r\naphy_channel_switch(dev, new_channel);\r\nreturn 0;\r\n}\r\nstatic unsigned int b43_aphy_op_get_default_chan(struct b43_wldev *dev)\r\n{\r\nreturn 36;\r\n}\r\nstatic void b43_aphy_op_set_rx_antenna(struct b43_wldev *dev, int antenna)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nu16 tmp;\r\nint autodiv = 0;\r\nif (antenna == B43_ANTENNA_AUTO0 || antenna == B43_ANTENNA_AUTO1)\r\nautodiv = 1;\r\nb43_hf_write(dev, b43_hf_read(dev) & ~B43_HF_ANTDIVHELP);\r\nb43_phy_maskset(dev, B43_PHY_BBANDCFG, ~B43_PHY_BBANDCFG_RXANT,\r\n(autodiv ? B43_ANTENNA_AUTO1 : antenna) <<\r\nB43_PHY_BBANDCFG_RXANT_SHIFT);\r\nif (autodiv) {\r\ntmp = b43_phy_read(dev, B43_PHY_ANTDWELL);\r\nif (antenna == B43_ANTENNA_AUTO1)\r\ntmp &= ~B43_PHY_ANTDWELL_AUTODIV1;\r\nelse\r\ntmp |= B43_PHY_ANTDWELL_AUTODIV1;\r\nb43_phy_write(dev, B43_PHY_ANTDWELL, tmp);\r\n}\r\nif (phy->rev < 3)\r\nb43_phy_maskset(dev, B43_PHY_ANTDWELL, 0xFF00, 0x24);\r\nelse {\r\nb43_phy_set(dev, B43_PHY_OFDM61, 0x10);\r\nif (phy->rev == 3) {\r\nb43_phy_write(dev, B43_PHY_CLIPPWRDOWNT, 0x1D);\r\nb43_phy_write(dev, B43_PHY_ADIVRELATED, 8);\r\n} else {\r\nb43_phy_write(dev, B43_PHY_CLIPPWRDOWNT, 0x3A);\r\nb43_phy_maskset(dev, B43_PHY_ADIVRELATED, 0xFF00, 8);\r\n}\r\n}\r\nb43_hf_write(dev, b43_hf_read(dev) | B43_HF_ANTDIVHELP);\r\n}\r\nstatic void b43_aphy_op_adjust_txpower(struct b43_wldev *dev)\r\n{\r\n}\r\nstatic enum b43_txpwr_result b43_aphy_op_recalc_txpower(struct b43_wldev *dev,\r\nbool ignore_tssi)\r\n{\r\nreturn B43_TXPWR_RES_DONE;\r\n}\r\nstatic void b43_aphy_op_pwork_15sec(struct b43_wldev *dev)\r\n{\r\n}\r\nstatic void b43_aphy_op_pwork_60sec(struct b43_wldev *dev)\r\n{\r\n}

static int ds1672_get_datetime(struct i2c_client *client, struct rtc_time *tm)\r\n{\r\nunsigned long time;\r\nunsigned char addr = DS1672_REG_CNT_BASE;\r\nunsigned char buf[4];\r\nstruct i2c_msg msgs[] = {\r\n{\r\n.addr = client->addr,\r\n.len = 1,\r\n.buf = &addr\r\n},\r\n{\r\n.addr = client->addr,\r\n.flags = I2C_M_RD,\r\n.len = 4,\r\n.buf = buf\r\n},\r\n};\r\nif ((i2c_transfer(client->adapter, &msgs[0], 2)) != 2) {\r\ndev_err(&client->dev, "%s: read error\n", __func__);\r\nreturn -EIO;\r\n}\r\ndev_dbg(&client->dev,\r\n"%s: raw read data - counters=%02x,%02x,%02x,%02x\n",\r\n__func__, buf[0], buf[1], buf[2], buf[3]);\r\ntime = (buf[3] << 24) | (buf[2] << 16) | (buf[1] << 8) | buf[0];\r\nrtc_time_to_tm(time, tm);\r\ndev_dbg(&client->dev, "%s: tm is secs=%d, mins=%d, hours=%d, "\r\n"mday=%d, mon=%d, year=%d, wday=%d\n",\r\n__func__, tm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year, tm->tm_wday);\r\nreturn 0;\r\n}\r\nstatic int ds1672_set_mmss(struct i2c_client *client, unsigned long secs)\r\n{\r\nint xfer;\r\nunsigned char buf[6];\r\nbuf[0] = DS1672_REG_CNT_BASE;\r\nbuf[1] = secs & 0x000000FF;\r\nbuf[2] = (secs & 0x0000FF00) >> 8;\r\nbuf[3] = (secs & 0x00FF0000) >> 16;\r\nbuf[4] = (secs & 0xFF000000) >> 24;\r\nbuf[5] = 0;\r\nxfer = i2c_master_send(client, buf, 6);\r\nif (xfer != 6) {\r\ndev_err(&client->dev, "%s: send: %d\n", __func__, xfer);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ds1672_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nreturn ds1672_get_datetime(to_i2c_client(dev), tm);\r\n}\r\nstatic int ds1672_rtc_set_mmss(struct device *dev, unsigned long secs)\r\n{\r\nreturn ds1672_set_mmss(to_i2c_client(dev), secs);\r\n}\r\nstatic int ds1672_get_control(struct i2c_client *client, u8 *status)\r\n{\r\nunsigned char addr = DS1672_REG_CONTROL;\r\nstruct i2c_msg msgs[] = {\r\n{\r\n.addr = client->addr,\r\n.len = 1,\r\n.buf = &addr\r\n},\r\n{\r\n.addr = client->addr,\r\n.flags = I2C_M_RD,\r\n.len = 1,\r\n.buf = status\r\n},\r\n};\r\nif ((i2c_transfer(client->adapter, &msgs[0], 2)) != 2) {\r\ndev_err(&client->dev, "%s: read error\n", __func__);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t show_control(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nu8 control;\r\nint err;\r\nerr = ds1672_get_control(client, &control);\r\nif (err)\r\nreturn err;\r\nreturn sprintf(buf, "%s\n", (control & DS1672_REG_CONTROL_EOSC)\r\n? "disabled" : "enabled");\r\n}\r\nstatic int ds1672_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nint err = 0;\r\nu8 control;\r\nstruct rtc_device *rtc;\r\ndev_dbg(&client->dev, "%s\n", __func__);\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C))\r\nreturn -ENODEV;\r\ndev_info(&client->dev, "chip found, driver version " DRV_VERSION "\n");\r\nrtc = devm_rtc_device_register(&client->dev, ds1672_driver.driver.name,\r\n&ds1672_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\ni2c_set_clientdata(client, rtc);\r\nerr = ds1672_get_control(client, &control);\r\nif (err)\r\ngoto exit_devreg;\r\nif (control & DS1672_REG_CONTROL_EOSC)\r\ndev_warn(&client->dev, "Oscillator not enabled. "\r\n"Set time to enable.\n");\r\nerr = device_create_file(&client->dev, &dev_attr_control);\r\nif (err)\r\ngoto exit_devreg;\r\nreturn 0;\r\nexit_devreg:\r\nreturn err;\r\n}

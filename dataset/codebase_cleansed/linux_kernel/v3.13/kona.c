void bcm_kona_setup_restart(void)\r\n{\r\nstruct device_node *np_wdog;\r\nnp_wdog = of_find_compatible_node(NULL, NULL, "brcm,kona-wdt");\r\nif (!np_wdog) {\r\npr_err("brcm,kona-wdt not found in DT, reboot disabled\n");\r\nreturn;\r\n}\r\nwatchdog_base = of_iomap(np_wdog, 0);\r\nWARN(!watchdog_base, "failed to map watchdog base");\r\nof_node_put(np_wdog);\r\n}\r\nvoid bcm_kona_restart(enum reboot_mode mode, const char *cmd)\r\n{\r\nuint32_t val;\r\nif (!watchdog_base)\r\npanic("Watchdog not mapped. Reboot failed.\n");\r\nval = readl(watchdog_base + SECWDOG_OFFSET);\r\nval &= SECWDOG_RESERVED_MASK | SECWDOG_WD_LOAD_FLAG_MASK;\r\nval |= SECWDOG_EN_MASK | SECWDOG_SRSTEN_MASK |\r\n(0x8 << SECWDOG_CLKS_SHIFT) |\r\n(0x8 << SECWDOG_LOCK_SHIFT);\r\nwritel(val, watchdog_base + SECWDOG_OFFSET);\r\nwhile (1)\r\n;\r\n}

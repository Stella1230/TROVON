int omap_msdi_reset(struct omap_hwmod *oh)\r\n{\r\nu16 v = 0;\r\nint c = 0;\r\nomap_hwmod_softreset(oh);\r\nv |= MSDI_CON_POW_MASK;\r\nv |= MSDI_TARGET_RESET_CLKD << MSDI_CON_CLKD_SHIFT;\r\nomap_hwmod_write(v, oh, MSDI_CON_OFFSET);\r\nomap_test_timeout((omap_hwmod_read(oh, oh->class->sysc->syss_offs)\r\n& SYSS_RESETDONE_MASK),\r\nMAX_MODULE_SOFTRESET_WAIT, c);\r\nif (c == MAX_MODULE_SOFTRESET_WAIT)\r\npr_warning("%s: %s: softreset failed (waited %d usec)\n",\r\n__func__, oh->name, MAX_MODULE_SOFTRESET_WAIT);\r\nelse\r\npr_debug("%s: %s: softreset in %d usec\n", __func__,\r\noh->name, c);\r\nv &= ~MSDI_CON_CLKD_MASK;\r\nomap_hwmod_write(v, oh, MSDI_CON_OFFSET);\r\nreturn 0;\r\n}\r\nstatic inline void omap242x_mmc_mux(struct omap_mmc_platform_data\r\n*mmc_controller)\r\n{\r\nif ((mmc_controller->slots[0].switch_pin > 0) && \\r\n(mmc_controller->slots[0].switch_pin < OMAP_MAX_GPIO_LINES))\r\nomap_mux_init_gpio(mmc_controller->slots[0].switch_pin,\r\nOMAP_PIN_INPUT_PULLUP);\r\nif ((mmc_controller->slots[0].gpio_wp > 0) && \\r\n(mmc_controller->slots[0].gpio_wp < OMAP_MAX_GPIO_LINES))\r\nomap_mux_init_gpio(mmc_controller->slots[0].gpio_wp,\r\nOMAP_PIN_INPUT_PULLUP);\r\nomap_mux_init_signal("sdmmc_cmd", 0);\r\nomap_mux_init_signal("sdmmc_clki", 0);\r\nomap_mux_init_signal("sdmmc_clko", 0);\r\nomap_mux_init_signal("sdmmc_dat0", 0);\r\nomap_mux_init_signal("sdmmc_dat_dir0", 0);\r\nomap_mux_init_signal("sdmmc_cmd_dir", 0);\r\nif (mmc_controller->slots[0].caps & MMC_CAP_4_BIT_DATA) {\r\nomap_mux_init_signal("sdmmc_dat1", 0);\r\nomap_mux_init_signal("sdmmc_dat2", 0);\r\nomap_mux_init_signal("sdmmc_dat3", 0);\r\nomap_mux_init_signal("sdmmc_dat_dir1", 0);\r\nomap_mux_init_signal("sdmmc_dat_dir2", 0);\r\nomap_mux_init_signal("sdmmc_dat_dir3", 0);\r\n}\r\nif (mmc_controller->slots[0].internal_clock) {\r\nu32 v = omap_ctrl_readl(OMAP2_CONTROL_DEVCONF0);\r\nv |= (1 << 24);\r\nomap_ctrl_writel(v, OMAP2_CONTROL_DEVCONF0);\r\n}\r\n}\r\nvoid __init omap242x_init_mmc(struct omap_mmc_platform_data **mmc_data)\r\n{\r\nstruct platform_device *pdev;\r\nstruct omap_hwmod *oh;\r\nint id = 0;\r\nchar *oh_name = "msdi1";\r\nchar *dev_name = "mmci-omap";\r\nif (!mmc_data[0]) {\r\npr_err("%s fails: Incomplete platform data\n", __func__);\r\nreturn;\r\n}\r\nomap242x_mmc_mux(mmc_data[0]);\r\noh = omap_hwmod_lookup(oh_name);\r\nif (!oh) {\r\npr_err("Could not look up %s\n", oh_name);\r\nreturn;\r\n}\r\npdev = omap_device_build(dev_name, id, oh, mmc_data[0],\r\nsizeof(struct omap_mmc_platform_data));\r\nif (IS_ERR(pdev))\r\nWARN(1, "Can'd build omap_device for %s:%s.\n",\r\ndev_name, oh->name);\r\n}

void dn_start_slow_timer(struct sock *sk)\r\n{\r\nsetup_timer(&sk->sk_timer, dn_slow_timer, (unsigned long)sk);\r\nsk_reset_timer(sk, &sk->sk_timer, jiffies + SLOW_INTERVAL);\r\n}\r\nvoid dn_stop_slow_timer(struct sock *sk)\r\n{\r\nsk_stop_timer(sk, &sk->sk_timer);\r\n}\r\nstatic void dn_slow_timer(unsigned long arg)\r\n{\r\nstruct sock *sk = (struct sock *)arg;\r\nstruct dn_scp *scp = DN_SK(sk);\r\nbh_lock_sock(sk);\r\nif (sock_owned_by_user(sk)) {\r\nsk_reset_timer(sk, &sk->sk_timer, jiffies + HZ / 10);\r\ngoto out;\r\n}\r\nif (scp->persist && scp->persist_fxn) {\r\nif (scp->persist <= SLOW_INTERVAL) {\r\nscp->persist = 0;\r\nif (scp->persist_fxn(sk))\r\ngoto out;\r\n} else {\r\nscp->persist -= SLOW_INTERVAL;\r\n}\r\n}\r\nif (scp->keepalive && scp->keepalive_fxn && (scp->state == DN_RUN)) {\r\nif ((jiffies - scp->stamp) >= scp->keepalive)\r\nscp->keepalive_fxn(sk);\r\n}\r\nsk_reset_timer(sk, &sk->sk_timer, jiffies + SLOW_INTERVAL);\r\nout:\r\nbh_unlock_sock(sk);\r\nsock_put(sk);\r\n}

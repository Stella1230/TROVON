int __atomic_add_return(int i, atomic_t *v)\r\n{\r\nint ret;\r\nunsigned long flags;\r\nspin_lock_irqsave(ATOMIC_HASH(v), flags);\r\nret = (v->counter += i);\r\nspin_unlock_irqrestore(ATOMIC_HASH(v), flags);\r\nreturn ret;\r\n}\r\nint atomic_cmpxchg(atomic_t *v, int old, int new)\r\n{\r\nint ret;\r\nunsigned long flags;\r\nspin_lock_irqsave(ATOMIC_HASH(v), flags);\r\nret = v->counter;\r\nif (likely(ret == old))\r\nv->counter = new;\r\nspin_unlock_irqrestore(ATOMIC_HASH(v), flags);\r\nreturn ret;\r\n}\r\nint __atomic_add_unless(atomic_t *v, int a, int u)\r\n{\r\nint ret;\r\nunsigned long flags;\r\nspin_lock_irqsave(ATOMIC_HASH(v), flags);\r\nret = v->counter;\r\nif (ret != u)\r\nv->counter += a;\r\nspin_unlock_irqrestore(ATOMIC_HASH(v), flags);\r\nreturn ret;\r\n}\r\nvoid atomic_set(atomic_t *v, int i)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(ATOMIC_HASH(v), flags);\r\nv->counter = i;\r\nspin_unlock_irqrestore(ATOMIC_HASH(v), flags);\r\n}\r\nunsigned long ___set_bit(unsigned long *addr, unsigned long mask)\r\n{\r\nunsigned long old, flags;\r\nspin_lock_irqsave(ATOMIC_HASH(addr), flags);\r\nold = *addr;\r\n*addr = old | mask;\r\nspin_unlock_irqrestore(ATOMIC_HASH(addr), flags);\r\nreturn old & mask;\r\n}\r\nunsigned long ___clear_bit(unsigned long *addr, unsigned long mask)\r\n{\r\nunsigned long old, flags;\r\nspin_lock_irqsave(ATOMIC_HASH(addr), flags);\r\nold = *addr;\r\n*addr = old & ~mask;\r\nspin_unlock_irqrestore(ATOMIC_HASH(addr), flags);\r\nreturn old & mask;\r\n}\r\nunsigned long ___change_bit(unsigned long *addr, unsigned long mask)\r\n{\r\nunsigned long old, flags;\r\nspin_lock_irqsave(ATOMIC_HASH(addr), flags);\r\nold = *addr;\r\n*addr = old ^ mask;\r\nspin_unlock_irqrestore(ATOMIC_HASH(addr), flags);\r\nreturn old & mask;\r\n}\r\nunsigned long __cmpxchg_u32(volatile u32 *ptr, u32 old, u32 new)\r\n{\r\nunsigned long flags;\r\nu32 prev;\r\nspin_lock_irqsave(ATOMIC_HASH(ptr), flags);\r\nif ((prev = *ptr) == old)\r\n*ptr = new;\r\nspin_unlock_irqrestore(ATOMIC_HASH(ptr), flags);\r\nreturn (unsigned long)prev;\r\n}

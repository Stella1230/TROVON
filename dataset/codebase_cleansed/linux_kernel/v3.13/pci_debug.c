static int pci_perf_show(struct seq_file *m, void *v)\r\n{\r\nstruct zpci_dev *zdev = m->private;\r\nu64 *stat;\r\nint i;\r\nif (!zdev)\r\nreturn 0;\r\nif (!zdev->fmb)\r\nreturn seq_printf(m, "FMB statistics disabled\n");\r\nseq_printf(m, "FMB @ %p\n", zdev->fmb);\r\nseq_printf(m, "Update interval: %u ms\n", zdev->fmb_update);\r\nseq_printf(m, "Samples: %u\n", zdev->fmb->samples);\r\nseq_printf(m, "Last update TOD: %Lx\n", zdev->fmb->last_update);\r\nstat = (u64 *) &zdev->fmb->ld_ops;\r\nfor (i = 0; i < 4; i++)\r\nseq_printf(m, "%26s:\t%llu\n",\r\npci_perf_names[i], *(stat + i));\r\nif (zdev->fmb->dma_valid)\r\nfor (i = 4; i < 6; i++)\r\nseq_printf(m, "%26s:\t%llu\n",\r\npci_perf_names[i], *(stat + i));\r\nfor (i = 6; i < ARRAY_SIZE(pci_perf_names); i++)\r\nseq_printf(m, "%26s:\t%llu\n",\r\npci_perf_names[i],\r\natomic64_read((atomic64_t *) (stat + i)));\r\nreturn 0;\r\n}\r\nstatic ssize_t pci_perf_seq_write(struct file *file, const char __user *ubuf,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct zpci_dev *zdev = ((struct seq_file *) file->private_data)->private;\r\nunsigned long val;\r\nint rc;\r\nif (!zdev)\r\nreturn 0;\r\nrc = kstrtoul_from_user(ubuf, count, 10, &val);\r\nif (rc)\r\nreturn rc;\r\nswitch (val) {\r\ncase 0:\r\nrc = zpci_fmb_disable_device(zdev);\r\nif (rc)\r\nreturn rc;\r\nbreak;\r\ncase 1:\r\nrc = zpci_fmb_enable_device(zdev);\r\nif (rc)\r\nreturn rc;\r\nbreak;\r\n}\r\nreturn count;\r\n}\r\nstatic int pci_perf_seq_open(struct inode *inode, struct file *filp)\r\n{\r\nreturn single_open(filp, pci_perf_show,\r\nfile_inode(filp)->i_private);\r\n}\r\nvoid zpci_debug_init_device(struct zpci_dev *zdev)\r\n{\r\nzdev->debugfs_dev = debugfs_create_dir(dev_name(&zdev->pdev->dev),\r\ndebugfs_root);\r\nif (IS_ERR(zdev->debugfs_dev))\r\nzdev->debugfs_dev = NULL;\r\nzdev->debugfs_perf = debugfs_create_file("statistics",\r\nS_IFREG | S_IRUGO | S_IWUSR,\r\nzdev->debugfs_dev, zdev,\r\n&debugfs_pci_perf_fops);\r\nif (IS_ERR(zdev->debugfs_perf))\r\nzdev->debugfs_perf = NULL;\r\n}\r\nvoid zpci_debug_exit_device(struct zpci_dev *zdev)\r\n{\r\ndebugfs_remove(zdev->debugfs_perf);\r\ndebugfs_remove(zdev->debugfs_dev);\r\n}\r\nint __init zpci_debug_init(void)\r\n{\r\npci_debug_msg_id = debug_register("pci_msg", 16, 1, 16 * sizeof(long));\r\nif (!pci_debug_msg_id)\r\nreturn -EINVAL;\r\ndebug_register_view(pci_debug_msg_id, &debug_sprintf_view);\r\ndebug_set_level(pci_debug_msg_id, 3);\r\npci_debug_err_id = debug_register("pci_error", 2, 1, 16);\r\nif (!pci_debug_err_id)\r\nreturn -EINVAL;\r\ndebug_register_view(pci_debug_err_id, &debug_hex_ascii_view);\r\ndebug_set_level(pci_debug_err_id, 6);\r\ndebugfs_root = debugfs_create_dir("pci", NULL);\r\nreturn 0;\r\n}\r\nvoid zpci_debug_exit(void)\r\n{\r\nif (pci_debug_msg_id)\r\ndebug_unregister(pci_debug_msg_id);\r\nif (pci_debug_err_id)\r\ndebug_unregister(pci_debug_err_id);\r\ndebugfs_remove(debugfs_root);\r\n}

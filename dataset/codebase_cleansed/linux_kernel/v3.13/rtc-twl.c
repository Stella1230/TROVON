static int twl_rtc_read_u8(u8 *data, u8 reg)\r\n{\r\nint ret;\r\nret = twl_i2c_read_u8(TWL_MODULE_RTC, data, (rtc_reg_map[reg]));\r\nif (ret < 0)\r\npr_err("twl_rtc: Could not read TWL"\r\n"register %X - error %d\n", reg, ret);\r\nreturn ret;\r\n}\r\nstatic int twl_rtc_write_u8(u8 data, u8 reg)\r\n{\r\nint ret;\r\nret = twl_i2c_write_u8(TWL_MODULE_RTC, data, (rtc_reg_map[reg]));\r\nif (ret < 0)\r\npr_err("twl_rtc: Could not write TWL"\r\n"register %X - error %d\n", reg, ret);\r\nreturn ret;\r\n}\r\nstatic int set_rtc_irq_bit(unsigned char bit)\r\n{\r\nunsigned char val;\r\nint ret;\r\nif (rtc_irq_bits & bit)\r\nreturn 0;\r\nval = rtc_irq_bits | bit;\r\nval &= ~BIT_RTC_INTERRUPTS_REG_EVERY_M;\r\nret = twl_rtc_write_u8(val, REG_RTC_INTERRUPTS_REG);\r\nif (ret == 0)\r\nrtc_irq_bits = val;\r\nreturn ret;\r\n}\r\nstatic int mask_rtc_irq_bit(unsigned char bit)\r\n{\r\nunsigned char val;\r\nint ret;\r\nif (!(rtc_irq_bits & bit))\r\nreturn 0;\r\nval = rtc_irq_bits & ~bit;\r\nret = twl_rtc_write_u8(val, REG_RTC_INTERRUPTS_REG);\r\nif (ret == 0)\r\nrtc_irq_bits = val;\r\nreturn ret;\r\n}\r\nstatic int twl_rtc_alarm_irq_enable(struct device *dev, unsigned enabled)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nint irq = platform_get_irq(pdev, 0);\r\nstatic bool twl_rtc_wake_enabled;\r\nint ret;\r\nif (enabled) {\r\nret = set_rtc_irq_bit(BIT_RTC_INTERRUPTS_REG_IT_ALARM_M);\r\nif (device_can_wakeup(dev) && !twl_rtc_wake_enabled) {\r\nenable_irq_wake(irq);\r\ntwl_rtc_wake_enabled = true;\r\n}\r\n} else {\r\nret = mask_rtc_irq_bit(BIT_RTC_INTERRUPTS_REG_IT_ALARM_M);\r\nif (twl_rtc_wake_enabled) {\r\ndisable_irq_wake(irq);\r\ntwl_rtc_wake_enabled = false;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int twl_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned char rtc_data[ALL_TIME_REGS];\r\nint ret;\r\nu8 save_control;\r\nu8 rtc_control;\r\nret = twl_rtc_read_u8(&save_control, REG_RTC_CTRL_REG);\r\nif (ret < 0) {\r\ndev_err(dev, "%s: reading CTRL_REG, error %d\n", __func__, ret);\r\nreturn ret;\r\n}\r\nif (twl_class_is_6030()) {\r\nif (save_control & BIT_RTC_CTRL_REG_GET_TIME_M) {\r\nsave_control &= ~BIT_RTC_CTRL_REG_GET_TIME_M;\r\nret = twl_rtc_write_u8(save_control, REG_RTC_CTRL_REG);\r\nif (ret < 0) {\r\ndev_err(dev, "%s clr GET_TIME, error %d\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\n}\r\n}\r\nrtc_control = save_control | BIT_RTC_CTRL_REG_GET_TIME_M;\r\nif (twl_class_is_6030())\r\nrtc_control |= BIT_RTC_CTRL_REG_RTC_V_OPT;\r\nret = twl_rtc_write_u8(rtc_control, REG_RTC_CTRL_REG);\r\nif (ret < 0) {\r\ndev_err(dev, "%s: writing CTRL_REG, error %d\n", __func__, ret);\r\nreturn ret;\r\n}\r\nret = twl_i2c_read(TWL_MODULE_RTC, rtc_data,\r\n(rtc_reg_map[REG_SECONDS_REG]), ALL_TIME_REGS);\r\nif (ret < 0) {\r\ndev_err(dev, "%s: reading data, error %d\n", __func__, ret);\r\nreturn ret;\r\n}\r\nif (twl_class_is_6030()) {\r\nret = twl_rtc_write_u8(save_control, REG_RTC_CTRL_REG);\r\nif (ret < 0) {\r\ndev_err(dev, "%s: restore CTRL_REG, error %d\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\n}\r\ntm->tm_sec = bcd2bin(rtc_data[0]);\r\ntm->tm_min = bcd2bin(rtc_data[1]);\r\ntm->tm_hour = bcd2bin(rtc_data[2]);\r\ntm->tm_mday = bcd2bin(rtc_data[3]);\r\ntm->tm_mon = bcd2bin(rtc_data[4]) - 1;\r\ntm->tm_year = bcd2bin(rtc_data[5]) + 100;\r\nreturn ret;\r\n}\r\nstatic int twl_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned char save_control;\r\nunsigned char rtc_data[ALL_TIME_REGS];\r\nint ret;\r\nrtc_data[0] = bin2bcd(tm->tm_sec);\r\nrtc_data[1] = bin2bcd(tm->tm_min);\r\nrtc_data[2] = bin2bcd(tm->tm_hour);\r\nrtc_data[3] = bin2bcd(tm->tm_mday);\r\nrtc_data[4] = bin2bcd(tm->tm_mon + 1);\r\nrtc_data[5] = bin2bcd(tm->tm_year - 100);\r\nret = twl_rtc_read_u8(&save_control, REG_RTC_CTRL_REG);\r\nif (ret < 0)\r\ngoto out;\r\nsave_control &= ~BIT_RTC_CTRL_REG_STOP_RTC_M;\r\nret = twl_rtc_write_u8(save_control, REG_RTC_CTRL_REG);\r\nif (ret < 0)\r\ngoto out;\r\nret = twl_i2c_write(TWL_MODULE_RTC, rtc_data,\r\n(rtc_reg_map[REG_SECONDS_REG]), ALL_TIME_REGS);\r\nif (ret < 0) {\r\ndev_err(dev, "rtc_set_time error %d\n", ret);\r\ngoto out;\r\n}\r\nsave_control |= BIT_RTC_CTRL_REG_STOP_RTC_M;\r\nret = twl_rtc_write_u8(save_control, REG_RTC_CTRL_REG);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int twl_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nunsigned char rtc_data[ALL_TIME_REGS];\r\nint ret;\r\nret = twl_i2c_read(TWL_MODULE_RTC, rtc_data,\r\n(rtc_reg_map[REG_ALARM_SECONDS_REG]), ALL_TIME_REGS);\r\nif (ret < 0) {\r\ndev_err(dev, "rtc_read_alarm error %d\n", ret);\r\nreturn ret;\r\n}\r\nalm->time.tm_sec = bcd2bin(rtc_data[0]);\r\nalm->time.tm_min = bcd2bin(rtc_data[1]);\r\nalm->time.tm_hour = bcd2bin(rtc_data[2]);\r\nalm->time.tm_mday = bcd2bin(rtc_data[3]);\r\nalm->time.tm_mon = bcd2bin(rtc_data[4]) - 1;\r\nalm->time.tm_year = bcd2bin(rtc_data[5]) + 100;\r\nif (rtc_irq_bits & BIT_RTC_INTERRUPTS_REG_IT_ALARM_M)\r\nalm->enabled = 1;\r\nreturn ret;\r\n}\r\nstatic int twl_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nunsigned char alarm_data[ALL_TIME_REGS];\r\nint ret;\r\nret = twl_rtc_alarm_irq_enable(dev, 0);\r\nif (ret)\r\ngoto out;\r\nalarm_data[0] = bin2bcd(alm->time.tm_sec);\r\nalarm_data[1] = bin2bcd(alm->time.tm_min);\r\nalarm_data[2] = bin2bcd(alm->time.tm_hour);\r\nalarm_data[3] = bin2bcd(alm->time.tm_mday);\r\nalarm_data[4] = bin2bcd(alm->time.tm_mon + 1);\r\nalarm_data[5] = bin2bcd(alm->time.tm_year - 100);\r\nret = twl_i2c_write(TWL_MODULE_RTC, alarm_data,\r\n(rtc_reg_map[REG_ALARM_SECONDS_REG]), ALL_TIME_REGS);\r\nif (ret) {\r\ndev_err(dev, "rtc_set_alarm error %d\n", ret);\r\ngoto out;\r\n}\r\nif (alm->enabled)\r\nret = twl_rtc_alarm_irq_enable(dev, 1);\r\nout:\r\nreturn ret;\r\n}\r\nstatic irqreturn_t twl_rtc_interrupt(int irq, void *rtc)\r\n{\r\nunsigned long events;\r\nint ret = IRQ_NONE;\r\nint res;\r\nu8 rd_reg;\r\nres = twl_rtc_read_u8(&rd_reg, REG_RTC_STATUS_REG);\r\nif (res)\r\ngoto out;\r\nif (rd_reg & BIT_RTC_STATUS_REG_ALARM_M)\r\nevents = RTC_IRQF | RTC_AF;\r\nelse\r\nevents = RTC_IRQF | RTC_PF;\r\nres = twl_rtc_write_u8(BIT_RTC_STATUS_REG_ALARM_M,\r\nREG_RTC_STATUS_REG);\r\nif (res)\r\ngoto out;\r\nif (twl_class_is_4030()) {\r\nres = twl_i2c_read_u8(TWL4030_MODULE_INT,\r\n&rd_reg, TWL4030_INT_PWR_ISR1);\r\nif (res)\r\ngoto out;\r\n}\r\nrtc_update_irq(rtc, 1, events);\r\nret = IRQ_HANDLED;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int twl_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc;\r\nint ret = -EINVAL;\r\nint irq = platform_get_irq(pdev, 0);\r\nu8 rd_reg;\r\nif (irq <= 0)\r\ngoto out1;\r\nif (twl_class_is_4030())\r\nrtc_reg_map = (u8 *)twl4030_rtc_reg_map;\r\nelse\r\nrtc_reg_map = (u8 *)twl6030_rtc_reg_map;\r\nret = twl_rtc_read_u8(&rd_reg, REG_RTC_STATUS_REG);\r\nif (ret < 0)\r\ngoto out1;\r\nif (rd_reg & BIT_RTC_STATUS_REG_POWER_UP_M)\r\ndev_warn(&pdev->dev, "Power up reset detected.\n");\r\nif (rd_reg & BIT_RTC_STATUS_REG_ALARM_M)\r\ndev_warn(&pdev->dev, "Pending Alarm interrupt detected.\n");\r\nret = twl_rtc_write_u8(rd_reg, REG_RTC_STATUS_REG);\r\nif (ret < 0)\r\ngoto out1;\r\nif (twl_class_is_6030()) {\r\ntwl6030_interrupt_unmask(TWL6030_RTC_INT_MASK,\r\nREG_INT_MSK_LINE_A);\r\ntwl6030_interrupt_unmask(TWL6030_RTC_INT_MASK,\r\nREG_INT_MSK_STS_A);\r\n}\r\ndev_info(&pdev->dev, "Enabling TWL-RTC\n");\r\nret = twl_rtc_write_u8(BIT_RTC_CTRL_REG_STOP_RTC_M, REG_RTC_CTRL_REG);\r\nif (ret < 0)\r\ngoto out1;\r\nret = twl_rtc_write_u8(0, REG_RTC_INTERRUPTS_REG);\r\nif (ret < 0)\r\ndev_warn(&pdev->dev, "unable to disable interrupt\n");\r\nret = twl_rtc_read_u8(&rtc_irq_bits, REG_RTC_INTERRUPTS_REG);\r\nif (ret < 0)\r\ngoto out1;\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nrtc = rtc_device_register(pdev->name,\r\n&pdev->dev, &twl_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc)) {\r\nret = PTR_ERR(rtc);\r\ndev_err(&pdev->dev, "can't register RTC device, err %ld\n",\r\nPTR_ERR(rtc));\r\ngoto out1;\r\n}\r\nret = request_threaded_irq(irq, NULL, twl_rtc_interrupt,\r\nIRQF_TRIGGER_RISING | IRQF_ONESHOT,\r\ndev_name(&rtc->dev), rtc);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "IRQ is not free.\n");\r\ngoto out2;\r\n}\r\nplatform_set_drvdata(pdev, rtc);\r\nreturn 0;\r\nout2:\r\nrtc_device_unregister(rtc);\r\nout1:\r\nreturn ret;\r\n}\r\nstatic int twl_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc = platform_get_drvdata(pdev);\r\nint irq = platform_get_irq(pdev, 0);\r\nmask_rtc_irq_bit(BIT_RTC_INTERRUPTS_REG_IT_ALARM_M);\r\nmask_rtc_irq_bit(BIT_RTC_INTERRUPTS_REG_IT_TIMER_M);\r\nif (twl_class_is_6030()) {\r\ntwl6030_interrupt_mask(TWL6030_RTC_INT_MASK,\r\nREG_INT_MSK_LINE_A);\r\ntwl6030_interrupt_mask(TWL6030_RTC_INT_MASK,\r\nREG_INT_MSK_STS_A);\r\n}\r\nfree_irq(irq, rtc);\r\nrtc_device_unregister(rtc);\r\nreturn 0;\r\n}\r\nstatic void twl_rtc_shutdown(struct platform_device *pdev)\r\n{\r\nmask_rtc_irq_bit(BIT_RTC_INTERRUPTS_REG_IT_TIMER_M);\r\n}\r\nstatic int twl_rtc_suspend(struct device *dev)\r\n{\r\nirqstat = rtc_irq_bits;\r\nmask_rtc_irq_bit(BIT_RTC_INTERRUPTS_REG_IT_TIMER_M);\r\nreturn 0;\r\n}\r\nstatic int twl_rtc_resume(struct device *dev)\r\n{\r\nset_rtc_irq_bit(irqstat);\r\nreturn 0;\r\n}

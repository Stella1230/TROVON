static int clk_prcmu_prepare(struct clk_hw *hw)\r\n{\r\nint ret;\r\nstruct clk_prcmu *clk = to_clk_prcmu(hw);\r\nret = prcmu_request_clock(clk->cg_sel, true);\r\nif (!ret)\r\nclk->is_prepared = 1;\r\nreturn ret;;\r\n}\r\nstatic void clk_prcmu_unprepare(struct clk_hw *hw)\r\n{\r\nstruct clk_prcmu *clk = to_clk_prcmu(hw);\r\nif (prcmu_request_clock(clk->cg_sel, false))\r\npr_err("clk_prcmu: %s failed to disable %s.\n", __func__,\r\n__clk_get_name(hw->clk));\r\nelse\r\nclk->is_prepared = 0;\r\n}\r\nstatic int clk_prcmu_is_prepared(struct clk_hw *hw)\r\n{\r\nstruct clk_prcmu *clk = to_clk_prcmu(hw);\r\nreturn clk->is_prepared;\r\n}\r\nstatic int clk_prcmu_enable(struct clk_hw *hw)\r\n{\r\nstruct clk_prcmu *clk = to_clk_prcmu(hw);\r\nclk->is_enabled = 1;\r\nreturn 0;\r\n}\r\nstatic void clk_prcmu_disable(struct clk_hw *hw)\r\n{\r\nstruct clk_prcmu *clk = to_clk_prcmu(hw);\r\nclk->is_enabled = 0;\r\n}\r\nstatic int clk_prcmu_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct clk_prcmu *clk = to_clk_prcmu(hw);\r\nreturn clk->is_enabled;\r\n}\r\nstatic unsigned long clk_prcmu_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_prcmu *clk = to_clk_prcmu(hw);\r\nreturn prcmu_clock_rate(clk->cg_sel);\r\n}\r\nstatic long clk_prcmu_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nstruct clk_prcmu *clk = to_clk_prcmu(hw);\r\nreturn prcmu_round_clock_rate(clk->cg_sel, rate);\r\n}\r\nstatic int clk_prcmu_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_prcmu *clk = to_clk_prcmu(hw);\r\nreturn prcmu_set_clock_rate(clk->cg_sel, rate);\r\n}\r\nstatic int clk_prcmu_opp_prepare(struct clk_hw *hw)\r\n{\r\nint err;\r\nstruct clk_prcmu *clk = to_clk_prcmu(hw);\r\nif (!clk->opp_requested) {\r\nerr = prcmu_qos_add_requirement(PRCMU_QOS_APE_OPP,\r\n(char *)__clk_get_name(hw->clk),\r\n100);\r\nif (err) {\r\npr_err("clk_prcmu: %s fail req APE OPP for %s.\n",\r\n__func__, __clk_get_name(hw->clk));\r\nreturn err;\r\n}\r\nclk->opp_requested = 1;\r\n}\r\nerr = prcmu_request_clock(clk->cg_sel, true);\r\nif (err) {\r\nprcmu_qos_remove_requirement(PRCMU_QOS_APE_OPP,\r\n(char *)__clk_get_name(hw->clk));\r\nclk->opp_requested = 0;\r\nreturn err;\r\n}\r\nclk->is_prepared = 1;\r\nreturn 0;\r\n}\r\nstatic void clk_prcmu_opp_unprepare(struct clk_hw *hw)\r\n{\r\nstruct clk_prcmu *clk = to_clk_prcmu(hw);\r\nif (prcmu_request_clock(clk->cg_sel, false)) {\r\npr_err("clk_prcmu: %s failed to disable %s.\n", __func__,\r\n__clk_get_name(hw->clk));\r\nreturn;\r\n}\r\nif (clk->opp_requested) {\r\nprcmu_qos_remove_requirement(PRCMU_QOS_APE_OPP,\r\n(char *)__clk_get_name(hw->clk));\r\nclk->opp_requested = 0;\r\n}\r\nclk->is_prepared = 0;\r\n}\r\nstatic int clk_prcmu_opp_volt_prepare(struct clk_hw *hw)\r\n{\r\nint err;\r\nstruct clk_prcmu *clk = to_clk_prcmu(hw);\r\nif (!clk->opp_requested) {\r\nerr = prcmu_request_ape_opp_100_voltage(true);\r\nif (err) {\r\npr_err("clk_prcmu: %s fail req APE OPP VOLT for %s.\n",\r\n__func__, __clk_get_name(hw->clk));\r\nreturn err;\r\n}\r\nclk->opp_requested = 1;\r\n}\r\nerr = prcmu_request_clock(clk->cg_sel, true);\r\nif (err) {\r\nprcmu_request_ape_opp_100_voltage(false);\r\nclk->opp_requested = 0;\r\nreturn err;\r\n}\r\nclk->is_prepared = 1;\r\nreturn 0;\r\n}\r\nstatic void clk_prcmu_opp_volt_unprepare(struct clk_hw *hw)\r\n{\r\nstruct clk_prcmu *clk = to_clk_prcmu(hw);\r\nif (prcmu_request_clock(clk->cg_sel, false)) {\r\npr_err("clk_prcmu: %s failed to disable %s.\n", __func__,\r\n__clk_get_name(hw->clk));\r\nreturn;\r\n}\r\nif (clk->opp_requested) {\r\nprcmu_request_ape_opp_100_voltage(false);\r\nclk->opp_requested = 0;\r\n}\r\nclk->is_prepared = 0;\r\n}\r\nstatic struct clk *clk_reg_prcmu(const char *name,\r\nconst char *parent_name,\r\nu8 cg_sel,\r\nunsigned long rate,\r\nunsigned long flags,\r\nstruct clk_ops *clk_prcmu_ops)\r\n{\r\nstruct clk_prcmu *clk;\r\nstruct clk_init_data clk_prcmu_init;\r\nstruct clk *clk_reg;\r\nif (!name) {\r\npr_err("clk_prcmu: %s invalid arguments passed\n", __func__);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nclk = kzalloc(sizeof(struct clk_prcmu), GFP_KERNEL);\r\nif (!clk) {\r\npr_err("clk_prcmu: %s could not allocate clk\n", __func__);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nclk->cg_sel = cg_sel;\r\nclk->is_prepared = 1;\r\nclk->is_enabled = 1;\r\nclk->opp_requested = 0;\r\nif (rate)\r\nprcmu_set_clock_rate(cg_sel, rate);\r\nclk_prcmu_init.name = name;\r\nclk_prcmu_init.ops = clk_prcmu_ops;\r\nclk_prcmu_init.flags = flags;\r\nclk_prcmu_init.parent_names = (parent_name ? &parent_name : NULL);\r\nclk_prcmu_init.num_parents = (parent_name ? 1 : 0);\r\nclk->hw.init = &clk_prcmu_init;\r\nclk_reg = clk_register(NULL, &clk->hw);\r\nif (IS_ERR_OR_NULL(clk_reg))\r\ngoto free_clk;\r\nreturn clk_reg;\r\nfree_clk:\r\nkfree(clk);\r\npr_err("clk_prcmu: %s failed to register clk\n", __func__);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nstruct clk *clk_reg_prcmu_scalable(const char *name,\r\nconst char *parent_name,\r\nu8 cg_sel,\r\nunsigned long rate,\r\nunsigned long flags)\r\n{\r\nreturn clk_reg_prcmu(name, parent_name, cg_sel, rate, flags,\r\n&clk_prcmu_scalable_ops);\r\n}\r\nstruct clk *clk_reg_prcmu_gate(const char *name,\r\nconst char *parent_name,\r\nu8 cg_sel,\r\nunsigned long flags)\r\n{\r\nreturn clk_reg_prcmu(name, parent_name, cg_sel, 0, flags,\r\n&clk_prcmu_gate_ops);\r\n}\r\nstruct clk *clk_reg_prcmu_scalable_rate(const char *name,\r\nconst char *parent_name,\r\nu8 cg_sel,\r\nunsigned long rate,\r\nunsigned long flags)\r\n{\r\nreturn clk_reg_prcmu(name, parent_name, cg_sel, rate, flags,\r\n&clk_prcmu_scalable_rate_ops);\r\n}\r\nstruct clk *clk_reg_prcmu_rate(const char *name,\r\nconst char *parent_name,\r\nu8 cg_sel,\r\nunsigned long flags)\r\n{\r\nreturn clk_reg_prcmu(name, parent_name, cg_sel, 0, flags,\r\n&clk_prcmu_rate_ops);\r\n}\r\nstruct clk *clk_reg_prcmu_opp_gate(const char *name,\r\nconst char *parent_name,\r\nu8 cg_sel,\r\nunsigned long flags)\r\n{\r\nreturn clk_reg_prcmu(name, parent_name, cg_sel, 0, flags,\r\n&clk_prcmu_opp_gate_ops);\r\n}\r\nstruct clk *clk_reg_prcmu_opp_volt_scalable(const char *name,\r\nconst char *parent_name,\r\nu8 cg_sel,\r\nunsigned long rate,\r\nunsigned long flags)\r\n{\r\nreturn clk_reg_prcmu(name, parent_name, cg_sel, rate, flags,\r\n&clk_prcmu_opp_volt_scalable_ops);\r\n}

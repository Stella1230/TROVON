static int snd_trident_probe(struct pci_dev *pci,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nstatic int dev;\r\nstruct snd_card *card;\r\nstruct snd_trident *trident;\r\nconst char *str;\r\nint err, pcm_dev = 0;\r\nif (dev >= SNDRV_CARDS)\r\nreturn -ENODEV;\r\nif (!enable[dev]) {\r\ndev++;\r\nreturn -ENOENT;\r\n}\r\nerr = snd_card_create(index[dev], id[dev], THIS_MODULE, 0, &card);\r\nif (err < 0)\r\nreturn err;\r\nif ((err = snd_trident_create(card, pci,\r\npcm_channels[dev],\r\n((pci->vendor << 16) | pci->device) == TRIDENT_DEVICE_ID_SI7018 ? 1 : 2,\r\nwavetable_size[dev],\r\n&trident)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\ncard->private_data = trident;\r\nswitch (trident->device) {\r\ncase TRIDENT_DEVICE_ID_DX:\r\nstr = "TRID4DWAVEDX";\r\nbreak;\r\ncase TRIDENT_DEVICE_ID_NX:\r\nstr = "TRID4DWAVENX";\r\nbreak;\r\ncase TRIDENT_DEVICE_ID_SI7018:\r\nstr = "SI7018";\r\nbreak;\r\ndefault:\r\nstr = "Unknown";\r\n}\r\nstrcpy(card->driver, str);\r\nif (trident->device == TRIDENT_DEVICE_ID_SI7018) {\r\nstrcpy(card->shortname, "SiS ");\r\n} else {\r\nstrcpy(card->shortname, "Trident ");\r\n}\r\nstrcat(card->shortname, card->driver);\r\nsprintf(card->longname, "%s PCI Audio at 0x%lx, irq %d",\r\ncard->shortname, trident->port, trident->irq);\r\nif ((err = snd_trident_pcm(trident, pcm_dev++, NULL)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nswitch (trident->device) {\r\ncase TRIDENT_DEVICE_ID_DX:\r\ncase TRIDENT_DEVICE_ID_NX:\r\nif ((err = snd_trident_foldback_pcm(trident, pcm_dev++, NULL)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nbreak;\r\n}\r\nif (trident->device == TRIDENT_DEVICE_ID_NX || trident->device == TRIDENT_DEVICE_ID_SI7018) {\r\nif ((err = snd_trident_spdif_pcm(trident, pcm_dev++, NULL)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\n}\r\nif (trident->device != TRIDENT_DEVICE_ID_SI7018 &&\r\n(err = snd_mpu401_uart_new(card, 0, MPU401_HW_TRID4DWAVE,\r\ntrident->midi_port,\r\nMPU401_INFO_INTEGRATED |\r\nMPU401_INFO_IRQ_HOOK,\r\n-1, &trident->rmidi)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nsnd_trident_create_gameport(trident);\r\nif ((err = snd_card_register(card)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\npci_set_drvdata(pci, card);\r\ndev++;\r\nreturn 0;\r\n}\r\nstatic void snd_trident_remove(struct pci_dev *pci)\r\n{\r\nsnd_card_free(pci_get_drvdata(pci));\r\n}

static unsigned long tegra20_clk_measure_input_freq(void)\r\n{\r\nu32 osc_ctrl = readl_relaxed(clk_base + OSC_CTRL);\r\nu32 auto_clk_control = osc_ctrl & OSC_CTRL_OSC_FREQ_MASK;\r\nu32 pll_ref_div = osc_ctrl & OSC_CTRL_PLL_REF_DIV_MASK;\r\nunsigned long input_freq;\r\nswitch (auto_clk_control) {\r\ncase OSC_CTRL_OSC_FREQ_12MHZ:\r\nBUG_ON(pll_ref_div != OSC_CTRL_PLL_REF_DIV_1);\r\ninput_freq = 12000000;\r\nbreak;\r\ncase OSC_CTRL_OSC_FREQ_13MHZ:\r\nBUG_ON(pll_ref_div != OSC_CTRL_PLL_REF_DIV_1);\r\ninput_freq = 13000000;\r\nbreak;\r\ncase OSC_CTRL_OSC_FREQ_19_2MHZ:\r\nBUG_ON(pll_ref_div != OSC_CTRL_PLL_REF_DIV_1);\r\ninput_freq = 19200000;\r\nbreak;\r\ncase OSC_CTRL_OSC_FREQ_26MHZ:\r\nBUG_ON(pll_ref_div != OSC_CTRL_PLL_REF_DIV_1);\r\ninput_freq = 26000000;\r\nbreak;\r\ndefault:\r\npr_err("Unexpected clock autodetect value %d",\r\nauto_clk_control);\r\nBUG();\r\nreturn 0;\r\n}\r\nreturn input_freq;\r\n}\r\nstatic unsigned int tegra20_get_pll_ref_div(void)\r\n{\r\nu32 pll_ref_div = readl_relaxed(clk_base + OSC_CTRL) &\r\nOSC_CTRL_PLL_REF_DIV_MASK;\r\nswitch (pll_ref_div) {\r\ncase OSC_CTRL_PLL_REF_DIV_1:\r\nreturn 1;\r\ncase OSC_CTRL_PLL_REF_DIV_2:\r\nreturn 2;\r\ncase OSC_CTRL_PLL_REF_DIV_4:\r\nreturn 4;\r\ndefault:\r\npr_err("Invalied pll ref divider %d\n", pll_ref_div);\r\nBUG();\r\n}\r\nreturn 0;\r\n}\r\nstatic void tegra20_pll_init(void)\r\n{\r\nstruct clk *clk;\r\nclk = tegra_clk_register_pll("pll_c", "pll_ref", clk_base, NULL, 0,\r\n0, &pll_c_params, TEGRA_PLL_HAS_CPCON,\r\npll_c_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_c", NULL);\r\nclks[pll_c] = clk;\r\nclk = tegra_clk_register_divider("pll_c_out1_div", "pll_c",\r\nclk_base + PLLC_OUT, 0, TEGRA_DIVIDER_ROUND_UP,\r\n8, 8, 1, NULL);\r\nclk = tegra_clk_register_pll_out("pll_c_out1", "pll_c_out1_div",\r\nclk_base + PLLC_OUT, 1, 0, CLK_SET_RATE_PARENT,\r\n0, NULL);\r\nclk_register_clkdev(clk, "pll_c_out1", NULL);\r\nclks[pll_c_out1] = clk;\r\nclk = tegra_clk_register_pll("pll_p", "pll_ref", clk_base, NULL, 0,\r\n216000000, &pll_p_params, TEGRA_PLL_FIXED |\r\nTEGRA_PLL_HAS_CPCON, pll_p_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_p", NULL);\r\nclks[pll_p] = clk;\r\nclk = tegra_clk_register_divider("pll_p_out1_div", "pll_p",\r\nclk_base + PLLP_OUTA, 0,\r\nTEGRA_DIVIDER_FIXED | TEGRA_DIVIDER_ROUND_UP,\r\n8, 8, 1, &pll_div_lock);\r\nclk = tegra_clk_register_pll_out("pll_p_out1", "pll_p_out1_div",\r\nclk_base + PLLP_OUTA, 1, 0,\r\nCLK_IGNORE_UNUSED | CLK_SET_RATE_PARENT, 0,\r\n&pll_div_lock);\r\nclk_register_clkdev(clk, "pll_p_out1", NULL);\r\nclks[pll_p_out1] = clk;\r\nclk = tegra_clk_register_divider("pll_p_out2_div", "pll_p",\r\nclk_base + PLLP_OUTA, 0,\r\nTEGRA_DIVIDER_FIXED | TEGRA_DIVIDER_ROUND_UP,\r\n24, 8, 1, &pll_div_lock);\r\nclk = tegra_clk_register_pll_out("pll_p_out2", "pll_p_out2_div",\r\nclk_base + PLLP_OUTA, 17, 16,\r\nCLK_IGNORE_UNUSED | CLK_SET_RATE_PARENT, 0,\r\n&pll_div_lock);\r\nclk_register_clkdev(clk, "pll_p_out2", NULL);\r\nclks[pll_p_out2] = clk;\r\nclk = tegra_clk_register_divider("pll_p_out3_div", "pll_p",\r\nclk_base + PLLP_OUTB, 0,\r\nTEGRA_DIVIDER_FIXED | TEGRA_DIVIDER_ROUND_UP,\r\n8, 8, 1, &pll_div_lock);\r\nclk = tegra_clk_register_pll_out("pll_p_out3", "pll_p_out3_div",\r\nclk_base + PLLP_OUTB, 1, 0,\r\nCLK_IGNORE_UNUSED | CLK_SET_RATE_PARENT, 0,\r\n&pll_div_lock);\r\nclk_register_clkdev(clk, "pll_p_out3", NULL);\r\nclks[pll_p_out3] = clk;\r\nclk = tegra_clk_register_divider("pll_p_out4_div", "pll_p",\r\nclk_base + PLLP_OUTB, 0,\r\nTEGRA_DIVIDER_FIXED | TEGRA_DIVIDER_ROUND_UP,\r\n24, 8, 1, &pll_div_lock);\r\nclk = tegra_clk_register_pll_out("pll_p_out4", "pll_p_out4_div",\r\nclk_base + PLLP_OUTB, 17, 16,\r\nCLK_IGNORE_UNUSED | CLK_SET_RATE_PARENT, 0,\r\n&pll_div_lock);\r\nclk_register_clkdev(clk, "pll_p_out4", NULL);\r\nclks[pll_p_out4] = clk;\r\nclk = tegra_clk_register_pll("pll_m", "pll_ref", clk_base, NULL,\r\nCLK_IGNORE_UNUSED | CLK_SET_RATE_GATE, 0,\r\n&pll_m_params, TEGRA_PLL_HAS_CPCON,\r\npll_m_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_m", NULL);\r\nclks[pll_m] = clk;\r\nclk = tegra_clk_register_divider("pll_m_out1_div", "pll_m",\r\nclk_base + PLLM_OUT, 0, TEGRA_DIVIDER_ROUND_UP,\r\n8, 8, 1, NULL);\r\nclk = tegra_clk_register_pll_out("pll_m_out1", "pll_m_out1_div",\r\nclk_base + PLLM_OUT, 1, 0, CLK_IGNORE_UNUSED |\r\nCLK_SET_RATE_PARENT, 0, NULL);\r\nclk_register_clkdev(clk, "pll_m_out1", NULL);\r\nclks[pll_m_out1] = clk;\r\nclk = tegra_clk_register_pll("pll_x", "pll_ref", clk_base, NULL, 0,\r\n0, &pll_x_params, TEGRA_PLL_HAS_CPCON,\r\npll_x_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_x", NULL);\r\nclks[pll_x] = clk;\r\nclk = tegra_clk_register_pll("pll_u", "pll_ref", clk_base, NULL, 0,\r\n0, &pll_u_params, TEGRA_PLLU | TEGRA_PLL_HAS_CPCON,\r\npll_u_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_u", NULL);\r\nclks[pll_u] = clk;\r\nclk = tegra_clk_register_pll("pll_d", "pll_ref", clk_base, NULL, 0,\r\n0, &pll_d_params, TEGRA_PLL_HAS_CPCON,\r\npll_d_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_d", NULL);\r\nclks[pll_d] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_d_out0", "pll_d",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclk_register_clkdev(clk, "pll_d_out0", NULL);\r\nclks[pll_d_out0] = clk;\r\nclk = tegra_clk_register_pll("pll_a", "pll_p_out1", clk_base, NULL, 0,\r\n0, &pll_a_params, TEGRA_PLL_HAS_CPCON,\r\npll_a_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_a", NULL);\r\nclks[pll_a] = clk;\r\nclk = tegra_clk_register_divider("pll_a_out0_div", "pll_a",\r\nclk_base + PLLA_OUT, 0, TEGRA_DIVIDER_ROUND_UP,\r\n8, 8, 1, NULL);\r\nclk = tegra_clk_register_pll_out("pll_a_out0", "pll_a_out0_div",\r\nclk_base + PLLA_OUT, 1, 0, CLK_IGNORE_UNUSED |\r\nCLK_SET_RATE_PARENT, 0, NULL);\r\nclk_register_clkdev(clk, "pll_a_out0", NULL);\r\nclks[pll_a_out0] = clk;\r\nclk = tegra_clk_register_plle("pll_e", "pll_ref", clk_base, pmc_base,\r\n0, 100000000, &pll_e_params,\r\n0, pll_e_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_e", NULL);\r\nclks[pll_e] = clk;\r\n}\r\nstatic void tegra20_super_clk_init(void)\r\n{\r\nstruct clk *clk;\r\nclk = tegra_clk_register_super_mux("cclk", cclk_parents,\r\nARRAY_SIZE(cclk_parents), CLK_SET_RATE_PARENT,\r\nclk_base + CCLK_BURST_POLICY, 0, 4, 0, 0, NULL);\r\nclk_register_clkdev(clk, "cclk", NULL);\r\nclks[cclk] = clk;\r\nclk = tegra_clk_register_super_mux("sclk", sclk_parents,\r\nARRAY_SIZE(sclk_parents), CLK_SET_RATE_PARENT,\r\nclk_base + SCLK_BURST_POLICY, 0, 4, 0, 0, NULL);\r\nclk_register_clkdev(clk, "sclk", NULL);\r\nclks[sclk] = clk;\r\nclk = clk_register_divider(NULL, "hclk_div", "sclk", 0,\r\nclk_base + CLK_SYSTEM_RATE, 4, 2, 0,\r\n&sysrate_lock);\r\nclk = clk_register_gate(NULL, "hclk", "hclk_div", CLK_SET_RATE_PARENT,\r\nclk_base + CLK_SYSTEM_RATE, 7,\r\nCLK_GATE_SET_TO_DISABLE, &sysrate_lock);\r\nclk_register_clkdev(clk, "hclk", NULL);\r\nclks[hclk] = clk;\r\nclk = clk_register_divider(NULL, "pclk_div", "hclk", 0,\r\nclk_base + CLK_SYSTEM_RATE, 0, 2, 0,\r\n&sysrate_lock);\r\nclk = clk_register_gate(NULL, "pclk", "pclk_div", CLK_SET_RATE_PARENT,\r\nclk_base + CLK_SYSTEM_RATE, 3,\r\nCLK_GATE_SET_TO_DISABLE, &sysrate_lock);\r\nclk_register_clkdev(clk, "pclk", NULL);\r\nclks[pclk] = clk;\r\nclk = clk_register_fixed_factor(NULL, "twd", "cclk", 0, 1, 4);\r\nclk_register_clkdev(clk, "twd", NULL);\r\nclks[twd] = clk;\r\n}\r\nstatic void __init tegra20_audio_clk_init(void)\r\n{\r\nstruct clk *clk;\r\nclk = clk_register_mux(NULL, "audio_mux", audio_parents,\r\nARRAY_SIZE(audio_parents),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + AUDIO_SYNC_CLK, 0, 3, 0, NULL);\r\nclk = clk_register_gate(NULL, "audio", "audio_mux", 0,\r\nclk_base + AUDIO_SYNC_CLK, 4,\r\nCLK_GATE_SET_TO_DISABLE, NULL);\r\nclk_register_clkdev(clk, "audio", NULL);\r\nclks[audio] = clk;\r\nclk = clk_register_fixed_factor(NULL, "audio_doubler", "audio",\r\nCLK_SET_RATE_PARENT, 2, 1);\r\nclk = tegra_clk_register_periph_gate("audio_2x", "audio_doubler",\r\nTEGRA_PERIPH_NO_RESET, clk_base,\r\nCLK_SET_RATE_PARENT, 89, &periph_u_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "audio_2x", NULL);\r\nclks[audio_2x] = clk;\r\n}\r\nstatic void __init tegra20_periph_clk_init(void)\r\n{\r\nstruct tegra_periph_init_data *data;\r\nstruct clk *clk;\r\nint i;\r\nclk = tegra_clk_register_periph_gate("ac97", "pll_a_out0",\r\nTEGRA_PERIPH_ON_APB,\r\nclk_base, 0, 3, &periph_l_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, NULL, "tegra20-ac97");\r\nclks[ac97] = clk;\r\nclk = tegra_clk_register_periph_gate("apbdma", "pclk", 0, clk_base,\r\n0, 34, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, NULL, "tegra-apbdma");\r\nclks[apbdma] = clk;\r\nclk = tegra_clk_register_periph_gate("rtc", "clk_32k",\r\nTEGRA_PERIPH_NO_RESET,\r\nclk_base, 0, 4, &periph_l_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, NULL, "rtc-tegra");\r\nclks[rtc] = clk;\r\nclk = tegra_clk_register_periph_gate("timer", "clk_m", 0, clk_base,\r\n0, 5, &periph_l_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, NULL, "timer");\r\nclks[timer] = clk;\r\nclk = tegra_clk_register_periph_gate("kbc", "clk_32k",\r\nTEGRA_PERIPH_NO_RESET | TEGRA_PERIPH_ON_APB,\r\nclk_base, 0, 36, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, NULL, "tegra-kbc");\r\nclks[kbc] = clk;\r\nclk = tegra_clk_register_periph_gate("csus", "clk_m",\r\nTEGRA_PERIPH_NO_RESET,\r\nclk_base, 0, 92, &periph_u_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "csus", "tengra_camera");\r\nclks[csus] = clk;\r\nclk = tegra_clk_register_periph_gate("vcp", "clk_m", 0,\r\nclk_base, 0, 29, &periph_l_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "vcp", "tegra-avp");\r\nclks[vcp] = clk;\r\nclk = tegra_clk_register_periph_gate("bsea", "clk_m", 0,\r\nclk_base, 0, 62, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "bsea", "tegra-avp");\r\nclks[bsea] = clk;\r\nclk = tegra_clk_register_periph_gate("bsev", "clk_m", 0,\r\nclk_base, 0, 63, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "bsev", "tegra-aes");\r\nclks[bsev] = clk;\r\nclk = clk_register_mux(NULL, "emc_mux", mux_pllmcp_clkm,\r\nARRAY_SIZE(mux_pllmcp_clkm),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + CLK_SOURCE_EMC,\r\n30, 2, 0, NULL);\r\nclk = tegra_clk_register_periph_gate("emc", "emc_mux", 0, clk_base, 0,\r\n57, &periph_h_regs, periph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "emc", NULL);\r\nclks[emc] = clk;\r\nclk = tegra_clk_register_periph_gate("usbd", "clk_m", 0, clk_base, 0,\r\n22, &periph_l_regs, periph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, NULL, "fsl-tegra-udc");\r\nclks[usbd] = clk;\r\nclk = tegra_clk_register_periph_gate("usb2", "clk_m", 0, clk_base, 0,\r\n58, &periph_h_regs, periph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, NULL, "tegra-ehci.1");\r\nclks[usb2] = clk;\r\nclk = tegra_clk_register_periph_gate("usb3", "clk_m", 0, clk_base, 0,\r\n59, &periph_h_regs, periph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, NULL, "tegra-ehci.2");\r\nclks[usb3] = clk;\r\nclk = tegra_clk_register_periph_gate("dsi", "pll_d", 0, clk_base, 0,\r\n48, &periph_h_regs, periph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, NULL, "dsi");\r\nclks[dsi] = clk;\r\nclk = tegra_clk_register_periph_gate("csi", "pll_p_out3", 0, clk_base,\r\n0, 52, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "csi", "tegra_camera");\r\nclks[csi] = clk;\r\nclk = tegra_clk_register_periph_gate("isp", "clk_m", 0, clk_base, 0, 23,\r\n&periph_l_regs, periph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "isp", "tegra_camera");\r\nclks[isp] = clk;\r\nclk = tegra_clk_register_periph_gate("pex", "clk_m", 0, clk_base, 0, 70,\r\n&periph_u_regs, periph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "pex", NULL);\r\nclks[pex] = clk;\r\nclk = tegra_clk_register_periph_gate("afi", "clk_m", 0, clk_base, 0, 72,\r\n&periph_u_regs, periph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "afi", NULL);\r\nclks[afi] = clk;\r\nclk = tegra_clk_register_periph_gate("pcie_xclk", "clk_m", 0, clk_base,\r\n0, 74, &periph_u_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "pcie_xclk", NULL);\r\nclks[pcie_xclk] = clk;\r\nclk = clk_register_fixed_rate(NULL, "cdev1_fixed", NULL, CLK_IS_ROOT,\r\n26000000);\r\nclk = tegra_clk_register_periph_gate("cdev1", "cdev1_fixed", 0,\r\nclk_base, 0, 94, &periph_u_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "cdev1", NULL);\r\nclks[cdev1] = clk;\r\nclk = clk_register_fixed_rate(NULL, "cdev2_fixed", NULL, CLK_IS_ROOT,\r\n26000000);\r\nclk = tegra_clk_register_periph_gate("cdev2", "cdev2_fixed", 0,\r\nclk_base, 0, 93, &periph_u_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "cdev2", NULL);\r\nclks[cdev2] = clk;\r\nfor (i = 0; i < ARRAY_SIZE(tegra_periph_clk_list); i++) {\r\ndata = &tegra_periph_clk_list[i];\r\nclk = tegra_clk_register_periph(data->name, data->parent_names,\r\ndata->num_parents, &data->periph,\r\nclk_base, data->offset, data->flags);\r\nclk_register_clkdev(clk, data->con_id, data->dev_id);\r\nclks[data->clk_id] = clk;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(tegra_periph_nodiv_clk_list); i++) {\r\ndata = &tegra_periph_nodiv_clk_list[i];\r\nclk = tegra_clk_register_periph_nodiv(data->name,\r\ndata->parent_names,\r\ndata->num_parents, &data->periph,\r\nclk_base, data->offset);\r\nclk_register_clkdev(clk, data->con_id, data->dev_id);\r\nclks[data->clk_id] = clk;\r\n}\r\n}\r\nstatic void __init tegra20_fixed_clk_init(void)\r\n{\r\nstruct clk *clk;\r\nclk = clk_register_fixed_rate(NULL, "clk_32k", NULL, CLK_IS_ROOT,\r\n32768);\r\nclk_register_clkdev(clk, "clk_32k", NULL);\r\nclks[clk_32k] = clk;\r\n}\r\nstatic void __init tegra20_pmc_clk_init(void)\r\n{\r\nstruct clk *clk;\r\nwritel_relaxed(0, pmc_base + PMC_BLINK_TIMER);\r\nclk = clk_register_gate(NULL, "blink_override", "clk_32k", 0,\r\npmc_base + PMC_DPD_PADS_ORIDE,\r\nPMC_DPD_PADS_ORIDE_BLINK_ENB, 0, NULL);\r\nclk = clk_register_gate(NULL, "blink", "blink_override", 0,\r\npmc_base + PMC_CTRL,\r\nPMC_CTRL_BLINK_ENB, 0, NULL);\r\nclk_register_clkdev(clk, "blink", NULL);\r\nclks[blink] = clk;\r\n}\r\nstatic void __init tegra20_osc_clk_init(void)\r\n{\r\nstruct clk *clk;\r\nunsigned long input_freq;\r\nunsigned int pll_ref_div;\r\ninput_freq = tegra20_clk_measure_input_freq();\r\nclk = clk_register_fixed_rate(NULL, "clk_m", NULL, CLK_IS_ROOT |\r\nCLK_IGNORE_UNUSED, input_freq);\r\nclk_register_clkdev(clk, "clk_m", NULL);\r\nclks[clk_m] = clk;\r\npll_ref_div = tegra20_get_pll_ref_div();\r\nclk = clk_register_fixed_factor(NULL, "pll_ref", "clk_m",\r\nCLK_SET_RATE_PARENT, 1, pll_ref_div);\r\nclk_register_clkdev(clk, "pll_ref", NULL);\r\nclks[pll_ref] = clk;\r\n}\r\nstatic void tegra20_wait_cpu_in_reset(u32 cpu)\r\n{\r\nunsigned int reg;\r\ndo {\r\nreg = readl(clk_base +\r\nTEGRA_CLK_RST_CONTROLLER_RST_CPU_CMPLX_SET);\r\ncpu_relax();\r\n} while (!(reg & (1 << cpu)));\r\nreturn;\r\n}\r\nstatic void tegra20_put_cpu_in_reset(u32 cpu)\r\n{\r\nwritel(CPU_RESET(cpu),\r\nclk_base + TEGRA_CLK_RST_CONTROLLER_RST_CPU_CMPLX_SET);\r\ndmb();\r\n}\r\nstatic void tegra20_cpu_out_of_reset(u32 cpu)\r\n{\r\nwritel(CPU_RESET(cpu),\r\nclk_base + TEGRA_CLK_RST_CONTROLLER_RST_CPU_CMPLX_CLR);\r\nwmb();\r\n}\r\nstatic void tegra20_enable_cpu_clock(u32 cpu)\r\n{\r\nunsigned int reg;\r\nreg = readl(clk_base + TEGRA_CLK_RST_CONTROLLER_CLK_CPU_CMPLX);\r\nwritel(reg & ~CPU_CLOCK(cpu),\r\nclk_base + TEGRA_CLK_RST_CONTROLLER_CLK_CPU_CMPLX);\r\nbarrier();\r\nreg = readl(clk_base + TEGRA_CLK_RST_CONTROLLER_CLK_CPU_CMPLX);\r\n}\r\nstatic void tegra20_disable_cpu_clock(u32 cpu)\r\n{\r\nunsigned int reg;\r\nreg = readl(clk_base + TEGRA_CLK_RST_CONTROLLER_CLK_CPU_CMPLX);\r\nwritel(reg | CPU_CLOCK(cpu),\r\nclk_base + TEGRA_CLK_RST_CONTROLLER_CLK_CPU_CMPLX);\r\n}\r\nstatic bool tegra20_cpu_rail_off_ready(void)\r\n{\r\nunsigned int cpu_rst_status;\r\ncpu_rst_status = readl(clk_base +\r\nTEGRA_CLK_RST_CONTROLLER_RST_CPU_CMPLX_SET);\r\nreturn !!(cpu_rst_status & 0x2);\r\n}\r\nstatic void tegra20_cpu_clock_suspend(void)\r\n{\r\ntegra20_cpu_clk_sctx.clk_csite_src =\r\nreadl(clk_base + CLK_SOURCE_CSITE);\r\nwritel(3<<30, clk_base + CLK_SOURCE_CSITE);\r\ntegra20_cpu_clk_sctx.cpu_burst =\r\nreadl(clk_base + CCLK_BURST_POLICY);\r\ntegra20_cpu_clk_sctx.pllx_base =\r\nreadl(clk_base + PLLX_BASE);\r\ntegra20_cpu_clk_sctx.pllx_misc =\r\nreadl(clk_base + PLLX_MISC);\r\ntegra20_cpu_clk_sctx.cclk_divider =\r\nreadl(clk_base + SUPER_CCLK_DIVIDER);\r\n}\r\nstatic void tegra20_cpu_clock_resume(void)\r\n{\r\nunsigned int reg, policy;\r\nreg = readl(clk_base + CCLK_BURST_POLICY);\r\npolicy = (reg >> CCLK_BURST_POLICY_SHIFT) & 0xF;\r\nif (policy == CCLK_IDLE_POLICY)\r\nreg = (reg >> CCLK_IDLE_POLICY_SHIFT) & 0xF;\r\nelse if (policy == CCLK_RUN_POLICY)\r\nreg = (reg >> CCLK_RUN_POLICY_SHIFT) & 0xF;\r\nelse\r\nBUG();\r\nif (reg != CCLK_BURST_POLICY_PLLX) {\r\nwritel(tegra20_cpu_clk_sctx.pllx_misc,\r\nclk_base + PLLX_MISC);\r\nwritel(tegra20_cpu_clk_sctx.pllx_base,\r\nclk_base + PLLX_BASE);\r\nif (tegra20_cpu_clk_sctx.pllx_base & (1 << 30))\r\nudelay(300);\r\n}\r\nwritel(tegra20_cpu_clk_sctx.cclk_divider,\r\nclk_base + SUPER_CCLK_DIVIDER);\r\nwritel(tegra20_cpu_clk_sctx.cpu_burst,\r\nclk_base + CCLK_BURST_POLICY);\r\nwritel(tegra20_cpu_clk_sctx.clk_csite_src,\r\nclk_base + CLK_SOURCE_CSITE);\r\n}\r\nstatic void __init tegra20_clock_apply_init_table(void)\r\n{\r\ntegra_init_from_table(init_table, clks, clk_max);\r\n}\r\nstatic void __init tegra20_clock_init(struct device_node *np)\r\n{\r\nint i;\r\nstruct device_node *node;\r\nclk_base = of_iomap(np, 0);\r\nif (!clk_base) {\r\npr_err("Can't map CAR registers\n");\r\nBUG();\r\n}\r\nnode = of_find_matching_node(NULL, pmc_match);\r\nif (!node) {\r\npr_err("Failed to find pmc node\n");\r\nBUG();\r\n}\r\npmc_base = of_iomap(node, 0);\r\nif (!pmc_base) {\r\npr_err("Can't map pmc registers\n");\r\nBUG();\r\n}\r\ntegra20_osc_clk_init();\r\ntegra20_pmc_clk_init();\r\ntegra20_fixed_clk_init();\r\ntegra20_pll_init();\r\ntegra20_super_clk_init();\r\ntegra20_periph_clk_init();\r\ntegra20_audio_clk_init();\r\nfor (i = 0; i < ARRAY_SIZE(clks); i++) {\r\nif (IS_ERR(clks[i])) {\r\npr_err("Tegra20 clk %d: register failed with %ld\n",\r\ni, PTR_ERR(clks[i]));\r\nBUG();\r\n}\r\nif (!clks[i])\r\nclks[i] = ERR_PTR(-EINVAL);\r\n}\r\ntegra_init_dup_clks(tegra_clk_duplicates, clks, clk_max);\r\nclk_data.clks = clks;\r\nclk_data.clk_num = ARRAY_SIZE(clks);\r\nof_clk_add_provider(np, of_clk_src_onecell_get, &clk_data);\r\ntegra_clk_apply_init_table = tegra20_clock_apply_init_table;\r\ntegra_cpu_car_ops = &tegra20_cpu_car_ops;\r\n}

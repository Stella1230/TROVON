static int vprbrd_probe(struct usb_interface *interface,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct vprbrd *vb;\r\nu16 version = 0;\r\nint pipe, ret;\r\nvb = kzalloc(sizeof(*vb), GFP_KERNEL);\r\nif (vb == NULL) {\r\ndev_err(&interface->dev, "Out of memory\n");\r\nreturn -ENOMEM;\r\n}\r\nmutex_init(&vb->lock);\r\nvb->usb_dev = usb_get_dev(interface_to_usbdev(interface));\r\nusb_set_intfdata(interface, vb);\r\ndev_set_drvdata(&vb->pdev.dev, vb);\r\npipe = usb_rcvctrlpipe(vb->usb_dev, 0);\r\nret = usb_control_msg(vb->usb_dev, pipe, VPRBRD_USB_REQUEST_MAJOR,\r\nVPRBRD_USB_TYPE_IN, 0x0000, 0x0000, vb->buf, 1,\r\nVPRBRD_USB_TIMEOUT_MS);\r\nif (ret == 1)\r\nversion = vb->buf[0];\r\nret = usb_control_msg(vb->usb_dev, pipe, VPRBRD_USB_REQUEST_MINOR,\r\nVPRBRD_USB_TYPE_IN, 0x0000, 0x0000, vb->buf, 1,\r\nVPRBRD_USB_TIMEOUT_MS);\r\nif (ret == 1) {\r\nversion <<= 8;\r\nversion = version | vb->buf[0];\r\n}\r\ndev_info(&interface->dev,\r\n"version %x.%02x found at bus %03d address %03d\n",\r\nversion >> 8, version & 0xff,\r\nvb->usb_dev->bus->busnum, vb->usb_dev->devnum);\r\nret = mfd_add_devices(&interface->dev, -1, vprbrd_devs,\r\nARRAY_SIZE(vprbrd_devs), NULL, 0, NULL);\r\nif (ret != 0) {\r\ndev_err(&interface->dev, "Failed to add mfd devices to core.");\r\ngoto error;\r\n}\r\nreturn 0;\r\nerror:\r\nif (vb) {\r\nusb_put_dev(vb->usb_dev);\r\nkfree(vb);\r\n}\r\nreturn ret;\r\n}\r\nstatic void vprbrd_disconnect(struct usb_interface *interface)\r\n{\r\nstruct vprbrd *vb = usb_get_intfdata(interface);\r\nmfd_remove_devices(&interface->dev);\r\nusb_set_intfdata(interface, NULL);\r\nusb_put_dev(vb->usb_dev);\r\nkfree(vb);\r\ndev_dbg(&interface->dev, "disconnected\n");\r\n}

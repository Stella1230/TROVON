static int amd_fam14h_get_pci_info(struct cstate *state,\r\nunsigned int *pci_offset,\r\nunsigned int *enable_bit,\r\nunsigned int cpu)\r\n{\r\nswitch (state->id) {\r\ncase NON_PC0:\r\n*enable_bit = PCI_NON_PC0_ENABLE_BIT;\r\n*pci_offset = PCI_NON_PC0_OFFSET;\r\nbreak;\r\ncase PC1:\r\n*enable_bit = PCI_PC1_ENABLE_BIT;\r\n*pci_offset = PCI_PC1_OFFSET;\r\nbreak;\r\ncase PC6:\r\n*enable_bit = PCI_PC6_ENABLE_BIT;\r\n*pci_offset = PCI_PC6_OFFSET;\r\nbreak;\r\ncase NBP1:\r\n*enable_bit = PCI_NBP1_ENTERED_BIT;\r\n*pci_offset = PCI_NBP1_STAT_OFFSET;\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n};\r\nreturn 0;\r\n}\r\nstatic int amd_fam14h_init(cstate_t *state, unsigned int cpu)\r\n{\r\nint enable_bit, pci_offset, ret;\r\nuint32_t val;\r\nret = amd_fam14h_get_pci_info(state, &pci_offset, &enable_bit, cpu);\r\nif (ret)\r\nreturn ret;\r\nif (state->id == NBP1) {\r\nval = pci_read_long(amd_fam14h_pci_dev, pci_offset);\r\nval |= 1 << enable_bit;\r\nval = pci_write_long(amd_fam14h_pci_dev, pci_offset, val);\r\nreturn ret;\r\n}\r\nval = pci_read_long(amd_fam14h_pci_dev, PCI_MONITOR_ENABLE_REG);\r\ndprint("Init %s: read at offset: 0x%x val: %u\n", state->name,\r\nPCI_MONITOR_ENABLE_REG, (unsigned int) val);\r\nval |= 1 << enable_bit;\r\npci_write_long(amd_fam14h_pci_dev, PCI_MONITOR_ENABLE_REG, val);\r\ndprint("Init %s: offset: 0x%x enable_bit: %d - val: %u (%u)\n",\r\nstate->name, PCI_MONITOR_ENABLE_REG, enable_bit,\r\n(unsigned int) val, cpu);\r\npci_write_long(amd_fam14h_pci_dev, pci_offset, 0);\r\nprevious_count[state->id][cpu] = 0;\r\nreturn 0;\r\n}\r\nstatic int amd_fam14h_disable(cstate_t *state, unsigned int cpu)\r\n{\r\nint enable_bit, pci_offset, ret;\r\nuint32_t val;\r\nret = amd_fam14h_get_pci_info(state, &pci_offset, &enable_bit, cpu);\r\nif (ret)\r\nreturn ret;\r\nval = pci_read_long(amd_fam14h_pci_dev, pci_offset);\r\ndprint("%s: offset: 0x%x %u\n", state->name, pci_offset, val);\r\nif (state->id == NBP1) {\r\nnbp1_entered = (val & (1 << PCI_NBP1_ACTIVE_BIT)) |\r\n(val & (1 << PCI_NBP1_ENTERED_BIT));\r\ndprint("NBP1 was %sentered - 0x%x - enable_bit: "\r\n"%d - pci_offset: 0x%x\n",\r\nnbp1_entered ? "" : "not ",\r\nval, enable_bit, pci_offset);\r\nreturn ret;\r\n}\r\ncurrent_count[state->id][cpu] = val;\r\ndprint("%s: Current - %llu (%u)\n", state->name,\r\ncurrent_count[state->id][cpu], cpu);\r\ndprint("%s: Previous - %llu (%u)\n", state->name,\r\nprevious_count[state->id][cpu], cpu);\r\nval = pci_read_long(amd_fam14h_pci_dev, PCI_MONITOR_ENABLE_REG);\r\nval &= ~(1 << enable_bit);\r\npci_write_long(amd_fam14h_pci_dev, PCI_MONITOR_ENABLE_REG, val);\r\nreturn 0;\r\n}\r\nstatic int fam14h_nbp1_count(unsigned int id, unsigned long long *count,\r\nunsigned int cpu)\r\n{\r\nif (id == NBP1) {\r\nif (nbp1_entered)\r\n*count = 1;\r\nelse\r\n*count = 0;\r\nreturn 0;\r\n}\r\nreturn -1;\r\n}\r\nstatic int fam14h_get_count_percent(unsigned int id, double *percent,\r\nunsigned int cpu)\r\n{\r\nunsigned long diff;\r\nif (id >= AMD_FAM14H_STATE_NUM)\r\nreturn -1;\r\ndiff = current_count[id][cpu] - previous_count[id][cpu];\r\nif (timediff == 0)\r\n*percent = 0.0;\r\nelse\r\n*percent = 100.0 * diff / timediff / 12.5;\r\ndprint("Timediff: %llu - res~: %lu us - percent: %.2f %%\n",\r\ntimediff, diff * 10 / 125, *percent);\r\nreturn 0;\r\n}\r\nstatic int amd_fam14h_start(void)\r\n{\r\nint num, cpu;\r\nclock_gettime(CLOCK_REALTIME, &start_time);\r\nfor (num = 0; num < AMD_FAM14H_STATE_NUM; num++) {\r\nfor (cpu = 0; cpu < cpu_count; cpu++)\r\namd_fam14h_init(&amd_fam14h_cstates[num], cpu);\r\n}\r\n#ifdef DEBUG\r\nclock_gettime(CLOCK_REALTIME, &dbg_time);\r\ndbg_timediff = timespec_diff_us(start_time, dbg_time);\r\ndprint("Enabling counters took: %lu us\n",\r\ndbg_timediff);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int amd_fam14h_stop(void)\r\n{\r\nint num, cpu;\r\nstruct timespec end_time;\r\nclock_gettime(CLOCK_REALTIME, &end_time);\r\nfor (num = 0; num < AMD_FAM14H_STATE_NUM; num++) {\r\nfor (cpu = 0; cpu < cpu_count; cpu++)\r\namd_fam14h_disable(&amd_fam14h_cstates[num], cpu);\r\n}\r\n#ifdef DEBUG\r\nclock_gettime(CLOCK_REALTIME, &dbg_time);\r\ndbg_timediff = timespec_diff_us(end_time, dbg_time);\r\ndprint("Disabling counters took: %lu ns\n", dbg_timediff);\r\n#endif\r\ntimediff = timespec_diff_us(start_time, end_time);\r\nif (timediff / 1000 > OVERFLOW_MS)\r\nprint_overflow_err((unsigned int)timediff / 1000000,\r\nOVERFLOW_MS / 1000);\r\nreturn 0;\r\n}\r\nstatic int is_nbp1_capable(void)\r\n{\r\nuint32_t val;\r\nval = pci_read_long(amd_fam14h_pci_dev, PCI_NBP1_CAP_OFFSET);\r\nreturn val & (1 << 31);\r\n}\r\nstruct cpuidle_monitor *amd_fam14h_register(void)\r\n{\r\nint num;\r\nif (cpupower_cpu_info.vendor != X86_VENDOR_AMD)\r\nreturn NULL;\r\nif (cpupower_cpu_info.family == 0x14)\r\nstrncpy(amd_fam14h_monitor.name, "Fam_14h",\r\nMONITOR_NAME_LEN - 1);\r\nelse if (cpupower_cpu_info.family == 0x12)\r\nstrncpy(amd_fam14h_monitor.name, "Fam_12h",\r\nMONITOR_NAME_LEN - 1);\r\nelse\r\nreturn NULL;\r\nfor (num = 0; num < AMD_FAM14H_STATE_NUM - 1; num++) {\r\nprevious_count[num] = calloc(cpu_count,\r\nsizeof(unsigned long long));\r\ncurrent_count[num] = calloc(cpu_count,\r\nsizeof(unsigned long long));\r\n}\r\namd_fam14h_pci_dev = pci_slot_func_init(&pci_acc, 0x18, 6);\r\nif (amd_fam14h_pci_dev == NULL || pci_acc == NULL)\r\nreturn NULL;\r\nif (!is_nbp1_capable())\r\namd_fam14h_monitor.hw_states_num = AMD_FAM14H_STATE_NUM - 1;\r\namd_fam14h_monitor.name_len = strlen(amd_fam14h_monitor.name);\r\nreturn &amd_fam14h_monitor;\r\n}\r\nstatic void amd_fam14h_unregister(void)\r\n{\r\nint num;\r\nfor (num = 0; num < AMD_FAM14H_STATE_NUM - 1; num++) {\r\nfree(previous_count[num]);\r\nfree(current_count[num]);\r\n}\r\npci_cleanup(pci_acc);\r\n}

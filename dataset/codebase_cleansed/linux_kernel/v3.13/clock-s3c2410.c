int s3c2410_clkcon_enable(struct clk *clk, int enable)\r\n{\r\nunsigned int clocks = clk->ctrlbit;\r\nunsigned long clkcon;\r\nclkcon = __raw_readl(S3C2410_CLKCON);\r\nif (enable)\r\nclkcon |= clocks;\r\nelse\r\nclkcon &= ~clocks;\r\nclkcon &= ~(S3C2410_CLKCON_IDLE|S3C2410_CLKCON_POWER);\r\n__raw_writel(clkcon, S3C2410_CLKCON);\r\nreturn 0;\r\n}\r\nstatic int s3c2410_upll_enable(struct clk *clk, int enable)\r\n{\r\nunsigned long clkslow = __raw_readl(S3C2410_CLKSLOW);\r\nunsigned long orig = clkslow;\r\nif (enable)\r\nclkslow &= ~S3C2410_CLKSLOW_UCLK_OFF;\r\nelse\r\nclkslow |= S3C2410_CLKSLOW_UCLK_OFF;\r\n__raw_writel(clkslow, S3C2410_CLKSLOW);\r\nif (enable && (orig & S3C2410_CLKSLOW_UCLK_OFF))\r\nudelay(200);\r\nreturn 0;\r\n}\r\nint __init s3c2410_baseclk_add(void)\r\n{\r\nunsigned long clkslow = __raw_readl(S3C2410_CLKSLOW);\r\nunsigned long clkcon = __raw_readl(S3C2410_CLKCON);\r\nstruct clk *xtal;\r\nint ret;\r\nint ptr;\r\nclk_upll.enable = s3c2410_upll_enable;\r\nif (s3c24xx_register_clock(&clk_usb_bus) < 0)\r\nprintk(KERN_ERR "failed to register usb bus clock\n");\r\nfor (ptr = 0; ptr < ARRAY_SIZE(init_clocks); ptr++) {\r\nstruct clk *clkp = init_clocks[ptr];\r\nclkp->usage = clkcon & clkp->ctrlbit ? 1 : 0;\r\nret = s3c24xx_register_clock(clkp);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "Failed to register clock %s (%d)\n",\r\nclkp->name, ret);\r\n}\r\n}\r\ns3c_register_clocks(init_clocks_off, ARRAY_SIZE(init_clocks_off));\r\ns3c_disable_clocks(init_clocks_off, ARRAY_SIZE(init_clocks_off));\r\nxtal = clk_get(NULL, "xtal");\r\nprintk("CLOCK: Slow mode (%ld.%ld MHz), %s, MPLL %s, UPLL %s\n",\r\nprint_mhz(clk_get_rate(xtal) /\r\n( 2 * S3C2410_CLKSLOW_GET_SLOWVAL(clkslow))),\r\n(clkslow & S3C2410_CLKSLOW_SLOW) ? "slow" : "fast",\r\n(clkslow & S3C2410_CLKSLOW_MPLL_OFF) ? "off" : "on",\r\n(clkslow & S3C2410_CLKSLOW_UCLK_OFF) ? "off" : "on");\r\nreturn 0;\r\n}

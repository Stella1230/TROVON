static const char *translate_esas2r_event_level_to_kernel(const long level)\r\n{\r\nswitch (level) {\r\ncase ESAS2R_LOG_CRIT:\r\nreturn KERN_CRIT;\r\ncase ESAS2R_LOG_WARN:\r\nreturn KERN_WARNING;\r\ncase ESAS2R_LOG_INFO:\r\nreturn KERN_INFO;\r\ncase ESAS2R_LOG_DEBG:\r\ncase ESAS2R_LOG_TRCE:\r\ndefault:\r\nreturn KERN_DEBUG;\r\n}\r\n}\r\nstatic int esas2r_log_master(const long level,\r\nconst struct device *dev,\r\nconst char *format,\r\nva_list args)\r\n{\r\nif (level <= event_log_level) {\r\nunsigned long flags = 0;\r\nint retval = 0;\r\nchar *buffer = event_buffer;\r\nsize_t buflen = EVENT_LOG_BUFF_SIZE;\r\nconst char *fmt_nodev = "%s%s: ";\r\nconst char *fmt_dev = "%s%s [%s, %s, %s]";\r\nconst char *slevel =\r\ntranslate_esas2r_event_level_to_kernel(level);\r\nspin_lock_irqsave(&event_buffer_lock, flags);\r\nif (buffer == NULL) {\r\nspin_unlock_irqrestore(&event_buffer_lock, flags);\r\nreturn -1;\r\n}\r\nmemset(buffer, 0, buflen);\r\nif (dev == NULL) {\r\nsnprintf(buffer, buflen, fmt_nodev, slevel,\r\nESAS2R_DRVR_NAME);\r\n} else {\r\nsnprintf(buffer, buflen, fmt_dev, slevel,\r\nESAS2R_DRVR_NAME,\r\n(dev->driver ? dev->driver->name : "unknown"),\r\n(dev->bus ? dev->bus->name : "unknown"),\r\ndev_name(dev));\r\n}\r\nbuffer += strlen(event_buffer);\r\nbuflen -= strlen(event_buffer);\r\nretval = vsnprintf(buffer, buflen, format, args);\r\nif (retval < 0) {\r\nspin_unlock_irqrestore(&event_buffer_lock, flags);\r\nreturn -1;\r\n}\r\nif (strlen(event_buffer) < buflen)\r\nstrcat(buffer, "\n");\r\nprintk(event_buffer);\r\nspin_unlock_irqrestore(&event_buffer_lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nint esas2r_log(const long level, const char *format, ...)\r\n{\r\nint retval = 0;\r\nva_list args;\r\nva_start(args, format);\r\nretval = esas2r_log_master(level, NULL, format, args);\r\nva_end(args);\r\nreturn retval;\r\n}\r\nint esas2r_log_dev(const long level,\r\nconst struct device *dev,\r\nconst char *format,\r\n...)\r\n{\r\nint retval = 0;\r\nva_list args;\r\nva_start(args, format);\r\nretval = esas2r_log_master(level, dev, format, args);\r\nva_end(args);\r\nreturn retval;\r\n}\r\nint esas2r_log_hexdump(const long level,\r\nconst void *buf,\r\nsize_t len)\r\n{\r\nif (level <= event_log_level) {\r\nprint_hex_dump(translate_esas2r_event_level_to_kernel(level),\r\n"", DUMP_PREFIX_OFFSET, 16, 1, buf,\r\nlen, true);\r\n}\r\nreturn 1;\r\n}

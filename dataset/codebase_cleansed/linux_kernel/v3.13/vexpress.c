static ssize_t vexpress_hwmon_name_show(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buffer)\r\n{\r\nconst char *compatible = of_get_property(dev->of_node, "compatible",\r\nNULL);\r\nreturn sprintf(buffer, "%s\n", compatible);\r\n}\r\nstatic ssize_t vexpress_hwmon_label_show(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buffer)\r\n{\r\nconst char *label = of_get_property(dev->of_node, "label", NULL);\r\nif (!label)\r\nreturn -ENOENT;\r\nreturn snprintf(buffer, PAGE_SIZE, "%s\n", label);\r\n}\r\nstatic ssize_t vexpress_hwmon_u32_show(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buffer)\r\n{\r\nstruct vexpress_hwmon_data *data = dev_get_drvdata(dev);\r\nint err;\r\nu32 value;\r\nerr = vexpress_config_read(data->func, 0, &value);\r\nif (err)\r\nreturn err;\r\nreturn snprintf(buffer, PAGE_SIZE, "%u\n", value /\r\nto_sensor_dev_attr(dev_attr)->index);\r\n}\r\nstatic ssize_t vexpress_hwmon_u64_show(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buffer)\r\n{\r\nstruct vexpress_hwmon_data *data = dev_get_drvdata(dev);\r\nint err;\r\nu32 value_hi, value_lo;\r\nerr = vexpress_config_read(data->func, 0, &value_lo);\r\nif (err)\r\nreturn err;\r\nerr = vexpress_config_read(data->func, 1, &value_hi);\r\nif (err)\r\nreturn err;\r\nreturn snprintf(buffer, PAGE_SIZE, "%llu\n",\r\ndiv_u64(((u64)value_hi << 32) | value_lo,\r\nto_sensor_dev_attr(dev_attr)->index));\r\n}\r\nstatic int vexpress_hwmon_probe(struct platform_device *pdev)\r\n{\r\nint err;\r\nconst struct of_device_id *match;\r\nstruct vexpress_hwmon_data *data;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, data);\r\nmatch = of_match_device(vexpress_hwmon_of_match, &pdev->dev);\r\nif (!match)\r\nreturn -ENODEV;\r\ndata->func = vexpress_config_func_get_by_dev(&pdev->dev);\r\nif (!data->func)\r\nreturn -ENODEV;\r\nerr = sysfs_create_group(&pdev->dev.kobj, match->data);\r\nif (err)\r\ngoto error;\r\ndata->hwmon_dev = hwmon_device_register(&pdev->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto error;\r\n}\r\nreturn 0;\r\nerror:\r\nsysfs_remove_group(&pdev->dev.kobj, match->data);\r\nvexpress_config_func_put(data->func);\r\nreturn err;\r\n}\r\nstatic int vexpress_hwmon_remove(struct platform_device *pdev)\r\n{\r\nstruct vexpress_hwmon_data *data = platform_get_drvdata(pdev);\r\nconst struct of_device_id *match;\r\nhwmon_device_unregister(data->hwmon_dev);\r\nmatch = of_match_device(vexpress_hwmon_of_match, &pdev->dev);\r\nsysfs_remove_group(&pdev->dev.kobj, match->data);\r\nvexpress_config_func_put(data->func);\r\nreturn 0;\r\n}

static void dm_CheckStatistics(struct adapter *Adapter)\r\n{\r\n}\r\nstatic void dm_InitGPIOSetting(struct adapter *Adapter)\r\n{\r\nu8 tmp1byte;\r\ntmp1byte = rtw_read8(Adapter, REG_GPIO_MUXCFG);\r\ntmp1byte &= (GPIOSEL_GPIO | ~GPIOSEL_ENBT);\r\nrtw_write8(Adapter, REG_GPIO_MUXCFG, tmp1byte);\r\n}\r\nstatic void Init_ODM_ComInfo_88E(struct adapter *Adapter)\r\n{\r\nstruct hal_data_8188e *hal_data = GET_HAL_DATA(Adapter);\r\nstruct dm_priv *pdmpriv = &hal_data->dmpriv;\r\nstruct odm_dm_struct *dm_odm = &(hal_data->odmpriv);\r\nu8 cut_ver, fab_ver;\r\n_rtw_memset(dm_odm, 0, sizeof(*dm_odm));\r\ndm_odm->Adapter = Adapter;\r\nODM_CmnInfoInit(dm_odm, ODM_CMNINFO_PLATFORM, ODM_CE);\r\nif (Adapter->interface_type == RTW_GSPI)\r\nODM_CmnInfoInit(dm_odm, ODM_CMNINFO_INTERFACE, ODM_ITRF_SDIO);\r\nelse\r\nODM_CmnInfoInit(dm_odm, ODM_CMNINFO_INTERFACE, Adapter->interface_type);\r\nODM_CmnInfoInit(dm_odm, ODM_CMNINFO_IC_TYPE, ODM_RTL8188E);\r\nfab_ver = ODM_TSMC;\r\ncut_ver = ODM_CUT_A;\r\nODM_CmnInfoInit(dm_odm, ODM_CMNINFO_FAB_VER, fab_ver);\r\nODM_CmnInfoInit(dm_odm, ODM_CMNINFO_CUT_VER, cut_ver);\r\nODM_CmnInfoInit(dm_odm, ODM_CMNINFO_MP_TEST_CHIP, IS_NORMAL_CHIP(hal_data->VersionID));\r\nODM_CmnInfoInit(dm_odm, ODM_CMNINFO_PATCH_ID, hal_data->CustomerID);\r\nODM_CmnInfoInit(dm_odm, ODM_CMNINFO_BWIFI_TEST, Adapter->registrypriv.wifi_spec);\r\nif (hal_data->rf_type == RF_1T1R)\r\nODM_CmnInfoUpdate(dm_odm, ODM_CMNINFO_RF_TYPE, ODM_1T1R);\r\nelse if (hal_data->rf_type == RF_2T2R)\r\nODM_CmnInfoUpdate(dm_odm, ODM_CMNINFO_RF_TYPE, ODM_2T2R);\r\nelse if (hal_data->rf_type == RF_1T2R)\r\nODM_CmnInfoUpdate(dm_odm, ODM_CMNINFO_RF_TYPE, ODM_1T2R);\r\nODM_CmnInfoInit(dm_odm, ODM_CMNINFO_RF_ANTENNA_TYPE, hal_data->TRxAntDivType);\r\npdmpriv->InitODMFlag = ODM_RF_CALIBRATION |\r\nODM_RF_TX_PWR_TRACK;\r\nODM_CmnInfoUpdate(dm_odm, ODM_CMNINFO_ABILITY, pdmpriv->InitODMFlag);\r\n}\r\nstatic void Update_ODM_ComInfo_88E(struct adapter *Adapter)\r\n{\r\nstruct mlme_ext_priv *pmlmeext = &Adapter->mlmeextpriv;\r\nstruct mlme_priv *pmlmepriv = &Adapter->mlmepriv;\r\nstruct pwrctrl_priv *pwrctrlpriv = &Adapter->pwrctrlpriv;\r\nstruct hal_data_8188e *hal_data = GET_HAL_DATA(Adapter);\r\nstruct odm_dm_struct *dm_odm = &(hal_data->odmpriv);\r\nstruct dm_priv *pdmpriv = &hal_data->dmpriv;\r\nint i;\r\npdmpriv->InitODMFlag = ODM_BB_DIG |\r\nODM_BB_RA_MASK |\r\nODM_BB_DYNAMIC_TXPWR |\r\nODM_BB_FA_CNT |\r\nODM_BB_RSSI_MONITOR |\r\nODM_BB_CCK_PD |\r\nODM_BB_PWR_SAVE |\r\nODM_MAC_EDCA_TURBO |\r\nODM_RF_CALIBRATION |\r\nODM_RF_TX_PWR_TRACK;\r\nif (hal_data->AntDivCfg)\r\npdmpriv->InitODMFlag |= ODM_BB_ANT_DIV;\r\nif (Adapter->registrypriv.mp_mode == 1) {\r\npdmpriv->InitODMFlag = ODM_RF_CALIBRATION |\r\nODM_RF_TX_PWR_TRACK;\r\n}\r\nODM_CmnInfoUpdate(dm_odm, ODM_CMNINFO_ABILITY, pdmpriv->InitODMFlag);\r\nODM_CmnInfoHook(dm_odm, ODM_CMNINFO_TX_UNI, &(Adapter->xmitpriv.tx_bytes));\r\nODM_CmnInfoHook(dm_odm, ODM_CMNINFO_RX_UNI, &(Adapter->recvpriv.rx_bytes));\r\nODM_CmnInfoHook(dm_odm, ODM_CMNINFO_WM_MODE, &(pmlmeext->cur_wireless_mode));\r\nODM_CmnInfoHook(dm_odm, ODM_CMNINFO_SEC_CHNL_OFFSET, &(hal_data->nCur40MhzPrimeSC));\r\nODM_CmnInfoHook(dm_odm, ODM_CMNINFO_SEC_MODE, &(Adapter->securitypriv.dot11PrivacyAlgrthm));\r\nODM_CmnInfoHook(dm_odm, ODM_CMNINFO_BW, &(hal_data->CurrentChannelBW));\r\nODM_CmnInfoHook(dm_odm, ODM_CMNINFO_CHNL, &(hal_data->CurrentChannel));\r\nODM_CmnInfoHook(dm_odm, ODM_CMNINFO_NET_CLOSED, &(Adapter->net_closed));\r\nODM_CmnInfoHook(dm_odm, ODM_CMNINFO_MP_MODE, &(Adapter->registrypriv.mp_mode));\r\nODM_CmnInfoHook(dm_odm, ODM_CMNINFO_SCAN, &(pmlmepriv->bScanInProcess));\r\nODM_CmnInfoHook(dm_odm, ODM_CMNINFO_POWER_SAVING, &(pwrctrlpriv->bpower_saving));\r\nODM_CmnInfoInit(dm_odm, ODM_CMNINFO_RF_ANTENNA_TYPE, hal_data->TRxAntDivType);\r\nfor (i = 0; i < NUM_STA; i++)\r\nODM_CmnInfoPtrArrayHook(dm_odm, ODM_CMNINFO_STA_STATUS, i, NULL);\r\n}\r\nvoid rtl8188e_InitHalDm(struct adapter *Adapter)\r\n{\r\nstruct hal_data_8188e *hal_data = GET_HAL_DATA(Adapter);\r\nstruct dm_priv *pdmpriv = &hal_data->dmpriv;\r\nstruct odm_dm_struct *dm_odm = &(hal_data->odmpriv);\r\ndm_InitGPIOSetting(Adapter);\r\npdmpriv->DM_Type = DM_Type_ByDriver;\r\npdmpriv->DMFlag = DYNAMIC_FUNC_DISABLE;\r\nUpdate_ODM_ComInfo_88E(Adapter);\r\nODM_DMInit(dm_odm);\r\nAdapter->fix_rate = 0xFF;\r\n}\r\nvoid rtl8188e_HalDmWatchDog(struct adapter *Adapter)\r\n{\r\nbool fw_cur_in_ps = false;\r\nbool fw_ps_awake = true;\r\nu8 hw_init_completed = false;\r\nstruct hal_data_8188e *hal_data = GET_HAL_DATA(Adapter);\r\n_func_enter_;\r\nhw_init_completed = Adapter->hw_init_completed;\r\nif (!hw_init_completed)\r\ngoto skip_dm;\r\nfw_cur_in_ps = Adapter->pwrctrlpriv.bFwCurrentInPSMode;\r\nrtw_hal_get_hwreg(Adapter, HW_VAR_FWLPS_RF_ON, (u8 *)(&fw_ps_awake));\r\nif (Adapter->wdinfo.p2p_ps_mode)\r\nfw_ps_awake = false;\r\nif (hw_init_completed && ((!fw_cur_in_ps) && fw_ps_awake)) {\r\ndm_CheckStatistics(Adapter);\r\n_func_exit_;\r\n}\r\nif (hw_init_completed) {\r\nstruct mlme_priv *pmlmepriv = &Adapter->mlmepriv;\r\nu8 bLinked = false;\r\nif ((check_fwstate(pmlmepriv, WIFI_AP_STATE)) ||\r\n(check_fwstate(pmlmepriv, WIFI_ADHOC_STATE | WIFI_ADHOC_MASTER_STATE))) {\r\nif (Adapter->stapriv.asoc_sta_count > 2)\r\nbLinked = true;\r\n} else {\r\nif (check_fwstate(pmlmepriv, _FW_LINKED))\r\nbLinked = true;\r\n}\r\nODM_CmnInfoUpdate(&hal_data->odmpriv, ODM_CMNINFO_LINK, bLinked);\r\nODM_DMWatchdog(&hal_data->odmpriv);\r\n}\r\nskip_dm:\r\nreturn;\r\n}\r\nvoid rtl8188e_init_dm_priv(struct adapter *Adapter)\r\n{\r\nstruct hal_data_8188e *hal_data = GET_HAL_DATA(Adapter);\r\nstruct dm_priv *pdmpriv = &hal_data->dmpriv;\r\nstruct odm_dm_struct *podmpriv = &hal_data->odmpriv;\r\n_rtw_memset(pdmpriv, 0, sizeof(struct dm_priv));\r\nInit_ODM_ComInfo_88E(Adapter);\r\nODM_InitDebugSetting(podmpriv);\r\n}\r\nvoid rtl8188e_deinit_dm_priv(struct adapter *Adapter)\r\n{\r\n}\r\nvoid AntDivCompare8188E(struct adapter *Adapter, struct wlan_bssid_ex *dst, struct wlan_bssid_ex *src)\r\n{\r\nstruct hal_data_8188e *hal_data = GET_HAL_DATA(Adapter);\r\nif (0 != hal_data->AntDivCfg) {\r\nif (dst->Rssi >= src->Rssi) {\r\nsrc->Rssi = dst->Rssi;\r\nsrc->PhyInfo.Optimum_antenna = dst->PhyInfo.Optimum_antenna;\r\n}\r\n}\r\n}\r\nu8 AntDivBeforeLink8188E(struct adapter *Adapter)\r\n{\r\nstruct hal_data_8188e *hal_data = GET_HAL_DATA(Adapter);\r\nstruct odm_dm_struct *dm_odm = &hal_data->odmpriv;\r\nstruct sw_ant_switch *dm_swat_tbl = &dm_odm->DM_SWAT_Table;\r\nstruct mlme_priv *pmlmepriv = &(Adapter->mlmepriv);\r\nif (hal_data->AntDivCfg == 0)\r\nreturn false;\r\nif (check_fwstate(pmlmepriv, _FW_LINKED))\r\nreturn false;\r\nif (dm_swat_tbl->SWAS_NoLink_State == 0) {\r\ndm_swat_tbl->SWAS_NoLink_State = 1;\r\ndm_swat_tbl->CurAntenna = (dm_swat_tbl->CurAntenna == Antenna_A) ? Antenna_B : Antenna_A;\r\nrtw_antenna_select_cmd(Adapter, dm_swat_tbl->CurAntenna, false);\r\nreturn true;\r\n} else {\r\ndm_swat_tbl->SWAS_NoLink_State = 0;\r\nreturn false;\r\n}\r\n}

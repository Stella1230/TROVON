static int lov_page_invariant(const struct cl_page_slice *slice)\r\n{\r\nconst struct cl_page *page = slice->cpl_page;\r\nconst struct cl_page *sub = lov_sub_page(slice);\r\nreturn ergo(sub != NULL,\r\npage->cp_child == sub &&\r\nsub->cp_parent == page &&\r\npage->cp_state == sub->cp_state);\r\n}\r\nstatic void lov_page_fini(const struct lu_env *env,\r\nstruct cl_page_slice *slice)\r\n{\r\nstruct cl_page *sub = lov_sub_page(slice);\r\nLINVRNT(lov_page_invariant(slice));\r\nif (sub != NULL) {\r\nLASSERT(sub->cp_state == CPS_FREEING);\r\nlu_ref_del(&sub->cp_reference, "lov", sub->cp_parent);\r\nsub->cp_parent = NULL;\r\nslice->cpl_page->cp_child = NULL;\r\ncl_page_put(env, sub);\r\n}\r\n}\r\nstatic int lov_page_own(const struct lu_env *env,\r\nconst struct cl_page_slice *slice, struct cl_io *io,\r\nint nonblock)\r\n{\r\nstruct lov_io *lio = lov_env_io(env);\r\nstruct lov_io_sub *sub;\r\nLINVRNT(lov_page_invariant(slice));\r\nLINVRNT(!cl2lov_page(slice)->lps_invalid);\r\nsub = lov_page_subio(env, lio, slice);\r\nif (!IS_ERR(sub)) {\r\nlov_sub_page(slice)->cp_owner = sub->sub_io;\r\nlov_sub_put(sub);\r\n} else\r\nLBUG();\r\nreturn 0;\r\n}\r\nstatic void lov_page_assume(const struct lu_env *env,\r\nconst struct cl_page_slice *slice, struct cl_io *io)\r\n{\r\nlov_page_own(env, slice, io, 0);\r\n}\r\nstatic int lov_page_cache_add(const struct lu_env *env,\r\nconst struct cl_page_slice *slice,\r\nstruct cl_io *io)\r\n{\r\nstruct lov_io *lio = lov_env_io(env);\r\nstruct lov_io_sub *sub;\r\nint rc = 0;\r\nLINVRNT(lov_page_invariant(slice));\r\nLINVRNT(!cl2lov_page(slice)->lps_invalid);\r\nsub = lov_page_subio(env, lio, slice);\r\nif (!IS_ERR(sub)) {\r\nrc = cl_page_cache_add(sub->sub_env, sub->sub_io,\r\nslice->cpl_page->cp_child, CRT_WRITE);\r\nlov_sub_put(sub);\r\n} else {\r\nrc = PTR_ERR(sub);\r\nCL_PAGE_DEBUG(D_ERROR, env, slice->cpl_page, "rc = %d\n", rc);\r\n}\r\nreturn rc;\r\n}\r\nstatic int lov_page_print(const struct lu_env *env,\r\nconst struct cl_page_slice *slice,\r\nvoid *cookie, lu_printer_t printer)\r\n{\r\nstruct lov_page *lp = cl2lov_page(slice);\r\nreturn (*printer)(env, cookie, LUSTRE_LOV_NAME"-page@%p\n", lp);\r\n}\r\nstatic void lov_empty_page_fini(const struct lu_env *env,\r\nstruct cl_page_slice *slice)\r\n{\r\nLASSERT(slice->cpl_page->cp_child == NULL);\r\n}\r\nint lov_page_init_raid0(const struct lu_env *env, struct cl_object *obj,\r\nstruct cl_page *page, struct page *vmpage)\r\n{\r\nstruct lov_object *loo = cl2lov(obj);\r\nstruct lov_layout_raid0 *r0 = lov_r0(loo);\r\nstruct lov_io *lio = lov_env_io(env);\r\nstruct cl_page *subpage;\r\nstruct cl_object *subobj;\r\nstruct lov_io_sub *sub;\r\nstruct lov_page *lpg = cl_object_page_slice(obj, page);\r\nloff_t offset;\r\nobd_off suboff;\r\nint stripe;\r\nint rc;\r\noffset = cl_offset(obj, page->cp_index);\r\nstripe = lov_stripe_number(loo->lo_lsm, offset);\r\nLASSERT(stripe < r0->lo_nr);\r\nrc = lov_stripe_offset(loo->lo_lsm, offset, stripe,\r\n&suboff);\r\nLASSERT(rc == 0);\r\nlpg->lps_invalid = 1;\r\ncl_page_slice_add(page, &lpg->lps_cl, obj, &lov_page_ops);\r\nsub = lov_sub_get(env, lio, stripe);\r\nif (IS_ERR(sub))\r\nGOTO(out, rc = PTR_ERR(sub));\r\nsubobj = lovsub2cl(r0->lo_sub[stripe]);\r\nsubpage = cl_page_find_sub(sub->sub_env, subobj,\r\ncl_index(subobj, suboff), vmpage, page);\r\nlov_sub_put(sub);\r\nif (IS_ERR(subpage))\r\nGOTO(out, rc = PTR_ERR(subpage));\r\nif (likely(subpage->cp_parent == page)) {\r\nlu_ref_add(&subpage->cp_reference, "lov", page);\r\nlpg->lps_invalid = 0;\r\nrc = 0;\r\n} else {\r\nCL_PAGE_DEBUG(D_ERROR, env, page, "parent page\n");\r\nCL_PAGE_DEBUG(D_ERROR, env, subpage, "child page\n");\r\nLASSERT(0);\r\n}\r\nout:\r\nreturn rc;\r\n}\r\nint lov_page_init_empty(const struct lu_env *env, struct cl_object *obj,\r\nstruct cl_page *page, struct page *vmpage)\r\n{\r\nstruct lov_page *lpg = cl_object_page_slice(obj, page);\r\nvoid *addr;\r\ncl_page_slice_add(page, &lpg->lps_cl, obj, &lov_empty_page_ops);\r\naddr = kmap(vmpage);\r\nmemset(addr, 0, cl_page_size(obj));\r\nkunmap(vmpage);\r\ncl_page_export(env, page, 1);\r\nreturn 0;\r\n}

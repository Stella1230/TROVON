static void iwl_mvm_power_log(struct iwl_mvm *mvm,\r\nstruct iwl_powertable_cmd *cmd)\r\n{\r\nIWL_DEBUG_POWER(mvm,\r\n"Sending power table command for power level %d, flags = 0x%X\n",\r\niwlmvm_mod_params.power_scheme,\r\nle16_to_cpu(cmd->flags));\r\nIWL_DEBUG_POWER(mvm, "Keep alive = %u sec\n", cmd->keep_alive_seconds);\r\nif (cmd->flags & cpu_to_le16(POWER_FLAGS_POWER_MANAGEMENT_ENA_MSK)) {\r\nIWL_DEBUG_POWER(mvm, "Rx timeout = %u usec\n",\r\nle32_to_cpu(cmd->rx_data_timeout));\r\nIWL_DEBUG_POWER(mvm, "Tx timeout = %u usec\n",\r\nle32_to_cpu(cmd->tx_data_timeout));\r\nif (cmd->flags & cpu_to_le16(POWER_FLAGS_SKIP_OVER_DTIM_MSK))\r\nIWL_DEBUG_POWER(mvm, "DTIM periods to skip = %u\n",\r\nle32_to_cpu(cmd->skip_dtim_periods));\r\nif (cmd->flags & cpu_to_le16(POWER_FLAGS_LPRX_ENA_MSK))\r\nIWL_DEBUG_POWER(mvm, "LP RX RSSI threshold = %u\n",\r\nle32_to_cpu(cmd->lprx_rssi_threshold));\r\n}\r\n}\r\nstatic void iwl_mvm_power_build_cmd(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif,\r\nstruct iwl_powertable_cmd *cmd)\r\n{\r\nstruct ieee80211_hw *hw = mvm->hw;\r\nstruct ieee80211_chanctx_conf *chanctx_conf;\r\nstruct ieee80211_channel *chan;\r\nint dtimper, dtimper_msec;\r\nint keep_alive;\r\nbool radar_detect = false;\r\nstruct iwl_mvm_vif *mvmvif __maybe_unused =\r\niwl_mvm_vif_from_mac80211(vif);\r\ncmd->keep_alive_seconds = POWER_KEEP_ALIVE_PERIOD_SEC;\r\nif (iwlmvm_mod_params.power_scheme == IWL_POWER_SCHEME_CAM)\r\nreturn;\r\ncmd->flags |= cpu_to_le16(POWER_FLAGS_POWER_SAVE_ENA_MSK);\r\nif (!vif->bss_conf.assoc)\r\ncmd->flags |= cpu_to_le16(POWER_FLAGS_POWER_MANAGEMENT_ENA_MSK);\r\n#ifdef CONFIG_IWLWIFI_DEBUGFS\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_DISABLE_POWER_OFF &&\r\nmvmvif->dbgfs_pm.disable_power_off)\r\ncmd->flags &= cpu_to_le16(~POWER_FLAGS_POWER_SAVE_ENA_MSK);\r\n#endif\r\nif (!vif->bss_conf.ps)\r\nreturn;\r\ncmd->flags |= cpu_to_le16(POWER_FLAGS_POWER_MANAGEMENT_ENA_MSK);\r\nif (vif->bss_conf.beacon_rate &&\r\n(vif->bss_conf.beacon_rate->bitrate == 10 ||\r\nvif->bss_conf.beacon_rate->bitrate == 60)) {\r\ncmd->flags |= cpu_to_le16(POWER_FLAGS_LPRX_ENA_MSK);\r\ncmd->lprx_rssi_threshold =\r\ncpu_to_le32(POWER_LPRX_RSSI_THRESHOLD);\r\n}\r\ndtimper = hw->conf.ps_dtim_period ?: 1;\r\nrcu_read_lock();\r\nchanctx_conf = rcu_dereference(vif->chanctx_conf);\r\nWARN_ON(!chanctx_conf);\r\nif (chanctx_conf) {\r\nchan = chanctx_conf->def.chan;\r\nradar_detect = chan->flags & IEEE80211_CHAN_RADAR;\r\n}\r\nrcu_read_unlock();\r\nif (!radar_detect && (dtimper <= 10) &&\r\n(iwlmvm_mod_params.power_scheme == IWL_POWER_SCHEME_LP ||\r\nmvm->cur_ucode == IWL_UCODE_WOWLAN)) {\r\ncmd->flags |= cpu_to_le16(POWER_FLAGS_SKIP_OVER_DTIM_MSK);\r\ncmd->skip_dtim_periods = cpu_to_le32(3);\r\n}\r\ndtimper_msec = dtimper * vif->bss_conf.beacon_int;\r\nkeep_alive = max_t(int, 3 * dtimper_msec,\r\nMSEC_PER_SEC * cmd->keep_alive_seconds);\r\nkeep_alive = DIV_ROUND_UP(keep_alive, MSEC_PER_SEC);\r\ncmd->keep_alive_seconds = keep_alive;\r\nif (mvm->cur_ucode != IWL_UCODE_WOWLAN) {\r\ncmd->rx_data_timeout = cpu_to_le32(100 * USEC_PER_MSEC);\r\ncmd->tx_data_timeout = cpu_to_le32(100 * USEC_PER_MSEC);\r\n} else {\r\ncmd->rx_data_timeout = cpu_to_le32(10 * USEC_PER_MSEC);\r\ncmd->tx_data_timeout = cpu_to_le32(10 * USEC_PER_MSEC);\r\n}\r\n#ifdef CONFIG_IWLWIFI_DEBUGFS\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_KEEP_ALIVE)\r\ncmd->keep_alive_seconds = mvmvif->dbgfs_pm.keep_alive_seconds;\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_SKIP_OVER_DTIM) {\r\nif (mvmvif->dbgfs_pm.skip_over_dtim)\r\ncmd->flags |=\r\ncpu_to_le16(POWER_FLAGS_SKIP_OVER_DTIM_MSK);\r\nelse\r\ncmd->flags &=\r\ncpu_to_le16(~POWER_FLAGS_SKIP_OVER_DTIM_MSK);\r\n}\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_RX_DATA_TIMEOUT)\r\ncmd->rx_data_timeout =\r\ncpu_to_le32(mvmvif->dbgfs_pm.rx_data_timeout);\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_TX_DATA_TIMEOUT)\r\ncmd->tx_data_timeout =\r\ncpu_to_le32(mvmvif->dbgfs_pm.tx_data_timeout);\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_SKIP_DTIM_PERIODS)\r\ncmd->skip_dtim_periods =\r\ncpu_to_le32(mvmvif->dbgfs_pm.skip_dtim_periods);\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_LPRX_ENA) {\r\nif (mvmvif->dbgfs_pm.lprx_ena)\r\ncmd->flags |= cpu_to_le16(POWER_FLAGS_LPRX_ENA_MSK);\r\nelse\r\ncmd->flags &= cpu_to_le16(~POWER_FLAGS_LPRX_ENA_MSK);\r\n}\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_LPRX_RSSI_THRESHOLD)\r\ncmd->lprx_rssi_threshold =\r\ncpu_to_le32(mvmvif->dbgfs_pm.lprx_rssi_threshold);\r\n#endif\r\n}\r\nstatic int iwl_mvm_power_legacy_update_mode(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif)\r\n{\r\nint ret;\r\nbool ba_enable;\r\nstruct iwl_powertable_cmd cmd = {};\r\nif (vif->type != NL80211_IFTYPE_STATION || vif->p2p)\r\nreturn 0;\r\nIWL_DEBUG_POWER(mvm, "Currently %d interfaces active\n",\r\nmvm->vif_count);\r\nif (mvm->vif_count > 1)\r\nreturn 0;\r\niwl_mvm_power_build_cmd(mvm, vif, &cmd);\r\niwl_mvm_power_log(mvm, &cmd);\r\nret = iwl_mvm_send_cmd_pdu(mvm, POWER_TABLE_CMD, CMD_SYNC,\r\nsizeof(cmd), &cmd);\r\nif (ret)\r\nreturn ret;\r\nba_enable = !!(cmd.flags &\r\ncpu_to_le16(POWER_FLAGS_POWER_MANAGEMENT_ENA_MSK));\r\nreturn iwl_mvm_update_beacon_abort(mvm, vif, ba_enable);\r\n}\r\nstatic int iwl_mvm_power_legacy_disable(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif)\r\n{\r\nstruct iwl_powertable_cmd cmd = {};\r\nstruct iwl_mvm_vif *mvmvif __maybe_unused =\r\niwl_mvm_vif_from_mac80211(vif);\r\nif (vif->type != NL80211_IFTYPE_STATION || vif->p2p)\r\nreturn 0;\r\nif (iwlmvm_mod_params.power_scheme != IWL_POWER_SCHEME_CAM)\r\ncmd.flags |= cpu_to_le16(POWER_FLAGS_POWER_SAVE_ENA_MSK);\r\n#ifdef CONFIG_IWLWIFI_DEBUGFS\r\nif (mvmvif->dbgfs_pm.mask & MVM_DEBUGFS_PM_DISABLE_POWER_OFF &&\r\nmvmvif->dbgfs_pm.disable_power_off)\r\ncmd.flags &= cpu_to_le16(~POWER_FLAGS_POWER_SAVE_ENA_MSK);\r\n#endif\r\niwl_mvm_power_log(mvm, &cmd);\r\nreturn iwl_mvm_send_cmd_pdu(mvm, POWER_TABLE_CMD, CMD_ASYNC,\r\nsizeof(cmd), &cmd);\r\n}\r\nstatic int iwl_mvm_power_legacy_dbgfs_read(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif, char *buf,\r\nint bufsz)\r\n{\r\nstruct iwl_powertable_cmd cmd = {};\r\nint pos = 0;\r\niwl_mvm_power_build_cmd(mvm, vif, &cmd);\r\npos += scnprintf(buf+pos, bufsz-pos, "disable_power_off = %d\n",\r\n(cmd.flags &\r\ncpu_to_le16(POWER_FLAGS_POWER_SAVE_ENA_MSK)) ?\r\n0 : 1);\r\npos += scnprintf(buf+pos, bufsz-pos, "skip_dtim_periods = %d\n",\r\nle32_to_cpu(cmd.skip_dtim_periods));\r\npos += scnprintf(buf+pos, bufsz-pos, "power_scheme = %d\n",\r\niwlmvm_mod_params.power_scheme);\r\npos += scnprintf(buf+pos, bufsz-pos, "flags = 0x%x\n",\r\nle16_to_cpu(cmd.flags));\r\npos += scnprintf(buf+pos, bufsz-pos, "keep_alive = %d\n",\r\ncmd.keep_alive_seconds);\r\nif (cmd.flags & cpu_to_le16(POWER_FLAGS_POWER_MANAGEMENT_ENA_MSK)) {\r\npos += scnprintf(buf+pos, bufsz-pos, "skip_over_dtim = %d\n",\r\n(cmd.flags &\r\ncpu_to_le16(POWER_FLAGS_SKIP_OVER_DTIM_MSK)) ?\r\n1 : 0);\r\npos += scnprintf(buf+pos, bufsz-pos, "rx_data_timeout = %d\n",\r\nle32_to_cpu(cmd.rx_data_timeout));\r\npos += scnprintf(buf+pos, bufsz-pos, "tx_data_timeout = %d\n",\r\nle32_to_cpu(cmd.tx_data_timeout));\r\nif (cmd.flags & cpu_to_le16(POWER_FLAGS_LPRX_ENA_MSK))\r\npos += scnprintf(buf+pos, bufsz-pos,\r\n"lprx_rssi_threshold = %d\n",\r\nle32_to_cpu(cmd.lprx_rssi_threshold));\r\n}\r\nreturn pos;\r\n}

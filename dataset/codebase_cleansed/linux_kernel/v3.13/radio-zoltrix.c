static struct radio_isa_card *zoltrix_alloc(void)\r\n{\r\nstruct zoltrix *zol = kzalloc(sizeof(*zol), GFP_KERNEL);\r\nreturn zol ? &zol->isa : NULL;\r\n}\r\nstatic int zoltrix_s_mute_volume(struct radio_isa_card *isa, bool mute, int vol)\r\n{\r\nstruct zoltrix *zol = container_of(isa, struct zoltrix, isa);\r\nzol->curvol = vol;\r\nzol->muted = mute;\r\nif (mute || vol == 0) {\r\noutb(0, isa->io);\r\noutb(0, isa->io);\r\ninb(isa->io + 3);\r\nreturn 0;\r\n}\r\noutb(vol - 1, isa->io);\r\nmsleep(10);\r\ninb(isa->io + 2);\r\nreturn 0;\r\n}\r\nstatic int zoltrix_s_frequency(struct radio_isa_card *isa, u32 freq)\r\n{\r\nstruct zoltrix *zol = container_of(isa, struct zoltrix, isa);\r\nstruct v4l2_device *v4l2_dev = &isa->v4l2_dev;\r\nunsigned long long bitmask, f, m;\r\nbool stereo = isa->stereo;\r\nint i;\r\nif (freq == 0) {\r\nv4l2_warn(v4l2_dev, "cannot set a frequency of 0.\n");\r\nreturn -EINVAL;\r\n}\r\nm = (freq / 160 - 8800) * 2;\r\nf = (unsigned long long)m + 0x4d1c;\r\nbitmask = 0xc480402c10080000ull;\r\ni = 45;\r\noutb(0, isa->io);\r\noutb(0, isa->io);\r\ninb(isa->io + 3);\r\noutb(0x40, isa->io);\r\noutb(0xc0, isa->io);\r\nbitmask = (bitmask ^ ((f & 0xff) << 47) ^ ((f & 0xff00) << 30) ^ (stereo << 31));\r\nwhile (i--) {\r\nif ((bitmask & 0x8000000000000000ull) != 0) {\r\noutb(0x80, isa->io);\r\nudelay(50);\r\noutb(0x00, isa->io);\r\nudelay(50);\r\noutb(0x80, isa->io);\r\nudelay(50);\r\n} else {\r\noutb(0xc0, isa->io);\r\nudelay(50);\r\noutb(0x40, isa->io);\r\nudelay(50);\r\noutb(0xc0, isa->io);\r\nudelay(50);\r\n}\r\nbitmask *= 2;\r\n}\r\noutb(0x80, isa->io);\r\noutb(0xc0, isa->io);\r\noutb(0x40, isa->io);\r\nudelay(1000);\r\ninb(isa->io + 2);\r\nudelay(1000);\r\nreturn zoltrix_s_mute_volume(isa, zol->muted, zol->curvol);\r\n}\r\nstatic u32 zoltrix_g_rxsubchans(struct radio_isa_card *isa)\r\n{\r\nstruct zoltrix *zol = container_of(isa, struct zoltrix, isa);\r\nint a, b;\r\noutb(0x00, isa->io);\r\noutb(zol->curvol, isa->io);\r\nmsleep(20);\r\na = inb(isa->io);\r\nmsleep(10);\r\nb = inb(isa->io);\r\nreturn (a == b && a == 0xcf) ?\r\nV4L2_TUNER_SUB_STEREO : V4L2_TUNER_SUB_MONO;\r\n}\r\nstatic u32 zoltrix_g_signal(struct radio_isa_card *isa)\r\n{\r\nstruct zoltrix *zol = container_of(isa, struct zoltrix, isa);\r\nint a, b;\r\noutb(0x00, isa->io);\r\noutb(zol->curvol, isa->io);\r\nmsleep(20);\r\na = inb(isa->io);\r\nmsleep(10);\r\nb = inb(isa->io);\r\nif (a != b)\r\nreturn 0;\r\nreturn (a == 0xcf || a == 0xdf || a == 0xef) ? 0xffff : 0;\r\n}\r\nstatic int zoltrix_s_stereo(struct radio_isa_card *isa, bool stereo)\r\n{\r\nreturn zoltrix_s_frequency(isa, isa->freq);\r\n}\r\nstatic int __init zoltrix_init(void)\r\n{\r\nreturn isa_register_driver(&zoltrix_driver.driver, ZOLTRIX_MAX);\r\n}\r\nstatic void __exit zoltrix_exit(void)\r\n{\r\nisa_unregister_driver(&zoltrix_driver.driver);\r\n}

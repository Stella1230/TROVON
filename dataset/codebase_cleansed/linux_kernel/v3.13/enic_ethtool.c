static int enic_get_settings(struct net_device *netdev,\r\nstruct ethtool_cmd *ecmd)\r\n{\r\nstruct enic *enic = netdev_priv(netdev);\r\necmd->supported = (SUPPORTED_10000baseT_Full | SUPPORTED_FIBRE);\r\necmd->advertising = (ADVERTISED_10000baseT_Full | ADVERTISED_FIBRE);\r\necmd->port = PORT_FIBRE;\r\necmd->transceiver = XCVR_EXTERNAL;\r\nif (netif_carrier_ok(netdev)) {\r\nethtool_cmd_speed_set(ecmd, vnic_dev_port_speed(enic->vdev));\r\necmd->duplex = DUPLEX_FULL;\r\n} else {\r\nethtool_cmd_speed_set(ecmd, -1);\r\necmd->duplex = -1;\r\n}\r\necmd->autoneg = AUTONEG_DISABLE;\r\nreturn 0;\r\n}\r\nstatic void enic_get_drvinfo(struct net_device *netdev,\r\nstruct ethtool_drvinfo *drvinfo)\r\n{\r\nstruct enic *enic = netdev_priv(netdev);\r\nstruct vnic_devcmd_fw_info *fw_info;\r\nenic_dev_fw_info(enic, &fw_info);\r\nstrlcpy(drvinfo->driver, DRV_NAME, sizeof(drvinfo->driver));\r\nstrlcpy(drvinfo->version, DRV_VERSION, sizeof(drvinfo->version));\r\nstrlcpy(drvinfo->fw_version, fw_info->fw_version,\r\nsizeof(drvinfo->fw_version));\r\nstrlcpy(drvinfo->bus_info, pci_name(enic->pdev),\r\nsizeof(drvinfo->bus_info));\r\n}\r\nstatic void enic_get_strings(struct net_device *netdev, u32 stringset,\r\nu8 *data)\r\n{\r\nunsigned int i;\r\nswitch (stringset) {\r\ncase ETH_SS_STATS:\r\nfor (i = 0; i < enic_n_tx_stats; i++) {\r\nmemcpy(data, enic_tx_stats[i].name, ETH_GSTRING_LEN);\r\ndata += ETH_GSTRING_LEN;\r\n}\r\nfor (i = 0; i < enic_n_rx_stats; i++) {\r\nmemcpy(data, enic_rx_stats[i].name, ETH_GSTRING_LEN);\r\ndata += ETH_GSTRING_LEN;\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic int enic_get_sset_count(struct net_device *netdev, int sset)\r\n{\r\nswitch (sset) {\r\ncase ETH_SS_STATS:\r\nreturn enic_n_tx_stats + enic_n_rx_stats;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\n}\r\nstatic void enic_get_ethtool_stats(struct net_device *netdev,\r\nstruct ethtool_stats *stats, u64 *data)\r\n{\r\nstruct enic *enic = netdev_priv(netdev);\r\nstruct vnic_stats *vstats;\r\nunsigned int i;\r\nenic_dev_stats_dump(enic, &vstats);\r\nfor (i = 0; i < enic_n_tx_stats; i++)\r\n*(data++) = ((u64 *)&vstats->tx)[enic_tx_stats[i].index];\r\nfor (i = 0; i < enic_n_rx_stats; i++)\r\n*(data++) = ((u64 *)&vstats->rx)[enic_rx_stats[i].index];\r\n}\r\nstatic u32 enic_get_msglevel(struct net_device *netdev)\r\n{\r\nstruct enic *enic = netdev_priv(netdev);\r\nreturn enic->msg_enable;\r\n}\r\nstatic void enic_set_msglevel(struct net_device *netdev, u32 value)\r\n{\r\nstruct enic *enic = netdev_priv(netdev);\r\nenic->msg_enable = value;\r\n}\r\nstatic int enic_get_coalesce(struct net_device *netdev,\r\nstruct ethtool_coalesce *ecmd)\r\n{\r\nstruct enic *enic = netdev_priv(netdev);\r\necmd->tx_coalesce_usecs = enic->tx_coalesce_usecs;\r\necmd->rx_coalesce_usecs = enic->rx_coalesce_usecs;\r\nreturn 0;\r\n}\r\nstatic int enic_set_coalesce(struct net_device *netdev,\r\nstruct ethtool_coalesce *ecmd)\r\n{\r\nstruct enic *enic = netdev_priv(netdev);\r\nu32 tx_coalesce_usecs;\r\nu32 rx_coalesce_usecs;\r\nunsigned int i, intr;\r\ntx_coalesce_usecs = min_t(u32, ecmd->tx_coalesce_usecs,\r\nvnic_dev_get_intr_coal_timer_max(enic->vdev));\r\nrx_coalesce_usecs = min_t(u32, ecmd->rx_coalesce_usecs,\r\nvnic_dev_get_intr_coal_timer_max(enic->vdev));\r\nswitch (vnic_dev_get_intr_mode(enic->vdev)) {\r\ncase VNIC_DEV_INTR_MODE_INTX:\r\nif (tx_coalesce_usecs != rx_coalesce_usecs)\r\nreturn -EINVAL;\r\nintr = enic_legacy_io_intr();\r\nvnic_intr_coalescing_timer_set(&enic->intr[intr],\r\ntx_coalesce_usecs);\r\nbreak;\r\ncase VNIC_DEV_INTR_MODE_MSI:\r\nif (tx_coalesce_usecs != rx_coalesce_usecs)\r\nreturn -EINVAL;\r\nvnic_intr_coalescing_timer_set(&enic->intr[0],\r\ntx_coalesce_usecs);\r\nbreak;\r\ncase VNIC_DEV_INTR_MODE_MSIX:\r\nfor (i = 0; i < enic->wq_count; i++) {\r\nintr = enic_msix_wq_intr(enic, i);\r\nvnic_intr_coalescing_timer_set(&enic->intr[intr],\r\ntx_coalesce_usecs);\r\n}\r\nfor (i = 0; i < enic->rq_count; i++) {\r\nintr = enic_msix_rq_intr(enic, i);\r\nvnic_intr_coalescing_timer_set(&enic->intr[intr],\r\nrx_coalesce_usecs);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nenic->tx_coalesce_usecs = tx_coalesce_usecs;\r\nenic->rx_coalesce_usecs = rx_coalesce_usecs;\r\nreturn 0;\r\n}\r\nvoid enic_set_ethtool_ops(struct net_device *netdev)\r\n{\r\nSET_ETHTOOL_OPS(netdev, &enic_ethtool_ops);\r\n}

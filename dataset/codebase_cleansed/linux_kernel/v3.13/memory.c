struct linux_mdesc * __init ArcGetMemoryDescriptor(struct linux_mdesc *Current)\r\n{\r\nreturn (struct linux_mdesc *) ARC_CALL1(get_mdesc, Current);\r\n}\r\nstatic inline int memtype_classify_arcs(union linux_memtypes type)\r\n{\r\nswitch (type.arcs) {\r\ncase arcs_fcontig:\r\ncase arcs_free:\r\nreturn BOOT_MEM_RAM;\r\ncase arcs_atmp:\r\nreturn BOOT_MEM_ROM_DATA;\r\ncase arcs_eblock:\r\ncase arcs_rvpage:\r\ncase arcs_bmem:\r\ncase arcs_prog:\r\ncase arcs_aperm:\r\nreturn BOOT_MEM_RESERVED;\r\ndefault:\r\nBUG();\r\n}\r\nwhile(1);\r\n}\r\nstatic inline int memtype_classify_arc(union linux_memtypes type)\r\n{\r\nswitch (type.arc) {\r\ncase arc_free:\r\ncase arc_fcontig:\r\nreturn BOOT_MEM_RAM;\r\ncase arc_atmp:\r\nreturn BOOT_MEM_ROM_DATA;\r\ncase arc_eblock:\r\ncase arc_rvpage:\r\ncase arc_bmem:\r\ncase arc_prog:\r\ncase arc_aperm:\r\nreturn BOOT_MEM_RESERVED;\r\ndefault:\r\nBUG();\r\n}\r\nwhile(1);\r\n}\r\nstatic int __init prom_memtype_classify(union linux_memtypes type)\r\n{\r\nif (prom_flags & PROM_FLAG_ARCS)\r\nreturn memtype_classify_arcs(type);\r\nreturn memtype_classify_arc(type);\r\n}\r\nvoid __init prom_meminit(void)\r\n{\r\nstruct linux_mdesc *p;\r\n#ifdef DEBUG\r\nint i = 0;\r\nprintk("ARCS MEMORY DESCRIPTOR dump:\n");\r\np = ArcGetMemoryDescriptor(PROM_NULL_MDESC);\r\nwhile(p) {\r\nprintk("[%d,%p]: base<%08lx> pages<%08lx> type<%s>\n",\r\ni, p, p->base, p->pages, mtypes(p->type));\r\np = ArcGetMemoryDescriptor(p);\r\ni++;\r\n}\r\n#endif\r\np = PROM_NULL_MDESC;\r\nwhile ((p = ArcGetMemoryDescriptor(p))) {\r\nunsigned long base, size;\r\nlong type;\r\nbase = p->base << ARC_PAGE_SHIFT;\r\nsize = p->pages << ARC_PAGE_SHIFT;\r\ntype = prom_memtype_classify(p->type);\r\nadd_memory_region(base, size, type);\r\n}\r\n}\r\nvoid __init prom_free_prom_memory(void)\r\n{\r\nunsigned long addr;\r\nint i;\r\nif (prom_flags & PROM_FLAG_DONT_FREE_TEMP)\r\nreturn;\r\nfor (i = 0; i < boot_mem_map.nr_map; i++) {\r\nif (boot_mem_map.map[i].type != BOOT_MEM_ROM_DATA)\r\ncontinue;\r\naddr = boot_mem_map.map[i].addr;\r\nfree_init_pages("prom memory",\r\naddr, addr + boot_mem_map.map[i].size);\r\n}\r\n}

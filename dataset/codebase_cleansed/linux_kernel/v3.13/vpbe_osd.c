static inline u32 osd_read(struct osd_state *sd, u32 offset)\r\n{\r\nstruct osd_state *osd = sd;\r\nreturn readl(osd->osd_base + offset);\r\n}\r\nstatic inline u32 osd_write(struct osd_state *sd, u32 val, u32 offset)\r\n{\r\nstruct osd_state *osd = sd;\r\nwritel(val, osd->osd_base + offset);\r\nreturn val;\r\n}\r\nstatic inline u32 osd_set(struct osd_state *sd, u32 mask, u32 offset)\r\n{\r\nstruct osd_state *osd = sd;\r\nvoid __iomem *addr = osd->osd_base + offset;\r\nu32 val = readl(addr) | mask;\r\nwritel(val, addr);\r\nreturn val;\r\n}\r\nstatic inline u32 osd_clear(struct osd_state *sd, u32 mask, u32 offset)\r\n{\r\nstruct osd_state *osd = sd;\r\nvoid __iomem *addr = osd->osd_base + offset;\r\nu32 val = readl(addr) & ~mask;\r\nwritel(val, addr);\r\nreturn val;\r\n}\r\nstatic inline u32 osd_modify(struct osd_state *sd, u32 mask, u32 val,\r\nu32 offset)\r\n{\r\nstruct osd_state *osd = sd;\r\nvoid __iomem *addr = osd->osd_base + offset;\r\nu32 new_val = (readl(addr) & ~mask) | (val & mask);\r\nwritel(new_val, addr);\r\nreturn new_val;\r\n}\r\nstatic int _osd_dm6446_vid0_pingpong(struct osd_state *sd,\r\nint field_inversion,\r\nunsigned long fb_base_phys,\r\nconst struct osd_layer_config *lconfig)\r\n{\r\nstruct osd_platform_data *pdata;\r\npdata = (struct osd_platform_data *)sd->dev->platform_data;\r\nif (pdata != NULL && pdata->field_inv_wa_enable) {\r\nif (!field_inversion || !lconfig->interlaced) {\r\nosd_write(sd, fb_base_phys & ~0x1F, OSD_VIDWIN0ADR);\r\nosd_write(sd, fb_base_phys & ~0x1F, OSD_PPVWIN0ADR);\r\nosd_modify(sd, OSD_MISCCTL_PPSW | OSD_MISCCTL_PPRV, 0,\r\nOSD_MISCCTL);\r\nreturn 0;\r\n} else {\r\nunsigned miscctl = OSD_MISCCTL_PPRV;\r\nosd_write(sd,\r\n(fb_base_phys & ~0x1F) - lconfig->line_length,\r\nOSD_VIDWIN0ADR);\r\nosd_write(sd,\r\n(fb_base_phys & ~0x1F) + lconfig->line_length,\r\nOSD_PPVWIN0ADR);\r\nosd_modify(sd,\r\nOSD_MISCCTL_PPSW | OSD_MISCCTL_PPRV, miscctl,\r\nOSD_MISCCTL);\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void _osd_set_field_inversion(struct osd_state *sd, int enable)\r\n{\r\nunsigned fsinv = 0;\r\nif (enable)\r\nfsinv = OSD_MODE_FSINV;\r\nosd_modify(sd, OSD_MODE_FSINV, fsinv, OSD_MODE);\r\n}\r\nstatic void _osd_set_blink_attribute(struct osd_state *sd, int enable,\r\nenum osd_blink_interval blink)\r\n{\r\nu32 osdatrmd = 0;\r\nif (enable) {\r\nosdatrmd |= OSD_OSDATRMD_BLNK;\r\nosdatrmd |= blink << OSD_OSDATRMD_BLNKINT_SHIFT;\r\n}\r\nosd_modify(sd, OSD_OSDATRMD_BLNKINT | OSD_OSDATRMD_BLNK, osdatrmd,\r\nOSD_OSDATRMD);\r\n}\r\nstatic void _osd_set_rom_clut(struct osd_state *sd,\r\nenum osd_rom_clut rom_clut)\r\n{\r\nif (rom_clut == ROM_CLUT0)\r\nosd_clear(sd, OSD_MISCCTL_RSEL, OSD_MISCCTL);\r\nelse\r\nosd_set(sd, OSD_MISCCTL_RSEL, OSD_MISCCTL);\r\n}\r\nstatic void _osd_set_palette_map(struct osd_state *sd,\r\nenum osd_win_layer osdwin,\r\nunsigned char pixel_value,\r\nunsigned char clut_index,\r\nenum osd_pix_format pixfmt)\r\n{\r\nstatic const int map_2bpp[] = { 0, 5, 10, 15 };\r\nstatic const int map_1bpp[] = { 0, 15 };\r\nint bmp_offset;\r\nint bmp_shift;\r\nint bmp_mask;\r\nint bmp_reg;\r\nswitch (pixfmt) {\r\ncase PIXFMT_1BPP:\r\nbmp_reg = map_1bpp[pixel_value & 0x1];\r\nbreak;\r\ncase PIXFMT_2BPP:\r\nbmp_reg = map_2bpp[pixel_value & 0x3];\r\nbreak;\r\ncase PIXFMT_4BPP:\r\nbmp_reg = pixel_value & 0xf;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nswitch (osdwin) {\r\ncase OSDWIN_OSD0:\r\nbmp_offset = OSD_W0BMP01 + (bmp_reg >> 1) * sizeof(u32);\r\nbreak;\r\ncase OSDWIN_OSD1:\r\nbmp_offset = OSD_W1BMP01 + (bmp_reg >> 1) * sizeof(u32);\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nif (bmp_reg & 1) {\r\nbmp_shift = 8;\r\nbmp_mask = 0xff << 8;\r\n} else {\r\nbmp_shift = 0;\r\nbmp_mask = 0xff;\r\n}\r\nosd_modify(sd, bmp_mask, clut_index << bmp_shift, bmp_offset);\r\n}\r\nstatic void _osd_set_rec601_attenuation(struct osd_state *sd,\r\nenum osd_win_layer osdwin, int enable)\r\n{\r\nswitch (osdwin) {\r\ncase OSDWIN_OSD0:\r\nosd_modify(sd, OSD_OSDWIN0MD_ATN0E,\r\nenable ? OSD_OSDWIN0MD_ATN0E : 0,\r\nOSD_OSDWIN0MD);\r\nif (sd->vpbe_type == VPBE_VERSION_1)\r\nosd_modify(sd, OSD_OSDWIN0MD_ATN0E,\r\nenable ? OSD_OSDWIN0MD_ATN0E : 0,\r\nOSD_OSDWIN0MD);\r\nelse if ((sd->vpbe_type == VPBE_VERSION_3) ||\r\n(sd->vpbe_type == VPBE_VERSION_2))\r\nosd_modify(sd, OSD_EXTMODE_ATNOSD0EN,\r\nenable ? OSD_EXTMODE_ATNOSD0EN : 0,\r\nOSD_EXTMODE);\r\nbreak;\r\ncase OSDWIN_OSD1:\r\nosd_modify(sd, OSD_OSDWIN1MD_ATN1E,\r\nenable ? OSD_OSDWIN1MD_ATN1E : 0,\r\nOSD_OSDWIN1MD);\r\nif (sd->vpbe_type == VPBE_VERSION_1)\r\nosd_modify(sd, OSD_OSDWIN1MD_ATN1E,\r\nenable ? OSD_OSDWIN1MD_ATN1E : 0,\r\nOSD_OSDWIN1MD);\r\nelse if ((sd->vpbe_type == VPBE_VERSION_3) ||\r\n(sd->vpbe_type == VPBE_VERSION_2))\r\nosd_modify(sd, OSD_EXTMODE_ATNOSD1EN,\r\nenable ? OSD_EXTMODE_ATNOSD1EN : 0,\r\nOSD_EXTMODE);\r\nbreak;\r\n}\r\n}\r\nstatic void _osd_set_blending_factor(struct osd_state *sd,\r\nenum osd_win_layer osdwin,\r\nenum osd_blending_factor blend)\r\n{\r\nswitch (osdwin) {\r\ncase OSDWIN_OSD0:\r\nosd_modify(sd, OSD_OSDWIN0MD_BLND0,\r\nblend << OSD_OSDWIN0MD_BLND0_SHIFT, OSD_OSDWIN0MD);\r\nbreak;\r\ncase OSDWIN_OSD1:\r\nosd_modify(sd, OSD_OSDWIN1MD_BLND1,\r\nblend << OSD_OSDWIN1MD_BLND1_SHIFT, OSD_OSDWIN1MD);\r\nbreak;\r\n}\r\n}\r\nstatic void _osd_enable_rgb888_pixblend(struct osd_state *sd,\r\nenum osd_win_layer osdwin)\r\n{\r\nosd_modify(sd, OSD_MISCCTL_BLDSEL, 0, OSD_MISCCTL);\r\nswitch (osdwin) {\r\ncase OSDWIN_OSD0:\r\nosd_modify(sd, OSD_EXTMODE_OSD0BLDCHR,\r\nOSD_EXTMODE_OSD0BLDCHR, OSD_EXTMODE);\r\nbreak;\r\ncase OSDWIN_OSD1:\r\nosd_modify(sd, OSD_EXTMODE_OSD1BLDCHR,\r\nOSD_EXTMODE_OSD1BLDCHR, OSD_EXTMODE);\r\nbreak;\r\n}\r\n}\r\nstatic void _osd_enable_color_key(struct osd_state *sd,\r\nenum osd_win_layer osdwin,\r\nunsigned colorkey,\r\nenum osd_pix_format pixfmt)\r\n{\r\nswitch (pixfmt) {\r\ncase PIXFMT_1BPP:\r\ncase PIXFMT_2BPP:\r\ncase PIXFMT_4BPP:\r\ncase PIXFMT_8BPP:\r\nif (sd->vpbe_type == VPBE_VERSION_3) {\r\nswitch (osdwin) {\r\ncase OSDWIN_OSD0:\r\nosd_modify(sd, OSD_TRANSPBMPIDX_BMP0,\r\ncolorkey <<\r\nOSD_TRANSPBMPIDX_BMP0_SHIFT,\r\nOSD_TRANSPBMPIDX);\r\nbreak;\r\ncase OSDWIN_OSD1:\r\nosd_modify(sd, OSD_TRANSPBMPIDX_BMP1,\r\ncolorkey <<\r\nOSD_TRANSPBMPIDX_BMP1_SHIFT,\r\nOSD_TRANSPBMPIDX);\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ncase PIXFMT_RGB565:\r\nif (sd->vpbe_type == VPBE_VERSION_1)\r\nosd_write(sd, colorkey & OSD_TRANSPVAL_RGBTRANS,\r\nOSD_TRANSPVAL);\r\nelse if (sd->vpbe_type == VPBE_VERSION_3)\r\nosd_write(sd, colorkey & OSD_TRANSPVALL_RGBL,\r\nOSD_TRANSPVALL);\r\nbreak;\r\ncase PIXFMT_YCBCRI:\r\ncase PIXFMT_YCRCBI:\r\nif (sd->vpbe_type == VPBE_VERSION_3)\r\nosd_modify(sd, OSD_TRANSPVALU_Y, colorkey,\r\nOSD_TRANSPVALU);\r\nbreak;\r\ncase PIXFMT_RGB888:\r\nif (sd->vpbe_type == VPBE_VERSION_3) {\r\nosd_write(sd, colorkey & OSD_TRANSPVALL_RGBL,\r\nOSD_TRANSPVALL);\r\nosd_modify(sd, OSD_TRANSPVALU_RGBU, colorkey >> 16,\r\nOSD_TRANSPVALU);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (osdwin) {\r\ncase OSDWIN_OSD0:\r\nosd_set(sd, OSD_OSDWIN0MD_TE0, OSD_OSDWIN0MD);\r\nbreak;\r\ncase OSDWIN_OSD1:\r\nosd_set(sd, OSD_OSDWIN1MD_TE1, OSD_OSDWIN1MD);\r\nbreak;\r\n}\r\n}\r\nstatic void _osd_disable_color_key(struct osd_state *sd,\r\nenum osd_win_layer osdwin)\r\n{\r\nswitch (osdwin) {\r\ncase OSDWIN_OSD0:\r\nosd_clear(sd, OSD_OSDWIN0MD_TE0, OSD_OSDWIN0MD);\r\nbreak;\r\ncase OSDWIN_OSD1:\r\nosd_clear(sd, OSD_OSDWIN1MD_TE1, OSD_OSDWIN1MD);\r\nbreak;\r\n}\r\n}\r\nstatic void _osd_set_osd_clut(struct osd_state *sd,\r\nenum osd_win_layer osdwin,\r\nenum osd_clut clut)\r\n{\r\nu32 winmd = 0;\r\nswitch (osdwin) {\r\ncase OSDWIN_OSD0:\r\nif (clut == RAM_CLUT)\r\nwinmd |= OSD_OSDWIN0MD_CLUTS0;\r\nosd_modify(sd, OSD_OSDWIN0MD_CLUTS0, winmd, OSD_OSDWIN0MD);\r\nbreak;\r\ncase OSDWIN_OSD1:\r\nif (clut == RAM_CLUT)\r\nwinmd |= OSD_OSDWIN1MD_CLUTS1;\r\nosd_modify(sd, OSD_OSDWIN1MD_CLUTS1, winmd, OSD_OSDWIN1MD);\r\nbreak;\r\n}\r\n}\r\nstatic void _osd_set_zoom(struct osd_state *sd, enum osd_layer layer,\r\nenum osd_zoom_factor h_zoom,\r\nenum osd_zoom_factor v_zoom)\r\n{\r\nu32 winmd = 0;\r\nswitch (layer) {\r\ncase WIN_OSD0:\r\nwinmd |= (h_zoom << OSD_OSDWIN0MD_OHZ0_SHIFT);\r\nwinmd |= (v_zoom << OSD_OSDWIN0MD_OVZ0_SHIFT);\r\nosd_modify(sd, OSD_OSDWIN0MD_OHZ0 | OSD_OSDWIN0MD_OVZ0, winmd,\r\nOSD_OSDWIN0MD);\r\nbreak;\r\ncase WIN_VID0:\r\nwinmd |= (h_zoom << OSD_VIDWINMD_VHZ0_SHIFT);\r\nwinmd |= (v_zoom << OSD_VIDWINMD_VVZ0_SHIFT);\r\nosd_modify(sd, OSD_VIDWINMD_VHZ0 | OSD_VIDWINMD_VVZ0, winmd,\r\nOSD_VIDWINMD);\r\nbreak;\r\ncase WIN_OSD1:\r\nwinmd |= (h_zoom << OSD_OSDWIN1MD_OHZ1_SHIFT);\r\nwinmd |= (v_zoom << OSD_OSDWIN1MD_OVZ1_SHIFT);\r\nosd_modify(sd, OSD_OSDWIN1MD_OHZ1 | OSD_OSDWIN1MD_OVZ1, winmd,\r\nOSD_OSDWIN1MD);\r\nbreak;\r\ncase WIN_VID1:\r\nwinmd |= (h_zoom << OSD_VIDWINMD_VHZ1_SHIFT);\r\nwinmd |= (v_zoom << OSD_VIDWINMD_VVZ1_SHIFT);\r\nosd_modify(sd, OSD_VIDWINMD_VHZ1 | OSD_VIDWINMD_VVZ1, winmd,\r\nOSD_VIDWINMD);\r\nbreak;\r\n}\r\n}\r\nstatic void _osd_disable_layer(struct osd_state *sd, enum osd_layer layer)\r\n{\r\nswitch (layer) {\r\ncase WIN_OSD0:\r\nosd_clear(sd, OSD_OSDWIN0MD_OACT0, OSD_OSDWIN0MD);\r\nbreak;\r\ncase WIN_VID0:\r\nosd_clear(sd, OSD_VIDWINMD_ACT0, OSD_VIDWINMD);\r\nbreak;\r\ncase WIN_OSD1:\r\nosd_clear(sd, OSD_OSDWIN1MD_OASW | OSD_OSDWIN1MD_OACT1,\r\nOSD_OSDWIN1MD);\r\nbreak;\r\ncase WIN_VID1:\r\nosd_clear(sd, OSD_VIDWINMD_ACT1, OSD_VIDWINMD);\r\nbreak;\r\n}\r\n}\r\nstatic void osd_disable_layer(struct osd_state *sd, enum osd_layer layer)\r\n{\r\nstruct osd_state *osd = sd;\r\nstruct osd_window_state *win = &osd->win[layer];\r\nunsigned long flags;\r\nspin_lock_irqsave(&osd->lock, flags);\r\nif (!win->is_enabled) {\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\nreturn;\r\n}\r\nwin->is_enabled = 0;\r\n_osd_disable_layer(sd, layer);\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\n}\r\nstatic void _osd_enable_attribute_mode(struct osd_state *sd)\r\n{\r\nosd_set(sd, OSD_OSDWIN1MD_OASW, OSD_OSDWIN1MD);\r\n}\r\nstatic void _osd_enable_layer(struct osd_state *sd, enum osd_layer layer)\r\n{\r\nswitch (layer) {\r\ncase WIN_OSD0:\r\nosd_set(sd, OSD_OSDWIN0MD_OACT0, OSD_OSDWIN0MD);\r\nbreak;\r\ncase WIN_VID0:\r\nosd_set(sd, OSD_VIDWINMD_ACT0, OSD_VIDWINMD);\r\nbreak;\r\ncase WIN_OSD1:\r\nosd_modify(sd, OSD_OSDWIN1MD_OASW | OSD_OSDWIN1MD_OACT1,\r\nOSD_OSDWIN1MD_OACT1, OSD_OSDWIN1MD);\r\nbreak;\r\ncase WIN_VID1:\r\nosd_set(sd, OSD_VIDWINMD_ACT1, OSD_VIDWINMD);\r\nbreak;\r\n}\r\n}\r\nstatic int osd_enable_layer(struct osd_state *sd, enum osd_layer layer,\r\nint otherwin)\r\n{\r\nstruct osd_state *osd = sd;\r\nstruct osd_window_state *win = &osd->win[layer];\r\nstruct osd_layer_config *cfg = &win->lconfig;\r\nunsigned long flags;\r\nspin_lock_irqsave(&osd->lock, flags);\r\nif (!otherwin && (!win->is_allocated ||\r\n!win->fb_base_phys ||\r\n!cfg->line_length ||\r\n!cfg->xsize ||\r\n!cfg->ysize)) {\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\nreturn -1;\r\n}\r\nif (win->is_enabled) {\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\nreturn 0;\r\n}\r\nwin->is_enabled = 1;\r\nif (cfg->pixfmt != PIXFMT_OSD_ATTR)\r\n_osd_enable_layer(sd, layer);\r\nelse {\r\n_osd_enable_attribute_mode(sd);\r\n_osd_set_blink_attribute(sd, osd->is_blinking, osd->blink);\r\n}\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void _osd_start_layer(struct osd_state *sd, enum osd_layer layer,\r\nunsigned long fb_base_phys,\r\nunsigned long cbcr_ofst)\r\n{\r\nif (sd->vpbe_type == VPBE_VERSION_1) {\r\nswitch (layer) {\r\ncase WIN_OSD0:\r\nosd_write(sd, fb_base_phys & ~0x1F, OSD_OSDWIN0ADR);\r\nbreak;\r\ncase WIN_VID0:\r\nosd_write(sd, fb_base_phys & ~0x1F, OSD_VIDWIN0ADR);\r\nbreak;\r\ncase WIN_OSD1:\r\nosd_write(sd, fb_base_phys & ~0x1F, OSD_OSDWIN1ADR);\r\nbreak;\r\ncase WIN_VID1:\r\nosd_write(sd, fb_base_phys & ~0x1F, OSD_VIDWIN1ADR);\r\nbreak;\r\n}\r\n} else if (sd->vpbe_type == VPBE_VERSION_3) {\r\nunsigned long fb_offset_32 =\r\n(fb_base_phys - VPBE_REG_BASE) >> 5;\r\nswitch (layer) {\r\ncase WIN_OSD0:\r\nosd_modify(sd, OSD_OSDWINADH_O0AH,\r\nfb_offset_32 >> (OSD_SRCADD_ADD_SFT -\r\nOSD_OSDWINADH_O0AH_SHIFT),\r\nOSD_OSDWINADH);\r\nosd_write(sd, fb_offset_32 & OSD_OSDWIN0ADL_O0AL,\r\nOSD_OSDWIN0ADL);\r\nbreak;\r\ncase WIN_VID0:\r\nosd_modify(sd, OSD_VIDWINADH_V0AH,\r\nfb_offset_32 >> (OSD_SRCADD_ADD_SFT -\r\nOSD_VIDWINADH_V0AH_SHIFT),\r\nOSD_VIDWINADH);\r\nosd_write(sd, fb_offset_32 & OSD_VIDWIN0ADL_V0AL,\r\nOSD_VIDWIN0ADL);\r\nbreak;\r\ncase WIN_OSD1:\r\nosd_modify(sd, OSD_OSDWINADH_O1AH,\r\nfb_offset_32 >> (OSD_SRCADD_ADD_SFT -\r\nOSD_OSDWINADH_O1AH_SHIFT),\r\nOSD_OSDWINADH);\r\nosd_write(sd, fb_offset_32 & OSD_OSDWIN1ADL_O1AL,\r\nOSD_OSDWIN1ADL);\r\nbreak;\r\ncase WIN_VID1:\r\nosd_modify(sd, OSD_VIDWINADH_V1AH,\r\nfb_offset_32 >> (OSD_SRCADD_ADD_SFT -\r\nOSD_VIDWINADH_V1AH_SHIFT),\r\nOSD_VIDWINADH);\r\nosd_write(sd, fb_offset_32 & OSD_VIDWIN1ADL_V1AL,\r\nOSD_VIDWIN1ADL);\r\nbreak;\r\n}\r\n} else if (sd->vpbe_type == VPBE_VERSION_2) {\r\nstruct osd_window_state *win = &sd->win[layer];\r\nunsigned long fb_offset_32, cbcr_offset_32;\r\nfb_offset_32 = fb_base_phys - VPBE_REG_BASE;\r\nif (cbcr_ofst)\r\ncbcr_offset_32 = cbcr_ofst;\r\nelse\r\ncbcr_offset_32 = win->lconfig.line_length *\r\nwin->lconfig.ysize;\r\ncbcr_offset_32 += fb_offset_32;\r\nfb_offset_32 = fb_offset_32 >> 5;\r\ncbcr_offset_32 = cbcr_offset_32 >> 5;\r\nif (win->lconfig.pixfmt == PIXFMT_NV12) {\r\nswitch (layer) {\r\ncase WIN_VID0:\r\ncase WIN_VID1:\r\nosd_modify(sd, OSD_VIDWIN0OFST_V0AH,\r\n((fb_offset_32 & OSD_SRC_ADDR_HIGH4) >>\r\n(OSD_SRCADD_OFSET_SFT -\r\nOSD_WINOFST_AH_SHIFT)) |\r\nOSD_WINOFST_MASK, OSD_VIDWIN0OFST);\r\nosd_modify(sd, OSD_VIDWINADH_V0AH,\r\n(fb_offset_32 & OSD_SRC_ADDR_HIGH7) >>\r\n(OSD_SRCADD_ADD_SFT -\r\nOSD_VIDWINADH_V0AH_SHIFT),\r\nOSD_VIDWINADH);\r\nosd_write(sd, fb_offset_32 & OSD_WINADL_MASK,\r\nOSD_VIDWIN0ADL);\r\nosd_modify(sd, OSD_VIDWIN1OFST_V1AH,\r\n((cbcr_offset_32 &\r\nOSD_SRC_ADDR_HIGH4) >>\r\n(OSD_SRCADD_OFSET_SFT -\r\nOSD_WINOFST_AH_SHIFT)) |\r\nOSD_WINOFST_MASK, OSD_VIDWIN1OFST);\r\nosd_modify(sd, OSD_VIDWINADH_V1AH,\r\n(cbcr_offset_32 &\r\nOSD_SRC_ADDR_HIGH7) >>\r\n(OSD_SRCADD_ADD_SFT -\r\nOSD_VIDWINADH_V1AH_SHIFT),\r\nOSD_VIDWINADH);\r\nosd_write(sd, cbcr_offset_32 & OSD_WINADL_MASK,\r\nOSD_VIDWIN1ADL);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nswitch (layer) {\r\ncase WIN_OSD0:\r\nosd_modify(sd, OSD_OSDWIN0OFST_O0AH,\r\n((fb_offset_32 & OSD_SRC_ADDR_HIGH4) >>\r\n(OSD_SRCADD_OFSET_SFT -\r\nOSD_WINOFST_AH_SHIFT)) | OSD_WINOFST_MASK,\r\nOSD_OSDWIN0OFST);\r\nosd_modify(sd, OSD_OSDWINADH_O0AH,\r\n(fb_offset_32 & OSD_SRC_ADDR_HIGH7) >>\r\n(OSD_SRCADD_ADD_SFT -\r\nOSD_OSDWINADH_O0AH_SHIFT), OSD_OSDWINADH);\r\nosd_write(sd, fb_offset_32 & OSD_WINADL_MASK,\r\nOSD_OSDWIN0ADL);\r\nbreak;\r\ncase WIN_VID0:\r\nif (win->lconfig.pixfmt != PIXFMT_NV12) {\r\nosd_modify(sd, OSD_VIDWIN0OFST_V0AH,\r\n((fb_offset_32 & OSD_SRC_ADDR_HIGH4) >>\r\n(OSD_SRCADD_OFSET_SFT -\r\nOSD_WINOFST_AH_SHIFT)) |\r\nOSD_WINOFST_MASK, OSD_VIDWIN0OFST);\r\nosd_modify(sd, OSD_VIDWINADH_V0AH,\r\n(fb_offset_32 & OSD_SRC_ADDR_HIGH7) >>\r\n(OSD_SRCADD_ADD_SFT -\r\nOSD_VIDWINADH_V0AH_SHIFT),\r\nOSD_VIDWINADH);\r\nosd_write(sd, fb_offset_32 & OSD_WINADL_MASK,\r\nOSD_VIDWIN0ADL);\r\n}\r\nbreak;\r\ncase WIN_OSD1:\r\nosd_modify(sd, OSD_OSDWIN1OFST_O1AH,\r\n((fb_offset_32 & OSD_SRC_ADDR_HIGH4) >>\r\n(OSD_SRCADD_OFSET_SFT -\r\nOSD_WINOFST_AH_SHIFT)) | OSD_WINOFST_MASK,\r\nOSD_OSDWIN1OFST);\r\nosd_modify(sd, OSD_OSDWINADH_O1AH,\r\n(fb_offset_32 & OSD_SRC_ADDR_HIGH7) >>\r\n(OSD_SRCADD_ADD_SFT -\r\nOSD_OSDWINADH_O1AH_SHIFT),\r\nOSD_OSDWINADH);\r\nosd_write(sd, fb_offset_32 & OSD_WINADL_MASK,\r\nOSD_OSDWIN1ADL);\r\nbreak;\r\ncase WIN_VID1:\r\nif (win->lconfig.pixfmt != PIXFMT_NV12) {\r\nosd_modify(sd, OSD_VIDWIN1OFST_V1AH,\r\n((fb_offset_32 & OSD_SRC_ADDR_HIGH4) >>\r\n(OSD_SRCADD_OFSET_SFT -\r\nOSD_WINOFST_AH_SHIFT)) |\r\nOSD_WINOFST_MASK, OSD_VIDWIN1OFST);\r\nosd_modify(sd, OSD_VIDWINADH_V1AH,\r\n(fb_offset_32 & OSD_SRC_ADDR_HIGH7) >>\r\n(OSD_SRCADD_ADD_SFT -\r\nOSD_VIDWINADH_V1AH_SHIFT),\r\nOSD_VIDWINADH);\r\nosd_write(sd, fb_offset_32 & OSD_WINADL_MASK,\r\nOSD_VIDWIN1ADL);\r\n}\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void osd_start_layer(struct osd_state *sd, enum osd_layer layer,\r\nunsigned long fb_base_phys,\r\nunsigned long cbcr_ofst)\r\n{\r\nstruct osd_state *osd = sd;\r\nstruct osd_window_state *win = &osd->win[layer];\r\nstruct osd_layer_config *cfg = &win->lconfig;\r\nunsigned long flags;\r\nspin_lock_irqsave(&osd->lock, flags);\r\nwin->fb_base_phys = fb_base_phys & ~0x1F;\r\n_osd_start_layer(sd, layer, fb_base_phys, cbcr_ofst);\r\nif (layer == WIN_VID0) {\r\nosd->pingpong =\r\n_osd_dm6446_vid0_pingpong(sd, osd->field_inversion,\r\nwin->fb_base_phys,\r\ncfg);\r\n}\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\n}\r\nstatic void osd_get_layer_config(struct osd_state *sd, enum osd_layer layer,\r\nstruct osd_layer_config *lconfig)\r\n{\r\nstruct osd_state *osd = sd;\r\nstruct osd_window_state *win = &osd->win[layer];\r\nunsigned long flags;\r\nspin_lock_irqsave(&osd->lock, flags);\r\n*lconfig = win->lconfig;\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\n}\r\nstatic int try_layer_config(struct osd_state *sd, enum osd_layer layer,\r\nstruct osd_layer_config *lconfig)\r\n{\r\nstruct osd_state *osd = sd;\r\nstruct osd_window_state *win = &osd->win[layer];\r\nint bad_config = 0;\r\nswitch (lconfig->pixfmt) {\r\ncase PIXFMT_1BPP:\r\ncase PIXFMT_2BPP:\r\ncase PIXFMT_4BPP:\r\ncase PIXFMT_8BPP:\r\ncase PIXFMT_RGB565:\r\nif (osd->vpbe_type == VPBE_VERSION_1)\r\nbad_config = !is_vid_win(layer);\r\nbreak;\r\ncase PIXFMT_YCBCRI:\r\ncase PIXFMT_YCRCBI:\r\nbad_config = !is_vid_win(layer);\r\nbreak;\r\ncase PIXFMT_RGB888:\r\nif (osd->vpbe_type == VPBE_VERSION_1)\r\nbad_config = !is_vid_win(layer);\r\nelse if ((osd->vpbe_type == VPBE_VERSION_3) ||\r\n(osd->vpbe_type == VPBE_VERSION_2))\r\nbad_config = !is_osd_win(layer);\r\nbreak;\r\ncase PIXFMT_NV12:\r\nif (osd->vpbe_type != VPBE_VERSION_2)\r\nbad_config = 1;\r\nelse\r\nbad_config = is_osd_win(layer);\r\nbreak;\r\ncase PIXFMT_OSD_ATTR:\r\nbad_config = (layer != WIN_OSD1);\r\nbreak;\r\ndefault:\r\nbad_config = 1;\r\nbreak;\r\n}\r\nif (bad_config) {\r\n*lconfig = win->lconfig;\r\nreturn bad_config;\r\n}\r\nif ((osd->vpbe_type == VPBE_VERSION_1) &&\r\nis_osd_win(layer) && is_rgb_pixfmt(lconfig->pixfmt)) {\r\nenum osd_pix_format pixfmt;\r\nif (layer == WIN_OSD0)\r\npixfmt = osd->win[WIN_OSD1].lconfig.pixfmt;\r\nelse\r\npixfmt = osd->win[WIN_OSD0].lconfig.pixfmt;\r\nif (is_rgb_pixfmt(pixfmt)) {\r\n*lconfig = win->lconfig;\r\nreturn 1;\r\n}\r\n}\r\nif ((osd->vpbe_type == VPBE_VERSION_1) && is_vid_win(layer) &&\r\nlconfig->pixfmt == PIXFMT_RGB888) {\r\nenum osd_pix_format pixfmt;\r\nif (layer == WIN_VID0)\r\npixfmt = osd->win[WIN_VID1].lconfig.pixfmt;\r\nelse\r\npixfmt = osd->win[WIN_VID0].lconfig.pixfmt;\r\nif (pixfmt == PIXFMT_RGB888) {\r\n*lconfig = win->lconfig;\r\nreturn 1;\r\n}\r\n}\r\nif (!lconfig->line_length || !lconfig->xsize || !lconfig->ysize) {\r\n*lconfig = win->lconfig;\r\nreturn 1;\r\n}\r\nlconfig->line_length = ((lconfig->line_length + 31) / 32) * 32;\r\nlconfig->line_length =\r\nmin(lconfig->line_length, (unsigned)MAX_LINE_LENGTH);\r\nlconfig->xsize = min(lconfig->xsize, (unsigned)MAX_WIN_SIZE);\r\nlconfig->ysize = min(lconfig->ysize, (unsigned)MAX_WIN_SIZE);\r\nlconfig->xpos = min(lconfig->xpos, (unsigned)MAX_WIN_SIZE);\r\nlconfig->ypos = min(lconfig->ypos, (unsigned)MAX_WIN_SIZE);\r\nlconfig->interlaced = (lconfig->interlaced != 0);\r\nif (lconfig->interlaced) {\r\nlconfig->ysize &= ~1;\r\nlconfig->ypos &= ~1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void _osd_disable_vid_rgb888(struct osd_state *sd)\r\n{\r\nif (sd->vpbe_type == VPBE_VERSION_1)\r\nosd_clear(sd, OSD_MISCCTL_RGBEN, OSD_MISCCTL);\r\n}\r\nstatic void _osd_enable_vid_rgb888(struct osd_state *sd,\r\nenum osd_layer layer)\r\n{\r\nif (sd->vpbe_type == VPBE_VERSION_1) {\r\nif (layer == WIN_VID0)\r\nosd_modify(sd, OSD_MISCCTL_RGBEN | OSD_MISCCTL_RGBWIN,\r\nOSD_MISCCTL_RGBEN, OSD_MISCCTL);\r\nelse if (layer == WIN_VID1)\r\nosd_modify(sd, OSD_MISCCTL_RGBEN | OSD_MISCCTL_RGBWIN,\r\nOSD_MISCCTL_RGBEN | OSD_MISCCTL_RGBWIN,\r\nOSD_MISCCTL);\r\n}\r\n}\r\nstatic void _osd_set_cbcr_order(struct osd_state *sd,\r\nenum osd_pix_format pixfmt)\r\n{\r\nif (pixfmt == PIXFMT_YCBCRI)\r\nosd_clear(sd, OSD_MODE_CS, OSD_MODE);\r\nelse if (pixfmt == PIXFMT_YCRCBI)\r\nosd_set(sd, OSD_MODE_CS, OSD_MODE);\r\n}\r\nstatic void _osd_set_layer_config(struct osd_state *sd, enum osd_layer layer,\r\nconst struct osd_layer_config *lconfig)\r\n{\r\nu32 winmd = 0, winmd_mask = 0, bmw = 0;\r\n_osd_set_cbcr_order(sd, lconfig->pixfmt);\r\nswitch (layer) {\r\ncase WIN_OSD0:\r\nif (sd->vpbe_type == VPBE_VERSION_1) {\r\nwinmd_mask |= OSD_OSDWIN0MD_RGB0E;\r\nif (lconfig->pixfmt == PIXFMT_RGB565)\r\nwinmd |= OSD_OSDWIN0MD_RGB0E;\r\n} else if ((sd->vpbe_type == VPBE_VERSION_3) ||\r\n(sd->vpbe_type == VPBE_VERSION_2)) {\r\nwinmd_mask |= OSD_OSDWIN0MD_BMP0MD;\r\nswitch (lconfig->pixfmt) {\r\ncase PIXFMT_RGB565:\r\nwinmd |= (1 <<\r\nOSD_OSDWIN0MD_BMP0MD_SHIFT);\r\nbreak;\r\ncase PIXFMT_RGB888:\r\nwinmd |= (2 << OSD_OSDWIN0MD_BMP0MD_SHIFT);\r\n_osd_enable_rgb888_pixblend(sd, OSDWIN_OSD0);\r\nbreak;\r\ncase PIXFMT_YCBCRI:\r\ncase PIXFMT_YCRCBI:\r\nwinmd |= (3 << OSD_OSDWIN0MD_BMP0MD_SHIFT);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nwinmd_mask |= OSD_OSDWIN0MD_BMW0 | OSD_OSDWIN0MD_OFF0;\r\nswitch (lconfig->pixfmt) {\r\ncase PIXFMT_1BPP:\r\nbmw = 0;\r\nbreak;\r\ncase PIXFMT_2BPP:\r\nbmw = 1;\r\nbreak;\r\ncase PIXFMT_4BPP:\r\nbmw = 2;\r\nbreak;\r\ncase PIXFMT_8BPP:\r\nbmw = 3;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nwinmd |= (bmw << OSD_OSDWIN0MD_BMW0_SHIFT);\r\nif (lconfig->interlaced)\r\nwinmd |= OSD_OSDWIN0MD_OFF0;\r\nosd_modify(sd, winmd_mask, winmd, OSD_OSDWIN0MD);\r\nosd_write(sd, lconfig->line_length >> 5, OSD_OSDWIN0OFST);\r\nosd_write(sd, lconfig->xpos, OSD_OSDWIN0XP);\r\nosd_write(sd, lconfig->xsize, OSD_OSDWIN0XL);\r\nif (lconfig->interlaced) {\r\nosd_write(sd, lconfig->ypos >> 1, OSD_OSDWIN0YP);\r\nosd_write(sd, lconfig->ysize >> 1, OSD_OSDWIN0YL);\r\n} else {\r\nosd_write(sd, lconfig->ypos, OSD_OSDWIN0YP);\r\nosd_write(sd, lconfig->ysize, OSD_OSDWIN0YL);\r\n}\r\nbreak;\r\ncase WIN_VID0:\r\nwinmd_mask |= OSD_VIDWINMD_VFF0;\r\nif (lconfig->interlaced)\r\nwinmd |= OSD_VIDWINMD_VFF0;\r\nosd_modify(sd, winmd_mask, winmd, OSD_VIDWINMD);\r\nosd_write(sd, lconfig->line_length >> 5, OSD_VIDWIN0OFST);\r\nosd_write(sd, lconfig->xpos, OSD_VIDWIN0XP);\r\nosd_write(sd, lconfig->xsize, OSD_VIDWIN0XL);\r\nif ((sd->vpbe_type == VPBE_VERSION_2) &&\r\n(lconfig->pixfmt == PIXFMT_NV12)) {\r\nif (lconfig->interlaced) {\r\nwinmd_mask |= OSD_VIDWINMD_VFF1;\r\nwinmd |= OSD_VIDWINMD_VFF1;\r\nosd_modify(sd, winmd_mask, winmd,\r\nOSD_VIDWINMD);\r\n}\r\nosd_modify(sd, OSD_MISCCTL_S420D,\r\nOSD_MISCCTL_S420D, OSD_MISCCTL);\r\nosd_write(sd, lconfig->line_length >> 5,\r\nOSD_VIDWIN1OFST);\r\nosd_write(sd, lconfig->xpos, OSD_VIDWIN1XP);\r\nosd_write(sd, lconfig->xsize, OSD_VIDWIN1XL);\r\nif (lconfig->xsize % 32) {\r\nosd_write(sd,\r\n((lconfig->xsize + 31) & ~31),\r\nOSD_VIDWIN1XL);\r\nosd_write(sd,\r\n((lconfig->xsize + 31) & ~31),\r\nOSD_VIDWIN0XL);\r\n}\r\n} else if ((sd->vpbe_type == VPBE_VERSION_2) &&\r\n(lconfig->pixfmt != PIXFMT_NV12)) {\r\nosd_modify(sd, OSD_MISCCTL_S420D, ~OSD_MISCCTL_S420D,\r\nOSD_MISCCTL);\r\n}\r\nif (lconfig->interlaced) {\r\nosd_write(sd, lconfig->ypos >> 1, OSD_VIDWIN0YP);\r\nosd_write(sd, lconfig->ysize >> 1, OSD_VIDWIN0YL);\r\nif ((sd->vpbe_type == VPBE_VERSION_2) &&\r\nlconfig->pixfmt == PIXFMT_NV12) {\r\nosd_write(sd, lconfig->ypos >> 1,\r\nOSD_VIDWIN1YP);\r\nosd_write(sd, lconfig->ysize >> 1,\r\nOSD_VIDWIN1YL);\r\n}\r\n} else {\r\nosd_write(sd, lconfig->ypos, OSD_VIDWIN0YP);\r\nosd_write(sd, lconfig->ysize, OSD_VIDWIN0YL);\r\nif ((sd->vpbe_type == VPBE_VERSION_2) &&\r\nlconfig->pixfmt == PIXFMT_NV12) {\r\nosd_write(sd, lconfig->ypos, OSD_VIDWIN1YP);\r\nosd_write(sd, lconfig->ysize, OSD_VIDWIN1YL);\r\n}\r\n}\r\nbreak;\r\ncase WIN_OSD1:\r\nif (lconfig->pixfmt == PIXFMT_OSD_ATTR) {\r\nif (sd->vpbe_type == VPBE_VERSION_1) {\r\nwinmd_mask |= OSD_OSDWIN1MD_ATN1E |\r\nOSD_OSDWIN1MD_RGB1E | OSD_OSDWIN1MD_CLUTS1 |\r\nOSD_OSDWIN1MD_BLND1 | OSD_OSDWIN1MD_TE1;\r\n} else {\r\nwinmd_mask |= OSD_OSDWIN1MD_BMP1MD |\r\nOSD_OSDWIN1MD_CLUTS1 | OSD_OSDWIN1MD_BLND1 |\r\nOSD_OSDWIN1MD_TE1;\r\n}\r\n} else {\r\nif (sd->vpbe_type == VPBE_VERSION_1) {\r\nwinmd_mask |= OSD_OSDWIN1MD_RGB1E;\r\nif (lconfig->pixfmt == PIXFMT_RGB565)\r\nwinmd |= OSD_OSDWIN1MD_RGB1E;\r\n} else if ((sd->vpbe_type == VPBE_VERSION_3)\r\n|| (sd->vpbe_type == VPBE_VERSION_2)) {\r\nwinmd_mask |= OSD_OSDWIN1MD_BMP1MD;\r\nswitch (lconfig->pixfmt) {\r\ncase PIXFMT_RGB565:\r\nwinmd |=\r\n(1 << OSD_OSDWIN1MD_BMP1MD_SHIFT);\r\nbreak;\r\ncase PIXFMT_RGB888:\r\nwinmd |=\r\n(2 << OSD_OSDWIN1MD_BMP1MD_SHIFT);\r\n_osd_enable_rgb888_pixblend(sd,\r\nOSDWIN_OSD1);\r\nbreak;\r\ncase PIXFMT_YCBCRI:\r\ncase PIXFMT_YCRCBI:\r\nwinmd |=\r\n(3 << OSD_OSDWIN1MD_BMP1MD_SHIFT);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nwinmd_mask |= OSD_OSDWIN1MD_BMW1;\r\nswitch (lconfig->pixfmt) {\r\ncase PIXFMT_1BPP:\r\nbmw = 0;\r\nbreak;\r\ncase PIXFMT_2BPP:\r\nbmw = 1;\r\nbreak;\r\ncase PIXFMT_4BPP:\r\nbmw = 2;\r\nbreak;\r\ncase PIXFMT_8BPP:\r\nbmw = 3;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nwinmd |= (bmw << OSD_OSDWIN1MD_BMW1_SHIFT);\r\n}\r\nwinmd_mask |= OSD_OSDWIN1MD_OFF1;\r\nif (lconfig->interlaced)\r\nwinmd |= OSD_OSDWIN1MD_OFF1;\r\nosd_modify(sd, winmd_mask, winmd, OSD_OSDWIN1MD);\r\nosd_write(sd, lconfig->line_length >> 5, OSD_OSDWIN1OFST);\r\nosd_write(sd, lconfig->xpos, OSD_OSDWIN1XP);\r\nosd_write(sd, lconfig->xsize, OSD_OSDWIN1XL);\r\nif (lconfig->interlaced) {\r\nosd_write(sd, lconfig->ypos >> 1, OSD_OSDWIN1YP);\r\nosd_write(sd, lconfig->ysize >> 1, OSD_OSDWIN1YL);\r\n} else {\r\nosd_write(sd, lconfig->ypos, OSD_OSDWIN1YP);\r\nosd_write(sd, lconfig->ysize, OSD_OSDWIN1YL);\r\n}\r\nbreak;\r\ncase WIN_VID1:\r\nwinmd_mask |= OSD_VIDWINMD_VFF1;\r\nif (lconfig->interlaced)\r\nwinmd |= OSD_VIDWINMD_VFF1;\r\nosd_modify(sd, winmd_mask, winmd, OSD_VIDWINMD);\r\nosd_write(sd, lconfig->line_length >> 5, OSD_VIDWIN1OFST);\r\nosd_write(sd, lconfig->xpos, OSD_VIDWIN1XP);\r\nosd_write(sd, lconfig->xsize, OSD_VIDWIN1XL);\r\nif (sd->vpbe_type == VPBE_VERSION_2) {\r\nif (lconfig->pixfmt == PIXFMT_NV12) {\r\nif (lconfig->interlaced) {\r\nwinmd_mask |= OSD_VIDWINMD_VFF0;\r\nwinmd |= OSD_VIDWINMD_VFF0;\r\nosd_modify(sd, winmd_mask, winmd,\r\nOSD_VIDWINMD);\r\n}\r\nosd_modify(sd, OSD_MISCCTL_S420D,\r\nOSD_MISCCTL_S420D, OSD_MISCCTL);\r\nosd_write(sd, lconfig->line_length >> 5,\r\nOSD_VIDWIN0OFST);\r\nosd_write(sd, lconfig->xpos, OSD_VIDWIN0XP);\r\nosd_write(sd, lconfig->xsize, OSD_VIDWIN0XL);\r\n} else {\r\nosd_modify(sd, OSD_MISCCTL_S420D,\r\n~OSD_MISCCTL_S420D, OSD_MISCCTL);\r\n}\r\n}\r\nif (lconfig->interlaced) {\r\nosd_write(sd, lconfig->ypos >> 1, OSD_VIDWIN1YP);\r\nosd_write(sd, lconfig->ysize >> 1, OSD_VIDWIN1YL);\r\nif ((sd->vpbe_type == VPBE_VERSION_2) &&\r\nlconfig->pixfmt == PIXFMT_NV12) {\r\nosd_write(sd, lconfig->ypos >> 1,\r\nOSD_VIDWIN0YP);\r\nosd_write(sd, lconfig->ysize >> 1,\r\nOSD_VIDWIN0YL);\r\n}\r\n} else {\r\nosd_write(sd, lconfig->ypos, OSD_VIDWIN1YP);\r\nosd_write(sd, lconfig->ysize, OSD_VIDWIN1YL);\r\nif ((sd->vpbe_type == VPBE_VERSION_2) &&\r\nlconfig->pixfmt == PIXFMT_NV12) {\r\nosd_write(sd, lconfig->ypos, OSD_VIDWIN0YP);\r\nosd_write(sd, lconfig->ysize, OSD_VIDWIN0YL);\r\n}\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic int osd_set_layer_config(struct osd_state *sd, enum osd_layer layer,\r\nstruct osd_layer_config *lconfig)\r\n{\r\nstruct osd_state *osd = sd;\r\nstruct osd_window_state *win = &osd->win[layer];\r\nstruct osd_layer_config *cfg = &win->lconfig;\r\nunsigned long flags;\r\nint reject_config;\r\nspin_lock_irqsave(&osd->lock, flags);\r\nreject_config = try_layer_config(sd, layer, lconfig);\r\nif (reject_config) {\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\nreturn reject_config;\r\n}\r\nif (is_yc_pixfmt(lconfig->pixfmt))\r\nosd->yc_pixfmt = lconfig->pixfmt;\r\nif (layer == WIN_OSD1) {\r\nif (((lconfig->pixfmt == PIXFMT_OSD_ATTR) &&\r\n(cfg->pixfmt != PIXFMT_OSD_ATTR)) ||\r\n((lconfig->pixfmt != PIXFMT_OSD_ATTR) &&\r\n(cfg->pixfmt == PIXFMT_OSD_ATTR))) {\r\nwin->is_enabled = 0;\r\n_osd_disable_layer(sd, layer);\r\n}\r\n}\r\n_osd_set_layer_config(sd, layer, lconfig);\r\nif (layer == WIN_OSD1) {\r\nstruct osd_osdwin_state *osdwin_state =\r\n&osd->osdwin[OSDWIN_OSD1];\r\nif ((lconfig->pixfmt != PIXFMT_OSD_ATTR) &&\r\n(cfg->pixfmt == PIXFMT_OSD_ATTR)) {\r\n_osd_set_osd_clut(sd, OSDWIN_OSD1,\r\nosdwin_state->clut);\r\n_osd_set_blending_factor(sd, OSDWIN_OSD1,\r\nosdwin_state->blend);\r\nif (osdwin_state->colorkey_blending) {\r\n_osd_enable_color_key(sd, OSDWIN_OSD1,\r\nosdwin_state->\r\ncolorkey,\r\nlconfig->pixfmt);\r\n} else\r\n_osd_disable_color_key(sd, OSDWIN_OSD1);\r\n_osd_set_rec601_attenuation(sd, OSDWIN_OSD1,\r\nosdwin_state->\r\nrec601_attenuation);\r\n} else if ((lconfig->pixfmt == PIXFMT_OSD_ATTR) &&\r\n(cfg->pixfmt != PIXFMT_OSD_ATTR)) {\r\n_osd_set_blink_attribute(sd, osd->is_blinking,\r\nosd->blink);\r\n}\r\n}\r\nif ((lconfig->pixfmt != cfg->pixfmt) &&\r\n((lconfig->pixfmt == PIXFMT_1BPP) ||\r\n(lconfig->pixfmt == PIXFMT_2BPP) ||\r\n(lconfig->pixfmt == PIXFMT_4BPP))) {\r\nenum osd_win_layer osdwin =\r\n((layer == WIN_OSD0) ? OSDWIN_OSD0 : OSDWIN_OSD1);\r\nstruct osd_osdwin_state *osdwin_state =\r\n&osd->osdwin[osdwin];\r\nunsigned char clut_index;\r\nunsigned char clut_entries = 0;\r\nswitch (lconfig->pixfmt) {\r\ncase PIXFMT_1BPP:\r\nclut_entries = 2;\r\nbreak;\r\ncase PIXFMT_2BPP:\r\nclut_entries = 4;\r\nbreak;\r\ncase PIXFMT_4BPP:\r\nclut_entries = 16;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nfor (clut_index = 0; clut_index < 16; clut_index++) {\r\nosdwin_state->palette_map[clut_index] = clut_index;\r\nif (clut_index < clut_entries) {\r\n_osd_set_palette_map(sd, osdwin, clut_index,\r\nclut_index,\r\nlconfig->pixfmt);\r\n}\r\n}\r\n}\r\n*cfg = *lconfig;\r\nif (osd->win[WIN_VID0].lconfig.pixfmt == PIXFMT_RGB888)\r\n_osd_enable_vid_rgb888(sd, WIN_VID0);\r\nelse if (osd->win[WIN_VID1].lconfig.pixfmt == PIXFMT_RGB888)\r\n_osd_enable_vid_rgb888(sd, WIN_VID1);\r\nelse\r\n_osd_disable_vid_rgb888(sd);\r\nif (layer == WIN_VID0) {\r\nosd->pingpong =\r\n_osd_dm6446_vid0_pingpong(sd, osd->field_inversion,\r\nwin->fb_base_phys,\r\ncfg);\r\n}\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void osd_init_layer(struct osd_state *sd, enum osd_layer layer)\r\n{\r\nstruct osd_state *osd = sd;\r\nstruct osd_window_state *win = &osd->win[layer];\r\nenum osd_win_layer osdwin;\r\nstruct osd_osdwin_state *osdwin_state;\r\nstruct osd_layer_config *cfg = &win->lconfig;\r\nunsigned long flags;\r\nspin_lock_irqsave(&osd->lock, flags);\r\nwin->is_enabled = 0;\r\n_osd_disable_layer(sd, layer);\r\nwin->h_zoom = ZOOM_X1;\r\nwin->v_zoom = ZOOM_X1;\r\n_osd_set_zoom(sd, layer, win->h_zoom, win->v_zoom);\r\nwin->fb_base_phys = 0;\r\n_osd_start_layer(sd, layer, win->fb_base_phys, 0);\r\ncfg->line_length = 0;\r\ncfg->xsize = 0;\r\ncfg->ysize = 0;\r\ncfg->xpos = 0;\r\ncfg->ypos = 0;\r\ncfg->interlaced = 0;\r\nswitch (layer) {\r\ncase WIN_OSD0:\r\ncase WIN_OSD1:\r\nosdwin = (layer == WIN_OSD0) ? OSDWIN_OSD0 : OSDWIN_OSD1;\r\nosdwin_state = &osd->osdwin[osdwin];\r\ncfg->pixfmt = PIXFMT_8BPP;\r\n_osd_set_layer_config(sd, layer, cfg);\r\nosdwin_state->clut = RAM_CLUT;\r\n_osd_set_osd_clut(sd, osdwin, osdwin_state->clut);\r\nosdwin_state->colorkey_blending = 0;\r\n_osd_disable_color_key(sd, osdwin);\r\nosdwin_state->blend = OSD_8_VID_0;\r\n_osd_set_blending_factor(sd, osdwin, osdwin_state->blend);\r\nosdwin_state->rec601_attenuation = 0;\r\n_osd_set_rec601_attenuation(sd, osdwin,\r\nosdwin_state->\r\nrec601_attenuation);\r\nif (osdwin == OSDWIN_OSD1) {\r\nosd->is_blinking = 0;\r\nosd->blink = BLINK_X1;\r\n}\r\nbreak;\r\ncase WIN_VID0:\r\ncase WIN_VID1:\r\ncfg->pixfmt = osd->yc_pixfmt;\r\n_osd_set_layer_config(sd, layer, cfg);\r\nbreak;\r\n}\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\n}\r\nstatic void osd_release_layer(struct osd_state *sd, enum osd_layer layer)\r\n{\r\nstruct osd_state *osd = sd;\r\nstruct osd_window_state *win = &osd->win[layer];\r\nunsigned long flags;\r\nspin_lock_irqsave(&osd->lock, flags);\r\nif (!win->is_allocated) {\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\nreturn;\r\n}\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\nosd_init_layer(sd, layer);\r\nspin_lock_irqsave(&osd->lock, flags);\r\nwin->is_allocated = 0;\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\n}\r\nstatic int osd_request_layer(struct osd_state *sd, enum osd_layer layer)\r\n{\r\nstruct osd_state *osd = sd;\r\nstruct osd_window_state *win = &osd->win[layer];\r\nunsigned long flags;\r\nspin_lock_irqsave(&osd->lock, flags);\r\nif (win->is_allocated) {\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\nreturn -1;\r\n}\r\nwin->is_allocated = 1;\r\nspin_unlock_irqrestore(&osd->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void _osd_init(struct osd_state *sd)\r\n{\r\nosd_write(sd, 0, OSD_MODE);\r\nosd_write(sd, 0, OSD_VIDWINMD);\r\nosd_write(sd, 0, OSD_OSDWIN0MD);\r\nosd_write(sd, 0, OSD_OSDWIN1MD);\r\nosd_write(sd, 0, OSD_RECTCUR);\r\nosd_write(sd, 0, OSD_MISCCTL);\r\nif (sd->vpbe_type == VPBE_VERSION_3) {\r\nosd_write(sd, 0, OSD_VBNDRY);\r\nosd_write(sd, 0, OSD_EXTMODE);\r\nosd_write(sd, OSD_MISCCTL_DMANG, OSD_MISCCTL);\r\n}\r\n}\r\nstatic void osd_set_left_margin(struct osd_state *sd, u32 val)\r\n{\r\nosd_write(sd, val, OSD_BASEPX);\r\n}\r\nstatic void osd_set_top_margin(struct osd_state *sd, u32 val)\r\n{\r\nosd_write(sd, val, OSD_BASEPY);\r\n}\r\nstatic int osd_initialize(struct osd_state *osd)\r\n{\r\nif (osd == NULL)\r\nreturn -ENODEV;\r\n_osd_init(osd);\r\nosd->yc_pixfmt = PIXFMT_YCBCRI;\r\nif (osd->vpbe_type == VPBE_VERSION_3) {\r\nosd->rom_clut = ROM_CLUT1;\r\n}\r\n_osd_set_field_inversion(osd, osd->field_inversion);\r\n_osd_set_rom_clut(osd, osd->rom_clut);\r\nosd_init_layer(osd, WIN_OSD0);\r\nosd_init_layer(osd, WIN_VID0);\r\nosd_init_layer(osd, WIN_OSD1);\r\nosd_init_layer(osd, WIN_VID1);\r\nreturn 0;\r\n}\r\nstatic int osd_probe(struct platform_device *pdev)\r\n{\r\nconst struct platform_device_id *pdev_id;\r\nstruct osd_state *osd;\r\nstruct resource *res;\r\npdev_id = platform_get_device_id(pdev);\r\nif (!pdev_id)\r\nreturn -EINVAL;\r\nosd = devm_kzalloc(&pdev->dev, sizeof(struct osd_state), GFP_KERNEL);\r\nif (osd == NULL)\r\nreturn -ENOMEM;\r\nosd->dev = &pdev->dev;\r\nosd->vpbe_type = pdev_id->driver_data;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nosd->osd_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(osd->osd_base))\r\nreturn PTR_ERR(osd->osd_base);\r\nosd->osd_base_phys = res->start;\r\nosd->osd_size = resource_size(res);\r\nspin_lock_init(&osd->lock);\r\nosd->ops = osd_ops;\r\nplatform_set_drvdata(pdev, osd);\r\ndev_notice(osd->dev, "OSD sub device probe success\n");\r\nreturn 0;\r\n}\r\nstatic int osd_remove(struct platform_device *pdev)\r\n{\r\nreturn 0;\r\n}

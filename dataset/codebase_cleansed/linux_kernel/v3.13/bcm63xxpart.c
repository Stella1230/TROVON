static int bcm63xx_detect_cfe(struct mtd_info *master)\r\n{\r\nchar buf[9];\r\nint ret;\r\nsize_t retlen;\r\nret = mtd_read(master, BCM963XX_CFE_VERSION_OFFSET, 5, &retlen,\r\n(void *)buf);\r\nbuf[retlen] = 0;\r\nif (ret)\r\nreturn ret;\r\nif (strncmp("cfe-v", buf, 5) == 0)\r\nreturn 0;\r\nret = mtd_read(master, BCM63XX_CFE_MAGIC_OFFSET, 8, &retlen,\r\n(void *)buf);\r\nbuf[retlen] = 0;\r\nreturn strncmp("CFE1CFE1", buf, 8);\r\n}\r\nstatic int bcm63xx_parse_cfe_partitions(struct mtd_info *master,\r\nstruct mtd_partition **pparts,\r\nstruct mtd_part_parser_data *data)\r\n{\r\nint nrparts = 3, curpart = 0;\r\nstruct bcm_tag *buf;\r\nstruct mtd_partition *parts;\r\nint ret;\r\nsize_t retlen;\r\nunsigned int rootfsaddr, kerneladdr, spareaddr;\r\nunsigned int rootfslen, kernellen, sparelen, totallen;\r\nunsigned int cfelen, nvramlen;\r\nunsigned int cfe_erasesize;\r\nint i;\r\nu32 computed_crc;\r\nbool rootfs_first = false;\r\nif (bcm63xx_detect_cfe(master))\r\nreturn -EINVAL;\r\ncfe_erasesize = max_t(uint32_t, master->erasesize,\r\nBCM63XX_CFE_BLOCK_SIZE);\r\ncfelen = cfe_erasesize;\r\nnvramlen = bcm63xx_nvram_get_psi_size() * SZ_1K;\r\nnvramlen = roundup(nvramlen, cfe_erasesize);\r\nbuf = vmalloc(sizeof(struct bcm_tag));\r\nif (!buf)\r\nreturn -ENOMEM;\r\nret = mtd_read(master, cfelen, sizeof(struct bcm_tag), &retlen,\r\n(void *)buf);\r\nif (retlen != sizeof(struct bcm_tag)) {\r\nvfree(buf);\r\nreturn -EIO;\r\n}\r\ncomputed_crc = crc32_le(IMAGETAG_CRC_START, (u8 *)buf,\r\noffsetof(struct bcm_tag, header_crc));\r\nif (computed_crc == buf->header_crc) {\r\nchar *boardid = &(buf->board_id[0]);\r\nchar *tagversion = &(buf->tag_version[0]);\r\nsscanf(buf->flash_image_start, "%u", &rootfsaddr);\r\nsscanf(buf->kernel_address, "%u", &kerneladdr);\r\nsscanf(buf->kernel_length, "%u", &kernellen);\r\nsscanf(buf->total_length, "%u", &totallen);\r\npr_info("CFE boot tag found with version %s and board type %s\n",\r\ntagversion, boardid);\r\nkerneladdr = kerneladdr - BCM63XX_EXTENDED_SIZE;\r\nrootfsaddr = rootfsaddr - BCM63XX_EXTENDED_SIZE;\r\nspareaddr = roundup(totallen, master->erasesize) + cfelen;\r\nif (rootfsaddr < kerneladdr) {\r\nrootfslen = kerneladdr - rootfsaddr;\r\nrootfs_first = true;\r\n} else {\r\nrootfsaddr = kerneladdr + kernellen;\r\nrootfslen = spareaddr - rootfsaddr;\r\n}\r\n} else {\r\npr_warn("CFE boot tag CRC invalid (expected %08x, actual %08x)\n",\r\nbuf->header_crc, computed_crc);\r\nkernellen = 0;\r\nrootfslen = 0;\r\nrootfsaddr = 0;\r\nspareaddr = cfelen;\r\n}\r\nsparelen = master->size - spareaddr - nvramlen;\r\nif (rootfslen > 0)\r\nnrparts++;\r\nif (kernellen > 0)\r\nnrparts++;\r\nparts = kzalloc(sizeof(*parts) * nrparts + 10 * nrparts, GFP_KERNEL);\r\nif (!parts) {\r\nvfree(buf);\r\nreturn -ENOMEM;\r\n}\r\nparts[curpart].name = "CFE";\r\nparts[curpart].offset = 0;\r\nparts[curpart].size = cfelen;\r\ncurpart++;\r\nif (kernellen > 0) {\r\nint kernelpart = curpart;\r\nif (rootfslen > 0 && rootfs_first)\r\nkernelpart++;\r\nparts[kernelpart].name = "kernel";\r\nparts[kernelpart].offset = kerneladdr;\r\nparts[kernelpart].size = kernellen;\r\ncurpart++;\r\n}\r\nif (rootfslen > 0) {\r\nint rootfspart = curpart;\r\nif (kernellen > 0 && rootfs_first)\r\nrootfspart--;\r\nparts[rootfspart].name = "rootfs";\r\nparts[rootfspart].offset = rootfsaddr;\r\nparts[rootfspart].size = rootfslen;\r\nif (sparelen > 0 && !rootfs_first)\r\nparts[rootfspart].size += sparelen;\r\ncurpart++;\r\n}\r\nparts[curpart].name = "nvram";\r\nparts[curpart].offset = master->size - nvramlen;\r\nparts[curpart].size = nvramlen;\r\ncurpart++;\r\nparts[curpart].name = "linux";\r\nparts[curpart].offset = cfelen;\r\nparts[curpart].size = master->size - cfelen - nvramlen;\r\nfor (i = 0; i < nrparts; i++)\r\npr_info("Partition %d is %s offset %llx and length %llx\n", i,\r\nparts[i].name, parts[i].offset, parts[i].size);\r\npr_info("Spare partition is offset %x and length %x\n", spareaddr,\r\nsparelen);\r\n*pparts = parts;\r\nvfree(buf);\r\nreturn nrparts;\r\n}\r\nstatic int __init bcm63xx_cfe_parser_init(void)\r\n{\r\nreturn register_mtd_parser(&bcm63xx_cfe_parser);\r\n}\r\nstatic void __exit bcm63xx_cfe_parser_exit(void)\r\n{\r\nderegister_mtd_parser(&bcm63xx_cfe_parser);\r\n}

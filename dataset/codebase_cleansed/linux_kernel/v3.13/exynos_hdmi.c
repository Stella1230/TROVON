static inline u32 hdmi_reg_read(struct hdmi_context *hdata, u32 reg_id)\r\n{\r\nreturn readl(hdata->regs + reg_id);\r\n}\r\nstatic inline void hdmi_reg_writeb(struct hdmi_context *hdata,\r\nu32 reg_id, u8 value)\r\n{\r\nwriteb(value, hdata->regs + reg_id);\r\n}\r\nstatic inline void hdmi_reg_writemask(struct hdmi_context *hdata,\r\nu32 reg_id, u32 value, u32 mask)\r\n{\r\nu32 old = readl(hdata->regs + reg_id);\r\nvalue = (value & mask) | (old & ~mask);\r\nwritel(value, hdata->regs + reg_id);\r\n}\r\nstatic void hdmi_v13_regs_dump(struct hdmi_context *hdata, char *prefix)\r\n{\r\n#define DUMPREG(reg_id) \\r\nDRM_DEBUG_KMS("%s:" #reg_id " = %08x\n", prefix, \\r\nreadl(hdata->regs + reg_id))\r\nDRM_DEBUG_KMS("%s: ---- CONTROL REGISTERS ----\n", prefix);\r\nDUMPREG(HDMI_INTC_FLAG);\r\nDUMPREG(HDMI_INTC_CON);\r\nDUMPREG(HDMI_HPD_STATUS);\r\nDUMPREG(HDMI_V13_PHY_RSTOUT);\r\nDUMPREG(HDMI_V13_PHY_VPLL);\r\nDUMPREG(HDMI_V13_PHY_CMU);\r\nDUMPREG(HDMI_V13_CORE_RSTOUT);\r\nDRM_DEBUG_KMS("%s: ---- CORE REGISTERS ----\n", prefix);\r\nDUMPREG(HDMI_CON_0);\r\nDUMPREG(HDMI_CON_1);\r\nDUMPREG(HDMI_CON_2);\r\nDUMPREG(HDMI_SYS_STATUS);\r\nDUMPREG(HDMI_V13_PHY_STATUS);\r\nDUMPREG(HDMI_STATUS_EN);\r\nDUMPREG(HDMI_HPD);\r\nDUMPREG(HDMI_MODE_SEL);\r\nDUMPREG(HDMI_V13_HPD_GEN);\r\nDUMPREG(HDMI_V13_DC_CONTROL);\r\nDUMPREG(HDMI_V13_VIDEO_PATTERN_GEN);\r\nDRM_DEBUG_KMS("%s: ---- CORE SYNC REGISTERS ----\n", prefix);\r\nDUMPREG(HDMI_H_BLANK_0);\r\nDUMPREG(HDMI_H_BLANK_1);\r\nDUMPREG(HDMI_V13_V_BLANK_0);\r\nDUMPREG(HDMI_V13_V_BLANK_1);\r\nDUMPREG(HDMI_V13_V_BLANK_2);\r\nDUMPREG(HDMI_V13_H_V_LINE_0);\r\nDUMPREG(HDMI_V13_H_V_LINE_1);\r\nDUMPREG(HDMI_V13_H_V_LINE_2);\r\nDUMPREG(HDMI_VSYNC_POL);\r\nDUMPREG(HDMI_INT_PRO_MODE);\r\nDUMPREG(HDMI_V13_V_BLANK_F_0);\r\nDUMPREG(HDMI_V13_V_BLANK_F_1);\r\nDUMPREG(HDMI_V13_V_BLANK_F_2);\r\nDUMPREG(HDMI_V13_H_SYNC_GEN_0);\r\nDUMPREG(HDMI_V13_H_SYNC_GEN_1);\r\nDUMPREG(HDMI_V13_H_SYNC_GEN_2);\r\nDUMPREG(HDMI_V13_V_SYNC_GEN_1_0);\r\nDUMPREG(HDMI_V13_V_SYNC_GEN_1_1);\r\nDUMPREG(HDMI_V13_V_SYNC_GEN_1_2);\r\nDUMPREG(HDMI_V13_V_SYNC_GEN_2_0);\r\nDUMPREG(HDMI_V13_V_SYNC_GEN_2_1);\r\nDUMPREG(HDMI_V13_V_SYNC_GEN_2_2);\r\nDUMPREG(HDMI_V13_V_SYNC_GEN_3_0);\r\nDUMPREG(HDMI_V13_V_SYNC_GEN_3_1);\r\nDUMPREG(HDMI_V13_V_SYNC_GEN_3_2);\r\nDRM_DEBUG_KMS("%s: ---- TG REGISTERS ----\n", prefix);\r\nDUMPREG(HDMI_TG_CMD);\r\nDUMPREG(HDMI_TG_H_FSZ_L);\r\nDUMPREG(HDMI_TG_H_FSZ_H);\r\nDUMPREG(HDMI_TG_HACT_ST_L);\r\nDUMPREG(HDMI_TG_HACT_ST_H);\r\nDUMPREG(HDMI_TG_HACT_SZ_L);\r\nDUMPREG(HDMI_TG_HACT_SZ_H);\r\nDUMPREG(HDMI_TG_V_FSZ_L);\r\nDUMPREG(HDMI_TG_V_FSZ_H);\r\nDUMPREG(HDMI_TG_VSYNC_L);\r\nDUMPREG(HDMI_TG_VSYNC_H);\r\nDUMPREG(HDMI_TG_VSYNC2_L);\r\nDUMPREG(HDMI_TG_VSYNC2_H);\r\nDUMPREG(HDMI_TG_VACT_ST_L);\r\nDUMPREG(HDMI_TG_VACT_ST_H);\r\nDUMPREG(HDMI_TG_VACT_SZ_L);\r\nDUMPREG(HDMI_TG_VACT_SZ_H);\r\nDUMPREG(HDMI_TG_FIELD_CHG_L);\r\nDUMPREG(HDMI_TG_FIELD_CHG_H);\r\nDUMPREG(HDMI_TG_VACT_ST2_L);\r\nDUMPREG(HDMI_TG_VACT_ST2_H);\r\nDUMPREG(HDMI_TG_VSYNC_TOP_HDMI_L);\r\nDUMPREG(HDMI_TG_VSYNC_TOP_HDMI_H);\r\nDUMPREG(HDMI_TG_VSYNC_BOT_HDMI_L);\r\nDUMPREG(HDMI_TG_VSYNC_BOT_HDMI_H);\r\nDUMPREG(HDMI_TG_FIELD_TOP_HDMI_L);\r\nDUMPREG(HDMI_TG_FIELD_TOP_HDMI_H);\r\nDUMPREG(HDMI_TG_FIELD_BOT_HDMI_L);\r\nDUMPREG(HDMI_TG_FIELD_BOT_HDMI_H);\r\n#undef DUMPREG\r\n}\r\nstatic void hdmi_v14_regs_dump(struct hdmi_context *hdata, char *prefix)\r\n{\r\nint i;\r\n#define DUMPREG(reg_id) \\r\nDRM_DEBUG_KMS("%s:" #reg_id " = %08x\n", prefix, \\r\nreadl(hdata->regs + reg_id))\r\nDRM_DEBUG_KMS("%s: ---- CONTROL REGISTERS ----\n", prefix);\r\nDUMPREG(HDMI_INTC_CON);\r\nDUMPREG(HDMI_INTC_FLAG);\r\nDUMPREG(HDMI_HPD_STATUS);\r\nDUMPREG(HDMI_INTC_CON_1);\r\nDUMPREG(HDMI_INTC_FLAG_1);\r\nDUMPREG(HDMI_PHY_STATUS_0);\r\nDUMPREG(HDMI_PHY_STATUS_PLL);\r\nDUMPREG(HDMI_PHY_CON_0);\r\nDUMPREG(HDMI_PHY_RSTOUT);\r\nDUMPREG(HDMI_PHY_VPLL);\r\nDUMPREG(HDMI_PHY_CMU);\r\nDUMPREG(HDMI_CORE_RSTOUT);\r\nDRM_DEBUG_KMS("%s: ---- CORE REGISTERS ----\n", prefix);\r\nDUMPREG(HDMI_CON_0);\r\nDUMPREG(HDMI_CON_1);\r\nDUMPREG(HDMI_CON_2);\r\nDUMPREG(HDMI_SYS_STATUS);\r\nDUMPREG(HDMI_PHY_STATUS_0);\r\nDUMPREG(HDMI_STATUS_EN);\r\nDUMPREG(HDMI_HPD);\r\nDUMPREG(HDMI_MODE_SEL);\r\nDUMPREG(HDMI_ENC_EN);\r\nDUMPREG(HDMI_DC_CONTROL);\r\nDUMPREG(HDMI_VIDEO_PATTERN_GEN);\r\nDRM_DEBUG_KMS("%s: ---- CORE SYNC REGISTERS ----\n", prefix);\r\nDUMPREG(HDMI_H_BLANK_0);\r\nDUMPREG(HDMI_H_BLANK_1);\r\nDUMPREG(HDMI_V2_BLANK_0);\r\nDUMPREG(HDMI_V2_BLANK_1);\r\nDUMPREG(HDMI_V1_BLANK_0);\r\nDUMPREG(HDMI_V1_BLANK_1);\r\nDUMPREG(HDMI_V_LINE_0);\r\nDUMPREG(HDMI_V_LINE_1);\r\nDUMPREG(HDMI_H_LINE_0);\r\nDUMPREG(HDMI_H_LINE_1);\r\nDUMPREG(HDMI_HSYNC_POL);\r\nDUMPREG(HDMI_VSYNC_POL);\r\nDUMPREG(HDMI_INT_PRO_MODE);\r\nDUMPREG(HDMI_V_BLANK_F0_0);\r\nDUMPREG(HDMI_V_BLANK_F0_1);\r\nDUMPREG(HDMI_V_BLANK_F1_0);\r\nDUMPREG(HDMI_V_BLANK_F1_1);\r\nDUMPREG(HDMI_H_SYNC_START_0);\r\nDUMPREG(HDMI_H_SYNC_START_1);\r\nDUMPREG(HDMI_H_SYNC_END_0);\r\nDUMPREG(HDMI_H_SYNC_END_1);\r\nDUMPREG(HDMI_V_SYNC_LINE_BEF_2_0);\r\nDUMPREG(HDMI_V_SYNC_LINE_BEF_2_1);\r\nDUMPREG(HDMI_V_SYNC_LINE_BEF_1_0);\r\nDUMPREG(HDMI_V_SYNC_LINE_BEF_1_1);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_2_0);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_2_1);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_1_0);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_1_1);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_PXL_2_0);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_PXL_2_1);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_PXL_1_0);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_PXL_1_1);\r\nDUMPREG(HDMI_V_BLANK_F2_0);\r\nDUMPREG(HDMI_V_BLANK_F2_1);\r\nDUMPREG(HDMI_V_BLANK_F3_0);\r\nDUMPREG(HDMI_V_BLANK_F3_1);\r\nDUMPREG(HDMI_V_BLANK_F4_0);\r\nDUMPREG(HDMI_V_BLANK_F4_1);\r\nDUMPREG(HDMI_V_BLANK_F5_0);\r\nDUMPREG(HDMI_V_BLANK_F5_1);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_3_0);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_3_1);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_4_0);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_4_1);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_5_0);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_5_1);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_6_0);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_6_1);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_PXL_3_0);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_PXL_3_1);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_PXL_4_0);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_PXL_4_1);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_PXL_5_0);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_PXL_5_1);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_PXL_6_0);\r\nDUMPREG(HDMI_V_SYNC_LINE_AFT_PXL_6_1);\r\nDUMPREG(HDMI_VACT_SPACE_1_0);\r\nDUMPREG(HDMI_VACT_SPACE_1_1);\r\nDUMPREG(HDMI_VACT_SPACE_2_0);\r\nDUMPREG(HDMI_VACT_SPACE_2_1);\r\nDUMPREG(HDMI_VACT_SPACE_3_0);\r\nDUMPREG(HDMI_VACT_SPACE_3_1);\r\nDUMPREG(HDMI_VACT_SPACE_4_0);\r\nDUMPREG(HDMI_VACT_SPACE_4_1);\r\nDUMPREG(HDMI_VACT_SPACE_5_0);\r\nDUMPREG(HDMI_VACT_SPACE_5_1);\r\nDUMPREG(HDMI_VACT_SPACE_6_0);\r\nDUMPREG(HDMI_VACT_SPACE_6_1);\r\nDRM_DEBUG_KMS("%s: ---- TG REGISTERS ----\n", prefix);\r\nDUMPREG(HDMI_TG_CMD);\r\nDUMPREG(HDMI_TG_H_FSZ_L);\r\nDUMPREG(HDMI_TG_H_FSZ_H);\r\nDUMPREG(HDMI_TG_HACT_ST_L);\r\nDUMPREG(HDMI_TG_HACT_ST_H);\r\nDUMPREG(HDMI_TG_HACT_SZ_L);\r\nDUMPREG(HDMI_TG_HACT_SZ_H);\r\nDUMPREG(HDMI_TG_V_FSZ_L);\r\nDUMPREG(HDMI_TG_V_FSZ_H);\r\nDUMPREG(HDMI_TG_VSYNC_L);\r\nDUMPREG(HDMI_TG_VSYNC_H);\r\nDUMPREG(HDMI_TG_VSYNC2_L);\r\nDUMPREG(HDMI_TG_VSYNC2_H);\r\nDUMPREG(HDMI_TG_VACT_ST_L);\r\nDUMPREG(HDMI_TG_VACT_ST_H);\r\nDUMPREG(HDMI_TG_VACT_SZ_L);\r\nDUMPREG(HDMI_TG_VACT_SZ_H);\r\nDUMPREG(HDMI_TG_FIELD_CHG_L);\r\nDUMPREG(HDMI_TG_FIELD_CHG_H);\r\nDUMPREG(HDMI_TG_VACT_ST2_L);\r\nDUMPREG(HDMI_TG_VACT_ST2_H);\r\nDUMPREG(HDMI_TG_VACT_ST3_L);\r\nDUMPREG(HDMI_TG_VACT_ST3_H);\r\nDUMPREG(HDMI_TG_VACT_ST4_L);\r\nDUMPREG(HDMI_TG_VACT_ST4_H);\r\nDUMPREG(HDMI_TG_VSYNC_TOP_HDMI_L);\r\nDUMPREG(HDMI_TG_VSYNC_TOP_HDMI_H);\r\nDUMPREG(HDMI_TG_VSYNC_BOT_HDMI_L);\r\nDUMPREG(HDMI_TG_VSYNC_BOT_HDMI_H);\r\nDUMPREG(HDMI_TG_FIELD_TOP_HDMI_L);\r\nDUMPREG(HDMI_TG_FIELD_TOP_HDMI_H);\r\nDUMPREG(HDMI_TG_FIELD_BOT_HDMI_L);\r\nDUMPREG(HDMI_TG_FIELD_BOT_HDMI_H);\r\nDUMPREG(HDMI_TG_3D);\r\nDRM_DEBUG_KMS("%s: ---- PACKET REGISTERS ----\n", prefix);\r\nDUMPREG(HDMI_AVI_CON);\r\nDUMPREG(HDMI_AVI_HEADER0);\r\nDUMPREG(HDMI_AVI_HEADER1);\r\nDUMPREG(HDMI_AVI_HEADER2);\r\nDUMPREG(HDMI_AVI_CHECK_SUM);\r\nDUMPREG(HDMI_VSI_CON);\r\nDUMPREG(HDMI_VSI_HEADER0);\r\nDUMPREG(HDMI_VSI_HEADER1);\r\nDUMPREG(HDMI_VSI_HEADER2);\r\nfor (i = 0; i < 7; ++i)\r\nDUMPREG(HDMI_VSI_DATA(i));\r\n#undef DUMPREG\r\n}\r\nstatic void hdmi_regs_dump(struct hdmi_context *hdata, char *prefix)\r\n{\r\nif (hdata->type == HDMI_TYPE13)\r\nhdmi_v13_regs_dump(hdata, prefix);\r\nelse\r\nhdmi_v14_regs_dump(hdata, prefix);\r\n}\r\nstatic u8 hdmi_chksum(struct hdmi_context *hdata,\r\nu32 start, u8 len, u32 hdr_sum)\r\n{\r\nint i;\r\nfor (i = 0; i < len; ++i)\r\nhdr_sum += 0xff & hdmi_reg_read(hdata, start + i * 4);\r\nreturn (u8)(~(hdr_sum & 0xff) + 1);\r\n}\r\nstatic void hdmi_reg_infoframe(struct hdmi_context *hdata,\r\nstruct hdmi_infoframe *infoframe)\r\n{\r\nu32 hdr_sum;\r\nu8 chksum;\r\nu32 aspect_ratio;\r\nu32 mod;\r\nu32 vic;\r\nmod = hdmi_reg_read(hdata, HDMI_MODE_SEL);\r\nif (hdata->dvi_mode) {\r\nhdmi_reg_writeb(hdata, HDMI_VSI_CON,\r\nHDMI_VSI_CON_DO_NOT_TRANSMIT);\r\nhdmi_reg_writeb(hdata, HDMI_AVI_CON,\r\nHDMI_AVI_CON_DO_NOT_TRANSMIT);\r\nhdmi_reg_writeb(hdata, HDMI_AUI_CON, HDMI_AUI_CON_NO_TRAN);\r\nreturn;\r\n}\r\nswitch (infoframe->type) {\r\ncase HDMI_PACKET_TYPE_AVI:\r\nhdmi_reg_writeb(hdata, HDMI_AVI_CON, HDMI_AVI_CON_EVERY_VSYNC);\r\nhdmi_reg_writeb(hdata, HDMI_AVI_HEADER0, infoframe->type);\r\nhdmi_reg_writeb(hdata, HDMI_AVI_HEADER1, infoframe->ver);\r\nhdmi_reg_writeb(hdata, HDMI_AVI_HEADER2, infoframe->len);\r\nhdr_sum = infoframe->type + infoframe->ver + infoframe->len;\r\nhdmi_reg_writeb(hdata, HDMI_AVI_BYTE(1), 0 << 5 |\r\nAVI_ACTIVE_FORMAT_VALID |\r\nAVI_UNDERSCANNED_DISPLAY_VALID);\r\naspect_ratio = AVI_PIC_ASPECT_RATIO_16_9;\r\nhdmi_reg_writeb(hdata, HDMI_AVI_BYTE(2), aspect_ratio |\r\nAVI_SAME_AS_PIC_ASPECT_RATIO);\r\nvic = hdata->mode_conf.cea_video_id;\r\nhdmi_reg_writeb(hdata, HDMI_AVI_BYTE(4), vic);\r\nchksum = hdmi_chksum(hdata, HDMI_AVI_BYTE(1),\r\ninfoframe->len, hdr_sum);\r\nDRM_DEBUG_KMS("AVI checksum = 0x%x\n", chksum);\r\nhdmi_reg_writeb(hdata, HDMI_AVI_CHECK_SUM, chksum);\r\nbreak;\r\ncase HDMI_PACKET_TYPE_AUI:\r\nhdmi_reg_writeb(hdata, HDMI_AUI_CON, 0x02);\r\nhdmi_reg_writeb(hdata, HDMI_AUI_HEADER0, infoframe->type);\r\nhdmi_reg_writeb(hdata, HDMI_AUI_HEADER1, infoframe->ver);\r\nhdmi_reg_writeb(hdata, HDMI_AUI_HEADER2, infoframe->len);\r\nhdr_sum = infoframe->type + infoframe->ver + infoframe->len;\r\nchksum = hdmi_chksum(hdata, HDMI_AUI_BYTE(1),\r\ninfoframe->len, hdr_sum);\r\nDRM_DEBUG_KMS("AUI checksum = 0x%x\n", chksum);\r\nhdmi_reg_writeb(hdata, HDMI_AUI_CHECK_SUM, chksum);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic bool hdmi_is_connected(void *ctx)\r\n{\r\nstruct hdmi_context *hdata = ctx;\r\nreturn hdata->hpd;\r\n}\r\nstatic struct edid *hdmi_get_edid(void *ctx, struct drm_connector *connector)\r\n{\r\nstruct edid *raw_edid;\r\nstruct hdmi_context *hdata = ctx;\r\nif (!hdata->ddc_port)\r\nreturn ERR_PTR(-ENODEV);\r\nraw_edid = drm_get_edid(connector, hdata->ddc_port->adapter);\r\nif (!raw_edid)\r\nreturn ERR_PTR(-ENODEV);\r\nhdata->dvi_mode = !drm_detect_hdmi_monitor(raw_edid);\r\nDRM_DEBUG_KMS("%s : width[%d] x height[%d]\n",\r\n(hdata->dvi_mode ? "dvi monitor" : "hdmi monitor"),\r\nraw_edid->width_cm, raw_edid->height_cm);\r\nreturn raw_edid;\r\n}\r\nstatic int hdmi_find_phy_conf(struct hdmi_context *hdata, u32 pixel_clock)\r\n{\r\nconst struct hdmiphy_config *confs;\r\nint count, i;\r\nif (hdata->type == HDMI_TYPE13) {\r\nconfs = hdmiphy_v13_configs;\r\ncount = ARRAY_SIZE(hdmiphy_v13_configs);\r\n} else if (hdata->type == HDMI_TYPE14) {\r\nconfs = hdmiphy_v14_configs;\r\ncount = ARRAY_SIZE(hdmiphy_v14_configs);\r\n} else\r\nreturn -EINVAL;\r\nfor (i = 0; i < count; i++)\r\nif (confs[i].pixel_clock == pixel_clock)\r\nreturn i;\r\nDRM_DEBUG_KMS("Could not find phy config for %d\n", pixel_clock);\r\nreturn -EINVAL;\r\n}\r\nstatic int hdmi_check_mode(void *ctx, struct drm_display_mode *mode)\r\n{\r\nstruct hdmi_context *hdata = ctx;\r\nint ret;\r\nDRM_DEBUG_KMS("xres=%d, yres=%d, refresh=%d, intl=%d clock=%d\n",\r\nmode->hdisplay, mode->vdisplay, mode->vrefresh,\r\n(mode->flags & DRM_MODE_FLAG_INTERLACE) ? true :\r\nfalse, mode->clock * 1000);\r\nret = hdmi_find_phy_conf(hdata, mode->clock * 1000);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic void hdmi_set_acr(u32 freq, u8 *acr)\r\n{\r\nu32 n, cts;\r\nswitch (freq) {\r\ncase 32000:\r\nn = 4096;\r\ncts = 27000;\r\nbreak;\r\ncase 44100:\r\nn = 6272;\r\ncts = 30000;\r\nbreak;\r\ncase 88200:\r\nn = 12544;\r\ncts = 30000;\r\nbreak;\r\ncase 176400:\r\nn = 25088;\r\ncts = 30000;\r\nbreak;\r\ncase 48000:\r\nn = 6144;\r\ncts = 27000;\r\nbreak;\r\ncase 96000:\r\nn = 12288;\r\ncts = 27000;\r\nbreak;\r\ncase 192000:\r\nn = 24576;\r\ncts = 27000;\r\nbreak;\r\ndefault:\r\nn = 0;\r\ncts = 0;\r\nbreak;\r\n}\r\nacr[1] = cts >> 16;\r\nacr[2] = cts >> 8 & 0xff;\r\nacr[3] = cts & 0xff;\r\nacr[4] = n >> 16;\r\nacr[5] = n >> 8 & 0xff;\r\nacr[6] = n & 0xff;\r\n}\r\nstatic void hdmi_reg_acr(struct hdmi_context *hdata, u8 *acr)\r\n{\r\nhdmi_reg_writeb(hdata, HDMI_ACR_N0, acr[6]);\r\nhdmi_reg_writeb(hdata, HDMI_ACR_N1, acr[5]);\r\nhdmi_reg_writeb(hdata, HDMI_ACR_N2, acr[4]);\r\nhdmi_reg_writeb(hdata, HDMI_ACR_MCTS0, acr[3]);\r\nhdmi_reg_writeb(hdata, HDMI_ACR_MCTS1, acr[2]);\r\nhdmi_reg_writeb(hdata, HDMI_ACR_MCTS2, acr[1]);\r\nhdmi_reg_writeb(hdata, HDMI_ACR_CTS0, acr[3]);\r\nhdmi_reg_writeb(hdata, HDMI_ACR_CTS1, acr[2]);\r\nhdmi_reg_writeb(hdata, HDMI_ACR_CTS2, acr[1]);\r\nif (hdata->type == HDMI_TYPE13)\r\nhdmi_reg_writeb(hdata, HDMI_V13_ACR_CON, 4);\r\nelse\r\nhdmi_reg_writeb(hdata, HDMI_ACR_CON, 4);\r\n}\r\nstatic void hdmi_audio_init(struct hdmi_context *hdata)\r\n{\r\nu32 sample_rate, bits_per_sample, frame_size_code;\r\nu32 data_num, bit_ch, sample_frq;\r\nu32 val;\r\nu8 acr[7];\r\nsample_rate = 44100;\r\nbits_per_sample = 16;\r\nframe_size_code = 0;\r\nswitch (bits_per_sample) {\r\ncase 20:\r\ndata_num = 2;\r\nbit_ch = 1;\r\nbreak;\r\ncase 24:\r\ndata_num = 3;\r\nbit_ch = 1;\r\nbreak;\r\ndefault:\r\ndata_num = 1;\r\nbit_ch = 0;\r\nbreak;\r\n}\r\nhdmi_set_acr(sample_rate, acr);\r\nhdmi_reg_acr(hdata, acr);\r\nhdmi_reg_writeb(hdata, HDMI_I2S_MUX_CON, HDMI_I2S_IN_DISABLE\r\n| HDMI_I2S_AUD_I2S | HDMI_I2S_CUV_I2S_ENABLE\r\n| HDMI_I2S_MUX_ENABLE);\r\nhdmi_reg_writeb(hdata, HDMI_I2S_MUX_CH, HDMI_I2S_CH0_EN\r\n| HDMI_I2S_CH1_EN | HDMI_I2S_CH2_EN);\r\nhdmi_reg_writeb(hdata, HDMI_I2S_MUX_CUV, HDMI_I2S_CUV_RL_EN);\r\nsample_frq = (sample_rate == 44100) ? 0 :\r\n(sample_rate == 48000) ? 2 :\r\n(sample_rate == 32000) ? 3 :\r\n(sample_rate == 96000) ? 0xa : 0x0;\r\nhdmi_reg_writeb(hdata, HDMI_I2S_CLK_CON, HDMI_I2S_CLK_DIS);\r\nhdmi_reg_writeb(hdata, HDMI_I2S_CLK_CON, HDMI_I2S_CLK_EN);\r\nval = hdmi_reg_read(hdata, HDMI_I2S_DSD_CON) | 0x01;\r\nhdmi_reg_writeb(hdata, HDMI_I2S_DSD_CON, val);\r\nhdmi_reg_writeb(hdata, HDMI_I2S_PIN_SEL_0, HDMI_I2S_SEL_SCLK(5)\r\n| HDMI_I2S_SEL_LRCK(6));\r\nhdmi_reg_writeb(hdata, HDMI_I2S_PIN_SEL_1, HDMI_I2S_SEL_SDATA1(1)\r\n| HDMI_I2S_SEL_SDATA2(4));\r\nhdmi_reg_writeb(hdata, HDMI_I2S_PIN_SEL_2, HDMI_I2S_SEL_SDATA3(1)\r\n| HDMI_I2S_SEL_SDATA2(2));\r\nhdmi_reg_writeb(hdata, HDMI_I2S_PIN_SEL_3, HDMI_I2S_SEL_DSD(0));\r\nhdmi_reg_writeb(hdata, HDMI_I2S_CON_1, HDMI_I2S_SCLK_FALLING_EDGE\r\n| HDMI_I2S_L_CH_LOW_POL);\r\nhdmi_reg_writeb(hdata, HDMI_I2S_CON_2, HDMI_I2S_MSB_FIRST_MODE\r\n| HDMI_I2S_SET_BIT_CH(bit_ch)\r\n| HDMI_I2S_SET_SDATA_BIT(data_num)\r\n| HDMI_I2S_BASIC_FORMAT);\r\nhdmi_reg_writeb(hdata, HDMI_I2S_CH_ST_0, HDMI_I2S_CH_STATUS_MODE_0\r\n| HDMI_I2S_2AUD_CH_WITHOUT_PREEMPH\r\n| HDMI_I2S_COPYRIGHT\r\n| HDMI_I2S_LINEAR_PCM\r\n| HDMI_I2S_CONSUMER_FORMAT);\r\nhdmi_reg_writeb(hdata, HDMI_I2S_CH_ST_1, HDMI_I2S_CD_PLAYER);\r\nhdmi_reg_writeb(hdata, HDMI_I2S_CH_ST_2, HDMI_I2S_SET_SOURCE_NUM(0));\r\nhdmi_reg_writeb(hdata, HDMI_I2S_CH_ST_3, HDMI_I2S_CLK_ACCUR_LEVEL_2\r\n| HDMI_I2S_SET_SMP_FREQ(sample_frq));\r\nhdmi_reg_writeb(hdata, HDMI_I2S_CH_ST_4,\r\nHDMI_I2S_ORG_SMP_FREQ_44_1\r\n| HDMI_I2S_WORD_LEN_MAX24_24BITS\r\n| HDMI_I2S_WORD_LEN_MAX_24BITS);\r\nhdmi_reg_writeb(hdata, HDMI_I2S_CH_ST_CON, HDMI_I2S_CH_STATUS_RELOAD);\r\n}\r\nstatic void hdmi_audio_control(struct hdmi_context *hdata, bool onoff)\r\n{\r\nif (hdata->dvi_mode)\r\nreturn;\r\nhdmi_reg_writeb(hdata, HDMI_AUI_CON, onoff ? 2 : 0);\r\nhdmi_reg_writemask(hdata, HDMI_CON_0, onoff ?\r\nHDMI_ASP_EN : HDMI_ASP_DIS, HDMI_ASP_MASK);\r\n}\r\nstatic void hdmi_conf_reset(struct hdmi_context *hdata)\r\n{\r\nu32 reg;\r\nif (hdata->type == HDMI_TYPE13)\r\nreg = HDMI_V13_CORE_RSTOUT;\r\nelse\r\nreg = HDMI_CORE_RSTOUT;\r\nhdmi_reg_writemask(hdata, reg, 0, HDMI_CORE_SW_RSTOUT);\r\nusleep_range(10000, 12000);\r\nhdmi_reg_writemask(hdata, reg, ~0, HDMI_CORE_SW_RSTOUT);\r\nusleep_range(10000, 12000);\r\n}\r\nstatic void hdmi_conf_init(struct hdmi_context *hdata)\r\n{\r\nstruct hdmi_infoframe infoframe;\r\nhdmi_reg_writemask(hdata, HDMI_INTC_CON, 0, HDMI_INTC_EN_GLOBAL |\r\nHDMI_INTC_EN_HPD_PLUG | HDMI_INTC_EN_HPD_UNPLUG);\r\nhdmi_reg_writemask(hdata, HDMI_MODE_SEL,\r\nHDMI_MODE_HDMI_EN, HDMI_MODE_MASK);\r\nhdmi_reg_writemask(hdata, HDMI_CON_0, 0, HDMI_BLUE_SCR_EN);\r\nif (hdata->dvi_mode) {\r\nhdmi_reg_writemask(hdata, HDMI_MODE_SEL,\r\nHDMI_MODE_DVI_EN, HDMI_MODE_MASK);\r\nhdmi_reg_writeb(hdata, HDMI_CON_2,\r\nHDMI_VID_PREAMBLE_DIS | HDMI_GUARD_BAND_DIS);\r\n}\r\nif (hdata->type == HDMI_TYPE13) {\r\nhdmi_reg_writeb(hdata, HDMI_V13_BLUE_SCREEN_0, 0x12);\r\nhdmi_reg_writeb(hdata, HDMI_V13_BLUE_SCREEN_1, 0x34);\r\nhdmi_reg_writeb(hdata, HDMI_V13_BLUE_SCREEN_2, 0x56);\r\nhdmi_reg_writeb(hdata, HDMI_V13_AVI_CON, 0x02);\r\nhdmi_reg_writeb(hdata, HDMI_V13_AVI_BYTE(0), 0 << 5);\r\nhdmi_reg_writemask(hdata, HDMI_CON_1, 0x10 << 5, 0x11 << 5);\r\nhdmi_reg_writeb(hdata, HDMI_V13_SPD_CON, 0x02);\r\nhdmi_reg_writeb(hdata, HDMI_V13_AUI_CON, 0x02);\r\nhdmi_reg_writeb(hdata, HDMI_V13_ACR_CON, 0x04);\r\n} else {\r\ninfoframe.type = HDMI_PACKET_TYPE_AVI;\r\ninfoframe.ver = HDMI_AVI_VERSION;\r\ninfoframe.len = HDMI_AVI_LENGTH;\r\nhdmi_reg_infoframe(hdata, &infoframe);\r\ninfoframe.type = HDMI_PACKET_TYPE_AUI;\r\ninfoframe.ver = HDMI_AUI_VERSION;\r\ninfoframe.len = HDMI_AUI_LENGTH;\r\nhdmi_reg_infoframe(hdata, &infoframe);\r\nhdmi_reg_writemask(hdata, HDMI_CON_1, 2, 3 << 5);\r\n}\r\n}\r\nstatic void hdmi_v13_mode_apply(struct hdmi_context *hdata)\r\n{\r\nconst struct hdmi_tg_regs *tg = &hdata->mode_conf.conf.v13_conf.tg;\r\nconst struct hdmi_v13_core_regs *core =\r\n&hdata->mode_conf.conf.v13_conf.core;\r\nint tries;\r\nhdmi_reg_writeb(hdata, HDMI_H_BLANK_0, core->h_blank[0]);\r\nhdmi_reg_writeb(hdata, HDMI_H_BLANK_1, core->h_blank[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_BLANK_0, core->v_blank[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_BLANK_1, core->v_blank[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_BLANK_2, core->v_blank[2]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_H_V_LINE_0, core->h_v_line[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_H_V_LINE_1, core->h_v_line[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_H_V_LINE_2, core->h_v_line[2]);\r\nhdmi_reg_writeb(hdata, HDMI_VSYNC_POL, core->vsync_pol[0]);\r\nhdmi_reg_writeb(hdata, HDMI_INT_PRO_MODE, core->int_pro_mode[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_BLANK_F_0, core->v_blank_f[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_BLANK_F_1, core->v_blank_f[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_BLANK_F_2, core->v_blank_f[2]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_H_SYNC_GEN_0, core->h_sync_gen[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_H_SYNC_GEN_1, core->h_sync_gen[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_H_SYNC_GEN_2, core->h_sync_gen[2]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_SYNC_GEN_1_0, core->v_sync_gen1[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_SYNC_GEN_1_1, core->v_sync_gen1[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_SYNC_GEN_1_2, core->v_sync_gen1[2]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_SYNC_GEN_2_0, core->v_sync_gen2[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_SYNC_GEN_2_1, core->v_sync_gen2[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_SYNC_GEN_2_2, core->v_sync_gen2[2]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_SYNC_GEN_3_0, core->v_sync_gen3[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_SYNC_GEN_3_1, core->v_sync_gen3[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V13_V_SYNC_GEN_3_2, core->v_sync_gen3[2]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_H_FSZ_L, tg->h_fsz[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_H_FSZ_H, tg->h_fsz[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_HACT_ST_L, tg->hact_st[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_HACT_ST_H, tg->hact_st[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_HACT_SZ_L, tg->hact_sz[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_HACT_SZ_H, tg->hact_sz[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_V_FSZ_L, tg->v_fsz[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_V_FSZ_H, tg->v_fsz[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC_L, tg->vsync[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC_H, tg->vsync[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC2_L, tg->vsync2[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC2_H, tg->vsync2[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_ST_L, tg->vact_st[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_ST_H, tg->vact_st[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_SZ_L, tg->vact_sz[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_SZ_H, tg->vact_sz[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_FIELD_CHG_L, tg->field_chg[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_FIELD_CHG_H, tg->field_chg[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_ST2_L, tg->vact_st2[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_ST2_H, tg->vact_st2[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC_TOP_HDMI_L, tg->vsync_top_hdmi[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC_TOP_HDMI_H, tg->vsync_top_hdmi[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC_BOT_HDMI_L, tg->vsync_bot_hdmi[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC_BOT_HDMI_H, tg->vsync_bot_hdmi[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_FIELD_TOP_HDMI_L, tg->field_top_hdmi[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_FIELD_TOP_HDMI_H, tg->field_top_hdmi[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_FIELD_BOT_HDMI_L, tg->field_bot_hdmi[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_FIELD_BOT_HDMI_H, tg->field_bot_hdmi[1]);\r\nfor (tries = 100; tries; --tries) {\r\nu32 val = hdmi_reg_read(hdata, HDMI_V13_PHY_STATUS);\r\nif (val & HDMI_PHY_STATUS_READY)\r\nbreak;\r\nusleep_range(1000, 2000);\r\n}\r\nif (tries == 0) {\r\nDRM_ERROR("hdmiphy's pll could not reach steady state.\n");\r\nhdmi_regs_dump(hdata, "timing apply");\r\n}\r\nclk_disable_unprepare(hdata->res.sclk_hdmi);\r\nclk_set_parent(hdata->res.mout_hdmi, hdata->res.sclk_hdmiphy);\r\nclk_prepare_enable(hdata->res.sclk_hdmi);\r\nhdmi_reg_writemask(hdata, HDMI_CON_0, ~0, HDMI_EN);\r\nif (core->int_pro_mode[0])\r\nhdmi_reg_writemask(hdata, HDMI_TG_CMD, ~0, HDMI_TG_EN |\r\nHDMI_FIELD_EN);\r\nelse\r\nhdmi_reg_writemask(hdata, HDMI_TG_CMD, ~0, HDMI_TG_EN);\r\n}\r\nstatic void hdmi_v14_mode_apply(struct hdmi_context *hdata)\r\n{\r\nconst struct hdmi_tg_regs *tg = &hdata->mode_conf.conf.v14_conf.tg;\r\nconst struct hdmi_v14_core_regs *core =\r\n&hdata->mode_conf.conf.v14_conf.core;\r\nint tries;\r\nhdmi_reg_writeb(hdata, HDMI_H_BLANK_0, core->h_blank[0]);\r\nhdmi_reg_writeb(hdata, HDMI_H_BLANK_1, core->h_blank[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V2_BLANK_0, core->v2_blank[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V2_BLANK_1, core->v2_blank[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V1_BLANK_0, core->v1_blank[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V1_BLANK_1, core->v1_blank[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_LINE_0, core->v_line[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_LINE_1, core->v_line[1]);\r\nhdmi_reg_writeb(hdata, HDMI_H_LINE_0, core->h_line[0]);\r\nhdmi_reg_writeb(hdata, HDMI_H_LINE_1, core->h_line[1]);\r\nhdmi_reg_writeb(hdata, HDMI_HSYNC_POL, core->hsync_pol[0]);\r\nhdmi_reg_writeb(hdata, HDMI_VSYNC_POL, core->vsync_pol[0]);\r\nhdmi_reg_writeb(hdata, HDMI_INT_PRO_MODE, core->int_pro_mode[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_BLANK_F0_0, core->v_blank_f0[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_BLANK_F0_1, core->v_blank_f0[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_BLANK_F1_0, core->v_blank_f1[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_BLANK_F1_1, core->v_blank_f1[1]);\r\nhdmi_reg_writeb(hdata, HDMI_H_SYNC_START_0, core->h_sync_start[0]);\r\nhdmi_reg_writeb(hdata, HDMI_H_SYNC_START_1, core->h_sync_start[1]);\r\nhdmi_reg_writeb(hdata, HDMI_H_SYNC_END_0, core->h_sync_end[0]);\r\nhdmi_reg_writeb(hdata, HDMI_H_SYNC_END_1, core->h_sync_end[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_BEF_2_0,\r\ncore->v_sync_line_bef_2[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_BEF_2_1,\r\ncore->v_sync_line_bef_2[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_BEF_1_0,\r\ncore->v_sync_line_bef_1[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_BEF_1_1,\r\ncore->v_sync_line_bef_1[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_2_0,\r\ncore->v_sync_line_aft_2[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_2_1,\r\ncore->v_sync_line_aft_2[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_1_0,\r\ncore->v_sync_line_aft_1[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_1_1,\r\ncore->v_sync_line_aft_1[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_PXL_2_0,\r\ncore->v_sync_line_aft_pxl_2[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_PXL_2_1,\r\ncore->v_sync_line_aft_pxl_2[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_PXL_1_0,\r\ncore->v_sync_line_aft_pxl_1[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_PXL_1_1,\r\ncore->v_sync_line_aft_pxl_1[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_BLANK_F2_0, core->v_blank_f2[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_BLANK_F2_1, core->v_blank_f2[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_BLANK_F3_0, core->v_blank_f3[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_BLANK_F3_1, core->v_blank_f3[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_BLANK_F4_0, core->v_blank_f4[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_BLANK_F4_1, core->v_blank_f4[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_BLANK_F5_0, core->v_blank_f5[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_BLANK_F5_1, core->v_blank_f5[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_3_0,\r\ncore->v_sync_line_aft_3[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_3_1,\r\ncore->v_sync_line_aft_3[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_4_0,\r\ncore->v_sync_line_aft_4[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_4_1,\r\ncore->v_sync_line_aft_4[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_5_0,\r\ncore->v_sync_line_aft_5[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_5_1,\r\ncore->v_sync_line_aft_5[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_6_0,\r\ncore->v_sync_line_aft_6[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_6_1,\r\ncore->v_sync_line_aft_6[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_PXL_3_0,\r\ncore->v_sync_line_aft_pxl_3[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_PXL_3_1,\r\ncore->v_sync_line_aft_pxl_3[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_PXL_4_0,\r\ncore->v_sync_line_aft_pxl_4[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_PXL_4_1,\r\ncore->v_sync_line_aft_pxl_4[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_PXL_5_0,\r\ncore->v_sync_line_aft_pxl_5[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_PXL_5_1,\r\ncore->v_sync_line_aft_pxl_5[1]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_PXL_6_0,\r\ncore->v_sync_line_aft_pxl_6[0]);\r\nhdmi_reg_writeb(hdata, HDMI_V_SYNC_LINE_AFT_PXL_6_1,\r\ncore->v_sync_line_aft_pxl_6[1]);\r\nhdmi_reg_writeb(hdata, HDMI_VACT_SPACE_1_0, core->vact_space_1[0]);\r\nhdmi_reg_writeb(hdata, HDMI_VACT_SPACE_1_1, core->vact_space_1[1]);\r\nhdmi_reg_writeb(hdata, HDMI_VACT_SPACE_2_0, core->vact_space_2[0]);\r\nhdmi_reg_writeb(hdata, HDMI_VACT_SPACE_2_1, core->vact_space_2[1]);\r\nhdmi_reg_writeb(hdata, HDMI_VACT_SPACE_3_0, core->vact_space_3[0]);\r\nhdmi_reg_writeb(hdata, HDMI_VACT_SPACE_3_1, core->vact_space_3[1]);\r\nhdmi_reg_writeb(hdata, HDMI_VACT_SPACE_4_0, core->vact_space_4[0]);\r\nhdmi_reg_writeb(hdata, HDMI_VACT_SPACE_4_1, core->vact_space_4[1]);\r\nhdmi_reg_writeb(hdata, HDMI_VACT_SPACE_5_0, core->vact_space_5[0]);\r\nhdmi_reg_writeb(hdata, HDMI_VACT_SPACE_5_1, core->vact_space_5[1]);\r\nhdmi_reg_writeb(hdata, HDMI_VACT_SPACE_6_0, core->vact_space_6[0]);\r\nhdmi_reg_writeb(hdata, HDMI_VACT_SPACE_6_1, core->vact_space_6[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_H_FSZ_L, tg->h_fsz[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_H_FSZ_H, tg->h_fsz[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_HACT_ST_L, tg->hact_st[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_HACT_ST_H, tg->hact_st[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_HACT_SZ_L, tg->hact_sz[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_HACT_SZ_H, tg->hact_sz[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_V_FSZ_L, tg->v_fsz[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_V_FSZ_H, tg->v_fsz[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC_L, tg->vsync[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC_H, tg->vsync[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC2_L, tg->vsync2[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC2_H, tg->vsync2[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_ST_L, tg->vact_st[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_ST_H, tg->vact_st[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_SZ_L, tg->vact_sz[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_SZ_H, tg->vact_sz[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_FIELD_CHG_L, tg->field_chg[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_FIELD_CHG_H, tg->field_chg[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_ST2_L, tg->vact_st2[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_ST2_H, tg->vact_st2[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_ST3_L, tg->vact_st3[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_ST3_H, tg->vact_st3[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_ST4_L, tg->vact_st4[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VACT_ST4_H, tg->vact_st4[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC_TOP_HDMI_L, tg->vsync_top_hdmi[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC_TOP_HDMI_H, tg->vsync_top_hdmi[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC_BOT_HDMI_L, tg->vsync_bot_hdmi[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_VSYNC_BOT_HDMI_H, tg->vsync_bot_hdmi[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_FIELD_TOP_HDMI_L, tg->field_top_hdmi[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_FIELD_TOP_HDMI_H, tg->field_top_hdmi[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_FIELD_BOT_HDMI_L, tg->field_bot_hdmi[0]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_FIELD_BOT_HDMI_H, tg->field_bot_hdmi[1]);\r\nhdmi_reg_writeb(hdata, HDMI_TG_3D, tg->tg_3d[0]);\r\nfor (tries = 100; tries; --tries) {\r\nu32 val = hdmi_reg_read(hdata, HDMI_PHY_STATUS_0);\r\nif (val & HDMI_PHY_STATUS_READY)\r\nbreak;\r\nusleep_range(1000, 2000);\r\n}\r\nif (tries == 0) {\r\nDRM_ERROR("hdmiphy's pll could not reach steady state.\n");\r\nhdmi_regs_dump(hdata, "timing apply");\r\n}\r\nclk_disable_unprepare(hdata->res.sclk_hdmi);\r\nclk_set_parent(hdata->res.mout_hdmi, hdata->res.sclk_hdmiphy);\r\nclk_prepare_enable(hdata->res.sclk_hdmi);\r\nhdmi_reg_writemask(hdata, HDMI_CON_0, ~0, HDMI_EN);\r\nif (core->int_pro_mode[0])\r\nhdmi_reg_writemask(hdata, HDMI_TG_CMD, ~0, HDMI_TG_EN |\r\nHDMI_FIELD_EN);\r\nelse\r\nhdmi_reg_writemask(hdata, HDMI_TG_CMD, ~0, HDMI_TG_EN);\r\n}\r\nstatic void hdmi_mode_apply(struct hdmi_context *hdata)\r\n{\r\nif (hdata->type == HDMI_TYPE13)\r\nhdmi_v13_mode_apply(hdata);\r\nelse\r\nhdmi_v14_mode_apply(hdata);\r\n}\r\nstatic void hdmiphy_conf_reset(struct hdmi_context *hdata)\r\n{\r\nu8 buffer[2];\r\nu32 reg;\r\nclk_disable_unprepare(hdata->res.sclk_hdmi);\r\nclk_set_parent(hdata->res.mout_hdmi, hdata->res.sclk_pixel);\r\nclk_prepare_enable(hdata->res.sclk_hdmi);\r\nbuffer[0] = 0x1f;\r\nbuffer[1] = 0x00;\r\nif (hdata->hdmiphy_port)\r\ni2c_master_send(hdata->hdmiphy_port, buffer, 2);\r\nif (hdata->type == HDMI_TYPE13)\r\nreg = HDMI_V13_PHY_RSTOUT;\r\nelse\r\nreg = HDMI_PHY_RSTOUT;\r\nhdmi_reg_writemask(hdata, reg, ~0, HDMI_PHY_SW_RSTOUT);\r\nusleep_range(10000, 12000);\r\nhdmi_reg_writemask(hdata, reg, 0, HDMI_PHY_SW_RSTOUT);\r\nusleep_range(10000, 12000);\r\n}\r\nstatic void hdmiphy_poweron(struct hdmi_context *hdata)\r\n{\r\nif (hdata->type == HDMI_TYPE14)\r\nhdmi_reg_writemask(hdata, HDMI_PHY_CON_0, 0,\r\nHDMI_PHY_POWER_OFF_EN);\r\n}\r\nstatic void hdmiphy_poweroff(struct hdmi_context *hdata)\r\n{\r\nif (hdata->type == HDMI_TYPE14)\r\nhdmi_reg_writemask(hdata, HDMI_PHY_CON_0, ~0,\r\nHDMI_PHY_POWER_OFF_EN);\r\n}\r\nstatic void hdmiphy_conf_apply(struct hdmi_context *hdata)\r\n{\r\nconst u8 *hdmiphy_data;\r\nu8 buffer[32];\r\nu8 operation[2];\r\nu8 read_buffer[32] = {0, };\r\nint ret;\r\nint i;\r\nif (!hdata->hdmiphy_port) {\r\nDRM_ERROR("hdmiphy is not attached\n");\r\nreturn;\r\n}\r\ni = hdmi_find_phy_conf(hdata, hdata->mode_conf.pixel_clock);\r\nif (i < 0) {\r\nDRM_ERROR("failed to find hdmiphy conf\n");\r\nreturn;\r\n}\r\nif (hdata->type == HDMI_TYPE13)\r\nhdmiphy_data = hdmiphy_v13_configs[i].conf;\r\nelse\r\nhdmiphy_data = hdmiphy_v14_configs[i].conf;\r\nmemcpy(buffer, hdmiphy_data, 32);\r\nret = i2c_master_send(hdata->hdmiphy_port, buffer, 32);\r\nif (ret != 32) {\r\nDRM_ERROR("failed to configure HDMIPHY via I2C\n");\r\nreturn;\r\n}\r\nusleep_range(10000, 12000);\r\noperation[0] = 0x1f;\r\noperation[1] = 0x80;\r\nret = i2c_master_send(hdata->hdmiphy_port, operation, 2);\r\nif (ret != 2) {\r\nDRM_ERROR("failed to enable hdmiphy\n");\r\nreturn;\r\n}\r\nret = i2c_master_recv(hdata->hdmiphy_port, read_buffer, 32);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to read hdmiphy config\n");\r\nreturn;\r\n}\r\nfor (i = 0; i < ret; i++)\r\nDRM_DEBUG_KMS("hdmiphy[0x%02x] write[0x%02x] - "\r\n"recv [0x%02x]\n", i, buffer[i], read_buffer[i]);\r\n}\r\nstatic void hdmi_conf_apply(struct hdmi_context *hdata)\r\n{\r\nhdmiphy_conf_reset(hdata);\r\nhdmiphy_conf_apply(hdata);\r\nmutex_lock(&hdata->hdmi_mutex);\r\nhdmi_conf_reset(hdata);\r\nhdmi_conf_init(hdata);\r\nmutex_unlock(&hdata->hdmi_mutex);\r\nhdmi_audio_init(hdata);\r\nhdmi_mode_apply(hdata);\r\nhdmi_audio_control(hdata, true);\r\nhdmi_regs_dump(hdata, "start");\r\n}\r\nstatic void hdmi_set_reg(u8 *reg_pair, int num_bytes, u32 value)\r\n{\r\nint i;\r\nBUG_ON(num_bytes > 4);\r\nfor (i = 0; i < num_bytes; i++)\r\nreg_pair[i] = (value >> (8 * i)) & 0xff;\r\n}\r\nstatic void hdmi_v13_mode_set(struct hdmi_context *hdata,\r\nstruct drm_display_mode *m)\r\n{\r\nstruct hdmi_v13_core_regs *core = &hdata->mode_conf.conf.v13_conf.core;\r\nstruct hdmi_tg_regs *tg = &hdata->mode_conf.conf.v13_conf.tg;\r\nunsigned int val;\r\nhdata->mode_conf.cea_video_id =\r\ndrm_match_cea_mode((struct drm_display_mode *)m);\r\nhdata->mode_conf.pixel_clock = m->clock * 1000;\r\nhdmi_set_reg(core->h_blank, 2, m->htotal - m->hdisplay);\r\nhdmi_set_reg(core->h_v_line, 3, (m->htotal << 12) | m->vtotal);\r\nval = (m->flags & DRM_MODE_FLAG_NVSYNC) ? 1 : 0;\r\nhdmi_set_reg(core->vsync_pol, 1, val);\r\nval = (m->flags & DRM_MODE_FLAG_INTERLACE) ? 1 : 0;\r\nhdmi_set_reg(core->int_pro_mode, 1, val);\r\nval = (m->hsync_start - m->hdisplay - 2);\r\nval |= ((m->hsync_end - m->hdisplay - 2) << 10);\r\nval |= ((m->flags & DRM_MODE_FLAG_NHSYNC) ? 1 : 0)<<20;\r\nhdmi_set_reg(core->h_sync_gen, 3, val);\r\nif (m->flags & DRM_MODE_FLAG_INTERLACE) {\r\nval = ((m->vsync_end - m->vdisplay) / 2);\r\nval |= ((m->vsync_start - m->vdisplay) / 2) << 12;\r\nhdmi_set_reg(core->v_sync_gen1, 3, val);\r\nval = m->vtotal / 2;\r\nval |= ((m->vtotal - m->vdisplay) / 2) << 11;\r\nhdmi_set_reg(core->v_blank, 3, val);\r\nval = (m->vtotal +\r\n((m->vsync_end - m->vsync_start) * 4) + 5) / 2;\r\nval |= m->vtotal << 11;\r\nhdmi_set_reg(core->v_blank_f, 3, val);\r\nval = ((m->vtotal / 2) + 7);\r\nval |= ((m->vtotal / 2) + 2) << 12;\r\nhdmi_set_reg(core->v_sync_gen2, 3, val);\r\nval = ((m->htotal / 2) + (m->hsync_start - m->hdisplay));\r\nval |= ((m->htotal / 2) +\r\n(m->hsync_start - m->hdisplay)) << 12;\r\nhdmi_set_reg(core->v_sync_gen3, 3, val);\r\nhdmi_set_reg(tg->vact_st, 2, (m->vtotal - m->vdisplay) / 2);\r\nhdmi_set_reg(tg->vact_sz, 2, m->vdisplay / 2);\r\nhdmi_set_reg(tg->vact_st2, 2, 0x249);\r\n} else {\r\nval = m->vtotal;\r\nval |= (m->vtotal - m->vdisplay) << 11;\r\nhdmi_set_reg(core->v_blank, 3, val);\r\nhdmi_set_reg(core->v_blank_f, 3, 0);\r\nval = (m->vsync_end - m->vdisplay);\r\nval |= ((m->vsync_start - m->vdisplay) << 12);\r\nhdmi_set_reg(core->v_sync_gen1, 3, val);\r\nhdmi_set_reg(core->v_sync_gen2, 3, 0x1001);\r\nhdmi_set_reg(core->v_sync_gen3, 3, 0x1001);\r\nhdmi_set_reg(tg->vact_st, 2, m->vtotal - m->vdisplay);\r\nhdmi_set_reg(tg->vact_sz, 2, m->vdisplay);\r\nhdmi_set_reg(tg->vact_st2, 2, 0x248);\r\n}\r\nhdmi_set_reg(tg->cmd, 1, 0x0);\r\nhdmi_set_reg(tg->h_fsz, 2, m->htotal);\r\nhdmi_set_reg(tg->hact_st, 2, m->htotal - m->hdisplay);\r\nhdmi_set_reg(tg->hact_sz, 2, m->hdisplay);\r\nhdmi_set_reg(tg->v_fsz, 2, m->vtotal);\r\nhdmi_set_reg(tg->vsync, 2, 0x1);\r\nhdmi_set_reg(tg->vsync2, 2, 0x233);\r\nhdmi_set_reg(tg->field_chg, 2, 0x233);\r\nhdmi_set_reg(tg->vsync_top_hdmi, 2, 0x1);\r\nhdmi_set_reg(tg->vsync_bot_hdmi, 2, 0x233);\r\nhdmi_set_reg(tg->field_top_hdmi, 2, 0x1);\r\nhdmi_set_reg(tg->field_bot_hdmi, 2, 0x233);\r\nhdmi_set_reg(tg->tg_3d, 1, 0x0);\r\n}\r\nstatic void hdmi_v14_mode_set(struct hdmi_context *hdata,\r\nstruct drm_display_mode *m)\r\n{\r\nstruct hdmi_tg_regs *tg = &hdata->mode_conf.conf.v14_conf.tg;\r\nstruct hdmi_v14_core_regs *core =\r\n&hdata->mode_conf.conf.v14_conf.core;\r\nhdata->mode_conf.cea_video_id =\r\ndrm_match_cea_mode((struct drm_display_mode *)m);\r\nhdata->mode_conf.pixel_clock = m->clock * 1000;\r\nhdmi_set_reg(core->h_blank, 2, m->htotal - m->hdisplay);\r\nhdmi_set_reg(core->v_line, 2, m->vtotal);\r\nhdmi_set_reg(core->h_line, 2, m->htotal);\r\nhdmi_set_reg(core->hsync_pol, 1,\r\n(m->flags & DRM_MODE_FLAG_NHSYNC) ? 1 : 0);\r\nhdmi_set_reg(core->vsync_pol, 1,\r\n(m->flags & DRM_MODE_FLAG_NVSYNC) ? 1 : 0);\r\nhdmi_set_reg(core->int_pro_mode, 1,\r\n(m->flags & DRM_MODE_FLAG_INTERLACE) ? 1 : 0);\r\nif (m->flags & DRM_MODE_FLAG_INTERLACE) {\r\nhdmi_set_reg(core->v_sync_line_bef_2, 2,\r\n(m->vsync_end - m->vdisplay) / 2);\r\nhdmi_set_reg(core->v_sync_line_bef_1, 2,\r\n(m->vsync_start - m->vdisplay) / 2);\r\nhdmi_set_reg(core->v2_blank, 2, m->vtotal / 2);\r\nhdmi_set_reg(core->v1_blank, 2, (m->vtotal - m->vdisplay) / 2);\r\nhdmi_set_reg(core->v_blank_f0, 2, m->vtotal - m->vdisplay / 2);\r\nhdmi_set_reg(core->v_blank_f1, 2, m->vtotal);\r\nhdmi_set_reg(core->v_sync_line_aft_2, 2, (m->vtotal / 2) + 7);\r\nhdmi_set_reg(core->v_sync_line_aft_1, 2, (m->vtotal / 2) + 2);\r\nhdmi_set_reg(core->v_sync_line_aft_pxl_2, 2,\r\n(m->htotal / 2) + (m->hsync_start - m->hdisplay));\r\nhdmi_set_reg(core->v_sync_line_aft_pxl_1, 2,\r\n(m->htotal / 2) + (m->hsync_start - m->hdisplay));\r\nhdmi_set_reg(tg->vact_st, 2, (m->vtotal - m->vdisplay) / 2);\r\nhdmi_set_reg(tg->vact_sz, 2, m->vdisplay / 2);\r\nhdmi_set_reg(tg->vact_st2, 2, m->vtotal - m->vdisplay / 2);\r\nhdmi_set_reg(tg->vsync2, 2, (m->vtotal / 2) + 1);\r\nhdmi_set_reg(tg->vsync_bot_hdmi, 2, (m->vtotal / 2) + 1);\r\nhdmi_set_reg(tg->field_bot_hdmi, 2, (m->vtotal / 2) + 1);\r\nhdmi_set_reg(tg->vact_st3, 2, 0x0);\r\nhdmi_set_reg(tg->vact_st4, 2, 0x0);\r\n} else {\r\nhdmi_set_reg(core->v_sync_line_bef_2, 2,\r\nm->vsync_end - m->vdisplay);\r\nhdmi_set_reg(core->v_sync_line_bef_1, 2,\r\nm->vsync_start - m->vdisplay);\r\nhdmi_set_reg(core->v2_blank, 2, m->vtotal);\r\nhdmi_set_reg(core->v1_blank, 2, m->vtotal - m->vdisplay);\r\nhdmi_set_reg(core->v_blank_f0, 2, 0xffff);\r\nhdmi_set_reg(core->v_blank_f1, 2, 0xffff);\r\nhdmi_set_reg(core->v_sync_line_aft_2, 2, 0xffff);\r\nhdmi_set_reg(core->v_sync_line_aft_1, 2, 0xffff);\r\nhdmi_set_reg(core->v_sync_line_aft_pxl_2, 2, 0xffff);\r\nhdmi_set_reg(core->v_sync_line_aft_pxl_1, 2, 0xffff);\r\nhdmi_set_reg(tg->vact_st, 2, m->vtotal - m->vdisplay);\r\nhdmi_set_reg(tg->vact_sz, 2, m->vdisplay);\r\nhdmi_set_reg(tg->vact_st2, 2, 0x248);\r\nhdmi_set_reg(tg->vact_st3, 2, 0x47b);\r\nhdmi_set_reg(tg->vact_st4, 2, 0x6ae);\r\nhdmi_set_reg(tg->vsync2, 2, 0x233);\r\nhdmi_set_reg(tg->vsync_bot_hdmi, 2, 0x233);\r\nhdmi_set_reg(tg->field_bot_hdmi, 2, 0x233);\r\n}\r\nhdmi_set_reg(core->h_sync_start, 2, m->hsync_start - m->hdisplay - 2);\r\nhdmi_set_reg(core->h_sync_end, 2, m->hsync_end - m->hdisplay - 2);\r\nhdmi_set_reg(core->vact_space_1, 2, 0xffff);\r\nhdmi_set_reg(core->vact_space_2, 2, 0xffff);\r\nhdmi_set_reg(core->vact_space_3, 2, 0xffff);\r\nhdmi_set_reg(core->vact_space_4, 2, 0xffff);\r\nhdmi_set_reg(core->vact_space_5, 2, 0xffff);\r\nhdmi_set_reg(core->vact_space_6, 2, 0xffff);\r\nhdmi_set_reg(core->v_blank_f2, 2, 0xffff);\r\nhdmi_set_reg(core->v_blank_f3, 2, 0xffff);\r\nhdmi_set_reg(core->v_blank_f4, 2, 0xffff);\r\nhdmi_set_reg(core->v_blank_f5, 2, 0xffff);\r\nhdmi_set_reg(core->v_sync_line_aft_3, 2, 0xffff);\r\nhdmi_set_reg(core->v_sync_line_aft_4, 2, 0xffff);\r\nhdmi_set_reg(core->v_sync_line_aft_5, 2, 0xffff);\r\nhdmi_set_reg(core->v_sync_line_aft_6, 2, 0xffff);\r\nhdmi_set_reg(core->v_sync_line_aft_pxl_3, 2, 0xffff);\r\nhdmi_set_reg(core->v_sync_line_aft_pxl_4, 2, 0xffff);\r\nhdmi_set_reg(core->v_sync_line_aft_pxl_5, 2, 0xffff);\r\nhdmi_set_reg(core->v_sync_line_aft_pxl_6, 2, 0xffff);\r\nhdmi_set_reg(tg->cmd, 1, 0x0);\r\nhdmi_set_reg(tg->h_fsz, 2, m->htotal);\r\nhdmi_set_reg(tg->hact_st, 2, m->htotal - m->hdisplay);\r\nhdmi_set_reg(tg->hact_sz, 2, m->hdisplay);\r\nhdmi_set_reg(tg->v_fsz, 2, m->vtotal);\r\nhdmi_set_reg(tg->vsync, 2, 0x1);\r\nhdmi_set_reg(tg->field_chg, 2, 0x233);\r\nhdmi_set_reg(tg->vsync_top_hdmi, 2, 0x1);\r\nhdmi_set_reg(tg->field_top_hdmi, 2, 0x1);\r\nhdmi_set_reg(tg->tg_3d, 1, 0x0);\r\n}\r\nstatic void hdmi_mode_set(void *ctx, struct drm_display_mode *mode)\r\n{\r\nstruct hdmi_context *hdata = ctx;\r\nstruct drm_display_mode *m = mode;\r\nDRM_DEBUG_KMS("xres=%d, yres=%d, refresh=%d, intl=%s\n",\r\nm->hdisplay, m->vdisplay,\r\nm->vrefresh, (m->flags & DRM_MODE_FLAG_INTERLACE) ?\r\n"INTERLACED" : "PROGERESSIVE");\r\nif (hdata->type == HDMI_TYPE13)\r\nhdmi_v13_mode_set(hdata, mode);\r\nelse\r\nhdmi_v14_mode_set(hdata, mode);\r\n}\r\nstatic void hdmi_get_max_resol(void *ctx, unsigned int *width,\r\nunsigned int *height)\r\n{\r\n*width = MAX_WIDTH;\r\n*height = MAX_HEIGHT;\r\n}\r\nstatic void hdmi_commit(void *ctx)\r\n{\r\nstruct hdmi_context *hdata = ctx;\r\nmutex_lock(&hdata->hdmi_mutex);\r\nif (!hdata->powered) {\r\nmutex_unlock(&hdata->hdmi_mutex);\r\nreturn;\r\n}\r\nmutex_unlock(&hdata->hdmi_mutex);\r\nhdmi_conf_apply(hdata);\r\n}\r\nstatic void hdmi_poweron(struct hdmi_context *hdata)\r\n{\r\nstruct hdmi_resources *res = &hdata->res;\r\nmutex_lock(&hdata->hdmi_mutex);\r\nif (hdata->powered) {\r\nmutex_unlock(&hdata->hdmi_mutex);\r\nreturn;\r\n}\r\nhdata->powered = true;\r\nmutex_unlock(&hdata->hdmi_mutex);\r\nif (regulator_bulk_enable(res->regul_count, res->regul_bulk))\r\nDRM_DEBUG_KMS("failed to enable regulator bulk\n");\r\nclk_prepare_enable(res->hdmiphy);\r\nclk_prepare_enable(res->hdmi);\r\nclk_prepare_enable(res->sclk_hdmi);\r\nhdmiphy_poweron(hdata);\r\n}\r\nstatic void hdmi_poweroff(struct hdmi_context *hdata)\r\n{\r\nstruct hdmi_resources *res = &hdata->res;\r\nmutex_lock(&hdata->hdmi_mutex);\r\nif (!hdata->powered)\r\ngoto out;\r\nmutex_unlock(&hdata->hdmi_mutex);\r\nhdmiphy_conf_reset(hdata);\r\nhdmiphy_poweroff(hdata);\r\nclk_disable_unprepare(res->sclk_hdmi);\r\nclk_disable_unprepare(res->hdmi);\r\nclk_disable_unprepare(res->hdmiphy);\r\nregulator_bulk_disable(res->regul_count, res->regul_bulk);\r\nmutex_lock(&hdata->hdmi_mutex);\r\nhdata->powered = false;\r\nout:\r\nmutex_unlock(&hdata->hdmi_mutex);\r\n}\r\nstatic void hdmi_dpms(void *ctx, int mode)\r\n{\r\nstruct hdmi_context *hdata = ctx;\r\nDRM_DEBUG_KMS("mode %d\n", mode);\r\nswitch (mode) {\r\ncase DRM_MODE_DPMS_ON:\r\nif (pm_runtime_suspended(hdata->dev))\r\npm_runtime_get_sync(hdata->dev);\r\nbreak;\r\ncase DRM_MODE_DPMS_STANDBY:\r\ncase DRM_MODE_DPMS_SUSPEND:\r\ncase DRM_MODE_DPMS_OFF:\r\nif (!pm_runtime_suspended(hdata->dev))\r\npm_runtime_put_sync(hdata->dev);\r\nbreak;\r\ndefault:\r\nDRM_DEBUG_KMS("unknown dpms mode: %d\n", mode);\r\nbreak;\r\n}\r\n}\r\nstatic irqreturn_t hdmi_irq_thread(int irq, void *arg)\r\n{\r\nstruct exynos_drm_hdmi_context *ctx = arg;\r\nstruct hdmi_context *hdata = ctx->ctx;\r\nmutex_lock(&hdata->hdmi_mutex);\r\nhdata->hpd = gpio_get_value(hdata->hpd_gpio);\r\nmutex_unlock(&hdata->hdmi_mutex);\r\nif (ctx->drm_dev)\r\ndrm_helper_hpd_irq_event(ctx->drm_dev);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int hdmi_resources_init(struct hdmi_context *hdata)\r\n{\r\nstruct device *dev = hdata->dev;\r\nstruct hdmi_resources *res = &hdata->res;\r\nstatic char *supply[] = {\r\n"hdmi-en",\r\n"vdd",\r\n"vdd_osc",\r\n"vdd_pll",\r\n};\r\nint i, ret;\r\nDRM_DEBUG_KMS("HDMI resource init\n");\r\nmemset(res, 0, sizeof(*res));\r\nres->hdmi = devm_clk_get(dev, "hdmi");\r\nif (IS_ERR(res->hdmi)) {\r\nDRM_ERROR("failed to get clock 'hdmi'\n");\r\ngoto fail;\r\n}\r\nres->sclk_hdmi = devm_clk_get(dev, "sclk_hdmi");\r\nif (IS_ERR(res->sclk_hdmi)) {\r\nDRM_ERROR("failed to get clock 'sclk_hdmi'\n");\r\ngoto fail;\r\n}\r\nres->sclk_pixel = devm_clk_get(dev, "sclk_pixel");\r\nif (IS_ERR(res->sclk_pixel)) {\r\nDRM_ERROR("failed to get clock 'sclk_pixel'\n");\r\ngoto fail;\r\n}\r\nres->sclk_hdmiphy = devm_clk_get(dev, "sclk_hdmiphy");\r\nif (IS_ERR(res->sclk_hdmiphy)) {\r\nDRM_ERROR("failed to get clock 'sclk_hdmiphy'\n");\r\ngoto fail;\r\n}\r\nres->hdmiphy = devm_clk_get(dev, "hdmiphy");\r\nif (IS_ERR(res->hdmiphy)) {\r\nDRM_ERROR("failed to get clock 'hdmiphy'\n");\r\ngoto fail;\r\n}\r\nres->mout_hdmi = devm_clk_get(dev, "mout_hdmi");\r\nif (IS_ERR(res->mout_hdmi)) {\r\nDRM_ERROR("failed to get clock 'mout_hdmi'\n");\r\ngoto fail;\r\n}\r\nclk_set_parent(res->mout_hdmi, res->sclk_pixel);\r\nres->regul_bulk = devm_kzalloc(dev, ARRAY_SIZE(supply) *\r\nsizeof(res->regul_bulk[0]), GFP_KERNEL);\r\nif (!res->regul_bulk)\r\ngoto fail;\r\nfor (i = 0; i < ARRAY_SIZE(supply); ++i) {\r\nres->regul_bulk[i].supply = supply[i];\r\nres->regul_bulk[i].consumer = NULL;\r\n}\r\nret = devm_regulator_bulk_get(dev, ARRAY_SIZE(supply), res->regul_bulk);\r\nif (ret) {\r\nDRM_ERROR("failed to get regulators\n");\r\ngoto fail;\r\n}\r\nres->regul_count = ARRAY_SIZE(supply);\r\nreturn 0;\r\nfail:\r\nDRM_ERROR("HDMI resource init - failed\n");\r\nreturn -ENODEV;\r\n}\r\nvoid hdmi_attach_ddc_client(struct i2c_client *ddc)\r\n{\r\nif (ddc)\r\nhdmi_ddc = ddc;\r\n}\r\nvoid hdmi_attach_hdmiphy_client(struct i2c_client *hdmiphy)\r\n{\r\nif (hdmiphy)\r\nhdmi_hdmiphy = hdmiphy;\r\n}\r\nstatic struct s5p_hdmi_platform_data *drm_hdmi_dt_parse_pdata\r\n(struct device *dev)\r\n{\r\nstruct device_node *np = dev->of_node;\r\nstruct s5p_hdmi_platform_data *pd;\r\nu32 value;\r\npd = devm_kzalloc(dev, sizeof(*pd), GFP_KERNEL);\r\nif (!pd)\r\ngoto err_data;\r\nif (!of_find_property(np, "hpd-gpio", &value)) {\r\nDRM_ERROR("no hpd gpio property found\n");\r\ngoto err_data;\r\n}\r\npd->hpd_gpio = of_get_named_gpio(np, "hpd-gpio", 0);\r\nreturn pd;\r\nerr_data:\r\nreturn NULL;\r\n}\r\nstatic int hdmi_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct exynos_drm_hdmi_context *drm_hdmi_ctx;\r\nstruct hdmi_context *hdata;\r\nstruct s5p_hdmi_platform_data *pdata;\r\nstruct resource *res;\r\nconst struct of_device_id *match;\r\nint ret;\r\nif (!dev->of_node)\r\nreturn -ENODEV;\r\npdata = drm_hdmi_dt_parse_pdata(dev);\r\nif (!pdata)\r\nreturn -EINVAL;\r\ndrm_hdmi_ctx = devm_kzalloc(dev, sizeof(*drm_hdmi_ctx), GFP_KERNEL);\r\nif (!drm_hdmi_ctx)\r\nreturn -ENOMEM;\r\nhdata = devm_kzalloc(dev, sizeof(struct hdmi_context), GFP_KERNEL);\r\nif (!hdata)\r\nreturn -ENOMEM;\r\nmutex_init(&hdata->hdmi_mutex);\r\ndrm_hdmi_ctx->ctx = (void *)hdata;\r\nhdata->parent_ctx = (void *)drm_hdmi_ctx;\r\nplatform_set_drvdata(pdev, drm_hdmi_ctx);\r\nmatch = of_match_node(hdmi_match_types, dev->of_node);\r\nif (!match)\r\nreturn -ENODEV;\r\nhdata->type = (enum hdmi_type)match->data;\r\nhdata->hpd_gpio = pdata->hpd_gpio;\r\nhdata->dev = dev;\r\nret = hdmi_resources_init(hdata);\r\nif (ret) {\r\nDRM_ERROR("hdmi_resources_init failed\n");\r\nreturn -EINVAL;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nhdata->regs = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(hdata->regs))\r\nreturn PTR_ERR(hdata->regs);\r\nret = devm_gpio_request(dev, hdata->hpd_gpio, "HPD");\r\nif (ret) {\r\nDRM_ERROR("failed to request HPD gpio\n");\r\nreturn ret;\r\n}\r\nif (i2c_add_driver(&ddc_driver)) {\r\nDRM_ERROR("failed to register ddc i2c driver\n");\r\nreturn -ENOENT;\r\n}\r\nhdata->ddc_port = hdmi_ddc;\r\nif (i2c_add_driver(&hdmiphy_driver)) {\r\nDRM_ERROR("failed to register hdmiphy i2c driver\n");\r\nret = -ENOENT;\r\ngoto err_ddc;\r\n}\r\nhdata->hdmiphy_port = hdmi_hdmiphy;\r\nhdata->irq = gpio_to_irq(hdata->hpd_gpio);\r\nif (hdata->irq < 0) {\r\nDRM_ERROR("failed to get GPIO irq\n");\r\nret = hdata->irq;\r\ngoto err_hdmiphy;\r\n}\r\nhdata->hpd = gpio_get_value(hdata->hpd_gpio);\r\nret = devm_request_threaded_irq(dev, hdata->irq, NULL,\r\nhdmi_irq_thread, IRQF_TRIGGER_RISING |\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\n"hdmi", drm_hdmi_ctx);\r\nif (ret) {\r\nDRM_ERROR("failed to register hdmi interrupt\n");\r\ngoto err_hdmiphy;\r\n}\r\nexynos_hdmi_drv_attach(drm_hdmi_ctx);\r\nexynos_hdmi_ops_register(&hdmi_ops);\r\npm_runtime_enable(dev);\r\nreturn 0;\r\nerr_hdmiphy:\r\ni2c_del_driver(&hdmiphy_driver);\r\nerr_ddc:\r\ni2c_del_driver(&ddc_driver);\r\nreturn ret;\r\n}\r\nstatic int hdmi_remove(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\npm_runtime_disable(dev);\r\ni2c_del_driver(&hdmiphy_driver);\r\ni2c_del_driver(&ddc_driver);\r\nreturn 0;\r\n}\r\nstatic int hdmi_suspend(struct device *dev)\r\n{\r\nstruct exynos_drm_hdmi_context *ctx = get_hdmi_context(dev);\r\nstruct hdmi_context *hdata = ctx->ctx;\r\ndisable_irq(hdata->irq);\r\nhdata->hpd = false;\r\nif (ctx->drm_dev)\r\ndrm_helper_hpd_irq_event(ctx->drm_dev);\r\nif (pm_runtime_suspended(dev)) {\r\nDRM_DEBUG_KMS("Already suspended\n");\r\nreturn 0;\r\n}\r\nhdmi_poweroff(hdata);\r\nreturn 0;\r\n}\r\nstatic int hdmi_resume(struct device *dev)\r\n{\r\nstruct exynos_drm_hdmi_context *ctx = get_hdmi_context(dev);\r\nstruct hdmi_context *hdata = ctx->ctx;\r\nhdata->hpd = gpio_get_value(hdata->hpd_gpio);\r\nenable_irq(hdata->irq);\r\nif (!pm_runtime_suspended(dev)) {\r\nDRM_DEBUG_KMS("Already resumed\n");\r\nreturn 0;\r\n}\r\nhdmi_poweron(hdata);\r\nreturn 0;\r\n}\r\nstatic int hdmi_runtime_suspend(struct device *dev)\r\n{\r\nstruct exynos_drm_hdmi_context *ctx = get_hdmi_context(dev);\r\nstruct hdmi_context *hdata = ctx->ctx;\r\nhdmi_poweroff(hdata);\r\nreturn 0;\r\n}\r\nstatic int hdmi_runtime_resume(struct device *dev)\r\n{\r\nstruct exynos_drm_hdmi_context *ctx = get_hdmi_context(dev);\r\nstruct hdmi_context *hdata = ctx->ctx;\r\nhdmi_poweron(hdata);\r\nreturn 0;\r\n}

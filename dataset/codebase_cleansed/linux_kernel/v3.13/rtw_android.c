int rtw_android_cmdstr_to_num(char *cmdstr)\r\n{\r\nint cmd_num;\r\nfor (cmd_num = 0; cmd_num < ANDROID_WIFI_CMD_MAX; cmd_num++)\r\nif (0 == strnicmp(cmdstr , android_wifi_cmd_str[cmd_num],\r\nstrlen(android_wifi_cmd_str[cmd_num])))\r\nbreak;\r\nreturn cmd_num;\r\n}\r\nstatic int rtw_android_get_rssi(struct net_device *net, char *command,\r\nint total_len)\r\n{\r\nstruct adapter *padapter = (struct adapter *)rtw_netdev_priv(net);\r\nstruct mlme_priv *pmlmepriv = &(padapter->mlmepriv);\r\nstruct wlan_network *pcur_network = &pmlmepriv->cur_network;\r\nint bytes_written = 0;\r\nif (check_fwstate(pmlmepriv, _FW_LINKED)) {\r\nbytes_written += snprintf(&command[bytes_written], total_len,\r\n"%s rssi %d",\r\npcur_network->network.Ssid.Ssid,\r\npadapter->recvpriv.rssi);\r\n}\r\nreturn bytes_written;\r\n}\r\nstatic int rtw_android_get_link_speed(struct net_device *net, char *command,\r\nint total_len)\r\n{\r\nstruct adapter *padapter = (struct adapter *)rtw_netdev_priv(net);\r\nint bytes_written;\r\nu16 link_speed;\r\nlink_speed = rtw_get_cur_max_rate(padapter) / 10;\r\nbytes_written = snprintf(command, total_len, "LinkSpeed %d",\r\nlink_speed);\r\nreturn bytes_written;\r\n}\r\nstatic int rtw_android_get_macaddr(struct net_device *net, char *command,\r\nint total_len)\r\n{\r\nint bytes_written;\r\nbytes_written = snprintf(command, total_len, "Macaddr = %pM",\r\nnet->dev_addr);\r\nreturn bytes_written;\r\n}\r\nstatic int android_set_cntry(struct net_device *net, char *command,\r\nint total_len)\r\n{\r\nstruct adapter *adapter = (struct adapter *)rtw_netdev_priv(net);\r\nchar *country_code = command + strlen(android_wifi_cmd_str[ANDROID_WIFI_CMD_COUNTRY]) + 1;\r\nint ret;\r\nret = rtw_set_country(adapter, country_code);\r\nreturn (ret == _SUCCESS) ? 0 : -1;\r\n}\r\nstatic int android_get_p2p_addr(struct net_device *net, char *command,\r\nint total_len)\r\n{\r\nmemcpy(command, net->dev_addr, ETH_ALEN);\r\nreturn ETH_ALEN;\r\n}\r\nstatic int rtw_android_set_block(struct net_device *net, char *command,\r\nint total_len)\r\n{\r\nreturn 0;\r\n}\r\nint rtw_android_priv_cmd(struct net_device *net, struct ifreq *ifr, int cmd)\r\n{\r\nint ret = 0;\r\nchar *command = NULL;\r\nint cmd_num;\r\nint bytes_written = 0;\r\nstruct android_wifi_priv_cmd priv_cmd;\r\nrtw_lock_suspend();\r\nif (!ifr->ifr_data) {\r\nret = -EINVAL;\r\ngoto exit;\r\n}\r\nif (copy_from_user(&priv_cmd, ifr->ifr_data,\r\nsizeof(struct android_wifi_priv_cmd))) {\r\nret = -EFAULT;\r\ngoto exit;\r\n}\r\ncommand = kmalloc(priv_cmd.total_len, GFP_KERNEL);\r\nif (!command) {\r\nDBG_88E("%s: failed to allocate memory\n", __func__);\r\nret = -ENOMEM;\r\ngoto exit;\r\n}\r\nif (!access_ok(VERIFY_READ, priv_cmd.buf, priv_cmd.total_len)) {\r\nDBG_88E("%s: failed to access memory\n", __func__);\r\nret = -EFAULT;\r\ngoto exit;\r\n}\r\nif (copy_from_user(command, (char __user *)priv_cmd.buf,\r\npriv_cmd.total_len)) {\r\nret = -EFAULT;\r\ngoto exit;\r\n}\r\nDBG_88E("%s: Android private cmd \"%s\" on %s\n",\r\n__func__, command, ifr->ifr_name);\r\ncmd_num = rtw_android_cmdstr_to_num(command);\r\nswitch (cmd_num) {\r\ncase ANDROID_WIFI_CMD_START:\r\ngoto response;\r\ncase ANDROID_WIFI_CMD_SETFWPATH:\r\ngoto response;\r\n}\r\nif (!g_wifi_on) {\r\nDBG_88E("%s: Ignore private cmd \"%s\" - iface %s is down\n",\r\n__func__, command, ifr->ifr_name);\r\nret = 0;\r\ngoto exit;\r\n}\r\nswitch (cmd_num) {\r\ncase ANDROID_WIFI_CMD_STOP:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_SCAN_ACTIVE:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_SCAN_PASSIVE:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_RSSI:\r\nbytes_written = rtw_android_get_rssi(net, command,\r\npriv_cmd.total_len);\r\nbreak;\r\ncase ANDROID_WIFI_CMD_LINKSPEED:\r\nbytes_written = rtw_android_get_link_speed(net, command,\r\npriv_cmd.total_len);\r\nbreak;\r\ncase ANDROID_WIFI_CMD_MACADDR:\r\nbytes_written = rtw_android_get_macaddr(net, command,\r\npriv_cmd.total_len);\r\nbreak;\r\ncase ANDROID_WIFI_CMD_BLOCK:\r\nbytes_written = rtw_android_set_block(net, command,\r\npriv_cmd.total_len);\r\nbreak;\r\ncase ANDROID_WIFI_CMD_RXFILTER_START:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_RXFILTER_STOP:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_RXFILTER_ADD:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_RXFILTER_REMOVE:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_BTCOEXSCAN_START:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_BTCOEXSCAN_STOP:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_BTCOEXMODE:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_SETSUSPENDOPT:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_SETBAND:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_GETBAND:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_COUNTRY:\r\nbytes_written = android_set_cntry(net, command,\r\npriv_cmd.total_len);\r\nbreak;\r\ncase ANDROID_WIFI_CMD_P2P_DEV_ADDR:\r\nbytes_written = android_get_p2p_addr(net, command,\r\npriv_cmd.total_len);\r\nbreak;\r\ncase ANDROID_WIFI_CMD_P2P_SET_NOA:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_P2P_GET_NOA:\r\nbreak;\r\ncase ANDROID_WIFI_CMD_P2P_SET_PS:\r\nbreak;\r\ndefault:\r\nDBG_88E("Unknown PRIVATE command %s - ignored\n", command);\r\nsnprintf(command, 3, "OK");\r\nbytes_written = strlen("OK");\r\n}\r\nresponse:\r\nif (bytes_written >= 0) {\r\nif ((bytes_written == 0) && (priv_cmd.total_len > 0))\r\ncommand[0] = '\0';\r\nif (bytes_written >= priv_cmd.total_len) {\r\nDBG_88E("%s: bytes_written = %d\n", __func__,\r\nbytes_written);\r\nbytes_written = priv_cmd.total_len;\r\n} else {\r\nbytes_written++;\r\n}\r\npriv_cmd.used_len = bytes_written;\r\nif (copy_to_user((char __user *)priv_cmd.buf, command,\r\nbytes_written)) {\r\nDBG_88E("%s: failed to copy data to user buffer\n",\r\n__func__);\r\nret = -EFAULT;\r\n}\r\n} else {\r\nret = bytes_written;\r\n}\r\nexit:\r\nrtw_unlock_suspend();\r\nkfree(command);\r\nreturn ret;\r\n}

static i40e_status i40e_diag_reg_pattern_test(struct i40e_hw *hw,\r\nu32 reg, u32 mask)\r\n{\r\nconst u32 patterns[] = {0x5A5A5A5A, 0xA5A5A5A5, 0x00000000, 0xFFFFFFFF};\r\nu32 pat, val, orig_val;\r\nint i;\r\norig_val = rd32(hw, reg);\r\nfor (i = 0; i < ARRAY_SIZE(patterns); i++) {\r\npat = patterns[i];\r\nwr32(hw, reg, (pat & mask));\r\nval = rd32(hw, reg);\r\nif ((val & mask) != (pat & mask)) {\r\ni40e_debug(hw, I40E_DEBUG_DIAG,\r\n"%s: reg pattern test failed - reg 0x%08x pat 0x%08x val 0x%08x\n",\r\n__func__, reg, pat, val);\r\nreturn I40E_ERR_DIAG_TEST_FAILED;\r\n}\r\n}\r\nwr32(hw, reg, orig_val);\r\nval = rd32(hw, reg);\r\nif (val != orig_val) {\r\ni40e_debug(hw, I40E_DEBUG_DIAG,\r\n"%s: reg restore test failed - reg 0x%08x orig_val 0x%08x val 0x%08x\n",\r\n__func__, reg, orig_val, val);\r\nreturn I40E_ERR_DIAG_TEST_FAILED;\r\n}\r\nreturn 0;\r\n}\r\ni40e_status i40e_diag_reg_test(struct i40e_hw *hw)\r\n{\r\ni40e_status ret_code = 0;\r\nu32 reg, mask;\r\nu32 i, j;\r\nfor (i = 0; (i40e_reg_list[i].offset != 0) && !ret_code; i++) {\r\nmask = i40e_reg_list[i].mask;\r\nfor (j = 0; (j < i40e_reg_list[i].elements) && !ret_code; j++) {\r\nreg = i40e_reg_list[i].offset +\r\n(j * i40e_reg_list[i].stride);\r\nret_code = i40e_diag_reg_pattern_test(hw, reg, mask);\r\n}\r\n}\r\nreturn ret_code;\r\n}\r\ni40e_status i40e_diag_eeprom_test(struct i40e_hw *hw)\r\n{\r\ni40e_status ret_code;\r\nu16 reg_val;\r\nret_code = i40e_read_nvm_word(hw, I40E_SR_NVM_CONTROL_WORD, &reg_val);\r\nif ((!ret_code) &&\r\n((reg_val & I40E_SR_CONTROL_WORD_1_MASK) ==\r\n(0x01 << I40E_SR_CONTROL_WORD_1_SHIFT))) {\r\nret_code = i40e_validate_nvm_checksum(hw, NULL);\r\n} else {\r\nret_code = I40E_ERR_DIAG_TEST_FAILED;\r\n}\r\nreturn ret_code;\r\n}

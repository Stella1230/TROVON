static bool dell_wmi_aio_event_check(u8 *buffer, int length)\r\n{\r\nstruct dell_wmi_event *event = (struct dell_wmi_event *)buffer;\r\nif (event == NULL || length < 6)\r\nreturn false;\r\nif ((event->type == 0 || event->type == 0xf) &&\r\nevent->length >= 2)\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic void dell_wmi_aio_notify(u32 value, void *context)\r\n{\r\nstruct acpi_buffer response = { ACPI_ALLOCATE_BUFFER, NULL };\r\nunion acpi_object *obj;\r\nstruct dell_wmi_event *event;\r\nacpi_status status;\r\nstatus = wmi_get_event_data(value, &response);\r\nif (status != AE_OK) {\r\npr_info("bad event status 0x%x\n", status);\r\nreturn;\r\n}\r\nobj = (union acpi_object *)response.pointer;\r\nif (obj) {\r\nunsigned int scancode = 0;\r\nswitch (obj->type) {\r\ncase ACPI_TYPE_INTEGER:\r\nscancode = obj->integer.value;\r\nsparse_keymap_report_event(dell_wmi_aio_input_dev,\r\nscancode, 1, true);\r\nbreak;\r\ncase ACPI_TYPE_BUFFER:\r\nif (dell_wmi_aio_event_check(obj->buffer.pointer,\r\nobj->buffer.length)) {\r\nevent = (struct dell_wmi_event *)\r\nobj->buffer.pointer;\r\nscancode = event->event[0];\r\n} else {\r\nif (obj->buffer.pointer &&\r\nobj->buffer.length > 0)\r\nscancode = obj->buffer.pointer[0];\r\n}\r\nif (scancode)\r\nsparse_keymap_report_event(\r\ndell_wmi_aio_input_dev,\r\nscancode, 1, true);\r\nbreak;\r\n}\r\n}\r\nkfree(obj);\r\n}\r\nstatic int __init dell_wmi_aio_input_setup(void)\r\n{\r\nint err;\r\ndell_wmi_aio_input_dev = input_allocate_device();\r\nif (!dell_wmi_aio_input_dev)\r\nreturn -ENOMEM;\r\ndell_wmi_aio_input_dev->name = "Dell AIO WMI hotkeys";\r\ndell_wmi_aio_input_dev->phys = "wmi/input0";\r\ndell_wmi_aio_input_dev->id.bustype = BUS_HOST;\r\nerr = sparse_keymap_setup(dell_wmi_aio_input_dev,\r\ndell_wmi_aio_keymap, NULL);\r\nif (err) {\r\npr_err("Unable to setup input device keymap\n");\r\ngoto err_free_dev;\r\n}\r\nerr = input_register_device(dell_wmi_aio_input_dev);\r\nif (err) {\r\npr_info("Unable to register input device\n");\r\ngoto err_free_keymap;\r\n}\r\nreturn 0;\r\nerr_free_keymap:\r\nsparse_keymap_free(dell_wmi_aio_input_dev);\r\nerr_free_dev:\r\ninput_free_device(dell_wmi_aio_input_dev);\r\nreturn err;\r\n}\r\nstatic const char *dell_wmi_aio_find(void)\r\n{\r\nint i;\r\nfor (i = 0; dell_wmi_aio_guids[i] != NULL; i++)\r\nif (wmi_has_guid(dell_wmi_aio_guids[i]))\r\nreturn dell_wmi_aio_guids[i];\r\nreturn NULL;\r\n}\r\nstatic int __init dell_wmi_aio_init(void)\r\n{\r\nint err;\r\nconst char *guid;\r\nguid = dell_wmi_aio_find();\r\nif (!guid) {\r\npr_warn("No known WMI GUID found\n");\r\nreturn -ENXIO;\r\n}\r\nerr = dell_wmi_aio_input_setup();\r\nif (err)\r\nreturn err;\r\nerr = wmi_install_notify_handler(guid, dell_wmi_aio_notify, NULL);\r\nif (err) {\r\npr_err("Unable to register notify handler - %d\n", err);\r\nsparse_keymap_free(dell_wmi_aio_input_dev);\r\ninput_unregister_device(dell_wmi_aio_input_dev);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit dell_wmi_aio_exit(void)\r\n{\r\nconst char *guid;\r\nguid = dell_wmi_aio_find();\r\nwmi_remove_notify_handler(guid);\r\nsparse_keymap_free(dell_wmi_aio_input_dev);\r\ninput_unregister_device(dell_wmi_aio_input_dev);\r\n}

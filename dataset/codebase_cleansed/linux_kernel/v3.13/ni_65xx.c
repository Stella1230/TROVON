static inline unsigned Port_Data(unsigned port)\r\n{\r\nreturn 0x40 + port * ni_65xx_port_offset;\r\n}\r\nstatic inline unsigned Port_Select(unsigned port)\r\n{\r\nreturn 0x41 + port * ni_65xx_port_offset;\r\n}\r\nstatic inline unsigned Rising_Edge_Detection_Enable(unsigned port)\r\n{\r\nreturn 0x42 + port * ni_65xx_port_offset;\r\n}\r\nstatic inline unsigned Falling_Edge_Detection_Enable(unsigned port)\r\n{\r\nreturn 0x43 + port * ni_65xx_port_offset;\r\n}\r\nstatic inline unsigned Filter_Enable(unsigned port)\r\n{\r\nreturn 0x44 + port * ni_65xx_port_offset;\r\n}\r\nstatic inline unsigned ni_65xx_port_by_channel(unsigned channel)\r\n{\r\nreturn channel / ni_65xx_channels_per_port;\r\n}\r\nstatic inline unsigned ni_65xx_total_num_ports(const struct ni_65xx_board\r\n*board)\r\n{\r\nreturn board->num_dio_ports + board->num_di_ports + board->num_do_ports;\r\n}\r\nstatic inline struct ni_65xx_subdevice_private *sprivate(struct comedi_subdevice\r\n*subdev)\r\n{\r\nreturn subdev->private;\r\n}\r\nstatic int ni_65xx_config_filter(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nstruct ni_65xx_private *devpriv = dev->private;\r\nconst unsigned chan = CR_CHAN(insn->chanspec);\r\nconst unsigned port =\r\nsprivate(s)->base_port + ni_65xx_port_by_channel(chan);\r\nif (data[0] != INSN_CONFIG_FILTER)\r\nreturn -EINVAL;\r\nif (data[1]) {\r\nstatic const unsigned filter_resolution_ns = 200;\r\nstatic const unsigned max_filter_interval = 0xfffff;\r\nunsigned interval =\r\n(data[1] +\r\n(filter_resolution_ns / 2)) / filter_resolution_ns;\r\nif (interval > max_filter_interval)\r\ninterval = max_filter_interval;\r\ndata[1] = interval * filter_resolution_ns;\r\nif (interval != devpriv->filter_interval) {\r\nwriteb(interval,\r\ndevpriv->mite->daq_io_addr +\r\nFilter_Interval);\r\ndevpriv->filter_interval = interval;\r\n}\r\ndevpriv->filter_enable[port] |=\r\n1 << (chan % ni_65xx_channels_per_port);\r\n} else {\r\ndevpriv->filter_enable[port] &=\r\n~(1 << (chan % ni_65xx_channels_per_port));\r\n}\r\nwriteb(devpriv->filter_enable[port],\r\ndevpriv->mite->daq_io_addr + Filter_Enable(port));\r\nreturn 2;\r\n}\r\nstatic int ni_65xx_dio_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nstruct ni_65xx_private *devpriv = dev->private;\r\nunsigned port;\r\nif (insn->n < 1)\r\nreturn -EINVAL;\r\nport = sprivate(s)->base_port +\r\nni_65xx_port_by_channel(CR_CHAN(insn->chanspec));\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_FILTER:\r\nreturn ni_65xx_config_filter(dev, s, insn, data);\r\nbreak;\r\ncase INSN_CONFIG_DIO_OUTPUT:\r\nif (s->type != COMEDI_SUBD_DIO)\r\nreturn -EINVAL;\r\ndevpriv->dio_direction[port] = COMEDI_OUTPUT;\r\nwriteb(0, devpriv->mite->daq_io_addr + Port_Select(port));\r\nreturn 1;\r\nbreak;\r\ncase INSN_CONFIG_DIO_INPUT:\r\nif (s->type != COMEDI_SUBD_DIO)\r\nreturn -EINVAL;\r\ndevpriv->dio_direction[port] = COMEDI_INPUT;\r\nwriteb(1, devpriv->mite->daq_io_addr + Port_Select(port));\r\nreturn 1;\r\nbreak;\r\ncase INSN_CONFIG_DIO_QUERY:\r\nif (s->type != COMEDI_SUBD_DIO)\r\nreturn -EINVAL;\r\ndata[1] = devpriv->dio_direction[port];\r\nreturn insn->n;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int ni_65xx_dio_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nconst struct ni_65xx_board *board = comedi_board(dev);\r\nstruct ni_65xx_private *devpriv = dev->private;\r\nint base_bitfield_channel;\r\nunsigned read_bits = 0;\r\nint last_port_offset = ni_65xx_port_by_channel(s->n_chan - 1);\r\nint port_offset;\r\nbase_bitfield_channel = CR_CHAN(insn->chanspec);\r\nfor (port_offset = ni_65xx_port_by_channel(base_bitfield_channel);\r\nport_offset <= last_port_offset; port_offset++) {\r\nunsigned port = sprivate(s)->base_port + port_offset;\r\nint base_port_channel = port_offset * ni_65xx_channels_per_port;\r\nunsigned port_mask, port_data, port_read_bits;\r\nint bitshift = base_port_channel - base_bitfield_channel;\r\nif (bitshift >= 32)\r\nbreak;\r\nport_mask = data[0];\r\nport_data = data[1];\r\nif (bitshift > 0) {\r\nport_mask >>= bitshift;\r\nport_data >>= bitshift;\r\n} else {\r\nport_mask <<= -bitshift;\r\nport_data <<= -bitshift;\r\n}\r\nport_mask &= 0xff;\r\nport_data &= 0xff;\r\nif (port_mask) {\r\nunsigned bits;\r\ndevpriv->output_bits[port] &= ~port_mask;\r\ndevpriv->output_bits[port] |=\r\nport_data & port_mask;\r\nbits = devpriv->output_bits[port];\r\nif (board->invert_outputs)\r\nbits = ~bits;\r\nwriteb(bits,\r\ndevpriv->mite->daq_io_addr +\r\nPort_Data(port));\r\n}\r\nport_read_bits =\r\nreadb(devpriv->mite->daq_io_addr + Port_Data(port));\r\nif (s->type == COMEDI_SUBD_DO && board->invert_outputs) {\r\nport_read_bits ^= 0xFF;\r\n}\r\nif (bitshift > 0)\r\nport_read_bits <<= bitshift;\r\nelse\r\nport_read_bits >>= -bitshift;\r\nread_bits |= port_read_bits;\r\n}\r\ndata[1] = read_bits;\r\nreturn insn->n;\r\n}\r\nstatic irqreturn_t ni_65xx_interrupt(int irq, void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nstruct ni_65xx_private *devpriv = dev->private;\r\nstruct comedi_subdevice *s = &dev->subdevices[2];\r\nunsigned int status;\r\nstatus = readb(devpriv->mite->daq_io_addr + Change_Status);\r\nif ((status & MasterInterruptStatus) == 0)\r\nreturn IRQ_NONE;\r\nif ((status & EdgeStatus) == 0)\r\nreturn IRQ_NONE;\r\nwriteb(ClrEdge | ClrOverflow,\r\ndevpriv->mite->daq_io_addr + Clear_Register);\r\ncomedi_buf_put(s->async, 0);\r\ns->async->events |= COMEDI_CB_EOS;\r\ncomedi_event(dev, s);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ni_65xx_intr_cmdtest(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_cmd *cmd)\r\n{\r\nint err = 0;\r\nerr |= cfc_check_trigger_src(&cmd->start_src, TRIG_NOW);\r\nerr |= cfc_check_trigger_src(&cmd->scan_begin_src, TRIG_OTHER);\r\nerr |= cfc_check_trigger_src(&cmd->convert_src, TRIG_FOLLOW);\r\nerr |= cfc_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);\r\nerr |= cfc_check_trigger_src(&cmd->stop_src, TRIG_COUNT);\r\nif (err)\r\nreturn 1;\r\nif (err)\r\nreturn 2;\r\nerr |= cfc_check_trigger_arg_is(&cmd->start_arg, 0);\r\nerr |= cfc_check_trigger_arg_is(&cmd->scan_begin_arg, 0);\r\nerr |= cfc_check_trigger_arg_is(&cmd->convert_arg, 0);\r\nerr |= cfc_check_trigger_arg_is(&cmd->scan_end_arg, 1);\r\nerr |= cfc_check_trigger_arg_is(&cmd->stop_arg, 0);\r\nif (err)\r\nreturn 3;\r\nif (err)\r\nreturn 4;\r\nreturn 0;\r\n}\r\nstatic int ni_65xx_intr_cmd(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct ni_65xx_private *devpriv = dev->private;\r\nwriteb(ClrEdge | ClrOverflow,\r\ndevpriv->mite->daq_io_addr + Clear_Register);\r\nwriteb(FallingEdgeIntEnable | RisingEdgeIntEnable |\r\nMasterInterruptEnable | EdgeIntEnable,\r\ndevpriv->mite->daq_io_addr + Master_Interrupt_Control);\r\nreturn 0;\r\n}\r\nstatic int ni_65xx_intr_cancel(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct ni_65xx_private *devpriv = dev->private;\r\nwriteb(0x00, devpriv->mite->daq_io_addr + Master_Interrupt_Control);\r\nreturn 0;\r\n}\r\nstatic int ni_65xx_intr_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\ndata[1] = 0;\r\nreturn insn->n;\r\n}\r\nstatic int ni_65xx_intr_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct ni_65xx_private *devpriv = dev->private;\r\nif (insn->n < 1)\r\nreturn -EINVAL;\r\nif (data[0] != INSN_CONFIG_CHANGE_NOTIFY)\r\nreturn -EINVAL;\r\nwriteb(data[1],\r\ndevpriv->mite->daq_io_addr +\r\nRising_Edge_Detection_Enable(0));\r\nwriteb(data[1] >> 8,\r\ndevpriv->mite->daq_io_addr +\r\nRising_Edge_Detection_Enable(0x10));\r\nwriteb(data[1] >> 16,\r\ndevpriv->mite->daq_io_addr +\r\nRising_Edge_Detection_Enable(0x20));\r\nwriteb(data[1] >> 24,\r\ndevpriv->mite->daq_io_addr +\r\nRising_Edge_Detection_Enable(0x30));\r\nwriteb(data[2],\r\ndevpriv->mite->daq_io_addr +\r\nFalling_Edge_Detection_Enable(0));\r\nwriteb(data[2] >> 8,\r\ndevpriv->mite->daq_io_addr +\r\nFalling_Edge_Detection_Enable(0x10));\r\nwriteb(data[2] >> 16,\r\ndevpriv->mite->daq_io_addr +\r\nFalling_Edge_Detection_Enable(0x20));\r\nwriteb(data[2] >> 24,\r\ndevpriv->mite->daq_io_addr +\r\nFalling_Edge_Detection_Enable(0x30));\r\nreturn 2;\r\n}\r\nstatic int ni_65xx_auto_attach(struct comedi_device *dev,\r\nunsigned long context)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nconst struct ni_65xx_board *board = NULL;\r\nstruct ni_65xx_private *devpriv;\r\nstruct ni_65xx_subdevice_private *spriv;\r\nstruct comedi_subdevice *s;\r\nunsigned i;\r\nint ret;\r\nif (context < ARRAY_SIZE(ni_65xx_boards))\r\nboard = &ni_65xx_boards[context];\r\nif (!board)\r\nreturn -ENODEV;\r\ndev->board_ptr = board;\r\ndev->board_name = board->name;\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\ndevpriv->mite = mite_alloc(pcidev);\r\nif (!devpriv->mite)\r\nreturn -ENOMEM;\r\nret = mite_setup(devpriv->mite);\r\nif (ret < 0) {\r\ndev_warn(dev->class_dev, "error setting up mite\n");\r\nreturn ret;\r\n}\r\ndev->irq = mite_irq(devpriv->mite);\r\ndev_info(dev->class_dev, "board: %s, ID=0x%02x", dev->board_name,\r\nreadb(devpriv->mite->daq_io_addr + ID_Register));\r\nret = comedi_alloc_subdevices(dev, 4);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\nif (board->num_di_ports) {\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan =\r\nboard->num_di_ports * ni_65xx_channels_per_port;\r\ns->range_table = &range_digital;\r\ns->maxdata = 1;\r\ns->insn_config = ni_65xx_dio_insn_config;\r\ns->insn_bits = ni_65xx_dio_insn_bits;\r\nspriv = comedi_alloc_spriv(s, sizeof(*spriv));\r\nif (!spriv)\r\nreturn -ENOMEM;\r\nspriv->base_port = 0;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[1];\r\nif (board->num_do_ports) {\r\ns->type = COMEDI_SUBD_DO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan =\r\nboard->num_do_ports * ni_65xx_channels_per_port;\r\ns->range_table = &range_digital;\r\ns->maxdata = 1;\r\ns->insn_bits = ni_65xx_dio_insn_bits;\r\nspriv = comedi_alloc_spriv(s, sizeof(*spriv));\r\nif (!spriv)\r\nreturn -ENOMEM;\r\nspriv->base_port = board->num_di_ports;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[2];\r\nif (board->num_dio_ports) {\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan =\r\nboard->num_dio_ports * ni_65xx_channels_per_port;\r\ns->range_table = &range_digital;\r\ns->maxdata = 1;\r\ns->insn_config = ni_65xx_dio_insn_config;\r\ns->insn_bits = ni_65xx_dio_insn_bits;\r\nspriv = comedi_alloc_spriv(s, sizeof(*spriv));\r\nif (!spriv)\r\nreturn -ENOMEM;\r\nspriv->base_port = 0;\r\nfor (i = 0; i < board->num_dio_ports; ++i) {\r\nwriteb(0x1,\r\ndevpriv->mite->daq_io_addr +\r\nPort_Select(i));\r\n}\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[3];\r\ndev->read_subdev = s;\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE | SDF_CMD_READ;\r\ns->n_chan = 1;\r\ns->range_table = &range_unknown;\r\ns->maxdata = 1;\r\ns->do_cmdtest = ni_65xx_intr_cmdtest;\r\ns->do_cmd = ni_65xx_intr_cmd;\r\ns->cancel = ni_65xx_intr_cancel;\r\ns->insn_bits = ni_65xx_intr_insn_bits;\r\ns->insn_config = ni_65xx_intr_insn_config;\r\nfor (i = 0; i < ni_65xx_total_num_ports(board); ++i) {\r\nwriteb(0x00,\r\ndevpriv->mite->daq_io_addr + Filter_Enable(i));\r\nif (board->invert_outputs)\r\nwriteb(0x01,\r\ndevpriv->mite->daq_io_addr + Port_Data(i));\r\nelse\r\nwriteb(0x00,\r\ndevpriv->mite->daq_io_addr + Port_Data(i));\r\n}\r\nwriteb(ClrEdge | ClrOverflow,\r\ndevpriv->mite->daq_io_addr + Clear_Register);\r\nwriteb(0x00,\r\ndevpriv->mite->daq_io_addr + Master_Interrupt_Control);\r\nwriteb(0x00000000, devpriv->mite->daq_io_addr + Filter_Interval);\r\nret = request_irq(dev->irq, ni_65xx_interrupt, IRQF_SHARED,\r\n"ni_65xx", dev);\r\nif (ret < 0) {\r\ndev->irq = 0;\r\ndev_warn(dev->class_dev, "irq not available\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic void ni_65xx_detach(struct comedi_device *dev)\r\n{\r\nstruct ni_65xx_private *devpriv = dev->private;\r\nif (devpriv && devpriv->mite && devpriv->mite->daq_io_addr) {\r\nwriteb(0x00,\r\ndevpriv->mite->daq_io_addr +\r\nMaster_Interrupt_Control);\r\n}\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\nif (devpriv) {\r\nif (devpriv->mite) {\r\nmite_unsetup(devpriv->mite);\r\nmite_free(devpriv->mite);\r\n}\r\n}\r\ncomedi_pci_disable(dev);\r\n}\r\nstatic int ni_65xx_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &ni_65xx_driver, id->driver_data);\r\n}

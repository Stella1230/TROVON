int axienet_mdio_wait_until_ready(struct axienet_local *lp)\r\n{\r\nlong end = jiffies + 2;\r\nwhile (!(axienet_ior(lp, XAE_MDIO_MCR_OFFSET) &\r\nXAE_MDIO_MCR_READY_MASK)) {\r\nif (end - jiffies <= 0) {\r\nWARN_ON(1);\r\nreturn -ETIMEDOUT;\r\n}\r\nudelay(1);\r\n}\r\nreturn 0;\r\n}\r\nstatic int axienet_mdio_read(struct mii_bus *bus, int phy_id, int reg)\r\n{\r\nu32 rc;\r\nint ret;\r\nstruct axienet_local *lp = bus->priv;\r\nret = axienet_mdio_wait_until_ready(lp);\r\nif (ret < 0)\r\nreturn ret;\r\naxienet_iow(lp, XAE_MDIO_MCR_OFFSET,\r\n(((phy_id << XAE_MDIO_MCR_PHYAD_SHIFT) &\r\nXAE_MDIO_MCR_PHYAD_MASK) |\r\n((reg << XAE_MDIO_MCR_REGAD_SHIFT) &\r\nXAE_MDIO_MCR_REGAD_MASK) |\r\nXAE_MDIO_MCR_INITIATE_MASK |\r\nXAE_MDIO_MCR_OP_READ_MASK));\r\nret = axienet_mdio_wait_until_ready(lp);\r\nif (ret < 0)\r\nreturn ret;\r\nrc = axienet_ior(lp, XAE_MDIO_MRD_OFFSET) & 0x0000FFFF;\r\ndev_dbg(lp->dev, "axienet_mdio_read(phy_id=%i, reg=%x) == %x\n",\r\nphy_id, reg, rc);\r\nreturn rc;\r\n}\r\nstatic int axienet_mdio_write(struct mii_bus *bus, int phy_id, int reg,\r\nu16 val)\r\n{\r\nint ret;\r\nstruct axienet_local *lp = bus->priv;\r\ndev_dbg(lp->dev, "axienet_mdio_write(phy_id=%i, reg=%x, val=%x)\n",\r\nphy_id, reg, val);\r\nret = axienet_mdio_wait_until_ready(lp);\r\nif (ret < 0)\r\nreturn ret;\r\naxienet_iow(lp, XAE_MDIO_MWD_OFFSET, (u32) val);\r\naxienet_iow(lp, XAE_MDIO_MCR_OFFSET,\r\n(((phy_id << XAE_MDIO_MCR_PHYAD_SHIFT) &\r\nXAE_MDIO_MCR_PHYAD_MASK) |\r\n((reg << XAE_MDIO_MCR_REGAD_SHIFT) &\r\nXAE_MDIO_MCR_REGAD_MASK) |\r\nXAE_MDIO_MCR_INITIATE_MASK |\r\nXAE_MDIO_MCR_OP_WRITE_MASK));\r\nret = axienet_mdio_wait_until_ready(lp);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint axienet_mdio_setup(struct axienet_local *lp, struct device_node *np)\r\n{\r\nint ret;\r\nu32 clk_div, host_clock;\r\nu32 *property_p;\r\nstruct mii_bus *bus;\r\nstruct resource res;\r\nstruct device_node *np1;\r\nnp1 = of_find_node_by_name(NULL, "cpu");\r\nif (!np1) {\r\nprintk(KERN_WARNING "%s(): Could not find CPU device node.",\r\n__func__);\r\nprintk(KERN_WARNING "Setting MDIO clock divisor to "\r\n"default %d\n", DEFAULT_CLOCK_DIVISOR);\r\nclk_div = DEFAULT_CLOCK_DIVISOR;\r\ngoto issue;\r\n}\r\nproperty_p = (u32 *) of_get_property(np1, "clock-frequency", NULL);\r\nif (!property_p) {\r\nprintk(KERN_WARNING "%s(): Could not find CPU property: "\r\n"clock-frequency.", __func__);\r\nprintk(KERN_WARNING "Setting MDIO clock divisor to "\r\n"default %d\n", DEFAULT_CLOCK_DIVISOR);\r\nclk_div = DEFAULT_CLOCK_DIVISOR;\r\nof_node_put(np1);\r\ngoto issue;\r\n}\r\nhost_clock = be32_to_cpup(property_p);\r\nclk_div = (host_clock / (MAX_MDIO_FREQ * 2)) - 1;\r\nif (host_clock % (MAX_MDIO_FREQ * 2))\r\nclk_div++;\r\nprintk(KERN_DEBUG "%s(): Setting MDIO clock divisor to %u based "\r\n"on %u Hz host clock.\n", __func__, clk_div, host_clock);\r\nof_node_put(np1);\r\nissue:\r\naxienet_iow(lp, XAE_MDIO_MC_OFFSET,\r\n(((u32) clk_div) | XAE_MDIO_MC_MDIOEN_MASK));\r\nret = axienet_mdio_wait_until_ready(lp);\r\nif (ret < 0)\r\nreturn ret;\r\nbus = mdiobus_alloc();\r\nif (!bus)\r\nreturn -ENOMEM;\r\nnp1 = of_get_parent(lp->phy_node);\r\nof_address_to_resource(np1, 0, &res);\r\nsnprintf(bus->id, MII_BUS_ID_SIZE, "%.8llx",\r\n(unsigned long long) res.start);\r\nbus->priv = lp;\r\nbus->name = "Xilinx Axi Ethernet MDIO";\r\nbus->read = axienet_mdio_read;\r\nbus->write = axienet_mdio_write;\r\nbus->parent = lp->dev;\r\nbus->irq = lp->mdio_irqs;\r\nlp->mii_bus = bus;\r\nret = of_mdiobus_register(bus, np1);\r\nif (ret) {\r\nmdiobus_free(bus);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nvoid axienet_mdio_teardown(struct axienet_local *lp)\r\n{\r\nmdiobus_unregister(lp->mii_bus);\r\nkfree(lp->mii_bus->irq);\r\nmdiobus_free(lp->mii_bus);\r\nlp->mii_bus = NULL;\r\n}

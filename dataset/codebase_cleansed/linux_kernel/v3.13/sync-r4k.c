void synchronise_count_master(int cpu)\r\n{\r\nint i;\r\nunsigned long flags;\r\nunsigned int initcount;\r\n#ifdef CONFIG_MIPS_MT_SMTC\r\nreturn;\r\n#endif\r\nprintk(KERN_INFO "Synchronize counters for CPU %u: ", cpu);\r\nlocal_irq_save(flags);\r\natomic_set(&count_reference, read_c0_count());\r\natomic_set(&count_start_flag, cpu);\r\nsmp_wmb();\r\ninitcount = read_c0_count();\r\nfor (i = 0; i < NR_LOOPS; i++) {\r\nwhile (atomic_read(&count_count_start) != 1)\r\nmb();\r\natomic_set(&count_count_stop, 0);\r\nsmp_wmb();\r\natomic_inc(&count_count_start);\r\nif (i == NR_LOOPS-1)\r\nwrite_c0_count(initcount);\r\nwhile (atomic_read(&count_count_stop) != 1)\r\nmb();\r\natomic_set(&count_count_start, 0);\r\nsmp_wmb();\r\natomic_inc(&count_count_stop);\r\n}\r\nwrite_c0_compare(read_c0_count() + COUNTON);\r\natomic_set(&count_start_flag, 0);\r\nlocal_irq_restore(flags);\r\nprintk("done.\n");\r\n}\r\nvoid synchronise_count_slave(int cpu)\r\n{\r\nint i;\r\nunsigned int initcount;\r\n#ifdef CONFIG_MIPS_MT_SMTC\r\nreturn;\r\n#endif\r\nwhile (atomic_read(&count_start_flag) != cpu)\r\nmb();\r\ninitcount = atomic_read(&count_reference);\r\nfor (i = 0; i < NR_LOOPS; i++) {\r\natomic_inc(&count_count_start);\r\nwhile (atomic_read(&count_count_start) != 2)\r\nmb();\r\nif (i == NR_LOOPS-1)\r\nwrite_c0_count(initcount);\r\natomic_inc(&count_count_stop);\r\nwhile (atomic_read(&count_count_stop) != 2)\r\nmb();\r\n}\r\nwrite_c0_compare(read_c0_count() + COUNTON);\r\n}

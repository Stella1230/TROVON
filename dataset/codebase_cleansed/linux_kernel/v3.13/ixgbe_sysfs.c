static ssize_t ixgbe_hwmon_show_location(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct hwmon_attr *ixgbe_attr = container_of(attr, struct hwmon_attr,\r\ndev_attr);\r\nreturn sprintf(buf, "loc%u\n",\r\nixgbe_attr->sensor->location);\r\n}\r\nstatic ssize_t ixgbe_hwmon_show_temp(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct hwmon_attr *ixgbe_attr = container_of(attr, struct hwmon_attr,\r\ndev_attr);\r\nunsigned int value;\r\nixgbe_attr->hw->mac.ops.get_thermal_sensor_data(ixgbe_attr->hw);\r\nvalue = ixgbe_attr->sensor->temp;\r\nvalue *= 1000;\r\nreturn sprintf(buf, "%u\n", value);\r\n}\r\nstatic ssize_t ixgbe_hwmon_show_cautionthresh(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct hwmon_attr *ixgbe_attr = container_of(attr, struct hwmon_attr,\r\ndev_attr);\r\nunsigned int value = ixgbe_attr->sensor->caution_thresh;\r\nvalue *= 1000;\r\nreturn sprintf(buf, "%u\n", value);\r\n}\r\nstatic ssize_t ixgbe_hwmon_show_maxopthresh(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct hwmon_attr *ixgbe_attr = container_of(attr, struct hwmon_attr,\r\ndev_attr);\r\nunsigned int value = ixgbe_attr->sensor->max_op_thresh;\r\nvalue *= 1000;\r\nreturn sprintf(buf, "%u\n", value);\r\n}\r\nstatic int ixgbe_add_hwmon_attr(struct ixgbe_adapter *adapter,\r\nunsigned int offset, int type) {\r\nint rc;\r\nunsigned int n_attr;\r\nstruct hwmon_attr *ixgbe_attr;\r\nn_attr = adapter->ixgbe_hwmon_buff.n_hwmon;\r\nixgbe_attr = &adapter->ixgbe_hwmon_buff.hwmon_list[n_attr];\r\nswitch (type) {\r\ncase IXGBE_HWMON_TYPE_LOC:\r\nixgbe_attr->dev_attr.show = ixgbe_hwmon_show_location;\r\nsnprintf(ixgbe_attr->name, sizeof(ixgbe_attr->name),\r\n"temp%u_label", offset);\r\nbreak;\r\ncase IXGBE_HWMON_TYPE_TEMP:\r\nixgbe_attr->dev_attr.show = ixgbe_hwmon_show_temp;\r\nsnprintf(ixgbe_attr->name, sizeof(ixgbe_attr->name),\r\n"temp%u_input", offset);\r\nbreak;\r\ncase IXGBE_HWMON_TYPE_CAUTION:\r\nixgbe_attr->dev_attr.show = ixgbe_hwmon_show_cautionthresh;\r\nsnprintf(ixgbe_attr->name, sizeof(ixgbe_attr->name),\r\n"temp%u_max", offset);\r\nbreak;\r\ncase IXGBE_HWMON_TYPE_MAX:\r\nixgbe_attr->dev_attr.show = ixgbe_hwmon_show_maxopthresh;\r\nsnprintf(ixgbe_attr->name, sizeof(ixgbe_attr->name),\r\n"temp%u_crit", offset);\r\nbreak;\r\ndefault:\r\nrc = -EPERM;\r\nreturn rc;\r\n}\r\nixgbe_attr->sensor =\r\n&adapter->hw.mac.thermal_sensor_data.sensor[offset];\r\nixgbe_attr->hw = &adapter->hw;\r\nixgbe_attr->dev_attr.store = NULL;\r\nixgbe_attr->dev_attr.attr.mode = S_IRUGO;\r\nixgbe_attr->dev_attr.attr.name = ixgbe_attr->name;\r\nrc = device_create_file(&adapter->pdev->dev,\r\n&ixgbe_attr->dev_attr);\r\nif (rc == 0)\r\n++adapter->ixgbe_hwmon_buff.n_hwmon;\r\nreturn rc;\r\n}\r\nstatic void ixgbe_sysfs_del_adapter(struct ixgbe_adapter *adapter)\r\n{\r\nint i;\r\nif (adapter == NULL)\r\nreturn;\r\nfor (i = 0; i < adapter->ixgbe_hwmon_buff.n_hwmon; i++) {\r\ndevice_remove_file(&adapter->pdev->dev,\r\n&adapter->ixgbe_hwmon_buff.hwmon_list[i].dev_attr);\r\n}\r\nkfree(adapter->ixgbe_hwmon_buff.hwmon_list);\r\nif (adapter->ixgbe_hwmon_buff.device)\r\nhwmon_device_unregister(adapter->ixgbe_hwmon_buff.device);\r\n}\r\nvoid ixgbe_sysfs_exit(struct ixgbe_adapter *adapter)\r\n{\r\nixgbe_sysfs_del_adapter(adapter);\r\n}\r\nint ixgbe_sysfs_init(struct ixgbe_adapter *adapter)\r\n{\r\nstruct hwmon_buff *ixgbe_hwmon = &adapter->ixgbe_hwmon_buff;\r\nunsigned int i;\r\nint n_attrs;\r\nint rc = 0;\r\nif (adapter->hw.mac.ops.init_thermal_sensor_thresh == NULL) {\r\ngoto exit;\r\n}\r\nif (adapter->hw.mac.ops.init_thermal_sensor_thresh(&adapter->hw))\r\ngoto exit;\r\nn_attrs = IXGBE_MAX_SENSORS * 4;\r\nixgbe_hwmon->hwmon_list = kcalloc(n_attrs, sizeof(struct hwmon_attr),\r\nGFP_KERNEL);\r\nif (!ixgbe_hwmon->hwmon_list) {\r\nrc = -ENOMEM;\r\ngoto err;\r\n}\r\nixgbe_hwmon->device = hwmon_device_register(&adapter->pdev->dev);\r\nif (IS_ERR(ixgbe_hwmon->device)) {\r\nrc = PTR_ERR(ixgbe_hwmon->device);\r\ngoto err;\r\n}\r\nfor (i = 0; i < IXGBE_MAX_SENSORS; i++) {\r\nif (adapter->hw.mac.thermal_sensor_data.sensor[i].location == 0)\r\ncontinue;\r\nrc = ixgbe_add_hwmon_attr(adapter, i, IXGBE_HWMON_TYPE_CAUTION);\r\nrc |= ixgbe_add_hwmon_attr(adapter, i, IXGBE_HWMON_TYPE_LOC);\r\nrc |= ixgbe_add_hwmon_attr(adapter, i, IXGBE_HWMON_TYPE_TEMP);\r\nrc |= ixgbe_add_hwmon_attr(adapter, i, IXGBE_HWMON_TYPE_MAX);\r\nif (rc)\r\ngoto err;\r\n}\r\ngoto exit;\r\nerr:\r\nixgbe_sysfs_del_adapter(adapter);\r\nexit:\r\nreturn rc;\r\n}

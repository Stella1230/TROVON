static void octeon_l2c_poll_oct1(struct edac_device_ctl_info *l2c)\r\n{\r\nunion cvmx_l2t_err l2t_err, l2t_err_reset;\r\nunion cvmx_l2d_err l2d_err, l2d_err_reset;\r\nl2t_err_reset.u64 = 0;\r\nl2t_err.u64 = cvmx_read_csr(CVMX_L2T_ERR);\r\nif (l2t_err.s.sec_err) {\r\nedac_device_handle_ce(l2c, 0, 0,\r\n"Tag Single bit error (corrected)");\r\nl2t_err_reset.s.sec_err = 1;\r\n}\r\nif (l2t_err.s.ded_err) {\r\nedac_device_handle_ue(l2c, 0, 0,\r\n"Tag Double bit error (detected)");\r\nl2t_err_reset.s.ded_err = 1;\r\n}\r\nif (l2t_err_reset.u64)\r\ncvmx_write_csr(CVMX_L2T_ERR, l2t_err_reset.u64);\r\nl2d_err_reset.u64 = 0;\r\nl2d_err.u64 = cvmx_read_csr(CVMX_L2D_ERR);\r\nif (l2d_err.s.sec_err) {\r\nedac_device_handle_ce(l2c, 0, 1,\r\n"Data Single bit error (corrected)");\r\nl2d_err_reset.s.sec_err = 1;\r\n}\r\nif (l2d_err.s.ded_err) {\r\nedac_device_handle_ue(l2c, 0, 1,\r\n"Data Double bit error (detected)");\r\nl2d_err_reset.s.ded_err = 1;\r\n}\r\nif (l2d_err_reset.u64)\r\ncvmx_write_csr(CVMX_L2D_ERR, l2d_err_reset.u64);\r\n}\r\nstatic void _octeon_l2c_poll_oct2(struct edac_device_ctl_info *l2c, int tad)\r\n{\r\nunion cvmx_l2c_err_tdtx err_tdtx, err_tdtx_reset;\r\nunion cvmx_l2c_err_ttgx err_ttgx, err_ttgx_reset;\r\nchar buf1[64];\r\nchar buf2[80];\r\nerr_tdtx_reset.u64 = 0;\r\nerr_tdtx.u64 = cvmx_read_csr(CVMX_L2C_ERR_TDTX(tad));\r\nif (err_tdtx.s.dbe || err_tdtx.s.sbe ||\r\nerr_tdtx.s.vdbe || err_tdtx.s.vsbe)\r\nsnprintf(buf1, sizeof(buf1),\r\n"type:%d, syn:0x%x, way:%d",\r\nerr_tdtx.s.type, err_tdtx.s.syn, err_tdtx.s.wayidx);\r\nif (err_tdtx.s.dbe) {\r\nsnprintf(buf2, sizeof(buf2),\r\n"L2D Double bit error (detected):%s", buf1);\r\nerr_tdtx_reset.s.dbe = 1;\r\nedac_device_handle_ue(l2c, tad, 1, buf2);\r\n}\r\nif (err_tdtx.s.sbe) {\r\nsnprintf(buf2, sizeof(buf2),\r\n"L2D Single bit error (corrected):%s", buf1);\r\nerr_tdtx_reset.s.sbe = 1;\r\nedac_device_handle_ce(l2c, tad, 1, buf2);\r\n}\r\nif (err_tdtx.s.vdbe) {\r\nsnprintf(buf2, sizeof(buf2),\r\n"VBF Double bit error (detected):%s", buf1);\r\nerr_tdtx_reset.s.vdbe = 1;\r\nedac_device_handle_ue(l2c, tad, 1, buf2);\r\n}\r\nif (err_tdtx.s.vsbe) {\r\nsnprintf(buf2, sizeof(buf2),\r\n"VBF Single bit error (corrected):%s", buf1);\r\nerr_tdtx_reset.s.vsbe = 1;\r\nedac_device_handle_ce(l2c, tad, 1, buf2);\r\n}\r\nif (err_tdtx_reset.u64)\r\ncvmx_write_csr(CVMX_L2C_ERR_TDTX(tad), err_tdtx_reset.u64);\r\nerr_ttgx_reset.u64 = 0;\r\nerr_ttgx.u64 = cvmx_read_csr(CVMX_L2C_ERR_TTGX(tad));\r\nif (err_ttgx.s.dbe || err_ttgx.s.sbe)\r\nsnprintf(buf1, sizeof(buf1),\r\n"type:%d, syn:0x%x, way:%d",\r\nerr_ttgx.s.type, err_ttgx.s.syn, err_ttgx.s.wayidx);\r\nif (err_ttgx.s.dbe) {\r\nsnprintf(buf2, sizeof(buf2),\r\n"Tag Double bit error (detected):%s", buf1);\r\nerr_ttgx_reset.s.dbe = 1;\r\nedac_device_handle_ue(l2c, tad, 0, buf2);\r\n}\r\nif (err_ttgx.s.sbe) {\r\nsnprintf(buf2, sizeof(buf2),\r\n"Tag Single bit error (corrected):%s", buf1);\r\nerr_ttgx_reset.s.sbe = 1;\r\nedac_device_handle_ce(l2c, tad, 0, buf2);\r\n}\r\nif (err_ttgx_reset.u64)\r\ncvmx_write_csr(CVMX_L2C_ERR_TTGX(tad), err_ttgx_reset.u64);\r\n}\r\nstatic void octeon_l2c_poll_oct2(struct edac_device_ctl_info *l2c)\r\n{\r\nint i;\r\nfor (i = 0; i < l2c->nr_instances; i++)\r\n_octeon_l2c_poll_oct2(l2c, i);\r\n}\r\nstatic int octeon_l2c_probe(struct platform_device *pdev)\r\n{\r\nstruct edac_device_ctl_info *l2c;\r\nint num_tads = OCTEON_IS_MODEL(OCTEON_CN68XX) ? 4 : 1;\r\nl2c = edac_device_alloc_ctl_info(0, "l2c", num_tads, "l2c", 2, 0,\r\nNULL, 0, edac_device_alloc_index());\r\nif (!l2c)\r\nreturn -ENOMEM;\r\nl2c->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, l2c);\r\nl2c->dev_name = dev_name(&pdev->dev);\r\nl2c->mod_name = "octeon-l2c";\r\nl2c->ctl_name = "octeon_l2c_err";\r\nif (OCTEON_IS_MODEL(OCTEON_FAM_1_PLUS)) {\r\nunion cvmx_l2t_err l2t_err;\r\nunion cvmx_l2d_err l2d_err;\r\nl2t_err.u64 = cvmx_read_csr(CVMX_L2T_ERR);\r\nl2t_err.s.sec_intena = 0;\r\nl2t_err.s.ded_intena = 0;\r\ncvmx_write_csr(CVMX_L2T_ERR, l2t_err.u64);\r\nl2d_err.u64 = cvmx_read_csr(CVMX_L2D_ERR);\r\nl2d_err.s.sec_intena = 0;\r\nl2d_err.s.ded_intena = 0;\r\ncvmx_write_csr(CVMX_L2T_ERR, l2d_err.u64);\r\nl2c->edac_check = octeon_l2c_poll_oct1;\r\n} else {\r\nl2c->edac_check = octeon_l2c_poll_oct2;\r\n}\r\nif (edac_device_add_device(l2c) > 0) {\r\npr_err("%s: edac_device_add_device() failed\n", __func__);\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\nedac_device_free_ctl_info(l2c);\r\nreturn -ENXIO;\r\n}\r\nstatic int octeon_l2c_remove(struct platform_device *pdev)\r\n{\r\nstruct edac_device_ctl_info *l2c = platform_get_drvdata(pdev);\r\nedac_device_del_device(&pdev->dev);\r\nedac_device_free_ctl_info(l2c);\r\nreturn 0;\r\n}

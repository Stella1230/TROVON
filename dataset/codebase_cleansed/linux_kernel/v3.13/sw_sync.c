static int sw_sync_cmp(u32 a, u32 b)\r\n{\r\nif (a == b)\r\nreturn 0;\r\nreturn ((s32)a - (s32)b) < 0 ? -1 : 1;\r\n}\r\nstruct sync_pt *sw_sync_pt_create(struct sw_sync_timeline *obj, u32 value)\r\n{\r\nstruct sw_sync_pt *pt;\r\npt = (struct sw_sync_pt *)\r\nsync_pt_create(&obj->obj, sizeof(struct sw_sync_pt));\r\npt->value = value;\r\nreturn (struct sync_pt *)pt;\r\n}\r\nstatic struct sync_pt *sw_sync_pt_dup(struct sync_pt *sync_pt)\r\n{\r\nstruct sw_sync_pt *pt = (struct sw_sync_pt *) sync_pt;\r\nstruct sw_sync_timeline *obj =\r\n(struct sw_sync_timeline *)sync_pt->parent;\r\nreturn (struct sync_pt *) sw_sync_pt_create(obj, pt->value);\r\n}\r\nstatic int sw_sync_pt_has_signaled(struct sync_pt *sync_pt)\r\n{\r\nstruct sw_sync_pt *pt = (struct sw_sync_pt *)sync_pt;\r\nstruct sw_sync_timeline *obj =\r\n(struct sw_sync_timeline *)sync_pt->parent;\r\nreturn sw_sync_cmp(obj->value, pt->value) >= 0;\r\n}\r\nstatic int sw_sync_pt_compare(struct sync_pt *a, struct sync_pt *b)\r\n{\r\nstruct sw_sync_pt *pt_a = (struct sw_sync_pt *)a;\r\nstruct sw_sync_pt *pt_b = (struct sw_sync_pt *)b;\r\nreturn sw_sync_cmp(pt_a->value, pt_b->value);\r\n}\r\nstatic int sw_sync_fill_driver_data(struct sync_pt *sync_pt,\r\nvoid *data, int size)\r\n{\r\nstruct sw_sync_pt *pt = (struct sw_sync_pt *)sync_pt;\r\nif (size < sizeof(pt->value))\r\nreturn -ENOMEM;\r\nmemcpy(data, &pt->value, sizeof(pt->value));\r\nreturn sizeof(pt->value);\r\n}\r\nstatic void sw_sync_timeline_value_str(struct sync_timeline *sync_timeline,\r\nchar *str, int size)\r\n{\r\nstruct sw_sync_timeline *timeline =\r\n(struct sw_sync_timeline *)sync_timeline;\r\nsnprintf(str, size, "%d", timeline->value);\r\n}\r\nstatic void sw_sync_pt_value_str(struct sync_pt *sync_pt,\r\nchar *str, int size)\r\n{\r\nstruct sw_sync_pt *pt = (struct sw_sync_pt *)sync_pt;\r\nsnprintf(str, size, "%d", pt->value);\r\n}\r\nstruct sw_sync_timeline *sw_sync_timeline_create(const char *name)\r\n{\r\nstruct sw_sync_timeline *obj = (struct sw_sync_timeline *)\r\nsync_timeline_create(&sw_sync_timeline_ops,\r\nsizeof(struct sw_sync_timeline),\r\nname);\r\nreturn obj;\r\n}\r\nvoid sw_sync_timeline_inc(struct sw_sync_timeline *obj, u32 inc)\r\n{\r\nobj->value += inc;\r\nsync_timeline_signal(&obj->obj);\r\n}\r\nstatic int sw_sync_open(struct inode *inode, struct file *file)\r\n{\r\nstruct sw_sync_timeline *obj;\r\nchar task_comm[TASK_COMM_LEN];\r\nget_task_comm(task_comm, current);\r\nobj = sw_sync_timeline_create(task_comm);\r\nif (obj == NULL)\r\nreturn -ENOMEM;\r\nfile->private_data = obj;\r\nreturn 0;\r\n}\r\nstatic int sw_sync_release(struct inode *inode, struct file *file)\r\n{\r\nstruct sw_sync_timeline *obj = file->private_data;\r\nsync_timeline_destroy(&obj->obj);\r\nreturn 0;\r\n}\r\nstatic long sw_sync_ioctl_create_fence(struct sw_sync_timeline *obj,\r\nunsigned long arg)\r\n{\r\nint fd = get_unused_fd_flags(O_CLOEXEC);\r\nint err;\r\nstruct sync_pt *pt;\r\nstruct sync_fence *fence;\r\nstruct sw_sync_create_fence_data data;\r\nif (fd < 0)\r\nreturn fd;\r\nif (copy_from_user(&data, (void __user *)arg, sizeof(data))) {\r\nerr = -EFAULT;\r\ngoto err;\r\n}\r\npt = sw_sync_pt_create(obj, data.value);\r\nif (pt == NULL) {\r\nerr = -ENOMEM;\r\ngoto err;\r\n}\r\ndata.name[sizeof(data.name) - 1] = '\0';\r\nfence = sync_fence_create(data.name, pt);\r\nif (fence == NULL) {\r\nsync_pt_free(pt);\r\nerr = -ENOMEM;\r\ngoto err;\r\n}\r\ndata.fence = fd;\r\nif (copy_to_user((void __user *)arg, &data, sizeof(data))) {\r\nsync_fence_put(fence);\r\nerr = -EFAULT;\r\ngoto err;\r\n}\r\nsync_fence_install(fence, fd);\r\nreturn 0;\r\nerr:\r\nput_unused_fd(fd);\r\nreturn err;\r\n}\r\nstatic long sw_sync_ioctl_inc(struct sw_sync_timeline *obj, unsigned long arg)\r\n{\r\nu32 value;\r\nif (copy_from_user(&value, (void __user *)arg, sizeof(value)))\r\nreturn -EFAULT;\r\nsw_sync_timeline_inc(obj, value);\r\nreturn 0;\r\n}\r\nstatic long sw_sync_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nstruct sw_sync_timeline *obj = file->private_data;\r\nswitch (cmd) {\r\ncase SW_SYNC_IOC_CREATE_FENCE:\r\nreturn sw_sync_ioctl_create_fence(obj, arg);\r\ncase SW_SYNC_IOC_INC:\r\nreturn sw_sync_ioctl_inc(obj, arg);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\n}\r\nstatic int __init sw_sync_device_init(void)\r\n{\r\nreturn misc_register(&sw_sync_dev);\r\n}\r\nstatic void __exit sw_sync_device_remove(void)\r\n{\r\nmisc_deregister(&sw_sync_dev);\r\n}

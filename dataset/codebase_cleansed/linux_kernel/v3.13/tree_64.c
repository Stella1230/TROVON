static phandle prom_node_to_node(const char *type, phandle node)\r\n{\r\nunsigned long args[5];\r\nargs[0] = (unsigned long) type;\r\nargs[1] = 1;\r\nargs[2] = 1;\r\nargs[3] = (unsigned int) node;\r\nargs[4] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nreturn (phandle) args[4];\r\n}\r\ninline phandle __prom_getchild(phandle node)\r\n{\r\nreturn prom_node_to_node("child", node);\r\n}\r\nphandle prom_getchild(phandle node)\r\n{\r\nphandle cnode;\r\nif ((s32)node == -1)\r\nreturn 0;\r\ncnode = __prom_getchild(node);\r\nif ((s32)cnode == -1)\r\nreturn 0;\r\nreturn cnode;\r\n}\r\ninline phandle prom_getparent(phandle node)\r\n{\r\nphandle cnode;\r\nif ((s32)node == -1)\r\nreturn 0;\r\ncnode = prom_node_to_node("parent", node);\r\nif ((s32)cnode == -1)\r\nreturn 0;\r\nreturn cnode;\r\n}\r\ninline phandle __prom_getsibling(phandle node)\r\n{\r\nreturn prom_node_to_node(prom_peer_name, node);\r\n}\r\nphandle prom_getsibling(phandle node)\r\n{\r\nphandle sibnode;\r\nif ((s32)node == -1)\r\nreturn 0;\r\nsibnode = __prom_getsibling(node);\r\nif ((s32)sibnode == -1)\r\nreturn 0;\r\nreturn sibnode;\r\n}\r\nint prom_getproplen(phandle node, const char *prop)\r\n{\r\nunsigned long args[6];\r\nif (!node || !prop)\r\nreturn -1;\r\nargs[0] = (unsigned long) "getproplen";\r\nargs[1] = 2;\r\nargs[2] = 1;\r\nargs[3] = (unsigned int) node;\r\nargs[4] = (unsigned long) prop;\r\nargs[5] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nreturn (int) args[5];\r\n}\r\nint prom_getproperty(phandle node, const char *prop,\r\nchar *buffer, int bufsize)\r\n{\r\nunsigned long args[8];\r\nint plen;\r\nplen = prom_getproplen(node, prop);\r\nif ((plen > bufsize) || (plen == 0) || (plen == -1))\r\nreturn -1;\r\nargs[0] = (unsigned long) prom_getprop_name;\r\nargs[1] = 4;\r\nargs[2] = 1;\r\nargs[3] = (unsigned int) node;\r\nargs[4] = (unsigned long) prop;\r\nargs[5] = (unsigned long) buffer;\r\nargs[6] = bufsize;\r\nargs[7] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nreturn (int) args[7];\r\n}\r\nint prom_getint(phandle node, const char *prop)\r\n{\r\nint intprop;\r\nif (prom_getproperty(node, prop, (char *) &intprop, sizeof(int)) != -1)\r\nreturn intprop;\r\nreturn -1;\r\n}\r\nint prom_getintdefault(phandle node, const char *property, int deflt)\r\n{\r\nint retval;\r\nretval = prom_getint(node, property);\r\nif (retval == -1)\r\nreturn deflt;\r\nreturn retval;\r\n}\r\nint prom_getbool(phandle node, const char *prop)\r\n{\r\nint retval;\r\nretval = prom_getproplen(node, prop);\r\nif (retval == -1)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nvoid prom_getstring(phandle node, const char *prop, char *user_buf,\r\nint ubuf_size)\r\n{\r\nint len;\r\nlen = prom_getproperty(node, prop, user_buf, ubuf_size);\r\nif (len != -1)\r\nreturn;\r\nuser_buf[0] = 0;\r\n}\r\nint prom_nodematch(phandle node, const char *name)\r\n{\r\nchar namebuf[128];\r\nprom_getproperty(node, "name", namebuf, sizeof(namebuf));\r\nif (strcmp(namebuf, name) == 0)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nphandle prom_searchsiblings(phandle node_start, const char *nodename)\r\n{\r\nphandle thisnode;\r\nint error;\r\nchar promlib_buf[128];\r\nfor(thisnode = node_start; thisnode;\r\nthisnode=prom_getsibling(thisnode)) {\r\nerror = prom_getproperty(thisnode, "name", promlib_buf,\r\nsizeof(promlib_buf));\r\nif(error == -1) continue;\r\nif(strcmp(nodename, promlib_buf)==0) return thisnode;\r\n}\r\nreturn 0;\r\n}\r\nchar *prom_firstprop(phandle node, char *buffer)\r\n{\r\nunsigned long args[7];\r\n*buffer = 0;\r\nif ((s32)node == -1)\r\nreturn buffer;\r\nargs[0] = (unsigned long) prom_nextprop_name;\r\nargs[1] = 3;\r\nargs[2] = 1;\r\nargs[3] = (unsigned int) node;\r\nargs[4] = 0;\r\nargs[5] = (unsigned long) buffer;\r\nargs[6] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nreturn buffer;\r\n}\r\nchar *prom_nextprop(phandle node, const char *oprop, char *buffer)\r\n{\r\nunsigned long args[7];\r\nchar buf[32];\r\nif ((s32)node == -1) {\r\n*buffer = 0;\r\nreturn buffer;\r\n}\r\nif (oprop == buffer) {\r\nstrcpy (buf, oprop);\r\noprop = buf;\r\n}\r\nargs[0] = (unsigned long) prom_nextprop_name;\r\nargs[1] = 3;\r\nargs[2] = 1;\r\nargs[3] = (unsigned int) node;\r\nargs[4] = (unsigned long) oprop;\r\nargs[5] = (unsigned long) buffer;\r\nargs[6] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nreturn buffer;\r\n}\r\nphandle prom_finddevice(const char *name)\r\n{\r\nunsigned long args[5];\r\nif (!name)\r\nreturn 0;\r\nargs[0] = (unsigned long) "finddevice";\r\nargs[1] = 1;\r\nargs[2] = 1;\r\nargs[3] = (unsigned long) name;\r\nargs[4] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nreturn (int) args[4];\r\n}\r\nint prom_node_has_property(phandle node, const char *prop)\r\n{\r\nchar buf [32];\r\n*buf = 0;\r\ndo {\r\nprom_nextprop(node, buf, buf);\r\nif (!strcmp(buf, prop))\r\nreturn 1;\r\n} while (*buf);\r\nreturn 0;\r\n}\r\nint\r\nprom_setprop(phandle node, const char *pname, char *value, int size)\r\n{\r\nunsigned long args[8];\r\nif (size == 0)\r\nreturn 0;\r\nif ((pname == 0) || (value == 0))\r\nreturn 0;\r\n#ifdef CONFIG_SUN_LDOMS\r\nif (ldom_domaining_enabled) {\r\nldom_set_var(pname, value);\r\nreturn 0;\r\n}\r\n#endif\r\nargs[0] = (unsigned long) "setprop";\r\nargs[1] = 4;\r\nargs[2] = 1;\r\nargs[3] = (unsigned int) node;\r\nargs[4] = (unsigned long) pname;\r\nargs[5] = (unsigned long) value;\r\nargs[6] = size;\r\nargs[7] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nreturn (int) args[7];\r\n}\r\ninline phandle prom_inst2pkg(int inst)\r\n{\r\nunsigned long args[5];\r\nphandle node;\r\nargs[0] = (unsigned long) "instance-to-package";\r\nargs[1] = 1;\r\nargs[2] = 1;\r\nargs[3] = (unsigned int) inst;\r\nargs[4] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nnode = (int) args[4];\r\nif ((s32)node == -1)\r\nreturn 0;\r\nreturn node;\r\n}\r\nint prom_ihandle2path(int handle, char *buffer, int bufsize)\r\n{\r\nunsigned long args[7];\r\nargs[0] = (unsigned long) "instance-to-path";\r\nargs[1] = 3;\r\nargs[2] = 1;\r\nargs[3] = (unsigned int) handle;\r\nargs[4] = (unsigned long) buffer;\r\nargs[5] = bufsize;\r\nargs[6] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nreturn (int) args[6];\r\n}

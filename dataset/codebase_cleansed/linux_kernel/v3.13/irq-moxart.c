static asmlinkage void __exception_irq_entry handle_irq(struct pt_regs *regs)\r\n{\r\nu32 irqstat;\r\nint hwirq;\r\nirqstat = readl(intc.base + IRQ_STATUS_REG);\r\nwhile (irqstat) {\r\nhwirq = ffs(irqstat) - 1;\r\nhandle_IRQ(irq_linear_revmap(intc.domain, hwirq), regs);\r\nirqstat &= ~(1 << hwirq);\r\n}\r\n}\r\nstatic int __init moxart_of_intc_init(struct device_node *node,\r\nstruct device_node *parent)\r\n{\r\nunsigned int clr = IRQ_NOREQUEST | IRQ_NOPROBE | IRQ_NOAUTOEN;\r\nint ret;\r\nstruct irq_chip_generic *gc;\r\nintc.base = of_iomap(node, 0);\r\nif (!intc.base) {\r\npr_err("%s: unable to map IC registers\n",\r\nnode->full_name);\r\nreturn -EINVAL;\r\n}\r\nintc.domain = irq_domain_add_linear(node, 32, &irq_generic_chip_ops,\r\nintc.base);\r\nif (!intc.domain) {\r\npr_err("%s: unable to create IRQ domain\n", node->full_name);\r\nreturn -EINVAL;\r\n}\r\nret = irq_alloc_domain_generic_chips(intc.domain, 32, 1,\r\n"MOXARTINTC", handle_edge_irq,\r\nclr, 0, IRQ_GC_INIT_MASK_CACHE);\r\nif (ret) {\r\npr_err("%s: could not allocate generic chip\n",\r\nnode->full_name);\r\nirq_domain_remove(intc.domain);\r\nreturn -EINVAL;\r\n}\r\nret = of_property_read_u32(node, "interrupt-mask",\r\n&intc.interrupt_mask);\r\nif (ret)\r\npr_err("%s: could not read interrupt-mask DT property\n",\r\nnode->full_name);\r\ngc = irq_get_domain_generic_chip(intc.domain, 0);\r\ngc->reg_base = intc.base;\r\ngc->chip_types[0].regs.mask = IRQ_MASK_REG;\r\ngc->chip_types[0].regs.ack = IRQ_CLEAR_REG;\r\ngc->chip_types[0].chip.irq_ack = irq_gc_ack_set_bit;\r\ngc->chip_types[0].chip.irq_mask = irq_gc_mask_clr_bit;\r\ngc->chip_types[0].chip.irq_unmask = irq_gc_mask_set_bit;\r\nwritel(0, intc.base + IRQ_MASK_REG);\r\nwritel(0xffffffff, intc.base + IRQ_CLEAR_REG);\r\nwritel(intc.interrupt_mask, intc.base + IRQ_MODE_REG);\r\nwritel(intc.interrupt_mask, intc.base + IRQ_LEVEL_REG);\r\nset_handle_irq(handle_irq);\r\nreturn 0;\r\n}

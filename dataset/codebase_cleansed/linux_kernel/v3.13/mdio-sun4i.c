static int sun4i_mdio_read(struct mii_bus *bus, int mii_id, int regnum)\r\n{\r\nstruct sun4i_mdio_data *data = bus->priv;\r\nunsigned long timeout_jiffies;\r\nint value;\r\nwritel((mii_id << 8) | regnum, data->membase + EMAC_MAC_MADR_REG);\r\nwritel(0x1, data->membase + EMAC_MAC_MCMD_REG);\r\ntimeout_jiffies = jiffies + MDIO_TIMEOUT;\r\nwhile (readl(data->membase + EMAC_MAC_MIND_REG) & 0x1) {\r\nif (time_is_before_jiffies(timeout_jiffies))\r\nreturn -ETIMEDOUT;\r\nmsleep(1);\r\n}\r\nwritel(0x0, data->membase + EMAC_MAC_MCMD_REG);\r\nvalue = readl(data->membase + EMAC_MAC_MRDD_REG);\r\nreturn value;\r\n}\r\nstatic int sun4i_mdio_write(struct mii_bus *bus, int mii_id, int regnum,\r\nu16 value)\r\n{\r\nstruct sun4i_mdio_data *data = bus->priv;\r\nunsigned long timeout_jiffies;\r\nwritel((mii_id << 8) | regnum, data->membase + EMAC_MAC_MADR_REG);\r\nwritel(0x1, data->membase + EMAC_MAC_MCMD_REG);\r\ntimeout_jiffies = jiffies + MDIO_TIMEOUT;\r\nwhile (readl(data->membase + EMAC_MAC_MIND_REG) & 0x1) {\r\nif (time_is_before_jiffies(timeout_jiffies))\r\nreturn -ETIMEDOUT;\r\nmsleep(1);\r\n}\r\nwritel(0x0, data->membase + EMAC_MAC_MCMD_REG);\r\nwritel(value, data->membase + EMAC_MAC_MWTD_REG);\r\nreturn 0;\r\n}\r\nstatic int sun4i_mdio_reset(struct mii_bus *bus)\r\n{\r\nreturn 0;\r\n}\r\nstatic int sun4i_mdio_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct mii_bus *bus;\r\nstruct sun4i_mdio_data *data;\r\nstruct resource *res;\r\nint ret, i;\r\nbus = mdiobus_alloc_size(sizeof(*data));\r\nif (!bus)\r\nreturn -ENOMEM;\r\nbus->name = "sun4i_mii_bus";\r\nbus->read = &sun4i_mdio_read;\r\nbus->write = &sun4i_mdio_write;\r\nbus->reset = &sun4i_mdio_reset;\r\nsnprintf(bus->id, MII_BUS_ID_SIZE, "%s-mii", dev_name(&pdev->dev));\r\nbus->parent = &pdev->dev;\r\nbus->irq = devm_kzalloc(&pdev->dev, sizeof(int) * PHY_MAX_ADDR,\r\nGFP_KERNEL);\r\nif (!bus->irq) {\r\nret = -ENOMEM;\r\ngoto err_out_free_mdiobus;\r\n}\r\nfor (i = 0; i < PHY_MAX_ADDR; i++)\r\nbus->irq[i] = PHY_POLL;\r\ndata = bus->priv;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndata->membase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(data->membase)) {\r\nret = PTR_ERR(data->membase);\r\ngoto err_out_free_mdiobus;\r\n}\r\ndata->regulator = devm_regulator_get(&pdev->dev, "phy");\r\nif (IS_ERR(data->regulator)) {\r\nif (PTR_ERR(data->regulator) == -EPROBE_DEFER)\r\nreturn -EPROBE_DEFER;\r\ndev_info(&pdev->dev, "no regulator found\n");\r\n} else {\r\nret = regulator_enable(data->regulator);\r\nif (ret)\r\ngoto err_out_free_mdiobus;\r\n}\r\nret = of_mdiobus_register(bus, np);\r\nif (ret < 0)\r\ngoto err_out_disable_regulator;\r\nplatform_set_drvdata(pdev, bus);\r\nreturn 0;\r\nerr_out_disable_regulator:\r\nregulator_disable(data->regulator);\r\nerr_out_free_mdiobus:\r\nmdiobus_free(bus);\r\nreturn ret;\r\n}\r\nstatic int sun4i_mdio_remove(struct platform_device *pdev)\r\n{\r\nstruct mii_bus *bus = platform_get_drvdata(pdev);\r\nmdiobus_unregister(bus);\r\nmdiobus_free(bus);\r\nreturn 0;\r\n}

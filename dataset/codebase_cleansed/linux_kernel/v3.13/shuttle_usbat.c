static void usbat_pack_ata_sector_cmd(unsigned char *buf,\r\nunsigned char thistime,\r\nu32 sector, unsigned char cmd)\r\n{\r\nbuf[0] = 0;\r\nbuf[1] = thistime;\r\nbuf[2] = sector & 0xFF;\r\nbuf[3] = (sector >> 8) & 0xFF;\r\nbuf[4] = (sector >> 16) & 0xFF;\r\nbuf[5] = 0xE0 | ((sector >> 24) & 0x0F);\r\nbuf[6] = cmd;\r\n}\r\nstatic int usbat_get_device_type(struct us_data *us)\r\n{\r\nreturn ((struct usbat_info*)us->extra)->devicetype;\r\n}\r\nstatic int usbat_read(struct us_data *us,\r\nunsigned char access,\r\nunsigned char reg,\r\nunsigned char *content)\r\n{\r\nreturn usb_stor_ctrl_transfer(us,\r\nus->recv_ctrl_pipe,\r\naccess | USBAT_CMD_READ_REG,\r\n0xC0,\r\n(u16)reg,\r\n0,\r\ncontent,\r\n1);\r\n}\r\nstatic int usbat_write(struct us_data *us,\r\nunsigned char access,\r\nunsigned char reg,\r\nunsigned char content)\r\n{\r\nreturn usb_stor_ctrl_transfer(us,\r\nus->send_ctrl_pipe,\r\naccess | USBAT_CMD_WRITE_REG,\r\n0x40,\r\nshort_pack(reg, content),\r\n0,\r\nNULL,\r\n0);\r\n}\r\nstatic int usbat_bulk_read(struct us_data *us,\r\nvoid* buf,\r\nunsigned int len,\r\nint use_sg)\r\n{\r\nif (len == 0)\r\nreturn USB_STOR_XFER_GOOD;\r\nusb_stor_dbg(us, "len = %d\n", len);\r\nreturn usb_stor_bulk_transfer_sg(us, us->recv_bulk_pipe, buf, len, use_sg, NULL);\r\n}\r\nstatic int usbat_bulk_write(struct us_data *us,\r\nvoid* buf,\r\nunsigned int len,\r\nint use_sg)\r\n{\r\nif (len == 0)\r\nreturn USB_STOR_XFER_GOOD;\r\nusb_stor_dbg(us, "len = %d\n", len);\r\nreturn usb_stor_bulk_transfer_sg(us, us->send_bulk_pipe, buf, len, use_sg, NULL);\r\n}\r\nstatic int usbat_execute_command(struct us_data *us,\r\nunsigned char *commands,\r\nunsigned int len)\r\n{\r\nreturn usb_stor_ctrl_transfer(us, us->send_ctrl_pipe,\r\nUSBAT_CMD_EXEC_CMD, 0x40, 0, 0,\r\ncommands, len);\r\n}\r\nstatic int usbat_get_status(struct us_data *us, unsigned char *status)\r\n{\r\nint rc;\r\nrc = usbat_read(us, USBAT_ATA, USBAT_ATA_STATUS, status);\r\nusb_stor_dbg(us, "0x%02X\n", *status);\r\nreturn rc;\r\n}\r\nstatic int usbat_check_status(struct us_data *us)\r\n{\r\nunsigned char *reply = us->iobuf;\r\nint rc;\r\nrc = usbat_get_status(us, reply);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\nif (*reply & 0x01 && *reply != 0x51)\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\nif (*reply & 0x20)\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int usbat_set_shuttle_features(struct us_data *us,\r\nunsigned char external_trigger,\r\nunsigned char epp_control,\r\nunsigned char mask_byte,\r\nunsigned char test_pattern,\r\nunsigned char subcountH,\r\nunsigned char subcountL)\r\n{\r\nunsigned char *command = us->iobuf;\r\ncommand[0] = 0x40;\r\ncommand[1] = USBAT_CMD_SET_FEAT;\r\ncommand[2] = epp_control;\r\ncommand[3] = external_trigger;\r\ncommand[4] = test_pattern;\r\ncommand[5] = mask_byte;\r\ncommand[6] = subcountL;\r\ncommand[7] = subcountH;\r\nreturn usbat_execute_command(us, command, 8);\r\n}\r\nstatic int usbat_wait_not_busy(struct us_data *us, int minutes)\r\n{\r\nint i;\r\nint result;\r\nunsigned char *status = us->iobuf;\r\nfor (i=0; i<1200+minutes*60; i++) {\r\nresult = usbat_get_status(us, status);\r\nif (result!=USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (*status & 0x01) {\r\nresult = usbat_read(us, USBAT_ATA, 0x10, status);\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\n}\r\nif (*status & 0x20)\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\nif ((*status & 0x80)==0x00) {\r\nusb_stor_dbg(us, "Waited not busy for %d steps\n", i);\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nif (i<500)\r\nmsleep(10);\r\nelse if (i<700)\r\nmsleep(50);\r\nelse if (i<1200)\r\nmsleep(100);\r\nelse\r\nmsleep(1000);\r\n}\r\nusb_stor_dbg(us, "Waited not busy for %d minutes, timing out\n",\r\nminutes);\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\n}\r\nstatic int usbat_read_block(struct us_data *us,\r\nvoid* buf,\r\nunsigned short len,\r\nint use_sg)\r\n{\r\nint result;\r\nunsigned char *command = us->iobuf;\r\nif (!len)\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\ncommand[0] = 0xC0;\r\ncommand[1] = USBAT_ATA | USBAT_CMD_READ_BLOCK;\r\ncommand[2] = USBAT_ATA_DATA;\r\ncommand[3] = 0;\r\ncommand[4] = 0;\r\ncommand[5] = 0;\r\ncommand[6] = LSB_of(len);\r\ncommand[7] = MSB_of(len);\r\nresult = usbat_execute_command(us, command, 8);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nresult = usbat_bulk_read(us, buf, len, use_sg);\r\nreturn (result == USB_STOR_XFER_GOOD ?\r\nUSB_STOR_TRANSPORT_GOOD : USB_STOR_TRANSPORT_ERROR);\r\n}\r\nstatic int usbat_write_block(struct us_data *us,\r\nunsigned char access,\r\nvoid* buf,\r\nunsigned short len,\r\nint minutes,\r\nint use_sg)\r\n{\r\nint result;\r\nunsigned char *command = us->iobuf;\r\nif (!len)\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\ncommand[0] = 0x40;\r\ncommand[1] = access | USBAT_CMD_WRITE_BLOCK;\r\ncommand[2] = USBAT_ATA_DATA;\r\ncommand[3] = 0;\r\ncommand[4] = 0;\r\ncommand[5] = 0;\r\ncommand[6] = LSB_of(len);\r\ncommand[7] = MSB_of(len);\r\nresult = usbat_execute_command(us, command, 8);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nresult = usbat_bulk_write(us, buf, len, use_sg);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nreturn usbat_wait_not_busy(us, minutes);\r\n}\r\nstatic int usbat_hp8200e_rw_block_test(struct us_data *us,\r\nunsigned char access,\r\nunsigned char *registers,\r\nunsigned char *data_out,\r\nunsigned short num_registers,\r\nunsigned char data_reg,\r\nunsigned char status_reg,\r\nunsigned char timeout,\r\nunsigned char qualifier,\r\nint direction,\r\nvoid *buf,\r\nunsigned short len,\r\nint use_sg,\r\nint minutes)\r\n{\r\nint result;\r\nunsigned int pipe = (direction == DMA_FROM_DEVICE) ?\r\nus->recv_bulk_pipe : us->send_bulk_pipe;\r\nunsigned char *command = us->iobuf;\r\nint i, j;\r\nint cmdlen;\r\nunsigned char *data = us->iobuf;\r\nunsigned char *status = us->iobuf;\r\nBUG_ON(num_registers > US_IOBUF_SIZE/2);\r\nfor (i=0; i<20; i++) {\r\nif (i==0) {\r\ncmdlen = 16;\r\ncommand[0] = 0x40;\r\ncommand[1] = access | USBAT_CMD_WRITE_REGS;\r\ncommand[2] = 0x07;\r\ncommand[3] = 0x17;\r\ncommand[4] = 0xFC;\r\ncommand[5] = 0xE7;\r\ncommand[6] = LSB_of(num_registers*2);\r\ncommand[7] = MSB_of(num_registers*2);\r\n} else\r\ncmdlen = 8;\r\ncommand[cmdlen-8] = (direction==DMA_TO_DEVICE ? 0x40 : 0xC0);\r\ncommand[cmdlen-7] = access |\r\n(direction==DMA_TO_DEVICE ?\r\nUSBAT_CMD_COND_WRITE_BLOCK : USBAT_CMD_COND_READ_BLOCK);\r\ncommand[cmdlen-6] = data_reg;\r\ncommand[cmdlen-5] = status_reg;\r\ncommand[cmdlen-4] = timeout;\r\ncommand[cmdlen-3] = qualifier;\r\ncommand[cmdlen-2] = LSB_of(len);\r\ncommand[cmdlen-1] = MSB_of(len);\r\nresult = usbat_execute_command(us, command, cmdlen);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (i==0) {\r\nfor (j=0; j<num_registers; j++) {\r\ndata[j<<1] = registers[j];\r\ndata[1+(j<<1)] = data_out[j];\r\n}\r\nresult = usbat_bulk_write(us, data, num_registers*2, 0);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\n}\r\nresult = usb_stor_bulk_transfer_sg(us,\r\npipe, buf, len, use_sg, NULL);\r\nif (result == USB_STOR_XFER_SHORT ||\r\nresult == USB_STOR_XFER_STALLED) {\r\nif (direction==DMA_FROM_DEVICE && i==0) {\r\nif (usb_stor_clear_halt(us,\r\nus->send_bulk_pipe) < 0)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\n}\r\nresult = usbat_read(us, USBAT_ATA,\r\ndirection==DMA_TO_DEVICE ?\r\nUSBAT_ATA_STATUS : USBAT_ATA_ALTSTATUS,\r\nstatus);\r\nif (result!=USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (*status & 0x01)\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\nif (*status & 0x20)\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\nusb_stor_dbg(us, "Redoing %s\n",\r\ndirection == DMA_TO_DEVICE\r\n? "write" : "read");\r\n} else if (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nelse\r\nreturn usbat_wait_not_busy(us, minutes);\r\n}\r\nusb_stor_dbg(us, "Bummer! %s bulk data 20 times failed\n",\r\ndirection == DMA_TO_DEVICE ? "Writing" : "Reading");\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\n}\r\nstatic int usbat_multiple_write(struct us_data *us,\r\nunsigned char *registers,\r\nunsigned char *data_out,\r\nunsigned short num_registers)\r\n{\r\nint i, result;\r\nunsigned char *data = us->iobuf;\r\nunsigned char *command = us->iobuf;\r\nBUG_ON(num_registers > US_IOBUF_SIZE/2);\r\ncommand[0] = 0x40;\r\ncommand[1] = USBAT_ATA | USBAT_CMD_WRITE_REGS;\r\ncommand[2] = 0;\r\ncommand[3] = 0;\r\ncommand[4] = 0;\r\ncommand[5] = 0;\r\ncommand[6] = LSB_of(num_registers*2);\r\ncommand[7] = MSB_of(num_registers*2);\r\nresult = usbat_execute_command(us, command, 8);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nfor (i=0; i<num_registers; i++) {\r\ndata[i<<1] = registers[i];\r\ndata[1+(i<<1)] = data_out[i];\r\n}\r\nresult = usbat_bulk_write(us, data, num_registers*2, 0);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (usbat_get_device_type(us) == USBAT_DEV_HP8200)\r\nreturn usbat_wait_not_busy(us, 0);\r\nelse\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int usbat_read_blocks(struct us_data *us,\r\nvoid* buffer,\r\nint len,\r\nint use_sg)\r\n{\r\nint result;\r\nunsigned char *command = us->iobuf;\r\ncommand[0] = 0xC0;\r\ncommand[1] = USBAT_ATA | USBAT_CMD_COND_READ_BLOCK;\r\ncommand[2] = USBAT_ATA_DATA;\r\ncommand[3] = USBAT_ATA_STATUS;\r\ncommand[4] = 0xFD;\r\ncommand[5] = USBAT_QUAL_FCQ;\r\ncommand[6] = LSB_of(len);\r\ncommand[7] = MSB_of(len);\r\nresult = usbat_execute_command(us, command, 8);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\nresult = usbat_bulk_read(us, buffer, len, use_sg);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int usbat_write_blocks(struct us_data *us,\r\nvoid* buffer,\r\nint len,\r\nint use_sg)\r\n{\r\nint result;\r\nunsigned char *command = us->iobuf;\r\ncommand[0] = 0x40;\r\ncommand[1] = USBAT_ATA | USBAT_CMD_COND_WRITE_BLOCK;\r\ncommand[2] = USBAT_ATA_DATA;\r\ncommand[3] = USBAT_ATA_STATUS;\r\ncommand[4] = 0xFD;\r\ncommand[5] = USBAT_QUAL_FCQ;\r\ncommand[6] = LSB_of(len);\r\ncommand[7] = MSB_of(len);\r\nresult = usbat_execute_command(us, command, 8);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\nresult = usbat_bulk_write(us, buffer, len, use_sg);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int usbat_read_user_io(struct us_data *us, unsigned char *data_flags)\r\n{\r\nint result;\r\nresult = usb_stor_ctrl_transfer(us,\r\nus->recv_ctrl_pipe,\r\nUSBAT_CMD_UIO,\r\n0xC0,\r\n0,\r\n0,\r\ndata_flags,\r\nUSBAT_UIO_READ);\r\nusb_stor_dbg(us, "UIO register reads %02X\n", *data_flags);\r\nreturn result;\r\n}\r\nstatic int usbat_write_user_io(struct us_data *us,\r\nunsigned char enable_flags,\r\nunsigned char data_flags)\r\n{\r\nreturn usb_stor_ctrl_transfer(us,\r\nus->send_ctrl_pipe,\r\nUSBAT_CMD_UIO,\r\n0x40,\r\nshort_pack(enable_flags, data_flags),\r\n0,\r\nNULL,\r\nUSBAT_UIO_WRITE);\r\n}\r\nstatic int usbat_device_reset(struct us_data *us)\r\n{\r\nint rc;\r\nrc = usbat_write_user_io(us,\r\nUSBAT_UIO_DRVRST | USBAT_UIO_OE1 | USBAT_UIO_OE0,\r\nUSBAT_UIO_EPAD | USBAT_UIO_1);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nrc = usbat_write_user_io(us,\r\nUSBAT_UIO_OE1 | USBAT_UIO_OE0,\r\nUSBAT_UIO_EPAD | USBAT_UIO_1);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int usbat_device_enable_cdt(struct us_data *us)\r\n{\r\nint rc;\r\nrc = usbat_write_user_io(us,\r\nUSBAT_UIO_ACKD | USBAT_UIO_OE1 | USBAT_UIO_OE0,\r\nUSBAT_UIO_EPAD | USBAT_UIO_1);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int usbat_flash_check_media_present(struct us_data *us,\r\nunsigned char *uio)\r\n{\r\nif (*uio & USBAT_UIO_UI0) {\r\nusb_stor_dbg(us, "no media detected\n");\r\nreturn USBAT_FLASH_MEDIA_NONE;\r\n}\r\nreturn USBAT_FLASH_MEDIA_CF;\r\n}\r\nstatic int usbat_flash_check_media_changed(struct us_data *us,\r\nunsigned char *uio)\r\n{\r\nif (*uio & USBAT_UIO_0) {\r\nusb_stor_dbg(us, "media change detected\n");\r\nreturn USBAT_FLASH_MEDIA_CHANGED;\r\n}\r\nreturn USBAT_FLASH_MEDIA_SAME;\r\n}\r\nstatic int usbat_flash_check_media(struct us_data *us,\r\nstruct usbat_info *info)\r\n{\r\nint rc;\r\nunsigned char *uio = us->iobuf;\r\nrc = usbat_read_user_io(us, uio);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nrc = usbat_flash_check_media_present(us, uio);\r\nif (rc == USBAT_FLASH_MEDIA_NONE) {\r\ninfo->sense_key = 0x02;\r\ninfo->sense_asc = 0x3A;\r\ninfo->sense_ascq = 0x00;\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\n}\r\nrc = usbat_flash_check_media_changed(us, uio);\r\nif (rc == USBAT_FLASH_MEDIA_CHANGED) {\r\nrc = usbat_device_reset(us);\r\nif (rc != USB_STOR_TRANSPORT_GOOD)\r\nreturn rc;\r\nrc = usbat_device_enable_cdt(us);\r\nif (rc != USB_STOR_TRANSPORT_GOOD)\r\nreturn rc;\r\nmsleep(50);\r\nrc = usbat_read_user_io(us, uio);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\ninfo->sense_key = UNIT_ATTENTION;\r\ninfo->sense_asc = 0x28;\r\ninfo->sense_ascq = 0x00;\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\n}\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int usbat_identify_device(struct us_data *us,\r\nstruct usbat_info *info)\r\n{\r\nint rc;\r\nunsigned char status;\r\nif (!us || !info)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nrc = usbat_device_reset(us);\r\nif (rc != USB_STOR_TRANSPORT_GOOD)\r\nreturn rc;\r\nmsleep(500);\r\nrc = usbat_write(us, USBAT_ATA, USBAT_ATA_CMD, 0xA1);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nrc = usbat_get_status(us, &status);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (status == 0xA1 || !(status & 0x01)) {\r\nusb_stor_dbg(us, "Detected HP8200 CDRW\n");\r\ninfo->devicetype = USBAT_DEV_HP8200;\r\n} else {\r\nusb_stor_dbg(us, "Detected Flash reader/writer\n");\r\ninfo->devicetype = USBAT_DEV_FLASH;\r\n}\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int usbat_set_transport(struct us_data *us,\r\nstruct usbat_info *info,\r\nint devicetype)\r\n{\r\nif (!info->devicetype)\r\ninfo->devicetype = devicetype;\r\nif (!info->devicetype)\r\nusbat_identify_device(us, info);\r\nswitch (info->devicetype) {\r\ndefault:\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\ncase USBAT_DEV_HP8200:\r\nus->transport = usbat_hp8200e_transport;\r\nbreak;\r\ncase USBAT_DEV_FLASH:\r\nus->transport = usbat_flash_transport;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int usbat_flash_get_sector_count(struct us_data *us,\r\nstruct usbat_info *info)\r\n{\r\nunsigned char registers[3] = {\r\nUSBAT_ATA_SECCNT,\r\nUSBAT_ATA_DEVICE,\r\nUSBAT_ATA_CMD,\r\n};\r\nunsigned char command[3] = { 0x01, 0xA0, 0xEC };\r\nunsigned char *reply;\r\nunsigned char status;\r\nint rc;\r\nif (!us || !info)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nreply = kmalloc(512, GFP_NOIO);\r\nif (!reply)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nrc = usbat_multiple_write(us, registers, command, 3);\r\nif (rc != USB_STOR_XFER_GOOD) {\r\nusb_stor_dbg(us, "Gah! identify_device failed\n");\r\nrc = USB_STOR_TRANSPORT_ERROR;\r\ngoto leave;\r\n}\r\nif (usbat_get_status(us, &status) != USB_STOR_XFER_GOOD) {\r\nrc = USB_STOR_TRANSPORT_ERROR;\r\ngoto leave;\r\n}\r\nmsleep(100);\r\nrc = usbat_read_block(us, reply, 512, 0);\r\nif (rc != USB_STOR_TRANSPORT_GOOD)\r\ngoto leave;\r\ninfo->sectors = ((u32)(reply[117]) << 24) |\r\n((u32)(reply[116]) << 16) |\r\n((u32)(reply[115]) << 8) |\r\n((u32)(reply[114]) );\r\nrc = USB_STOR_TRANSPORT_GOOD;\r\nleave:\r\nkfree(reply);\r\nreturn rc;\r\n}\r\nstatic int usbat_flash_read_data(struct us_data *us,\r\nstruct usbat_info *info,\r\nu32 sector,\r\nu32 sectors)\r\n{\r\nunsigned char registers[7] = {\r\nUSBAT_ATA_FEATURES,\r\nUSBAT_ATA_SECCNT,\r\nUSBAT_ATA_SECNUM,\r\nUSBAT_ATA_LBA_ME,\r\nUSBAT_ATA_LBA_HI,\r\nUSBAT_ATA_DEVICE,\r\nUSBAT_ATA_STATUS,\r\n};\r\nunsigned char command[7];\r\nunsigned char *buffer;\r\nunsigned char thistime;\r\nunsigned int totallen, alloclen;\r\nint len, result;\r\nunsigned int sg_offset = 0;\r\nstruct scatterlist *sg = NULL;\r\nresult = usbat_flash_check_media(us, info);\r\nif (result != USB_STOR_TRANSPORT_GOOD)\r\nreturn result;\r\nif (sector > 0x0FFFFFFF)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\ntotallen = sectors * info->ssize;\r\nalloclen = min(totallen, 65536u);\r\nbuffer = kmalloc(alloclen, GFP_NOIO);\r\nif (buffer == NULL)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\ndo {\r\nlen = min(totallen, alloclen);\r\nthistime = (len / info->ssize) & 0xff;\r\nusbat_pack_ata_sector_cmd(command, thistime, sector, 0x20);\r\nresult = usbat_multiple_write(us, registers, command, 7);\r\nif (result != USB_STOR_TRANSPORT_GOOD)\r\ngoto leave;\r\nresult = usbat_read_blocks(us, buffer, len, 0);\r\nif (result != USB_STOR_TRANSPORT_GOOD)\r\ngoto leave;\r\nusb_stor_dbg(us, "%d bytes\n", len);\r\nusb_stor_access_xfer_buf(buffer, len, us->srb,\r\n&sg, &sg_offset, TO_XFER_BUF);\r\nsector += thistime;\r\ntotallen -= len;\r\n} while (totallen > 0);\r\nkfree(buffer);\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\nleave:\r\nkfree(buffer);\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\n}\r\nstatic int usbat_flash_write_data(struct us_data *us,\r\nstruct usbat_info *info,\r\nu32 sector,\r\nu32 sectors)\r\n{\r\nunsigned char registers[7] = {\r\nUSBAT_ATA_FEATURES,\r\nUSBAT_ATA_SECCNT,\r\nUSBAT_ATA_SECNUM,\r\nUSBAT_ATA_LBA_ME,\r\nUSBAT_ATA_LBA_HI,\r\nUSBAT_ATA_DEVICE,\r\nUSBAT_ATA_STATUS,\r\n};\r\nunsigned char command[7];\r\nunsigned char *buffer;\r\nunsigned char thistime;\r\nunsigned int totallen, alloclen;\r\nint len, result;\r\nunsigned int sg_offset = 0;\r\nstruct scatterlist *sg = NULL;\r\nresult = usbat_flash_check_media(us, info);\r\nif (result != USB_STOR_TRANSPORT_GOOD)\r\nreturn result;\r\nif (sector > 0x0FFFFFFF)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\ntotallen = sectors * info->ssize;\r\nalloclen = min(totallen, 65536u);\r\nbuffer = kmalloc(alloclen, GFP_NOIO);\r\nif (buffer == NULL)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\ndo {\r\nlen = min(totallen, alloclen);\r\nthistime = (len / info->ssize) & 0xff;\r\nusb_stor_access_xfer_buf(buffer, len, us->srb,\r\n&sg, &sg_offset, FROM_XFER_BUF);\r\nusbat_pack_ata_sector_cmd(command, thistime, sector, 0x30);\r\nresult = usbat_multiple_write(us, registers, command, 7);\r\nif (result != USB_STOR_TRANSPORT_GOOD)\r\ngoto leave;\r\nresult = usbat_write_blocks(us, buffer, len, 0);\r\nif (result != USB_STOR_TRANSPORT_GOOD)\r\ngoto leave;\r\nsector += thistime;\r\ntotallen -= len;\r\n} while (totallen > 0);\r\nkfree(buffer);\r\nreturn result;\r\nleave:\r\nkfree(buffer);\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\n}\r\nstatic int usbat_hp8200e_handle_read10(struct us_data *us,\r\nunsigned char *registers,\r\nunsigned char *data,\r\nstruct scsi_cmnd *srb)\r\n{\r\nint result = USB_STOR_TRANSPORT_GOOD;\r\nunsigned char *buffer;\r\nunsigned int len;\r\nunsigned int sector;\r\nunsigned int sg_offset = 0;\r\nstruct scatterlist *sg = NULL;\r\nusb_stor_dbg(us, "transfersize %d\n", srb->transfersize);\r\nif (scsi_bufflen(srb) < 0x10000) {\r\nresult = usbat_hp8200e_rw_block_test(us, USBAT_ATA,\r\nregisters, data, 19,\r\nUSBAT_ATA_DATA, USBAT_ATA_STATUS, 0xFD,\r\n(USBAT_QUAL_FCQ | USBAT_QUAL_ALQ),\r\nDMA_FROM_DEVICE,\r\nscsi_sglist(srb),\r\nscsi_bufflen(srb), scsi_sg_count(srb), 1);\r\nreturn result;\r\n}\r\nif (data[7+0] == GPCMD_READ_CD) {\r\nlen = short_pack(data[7+9], data[7+8]);\r\nlen <<= 16;\r\nlen |= data[7+7];\r\nusb_stor_dbg(us, "GPCMD_READ_CD: len %d\n", len);\r\nsrb->transfersize = scsi_bufflen(srb)/len;\r\n}\r\nif (!srb->transfersize) {\r\nsrb->transfersize = 2048;\r\nusb_stor_dbg(us, "transfersize 0, forcing %d\n",\r\nsrb->transfersize);\r\n}\r\nlen = (65535/srb->transfersize) * srb->transfersize;\r\nusb_stor_dbg(us, "Max read is %d bytes\n", len);\r\nlen = min(len, scsi_bufflen(srb));\r\nbuffer = kmalloc(len, GFP_NOIO);\r\nif (buffer == NULL)\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\nsector = short_pack(data[7+3], data[7+2]);\r\nsector <<= 16;\r\nsector |= short_pack(data[7+5], data[7+4]);\r\ntransferred = 0;\r\nwhile (transferred != scsi_bufflen(srb)) {\r\nif (len > scsi_bufflen(srb) - transferred)\r\nlen = scsi_bufflen(srb) - transferred;\r\ndata[3] = len&0xFF;\r\ndata[4] = (len>>8)&0xFF;\r\ndata[7+2] = MSB_of(sector>>16);\r\ndata[7+3] = LSB_of(sector>>16);\r\ndata[7+4] = MSB_of(sector&0xFFFF);\r\ndata[7+5] = LSB_of(sector&0xFFFF);\r\nif (data[7+0] == GPCMD_READ_CD)\r\ndata[7+6] = 0;\r\ndata[7+7] = MSB_of(len / srb->transfersize);\r\ndata[7+8] = LSB_of(len / srb->transfersize);\r\nresult = usbat_hp8200e_rw_block_test(us, USBAT_ATA,\r\nregisters, data, 19,\r\nUSBAT_ATA_DATA, USBAT_ATA_STATUS, 0xFD,\r\n(USBAT_QUAL_FCQ | USBAT_QUAL_ALQ),\r\nDMA_FROM_DEVICE,\r\nbuffer,\r\nlen, 0, 1);\r\nif (result != USB_STOR_TRANSPORT_GOOD)\r\nbreak;\r\nusb_stor_access_xfer_buf(buffer, len, srb,\r\n&sg, &sg_offset, TO_XFER_BUF);\r\ntransferred += len;\r\nsector += len / srb->transfersize;\r\n}\r\nkfree(buffer);\r\nreturn result;\r\n}\r\nstatic int usbat_select_and_test_registers(struct us_data *us)\r\n{\r\nint selector;\r\nunsigned char *status = us->iobuf;\r\nfor (selector = 0xA0; selector <= 0xB0; selector += 0x10) {\r\nif (usbat_write(us, USBAT_ATA, USBAT_ATA_DEVICE, selector) !=\r\nUSB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (usbat_read(us, USBAT_ATA, USBAT_ATA_STATUS, status) !=\r\nUSB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (usbat_read(us, USBAT_ATA, USBAT_ATA_DEVICE, status) !=\r\nUSB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (usbat_read(us, USBAT_ATA, USBAT_ATA_LBA_ME, status) !=\r\nUSB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (usbat_read(us, USBAT_ATA, USBAT_ATA_LBA_HI, status) !=\r\nUSB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (usbat_write(us, USBAT_ATA, USBAT_ATA_LBA_ME, 0x55) !=\r\nUSB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (usbat_write(us, USBAT_ATA, USBAT_ATA_LBA_HI, 0xAA) !=\r\nUSB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (usbat_read(us, USBAT_ATA, USBAT_ATA_LBA_ME, status) !=\r\nUSB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (usbat_read(us, USBAT_ATA, USBAT_ATA_LBA_ME, status) !=\r\nUSB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\n}\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int init_usbat(struct us_data *us, int devicetype)\r\n{\r\nint rc;\r\nstruct usbat_info *info;\r\nunsigned char subcountH = USBAT_ATA_LBA_HI;\r\nunsigned char subcountL = USBAT_ATA_LBA_ME;\r\nunsigned char *status = us->iobuf;\r\nus->extra = kzalloc(sizeof(struct usbat_info), GFP_NOIO);\r\nif (!us->extra)\r\nreturn 1;\r\ninfo = (struct usbat_info *) (us->extra);\r\nrc = usbat_write_user_io(us,\r\nUSBAT_UIO_OE1 | USBAT_UIO_OE0,\r\nUSBAT_UIO_EPAD | USBAT_UIO_1);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nusb_stor_dbg(us, "INIT 1\n");\r\nmsleep(2000);\r\nrc = usbat_read_user_io(us, status);\r\nif (rc != USB_STOR_TRANSPORT_GOOD)\r\nreturn rc;\r\nusb_stor_dbg(us, "INIT 2\n");\r\nrc = usbat_read_user_io(us, status);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nrc = usbat_read_user_io(us, status);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nusb_stor_dbg(us, "INIT 3\n");\r\nrc = usbat_select_and_test_registers(us);\r\nif (rc != USB_STOR_TRANSPORT_GOOD)\r\nreturn rc;\r\nusb_stor_dbg(us, "INIT 4\n");\r\nrc = usbat_read_user_io(us, status);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nusb_stor_dbg(us, "INIT 5\n");\r\nrc = usbat_device_enable_cdt(us);\r\nif (rc != USB_STOR_TRANSPORT_GOOD)\r\nreturn rc;\r\nusb_stor_dbg(us, "INIT 6\n");\r\nrc = usbat_read_user_io(us, status);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nusb_stor_dbg(us, "INIT 7\n");\r\nmsleep(1400);\r\nrc = usbat_read_user_io(us, status);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nusb_stor_dbg(us, "INIT 8\n");\r\nrc = usbat_select_and_test_registers(us);\r\nif (rc != USB_STOR_TRANSPORT_GOOD)\r\nreturn rc;\r\nusb_stor_dbg(us, "INIT 9\n");\r\nif (usbat_set_transport(us, info, devicetype))\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nusb_stor_dbg(us, "INIT 10\n");\r\nif (usbat_get_device_type(us) == USBAT_DEV_FLASH) {\r\nsubcountH = 0x02;\r\nsubcountL = 0x00;\r\n}\r\nrc = usbat_set_shuttle_features(us, (USBAT_FEAT_ETEN | USBAT_FEAT_ET2 | USBAT_FEAT_ET1),\r\n0x00, 0x88, 0x08, subcountH, subcountL);\r\nif (rc != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nusb_stor_dbg(us, "INIT 11\n");\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int usbat_hp8200e_transport(struct scsi_cmnd *srb, struct us_data *us)\r\n{\r\nint result;\r\nunsigned char *status = us->iobuf;\r\nunsigned char registers[32];\r\nunsigned char data[32];\r\nunsigned int len;\r\nint i;\r\nlen = scsi_bufflen(srb);\r\nregisters[0] = USBAT_ATA_FEATURES;\r\nregisters[1] = USBAT_ATA_SECCNT;\r\nregisters[2] = USBAT_ATA_SECNUM;\r\nregisters[3] = USBAT_ATA_LBA_ME;\r\nregisters[4] = USBAT_ATA_LBA_HI;\r\nregisters[5] = USBAT_ATA_DEVICE;\r\nregisters[6] = USBAT_ATA_CMD;\r\ndata[0] = 0x00;\r\ndata[1] = 0x00;\r\ndata[2] = 0x00;\r\ndata[3] = len&0xFF;\r\ndata[4] = (len>>8)&0xFF;\r\ndata[5] = 0xB0;\r\ndata[6] = 0xA0;\r\nfor (i=7; i<19; i++) {\r\nregisters[i] = 0x10;\r\ndata[i] = (i-7 >= srb->cmd_len) ? 0 : srb->cmnd[i-7];\r\n}\r\nresult = usbat_get_status(us, status);\r\nusb_stor_dbg(us, "Status = %02X\n", *status);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (srb->cmnd[0] == TEST_UNIT_READY)\r\ntransferred = 0;\r\nif (srb->sc_data_direction == DMA_TO_DEVICE) {\r\nresult = usbat_hp8200e_rw_block_test(us, USBAT_ATA,\r\nregisters, data, 19,\r\nUSBAT_ATA_DATA, USBAT_ATA_STATUS, 0xFD,\r\n(USBAT_QUAL_FCQ | USBAT_QUAL_ALQ),\r\nDMA_TO_DEVICE,\r\nscsi_sglist(srb),\r\nlen, scsi_sg_count(srb), 10);\r\nif (result == USB_STOR_TRANSPORT_GOOD) {\r\ntransferred += len;\r\nusb_stor_dbg(us, "Wrote %08X bytes\n", transferred);\r\n}\r\nreturn result;\r\n} else if (srb->cmnd[0] == READ_10 ||\r\nsrb->cmnd[0] == GPCMD_READ_CD) {\r\nreturn usbat_hp8200e_handle_read10(us, registers, data, srb);\r\n}\r\nif (len > 0xFFFF) {\r\nusb_stor_dbg(us, "Error: len = %08X... what do I do now?\n",\r\nlen);\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\n}\r\nresult = usbat_multiple_write(us, registers, data, 7);\r\nif (result != USB_STOR_TRANSPORT_GOOD)\r\nreturn result;\r\nresult = usbat_write_block(us, USBAT_ATA, srb->cmnd, 12,\r\nsrb->cmnd[0] == GPCMD_BLANK ? 75 : 10, 0);\r\nif (result != USB_STOR_TRANSPORT_GOOD)\r\nreturn result;\r\nif (len != 0 && (srb->sc_data_direction == DMA_FROM_DEVICE)) {\r\nif (usbat_read(us, USBAT_ATA, USBAT_ATA_LBA_ME, status) !=\r\nUSB_STOR_XFER_GOOD) {\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\n}\r\nif (len > 0xFF) {\r\nlen = *status;\r\nif (usbat_read(us, USBAT_ATA, USBAT_ATA_LBA_HI, status) !=\r\nUSB_STOR_XFER_GOOD) {\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\n}\r\nlen += ((unsigned int) *status)<<8;\r\n}\r\nelse\r\nlen = *status;\r\nresult = usbat_read_block(us, scsi_sglist(srb), len,\r\nscsi_sg_count(srb));\r\n}\r\nreturn result;\r\n}\r\nstatic int usbat_flash_transport(struct scsi_cmnd * srb, struct us_data *us)\r\n{\r\nint rc;\r\nstruct usbat_info *info = (struct usbat_info *) (us->extra);\r\nunsigned long block, blocks;\r\nunsigned char *ptr = us->iobuf;\r\nstatic unsigned char inquiry_response[36] = {\r\n0x00, 0x80, 0x00, 0x01, 0x1F, 0x00, 0x00, 0x00\r\n};\r\nif (srb->cmnd[0] == INQUIRY) {\r\nusb_stor_dbg(us, "INQUIRY - Returning bogus response\n");\r\nmemcpy(ptr, inquiry_response, sizeof(inquiry_response));\r\nfill_inquiry_response(us, ptr, 36);\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nif (srb->cmnd[0] == READ_CAPACITY) {\r\nrc = usbat_flash_check_media(us, info);\r\nif (rc != USB_STOR_TRANSPORT_GOOD)\r\nreturn rc;\r\nrc = usbat_flash_get_sector_count(us, info);\r\nif (rc != USB_STOR_TRANSPORT_GOOD)\r\nreturn rc;\r\ninfo->ssize = 0x200;\r\nusb_stor_dbg(us, "READ_CAPACITY: %ld sectors, %ld bytes per sector\n",\r\ninfo->sectors, info->ssize);\r\n((__be32 *) ptr)[0] = cpu_to_be32(info->sectors - 1);\r\n((__be32 *) ptr)[1] = cpu_to_be32(info->ssize);\r\nusb_stor_set_xfer_buf(ptr, 8, srb);\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nif (srb->cmnd[0] == MODE_SELECT_10) {\r\nusb_stor_dbg(us, "Gah! MODE_SELECT_10\n");\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\n}\r\nif (srb->cmnd[0] == READ_10) {\r\nblock = ((u32)(srb->cmnd[2]) << 24) | ((u32)(srb->cmnd[3]) << 16) |\r\n((u32)(srb->cmnd[4]) << 8) | ((u32)(srb->cmnd[5]));\r\nblocks = ((u32)(srb->cmnd[7]) << 8) | ((u32)(srb->cmnd[8]));\r\nusb_stor_dbg(us, "READ_10: read block 0x%04lx count %ld\n",\r\nblock, blocks);\r\nreturn usbat_flash_read_data(us, info, block, blocks);\r\n}\r\nif (srb->cmnd[0] == READ_12) {\r\nblock = ((u32)(srb->cmnd[2]) << 24) | ((u32)(srb->cmnd[3]) << 16) |\r\n((u32)(srb->cmnd[4]) << 8) | ((u32)(srb->cmnd[5]));\r\nblocks = ((u32)(srb->cmnd[6]) << 24) | ((u32)(srb->cmnd[7]) << 16) |\r\n((u32)(srb->cmnd[8]) << 8) | ((u32)(srb->cmnd[9]));\r\nusb_stor_dbg(us, "READ_12: read block 0x%04lx count %ld\n",\r\nblock, blocks);\r\nreturn usbat_flash_read_data(us, info, block, blocks);\r\n}\r\nif (srb->cmnd[0] == WRITE_10) {\r\nblock = ((u32)(srb->cmnd[2]) << 24) | ((u32)(srb->cmnd[3]) << 16) |\r\n((u32)(srb->cmnd[4]) << 8) | ((u32)(srb->cmnd[5]));\r\nblocks = ((u32)(srb->cmnd[7]) << 8) | ((u32)(srb->cmnd[8]));\r\nusb_stor_dbg(us, "WRITE_10: write block 0x%04lx count %ld\n",\r\nblock, blocks);\r\nreturn usbat_flash_write_data(us, info, block, blocks);\r\n}\r\nif (srb->cmnd[0] == WRITE_12) {\r\nblock = ((u32)(srb->cmnd[2]) << 24) | ((u32)(srb->cmnd[3]) << 16) |\r\n((u32)(srb->cmnd[4]) << 8) | ((u32)(srb->cmnd[5]));\r\nblocks = ((u32)(srb->cmnd[6]) << 24) | ((u32)(srb->cmnd[7]) << 16) |\r\n((u32)(srb->cmnd[8]) << 8) | ((u32)(srb->cmnd[9]));\r\nusb_stor_dbg(us, "WRITE_12: write block 0x%04lx count %ld\n",\r\nblock, blocks);\r\nreturn usbat_flash_write_data(us, info, block, blocks);\r\n}\r\nif (srb->cmnd[0] == TEST_UNIT_READY) {\r\nusb_stor_dbg(us, "TEST_UNIT_READY\n");\r\nrc = usbat_flash_check_media(us, info);\r\nif (rc != USB_STOR_TRANSPORT_GOOD)\r\nreturn rc;\r\nreturn usbat_check_status(us);\r\n}\r\nif (srb->cmnd[0] == REQUEST_SENSE) {\r\nusb_stor_dbg(us, "REQUEST_SENSE\n");\r\nmemset(ptr, 0, 18);\r\nptr[0] = 0xF0;\r\nptr[2] = info->sense_key;\r\nptr[7] = 11;\r\nptr[12] = info->sense_asc;\r\nptr[13] = info->sense_ascq;\r\nusb_stor_set_xfer_buf(ptr, 18, srb);\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nif (srb->cmnd[0] == ALLOW_MEDIUM_REMOVAL) {\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nusb_stor_dbg(us, "Gah! Unknown command: %d (0x%x)\n",\r\nsrb->cmnd[0], srb->cmnd[0]);\r\ninfo->sense_key = 0x05;\r\ninfo->sense_asc = 0x20;\r\ninfo->sense_ascq = 0x00;\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\n}\r\nstatic int init_usbat_cd(struct us_data *us)\r\n{\r\nreturn init_usbat(us, USBAT_DEV_HP8200);\r\n}\r\nstatic int init_usbat_flash(struct us_data *us)\r\n{\r\nreturn init_usbat(us, USBAT_DEV_FLASH);\r\n}\r\nstatic int usbat_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct us_data *us;\r\nint result;\r\nresult = usb_stor_probe1(&us, intf, id,\r\n(id - usbat_usb_ids) + usbat_unusual_dev_list);\r\nif (result)\r\nreturn result;\r\nus->transport_name = "Shuttle USBAT";\r\nus->transport = usbat_flash_transport;\r\nus->transport_reset = usb_stor_CB_reset;\r\nus->max_lun = 1;\r\nresult = usb_stor_probe2(us);\r\nreturn result;\r\n}

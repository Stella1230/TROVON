int\r\nnve4_graph_init(struct nouveau_object *object)\r\n{\r\nstruct nvc0_graph_oclass *oclass = (void *)object->oclass;\r\nstruct nvc0_graph_priv *priv = (void *)object;\r\nconst u32 magicgpc918 = DIV_ROUND_UP(0x00800000, priv->tpc_total);\r\nu32 data[TPC_MAX / 8] = {};\r\nu8 tpcnr[GPC_MAX];\r\nint gpc, tpc, rop;\r\nint ret, i;\r\nret = nouveau_graph_init(&priv->base);\r\nif (ret)\r\nreturn ret;\r\nnv_wr32(priv, GPC_BCAST(0x0880), 0x00000000);\r\nnv_wr32(priv, GPC_BCAST(0x08a4), 0x00000000);\r\nnv_wr32(priv, GPC_BCAST(0x0888), 0x00000000);\r\nnv_wr32(priv, GPC_BCAST(0x088c), 0x00000000);\r\nnv_wr32(priv, GPC_BCAST(0x0890), 0x00000000);\r\nnv_wr32(priv, GPC_BCAST(0x0894), 0x00000000);\r\nnv_wr32(priv, GPC_BCAST(0x08b4), priv->unk4188b4->addr >> 8);\r\nnv_wr32(priv, GPC_BCAST(0x08b8), priv->unk4188b8->addr >> 8);\r\nfor (i = 0; oclass->mmio[i]; i++)\r\nnvc0_graph_mmio(priv, oclass->mmio[i]);\r\nnv_wr32(priv, GPC_UNIT(0, 0x3018), 0x00000001);\r\nmemset(data, 0x00, sizeof(data));\r\nmemcpy(tpcnr, priv->tpc_nr, sizeof(priv->tpc_nr));\r\nfor (i = 0, gpc = -1; i < priv->tpc_total; i++) {\r\ndo {\r\ngpc = (gpc + 1) % priv->gpc_nr;\r\n} while (!tpcnr[gpc]);\r\ntpc = priv->tpc_nr[gpc] - tpcnr[gpc]--;\r\ndata[i / 8] |= tpc << ((i % 8) * 4);\r\n}\r\nnv_wr32(priv, GPC_BCAST(0x0980), data[0]);\r\nnv_wr32(priv, GPC_BCAST(0x0984), data[1]);\r\nnv_wr32(priv, GPC_BCAST(0x0988), data[2]);\r\nnv_wr32(priv, GPC_BCAST(0x098c), data[3]);\r\nfor (gpc = 0; gpc < priv->gpc_nr; gpc++) {\r\nnv_wr32(priv, GPC_UNIT(gpc, 0x0914),\r\npriv->magic_not_rop_nr << 8 | priv->tpc_nr[gpc]);\r\nnv_wr32(priv, GPC_UNIT(gpc, 0x0910), 0x00040000 |\r\npriv->tpc_total);\r\nnv_wr32(priv, GPC_UNIT(gpc, 0x0918), magicgpc918);\r\n}\r\nnv_wr32(priv, GPC_BCAST(0x3fd4), magicgpc918);\r\nnv_wr32(priv, GPC_BCAST(0x08ac), nv_rd32(priv, 0x100800));\r\nnv_wr32(priv, 0x400500, 0x00010001);\r\nnv_wr32(priv, 0x400100, 0xffffffff);\r\nnv_wr32(priv, 0x40013c, 0xffffffff);\r\nnv_wr32(priv, 0x409ffc, 0x00000000);\r\nnv_wr32(priv, 0x409c14, 0x00003e3e);\r\nnv_wr32(priv, 0x409c24, 0x000f0001);\r\nnv_wr32(priv, 0x404000, 0xc0000000);\r\nnv_wr32(priv, 0x404600, 0xc0000000);\r\nnv_wr32(priv, 0x408030, 0xc0000000);\r\nnv_wr32(priv, 0x404490, 0xc0000000);\r\nnv_wr32(priv, 0x406018, 0xc0000000);\r\nnv_wr32(priv, 0x407020, 0x40000000);\r\nnv_wr32(priv, 0x405840, 0xc0000000);\r\nnv_wr32(priv, 0x405844, 0x00ffffff);\r\nnv_mask(priv, 0x419cc0, 0x00000008, 0x00000008);\r\nnv_mask(priv, 0x419eb4, 0x00001000, 0x00001000);\r\nfor (gpc = 0; gpc < priv->gpc_nr; gpc++) {\r\nnv_wr32(priv, GPC_UNIT(gpc, 0x3038), 0xc0000000);\r\nnv_wr32(priv, GPC_UNIT(gpc, 0x0420), 0xc0000000);\r\nnv_wr32(priv, GPC_UNIT(gpc, 0x0900), 0xc0000000);\r\nnv_wr32(priv, GPC_UNIT(gpc, 0x1028), 0xc0000000);\r\nnv_wr32(priv, GPC_UNIT(gpc, 0x0824), 0xc0000000);\r\nfor (tpc = 0; tpc < priv->tpc_nr[gpc]; tpc++) {\r\nnv_wr32(priv, TPC_UNIT(gpc, tpc, 0x508), 0xffffffff);\r\nnv_wr32(priv, TPC_UNIT(gpc, tpc, 0x50c), 0xffffffff);\r\nnv_wr32(priv, TPC_UNIT(gpc, tpc, 0x224), 0xc0000000);\r\nnv_wr32(priv, TPC_UNIT(gpc, tpc, 0x48c), 0xc0000000);\r\nnv_wr32(priv, TPC_UNIT(gpc, tpc, 0x084), 0xc0000000);\r\nnv_wr32(priv, TPC_UNIT(gpc, tpc, 0x644), 0x001ffffe);\r\nnv_wr32(priv, TPC_UNIT(gpc, tpc, 0x64c), 0x0000000f);\r\n}\r\nnv_wr32(priv, GPC_UNIT(gpc, 0x2c90), 0xffffffff);\r\nnv_wr32(priv, GPC_UNIT(gpc, 0x2c94), 0xffffffff);\r\n}\r\nfor (rop = 0; rop < priv->rop_nr; rop++) {\r\nnv_wr32(priv, ROP_UNIT(rop, 0x144), 0xc0000000);\r\nnv_wr32(priv, ROP_UNIT(rop, 0x070), 0xc0000000);\r\nnv_wr32(priv, ROP_UNIT(rop, 0x204), 0xffffffff);\r\nnv_wr32(priv, ROP_UNIT(rop, 0x208), 0xffffffff);\r\n}\r\nnv_wr32(priv, 0x400108, 0xffffffff);\r\nnv_wr32(priv, 0x400138, 0xffffffff);\r\nnv_wr32(priv, 0x400118, 0xffffffff);\r\nnv_wr32(priv, 0x400130, 0xffffffff);\r\nnv_wr32(priv, 0x40011c, 0xffffffff);\r\nnv_wr32(priv, 0x400134, 0xffffffff);\r\nnv_wr32(priv, 0x400054, 0x34ce3464);\r\nreturn nvc0_graph_init_ctxctl(priv);\r\n}

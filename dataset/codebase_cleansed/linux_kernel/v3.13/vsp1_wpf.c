static inline u32 vsp1_wpf_read(struct vsp1_rwpf *wpf, u32 reg)\r\n{\r\nreturn vsp1_read(wpf->entity.vsp1,\r\nreg + wpf->entity.index * VI6_WPF_OFFSET);\r\n}\r\nstatic inline void vsp1_wpf_write(struct vsp1_rwpf *wpf, u32 reg, u32 data)\r\n{\r\nvsp1_write(wpf->entity.vsp1,\r\nreg + wpf->entity.index * VI6_WPF_OFFSET, data);\r\n}\r\nstatic int wpf_s_stream(struct v4l2_subdev *subdev, int enable)\r\n{\r\nstruct vsp1_rwpf *wpf = to_rwpf(subdev);\r\nstruct vsp1_pipeline *pipe =\r\nto_vsp1_pipeline(&wpf->entity.subdev.entity);\r\nstruct vsp1_device *vsp1 = wpf->entity.vsp1;\r\nconst struct v4l2_mbus_framefmt *format =\r\n&wpf->entity.formats[RWPF_PAD_SOURCE];\r\nunsigned int i;\r\nu32 srcrpf = 0;\r\nu32 outfmt = 0;\r\nif (!enable) {\r\nvsp1_write(vsp1, VI6_WPF_IRQ_ENB(wpf->entity.index), 0);\r\nreturn 0;\r\n}\r\nfor (i = 0; i < pipe->num_inputs; ++i) {\r\nstruct vsp1_rwpf *input = pipe->inputs[i];\r\nsrcrpf |= VI6_WPF_SRCRPF_RPF_ACT_MST(input->entity.index);\r\n}\r\nvsp1_wpf_write(wpf, VI6_WPF_SRCRPF, srcrpf);\r\nif (!pipe->lif) {\r\nstruct v4l2_pix_format_mplane *format = &wpf->video.format;\r\nvsp1_wpf_write(wpf, VI6_WPF_DSTM_STRIDE_Y,\r\nformat->plane_fmt[0].bytesperline);\r\nif (format->num_planes > 1)\r\nvsp1_wpf_write(wpf, VI6_WPF_DSTM_STRIDE_C,\r\nformat->plane_fmt[1].bytesperline);\r\n}\r\nvsp1_wpf_write(wpf, VI6_WPF_HSZCLIP,\r\nformat->width << VI6_WPF_SZCLIP_SIZE_SHIFT);\r\nvsp1_wpf_write(wpf, VI6_WPF_VSZCLIP,\r\nformat->height << VI6_WPF_SZCLIP_SIZE_SHIFT);\r\nif (!pipe->lif) {\r\nconst struct vsp1_format_info *fmtinfo = wpf->video.fmtinfo;\r\noutfmt = fmtinfo->hwfmt << VI6_WPF_OUTFMT_WRFMT_SHIFT;\r\nif (fmtinfo->swap_yc)\r\noutfmt |= VI6_WPF_OUTFMT_SPYCS;\r\nif (fmtinfo->swap_uv)\r\noutfmt |= VI6_WPF_OUTFMT_SPUVS;\r\nvsp1_wpf_write(wpf, VI6_WPF_DSWAP, fmtinfo->swap);\r\n}\r\nif (wpf->entity.formats[RWPF_PAD_SINK].code !=\r\nwpf->entity.formats[RWPF_PAD_SOURCE].code)\r\noutfmt |= VI6_WPF_OUTFMT_CSC;\r\nvsp1_wpf_write(wpf, VI6_WPF_OUTFMT, outfmt);\r\nvsp1_write(vsp1, VI6_DPR_WPF_FPORCH(wpf->entity.index),\r\nVI6_DPR_WPF_FPORCH_FP_WPFN);\r\nvsp1_write(vsp1, VI6_WPF_WRBCK_CTRL, 0);\r\nvsp1_write(vsp1, VI6_WPF_IRQ_STA(wpf->entity.index), 0);\r\nvsp1_write(vsp1, VI6_WPF_IRQ_ENB(wpf->entity.index),\r\nVI6_WFP_IRQ_ENB_FREE);\r\nreturn 0;\r\n}\r\nstatic void wpf_vdev_queue(struct vsp1_video *video,\r\nstruct vsp1_video_buffer *buf)\r\n{\r\nstruct vsp1_rwpf *wpf = container_of(video, struct vsp1_rwpf, video);\r\nvsp1_wpf_write(wpf, VI6_WPF_DSTM_ADDR_Y, buf->addr[0]);\r\nif (buf->buf.num_planes > 1)\r\nvsp1_wpf_write(wpf, VI6_WPF_DSTM_ADDR_C0, buf->addr[1]);\r\nif (buf->buf.num_planes > 2)\r\nvsp1_wpf_write(wpf, VI6_WPF_DSTM_ADDR_C1, buf->addr[2]);\r\n}\r\nstruct vsp1_rwpf *vsp1_wpf_create(struct vsp1_device *vsp1, unsigned int index)\r\n{\r\nstruct v4l2_subdev *subdev;\r\nstruct vsp1_video *video;\r\nstruct vsp1_rwpf *wpf;\r\nunsigned int flags;\r\nint ret;\r\nwpf = devm_kzalloc(vsp1->dev, sizeof(*wpf), GFP_KERNEL);\r\nif (wpf == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nwpf->max_width = WPF_MAX_WIDTH;\r\nwpf->max_height = WPF_MAX_HEIGHT;\r\nwpf->entity.type = VSP1_ENTITY_WPF;\r\nwpf->entity.index = index;\r\nwpf->entity.id = VI6_DPR_NODE_WPF(index);\r\nret = vsp1_entity_init(vsp1, &wpf->entity, 2);\r\nif (ret < 0)\r\nreturn ERR_PTR(ret);\r\nsubdev = &wpf->entity.subdev;\r\nv4l2_subdev_init(subdev, &wpf_ops);\r\nsubdev->entity.ops = &vsp1_media_ops;\r\nsubdev->internal_ops = &vsp1_subdev_internal_ops;\r\nsnprintf(subdev->name, sizeof(subdev->name), "%s wpf.%u",\r\ndev_name(vsp1->dev), index);\r\nv4l2_set_subdevdata(subdev, wpf);\r\nsubdev->flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;\r\nvsp1_entity_init_formats(subdev, NULL);\r\nvideo = &wpf->video;\r\nvideo->type = V4L2_BUF_TYPE_VIDEO_CAPTURE_MPLANE;\r\nvideo->vsp1 = vsp1;\r\nvideo->ops = &wpf_vdev_ops;\r\nret = vsp1_video_init(video, &wpf->entity);\r\nif (ret < 0)\r\ngoto error_video;\r\nflags = MEDIA_LNK_FL_ENABLED;\r\nif (!(vsp1->pdata->features & VSP1_HAS_LIF) || index != 0)\r\nflags |= MEDIA_LNK_FL_IMMUTABLE;\r\nret = media_entity_create_link(&wpf->entity.subdev.entity,\r\nRWPF_PAD_SOURCE,\r\n&wpf->video.video.entity, 0, flags);\r\nif (ret < 0)\r\ngoto error_link;\r\nwpf->entity.sink = &wpf->video.video.entity;\r\nreturn wpf;\r\nerror_link:\r\nvsp1_video_cleanup(video);\r\nerror_video:\r\nmedia_entity_cleanup(&wpf->entity.subdev.entity);\r\nreturn ERR_PTR(ret);\r\n}

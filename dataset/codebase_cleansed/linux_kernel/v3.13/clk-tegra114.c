static int __init tegra114_osc_clk_init(void __iomem *clk_base)\r\n{\r\nstruct clk *clk;\r\nu32 val, pll_ref_div;\r\nval = readl_relaxed(clk_base + OSC_CTRL);\r\nosc_freq = tegra114_input_freq[val >> OSC_CTRL_OSC_FREQ_SHIFT];\r\nif (!osc_freq) {\r\nWARN_ON(1);\r\nreturn -EINVAL;\r\n}\r\nclk = clk_register_fixed_rate(NULL, "clk_m", NULL, CLK_IS_ROOT,\r\nosc_freq);\r\nclk_register_clkdev(clk, "clk_m", NULL);\r\nclks[clk_m] = clk;\r\nval = (val >> OSC_CTRL_PLL_REF_DIV_SHIFT) & 3;\r\npll_ref_div = 1 << val;\r\nclk = clk_register_fixed_factor(NULL, "pll_ref", "clk_m",\r\nCLK_SET_RATE_PARENT, 1, pll_ref_div);\r\nclk_register_clkdev(clk, "pll_ref", NULL);\r\nclks[pll_ref] = clk;\r\npll_ref_freq = osc_freq / pll_ref_div;\r\nreturn 0;\r\n}\r\nstatic void __init tegra114_fixed_clk_init(void __iomem *clk_base)\r\n{\r\nstruct clk *clk;\r\nclk = clk_register_fixed_rate(NULL, "clk_32k", NULL, CLK_IS_ROOT,\r\n32768);\r\nclk_register_clkdev(clk, "clk_32k", NULL);\r\nclks[clk_32k] = clk;\r\nclk = clk_register_fixed_factor(NULL, "clk_m_div2", "clk_m",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclk_register_clkdev(clk, "clk_m_div2", NULL);\r\nclks[clk_m_div2] = clk;\r\nclk = clk_register_fixed_factor(NULL, "clk_m_div4", "clk_m",\r\nCLK_SET_RATE_PARENT, 1, 4);\r\nclk_register_clkdev(clk, "clk_m_div4", NULL);\r\nclks[clk_m_div4] = clk;\r\n}\r\nstatic __init void tegra114_utmi_param_configure(void __iomem *clk_base)\r\n{\r\nu32 reg;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(utmi_parameters); i++) {\r\nif (osc_freq == utmi_parameters[i].osc_frequency)\r\nbreak;\r\n}\r\nif (i >= ARRAY_SIZE(utmi_parameters)) {\r\npr_err("%s: Unexpected oscillator freq %lu\n", __func__,\r\nosc_freq);\r\nreturn;\r\n}\r\nreg = readl_relaxed(clk_base + UTMIP_PLL_CFG2);\r\nreg &= ~UTMIP_PLL_CFG2_STABLE_COUNT(~0);\r\nreg |= UTMIP_PLL_CFG2_STABLE_COUNT(utmi_parameters[i].stable_count);\r\nreg &= ~UTMIP_PLL_CFG2_ACTIVE_DLY_COUNT(~0);\r\nreg |= UTMIP_PLL_CFG2_ACTIVE_DLY_COUNT(utmi_parameters[i].\r\nactive_delay_count);\r\nreg &= ~UTMIP_PLL_CFG2_FORCE_PD_SAMP_A_POWERDOWN;\r\nreg &= ~UTMIP_PLL_CFG2_FORCE_PD_SAMP_B_POWERDOWN;\r\nreg &= ~UTMIP_PLL_CFG2_FORCE_PD_SAMP_C_POWERDOWN;\r\nwritel_relaxed(reg, clk_base + UTMIP_PLL_CFG2);\r\nreg = readl_relaxed(clk_base + UTMIP_PLL_CFG1);\r\nreg &= ~UTMIP_PLL_CFG1_ENABLE_DLY_COUNT(~0);\r\nreg |= UTMIP_PLL_CFG1_ENABLE_DLY_COUNT(utmi_parameters[i].\r\nenable_delay_count);\r\nreg &= ~UTMIP_PLL_CFG1_XTAL_FREQ_COUNT(~0);\r\nreg |= UTMIP_PLL_CFG1_XTAL_FREQ_COUNT(utmi_parameters[i].\r\nxtal_freq_count);\r\nreg &= ~UTMIP_PLL_CFG1_FORCE_PLL_ENABLE_POWERDOWN;\r\nreg &= ~UTMIP_PLL_CFG1_FORCE_PLL_ACTIVE_POWERDOWN;\r\nreg &= ~UTMIP_PLL_CFG1_FORCE_PLLU_POWERUP;\r\nreg &= ~UTMIP_PLL_CFG1_FORCE_PLLU_POWERDOWN;\r\nwritel_relaxed(reg, clk_base + UTMIP_PLL_CFG1);\r\nreg = readl_relaxed(clk_base + UTMIPLL_HW_PWRDN_CFG0);\r\nreg |= UTMIPLL_HW_PWRDN_CFG0_USE_LOCKDET;\r\nreg &= ~UTMIPLL_HW_PWRDN_CFG0_CLK_ENABLE_SWCTL;\r\nreg |= UTMIPLL_HW_PWRDN_CFG0_SEQ_START_STATE;\r\nwritel_relaxed(reg, clk_base + UTMIPLL_HW_PWRDN_CFG0);\r\nreg = readl_relaxed(clk_base + UTMIP_PLL_CFG1);\r\nreg &= ~UTMIP_PLL_CFG1_FORCE_PLL_ENABLE_POWERUP;\r\nreg &= ~UTMIP_PLL_CFG1_FORCE_PLL_ENABLE_POWERDOWN;\r\nwritel_relaxed(reg, clk_base + UTMIP_PLL_CFG1);\r\nudelay(1);\r\nreg = readl_relaxed(clk_base + UTMIPLL_HW_PWRDN_CFG0);\r\nreg |= UTMIPLL_HW_PWRDN_CFG0_IDDQ_SWCTL;\r\nreg &= ~UTMIPLL_HW_PWRDN_CFG0_IDDQ_OVERRIDE;\r\nwritel_relaxed(reg, clk_base + UTMIPLL_HW_PWRDN_CFG0);\r\nudelay(1);\r\nreg = readl_relaxed(clk_base + UTMIPLL_HW_PWRDN_CFG0);\r\nreg |= UTMIPLL_HW_PWRDN_CFG0_SEQ_ENABLE;\r\nwritel_relaxed(reg, clk_base + UTMIPLL_HW_PWRDN_CFG0);\r\n}\r\nstatic void __init _clip_vco_min(struct tegra_clk_pll_params *pll_params)\r\n{\r\npll_params->vco_min =\r\nDIV_ROUND_UP(pll_params->vco_min, pll_ref_freq) * pll_ref_freq;\r\n}\r\nstatic int __init _setup_dynamic_ramp(struct tegra_clk_pll_params *pll_params,\r\nvoid __iomem *clk_base)\r\n{\r\nu32 val;\r\nu32 step_a, step_b;\r\nswitch (pll_ref_freq) {\r\ncase 12000000:\r\ncase 13000000:\r\ncase 26000000:\r\nstep_a = 0x2B;\r\nstep_b = 0x0B;\r\nbreak;\r\ncase 16800000:\r\nstep_a = 0x1A;\r\nstep_b = 0x09;\r\nbreak;\r\ncase 19200000:\r\nstep_a = 0x12;\r\nstep_b = 0x08;\r\nbreak;\r\ndefault:\r\npr_err("%s: Unexpected reference rate %lu\n",\r\n__func__, pll_ref_freq);\r\nWARN_ON(1);\r\nreturn -EINVAL;\r\n}\r\nval = step_a << pll_params->stepa_shift;\r\nval |= step_b << pll_params->stepb_shift;\r\nwritel_relaxed(val, clk_base + pll_params->dyn_ramp_reg);\r\nreturn 0;\r\n}\r\nstatic void __init _init_iddq(struct tegra_clk_pll_params *pll_params,\r\nvoid __iomem *clk_base)\r\n{\r\nu32 val, val_iddq;\r\nval = readl_relaxed(clk_base + pll_params->base_reg);\r\nval_iddq = readl_relaxed(clk_base + pll_params->iddq_reg);\r\nif (val & BIT(30))\r\nWARN_ON(val_iddq & BIT(pll_params->iddq_bit_idx));\r\nelse {\r\nval_iddq |= BIT(pll_params->iddq_bit_idx);\r\nwritel_relaxed(val_iddq, clk_base + pll_params->iddq_reg);\r\n}\r\n}\r\nstatic void __init tegra114_pll_init(void __iomem *clk_base,\r\nvoid __iomem *pmc)\r\n{\r\nu32 val;\r\nstruct clk *clk;\r\n_clip_vco_min(&pll_c_params);\r\nif (_setup_dynamic_ramp(&pll_c_params, clk_base) >= 0) {\r\n_init_iddq(&pll_c_params, clk_base);\r\nclk = tegra_clk_register_pllxc("pll_c", "pll_ref", clk_base,\r\npmc, 0, 0, &pll_c_params, TEGRA_PLL_USE_LOCK,\r\npll_c_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_c", NULL);\r\nclks[pll_c] = clk;\r\nclk = tegra_clk_register_divider("pll_c_out1_div", "pll_c",\r\nclk_base + PLLC_OUT, 0, TEGRA_DIVIDER_ROUND_UP,\r\n8, 8, 1, NULL);\r\nclk = tegra_clk_register_pll_out("pll_c_out1", "pll_c_out1_div",\r\nclk_base + PLLC_OUT, 1, 0,\r\nCLK_SET_RATE_PARENT, 0, NULL);\r\nclk_register_clkdev(clk, "pll_c_out1", NULL);\r\nclks[pll_c_out1] = clk;\r\n}\r\n_clip_vco_min(&pll_c2_params);\r\nclk = tegra_clk_register_pllc("pll_c2", "pll_ref", clk_base, pmc, 0, 0,\r\n&pll_c2_params, TEGRA_PLL_USE_LOCK,\r\npll_cx_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_c2", NULL);\r\nclks[pll_c2] = clk;\r\n_clip_vco_min(&pll_c3_params);\r\nclk = tegra_clk_register_pllc("pll_c3", "pll_ref", clk_base, pmc, 0, 0,\r\n&pll_c3_params, TEGRA_PLL_USE_LOCK,\r\npll_cx_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_c3", NULL);\r\nclks[pll_c3] = clk;\r\nclk = tegra_clk_register_pll("pll_p", "pll_ref", clk_base, pmc, 0,\r\n408000000, &pll_p_params,\r\nTEGRA_PLL_FIXED | TEGRA_PLL_USE_LOCK,\r\npll_p_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_p", NULL);\r\nclks[pll_p] = clk;\r\nclk = tegra_clk_register_divider("pll_p_out1_div", "pll_p",\r\nclk_base + PLLP_OUTA, 0, TEGRA_DIVIDER_FIXED |\r\nTEGRA_DIVIDER_ROUND_UP, 8, 8, 1, &pll_div_lock);\r\nclk = tegra_clk_register_pll_out("pll_p_out1", "pll_p_out1_div",\r\nclk_base + PLLP_OUTA, 1, 0,\r\nCLK_IGNORE_UNUSED | CLK_SET_RATE_PARENT, 0,\r\n&pll_div_lock);\r\nclk_register_clkdev(clk, "pll_p_out1", NULL);\r\nclks[pll_p_out1] = clk;\r\nclk = tegra_clk_register_divider("pll_p_out2_div", "pll_p",\r\nclk_base + PLLP_OUTA, 0, TEGRA_DIVIDER_FIXED |\r\nTEGRA_DIVIDER_ROUND_UP | TEGRA_DIVIDER_INT, 24,\r\n8, 1, &pll_div_lock);\r\nclk = tegra_clk_register_pll_out("pll_p_out2", "pll_p_out2_div",\r\nclk_base + PLLP_OUTA, 17, 16,\r\nCLK_IGNORE_UNUSED | CLK_SET_RATE_PARENT, 0,\r\n&pll_div_lock);\r\nclk_register_clkdev(clk, "pll_p_out2", NULL);\r\nclks[pll_p_out2] = clk;\r\nclk = tegra_clk_register_divider("pll_p_out3_div", "pll_p",\r\nclk_base + PLLP_OUTB, 0, TEGRA_DIVIDER_FIXED |\r\nTEGRA_DIVIDER_ROUND_UP, 8, 8, 1, &pll_div_lock);\r\nclk = tegra_clk_register_pll_out("pll_p_out3", "pll_p_out3_div",\r\nclk_base + PLLP_OUTB, 1, 0,\r\nCLK_IGNORE_UNUSED | CLK_SET_RATE_PARENT, 0,\r\n&pll_div_lock);\r\nclk_register_clkdev(clk, "pll_p_out3", NULL);\r\nclks[pll_p_out3] = clk;\r\nclk = tegra_clk_register_divider("pll_p_out4_div", "pll_p",\r\nclk_base + PLLP_OUTB, 0, TEGRA_DIVIDER_FIXED |\r\nTEGRA_DIVIDER_ROUND_UP, 24, 8, 1,\r\n&pll_div_lock);\r\nclk = tegra_clk_register_pll_out("pll_p_out4", "pll_p_out4_div",\r\nclk_base + PLLP_OUTB, 17, 16,\r\nCLK_IGNORE_UNUSED | CLK_SET_RATE_PARENT, 0,\r\n&pll_div_lock);\r\nclk_register_clkdev(clk, "pll_p_out4", NULL);\r\nclks[pll_p_out4] = clk;\r\n_clip_vco_min(&pll_m_params);\r\nclk = tegra_clk_register_pllm("pll_m", "pll_ref", clk_base, pmc,\r\nCLK_IGNORE_UNUSED | CLK_SET_RATE_GATE, 0,\r\n&pll_m_params, TEGRA_PLL_USE_LOCK,\r\npll_m_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_m", NULL);\r\nclks[pll_m] = clk;\r\nclk = tegra_clk_register_divider("pll_m_out1_div", "pll_m",\r\nclk_base + PLLM_OUT, 0, TEGRA_DIVIDER_ROUND_UP,\r\n8, 8, 1, NULL);\r\nclk = tegra_clk_register_pll_out("pll_m_out1", "pll_m_out1_div",\r\nclk_base + PLLM_OUT, 1, 0, CLK_IGNORE_UNUSED |\r\nCLK_SET_RATE_PARENT, 0, NULL);\r\nclk_register_clkdev(clk, "pll_m_out1", NULL);\r\nclks[pll_m_out1] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_m_ud", "pll_m",\r\nCLK_SET_RATE_PARENT, 1, 1);\r\n_clip_vco_min(&pll_x_params);\r\nif (_setup_dynamic_ramp(&pll_x_params, clk_base) >= 0) {\r\n_init_iddq(&pll_x_params, clk_base);\r\nclk = tegra_clk_register_pllxc("pll_x", "pll_ref", clk_base,\r\npmc, CLK_IGNORE_UNUSED, 0, &pll_x_params,\r\nTEGRA_PLL_USE_LOCK, pll_x_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_x", NULL);\r\nclks[pll_x] = clk;\r\n}\r\nclk = clk_register_fixed_factor(NULL, "pll_x_out0", "pll_x",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclk_register_clkdev(clk, "pll_x_out0", NULL);\r\nclks[pll_x_out0] = clk;\r\nval = readl(clk_base + pll_u_params.base_reg);\r\nval &= ~BIT(24);\r\nwritel(val, clk_base + pll_u_params.base_reg);\r\nclk = tegra_clk_register_pll("pll_u", "pll_ref", clk_base, pmc, 0,\r\n0, &pll_u_params, TEGRA_PLLU |\r\nTEGRA_PLL_HAS_CPCON | TEGRA_PLL_SET_LFCON |\r\nTEGRA_PLL_USE_LOCK, pll_u_freq_table, &pll_u_lock);\r\nclk_register_clkdev(clk, "pll_u", NULL);\r\nclks[pll_u] = clk;\r\ntegra114_utmi_param_configure(clk_base);\r\nclk = clk_register_gate(NULL, "pll_u_480M", "pll_u",\r\nCLK_SET_RATE_PARENT, clk_base + PLLU_BASE,\r\n22, 0, &pll_u_lock);\r\nclk_register_clkdev(clk, "pll_u_480M", NULL);\r\nclks[pll_u_480M] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_u_60M", "pll_u",\r\nCLK_SET_RATE_PARENT, 1, 8);\r\nclk_register_clkdev(clk, "pll_u_60M", NULL);\r\nclks[pll_u_60M] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_u_48M", "pll_u",\r\nCLK_SET_RATE_PARENT, 1, 10);\r\nclk_register_clkdev(clk, "pll_u_48M", NULL);\r\nclks[pll_u_48M] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_u_12M", "pll_u",\r\nCLK_SET_RATE_PARENT, 1, 40);\r\nclk_register_clkdev(clk, "pll_u_12M", NULL);\r\nclks[pll_u_12M] = clk;\r\nclk = tegra_clk_register_pll("pll_d", "pll_ref", clk_base, pmc, 0,\r\n0, &pll_d_params,\r\nTEGRA_PLL_HAS_CPCON | TEGRA_PLL_SET_LFCON |\r\nTEGRA_PLL_USE_LOCK, pll_d_freq_table, &pll_d_lock);\r\nclk_register_clkdev(clk, "pll_d", NULL);\r\nclks[pll_d] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_d_out0", "pll_d",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclk_register_clkdev(clk, "pll_d_out0", NULL);\r\nclks[pll_d_out0] = clk;\r\nclk = tegra_clk_register_pll("pll_d2", "pll_ref", clk_base, pmc, 0,\r\n0, &pll_d2_params,\r\nTEGRA_PLL_HAS_CPCON | TEGRA_PLL_SET_LFCON |\r\nTEGRA_PLL_USE_LOCK, pll_d_freq_table, &pll_d2_lock);\r\nclk_register_clkdev(clk, "pll_d2", NULL);\r\nclks[pll_d2] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_d2_out0", "pll_d2",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclk_register_clkdev(clk, "pll_d2_out0", NULL);\r\nclks[pll_d2_out0] = clk;\r\nclk = tegra_clk_register_pll("pll_a", "pll_p_out1", clk_base, pmc, 0,\r\n0, &pll_a_params, TEGRA_PLL_HAS_CPCON |\r\nTEGRA_PLL_USE_LOCK, pll_a_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_a", NULL);\r\nclks[pll_a] = clk;\r\nclk = tegra_clk_register_divider("pll_a_out0_div", "pll_a",\r\nclk_base + PLLA_OUT, 0, TEGRA_DIVIDER_ROUND_UP,\r\n8, 8, 1, NULL);\r\nclk = tegra_clk_register_pll_out("pll_a_out0", "pll_a_out0_div",\r\nclk_base + PLLA_OUT, 1, 0, CLK_IGNORE_UNUSED |\r\nCLK_SET_RATE_PARENT, 0, NULL);\r\nclk_register_clkdev(clk, "pll_a_out0", NULL);\r\nclks[pll_a_out0] = clk;\r\n_clip_vco_min(&pll_re_vco_params);\r\nclk = tegra_clk_register_pllre("pll_re_vco", "pll_ref", clk_base, pmc,\r\n0, 0, &pll_re_vco_params, TEGRA_PLL_USE_LOCK,\r\nNULL, &pll_re_lock, pll_ref_freq);\r\nclk_register_clkdev(clk, "pll_re_vco", NULL);\r\nclks[pll_re_vco] = clk;\r\nclk = clk_register_divider_table(NULL, "pll_re_out", "pll_re_vco", 0,\r\nclk_base + PLLRE_BASE, 16, 4, 0,\r\npll_re_div_table, &pll_re_lock);\r\nclk_register_clkdev(clk, "pll_re_out", NULL);\r\nclks[pll_re_out] = clk;\r\nclk = tegra_clk_register_plle_tegra114("pll_e_out0", "pll_re_vco",\r\nclk_base, 0, 100000000, &pll_e_params,\r\npll_e_freq_table, NULL);\r\nclk_register_clkdev(clk, "pll_e_out0", NULL);\r\nclks[pll_e_out0] = clk;\r\n}\r\nstatic void __init tegra114_audio_clk_init(void __iomem *clk_base)\r\n{\r\nstruct clk *clk;\r\nclk = tegra_clk_register_sync_source("spdif_in_sync", 24000000,\r\n24000000);\r\nclk_register_clkdev(clk, "spdif_in_sync", NULL);\r\nclks[spdif_in_sync] = clk;\r\nclk = tegra_clk_register_sync_source("i2s0_sync", 24000000, 24000000);\r\nclk_register_clkdev(clk, "i2s0_sync", NULL);\r\nclks[i2s0_sync] = clk;\r\nclk = tegra_clk_register_sync_source("i2s1_sync", 24000000, 24000000);\r\nclk_register_clkdev(clk, "i2s1_sync", NULL);\r\nclks[i2s1_sync] = clk;\r\nclk = tegra_clk_register_sync_source("i2s2_sync", 24000000, 24000000);\r\nclk_register_clkdev(clk, "i2s2_sync", NULL);\r\nclks[i2s2_sync] = clk;\r\nclk = tegra_clk_register_sync_source("i2s3_sync", 24000000, 24000000);\r\nclk_register_clkdev(clk, "i2s3_sync", NULL);\r\nclks[i2s3_sync] = clk;\r\nclk = tegra_clk_register_sync_source("i2s4_sync", 24000000, 24000000);\r\nclk_register_clkdev(clk, "i2s4_sync", NULL);\r\nclks[i2s4_sync] = clk;\r\nclk = tegra_clk_register_sync_source("vimclk_sync", 24000000, 24000000);\r\nclk_register_clkdev(clk, "vimclk_sync", NULL);\r\nclks[vimclk_sync] = clk;\r\nclk = clk_register_mux(NULL, "audio0_mux", mux_audio_sync_clk,\r\nARRAY_SIZE(mux_audio_sync_clk),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + AUDIO_SYNC_CLK_I2S0, 0, 3, 0,\r\nNULL);\r\nclks[audio0_mux] = clk;\r\nclk = clk_register_gate(NULL, "audio0", "audio0_mux", 0,\r\nclk_base + AUDIO_SYNC_CLK_I2S0, 4,\r\nCLK_GATE_SET_TO_DISABLE, NULL);\r\nclk_register_clkdev(clk, "audio0", NULL);\r\nclks[audio0] = clk;\r\nclk = clk_register_mux(NULL, "audio1_mux", mux_audio_sync_clk,\r\nARRAY_SIZE(mux_audio_sync_clk),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + AUDIO_SYNC_CLK_I2S1, 0, 3, 0,\r\nNULL);\r\nclks[audio1_mux] = clk;\r\nclk = clk_register_gate(NULL, "audio1", "audio1_mux", 0,\r\nclk_base + AUDIO_SYNC_CLK_I2S1, 4,\r\nCLK_GATE_SET_TO_DISABLE, NULL);\r\nclk_register_clkdev(clk, "audio1", NULL);\r\nclks[audio1] = clk;\r\nclk = clk_register_mux(NULL, "audio2_mux", mux_audio_sync_clk,\r\nARRAY_SIZE(mux_audio_sync_clk),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + AUDIO_SYNC_CLK_I2S2, 0, 3, 0,\r\nNULL);\r\nclks[audio2_mux] = clk;\r\nclk = clk_register_gate(NULL, "audio2", "audio2_mux", 0,\r\nclk_base + AUDIO_SYNC_CLK_I2S2, 4,\r\nCLK_GATE_SET_TO_DISABLE, NULL);\r\nclk_register_clkdev(clk, "audio2", NULL);\r\nclks[audio2] = clk;\r\nclk = clk_register_mux(NULL, "audio3_mux", mux_audio_sync_clk,\r\nARRAY_SIZE(mux_audio_sync_clk),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + AUDIO_SYNC_CLK_I2S3, 0, 3, 0,\r\nNULL);\r\nclks[audio3_mux] = clk;\r\nclk = clk_register_gate(NULL, "audio3", "audio3_mux", 0,\r\nclk_base + AUDIO_SYNC_CLK_I2S3, 4,\r\nCLK_GATE_SET_TO_DISABLE, NULL);\r\nclk_register_clkdev(clk, "audio3", NULL);\r\nclks[audio3] = clk;\r\nclk = clk_register_mux(NULL, "audio4_mux", mux_audio_sync_clk,\r\nARRAY_SIZE(mux_audio_sync_clk),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + AUDIO_SYNC_CLK_I2S4, 0, 3, 0,\r\nNULL);\r\nclks[audio4_mux] = clk;\r\nclk = clk_register_gate(NULL, "audio4", "audio4_mux", 0,\r\nclk_base + AUDIO_SYNC_CLK_I2S4, 4,\r\nCLK_GATE_SET_TO_DISABLE, NULL);\r\nclk_register_clkdev(clk, "audio4", NULL);\r\nclks[audio4] = clk;\r\nclk = clk_register_mux(NULL, "spdif_mux", mux_audio_sync_clk,\r\nARRAY_SIZE(mux_audio_sync_clk),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + AUDIO_SYNC_CLK_SPDIF, 0, 3, 0,\r\nNULL);\r\nclks[spdif_mux] = clk;\r\nclk = clk_register_gate(NULL, "spdif", "spdif_mux", 0,\r\nclk_base + AUDIO_SYNC_CLK_SPDIF, 4,\r\nCLK_GATE_SET_TO_DISABLE, NULL);\r\nclk_register_clkdev(clk, "spdif", NULL);\r\nclks[spdif] = clk;\r\nclk = clk_register_fixed_factor(NULL, "audio0_doubler", "audio0",\r\nCLK_SET_RATE_PARENT, 2, 1);\r\nclk = tegra_clk_register_divider("audio0_div", "audio0_doubler",\r\nclk_base + AUDIO_SYNC_DOUBLER, 0, 0, 24, 1,\r\n0, &clk_doubler_lock);\r\nclk = tegra_clk_register_periph_gate("audio0_2x", "audio0_div",\r\nTEGRA_PERIPH_NO_RESET, clk_base,\r\nCLK_SET_RATE_PARENT, 113, &periph_v_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "audio0_2x", NULL);\r\nclks[audio0_2x] = clk;\r\nclk = clk_register_fixed_factor(NULL, "audio1_doubler", "audio1",\r\nCLK_SET_RATE_PARENT, 2, 1);\r\nclk = tegra_clk_register_divider("audio1_div", "audio1_doubler",\r\nclk_base + AUDIO_SYNC_DOUBLER, 0, 0, 25, 1,\r\n0, &clk_doubler_lock);\r\nclk = tegra_clk_register_periph_gate("audio1_2x", "audio1_div",\r\nTEGRA_PERIPH_NO_RESET, clk_base,\r\nCLK_SET_RATE_PARENT, 114, &periph_v_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "audio1_2x", NULL);\r\nclks[audio1_2x] = clk;\r\nclk = clk_register_fixed_factor(NULL, "audio2_doubler", "audio2",\r\nCLK_SET_RATE_PARENT, 2, 1);\r\nclk = tegra_clk_register_divider("audio2_div", "audio2_doubler",\r\nclk_base + AUDIO_SYNC_DOUBLER, 0, 0, 26, 1,\r\n0, &clk_doubler_lock);\r\nclk = tegra_clk_register_periph_gate("audio2_2x", "audio2_div",\r\nTEGRA_PERIPH_NO_RESET, clk_base,\r\nCLK_SET_RATE_PARENT, 115, &periph_v_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "audio2_2x", NULL);\r\nclks[audio2_2x] = clk;\r\nclk = clk_register_fixed_factor(NULL, "audio3_doubler", "audio3",\r\nCLK_SET_RATE_PARENT, 2, 1);\r\nclk = tegra_clk_register_divider("audio3_div", "audio3_doubler",\r\nclk_base + AUDIO_SYNC_DOUBLER, 0, 0, 27, 1,\r\n0, &clk_doubler_lock);\r\nclk = tegra_clk_register_periph_gate("audio3_2x", "audio3_div",\r\nTEGRA_PERIPH_NO_RESET, clk_base,\r\nCLK_SET_RATE_PARENT, 116, &periph_v_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "audio3_2x", NULL);\r\nclks[audio3_2x] = clk;\r\nclk = clk_register_fixed_factor(NULL, "audio4_doubler", "audio4",\r\nCLK_SET_RATE_PARENT, 2, 1);\r\nclk = tegra_clk_register_divider("audio4_div", "audio4_doubler",\r\nclk_base + AUDIO_SYNC_DOUBLER, 0, 0, 28, 1,\r\n0, &clk_doubler_lock);\r\nclk = tegra_clk_register_periph_gate("audio4_2x", "audio4_div",\r\nTEGRA_PERIPH_NO_RESET, clk_base,\r\nCLK_SET_RATE_PARENT, 117, &periph_v_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "audio4_2x", NULL);\r\nclks[audio4_2x] = clk;\r\nclk = clk_register_fixed_factor(NULL, "spdif_doubler", "spdif",\r\nCLK_SET_RATE_PARENT, 2, 1);\r\nclk = tegra_clk_register_divider("spdif_div", "spdif_doubler",\r\nclk_base + AUDIO_SYNC_DOUBLER, 0, 0, 29, 1,\r\n0, &clk_doubler_lock);\r\nclk = tegra_clk_register_periph_gate("spdif_2x", "spdif_div",\r\nTEGRA_PERIPH_NO_RESET, clk_base,\r\nCLK_SET_RATE_PARENT, 118,\r\n&periph_v_regs, periph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, "spdif_2x", NULL);\r\nclks[spdif_2x] = clk;\r\n}\r\nstatic void __init tegra114_pmc_clk_init(void __iomem *pmc_base)\r\n{\r\nstruct clk *clk;\r\nclk = clk_register_mux(NULL, "clk_out_1_mux", clk_out1_parents,\r\nARRAY_SIZE(clk_out1_parents),\r\nCLK_SET_RATE_NO_REPARENT,\r\npmc_base + PMC_CLK_OUT_CNTRL, 6, 3, 0,\r\n&clk_out_lock);\r\nclks[clk_out_1_mux] = clk;\r\nclk = clk_register_gate(NULL, "clk_out_1", "clk_out_1_mux", 0,\r\npmc_base + PMC_CLK_OUT_CNTRL, 2, 0,\r\n&clk_out_lock);\r\nclk_register_clkdev(clk, "extern1", "clk_out_1");\r\nclks[clk_out_1] = clk;\r\nclk = clk_register_mux(NULL, "clk_out_2_mux", clk_out2_parents,\r\nARRAY_SIZE(clk_out2_parents),\r\nCLK_SET_RATE_NO_REPARENT,\r\npmc_base + PMC_CLK_OUT_CNTRL, 14, 3, 0,\r\n&clk_out_lock);\r\nclks[clk_out_2_mux] = clk;\r\nclk = clk_register_gate(NULL, "clk_out_2", "clk_out_2_mux", 0,\r\npmc_base + PMC_CLK_OUT_CNTRL, 10, 0,\r\n&clk_out_lock);\r\nclk_register_clkdev(clk, "extern2", "clk_out_2");\r\nclks[clk_out_2] = clk;\r\nclk = clk_register_mux(NULL, "clk_out_3_mux", clk_out3_parents,\r\nARRAY_SIZE(clk_out3_parents),\r\nCLK_SET_RATE_NO_REPARENT,\r\npmc_base + PMC_CLK_OUT_CNTRL, 22, 3, 0,\r\n&clk_out_lock);\r\nclks[clk_out_3_mux] = clk;\r\nclk = clk_register_gate(NULL, "clk_out_3", "clk_out_3_mux", 0,\r\npmc_base + PMC_CLK_OUT_CNTRL, 18, 0,\r\n&clk_out_lock);\r\nclk_register_clkdev(clk, "extern3", "clk_out_3");\r\nclks[clk_out_3] = clk;\r\nwritel_relaxed(0, pmc_base + PMC_BLINK_TIMER);\r\nclk = clk_register_gate(NULL, "blink_override", "clk_32k", 0,\r\npmc_base + PMC_DPD_PADS_ORIDE,\r\nPMC_DPD_PADS_ORIDE_BLINK_ENB, 0, NULL);\r\nclk = clk_register_gate(NULL, "blink", "blink_override", 0,\r\npmc_base + PMC_CTRL,\r\nPMC_CTRL_BLINK_ENB, 0, NULL);\r\nclk_register_clkdev(clk, "blink", NULL);\r\nclks[blink] = clk;\r\n}\r\nstatic void __init tegra114_super_clk_init(void __iomem *clk_base)\r\n{\r\nstruct clk *clk;\r\nclk = tegra_clk_register_super_mux("cclk_g", cclk_g_parents,\r\nARRAY_SIZE(cclk_g_parents),\r\nCLK_SET_RATE_PARENT,\r\nclk_base + CCLKG_BURST_POLICY,\r\n0, 4, 0, 0, NULL);\r\nclk_register_clkdev(clk, "cclk_g", NULL);\r\nclks[cclk_g] = clk;\r\nclk = tegra_clk_register_super_mux("cclk_lp", cclk_lp_parents,\r\nARRAY_SIZE(cclk_lp_parents),\r\nCLK_SET_RATE_PARENT,\r\nclk_base + CCLKLP_BURST_POLICY,\r\n0, 4, 8, 9, NULL);\r\nclk_register_clkdev(clk, "cclk_lp", NULL);\r\nclks[cclk_lp] = clk;\r\nclk = tegra_clk_register_super_mux("sclk", sclk_parents,\r\nARRAY_SIZE(sclk_parents),\r\nCLK_SET_RATE_PARENT,\r\nclk_base + SCLK_BURST_POLICY,\r\n0, 4, 0, 0, NULL);\r\nclk_register_clkdev(clk, "sclk", NULL);\r\nclks[sclk] = clk;\r\nclk = clk_register_divider(NULL, "hclk_div", "sclk", 0,\r\nclk_base + SYSTEM_CLK_RATE, 4, 2, 0,\r\n&sysrate_lock);\r\nclk = clk_register_gate(NULL, "hclk", "hclk_div", CLK_SET_RATE_PARENT |\r\nCLK_IGNORE_UNUSED, clk_base + SYSTEM_CLK_RATE,\r\n7, CLK_GATE_SET_TO_DISABLE, &sysrate_lock);\r\nclk_register_clkdev(clk, "hclk", NULL);\r\nclks[hclk] = clk;\r\nclk = clk_register_divider(NULL, "pclk_div", "hclk", 0,\r\nclk_base + SYSTEM_CLK_RATE, 0, 2, 0,\r\n&sysrate_lock);\r\nclk = clk_register_gate(NULL, "pclk", "pclk_div", CLK_SET_RATE_PARENT |\r\nCLK_IGNORE_UNUSED, clk_base + SYSTEM_CLK_RATE,\r\n3, CLK_GATE_SET_TO_DISABLE, &sysrate_lock);\r\nclk_register_clkdev(clk, "pclk", NULL);\r\nclks[pclk] = clk;\r\n}\r\nstatic __init void tegra114_periph_clk_init(void __iomem *clk_base)\r\n{\r\nstruct tegra_periph_init_data *data;\r\nstruct clk *clk;\r\nint i;\r\nu32 val;\r\nclk = tegra_clk_register_periph_gate("apbdma", "clk_m", 0, clk_base,\r\n0, 34, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[apbdma] = clk;\r\nclk = tegra_clk_register_periph_gate("rtc", "clk_32k",\r\nTEGRA_PERIPH_ON_APB |\r\nTEGRA_PERIPH_NO_RESET, clk_base,\r\n0, 4, &periph_l_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, NULL, "rtc-tegra");\r\nclks[rtc] = clk;\r\nclk = tegra_clk_register_periph_gate("kbc", "clk_32k",\r\nTEGRA_PERIPH_ON_APB |\r\nTEGRA_PERIPH_NO_RESET, clk_base,\r\n0, 36, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[kbc] = clk;\r\nclk = tegra_clk_register_periph_gate("timer", "clk_m", 0, clk_base,\r\n0, 5, &periph_l_regs,\r\nperiph_clk_enb_refcnt);\r\nclk_register_clkdev(clk, NULL, "timer");\r\nclks[timer] = clk;\r\nclk = tegra_clk_register_periph_gate("kfuse", "clk_m",\r\nTEGRA_PERIPH_ON_APB, clk_base, 0, 40,\r\n&periph_h_regs, periph_clk_enb_refcnt);\r\nclks[kfuse] = clk;\r\nclk = tegra_clk_register_periph_gate("fuse", "clk_m",\r\nTEGRA_PERIPH_ON_APB, clk_base, 0, 39,\r\n&periph_h_regs, periph_clk_enb_refcnt);\r\nclks[fuse] = clk;\r\nclk = tegra_clk_register_periph_gate("fuse_burn", "clk_m",\r\nTEGRA_PERIPH_ON_APB, clk_base, 0, 39,\r\n&periph_h_regs, periph_clk_enb_refcnt);\r\nclks[fuse_burn] = clk;\r\nclk = tegra_clk_register_periph_gate("apbif", "clk_m",\r\nTEGRA_PERIPH_ON_APB, clk_base, 0, 107,\r\n&periph_v_regs, periph_clk_enb_refcnt);\r\nclks[apbif] = clk;\r\nclk = tegra_clk_register_periph_gate("hda2hdmi", "clk_m",\r\nTEGRA_PERIPH_ON_APB, clk_base, 0, 128,\r\n&periph_w_regs, periph_clk_enb_refcnt);\r\nclks[hda2hdmi] = clk;\r\nclk = tegra_clk_register_periph_gate("vcp", "clk_m", 0, clk_base, 0,\r\n29, &periph_l_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[vcp] = clk;\r\nclk = tegra_clk_register_periph_gate("bsea", "clk_m", 0, clk_base,\r\n0, 62, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[bsea] = clk;\r\nclk = tegra_clk_register_periph_gate("bsev", "clk_m", 0, clk_base,\r\n0, 63, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[bsev] = clk;\r\nclk = tegra_clk_register_periph_gate("mipi-cal", "clk_m", 0, clk_base,\r\n0, 56, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[mipi_cal] = clk;\r\nclk = tegra_clk_register_periph_gate("usbd", "clk_m", 0, clk_base,\r\n0, 22, &periph_l_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[usbd] = clk;\r\nclk = tegra_clk_register_periph_gate("usb2", "clk_m", 0, clk_base,\r\n0, 58, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[usb2] = clk;\r\nclk = tegra_clk_register_periph_gate("usb3", "clk_m", 0, clk_base,\r\n0, 59, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[usb3] = clk;\r\nclk = tegra_clk_register_periph_gate("csi", "pll_p_out3", 0, clk_base,\r\n0, 52, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[csi] = clk;\r\nclk = tegra_clk_register_periph_gate("isp", "clk_m", 0, clk_base, 0,\r\n23, &periph_l_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[isp] = clk;\r\nclk = tegra_clk_register_periph_gate("csus", "clk_m",\r\nTEGRA_PERIPH_NO_RESET, clk_base, 0, 92,\r\n&periph_u_regs, periph_clk_enb_refcnt);\r\nclks[csus] = clk;\r\nclk = tegra_clk_register_periph_gate("dds", "clk_m",\r\nTEGRA_PERIPH_ON_APB, clk_base, 0, 150,\r\n&periph_w_regs, periph_clk_enb_refcnt);\r\nclks[dds] = clk;\r\nclk = tegra_clk_register_periph_gate("dp2", "clk_m",\r\nTEGRA_PERIPH_ON_APB, clk_base, 0, 152,\r\n&periph_w_regs, periph_clk_enb_refcnt);\r\nclks[dp2] = clk;\r\nclk = tegra_clk_register_periph_gate("dtv", "clk_m",\r\nTEGRA_PERIPH_ON_APB, clk_base, 0, 79,\r\n&periph_u_regs, periph_clk_enb_refcnt);\r\nclks[dtv] = clk;\r\nclk = clk_register_mux(NULL, "dsia_mux", mux_plld_out0_plld2_out0,\r\nARRAY_SIZE(mux_plld_out0_plld2_out0),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + PLLD_BASE, 25, 1, 0, &pll_d_lock);\r\nclks[dsia_mux] = clk;\r\nclk = tegra_clk_register_periph_gate("dsia", "dsia_mux", 0, clk_base,\r\n0, 48, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[dsia] = clk;\r\nclk = clk_register_mux(NULL, "dsib_mux", mux_plld_out0_plld2_out0,\r\nARRAY_SIZE(mux_plld_out0_plld2_out0),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + PLLD2_BASE, 25, 1, 0, &pll_d2_lock);\r\nclks[dsib_mux] = clk;\r\nclk = tegra_clk_register_periph_gate("dsib", "dsib_mux", 0, clk_base,\r\n0, 82, &periph_u_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[dsib] = clk;\r\nval = readl(clk_base + CLK_SOURCE_XUSB_SS_SRC);\r\nval |= BIT(25);\r\nwritel(val, clk_base + CLK_SOURCE_XUSB_SS_SRC);\r\nclk = clk_register_fixed_factor(NULL, "xusb_hs_src", "pll_u_60M", 0,\r\n1, 1);\r\nclks[xusb_hs_src] = clk;\r\nclk = tegra_clk_register_periph_gate("xusb_host", "xusb_host_src", 0,\r\nclk_base, 0, 89, &periph_u_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[xusb_host] = clk;\r\nclk = tegra_clk_register_periph_gate("xusb_ss", "xusb_ss_src", 0,\r\nclk_base, 0, 156, &periph_w_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[xusb_host] = clk;\r\nclk = tegra_clk_register_periph_gate("xusb_dev", "xusb_dev_src", 0,\r\nclk_base, 0, 95, &periph_u_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[xusb_dev] = clk;\r\nclk = clk_register_mux(NULL, "emc_mux", mux_pllmcp_clkm,\r\nARRAY_SIZE(mux_pllmcp_clkm),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + CLK_SOURCE_EMC,\r\n29, 3, 0, NULL);\r\nclk = tegra_clk_register_periph_gate("emc", "emc_mux", 0, clk_base,\r\nCLK_IGNORE_UNUSED, 57, &periph_h_regs,\r\nperiph_clk_enb_refcnt);\r\nclks[emc] = clk;\r\nfor (i = 0; i < ARRAY_SIZE(tegra_periph_clk_list); i++) {\r\ndata = &tegra_periph_clk_list[i];\r\nclk = tegra_clk_register_periph(data->name, data->parent_names,\r\ndata->num_parents, &data->periph,\r\nclk_base, data->offset, data->flags);\r\nclks[data->clk_id] = clk;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(tegra_periph_nodiv_clk_list); i++) {\r\ndata = &tegra_periph_nodiv_clk_list[i];\r\nclk = tegra_clk_register_periph_nodiv(data->name,\r\ndata->parent_names, data->num_parents,\r\n&data->periph, clk_base, data->offset);\r\nclks[data->clk_id] = clk;\r\n}\r\n}\r\nstatic void tegra114_wait_cpu_in_reset(u32 cpu)\r\n{\r\nunsigned int reg;\r\ndo {\r\nreg = readl(clk_base + CLK_RST_CONTROLLER_CPU_CMPLX_STATUS);\r\ncpu_relax();\r\n} while (!(reg & (1 << cpu)));\r\n}\r\nstatic void tegra114_disable_cpu_clock(u32 cpu)\r\n{\r\n}\r\nstatic void tegra114_cpu_clock_suspend(void)\r\n{\r\ntegra114_cpu_clk_sctx.clk_csite_src =\r\nreadl(clk_base + CLK_SOURCE_CSITE);\r\nwritel(3 << 30, clk_base + CLK_SOURCE_CSITE);\r\ntegra114_cpu_clk_sctx.cclkg_burst =\r\nreadl(clk_base + CCLKG_BURST_POLICY);\r\ntegra114_cpu_clk_sctx.cclkg_divider =\r\nreadl(clk_base + CCLKG_BURST_POLICY + 4);\r\n}\r\nstatic void tegra114_cpu_clock_resume(void)\r\n{\r\nwritel(tegra114_cpu_clk_sctx.clk_csite_src,\r\nclk_base + CLK_SOURCE_CSITE);\r\nwritel(tegra114_cpu_clk_sctx.cclkg_burst,\r\nclk_base + CCLKG_BURST_POLICY);\r\nwritel(tegra114_cpu_clk_sctx.cclkg_divider,\r\nclk_base + CCLKG_BURST_POLICY + 4);\r\n}\r\nstatic void __init tegra114_clock_apply_init_table(void)\r\n{\r\ntegra_init_from_table(init_table, clks, clk_max);\r\n}\r\nstatic void tegra114_car_barrier(void)\r\n{\r\nwmb();\r\nreadl_relaxed(clk_base + CPU_FINETRIM_SELECT);\r\n}\r\nvoid tegra114_clock_tune_cpu_trimmers_high(void)\r\n{\r\nu32 select = 0;\r\nselect |= ~(CPU_FINETRIM_1_FCPU_1 | CPU_FINETRIM_1_FCPU_2 |\r\nCPU_FINETRIM_1_FCPU_3 | CPU_FINETRIM_1_FCPU_4 |\r\nCPU_FINETRIM_1_FCPU_5 | CPU_FINETRIM_1_FCPU_6);\r\nwritel_relaxed(select, clk_base + CPU_FINETRIM_SELECT);\r\ntegra114_car_barrier();\r\n}\r\nvoid tegra114_clock_tune_cpu_trimmers_low(void)\r\n{\r\nu32 select = 0;\r\nselect |= (CPU_FINETRIM_1_FCPU_1 | CPU_FINETRIM_1_FCPU_2 |\r\nCPU_FINETRIM_1_FCPU_3 | CPU_FINETRIM_1_FCPU_4 |\r\nCPU_FINETRIM_1_FCPU_5 | CPU_FINETRIM_1_FCPU_6);\r\nwritel_relaxed(select, clk_base + CPU_FINETRIM_SELECT);\r\ntegra114_car_barrier();\r\n}\r\nvoid tegra114_clock_tune_cpu_trimmers_init(void)\r\n{\r\nu32 dr = 0, r = 0;\r\nr |= (CPU_FINETRIM_R_FCPU_1_MASK | CPU_FINETRIM_R_FCPU_2_MASK |\r\nCPU_FINETRIM_R_FCPU_3_MASK | CPU_FINETRIM_R_FCPU_4_MASK |\r\nCPU_FINETRIM_R_FCPU_5_MASK | CPU_FINETRIM_R_FCPU_6_MASK);\r\nwritel_relaxed(r, clk_base + CPU_FINETRIM_R);\r\ndr |= (CPU_FINETRIM_1_FCPU_1 | CPU_FINETRIM_1_FCPU_2 |\r\nCPU_FINETRIM_1_FCPU_3 | CPU_FINETRIM_1_FCPU_4 |\r\nCPU_FINETRIM_1_FCPU_5 | CPU_FINETRIM_1_FCPU_6);\r\nwritel_relaxed(dr, clk_base + CPU_FINETRIM_DR);\r\ntegra114_clock_tune_cpu_trimmers_low();\r\n}\r\nvoid tegra114_clock_assert_dfll_dvco_reset(void)\r\n{\r\nu32 v;\r\nv = readl_relaxed(clk_base + RST_DFLL_DVCO);\r\nv |= (1 << DVFS_DFLL_RESET_SHIFT);\r\nwritel_relaxed(v, clk_base + RST_DFLL_DVCO);\r\ntegra114_car_barrier();\r\n}\r\nvoid tegra114_clock_deassert_dfll_dvco_reset(void)\r\n{\r\nu32 v;\r\nv = readl_relaxed(clk_base + RST_DFLL_DVCO);\r\nv &= ~(1 << DVFS_DFLL_RESET_SHIFT);\r\nwritel_relaxed(v, clk_base + RST_DFLL_DVCO);\r\ntegra114_car_barrier();\r\n}\r\nstatic void __init tegra114_clock_init(struct device_node *np)\r\n{\r\nstruct device_node *node;\r\nint i;\r\nclk_base = of_iomap(np, 0);\r\nif (!clk_base) {\r\npr_err("ioremap tegra114 CAR failed\n");\r\nreturn;\r\n}\r\nnode = of_find_matching_node(NULL, pmc_match);\r\nif (!node) {\r\npr_err("Failed to find pmc node\n");\r\nWARN_ON(1);\r\nreturn;\r\n}\r\npmc_base = of_iomap(node, 0);\r\nif (!pmc_base) {\r\npr_err("Can't map pmc registers\n");\r\nWARN_ON(1);\r\nreturn;\r\n}\r\nif (tegra114_osc_clk_init(clk_base) < 0)\r\nreturn;\r\ntegra114_fixed_clk_init(clk_base);\r\ntegra114_pll_init(clk_base, pmc_base);\r\ntegra114_periph_clk_init(clk_base);\r\ntegra114_audio_clk_init(clk_base);\r\ntegra114_pmc_clk_init(pmc_base);\r\ntegra114_super_clk_init(clk_base);\r\nfor (i = 0; i < ARRAY_SIZE(clks); i++) {\r\nif (IS_ERR(clks[i])) {\r\npr_err\r\n("Tegra114 clk %d: register failed with %ld\n",\r\ni, PTR_ERR(clks[i]));\r\n}\r\nif (!clks[i])\r\nclks[i] = ERR_PTR(-EINVAL);\r\n}\r\nclk_data.clks = clks;\r\nclk_data.clk_num = ARRAY_SIZE(clks);\r\nof_clk_add_provider(np, of_clk_src_onecell_get, &clk_data);\r\ntegra_clk_apply_init_table = tegra114_clock_apply_init_table;\r\ntegra_cpu_car_ops = &tegra114_cpu_car_ops;\r\n}

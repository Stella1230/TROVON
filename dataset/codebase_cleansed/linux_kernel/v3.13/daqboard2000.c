static void writeAcqScanListEntry(struct comedi_device *dev, u16 entry)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nwritew(entry & 0x00ff, devpriv->daq + acqScanListFIFO);\r\nwritew((entry >> 8) & 0x00ff, devpriv->daq + acqScanListFIFO);\r\n}\r\nstatic void setup_sampling(struct comedi_device *dev, int chan, int gain)\r\n{\r\nu16 word0, word1, word2, word3;\r\nword0 = 0;\r\nword1 = 0x0004;\r\nword2 = (chan << 6) & 0x00c0;\r\nswitch (chan / 4) {\r\ncase 0:\r\nword3 = 0x0001;\r\nbreak;\r\ncase 1:\r\nword3 = 0x0002;\r\nbreak;\r\ncase 2:\r\nword3 = 0x0005;\r\nbreak;\r\ncase 3:\r\nword3 = 0x0006;\r\nbreak;\r\ncase 4:\r\nword3 = 0x0041;\r\nbreak;\r\ncase 5:\r\nword3 = 0x0042;\r\nbreak;\r\ndefault:\r\nword3 = 0;\r\nbreak;\r\n}\r\nword2 |= 0x0800;\r\nword3 |= 0xc000;\r\nwriteAcqScanListEntry(dev, word0);\r\nwriteAcqScanListEntry(dev, word1);\r\nwriteAcqScanListEntry(dev, word2);\r\nwriteAcqScanListEntry(dev, word3);\r\n}\r\nstatic int daqboard2000_ai_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nunsigned int val;\r\nint gain, chan, timeout;\r\nint i;\r\nwritew(DAQBOARD2000_AcqResetScanListFifo |\r\nDAQBOARD2000_AcqResetResultsFifo |\r\nDAQBOARD2000_AcqResetConfigPipe, devpriv->daq + acqControl);\r\nwritel(1000000, devpriv->daq + acqPacerClockDivLow);\r\nwritew(0, devpriv->daq + acqPacerClockDivHigh);\r\ngain = CR_RANGE(insn->chanspec);\r\nchan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++) {\r\nsetup_sampling(dev, chan, gain);\r\nwritew(DAQBOARD2000_SeqStartScanList,\r\ndevpriv->daq + acqControl);\r\nfor (timeout = 0; timeout < 20; timeout++) {\r\nval = readw(devpriv->daq + acqControl);\r\nif (val & DAQBOARD2000_AcqConfigPipeFull)\r\nbreak;\r\n}\r\nwritew(DAQBOARD2000_AdcPacerEnable, devpriv->daq + acqControl);\r\nfor (timeout = 0; timeout < 20; timeout++) {\r\nval = readw(devpriv->daq + acqControl);\r\nif (val & DAQBOARD2000_AcqLogicScanning)\r\nbreak;\r\n}\r\nfor (timeout = 0; timeout < 20; timeout++) {\r\nval = readw(devpriv->daq + acqControl);\r\nif (val & DAQBOARD2000_AcqResultsFIFOHasValidData)\r\nbreak;\r\n}\r\ndata[i] = readw(devpriv->daq + acqResultsFIFO);\r\nwritew(DAQBOARD2000_AdcPacerDisable, devpriv->daq + acqControl);\r\nwritew(DAQBOARD2000_SeqStopScanList, devpriv->daq + acqControl);\r\n}\r\nreturn i;\r\n}\r\nstatic int daqboard2000_ao_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nint chan = CR_CHAN(insn->chanspec);\r\nint i;\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = devpriv->ao_readback[chan];\r\nreturn i;\r\n}\r\nstatic int daqboard2000_ao_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nint chan = CR_CHAN(insn->chanspec);\r\nunsigned int val;\r\nint timeout;\r\nint i;\r\nfor (i = 0; i < insn->n; i++) {\r\n#if 0\r\nwritew((chan + 2) * 0x0010 | 0x0001,\r\ndevpriv->daq + dacControl);\r\nudelay(1000);\r\n#endif\r\nwritew(data[i], devpriv->daq + dacSetting(chan));\r\nfor (timeout = 0; timeout < 20; timeout++) {\r\nval = readw(devpriv->daq + dacControl);\r\nif ((val & ((chan + 1) * 0x0010)) == 0)\r\nbreak;\r\n}\r\ndevpriv->ao_readback[chan] = data[i];\r\n#if 0\r\nwritew((chan + 2) * 0x0010 | 0x0000,\r\ndevpriv->daq + dacControl);\r\nudelay(1000);\r\n#endif\r\n}\r\nreturn i;\r\n}\r\nstatic void daqboard2000_resetLocalBus(struct comedi_device *dev)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nwritel(DAQBOARD2000_SECRLocalBusHi, devpriv->plx + 0x6c);\r\nmdelay(10);\r\nwritel(DAQBOARD2000_SECRLocalBusLo, devpriv->plx + 0x6c);\r\nmdelay(10);\r\n}\r\nstatic void daqboard2000_reloadPLX(struct comedi_device *dev)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nwritel(DAQBOARD2000_SECRReloadLo, devpriv->plx + 0x6c);\r\nmdelay(10);\r\nwritel(DAQBOARD2000_SECRReloadHi, devpriv->plx + 0x6c);\r\nmdelay(10);\r\nwritel(DAQBOARD2000_SECRReloadLo, devpriv->plx + 0x6c);\r\nmdelay(10);\r\n}\r\nstatic void daqboard2000_pulseProgPin(struct comedi_device *dev)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nwritel(DAQBOARD2000_SECRProgPinHi, devpriv->plx + 0x6c);\r\nmdelay(10);\r\nwritel(DAQBOARD2000_SECRProgPinLo, devpriv->plx + 0x6c);\r\nmdelay(10);\r\n}\r\nstatic int daqboard2000_pollCPLD(struct comedi_device *dev, int mask)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nint result = 0;\r\nint i;\r\nint cpld;\r\nfor (i = 0; i < 50; i++) {\r\ncpld = readw(devpriv->daq + 0x1000);\r\nif ((cpld & mask) == mask) {\r\nresult = 1;\r\nbreak;\r\n}\r\nudelay(100);\r\n}\r\nudelay(5);\r\nreturn result;\r\n}\r\nstatic int daqboard2000_writeCPLD(struct comedi_device *dev, int data)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nint result = 0;\r\nudelay(10);\r\nwritew(data, devpriv->daq + 0x1000);\r\nif ((readw(devpriv->daq + 0x1000) & DAQBOARD2000_CPLD_INIT) ==\r\nDAQBOARD2000_CPLD_INIT) {\r\nresult = 1;\r\n}\r\nreturn result;\r\n}\r\nstatic int initialize_daqboard2000(struct comedi_device *dev,\r\nconst u8 *cpld_array, size_t len,\r\nunsigned long context)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nint result = -EIO;\r\nint secr;\r\nint retry;\r\nsize_t i;\r\nsecr = readl(devpriv->plx + 0x6c);\r\nif (!(secr & DAQBOARD2000_EEPROM_PRESENT))\r\nreturn -EIO;\r\nfor (retry = 0; retry < 3; retry++) {\r\ndaqboard2000_resetLocalBus(dev);\r\ndaqboard2000_reloadPLX(dev);\r\ndaqboard2000_pulseProgPin(dev);\r\nif (daqboard2000_pollCPLD(dev, DAQBOARD2000_CPLD_INIT)) {\r\nfor (i = 0; i < len; i++) {\r\nif (cpld_array[i] == 0xff &&\r\ncpld_array[i + 1] == 0x20)\r\nbreak;\r\n}\r\nfor (; i < len; i += 2) {\r\nint data =\r\n(cpld_array[i] << 8) + cpld_array[i + 1];\r\nif (!daqboard2000_writeCPLD(dev, data))\r\nbreak;\r\n}\r\nif (i >= len) {\r\ndaqboard2000_resetLocalBus(dev);\r\ndaqboard2000_reloadPLX(dev);\r\nresult = 0;\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn result;\r\n}\r\nstatic void daqboard2000_adcStopDmaTransfer(struct comedi_device *dev)\r\n{\r\n}\r\nstatic void daqboard2000_adcDisarm(struct comedi_device *dev)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nudelay(2);\r\nwritew(DAQBOARD2000_TrigAnalog | DAQBOARD2000_TrigDisable,\r\ndevpriv->daq + trigControl);\r\nudelay(2);\r\nwritew(DAQBOARD2000_TrigTTL | DAQBOARD2000_TrigDisable,\r\ndevpriv->daq + trigControl);\r\nudelay(2);\r\nwritew(DAQBOARD2000_SeqStopScanList, devpriv->daq + acqControl);\r\nudelay(2);\r\nwritew(DAQBOARD2000_AdcPacerDisable, devpriv->daq + acqControl);\r\ndaqboard2000_adcStopDmaTransfer(dev);\r\n}\r\nstatic void daqboard2000_activateReferenceDacs(struct comedi_device *dev)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nunsigned int val;\r\nint timeout;\r\nwritew(0x80 | DAQBOARD2000_PosRefDacSelect, devpriv->daq + refDacs);\r\nfor (timeout = 0; timeout < 20; timeout++) {\r\nval = readw(devpriv->daq + dacControl);\r\nif ((val & DAQBOARD2000_RefBusy) == 0)\r\nbreak;\r\nudelay(2);\r\n}\r\nwritew(0x80 | DAQBOARD2000_NegRefDacSelect, devpriv->daq + refDacs);\r\nfor (timeout = 0; timeout < 20; timeout++) {\r\nval = readw(devpriv->daq + dacControl);\r\nif ((val & DAQBOARD2000_RefBusy) == 0)\r\nbreak;\r\nudelay(2);\r\n}\r\n}\r\nstatic void daqboard2000_initializeCtrs(struct comedi_device *dev)\r\n{\r\n}\r\nstatic void daqboard2000_initializeTmrs(struct comedi_device *dev)\r\n{\r\n}\r\nstatic void daqboard2000_dacDisarm(struct comedi_device *dev)\r\n{\r\n}\r\nstatic void daqboard2000_initializeAdc(struct comedi_device *dev)\r\n{\r\ndaqboard2000_adcDisarm(dev);\r\ndaqboard2000_activateReferenceDacs(dev);\r\ndaqboard2000_initializeCtrs(dev);\r\ndaqboard2000_initializeTmrs(dev);\r\n}\r\nstatic void daqboard2000_initializeDac(struct comedi_device *dev)\r\n{\r\ndaqboard2000_dacDisarm(dev);\r\n}\r\nstatic int daqboard2000_8255_cb(int dir, int port, int data,\r\nunsigned long ioaddr)\r\n{\r\nvoid __iomem *mmio_base = (void __iomem *)ioaddr;\r\nif (dir) {\r\nwritew(data, mmio_base + port * 2);\r\nreturn 0;\r\n} else {\r\nreturn readw(mmio_base + port * 2);\r\n}\r\n}\r\nstatic const void *daqboard2000_find_boardinfo(struct comedi_device *dev,\r\nstruct pci_dev *pcidev)\r\n{\r\nconst struct daq200_boardtype *board;\r\nint i;\r\nif (pcidev->subsystem_device != PCI_VENDOR_ID_IOTECH)\r\nreturn NULL;\r\nfor (i = 0; i < ARRAY_SIZE(boardtypes); i++) {\r\nboard = &boardtypes[i];\r\nif (pcidev->subsystem_device == board->id)\r\nreturn board;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int daqboard2000_auto_attach(struct comedi_device *dev,\r\nunsigned long context_unused)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nconst struct daq200_boardtype *board;\r\nstruct daqboard2000_private *devpriv;\r\nstruct comedi_subdevice *s;\r\nint result;\r\nboard = daqboard2000_find_boardinfo(dev, pcidev);\r\nif (!board)\r\nreturn -ENODEV;\r\ndev->board_ptr = board;\r\ndev->board_name = board->name;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\nresult = comedi_pci_enable(dev);\r\nif (result)\r\nreturn result;\r\ndevpriv->plx = pci_ioremap_bar(pcidev, 0);\r\ndevpriv->daq = pci_ioremap_bar(pcidev, 2);\r\nif (!devpriv->plx || !devpriv->daq)\r\nreturn -ENOMEM;\r\nresult = comedi_alloc_subdevices(dev, 3);\r\nif (result)\r\nreturn result;\r\nreadl(devpriv->plx + 0x6c);\r\nresult = comedi_load_firmware(dev, &comedi_to_pci_dev(dev)->dev,\r\nDAQBOARD2000_FIRMWARE,\r\ninitialize_daqboard2000, 0);\r\nif (result < 0)\r\nreturn result;\r\ndaqboard2000_initializeAdc(dev);\r\ndaqboard2000_initializeDac(dev);\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND;\r\ns->n_chan = 24;\r\ns->maxdata = 0xffff;\r\ns->insn_read = daqboard2000_ai_insn_read;\r\ns->range_table = &range_daqboard2000_ai;\r\ns = &dev->subdevices[1];\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = 2;\r\ns->maxdata = 0xffff;\r\ns->insn_read = daqboard2000_ao_insn_read;\r\ns->insn_write = daqboard2000_ao_insn_write;\r\ns->range_table = &range_bipolar10;\r\ns = &dev->subdevices[2];\r\nresult = subdev_8255_init(dev, s, daqboard2000_8255_cb,\r\n(unsigned long)(devpriv->daq + dioP2ExpansionIO8Bit));\r\nif (result)\r\nreturn result;\r\ndev_info(dev->class_dev, "%s: %s attached\n",\r\ndev->driver->driver_name, dev->board_name);\r\nreturn 0;\r\n}\r\nstatic void daqboard2000_detach(struct comedi_device *dev)\r\n{\r\nstruct daqboard2000_private *devpriv = dev->private;\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\nif (devpriv) {\r\nif (devpriv->daq)\r\niounmap(devpriv->daq);\r\nif (devpriv->plx)\r\niounmap(devpriv->plx);\r\n}\r\ncomedi_pci_disable(dev);\r\n}\r\nstatic int daqboard2000_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &daqboard2000_driver,\r\nid->driver_data);\r\n}

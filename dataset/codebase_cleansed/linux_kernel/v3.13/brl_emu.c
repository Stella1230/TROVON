struct illegal_op_return\r\nia64_emulate_brl (struct pt_regs *regs, unsigned long ar_ec)\r\n{\r\nunsigned long bundle[2];\r\nunsigned long opcode, btype, qp, offset, cpl;\r\nunsigned long next_ip;\r\nstruct siginfo siginfo;\r\nstruct illegal_op_return rv;\r\nlong tmp_taken, unimplemented_address;\r\nrv.fkt = (unsigned long) -1;\r\nif (copy_from_user(bundle, (void *) (regs->cr_iip), sizeof(bundle)))\r\nreturn rv;\r\nnext_ip = (unsigned long) regs->cr_iip + 16;\r\nif (ia64_psr(regs)->ri != 1) return rv;\r\nif ((bundle[0] & 0x1e) != 0x4) return rv;\r\nopcode = (bundle[1] >> 60);\r\nbtype = ((bundle[1] >> 29) & 0x7);\r\nqp = ((bundle[1] >> 23) & 0x3f);\r\noffset = ((bundle[1] & 0x0800000000000000L) << 4)\r\n| ((bundle[1] & 0x00fffff000000000L) >> 32)\r\n| ((bundle[1] & 0x00000000007fffffL) << 40)\r\n| ((bundle[0] & 0xffff000000000000L) >> 24);\r\ntmp_taken = regs->pr & (1L << qp);\r\nswitch(opcode) {\r\ncase 0xC:\r\nif (btype != 0) return rv;\r\nrv.fkt = 0;\r\nif (!(tmp_taken)) {\r\nregs->cr_iip = next_ip;\r\nia64_psr(regs)->ri = 0;\r\nreturn rv;\r\n}\r\nbreak;\r\ncase 0xD:\r\nrv.fkt = 0;\r\nif (!(tmp_taken)) {\r\nregs->cr_iip = next_ip;\r\nia64_psr(regs)->ri = 0;\r\nreturn rv;\r\n}\r\nswitch(btype) {\r\ncase 0:\r\nregs->b0 = next_ip;\r\nbreak;\r\ncase 1:\r\nrv.fkt = (unsigned long) &ia64_set_b1;\r\nbreak;\r\ncase 2:\r\nrv.fkt = (unsigned long) &ia64_set_b2;\r\nbreak;\r\ncase 3:\r\nrv.fkt = (unsigned long) &ia64_set_b3;\r\nbreak;\r\ncase 4:\r\nrv.fkt = (unsigned long) &ia64_set_b4;\r\nbreak;\r\ncase 5:\r\nrv.fkt = (unsigned long) &ia64_set_b5;\r\nbreak;\r\ncase 6:\r\nregs->b6 = next_ip;\r\nbreak;\r\ncase 7:\r\nregs->b7 = next_ip;\r\nbreak;\r\n}\r\nrv.arg1 = next_ip;\r\ncpl = ia64_psr(regs)->cpl;\r\nregs->ar_pfs = ((regs->cr_ifs & 0x3fffffffff)\r\n| (ar_ec << 52) | (cpl << 62));\r\nregs->cr_ifs = ((regs->cr_ifs & 0xffffffc00000007f)\r\n- ((regs->cr_ifs >> 7) & 0x7f));\r\nbreak;\r\ndefault:\r\nreturn rv;\r\n}\r\nregs->cr_iip += offset;\r\nia64_psr(regs)->ri = 0;\r\nif (ia64_psr(regs)->it == 0)\r\nunimplemented_address = unimplemented_physical_address(regs->cr_iip);\r\nelse\r\nunimplemented_address = unimplemented_virtual_address(regs->cr_iip);\r\nif (unimplemented_address) {\r\nprintk(KERN_DEBUG "Woah! Unimplemented Instruction Address Trap!\n");\r\nsiginfo.si_signo = SIGILL;\r\nsiginfo.si_errno = 0;\r\nsiginfo.si_flags = 0;\r\nsiginfo.si_isr = 0;\r\nsiginfo.si_imm = 0;\r\nsiginfo.si_code = ILL_BADIADDR;\r\nforce_sig_info(SIGILL, &siginfo, current);\r\n} else if (ia64_psr(regs)->tb) {\r\nsiginfo.si_signo = SIGTRAP;\r\nsiginfo.si_errno = 0;\r\nsiginfo.si_code = TRAP_BRANCH;\r\nsiginfo.si_flags = 0;\r\nsiginfo.si_isr = 0;\r\nsiginfo.si_addr = 0;\r\nsiginfo.si_imm = 0;\r\nforce_sig_info(SIGTRAP, &siginfo, current);\r\n} else if (ia64_psr(regs)->ss) {\r\nsiginfo.si_signo = SIGTRAP;\r\nsiginfo.si_errno = 0;\r\nsiginfo.si_code = TRAP_TRACE;\r\nsiginfo.si_flags = 0;\r\nsiginfo.si_isr = 0;\r\nsiginfo.si_addr = 0;\r\nsiginfo.si_imm = 0;\r\nforce_sig_info(SIGTRAP, &siginfo, current);\r\n}\r\nreturn rv;\r\n}

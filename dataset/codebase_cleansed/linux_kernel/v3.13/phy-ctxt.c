static inline u8 iwl_mvm_get_channel_width(struct cfg80211_chan_def *chandef)\r\n{\r\nswitch (chandef->width) {\r\ncase NL80211_CHAN_WIDTH_20_NOHT:\r\ncase NL80211_CHAN_WIDTH_20:\r\nreturn PHY_VHT_CHANNEL_MODE20;\r\ncase NL80211_CHAN_WIDTH_40:\r\nreturn PHY_VHT_CHANNEL_MODE40;\r\ncase NL80211_CHAN_WIDTH_80:\r\nreturn PHY_VHT_CHANNEL_MODE80;\r\ncase NL80211_CHAN_WIDTH_160:\r\nreturn PHY_VHT_CHANNEL_MODE160;\r\ndefault:\r\nWARN(1, "Invalid channel width=%u", chandef->width);\r\nreturn PHY_VHT_CHANNEL_MODE20;\r\n}\r\n}\r\nstatic inline u8 iwl_mvm_get_ctrl_pos(struct cfg80211_chan_def *chandef)\r\n{\r\nswitch (chandef->chan->center_freq - chandef->center_freq1) {\r\ncase -70:\r\nreturn PHY_VHT_CTRL_POS_4_BELOW;\r\ncase -50:\r\nreturn PHY_VHT_CTRL_POS_3_BELOW;\r\ncase -30:\r\nreturn PHY_VHT_CTRL_POS_2_BELOW;\r\ncase -10:\r\nreturn PHY_VHT_CTRL_POS_1_BELOW;\r\ncase 10:\r\nreturn PHY_VHT_CTRL_POS_1_ABOVE;\r\ncase 30:\r\nreturn PHY_VHT_CTRL_POS_2_ABOVE;\r\ncase 50:\r\nreturn PHY_VHT_CTRL_POS_3_ABOVE;\r\ncase 70:\r\nreturn PHY_VHT_CTRL_POS_4_ABOVE;\r\ndefault:\r\nWARN(1, "Invalid channel definition");\r\ncase 0:\r\nreturn PHY_VHT_CTRL_POS_1_BELOW;\r\n}\r\n}\r\nstatic void iwl_mvm_phy_ctxt_cmd_hdr(struct iwl_mvm_phy_ctxt *ctxt,\r\nstruct iwl_phy_context_cmd *cmd,\r\nu32 action, u32 apply_time)\r\n{\r\nmemset(cmd, 0, sizeof(struct iwl_phy_context_cmd));\r\ncmd->id_and_color = cpu_to_le32(FW_CMD_ID_AND_COLOR(ctxt->id,\r\nctxt->color));\r\ncmd->action = cpu_to_le32(action);\r\ncmd->apply_time = cpu_to_le32(apply_time);\r\n}\r\nstatic void iwl_mvm_phy_ctxt_cmd_data(struct iwl_mvm *mvm,\r\nstruct iwl_phy_context_cmd *cmd,\r\nstruct cfg80211_chan_def *chandef,\r\nu8 chains_static, u8 chains_dynamic)\r\n{\r\nu8 active_cnt, idle_cnt;\r\ncmd->ci.band = (chandef->chan->band == IEEE80211_BAND_2GHZ ?\r\nPHY_BAND_24 : PHY_BAND_5);\r\ncmd->ci.channel = chandef->chan->hw_value;\r\ncmd->ci.width = iwl_mvm_get_channel_width(chandef);\r\ncmd->ci.ctrl_pos = iwl_mvm_get_ctrl_pos(chandef);\r\nidle_cnt = chains_static;\r\nactive_cnt = chains_dynamic;\r\ncmd->rxchain_info = cpu_to_le32(iwl_fw_valid_rx_ant(mvm->fw) <<\r\nPHY_RX_CHAIN_VALID_POS);\r\ncmd->rxchain_info |= cpu_to_le32(idle_cnt << PHY_RX_CHAIN_CNT_POS);\r\ncmd->rxchain_info |= cpu_to_le32(active_cnt <<\r\nPHY_RX_CHAIN_MIMO_CNT_POS);\r\ncmd->txchain_info = cpu_to_le32(iwl_fw_valid_tx_ant(mvm->fw));\r\n}\r\nstatic int iwl_mvm_phy_ctxt_apply(struct iwl_mvm *mvm,\r\nstruct iwl_mvm_phy_ctxt *ctxt,\r\nstruct cfg80211_chan_def *chandef,\r\nu8 chains_static, u8 chains_dynamic,\r\nu32 action, u32 apply_time)\r\n{\r\nstruct iwl_phy_context_cmd cmd;\r\nint ret;\r\niwl_mvm_phy_ctxt_cmd_hdr(ctxt, &cmd, action, apply_time);\r\niwl_mvm_phy_ctxt_cmd_data(mvm, &cmd, chandef,\r\nchains_static, chains_dynamic);\r\nret = iwl_mvm_send_cmd_pdu(mvm, PHY_CONTEXT_CMD, CMD_SYNC,\r\nsizeof(struct iwl_phy_context_cmd),\r\n&cmd);\r\nif (ret)\r\nIWL_ERR(mvm, "PHY ctxt cmd error. ret=%d\n", ret);\r\nreturn ret;\r\n}\r\nint iwl_mvm_phy_ctxt_add(struct iwl_mvm *mvm, struct iwl_mvm_phy_ctxt *ctxt,\r\nstruct cfg80211_chan_def *chandef,\r\nu8 chains_static, u8 chains_dynamic)\r\n{\r\nint ret;\r\nWARN_ON(!test_bit(IWL_MVM_STATUS_IN_HW_RESTART, &mvm->status) &&\r\nctxt->ref);\r\nlockdep_assert_held(&mvm->mutex);\r\nctxt->channel = chandef->chan;\r\nret = iwl_mvm_phy_ctxt_apply(mvm, ctxt, chandef,\r\nchains_static, chains_dynamic,\r\nFW_CTXT_ACTION_ADD, 0);\r\nreturn ret;\r\n}\r\nvoid iwl_mvm_phy_ctxt_ref(struct iwl_mvm *mvm, struct iwl_mvm_phy_ctxt *ctxt)\r\n{\r\nlockdep_assert_held(&mvm->mutex);\r\nctxt->ref++;\r\n}\r\nint iwl_mvm_phy_ctxt_changed(struct iwl_mvm *mvm, struct iwl_mvm_phy_ctxt *ctxt,\r\nstruct cfg80211_chan_def *chandef,\r\nu8 chains_static, u8 chains_dynamic)\r\n{\r\nlockdep_assert_held(&mvm->mutex);\r\nctxt->channel = chandef->chan;\r\nreturn iwl_mvm_phy_ctxt_apply(mvm, ctxt, chandef,\r\nchains_static, chains_dynamic,\r\nFW_CTXT_ACTION_MODIFY, 0);\r\n}\r\nvoid iwl_mvm_phy_ctxt_unref(struct iwl_mvm *mvm, struct iwl_mvm_phy_ctxt *ctxt)\r\n{\r\nlockdep_assert_held(&mvm->mutex);\r\nif (WARN_ON_ONCE(!ctxt))\r\nreturn;\r\nctxt->ref--;\r\n}

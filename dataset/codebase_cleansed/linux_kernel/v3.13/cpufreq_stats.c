static int cpufreq_stats_update(unsigned int cpu)\r\n{\r\nstruct cpufreq_stats *stat;\r\nunsigned long long cur_time;\r\ncur_time = get_jiffies_64();\r\nspin_lock(&cpufreq_stats_lock);\r\nstat = per_cpu(cpufreq_stats_table, cpu);\r\nif (stat->time_in_state)\r\nstat->time_in_state[stat->last_index] +=\r\ncur_time - stat->last_time;\r\nstat->last_time = cur_time;\r\nspin_unlock(&cpufreq_stats_lock);\r\nreturn 0;\r\n}\r\nstatic ssize_t show_total_trans(struct cpufreq_policy *policy, char *buf)\r\n{\r\nstruct cpufreq_stats *stat = per_cpu(cpufreq_stats_table, policy->cpu);\r\nif (!stat)\r\nreturn 0;\r\nreturn sprintf(buf, "%d\n",\r\nper_cpu(cpufreq_stats_table, stat->cpu)->total_trans);\r\n}\r\nstatic ssize_t show_time_in_state(struct cpufreq_policy *policy, char *buf)\r\n{\r\nssize_t len = 0;\r\nint i;\r\nstruct cpufreq_stats *stat = per_cpu(cpufreq_stats_table, policy->cpu);\r\nif (!stat)\r\nreturn 0;\r\ncpufreq_stats_update(stat->cpu);\r\nfor (i = 0; i < stat->state_num; i++) {\r\nlen += sprintf(buf + len, "%u %llu\n", stat->freq_table[i],\r\n(unsigned long long)\r\njiffies_64_to_clock_t(stat->time_in_state[i]));\r\n}\r\nreturn len;\r\n}\r\nstatic ssize_t show_trans_table(struct cpufreq_policy *policy, char *buf)\r\n{\r\nssize_t len = 0;\r\nint i, j;\r\nstruct cpufreq_stats *stat = per_cpu(cpufreq_stats_table, policy->cpu);\r\nif (!stat)\r\nreturn 0;\r\ncpufreq_stats_update(stat->cpu);\r\nlen += snprintf(buf + len, PAGE_SIZE - len, " From : To\n");\r\nlen += snprintf(buf + len, PAGE_SIZE - len, " : ");\r\nfor (i = 0; i < stat->state_num; i++) {\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "%9u ",\r\nstat->freq_table[i]);\r\n}\r\nif (len >= PAGE_SIZE)\r\nreturn PAGE_SIZE;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "\n");\r\nfor (i = 0; i < stat->state_num; i++) {\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "%9u: ",\r\nstat->freq_table[i]);\r\nfor (j = 0; j < stat->state_num; j++) {\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "%9u ",\r\nstat->trans_table[i*stat->max_state+j]);\r\n}\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "\n");\r\n}\r\nif (len >= PAGE_SIZE)\r\nreturn PAGE_SIZE;\r\nreturn len;\r\n}\r\nstatic int freq_table_get_index(struct cpufreq_stats *stat, unsigned int freq)\r\n{\r\nint index;\r\nfor (index = 0; index < stat->max_state; index++)\r\nif (stat->freq_table[index] == freq)\r\nreturn index;\r\nreturn -1;\r\n}\r\nstatic void cpufreq_stats_free_table(unsigned int cpu)\r\n{\r\nstruct cpufreq_stats *stat = per_cpu(cpufreq_stats_table, cpu);\r\nif (stat) {\r\npr_debug("%s: Free stat table\n", __func__);\r\nkfree(stat->time_in_state);\r\nkfree(stat);\r\nper_cpu(cpufreq_stats_table, cpu) = NULL;\r\n}\r\n}\r\nstatic void cpufreq_stats_free_sysfs(unsigned int cpu)\r\n{\r\nstruct cpufreq_policy *policy = cpufreq_cpu_get(cpu);\r\nif (!policy)\r\nreturn;\r\nif (!cpufreq_frequency_get_table(cpu))\r\ngoto put_ref;\r\nif (!policy_is_shared(policy)) {\r\npr_debug("%s: Free sysfs stat\n", __func__);\r\nsysfs_remove_group(&policy->kobj, &stats_attr_group);\r\n}\r\nput_ref:\r\ncpufreq_cpu_put(policy);\r\n}\r\nstatic int cpufreq_stats_create_table(struct cpufreq_policy *policy,\r\nstruct cpufreq_frequency_table *table)\r\n{\r\nunsigned int i, j, count = 0, ret = 0;\r\nstruct cpufreq_stats *stat;\r\nstruct cpufreq_policy *current_policy;\r\nunsigned int alloc_size;\r\nunsigned int cpu = policy->cpu;\r\nif (per_cpu(cpufreq_stats_table, cpu))\r\nreturn -EBUSY;\r\nstat = kzalloc(sizeof(*stat), GFP_KERNEL);\r\nif ((stat) == NULL)\r\nreturn -ENOMEM;\r\ncurrent_policy = cpufreq_cpu_get(cpu);\r\nif (current_policy == NULL) {\r\nret = -EINVAL;\r\ngoto error_get_fail;\r\n}\r\nret = sysfs_create_group(&current_policy->kobj, &stats_attr_group);\r\nif (ret)\r\ngoto error_out;\r\nstat->cpu = cpu;\r\nper_cpu(cpufreq_stats_table, cpu) = stat;\r\nfor (i = 0; table[i].frequency != CPUFREQ_TABLE_END; i++) {\r\nunsigned int freq = table[i].frequency;\r\nif (freq == CPUFREQ_ENTRY_INVALID)\r\ncontinue;\r\ncount++;\r\n}\r\nalloc_size = count * sizeof(int) + count * sizeof(u64);\r\n#ifdef CONFIG_CPU_FREQ_STAT_DETAILS\r\nalloc_size += count * count * sizeof(int);\r\n#endif\r\nstat->max_state = count;\r\nstat->time_in_state = kzalloc(alloc_size, GFP_KERNEL);\r\nif (!stat->time_in_state) {\r\nret = -ENOMEM;\r\ngoto error_out;\r\n}\r\nstat->freq_table = (unsigned int *)(stat->time_in_state + count);\r\n#ifdef CONFIG_CPU_FREQ_STAT_DETAILS\r\nstat->trans_table = stat->freq_table + count;\r\n#endif\r\nj = 0;\r\nfor (i = 0; table[i].frequency != CPUFREQ_TABLE_END; i++) {\r\nunsigned int freq = table[i].frequency;\r\nif (freq == CPUFREQ_ENTRY_INVALID)\r\ncontinue;\r\nif (freq_table_get_index(stat, freq) == -1)\r\nstat->freq_table[j++] = freq;\r\n}\r\nstat->state_num = j;\r\nspin_lock(&cpufreq_stats_lock);\r\nstat->last_time = get_jiffies_64();\r\nstat->last_index = freq_table_get_index(stat, policy->cur);\r\nspin_unlock(&cpufreq_stats_lock);\r\ncpufreq_cpu_put(current_policy);\r\nreturn 0;\r\nerror_out:\r\ncpufreq_cpu_put(current_policy);\r\nerror_get_fail:\r\nkfree(stat);\r\nper_cpu(cpufreq_stats_table, cpu) = NULL;\r\nreturn ret;\r\n}\r\nstatic void cpufreq_stats_update_policy_cpu(struct cpufreq_policy *policy)\r\n{\r\nstruct cpufreq_stats *stat = per_cpu(cpufreq_stats_table,\r\npolicy->last_cpu);\r\npr_debug("Updating stats_table for new_cpu %u from last_cpu %u\n",\r\npolicy->cpu, policy->last_cpu);\r\nper_cpu(cpufreq_stats_table, policy->cpu) = per_cpu(cpufreq_stats_table,\r\npolicy->last_cpu);\r\nper_cpu(cpufreq_stats_table, policy->last_cpu) = NULL;\r\nstat->cpu = policy->cpu;\r\n}\r\nstatic int cpufreq_stat_notifier_policy(struct notifier_block *nb,\r\nunsigned long val, void *data)\r\n{\r\nint ret;\r\nstruct cpufreq_policy *policy = data;\r\nstruct cpufreq_frequency_table *table;\r\nunsigned int cpu = policy->cpu;\r\nif (val == CPUFREQ_UPDATE_POLICY_CPU) {\r\ncpufreq_stats_update_policy_cpu(policy);\r\nreturn 0;\r\n}\r\nif (val != CPUFREQ_NOTIFY)\r\nreturn 0;\r\ntable = cpufreq_frequency_get_table(cpu);\r\nif (!table)\r\nreturn 0;\r\nret = cpufreq_stats_create_table(policy, table);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int cpufreq_stat_notifier_trans(struct notifier_block *nb,\r\nunsigned long val, void *data)\r\n{\r\nstruct cpufreq_freqs *freq = data;\r\nstruct cpufreq_stats *stat;\r\nint old_index, new_index;\r\nif (val != CPUFREQ_POSTCHANGE)\r\nreturn 0;\r\nstat = per_cpu(cpufreq_stats_table, freq->cpu);\r\nif (!stat)\r\nreturn 0;\r\nold_index = stat->last_index;\r\nnew_index = freq_table_get_index(stat, freq->new);\r\nif (old_index == -1 || new_index == -1)\r\nreturn 0;\r\ncpufreq_stats_update(freq->cpu);\r\nif (old_index == new_index)\r\nreturn 0;\r\nspin_lock(&cpufreq_stats_lock);\r\nstat->last_index = new_index;\r\n#ifdef CONFIG_CPU_FREQ_STAT_DETAILS\r\nstat->trans_table[old_index * stat->max_state + new_index]++;\r\n#endif\r\nstat->total_trans++;\r\nspin_unlock(&cpufreq_stats_lock);\r\nreturn 0;\r\n}\r\nstatic int cpufreq_stat_cpu_callback(struct notifier_block *nfb,\r\nunsigned long action,\r\nvoid *hcpu)\r\n{\r\nunsigned int cpu = (unsigned long)hcpu;\r\nswitch (action) {\r\ncase CPU_DOWN_PREPARE:\r\ncpufreq_stats_free_sysfs(cpu);\r\nbreak;\r\ncase CPU_DEAD:\r\ncpufreq_stats_free_table(cpu);\r\nbreak;\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int __init cpufreq_stats_init(void)\r\n{\r\nint ret;\r\nunsigned int cpu;\r\nspin_lock_init(&cpufreq_stats_lock);\r\nret = cpufreq_register_notifier(&notifier_policy_block,\r\nCPUFREQ_POLICY_NOTIFIER);\r\nif (ret)\r\nreturn ret;\r\nregister_hotcpu_notifier(&cpufreq_stat_cpu_notifier);\r\nret = cpufreq_register_notifier(&notifier_trans_block,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\nif (ret) {\r\ncpufreq_unregister_notifier(&notifier_policy_block,\r\nCPUFREQ_POLICY_NOTIFIER);\r\nunregister_hotcpu_notifier(&cpufreq_stat_cpu_notifier);\r\nfor_each_online_cpu(cpu)\r\ncpufreq_stats_free_table(cpu);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit cpufreq_stats_exit(void)\r\n{\r\nunsigned int cpu;\r\ncpufreq_unregister_notifier(&notifier_policy_block,\r\nCPUFREQ_POLICY_NOTIFIER);\r\ncpufreq_unregister_notifier(&notifier_trans_block,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\nunregister_hotcpu_notifier(&cpufreq_stat_cpu_notifier);\r\nfor_each_online_cpu(cpu) {\r\ncpufreq_stats_free_table(cpu);\r\ncpufreq_stats_free_sysfs(cpu);\r\n}\r\n}

static resource_size_t pcmcia_align(void *align_data,\r\nconst struct resource *res,\r\nresource_size_t size, resource_size_t align)\r\n{\r\nstruct pcmcia_align_data *data = align_data;\r\nresource_size_t start;\r\nstart = (res->start & ~data->mask) + data->offset;\r\nif (start < res->start)\r\nstart += data->mask + 1;\r\n#ifdef CONFIG_X86\r\nif (res->flags & IORESOURCE_IO) {\r\nif (start & 0x300)\r\nstart = (start + 0x3ff) & ~0x3ff;\r\n}\r\n#endif\r\n#ifdef CONFIG_M68K\r\nif (res->flags & IORESOURCE_IO) {\r\nif ((res->start + size - 1) >= 1024)\r\nstart = res->end;\r\n}\r\n#endif\r\nreturn start;\r\n}\r\nstatic struct resource *__iodyn_find_io_region(struct pcmcia_socket *s,\r\nunsigned long base, int num,\r\nunsigned long align)\r\n{\r\nstruct resource *res = pcmcia_make_resource(0, num, IORESOURCE_IO,\r\ndev_name(&s->dev));\r\nstruct pcmcia_align_data data;\r\nunsigned long min = base;\r\nint ret;\r\ndata.mask = align - 1;\r\ndata.offset = base & data.mask;\r\n#ifdef CONFIG_PCI\r\nif (s->cb_dev) {\r\nret = pci_bus_alloc_resource(s->cb_dev->bus, res, num, 1,\r\nmin, 0, pcmcia_align, &data);\r\n} else\r\n#endif\r\nret = allocate_resource(&ioport_resource, res, num, min, ~0UL,\r\n1, pcmcia_align, &data);\r\nif (ret != 0) {\r\nkfree(res);\r\nres = NULL;\r\n}\r\nreturn res;\r\n}\r\nstatic int iodyn_find_io(struct pcmcia_socket *s, unsigned int attr,\r\nunsigned int *base, unsigned int num,\r\nunsigned int align, struct resource **parent)\r\n{\r\nint i, ret = 0;\r\nfor (i = 0; i < MAX_IO_WIN; i++) {\r\nif (!s->io[i].res)\r\ncontinue;\r\nif (!*base)\r\ncontinue;\r\nif ((s->io[i].res->start & (align-1)) == *base)\r\nreturn -EBUSY;\r\n}\r\nfor (i = 0; i < MAX_IO_WIN; i++) {\r\nstruct resource *res = s->io[i].res;\r\nunsigned int try;\r\nif (res && (res->flags & IORESOURCE_BITS) !=\r\n(attr & IORESOURCE_BITS))\r\ncontinue;\r\nif (!res) {\r\nif (align == 0)\r\nalign = 0x10000;\r\nres = s->io[i].res = __iodyn_find_io_region(s, *base,\r\nnum, align);\r\nif (!res)\r\nreturn -EINVAL;\r\n*base = res->start;\r\ns->io[i].res->flags =\r\n((res->flags & ~IORESOURCE_BITS) |\r\n(attr & IORESOURCE_BITS));\r\ns->io[i].InUse = num;\r\n*parent = res;\r\nreturn 0;\r\n}\r\ntry = res->end + 1;\r\nif ((*base == 0) || (*base == try)) {\r\nif (adjust_resource(s->io[i].res, res->start,\r\nresource_size(res) + num))\r\ncontinue;\r\n*base = try;\r\ns->io[i].InUse += num;\r\n*parent = res;\r\nreturn 0;\r\n}\r\ntry = res->start - num;\r\nif ((*base == 0) || (*base == try)) {\r\nif (adjust_resource(s->io[i].res,\r\nres->start - num,\r\nresource_size(res) + num))\r\ncontinue;\r\n*base = try;\r\ns->io[i].InUse += num;\r\n*parent = res;\r\nreturn 0;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}

int x25_parse_facilities(struct sk_buff *skb, struct x25_facilities *facilities,\r\nstruct x25_dte_facilities *dte_facs, unsigned long *vc_fac_mask)\r\n{\r\nunsigned char *p;\r\nunsigned int len;\r\n*vc_fac_mask = 0;\r\ndte_facs->calling_len = 0;\r\ndte_facs->called_len = 0;\r\nmemset(dte_facs->called_ae, '\0', sizeof(dte_facs->called_ae));\r\nmemset(dte_facs->calling_ae, '\0', sizeof(dte_facs->calling_ae));\r\nif (!pskb_may_pull(skb, 1))\r\nreturn 0;\r\nlen = skb->data[0];\r\nif (!pskb_may_pull(skb, 1 + len))\r\nreturn -1;\r\np = skb->data + 1;\r\nwhile (len > 0) {\r\nswitch (*p & X25_FAC_CLASS_MASK) {\r\ncase X25_FAC_CLASS_A:\r\nif (len < 2)\r\nreturn -1;\r\nswitch (*p) {\r\ncase X25_FAC_REVERSE:\r\nif((p[1] & 0x81) == 0x81) {\r\nfacilities->reverse = p[1] & 0x81;\r\n*vc_fac_mask |= X25_MASK_REVERSE;\r\nbreak;\r\n}\r\nif((p[1] & 0x01) == 0x01) {\r\nfacilities->reverse = p[1] & 0x01;\r\n*vc_fac_mask |= X25_MASK_REVERSE;\r\nbreak;\r\n}\r\nif((p[1] & 0x80) == 0x80) {\r\nfacilities->reverse = p[1] & 0x80;\r\n*vc_fac_mask |= X25_MASK_REVERSE;\r\nbreak;\r\n}\r\nif(p[1] == 0x00) {\r\nfacilities->reverse\r\n= X25_DEFAULT_REVERSE;\r\n*vc_fac_mask |= X25_MASK_REVERSE;\r\nbreak;\r\n}\r\ncase X25_FAC_THROUGHPUT:\r\nfacilities->throughput = p[1];\r\n*vc_fac_mask |= X25_MASK_THROUGHPUT;\r\nbreak;\r\ncase X25_MARKER:\r\nbreak;\r\ndefault:\r\nprintk(KERN_DEBUG "X.25: unknown facility "\r\n"%02X, value %02X\n",\r\np[0], p[1]);\r\nbreak;\r\n}\r\np += 2;\r\nlen -= 2;\r\nbreak;\r\ncase X25_FAC_CLASS_B:\r\nif (len < 3)\r\nreturn -1;\r\nswitch (*p) {\r\ncase X25_FAC_PACKET_SIZE:\r\nfacilities->pacsize_in = p[1];\r\nfacilities->pacsize_out = p[2];\r\n*vc_fac_mask |= X25_MASK_PACKET_SIZE;\r\nbreak;\r\ncase X25_FAC_WINDOW_SIZE:\r\nfacilities->winsize_in = p[1];\r\nfacilities->winsize_out = p[2];\r\n*vc_fac_mask |= X25_MASK_WINDOW_SIZE;\r\nbreak;\r\ndefault:\r\nprintk(KERN_DEBUG "X.25: unknown facility "\r\n"%02X, values %02X, %02X\n",\r\np[0], p[1], p[2]);\r\nbreak;\r\n}\r\np += 3;\r\nlen -= 3;\r\nbreak;\r\ncase X25_FAC_CLASS_C:\r\nif (len < 4)\r\nreturn -1;\r\nprintk(KERN_DEBUG "X.25: unknown facility %02X, "\r\n"values %02X, %02X, %02X\n",\r\np[0], p[1], p[2], p[3]);\r\np += 4;\r\nlen -= 4;\r\nbreak;\r\ncase X25_FAC_CLASS_D:\r\nif (len < p[1] + 2)\r\nreturn -1;\r\nswitch (*p) {\r\ncase X25_FAC_CALLING_AE:\r\nif (p[1] > X25_MAX_DTE_FACIL_LEN || p[1] <= 1)\r\nreturn -1;\r\nif (p[2] > X25_MAX_AE_LEN)\r\nreturn -1;\r\ndte_facs->calling_len = p[2];\r\nmemcpy(dte_facs->calling_ae, &p[3], p[1] - 1);\r\n*vc_fac_mask |= X25_MASK_CALLING_AE;\r\nbreak;\r\ncase X25_FAC_CALLED_AE:\r\nif (p[1] > X25_MAX_DTE_FACIL_LEN || p[1] <= 1)\r\nreturn -1;\r\nif (p[2] > X25_MAX_AE_LEN)\r\nreturn -1;\r\ndte_facs->called_len = p[2];\r\nmemcpy(dte_facs->called_ae, &p[3], p[1] - 1);\r\n*vc_fac_mask |= X25_MASK_CALLED_AE;\r\nbreak;\r\ndefault:\r\nprintk(KERN_DEBUG "X.25: unknown facility %02X,"\r\n"length %d\n", p[0], p[1]);\r\nbreak;\r\n}\r\nlen -= p[1] + 2;\r\np += p[1] + 2;\r\nbreak;\r\n}\r\n}\r\nreturn p - skb->data;\r\n}\r\nint x25_create_facilities(unsigned char *buffer,\r\nstruct x25_facilities *facilities,\r\nstruct x25_dte_facilities *dte_facs, unsigned long facil_mask)\r\n{\r\nunsigned char *p = buffer + 1;\r\nint len;\r\nif (!facil_mask) {\r\nbuffer[0] = 0;\r\nlen = 1;\r\nreturn len;\r\n}\r\nif (facilities->reverse && (facil_mask & X25_MASK_REVERSE)) {\r\n*p++ = X25_FAC_REVERSE;\r\n*p++ = facilities->reverse;\r\n}\r\nif (facilities->throughput && (facil_mask & X25_MASK_THROUGHPUT)) {\r\n*p++ = X25_FAC_THROUGHPUT;\r\n*p++ = facilities->throughput;\r\n}\r\nif ((facilities->pacsize_in || facilities->pacsize_out) &&\r\n(facil_mask & X25_MASK_PACKET_SIZE)) {\r\n*p++ = X25_FAC_PACKET_SIZE;\r\n*p++ = facilities->pacsize_in ? : facilities->pacsize_out;\r\n*p++ = facilities->pacsize_out ? : facilities->pacsize_in;\r\n}\r\nif ((facilities->winsize_in || facilities->winsize_out) &&\r\n(facil_mask & X25_MASK_WINDOW_SIZE)) {\r\n*p++ = X25_FAC_WINDOW_SIZE;\r\n*p++ = facilities->winsize_in ? : facilities->winsize_out;\r\n*p++ = facilities->winsize_out ? : facilities->winsize_in;\r\n}\r\nif (facil_mask & (X25_MASK_CALLING_AE|X25_MASK_CALLED_AE)) {\r\n*p++ = X25_MARKER;\r\n*p++ = X25_DTE_SERVICES;\r\n}\r\nif (dte_facs->calling_len && (facil_mask & X25_MASK_CALLING_AE)) {\r\nunsigned int bytecount = (dte_facs->calling_len + 1) >> 1;\r\n*p++ = X25_FAC_CALLING_AE;\r\n*p++ = 1 + bytecount;\r\n*p++ = dte_facs->calling_len;\r\nmemcpy(p, dte_facs->calling_ae, bytecount);\r\np += bytecount;\r\n}\r\nif (dte_facs->called_len && (facil_mask & X25_MASK_CALLED_AE)) {\r\nunsigned int bytecount = (dte_facs->called_len % 2) ?\r\ndte_facs->called_len / 2 + 1 :\r\ndte_facs->called_len / 2;\r\n*p++ = X25_FAC_CALLED_AE;\r\n*p++ = 1 + bytecount;\r\n*p++ = dte_facs->called_len;\r\nmemcpy(p, dte_facs->called_ae, bytecount);\r\np+=bytecount;\r\n}\r\nlen = p - buffer;\r\nbuffer[0] = len - 1;\r\nreturn len;\r\n}\r\nint x25_negotiate_facilities(struct sk_buff *skb, struct sock *sk,\r\nstruct x25_facilities *new, struct x25_dte_facilities *dte)\r\n{\r\nstruct x25_sock *x25 = x25_sk(sk);\r\nstruct x25_facilities *ours = &x25->facilities;\r\nstruct x25_facilities theirs;\r\nint len;\r\nmemset(&theirs, 0, sizeof(theirs));\r\nmemcpy(new, ours, sizeof(*new));\r\nlen = x25_parse_facilities(skb, &theirs, dte, &x25->vc_facil_mask);\r\nif (len < 0)\r\nreturn len;\r\nif ((theirs.reverse & 0x01 ) && (ours->reverse & 0x01)) {\r\nSOCK_DEBUG(sk, "X.25: rejecting reverse charging request\n");\r\nreturn -1;\r\n}\r\nnew->reverse = theirs.reverse;\r\nif (theirs.throughput) {\r\nint theirs_in = theirs.throughput & 0x0f;\r\nint theirs_out = theirs.throughput & 0xf0;\r\nint ours_in = ours->throughput & 0x0f;\r\nint ours_out = ours->throughput & 0xf0;\r\nif (!ours_in || theirs_in < ours_in) {\r\nSOCK_DEBUG(sk, "X.25: inbound throughput negotiated\n");\r\nnew->throughput = (new->throughput & 0xf0) | theirs_in;\r\n}\r\nif (!ours_out || theirs_out < ours_out) {\r\nSOCK_DEBUG(sk,\r\n"X.25: outbound throughput negotiated\n");\r\nnew->throughput = (new->throughput & 0x0f) | theirs_out;\r\n}\r\n}\r\nif (theirs.pacsize_in && theirs.pacsize_out) {\r\nif (theirs.pacsize_in < ours->pacsize_in) {\r\nSOCK_DEBUG(sk, "X.25: packet size inwards negotiated down\n");\r\nnew->pacsize_in = theirs.pacsize_in;\r\n}\r\nif (theirs.pacsize_out < ours->pacsize_out) {\r\nSOCK_DEBUG(sk, "X.25: packet size outwards negotiated down\n");\r\nnew->pacsize_out = theirs.pacsize_out;\r\n}\r\n}\r\nif (theirs.winsize_in && theirs.winsize_out) {\r\nif (theirs.winsize_in < ours->winsize_in) {\r\nSOCK_DEBUG(sk, "X.25: window size inwards negotiated down\n");\r\nnew->winsize_in = theirs.winsize_in;\r\n}\r\nif (theirs.winsize_out < ours->winsize_out) {\r\nSOCK_DEBUG(sk, "X.25: window size outwards negotiated down\n");\r\nnew->winsize_out = theirs.winsize_out;\r\n}\r\n}\r\nreturn len;\r\n}\r\nvoid x25_limit_facilities(struct x25_facilities *facilities,\r\nstruct x25_neigh *nb)\r\n{\r\nif (!nb->extended) {\r\nif (facilities->winsize_in > 7) {\r\nprintk(KERN_DEBUG "X.25: incoming winsize limited to 7\n");\r\nfacilities->winsize_in = 7;\r\n}\r\nif (facilities->winsize_out > 7) {\r\nfacilities->winsize_out = 7;\r\nprintk( KERN_DEBUG "X.25: outgoing winsize limited to 7\n");\r\n}\r\n}\r\n}

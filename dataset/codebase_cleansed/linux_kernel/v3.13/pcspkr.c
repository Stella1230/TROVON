static int pcspkr_event(struct input_dev *dev, unsigned int type, unsigned int code, int value)\r\n{\r\nunsigned int count = 0;\r\nunsigned long flags;\r\nif (type != EV_SND)\r\nreturn -1;\r\nswitch (code) {\r\ncase SND_BELL: if (value) value = 1000;\r\ncase SND_TONE: break;\r\ndefault: return -1;\r\n}\r\nif (value > 20 && value < 32767)\r\ncount = PIT_TICK_RATE / value;\r\nraw_spin_lock_irqsave(&i8253_lock, flags);\r\nif (count) {\r\noutb_p(0xB6, 0x43);\r\noutb_p(count & 0xff, 0x42);\r\noutb((count >> 8) & 0xff, 0x42);\r\noutb_p(inb_p(0x61) | 3, 0x61);\r\n} else {\r\noutb(inb_p(0x61) & 0xFC, 0x61);\r\n}\r\nraw_spin_unlock_irqrestore(&i8253_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int pcspkr_probe(struct platform_device *dev)\r\n{\r\nstruct input_dev *pcspkr_dev;\r\nint err;\r\npcspkr_dev = input_allocate_device();\r\nif (!pcspkr_dev)\r\nreturn -ENOMEM;\r\npcspkr_dev->name = "PC Speaker";\r\npcspkr_dev->phys = "isa0061/input0";\r\npcspkr_dev->id.bustype = BUS_ISA;\r\npcspkr_dev->id.vendor = 0x001f;\r\npcspkr_dev->id.product = 0x0001;\r\npcspkr_dev->id.version = 0x0100;\r\npcspkr_dev->dev.parent = &dev->dev;\r\npcspkr_dev->evbit[0] = BIT_MASK(EV_SND);\r\npcspkr_dev->sndbit[0] = BIT_MASK(SND_BELL) | BIT_MASK(SND_TONE);\r\npcspkr_dev->event = pcspkr_event;\r\nerr = input_register_device(pcspkr_dev);\r\nif (err) {\r\ninput_free_device(pcspkr_dev);\r\nreturn err;\r\n}\r\nplatform_set_drvdata(dev, pcspkr_dev);\r\nreturn 0;\r\n}\r\nstatic int pcspkr_remove(struct platform_device *dev)\r\n{\r\nstruct input_dev *pcspkr_dev = platform_get_drvdata(dev);\r\ninput_unregister_device(pcspkr_dev);\r\npcspkr_event(NULL, EV_SND, SND_BELL, 0);\r\nreturn 0;\r\n}\r\nstatic int pcspkr_suspend(struct device *dev)\r\n{\r\npcspkr_event(NULL, EV_SND, SND_BELL, 0);\r\nreturn 0;\r\n}\r\nstatic void pcspkr_shutdown(struct platform_device *dev)\r\n{\r\npcspkr_event(NULL, EV_SND, SND_BELL, 0);\r\n}

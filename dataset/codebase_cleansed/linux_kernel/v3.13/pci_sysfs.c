static ssize_t show_fid(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct zpci_dev *zdev = get_zdev(to_pci_dev(dev));\r\nreturn sprintf(buf, "0x%08x\n", zdev->fid);\r\n}\r\nstatic ssize_t show_fh(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct zpci_dev *zdev = get_zdev(to_pci_dev(dev));\r\nreturn sprintf(buf, "0x%08x\n", zdev->fh);\r\n}\r\nstatic ssize_t show_pchid(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct zpci_dev *zdev = get_zdev(to_pci_dev(dev));\r\nreturn sprintf(buf, "0x%04x\n", zdev->pchid);\r\n}\r\nstatic ssize_t show_pfgid(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct zpci_dev *zdev = get_zdev(to_pci_dev(dev));\r\nreturn sprintf(buf, "0x%02x\n", zdev->pfgid);\r\n}\r\nstatic void recover_callback(struct device *dev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct zpci_dev *zdev = get_zdev(pdev);\r\nint ret;\r\npci_stop_and_remove_bus_device(pdev);\r\nret = zpci_disable_device(zdev);\r\nif (ret)\r\nreturn;\r\nret = zpci_enable_device(zdev);\r\nif (ret)\r\nreturn;\r\npci_rescan_bus(zdev->bus);\r\n}\r\nstatic ssize_t store_recover(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nint rc = device_schedule_callback(dev, recover_callback);\r\nreturn rc ? rc : count;\r\n}\r\nint zpci_sysfs_add_device(struct device *dev)\r\n{\r\nint i, rc = 0;\r\nfor (i = 0; zpci_dev_attrs[i]; i++) {\r\nrc = device_create_file(dev, zpci_dev_attrs[i]);\r\nif (rc)\r\ngoto error;\r\n}\r\nreturn 0;\r\nerror:\r\nwhile (--i >= 0)\r\ndevice_remove_file(dev, zpci_dev_attrs[i]);\r\nreturn rc;\r\n}\r\nvoid zpci_sysfs_remove_device(struct device *dev)\r\n{\r\nint i;\r\nfor (i = 0; zpci_dev_attrs[i]; i++)\r\ndevice_remove_file(dev, zpci_dev_attrs[i]);\r\n}

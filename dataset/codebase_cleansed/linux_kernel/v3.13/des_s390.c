static int des_setkey(struct crypto_tfm *tfm, const u8 *key,\r\nunsigned int key_len)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\nu32 *flags = &tfm->crt_flags;\r\nu32 tmp[DES_EXPKEY_WORDS];\r\nif (!des_ekey(tmp, key) && (*flags & CRYPTO_TFM_REQ_WEAK_KEY)) {\r\n*flags |= CRYPTO_TFM_RES_WEAK_KEY;\r\nreturn -EINVAL;\r\n}\r\nmemcpy(ctx->key, key, key_len);\r\nreturn 0;\r\n}\r\nstatic void des_encrypt(struct crypto_tfm *tfm, u8 *out, const u8 *in)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\ncrypt_s390_km(KM_DEA_ENCRYPT, ctx->key, out, in, DES_BLOCK_SIZE);\r\n}\r\nstatic void des_decrypt(struct crypto_tfm *tfm, u8 *out, const u8 *in)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\ncrypt_s390_km(KM_DEA_DECRYPT, ctx->key, out, in, DES_BLOCK_SIZE);\r\n}\r\nstatic int ecb_desall_crypt(struct blkcipher_desc *desc, long func,\r\nu8 *key, struct blkcipher_walk *walk)\r\n{\r\nint ret = blkcipher_walk_virt(desc, walk);\r\nunsigned int nbytes;\r\nwhile ((nbytes = walk->nbytes)) {\r\nunsigned int n = nbytes & ~(DES_BLOCK_SIZE - 1);\r\nu8 *out = walk->dst.virt.addr;\r\nu8 *in = walk->src.virt.addr;\r\nret = crypt_s390_km(func, key, out, in, n);\r\nif (ret < 0 || ret != n)\r\nreturn -EIO;\r\nnbytes &= DES_BLOCK_SIZE - 1;\r\nret = blkcipher_walk_done(desc, walk, nbytes);\r\n}\r\nreturn ret;\r\n}\r\nstatic int cbc_desall_crypt(struct blkcipher_desc *desc, long func,\r\nu8 *iv, struct blkcipher_walk *walk)\r\n{\r\nint ret = blkcipher_walk_virt(desc, walk);\r\nunsigned int nbytes = walk->nbytes;\r\nif (!nbytes)\r\ngoto out;\r\nmemcpy(iv, walk->iv, DES_BLOCK_SIZE);\r\ndo {\r\nunsigned int n = nbytes & ~(DES_BLOCK_SIZE - 1);\r\nu8 *out = walk->dst.virt.addr;\r\nu8 *in = walk->src.virt.addr;\r\nret = crypt_s390_kmc(func, iv, out, in, n);\r\nif (ret < 0 || ret != n)\r\nreturn -EIO;\r\nnbytes &= DES_BLOCK_SIZE - 1;\r\nret = blkcipher_walk_done(desc, walk, nbytes);\r\n} while ((nbytes = walk->nbytes));\r\nmemcpy(walk->iv, iv, DES_BLOCK_SIZE);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int ecb_des_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ecb_desall_crypt(desc, KM_DEA_ENCRYPT, ctx->key, &walk);\r\n}\r\nstatic int ecb_des_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ecb_desall_crypt(desc, KM_DEA_DECRYPT, ctx->key, &walk);\r\n}\r\nstatic int cbc_des_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn cbc_desall_crypt(desc, KMC_DEA_ENCRYPT, ctx->iv, &walk);\r\n}\r\nstatic int cbc_des_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn cbc_desall_crypt(desc, KMC_DEA_DECRYPT, ctx->iv, &walk);\r\n}\r\nstatic int des3_setkey(struct crypto_tfm *tfm, const u8 *key,\r\nunsigned int key_len)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\nu32 *flags = &tfm->crt_flags;\r\nif (!(memcmp(key, &key[DES_KEY_SIZE], DES_KEY_SIZE) &&\r\nmemcmp(&key[DES_KEY_SIZE], &key[DES_KEY_SIZE * 2],\r\nDES_KEY_SIZE)) &&\r\n(*flags & CRYPTO_TFM_REQ_WEAK_KEY)) {\r\n*flags |= CRYPTO_TFM_RES_WEAK_KEY;\r\nreturn -EINVAL;\r\n}\r\nmemcpy(ctx->key, key, key_len);\r\nreturn 0;\r\n}\r\nstatic void des3_encrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\ncrypt_s390_km(KM_TDEA_192_ENCRYPT, ctx->key, dst, src, DES_BLOCK_SIZE);\r\n}\r\nstatic void des3_decrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\ncrypt_s390_km(KM_TDEA_192_DECRYPT, ctx->key, dst, src, DES_BLOCK_SIZE);\r\n}\r\nstatic int ecb_des3_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ecb_desall_crypt(desc, KM_TDEA_192_ENCRYPT, ctx->key, &walk);\r\n}\r\nstatic int ecb_des3_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ecb_desall_crypt(desc, KM_TDEA_192_DECRYPT, ctx->key, &walk);\r\n}\r\nstatic int cbc_des3_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn cbc_desall_crypt(desc, KMC_TDEA_192_ENCRYPT, ctx->iv, &walk);\r\n}\r\nstatic int cbc_des3_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn cbc_desall_crypt(desc, KMC_TDEA_192_DECRYPT, ctx->iv, &walk);\r\n}\r\nstatic int ctr_desall_crypt(struct blkcipher_desc *desc, long func,\r\nstruct s390_des_ctx *ctx, struct blkcipher_walk *walk)\r\n{\r\nint ret = blkcipher_walk_virt_block(desc, walk, DES_BLOCK_SIZE);\r\nunsigned int i, n, nbytes;\r\nu8 buf[DES_BLOCK_SIZE];\r\nu8 *out, *in;\r\nmemcpy(ctrblk, walk->iv, DES_BLOCK_SIZE);\r\nwhile ((nbytes = walk->nbytes) >= DES_BLOCK_SIZE) {\r\nout = walk->dst.virt.addr;\r\nin = walk->src.virt.addr;\r\nwhile (nbytes >= DES_BLOCK_SIZE) {\r\nn = (nbytes > PAGE_SIZE) ? PAGE_SIZE :\r\nnbytes & ~(DES_BLOCK_SIZE - 1);\r\nfor (i = DES_BLOCK_SIZE; i < n; i += DES_BLOCK_SIZE) {\r\nmemcpy(ctrblk + i, ctrblk + i - DES_BLOCK_SIZE,\r\nDES_BLOCK_SIZE);\r\ncrypto_inc(ctrblk + i, DES_BLOCK_SIZE);\r\n}\r\nret = crypt_s390_kmctr(func, ctx->key, out, in, n, ctrblk);\r\nif (ret < 0 || ret != n)\r\nreturn -EIO;\r\nif (n > DES_BLOCK_SIZE)\r\nmemcpy(ctrblk, ctrblk + n - DES_BLOCK_SIZE,\r\nDES_BLOCK_SIZE);\r\ncrypto_inc(ctrblk, DES_BLOCK_SIZE);\r\nout += n;\r\nin += n;\r\nnbytes -= n;\r\n}\r\nret = blkcipher_walk_done(desc, walk, nbytes);\r\n}\r\nif (nbytes) {\r\nout = walk->dst.virt.addr;\r\nin = walk->src.virt.addr;\r\nret = crypt_s390_kmctr(func, ctx->key, buf, in,\r\nDES_BLOCK_SIZE, ctrblk);\r\nif (ret < 0 || ret != DES_BLOCK_SIZE)\r\nreturn -EIO;\r\nmemcpy(out, buf, nbytes);\r\ncrypto_inc(ctrblk, DES_BLOCK_SIZE);\r\nret = blkcipher_walk_done(desc, walk, 0);\r\n}\r\nmemcpy(walk->iv, ctrblk, DES_BLOCK_SIZE);\r\nreturn ret;\r\n}\r\nstatic int ctr_des_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ctr_desall_crypt(desc, KMCTR_DEA_ENCRYPT, ctx, &walk);\r\n}\r\nstatic int ctr_des_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ctr_desall_crypt(desc, KMCTR_DEA_DECRYPT, ctx, &walk);\r\n}\r\nstatic int ctr_des3_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ctr_desall_crypt(desc, KMCTR_TDEA_192_ENCRYPT, ctx, &walk);\r\n}\r\nstatic int ctr_des3_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ctr_desall_crypt(desc, KMCTR_TDEA_192_DECRYPT, ctx, &walk);\r\n}\r\nstatic int __init des_s390_init(void)\r\n{\r\nint ret;\r\nif (!crypt_s390_func_available(KM_DEA_ENCRYPT, CRYPT_S390_MSA) ||\r\n!crypt_s390_func_available(KM_TDEA_192_ENCRYPT, CRYPT_S390_MSA))\r\nreturn -EOPNOTSUPP;\r\nret = crypto_register_alg(&des_alg);\r\nif (ret)\r\ngoto des_err;\r\nret = crypto_register_alg(&ecb_des_alg);\r\nif (ret)\r\ngoto ecb_des_err;\r\nret = crypto_register_alg(&cbc_des_alg);\r\nif (ret)\r\ngoto cbc_des_err;\r\nret = crypto_register_alg(&des3_alg);\r\nif (ret)\r\ngoto des3_err;\r\nret = crypto_register_alg(&ecb_des3_alg);\r\nif (ret)\r\ngoto ecb_des3_err;\r\nret = crypto_register_alg(&cbc_des3_alg);\r\nif (ret)\r\ngoto cbc_des3_err;\r\nif (crypt_s390_func_available(KMCTR_DEA_ENCRYPT,\r\nCRYPT_S390_MSA | CRYPT_S390_MSA4) &&\r\ncrypt_s390_func_available(KMCTR_TDEA_192_ENCRYPT,\r\nCRYPT_S390_MSA | CRYPT_S390_MSA4)) {\r\nret = crypto_register_alg(&ctr_des_alg);\r\nif (ret)\r\ngoto ctr_des_err;\r\nret = crypto_register_alg(&ctr_des3_alg);\r\nif (ret)\r\ngoto ctr_des3_err;\r\nctrblk = (u8 *) __get_free_page(GFP_KERNEL);\r\nif (!ctrblk) {\r\nret = -ENOMEM;\r\ngoto ctr_mem_err;\r\n}\r\n}\r\nout:\r\nreturn ret;\r\nctr_mem_err:\r\ncrypto_unregister_alg(&ctr_des3_alg);\r\nctr_des3_err:\r\ncrypto_unregister_alg(&ctr_des_alg);\r\nctr_des_err:\r\ncrypto_unregister_alg(&cbc_des3_alg);\r\ncbc_des3_err:\r\ncrypto_unregister_alg(&ecb_des3_alg);\r\necb_des3_err:\r\ncrypto_unregister_alg(&des3_alg);\r\ndes3_err:\r\ncrypto_unregister_alg(&cbc_des_alg);\r\ncbc_des_err:\r\ncrypto_unregister_alg(&ecb_des_alg);\r\necb_des_err:\r\ncrypto_unregister_alg(&des_alg);\r\ndes_err:\r\ngoto out;\r\n}\r\nstatic void __exit des_s390_exit(void)\r\n{\r\nif (ctrblk) {\r\ncrypto_unregister_alg(&ctr_des_alg);\r\ncrypto_unregister_alg(&ctr_des3_alg);\r\nfree_page((unsigned long) ctrblk);\r\n}\r\ncrypto_unregister_alg(&cbc_des3_alg);\r\ncrypto_unregister_alg(&ecb_des3_alg);\r\ncrypto_unregister_alg(&des3_alg);\r\ncrypto_unregister_alg(&cbc_des_alg);\r\ncrypto_unregister_alg(&ecb_des_alg);\r\ncrypto_unregister_alg(&des_alg);\r\n}

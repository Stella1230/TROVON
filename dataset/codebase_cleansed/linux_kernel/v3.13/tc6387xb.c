static int tc6387xb_suspend(struct platform_device *dev, pm_message_t state)\r\n{\r\nstruct tc6387xb *tc6387xb = platform_get_drvdata(dev);\r\nstruct tc6387xb_platform_data *pdata = dev_get_platdata(&dev->dev);\r\nif (pdata && pdata->suspend)\r\npdata->suspend(dev);\r\nclk_disable(tc6387xb->clk32k);\r\nreturn 0;\r\n}\r\nstatic int tc6387xb_resume(struct platform_device *dev)\r\n{\r\nstruct tc6387xb *tc6387xb = platform_get_drvdata(dev);\r\nstruct tc6387xb_platform_data *pdata = dev_get_platdata(&dev->dev);\r\nclk_enable(tc6387xb->clk32k);\r\nif (pdata && pdata->resume)\r\npdata->resume(dev);\r\ntmio_core_mmc_resume(tc6387xb->scr + 0x200, 0,\r\ntc6387xb_mmc_resources[0].start & 0xfffe);\r\nreturn 0;\r\n}\r\nstatic void tc6387xb_mmc_pwr(struct platform_device *mmc, int state)\r\n{\r\nstruct platform_device *dev = to_platform_device(mmc->dev.parent);\r\nstruct tc6387xb *tc6387xb = platform_get_drvdata(dev);\r\ntmio_core_mmc_pwr(tc6387xb->scr + 0x200, 0, state);\r\n}\r\nstatic void tc6387xb_mmc_clk_div(struct platform_device *mmc, int state)\r\n{\r\nstruct platform_device *dev = to_platform_device(mmc->dev.parent);\r\nstruct tc6387xb *tc6387xb = platform_get_drvdata(dev);\r\ntmio_core_mmc_clk_div(tc6387xb->scr + 0x200, 0, state);\r\n}\r\nstatic int tc6387xb_mmc_enable(struct platform_device *mmc)\r\n{\r\nstruct platform_device *dev = to_platform_device(mmc->dev.parent);\r\nstruct tc6387xb *tc6387xb = platform_get_drvdata(dev);\r\nclk_enable(tc6387xb->clk32k);\r\ntmio_core_mmc_enable(tc6387xb->scr + 0x200, 0,\r\ntc6387xb_mmc_resources[0].start & 0xfffe);\r\nreturn 0;\r\n}\r\nstatic int tc6387xb_mmc_disable(struct platform_device *mmc)\r\n{\r\nstruct platform_device *dev = to_platform_device(mmc->dev.parent);\r\nstruct tc6387xb *tc6387xb = platform_get_drvdata(dev);\r\nclk_disable(tc6387xb->clk32k);\r\nreturn 0;\r\n}\r\nstatic int tc6387xb_probe(struct platform_device *dev)\r\n{\r\nstruct tc6387xb_platform_data *pdata = dev_get_platdata(&dev->dev);\r\nstruct resource *iomem, *rscr;\r\nstruct clk *clk32k;\r\nstruct tc6387xb *tc6387xb;\r\nint irq, ret;\r\niomem = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!iomem) {\r\nreturn -EINVAL;\r\n}\r\ntc6387xb = kzalloc(sizeof *tc6387xb, GFP_KERNEL);\r\nif (!tc6387xb)\r\nreturn -ENOMEM;\r\nret = platform_get_irq(dev, 0);\r\nif (ret >= 0)\r\nirq = ret;\r\nelse\r\ngoto err_no_irq;\r\nclk32k = clk_get(&dev->dev, "CLK_CK32K");\r\nif (IS_ERR(clk32k)) {\r\nret = PTR_ERR(clk32k);\r\ngoto err_no_clk;\r\n}\r\nrscr = &tc6387xb->rscr;\r\nrscr->name = "tc6387xb-core";\r\nrscr->start = iomem->start;\r\nrscr->end = iomem->start + 0xff;\r\nrscr->flags = IORESOURCE_MEM;\r\nret = request_resource(iomem, rscr);\r\nif (ret)\r\ngoto err_resource;\r\ntc6387xb->scr = ioremap(rscr->start, resource_size(rscr));\r\nif (!tc6387xb->scr) {\r\nret = -ENOMEM;\r\ngoto err_ioremap;\r\n}\r\ntc6387xb->clk32k = clk32k;\r\nplatform_set_drvdata(dev, tc6387xb);\r\nif (pdata && pdata->enable)\r\npdata->enable(dev);\r\nprintk(KERN_INFO "Toshiba tc6387xb initialised\n");\r\nret = mfd_add_devices(&dev->dev, dev->id, tc6387xb_cells,\r\nARRAY_SIZE(tc6387xb_cells), iomem, irq, NULL);\r\nif (!ret)\r\nreturn 0;\r\niounmap(tc6387xb->scr);\r\nerr_ioremap:\r\nrelease_resource(&tc6387xb->rscr);\r\nerr_resource:\r\nclk_put(clk32k);\r\nerr_no_clk:\r\nerr_no_irq:\r\nkfree(tc6387xb);\r\nreturn ret;\r\n}\r\nstatic int tc6387xb_remove(struct platform_device *dev)\r\n{\r\nstruct tc6387xb *tc6387xb = platform_get_drvdata(dev);\r\nmfd_remove_devices(&dev->dev);\r\niounmap(tc6387xb->scr);\r\nrelease_resource(&tc6387xb->rscr);\r\nclk_disable(tc6387xb->clk32k);\r\nclk_put(tc6387xb->clk32k);\r\nkfree(tc6387xb);\r\nreturn 0;\r\n}

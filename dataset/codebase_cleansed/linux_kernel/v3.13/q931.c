void\r\niecpy(u_char *dest, u_char *iestart, int ieoffset)\r\n{\r\nu_char *p;\r\nint l;\r\np = iestart + ieoffset + 2;\r\nl = iestart[1] - ieoffset;\r\nwhile (l--)\r\n*dest++ = *p++;\r\n*dest++ = '\0';\r\n}\r\nstatic int\r\nprbits(char *dest, u_char b, int start, int len)\r\n{\r\nchar *dp = dest;\r\nb = b << (8 - start);\r\nwhile (len--) {\r\nif (b & 0x80)\r\n*dp++ = '1';\r\nelse\r\n*dp++ = '0';\r\nb = b << 1;\r\n}\r\nreturn (dp - dest);\r\n}\r\nstatic\r\nu_char *\r\nskipext(u_char *p)\r\n{\r\nwhile (!(*p++ & 0x80));\r\nreturn (p);\r\n}\r\nstatic\r\nint\r\nprcause(char *dest, u_char *p)\r\n{\r\nu_char *end;\r\nchar *dp = dest;\r\nint i, cause;\r\nend = p + p[1] + 1;\r\np += 2;\r\ndp += sprintf(dp, " coding ");\r\ndp += prbits(dp, *p, 7, 2);\r\ndp += sprintf(dp, " location ");\r\ndp += prbits(dp, *p, 4, 4);\r\n*dp++ = '\n';\r\np = skipext(p);\r\ncause = 0x7f & *p++;\r\nfor (i = 0; i < CVSIZE; i++)\r\nif (cvlist[i].nr == cause)\r\nbreak;\r\nif (i == CVSIZE)\r\ndp += sprintf(dp, "Unknown cause type %x!\n", cause);\r\nelse\r\ndp += sprintf(dp, " cause value %x : %s \n", cause, cvlist[i].edescr);\r\nwhile (!0) {\r\nif (p > end)\r\nbreak;\r\ndp += sprintf(dp, " diag attribute %d ", *p++ & 0x7f);\r\ndp += sprintf(dp, " rej %d ", *p & 0x7f);\r\nif (*p & 0x80) {\r\n*dp++ = '\n';\r\nbreak;\r\n} else\r\ndp += sprintf(dp, " av %d\n", (*++p) & 0x7f);\r\n}\r\nreturn (dp - dest);\r\n}\r\nstatic int\r\nprcause_1tr6(char *dest, u_char *p)\r\n{\r\nchar *dp = dest;\r\nint i, cause;\r\np++;\r\nif (0 == *p) {\r\ndp += sprintf(dp, " OK (cause length=0)\n");\r\nreturn (dp - dest);\r\n} else if (*p > 1) {\r\ndp += sprintf(dp, " coding ");\r\ndp += prbits(dp, p[2], 7, 2);\r\ndp += sprintf(dp, " location ");\r\ndp += prbits(dp, p[2], 4, 4);\r\n*dp++ = '\n';\r\n}\r\np++;\r\ncause = 0x7f & *p;\r\nfor (i = 0; i < cause_1tr6_len; i++)\r\nif (cause_1tr6[i].nr == cause)\r\nbreak;\r\nif (i == cause_1tr6_len)\r\ndp += sprintf(dp, "Unknown cause type %x!\n", cause);\r\nelse\r\ndp += sprintf(dp, " cause value %x : %s \n", cause, cause_1tr6[i].descr);\r\nreturn (dp - dest);\r\n}\r\nstatic int\r\nprchident(char *dest, u_char *p)\r\n{\r\nchar *dp = dest;\r\np += 2;\r\ndp += sprintf(dp, " octet 3 ");\r\ndp += prbits(dp, *p, 8, 8);\r\n*dp++ = '\n';\r\nreturn (dp - dest);\r\n}\r\nstatic int\r\nprcalled(char *dest, u_char *p)\r\n{\r\nint l;\r\nchar *dp = dest;\r\np++;\r\nl = *p++ - 1;\r\ndp += sprintf(dp, " octet 3 ");\r\ndp += prbits(dp, *p++, 8, 8);\r\n*dp++ = '\n';\r\ndp += sprintf(dp, " number digits ");\r\nwhile (l--)\r\n*dp++ = *p++;\r\n*dp++ = '\n';\r\nreturn (dp - dest);\r\n}\r\nstatic int\r\nprcalling(char *dest, u_char *p)\r\n{\r\nint l;\r\nchar *dp = dest;\r\np++;\r\nl = *p++ - 1;\r\ndp += sprintf(dp, " octet 3 ");\r\ndp += prbits(dp, *p, 8, 8);\r\n*dp++ = '\n';\r\nif (!(*p & 0x80)) {\r\ndp += sprintf(dp, " octet 3a ");\r\ndp += prbits(dp, *++p, 8, 8);\r\n*dp++ = '\n';\r\nl--;\r\n};\r\np++;\r\ndp += sprintf(dp, " number digits ");\r\nwhile (l--)\r\n*dp++ = *p++;\r\n*dp++ = '\n';\r\nreturn (dp - dest);\r\n}\r\nstatic\r\nint\r\nprbearer(char *dest, u_char *p)\r\n{\r\nchar *dp = dest, ch;\r\np += 2;\r\ndp += sprintf(dp, " octet 3 ");\r\ndp += prbits(dp, *p++, 8, 8);\r\n*dp++ = '\n';\r\ndp += sprintf(dp, " octet 4 ");\r\ndp += prbits(dp, *p, 8, 8);\r\n*dp++ = '\n';\r\nif ((*p++ & 0x1f) == 0x18) {\r\ndp += sprintf(dp, " octet 4.1 ");\r\ndp += prbits(dp, *p++, 8, 8);\r\n*dp++ = '\n';\r\n}\r\nif ((*p & 0x60) == 0x20) {\r\nch = ' ';\r\ndo {\r\ndp += sprintf(dp, " octet 5%c ", ch);\r\ndp += prbits(dp, *p, 8, 8);\r\n*dp++ = '\n';\r\nif (ch == ' ')\r\nch = 'a';\r\nelse\r\nch++;\r\n}\r\nwhile (!(*p++ & 0x80));\r\n}\r\nif ((*p & 0x60) == 0x40) {\r\ndp += sprintf(dp, " octet 6 ");\r\ndp += prbits(dp, *p++, 8, 8);\r\n*dp++ = '\n';\r\n}\r\nif ((*p & 0x60) == 0x60) {\r\ndp += sprintf(dp, " octet 7 ");\r\ndp += prbits(dp, *p++, 8, 8);\r\n*dp++ = '\n';\r\n}\r\nreturn (dp - dest);\r\n}\r\nstatic\r\nint\r\nprbearer_ni1(char *dest, u_char *p)\r\n{\r\nchar *dp = dest;\r\nu_char len;\r\np++;\r\nlen = *p++;\r\ndp += sprintf(dp, " octet 3 ");\r\ndp += prbits(dp, *p, 8, 8);\r\nswitch (*p++) {\r\ncase 0x80:\r\ndp += sprintf(dp, " Speech");\r\nbreak;\r\ncase 0x88:\r\ndp += sprintf(dp, " Unrestricted digital information");\r\nbreak;\r\ncase 0x90:\r\ndp += sprintf(dp, " 3.1 kHz audio");\r\nbreak;\r\ndefault:\r\ndp += sprintf(dp, " Unknown information-transfer capability");\r\n}\r\n*dp++ = '\n';\r\ndp += sprintf(dp, " octet 4 ");\r\ndp += prbits(dp, *p, 8, 8);\r\nswitch (*p++) {\r\ncase 0x90:\r\ndp += sprintf(dp, " 64 kbps, circuit mode");\r\nbreak;\r\ncase 0xc0:\r\ndp += sprintf(dp, " Packet mode");\r\nbreak;\r\ndefault:\r\ndp += sprintf(dp, " Unknown transfer mode");\r\n}\r\n*dp++ = '\n';\r\nif (len > 2) {\r\ndp += sprintf(dp, " octet 5 ");\r\ndp += prbits(dp, *p, 8, 8);\r\nswitch (*p++) {\r\ncase 0x21:\r\ndp += sprintf(dp, " Rate adaption\n");\r\ndp += sprintf(dp, " octet 5a ");\r\ndp += prbits(dp, *p, 8, 8);\r\nbreak;\r\ncase 0xa2:\r\ndp += sprintf(dp, " u-law");\r\nbreak;\r\ndefault:\r\ndp += sprintf(dp, " Unknown UI layer 1 protocol");\r\n}\r\n*dp++ = '\n';\r\n}\r\nreturn (dp - dest);\r\n}\r\nstatic int\r\ngeneral(char *dest, u_char *p)\r\n{\r\nchar *dp = dest;\r\nchar ch = ' ';\r\nint l, octet = 3;\r\np++;\r\nl = *p++;\r\nwhile (l--) {\r\ndp += sprintf(dp, " octet %d%c ", octet, ch);\r\ndp += prbits(dp, *p++, 8, 8);\r\n*dp++ = '\n';\r\nif (*p & 0x80) {\r\noctet++;\r\nch = ' ';\r\n} else if (ch == ' ')\r\nch = 'a';\r\nelse\r\nch++;\r\n}\r\nreturn (dp - dest);\r\n}\r\nstatic int\r\ngeneral_ni1(char *dest, u_char *p)\r\n{\r\nchar *dp = dest;\r\nchar ch = ' ';\r\nint l, octet = 3;\r\np++;\r\nl = *p++;\r\nwhile (l--) {\r\ndp += sprintf(dp, " octet %d%c ", octet, ch);\r\ndp += prbits(dp, *p, 8, 8);\r\n*dp++ = '\n';\r\nif (*p++ & 0x80) {\r\noctet++;\r\nch = ' ';\r\n} else if (ch == ' ')\r\nch = 'a';\r\nelse\r\nch++;\r\n}\r\nreturn (dp - dest);\r\n}\r\nstatic int\r\nprcharge(char *dest, u_char *p)\r\n{\r\nchar *dp = dest;\r\nint l;\r\np++;\r\nl = *p++ - 1;\r\ndp += sprintf(dp, " GEA ");\r\ndp += prbits(dp, *p++, 8, 8);\r\ndp += sprintf(dp, " Anzahl: ");\r\nwhile (l--)\r\n*dp++ = *p++;\r\n*dp++ = '\n';\r\nreturn (dp - dest);\r\n}\r\nstatic int\r\nprtext(char *dest, u_char *p)\r\n{\r\nchar *dp = dest;\r\nint l;\r\np++;\r\nl = *p++;\r\ndp += sprintf(dp, " ");\r\nwhile (l--)\r\n*dp++ = *p++;\r\n*dp++ = '\n';\r\nreturn (dp - dest);\r\n}\r\nstatic int\r\nprfeatureind(char *dest, u_char *p)\r\n{\r\nchar *dp = dest;\r\np += 2;\r\ndp += sprintf(dp, " octet 3 ");\r\ndp += prbits(dp, *p, 8, 8);\r\n*dp++ = '\n';\r\nif (!(*p++ & 80)) {\r\ndp += sprintf(dp, " octet 4 ");\r\ndp += prbits(dp, *p++, 8, 8);\r\n*dp++ = '\n';\r\n}\r\ndp += sprintf(dp, " Status: ");\r\nswitch (*p) {\r\ncase 0:\r\ndp += sprintf(dp, "Idle");\r\nbreak;\r\ncase 1:\r\ndp += sprintf(dp, "Active");\r\nbreak;\r\ncase 2:\r\ndp += sprintf(dp, "Prompt");\r\nbreak;\r\ncase 3:\r\ndp += sprintf(dp, "Pending");\r\nbreak;\r\ndefault:\r\ndp += sprintf(dp, "(Reserved)");\r\nbreak;\r\n}\r\n*dp++ = '\n';\r\nreturn (dp - dest);\r\n}\r\nstatic int\r\ndisptext_ni1(char *dest, u_char *p)\r\n{\r\nchar *dp = dest;\r\nint l, tag, len, i;\r\np++;\r\nl = *p++ - 1;\r\nif (*p++ != 0x80) {\r\ndp += sprintf(dp, " Unknown display type\n");\r\nreturn (dp - dest);\r\n}\r\nwhile (l > 0) {\r\ntag = *p++;\r\nlen = *p++;\r\nl -= len + 2;\r\nif ((tag == 0x80) || (tag == 0x81)) p++;\r\nelse {\r\nfor (i = 0; i < DTAGSIZE; i++)\r\nif (tag == dtaglist[i].nr)\r\nbreak;\r\nif (i != DTAGSIZE) {\r\ndp += sprintf(dp, " %s: ", dtaglist[i].descr);\r\nwhile (len--)\r\n*dp++ = *p++;\r\n} else {\r\ndp += sprintf(dp, " (unknown display tag %2x): ", tag);\r\nwhile (len--)\r\n*dp++ = *p++;\r\n}\r\ndp += sprintf(dp, "\n");\r\n}\r\n}\r\nreturn (dp - dest);\r\n}\r\nstatic int\r\ndisplay(char *dest, u_char *p)\r\n{\r\nchar *dp = dest;\r\nchar ch = ' ';\r\nint l, octet = 3;\r\np++;\r\nl = *p++;\r\ndp += sprintf(dp, " \"");\r\nwhile (l--) {\r\ndp += sprintf(dp, "%c", *p++);\r\nif (*p & 0x80) {\r\noctet++;\r\nch = ' ';\r\n} else if (ch == ' ')\r\nch = 'a';\r\nelse\r\nch++;\r\n}\r\n*dp++ = '\"';\r\n*dp++ = '\n';\r\nreturn (dp - dest);\r\n}\r\nstatic int\r\nprfacility(char *dest, u_char *p)\r\n{\r\nchar *dp = dest;\r\nint l, l2;\r\np++;\r\nl = *p++;\r\ndp += sprintf(dp, " octet 3 ");\r\ndp += prbits(dp, *p++, 8, 8);\r\ndp += sprintf(dp, "\n");\r\nl -= 1;\r\nwhile (l > 0) {\r\ndp += sprintf(dp, " octet 4 ");\r\ndp += prbits(dp, *p++, 8, 8);\r\ndp += sprintf(dp, "\n");\r\ndp += sprintf(dp, " octet 5 %d\n", l2 = *p++ & 0x7f);\r\nl -= 2;\r\ndp += sprintf(dp, " contents ");\r\nwhile (l2--) {\r\ndp += sprintf(dp, "%2x ", *p++);\r\nl--;\r\n}\r\ndp += sprintf(dp, "\n");\r\n}\r\nreturn (dp - dest);\r\n}\r\nint\r\nQuickHex(char *txt, u_char *p, int cnt)\r\n{\r\nregister int i;\r\nregister char *t = txt;\r\nfor (i = 0; i < cnt; i++) {\r\n*t++ = ' ';\r\n*t++ = hex_asc_hi(p[i]);\r\n*t++ = hex_asc_lo(p[i]);\r\n}\r\n*t++ = 0;\r\nreturn (t - txt);\r\n}\r\nvoid\r\nLogFrame(struct IsdnCardState *cs, u_char *buf, int size)\r\n{\r\nchar *dp;\r\nif (size < 1)\r\nreturn;\r\ndp = cs->dlog;\r\nif (size < MAX_DLOG_SPACE / 3 - 10) {\r\n*dp++ = 'H';\r\n*dp++ = 'E';\r\n*dp++ = 'X';\r\n*dp++ = ':';\r\ndp += QuickHex(dp, buf, size);\r\ndp--;\r\n*dp++ = '\n';\r\n*dp = 0;\r\nHiSax_putstatus(cs, NULL, "%s", cs->dlog);\r\n} else\r\nHiSax_putstatus(cs, "LogFrame: ", "warning Frame too big (%d)", size);\r\n}\r\nvoid\r\ndlogframe(struct IsdnCardState *cs, struct sk_buff *skb, int dir)\r\n{\r\nu_char *bend, *buf;\r\nchar *dp;\r\nunsigned char pd, cr_l, cr, mt;\r\nunsigned char sapi, tei, ftyp;\r\nint i, cset = 0, cs_old = 0, cs_fest = 0;\r\nint size, finish = 0;\r\nif (skb->len < 3)\r\nreturn;\r\ndp = cs->dlog;\r\ndp += jiftime(dp, jiffies);\r\n*dp++ = ' ';\r\nsapi = skb->data[0] >> 2;\r\ntei = skb->data[1] >> 1;\r\nftyp = skb->data[2];\r\nbuf = skb->data;\r\ndp += sprintf(dp, "frame %s ", dir ? "network->user" : "user->network");\r\nsize = skb->len;\r\nif (tei == GROUP_TEI) {\r\nif (sapi == CTRL_SAPI) {\r\nif (ftyp == 3) {\r\ndp += sprintf(dp, "broadcast\n");\r\nbuf += 3;\r\nsize -= 3;\r\n} else {\r\ndp += sprintf(dp, "no UI broadcast\n");\r\nfinish = 1;\r\n}\r\n} else if (sapi == TEI_SAPI) {\r\ndp += sprintf(dp, "tei management\n");\r\nfinish = 1;\r\n} else {\r\ndp += sprintf(dp, "unknown sapi %d broadcast\n", sapi);\r\nfinish = 1;\r\n}\r\n} else {\r\nif (sapi == CTRL_SAPI) {\r\nif (!(ftyp & 1)) {\r\ndp += sprintf(dp, "with tei %d\n", tei);\r\nbuf += 4;\r\nsize -= 4;\r\n} else {\r\ndp += sprintf(dp, "SFrame with tei %d\n", tei);\r\nfinish = 1;\r\n}\r\n} else {\r\ndp += sprintf(dp, "unknown sapi %d tei %d\n", sapi, tei);\r\nfinish = 1;\r\n}\r\n}\r\nbend = skb->data + skb->len;\r\nif (buf >= bend) {\r\ndp += sprintf(dp, "frame too short\n");\r\nfinish = 1;\r\n}\r\nif (finish) {\r\n*dp = 0;\r\nHiSax_putstatus(cs, NULL, "%s", cs->dlog);\r\nreturn;\r\n}\r\nif ((0xfe & buf[0]) == PROTO_DIS_N0) {\r\npd = *buf++;\r\ncr_l = *buf++;\r\nif (cr_l)\r\ncr = *buf++;\r\nelse\r\ncr = 0;\r\nmt = *buf++;\r\nif (pd == PROTO_DIS_N0) {\r\nfor (i = 0; i < MT_N0_LEN; i++)\r\nif (mt_n0[i].nr == mt)\r\nbreak;\r\nif (i == MT_N0_LEN)\r\ndp += sprintf(dp, "callref %d %s size %d unknown message type N0 %x!\n",\r\ncr & 0x7f, (cr & 0x80) ? "called" : "caller",\r\nsize, mt);\r\nelse\r\ndp += sprintf(dp, "callref %d %s size %d message type %s\n",\r\ncr & 0x7f, (cr & 0x80) ? "called" : "caller",\r\nsize, mt_n0[i].descr);\r\n} else {\r\nfor (i = 0; i < MT_N1_LEN; i++)\r\nif (mt_n1[i].nr == mt)\r\nbreak;\r\nif (i == MT_N1_LEN)\r\ndp += sprintf(dp, "callref %d %s size %d unknown message type N1 %x!\n",\r\ncr & 0x7f, (cr & 0x80) ? "called" : "caller",\r\nsize, mt);\r\nelse\r\ndp += sprintf(dp, "callref %d %s size %d message type %s\n",\r\ncr & 0x7f, (cr & 0x80) ? "called" : "caller",\r\nsize, mt_n1[i].descr);\r\n}\r\nwhile (buf < bend) {\r\nif (*buf & 0x80) {\r\nswitch ((*buf >> 4) & 7) {\r\ncase 1:\r\ndp += sprintf(dp, " Shift %x\n", *buf & 0xf);\r\ncs_old = cset;\r\ncset = *buf & 7;\r\ncs_fest = *buf & 8;\r\nbreak;\r\ncase 3:\r\ndp += sprintf(dp, " Congestion level %x\n", *buf & 0xf);\r\nbreak;\r\ncase 2:\r\nif (*buf == 0xa0) {\r\ndp += sprintf(dp, " More data\n");\r\nbreak;\r\n}\r\nif (*buf == 0xa1) {\r\ndp += sprintf(dp, " Sending complete\n");\r\n}\r\nbreak;\r\ndefault:\r\ndp += sprintf(dp, " Reserved %x\n", *buf);\r\nbreak;\r\n}\r\nbuf++;\r\ncontinue;\r\n}\r\nif (cset == 0) {\r\nfor (i = 0; i < WE_0_LEN; i++)\r\nif (*buf == we_0[i].nr)\r\nbreak;\r\nif (i != WE_0_LEN) {\r\ndp += sprintf(dp, " %s\n", we_0[i].descr);\r\ndp += we_0[i].f(dp, buf);\r\n} else\r\ndp += sprintf(dp, " Codeset %d attribute %x attribute size %d\n", cset, *buf, buf[1]);\r\n} else if (cset == 6) {\r\nfor (i = 0; i < WE_6_LEN; i++)\r\nif (*buf == we_6[i].nr)\r\nbreak;\r\nif (i != WE_6_LEN) {\r\ndp += sprintf(dp, " %s\n", we_6[i].descr);\r\ndp += we_6[i].f(dp, buf);\r\n} else\r\ndp += sprintf(dp, " Codeset %d attribute %x attribute size %d\n", cset, *buf, buf[1]);\r\n} else\r\ndp += sprintf(dp, " Unknown Codeset %d attribute %x attribute size %d\n", cset, *buf, buf[1]);\r\nif (cs_fest == 8) {\r\ncset = cs_old;\r\ncs_old = 0;\r\ncs_fest = 0;\r\n}\r\nbuf += buf[1] + 2;\r\n}\r\n} else if ((buf[0] == 8) && (cs->protocol == ISDN_PTYPE_NI1)) {\r\nbuf++;\r\ncr_l = *buf++;\r\nif (cr_l)\r\ncr = *buf++;\r\nelse\r\ncr = 0;\r\nmt = *buf++;\r\nfor (i = 0; i < MTSIZE; i++)\r\nif (mtlist[i].nr == mt)\r\nbreak;\r\nif (i == MTSIZE)\r\ndp += sprintf(dp, "callref %d %s size %d unknown message type %x!\n",\r\ncr & 0x7f, (cr & 0x80) ? "called" : "caller",\r\nsize, mt);\r\nelse\r\ndp += sprintf(dp, "callref %d %s size %d message type %s\n",\r\ncr & 0x7f, (cr & 0x80) ? "called" : "caller",\r\nsize, mtlist[i].descr);\r\nwhile (buf < bend) {\r\nif (*buf & 0x80) {\r\nswitch ((*buf >> 4) & 7) {\r\ncase 1:\r\ndp += sprintf(dp, " Shift %x\n", *buf & 0xf);\r\ncs_old = cset;\r\ncset = *buf & 7;\r\ncs_fest = *buf & 8;\r\nbreak;\r\ndefault:\r\ndp += sprintf(dp, " Unknown single-octet IE %x\n", *buf);\r\nbreak;\r\n}\r\nbuf++;\r\ncontinue;\r\n}\r\nif (cset == 0) {\r\nfor (i = 0; i < IESIZE_NI1; i++)\r\nif (*buf == ielist_ni1[i].nr)\r\nbreak;\r\nif (i != IESIZE_NI1) {\r\ndp += sprintf(dp, " %s\n", ielist_ni1[i].descr);\r\ndp += ielist_ni1[i].f(dp, buf);\r\n} else\r\ndp += sprintf(dp, " attribute %x attribute size %d\n", *buf, buf[1]);\r\n} else if (cset == 5) {\r\nfor (i = 0; i < IESIZE_NI1_CS5; i++)\r\nif (*buf == ielist_ni1_cs5[i].nr)\r\nbreak;\r\nif (i != IESIZE_NI1_CS5) {\r\ndp += sprintf(dp, " %s\n", ielist_ni1_cs5[i].descr);\r\ndp += ielist_ni1_cs5[i].f(dp, buf);\r\n} else\r\ndp += sprintf(dp, " attribute %x attribute size %d\n", *buf, buf[1]);\r\n} else if (cset == 6) {\r\nfor (i = 0; i < IESIZE_NI1_CS6; i++)\r\nif (*buf == ielist_ni1_cs6[i].nr)\r\nbreak;\r\nif (i != IESIZE_NI1_CS6) {\r\ndp += sprintf(dp, " %s\n", ielist_ni1_cs6[i].descr);\r\ndp += ielist_ni1_cs6[i].f(dp, buf);\r\n} else\r\ndp += sprintf(dp, " attribute %x attribute size %d\n", *buf, buf[1]);\r\n} else\r\ndp += sprintf(dp, " Unknown Codeset %d attribute %x attribute size %d\n", cset, *buf, buf[1]);\r\nif (cs_fest == 8) {\r\ncset = cs_old;\r\ncs_old = 0;\r\ncs_fest = 0;\r\n}\r\nbuf += buf[1] + 2;\r\n}\r\n} else if ((buf[0] == 8) && (cs->protocol == ISDN_PTYPE_EURO)) {\r\nbuf++;\r\ncr_l = *buf++;\r\nif (cr_l)\r\ncr = *buf++;\r\nelse\r\ncr = 0;\r\nmt = *buf++;\r\nfor (i = 0; i < MTSIZE; i++)\r\nif (mtlist[i].nr == mt)\r\nbreak;\r\nif (i == MTSIZE)\r\ndp += sprintf(dp, "callref %d %s size %d unknown message type %x!\n",\r\ncr & 0x7f, (cr & 0x80) ? "called" : "caller",\r\nsize, mt);\r\nelse\r\ndp += sprintf(dp, "callref %d %s size %d message type %s\n",\r\ncr & 0x7f, (cr & 0x80) ? "called" : "caller",\r\nsize, mtlist[i].descr);\r\nwhile (buf < bend) {\r\nif (*buf & 0x80) {\r\nswitch ((*buf >> 4) & 7) {\r\ncase 1:\r\ndp += sprintf(dp, " Shift %x\n", *buf & 0xf);\r\nbreak;\r\ncase 3:\r\ndp += sprintf(dp, " Congestion level %x\n", *buf & 0xf);\r\nbreak;\r\ncase 5:\r\ndp += sprintf(dp, " Repeat indicator %x\n", *buf & 0xf);\r\nbreak;\r\ncase 2:\r\nif (*buf == 0xa0) {\r\ndp += sprintf(dp, " More data\n");\r\nbreak;\r\n}\r\nif (*buf == 0xa1) {\r\ndp += sprintf(dp, " Sending complete\n");\r\n}\r\nbreak;\r\ndefault:\r\ndp += sprintf(dp, " Reserved %x\n", *buf);\r\nbreak;\r\n}\r\nbuf++;\r\ncontinue;\r\n}\r\nfor (i = 0; i < IESIZE; i++)\r\nif (*buf == ielist[i].nr)\r\nbreak;\r\nif (i != IESIZE) {\r\ndp += sprintf(dp, " %s\n", ielist[i].descr);\r\ndp += ielist[i].f(dp, buf);\r\n} else\r\ndp += sprintf(dp, " attribute %x attribute size %d\n", *buf, buf[1]);\r\nbuf += buf[1] + 2;\r\n}\r\n} else {\r\ndp += sprintf(dp, "Unknown protocol %x!", buf[0]);\r\n}\r\n*dp = 0;\r\nHiSax_putstatus(cs, NULL, "%s", cs->dlog);\r\n}

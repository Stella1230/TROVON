static void com20020_copy_from_card(struct net_device *dev, int bufnum,\r\nint offset, void *buf, int count)\r\n{\r\nint ioaddr = dev->base_addr, ofs = 512 * bufnum + offset;\r\noutb((ofs >> 8) | RDDATAflag | AUTOINCflag, _ADDR_HI);\r\noutb(ofs & 0xff, _ADDR_LO);\r\nTIME("insb", count, insb(_MEMDATA, buf, count));\r\n}\r\nstatic void com20020_copy_to_card(struct net_device *dev, int bufnum,\r\nint offset, void *buf, int count)\r\n{\r\nint ioaddr = dev->base_addr, ofs = 512 * bufnum + offset;\r\noutb((ofs >> 8) | AUTOINCflag, _ADDR_HI);\r\noutb(ofs & 0xff, _ADDR_LO);\r\nTIME("outsb", count, outsb(_MEMDATA, buf, count));\r\n}\r\nint com20020_check(struct net_device *dev)\r\n{\r\nint ioaddr = dev->base_addr, status;\r\nstruct arcnet_local *lp = netdev_priv(dev);\r\nARCRESET0;\r\nmdelay(RESETtime);\r\nlp->setup = lp->clockm ? 0 : (lp->clockp << 1);\r\nlp->setup2 = (lp->clockm << 4) | 8;\r\nlp->setup = lp->setup | P1MODE;\r\nSET_SUBADR(SUB_SETUP1);\r\noutb(lp->setup, _XREG);\r\nif (lp->clockm != 0)\r\n{\r\nSET_SUBADR(SUB_SETUP2);\r\noutb(lp->setup2, _XREG);\r\nmdelay(1);\r\noutb(0x18, _COMMAND);\r\n}\r\nlp->config = 0x21 | (lp->timeout << 3) | (lp->backplane << 2);\r\nSETCONF;\r\noutb(0x42, ioaddr + BUS_ALIGN*7);\r\nstatus = ASTATUS();\r\nif ((status & 0x99) != (NORXflag | TXFREEflag | RESETflag)) {\r\nBUGMSG(D_NORMAL, "status invalid (%Xh).\n", status);\r\nreturn -ENODEV;\r\n}\r\nBUGMSG(D_INIT_REASONS, "status after reset: %X\n", status);\r\noutb(0x39, _CONFIG);\r\noutb(inb(ioaddr + BUS_ALIGN*8), ioaddr + BUS_ALIGN*7);\r\nACOMMAND(CFLAGScmd | RESETclear | CONFIGclear);\r\nstatus = ASTATUS();\r\nBUGMSG(D_INIT_REASONS, "status after reset acknowledged: %X\n",\r\nstatus);\r\noutb(0 | RDDATAflag | AUTOINCflag, _ADDR_HI);\r\noutb(0, _ADDR_LO);\r\nif ((status = inb(_MEMDATA)) != TESTvalue) {\r\nBUGMSG(D_NORMAL, "Signature byte not found (%02Xh != D1h).\n",\r\nstatus);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nint com20020_found(struct net_device *dev, int shared)\r\n{\r\nstruct arcnet_local *lp;\r\nint ioaddr = dev->base_addr;\r\nlp = netdev_priv(dev);\r\nlp->hw.owner = THIS_MODULE;\r\nlp->hw.command = com20020_command;\r\nlp->hw.status = com20020_status;\r\nlp->hw.intmask = com20020_setmask;\r\nlp->hw.reset = com20020_reset;\r\nlp->hw.copy_to_card = com20020_copy_to_card;\r\nlp->hw.copy_from_card = com20020_copy_from_card;\r\nlp->hw.close = com20020_close;\r\nif (!dev->dev_addr[0])\r\ndev->dev_addr[0] = inb(ioaddr + BUS_ALIGN*8);\r\nSET_SUBADR(SUB_SETUP1);\r\noutb(lp->setup, _XREG);\r\nif (lp->card_flags & ARC_CAN_10MBIT)\r\n{\r\nSET_SUBADR(SUB_SETUP2);\r\noutb(lp->setup2, _XREG);\r\nmdelay(1);\r\noutb(0x18, _COMMAND);\r\n}\r\nlp->config = 0x20 | (lp->timeout << 3) | (lp->backplane << 2) | 1;\r\nSETCONF;\r\noutb(dev->dev_addr[0], _XREG);\r\nif (request_irq(dev->irq, arcnet_interrupt, shared,\r\n"arcnet (COM20020)", dev)) {\r\nBUGMSG(D_NORMAL, "Can't get IRQ %d!\n", dev->irq);\r\nreturn -ENODEV;\r\n}\r\ndev->base_addr = ioaddr;\r\nBUGMSG(D_NORMAL, "%s: station %02Xh found at %03lXh, IRQ %d.\n",\r\nlp->card_name, dev->dev_addr[0], dev->base_addr, dev->irq);\r\nif (lp->backplane)\r\nBUGMSG(D_NORMAL, "Using backplane mode.\n");\r\nif (lp->timeout != 3)\r\nBUGMSG(D_NORMAL, "Using extended timeout value of %d.\n", lp->timeout);\r\nBUGMSG(D_NORMAL, "Using CKP %d - data rate %s.\n",\r\nlp->setup >> 1,\r\nclockrates[3 - ((lp->setup2 & 0xF0) >> 4) + ((lp->setup & 0x0F) >> 1)]);\r\nif (register_netdev(dev)) {\r\nfree_irq(dev->irq, dev);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int com20020_reset(struct net_device *dev, int really_reset)\r\n{\r\nstruct arcnet_local *lp = netdev_priv(dev);\r\nu_int ioaddr = dev->base_addr;\r\nu_char inbyte;\r\nBUGMSG(D_DEBUG, "%s: %d: %s: dev: %p, lp: %p, dev->name: %s\n",\r\n__FILE__,__LINE__,__func__,dev,lp,dev->name);\r\nBUGMSG(D_INIT, "Resetting %s (status=%02Xh)\n",\r\ndev->name, ASTATUS());\r\nBUGMSG(D_DEBUG, "%s: %d: %s\n",__FILE__,__LINE__,__func__);\r\nlp->config = TXENcfg | (lp->timeout << 3) | (lp->backplane << 2);\r\nSETCONF;\r\nBUGMSG(D_DEBUG, "%s: %d: %s\n",__FILE__,__LINE__,__func__);\r\nif (really_reset) {\r\nARCRESET;\r\nmdelay(RESETtime * 2);\r\n}\r\nBUGMSG(D_DEBUG, "%s: %d: %s\n",__FILE__,__LINE__,__func__);\r\nACOMMAND(CFLAGScmd | RESETclear | CONFIGclear);\r\nBUGMSG(D_DEBUG, "%s: %d: %s\n",__FILE__,__LINE__,__func__);\r\ncom20020_copy_from_card(dev, 0, 0, &inbyte, 1);\r\nBUGMSG(D_DEBUG, "%s: %d: %s\n",__FILE__,__LINE__,__func__);\r\nif (inbyte != TESTvalue) {\r\nBUGMSG(D_DEBUG, "%s: %d: %s\n",__FILE__,__LINE__,__func__);\r\nBUGMSG(D_NORMAL, "reset failed: TESTvalue not present.\n");\r\nreturn 1;\r\n}\r\nACOMMAND(CONFIGcmd | EXTconf);\r\nBUGMSG(D_DEBUG, "%s: %d: %s\n",__FILE__,__LINE__,__func__);\r\nreturn 0;\r\n}\r\nstatic void com20020_setmask(struct net_device *dev, int mask)\r\n{\r\nu_int ioaddr = dev->base_addr;\r\nBUGMSG(D_DURING, "Setting mask to %x at %x\n",mask,ioaddr);\r\nAINTMASK(mask);\r\n}\r\nstatic void com20020_command(struct net_device *dev, int cmd)\r\n{\r\nu_int ioaddr = dev->base_addr;\r\nACOMMAND(cmd);\r\n}\r\nstatic int com20020_status(struct net_device *dev)\r\n{\r\nu_int ioaddr = dev->base_addr;\r\nreturn ASTATUS() + (ADIAGSTATUS()<<8);\r\n}\r\nstatic void com20020_close(struct net_device *dev)\r\n{\r\nstruct arcnet_local *lp = netdev_priv(dev);\r\nint ioaddr = dev->base_addr;\r\nlp->config &= ~TXENcfg;\r\nSETCONF;\r\n}\r\nstatic void com20020_set_mc_list(struct net_device *dev)\r\n{\r\nstruct arcnet_local *lp = netdev_priv(dev);\r\nint ioaddr = dev->base_addr;\r\nif ((dev->flags & IFF_PROMISC) && (dev->flags & IFF_UP)) {\r\nif (!(lp->setup & PROMISCset))\r\nBUGMSG(D_NORMAL, "Setting promiscuous flag...\n");\r\nSET_SUBADR(SUB_SETUP1);\r\nlp->setup |= PROMISCset;\r\noutb(lp->setup, _XREG);\r\n} else\r\n{\r\nif ((lp->setup & PROMISCset))\r\nBUGMSG(D_NORMAL, "Resetting promiscuous flag...\n");\r\nSET_SUBADR(SUB_SETUP1);\r\nlp->setup &= ~PROMISCset;\r\noutb(lp->setup, _XREG);\r\n}\r\n}\r\nstatic int __init com20020_module_init(void)\r\n{\r\nBUGLVL(D_NORMAL) printk(VERSION);\r\nreturn 0;\r\n}\r\nstatic void __exit com20020_module_exit(void)\r\n{\r\n}

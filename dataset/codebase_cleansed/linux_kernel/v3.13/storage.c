static int romfs_mtd_read(struct super_block *sb, unsigned long pos,\r\nvoid *buf, size_t buflen)\r\n{\r\nsize_t rlen;\r\nint ret;\r\nret = ROMFS_MTD_READ(sb, pos, buflen, &rlen, buf);\r\nreturn (ret < 0 || rlen != buflen) ? -EIO : 0;\r\n}\r\nstatic ssize_t romfs_mtd_strnlen(struct super_block *sb,\r\nunsigned long pos, size_t maxlen)\r\n{\r\nssize_t n = 0;\r\nsize_t segment;\r\nu_char buf[16], *p;\r\nsize_t len;\r\nint ret;\r\nwhile (maxlen > 0) {\r\nsegment = min_t(size_t, maxlen, 16);\r\nret = ROMFS_MTD_READ(sb, pos, segment, &len, buf);\r\nif (ret < 0)\r\nreturn ret;\r\np = memchr(buf, 0, len);\r\nif (p)\r\nreturn n + (p - buf);\r\nmaxlen -= len;\r\npos += len;\r\nn += len;\r\n}\r\nreturn n;\r\n}\r\nstatic int romfs_mtd_strcmp(struct super_block *sb, unsigned long pos,\r\nconst char *str, size_t size)\r\n{\r\nu_char buf[17];\r\nsize_t len, segment;\r\nint ret;\r\nbuf[0] = 0xff;\r\nwhile (size > 0) {\r\nsegment = min_t(size_t, size + 1, 17);\r\nret = ROMFS_MTD_READ(sb, pos, segment, &len, buf);\r\nif (ret < 0)\r\nreturn ret;\r\nlen--;\r\nif (memcmp(buf, str, len) != 0)\r\nreturn 0;\r\nbuf[0] = buf[len];\r\nsize -= len;\r\npos += len;\r\nstr += len;\r\n}\r\nif (buf[0])\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int romfs_blk_read(struct super_block *sb, unsigned long pos,\r\nvoid *buf, size_t buflen)\r\n{\r\nstruct buffer_head *bh;\r\nunsigned long offset;\r\nsize_t segment;\r\nwhile (buflen > 0) {\r\noffset = pos & (ROMBSIZE - 1);\r\nsegment = min_t(size_t, buflen, ROMBSIZE - offset);\r\nbh = sb_bread(sb, pos >> ROMBSBITS);\r\nif (!bh)\r\nreturn -EIO;\r\nmemcpy(buf, bh->b_data + offset, segment);\r\nbrelse(bh);\r\nbuf += segment;\r\nbuflen -= segment;\r\npos += segment;\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t romfs_blk_strnlen(struct super_block *sb,\r\nunsigned long pos, size_t limit)\r\n{\r\nstruct buffer_head *bh;\r\nunsigned long offset;\r\nssize_t n = 0;\r\nsize_t segment;\r\nu_char *buf, *p;\r\nwhile (limit > 0) {\r\noffset = pos & (ROMBSIZE - 1);\r\nsegment = min_t(size_t, limit, ROMBSIZE - offset);\r\nbh = sb_bread(sb, pos >> ROMBSBITS);\r\nif (!bh)\r\nreturn -EIO;\r\nbuf = bh->b_data + offset;\r\np = memchr(buf, 0, segment);\r\nbrelse(bh);\r\nif (p)\r\nreturn n + (p - buf);\r\nlimit -= segment;\r\npos += segment;\r\nn += segment;\r\n}\r\nreturn n;\r\n}\r\nstatic int romfs_blk_strcmp(struct super_block *sb, unsigned long pos,\r\nconst char *str, size_t size)\r\n{\r\nstruct buffer_head *bh;\r\nunsigned long offset;\r\nsize_t segment;\r\nbool matched, terminated = false;\r\nwhile (size > 0) {\r\noffset = pos & (ROMBSIZE - 1);\r\nsegment = min_t(size_t, size, ROMBSIZE - offset);\r\nbh = sb_bread(sb, pos >> ROMBSBITS);\r\nif (!bh)\r\nreturn -EIO;\r\nmatched = (memcmp(bh->b_data + offset, str, segment) == 0);\r\nsize -= segment;\r\npos += segment;\r\nstr += segment;\r\nif (matched && size == 0 && offset + segment < ROMBSIZE) {\r\nif (!bh->b_data[offset + segment])\r\nterminated = true;\r\nelse\r\nmatched = false;\r\n}\r\nbrelse(bh);\r\nif (!matched)\r\nreturn 0;\r\n}\r\nif (!terminated) {\r\nBUG_ON((pos & (ROMBSIZE - 1)) != 0);\r\nbh = sb_bread(sb, pos >> ROMBSBITS);\r\nif (!bh)\r\nreturn -EIO;\r\nmatched = !bh->b_data[0];\r\nbrelse(bh);\r\nif (!matched)\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint romfs_dev_read(struct super_block *sb, unsigned long pos,\r\nvoid *buf, size_t buflen)\r\n{\r\nsize_t limit;\r\nlimit = romfs_maxsize(sb);\r\nif (pos >= limit)\r\nreturn -EIO;\r\nif (buflen > limit - pos)\r\nbuflen = limit - pos;\r\n#ifdef CONFIG_ROMFS_ON_MTD\r\nif (sb->s_mtd)\r\nreturn romfs_mtd_read(sb, pos, buf, buflen);\r\n#endif\r\n#ifdef CONFIG_ROMFS_ON_BLOCK\r\nif (sb->s_bdev)\r\nreturn romfs_blk_read(sb, pos, buf, buflen);\r\n#endif\r\nreturn -EIO;\r\n}\r\nssize_t romfs_dev_strnlen(struct super_block *sb,\r\nunsigned long pos, size_t maxlen)\r\n{\r\nsize_t limit;\r\nlimit = romfs_maxsize(sb);\r\nif (pos >= limit)\r\nreturn -EIO;\r\nif (maxlen > limit - pos)\r\nmaxlen = limit - pos;\r\n#ifdef CONFIG_ROMFS_ON_MTD\r\nif (sb->s_mtd)\r\nreturn romfs_mtd_strnlen(sb, pos, maxlen);\r\n#endif\r\n#ifdef CONFIG_ROMFS_ON_BLOCK\r\nif (sb->s_bdev)\r\nreturn romfs_blk_strnlen(sb, pos, maxlen);\r\n#endif\r\nreturn -EIO;\r\n}\r\nint romfs_dev_strcmp(struct super_block *sb, unsigned long pos,\r\nconst char *str, size_t size)\r\n{\r\nsize_t limit;\r\nlimit = romfs_maxsize(sb);\r\nif (pos >= limit)\r\nreturn -EIO;\r\nif (size > ROMFS_MAXFN)\r\nreturn -ENAMETOOLONG;\r\nif (size + 1 > limit - pos)\r\nreturn -EIO;\r\n#ifdef CONFIG_ROMFS_ON_MTD\r\nif (sb->s_mtd)\r\nreturn romfs_mtd_strcmp(sb, pos, str, size);\r\n#endif\r\n#ifdef CONFIG_ROMFS_ON_BLOCK\r\nif (sb->s_bdev)\r\nreturn romfs_blk_strcmp(sb, pos, str, size);\r\n#endif\r\nreturn -EIO;\r\n}

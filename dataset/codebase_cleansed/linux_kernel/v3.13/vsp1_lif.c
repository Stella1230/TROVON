static inline u32 vsp1_lif_read(struct vsp1_lif *lif, u32 reg)\r\n{\r\nreturn vsp1_read(lif->entity.vsp1, reg);\r\n}\r\nstatic inline void vsp1_lif_write(struct vsp1_lif *lif, u32 reg, u32 data)\r\n{\r\nvsp1_write(lif->entity.vsp1, reg, data);\r\n}\r\nstatic int lif_s_stream(struct v4l2_subdev *subdev, int enable)\r\n{\r\nconst struct v4l2_mbus_framefmt *format;\r\nstruct vsp1_lif *lif = to_lif(subdev);\r\nunsigned int hbth = 1300;\r\nunsigned int obth = 400;\r\nunsigned int lbth = 200;\r\nif (!enable) {\r\nvsp1_lif_write(lif, VI6_LIF_CTRL, 0);\r\nreturn 0;\r\n}\r\nformat = &lif->entity.formats[LIF_PAD_SOURCE];\r\nobth = min(obth, (format->width + 1) / 2 * format->height - 4);\r\nvsp1_lif_write(lif, VI6_LIF_CSBTH,\r\n(hbth << VI6_LIF_CSBTH_HBTH_SHIFT) |\r\n(lbth << VI6_LIF_CSBTH_LBTH_SHIFT));\r\nvsp1_lif_write(lif, VI6_LIF_CTRL,\r\n(obth << VI6_LIF_CTRL_OBTH_SHIFT) |\r\n(format->code == 0 ? VI6_LIF_CTRL_CFMT : 0) |\r\nVI6_LIF_CTRL_REQSEL | VI6_LIF_CTRL_LIF_EN);\r\nreturn 0;\r\n}\r\nstatic int lif_enum_mbus_code(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_mbus_code_enum *code)\r\n{\r\nstatic const unsigned int codes[] = {\r\nV4L2_MBUS_FMT_ARGB8888_1X32,\r\nV4L2_MBUS_FMT_AYUV8_1X32,\r\n};\r\nif (code->pad == LIF_PAD_SINK) {\r\nif (code->index >= ARRAY_SIZE(codes))\r\nreturn -EINVAL;\r\ncode->code = codes[code->index];\r\n} else {\r\nstruct v4l2_mbus_framefmt *format;\r\nif (code->index)\r\nreturn -EINVAL;\r\nformat = v4l2_subdev_get_try_format(fh, LIF_PAD_SINK);\r\ncode->code = format->code;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lif_enum_frame_size(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_frame_size_enum *fse)\r\n{\r\nstruct v4l2_mbus_framefmt *format;\r\nformat = v4l2_subdev_get_try_format(fh, LIF_PAD_SINK);\r\nif (fse->index || fse->code != format->code)\r\nreturn -EINVAL;\r\nif (fse->pad == LIF_PAD_SINK) {\r\nfse->min_width = LIF_MIN_SIZE;\r\nfse->max_width = LIF_MAX_SIZE;\r\nfse->min_height = LIF_MIN_SIZE;\r\nfse->max_height = LIF_MAX_SIZE;\r\n} else {\r\nfse->min_width = format->width;\r\nfse->max_width = format->width;\r\nfse->min_height = format->height;\r\nfse->max_height = format->height;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lif_get_format(struct v4l2_subdev *subdev, struct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct vsp1_lif *lif = to_lif(subdev);\r\nfmt->format = *vsp1_entity_get_pad_format(&lif->entity, fh, fmt->pad,\r\nfmt->which);\r\nreturn 0;\r\n}\r\nstatic int lif_set_format(struct v4l2_subdev *subdev, struct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct vsp1_lif *lif = to_lif(subdev);\r\nstruct v4l2_mbus_framefmt *format;\r\nif (fmt->format.code != V4L2_MBUS_FMT_ARGB8888_1X32 &&\r\nfmt->format.code != V4L2_MBUS_FMT_AYUV8_1X32)\r\nfmt->format.code = V4L2_MBUS_FMT_AYUV8_1X32;\r\nformat = vsp1_entity_get_pad_format(&lif->entity, fh, fmt->pad,\r\nfmt->which);\r\nif (fmt->pad == LIF_PAD_SOURCE) {\r\nfmt->format = *format;\r\nreturn 0;\r\n}\r\nformat->code = fmt->format.code;\r\nformat->width = clamp_t(unsigned int, fmt->format.width,\r\nLIF_MIN_SIZE, LIF_MAX_SIZE);\r\nformat->height = clamp_t(unsigned int, fmt->format.height,\r\nLIF_MIN_SIZE, LIF_MAX_SIZE);\r\nformat->field = V4L2_FIELD_NONE;\r\nformat->colorspace = V4L2_COLORSPACE_SRGB;\r\nfmt->format = *format;\r\nformat = vsp1_entity_get_pad_format(&lif->entity, fh, LIF_PAD_SOURCE,\r\nfmt->which);\r\n*format = fmt->format;\r\nreturn 0;\r\n}\r\nstruct vsp1_lif *vsp1_lif_create(struct vsp1_device *vsp1)\r\n{\r\nstruct v4l2_subdev *subdev;\r\nstruct vsp1_lif *lif;\r\nint ret;\r\nlif = devm_kzalloc(vsp1->dev, sizeof(*lif), GFP_KERNEL);\r\nif (lif == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nlif->entity.type = VSP1_ENTITY_LIF;\r\nlif->entity.id = VI6_DPR_NODE_LIF;\r\nret = vsp1_entity_init(vsp1, &lif->entity, 2);\r\nif (ret < 0)\r\nreturn ERR_PTR(ret);\r\nsubdev = &lif->entity.subdev;\r\nv4l2_subdev_init(subdev, &lif_ops);\r\nsubdev->entity.ops = &vsp1_media_ops;\r\nsubdev->internal_ops = &vsp1_subdev_internal_ops;\r\nsnprintf(subdev->name, sizeof(subdev->name), "%s lif",\r\ndev_name(vsp1->dev));\r\nv4l2_set_subdevdata(subdev, lif);\r\nsubdev->flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;\r\nvsp1_entity_init_formats(subdev, NULL);\r\nreturn lif;\r\n}

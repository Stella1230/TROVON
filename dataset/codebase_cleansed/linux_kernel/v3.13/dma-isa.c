static int isa_get_dma_residue(unsigned int chan, dma_t *dma)\r\n{\r\nunsigned int io_port = isa_dma_port[chan][ISA_DMA_COUNT];\r\nint count;\r\ncount = 1 + inb(io_port);\r\ncount |= inb(io_port) << 8;\r\nreturn chan < 4 ? count : (count << 1);\r\n}\r\nstatic void isa_enable_dma(unsigned int chan, dma_t *dma)\r\n{\r\nif (dma->invalid) {\r\nunsigned long address, length;\r\nunsigned int mode;\r\nenum dma_data_direction direction;\r\nmode = (chan & 3) | dma->dma_mode;\r\nswitch (dma->dma_mode & DMA_MODE_MASK) {\r\ncase DMA_MODE_READ:\r\ndirection = DMA_FROM_DEVICE;\r\nbreak;\r\ncase DMA_MODE_WRITE:\r\ndirection = DMA_TO_DEVICE;\r\nbreak;\r\ncase DMA_MODE_CASCADE:\r\ndirection = DMA_BIDIRECTIONAL;\r\nbreak;\r\ndefault:\r\ndirection = DMA_NONE;\r\nbreak;\r\n}\r\nif (!dma->sg) {\r\ndma->sg = &dma->buf;\r\ndma->sgcount = 1;\r\ndma->buf.length = dma->count;\r\ndma->buf.dma_address = dma_map_single(NULL,\r\ndma->addr, dma->count,\r\ndirection);\r\n}\r\naddress = dma->buf.dma_address;\r\nlength = dma->buf.length - 1;\r\noutb(address >> 16, isa_dma_port[chan][ISA_DMA_PGLO]);\r\noutb(address >> 24, isa_dma_port[chan][ISA_DMA_PGHI]);\r\nif (chan >= 4) {\r\naddress >>= 1;\r\nlength >>= 1;\r\n}\r\noutb(0, isa_dma_port[chan][ISA_DMA_CLRFF]);\r\noutb(address, isa_dma_port[chan][ISA_DMA_ADDR]);\r\noutb(address >> 8, isa_dma_port[chan][ISA_DMA_ADDR]);\r\noutb(length, isa_dma_port[chan][ISA_DMA_COUNT]);\r\noutb(length >> 8, isa_dma_port[chan][ISA_DMA_COUNT]);\r\noutb(mode, isa_dma_port[chan][ISA_DMA_MODE]);\r\ndma->invalid = 0;\r\n}\r\noutb(chan & 3, isa_dma_port[chan][ISA_DMA_MASK]);\r\n}\r\nstatic void isa_disable_dma(unsigned int chan, dma_t *dma)\r\n{\r\noutb(chan | 4, isa_dma_port[chan][ISA_DMA_MASK]);\r\n}\r\nvoid __init isa_init_dma(void)\r\n{\r\noutb(0xff, 0x0d);\r\noutb(0xff, 0xda);\r\noutb(0x55, 0x00);\r\noutb(0xaa, 0x00);\r\nif (inb(0) == 0x55 && inb(0) == 0xaa) {\r\nunsigned int chan, i;\r\nfor (chan = 0; chan < 8; chan++) {\r\nisa_dma[chan].d_ops = &isa_dma_ops;\r\nisa_disable_dma(chan, NULL);\r\n}\r\noutb(0x40, 0x0b);\r\noutb(0x41, 0x0b);\r\noutb(0x42, 0x0b);\r\noutb(0x43, 0x0b);\r\noutb(0xc0, 0xd6);\r\noutb(0x41, 0xd6);\r\noutb(0x42, 0xd6);\r\noutb(0x43, 0xd6);\r\noutb(0, 0xd4);\r\noutb(0x10, 0x08);\r\noutb(0x10, 0xd0);\r\noutb(0x30, 0x40b);\r\noutb(0x31, 0x40b);\r\noutb(0x32, 0x40b);\r\noutb(0x33, 0x40b);\r\noutb(0x31, 0x4d6);\r\noutb(0x32, 0x4d6);\r\noutb(0x33, 0x4d6);\r\nfor (i = 0; i < ARRAY_SIZE(dma_resources); i++)\r\nrequest_resource(&ioport_resource, dma_resources + i);\r\nfor (chan = 0; chan < 8; chan++) {\r\nint ret = isa_dma_add(chan, &isa_dma[chan]);\r\nif (ret)\r\nprintk(KERN_ERR "ISADMA%u: unable to register: %d\n",\r\nchan, ret);\r\n}\r\nrequest_dma(DMA_ISA_CASCADE, "cascade");\r\n}\r\n}

int IFRFbWriteEmbedded(struct vnt_private *pDevice, u32 dwData)\r\n{\r\nu8 pbyData[4];\r\npbyData[0] = (u8)dwData;\r\npbyData[1] = (u8)(dwData >> 8);\r\npbyData[2] = (u8)(dwData >> 16);\r\npbyData[3] = (u8)(dwData >> 24);\r\nCONTROLnsRequestOut(pDevice,\r\nMESSAGE_TYPE_WRITE_IFRF, 0, 0, 4, pbyData);\r\nreturn true;\r\n}\r\nint RFbSetPower(struct vnt_private *priv, u32 rate, u32 channel)\r\n{\r\nint ret = true;\r\nu8 power = priv->byCCKPwr;\r\nif (priv->dwDiagRefCount)\r\nreturn true;\r\nif (channel == 0)\r\nreturn -EINVAL;\r\nswitch (rate) {\r\ncase RATE_1M:\r\ncase RATE_2M:\r\ncase RATE_5M:\r\ncase RATE_11M:\r\npower = priv->abyCCKPwrTbl[channel-1];\r\nbreak;\r\ncase RATE_6M:\r\ncase RATE_9M:\r\ncase RATE_18M:\r\ncase RATE_24M:\r\ncase RATE_36M:\r\ncase RATE_48M:\r\ncase RATE_54M:\r\nif (channel > CB_MAX_CHANNEL_24G)\r\npower = priv->abyOFDMAPwrTbl[channel-15];\r\nelse\r\npower = priv->abyOFDMPwrTbl[channel-1];\r\nbreak;\r\n}\r\nret = RFbRawSetPower(priv, power, rate);\r\nreturn ret;\r\n}\r\nint RFbRawSetPower(struct vnt_private *priv, u8 power, u32 rate)\r\n{\r\nu32 power_setting = 0;\r\nint ret = true;\r\nif (priv->byCurPwr == power)\r\nreturn true;\r\npriv->byCurPwr = power;\r\nswitch (priv->byRFType) {\r\ncase RF_AL2230:\r\nif (priv->byCurPwr >= AL2230_PWR_IDX_LEN)\r\nreturn false;\r\nret &= IFRFbWriteEmbedded(priv,\r\nal2230_power_table[priv->byCurPwr]);\r\nif (rate <= RATE_11M)\r\nret &= IFRFbWriteEmbedded(priv, 0x0001b400 +\r\n(BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW);\r\nelse\r\nret &= IFRFbWriteEmbedded(priv, 0x0005a400 +\r\n(BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW);\r\nbreak;\r\ncase RF_AL2230S:\r\nif (priv->byCurPwr >= AL2230_PWR_IDX_LEN)\r\nreturn false;\r\nret &= IFRFbWriteEmbedded(priv,\r\nal2230_power_table[priv->byCurPwr]);\r\nif (rate <= RATE_11M) {\r\nret &= IFRFbWriteEmbedded(priv, 0x040c1400 +\r\n(BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW);\r\nret &= IFRFbWriteEmbedded(priv, 0x00299b00 +\r\n(BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW);\r\n} else {\r\nret &= IFRFbWriteEmbedded(priv, 0x0005a400 +\r\n(BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW);\r\nret &= IFRFbWriteEmbedded(priv, 0x00099b00 +\r\n(BY_AL2230_REG_LEN << 3) + IFREGCTL_REGW);\r\n}\r\nbreak;\r\ncase RF_AIROHA7230:\r\nif (rate <= RATE_11M)\r\nret &= IFRFbWriteEmbedded(priv, 0x111bb900 +\r\n(BY_AL7230_REG_LEN << 3)+IFREGCTL_REGW);\r\nelse\r\nret &= IFRFbWriteEmbedded(priv, 0x221bb900 +\r\n(BY_AL7230_REG_LEN << 3)+IFREGCTL_REGW);\r\nif (priv->byCurPwr > AL7230_PWR_IDX_LEN)\r\nreturn false;\r\npower_setting = 0x080c0b00 | ((priv->byCurPwr) << 12) |\r\n(BY_AL7230_REG_LEN << 3) | IFREGCTL_REGW;\r\nret &= IFRFbWriteEmbedded(priv, power_setting);\r\nbreak;\r\ncase RF_VT3226:\r\nif (priv->byCurPwr >= VT3226_PWR_IDX_LEN)\r\nreturn false;\r\npower_setting = ((0x3f - priv->byCurPwr) << 20) | (0x17 << 8) |\r\n(BY_VT3226_REG_LEN << 3) | IFREGCTL_REGW;\r\nret &= IFRFbWriteEmbedded(priv, power_setting);\r\nbreak;\r\ncase RF_VT3226D0:\r\nif (priv->byCurPwr >= VT3226_PWR_IDX_LEN)\r\nreturn false;\r\nif (rate <= RATE_11M) {\r\npower_setting = ((0x3f-priv->byCurPwr) << 20) |\r\n(0xe07 << 8) | (BY_VT3226_REG_LEN << 3) |\r\nIFREGCTL_REGW;\r\nret &= IFRFbWriteEmbedded(priv, power_setting);\r\nret &= IFRFbWriteEmbedded(priv, 0x03c6a200 +\r\n(BY_VT3226_REG_LEN<<3)+IFREGCTL_REGW);\r\nif (priv->vnt_mgmt.eScanState != WMAC_NO_SCANNING) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO\r\n"RFbRawSetPower> 11B mode uCurrChannel[%d]\n",\r\npriv->vnt_mgmt.uScanChannel);\r\nret &= IFRFbWriteEmbedded(priv,\r\nvt3226d0_lo_current_table[priv->\r\nvnt_mgmt.uScanChannel - 1]);\r\n} else {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO\r\n"RFbRawSetPower> 11B mode uCurrChannel[%d]\n",\r\npriv->vnt_mgmt.uCurrChannel);\r\nret &= IFRFbWriteEmbedded(priv,\r\nvt3226d0_lo_current_table[priv->\r\nvnt_mgmt.uCurrChannel - 1]);\r\n}\r\nret &= IFRFbWriteEmbedded(priv, 0x015C0800 +\r\n(BY_VT3226_REG_LEN<<3)+IFREGCTL_REGW);\r\n} else {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO\r\n"@@@@ RFbRawSetPower> 11G mode\n");\r\npower_setting = ((0x3f-priv->byCurPwr) << 20) |\r\n(0x7 << 8) | (BY_VT3226_REG_LEN << 3) |\r\nIFREGCTL_REGW;\r\nret &= IFRFbWriteEmbedded(priv, power_setting);\r\nret &= IFRFbWriteEmbedded(priv, 0x00C6A200 +\r\n(BY_VT3226_REG_LEN << 3) + IFREGCTL_REGW);\r\nret &= IFRFbWriteEmbedded(priv, 0x016BC600 +\r\n(BY_VT3226_REG_LEN<<3)+IFREGCTL_REGW);\r\nret &= IFRFbWriteEmbedded(priv, 0x00900800 +\r\n(BY_VT3226_REG_LEN<<3)+IFREGCTL_REGW);\r\n}\r\nbreak;\r\ncase RF_VT3342A0:\r\nif (priv->byCurPwr >= VT3342_PWR_IDX_LEN)\r\nreturn false;\r\npower_setting = ((0x3F-priv->byCurPwr) << 20) |\r\n(0x27 << 8) | (BY_VT3342_REG_LEN << 3) |\r\nIFREGCTL_REGW;\r\nret &= IFRFbWriteEmbedded(priv, power_setting);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nvoid RFvRSSITodBm(struct vnt_private *priv, u8 rssi, long *dbm)\r\n{\r\nu8 idx = (((rssi & 0xc0) >> 6) & 0x03);\r\nlong b = (rssi & 0x3f);\r\nlong a = 0;\r\nu8 airoharf[4] = {0, 18, 0, 40};\r\nswitch (priv->byRFType) {\r\ncase RF_AL2230:\r\ncase RF_AL2230S:\r\ncase RF_AIROHA7230:\r\ncase RF_VT3226:\r\ncase RF_VT3226D0:\r\ncase RF_VT3342A0:\r\na = airoharf[idx];\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n*dbm = -1 * (a + b * 2);\r\n}\r\nvoid RFbRFTableDownload(struct vnt_private *priv)\r\n{\r\nu16 length1 = 0, length2 = 0, length3 = 0;\r\nu8 *addr1 = NULL, *addr2 = NULL, *addr3 = NULL;\r\nu16 length, value;\r\nu8 array[256];\r\nswitch (priv->byRFType) {\r\ncase RF_AL2230:\r\ncase RF_AL2230S:\r\nlength1 = CB_AL2230_INIT_SEQ * 3;\r\nlength2 = CB_MAX_CHANNEL_24G * 3;\r\nlength3 = CB_MAX_CHANNEL_24G * 3;\r\naddr1 = &al2230_init_table[0][0];\r\naddr2 = &al2230_channel_table0[0][0];\r\naddr3 = &al2230_channel_table1[0][0];\r\nbreak;\r\ncase RF_AIROHA7230:\r\nlength1 = CB_AL7230_INIT_SEQ * 3;\r\nlength2 = CB_MAX_CHANNEL * 3;\r\nlength3 = CB_MAX_CHANNEL * 3;\r\naddr1 = &al7230_init_table[0][0];\r\naddr2 = &al7230_channel_table0[0][0];\r\naddr3 = &al7230_channel_table1[0][0];\r\nbreak;\r\ncase RF_VT3226:\r\nlength1 = CB_VT3226_INIT_SEQ * 3;\r\nlength2 = CB_MAX_CHANNEL_24G * 3;\r\nlength3 = CB_MAX_CHANNEL_24G * 3;\r\naddr1 = &at3226_init_table[0][0];\r\naddr2 = &vt3226_channel_table0[0][0];\r\naddr3 = &vt3226_channel_table1[0][0];\r\nbreak;\r\ncase RF_VT3226D0:\r\nlength1 = CB_VT3226_INIT_SEQ * 3;\r\nlength2 = CB_MAX_CHANNEL_24G * 3;\r\nlength3 = CB_MAX_CHANNEL_24G * 3;\r\naddr1 = &at3226d0_init_table[0][0];\r\naddr2 = &vt3226_channel_table0[0][0];\r\naddr3 = &vt3226_channel_table1[0][0];\r\nbreak;\r\ncase RF_VT3342A0:\r\nlength1 = CB_VT3342_INIT_SEQ * 3;\r\nlength2 = CB_MAX_CHANNEL * 3;\r\nlength3 = CB_MAX_CHANNEL * 3;\r\naddr1 = &vt3342a0_init_table[0][0];\r\naddr2 = &vt3342_channel_table0[0][0];\r\naddr3 = &vt3342_channel_table1[0][0];\r\nbreak;\r\n}\r\nmemcpy(array, addr1, length1);\r\nCONTROLnsRequestOut(priv, MESSAGE_TYPE_WRITE, 0,\r\nMESSAGE_REQUEST_RF_INIT, length1, array);\r\nvalue = 0;\r\nwhile (length2 > 0) {\r\nif (length2 >= 64)\r\nlength = 64;\r\nelse\r\nlength = length2;\r\nmemcpy(array, addr2, length);\r\nCONTROLnsRequestOut(priv, MESSAGE_TYPE_WRITE,\r\nvalue, MESSAGE_REQUEST_RF_CH0, length, array);\r\nlength2 -= length;\r\nvalue += length;\r\naddr2 += length;\r\n}\r\nvalue = 0;\r\nwhile (length3 > 0) {\r\nif (length3 >= 64)\r\nlength = 64;\r\nelse\r\nlength = length3;\r\nmemcpy(array, addr3, length);\r\nCONTROLnsRequestOut(priv, MESSAGE_TYPE_WRITE,\r\nvalue, MESSAGE_REQUEST_RF_CH1, length, array);\r\nlength3 -= length;\r\nvalue += length;\r\naddr3 += length;\r\n}\r\nif (priv->byRFType == RF_AIROHA7230) {\r\nlength1 = CB_AL7230_INIT_SEQ * 3;\r\nlength2 = CB_MAX_CHANNEL * 3;\r\naddr1 = &(al7230_init_table_amode[0][0]);\r\naddr2 = &(al7230_channel_table2[0][0]);\r\nmemcpy(array, addr1, length1);\r\nCONTROLnsRequestOut(priv, MESSAGE_TYPE_WRITE,\r\n0, MESSAGE_REQUEST_RF_INIT2, length1, array);\r\nvalue = 0;\r\nwhile (length2 > 0) {\r\nif (length2 >= 64)\r\nlength = 64;\r\nelse\r\nlength = length2;\r\nmemcpy(array, addr2, length);\r\nCONTROLnsRequestOut(priv, MESSAGE_TYPE_WRITE,\r\nvalue, MESSAGE_REQUEST_RF_CH2, length, array);\r\nlength2 -= length;\r\nvalue += length;\r\naddr2 += length;\r\n}\r\n}\r\n}

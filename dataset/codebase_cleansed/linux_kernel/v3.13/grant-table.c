static int map_pte_fn(pte_t *pte, struct page *pmd_page,\r\nunsigned long addr, void *data)\r\n{\r\nunsigned long **frames = (unsigned long **)data;\r\nset_pte_at(&init_mm, addr, pte, mfn_pte((*frames)[0], PAGE_KERNEL));\r\n(*frames)++;\r\nreturn 0;\r\n}\r\nstatic int map_pte_fn_status(pte_t *pte, struct page *pmd_page,\r\nunsigned long addr, void *data)\r\n{\r\nuint64_t **frames = (uint64_t **)data;\r\nset_pte_at(&init_mm, addr, pte, mfn_pte((*frames)[0], PAGE_KERNEL));\r\n(*frames)++;\r\nreturn 0;\r\n}\r\nstatic int unmap_pte_fn(pte_t *pte, struct page *pmd_page,\r\nunsigned long addr, void *data)\r\n{\r\nset_pte_at(&init_mm, addr, pte, __pte(0));\r\nreturn 0;\r\n}\r\nint arch_gnttab_map_shared(unsigned long *frames, unsigned long nr_gframes,\r\nunsigned long max_nr_gframes,\r\nvoid **__shared)\r\n{\r\nint rc;\r\nvoid *shared = *__shared;\r\nif (shared == NULL) {\r\nstruct vm_struct *area =\r\nalloc_vm_area(PAGE_SIZE * max_nr_gframes, NULL);\r\nBUG_ON(area == NULL);\r\nshared = area->addr;\r\n*__shared = shared;\r\n}\r\nrc = apply_to_page_range(&init_mm, (unsigned long)shared,\r\nPAGE_SIZE * nr_gframes,\r\nmap_pte_fn, &frames);\r\nreturn rc;\r\n}\r\nint arch_gnttab_map_status(uint64_t *frames, unsigned long nr_gframes,\r\nunsigned long max_nr_gframes,\r\ngrant_status_t **__shared)\r\n{\r\nint rc;\r\ngrant_status_t *shared = *__shared;\r\nif (shared == NULL) {\r\nstruct vm_struct *area =\r\nalloc_vm_area(PAGE_SIZE * max_nr_gframes, NULL);\r\nBUG_ON(area == NULL);\r\nshared = area->addr;\r\n*__shared = shared;\r\n}\r\nrc = apply_to_page_range(&init_mm, (unsigned long)shared,\r\nPAGE_SIZE * nr_gframes,\r\nmap_pte_fn_status, &frames);\r\nreturn rc;\r\n}\r\nvoid arch_gnttab_unmap(void *shared, unsigned long nr_gframes)\r\n{\r\napply_to_page_range(&init_mm, (unsigned long)shared,\r\nPAGE_SIZE * nr_gframes, unmap_pte_fn, NULL);\r\n}

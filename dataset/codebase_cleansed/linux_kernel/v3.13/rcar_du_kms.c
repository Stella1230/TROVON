const struct rcar_du_format_info *rcar_du_format_info(u32 fourcc)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(rcar_du_format_infos); ++i) {\r\nif (rcar_du_format_infos[i].fourcc == fourcc)\r\nreturn &rcar_du_format_infos[i];\r\n}\r\nreturn NULL;\r\n}\r\nint rcar_du_dumb_create(struct drm_file *file, struct drm_device *dev,\r\nstruct drm_mode_create_dumb *args)\r\n{\r\nstruct rcar_du_device *rcdu = dev->dev_private;\r\nunsigned int min_pitch = DIV_ROUND_UP(args->width * args->bpp, 8);\r\nunsigned int align;\r\nif (rcar_du_has(rcdu, RCAR_DU_FEATURE_ALIGN_128B))\r\nalign = 128;\r\nelse\r\nalign = 16 * args->bpp / 8;\r\nargs->pitch = roundup(max(args->pitch, min_pitch), align);\r\nreturn drm_gem_cma_dumb_create(file, dev, args);\r\n}\r\nstatic struct drm_framebuffer *\r\nrcar_du_fb_create(struct drm_device *dev, struct drm_file *file_priv,\r\nstruct drm_mode_fb_cmd2 *mode_cmd)\r\n{\r\nstruct rcar_du_device *rcdu = dev->dev_private;\r\nconst struct rcar_du_format_info *format;\r\nunsigned int align;\r\nformat = rcar_du_format_info(mode_cmd->pixel_format);\r\nif (format == NULL) {\r\ndev_dbg(dev->dev, "unsupported pixel format %08x\n",\r\nmode_cmd->pixel_format);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nif (rcar_du_has(rcdu, RCAR_DU_FEATURE_ALIGN_128B))\r\nalign = 128;\r\nelse\r\nalign = 16 * format->bpp / 8;\r\nif (mode_cmd->pitches[0] & (align - 1) ||\r\nmode_cmd->pitches[0] >= 8192) {\r\ndev_dbg(dev->dev, "invalid pitch value %u\n",\r\nmode_cmd->pitches[0]);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nif (format->planes == 2) {\r\nif (mode_cmd->pitches[1] != mode_cmd->pitches[0]) {\r\ndev_dbg(dev->dev,\r\n"luma and chroma pitches do not match\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\n}\r\nreturn drm_fb_cma_create(dev, file_priv, mode_cmd);\r\n}\r\nstatic void rcar_du_output_poll_changed(struct drm_device *dev)\r\n{\r\nstruct rcar_du_device *rcdu = dev->dev_private;\r\ndrm_fbdev_cma_hotplug_event(rcdu->fbdev);\r\n}\r\nint rcar_du_modeset_init(struct rcar_du_device *rcdu)\r\n{\r\nstatic const unsigned int mmio_offsets[] = {\r\nDU0_REG_OFFSET, DU2_REG_OFFSET\r\n};\r\nstruct drm_device *dev = rcdu->ddev;\r\nstruct drm_encoder *encoder;\r\nstruct drm_fbdev_cma *fbdev;\r\nunsigned int num_groups;\r\nunsigned int i;\r\nint ret;\r\ndrm_mode_config_init(dev);\r\ndev->mode_config.min_width = 0;\r\ndev->mode_config.min_height = 0;\r\ndev->mode_config.max_width = 4095;\r\ndev->mode_config.max_height = 2047;\r\ndev->mode_config.funcs = &rcar_du_mode_config_funcs;\r\nrcdu->num_crtcs = rcdu->info->num_crtcs;\r\nnum_groups = DIV_ROUND_UP(rcdu->num_crtcs, 2);\r\nfor (i = 0; i < num_groups; ++i) {\r\nstruct rcar_du_group *rgrp = &rcdu->groups[i];\r\nrgrp->dev = rcdu;\r\nrgrp->mmio_offset = mmio_offsets[i];\r\nrgrp->index = i;\r\nret = rcar_du_planes_init(rgrp);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nfor (i = 0; i < rcdu->num_crtcs; ++i) {\r\nstruct rcar_du_group *rgrp = &rcdu->groups[i / 2];\r\nret = rcar_du_crtc_create(rgrp, i);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nret = rcar_du_lvdsenc_init(rcdu);\r\nif (ret < 0)\r\nreturn ret;\r\nfor (i = 0; i < rcdu->pdata->num_encoders; ++i) {\r\nconst struct rcar_du_encoder_data *pdata =\r\n&rcdu->pdata->encoders[i];\r\nconst struct rcar_du_output_routing *route =\r\n&rcdu->info->routes[pdata->output];\r\nif (pdata->type == RCAR_DU_ENCODER_UNUSED)\r\ncontinue;\r\nif (pdata->output >= RCAR_DU_OUTPUT_MAX ||\r\nroute->possible_crtcs == 0) {\r\ndev_warn(rcdu->dev,\r\n"encoder %u references unexisting output %u, skipping\n",\r\ni, pdata->output);\r\ncontinue;\r\n}\r\nrcar_du_encoder_init(rcdu, pdata->type, pdata->output, pdata);\r\n}\r\nlist_for_each_entry(encoder, &dev->mode_config.encoder_list, head) {\r\nstruct rcar_du_encoder *renc = to_rcar_encoder(encoder);\r\nconst struct rcar_du_output_routing *route =\r\n&rcdu->info->routes[renc->output];\r\nencoder->possible_crtcs = route->possible_crtcs;\r\nencoder->possible_clones = (1 << rcdu->pdata->num_encoders) - 1;\r\n}\r\nfor (i = 0; i < num_groups; ++i) {\r\nret = rcar_du_planes_register(&rcdu->groups[i]);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\ndrm_kms_helper_poll_init(dev);\r\ndrm_helper_disable_unused_functions(dev);\r\nfbdev = drm_fbdev_cma_init(dev, 32, dev->mode_config.num_crtc,\r\ndev->mode_config.num_connector);\r\nif (IS_ERR(fbdev))\r\nreturn PTR_ERR(fbdev);\r\n#ifndef CONFIG_FRAMEBUFFER_CONSOLE\r\ndrm_fbdev_cma_restore_mode(fbdev);\r\n#endif\r\nrcdu->fbdev = fbdev;\r\nreturn 0;\r\n}

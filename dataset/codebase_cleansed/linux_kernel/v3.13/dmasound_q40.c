static ssize_t q40_ct_law(const u_char __user *userPtr, size_t userCount,\r\nu_char frame[], ssize_t *frameUsed,\r\nssize_t frameLeft)\r\n{\r\nchar *table = dmasound.soft.format == AFMT_MU_LAW ? dmasound_ulaw2dma8: dmasound_alaw2dma8;\r\nssize_t count, used;\r\nu_char *p = (u_char *) &frame[*frameUsed];\r\nused = count = min_t(size_t, userCount, frameLeft);\r\nif (copy_from_user(p,userPtr,count))\r\nreturn -EFAULT;\r\nwhile (count > 0) {\r\n*p = table[*p]+128;\r\np++;\r\ncount--;\r\n}\r\n*frameUsed += used ;\r\nreturn used;\r\n}\r\nstatic ssize_t q40_ct_s8(const u_char __user *userPtr, size_t userCount,\r\nu_char frame[], ssize_t *frameUsed,\r\nssize_t frameLeft)\r\n{\r\nssize_t count, used;\r\nu_char *p = (u_char *) &frame[*frameUsed];\r\nused = count = min_t(size_t, userCount, frameLeft);\r\nif (copy_from_user(p,userPtr,count))\r\nreturn -EFAULT;\r\nwhile (count > 0) {\r\n*p = *p + 128;\r\np++;\r\ncount--;\r\n}\r\n*frameUsed += used;\r\nreturn used;\r\n}\r\nstatic ssize_t q40_ct_u8(const u_char __user *userPtr, size_t userCount,\r\nu_char frame[], ssize_t *frameUsed,\r\nssize_t frameLeft)\r\n{\r\nssize_t count, used;\r\nu_char *p = (u_char *) &frame[*frameUsed];\r\nused = count = min_t(size_t, userCount, frameLeft);\r\nif (copy_from_user(p,userPtr,count))\r\nreturn -EFAULT;\r\n*frameUsed += used;\r\nreturn used;\r\n}\r\nstatic ssize_t q40_ctx_law(const u_char __user *userPtr, size_t userCount,\r\nu_char frame[], ssize_t *frameUsed,\r\nssize_t frameLeft)\r\n{\r\nunsigned char *table = (unsigned char *)\r\n(dmasound.soft.format == AFMT_MU_LAW ? dmasound_ulaw2dma8: dmasound_alaw2dma8);\r\nunsigned int data = expand_data;\r\nu_char *p = (u_char *) &frame[*frameUsed];\r\nint bal = expand_bal;\r\nint hSpeed = dmasound.hard.speed, sSpeed = dmasound.soft.speed;\r\nint utotal, ftotal;\r\nftotal = frameLeft;\r\nutotal = userCount;\r\nwhile (frameLeft) {\r\nu_char c;\r\nif (bal < 0) {\r\nif (userCount == 0)\r\nbreak;\r\nif (get_user(c, userPtr++))\r\nreturn -EFAULT;\r\ndata = table[c];\r\ndata += 0x80;\r\nuserCount--;\r\nbal += hSpeed;\r\n}\r\n*p++ = data;\r\nframeLeft--;\r\nbal -= sSpeed;\r\n}\r\nexpand_bal = bal;\r\nexpand_data = data;\r\n*frameUsed += (ftotal - frameLeft);\r\nutotal -= userCount;\r\nreturn utotal;\r\n}\r\nstatic ssize_t q40_ctx_s8(const u_char __user *userPtr, size_t userCount,\r\nu_char frame[], ssize_t *frameUsed,\r\nssize_t frameLeft)\r\n{\r\nu_char *p = (u_char *) &frame[*frameUsed];\r\nunsigned int data = expand_data;\r\nint bal = expand_bal;\r\nint hSpeed = dmasound.hard.speed, sSpeed = dmasound.soft.speed;\r\nint utotal, ftotal;\r\nftotal = frameLeft;\r\nutotal = userCount;\r\nwhile (frameLeft) {\r\nu_char c;\r\nif (bal < 0) {\r\nif (userCount == 0)\r\nbreak;\r\nif (get_user(c, userPtr++))\r\nreturn -EFAULT;\r\ndata = c ;\r\ndata += 0x80;\r\nuserCount--;\r\nbal += hSpeed;\r\n}\r\n*p++ = data;\r\nframeLeft--;\r\nbal -= sSpeed;\r\n}\r\nexpand_bal = bal;\r\nexpand_data = data;\r\n*frameUsed += (ftotal - frameLeft);\r\nutotal -= userCount;\r\nreturn utotal;\r\n}\r\nstatic ssize_t q40_ctx_u8(const u_char __user *userPtr, size_t userCount,\r\nu_char frame[], ssize_t *frameUsed,\r\nssize_t frameLeft)\r\n{\r\nu_char *p = (u_char *) &frame[*frameUsed];\r\nunsigned int data = expand_data;\r\nint bal = expand_bal;\r\nint hSpeed = dmasound.hard.speed, sSpeed = dmasound.soft.speed;\r\nint utotal, ftotal;\r\nftotal = frameLeft;\r\nutotal = userCount;\r\nwhile (frameLeft) {\r\nu_char c;\r\nif (bal < 0) {\r\nif (userCount == 0)\r\nbreak;\r\nif (get_user(c, userPtr++))\r\nreturn -EFAULT;\r\ndata = c ;\r\nuserCount--;\r\nbal += hSpeed;\r\n}\r\n*p++ = data;\r\nframeLeft--;\r\nbal -= sSpeed;\r\n}\r\nexpand_bal = bal;\r\nexpand_data = data;\r\n*frameUsed += (ftotal - frameLeft) ;\r\nutotal -= userCount;\r\nreturn utotal;\r\n}\r\nstatic ssize_t q40_ctc_law(const u_char __user *userPtr, size_t userCount,\r\nu_char frame[], ssize_t *frameUsed,\r\nssize_t frameLeft)\r\n{\r\nunsigned char *table = (unsigned char *)\r\n(dmasound.soft.format == AFMT_MU_LAW ? dmasound_ulaw2dma8: dmasound_alaw2dma8);\r\nunsigned int data = expand_data;\r\nu_char *p = (u_char *) &frame[*frameUsed];\r\nint bal = expand_bal;\r\nint hSpeed = dmasound.hard.speed, sSpeed = dmasound.soft.speed;\r\nint utotal, ftotal;\r\nftotal = frameLeft;\r\nutotal = userCount;\r\nwhile (frameLeft) {\r\nu_char c;\r\nwhile(bal<0) {\r\nif (userCount == 0)\r\ngoto lout;\r\nif (!(bal<(-hSpeed))) {\r\nif (get_user(c, userPtr))\r\nreturn -EFAULT;\r\ndata = 0x80 + table[c];\r\n}\r\nuserPtr++;\r\nuserCount--;\r\nbal += hSpeed;\r\n}\r\n*p++ = data;\r\nframeLeft--;\r\nbal -= sSpeed;\r\n}\r\nlout:\r\nexpand_bal = bal;\r\nexpand_data = data;\r\n*frameUsed += (ftotal - frameLeft);\r\nutotal -= userCount;\r\nreturn utotal;\r\n}\r\nstatic ssize_t q40_ctc_s8(const u_char __user *userPtr, size_t userCount,\r\nu_char frame[], ssize_t *frameUsed,\r\nssize_t frameLeft)\r\n{\r\nu_char *p = (u_char *) &frame[*frameUsed];\r\nunsigned int data = expand_data;\r\nint bal = expand_bal;\r\nint hSpeed = dmasound.hard.speed, sSpeed = dmasound.soft.speed;\r\nint utotal, ftotal;\r\nftotal = frameLeft;\r\nutotal = userCount;\r\nwhile (frameLeft) {\r\nu_char c;\r\nwhile (bal < 0) {\r\nif (userCount == 0)\r\ngoto lout;\r\nif (!(bal<(-hSpeed))) {\r\nif (get_user(c, userPtr))\r\nreturn -EFAULT;\r\ndata = c + 0x80;\r\n}\r\nuserPtr++;\r\nuserCount--;\r\nbal += hSpeed;\r\n}\r\n*p++ = data;\r\nframeLeft--;\r\nbal -= sSpeed;\r\n}\r\nlout:\r\nexpand_bal = bal;\r\nexpand_data = data;\r\n*frameUsed += (ftotal - frameLeft);\r\nutotal -= userCount;\r\nreturn utotal;\r\n}\r\nstatic ssize_t q40_ctc_u8(const u_char __user *userPtr, size_t userCount,\r\nu_char frame[], ssize_t *frameUsed,\r\nssize_t frameLeft)\r\n{\r\nu_char *p = (u_char *) &frame[*frameUsed];\r\nunsigned int data = expand_data;\r\nint bal = expand_bal;\r\nint hSpeed = dmasound.hard.speed, sSpeed = dmasound.soft.speed;\r\nint utotal, ftotal;\r\nftotal = frameLeft;\r\nutotal = userCount;\r\nwhile (frameLeft) {\r\nu_char c;\r\nwhile (bal < 0) {\r\nif (userCount == 0)\r\ngoto lout;\r\nif (!(bal<(-hSpeed))) {\r\nif (get_user(c, userPtr))\r\nreturn -EFAULT;\r\ndata = c ;\r\n}\r\nuserPtr++;\r\nuserCount--;\r\nbal += hSpeed;\r\n}\r\n*p++ = data;\r\nframeLeft--;\r\nbal -= sSpeed;\r\n}\r\nlout:\r\nexpand_bal = bal;\r\nexpand_data = data;\r\n*frameUsed += (ftotal - frameLeft) ;\r\nutotal -= userCount;\r\nreturn utotal;\r\n}\r\nstatic void *Q40Alloc(unsigned int size, gfp_t flags)\r\n{\r\nreturn kmalloc(size, flags);\r\n}\r\nstatic void Q40Free(void *ptr, unsigned int size)\r\n{\r\nkfree(ptr);\r\n}\r\nstatic int __init Q40IrqInit(void)\r\n{\r\nif (request_irq(Q40_IRQ_SAMPLE, Q40StereoInterrupt, 0,\r\n"DMA sound", Q40Interrupt))\r\nreturn 0;\r\nreturn(1);\r\n}\r\nstatic void Q40IrqCleanUp(void)\r\n{\r\nmaster_outb(0,SAMPLE_ENABLE_REG);\r\nfree_irq(Q40_IRQ_SAMPLE, Q40Interrupt);\r\n}\r\nstatic void Q40Silence(void)\r\n{\r\nmaster_outb(0,SAMPLE_ENABLE_REG);\r\n*DAC_LEFT=*DAC_RIGHT=127;\r\n}\r\nstatic void Q40PlayNextFrame(int index)\r\n{\r\nu_char *start;\r\nu_long size;\r\nu_char speed;\r\nint error;\r\nstart = write_sq.buffers[write_sq.front];\r\nsize = (write_sq.count == index ? write_sq.rear_size : write_sq.block_size);\r\nq40_pp=start;\r\nq40_sc=size;\r\nwrite_sq.front = (write_sq.front+1) % write_sq.max_count;\r\nwrite_sq.active++;\r\nspeed=(dmasound.hard.speed==10000 ? 0 : 1);\r\nmaster_outb( 0,SAMPLE_ENABLE_REG);\r\nfree_irq(Q40_IRQ_SAMPLE, Q40Interrupt);\r\nif (dmasound.soft.stereo)\r\nerror = request_irq(Q40_IRQ_SAMPLE, Q40StereoInterrupt, 0,\r\n"Q40 sound", Q40Interrupt);\r\nelse\r\nerror = request_irq(Q40_IRQ_SAMPLE, Q40MonoInterrupt, 0,\r\n"Q40 sound", Q40Interrupt);\r\nif (error && printk_ratelimit())\r\npr_err("Couldn't register sound interrupt\n");\r\nmaster_outb( speed, SAMPLE_RATE_REG);\r\nmaster_outb( 1,SAMPLE_CLEAR_REG);\r\nmaster_outb( 1,SAMPLE_ENABLE_REG);\r\n}\r\nstatic void Q40Play(void)\r\n{\r\nunsigned long flags;\r\nif (write_sq.active || write_sq.count<=0 ) {\r\nreturn;\r\n}\r\nif (write_sq.count <= 1 && write_sq.rear_size < write_sq.block_size && !write_sq.syncing) {\r\nreturn;\r\n}\r\nspin_lock_irqsave(&dmasound.lock, flags);\r\nQ40PlayNextFrame(1);\r\nspin_unlock_irqrestore(&dmasound.lock, flags);\r\n}\r\nstatic irqreturn_t Q40StereoInterrupt(int irq, void *dummy)\r\n{\r\nspin_lock(&dmasound.lock);\r\nif (q40_sc>1){\r\n*DAC_LEFT=*q40_pp++;\r\n*DAC_RIGHT=*q40_pp++;\r\nq40_sc -=2;\r\nmaster_outb(1,SAMPLE_CLEAR_REG);\r\n}else Q40Interrupt();\r\nspin_unlock(&dmasound.lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t Q40MonoInterrupt(int irq, void *dummy)\r\n{\r\nspin_lock(&dmasound.lock);\r\nif (q40_sc>0){\r\n*DAC_LEFT=*q40_pp;\r\n*DAC_RIGHT=*q40_pp++;\r\nq40_sc --;\r\nmaster_outb(1,SAMPLE_CLEAR_REG);\r\n}else Q40Interrupt();\r\nspin_unlock(&dmasound.lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void Q40Interrupt(void)\r\n{\r\nif (!write_sq.active) {\r\nWAKE_UP(write_sq.sync_queue);\r\nmaster_outb(0,SAMPLE_ENABLE_REG);\r\ngoto exit;\r\n} else write_sq.active=0;\r\nwrite_sq.count--;\r\nQ40Play();\r\nif (q40_sc<2)\r\n{\r\nmaster_outb(0,SAMPLE_ENABLE_REG);\r\n*DAC_LEFT=*DAC_RIGHT=127;\r\n}\r\nWAKE_UP(write_sq.action_queue);\r\nexit:\r\nmaster_outb(1,SAMPLE_CLEAR_REG);\r\n}\r\nstatic void Q40Init(void)\r\n{\r\nint i, idx;\r\nconst int freq[] = {10000, 20000};\r\nidx = -1;\r\nfor (i = 0; i < 2; i++)\r\nif ((100 * abs(dmasound.soft.speed - freq[i]) / freq[i]) <= catchRadius)\r\nidx = i;\r\ndmasound.hard = dmasound.soft;\r\ndmasound.hard.size=8;\r\nif (idx > -1) {\r\ndmasound.soft.speed = freq[idx];\r\ndmasound.trans_write = &transQ40Normal;\r\n} else\r\ndmasound.trans_write = &transQ40Expanding;\r\nQ40Silence();\r\nif (dmasound.hard.speed > 20200) {\r\ndmasound.hard.speed = 20000;\r\ndmasound.trans_write = &transQ40Compressing;\r\n} else if (dmasound.hard.speed > 10000) {\r\ndmasound.hard.speed = 20000;\r\n} else {\r\ndmasound.hard.speed = 10000;\r\n}\r\nexpand_bal = -dmasound.soft.speed;\r\n}\r\nstatic int Q40SetFormat(int format)\r\n{\r\nswitch (format) {\r\ncase AFMT_QUERY:\r\nreturn(dmasound.soft.format);\r\ncase AFMT_MU_LAW:\r\ncase AFMT_A_LAW:\r\ncase AFMT_S8:\r\ncase AFMT_U8:\r\nbreak;\r\ndefault:\r\nformat = AFMT_S8;\r\n}\r\ndmasound.soft.format = format;\r\ndmasound.soft.size = 8;\r\nif (dmasound.minDev == SND_DEV_DSP) {\r\ndmasound.dsp.format = format;\r\ndmasound.dsp.size = 8;\r\n}\r\nQ40Init();\r\nreturn(format);\r\n}\r\nstatic int Q40SetVolume(int volume)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __init dmasound_q40_init(void)\r\n{\r\nif (MACH_IS_Q40) {\r\ndmasound.mach = machQ40;\r\ndmasound.mach.default_hard = def_hard ;\r\ndmasound.mach.default_soft = def_soft ;\r\nreturn dmasound_init();\r\n} else\r\nreturn -ENODEV;\r\n}\r\nstatic void __exit dmasound_q40_cleanup(void)\r\n{\r\ndmasound_deinit();\r\n}

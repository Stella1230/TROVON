int __init davinci_psc_is_clk_active(unsigned int ctlr, unsigned int id)\r\n{\r\nvoid __iomem *psc_base;\r\nu32 mdstat;\r\nstruct davinci_soc_info *soc_info = &davinci_soc_info;\r\nif (!soc_info->psc_bases || (ctlr >= soc_info->psc_bases_num)) {\r\npr_warn("PSC: Bad psc data: 0x%x[%d]\n",\r\n(int)soc_info->psc_bases, ctlr);\r\nreturn 0;\r\n}\r\npsc_base = ioremap(soc_info->psc_bases[ctlr], SZ_4K);\r\nmdstat = __raw_readl(psc_base + MDSTAT + 4 * id);\r\niounmap(psc_base);\r\nreturn mdstat & BIT(12);\r\n}\r\nvoid davinci_psc_reset(unsigned int ctlr, unsigned int id, bool reset)\r\n{\r\nu32 mdctl;\r\nvoid __iomem *psc_base;\r\nstruct davinci_soc_info *soc_info = &davinci_soc_info;\r\nif (!soc_info->psc_bases || (ctlr >= soc_info->psc_bases_num)) {\r\npr_warn("PSC: Bad psc data: 0x%x[%d]\n",\r\n(int)soc_info->psc_bases, ctlr);\r\nreturn;\r\n}\r\npsc_base = ioremap(soc_info->psc_bases[ctlr], SZ_4K);\r\nmdctl = readl(psc_base + MDCTL + 4 * id);\r\nif (reset)\r\nmdctl &= ~MDCTL_LRST;\r\nelse\r\nmdctl |= MDCTL_LRST;\r\nwritel(mdctl, psc_base + MDCTL + 4 * id);\r\niounmap(psc_base);\r\n}\r\nvoid davinci_psc_config(unsigned int domain, unsigned int ctlr,\r\nunsigned int id, bool enable, u32 flags)\r\n{\r\nu32 epcpr, ptcmd, ptstat, pdstat, pdctl, mdstat, mdctl;\r\nvoid __iomem *psc_base;\r\nstruct davinci_soc_info *soc_info = &davinci_soc_info;\r\nu32 next_state = PSC_STATE_ENABLE;\r\nif (!soc_info->psc_bases || (ctlr >= soc_info->psc_bases_num)) {\r\npr_warn("PSC: Bad psc data: 0x%x[%d]\n",\r\n(int)soc_info->psc_bases, ctlr);\r\nreturn;\r\n}\r\npsc_base = ioremap(soc_info->psc_bases[ctlr], SZ_4K);\r\nif (!enable) {\r\nif (flags & PSC_SWRSTDISABLE)\r\nnext_state = PSC_STATE_SWRSTDISABLE;\r\nelse\r\nnext_state = PSC_STATE_DISABLE;\r\n}\r\nmdctl = __raw_readl(psc_base + MDCTL + 4 * id);\r\nmdctl &= ~MDSTAT_STATE_MASK;\r\nmdctl |= next_state;\r\nif (flags & PSC_FORCE)\r\nmdctl |= MDCTL_FORCE;\r\n__raw_writel(mdctl, psc_base + MDCTL + 4 * id);\r\npdstat = __raw_readl(psc_base + PDSTAT + 4 * domain);\r\nif ((pdstat & PDSTAT_STATE_MASK) == 0) {\r\npdctl = __raw_readl(psc_base + PDCTL + 4 * domain);\r\npdctl |= PDCTL_NEXT;\r\n__raw_writel(pdctl, psc_base + PDCTL + 4 * domain);\r\nptcmd = 1 << domain;\r\n__raw_writel(ptcmd, psc_base + PTCMD);\r\ndo {\r\nepcpr = __raw_readl(psc_base + EPCPR);\r\n} while ((((epcpr >> domain) & 1) == 0));\r\npdctl = __raw_readl(psc_base + PDCTL + 4 * domain);\r\npdctl |= PDCTL_EPCGOOD;\r\n__raw_writel(pdctl, psc_base + PDCTL + 4 * domain);\r\n} else {\r\nptcmd = 1 << domain;\r\n__raw_writel(ptcmd, psc_base + PTCMD);\r\n}\r\ndo {\r\nptstat = __raw_readl(psc_base + PTSTAT);\r\n} while (!(((ptstat >> domain) & 1) == 0));\r\ndo {\r\nmdstat = __raw_readl(psc_base + MDSTAT + 4 * id);\r\n} while (!((mdstat & MDSTAT_STATE_MASK) == next_state));\r\niounmap(psc_base);\r\n}

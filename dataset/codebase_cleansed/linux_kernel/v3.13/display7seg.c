static int d7s_open(struct inode *inode, struct file *f)\r\n{\r\nif (D7S_MINOR != iminor(inode))\r\nreturn -ENODEV;\r\natomic_inc(&d7s_users);\r\nreturn 0;\r\n}\r\nstatic int d7s_release(struct inode *inode, struct file *f)\r\n{\r\nif (atomic_dec_and_test(&d7s_users) && !sol_compat) {\r\nstruct d7s *p = d7s_device;\r\nu8 regval = 0;\r\nregval = readb(p->regs);\r\nif (p->flipped)\r\nregval |= D7S_FLIP;\r\nelse\r\nregval &= ~D7S_FLIP;\r\nwriteb(regval, p->regs);\r\n}\r\nreturn 0;\r\n}\r\nstatic long d7s_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nstruct d7s *p = d7s_device;\r\nu8 regs = readb(p->regs);\r\nint error = 0;\r\nu8 ireg = 0;\r\nif (D7S_MINOR != iminor(file_inode(file)))\r\nreturn -ENODEV;\r\nmutex_lock(&d7s_mutex);\r\nswitch (cmd) {\r\ncase D7SIOCWR:\r\nif (get_user(ireg, (int __user *) arg)) {\r\nerror = -EFAULT;\r\nbreak;\r\n}\r\nif (sol_compat) {\r\nif (regs & D7S_FLIP)\r\nireg |= D7S_FLIP;\r\nelse\r\nireg &= ~D7S_FLIP;\r\n}\r\nwriteb(ireg, p->regs);\r\nbreak;\r\ncase D7SIOCRD:\r\nif (put_user(regs, (int __user *) arg)) {\r\nerror = -EFAULT;\r\nbreak;\r\n}\r\nbreak;\r\ncase D7SIOCTM:\r\nif (regs & D7S_FLIP)\r\nregs &= ~D7S_FLIP;\r\nelse\r\nregs |= D7S_FLIP;\r\nwriteb(regs, p->regs);\r\nbreak;\r\n}\r\nmutex_unlock(&d7s_mutex);\r\nreturn error;\r\n}\r\nstatic int d7s_probe(struct platform_device *op)\r\n{\r\nstruct device_node *opts;\r\nint err = -EINVAL;\r\nstruct d7s *p;\r\nu8 regs;\r\nif (d7s_device)\r\ngoto out;\r\np = kzalloc(sizeof(*p), GFP_KERNEL);\r\nerr = -ENOMEM;\r\nif (!p)\r\ngoto out;\r\np->regs = of_ioremap(&op->resource[0], 0, sizeof(u8), "d7s");\r\nif (!p->regs) {\r\nprintk(KERN_ERR PFX "Cannot map chip registers\n");\r\ngoto out_free;\r\n}\r\nerr = misc_register(&d7s_miscdev);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Unable to acquire miscdevice minor %i\n",\r\nD7S_MINOR);\r\ngoto out_iounmap;\r\n}\r\nregs = readb(p->regs);\r\nopts = of_find_node_by_path("/options");\r\nif (opts &&\r\nof_get_property(opts, "d7s-flipped?", NULL))\r\np->flipped = true;\r\nif (p->flipped)\r\nregs |= D7S_FLIP;\r\nelse\r\nregs &= ~D7S_FLIP;\r\nwriteb(regs, p->regs);\r\nprintk(KERN_INFO PFX "7-Segment Display%s at [%s:0x%llx] %s\n",\r\nop->dev.of_node->full_name,\r\n(regs & D7S_FLIP) ? " (FLIPPED)" : "",\r\nop->resource[0].start,\r\nsol_compat ? "in sol_compat mode" : "");\r\ndev_set_drvdata(&op->dev, p);\r\nd7s_device = p;\r\nerr = 0;\r\nout:\r\nreturn err;\r\nout_iounmap:\r\nof_iounmap(&op->resource[0], p->regs, sizeof(u8));\r\nout_free:\r\nkfree(p);\r\ngoto out;\r\n}\r\nstatic int d7s_remove(struct platform_device *op)\r\n{\r\nstruct d7s *p = dev_get_drvdata(&op->dev);\r\nu8 regs = readb(p->regs);\r\nif (sol_compat) {\r\nif (p->flipped)\r\nregs |= D7S_FLIP;\r\nelse\r\nregs &= ~D7S_FLIP;\r\nwriteb(regs, p->regs);\r\n}\r\nmisc_deregister(&d7s_miscdev);\r\nof_iounmap(&op->resource[0], p->regs, sizeof(u8));\r\nkfree(p);\r\nreturn 0;\r\n}

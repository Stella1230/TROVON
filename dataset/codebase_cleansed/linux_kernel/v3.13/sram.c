static int sram_probe(struct platform_device *pdev)\r\n{\r\nvoid __iomem *virt_base;\r\nstruct sram_dev *sram;\r\nstruct resource *res;\r\nunsigned long size;\r\nint ret;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nvirt_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(virt_base))\r\nreturn PTR_ERR(virt_base);\r\nsize = resource_size(res);\r\nsram = devm_kzalloc(&pdev->dev, sizeof(*sram), GFP_KERNEL);\r\nif (!sram)\r\nreturn -ENOMEM;\r\nsram->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(sram->clk))\r\nsram->clk = NULL;\r\nelse\r\nclk_prepare_enable(sram->clk);\r\nsram->pool = devm_gen_pool_create(&pdev->dev, ilog2(SRAM_GRANULARITY), -1);\r\nif (!sram->pool)\r\nreturn -ENOMEM;\r\nret = gen_pool_add_virt(sram->pool, (unsigned long)virt_base,\r\nres->start, size, -1);\r\nif (ret < 0) {\r\nif (sram->clk)\r\nclk_disable_unprepare(sram->clk);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, sram);\r\ndev_dbg(&pdev->dev, "SRAM pool: %ld KiB @ 0x%p\n", size / 1024, virt_base);\r\nreturn 0;\r\n}\r\nstatic int sram_remove(struct platform_device *pdev)\r\n{\r\nstruct sram_dev *sram = platform_get_drvdata(pdev);\r\nif (gen_pool_avail(sram->pool) < gen_pool_size(sram->pool))\r\ndev_dbg(&pdev->dev, "removed while SRAM allocated\n");\r\ngen_pool_destroy(sram->pool);\r\nif (sram->clk)\r\nclk_disable_unprepare(sram->clk);\r\nreturn 0;\r\n}\r\nstatic int __init sram_init(void)\r\n{\r\nreturn platform_driver_register(&sram_driver);\r\n}

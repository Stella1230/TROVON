int main(int argc, char ** argv)\r\n{\r\nbootblock bootblock_from_disk;\r\nbootblock bootloader_image;\r\nint dev, fd;\r\nint i;\r\nint nread;\r\nif(argc != 3) {\r\nfprintf(stderr, "Usage: %s device lxboot\n", argv[0]);\r\nexit(0);\r\n}\r\ndev = open(argv[1], O_RDWR);\r\nif(dev < 0) {\r\nperror(argv[1]);\r\nexit(0);\r\n}\r\nfd = open(argv[2], O_RDONLY);\r\nif(fd < 0) {\r\nperror(argv[2]);\r\nclose(dev);\r\nexit(0);\r\n}\r\nnread = read(fd, &bootloader_image, sizeof(bootblock));\r\nif(nread != sizeof(bootblock)) {\r\nperror("lxboot read");\r\nfprintf(stderr, "expected %zd, got %d\n", sizeof(bootblock), nread);\r\nexit(0);\r\n}\r\nnread = read(dev, &bootblock_from_disk, sizeof(bootblock));\r\nif(nread != sizeof(bootblock)) {\r\nperror("bootblock read");\r\nfprintf(stderr, "expected %zd, got %d\n", sizeof(bootblock), nread);\r\nexit(0);\r\n}\r\nbootloader_image.bootblock_label = bootblock_from_disk.bootblock_label;\r\nbootloader_image.bootblock_checksum = 0;\r\nfor(i = 0; i < 63; i++) {\r\nbootloader_image.bootblock_checksum +=\r\nbootloader_image.bootblock_quadwords[i];\r\n}\r\nlseek(dev, 0L, SEEK_SET);\r\nif(write(dev, &bootloader_image, sizeof(bootblock)) != sizeof(bootblock)) {\r\nperror("bootblock write");\r\nexit(0);\r\n}\r\nclose(fd);\r\nclose(dev);\r\nexit(0);\r\n}

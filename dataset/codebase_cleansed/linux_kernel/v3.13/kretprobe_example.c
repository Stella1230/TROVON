static int entry_handler(struct kretprobe_instance *ri, struct pt_regs *regs)\r\n{\r\nstruct my_data *data;\r\nif (!current->mm)\r\nreturn 1;\r\ndata = (struct my_data *)ri->data;\r\ndata->entry_stamp = ktime_get();\r\nreturn 0;\r\n}\r\nstatic int ret_handler(struct kretprobe_instance *ri, struct pt_regs *regs)\r\n{\r\nint retval = regs_return_value(regs);\r\nstruct my_data *data = (struct my_data *)ri->data;\r\ns64 delta;\r\nktime_t now;\r\nnow = ktime_get();\r\ndelta = ktime_to_ns(ktime_sub(now, data->entry_stamp));\r\nprintk(KERN_INFO "%s returned %d and took %lld ns to execute\n",\r\nfunc_name, retval, (long long)delta);\r\nreturn 0;\r\n}\r\nstatic int __init kretprobe_init(void)\r\n{\r\nint ret;\r\nmy_kretprobe.kp.symbol_name = func_name;\r\nret = register_kretprobe(&my_kretprobe);\r\nif (ret < 0) {\r\nprintk(KERN_INFO "register_kretprobe failed, returned %d\n",\r\nret);\r\nreturn -1;\r\n}\r\nprintk(KERN_INFO "Planted return probe at %s: %p\n",\r\nmy_kretprobe.kp.symbol_name, my_kretprobe.kp.addr);\r\nreturn 0;\r\n}\r\nstatic void __exit kretprobe_exit(void)\r\n{\r\nunregister_kretprobe(&my_kretprobe);\r\nprintk(KERN_INFO "kretprobe at %p unregistered\n",\r\nmy_kretprobe.kp.addr);\r\nprintk(KERN_INFO "Missed probing %d instances of %s\n",\r\nmy_kretprobe.nmissed, my_kretprobe.kp.symbol_name);\r\n}

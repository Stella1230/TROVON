int pxa910_set_wake(struct irq_data *data, unsigned int on)\r\n{\r\nint irq = data->irq;\r\nstruct irq_desc *desc = irq_to_desc(data->irq);\r\nuint32_t awucrm = 0, apcr = 0;\r\nif (unlikely(irq >= nr_irqs)) {\r\npr_err("IRQ nubmers are out of boundary!\n");\r\nreturn -EINVAL;\r\n}\r\nif (on) {\r\nif (desc->action)\r\ndesc->action->flags |= IRQF_NO_SUSPEND;\r\n} else {\r\nif (desc->action)\r\ndesc->action->flags &= ~IRQF_NO_SUSPEND;\r\n}\r\nswitch (irq) {\r\ncase IRQ_PXA910_AP_GPIO:\r\nawucrm = MPMU_AWUCRM_WAKEUP(2);\r\napcr |= MPMU_APCR_SLPWP2;\r\nbreak;\r\ncase IRQ_PXA910_KEYPAD:\r\nawucrm = MPMU_AWUCRM_WAKEUP(3) | MPMU_AWUCRM_KEYPRESS;\r\napcr |= MPMU_APCR_SLPWP3;\r\nbreak;\r\ncase IRQ_PXA910_ROTARY:\r\nawucrm = MPMU_AWUCRM_WAKEUP(3) | MPMU_AWUCRM_NEWROTARY;\r\napcr |= MPMU_APCR_SLPWP3;\r\nbreak;\r\ncase IRQ_PXA910_TRACKBALL:\r\nawucrm = MPMU_AWUCRM_WAKEUP(3) | MPMU_AWUCRM_TRACKBALL;\r\napcr |= MPMU_APCR_SLPWP3;\r\nbreak;\r\ncase IRQ_PXA910_AP1_TIMER1:\r\nawucrm = MPMU_AWUCRM_WAKEUP(4) | MPMU_AWUCRM_AP1_TIMER_1;\r\napcr |= MPMU_APCR_SLPWP4;\r\nbreak;\r\ncase IRQ_PXA910_AP1_TIMER2:\r\nawucrm = MPMU_AWUCRM_WAKEUP(4) | MPMU_AWUCRM_AP1_TIMER_2;\r\napcr |= MPMU_APCR_SLPWP4;\r\nbreak;\r\ncase IRQ_PXA910_AP1_TIMER3:\r\nawucrm = MPMU_AWUCRM_WAKEUP(4) | MPMU_AWUCRM_AP1_TIMER_3;\r\napcr |= MPMU_APCR_SLPWP4;\r\nbreak;\r\ncase IRQ_PXA910_AP2_TIMER1:\r\nawucrm = MPMU_AWUCRM_WAKEUP(4) | MPMU_AWUCRM_AP2_TIMER_1;\r\napcr |= MPMU_APCR_SLPWP4;\r\nbreak;\r\ncase IRQ_PXA910_AP2_TIMER2:\r\nawucrm = MPMU_AWUCRM_WAKEUP(4) | MPMU_AWUCRM_AP2_TIMER_2;\r\napcr |= MPMU_APCR_SLPWP4;\r\nbreak;\r\ncase IRQ_PXA910_AP2_TIMER3:\r\nawucrm = MPMU_AWUCRM_WAKEUP(4) | MPMU_AWUCRM_AP2_TIMER_3;\r\napcr |= MPMU_APCR_SLPWP4;\r\nbreak;\r\ncase IRQ_PXA910_RTC_ALARM:\r\nawucrm = MPMU_AWUCRM_WAKEUP(4) | MPMU_AWUCRM_RTC_ALARM;\r\napcr |= MPMU_APCR_SLPWP4;\r\nbreak;\r\ncase IRQ_PXA910_USB1:\r\ncase IRQ_PXA910_USB2:\r\nawucrm = MPMU_AWUCRM_WAKEUP(5);\r\napcr |= MPMU_APCR_SLPWP5;\r\nbreak;\r\ncase IRQ_PXA910_MMC:\r\nawucrm = MPMU_AWUCRM_WAKEUP(6)\r\n| MPMU_AWUCRM_SDH1\r\n| MPMU_AWUCRM_SDH2;\r\napcr |= MPMU_APCR_SLPWP6;\r\nbreak;\r\ncase IRQ_PXA910_PMIC_INT:\r\nawucrm = MPMU_AWUCRM_WAKEUP(7);\r\napcr |= MPMU_APCR_SLPWP7;\r\nbreak;\r\ndefault:\r\nif (irq >= IRQ_GPIO_START && irq < IRQ_BOARD_START) {\r\nawucrm = MPMU_AWUCRM_WAKEUP(2);\r\napcr |= MPMU_APCR_SLPWP2;\r\n} else\r\nprintk(KERN_ERR "Error: no defined wake up source irq: %d\n",\r\nirq);\r\n}\r\nif (on) {\r\nif (awucrm) {\r\nawucrm |= __raw_readl(MPMU_AWUCRM);\r\n__raw_writel(awucrm, MPMU_AWUCRM);\r\n}\r\nif (apcr) {\r\napcr = ~apcr & __raw_readl(MPMU_APCR);\r\n__raw_writel(apcr, MPMU_APCR);\r\n}\r\n} else {\r\nif (awucrm) {\r\nawucrm = ~awucrm & __raw_readl(MPMU_AWUCRM);\r\n__raw_writel(awucrm, MPMU_AWUCRM);\r\n}\r\nif (apcr) {\r\napcr |= __raw_readl(MPMU_APCR);\r\n__raw_writel(apcr, MPMU_APCR);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid pxa910_pm_enter_lowpower_mode(int state)\r\n{\r\nuint32_t idle_cfg, apcr;\r\nidle_cfg = __raw_readl(APMU_MOH_IDLE_CFG);\r\napcr = __raw_readl(MPMU_APCR);\r\napcr &= ~(MPMU_APCR_DDRCORSD | MPMU_APCR_APBSD | MPMU_APCR_AXISD\r\n| MPMU_APCR_VCTCXOSD | MPMU_APCR_STBYEN);\r\nidle_cfg &= ~(APMU_MOH_IDLE_CFG_MOH_IDLE\r\n| APMU_MOH_IDLE_CFG_MOH_PWRDWN);\r\nswitch (state) {\r\ncase POWER_MODE_UDR:\r\napcr |= MPMU_APCR_STBYEN | MPMU_APCR_APBSD;\r\ncase POWER_MODE_SYS_SLEEP:\r\napcr |= MPMU_APCR_SLPEN;\r\napcr |= MPMU_APCR_VCTCXOSD;\r\ncase POWER_MODE_APPS_SLEEP:\r\napcr |= MPMU_APCR_DDRCORSD;\r\ncase POWER_MODE_APPS_IDLE:\r\napcr |= MPMU_APCR_AXISD;\r\ncase POWER_MODE_CORE_EXTIDLE:\r\nidle_cfg |= APMU_MOH_IDLE_CFG_MOH_IDLE;\r\nidle_cfg |= APMU_MOH_IDLE_CFG_MOH_PWRDWN;\r\nidle_cfg |= APMU_MOH_IDLE_CFG_MOH_PWR_SW(3)\r\n| APMU_MOH_IDLE_CFG_MOH_L2_PWR_SW(3);\r\ncase POWER_MODE_CORE_INTIDLE:\r\nbreak;\r\n}\r\nidle_cfg |= APMU_MOH_IDLE_CFG_MOH_DIS_MC_SW_REQ;\r\nidle_cfg |= APMU_MOH_IDLE_CFG_MOH_MC_WAKE_EN;\r\n__raw_writel(0x0, APMU_MC_HW_SLP_TYPE);\r\napcr |= MPMU_APCR_DSPSD | MPMU_APCR_DTCMSD | MPMU_APCR_BBSD\r\n| MPMU_APCR_MSASLPEN;\r\napcr |= MPMU_APCR_SLPEN;\r\n__raw_writel(idle_cfg, APMU_MOH_IDLE_CFG);\r\n__raw_writel(apcr, MPMU_APCR);\r\n}\r\nstatic int pxa910_pm_enter(suspend_state_t state)\r\n{\r\nunsigned int idle_cfg, reg = 0;\r\nreg = __raw_readl(ICU_INT_CONF(IRQ_PXA910_PMIC_INT));\r\nif ((reg & 0x3) == 0)\r\nreturn -EAGAIN;\r\nidle_cfg = __raw_readl(APMU_MOH_IDLE_CFG);\r\nidle_cfg |= APMU_MOH_IDLE_CFG_MOH_PWRDWN\r\n| APMU_MOH_IDLE_CFG_MOH_SRAM_PWRDWN;\r\n__raw_writel(idle_cfg, APMU_MOH_IDLE_CFG);\r\nouter_disable();\r\nwhile (!(readl(CIU_REG(0x8)) & (1 << 16)))\r\nudelay(1);\r\ncpu_do_idle();\r\nouter_resume();\r\nwhile (!(readl(CIU_REG(0x8)) & (1 << 16)))\r\nudelay(1);\r\nidle_cfg = __raw_readl(APMU_MOH_IDLE_CFG);\r\nidle_cfg &= ~(APMU_MOH_IDLE_CFG_MOH_PWRDWN\r\n| APMU_MOH_IDLE_CFG_MOH_SRAM_PWRDWN);\r\n__raw_writel(idle_cfg, APMU_MOH_IDLE_CFG);\r\nreturn 0;\r\n}\r\nstatic int pxa910_pm_prepare(void)\r\n{\r\npxa910_pm_enter_lowpower_mode(POWER_MODE_UDR);\r\nreturn 0;\r\n}\r\nstatic void pxa910_pm_finish(void)\r\n{\r\npxa910_pm_enter_lowpower_mode(POWER_MODE_CORE_INTIDLE);\r\n}\r\nstatic int pxa910_pm_valid(suspend_state_t state)\r\n{\r\nreturn ((state == PM_SUSPEND_STANDBY) || (state == PM_SUSPEND_MEM));\r\n}\r\nstatic int __init pxa910_pm_init(void)\r\n{\r\nuint32_t awucrm = 0;\r\nif (!cpu_is_pxa910())\r\nreturn -EIO;\r\nsuspend_set_ops(&pxa910_pm_ops);\r\n__raw_writel(__raw_readl(APMU_SQU_CLK_GATE_CTRL) | (1 << 30),\r\nAPMU_SQU_CLK_GATE_CTRL);\r\n__raw_writel(__raw_readl(MPMU_FCCR) | (1 << 28), MPMU_FCCR);\r\nawucrm |= MPMU_AWUCRM_AP_ASYNC_INT | MPMU_AWUCRM_AP_FULL_IDLE;\r\n__raw_writel(awucrm, MPMU_AWUCRM);\r\nreturn 0;\r\n}

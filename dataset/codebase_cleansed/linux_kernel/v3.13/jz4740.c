static int jz4740_codec_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\r\n{\r\nstruct jz4740_codec *jz4740_codec = snd_soc_codec_get_drvdata(dai->codec);\r\nuint32_t val;\r\nswitch (params_rate(params)) {\r\ncase 8000:\r\nval = 0;\r\nbreak;\r\ncase 11025:\r\nval = 1;\r\nbreak;\r\ncase 12000:\r\nval = 2;\r\nbreak;\r\ncase 16000:\r\nval = 3;\r\nbreak;\r\ncase 22050:\r\nval = 4;\r\nbreak;\r\ncase 24000:\r\nval = 5;\r\nbreak;\r\ncase 32000:\r\nval = 6;\r\nbreak;\r\ncase 44100:\r\nval = 7;\r\nbreak;\r\ncase 48000:\r\nval = 8;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nval <<= JZ4740_CODEC_2_SAMPLE_RATE_OFFSET;\r\nregmap_update_bits(jz4740_codec->regmap, JZ4740_REG_CODEC_2,\r\nJZ4740_CODEC_2_SAMPLE_RATE_MASK, val);\r\nreturn 0;\r\n}\r\nstatic void jz4740_codec_wakeup(struct regmap *regmap)\r\n{\r\nregmap_update_bits(regmap, JZ4740_REG_CODEC_1,\r\nJZ4740_CODEC_1_RESET, JZ4740_CODEC_1_RESET);\r\nudelay(2);\r\nregmap_update_bits(regmap, JZ4740_REG_CODEC_1,\r\nJZ4740_CODEC_1_SUSPEND | JZ4740_CODEC_1_RESET, 0);\r\nregcache_sync(regmap);\r\n}\r\nstatic int jz4740_codec_set_bias_level(struct snd_soc_codec *codec,\r\nenum snd_soc_bias_level level)\r\n{\r\nstruct jz4740_codec *jz4740_codec = snd_soc_codec_get_drvdata(codec);\r\nstruct regmap *regmap = jz4740_codec->regmap;\r\nunsigned int mask;\r\nunsigned int value;\r\nswitch (level) {\r\ncase SND_SOC_BIAS_ON:\r\nbreak;\r\ncase SND_SOC_BIAS_PREPARE:\r\nmask = JZ4740_CODEC_1_VREF_DISABLE |\r\nJZ4740_CODEC_1_VREF_AMP_DISABLE |\r\nJZ4740_CODEC_1_HEADPHONE_POWERDOWN_M;\r\nvalue = 0;\r\nregmap_update_bits(regmap, JZ4740_REG_CODEC_1, mask, value);\r\nbreak;\r\ncase SND_SOC_BIAS_STANDBY:\r\nif (codec->dapm.bias_level == SND_SOC_BIAS_OFF)\r\njz4740_codec_wakeup(regmap);\r\nmask = JZ4740_CODEC_1_VREF_DISABLE |\r\nJZ4740_CODEC_1_VREF_AMP_DISABLE |\r\nJZ4740_CODEC_1_HEADPHONE_POWERDOWN_M;\r\nvalue = JZ4740_CODEC_1_VREF_DISABLE |\r\nJZ4740_CODEC_1_VREF_AMP_DISABLE |\r\nJZ4740_CODEC_1_HEADPHONE_POWERDOWN_M;\r\nregmap_update_bits(regmap, JZ4740_REG_CODEC_1, mask, value);\r\nbreak;\r\ncase SND_SOC_BIAS_OFF:\r\nmask = JZ4740_CODEC_1_SUSPEND;\r\nvalue = JZ4740_CODEC_1_SUSPEND;\r\nregmap_update_bits(regmap, JZ4740_REG_CODEC_1, mask, value);\r\nregcache_mark_dirty(regmap);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ncodec->dapm.bias_level = level;\r\nreturn 0;\r\n}\r\nstatic int jz4740_codec_dev_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct jz4740_codec *jz4740_codec = snd_soc_codec_get_drvdata(codec);\r\nregmap_update_bits(jz4740_codec->regmap, JZ4740_REG_CODEC_1,\r\nJZ4740_CODEC_1_SW2_ENABLE, JZ4740_CODEC_1_SW2_ENABLE);\r\njz4740_codec_set_bias_level(codec, SND_SOC_BIAS_STANDBY);\r\nreturn 0;\r\n}\r\nstatic int jz4740_codec_dev_remove(struct snd_soc_codec *codec)\r\n{\r\njz4740_codec_set_bias_level(codec, SND_SOC_BIAS_OFF);\r\nreturn 0;\r\n}\r\nstatic int jz4740_codec_suspend(struct snd_soc_codec *codec)\r\n{\r\nreturn jz4740_codec_set_bias_level(codec, SND_SOC_BIAS_OFF);\r\n}\r\nstatic int jz4740_codec_resume(struct snd_soc_codec *codec)\r\n{\r\nreturn jz4740_codec_set_bias_level(codec, SND_SOC_BIAS_STANDBY);\r\n}\r\nstatic int jz4740_codec_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct jz4740_codec *jz4740_codec;\r\nstruct resource *mem;\r\nvoid __iomem *base;\r\njz4740_codec = devm_kzalloc(&pdev->dev, sizeof(*jz4740_codec),\r\nGFP_KERNEL);\r\nif (!jz4740_codec)\r\nreturn -ENOMEM;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\njz4740_codec->regmap = devm_regmap_init_mmio(&pdev->dev, base,\r\n&jz4740_codec_regmap_config);\r\nif (IS_ERR(jz4740_codec->regmap))\r\nreturn PTR_ERR(jz4740_codec->regmap);\r\nplatform_set_drvdata(pdev, jz4740_codec);\r\nret = snd_soc_register_codec(&pdev->dev,\r\n&soc_codec_dev_jz4740_codec, &jz4740_codec_dai, 1);\r\nif (ret)\r\ndev_err(&pdev->dev, "Failed to register codec\n");\r\nreturn ret;\r\n}\r\nstatic int jz4740_codec_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_codec(&pdev->dev);\r\nreturn 0;\r\n}

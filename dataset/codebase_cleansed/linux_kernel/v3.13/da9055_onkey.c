static void da9055_onkey_query(struct da9055_onkey *onkey)\r\n{\r\nint key_stat;\r\nkey_stat = da9055_reg_read(onkey->da9055, DA9055_REG_STATUS_A);\r\nif (key_stat < 0) {\r\ndev_err(onkey->da9055->dev,\r\n"Failed to read onkey event %d\n", key_stat);\r\n} else {\r\nkey_stat &= DA9055_NOKEY_STS;\r\nif (!key_stat) {\r\ninput_report_key(onkey->input, KEY_POWER, 0);\r\ninput_sync(onkey->input);\r\n}\r\n}\r\nif (key_stat)\r\nschedule_delayed_work(&onkey->work, msecs_to_jiffies(10));\r\n}\r\nstatic void da9055_onkey_work(struct work_struct *work)\r\n{\r\nstruct da9055_onkey *onkey = container_of(work, struct da9055_onkey,\r\nwork.work);\r\nda9055_onkey_query(onkey);\r\n}\r\nstatic irqreturn_t da9055_onkey_irq(int irq, void *data)\r\n{\r\nstruct da9055_onkey *onkey = data;\r\ninput_report_key(onkey->input, KEY_POWER, 1);\r\ninput_sync(onkey->input);\r\nda9055_onkey_query(onkey);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int da9055_onkey_probe(struct platform_device *pdev)\r\n{\r\nstruct da9055 *da9055 = dev_get_drvdata(pdev->dev.parent);\r\nstruct da9055_onkey *onkey;\r\nstruct input_dev *input_dev;\r\nint irq, err;\r\nirq = platform_get_irq_byname(pdev, "ONKEY");\r\nif (irq < 0) {\r\ndev_err(&pdev->dev,\r\n"Failed to get an IRQ for input device, %d\n", irq);\r\nreturn -EINVAL;\r\n}\r\nonkey = devm_kzalloc(&pdev->dev, sizeof(*onkey), GFP_KERNEL);\r\nif (!onkey) {\r\ndev_err(&pdev->dev, "Failed to allocate memory\n");\r\nreturn -ENOMEM;\r\n}\r\ninput_dev = input_allocate_device();\r\nif (!input_dev) {\r\ndev_err(&pdev->dev, "Failed to allocate memory\n");\r\nreturn -ENOMEM;\r\n}\r\nonkey->input = input_dev;\r\nonkey->da9055 = da9055;\r\ninput_dev->name = "da9055-onkey";\r\ninput_dev->phys = "da9055-onkey/input0";\r\ninput_dev->dev.parent = &pdev->dev;\r\ninput_dev->evbit[0] = BIT_MASK(EV_KEY);\r\n__set_bit(KEY_POWER, input_dev->keybit);\r\nINIT_DELAYED_WORK(&onkey->work, da9055_onkey_work);\r\nirq = regmap_irq_get_virq(da9055->irq_data, irq);\r\nerr = request_threaded_irq(irq, NULL, da9055_onkey_irq,\r\nIRQF_TRIGGER_HIGH | IRQF_ONESHOT,\r\n"ONKEY", onkey);\r\nif (err < 0) {\r\ndev_err(&pdev->dev,\r\n"Failed to register ONKEY IRQ %d, error = %d\n",\r\nirq, err);\r\ngoto err_free_input;\r\n}\r\nerr = input_register_device(input_dev);\r\nif (err) {\r\ndev_err(&pdev->dev, "Unable to register input device, %d\n",\r\nerr);\r\ngoto err_free_irq;\r\n}\r\nplatform_set_drvdata(pdev, onkey);\r\nreturn 0;\r\nerr_free_irq:\r\nfree_irq(irq, onkey);\r\ncancel_delayed_work_sync(&onkey->work);\r\nerr_free_input:\r\ninput_free_device(input_dev);\r\nreturn err;\r\n}\r\nstatic int da9055_onkey_remove(struct platform_device *pdev)\r\n{\r\nstruct da9055_onkey *onkey = platform_get_drvdata(pdev);\r\nint irq = platform_get_irq_byname(pdev, "ONKEY");\r\nirq = regmap_irq_get_virq(onkey->da9055->irq_data, irq);\r\nfree_irq(irq, onkey);\r\ncancel_delayed_work_sync(&onkey->work);\r\ninput_unregister_device(onkey->input);\r\nreturn 0;\r\n}

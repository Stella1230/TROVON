static int kinect_write(struct usb_device *udev, uint8_t *data,\r\nuint16_t wLength)\r\n{\r\nreturn usb_control_msg(udev,\r\nusb_sndctrlpipe(udev, 0),\r\n0x00,\r\nUSB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\n0, 0, data, wLength, CTRL_TIMEOUT);\r\n}\r\nstatic int kinect_read(struct usb_device *udev, uint8_t *data, uint16_t wLength)\r\n{\r\nreturn usb_control_msg(udev,\r\nusb_rcvctrlpipe(udev, 0),\r\n0x00,\r\nUSB_DIR_IN | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\n0, 0, data, wLength, CTRL_TIMEOUT);\r\n}\r\nstatic int send_cmd(struct gspca_dev *gspca_dev, uint16_t cmd, void *cmdbuf,\r\nunsigned int cmd_len, void *replybuf, unsigned int reply_len)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nstruct usb_device *udev = gspca_dev->dev;\r\nint res, actual_len;\r\nuint8_t *obuf = sd->obuf;\r\nuint8_t *ibuf = sd->ibuf;\r\nstruct cam_hdr *chdr = (void *)obuf;\r\nstruct cam_hdr *rhdr = (void *)ibuf;\r\nif (cmd_len & 1 || cmd_len > (0x400 - sizeof(*chdr))) {\r\npr_err("send_cmd: Invalid command length (0x%x)\n", cmd_len);\r\nreturn -1;\r\n}\r\nchdr->magic[0] = 0x47;\r\nchdr->magic[1] = 0x4d;\r\nchdr->cmd = cpu_to_le16(cmd);\r\nchdr->tag = cpu_to_le16(sd->cam_tag);\r\nchdr->len = cpu_to_le16(cmd_len / 2);\r\nmemcpy(obuf+sizeof(*chdr), cmdbuf, cmd_len);\r\nres = kinect_write(udev, obuf, cmd_len + sizeof(*chdr));\r\nPDEBUG(D_USBO, "Control cmd=%04x tag=%04x len=%04x: %d", cmd,\r\nsd->cam_tag, cmd_len, res);\r\nif (res < 0) {\r\npr_err("send_cmd: Output control transfer failed (%d)\n", res);\r\nreturn res;\r\n}\r\ndo {\r\nactual_len = kinect_read(udev, ibuf, 0x200);\r\n} while (actual_len == 0);\r\nPDEBUG(D_USBO, "Control reply: %d", res);\r\nif (actual_len < sizeof(*rhdr)) {\r\npr_err("send_cmd: Input control transfer failed (%d)\n", res);\r\nreturn res;\r\n}\r\nactual_len -= sizeof(*rhdr);\r\nif (rhdr->magic[0] != 0x52 || rhdr->magic[1] != 0x42) {\r\npr_err("send_cmd: Bad magic %02x %02x\n",\r\nrhdr->magic[0], rhdr->magic[1]);\r\nreturn -1;\r\n}\r\nif (rhdr->cmd != chdr->cmd) {\r\npr_err("send_cmd: Bad cmd %02x != %02x\n",\r\nrhdr->cmd, chdr->cmd);\r\nreturn -1;\r\n}\r\nif (rhdr->tag != chdr->tag) {\r\npr_err("send_cmd: Bad tag %04x != %04x\n",\r\nrhdr->tag, chdr->tag);\r\nreturn -1;\r\n}\r\nif (cpu_to_le16(rhdr->len) != (actual_len/2)) {\r\npr_err("send_cmd: Bad len %04x != %04x\n",\r\ncpu_to_le16(rhdr->len), (int)(actual_len/2));\r\nreturn -1;\r\n}\r\nif (actual_len > reply_len) {\r\npr_warn("send_cmd: Data buffer is %d bytes long, but got %d bytes\n",\r\nreply_len, actual_len);\r\nmemcpy(replybuf, ibuf+sizeof(*rhdr), reply_len);\r\n} else {\r\nmemcpy(replybuf, ibuf+sizeof(*rhdr), actual_len);\r\n}\r\nsd->cam_tag++;\r\nreturn actual_len;\r\n}\r\nstatic int write_register(struct gspca_dev *gspca_dev, uint16_t reg,\r\nuint16_t data)\r\n{\r\nuint16_t reply[2];\r\nuint16_t cmd[2];\r\nint res;\r\ncmd[0] = cpu_to_le16(reg);\r\ncmd[1] = cpu_to_le16(data);\r\nPDEBUG(D_USBO, "Write Reg 0x%04x <= 0x%02x", reg, data);\r\nres = send_cmd(gspca_dev, 0x03, cmd, 4, reply, 4);\r\nif (res < 0)\r\nreturn res;\r\nif (res != 2) {\r\npr_warn("send_cmd returned %d [%04x %04x], 0000 expected\n",\r\nres, reply[0], reply[1]);\r\n}\r\nreturn 0;\r\n}\r\nstatic int sd_config(struct gspca_dev *gspca_dev,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nstruct cam *cam;\r\nsd->cam_tag = 0;\r\nsd->stream_flag = 0x80;\r\ncam = &gspca_dev->cam;\r\ncam->cam_mode = video_camera_mode;\r\ncam->nmodes = ARRAY_SIZE(video_camera_mode);\r\n#if 0\r\ncam->npkt = 15;\r\ngspca_dev->pkt_size = 960 * 2;\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int sd_init(struct gspca_dev *gspca_dev)\r\n{\r\nPDEBUG(D_PROBE, "Kinect Camera device.");\r\nreturn 0;\r\n}\r\nstatic int sd_start(struct gspca_dev *gspca_dev)\r\n{\r\nint mode;\r\nuint8_t fmt_reg, fmt_val;\r\nuint8_t res_reg, res_val;\r\nuint8_t fps_reg, fps_val;\r\nuint8_t mode_val;\r\nmode = gspca_dev->cam.cam_mode[gspca_dev->curr_mode].priv;\r\nif (mode & FORMAT_Y10B) {\r\nfmt_reg = 0x19;\r\nres_reg = 0x1a;\r\nfps_reg = 0x1b;\r\nmode_val = 0x03;\r\n} else {\r\nfmt_reg = 0x0c;\r\nres_reg = 0x0d;\r\nfps_reg = 0x0e;\r\nmode_val = 0x01;\r\n}\r\nif (mode & FORMAT_UYVY)\r\nfmt_val = 0x05;\r\nelse\r\nfmt_val = 0x00;\r\nif (mode & MODE_1280x1024)\r\nres_val = 0x02;\r\nelse\r\nres_val = 0x01;\r\nif (mode & FPS_HIGH)\r\nfps_val = 0x1e;\r\nelse\r\nfps_val = 0x0f;\r\nwrite_register(gspca_dev, 0x105, 0x00);\r\nwrite_register(gspca_dev, 0x05, 0x00);\r\nif (mode & (FORMAT_Y10B | MODE_1280x1024)) {\r\nwrite_register(gspca_dev, 0x13, 0x01);\r\nwrite_register(gspca_dev, 0x14, 0x1e);\r\nwrite_register(gspca_dev, 0x06, 0x02);\r\nwrite_register(gspca_dev, 0x06, 0x00);\r\n}\r\nwrite_register(gspca_dev, fmt_reg, fmt_val);\r\nwrite_register(gspca_dev, res_reg, res_val);\r\nwrite_register(gspca_dev, fps_reg, fps_val);\r\nwrite_register(gspca_dev, 0x05, mode_val);\r\nwrite_register(gspca_dev, 0x47, 0x00);\r\nreturn 0;\r\n}\r\nstatic void sd_stopN(struct gspca_dev *gspca_dev)\r\n{\r\nwrite_register(gspca_dev, 0x05, 0x00);\r\n}\r\nstatic void sd_pkt_scan(struct gspca_dev *gspca_dev, u8 *__data, int len)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nstruct pkt_hdr *hdr = (void *)__data;\r\nuint8_t *data = __data + sizeof(*hdr);\r\nint datalen = len - sizeof(*hdr);\r\nuint8_t sof = sd->stream_flag | 1;\r\nuint8_t mof = sd->stream_flag | 2;\r\nuint8_t eof = sd->stream_flag | 5;\r\nif (len < 12)\r\nreturn;\r\nif (hdr->magic[0] != 'R' || hdr->magic[1] != 'B') {\r\npr_warn("[Stream %02x] Invalid magic %02x%02x\n",\r\nsd->stream_flag, hdr->magic[0], hdr->magic[1]);\r\nreturn;\r\n}\r\nif (hdr->flag == sof)\r\ngspca_frame_add(gspca_dev, FIRST_PACKET, data, datalen);\r\nelse if (hdr->flag == mof)\r\ngspca_frame_add(gspca_dev, INTER_PACKET, data, datalen);\r\nelse if (hdr->flag == eof)\r\ngspca_frame_add(gspca_dev, LAST_PACKET, data, datalen);\r\nelse\r\npr_warn("Packet type not recognized...\n");\r\n}\r\nstatic int sd_probe(struct usb_interface *intf, const struct usb_device_id *id)\r\n{\r\nreturn gspca_dev_probe(intf, id, &sd_desc, sizeof(struct sd),\r\nTHIS_MODULE);\r\n}

static inline void\r\nSetRegAddr(hfc4s8s_hw *a, u_char b)\r\n{\r\noutb(b, (a->iobase) + 4);\r\n}\r\nstatic inline u_char\r\nGetRegAddr(hfc4s8s_hw *a)\r\n{\r\nreturn (inb((volatile u_int) (a->iobase + 4)));\r\n}\r\nstatic inline void\r\nWrite_hfc8(hfc4s8s_hw *a, u_char b, u_char c)\r\n{\r\nSetRegAddr(a, b);\r\noutb(c, a->iobase);\r\n}\r\nstatic inline void\r\nfWrite_hfc8(hfc4s8s_hw *a, u_char c)\r\n{\r\noutb(c, a->iobase);\r\n}\r\nstatic inline void\r\nWrite_hfc16(hfc4s8s_hw *a, u_char b, u_short c)\r\n{\r\nSetRegAddr(a, b);\r\noutw(c, a->iobase);\r\n}\r\nstatic inline void\r\nWrite_hfc32(hfc4s8s_hw *a, u_char b, u_long c)\r\n{\r\nSetRegAddr(a, b);\r\noutl(c, a->iobase);\r\n}\r\nstatic inline void\r\nfWrite_hfc32(hfc4s8s_hw *a, u_long c)\r\n{\r\noutl(c, a->iobase);\r\n}\r\nstatic inline u_char\r\nRead_hfc8(hfc4s8s_hw *a, u_char b)\r\n{\r\nSetRegAddr(a, b);\r\nreturn (inb((volatile u_int) a->iobase));\r\n}\r\nstatic inline u_char\r\nfRead_hfc8(hfc4s8s_hw *a)\r\n{\r\nreturn (inb((volatile u_int) a->iobase));\r\n}\r\nstatic inline u_short\r\nRead_hfc16(hfc4s8s_hw *a, u_char b)\r\n{\r\nSetRegAddr(a, b);\r\nreturn (inw((volatile u_int) a->iobase));\r\n}\r\nstatic inline u_long\r\nRead_hfc32(hfc4s8s_hw *a, u_char b)\r\n{\r\nSetRegAddr(a, b);\r\nreturn (inl((volatile u_int) a->iobase));\r\n}\r\nstatic inline u_long\r\nfRead_hfc32(hfc4s8s_hw *a)\r\n{\r\nreturn (inl((volatile u_int) a->iobase));\r\n}\r\nstatic inline void\r\nwait_busy(hfc4s8s_hw *a)\r\n{\r\nSetRegAddr(a, R_STATUS);\r\nwhile (inb((volatile u_int) a->iobase) & M_BUSY);\r\n}\r\nstatic u_char\r\nRead_hfc8_stable(hfc4s8s_hw *hw, int reg)\r\n{\r\nu_char ref8;\r\nu_char in8;\r\nref8 = Read_hfc8(hw, reg);\r\nwhile (((in8 = Read_hfc8(hw, reg)) != ref8)) {\r\nref8 = in8;\r\n}\r\nreturn in8;\r\n}\r\nstatic int\r\nRead_hfc16_stable(hfc4s8s_hw *hw, int reg)\r\n{\r\nint ref16;\r\nint in16;\r\nref16 = Read_hfc16(hw, reg);\r\nwhile (((in16 = Read_hfc16(hw, reg)) != ref16)) {\r\nref16 = in16;\r\n}\r\nreturn in16;\r\n}\r\nstatic void\r\ndch_l2l1(struct hisax_d_if *iface, int pr, void *arg)\r\n{\r\nstruct hfc4s8s_l1 *l1 = iface->ifc.priv;\r\nstruct sk_buff *skb = (struct sk_buff *) arg;\r\nu_long flags;\r\nswitch (pr) {\r\ncase (PH_DATA | REQUEST):\r\nif (!l1->enabled) {\r\ndev_kfree_skb(skb);\r\nbreak;\r\n}\r\nspin_lock_irqsave(&l1->lock, flags);\r\nskb_queue_tail(&l1->d_tx_queue, skb);\r\nif ((skb_queue_len(&l1->d_tx_queue) == 1) &&\r\n(l1->tx_cnt <= 0)) {\r\nl1->hw->mr.r_irq_fifo_blx[l1->st_num] |=\r\n0x10;\r\nspin_unlock_irqrestore(&l1->lock, flags);\r\nschedule_work(&l1->hw->tqueue);\r\n} else\r\nspin_unlock_irqrestore(&l1->lock, flags);\r\nbreak;\r\ncase (PH_ACTIVATE | REQUEST):\r\nif (!l1->enabled)\r\nbreak;\r\nif (!l1->nt_mode) {\r\nif (l1->l1_state < 6) {\r\nspin_lock_irqsave(&l1->lock,\r\nflags);\r\nWrite_hfc8(l1->hw, R_ST_SEL,\r\nl1->st_num);\r\nWrite_hfc8(l1->hw, A_ST_WR_STA,\r\n0x60);\r\nmod_timer(&l1->l1_timer,\r\njiffies + L1_TIMER_T3);\r\nspin_unlock_irqrestore(&l1->lock,\r\nflags);\r\n} else if (l1->l1_state == 7)\r\nl1->d_if.ifc.l1l2(&l1->d_if.ifc,\r\nPH_ACTIVATE |\r\nINDICATION,\r\nNULL);\r\n} else {\r\nif (l1->l1_state != 3) {\r\nspin_lock_irqsave(&l1->lock,\r\nflags);\r\nWrite_hfc8(l1->hw, R_ST_SEL,\r\nl1->st_num);\r\nWrite_hfc8(l1->hw, A_ST_WR_STA,\r\n0x60);\r\nspin_unlock_irqrestore(&l1->lock,\r\nflags);\r\n} else if (l1->l1_state == 3)\r\nl1->d_if.ifc.l1l2(&l1->d_if.ifc,\r\nPH_ACTIVATE |\r\nINDICATION,\r\nNULL);\r\n}\r\nbreak;\r\ndefault:\r\nprintk(KERN_INFO\r\n"HFC-4S/8S: Unknown D-chan cmd 0x%x received, ignored\n",\r\npr);\r\nbreak;\r\n}\r\nif (!l1->enabled)\r\nl1->d_if.ifc.l1l2(&l1->d_if.ifc,\r\nPH_DEACTIVATE | INDICATION, NULL);\r\n}\r\nstatic void\r\nbch_l2l1(struct hisax_if *ifc, int pr, void *arg)\r\n{\r\nstruct hfc4s8s_btype *bch = ifc->priv;\r\nstruct hfc4s8s_l1 *l1 = bch->l1p;\r\nstruct sk_buff *skb = (struct sk_buff *) arg;\r\nlong mode = (long) arg;\r\nu_long flags;\r\nswitch (pr) {\r\ncase (PH_DATA | REQUEST):\r\nif (!l1->enabled || (bch->mode == L1_MODE_NULL)) {\r\ndev_kfree_skb(skb);\r\nbreak;\r\n}\r\nspin_lock_irqsave(&l1->lock, flags);\r\nskb_queue_tail(&bch->tx_queue, skb);\r\nif (!bch->tx_skb && (bch->tx_cnt <= 0)) {\r\nl1->hw->mr.r_irq_fifo_blx[l1->st_num] |=\r\n((bch->bchan == 1) ? 1 : 4);\r\nspin_unlock_irqrestore(&l1->lock, flags);\r\nschedule_work(&l1->hw->tqueue);\r\n} else\r\nspin_unlock_irqrestore(&l1->lock, flags);\r\nbreak;\r\ncase (PH_ACTIVATE | REQUEST):\r\ncase (PH_DEACTIVATE | REQUEST):\r\nif (!l1->enabled)\r\nbreak;\r\nif (pr == (PH_DEACTIVATE | REQUEST))\r\nmode = L1_MODE_NULL;\r\nswitch (mode) {\r\ncase L1_MODE_HDLC:\r\nspin_lock_irqsave(&l1->lock,\r\nflags);\r\nl1->hw->mr.timer_usg_cnt++;\r\nl1->hw->mr.\r\nfifo_slow_timer_service[l1->\r\nst_num]\r\n|=\r\n((bch->bchan ==\r\n1) ? 0x2 : 0x8);\r\nWrite_hfc8(l1->hw, R_FIFO,\r\n(l1->st_num * 8 +\r\n((bch->bchan ==\r\n1) ? 0 : 2)));\r\nwait_busy(l1->hw);\r\nWrite_hfc8(l1->hw, A_CON_HDLC, 0xc);\r\nWrite_hfc8(l1->hw, A_SUBCH_CFG, 0);\r\nWrite_hfc8(l1->hw, A_IRQ_MSK, 1);\r\nWrite_hfc8(l1->hw, A_INC_RES_FIFO, 2);\r\nwait_busy(l1->hw);\r\nWrite_hfc8(l1->hw, R_FIFO,\r\n(l1->st_num * 8 +\r\n((bch->bchan ==\r\n1) ? 1 : 3)));\r\nwait_busy(l1->hw);\r\nWrite_hfc8(l1->hw, A_CON_HDLC, 0xc);\r\nWrite_hfc8(l1->hw, A_SUBCH_CFG, 0);\r\nWrite_hfc8(l1->hw, A_IRQ_MSK, 1);\r\nWrite_hfc8(l1->hw, A_INC_RES_FIFO, 2);\r\nWrite_hfc8(l1->hw, R_ST_SEL,\r\nl1->st_num);\r\nl1->hw->mr.r_ctrl0 |=\r\n(bch->bchan & 3);\r\nWrite_hfc8(l1->hw, A_ST_CTRL0,\r\nl1->hw->mr.r_ctrl0);\r\nbch->mode = L1_MODE_HDLC;\r\nspin_unlock_irqrestore(&l1->lock,\r\nflags);\r\nbch->b_if.ifc.l1l2(&bch->b_if.ifc,\r\nPH_ACTIVATE |\r\nINDICATION,\r\nNULL);\r\nbreak;\r\ncase L1_MODE_TRANS:\r\nspin_lock_irqsave(&l1->lock,\r\nflags);\r\nl1->hw->mr.\r\nfifo_rx_trans_enables[l1->\r\nst_num]\r\n|=\r\n((bch->bchan ==\r\n1) ? 0x2 : 0x8);\r\nl1->hw->mr.timer_usg_cnt++;\r\nWrite_hfc8(l1->hw, R_FIFO,\r\n(l1->st_num * 8 +\r\n((bch->bchan ==\r\n1) ? 0 : 2)));\r\nwait_busy(l1->hw);\r\nWrite_hfc8(l1->hw, A_CON_HDLC, 0xf);\r\nWrite_hfc8(l1->hw, A_SUBCH_CFG, 0);\r\nWrite_hfc8(l1->hw, A_IRQ_MSK, 0);\r\nWrite_hfc8(l1->hw, A_INC_RES_FIFO, 2);\r\nwait_busy(l1->hw);\r\nWrite_hfc8(l1->hw, R_FIFO,\r\n(l1->st_num * 8 +\r\n((bch->bchan ==\r\n1) ? 1 : 3)));\r\nwait_busy(l1->hw);\r\nWrite_hfc8(l1->hw, A_CON_HDLC, 0xf);\r\nWrite_hfc8(l1->hw, A_SUBCH_CFG, 0);\r\nWrite_hfc8(l1->hw, A_IRQ_MSK, 0);\r\nWrite_hfc8(l1->hw, A_INC_RES_FIFO, 2);\r\nWrite_hfc8(l1->hw, R_ST_SEL,\r\nl1->st_num);\r\nl1->hw->mr.r_ctrl0 |=\r\n(bch->bchan & 3);\r\nWrite_hfc8(l1->hw, A_ST_CTRL0,\r\nl1->hw->mr.r_ctrl0);\r\nbch->mode = L1_MODE_TRANS;\r\nspin_unlock_irqrestore(&l1->lock,\r\nflags);\r\nbch->b_if.ifc.l1l2(&bch->b_if.ifc,\r\nPH_ACTIVATE |\r\nINDICATION,\r\nNULL);\r\nbreak;\r\ndefault:\r\nif (bch->mode == L1_MODE_NULL)\r\nbreak;\r\nspin_lock_irqsave(&l1->lock,\r\nflags);\r\nl1->hw->mr.\r\nfifo_slow_timer_service[l1->\r\nst_num]\r\n&=\r\n~((bch->bchan ==\r\n1) ? 0x3 : 0xc);\r\nl1->hw->mr.\r\nfifo_rx_trans_enables[l1->\r\nst_num]\r\n&=\r\n~((bch->bchan ==\r\n1) ? 0x3 : 0xc);\r\nl1->hw->mr.timer_usg_cnt--;\r\nWrite_hfc8(l1->hw, R_FIFO,\r\n(l1->st_num * 8 +\r\n((bch->bchan ==\r\n1) ? 0 : 2)));\r\nwait_busy(l1->hw);\r\nWrite_hfc8(l1->hw, A_IRQ_MSK, 0);\r\nwait_busy(l1->hw);\r\nWrite_hfc8(l1->hw, R_FIFO,\r\n(l1->st_num * 8 +\r\n((bch->bchan ==\r\n1) ? 1 : 3)));\r\nwait_busy(l1->hw);\r\nWrite_hfc8(l1->hw, A_IRQ_MSK, 0);\r\nWrite_hfc8(l1->hw, R_ST_SEL,\r\nl1->st_num);\r\nl1->hw->mr.r_ctrl0 &=\r\n~(bch->bchan & 3);\r\nWrite_hfc8(l1->hw, A_ST_CTRL0,\r\nl1->hw->mr.r_ctrl0);\r\nspin_unlock_irqrestore(&l1->lock,\r\nflags);\r\nbch->mode = L1_MODE_NULL;\r\nbch->b_if.ifc.l1l2(&bch->b_if.ifc,\r\nPH_DEACTIVATE |\r\nINDICATION,\r\nNULL);\r\nif (bch->tx_skb) {\r\ndev_kfree_skb(bch->tx_skb);\r\nbch->tx_skb = NULL;\r\n}\r\nif (bch->rx_skb) {\r\ndev_kfree_skb(bch->rx_skb);\r\nbch->rx_skb = NULL;\r\n}\r\nskb_queue_purge(&bch->tx_queue);\r\nbch->tx_cnt = 0;\r\nbch->rx_ptr = NULL;\r\nbreak;\r\n}\r\nif (l1->hw->mr.timer_usg_cnt) {\r\nWrite_hfc8(l1->hw, R_IRQMSK_MISC,\r\nM_TI_IRQMSK);\r\n} else {\r\nWrite_hfc8(l1->hw, R_IRQMSK_MISC, 0);\r\n}\r\nbreak;\r\ndefault:\r\nprintk(KERN_INFO\r\n"HFC-4S/8S: Unknown B-chan cmd 0x%x received, ignored\n",\r\npr);\r\nbreak;\r\n}\r\nif (!l1->enabled)\r\nbch->b_if.ifc.l1l2(&bch->b_if.ifc,\r\nPH_DEACTIVATE | INDICATION, NULL);\r\n}\r\nstatic void\r\nhfc_l1_timer(struct hfc4s8s_l1 *l1)\r\n{\r\nu_long flags;\r\nif (!l1->enabled)\r\nreturn;\r\nspin_lock_irqsave(&l1->lock, flags);\r\nif (l1->nt_mode) {\r\nl1->l1_state = 1;\r\nWrite_hfc8(l1->hw, R_ST_SEL, l1->st_num);\r\nWrite_hfc8(l1->hw, A_ST_WR_STA, 0x11);\r\nspin_unlock_irqrestore(&l1->lock, flags);\r\nl1->d_if.ifc.l1l2(&l1->d_if.ifc,\r\nPH_DEACTIVATE | INDICATION, NULL);\r\nspin_lock_irqsave(&l1->lock, flags);\r\nl1->l1_state = 1;\r\nWrite_hfc8(l1->hw, A_ST_WR_STA, 0x1);\r\nspin_unlock_irqrestore(&l1->lock, flags);\r\n} else {\r\nWrite_hfc8(l1->hw, R_ST_SEL, l1->st_num);\r\nWrite_hfc8(l1->hw, A_ST_WR_STA, 0x13);\r\nspin_unlock_irqrestore(&l1->lock, flags);\r\nl1->d_if.ifc.l1l2(&l1->d_if.ifc,\r\nPH_DEACTIVATE | INDICATION, NULL);\r\nspin_lock_irqsave(&l1->lock, flags);\r\nWrite_hfc8(l1->hw, R_ST_SEL, l1->st_num);\r\nWrite_hfc8(l1->hw, A_ST_WR_STA, 0x3);\r\nspin_unlock_irqrestore(&l1->lock, flags);\r\n}\r\n}\r\nstatic void\r\nrx_d_frame(struct hfc4s8s_l1 *l1p, int ech)\r\n{\r\nint z1, z2;\r\nu_char f1, f2, df;\r\nstruct sk_buff *skb;\r\nu_char *cp;\r\nif (!l1p->enabled)\r\nreturn;\r\ndo {\r\nWrite_hfc8(l1p->hw, R_FIFO,\r\n(l1p->st_num * 8 + ((ech) ? 7 : 5)));\r\nwait_busy(l1p->hw);\r\nf1 = Read_hfc8_stable(l1p->hw, A_F1);\r\nf2 = Read_hfc8(l1p->hw, A_F2);\r\ndf = f1 - f2;\r\nif ((f1 - f2) < 0)\r\ndf = f1 - f2 + MAX_F_CNT + 1;\r\nif (!df) {\r\nreturn;\r\n}\r\nz1 = Read_hfc16_stable(l1p->hw, A_Z1);\r\nz2 = Read_hfc16(l1p->hw, A_Z2);\r\nz1 = z1 - z2 + 1;\r\nif (z1 < 0)\r\nz1 += 384;\r\nif (!(skb = dev_alloc_skb(MAX_D_FRAME_SIZE))) {\r\nprintk(KERN_INFO\r\n"HFC-4S/8S: Could not allocate D/E "\r\n"channel receive buffer");\r\nWrite_hfc8(l1p->hw, A_INC_RES_FIFO, 2);\r\nwait_busy(l1p->hw);\r\nreturn;\r\n}\r\nif (((z1 < 4) || (z1 > MAX_D_FRAME_SIZE))) {\r\nif (skb)\r\ndev_kfree_skb(skb);\r\nif (df == 1) {\r\nWrite_hfc8(l1p->hw, A_INC_RES_FIFO, 2);\r\nwait_busy(l1p->hw);\r\nreturn;\r\n} else {\r\n#ifndef HISAX_HFC4S8S_PCIMEM\r\nSetRegAddr(l1p->hw, A_FIFO_DATA0);\r\n#endif\r\nwhile (z1 >= 4) {\r\n#ifdef HISAX_HFC4S8S_PCIMEM\r\nRead_hfc32(l1p->hw, A_FIFO_DATA0);\r\n#else\r\nfRead_hfc32(l1p->hw);\r\n#endif\r\nz1 -= 4;\r\n}\r\nwhile (z1--)\r\n#ifdef HISAX_HFC4S8S_PCIMEM\r\nRead_hfc8(l1p->hw, A_FIFO_DATA0);\r\n#else\r\nfRead_hfc8(l1p->hw);\r\n#endif\r\nWrite_hfc8(l1p->hw, A_INC_RES_FIFO, 1);\r\nwait_busy(l1p->hw);\r\nreturn;\r\n}\r\n}\r\ncp = skb->data;\r\n#ifndef HISAX_HFC4S8S_PCIMEM\r\nSetRegAddr(l1p->hw, A_FIFO_DATA0);\r\n#endif\r\nwhile (z1 >= 4) {\r\n#ifdef HISAX_HFC4S8S_PCIMEM\r\n*((unsigned long *) cp) =\r\nRead_hfc32(l1p->hw, A_FIFO_DATA0);\r\n#else\r\n*((unsigned long *) cp) = fRead_hfc32(l1p->hw);\r\n#endif\r\ncp += 4;\r\nz1 -= 4;\r\n}\r\nwhile (z1--)\r\n#ifdef HISAX_HFC4S8S_PCIMEM\r\n*cp++ = Read_hfc8(l1p->hw, A_FIFO_DATA0);\r\n#else\r\n*cp++ = fRead_hfc8(l1p->hw);\r\n#endif\r\nWrite_hfc8(l1p->hw, A_INC_RES_FIFO, 1);\r\nwait_busy(l1p->hw);\r\nif (*(--cp)) {\r\ndev_kfree_skb(skb);\r\n} else {\r\nskb->len = (cp - skb->data) - 2;\r\nif (ech)\r\nl1p->d_if.ifc.l1l2(&l1p->d_if.ifc,\r\nPH_DATA_E | INDICATION,\r\nskb);\r\nelse\r\nl1p->d_if.ifc.l1l2(&l1p->d_if.ifc,\r\nPH_DATA | INDICATION,\r\nskb);\r\n}\r\n} while (1);\r\n}\r\nstatic void\r\nrx_b_frame(struct hfc4s8s_btype *bch)\r\n{\r\nint z1, z2, hdlc_complete;\r\nu_char f1, f2;\r\nstruct hfc4s8s_l1 *l1 = bch->l1p;\r\nstruct sk_buff *skb;\r\nif (!l1->enabled || (bch->mode == L1_MODE_NULL))\r\nreturn;\r\ndo {\r\nWrite_hfc8(l1->hw, R_FIFO,\r\n(l1->st_num * 8 + ((bch->bchan == 1) ? 1 : 3)));\r\nwait_busy(l1->hw);\r\nif (bch->mode == L1_MODE_HDLC) {\r\nf1 = Read_hfc8_stable(l1->hw, A_F1);\r\nf2 = Read_hfc8(l1->hw, A_F2);\r\nhdlc_complete = ((f1 ^ f2) & MAX_F_CNT);\r\n} else\r\nhdlc_complete = 0;\r\nz1 = Read_hfc16_stable(l1->hw, A_Z1);\r\nz2 = Read_hfc16(l1->hw, A_Z2);\r\nz1 = (z1 - z2);\r\nif (hdlc_complete)\r\nz1++;\r\nif (z1 < 0)\r\nz1 += 384;\r\nif (!z1)\r\nbreak;\r\nif (!(skb = bch->rx_skb)) {\r\nif (!\r\n(skb =\r\ndev_alloc_skb((bch->mode ==\r\nL1_MODE_TRANS) ? z1\r\n: (MAX_B_FRAME_SIZE + 3)))) {\r\nprintk(KERN_ERR\r\n"HFC-4S/8S: Could not allocate B "\r\n"channel receive buffer");\r\nreturn;\r\n}\r\nbch->rx_ptr = skb->data;\r\nbch->rx_skb = skb;\r\n}\r\nskb->len = (bch->rx_ptr - skb->data) + z1;\r\nif ((bch->mode == L1_MODE_HDLC) &&\r\n((hdlc_complete && (skb->len < 4)) ||\r\n(skb->len > (MAX_B_FRAME_SIZE + 3)))) {\r\nskb->len = 0;\r\nbch->rx_ptr = skb->data;\r\nWrite_hfc8(l1->hw, A_INC_RES_FIFO, 2);\r\nwait_busy(l1->hw);\r\nreturn;\r\n}\r\n#ifndef HISAX_HFC4S8S_PCIMEM\r\nSetRegAddr(l1->hw, A_FIFO_DATA0);\r\n#endif\r\nwhile (z1 >= 4) {\r\n#ifdef HISAX_HFC4S8S_PCIMEM\r\n*((unsigned long *) bch->rx_ptr) =\r\nRead_hfc32(l1->hw, A_FIFO_DATA0);\r\n#else\r\n*((unsigned long *) bch->rx_ptr) =\r\nfRead_hfc32(l1->hw);\r\n#endif\r\nbch->rx_ptr += 4;\r\nz1 -= 4;\r\n}\r\nwhile (z1--)\r\n#ifdef HISAX_HFC4S8S_PCIMEM\r\n*(bch->rx_ptr++) = Read_hfc8(l1->hw, A_FIFO_DATA0);\r\n#else\r\n*(bch->rx_ptr++) = fRead_hfc8(l1->hw);\r\n#endif\r\nif (hdlc_complete) {\r\nWrite_hfc8(l1->hw, A_INC_RES_FIFO, 1);\r\nwait_busy(l1->hw);\r\nbch->rx_ptr--;\r\nif (*bch->rx_ptr) {\r\nskb->len = 0;\r\nbch->rx_ptr = skb->data;\r\ncontinue;\r\n}\r\nskb->len -= 3;\r\n}\r\nif (hdlc_complete || (bch->mode == L1_MODE_TRANS)) {\r\nbch->rx_skb = NULL;\r\nbch->rx_ptr = NULL;\r\nbch->b_if.ifc.l1l2(&bch->b_if.ifc,\r\nPH_DATA | INDICATION, skb);\r\n}\r\n} while (1);\r\n}\r\nstatic void\r\ntx_d_frame(struct hfc4s8s_l1 *l1p)\r\n{\r\nstruct sk_buff *skb;\r\nu_char f1, f2;\r\nu_char *cp;\r\nlong cnt;\r\nif (l1p->l1_state != 7)\r\nreturn;\r\nWrite_hfc8(l1p->hw, R_FIFO, (l1p->st_num * 8 + 4));\r\nwait_busy(l1p->hw);\r\nf1 = Read_hfc8(l1p->hw, A_F1);\r\nf2 = Read_hfc8_stable(l1p->hw, A_F2);\r\nif ((f1 ^ f2) & MAX_F_CNT)\r\nreturn;\r\nif (l1p->tx_cnt > 0) {\r\ncnt = l1p->tx_cnt;\r\nl1p->tx_cnt = 0;\r\nl1p->d_if.ifc.l1l2(&l1p->d_if.ifc, PH_DATA | CONFIRM,\r\n(void *) cnt);\r\n}\r\nif ((skb = skb_dequeue(&l1p->d_tx_queue))) {\r\ncp = skb->data;\r\ncnt = skb->len;\r\n#ifndef HISAX_HFC4S8S_PCIMEM\r\nSetRegAddr(l1p->hw, A_FIFO_DATA0);\r\n#endif\r\nwhile (cnt >= 4) {\r\n#ifdef HISAX_HFC4S8S_PCIMEM\r\nfWrite_hfc32(l1p->hw, A_FIFO_DATA0,\r\n*(unsigned long *) cp);\r\n#else\r\nSetRegAddr(l1p->hw, A_FIFO_DATA0);\r\nfWrite_hfc32(l1p->hw, *(unsigned long *) cp);\r\n#endif\r\ncp += 4;\r\ncnt -= 4;\r\n}\r\n#ifdef HISAX_HFC4S8S_PCIMEM\r\nwhile (cnt--)\r\nfWrite_hfc8(l1p->hw, A_FIFO_DATA0, *cp++);\r\n#else\r\nwhile (cnt--)\r\nfWrite_hfc8(l1p->hw, *cp++);\r\n#endif\r\nl1p->tx_cnt = skb->truesize;\r\nWrite_hfc8(l1p->hw, A_INC_RES_FIFO, 1);\r\nwait_busy(l1p->hw);\r\ndev_kfree_skb(skb);\r\n}\r\n}\r\nstatic void\r\ntx_b_frame(struct hfc4s8s_btype *bch)\r\n{\r\nstruct sk_buff *skb;\r\nstruct hfc4s8s_l1 *l1 = bch->l1p;\r\nu_char *cp;\r\nint cnt, max, hdlc_num;\r\nlong ack_len = 0;\r\nif (!l1->enabled || (bch->mode == L1_MODE_NULL))\r\nreturn;\r\nWrite_hfc8(l1->hw, R_FIFO,\r\n(l1->st_num * 8 + ((bch->bchan == 1) ? 0 : 2)));\r\nwait_busy(l1->hw);\r\ndo {\r\nif (bch->mode == L1_MODE_HDLC) {\r\nhdlc_num = Read_hfc8(l1->hw, A_F1) & MAX_F_CNT;\r\nhdlc_num -=\r\n(Read_hfc8_stable(l1->hw, A_F2) & MAX_F_CNT);\r\nif (hdlc_num < 0)\r\nhdlc_num += 16;\r\nif (hdlc_num >= 15)\r\nbreak;\r\n} else\r\nhdlc_num = 0;\r\nif (!(skb = bch->tx_skb)) {\r\nif (!(skb = skb_dequeue(&bch->tx_queue))) {\r\nl1->hw->mr.fifo_slow_timer_service[l1->\r\nst_num]\r\n&= ~((bch->bchan == 1) ? 1 : 4);\r\nbreak;\r\n}\r\nbch->tx_skb = skb;\r\nbch->tx_cnt = 0;\r\n}\r\nif (!hdlc_num)\r\nl1->hw->mr.fifo_slow_timer_service[l1->st_num] |=\r\n((bch->bchan == 1) ? 1 : 4);\r\nelse\r\nl1->hw->mr.fifo_slow_timer_service[l1->st_num] &=\r\n~((bch->bchan == 1) ? 1 : 4);\r\nmax = Read_hfc16_stable(l1->hw, A_Z2);\r\nmax -= Read_hfc16(l1->hw, A_Z1);\r\nif (max <= 0)\r\nmax += 384;\r\nmax--;\r\nif (max < 16)\r\nbreak;\r\ncnt = skb->len - bch->tx_cnt;\r\nif (cnt > max)\r\ncnt = max;\r\ncp = skb->data + bch->tx_cnt;\r\nbch->tx_cnt += cnt;\r\n#ifndef HISAX_HFC4S8S_PCIMEM\r\nSetRegAddr(l1->hw, A_FIFO_DATA0);\r\n#endif\r\nwhile (cnt >= 4) {\r\n#ifdef HISAX_HFC4S8S_PCIMEM\r\nfWrite_hfc32(l1->hw, A_FIFO_DATA0,\r\n*(unsigned long *) cp);\r\n#else\r\nfWrite_hfc32(l1->hw, *(unsigned long *) cp);\r\n#endif\r\ncp += 4;\r\ncnt -= 4;\r\n}\r\nwhile (cnt--)\r\n#ifdef HISAX_HFC4S8S_PCIMEM\r\nfWrite_hfc8(l1->hw, A_FIFO_DATA0, *cp++);\r\n#else\r\nfWrite_hfc8(l1->hw, *cp++);\r\n#endif\r\nif (bch->tx_cnt >= skb->len) {\r\nif (bch->mode == L1_MODE_HDLC) {\r\nWrite_hfc8(l1->hw, A_INC_RES_FIFO, 1);\r\n}\r\nack_len += skb->truesize;\r\nbch->tx_skb = NULL;\r\nbch->tx_cnt = 0;\r\ndev_kfree_skb(skb);\r\n} else\r\nWrite_hfc8(l1->hw, R_FIFO,\r\n(l1->st_num * 8 +\r\n((bch->bchan == 1) ? 0 : 2)));\r\nwait_busy(l1->hw);\r\n} while (1);\r\nif (ack_len)\r\nbch->b_if.ifc.l1l2((struct hisax_if *) &bch->b_if,\r\nPH_DATA | CONFIRM, (void *) ack_len);\r\n}\r\nstatic void\r\nhfc4s8s_bh(struct work_struct *work)\r\n{\r\nhfc4s8s_hw *hw = container_of(work, hfc4s8s_hw, tqueue);\r\nu_char b;\r\nstruct hfc4s8s_l1 *l1p;\r\nvolatile u_char *fifo_stat;\r\nint idx;\r\nb = 1;\r\nl1p = hw->l1;\r\nwhile (b) {\r\nif ((b & hw->mr.r_irq_statech)) {\r\nhw->mr.r_irq_statech &= ~b;\r\nif (l1p->enabled) {\r\nif (l1p->nt_mode) {\r\nu_char oldstate = l1p->l1_state;\r\nWrite_hfc8(l1p->hw, R_ST_SEL,\r\nl1p->st_num);\r\nl1p->l1_state =\r\nRead_hfc8(l1p->hw,\r\nA_ST_RD_STA) & 0xf;\r\nif ((oldstate == 3)\r\n&& (l1p->l1_state != 3))\r\nl1p->d_if.ifc.l1l2(&l1p->\r\nd_if.\r\nifc,\r\nPH_DEACTIVATE\r\n|\r\nINDICATION,\r\nNULL);\r\nif (l1p->l1_state != 2) {\r\ndel_timer(&l1p->l1_timer);\r\nif (l1p->l1_state == 3) {\r\nl1p->d_if.ifc.\r\nl1l2(&l1p->\r\nd_if.ifc,\r\nPH_ACTIVATE\r\n|\r\nINDICATION,\r\nNULL);\r\n}\r\n} else {\r\nWrite_hfc8(hw, A_ST_WR_STA,\r\nM_SET_G2_G3);\r\nmod_timer(&l1p->l1_timer,\r\njiffies +\r\nL1_TIMER_T1);\r\n}\r\nprintk(KERN_INFO\r\n"HFC-4S/8S: NT ch %d l1 state %d -> %d\n",\r\nl1p->st_num, oldstate,\r\nl1p->l1_state);\r\n} else {\r\nu_char oldstate = l1p->l1_state;\r\nWrite_hfc8(l1p->hw, R_ST_SEL,\r\nl1p->st_num);\r\nl1p->l1_state =\r\nRead_hfc8(l1p->hw,\r\nA_ST_RD_STA) & 0xf;\r\nif (((l1p->l1_state == 3) &&\r\n((oldstate == 7) ||\r\n(oldstate == 8))) ||\r\n((timer_pending\r\n(&l1p->l1_timer))\r\n&& (l1p->l1_state == 8))) {\r\nmod_timer(&l1p->l1_timer,\r\nL1_TIMER_T4 +\r\njiffies);\r\n} else {\r\nif (l1p->l1_state == 7) {\r\ndel_timer(&l1p->\r\nl1_timer);\r\nl1p->d_if.ifc.\r\nl1l2(&l1p->\r\nd_if.ifc,\r\nPH_ACTIVATE\r\n|\r\nINDICATION,\r\nNULL);\r\ntx_d_frame(l1p);\r\n}\r\nif (l1p->l1_state == 3) {\r\nif (oldstate != 3)\r\nl1p->d_if.\r\nifc.\r\nl1l2\r\n(&l1p->\r\nd_if.\r\nifc,\r\nPH_DEACTIVATE\r\n|\r\nINDICATION,\r\nNULL);\r\n}\r\n}\r\nprintk(KERN_INFO\r\n"HFC-4S/8S: TE %d ch %d l1 state %d -> %d\n",\r\nl1p->hw->cardnum,\r\nl1p->st_num, oldstate,\r\nl1p->l1_state);\r\n}\r\n}\r\n}\r\nb <<= 1;\r\nl1p++;\r\n}\r\nidx = 0;\r\nfifo_stat = hw->mr.r_irq_fifo_blx;\r\nl1p = hw->l1;\r\nwhile (idx < hw->driver_data.max_st_ports) {\r\nif (hw->mr.timer_irq) {\r\n*fifo_stat |= hw->mr.fifo_rx_trans_enables[idx];\r\nif (hw->fifo_sched_cnt <= 0) {\r\n*fifo_stat |=\r\nhw->mr.fifo_slow_timer_service[l1p->\r\nst_num];\r\n}\r\n}\r\n*fifo_stat &= 0xff - 0x40;\r\nwhile (*fifo_stat) {\r\nif (!l1p->nt_mode) {\r\nif ((*fifo_stat & 0x20)) {\r\n*fifo_stat &= ~0x20;\r\nrx_d_frame(l1p, 0);\r\n}\r\nif ((*fifo_stat & 0x80)) {\r\n*fifo_stat &= ~0x80;\r\nrx_d_frame(l1p, 1);\r\n}\r\nif ((*fifo_stat & 0x10)) {\r\n*fifo_stat &= ~0x10;\r\ntx_d_frame(l1p);\r\n}\r\n}\r\nif ((*fifo_stat & 0x2)) {\r\n*fifo_stat &= ~0x2;\r\nrx_b_frame(l1p->b_ch);\r\n}\r\nif ((*fifo_stat & 0x1)) {\r\n*fifo_stat &= ~0x1;\r\ntx_b_frame(l1p->b_ch);\r\n}\r\nif ((*fifo_stat & 0x8)) {\r\n*fifo_stat &= ~0x8;\r\nrx_b_frame(l1p->b_ch + 1);\r\n}\r\nif ((*fifo_stat & 0x4)) {\r\n*fifo_stat &= ~0x4;\r\ntx_b_frame(l1p->b_ch + 1);\r\n}\r\n}\r\nfifo_stat++;\r\nl1p++;\r\nidx++;\r\n}\r\nif (hw->fifo_sched_cnt <= 0)\r\nhw->fifo_sched_cnt += (1 << (7 - TRANS_TIMER_MODE));\r\nhw->mr.timer_irq = 0;\r\n}\r\nstatic irqreturn_t\r\nhfc4s8s_interrupt(int intno, void *dev_id)\r\n{\r\nhfc4s8s_hw *hw = dev_id;\r\nu_char b, ovr;\r\nvolatile u_char *ovp;\r\nint idx;\r\nu_char old_ioreg;\r\nif (!hw || !(hw->mr.r_irq_ctrl & M_GLOB_IRQ_EN))\r\nreturn IRQ_NONE;\r\n#ifndef HISAX_HFC4S8S_PCIMEM\r\nold_ioreg = GetRegAddr(hw);\r\n#endif\r\nhw->mr.r_irq_statech |=\r\n(Read_hfc8(hw, R_SCI) & hw->mr.r_irqmsk_statchg);\r\nif (!\r\n(b = (Read_hfc8(hw, R_STATUS) & (M_MISC_IRQSTA | M_FR_IRQSTA)))\r\n&& !hw->mr.r_irq_statech) {\r\n#ifndef HISAX_HFC4S8S_PCIMEM\r\nSetRegAddr(hw, old_ioreg);\r\n#endif\r\nreturn IRQ_NONE;\r\n}\r\nif (Read_hfc8(hw, R_IRQ_MISC) & M_TI_IRQ) {\r\nhw->mr.timer_irq = 1;\r\nhw->fifo_sched_cnt--;\r\n}\r\nif ((ovr = Read_hfc8(hw, R_IRQ_OVIEW))) {\r\nhw->mr.r_irq_oview |= ovr;\r\nidx = R_IRQ_FIFO_BL0;\r\novp = hw->mr.r_irq_fifo_blx;\r\nwhile (ovr) {\r\nif ((ovr & 1)) {\r\n*ovp |= Read_hfc8(hw, idx);\r\n}\r\novp++;\r\nidx++;\r\novr >>= 1;\r\n}\r\n}\r\nschedule_work(&hw->tqueue);\r\n#ifndef HISAX_HFC4S8S_PCIMEM\r\nSetRegAddr(hw, old_ioreg);\r\n#endif\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void\r\nchipreset(hfc4s8s_hw *hw)\r\n{\r\nu_long flags;\r\nspin_lock_irqsave(&hw->lock, flags);\r\nWrite_hfc8(hw, R_CTRL, 0);\r\nWrite_hfc8(hw, R_RAM_MISC, 0);\r\nWrite_hfc8(hw, R_FIFO_MD, 0);\r\nWrite_hfc8(hw, R_CIRM, M_SRES);\r\nhw->mr.r_irq_ctrl = 0;\r\nspin_unlock_irqrestore(&hw->lock, flags);\r\nudelay(3);\r\nWrite_hfc8(hw, R_CIRM, 0);\r\nwait_busy(hw);\r\nWrite_hfc8(hw, R_PCM_MD0, M_PCM_MD);\r\nWrite_hfc8(hw, R_RAM_MISC, M_FZ_MD);\r\nif (hw->driver_data.clock_mode == 1)\r\nWrite_hfc8(hw, R_BRG_PCM_CFG, M_PCM_CLK);\r\nWrite_hfc8(hw, R_TI_WD, TRANS_TIMER_MODE);\r\nmemset(&hw->mr, 0, sizeof(hw->mr));\r\n}\r\nstatic void\r\nhfc_hardware_enable(hfc4s8s_hw *hw, int enable, int nt_mode)\r\n{\r\nu_long flags;\r\nchar if_name[40];\r\nint i;\r\nif (enable) {\r\nhw->nt_mode = nt_mode;\r\nhw->mr.r_irq_ctrl = M_FIFO_IRQ;\r\nWrite_hfc8(hw, R_IRQ_CTRL, hw->mr.r_irq_ctrl);\r\nhw->mr.r_irqmsk_statchg = 0;\r\nWrite_hfc8(hw, R_SCI_MSK, hw->mr.r_irqmsk_statchg);\r\nWrite_hfc8(hw, R_PWM_MD, 0x80);\r\nWrite_hfc8(hw, R_PWM1, 26);\r\nif (!nt_mode)\r\nWrite_hfc8(hw, R_ST_SYNC, M_AUTO_SYNC);\r\nfor (i = 0; i < hw->driver_data.max_st_ports; i++) {\r\nhw->mr.r_irqmsk_statchg |= (1 << i);\r\nWrite_hfc8(hw, R_SCI_MSK, hw->mr.r_irqmsk_statchg);\r\nWrite_hfc8(hw, R_ST_SEL, i);\r\nWrite_hfc8(hw, A_ST_CLK_DLY,\r\n((nt_mode) ? CLKDEL_NT : CLKDEL_TE));\r\nhw->mr.r_ctrl0 = ((nt_mode) ? CTRL0_NT : CTRL0_TE);\r\nWrite_hfc8(hw, A_ST_CTRL0, hw->mr.r_ctrl0);\r\nWrite_hfc8(hw, A_ST_CTRL2, 3);\r\nWrite_hfc8(hw, A_ST_WR_STA, 0);\r\nhw->l1[i].enabled = 1;\r\nhw->l1[i].nt_mode = nt_mode;\r\nif (!nt_mode) {\r\nWrite_hfc8(hw, R_FIFO, i * 8 + 7);\r\nwait_busy(hw);\r\nWrite_hfc8(hw, A_CON_HDLC, 0x11);\r\nWrite_hfc8(hw, A_SUBCH_CFG, 2);\r\nWrite_hfc8(hw, A_IRQ_MSK, 1);\r\nWrite_hfc8(hw, A_INC_RES_FIFO, 2);\r\nwait_busy(hw);\r\nWrite_hfc8(hw, R_FIFO, i * 8 + 5);\r\nwait_busy(hw);\r\nWrite_hfc8(hw, A_CON_HDLC, 0x11);\r\nWrite_hfc8(hw, A_SUBCH_CFG, 2);\r\nWrite_hfc8(hw, A_IRQ_MSK, 1);\r\nWrite_hfc8(hw, A_INC_RES_FIFO, 2);\r\nwait_busy(hw);\r\nWrite_hfc8(hw, R_FIFO, i * 8 + 4);\r\nwait_busy(hw);\r\nWrite_hfc8(hw, A_CON_HDLC, 0x11);\r\nWrite_hfc8(hw, A_SUBCH_CFG, 2);\r\nWrite_hfc8(hw, A_IRQ_MSK, 1);\r\nWrite_hfc8(hw, A_INC_RES_FIFO, 2);\r\nwait_busy(hw);\r\n}\r\nsprintf(if_name, "hfc4s8s_%d%d_", hw->cardnum, i);\r\nif (hisax_register\r\n(&hw->l1[i].d_if, hw->l1[i].b_table, if_name,\r\n((nt_mode) ? 3 : 2))) {\r\nhw->l1[i].enabled = 0;\r\nhw->mr.r_irqmsk_statchg &= ~(1 << i);\r\nWrite_hfc8(hw, R_SCI_MSK,\r\nhw->mr.r_irqmsk_statchg);\r\nprintk(KERN_INFO\r\n"HFC-4S/8S: Unable to register S/T device %s, break\n",\r\nif_name);\r\nbreak;\r\n}\r\n}\r\nspin_lock_irqsave(&hw->lock, flags);\r\nhw->mr.r_irq_ctrl |= M_GLOB_IRQ_EN;\r\nWrite_hfc8(hw, R_IRQ_CTRL, hw->mr.r_irq_ctrl);\r\nspin_unlock_irqrestore(&hw->lock, flags);\r\n} else {\r\nspin_lock_irqsave(&hw->lock, flags);\r\nhw->mr.r_irq_ctrl &= ~M_GLOB_IRQ_EN;\r\nWrite_hfc8(hw, R_IRQ_CTRL, hw->mr.r_irq_ctrl);\r\nspin_unlock_irqrestore(&hw->lock, flags);\r\nfor (i = hw->driver_data.max_st_ports - 1; i >= 0; i--) {\r\nhw->l1[i].enabled = 0;\r\nhisax_unregister(&hw->l1[i].d_if);\r\ndel_timer(&hw->l1[i].l1_timer);\r\nskb_queue_purge(&hw->l1[i].d_tx_queue);\r\nskb_queue_purge(&hw->l1[i].b_ch[0].tx_queue);\r\nskb_queue_purge(&hw->l1[i].b_ch[1].tx_queue);\r\n}\r\nchipreset(hw);\r\n}\r\n}\r\nstatic void\r\nrelease_pci_ports(hfc4s8s_hw *hw)\r\n{\r\npci_write_config_word(hw->pdev, PCI_COMMAND, 0);\r\n#ifdef HISAX_HFC4S8S_PCIMEM\r\nif (hw->membase)\r\niounmap((void *) hw->membase);\r\n#else\r\nif (hw->iobase)\r\nrelease_region(hw->iobase, 8);\r\n#endif\r\n}\r\nstatic void\r\nenable_pci_ports(hfc4s8s_hw *hw)\r\n{\r\n#ifdef HISAX_HFC4S8S_PCIMEM\r\npci_write_config_word(hw->pdev, PCI_COMMAND, PCI_ENA_MEMIO);\r\n#else\r\npci_write_config_word(hw->pdev, PCI_COMMAND, PCI_ENA_REGIO);\r\n#endif\r\n}\r\nstatic int\r\nsetup_instance(hfc4s8s_hw *hw)\r\n{\r\nint err = -EIO;\r\nint i;\r\nfor (i = 0; i < HFC_MAX_ST; i++) {\r\nstruct hfc4s8s_l1 *l1p;\r\nl1p = hw->l1 + i;\r\nspin_lock_init(&l1p->lock);\r\nl1p->hw = hw;\r\nl1p->l1_timer.function = (void *) hfc_l1_timer;\r\nl1p->l1_timer.data = (long) (l1p);\r\ninit_timer(&l1p->l1_timer);\r\nl1p->st_num = i;\r\nskb_queue_head_init(&l1p->d_tx_queue);\r\nl1p->d_if.ifc.priv = hw->l1 + i;\r\nl1p->d_if.ifc.l2l1 = (void *) dch_l2l1;\r\nspin_lock_init(&l1p->b_ch[0].lock);\r\nl1p->b_ch[0].b_if.ifc.l2l1 = (void *) bch_l2l1;\r\nl1p->b_ch[0].b_if.ifc.priv = (void *) &l1p->b_ch[0];\r\nl1p->b_ch[0].l1p = hw->l1 + i;\r\nl1p->b_ch[0].bchan = 1;\r\nl1p->b_table[0] = &l1p->b_ch[0].b_if;\r\nskb_queue_head_init(&l1p->b_ch[0].tx_queue);\r\nspin_lock_init(&l1p->b_ch[1].lock);\r\nl1p->b_ch[1].b_if.ifc.l2l1 = (void *) bch_l2l1;\r\nl1p->b_ch[1].b_if.ifc.priv = (void *) &l1p->b_ch[1];\r\nl1p->b_ch[1].l1p = hw->l1 + i;\r\nl1p->b_ch[1].bchan = 2;\r\nl1p->b_table[1] = &l1p->b_ch[1].b_if;\r\nskb_queue_head_init(&l1p->b_ch[1].tx_queue);\r\n}\r\nenable_pci_ports(hw);\r\nchipreset(hw);\r\ni = Read_hfc8(hw, R_CHIP_ID) >> CHIP_ID_SHIFT;\r\nif (i != hw->driver_data.chip_id) {\r\nprintk(KERN_INFO\r\n"HFC-4S/8S: invalid chip id 0x%x instead of 0x%x, card ignored\n",\r\ni, hw->driver_data.chip_id);\r\ngoto out;\r\n}\r\ni = Read_hfc8(hw, R_CHIP_RV) & 0xf;\r\nif (!i) {\r\nprintk(KERN_INFO\r\n"HFC-4S/8S: chip revision 0 not supported, card ignored\n");\r\ngoto out;\r\n}\r\nINIT_WORK(&hw->tqueue, hfc4s8s_bh);\r\nif (request_irq\r\n(hw->irq, hfc4s8s_interrupt, IRQF_SHARED, hw->card_name, hw)) {\r\nprintk(KERN_INFO\r\n"HFC-4S/8S: unable to alloc irq %d, card ignored\n",\r\nhw->irq);\r\ngoto out;\r\n}\r\n#ifdef HISAX_HFC4S8S_PCIMEM\r\nprintk(KERN_INFO\r\n"HFC-4S/8S: found PCI card at membase 0x%p, irq %d\n",\r\nhw->hw_membase, hw->irq);\r\n#else\r\nprintk(KERN_INFO\r\n"HFC-4S/8S: found PCI card at iobase 0x%x, irq %d\n",\r\nhw->iobase, hw->irq);\r\n#endif\r\nhfc_hardware_enable(hw, 1, 0);\r\nreturn (0);\r\nout:\r\nhw->irq = 0;\r\nrelease_pci_ports(hw);\r\nkfree(hw);\r\nreturn (err);\r\n}\r\nstatic int\r\nhfc4s8s_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nint err = -ENOMEM;\r\nhfc4s8s_param *driver_data = (hfc4s8s_param *) ent->driver_data;\r\nhfc4s8s_hw *hw;\r\nif (!(hw = kzalloc(sizeof(hfc4s8s_hw), GFP_ATOMIC))) {\r\nprintk(KERN_ERR "No kmem for HFC-4S/8S card\n");\r\nreturn (err);\r\n}\r\nhw->pdev = pdev;\r\nerr = pci_enable_device(pdev);\r\nif (err)\r\ngoto out;\r\nhw->cardnum = card_cnt;\r\nsprintf(hw->card_name, "hfc4s8s_%d", hw->cardnum);\r\nprintk(KERN_INFO "HFC-4S/8S: found adapter %s (%s) at %s\n",\r\ndriver_data->device_name, hw->card_name, pci_name(pdev));\r\nspin_lock_init(&hw->lock);\r\nhw->driver_data = *driver_data;\r\nhw->irq = pdev->irq;\r\nhw->iobase = pci_resource_start(pdev, 0);\r\n#ifdef HISAX_HFC4S8S_PCIMEM\r\nhw->hw_membase = (u_char *) pci_resource_start(pdev, 1);\r\nhw->membase = ioremap((ulong) hw->hw_membase, 256);\r\n#else\r\nif (!request_region(hw->iobase, 8, hw->card_name)) {\r\nprintk(KERN_INFO\r\n"HFC-4S/8S: failed to rquest address space at 0x%04x\n",\r\nhw->iobase);\r\ngoto out;\r\n}\r\n#endif\r\npci_set_drvdata(pdev, hw);\r\nerr = setup_instance(hw);\r\nif (!err)\r\ncard_cnt++;\r\nreturn (err);\r\nout:\r\nkfree(hw);\r\nreturn (err);\r\n}\r\nstatic void\r\nhfc4s8s_remove(struct pci_dev *pdev)\r\n{\r\nhfc4s8s_hw *hw = pci_get_drvdata(pdev);\r\nprintk(KERN_INFO "HFC-4S/8S: removing card %d\n", hw->cardnum);\r\nhfc_hardware_enable(hw, 0, 0);\r\nif (hw->irq)\r\nfree_irq(hw->irq, hw);\r\nhw->irq = 0;\r\nrelease_pci_ports(hw);\r\ncard_cnt--;\r\npci_disable_device(pdev);\r\nkfree(hw);\r\nreturn;\r\n}\r\nstatic int __init\r\nhfc4s8s_module_init(void)\r\n{\r\nint err;\r\nprintk(KERN_INFO\r\n"HFC-4S/8S: Layer 1 driver module for HFC-4S/8S isdn chips, %s\n",\r\nhfc4s8s_rev);\r\nprintk(KERN_INFO\r\n"HFC-4S/8S: (C) 2003 Cornelius Consult, www.cornelius-consult.de\n");\r\ncard_cnt = 0;\r\nerr = pci_register_driver(&hfc4s8s_driver);\r\nif (err < 0) {\r\ngoto out;\r\n}\r\nprintk(KERN_INFO "HFC-4S/8S: found %d cards\n", card_cnt);\r\nreturn 0;\r\nout:\r\nreturn (err);\r\n}\r\nstatic void __exit\r\nhfc4s8s_module_exit(void)\r\n{\r\npci_unregister_driver(&hfc4s8s_driver);\r\nprintk(KERN_INFO "HFC-4S/8S: module removed\n");\r\n}

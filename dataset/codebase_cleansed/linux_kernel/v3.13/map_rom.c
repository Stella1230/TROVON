static struct mtd_info *map_rom_probe(struct map_info *map)\r\n{\r\nstruct mtd_info *mtd;\r\nmtd = kzalloc(sizeof(*mtd), GFP_KERNEL);\r\nif (!mtd)\r\nreturn NULL;\r\nmap->fldrv = &maprom_chipdrv;\r\nmtd->priv = map;\r\nmtd->name = map->name;\r\nmtd->type = MTD_ROM;\r\nmtd->size = map->size;\r\nmtd->_get_unmapped_area = maprom_unmapped_area;\r\nmtd->_read = maprom_read;\r\nmtd->_write = maprom_write;\r\nmtd->_sync = maprom_nop;\r\nmtd->_erase = maprom_erase;\r\nmtd->flags = MTD_CAP_ROM;\r\nmtd->erasesize = map->size;\r\nmtd->writesize = 1;\r\n__module_get(THIS_MODULE);\r\nreturn mtd;\r\n}\r\nstatic unsigned long maprom_unmapped_area(struct mtd_info *mtd,\r\nunsigned long len,\r\nunsigned long offset,\r\nunsigned long flags)\r\n{\r\nstruct map_info *map = mtd->priv;\r\nreturn (unsigned long) map->virt + offset;\r\n}\r\nstatic int maprom_read (struct mtd_info *mtd, loff_t from, size_t len, size_t *retlen, u_char *buf)\r\n{\r\nstruct map_info *map = mtd->priv;\r\nmap_copy_from(map, buf, from, len);\r\n*retlen = len;\r\nreturn 0;\r\n}\r\nstatic void maprom_nop(struct mtd_info *mtd)\r\n{\r\n}\r\nstatic int maprom_write (struct mtd_info *mtd, loff_t to, size_t len, size_t *retlen, const u_char *buf)\r\n{\r\nreturn -EROFS;\r\n}\r\nstatic int maprom_erase (struct mtd_info *mtd, struct erase_info *info)\r\n{\r\nreturn -EROFS;\r\n}\r\nstatic int __init map_rom_init(void)\r\n{\r\nregister_mtd_chip_driver(&maprom_chipdrv);\r\nreturn 0;\r\n}\r\nstatic void __exit map_rom_exit(void)\r\n{\r\nunregister_mtd_chip_driver(&maprom_chipdrv);\r\n}

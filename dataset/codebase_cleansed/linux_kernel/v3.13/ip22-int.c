static void enable_local0_irq(struct irq_data *d)\r\n{\r\nif (d->irq != SGI_MAP_0_IRQ)\r\nsgint->imask0 |= (1 << (d->irq - SGINT_LOCAL0));\r\n}\r\nstatic void disable_local0_irq(struct irq_data *d)\r\n{\r\nsgint->imask0 &= ~(1 << (d->irq - SGINT_LOCAL0));\r\n}\r\nstatic void enable_local1_irq(struct irq_data *d)\r\n{\r\nif (d->irq != SGI_MAP_1_IRQ)\r\nsgint->imask1 |= (1 << (d->irq - SGINT_LOCAL1));\r\n}\r\nstatic void disable_local1_irq(struct irq_data *d)\r\n{\r\nsgint->imask1 &= ~(1 << (d->irq - SGINT_LOCAL1));\r\n}\r\nstatic void enable_local2_irq(struct irq_data *d)\r\n{\r\nsgint->imask0 |= (1 << (SGI_MAP_0_IRQ - SGINT_LOCAL0));\r\nsgint->cmeimask0 |= (1 << (d->irq - SGINT_LOCAL2));\r\n}\r\nstatic void disable_local2_irq(struct irq_data *d)\r\n{\r\nsgint->cmeimask0 &= ~(1 << (d->irq - SGINT_LOCAL2));\r\nif (!sgint->cmeimask0)\r\nsgint->imask0 &= ~(1 << (SGI_MAP_0_IRQ - SGINT_LOCAL0));\r\n}\r\nstatic void enable_local3_irq(struct irq_data *d)\r\n{\r\nsgint->imask1 |= (1 << (SGI_MAP_1_IRQ - SGINT_LOCAL1));\r\nsgint->cmeimask1 |= (1 << (d->irq - SGINT_LOCAL3));\r\n}\r\nstatic void disable_local3_irq(struct irq_data *d)\r\n{\r\nsgint->cmeimask1 &= ~(1 << (d->irq - SGINT_LOCAL3));\r\nif (!sgint->cmeimask1)\r\nsgint->imask1 &= ~(1 << (SGI_MAP_1_IRQ - SGINT_LOCAL1));\r\n}\r\nstatic void indy_local0_irqdispatch(void)\r\n{\r\nu8 mask = sgint->istat0 & sgint->imask0;\r\nu8 mask2;\r\nint irq;\r\nif (mask & SGINT_ISTAT0_LIO2) {\r\nmask2 = sgint->vmeistat & sgint->cmeimask0;\r\nirq = lc2msk_to_irqnr[mask2];\r\n} else\r\nirq = lc0msk_to_irqnr[mask];\r\nif (irq)\r\ndo_IRQ(irq);\r\n}\r\nstatic void indy_local1_irqdispatch(void)\r\n{\r\nu8 mask = sgint->istat1 & sgint->imask1;\r\nu8 mask2;\r\nint irq;\r\nif (mask & SGINT_ISTAT1_LIO3) {\r\nmask2 = sgint->vmeistat & sgint->cmeimask1;\r\nirq = lc3msk_to_irqnr[mask2];\r\n} else\r\nirq = lc1msk_to_irqnr[mask];\r\nif (irq)\r\ndo_IRQ(irq);\r\n}\r\nstatic void __irq_entry indy_buserror_irq(void)\r\n{\r\nint irq = SGI_BUSERR_IRQ;\r\nirq_enter();\r\nkstat_incr_irqs_this_cpu(irq, irq_to_desc(irq));\r\nip22_be_interrupt(irq);\r\nirq_exit();\r\n}\r\nasmlinkage void plat_irq_dispatch(void)\r\n{\r\nunsigned int pending = read_c0_status() & read_c0_cause();\r\nif (pending & CAUSEF_IP7)\r\ndo_IRQ(SGI_TIMER_IRQ);\r\nelse if (pending & CAUSEF_IP2)\r\nindy_local0_irqdispatch();\r\nelse if (pending & CAUSEF_IP3)\r\nindy_local1_irqdispatch();\r\nelse if (pending & CAUSEF_IP6)\r\nindy_buserror_irq();\r\nelse if (pending & (CAUSEF_IP4 | CAUSEF_IP5))\r\nindy_8254timer_irq();\r\n}\r\nvoid __init arch_init_irq(void)\r\n{\r\nint i;\r\nfor (i = 0; i < 256; i++) {\r\nif (i & 0x80) {\r\nlc0msk_to_irqnr[i] = SGINT_LOCAL0 + 7;\r\nlc1msk_to_irqnr[i] = SGINT_LOCAL1 + 7;\r\nlc2msk_to_irqnr[i] = SGINT_LOCAL2 + 7;\r\nlc3msk_to_irqnr[i] = SGINT_LOCAL3 + 7;\r\n} else if (i & 0x40) {\r\nlc0msk_to_irqnr[i] = SGINT_LOCAL0 + 6;\r\nlc1msk_to_irqnr[i] = SGINT_LOCAL1 + 6;\r\nlc2msk_to_irqnr[i] = SGINT_LOCAL2 + 6;\r\nlc3msk_to_irqnr[i] = SGINT_LOCAL3 + 6;\r\n} else if (i & 0x20) {\r\nlc0msk_to_irqnr[i] = SGINT_LOCAL0 + 5;\r\nlc1msk_to_irqnr[i] = SGINT_LOCAL1 + 5;\r\nlc2msk_to_irqnr[i] = SGINT_LOCAL2 + 5;\r\nlc3msk_to_irqnr[i] = SGINT_LOCAL3 + 5;\r\n} else if (i & 0x10) {\r\nlc0msk_to_irqnr[i] = SGINT_LOCAL0 + 4;\r\nlc1msk_to_irqnr[i] = SGINT_LOCAL1 + 4;\r\nlc2msk_to_irqnr[i] = SGINT_LOCAL2 + 4;\r\nlc3msk_to_irqnr[i] = SGINT_LOCAL3 + 4;\r\n} else if (i & 0x08) {\r\nlc0msk_to_irqnr[i] = SGINT_LOCAL0 + 3;\r\nlc1msk_to_irqnr[i] = SGINT_LOCAL1 + 3;\r\nlc2msk_to_irqnr[i] = SGINT_LOCAL2 + 3;\r\nlc3msk_to_irqnr[i] = SGINT_LOCAL3 + 3;\r\n} else if (i & 0x04) {\r\nlc0msk_to_irqnr[i] = SGINT_LOCAL0 + 2;\r\nlc1msk_to_irqnr[i] = SGINT_LOCAL1 + 2;\r\nlc2msk_to_irqnr[i] = SGINT_LOCAL2 + 2;\r\nlc3msk_to_irqnr[i] = SGINT_LOCAL3 + 2;\r\n} else if (i & 0x02) {\r\nlc0msk_to_irqnr[i] = SGINT_LOCAL0 + 1;\r\nlc1msk_to_irqnr[i] = SGINT_LOCAL1 + 1;\r\nlc2msk_to_irqnr[i] = SGINT_LOCAL2 + 1;\r\nlc3msk_to_irqnr[i] = SGINT_LOCAL3 + 1;\r\n} else if (i & 0x01) {\r\nlc0msk_to_irqnr[i] = SGINT_LOCAL0 + 0;\r\nlc1msk_to_irqnr[i] = SGINT_LOCAL1 + 0;\r\nlc2msk_to_irqnr[i] = SGINT_LOCAL2 + 0;\r\nlc3msk_to_irqnr[i] = SGINT_LOCAL3 + 0;\r\n} else {\r\nlc0msk_to_irqnr[i] = 0;\r\nlc1msk_to_irqnr[i] = 0;\r\nlc2msk_to_irqnr[i] = 0;\r\nlc3msk_to_irqnr[i] = 0;\r\n}\r\n}\r\nsgint->imask0 = 0;\r\nsgint->imask1 = 0;\r\nsgint->cmeimask0 = 0;\r\nsgint->cmeimask1 = 0;\r\nmips_cpu_irq_init();\r\nfor (i = SGINT_LOCAL0; i < SGI_INTERRUPTS; i++) {\r\nstruct irq_chip *handler;\r\nif (i < SGINT_LOCAL1)\r\nhandler = &ip22_local0_irq_type;\r\nelse if (i < SGINT_LOCAL2)\r\nhandler = &ip22_local1_irq_type;\r\nelse if (i < SGINT_LOCAL3)\r\nhandler = &ip22_local2_irq_type;\r\nelse\r\nhandler = &ip22_local3_irq_type;\r\nirq_set_chip_and_handler(i, handler, handle_level_irq);\r\n}\r\nsetup_irq(SGI_LOCAL_0_IRQ, &local0_cascade);\r\nsetup_irq(SGI_LOCAL_1_IRQ, &local1_cascade);\r\nsetup_irq(SGI_BUSERR_IRQ, &buserr);\r\nsetup_irq(SGI_MAP_0_IRQ, &map0_cascade);\r\n#ifdef USE_LIO3_IRQ\r\nsetup_irq(SGI_MAP_1_IRQ, &map1_cascade);\r\n#endif\r\n#ifdef CONFIG_EISA\r\nif (ip22_is_fullhouse())\r\nip22_eisa_init();\r\n#endif\r\n}

u32 omap4_prm_read_inst_reg(s16 inst, u16 reg)\r\n{\r\nreturn __raw_readl(prm_base + inst + reg);\r\n}\r\nvoid omap4_prm_write_inst_reg(u32 val, s16 inst, u16 reg)\r\n{\r\n__raw_writel(val, prm_base + inst + reg);\r\n}\r\nu32 omap4_prm_rmw_inst_reg_bits(u32 mask, u32 bits, s16 inst, s16 reg)\r\n{\r\nu32 v;\r\nv = omap4_prm_read_inst_reg(inst, reg);\r\nv &= ~mask;\r\nv |= bits;\r\nomap4_prm_write_inst_reg(v, inst, reg);\r\nreturn v;\r\n}\r\nu32 omap4_prm_vp_check_txdone(u8 vp_id)\r\n{\r\nstruct omap4_vp *vp = &omap4_vp[vp_id];\r\nu32 irqstatus;\r\nirqstatus = omap4_prminst_read_inst_reg(OMAP4430_PRM_PARTITION,\r\nOMAP4430_PRM_OCP_SOCKET_INST,\r\nvp->irqstatus_mpu);\r\nreturn irqstatus & vp->tranxdone_status;\r\n}\r\nvoid omap4_prm_vp_clear_txdone(u8 vp_id)\r\n{\r\nstruct omap4_vp *vp = &omap4_vp[vp_id];\r\nomap4_prminst_write_inst_reg(vp->tranxdone_status,\r\nOMAP4430_PRM_PARTITION,\r\nOMAP4430_PRM_OCP_SOCKET_INST,\r\nvp->irqstatus_mpu);\r\n}\r\nu32 omap4_prm_vcvp_read(u8 offset)\r\n{\r\nreturn omap4_prminst_read_inst_reg(OMAP4430_PRM_PARTITION,\r\nOMAP4430_PRM_DEVICE_INST, offset);\r\n}\r\nvoid omap4_prm_vcvp_write(u32 val, u8 offset)\r\n{\r\nomap4_prminst_write_inst_reg(val, OMAP4430_PRM_PARTITION,\r\nOMAP4430_PRM_DEVICE_INST, offset);\r\n}\r\nu32 omap4_prm_vcvp_rmw(u32 mask, u32 bits, u8 offset)\r\n{\r\nreturn omap4_prminst_rmw_inst_reg_bits(mask, bits,\r\nOMAP4430_PRM_PARTITION,\r\nOMAP4430_PRM_DEVICE_INST,\r\noffset);\r\n}\r\nstatic inline u32 _read_pending_irq_reg(u16 irqen_offs, u16 irqst_offs)\r\n{\r\nu32 mask, st;\r\nmask = omap4_prm_read_inst_reg(OMAP4430_PRM_OCP_SOCKET_INST,\r\nirqen_offs);\r\nst = omap4_prm_read_inst_reg(OMAP4430_PRM_OCP_SOCKET_INST, irqst_offs);\r\nreturn mask & st;\r\n}\r\nvoid omap44xx_prm_read_pending_irqs(unsigned long *events)\r\n{\r\nevents[0] = _read_pending_irq_reg(OMAP4_PRM_IRQENABLE_MPU_OFFSET,\r\nOMAP4_PRM_IRQSTATUS_MPU_OFFSET);\r\nevents[1] = _read_pending_irq_reg(OMAP4_PRM_IRQENABLE_MPU_2_OFFSET,\r\nOMAP4_PRM_IRQSTATUS_MPU_2_OFFSET);\r\n}\r\nvoid omap44xx_prm_ocp_barrier(void)\r\n{\r\nomap4_prm_read_inst_reg(OMAP4430_PRM_OCP_SOCKET_INST,\r\nOMAP4_REVISION_PRM_OFFSET);\r\n}\r\nvoid omap44xx_prm_save_and_clear_irqen(u32 *saved_mask)\r\n{\r\nsaved_mask[0] =\r\nomap4_prm_read_inst_reg(OMAP4430_PRM_OCP_SOCKET_INST,\r\nOMAP4_PRM_IRQSTATUS_MPU_OFFSET);\r\nsaved_mask[1] =\r\nomap4_prm_read_inst_reg(OMAP4430_PRM_OCP_SOCKET_INST,\r\nOMAP4_PRM_IRQSTATUS_MPU_2_OFFSET);\r\nomap4_prm_write_inst_reg(0, OMAP4430_PRM_OCP_SOCKET_INST,\r\nOMAP4_PRM_IRQENABLE_MPU_OFFSET);\r\nomap4_prm_write_inst_reg(0, OMAP4430_PRM_OCP_SOCKET_INST,\r\nOMAP4_PRM_IRQENABLE_MPU_2_OFFSET);\r\nomap4_prm_read_inst_reg(OMAP4430_PRM_OCP_SOCKET_INST,\r\nOMAP4_REVISION_PRM_OFFSET);\r\n}\r\nvoid omap44xx_prm_restore_irqen(u32 *saved_mask)\r\n{\r\nomap4_prm_write_inst_reg(saved_mask[0], OMAP4430_PRM_OCP_SOCKET_INST,\r\nOMAP4_PRM_IRQENABLE_MPU_OFFSET);\r\nomap4_prm_write_inst_reg(saved_mask[1], OMAP4430_PRM_OCP_SOCKET_INST,\r\nOMAP4_PRM_IRQENABLE_MPU_2_OFFSET);\r\n}\r\nvoid omap44xx_prm_reconfigure_io_chain(void)\r\n{\r\nint i = 0;\r\nomap4_prm_rmw_inst_reg_bits(OMAP4430_WUCLK_CTRL_MASK,\r\nOMAP4430_WUCLK_CTRL_MASK,\r\nOMAP4430_PRM_DEVICE_INST,\r\nOMAP4_PRM_IO_PMCTRL_OFFSET);\r\nomap_test_timeout(\r\n(((omap4_prm_read_inst_reg(OMAP4430_PRM_DEVICE_INST,\r\nOMAP4_PRM_IO_PMCTRL_OFFSET) &\r\nOMAP4430_WUCLK_STATUS_MASK) >>\r\nOMAP4430_WUCLK_STATUS_SHIFT) == 1),\r\nMAX_IOPAD_LATCH_TIME, i);\r\nif (i == MAX_IOPAD_LATCH_TIME)\r\npr_warn("PRM: I/O chain clock line assertion timed out\n");\r\nomap4_prm_rmw_inst_reg_bits(OMAP4430_WUCLK_CTRL_MASK, 0x0,\r\nOMAP4430_PRM_DEVICE_INST,\r\nOMAP4_PRM_IO_PMCTRL_OFFSET);\r\nomap_test_timeout(\r\n(((omap4_prm_read_inst_reg(OMAP4430_PRM_DEVICE_INST,\r\nOMAP4_PRM_IO_PMCTRL_OFFSET) &\r\nOMAP4430_WUCLK_STATUS_MASK) >>\r\nOMAP4430_WUCLK_STATUS_SHIFT) == 0),\r\nMAX_IOPAD_LATCH_TIME, i);\r\nif (i == MAX_IOPAD_LATCH_TIME)\r\npr_warn("PRM: I/O chain clock line deassertion timed out\n");\r\nreturn;\r\n}\r\nstatic void __init omap44xx_prm_enable_io_wakeup(void)\r\n{\r\nomap4_prm_rmw_inst_reg_bits(OMAP4430_GLOBAL_WUEN_MASK,\r\nOMAP4430_GLOBAL_WUEN_MASK,\r\nOMAP4430_PRM_DEVICE_INST,\r\nOMAP4_PRM_IO_PMCTRL_OFFSET);\r\n}\r\nstatic u32 omap44xx_prm_read_reset_sources(void)\r\n{\r\nstruct prm_reset_src_map *p;\r\nu32 r = 0;\r\nu32 v;\r\nv = omap4_prm_read_inst_reg(OMAP4430_PRM_DEVICE_INST,\r\nOMAP4_RM_RSTST);\r\np = omap44xx_prm_reset_src_map;\r\nwhile (p->reg_shift >= 0 && p->std_shift >= 0) {\r\nif (v & (1 << p->reg_shift))\r\nr |= 1 << p->std_shift;\r\np++;\r\n}\r\nreturn r;\r\n}\r\nstatic bool omap44xx_prm_was_any_context_lost_old(u8 part, s16 inst, u16 idx)\r\n{\r\nreturn (omap4_prminst_read_inst_reg(part, inst, idx)) ? 1 : 0;\r\n}\r\nstatic void omap44xx_prm_clear_context_loss_flags_old(u8 part, s16 inst,\r\nu16 idx)\r\n{\r\nomap4_prminst_write_inst_reg(0xffffffff, part, inst, idx);\r\n}\r\nstatic int omap4_pwrdm_set_next_pwrst(struct powerdomain *pwrdm, u8 pwrst)\r\n{\r\nomap4_prminst_rmw_inst_reg_bits(OMAP_POWERSTATE_MASK,\r\n(pwrst << OMAP_POWERSTATE_SHIFT),\r\npwrdm->prcm_partition,\r\npwrdm->prcm_offs, OMAP4_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic int omap4_pwrdm_read_next_pwrst(struct powerdomain *pwrdm)\r\n{\r\nu32 v;\r\nv = omap4_prminst_read_inst_reg(pwrdm->prcm_partition, pwrdm->prcm_offs,\r\nOMAP4_PM_PWSTCTRL);\r\nv &= OMAP_POWERSTATE_MASK;\r\nv >>= OMAP_POWERSTATE_SHIFT;\r\nreturn v;\r\n}\r\nstatic int omap4_pwrdm_read_pwrst(struct powerdomain *pwrdm)\r\n{\r\nu32 v;\r\nv = omap4_prminst_read_inst_reg(pwrdm->prcm_partition, pwrdm->prcm_offs,\r\nOMAP4_PM_PWSTST);\r\nv &= OMAP_POWERSTATEST_MASK;\r\nv >>= OMAP_POWERSTATEST_SHIFT;\r\nreturn v;\r\n}\r\nstatic int omap4_pwrdm_read_prev_pwrst(struct powerdomain *pwrdm)\r\n{\r\nu32 v;\r\nv = omap4_prminst_read_inst_reg(pwrdm->prcm_partition, pwrdm->prcm_offs,\r\nOMAP4_PM_PWSTST);\r\nv &= OMAP4430_LASTPOWERSTATEENTERED_MASK;\r\nv >>= OMAP4430_LASTPOWERSTATEENTERED_SHIFT;\r\nreturn v;\r\n}\r\nstatic int omap4_pwrdm_set_lowpwrstchange(struct powerdomain *pwrdm)\r\n{\r\nomap4_prminst_rmw_inst_reg_bits(OMAP4430_LOWPOWERSTATECHANGE_MASK,\r\n(1 << OMAP4430_LOWPOWERSTATECHANGE_SHIFT),\r\npwrdm->prcm_partition,\r\npwrdm->prcm_offs, OMAP4_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic int omap4_pwrdm_clear_all_prev_pwrst(struct powerdomain *pwrdm)\r\n{\r\nomap4_prminst_rmw_inst_reg_bits(OMAP4430_LASTPOWERSTATEENTERED_MASK,\r\nOMAP4430_LASTPOWERSTATEENTERED_MASK,\r\npwrdm->prcm_partition,\r\npwrdm->prcm_offs, OMAP4_PM_PWSTST);\r\nreturn 0;\r\n}\r\nstatic int omap4_pwrdm_set_logic_retst(struct powerdomain *pwrdm, u8 pwrst)\r\n{\r\nu32 v;\r\nv = pwrst << __ffs(OMAP4430_LOGICRETSTATE_MASK);\r\nomap4_prminst_rmw_inst_reg_bits(OMAP4430_LOGICRETSTATE_MASK, v,\r\npwrdm->prcm_partition, pwrdm->prcm_offs,\r\nOMAP4_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic int omap4_pwrdm_set_mem_onst(struct powerdomain *pwrdm, u8 bank,\r\nu8 pwrst)\r\n{\r\nu32 m;\r\nm = omap2_pwrdm_get_mem_bank_onstate_mask(bank);\r\nomap4_prminst_rmw_inst_reg_bits(m, (pwrst << __ffs(m)),\r\npwrdm->prcm_partition, pwrdm->prcm_offs,\r\nOMAP4_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic int omap4_pwrdm_set_mem_retst(struct powerdomain *pwrdm, u8 bank,\r\nu8 pwrst)\r\n{\r\nu32 m;\r\nm = omap2_pwrdm_get_mem_bank_retst_mask(bank);\r\nomap4_prminst_rmw_inst_reg_bits(m, (pwrst << __ffs(m)),\r\npwrdm->prcm_partition, pwrdm->prcm_offs,\r\nOMAP4_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic int omap4_pwrdm_read_logic_pwrst(struct powerdomain *pwrdm)\r\n{\r\nu32 v;\r\nv = omap4_prminst_read_inst_reg(pwrdm->prcm_partition, pwrdm->prcm_offs,\r\nOMAP4_PM_PWSTST);\r\nv &= OMAP4430_LOGICSTATEST_MASK;\r\nv >>= OMAP4430_LOGICSTATEST_SHIFT;\r\nreturn v;\r\n}\r\nstatic int omap4_pwrdm_read_logic_retst(struct powerdomain *pwrdm)\r\n{\r\nu32 v;\r\nv = omap4_prminst_read_inst_reg(pwrdm->prcm_partition, pwrdm->prcm_offs,\r\nOMAP4_PM_PWSTCTRL);\r\nv &= OMAP4430_LOGICRETSTATE_MASK;\r\nv >>= OMAP4430_LOGICRETSTATE_SHIFT;\r\nreturn v;\r\n}\r\nstatic int omap4_pwrdm_read_prev_logic_pwrst(struct powerdomain *pwrdm)\r\n{\r\nint state;\r\nstate = omap4_pwrdm_read_prev_pwrst(pwrdm);\r\nif (state == PWRDM_POWER_OFF)\r\nreturn PWRDM_POWER_OFF;\r\nif (state != PWRDM_POWER_RET)\r\nreturn PWRDM_POWER_RET;\r\nreturn omap4_pwrdm_read_logic_retst(pwrdm);\r\n}\r\nstatic int omap4_pwrdm_read_mem_pwrst(struct powerdomain *pwrdm, u8 bank)\r\n{\r\nu32 m, v;\r\nm = omap2_pwrdm_get_mem_bank_stst_mask(bank);\r\nv = omap4_prminst_read_inst_reg(pwrdm->prcm_partition, pwrdm->prcm_offs,\r\nOMAP4_PM_PWSTST);\r\nv &= m;\r\nv >>= __ffs(m);\r\nreturn v;\r\n}\r\nstatic int omap4_pwrdm_read_mem_retst(struct powerdomain *pwrdm, u8 bank)\r\n{\r\nu32 m, v;\r\nm = omap2_pwrdm_get_mem_bank_retst_mask(bank);\r\nv = omap4_prminst_read_inst_reg(pwrdm->prcm_partition, pwrdm->prcm_offs,\r\nOMAP4_PM_PWSTCTRL);\r\nv &= m;\r\nv >>= __ffs(m);\r\nreturn v;\r\n}\r\nstatic int omap4_pwrdm_read_prev_mem_pwrst(struct powerdomain *pwrdm, u8 bank)\r\n{\r\nint state;\r\nstate = omap4_pwrdm_read_prev_pwrst(pwrdm);\r\nif (state == PWRDM_POWER_OFF)\r\nreturn PWRDM_POWER_OFF;\r\nif (state != PWRDM_POWER_RET)\r\nreturn PWRDM_POWER_RET;\r\nreturn omap4_pwrdm_read_mem_retst(pwrdm, bank);\r\n}\r\nstatic int omap4_pwrdm_wait_transition(struct powerdomain *pwrdm)\r\n{\r\nu32 c = 0;\r\nwhile ((omap4_prminst_read_inst_reg(pwrdm->prcm_partition,\r\npwrdm->prcm_offs,\r\nOMAP4_PM_PWSTST) &\r\nOMAP_INTRANSITION_MASK) &&\r\n(c++ < PWRDM_TRANSITION_BAILOUT))\r\nudelay(1);\r\nif (c > PWRDM_TRANSITION_BAILOUT) {\r\npr_err("powerdomain: %s: waited too long to complete transition\n",\r\npwrdm->name);\r\nreturn -EAGAIN;\r\n}\r\npr_debug("powerdomain: completed transition in %d loops\n", c);\r\nreturn 0;\r\n}\r\nstatic int omap4_check_vcvp(void)\r\n{\r\nif (soc_is_dra7xx())\r\nreturn 0;\r\nreturn 1;\r\n}\r\nint __init omap44xx_prm_init(void)\r\n{\r\nif (!cpu_is_omap44xx() && !soc_is_omap54xx() && !soc_is_dra7xx())\r\nreturn 0;\r\nreturn prm_register(&omap44xx_prm_ll_data);\r\n}\r\nstatic int __init omap44xx_prm_late_init(void)\r\n{\r\nif (!cpu_is_omap44xx())\r\nreturn 0;\r\nomap44xx_prm_enable_io_wakeup();\r\nreturn omap_prcm_register_chain_handler(&omap4_prcm_irq_setup);\r\n}\r\nstatic void __exit omap44xx_prm_exit(void)\r\n{\r\nif (!cpu_is_omap44xx())\r\nreturn;\r\nWARN(prm_unregister(&omap44xx_prm_ll_data),\r\n"%s: prm_ll_data function pointer mismatch\n", __func__);\r\n}

static int snirm710_probe(struct platform_device *dev)\r\n{\r\nunsigned long base;\r\nstruct NCR_700_Host_Parameters *hostdata;\r\nstruct Scsi_Host *host;\r\nstruct resource *res;\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\nbase = res->start;\r\nhostdata = kzalloc(sizeof(*hostdata), GFP_KERNEL);\r\nif (!hostdata) {\r\ndev_printk(KERN_ERR, dev, "Failed to allocate host data\n");\r\nreturn -ENOMEM;\r\n}\r\nhostdata->dev = &dev->dev;\r\ndma_set_mask(&dev->dev, DMA_BIT_MASK(32));\r\nhostdata->base = ioremap_nocache(base, 0x100);\r\nhostdata->differential = 0;\r\nhostdata->clock = SNIRM710_CLOCK;\r\nhostdata->force_le_on_be = 1;\r\nhostdata->chip710 = 1;\r\nhostdata->burst_length = 4;\r\nhost = NCR_700_detect(&snirm710_template, hostdata, &dev->dev);\r\nif (!host)\r\ngoto out_kfree;\r\nhost->this_id = 7;\r\nhost->base = base;\r\nhost->irq = platform_get_irq(dev, 0);\r\nif(request_irq(host->irq, NCR_700_intr, IRQF_SHARED, "snirm710", host)) {\r\nprintk(KERN_ERR "snirm710: request_irq failed!\n");\r\ngoto out_put_host;\r\n}\r\ndev_set_drvdata(&dev->dev, host);\r\nscsi_scan_host(host);\r\nreturn 0;\r\nout_put_host:\r\nscsi_host_put(host);\r\nout_kfree:\r\niounmap(hostdata->base);\r\nkfree(hostdata);\r\nreturn -ENODEV;\r\n}\r\nstatic int __exit snirm710_driver_remove(struct platform_device *dev)\r\n{\r\nstruct Scsi_Host *host = dev_get_drvdata(&dev->dev);\r\nstruct NCR_700_Host_Parameters *hostdata =\r\n(struct NCR_700_Host_Parameters *)host->hostdata[0];\r\nscsi_remove_host(host);\r\nNCR_700_release(host);\r\nfree_irq(host->irq, host);\r\niounmap(hostdata->base);\r\nkfree(hostdata);\r\nreturn 0;\r\n}\r\nstatic int __init snirm710_init(void)\r\n{\r\nreturn platform_driver_register(&snirm710_driver);\r\n}\r\nstatic void __exit snirm710_exit(void)\r\n{\r\nplatform_driver_unregister(&snirm710_driver);\r\n}

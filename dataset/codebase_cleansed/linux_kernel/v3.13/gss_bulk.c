int gss_cli_ctx_wrap_bulk(struct ptlrpc_cli_ctx *ctx,\r\nstruct ptlrpc_request *req,\r\nstruct ptlrpc_bulk_desc *desc)\r\n{\r\nstruct gss_cli_ctx *gctx;\r\nstruct lustre_msg *msg;\r\nstruct ptlrpc_bulk_sec_desc *bsd;\r\nrawobj_t token;\r\n__u32 maj;\r\nint offset;\r\nint rc;\r\nLASSERT(req->rq_pack_bulk);\r\nLASSERT(req->rq_bulk_read || req->rq_bulk_write);\r\ngctx = container_of(ctx, struct gss_cli_ctx, gc_base);\r\nLASSERT(gctx->gc_mechctx);\r\nswitch (SPTLRPC_FLVR_SVC(req->rq_flvr.sf_rpc)) {\r\ncase SPTLRPC_SVC_NULL:\r\nLASSERT(req->rq_reqbuf->lm_bufcount >= 3);\r\nmsg = req->rq_reqbuf;\r\noffset = msg->lm_bufcount - 1;\r\nbreak;\r\ncase SPTLRPC_SVC_AUTH:\r\ncase SPTLRPC_SVC_INTG:\r\nLASSERT(req->rq_reqbuf->lm_bufcount >= 4);\r\nmsg = req->rq_reqbuf;\r\noffset = msg->lm_bufcount - 2;\r\nbreak;\r\ncase SPTLRPC_SVC_PRIV:\r\nLASSERT(req->rq_clrbuf->lm_bufcount >= 2);\r\nmsg = req->rq_clrbuf;\r\noffset = msg->lm_bufcount - 1;\r\nbreak;\r\ndefault:\r\nLBUG();\r\n}\r\nbsd = lustre_msg_buf(msg, offset, sizeof(*bsd));\r\nbsd->bsd_version = 0;\r\nbsd->bsd_flags = 0;\r\nbsd->bsd_type = SPTLRPC_BULK_DEFAULT;\r\nbsd->bsd_svc = SPTLRPC_FLVR_BULK_SVC(req->rq_flvr.sf_rpc);\r\nif (bsd->bsd_svc == SPTLRPC_BULK_SVC_NULL)\r\nreturn 0;\r\nLASSERT(bsd->bsd_svc == SPTLRPC_BULK_SVC_INTG ||\r\nbsd->bsd_svc == SPTLRPC_BULK_SVC_PRIV);\r\nif (req->rq_bulk_read) {\r\nif (bsd->bsd_svc == SPTLRPC_BULK_SVC_PRIV)\r\nreturn gss_cli_prep_bulk(req, desc);\r\n} else {\r\nbsd->bsd_nob = desc->bd_nob;\r\nif (bsd->bsd_svc == SPTLRPC_BULK_SVC_INTG) {\r\ntoken.data = bsd->bsd_data;\r\ntoken.len = lustre_msg_buflen(msg, offset) -\r\nsizeof(*bsd);\r\nmaj = lgss_get_mic(gctx->gc_mechctx, 0, NULL,\r\ndesc->bd_iov_count, desc->bd_iov,\r\n&token);\r\nif (maj != GSS_S_COMPLETE) {\r\nCWARN("failed to sign bulk data: %x\n", maj);\r\nreturn -EACCES;\r\n}\r\n} else {\r\nif (desc->bd_iov_count == 0)\r\nreturn 0;\r\nrc = sptlrpc_enc_pool_get_pages(desc);\r\nif (rc) {\r\nCERROR("bulk write: failed to allocate "\r\n"encryption pages: %d\n", rc);\r\nreturn rc;\r\n}\r\ntoken.data = bsd->bsd_data;\r\ntoken.len = lustre_msg_buflen(msg, offset) -\r\nsizeof(*bsd);\r\nmaj = lgss_wrap_bulk(gctx->gc_mechctx, desc, &token, 0);\r\nif (maj != GSS_S_COMPLETE) {\r\nCWARN("fail to encrypt bulk data: %x\n", maj);\r\nreturn -EACCES;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint gss_cli_ctx_unwrap_bulk(struct ptlrpc_cli_ctx *ctx,\r\nstruct ptlrpc_request *req,\r\nstruct ptlrpc_bulk_desc *desc)\r\n{\r\nstruct gss_cli_ctx *gctx;\r\nstruct lustre_msg *rmsg, *vmsg;\r\nstruct ptlrpc_bulk_sec_desc *bsdr, *bsdv;\r\nrawobj_t token;\r\n__u32 maj;\r\nint roff, voff;\r\nLASSERT(req->rq_pack_bulk);\r\nLASSERT(req->rq_bulk_read || req->rq_bulk_write);\r\nswitch (SPTLRPC_FLVR_SVC(req->rq_flvr.sf_rpc)) {\r\ncase SPTLRPC_SVC_NULL:\r\nvmsg = req->rq_repdata;\r\nvoff = vmsg->lm_bufcount - 1;\r\nLASSERT(vmsg && vmsg->lm_bufcount >= 3);\r\nrmsg = req->rq_reqbuf;\r\nroff = rmsg->lm_bufcount - 1;\r\nLASSERT(rmsg && rmsg->lm_bufcount >= 3);\r\nbreak;\r\ncase SPTLRPC_SVC_AUTH:\r\ncase SPTLRPC_SVC_INTG:\r\nvmsg = req->rq_repdata;\r\nvoff = vmsg->lm_bufcount - 2;\r\nLASSERT(vmsg && vmsg->lm_bufcount >= 4);\r\nrmsg = req->rq_reqbuf;\r\nroff = rmsg->lm_bufcount - 2;\r\nLASSERT(rmsg && rmsg->lm_bufcount >= 4);\r\nbreak;\r\ncase SPTLRPC_SVC_PRIV:\r\nvmsg = req->rq_repdata;\r\nvoff = vmsg->lm_bufcount - 1;\r\nLASSERT(vmsg && vmsg->lm_bufcount >= 2);\r\nrmsg = req->rq_clrbuf;\r\nroff = rmsg->lm_bufcount - 1;\r\nLASSERT(rmsg && rmsg->lm_bufcount >= 2);\r\nbreak;\r\ndefault:\r\nLBUG();\r\n}\r\nbsdr = lustre_msg_buf(rmsg, roff, sizeof(*bsdr));\r\nbsdv = lustre_msg_buf(vmsg, voff, sizeof(*bsdv));\r\nLASSERT(bsdr && bsdv);\r\nif (bsdr->bsd_version != bsdv->bsd_version ||\r\nbsdr->bsd_type != bsdv->bsd_type ||\r\nbsdr->bsd_svc != bsdv->bsd_svc) {\r\nCERROR("bulk security descriptor mismatch: "\r\n"(%u,%u,%u) != (%u,%u,%u)\n",\r\nbsdr->bsd_version, bsdr->bsd_type, bsdr->bsd_svc,\r\nbsdv->bsd_version, bsdv->bsd_type, bsdv->bsd_svc);\r\nreturn -EPROTO;\r\n}\r\nLASSERT(bsdv->bsd_svc == SPTLRPC_BULK_SVC_NULL ||\r\nbsdv->bsd_svc == SPTLRPC_BULK_SVC_INTG ||\r\nbsdv->bsd_svc == SPTLRPC_BULK_SVC_PRIV);\r\nif (req->rq_bulk_write) {\r\nif (bsdv->bsd_flags & BSD_FL_ERR) {\r\nCERROR("server reported bulk i/o failure\n");\r\nreturn -EIO;\r\n}\r\nif (bsdv->bsd_svc == SPTLRPC_BULK_SVC_PRIV)\r\ndesc->bd_nob_transferred = desc->bd_nob;\r\n} else {\r\ngctx = container_of(ctx, struct gss_cli_ctx, gc_base);\r\nLASSERT(gctx->gc_mechctx);\r\nif (bsdv->bsd_svc == SPTLRPC_BULK_SVC_INTG) {\r\nint i, nob;\r\nfor (i = 0, nob = 0; i < desc->bd_iov_count; i++) {\r\nif (desc->bd_iov[i].kiov_len + nob >\r\ndesc->bd_nob_transferred) {\r\ndesc->bd_iov[i].kiov_len =\r\ndesc->bd_nob_transferred - nob;\r\n}\r\nnob += desc->bd_iov[i].kiov_len;\r\n}\r\ntoken.data = bsdv->bsd_data;\r\ntoken.len = lustre_msg_buflen(vmsg, voff) -\r\nsizeof(*bsdv);\r\nmaj = lgss_verify_mic(gctx->gc_mechctx, 0, NULL,\r\ndesc->bd_iov_count, desc->bd_iov,\r\n&token);\r\nif (maj != GSS_S_COMPLETE) {\r\nCERROR("failed to verify bulk read: %x\n", maj);\r\nreturn -EACCES;\r\n}\r\n} else if (bsdv->bsd_svc == SPTLRPC_BULK_SVC_PRIV) {\r\ndesc->bd_nob = bsdv->bsd_nob;\r\nif (desc->bd_nob == 0)\r\nreturn 0;\r\ntoken.data = bsdv->bsd_data;\r\ntoken.len = lustre_msg_buflen(vmsg, voff) -\r\nsizeof(*bsdr);\r\nmaj = lgss_unwrap_bulk(gctx->gc_mechctx, desc,\r\n&token, 1);\r\nif (maj != GSS_S_COMPLETE) {\r\nCERROR("failed to decrypt bulk read: %x\n",\r\nmaj);\r\nreturn -EACCES;\r\n}\r\ndesc->bd_nob_transferred = desc->bd_nob;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int gss_prep_bulk(struct ptlrpc_bulk_desc *desc,\r\nstruct gss_ctx *mechctx)\r\n{\r\nint rc;\r\nif (desc->bd_iov_count == 0)\r\nreturn 0;\r\nrc = sptlrpc_enc_pool_get_pages(desc);\r\nif (rc)\r\nreturn rc;\r\nif (lgss_prep_bulk(mechctx, desc) != GSS_S_COMPLETE)\r\nreturn -EACCES;\r\nreturn 0;\r\n}\r\nint gss_cli_prep_bulk(struct ptlrpc_request *req,\r\nstruct ptlrpc_bulk_desc *desc)\r\n{\r\nint rc;\r\nLASSERT(req->rq_cli_ctx);\r\nLASSERT(req->rq_pack_bulk);\r\nLASSERT(req->rq_bulk_read);\r\nif (SPTLRPC_FLVR_BULK_SVC(req->rq_flvr.sf_rpc) != SPTLRPC_BULK_SVC_PRIV)\r\nreturn 0;\r\nrc = gss_prep_bulk(desc, ctx2gctx(req->rq_cli_ctx)->gc_mechctx);\r\nif (rc)\r\nCERROR("bulk read: failed to prepare encryption "\r\n"pages: %d\n", rc);\r\nreturn rc;\r\n}\r\nint gss_svc_prep_bulk(struct ptlrpc_request *req,\r\nstruct ptlrpc_bulk_desc *desc)\r\n{\r\nstruct gss_svc_reqctx *grctx;\r\nstruct ptlrpc_bulk_sec_desc *bsd;\r\nint rc;\r\nLASSERT(req->rq_svc_ctx);\r\nLASSERT(req->rq_pack_bulk);\r\nLASSERT(req->rq_bulk_write);\r\ngrctx = gss_svc_ctx2reqctx(req->rq_svc_ctx);\r\nLASSERT(grctx->src_reqbsd);\r\nLASSERT(grctx->src_repbsd);\r\nLASSERT(grctx->src_ctx);\r\nLASSERT(grctx->src_ctx->gsc_mechctx);\r\nbsd = grctx->src_reqbsd;\r\nif (bsd->bsd_svc != SPTLRPC_BULK_SVC_PRIV)\r\nreturn 0;\r\nrc = gss_prep_bulk(desc, grctx->src_ctx->gsc_mechctx);\r\nif (rc)\r\nCERROR("bulk write: failed to prepare encryption "\r\n"pages: %d\n", rc);\r\nreturn rc;\r\n}\r\nint gss_svc_unwrap_bulk(struct ptlrpc_request *req,\r\nstruct ptlrpc_bulk_desc *desc)\r\n{\r\nstruct gss_svc_reqctx *grctx;\r\nstruct ptlrpc_bulk_sec_desc *bsdr, *bsdv;\r\nrawobj_t token;\r\n__u32 maj;\r\nLASSERT(req->rq_svc_ctx);\r\nLASSERT(req->rq_pack_bulk);\r\nLASSERT(req->rq_bulk_write);\r\ngrctx = gss_svc_ctx2reqctx(req->rq_svc_ctx);\r\nLASSERT(grctx->src_reqbsd);\r\nLASSERT(grctx->src_repbsd);\r\nLASSERT(grctx->src_ctx);\r\nLASSERT(grctx->src_ctx->gsc_mechctx);\r\nbsdr = grctx->src_reqbsd;\r\nbsdv = grctx->src_repbsd;\r\nbsdv->bsd_version = 0;\r\nbsdv->bsd_type = SPTLRPC_BULK_DEFAULT;\r\nbsdv->bsd_svc = bsdr->bsd_svc;\r\nbsdv->bsd_flags = 0;\r\nswitch (bsdv->bsd_svc) {\r\ncase SPTLRPC_BULK_SVC_INTG:\r\ntoken.data = bsdr->bsd_data;\r\ntoken.len = grctx->src_reqbsd_size - sizeof(*bsdr);\r\nmaj = lgss_verify_mic(grctx->src_ctx->gsc_mechctx, 0, NULL,\r\ndesc->bd_iov_count, desc->bd_iov, &token);\r\nif (maj != GSS_S_COMPLETE) {\r\nbsdv->bsd_flags |= BSD_FL_ERR;\r\nCERROR("failed to verify bulk signature: %x\n", maj);\r\nreturn -EACCES;\r\n}\r\nbreak;\r\ncase SPTLRPC_BULK_SVC_PRIV:\r\nif (bsdr->bsd_nob != desc->bd_nob) {\r\nbsdv->bsd_flags |= BSD_FL_ERR;\r\nCERROR("prepared nob %d doesn't match the actual "\r\n"nob %d\n", desc->bd_nob, bsdr->bsd_nob);\r\nreturn -EPROTO;\r\n}\r\nif (desc->bd_iov_count == 0) {\r\nLASSERT(desc->bd_nob == 0);\r\nbreak;\r\n}\r\ntoken.data = bsdr->bsd_data;\r\ntoken.len = grctx->src_reqbsd_size - sizeof(*bsdr);\r\nmaj = lgss_unwrap_bulk(grctx->src_ctx->gsc_mechctx,\r\ndesc, &token, 0);\r\nif (maj != GSS_S_COMPLETE) {\r\nbsdv->bsd_flags |= BSD_FL_ERR;\r\nCERROR("failed decrypt bulk data: %x\n", maj);\r\nreturn -EACCES;\r\n}\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nint gss_svc_wrap_bulk(struct ptlrpc_request *req,\r\nstruct ptlrpc_bulk_desc *desc)\r\n{\r\nstruct gss_svc_reqctx *grctx;\r\nstruct ptlrpc_bulk_sec_desc *bsdr, *bsdv;\r\nrawobj_t token;\r\n__u32 maj;\r\nint rc;\r\nLASSERT(req->rq_svc_ctx);\r\nLASSERT(req->rq_pack_bulk);\r\nLASSERT(req->rq_bulk_read);\r\ngrctx = gss_svc_ctx2reqctx(req->rq_svc_ctx);\r\nLASSERT(grctx->src_reqbsd);\r\nLASSERT(grctx->src_repbsd);\r\nLASSERT(grctx->src_ctx);\r\nLASSERT(grctx->src_ctx->gsc_mechctx);\r\nbsdr = grctx->src_reqbsd;\r\nbsdv = grctx->src_repbsd;\r\nbsdv->bsd_version = 0;\r\nbsdv->bsd_type = SPTLRPC_BULK_DEFAULT;\r\nbsdv->bsd_svc = bsdr->bsd_svc;\r\nbsdv->bsd_flags = 0;\r\nswitch (bsdv->bsd_svc) {\r\ncase SPTLRPC_BULK_SVC_INTG:\r\ntoken.data = bsdv->bsd_data;\r\ntoken.len = grctx->src_repbsd_size - sizeof(*bsdv);\r\nmaj = lgss_get_mic(grctx->src_ctx->gsc_mechctx, 0, NULL,\r\ndesc->bd_iov_count, desc->bd_iov, &token);\r\nif (maj != GSS_S_COMPLETE) {\r\nbsdv->bsd_flags |= BSD_FL_ERR;\r\nCERROR("failed to sign bulk data: %x\n", maj);\r\nreturn -EACCES;\r\n}\r\nbreak;\r\ncase SPTLRPC_BULK_SVC_PRIV:\r\nbsdv->bsd_nob = desc->bd_nob;\r\nif (desc->bd_iov_count == 0) {\r\nLASSERT(desc->bd_nob == 0);\r\nbreak;\r\n}\r\nrc = sptlrpc_enc_pool_get_pages(desc);\r\nif (rc) {\r\nbsdv->bsd_flags |= BSD_FL_ERR;\r\nCERROR("bulk read: failed to allocate encryption "\r\n"pages: %d\n", rc);\r\nreturn rc;\r\n}\r\ntoken.data = bsdv->bsd_data;\r\ntoken.len = grctx->src_repbsd_size - sizeof(*bsdv);\r\nmaj = lgss_wrap_bulk(grctx->src_ctx->gsc_mechctx,\r\ndesc, &token, 1);\r\nif (maj != GSS_S_COMPLETE) {\r\nbsdv->bsd_flags |= BSD_FL_ERR;\r\nCERROR("failed to encrypt bulk data: %x\n", maj);\r\nreturn -EACCES;\r\n}\r\nbreak;\r\n}\r\nreturn 0;\r\n}

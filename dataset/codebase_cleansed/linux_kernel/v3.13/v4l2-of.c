static void v4l2_of_parse_csi_bus(const struct device_node *node,\r\nstruct v4l2_of_endpoint *endpoint)\r\n{\r\nstruct v4l2_of_bus_mipi_csi2 *bus = &endpoint->bus.mipi_csi2;\r\nu32 data_lanes[ARRAY_SIZE(bus->data_lanes)];\r\nstruct property *prop;\r\nbool have_clk_lane = false;\r\nunsigned int flags = 0;\r\nu32 v;\r\nprop = of_find_property(node, "data-lanes", NULL);\r\nif (prop) {\r\nconst __be32 *lane = NULL;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(data_lanes); i++) {\r\nlane = of_prop_next_u32(prop, lane, &data_lanes[i]);\r\nif (!lane)\r\nbreak;\r\n}\r\nbus->num_data_lanes = i;\r\nwhile (i--)\r\nbus->data_lanes[i] = data_lanes[i];\r\n}\r\nif (!of_property_read_u32(node, "clock-lanes", &v)) {\r\nbus->clock_lane = v;\r\nhave_clk_lane = true;\r\n}\r\nif (of_get_property(node, "clock-noncontinuous", &v))\r\nflags |= V4L2_MBUS_CSI2_NONCONTINUOUS_CLOCK;\r\nelse if (have_clk_lane || bus->num_data_lanes > 0)\r\nflags |= V4L2_MBUS_CSI2_CONTINUOUS_CLOCK;\r\nbus->flags = flags;\r\nendpoint->bus_type = V4L2_MBUS_CSI2;\r\n}\r\nstatic void v4l2_of_parse_parallel_bus(const struct device_node *node,\r\nstruct v4l2_of_endpoint *endpoint)\r\n{\r\nstruct v4l2_of_bus_parallel *bus = &endpoint->bus.parallel;\r\nunsigned int flags = 0;\r\nu32 v;\r\nif (!of_property_read_u32(node, "hsync-active", &v))\r\nflags |= v ? V4L2_MBUS_HSYNC_ACTIVE_HIGH :\r\nV4L2_MBUS_HSYNC_ACTIVE_LOW;\r\nif (!of_property_read_u32(node, "vsync-active", &v))\r\nflags |= v ? V4L2_MBUS_VSYNC_ACTIVE_HIGH :\r\nV4L2_MBUS_VSYNC_ACTIVE_LOW;\r\nif (!of_property_read_u32(node, "pclk-sample", &v))\r\nflags |= v ? V4L2_MBUS_PCLK_SAMPLE_RISING :\r\nV4L2_MBUS_PCLK_SAMPLE_FALLING;\r\nif (!of_property_read_u32(node, "field-even-active", &v))\r\nflags |= v ? V4L2_MBUS_FIELD_EVEN_HIGH :\r\nV4L2_MBUS_FIELD_EVEN_LOW;\r\nif (flags)\r\nendpoint->bus_type = V4L2_MBUS_PARALLEL;\r\nelse\r\nendpoint->bus_type = V4L2_MBUS_BT656;\r\nif (!of_property_read_u32(node, "data-active", &v))\r\nflags |= v ? V4L2_MBUS_DATA_ACTIVE_HIGH :\r\nV4L2_MBUS_DATA_ACTIVE_LOW;\r\nif (of_get_property(node, "slave-mode", &v))\r\nflags |= V4L2_MBUS_SLAVE;\r\nelse\r\nflags |= V4L2_MBUS_MASTER;\r\nif (!of_property_read_u32(node, "bus-width", &v))\r\nbus->bus_width = v;\r\nif (!of_property_read_u32(node, "data-shift", &v))\r\nbus->data_shift = v;\r\nif (!of_property_read_u32(node, "sync-on-green-active", &v))\r\nflags |= v ? V4L2_MBUS_VIDEO_SOG_ACTIVE_HIGH :\r\nV4L2_MBUS_VIDEO_SOG_ACTIVE_LOW;\r\nbus->flags = flags;\r\n}\r\nvoid v4l2_of_parse_endpoint(const struct device_node *node,\r\nstruct v4l2_of_endpoint *endpoint)\r\n{\r\nstruct device_node *port_node = of_get_parent(node);\r\nmemset(endpoint, 0, offsetof(struct v4l2_of_endpoint, head));\r\nendpoint->local_node = node;\r\nof_property_read_u32(port_node, "reg", &endpoint->port);\r\nof_property_read_u32(node, "reg", &endpoint->id);\r\nv4l2_of_parse_csi_bus(node, endpoint);\r\nif (endpoint->bus.mipi_csi2.flags == 0)\r\nv4l2_of_parse_parallel_bus(node, endpoint);\r\nof_node_put(port_node);\r\n}\r\nstruct device_node *v4l2_of_get_next_endpoint(const struct device_node *parent,\r\nstruct device_node *prev)\r\n{\r\nstruct device_node *endpoint;\r\nstruct device_node *port = NULL;\r\nif (!parent)\r\nreturn NULL;\r\nif (!prev) {\r\nstruct device_node *node;\r\nnode = of_get_child_by_name(parent, "ports");\r\nif (node)\r\nparent = node;\r\nport = of_get_child_by_name(parent, "port");\r\nif (port) {\r\nendpoint = of_get_next_child(port, NULL);\r\nof_node_put(port);\r\n} else {\r\nendpoint = NULL;\r\n}\r\nif (!endpoint)\r\npr_err("%s(): no endpoint nodes specified for %s\n",\r\n__func__, parent->full_name);\r\nof_node_put(node);\r\n} else {\r\nport = of_get_parent(prev);\r\nif (!port)\r\nreturn NULL;\r\nof_node_get(prev);\r\nendpoint = of_get_next_child(port, prev);\r\nif (endpoint) {\r\nof_node_put(port);\r\nreturn endpoint;\r\n}\r\ndo {\r\nport = of_get_next_child(parent, port);\r\nif (!port)\r\nreturn NULL;\r\n} while (of_node_cmp(port->name, "port"));\r\nendpoint = of_get_next_child(port, NULL);\r\nof_node_put(port);\r\n}\r\nreturn endpoint;\r\n}\r\nstruct device_node *v4l2_of_get_remote_port_parent(\r\nconst struct device_node *node)\r\n{\r\nstruct device_node *np;\r\nunsigned int depth;\r\nnp = of_parse_phandle(node, "remote-endpoint", 0);\r\nfor (depth = 3; depth && np; depth--) {\r\nnp = of_get_next_parent(np);\r\nif (depth == 2 && of_node_cmp(np->name, "ports"))\r\nbreak;\r\n}\r\nreturn np;\r\n}\r\nstruct device_node *v4l2_of_get_remote_port(const struct device_node *node)\r\n{\r\nstruct device_node *np;\r\nnp = of_parse_phandle(node, "remote-endpoint", 0);\r\nif (!np)\r\nreturn NULL;\r\nreturn of_get_parent(np);\r\n}

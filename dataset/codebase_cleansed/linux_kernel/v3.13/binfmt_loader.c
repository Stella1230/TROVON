static int load_binary(struct linux_binprm *bprm)\r\n{\r\nstruct exec *eh = (struct exec *)bprm->buf;\r\nunsigned long loader;\r\nstruct file *file;\r\nint retval;\r\nif (eh->fh.f_magic != 0x183 || (eh->fh.f_flags & 0x3000) != 0x3000)\r\nreturn -ENOEXEC;\r\nif (bprm->loader)\r\nreturn -ENOEXEC;\r\nallow_write_access(bprm->file);\r\nfput(bprm->file);\r\nbprm->file = NULL;\r\nloader = bprm->vma->vm_end - sizeof(void *);\r\nfile = open_exec("/sbin/loader");\r\nretval = PTR_ERR(file);\r\nif (IS_ERR(file))\r\nreturn retval;\r\nbprm->taso = eh->ah.entry < 0x100000000UL;\r\nbprm->file = file;\r\nbprm->loader = loader;\r\nretval = prepare_binprm(bprm);\r\nif (retval < 0)\r\nreturn retval;\r\nreturn search_binary_handler(bprm);\r\n}\r\nstatic int __init init_loader_binfmt(void)\r\n{\r\ninsert_binfmt(&loader_format);\r\nreturn 0;\r\n}

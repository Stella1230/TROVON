static inline u32 vsp1_rpf_read(struct vsp1_rwpf *rpf, u32 reg)\r\n{\r\nreturn vsp1_read(rpf->entity.vsp1,\r\nreg + rpf->entity.index * VI6_RPF_OFFSET);\r\n}\r\nstatic inline void vsp1_rpf_write(struct vsp1_rwpf *rpf, u32 reg, u32 data)\r\n{\r\nvsp1_write(rpf->entity.vsp1,\r\nreg + rpf->entity.index * VI6_RPF_OFFSET, data);\r\n}\r\nstatic int rpf_s_stream(struct v4l2_subdev *subdev, int enable)\r\n{\r\nstruct vsp1_rwpf *rpf = to_rwpf(subdev);\r\nconst struct vsp1_format_info *fmtinfo = rpf->video.fmtinfo;\r\nconst struct v4l2_pix_format_mplane *format = &rpf->video.format;\r\nu32 pstride;\r\nu32 infmt;\r\nif (!enable)\r\nreturn 0;\r\nvsp1_rpf_write(rpf, VI6_RPF_SRC_BSIZE,\r\n(format->width << VI6_RPF_SRC_BSIZE_BHSIZE_SHIFT) |\r\n(format->height << VI6_RPF_SRC_BSIZE_BVSIZE_SHIFT));\r\nvsp1_rpf_write(rpf, VI6_RPF_SRC_ESIZE,\r\n(format->width << VI6_RPF_SRC_ESIZE_EHSIZE_SHIFT) |\r\n(format->height << VI6_RPF_SRC_ESIZE_EVSIZE_SHIFT));\r\npstride = format->plane_fmt[0].bytesperline\r\n<< VI6_RPF_SRCM_PSTRIDE_Y_SHIFT;\r\nif (format->num_planes > 1)\r\npstride |= format->plane_fmt[1].bytesperline\r\n<< VI6_RPF_SRCM_PSTRIDE_C_SHIFT;\r\nvsp1_rpf_write(rpf, VI6_RPF_SRCM_PSTRIDE, pstride);\r\ninfmt = VI6_RPF_INFMT_CIPM\r\n| (fmtinfo->hwfmt << VI6_RPF_INFMT_RDFMT_SHIFT);\r\nif (fmtinfo->swap_yc)\r\ninfmt |= VI6_RPF_INFMT_SPYCS;\r\nif (fmtinfo->swap_uv)\r\ninfmt |= VI6_RPF_INFMT_SPUVS;\r\nif (rpf->entity.formats[RWPF_PAD_SINK].code !=\r\nrpf->entity.formats[RWPF_PAD_SOURCE].code)\r\ninfmt |= VI6_RPF_INFMT_CSC;\r\nvsp1_rpf_write(rpf, VI6_RPF_INFMT, infmt);\r\nvsp1_rpf_write(rpf, VI6_RPF_DSWAP, fmtinfo->swap);\r\nvsp1_rpf_write(rpf, VI6_RPF_LOC, 0);\r\nvsp1_rpf_write(rpf, VI6_RPF_ALPH_SEL, VI6_RPF_ALPH_SEL_ASEL_FIXED);\r\nvsp1_rpf_write(rpf, VI6_RPF_VRTCOL_SET,\r\n255 << VI6_RPF_VRTCOL_SET_LAYA_SHIFT);\r\nvsp1_rpf_write(rpf, VI6_RPF_MSK_CTRL, 0);\r\nvsp1_rpf_write(rpf, VI6_RPF_CKEY_CTRL, 0);\r\nreturn 0;\r\n}\r\nstatic void rpf_vdev_queue(struct vsp1_video *video,\r\nstruct vsp1_video_buffer *buf)\r\n{\r\nstruct vsp1_rwpf *rpf = container_of(video, struct vsp1_rwpf, video);\r\nvsp1_rpf_write(rpf, VI6_RPF_SRCM_ADDR_Y, buf->addr[0]);\r\nif (buf->buf.num_planes > 1)\r\nvsp1_rpf_write(rpf, VI6_RPF_SRCM_ADDR_C0, buf->addr[1]);\r\nif (buf->buf.num_planes > 2)\r\nvsp1_rpf_write(rpf, VI6_RPF_SRCM_ADDR_C1, buf->addr[2]);\r\n}\r\nstruct vsp1_rwpf *vsp1_rpf_create(struct vsp1_device *vsp1, unsigned int index)\r\n{\r\nstruct v4l2_subdev *subdev;\r\nstruct vsp1_video *video;\r\nstruct vsp1_rwpf *rpf;\r\nint ret;\r\nrpf = devm_kzalloc(vsp1->dev, sizeof(*rpf), GFP_KERNEL);\r\nif (rpf == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nrpf->max_width = RPF_MAX_WIDTH;\r\nrpf->max_height = RPF_MAX_HEIGHT;\r\nrpf->entity.type = VSP1_ENTITY_RPF;\r\nrpf->entity.index = index;\r\nrpf->entity.id = VI6_DPR_NODE_RPF(index);\r\nret = vsp1_entity_init(vsp1, &rpf->entity, 2);\r\nif (ret < 0)\r\nreturn ERR_PTR(ret);\r\nsubdev = &rpf->entity.subdev;\r\nv4l2_subdev_init(subdev, &rpf_ops);\r\nsubdev->entity.ops = &vsp1_media_ops;\r\nsubdev->internal_ops = &vsp1_subdev_internal_ops;\r\nsnprintf(subdev->name, sizeof(subdev->name), "%s rpf.%u",\r\ndev_name(vsp1->dev), index);\r\nv4l2_set_subdevdata(subdev, rpf);\r\nsubdev->flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;\r\nvsp1_entity_init_formats(subdev, NULL);\r\nvideo = &rpf->video;\r\nvideo->type = V4L2_BUF_TYPE_VIDEO_OUTPUT_MPLANE;\r\nvideo->vsp1 = vsp1;\r\nvideo->ops = &rpf_vdev_ops;\r\nret = vsp1_video_init(video, &rpf->entity);\r\nif (ret < 0)\r\ngoto error_video;\r\nret = media_entity_create_link(&rpf->video.video.entity, 0,\r\n&rpf->entity.subdev.entity,\r\nRWPF_PAD_SINK,\r\nMEDIA_LNK_FL_ENABLED |\r\nMEDIA_LNK_FL_IMMUTABLE);\r\nif (ret < 0)\r\ngoto error_link;\r\nreturn rpf;\r\nerror_link:\r\nvsp1_video_cleanup(video);\r\nerror_video:\r\nmedia_entity_cleanup(&rpf->entity.subdev.entity);\r\nreturn ERR_PTR(ret);\r\n}

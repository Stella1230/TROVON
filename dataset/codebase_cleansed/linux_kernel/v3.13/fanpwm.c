static int\r\nnouveau_fanpwm_get(struct nouveau_therm *therm)\r\n{\r\nstruct nouveau_therm_priv *tpriv = (void *)therm;\r\nstruct nouveau_fanpwm_priv *priv = (void *)tpriv->fan;\r\nstruct nouveau_gpio *gpio = nouveau_gpio(therm);\r\nint card_type = nv_device(therm)->card_type;\r\nu32 divs, duty;\r\nint ret;\r\nret = therm->pwm_get(therm, priv->func.line, &divs, &duty);\r\nif (ret == 0 && divs) {\r\ndivs = max(divs, duty);\r\nif (card_type <= NV_40 || (priv->func.log[0] & 1))\r\nduty = divs - duty;\r\nreturn (duty * 100) / divs;\r\n}\r\nreturn gpio->get(gpio, 0, priv->func.func, priv->func.line) * 100;\r\n}\r\nstatic int\r\nnouveau_fanpwm_set(struct nouveau_therm *therm, int percent)\r\n{\r\nstruct nouveau_therm_priv *tpriv = (void *)therm;\r\nstruct nouveau_fanpwm_priv *priv = (void *)tpriv->fan;\r\nint card_type = nv_device(therm)->card_type;\r\nu32 divs, duty;\r\nint ret;\r\ndivs = priv->base.perf.pwm_divisor;\r\nif (priv->base.bios.pwm_freq) {\r\ndivs = 1;\r\nif (therm->pwm_clock)\r\ndivs = therm->pwm_clock(therm);\r\ndivs /= priv->base.bios.pwm_freq;\r\n}\r\nduty = ((divs * percent) + 99) / 100;\r\nif (card_type <= NV_40 || (priv->func.log[0] & 1))\r\nduty = divs - duty;\r\nret = therm->pwm_set(therm, priv->func.line, divs, duty);\r\nif (ret == 0)\r\nret = therm->pwm_ctrl(therm, priv->func.line, true);\r\nreturn ret;\r\n}\r\nint\r\nnouveau_fanpwm_create(struct nouveau_therm *therm, struct dcb_gpio_func *func)\r\n{\r\nstruct nouveau_device *device = nv_device(therm);\r\nstruct nouveau_therm_priv *tpriv = (void *)therm;\r\nstruct nouveau_fanpwm_priv *priv;\r\nu32 divs, duty;\r\nif (!nouveau_boolopt(device->cfgopt, "NvFanPWM", func->param) ||\r\n!therm->pwm_ctrl ||\r\ntherm->pwm_get(therm, func->line, &divs, &duty) == -ENODEV)\r\nreturn -ENODEV;\r\npriv = kzalloc(sizeof(*priv), GFP_KERNEL);\r\ntpriv->fan = &priv->base;\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->base.type = "PWM";\r\npriv->base.get = nouveau_fanpwm_get;\r\npriv->base.set = nouveau_fanpwm_set;\r\npriv->func = *func;\r\nreturn 0;\r\n}

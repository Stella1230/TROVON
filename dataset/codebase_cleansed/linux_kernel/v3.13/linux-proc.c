int\r\nproc_call_handler(void *data, int write,\r\nloff_t *ppos, void *buffer, size_t *lenp,\r\nint (*handler)(void *data, int write,\r\nloff_t pos, void *buffer, int len))\r\n{\r\nint rc = handler(data, write, *ppos, buffer, *lenp);\r\nif (rc < 0)\r\nreturn rc;\r\nif (write) {\r\n*ppos += *lenp;\r\n} else {\r\n*lenp = rc;\r\n*ppos += rc;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __proc_dobitmasks(void *data, int write,\r\nloff_t pos, void *buffer, int nob)\r\n{\r\nconst int tmpstrlen = 512;\r\nchar *tmpstr;\r\nint rc;\r\nunsigned int *mask = data;\r\nint is_subsys = (mask == &libcfs_subsystem_debug) ? 1 : 0;\r\nint is_printk = (mask == &libcfs_printk) ? 1 : 0;\r\nrc = cfs_trace_allocate_string_buffer(&tmpstr, tmpstrlen);\r\nif (rc < 0)\r\nreturn rc;\r\nif (!write) {\r\nlibcfs_debug_mask2str(tmpstr, tmpstrlen, *mask, is_subsys);\r\nrc = strlen(tmpstr);\r\nif (pos >= rc) {\r\nrc = 0;\r\n} else {\r\nrc = cfs_trace_copyout_string(buffer, nob,\r\ntmpstr + pos, "\n");\r\n}\r\n} else {\r\nrc = cfs_trace_copyin_string(tmpstr, tmpstrlen, buffer, nob);\r\nif (rc < 0) {\r\ncfs_trace_free_string_buffer(tmpstr, tmpstrlen);\r\nreturn rc;\r\n}\r\nrc = libcfs_debug_str2mask(mask, tmpstr, is_subsys);\r\nif (is_printk)\r\n*mask |= D_EMERG;\r\n}\r\ncfs_trace_free_string_buffer(tmpstr, tmpstrlen);\r\nreturn rc;\r\n}\r\nstatic int __proc_dump_kernel(void *data, int write,\r\nloff_t pos, void *buffer, int nob)\r\n{\r\nif (!write)\r\nreturn 0;\r\nreturn cfs_trace_dump_debug_buffer_usrstr(buffer, nob);\r\n}\r\nstatic int __proc_daemon_file(void *data, int write,\r\nloff_t pos, void *buffer, int nob)\r\n{\r\nif (!write) {\r\nint len = strlen(cfs_tracefile);\r\nif (pos >= len)\r\nreturn 0;\r\nreturn cfs_trace_copyout_string(buffer, nob,\r\ncfs_tracefile + pos, "\n");\r\n}\r\nreturn cfs_trace_daemon_command_usrstr(buffer, nob);\r\n}\r\nstatic int __proc_debug_mb(void *data, int write,\r\nloff_t pos, void *buffer, int nob)\r\n{\r\nif (!write) {\r\nchar tmpstr[32];\r\nint len = snprintf(tmpstr, sizeof(tmpstr), "%d",\r\ncfs_trace_get_debug_mb());\r\nif (pos >= len)\r\nreturn 0;\r\nreturn cfs_trace_copyout_string(buffer, nob, tmpstr + pos,\r\n"\n");\r\n}\r\nreturn cfs_trace_set_debug_mb_usrstr(buffer, nob);\r\n}\r\nint LL_PROC_PROTO(proc_console_max_delay_cs)\r\n{\r\nint rc, max_delay_cs;\r\nctl_table_t dummy = *table;\r\ncfs_duration_t d;\r\ndummy.data = &max_delay_cs;\r\ndummy.proc_handler = &proc_dointvec;\r\nif (!write) {\r\nmax_delay_cs = cfs_duration_sec(libcfs_console_max_delay * 100);\r\nrc = ll_proc_dointvec(&dummy, write, filp, buffer, lenp, ppos);\r\nreturn rc;\r\n}\r\nmax_delay_cs = 0;\r\nrc = ll_proc_dointvec(&dummy, write, filp, buffer, lenp, ppos);\r\nif (rc < 0)\r\nreturn rc;\r\nif (max_delay_cs <= 0)\r\nreturn -EINVAL;\r\nd = cfs_time_seconds(max_delay_cs) / 100;\r\nif (d == 0 || d < libcfs_console_min_delay)\r\nreturn -EINVAL;\r\nlibcfs_console_max_delay = d;\r\nreturn rc;\r\n}\r\nint LL_PROC_PROTO(proc_console_min_delay_cs)\r\n{\r\nint rc, min_delay_cs;\r\nctl_table_t dummy = *table;\r\ncfs_duration_t d;\r\ndummy.data = &min_delay_cs;\r\ndummy.proc_handler = &proc_dointvec;\r\nif (!write) {\r\nmin_delay_cs = cfs_duration_sec(libcfs_console_min_delay * 100);\r\nrc = ll_proc_dointvec(&dummy, write, filp, buffer, lenp, ppos);\r\nreturn rc;\r\n}\r\nmin_delay_cs = 0;\r\nrc = ll_proc_dointvec(&dummy, write, filp, buffer, lenp, ppos);\r\nif (rc < 0)\r\nreturn rc;\r\nif (min_delay_cs <= 0)\r\nreturn -EINVAL;\r\nd = cfs_time_seconds(min_delay_cs) / 100;\r\nif (d == 0 || d > libcfs_console_max_delay)\r\nreturn -EINVAL;\r\nlibcfs_console_min_delay = d;\r\nreturn rc;\r\n}\r\nint LL_PROC_PROTO(proc_console_backoff)\r\n{\r\nint rc, backoff;\r\nctl_table_t dummy = *table;\r\ndummy.data = &backoff;\r\ndummy.proc_handler = &proc_dointvec;\r\nif (!write) {\r\nbackoff= libcfs_console_backoff;\r\nrc = ll_proc_dointvec(&dummy, write, filp, buffer, lenp, ppos);\r\nreturn rc;\r\n}\r\nbackoff = 0;\r\nrc = ll_proc_dointvec(&dummy, write, filp, buffer, lenp, ppos);\r\nif (rc < 0)\r\nreturn rc;\r\nif (backoff <= 0)\r\nreturn -EINVAL;\r\nlibcfs_console_backoff = backoff;\r\nreturn rc;\r\n}\r\nint LL_PROC_PROTO(libcfs_force_lbug)\r\n{\r\nif (write)\r\nLBUG();\r\nreturn 0;\r\n}\r\nint LL_PROC_PROTO(proc_fail_loc)\r\n{\r\nint rc;\r\nlong old_fail_loc = cfs_fail_loc;\r\nrc = ll_proc_dolongvec(table, write, filp, buffer, lenp, ppos);\r\nif (old_fail_loc != cfs_fail_loc)\r\nwake_up(&cfs_race_waitq);\r\nreturn rc;\r\n}\r\nstatic int __proc_cpt_table(void *data, int write,\r\nloff_t pos, void *buffer, int nob)\r\n{\r\nchar *buf = NULL;\r\nint len = 4096;\r\nint rc = 0;\r\nif (write)\r\nreturn -EPERM;\r\nLASSERT(cfs_cpt_table != NULL);\r\nwhile (1) {\r\nLIBCFS_ALLOC(buf, len);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nrc = cfs_cpt_table_print(cfs_cpt_table, buf, len);\r\nif (rc >= 0)\r\nbreak;\r\nLIBCFS_FREE(buf, len);\r\nif (rc == -EFBIG) {\r\nlen <<= 1;\r\ncontinue;\r\n}\r\ngoto out;\r\n}\r\nif (pos >= rc) {\r\nrc = 0;\r\ngoto out;\r\n}\r\nrc = cfs_trace_copyout_string(buffer, nob, buf + pos, NULL);\r\nout:\r\nif (buf != NULL)\r\nLIBCFS_FREE(buf, len);\r\nreturn rc;\r\n}\r\nint insert_proc(void)\r\n{\r\n#ifdef CONFIG_SYSCTL\r\nif (lnet_table_header == NULL)\r\nlnet_table_header = register_sysctl_table(top_table);\r\n#endif\r\nreturn 0;\r\n}\r\nvoid remove_proc(void)\r\n{\r\n#ifdef CONFIG_SYSCTL\r\nif (lnet_table_header != NULL)\r\nunregister_sysctl_table(lnet_table_header);\r\nlnet_table_header = NULL;\r\n#endif\r\n}

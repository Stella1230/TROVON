void mxs_ssp_set_clk_rate(struct mxs_ssp *ssp, unsigned int rate)\r\n{\r\nunsigned int ssp_clk, ssp_sck;\r\nu32 clock_divide, clock_rate;\r\nu32 val;\r\nssp_clk = clk_get_rate(ssp->clk);\r\nfor (clock_divide = 2; clock_divide <= 254; clock_divide += 2) {\r\nclock_rate = DIV_ROUND_UP(ssp_clk, rate * clock_divide);\r\nclock_rate = (clock_rate > 0) ? clock_rate - 1 : 0;\r\nif (clock_rate <= 255)\r\nbreak;\r\n}\r\nif (clock_divide > 254) {\r\ndev_err(ssp->dev,\r\n"%s: cannot set clock to %d\n", __func__, rate);\r\nreturn;\r\n}\r\nssp_sck = ssp_clk / clock_divide / (1 + clock_rate);\r\nval = readl(ssp->base + HW_SSP_TIMING(ssp));\r\nval &= ~(BM_SSP_TIMING_CLOCK_DIVIDE | BM_SSP_TIMING_CLOCK_RATE);\r\nval |= BF_SSP(clock_divide, TIMING_CLOCK_DIVIDE);\r\nval |= BF_SSP(clock_rate, TIMING_CLOCK_RATE);\r\nwritel(val, ssp->base + HW_SSP_TIMING(ssp));\r\nssp->clk_rate = ssp_sck;\r\ndev_dbg(ssp->dev,\r\n"%s: clock_divide %d, clock_rate %d, ssp_clk %d, rate_actual %d, rate_requested %d\n",\r\n__func__, clock_divide, clock_rate, ssp_clk, ssp_sck, rate);\r\n}

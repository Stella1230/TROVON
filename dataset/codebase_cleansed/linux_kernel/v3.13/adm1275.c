static int adm1275_read_word_data(struct i2c_client *client, int page, int reg)\r\n{\r\nconst struct pmbus_driver_info *info = pmbus_get_driver_info(client);\r\nconst struct adm1275_data *data = to_adm1275_data(info);\r\nint ret = 0;\r\nif (page)\r\nreturn -ENXIO;\r\nswitch (reg) {\r\ncase PMBUS_IOUT_UC_FAULT_LIMIT:\r\nif (data->have_oc_fault) {\r\nret = -ENXIO;\r\nbreak;\r\n}\r\nret = pmbus_read_word_data(client, 0, ADM1275_IOUT_WARN2_LIMIT);\r\nbreak;\r\ncase PMBUS_IOUT_OC_FAULT_LIMIT:\r\nif (!data->have_oc_fault) {\r\nret = -ENXIO;\r\nbreak;\r\n}\r\nret = pmbus_read_word_data(client, 0, ADM1275_IOUT_WARN2_LIMIT);\r\nbreak;\r\ncase PMBUS_VOUT_OV_WARN_LIMIT:\r\nif (data->id != adm1075) {\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nret = pmbus_read_word_data(client, 0,\r\nADM1075_VAUX_OV_WARN_LIMIT);\r\nbreak;\r\ncase PMBUS_VOUT_UV_WARN_LIMIT:\r\nif (data->id != adm1075) {\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nret = pmbus_read_word_data(client, 0,\r\nADM1075_VAUX_UV_WARN_LIMIT);\r\nbreak;\r\ncase PMBUS_READ_VOUT:\r\nif (data->id != adm1075) {\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nret = pmbus_read_word_data(client, 0, ADM1075_READ_VAUX);\r\nbreak;\r\ncase PMBUS_VIRT_READ_IOUT_MAX:\r\nret = pmbus_read_word_data(client, 0, ADM1275_PEAK_IOUT);\r\nbreak;\r\ncase PMBUS_VIRT_READ_VOUT_MAX:\r\nret = pmbus_read_word_data(client, 0, ADM1275_PEAK_VOUT);\r\nbreak;\r\ncase PMBUS_VIRT_READ_VIN_MAX:\r\nret = pmbus_read_word_data(client, 0, ADM1275_PEAK_VIN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_PIN_MAX:\r\nif (data->id == adm1275) {\r\nret = -ENXIO;\r\nbreak;\r\n}\r\nret = pmbus_read_word_data(client, 0, ADM1276_PEAK_PIN);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_IOUT_HISTORY:\r\ncase PMBUS_VIRT_RESET_VOUT_HISTORY:\r\ncase PMBUS_VIRT_RESET_VIN_HISTORY:\r\nbreak;\r\ncase PMBUS_VIRT_RESET_PIN_HISTORY:\r\nif (data->id == adm1275)\r\nret = -ENXIO;\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int adm1275_write_word_data(struct i2c_client *client, int page, int reg,\r\nu16 word)\r\n{\r\nint ret;\r\nif (page)\r\nreturn -ENXIO;\r\nswitch (reg) {\r\ncase PMBUS_IOUT_UC_FAULT_LIMIT:\r\ncase PMBUS_IOUT_OC_FAULT_LIMIT:\r\nret = pmbus_write_word_data(client, 0, ADM1275_IOUT_WARN2_LIMIT,\r\nword);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_IOUT_HISTORY:\r\nret = pmbus_write_word_data(client, 0, ADM1275_PEAK_IOUT, 0);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_VOUT_HISTORY:\r\nret = pmbus_write_word_data(client, 0, ADM1275_PEAK_VOUT, 0);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_VIN_HISTORY:\r\nret = pmbus_write_word_data(client, 0, ADM1275_PEAK_VIN, 0);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_PIN_HISTORY:\r\nret = pmbus_write_word_data(client, 0, ADM1276_PEAK_PIN, 0);\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int adm1275_read_byte_data(struct i2c_client *client, int page, int reg)\r\n{\r\nconst struct pmbus_driver_info *info = pmbus_get_driver_info(client);\r\nconst struct adm1275_data *data = to_adm1275_data(info);\r\nint mfr_status, ret;\r\nif (page > 0)\r\nreturn -ENXIO;\r\nswitch (reg) {\r\ncase PMBUS_STATUS_IOUT:\r\nret = pmbus_read_byte_data(client, page, PMBUS_STATUS_IOUT);\r\nif (ret < 0)\r\nbreak;\r\nmfr_status = pmbus_read_byte_data(client, page,\r\nPMBUS_STATUS_MFR_SPECIFIC);\r\nif (mfr_status < 0) {\r\nret = mfr_status;\r\nbreak;\r\n}\r\nif (mfr_status & ADM1275_MFR_STATUS_IOUT_WARN2) {\r\nret |= data->have_oc_fault ?\r\nPB_IOUT_OC_FAULT : PB_IOUT_UC_FAULT;\r\n}\r\nbreak;\r\ncase PMBUS_STATUS_VOUT:\r\nif (data->id != adm1075) {\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nret = 0;\r\nmfr_status = pmbus_read_byte_data(client, 0,\r\nADM1075_VAUX_STATUS);\r\nif (mfr_status & ADM1075_VAUX_OV_WARN)\r\nret |= PB_VOLTAGE_OV_WARNING;\r\nif (mfr_status & ADM1075_VAUX_UV_WARN)\r\nret |= PB_VOLTAGE_UV_WARNING;\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int adm1275_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nu8 block_buffer[I2C_SMBUS_BLOCK_MAX + 1];\r\nint config, device_config;\r\nint ret;\r\nstruct pmbus_driver_info *info;\r\nstruct adm1275_data *data;\r\nconst struct i2c_device_id *mid;\r\nif (!i2c_check_functionality(client->adapter,\r\nI2C_FUNC_SMBUS_READ_BYTE_DATA\r\n| I2C_FUNC_SMBUS_BLOCK_DATA))\r\nreturn -ENODEV;\r\nret = i2c_smbus_read_block_data(client, PMBUS_MFR_ID, block_buffer);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "Failed to read Manufacturer ID\n");\r\nreturn ret;\r\n}\r\nif (ret != 3 || strncmp(block_buffer, "ADI", 3)) {\r\ndev_err(&client->dev, "Unsupported Manufacturer ID\n");\r\nreturn -ENODEV;\r\n}\r\nret = i2c_smbus_read_block_data(client, PMBUS_MFR_MODEL, block_buffer);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "Failed to read Manufacturer Model\n");\r\nreturn ret;\r\n}\r\nfor (mid = adm1275_id; mid->name[0]; mid++) {\r\nif (!strncasecmp(mid->name, block_buffer, strlen(mid->name)))\r\nbreak;\r\n}\r\nif (!mid->name[0]) {\r\ndev_err(&client->dev, "Unsupported device\n");\r\nreturn -ENODEV;\r\n}\r\nif (id->driver_data != mid->driver_data)\r\ndev_notice(&client->dev,\r\n"Device mismatch: Configured %s, detected %s\n",\r\nid->name, mid->name);\r\nconfig = i2c_smbus_read_byte_data(client, ADM1275_PMON_CONFIG);\r\nif (config < 0)\r\nreturn config;\r\ndevice_config = i2c_smbus_read_byte_data(client, ADM1275_DEVICE_CONFIG);\r\nif (device_config < 0)\r\nreturn device_config;\r\ndata = devm_kzalloc(&client->dev, sizeof(struct adm1275_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->id = mid->driver_data;\r\ninfo = &data->info;\r\ninfo->pages = 1;\r\ninfo->format[PSC_VOLTAGE_IN] = direct;\r\ninfo->format[PSC_VOLTAGE_OUT] = direct;\r\ninfo->format[PSC_CURRENT_OUT] = direct;\r\ninfo->m[PSC_CURRENT_OUT] = 807;\r\ninfo->b[PSC_CURRENT_OUT] = 20475;\r\ninfo->R[PSC_CURRENT_OUT] = -1;\r\ninfo->func[0] = PMBUS_HAVE_IOUT | PMBUS_HAVE_STATUS_IOUT;\r\ninfo->read_word_data = adm1275_read_word_data;\r\ninfo->read_byte_data = adm1275_read_byte_data;\r\ninfo->write_word_data = adm1275_write_word_data;\r\nif (data->id == adm1075) {\r\ninfo->m[PSC_VOLTAGE_IN] = 27169;\r\ninfo->b[PSC_VOLTAGE_IN] = 0;\r\ninfo->R[PSC_VOLTAGE_IN] = -1;\r\ninfo->m[PSC_VOLTAGE_OUT] = 27169;\r\ninfo->b[PSC_VOLTAGE_OUT] = 0;\r\ninfo->R[PSC_VOLTAGE_OUT] = -1;\r\n} else if (config & ADM1275_VRANGE) {\r\ninfo->m[PSC_VOLTAGE_IN] = 19199;\r\ninfo->b[PSC_VOLTAGE_IN] = 0;\r\ninfo->R[PSC_VOLTAGE_IN] = -2;\r\ninfo->m[PSC_VOLTAGE_OUT] = 19199;\r\ninfo->b[PSC_VOLTAGE_OUT] = 0;\r\ninfo->R[PSC_VOLTAGE_OUT] = -2;\r\n} else {\r\ninfo->m[PSC_VOLTAGE_IN] = 6720;\r\ninfo->b[PSC_VOLTAGE_IN] = 0;\r\ninfo->R[PSC_VOLTAGE_IN] = -1;\r\ninfo->m[PSC_VOLTAGE_OUT] = 6720;\r\ninfo->b[PSC_VOLTAGE_OUT] = 0;\r\ninfo->R[PSC_VOLTAGE_OUT] = -1;\r\n}\r\nif (device_config & ADM1275_IOUT_WARN2_SELECT)\r\ndata->have_oc_fault = true;\r\nswitch (data->id) {\r\ncase adm1075:\r\ninfo->format[PSC_POWER] = direct;\r\ninfo->b[PSC_POWER] = 0;\r\ninfo->R[PSC_POWER] = -1;\r\nswitch (config & ADM1075_IRANGE_MASK) {\r\ncase ADM1075_IRANGE_25:\r\ninfo->m[PSC_POWER] = 8549;\r\ninfo->m[PSC_CURRENT_OUT] = 806;\r\nbreak;\r\ncase ADM1075_IRANGE_50:\r\ninfo->m[PSC_POWER] = 4279;\r\ninfo->m[PSC_CURRENT_OUT] = 404;\r\nbreak;\r\ndefault:\r\ndev_err(&client->dev, "Invalid input current range");\r\ninfo->m[PSC_POWER] = 0;\r\ninfo->m[PSC_CURRENT_OUT] = 0;\r\nbreak;\r\n}\r\ninfo->func[0] |= PMBUS_HAVE_VIN | PMBUS_HAVE_PIN\r\n| PMBUS_HAVE_STATUS_INPUT;\r\nif (config & ADM1275_VIN_VOUT_SELECT)\r\ninfo->func[0] |=\r\nPMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT;\r\nbreak;\r\ncase adm1275:\r\nif (config & ADM1275_VIN_VOUT_SELECT)\r\ninfo->func[0] |=\r\nPMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT;\r\nelse\r\ninfo->func[0] |=\r\nPMBUS_HAVE_VIN | PMBUS_HAVE_STATUS_INPUT;\r\nbreak;\r\ncase adm1276:\r\ninfo->format[PSC_POWER] = direct;\r\ninfo->func[0] |= PMBUS_HAVE_VIN | PMBUS_HAVE_PIN\r\n| PMBUS_HAVE_STATUS_INPUT;\r\nif (config & ADM1275_VIN_VOUT_SELECT)\r\ninfo->func[0] |=\r\nPMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT;\r\nif (config & ADM1275_VRANGE) {\r\ninfo->m[PSC_POWER] = 6043;\r\ninfo->b[PSC_POWER] = 0;\r\ninfo->R[PSC_POWER] = -2;\r\n} else {\r\ninfo->m[PSC_POWER] = 2115;\r\ninfo->b[PSC_POWER] = 0;\r\ninfo->R[PSC_POWER] = -1;\r\n}\r\nbreak;\r\n}\r\nreturn pmbus_do_probe(client, id, info);\r\n}

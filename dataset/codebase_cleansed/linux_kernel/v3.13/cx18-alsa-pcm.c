void cx18_alsa_announce_pcm_data(struct snd_cx18_card *cxsc, u8 *pcm_data,\r\nsize_t num_bytes)\r\n{\r\nstruct snd_pcm_substream *substream;\r\nstruct snd_pcm_runtime *runtime;\r\nunsigned int oldptr;\r\nunsigned int stride;\r\nint period_elapsed = 0;\r\nint length;\r\ndprintk("cx18 alsa announce ptr=%p data=%p num_bytes=%zd\n", cxsc,\r\npcm_data, num_bytes);\r\nsubstream = cxsc->capture_pcm_substream;\r\nif (substream == NULL) {\r\ndprintk("substream was NULL\n");\r\nreturn;\r\n}\r\nruntime = substream->runtime;\r\nif (runtime == NULL) {\r\ndprintk("runtime was NULL\n");\r\nreturn;\r\n}\r\nstride = runtime->frame_bits >> 3;\r\nif (stride == 0) {\r\ndprintk("stride is zero\n");\r\nreturn;\r\n}\r\nlength = num_bytes / stride;\r\nif (length == 0) {\r\ndprintk("%s: length was zero\n", __func__);\r\nreturn;\r\n}\r\nif (runtime->dma_area == NULL) {\r\ndprintk("dma area was NULL - ignoring\n");\r\nreturn;\r\n}\r\noldptr = cxsc->hwptr_done_capture;\r\nif (oldptr + length >= runtime->buffer_size) {\r\nunsigned int cnt =\r\nruntime->buffer_size - oldptr;\r\nmemcpy(runtime->dma_area + oldptr * stride, pcm_data,\r\ncnt * stride);\r\nmemcpy(runtime->dma_area, pcm_data + cnt * stride,\r\nlength * stride - cnt * stride);\r\n} else {\r\nmemcpy(runtime->dma_area + oldptr * stride, pcm_data,\r\nlength * stride);\r\n}\r\nsnd_pcm_stream_lock(substream);\r\ncxsc->hwptr_done_capture += length;\r\nif (cxsc->hwptr_done_capture >=\r\nruntime->buffer_size)\r\ncxsc->hwptr_done_capture -=\r\nruntime->buffer_size;\r\ncxsc->capture_transfer_done += length;\r\nif (cxsc->capture_transfer_done >=\r\nruntime->period_size) {\r\ncxsc->capture_transfer_done -=\r\nruntime->period_size;\r\nperiod_elapsed = 1;\r\n}\r\nsnd_pcm_stream_unlock(substream);\r\nif (period_elapsed)\r\nsnd_pcm_period_elapsed(substream);\r\n}\r\nstatic int snd_cx18_pcm_capture_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_cx18_card *cxsc = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct v4l2_device *v4l2_dev = cxsc->v4l2_dev;\r\nstruct cx18 *cx = to_cx18(v4l2_dev);\r\nstruct cx18_stream *s;\r\nstruct cx18_open_id item;\r\nint ret;\r\nsnd_cx18_lock(cxsc);\r\ns = &cx->streams[CX18_ENC_STREAM_TYPE_PCM];\r\nitem.cx = cx;\r\nitem.type = s->type;\r\nitem.open_id = cx->open_id++;\r\nif (cx18_claim_stream(&item, item.type)) {\r\nsnd_cx18_unlock(cxsc);\r\nreturn -EBUSY;\r\n}\r\nif (test_bit(CX18_F_S_STREAMOFF, &s->s_flags) ||\r\ntest_and_set_bit(CX18_F_S_STREAMING, &s->s_flags)) {\r\nsnd_cx18_unlock(cxsc);\r\nreturn 0;\r\n}\r\nruntime->hw = snd_cx18_hw_capture;\r\nsnd_pcm_hw_constraint_integer(runtime, SNDRV_PCM_HW_PARAM_PERIODS);\r\ncxsc->capture_pcm_substream = substream;\r\nruntime->private_data = cx;\r\ncx->pcm_announce_callback = cx18_alsa_announce_pcm_data;\r\nset_bit(CX18_F_S_STREAMING, &s->s_flags);\r\nret = cx18_start_v4l2_encode_stream(s);\r\nsnd_cx18_unlock(cxsc);\r\nreturn ret;\r\n}\r\nstatic int snd_cx18_pcm_capture_close(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_cx18_card *cxsc = snd_pcm_substream_chip(substream);\r\nstruct v4l2_device *v4l2_dev = cxsc->v4l2_dev;\r\nstruct cx18 *cx = to_cx18(v4l2_dev);\r\nstruct cx18_stream *s;\r\nsnd_cx18_lock(cxsc);\r\ns = &cx->streams[CX18_ENC_STREAM_TYPE_PCM];\r\ncx18_stop_v4l2_encode_stream(s, 0);\r\nclear_bit(CX18_F_S_STREAMING, &s->s_flags);\r\ncx18_release_stream(s);\r\ncx->pcm_announce_callback = NULL;\r\nsnd_cx18_unlock(cxsc);\r\nreturn 0;\r\n}\r\nstatic int snd_cx18_pcm_ioctl(struct snd_pcm_substream *substream,\r\nunsigned int cmd, void *arg)\r\n{\r\nstruct snd_cx18_card *cxsc = snd_pcm_substream_chip(substream);\r\nint ret;\r\nsnd_cx18_lock(cxsc);\r\nret = snd_pcm_lib_ioctl(substream, cmd, arg);\r\nsnd_cx18_unlock(cxsc);\r\nreturn ret;\r\n}\r\nstatic int snd_pcm_alloc_vmalloc_buffer(struct snd_pcm_substream *subs,\r\nsize_t size)\r\n{\r\nstruct snd_pcm_runtime *runtime = subs->runtime;\r\ndprintk("Allocating vbuffer\n");\r\nif (runtime->dma_area) {\r\nif (runtime->dma_bytes > size)\r\nreturn 0;\r\nvfree(runtime->dma_area);\r\n}\r\nruntime->dma_area = vmalloc(size);\r\nif (!runtime->dma_area)\r\nreturn -ENOMEM;\r\nruntime->dma_bytes = size;\r\nreturn 0;\r\n}\r\nstatic int snd_cx18_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\ndprintk("%s called\n", __func__);\r\nreturn snd_pcm_alloc_vmalloc_buffer(substream,\r\nparams_buffer_bytes(params));\r\n}\r\nstatic int snd_cx18_pcm_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_cx18_card *cxsc = snd_pcm_substream_chip(substream);\r\nunsigned long flags;\r\nspin_lock_irqsave(&cxsc->slock, flags);\r\nif (substream->runtime->dma_area) {\r\ndprintk("freeing pcm capture region\n");\r\nvfree(substream->runtime->dma_area);\r\nsubstream->runtime->dma_area = NULL;\r\n}\r\nspin_unlock_irqrestore(&cxsc->slock, flags);\r\nreturn 0;\r\n}\r\nstatic int snd_cx18_pcm_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_cx18_card *cxsc = snd_pcm_substream_chip(substream);\r\ncxsc->hwptr_done_capture = 0;\r\ncxsc->capture_transfer_done = 0;\r\nreturn 0;\r\n}\r\nstatic int snd_cx18_pcm_trigger(struct snd_pcm_substream *substream, int cmd)\r\n{\r\nreturn 0;\r\n}\r\nstatic\r\nsnd_pcm_uframes_t snd_cx18_pcm_pointer(struct snd_pcm_substream *substream)\r\n{\r\nunsigned long flags;\r\nsnd_pcm_uframes_t hwptr_done;\r\nstruct snd_cx18_card *cxsc = snd_pcm_substream_chip(substream);\r\nspin_lock_irqsave(&cxsc->slock, flags);\r\nhwptr_done = cxsc->hwptr_done_capture;\r\nspin_unlock_irqrestore(&cxsc->slock, flags);\r\nreturn hwptr_done;\r\n}\r\nstatic struct page *snd_pcm_get_vmalloc_page(struct snd_pcm_substream *subs,\r\nunsigned long offset)\r\n{\r\nvoid *pageptr = subs->runtime->dma_area + offset;\r\nreturn vmalloc_to_page(pageptr);\r\n}\r\nint snd_cx18_pcm_create(struct snd_cx18_card *cxsc)\r\n{\r\nstruct snd_pcm *sp;\r\nstruct snd_card *sc = cxsc->sc;\r\nstruct v4l2_device *v4l2_dev = cxsc->v4l2_dev;\r\nstruct cx18 *cx = to_cx18(v4l2_dev);\r\nint ret;\r\nret = snd_pcm_new(sc, "CX23418 PCM",\r\n0,\r\n0,\r\n1,\r\n&sp);\r\nif (ret) {\r\nCX18_ALSA_ERR("%s: snd_cx18_pcm_create() failed with err %d\n",\r\n__func__, ret);\r\ngoto err_exit;\r\n}\r\nspin_lock_init(&cxsc->slock);\r\nsnd_pcm_set_ops(sp, SNDRV_PCM_STREAM_CAPTURE,\r\n&snd_cx18_pcm_capture_ops);\r\nsp->info_flags = 0;\r\nsp->private_data = cxsc;\r\nstrlcpy(sp->name, cx->card_name, sizeof(sp->name));\r\nreturn 0;\r\nerr_exit:\r\nreturn ret;\r\n}

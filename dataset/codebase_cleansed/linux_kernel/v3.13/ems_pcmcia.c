static u8 ems_pcmcia_read_reg(const struct sja1000_priv *priv, int port)\r\n{\r\nreturn readb(priv->reg_base + port);\r\n}\r\nstatic void ems_pcmcia_write_reg(const struct sja1000_priv *priv, int port,\r\nu8 val)\r\n{\r\nwriteb(val, priv->reg_base + port);\r\n}\r\nstatic irqreturn_t ems_pcmcia_interrupt(int irq, void *dev_id)\r\n{\r\nstruct ems_pcmcia_card *card = dev_id;\r\nstruct net_device *dev;\r\nirqreturn_t retval = IRQ_NONE;\r\nint i, again;\r\nif (readw(card->base_addr) != 0xAA55)\r\nreturn IRQ_HANDLED;\r\ndo {\r\nagain = 0;\r\nfor (i = 0; i < card->channels; i++) {\r\ndev = card->net_dev[i];\r\nif (!dev)\r\ncontinue;\r\nif (sja1000_interrupt(irq, dev) == IRQ_HANDLED)\r\nagain = 1;\r\n}\r\nif (again)\r\nretval = IRQ_HANDLED;\r\n} while (again);\r\nreturn retval;\r\n}\r\nstatic inline int ems_pcmcia_check_chan(struct sja1000_priv *priv)\r\n{\r\nems_pcmcia_write_reg(priv, SJA1000_MOD, 1);\r\nems_pcmcia_write_reg(priv, SJA1000_CDR, CDR_PELICAN);\r\nif (ems_pcmcia_read_reg(priv, SJA1000_CDR) == CDR_PELICAN)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void ems_pcmcia_del_card(struct pcmcia_device *pdev)\r\n{\r\nstruct ems_pcmcia_card *card = pdev->priv;\r\nstruct net_device *dev;\r\nint i;\r\nfree_irq(pdev->irq, card);\r\nfor (i = 0; i < card->channels; i++) {\r\ndev = card->net_dev[i];\r\nif (!dev)\r\ncontinue;\r\nprintk(KERN_INFO "%s: removing %s on channel #%d\n",\r\nDRV_NAME, dev->name, i);\r\nunregister_sja1000dev(dev);\r\nfree_sja1000dev(dev);\r\n}\r\nwriteb(EMS_CMD_UMAP, card->base_addr);\r\niounmap(card->base_addr);\r\nkfree(card);\r\npdev->priv = NULL;\r\n}\r\nstatic int ems_pcmcia_add_card(struct pcmcia_device *pdev, unsigned long base)\r\n{\r\nstruct sja1000_priv *priv;\r\nstruct net_device *dev;\r\nstruct ems_pcmcia_card *card;\r\nint err, i;\r\ncard = kzalloc(sizeof(struct ems_pcmcia_card), GFP_KERNEL);\r\nif (!card)\r\nreturn -ENOMEM;\r\npdev->priv = card;\r\ncard->channels = 0;\r\ncard->base_addr = ioremap(base, EMS_PCMCIA_MEM_SIZE);\r\nif (!card->base_addr) {\r\nerr = -ENOMEM;\r\ngoto failure_cleanup;\r\n}\r\nif (readw(card->base_addr) != 0xAA55) {\r\nerr = -ENODEV;\r\ngoto failure_cleanup;\r\n}\r\nwriteb(EMS_CMD_RESET, card->base_addr);\r\nwriteb(EMS_CMD_MAP, card->base_addr);\r\nfor (i = 0; i < EMS_PCMCIA_MAX_CHAN; i++) {\r\ndev = alloc_sja1000dev(0);\r\nif (!dev) {\r\nerr = -ENOMEM;\r\ngoto failure_cleanup;\r\n}\r\ncard->net_dev[i] = dev;\r\npriv = netdev_priv(dev);\r\npriv->priv = card;\r\nSET_NETDEV_DEV(dev, &pdev->dev);\r\npriv->irq_flags = IRQF_SHARED;\r\ndev->irq = pdev->irq;\r\npriv->reg_base = card->base_addr + EMS_PCMCIA_CAN_BASE_OFFSET +\r\n(i * EMS_PCMCIA_CAN_CTRL_SIZE);\r\nif (ems_pcmcia_check_chan(priv)) {\r\npriv->read_reg = ems_pcmcia_read_reg;\r\npriv->write_reg = ems_pcmcia_write_reg;\r\npriv->can.clock.freq = EMS_PCMCIA_CAN_CLOCK;\r\npriv->ocr = EMS_PCMCIA_OCR;\r\npriv->cdr = EMS_PCMCIA_CDR;\r\npriv->flags |= SJA1000_CUSTOM_IRQ_HANDLER;\r\nerr = register_sja1000dev(dev);\r\nif (err) {\r\nfree_sja1000dev(dev);\r\ngoto failure_cleanup;\r\n}\r\ncard->channels++;\r\nprintk(KERN_INFO "%s: registered %s on channel "\r\n"#%d at 0x%p, irq %d\n", DRV_NAME, dev->name,\r\ni, priv->reg_base, dev->irq);\r\n} else\r\nfree_sja1000dev(dev);\r\n}\r\nerr = request_irq(dev->irq, &ems_pcmcia_interrupt, IRQF_SHARED,\r\nDRV_NAME, card);\r\nif (!err)\r\nreturn 0;\r\nfailure_cleanup:\r\nems_pcmcia_del_card(pdev);\r\nreturn err;\r\n}\r\nstatic int ems_pcmcia_probe(struct pcmcia_device *dev)\r\n{\r\nint csval;\r\ndev->config_flags |= CONF_ENABLE_IRQ;\r\ndev->config_index = 1;\r\ndev->config_regs = PRESENT_OPTION;\r\ndev->resource[0]->end = 16;\r\ndev->resource[0]->flags |= IO_DATA_PATH_WIDTH_8;\r\ndev->resource[1]->end = 16;\r\ndev->resource[1]->flags |= IO_DATA_PATH_WIDTH_16;\r\ndev->io_lines = 5;\r\ndev->resource[2]->flags =\r\n(WIN_DATA_WIDTH_8 | WIN_MEMORY_TYPE_CM | WIN_ENABLE);\r\ndev->resource[2]->start = dev->resource[2]->end = 0;\r\ncsval = pcmcia_request_window(dev, dev->resource[2], 0);\r\nif (csval) {\r\ndev_err(&dev->dev, "pcmcia_request_window failed (err=%d)\n",\r\ncsval);\r\nreturn 0;\r\n}\r\ncsval = pcmcia_map_mem_page(dev, dev->resource[2], dev->config_base);\r\nif (csval) {\r\ndev_err(&dev->dev, "pcmcia_map_mem_page failed (err=%d)\n",\r\ncsval);\r\nreturn 0;\r\n}\r\ncsval = pcmcia_enable_device(dev);\r\nif (csval) {\r\ndev_err(&dev->dev, "pcmcia_enable_device failed (err=%d)\n",\r\ncsval);\r\nreturn 0;\r\n}\r\nems_pcmcia_add_card(dev, dev->resource[2]->start);\r\nreturn 0;\r\n}\r\nstatic void ems_pcmcia_remove(struct pcmcia_device *dev)\r\n{\r\nems_pcmcia_del_card(dev);\r\npcmcia_disable_device(dev);\r\n}

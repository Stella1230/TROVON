static void led_update_brightness(struct led_classdev *led_cdev)\r\n{\r\nif (led_cdev->brightness_get)\r\nled_cdev->brightness = led_cdev->brightness_get(led_cdev);\r\n}\r\nstatic ssize_t brightness_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nled_update_brightness(led_cdev);\r\nreturn sprintf(buf, "%u\n", led_cdev->brightness);\r\n}\r\nstatic ssize_t brightness_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nunsigned long state;\r\nssize_t ret = -EINVAL;\r\nret = kstrtoul(buf, 10, &state);\r\nif (ret)\r\nreturn ret;\r\nif (state == LED_OFF)\r\nled_trigger_remove(led_cdev);\r\n__led_set_brightness(led_cdev, state);\r\nreturn size;\r\n}\r\nstatic ssize_t led_max_brightness_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%u\n", led_cdev->max_brightness);\r\n}\r\nstatic void led_timer_function(unsigned long data)\r\n{\r\nstruct led_classdev *led_cdev = (void *)data;\r\nunsigned long brightness;\r\nunsigned long delay;\r\nif (!led_cdev->blink_delay_on || !led_cdev->blink_delay_off) {\r\n__led_set_brightness(led_cdev, LED_OFF);\r\nreturn;\r\n}\r\nif (led_cdev->flags & LED_BLINK_ONESHOT_STOP) {\r\nled_cdev->flags &= ~LED_BLINK_ONESHOT_STOP;\r\nreturn;\r\n}\r\nbrightness = led_get_brightness(led_cdev);\r\nif (!brightness) {\r\nbrightness = led_cdev->blink_brightness;\r\ndelay = led_cdev->blink_delay_on;\r\n} else {\r\nled_cdev->blink_brightness = brightness;\r\nbrightness = LED_OFF;\r\ndelay = led_cdev->blink_delay_off;\r\n}\r\n__led_set_brightness(led_cdev, brightness);\r\nif (led_cdev->flags & LED_BLINK_ONESHOT) {\r\nif (led_cdev->flags & LED_BLINK_INVERT) {\r\nif (brightness)\r\nled_cdev->flags |= LED_BLINK_ONESHOT_STOP;\r\n} else {\r\nif (!brightness)\r\nled_cdev->flags |= LED_BLINK_ONESHOT_STOP;\r\n}\r\n}\r\nmod_timer(&led_cdev->blink_timer, jiffies + msecs_to_jiffies(delay));\r\n}\r\nstatic void set_brightness_delayed(struct work_struct *ws)\r\n{\r\nstruct led_classdev *led_cdev =\r\ncontainer_of(ws, struct led_classdev, set_brightness_work);\r\nled_stop_software_blink(led_cdev);\r\n__led_set_brightness(led_cdev, led_cdev->delayed_set_value);\r\n}\r\nvoid led_classdev_suspend(struct led_classdev *led_cdev)\r\n{\r\nled_cdev->flags |= LED_SUSPENDED;\r\nled_cdev->brightness_set(led_cdev, 0);\r\n}\r\nvoid led_classdev_resume(struct led_classdev *led_cdev)\r\n{\r\nled_cdev->brightness_set(led_cdev, led_cdev->brightness);\r\nled_cdev->flags &= ~LED_SUSPENDED;\r\n}\r\nstatic int led_suspend(struct device *dev)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nif (led_cdev->flags & LED_CORE_SUSPENDRESUME)\r\nled_classdev_suspend(led_cdev);\r\nreturn 0;\r\n}\r\nstatic int led_resume(struct device *dev)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nif (led_cdev->flags & LED_CORE_SUSPENDRESUME)\r\nled_classdev_resume(led_cdev);\r\nreturn 0;\r\n}\r\nint led_classdev_register(struct device *parent, struct led_classdev *led_cdev)\r\n{\r\nled_cdev->dev = device_create(leds_class, parent, 0, led_cdev,\r\n"%s", led_cdev->name);\r\nif (IS_ERR(led_cdev->dev))\r\nreturn PTR_ERR(led_cdev->dev);\r\n#ifdef CONFIG_LEDS_TRIGGERS\r\ninit_rwsem(&led_cdev->trigger_lock);\r\n#endif\r\ndown_write(&leds_list_lock);\r\nlist_add_tail(&led_cdev->node, &leds_list);\r\nup_write(&leds_list_lock);\r\nif (!led_cdev->max_brightness)\r\nled_cdev->max_brightness = LED_FULL;\r\nled_update_brightness(led_cdev);\r\nINIT_WORK(&led_cdev->set_brightness_work, set_brightness_delayed);\r\ninit_timer(&led_cdev->blink_timer);\r\nled_cdev->blink_timer.function = led_timer_function;\r\nled_cdev->blink_timer.data = (unsigned long)led_cdev;\r\n#ifdef CONFIG_LEDS_TRIGGERS\r\nled_trigger_set_default(led_cdev);\r\n#endif\r\ndev_dbg(parent, "Registered led device: %s\n",\r\nled_cdev->name);\r\nreturn 0;\r\n}\r\nvoid led_classdev_unregister(struct led_classdev *led_cdev)\r\n{\r\n#ifdef CONFIG_LEDS_TRIGGERS\r\ndown_write(&led_cdev->trigger_lock);\r\nif (led_cdev->trigger)\r\nled_trigger_set(led_cdev, NULL);\r\nup_write(&led_cdev->trigger_lock);\r\n#endif\r\ncancel_work_sync(&led_cdev->set_brightness_work);\r\nled_stop_software_blink(led_cdev);\r\nled_set_brightness(led_cdev, LED_OFF);\r\ndevice_unregister(led_cdev->dev);\r\ndown_write(&leds_list_lock);\r\nlist_del(&led_cdev->node);\r\nup_write(&leds_list_lock);\r\n}\r\nstatic int __init leds_init(void)\r\n{\r\nleds_class = class_create(THIS_MODULE, "leds");\r\nif (IS_ERR(leds_class))\r\nreturn PTR_ERR(leds_class);\r\nleds_class->pm = &leds_class_dev_pm_ops;\r\nleds_class->dev_groups = led_groups;\r\nreturn 0;\r\n}\r\nstatic void __exit leds_exit(void)\r\n{\r\nclass_destroy(leds_class);\r\n}

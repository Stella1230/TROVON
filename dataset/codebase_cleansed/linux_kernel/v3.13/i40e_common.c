static i40e_status i40e_set_mac_type(struct i40e_hw *hw)\r\n{\r\ni40e_status status = 0;\r\nif (hw->vendor_id == PCI_VENDOR_ID_INTEL) {\r\nswitch (hw->device_id) {\r\ncase I40E_SFP_XL710_DEVICE_ID:\r\ncase I40E_SFP_X710_DEVICE_ID:\r\ncase I40E_QEMU_DEVICE_ID:\r\ncase I40E_KX_A_DEVICE_ID:\r\ncase I40E_KX_B_DEVICE_ID:\r\ncase I40E_KX_C_DEVICE_ID:\r\ncase I40E_KX_D_DEVICE_ID:\r\ncase I40E_QSFP_A_DEVICE_ID:\r\ncase I40E_QSFP_B_DEVICE_ID:\r\ncase I40E_QSFP_C_DEVICE_ID:\r\nhw->mac.type = I40E_MAC_XL710;\r\nbreak;\r\ncase I40E_VF_DEVICE_ID:\r\ncase I40E_VF_HV_DEVICE_ID:\r\nhw->mac.type = I40E_MAC_VF;\r\nbreak;\r\ndefault:\r\nhw->mac.type = I40E_MAC_GENERIC;\r\nbreak;\r\n}\r\n} else {\r\nstatus = I40E_ERR_DEVICE_NOT_SUPPORTED;\r\n}\r\nhw_dbg(hw, "i40e_set_mac_type found mac: %d, returns: %d\n",\r\nhw->mac.type, status);\r\nreturn status;\r\n}\r\nvoid i40e_debug_aq(struct i40e_hw *hw, enum i40e_debug_mask mask, void *desc,\r\nvoid *buffer)\r\n{\r\nstruct i40e_aq_desc *aq_desc = (struct i40e_aq_desc *)desc;\r\nu8 *aq_buffer = (u8 *)buffer;\r\nu32 data[4];\r\nu32 i = 0;\r\nif ((!(mask & hw->debug_mask)) || (desc == NULL))\r\nreturn;\r\ni40e_debug(hw, mask,\r\n"AQ CMD: opcode 0x%04X, flags 0x%04X, datalen 0x%04X, retval 0x%04X\n",\r\naq_desc->opcode, aq_desc->flags, aq_desc->datalen,\r\naq_desc->retval);\r\ni40e_debug(hw, mask, "\tcookie (h,l) 0x%08X 0x%08X\n",\r\naq_desc->cookie_high, aq_desc->cookie_low);\r\ni40e_debug(hw, mask, "\tparam (0,1) 0x%08X 0x%08X\n",\r\naq_desc->params.internal.param0,\r\naq_desc->params.internal.param1);\r\ni40e_debug(hw, mask, "\taddr (h,l) 0x%08X 0x%08X\n",\r\naq_desc->params.external.addr_high,\r\naq_desc->params.external.addr_low);\r\nif ((buffer != NULL) && (aq_desc->datalen != 0)) {\r\nmemset(data, 0, sizeof(data));\r\ni40e_debug(hw, mask, "AQ CMD Buffer:\n");\r\nfor (i = 0; i < le16_to_cpu(aq_desc->datalen); i++) {\r\ndata[((i % 16) / 4)] |=\r\n((u32)aq_buffer[i]) << (8 * (i % 4));\r\nif ((i % 16) == 15) {\r\ni40e_debug(hw, mask,\r\n"\t0x%04X %08X %08X %08X %08X\n",\r\ni - 15, data[0], data[1], data[2],\r\ndata[3]);\r\nmemset(data, 0, sizeof(data));\r\n}\r\n}\r\nif ((i % 16) != 0)\r\ni40e_debug(hw, mask, "\t0x%04X %08X %08X %08X %08X\n",\r\ni - (i % 16), data[0], data[1], data[2],\r\ndata[3]);\r\n}\r\n}\r\ni40e_status i40e_init_shared_code(struct i40e_hw *hw)\r\n{\r\ni40e_status status = 0;\r\nu32 reg;\r\nhw->phy.get_link_info = true;\r\nreg = rd32(hw, I40E_PFGEN_PORTNUM);\r\nreg = ((reg & I40E_PFGEN_PORTNUM_PORT_NUM_MASK) >>\r\nI40E_PFGEN_PORTNUM_PORT_NUM_SHIFT);\r\nhw->port = (u8)reg;\r\ni40e_set_mac_type(hw);\r\nswitch (hw->mac.type) {\r\ncase I40E_MAC_XL710:\r\nbreak;\r\ndefault:\r\nreturn I40E_ERR_DEVICE_NOT_SUPPORTED;\r\nbreak;\r\n}\r\nstatus = i40e_init_nvm(hw);\r\nreturn status;\r\n}\r\nstatic i40e_status i40e_aq_mac_address_read(struct i40e_hw *hw,\r\nu16 *flags,\r\nstruct i40e_aqc_mac_address_read_data *addrs,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_mac_address_read *cmd_data =\r\n(struct i40e_aqc_mac_address_read *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_mac_address_read);\r\ndesc.flags |= cpu_to_le16(I40E_AQ_FLAG_BUF);\r\nstatus = i40e_asq_send_command(hw, &desc, addrs,\r\nsizeof(*addrs), cmd_details);\r\n*flags = le16_to_cpu(cmd_data->command_flags);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_mac_address_write(struct i40e_hw *hw,\r\nu16 flags, u8 *mac_addr,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_mac_address_write *cmd_data =\r\n(struct i40e_aqc_mac_address_write *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc,\r\ni40e_aqc_opc_mac_address_write);\r\ncmd_data->command_flags = cpu_to_le16(flags);\r\nmemcpy(&cmd_data->mac_sal, &mac_addr[0], 4);\r\nmemcpy(&cmd_data->mac_sah, &mac_addr[4], 2);\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_get_mac_addr(struct i40e_hw *hw, u8 *mac_addr)\r\n{\r\nstruct i40e_aqc_mac_address_read_data addrs;\r\ni40e_status status;\r\nu16 flags = 0;\r\nstatus = i40e_aq_mac_address_read(hw, &flags, &addrs, NULL);\r\nif (flags & I40E_AQC_LAN_ADDR_VALID)\r\nmemcpy(mac_addr, &addrs.pf_lan_mac, sizeof(addrs.pf_lan_mac));\r\nreturn status;\r\n}\r\ni40e_status i40e_validate_mac_addr(u8 *mac_addr)\r\n{\r\ni40e_status status = 0;\r\nif (I40E_IS_MULTICAST(mac_addr)) {\r\nhw_dbg(hw, "MAC address is multicast\n");\r\nstatus = I40E_ERR_INVALID_MAC_ADDR;\r\n} else if (I40E_IS_BROADCAST(mac_addr)) {\r\nhw_dbg(hw, "MAC address is broadcast\n");\r\nstatus = I40E_ERR_INVALID_MAC_ADDR;\r\n} else if (mac_addr[0] == 0 && mac_addr[1] == 0 && mac_addr[2] == 0 &&\r\nmac_addr[3] == 0 && mac_addr[4] == 0 && mac_addr[5] == 0) {\r\nhw_dbg(hw, "MAC address is all zeros\n");\r\nstatus = I40E_ERR_INVALID_MAC_ADDR;\r\n}\r\nreturn status;\r\n}\r\ni40e_status i40e_pf_reset(struct i40e_hw *hw)\r\n{\r\nu32 wait_cnt = 0;\r\nu32 reg = 0;\r\nu32 grst_del;\r\ngrst_del = rd32(hw, I40E_GLGEN_RSTCTL) & I40E_GLGEN_RSTCTL_GRSTDEL_MASK\r\n>> I40E_GLGEN_RSTCTL_GRSTDEL_SHIFT;\r\nfor (wait_cnt = 0; wait_cnt < grst_del + 2; wait_cnt++) {\r\nreg = rd32(hw, I40E_GLGEN_RSTAT);\r\nif (!(reg & I40E_GLGEN_RSTAT_DEVSTATE_MASK))\r\nbreak;\r\nmsleep(100);\r\n}\r\nif (reg & I40E_GLGEN_RSTAT_DEVSTATE_MASK) {\r\nhw_dbg(hw, "Global reset polling failed to complete.\n");\r\nreturn I40E_ERR_RESET_FAILED;\r\n}\r\nhw->pf_id = (u8)hw->bus.func;\r\nif (!wait_cnt) {\r\nreg = rd32(hw, I40E_PFGEN_CTRL);\r\nwr32(hw, I40E_PFGEN_CTRL,\r\n(reg | I40E_PFGEN_CTRL_PFSWR_MASK));\r\nfor (wait_cnt = 0; wait_cnt < 10; wait_cnt++) {\r\nreg = rd32(hw, I40E_PFGEN_CTRL);\r\nif (!(reg & I40E_PFGEN_CTRL_PFSWR_MASK))\r\nbreak;\r\nusleep_range(1000, 2000);\r\n}\r\nif (reg & I40E_PFGEN_CTRL_PFSWR_MASK) {\r\nhw_dbg(hw, "PF reset polling failed to complete.\n");\r\nreturn I40E_ERR_RESET_FAILED;\r\n}\r\n}\r\ni40e_clear_pxe_mode(hw);\r\nreturn 0;\r\n}\r\nvoid i40e_clear_pxe_mode(struct i40e_hw *hw)\r\n{\r\nu32 reg;\r\nreg = rd32(hw, I40E_GLLAN_RCTL_0);\r\nwr32(hw, I40E_GLLAN_RCTL_0, (reg | I40E_GLLAN_RCTL_0_PXE_MODE_MASK));\r\n}\r\nu32 i40e_led_get(struct i40e_hw *hw)\r\n{\r\nu32 gpio_val = 0;\r\nu32 mode = 0;\r\nu32 port;\r\nint i;\r\nfor (i = 0; i < I40E_HW_CAP_MAX_GPIO; i++) {\r\nif (!hw->func_caps.led[i])\r\ncontinue;\r\ngpio_val = rd32(hw, I40E_GLGEN_GPIO_CTL(i));\r\nport = (gpio_val & I40E_GLGEN_GPIO_CTL_PRT_NUM_MASK)\r\n>> I40E_GLGEN_GPIO_CTL_PRT_NUM_SHIFT;\r\nif (port != hw->port)\r\ncontinue;\r\nmode = (gpio_val & I40E_GLGEN_GPIO_CTL_LED_MODE_MASK)\r\n>> I40E_GLGEN_GPIO_CTL_INT_MODE_SHIFT;\r\nbreak;\r\n}\r\nreturn mode;\r\n}\r\nvoid i40e_led_set(struct i40e_hw *hw, u32 mode)\r\n{\r\nu32 gpio_val = 0;\r\nu32 led_mode = 0;\r\nu32 port;\r\nint i;\r\nfor (i = 0; i < I40E_HW_CAP_MAX_GPIO; i++) {\r\nif (!hw->func_caps.led[i])\r\ncontinue;\r\ngpio_val = rd32(hw, I40E_GLGEN_GPIO_CTL(i));\r\nport = (gpio_val & I40E_GLGEN_GPIO_CTL_PRT_NUM_MASK)\r\n>> I40E_GLGEN_GPIO_CTL_PRT_NUM_SHIFT;\r\nif (port != hw->port)\r\ncontinue;\r\nled_mode = (mode << I40E_GLGEN_GPIO_CTL_LED_MODE_SHIFT) &\r\nI40E_GLGEN_GPIO_CTL_LED_MODE_MASK;\r\ngpio_val &= ~I40E_GLGEN_GPIO_CTL_LED_MODE_MASK;\r\ngpio_val |= led_mode;\r\nwr32(hw, I40E_GLGEN_GPIO_CTL(i), gpio_val);\r\n}\r\n}\r\ni40e_status i40e_aq_queue_shutdown(struct i40e_hw *hw,\r\nbool unloading)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_queue_shutdown *cmd =\r\n(struct i40e_aqc_queue_shutdown *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc,\r\ni40e_aqc_opc_queue_shutdown);\r\nif (unloading)\r\ncmd->driver_unloading = cpu_to_le32(I40E_AQ_DRIVER_UNLOADING);\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, NULL);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_set_link_restart_an(struct i40e_hw *hw,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_set_link_restart_an *cmd =\r\n(struct i40e_aqc_set_link_restart_an *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc,\r\ni40e_aqc_opc_set_link_restart_an);\r\ncmd->command = I40E_AQ_PHY_RESTART_AN;\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_get_link_info(struct i40e_hw *hw,\r\nbool enable_lse, struct i40e_link_status *link,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_get_link_status *resp =\r\n(struct i40e_aqc_get_link_status *)&desc.params.raw;\r\nstruct i40e_link_status *hw_link_info = &hw->phy.link_info;\r\ni40e_status status;\r\nu16 command_flags;\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_get_link_status);\r\nif (enable_lse)\r\ncommand_flags = I40E_AQ_LSE_ENABLE;\r\nelse\r\ncommand_flags = I40E_AQ_LSE_DISABLE;\r\nresp->command_flags = cpu_to_le16(command_flags);\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nif (status)\r\ngoto aq_get_link_info_exit;\r\nmemcpy(&hw->phy.link_info_old, hw_link_info,\r\nsizeof(struct i40e_link_status));\r\nhw_link_info->phy_type = (enum i40e_aq_phy_type)resp->phy_type;\r\nhw_link_info->link_speed = (enum i40e_aq_link_speed)resp->link_speed;\r\nhw_link_info->link_info = resp->link_info;\r\nhw_link_info->an_info = resp->an_info;\r\nhw_link_info->ext_info = resp->ext_info;\r\nif (resp->command_flags & cpu_to_le16(I40E_AQ_LSE_ENABLE))\r\nhw_link_info->lse_enable = true;\r\nelse\r\nhw_link_info->lse_enable = false;\r\nif (link)\r\n*link = *hw_link_info;\r\nhw->phy.get_link_info = false;\r\naq_get_link_info_exit:\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_add_vsi(struct i40e_hw *hw,\r\nstruct i40e_vsi_context *vsi_ctx,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_add_get_update_vsi *cmd =\r\n(struct i40e_aqc_add_get_update_vsi *)&desc.params.raw;\r\nstruct i40e_aqc_add_get_update_vsi_completion *resp =\r\n(struct i40e_aqc_add_get_update_vsi_completion *)\r\n&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc,\r\ni40e_aqc_opc_add_vsi);\r\ncmd->uplink_seid = cpu_to_le16(vsi_ctx->uplink_seid);\r\ncmd->connection_type = vsi_ctx->connection_type;\r\ncmd->vf_id = vsi_ctx->vf_num;\r\ncmd->vsi_flags = cpu_to_le16(vsi_ctx->flags);\r\ndesc.flags |= cpu_to_le16((u16)(I40E_AQ_FLAG_BUF | I40E_AQ_FLAG_RD));\r\nif (sizeof(vsi_ctx->info) > I40E_AQ_LARGE_BUF)\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_LB);\r\nstatus = i40e_asq_send_command(hw, &desc, &vsi_ctx->info,\r\nsizeof(vsi_ctx->info), cmd_details);\r\nif (status)\r\ngoto aq_add_vsi_exit;\r\nvsi_ctx->seid = le16_to_cpu(resp->seid);\r\nvsi_ctx->vsi_number = le16_to_cpu(resp->vsi_number);\r\nvsi_ctx->vsis_allocated = le16_to_cpu(resp->vsi_used);\r\nvsi_ctx->vsis_unallocated = le16_to_cpu(resp->vsi_free);\r\naq_add_vsi_exit:\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_set_vsi_unicast_promiscuous(struct i40e_hw *hw,\r\nu16 seid, bool set, struct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_set_vsi_promiscuous_modes *cmd =\r\n(struct i40e_aqc_set_vsi_promiscuous_modes *)&desc.params.raw;\r\ni40e_status status;\r\nu16 flags = 0;\r\ni40e_fill_default_direct_cmd_desc(&desc,\r\ni40e_aqc_opc_set_vsi_promiscuous_modes);\r\nif (set)\r\nflags |= I40E_AQC_SET_VSI_PROMISC_UNICAST;\r\ncmd->promiscuous_flags = cpu_to_le16(flags);\r\ncmd->valid_flags = cpu_to_le16(I40E_AQC_SET_VSI_PROMISC_UNICAST);\r\ncmd->seid = cpu_to_le16(seid);\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_set_vsi_multicast_promiscuous(struct i40e_hw *hw,\r\nu16 seid, bool set, struct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_set_vsi_promiscuous_modes *cmd =\r\n(struct i40e_aqc_set_vsi_promiscuous_modes *)&desc.params.raw;\r\ni40e_status status;\r\nu16 flags = 0;\r\ni40e_fill_default_direct_cmd_desc(&desc,\r\ni40e_aqc_opc_set_vsi_promiscuous_modes);\r\nif (set)\r\nflags |= I40E_AQC_SET_VSI_PROMISC_MULTICAST;\r\ncmd->promiscuous_flags = cpu_to_le16(flags);\r\ncmd->valid_flags = cpu_to_le16(I40E_AQC_SET_VSI_PROMISC_MULTICAST);\r\ncmd->seid = cpu_to_le16(seid);\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_set_vsi_broadcast(struct i40e_hw *hw,\r\nu16 seid, bool set_filter,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_set_vsi_promiscuous_modes *cmd =\r\n(struct i40e_aqc_set_vsi_promiscuous_modes *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc,\r\ni40e_aqc_opc_set_vsi_promiscuous_modes);\r\nif (set_filter)\r\ncmd->promiscuous_flags\r\n|= cpu_to_le16(I40E_AQC_SET_VSI_PROMISC_BROADCAST);\r\nelse\r\ncmd->promiscuous_flags\r\n&= cpu_to_le16(~I40E_AQC_SET_VSI_PROMISC_BROADCAST);\r\ncmd->valid_flags = cpu_to_le16(I40E_AQC_SET_VSI_PROMISC_BROADCAST);\r\ncmd->seid = cpu_to_le16(seid);\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_get_vsi_params(struct i40e_hw *hw,\r\nstruct i40e_vsi_context *vsi_ctx,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_switch_seid *cmd =\r\n(struct i40e_aqc_switch_seid *)&desc.params.raw;\r\nstruct i40e_aqc_add_get_update_vsi_completion *resp =\r\n(struct i40e_aqc_add_get_update_vsi_completion *)\r\n&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc,\r\ni40e_aqc_opc_get_vsi_parameters);\r\ncmd->seid = cpu_to_le16(vsi_ctx->seid);\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_BUF);\r\nif (sizeof(vsi_ctx->info) > I40E_AQ_LARGE_BUF)\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_LB);\r\nstatus = i40e_asq_send_command(hw, &desc, &vsi_ctx->info,\r\nsizeof(vsi_ctx->info), NULL);\r\nif (status)\r\ngoto aq_get_vsi_params_exit;\r\nvsi_ctx->seid = le16_to_cpu(resp->seid);\r\nvsi_ctx->vsi_number = le16_to_cpu(resp->vsi_number);\r\nvsi_ctx->vsis_allocated = le16_to_cpu(resp->vsi_used);\r\nvsi_ctx->vsis_unallocated = le16_to_cpu(resp->vsi_free);\r\naq_get_vsi_params_exit:\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_update_vsi_params(struct i40e_hw *hw,\r\nstruct i40e_vsi_context *vsi_ctx,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_switch_seid *cmd =\r\n(struct i40e_aqc_switch_seid *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc,\r\ni40e_aqc_opc_update_vsi_parameters);\r\ncmd->seid = cpu_to_le16(vsi_ctx->seid);\r\ndesc.flags |= cpu_to_le16((u16)(I40E_AQ_FLAG_BUF | I40E_AQ_FLAG_RD));\r\nif (sizeof(vsi_ctx->info) > I40E_AQ_LARGE_BUF)\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_LB);\r\nstatus = i40e_asq_send_command(hw, &desc, &vsi_ctx->info,\r\nsizeof(vsi_ctx->info), cmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_get_switch_config(struct i40e_hw *hw,\r\nstruct i40e_aqc_get_switch_config_resp *buf,\r\nu16 buf_size, u16 *start_seid,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_switch_seid *scfg =\r\n(struct i40e_aqc_switch_seid *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc,\r\ni40e_aqc_opc_get_switch_config);\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_BUF);\r\nif (buf_size > I40E_AQ_LARGE_BUF)\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_LB);\r\nscfg->seid = cpu_to_le16(*start_seid);\r\nstatus = i40e_asq_send_command(hw, &desc, buf, buf_size, cmd_details);\r\n*start_seid = le16_to_cpu(scfg->seid);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_get_firmware_version(struct i40e_hw *hw,\r\nu16 *fw_major_version, u16 *fw_minor_version,\r\nu16 *api_major_version, u16 *api_minor_version,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_get_version *resp =\r\n(struct i40e_aqc_get_version *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_get_version);\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nif (!status) {\r\nif (fw_major_version != NULL)\r\n*fw_major_version = le16_to_cpu(resp->fw_major);\r\nif (fw_minor_version != NULL)\r\n*fw_minor_version = le16_to_cpu(resp->fw_minor);\r\nif (api_major_version != NULL)\r\n*api_major_version = le16_to_cpu(resp->api_major);\r\nif (api_minor_version != NULL)\r\n*api_minor_version = le16_to_cpu(resp->api_minor);\r\n}\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_send_driver_version(struct i40e_hw *hw,\r\nstruct i40e_driver_version *dv,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_driver_version *cmd =\r\n(struct i40e_aqc_driver_version *)&desc.params.raw;\r\ni40e_status status;\r\nif (dv == NULL)\r\nreturn I40E_ERR_PARAM;\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_driver_version);\r\ndesc.flags |= cpu_to_le16(I40E_AQ_FLAG_SI);\r\ncmd->driver_major_ver = dv->major_version;\r\ncmd->driver_minor_ver = dv->minor_version;\r\ncmd->driver_build_ver = dv->build_version;\r\ncmd->driver_subbuild_ver = dv->subbuild_version;\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nreturn status;\r\n}\r\nbool i40e_get_link_status(struct i40e_hw *hw)\r\n{\r\ni40e_status status = 0;\r\nbool link_status = false;\r\nif (hw->phy.get_link_info) {\r\nstatus = i40e_aq_get_link_info(hw, true, NULL, NULL);\r\nif (status)\r\ngoto i40e_get_link_status_exit;\r\n}\r\nlink_status = hw->phy.link_info.link_info & I40E_AQ_LINK_UP;\r\ni40e_get_link_status_exit:\r\nreturn link_status;\r\n}\r\ni40e_status i40e_aq_add_veb(struct i40e_hw *hw, u16 uplink_seid,\r\nu16 downlink_seid, u8 enabled_tc,\r\nbool default_port, u16 *veb_seid,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_add_veb *cmd =\r\n(struct i40e_aqc_add_veb *)&desc.params.raw;\r\nstruct i40e_aqc_add_veb_completion *resp =\r\n(struct i40e_aqc_add_veb_completion *)&desc.params.raw;\r\ni40e_status status;\r\nu16 veb_flags = 0;\r\nif (!!uplink_seid != !!downlink_seid)\r\nreturn I40E_ERR_PARAM;\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_add_veb);\r\ncmd->uplink_seid = cpu_to_le16(uplink_seid);\r\ncmd->downlink_seid = cpu_to_le16(downlink_seid);\r\ncmd->enable_tcs = enabled_tc;\r\nif (!uplink_seid)\r\nveb_flags |= I40E_AQC_ADD_VEB_FLOATING;\r\nif (default_port)\r\nveb_flags |= I40E_AQC_ADD_VEB_PORT_TYPE_DEFAULT;\r\nelse\r\nveb_flags |= I40E_AQC_ADD_VEB_PORT_TYPE_DATA;\r\ncmd->veb_flags = cpu_to_le16(veb_flags);\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nif (!status && veb_seid)\r\n*veb_seid = le16_to_cpu(resp->veb_seid);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_get_veb_parameters(struct i40e_hw *hw,\r\nu16 veb_seid, u16 *switch_id,\r\nbool *floating, u16 *statistic_index,\r\nu16 *vebs_used, u16 *vebs_free,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_get_veb_parameters_completion *cmd_resp =\r\n(struct i40e_aqc_get_veb_parameters_completion *)\r\n&desc.params.raw;\r\ni40e_status status;\r\nif (veb_seid == 0)\r\nreturn I40E_ERR_PARAM;\r\ni40e_fill_default_direct_cmd_desc(&desc,\r\ni40e_aqc_opc_get_veb_parameters);\r\ncmd_resp->seid = cpu_to_le16(veb_seid);\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nif (status)\r\ngoto get_veb_exit;\r\nif (switch_id)\r\n*switch_id = le16_to_cpu(cmd_resp->switch_id);\r\nif (statistic_index)\r\n*statistic_index = le16_to_cpu(cmd_resp->statistic_index);\r\nif (vebs_used)\r\n*vebs_used = le16_to_cpu(cmd_resp->vebs_used);\r\nif (vebs_free)\r\n*vebs_free = le16_to_cpu(cmd_resp->vebs_free);\r\nif (floating) {\r\nu16 flags = le16_to_cpu(cmd_resp->veb_flags);\r\nif (flags & I40E_AQC_ADD_VEB_FLOATING)\r\n*floating = true;\r\nelse\r\n*floating = false;\r\n}\r\nget_veb_exit:\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_add_macvlan(struct i40e_hw *hw, u16 seid,\r\nstruct i40e_aqc_add_macvlan_element_data *mv_list,\r\nu16 count, struct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_macvlan *cmd =\r\n(struct i40e_aqc_macvlan *)&desc.params.raw;\r\ni40e_status status;\r\nu16 buf_size;\r\nif (count == 0 || !mv_list || !hw)\r\nreturn I40E_ERR_PARAM;\r\nbuf_size = count * sizeof(struct i40e_aqc_add_macvlan_element_data);\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_add_macvlan);\r\ncmd->num_addresses = cpu_to_le16(count);\r\ncmd->seid[0] = cpu_to_le16(I40E_AQC_MACVLAN_CMD_SEID_VALID | seid);\r\ncmd->seid[1] = 0;\r\ncmd->seid[2] = 0;\r\ndesc.flags |= cpu_to_le16((u16)(I40E_AQ_FLAG_BUF | I40E_AQ_FLAG_RD));\r\nif (buf_size > I40E_AQ_LARGE_BUF)\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_LB);\r\nstatus = i40e_asq_send_command(hw, &desc, mv_list, buf_size,\r\ncmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_remove_macvlan(struct i40e_hw *hw, u16 seid,\r\nstruct i40e_aqc_remove_macvlan_element_data *mv_list,\r\nu16 count, struct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_macvlan *cmd =\r\n(struct i40e_aqc_macvlan *)&desc.params.raw;\r\ni40e_status status;\r\nu16 buf_size;\r\nif (count == 0 || !mv_list || !hw)\r\nreturn I40E_ERR_PARAM;\r\nbuf_size = count * sizeof(struct i40e_aqc_remove_macvlan_element_data);\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_remove_macvlan);\r\ncmd->num_addresses = cpu_to_le16(count);\r\ncmd->seid[0] = cpu_to_le16(I40E_AQC_MACVLAN_CMD_SEID_VALID | seid);\r\ncmd->seid[1] = 0;\r\ncmd->seid[2] = 0;\r\ndesc.flags |= cpu_to_le16((u16)(I40E_AQ_FLAG_BUF | I40E_AQ_FLAG_RD));\r\nif (buf_size > I40E_AQ_LARGE_BUF)\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_LB);\r\nstatus = i40e_asq_send_command(hw, &desc, mv_list, buf_size,\r\ncmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_add_vlan(struct i40e_hw *hw, u16 seid,\r\nstruct i40e_aqc_add_remove_vlan_element_data *v_list,\r\nu8 count, struct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_macvlan *cmd =\r\n(struct i40e_aqc_macvlan *)&desc.params.raw;\r\ni40e_status status;\r\nu16 buf_size;\r\nif (count == 0 || !v_list || !hw)\r\nreturn I40E_ERR_PARAM;\r\nbuf_size = count * sizeof(struct i40e_aqc_add_remove_vlan_element_data);\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_add_vlan);\r\ncmd->num_addresses = cpu_to_le16(count);\r\ncmd->seid[0] = cpu_to_le16(seid | I40E_AQC_MACVLAN_CMD_SEID_VALID);\r\ncmd->seid[1] = 0;\r\ncmd->seid[2] = 0;\r\ndesc.flags |= cpu_to_le16((u16)(I40E_AQ_FLAG_BUF | I40E_AQ_FLAG_RD));\r\nif (buf_size > I40E_AQ_LARGE_BUF)\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_LB);\r\nstatus = i40e_asq_send_command(hw, &desc, v_list, buf_size,\r\ncmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_remove_vlan(struct i40e_hw *hw, u16 seid,\r\nstruct i40e_aqc_add_remove_vlan_element_data *v_list,\r\nu8 count, struct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_macvlan *cmd =\r\n(struct i40e_aqc_macvlan *)&desc.params.raw;\r\ni40e_status status;\r\nu16 buf_size;\r\nif (count == 0 || !v_list || !hw)\r\nreturn I40E_ERR_PARAM;\r\nbuf_size = count * sizeof(struct i40e_aqc_add_remove_vlan_element_data);\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_remove_vlan);\r\ncmd->num_addresses = cpu_to_le16(count);\r\ncmd->seid[0] = cpu_to_le16(seid | I40E_AQC_MACVLAN_CMD_SEID_VALID);\r\ncmd->seid[1] = 0;\r\ncmd->seid[2] = 0;\r\ndesc.flags |= cpu_to_le16((u16)(I40E_AQ_FLAG_BUF | I40E_AQ_FLAG_RD));\r\nif (buf_size > I40E_AQ_LARGE_BUF)\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_LB);\r\nstatus = i40e_asq_send_command(hw, &desc, v_list, buf_size,\r\ncmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_send_msg_to_vf(struct i40e_hw *hw, u16 vfid,\r\nu32 v_opcode, u32 v_retval, u8 *msg, u16 msglen,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_pf_vf_message *cmd =\r\n(struct i40e_aqc_pf_vf_message *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_send_msg_to_vf);\r\ncmd->id = cpu_to_le32(vfid);\r\ndesc.cookie_high = cpu_to_le32(v_opcode);\r\ndesc.cookie_low = cpu_to_le32(v_retval);\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_SI);\r\nif (msglen) {\r\ndesc.flags |= cpu_to_le16((u16)(I40E_AQ_FLAG_BUF |\r\nI40E_AQ_FLAG_RD));\r\nif (msglen > I40E_AQ_LARGE_BUF)\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_LB);\r\ndesc.datalen = cpu_to_le16(msglen);\r\n}\r\nstatus = i40e_asq_send_command(hw, &desc, msg, msglen, cmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_set_hmc_resource_profile(struct i40e_hw *hw,\r\nenum i40e_aq_hmc_profile profile,\r\nu8 pe_vf_enabled_count,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aq_get_set_hmc_resource_profile *cmd =\r\n(struct i40e_aq_get_set_hmc_resource_profile *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc,\r\ni40e_aqc_opc_set_hmc_resource_profile);\r\ncmd->pm_profile = (u8)profile;\r\ncmd->pe_vf_enabled = pe_vf_enabled_count;\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_request_resource(struct i40e_hw *hw,\r\nenum i40e_aq_resources_ids resource,\r\nenum i40e_aq_resource_access_type access,\r\nu8 sdp_number, u64 *timeout,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_request_resource *cmd_resp =\r\n(struct i40e_aqc_request_resource *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_request_resource);\r\ncmd_resp->resource_id = cpu_to_le16(resource);\r\ncmd_resp->access_type = cpu_to_le16(access);\r\ncmd_resp->resource_number = cpu_to_le32(sdp_number);\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nif (!status || hw->aq.asq_last_status == I40E_AQ_RC_EBUSY)\r\n*timeout = le32_to_cpu(cmd_resp->timeout);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_release_resource(struct i40e_hw *hw,\r\nenum i40e_aq_resources_ids resource,\r\nu8 sdp_number,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_request_resource *cmd =\r\n(struct i40e_aqc_request_resource *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_release_resource);\r\ncmd->resource_id = cpu_to_le16(resource);\r\ncmd->resource_number = cpu_to_le32(sdp_number);\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_read_nvm(struct i40e_hw *hw, u8 module_pointer,\r\nu32 offset, u16 length, void *data,\r\nbool last_command,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_nvm_update *cmd =\r\n(struct i40e_aqc_nvm_update *)&desc.params.raw;\r\ni40e_status status;\r\nif (offset & 0xFF000000) {\r\nstatus = I40E_ERR_PARAM;\r\ngoto i40e_aq_read_nvm_exit;\r\n}\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_nvm_read);\r\nif (last_command)\r\ncmd->command_flags |= I40E_AQ_NVM_LAST_CMD;\r\ncmd->module_pointer = module_pointer;\r\ncmd->offset = cpu_to_le32(offset);\r\ncmd->length = cpu_to_le16(length);\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_BUF);\r\nif (length > I40E_AQ_LARGE_BUF)\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_LB);\r\nstatus = i40e_asq_send_command(hw, &desc, data, length, cmd_details);\r\ni40e_aq_read_nvm_exit:\r\nreturn status;\r\n}\r\nstatic void i40e_parse_discover_capabilities(struct i40e_hw *hw, void *buff,\r\nu32 cap_count,\r\nenum i40e_admin_queue_opc list_type_opc)\r\n{\r\nstruct i40e_aqc_list_capabilities_element_resp *cap;\r\nu32 number, logical_id, phys_id;\r\nstruct i40e_hw_capabilities *p;\r\nu32 reg_val;\r\nu32 i = 0;\r\nu16 id;\r\ncap = (struct i40e_aqc_list_capabilities_element_resp *) buff;\r\nif (list_type_opc == i40e_aqc_opc_list_dev_capabilities)\r\np = (struct i40e_hw_capabilities *)&hw->dev_caps;\r\nelse if (list_type_opc == i40e_aqc_opc_list_func_capabilities)\r\np = (struct i40e_hw_capabilities *)&hw->func_caps;\r\nelse\r\nreturn;\r\nfor (i = 0; i < cap_count; i++, cap++) {\r\nid = le16_to_cpu(cap->id);\r\nnumber = le32_to_cpu(cap->number);\r\nlogical_id = le32_to_cpu(cap->logical_id);\r\nphys_id = le32_to_cpu(cap->phys_id);\r\nswitch (id) {\r\ncase I40E_DEV_FUNC_CAP_SWITCH_MODE:\r\np->switch_mode = number;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_MGMT_MODE:\r\np->management_mode = number;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_NPAR:\r\np->npar_enable = number;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_OS2BMC:\r\np->os2bmc = number;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_VALID_FUNC:\r\np->valid_functions = number;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_SRIOV_1_1:\r\nif (number == 1)\r\np->sr_iov_1_1 = true;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_VF:\r\np->num_vfs = number;\r\np->vf_base_id = logical_id;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_VMDQ:\r\nif (number == 1)\r\np->vmdq = true;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_802_1_QBG:\r\nif (number == 1)\r\np->evb_802_1_qbg = true;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_802_1_QBH:\r\nif (number == 1)\r\np->evb_802_1_qbh = true;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_VSI:\r\np->num_vsis = number;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_DCB:\r\nif (number == 1) {\r\np->dcb = true;\r\np->enabled_tcmap = logical_id;\r\np->maxtc = phys_id;\r\n}\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_FCOE:\r\nif (number == 1)\r\np->fcoe = true;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_RSS:\r\np->rss = true;\r\nreg_val = rd32(hw, I40E_PFQF_CTL_0);\r\nif (reg_val & I40E_PFQF_CTL_0_HASHLUTSIZE_MASK)\r\np->rss_table_size = number;\r\nelse\r\np->rss_table_size = 128;\r\np->rss_table_entry_width = logical_id;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_RX_QUEUES:\r\np->num_rx_qp = number;\r\np->base_queue = phys_id;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_TX_QUEUES:\r\np->num_tx_qp = number;\r\np->base_queue = phys_id;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_MSIX:\r\np->num_msix_vectors = number;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_MSIX_VF:\r\np->num_msix_vectors_vf = number;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_MFP_MODE_1:\r\nif (number == 1)\r\np->mfp_mode_1 = true;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_CEM:\r\nif (number == 1)\r\np->mgmt_cem = true;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_IWARP:\r\nif (number == 1)\r\np->iwarp = true;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_LED:\r\nif (phys_id < I40E_HW_CAP_MAX_GPIO)\r\np->led[phys_id] = true;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_SDP:\r\nif (phys_id < I40E_HW_CAP_MAX_GPIO)\r\np->sdp[phys_id] = true;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_MDIO:\r\nif (number == 1) {\r\np->mdio_port_num = phys_id;\r\np->mdio_port_mode = logical_id;\r\n}\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_IEEE_1588:\r\nif (number == 1)\r\np->ieee_1588 = true;\r\nbreak;\r\ncase I40E_DEV_FUNC_CAP_FLOW_DIRECTOR:\r\np->fd = true;\r\np->fd_filters_guaranteed = number;\r\np->fd_filters_best_effort = logical_id;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\np->rx_buf_chain_len = I40E_MAX_CHAINED_RX_BUFFERS;\r\n}\r\ni40e_status i40e_aq_discover_capabilities(struct i40e_hw *hw,\r\nvoid *buff, u16 buff_size, u16 *data_size,\r\nenum i40e_admin_queue_opc list_type_opc,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aqc_list_capabilites *cmd;\r\ni40e_status status = 0;\r\nstruct i40e_aq_desc desc;\r\ncmd = (struct i40e_aqc_list_capabilites *)&desc.params.raw;\r\nif (list_type_opc != i40e_aqc_opc_list_func_capabilities &&\r\nlist_type_opc != i40e_aqc_opc_list_dev_capabilities) {\r\nstatus = I40E_ERR_PARAM;\r\ngoto exit;\r\n}\r\ni40e_fill_default_direct_cmd_desc(&desc, list_type_opc);\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_BUF);\r\nif (buff_size > I40E_AQ_LARGE_BUF)\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_LB);\r\nstatus = i40e_asq_send_command(hw, &desc, buff, buff_size, cmd_details);\r\n*data_size = le16_to_cpu(desc.datalen);\r\nif (status)\r\ngoto exit;\r\ni40e_parse_discover_capabilities(hw, buff, le32_to_cpu(cmd->count),\r\nlist_type_opc);\r\nexit:\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_get_lldp_mib(struct i40e_hw *hw, u8 bridge_type,\r\nu8 mib_type, void *buff, u16 buff_size,\r\nu16 *local_len, u16 *remote_len,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_lldp_get_mib *cmd =\r\n(struct i40e_aqc_lldp_get_mib *)&desc.params.raw;\r\nstruct i40e_aqc_lldp_get_mib *resp =\r\n(struct i40e_aqc_lldp_get_mib *)&desc.params.raw;\r\ni40e_status status;\r\nif (buff_size == 0 || !buff)\r\nreturn I40E_ERR_PARAM;\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_lldp_get_mib);\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_BUF);\r\ncmd->type = mib_type & I40E_AQ_LLDP_MIB_TYPE_MASK;\r\ncmd->type |= ((bridge_type << I40E_AQ_LLDP_BRIDGE_TYPE_SHIFT) &\r\nI40E_AQ_LLDP_BRIDGE_TYPE_MASK);\r\ndesc.datalen = cpu_to_le16(buff_size);\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_BUF);\r\nif (buff_size > I40E_AQ_LARGE_BUF)\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_LB);\r\nstatus = i40e_asq_send_command(hw, &desc, buff, buff_size, cmd_details);\r\nif (!status) {\r\nif (local_len != NULL)\r\n*local_len = le16_to_cpu(resp->local_len);\r\nif (remote_len != NULL)\r\n*remote_len = le16_to_cpu(resp->remote_len);\r\n}\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_cfg_lldp_mib_change_event(struct i40e_hw *hw,\r\nbool enable_update,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_lldp_update_mib *cmd =\r\n(struct i40e_aqc_lldp_update_mib *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_lldp_update_mib);\r\nif (!enable_update)\r\ncmd->command |= I40E_AQ_LLDP_MIB_UPDATE_DISABLE;\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_stop_lldp(struct i40e_hw *hw, bool shutdown_agent,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_lldp_stop *cmd =\r\n(struct i40e_aqc_lldp_stop *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_lldp_stop);\r\nif (shutdown_agent)\r\ncmd->command |= I40E_AQ_LLDP_AGENT_SHUTDOWN;\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_start_lldp(struct i40e_hw *hw,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_lldp_start *cmd =\r\n(struct i40e_aqc_lldp_start *)&desc.params.raw;\r\ni40e_status status;\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_lldp_start);\r\ncmd->command = I40E_AQ_LLDP_AGENT_START;\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_delete_element(struct i40e_hw *hw, u16 seid,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_switch_seid *cmd =\r\n(struct i40e_aqc_switch_seid *)&desc.params.raw;\r\ni40e_status status;\r\nif (seid == 0)\r\nreturn I40E_ERR_PARAM;\r\ni40e_fill_default_direct_cmd_desc(&desc, i40e_aqc_opc_delete_element);\r\ncmd->seid = cpu_to_le16(seid);\r\nstatus = i40e_asq_send_command(hw, &desc, NULL, 0, cmd_details);\r\nreturn status;\r\n}\r\nstatic i40e_status i40e_aq_tx_sched_cmd(struct i40e_hw *hw, u16 seid,\r\nvoid *buff, u16 buff_size,\r\nenum i40e_admin_queue_opc opcode,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nstruct i40e_aq_desc desc;\r\nstruct i40e_aqc_tx_sched_ind *cmd =\r\n(struct i40e_aqc_tx_sched_ind *)&desc.params.raw;\r\ni40e_status status;\r\nbool cmd_param_flag = false;\r\nswitch (opcode) {\r\ncase i40e_aqc_opc_configure_vsi_ets_sla_bw_limit:\r\ncase i40e_aqc_opc_configure_vsi_tc_bw:\r\ncase i40e_aqc_opc_enable_switching_comp_ets:\r\ncase i40e_aqc_opc_modify_switching_comp_ets:\r\ncase i40e_aqc_opc_disable_switching_comp_ets:\r\ncase i40e_aqc_opc_configure_switching_comp_ets_bw_limit:\r\ncase i40e_aqc_opc_configure_switching_comp_bw_config:\r\ncmd_param_flag = true;\r\nbreak;\r\ncase i40e_aqc_opc_query_vsi_bw_config:\r\ncase i40e_aqc_opc_query_vsi_ets_sla_config:\r\ncase i40e_aqc_opc_query_switching_comp_ets_config:\r\ncase i40e_aqc_opc_query_port_ets_config:\r\ncase i40e_aqc_opc_query_switching_comp_bw_config:\r\ncmd_param_flag = false;\r\nbreak;\r\ndefault:\r\nreturn I40E_ERR_PARAM;\r\n}\r\ni40e_fill_default_direct_cmd_desc(&desc, opcode);\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_BUF);\r\nif (cmd_param_flag)\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_RD);\r\nif (buff_size > I40E_AQ_LARGE_BUF)\r\ndesc.flags |= cpu_to_le16((u16)I40E_AQ_FLAG_LB);\r\ndesc.datalen = cpu_to_le16(buff_size);\r\ncmd->vsi_seid = cpu_to_le16(seid);\r\nstatus = i40e_asq_send_command(hw, &desc, buff, buff_size, cmd_details);\r\nreturn status;\r\n}\r\ni40e_status i40e_aq_config_vsi_tc_bw(struct i40e_hw *hw,\r\nu16 seid,\r\nstruct i40e_aqc_configure_vsi_tc_bw_data *bw_data,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nreturn i40e_aq_tx_sched_cmd(hw, seid, (void *)bw_data, sizeof(*bw_data),\r\ni40e_aqc_opc_configure_vsi_tc_bw,\r\ncmd_details);\r\n}\r\ni40e_status i40e_aq_query_vsi_bw_config(struct i40e_hw *hw,\r\nu16 seid,\r\nstruct i40e_aqc_query_vsi_bw_config_resp *bw_data,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nreturn i40e_aq_tx_sched_cmd(hw, seid, (void *)bw_data, sizeof(*bw_data),\r\ni40e_aqc_opc_query_vsi_bw_config,\r\ncmd_details);\r\n}\r\ni40e_status i40e_aq_query_vsi_ets_sla_config(struct i40e_hw *hw,\r\nu16 seid,\r\nstruct i40e_aqc_query_vsi_ets_sla_config_resp *bw_data,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nreturn i40e_aq_tx_sched_cmd(hw, seid, (void *)bw_data, sizeof(*bw_data),\r\ni40e_aqc_opc_query_vsi_ets_sla_config,\r\ncmd_details);\r\n}\r\ni40e_status i40e_aq_query_switch_comp_ets_config(struct i40e_hw *hw,\r\nu16 seid,\r\nstruct i40e_aqc_query_switching_comp_ets_config_resp *bw_data,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nreturn i40e_aq_tx_sched_cmd(hw, seid, (void *)bw_data, sizeof(*bw_data),\r\ni40e_aqc_opc_query_switching_comp_ets_config,\r\ncmd_details);\r\n}\r\ni40e_status i40e_aq_query_port_ets_config(struct i40e_hw *hw,\r\nu16 seid,\r\nstruct i40e_aqc_query_port_ets_config_resp *bw_data,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nreturn i40e_aq_tx_sched_cmd(hw, seid, (void *)bw_data, sizeof(*bw_data),\r\ni40e_aqc_opc_query_port_ets_config,\r\ncmd_details);\r\n}\r\ni40e_status i40e_aq_query_switch_comp_bw_config(struct i40e_hw *hw,\r\nu16 seid,\r\nstruct i40e_aqc_query_switching_comp_bw_config_resp *bw_data,\r\nstruct i40e_asq_cmd_details *cmd_details)\r\n{\r\nreturn i40e_aq_tx_sched_cmd(hw, seid, (void *)bw_data, sizeof(*bw_data),\r\ni40e_aqc_opc_query_switching_comp_bw_config,\r\ncmd_details);\r\n}\r\nstatic i40e_status i40e_validate_filter_settings(struct i40e_hw *hw,\r\nstruct i40e_filter_control_settings *settings)\r\n{\r\nu32 fcoe_cntx_size, fcoe_filt_size;\r\nu32 pe_cntx_size, pe_filt_size;\r\nu32 fcoe_fmax, pe_fmax;\r\nu32 val;\r\nswitch (settings->fcoe_filt_num) {\r\ncase I40E_HASH_FILTER_SIZE_1K:\r\ncase I40E_HASH_FILTER_SIZE_2K:\r\ncase I40E_HASH_FILTER_SIZE_4K:\r\ncase I40E_HASH_FILTER_SIZE_8K:\r\ncase I40E_HASH_FILTER_SIZE_16K:\r\ncase I40E_HASH_FILTER_SIZE_32K:\r\nfcoe_filt_size = I40E_HASH_FILTER_BASE_SIZE;\r\nfcoe_filt_size <<= (u32)settings->fcoe_filt_num;\r\nbreak;\r\ndefault:\r\nreturn I40E_ERR_PARAM;\r\n}\r\nswitch (settings->fcoe_cntx_num) {\r\ncase I40E_DMA_CNTX_SIZE_512:\r\ncase I40E_DMA_CNTX_SIZE_1K:\r\ncase I40E_DMA_CNTX_SIZE_2K:\r\ncase I40E_DMA_CNTX_SIZE_4K:\r\nfcoe_cntx_size = I40E_DMA_CNTX_BASE_SIZE;\r\nfcoe_cntx_size <<= (u32)settings->fcoe_cntx_num;\r\nbreak;\r\ndefault:\r\nreturn I40E_ERR_PARAM;\r\n}\r\nswitch (settings->pe_filt_num) {\r\ncase I40E_HASH_FILTER_SIZE_1K:\r\ncase I40E_HASH_FILTER_SIZE_2K:\r\ncase I40E_HASH_FILTER_SIZE_4K:\r\ncase I40E_HASH_FILTER_SIZE_8K:\r\ncase I40E_HASH_FILTER_SIZE_16K:\r\ncase I40E_HASH_FILTER_SIZE_32K:\r\ncase I40E_HASH_FILTER_SIZE_64K:\r\ncase I40E_HASH_FILTER_SIZE_128K:\r\ncase I40E_HASH_FILTER_SIZE_256K:\r\ncase I40E_HASH_FILTER_SIZE_512K:\r\ncase I40E_HASH_FILTER_SIZE_1M:\r\npe_filt_size = I40E_HASH_FILTER_BASE_SIZE;\r\npe_filt_size <<= (u32)settings->pe_filt_num;\r\nbreak;\r\ndefault:\r\nreturn I40E_ERR_PARAM;\r\n}\r\nswitch (settings->pe_cntx_num) {\r\ncase I40E_DMA_CNTX_SIZE_512:\r\ncase I40E_DMA_CNTX_SIZE_1K:\r\ncase I40E_DMA_CNTX_SIZE_2K:\r\ncase I40E_DMA_CNTX_SIZE_4K:\r\ncase I40E_DMA_CNTX_SIZE_8K:\r\ncase I40E_DMA_CNTX_SIZE_16K:\r\ncase I40E_DMA_CNTX_SIZE_32K:\r\ncase I40E_DMA_CNTX_SIZE_64K:\r\ncase I40E_DMA_CNTX_SIZE_128K:\r\ncase I40E_DMA_CNTX_SIZE_256K:\r\npe_cntx_size = I40E_DMA_CNTX_BASE_SIZE;\r\npe_cntx_size <<= (u32)settings->pe_cntx_num;\r\nbreak;\r\ndefault:\r\nreturn I40E_ERR_PARAM;\r\n}\r\nval = rd32(hw, I40E_GLHMC_FCOEFMAX);\r\nfcoe_fmax = (val & I40E_GLHMC_FCOEFMAX_PMFCOEFMAX_MASK)\r\n>> I40E_GLHMC_FCOEFMAX_PMFCOEFMAX_SHIFT;\r\nif (fcoe_filt_size + fcoe_cntx_size > fcoe_fmax)\r\nreturn I40E_ERR_INVALID_SIZE;\r\nval = rd32(hw, I40E_GLHMC_PEXFMAX);\r\npe_fmax = (val & I40E_GLHMC_PEXFMAX_PMPEXFMAX_MASK)\r\n>> I40E_GLHMC_PEXFMAX_PMPEXFMAX_SHIFT;\r\nif (pe_filt_size + pe_cntx_size > pe_fmax)\r\nreturn I40E_ERR_INVALID_SIZE;\r\nreturn 0;\r\n}\r\ni40e_status i40e_set_filter_control(struct i40e_hw *hw,\r\nstruct i40e_filter_control_settings *settings)\r\n{\r\ni40e_status ret = 0;\r\nu32 hash_lut_size = 0;\r\nu32 val;\r\nif (!settings)\r\nreturn I40E_ERR_PARAM;\r\nret = i40e_validate_filter_settings(hw, settings);\r\nif (ret)\r\nreturn ret;\r\nval = rd32(hw, I40E_PFQF_CTL_0);\r\nval &= ~I40E_PFQF_CTL_0_PEHSIZE_MASK;\r\nval |= ((u32)settings->pe_filt_num << I40E_PFQF_CTL_0_PEHSIZE_SHIFT) &\r\nI40E_PFQF_CTL_0_PEHSIZE_MASK;\r\nval &= ~I40E_PFQF_CTL_0_PEDSIZE_MASK;\r\nval |= ((u32)settings->pe_cntx_num << I40E_PFQF_CTL_0_PEDSIZE_SHIFT) &\r\nI40E_PFQF_CTL_0_PEDSIZE_MASK;\r\nval &= ~I40E_PFQF_CTL_0_PFFCHSIZE_MASK;\r\nval |= ((u32)settings->fcoe_filt_num <<\r\nI40E_PFQF_CTL_0_PFFCHSIZE_SHIFT) &\r\nI40E_PFQF_CTL_0_PFFCHSIZE_MASK;\r\nval &= ~I40E_PFQF_CTL_0_PFFCDSIZE_MASK;\r\nval |= ((u32)settings->fcoe_cntx_num <<\r\nI40E_PFQF_CTL_0_PFFCDSIZE_SHIFT) &\r\nI40E_PFQF_CTL_0_PFFCDSIZE_MASK;\r\nval &= ~I40E_PFQF_CTL_0_HASHLUTSIZE_MASK;\r\nif (settings->hash_lut_size == I40E_HASH_LUT_SIZE_512)\r\nhash_lut_size = 1;\r\nval |= (hash_lut_size << I40E_PFQF_CTL_0_HASHLUTSIZE_SHIFT) &\r\nI40E_PFQF_CTL_0_HASHLUTSIZE_MASK;\r\nif (settings->enable_fdir)\r\nval |= I40E_PFQF_CTL_0_FD_ENA_MASK;\r\nif (settings->enable_ethtype)\r\nval |= I40E_PFQF_CTL_0_ETYPE_ENA_MASK;\r\nif (settings->enable_macvlan)\r\nval |= I40E_PFQF_CTL_0_MACVLAN_ENA_MASK;\r\nwr32(hw, I40E_PFQF_CTL_0, val);\r\nreturn 0;\r\n}

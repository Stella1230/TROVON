static int compat_i915_batchbuffer(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_i915_batchbuffer32_t batchbuffer32;\r\ndrm_i915_batchbuffer_t __user *batchbuffer;\r\nif (copy_from_user\r\n(&batchbuffer32, (void __user *)arg, sizeof(batchbuffer32)))\r\nreturn -EFAULT;\r\nbatchbuffer = compat_alloc_user_space(sizeof(*batchbuffer));\r\nif (!access_ok(VERIFY_WRITE, batchbuffer, sizeof(*batchbuffer))\r\n|| __put_user(batchbuffer32.start, &batchbuffer->start)\r\n|| __put_user(batchbuffer32.used, &batchbuffer->used)\r\n|| __put_user(batchbuffer32.DR1, &batchbuffer->DR1)\r\n|| __put_user(batchbuffer32.DR4, &batchbuffer->DR4)\r\n|| __put_user(batchbuffer32.num_cliprects,\r\n&batchbuffer->num_cliprects)\r\n|| __put_user((int __user *)(unsigned long)batchbuffer32.cliprects,\r\n&batchbuffer->cliprects))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_I915_BATCHBUFFER,\r\n(unsigned long)batchbuffer);\r\n}\r\nstatic int compat_i915_cmdbuffer(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_i915_cmdbuffer32_t cmdbuffer32;\r\ndrm_i915_cmdbuffer_t __user *cmdbuffer;\r\nif (copy_from_user\r\n(&cmdbuffer32, (void __user *)arg, sizeof(cmdbuffer32)))\r\nreturn -EFAULT;\r\ncmdbuffer = compat_alloc_user_space(sizeof(*cmdbuffer));\r\nif (!access_ok(VERIFY_WRITE, cmdbuffer, sizeof(*cmdbuffer))\r\n|| __put_user((int __user *)(unsigned long)cmdbuffer32.buf,\r\n&cmdbuffer->buf)\r\n|| __put_user(cmdbuffer32.sz, &cmdbuffer->sz)\r\n|| __put_user(cmdbuffer32.DR1, &cmdbuffer->DR1)\r\n|| __put_user(cmdbuffer32.DR4, &cmdbuffer->DR4)\r\n|| __put_user(cmdbuffer32.num_cliprects, &cmdbuffer->num_cliprects)\r\n|| __put_user((int __user *)(unsigned long)cmdbuffer32.cliprects,\r\n&cmdbuffer->cliprects))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_I915_CMDBUFFER,\r\n(unsigned long)cmdbuffer);\r\n}\r\nstatic int compat_i915_irq_emit(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_i915_irq_emit32_t req32;\r\ndrm_i915_irq_emit_t __user *request;\r\nif (copy_from_user(&req32, (void __user *)arg, sizeof(req32)))\r\nreturn -EFAULT;\r\nrequest = compat_alloc_user_space(sizeof(*request));\r\nif (!access_ok(VERIFY_WRITE, request, sizeof(*request))\r\n|| __put_user((int __user *)(unsigned long)req32.irq_seq,\r\n&request->irq_seq))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_I915_IRQ_EMIT,\r\n(unsigned long)request);\r\n}\r\nstatic int compat_i915_getparam(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_i915_getparam32_t req32;\r\ndrm_i915_getparam_t __user *request;\r\nif (copy_from_user(&req32, (void __user *)arg, sizeof(req32)))\r\nreturn -EFAULT;\r\nrequest = compat_alloc_user_space(sizeof(*request));\r\nif (!access_ok(VERIFY_WRITE, request, sizeof(*request))\r\n|| __put_user(req32.param, &request->param)\r\n|| __put_user((void __user *)(unsigned long)req32.value,\r\n&request->value))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_I915_GETPARAM,\r\n(unsigned long)request);\r\n}\r\nstatic int compat_i915_alloc(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_i915_mem_alloc32_t req32;\r\ndrm_i915_mem_alloc_t __user *request;\r\nif (copy_from_user(&req32, (void __user *)arg, sizeof(req32)))\r\nreturn -EFAULT;\r\nrequest = compat_alloc_user_space(sizeof(*request));\r\nif (!access_ok(VERIFY_WRITE, request, sizeof(*request))\r\n|| __put_user(req32.region, &request->region)\r\n|| __put_user(req32.alignment, &request->alignment)\r\n|| __put_user(req32.size, &request->size)\r\n|| __put_user((void __user *)(unsigned long)req32.region_offset,\r\n&request->region_offset))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_I915_ALLOC,\r\n(unsigned long)request);\r\n}\r\nlong i915_compat_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\r\n{\r\nunsigned int nr = DRM_IOCTL_NR(cmd);\r\ndrm_ioctl_compat_t *fn = NULL;\r\nint ret;\r\nif (nr < DRM_COMMAND_BASE)\r\nreturn drm_compat_ioctl(filp, cmd, arg);\r\nif (nr < DRM_COMMAND_BASE + DRM_ARRAY_SIZE(i915_compat_ioctls))\r\nfn = i915_compat_ioctls[nr - DRM_COMMAND_BASE];\r\nif (fn != NULL)\r\nret = (*fn) (filp, cmd, arg);\r\nelse\r\nret = drm_ioctl(filp, cmd, arg);\r\nreturn ret;\r\n}

static struct icst_vco vco_get(void __iomem *vcoreg)\r\n{\r\nu32 val;\r\nstruct icst_vco vco;\r\nval = readl(vcoreg);\r\nvco.v = val & 0x1ff;\r\nvco.r = (val >> 9) & 0x7f;\r\nvco.s = (val >> 16) & 03;\r\nreturn vco;\r\n}\r\nstatic void vco_set(void __iomem *lockreg,\r\nvoid __iomem *vcoreg,\r\nstruct icst_vco vco)\r\n{\r\nu32 val;\r\nval = readl(vcoreg) & ~0x7ffff;\r\nval |= vco.v | (vco.r << 9) | (vco.s << 16);\r\nwritel(0xa05f, lockreg);\r\nwritel(val, vcoreg);\r\nwritel(0, lockreg);\r\n}\r\nstatic unsigned long icst_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_icst *icst = to_icst(hw);\r\nstruct icst_vco vco;\r\nvco = vco_get(icst->vcoreg);\r\nicst->rate = icst_hz(icst->params, vco);\r\nreturn icst->rate;\r\n}\r\nstatic long icst_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *prate)\r\n{\r\nstruct clk_icst *icst = to_icst(hw);\r\nstruct icst_vco vco;\r\nvco = icst_hz_to_vco(icst->params, rate);\r\nreturn icst_hz(icst->params, vco);\r\n}\r\nstatic int icst_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_icst *icst = to_icst(hw);\r\nstruct icst_vco vco;\r\nvco = icst_hz_to_vco(icst->params, rate);\r\nicst->rate = icst_hz(icst->params, vco);\r\nvco_set(icst->lockreg, icst->vcoreg, vco);\r\nreturn 0;\r\n}\r\nstruct clk *icst_clk_register(struct device *dev,\r\nconst struct clk_icst_desc *desc,\r\nvoid __iomem *base)\r\n{\r\nstruct clk *clk;\r\nstruct clk_icst *icst;\r\nstruct clk_init_data init;\r\nicst = kzalloc(sizeof(struct clk_icst), GFP_KERNEL);\r\nif (!icst) {\r\npr_err("could not allocate ICST clock!\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\ninit.name = "icst";\r\ninit.ops = &icst_ops;\r\ninit.flags = CLK_IS_ROOT;\r\ninit.parent_names = NULL;\r\ninit.num_parents = 0;\r\nicst->hw.init = &init;\r\nicst->params = desc->params;\r\nicst->vcoreg = base + desc->vco_offset;\r\nicst->lockreg = base + desc->lock_offset;\r\nclk = clk_register(dev, &icst->hw);\r\nif (IS_ERR(clk))\r\nkfree(icst);\r\nreturn clk;\r\n}

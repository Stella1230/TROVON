static void\r\nmwifiex_11h_process_infra_join(struct mwifiex_private *priv, u8 **buffer,\r\nstruct mwifiex_bssdescriptor *bss_desc)\r\n{\r\nstruct mwifiex_ie_types_header *ie_header;\r\nstruct mwifiex_ie_types_pwr_capability *cap;\r\nstruct mwifiex_ie_types_local_pwr_constraint *constraint;\r\nstruct ieee80211_supported_band *sband;\r\nu8 radio_type;\r\nint i;\r\nif (!buffer || !(*buffer))\r\nreturn;\r\nradio_type = mwifiex_band_to_radio_type((u8) bss_desc->bss_band);\r\nsband = priv->wdev->wiphy->bands[radio_type];\r\ncap = (struct mwifiex_ie_types_pwr_capability *)*buffer;\r\ncap->header.type = cpu_to_le16(WLAN_EID_PWR_CAPABILITY);\r\ncap->header.len = cpu_to_le16(2);\r\ncap->min_pwr = 0;\r\ncap->max_pwr = 0;\r\n*buffer += sizeof(*cap);\r\nconstraint = (struct mwifiex_ie_types_local_pwr_constraint *)*buffer;\r\nconstraint->header.type = cpu_to_le16(WLAN_EID_PWR_CONSTRAINT);\r\nconstraint->header.len = cpu_to_le16(2);\r\nconstraint->chan = bss_desc->channel;\r\nconstraint->constraint = bss_desc->local_constraint;\r\n*buffer += sizeof(*constraint);\r\nie_header = (struct mwifiex_ie_types_header *)*buffer;\r\nie_header->type = cpu_to_le16(TLV_TYPE_PASSTHROUGH);\r\nie_header->len = cpu_to_le16(2 * sband->n_channels + 2);\r\n*buffer += sizeof(*ie_header);\r\n*(*buffer)++ = WLAN_EID_SUPPORTED_CHANNELS;\r\n*(*buffer)++ = 2 * sband->n_channels;\r\nfor (i = 0; i < sband->n_channels; i++) {\r\n*(*buffer)++ = ieee80211_frequency_to_channel(\r\nsband->channels[i].center_freq);\r\n*(*buffer)++ = 1;\r\n}\r\n}\r\nstatic int mwifiex_11h_activate(struct mwifiex_private *priv, bool flag)\r\n{\r\nu32 enable = flag;\r\nreturn mwifiex_send_cmd_sync(priv, HostCmd_CMD_802_11_SNMP_MIB,\r\nHostCmd_ACT_GEN_SET, DOT11H_I, &enable);\r\n}\r\nvoid mwifiex_11h_process_join(struct mwifiex_private *priv, u8 **buffer,\r\nstruct mwifiex_bssdescriptor *bss_desc)\r\n{\r\nif (bss_desc->sensed_11h) {\r\nmwifiex_11h_activate(priv, true);\r\nbss_desc->cap_info_bitmap |= WLAN_CAPABILITY_SPECTRUM_MGMT;\r\nmwifiex_11h_process_infra_join(priv, buffer, bss_desc);\r\n} else {\r\nmwifiex_11h_activate(priv, false);\r\nbss_desc->cap_info_bitmap &= ~WLAN_CAPABILITY_SPECTRUM_MGMT;\r\n}\r\n}

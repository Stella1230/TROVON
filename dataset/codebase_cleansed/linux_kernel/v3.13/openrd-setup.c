static int __init sd_uart_selection(char *str)\r\n{\r\nuart1 = -EINVAL;\r\nif (!str)\r\nreturn 0;\r\nif (!strncmp(str, "232", 3)) {\r\nuart1 = 232;\r\n} else if (!strncmp(str, "485", 3)) {\r\nif (machine_is_openrd_base()) {\r\nuart1 = -ENODEV;\r\nreturn 1;\r\n}\r\nuart1 = 485;\r\n}\r\nreturn 1;\r\n}\r\nstatic int __init uart1_mpp_config(void)\r\n{\r\nkirkwood_mpp_conf(openrd_uart1_mpp_config);\r\nif (gpio_request(34, "SD_UART1_SEL")) {\r\npr_err("GPIO request 34 failed for SD/UART1 selection\n");\r\nreturn -EIO;\r\n}\r\nif (gpio_request(28, "RS232_RS485_SEL")) {\r\npr_err("GPIO request 28 failed for RS232/RS485 selection\n");\r\ngpio_free(34);\r\nreturn -EIO;\r\n}\r\ngpio_direction_output(34, 0);\r\nif (uart1 == 232)\r\ngpio_direction_output(28, 0);\r\nelse\r\ngpio_direction_output(28, 1);\r\ngpio_free(34);\r\ngpio_free(28);\r\nreturn 0;\r\n}\r\nstatic void __init openrd_init(void)\r\n{\r\nkirkwood_init();\r\nkirkwood_mpp_conf(openrd_mpp_config);\r\nkirkwood_uart0_init();\r\nkirkwood_nand_init(openrd_nand_parts, ARRAY_SIZE(openrd_nand_parts),\r\n25);\r\nkirkwood_ehci_init();\r\nif (machine_is_openrd_ultimate()) {\r\nopenrd_ge00_data.phy_addr = MV643XX_ETH_PHY_ADDR(0);\r\nopenrd_ge01_data.phy_addr = MV643XX_ETH_PHY_ADDR(1);\r\n}\r\nkirkwood_ge00_init(&openrd_ge00_data);\r\nif (!machine_is_openrd_base())\r\nkirkwood_ge01_init(&openrd_ge01_data);\r\nkirkwood_sata_init(&openrd_sata_data);\r\nkirkwood_i2c_init();\r\nif (machine_is_openrd_client() || machine_is_openrd_ultimate()) {\r\nplatform_device_register(&openrd_client_audio_device);\r\ni2c_register_board_info(0, i2c_board_info,\r\nARRAY_SIZE(i2c_board_info));\r\nkirkwood_audio_init();\r\n}\r\nif (uart1 <= 0) {\r\nif (uart1 < 0)\r\npr_err("Invalid kernel parameter to select UART1. Defaulting to SD. ERROR CODE: %d\n",\r\nuart1);\r\nif (gpio_request(34, "SD_UART1_SEL")) {\r\npr_err("GPIO request 34 failed for SD/UART1 selection\n");\r\n} else {\r\ngpio_direction_output(34, 1);\r\ngpio_free(34);\r\nkirkwood_sdio_init(&openrd_mvsdio_data);\r\n}\r\n} else {\r\nif (!uart1_mpp_config())\r\nkirkwood_uart1_init();\r\n}\r\n}\r\nstatic int __init openrd_pci_init(void)\r\n{\r\nif (machine_is_openrd_base() ||\r\nmachine_is_openrd_client() ||\r\nmachine_is_openrd_ultimate())\r\nkirkwood_pcie_init(KW_PCIE0);\r\nreturn 0;\r\n}

static void mop500_of_node_put(void)\r\n{\r\nint i;\r\nfor (i = 0; i < 2; i++) {\r\nif (mop500_dai_links[i].cpu_of_node)\r\nof_node_put((struct device_node *)\r\nmop500_dai_links[i].cpu_of_node);\r\nif (mop500_dai_links[i].codec_of_node)\r\nof_node_put((struct device_node *)\r\nmop500_dai_links[i].codec_of_node);\r\n}\r\n}\r\nstatic int mop500_of_probe(struct platform_device *pdev,\r\nstruct device_node *np)\r\n{\r\nstruct device_node *codec_np, *msp_np[2];\r\nint i;\r\nmsp_np[0] = of_parse_phandle(np, "stericsson,cpu-dai", 0);\r\nmsp_np[1] = of_parse_phandle(np, "stericsson,cpu-dai", 1);\r\ncodec_np = of_parse_phandle(np, "stericsson,audio-codec", 0);\r\nif (!(msp_np[0] && msp_np[1] && codec_np)) {\r\ndev_err(&pdev->dev, "Phandle missing or invalid\n");\r\nmop500_of_node_put();\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < 2; i++) {\r\nmop500_dai_links[i].cpu_of_node = msp_np[i];\r\nmop500_dai_links[i].cpu_dai_name = NULL;\r\nmop500_dai_links[i].codec_of_node = codec_np;\r\nmop500_dai_links[i].codec_name = NULL;\r\n}\r\nsnd_soc_of_parse_card_name(&mop500_card, "stericsson,card-name");\r\nreturn 0;\r\n}\r\nstatic int mop500_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nint ret;\r\ndev_dbg(&pdev->dev, "%s: Enter.\n", __func__);\r\nmop500_card.dev = &pdev->dev;\r\nif (np) {\r\nret = mop500_of_probe(pdev, np);\r\nif (ret)\r\nreturn ret;\r\n}\r\ndev_dbg(&pdev->dev, "%s: Card %s: Set platform drvdata.\n",\r\n__func__, mop500_card.name);\r\nplatform_set_drvdata(pdev, &mop500_card);\r\nsnd_soc_card_set_drvdata(&mop500_card, NULL);\r\ndev_dbg(&pdev->dev, "%s: Card %s: num_links = %d\n",\r\n__func__, mop500_card.name, mop500_card.num_links);\r\ndev_dbg(&pdev->dev, "%s: Card %s: DAI-link 0: name = %s\n",\r\n__func__, mop500_card.name, mop500_card.dai_link[0].name);\r\ndev_dbg(&pdev->dev, "%s: Card %s: DAI-link 0: stream_name = %s\n",\r\n__func__, mop500_card.name,\r\nmop500_card.dai_link[0].stream_name);\r\nret = snd_soc_register_card(&mop500_card);\r\nif (ret)\r\ndev_err(&pdev->dev,\r\n"Error: snd_soc_register_card failed (%d)!\n", ret);\r\nreturn ret;\r\n}\r\nstatic int mop500_remove(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *mop500_card = platform_get_drvdata(pdev);\r\npr_debug("%s: Enter.\n", __func__);\r\nsnd_soc_unregister_card(mop500_card);\r\nmop500_ab8500_remove(mop500_card);\r\nmop500_of_node_put();\r\nreturn 0;\r\n}

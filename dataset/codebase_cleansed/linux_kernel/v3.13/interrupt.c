static inline void wil_icr_clear(u32 x, void __iomem *addr)\r\n{\r\n}\r\nstatic inline void wil_icr_clear(u32 x, void __iomem *addr)\r\n{\r\niowrite32(x, addr);\r\n}\r\nstatic inline u32 wil_ioread32_and_clear(void __iomem *addr)\r\n{\r\nu32 x = ioread32(addr);\r\nwil_icr_clear(x, addr);\r\nreturn x;\r\n}\r\nstatic void wil6210_mask_irq_tx(struct wil6210_priv *wil)\r\n{\r\niowrite32(WIL6210_IRQ_DISABLE, wil->csr +\r\nHOSTADDR(RGF_DMA_EP_TX_ICR) +\r\noffsetof(struct RGF_ICR, IMS));\r\n}\r\nstatic void wil6210_mask_irq_rx(struct wil6210_priv *wil)\r\n{\r\niowrite32(WIL6210_IRQ_DISABLE, wil->csr +\r\nHOSTADDR(RGF_DMA_EP_RX_ICR) +\r\noffsetof(struct RGF_ICR, IMS));\r\n}\r\nstatic void wil6210_mask_irq_misc(struct wil6210_priv *wil)\r\n{\r\niowrite32(WIL6210_IRQ_DISABLE, wil->csr +\r\nHOSTADDR(RGF_DMA_EP_MISC_ICR) +\r\noffsetof(struct RGF_ICR, IMS));\r\n}\r\nstatic void wil6210_mask_irq_pseudo(struct wil6210_priv *wil)\r\n{\r\nwil_dbg_irq(wil, "%s()\n", __func__);\r\niowrite32(WIL6210_IRQ_DISABLE, wil->csr +\r\nHOSTADDR(RGF_DMA_PSEUDO_CAUSE_MASK_SW));\r\nclear_bit(wil_status_irqen, &wil->status);\r\n}\r\nvoid wil6210_unmask_irq_tx(struct wil6210_priv *wil)\r\n{\r\niowrite32(WIL6210_IMC_TX, wil->csr +\r\nHOSTADDR(RGF_DMA_EP_TX_ICR) +\r\noffsetof(struct RGF_ICR, IMC));\r\n}\r\nvoid wil6210_unmask_irq_rx(struct wil6210_priv *wil)\r\n{\r\niowrite32(WIL6210_IMC_RX, wil->csr +\r\nHOSTADDR(RGF_DMA_EP_RX_ICR) +\r\noffsetof(struct RGF_ICR, IMC));\r\n}\r\nstatic void wil6210_unmask_irq_misc(struct wil6210_priv *wil)\r\n{\r\niowrite32(WIL6210_IMC_MISC, wil->csr +\r\nHOSTADDR(RGF_DMA_EP_MISC_ICR) +\r\noffsetof(struct RGF_ICR, IMC));\r\n}\r\nstatic void wil6210_unmask_irq_pseudo(struct wil6210_priv *wil)\r\n{\r\nwil_dbg_irq(wil, "%s()\n", __func__);\r\nset_bit(wil_status_irqen, &wil->status);\r\niowrite32(WIL6210_IRQ_PSEUDO_MASK, wil->csr +\r\nHOSTADDR(RGF_DMA_PSEUDO_CAUSE_MASK_SW));\r\n}\r\nvoid wil6210_disable_irq(struct wil6210_priv *wil)\r\n{\r\nwil_dbg_irq(wil, "%s()\n", __func__);\r\nwil6210_mask_irq_tx(wil);\r\nwil6210_mask_irq_rx(wil);\r\nwil6210_mask_irq_misc(wil);\r\nwil6210_mask_irq_pseudo(wil);\r\n}\r\nvoid wil6210_enable_irq(struct wil6210_priv *wil)\r\n{\r\nwil_dbg_irq(wil, "%s()\n", __func__);\r\niowrite32(WIL_ICR_ICC_VALUE, wil->csr + HOSTADDR(RGF_DMA_EP_RX_ICR) +\r\noffsetof(struct RGF_ICR, ICC));\r\niowrite32(WIL_ICR_ICC_VALUE, wil->csr + HOSTADDR(RGF_DMA_EP_TX_ICR) +\r\noffsetof(struct RGF_ICR, ICC));\r\niowrite32(WIL_ICR_ICC_VALUE, wil->csr + HOSTADDR(RGF_DMA_EP_MISC_ICR) +\r\noffsetof(struct RGF_ICR, ICC));\r\nwil6210_unmask_irq_pseudo(wil);\r\nwil6210_unmask_irq_tx(wil);\r\nwil6210_unmask_irq_rx(wil);\r\nwil6210_unmask_irq_misc(wil);\r\n}\r\nstatic irqreturn_t wil6210_irq_rx(int irq, void *cookie)\r\n{\r\nstruct wil6210_priv *wil = cookie;\r\nu32 isr = wil_ioread32_and_clear(wil->csr +\r\nHOSTADDR(RGF_DMA_EP_RX_ICR) +\r\noffsetof(struct RGF_ICR, ICR));\r\ntrace_wil6210_irq_rx(isr);\r\nwil_dbg_irq(wil, "ISR RX 0x%08x\n", isr);\r\nif (!isr) {\r\nwil_err(wil, "spurious IRQ: RX\n");\r\nreturn IRQ_NONE;\r\n}\r\nwil6210_mask_irq_rx(wil);\r\nif (isr & BIT_DMA_EP_RX_ICR_RX_DONE) {\r\nwil_dbg_irq(wil, "RX done\n");\r\nisr &= ~BIT_DMA_EP_RX_ICR_RX_DONE;\r\nwil_dbg_txrx(wil, "NAPI schedule\n");\r\nnapi_schedule(&wil->napi_rx);\r\n}\r\nif (isr)\r\nwil_err(wil, "un-handled RX ISR bits 0x%08x\n", isr);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t wil6210_irq_tx(int irq, void *cookie)\r\n{\r\nstruct wil6210_priv *wil = cookie;\r\nu32 isr = wil_ioread32_and_clear(wil->csr +\r\nHOSTADDR(RGF_DMA_EP_TX_ICR) +\r\noffsetof(struct RGF_ICR, ICR));\r\ntrace_wil6210_irq_tx(isr);\r\nwil_dbg_irq(wil, "ISR TX 0x%08x\n", isr);\r\nif (!isr) {\r\nwil_err(wil, "spurious IRQ: TX\n");\r\nreturn IRQ_NONE;\r\n}\r\nwil6210_mask_irq_tx(wil);\r\nif (isr & BIT_DMA_EP_TX_ICR_TX_DONE) {\r\nwil_dbg_irq(wil, "TX done\n");\r\nnapi_schedule(&wil->napi_tx);\r\nisr &= ~BIT_DMA_EP_TX_ICR_TX_DONE;\r\nisr &= ~(BIT(25) - 1UL);\r\n}\r\nif (isr)\r\nwil_err(wil, "un-handled TX ISR bits 0x%08x\n", isr);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void wil_notify_fw_error(struct wil6210_priv *wil)\r\n{\r\nstruct device *dev = &wil_to_ndev(wil)->dev;\r\nchar *envp[3] = {\r\n[0] = "SOURCE=wil6210",\r\n[1] = "EVENT=FW_ERROR",\r\n[2] = NULL,\r\n};\r\nkobject_uevent_env(&dev->kobj, KOBJ_CHANGE, envp);\r\n}\r\nstatic void wil_cache_mbox_regs(struct wil6210_priv *wil)\r\n{\r\nwil_memcpy_fromio_32(&wil->mbox_ctl, wil->csr + HOST_MBOX,\r\nsizeof(struct wil6210_mbox_ctl));\r\nwil_mbox_ring_le2cpus(&wil->mbox_ctl.rx);\r\nwil_mbox_ring_le2cpus(&wil->mbox_ctl.tx);\r\n}\r\nstatic irqreturn_t wil6210_irq_misc(int irq, void *cookie)\r\n{\r\nstruct wil6210_priv *wil = cookie;\r\nu32 isr = wil_ioread32_and_clear(wil->csr +\r\nHOSTADDR(RGF_DMA_EP_MISC_ICR) +\r\noffsetof(struct RGF_ICR, ICR));\r\ntrace_wil6210_irq_misc(isr);\r\nwil_dbg_irq(wil, "ISR MISC 0x%08x\n", isr);\r\nif (!isr) {\r\nwil_err(wil, "spurious IRQ: MISC\n");\r\nreturn IRQ_NONE;\r\n}\r\nwil6210_mask_irq_misc(wil);\r\nif (isr & ISR_MISC_FW_ERROR) {\r\nwil_err(wil, "Firmware error detected\n");\r\nclear_bit(wil_status_fwready, &wil->status);\r\n}\r\nif (isr & ISR_MISC_FW_READY) {\r\nwil_dbg_irq(wil, "IRQ: FW ready\n");\r\nwil_cache_mbox_regs(wil);\r\nset_bit(wil_status_reset_done, &wil->status);\r\nisr &= ~ISR_MISC_FW_READY;\r\n}\r\nwil->isr_misc = isr;\r\nif (isr) {\r\nreturn IRQ_WAKE_THREAD;\r\n} else {\r\nwil6210_unmask_irq_misc(wil);\r\nreturn IRQ_HANDLED;\r\n}\r\n}\r\nstatic irqreturn_t wil6210_irq_misc_thread(int irq, void *cookie)\r\n{\r\nstruct wil6210_priv *wil = cookie;\r\nu32 isr = wil->isr_misc;\r\ntrace_wil6210_irq_misc_thread(isr);\r\nwil_dbg_irq(wil, "Thread ISR MISC 0x%08x\n", isr);\r\nif (isr & ISR_MISC_FW_ERROR) {\r\nwil_notify_fw_error(wil);\r\nisr &= ~ISR_MISC_FW_ERROR;\r\n}\r\nif (isr & ISR_MISC_MBOX_EVT) {\r\nwil_dbg_irq(wil, "MBOX event\n");\r\nwmi_recv_cmd(wil);\r\nisr &= ~ISR_MISC_MBOX_EVT;\r\n}\r\nif (isr)\r\nwil_err(wil, "un-handled MISC ISR bits 0x%08x\n", isr);\r\nwil->isr_misc = 0;\r\nwil6210_unmask_irq_misc(wil);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t wil6210_thread_irq(int irq, void *cookie)\r\n{\r\nstruct wil6210_priv *wil = cookie;\r\nwil_dbg_irq(wil, "Thread IRQ\n");\r\nif (wil->isr_misc)\r\nwil6210_irq_misc_thread(irq, cookie);\r\nwil6210_unmask_irq_pseudo(wil);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int wil6210_debug_irq_mask(struct wil6210_priv *wil, u32 pseudo_cause)\r\n{\r\nif (!test_bit(wil_status_irqen, &wil->status)) {\r\nu32 icm_rx = wil_ioread32_and_clear(wil->csr +\r\nHOSTADDR(RGF_DMA_EP_RX_ICR) +\r\noffsetof(struct RGF_ICR, ICM));\r\nu32 icr_rx = wil_ioread32_and_clear(wil->csr +\r\nHOSTADDR(RGF_DMA_EP_RX_ICR) +\r\noffsetof(struct RGF_ICR, ICR));\r\nu32 imv_rx = ioread32(wil->csr +\r\nHOSTADDR(RGF_DMA_EP_RX_ICR) +\r\noffsetof(struct RGF_ICR, IMV));\r\nu32 icm_tx = wil_ioread32_and_clear(wil->csr +\r\nHOSTADDR(RGF_DMA_EP_TX_ICR) +\r\noffsetof(struct RGF_ICR, ICM));\r\nu32 icr_tx = wil_ioread32_and_clear(wil->csr +\r\nHOSTADDR(RGF_DMA_EP_TX_ICR) +\r\noffsetof(struct RGF_ICR, ICR));\r\nu32 imv_tx = ioread32(wil->csr +\r\nHOSTADDR(RGF_DMA_EP_TX_ICR) +\r\noffsetof(struct RGF_ICR, IMV));\r\nu32 icm_misc = wil_ioread32_and_clear(wil->csr +\r\nHOSTADDR(RGF_DMA_EP_MISC_ICR) +\r\noffsetof(struct RGF_ICR, ICM));\r\nu32 icr_misc = wil_ioread32_and_clear(wil->csr +\r\nHOSTADDR(RGF_DMA_EP_MISC_ICR) +\r\noffsetof(struct RGF_ICR, ICR));\r\nu32 imv_misc = ioread32(wil->csr +\r\nHOSTADDR(RGF_DMA_EP_MISC_ICR) +\r\noffsetof(struct RGF_ICR, IMV));\r\nwil_err(wil, "IRQ when it should be masked: pseudo 0x%08x\n"\r\n"Rx icm:icr:imv 0x%08x 0x%08x 0x%08x\n"\r\n"Tx icm:icr:imv 0x%08x 0x%08x 0x%08x\n"\r\n"Misc icm:icr:imv 0x%08x 0x%08x 0x%08x\n",\r\npseudo_cause,\r\nicm_rx, icr_rx, imv_rx,\r\nicm_tx, icr_tx, imv_tx,\r\nicm_misc, icr_misc, imv_misc);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t wil6210_hardirq(int irq, void *cookie)\r\n{\r\nirqreturn_t rc = IRQ_HANDLED;\r\nstruct wil6210_priv *wil = cookie;\r\nu32 pseudo_cause = ioread32(wil->csr + HOSTADDR(RGF_DMA_PSEUDO_CAUSE));\r\nif ((pseudo_cause == 0) || ((pseudo_cause & 0xff) == 0xff))\r\nreturn IRQ_NONE;\r\nif (wil6210_debug_irq_mask(wil, pseudo_cause))\r\nreturn IRQ_NONE;\r\ntrace_wil6210_irq_pseudo(pseudo_cause);\r\nwil_dbg_irq(wil, "Pseudo IRQ 0x%08x\n", pseudo_cause);\r\nwil6210_mask_irq_pseudo(wil);\r\nif ((pseudo_cause & BIT_DMA_PSEUDO_CAUSE_RX) &&\r\n(wil6210_irq_rx(irq, cookie) == IRQ_WAKE_THREAD))\r\nrc = IRQ_WAKE_THREAD;\r\nif ((pseudo_cause & BIT_DMA_PSEUDO_CAUSE_TX) &&\r\n(wil6210_irq_tx(irq, cookie) == IRQ_WAKE_THREAD))\r\nrc = IRQ_WAKE_THREAD;\r\nif ((pseudo_cause & BIT_DMA_PSEUDO_CAUSE_MISC) &&\r\n(wil6210_irq_misc(irq, cookie) == IRQ_WAKE_THREAD))\r\nrc = IRQ_WAKE_THREAD;\r\nif (rc != IRQ_WAKE_THREAD)\r\nwil6210_unmask_irq_pseudo(wil);\r\nreturn rc;\r\n}\r\nstatic int wil6210_request_3msi(struct wil6210_priv *wil, int irq)\r\n{\r\nint rc;\r\nrc = request_irq(irq, wil6210_irq_tx, IRQF_SHARED,\r\nWIL_NAME"_tx", wil);\r\nif (rc)\r\nreturn rc;\r\nrc = request_irq(irq + 1, wil6210_irq_rx, IRQF_SHARED,\r\nWIL_NAME"_rx", wil);\r\nif (rc)\r\ngoto free0;\r\nrc = request_threaded_irq(irq + 2, wil6210_irq_misc,\r\nwil6210_irq_misc_thread,\r\nIRQF_SHARED, WIL_NAME"_misc", wil);\r\nif (rc)\r\ngoto free1;\r\nreturn 0;\r\nfree1:\r\nfree_irq(irq + 1, wil);\r\nfree0:\r\nfree_irq(irq, wil);\r\nreturn rc;\r\n}\r\nint wil6210_init_irq(struct wil6210_priv *wil, int irq)\r\n{\r\nint rc;\r\nif (wil->n_msi == 3)\r\nrc = wil6210_request_3msi(wil, irq);\r\nelse\r\nrc = request_threaded_irq(irq, wil6210_hardirq,\r\nwil6210_thread_irq,\r\nwil->n_msi ? 0 : IRQF_SHARED,\r\nWIL_NAME, wil);\r\nif (rc)\r\nreturn rc;\r\nwil6210_enable_irq(wil);\r\nreturn 0;\r\n}\r\nvoid wil6210_fini_irq(struct wil6210_priv *wil, int irq)\r\n{\r\nwil6210_disable_irq(wil);\r\nfree_irq(irq, wil);\r\nif (wil->n_msi == 3) {\r\nfree_irq(irq + 1, wil);\r\nfree_irq(irq + 2, wil);\r\n}\r\n}

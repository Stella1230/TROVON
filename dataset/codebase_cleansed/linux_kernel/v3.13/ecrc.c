static int enable_ecrc_checking(struct pci_dev *dev)\r\n{\r\nint pos;\r\nu32 reg32;\r\nif (!pci_is_pcie(dev))\r\nreturn -ENODEV;\r\npos = pci_find_ext_capability(dev, PCI_EXT_CAP_ID_ERR);\r\nif (!pos)\r\nreturn -ENODEV;\r\npci_read_config_dword(dev, pos + PCI_ERR_CAP, &reg32);\r\nif (reg32 & PCI_ERR_CAP_ECRC_GENC)\r\nreg32 |= PCI_ERR_CAP_ECRC_GENE;\r\nif (reg32 & PCI_ERR_CAP_ECRC_CHKC)\r\nreg32 |= PCI_ERR_CAP_ECRC_CHKE;\r\npci_write_config_dword(dev, pos + PCI_ERR_CAP, reg32);\r\nreturn 0;\r\n}\r\nstatic int disable_ecrc_checking(struct pci_dev *dev)\r\n{\r\nint pos;\r\nu32 reg32;\r\nif (!pci_is_pcie(dev))\r\nreturn -ENODEV;\r\npos = pci_find_ext_capability(dev, PCI_EXT_CAP_ID_ERR);\r\nif (!pos)\r\nreturn -ENODEV;\r\npci_read_config_dword(dev, pos + PCI_ERR_CAP, &reg32);\r\nreg32 &= ~(PCI_ERR_CAP_ECRC_GENE | PCI_ERR_CAP_ECRC_CHKE);\r\npci_write_config_dword(dev, pos + PCI_ERR_CAP, reg32);\r\nreturn 0;\r\n}\r\nvoid pcie_set_ecrc_checking(struct pci_dev *dev)\r\n{\r\nswitch (ecrc_policy) {\r\ncase ECRC_POLICY_DEFAULT:\r\nreturn;\r\ncase ECRC_POLICY_OFF:\r\ndisable_ecrc_checking(dev);\r\nbreak;\r\ncase ECRC_POLICY_ON:\r\nenable_ecrc_checking(dev);\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\n}\r\nvoid pcie_ecrc_get_policy(char *str)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ecrc_policy_str); i++)\r\nif (!strncmp(str, ecrc_policy_str[i],\r\nstrlen(ecrc_policy_str[i])))\r\nbreak;\r\nif (i >= ARRAY_SIZE(ecrc_policy_str))\r\nreturn;\r\necrc_policy = i;\r\n}

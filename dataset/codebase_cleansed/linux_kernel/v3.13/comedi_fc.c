static void increment_scan_progress(struct comedi_subdevice *subd,\r\nunsigned int num_bytes)\r\n{\r\nstruct comedi_async *async = subd->async;\r\nunsigned int scan_length = cfc_bytes_per_scan(subd);\r\nasync->scan_progress += num_bytes;\r\nif (async->scan_progress >= scan_length) {\r\nasync->scan_progress %= scan_length;\r\nasync->events |= COMEDI_CB_EOS;\r\n}\r\n}\r\nunsigned int cfc_write_array_to_buffer(struct comedi_subdevice *subd,\r\nvoid *data, unsigned int num_bytes)\r\n{\r\nstruct comedi_async *async = subd->async;\r\nunsigned int retval;\r\nif (num_bytes == 0)\r\nreturn 0;\r\nretval = comedi_buf_write_alloc(async, num_bytes);\r\nif (retval != num_bytes) {\r\ndev_warn(subd->device->class_dev, "comedi: buffer overrun\n");\r\nasync->events |= COMEDI_CB_OVERFLOW;\r\nreturn 0;\r\n}\r\ncomedi_buf_memcpy_to(async, 0, data, num_bytes);\r\ncomedi_buf_write_free(async, num_bytes);\r\nincrement_scan_progress(subd, num_bytes);\r\nasync->events |= COMEDI_CB_BLOCK;\r\nreturn num_bytes;\r\n}\r\nunsigned int cfc_read_array_from_buffer(struct comedi_subdevice *subd,\r\nvoid *data, unsigned int num_bytes)\r\n{\r\nstruct comedi_async *async = subd->async;\r\nif (num_bytes == 0)\r\nreturn 0;\r\nnum_bytes = comedi_buf_read_alloc(async, num_bytes);\r\ncomedi_buf_memcpy_from(async, 0, data, num_bytes);\r\ncomedi_buf_read_free(async, num_bytes);\r\nincrement_scan_progress(subd, num_bytes);\r\nasync->events |= COMEDI_CB_BLOCK;\r\nreturn num_bytes;\r\n}\r\nunsigned int cfc_handle_events(struct comedi_device *dev,\r\nstruct comedi_subdevice *subd)\r\n{\r\nunsigned int events = subd->async->events;\r\nif (events == 0)\r\nreturn events;\r\nif (events & (COMEDI_CB_EOA | COMEDI_CB_ERROR | COMEDI_CB_OVERFLOW))\r\nsubd->cancel(dev, subd);\r\ncomedi_event(dev, subd);\r\nreturn events;\r\n}\r\nstatic int __init comedi_fc_init_module(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit comedi_fc_cleanup_module(void)\r\n{\r\n}

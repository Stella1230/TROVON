static inline struct rcar_du_plane *to_rcar_plane(struct drm_plane *plane)\r\n{\r\nreturn container_of(plane, struct rcar_du_kms_plane, plane)->hwplane;\r\n}\r\nstatic u32 rcar_du_plane_read(struct rcar_du_group *rgrp,\r\nunsigned int index, u32 reg)\r\n{\r\nreturn rcar_du_read(rgrp->dev,\r\nrgrp->mmio_offset + index * PLANE_OFF + reg);\r\n}\r\nstatic void rcar_du_plane_write(struct rcar_du_group *rgrp,\r\nunsigned int index, u32 reg, u32 data)\r\n{\r\nrcar_du_write(rgrp->dev, rgrp->mmio_offset + index * PLANE_OFF + reg,\r\ndata);\r\n}\r\nint rcar_du_plane_reserve(struct rcar_du_plane *plane,\r\nconst struct rcar_du_format_info *format)\r\n{\r\nstruct rcar_du_group *rgrp = plane->group;\r\nunsigned int i;\r\nint ret = -EBUSY;\r\nmutex_lock(&rgrp->planes.lock);\r\nfor (i = 0; i < ARRAY_SIZE(rgrp->planes.planes); ++i) {\r\nif (!(rgrp->planes.free & (1 << i)))\r\ncontinue;\r\nif (format->planes == 1 ||\r\nrgrp->planes.free & (1 << ((i + 1) % 8)))\r\nbreak;\r\n}\r\nif (i == ARRAY_SIZE(rgrp->planes.planes))\r\ngoto done;\r\nrgrp->planes.free &= ~(1 << i);\r\nif (format->planes == 2)\r\nrgrp->planes.free &= ~(1 << ((i + 1) % 8));\r\nplane->hwindex = i;\r\nret = 0;\r\ndone:\r\nmutex_unlock(&rgrp->planes.lock);\r\nreturn ret;\r\n}\r\nvoid rcar_du_plane_release(struct rcar_du_plane *plane)\r\n{\r\nstruct rcar_du_group *rgrp = plane->group;\r\nif (plane->hwindex == -1)\r\nreturn;\r\nmutex_lock(&rgrp->planes.lock);\r\nrgrp->planes.free |= 1 << plane->hwindex;\r\nif (plane->format->planes == 2)\r\nrgrp->planes.free |= 1 << ((plane->hwindex + 1) % 8);\r\nmutex_unlock(&rgrp->planes.lock);\r\nplane->hwindex = -1;\r\n}\r\nvoid rcar_du_plane_update_base(struct rcar_du_plane *plane)\r\n{\r\nstruct rcar_du_group *rgrp = plane->group;\r\nunsigned int index = plane->hwindex;\r\nrcar_du_plane_write(rgrp, index, PnSPXR, plane->src_x);\r\nrcar_du_plane_write(rgrp, index, PnSPYR, plane->src_y *\r\n(plane->format->bpp == 32 ? 2 : 1));\r\nrcar_du_plane_write(rgrp, index, PnDSA0R, plane->dma[0]);\r\nif (plane->format->planes == 2) {\r\nindex = (index + 1) % 8;\r\nrcar_du_plane_write(rgrp, index, PnSPXR, plane->src_x);\r\nrcar_du_plane_write(rgrp, index, PnSPYR, plane->src_y *\r\n(plane->format->bpp == 16 ? 2 : 1) / 2);\r\nrcar_du_plane_write(rgrp, index, PnDSA0R, plane->dma[1]);\r\n}\r\n}\r\nvoid rcar_du_plane_compute_base(struct rcar_du_plane *plane,\r\nstruct drm_framebuffer *fb)\r\n{\r\nstruct drm_gem_cma_object *gem;\r\ngem = drm_fb_cma_get_gem_obj(fb, 0);\r\nplane->dma[0] = gem->paddr + fb->offsets[0];\r\nif (plane->format->planes == 2) {\r\ngem = drm_fb_cma_get_gem_obj(fb, 1);\r\nplane->dma[1] = gem->paddr + fb->offsets[1];\r\n}\r\n}\r\nstatic void rcar_du_plane_setup_mode(struct rcar_du_plane *plane,\r\nunsigned int index)\r\n{\r\nstruct rcar_du_group *rgrp = plane->group;\r\nu32 colorkey;\r\nu32 pnmr;\r\nif (plane->format->fourcc != DRM_FORMAT_XRGB1555)\r\nrcar_du_plane_write(rgrp, index, PnALPHAR, PnALPHAR_ABIT_0);\r\nelse\r\nrcar_du_plane_write(rgrp, index, PnALPHAR,\r\nPnALPHAR_ABIT_X | plane->alpha);\r\npnmr = PnMR_BM_MD | plane->format->pnmr;\r\nif ((plane->colorkey & RCAR_DU_COLORKEY_MASK) == RCAR_DU_COLORKEY_NONE)\r\npnmr |= PnMR_SPIM_TP_OFF;\r\nif (plane->format->fourcc == DRM_FORMAT_YUYV)\r\npnmr |= PnMR_YCDF_YUYV;\r\nrcar_du_plane_write(rgrp, index, PnMR, pnmr);\r\nswitch (plane->format->fourcc) {\r\ncase DRM_FORMAT_RGB565:\r\ncolorkey = ((plane->colorkey & 0xf80000) >> 8)\r\n| ((plane->colorkey & 0x00fc00) >> 5)\r\n| ((plane->colorkey & 0x0000f8) >> 3);\r\nrcar_du_plane_write(rgrp, index, PnTC2R, colorkey);\r\nbreak;\r\ncase DRM_FORMAT_ARGB1555:\r\ncase DRM_FORMAT_XRGB1555:\r\ncolorkey = ((plane->colorkey & 0xf80000) >> 9)\r\n| ((plane->colorkey & 0x00f800) >> 6)\r\n| ((plane->colorkey & 0x0000f8) >> 3);\r\nrcar_du_plane_write(rgrp, index, PnTC2R, colorkey);\r\nbreak;\r\ncase DRM_FORMAT_XRGB8888:\r\ncase DRM_FORMAT_ARGB8888:\r\nrcar_du_plane_write(rgrp, index, PnTC3R,\r\nPnTC3R_CODE | (plane->colorkey & 0xffffff));\r\nbreak;\r\n}\r\n}\r\nstatic void __rcar_du_plane_setup(struct rcar_du_plane *plane,\r\nunsigned int index)\r\n{\r\nstruct rcar_du_group *rgrp = plane->group;\r\nu32 ddcr2 = PnDDCR2_CODE;\r\nu32 ddcr4;\r\nu32 mwr;\r\nddcr4 = rcar_du_plane_read(rgrp, index, PnDDCR4);\r\nddcr4 &= ~PnDDCR4_EDF_MASK;\r\nddcr4 |= plane->format->edf | PnDDCR4_CODE;\r\nrcar_du_plane_setup_mode(plane, index);\r\nif (plane->format->planes == 2) {\r\nif (plane->hwindex != index) {\r\nif (plane->format->fourcc == DRM_FORMAT_NV12 ||\r\nplane->format->fourcc == DRM_FORMAT_NV21)\r\nddcr2 |= PnDDCR2_Y420;\r\nif (plane->format->fourcc == DRM_FORMAT_NV21)\r\nddcr2 |= PnDDCR2_NV21;\r\nddcr2 |= PnDDCR2_DIVU;\r\n} else {\r\nddcr2 |= PnDDCR2_DIVY;\r\n}\r\n}\r\nrcar_du_plane_write(rgrp, index, PnDDCR2, ddcr2);\r\nrcar_du_plane_write(rgrp, index, PnDDCR4, ddcr4);\r\nif (plane->format->planes == 2)\r\nmwr = plane->pitch;\r\nelse\r\nmwr = plane->pitch * 8 / plane->format->bpp;\r\nrcar_du_plane_write(rgrp, index, PnMWR, mwr);\r\nrcar_du_plane_write(rgrp, index, PnDSXR, plane->width);\r\nrcar_du_plane_write(rgrp, index, PnDSYR, plane->height);\r\nrcar_du_plane_write(rgrp, index, PnDPXR, plane->dst_x);\r\nrcar_du_plane_write(rgrp, index, PnDPYR, plane->dst_y);\r\nrcar_du_plane_write(rgrp, index, PnWASPR, 0);\r\nrcar_du_plane_write(rgrp, index, PnWAMWR, 4095);\r\nrcar_du_plane_write(rgrp, index, PnBTR, 0);\r\nrcar_du_plane_write(rgrp, index, PnMLR, 0);\r\n}\r\nvoid rcar_du_plane_setup(struct rcar_du_plane *plane)\r\n{\r\n__rcar_du_plane_setup(plane, plane->hwindex);\r\nif (plane->format->planes == 2)\r\n__rcar_du_plane_setup(plane, (plane->hwindex + 1) % 8);\r\nrcar_du_plane_update_base(plane);\r\n}\r\nstatic int\r\nrcar_du_plane_update(struct drm_plane *plane, struct drm_crtc *crtc,\r\nstruct drm_framebuffer *fb, int crtc_x, int crtc_y,\r\nunsigned int crtc_w, unsigned int crtc_h,\r\nuint32_t src_x, uint32_t src_y,\r\nuint32_t src_w, uint32_t src_h)\r\n{\r\nstruct rcar_du_plane *rplane = to_rcar_plane(plane);\r\nstruct rcar_du_device *rcdu = rplane->group->dev;\r\nconst struct rcar_du_format_info *format;\r\nunsigned int nplanes;\r\nint ret;\r\nformat = rcar_du_format_info(fb->pixel_format);\r\nif (format == NULL) {\r\ndev_dbg(rcdu->dev, "%s: unsupported format %08x\n", __func__,\r\nfb->pixel_format);\r\nreturn -EINVAL;\r\n}\r\nif (src_w >> 16 != crtc_w || src_h >> 16 != crtc_h) {\r\ndev_dbg(rcdu->dev, "%s: scaling not supported\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nnplanes = rplane->format ? rplane->format->planes : 0;\r\nif (format->planes != nplanes) {\r\nrcar_du_plane_release(rplane);\r\nret = rcar_du_plane_reserve(rplane, format);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nrplane->crtc = crtc;\r\nrplane->format = format;\r\nrplane->pitch = fb->pitches[0];\r\nrplane->src_x = src_x >> 16;\r\nrplane->src_y = src_y >> 16;\r\nrplane->dst_x = crtc_x;\r\nrplane->dst_y = crtc_y;\r\nrplane->width = crtc_w;\r\nrplane->height = crtc_h;\r\nrcar_du_plane_compute_base(rplane, fb);\r\nrcar_du_plane_setup(rplane);\r\nmutex_lock(&rplane->group->planes.lock);\r\nrplane->enabled = true;\r\nrcar_du_crtc_update_planes(rplane->crtc);\r\nmutex_unlock(&rplane->group->planes.lock);\r\nreturn 0;\r\n}\r\nstatic int rcar_du_plane_disable(struct drm_plane *plane)\r\n{\r\nstruct rcar_du_plane *rplane = to_rcar_plane(plane);\r\nif (!rplane->enabled)\r\nreturn 0;\r\nmutex_lock(&rplane->group->planes.lock);\r\nrplane->enabled = false;\r\nrcar_du_crtc_update_planes(rplane->crtc);\r\nmutex_unlock(&rplane->group->planes.lock);\r\nrcar_du_plane_release(rplane);\r\nrplane->crtc = NULL;\r\nrplane->format = NULL;\r\nreturn 0;\r\n}\r\nstatic void rcar_du_plane_set_alpha(struct rcar_du_plane *plane, u32 alpha)\r\n{\r\nif (plane->alpha == alpha)\r\nreturn;\r\nplane->alpha = alpha;\r\nif (!plane->enabled || plane->format->fourcc != DRM_FORMAT_XRGB1555)\r\nreturn;\r\nrcar_du_plane_setup_mode(plane, plane->hwindex);\r\n}\r\nstatic void rcar_du_plane_set_colorkey(struct rcar_du_plane *plane,\r\nu32 colorkey)\r\n{\r\nif (plane->colorkey == colorkey)\r\nreturn;\r\nplane->colorkey = colorkey;\r\nif (!plane->enabled)\r\nreturn;\r\nrcar_du_plane_setup_mode(plane, plane->hwindex);\r\n}\r\nstatic void rcar_du_plane_set_zpos(struct rcar_du_plane *plane,\r\nunsigned int zpos)\r\n{\r\nmutex_lock(&plane->group->planes.lock);\r\nif (plane->zpos == zpos)\r\ngoto done;\r\nplane->zpos = zpos;\r\nif (!plane->enabled)\r\ngoto done;\r\nrcar_du_crtc_update_planes(plane->crtc);\r\ndone:\r\nmutex_unlock(&plane->group->planes.lock);\r\n}\r\nstatic int rcar_du_plane_set_property(struct drm_plane *plane,\r\nstruct drm_property *property,\r\nuint64_t value)\r\n{\r\nstruct rcar_du_plane *rplane = to_rcar_plane(plane);\r\nstruct rcar_du_group *rgrp = rplane->group;\r\nif (property == rgrp->planes.alpha)\r\nrcar_du_plane_set_alpha(rplane, value);\r\nelse if (property == rgrp->planes.colorkey)\r\nrcar_du_plane_set_colorkey(rplane, value);\r\nelse if (property == rgrp->planes.zpos)\r\nrcar_du_plane_set_zpos(rplane, value);\r\nelse\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nint rcar_du_planes_init(struct rcar_du_group *rgrp)\r\n{\r\nstruct rcar_du_planes *planes = &rgrp->planes;\r\nstruct rcar_du_device *rcdu = rgrp->dev;\r\nunsigned int i;\r\nmutex_init(&planes->lock);\r\nplanes->free = 0xff;\r\nplanes->alpha =\r\ndrm_property_create_range(rcdu->ddev, 0, "alpha", 0, 255);\r\nif (planes->alpha == NULL)\r\nreturn -ENOMEM;\r\nplanes->colorkey =\r\ndrm_property_create_range(rcdu->ddev, 0, "colorkey",\r\n0, 0x01ffffff);\r\nif (planes->colorkey == NULL)\r\nreturn -ENOMEM;\r\nplanes->zpos =\r\ndrm_property_create_range(rcdu->ddev, 0, "zpos", 1, 7);\r\nif (planes->zpos == NULL)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < ARRAY_SIZE(planes->planes); ++i) {\r\nstruct rcar_du_plane *plane = &planes->planes[i];\r\nplane->group = rgrp;\r\nplane->hwindex = -1;\r\nplane->alpha = 255;\r\nplane->colorkey = RCAR_DU_COLORKEY_NONE;\r\nplane->zpos = 0;\r\n}\r\nreturn 0;\r\n}\r\nint rcar_du_planes_register(struct rcar_du_group *rgrp)\r\n{\r\nstruct rcar_du_planes *planes = &rgrp->planes;\r\nstruct rcar_du_device *rcdu = rgrp->dev;\r\nunsigned int crtcs;\r\nunsigned int i;\r\nint ret;\r\ncrtcs = ((1 << rcdu->num_crtcs) - 1) & (3 << (2 * rgrp->index));\r\nfor (i = 0; i < RCAR_DU_NUM_KMS_PLANES; ++i) {\r\nstruct rcar_du_kms_plane *plane;\r\nplane = devm_kzalloc(rcdu->dev, sizeof(*plane), GFP_KERNEL);\r\nif (plane == NULL)\r\nreturn -ENOMEM;\r\nplane->hwplane = &planes->planes[i + 2];\r\nplane->hwplane->zpos = 1;\r\nret = drm_plane_init(rcdu->ddev, &plane->plane, crtcs,\r\n&rcar_du_plane_funcs, formats,\r\nARRAY_SIZE(formats), false);\r\nif (ret < 0)\r\nreturn ret;\r\ndrm_object_attach_property(&plane->plane.base,\r\nplanes->alpha, 255);\r\ndrm_object_attach_property(&plane->plane.base,\r\nplanes->colorkey,\r\nRCAR_DU_COLORKEY_NONE);\r\ndrm_object_attach_property(&plane->plane.base,\r\nplanes->zpos, 1);\r\n}\r\nreturn 0;\r\n}

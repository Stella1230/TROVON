static inline void pdregw(void *data, u32 val)\r\n{\r\nstruct Hydra *hydra = (struct Hydra *)data;\r\nwritel(val, &hydra->CachePD);\r\n}\r\nstatic inline u32 pdregr(void *data)\r\n{\r\nstruct Hydra *hydra = (struct Hydra *)data;\r\nreturn readl(&hydra->CachePD);\r\n}\r\nstatic void hydra_bit_setscl(void *data, int state)\r\n{\r\nu32 val = pdregr(data);\r\nif (state)\r\nval &= ~HYDRA_SCLK_OE;\r\nelse {\r\nval &= ~HYDRA_SCLK;\r\nval |= HYDRA_SCLK_OE;\r\n}\r\npdregw(data, val);\r\n}\r\nstatic void hydra_bit_setsda(void *data, int state)\r\n{\r\nu32 val = pdregr(data);\r\nif (state)\r\nval &= ~HYDRA_SDAT_OE;\r\nelse {\r\nval &= ~HYDRA_SDAT;\r\nval |= HYDRA_SDAT_OE;\r\n}\r\npdregw(data, val);\r\n}\r\nstatic int hydra_bit_getscl(void *data)\r\n{\r\nreturn (pdregr(data) & HYDRA_SCLK) != 0;\r\n}\r\nstatic int hydra_bit_getsda(void *data)\r\n{\r\nreturn (pdregr(data) & HYDRA_SDAT) != 0;\r\n}\r\nstatic int hydra_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nunsigned long base = pci_resource_start(dev, 0);\r\nint res;\r\nif (!request_mem_region(base+offsetof(struct Hydra, CachePD), 4,\r\nhydra_adap.name))\r\nreturn -EBUSY;\r\nhydra_bit_data.data = pci_ioremap_bar(dev, 0);\r\nif (hydra_bit_data.data == NULL) {\r\nrelease_mem_region(base+offsetof(struct Hydra, CachePD), 4);\r\nreturn -ENODEV;\r\n}\r\npdregw(hydra_bit_data.data, 0);\r\nhydra_adap.dev.parent = &dev->dev;\r\nres = i2c_bit_add_bus(&hydra_adap);\r\nif (res < 0) {\r\niounmap(hydra_bit_data.data);\r\nrelease_mem_region(base+offsetof(struct Hydra, CachePD), 4);\r\nreturn res;\r\n}\r\nreturn 0;\r\n}\r\nstatic void hydra_remove(struct pci_dev *dev)\r\n{\r\npdregw(hydra_bit_data.data, 0);\r\ni2c_del_adapter(&hydra_adap);\r\niounmap(hydra_bit_data.data);\r\nrelease_mem_region(pci_resource_start(dev, 0)+\r\noffsetof(struct Hydra, CachePD), 4);\r\n}

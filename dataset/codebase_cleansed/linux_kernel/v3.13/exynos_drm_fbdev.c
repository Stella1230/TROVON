static int exynos_drm_fb_mmap(struct fb_info *info,\r\nstruct vm_area_struct *vma)\r\n{\r\nstruct drm_fb_helper *helper = info->par;\r\nstruct exynos_drm_fbdev *exynos_fbd = to_exynos_fbdev(helper);\r\nstruct exynos_drm_gem_obj *exynos_gem_obj = exynos_fbd->exynos_gem_obj;\r\nstruct exynos_drm_gem_buf *buffer = exynos_gem_obj->buffer;\r\nunsigned long vm_size;\r\nint ret;\r\nvma->vm_flags |= VM_IO | VM_DONTEXPAND | VM_DONTDUMP;\r\nvm_size = vma->vm_end - vma->vm_start;\r\nif (vm_size > buffer->size)\r\nreturn -EINVAL;\r\nret = dma_mmap_attrs(helper->dev->dev, vma, buffer->pages,\r\nbuffer->dma_addr, buffer->size, &buffer->dma_attrs);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to mmap.\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int exynos_drm_fbdev_update(struct drm_fb_helper *helper,\r\nstruct drm_framebuffer *fb)\r\n{\r\nstruct fb_info *fbi = helper->fbdev;\r\nstruct drm_device *dev = helper->dev;\r\nstruct exynos_drm_gem_buf *buffer;\r\nunsigned int size = fb->width * fb->height * (fb->bits_per_pixel >> 3);\r\nunsigned long offset;\r\ndrm_fb_helper_fill_fix(fbi, fb->pitches[0], fb->depth);\r\ndrm_fb_helper_fill_var(fbi, helper, fb->width, fb->height);\r\nbuffer = exynos_drm_fb_buffer(fb, 0);\r\nif (!buffer) {\r\nDRM_LOG_KMS("buffer is null.\n");\r\nreturn -EFAULT;\r\n}\r\nif (!buffer->kvaddr) {\r\nif (is_drm_iommu_supported(dev)) {\r\nunsigned int nr_pages = buffer->size >> PAGE_SHIFT;\r\nbuffer->kvaddr = (void __iomem *) vmap(buffer->pages,\r\nnr_pages, VM_MAP,\r\npgprot_writecombine(PAGE_KERNEL));\r\n} else {\r\nphys_addr_t dma_addr = buffer->dma_addr;\r\nif (dma_addr)\r\nbuffer->kvaddr = (void __iomem *)phys_to_virt(dma_addr);\r\nelse\r\nbuffer->kvaddr = (void __iomem *)NULL;\r\n}\r\nif (!buffer->kvaddr) {\r\nDRM_ERROR("failed to map pages to kernel space.\n");\r\nreturn -EIO;\r\n}\r\n}\r\nexynos_drm_fb_set_buf_cnt(fb, 1);\r\noffset = fbi->var.xoffset * (fb->bits_per_pixel >> 3);\r\noffset += fbi->var.yoffset * fb->pitches[0];\r\ndev->mode_config.fb_base = (resource_size_t)buffer->dma_addr;\r\nfbi->screen_base = buffer->kvaddr + offset;\r\nif (is_drm_iommu_supported(dev))\r\nfbi->fix.smem_start = (unsigned long)\r\n(page_to_phys(sg_page(buffer->sgt->sgl)) + offset);\r\nelse\r\nfbi->fix.smem_start = (unsigned long)buffer->dma_addr;\r\nfbi->screen_size = size;\r\nfbi->fix.smem_len = size;\r\nreturn 0;\r\n}\r\nstatic int exynos_drm_fbdev_create(struct drm_fb_helper *helper,\r\nstruct drm_fb_helper_surface_size *sizes)\r\n{\r\nstruct exynos_drm_fbdev *exynos_fbdev = to_exynos_fbdev(helper);\r\nstruct exynos_drm_gem_obj *exynos_gem_obj;\r\nstruct drm_device *dev = helper->dev;\r\nstruct fb_info *fbi;\r\nstruct drm_mode_fb_cmd2 mode_cmd = { 0 };\r\nstruct platform_device *pdev = dev->platformdev;\r\nunsigned long size;\r\nint ret;\r\nDRM_DEBUG_KMS("surface width(%d), height(%d) and bpp(%d\n",\r\nsizes->surface_width, sizes->surface_height,\r\nsizes->surface_bpp);\r\nmode_cmd.width = sizes->surface_width;\r\nmode_cmd.height = sizes->surface_height;\r\nmode_cmd.pitches[0] = sizes->surface_width * (sizes->surface_bpp >> 3);\r\nmode_cmd.pixel_format = drm_mode_legacy_fb_format(sizes->surface_bpp,\r\nsizes->surface_depth);\r\nmutex_lock(&dev->struct_mutex);\r\nfbi = framebuffer_alloc(0, &pdev->dev);\r\nif (!fbi) {\r\nDRM_ERROR("failed to allocate fb info.\n");\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nsize = mode_cmd.pitches[0] * mode_cmd.height;\r\nexynos_gem_obj = exynos_drm_gem_create(dev, EXYNOS_BO_CONTIG, size);\r\nif (IS_ERR(exynos_gem_obj) && is_drm_iommu_supported(dev)) {\r\ndev_warn(&pdev->dev, "contiguous FB allocation failed, falling back to non-contiguous\n");\r\nexynos_gem_obj = exynos_drm_gem_create(dev, EXYNOS_BO_NONCONTIG,\r\nsize);\r\n}\r\nif (IS_ERR(exynos_gem_obj)) {\r\nret = PTR_ERR(exynos_gem_obj);\r\ngoto err_release_framebuffer;\r\n}\r\nexynos_fbdev->exynos_gem_obj = exynos_gem_obj;\r\nhelper->fb = exynos_drm_framebuffer_init(dev, &mode_cmd,\r\n&exynos_gem_obj->base);\r\nif (IS_ERR(helper->fb)) {\r\nDRM_ERROR("failed to create drm framebuffer.\n");\r\nret = PTR_ERR(helper->fb);\r\ngoto err_destroy_gem;\r\n}\r\nhelper->fbdev = fbi;\r\nfbi->par = helper;\r\nfbi->flags = FBINFO_FLAG_DEFAULT;\r\nfbi->fbops = &exynos_drm_fb_ops;\r\nret = fb_alloc_cmap(&fbi->cmap, 256, 0);\r\nif (ret) {\r\nDRM_ERROR("failed to allocate cmap.\n");\r\ngoto err_destroy_framebuffer;\r\n}\r\nret = exynos_drm_fbdev_update(helper, helper->fb);\r\nif (ret < 0)\r\ngoto err_dealloc_cmap;\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn ret;\r\nerr_dealloc_cmap:\r\nfb_dealloc_cmap(&fbi->cmap);\r\nerr_destroy_framebuffer:\r\ndrm_framebuffer_cleanup(helper->fb);\r\nerr_destroy_gem:\r\nexynos_drm_gem_destroy(exynos_gem_obj);\r\nerr_release_framebuffer:\r\nframebuffer_release(fbi);\r\nout:\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn ret;\r\n}\r\nint exynos_drm_fbdev_init(struct drm_device *dev)\r\n{\r\nstruct exynos_drm_fbdev *fbdev;\r\nstruct exynos_drm_private *private = dev->dev_private;\r\nstruct drm_fb_helper *helper;\r\nunsigned int num_crtc;\r\nint ret;\r\nif (!dev->mode_config.num_crtc || !dev->mode_config.num_connector)\r\nreturn 0;\r\nfbdev = kzalloc(sizeof(*fbdev), GFP_KERNEL);\r\nif (!fbdev)\r\nreturn -ENOMEM;\r\nprivate->fb_helper = helper = &fbdev->drm_fb_helper;\r\nhelper->funcs = &exynos_drm_fb_helper_funcs;\r\nnum_crtc = dev->mode_config.num_crtc;\r\nret = drm_fb_helper_init(dev, helper, num_crtc, MAX_CONNECTOR);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to initialize drm fb helper.\n");\r\ngoto err_init;\r\n}\r\nret = drm_fb_helper_single_add_all_connectors(helper);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to register drm_fb_helper_connector.\n");\r\ngoto err_setup;\r\n}\r\ndrm_helper_disable_unused_functions(dev);\r\nret = drm_fb_helper_initial_config(helper, PREFERRED_BPP);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to set up hw configuration.\n");\r\ngoto err_setup;\r\n}\r\nreturn 0;\r\nerr_setup:\r\ndrm_fb_helper_fini(helper);\r\nerr_init:\r\nprivate->fb_helper = NULL;\r\nkfree(fbdev);\r\nreturn ret;\r\n}\r\nstatic void exynos_drm_fbdev_destroy(struct drm_device *dev,\r\nstruct drm_fb_helper *fb_helper)\r\n{\r\nstruct exynos_drm_fbdev *exynos_fbd = to_exynos_fbdev(fb_helper);\r\nstruct exynos_drm_gem_obj *exynos_gem_obj = exynos_fbd->exynos_gem_obj;\r\nstruct drm_framebuffer *fb;\r\nif (is_drm_iommu_supported(dev) && exynos_gem_obj->buffer->kvaddr)\r\nvunmap(exynos_gem_obj->buffer->kvaddr);\r\nif (fb_helper->fb && fb_helper->fb->funcs) {\r\nfb = fb_helper->fb;\r\nif (fb) {\r\ndrm_framebuffer_unregister_private(fb);\r\ndrm_framebuffer_remove(fb);\r\n}\r\n}\r\nif (fb_helper->fbdev) {\r\nstruct fb_info *info;\r\nint ret;\r\ninfo = fb_helper->fbdev;\r\nret = unregister_framebuffer(info);\r\nif (ret < 0)\r\nDRM_DEBUG_KMS("failed unregister_framebuffer()\n");\r\nif (info->cmap.len)\r\nfb_dealloc_cmap(&info->cmap);\r\nframebuffer_release(info);\r\n}\r\ndrm_fb_helper_fini(fb_helper);\r\n}\r\nvoid exynos_drm_fbdev_fini(struct drm_device *dev)\r\n{\r\nstruct exynos_drm_private *private = dev->dev_private;\r\nstruct exynos_drm_fbdev *fbdev;\r\nif (!private || !private->fb_helper)\r\nreturn;\r\nfbdev = to_exynos_fbdev(private->fb_helper);\r\nif (fbdev->exynos_gem_obj)\r\nexynos_drm_gem_destroy(fbdev->exynos_gem_obj);\r\nexynos_drm_fbdev_destroy(dev, private->fb_helper);\r\nkfree(fbdev);\r\nprivate->fb_helper = NULL;\r\n}\r\nvoid exynos_drm_fbdev_restore_mode(struct drm_device *dev)\r\n{\r\nstruct exynos_drm_private *private = dev->dev_private;\r\nif (!private || !private->fb_helper)\r\nreturn;\r\ndrm_modeset_lock_all(dev);\r\ndrm_fb_helper_restore_fbdev_mode(private->fb_helper);\r\ndrm_modeset_unlock_all(dev);\r\n}

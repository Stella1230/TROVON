static int snd_gf1_get_single(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_gus_card *gus = snd_kcontrol_chip(kcontrol);\r\nint shift = kcontrol->private_value & 0xff;\r\nint invert = (kcontrol->private_value >> 8) & 1;\r\nucontrol->value.integer.value[0] = (gus->mix_cntrl_reg >> shift) & 1;\r\nif (invert)\r\nucontrol->value.integer.value[0] ^= 1;\r\nreturn 0;\r\n}\r\nstatic int snd_gf1_put_single(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_gus_card *gus = snd_kcontrol_chip(kcontrol);\r\nunsigned long flags;\r\nint shift = kcontrol->private_value & 0xff;\r\nint invert = (kcontrol->private_value >> 8) & 1;\r\nint change;\r\nunsigned char oval, nval;\r\nnval = ucontrol->value.integer.value[0] & 1;\r\nif (invert)\r\nnval ^= 1;\r\nnval <<= shift;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\noval = gus->mix_cntrl_reg;\r\nnval = (oval & ~(1 << shift)) | nval;\r\nchange = nval != oval;\r\noutb(gus->mix_cntrl_reg = nval, GUSP(gus, MIXCNTRLREG));\r\noutb(gus->gf1.active_voice = 0, GUSP(gus, GF1PAGE));\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\nreturn change;\r\n}\r\nstatic int snd_ics_info_double(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 2;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 127;\r\nreturn 0;\r\n}\r\nstatic int snd_ics_get_double(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_gus_card *gus = snd_kcontrol_chip(kcontrol);\r\nunsigned long flags;\r\nint addr = kcontrol->private_value & 0xff;\r\nunsigned char left, right;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\nleft = gus->gf1.ics_regs[addr][0];\r\nright = gus->gf1.ics_regs[addr][1];\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\nucontrol->value.integer.value[0] = left & 127;\r\nucontrol->value.integer.value[1] = right & 127;\r\nreturn 0;\r\n}\r\nstatic int snd_ics_put_double(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_gus_card *gus = snd_kcontrol_chip(kcontrol);\r\nunsigned long flags;\r\nint addr = kcontrol->private_value & 0xff;\r\nint change;\r\nunsigned char val1, val2, oval1, oval2, tmp;\r\nval1 = ucontrol->value.integer.value[0] & 127;\r\nval2 = ucontrol->value.integer.value[1] & 127;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\noval1 = gus->gf1.ics_regs[addr][0];\r\noval2 = gus->gf1.ics_regs[addr][1];\r\nchange = val1 != oval1 || val2 != oval2;\r\ngus->gf1.ics_regs[addr][0] = val1;\r\ngus->gf1.ics_regs[addr][1] = val2;\r\nif (gus->ics_flag && gus->ics_flipped &&\r\n(addr == SNDRV_ICS_GF1_DEV || addr == SNDRV_ICS_MASTER_DEV)) {\r\ntmp = val1;\r\nval1 = val2;\r\nval2 = tmp;\r\n}\r\naddr <<= 3;\r\noutb(addr | 0, GUSP(gus, MIXCNTRLPORT));\r\noutb(1, GUSP(gus, MIXDATAPORT));\r\noutb(addr | 2, GUSP(gus, MIXCNTRLPORT));\r\noutb((unsigned char) val1, GUSP(gus, MIXDATAPORT));\r\noutb(addr | 1, GUSP(gus, MIXCNTRLPORT));\r\noutb(2, GUSP(gus, MIXDATAPORT));\r\noutb(addr | 3, GUSP(gus, MIXCNTRLPORT));\r\noutb((unsigned char) val2, GUSP(gus, MIXDATAPORT));\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\nreturn change;\r\n}\r\nint snd_gf1_new_mixer(struct snd_gus_card * gus)\r\n{\r\nstruct snd_card *card;\r\nunsigned int idx, max;\r\nint err;\r\nif (snd_BUG_ON(!gus))\r\nreturn -EINVAL;\r\ncard = gus->card;\r\nif (snd_BUG_ON(!card))\r\nreturn -EINVAL;\r\nif (gus->ics_flag)\r\nsnd_component_add(card, "ICS2101");\r\nif (card->mixername[0] == '\0') {\r\nstrcpy(card->mixername, gus->ics_flag ? "GF1,ICS2101" : "GF1");\r\n} else {\r\nif (gus->ics_flag)\r\nstrcat(card->mixername, ",ICS2101");\r\nstrcat(card->mixername, ",GF1");\r\n}\r\nif (!gus->ics_flag) {\r\nmax = gus->ess_flag ? 1 : ARRAY_SIZE(snd_gf1_controls);\r\nfor (idx = 0; idx < max; idx++) {\r\nif ((err = snd_ctl_add(card, snd_ctl_new1(&snd_gf1_controls[idx], gus))) < 0)\r\nreturn err;\r\n}\r\n} else {\r\nfor (idx = 0; idx < ARRAY_SIZE(snd_ics_controls); idx++) {\r\nif ((err = snd_ctl_add(card, snd_ctl_new1(&snd_ics_controls[idx], gus))) < 0)\r\nreturn err;\r\n}\r\n}\r\nreturn 0;\r\n}

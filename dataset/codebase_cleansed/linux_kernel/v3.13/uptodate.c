u64 ocfs2_metadata_cache_owner(struct ocfs2_caching_info *ci)\r\n{\r\nBUG_ON(!ci || !ci->ci_ops);\r\nreturn ci->ci_ops->co_owner(ci);\r\n}\r\nstruct super_block *ocfs2_metadata_cache_get_super(struct ocfs2_caching_info *ci)\r\n{\r\nBUG_ON(!ci || !ci->ci_ops);\r\nreturn ci->ci_ops->co_get_super(ci);\r\n}\r\nstatic void ocfs2_metadata_cache_lock(struct ocfs2_caching_info *ci)\r\n{\r\nBUG_ON(!ci || !ci->ci_ops);\r\nci->ci_ops->co_cache_lock(ci);\r\n}\r\nstatic void ocfs2_metadata_cache_unlock(struct ocfs2_caching_info *ci)\r\n{\r\nBUG_ON(!ci || !ci->ci_ops);\r\nci->ci_ops->co_cache_unlock(ci);\r\n}\r\nvoid ocfs2_metadata_cache_io_lock(struct ocfs2_caching_info *ci)\r\n{\r\nBUG_ON(!ci || !ci->ci_ops);\r\nci->ci_ops->co_io_lock(ci);\r\n}\r\nvoid ocfs2_metadata_cache_io_unlock(struct ocfs2_caching_info *ci)\r\n{\r\nBUG_ON(!ci || !ci->ci_ops);\r\nci->ci_ops->co_io_unlock(ci);\r\n}\r\nstatic void ocfs2_metadata_cache_reset(struct ocfs2_caching_info *ci,\r\nint clear)\r\n{\r\nci->ci_flags |= OCFS2_CACHE_FL_INLINE;\r\nci->ci_num_cached = 0;\r\nif (clear) {\r\nci->ci_created_trans = 0;\r\nci->ci_last_trans = 0;\r\n}\r\n}\r\nvoid ocfs2_metadata_cache_init(struct ocfs2_caching_info *ci,\r\nconst struct ocfs2_caching_operations *ops)\r\n{\r\nBUG_ON(!ops);\r\nci->ci_ops = ops;\r\nocfs2_metadata_cache_reset(ci, 1);\r\n}\r\nvoid ocfs2_metadata_cache_exit(struct ocfs2_caching_info *ci)\r\n{\r\nocfs2_metadata_cache_purge(ci);\r\nocfs2_metadata_cache_reset(ci, 1);\r\n}\r\nstatic unsigned int ocfs2_purge_copied_metadata_tree(struct rb_root *root)\r\n{\r\nunsigned int purged = 0;\r\nstruct rb_node *node;\r\nstruct ocfs2_meta_cache_item *item;\r\nwhile ((node = rb_last(root)) != NULL) {\r\nitem = rb_entry(node, struct ocfs2_meta_cache_item, c_node);\r\ntrace_ocfs2_purge_copied_metadata_tree(\r\n(unsigned long long) item->c_block);\r\nrb_erase(&item->c_node, root);\r\nkmem_cache_free(ocfs2_uptodate_cachep, item);\r\npurged++;\r\n}\r\nreturn purged;\r\n}\r\nvoid ocfs2_metadata_cache_purge(struct ocfs2_caching_info *ci)\r\n{\r\nunsigned int tree, to_purge, purged;\r\nstruct rb_root root = RB_ROOT;\r\nBUG_ON(!ci || !ci->ci_ops);\r\nocfs2_metadata_cache_lock(ci);\r\ntree = !(ci->ci_flags & OCFS2_CACHE_FL_INLINE);\r\nto_purge = ci->ci_num_cached;\r\ntrace_ocfs2_metadata_cache_purge(\r\n(unsigned long long)ocfs2_metadata_cache_owner(ci),\r\nto_purge, tree);\r\nif (tree)\r\nroot = ci->ci_cache.ci_tree;\r\nocfs2_metadata_cache_reset(ci, 0);\r\nocfs2_metadata_cache_unlock(ci);\r\npurged = ocfs2_purge_copied_metadata_tree(&root);\r\nif (tree && purged != to_purge)\r\nmlog(ML_ERROR, "Owner %llu, count = %u, purged = %u\n",\r\n(unsigned long long)ocfs2_metadata_cache_owner(ci),\r\nto_purge, purged);\r\n}\r\nstatic int ocfs2_search_cache_array(struct ocfs2_caching_info *ci,\r\nsector_t item)\r\n{\r\nint i;\r\nfor (i = 0; i < ci->ci_num_cached; i++) {\r\nif (item == ci->ci_cache.ci_array[i])\r\nreturn i;\r\n}\r\nreturn -1;\r\n}\r\nstatic struct ocfs2_meta_cache_item *\r\nocfs2_search_cache_tree(struct ocfs2_caching_info *ci,\r\nsector_t block)\r\n{\r\nstruct rb_node * n = ci->ci_cache.ci_tree.rb_node;\r\nstruct ocfs2_meta_cache_item *item = NULL;\r\nwhile (n) {\r\nitem = rb_entry(n, struct ocfs2_meta_cache_item, c_node);\r\nif (block < item->c_block)\r\nn = n->rb_left;\r\nelse if (block > item->c_block)\r\nn = n->rb_right;\r\nelse\r\nreturn item;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int ocfs2_buffer_cached(struct ocfs2_caching_info *ci,\r\nstruct buffer_head *bh)\r\n{\r\nint index = -1;\r\nstruct ocfs2_meta_cache_item *item = NULL;\r\nocfs2_metadata_cache_lock(ci);\r\ntrace_ocfs2_buffer_cached_begin(\r\n(unsigned long long)ocfs2_metadata_cache_owner(ci),\r\n(unsigned long long) bh->b_blocknr,\r\n!!(ci->ci_flags & OCFS2_CACHE_FL_INLINE));\r\nif (ci->ci_flags & OCFS2_CACHE_FL_INLINE)\r\nindex = ocfs2_search_cache_array(ci, bh->b_blocknr);\r\nelse\r\nitem = ocfs2_search_cache_tree(ci, bh->b_blocknr);\r\nocfs2_metadata_cache_unlock(ci);\r\ntrace_ocfs2_buffer_cached_end(index, item);\r\nreturn (index != -1) || (item != NULL);\r\n}\r\nint ocfs2_buffer_uptodate(struct ocfs2_caching_info *ci,\r\nstruct buffer_head *bh)\r\n{\r\nif (!buffer_uptodate(bh))\r\nreturn 0;\r\nif (buffer_jbd(bh))\r\nreturn 1;\r\nreturn ocfs2_buffer_cached(ci, bh);\r\n}\r\nint ocfs2_buffer_read_ahead(struct ocfs2_caching_info *ci,\r\nstruct buffer_head *bh)\r\n{\r\nreturn buffer_locked(bh) && ocfs2_buffer_cached(ci, bh);\r\n}\r\nstatic void ocfs2_append_cache_array(struct ocfs2_caching_info *ci,\r\nsector_t block)\r\n{\r\nBUG_ON(ci->ci_num_cached >= OCFS2_CACHE_INFO_MAX_ARRAY);\r\ntrace_ocfs2_append_cache_array(\r\n(unsigned long long)ocfs2_metadata_cache_owner(ci),\r\n(unsigned long long)block, ci->ci_num_cached);\r\nci->ci_cache.ci_array[ci->ci_num_cached] = block;\r\nci->ci_num_cached++;\r\n}\r\nstatic void __ocfs2_insert_cache_tree(struct ocfs2_caching_info *ci,\r\nstruct ocfs2_meta_cache_item *new)\r\n{\r\nsector_t block = new->c_block;\r\nstruct rb_node *parent = NULL;\r\nstruct rb_node **p = &ci->ci_cache.ci_tree.rb_node;\r\nstruct ocfs2_meta_cache_item *tmp;\r\ntrace_ocfs2_insert_cache_tree(\r\n(unsigned long long)ocfs2_metadata_cache_owner(ci),\r\n(unsigned long long)block, ci->ci_num_cached);\r\nwhile(*p) {\r\nparent = *p;\r\ntmp = rb_entry(parent, struct ocfs2_meta_cache_item, c_node);\r\nif (block < tmp->c_block)\r\np = &(*p)->rb_left;\r\nelse if (block > tmp->c_block)\r\np = &(*p)->rb_right;\r\nelse {\r\nmlog(ML_ERROR, "Duplicate block %llu cached!\n",\r\n(unsigned long long) block);\r\nBUG();\r\n}\r\n}\r\nrb_link_node(&new->c_node, parent, p);\r\nrb_insert_color(&new->c_node, &ci->ci_cache.ci_tree);\r\nci->ci_num_cached++;\r\n}\r\nstatic inline int ocfs2_insert_can_use_array(struct ocfs2_caching_info *ci)\r\n{\r\nreturn (ci->ci_flags & OCFS2_CACHE_FL_INLINE) &&\r\n(ci->ci_num_cached < OCFS2_CACHE_INFO_MAX_ARRAY);\r\n}\r\nstatic void ocfs2_expand_cache(struct ocfs2_caching_info *ci,\r\nstruct ocfs2_meta_cache_item **tree)\r\n{\r\nint i;\r\nmlog_bug_on_msg(ci->ci_num_cached != OCFS2_CACHE_INFO_MAX_ARRAY,\r\n"Owner %llu, num cached = %u, should be %u\n",\r\n(unsigned long long)ocfs2_metadata_cache_owner(ci),\r\nci->ci_num_cached, OCFS2_CACHE_INFO_MAX_ARRAY);\r\nmlog_bug_on_msg(!(ci->ci_flags & OCFS2_CACHE_FL_INLINE),\r\n"Owner %llu not marked as inline anymore!\n",\r\n(unsigned long long)ocfs2_metadata_cache_owner(ci));\r\nfor (i = 0; i < OCFS2_CACHE_INFO_MAX_ARRAY; i++)\r\ntree[i]->c_block = ci->ci_cache.ci_array[i];\r\nci->ci_flags &= ~OCFS2_CACHE_FL_INLINE;\r\nci->ci_cache.ci_tree = RB_ROOT;\r\nci->ci_num_cached = 0;\r\nfor (i = 0; i < OCFS2_CACHE_INFO_MAX_ARRAY; i++) {\r\n__ocfs2_insert_cache_tree(ci, tree[i]);\r\ntree[i] = NULL;\r\n}\r\ntrace_ocfs2_expand_cache(\r\n(unsigned long long)ocfs2_metadata_cache_owner(ci),\r\nci->ci_flags, ci->ci_num_cached);\r\n}\r\nstatic void __ocfs2_set_buffer_uptodate(struct ocfs2_caching_info *ci,\r\nsector_t block,\r\nint expand_tree)\r\n{\r\nint i;\r\nstruct ocfs2_meta_cache_item *new = NULL;\r\nstruct ocfs2_meta_cache_item *tree[OCFS2_CACHE_INFO_MAX_ARRAY] =\r\n{ NULL, };\r\ntrace_ocfs2_set_buffer_uptodate(\r\n(unsigned long long)ocfs2_metadata_cache_owner(ci),\r\n(unsigned long long)block, expand_tree);\r\nnew = kmem_cache_alloc(ocfs2_uptodate_cachep, GFP_NOFS);\r\nif (!new) {\r\nmlog_errno(-ENOMEM);\r\nreturn;\r\n}\r\nnew->c_block = block;\r\nif (expand_tree) {\r\nfor (i = 0; i < OCFS2_CACHE_INFO_MAX_ARRAY; i++) {\r\ntree[i] = kmem_cache_alloc(ocfs2_uptodate_cachep,\r\nGFP_NOFS);\r\nif (!tree[i]) {\r\nmlog_errno(-ENOMEM);\r\ngoto out_free;\r\n}\r\n}\r\n}\r\nocfs2_metadata_cache_lock(ci);\r\nif (ocfs2_insert_can_use_array(ci)) {\r\nocfs2_append_cache_array(ci, block);\r\nocfs2_metadata_cache_unlock(ci);\r\ngoto out_free;\r\n}\r\nif (expand_tree)\r\nocfs2_expand_cache(ci, tree);\r\n__ocfs2_insert_cache_tree(ci, new);\r\nocfs2_metadata_cache_unlock(ci);\r\nnew = NULL;\r\nout_free:\r\nif (new)\r\nkmem_cache_free(ocfs2_uptodate_cachep, new);\r\nif (tree[0]) {\r\nfor (i = 0; i < OCFS2_CACHE_INFO_MAX_ARRAY; i++)\r\nif (tree[i])\r\nkmem_cache_free(ocfs2_uptodate_cachep,\r\ntree[i]);\r\n}\r\n}\r\nvoid ocfs2_set_buffer_uptodate(struct ocfs2_caching_info *ci,\r\nstruct buffer_head *bh)\r\n{\r\nint expand;\r\nif (ocfs2_buffer_cached(ci, bh))\r\nreturn;\r\ntrace_ocfs2_set_buffer_uptodate_begin(\r\n(unsigned long long)ocfs2_metadata_cache_owner(ci),\r\n(unsigned long long)bh->b_blocknr);\r\nocfs2_metadata_cache_lock(ci);\r\nif (ocfs2_insert_can_use_array(ci)) {\r\nocfs2_append_cache_array(ci, bh->b_blocknr);\r\nocfs2_metadata_cache_unlock(ci);\r\nreturn;\r\n}\r\nexpand = 0;\r\nif (ci->ci_flags & OCFS2_CACHE_FL_INLINE) {\r\nexpand = 1;\r\n}\r\nocfs2_metadata_cache_unlock(ci);\r\n__ocfs2_set_buffer_uptodate(ci, bh->b_blocknr, expand);\r\n}\r\nvoid ocfs2_set_new_buffer_uptodate(struct ocfs2_caching_info *ci,\r\nstruct buffer_head *bh)\r\n{\r\nBUG_ON(ocfs2_buffer_cached(ci, bh));\r\nset_buffer_uptodate(bh);\r\nocfs2_metadata_cache_io_lock(ci);\r\nocfs2_set_buffer_uptodate(ci, bh);\r\nocfs2_metadata_cache_io_unlock(ci);\r\n}\r\nstatic void ocfs2_remove_metadata_array(struct ocfs2_caching_info *ci,\r\nint index)\r\n{\r\nsector_t *array = ci->ci_cache.ci_array;\r\nint bytes;\r\nBUG_ON(index < 0 || index >= OCFS2_CACHE_INFO_MAX_ARRAY);\r\nBUG_ON(index >= ci->ci_num_cached);\r\nBUG_ON(!ci->ci_num_cached);\r\ntrace_ocfs2_remove_metadata_array(\r\n(unsigned long long)ocfs2_metadata_cache_owner(ci),\r\nindex, ci->ci_num_cached);\r\nci->ci_num_cached--;\r\nif (ci->ci_num_cached && index < ci->ci_num_cached) {\r\nbytes = sizeof(sector_t) * (ci->ci_num_cached - index);\r\nmemmove(&array[index], &array[index + 1], bytes);\r\n}\r\n}\r\nstatic void ocfs2_remove_metadata_tree(struct ocfs2_caching_info *ci,\r\nstruct ocfs2_meta_cache_item *item)\r\n{\r\ntrace_ocfs2_remove_metadata_tree(\r\n(unsigned long long)ocfs2_metadata_cache_owner(ci),\r\n(unsigned long long)item->c_block);\r\nrb_erase(&item->c_node, &ci->ci_cache.ci_tree);\r\nci->ci_num_cached--;\r\n}\r\nstatic void ocfs2_remove_block_from_cache(struct ocfs2_caching_info *ci,\r\nsector_t block)\r\n{\r\nint index;\r\nstruct ocfs2_meta_cache_item *item = NULL;\r\nocfs2_metadata_cache_lock(ci);\r\ntrace_ocfs2_remove_block_from_cache(\r\n(unsigned long long)ocfs2_metadata_cache_owner(ci),\r\n(unsigned long long) block, ci->ci_num_cached,\r\nci->ci_flags);\r\nif (ci->ci_flags & OCFS2_CACHE_FL_INLINE) {\r\nindex = ocfs2_search_cache_array(ci, block);\r\nif (index != -1)\r\nocfs2_remove_metadata_array(ci, index);\r\n} else {\r\nitem = ocfs2_search_cache_tree(ci, block);\r\nif (item)\r\nocfs2_remove_metadata_tree(ci, item);\r\n}\r\nocfs2_metadata_cache_unlock(ci);\r\nif (item)\r\nkmem_cache_free(ocfs2_uptodate_cachep, item);\r\n}\r\nvoid ocfs2_remove_from_cache(struct ocfs2_caching_info *ci,\r\nstruct buffer_head *bh)\r\n{\r\nsector_t block = bh->b_blocknr;\r\nocfs2_remove_block_from_cache(ci, block);\r\n}\r\nvoid ocfs2_remove_xattr_clusters_from_cache(struct ocfs2_caching_info *ci,\r\nsector_t block,\r\nu32 c_len)\r\n{\r\nstruct super_block *sb = ocfs2_metadata_cache_get_super(ci);\r\nunsigned int i, b_len = ocfs2_clusters_to_blocks(sb, 1) * c_len;\r\nfor (i = 0; i < b_len; i++, block++)\r\nocfs2_remove_block_from_cache(ci, block);\r\n}\r\nint __init init_ocfs2_uptodate_cache(void)\r\n{\r\nocfs2_uptodate_cachep = kmem_cache_create("ocfs2_uptodate",\r\nsizeof(struct ocfs2_meta_cache_item),\r\n0, SLAB_HWCACHE_ALIGN, NULL);\r\nif (!ocfs2_uptodate_cachep)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nvoid exit_ocfs2_uptodate_cache(void)\r\n{\r\nif (ocfs2_uptodate_cachep)\r\nkmem_cache_destroy(ocfs2_uptodate_cachep);\r\n}

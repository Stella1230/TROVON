static inline u8 reg_to_temp(u8 reg_value)\r\n{\r\nreturn ((reg_value & 0x3f) << 1) + TEMP_MIN;\r\n}\r\nstatic inline u8 temp_to_reg(u8 temp)\r\n{\r\nreturn ((temp - TEMP_MIN) >> 1) & 0x3f;\r\n}\r\nstatic struct cbe_pmd_regs __iomem *get_pmd_regs(struct device *dev)\r\n{\r\nstruct spu *spu;\r\nspu = container_of(dev, struct spu, dev);\r\nreturn cbe_get_pmd_regs(spu_devnode(spu));\r\n}\r\nstatic u8 spu_read_register_value(struct device *dev, union spe_reg __iomem *reg)\r\n{\r\nunion spe_reg value;\r\nstruct spu *spu;\r\nspu = container_of(dev, struct spu, dev);\r\nvalue.val = in_be64(&reg->val);\r\nreturn value.spe[spu->spe_id];\r\n}\r\nstatic ssize_t spu_show_temp(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nu8 value;\r\nstruct cbe_pmd_regs __iomem *pmd_regs;\r\npmd_regs = get_pmd_regs(dev);\r\nvalue = spu_read_register_value(dev, &pmd_regs->ts_ctsr1);\r\nreturn sprintf(buf, "%d\n", reg_to_temp(value));\r\n}\r\nstatic ssize_t show_throttle(struct cbe_pmd_regs __iomem *pmd_regs, char *buf, int pos)\r\n{\r\nu64 value;\r\nvalue = in_be64(&pmd_regs->tm_tpr.val);\r\nvalue >>= pos;\r\nvalue &= 0x3F;\r\nreturn sprintf(buf, "%d\n", reg_to_temp(value));\r\n}\r\nstatic ssize_t store_throttle(struct cbe_pmd_regs __iomem *pmd_regs, const char *buf, size_t size, int pos)\r\n{\r\nu64 reg_value;\r\nint temp;\r\nu64 new_value;\r\nint ret;\r\nret = sscanf(buf, "%u", &temp);\r\nif (ret != 1 || temp < TEMP_MIN || temp > TEMP_MAX)\r\nreturn -EINVAL;\r\nnew_value = temp_to_reg(temp);\r\nreg_value = in_be64(&pmd_regs->tm_tpr.val);\r\nreg_value &= ~(0xffull << pos);\r\nreg_value |= new_value << pos;\r\nout_be64(&pmd_regs->tm_tpr.val, reg_value);\r\nreturn size;\r\n}\r\nstatic ssize_t spu_show_throttle_end(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn show_throttle(get_pmd_regs(dev), buf, 0);\r\n}\r\nstatic ssize_t spu_show_throttle_begin(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn show_throttle(get_pmd_regs(dev), buf, 8);\r\n}\r\nstatic ssize_t spu_show_throttle_full_stop(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn show_throttle(get_pmd_regs(dev), buf, 16);\r\n}\r\nstatic ssize_t spu_store_throttle_end(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nreturn store_throttle(get_pmd_regs(dev), buf, size, 0);\r\n}\r\nstatic ssize_t spu_store_throttle_begin(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nreturn store_throttle(get_pmd_regs(dev), buf, size, 8);\r\n}\r\nstatic ssize_t spu_store_throttle_full_stop(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nreturn store_throttle(get_pmd_regs(dev), buf, size, 16);\r\n}\r\nstatic ssize_t ppe_show_temp(struct device *dev, char *buf, int pos)\r\n{\r\nstruct cbe_pmd_regs __iomem *pmd_regs;\r\nu64 value;\r\npmd_regs = cbe_get_cpu_pmd_regs(dev->id);\r\nvalue = in_be64(&pmd_regs->ts_ctsr2);\r\nvalue = (value >> pos) & 0x3f;\r\nreturn sprintf(buf, "%d\n", reg_to_temp(value));\r\n}\r\nstatic ssize_t ppe_show_temp0(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn ppe_show_temp(dev, buf, 32);\r\n}\r\nstatic ssize_t ppe_show_temp1(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn ppe_show_temp(dev, buf, 0);\r\n}\r\nstatic ssize_t ppe_show_throttle_end(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn show_throttle(cbe_get_cpu_pmd_regs(dev->id), buf, 32);\r\n}\r\nstatic ssize_t ppe_show_throttle_begin(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn show_throttle(cbe_get_cpu_pmd_regs(dev->id), buf, 40);\r\n}\r\nstatic ssize_t ppe_show_throttle_full_stop(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn show_throttle(cbe_get_cpu_pmd_regs(dev->id), buf, 48);\r\n}\r\nstatic ssize_t ppe_store_throttle_end(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nreturn store_throttle(cbe_get_cpu_pmd_regs(dev->id), buf, size, 32);\r\n}\r\nstatic ssize_t ppe_store_throttle_begin(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nreturn store_throttle(cbe_get_cpu_pmd_regs(dev->id), buf, size, 40);\r\n}\r\nstatic ssize_t ppe_store_throttle_full_stop(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nreturn store_throttle(cbe_get_cpu_pmd_regs(dev->id), buf, size, 48);\r\n}\r\nstatic int __init init_default_values(void)\r\n{\r\nint cpu;\r\nstruct cbe_pmd_regs __iomem *pmd_regs;\r\nstruct device *dev;\r\nunion ppe_spe_reg tpr;\r\nunion spe_reg str1;\r\nu64 str2;\r\nunion spe_reg cr1;\r\nu64 cr2;\r\ntpr.ppe = 0x1F0803;\r\ntpr.spe = 0x100803;\r\nstr1.val = 0x1010101010101010ull;\r\nstr2 = 0x10;\r\ncr1.val = 0x0404040404040404ull;\r\ncr2 = 0x04;\r\nfor_each_possible_cpu (cpu) {\r\npr_debug("processing cpu %d\n", cpu);\r\ndev = get_cpu_device(cpu);\r\nif (!dev) {\r\npr_info("invalid dev pointer for cbe_thermal\n");\r\nreturn -EINVAL;\r\n}\r\npmd_regs = cbe_get_cpu_pmd_regs(dev->id);\r\nif (!pmd_regs) {\r\npr_info("invalid CBE regs pointer for cbe_thermal\n");\r\nreturn -EINVAL;\r\n}\r\nout_be64(&pmd_regs->tm_str2, str2);\r\nout_be64(&pmd_regs->tm_str1.val, str1.val);\r\nout_be64(&pmd_regs->tm_tpr.val, tpr.val);\r\nout_be64(&pmd_regs->tm_cr1.val, cr1.val);\r\nout_be64(&pmd_regs->tm_cr2, cr2);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init thermal_init(void)\r\n{\r\nint rc = init_default_values();\r\nif (rc == 0) {\r\nspu_add_dev_attr_group(&spu_attribute_group);\r\ncpu_add_dev_attr_group(&ppe_attribute_group);\r\n}\r\nreturn rc;\r\n}\r\nstatic void __exit thermal_exit(void)\r\n{\r\nspu_remove_dev_attr_group(&spu_attribute_group);\r\ncpu_remove_dev_attr_group(&ppe_attribute_group);\r\n}

static int apci1032_reset(struct comedi_device *dev)\r\n{\r\noutl(0x0, dev->iobase + APCI1032_CTRL_REG);\r\ninl(dev->iobase + APCI1032_STATUS_REG);\r\noutl(0x0, dev->iobase + APCI1032_MODE1_REG);\r\noutl(0x0, dev->iobase + APCI1032_MODE2_REG);\r\nreturn 0;\r\n}\r\nstatic int apci1032_cos_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci1032_private *devpriv = dev->private;\r\nunsigned int shift, oldmask;\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_DIGITAL_TRIG:\r\nif (data[1] != 0)\r\nreturn -EINVAL;\r\nshift = data[3];\r\noldmask = (1U << shift) - 1;\r\nswitch (data[2]) {\r\ncase COMEDI_DIGITAL_TRIG_DISABLE:\r\ndevpriv->ctrl = 0;\r\ndevpriv->mode1 = 0;\r\ndevpriv->mode2 = 0;\r\napci1032_reset(dev);\r\nbreak;\r\ncase COMEDI_DIGITAL_TRIG_ENABLE_EDGES:\r\nif (devpriv->ctrl != (APCI1032_CTRL_INT_ENA |\r\nAPCI1032_CTRL_INT_OR)) {\r\ndevpriv->ctrl = APCI1032_CTRL_INT_ENA |\r\nAPCI1032_CTRL_INT_OR;\r\ndevpriv->mode1 = 0;\r\ndevpriv->mode2 = 0;\r\n} else {\r\ndevpriv->mode1 &= oldmask;\r\ndevpriv->mode2 &= oldmask;\r\n}\r\ndevpriv->mode1 |= data[4] << shift;\r\ndevpriv->mode2 |= data[5] << shift;\r\nbreak;\r\ncase COMEDI_DIGITAL_TRIG_ENABLE_LEVELS:\r\nif (devpriv->ctrl != (APCI1032_CTRL_INT_ENA |\r\nAPCI1032_CTRL_INT_AND)) {\r\ndevpriv->ctrl = APCI1032_CTRL_INT_ENA |\r\nAPCI1032_CTRL_INT_AND;\r\ndevpriv->mode1 = 0;\r\ndevpriv->mode2 = 0;\r\n} else {\r\ndevpriv->mode1 &= oldmask;\r\ndevpriv->mode2 &= oldmask;\r\n}\r\ndevpriv->mode1 |= data[4] << shift;\r\ndevpriv->mode2 |= data[5] << shift;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int apci1032_cos_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\ndata[1] = s->state;\r\nreturn 0;\r\n}\r\nstatic int apci1032_cos_cmdtest(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_cmd *cmd)\r\n{\r\nint err = 0;\r\nerr |= cfc_check_trigger_src(&cmd->start_src, TRIG_NOW);\r\nerr |= cfc_check_trigger_src(&cmd->scan_begin_src, TRIG_EXT);\r\nerr |= cfc_check_trigger_src(&cmd->convert_src, TRIG_FOLLOW);\r\nerr |= cfc_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);\r\nerr |= cfc_check_trigger_src(&cmd->stop_src, TRIG_NONE);\r\nif (err)\r\nreturn 1;\r\nif (err)\r\nreturn 2;\r\nerr |= cfc_check_trigger_arg_is(&cmd->start_arg, 0);\r\nerr |= cfc_check_trigger_arg_is(&cmd->scan_begin_arg, 0);\r\nerr |= cfc_check_trigger_arg_is(&cmd->convert_arg, 0);\r\nerr |= cfc_check_trigger_arg_is(&cmd->scan_end_arg, 1);\r\nerr |= cfc_check_trigger_arg_is(&cmd->stop_arg, 0);\r\nif (err)\r\nreturn 3;\r\nif (err)\r\nreturn 4;\r\nreturn 0;\r\n}\r\nstatic int apci1032_cos_cmd(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct apci1032_private *devpriv = dev->private;\r\nif (!devpriv->ctrl) {\r\ndev_warn(dev->class_dev,\r\n"Interrupts disabled due to mode configuration!\n");\r\nreturn -EINVAL;\r\n}\r\noutl(devpriv->mode1, dev->iobase + APCI1032_MODE1_REG);\r\noutl(devpriv->mode2, dev->iobase + APCI1032_MODE2_REG);\r\noutl(devpriv->ctrl, dev->iobase + APCI1032_CTRL_REG);\r\nreturn 0;\r\n}\r\nstatic int apci1032_cos_cancel(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nreturn apci1032_reset(dev);\r\n}\r\nstatic irqreturn_t apci1032_interrupt(int irq, void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nstruct apci1032_private *devpriv = dev->private;\r\nstruct comedi_subdevice *s = dev->read_subdev;\r\nunsigned int ctrl;\r\nif ((inl(devpriv->amcc_iobase + AMCC_OP_REG_INTCSR) &\r\nINTCSR_INTR_ASSERTED) == 0)\r\nreturn IRQ_NONE;\r\nctrl = inl(dev->iobase + APCI1032_CTRL_REG);\r\nif ((ctrl & APCI1032_CTRL_INT_ENA) == 0)\r\nreturn IRQ_HANDLED;\r\noutl(ctrl & ~APCI1032_CTRL_INT_ENA, dev->iobase + APCI1032_CTRL_REG);\r\ns->state = inl(dev->iobase + APCI1032_STATUS_REG) & 0xffff;\r\ncomedi_buf_put(s->async, s->state);\r\ns->async->events |= COMEDI_CB_BLOCK | COMEDI_CB_EOS;\r\ncomedi_event(dev, s);\r\noutl(ctrl, dev->iobase + APCI1032_CTRL_REG);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int apci1032_di_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\ndata[1] = inl(dev->iobase + APCI1032_DI_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci1032_auto_attach(struct comedi_device *dev,\r\nunsigned long context_unused)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nstruct apci1032_private *devpriv;\r\nstruct comedi_subdevice *s;\r\nint ret;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\ndevpriv->amcc_iobase = pci_resource_start(pcidev, 0);\r\ndev->iobase = pci_resource_start(pcidev, 1);\r\napci1032_reset(dev);\r\nif (pcidev->irq > 0) {\r\nret = request_irq(pcidev->irq, apci1032_interrupt, IRQF_SHARED,\r\ndev->board_name, dev);\r\nif (ret == 0)\r\ndev->irq = pcidev->irq;\r\n}\r\nret = comedi_alloc_subdevices(dev, 2);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan = 32;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = apci1032_di_insn_bits;\r\ns = &dev->subdevices[1];\r\nif (dev->irq) {\r\ndev->read_subdev = s;\r\ns->type = COMEDI_SUBD_DI | SDF_CMD_READ;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan = 1;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_config = apci1032_cos_insn_config;\r\ns->insn_bits = apci1032_cos_insn_bits;\r\ns->do_cmdtest = apci1032_cos_cmdtest;\r\ns->do_cmd = apci1032_cos_cmd;\r\ns->cancel = apci1032_cos_cancel;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\nreturn 0;\r\n}\r\nstatic void apci1032_detach(struct comedi_device *dev)\r\n{\r\nif (dev->iobase)\r\napci1032_reset(dev);\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\ncomedi_pci_disable(dev);\r\n}\r\nstatic int apci1032_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &apci1032_driver, id->driver_data);\r\n}

static u32 at91x40_gettimeoffset(void)\r\n{\r\nreturn (at91_tc_read(AT91_TC_CLK1BASE + AT91_TC_CV) * 1000000 /\r\n(AT91X40_MASTER_CLOCK / 128)) * 1000;\r\n}\r\nstatic irqreturn_t at91x40_timer_interrupt(int irq, void *dev_id)\r\n{\r\nat91_tc_read(AT91_TC_CLK1BASE + AT91_TC_SR);\r\ntimer_tick();\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid __init at91x40_timer_init(void)\r\n{\r\nunsigned int v;\r\narch_gettimeoffset = at91x40_gettimeoffset;\r\nat91_tc_write(AT91_TC_BCR, 0);\r\nv = at91_tc_read(AT91_TC_BMR);\r\nv = (v & ~AT91_TC_TC1XC1S) | AT91_TC_TC1XC1S_NONE;\r\nat91_tc_write(AT91_TC_BMR, v);\r\nat91_tc_write(AT91_TC_CLK1BASE + AT91_TC_CCR, AT91_TC_CLKDIS);\r\nat91_tc_write(AT91_TC_CLK1BASE + AT91_TC_CMR, (AT91_TC_TIMER_CLOCK4 | AT91_TC_CPCTRG));\r\nat91_tc_write(AT91_TC_CLK1BASE + AT91_TC_IDR, 0xffffffff);\r\nat91_tc_write(AT91_TC_CLK1BASE + AT91_TC_RC, (AT91X40_MASTER_CLOCK / 128) / HZ - 1);\r\nat91_tc_write(AT91_TC_CLK1BASE + AT91_TC_IER, (1<<4));\r\nsetup_irq(AT91X40_ID_TC1, &at91x40_timer_irq);\r\nat91_tc_write(AT91_TC_CLK1BASE + AT91_TC_CCR, (AT91_TC_SWTRG | AT91_TC_CLKEN));\r\n}

int\r\nxencomm_hypercall_console_io(int cmd, int count, char *str)\r\n{\r\nif (!xencomm_is_initialized())\r\nreturn 0;\r\nreturn xencomm_arch_hypercall_console_io\r\n(cmd, count, xencomm_map_no_alloc(str, count));\r\n}\r\nint\r\nxencomm_hypercall_event_channel_op(int cmd, void *op)\r\n{\r\nstruct xencomm_handle *desc;\r\ndesc = xencomm_map_no_alloc(op, sizeof(struct evtchn_op));\r\nif (desc == NULL)\r\nreturn -EINVAL;\r\nreturn xencomm_arch_hypercall_event_channel_op(cmd, desc);\r\n}\r\nint\r\nxencomm_hypercall_xen_version(int cmd, void *arg)\r\n{\r\nstruct xencomm_handle *desc;\r\nunsigned int argsize;\r\nswitch (cmd) {\r\ncase XENVER_version:\r\nreturn xencomm_arch_hypercall_xen_version(cmd, 0);\r\ncase XENVER_extraversion:\r\nargsize = sizeof(struct xen_extraversion);\r\nbreak;\r\ncase XENVER_compile_info:\r\nargsize = sizeof(struct xen_compile_info);\r\nbreak;\r\ncase XENVER_capabilities:\r\nargsize = sizeof(struct xen_capabilities_info);\r\nbreak;\r\ncase XENVER_changeset:\r\nargsize = sizeof(struct xen_changeset_info);\r\nbreak;\r\ncase XENVER_platform_parameters:\r\nargsize = sizeof(struct xen_platform_parameters);\r\nbreak;\r\ncase XENVER_get_features:\r\nargsize = (arg == NULL) ? 0 : sizeof(struct xen_feature_info);\r\nbreak;\r\ndefault:\r\nprintk(KERN_DEBUG\r\n"%s: unknown version op %d\n", __func__, cmd);\r\nreturn -ENOSYS;\r\n}\r\ndesc = xencomm_map_no_alloc(arg, argsize);\r\nif (desc == NULL)\r\nreturn -EINVAL;\r\nreturn xencomm_arch_hypercall_xen_version(cmd, desc);\r\n}\r\nint\r\nxencomm_hypercall_physdev_op(int cmd, void *op)\r\n{\r\nunsigned int argsize;\r\nswitch (cmd) {\r\ncase PHYSDEVOP_apic_read:\r\ncase PHYSDEVOP_apic_write:\r\nargsize = sizeof(struct physdev_apic);\r\nbreak;\r\ncase PHYSDEVOP_alloc_irq_vector:\r\ncase PHYSDEVOP_free_irq_vector:\r\nargsize = sizeof(struct physdev_irq);\r\nbreak;\r\ncase PHYSDEVOP_irq_status_query:\r\nargsize = sizeof(struct physdev_irq_status_query);\r\nbreak;\r\ndefault:\r\nprintk(KERN_DEBUG\r\n"%s: unknown physdev op %d\n", __func__, cmd);\r\nreturn -ENOSYS;\r\n}\r\nreturn xencomm_arch_hypercall_physdev_op\r\n(cmd, xencomm_map_no_alloc(op, argsize));\r\n}\r\nstatic int\r\nxencommize_grant_table_op(struct xencomm_mini **xc_area,\r\nunsigned int cmd, void *op, unsigned int count,\r\nstruct xencomm_handle **desc)\r\n{\r\nstruct xencomm_handle *desc1;\r\nunsigned int argsize;\r\nswitch (cmd) {\r\ncase GNTTABOP_map_grant_ref:\r\nargsize = sizeof(struct gnttab_map_grant_ref);\r\nbreak;\r\ncase GNTTABOP_unmap_grant_ref:\r\nargsize = sizeof(struct gnttab_unmap_grant_ref);\r\nbreak;\r\ncase GNTTABOP_setup_table:\r\n{\r\nstruct gnttab_setup_table *setup = op;\r\nargsize = sizeof(*setup);\r\nif (count != 1)\r\nreturn -EINVAL;\r\ndesc1 = __xencomm_map_no_alloc\r\n(xen_guest_handle(setup->frame_list),\r\nsetup->nr_frames *\r\nsizeof(*xen_guest_handle(setup->frame_list)),\r\n*xc_area);\r\nif (desc1 == NULL)\r\nreturn -EINVAL;\r\n(*xc_area)++;\r\nset_xen_guest_handle(setup->frame_list, (void *)desc1);\r\nbreak;\r\n}\r\ncase GNTTABOP_dump_table:\r\nargsize = sizeof(struct gnttab_dump_table);\r\nbreak;\r\ncase GNTTABOP_transfer:\r\nargsize = sizeof(struct gnttab_transfer);\r\nbreak;\r\ncase GNTTABOP_copy:\r\nargsize = sizeof(struct gnttab_copy);\r\nbreak;\r\ncase GNTTABOP_query_size:\r\nargsize = sizeof(struct gnttab_query_size);\r\nbreak;\r\ndefault:\r\nprintk(KERN_DEBUG "%s: unknown hypercall grant table op %d\n",\r\n__func__, cmd);\r\nBUG();\r\n}\r\n*desc = __xencomm_map_no_alloc(op, count * argsize, *xc_area);\r\nif (*desc == NULL)\r\nreturn -EINVAL;\r\n(*xc_area)++;\r\nreturn 0;\r\n}\r\nint\r\nxencomm_hypercall_grant_table_op(unsigned int cmd, void *op,\r\nunsigned int count)\r\n{\r\nint rc;\r\nstruct xencomm_handle *desc;\r\nXENCOMM_MINI_ALIGNED(xc_area, 2);\r\nrc = xencommize_grant_table_op(&xc_area, cmd, op, count, &desc);\r\nif (rc)\r\nreturn rc;\r\nreturn xencomm_arch_hypercall_grant_table_op(cmd, desc, count);\r\n}\r\nint\r\nxencomm_hypercall_sched_op(int cmd, void *arg)\r\n{\r\nstruct xencomm_handle *desc;\r\nunsigned int argsize;\r\nswitch (cmd) {\r\ncase SCHEDOP_yield:\r\ncase SCHEDOP_block:\r\nargsize = 0;\r\nbreak;\r\ncase SCHEDOP_shutdown:\r\nargsize = sizeof(struct sched_shutdown);\r\nbreak;\r\ncase SCHEDOP_poll:\r\n{\r\nstruct sched_poll *poll = arg;\r\nstruct xencomm_handle *ports;\r\nargsize = sizeof(struct sched_poll);\r\nports = xencomm_map_no_alloc(xen_guest_handle(poll->ports),\r\nsizeof(*xen_guest_handle(poll->ports)));\r\nset_xen_guest_handle(poll->ports, (void *)ports);\r\nbreak;\r\n}\r\ndefault:\r\nprintk(KERN_DEBUG "%s: unknown sched op %d\n", __func__, cmd);\r\nreturn -ENOSYS;\r\n}\r\ndesc = xencomm_map_no_alloc(arg, argsize);\r\nif (desc == NULL)\r\nreturn -EINVAL;\r\nreturn xencomm_arch_hypercall_sched_op(cmd, desc);\r\n}\r\nint\r\nxencomm_hypercall_multicall(void *call_list, int nr_calls)\r\n{\r\nint rc;\r\nint i;\r\nstruct multicall_entry *mce;\r\nstruct xencomm_handle *desc;\r\nXENCOMM_MINI_ALIGNED(xc_area, nr_calls * 2);\r\nfor (i = 0; i < nr_calls; i++) {\r\nmce = (struct multicall_entry *)call_list + i;\r\nswitch (mce->op) {\r\ncase __HYPERVISOR_update_va_mapping:\r\ncase __HYPERVISOR_mmu_update:\r\nbreak;\r\ncase __HYPERVISOR_grant_table_op:\r\nrc = xencommize_grant_table_op\r\n(&xc_area,\r\nmce->args[0], (void *)mce->args[1],\r\nmce->args[2], &desc);\r\nif (rc)\r\nreturn rc;\r\nmce->args[1] = (unsigned long)desc;\r\nbreak;\r\ncase __HYPERVISOR_memory_op:\r\ndefault:\r\nprintk(KERN_DEBUG\r\n"%s: unhandled multicall op entry op %lu\n",\r\n__func__, mce->op);\r\nreturn -ENOSYS;\r\n}\r\n}\r\ndesc = xencomm_map_no_alloc(call_list,\r\nnr_calls * sizeof(struct multicall_entry));\r\nif (desc == NULL)\r\nreturn -EINVAL;\r\nreturn xencomm_arch_hypercall_multicall(desc, nr_calls);\r\n}\r\nint\r\nxencomm_hypercall_callback_op(int cmd, void *arg)\r\n{\r\nunsigned int argsize;\r\nswitch (cmd) {\r\ncase CALLBACKOP_register:\r\nargsize = sizeof(struct callback_register);\r\nbreak;\r\ncase CALLBACKOP_unregister:\r\nargsize = sizeof(struct callback_unregister);\r\nbreak;\r\ndefault:\r\nprintk(KERN_DEBUG\r\n"%s: unknown callback op %d\n", __func__, cmd);\r\nreturn -ENOSYS;\r\n}\r\nreturn xencomm_arch_hypercall_callback_op\r\n(cmd, xencomm_map_no_alloc(arg, argsize));\r\n}\r\nstatic int\r\nxencommize_memory_reservation(struct xencomm_mini *xc_area,\r\nstruct xen_memory_reservation *mop)\r\n{\r\nstruct xencomm_handle *desc;\r\ndesc = __xencomm_map_no_alloc(xen_guest_handle(mop->extent_start),\r\nmop->nr_extents *\r\nsizeof(*xen_guest_handle(mop->extent_start)),\r\nxc_area);\r\nif (desc == NULL)\r\nreturn -EINVAL;\r\nset_xen_guest_handle(mop->extent_start, (void *)desc);\r\nreturn 0;\r\n}\r\nint\r\nxencomm_hypercall_memory_op(unsigned int cmd, void *arg)\r\n{\r\nGUEST_HANDLE(xen_pfn_t) extent_start_va[2] = { {NULL}, {NULL} };\r\nstruct xen_memory_reservation *xmr = NULL;\r\nint rc;\r\nstruct xencomm_handle *desc;\r\nunsigned int argsize;\r\nXENCOMM_MINI_ALIGNED(xc_area, 2);\r\nswitch (cmd) {\r\ncase XENMEM_increase_reservation:\r\ncase XENMEM_decrease_reservation:\r\ncase XENMEM_populate_physmap:\r\nxmr = (struct xen_memory_reservation *)arg;\r\nset_xen_guest_handle(extent_start_va[0],\r\nxen_guest_handle(xmr->extent_start));\r\nargsize = sizeof(*xmr);\r\nrc = xencommize_memory_reservation(xc_area, xmr);\r\nif (rc)\r\nreturn rc;\r\nxc_area++;\r\nbreak;\r\ncase XENMEM_maximum_ram_page:\r\nargsize = 0;\r\nbreak;\r\ncase XENMEM_add_to_physmap:\r\nargsize = sizeof(struct xen_add_to_physmap);\r\nbreak;\r\ndefault:\r\nprintk(KERN_DEBUG "%s: unknown memory op %d\n", __func__, cmd);\r\nreturn -ENOSYS;\r\n}\r\ndesc = xencomm_map_no_alloc(arg, argsize);\r\nif (desc == NULL)\r\nreturn -EINVAL;\r\nrc = xencomm_arch_hypercall_memory_op(cmd, desc);\r\nswitch (cmd) {\r\ncase XENMEM_increase_reservation:\r\ncase XENMEM_decrease_reservation:\r\ncase XENMEM_populate_physmap:\r\nset_xen_guest_handle(xmr->extent_start,\r\nxen_guest_handle(extent_start_va[0]));\r\nbreak;\r\n}\r\nreturn rc;\r\n}\r\nint\r\nxencomm_hypercall_suspend(unsigned long srec)\r\n{\r\nstruct sched_shutdown arg;\r\narg.reason = SHUTDOWN_suspend;\r\nreturn xencomm_arch_hypercall_sched_op(\r\nSCHEDOP_shutdown, xencomm_map_no_alloc(&arg, sizeof(arg)));\r\n}\r\nlong\r\nxencomm_hypercall_vcpu_op(int cmd, int cpu, void *arg)\r\n{\r\nunsigned int argsize;\r\nswitch (cmd) {\r\ncase VCPUOP_register_runstate_memory_area: {\r\nstruct vcpu_register_runstate_memory_area *area =\r\n(struct vcpu_register_runstate_memory_area *)arg;\r\nargsize = sizeof(*arg);\r\nset_xen_guest_handle(area->addr.h,\r\n(void *)xencomm_map_no_alloc(area->addr.v,\r\nsizeof(area->addr.v)));\r\nbreak;\r\n}\r\ndefault:\r\nprintk(KERN_DEBUG "%s: unknown vcpu op %d\n", __func__, cmd);\r\nreturn -ENOSYS;\r\n}\r\nreturn xencomm_arch_hypercall_vcpu_op(cmd, cpu,\r\nxencomm_map_no_alloc(arg, argsize));\r\n}\r\nlong\r\nxencomm_hypercall_opt_feature(void *arg)\r\n{\r\nreturn xencomm_arch_hypercall_opt_feature(\r\nxencomm_map_no_alloc(arg,\r\nsizeof(struct xen_ia64_opt_feature)));\r\n}

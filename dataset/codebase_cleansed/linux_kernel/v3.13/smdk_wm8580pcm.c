static int smdk_wm8580_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nint rfs, ret;\r\nswitch (params_rate(params)) {\r\ncase 8000:\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s:%d Sampling Rate %u not supported!\n",\r\n__func__, __LINE__, params_rate(params));\r\nreturn -EINVAL;\r\n}\r\nrfs = mclk_freq / params_rate(params) / 2;\r\nret = snd_soc_dai_set_fmt(codec_dai, SND_SOC_DAIFMT_DSP_B\r\n| SND_SOC_DAIFMT_IB_NF\r\n| SND_SOC_DAIFMT_CBS_CFS);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_fmt(cpu_dai, SND_SOC_DAIFMT_DSP_B\r\n| SND_SOC_DAIFMT_IB_NF\r\n| SND_SOC_DAIFMT_CBS_CFS);\r\nif (ret < 0)\r\nreturn ret;\r\nif (mclk_freq == xtal_freq) {\r\nret = snd_soc_dai_set_sysclk(codec_dai, WM8580_CLKSRC_MCLK,\r\nmclk_freq, SND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_clkdiv(codec_dai, WM8580_MCLK,\r\nWM8580_CLKSRC_MCLK);\r\nif (ret < 0)\r\nreturn ret;\r\n} else {\r\nret = snd_soc_dai_set_sysclk(codec_dai, WM8580_CLKSRC_PLLA,\r\nmclk_freq, SND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_clkdiv(codec_dai, WM8580_MCLK,\r\nWM8580_CLKSRC_PLLA);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_pll(codec_dai, WM8580_PLLA, 0,\r\nxtal_freq, mclk_freq);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_sysclk(cpu_dai, S3C_PCM_CLKSRC_MUX,\r\nmclk_freq, SND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_clkdiv(cpu_dai, S3C_PCM_SCLK_PER_FS, rfs);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int snd_smdk_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0;\r\nxtal_freq = SMDK_WM8580_EXT_OSC;\r\nmclk_freq = SMDK_WM8580_EXT_MCLK;\r\nif (machine_is_smdkc110() || machine_is_smdkv210())\r\nxtal_freq = mclk_freq = SMDK_WM8580_EXT_VOICE;\r\nsmdk_pcm.dev = &pdev->dev;\r\nret = snd_soc_register_card(&smdk_pcm);\r\nif (ret) {\r\ndev_err(&pdev->dev, "snd_soc_register_card failed %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_smdk_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_card(&smdk_pcm);\r\nreturn 0;\r\n}

int InitialiseRamdac(volatile STG4000REG __iomem * pSTGReg,\r\nu32 displayDepth,\r\nu32 displayWidth,\r\nu32 displayHeight,\r\ns32 HSyncPolarity,\r\ns32 VSyncPolarity, u32 * pixelClock)\r\n{\r\nu32 tmp = 0;\r\nu32 F = 0, R = 0, P = 0;\r\nu32 stride = 0;\r\nu32 ulPdiv = 0;\r\nu32 physicalPixelDepth = 0;\r\ntmp = STG_READ_REG(SoftwareReset);\r\nif (tmp & 0x1) {\r\nCLEAR_BIT(1);\r\nSTG_WRITE_REG(SoftwareReset, tmp);\r\n}\r\ntmp = STG_READ_REG(DACPixelFormat);\r\nCLEAR_BITS_FRM_TO(0, 2);\r\nCLEAR_BITS_FRM_TO(8, 9);\r\nswitch (displayDepth) {\r\ncase 16:\r\n{\r\nphysicalPixelDepth = 16;\r\ntmp |= _16BPP;\r\nbreak;\r\n}\r\ncase 32:\r\n{\r\nphysicalPixelDepth = 32;\r\ntmp |= _32BPP;\r\nbreak;\r\n}\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nSTG_WRITE_REG(DACPixelFormat, tmp);\r\nulPdiv = STG_PIXEL_BUS_WIDTH / physicalPixelDepth;\r\nstride = displayWidth;\r\ntmp = STG_READ_REG(DACPrimSize);\r\nCLEAR_BITS_FRM_TO(0, 10);\r\nCLEAR_BITS_FRM_TO(12, 31);\r\ntmp |=\r\n((((displayHeight - 1) << 12) | (((displayWidth / ulPdiv) -\r\n1) << 23))\r\n| (stride / ulPdiv));\r\nSTG_WRITE_REG(DACPrimSize, tmp);\r\n*pixelClock = ProgramClock(REF_CLOCK, *pixelClock, &F, &R, &P);\r\ntmp = STG_READ_REG(DACPLLMode);\r\nCLEAR_BITS_FRM_TO(0, 15);\r\ntmp |= ((P) | ((F - 2) << 2) | ((R - 2) << 11));\r\nSTG_WRITE_REG(DACPLLMode, tmp);\r\ntmp = STG_READ_REG(DACPrimAddress);\r\nCLEAR_BITS_FRM_TO(0, 20);\r\nCLEAR_BITS_FRM_TO(20, 31);\r\nSTG_WRITE_REG(DACPrimAddress, tmp);\r\ntmp = STG_READ_REG(DACCursorCtrl);\r\ntmp &= ~SET_BIT(31);\r\nSTG_WRITE_REG(DACCursorCtrl, tmp);\r\ntmp = STG_READ_REG(DACCursorAddr);\r\nCLEAR_BITS_FRM_TO(0, 20);\r\nSTG_WRITE_REG(DACCursorAddr, tmp);\r\ntmp = STG_READ_REG(DACVidWinStart);\r\nCLEAR_BITS_FRM_TO(0, 10);\r\nCLEAR_BITS_FRM_TO(16, 26);\r\nSTG_WRITE_REG(DACVidWinStart, tmp);\r\ntmp = STG_READ_REG(DACVidWinEnd);\r\nCLEAR_BITS_FRM_TO(0, 10);\r\nCLEAR_BITS_FRM_TO(16, 26);\r\nSTG_WRITE_REG(DACVidWinEnd, tmp);\r\ntmp = STG_READ_REG(DACBorderColor);\r\nCLEAR_BITS_FRM_TO(0, 23);\r\nSTG_WRITE_REG(DACBorderColor, tmp);\r\nSTG_WRITE_REG(DACBurstCtrl, 0x0404);\r\ntmp = STG_READ_REG(DACCrcTrigger);\r\nCLEAR_BIT(0);\r\nSTG_WRITE_REG(DACCrcTrigger, tmp);\r\ntmp = STG_READ_REG(DigVidPortCtrl);\r\nCLEAR_BIT(8);\r\nCLEAR_BITS_FRM_TO(16, 27);\r\nCLEAR_BITS_FRM_TO(1, 3);\r\nCLEAR_BITS_FRM_TO(10, 11);\r\nSTG_WRITE_REG(DigVidPortCtrl, tmp);\r\nreturn 0;\r\n}\r\nvoid DisableRamdacOutput(volatile STG4000REG __iomem * pSTGReg)\r\n{\r\nu32 tmp;\r\ntmp = (STG_READ_REG(DACStreamCtrl)) & ~SET_BIT(0);\r\nSTG_WRITE_REG(DACStreamCtrl, tmp);\r\n}\r\nvoid EnableRamdacOutput(volatile STG4000REG __iomem * pSTGReg)\r\n{\r\nu32 tmp;\r\ntmp = (STG_READ_REG(DACStreamCtrl)) | SET_BIT(0);\r\nSTG_WRITE_REG(DACStreamCtrl, tmp);\r\n}

void fimc_is_fw_clear_irq1(struct fimc_is *is, unsigned int nr)\r\n{\r\nmcuctl_write(1UL << nr, is, MCUCTL_REG_INTCR1);\r\n}\r\nvoid fimc_is_fw_clear_irq2(struct fimc_is *is)\r\n{\r\nu32 cfg = mcuctl_read(is, MCUCTL_REG_INTSR2);\r\nmcuctl_write(cfg, is, MCUCTL_REG_INTCR2);\r\n}\r\nvoid fimc_is_hw_set_intgr0_gd0(struct fimc_is *is)\r\n{\r\nmcuctl_write(INTGR0_INTGD(0), is, MCUCTL_REG_INTGR0);\r\n}\r\nint fimc_is_hw_wait_intsr0_intsd0(struct fimc_is *is)\r\n{\r\nunsigned int timeout = 2000;\r\nu32 cfg, status;\r\ncfg = mcuctl_read(is, MCUCTL_REG_INTSR0);\r\nstatus = INTSR0_GET_INTSD(0, cfg);\r\nwhile (status) {\r\ncfg = mcuctl_read(is, MCUCTL_REG_INTSR0);\r\nstatus = INTSR0_GET_INTSD(0, cfg);\r\nif (timeout == 0) {\r\ndev_warn(&is->pdev->dev, "%s timeout\n",\r\n__func__);\r\nreturn -ETIME;\r\n}\r\ntimeout--;\r\nudelay(1);\r\n}\r\nreturn 0;\r\n}\r\nint fimc_is_hw_wait_intmsr0_intmsd0(struct fimc_is *is)\r\n{\r\nunsigned int timeout = 2000;\r\nu32 cfg, status;\r\ncfg = mcuctl_read(is, MCUCTL_REG_INTMSR0);\r\nstatus = INTMSR0_GET_INTMSD(0, cfg);\r\nwhile (status) {\r\ncfg = mcuctl_read(is, MCUCTL_REG_INTMSR0);\r\nstatus = INTMSR0_GET_INTMSD(0, cfg);\r\nif (timeout == 0) {\r\ndev_warn(&is->pdev->dev, "%s timeout\n",\r\n__func__);\r\nreturn -ETIME;\r\n}\r\ntimeout--;\r\nudelay(1);\r\n}\r\nreturn 0;\r\n}\r\nint fimc_is_hw_set_param(struct fimc_is *is)\r\n{\r\nstruct chain_config *config = &is->config[is->config_index];\r\nunsigned int param_count = __get_pending_param_count(is);\r\nfimc_is_hw_wait_intmsr0_intmsd0(is);\r\nmcuctl_write(HIC_SET_PARAMETER, is, MCUCTL_REG_ISSR(0));\r\nmcuctl_write(is->sensor_index, is, MCUCTL_REG_ISSR(1));\r\nmcuctl_write(is->config_index, is, MCUCTL_REG_ISSR(2));\r\nmcuctl_write(param_count, is, MCUCTL_REG_ISSR(3));\r\nmcuctl_write(config->p_region_index[0], is, MCUCTL_REG_ISSR(4));\r\nmcuctl_write(config->p_region_index[1], is, MCUCTL_REG_ISSR(5));\r\nfimc_is_hw_set_intgr0_gd0(is);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused fimc_is_hw_set_tune(struct fimc_is *is)\r\n{\r\nfimc_is_hw_wait_intmsr0_intmsd0(is);\r\nmcuctl_write(HIC_SET_TUNE, is, MCUCTL_REG_ISSR(0));\r\nmcuctl_write(is->sensor_index, is, MCUCTL_REG_ISSR(1));\r\nmcuctl_write(is->h2i_cmd.entry_id, is, MCUCTL_REG_ISSR(2));\r\nfimc_is_hw_set_intgr0_gd0(is);\r\nreturn 0;\r\n}\r\nint fimc_is_hw_get_params(struct fimc_is *is, unsigned int num_args)\r\n{\r\nint i;\r\nif (num_args > FIMC_IS_MAX_PARAMS)\r\nreturn -EINVAL;\r\nis->i2h_cmd.num_args = num_args;\r\nfor (i = 0; i < FIMC_IS_MAX_PARAMS; i++) {\r\nif (i < num_args)\r\nis->i2h_cmd.args[i] = mcuctl_read(is,\r\nMCUCTL_REG_ISSR(12 + i));\r\nelse\r\nis->i2h_cmd.args[i] = 0;\r\n}\r\nreturn 0;\r\n}\r\nvoid fimc_is_hw_set_sensor_num(struct fimc_is *is)\r\n{\r\npr_debug("setting sensor index to: %d\n", is->sensor_index);\r\nmcuctl_write(IH_REPLY_DONE, is, MCUCTL_REG_ISSR(0));\r\nmcuctl_write(is->sensor_index, is, MCUCTL_REG_ISSR(1));\r\nmcuctl_write(IHC_GET_SENSOR_NUM, is, MCUCTL_REG_ISSR(2));\r\nmcuctl_write(FIMC_IS_SENSOR_NUM, is, MCUCTL_REG_ISSR(3));\r\n}\r\nvoid fimc_is_hw_close_sensor(struct fimc_is *is, unsigned int index)\r\n{\r\nif (is->sensor_index != index)\r\nreturn;\r\nfimc_is_hw_wait_intmsr0_intmsd0(is);\r\nmcuctl_write(HIC_CLOSE_SENSOR, is, MCUCTL_REG_ISSR(0));\r\nmcuctl_write(is->sensor_index, is, MCUCTL_REG_ISSR(1));\r\nmcuctl_write(is->sensor_index, is, MCUCTL_REG_ISSR(2));\r\nfimc_is_hw_set_intgr0_gd0(is);\r\n}\r\nvoid fimc_is_hw_get_setfile_addr(struct fimc_is *is)\r\n{\r\nfimc_is_hw_wait_intmsr0_intmsd0(is);\r\nmcuctl_write(HIC_GET_SET_FILE_ADDR, is, MCUCTL_REG_ISSR(0));\r\nmcuctl_write(is->sensor_index, is, MCUCTL_REG_ISSR(1));\r\nfimc_is_hw_set_intgr0_gd0(is);\r\n}\r\nvoid fimc_is_hw_load_setfile(struct fimc_is *is)\r\n{\r\nfimc_is_hw_wait_intmsr0_intmsd0(is);\r\nmcuctl_write(HIC_LOAD_SET_FILE, is, MCUCTL_REG_ISSR(0));\r\nmcuctl_write(is->sensor_index, is, MCUCTL_REG_ISSR(1));\r\nfimc_is_hw_set_intgr0_gd0(is);\r\n}\r\nint fimc_is_hw_change_mode(struct fimc_is *is)\r\n{\r\nconst u8 cmd[] = {\r\nHIC_PREVIEW_STILL, HIC_PREVIEW_VIDEO,\r\nHIC_CAPTURE_STILL, HIC_CAPTURE_VIDEO,\r\n};\r\nif (WARN_ON(is->config_index >= ARRAY_SIZE(cmd)))\r\nreturn -EINVAL;\r\nmcuctl_write(cmd[is->config_index], is, MCUCTL_REG_ISSR(0));\r\nmcuctl_write(is->sensor_index, is, MCUCTL_REG_ISSR(1));\r\nmcuctl_write(is->setfile.sub_index, is, MCUCTL_REG_ISSR(2));\r\nfimc_is_hw_set_intgr0_gd0(is);\r\nreturn 0;\r\n}\r\nvoid fimc_is_hw_stream_on(struct fimc_is *is)\r\n{\r\nfimc_is_hw_wait_intmsr0_intmsd0(is);\r\nmcuctl_write(HIC_STREAM_ON, is, MCUCTL_REG_ISSR(0));\r\nmcuctl_write(is->sensor_index, is, MCUCTL_REG_ISSR(1));\r\nmcuctl_write(0, is, MCUCTL_REG_ISSR(2));\r\nfimc_is_hw_set_intgr0_gd0(is);\r\n}\r\nvoid fimc_is_hw_stream_off(struct fimc_is *is)\r\n{\r\nfimc_is_hw_wait_intmsr0_intmsd0(is);\r\nmcuctl_write(HIC_STREAM_OFF, is, MCUCTL_REG_ISSR(0));\r\nmcuctl_write(is->sensor_index, is, MCUCTL_REG_ISSR(1));\r\nfimc_is_hw_set_intgr0_gd0(is);\r\n}\r\nvoid fimc_is_hw_subip_power_off(struct fimc_is *is)\r\n{\r\nfimc_is_hw_wait_intmsr0_intmsd0(is);\r\nmcuctl_write(HIC_POWER_DOWN, is, MCUCTL_REG_ISSR(0));\r\nmcuctl_write(is->sensor_index, is, MCUCTL_REG_ISSR(1));\r\nfimc_is_hw_set_intgr0_gd0(is);\r\n}\r\nint fimc_is_itf_s_param(struct fimc_is *is, bool update)\r\n{\r\nint ret;\r\nif (update)\r\n__is_hw_update_params(is);\r\nfimc_is_mem_barrier();\r\nclear_bit(IS_ST_BLOCK_CMD_CLEARED, &is->state);\r\nfimc_is_hw_set_param(is);\r\nret = fimc_is_wait_event(is, IS_ST_BLOCK_CMD_CLEARED, 1,\r\nFIMC_IS_CONFIG_TIMEOUT);\r\nif (ret < 0)\r\ndev_err(&is->pdev->dev, "%s() timeout\n", __func__);\r\nreturn ret;\r\n}\r\nint fimc_is_itf_mode_change(struct fimc_is *is)\r\n{\r\nint ret;\r\nclear_bit(IS_ST_CHANGE_MODE, &is->state);\r\nfimc_is_hw_change_mode(is);\r\nret = fimc_is_wait_event(is, IS_ST_CHANGE_MODE, 1,\r\nFIMC_IS_CONFIG_TIMEOUT);\r\nif (ret < 0)\r\ndev_err(&is->pdev->dev, "%s(): mode change (%d) timeout\n",\r\n__func__, is->config_index);\r\nreturn ret;\r\n}

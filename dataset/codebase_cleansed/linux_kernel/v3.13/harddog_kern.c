static int harddog_open(struct inode *inode, struct file *file)\r\n{\r\nint err = -EBUSY;\r\nchar *sock = NULL;\r\nmutex_lock(&harddog_mutex);\r\nspin_lock(&lock);\r\nif(timer_alive)\r\ngoto err;\r\n#ifdef CONFIG_WATCHDOG_NOWAYOUT\r\n__module_get(THIS_MODULE);\r\n#endif\r\n#ifdef CONFIG_MCONSOLE\r\nsock = mconsole_notify_socket();\r\n#endif\r\nerr = start_watchdog(&harddog_in_fd, &harddog_out_fd, sock);\r\nif(err)\r\ngoto err;\r\ntimer_alive = 1;\r\nspin_unlock(&lock);\r\nmutex_unlock(&harddog_mutex);\r\nreturn nonseekable_open(inode, file);\r\nerr:\r\nspin_unlock(&lock);\r\nmutex_unlock(&harddog_mutex);\r\nreturn err;\r\n}\r\nstatic int harddog_release(struct inode *inode, struct file *file)\r\n{\r\nspin_lock(&lock);\r\nstop_watchdog(harddog_in_fd, harddog_out_fd);\r\nharddog_in_fd = -1;\r\nharddog_out_fd = -1;\r\ntimer_alive=0;\r\nspin_unlock(&lock);\r\nreturn 0;\r\n}\r\nstatic ssize_t harddog_write(struct file *file, const char __user *data, size_t len,\r\nloff_t *ppos)\r\n{\r\nif(len)\r\nreturn ping_watchdog(harddog_out_fd);\r\nreturn 0;\r\n}\r\nstatic int harddog_ioctl_unlocked(struct file *file,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nvoid __user *argp= (void __user *)arg;\r\nstatic struct watchdog_info ident = {\r\nWDIOC_SETTIMEOUT,\r\n0,\r\n"UML Hardware Watchdog"\r\n};\r\nswitch (cmd) {\r\ndefault:\r\nreturn -ENOTTY;\r\ncase WDIOC_GETSUPPORT:\r\nif(copy_to_user(argp, &ident, sizeof(ident)))\r\nreturn -EFAULT;\r\nreturn 0;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0,(int __user *)argp);\r\ncase WDIOC_KEEPALIVE:\r\nreturn ping_watchdog(harddog_out_fd);\r\n}\r\n}\r\nstatic long harddog_ioctl(struct file *file,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nlong ret;\r\nmutex_lock(&harddog_mutex);\r\nret = harddog_ioctl_unlocked(file, cmd, arg);\r\nmutex_unlock(&harddog_mutex);\r\nreturn ret;\r\n}\r\nstatic int __init harddog_init(void)\r\n{\r\nint ret;\r\nret = misc_register(&harddog_miscdev);\r\nif (ret)\r\nreturn ret;\r\nprintk(banner);\r\nreturn 0;\r\n}\r\nstatic void __exit harddog_exit(void)\r\n{\r\nmisc_deregister(&harddog_miscdev);\r\n}

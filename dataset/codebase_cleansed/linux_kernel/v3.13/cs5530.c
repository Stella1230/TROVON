static int snd_cs5530_free(struct snd_cs5530 *chip)\r\n{\r\npci_release_regions(chip->pci);\r\npci_disable_device(chip->pci);\r\nkfree(chip);\r\nreturn 0;\r\n}\r\nstatic int snd_cs5530_dev_free(struct snd_device *device)\r\n{\r\nstruct snd_cs5530 *chip = device->device_data;\r\nreturn snd_cs5530_free(chip);\r\n}\r\nstatic void snd_cs5530_remove(struct pci_dev *pci)\r\n{\r\nsnd_card_free(pci_get_drvdata(pci));\r\n}\r\nstatic u8 snd_cs5530_mixer_read(unsigned long io, u8 reg)\r\n{\r\noutb(reg, io + 4);\r\nudelay(20);\r\nreg = inb(io + 5);\r\nudelay(20);\r\nreturn reg;\r\n}\r\nstatic int snd_cs5530_create(struct snd_card *card,\r\nstruct pci_dev *pci,\r\nstruct snd_cs5530 **rchip)\r\n{\r\nstruct snd_cs5530 *chip;\r\nunsigned long sb_base;\r\nu8 irq, dma8, dma16 = 0;\r\nu16 map;\r\nvoid __iomem *mem;\r\nint err;\r\nstatic struct snd_device_ops ops = {\r\n.dev_free = snd_cs5530_dev_free,\r\n};\r\n*rchip = NULL;\r\nerr = pci_enable_device(pci);\r\nif (err < 0)\r\nreturn err;\r\nchip = kzalloc(sizeof(*chip), GFP_KERNEL);\r\nif (chip == NULL) {\r\npci_disable_device(pci);\r\nreturn -ENOMEM;\r\n}\r\nchip->card = card;\r\nchip->pci = pci;\r\nerr = pci_request_regions(pci, "CS5530");\r\nif (err < 0) {\r\nkfree(chip);\r\npci_disable_device(pci);\r\nreturn err;\r\n}\r\nchip->pci_base = pci_resource_start(pci, 0);\r\nmem = pci_ioremap_bar(pci, 0);\r\nif (mem == NULL) {\r\nsnd_cs5530_free(chip);\r\nreturn -EBUSY;\r\n}\r\nmap = readw(mem + 0x18);\r\niounmap(mem);\r\nsb_base = 0x220 + 0x20 * (map & 3);\r\nif (map & (1<<2))\r\nprintk(KERN_INFO "CS5530: XpressAudio at 0x%lx\n", sb_base);\r\nelse {\r\nprintk(KERN_ERR "Could not find XpressAudio!\n");\r\nsnd_cs5530_free(chip);\r\nreturn -ENODEV;\r\n}\r\nif (map & (1<<5))\r\nprintk(KERN_INFO "CS5530: MPU at 0x300\n");\r\nelse if (map & (1<<6))\r\nprintk(KERN_INFO "CS5530: MPU at 0x330\n");\r\nirq = snd_cs5530_mixer_read(sb_base, 0x80) & 0x0F;\r\ndma8 = snd_cs5530_mixer_read(sb_base, 0x81);\r\nif (dma8 & 0x20)\r\ndma16 = 5;\r\nelse if (dma8 & 0x40)\r\ndma16 = 6;\r\nelse if (dma8 & 0x80)\r\ndma16 = 7;\r\nelse {\r\nprintk(KERN_ERR "CS5530: No 16bit DMA enabled\n");\r\nsnd_cs5530_free(chip);\r\nreturn -ENODEV;\r\n}\r\nif (dma8 & 0x01)\r\ndma8 = 0;\r\nelse if (dma8 & 02)\r\ndma8 = 1;\r\nelse if (dma8 & 0x08)\r\ndma8 = 3;\r\nelse {\r\nprintk(KERN_ERR "CS5530: No 8bit DMA enabled\n");\r\nsnd_cs5530_free(chip);\r\nreturn -ENODEV;\r\n}\r\nif (irq & 1)\r\nirq = 9;\r\nelse if (irq & 2)\r\nirq = 5;\r\nelse if (irq & 4)\r\nirq = 7;\r\nelse if (irq & 8)\r\nirq = 10;\r\nelse {\r\nprintk(KERN_ERR "CS5530: SoundBlaster IRQ not set\n");\r\nsnd_cs5530_free(chip);\r\nreturn -ENODEV;\r\n}\r\nprintk(KERN_INFO "CS5530: IRQ: %d DMA8: %d DMA16: %d\n", irq, dma8,\r\ndma16);\r\nerr = snd_sbdsp_create(card, sb_base, irq, snd_sb16dsp_interrupt, dma8,\r\ndma16, SB_HW_CS5530, &chip->sb);\r\nif (err < 0) {\r\nprintk(KERN_ERR "CS5530: Could not create SoundBlaster\n");\r\nsnd_cs5530_free(chip);\r\nreturn err;\r\n}\r\nerr = snd_sb16dsp_pcm(chip->sb, 0, &chip->sb->pcm);\r\nif (err < 0) {\r\nprintk(KERN_ERR "CS5530: Could not create PCM\n");\r\nsnd_cs5530_free(chip);\r\nreturn err;\r\n}\r\nerr = snd_sbmixer_new(chip->sb);\r\nif (err < 0) {\r\nprintk(KERN_ERR "CS5530: Could not create Mixer\n");\r\nsnd_cs5530_free(chip);\r\nreturn err;\r\n}\r\nerr = snd_device_new(card, SNDRV_DEV_LOWLEVEL, chip, &ops);\r\nif (err < 0) {\r\nsnd_cs5530_free(chip);\r\nreturn err;\r\n}\r\nsnd_card_set_dev(card, &pci->dev);\r\n*rchip = chip;\r\nreturn 0;\r\n}\r\nstatic int snd_cs5530_probe(struct pci_dev *pci,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nstatic int dev;\r\nstruct snd_card *card;\r\nstruct snd_cs5530 *chip = NULL;\r\nint err;\r\nif (dev >= SNDRV_CARDS)\r\nreturn -ENODEV;\r\nif (!enable[dev]) {\r\ndev++;\r\nreturn -ENOENT;\r\n}\r\nerr = snd_card_create(index[dev], id[dev], THIS_MODULE, 0, &card);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_cs5530_create(card, pci, &chip);\r\nif (err < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nstrcpy(card->driver, "CS5530");\r\nstrcpy(card->shortname, "CS5530 Audio");\r\nsprintf(card->longname, "%s at 0x%lx", card->shortname, chip->pci_base);\r\nerr = snd_card_register(card);\r\nif (err < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\npci_set_drvdata(pci, card);\r\ndev++;\r\nreturn 0;\r\n}

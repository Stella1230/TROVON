int\r\nsnd_seq_oss_process_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev)\r\n{\r\nswitch (q->s.code) {\r\ncase SEQ_EXTENDED:\r\nreturn extended_event(dp, q, ev);\r\ncase EV_CHN_VOICE:\r\nreturn chn_voice_event(dp, q, ev);\r\ncase EV_CHN_COMMON:\r\nreturn chn_common_event(dp, q, ev);\r\ncase EV_TIMING:\r\nreturn timing_event(dp, q, ev);\r\ncase EV_SEQ_LOCAL:\r\nreturn local_event(dp, q, ev);\r\ncase EV_SYSEX:\r\nreturn snd_seq_oss_synth_sysex(dp, q->x.dev, q->x.buf, ev);\r\ncase SEQ_MIDIPUTC:\r\nif (dp->seq_mode == SNDRV_SEQ_OSS_MODE_MUSIC)\r\nreturn -EINVAL;\r\nif (! is_write_mode(dp->file_mode))\r\nbreak;\r\nif (snd_seq_oss_midi_open(dp, q->s.dev, SNDRV_SEQ_OSS_FILE_WRITE))\r\nbreak;\r\nif (snd_seq_oss_midi_filemode(dp, q->s.dev) & SNDRV_SEQ_OSS_FILE_WRITE)\r\nreturn snd_seq_oss_midi_putc(dp, q->s.dev, q->s.parm1, ev);\r\nbreak;\r\ncase SEQ_ECHO:\r\nif (dp->seq_mode == SNDRV_SEQ_OSS_MODE_MUSIC)\r\nreturn -EINVAL;\r\nreturn set_echo_event(dp, q, ev);\r\ncase SEQ_PRIVATE:\r\nif (dp->seq_mode == SNDRV_SEQ_OSS_MODE_MUSIC)\r\nreturn -EINVAL;\r\nreturn snd_seq_oss_synth_raw_event(dp, q->c[1], q->c, ev);\r\ndefault:\r\nif (dp->seq_mode == SNDRV_SEQ_OSS_MODE_MUSIC)\r\nreturn -EINVAL;\r\nreturn old_event(dp, q, ev);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nold_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev)\r\n{\r\nswitch (q->s.code) {\r\ncase SEQ_NOTEOFF:\r\nreturn note_off_event(dp, 0, q->n.chn, q->n.note, q->n.vel, ev);\r\ncase SEQ_NOTEON:\r\nreturn note_on_event(dp, 0, q->n.chn, q->n.note, q->n.vel, ev);\r\ncase SEQ_WAIT:\r\nbreak;\r\ncase SEQ_PGMCHANGE:\r\nreturn set_control_event(dp, 0, SNDRV_SEQ_EVENT_PGMCHANGE,\r\nq->n.chn, 0, q->n.note, ev);\r\ncase SEQ_SYNCTIMER:\r\nreturn snd_seq_oss_timer_reset(dp->timer);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nextended_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev)\r\n{\r\nint val;\r\nswitch (q->e.cmd) {\r\ncase SEQ_NOTEOFF:\r\nreturn note_off_event(dp, q->e.dev, q->e.chn, q->e.p1, q->e.p2, ev);\r\ncase SEQ_NOTEON:\r\nreturn note_on_event(dp, q->e.dev, q->e.chn, q->e.p1, q->e.p2, ev);\r\ncase SEQ_PGMCHANGE:\r\nreturn set_control_event(dp, q->e.dev, SNDRV_SEQ_EVENT_PGMCHANGE,\r\nq->e.chn, 0, q->e.p1, ev);\r\ncase SEQ_AFTERTOUCH:\r\nreturn set_control_event(dp, q->e.dev, SNDRV_SEQ_EVENT_CHANPRESS,\r\nq->e.chn, 0, q->e.p1, ev);\r\ncase SEQ_BALANCE:\r\nval = (char)q->e.p1;\r\nval = (val + 128) / 2;\r\nreturn set_control_event(dp, q->e.dev, SNDRV_SEQ_EVENT_CONTROLLER,\r\nq->e.chn, CTL_PAN, val, ev);\r\ncase SEQ_CONTROLLER:\r\nval = ((short)q->e.p3 << 8) | (short)q->e.p2;\r\nswitch (q->e.p1) {\r\ncase CTRL_PITCH_BENDER:\r\nreturn set_control_event(dp, q->e.dev,\r\nSNDRV_SEQ_EVENT_PITCHBEND,\r\nq->e.chn, 0, val, ev);\r\ncase CTRL_PITCH_BENDER_RANGE:\r\nreturn set_control_event(dp, q->e.dev,\r\nSNDRV_SEQ_EVENT_REGPARAM,\r\nq->e.chn, 0, val*128/100, ev);\r\ndefault:\r\nreturn set_control_event(dp, q->e.dev,\r\nSNDRV_SEQ_EVENT_CONTROL14,\r\nq->e.chn, q->e.p1, val, ev);\r\n}\r\ncase SEQ_VOLMODE:\r\nreturn snd_seq_oss_synth_raw_event(dp, q->e.dev, q->c, ev);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nchn_voice_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev)\r\n{\r\nif (q->v.chn >= 32)\r\nreturn -EINVAL;\r\nswitch (q->v.cmd) {\r\ncase MIDI_NOTEON:\r\nreturn note_on_event(dp, q->v.dev, q->v.chn, q->v.note, q->v.parm, ev);\r\ncase MIDI_NOTEOFF:\r\nreturn note_off_event(dp, q->v.dev, q->v.chn, q->v.note, q->v.parm, ev);\r\ncase MIDI_KEY_PRESSURE:\r\nreturn set_note_event(dp, q->v.dev, SNDRV_SEQ_EVENT_KEYPRESS,\r\nq->v.chn, q->v.note, q->v.parm, ev);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nchn_common_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev)\r\n{\r\nif (q->l.chn >= 32)\r\nreturn -EINVAL;\r\nswitch (q->l.cmd) {\r\ncase MIDI_PGM_CHANGE:\r\nreturn set_control_event(dp, q->l.dev, SNDRV_SEQ_EVENT_PGMCHANGE,\r\nq->l.chn, 0, q->l.p1, ev);\r\ncase MIDI_CTL_CHANGE:\r\nreturn set_control_event(dp, q->l.dev, SNDRV_SEQ_EVENT_CONTROLLER,\r\nq->l.chn, q->l.p1, q->l.val, ev);\r\ncase MIDI_PITCH_BEND:\r\nreturn set_control_event(dp, q->l.dev, SNDRV_SEQ_EVENT_PITCHBEND,\r\nq->l.chn, 0, q->l.val - 8192, ev);\r\ncase MIDI_CHN_PRESSURE:\r\nreturn set_control_event(dp, q->l.dev, SNDRV_SEQ_EVENT_CHANPRESS,\r\nq->l.chn, 0, q->l.val, ev);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\ntiming_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev)\r\n{\r\nswitch (q->t.cmd) {\r\ncase TMR_ECHO:\r\nif (dp->seq_mode == SNDRV_SEQ_OSS_MODE_MUSIC)\r\nreturn set_echo_event(dp, q, ev);\r\nelse {\r\nunion evrec tmp;\r\nmemset(&tmp, 0, sizeof(tmp));\r\ntmp.echo = (q->t.time << 8) | SEQ_ECHO;\r\nreturn set_echo_event(dp, &tmp, ev);\r\n}\r\ncase TMR_STOP:\r\nif (dp->seq_mode)\r\nreturn snd_seq_oss_timer_stop(dp->timer);\r\nreturn 0;\r\ncase TMR_CONTINUE:\r\nif (dp->seq_mode)\r\nreturn snd_seq_oss_timer_continue(dp->timer);\r\nreturn 0;\r\ncase TMR_TEMPO:\r\nif (dp->seq_mode)\r\nreturn snd_seq_oss_timer_tempo(dp->timer, q->t.time);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nlocal_event(struct seq_oss_devinfo *dp, union evrec *q, struct snd_seq_event *ev)\r\n{\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nnote_on_event(struct seq_oss_devinfo *dp, int dev, int ch, int note, int vel, struct snd_seq_event *ev)\r\n{\r\nstruct seq_oss_synthinfo *info;\r\nif (!snd_seq_oss_synth_is_valid(dp, dev))\r\nreturn -ENXIO;\r\ninfo = &dp->synths[dev];\r\nswitch (info->arg.event_passing) {\r\ncase SNDRV_SEQ_OSS_PROCESS_EVENTS:\r\nif (! info->ch || ch < 0 || ch >= info->nr_voices) {\r\nreturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEON, ch, note, vel, ev);\r\n}\r\nif (note == 255 && info->ch[ch].note >= 0) {\r\nint type;\r\nif (info->ch[ch].vel)\r\ntype = SNDRV_SEQ_EVENT_KEYPRESS;\r\nelse\r\ntype = SNDRV_SEQ_EVENT_NOTEON;\r\ninfo->ch[ch].vel = vel;\r\nreturn set_note_event(dp, dev, type, ch, info->ch[ch].note, vel, ev);\r\n} else if (note >= 128)\r\nreturn -EINVAL;\r\nif (note != info->ch[ch].note && info->ch[ch].note >= 0)\r\nset_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEOFF, ch, info->ch[ch].note, 0, ev);\r\ninfo->ch[ch].note = note;\r\ninfo->ch[ch].vel = vel;\r\nif (vel)\r\nreturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEON, ch, note, vel, ev);\r\nreturn -EINVAL;\r\ncase SNDRV_SEQ_OSS_PASS_EVENTS:\r\nreturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEON, ch, note, vel, ev);\r\ncase SNDRV_SEQ_OSS_PROCESS_KEYPRESS:\r\nif (note >= 128)\r\nreturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_KEYPRESS, ch, note - 128, vel, ev);\r\nelse\r\nreturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEON, ch, note, vel, ev);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nnote_off_event(struct seq_oss_devinfo *dp, int dev, int ch, int note, int vel, struct snd_seq_event *ev)\r\n{\r\nstruct seq_oss_synthinfo *info;\r\nif (!snd_seq_oss_synth_is_valid(dp, dev))\r\nreturn -ENXIO;\r\ninfo = &dp->synths[dev];\r\nswitch (info->arg.event_passing) {\r\ncase SNDRV_SEQ_OSS_PROCESS_EVENTS:\r\nif (! info->ch || ch < 0 || ch >= info->nr_voices) {\r\nreturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEON, ch, note, vel, ev);\r\n}\r\nif (info->ch[ch].note >= 0) {\r\nnote = info->ch[ch].note;\r\ninfo->ch[ch].vel = 0;\r\ninfo->ch[ch].note = -1;\r\nreturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEOFF, ch, note, vel, ev);\r\n}\r\nreturn -EINVAL;\r\ncase SNDRV_SEQ_OSS_PASS_EVENTS:\r\ncase SNDRV_SEQ_OSS_PROCESS_KEYPRESS:\r\nreturn set_note_event(dp, dev, SNDRV_SEQ_EVENT_NOTEOFF, ch, note, vel, ev);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nset_note_event(struct seq_oss_devinfo *dp, int dev, int type, int ch, int note, int vel, struct snd_seq_event *ev)\r\n{\r\nif (! snd_seq_oss_synth_is_valid(dp, dev))\r\nreturn -ENXIO;\r\nev->type = type;\r\nsnd_seq_oss_synth_addr(dp, dev, ev);\r\nev->data.note.channel = ch;\r\nev->data.note.note = note;\r\nev->data.note.velocity = vel;\r\nreturn 0;\r\n}\r\nstatic int\r\nset_control_event(struct seq_oss_devinfo *dp, int dev, int type, int ch, int param, int val, struct snd_seq_event *ev)\r\n{\r\nif (! snd_seq_oss_synth_is_valid(dp, dev))\r\nreturn -ENXIO;\r\nev->type = type;\r\nsnd_seq_oss_synth_addr(dp, dev, ev);\r\nev->data.control.channel = ch;\r\nev->data.control.param = param;\r\nev->data.control.value = val;\r\nreturn 0;\r\n}\r\nstatic int\r\nset_echo_event(struct seq_oss_devinfo *dp, union evrec *rec, struct snd_seq_event *ev)\r\n{\r\nev->type = SNDRV_SEQ_EVENT_ECHO;\r\nsnd_seq_oss_fill_addr(dp, ev, dp->addr.client, dp->addr.port);\r\nmemcpy(&ev->data, rec, LONG_EVENT_SIZE);\r\nreturn 0;\r\n}\r\nint\r\nsnd_seq_oss_event_input(struct snd_seq_event *ev, int direct, void *private_data,\r\nint atomic, int hop)\r\n{\r\nstruct seq_oss_devinfo *dp = (struct seq_oss_devinfo *)private_data;\r\nunion evrec *rec;\r\nif (ev->type != SNDRV_SEQ_EVENT_ECHO)\r\nreturn snd_seq_oss_midi_input(ev, direct, private_data);\r\nif (ev->source.client != dp->cseq)\r\nreturn 0;\r\nrec = (union evrec*)&ev->data;\r\nif (rec->s.code == SEQ_SYNCTIMER) {\r\nsnd_seq_oss_writeq_wakeup(dp->writeq, rec->t.time);\r\n} else {\r\nif (dp->readq == NULL)\r\nreturn 0;\r\nsnd_seq_oss_readq_put_event(dp->readq, rec);\r\n}\r\nreturn 0;\r\n}

static int ssb_pcihost_suspend(struct pci_dev *dev, pm_message_t state)\r\n{\r\nstruct ssb_bus *ssb = pci_get_drvdata(dev);\r\nint err;\r\nerr = ssb_bus_suspend(ssb);\r\nif (err)\r\nreturn err;\r\npci_save_state(dev);\r\npci_disable_device(dev);\r\npci_set_power_state(dev, pci_choose_state(dev, state));\r\nreturn 0;\r\n}\r\nstatic int ssb_pcihost_resume(struct pci_dev *dev)\r\n{\r\nstruct ssb_bus *ssb = pci_get_drvdata(dev);\r\nint err;\r\npci_set_power_state(dev, PCI_D0);\r\nerr = pci_enable_device(dev);\r\nif (err)\r\nreturn err;\r\npci_restore_state(dev);\r\nerr = ssb_bus_resume(ssb);\r\nif (err)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int ssb_pcihost_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nstruct ssb_bus *ssb;\r\nint err = -ENOMEM;\r\nconst char *name;\r\nu32 val;\r\nssb = kzalloc(sizeof(*ssb), GFP_KERNEL);\r\nif (!ssb)\r\ngoto out;\r\nerr = pci_enable_device(dev);\r\nif (err)\r\ngoto err_kfree_ssb;\r\nname = dev_name(&dev->dev);\r\nif (dev->driver && dev->driver->name)\r\nname = dev->driver->name;\r\nerr = pci_request_regions(dev, name);\r\nif (err)\r\ngoto err_pci_disable;\r\npci_set_master(dev);\r\npci_read_config_dword(dev, 0x40, &val);\r\nif ((val & 0x0000ff00) != 0)\r\npci_write_config_dword(dev, 0x40, val & 0xffff00ff);\r\nerr = ssb_bus_pcibus_register(ssb, dev);\r\nif (err)\r\ngoto err_pci_release_regions;\r\npci_set_drvdata(dev, ssb);\r\nout:\r\nreturn err;\r\nerr_pci_release_regions:\r\npci_release_regions(dev);\r\nerr_pci_disable:\r\npci_disable_device(dev);\r\nerr_kfree_ssb:\r\nkfree(ssb);\r\nreturn err;\r\n}\r\nstatic void ssb_pcihost_remove(struct pci_dev *dev)\r\n{\r\nstruct ssb_bus *ssb = pci_get_drvdata(dev);\r\nssb_bus_unregister(ssb);\r\npci_release_regions(dev);\r\npci_disable_device(dev);\r\nkfree(ssb);\r\npci_set_drvdata(dev, NULL);\r\n}\r\nint ssb_pcihost_register(struct pci_driver *driver)\r\n{\r\ndriver->probe = ssb_pcihost_probe;\r\ndriver->remove = ssb_pcihost_remove;\r\ndriver->suspend = ssb_pcihost_suspend;\r\ndriver->resume = ssb_pcihost_resume;\r\nreturn pci_register_driver(driver);\r\n}

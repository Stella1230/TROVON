static ssize_t acpi_ec_read_io(struct file *f, char __user *buf,\r\nsize_t count, loff_t *off)\r\n{\r\nunsigned int size = EC_SPACE_SIZE;\r\nloff_t init_off = *off;\r\nint err = 0;\r\nif (*off >= size)\r\nreturn 0;\r\nif (*off + count >= size) {\r\nsize -= *off;\r\ncount = size;\r\n} else\r\nsize = count;\r\nwhile (size) {\r\nu8 byte_read;\r\nerr = ec_read(*off, &byte_read);\r\nif (err)\r\nreturn err;\r\nif (put_user(byte_read, buf + *off - init_off)) {\r\nif (*off - init_off)\r\nreturn *off - init_off;\r\nreturn -EFAULT;\r\n}\r\n*off += 1;\r\nsize--;\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t acpi_ec_write_io(struct file *f, const char __user *buf,\r\nsize_t count, loff_t *off)\r\n{\r\nunsigned int size = count;\r\nloff_t init_off = *off;\r\nint err = 0;\r\nif (*off >= EC_SPACE_SIZE)\r\nreturn 0;\r\nif (*off + count >= EC_SPACE_SIZE) {\r\nsize = EC_SPACE_SIZE - *off;\r\ncount = size;\r\n}\r\nwhile (size) {\r\nu8 byte_write;\r\nif (get_user(byte_write, buf + *off - init_off)) {\r\nif (*off - init_off)\r\nreturn *off - init_off;\r\nreturn -EFAULT;\r\n}\r\nerr = ec_write(*off, byte_write);\r\nif (err)\r\nreturn err;\r\n*off += 1;\r\nsize--;\r\n}\r\nreturn count;\r\n}\r\nint acpi_ec_add_debugfs(struct acpi_ec *ec, unsigned int ec_device_count)\r\n{\r\nstruct dentry *dev_dir;\r\nchar name[64];\r\numode_t mode = 0400;\r\nif (ec_device_count == 0) {\r\nacpi_ec_debugfs_dir = debugfs_create_dir("ec", NULL);\r\nif (!acpi_ec_debugfs_dir)\r\nreturn -ENOMEM;\r\n}\r\nsprintf(name, "ec%u", ec_device_count);\r\ndev_dir = debugfs_create_dir(name, acpi_ec_debugfs_dir);\r\nif (!dev_dir) {\r\nif (ec_device_count != 0)\r\ngoto error;\r\nreturn -ENOMEM;\r\n}\r\nif (!debugfs_create_x32("gpe", 0444, dev_dir, (u32 *)&first_ec->gpe))\r\ngoto error;\r\nif (!debugfs_create_bool("use_global_lock", 0444, dev_dir,\r\n(u32 *)&first_ec->global_lock))\r\ngoto error;\r\nif (write_support)\r\nmode = 0600;\r\nif (!debugfs_create_file("io", mode, dev_dir, ec, &acpi_ec_io_ops))\r\ngoto error;\r\nreturn 0;\r\nerror:\r\ndebugfs_remove_recursive(acpi_ec_debugfs_dir);\r\nreturn -ENOMEM;\r\n}\r\nstatic int __init acpi_ec_sys_init(void)\r\n{\r\nint err = 0;\r\nif (first_ec)\r\nerr = acpi_ec_add_debugfs(first_ec, 0);\r\nelse\r\nerr = -ENODEV;\r\nreturn err;\r\n}\r\nstatic void __exit acpi_ec_sys_exit(void)\r\n{\r\ndebugfs_remove_recursive(acpi_ec_debugfs_dir);\r\n}

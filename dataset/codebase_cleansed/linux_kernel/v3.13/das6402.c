static void das6402_ai_fifo_dregs(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nwhile (1) {\r\nif (!(inb(dev->iobase + 8) & 0x01))\r\nreturn;\r\ncomedi_buf_put(s->async, inw(dev->iobase));\r\n}\r\n}\r\nstatic void das6402_setcounter(struct comedi_device *dev)\r\n{\r\nBYTE p;\r\nunsigned short ctrlwrd;\r\np = M0 | C0 | RWLH;\r\noutb_p(p, dev->iobase + 15);\r\nctrlwrd = 2000;\r\np = (BYTE) (0xff & ctrlwrd);\r\noutb_p(p, dev->iobase + 12);\r\np = (BYTE) (0xff & (ctrlwrd >> 8));\r\noutb_p(p, dev->iobase + 12);\r\np = M2 | C1 | RWLH;\r\noutb_p(p, dev->iobase + 15);\r\nctrlwrd = 10;\r\np = (BYTE) (0xff & ctrlwrd);\r\noutb_p(p, dev->iobase + 13);\r\np = (BYTE) (0xff & (ctrlwrd >> 8));\r\noutb_p(p, dev->iobase + 13);\r\np = M2 | C2 | RWLH;\r\noutb_p(p, dev->iobase + 15);\r\nctrlwrd = 1000;\r\np = (BYTE) (0xff & ctrlwrd);\r\noutb_p(p, dev->iobase + 14);\r\np = (BYTE) (0xff & (ctrlwrd >> 8));\r\noutb_p(p, dev->iobase + 14);\r\n}\r\nstatic irqreturn_t intr_handler(int irq, void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nstruct das6402_private *devpriv = dev->private;\r\nstruct comedi_subdevice *s = &dev->subdevices[0];\r\nif (!dev->attached || devpriv->das6402_ignoreirq) {\r\ndev_warn(dev->class_dev, "BUG: spurious interrupt\n");\r\nreturn IRQ_HANDLED;\r\n}\r\n#ifdef DEBUG\r\nprintk("das6402: interrupt! das6402_irqcount=%i\n",\r\ndevpriv->das6402_irqcount);\r\nprintk("das6402: iobase+2=%i\n", inw_p(dev->iobase + 2));\r\n#endif\r\ndas6402_ai_fifo_dregs(dev, s);\r\nif (s->async->buf_write_count >= devpriv->ai_bytes_to_read) {\r\noutw_p(SCANL, dev->iobase + 2);\r\noutb(0x07, dev->iobase + 8);\r\n#ifdef DEBUG\r\nprintk("das6402: Got %i samples\n\n",\r\ndevpriv->das6402_wordsread - diff);\r\n#endif\r\ns->async->events |= COMEDI_CB_EOA;\r\ncomedi_event(dev, s);\r\n}\r\noutb(0x01, dev->iobase + 8);\r\ncomedi_event(dev, s);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int das6402_ai_cancel(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct das6402_private *devpriv = dev->private;\r\ndevpriv->das6402_ignoreirq = 1;\r\ndev_dbg(dev->class_dev, "Stopping acquisition\n");\r\ndevpriv->das6402_ignoreirq = 1;\r\noutb_p(0x02, dev->iobase + 10);\r\noutw_p(SCANL, dev->iobase + 2);\r\noutb_p(0, dev->iobase + 9);\r\noutw_p(SCANL, dev->iobase + 2);\r\nreturn 0;\r\n}\r\nstatic int das6402_ai_mode2(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, comedi_trig * it)\r\n{\r\nstruct das6402_private *devpriv = dev->private;\r\ndevpriv->das6402_ignoreirq = 1;\r\ndev_dbg(dev->class_dev, "Starting acquisition\n");\r\noutb_p(0x03, dev->iobase + 10);\r\noutw_p(SCANL, dev->iobase + 2);\r\noutb_p(IRQ | CONVSRC | BURSTEN | INTE, dev->iobase + 9);\r\ndevpriv->ai_bytes_to_read = it->n * sizeof(short);\r\ndevpriv->das6402_ignoreirq = 0;\r\noutw_p(SCANL, dev->iobase + 2);\r\nreturn 0;\r\n}\r\nstatic int board_init(struct comedi_device *dev)\r\n{\r\nstruct das6402_private *devpriv = dev->private;\r\nBYTE b;\r\ndevpriv->das6402_ignoreirq = 1;\r\noutb(0x07, dev->iobase + 8);\r\noutb_p(MODE, dev->iobase + 11);\r\nb = BIP | SEM | MODE | GAIN | FIFOHFULL;\r\noutb_p(b, dev->iobase + 11);\r\noutb_p(EXTEND, dev->iobase + 8);\r\nb = EXTEND | MHZ;\r\noutb_p(b, dev->iobase + 8);\r\nb = MHZ | CLRINT | CLRXTR | CLRXIN;\r\noutb_p(b, dev->iobase + 8);\r\nb = IRQ | CONVSRC | BURSTEN | INTE;\r\noutb_p(b, dev->iobase + 9);\r\nb = TGSEL | TGEN;\r\noutb_p(b, dev->iobase + 10);\r\nb = 0x07;\r\noutb_p(b, dev->iobase + 8);\r\ndas6402_setcounter(dev);\r\noutw_p(SCANL, dev->iobase + 2);\r\ndevpriv->das6402_ignoreirq = 0;\r\nreturn 0;\r\n}\r\nstatic int das6402_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nstruct das6402_private *devpriv;\r\nunsigned int irq;\r\nint ret;\r\nstruct comedi_subdevice *s;\r\nret = comedi_request_region(dev, it->options[0], DAS6402_SIZE);\r\nif (ret)\r\nreturn ret;\r\nirq = it->options[0];\r\ndev_dbg(dev->class_dev, "( irq = %u )\n", irq);\r\nret = request_irq(irq, intr_handler, 0, "das6402", dev);\r\nif (ret < 0)\r\nreturn ret;\r\ndev->irq = irq;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\nret = comedi_alloc_subdevices(dev, 1);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND;\r\ns->n_chan = 8;\r\ns->cancel = das6402_ai_cancel;\r\ns->maxdata = (1 << 12) - 1;\r\ns->len_chanlist = 16;\r\ns->range_table = &range_unknown;\r\nboard_init(dev);\r\nreturn 0;\r\n}

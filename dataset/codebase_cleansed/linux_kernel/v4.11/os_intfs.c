static void loadparam(struct _adapter *padapter, struct net_device *pnetdev)\r\n{\r\nstruct registry_priv *registry_par = &padapter->registrypriv;\r\nregistry_par->chip_version = (u8)chip_version;\r\nregistry_par->rfintfs = (u8)rfintfs;\r\nregistry_par->lbkmode = (u8)lbkmode;\r\nregistry_par->hci = (u8)hci;\r\nregistry_par->network_mode = (u8)network_mode;\r\nmemcpy(registry_par->ssid.Ssid, "ANY", 3);\r\nregistry_par->ssid.SsidLength = 3;\r\nregistry_par->channel = (u8)channel;\r\nregistry_par->wireless_mode = (u8)wireless_mode;\r\nregistry_par->vrtl_carrier_sense = (u8)vrtl_carrier_sense;\r\nregistry_par->vcs_type = (u8)vcs_type;\r\nregistry_par->frag_thresh = (u16)frag_thresh;\r\nregistry_par->preamble = (u8)preamble;\r\nregistry_par->scan_mode = (u8)scan_mode;\r\nregistry_par->adhoc_tx_pwr = (u8)adhoc_tx_pwr;\r\nregistry_par->soft_ap = (u8)soft_ap;\r\nregistry_par->smart_ps = (u8)smart_ps;\r\nregistry_par->power_mgnt = (u8)power_mgnt;\r\nregistry_par->radio_enable = (u8)radio_enable;\r\nregistry_par->long_retry_lmt = (u8)long_retry_lmt;\r\nregistry_par->short_retry_lmt = (u8)short_retry_lmt;\r\nregistry_par->busy_thresh = (u16)busy_thresh;\r\nregistry_par->ack_policy = (u8)ack_policy;\r\nregistry_par->mp_mode = (u8)mp_mode;\r\nregistry_par->software_encrypt = (u8)software_encrypt;\r\nregistry_par->software_decrypt = (u8)software_decrypt;\r\nregistry_par->wmm_enable = (u8)wmm_enable;\r\nregistry_par->uapsd_enable = (u8)uapsd_enable;\r\nregistry_par->uapsd_max_sp = (u8)uapsd_max_sp;\r\nregistry_par->uapsd_acbk_en = (u8)uapsd_acbk_en;\r\nregistry_par->uapsd_acbe_en = (u8)uapsd_acbe_en;\r\nregistry_par->uapsd_acvi_en = (u8)uapsd_acvi_en;\r\nregistry_par->uapsd_acvo_en = (u8)uapsd_acvo_en;\r\nregistry_par->ht_enable = (u8)ht_enable;\r\nregistry_par->cbw40_enable = (u8)cbw40_enable;\r\nregistry_par->ampdu_enable = (u8)ampdu_enable;\r\nregistry_par->rf_config = (u8)rf_config;\r\nregistry_par->low_power = (u8)low_power;\r\nregistry_par->wifi_test = (u8) wifi_test;\r\nr8712_initmac = initmac;\r\n}\r\nstatic int r871x_net_set_mac_address(struct net_device *pnetdev, void *p)\r\n{\r\nstruct _adapter *padapter = netdev_priv(pnetdev);\r\nstruct sockaddr *addr = p;\r\nif (!padapter->bup)\r\nether_addr_copy(pnetdev->dev_addr, addr->sa_data);\r\nreturn 0;\r\n}\r\nstatic struct net_device_stats *r871x_net_get_stats(struct net_device *pnetdev)\r\n{\r\nstruct _adapter *padapter = netdev_priv(pnetdev);\r\nstruct xmit_priv *pxmitpriv = &(padapter->xmitpriv);\r\nstruct recv_priv *precvpriv = &(padapter->recvpriv);\r\npadapter->stats.tx_packets = pxmitpriv->tx_pkts;\r\npadapter->stats.rx_packets = precvpriv->rx_pkts;\r\npadapter->stats.tx_dropped = pxmitpriv->tx_drop;\r\npadapter->stats.rx_dropped = precvpriv->rx_drop;\r\npadapter->stats.tx_bytes = pxmitpriv->tx_bytes;\r\npadapter->stats.rx_bytes = precvpriv->rx_bytes;\r\nreturn &padapter->stats;\r\n}\r\nstruct net_device *r8712_init_netdev(void)\r\n{\r\nstruct _adapter *padapter;\r\nstruct net_device *pnetdev;\r\npnetdev = alloc_etherdev(sizeof(struct _adapter));\r\nif (!pnetdev)\r\nreturn NULL;\r\nif (dev_alloc_name(pnetdev, ifname) < 0) {\r\nstrcpy(ifname, "wlan%d");\r\ndev_alloc_name(pnetdev, ifname);\r\n}\r\npadapter = netdev_priv(pnetdev);\r\npadapter->pnetdev = pnetdev;\r\npr_info("r8712u: register rtl8712_netdev_ops to netdev_ops\n");\r\npnetdev->netdev_ops = &rtl8712_netdev_ops;\r\npnetdev->watchdog_timeo = HZ;\r\npnetdev->wireless_handlers = (struct iw_handler_def *)\r\n&r871x_handlers_def;\r\nloadparam(padapter, pnetdev);\r\nnetif_carrier_off(pnetdev);\r\npadapter->pid = 0;\r\nreturn pnetdev;\r\n}\r\nstatic u32 start_drv_threads(struct _adapter *padapter)\r\n{\r\npadapter->cmdThread = kthread_run(r8712_cmd_thread, padapter, "%s",\r\npadapter->pnetdev->name);\r\nif (IS_ERR(padapter->cmdThread))\r\nreturn _FAIL;\r\nreturn _SUCCESS;\r\n}\r\nvoid r8712_stop_drv_threads(struct _adapter *padapter)\r\n{\r\ncomplete(&padapter->cmdpriv.cmd_queue_comp);\r\nif (padapter->cmdThread)\r\nwait_for_completion_interruptible(&padapter->cmdpriv.terminate_cmdthread_comp);\r\npadapter->cmdpriv.cmd_seq = 1;\r\n}\r\nstatic void start_drv_timers(struct _adapter *padapter)\r\n{\r\nmod_timer(&padapter->mlmepriv.sitesurveyctrl.sitesurvey_ctrl_timer,\r\njiffies + msecs_to_jiffies(5000));\r\nmod_timer(&padapter->mlmepriv.wdg_timer,\r\njiffies + msecs_to_jiffies(2000));\r\n}\r\nvoid r8712_stop_drv_timers(struct _adapter *padapter)\r\n{\r\ndel_timer_sync(&padapter->mlmepriv.assoc_timer);\r\ndel_timer_sync(&padapter->securitypriv.tkip_timer);\r\ndel_timer_sync(&padapter->mlmepriv.scan_to_timer);\r\ndel_timer_sync(&padapter->mlmepriv.dhcp_timer);\r\ndel_timer_sync(&padapter->mlmepriv.wdg_timer);\r\ndel_timer_sync(&padapter->mlmepriv.sitesurveyctrl.sitesurvey_ctrl_timer);\r\n}\r\nstatic u8 init_default_value(struct _adapter *padapter)\r\n{\r\nstruct registry_priv *pregistrypriv = &padapter->registrypriv;\r\nstruct xmit_priv *pxmitpriv = &padapter->xmitpriv;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nstruct security_priv *psecuritypriv = &padapter->securitypriv;\r\npxmitpriv->vcs_setting = pregistrypriv->vrtl_carrier_sense;\r\npxmitpriv->vcs = pregistrypriv->vcs_type;\r\npxmitpriv->vcs_type = pregistrypriv->vcs_type;\r\npxmitpriv->rts_thresh = pregistrypriv->rts_thresh;\r\npxmitpriv->frag_len = pregistrypriv->frag_thresh;\r\npmlmepriv->passive_mode = 1;\r\n{\r\nint i;\r\nstruct ht_priv *phtpriv = &pmlmepriv->htpriv;\r\nphtpriv->ampdu_enable = false;\r\nfor (i = 0; i < 16; i++)\r\nphtpriv->baddbareq_issued[i] = false;\r\n}\r\npsecuritypriv->sw_encrypt = pregistrypriv->software_encrypt;\r\npsecuritypriv->sw_decrypt = pregistrypriv->software_decrypt;\r\npsecuritypriv->binstallGrpkey = _FAIL;\r\nr8712_init_registrypriv_dev_network(padapter);\r\nr8712_update_registrypriv_dev_network(padapter);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_init_drv_sw(struct _adapter *padapter)\r\n{\r\nif ((r8712_init_cmd_priv(&padapter->cmdpriv)) == _FAIL)\r\nreturn _FAIL;\r\npadapter->cmdpriv.padapter = padapter;\r\nif ((r8712_init_evt_priv(&padapter->evtpriv)) == _FAIL)\r\nreturn _FAIL;\r\nif (r8712_init_mlme_priv(padapter) == _FAIL)\r\nreturn _FAIL;\r\n_r8712_init_xmit_priv(&padapter->xmitpriv, padapter);\r\n_r8712_init_recv_priv(&padapter->recvpriv, padapter);\r\nmemset((unsigned char *)&padapter->securitypriv, 0,\r\nsizeof(struct security_priv));\r\nsetup_timer(&padapter->securitypriv.tkip_timer,\r\nr8712_use_tkipkey_handler, (unsigned long)padapter);\r\n_r8712_init_sta_priv(&padapter->stapriv);\r\npadapter->stapriv.padapter = padapter;\r\nr8712_init_bcmc_stainfo(padapter);\r\nr8712_init_pwrctrl_priv(padapter);\r\nmp871xinit(padapter);\r\nif (init_default_value(padapter) != _SUCCESS)\r\nreturn _FAIL;\r\nr8712_InitSwLeds(padapter);\r\nreturn _SUCCESS;\r\n}\r\nu8 r8712_free_drv_sw(struct _adapter *padapter)\r\n{\r\nstruct net_device *pnetdev = padapter->pnetdev;\r\nr8712_free_cmd_priv(&padapter->cmdpriv);\r\nr8712_free_evt_priv(&padapter->evtpriv);\r\nr8712_DeInitSwLeds(padapter);\r\nr8712_free_mlme_priv(&padapter->mlmepriv);\r\nr8712_free_io_queue(padapter);\r\n_free_xmit_priv(&padapter->xmitpriv);\r\n_r8712_free_sta_priv(&padapter->stapriv);\r\n_r8712_free_recv_priv(&padapter->recvpriv);\r\nmp871xdeinit(padapter);\r\nif (pnetdev)\r\nfree_netdev(pnetdev);\r\nreturn _SUCCESS;\r\n}\r\nstatic void enable_video_mode(struct _adapter *padapter, int cbw40_value)\r\n{\r\nu32 intcmd = 0xf4000500;\r\nif (cbw40_value) {\r\nintcmd |= 0x200;\r\n}\r\nr8712_fw_cmd(padapter, intcmd);\r\n}\r\nstatic int netdev_open(struct net_device *pnetdev)\r\n{\r\nstruct _adapter *padapter = netdev_priv(pnetdev);\r\nmutex_lock(&padapter->mutex_start);\r\nif (!padapter->bup) {\r\npadapter->bDriverStopped = false;\r\npadapter->bSurpriseRemoved = false;\r\npadapter->bup = true;\r\nif (rtl871x_hal_init(padapter) != _SUCCESS)\r\ngoto netdev_open_error;\r\nif (!r8712_initmac)\r\nmemcpy(pnetdev->dev_addr,\r\npadapter->eeprompriv.mac_addr, ETH_ALEN);\r\nelse {\r\nmsleep(200);\r\nr8712_setMacAddr_cmd(padapter, (u8 *)pnetdev->dev_addr);\r\nmemcpy(padapter->eeprompriv.mac_addr,\r\npnetdev->dev_addr, ETH_ALEN);\r\n}\r\nif (start_drv_threads(padapter) != _SUCCESS)\r\ngoto netdev_open_error;\r\nif (!padapter->dvobjpriv.inirp_init)\r\ngoto netdev_open_error;\r\nelse\r\npadapter->dvobjpriv.inirp_init(padapter);\r\nr8712_set_ps_mode(padapter, padapter->registrypriv.power_mgnt,\r\npadapter->registrypriv.smart_ps);\r\n}\r\nif (!netif_queue_stopped(pnetdev))\r\nnetif_start_queue(pnetdev);\r\nelse\r\nnetif_wake_queue(pnetdev);\r\nif (video_mode)\r\nenable_video_mode(padapter, cbw40_enable);\r\nstart_drv_timers(padapter);\r\npadapter->ledpriv.LedControlHandler(padapter, LED_CTL_NO_LINK);\r\nmutex_unlock(&padapter->mutex_start);\r\nreturn 0;\r\nnetdev_open_error:\r\npadapter->bup = false;\r\nnetif_carrier_off(pnetdev);\r\nnetif_stop_queue(pnetdev);\r\nmutex_unlock(&padapter->mutex_start);\r\nreturn -1;\r\n}\r\nstatic int netdev_close(struct net_device *pnetdev)\r\n{\r\nstruct _adapter *padapter = netdev_priv(pnetdev);\r\npadapter->ledpriv.LedControlHandler(padapter, LED_CTL_POWER_OFF);\r\nmsleep(200);\r\nif (pnetdev) {\r\nif (!netif_queue_stopped(pnetdev))\r\nnetif_stop_queue(pnetdev);\r\n}\r\nr8712_disassoc_cmd(padapter);\r\nr8712_ind_disconnect(padapter);\r\nr8712_free_assoc_resources(padapter);\r\nr8712_free_network_queue(padapter);\r\nreturn 0;\r\n}

static int ac97_analog_prepare(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nunsigned short reg;\r\nsnd_soc_update_bits(codec, AC97_EXTENDED_STATUS, 0x5, 0x1);\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nreg = AC97_PCM_FRONT_DAC_RATE;\r\nelse\r\nreg = AC97_PCM_LR_ADC_RATE;\r\nreturn snd_soc_write(codec, reg, runtime->rate);\r\n}\r\nstatic int ac97_digital_prepare(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nunsigned short reg;\r\nsnd_soc_write(codec, AC97_SPDIF, 0x2002);\r\nsnd_soc_update_bits(codec, AC97_EXTENDED_STATUS, 0x5, 0x5);\r\nreg = AC97_PCM_FRONT_DAC_RATE;\r\nreturn snd_soc_write(codec, reg, runtime->rate);\r\n}\r\nstatic int stac9766_set_bias_level(struct snd_soc_codec *codec,\r\nenum snd_soc_bias_level level)\r\n{\r\nswitch (level) {\r\ncase SND_SOC_BIAS_ON:\r\ncase SND_SOC_BIAS_PREPARE:\r\ncase SND_SOC_BIAS_STANDBY:\r\nsnd_soc_write(codec, AC97_POWERDOWN, 0x0000);\r\nbreak;\r\ncase SND_SOC_BIAS_OFF:\r\nsnd_soc_write(codec, AC97_POWERDOWN, 0xffff);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stac9766_codec_resume(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_ac97 *ac97 = snd_soc_codec_get_drvdata(codec);\r\nreturn snd_ac97_reset(ac97, true, STAC9766_VENDOR_ID,\r\nSTAC9766_VENDOR_ID_MASK);\r\n}\r\nstatic int stac9766_codec_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_ac97 *ac97;\r\nstruct regmap *regmap;\r\nint ret;\r\nac97 = snd_soc_new_ac97_codec(codec, STAC9766_VENDOR_ID,\r\nSTAC9766_VENDOR_ID_MASK);\r\nif (IS_ERR(ac97))\r\nreturn PTR_ERR(ac97);\r\nregmap = regmap_init_ac97(ac97, &stac9766_regmap_config);\r\nif (IS_ERR(regmap)) {\r\nret = PTR_ERR(regmap);\r\ngoto err_free_ac97;\r\n}\r\nsnd_soc_codec_init_regmap(codec, regmap);\r\nsnd_soc_codec_set_drvdata(codec, ac97);\r\nreturn 0;\r\nerr_free_ac97:\r\nsnd_soc_free_ac97_codec(ac97);\r\nreturn ret;\r\n}\r\nstatic int stac9766_codec_remove(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_ac97 *ac97 = snd_soc_codec_get_drvdata(codec);\r\nsnd_soc_codec_exit_regmap(codec);\r\nsnd_soc_free_ac97_codec(ac97);\r\nreturn 0;\r\n}\r\nstatic int stac9766_probe(struct platform_device *pdev)\r\n{\r\nreturn snd_soc_register_codec(&pdev->dev,\r\n&soc_codec_dev_stac9766, stac9766_dai, ARRAY_SIZE(stac9766_dai));\r\n}\r\nstatic int stac9766_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_codec(&pdev->dev);\r\nreturn 0;\r\n}

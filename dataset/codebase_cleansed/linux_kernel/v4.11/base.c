int\r\nnvkm_ltc_tags_alloc(struct nvkm_ltc *ltc, u32 n, struct nvkm_mm_node **pnode)\r\n{\r\nint ret = nvkm_mm_head(&ltc->tags, 0, 1, n, n, 1, pnode);\r\nif (ret)\r\n*pnode = NULL;\r\nreturn ret;\r\n}\r\nvoid\r\nnvkm_ltc_tags_free(struct nvkm_ltc *ltc, struct nvkm_mm_node **pnode)\r\n{\r\nnvkm_mm_free(&ltc->tags, pnode);\r\n}\r\nvoid\r\nnvkm_ltc_tags_clear(struct nvkm_ltc *ltc, u32 first, u32 count)\r\n{\r\nconst u32 limit = first + count - 1;\r\nBUG_ON((first > limit) || (limit >= ltc->num_tags));\r\nmutex_lock(&ltc->subdev.mutex);\r\nltc->func->cbc_clear(ltc, first, limit);\r\nltc->func->cbc_wait(ltc);\r\nmutex_unlock(&ltc->subdev.mutex);\r\n}\r\nint\r\nnvkm_ltc_zbc_color_get(struct nvkm_ltc *ltc, int index, const u32 color[4])\r\n{\r\nmemcpy(ltc->zbc_color[index], color, sizeof(ltc->zbc_color[index]));\r\nltc->func->zbc_clear_color(ltc, index, color);\r\nreturn index;\r\n}\r\nint\r\nnvkm_ltc_zbc_depth_get(struct nvkm_ltc *ltc, int index, const u32 depth)\r\n{\r\nltc->zbc_depth[index] = depth;\r\nltc->func->zbc_clear_depth(ltc, index, depth);\r\nreturn index;\r\n}\r\nvoid\r\nnvkm_ltc_invalidate(struct nvkm_ltc *ltc)\r\n{\r\nif (ltc->func->invalidate)\r\nltc->func->invalidate(ltc);\r\n}\r\nvoid\r\nnvkm_ltc_flush(struct nvkm_ltc *ltc)\r\n{\r\nif (ltc->func->flush)\r\nltc->func->flush(ltc);\r\n}\r\nstatic void\r\nnvkm_ltc_intr(struct nvkm_subdev *subdev)\r\n{\r\nstruct nvkm_ltc *ltc = nvkm_ltc(subdev);\r\nltc->func->intr(ltc);\r\n}\r\nstatic int\r\nnvkm_ltc_oneinit(struct nvkm_subdev *subdev)\r\n{\r\nstruct nvkm_ltc *ltc = nvkm_ltc(subdev);\r\nreturn ltc->func->oneinit(ltc);\r\n}\r\nstatic int\r\nnvkm_ltc_init(struct nvkm_subdev *subdev)\r\n{\r\nstruct nvkm_ltc *ltc = nvkm_ltc(subdev);\r\nint i;\r\nfor (i = ltc->zbc_min; i <= ltc->zbc_max; i++) {\r\nltc->func->zbc_clear_color(ltc, i, ltc->zbc_color[i]);\r\nltc->func->zbc_clear_depth(ltc, i, ltc->zbc_depth[i]);\r\n}\r\nltc->func->init(ltc);\r\nreturn 0;\r\n}\r\nstatic void *\r\nnvkm_ltc_dtor(struct nvkm_subdev *subdev)\r\n{\r\nstruct nvkm_ltc *ltc = nvkm_ltc(subdev);\r\nstruct nvkm_ram *ram = ltc->subdev.device->fb->ram;\r\nnvkm_mm_fini(&ltc->tags);\r\nif (ram)\r\nnvkm_mm_free(&ram->vram, &ltc->tag_ram);\r\nreturn ltc;\r\n}\r\nint\r\nnvkm_ltc_new_(const struct nvkm_ltc_func *func, struct nvkm_device *device,\r\nint index, struct nvkm_ltc **pltc)\r\n{\r\nstruct nvkm_ltc *ltc;\r\nif (!(ltc = *pltc = kzalloc(sizeof(*ltc), GFP_KERNEL)))\r\nreturn -ENOMEM;\r\nnvkm_subdev_ctor(&nvkm_ltc, device, index, &ltc->subdev);\r\nltc->func = func;\r\nltc->zbc_min = 1;\r\nltc->zbc_max = min(func->zbc, NVKM_LTC_MAX_ZBC_CNT) - 1;\r\nreturn 0;\r\n}

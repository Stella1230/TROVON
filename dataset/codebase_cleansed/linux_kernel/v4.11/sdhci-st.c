static inline void st_mmcss_set_static_delay(void __iomem *ioaddr)\r\n{\r\nif (!ioaddr)\r\nreturn;\r\nwritel_relaxed(0x0, ioaddr + ST_TOP_MMC_DLY_CTRL);\r\nwritel_relaxed(ST_TOP_MMC_DLY_MAX,\r\nioaddr + ST_TOP_MMC_TX_CLK_DLY);\r\n}\r\nstatic void st_mmcss_cconfig(struct device_node *np, struct sdhci_host *host)\r\n{\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct mmc_host *mhost = host->mmc;\r\nu32 cconf2, cconf3, cconf4, cconf5;\r\nif (!of_device_is_compatible(np, "st,sdhci-stih407"))\r\nreturn;\r\ncconf2 = ST_MMC_CCONFIG_2_DEFAULT;\r\ncconf3 = ST_MMC_CCONFIG_3_DEFAULT;\r\ncconf4 = ST_MMC_CCONFIG_4_DEFAULT;\r\ncconf5 = ST_MMC_CCONFIG_5_DEFAULT;\r\nwritel_relaxed(ST_MMC_CCONFIG_1_DEFAULT,\r\nhost->ioaddr + ST_MMC_CCONFIG_REG_1);\r\nswitch (mhost->f_max) {\r\ncase 200000000:\r\nclk_set_rate(pltfm_host->clk, mhost->f_max);\r\ncconf2 |= BASE_CLK_FREQ_200;\r\nbreak;\r\ncase 100000000:\r\nclk_set_rate(pltfm_host->clk, mhost->f_max);\r\ncconf2 |= BASE_CLK_FREQ_100;\r\nbreak;\r\ndefault:\r\nclk_set_rate(pltfm_host->clk, 50000000);\r\ncconf2 |= BASE_CLK_FREQ_50;\r\n}\r\nwritel_relaxed(cconf2, host->ioaddr + ST_MMC_CCONFIG_REG_2);\r\nif (!mmc_card_is_removable(mhost))\r\ncconf3 |= ST_MMC_CCONFIG_EMMC_SLOT_TYPE;\r\nelse\r\nwritel_relaxed(ST_MMC_GP_OUTPUT_CD,\r\nhost->ioaddr + ST_MMC_GP_OUTPUT);\r\nif (mhost->caps & MMC_CAP_UHS_SDR50) {\r\ncconf3 |= ST_MMC_CCONFIG_1P8_VOLT;\r\ncconf4 |= ST_MMC_CCONFIG_SDR50;\r\ncconf5 |= ST_MMC_CCONFIG_TUNING_FOR_SDR50;\r\ncconf5 |= RETUNING_TIMER_CNT_MAX;\r\n}\r\nif (mhost->caps & MMC_CAP_UHS_SDR104) {\r\ncconf3 |= ST_MMC_CCONFIG_1P8_VOLT;\r\ncconf4 |= ST_MMC_CCONFIG_SDR104;\r\ncconf5 |= RETUNING_TIMER_CNT_MAX;\r\n}\r\nif (mhost->caps & MMC_CAP_UHS_DDR50)\r\ncconf4 |= ST_MMC_CCONFIG_DDR50;\r\nwritel_relaxed(cconf3, host->ioaddr + ST_MMC_CCONFIG_REG_3);\r\nwritel_relaxed(cconf4, host->ioaddr + ST_MMC_CCONFIG_REG_4);\r\nwritel_relaxed(cconf5, host->ioaddr + ST_MMC_CCONFIG_REG_5);\r\n}\r\nstatic inline void st_mmcss_set_dll(void __iomem *ioaddr)\r\n{\r\nif (!ioaddr)\r\nreturn;\r\nwritel_relaxed(ST_TOP_MMC_DYN_DLY_CONF, ioaddr + ST_TOP_MMC_DLY_CTRL);\r\nwritel_relaxed(ST_TOP_MMC_TX_DLL_STEP_DLY_VALID,\r\nioaddr + ST_TOP_MMC_TX_DLL_STEP_DLY);\r\n}\r\nstatic int st_mmcss_lock_dll(void __iomem *ioaddr)\r\n{\r\nunsigned long curr, value;\r\nunsigned long finish = jiffies + HZ;\r\ndo {\r\ncurr = jiffies;\r\nvalue = readl(ioaddr + ST_MMC_STATUS_R);\r\nif (value & 0x1)\r\nreturn 0;\r\ncpu_relax();\r\n} while (!time_after_eq(curr, finish));\r\nreturn -EBUSY;\r\n}\r\nstatic int sdhci_st_set_dll_for_clock(struct sdhci_host *host)\r\n{\r\nint ret = 0;\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct st_mmc_platform_data *pdata = sdhci_pltfm_priv(pltfm_host);\r\nif (host->clock > CLK_TO_CHECK_DLL_LOCK) {\r\nst_mmcss_set_dll(pdata->top_ioaddr);\r\nret = st_mmcss_lock_dll(host->ioaddr);\r\n}\r\nreturn ret;\r\n}\r\nstatic void sdhci_st_set_uhs_signaling(struct sdhci_host *host,\r\nunsigned int uhs)\r\n{\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct st_mmc_platform_data *pdata = sdhci_pltfm_priv(pltfm_host);\r\nu16 ctrl_2 = sdhci_readw(host, SDHCI_HOST_CONTROL2);\r\nint ret = 0;\r\nctrl_2 &= ~SDHCI_CTRL_UHS_MASK;\r\nswitch (uhs) {\r\ncase MMC_TIMING_UHS_SDR12:\r\nst_mmcss_set_static_delay(pdata->top_ioaddr);\r\nctrl_2 |= SDHCI_CTRL_UHS_SDR12 | SDHCI_CTRL_VDD_180;\r\nbreak;\r\ncase MMC_TIMING_UHS_SDR25:\r\nst_mmcss_set_static_delay(pdata->top_ioaddr);\r\nctrl_2 |= SDHCI_CTRL_UHS_SDR25 | SDHCI_CTRL_VDD_180;\r\nbreak;\r\ncase MMC_TIMING_UHS_SDR50:\r\nst_mmcss_set_static_delay(pdata->top_ioaddr);\r\nctrl_2 |= SDHCI_CTRL_UHS_SDR50 | SDHCI_CTRL_VDD_180;\r\nret = sdhci_st_set_dll_for_clock(host);\r\nbreak;\r\ncase MMC_TIMING_UHS_SDR104:\r\ncase MMC_TIMING_MMC_HS200:\r\nst_mmcss_set_static_delay(pdata->top_ioaddr);\r\nctrl_2 |= SDHCI_CTRL_UHS_SDR104 | SDHCI_CTRL_VDD_180;\r\nret = sdhci_st_set_dll_for_clock(host);\r\nbreak;\r\ncase MMC_TIMING_UHS_DDR50:\r\ncase MMC_TIMING_MMC_DDR52:\r\nst_mmcss_set_static_delay(pdata->top_ioaddr);\r\nctrl_2 |= SDHCI_CTRL_UHS_DDR50 | SDHCI_CTRL_VDD_180;\r\nbreak;\r\n}\r\nif (ret)\r\ndev_warn(mmc_dev(host->mmc), "Error setting dll for clock "\r\n"(uhs %d)\n", uhs);\r\ndev_dbg(mmc_dev(host->mmc), "uhs %d, ctrl_2 %04X\n", uhs, ctrl_2);\r\nsdhci_writew(host, ctrl_2, SDHCI_HOST_CONTROL2);\r\n}\r\nstatic u32 sdhci_st_readl(struct sdhci_host *host, int reg)\r\n{\r\nu32 ret;\r\nswitch (reg) {\r\ncase SDHCI_CAPABILITIES:\r\nret = readl_relaxed(host->ioaddr + reg);\r\nret &= ~SDHCI_CAN_VDD_300;\r\nbreak;\r\ndefault:\r\nret = readl_relaxed(host->ioaddr + reg);\r\n}\r\nreturn ret;\r\n}\r\nstatic int sdhci_st_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct sdhci_host *host;\r\nstruct st_mmc_platform_data *pdata;\r\nstruct sdhci_pltfm_host *pltfm_host;\r\nstruct clk *clk, *icnclk;\r\nint ret = 0;\r\nu16 host_version;\r\nstruct resource *res;\r\nstruct reset_control *rstc;\r\nclk = devm_clk_get(&pdev->dev, "mmc");\r\nif (IS_ERR(clk)) {\r\ndev_err(&pdev->dev, "Peripheral clk not found\n");\r\nreturn PTR_ERR(clk);\r\n}\r\nicnclk = devm_clk_get(&pdev->dev, "icn");\r\nif (IS_ERR(icnclk))\r\nicnclk = NULL;\r\nrstc = devm_reset_control_get(&pdev->dev, NULL);\r\nif (IS_ERR(rstc))\r\nrstc = NULL;\r\nelse\r\nreset_control_deassert(rstc);\r\nhost = sdhci_pltfm_init(pdev, &sdhci_st_pdata, sizeof(*pdata));\r\nif (IS_ERR(host)) {\r\ndev_err(&pdev->dev, "Failed sdhci_pltfm_init\n");\r\nret = PTR_ERR(host);\r\ngoto err_pltfm_init;\r\n}\r\npltfm_host = sdhci_priv(host);\r\npdata = sdhci_pltfm_priv(pltfm_host);\r\npdata->rstc = rstc;\r\nret = mmc_of_parse(host->mmc);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed mmc_of_parse\n");\r\ngoto err_of;\r\n}\r\nclk_prepare_enable(clk);\r\nclk_prepare_enable(icnclk);\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM,\r\n"top-mmc-delay");\r\npdata->top_ioaddr = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(pdata->top_ioaddr)) {\r\ndev_warn(&pdev->dev, "FlashSS Top Dly registers not available");\r\npdata->top_ioaddr = NULL;\r\n}\r\npltfm_host->clk = clk;\r\npdata->icnclk = icnclk;\r\nst_mmcss_cconfig(np, host);\r\nret = sdhci_add_host(host);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed sdhci_add_host\n");\r\ngoto err_out;\r\n}\r\nplatform_set_drvdata(pdev, host);\r\nhost_version = readw_relaxed((host->ioaddr + SDHCI_HOST_VERSION));\r\ndev_info(&pdev->dev, "SDHCI ST Initialised: Host Version: 0x%x Vendor Version 0x%x\n",\r\n((host_version & SDHCI_SPEC_VER_MASK) >> SDHCI_SPEC_VER_SHIFT),\r\n((host_version & SDHCI_VENDOR_VER_MASK) >>\r\nSDHCI_VENDOR_VER_SHIFT));\r\nreturn 0;\r\nerr_out:\r\nclk_disable_unprepare(icnclk);\r\nclk_disable_unprepare(clk);\r\nerr_of:\r\nsdhci_pltfm_free(pdev);\r\nerr_pltfm_init:\r\nif (rstc)\r\nreset_control_assert(rstc);\r\nreturn ret;\r\n}\r\nstatic int sdhci_st_remove(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct st_mmc_platform_data *pdata = sdhci_pltfm_priv(pltfm_host);\r\nstruct reset_control *rstc = pdata->rstc;\r\nint ret;\r\nret = sdhci_pltfm_unregister(pdev);\r\nclk_disable_unprepare(pdata->icnclk);\r\nif (rstc)\r\nreset_control_assert(rstc);\r\nreturn ret;\r\n}\r\nstatic int sdhci_st_suspend(struct device *dev)\r\n{\r\nstruct sdhci_host *host = dev_get_drvdata(dev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct st_mmc_platform_data *pdata = sdhci_pltfm_priv(pltfm_host);\r\nint ret = sdhci_suspend_host(host);\r\nif (ret)\r\ngoto out;\r\nif (pdata->rstc)\r\nreset_control_assert(pdata->rstc);\r\nclk_disable_unprepare(pdata->icnclk);\r\nclk_disable_unprepare(pltfm_host->clk);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int sdhci_st_resume(struct device *dev)\r\n{\r\nstruct sdhci_host *host = dev_get_drvdata(dev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct st_mmc_platform_data *pdata = sdhci_pltfm_priv(pltfm_host);\r\nstruct device_node *np = dev->of_node;\r\nclk_prepare_enable(pltfm_host->clk);\r\nclk_prepare_enable(pdata->icnclk);\r\nif (pdata->rstc)\r\nreset_control_deassert(pdata->rstc);\r\nst_mmcss_cconfig(np, host);\r\nreturn sdhci_resume_host(host);\r\n}

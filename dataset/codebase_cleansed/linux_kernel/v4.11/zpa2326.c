static const struct zpa2326_frequency *zpa2326_highest_frequency(void)\r\n{\r\nreturn &zpa2326_sampling_frequencies[\r\nARRAY_SIZE(zpa2326_sampling_frequencies) - 1];\r\n}\r\nbool zpa2326_isreg_writeable(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase ZPA2326_REF_P_XL_REG:\r\ncase ZPA2326_REF_P_L_REG:\r\ncase ZPA2326_REF_P_H_REG:\r\ncase ZPA2326_RES_CONF_REG:\r\ncase ZPA2326_CTRL_REG0_REG:\r\ncase ZPA2326_CTRL_REG1_REG:\r\ncase ZPA2326_CTRL_REG2_REG:\r\ncase ZPA2326_CTRL_REG3_REG:\r\ncase ZPA2326_THS_P_LOW_REG:\r\ncase ZPA2326_THS_P_HIGH_REG:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nbool zpa2326_isreg_readable(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase ZPA2326_REF_P_XL_REG:\r\ncase ZPA2326_REF_P_L_REG:\r\ncase ZPA2326_REF_P_H_REG:\r\ncase ZPA2326_DEVICE_ID_REG:\r\ncase ZPA2326_RES_CONF_REG:\r\ncase ZPA2326_CTRL_REG0_REG:\r\ncase ZPA2326_CTRL_REG1_REG:\r\ncase ZPA2326_CTRL_REG2_REG:\r\ncase ZPA2326_CTRL_REG3_REG:\r\ncase ZPA2326_INT_SOURCE_REG:\r\ncase ZPA2326_THS_P_LOW_REG:\r\ncase ZPA2326_THS_P_HIGH_REG:\r\ncase ZPA2326_STATUS_REG:\r\ncase ZPA2326_PRESS_OUT_XL_REG:\r\ncase ZPA2326_PRESS_OUT_L_REG:\r\ncase ZPA2326_PRESS_OUT_H_REG:\r\ncase ZPA2326_TEMP_OUT_L_REG:\r\ncase ZPA2326_TEMP_OUT_H_REG:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nbool zpa2326_isreg_precious(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase ZPA2326_INT_SOURCE_REG:\r\ncase ZPA2326_PRESS_OUT_H_REG:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic int zpa2326_enable_device(const struct iio_dev *indio_dev)\r\n{\r\nint err;\r\nerr = regmap_write(((struct zpa2326_private *)\r\niio_priv(indio_dev))->regmap,\r\nZPA2326_CTRL_REG0_REG, ZPA2326_CTRL_REG0_ENABLE);\r\nif (err) {\r\nzpa2326_err(indio_dev, "failed to enable device (%d)", err);\r\nreturn err;\r\n}\r\nzpa2326_dbg(indio_dev, "enabled");\r\nreturn 0;\r\n}\r\nstatic int zpa2326_sleep(const struct iio_dev *indio_dev)\r\n{\r\nint err;\r\nerr = regmap_write(((struct zpa2326_private *)\r\niio_priv(indio_dev))->regmap,\r\nZPA2326_CTRL_REG0_REG, 0);\r\nif (err) {\r\nzpa2326_err(indio_dev, "failed to sleep (%d)", err);\r\nreturn err;\r\n}\r\nzpa2326_dbg(indio_dev, "sleeping");\r\nreturn 0;\r\n}\r\nstatic int zpa2326_reset_device(const struct iio_dev *indio_dev)\r\n{\r\nint err;\r\nerr = regmap_write(((struct zpa2326_private *)\r\niio_priv(indio_dev))->regmap,\r\nZPA2326_CTRL_REG2_REG, ZPA2326_CTRL_REG2_SWRESET);\r\nif (err) {\r\nzpa2326_err(indio_dev, "failed to reset device (%d)", err);\r\nreturn err;\r\n}\r\nusleep_range(ZPA2326_TPUP_USEC_MIN, ZPA2326_TPUP_USEC_MAX);\r\nzpa2326_dbg(indio_dev, "reset");\r\nreturn 0;\r\n}\r\nstatic int zpa2326_start_oneshot(const struct iio_dev *indio_dev)\r\n{\r\nint err;\r\nerr = regmap_write(((struct zpa2326_private *)\r\niio_priv(indio_dev))->regmap,\r\nZPA2326_CTRL_REG0_REG,\r\nZPA2326_CTRL_REG0_ENABLE |\r\nZPA2326_CTRL_REG0_ONE_SHOT);\r\nif (err) {\r\nzpa2326_err(indio_dev, "failed to start one shot cycle (%d)",\r\nerr);\r\nreturn err;\r\n}\r\nzpa2326_dbg(indio_dev, "one shot cycle started");\r\nreturn 0;\r\n}\r\nstatic int zpa2326_power_on(const struct iio_dev *indio_dev,\r\nconst struct zpa2326_private *private)\r\n{\r\nint err;\r\nerr = regulator_enable(private->vref);\r\nif (err)\r\nreturn err;\r\nerr = regulator_enable(private->vdd);\r\nif (err)\r\ngoto vref;\r\nzpa2326_dbg(indio_dev, "powered on");\r\nerr = zpa2326_enable_device(indio_dev);\r\nif (err)\r\ngoto vdd;\r\nerr = zpa2326_reset_device(indio_dev);\r\nif (err)\r\ngoto sleep;\r\nreturn 0;\r\nsleep:\r\nzpa2326_sleep(indio_dev);\r\nvdd:\r\nregulator_disable(private->vdd);\r\nvref:\r\nregulator_disable(private->vref);\r\nzpa2326_dbg(indio_dev, "powered off");\r\nreturn err;\r\n}\r\nstatic void zpa2326_power_off(const struct iio_dev *indio_dev,\r\nconst struct zpa2326_private *private)\r\n{\r\nregulator_disable(private->vdd);\r\nregulator_disable(private->vref);\r\nzpa2326_dbg(indio_dev, "powered off");\r\n}\r\nstatic int zpa2326_config_oneshot(const struct iio_dev *indio_dev,\r\nint irq)\r\n{\r\nstruct regmap *regs = ((struct zpa2326_private *)\r\niio_priv(indio_dev))->regmap;\r\nconst struct zpa2326_frequency *freq = zpa2326_highest_frequency();\r\nint err;\r\nerr = regmap_write(regs, ZPA2326_CTRL_REG3_REG, freq->odr);\r\nif (err)\r\nreturn err;\r\nif (irq > 0) {\r\nerr = regmap_write(regs, ZPA2326_CTRL_REG1_REG,\r\n(u8)~ZPA2326_CTRL_REG1_MASK_DATA_READY);\r\nif (err) {\r\ndev_err(indio_dev->dev.parent,\r\n"failed to setup one shot mode (%d)", err);\r\nreturn err;\r\n}\r\n}\r\nzpa2326_dbg(indio_dev, "one shot mode setup @%dHz", freq->hz);\r\nreturn 0;\r\n}\r\nstatic int zpa2326_clear_fifo(const struct iio_dev *indio_dev,\r\nunsigned int min_count)\r\n{\r\nstruct regmap *regs = ((struct zpa2326_private *)\r\niio_priv(indio_dev))->regmap;\r\nint err;\r\nunsigned int val;\r\nif (!min_count) {\r\nerr = regmap_read(regs, ZPA2326_STATUS_REG, &val);\r\nif (err < 0)\r\ngoto err;\r\nif (val & ZPA2326_STATUS_FIFO_E)\r\nreturn 0;\r\n}\r\ndo {\r\nerr = regmap_read(regs, ZPA2326_PRESS_OUT_H_REG, &val);\r\nif (err < 0)\r\ngoto err;\r\nif (min_count) {\r\nmin_count--;\r\ncontinue;\r\n}\r\nerr = regmap_read(regs, ZPA2326_STATUS_REG, &val);\r\nif (err < 0)\r\ngoto err;\r\n} while (!(val & ZPA2326_STATUS_FIFO_E));\r\nzpa2326_dbg(indio_dev, "FIFO cleared");\r\nreturn 0;\r\nerr:\r\nzpa2326_err(indio_dev, "failed to clear FIFO (%d)", err);\r\nreturn err;\r\n}\r\nstatic int zpa2326_dequeue_pressure(const struct iio_dev *indio_dev,\r\nu32 *pressure)\r\n{\r\nstruct regmap *regs = ((struct zpa2326_private *)\r\niio_priv(indio_dev))->regmap;\r\nunsigned int val;\r\nint err;\r\nint cleared = -1;\r\nerr = regmap_read(regs, ZPA2326_STATUS_REG, &val);\r\nif (err < 0)\r\nreturn err;\r\n*pressure = 0;\r\nif (val & ZPA2326_STATUS_P_OR) {\r\nzpa2326_warn(indio_dev, "FIFO overflow");\r\nerr = regmap_bulk_read(regs, ZPA2326_PRESS_OUT_XL_REG, pressure,\r\n3);\r\nif (err)\r\nreturn err;\r\n#define ZPA2326_FIFO_DEPTH (16U)\r\nreturn zpa2326_clear_fifo(indio_dev, ZPA2326_FIFO_DEPTH - 1);\r\n}\r\ndo {\r\nerr = regmap_bulk_read(regs, ZPA2326_PRESS_OUT_XL_REG, pressure,\r\n3);\r\nif (err)\r\nreturn err;\r\nerr = regmap_read(regs, ZPA2326_STATUS_REG, &val);\r\nif (err < 0)\r\nreturn err;\r\ncleared++;\r\n} while (!(val & ZPA2326_STATUS_FIFO_E));\r\nif (cleared)\r\nzpa2326_dbg(indio_dev, "cleared %d FIFO entries", cleared);\r\nreturn 0;\r\n}\r\nstatic int zpa2326_fill_sample_buffer(struct iio_dev *indio_dev,\r\nconst struct zpa2326_private *private)\r\n{\r\nstruct {\r\nu32 pressure;\r\nu16 temperature;\r\nu64 timestamp;\r\n} sample;\r\nint err;\r\nif (test_bit(0, indio_dev->active_scan_mask)) {\r\nerr = zpa2326_dequeue_pressure(indio_dev, &sample.pressure);\r\nif (err) {\r\nzpa2326_warn(indio_dev, "failed to fetch pressure (%d)",\r\nerr);\r\nreturn err;\r\n}\r\n}\r\nif (test_bit(1, indio_dev->active_scan_mask)) {\r\nerr = regmap_bulk_read(private->regmap, ZPA2326_TEMP_OUT_L_REG,\r\n&sample.temperature, 2);\r\nif (err) {\r\nzpa2326_warn(indio_dev,\r\n"failed to fetch temperature (%d)", err);\r\nreturn err;\r\n}\r\n}\r\nzpa2326_dbg(indio_dev, "filling raw samples buffer");\r\niio_push_to_buffers_with_timestamp(indio_dev, &sample,\r\nprivate->timestamp);\r\nreturn 0;\r\n}\r\nstatic int zpa2326_runtime_suspend(struct device *parent)\r\n{\r\nconst struct iio_dev *indio_dev = dev_get_drvdata(parent);\r\nif (pm_runtime_autosuspend_expiration(parent))\r\nreturn -EAGAIN;\r\nzpa2326_power_off(indio_dev, iio_priv(indio_dev));\r\nreturn 0;\r\n}\r\nstatic int zpa2326_runtime_resume(struct device *parent)\r\n{\r\nconst struct iio_dev *indio_dev = dev_get_drvdata(parent);\r\nreturn zpa2326_power_on(indio_dev, iio_priv(indio_dev));\r\n}\r\nstatic int zpa2326_resume(const struct iio_dev *indio_dev)\r\n{\r\nint err;\r\nerr = pm_runtime_get_sync(indio_dev->dev.parent);\r\nif (err < 0)\r\nreturn err;\r\nif (err > 0) {\r\nzpa2326_enable_device(indio_dev);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void zpa2326_suspend(struct iio_dev *indio_dev)\r\n{\r\nstruct device *parent = indio_dev->dev.parent;\r\nzpa2326_sleep(indio_dev);\r\npm_runtime_mark_last_busy(parent);\r\npm_runtime_put_autosuspend(parent);\r\n}\r\nstatic void zpa2326_init_runtime(struct device *parent)\r\n{\r\npm_runtime_get_noresume(parent);\r\npm_runtime_set_active(parent);\r\npm_runtime_enable(parent);\r\npm_runtime_set_autosuspend_delay(parent, 1000);\r\npm_runtime_use_autosuspend(parent);\r\npm_runtime_mark_last_busy(parent);\r\npm_runtime_put_autosuspend(parent);\r\n}\r\nstatic void zpa2326_fini_runtime(struct device *parent)\r\n{\r\npm_runtime_disable(parent);\r\npm_runtime_set_suspended(parent);\r\n}\r\nstatic int zpa2326_resume(const struct iio_dev *indio_dev)\r\n{\r\nzpa2326_enable_device(indio_dev);\r\nreturn 0;\r\n}\r\nstatic void zpa2326_suspend(struct iio_dev *indio_dev)\r\n{\r\nzpa2326_sleep(indio_dev);\r\n}\r\nstatic irqreturn_t zpa2326_handle_irq(int irq, void *data)\r\n{\r\nstruct iio_dev *indio_dev = (struct iio_dev *)data;\r\nif (iio_buffer_enabled(indio_dev)) {\r\n((struct zpa2326_private *)\r\niio_priv(indio_dev))->timestamp = iio_get_time_ns(indio_dev);\r\n}\r\nreturn IRQ_WAKE_THREAD;\r\n}\r\nstatic irqreturn_t zpa2326_handle_threaded_irq(int irq, void *data)\r\n{\r\nstruct iio_dev *indio_dev = (struct iio_dev *)data;\r\nstruct zpa2326_private *priv = iio_priv(indio_dev);\r\nunsigned int val;\r\nbool cont;\r\nirqreturn_t ret = IRQ_NONE;\r\ncont = (iio_buffer_enabled(indio_dev) &&\r\niio_trigger_using_own(indio_dev));\r\npriv->result = regmap_read(priv->regmap, ZPA2326_INT_SOURCE_REG, &val);\r\nif (priv->result < 0) {\r\nif (cont)\r\nreturn IRQ_NONE;\r\ngoto complete;\r\n}\r\nif (!(val & ZPA2326_INT_SOURCE_DATA_READY)) {\r\nzpa2326_warn(indio_dev, "unexpected interrupt status %02x",\r\nval);\r\nif (cont)\r\nreturn IRQ_NONE;\r\npriv->result = -ENODATA;\r\ngoto complete;\r\n}\r\niio_trigger_poll_chained(priv->trigger);\r\nif (cont)\r\nreturn IRQ_HANDLED;\r\nret = IRQ_HANDLED;\r\ncomplete:\r\ncomplete(&priv->data_ready);\r\nreturn ret;\r\n}\r\nstatic int zpa2326_wait_oneshot_completion(const struct iio_dev *indio_dev,\r\nstruct zpa2326_private *private)\r\n{\r\nint ret;\r\nunsigned int val;\r\nzpa2326_dbg(indio_dev, "waiting for one shot completion interrupt");\r\nret = wait_for_completion_interruptible_timeout(\r\n&private->data_ready, ZPA2326_CONVERSION_JIFFIES);\r\nif (ret > 0)\r\nreturn private->result;\r\nregmap_read(private->regmap, ZPA2326_INT_SOURCE_REG, &val);\r\nif (!ret)\r\nret = -ETIME;\r\nif (ret != -ERESTARTSYS)\r\nzpa2326_warn(indio_dev, "no one shot interrupt occurred (%d)",\r\nret);\r\nreturn ret;\r\n}\r\nstatic int zpa2326_init_managed_irq(struct device *parent,\r\nstruct iio_dev *indio_dev,\r\nstruct zpa2326_private *private,\r\nint irq)\r\n{\r\nint err;\r\nprivate->irq = irq;\r\nif (irq <= 0) {\r\ndev_info(parent, "no interrupt found, running in polling mode");\r\nreturn 0;\r\n}\r\ninit_completion(&private->data_ready);\r\nerr = devm_request_threaded_irq(parent, irq, zpa2326_handle_irq,\r\nzpa2326_handle_threaded_irq,\r\nIRQF_TRIGGER_RISING | IRQF_ONESHOT,\r\ndev_name(parent), indio_dev);\r\nif (err) {\r\ndev_err(parent, "failed to request interrupt %d (%d)", irq,\r\nerr);\r\nreturn err;\r\n}\r\ndev_info(parent, "using interrupt %d", irq);\r\nreturn 0;\r\n}\r\nstatic int zpa2326_poll_oneshot_completion(const struct iio_dev *indio_dev)\r\n{\r\nunsigned long tmout = jiffies + ZPA2326_CONVERSION_JIFFIES;\r\nstruct regmap *regs = ((struct zpa2326_private *)\r\niio_priv(indio_dev))->regmap;\r\nunsigned int val;\r\nint err;\r\nzpa2326_dbg(indio_dev, "polling for one shot completion");\r\nif (msleep_interruptible(100))\r\nreturn -ERESTARTSYS;\r\nwhile (true) {\r\nerr = regmap_read(regs, ZPA2326_CTRL_REG0_REG, &val);\r\nif (err < 0)\r\ngoto err;\r\nif (!(val & ZPA2326_CTRL_REG0_ONE_SHOT))\r\nbreak;\r\nif (time_after(jiffies, tmout)) {\r\nerr = -ETIME;\r\ngoto err;\r\n}\r\nusleep_range(10000, 20000);\r\n}\r\nerr = regmap_read(regs, ZPA2326_STATUS_REG, &val);\r\nif (err < 0)\r\ngoto err;\r\nif (!(val & ZPA2326_STATUS_P_DA)) {\r\nerr = -ENODATA;\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\nzpa2326_warn(indio_dev, "failed to poll one shot completion (%d)", err);\r\nreturn err;\r\n}\r\nstatic int zpa2326_fetch_raw_sample(const struct iio_dev *indio_dev,\r\nenum iio_chan_type type,\r\nint *value)\r\n{\r\nstruct regmap *regs = ((struct zpa2326_private *)\r\niio_priv(indio_dev))->regmap;\r\nint err;\r\nswitch (type) {\r\ncase IIO_PRESSURE:\r\nzpa2326_dbg(indio_dev, "fetching raw pressure sample");\r\nerr = regmap_bulk_read(regs, ZPA2326_PRESS_OUT_XL_REG, value,\r\n3);\r\nif (err) {\r\nzpa2326_warn(indio_dev, "failed to fetch pressure (%d)",\r\nerr);\r\nreturn err;\r\n}\r\n*value = (((u8 *)value)[2] << 16) | (((u8 *)value)[1] << 8) |\r\n((u8 *)value)[0];\r\nreturn IIO_VAL_INT;\r\ncase IIO_TEMP:\r\nzpa2326_dbg(indio_dev, "fetching raw temperature sample");\r\nerr = regmap_bulk_read(regs, ZPA2326_TEMP_OUT_L_REG, value, 2);\r\nif (err) {\r\nzpa2326_warn(indio_dev,\r\n"failed to fetch temperature (%d)", err);\r\nreturn err;\r\n}\r\n*value = (int)le16_to_cpup((__le16 *)value);\r\nreturn IIO_VAL_INT;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int zpa2326_sample_oneshot(struct iio_dev *indio_dev,\r\nenum iio_chan_type type,\r\nint *value)\r\n{\r\nint ret;\r\nstruct zpa2326_private *priv;\r\nret = iio_device_claim_direct_mode(indio_dev);\r\nif (ret)\r\nreturn ret;\r\nret = zpa2326_resume(indio_dev);\r\nif (ret < 0)\r\ngoto release;\r\npriv = iio_priv(indio_dev);\r\nif (ret > 0) {\r\nif (type == IIO_PRESSURE) {\r\nret = zpa2326_clear_fifo(indio_dev, 0);\r\nif (ret)\r\ngoto suspend;\r\n}\r\n} else {\r\nret = zpa2326_config_oneshot(indio_dev, priv->irq);\r\nif (ret)\r\ngoto suspend;\r\n}\r\nret = zpa2326_start_oneshot(indio_dev);\r\nif (ret)\r\ngoto suspend;\r\nif (priv->irq > 0)\r\nret = zpa2326_wait_oneshot_completion(indio_dev, priv);\r\nelse\r\nret = zpa2326_poll_oneshot_completion(indio_dev);\r\nif (ret)\r\ngoto suspend;\r\nret = zpa2326_fetch_raw_sample(indio_dev, type, value);\r\nsuspend:\r\nzpa2326_suspend(indio_dev);\r\nrelease:\r\niio_device_release_direct_mode(indio_dev);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t zpa2326_trigger_handler(int irq, void *data)\r\n{\r\nstruct iio_dev *indio_dev = ((struct iio_poll_func *)\r\ndata)->indio_dev;\r\nstruct zpa2326_private *priv = iio_priv(indio_dev);\r\nbool cont;\r\ncont = iio_trigger_using_own(indio_dev);\r\nif (!cont) {\r\nif (zpa2326_start_oneshot(indio_dev))\r\ngoto out;\r\nif (priv->irq <= 0) {\r\nif (zpa2326_poll_oneshot_completion(indio_dev))\r\ngoto out;\r\npriv->timestamp = iio_get_time_ns(indio_dev);\r\n} else {\r\nif (zpa2326_wait_oneshot_completion(indio_dev, priv))\r\ngoto out;\r\n}\r\n}\r\nzpa2326_fill_sample_buffer(indio_dev, priv);\r\nout:\r\nif (!cont)\r\nzpa2326_sleep(indio_dev);\r\niio_trigger_notify_done(indio_dev->trig);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int zpa2326_preenable_buffer(struct iio_dev *indio_dev)\r\n{\r\nint ret = zpa2326_resume(indio_dev);\r\nif (ret < 0)\r\nreturn ret;\r\n((struct zpa2326_private *)\r\niio_priv(indio_dev))->waken = iio_priv(indio_dev);\r\nreturn 0;\r\n}\r\nstatic int zpa2326_postenable_buffer(struct iio_dev *indio_dev)\r\n{\r\nconst struct zpa2326_private *priv = iio_priv(indio_dev);\r\nint err;\r\nif (!priv->waken) {\r\nerr = zpa2326_clear_fifo(indio_dev, 0);\r\nif (err)\r\ngoto err;\r\n}\r\nif (!iio_trigger_using_own(indio_dev) && priv->waken) {\r\nerr = zpa2326_config_oneshot(indio_dev, priv->irq);\r\nif (err)\r\ngoto err;\r\n}\r\nerr = iio_triggered_buffer_postenable(indio_dev);\r\nif (err)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\nzpa2326_err(indio_dev, "failed to enable buffering (%d)", err);\r\nreturn err;\r\n}\r\nstatic int zpa2326_postdisable_buffer(struct iio_dev *indio_dev)\r\n{\r\nzpa2326_suspend(indio_dev);\r\nreturn 0;\r\n}\r\nstatic int zpa2326_set_trigger_state(struct iio_trigger *trig, bool state)\r\n{\r\nconst struct iio_dev *indio_dev = dev_get_drvdata(\r\ntrig->dev.parent);\r\nconst struct zpa2326_private *priv = iio_priv(indio_dev);\r\nint err;\r\nif (!state) {\r\nunsigned int val;\r\ndisable_irq(priv->irq);\r\nerr = regmap_write(priv->regmap, ZPA2326_CTRL_REG3_REG,\r\nzpa2326_highest_frequency()->odr);\r\nif (err)\r\nreturn err;\r\nerr = regmap_read(priv->regmap, ZPA2326_INT_SOURCE_REG, &val);\r\nif (err < 0)\r\nreturn err;\r\nenable_irq(priv->irq);\r\nzpa2326_dbg(indio_dev, "continuous mode stopped");\r\n} else {\r\nif (priv->waken) {\r\nerr = regmap_write(priv->regmap, ZPA2326_CTRL_REG1_REG,\r\n(u8)\r\n~ZPA2326_CTRL_REG1_MASK_DATA_READY);\r\nif (err)\r\nreturn err;\r\n}\r\nerr = regmap_write(priv->regmap, ZPA2326_CTRL_REG3_REG,\r\nZPA2326_CTRL_REG3_ENABLE_MEAS |\r\npriv->frequency->odr);\r\nif (err)\r\nreturn err;\r\nzpa2326_dbg(indio_dev, "continuous mode setup @%dHz",\r\npriv->frequency->hz);\r\n}\r\nreturn 0;\r\n}\r\nstatic int zpa2326_init_managed_trigger(struct device *parent,\r\nstruct iio_dev *indio_dev,\r\nstruct zpa2326_private *private,\r\nint irq)\r\n{\r\nstruct iio_trigger *trigger;\r\nint ret;\r\nif (irq <= 0)\r\nreturn 0;\r\ntrigger = devm_iio_trigger_alloc(parent, "%s-dev%d",\r\nindio_dev->name, indio_dev->id);\r\nif (!trigger)\r\nreturn -ENOMEM;\r\ntrigger->dev.parent = parent;\r\ntrigger->ops = &zpa2326_trigger_ops;\r\nprivate->trigger = trigger;\r\nret = devm_iio_trigger_register(parent, trigger);\r\nif (ret)\r\ndev_err(parent, "failed to register hardware trigger (%d)",\r\nret);\r\nreturn ret;\r\n}\r\nstatic int zpa2326_get_frequency(const struct iio_dev *indio_dev)\r\n{\r\nreturn ((struct zpa2326_private *)iio_priv(indio_dev))->frequency->hz;\r\n}\r\nstatic int zpa2326_set_frequency(struct iio_dev *indio_dev, int hz)\r\n{\r\nstruct zpa2326_private *priv = iio_priv(indio_dev);\r\nint freq;\r\nint err;\r\nfor (freq = 0; freq < ARRAY_SIZE(zpa2326_sampling_frequencies); freq++)\r\nif (zpa2326_sampling_frequencies[freq].hz == hz)\r\nbreak;\r\nif (freq == ARRAY_SIZE(zpa2326_sampling_frequencies))\r\nreturn -EINVAL;\r\nerr = iio_device_claim_direct_mode(indio_dev);\r\nif (err)\r\nreturn err;\r\npriv->frequency = &zpa2326_sampling_frequencies[freq];\r\niio_device_release_direct_mode(indio_dev);\r\nreturn 0;\r\n}\r\nstatic int zpa2326_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val,\r\nint *val2,\r\nlong mask)\r\n{\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nreturn zpa2326_sample_oneshot(indio_dev, chan->type, val);\r\ncase IIO_CHAN_INFO_SCALE:\r\nswitch (chan->type) {\r\ncase IIO_PRESSURE:\r\n*val = 1;\r\n*val2 = 64000;\r\nreturn IIO_VAL_FRACTIONAL;\r\ncase IIO_TEMP:\r\n*val = 6;\r\n*val2 = 490000;\r\nreturn IIO_VAL_INT_PLUS_MICRO;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ncase IIO_CHAN_INFO_OFFSET:\r\nswitch (chan->type) {\r\ncase IIO_TEMP:\r\n*val = -17683000;\r\n*val2 = 649;\r\nreturn IIO_VAL_FRACTIONAL;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ncase IIO_CHAN_INFO_SAMP_FREQ:\r\n*val = zpa2326_get_frequency(indio_dev);\r\nreturn IIO_VAL_INT;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int zpa2326_write_raw(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan,\r\nint val,\r\nint val2,\r\nlong mask)\r\n{\r\nif ((mask != IIO_CHAN_INFO_SAMP_FREQ) || val2)\r\nreturn -EINVAL;\r\nreturn zpa2326_set_frequency(indio_dev, val);\r\n}\r\nstatic struct iio_dev *zpa2326_create_managed_iiodev(struct device *device,\r\nconst char *name,\r\nstruct regmap *regmap)\r\n{\r\nstruct iio_dev *indio_dev;\r\nindio_dev = devm_iio_device_alloc(device,\r\nsizeof(struct zpa2326_private));\r\nif (!indio_dev)\r\nreturn NULL;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->dev.parent = device;\r\nindio_dev->channels = zpa2326_channels;\r\nindio_dev->num_channels = ARRAY_SIZE(zpa2326_channels);\r\nindio_dev->name = name;\r\nindio_dev->info = &zpa2326_info;\r\nreturn indio_dev;\r\n}\r\nint zpa2326_probe(struct device *parent,\r\nconst char *name,\r\nint irq,\r\nunsigned int hwid,\r\nstruct regmap *regmap)\r\n{\r\nstruct iio_dev *indio_dev;\r\nstruct zpa2326_private *priv;\r\nint err;\r\nunsigned int id;\r\nindio_dev = zpa2326_create_managed_iiodev(parent, name, regmap);\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\npriv = iio_priv(indio_dev);\r\npriv->vref = devm_regulator_get(parent, "vref");\r\nif (IS_ERR(priv->vref))\r\nreturn PTR_ERR(priv->vref);\r\npriv->vdd = devm_regulator_get(parent, "vdd");\r\nif (IS_ERR(priv->vdd))\r\nreturn PTR_ERR(priv->vdd);\r\npriv->frequency = zpa2326_highest_frequency();\r\npriv->regmap = regmap;\r\nerr = devm_iio_triggered_buffer_setup(parent, indio_dev, NULL,\r\nzpa2326_trigger_handler,\r\n&zpa2326_buffer_setup_ops);\r\nif (err)\r\nreturn err;\r\nerr = zpa2326_init_managed_trigger(parent, indio_dev, priv, irq);\r\nif (err)\r\nreturn err;\r\nerr = zpa2326_init_managed_irq(parent, indio_dev, priv, irq);\r\nif (err)\r\nreturn err;\r\nerr = zpa2326_power_on(indio_dev, priv);\r\nif (err)\r\nreturn err;\r\nerr = regmap_read(regmap, ZPA2326_DEVICE_ID_REG, &id);\r\nif (err)\r\ngoto sleep;\r\nif (id != hwid) {\r\ndev_err(parent, "found device with unexpected id %02x", id);\r\nerr = -ENODEV;\r\ngoto sleep;\r\n}\r\nerr = zpa2326_config_oneshot(indio_dev, irq);\r\nif (err)\r\ngoto sleep;\r\nerr = zpa2326_sleep(indio_dev);\r\nif (err)\r\ngoto poweroff;\r\ndev_set_drvdata(parent, indio_dev);\r\nzpa2326_init_runtime(parent);\r\nerr = iio_device_register(indio_dev);\r\nif (err) {\r\nzpa2326_fini_runtime(parent);\r\ngoto poweroff;\r\n}\r\nreturn 0;\r\nsleep:\r\nzpa2326_sleep(indio_dev);\r\npoweroff:\r\nzpa2326_power_off(indio_dev, priv);\r\nreturn err;\r\n}\r\nvoid zpa2326_remove(const struct device *parent)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(parent);\r\niio_device_unregister(indio_dev);\r\nzpa2326_fini_runtime(indio_dev->dev.parent);\r\nzpa2326_sleep(indio_dev);\r\nzpa2326_power_off(indio_dev, iio_priv(indio_dev));\r\n}

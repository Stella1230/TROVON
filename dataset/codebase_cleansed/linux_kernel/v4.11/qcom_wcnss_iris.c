int qcom_iris_enable(struct qcom_iris *iris)\r\n{\r\nint ret;\r\nret = regulator_bulk_enable(iris->num_vregs, iris->vregs);\r\nif (ret)\r\nreturn ret;\r\nret = clk_prepare_enable(iris->xo_clk);\r\nif (ret) {\r\ndev_err(iris->dev, "failed to enable xo clk\n");\r\ngoto disable_regulators;\r\n}\r\nreturn 0;\r\ndisable_regulators:\r\nregulator_bulk_disable(iris->num_vregs, iris->vregs);\r\nreturn ret;\r\n}\r\nvoid qcom_iris_disable(struct qcom_iris *iris)\r\n{\r\nclk_disable_unprepare(iris->xo_clk);\r\nregulator_bulk_disable(iris->num_vregs, iris->vregs);\r\n}\r\nstatic int qcom_iris_probe(struct platform_device *pdev)\r\n{\r\nconst struct iris_data *data;\r\nstruct qcom_wcnss *wcnss;\r\nstruct qcom_iris *iris;\r\nint ret;\r\nint i;\r\niris = devm_kzalloc(&pdev->dev, sizeof(struct qcom_iris), GFP_KERNEL);\r\nif (!iris)\r\nreturn -ENOMEM;\r\ndata = of_device_get_match_data(&pdev->dev);\r\nwcnss = dev_get_drvdata(pdev->dev.parent);\r\niris->xo_clk = devm_clk_get(&pdev->dev, "xo");\r\nif (IS_ERR(iris->xo_clk)) {\r\nif (PTR_ERR(iris->xo_clk) != -EPROBE_DEFER)\r\ndev_err(&pdev->dev, "failed to acquire xo clk\n");\r\nreturn PTR_ERR(iris->xo_clk);\r\n}\r\niris->num_vregs = data->num_vregs;\r\niris->vregs = devm_kcalloc(&pdev->dev,\r\niris->num_vregs,\r\nsizeof(struct regulator_bulk_data),\r\nGFP_KERNEL);\r\nif (!iris->vregs)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < iris->num_vregs; i++)\r\niris->vregs[i].supply = data->vregs[i].name;\r\nret = devm_regulator_bulk_get(&pdev->dev, iris->num_vregs, iris->vregs);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to get regulators\n");\r\nreturn ret;\r\n}\r\nfor (i = 0; i < iris->num_vregs; i++) {\r\nif (data->vregs[i].max_voltage)\r\nregulator_set_voltage(iris->vregs[i].consumer,\r\ndata->vregs[i].min_voltage,\r\ndata->vregs[i].max_voltage);\r\nif (data->vregs[i].load_uA)\r\nregulator_set_load(iris->vregs[i].consumer,\r\ndata->vregs[i].load_uA);\r\n}\r\nqcom_wcnss_assign_iris(wcnss, iris, data->use_48mhz_xo);\r\nreturn 0;\r\n}\r\nstatic int qcom_iris_remove(struct platform_device *pdev)\r\n{\r\nstruct qcom_wcnss *wcnss = dev_get_drvdata(pdev->dev.parent);\r\nqcom_wcnss_assign_iris(wcnss, NULL, false);\r\nreturn 0;\r\n}

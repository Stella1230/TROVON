static int hi6220_ion_probe(struct platform_device *pdev)\r\n{\r\nstruct hisi_ion_dev *ipdev;\r\nint i;\r\nipdev = devm_kzalloc(&pdev->dev, sizeof(*ipdev), GFP_KERNEL);\r\nif (!ipdev)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, ipdev);\r\nipdev->idev = ion_device_create(NULL);\r\nif (IS_ERR(ipdev->idev))\r\nreturn PTR_ERR(ipdev->idev);\r\nipdev->data = ion_parse_dt(pdev, hisi_heaps);\r\nif (IS_ERR(ipdev->data))\r\nreturn PTR_ERR(ipdev->data);\r\nipdev->heaps = devm_kzalloc(&pdev->dev,\r\nsizeof(struct ion_heap) * ipdev->data->nr,\r\nGFP_KERNEL);\r\nif (!ipdev->heaps) {\r\nion_destroy_platform_data(ipdev->data);\r\nreturn -ENOMEM;\r\n}\r\nfor (i = 0; i < ipdev->data->nr; i++) {\r\nipdev->heaps[i] = ion_heap_create(&ipdev->data->heaps[i]);\r\nif (!ipdev->heaps) {\r\nion_destroy_platform_data(ipdev->data);\r\nreturn -ENOMEM;\r\n}\r\nion_device_add_heap(ipdev->idev, ipdev->heaps[i]);\r\n}\r\nreturn 0;\r\n}\r\nstatic int hi6220_ion_remove(struct platform_device *pdev)\r\n{\r\nstruct hisi_ion_dev *ipdev;\r\nint i;\r\nipdev = platform_get_drvdata(pdev);\r\nfor (i = 0; i < ipdev->data->nr; i++)\r\nion_heap_destroy(ipdev->heaps[i]);\r\nion_destroy_platform_data(ipdev->data);\r\nion_device_destroy(ipdev->idev);\r\nreturn 0;\r\n}\r\nstatic int __init hi6220_ion_init(void)\r\n{\r\nreturn platform_driver_register(&hi6220_ion_driver);\r\n}

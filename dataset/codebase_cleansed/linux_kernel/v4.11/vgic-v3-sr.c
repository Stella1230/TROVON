static u64 __hyp_text __gic_v3_get_lr(unsigned int lr)\r\n{\r\nswitch (lr & 0xf) {\r\ncase 0:\r\nreturn read_gicreg(ICH_LR0_EL2);\r\ncase 1:\r\nreturn read_gicreg(ICH_LR1_EL2);\r\ncase 2:\r\nreturn read_gicreg(ICH_LR2_EL2);\r\ncase 3:\r\nreturn read_gicreg(ICH_LR3_EL2);\r\ncase 4:\r\nreturn read_gicreg(ICH_LR4_EL2);\r\ncase 5:\r\nreturn read_gicreg(ICH_LR5_EL2);\r\ncase 6:\r\nreturn read_gicreg(ICH_LR6_EL2);\r\ncase 7:\r\nreturn read_gicreg(ICH_LR7_EL2);\r\ncase 8:\r\nreturn read_gicreg(ICH_LR8_EL2);\r\ncase 9:\r\nreturn read_gicreg(ICH_LR9_EL2);\r\ncase 10:\r\nreturn read_gicreg(ICH_LR10_EL2);\r\ncase 11:\r\nreturn read_gicreg(ICH_LR11_EL2);\r\ncase 12:\r\nreturn read_gicreg(ICH_LR12_EL2);\r\ncase 13:\r\nreturn read_gicreg(ICH_LR13_EL2);\r\ncase 14:\r\nreturn read_gicreg(ICH_LR14_EL2);\r\ncase 15:\r\nreturn read_gicreg(ICH_LR15_EL2);\r\n}\r\nunreachable();\r\n}\r\nstatic void __hyp_text __gic_v3_set_lr(u64 val, int lr)\r\n{\r\nswitch (lr & 0xf) {\r\ncase 0:\r\nwrite_gicreg(val, ICH_LR0_EL2);\r\nbreak;\r\ncase 1:\r\nwrite_gicreg(val, ICH_LR1_EL2);\r\nbreak;\r\ncase 2:\r\nwrite_gicreg(val, ICH_LR2_EL2);\r\nbreak;\r\ncase 3:\r\nwrite_gicreg(val, ICH_LR3_EL2);\r\nbreak;\r\ncase 4:\r\nwrite_gicreg(val, ICH_LR4_EL2);\r\nbreak;\r\ncase 5:\r\nwrite_gicreg(val, ICH_LR5_EL2);\r\nbreak;\r\ncase 6:\r\nwrite_gicreg(val, ICH_LR6_EL2);\r\nbreak;\r\ncase 7:\r\nwrite_gicreg(val, ICH_LR7_EL2);\r\nbreak;\r\ncase 8:\r\nwrite_gicreg(val, ICH_LR8_EL2);\r\nbreak;\r\ncase 9:\r\nwrite_gicreg(val, ICH_LR9_EL2);\r\nbreak;\r\ncase 10:\r\nwrite_gicreg(val, ICH_LR10_EL2);\r\nbreak;\r\ncase 11:\r\nwrite_gicreg(val, ICH_LR11_EL2);\r\nbreak;\r\ncase 12:\r\nwrite_gicreg(val, ICH_LR12_EL2);\r\nbreak;\r\ncase 13:\r\nwrite_gicreg(val, ICH_LR13_EL2);\r\nbreak;\r\ncase 14:\r\nwrite_gicreg(val, ICH_LR14_EL2);\r\nbreak;\r\ncase 15:\r\nwrite_gicreg(val, ICH_LR15_EL2);\r\nbreak;\r\n}\r\n}\r\nstatic void __hyp_text save_maint_int_state(struct kvm_vcpu *vcpu, int nr_lr)\r\n{\r\nstruct vgic_v3_cpu_if *cpu_if = &vcpu->arch.vgic_cpu.vgic_v3;\r\nint i;\r\nbool expect_mi;\r\nexpect_mi = !!(cpu_if->vgic_hcr & ICH_HCR_UIE);\r\nfor (i = 0; i < nr_lr; i++) {\r\nif (!(vcpu->arch.vgic_cpu.live_lrs & (1UL << i)))\r\ncontinue;\r\nexpect_mi |= (!(cpu_if->vgic_lr[i] & ICH_LR_HW) &&\r\n(cpu_if->vgic_lr[i] & ICH_LR_EOI));\r\n}\r\nif (expect_mi) {\r\ncpu_if->vgic_misr = read_gicreg(ICH_MISR_EL2);\r\nif (cpu_if->vgic_misr & ICH_MISR_EOI)\r\ncpu_if->vgic_eisr = read_gicreg(ICH_EISR_EL2);\r\nelse\r\ncpu_if->vgic_eisr = 0;\r\n} else {\r\ncpu_if->vgic_misr = 0;\r\ncpu_if->vgic_eisr = 0;\r\n}\r\n}\r\nvoid __hyp_text __vgic_v3_save_state(struct kvm_vcpu *vcpu)\r\n{\r\nstruct vgic_v3_cpu_if *cpu_if = &vcpu->arch.vgic_cpu.vgic_v3;\r\nu64 val;\r\nif (!cpu_if->vgic_sre)\r\ndsb(st);\r\ncpu_if->vgic_vmcr = read_gicreg(ICH_VMCR_EL2);\r\nif (vcpu->arch.vgic_cpu.live_lrs) {\r\nint i;\r\nu32 max_lr_idx, nr_pri_bits;\r\ncpu_if->vgic_elrsr = read_gicreg(ICH_ELSR_EL2);\r\nwrite_gicreg(0, ICH_HCR_EL2);\r\nval = read_gicreg(ICH_VTR_EL2);\r\nmax_lr_idx = vtr_to_max_lr_idx(val);\r\nnr_pri_bits = vtr_to_nr_pri_bits(val);\r\nsave_maint_int_state(vcpu, max_lr_idx + 1);\r\nfor (i = 0; i <= max_lr_idx; i++) {\r\nif (!(vcpu->arch.vgic_cpu.live_lrs & (1UL << i)))\r\ncontinue;\r\nif (cpu_if->vgic_elrsr & (1 << i))\r\ncpu_if->vgic_lr[i] &= ~ICH_LR_STATE;\r\nelse\r\ncpu_if->vgic_lr[i] = __gic_v3_get_lr(i);\r\n__gic_v3_set_lr(0, i);\r\n}\r\nswitch (nr_pri_bits) {\r\ncase 7:\r\ncpu_if->vgic_ap0r[3] = read_gicreg(ICH_AP0R3_EL2);\r\ncpu_if->vgic_ap0r[2] = read_gicreg(ICH_AP0R2_EL2);\r\ncase 6:\r\ncpu_if->vgic_ap0r[1] = read_gicreg(ICH_AP0R1_EL2);\r\ndefault:\r\ncpu_if->vgic_ap0r[0] = read_gicreg(ICH_AP0R0_EL2);\r\n}\r\nswitch (nr_pri_bits) {\r\ncase 7:\r\ncpu_if->vgic_ap1r[3] = read_gicreg(ICH_AP1R3_EL2);\r\ncpu_if->vgic_ap1r[2] = read_gicreg(ICH_AP1R2_EL2);\r\ncase 6:\r\ncpu_if->vgic_ap1r[1] = read_gicreg(ICH_AP1R1_EL2);\r\ndefault:\r\ncpu_if->vgic_ap1r[0] = read_gicreg(ICH_AP1R0_EL2);\r\n}\r\nvcpu->arch.vgic_cpu.live_lrs = 0;\r\n} else {\r\ncpu_if->vgic_misr = 0;\r\ncpu_if->vgic_eisr = 0;\r\ncpu_if->vgic_elrsr = 0xffff;\r\ncpu_if->vgic_ap0r[0] = 0;\r\ncpu_if->vgic_ap0r[1] = 0;\r\ncpu_if->vgic_ap0r[2] = 0;\r\ncpu_if->vgic_ap0r[3] = 0;\r\ncpu_if->vgic_ap1r[0] = 0;\r\ncpu_if->vgic_ap1r[1] = 0;\r\ncpu_if->vgic_ap1r[2] = 0;\r\ncpu_if->vgic_ap1r[3] = 0;\r\n}\r\nval = read_gicreg(ICC_SRE_EL2);\r\nwrite_gicreg(val | ICC_SRE_EL2_ENABLE, ICC_SRE_EL2);\r\nif (!cpu_if->vgic_sre) {\r\nisb();\r\nwrite_gicreg(1, ICC_SRE_EL1);\r\n}\r\n}\r\nvoid __hyp_text __vgic_v3_restore_state(struct kvm_vcpu *vcpu)\r\n{\r\nstruct vgic_v3_cpu_if *cpu_if = &vcpu->arch.vgic_cpu.vgic_v3;\r\nu64 val;\r\nu32 max_lr_idx, nr_pri_bits;\r\nu16 live_lrs = 0;\r\nint i;\r\nif (!cpu_if->vgic_sre) {\r\nwrite_gicreg(0, ICC_SRE_EL1);\r\nisb();\r\n}\r\nval = read_gicreg(ICH_VTR_EL2);\r\nmax_lr_idx = vtr_to_max_lr_idx(val);\r\nnr_pri_bits = vtr_to_nr_pri_bits(val);\r\nfor (i = 0; i <= max_lr_idx; i++) {\r\nif (cpu_if->vgic_lr[i] & ICH_LR_STATE)\r\nlive_lrs |= (1 << i);\r\n}\r\nwrite_gicreg(cpu_if->vgic_vmcr, ICH_VMCR_EL2);\r\nif (live_lrs) {\r\nwrite_gicreg(cpu_if->vgic_hcr, ICH_HCR_EL2);\r\nswitch (nr_pri_bits) {\r\ncase 7:\r\nwrite_gicreg(cpu_if->vgic_ap0r[3], ICH_AP0R3_EL2);\r\nwrite_gicreg(cpu_if->vgic_ap0r[2], ICH_AP0R2_EL2);\r\ncase 6:\r\nwrite_gicreg(cpu_if->vgic_ap0r[1], ICH_AP0R1_EL2);\r\ndefault:\r\nwrite_gicreg(cpu_if->vgic_ap0r[0], ICH_AP0R0_EL2);\r\n}\r\nswitch (nr_pri_bits) {\r\ncase 7:\r\nwrite_gicreg(cpu_if->vgic_ap1r[3], ICH_AP1R3_EL2);\r\nwrite_gicreg(cpu_if->vgic_ap1r[2], ICH_AP1R2_EL2);\r\ncase 6:\r\nwrite_gicreg(cpu_if->vgic_ap1r[1], ICH_AP1R1_EL2);\r\ndefault:\r\nwrite_gicreg(cpu_if->vgic_ap1r[0], ICH_AP1R0_EL2);\r\n}\r\nfor (i = 0; i <= max_lr_idx; i++) {\r\nif (!(live_lrs & (1 << i)))\r\ncontinue;\r\n__gic_v3_set_lr(cpu_if->vgic_lr[i], i);\r\n}\r\n}\r\nif (!cpu_if->vgic_sre) {\r\nisb();\r\ndsb(sy);\r\n}\r\nvcpu->arch.vgic_cpu.live_lrs = live_lrs;\r\nwrite_gicreg(read_gicreg(ICC_SRE_EL2) & ~ICC_SRE_EL2_ENABLE,\r\nICC_SRE_EL2);\r\n}\r\nvoid __hyp_text __vgic_v3_init_lrs(void)\r\n{\r\nint max_lr_idx = vtr_to_max_lr_idx(read_gicreg(ICH_VTR_EL2));\r\nint i;\r\nfor (i = 0; i <= max_lr_idx; i++)\r\n__gic_v3_set_lr(0, i);\r\n}\r\nu64 __hyp_text __vgic_v3_get_ich_vtr_el2(void)\r\n{\r\nreturn read_gicreg(ICH_VTR_EL2);\r\n}

int liquidio_set_feature(struct net_device *netdev, int cmd, u16 param1)\r\n{\r\nstruct lio *lio = GET_LIO(netdev);\r\nstruct octeon_device *oct = lio->oct_dev;\r\nstruct octnic_ctrl_pkt nctrl;\r\nint ret = 0;\r\nmemset(&nctrl, 0, sizeof(struct octnic_ctrl_pkt));\r\nnctrl.ncmd.u64 = 0;\r\nnctrl.ncmd.s.cmd = cmd;\r\nnctrl.ncmd.s.param1 = param1;\r\nnctrl.iq_no = lio->linfo.txpciq[0].s.q_no;\r\nnctrl.wait_time = 100;\r\nnctrl.netpndev = (u64)netdev;\r\nnctrl.cb_fn = liquidio_link_ctrl_cmd_completion;\r\nret = octnet_send_nic_ctrl_pkt(lio->oct_dev, &nctrl);\r\nif (ret < 0) {\r\ndev_err(&oct->pci_dev->dev, "Feature change failed in core (ret: 0x%x)\n",\r\nret);\r\n}\r\nreturn ret;\r\n}\r\nvoid octeon_report_tx_completion_to_bql(void *txq, unsigned int pkts_compl,\r\nunsigned int bytes_compl)\r\n{\r\nstruct netdev_queue *netdev_queue = txq;\r\nnetdev_tx_completed_queue(netdev_queue, pkts_compl, bytes_compl);\r\n}\r\nvoid octeon_update_tx_completion_counters(void *buf, int reqtype,\r\nunsigned int *pkts_compl,\r\nunsigned int *bytes_compl)\r\n{\r\nstruct octnet_buf_free_info *finfo;\r\nstruct sk_buff *skb = NULL;\r\nstruct octeon_soft_command *sc;\r\nswitch (reqtype) {\r\ncase REQTYPE_NORESP_NET:\r\ncase REQTYPE_NORESP_NET_SG:\r\nfinfo = buf;\r\nskb = finfo->skb;\r\nbreak;\r\ncase REQTYPE_RESP_NET_SG:\r\ncase REQTYPE_RESP_NET:\r\nsc = buf;\r\nskb = sc->callback_arg;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\n(*pkts_compl)++;\r\n*bytes_compl += skb->len;\r\n}\r\nvoid octeon_report_sent_bytes_to_bql(void *buf, int reqtype)\r\n{\r\nstruct octnet_buf_free_info *finfo;\r\nstruct sk_buff *skb;\r\nstruct octeon_soft_command *sc;\r\nstruct netdev_queue *txq;\r\nswitch (reqtype) {\r\ncase REQTYPE_NORESP_NET:\r\ncase REQTYPE_NORESP_NET_SG:\r\nfinfo = buf;\r\nskb = finfo->skb;\r\nbreak;\r\ncase REQTYPE_RESP_NET_SG:\r\ncase REQTYPE_RESP_NET:\r\nsc = buf;\r\nskb = sc->callback_arg;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\ntxq = netdev_get_tx_queue(skb->dev, skb_get_queue_mapping(skb));\r\nnetdev_tx_sent_queue(txq, skb->len);\r\n}\r\nvoid liquidio_link_ctrl_cmd_completion(void *nctrl_ptr)\r\n{\r\nstruct octnic_ctrl_pkt *nctrl = (struct octnic_ctrl_pkt *)nctrl_ptr;\r\nstruct net_device *netdev = (struct net_device *)nctrl->netpndev;\r\nstruct lio *lio = GET_LIO(netdev);\r\nstruct octeon_device *oct = lio->oct_dev;\r\nu8 *mac;\r\nswitch (nctrl->ncmd.s.cmd) {\r\ncase OCTNET_CMD_CHANGE_DEVFLAGS:\r\ncase OCTNET_CMD_SET_MULTI_LIST:\r\nbreak;\r\ncase OCTNET_CMD_CHANGE_MACADDR:\r\nmac = ((u8 *)&nctrl->udd[0]) + 2;\r\nnetif_info(lio, probe, lio->netdev,\r\n"MACAddr changed to %2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x\n",\r\nmac[0], mac[1],\r\nmac[2], mac[3],\r\nmac[4], mac[5]);\r\nbreak;\r\ncase OCTNET_CMD_CHANGE_MTU:\r\nnetif_info(lio, probe, lio->netdev, "MTU Changed from %d to %d\n",\r\nnetdev->mtu, nctrl->ncmd.s.param1);\r\ndev_info(&oct->pci_dev->dev, "%s MTU Changed from %d to %d\n",\r\nnetdev->name, netdev->mtu,\r\nnctrl->ncmd.s.param1);\r\nnetdev->mtu = nctrl->ncmd.s.param1;\r\nqueue_delayed_work(lio->link_status_wq.wq,\r\n&lio->link_status_wq.wk.work, 0);\r\nbreak;\r\ncase OCTNET_CMD_GPIO_ACCESS:\r\nnetif_info(lio, probe, lio->netdev, "LED Flashing visual identification\n");\r\nbreak;\r\ncase OCTNET_CMD_ID_ACTIVE:\r\nnetif_info(lio, probe, lio->netdev, "LED Flashing visual identification\n");\r\nbreak;\r\ncase OCTNET_CMD_LRO_ENABLE:\r\ndev_info(&oct->pci_dev->dev, "%s LRO Enabled\n", netdev->name);\r\nbreak;\r\ncase OCTNET_CMD_LRO_DISABLE:\r\ndev_info(&oct->pci_dev->dev, "%s LRO Disabled\n",\r\nnetdev->name);\r\nbreak;\r\ncase OCTNET_CMD_VERBOSE_ENABLE:\r\ndev_info(&oct->pci_dev->dev, "%s Firmware debug enabled\n",\r\nnetdev->name);\r\nbreak;\r\ncase OCTNET_CMD_VERBOSE_DISABLE:\r\ndev_info(&oct->pci_dev->dev, "%s Firmware debug disabled\n",\r\nnetdev->name);\r\nbreak;\r\ncase OCTNET_CMD_ENABLE_VLAN_FILTER:\r\ndev_info(&oct->pci_dev->dev, "%s VLAN filter enabled\n",\r\nnetdev->name);\r\nbreak;\r\ncase OCTNET_CMD_ADD_VLAN_FILTER:\r\ndev_info(&oct->pci_dev->dev, "%s VLAN filter %d added\n",\r\nnetdev->name, nctrl->ncmd.s.param1);\r\nbreak;\r\ncase OCTNET_CMD_DEL_VLAN_FILTER:\r\ndev_info(&oct->pci_dev->dev, "%s VLAN filter %d removed\n",\r\nnetdev->name, nctrl->ncmd.s.param1);\r\nbreak;\r\ncase OCTNET_CMD_SET_SETTINGS:\r\ndev_info(&oct->pci_dev->dev, "%s settings changed\n",\r\nnetdev->name);\r\nbreak;\r\ncase OCTNET_CMD_TNL_RX_CSUM_CTL:\r\nif (nctrl->ncmd.s.param1 == OCTNET_CMD_RXCSUM_ENABLE) {\r\nnetif_info(lio, probe, lio->netdev,\r\n"RX Checksum Offload Enabled\n");\r\n} else if (nctrl->ncmd.s.param1 ==\r\nOCTNET_CMD_RXCSUM_DISABLE) {\r\nnetif_info(lio, probe, lio->netdev,\r\n"RX Checksum Offload Disabled\n");\r\n}\r\nbreak;\r\ncase OCTNET_CMD_TNL_TX_CSUM_CTL:\r\nif (nctrl->ncmd.s.param1 == OCTNET_CMD_TXCSUM_ENABLE) {\r\nnetif_info(lio, probe, lio->netdev,\r\n"TX Checksum Offload Enabled\n");\r\n} else if (nctrl->ncmd.s.param1 ==\r\nOCTNET_CMD_TXCSUM_DISABLE) {\r\nnetif_info(lio, probe, lio->netdev,\r\n"TX Checksum Offload Disabled\n");\r\n}\r\nbreak;\r\ncase OCTNET_CMD_VXLAN_PORT_CONFIG:\r\nif (nctrl->ncmd.s.more == OCTNET_CMD_VXLAN_PORT_ADD) {\r\nnetif_info(lio, probe, lio->netdev,\r\n"VxLAN Destination UDP PORT:%d ADDED\n",\r\nnctrl->ncmd.s.param1);\r\n} else if (nctrl->ncmd.s.more ==\r\nOCTNET_CMD_VXLAN_PORT_DEL) {\r\nnetif_info(lio, probe, lio->netdev,\r\n"VxLAN Destination UDP PORT:%d DELETED\n",\r\nnctrl->ncmd.s.param1);\r\n}\r\nbreak;\r\ncase OCTNET_CMD_SET_FLOW_CTL:\r\nnetif_info(lio, probe, lio->netdev, "Set RX/TX flow control parameters\n");\r\nbreak;\r\ndefault:\r\ndev_err(&oct->pci_dev->dev, "%s Unknown cmd %d\n", __func__,\r\nnctrl->ncmd.s.cmd);\r\n}\r\n}\r\nvoid octeon_pf_changed_vf_macaddr(struct octeon_device *oct, u8 *mac)\r\n{\r\nbool macaddr_changed = false;\r\nstruct net_device *netdev;\r\nstruct lio *lio;\r\nrtnl_lock();\r\nnetdev = oct->props[0].netdev;\r\nlio = GET_LIO(netdev);\r\nlio->linfo.macaddr_is_admin_asgnd = true;\r\nif (!ether_addr_equal(netdev->dev_addr, mac)) {\r\nmacaddr_changed = true;\r\nether_addr_copy(netdev->dev_addr, mac);\r\nether_addr_copy(((u8 *)&lio->linfo.hw_addr) + 2, mac);\r\ncall_netdevice_notifiers(NETDEV_CHANGEADDR, netdev);\r\n}\r\nrtnl_unlock();\r\nif (macaddr_changed)\r\ndev_info(&oct->pci_dev->dev,\r\n"PF changed VF's MAC address to %pM\n", mac);\r\n}

static inline void vsp1_rpf_write(struct vsp1_rwpf *rpf,\r\nstruct vsp1_dl_list *dl, u32 reg, u32 data)\r\n{\r\nvsp1_dl_list_write(dl, reg + rpf->entity.index * VI6_RPF_OFFSET, data);\r\n}\r\nstatic void rpf_configure(struct vsp1_entity *entity,\r\nstruct vsp1_pipeline *pipe,\r\nstruct vsp1_dl_list *dl,\r\nenum vsp1_entity_params params)\r\n{\r\nstruct vsp1_rwpf *rpf = to_rwpf(&entity->subdev);\r\nconst struct vsp1_format_info *fmtinfo = rpf->fmtinfo;\r\nconst struct v4l2_pix_format_mplane *format = &rpf->format;\r\nconst struct v4l2_mbus_framefmt *source_format;\r\nconst struct v4l2_mbus_framefmt *sink_format;\r\nunsigned int left = 0;\r\nunsigned int top = 0;\r\nu32 pstride;\r\nu32 infmt;\r\nif (params == VSP1_ENTITY_PARAMS_RUNTIME) {\r\nvsp1_rpf_write(rpf, dl, VI6_RPF_VRTCOL_SET,\r\nrpf->alpha << VI6_RPF_VRTCOL_SET_LAYA_SHIFT);\r\nvsp1_rpf_write(rpf, dl, VI6_RPF_MULT_ALPHA, rpf->mult_alpha |\r\n(rpf->alpha << VI6_RPF_MULT_ALPHA_RATIO_SHIFT));\r\nvsp1_pipeline_propagate_alpha(pipe, dl, rpf->alpha);\r\nreturn;\r\n}\r\nif (params == VSP1_ENTITY_PARAMS_PARTITION) {\r\nunsigned int offsets[2];\r\nstruct v4l2_rect crop;\r\ncrop = *vsp1_rwpf_get_crop(rpf, rpf->entity.config);\r\nif (pipe->partitions > 1) {\r\nconst struct v4l2_mbus_framefmt *output;\r\nstruct vsp1_entity *wpf = &pipe->output->entity;\r\nunsigned int input_width = crop.width;\r\noutput = vsp1_entity_get_pad_format(wpf, wpf->config,\r\nRWPF_PAD_SOURCE);\r\ncrop.width = pipe->partition.width * input_width\r\n/ output->width;\r\ncrop.left += pipe->partition.left * input_width\r\n/ output->width;\r\n}\r\nvsp1_rpf_write(rpf, dl, VI6_RPF_SRC_BSIZE,\r\n(crop.width << VI6_RPF_SRC_BSIZE_BHSIZE_SHIFT) |\r\n(crop.height << VI6_RPF_SRC_BSIZE_BVSIZE_SHIFT));\r\nvsp1_rpf_write(rpf, dl, VI6_RPF_SRC_ESIZE,\r\n(crop.width << VI6_RPF_SRC_ESIZE_EHSIZE_SHIFT) |\r\n(crop.height << VI6_RPF_SRC_ESIZE_EVSIZE_SHIFT));\r\noffsets[0] = crop.top * format->plane_fmt[0].bytesperline\r\n+ crop.left * fmtinfo->bpp[0] / 8;\r\nif (format->num_planes > 1)\r\noffsets[1] = crop.top * format->plane_fmt[1].bytesperline\r\n+ crop.left / fmtinfo->hsub\r\n* fmtinfo->bpp[1] / 8;\r\nelse\r\noffsets[1] = 0;\r\nvsp1_rpf_write(rpf, dl, VI6_RPF_SRCM_ADDR_Y,\r\nrpf->mem.addr[0] + offsets[0]);\r\nvsp1_rpf_write(rpf, dl, VI6_RPF_SRCM_ADDR_C0,\r\nrpf->mem.addr[1] + offsets[1]);\r\nvsp1_rpf_write(rpf, dl, VI6_RPF_SRCM_ADDR_C1,\r\nrpf->mem.addr[2] + offsets[1]);\r\nreturn;\r\n}\r\npstride = format->plane_fmt[0].bytesperline\r\n<< VI6_RPF_SRCM_PSTRIDE_Y_SHIFT;\r\nif (format->num_planes > 1)\r\npstride |= format->plane_fmt[1].bytesperline\r\n<< VI6_RPF_SRCM_PSTRIDE_C_SHIFT;\r\nvsp1_rpf_write(rpf, dl, VI6_RPF_SRCM_PSTRIDE, pstride);\r\nsink_format = vsp1_entity_get_pad_format(&rpf->entity,\r\nrpf->entity.config,\r\nRWPF_PAD_SINK);\r\nsource_format = vsp1_entity_get_pad_format(&rpf->entity,\r\nrpf->entity.config,\r\nRWPF_PAD_SOURCE);\r\ninfmt = VI6_RPF_INFMT_CIPM\r\n| (fmtinfo->hwfmt << VI6_RPF_INFMT_RDFMT_SHIFT);\r\nif (fmtinfo->swap_yc)\r\ninfmt |= VI6_RPF_INFMT_SPYCS;\r\nif (fmtinfo->swap_uv)\r\ninfmt |= VI6_RPF_INFMT_SPUVS;\r\nif (sink_format->code != source_format->code)\r\ninfmt |= VI6_RPF_INFMT_CSC;\r\nvsp1_rpf_write(rpf, dl, VI6_RPF_INFMT, infmt);\r\nvsp1_rpf_write(rpf, dl, VI6_RPF_DSWAP, fmtinfo->swap);\r\nif (pipe->bru) {\r\nconst struct v4l2_rect *compose;\r\ncompose = vsp1_entity_get_pad_selection(pipe->bru,\r\npipe->bru->config,\r\nrpf->bru_input,\r\nV4L2_SEL_TGT_COMPOSE);\r\nleft = compose->left;\r\ntop = compose->top;\r\n}\r\nvsp1_rpf_write(rpf, dl, VI6_RPF_LOC,\r\n(left << VI6_RPF_LOC_HCOORD_SHIFT) |\r\n(top << VI6_RPF_LOC_VCOORD_SHIFT));\r\nvsp1_rpf_write(rpf, dl, VI6_RPF_ALPH_SEL, VI6_RPF_ALPH_SEL_AEXT_EXT |\r\n(fmtinfo->alpha ? VI6_RPF_ALPH_SEL_ASEL_PACKED\r\n: VI6_RPF_ALPH_SEL_ASEL_FIXED));\r\nif (entity->vsp1->info->gen == 3) {\r\nu32 mult;\r\nif (fmtinfo->alpha) {\r\nbool premultiplied = format->flags\r\n& V4L2_PIX_FMT_FLAG_PREMUL_ALPHA;\r\nmult = VI6_RPF_MULT_ALPHA_A_MMD_RATIO\r\n| (premultiplied ?\r\nVI6_RPF_MULT_ALPHA_P_MMD_RATIO :\r\nVI6_RPF_MULT_ALPHA_P_MMD_NONE);\r\n} else {\r\nmult = VI6_RPF_MULT_ALPHA_A_MMD_NONE\r\n| VI6_RPF_MULT_ALPHA_P_MMD_NONE;\r\n}\r\nrpf->mult_alpha = mult;\r\n}\r\nvsp1_rpf_write(rpf, dl, VI6_RPF_MSK_CTRL, 0);\r\nvsp1_rpf_write(rpf, dl, VI6_RPF_CKEY_CTRL, 0);\r\n}\r\nstruct vsp1_rwpf *vsp1_rpf_create(struct vsp1_device *vsp1, unsigned int index)\r\n{\r\nstruct vsp1_rwpf *rpf;\r\nchar name[6];\r\nint ret;\r\nrpf = devm_kzalloc(vsp1->dev, sizeof(*rpf), GFP_KERNEL);\r\nif (rpf == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nrpf->max_width = RPF_MAX_WIDTH;\r\nrpf->max_height = RPF_MAX_HEIGHT;\r\nrpf->entity.ops = &rpf_entity_ops;\r\nrpf->entity.type = VSP1_ENTITY_RPF;\r\nrpf->entity.index = index;\r\nsprintf(name, "rpf.%u", index);\r\nret = vsp1_entity_init(vsp1, &rpf->entity, name, 2, &rpf_ops,\r\nMEDIA_ENT_F_PROC_VIDEO_PIXEL_FORMATTER);\r\nif (ret < 0)\r\nreturn ERR_PTR(ret);\r\nret = vsp1_rwpf_init_ctrls(rpf, 0);\r\nif (ret < 0) {\r\ndev_err(vsp1->dev, "rpf%u: failed to initialize controls\n",\r\nindex);\r\ngoto error;\r\n}\r\nv4l2_ctrl_handler_setup(&rpf->ctrls);\r\nreturn rpf;\r\nerror:\r\nvsp1_entity_destroy(&rpf->entity);\r\nreturn ERR_PTR(ret);\r\n}

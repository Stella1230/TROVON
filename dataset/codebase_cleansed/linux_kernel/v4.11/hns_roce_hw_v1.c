static void set_data_seg(struct hns_roce_wqe_data_seg *dseg, struct ib_sge *sg)\r\n{\r\ndseg->lkey = cpu_to_le32(sg->lkey);\r\ndseg->addr = cpu_to_le64(sg->addr);\r\ndseg->len = cpu_to_le32(sg->length);\r\n}\r\nstatic void set_raddr_seg(struct hns_roce_wqe_raddr_seg *rseg, u64 remote_addr,\r\nu32 rkey)\r\n{\r\nrseg->raddr = cpu_to_le64(remote_addr);\r\nrseg->rkey = cpu_to_le32(rkey);\r\nrseg->len = 0;\r\n}\r\nint hns_roce_v1_post_send(struct ib_qp *ibqp, struct ib_send_wr *wr,\r\nstruct ib_send_wr **bad_wr)\r\n{\r\nstruct hns_roce_dev *hr_dev = to_hr_dev(ibqp->device);\r\nstruct hns_roce_ah *ah = to_hr_ah(ud_wr(wr)->ah);\r\nstruct hns_roce_ud_send_wqe *ud_sq_wqe = NULL;\r\nstruct hns_roce_wqe_ctrl_seg *ctrl = NULL;\r\nstruct hns_roce_wqe_data_seg *dseg = NULL;\r\nstruct hns_roce_qp *qp = to_hr_qp(ibqp);\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_sq_db sq_db;\r\nint ps_opcode = 0, i = 0;\r\nunsigned long flags = 0;\r\nvoid *wqe = NULL;\r\nu32 doorbell[2];\r\nint nreq = 0;\r\nu32 ind = 0;\r\nint ret = 0;\r\nu8 *smac;\r\nint loopback;\r\nif (unlikely(ibqp->qp_type != IB_QPT_GSI &&\r\nibqp->qp_type != IB_QPT_RC)) {\r\ndev_err(dev, "un-supported QP type\n");\r\n*bad_wr = NULL;\r\nreturn -EOPNOTSUPP;\r\n}\r\nspin_lock_irqsave(&qp->sq.lock, flags);\r\nind = qp->sq_next_wqe;\r\nfor (nreq = 0; wr; ++nreq, wr = wr->next) {\r\nif (hns_roce_wq_overflow(&qp->sq, nreq, qp->ibqp.send_cq)) {\r\nret = -ENOMEM;\r\n*bad_wr = wr;\r\ngoto out;\r\n}\r\nif (unlikely(wr->num_sge > qp->sq.max_gs)) {\r\ndev_err(dev, "num_sge=%d > qp->sq.max_gs=%d\n",\r\nwr->num_sge, qp->sq.max_gs);\r\nret = -EINVAL;\r\n*bad_wr = wr;\r\ngoto out;\r\n}\r\nwqe = get_send_wqe(qp, ind & (qp->sq.wqe_cnt - 1));\r\nqp->sq.wrid[(qp->sq.head + nreq) & (qp->sq.wqe_cnt - 1)] =\r\nwr->wr_id;\r\nif (ibqp->qp_type == IB_QPT_GSI) {\r\nud_sq_wqe = wqe;\r\nroce_set_field(ud_sq_wqe->dmac_h,\r\nUD_SEND_WQE_U32_4_DMAC_0_M,\r\nUD_SEND_WQE_U32_4_DMAC_0_S,\r\nah->av.mac[0]);\r\nroce_set_field(ud_sq_wqe->dmac_h,\r\nUD_SEND_WQE_U32_4_DMAC_1_M,\r\nUD_SEND_WQE_U32_4_DMAC_1_S,\r\nah->av.mac[1]);\r\nroce_set_field(ud_sq_wqe->dmac_h,\r\nUD_SEND_WQE_U32_4_DMAC_2_M,\r\nUD_SEND_WQE_U32_4_DMAC_2_S,\r\nah->av.mac[2]);\r\nroce_set_field(ud_sq_wqe->dmac_h,\r\nUD_SEND_WQE_U32_4_DMAC_3_M,\r\nUD_SEND_WQE_U32_4_DMAC_3_S,\r\nah->av.mac[3]);\r\nroce_set_field(ud_sq_wqe->u32_8,\r\nUD_SEND_WQE_U32_8_DMAC_4_M,\r\nUD_SEND_WQE_U32_8_DMAC_4_S,\r\nah->av.mac[4]);\r\nroce_set_field(ud_sq_wqe->u32_8,\r\nUD_SEND_WQE_U32_8_DMAC_5_M,\r\nUD_SEND_WQE_U32_8_DMAC_5_S,\r\nah->av.mac[5]);\r\nsmac = (u8 *)hr_dev->dev_addr[qp->port];\r\nloopback = ether_addr_equal_unaligned(ah->av.mac,\r\nsmac) ? 1 : 0;\r\nroce_set_bit(ud_sq_wqe->u32_8,\r\nUD_SEND_WQE_U32_8_LOOPBACK_INDICATOR_S,\r\nloopback);\r\nroce_set_field(ud_sq_wqe->u32_8,\r\nUD_SEND_WQE_U32_8_OPERATION_TYPE_M,\r\nUD_SEND_WQE_U32_8_OPERATION_TYPE_S,\r\nHNS_ROCE_WQE_OPCODE_SEND);\r\nroce_set_field(ud_sq_wqe->u32_8,\r\nUD_SEND_WQE_U32_8_NUMBER_OF_DATA_SEG_M,\r\nUD_SEND_WQE_U32_8_NUMBER_OF_DATA_SEG_S,\r\n2);\r\nroce_set_bit(ud_sq_wqe->u32_8,\r\nUD_SEND_WQE_U32_8_SEND_GL_ROUTING_HDR_FLAG_S,\r\n1);\r\nud_sq_wqe->u32_8 |= (wr->send_flags & IB_SEND_SIGNALED ?\r\ncpu_to_le32(HNS_ROCE_WQE_CQ_NOTIFY) : 0) |\r\n(wr->send_flags & IB_SEND_SOLICITED ?\r\ncpu_to_le32(HNS_ROCE_WQE_SE) : 0) |\r\n((wr->opcode == IB_WR_SEND_WITH_IMM) ?\r\ncpu_to_le32(HNS_ROCE_WQE_IMM) : 0);\r\nroce_set_field(ud_sq_wqe->u32_16,\r\nUD_SEND_WQE_U32_16_DEST_QP_M,\r\nUD_SEND_WQE_U32_16_DEST_QP_S,\r\nud_wr(wr)->remote_qpn);\r\nroce_set_field(ud_sq_wqe->u32_16,\r\nUD_SEND_WQE_U32_16_MAX_STATIC_RATE_M,\r\nUD_SEND_WQE_U32_16_MAX_STATIC_RATE_S,\r\nah->av.stat_rate);\r\nroce_set_field(ud_sq_wqe->u32_36,\r\nUD_SEND_WQE_U32_36_FLOW_LABEL_M,\r\nUD_SEND_WQE_U32_36_FLOW_LABEL_S, 0);\r\nroce_set_field(ud_sq_wqe->u32_36,\r\nUD_SEND_WQE_U32_36_PRIORITY_M,\r\nUD_SEND_WQE_U32_36_PRIORITY_S,\r\nah->av.sl_tclass_flowlabel >>\r\nHNS_ROCE_SL_SHIFT);\r\nroce_set_field(ud_sq_wqe->u32_36,\r\nUD_SEND_WQE_U32_36_SGID_INDEX_M,\r\nUD_SEND_WQE_U32_36_SGID_INDEX_S,\r\nhns_get_gid_index(hr_dev, qp->phy_port,\r\nah->av.gid_index));\r\nroce_set_field(ud_sq_wqe->u32_40,\r\nUD_SEND_WQE_U32_40_HOP_LIMIT_M,\r\nUD_SEND_WQE_U32_40_HOP_LIMIT_S,\r\nah->av.hop_limit);\r\nroce_set_field(ud_sq_wqe->u32_40,\r\nUD_SEND_WQE_U32_40_TRAFFIC_CLASS_M,\r\nUD_SEND_WQE_U32_40_TRAFFIC_CLASS_S, 0);\r\nmemcpy(&ud_sq_wqe->dgid[0], &ah->av.dgid[0], GID_LEN);\r\nud_sq_wqe->va0_l = (u32)wr->sg_list[0].addr;\r\nud_sq_wqe->va0_h = (wr->sg_list[0].addr) >> 32;\r\nud_sq_wqe->l_key0 = wr->sg_list[0].lkey;\r\nud_sq_wqe->va1_l = (u32)wr->sg_list[1].addr;\r\nud_sq_wqe->va1_h = (wr->sg_list[1].addr) >> 32;\r\nud_sq_wqe->l_key1 = wr->sg_list[1].lkey;\r\nind++;\r\n} else if (ibqp->qp_type == IB_QPT_RC) {\r\nctrl = wqe;\r\nmemset(ctrl, 0, sizeof(struct hns_roce_wqe_ctrl_seg));\r\nfor (i = 0; i < wr->num_sge; i++)\r\nctrl->msg_length += wr->sg_list[i].length;\r\nctrl->sgl_pa_h = 0;\r\nctrl->flag = 0;\r\nctrl->imm_data = send_ieth(wr);\r\nctrl->flag |= (wr->send_flags & IB_SEND_SIGNALED ?\r\ncpu_to_le32(HNS_ROCE_WQE_CQ_NOTIFY) : 0) |\r\n(wr->send_flags & IB_SEND_SOLICITED ?\r\ncpu_to_le32(HNS_ROCE_WQE_SE) : 0) |\r\n((wr->opcode == IB_WR_SEND_WITH_IMM ||\r\nwr->opcode == IB_WR_RDMA_WRITE_WITH_IMM) ?\r\ncpu_to_le32(HNS_ROCE_WQE_IMM) : 0) |\r\n(wr->send_flags & IB_SEND_FENCE ?\r\n(cpu_to_le32(HNS_ROCE_WQE_FENCE)) : 0);\r\nwqe += sizeof(struct hns_roce_wqe_ctrl_seg);\r\nswitch (wr->opcode) {\r\ncase IB_WR_RDMA_READ:\r\nps_opcode = HNS_ROCE_WQE_OPCODE_RDMA_READ;\r\nset_raddr_seg(wqe, atomic_wr(wr)->remote_addr,\r\natomic_wr(wr)->rkey);\r\nbreak;\r\ncase IB_WR_RDMA_WRITE:\r\ncase IB_WR_RDMA_WRITE_WITH_IMM:\r\nps_opcode = HNS_ROCE_WQE_OPCODE_RDMA_WRITE;\r\nset_raddr_seg(wqe, atomic_wr(wr)->remote_addr,\r\natomic_wr(wr)->rkey);\r\nbreak;\r\ncase IB_WR_SEND:\r\ncase IB_WR_SEND_WITH_INV:\r\ncase IB_WR_SEND_WITH_IMM:\r\nps_opcode = HNS_ROCE_WQE_OPCODE_SEND;\r\nbreak;\r\ncase IB_WR_LOCAL_INV:\r\nbreak;\r\ncase IB_WR_ATOMIC_CMP_AND_SWP:\r\ncase IB_WR_ATOMIC_FETCH_AND_ADD:\r\ncase IB_WR_LSO:\r\ndefault:\r\nps_opcode = HNS_ROCE_WQE_OPCODE_MASK;\r\nbreak;\r\n}\r\nctrl->flag |= cpu_to_le32(ps_opcode);\r\nwqe += sizeof(struct hns_roce_wqe_raddr_seg);\r\ndseg = wqe;\r\nif (wr->send_flags & IB_SEND_INLINE && wr->num_sge) {\r\nif (ctrl->msg_length >\r\nhr_dev->caps.max_sq_inline) {\r\nret = -EINVAL;\r\n*bad_wr = wr;\r\ndev_err(dev, "inline len(1-%d)=%d, illegal",\r\nctrl->msg_length,\r\nhr_dev->caps.max_sq_inline);\r\ngoto out;\r\n}\r\nfor (i = 0; i < wr->num_sge; i++) {\r\nmemcpy(wqe, ((void *) (uintptr_t)\r\nwr->sg_list[i].addr),\r\nwr->sg_list[i].length);\r\nwqe += wr->sg_list[i].length;\r\n}\r\nctrl->flag |= HNS_ROCE_WQE_INLINE;\r\n} else {\r\nfor (i = 0; i < wr->num_sge; i++)\r\nset_data_seg(dseg + i, wr->sg_list + i);\r\nctrl->flag |= cpu_to_le32(wr->num_sge <<\r\nHNS_ROCE_WQE_SGE_NUM_BIT);\r\n}\r\nind++;\r\n}\r\n}\r\nout:\r\nif (likely(nreq)) {\r\nqp->sq.head += nreq;\r\nwmb();\r\nsq_db.u32_4 = 0;\r\nsq_db.u32_8 = 0;\r\nroce_set_field(sq_db.u32_4, SQ_DOORBELL_U32_4_SQ_HEAD_M,\r\nSQ_DOORBELL_U32_4_SQ_HEAD_S,\r\n(qp->sq.head & ((qp->sq.wqe_cnt << 1) - 1)));\r\nroce_set_field(sq_db.u32_4, SQ_DOORBELL_U32_4_SL_M,\r\nSQ_DOORBELL_U32_4_SL_S, qp->sl);\r\nroce_set_field(sq_db.u32_4, SQ_DOORBELL_U32_4_PORT_M,\r\nSQ_DOORBELL_U32_4_PORT_S, qp->phy_port);\r\nroce_set_field(sq_db.u32_8, SQ_DOORBELL_U32_8_QPN_M,\r\nSQ_DOORBELL_U32_8_QPN_S, qp->doorbell_qpn);\r\nroce_set_bit(sq_db.u32_8, SQ_DOORBELL_HW_SYNC_S, 1);\r\ndoorbell[0] = sq_db.u32_4;\r\ndoorbell[1] = sq_db.u32_8;\r\nhns_roce_write64_k(doorbell, qp->sq.db_reg_l);\r\nqp->sq_next_wqe = ind;\r\n}\r\nspin_unlock_irqrestore(&qp->sq.lock, flags);\r\nreturn ret;\r\n}\r\nint hns_roce_v1_post_recv(struct ib_qp *ibqp, struct ib_recv_wr *wr,\r\nstruct ib_recv_wr **bad_wr)\r\n{\r\nint ret = 0;\r\nint nreq = 0;\r\nint ind = 0;\r\nint i = 0;\r\nu32 reg_val = 0;\r\nunsigned long flags = 0;\r\nstruct hns_roce_rq_wqe_ctrl *ctrl = NULL;\r\nstruct hns_roce_wqe_data_seg *scat = NULL;\r\nstruct hns_roce_qp *hr_qp = to_hr_qp(ibqp);\r\nstruct hns_roce_dev *hr_dev = to_hr_dev(ibqp->device);\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_rq_db rq_db;\r\nuint32_t doorbell[2] = {0};\r\nspin_lock_irqsave(&hr_qp->rq.lock, flags);\r\nind = hr_qp->rq.head & (hr_qp->rq.wqe_cnt - 1);\r\nfor (nreq = 0; wr; ++nreq, wr = wr->next) {\r\nif (hns_roce_wq_overflow(&hr_qp->rq, nreq,\r\nhr_qp->ibqp.recv_cq)) {\r\nret = -ENOMEM;\r\n*bad_wr = wr;\r\ngoto out;\r\n}\r\nif (unlikely(wr->num_sge > hr_qp->rq.max_gs)) {\r\ndev_err(dev, "rq:num_sge=%d > qp->sq.max_gs=%d\n",\r\nwr->num_sge, hr_qp->rq.max_gs);\r\nret = -EINVAL;\r\n*bad_wr = wr;\r\ngoto out;\r\n}\r\nctrl = get_recv_wqe(hr_qp, ind);\r\nroce_set_field(ctrl->rwqe_byte_12,\r\nRQ_WQE_CTRL_RWQE_BYTE_12_RWQE_SGE_NUM_M,\r\nRQ_WQE_CTRL_RWQE_BYTE_12_RWQE_SGE_NUM_S,\r\nwr->num_sge);\r\nscat = (struct hns_roce_wqe_data_seg *)(ctrl + 1);\r\nfor (i = 0; i < wr->num_sge; i++)\r\nset_data_seg(scat + i, wr->sg_list + i);\r\nhr_qp->rq.wrid[ind] = wr->wr_id;\r\nind = (ind + 1) & (hr_qp->rq.wqe_cnt - 1);\r\n}\r\nout:\r\nif (likely(nreq)) {\r\nhr_qp->rq.head += nreq;\r\nwmb();\r\nif (ibqp->qp_type == IB_QPT_GSI) {\r\nreg_val = roce_read(to_hr_dev(ibqp->device),\r\nROCEE_QP1C_CFG3_0_REG +\r\nQP1C_CFGN_OFFSET * hr_qp->phy_port);\r\nroce_set_field(reg_val,\r\nROCEE_QP1C_CFG3_0_ROCEE_QP1C_RQ_HEAD_M,\r\nROCEE_QP1C_CFG3_0_ROCEE_QP1C_RQ_HEAD_S,\r\nhr_qp->rq.head);\r\nroce_write(to_hr_dev(ibqp->device),\r\nROCEE_QP1C_CFG3_0_REG +\r\nQP1C_CFGN_OFFSET * hr_qp->phy_port, reg_val);\r\n} else {\r\nrq_db.u32_4 = 0;\r\nrq_db.u32_8 = 0;\r\nroce_set_field(rq_db.u32_4, RQ_DOORBELL_U32_4_RQ_HEAD_M,\r\nRQ_DOORBELL_U32_4_RQ_HEAD_S,\r\nhr_qp->rq.head);\r\nroce_set_field(rq_db.u32_8, RQ_DOORBELL_U32_8_QPN_M,\r\nRQ_DOORBELL_U32_8_QPN_S, hr_qp->qpn);\r\nroce_set_field(rq_db.u32_8, RQ_DOORBELL_U32_8_CMD_M,\r\nRQ_DOORBELL_U32_8_CMD_S, 1);\r\nroce_set_bit(rq_db.u32_8, RQ_DOORBELL_U32_8_HW_SYNC_S,\r\n1);\r\ndoorbell[0] = rq_db.u32_4;\r\ndoorbell[1] = rq_db.u32_8;\r\nhns_roce_write64_k(doorbell, hr_qp->rq.db_reg_l);\r\n}\r\n}\r\nspin_unlock_irqrestore(&hr_qp->rq.lock, flags);\r\nreturn ret;\r\n}\r\nstatic void hns_roce_set_db_event_mode(struct hns_roce_dev *hr_dev,\r\nint sdb_mode, int odb_mode)\r\n{\r\nu32 val;\r\nval = roce_read(hr_dev, ROCEE_GLB_CFG_REG);\r\nroce_set_bit(val, ROCEE_GLB_CFG_ROCEE_DB_SQ_MODE_S, sdb_mode);\r\nroce_set_bit(val, ROCEE_GLB_CFG_ROCEE_DB_OTH_MODE_S, odb_mode);\r\nroce_write(hr_dev, ROCEE_GLB_CFG_REG, val);\r\n}\r\nstatic void hns_roce_set_db_ext_mode(struct hns_roce_dev *hr_dev, u32 sdb_mode,\r\nu32 odb_mode)\r\n{\r\nu32 val;\r\nval = roce_read(hr_dev, ROCEE_GLB_CFG_REG);\r\nroce_set_bit(val, ROCEE_GLB_CFG_SQ_EXT_DB_MODE_S, sdb_mode);\r\nroce_set_bit(val, ROCEE_GLB_CFG_OTH_EXT_DB_MODE_S, odb_mode);\r\nroce_write(hr_dev, ROCEE_GLB_CFG_REG, val);\r\n}\r\nstatic void hns_roce_set_sdb(struct hns_roce_dev *hr_dev, u32 sdb_alept,\r\nu32 sdb_alful)\r\n{\r\nu32 val;\r\nval = roce_read(hr_dev, ROCEE_DB_SQ_WL_REG);\r\nroce_set_field(val, ROCEE_DB_SQ_WL_ROCEE_DB_SQ_WL_M,\r\nROCEE_DB_SQ_WL_ROCEE_DB_SQ_WL_S, sdb_alful);\r\nroce_set_field(val, ROCEE_DB_SQ_WL_ROCEE_DB_SQ_WL_EMPTY_M,\r\nROCEE_DB_SQ_WL_ROCEE_DB_SQ_WL_EMPTY_S, sdb_alept);\r\nroce_write(hr_dev, ROCEE_DB_SQ_WL_REG, val);\r\n}\r\nstatic void hns_roce_set_odb(struct hns_roce_dev *hr_dev, u32 odb_alept,\r\nu32 odb_alful)\r\n{\r\nu32 val;\r\nval = roce_read(hr_dev, ROCEE_DB_OTHERS_WL_REG);\r\nroce_set_field(val, ROCEE_DB_OTHERS_WL_ROCEE_DB_OTH_WL_M,\r\nROCEE_DB_OTHERS_WL_ROCEE_DB_OTH_WL_S, odb_alful);\r\nroce_set_field(val, ROCEE_DB_OTHERS_WL_ROCEE_DB_OTH_WL_EMPTY_M,\r\nROCEE_DB_OTHERS_WL_ROCEE_DB_OTH_WL_EMPTY_S, odb_alept);\r\nroce_write(hr_dev, ROCEE_DB_OTHERS_WL_REG, val);\r\n}\r\nstatic void hns_roce_set_sdb_ext(struct hns_roce_dev *hr_dev, u32 ext_sdb_alept,\r\nu32 ext_sdb_alful)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_v1_priv *priv;\r\nstruct hns_roce_db_table *db;\r\ndma_addr_t sdb_dma_addr;\r\nu32 val;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\ndb = &priv->db_table;\r\nroce_write(hr_dev, ROCEE_EXT_DB_SQ_WL_EMPTY_REG, ext_sdb_alept);\r\nroce_write(hr_dev, ROCEE_EXT_DB_SQ_WL_REG, ext_sdb_alful);\r\nsdb_dma_addr = db->ext_db->sdb_buf_list->map;\r\nroce_write(hr_dev, ROCEE_EXT_DB_SQ_REG, (u32)(sdb_dma_addr >> 12));\r\nval = roce_read(hr_dev, ROCEE_EXT_DB_SQ_H_REG);\r\nroce_set_field(val, ROCEE_EXT_DB_SQ_H_EXT_DB_SQ_SHIFT_M,\r\nROCEE_EXT_DB_SQ_H_EXT_DB_SQ_SHIFT_S,\r\ndb->ext_db->esdb_dep);\r\nroce_set_field(val, ROCEE_EXT_DB_SQ_H_EXT_DB_SQ_BA_H_M,\r\nROCEE_EXT_DB_SQ_H_EXT_DB_SQ_BA_H_S, sdb_dma_addr >> 44);\r\nroce_write(hr_dev, ROCEE_EXT_DB_SQ_H_REG, val);\r\ndev_dbg(dev, "ext SDB depth: 0x%x\n", db->ext_db->esdb_dep);\r\ndev_dbg(dev, "ext SDB threshold: epmty: 0x%x, ful: 0x%x\n",\r\next_sdb_alept, ext_sdb_alful);\r\n}\r\nstatic void hns_roce_set_odb_ext(struct hns_roce_dev *hr_dev, u32 ext_odb_alept,\r\nu32 ext_odb_alful)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_v1_priv *priv;\r\nstruct hns_roce_db_table *db;\r\ndma_addr_t odb_dma_addr;\r\nu32 val;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\ndb = &priv->db_table;\r\nroce_write(hr_dev, ROCEE_EXT_DB_OTHERS_WL_EMPTY_REG, ext_odb_alept);\r\nroce_write(hr_dev, ROCEE_EXT_DB_OTHERS_WL_REG, ext_odb_alful);\r\nodb_dma_addr = db->ext_db->odb_buf_list->map;\r\nroce_write(hr_dev, ROCEE_EXT_DB_OTH_REG, (u32)(odb_dma_addr >> 12));\r\nval = roce_read(hr_dev, ROCEE_EXT_DB_OTH_H_REG);\r\nroce_set_field(val, ROCEE_EXT_DB_OTH_H_EXT_DB_OTH_SHIFT_M,\r\nROCEE_EXT_DB_OTH_H_EXT_DB_OTH_SHIFT_S,\r\ndb->ext_db->eodb_dep);\r\nroce_set_field(val, ROCEE_EXT_DB_SQ_H_EXT_DB_OTH_BA_H_M,\r\nROCEE_EXT_DB_SQ_H_EXT_DB_OTH_BA_H_S,\r\ndb->ext_db->eodb_dep);\r\nroce_write(hr_dev, ROCEE_EXT_DB_OTH_H_REG, val);\r\ndev_dbg(dev, "ext ODB depth: 0x%x\n", db->ext_db->eodb_dep);\r\ndev_dbg(dev, "ext ODB threshold: empty: 0x%x, ful: 0x%x\n",\r\next_odb_alept, ext_odb_alful);\r\n}\r\nstatic int hns_roce_db_ext_init(struct hns_roce_dev *hr_dev, u32 sdb_ext_mod,\r\nu32 odb_ext_mod)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_v1_priv *priv;\r\nstruct hns_roce_db_table *db;\r\ndma_addr_t sdb_dma_addr;\r\ndma_addr_t odb_dma_addr;\r\nint ret = 0;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\ndb = &priv->db_table;\r\ndb->ext_db = kmalloc(sizeof(*db->ext_db), GFP_KERNEL);\r\nif (!db->ext_db)\r\nreturn -ENOMEM;\r\nif (sdb_ext_mod) {\r\ndb->ext_db->sdb_buf_list = kmalloc(\r\nsizeof(*db->ext_db->sdb_buf_list), GFP_KERNEL);\r\nif (!db->ext_db->sdb_buf_list) {\r\nret = -ENOMEM;\r\ngoto ext_sdb_buf_fail_out;\r\n}\r\ndb->ext_db->sdb_buf_list->buf = dma_alloc_coherent(dev,\r\nHNS_ROCE_V1_EXT_SDB_SIZE,\r\n&sdb_dma_addr, GFP_KERNEL);\r\nif (!db->ext_db->sdb_buf_list->buf) {\r\nret = -ENOMEM;\r\ngoto alloc_sq_db_buf_fail;\r\n}\r\ndb->ext_db->sdb_buf_list->map = sdb_dma_addr;\r\ndb->ext_db->esdb_dep = ilog2(HNS_ROCE_V1_EXT_SDB_DEPTH);\r\nhns_roce_set_sdb_ext(hr_dev, HNS_ROCE_V1_EXT_SDB_ALEPT,\r\nHNS_ROCE_V1_EXT_SDB_ALFUL);\r\n} else\r\nhns_roce_set_sdb(hr_dev, HNS_ROCE_V1_SDB_ALEPT,\r\nHNS_ROCE_V1_SDB_ALFUL);\r\nif (odb_ext_mod) {\r\ndb->ext_db->odb_buf_list = kmalloc(\r\nsizeof(*db->ext_db->odb_buf_list), GFP_KERNEL);\r\nif (!db->ext_db->odb_buf_list) {\r\nret = -ENOMEM;\r\ngoto ext_odb_buf_fail_out;\r\n}\r\ndb->ext_db->odb_buf_list->buf = dma_alloc_coherent(dev,\r\nHNS_ROCE_V1_EXT_ODB_SIZE,\r\n&odb_dma_addr, GFP_KERNEL);\r\nif (!db->ext_db->odb_buf_list->buf) {\r\nret = -ENOMEM;\r\ngoto alloc_otr_db_buf_fail;\r\n}\r\ndb->ext_db->odb_buf_list->map = odb_dma_addr;\r\ndb->ext_db->eodb_dep = ilog2(HNS_ROCE_V1_EXT_ODB_DEPTH);\r\nhns_roce_set_odb_ext(hr_dev, HNS_ROCE_V1_EXT_ODB_ALEPT,\r\nHNS_ROCE_V1_EXT_ODB_ALFUL);\r\n} else\r\nhns_roce_set_odb(hr_dev, HNS_ROCE_V1_ODB_ALEPT,\r\nHNS_ROCE_V1_ODB_ALFUL);\r\nhns_roce_set_db_ext_mode(hr_dev, sdb_ext_mod, odb_ext_mod);\r\nreturn 0;\r\nalloc_otr_db_buf_fail:\r\nkfree(db->ext_db->odb_buf_list);\r\next_odb_buf_fail_out:\r\nif (sdb_ext_mod) {\r\ndma_free_coherent(dev, HNS_ROCE_V1_EXT_SDB_SIZE,\r\ndb->ext_db->sdb_buf_list->buf,\r\ndb->ext_db->sdb_buf_list->map);\r\n}\r\nalloc_sq_db_buf_fail:\r\nif (sdb_ext_mod)\r\nkfree(db->ext_db->sdb_buf_list);\r\next_sdb_buf_fail_out:\r\nkfree(db->ext_db);\r\nreturn ret;\r\n}\r\nstatic struct hns_roce_qp *hns_roce_v1_create_lp_qp(struct hns_roce_dev *hr_dev,\r\nstruct ib_pd *pd)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct ib_qp_init_attr init_attr;\r\nstruct ib_qp *qp;\r\nmemset(&init_attr, 0, sizeof(struct ib_qp_init_attr));\r\ninit_attr.qp_type = IB_QPT_RC;\r\ninit_attr.sq_sig_type = IB_SIGNAL_ALL_WR;\r\ninit_attr.cap.max_recv_wr = HNS_ROCE_MIN_WQE_NUM;\r\ninit_attr.cap.max_send_wr = HNS_ROCE_MIN_WQE_NUM;\r\nqp = hns_roce_create_qp(pd, &init_attr, NULL);\r\nif (IS_ERR(qp)) {\r\ndev_err(dev, "Create loop qp for mr free failed!");\r\nreturn NULL;\r\n}\r\nreturn to_hr_qp(qp);\r\n}\r\nstatic int hns_roce_v1_rsv_lp_qp(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct hns_roce_caps *caps = &hr_dev->caps;\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct ib_cq_init_attr cq_init_attr;\r\nstruct hns_roce_free_mr *free_mr;\r\nstruct ib_qp_attr attr = { 0 };\r\nstruct hns_roce_v1_priv *priv;\r\nstruct hns_roce_qp *hr_qp;\r\nstruct ib_cq *cq;\r\nstruct ib_pd *pd;\r\nu64 subnet_prefix;\r\nint attr_mask = 0;\r\nint i;\r\nint ret;\r\nu8 phy_port;\r\nu8 sl;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\nfree_mr = &priv->free_mr;\r\ncq_init_attr.cqe = HNS_ROCE_MIN_WQE_NUM * 2;\r\ncq_init_attr.comp_vector = 0;\r\ncq = hns_roce_ib_create_cq(&hr_dev->ib_dev, &cq_init_attr, NULL, NULL);\r\nif (IS_ERR(cq)) {\r\ndev_err(dev, "Create cq for reseved loop qp failed!");\r\nreturn -ENOMEM;\r\n}\r\nfree_mr->mr_free_cq = to_hr_cq(cq);\r\nfree_mr->mr_free_cq->ib_cq.device = &hr_dev->ib_dev;\r\nfree_mr->mr_free_cq->ib_cq.uobject = NULL;\r\nfree_mr->mr_free_cq->ib_cq.comp_handler = NULL;\r\nfree_mr->mr_free_cq->ib_cq.event_handler = NULL;\r\nfree_mr->mr_free_cq->ib_cq.cq_context = NULL;\r\natomic_set(&free_mr->mr_free_cq->ib_cq.usecnt, 0);\r\npd = hns_roce_alloc_pd(&hr_dev->ib_dev, NULL, NULL);\r\nif (IS_ERR(pd)) {\r\ndev_err(dev, "Create pd for reseved loop qp failed!");\r\nret = -ENOMEM;\r\ngoto alloc_pd_failed;\r\n}\r\nfree_mr->mr_free_pd = to_hr_pd(pd);\r\nfree_mr->mr_free_pd->ibpd.device = &hr_dev->ib_dev;\r\nfree_mr->mr_free_pd->ibpd.uobject = NULL;\r\natomic_set(&free_mr->mr_free_pd->ibpd.usecnt, 0);\r\nattr.qp_access_flags = IB_ACCESS_REMOTE_WRITE;\r\nattr.pkey_index = 0;\r\nattr.min_rnr_timer = 0;\r\nattr.max_dest_rd_atomic = 0;\r\nattr.max_rd_atomic = 0;\r\nattr.rq_psn = 0x0808;\r\nattr.sq_psn = 0x0808;\r\nattr.retry_cnt = 7;\r\nattr.rnr_retry = 7;\r\nattr.timeout = 0x12;\r\nattr.path_mtu = IB_MTU_256;\r\nattr.ah_attr.ah_flags = 1;\r\nattr.ah_attr.static_rate = 3;\r\nattr.ah_attr.grh.sgid_index = 0;\r\nattr.ah_attr.grh.hop_limit = 1;\r\nattr.ah_attr.grh.flow_label = 0;\r\nattr.ah_attr.grh.traffic_class = 0;\r\nsubnet_prefix = cpu_to_be64(0xfe80000000000000LL);\r\nfor (i = 0; i < HNS_ROCE_V1_RESV_QP; i++) {\r\nfree_mr->mr_free_qp[i] = hns_roce_v1_create_lp_qp(hr_dev, pd);\r\nif (IS_ERR(free_mr->mr_free_qp[i])) {\r\ndev_err(dev, "Create loop qp failed!\n");\r\ngoto create_lp_qp_failed;\r\n}\r\nhr_qp = free_mr->mr_free_qp[i];\r\nsl = i / caps->num_ports;\r\nif (caps->num_ports == HNS_ROCE_MAX_PORTS)\r\nphy_port = (i >= HNS_ROCE_MAX_PORTS) ? (i - 2) :\r\n(i % caps->num_ports);\r\nelse\r\nphy_port = i % caps->num_ports;\r\nhr_qp->port = phy_port + 1;\r\nhr_qp->phy_port = phy_port;\r\nhr_qp->ibqp.qp_type = IB_QPT_RC;\r\nhr_qp->ibqp.device = &hr_dev->ib_dev;\r\nhr_qp->ibqp.uobject = NULL;\r\natomic_set(&hr_qp->ibqp.usecnt, 0);\r\nhr_qp->ibqp.pd = pd;\r\nhr_qp->ibqp.recv_cq = cq;\r\nhr_qp->ibqp.send_cq = cq;\r\nattr.ah_attr.port_num = phy_port + 1;\r\nattr.ah_attr.sl = sl;\r\nattr.port_num = phy_port + 1;\r\nattr.dest_qp_num = hr_qp->qpn;\r\nmemcpy(attr.ah_attr.dmac, hr_dev->dev_addr[phy_port],\r\nMAC_ADDR_OCTET_NUM);\r\nmemcpy(attr.ah_attr.grh.dgid.raw,\r\n&subnet_prefix, sizeof(u64));\r\nmemcpy(&attr.ah_attr.grh.dgid.raw[8],\r\nhr_dev->dev_addr[phy_port], 3);\r\nmemcpy(&attr.ah_attr.grh.dgid.raw[13],\r\nhr_dev->dev_addr[phy_port] + 3, 3);\r\nattr.ah_attr.grh.dgid.raw[11] = 0xff;\r\nattr.ah_attr.grh.dgid.raw[12] = 0xfe;\r\nattr.ah_attr.grh.dgid.raw[8] ^= 2;\r\nattr_mask |= IB_QP_PORT;\r\nret = hr_dev->hw->modify_qp(&hr_qp->ibqp, &attr, attr_mask,\r\nIB_QPS_RESET, IB_QPS_INIT);\r\nif (ret) {\r\ndev_err(dev, "modify qp failed(%d)!\n", ret);\r\ngoto create_lp_qp_failed;\r\n}\r\nret = hr_dev->hw->modify_qp(&hr_qp->ibqp, &attr, attr_mask,\r\nIB_QPS_INIT, IB_QPS_RTR);\r\nif (ret) {\r\ndev_err(dev, "modify qp failed(%d)!\n", ret);\r\ngoto create_lp_qp_failed;\r\n}\r\nret = hr_dev->hw->modify_qp(&hr_qp->ibqp, &attr, attr_mask,\r\nIB_QPS_RTR, IB_QPS_RTS);\r\nif (ret) {\r\ndev_err(dev, "modify qp failed(%d)!\n", ret);\r\ngoto create_lp_qp_failed;\r\n}\r\n}\r\nreturn 0;\r\ncreate_lp_qp_failed:\r\nfor (i -= 1; i >= 0; i--) {\r\nhr_qp = free_mr->mr_free_qp[i];\r\nif (hns_roce_v1_destroy_qp(&hr_qp->ibqp))\r\ndev_err(dev, "Destroy qp %d for mr free failed!\n", i);\r\n}\r\nif (hns_roce_dealloc_pd(pd))\r\ndev_err(dev, "Destroy pd for create_lp_qp failed!\n");\r\nalloc_pd_failed:\r\nif (hns_roce_ib_destroy_cq(cq))\r\ndev_err(dev, "Destroy cq for create_lp_qp failed!\n");\r\nreturn -EINVAL;\r\n}\r\nstatic void hns_roce_v1_release_lp_qp(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_free_mr *free_mr;\r\nstruct hns_roce_v1_priv *priv;\r\nstruct hns_roce_qp *hr_qp;\r\nint ret;\r\nint i;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\nfree_mr = &priv->free_mr;\r\nfor (i = 0; i < HNS_ROCE_V1_RESV_QP; i++) {\r\nhr_qp = free_mr->mr_free_qp[i];\r\nret = hns_roce_v1_destroy_qp(&hr_qp->ibqp);\r\nif (ret)\r\ndev_err(dev, "Destroy qp %d for mr free failed(%d)!\n",\r\ni, ret);\r\n}\r\nret = hns_roce_ib_destroy_cq(&free_mr->mr_free_cq->ib_cq);\r\nif (ret)\r\ndev_err(dev, "Destroy cq for mr_free failed(%d)!\n", ret);\r\nret = hns_roce_dealloc_pd(&free_mr->mr_free_pd->ibpd);\r\nif (ret)\r\ndev_err(dev, "Destroy pd for mr_free failed(%d)!\n", ret);\r\n}\r\nstatic int hns_roce_db_init(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_v1_priv *priv;\r\nstruct hns_roce_db_table *db;\r\nu32 sdb_ext_mod;\r\nu32 odb_ext_mod;\r\nu32 sdb_evt_mod;\r\nu32 odb_evt_mod;\r\nint ret = 0;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\ndb = &priv->db_table;\r\nmemset(db, 0, sizeof(*db));\r\nsdb_ext_mod = HNS_ROCE_SDB_EXTEND_MODE;\r\nodb_ext_mod = HNS_ROCE_ODB_EXTEND_MODE;\r\nsdb_evt_mod = HNS_ROCE_SDB_NORMAL_MODE;\r\nodb_evt_mod = HNS_ROCE_ODB_POLL_MODE;\r\ndb->sdb_ext_mod = sdb_ext_mod;\r\ndb->odb_ext_mod = odb_ext_mod;\r\nret = hns_roce_db_ext_init(hr_dev, sdb_ext_mod, odb_ext_mod);\r\nif (ret) {\r\ndev_err(dev, "Failed in extend DB configuration.\n");\r\nreturn ret;\r\n}\r\nhns_roce_set_db_event_mode(hr_dev, sdb_evt_mod, odb_evt_mod);\r\nreturn 0;\r\n}\r\nvoid hns_roce_v1_recreate_lp_qp_work_fn(struct work_struct *work)\r\n{\r\nstruct hns_roce_recreate_lp_qp_work *lp_qp_work;\r\nstruct hns_roce_dev *hr_dev;\r\nlp_qp_work = container_of(work, struct hns_roce_recreate_lp_qp_work,\r\nwork);\r\nhr_dev = to_hr_dev(lp_qp_work->ib_dev);\r\nhns_roce_v1_release_lp_qp(hr_dev);\r\nif (hns_roce_v1_rsv_lp_qp(hr_dev))\r\ndev_err(&hr_dev->pdev->dev, "create reserver qp failed\n");\r\nif (lp_qp_work->comp_flag)\r\ncomplete(lp_qp_work->comp);\r\nkfree(lp_qp_work);\r\n}\r\nstatic int hns_roce_v1_recreate_lp_qp(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_recreate_lp_qp_work *lp_qp_work;\r\nstruct hns_roce_free_mr *free_mr;\r\nstruct hns_roce_v1_priv *priv;\r\nstruct completion comp;\r\nunsigned long end =\r\nmsecs_to_jiffies(HNS_ROCE_V1_RECREATE_LP_QP_TIMEOUT_MSECS) + jiffies;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\nfree_mr = &priv->free_mr;\r\nlp_qp_work = kzalloc(sizeof(struct hns_roce_recreate_lp_qp_work),\r\nGFP_KERNEL);\r\nINIT_WORK(&(lp_qp_work->work), hns_roce_v1_recreate_lp_qp_work_fn);\r\nlp_qp_work->ib_dev = &(hr_dev->ib_dev);\r\nlp_qp_work->comp = &comp;\r\nlp_qp_work->comp_flag = 1;\r\ninit_completion(lp_qp_work->comp);\r\nqueue_work(free_mr->free_mr_wq, &(lp_qp_work->work));\r\nwhile (time_before_eq(jiffies, end)) {\r\nif (try_wait_for_completion(&comp))\r\nreturn 0;\r\nmsleep(HNS_ROCE_V1_RECREATE_LP_QP_WAIT_VALUE);\r\n}\r\nlp_qp_work->comp_flag = 0;\r\nif (try_wait_for_completion(&comp))\r\nreturn 0;\r\ndev_warn(dev, "recreate lp qp failed 20s timeout and return failed!\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int hns_roce_v1_send_lp_wqe(struct hns_roce_qp *hr_qp)\r\n{\r\nstruct hns_roce_dev *hr_dev = to_hr_dev(hr_qp->ibqp.device);\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct ib_send_wr send_wr, *bad_wr;\r\nint ret;\r\nmemset(&send_wr, 0, sizeof(send_wr));\r\nsend_wr.next = NULL;\r\nsend_wr.num_sge = 0;\r\nsend_wr.send_flags = 0;\r\nsend_wr.sg_list = NULL;\r\nsend_wr.wr_id = (unsigned long long)&send_wr;\r\nsend_wr.opcode = IB_WR_RDMA_WRITE;\r\nret = hns_roce_v1_post_send(&hr_qp->ibqp, &send_wr, &bad_wr);\r\nif (ret) {\r\ndev_err(dev, "Post write wqe for mr free failed(%d)!", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void hns_roce_v1_mr_free_work_fn(struct work_struct *work)\r\n{\r\nstruct hns_roce_mr_free_work *mr_work;\r\nstruct ib_wc wc[HNS_ROCE_V1_RESV_QP];\r\nstruct hns_roce_free_mr *free_mr;\r\nstruct hns_roce_cq *mr_free_cq;\r\nstruct hns_roce_v1_priv *priv;\r\nstruct hns_roce_dev *hr_dev;\r\nstruct hns_roce_mr *hr_mr;\r\nstruct hns_roce_qp *hr_qp;\r\nstruct device *dev;\r\nunsigned long end =\r\nmsecs_to_jiffies(HNS_ROCE_V1_FREE_MR_TIMEOUT_MSECS) + jiffies;\r\nint i;\r\nint ret;\r\nint ne;\r\nmr_work = container_of(work, struct hns_roce_mr_free_work, work);\r\nhr_mr = (struct hns_roce_mr *)mr_work->mr;\r\nhr_dev = to_hr_dev(mr_work->ib_dev);\r\ndev = &hr_dev->pdev->dev;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\nfree_mr = &priv->free_mr;\r\nmr_free_cq = free_mr->mr_free_cq;\r\nfor (i = 0; i < HNS_ROCE_V1_RESV_QP; i++) {\r\nhr_qp = free_mr->mr_free_qp[i];\r\nret = hns_roce_v1_send_lp_wqe(hr_qp);\r\nif (ret) {\r\ndev_err(dev,\r\n"Send wqe (qp:0x%lx) for mr free failed(%d)!\n",\r\nhr_qp->qpn, ret);\r\ngoto free_work;\r\n}\r\n}\r\nne = HNS_ROCE_V1_RESV_QP;\r\ndo {\r\nret = hns_roce_v1_poll_cq(&mr_free_cq->ib_cq, ne, wc);\r\nif (ret < 0) {\r\ndev_err(dev,\r\n"(qp:0x%lx) starts, Poll cqe failed(%d) for mr 0x%x free! Remain %d cqe\n",\r\nhr_qp->qpn, ret, hr_mr->key, ne);\r\ngoto free_work;\r\n}\r\nne -= ret;\r\nmsleep(HNS_ROCE_V1_FREE_MR_WAIT_VALUE);\r\n} while (ne && time_before_eq(jiffies, end));\r\nif (ne != 0)\r\ndev_err(dev,\r\n"Poll cqe for mr 0x%x free timeout! Remain %d cqe\n",\r\nhr_mr->key, ne);\r\nfree_work:\r\nif (mr_work->comp_flag)\r\ncomplete(mr_work->comp);\r\nkfree(mr_work);\r\n}\r\nint hns_roce_v1_dereg_mr(struct hns_roce_dev *hr_dev, struct hns_roce_mr *mr)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_mr_free_work *mr_work;\r\nstruct hns_roce_free_mr *free_mr;\r\nstruct hns_roce_v1_priv *priv;\r\nstruct completion comp;\r\nunsigned long end =\r\nmsecs_to_jiffies(HNS_ROCE_V1_FREE_MR_TIMEOUT_MSECS) + jiffies;\r\nunsigned long start = jiffies;\r\nint npages;\r\nint ret = 0;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\nfree_mr = &priv->free_mr;\r\nif (mr->enabled) {\r\nif (hns_roce_hw2sw_mpt(hr_dev, NULL, key_to_hw_index(mr->key)\r\n& (hr_dev->caps.num_mtpts - 1)))\r\ndev_warn(dev, "HW2SW_MPT failed!\n");\r\n}\r\nmr_work = kzalloc(sizeof(*mr_work), GFP_KERNEL);\r\nif (!mr_work) {\r\nret = -ENOMEM;\r\ngoto free_mr;\r\n}\r\nINIT_WORK(&(mr_work->work), hns_roce_v1_mr_free_work_fn);\r\nmr_work->ib_dev = &(hr_dev->ib_dev);\r\nmr_work->comp = &comp;\r\nmr_work->comp_flag = 1;\r\nmr_work->mr = (void *)mr;\r\ninit_completion(mr_work->comp);\r\nqueue_work(free_mr->free_mr_wq, &(mr_work->work));\r\nwhile (time_before_eq(jiffies, end)) {\r\nif (try_wait_for_completion(&comp))\r\ngoto free_mr;\r\nmsleep(HNS_ROCE_V1_FREE_MR_WAIT_VALUE);\r\n}\r\nmr_work->comp_flag = 0;\r\nif (try_wait_for_completion(&comp))\r\ngoto free_mr;\r\ndev_warn(dev, "Free mr work 0x%x over 50s and failed!\n", mr->key);\r\nret = -ETIMEDOUT;\r\nfree_mr:\r\ndev_dbg(dev, "Free mr 0x%x use 0x%x us.\n",\r\nmr->key, jiffies_to_usecs(jiffies) - jiffies_to_usecs(start));\r\nif (mr->size != ~0ULL) {\r\nnpages = ib_umem_page_count(mr->umem);\r\ndma_free_coherent(dev, npages * 8, mr->pbl_buf,\r\nmr->pbl_dma_addr);\r\n}\r\nhns_roce_bitmap_free(&hr_dev->mr_table.mtpt_bitmap,\r\nkey_to_hw_index(mr->key), 0);\r\nif (mr->umem)\r\nib_umem_release(mr->umem);\r\nkfree(mr);\r\nreturn ret;\r\n}\r\nstatic void hns_roce_db_free(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_v1_priv *priv;\r\nstruct hns_roce_db_table *db;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\ndb = &priv->db_table;\r\nif (db->sdb_ext_mod) {\r\ndma_free_coherent(dev, HNS_ROCE_V1_EXT_SDB_SIZE,\r\ndb->ext_db->sdb_buf_list->buf,\r\ndb->ext_db->sdb_buf_list->map);\r\nkfree(db->ext_db->sdb_buf_list);\r\n}\r\nif (db->odb_ext_mod) {\r\ndma_free_coherent(dev, HNS_ROCE_V1_EXT_ODB_SIZE,\r\ndb->ext_db->odb_buf_list->buf,\r\ndb->ext_db->odb_buf_list->map);\r\nkfree(db->ext_db->odb_buf_list);\r\n}\r\nkfree(db->ext_db);\r\n}\r\nstatic int hns_roce_raq_init(struct hns_roce_dev *hr_dev)\r\n{\r\nint ret;\r\nint raq_shift = 0;\r\ndma_addr_t addr;\r\nu32 val;\r\nstruct hns_roce_v1_priv *priv;\r\nstruct hns_roce_raq_table *raq;\r\nstruct device *dev = &hr_dev->pdev->dev;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\nraq = &priv->raq_table;\r\nraq->e_raq_buf = kzalloc(sizeof(*(raq->e_raq_buf)), GFP_KERNEL);\r\nif (!raq->e_raq_buf)\r\nreturn -ENOMEM;\r\nraq->e_raq_buf->buf = dma_alloc_coherent(dev, HNS_ROCE_V1_RAQ_SIZE,\r\n&addr, GFP_KERNEL);\r\nif (!raq->e_raq_buf->buf) {\r\nret = -ENOMEM;\r\ngoto err_dma_alloc_raq;\r\n}\r\nraq->e_raq_buf->map = addr;\r\nroce_write(hr_dev, ROCEE_EXT_RAQ_REG, raq->e_raq_buf->map >> 12);\r\nraq_shift = ilog2(HNS_ROCE_V1_RAQ_SIZE / HNS_ROCE_V1_RAQ_ENTRY);\r\nval = roce_read(hr_dev, ROCEE_EXT_RAQ_H_REG);\r\nroce_set_field(val, ROCEE_EXT_RAQ_H_EXT_RAQ_SHIFT_M,\r\nROCEE_EXT_RAQ_H_EXT_RAQ_SHIFT_S, raq_shift);\r\nroce_set_field(val, ROCEE_EXT_RAQ_H_EXT_RAQ_BA_H_M,\r\nROCEE_EXT_RAQ_H_EXT_RAQ_BA_H_S,\r\nraq->e_raq_buf->map >> 44);\r\nroce_write(hr_dev, ROCEE_EXT_RAQ_H_REG, val);\r\ndev_dbg(dev, "Configure raq_shift 0x%x.\n", val);\r\nval = roce_read(hr_dev, ROCEE_RAQ_WL_REG);\r\nroce_set_field(val, ROCEE_RAQ_WL_ROCEE_RAQ_WL_M,\r\nROCEE_RAQ_WL_ROCEE_RAQ_WL_S,\r\nHNS_ROCE_V1_EXT_RAQ_WF);\r\nroce_write(hr_dev, ROCEE_RAQ_WL_REG, val);\r\ndev_dbg(dev, "Configure raq_wl 0x%x.\n", val);\r\nval = roce_read(hr_dev, ROCEE_WRMS_POL_TIME_INTERVAL_REG);\r\nroce_set_field(val,\r\nROCEE_WRMS_POL_TIME_INTERVAL_WRMS_POL_TIME_INTERVAL_M,\r\nROCEE_WRMS_POL_TIME_INTERVAL_WRMS_POL_TIME_INTERVAL_S,\r\nPOL_TIME_INTERVAL_VAL);\r\nroce_set_bit(val, ROCEE_WRMS_POL_TIME_INTERVAL_WRMS_EXT_RAQ_MODE, 1);\r\nroce_set_field(val,\r\nROCEE_WRMS_POL_TIME_INTERVAL_WRMS_RAQ_TIMEOUT_CHK_CFG_M,\r\nROCEE_WRMS_POL_TIME_INTERVAL_WRMS_RAQ_TIMEOUT_CHK_CFG_S,\r\n2);\r\nroce_set_bit(val,\r\nROCEE_WRMS_POL_TIME_INTERVAL_WRMS_RAQ_TIMEOUT_CHK_EN_S, 1);\r\nroce_write(hr_dev, ROCEE_WRMS_POL_TIME_INTERVAL_REG, val);\r\ndev_dbg(dev, "Configure WrmsPolTimeInterval 0x%x.\n", val);\r\nval = roce_read(hr_dev, ROCEE_GLB_CFG_REG);\r\nroce_set_bit(val, ROCEE_GLB_CFG_TRP_RAQ_DROP_EN_S, 1);\r\nroce_write(hr_dev, ROCEE_GLB_CFG_REG, val);\r\ndev_dbg(dev, "Configure GlbCfg = 0x%x.\n", val);\r\nreturn 0;\r\nerr_dma_alloc_raq:\r\nkfree(raq->e_raq_buf);\r\nreturn ret;\r\n}\r\nstatic void hns_roce_raq_free(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_v1_priv *priv;\r\nstruct hns_roce_raq_table *raq;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\nraq = &priv->raq_table;\r\ndma_free_coherent(dev, HNS_ROCE_V1_RAQ_SIZE, raq->e_raq_buf->buf,\r\nraq->e_raq_buf->map);\r\nkfree(raq->e_raq_buf);\r\n}\r\nstatic void hns_roce_port_enable(struct hns_roce_dev *hr_dev, int enable_flag)\r\n{\r\nu32 val;\r\nif (enable_flag) {\r\nval = roce_read(hr_dev, ROCEE_GLB_CFG_REG);\r\nroce_set_field(val, ROCEE_GLB_CFG_ROCEE_PORT_ST_M,\r\nROCEE_GLB_CFG_ROCEE_PORT_ST_S,\r\nALL_PORT_VAL_OPEN);\r\nroce_write(hr_dev, ROCEE_GLB_CFG_REG, val);\r\n} else {\r\nval = roce_read(hr_dev, ROCEE_GLB_CFG_REG);\r\nroce_set_field(val, ROCEE_GLB_CFG_ROCEE_PORT_ST_M,\r\nROCEE_GLB_CFG_ROCEE_PORT_ST_S, 0x0);\r\nroce_write(hr_dev, ROCEE_GLB_CFG_REG, val);\r\n}\r\n}\r\nstatic int hns_roce_bt_init(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_v1_priv *priv;\r\nint ret;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\npriv->bt_table.qpc_buf.buf = dma_alloc_coherent(dev,\r\nHNS_ROCE_BT_RSV_BUF_SIZE, &priv->bt_table.qpc_buf.map,\r\nGFP_KERNEL);\r\nif (!priv->bt_table.qpc_buf.buf)\r\nreturn -ENOMEM;\r\npriv->bt_table.mtpt_buf.buf = dma_alloc_coherent(dev,\r\nHNS_ROCE_BT_RSV_BUF_SIZE, &priv->bt_table.mtpt_buf.map,\r\nGFP_KERNEL);\r\nif (!priv->bt_table.mtpt_buf.buf) {\r\nret = -ENOMEM;\r\ngoto err_failed_alloc_mtpt_buf;\r\n}\r\npriv->bt_table.cqc_buf.buf = dma_alloc_coherent(dev,\r\nHNS_ROCE_BT_RSV_BUF_SIZE, &priv->bt_table.cqc_buf.map,\r\nGFP_KERNEL);\r\nif (!priv->bt_table.cqc_buf.buf) {\r\nret = -ENOMEM;\r\ngoto err_failed_alloc_cqc_buf;\r\n}\r\nreturn 0;\r\nerr_failed_alloc_cqc_buf:\r\ndma_free_coherent(dev, HNS_ROCE_BT_RSV_BUF_SIZE,\r\npriv->bt_table.mtpt_buf.buf, priv->bt_table.mtpt_buf.map);\r\nerr_failed_alloc_mtpt_buf:\r\ndma_free_coherent(dev, HNS_ROCE_BT_RSV_BUF_SIZE,\r\npriv->bt_table.qpc_buf.buf, priv->bt_table.qpc_buf.map);\r\nreturn ret;\r\n}\r\nstatic void hns_roce_bt_free(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_v1_priv *priv;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\ndma_free_coherent(dev, HNS_ROCE_BT_RSV_BUF_SIZE,\r\npriv->bt_table.cqc_buf.buf, priv->bt_table.cqc_buf.map);\r\ndma_free_coherent(dev, HNS_ROCE_BT_RSV_BUF_SIZE,\r\npriv->bt_table.mtpt_buf.buf, priv->bt_table.mtpt_buf.map);\r\ndma_free_coherent(dev, HNS_ROCE_BT_RSV_BUF_SIZE,\r\npriv->bt_table.qpc_buf.buf, priv->bt_table.qpc_buf.map);\r\n}\r\nstatic int hns_roce_tptr_init(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_buf_list *tptr_buf;\r\nstruct hns_roce_v1_priv *priv;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\ntptr_buf = &priv->tptr_table.tptr_buf;\r\ntptr_buf->buf = dma_alloc_coherent(dev, HNS_ROCE_V1_TPTR_BUF_SIZE,\r\n&tptr_buf->map, GFP_KERNEL);\r\nif (!tptr_buf->buf)\r\nreturn -ENOMEM;\r\nhr_dev->tptr_dma_addr = tptr_buf->map;\r\nhr_dev->tptr_size = HNS_ROCE_V1_TPTR_BUF_SIZE;\r\nreturn 0;\r\n}\r\nstatic void hns_roce_tptr_free(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_buf_list *tptr_buf;\r\nstruct hns_roce_v1_priv *priv;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\ntptr_buf = &priv->tptr_table.tptr_buf;\r\ndma_free_coherent(dev, HNS_ROCE_V1_TPTR_BUF_SIZE,\r\ntptr_buf->buf, tptr_buf->map);\r\n}\r\nstatic int hns_roce_free_mr_init(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_free_mr *free_mr;\r\nstruct hns_roce_v1_priv *priv;\r\nint ret = 0;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\nfree_mr = &priv->free_mr;\r\nfree_mr->free_mr_wq = create_singlethread_workqueue("hns_roce_free_mr");\r\nif (!free_mr->free_mr_wq) {\r\ndev_err(dev, "Create free mr workqueue failed!\n");\r\nreturn -ENOMEM;\r\n}\r\nret = hns_roce_v1_rsv_lp_qp(hr_dev);\r\nif (ret) {\r\ndev_err(dev, "Reserved loop qp failed(%d)!\n", ret);\r\nflush_workqueue(free_mr->free_mr_wq);\r\ndestroy_workqueue(free_mr->free_mr_wq);\r\n}\r\nreturn ret;\r\n}\r\nstatic void hns_roce_free_mr_free(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct hns_roce_free_mr *free_mr;\r\nstruct hns_roce_v1_priv *priv;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\nfree_mr = &priv->free_mr;\r\nflush_workqueue(free_mr->free_mr_wq);\r\ndestroy_workqueue(free_mr->free_mr_wq);\r\nhns_roce_v1_release_lp_qp(hr_dev);\r\n}\r\nint hns_roce_v1_reset(struct hns_roce_dev *hr_dev, bool dereset)\r\n{\r\nstruct device_node *dsaf_node;\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct fwnode_handle *fwnode;\r\nint ret;\r\nif (dev_of_node(dev)) {\r\ndsaf_node = of_parse_phandle(np, "dsaf-handle", 0);\r\nif (!dsaf_node) {\r\ndev_err(dev, "could not find dsaf-handle\n");\r\nreturn -EINVAL;\r\n}\r\nfwnode = &dsaf_node->fwnode;\r\n} else if (is_acpi_device_node(dev->fwnode)) {\r\nstruct acpi_reference_args args;\r\nret = acpi_node_get_property_reference(dev->fwnode,\r\n"dsaf-handle", 0, &args);\r\nif (ret) {\r\ndev_err(dev, "could not find dsaf-handle\n");\r\nreturn ret;\r\n}\r\nfwnode = acpi_fwnode_handle(args.adev);\r\n} else {\r\ndev_err(dev, "cannot read data from DT or ACPI\n");\r\nreturn -ENXIO;\r\n}\r\nret = hns_dsaf_roce_reset(fwnode, false);\r\nif (ret)\r\nreturn ret;\r\nif (dereset) {\r\nmsleep(SLEEP_TIME_INTERVAL);\r\nret = hns_dsaf_roce_reset(fwnode, true);\r\n}\r\nreturn ret;\r\n}\r\nstatic int hns_roce_des_qp_init(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_v1_priv *priv;\r\nstruct hns_roce_des_qp *des_qp;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\ndes_qp = &priv->des_qp;\r\ndes_qp->requeue_flag = 1;\r\ndes_qp->qp_wq = create_singlethread_workqueue("hns_roce_destroy_qp");\r\nif (!des_qp->qp_wq) {\r\ndev_err(dev, "Create destroy qp workqueue failed!\n");\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nstatic void hns_roce_des_qp_free(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct hns_roce_v1_priv *priv;\r\nstruct hns_roce_des_qp *des_qp;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\ndes_qp = &priv->des_qp;\r\ndes_qp->requeue_flag = 0;\r\nflush_workqueue(des_qp->qp_wq);\r\ndestroy_workqueue(des_qp->qp_wq);\r\n}\r\nvoid hns_roce_v1_profile(struct hns_roce_dev *hr_dev)\r\n{\r\nint i = 0;\r\nstruct hns_roce_caps *caps = &hr_dev->caps;\r\nhr_dev->vendor_id = le32_to_cpu(roce_read(hr_dev, ROCEE_VENDOR_ID_REG));\r\nhr_dev->vendor_part_id = le32_to_cpu(roce_read(hr_dev,\r\nROCEE_VENDOR_PART_ID_REG));\r\nhr_dev->sys_image_guid = le32_to_cpu(roce_read(hr_dev,\r\nROCEE_SYS_IMAGE_GUID_L_REG)) |\r\n((u64)le32_to_cpu(roce_read(hr_dev,\r\nROCEE_SYS_IMAGE_GUID_H_REG)) << 32);\r\nhr_dev->hw_rev = HNS_ROCE_HW_VER1;\r\ncaps->num_qps = HNS_ROCE_V1_MAX_QP_NUM;\r\ncaps->max_wqes = HNS_ROCE_V1_MAX_WQE_NUM;\r\ncaps->num_cqs = HNS_ROCE_V1_MAX_CQ_NUM;\r\ncaps->max_cqes = HNS_ROCE_V1_MAX_CQE_NUM;\r\ncaps->max_sq_sg = HNS_ROCE_V1_SG_NUM;\r\ncaps->max_rq_sg = HNS_ROCE_V1_SG_NUM;\r\ncaps->max_sq_inline = HNS_ROCE_V1_INLINE_SIZE;\r\ncaps->num_uars = HNS_ROCE_V1_UAR_NUM;\r\ncaps->phy_num_uars = HNS_ROCE_V1_PHY_UAR_NUM;\r\ncaps->num_aeq_vectors = HNS_ROCE_AEQE_VEC_NUM;\r\ncaps->num_comp_vectors = HNS_ROCE_COMP_VEC_NUM;\r\ncaps->num_other_vectors = HNS_ROCE_AEQE_OF_VEC_NUM;\r\ncaps->num_mtpts = HNS_ROCE_V1_MAX_MTPT_NUM;\r\ncaps->num_mtt_segs = HNS_ROCE_V1_MAX_MTT_SEGS;\r\ncaps->num_pds = HNS_ROCE_V1_MAX_PD_NUM;\r\ncaps->max_qp_init_rdma = HNS_ROCE_V1_MAX_QP_INIT_RDMA;\r\ncaps->max_qp_dest_rdma = HNS_ROCE_V1_MAX_QP_DEST_RDMA;\r\ncaps->max_sq_desc_sz = HNS_ROCE_V1_MAX_SQ_DESC_SZ;\r\ncaps->max_rq_desc_sz = HNS_ROCE_V1_MAX_RQ_DESC_SZ;\r\ncaps->qpc_entry_sz = HNS_ROCE_V1_QPC_ENTRY_SIZE;\r\ncaps->irrl_entry_sz = HNS_ROCE_V1_IRRL_ENTRY_SIZE;\r\ncaps->cqc_entry_sz = HNS_ROCE_V1_CQC_ENTRY_SIZE;\r\ncaps->mtpt_entry_sz = HNS_ROCE_V1_MTPT_ENTRY_SIZE;\r\ncaps->mtt_entry_sz = HNS_ROCE_V1_MTT_ENTRY_SIZE;\r\ncaps->cq_entry_sz = HNS_ROCE_V1_CQE_ENTRY_SIZE;\r\ncaps->page_size_cap = HNS_ROCE_V1_PAGE_SIZE_SUPPORT;\r\ncaps->reserved_lkey = 0;\r\ncaps->reserved_pds = 0;\r\ncaps->reserved_mrws = 1;\r\ncaps->reserved_uars = 0;\r\ncaps->reserved_cqs = 0;\r\nfor (i = 0; i < caps->num_ports; i++)\r\ncaps->pkey_table_len[i] = 1;\r\nfor (i = 0; i < caps->num_ports; i++) {\r\nif (i >= (HNS_ROCE_V1_GID_NUM % caps->num_ports))\r\ncaps->gid_table_len[i] = HNS_ROCE_V1_GID_NUM /\r\ncaps->num_ports;\r\nelse\r\ncaps->gid_table_len[i] = HNS_ROCE_V1_GID_NUM /\r\ncaps->num_ports + 1;\r\n}\r\nfor (i = 0; i < caps->num_comp_vectors; i++)\r\ncaps->ceqe_depth[i] = HNS_ROCE_V1_NUM_COMP_EQE;\r\ncaps->aeqe_depth = HNS_ROCE_V1_NUM_ASYNC_EQE;\r\ncaps->local_ca_ack_delay = le32_to_cpu(roce_read(hr_dev,\r\nROCEE_ACK_DELAY_REG));\r\ncaps->max_mtu = IB_MTU_2048;\r\n}\r\nint hns_roce_v1_init(struct hns_roce_dev *hr_dev)\r\n{\r\nint ret;\r\nu32 val;\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nval = roce_read(hr_dev, ROCEE_DMAE_USER_CFG1_REG);\r\nroce_set_field(val, ROCEE_DMAE_USER_CFG1_ROCEE_CACHE_TB_CFG_M,\r\nROCEE_DMAE_USER_CFG1_ROCEE_CACHE_TB_CFG_S, 0xf);\r\nroce_set_field(val, ROCEE_DMAE_USER_CFG1_ROCEE_STREAM_ID_TB_CFG_M,\r\nROCEE_DMAE_USER_CFG1_ROCEE_STREAM_ID_TB_CFG_S,\r\n1 << PAGES_SHIFT_16);\r\nroce_write(hr_dev, ROCEE_DMAE_USER_CFG1_REG, val);\r\nval = roce_read(hr_dev, ROCEE_DMAE_USER_CFG2_REG);\r\nroce_set_field(val, ROCEE_DMAE_USER_CFG2_ROCEE_CACHE_PKT_CFG_M,\r\nROCEE_DMAE_USER_CFG2_ROCEE_CACHE_PKT_CFG_S, 0xf);\r\nroce_set_field(val, ROCEE_DMAE_USER_CFG2_ROCEE_STREAM_ID_PKT_CFG_M,\r\nROCEE_DMAE_USER_CFG2_ROCEE_STREAM_ID_PKT_CFG_S,\r\n1 << PAGES_SHIFT_16);\r\nret = hns_roce_db_init(hr_dev);\r\nif (ret) {\r\ndev_err(dev, "doorbell init failed!\n");\r\nreturn ret;\r\n}\r\nret = hns_roce_raq_init(hr_dev);\r\nif (ret) {\r\ndev_err(dev, "raq init failed!\n");\r\ngoto error_failed_raq_init;\r\n}\r\nret = hns_roce_bt_init(hr_dev);\r\nif (ret) {\r\ndev_err(dev, "bt init failed!\n");\r\ngoto error_failed_bt_init;\r\n}\r\nret = hns_roce_tptr_init(hr_dev);\r\nif (ret) {\r\ndev_err(dev, "tptr init failed!\n");\r\ngoto error_failed_tptr_init;\r\n}\r\nret = hns_roce_des_qp_init(hr_dev);\r\nif (ret) {\r\ndev_err(dev, "des qp init failed!\n");\r\ngoto error_failed_des_qp_init;\r\n}\r\nret = hns_roce_free_mr_init(hr_dev);\r\nif (ret) {\r\ndev_err(dev, "free mr init failed!\n");\r\ngoto error_failed_free_mr_init;\r\n}\r\nhns_roce_port_enable(hr_dev, HNS_ROCE_PORT_UP);\r\nreturn 0;\r\nerror_failed_free_mr_init:\r\nhns_roce_des_qp_free(hr_dev);\r\nerror_failed_des_qp_init:\r\nhns_roce_tptr_free(hr_dev);\r\nerror_failed_tptr_init:\r\nhns_roce_bt_free(hr_dev);\r\nerror_failed_bt_init:\r\nhns_roce_raq_free(hr_dev);\r\nerror_failed_raq_init:\r\nhns_roce_db_free(hr_dev);\r\nreturn ret;\r\n}\r\nvoid hns_roce_v1_exit(struct hns_roce_dev *hr_dev)\r\n{\r\nhns_roce_port_enable(hr_dev, HNS_ROCE_PORT_DOWN);\r\nhns_roce_free_mr_free(hr_dev);\r\nhns_roce_des_qp_free(hr_dev);\r\nhns_roce_tptr_free(hr_dev);\r\nhns_roce_bt_free(hr_dev);\r\nhns_roce_raq_free(hr_dev);\r\nhns_roce_db_free(hr_dev);\r\n}\r\nvoid hns_roce_v1_set_gid(struct hns_roce_dev *hr_dev, u8 port, int gid_index,\r\nunion ib_gid *gid)\r\n{\r\nu32 *p = NULL;\r\nu8 gid_idx = 0;\r\ngid_idx = hns_get_gid_index(hr_dev, port, gid_index);\r\np = (u32 *)&gid->raw[0];\r\nroce_raw_write(*p, hr_dev->reg_base + ROCEE_PORT_GID_L_0_REG +\r\n(HNS_ROCE_V1_GID_NUM * gid_idx));\r\np = (u32 *)&gid->raw[4];\r\nroce_raw_write(*p, hr_dev->reg_base + ROCEE_PORT_GID_ML_0_REG +\r\n(HNS_ROCE_V1_GID_NUM * gid_idx));\r\np = (u32 *)&gid->raw[8];\r\nroce_raw_write(*p, hr_dev->reg_base + ROCEE_PORT_GID_MH_0_REG +\r\n(HNS_ROCE_V1_GID_NUM * gid_idx));\r\np = (u32 *)&gid->raw[0xc];\r\nroce_raw_write(*p, hr_dev->reg_base + ROCEE_PORT_GID_H_0_REG +\r\n(HNS_ROCE_V1_GID_NUM * gid_idx));\r\n}\r\nvoid hns_roce_v1_set_mac(struct hns_roce_dev *hr_dev, u8 phy_port, u8 *addr)\r\n{\r\nu32 reg_smac_l;\r\nu16 reg_smac_h;\r\nu16 *p_h;\r\nu32 *p;\r\nu32 val;\r\nif (hr_dev->hw->dereg_mr && hns_roce_v1_recreate_lp_qp(hr_dev))\r\ndev_warn(&hr_dev->pdev->dev, "recreate lp qp timeout!\n");\r\np = (u32 *)(&addr[0]);\r\nreg_smac_l = *p;\r\nroce_raw_write(reg_smac_l, hr_dev->reg_base + ROCEE_SMAC_L_0_REG +\r\nPHY_PORT_OFFSET * phy_port);\r\nval = roce_read(hr_dev,\r\nROCEE_SMAC_H_0_REG + phy_port * PHY_PORT_OFFSET);\r\np_h = (u16 *)(&addr[4]);\r\nreg_smac_h = *p_h;\r\nroce_set_field(val, ROCEE_SMAC_H_ROCEE_SMAC_H_M,\r\nROCEE_SMAC_H_ROCEE_SMAC_H_S, reg_smac_h);\r\nroce_write(hr_dev, ROCEE_SMAC_H_0_REG + phy_port * PHY_PORT_OFFSET,\r\nval);\r\n}\r\nvoid hns_roce_v1_set_mtu(struct hns_roce_dev *hr_dev, u8 phy_port,\r\nenum ib_mtu mtu)\r\n{\r\nu32 val;\r\nval = roce_read(hr_dev,\r\nROCEE_SMAC_H_0_REG + phy_port * PHY_PORT_OFFSET);\r\nroce_set_field(val, ROCEE_SMAC_H_ROCEE_PORT_MTU_M,\r\nROCEE_SMAC_H_ROCEE_PORT_MTU_S, mtu);\r\nroce_write(hr_dev, ROCEE_SMAC_H_0_REG + phy_port * PHY_PORT_OFFSET,\r\nval);\r\n}\r\nint hns_roce_v1_write_mtpt(void *mb_buf, struct hns_roce_mr *mr,\r\nunsigned long mtpt_idx)\r\n{\r\nstruct hns_roce_v1_mpt_entry *mpt_entry;\r\nstruct scatterlist *sg;\r\nu64 *pages;\r\nint entry;\r\nint i;\r\nmpt_entry = (struct hns_roce_v1_mpt_entry *)mb_buf;\r\nmemset(mpt_entry, 0, sizeof(*mpt_entry));\r\nroce_set_field(mpt_entry->mpt_byte_4, MPT_BYTE_4_KEY_STATE_M,\r\nMPT_BYTE_4_KEY_STATE_S, KEY_VALID);\r\nroce_set_field(mpt_entry->mpt_byte_4, MPT_BYTE_4_KEY_M,\r\nMPT_BYTE_4_KEY_S, mr->key);\r\nroce_set_field(mpt_entry->mpt_byte_4, MPT_BYTE_4_PAGE_SIZE_M,\r\nMPT_BYTE_4_PAGE_SIZE_S, MR_SIZE_4K);\r\nroce_set_bit(mpt_entry->mpt_byte_4, MPT_BYTE_4_MW_TYPE_S, 0);\r\nroce_set_bit(mpt_entry->mpt_byte_4, MPT_BYTE_4_MW_BIND_ENABLE_S,\r\n(mr->access & IB_ACCESS_MW_BIND ? 1 : 0));\r\nroce_set_bit(mpt_entry->mpt_byte_4, MPT_BYTE_4_OWN_S, 0);\r\nroce_set_field(mpt_entry->mpt_byte_4, MPT_BYTE_4_MEMORY_LOCATION_TYPE_M,\r\nMPT_BYTE_4_MEMORY_LOCATION_TYPE_S, mr->type);\r\nroce_set_bit(mpt_entry->mpt_byte_4, MPT_BYTE_4_REMOTE_ATOMIC_S, 0);\r\nroce_set_bit(mpt_entry->mpt_byte_4, MPT_BYTE_4_LOCAL_WRITE_S,\r\n(mr->access & IB_ACCESS_LOCAL_WRITE ? 1 : 0));\r\nroce_set_bit(mpt_entry->mpt_byte_4, MPT_BYTE_4_REMOTE_WRITE_S,\r\n(mr->access & IB_ACCESS_REMOTE_WRITE ? 1 : 0));\r\nroce_set_bit(mpt_entry->mpt_byte_4, MPT_BYTE_4_REMOTE_READ_S,\r\n(mr->access & IB_ACCESS_REMOTE_READ ? 1 : 0));\r\nroce_set_bit(mpt_entry->mpt_byte_4, MPT_BYTE_4_REMOTE_INVAL_ENABLE_S,\r\n0);\r\nroce_set_bit(mpt_entry->mpt_byte_4, MPT_BYTE_4_ADDRESS_TYPE_S, 0);\r\nroce_set_field(mpt_entry->mpt_byte_12, MPT_BYTE_12_PBL_ADDR_H_M,\r\nMPT_BYTE_12_PBL_ADDR_H_S, 0);\r\nroce_set_field(mpt_entry->mpt_byte_12, MPT_BYTE_12_MW_BIND_COUNTER_M,\r\nMPT_BYTE_12_MW_BIND_COUNTER_S, 0);\r\nmpt_entry->virt_addr_l = (u32)mr->iova;\r\nmpt_entry->virt_addr_h = (u32)(mr->iova >> 32);\r\nmpt_entry->length = (u32)mr->size;\r\nroce_set_field(mpt_entry->mpt_byte_28, MPT_BYTE_28_PD_M,\r\nMPT_BYTE_28_PD_S, mr->pd);\r\nroce_set_field(mpt_entry->mpt_byte_28, MPT_BYTE_28_L_KEY_IDX_L_M,\r\nMPT_BYTE_28_L_KEY_IDX_L_S, mtpt_idx);\r\nroce_set_field(mpt_entry->mpt_byte_64, MPT_BYTE_64_L_KEY_IDX_H_M,\r\nMPT_BYTE_64_L_KEY_IDX_H_S, mtpt_idx >> MTPT_IDX_SHIFT);\r\nif (mr->type == MR_TYPE_DMA)\r\nreturn 0;\r\npages = (u64 *) __get_free_page(GFP_KERNEL);\r\nif (!pages)\r\nreturn -ENOMEM;\r\ni = 0;\r\nfor_each_sg(mr->umem->sg_head.sgl, sg, mr->umem->nmap, entry) {\r\npages[i] = ((u64)sg_dma_address(sg)) >> 12;\r\nif (i >= HNS_ROCE_MAX_INNER_MTPT_NUM)\r\nbreak;\r\ni++;\r\n}\r\nfor (i = 0; i < HNS_ROCE_MAX_INNER_MTPT_NUM; i++) {\r\nswitch (i) {\r\ncase 0:\r\nmpt_entry->pa0_l = cpu_to_le32((u32)(pages[i]));\r\nroce_set_field(mpt_entry->mpt_byte_36,\r\nMPT_BYTE_36_PA0_H_M,\r\nMPT_BYTE_36_PA0_H_S,\r\ncpu_to_le32((u32)(pages[i] >> PAGES_SHIFT_32)));\r\nbreak;\r\ncase 1:\r\nroce_set_field(mpt_entry->mpt_byte_36,\r\nMPT_BYTE_36_PA1_L_M,\r\nMPT_BYTE_36_PA1_L_S,\r\ncpu_to_le32((u32)(pages[i])));\r\nroce_set_field(mpt_entry->mpt_byte_40,\r\nMPT_BYTE_40_PA1_H_M,\r\nMPT_BYTE_40_PA1_H_S,\r\ncpu_to_le32((u32)(pages[i] >> PAGES_SHIFT_24)));\r\nbreak;\r\ncase 2:\r\nroce_set_field(mpt_entry->mpt_byte_40,\r\nMPT_BYTE_40_PA2_L_M,\r\nMPT_BYTE_40_PA2_L_S,\r\ncpu_to_le32((u32)(pages[i])));\r\nroce_set_field(mpt_entry->mpt_byte_44,\r\nMPT_BYTE_44_PA2_H_M,\r\nMPT_BYTE_44_PA2_H_S,\r\ncpu_to_le32((u32)(pages[i] >> PAGES_SHIFT_16)));\r\nbreak;\r\ncase 3:\r\nroce_set_field(mpt_entry->mpt_byte_44,\r\nMPT_BYTE_44_PA3_L_M,\r\nMPT_BYTE_44_PA3_L_S,\r\ncpu_to_le32((u32)(pages[i])));\r\nroce_set_field(mpt_entry->mpt_byte_48,\r\nMPT_BYTE_48_PA3_H_M,\r\nMPT_BYTE_48_PA3_H_S,\r\ncpu_to_le32((u32)(pages[i] >> PAGES_SHIFT_8)));\r\nbreak;\r\ncase 4:\r\nmpt_entry->pa4_l = cpu_to_le32((u32)(pages[i]));\r\nroce_set_field(mpt_entry->mpt_byte_56,\r\nMPT_BYTE_56_PA4_H_M,\r\nMPT_BYTE_56_PA4_H_S,\r\ncpu_to_le32((u32)(pages[i] >> PAGES_SHIFT_32)));\r\nbreak;\r\ncase 5:\r\nroce_set_field(mpt_entry->mpt_byte_56,\r\nMPT_BYTE_56_PA5_L_M,\r\nMPT_BYTE_56_PA5_L_S,\r\ncpu_to_le32((u32)(pages[i])));\r\nroce_set_field(mpt_entry->mpt_byte_60,\r\nMPT_BYTE_60_PA5_H_M,\r\nMPT_BYTE_60_PA5_H_S,\r\ncpu_to_le32((u32)(pages[i] >> PAGES_SHIFT_24)));\r\nbreak;\r\ncase 6:\r\nroce_set_field(mpt_entry->mpt_byte_60,\r\nMPT_BYTE_60_PA6_L_M,\r\nMPT_BYTE_60_PA6_L_S,\r\ncpu_to_le32((u32)(pages[i])));\r\nroce_set_field(mpt_entry->mpt_byte_64,\r\nMPT_BYTE_64_PA6_H_M,\r\nMPT_BYTE_64_PA6_H_S,\r\ncpu_to_le32((u32)(pages[i] >> PAGES_SHIFT_16)));\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nfree_page((unsigned long) pages);\r\nmpt_entry->pbl_addr_l = (u32)(mr->pbl_dma_addr);\r\nroce_set_field(mpt_entry->mpt_byte_12, MPT_BYTE_12_PBL_ADDR_H_M,\r\nMPT_BYTE_12_PBL_ADDR_H_S,\r\n((u32)(mr->pbl_dma_addr >> 32)));\r\nreturn 0;\r\n}\r\nstatic void *get_cqe(struct hns_roce_cq *hr_cq, int n)\r\n{\r\nreturn hns_roce_buf_offset(&hr_cq->hr_buf.hr_buf,\r\nn * HNS_ROCE_V1_CQE_ENTRY_SIZE);\r\n}\r\nstatic void *get_sw_cqe(struct hns_roce_cq *hr_cq, int n)\r\n{\r\nstruct hns_roce_cqe *hr_cqe = get_cqe(hr_cq, n & hr_cq->ib_cq.cqe);\r\nreturn (roce_get_bit(hr_cqe->cqe_byte_4, CQE_BYTE_4_OWNER_S) ^\r\n!!(n & (hr_cq->ib_cq.cqe + 1))) ? hr_cqe : NULL;\r\n}\r\nstatic struct hns_roce_cqe *next_cqe_sw(struct hns_roce_cq *hr_cq)\r\n{\r\nreturn get_sw_cqe(hr_cq, hr_cq->cons_index);\r\n}\r\nvoid hns_roce_v1_cq_set_ci(struct hns_roce_cq *hr_cq, u32 cons_index)\r\n{\r\nu32 doorbell[2];\r\ndoorbell[0] = cons_index & ((hr_cq->cq_depth << 1) - 1);\r\nroce_set_bit(doorbell[1], ROCEE_DB_OTHERS_H_ROCEE_DB_OTH_HW_SYNS_S, 1);\r\nroce_set_field(doorbell[1], ROCEE_DB_OTHERS_H_ROCEE_DB_OTH_CMD_M,\r\nROCEE_DB_OTHERS_H_ROCEE_DB_OTH_CMD_S, 3);\r\nroce_set_field(doorbell[1], ROCEE_DB_OTHERS_H_ROCEE_DB_OTH_CMD_MDF_M,\r\nROCEE_DB_OTHERS_H_ROCEE_DB_OTH_CMD_MDF_S, 0);\r\nroce_set_field(doorbell[1], ROCEE_DB_OTHERS_H_ROCEE_DB_OTH_INP_H_M,\r\nROCEE_DB_OTHERS_H_ROCEE_DB_OTH_INP_H_S, hr_cq->cqn);\r\nhns_roce_write64_k(doorbell, hr_cq->cq_db_l);\r\n}\r\nstatic void __hns_roce_v1_cq_clean(struct hns_roce_cq *hr_cq, u32 qpn,\r\nstruct hns_roce_srq *srq)\r\n{\r\nstruct hns_roce_cqe *cqe, *dest;\r\nu32 prod_index;\r\nint nfreed = 0;\r\nu8 owner_bit;\r\nfor (prod_index = hr_cq->cons_index; get_sw_cqe(hr_cq, prod_index);\r\n++prod_index) {\r\nif (prod_index == hr_cq->cons_index + hr_cq->ib_cq.cqe)\r\nbreak;\r\n}\r\nwhile ((int) --prod_index - (int) hr_cq->cons_index >= 0) {\r\ncqe = get_cqe(hr_cq, prod_index & hr_cq->ib_cq.cqe);\r\nif ((roce_get_field(cqe->cqe_byte_16, CQE_BYTE_16_LOCAL_QPN_M,\r\nCQE_BYTE_16_LOCAL_QPN_S) &\r\nHNS_ROCE_CQE_QPN_MASK) == qpn) {\r\n++nfreed;\r\n} else if (nfreed) {\r\ndest = get_cqe(hr_cq, (prod_index + nfreed) &\r\nhr_cq->ib_cq.cqe);\r\nowner_bit = roce_get_bit(dest->cqe_byte_4,\r\nCQE_BYTE_4_OWNER_S);\r\nmemcpy(dest, cqe, sizeof(*cqe));\r\nroce_set_bit(dest->cqe_byte_4, CQE_BYTE_4_OWNER_S,\r\nowner_bit);\r\n}\r\n}\r\nif (nfreed) {\r\nhr_cq->cons_index += nfreed;\r\nwmb();\r\nhns_roce_v1_cq_set_ci(hr_cq, hr_cq->cons_index);\r\n}\r\n}\r\nstatic void hns_roce_v1_cq_clean(struct hns_roce_cq *hr_cq, u32 qpn,\r\nstruct hns_roce_srq *srq)\r\n{\r\nspin_lock_irq(&hr_cq->lock);\r\n__hns_roce_v1_cq_clean(hr_cq, qpn, srq);\r\nspin_unlock_irq(&hr_cq->lock);\r\n}\r\nvoid hns_roce_v1_write_cqc(struct hns_roce_dev *hr_dev,\r\nstruct hns_roce_cq *hr_cq, void *mb_buf, u64 *mtts,\r\ndma_addr_t dma_handle, int nent, u32 vector)\r\n{\r\nstruct hns_roce_cq_context *cq_context = NULL;\r\nstruct hns_roce_buf_list *tptr_buf;\r\nstruct hns_roce_v1_priv *priv;\r\ndma_addr_t tptr_dma_addr;\r\nint offset;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\ntptr_buf = &priv->tptr_table.tptr_buf;\r\ncq_context = mb_buf;\r\nmemset(cq_context, 0, sizeof(*cq_context));\r\noffset = hr_cq->cqn * HNS_ROCE_V1_TPTR_ENTRY_SIZE;\r\ntptr_dma_addr = tptr_buf->map + offset;\r\nhr_cq->tptr_addr = (u16 *)(tptr_buf->buf + offset);\r\nroce_set_field(cq_context->cqc_byte_4,\r\nCQ_CONTEXT_CQC_BYTE_4_CQC_STATE_M,\r\nCQ_CONTEXT_CQC_BYTE_4_CQC_STATE_S, CQ_STATE_VALID);\r\nroce_set_field(cq_context->cqc_byte_4, CQ_CONTEXT_CQC_BYTE_4_CQN_M,\r\nCQ_CONTEXT_CQC_BYTE_4_CQN_S, hr_cq->cqn);\r\ncq_context->cqc_byte_4 = cpu_to_le32(cq_context->cqc_byte_4);\r\ncq_context->cq_bt_l = (u32)dma_handle;\r\ncq_context->cq_bt_l = cpu_to_le32(cq_context->cq_bt_l);\r\nroce_set_field(cq_context->cqc_byte_12,\r\nCQ_CONTEXT_CQC_BYTE_12_CQ_BT_H_M,\r\nCQ_CONTEXT_CQC_BYTE_12_CQ_BT_H_S,\r\n((u64)dma_handle >> 32));\r\nroce_set_field(cq_context->cqc_byte_12,\r\nCQ_CONTEXT_CQC_BYTE_12_CQ_CQE_SHIFT_M,\r\nCQ_CONTEXT_CQC_BYTE_12_CQ_CQE_SHIFT_S,\r\nilog2((unsigned int)nent));\r\nroce_set_field(cq_context->cqc_byte_12, CQ_CONTEXT_CQC_BYTE_12_CEQN_M,\r\nCQ_CONTEXT_CQC_BYTE_12_CEQN_S, vector);\r\ncq_context->cqc_byte_12 = cpu_to_le32(cq_context->cqc_byte_12);\r\ncq_context->cur_cqe_ba0_l = (u32)(mtts[0]);\r\ncq_context->cur_cqe_ba0_l = cpu_to_le32(cq_context->cur_cqe_ba0_l);\r\nroce_set_field(cq_context->cqc_byte_20,\r\nCQ_CONTEXT_CQC_BYTE_20_CUR_CQE_BA0_H_M,\r\nCQ_CONTEXT_CQC_BYTE_20_CUR_CQE_BA0_H_S,\r\ncpu_to_le32((mtts[0]) >> 32));\r\nroce_set_field(cq_context->cqc_byte_20,\r\nCQ_CONTEXT_CQC_BYTE_20_CQ_CUR_INDEX_M,\r\nCQ_CONTEXT_CQC_BYTE_20_CQ_CUR_INDEX_S, 0);\r\nroce_set_field(cq_context->cqc_byte_20,\r\nCQ_CONTEXT_CQC_BYTE_20_CQE_TPTR_ADDR_H_M,\r\nCQ_CONTEXT_CQC_BYTE_20_CQE_TPTR_ADDR_H_S,\r\ntptr_dma_addr >> 44);\r\ncq_context->cqc_byte_20 = cpu_to_le32(cq_context->cqc_byte_20);\r\ncq_context->cqe_tptr_addr_l = (u32)(tptr_dma_addr >> 12);\r\nroce_set_field(cq_context->cqc_byte_32,\r\nCQ_CONTEXT_CQC_BYTE_32_CUR_CQE_BA1_H_M,\r\nCQ_CONTEXT_CQC_BYTE_32_CUR_CQE_BA1_H_S, 0);\r\nroce_set_bit(cq_context->cqc_byte_32,\r\nCQ_CONTEXT_CQC_BYTE_32_SE_FLAG_S, 0);\r\nroce_set_bit(cq_context->cqc_byte_32,\r\nCQ_CONTEXT_CQC_BYTE_32_CE_FLAG_S, 0);\r\nroce_set_bit(cq_context->cqc_byte_32,\r\nCQ_CONTEXT_CQC_BYTE_32_NOTIFICATION_FLAG_S, 0);\r\nroce_set_bit(cq_context->cqc_byte_32,\r\nCQ_CQNTEXT_CQC_BYTE_32_TYPE_OF_COMPLETION_NOTIFICATION_S,\r\n0);\r\nroce_set_field(cq_context->cqc_byte_32,\r\nCQ_CONTEXT_CQC_BYTE_32_CQ_CONS_IDX_M,\r\nCQ_CONTEXT_CQC_BYTE_32_CQ_CONS_IDX_S, 0);\r\ncq_context->cqc_byte_32 = cpu_to_le32(cq_context->cqc_byte_32);\r\n}\r\nint hns_roce_v1_req_notify_cq(struct ib_cq *ibcq, enum ib_cq_notify_flags flags)\r\n{\r\nstruct hns_roce_cq *hr_cq = to_hr_cq(ibcq);\r\nu32 notification_flag;\r\nu32 doorbell[2];\r\nint ret = 0;\r\nnotification_flag = (flags & IB_CQ_SOLICITED_MASK) ==\r\nIB_CQ_SOLICITED ? CQ_DB_REQ_NOT : CQ_DB_REQ_NOT_SOL;\r\ndoorbell[0] = hr_cq->cons_index & ((hr_cq->cq_depth << 1) - 1);\r\nroce_set_bit(doorbell[1], ROCEE_DB_OTHERS_H_ROCEE_DB_OTH_HW_SYNS_S, 1);\r\nroce_set_field(doorbell[1], ROCEE_DB_OTHERS_H_ROCEE_DB_OTH_CMD_M,\r\nROCEE_DB_OTHERS_H_ROCEE_DB_OTH_CMD_S, 3);\r\nroce_set_field(doorbell[1], ROCEE_DB_OTHERS_H_ROCEE_DB_OTH_CMD_MDF_M,\r\nROCEE_DB_OTHERS_H_ROCEE_DB_OTH_CMD_MDF_S, 1);\r\nroce_set_field(doorbell[1], ROCEE_DB_OTHERS_H_ROCEE_DB_OTH_INP_H_M,\r\nROCEE_DB_OTHERS_H_ROCEE_DB_OTH_INP_H_S,\r\nhr_cq->cqn | notification_flag);\r\nhns_roce_write64_k(doorbell, hr_cq->cq_db_l);\r\nreturn ret;\r\n}\r\nstatic int hns_roce_v1_poll_one(struct hns_roce_cq *hr_cq,\r\nstruct hns_roce_qp **cur_qp, struct ib_wc *wc)\r\n{\r\nint qpn;\r\nint is_send;\r\nu16 wqe_ctr;\r\nu32 status;\r\nu32 opcode;\r\nstruct hns_roce_cqe *cqe;\r\nstruct hns_roce_qp *hr_qp;\r\nstruct hns_roce_wq *wq;\r\nstruct hns_roce_wqe_ctrl_seg *sq_wqe;\r\nstruct hns_roce_dev *hr_dev = to_hr_dev(hr_cq->ib_cq.device);\r\nstruct device *dev = &hr_dev->pdev->dev;\r\ncqe = next_cqe_sw(hr_cq);\r\nif (!cqe)\r\nreturn -EAGAIN;\r\n++hr_cq->cons_index;\r\nrmb();\r\nis_send = !(roce_get_bit(cqe->cqe_byte_4, CQE_BYTE_4_SQ_RQ_FLAG_S));\r\nif (roce_get_field(cqe->cqe_byte_16, CQE_BYTE_16_LOCAL_QPN_M,\r\nCQE_BYTE_16_LOCAL_QPN_S) <= 1) {\r\nqpn = roce_get_field(cqe->cqe_byte_20, CQE_BYTE_20_PORT_NUM_M,\r\nCQE_BYTE_20_PORT_NUM_S) +\r\nroce_get_field(cqe->cqe_byte_16, CQE_BYTE_16_LOCAL_QPN_M,\r\nCQE_BYTE_16_LOCAL_QPN_S) *\r\nHNS_ROCE_MAX_PORTS;\r\n} else {\r\nqpn = roce_get_field(cqe->cqe_byte_16, CQE_BYTE_16_LOCAL_QPN_M,\r\nCQE_BYTE_16_LOCAL_QPN_S);\r\n}\r\nif (!*cur_qp || (qpn & HNS_ROCE_CQE_QPN_MASK) != (*cur_qp)->qpn) {\r\nhr_qp = __hns_roce_qp_lookup(hr_dev, qpn);\r\nif (unlikely(!hr_qp)) {\r\ndev_err(dev, "CQ %06lx with entry for unknown QPN %06x\n",\r\nhr_cq->cqn, (qpn & HNS_ROCE_CQE_QPN_MASK));\r\nreturn -EINVAL;\r\n}\r\n*cur_qp = hr_qp;\r\n}\r\nwc->qp = &(*cur_qp)->ibqp;\r\nwc->vendor_err = 0;\r\nstatus = roce_get_field(cqe->cqe_byte_4,\r\nCQE_BYTE_4_STATUS_OF_THE_OPERATION_M,\r\nCQE_BYTE_4_STATUS_OF_THE_OPERATION_S) &\r\nHNS_ROCE_CQE_STATUS_MASK;\r\nswitch (status) {\r\ncase HNS_ROCE_CQE_SUCCESS:\r\nwc->status = IB_WC_SUCCESS;\r\nbreak;\r\ncase HNS_ROCE_CQE_SYNDROME_LOCAL_LENGTH_ERR:\r\nwc->status = IB_WC_LOC_LEN_ERR;\r\nbreak;\r\ncase HNS_ROCE_CQE_SYNDROME_LOCAL_QP_OP_ERR:\r\nwc->status = IB_WC_LOC_QP_OP_ERR;\r\nbreak;\r\ncase HNS_ROCE_CQE_SYNDROME_LOCAL_PROT_ERR:\r\nwc->status = IB_WC_LOC_PROT_ERR;\r\nbreak;\r\ncase HNS_ROCE_CQE_SYNDROME_WR_FLUSH_ERR:\r\nwc->status = IB_WC_WR_FLUSH_ERR;\r\nbreak;\r\ncase HNS_ROCE_CQE_SYNDROME_MEM_MANAGE_OPERATE_ERR:\r\nwc->status = IB_WC_MW_BIND_ERR;\r\nbreak;\r\ncase HNS_ROCE_CQE_SYNDROME_BAD_RESP_ERR:\r\nwc->status = IB_WC_BAD_RESP_ERR;\r\nbreak;\r\ncase HNS_ROCE_CQE_SYNDROME_LOCAL_ACCESS_ERR:\r\nwc->status = IB_WC_LOC_ACCESS_ERR;\r\nbreak;\r\ncase HNS_ROCE_CQE_SYNDROME_REMOTE_INVAL_REQ_ERR:\r\nwc->status = IB_WC_REM_INV_REQ_ERR;\r\nbreak;\r\ncase HNS_ROCE_CQE_SYNDROME_REMOTE_ACCESS_ERR:\r\nwc->status = IB_WC_REM_ACCESS_ERR;\r\nbreak;\r\ncase HNS_ROCE_CQE_SYNDROME_REMOTE_OP_ERR:\r\nwc->status = IB_WC_REM_OP_ERR;\r\nbreak;\r\ncase HNS_ROCE_CQE_SYNDROME_TRANSPORT_RETRY_EXC_ERR:\r\nwc->status = IB_WC_RETRY_EXC_ERR;\r\nbreak;\r\ncase HNS_ROCE_CQE_SYNDROME_RNR_RETRY_EXC_ERR:\r\nwc->status = IB_WC_RNR_RETRY_EXC_ERR;\r\nbreak;\r\ndefault:\r\nwc->status = IB_WC_GENERAL_ERR;\r\nbreak;\r\n}\r\nif (wc->status != IB_WC_SUCCESS)\r\nreturn 0;\r\nif (is_send) {\r\nsq_wqe = get_send_wqe(*cur_qp, roce_get_field(cqe->cqe_byte_4,\r\nCQE_BYTE_4_WQE_INDEX_M,\r\nCQE_BYTE_4_WQE_INDEX_S)&\r\n((*cur_qp)->sq.wqe_cnt-1));\r\nswitch (sq_wqe->flag & HNS_ROCE_WQE_OPCODE_MASK) {\r\ncase HNS_ROCE_WQE_OPCODE_SEND:\r\nwc->opcode = IB_WC_SEND;\r\nbreak;\r\ncase HNS_ROCE_WQE_OPCODE_RDMA_READ:\r\nwc->opcode = IB_WC_RDMA_READ;\r\nwc->byte_len = le32_to_cpu(cqe->byte_cnt);\r\nbreak;\r\ncase HNS_ROCE_WQE_OPCODE_RDMA_WRITE:\r\nwc->opcode = IB_WC_RDMA_WRITE;\r\nbreak;\r\ncase HNS_ROCE_WQE_OPCODE_LOCAL_INV:\r\nwc->opcode = IB_WC_LOCAL_INV;\r\nbreak;\r\ncase HNS_ROCE_WQE_OPCODE_UD_SEND:\r\nwc->opcode = IB_WC_SEND;\r\nbreak;\r\ndefault:\r\nwc->status = IB_WC_GENERAL_ERR;\r\nbreak;\r\n}\r\nwc->wc_flags = (sq_wqe->flag & HNS_ROCE_WQE_IMM ?\r\nIB_WC_WITH_IMM : 0);\r\nwq = &(*cur_qp)->sq;\r\nif ((*cur_qp)->sq_signal_bits) {\r\nwqe_ctr = (u16)roce_get_field(cqe->cqe_byte_4,\r\nCQE_BYTE_4_WQE_INDEX_M,\r\nCQE_BYTE_4_WQE_INDEX_S);\r\nwq->tail += (wqe_ctr - (u16)wq->tail) &\r\n(wq->wqe_cnt - 1);\r\n}\r\nwc->wr_id = wq->wrid[wq->tail & (wq->wqe_cnt - 1)];\r\n++wq->tail;\r\n} else {\r\nwc->byte_len = le32_to_cpu(cqe->byte_cnt);\r\nopcode = roce_get_field(cqe->cqe_byte_4,\r\nCQE_BYTE_4_OPERATION_TYPE_M,\r\nCQE_BYTE_4_OPERATION_TYPE_S) &\r\nHNS_ROCE_CQE_OPCODE_MASK;\r\nswitch (opcode) {\r\ncase HNS_ROCE_OPCODE_RDMA_WITH_IMM_RECEIVE:\r\nwc->opcode = IB_WC_RECV_RDMA_WITH_IMM;\r\nwc->wc_flags = IB_WC_WITH_IMM;\r\nwc->ex.imm_data = le32_to_cpu(cqe->immediate_data);\r\nbreak;\r\ncase HNS_ROCE_OPCODE_SEND_DATA_RECEIVE:\r\nif (roce_get_bit(cqe->cqe_byte_4,\r\nCQE_BYTE_4_IMM_INDICATOR_S)) {\r\nwc->opcode = IB_WC_RECV;\r\nwc->wc_flags = IB_WC_WITH_IMM;\r\nwc->ex.imm_data = le32_to_cpu(\r\ncqe->immediate_data);\r\n} else {\r\nwc->opcode = IB_WC_RECV;\r\nwc->wc_flags = 0;\r\n}\r\nbreak;\r\ndefault:\r\nwc->status = IB_WC_GENERAL_ERR;\r\nbreak;\r\n}\r\nwq = &(*cur_qp)->rq;\r\nwc->wr_id = wq->wrid[wq->tail & (wq->wqe_cnt - 1)];\r\n++wq->tail;\r\nwc->sl = (u8)roce_get_field(cqe->cqe_byte_20, CQE_BYTE_20_SL_M,\r\nCQE_BYTE_20_SL_S);\r\nwc->src_qp = (u8)roce_get_field(cqe->cqe_byte_20,\r\nCQE_BYTE_20_REMOTE_QPN_M,\r\nCQE_BYTE_20_REMOTE_QPN_S);\r\nwc->wc_flags |= (roce_get_bit(cqe->cqe_byte_20,\r\nCQE_BYTE_20_GRH_PRESENT_S) ?\r\nIB_WC_GRH : 0);\r\nwc->pkey_index = (u16)roce_get_field(cqe->cqe_byte_28,\r\nCQE_BYTE_28_P_KEY_IDX_M,\r\nCQE_BYTE_28_P_KEY_IDX_S);\r\n}\r\nreturn 0;\r\n}\r\nint hns_roce_v1_poll_cq(struct ib_cq *ibcq, int num_entries, struct ib_wc *wc)\r\n{\r\nstruct hns_roce_cq *hr_cq = to_hr_cq(ibcq);\r\nstruct hns_roce_qp *cur_qp = NULL;\r\nunsigned long flags;\r\nint npolled;\r\nint ret = 0;\r\nspin_lock_irqsave(&hr_cq->lock, flags);\r\nfor (npolled = 0; npolled < num_entries; ++npolled) {\r\nret = hns_roce_v1_poll_one(hr_cq, &cur_qp, wc + npolled);\r\nif (ret)\r\nbreak;\r\n}\r\nif (npolled) {\r\n*hr_cq->tptr_addr = hr_cq->cons_index &\r\n((hr_cq->cq_depth << 1) - 1);\r\nwmb();\r\nhns_roce_v1_cq_set_ci(hr_cq, hr_cq->cons_index);\r\n}\r\nspin_unlock_irqrestore(&hr_cq->lock, flags);\r\nif (ret == 0 || ret == -EAGAIN)\r\nreturn npolled;\r\nelse\r\nreturn ret;\r\n}\r\nint hns_roce_v1_clear_hem(struct hns_roce_dev *hr_dev,\r\nstruct hns_roce_hem_table *table, int obj)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_v1_priv *priv;\r\nunsigned long end = 0, flags = 0;\r\nuint32_t bt_cmd_val[2] = {0};\r\nvoid __iomem *bt_cmd;\r\nu64 bt_ba = 0;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\nswitch (table->type) {\r\ncase HEM_TYPE_QPC:\r\nroce_set_field(bt_cmd_val[1], ROCEE_BT_CMD_H_ROCEE_BT_CMD_MDF_M,\r\nROCEE_BT_CMD_H_ROCEE_BT_CMD_MDF_S, HEM_TYPE_QPC);\r\nbt_ba = priv->bt_table.qpc_buf.map >> 12;\r\nbreak;\r\ncase HEM_TYPE_MTPT:\r\nroce_set_field(bt_cmd_val[1], ROCEE_BT_CMD_H_ROCEE_BT_CMD_MDF_M,\r\nROCEE_BT_CMD_H_ROCEE_BT_CMD_MDF_S, HEM_TYPE_MTPT);\r\nbt_ba = priv->bt_table.mtpt_buf.map >> 12;\r\nbreak;\r\ncase HEM_TYPE_CQC:\r\nroce_set_field(bt_cmd_val[1], ROCEE_BT_CMD_H_ROCEE_BT_CMD_MDF_M,\r\nROCEE_BT_CMD_H_ROCEE_BT_CMD_MDF_S, HEM_TYPE_CQC);\r\nbt_ba = priv->bt_table.cqc_buf.map >> 12;\r\nbreak;\r\ncase HEM_TYPE_SRQC:\r\ndev_dbg(dev, "HEM_TYPE_SRQC not support.\n");\r\nreturn -EINVAL;\r\ndefault:\r\nreturn 0;\r\n}\r\nroce_set_field(bt_cmd_val[1], ROCEE_BT_CMD_H_ROCEE_BT_CMD_IN_MDF_M,\r\nROCEE_BT_CMD_H_ROCEE_BT_CMD_IN_MDF_S, obj);\r\nroce_set_bit(bt_cmd_val[1], ROCEE_BT_CMD_H_ROCEE_BT_CMD_S, 0);\r\nroce_set_bit(bt_cmd_val[1], ROCEE_BT_CMD_H_ROCEE_BT_CMD_HW_SYNS_S, 1);\r\nspin_lock_irqsave(&hr_dev->bt_cmd_lock, flags);\r\nbt_cmd = hr_dev->reg_base + ROCEE_BT_CMD_H_REG;\r\nend = msecs_to_jiffies(HW_SYNC_TIMEOUT_MSECS) + jiffies;\r\nwhile (1) {\r\nif (readl(bt_cmd) >> BT_CMD_SYNC_SHIFT) {\r\nif (!(time_before(jiffies, end))) {\r\ndev_err(dev, "Write bt_cmd err,hw_sync is not zero.\n");\r\nspin_unlock_irqrestore(&hr_dev->bt_cmd_lock,\r\nflags);\r\nreturn -EBUSY;\r\n}\r\n} else {\r\nbreak;\r\n}\r\nmsleep(HW_SYNC_SLEEP_TIME_INTERVAL);\r\n}\r\nbt_cmd_val[0] = (uint32_t)bt_ba;\r\nroce_set_field(bt_cmd_val[1], ROCEE_BT_CMD_H_ROCEE_BT_CMD_BA_H_M,\r\nROCEE_BT_CMD_H_ROCEE_BT_CMD_BA_H_S, bt_ba >> 32);\r\nhns_roce_write64_k(bt_cmd_val, hr_dev->reg_base + ROCEE_BT_CMD_L_REG);\r\nspin_unlock_irqrestore(&hr_dev->bt_cmd_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int hns_roce_v1_qp_modify(struct hns_roce_dev *hr_dev,\r\nstruct hns_roce_mtt *mtt,\r\nenum hns_roce_qp_state cur_state,\r\nenum hns_roce_qp_state new_state,\r\nstruct hns_roce_qp_context *context,\r\nstruct hns_roce_qp *hr_qp)\r\n{\r\nstatic const u16\r\nop[HNS_ROCE_QP_NUM_STATE][HNS_ROCE_QP_NUM_STATE] = {\r\n[HNS_ROCE_QP_STATE_RST] = {\r\n[HNS_ROCE_QP_STATE_RST] = HNS_ROCE_CMD_2RST_QP,\r\n[HNS_ROCE_QP_STATE_ERR] = HNS_ROCE_CMD_2ERR_QP,\r\n[HNS_ROCE_QP_STATE_INIT] = HNS_ROCE_CMD_RST2INIT_QP,\r\n},\r\n[HNS_ROCE_QP_STATE_INIT] = {\r\n[HNS_ROCE_QP_STATE_RST] = HNS_ROCE_CMD_2RST_QP,\r\n[HNS_ROCE_QP_STATE_ERR] = HNS_ROCE_CMD_2ERR_QP,\r\n[HNS_ROCE_QP_STATE_INIT] = HNS_ROCE_CMD_RST2INIT_QP,\r\n[HNS_ROCE_QP_STATE_RTR] = HNS_ROCE_CMD_INIT2RTR_QP,\r\n},\r\n[HNS_ROCE_QP_STATE_RTR] = {\r\n[HNS_ROCE_QP_STATE_RST] = HNS_ROCE_CMD_2RST_QP,\r\n[HNS_ROCE_QP_STATE_ERR] = HNS_ROCE_CMD_2ERR_QP,\r\n[HNS_ROCE_QP_STATE_RTS] = HNS_ROCE_CMD_RTR2RTS_QP,\r\n},\r\n[HNS_ROCE_QP_STATE_RTS] = {\r\n[HNS_ROCE_QP_STATE_RST] = HNS_ROCE_CMD_2RST_QP,\r\n[HNS_ROCE_QP_STATE_ERR] = HNS_ROCE_CMD_2ERR_QP,\r\n[HNS_ROCE_QP_STATE_RTS] = HNS_ROCE_CMD_RTS2RTS_QP,\r\n[HNS_ROCE_QP_STATE_SQD] = HNS_ROCE_CMD_RTS2SQD_QP,\r\n},\r\n[HNS_ROCE_QP_STATE_SQD] = {\r\n[HNS_ROCE_QP_STATE_RST] = HNS_ROCE_CMD_2RST_QP,\r\n[HNS_ROCE_QP_STATE_ERR] = HNS_ROCE_CMD_2ERR_QP,\r\n[HNS_ROCE_QP_STATE_RTS] = HNS_ROCE_CMD_SQD2RTS_QP,\r\n[HNS_ROCE_QP_STATE_SQD] = HNS_ROCE_CMD_SQD2SQD_QP,\r\n},\r\n[HNS_ROCE_QP_STATE_ERR] = {\r\n[HNS_ROCE_QP_STATE_RST] = HNS_ROCE_CMD_2RST_QP,\r\n[HNS_ROCE_QP_STATE_ERR] = HNS_ROCE_CMD_2ERR_QP,\r\n}\r\n};\r\nstruct hns_roce_cmd_mailbox *mailbox;\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nint ret = 0;\r\nif (cur_state >= HNS_ROCE_QP_NUM_STATE ||\r\nnew_state >= HNS_ROCE_QP_NUM_STATE ||\r\n!op[cur_state][new_state]) {\r\ndev_err(dev, "[modify_qp]not support state %d to %d\n",\r\ncur_state, new_state);\r\nreturn -EINVAL;\r\n}\r\nif (op[cur_state][new_state] == HNS_ROCE_CMD_2RST_QP)\r\nreturn hns_roce_cmd_mbox(hr_dev, 0, 0, hr_qp->qpn, 2,\r\nHNS_ROCE_CMD_2RST_QP,\r\nHNS_ROCE_CMD_TIMEOUT_MSECS);\r\nif (op[cur_state][new_state] == HNS_ROCE_CMD_2ERR_QP)\r\nreturn hns_roce_cmd_mbox(hr_dev, 0, 0, hr_qp->qpn, 2,\r\nHNS_ROCE_CMD_2ERR_QP,\r\nHNS_ROCE_CMD_TIMEOUT_MSECS);\r\nmailbox = hns_roce_alloc_cmd_mailbox(hr_dev);\r\nif (IS_ERR(mailbox))\r\nreturn PTR_ERR(mailbox);\r\nmemcpy(mailbox->buf, context, sizeof(*context));\r\nret = hns_roce_cmd_mbox(hr_dev, mailbox->dma, 0, hr_qp->qpn, 0,\r\nop[cur_state][new_state],\r\nHNS_ROCE_CMD_TIMEOUT_MSECS);\r\nhns_roce_free_cmd_mailbox(hr_dev, mailbox);\r\nreturn ret;\r\n}\r\nstatic int hns_roce_v1_m_sqp(struct ib_qp *ibqp, const struct ib_qp_attr *attr,\r\nint attr_mask, enum ib_qp_state cur_state,\r\nenum ib_qp_state new_state)\r\n{\r\nstruct hns_roce_dev *hr_dev = to_hr_dev(ibqp->device);\r\nstruct hns_roce_qp *hr_qp = to_hr_qp(ibqp);\r\nstruct hns_roce_sqp_context *context;\r\nstruct device *dev = &hr_dev->pdev->dev;\r\ndma_addr_t dma_handle = 0;\r\nint rq_pa_start;\r\nu32 reg_val;\r\nu64 *mtts;\r\nu32 *addr;\r\ncontext = kzalloc(sizeof(*context), GFP_KERNEL);\r\nif (!context)\r\nreturn -ENOMEM;\r\nmtts = hns_roce_table_find(&hr_dev->mr_table.mtt_table,\r\nhr_qp->mtt.first_seg, &dma_handle);\r\nif (!mtts) {\r\ndev_err(dev, "qp buf pa find failed\n");\r\ngoto out;\r\n}\r\nif (cur_state == IB_QPS_RESET && new_state == IB_QPS_INIT) {\r\nroce_set_field(context->qp1c_bytes_4,\r\nQP1C_BYTES_4_SQ_WQE_SHIFT_M,\r\nQP1C_BYTES_4_SQ_WQE_SHIFT_S,\r\nilog2((unsigned int)hr_qp->sq.wqe_cnt));\r\nroce_set_field(context->qp1c_bytes_4,\r\nQP1C_BYTES_4_RQ_WQE_SHIFT_M,\r\nQP1C_BYTES_4_RQ_WQE_SHIFT_S,\r\nilog2((unsigned int)hr_qp->rq.wqe_cnt));\r\nroce_set_field(context->qp1c_bytes_4, QP1C_BYTES_4_PD_M,\r\nQP1C_BYTES_4_PD_S, to_hr_pd(ibqp->pd)->pdn);\r\ncontext->sq_rq_bt_l = (u32)(dma_handle);\r\nroce_set_field(context->qp1c_bytes_12,\r\nQP1C_BYTES_12_SQ_RQ_BT_H_M,\r\nQP1C_BYTES_12_SQ_RQ_BT_H_S,\r\n((u32)(dma_handle >> 32)));\r\nroce_set_field(context->qp1c_bytes_16, QP1C_BYTES_16_RQ_HEAD_M,\r\nQP1C_BYTES_16_RQ_HEAD_S, hr_qp->rq.head);\r\nroce_set_field(context->qp1c_bytes_16, QP1C_BYTES_16_PORT_NUM_M,\r\nQP1C_BYTES_16_PORT_NUM_S, hr_qp->phy_port);\r\nroce_set_bit(context->qp1c_bytes_16,\r\nQP1C_BYTES_16_SIGNALING_TYPE_S,\r\nhr_qp->sq_signal_bits);\r\nroce_set_bit(context->qp1c_bytes_16, QP1C_BYTES_16_RQ_BA_FLG_S,\r\n1);\r\nroce_set_bit(context->qp1c_bytes_16, QP1C_BYTES_16_SQ_BA_FLG_S,\r\n1);\r\nroce_set_bit(context->qp1c_bytes_16, QP1C_BYTES_16_QP1_ERR_S,\r\n0);\r\nroce_set_field(context->qp1c_bytes_20, QP1C_BYTES_20_SQ_HEAD_M,\r\nQP1C_BYTES_20_SQ_HEAD_S, hr_qp->sq.head);\r\nroce_set_field(context->qp1c_bytes_20, QP1C_BYTES_20_PKEY_IDX_M,\r\nQP1C_BYTES_20_PKEY_IDX_S, attr->pkey_index);\r\nrq_pa_start = (u32)hr_qp->rq.offset / PAGE_SIZE;\r\ncontext->cur_rq_wqe_ba_l = (u32)(mtts[rq_pa_start]);\r\nroce_set_field(context->qp1c_bytes_28,\r\nQP1C_BYTES_28_CUR_RQ_WQE_BA_H_M,\r\nQP1C_BYTES_28_CUR_RQ_WQE_BA_H_S,\r\n(mtts[rq_pa_start]) >> 32);\r\nroce_set_field(context->qp1c_bytes_28,\r\nQP1C_BYTES_28_RQ_CUR_IDX_M,\r\nQP1C_BYTES_28_RQ_CUR_IDX_S, 0);\r\nroce_set_field(context->qp1c_bytes_32,\r\nQP1C_BYTES_32_RX_CQ_NUM_M,\r\nQP1C_BYTES_32_RX_CQ_NUM_S,\r\nto_hr_cq(ibqp->recv_cq)->cqn);\r\nroce_set_field(context->qp1c_bytes_32,\r\nQP1C_BYTES_32_TX_CQ_NUM_M,\r\nQP1C_BYTES_32_TX_CQ_NUM_S,\r\nto_hr_cq(ibqp->send_cq)->cqn);\r\ncontext->cur_sq_wqe_ba_l = (u32)mtts[0];\r\nroce_set_field(context->qp1c_bytes_40,\r\nQP1C_BYTES_40_CUR_SQ_WQE_BA_H_M,\r\nQP1C_BYTES_40_CUR_SQ_WQE_BA_H_S,\r\n(mtts[0]) >> 32);\r\nroce_set_field(context->qp1c_bytes_40,\r\nQP1C_BYTES_40_SQ_CUR_IDX_M,\r\nQP1C_BYTES_40_SQ_CUR_IDX_S, 0);\r\naddr = (u32 *)(hr_dev->reg_base + ROCEE_QP1C_CFG0_0_REG +\r\nhr_qp->phy_port * sizeof(*context));\r\nwritel(context->qp1c_bytes_4, addr);\r\nwritel(context->sq_rq_bt_l, addr + 1);\r\nwritel(context->qp1c_bytes_12, addr + 2);\r\nwritel(context->qp1c_bytes_16, addr + 3);\r\nwritel(context->qp1c_bytes_20, addr + 4);\r\nwritel(context->cur_rq_wqe_ba_l, addr + 5);\r\nwritel(context->qp1c_bytes_28, addr + 6);\r\nwritel(context->qp1c_bytes_32, addr + 7);\r\nwritel(context->cur_sq_wqe_ba_l, addr + 8);\r\nwritel(context->qp1c_bytes_40, addr + 9);\r\n}\r\nreg_val = roce_read(hr_dev, ROCEE_QP1C_CFG0_0_REG +\r\nhr_qp->phy_port * sizeof(*context));\r\nroce_set_field(reg_val, ROCEE_QP1C_CFG0_0_ROCEE_QP1C_QP_ST_M,\r\nROCEE_QP1C_CFG0_0_ROCEE_QP1C_QP_ST_S, new_state);\r\nroce_write(hr_dev, ROCEE_QP1C_CFG0_0_REG +\r\nhr_qp->phy_port * sizeof(*context), reg_val);\r\nhr_qp->state = new_state;\r\nif (new_state == IB_QPS_RESET) {\r\nhns_roce_v1_cq_clean(to_hr_cq(ibqp->recv_cq), hr_qp->qpn,\r\nibqp->srq ? to_hr_srq(ibqp->srq) : NULL);\r\nif (ibqp->send_cq != ibqp->recv_cq)\r\nhns_roce_v1_cq_clean(to_hr_cq(ibqp->send_cq),\r\nhr_qp->qpn, NULL);\r\nhr_qp->rq.head = 0;\r\nhr_qp->rq.tail = 0;\r\nhr_qp->sq.head = 0;\r\nhr_qp->sq.tail = 0;\r\nhr_qp->sq_next_wqe = 0;\r\n}\r\nkfree(context);\r\nreturn 0;\r\nout:\r\nkfree(context);\r\nreturn -EINVAL;\r\n}\r\nstatic int hns_roce_v1_m_qp(struct ib_qp *ibqp, const struct ib_qp_attr *attr,\r\nint attr_mask, enum ib_qp_state cur_state,\r\nenum ib_qp_state new_state)\r\n{\r\nstruct hns_roce_dev *hr_dev = to_hr_dev(ibqp->device);\r\nstruct hns_roce_qp *hr_qp = to_hr_qp(ibqp);\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_qp_context *context;\r\ndma_addr_t dma_handle_2 = 0;\r\ndma_addr_t dma_handle = 0;\r\nuint32_t doorbell[2] = {0};\r\nint rq_pa_start = 0;\r\nu64 *mtts_2 = NULL;\r\nint ret = -EINVAL;\r\nu64 *mtts = NULL;\r\nint port;\r\nu8 *dmac;\r\nu8 *smac;\r\ncontext = kzalloc(sizeof(*context), GFP_KERNEL);\r\nif (!context)\r\nreturn -ENOMEM;\r\nmtts = hns_roce_table_find(&hr_dev->mr_table.mtt_table,\r\nhr_qp->mtt.first_seg, &dma_handle);\r\nif (mtts == NULL) {\r\ndev_err(dev, "qp buf pa find failed\n");\r\ngoto out;\r\n}\r\nmtts_2 = hns_roce_table_find(&hr_dev->qp_table.irrl_table, hr_qp->qpn,\r\n&dma_handle_2);\r\nif (mtts_2 == NULL) {\r\ndev_err(dev, "qp irrl_table find failed\n");\r\ngoto out;\r\n}\r\nif (cur_state == IB_QPS_RESET && new_state == IB_QPS_INIT) {\r\nroce_set_field(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTES_4_TRANSPORT_SERVICE_TYPE_M,\r\nQP_CONTEXT_QPC_BYTES_4_TRANSPORT_SERVICE_TYPE_S,\r\nto_hr_qp_type(hr_qp->ibqp.qp_type));\r\nroce_set_bit(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTE_4_ENABLE_FPMR_S, 0);\r\nroce_set_bit(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTE_4_RDMA_READ_ENABLE_S,\r\n!!(attr->qp_access_flags & IB_ACCESS_REMOTE_READ));\r\nroce_set_bit(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTE_4_RDMA_WRITE_ENABLE_S,\r\n!!(attr->qp_access_flags & IB_ACCESS_REMOTE_WRITE)\r\n);\r\nroce_set_bit(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTE_4_ATOMIC_OPERATION_ENABLE_S,\r\n!!(attr->qp_access_flags & IB_ACCESS_REMOTE_ATOMIC)\r\n);\r\nroce_set_bit(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTE_4_RDMAR_USE_S, 1);\r\nroce_set_field(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTES_4_SQ_WQE_SHIFT_M,\r\nQP_CONTEXT_QPC_BYTES_4_SQ_WQE_SHIFT_S,\r\nilog2((unsigned int)hr_qp->sq.wqe_cnt));\r\nroce_set_field(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTES_4_RQ_WQE_SHIFT_M,\r\nQP_CONTEXT_QPC_BYTES_4_RQ_WQE_SHIFT_S,\r\nilog2((unsigned int)hr_qp->rq.wqe_cnt));\r\nroce_set_field(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTES_4_PD_M,\r\nQP_CONTEXT_QPC_BYTES_4_PD_S,\r\nto_hr_pd(ibqp->pd)->pdn);\r\nhr_qp->access_flags = attr->qp_access_flags;\r\nroce_set_field(context->qpc_bytes_8,\r\nQP_CONTEXT_QPC_BYTES_8_TX_COMPLETION_M,\r\nQP_CONTEXT_QPC_BYTES_8_TX_COMPLETION_S,\r\nto_hr_cq(ibqp->send_cq)->cqn);\r\nroce_set_field(context->qpc_bytes_8,\r\nQP_CONTEXT_QPC_BYTES_8_RX_COMPLETION_M,\r\nQP_CONTEXT_QPC_BYTES_8_RX_COMPLETION_S,\r\nto_hr_cq(ibqp->recv_cq)->cqn);\r\nif (ibqp->srq)\r\nroce_set_field(context->qpc_bytes_12,\r\nQP_CONTEXT_QPC_BYTES_12_SRQ_NUMBER_M,\r\nQP_CONTEXT_QPC_BYTES_12_SRQ_NUMBER_S,\r\nto_hr_srq(ibqp->srq)->srqn);\r\nroce_set_field(context->qpc_bytes_12,\r\nQP_CONTEXT_QPC_BYTES_12_P_KEY_INDEX_M,\r\nQP_CONTEXT_QPC_BYTES_12_P_KEY_INDEX_S,\r\nattr->pkey_index);\r\nhr_qp->pkey_index = attr->pkey_index;\r\nroce_set_field(context->qpc_bytes_16,\r\nQP_CONTEXT_QPC_BYTES_16_QP_NUM_M,\r\nQP_CONTEXT_QPC_BYTES_16_QP_NUM_S, hr_qp->qpn);\r\n} else if (cur_state == IB_QPS_INIT && new_state == IB_QPS_INIT) {\r\nroce_set_field(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTES_4_TRANSPORT_SERVICE_TYPE_M,\r\nQP_CONTEXT_QPC_BYTES_4_TRANSPORT_SERVICE_TYPE_S,\r\nto_hr_qp_type(hr_qp->ibqp.qp_type));\r\nroce_set_bit(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTE_4_ENABLE_FPMR_S, 0);\r\nif (attr_mask & IB_QP_ACCESS_FLAGS) {\r\nroce_set_bit(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTE_4_RDMA_READ_ENABLE_S,\r\n!!(attr->qp_access_flags &\r\nIB_ACCESS_REMOTE_READ));\r\nroce_set_bit(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTE_4_RDMA_WRITE_ENABLE_S,\r\n!!(attr->qp_access_flags &\r\nIB_ACCESS_REMOTE_WRITE));\r\n} else {\r\nroce_set_bit(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTE_4_RDMA_READ_ENABLE_S,\r\n!!(hr_qp->access_flags &\r\nIB_ACCESS_REMOTE_READ));\r\nroce_set_bit(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTE_4_RDMA_WRITE_ENABLE_S,\r\n!!(hr_qp->access_flags &\r\nIB_ACCESS_REMOTE_WRITE));\r\n}\r\nroce_set_bit(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTE_4_RDMAR_USE_S, 1);\r\nroce_set_field(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTES_4_SQ_WQE_SHIFT_M,\r\nQP_CONTEXT_QPC_BYTES_4_SQ_WQE_SHIFT_S,\r\nilog2((unsigned int)hr_qp->sq.wqe_cnt));\r\nroce_set_field(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTES_4_RQ_WQE_SHIFT_M,\r\nQP_CONTEXT_QPC_BYTES_4_RQ_WQE_SHIFT_S,\r\nilog2((unsigned int)hr_qp->rq.wqe_cnt));\r\nroce_set_field(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTES_4_PD_M,\r\nQP_CONTEXT_QPC_BYTES_4_PD_S,\r\nto_hr_pd(ibqp->pd)->pdn);\r\nroce_set_field(context->qpc_bytes_8,\r\nQP_CONTEXT_QPC_BYTES_8_TX_COMPLETION_M,\r\nQP_CONTEXT_QPC_BYTES_8_TX_COMPLETION_S,\r\nto_hr_cq(ibqp->send_cq)->cqn);\r\nroce_set_field(context->qpc_bytes_8,\r\nQP_CONTEXT_QPC_BYTES_8_RX_COMPLETION_M,\r\nQP_CONTEXT_QPC_BYTES_8_RX_COMPLETION_S,\r\nto_hr_cq(ibqp->recv_cq)->cqn);\r\nif (ibqp->srq)\r\nroce_set_field(context->qpc_bytes_12,\r\nQP_CONTEXT_QPC_BYTES_12_SRQ_NUMBER_M,\r\nQP_CONTEXT_QPC_BYTES_12_SRQ_NUMBER_S,\r\nto_hr_srq(ibqp->srq)->srqn);\r\nif (attr_mask & IB_QP_PKEY_INDEX)\r\nroce_set_field(context->qpc_bytes_12,\r\nQP_CONTEXT_QPC_BYTES_12_P_KEY_INDEX_M,\r\nQP_CONTEXT_QPC_BYTES_12_P_KEY_INDEX_S,\r\nattr->pkey_index);\r\nelse\r\nroce_set_field(context->qpc_bytes_12,\r\nQP_CONTEXT_QPC_BYTES_12_P_KEY_INDEX_M,\r\nQP_CONTEXT_QPC_BYTES_12_P_KEY_INDEX_S,\r\nhr_qp->pkey_index);\r\nroce_set_field(context->qpc_bytes_16,\r\nQP_CONTEXT_QPC_BYTES_16_QP_NUM_M,\r\nQP_CONTEXT_QPC_BYTES_16_QP_NUM_S, hr_qp->qpn);\r\n} else if (cur_state == IB_QPS_INIT && new_state == IB_QPS_RTR) {\r\nif ((attr_mask & IB_QP_ALT_PATH) ||\r\n(attr_mask & IB_QP_ACCESS_FLAGS) ||\r\n(attr_mask & IB_QP_PKEY_INDEX) ||\r\n(attr_mask & IB_QP_QKEY)) {\r\ndev_err(dev, "INIT2RTR attr_mask error\n");\r\ngoto out;\r\n}\r\ndmac = (u8 *)attr->ah_attr.dmac;\r\ncontext->sq_rq_bt_l = (u32)(dma_handle);\r\nroce_set_field(context->qpc_bytes_24,\r\nQP_CONTEXT_QPC_BYTES_24_SQ_RQ_BT_H_M,\r\nQP_CONTEXT_QPC_BYTES_24_SQ_RQ_BT_H_S,\r\n((u32)(dma_handle >> 32)));\r\nroce_set_bit(context->qpc_bytes_24,\r\nQP_CONTEXT_QPC_BYTE_24_REMOTE_ENABLE_E2E_CREDITS_S,\r\n1);\r\nroce_set_field(context->qpc_bytes_24,\r\nQP_CONTEXT_QPC_BYTES_24_MINIMUM_RNR_NAK_TIMER_M,\r\nQP_CONTEXT_QPC_BYTES_24_MINIMUM_RNR_NAK_TIMER_S,\r\nattr->min_rnr_timer);\r\ncontext->irrl_ba_l = (u32)(dma_handle_2);\r\nroce_set_field(context->qpc_bytes_32,\r\nQP_CONTEXT_QPC_BYTES_32_IRRL_BA_H_M,\r\nQP_CONTEXT_QPC_BYTES_32_IRRL_BA_H_S,\r\n((u32)(dma_handle_2 >> 32)) &\r\nQP_CONTEXT_QPC_BYTES_32_IRRL_BA_H_M);\r\nroce_set_field(context->qpc_bytes_32,\r\nQP_CONTEXT_QPC_BYTES_32_MIG_STATE_M,\r\nQP_CONTEXT_QPC_BYTES_32_MIG_STATE_S, 0);\r\nroce_set_bit(context->qpc_bytes_32,\r\nQP_CONTEXT_QPC_BYTE_32_LOCAL_ENABLE_E2E_CREDITS_S,\r\n1);\r\nroce_set_bit(context->qpc_bytes_32,\r\nQP_CONTEXT_QPC_BYTE_32_SIGNALING_TYPE_S,\r\nhr_qp->sq_signal_bits);\r\nport = (attr_mask & IB_QP_PORT) ? (attr->port_num - 1) :\r\nhr_qp->port;\r\nsmac = (u8 *)hr_dev->dev_addr[port];\r\nif (ether_addr_equal_unaligned(dmac, smac) ||\r\nhr_dev->loop_idc == 0x1)\r\nroce_set_bit(context->qpc_bytes_32,\r\nQP_CONTEXT_QPC_BYTE_32_LOOPBACK_INDICATOR_S, 1);\r\nroce_set_bit(context->qpc_bytes_32,\r\nQP_CONTEXT_QPC_BYTE_32_GLOBAL_HEADER_S,\r\nattr->ah_attr.ah_flags);\r\nroce_set_field(context->qpc_bytes_32,\r\nQP_CONTEXT_QPC_BYTES_32_RESPONDER_RESOURCES_M,\r\nQP_CONTEXT_QPC_BYTES_32_RESPONDER_RESOURCES_S,\r\nilog2((unsigned int)attr->max_dest_rd_atomic));\r\nroce_set_field(context->qpc_bytes_36,\r\nQP_CONTEXT_QPC_BYTES_36_DEST_QP_M,\r\nQP_CONTEXT_QPC_BYTES_36_DEST_QP_S,\r\nattr->dest_qp_num);\r\nroce_set_field(context->qpc_bytes_36,\r\nQP_CONTEXT_QPC_BYTES_36_SGID_INDEX_M,\r\nQP_CONTEXT_QPC_BYTES_36_SGID_INDEX_S,\r\nhns_get_gid_index(hr_dev,\r\nattr->ah_attr.port_num - 1,\r\nattr->ah_attr.grh.sgid_index));\r\nmemcpy(&(context->dmac_l), dmac, 4);\r\nroce_set_field(context->qpc_bytes_44,\r\nQP_CONTEXT_QPC_BYTES_44_DMAC_H_M,\r\nQP_CONTEXT_QPC_BYTES_44_DMAC_H_S,\r\n*((u16 *)(&dmac[4])));\r\nroce_set_field(context->qpc_bytes_44,\r\nQP_CONTEXT_QPC_BYTES_44_MAXIMUM_STATIC_RATE_M,\r\nQP_CONTEXT_QPC_BYTES_44_MAXIMUM_STATIC_RATE_S,\r\nattr->ah_attr.static_rate);\r\nroce_set_field(context->qpc_bytes_44,\r\nQP_CONTEXT_QPC_BYTES_44_HOPLMT_M,\r\nQP_CONTEXT_QPC_BYTES_44_HOPLMT_S,\r\nattr->ah_attr.grh.hop_limit);\r\nroce_set_field(context->qpc_bytes_48,\r\nQP_CONTEXT_QPC_BYTES_48_FLOWLABEL_M,\r\nQP_CONTEXT_QPC_BYTES_48_FLOWLABEL_S,\r\nattr->ah_attr.grh.flow_label);\r\nroce_set_field(context->qpc_bytes_48,\r\nQP_CONTEXT_QPC_BYTES_48_TCLASS_M,\r\nQP_CONTEXT_QPC_BYTES_48_TCLASS_S,\r\nattr->ah_attr.grh.traffic_class);\r\nroce_set_field(context->qpc_bytes_48,\r\nQP_CONTEXT_QPC_BYTES_48_MTU_M,\r\nQP_CONTEXT_QPC_BYTES_48_MTU_S, attr->path_mtu);\r\nmemcpy(context->dgid, attr->ah_attr.grh.dgid.raw,\r\nsizeof(attr->ah_attr.grh.dgid.raw));\r\ndev_dbg(dev, "dmac:%x :%lx\n", context->dmac_l,\r\nroce_get_field(context->qpc_bytes_44,\r\nQP_CONTEXT_QPC_BYTES_44_DMAC_H_M,\r\nQP_CONTEXT_QPC_BYTES_44_DMAC_H_S));\r\nroce_set_field(context->qpc_bytes_68,\r\nQP_CONTEXT_QPC_BYTES_68_RQ_HEAD_M,\r\nQP_CONTEXT_QPC_BYTES_68_RQ_HEAD_S,\r\nhr_qp->rq.head);\r\nroce_set_field(context->qpc_bytes_68,\r\nQP_CONTEXT_QPC_BYTES_68_RQ_CUR_INDEX_M,\r\nQP_CONTEXT_QPC_BYTES_68_RQ_CUR_INDEX_S, 0);\r\nrq_pa_start = (u32)hr_qp->rq.offset / PAGE_SIZE;\r\ncontext->cur_rq_wqe_ba_l = (u32)(mtts[rq_pa_start]);\r\nroce_set_field(context->qpc_bytes_76,\r\nQP_CONTEXT_QPC_BYTES_76_CUR_RQ_WQE_BA_H_M,\r\nQP_CONTEXT_QPC_BYTES_76_CUR_RQ_WQE_BA_H_S,\r\nmtts[rq_pa_start] >> 32);\r\nroce_set_field(context->qpc_bytes_76,\r\nQP_CONTEXT_QPC_BYTES_76_RX_REQ_MSN_M,\r\nQP_CONTEXT_QPC_BYTES_76_RX_REQ_MSN_S, 0);\r\ncontext->rx_rnr_time = 0;\r\nroce_set_field(context->qpc_bytes_84,\r\nQP_CONTEXT_QPC_BYTES_84_LAST_ACK_PSN_M,\r\nQP_CONTEXT_QPC_BYTES_84_LAST_ACK_PSN_S,\r\nattr->rq_psn - 1);\r\nroce_set_field(context->qpc_bytes_84,\r\nQP_CONTEXT_QPC_BYTES_84_TRRL_HEAD_M,\r\nQP_CONTEXT_QPC_BYTES_84_TRRL_HEAD_S, 0);\r\nroce_set_field(context->qpc_bytes_88,\r\nQP_CONTEXT_QPC_BYTES_88_RX_REQ_EPSN_M,\r\nQP_CONTEXT_QPC_BYTES_88_RX_REQ_EPSN_S,\r\nattr->rq_psn);\r\nroce_set_bit(context->qpc_bytes_88,\r\nQP_CONTEXT_QPC_BYTES_88_RX_REQ_PSN_ERR_FLAG_S, 0);\r\nroce_set_bit(context->qpc_bytes_88,\r\nQP_CONTEXT_QPC_BYTES_88_RX_LAST_OPCODE_FLG_S, 0);\r\nroce_set_field(context->qpc_bytes_88,\r\nQP_CONTEXT_QPC_BYTES_88_RQ_REQ_LAST_OPERATION_TYPE_M,\r\nQP_CONTEXT_QPC_BYTES_88_RQ_REQ_LAST_OPERATION_TYPE_S,\r\n0);\r\nroce_set_field(context->qpc_bytes_88,\r\nQP_CONTEXT_QPC_BYTES_88_RQ_REQ_RDMA_WR_FLAG_M,\r\nQP_CONTEXT_QPC_BYTES_88_RQ_REQ_RDMA_WR_FLAG_S,\r\n0);\r\ncontext->dma_length = 0;\r\ncontext->r_key = 0;\r\ncontext->va_l = 0;\r\ncontext->va_h = 0;\r\nroce_set_field(context->qpc_bytes_108,\r\nQP_CONTEXT_QPC_BYTES_108_TRRL_SDB_PSN_M,\r\nQP_CONTEXT_QPC_BYTES_108_TRRL_SDB_PSN_S, 0);\r\nroce_set_bit(context->qpc_bytes_108,\r\nQP_CONTEXT_QPC_BYTES_108_TRRL_SDB_PSN_FLG_S, 0);\r\nroce_set_bit(context->qpc_bytes_108,\r\nQP_CONTEXT_QPC_BYTES_108_TRRL_TDB_PSN_FLG_S, 0);\r\nroce_set_field(context->qpc_bytes_112,\r\nQP_CONTEXT_QPC_BYTES_112_TRRL_TDB_PSN_M,\r\nQP_CONTEXT_QPC_BYTES_112_TRRL_TDB_PSN_S, 0);\r\nroce_set_field(context->qpc_bytes_112,\r\nQP_CONTEXT_QPC_BYTES_112_TRRL_TAIL_M,\r\nQP_CONTEXT_QPC_BYTES_112_TRRL_TAIL_S, 0);\r\nroce_set_field(context->qpc_bytes_156,\r\nQP_CONTEXT_QPC_BYTES_156_PORT_NUM_M,\r\nQP_CONTEXT_QPC_BYTES_156_PORT_NUM_S,\r\nhr_qp->phy_port);\r\nroce_set_field(context->qpc_bytes_156,\r\nQP_CONTEXT_QPC_BYTES_156_SL_M,\r\nQP_CONTEXT_QPC_BYTES_156_SL_S, attr->ah_attr.sl);\r\nhr_qp->sl = attr->ah_attr.sl;\r\n} else if (cur_state == IB_QPS_RTR &&\r\nnew_state == IB_QPS_RTS) {\r\nif ((attr_mask & IB_QP_ALT_PATH) ||\r\n(attr_mask & IB_QP_ACCESS_FLAGS) ||\r\n(attr_mask & IB_QP_QKEY) ||\r\n(attr_mask & IB_QP_PATH_MIG_STATE) ||\r\n(attr_mask & IB_QP_CUR_STATE) ||\r\n(attr_mask & IB_QP_MIN_RNR_TIMER)) {\r\ndev_err(dev, "RTR2RTS attr_mask error\n");\r\ngoto out;\r\n}\r\ncontext->rx_cur_sq_wqe_ba_l = (u32)(mtts[0]);\r\nroce_set_field(context->qpc_bytes_120,\r\nQP_CONTEXT_QPC_BYTES_120_RX_CUR_SQ_WQE_BA_H_M,\r\nQP_CONTEXT_QPC_BYTES_120_RX_CUR_SQ_WQE_BA_H_S,\r\n(mtts[0]) >> 32);\r\nroce_set_field(context->qpc_bytes_124,\r\nQP_CONTEXT_QPC_BYTES_124_RX_ACK_MSN_M,\r\nQP_CONTEXT_QPC_BYTES_124_RX_ACK_MSN_S, 0);\r\nroce_set_field(context->qpc_bytes_124,\r\nQP_CONTEXT_QPC_BYTES_124_IRRL_MSG_IDX_M,\r\nQP_CONTEXT_QPC_BYTES_124_IRRL_MSG_IDX_S, 0);\r\nroce_set_field(context->qpc_bytes_128,\r\nQP_CONTEXT_QPC_BYTES_128_RX_ACK_EPSN_M,\r\nQP_CONTEXT_QPC_BYTES_128_RX_ACK_EPSN_S,\r\nattr->sq_psn);\r\nroce_set_bit(context->qpc_bytes_128,\r\nQP_CONTEXT_QPC_BYTES_128_RX_ACK_PSN_ERR_FLG_S, 0);\r\nroce_set_field(context->qpc_bytes_128,\r\nQP_CONTEXT_QPC_BYTES_128_ACK_LAST_OPERATION_TYPE_M,\r\nQP_CONTEXT_QPC_BYTES_128_ACK_LAST_OPERATION_TYPE_S,\r\n0);\r\nroce_set_bit(context->qpc_bytes_128,\r\nQP_CONTEXT_QPC_BYTES_128_IRRL_PSN_VLD_FLG_S, 0);\r\nroce_set_field(context->qpc_bytes_132,\r\nQP_CONTEXT_QPC_BYTES_132_IRRL_PSN_M,\r\nQP_CONTEXT_QPC_BYTES_132_IRRL_PSN_S, 0);\r\nroce_set_field(context->qpc_bytes_132,\r\nQP_CONTEXT_QPC_BYTES_132_IRRL_TAIL_M,\r\nQP_CONTEXT_QPC_BYTES_132_IRRL_TAIL_S, 0);\r\nroce_set_field(context->qpc_bytes_136,\r\nQP_CONTEXT_QPC_BYTES_136_RETRY_MSG_PSN_M,\r\nQP_CONTEXT_QPC_BYTES_136_RETRY_MSG_PSN_S,\r\nattr->sq_psn);\r\nroce_set_field(context->qpc_bytes_136,\r\nQP_CONTEXT_QPC_BYTES_136_RETRY_MSG_FPKT_PSN_L_M,\r\nQP_CONTEXT_QPC_BYTES_136_RETRY_MSG_FPKT_PSN_L_S,\r\nattr->sq_psn);\r\nroce_set_field(context->qpc_bytes_140,\r\nQP_CONTEXT_QPC_BYTES_140_RETRY_MSG_FPKT_PSN_H_M,\r\nQP_CONTEXT_QPC_BYTES_140_RETRY_MSG_FPKT_PSN_H_S,\r\n(attr->sq_psn >> SQ_PSN_SHIFT));\r\nroce_set_field(context->qpc_bytes_140,\r\nQP_CONTEXT_QPC_BYTES_140_RETRY_MSG_MSN_M,\r\nQP_CONTEXT_QPC_BYTES_140_RETRY_MSG_MSN_S, 0);\r\nroce_set_bit(context->qpc_bytes_140,\r\nQP_CONTEXT_QPC_BYTES_140_RNR_RETRY_FLG_S, 0);\r\nroce_set_field(context->qpc_bytes_148,\r\nQP_CONTEXT_QPC_BYTES_148_CHECK_FLAG_M,\r\nQP_CONTEXT_QPC_BYTES_148_CHECK_FLAG_S, 0);\r\nroce_set_field(context->qpc_bytes_148,\r\nQP_CONTEXT_QPC_BYTES_148_RETRY_COUNT_M,\r\nQP_CONTEXT_QPC_BYTES_148_RETRY_COUNT_S,\r\nattr->retry_cnt);\r\nroce_set_field(context->qpc_bytes_148,\r\nQP_CONTEXT_QPC_BYTES_148_RNR_RETRY_COUNT_M,\r\nQP_CONTEXT_QPC_BYTES_148_RNR_RETRY_COUNT_S,\r\nattr->rnr_retry);\r\nroce_set_field(context->qpc_bytes_148,\r\nQP_CONTEXT_QPC_BYTES_148_LSN_M,\r\nQP_CONTEXT_QPC_BYTES_148_LSN_S, 0x100);\r\ncontext->rnr_retry = 0;\r\nroce_set_field(context->qpc_bytes_156,\r\nQP_CONTEXT_QPC_BYTES_156_RETRY_COUNT_INIT_M,\r\nQP_CONTEXT_QPC_BYTES_156_RETRY_COUNT_INIT_S,\r\nattr->retry_cnt);\r\nif (attr->timeout < 0x12) {\r\ndev_info(dev, "ack timeout value(0x%x) must bigger than 0x12.\n",\r\nattr->timeout);\r\nroce_set_field(context->qpc_bytes_156,\r\nQP_CONTEXT_QPC_BYTES_156_ACK_TIMEOUT_M,\r\nQP_CONTEXT_QPC_BYTES_156_ACK_TIMEOUT_S,\r\n0x12);\r\n} else {\r\nroce_set_field(context->qpc_bytes_156,\r\nQP_CONTEXT_QPC_BYTES_156_ACK_TIMEOUT_M,\r\nQP_CONTEXT_QPC_BYTES_156_ACK_TIMEOUT_S,\r\nattr->timeout);\r\n}\r\nroce_set_field(context->qpc_bytes_156,\r\nQP_CONTEXT_QPC_BYTES_156_RNR_RETRY_COUNT_INIT_M,\r\nQP_CONTEXT_QPC_BYTES_156_RNR_RETRY_COUNT_INIT_S,\r\nattr->rnr_retry);\r\nroce_set_field(context->qpc_bytes_156,\r\nQP_CONTEXT_QPC_BYTES_156_PORT_NUM_M,\r\nQP_CONTEXT_QPC_BYTES_156_PORT_NUM_S,\r\nhr_qp->phy_port);\r\nroce_set_field(context->qpc_bytes_156,\r\nQP_CONTEXT_QPC_BYTES_156_SL_M,\r\nQP_CONTEXT_QPC_BYTES_156_SL_S, attr->ah_attr.sl);\r\nhr_qp->sl = attr->ah_attr.sl;\r\nroce_set_field(context->qpc_bytes_156,\r\nQP_CONTEXT_QPC_BYTES_156_INITIATOR_DEPTH_M,\r\nQP_CONTEXT_QPC_BYTES_156_INITIATOR_DEPTH_S,\r\nilog2((unsigned int)attr->max_rd_atomic));\r\nroce_set_field(context->qpc_bytes_156,\r\nQP_CONTEXT_QPC_BYTES_156_ACK_REQ_IND_M,\r\nQP_CONTEXT_QPC_BYTES_156_ACK_REQ_IND_S, 0);\r\ncontext->pkt_use_len = 0;\r\nroce_set_field(context->qpc_bytes_164,\r\nQP_CONTEXT_QPC_BYTES_164_SQ_PSN_M,\r\nQP_CONTEXT_QPC_BYTES_164_SQ_PSN_S, attr->sq_psn);\r\nroce_set_field(context->qpc_bytes_164,\r\nQP_CONTEXT_QPC_BYTES_164_IRRL_HEAD_M,\r\nQP_CONTEXT_QPC_BYTES_164_IRRL_HEAD_S, 0);\r\nroce_set_field(context->qpc_bytes_168,\r\nQP_CONTEXT_QPC_BYTES_168_RETRY_SQ_PSN_M,\r\nQP_CONTEXT_QPC_BYTES_168_RETRY_SQ_PSN_S,\r\nattr->sq_psn);\r\nroce_set_field(context->qpc_bytes_168,\r\nQP_CONTEXT_QPC_BYTES_168_SGE_USE_FLA_M,\r\nQP_CONTEXT_QPC_BYTES_168_SGE_USE_FLA_S, 0);\r\nroce_set_field(context->qpc_bytes_168,\r\nQP_CONTEXT_QPC_BYTES_168_DB_TYPE_M,\r\nQP_CONTEXT_QPC_BYTES_168_DB_TYPE_S, 0);\r\nroce_set_bit(context->qpc_bytes_168,\r\nQP_CONTEXT_QPC_BYTES_168_MSG_LP_IND_S, 0);\r\nroce_set_bit(context->qpc_bytes_168,\r\nQP_CONTEXT_QPC_BYTES_168_CSDB_LP_IND_S, 0);\r\nroce_set_bit(context->qpc_bytes_168,\r\nQP_CONTEXT_QPC_BYTES_168_QP_ERR_FLG_S, 0);\r\ncontext->sge_use_len = 0;\r\nroce_set_field(context->qpc_bytes_176,\r\nQP_CONTEXT_QPC_BYTES_176_DB_CUR_INDEX_M,\r\nQP_CONTEXT_QPC_BYTES_176_DB_CUR_INDEX_S, 0);\r\nroce_set_field(context->qpc_bytes_176,\r\nQP_CONTEXT_QPC_BYTES_176_RETRY_DB_CUR_INDEX_M,\r\nQP_CONTEXT_QPC_BYTES_176_RETRY_DB_CUR_INDEX_S,\r\n0);\r\nroce_set_field(context->qpc_bytes_180,\r\nQP_CONTEXT_QPC_BYTES_180_SQ_CUR_INDEX_M,\r\nQP_CONTEXT_QPC_BYTES_180_SQ_CUR_INDEX_S, 0);\r\nroce_set_field(context->qpc_bytes_180,\r\nQP_CONTEXT_QPC_BYTES_180_SQ_HEAD_M,\r\nQP_CONTEXT_QPC_BYTES_180_SQ_HEAD_S, 0);\r\ncontext->tx_cur_sq_wqe_ba_l = (u32)(mtts[0]);\r\nroce_set_field(context->qpc_bytes_188,\r\nQP_CONTEXT_QPC_BYTES_188_TX_CUR_SQ_WQE_BA_H_M,\r\nQP_CONTEXT_QPC_BYTES_188_TX_CUR_SQ_WQE_BA_H_S,\r\n(mtts[0]) >> 32);\r\nroce_set_bit(context->qpc_bytes_188,\r\nQP_CONTEXT_QPC_BYTES_188_PKT_RETRY_FLG_S, 0);\r\nroce_set_field(context->qpc_bytes_188,\r\nQP_CONTEXT_QPC_BYTES_188_TX_RETRY_CUR_INDEX_M,\r\nQP_CONTEXT_QPC_BYTES_188_TX_RETRY_CUR_INDEX_S,\r\n0);\r\n} else if (!((cur_state == IB_QPS_INIT && new_state == IB_QPS_RESET) ||\r\n(cur_state == IB_QPS_INIT && new_state == IB_QPS_ERR) ||\r\n(cur_state == IB_QPS_RTR && new_state == IB_QPS_RESET) ||\r\n(cur_state == IB_QPS_RTR && new_state == IB_QPS_ERR) ||\r\n(cur_state == IB_QPS_RTS && new_state == IB_QPS_RESET) ||\r\n(cur_state == IB_QPS_RTS && new_state == IB_QPS_ERR) ||\r\n(cur_state == IB_QPS_ERR && new_state == IB_QPS_RESET) ||\r\n(cur_state == IB_QPS_ERR && new_state == IB_QPS_ERR))) {\r\ndev_err(dev, "not support this status migration\n");\r\ngoto out;\r\n}\r\nroce_set_field(context->qpc_bytes_144,\r\nQP_CONTEXT_QPC_BYTES_144_QP_STATE_M,\r\nQP_CONTEXT_QPC_BYTES_144_QP_STATE_S, new_state);\r\nret = hns_roce_v1_qp_modify(hr_dev, &hr_qp->mtt,\r\nto_hns_roce_state(cur_state),\r\nto_hns_roce_state(new_state), context,\r\nhr_qp);\r\nif (ret) {\r\ndev_err(dev, "hns_roce_qp_modify failed\n");\r\ngoto out;\r\n}\r\nif (cur_state == IB_QPS_INIT && new_state == IB_QPS_INIT) {\r\nwmb();\r\nroce_set_field(doorbell[0], RQ_DOORBELL_U32_4_RQ_HEAD_M,\r\nRQ_DOORBELL_U32_4_RQ_HEAD_S, hr_qp->rq.head);\r\nroce_set_field(doorbell[1], RQ_DOORBELL_U32_8_QPN_M,\r\nRQ_DOORBELL_U32_8_QPN_S, hr_qp->qpn);\r\nroce_set_field(doorbell[1], RQ_DOORBELL_U32_8_CMD_M,\r\nRQ_DOORBELL_U32_8_CMD_S, 1);\r\nroce_set_bit(doorbell[1], RQ_DOORBELL_U32_8_HW_SYNC_S, 1);\r\nif (ibqp->uobject) {\r\nhr_qp->rq.db_reg_l = hr_dev->reg_base +\r\nROCEE_DB_OTHERS_L_0_REG +\r\nDB_REG_OFFSET * hr_dev->priv_uar.index;\r\n}\r\nhns_roce_write64_k(doorbell, hr_qp->rq.db_reg_l);\r\n}\r\nhr_qp->state = new_state;\r\nif (attr_mask & IB_QP_MAX_DEST_RD_ATOMIC)\r\nhr_qp->resp_depth = attr->max_dest_rd_atomic;\r\nif (attr_mask & IB_QP_PORT) {\r\nhr_qp->port = attr->port_num - 1;\r\nhr_qp->phy_port = hr_dev->iboe.phy_port[hr_qp->port];\r\n}\r\nif (new_state == IB_QPS_RESET && !ibqp->uobject) {\r\nhns_roce_v1_cq_clean(to_hr_cq(ibqp->recv_cq), hr_qp->qpn,\r\nibqp->srq ? to_hr_srq(ibqp->srq) : NULL);\r\nif (ibqp->send_cq != ibqp->recv_cq)\r\nhns_roce_v1_cq_clean(to_hr_cq(ibqp->send_cq),\r\nhr_qp->qpn, NULL);\r\nhr_qp->rq.head = 0;\r\nhr_qp->rq.tail = 0;\r\nhr_qp->sq.head = 0;\r\nhr_qp->sq.tail = 0;\r\nhr_qp->sq_next_wqe = 0;\r\n}\r\nout:\r\nkfree(context);\r\nreturn ret;\r\n}\r\nint hns_roce_v1_modify_qp(struct ib_qp *ibqp, const struct ib_qp_attr *attr,\r\nint attr_mask, enum ib_qp_state cur_state,\r\nenum ib_qp_state new_state)\r\n{\r\nif (ibqp->qp_type == IB_QPT_GSI || ibqp->qp_type == IB_QPT_SMI)\r\nreturn hns_roce_v1_m_sqp(ibqp, attr, attr_mask, cur_state,\r\nnew_state);\r\nelse\r\nreturn hns_roce_v1_m_qp(ibqp, attr, attr_mask, cur_state,\r\nnew_state);\r\n}\r\nstatic enum ib_qp_state to_ib_qp_state(enum hns_roce_qp_state state)\r\n{\r\nswitch (state) {\r\ncase HNS_ROCE_QP_STATE_RST:\r\nreturn IB_QPS_RESET;\r\ncase HNS_ROCE_QP_STATE_INIT:\r\nreturn IB_QPS_INIT;\r\ncase HNS_ROCE_QP_STATE_RTR:\r\nreturn IB_QPS_RTR;\r\ncase HNS_ROCE_QP_STATE_RTS:\r\nreturn IB_QPS_RTS;\r\ncase HNS_ROCE_QP_STATE_SQD:\r\nreturn IB_QPS_SQD;\r\ncase HNS_ROCE_QP_STATE_ERR:\r\nreturn IB_QPS_ERR;\r\ndefault:\r\nreturn IB_QPS_ERR;\r\n}\r\n}\r\nstatic int hns_roce_v1_query_qpc(struct hns_roce_dev *hr_dev,\r\nstruct hns_roce_qp *hr_qp,\r\nstruct hns_roce_qp_context *hr_context)\r\n{\r\nstruct hns_roce_cmd_mailbox *mailbox;\r\nint ret;\r\nmailbox = hns_roce_alloc_cmd_mailbox(hr_dev);\r\nif (IS_ERR(mailbox))\r\nreturn PTR_ERR(mailbox);\r\nret = hns_roce_cmd_mbox(hr_dev, 0, mailbox->dma, hr_qp->qpn, 0,\r\nHNS_ROCE_CMD_QUERY_QP,\r\nHNS_ROCE_CMD_TIMEOUT_MSECS);\r\nif (!ret)\r\nmemcpy(hr_context, mailbox->buf, sizeof(*hr_context));\r\nelse\r\ndev_err(&hr_dev->pdev->dev, "QUERY QP cmd process error\n");\r\nhns_roce_free_cmd_mailbox(hr_dev, mailbox);\r\nreturn ret;\r\n}\r\nstatic int hns_roce_v1_q_sqp(struct ib_qp *ibqp, struct ib_qp_attr *qp_attr,\r\nint qp_attr_mask,\r\nstruct ib_qp_init_attr *qp_init_attr)\r\n{\r\nstruct hns_roce_dev *hr_dev = to_hr_dev(ibqp->device);\r\nstruct hns_roce_qp *hr_qp = to_hr_qp(ibqp);\r\nstruct hns_roce_sqp_context context;\r\nu32 addr;\r\nmutex_lock(&hr_qp->mutex);\r\nif (hr_qp->state == IB_QPS_RESET) {\r\nqp_attr->qp_state = IB_QPS_RESET;\r\ngoto done;\r\n}\r\naddr = ROCEE_QP1C_CFG0_0_REG +\r\nhr_qp->port * sizeof(struct hns_roce_sqp_context);\r\ncontext.qp1c_bytes_4 = roce_read(hr_dev, addr);\r\ncontext.sq_rq_bt_l = roce_read(hr_dev, addr + 1);\r\ncontext.qp1c_bytes_12 = roce_read(hr_dev, addr + 2);\r\ncontext.qp1c_bytes_16 = roce_read(hr_dev, addr + 3);\r\ncontext.qp1c_bytes_20 = roce_read(hr_dev, addr + 4);\r\ncontext.cur_rq_wqe_ba_l = roce_read(hr_dev, addr + 5);\r\ncontext.qp1c_bytes_28 = roce_read(hr_dev, addr + 6);\r\ncontext.qp1c_bytes_32 = roce_read(hr_dev, addr + 7);\r\ncontext.cur_sq_wqe_ba_l = roce_read(hr_dev, addr + 8);\r\ncontext.qp1c_bytes_40 = roce_read(hr_dev, addr + 9);\r\nhr_qp->state = roce_get_field(context.qp1c_bytes_4,\r\nQP1C_BYTES_4_QP_STATE_M,\r\nQP1C_BYTES_4_QP_STATE_S);\r\nqp_attr->qp_state = hr_qp->state;\r\nqp_attr->path_mtu = IB_MTU_256;\r\nqp_attr->path_mig_state = IB_MIG_ARMED;\r\nqp_attr->qkey = QKEY_VAL;\r\nqp_attr->rq_psn = 0;\r\nqp_attr->sq_psn = 0;\r\nqp_attr->dest_qp_num = 1;\r\nqp_attr->qp_access_flags = 6;\r\nqp_attr->pkey_index = roce_get_field(context.qp1c_bytes_20,\r\nQP1C_BYTES_20_PKEY_IDX_M,\r\nQP1C_BYTES_20_PKEY_IDX_S);\r\nqp_attr->port_num = hr_qp->port + 1;\r\nqp_attr->sq_draining = 0;\r\nqp_attr->max_rd_atomic = 0;\r\nqp_attr->max_dest_rd_atomic = 0;\r\nqp_attr->min_rnr_timer = 0;\r\nqp_attr->timeout = 0;\r\nqp_attr->retry_cnt = 0;\r\nqp_attr->rnr_retry = 0;\r\nqp_attr->alt_timeout = 0;\r\ndone:\r\nqp_attr->cur_qp_state = qp_attr->qp_state;\r\nqp_attr->cap.max_recv_wr = hr_qp->rq.wqe_cnt;\r\nqp_attr->cap.max_recv_sge = hr_qp->rq.max_gs;\r\nqp_attr->cap.max_send_wr = hr_qp->sq.wqe_cnt;\r\nqp_attr->cap.max_send_sge = hr_qp->sq.max_gs;\r\nqp_attr->cap.max_inline_data = 0;\r\nqp_init_attr->cap = qp_attr->cap;\r\nqp_init_attr->create_flags = 0;\r\nmutex_unlock(&hr_qp->mutex);\r\nreturn 0;\r\n}\r\nstatic int hns_roce_v1_q_qp(struct ib_qp *ibqp, struct ib_qp_attr *qp_attr,\r\nint qp_attr_mask,\r\nstruct ib_qp_init_attr *qp_init_attr)\r\n{\r\nstruct hns_roce_dev *hr_dev = to_hr_dev(ibqp->device);\r\nstruct hns_roce_qp *hr_qp = to_hr_qp(ibqp);\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_qp_context *context;\r\nint tmp_qp_state = 0;\r\nint ret = 0;\r\nint state;\r\ncontext = kzalloc(sizeof(*context), GFP_KERNEL);\r\nif (!context)\r\nreturn -ENOMEM;\r\nmemset(qp_attr, 0, sizeof(*qp_attr));\r\nmemset(qp_init_attr, 0, sizeof(*qp_init_attr));\r\nmutex_lock(&hr_qp->mutex);\r\nif (hr_qp->state == IB_QPS_RESET) {\r\nqp_attr->qp_state = IB_QPS_RESET;\r\ngoto done;\r\n}\r\nret = hns_roce_v1_query_qpc(hr_dev, hr_qp, context);\r\nif (ret) {\r\ndev_err(dev, "query qpc error\n");\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nstate = roce_get_field(context->qpc_bytes_144,\r\nQP_CONTEXT_QPC_BYTES_144_QP_STATE_M,\r\nQP_CONTEXT_QPC_BYTES_144_QP_STATE_S);\r\ntmp_qp_state = (int)to_ib_qp_state((enum hns_roce_qp_state)state);\r\nif (tmp_qp_state == -1) {\r\ndev_err(dev, "to_ib_qp_state error\n");\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nhr_qp->state = (u8)tmp_qp_state;\r\nqp_attr->qp_state = (enum ib_qp_state)hr_qp->state;\r\nqp_attr->path_mtu = (enum ib_mtu)roce_get_field(context->qpc_bytes_48,\r\nQP_CONTEXT_QPC_BYTES_48_MTU_M,\r\nQP_CONTEXT_QPC_BYTES_48_MTU_S);\r\nqp_attr->path_mig_state = IB_MIG_ARMED;\r\nif (hr_qp->ibqp.qp_type == IB_QPT_UD)\r\nqp_attr->qkey = QKEY_VAL;\r\nqp_attr->rq_psn = roce_get_field(context->qpc_bytes_88,\r\nQP_CONTEXT_QPC_BYTES_88_RX_REQ_EPSN_M,\r\nQP_CONTEXT_QPC_BYTES_88_RX_REQ_EPSN_S);\r\nqp_attr->sq_psn = (u32)roce_get_field(context->qpc_bytes_164,\r\nQP_CONTEXT_QPC_BYTES_164_SQ_PSN_M,\r\nQP_CONTEXT_QPC_BYTES_164_SQ_PSN_S);\r\nqp_attr->dest_qp_num = (u8)roce_get_field(context->qpc_bytes_36,\r\nQP_CONTEXT_QPC_BYTES_36_DEST_QP_M,\r\nQP_CONTEXT_QPC_BYTES_36_DEST_QP_S);\r\nqp_attr->qp_access_flags = ((roce_get_bit(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTE_4_RDMA_READ_ENABLE_S)) << 2) |\r\n((roce_get_bit(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTE_4_RDMA_WRITE_ENABLE_S)) << 1) |\r\n((roce_get_bit(context->qpc_bytes_4,\r\nQP_CONTEXT_QPC_BYTE_4_ATOMIC_OPERATION_ENABLE_S)) << 3);\r\nif (hr_qp->ibqp.qp_type == IB_QPT_RC ||\r\nhr_qp->ibqp.qp_type == IB_QPT_UC) {\r\nqp_attr->ah_attr.sl = roce_get_field(context->qpc_bytes_156,\r\nQP_CONTEXT_QPC_BYTES_156_SL_M,\r\nQP_CONTEXT_QPC_BYTES_156_SL_S);\r\nqp_attr->ah_attr.grh.flow_label = roce_get_field(\r\ncontext->qpc_bytes_48,\r\nQP_CONTEXT_QPC_BYTES_48_FLOWLABEL_M,\r\nQP_CONTEXT_QPC_BYTES_48_FLOWLABEL_S);\r\nqp_attr->ah_attr.grh.sgid_index = roce_get_field(\r\ncontext->qpc_bytes_36,\r\nQP_CONTEXT_QPC_BYTES_36_SGID_INDEX_M,\r\nQP_CONTEXT_QPC_BYTES_36_SGID_INDEX_S);\r\nqp_attr->ah_attr.grh.hop_limit = roce_get_field(\r\ncontext->qpc_bytes_44,\r\nQP_CONTEXT_QPC_BYTES_44_HOPLMT_M,\r\nQP_CONTEXT_QPC_BYTES_44_HOPLMT_S);\r\nqp_attr->ah_attr.grh.traffic_class = roce_get_field(\r\ncontext->qpc_bytes_48,\r\nQP_CONTEXT_QPC_BYTES_48_TCLASS_M,\r\nQP_CONTEXT_QPC_BYTES_48_TCLASS_S);\r\nmemcpy(qp_attr->ah_attr.grh.dgid.raw, context->dgid,\r\nsizeof(qp_attr->ah_attr.grh.dgid.raw));\r\n}\r\nqp_attr->pkey_index = roce_get_field(context->qpc_bytes_12,\r\nQP_CONTEXT_QPC_BYTES_12_P_KEY_INDEX_M,\r\nQP_CONTEXT_QPC_BYTES_12_P_KEY_INDEX_S);\r\nqp_attr->port_num = hr_qp->port + 1;\r\nqp_attr->sq_draining = 0;\r\nqp_attr->max_rd_atomic = roce_get_field(context->qpc_bytes_156,\r\nQP_CONTEXT_QPC_BYTES_156_INITIATOR_DEPTH_M,\r\nQP_CONTEXT_QPC_BYTES_156_INITIATOR_DEPTH_S);\r\nqp_attr->max_dest_rd_atomic = roce_get_field(context->qpc_bytes_32,\r\nQP_CONTEXT_QPC_BYTES_32_RESPONDER_RESOURCES_M,\r\nQP_CONTEXT_QPC_BYTES_32_RESPONDER_RESOURCES_S);\r\nqp_attr->min_rnr_timer = (u8)(roce_get_field(context->qpc_bytes_24,\r\nQP_CONTEXT_QPC_BYTES_24_MINIMUM_RNR_NAK_TIMER_M,\r\nQP_CONTEXT_QPC_BYTES_24_MINIMUM_RNR_NAK_TIMER_S));\r\nqp_attr->timeout = (u8)(roce_get_field(context->qpc_bytes_156,\r\nQP_CONTEXT_QPC_BYTES_156_ACK_TIMEOUT_M,\r\nQP_CONTEXT_QPC_BYTES_156_ACK_TIMEOUT_S));\r\nqp_attr->retry_cnt = roce_get_field(context->qpc_bytes_148,\r\nQP_CONTEXT_QPC_BYTES_148_RETRY_COUNT_M,\r\nQP_CONTEXT_QPC_BYTES_148_RETRY_COUNT_S);\r\nqp_attr->rnr_retry = context->rnr_retry;\r\ndone:\r\nqp_attr->cur_qp_state = qp_attr->qp_state;\r\nqp_attr->cap.max_recv_wr = hr_qp->rq.wqe_cnt;\r\nqp_attr->cap.max_recv_sge = hr_qp->rq.max_gs;\r\nif (!ibqp->uobject) {\r\nqp_attr->cap.max_send_wr = hr_qp->sq.wqe_cnt;\r\nqp_attr->cap.max_send_sge = hr_qp->sq.max_gs;\r\n} else {\r\nqp_attr->cap.max_send_wr = 0;\r\nqp_attr->cap.max_send_sge = 0;\r\n}\r\nqp_init_attr->cap = qp_attr->cap;\r\nout:\r\nmutex_unlock(&hr_qp->mutex);\r\nkfree(context);\r\nreturn ret;\r\n}\r\nint hns_roce_v1_query_qp(struct ib_qp *ibqp, struct ib_qp_attr *qp_attr,\r\nint qp_attr_mask, struct ib_qp_init_attr *qp_init_attr)\r\n{\r\nstruct hns_roce_qp *hr_qp = to_hr_qp(ibqp);\r\nreturn hr_qp->doorbell_qpn <= 1 ?\r\nhns_roce_v1_q_sqp(ibqp, qp_attr, qp_attr_mask, qp_init_attr) :\r\nhns_roce_v1_q_qp(ibqp, qp_attr, qp_attr_mask, qp_init_attr);\r\n}\r\nstatic int check_qp_db_process_status(struct hns_roce_dev *hr_dev,\r\nstruct hns_roce_qp *hr_qp,\r\nu32 sdb_issue_ptr,\r\nu32 *sdb_inv_cnt,\r\nu32 *wait_stage)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nu32 sdb_retry_cnt, old_retry;\r\nu32 sdb_send_ptr, old_send;\r\nu32 success_flags = 0;\r\nu32 cur_cnt, old_cnt;\r\nunsigned long end;\r\nu32 send_ptr;\r\nu32 inv_cnt;\r\nu32 tsp_st;\r\nif (*wait_stage > HNS_ROCE_V1_DB_STAGE2 ||\r\n*wait_stage < HNS_ROCE_V1_DB_STAGE1) {\r\ndev_err(dev, "QP(0x%lx) db status wait stage(%d) error!\n",\r\nhr_qp->qpn, *wait_stage);\r\nreturn -EINVAL;\r\n}\r\nend = msecs_to_jiffies(HNS_ROCE_V1_CHECK_DB_TIMEOUT_MSECS) + jiffies;\r\nif (*wait_stage == HNS_ROCE_V1_DB_STAGE1) {\r\nsdb_send_ptr = roce_read(hr_dev, ROCEE_SDB_SEND_PTR_REG);\r\nwhile (roce_hw_index_cmp_lt(sdb_send_ptr, sdb_issue_ptr,\r\nROCEE_SDB_PTR_CMP_BITS)) {\r\nif (!time_before(jiffies, end)) {\r\ndev_dbg(dev, "QP(0x%lx) db process stage1 timeout. issue 0x%x send 0x%x.\n",\r\nhr_qp->qpn, sdb_issue_ptr,\r\nsdb_send_ptr);\r\nreturn 0;\r\n}\r\nmsleep(HNS_ROCE_V1_CHECK_DB_SLEEP_MSECS);\r\nsdb_send_ptr = roce_read(hr_dev,\r\nROCEE_SDB_SEND_PTR_REG);\r\n}\r\nif (roce_get_field(sdb_issue_ptr,\r\nROCEE_SDB_ISSUE_PTR_SDB_ISSUE_PTR_M,\r\nROCEE_SDB_ISSUE_PTR_SDB_ISSUE_PTR_S) ==\r\nroce_get_field(sdb_send_ptr,\r\nROCEE_SDB_SEND_PTR_SDB_SEND_PTR_M,\r\nROCEE_SDB_SEND_PTR_SDB_SEND_PTR_S)) {\r\nold_send = roce_read(hr_dev, ROCEE_SDB_SEND_PTR_REG);\r\nold_retry = roce_read(hr_dev, ROCEE_SDB_RETRY_CNT_REG);\r\ndo {\r\ntsp_st = roce_read(hr_dev, ROCEE_TSP_BP_ST_REG);\r\nif (roce_get_bit(tsp_st,\r\nROCEE_TSP_BP_ST_QH_FIFO_ENTRY_S) == 1) {\r\n*wait_stage = HNS_ROCE_V1_DB_WAIT_OK;\r\nreturn 0;\r\n}\r\nif (!time_before(jiffies, end)) {\r\ndev_dbg(dev, "QP(0x%lx) db process stage1 timeout when send ptr equals issue ptr.\n"\r\n"issue 0x%x send 0x%x.\n",\r\nhr_qp->qpn, sdb_issue_ptr,\r\nsdb_send_ptr);\r\nreturn 0;\r\n}\r\nmsleep(HNS_ROCE_V1_CHECK_DB_SLEEP_MSECS);\r\nsdb_send_ptr = roce_read(hr_dev,\r\nROCEE_SDB_SEND_PTR_REG);\r\nsdb_retry_cnt = roce_read(hr_dev,\r\nROCEE_SDB_RETRY_CNT_REG);\r\ncur_cnt = roce_get_field(sdb_send_ptr,\r\nROCEE_SDB_SEND_PTR_SDB_SEND_PTR_M,\r\nROCEE_SDB_SEND_PTR_SDB_SEND_PTR_S) +\r\nroce_get_field(sdb_retry_cnt,\r\nROCEE_SDB_RETRY_CNT_SDB_RETRY_CT_M,\r\nROCEE_SDB_RETRY_CNT_SDB_RETRY_CT_S);\r\nif (!roce_get_bit(tsp_st,\r\nROCEE_CNT_CLR_CE_CNT_CLR_CE_S)) {\r\nold_cnt = roce_get_field(old_send,\r\nROCEE_SDB_SEND_PTR_SDB_SEND_PTR_M,\r\nROCEE_SDB_SEND_PTR_SDB_SEND_PTR_S) +\r\nroce_get_field(old_retry,\r\nROCEE_SDB_RETRY_CNT_SDB_RETRY_CT_M,\r\nROCEE_SDB_RETRY_CNT_SDB_RETRY_CT_S);\r\nif (cur_cnt - old_cnt > SDB_ST_CMP_VAL)\r\nsuccess_flags = 1;\r\n} else {\r\nold_cnt = roce_get_field(old_send,\r\nROCEE_SDB_SEND_PTR_SDB_SEND_PTR_M,\r\nROCEE_SDB_SEND_PTR_SDB_SEND_PTR_S);\r\nif (cur_cnt - old_cnt > SDB_ST_CMP_VAL)\r\nsuccess_flags = 1;\r\nelse {\r\nsend_ptr = roce_get_field(old_send,\r\nROCEE_SDB_SEND_PTR_SDB_SEND_PTR_M,\r\nROCEE_SDB_SEND_PTR_SDB_SEND_PTR_S) +\r\nroce_get_field(sdb_retry_cnt,\r\nROCEE_SDB_RETRY_CNT_SDB_RETRY_CT_M,\r\nROCEE_SDB_RETRY_CNT_SDB_RETRY_CT_S);\r\nroce_set_field(old_send,\r\nROCEE_SDB_SEND_PTR_SDB_SEND_PTR_M,\r\nROCEE_SDB_SEND_PTR_SDB_SEND_PTR_S,\r\nsend_ptr);\r\n}\r\n}\r\n} while (!success_flags);\r\n}\r\n*wait_stage = HNS_ROCE_V1_DB_STAGE2;\r\n*sdb_inv_cnt = roce_read(hr_dev, ROCEE_SDB_INV_CNT_REG);\r\ndev_dbg(dev, "QP(0x%lx) db process stage2. inv cnt = 0x%x.\n",\r\nhr_qp->qpn, *sdb_inv_cnt);\r\n}\r\nif (*wait_stage == HNS_ROCE_V1_DB_STAGE2) {\r\ninv_cnt = roce_read(hr_dev, ROCEE_SDB_INV_CNT_REG);\r\nwhile (roce_hw_index_cmp_lt(inv_cnt,\r\n*sdb_inv_cnt + SDB_INV_CNT_OFFSET,\r\nROCEE_SDB_CNT_CMP_BITS)) {\r\nif (!time_before(jiffies, end)) {\r\ndev_dbg(dev, "QP(0x%lx) db process stage2 timeout. inv cnt 0x%x.\n",\r\nhr_qp->qpn, inv_cnt);\r\nreturn 0;\r\n}\r\nmsleep(HNS_ROCE_V1_CHECK_DB_SLEEP_MSECS);\r\ninv_cnt = roce_read(hr_dev, ROCEE_SDB_INV_CNT_REG);\r\n}\r\n*wait_stage = HNS_ROCE_V1_DB_WAIT_OK;\r\n}\r\nreturn 0;\r\n}\r\nstatic int check_qp_reset_state(struct hns_roce_dev *hr_dev,\r\nstruct hns_roce_qp *hr_qp,\r\nstruct hns_roce_qp_work *qp_work_entry,\r\nint *is_timeout)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nu32 sdb_issue_ptr;\r\nint ret;\r\nif (hr_qp->state != IB_QPS_RESET) {\r\nret = hns_roce_v1_modify_qp(&hr_qp->ibqp, NULL, 0, hr_qp->state,\r\nIB_QPS_ERR);\r\nif (ret) {\r\ndev_err(dev, "Modify QP(0x%lx) to ERR failed!\n",\r\nhr_qp->qpn);\r\nreturn ret;\r\n}\r\nsdb_issue_ptr = roce_read(hr_dev, ROCEE_SDB_ISSUE_PTR_REG);\r\nqp_work_entry->sdb_issue_ptr = sdb_issue_ptr;\r\nqp_work_entry->db_wait_stage = HNS_ROCE_V1_DB_STAGE1;\r\nret = check_qp_db_process_status(hr_dev, hr_qp, sdb_issue_ptr,\r\n&qp_work_entry->sdb_inv_cnt,\r\n&qp_work_entry->db_wait_stage);\r\nif (ret) {\r\ndev_err(dev, "Check QP(0x%lx) db process status failed!\n",\r\nhr_qp->qpn);\r\nreturn ret;\r\n}\r\nif (qp_work_entry->db_wait_stage != HNS_ROCE_V1_DB_WAIT_OK) {\r\nqp_work_entry->sche_cnt = 0;\r\n*is_timeout = 1;\r\nreturn 0;\r\n}\r\nret = hns_roce_v1_modify_qp(&hr_qp->ibqp, NULL, 0, hr_qp->state,\r\nIB_QPS_RESET);\r\nif (ret) {\r\ndev_err(dev, "Modify QP(0x%lx) to RST failed!\n",\r\nhr_qp->qpn);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void hns_roce_v1_destroy_qp_work_fn(struct work_struct *work)\r\n{\r\nstruct hns_roce_qp_work *qp_work_entry;\r\nstruct hns_roce_v1_priv *priv;\r\nstruct hns_roce_dev *hr_dev;\r\nstruct hns_roce_qp *hr_qp;\r\nstruct device *dev;\r\nint ret;\r\nqp_work_entry = container_of(work, struct hns_roce_qp_work, work);\r\nhr_dev = to_hr_dev(qp_work_entry->ib_dev);\r\ndev = &hr_dev->pdev->dev;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\nhr_qp = qp_work_entry->qp;\r\ndev_dbg(dev, "Schedule destroy QP(0x%lx) work.\n", hr_qp->qpn);\r\nqp_work_entry->sche_cnt++;\r\nret = check_qp_db_process_status(hr_dev, hr_qp,\r\nqp_work_entry->sdb_issue_ptr,\r\n&qp_work_entry->sdb_inv_cnt,\r\n&qp_work_entry->db_wait_stage);\r\nif (ret) {\r\ndev_err(dev, "Check QP(0x%lx) db process status failed!\n",\r\nhr_qp->qpn);\r\nreturn;\r\n}\r\nif (qp_work_entry->db_wait_stage != HNS_ROCE_V1_DB_WAIT_OK &&\r\npriv->des_qp.requeue_flag) {\r\nqueue_work(priv->des_qp.qp_wq, work);\r\nreturn;\r\n}\r\nret = hns_roce_v1_modify_qp(&hr_qp->ibqp, NULL, 0, hr_qp->state,\r\nIB_QPS_RESET);\r\nif (ret) {\r\ndev_err(dev, "Modify QP(0x%lx) to RST failed!\n", hr_qp->qpn);\r\nreturn;\r\n}\r\nhns_roce_qp_remove(hr_dev, hr_qp);\r\nhns_roce_qp_free(hr_dev, hr_qp);\r\nif (hr_qp->ibqp.qp_type == IB_QPT_RC) {\r\nhns_roce_release_range_qp(hr_dev, hr_qp->qpn, 1);\r\nkfree(hr_qp);\r\n} else\r\nkfree(hr_to_hr_sqp(hr_qp));\r\nkfree(qp_work_entry);\r\ndev_dbg(dev, "Accomplished destroy QP(0x%lx) work.\n", hr_qp->qpn);\r\n}\r\nint hns_roce_v1_destroy_qp(struct ib_qp *ibqp)\r\n{\r\nstruct hns_roce_dev *hr_dev = to_hr_dev(ibqp->device);\r\nstruct hns_roce_qp *hr_qp = to_hr_qp(ibqp);\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_qp_work qp_work_entry;\r\nstruct hns_roce_qp_work *qp_work;\r\nstruct hns_roce_v1_priv *priv;\r\nstruct hns_roce_cq *send_cq, *recv_cq;\r\nint is_user = !!ibqp->pd->uobject;\r\nint is_timeout = 0;\r\nint ret;\r\nret = check_qp_reset_state(hr_dev, hr_qp, &qp_work_entry, &is_timeout);\r\nif (ret) {\r\ndev_err(dev, "QP reset state check failed(%d)!\n", ret);\r\nreturn ret;\r\n}\r\nsend_cq = to_hr_cq(hr_qp->ibqp.send_cq);\r\nrecv_cq = to_hr_cq(hr_qp->ibqp.recv_cq);\r\nhns_roce_lock_cqs(send_cq, recv_cq);\r\nif (!is_user) {\r\n__hns_roce_v1_cq_clean(recv_cq, hr_qp->qpn, hr_qp->ibqp.srq ?\r\nto_hr_srq(hr_qp->ibqp.srq) : NULL);\r\nif (send_cq != recv_cq)\r\n__hns_roce_v1_cq_clean(send_cq, hr_qp->qpn, NULL);\r\n}\r\nhns_roce_unlock_cqs(send_cq, recv_cq);\r\nif (!is_timeout) {\r\nhns_roce_qp_remove(hr_dev, hr_qp);\r\nhns_roce_qp_free(hr_dev, hr_qp);\r\nif (hr_qp->ibqp.qp_type == IB_QPT_RC)\r\nhns_roce_release_range_qp(hr_dev, hr_qp->qpn, 1);\r\n}\r\nhns_roce_mtt_cleanup(hr_dev, &hr_qp->mtt);\r\nif (is_user)\r\nib_umem_release(hr_qp->umem);\r\nelse {\r\nkfree(hr_qp->sq.wrid);\r\nkfree(hr_qp->rq.wrid);\r\nhns_roce_buf_free(hr_dev, hr_qp->buff_size, &hr_qp->hr_buf);\r\n}\r\nif (!is_timeout) {\r\nif (hr_qp->ibqp.qp_type == IB_QPT_RC)\r\nkfree(hr_qp);\r\nelse\r\nkfree(hr_to_hr_sqp(hr_qp));\r\n} else {\r\nqp_work = kzalloc(sizeof(*qp_work), GFP_KERNEL);\r\nif (!qp_work)\r\nreturn -ENOMEM;\r\nINIT_WORK(&qp_work->work, hns_roce_v1_destroy_qp_work_fn);\r\nqp_work->ib_dev = &hr_dev->ib_dev;\r\nqp_work->qp = hr_qp;\r\nqp_work->db_wait_stage = qp_work_entry.db_wait_stage;\r\nqp_work->sdb_issue_ptr = qp_work_entry.sdb_issue_ptr;\r\nqp_work->sdb_inv_cnt = qp_work_entry.sdb_inv_cnt;\r\nqp_work->sche_cnt = qp_work_entry.sche_cnt;\r\npriv = (struct hns_roce_v1_priv *)hr_dev->hw->priv;\r\nqueue_work(priv->des_qp.qp_wq, &qp_work->work);\r\ndev_dbg(dev, "Begin destroy QP(0x%lx) work.\n", hr_qp->qpn);\r\n}\r\nreturn 0;\r\n}\r\nint hns_roce_v1_destroy_cq(struct ib_cq *ibcq)\r\n{\r\nstruct hns_roce_dev *hr_dev = to_hr_dev(ibcq->device);\r\nstruct hns_roce_cq *hr_cq = to_hr_cq(ibcq);\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nu32 cqe_cnt_ori;\r\nu32 cqe_cnt_cur;\r\nu32 cq_buf_size;\r\nint wait_time = 0;\r\nint ret = 0;\r\nhns_roce_free_cq(hr_dev, hr_cq);\r\ncqe_cnt_ori = roce_read(hr_dev, ROCEE_SCAEP_WR_CQE_CNT);\r\nwhile (1) {\r\nif (roce_read(hr_dev, ROCEE_CAEP_CQE_WCMD_EMPTY) &\r\nHNS_ROCE_CQE_WCMD_EMPTY_BIT)\r\nbreak;\r\ncqe_cnt_cur = roce_read(hr_dev, ROCEE_SCAEP_WR_CQE_CNT);\r\nif ((cqe_cnt_cur - cqe_cnt_ori) >= HNS_ROCE_MIN_CQE_CNT)\r\nbreak;\r\nmsleep(HNS_ROCE_EACH_FREE_CQ_WAIT_MSECS);\r\nif (wait_time > HNS_ROCE_MAX_FREE_CQ_WAIT_CNT) {\r\ndev_warn(dev, "Destroy cq 0x%lx timeout!\n",\r\nhr_cq->cqn);\r\nret = -ETIMEDOUT;\r\nbreak;\r\n}\r\nwait_time++;\r\n}\r\nhns_roce_mtt_cleanup(hr_dev, &hr_cq->hr_buf.hr_mtt);\r\nif (ibcq->uobject)\r\nib_umem_release(hr_cq->umem);\r\nelse {\r\ncq_buf_size = (ibcq->cqe + 1) * hr_dev->caps.cq_entry_sz;\r\nhns_roce_buf_free(hr_dev, cq_buf_size, &hr_cq->hr_buf.hr_buf);\r\n}\r\nkfree(hr_cq);\r\nreturn ret;\r\n}

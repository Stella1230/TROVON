void crunch_task_release(struct thread_info *thread)\r\n{\r\nlocal_irq_disable();\r\nif (crunch_owner == &thread->crunchstate)\r\ncrunch_owner = NULL;\r\nlocal_irq_enable();\r\n}\r\nstatic int crunch_enabled(u32 devcfg)\r\n{\r\nreturn !!(devcfg & EP93XX_SYSCON_DEVCFG_CPENA);\r\n}\r\nstatic int crunch_do(struct notifier_block *self, unsigned long cmd, void *t)\r\n{\r\nstruct thread_info *thread = (struct thread_info *)t;\r\nstruct crunch_state *crunch_state;\r\nu32 devcfg;\r\ncrunch_state = &thread->crunchstate;\r\nswitch (cmd) {\r\ncase THREAD_NOTIFY_FLUSH:\r\nmemset(crunch_state, 0, sizeof(*crunch_state));\r\ncase THREAD_NOTIFY_EXIT:\r\ncrunch_task_release(thread);\r\nbreak;\r\ncase THREAD_NOTIFY_SWITCH:\r\ndevcfg = __raw_readl(EP93XX_SYSCON_DEVCFG);\r\nif (crunch_enabled(devcfg) || crunch_owner == crunch_state) {\r\ndevcfg ^= EP93XX_SYSCON_DEVCFG_CPENA;\r\n__raw_writel(0xaa, EP93XX_SYSCON_SWLOCK);\r\n__raw_writel(devcfg, EP93XX_SYSCON_DEVCFG);\r\n}\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nint __init crunch_init(void)\r\n{\r\nthread_register_notifier(&crunch_notifier_block);\r\nelf_hwcap |= HWCAP_CRUNCH;\r\nreturn 0;\r\n}

static bool as3711_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase AS3711_GPIO_SIGNAL_IN:\r\ncase AS3711_INTERRUPT_STATUS_1:\r\ncase AS3711_INTERRUPT_STATUS_2:\r\ncase AS3711_INTERRUPT_STATUS_3:\r\ncase AS3711_CHARGER_STATUS_1:\r\ncase AS3711_CHARGER_STATUS_2:\r\ncase AS3711_REG_STATUS:\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool as3711_precious_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase AS3711_INTERRUPT_STATUS_1:\r\ncase AS3711_INTERRUPT_STATUS_2:\r\ncase AS3711_INTERRUPT_STATUS_3:\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool as3711_readable_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase AS3711_SD_1_VOLTAGE:\r\ncase AS3711_SD_2_VOLTAGE:\r\ncase AS3711_SD_3_VOLTAGE:\r\ncase AS3711_SD_4_VOLTAGE:\r\ncase AS3711_LDO_1_VOLTAGE:\r\ncase AS3711_LDO_2_VOLTAGE:\r\ncase AS3711_LDO_3_VOLTAGE:\r\ncase AS3711_LDO_4_VOLTAGE:\r\ncase AS3711_LDO_5_VOLTAGE:\r\ncase AS3711_LDO_6_VOLTAGE:\r\ncase AS3711_LDO_7_VOLTAGE:\r\ncase AS3711_LDO_8_VOLTAGE:\r\ncase AS3711_SD_CONTROL:\r\ncase AS3711_GPIO_SIGNAL_OUT:\r\ncase AS3711_GPIO_SIGNAL_IN:\r\ncase AS3711_SD_CONTROL_1:\r\ncase AS3711_SD_CONTROL_2:\r\ncase AS3711_CURR_CONTROL:\r\ncase AS3711_CURR1_VALUE:\r\ncase AS3711_CURR2_VALUE:\r\ncase AS3711_CURR3_VALUE:\r\ncase AS3711_STEPUP_CONTROL_1:\r\ncase AS3711_STEPUP_CONTROL_2:\r\ncase AS3711_STEPUP_CONTROL_4:\r\ncase AS3711_STEPUP_CONTROL_5:\r\ncase AS3711_REG_STATUS:\r\ncase AS3711_INTERRUPT_STATUS_1:\r\ncase AS3711_INTERRUPT_STATUS_2:\r\ncase AS3711_INTERRUPT_STATUS_3:\r\ncase AS3711_CHARGER_STATUS_1:\r\ncase AS3711_CHARGER_STATUS_2:\r\ncase AS3711_ASIC_ID_1:\r\ncase AS3711_ASIC_ID_2:\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic int as3711_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct as3711 *as3711;\r\nstruct as3711_platform_data *pdata;\r\nunsigned int id1, id2;\r\nint ret;\r\nif (!client->dev.of_node) {\r\npdata = dev_get_platdata(&client->dev);\r\nif (!pdata)\r\ndev_dbg(&client->dev, "Platform data not found\n");\r\n} else {\r\npdata = devm_kzalloc(&client->dev,\r\nsizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\n}\r\nas3711 = devm_kzalloc(&client->dev, sizeof(struct as3711), GFP_KERNEL);\r\nif (!as3711)\r\nreturn -ENOMEM;\r\nas3711->dev = &client->dev;\r\ni2c_set_clientdata(client, as3711);\r\nif (client->irq)\r\ndev_notice(&client->dev, "IRQ not supported yet\n");\r\nas3711->regmap = devm_regmap_init_i2c(client, &as3711_regmap_config);\r\nif (IS_ERR(as3711->regmap)) {\r\nret = PTR_ERR(as3711->regmap);\r\ndev_err(&client->dev,\r\n"regmap initialization failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_read(as3711->regmap, AS3711_ASIC_ID_1, &id1);\r\nif (!ret)\r\nret = regmap_read(as3711->regmap, AS3711_ASIC_ID_2, &id2);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "regmap_read() failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (id1 != 0x8b)\r\nreturn -ENODEV;\r\ndev_info(as3711->dev, "AS3711 detected: %x:%x\n", id1, id2);\r\nif (pdata) {\r\nas3711_subdevs[AS3711_REGULATOR].platform_data =\r\n&pdata->regulator;\r\nas3711_subdevs[AS3711_REGULATOR].pdata_size =\r\nsizeof(pdata->regulator);\r\nas3711_subdevs[AS3711_BACKLIGHT].platform_data =\r\n&pdata->backlight;\r\nas3711_subdevs[AS3711_BACKLIGHT].pdata_size =\r\nsizeof(pdata->backlight);\r\n} else {\r\nas3711_subdevs[AS3711_REGULATOR].platform_data = NULL;\r\nas3711_subdevs[AS3711_REGULATOR].pdata_size = 0;\r\nas3711_subdevs[AS3711_BACKLIGHT].platform_data = NULL;\r\nas3711_subdevs[AS3711_BACKLIGHT].pdata_size = 0;\r\n}\r\nret = devm_mfd_add_devices(as3711->dev, -1, as3711_subdevs,\r\nARRAY_SIZE(as3711_subdevs), NULL, 0, NULL);\r\nif (ret < 0)\r\ndev_err(&client->dev, "add mfd devices failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int __init as3711_i2c_init(void)\r\n{\r\nreturn i2c_add_driver(&as3711_i2c_driver);\r\n}\r\nstatic void __exit as3711_i2c_exit(void)\r\n{\r\ni2c_del_driver(&as3711_i2c_driver);\r\n}

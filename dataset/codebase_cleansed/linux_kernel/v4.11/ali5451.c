static inline unsigned int snd_ali_5451_peek(struct snd_ali *codec,\r\nunsigned int port)\r\n{\r\nreturn (unsigned int)inl(ALI_REG(codec, port));\r\n}\r\nstatic inline void snd_ali_5451_poke(struct snd_ali *codec,\r\nunsigned int port,\r\nunsigned int val)\r\n{\r\noutl((unsigned int)val, ALI_REG(codec, port));\r\n}\r\nstatic int snd_ali_codec_ready(struct snd_ali *codec,\r\nunsigned int port)\r\n{\r\nunsigned long end_time;\r\nunsigned int res;\r\nend_time = jiffies + msecs_to_jiffies(250);\r\nfor (;;) {\r\nres = snd_ali_5451_peek(codec,port);\r\nif (!(res & 0x8000))\r\nreturn 0;\r\nif (!time_after_eq(end_time, jiffies))\r\nbreak;\r\nschedule_timeout_uninterruptible(1);\r\n}\r\nsnd_ali_5451_poke(codec, port, res & ~0x8000);\r\ndev_dbg(codec->card->dev, "ali_codec_ready: codec is not ready.\n ");\r\nreturn -EIO;\r\n}\r\nstatic int snd_ali_stimer_ready(struct snd_ali *codec)\r\n{\r\nunsigned long end_time;\r\nunsigned long dwChk1,dwChk2;\r\ndwChk1 = snd_ali_5451_peek(codec, ALI_STIMER);\r\nend_time = jiffies + msecs_to_jiffies(250);\r\nfor (;;) {\r\ndwChk2 = snd_ali_5451_peek(codec, ALI_STIMER);\r\nif (dwChk2 != dwChk1)\r\nreturn 0;\r\nif (!time_after_eq(end_time, jiffies))\r\nbreak;\r\nschedule_timeout_uninterruptible(1);\r\n}\r\ndev_err(codec->card->dev, "ali_stimer_read: stimer is not ready.\n");\r\nreturn -EIO;\r\n}\r\nstatic void snd_ali_codec_poke(struct snd_ali *codec,int secondary,\r\nunsigned short reg,\r\nunsigned short val)\r\n{\r\nunsigned int dwVal;\r\nunsigned int port;\r\nif (reg >= 0x80) {\r\ndev_err(codec->card->dev,\r\n"ali_codec_poke: reg(%xh) invalid.\n", reg);\r\nreturn;\r\n}\r\nport = codec->chregs.regs.ac97write;\r\nif (snd_ali_codec_ready(codec, port) < 0)\r\nreturn;\r\nif (snd_ali_stimer_ready(codec) < 0)\r\nreturn;\r\ndwVal = (unsigned int) (reg & 0xff);\r\ndwVal |= 0x8000 | (val << 16);\r\nif (secondary)\r\ndwVal |= 0x0080;\r\nif (codec->revision == ALI_5451_V02)\r\ndwVal |= 0x0100;\r\nsnd_ali_5451_poke(codec, port, dwVal);\r\nreturn ;\r\n}\r\nstatic unsigned short snd_ali_codec_peek(struct snd_ali *codec,\r\nint secondary,\r\nunsigned short reg)\r\n{\r\nunsigned int dwVal;\r\nunsigned int port;\r\nif (reg >= 0x80) {\r\ndev_err(codec->card->dev,\r\n"ali_codec_peek: reg(%xh) invalid.\n", reg);\r\nreturn ~0;\r\n}\r\nport = codec->chregs.regs.ac97read;\r\nif (snd_ali_codec_ready(codec, port) < 0)\r\nreturn ~0;\r\nif (snd_ali_stimer_ready(codec) < 0)\r\nreturn ~0;\r\ndwVal = (unsigned int) (reg & 0xff);\r\ndwVal |= 0x8000;\r\nif (secondary)\r\ndwVal |= 0x0080;\r\nsnd_ali_5451_poke(codec, port, dwVal);\r\nif (snd_ali_stimer_ready(codec) < 0)\r\nreturn ~0;\r\nif (snd_ali_codec_ready(codec, port) < 0)\r\nreturn ~0;\r\nreturn (snd_ali_5451_peek(codec, port) & 0xffff0000) >> 16;\r\n}\r\nstatic void snd_ali_codec_write(struct snd_ac97 *ac97,\r\nunsigned short reg,\r\nunsigned short val )\r\n{\r\nstruct snd_ali *codec = ac97->private_data;\r\ndev_dbg(codec->card->dev, "codec_write: reg=%xh data=%xh.\n", reg, val);\r\nif (reg == AC97_GPIO_STATUS) {\r\noutl((val << ALI_AC97_GPIO_DATA_SHIFT) | ALI_AC97_GPIO_ENABLE,\r\nALI_REG(codec, ALI_AC97_GPIO));\r\nreturn;\r\n}\r\nsnd_ali_codec_poke(codec, ac97->num, reg, val);\r\nreturn ;\r\n}\r\nstatic unsigned short snd_ali_codec_read(struct snd_ac97 *ac97,\r\nunsigned short reg)\r\n{\r\nstruct snd_ali *codec = ac97->private_data;\r\ndev_dbg(codec->card->dev, "codec_read reg=%xh.\n", reg);\r\nreturn snd_ali_codec_peek(codec, ac97->num, reg);\r\n}\r\nstatic int snd_ali_reset_5451(struct snd_ali *codec)\r\n{\r\nstruct pci_dev *pci_dev;\r\nunsigned short wCount, wReg;\r\nunsigned int dwVal;\r\npci_dev = codec->pci_m1533;\r\nif (pci_dev) {\r\npci_read_config_dword(pci_dev, 0x7c, &dwVal);\r\npci_write_config_dword(pci_dev, 0x7c, dwVal | 0x08000000);\r\nmdelay(5);\r\npci_read_config_dword(pci_dev, 0x7c, &dwVal);\r\npci_write_config_dword(pci_dev, 0x7c, dwVal & 0xf7ffffff);\r\nmdelay(5);\r\n}\r\npci_dev = codec->pci;\r\npci_read_config_dword(pci_dev, 0x44, &dwVal);\r\npci_write_config_dword(pci_dev, 0x44, dwVal | 0x000c0000);\r\nudelay(500);\r\npci_read_config_dword(pci_dev, 0x44, &dwVal);\r\npci_write_config_dword(pci_dev, 0x44, dwVal & 0xfffbffff);\r\nmdelay(5);\r\nwCount = 200;\r\nwhile(wCount--) {\r\nwReg = snd_ali_codec_peek(codec, 0, AC97_POWERDOWN);\r\nif ((wReg & 0x000f) == 0x000f)\r\nreturn 0;\r\nmdelay(5);\r\n}\r\nreturn 0;\r\n}\r\nstatic void snd_ali_enable_special_channel(struct snd_ali *codec,\r\nunsigned int channel)\r\n{\r\nunsigned long dwVal;\r\ndwVal = inl(ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\ndwVal |= 1 << (channel & 0x0000001f);\r\noutl(dwVal, ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\n}\r\nstatic void snd_ali_disable_special_channel(struct snd_ali *codec,\r\nunsigned int channel)\r\n{\r\nunsigned long dwVal;\r\ndwVal = inl(ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\ndwVal &= ~(1 << (channel & 0x0000001f));\r\noutl(dwVal, ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\n}\r\nstatic void snd_ali_enable_address_interrupt(struct snd_ali *codec)\r\n{\r\nunsigned int gc;\r\ngc = inl(ALI_REG(codec, ALI_GC_CIR));\r\ngc |= ENDLP_IE;\r\ngc |= MIDLP_IE;\r\noutl( gc, ALI_REG(codec, ALI_GC_CIR));\r\n}\r\nstatic void snd_ali_disable_address_interrupt(struct snd_ali *codec)\r\n{\r\nunsigned int gc;\r\ngc = inl(ALI_REG(codec, ALI_GC_CIR));\r\ngc &= ~ENDLP_IE;\r\ngc &= ~MIDLP_IE;\r\noutl(gc, ALI_REG(codec, ALI_GC_CIR));\r\n}\r\nstatic void snd_ali_disable_voice_irq(struct snd_ali *codec,\r\nunsigned int channel)\r\n{\r\nunsigned int mask;\r\nstruct snd_ali_channel_control *pchregs = &(codec->chregs);\r\ndev_dbg(codec->card->dev, "disable_voice_irq channel=%d\n", channel);\r\nmask = 1 << (channel & 0x1f);\r\npchregs->data.ainten = inl(ALI_REG(codec, pchregs->regs.ainten));\r\npchregs->data.ainten &= ~mask;\r\noutl(pchregs->data.ainten, ALI_REG(codec, pchregs->regs.ainten));\r\n}\r\nstatic int snd_ali_alloc_pcm_channel(struct snd_ali *codec, int channel)\r\n{\r\nunsigned int idx = channel & 0x1f;\r\nif (codec->synth.chcnt >= ALI_CHANNELS){\r\ndev_err(codec->card->dev,\r\n"ali_alloc_pcm_channel: no free channels.\n");\r\nreturn -1;\r\n}\r\nif (!(codec->synth.chmap & (1 << idx))) {\r\ncodec->synth.chmap |= 1 << idx;\r\ncodec->synth.chcnt++;\r\ndev_dbg(codec->card->dev, "alloc_pcm_channel no. %d.\n", idx);\r\nreturn idx;\r\n}\r\nreturn -1;\r\n}\r\nstatic int snd_ali_find_free_channel(struct snd_ali * codec, int rec)\r\n{\r\nint idx;\r\nint result = -1;\r\ndev_dbg(codec->card->dev,\r\n"find_free_channel: for %s\n", rec ? "rec" : "pcm");\r\nif (rec) {\r\nif (codec->spdif_support &&\r\n(inl(ALI_REG(codec, ALI_GLOBAL_CONTROL)) &\r\nALI_SPDIF_IN_SUPPORT))\r\nidx = ALI_SPDIF_IN_CHANNEL;\r\nelse\r\nidx = ALI_PCM_IN_CHANNEL;\r\nresult = snd_ali_alloc_pcm_channel(codec, idx);\r\nif (result >= 0)\r\nreturn result;\r\nelse {\r\ndev_err(codec->card->dev,\r\n"ali_find_free_channel: record channel is busy now.\n");\r\nreturn -1;\r\n}\r\n}\r\nif (codec->spdif_support &&\r\n(inl(ALI_REG(codec, ALI_GLOBAL_CONTROL)) &\r\nALI_SPDIF_OUT_CH_ENABLE)) {\r\nidx = ALI_SPDIF_OUT_CHANNEL;\r\nresult = snd_ali_alloc_pcm_channel(codec, idx);\r\nif (result >= 0)\r\nreturn result;\r\nelse\r\ndev_err(codec->card->dev,\r\n"ali_find_free_channel: S/PDIF out channel is in busy now.\n");\r\n}\r\nfor (idx = 0; idx < ALI_CHANNELS; idx++) {\r\nresult = snd_ali_alloc_pcm_channel(codec, idx);\r\nif (result >= 0)\r\nreturn result;\r\n}\r\ndev_err(codec->card->dev, "ali_find_free_channel: no free channels.\n");\r\nreturn -1;\r\n}\r\nstatic void snd_ali_free_channel_pcm(struct snd_ali *codec, int channel)\r\n{\r\nunsigned int idx = channel & 0x0000001f;\r\ndev_dbg(codec->card->dev, "free_channel_pcm channel=%d\n", channel);\r\nif (channel < 0 || channel >= ALI_CHANNELS)\r\nreturn;\r\nif (!(codec->synth.chmap & (1 << idx))) {\r\ndev_err(codec->card->dev,\r\n"ali_free_channel_pcm: channel %d is not in use.\n",\r\nchannel);\r\nreturn;\r\n} else {\r\ncodec->synth.chmap &= ~(1 << idx);\r\ncodec->synth.chcnt--;\r\n}\r\n}\r\nstatic void snd_ali_stop_voice(struct snd_ali *codec, unsigned int channel)\r\n{\r\nunsigned int mask = 1 << (channel & 0x1f);\r\ndev_dbg(codec->card->dev, "stop_voice: channel=%d\n", channel);\r\noutl(mask, ALI_REG(codec, codec->chregs.regs.stop));\r\n}\r\nstatic void snd_ali_delay(struct snd_ali *codec,int interval)\r\n{\r\nunsigned long begintimer,currenttimer;\r\nbegintimer = inl(ALI_REG(codec, ALI_STIMER));\r\ncurrenttimer = inl(ALI_REG(codec, ALI_STIMER));\r\nwhile (currenttimer < begintimer + interval) {\r\nif (snd_ali_stimer_ready(codec) < 0)\r\nbreak;\r\ncurrenttimer = inl(ALI_REG(codec, ALI_STIMER));\r\ncpu_relax();\r\n}\r\n}\r\nstatic void snd_ali_detect_spdif_rate(struct snd_ali *codec)\r\n{\r\nu16 wval;\r\nu16 count = 0;\r\nu8 bval, R1 = 0, R2;\r\nbval = inb(ALI_REG(codec, ALI_SPDIF_CTRL + 1));\r\nbval |= 0x1F;\r\noutb(bval, ALI_REG(codec, ALI_SPDIF_CTRL + 1));\r\nwhile ((R1 < 0x0b || R1 > 0x0e) && R1 != 0x12 && count <= 50000) {\r\ncount ++;\r\nsnd_ali_delay(codec, 6);\r\nbval = inb(ALI_REG(codec, ALI_SPDIF_CTRL + 1));\r\nR1 = bval & 0x1F;\r\n}\r\nif (count > 50000) {\r\ndev_err(codec->card->dev, "ali_detect_spdif_rate: timeout!\n");\r\nreturn;\r\n}\r\nfor (count = 0; count <= 50000; count++) {\r\nsnd_ali_delay(codec, 6);\r\nbval = inb(ALI_REG(codec,ALI_SPDIF_CTRL + 1));\r\nR2 = bval & 0x1F;\r\nif (R2 != R1)\r\nR1 = R2;\r\nelse\r\nbreak;\r\n}\r\nif (count > 50000) {\r\ndev_err(codec->card->dev, "ali_detect_spdif_rate: timeout!\n");\r\nreturn;\r\n}\r\nif (R2 >= 0x0b && R2 <= 0x0e) {\r\nwval = inw(ALI_REG(codec, ALI_SPDIF_CTRL + 2));\r\nwval &= 0xe0f0;\r\nwval |= (0x09 << 8) | 0x05;\r\noutw(wval, ALI_REG(codec, ALI_SPDIF_CTRL + 2));\r\nbval = inb(ALI_REG(codec, ALI_SPDIF_CS + 3)) & 0xf0;\r\noutb(bval | 0x02, ALI_REG(codec, ALI_SPDIF_CS + 3));\r\n} else if (R2 == 0x12) {\r\nwval = inw(ALI_REG(codec, ALI_SPDIF_CTRL + 2));\r\nwval &= 0xe0f0;\r\nwval |= (0x0e << 8) | 0x08;\r\noutw(wval, ALI_REG(codec, ALI_SPDIF_CTRL + 2));\r\nbval = inb(ALI_REG(codec,ALI_SPDIF_CS + 3)) & 0xf0;\r\noutb(bval | 0x03, ALI_REG(codec, ALI_SPDIF_CS + 3));\r\n}\r\n}\r\nstatic unsigned int snd_ali_get_spdif_in_rate(struct snd_ali *codec)\r\n{\r\nu32 dwRate;\r\nu8 bval;\r\nbval = inb(ALI_REG(codec, ALI_SPDIF_CTRL));\r\nbval &= 0x7f;\r\nbval |= 0x40;\r\noutb(bval, ALI_REG(codec, ALI_SPDIF_CTRL));\r\nsnd_ali_detect_spdif_rate(codec);\r\nbval = inb(ALI_REG(codec, ALI_SPDIF_CS + 3));\r\nbval &= 0x0f;\r\nswitch (bval) {\r\ncase 0: dwRate = 44100; break;\r\ncase 1: dwRate = 48000; break;\r\ncase 2: dwRate = 32000; break;\r\ndefault: dwRate = 0; break;\r\n}\r\nreturn dwRate;\r\n}\r\nstatic void snd_ali_enable_spdif_in(struct snd_ali *codec)\r\n{\r\nunsigned int dwVal;\r\ndwVal = inl(ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\ndwVal |= ALI_SPDIF_IN_SUPPORT;\r\noutl(dwVal, ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\ndwVal = inb(ALI_REG(codec, ALI_SPDIF_CTRL));\r\ndwVal |= 0x02;\r\noutb(dwVal, ALI_REG(codec, ALI_SPDIF_CTRL));\r\nsnd_ali_enable_special_channel(codec, ALI_SPDIF_IN_CHANNEL);\r\n}\r\nstatic void snd_ali_disable_spdif_in(struct snd_ali *codec)\r\n{\r\nunsigned int dwVal;\r\ndwVal = inl(ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\ndwVal &= ~ALI_SPDIF_IN_SUPPORT;\r\noutl(dwVal, ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\nsnd_ali_disable_special_channel(codec, ALI_SPDIF_IN_CHANNEL);\r\n}\r\nstatic void snd_ali_set_spdif_out_rate(struct snd_ali *codec, unsigned int rate)\r\n{\r\nunsigned char bVal;\r\nunsigned int dwRate;\r\nswitch (rate) {\r\ncase 32000: dwRate = 0x300; break;\r\ncase 48000: dwRate = 0x200; break;\r\ndefault: dwRate = 0; break;\r\n}\r\nbVal = inb(ALI_REG(codec, ALI_SPDIF_CTRL));\r\nbVal &= (unsigned char)(~(1<<6));\r\nbVal |= 0x80;\r\noutb(bVal, ALI_REG(codec, ALI_SPDIF_CTRL));\r\noutb(dwRate | 0x20, ALI_REG(codec, ALI_SPDIF_CS + 2));\r\nbVal &= ~0x80;\r\noutb(bVal, ALI_REG(codec, ALI_SPDIF_CTRL));\r\noutw(rate | 0x10, ALI_REG(codec, ALI_SPDIF_CS + 2));\r\n}\r\nstatic void snd_ali_enable_spdif_out(struct snd_ali *codec)\r\n{\r\nunsigned short wVal;\r\nunsigned char bVal;\r\nstruct pci_dev *pci_dev;\r\npci_dev = codec->pci_m1533;\r\nif (pci_dev == NULL)\r\nreturn;\r\npci_read_config_byte(pci_dev, 0x61, &bVal);\r\nbVal |= 0x40;\r\npci_write_config_byte(pci_dev, 0x61, bVal);\r\npci_read_config_byte(pci_dev, 0x7d, &bVal);\r\nbVal |= 0x01;\r\npci_write_config_byte(pci_dev, 0x7d, bVal);\r\npci_read_config_byte(pci_dev, 0x7e, &bVal);\r\nbVal &= (~0x20);\r\nbVal |= 0x10;\r\npci_write_config_byte(pci_dev, 0x7e, bVal);\r\nbVal = inb(ALI_REG(codec, ALI_SCTRL));\r\noutb(bVal | ALI_SPDIF_OUT_ENABLE, ALI_REG(codec, ALI_SCTRL));\r\nbVal = inb(ALI_REG(codec, ALI_SPDIF_CTRL));\r\noutb(bVal & ALI_SPDIF_OUT_CH_STATUS, ALI_REG(codec, ALI_SPDIF_CTRL));\r\nwVal = inw(ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\nwVal |= ALI_SPDIF_OUT_SEL_PCM;\r\noutw(wVal, ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\nsnd_ali_disable_special_channel(codec, ALI_SPDIF_OUT_CHANNEL);\r\n}\r\nstatic void snd_ali_enable_spdif_chnout(struct snd_ali *codec)\r\n{\r\nunsigned short wVal;\r\nwVal = inw(ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\nwVal &= ~ALI_SPDIF_OUT_SEL_PCM;\r\noutw(wVal, ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\nsnd_ali_enable_special_channel(codec, ALI_SPDIF_OUT_CHANNEL);\r\n}\r\nstatic void snd_ali_disable_spdif_chnout(struct snd_ali *codec)\r\n{\r\nunsigned short wVal;\r\nwVal = inw(ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\nwVal |= ALI_SPDIF_OUT_SEL_PCM;\r\noutw(wVal, ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\nsnd_ali_enable_special_channel(codec, ALI_SPDIF_OUT_CHANNEL);\r\n}\r\nstatic void snd_ali_disable_spdif_out(struct snd_ali *codec)\r\n{\r\nunsigned char bVal;\r\nbVal = inb(ALI_REG(codec, ALI_SCTRL));\r\noutb(bVal & ~ALI_SPDIF_OUT_ENABLE, ALI_REG(codec, ALI_SCTRL));\r\nsnd_ali_disable_spdif_chnout(codec);\r\n}\r\nstatic void snd_ali_update_ptr(struct snd_ali *codec, int channel)\r\n{\r\nstruct snd_ali_voice *pvoice;\r\nstruct snd_ali_channel_control *pchregs;\r\nunsigned int old, mask;\r\npchregs = &(codec->chregs);\r\nold = pchregs->data.aint;\r\nmask = 1U << (channel & 0x1f);\r\nif (!(old & mask))\r\nreturn;\r\npvoice = &codec->synth.voices[channel];\r\nudelay(100);\r\nspin_lock(&codec->reg_lock);\r\nif (pvoice->pcm && pvoice->substream) {\r\nif (pvoice->running) {\r\ndev_dbg(codec->card->dev,\r\n"update_ptr: cso=%4.4x cspf=%d.\n",\r\ninw(ALI_REG(codec, ALI_CSO_ALPHA_FMS + 2)),\r\n(inl(ALI_REG(codec, ALI_CSPF)) & mask) == mask);\r\nspin_unlock(&codec->reg_lock);\r\nsnd_pcm_period_elapsed(pvoice->substream);\r\nspin_lock(&codec->reg_lock);\r\n} else {\r\nsnd_ali_stop_voice(codec, channel);\r\nsnd_ali_disable_voice_irq(codec, channel);\r\n}\r\n} else if (codec->synth.voices[channel].synth) {\r\n} else if (codec->synth.voices[channel].midi) {\r\n} else {\r\nsnd_ali_stop_voice(codec, channel);\r\nsnd_ali_disable_voice_irq(codec, channel);\r\n}\r\nspin_unlock(&codec->reg_lock);\r\noutl(mask,ALI_REG(codec,pchregs->regs.aint));\r\npchregs->data.aint = old & (~mask);\r\n}\r\nstatic irqreturn_t snd_ali_card_interrupt(int irq, void *dev_id)\r\n{\r\nstruct snd_ali *codec = dev_id;\r\nint channel;\r\nunsigned int audio_int;\r\nstruct snd_ali_channel_control *pchregs;\r\nif (codec == NULL || !codec->hw_initialized)\r\nreturn IRQ_NONE;\r\naudio_int = inl(ALI_REG(codec, ALI_MISCINT));\r\nif (!audio_int)\r\nreturn IRQ_NONE;\r\npchregs = &(codec->chregs);\r\nif (audio_int & ADDRESS_IRQ) {\r\npchregs->data.aint = inl(ALI_REG(codec, pchregs->regs.aint));\r\nfor (channel = 0; channel < ALI_CHANNELS; channel++)\r\nsnd_ali_update_ptr(codec, channel);\r\n}\r\noutl((TARGET_REACHED | MIXER_OVERFLOW | MIXER_UNDERFLOW),\r\nALI_REG(codec, ALI_MISCINT));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic struct snd_ali_voice *snd_ali_alloc_voice(struct snd_ali * codec,\r\nint type, int rec, int channel)\r\n{\r\nstruct snd_ali_voice *pvoice;\r\nint idx;\r\ndev_dbg(codec->card->dev, "alloc_voice: type=%d rec=%d\n", type, rec);\r\nspin_lock_irq(&codec->voice_alloc);\r\nif (type == SNDRV_ALI_VOICE_TYPE_PCM) {\r\nidx = channel > 0 ? snd_ali_alloc_pcm_channel(codec, channel) :\r\nsnd_ali_find_free_channel(codec,rec);\r\nif (idx < 0) {\r\ndev_err(codec->card->dev, "ali_alloc_voice: err.\n");\r\nspin_unlock_irq(&codec->voice_alloc);\r\nreturn NULL;\r\n}\r\npvoice = &(codec->synth.voices[idx]);\r\npvoice->codec = codec;\r\npvoice->use = 1;\r\npvoice->pcm = 1;\r\npvoice->mode = rec;\r\nspin_unlock_irq(&codec->voice_alloc);\r\nreturn pvoice;\r\n}\r\nspin_unlock_irq(&codec->voice_alloc);\r\nreturn NULL;\r\n}\r\nstatic void snd_ali_free_voice(struct snd_ali * codec,\r\nstruct snd_ali_voice *pvoice)\r\n{\r\nvoid (*private_free)(void *);\r\nvoid *private_data;\r\ndev_dbg(codec->card->dev, "free_voice: channel=%d\n", pvoice->number);\r\nif (!pvoice->use)\r\nreturn;\r\nsnd_ali_clear_voices(codec, pvoice->number, pvoice->number);\r\nspin_lock_irq(&codec->voice_alloc);\r\nprivate_free = pvoice->private_free;\r\nprivate_data = pvoice->private_data;\r\npvoice->private_free = NULL;\r\npvoice->private_data = NULL;\r\nif (pvoice->pcm)\r\nsnd_ali_free_channel_pcm(codec, pvoice->number);\r\npvoice->use = pvoice->pcm = pvoice->synth = 0;\r\npvoice->substream = NULL;\r\nspin_unlock_irq(&codec->voice_alloc);\r\nif (private_free)\r\nprivate_free(private_data);\r\n}\r\nstatic void snd_ali_clear_voices(struct snd_ali *codec,\r\nunsigned int v_min,\r\nunsigned int v_max)\r\n{\r\nunsigned int i;\r\nfor (i = v_min; i <= v_max; i++) {\r\nsnd_ali_stop_voice(codec, i);\r\nsnd_ali_disable_voice_irq(codec, i);\r\n}\r\n}\r\nstatic void snd_ali_write_voice_regs(struct snd_ali *codec,\r\nunsigned int Channel,\r\nunsigned int LBA,\r\nunsigned int CSO,\r\nunsigned int ESO,\r\nunsigned int DELTA,\r\nunsigned int ALPHA_FMS,\r\nunsigned int GVSEL,\r\nunsigned int PAN,\r\nunsigned int VOL,\r\nunsigned int CTRL,\r\nunsigned int EC)\r\n{\r\nunsigned int ctlcmds[4];\r\noutb((unsigned char)(Channel & 0x001f), ALI_REG(codec, ALI_GC_CIR));\r\nctlcmds[0] = (CSO << 16) | (ALPHA_FMS & 0x0000ffff);\r\nctlcmds[1] = LBA;\r\nctlcmds[2] = (ESO << 16) | (DELTA & 0x0ffff);\r\nctlcmds[3] = (GVSEL << 31) |\r\n((PAN & 0x0000007f) << 24) |\r\n((VOL & 0x000000ff) << 16) |\r\n((CTRL & 0x0000000f) << 12) |\r\n(EC & 0x00000fff);\r\noutb(Channel, ALI_REG(codec, ALI_GC_CIR));\r\noutl(ctlcmds[0], ALI_REG(codec, ALI_CSO_ALPHA_FMS));\r\noutl(ctlcmds[1], ALI_REG(codec, ALI_LBA));\r\noutl(ctlcmds[2], ALI_REG(codec, ALI_ESO_DELTA));\r\noutl(ctlcmds[3], ALI_REG(codec, ALI_GVSEL_PAN_VOC_CTRL_EC));\r\noutl(0x30000000, ALI_REG(codec, ALI_EBUF1));\r\noutl(0x30000000, ALI_REG(codec, ALI_EBUF2));\r\n}\r\nstatic unsigned int snd_ali_convert_rate(unsigned int rate, int rec)\r\n{\r\nunsigned int delta;\r\nif (rate < 4000)\r\nrate = 4000;\r\nif (rate > 48000)\r\nrate = 48000;\r\nif (rec) {\r\nif (rate == 44100)\r\ndelta = 0x116a;\r\nelse if (rate == 8000)\r\ndelta = 0x6000;\r\nelse if (rate == 48000)\r\ndelta = 0x1000;\r\nelse\r\ndelta = ((48000 << 12) / rate) & 0x0000ffff;\r\n} else {\r\nif (rate == 44100)\r\ndelta = 0xeb3;\r\nelse if (rate == 8000)\r\ndelta = 0x2ab;\r\nelse if (rate == 48000)\r\ndelta = 0x1000;\r\nelse\r\ndelta = (((rate << 12) + rate) / 48000) & 0x0000ffff;\r\n}\r\nreturn delta;\r\n}\r\nstatic unsigned int snd_ali_control_mode(struct snd_pcm_substream *substream)\r\n{\r\nunsigned int CTRL;\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nCTRL = 0x00000001;\r\nif (snd_pcm_format_width(runtime->format) == 16)\r\nCTRL |= 0x00000008;\r\nif (!snd_pcm_format_unsigned(runtime->format))\r\nCTRL |= 0x00000002;\r\nif (runtime->channels > 1)\r\nCTRL |= 0x00000004;\r\nreturn CTRL;\r\n}\r\nstatic int snd_ali_trigger(struct snd_pcm_substream *substream,\r\nint cmd)\r\n{\r\nstruct snd_ali *codec = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_substream *s;\r\nunsigned int what, whati, capture_flag;\r\nstruct snd_ali_voice *pvoice, *evoice;\r\nunsigned int val;\r\nint do_start;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ndo_start = 1;\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ndo_start = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nwhat = whati = capture_flag = 0;\r\nsnd_pcm_group_for_each_entry(s, substream) {\r\nif ((struct snd_ali *) snd_pcm_substream_chip(s) == codec) {\r\npvoice = s->runtime->private_data;\r\nevoice = pvoice->extra;\r\nwhat |= 1 << (pvoice->number & 0x1f);\r\nif (evoice == NULL)\r\nwhati |= 1 << (pvoice->number & 0x1f);\r\nelse {\r\nwhati |= 1 << (evoice->number & 0x1f);\r\nwhat |= 1 << (evoice->number & 0x1f);\r\n}\r\nif (do_start) {\r\npvoice->running = 1;\r\nif (evoice != NULL)\r\nevoice->running = 1;\r\n} else {\r\npvoice->running = 0;\r\nif (evoice != NULL)\r\nevoice->running = 0;\r\n}\r\nsnd_pcm_trigger_done(s, substream);\r\nif (pvoice->mode)\r\ncapture_flag = 1;\r\n}\r\n}\r\nspin_lock(&codec->reg_lock);\r\nif (!do_start)\r\noutl(what, ALI_REG(codec, ALI_STOP));\r\nval = inl(ALI_REG(codec, ALI_AINTEN));\r\nif (do_start)\r\nval |= whati;\r\nelse\r\nval &= ~whati;\r\noutl(val, ALI_REG(codec, ALI_AINTEN));\r\nif (do_start)\r\noutl(what, ALI_REG(codec, ALI_START));\r\ndev_dbg(codec->card->dev, "trigger: what=%xh whati=%xh\n", what, whati);\r\nspin_unlock(&codec->reg_lock);\r\nreturn 0;\r\n}\r\nstatic int snd_ali_playback_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *hw_params)\r\n{\r\nstruct snd_ali *codec = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct snd_ali_voice *pvoice = runtime->private_data;\r\nstruct snd_ali_voice *evoice = pvoice->extra;\r\nint err;\r\nerr = snd_pcm_lib_malloc_pages(substream,\r\nparams_buffer_bytes(hw_params));\r\nif (err < 0)\r\nreturn err;\r\nif (params_buffer_size(hw_params) / 2 !=\r\nparams_period_size(hw_params)) {\r\nif (!evoice) {\r\nevoice = snd_ali_alloc_voice(codec,\r\nSNDRV_ALI_VOICE_TYPE_PCM,\r\n0, -1);\r\nif (!evoice)\r\nreturn -ENOMEM;\r\npvoice->extra = evoice;\r\nevoice->substream = substream;\r\n}\r\n} else {\r\nif (evoice) {\r\nsnd_ali_free_voice(codec, evoice);\r\npvoice->extra = evoice = NULL;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_ali_playback_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_ali *codec = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct snd_ali_voice *pvoice = runtime->private_data;\r\nstruct snd_ali_voice *evoice = pvoice ? pvoice->extra : NULL;\r\nsnd_pcm_lib_free_pages(substream);\r\nif (evoice) {\r\nsnd_ali_free_voice(codec, evoice);\r\npvoice->extra = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_ali_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *hw_params)\r\n{\r\nreturn snd_pcm_lib_malloc_pages(substream,\r\nparams_buffer_bytes(hw_params));\r\n}\r\nstatic int snd_ali_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nreturn snd_pcm_lib_free_pages(substream);\r\n}\r\nstatic int snd_ali_playback_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_ali *codec = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct snd_ali_voice *pvoice = runtime->private_data;\r\nstruct snd_ali_voice *evoice = pvoice->extra;\r\nunsigned int LBA;\r\nunsigned int Delta;\r\nunsigned int ESO;\r\nunsigned int CTRL;\r\nunsigned int GVSEL;\r\nunsigned int PAN;\r\nunsigned int VOL;\r\nunsigned int EC;\r\ndev_dbg(codec->card->dev, "playback_prepare ...\n");\r\nspin_lock_irq(&codec->reg_lock);\r\nDelta = snd_ali_convert_rate(runtime->rate, 0);\r\nif (pvoice->number == ALI_SPDIF_IN_CHANNEL ||\r\npvoice->number == ALI_PCM_IN_CHANNEL)\r\nsnd_ali_disable_special_channel(codec, pvoice->number);\r\nelse if (codec->spdif_support &&\r\n(inl(ALI_REG(codec, ALI_GLOBAL_CONTROL)) &\r\nALI_SPDIF_OUT_CH_ENABLE)\r\n&& pvoice->number == ALI_SPDIF_OUT_CHANNEL) {\r\nsnd_ali_set_spdif_out_rate(codec, runtime->rate);\r\nDelta = 0x1000;\r\n}\r\nLBA = runtime->dma_addr;\r\npvoice->count = runtime->period_size;\r\npvoice->eso = runtime->buffer_size;\r\ndev_dbg(codec->card->dev, "playback_prepare: eso=%xh count=%xh\n",\r\npvoice->eso, pvoice->count);\r\nESO = pvoice->eso -1;\r\nCTRL = snd_ali_control_mode(substream);\r\nGVSEL = 1;\r\nPAN = 0;\r\nVOL = 0;\r\nEC = 0;\r\ndev_dbg(codec->card->dev, "playback_prepare:\n");\r\ndev_dbg(codec->card->dev,\r\n"ch=%d, Rate=%d Delta=%xh,GVSEL=%xh,PAN=%xh,CTRL=%xh\n",\r\npvoice->number,runtime->rate,Delta,GVSEL,PAN,CTRL);\r\nsnd_ali_write_voice_regs(codec,\r\npvoice->number,\r\nLBA,\r\n0,\r\nESO,\r\nDelta,\r\n0,\r\nGVSEL,\r\nPAN,\r\nVOL,\r\nCTRL,\r\nEC);\r\nif (evoice) {\r\nevoice->count = pvoice->count;\r\nevoice->eso = pvoice->count << 1;\r\nESO = evoice->eso - 1;\r\nsnd_ali_write_voice_regs(codec,\r\nevoice->number,\r\nLBA,\r\n0,\r\nESO,\r\nDelta,\r\n0,\r\nGVSEL,\r\n0x7f,\r\n0x3ff,\r\nCTRL,\r\nEC);\r\n}\r\nspin_unlock_irq(&codec->reg_lock);\r\nreturn 0;\r\n}\r\nstatic int snd_ali_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_ali *codec = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct snd_ali_voice *pvoice = runtime->private_data;\r\nunsigned int LBA;\r\nunsigned int Delta;\r\nunsigned int ESO;\r\nunsigned int CTRL;\r\nunsigned int GVSEL;\r\nunsigned int PAN;\r\nunsigned int VOL;\r\nunsigned int EC;\r\nu8 bValue;\r\nspin_lock_irq(&codec->reg_lock);\r\ndev_dbg(codec->card->dev, "ali_prepare...\n");\r\nsnd_ali_enable_special_channel(codec,pvoice->number);\r\nDelta = (pvoice->number == ALI_MODEM_IN_CHANNEL ||\r\npvoice->number == ALI_MODEM_OUT_CHANNEL) ?\r\n0x1000 : snd_ali_convert_rate(runtime->rate, pvoice->mode);\r\nif (pvoice->number == ALI_SPDIF_IN_CHANNEL) {\r\nunsigned int rate;\r\nspin_unlock_irq(&codec->reg_lock);\r\nif (codec->revision != ALI_5451_V02)\r\nreturn -1;\r\nrate = snd_ali_get_spdif_in_rate(codec);\r\nif (rate == 0) {\r\ndev_warn(codec->card->dev,\r\n"ali_capture_preapre: spdif rate detect err!\n");\r\nrate = 48000;\r\n}\r\nspin_lock_irq(&codec->reg_lock);\r\nbValue = inb(ALI_REG(codec,ALI_SPDIF_CTRL));\r\nif (bValue & 0x10) {\r\noutb(bValue,ALI_REG(codec,ALI_SPDIF_CTRL));\r\ndev_warn(codec->card->dev,\r\n"clear SPDIF parity error flag.\n");\r\n}\r\nif (rate != 48000)\r\nDelta = ((rate << 12) / runtime->rate) & 0x00ffff;\r\n}\r\npvoice->eso = runtime->buffer_size;\r\npvoice->count = runtime->period_size;\r\nLBA = runtime->dma_addr;\r\nESO = pvoice->eso - 1;\r\nCTRL = snd_ali_control_mode(substream);\r\nGVSEL = 0;\r\nPAN = 0x00;\r\nVOL = 0x00;\r\nEC = 0;\r\nsnd_ali_write_voice_regs( codec,\r\npvoice->number,\r\nLBA,\r\n0,\r\nESO,\r\nDelta,\r\n0,\r\nGVSEL,\r\nPAN,\r\nVOL,\r\nCTRL,\r\nEC);\r\nspin_unlock_irq(&codec->reg_lock);\r\nreturn 0;\r\n}\r\nstatic snd_pcm_uframes_t\r\nsnd_ali_playback_pointer(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_ali *codec = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct snd_ali_voice *pvoice = runtime->private_data;\r\nunsigned int cso;\r\nspin_lock(&codec->reg_lock);\r\nif (!pvoice->running) {\r\nspin_unlock(&codec->reg_lock);\r\nreturn 0;\r\n}\r\noutb(pvoice->number, ALI_REG(codec, ALI_GC_CIR));\r\ncso = inw(ALI_REG(codec, ALI_CSO_ALPHA_FMS + 2));\r\nspin_unlock(&codec->reg_lock);\r\ndev_dbg(codec->card->dev, "playback pointer returned cso=%xh.\n", cso);\r\ncso %= runtime->buffer_size;\r\nreturn cso;\r\n}\r\nstatic snd_pcm_uframes_t snd_ali_pointer(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_ali *codec = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct snd_ali_voice *pvoice = runtime->private_data;\r\nunsigned int cso;\r\nspin_lock(&codec->reg_lock);\r\nif (!pvoice->running) {\r\nspin_unlock(&codec->reg_lock);\r\nreturn 0;\r\n}\r\noutb(pvoice->number, ALI_REG(codec, ALI_GC_CIR));\r\ncso = inw(ALI_REG(codec, ALI_CSO_ALPHA_FMS + 2));\r\nspin_unlock(&codec->reg_lock);\r\ncso %= runtime->buffer_size;\r\nreturn cso;\r\n}\r\nstatic void snd_ali_pcm_free_substream(struct snd_pcm_runtime *runtime)\r\n{\r\nstruct snd_ali_voice *pvoice = runtime->private_data;\r\nstruct snd_ali *codec;\r\nif (pvoice) {\r\ncodec = pvoice->codec;\r\nsnd_ali_free_voice(pvoice->codec, pvoice);\r\n}\r\n}\r\nstatic int snd_ali_open(struct snd_pcm_substream *substream, int rec,\r\nint channel, struct snd_pcm_hardware *phw)\r\n{\r\nstruct snd_ali *codec = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct snd_ali_voice *pvoice;\r\npvoice = snd_ali_alloc_voice(codec, SNDRV_ALI_VOICE_TYPE_PCM, rec,\r\nchannel);\r\nif (!pvoice)\r\nreturn -EAGAIN;\r\npvoice->substream = substream;\r\nruntime->private_data = pvoice;\r\nruntime->private_free = snd_ali_pcm_free_substream;\r\nruntime->hw = *phw;\r\nsnd_pcm_set_sync(substream);\r\nsnd_pcm_hw_constraint_minmax(runtime, SNDRV_PCM_HW_PARAM_BUFFER_SIZE,\r\n0, 64*1024);\r\nreturn 0;\r\n}\r\nstatic int snd_ali_playback_open(struct snd_pcm_substream *substream)\r\n{\r\nreturn snd_ali_open(substream, 0, -1, &snd_ali_playback);\r\n}\r\nstatic int snd_ali_capture_open(struct snd_pcm_substream *substream)\r\n{\r\nreturn snd_ali_open(substream, 1, -1, &snd_ali_capture);\r\n}\r\nstatic int snd_ali_playback_close(struct snd_pcm_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int snd_ali_close(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_ali *codec = snd_pcm_substream_chip(substream);\r\nstruct snd_ali_voice *pvoice = substream->runtime->private_data;\r\nsnd_ali_disable_special_channel(codec,pvoice->number);\r\nreturn 0;\r\n}\r\nstatic int snd_ali_modem_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *hw_params)\r\n{\r\nstruct snd_ali *chip = snd_pcm_substream_chip(substream);\r\nunsigned int modem_num = chip->num_of_codecs - 1;\r\nsnd_ac97_write(chip->ac97[modem_num], AC97_LINE1_RATE,\r\nparams_rate(hw_params));\r\nsnd_ac97_write(chip->ac97[modem_num], AC97_LINE1_LEVEL, 0);\r\nreturn snd_ali_hw_params(substream, hw_params);\r\n}\r\nstatic int snd_ali_modem_open(struct snd_pcm_substream *substream, int rec,\r\nint channel)\r\n{\r\nstatic unsigned int rates[] = {8000, 9600, 12000, 16000};\r\nstatic struct snd_pcm_hw_constraint_list hw_constraint_rates = {\r\n.count = ARRAY_SIZE(rates),\r\n.list = rates,\r\n.mask = 0,\r\n};\r\nint err = snd_ali_open(substream, rec, channel, &snd_ali_modem);\r\nif (err)\r\nreturn err;\r\nreturn snd_pcm_hw_constraint_list(substream->runtime, 0,\r\nSNDRV_PCM_HW_PARAM_RATE, &hw_constraint_rates);\r\n}\r\nstatic int snd_ali_modem_playback_open(struct snd_pcm_substream *substream)\r\n{\r\nreturn snd_ali_modem_open(substream, 0, ALI_MODEM_OUT_CHANNEL);\r\n}\r\nstatic int snd_ali_modem_capture_open(struct snd_pcm_substream *substream)\r\n{\r\nreturn snd_ali_modem_open(substream, 1, ALI_MODEM_IN_CHANNEL);\r\n}\r\nstatic void snd_ali_pcm_free(struct snd_pcm *pcm)\r\n{\r\nstruct snd_ali *codec = pcm->private_data;\r\ncodec->pcm[pcm->device] = NULL;\r\n}\r\nstatic int snd_ali_pcm(struct snd_ali *codec, int device,\r\nstruct ali_pcm_description *desc)\r\n{\r\nstruct snd_pcm *pcm;\r\nint err;\r\nerr = snd_pcm_new(codec->card, desc->name, device,\r\ndesc->playback_num, desc->capture_num, &pcm);\r\nif (err < 0) {\r\ndev_err(codec->card->dev,\r\n"snd_ali_pcm: err called snd_pcm_new.\n");\r\nreturn err;\r\n}\r\npcm->private_data = codec;\r\npcm->private_free = snd_ali_pcm_free;\r\nif (desc->playback_ops)\r\nsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_PLAYBACK,\r\ndesc->playback_ops);\r\nif (desc->capture_ops)\r\nsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_CAPTURE,\r\ndesc->capture_ops);\r\nsnd_pcm_lib_preallocate_pages_for_all(pcm, SNDRV_DMA_TYPE_DEV,\r\nsnd_dma_pci_data(codec->pci),\r\n64*1024, 128*1024);\r\npcm->info_flags = 0;\r\npcm->dev_class = desc->class;\r\npcm->dev_subclass = SNDRV_PCM_SUBCLASS_GENERIC_MIX;\r\nstrcpy(pcm->name, desc->name);\r\ncodec->pcm[0] = pcm;\r\nreturn 0;\r\n}\r\nstatic int snd_ali_build_pcms(struct snd_ali *codec)\r\n{\r\nint i, err;\r\nfor (i = 0; i < codec->num_of_codecs && i < ARRAY_SIZE(ali_pcms); i++) {\r\nerr = snd_ali_pcm(codec, i, &ali_pcms[i]);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_ali5451_spdif_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ali *codec = kcontrol->private_data;\r\nunsigned int spdif_enable;\r\nspdif_enable = ucontrol->value.integer.value[0] ? 1 : 0;\r\nspin_lock_irq(&codec->reg_lock);\r\nswitch (kcontrol->private_value) {\r\ncase 0:\r\nspdif_enable = (codec->spdif_mask & 0x02) ? 1 : 0;\r\nbreak;\r\ncase 1:\r\nspdif_enable = ((codec->spdif_mask & 0x02) &&\r\n(codec->spdif_mask & 0x04)) ? 1 : 0;\r\nbreak;\r\ncase 2:\r\nspdif_enable = (codec->spdif_mask & 0x01) ? 1 : 0;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nucontrol->value.integer.value[0] = spdif_enable;\r\nspin_unlock_irq(&codec->reg_lock);\r\nreturn 0;\r\n}\r\nstatic int snd_ali5451_spdif_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ali *codec = kcontrol->private_data;\r\nunsigned int change = 0, spdif_enable = 0;\r\nspdif_enable = ucontrol->value.integer.value[0] ? 1 : 0;\r\nspin_lock_irq(&codec->reg_lock);\r\nswitch (kcontrol->private_value) {\r\ncase 0:\r\nchange = (codec->spdif_mask & 0x02) ? 1 : 0;\r\nchange = change ^ spdif_enable;\r\nif (change) {\r\nif (spdif_enable) {\r\ncodec->spdif_mask |= 0x02;\r\nsnd_ali_enable_spdif_out(codec);\r\n} else {\r\ncodec->spdif_mask &= ~(0x02);\r\ncodec->spdif_mask &= ~(0x04);\r\nsnd_ali_disable_spdif_out(codec);\r\n}\r\n}\r\nbreak;\r\ncase 1:\r\nchange = (codec->spdif_mask & 0x04) ? 1 : 0;\r\nchange = change ^ spdif_enable;\r\nif (change && (codec->spdif_mask & 0x02)) {\r\nif (spdif_enable) {\r\ncodec->spdif_mask |= 0x04;\r\nsnd_ali_enable_spdif_chnout(codec);\r\n} else {\r\ncodec->spdif_mask &= ~(0x04);\r\nsnd_ali_disable_spdif_chnout(codec);\r\n}\r\n}\r\nbreak;\r\ncase 2:\r\nchange = (codec->spdif_mask & 0x01) ? 1 : 0;\r\nchange = change ^ spdif_enable;\r\nif (change) {\r\nif (spdif_enable) {\r\ncodec->spdif_mask |= 0x01;\r\nsnd_ali_enable_spdif_in(codec);\r\n} else {\r\ncodec->spdif_mask &= ~(0x01);\r\nsnd_ali_disable_spdif_in(codec);\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nspin_unlock_irq(&codec->reg_lock);\r\nreturn change;\r\n}\r\nstatic int snd_ali_mixer(struct snd_ali *codec)\r\n{\r\nstruct snd_ac97_template ac97;\r\nunsigned int idx;\r\nint i, err;\r\nstatic struct snd_ac97_bus_ops ops = {\r\n.write = snd_ali_codec_write,\r\n.read = snd_ali_codec_read,\r\n};\r\nerr = snd_ac97_bus(codec->card, 0, &ops, codec, &codec->ac97_bus);\r\nif (err < 0)\r\nreturn err;\r\nmemset(&ac97, 0, sizeof(ac97));\r\nac97.private_data = codec;\r\nfor (i = 0; i < codec->num_of_codecs; i++) {\r\nac97.num = i;\r\nerr = snd_ac97_mixer(codec->ac97_bus, &ac97, &codec->ac97[i]);\r\nif (err < 0) {\r\ndev_err(codec->card->dev,\r\n"ali mixer %d creating error.\n", i);\r\nif (i == 0)\r\nreturn err;\r\ncodec->num_of_codecs = 1;\r\nbreak;\r\n}\r\n}\r\nif (codec->spdif_support) {\r\nfor (idx = 0; idx < ARRAY_SIZE(snd_ali5451_mixer_spdif); idx++) {\r\nerr = snd_ctl_add(codec->card,\r\nsnd_ctl_new1(&snd_ali5451_mixer_spdif[idx], codec));\r\nif (err < 0)\r\nreturn err;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int ali_suspend(struct device *dev)\r\n{\r\nstruct snd_card *card = dev_get_drvdata(dev);\r\nstruct snd_ali *chip = card->private_data;\r\nstruct snd_ali_image *im;\r\nint i, j;\r\nim = chip->image;\r\nif (!im)\r\nreturn 0;\r\nsnd_power_change_state(card, SNDRV_CTL_POWER_D3hot);\r\nfor (i = 0; i < chip->num_of_codecs; i++) {\r\nsnd_pcm_suspend_all(chip->pcm[i]);\r\nsnd_ac97_suspend(chip->ac97[i]);\r\n}\r\nspin_lock_irq(&chip->reg_lock);\r\nim->regs[ALI_MISCINT >> 2] = inl(ALI_REG(chip, ALI_MISCINT));\r\nim->regs[ALI_STOP >> 2] = inl(ALI_REG(chip, ALI_STOP));\r\noutl(0, ALI_REG(chip, ALI_MISCINT));\r\nfor (i = 0; i < ALI_GLOBAL_REGS; i++) {\r\nif ((i*4 == ALI_MISCINT) || (i*4 == ALI_STOP))\r\ncontinue;\r\nim->regs[i] = inl(ALI_REG(chip, i*4));\r\n}\r\nfor (i = 0; i < ALI_CHANNELS; i++) {\r\noutb(i, ALI_REG(chip, ALI_GC_CIR));\r\nfor (j = 0; j < ALI_CHANNEL_REGS; j++)\r\nim->channel_regs[i][j] = inl(ALI_REG(chip, j*4 + 0xe0));\r\n}\r\noutl(0xffffffff, ALI_REG(chip, ALI_STOP));\r\nspin_unlock_irq(&chip->reg_lock);\r\nreturn 0;\r\n}\r\nstatic int ali_resume(struct device *dev)\r\n{\r\nstruct snd_card *card = dev_get_drvdata(dev);\r\nstruct snd_ali *chip = card->private_data;\r\nstruct snd_ali_image *im;\r\nint i, j;\r\nim = chip->image;\r\nif (!im)\r\nreturn 0;\r\nspin_lock_irq(&chip->reg_lock);\r\nfor (i = 0; i < ALI_CHANNELS; i++) {\r\noutb(i, ALI_REG(chip, ALI_GC_CIR));\r\nfor (j = 0; j < ALI_CHANNEL_REGS; j++)\r\noutl(im->channel_regs[i][j], ALI_REG(chip, j*4 + 0xe0));\r\n}\r\nfor (i = 0; i < ALI_GLOBAL_REGS; i++) {\r\nif ((i*4 == ALI_MISCINT) || (i*4 == ALI_STOP) ||\r\n(i*4 == ALI_START))\r\ncontinue;\r\noutl(im->regs[i], ALI_REG(chip, i*4));\r\n}\r\noutl(im->regs[ALI_START >> 2], ALI_REG(chip, ALI_START));\r\noutl(im->regs[ALI_MISCINT >> 2], ALI_REG(chip, ALI_MISCINT));\r\nspin_unlock_irq(&chip->reg_lock);\r\nfor (i = 0 ; i < chip->num_of_codecs; i++)\r\nsnd_ac97_resume(chip->ac97[i]);\r\nsnd_power_change_state(card, SNDRV_CTL_POWER_D0);\r\nreturn 0;\r\n}\r\nstatic int snd_ali_free(struct snd_ali * codec)\r\n{\r\nif (codec->hw_initialized)\r\nsnd_ali_disable_address_interrupt(codec);\r\nif (codec->irq >= 0)\r\nfree_irq(codec->irq, codec);\r\nif (codec->port)\r\npci_release_regions(codec->pci);\r\npci_disable_device(codec->pci);\r\n#ifdef CONFIG_PM_SLEEP\r\nkfree(codec->image);\r\n#endif\r\npci_dev_put(codec->pci_m1533);\r\npci_dev_put(codec->pci_m7101);\r\nkfree(codec);\r\nreturn 0;\r\n}\r\nstatic int snd_ali_chip_init(struct snd_ali *codec)\r\n{\r\nunsigned int legacy;\r\nunsigned char temp;\r\nstruct pci_dev *pci_dev;\r\ndev_dbg(codec->card->dev, "chip initializing ...\n");\r\nif (snd_ali_reset_5451(codec)) {\r\ndev_err(codec->card->dev, "ali_chip_init: reset 5451 error.\n");\r\nreturn -1;\r\n}\r\nif (codec->revision == ALI_5451_V02) {\r\npci_dev = codec->pci_m1533;\r\npci_read_config_byte(pci_dev, 0x59, &temp);\r\ntemp |= 0x80;\r\npci_write_config_byte(pci_dev, 0x59, temp);\r\npci_dev = codec->pci_m7101;\r\npci_read_config_byte(pci_dev, 0xb8, &temp);\r\ntemp |= 0x20;\r\npci_write_config_byte(pci_dev, 0xB8, temp);\r\n}\r\npci_read_config_dword(codec->pci, 0x44, &legacy);\r\nlegacy &= 0xff00ff00;\r\nlegacy |= 0x000800aa;\r\npci_write_config_dword(codec->pci, 0x44, legacy);\r\noutl(0x80000001, ALI_REG(codec, ALI_GLOBAL_CONTROL));\r\noutl(0x00000000, ALI_REG(codec, ALI_AINTEN));\r\noutl(0xffffffff, ALI_REG(codec, ALI_AINT));\r\noutl(0x00000000, ALI_REG(codec, ALI_VOLUME));\r\noutb(0x10, ALI_REG(codec, ALI_MPUR2));\r\ncodec->ac97_ext_id = snd_ali_codec_peek(codec, 0, AC97_EXTENDED_ID);\r\ncodec->ac97_ext_status = snd_ali_codec_peek(codec, 0,\r\nAC97_EXTENDED_STATUS);\r\nif (codec->spdif_support) {\r\nsnd_ali_enable_spdif_out(codec);\r\ncodec->spdif_mask = 0x00000002;\r\n}\r\ncodec->num_of_codecs = 1;\r\nif (inl(ALI_REG(codec, ALI_SCTRL)) & ALI_SCTRL_CODEC2_READY) {\r\ncodec->num_of_codecs++;\r\noutl(inl(ALI_REG(codec, ALI_SCTRL)) |\r\n(ALI_SCTRL_LINE_IN2 | ALI_SCTRL_GPIO_IN2 |\r\nALI_SCTRL_LINE_OUT_EN),\r\nALI_REG(codec, ALI_SCTRL));\r\n}\r\ndev_dbg(codec->card->dev, "chip initialize succeed.\n");\r\nreturn 0;\r\n}\r\nstatic void snd_ali_proc_read(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buf)\r\n{\r\nstruct snd_ali *codec = entry->private_data;\r\nint i;\r\nfor (i = 0; i < 256 ; i+= 4)\r\nsnd_iprintf(buf, "%02x: %08x\n", i, inl(ALI_REG(codec, i)));\r\n}\r\nstatic void snd_ali_proc_init(struct snd_ali *codec)\r\n{\r\nstruct snd_info_entry *entry;\r\nif (!snd_card_proc_new(codec->card, "ali5451", &entry))\r\nsnd_info_set_text_ops(entry, codec, snd_ali_proc_read);\r\n}\r\nstatic int snd_ali_resources(struct snd_ali *codec)\r\n{\r\nint err;\r\ndev_dbg(codec->card->dev, "resources allocation ...\n");\r\nerr = pci_request_regions(codec->pci, "ALI 5451");\r\nif (err < 0)\r\nreturn err;\r\ncodec->port = pci_resource_start(codec->pci, 0);\r\nif (request_irq(codec->pci->irq, snd_ali_card_interrupt,\r\nIRQF_SHARED, KBUILD_MODNAME, codec)) {\r\ndev_err(codec->card->dev, "Unable to request irq.\n");\r\nreturn -EBUSY;\r\n}\r\ncodec->irq = codec->pci->irq;\r\ndev_dbg(codec->card->dev, "resources allocated.\n");\r\nreturn 0;\r\n}\r\nstatic int snd_ali_dev_free(struct snd_device *device)\r\n{\r\nstruct snd_ali *codec = device->device_data;\r\nsnd_ali_free(codec);\r\nreturn 0;\r\n}\r\nstatic int snd_ali_create(struct snd_card *card,\r\nstruct pci_dev *pci,\r\nint pcm_streams,\r\nint spdif_support,\r\nstruct snd_ali **r_ali)\r\n{\r\nstruct snd_ali *codec;\r\nint i, err;\r\nunsigned short cmdw;\r\nstatic struct snd_device_ops ops = {\r\n.dev_free = snd_ali_dev_free,\r\n};\r\n*r_ali = NULL;\r\ndev_dbg(card->dev, "creating ...\n");\r\nerr = pci_enable_device(pci);\r\nif (err < 0)\r\nreturn err;\r\nif (dma_set_mask(&pci->dev, DMA_BIT_MASK(31)) < 0 ||\r\ndma_set_coherent_mask(&pci->dev, DMA_BIT_MASK(31)) < 0) {\r\ndev_err(card->dev,\r\n"architecture does not support 31bit PCI busmaster DMA\n");\r\npci_disable_device(pci);\r\nreturn -ENXIO;\r\n}\r\ncodec = kzalloc(sizeof(*codec), GFP_KERNEL);\r\nif (!codec) {\r\npci_disable_device(pci);\r\nreturn -ENOMEM;\r\n}\r\nspin_lock_init(&codec->reg_lock);\r\nspin_lock_init(&codec->voice_alloc);\r\ncodec->card = card;\r\ncodec->pci = pci;\r\ncodec->irq = -1;\r\ncodec->revision = pci->revision;\r\ncodec->spdif_support = spdif_support;\r\nif (pcm_streams < 1)\r\npcm_streams = 1;\r\nif (pcm_streams > 32)\r\npcm_streams = 32;\r\npci_set_master(pci);\r\npci_read_config_word(pci, PCI_COMMAND, &cmdw);\r\nif ((cmdw & PCI_COMMAND_IO) != PCI_COMMAND_IO) {\r\ncmdw |= PCI_COMMAND_IO;\r\npci_write_config_word(pci, PCI_COMMAND, cmdw);\r\n}\r\npci_set_master(pci);\r\nif (snd_ali_resources(codec)) {\r\nsnd_ali_free(codec);\r\nreturn -EBUSY;\r\n}\r\nsynchronize_irq(pci->irq);\r\ncodec->synth.chmap = 0;\r\ncodec->synth.chcnt = 0;\r\ncodec->spdif_mask = 0;\r\ncodec->synth.synthcount = 0;\r\nif (codec->revision == ALI_5451_V02)\r\ncodec->chregs.regs.ac97read = ALI_AC97_WRITE;\r\nelse\r\ncodec->chregs.regs.ac97read = ALI_AC97_READ;\r\ncodec->chregs.regs.ac97write = ALI_AC97_WRITE;\r\ncodec->chregs.regs.start = ALI_START;\r\ncodec->chregs.regs.stop = ALI_STOP;\r\ncodec->chregs.regs.aint = ALI_AINT;\r\ncodec->chregs.regs.ainten = ALI_AINTEN;\r\ncodec->chregs.data.start = 0x00;\r\ncodec->chregs.data.stop = 0x00;\r\ncodec->chregs.data.aint = 0x00;\r\ncodec->chregs.data.ainten = 0x00;\r\ncodec->pci_m1533 = pci_get_device(0x10b9, 0x1533, NULL);\r\nif (!codec->pci_m1533) {\r\ndev_err(card->dev, "cannot find ALi 1533 chip.\n");\r\nsnd_ali_free(codec);\r\nreturn -ENODEV;\r\n}\r\ncodec->pci_m7101 = pci_get_device(0x10b9, 0x7101, NULL);\r\nif (!codec->pci_m7101 && codec->revision == ALI_5451_V02) {\r\ndev_err(card->dev, "cannot find ALi 7101 chip.\n");\r\nsnd_ali_free(codec);\r\nreturn -ENODEV;\r\n}\r\ndev_dbg(card->dev, "snd_device_new is called.\n");\r\nerr = snd_device_new(card, SNDRV_DEV_LOWLEVEL, codec, &ops);\r\nif (err < 0) {\r\nsnd_ali_free(codec);\r\nreturn err;\r\n}\r\nfor (i = 0; i < ALI_CHANNELS; i++)\r\ncodec->synth.voices[i].number = i;\r\nerr = snd_ali_chip_init(codec);\r\nif (err < 0) {\r\ndev_err(card->dev, "ali create: chip init error.\n");\r\nreturn err;\r\n}\r\n#ifdef CONFIG_PM_SLEEP\r\ncodec->image = kmalloc(sizeof(*codec->image), GFP_KERNEL);\r\nif (!codec->image)\r\ndev_warn(card->dev, "can't allocate apm buffer\n");\r\n#endif\r\nsnd_ali_enable_address_interrupt(codec);\r\ncodec->hw_initialized = 1;\r\n*r_ali = codec;\r\ndev_dbg(card->dev, "created.\n");\r\nreturn 0;\r\n}\r\nstatic int snd_ali_probe(struct pci_dev *pci,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nstruct snd_card *card;\r\nstruct snd_ali *codec;\r\nint err;\r\ndev_dbg(&pci->dev, "probe ...\n");\r\nerr = snd_card_new(&pci->dev, index, id, THIS_MODULE, 0, &card);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_ali_create(card, pci, pcm_channels, spdif, &codec);\r\nif (err < 0)\r\ngoto error;\r\ncard->private_data = codec;\r\ndev_dbg(&pci->dev, "mixer building ...\n");\r\nerr = snd_ali_mixer(codec);\r\nif (err < 0)\r\ngoto error;\r\ndev_dbg(&pci->dev, "pcm building ...\n");\r\nerr = snd_ali_build_pcms(codec);\r\nif (err < 0)\r\ngoto error;\r\nsnd_ali_proc_init(codec);\r\nstrcpy(card->driver, "ALI5451");\r\nstrcpy(card->shortname, "ALI 5451");\r\nsprintf(card->longname, "%s at 0x%lx, irq %i",\r\ncard->shortname, codec->port, codec->irq);\r\ndev_dbg(&pci->dev, "register card.\n");\r\nerr = snd_card_register(card);\r\nif (err < 0)\r\ngoto error;\r\npci_set_drvdata(pci, card);\r\nreturn 0;\r\nerror:\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nstatic void snd_ali_remove(struct pci_dev *pci)\r\n{\r\nsnd_card_free(pci_get_drvdata(pci));\r\n}

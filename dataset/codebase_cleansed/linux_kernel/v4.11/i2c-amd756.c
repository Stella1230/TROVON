static int amd756_transaction(struct i2c_adapter *adap)\r\n{\r\nint temp;\r\nint result = 0;\r\nint timeout = 0;\r\ndev_dbg(&adap->dev, "Transaction (pre): GS=%04x, GE=%04x, ADD=%04x, "\r\n"DAT=%04x\n", inw_p(SMB_GLOBAL_STATUS),\r\ninw_p(SMB_GLOBAL_ENABLE), inw_p(SMB_HOST_ADDRESS),\r\ninb_p(SMB_HOST_DATA));\r\nif ((temp = inw_p(SMB_GLOBAL_STATUS)) & (GS_HST_STS | GS_SMB_STS)) {\r\ndev_dbg(&adap->dev, "SMBus busy (%04x). Waiting...\n", temp);\r\ndo {\r\nmsleep(1);\r\ntemp = inw_p(SMB_GLOBAL_STATUS);\r\n} while ((temp & (GS_HST_STS | GS_SMB_STS)) &&\r\n(timeout++ < MAX_TIMEOUT));\r\nif (timeout > MAX_TIMEOUT) {\r\ndev_dbg(&adap->dev, "Busy wait timeout (%04x)\n", temp);\r\ngoto abort;\r\n}\r\ntimeout = 0;\r\n}\r\noutw_p(inw(SMB_GLOBAL_ENABLE) | GE_HOST_STC, SMB_GLOBAL_ENABLE);\r\ndo {\r\nmsleep(1);\r\ntemp = inw_p(SMB_GLOBAL_STATUS);\r\n} while ((temp & GS_HST_STS) && (timeout++ < MAX_TIMEOUT));\r\nif (timeout > MAX_TIMEOUT) {\r\ndev_dbg(&adap->dev, "Completion timeout!\n");\r\ngoto abort;\r\n}\r\nif (temp & GS_PRERR_STS) {\r\nresult = -ENXIO;\r\ndev_dbg(&adap->dev, "SMBus Protocol error (no response)!\n");\r\n}\r\nif (temp & GS_COL_STS) {\r\nresult = -EIO;\r\ndev_warn(&adap->dev, "SMBus collision!\n");\r\n}\r\nif (temp & GS_TO_STS) {\r\nresult = -ETIMEDOUT;\r\ndev_dbg(&adap->dev, "SMBus protocol timeout!\n");\r\n}\r\nif (temp & GS_HCYC_STS)\r\ndev_dbg(&adap->dev, "SMBus protocol success!\n");\r\noutw_p(GS_CLEAR_STS, SMB_GLOBAL_STATUS);\r\n#ifdef DEBUG\r\nif (((temp = inw_p(SMB_GLOBAL_STATUS)) & GS_CLEAR_STS) != 0x00) {\r\ndev_dbg(&adap->dev,\r\n"Failed reset at end of transaction (%04x)\n", temp);\r\n}\r\n#endif\r\ndev_dbg(&adap->dev,\r\n"Transaction (post): GS=%04x, GE=%04x, ADD=%04x, DAT=%04x\n",\r\ninw_p(SMB_GLOBAL_STATUS), inw_p(SMB_GLOBAL_ENABLE),\r\ninw_p(SMB_HOST_ADDRESS), inb_p(SMB_HOST_DATA));\r\nreturn result;\r\nabort:\r\ndev_warn(&adap->dev, "Sending abort\n");\r\noutw_p(inw(SMB_GLOBAL_ENABLE) | GE_ABORT, SMB_GLOBAL_ENABLE);\r\nmsleep(100);\r\noutw_p(GS_CLEAR_STS, SMB_GLOBAL_STATUS);\r\nreturn -EIO;\r\n}\r\nstatic s32 amd756_access(struct i2c_adapter * adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size, union i2c_smbus_data * data)\r\n{\r\nint i, len;\r\nint status;\r\nswitch (size) {\r\ncase I2C_SMBUS_QUICK:\r\noutw_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMB_HOST_ADDRESS);\r\nsize = AMD756_QUICK;\r\nbreak;\r\ncase I2C_SMBUS_BYTE:\r\noutw_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMB_HOST_ADDRESS);\r\nif (read_write == I2C_SMBUS_WRITE)\r\noutb_p(command, SMB_HOST_DATA);\r\nsize = AMD756_BYTE;\r\nbreak;\r\ncase I2C_SMBUS_BYTE_DATA:\r\noutw_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMB_HOST_ADDRESS);\r\noutb_p(command, SMB_HOST_COMMAND);\r\nif (read_write == I2C_SMBUS_WRITE)\r\noutw_p(data->byte, SMB_HOST_DATA);\r\nsize = AMD756_BYTE_DATA;\r\nbreak;\r\ncase I2C_SMBUS_WORD_DATA:\r\noutw_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMB_HOST_ADDRESS);\r\noutb_p(command, SMB_HOST_COMMAND);\r\nif (read_write == I2C_SMBUS_WRITE)\r\noutw_p(data->word, SMB_HOST_DATA);\r\nsize = AMD756_WORD_DATA;\r\nbreak;\r\ncase I2C_SMBUS_BLOCK_DATA:\r\noutw_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMB_HOST_ADDRESS);\r\noutb_p(command, SMB_HOST_COMMAND);\r\nif (read_write == I2C_SMBUS_WRITE) {\r\nlen = data->block[0];\r\nif (len < 0)\r\nlen = 0;\r\nif (len > 32)\r\nlen = 32;\r\noutw_p(len, SMB_HOST_DATA);\r\nfor (i = 1; i <= len; i++)\r\noutb_p(data->block[i],\r\nSMB_HOST_BLOCK_DATA);\r\n}\r\nsize = AMD756_BLOCK_DATA;\r\nbreak;\r\ndefault:\r\ndev_warn(&adap->dev, "Unsupported transaction %d\n", size);\r\nreturn -EOPNOTSUPP;\r\n}\r\noutw_p(size & GE_CYC_TYPE_MASK, SMB_GLOBAL_ENABLE);\r\nstatus = amd756_transaction(adap);\r\nif (status)\r\nreturn status;\r\nif ((read_write == I2C_SMBUS_WRITE) || (size == AMD756_QUICK))\r\nreturn 0;\r\nswitch (size) {\r\ncase AMD756_BYTE:\r\ndata->byte = inw_p(SMB_HOST_DATA);\r\nbreak;\r\ncase AMD756_BYTE_DATA:\r\ndata->byte = inw_p(SMB_HOST_DATA);\r\nbreak;\r\ncase AMD756_WORD_DATA:\r\ndata->word = inw_p(SMB_HOST_DATA);\r\nbreak;\r\ncase AMD756_BLOCK_DATA:\r\ndata->block[0] = inw_p(SMB_HOST_DATA) & 0x3f;\r\nif(data->block[0] > 32)\r\ndata->block[0] = 32;\r\nfor (i = 1; i <= data->block[0]; i++)\r\ndata->block[i] = inb_p(SMB_HOST_BLOCK_DATA);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic u32 amd756_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_SMBUS_QUICK | I2C_FUNC_SMBUS_BYTE |\r\nI2C_FUNC_SMBUS_BYTE_DATA | I2C_FUNC_SMBUS_WORD_DATA |\r\nI2C_FUNC_SMBUS_BLOCK_DATA;\r\n}\r\nstatic int amd756_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nint nforce = (id->driver_data == NFORCE);\r\nint error;\r\nu8 temp;\r\nif (amd756_ioport) {\r\ndev_err(&pdev->dev, "Only one device supported "\r\n"(you have a strange motherboard, btw)\n");\r\nreturn -ENODEV;\r\n}\r\nif (nforce) {\r\nif (PCI_FUNC(pdev->devfn) != 1)\r\nreturn -ENODEV;\r\npci_read_config_word(pdev, SMBBANFORCE, &amd756_ioport);\r\namd756_ioport &= 0xfffc;\r\n} else {\r\nif (PCI_FUNC(pdev->devfn) != 3)\r\nreturn -ENODEV;\r\npci_read_config_byte(pdev, SMBGCFG, &temp);\r\nif ((temp & 128) == 0) {\r\ndev_err(&pdev->dev,\r\n"Error: SMBus controller I/O not enabled!\n");\r\nreturn -ENODEV;\r\n}\r\npci_read_config_word(pdev, SMBBA, &amd756_ioport);\r\namd756_ioport &= 0xff00;\r\namd756_ioport += SMB_ADDR_OFFSET;\r\n}\r\nerror = acpi_check_region(amd756_ioport, SMB_IOSIZE,\r\namd756_driver.name);\r\nif (error)\r\nreturn -ENODEV;\r\nif (!request_region(amd756_ioport, SMB_IOSIZE, amd756_driver.name)) {\r\ndev_err(&pdev->dev, "SMB region 0x%x already in use!\n",\r\namd756_ioport);\r\nreturn -ENODEV;\r\n}\r\npci_read_config_byte(pdev, SMBREV, &temp);\r\ndev_dbg(&pdev->dev, "SMBREV = 0x%X\n", temp);\r\ndev_dbg(&pdev->dev, "AMD756_smba = 0x%X\n", amd756_ioport);\r\namd756_smbus.dev.parent = &pdev->dev;\r\nsnprintf(amd756_smbus.name, sizeof(amd756_smbus.name),\r\n"SMBus %s adapter at %04x", chipname[id->driver_data],\r\namd756_ioport);\r\nerror = i2c_add_adapter(&amd756_smbus);\r\nif (error)\r\ngoto out_err;\r\nreturn 0;\r\nout_err:\r\nrelease_region(amd756_ioport, SMB_IOSIZE);\r\nreturn error;\r\n}\r\nstatic void amd756_remove(struct pci_dev *dev)\r\n{\r\ni2c_del_adapter(&amd756_smbus);\r\nrelease_region(amd756_ioport, SMB_IOSIZE);\r\n}

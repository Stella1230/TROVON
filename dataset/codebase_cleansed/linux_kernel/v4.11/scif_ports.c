static int __scif_get_port(int start, int end)\r\n{\r\nint id;\r\nstruct scif_port *port = kzalloc(sizeof(*port), GFP_ATOMIC);\r\nif (!port)\r\nreturn -ENOMEM;\r\nspin_lock(&scif_info.port_lock);\r\nid = idr_alloc(&scif_ports, port, start, end, GFP_ATOMIC);\r\nif (id >= 0)\r\nport->ref_cnt++;\r\nspin_unlock(&scif_info.port_lock);\r\nreturn id;\r\n}\r\nint scif_rsrv_port(u16 port)\r\n{\r\nreturn __scif_get_port(port, port + 1);\r\n}\r\nint scif_get_new_port(void)\r\n{\r\nreturn __scif_get_port(SCIF_PORT_RSVD + 1, SCIF_PORT_COUNT);\r\n}\r\nvoid scif_get_port(u16 id)\r\n{\r\nstruct scif_port *port;\r\nif (!id)\r\nreturn;\r\nspin_lock(&scif_info.port_lock);\r\nport = idr_find(&scif_ports, id);\r\nif (port)\r\nport->ref_cnt++;\r\nspin_unlock(&scif_info.port_lock);\r\n}\r\nvoid scif_put_port(u16 id)\r\n{\r\nstruct scif_port *port;\r\nif (!id)\r\nreturn;\r\nspin_lock(&scif_info.port_lock);\r\nport = idr_find(&scif_ports, id);\r\nif (port) {\r\nport->ref_cnt--;\r\nif (!port->ref_cnt) {\r\nidr_remove(&scif_ports, id);\r\nkfree(port);\r\n}\r\n}\r\nspin_unlock(&scif_info.port_lock);\r\n}

static inline struct clk_oxnas_gate *to_clk_oxnas_gate(struct clk_hw *hw)\r\n{\r\nreturn container_of(hw, struct clk_oxnas_gate, hw);\r\n}\r\nstatic int oxnas_clk_gate_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct clk_oxnas_gate *std = to_clk_oxnas_gate(hw);\r\nint ret;\r\nunsigned int val;\r\nret = regmap_read(std->regmap, CLK_STAT_REGOFFSET, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn val & BIT(std->bit);\r\n}\r\nstatic int oxnas_clk_gate_enable(struct clk_hw *hw)\r\n{\r\nstruct clk_oxnas_gate *std = to_clk_oxnas_gate(hw);\r\nregmap_write(std->regmap, CLK_SET_REGOFFSET, BIT(std->bit));\r\nreturn 0;\r\n}\r\nstatic void oxnas_clk_gate_disable(struct clk_hw *hw)\r\n{\r\nstruct clk_oxnas_gate *std = to_clk_oxnas_gate(hw);\r\nregmap_write(std->regmap, CLK_CLR_REGOFFSET, BIT(std->bit));\r\n}\r\nstatic int oxnas_stdclk_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nconst struct oxnas_stdclk_data *data;\r\nconst struct of_device_id *id;\r\nstruct regmap *regmap;\r\nint ret;\r\nint i;\r\nid = of_match_device(oxnas_stdclk_dt_ids, &pdev->dev);\r\nif (!id)\r\nreturn -ENODEV;\r\ndata = id->data;\r\nregmap = syscon_node_to_regmap(of_get_parent(np));\r\nif (IS_ERR(regmap)) {\r\ndev_err(&pdev->dev, "failed to have parent regmap\n");\r\nreturn PTR_ERR(regmap);\r\n}\r\nfor (i = 0 ; i < data->ngates ; ++i)\r\ndata->gates[i]->regmap = regmap;\r\nfor (i = 0; i < data->onecell_data->num; i++) {\r\nif (!data->onecell_data->hws[i])\r\ncontinue;\r\nret = devm_clk_hw_register(&pdev->dev,\r\ndata->onecell_data->hws[i]);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn of_clk_add_hw_provider(np, of_clk_hw_onecell_get,\r\ndata->onecell_data);\r\n}

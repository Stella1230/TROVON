static int intel_crc_pmic_get_power(struct regmap *regmap, int reg,\r\nint bit, u64 *value)\r\n{\r\nint data;\r\nif (regmap_read(regmap, reg, &data))\r\nreturn -EIO;\r\n*value = (data & PWR_SOURCE_SELECT) && (data & BIT(bit)) ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic int intel_crc_pmic_update_power(struct regmap *regmap, int reg,\r\nint bit, bool on)\r\n{\r\nint data;\r\nif (regmap_read(regmap, reg, &data))\r\nreturn -EIO;\r\nif (on) {\r\ndata |= PWR_SOURCE_SELECT | BIT(bit);\r\n} else {\r\ndata &= ~BIT(bit);\r\ndata |= PWR_SOURCE_SELECT;\r\n}\r\nif (regmap_write(regmap, reg, data))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int intel_crc_pmic_get_raw_temp(struct regmap *regmap, int reg)\r\n{\r\nint temp_l, temp_h;\r\nif (regmap_read(regmap, reg, &temp_l) ||\r\nregmap_read(regmap, reg - 1, &temp_h))\r\nreturn -EIO;\r\nreturn temp_l | (temp_h & 0x3) << 8;\r\n}\r\nstatic int intel_crc_pmic_update_aux(struct regmap *regmap, int reg, int raw)\r\n{\r\nreturn regmap_write(regmap, reg, raw) ||\r\nregmap_update_bits(regmap, reg - 1, 0x3, raw >> 8) ? -EIO : 0;\r\n}\r\nstatic int intel_crc_pmic_get_policy(struct regmap *regmap,\r\nint reg, int bit, u64 *value)\r\n{\r\nint pen;\r\nif (regmap_read(regmap, reg, &pen))\r\nreturn -EIO;\r\n*value = pen >> 7;\r\nreturn 0;\r\n}\r\nstatic int intel_crc_pmic_update_policy(struct regmap *regmap,\r\nint reg, int bit, int enable)\r\n{\r\nint alert0;\r\nif (regmap_read(regmap, PMIC_A0LOCK_REG, &alert0))\r\nreturn -EIO;\r\nif (regmap_update_bits(regmap, PMIC_A0LOCK_REG, 0x01, 0))\r\nreturn -EIO;\r\nif (regmap_update_bits(regmap, reg, 0x80, enable << 7))\r\nreturn -EIO;\r\nif (regmap_write(regmap, PMIC_A0LOCK_REG, alert0))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int intel_crc_pmic_opregion_probe(struct platform_device *pdev)\r\n{\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(pdev->dev.parent);\r\nreturn intel_pmic_install_opregion_handler(&pdev->dev,\r\nACPI_HANDLE(pdev->dev.parent), pmic->regmap,\r\n&intel_crc_pmic_opregion_data);\r\n}\r\nstatic int __init intel_crc_pmic_opregion_driver_init(void)\r\n{\r\nreturn platform_driver_register(&intel_crc_pmic_opregion_driver);\r\n}

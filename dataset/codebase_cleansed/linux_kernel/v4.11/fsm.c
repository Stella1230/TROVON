void\r\nmISDN_FsmNew(struct Fsm *fsm,\r\nstruct FsmNode *fnlist, int fncount)\r\n{\r\nint i;\r\nfsm->jumpmatrix = kzalloc(sizeof(FSMFNPTR) * fsm->state_count *\r\nfsm->event_count, GFP_KERNEL);\r\nfor (i = 0; i < fncount; i++)\r\nif ((fnlist[i].state >= fsm->state_count) ||\r\n(fnlist[i].event >= fsm->event_count)) {\r\nprintk(KERN_ERR\r\n"mISDN_FsmNew Error: %d st(%ld/%ld) ev(%ld/%ld)\n",\r\ni, (long)fnlist[i].state, (long)fsm->state_count,\r\n(long)fnlist[i].event, (long)fsm->event_count);\r\n} else\r\nfsm->jumpmatrix[fsm->state_count * fnlist[i].event +\r\nfnlist[i].state] = (FSMFNPTR) fnlist[i].routine;\r\n}\r\nvoid\r\nmISDN_FsmFree(struct Fsm *fsm)\r\n{\r\nkfree((void *) fsm->jumpmatrix);\r\n}\r\nint\r\nmISDN_FsmEvent(struct FsmInst *fi, int event, void *arg)\r\n{\r\nFSMFNPTR r;\r\nif ((fi->state >= fi->fsm->state_count) ||\r\n(event >= fi->fsm->event_count)) {\r\nprintk(KERN_ERR\r\n"mISDN_FsmEvent Error st(%ld/%ld) ev(%d/%ld)\n",\r\n(long)fi->state, (long)fi->fsm->state_count, event,\r\n(long)fi->fsm->event_count);\r\nreturn 1;\r\n}\r\nr = fi->fsm->jumpmatrix[fi->fsm->state_count * event + fi->state];\r\nif (r) {\r\nif (fi->debug)\r\nfi->printdebug(fi, "State %s Event %s",\r\nfi->fsm->strState[fi->state],\r\nfi->fsm->strEvent[event]);\r\nr(fi, event, arg);\r\nreturn 0;\r\n} else {\r\nif (fi->debug)\r\nfi->printdebug(fi, "State %s Event %s no action",\r\nfi->fsm->strState[fi->state],\r\nfi->fsm->strEvent[event]);\r\nreturn 1;\r\n}\r\n}\r\nvoid\r\nmISDN_FsmChangeState(struct FsmInst *fi, int newstate)\r\n{\r\nfi->state = newstate;\r\nif (fi->debug)\r\nfi->printdebug(fi, "ChangeState %s",\r\nfi->fsm->strState[newstate]);\r\n}\r\nstatic void\r\nFsmExpireTimer(struct FsmTimer *ft)\r\n{\r\n#if FSM_TIMER_DEBUG\r\nif (ft->fi->debug)\r\nft->fi->printdebug(ft->fi, "FsmExpireTimer %lx", (long) ft);\r\n#endif\r\nmISDN_FsmEvent(ft->fi, ft->event, ft->arg);\r\n}\r\nvoid\r\nmISDN_FsmInitTimer(struct FsmInst *fi, struct FsmTimer *ft)\r\n{\r\nft->fi = fi;\r\nft->tl.function = (void *) FsmExpireTimer;\r\nft->tl.data = (long) ft;\r\n#if FSM_TIMER_DEBUG\r\nif (ft->fi->debug)\r\nft->fi->printdebug(ft->fi, "mISDN_FsmInitTimer %lx", (long) ft);\r\n#endif\r\ninit_timer(&ft->tl);\r\n}\r\nvoid\r\nmISDN_FsmDelTimer(struct FsmTimer *ft, int where)\r\n{\r\n#if FSM_TIMER_DEBUG\r\nif (ft->fi->debug)\r\nft->fi->printdebug(ft->fi, "mISDN_FsmDelTimer %lx %d",\r\n(long) ft, where);\r\n#endif\r\ndel_timer(&ft->tl);\r\n}\r\nint\r\nmISDN_FsmAddTimer(struct FsmTimer *ft,\r\nint millisec, int event, void *arg, int where)\r\n{\r\n#if FSM_TIMER_DEBUG\r\nif (ft->fi->debug)\r\nft->fi->printdebug(ft->fi, "mISDN_FsmAddTimer %lx %d %d",\r\n(long) ft, millisec, where);\r\n#endif\r\nif (timer_pending(&ft->tl)) {\r\nif (ft->fi->debug) {\r\nprintk(KERN_WARNING\r\n"mISDN_FsmAddTimer: timer already active!\n");\r\nft->fi->printdebug(ft->fi,\r\n"mISDN_FsmAddTimer already active!");\r\n}\r\nreturn -1;\r\n}\r\ninit_timer(&ft->tl);\r\nft->event = event;\r\nft->arg = arg;\r\nft->tl.expires = jiffies + (millisec * HZ) / 1000;\r\nadd_timer(&ft->tl);\r\nreturn 0;\r\n}\r\nvoid\r\nmISDN_FsmRestartTimer(struct FsmTimer *ft,\r\nint millisec, int event, void *arg, int where)\r\n{\r\n#if FSM_TIMER_DEBUG\r\nif (ft->fi->debug)\r\nft->fi->printdebug(ft->fi, "mISDN_FsmRestartTimer %lx %d %d",\r\n(long) ft, millisec, where);\r\n#endif\r\nif (timer_pending(&ft->tl))\r\ndel_timer(&ft->tl);\r\ninit_timer(&ft->tl);\r\nft->event = event;\r\nft->arg = arg;\r\nft->tl.expires = jiffies + (millisec * HZ) / 1000;\r\nadd_timer(&ft->tl);\r\n}

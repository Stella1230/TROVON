static int menf21bmc_wdt_exit_prod_mode(struct i2c_client *client)\r\n{\r\nint val, ret;\r\nval = i2c_smbus_read_byte_data(client, BMC_CMD_WDT_PROD_STAT);\r\nif (val < 0)\r\nreturn val;\r\nif (val == 0x00) {\r\ndev_info(&client->dev,\r\n"BMC in production mode. Exit production mode\n");\r\nret = i2c_smbus_write_byte(client, BMC_CMD_WDT_EXIT_PROD);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nmenf21bmc_probe(struct i2c_client *client, const struct i2c_device_id *ids)\r\n{\r\nint rev_major, rev_minor, rev_main;\r\nint ret;\r\nret = i2c_check_functionality(client->adapter,\r\nI2C_FUNC_SMBUS_BYTE_DATA |\r\nI2C_FUNC_SMBUS_WORD_DATA |\r\nI2C_FUNC_SMBUS_BYTE);\r\nif (!ret)\r\nreturn -ENODEV;\r\nrev_major = i2c_smbus_read_word_data(client, BMC_CMD_REV_MAJOR);\r\nif (rev_major < 0) {\r\ndev_err(&client->dev, "failed to get BMC major revision\n");\r\nreturn rev_major;\r\n}\r\nrev_minor = i2c_smbus_read_word_data(client, BMC_CMD_REV_MINOR);\r\nif (rev_minor < 0) {\r\ndev_err(&client->dev, "failed to get BMC minor revision\n");\r\nreturn rev_minor;\r\n}\r\nrev_main = i2c_smbus_read_word_data(client, BMC_CMD_REV_MAIN);\r\nif (rev_main < 0) {\r\ndev_err(&client->dev, "failed to get BMC main revision\n");\r\nreturn rev_main;\r\n}\r\ndev_info(&client->dev, "FW Revision: %02d.%02d.%02d\n",\r\nrev_major, rev_minor, rev_main);\r\nret = menf21bmc_wdt_exit_prod_mode(client);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "failed to leave production mode\n");\r\nreturn ret;\r\n}\r\nret = devm_mfd_add_devices(&client->dev, 0, menf21bmc_cell,\r\nARRAY_SIZE(menf21bmc_cell), NULL, 0, NULL);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "failed to add BMC sub-devices\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

void irq_poll_sched(struct irq_poll *iop)\r\n{\r\nunsigned long flags;\r\nif (test_bit(IRQ_POLL_F_DISABLE, &iop->state))\r\nreturn;\r\nif (test_and_set_bit(IRQ_POLL_F_SCHED, &iop->state))\r\nreturn;\r\nlocal_irq_save(flags);\r\nlist_add_tail(&iop->list, this_cpu_ptr(&blk_cpu_iopoll));\r\n__raise_softirq_irqoff(IRQ_POLL_SOFTIRQ);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void __irq_poll_complete(struct irq_poll *iop)\r\n{\r\nlist_del(&iop->list);\r\nsmp_mb__before_atomic();\r\nclear_bit_unlock(IRQ_POLL_F_SCHED, &iop->state);\r\n}\r\nvoid irq_poll_complete(struct irq_poll *iop)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\n__irq_poll_complete(iop);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void __latent_entropy irq_poll_softirq(struct softirq_action *h)\r\n{\r\nstruct list_head *list = this_cpu_ptr(&blk_cpu_iopoll);\r\nint rearm = 0, budget = irq_poll_budget;\r\nunsigned long start_time = jiffies;\r\nlocal_irq_disable();\r\nwhile (!list_empty(list)) {\r\nstruct irq_poll *iop;\r\nint work, weight;\r\nif (budget <= 0 || time_after(jiffies, start_time)) {\r\nrearm = 1;\r\nbreak;\r\n}\r\nlocal_irq_enable();\r\niop = list_entry(list->next, struct irq_poll, list);\r\nweight = iop->weight;\r\nwork = 0;\r\nif (test_bit(IRQ_POLL_F_SCHED, &iop->state))\r\nwork = iop->poll(iop, weight);\r\nbudget -= work;\r\nlocal_irq_disable();\r\nif (work >= weight) {\r\nif (test_bit(IRQ_POLL_F_DISABLE, &iop->state))\r\n__irq_poll_complete(iop);\r\nelse\r\nlist_move_tail(&iop->list, list);\r\n}\r\n}\r\nif (rearm)\r\n__raise_softirq_irqoff(IRQ_POLL_SOFTIRQ);\r\nlocal_irq_enable();\r\n}\r\nvoid irq_poll_disable(struct irq_poll *iop)\r\n{\r\nset_bit(IRQ_POLL_F_DISABLE, &iop->state);\r\nwhile (test_and_set_bit(IRQ_POLL_F_SCHED, &iop->state))\r\nmsleep(1);\r\nclear_bit(IRQ_POLL_F_DISABLE, &iop->state);\r\n}\r\nvoid irq_poll_enable(struct irq_poll *iop)\r\n{\r\nBUG_ON(!test_bit(IRQ_POLL_F_SCHED, &iop->state));\r\nsmp_mb__before_atomic();\r\nclear_bit_unlock(IRQ_POLL_F_SCHED, &iop->state);\r\n}\r\nvoid irq_poll_init(struct irq_poll *iop, int weight, irq_poll_fn *poll_fn)\r\n{\r\nmemset(iop, 0, sizeof(*iop));\r\nINIT_LIST_HEAD(&iop->list);\r\niop->weight = weight;\r\niop->poll = poll_fn;\r\n}\r\nstatic int irq_poll_cpu_dead(unsigned int cpu)\r\n{\r\nlocal_irq_disable();\r\nlist_splice_init(&per_cpu(blk_cpu_iopoll, cpu),\r\nthis_cpu_ptr(&blk_cpu_iopoll));\r\n__raise_softirq_irqoff(IRQ_POLL_SOFTIRQ);\r\nlocal_irq_enable();\r\nreturn 0;\r\n}\r\nstatic __init int irq_poll_setup(void)\r\n{\r\nint i;\r\nfor_each_possible_cpu(i)\r\nINIT_LIST_HEAD(&per_cpu(blk_cpu_iopoll, i));\r\nopen_softirq(IRQ_POLL_SOFTIRQ, irq_poll_softirq);\r\ncpuhp_setup_state_nocalls(CPUHP_IRQ_POLL_DEAD, "irq_poll:dead", NULL,\r\nirq_poll_cpu_dead);\r\nreturn 0;\r\n}

static uint8_t __init cvmx_fuse_read_byte(int byte_addr)\r\n{\r\nunion cvmx_mio_fus_rcmd read_cmd;\r\nread_cmd.u64 = 0;\r\nread_cmd.s.addr = byte_addr;\r\nread_cmd.s.pend = 1;\r\ncvmx_write_csr(CVMX_MIO_FUS_RCMD, read_cmd.u64);\r\nwhile ((read_cmd.u64 = cvmx_read_csr(CVMX_MIO_FUS_RCMD))\r\n&& read_cmd.s.pend)\r\n;\r\nreturn read_cmd.s.dat;\r\n}\r\nstatic const char *__init octeon_model_get_string_buffer(uint32_t chip_id,\r\nchar *buffer)\r\n{\r\nconst char *family;\r\nconst char *core_model;\r\nchar pass[4];\r\nint clock_mhz;\r\nconst char *suffix;\r\nunion cvmx_l2d_fus3 fus3;\r\nint num_cores;\r\nunion cvmx_mio_fus_dat2 fus_dat2;\r\nunion cvmx_mio_fus_dat3 fus_dat3;\r\nchar fuse_model[10];\r\nuint32_t fuse_data = 0;\r\nfus3.u64 = 0;\r\nif (OCTEON_IS_MODEL(OCTEON_CN3XXX) || OCTEON_IS_MODEL(OCTEON_CN5XXX))\r\nfus3.u64 = cvmx_read_csr(CVMX_L2D_FUS3);\r\nfus_dat2.u64 = cvmx_read_csr(CVMX_MIO_FUS_DAT2);\r\nfus_dat3.u64 = cvmx_read_csr(CVMX_MIO_FUS_DAT3);\r\nnum_cores = cvmx_octeon_num_cores();\r\nswitch ((chip_id >> 8) & 0xff) {\r\ncase 6:\r\ncase 2:\r\nfus_dat3.s.nodfa_dte = 1;\r\nfus_dat3.s.nozip = 1;\r\nbreak;\r\ncase 4:\r\nfus_dat3.s.nodfa_dte = 1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (fus_dat3.s.nodfa_dte) {\r\nif (fus_dat2.s.nocrypto)\r\nsuffix = "CP";\r\nelse\r\nsuffix = "SCP";\r\n} else if (fus_dat2.s.nocrypto)\r\nsuffix = "EXP";\r\nelse\r\nsuffix = "NSP";\r\nif (!fus_dat2.s.nocrypto)\r\n__octeon_feature_bits |= OCTEON_HAS_CRYPTO;\r\nsprintf(pass, "%d.%d", (int)((chip_id >> 3) & 7) + 1, (int)chip_id & 7);\r\nswitch (num_cores) {\r\ncase 48:\r\ncore_model = "90";\r\nbreak;\r\ncase 44:\r\ncore_model = "88";\r\nbreak;\r\ncase 40:\r\ncore_model = "85";\r\nbreak;\r\ncase 32:\r\ncore_model = "80";\r\nbreak;\r\ncase 24:\r\ncore_model = "70";\r\nbreak;\r\ncase 16:\r\ncore_model = "60";\r\nbreak;\r\ncase 15:\r\ncore_model = "58";\r\nbreak;\r\ncase 14:\r\ncore_model = "55";\r\nbreak;\r\ncase 13:\r\ncore_model = "52";\r\nbreak;\r\ncase 12:\r\ncore_model = "50";\r\nbreak;\r\ncase 11:\r\ncore_model = "48";\r\nbreak;\r\ncase 10:\r\ncore_model = "45";\r\nbreak;\r\ncase 9:\r\ncore_model = "42";\r\nbreak;\r\ncase 8:\r\ncore_model = "40";\r\nbreak;\r\ncase 7:\r\ncore_model = "38";\r\nbreak;\r\ncase 6:\r\ncore_model = "34";\r\nbreak;\r\ncase 5:\r\ncore_model = "32";\r\nbreak;\r\ncase 4:\r\ncore_model = "30";\r\nbreak;\r\ncase 3:\r\ncore_model = "25";\r\nbreak;\r\ncase 2:\r\ncore_model = "20";\r\nbreak;\r\ncase 1:\r\ncore_model = "10";\r\nbreak;\r\ndefault:\r\ncore_model = "XX";\r\nbreak;\r\n}\r\nswitch ((chip_id >> 8) & 0xff) {\r\ncase 0:\r\nif (fus3.cn38xx.crip_512k) {\r\nif (num_cores >= 16)\r\nfamily = "37";\r\nelse\r\nfamily = "36";\r\n} else\r\nfamily = "38";\r\nswitch (chip_id & 0xf) {\r\ncase 0:\r\nstrcpy(pass, "1.X");\r\nbreak;\r\ncase 1:\r\nstrcpy(pass, "2.X");\r\nbreak;\r\ncase 3:\r\nstrcpy(pass, "3.X");\r\nbreak;\r\ndefault:\r\nstrcpy(pass, "X.X");\r\nbreak;\r\n}\r\nbreak;\r\ncase 1:\r\nif ((chip_id & 0x10) || fus3.cn31xx.crip_128k)\r\nfamily = "30";\r\nelse\r\nfamily = "31";\r\nswitch (chip_id & 0xf) {\r\ncase 0:\r\nstrcpy(pass, "1.0");\r\nbreak;\r\ncase 2:\r\nstrcpy(pass, "1.1");\r\nbreak;\r\ndefault:\r\nstrcpy(pass, "X.X");\r\nbreak;\r\n}\r\nbreak;\r\ncase 2:\r\nfamily = "30";\r\nif (fus3.cn30xx.crip_64k)\r\ncore_model = "05";\r\nswitch (chip_id & 0xf) {\r\ncase 0:\r\nstrcpy(pass, "1.0");\r\nbreak;\r\ncase 2:\r\nstrcpy(pass, "1.1");\r\nbreak;\r\ndefault:\r\nstrcpy(pass, "X.X");\r\nbreak;\r\n}\r\nbreak;\r\ncase 3:\r\nfamily = "58";\r\nif ((num_cores == 4) && fus3.cn58xx.crip_1024k && !strncmp(suffix, "CP", 2))\r\ncore_model = "29";\r\nif ((chip_id & 0xFF) < 0x8) {\r\nswitch (chip_id & 0x3) {\r\ncase 0:\r\nstrcpy(pass, "1.0");\r\nbreak;\r\ncase 1:\r\nstrcpy(pass, "1.1");\r\nbreak;\r\ncase 3:\r\nstrcpy(pass, "1.2");\r\nbreak;\r\ndefault:\r\nstrcpy(pass, "1.X");\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ncase 4:\r\nif (fus_dat2.cn56xx.raid_en) {\r\nif (fus3.cn56xx.crip_1024k)\r\nfamily = "55";\r\nelse\r\nfamily = "57";\r\nif (fus_dat2.cn56xx.nocrypto)\r\nsuffix = "SP";\r\nelse\r\nsuffix = "SSP";\r\n} else {\r\nif (fus_dat2.cn56xx.nocrypto)\r\nsuffix = "CP";\r\nelse {\r\nsuffix = "NSP";\r\nif (fus_dat3.s.nozip)\r\nsuffix = "SCP";\r\nif (fus_dat3.cn56xx.bar2_en)\r\nsuffix = "NSPB2";\r\n}\r\nif (fus3.cn56xx.crip_1024k)\r\nfamily = "54";\r\nelse\r\nfamily = "56";\r\n}\r\nbreak;\r\ncase 6:\r\nfamily = "50";\r\nbreak;\r\ncase 7:\r\nif (fus3.cn52xx.crip_256k)\r\nfamily = "51";\r\nelse\r\nfamily = "52";\r\nbreak;\r\ncase 0x93:\r\nfamily = "61";\r\nif (fus_dat2.cn61xx.nocrypto && fus_dat2.cn61xx.dorm_crypto)\r\nsuffix = "AP";\r\nif (fus_dat2.cn61xx.nocrypto)\r\nsuffix = "CP";\r\nelse if (fus_dat2.cn61xx.dorm_crypto)\r\nsuffix = "DAP";\r\nelse if (fus_dat3.cn61xx.nozip)\r\nsuffix = "SCP";\r\nbreak;\r\ncase 0x90:\r\nfamily = "63";\r\nif (fus_dat3.s.l2c_crip == 2)\r\nfamily = "62";\r\nif (num_cores == 6)\r\ncore_model = "35";\r\nif (fus_dat2.cn63xx.nocrypto)\r\nsuffix = "CP";\r\nelse if (fus_dat2.cn63xx.dorm_crypto)\r\nsuffix = "DAP";\r\nelse if (fus_dat3.cn63xx.nozip)\r\nsuffix = "SCP";\r\nelse\r\nsuffix = "AAP";\r\nbreak;\r\ncase 0x92:\r\nfamily = "66";\r\nif (num_cores == 6)\r\ncore_model = "35";\r\nif (fus_dat2.cn66xx.nocrypto && fus_dat2.cn66xx.dorm_crypto)\r\nsuffix = "AP";\r\nif (fus_dat2.cn66xx.nocrypto)\r\nsuffix = "CP";\r\nelse if (fus_dat2.cn66xx.dorm_crypto)\r\nsuffix = "DAP";\r\nelse if (fus_dat3.cn66xx.nozip)\r\nsuffix = "SCP";\r\nelse\r\nsuffix = "AAP";\r\nbreak;\r\ncase 0x91:\r\nfamily = "68";\r\nif (fus_dat2.cn68xx.nocrypto && fus_dat3.cn68xx.nozip)\r\nsuffix = "CP";\r\nelse if (fus_dat2.cn68xx.dorm_crypto)\r\nsuffix = "DAP";\r\nelse if (fus_dat3.cn68xx.nozip)\r\nsuffix = "SCP";\r\nelse if (fus_dat2.cn68xx.nocrypto)\r\nsuffix = "SP";\r\nelse\r\nsuffix = "AAP";\r\nbreak;\r\ncase 0x94:\r\nfamily = "F71";\r\nif (fus_dat3.cnf71xx.nozip)\r\nsuffix = "SCP";\r\nelse\r\nsuffix = "AAP";\r\nbreak;\r\ncase 0x95:\r\nif (num_cores == 6)\r\ncore_model = "35";\r\nif (OCTEON_IS_MODEL(OCTEON_CN76XX))\r\nfamily = "76";\r\nelse\r\nfamily = "78";\r\nif (fus_dat3.cn78xx.l2c_crip == 2)\r\nfamily = "77";\r\nif (fus_dat3.cn78xx.nozip\r\n&& fus_dat3.cn78xx.nodfa_dte\r\n&& fus_dat3.cn78xx.nohna_dte) {\r\nif (fus_dat3.cn78xx.nozip &&\r\n!fus_dat2.cn78xx.raid_en &&\r\nfus_dat3.cn78xx.nohna_dte) {\r\nsuffix = "CP";\r\n} else {\r\nsuffix = "SCP";\r\n}\r\n} else if (fus_dat2.cn78xx.raid_en == 0)\r\nsuffix = "HCP";\r\nelse\r\nsuffix = "AAP";\r\nbreak;\r\ncase 0x96:\r\nfamily = "70";\r\nif (cvmx_read_csr(CVMX_MIO_FUS_PDF) & (0x1ULL << 32))\r\nfamily = "71";\r\nif (fus_dat2.cn70xx.nocrypto)\r\nsuffix = "CP";\r\nelse if (fus_dat3.cn70xx.nodfa_dte)\r\nsuffix = "SCP";\r\nelse\r\nsuffix = "AAP";\r\nbreak;\r\ncase 0x97:\r\nif (num_cores == 6)\r\ncore_model = "35";\r\nfamily = "73";\r\nif (fus_dat3.cn73xx.l2c_crip == 2)\r\nfamily = "72";\r\nif (fus_dat3.cn73xx.nozip\r\n&& fus_dat3.cn73xx.nodfa_dte\r\n&& fus_dat3.cn73xx.nohna_dte) {\r\nif (!fus_dat2.cn73xx.raid_en)\r\nsuffix = "CP";\r\nelse\r\nsuffix = "SCP";\r\n} else\r\nsuffix = "AAP";\r\nbreak;\r\ncase 0x98:\r\nfamily = "F75";\r\nif (fus_dat3.cn78xx.nozip\r\n&& fus_dat3.cn78xx.nodfa_dte\r\n&& fus_dat3.cn78xx.nohna_dte)\r\nsuffix = "SCP";\r\nelse\r\nsuffix = "AAP";\r\nbreak;\r\ndefault:\r\nfamily = "XX";\r\ncore_model = "XX";\r\nstrcpy(pass, "X.X");\r\nsuffix = "XXX";\r\nbreak;\r\n}\r\nclock_mhz = octeon_get_clock_rate() / 1000000;\r\nif (family[0] != '3') {\r\nint fuse_base = 384 / 8;\r\nif (family[0] == '6')\r\nfuse_base = 832 / 8;\r\nfuse_data |= cvmx_fuse_read_byte(fuse_base + 3);\r\nfuse_data = fuse_data << 8;\r\nfuse_data |= cvmx_fuse_read_byte(fuse_base + 2);\r\nfuse_data = fuse_data << 8;\r\nfuse_data |= cvmx_fuse_read_byte(fuse_base + 1);\r\nfuse_data = fuse_data << 8;\r\nfuse_data |= cvmx_fuse_read_byte(fuse_base);\r\nif (fuse_data & 0x7ffff) {\r\nint model = fuse_data & 0x3fff;\r\nint suffix = (fuse_data >> 14) & 0x1f;\r\nif (suffix && model) {\r\nsprintf(fuse_model, "%d%c", model, 'A' + suffix - 1);\r\ncore_model = "";\r\nfamily = fuse_model;\r\n} else if (suffix && !model) {\r\nsprintf(fuse_model, "%s%c", core_model, 'A' + suffix - 1);\r\ncore_model = fuse_model;\r\n} else {\r\nsprintf(fuse_model, "%d", model);\r\ncore_model = "";\r\nfamily = fuse_model;\r\n}\r\n}\r\n}\r\nsprintf(buffer, "CN%s%sp%s-%d-%s", family, core_model, pass, clock_mhz, suffix);\r\nreturn buffer;\r\n}\r\nconst char *__init octeon_model_get_string(uint32_t chip_id)\r\n{\r\nstatic char buffer[32];\r\nreturn octeon_model_get_string_buffer(chip_id, buffer);\r\n}

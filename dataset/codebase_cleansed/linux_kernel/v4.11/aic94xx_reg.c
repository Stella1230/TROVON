static void asd_write_byte(struct asd_ha_struct *asd_ha,\r\nunsigned long offs, u8 val)\r\n{\r\nif (unlikely(asd_ha->iospace))\r\noutb(val,\r\n(unsigned long)asd_ha->io_handle[0].addr + (offs & 0xFF));\r\nelse\r\nwriteb(val, asd_ha->io_handle[0].addr + offs);\r\nwmb();\r\n}\r\nstatic void asd_write_word(struct asd_ha_struct *asd_ha,\r\nunsigned long offs, u16 val)\r\n{\r\nif (unlikely(asd_ha->iospace))\r\noutw(val,\r\n(unsigned long)asd_ha->io_handle[0].addr + (offs & 0xFF));\r\nelse\r\nwritew(val, asd_ha->io_handle[0].addr + offs);\r\nwmb();\r\n}\r\nstatic void asd_write_dword(struct asd_ha_struct *asd_ha,\r\nunsigned long offs, u32 val)\r\n{\r\nif (unlikely(asd_ha->iospace))\r\noutl(val,\r\n(unsigned long)asd_ha->io_handle[0].addr + (offs & 0xFF));\r\nelse\r\nwritel(val, asd_ha->io_handle[0].addr + offs);\r\nwmb();\r\n}\r\nstatic u8 asd_read_byte(struct asd_ha_struct *asd_ha, unsigned long offs)\r\n{\r\nu8 val;\r\nif (unlikely(asd_ha->iospace))\r\nval = inb((unsigned long) asd_ha->io_handle[0].addr\r\n+ (offs & 0xFF));\r\nelse\r\nval = readb(asd_ha->io_handle[0].addr + offs);\r\nrmb();\r\nreturn val;\r\n}\r\nstatic u16 asd_read_word(struct asd_ha_struct *asd_ha,\r\nunsigned long offs)\r\n{\r\nu16 val;\r\nif (unlikely(asd_ha->iospace))\r\nval = inw((unsigned long)asd_ha->io_handle[0].addr\r\n+ (offs & 0xFF));\r\nelse\r\nval = readw(asd_ha->io_handle[0].addr + offs);\r\nrmb();\r\nreturn val;\r\n}\r\nstatic u32 asd_read_dword(struct asd_ha_struct *asd_ha,\r\nunsigned long offs)\r\n{\r\nu32 val;\r\nif (unlikely(asd_ha->iospace))\r\nval = inl((unsigned long) asd_ha->io_handle[0].addr\r\n+ (offs & 0xFF));\r\nelse\r\nval = readl(asd_ha->io_handle[0].addr + offs);\r\nrmb();\r\nreturn val;\r\n}\r\nstatic inline u32 asd_mem_offs_swa(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline u32 asd_mem_offs_swc(void)\r\n{\r\nreturn asd_mem_offs_swa() + MBAR0_SWA_SIZE;\r\n}\r\nstatic inline u32 asd_mem_offs_swb(void)\r\n{\r\nreturn asd_mem_offs_swc() + MBAR0_SWC_SIZE + 0x20;\r\n}\r\nstatic void asd_move_swb(struct asd_ha_struct *asd_ha, u32 reg)\r\n{\r\nu32 base = reg & ~(MBAR0_SWB_SIZE-1);\r\npci_write_config_dword(asd_ha->pcidev, PCI_CONF_MBAR0_SWB, base);\r\nasd_ha->io_handle[0].swb_base = base;\r\n}\r\nstatic void __asd_write_reg_byte(struct asd_ha_struct *asd_ha, u32 reg, u8 val)\r\n{\r\nstruct asd_ha_addrspace *io_handle=&asd_ha->io_handle[0];\r\nBUG_ON(reg >= 0xC0000000 || reg < ALL_BASE_ADDR);\r\nif (io_handle->swa_base <= reg\r\n&& reg < io_handle->swa_base + MBAR0_SWA_SIZE)\r\nasd_write_swa_byte (asd_ha, reg,val);\r\nelse if (io_handle->swb_base <= reg\r\n&& reg < io_handle->swb_base + MBAR0_SWB_SIZE)\r\nasd_write_swb_byte (asd_ha, reg, val);\r\nelse if (io_handle->swc_base <= reg\r\n&& reg < io_handle->swc_base + MBAR0_SWC_SIZE)\r\nasd_write_swc_byte (asd_ha, reg, val);\r\nelse {\r\nasd_move_swb(asd_ha, reg);\r\nasd_write_swb_byte (asd_ha, reg, val);\r\n}\r\n}\r\nstatic u8 __asd_read_reg_byte(struct asd_ha_struct *asd_ha, u32 reg)\r\n{\r\nstruct asd_ha_addrspace *io_handle=&asd_ha->io_handle[0];\r\nu8 val;\r\nBUG_ON(reg >= 0xC0000000 || reg < ALL_BASE_ADDR);\r\nif (io_handle->swa_base <= reg\r\n&& reg < io_handle->swa_base + MBAR0_SWA_SIZE)\r\nval = asd_read_swa_byte (asd_ha, reg);\r\nelse if (io_handle->swb_base <= reg\r\n&& reg < io_handle->swb_base + MBAR0_SWB_SIZE)\r\nval = asd_read_swb_byte (asd_ha, reg);\r\nelse if (io_handle->swc_base <= reg\r\n&& reg < io_handle->swc_base + MBAR0_SWC_SIZE)\r\nval = asd_read_swc_byte (asd_ha, reg);\r\nelse {\r\nasd_move_swb(asd_ha, reg);\r\nval = asd_read_swb_byte (asd_ha, reg);\r\n}\r\nreturn val;\r\n}\r\nvoid asd_read_reg_string(struct asd_ha_struct *asd_ha, void *dst,\r\nu32 offs, int count)\r\n{\r\nu8 *p = dst;\r\nunsigned long flags;\r\nspin_lock_irqsave(&asd_ha->iolock, flags);\r\nfor ( ; count > 0; count--, offs++, p++)\r\n*p = __asd_read_reg_byte(asd_ha, offs);\r\nspin_unlock_irqrestore(&asd_ha->iolock, flags);\r\n}\r\nvoid asd_write_reg_string(struct asd_ha_struct *asd_ha, void *src,\r\nu32 offs, int count)\r\n{\r\nu8 *p = src;\r\nunsigned long flags;\r\nspin_lock_irqsave(&asd_ha->iolock, flags);\r\nfor ( ; count > 0; count--, offs++, p++)\r\n__asd_write_reg_byte(asd_ha, offs, *p);\r\nspin_unlock_irqrestore(&asd_ha->iolock, flags);\r\n}

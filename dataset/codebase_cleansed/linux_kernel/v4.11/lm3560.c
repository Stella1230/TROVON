static int lm3560_mode_ctrl(struct lm3560_flash *flash)\r\n{\r\nint rval = -EINVAL;\r\nswitch (flash->led_mode) {\r\ncase V4L2_FLASH_LED_MODE_NONE:\r\nrval = regmap_update_bits(flash->regmap,\r\nREG_ENABLE, 0x03, MODE_SHDN);\r\nbreak;\r\ncase V4L2_FLASH_LED_MODE_TORCH:\r\nrval = regmap_update_bits(flash->regmap,\r\nREG_ENABLE, 0x03, MODE_TORCH);\r\nbreak;\r\ncase V4L2_FLASH_LED_MODE_FLASH:\r\nrval = regmap_update_bits(flash->regmap,\r\nREG_ENABLE, 0x03, MODE_FLASH);\r\nbreak;\r\n}\r\nreturn rval;\r\n}\r\nstatic int lm3560_enable_ctrl(struct lm3560_flash *flash,\r\nenum lm3560_led_id led_no, bool on)\r\n{\r\nint rval;\r\nif (led_no == LM3560_LED0) {\r\nif (on)\r\nrval = regmap_update_bits(flash->regmap,\r\nREG_ENABLE, 0x08, 0x08);\r\nelse\r\nrval = regmap_update_bits(flash->regmap,\r\nREG_ENABLE, 0x08, 0x00);\r\n} else {\r\nif (on)\r\nrval = regmap_update_bits(flash->regmap,\r\nREG_ENABLE, 0x10, 0x10);\r\nelse\r\nrval = regmap_update_bits(flash->regmap,\r\nREG_ENABLE, 0x10, 0x00);\r\n}\r\nreturn rval;\r\n}\r\nstatic int lm3560_torch_brt_ctrl(struct lm3560_flash *flash,\r\nenum lm3560_led_id led_no, unsigned int brt)\r\n{\r\nint rval;\r\nu8 br_bits;\r\nif (brt < LM3560_TORCH_BRT_MIN)\r\nreturn lm3560_enable_ctrl(flash, led_no, false);\r\nelse\r\nrval = lm3560_enable_ctrl(flash, led_no, true);\r\nbr_bits = LM3560_TORCH_BRT_uA_TO_REG(brt);\r\nif (led_no == LM3560_LED0)\r\nrval = regmap_update_bits(flash->regmap,\r\nREG_TORCH_BR, 0x07, br_bits);\r\nelse\r\nrval = regmap_update_bits(flash->regmap,\r\nREG_TORCH_BR, 0x38, br_bits << 3);\r\nreturn rval;\r\n}\r\nstatic int lm3560_flash_brt_ctrl(struct lm3560_flash *flash,\r\nenum lm3560_led_id led_no, unsigned int brt)\r\n{\r\nint rval;\r\nu8 br_bits;\r\nif (brt < LM3560_FLASH_BRT_MIN)\r\nreturn lm3560_enable_ctrl(flash, led_no, false);\r\nelse\r\nrval = lm3560_enable_ctrl(flash, led_no, true);\r\nbr_bits = LM3560_FLASH_BRT_uA_TO_REG(brt);\r\nif (led_no == LM3560_LED0)\r\nrval = regmap_update_bits(flash->regmap,\r\nREG_FLASH_BR, 0x0f, br_bits);\r\nelse\r\nrval = regmap_update_bits(flash->regmap,\r\nREG_FLASH_BR, 0xf0, br_bits << 4);\r\nreturn rval;\r\n}\r\nstatic int lm3560_get_ctrl(struct v4l2_ctrl *ctrl, enum lm3560_led_id led_no)\r\n{\r\nstruct lm3560_flash *flash = to_lm3560_flash(ctrl, led_no);\r\nint rval = -EINVAL;\r\nmutex_lock(&flash->lock);\r\nif (ctrl->id == V4L2_CID_FLASH_FAULT) {\r\ns32 fault = 0;\r\nunsigned int reg_val;\r\nrval = regmap_read(flash->regmap, REG_FLAG, &reg_val);\r\nif (rval < 0)\r\ngoto out;\r\nif (reg_val & FAULT_SHORT_CIRCUIT)\r\nfault |= V4L2_FLASH_FAULT_SHORT_CIRCUIT;\r\nif (reg_val & FAULT_OVERTEMP)\r\nfault |= V4L2_FLASH_FAULT_OVER_TEMPERATURE;\r\nif (reg_val & FAULT_TIMEOUT)\r\nfault |= V4L2_FLASH_FAULT_TIMEOUT;\r\nctrl->cur.val = fault;\r\n}\r\nout:\r\nmutex_unlock(&flash->lock);\r\nreturn rval;\r\n}\r\nstatic int lm3560_set_ctrl(struct v4l2_ctrl *ctrl, enum lm3560_led_id led_no)\r\n{\r\nstruct lm3560_flash *flash = to_lm3560_flash(ctrl, led_no);\r\nu8 tout_bits;\r\nint rval = -EINVAL;\r\nmutex_lock(&flash->lock);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_FLASH_LED_MODE:\r\nflash->led_mode = ctrl->val;\r\nif (flash->led_mode != V4L2_FLASH_LED_MODE_FLASH)\r\nrval = lm3560_mode_ctrl(flash);\r\nbreak;\r\ncase V4L2_CID_FLASH_STROBE_SOURCE:\r\nrval = regmap_update_bits(flash->regmap,\r\nREG_CONFIG1, 0x04, (ctrl->val) << 2);\r\nif (rval < 0)\r\ngoto err_out;\r\nbreak;\r\ncase V4L2_CID_FLASH_STROBE:\r\nif (flash->led_mode != V4L2_FLASH_LED_MODE_FLASH) {\r\nrval = -EBUSY;\r\ngoto err_out;\r\n}\r\nflash->led_mode = V4L2_FLASH_LED_MODE_FLASH;\r\nrval = lm3560_mode_ctrl(flash);\r\nbreak;\r\ncase V4L2_CID_FLASH_STROBE_STOP:\r\nif (flash->led_mode != V4L2_FLASH_LED_MODE_FLASH) {\r\nrval = -EBUSY;\r\ngoto err_out;\r\n}\r\nflash->led_mode = V4L2_FLASH_LED_MODE_NONE;\r\nrval = lm3560_mode_ctrl(flash);\r\nbreak;\r\ncase V4L2_CID_FLASH_TIMEOUT:\r\ntout_bits = LM3560_FLASH_TOUT_ms_TO_REG(ctrl->val);\r\nrval = regmap_update_bits(flash->regmap,\r\nREG_FLASH_TOUT, 0x1f, tout_bits);\r\nbreak;\r\ncase V4L2_CID_FLASH_INTENSITY:\r\nrval = lm3560_flash_brt_ctrl(flash, led_no, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_FLASH_TORCH_INTENSITY:\r\nrval = lm3560_torch_brt_ctrl(flash, led_no, ctrl->val);\r\nbreak;\r\n}\r\nerr_out:\r\nmutex_unlock(&flash->lock);\r\nreturn rval;\r\n}\r\nstatic int lm3560_led1_get_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nreturn lm3560_get_ctrl(ctrl, LM3560_LED1);\r\n}\r\nstatic int lm3560_led1_set_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nreturn lm3560_set_ctrl(ctrl, LM3560_LED1);\r\n}\r\nstatic int lm3560_led0_get_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nreturn lm3560_get_ctrl(ctrl, LM3560_LED0);\r\n}\r\nstatic int lm3560_led0_set_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nreturn lm3560_set_ctrl(ctrl, LM3560_LED0);\r\n}\r\nstatic int lm3560_init_controls(struct lm3560_flash *flash,\r\nenum lm3560_led_id led_no)\r\n{\r\nstruct v4l2_ctrl *fault;\r\nu32 max_flash_brt = flash->pdata->max_flash_brt[led_no];\r\nu32 max_torch_brt = flash->pdata->max_torch_brt[led_no];\r\nstruct v4l2_ctrl_handler *hdl = &flash->ctrls_led[led_no];\r\nconst struct v4l2_ctrl_ops *ops = &lm3560_led_ctrl_ops[led_no];\r\nv4l2_ctrl_handler_init(hdl, 8);\r\nv4l2_ctrl_new_std_menu(hdl, ops, V4L2_CID_FLASH_LED_MODE,\r\nV4L2_FLASH_LED_MODE_TORCH, ~0x7,\r\nV4L2_FLASH_LED_MODE_NONE);\r\nflash->led_mode = V4L2_FLASH_LED_MODE_NONE;\r\nv4l2_ctrl_new_std_menu(hdl, ops, V4L2_CID_FLASH_STROBE_SOURCE,\r\n0x1, ~0x3, V4L2_FLASH_STROBE_SOURCE_SOFTWARE);\r\nv4l2_ctrl_new_std(hdl, ops, V4L2_CID_FLASH_STROBE, 0, 0, 0, 0);\r\nv4l2_ctrl_new_std(hdl, ops, V4L2_CID_FLASH_STROBE_STOP, 0, 0, 0, 0);\r\nv4l2_ctrl_new_std(hdl, ops, V4L2_CID_FLASH_TIMEOUT,\r\nLM3560_FLASH_TOUT_MIN,\r\nflash->pdata->max_flash_timeout,\r\nLM3560_FLASH_TOUT_STEP,\r\nflash->pdata->max_flash_timeout);\r\nv4l2_ctrl_new_std(hdl, ops, V4L2_CID_FLASH_INTENSITY,\r\nLM3560_FLASH_BRT_MIN, max_flash_brt,\r\nLM3560_FLASH_BRT_STEP, max_flash_brt);\r\nv4l2_ctrl_new_std(hdl, ops, V4L2_CID_FLASH_TORCH_INTENSITY,\r\nLM3560_TORCH_BRT_MIN, max_torch_brt,\r\nLM3560_TORCH_BRT_STEP, max_torch_brt);\r\nfault = v4l2_ctrl_new_std(hdl, ops, V4L2_CID_FLASH_FAULT, 0,\r\nV4L2_FLASH_FAULT_OVER_VOLTAGE\r\n| V4L2_FLASH_FAULT_OVER_TEMPERATURE\r\n| V4L2_FLASH_FAULT_SHORT_CIRCUIT\r\n| V4L2_FLASH_FAULT_TIMEOUT, 0, 0);\r\nif (fault != NULL)\r\nfault->flags |= V4L2_CTRL_FLAG_VOLATILE;\r\nif (hdl->error)\r\nreturn hdl->error;\r\nflash->subdev_led[led_no].ctrl_handler = hdl;\r\nreturn 0;\r\n}\r\nstatic int lm3560_subdev_init(struct lm3560_flash *flash,\r\nenum lm3560_led_id led_no, char *led_name)\r\n{\r\nstruct i2c_client *client = to_i2c_client(flash->dev);\r\nint rval;\r\nv4l2_i2c_subdev_init(&flash->subdev_led[led_no], client, &lm3560_ops);\r\nflash->subdev_led[led_no].flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;\r\nstrcpy(flash->subdev_led[led_no].name, led_name);\r\nrval = lm3560_init_controls(flash, led_no);\r\nif (rval)\r\ngoto err_out;\r\nrval = media_entity_pads_init(&flash->subdev_led[led_no].entity, 0, NULL);\r\nif (rval < 0)\r\ngoto err_out;\r\nflash->subdev_led[led_no].entity.function = MEDIA_ENT_F_FLASH;\r\nreturn rval;\r\nerr_out:\r\nv4l2_ctrl_handler_free(&flash->ctrls_led[led_no]);\r\nreturn rval;\r\n}\r\nstatic int lm3560_init_device(struct lm3560_flash *flash)\r\n{\r\nint rval;\r\nunsigned int reg_val;\r\nrval = regmap_update_bits(flash->regmap,\r\nREG_FLASH_TOUT, 0x60, flash->pdata->peak);\r\nif (rval < 0)\r\nreturn rval;\r\nflash->led_mode = V4L2_FLASH_LED_MODE_NONE;\r\nrval = lm3560_mode_ctrl(flash);\r\nif (rval < 0)\r\nreturn rval;\r\nrval = regmap_read(flash->regmap, REG_FLAG, &reg_val);\r\nreturn rval;\r\n}\r\nstatic int lm3560_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *devid)\r\n{\r\nstruct lm3560_flash *flash;\r\nstruct lm3560_platform_data *pdata = dev_get_platdata(&client->dev);\r\nint rval;\r\nflash = devm_kzalloc(&client->dev, sizeof(*flash), GFP_KERNEL);\r\nif (flash == NULL)\r\nreturn -ENOMEM;\r\nflash->regmap = devm_regmap_init_i2c(client, &lm3560_regmap);\r\nif (IS_ERR(flash->regmap)) {\r\nrval = PTR_ERR(flash->regmap);\r\nreturn rval;\r\n}\r\nif (pdata == NULL) {\r\npdata = devm_kzalloc(&client->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (pdata == NULL)\r\nreturn -ENODEV;\r\npdata->peak = LM3560_PEAK_3600mA;\r\npdata->max_flash_timeout = LM3560_FLASH_TOUT_MAX;\r\npdata->max_flash_brt[LM3560_LED0] = LM3560_FLASH_BRT_MAX;\r\npdata->max_torch_brt[LM3560_LED0] = LM3560_TORCH_BRT_MAX;\r\npdata->max_flash_brt[LM3560_LED1] = LM3560_FLASH_BRT_MAX;\r\npdata->max_torch_brt[LM3560_LED1] = LM3560_TORCH_BRT_MAX;\r\n}\r\nflash->pdata = pdata;\r\nflash->dev = &client->dev;\r\nmutex_init(&flash->lock);\r\nrval = lm3560_subdev_init(flash, LM3560_LED0, "lm3560-led0");\r\nif (rval < 0)\r\nreturn rval;\r\nrval = lm3560_subdev_init(flash, LM3560_LED1, "lm3560-led1");\r\nif (rval < 0)\r\nreturn rval;\r\nrval = lm3560_init_device(flash);\r\nif (rval < 0)\r\nreturn rval;\r\ni2c_set_clientdata(client, flash);\r\nreturn 0;\r\n}\r\nstatic int lm3560_remove(struct i2c_client *client)\r\n{\r\nstruct lm3560_flash *flash = i2c_get_clientdata(client);\r\nunsigned int i;\r\nfor (i = LM3560_LED0; i < LM3560_LED_MAX; i++) {\r\nv4l2_device_unregister_subdev(&flash->subdev_led[i]);\r\nv4l2_ctrl_handler_free(&flash->ctrls_led[i]);\r\nmedia_entity_cleanup(&flash->subdev_led[i].entity);\r\n}\r\nreturn 0;\r\n}

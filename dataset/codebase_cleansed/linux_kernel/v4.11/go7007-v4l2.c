static bool valid_pixelformat(u32 pixelformat)\r\n{\r\nswitch (pixelformat) {\r\ncase V4L2_PIX_FMT_MJPEG:\r\ncase V4L2_PIX_FMT_MPEG1:\r\ncase V4L2_PIX_FMT_MPEG2:\r\ncase V4L2_PIX_FMT_MPEG4:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic u32 get_frame_type_flag(struct go7007_buffer *vb, int format)\r\n{\r\nu8 *ptr = vb2_plane_vaddr(&vb->vb.vb2_buf, 0);\r\nswitch (format) {\r\ncase V4L2_PIX_FMT_MJPEG:\r\nreturn V4L2_BUF_FLAG_KEYFRAME;\r\ncase V4L2_PIX_FMT_MPEG4:\r\nswitch ((ptr[vb->frame_offset + 4] >> 6) & 0x3) {\r\ncase 0:\r\nreturn V4L2_BUF_FLAG_KEYFRAME;\r\ncase 1:\r\nreturn V4L2_BUF_FLAG_PFRAME;\r\ncase 2:\r\nreturn V4L2_BUF_FLAG_BFRAME;\r\ndefault:\r\nreturn 0;\r\n}\r\ncase V4L2_PIX_FMT_MPEG1:\r\ncase V4L2_PIX_FMT_MPEG2:\r\nswitch ((ptr[vb->frame_offset + 5] >> 3) & 0x7) {\r\ncase 1:\r\nreturn V4L2_BUF_FLAG_KEYFRAME;\r\ncase 2:\r\nreturn V4L2_BUF_FLAG_PFRAME;\r\ncase 3:\r\nreturn V4L2_BUF_FLAG_BFRAME;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void get_resolution(struct go7007 *go, int *width, int *height)\r\n{\r\nswitch (go->standard) {\r\ncase GO7007_STD_NTSC:\r\n*width = 720;\r\n*height = 480;\r\nbreak;\r\ncase GO7007_STD_PAL:\r\n*width = 720;\r\n*height = 576;\r\nbreak;\r\ncase GO7007_STD_OTHER:\r\ndefault:\r\n*width = go->board_info->sensor_width;\r\n*height = go->board_info->sensor_height;\r\nbreak;\r\n}\r\n}\r\nstatic void set_formatting(struct go7007 *go)\r\n{\r\nif (go->format == V4L2_PIX_FMT_MJPEG) {\r\ngo->pali = 0;\r\ngo->aspect_ratio = GO7007_RATIO_1_1;\r\ngo->gop_size = 0;\r\ngo->ipb = 0;\r\ngo->closed_gop = 0;\r\ngo->repeat_seqhead = 0;\r\ngo->seq_header_enable = 0;\r\ngo->gop_header_enable = 0;\r\ngo->dvd_mode = 0;\r\nreturn;\r\n}\r\nswitch (go->format) {\r\ncase V4L2_PIX_FMT_MPEG1:\r\ngo->pali = 0;\r\nbreak;\r\ndefault:\r\ncase V4L2_PIX_FMT_MPEG2:\r\ngo->pali = 0x48;\r\nbreak;\r\ncase V4L2_PIX_FMT_MPEG4:\r\ngo->pali = 0xf5;\r\nbreak;\r\n}\r\ngo->gop_size = v4l2_ctrl_g_ctrl(go->mpeg_video_gop_size);\r\ngo->closed_gop = v4l2_ctrl_g_ctrl(go->mpeg_video_gop_closure);\r\ngo->ipb = v4l2_ctrl_g_ctrl(go->mpeg_video_b_frames) != 0;\r\ngo->bitrate = v4l2_ctrl_g_ctrl(go->mpeg_video_bitrate);\r\ngo->repeat_seqhead = v4l2_ctrl_g_ctrl(go->mpeg_video_rep_seqheader);\r\ngo->gop_header_enable = 1;\r\ngo->dvd_mode = 0;\r\nif (go->format == V4L2_PIX_FMT_MPEG2)\r\ngo->dvd_mode =\r\ngo->bitrate == 9800000 &&\r\ngo->gop_size == 15 &&\r\ngo->ipb == 0 &&\r\ngo->repeat_seqhead == 1 &&\r\ngo->closed_gop;\r\nswitch (v4l2_ctrl_g_ctrl(go->mpeg_video_aspect_ratio)) {\r\ndefault:\r\ncase V4L2_MPEG_VIDEO_ASPECT_1x1:\r\ngo->aspect_ratio = GO7007_RATIO_1_1;\r\nbreak;\r\ncase V4L2_MPEG_VIDEO_ASPECT_4x3:\r\ngo->aspect_ratio = GO7007_RATIO_4_3;\r\nbreak;\r\ncase V4L2_MPEG_VIDEO_ASPECT_16x9:\r\ngo->aspect_ratio = GO7007_RATIO_16_9;\r\nbreak;\r\n}\r\n}\r\nstatic int set_capture_size(struct go7007 *go, struct v4l2_format *fmt, int try)\r\n{\r\nint sensor_height = 0, sensor_width = 0;\r\nint width, height;\r\nif (fmt != NULL && !valid_pixelformat(fmt->fmt.pix.pixelformat))\r\nreturn -EINVAL;\r\nget_resolution(go, &sensor_width, &sensor_height);\r\nif (fmt == NULL) {\r\nwidth = sensor_width;\r\nheight = sensor_height;\r\n} else if (go->board_info->sensor_flags & GO7007_SENSOR_SCALING) {\r\nif (fmt->fmt.pix.width > sensor_width)\r\nwidth = sensor_width;\r\nelse if (fmt->fmt.pix.width < 144)\r\nwidth = 144;\r\nelse\r\nwidth = fmt->fmt.pix.width & ~0x0f;\r\nif (fmt->fmt.pix.height > sensor_height)\r\nheight = sensor_height;\r\nelse if (fmt->fmt.pix.height < 96)\r\nheight = 96;\r\nelse\r\nheight = fmt->fmt.pix.height & ~0x0f;\r\n} else {\r\nwidth = fmt->fmt.pix.width;\r\nif (width <= sensor_width / 4) {\r\nwidth = sensor_width / 4;\r\nheight = sensor_height / 4;\r\n} else if (width <= sensor_width / 2) {\r\nwidth = sensor_width / 2;\r\nheight = sensor_height / 2;\r\n} else {\r\nwidth = sensor_width;\r\nheight = sensor_height;\r\n}\r\nwidth &= ~0xf;\r\nheight &= ~0xf;\r\n}\r\nif (fmt != NULL) {\r\nu32 pixelformat = fmt->fmt.pix.pixelformat;\r\nmemset(fmt, 0, sizeof(*fmt));\r\nfmt->type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\r\nfmt->fmt.pix.width = width;\r\nfmt->fmt.pix.height = height;\r\nfmt->fmt.pix.pixelformat = pixelformat;\r\nfmt->fmt.pix.field = V4L2_FIELD_NONE;\r\nfmt->fmt.pix.bytesperline = 0;\r\nfmt->fmt.pix.sizeimage = GO7007_BUF_SIZE;\r\nfmt->fmt.pix.colorspace = V4L2_COLORSPACE_SMPTE170M;\r\n}\r\nif (try)\r\nreturn 0;\r\nif (fmt)\r\ngo->format = fmt->fmt.pix.pixelformat;\r\ngo->width = width;\r\ngo->height = height;\r\ngo->encoder_h_offset = go->board_info->sensor_h_offset;\r\ngo->encoder_v_offset = go->board_info->sensor_v_offset;\r\nif (go->board_info->sensor_flags & GO7007_SENSOR_SCALING) {\r\nstruct v4l2_subdev_format format = {\r\n.which = V4L2_SUBDEV_FORMAT_ACTIVE,\r\n};\r\nformat.format.code = MEDIA_BUS_FMT_FIXED;\r\nformat.format.width = fmt ? fmt->fmt.pix.width : width;\r\nformat.format.height = height;\r\ngo->encoder_h_halve = 0;\r\ngo->encoder_v_halve = 0;\r\ngo->encoder_subsample = 0;\r\ncall_all(&go->v4l2_dev, pad, set_fmt, NULL, &format);\r\n} else {\r\nif (width <= sensor_width / 4) {\r\ngo->encoder_h_halve = 1;\r\ngo->encoder_v_halve = 1;\r\ngo->encoder_subsample = 1;\r\n} else if (width <= sensor_width / 2) {\r\ngo->encoder_h_halve = 1;\r\ngo->encoder_v_halve = 1;\r\ngo->encoder_subsample = 0;\r\n} else {\r\ngo->encoder_h_halve = 0;\r\ngo->encoder_v_halve = 0;\r\ngo->encoder_subsample = 0;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int vidioc_querycap(struct file *file, void *priv,\r\nstruct v4l2_capability *cap)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nstrlcpy(cap->driver, "go7007", sizeof(cap->driver));\r\nstrlcpy(cap->card, go->name, sizeof(cap->card));\r\nstrlcpy(cap->bus_info, go->bus_info, sizeof(cap->bus_info));\r\ncap->device_caps = V4L2_CAP_VIDEO_CAPTURE | V4L2_CAP_READWRITE |\r\nV4L2_CAP_STREAMING;\r\nif (go->board_info->num_aud_inputs)\r\ncap->device_caps |= V4L2_CAP_AUDIO;\r\nif (go->board_info->flags & GO7007_BOARD_HAS_TUNER)\r\ncap->device_caps |= V4L2_CAP_TUNER;\r\ncap->capabilities = cap->device_caps | V4L2_CAP_DEVICE_CAPS;\r\nreturn 0;\r\n}\r\nstatic int vidioc_enum_fmt_vid_cap(struct file *file, void *priv,\r\nstruct v4l2_fmtdesc *fmt)\r\n{\r\nchar *desc = NULL;\r\nswitch (fmt->index) {\r\ncase 0:\r\nfmt->pixelformat = V4L2_PIX_FMT_MJPEG;\r\ndesc = "Motion JPEG";\r\nbreak;\r\ncase 1:\r\nfmt->pixelformat = V4L2_PIX_FMT_MPEG1;\r\ndesc = "MPEG-1 ES";\r\nbreak;\r\ncase 2:\r\nfmt->pixelformat = V4L2_PIX_FMT_MPEG2;\r\ndesc = "MPEG-2 ES";\r\nbreak;\r\ncase 3:\r\nfmt->pixelformat = V4L2_PIX_FMT_MPEG4;\r\ndesc = "MPEG-4 ES";\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nfmt->type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\r\nfmt->flags = V4L2_FMT_FLAG_COMPRESSED;\r\nstrncpy(fmt->description, desc, sizeof(fmt->description));\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_fmt_vid_cap(struct file *file, void *priv,\r\nstruct v4l2_format *fmt)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nfmt->type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\r\nfmt->fmt.pix.width = go->width;\r\nfmt->fmt.pix.height = go->height;\r\nfmt->fmt.pix.pixelformat = go->format;\r\nfmt->fmt.pix.field = V4L2_FIELD_NONE;\r\nfmt->fmt.pix.bytesperline = 0;\r\nfmt->fmt.pix.sizeimage = GO7007_BUF_SIZE;\r\nfmt->fmt.pix.colorspace = V4L2_COLORSPACE_SMPTE170M;\r\nreturn 0;\r\n}\r\nstatic int vidioc_try_fmt_vid_cap(struct file *file, void *priv,\r\nstruct v4l2_format *fmt)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nreturn set_capture_size(go, fmt, 1);\r\n}\r\nstatic int vidioc_s_fmt_vid_cap(struct file *file, void *priv,\r\nstruct v4l2_format *fmt)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nif (vb2_is_busy(&go->vidq))\r\nreturn -EBUSY;\r\nreturn set_capture_size(go, fmt, 0);\r\n}\r\nstatic int go7007_queue_setup(struct vb2_queue *q,\r\nunsigned int *num_buffers, unsigned int *num_planes,\r\nunsigned int sizes[], struct device *alloc_devs[])\r\n{\r\nsizes[0] = GO7007_BUF_SIZE;\r\n*num_planes = 1;\r\nif (*num_buffers < 2)\r\n*num_buffers = 2;\r\nreturn 0;\r\n}\r\nstatic void go7007_buf_queue(struct vb2_buffer *vb)\r\n{\r\nstruct vb2_queue *vq = vb->vb2_queue;\r\nstruct go7007 *go = vb2_get_drv_priv(vq);\r\nstruct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb);\r\nstruct go7007_buffer *go7007_vb =\r\ncontainer_of(vbuf, struct go7007_buffer, vb);\r\nunsigned long flags;\r\nspin_lock_irqsave(&go->spinlock, flags);\r\nlist_add_tail(&go7007_vb->list, &go->vidq_active);\r\nspin_unlock_irqrestore(&go->spinlock, flags);\r\n}\r\nstatic int go7007_buf_prepare(struct vb2_buffer *vb)\r\n{\r\nstruct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb);\r\nstruct go7007_buffer *go7007_vb =\r\ncontainer_of(vbuf, struct go7007_buffer, vb);\r\ngo7007_vb->modet_active = 0;\r\ngo7007_vb->frame_offset = 0;\r\nvb->planes[0].bytesused = 0;\r\nreturn 0;\r\n}\r\nstatic void go7007_buf_finish(struct vb2_buffer *vb)\r\n{\r\nstruct vb2_queue *vq = vb->vb2_queue;\r\nstruct go7007 *go = vb2_get_drv_priv(vq);\r\nstruct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb);\r\nstruct go7007_buffer *go7007_vb =\r\ncontainer_of(vbuf, struct go7007_buffer, vb);\r\nu32 frame_type_flag = get_frame_type_flag(go7007_vb, go->format);\r\nvbuf->flags &= ~(V4L2_BUF_FLAG_KEYFRAME | V4L2_BUF_FLAG_BFRAME |\r\nV4L2_BUF_FLAG_PFRAME);\r\nvbuf->flags |= frame_type_flag;\r\nvbuf->field = V4L2_FIELD_NONE;\r\n}\r\nstatic int go7007_start_streaming(struct vb2_queue *q, unsigned int count)\r\n{\r\nstruct go7007 *go = vb2_get_drv_priv(q);\r\nint ret;\r\nset_formatting(go);\r\nmutex_lock(&go->hw_lock);\r\ngo->next_seq = 0;\r\ngo->active_buf = NULL;\r\ngo->modet_event_status = 0;\r\nq->streaming = 1;\r\nif (go7007_start_encoder(go) < 0)\r\nret = -EIO;\r\nelse\r\nret = 0;\r\nmutex_unlock(&go->hw_lock);\r\nif (ret) {\r\nq->streaming = 0;\r\nreturn ret;\r\n}\r\ncall_all(&go->v4l2_dev, video, s_stream, 1);\r\nv4l2_ctrl_grab(go->mpeg_video_gop_size, true);\r\nv4l2_ctrl_grab(go->mpeg_video_gop_closure, true);\r\nv4l2_ctrl_grab(go->mpeg_video_bitrate, true);\r\nv4l2_ctrl_grab(go->mpeg_video_aspect_ratio, true);\r\nif (go->board_id == GO7007_BOARDID_ADS_USBAV_709)\r\ngo7007_write_addr(go, 0x3c82, 0x0005);\r\nreturn ret;\r\n}\r\nstatic void go7007_stop_streaming(struct vb2_queue *q)\r\n{\r\nstruct go7007 *go = vb2_get_drv_priv(q);\r\nunsigned long flags;\r\nq->streaming = 0;\r\ngo7007_stream_stop(go);\r\nmutex_lock(&go->hw_lock);\r\ngo7007_reset_encoder(go);\r\nmutex_unlock(&go->hw_lock);\r\ncall_all(&go->v4l2_dev, video, s_stream, 0);\r\nspin_lock_irqsave(&go->spinlock, flags);\r\nINIT_LIST_HEAD(&go->vidq_active);\r\nspin_unlock_irqrestore(&go->spinlock, flags);\r\nv4l2_ctrl_grab(go->mpeg_video_gop_size, false);\r\nv4l2_ctrl_grab(go->mpeg_video_gop_closure, false);\r\nv4l2_ctrl_grab(go->mpeg_video_bitrate, false);\r\nv4l2_ctrl_grab(go->mpeg_video_aspect_ratio, false);\r\nif (go->board_id == GO7007_BOARDID_ADS_USBAV_709)\r\ngo7007_write_addr(go, 0x3c82, 0x000d);\r\n}\r\nstatic int vidioc_g_parm(struct file *filp, void *priv,\r\nstruct v4l2_streamparm *parm)\r\n{\r\nstruct go7007 *go = video_drvdata(filp);\r\nstruct v4l2_fract timeperframe = {\r\n.numerator = 1001 * go->fps_scale,\r\n.denominator = go->sensor_framerate,\r\n};\r\nif (parm->type != V4L2_BUF_TYPE_VIDEO_CAPTURE)\r\nreturn -EINVAL;\r\nparm->parm.capture.readbuffers = 2;\r\nparm->parm.capture.capability = V4L2_CAP_TIMEPERFRAME;\r\nparm->parm.capture.timeperframe = timeperframe;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_parm(struct file *filp, void *priv,\r\nstruct v4l2_streamparm *parm)\r\n{\r\nstruct go7007 *go = video_drvdata(filp);\r\nunsigned int n, d;\r\nif (parm->type != V4L2_BUF_TYPE_VIDEO_CAPTURE)\r\nreturn -EINVAL;\r\nn = go->sensor_framerate *\r\nparm->parm.capture.timeperframe.numerator;\r\nd = 1001 * parm->parm.capture.timeperframe.denominator;\r\nif (n != 0 && d != 0 && n > d)\r\ngo->fps_scale = (n + d/2) / d;\r\nelse\r\ngo->fps_scale = 1;\r\nreturn vidioc_g_parm(filp, priv, parm);\r\n}\r\nstatic int vidioc_enum_framesizes(struct file *filp, void *priv,\r\nstruct v4l2_frmsizeenum *fsize)\r\n{\r\nstruct go7007 *go = video_drvdata(filp);\r\nint width, height;\r\nif (fsize->index > 2)\r\nreturn -EINVAL;\r\nif (!valid_pixelformat(fsize->pixel_format))\r\nreturn -EINVAL;\r\nget_resolution(go, &width, &height);\r\nfsize->type = V4L2_FRMSIZE_TYPE_DISCRETE;\r\nfsize->discrete.width = (width >> fsize->index) & ~0xf;\r\nfsize->discrete.height = (height >> fsize->index) & ~0xf;\r\nreturn 0;\r\n}\r\nstatic int vidioc_enum_frameintervals(struct file *filp, void *priv,\r\nstruct v4l2_frmivalenum *fival)\r\n{\r\nstruct go7007 *go = video_drvdata(filp);\r\nint width, height;\r\nint i;\r\nif (fival->index > 4)\r\nreturn -EINVAL;\r\nif (!valid_pixelformat(fival->pixel_format))\r\nreturn -EINVAL;\r\nif (!(go->board_info->sensor_flags & GO7007_SENSOR_SCALING)) {\r\nget_resolution(go, &width, &height);\r\nfor (i = 0; i <= 2; i++)\r\nif (fival->width == ((width >> i) & ~0xf) &&\r\nfival->height == ((height >> i) & ~0xf))\r\nbreak;\r\nif (i > 2)\r\nreturn -EINVAL;\r\n}\r\nfival->type = V4L2_FRMIVAL_TYPE_DISCRETE;\r\nfival->discrete.numerator = 1001 * (fival->index + 1);\r\nfival->discrete.denominator = go->sensor_framerate;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_std(struct file *file, void *priv, v4l2_std_id *std)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\n*std = go->std;\r\nreturn 0;\r\n}\r\nstatic int go7007_s_std(struct go7007 *go)\r\n{\r\nif (go->std & V4L2_STD_625_50) {\r\ngo->standard = GO7007_STD_PAL;\r\ngo->sensor_framerate = 25025;\r\n} else {\r\ngo->standard = GO7007_STD_NTSC;\r\ngo->sensor_framerate = 30000;\r\n}\r\ncall_all(&go->v4l2_dev, video, s_std, go->std);\r\nset_capture_size(go, NULL, 0);\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_std(struct file *file, void *priv, v4l2_std_id std)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nif (vb2_is_busy(&go->vidq))\r\nreturn -EBUSY;\r\ngo->std = std;\r\nreturn go7007_s_std(go);\r\n}\r\nstatic int vidioc_querystd(struct file *file, void *priv, v4l2_std_id *std)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nreturn call_all(&go->v4l2_dev, video, querystd, std);\r\n}\r\nstatic int vidioc_enum_input(struct file *file, void *priv,\r\nstruct v4l2_input *inp)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nif (inp->index >= go->board_info->num_inputs)\r\nreturn -EINVAL;\r\nstrncpy(inp->name, go->board_info->inputs[inp->index].name,\r\nsizeof(inp->name));\r\nif ((go->board_info->flags & GO7007_BOARD_HAS_TUNER) &&\r\ninp->index == 0)\r\ninp->type = V4L2_INPUT_TYPE_TUNER;\r\nelse\r\ninp->type = V4L2_INPUT_TYPE_CAMERA;\r\nif (go->board_info->num_aud_inputs)\r\ninp->audioset = (1 << go->board_info->num_aud_inputs) - 1;\r\nelse\r\ninp->audioset = 0;\r\ninp->tuner = 0;\r\nif (go->board_info->sensor_flags & GO7007_SENSOR_TV)\r\ninp->std = video_devdata(file)->tvnorms;\r\nelse\r\ninp->std = 0;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_input(struct file *file, void *priv, unsigned int *input)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\n*input = go->input;\r\nreturn 0;\r\n}\r\nstatic int vidioc_enumaudio(struct file *file, void *fh, struct v4l2_audio *a)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nif (a->index >= go->board_info->num_aud_inputs)\r\nreturn -EINVAL;\r\nstrlcpy(a->name, go->board_info->aud_inputs[a->index].name,\r\nsizeof(a->name));\r\na->capability = V4L2_AUDCAP_STEREO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_audio(struct file *file, void *fh, struct v4l2_audio *a)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\na->index = go->aud_input;\r\nstrlcpy(a->name, go->board_info->aud_inputs[go->aud_input].name,\r\nsizeof(a->name));\r\na->capability = V4L2_AUDCAP_STEREO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_audio(struct file *file, void *fh,\r\nconst struct v4l2_audio *a)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nif (a->index >= go->board_info->num_aud_inputs)\r\nreturn -EINVAL;\r\ngo->aud_input = a->index;\r\nv4l2_subdev_call(go->sd_audio, audio, s_routing,\r\ngo->board_info->aud_inputs[go->aud_input].audio_input, 0, 0);\r\nreturn 0;\r\n}\r\nstatic void go7007_s_input(struct go7007 *go)\r\n{\r\nunsigned int input = go->input;\r\nv4l2_subdev_call(go->sd_video, video, s_routing,\r\ngo->board_info->inputs[input].video_input, 0,\r\ngo->board_info->video_config);\r\nif (go->board_info->num_aud_inputs) {\r\nint aud_input = go->board_info->inputs[input].audio_index;\r\nv4l2_subdev_call(go->sd_audio, audio, s_routing,\r\ngo->board_info->aud_inputs[aud_input].audio_input, 0, 0);\r\ngo->aud_input = aud_input;\r\n}\r\n}\r\nstatic int vidioc_s_input(struct file *file, void *priv, unsigned int input)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nif (input >= go->board_info->num_inputs)\r\nreturn -EINVAL;\r\nif (vb2_is_busy(&go->vidq))\r\nreturn -EBUSY;\r\ngo->input = input;\r\ngo7007_s_input(go);\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *t)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nif (t->index != 0)\r\nreturn -EINVAL;\r\nstrlcpy(t->name, "Tuner", sizeof(t->name));\r\nreturn call_all(&go->v4l2_dev, tuner, g_tuner, t);\r\n}\r\nstatic int vidioc_s_tuner(struct file *file, void *priv,\r\nconst struct v4l2_tuner *t)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nif (t->index != 0)\r\nreturn -EINVAL;\r\nreturn call_all(&go->v4l2_dev, tuner, s_tuner, t);\r\n}\r\nstatic int vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nif (f->tuner)\r\nreturn -EINVAL;\r\nreturn call_all(&go->v4l2_dev, tuner, g_frequency, f);\r\n}\r\nstatic int vidioc_s_frequency(struct file *file, void *priv,\r\nconst struct v4l2_frequency *f)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nif (f->tuner)\r\nreturn -EINVAL;\r\nreturn call_all(&go->v4l2_dev, tuner, s_frequency, f);\r\n}\r\nstatic int vidioc_log_status(struct file *file, void *priv)\r\n{\r\nstruct go7007 *go = video_drvdata(file);\r\nv4l2_ctrl_log_status(file, priv);\r\nreturn call_all(&go->v4l2_dev, core, log_status);\r\n}\r\nstatic int vidioc_subscribe_event(struct v4l2_fh *fh,\r\nconst struct v4l2_event_subscription *sub)\r\n{\r\nswitch (sub->type) {\r\ncase V4L2_EVENT_CTRL:\r\nreturn v4l2_ctrl_subscribe_event(fh, sub);\r\ncase V4L2_EVENT_MOTION_DET:\r\nreturn v4l2_event_subscribe(fh, sub, 30, NULL);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int go7007_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct go7007 *go =\r\ncontainer_of(ctrl->handler, struct go7007, hdl);\r\nunsigned y;\r\nu8 *mt;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_PIXEL_THRESHOLD0:\r\ngo->modet[0].pixel_threshold = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MOTION_THRESHOLD0:\r\ngo->modet[0].motion_threshold = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MB_THRESHOLD0:\r\ngo->modet[0].mb_threshold = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_PIXEL_THRESHOLD1:\r\ngo->modet[1].pixel_threshold = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MOTION_THRESHOLD1:\r\ngo->modet[1].motion_threshold = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MB_THRESHOLD1:\r\ngo->modet[1].mb_threshold = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_PIXEL_THRESHOLD2:\r\ngo->modet[2].pixel_threshold = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MOTION_THRESHOLD2:\r\ngo->modet[2].motion_threshold = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MB_THRESHOLD2:\r\ngo->modet[2].mb_threshold = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_PIXEL_THRESHOLD3:\r\ngo->modet[3].pixel_threshold = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MOTION_THRESHOLD3:\r\ngo->modet[3].motion_threshold = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_MB_THRESHOLD3:\r\ngo->modet[3].mb_threshold = ctrl->val;\r\nbreak;\r\ncase V4L2_CID_DETECT_MD_REGION_GRID:\r\nmt = go->modet_map;\r\nfor (y = 0; y < go->height / 16; y++, mt += go->width / 16)\r\nmemcpy(mt, ctrl->p_new.p_u8 + y * (720 / 16), go->width / 16);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint go7007_v4l2_ctrl_init(struct go7007 *go)\r\n{\r\nstruct v4l2_ctrl_handler *hdl = &go->hdl;\r\nstruct v4l2_ctrl *ctrl;\r\nv4l2_ctrl_handler_init(hdl, 22);\r\ngo->mpeg_video_gop_size = v4l2_ctrl_new_std(hdl, NULL,\r\nV4L2_CID_MPEG_VIDEO_GOP_SIZE, 0, 34, 1, 15);\r\ngo->mpeg_video_gop_closure = v4l2_ctrl_new_std(hdl, NULL,\r\nV4L2_CID_MPEG_VIDEO_GOP_CLOSURE, 0, 1, 1, 1);\r\ngo->mpeg_video_bitrate = v4l2_ctrl_new_std(hdl, NULL,\r\nV4L2_CID_MPEG_VIDEO_BITRATE,\r\n64000, 10000000, 1, 9800000);\r\ngo->mpeg_video_b_frames = v4l2_ctrl_new_std(hdl, NULL,\r\nV4L2_CID_MPEG_VIDEO_B_FRAMES, 0, 2, 2, 0);\r\ngo->mpeg_video_rep_seqheader = v4l2_ctrl_new_std(hdl, NULL,\r\nV4L2_CID_MPEG_VIDEO_REPEAT_SEQ_HEADER, 0, 1, 1, 1);\r\ngo->mpeg_video_aspect_ratio = v4l2_ctrl_new_std_menu(hdl, NULL,\r\nV4L2_CID_MPEG_VIDEO_ASPECT,\r\nV4L2_MPEG_VIDEO_ASPECT_16x9, 0,\r\nV4L2_MPEG_VIDEO_ASPECT_1x1);\r\nctrl = v4l2_ctrl_new_std(hdl, NULL,\r\nV4L2_CID_JPEG_ACTIVE_MARKER, 0,\r\nV4L2_JPEG_ACTIVE_MARKER_DQT |\r\nV4L2_JPEG_ACTIVE_MARKER_DHT, 0,\r\nV4L2_JPEG_ACTIVE_MARKER_DQT |\r\nV4L2_JPEG_ACTIVE_MARKER_DHT);\r\nif (ctrl)\r\nctrl->flags |= V4L2_CTRL_FLAG_READ_ONLY;\r\nv4l2_ctrl_new_custom(hdl, &go7007_pixel_threshold0_ctrl, NULL);\r\nv4l2_ctrl_new_custom(hdl, &go7007_motion_threshold0_ctrl, NULL);\r\nv4l2_ctrl_new_custom(hdl, &go7007_mb_threshold0_ctrl, NULL);\r\nv4l2_ctrl_new_custom(hdl, &go7007_pixel_threshold1_ctrl, NULL);\r\nv4l2_ctrl_new_custom(hdl, &go7007_motion_threshold1_ctrl, NULL);\r\nv4l2_ctrl_new_custom(hdl, &go7007_mb_threshold1_ctrl, NULL);\r\nv4l2_ctrl_new_custom(hdl, &go7007_pixel_threshold2_ctrl, NULL);\r\nv4l2_ctrl_new_custom(hdl, &go7007_motion_threshold2_ctrl, NULL);\r\nv4l2_ctrl_new_custom(hdl, &go7007_mb_threshold2_ctrl, NULL);\r\nv4l2_ctrl_new_custom(hdl, &go7007_pixel_threshold3_ctrl, NULL);\r\nv4l2_ctrl_new_custom(hdl, &go7007_motion_threshold3_ctrl, NULL);\r\nv4l2_ctrl_new_custom(hdl, &go7007_mb_threshold3_ctrl, NULL);\r\nv4l2_ctrl_new_custom(hdl, &go7007_mb_regions_ctrl, NULL);\r\ngo->modet_mode = v4l2_ctrl_new_std_menu(hdl, NULL,\r\nV4L2_CID_DETECT_MD_MODE,\r\nV4L2_DETECT_MD_MODE_REGION_GRID,\r\n1 << V4L2_DETECT_MD_MODE_THRESHOLD_GRID,\r\nV4L2_DETECT_MD_MODE_DISABLED);\r\nif (hdl->error) {\r\nint rv = hdl->error;\r\nv4l2_err(&go->v4l2_dev, "Could not register controls\n");\r\nreturn rv;\r\n}\r\ngo->v4l2_dev.ctrl_handler = hdl;\r\nreturn 0;\r\n}\r\nint go7007_v4l2_init(struct go7007 *go)\r\n{\r\nstruct video_device *vdev = &go->vdev;\r\nint rv;\r\nmutex_init(&go->serialize_lock);\r\nmutex_init(&go->queue_lock);\r\nINIT_LIST_HEAD(&go->vidq_active);\r\ngo->vidq.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\r\ngo->vidq.io_modes = VB2_MMAP | VB2_USERPTR | VB2_READ;\r\ngo->vidq.ops = &go7007_video_qops;\r\ngo->vidq.mem_ops = &vb2_vmalloc_memops;\r\ngo->vidq.drv_priv = go;\r\ngo->vidq.buf_struct_size = sizeof(struct go7007_buffer);\r\ngo->vidq.timestamp_flags = V4L2_BUF_FLAG_TIMESTAMP_MONOTONIC;\r\ngo->vidq.lock = &go->queue_lock;\r\nrv = vb2_queue_init(&go->vidq);\r\nif (rv)\r\nreturn rv;\r\n*vdev = go7007_template;\r\nvdev->lock = &go->serialize_lock;\r\nvdev->queue = &go->vidq;\r\nvideo_set_drvdata(vdev, go);\r\nvdev->v4l2_dev = &go->v4l2_dev;\r\nif (!v4l2_device_has_op(&go->v4l2_dev, 0, video, querystd))\r\nv4l2_disable_ioctl(vdev, VIDIOC_QUERYSTD);\r\nif (!(go->board_info->flags & GO7007_BOARD_HAS_TUNER)) {\r\nv4l2_disable_ioctl(vdev, VIDIOC_S_FREQUENCY);\r\nv4l2_disable_ioctl(vdev, VIDIOC_G_FREQUENCY);\r\nv4l2_disable_ioctl(vdev, VIDIOC_S_TUNER);\r\nv4l2_disable_ioctl(vdev, VIDIOC_G_TUNER);\r\n} else {\r\nstruct v4l2_frequency f = {\r\n.type = V4L2_TUNER_ANALOG_TV,\r\n.frequency = 980,\r\n};\r\ncall_all(&go->v4l2_dev, tuner, s_frequency, &f);\r\n}\r\nif (!(go->board_info->sensor_flags & GO7007_SENSOR_TV)) {\r\nv4l2_disable_ioctl(vdev, VIDIOC_G_STD);\r\nv4l2_disable_ioctl(vdev, VIDIOC_S_STD);\r\nvdev->tvnorms = 0;\r\n}\r\nif (go->board_info->sensor_flags & GO7007_SENSOR_SCALING)\r\nv4l2_disable_ioctl(vdev, VIDIOC_ENUM_FRAMESIZES);\r\nif (go->board_info->num_aud_inputs == 0) {\r\nv4l2_disable_ioctl(vdev, VIDIOC_G_AUDIO);\r\nv4l2_disable_ioctl(vdev, VIDIOC_S_AUDIO);\r\nv4l2_disable_ioctl(vdev, VIDIOC_ENUMAUDIO);\r\n}\r\nif (go->board_info->sensor_flags & GO7007_SENSOR_SAA7115)\r\nv4l2_subdev_call(go->sd_video, video, s_crystal_freq,\r\nSAA7115_FREQ_24_576_MHZ,\r\nSAA7115_FREQ_FL_APLL | SAA7115_FREQ_FL_UCGC |\r\nSAA7115_FREQ_FL_DOUBLE_ASCLK);\r\ngo7007_s_input(go);\r\nif (go->board_info->sensor_flags & GO7007_SENSOR_TV)\r\ngo7007_s_std(go);\r\nrv = video_register_device(vdev, VFL_TYPE_GRABBER, -1);\r\nif (rv < 0)\r\nreturn rv;\r\ndev_info(go->dev, "registered device %s [v4l2]\n",\r\nvideo_device_node_name(vdev));\r\nreturn 0;\r\n}\r\nvoid go7007_v4l2_remove(struct go7007 *go)\r\n{\r\nv4l2_ctrl_handler_free(&go->hdl);\r\n}

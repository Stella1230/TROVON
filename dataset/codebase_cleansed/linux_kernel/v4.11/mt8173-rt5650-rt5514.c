static int mt8173_rt5650_rt5514_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nint i, ret;\r\nfor (i = 0; i < rtd->num_codecs; i++) {\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dais[i];\r\nret = snd_soc_dai_set_pll(codec_dai, 0, 0, MCLK_FOR_CODECS,\r\nparams_rate(params) * 512);\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, 1,\r\nparams_rate(params) * 512,\r\nSND_SOC_CLOCK_IN);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mt8173_rt5650_rt5514_init(struct snd_soc_pcm_runtime *runtime)\r\n{\r\nstruct snd_soc_card *card = runtime->card;\r\nstruct snd_soc_codec *codec = runtime->codec_dais[0]->codec;\r\nint ret;\r\nrt5645_sel_asrc_clk_src(codec,\r\nRT5645_DA_STEREO_FILTER |\r\nRT5645_AD_STEREO_FILTER,\r\nRT5645_CLK_SEL_I2S1_ASRC);\r\nret = snd_soc_card_jack_new(card, "Headset Jack",\r\nSND_JACK_HEADPHONE | SND_JACK_MICROPHONE |\r\nSND_JACK_BTN_0 | SND_JACK_BTN_1 |\r\nSND_JACK_BTN_2 | SND_JACK_BTN_3,\r\n&mt8173_rt5650_rt5514_jack, NULL, 0);\r\nif (ret) {\r\ndev_err(card->dev, "Can't new Headset Jack %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn rt5645_set_jack_detect(codec,\r\n&mt8173_rt5650_rt5514_jack,\r\n&mt8173_rt5650_rt5514_jack,\r\n&mt8173_rt5650_rt5514_jack);\r\n}\r\nstatic int mt8173_rt5650_rt5514_dev_probe(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = &mt8173_rt5650_rt5514_card;\r\nstruct device_node *platform_node;\r\nint i, ret;\r\nplatform_node = of_parse_phandle(pdev->dev.of_node,\r\n"mediatek,platform", 0);\r\nif (!platform_node) {\r\ndev_err(&pdev->dev, "Property 'platform' missing or invalid\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < card->num_links; i++) {\r\nif (mt8173_rt5650_rt5514_dais[i].platform_name)\r\ncontinue;\r\nmt8173_rt5650_rt5514_dais[i].platform_of_node = platform_node;\r\n}\r\nmt8173_rt5650_rt5514_codecs[0].of_node =\r\nof_parse_phandle(pdev->dev.of_node, "mediatek,audio-codec", 0);\r\nif (!mt8173_rt5650_rt5514_codecs[0].of_node) {\r\ndev_err(&pdev->dev,\r\n"Property 'audio-codec' missing or invalid\n");\r\nreturn -EINVAL;\r\n}\r\nmt8173_rt5650_rt5514_codecs[1].of_node =\r\nof_parse_phandle(pdev->dev.of_node, "mediatek,audio-codec", 1);\r\nif (!mt8173_rt5650_rt5514_codecs[1].of_node) {\r\ndev_err(&pdev->dev,\r\n"Property 'audio-codec' missing or invalid\n");\r\nreturn -EINVAL;\r\n}\r\nmt8173_rt5650_rt5514_codec_conf[0].of_node =\r\nmt8173_rt5650_rt5514_codecs[1].of_node;\r\ncard->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, card);\r\nret = devm_snd_soc_register_card(&pdev->dev, card);\r\nif (ret)\r\ndev_err(&pdev->dev, "%s snd_soc_register_card fail %d\n",\r\n__func__, ret);\r\nreturn ret;\r\n}

static int lm363x_regulator_enable_time(struct regulator_dev *rdev)\r\n{\r\nenum lm363x_regulator_id id = rdev_get_id(rdev);\r\nu8 val, addr, mask;\r\nswitch (id) {\r\ncase LM3631_LDO_CONT:\r\naddr = LM3631_REG_ENTIME_VCONT;\r\nmask = LM3631_ENTIME_CONT_MASK;\r\nbreak;\r\ncase LM3631_LDO_OREF:\r\naddr = LM3631_REG_ENTIME_VOREF;\r\nmask = LM3631_ENTIME_MASK;\r\nbreak;\r\ncase LM3631_LDO_POS:\r\naddr = LM3631_REG_ENTIME_VPOS;\r\nmask = LM3631_ENTIME_MASK;\r\nbreak;\r\ncase LM3631_LDO_NEG:\r\naddr = LM3631_REG_ENTIME_VNEG;\r\nmask = LM3631_ENTIME_MASK;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nif (regmap_read(rdev->regmap, addr, (unsigned int *)&val))\r\nreturn -EINVAL;\r\nval = (val & mask) >> LM3631_ENTIME_SHIFT;\r\nif (id == LM3631_LDO_CONT)\r\nreturn ldo_cont_enable_time[val];\r\nelse\r\nreturn ENABLE_TIME_USEC * val;\r\n}\r\nstatic int lm363x_regulator_of_get_enable_gpio(struct device_node *np, int id)\r\n{\r\nswitch (id) {\r\ncase LM3632_LDO_POS:\r\nreturn of_get_named_gpio(np, "ti,lcm-en1-gpio", 0);\r\ncase LM3632_LDO_NEG:\r\nreturn of_get_named_gpio(np, "ti,lcm-en2-gpio", 0);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int lm363x_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct ti_lmu *lmu = dev_get_drvdata(pdev->dev.parent);\r\nstruct regmap *regmap = lmu->regmap;\r\nstruct regulator_config cfg = { };\r\nstruct regulator_dev *rdev;\r\nstruct device *dev = &pdev->dev;\r\nint id = pdev->id;\r\nint ret, ena_gpio;\r\ncfg.dev = dev;\r\ncfg.regmap = regmap;\r\nena_gpio = lm363x_regulator_of_get_enable_gpio(dev->of_node, id);\r\nif (gpio_is_valid(ena_gpio)) {\r\ncfg.ena_gpio = ena_gpio;\r\ncfg.ena_gpio_flags = GPIOF_OUT_INIT_LOW;\r\nret = regmap_update_bits(regmap, LM3632_REG_BIAS_CONFIG,\r\nLM3632_EXT_EN_MASK,\r\nLM3632_EXT_EN_MASK);\r\nif (ret) {\r\ndev_err(dev, "External pin err: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nrdev = devm_regulator_register(dev, &lm363x_regulator_desc[id], &cfg);\r\nif (IS_ERR(rdev)) {\r\nret = PTR_ERR(rdev);\r\ndev_err(dev, "[%d] regulator register err: %d\n", id, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

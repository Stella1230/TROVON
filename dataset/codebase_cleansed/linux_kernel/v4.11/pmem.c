static struct dax_pmem *to_dax_pmem(struct percpu_ref *ref)\r\n{\r\nreturn container_of(ref, struct dax_pmem, ref);\r\n}\r\nstatic void dax_pmem_percpu_release(struct percpu_ref *ref)\r\n{\r\nstruct dax_pmem *dax_pmem = to_dax_pmem(ref);\r\ndev_dbg(dax_pmem->dev, "%s\n", __func__);\r\ncomplete(&dax_pmem->cmp);\r\n}\r\nstatic void dax_pmem_percpu_exit(void *data)\r\n{\r\nstruct percpu_ref *ref = data;\r\nstruct dax_pmem *dax_pmem = to_dax_pmem(ref);\r\ndev_dbg(dax_pmem->dev, "%s\n", __func__);\r\npercpu_ref_exit(ref);\r\n}\r\nstatic void dax_pmem_percpu_kill(void *data)\r\n{\r\nstruct percpu_ref *ref = data;\r\nstruct dax_pmem *dax_pmem = to_dax_pmem(ref);\r\ndev_dbg(dax_pmem->dev, "%s\n", __func__);\r\npercpu_ref_kill(ref);\r\nwait_for_completion(&dax_pmem->cmp);\r\n}\r\nstatic int dax_pmem_probe(struct device *dev)\r\n{\r\nint rc;\r\nvoid *addr;\r\nstruct resource res;\r\nstruct dax_dev *dax_dev;\r\nstruct nd_pfn_sb *pfn_sb;\r\nstruct dax_pmem *dax_pmem;\r\nstruct nd_region *nd_region;\r\nstruct nd_namespace_io *nsio;\r\nstruct dax_region *dax_region;\r\nstruct nd_namespace_common *ndns;\r\nstruct nd_dax *nd_dax = to_nd_dax(dev);\r\nstruct nd_pfn *nd_pfn = &nd_dax->nd_pfn;\r\nstruct vmem_altmap __altmap, *altmap = NULL;\r\nndns = nvdimm_namespace_common_probe(dev);\r\nif (IS_ERR(ndns))\r\nreturn PTR_ERR(ndns);\r\nnsio = to_nd_namespace_io(&ndns->dev);\r\nrc = devm_nsio_enable(dev, nsio);\r\nif (rc)\r\nreturn rc;\r\naltmap = nvdimm_setup_pfn(nd_pfn, &res, &__altmap);\r\nif (IS_ERR(altmap))\r\nreturn PTR_ERR(altmap);\r\ndevm_nsio_disable(dev, nsio);\r\npfn_sb = nd_pfn->pfn_sb;\r\nif (!devm_request_mem_region(dev, nsio->res.start,\r\nresource_size(&nsio->res),\r\ndev_name(&ndns->dev))) {\r\ndev_warn(dev, "could not reserve region %pR\n", &nsio->res);\r\nreturn -EBUSY;\r\n}\r\ndax_pmem = devm_kzalloc(dev, sizeof(*dax_pmem), GFP_KERNEL);\r\nif (!dax_pmem)\r\nreturn -ENOMEM;\r\ndax_pmem->dev = dev;\r\ninit_completion(&dax_pmem->cmp);\r\nrc = percpu_ref_init(&dax_pmem->ref, dax_pmem_percpu_release, 0,\r\nGFP_KERNEL);\r\nif (rc)\r\nreturn rc;\r\nrc = devm_add_action_or_reset(dev, dax_pmem_percpu_exit,\r\n&dax_pmem->ref);\r\nif (rc)\r\nreturn rc;\r\naddr = devm_memremap_pages(dev, &res, &dax_pmem->ref, altmap);\r\nif (IS_ERR(addr))\r\nreturn PTR_ERR(addr);\r\nrc = devm_add_action_or_reset(dev, dax_pmem_percpu_kill,\r\n&dax_pmem->ref);\r\nif (rc)\r\nreturn rc;\r\nres.start += le64_to_cpu(pfn_sb->dataoff);\r\nnd_region = to_nd_region(dev->parent);\r\ndax_region = alloc_dax_region(dev, nd_region->id, &res,\r\nle32_to_cpu(pfn_sb->align), addr, PFN_DEV|PFN_MAP);\r\nif (!dax_region)\r\nreturn -ENOMEM;\r\ndax_dev = devm_create_dax_dev(dax_region, &res, 1);\r\ndax_region_put(dax_region);\r\nreturn PTR_ERR_OR_ZERO(dax_dev);\r\n}\r\nstatic int __init dax_pmem_init(void)\r\n{\r\nreturn nd_driver_register(&dax_pmem_driver);\r\n}\r\nstatic void __exit dax_pmem_exit(void)\r\n{\r\ndriver_unregister(&dax_pmem_driver.drv);\r\n}

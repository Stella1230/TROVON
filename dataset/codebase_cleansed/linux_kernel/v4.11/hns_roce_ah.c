struct ib_ah *hns_roce_create_ah(struct ib_pd *ibpd, struct ib_ah_attr *ah_attr,\r\nstruct ib_udata *udata)\r\n{\r\nstruct hns_roce_dev *hr_dev = to_hr_dev(ibpd->device);\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct ib_gid_attr gid_attr;\r\nstruct hns_roce_ah *ah;\r\nu16 vlan_tag = 0xffff;\r\nstruct in6_addr in6;\r\nunion ib_gid sgid;\r\nint ret;\r\nah = kzalloc(sizeof(*ah), GFP_ATOMIC);\r\nif (!ah)\r\nreturn ERR_PTR(-ENOMEM);\r\nmemcpy(&in6, ah_attr->grh.dgid.raw, sizeof(ah_attr->grh.dgid.raw));\r\nif (rdma_is_multicast_addr(&in6))\r\nrdma_get_mcast_mac(&in6, ah->av.mac);\r\nelse\r\nmemcpy(ah->av.mac, ah_attr->dmac, sizeof(ah_attr->dmac));\r\nret = ib_get_cached_gid(ibpd->device, ah_attr->port_num,\r\nah_attr->grh.sgid_index, &sgid, &gid_attr);\r\nif (ret) {\r\ndev_err(dev, "get sgid failed! ret = %d\n", ret);\r\nkfree(ah);\r\nreturn ERR_PTR(ret);\r\n}\r\nif (gid_attr.ndev) {\r\nif (is_vlan_dev(gid_attr.ndev))\r\nvlan_tag = vlan_dev_vlan_id(gid_attr.ndev);\r\ndev_put(gid_attr.ndev);\r\n}\r\nif (vlan_tag < 0x1000)\r\nvlan_tag |= (ah_attr->sl & HNS_ROCE_VLAN_SL_BIT_MASK) <<\r\nHNS_ROCE_VLAN_SL_SHIFT;\r\nah->av.port_pd = cpu_to_be32(to_hr_pd(ibpd)->pdn | (ah_attr->port_num <<\r\nHNS_ROCE_PORT_NUM_SHIFT));\r\nah->av.gid_index = ah_attr->grh.sgid_index;\r\nah->av.vlan = cpu_to_le16(vlan_tag);\r\ndev_dbg(dev, "gid_index = 0x%x,vlan = 0x%x\n", ah->av.gid_index,\r\nah->av.vlan);\r\nif (ah_attr->static_rate)\r\nah->av.stat_rate = IB_RATE_10_GBPS;\r\nmemcpy(ah->av.dgid, ah_attr->grh.dgid.raw, HNS_ROCE_GID_SIZE);\r\nah->av.sl_tclass_flowlabel = cpu_to_le32(ah_attr->sl <<\r\nHNS_ROCE_SL_SHIFT);\r\nreturn &ah->ibah;\r\n}\r\nint hns_roce_query_ah(struct ib_ah *ibah, struct ib_ah_attr *ah_attr)\r\n{\r\nstruct hns_roce_ah *ah = to_hr_ah(ibah);\r\nmemset(ah_attr, 0, sizeof(*ah_attr));\r\nah_attr->sl = le32_to_cpu(ah->av.sl_tclass_flowlabel) >>\r\nHNS_ROCE_SL_SHIFT;\r\nah_attr->port_num = le32_to_cpu(ah->av.port_pd) >>\r\nHNS_ROCE_PORT_NUM_SHIFT;\r\nah_attr->static_rate = ah->av.stat_rate;\r\nah_attr->ah_flags = IB_AH_GRH;\r\nah_attr->grh.traffic_class = le32_to_cpu(ah->av.sl_tclass_flowlabel) >>\r\nHNS_ROCE_TCLASS_SHIFT;\r\nah_attr->grh.flow_label = le32_to_cpu(ah->av.sl_tclass_flowlabel) &\r\nHNS_ROCE_FLOW_LABLE_MASK;\r\nah_attr->grh.hop_limit = ah->av.hop_limit;\r\nah_attr->grh.sgid_index = ah->av.gid_index;\r\nmemcpy(ah_attr->grh.dgid.raw, ah->av.dgid, HNS_ROCE_GID_SIZE);\r\nreturn 0;\r\n}\r\nint hns_roce_destroy_ah(struct ib_ah *ah)\r\n{\r\nkfree(to_hr_ah(ah));\r\nreturn 0;\r\n}

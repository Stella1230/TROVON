static int gact_net_rand(struct tcf_gact *gact)\r\n{\r\nsmp_rmb();\r\nif (prandom_u32() % gact->tcfg_pval)\r\nreturn gact->tcf_action;\r\nreturn gact->tcfg_paction;\r\n}\r\nstatic int gact_determ(struct tcf_gact *gact)\r\n{\r\nu32 pack = atomic_inc_return(&gact->packets);\r\nsmp_rmb();\r\nif (pack % gact->tcfg_pval)\r\nreturn gact->tcf_action;\r\nreturn gact->tcfg_paction;\r\n}\r\nstatic int tcf_gact_init(struct net *net, struct nlattr *nla,\r\nstruct nlattr *est, struct tc_action **a,\r\nint ovr, int bind)\r\n{\r\nstruct tc_action_net *tn = net_generic(net, gact_net_id);\r\nstruct nlattr *tb[TCA_GACT_MAX + 1];\r\nstruct tc_gact *parm;\r\nstruct tcf_gact *gact;\r\nint ret = 0;\r\nint err;\r\n#ifdef CONFIG_GACT_PROB\r\nstruct tc_gact_p *p_parm = NULL;\r\n#endif\r\nif (nla == NULL)\r\nreturn -EINVAL;\r\nerr = nla_parse_nested(tb, TCA_GACT_MAX, nla, gact_policy);\r\nif (err < 0)\r\nreturn err;\r\nif (tb[TCA_GACT_PARMS] == NULL)\r\nreturn -EINVAL;\r\nparm = nla_data(tb[TCA_GACT_PARMS]);\r\n#ifndef CONFIG_GACT_PROB\r\nif (tb[TCA_GACT_PROB] != NULL)\r\nreturn -EOPNOTSUPP;\r\n#else\r\nif (tb[TCA_GACT_PROB]) {\r\np_parm = nla_data(tb[TCA_GACT_PROB]);\r\nif (p_parm->ptype >= MAX_RAND)\r\nreturn -EINVAL;\r\n}\r\n#endif\r\nif (!tcf_hash_check(tn, parm->index, a, bind)) {\r\nret = tcf_hash_create(tn, parm->index, est, a,\r\n&act_gact_ops, bind, true);\r\nif (ret)\r\nreturn ret;\r\nret = ACT_P_CREATED;\r\n} else {\r\nif (bind)\r\nreturn 0;\r\ntcf_hash_release(*a, bind);\r\nif (!ovr)\r\nreturn -EEXIST;\r\n}\r\ngact = to_gact(*a);\r\nASSERT_RTNL();\r\ngact->tcf_action = parm->action;\r\n#ifdef CONFIG_GACT_PROB\r\nif (p_parm) {\r\ngact->tcfg_paction = p_parm->paction;\r\ngact->tcfg_pval = max_t(u16, 1, p_parm->pval);\r\nsmp_wmb();\r\ngact->tcfg_ptype = p_parm->ptype;\r\n}\r\n#endif\r\nif (ret == ACT_P_CREATED)\r\ntcf_hash_insert(tn, *a);\r\nreturn ret;\r\n}\r\nstatic int tcf_gact(struct sk_buff *skb, const struct tc_action *a,\r\nstruct tcf_result *res)\r\n{\r\nstruct tcf_gact *gact = to_gact(a);\r\nint action = READ_ONCE(gact->tcf_action);\r\n#ifdef CONFIG_GACT_PROB\r\n{\r\nu32 ptype = READ_ONCE(gact->tcfg_ptype);\r\nif (ptype)\r\naction = gact_rand[ptype](gact);\r\n}\r\n#endif\r\nbstats_cpu_update(this_cpu_ptr(gact->common.cpu_bstats), skb);\r\nif (action == TC_ACT_SHOT)\r\nqstats_drop_inc(this_cpu_ptr(gact->common.cpu_qstats));\r\ntcf_lastuse_update(&gact->tcf_tm);\r\nreturn action;\r\n}\r\nstatic void tcf_gact_stats_update(struct tc_action *a, u64 bytes, u32 packets,\r\nu64 lastuse)\r\n{\r\nstruct tcf_gact *gact = to_gact(a);\r\nint action = READ_ONCE(gact->tcf_action);\r\nstruct tcf_t *tm = &gact->tcf_tm;\r\n_bstats_cpu_update(this_cpu_ptr(gact->common.cpu_bstats), bytes,\r\npackets);\r\nif (action == TC_ACT_SHOT)\r\nthis_cpu_ptr(gact->common.cpu_qstats)->drops += packets;\r\ntm->lastuse = lastuse;\r\n}\r\nstatic int tcf_gact_dump(struct sk_buff *skb, struct tc_action *a,\r\nint bind, int ref)\r\n{\r\nunsigned char *b = skb_tail_pointer(skb);\r\nstruct tcf_gact *gact = to_gact(a);\r\nstruct tc_gact opt = {\r\n.index = gact->tcf_index,\r\n.refcnt = gact->tcf_refcnt - ref,\r\n.bindcnt = gact->tcf_bindcnt - bind,\r\n.action = gact->tcf_action,\r\n};\r\nstruct tcf_t t;\r\nif (nla_put(skb, TCA_GACT_PARMS, sizeof(opt), &opt))\r\ngoto nla_put_failure;\r\n#ifdef CONFIG_GACT_PROB\r\nif (gact->tcfg_ptype) {\r\nstruct tc_gact_p p_opt = {\r\n.paction = gact->tcfg_paction,\r\n.pval = gact->tcfg_pval,\r\n.ptype = gact->tcfg_ptype,\r\n};\r\nif (nla_put(skb, TCA_GACT_PROB, sizeof(p_opt), &p_opt))\r\ngoto nla_put_failure;\r\n}\r\n#endif\r\ntcf_tm_dump(&t, &gact->tcf_tm);\r\nif (nla_put_64bit(skb, TCA_GACT_TM, sizeof(t), &t, TCA_GACT_PAD))\r\ngoto nla_put_failure;\r\nreturn skb->len;\r\nnla_put_failure:\r\nnlmsg_trim(skb, b);\r\nreturn -1;\r\n}\r\nstatic int tcf_gact_walker(struct net *net, struct sk_buff *skb,\r\nstruct netlink_callback *cb, int type,\r\nconst struct tc_action_ops *ops)\r\n{\r\nstruct tc_action_net *tn = net_generic(net, gact_net_id);\r\nreturn tcf_generic_walker(tn, skb, cb, type, ops);\r\n}\r\nstatic int tcf_gact_search(struct net *net, struct tc_action **a, u32 index)\r\n{\r\nstruct tc_action_net *tn = net_generic(net, gact_net_id);\r\nreturn tcf_hash_search(tn, a, index);\r\n}\r\nstatic __net_init int gact_init_net(struct net *net)\r\n{\r\nstruct tc_action_net *tn = net_generic(net, gact_net_id);\r\nreturn tc_action_net_init(tn, &act_gact_ops, GACT_TAB_MASK);\r\n}\r\nstatic void __net_exit gact_exit_net(struct net *net)\r\n{\r\nstruct tc_action_net *tn = net_generic(net, gact_net_id);\r\ntc_action_net_exit(tn);\r\n}\r\nstatic int __init gact_init_module(void)\r\n{\r\n#ifdef CONFIG_GACT_PROB\r\npr_info("GACT probability on\n");\r\n#else\r\npr_info("GACT probability NOT on\n");\r\n#endif\r\nreturn tcf_register_action(&act_gact_ops, &gact_net_ops);\r\n}\r\nstatic void __exit gact_cleanup_module(void)\r\n{\r\ntcf_unregister_action(&act_gact_ops, &gact_net_ops);\r\n}

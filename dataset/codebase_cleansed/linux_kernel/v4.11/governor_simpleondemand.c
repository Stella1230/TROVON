static int devfreq_simple_ondemand_func(struct devfreq *df,\r\nunsigned long *freq)\r\n{\r\nint err;\r\nstruct devfreq_dev_status *stat;\r\nunsigned long long a, b;\r\nunsigned int dfso_upthreshold = DFSO_UPTHRESHOLD;\r\nunsigned int dfso_downdifferential = DFSO_DOWNDIFFERENCTIAL;\r\nstruct devfreq_simple_ondemand_data *data = df->data;\r\nunsigned long max = (df->max_freq) ? df->max_freq : UINT_MAX;\r\nerr = devfreq_update_stats(df);\r\nif (err)\r\nreturn err;\r\nstat = &df->last_status;\r\nif (data) {\r\nif (data->upthreshold)\r\ndfso_upthreshold = data->upthreshold;\r\nif (data->downdifferential)\r\ndfso_downdifferential = data->downdifferential;\r\n}\r\nif (dfso_upthreshold > 100 ||\r\ndfso_upthreshold < dfso_downdifferential)\r\nreturn -EINVAL;\r\nif (stat->total_time == 0) {\r\n*freq = max;\r\nreturn 0;\r\n}\r\nif (stat->busy_time >= (1 << 24) || stat->total_time >= (1 << 24)) {\r\nstat->busy_time >>= 7;\r\nstat->total_time >>= 7;\r\n}\r\nif (stat->busy_time * 100 >\r\nstat->total_time * dfso_upthreshold) {\r\n*freq = max;\r\nreturn 0;\r\n}\r\nif (stat->current_frequency == 0) {\r\n*freq = max;\r\nreturn 0;\r\n}\r\nif (stat->busy_time * 100 >\r\nstat->total_time * (dfso_upthreshold - dfso_downdifferential)) {\r\n*freq = stat->current_frequency;\r\nreturn 0;\r\n}\r\na = stat->busy_time;\r\na *= stat->current_frequency;\r\nb = div_u64(a, stat->total_time);\r\nb *= 100;\r\nb = div_u64(b, (dfso_upthreshold - dfso_downdifferential / 2));\r\n*freq = (unsigned long) b;\r\nif (df->min_freq && *freq < df->min_freq)\r\n*freq = df->min_freq;\r\nif (df->max_freq && *freq > df->max_freq)\r\n*freq = df->max_freq;\r\nreturn 0;\r\n}\r\nstatic int devfreq_simple_ondemand_handler(struct devfreq *devfreq,\r\nunsigned int event, void *data)\r\n{\r\nswitch (event) {\r\ncase DEVFREQ_GOV_START:\r\ndevfreq_monitor_start(devfreq);\r\nbreak;\r\ncase DEVFREQ_GOV_STOP:\r\ndevfreq_monitor_stop(devfreq);\r\nbreak;\r\ncase DEVFREQ_GOV_INTERVAL:\r\ndevfreq_interval_update(devfreq, (unsigned int *)data);\r\nbreak;\r\ncase DEVFREQ_GOV_SUSPEND:\r\ndevfreq_monitor_suspend(devfreq);\r\nbreak;\r\ncase DEVFREQ_GOV_RESUME:\r\ndevfreq_monitor_resume(devfreq);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init devfreq_simple_ondemand_init(void)\r\n{\r\nreturn devfreq_add_governor(&devfreq_simple_ondemand);\r\n}\r\nstatic void __exit devfreq_simple_ondemand_exit(void)\r\n{\r\nint ret;\r\nret = devfreq_remove_governor(&devfreq_simple_ondemand);\r\nif (ret)\r\npr_err("%s: failed remove governor %d\n", __func__, ret);\r\nreturn;\r\n}

static void tea5761_status_dump(unsigned char *buffer)\r\n{\r\nunsigned int div, frq;\r\ndiv = ((buffer[2] & 0x3f) << 8) | buffer[3];\r\nfrq = 1000 * (div * 32768 / 1000 + FREQ_OFFSET + 225) / 4;\r\nprintk(KERN_INFO "tea5761: Frequency %d.%03d KHz (divider = 0x%04x)\n",\r\nfrq / 1000, frq % 1000, div);\r\n}\r\nstatic int __set_radio_freq(struct dvb_frontend *fe,\r\nunsigned int freq,\r\nbool mono)\r\n{\r\nstruct tea5761_priv *priv = fe->tuner_priv;\r\nunsigned int frq = freq;\r\nunsigned char buffer[7] = {0, 0, 0, 0, 0, 0, 0 };\r\nunsigned div;\r\nint rc;\r\ntuner_dbg("radio freq counter %d\n", frq);\r\nif (priv->standby) {\r\ntuner_dbg("TEA5761 set to standby mode\n");\r\nbuffer[5] |= TEA5761_TNCTRL_MU;\r\n} else {\r\nbuffer[4] |= TEA5761_TNCTRL_PUPD_0;\r\n}\r\nif (mono) {\r\ntuner_dbg("TEA5761 set to mono\n");\r\nbuffer[5] |= TEA5761_TNCTRL_MST;\r\n} else {\r\ntuner_dbg("TEA5761 set to stereo\n");\r\n}\r\ndiv = (1000 * (frq * 4 / 16 + 700 + 225) ) >> 15;\r\nbuffer[1] = (div >> 8) & 0x3f;\r\nbuffer[2] = div & 0xff;\r\nif (debug)\r\ntea5761_status_dump(buffer);\r\nif (7 != (rc = tuner_i2c_xfer_send(&priv->i2c_props, buffer, 7)))\r\ntuner_warn("i2c i/o error: rc == %d (should be 5)\n", rc);\r\npriv->frequency = frq * 125 / 2;\r\nreturn 0;\r\n}\r\nstatic int set_radio_freq(struct dvb_frontend *fe,\r\nstruct analog_parameters *params)\r\n{\r\nstruct tea5761_priv *priv = fe->analog_demod_priv;\r\npriv->standby = false;\r\nreturn __set_radio_freq(fe, params->frequency,\r\nparams->audmode == V4L2_TUNER_MODE_MONO);\r\n}\r\nstatic int set_radio_sleep(struct dvb_frontend *fe)\r\n{\r\nstruct tea5761_priv *priv = fe->analog_demod_priv;\r\npriv->standby = true;\r\nreturn __set_radio_freq(fe, priv->frequency, false);\r\n}\r\nstatic int tea5761_read_status(struct dvb_frontend *fe, char *buffer)\r\n{\r\nstruct tea5761_priv *priv = fe->tuner_priv;\r\nint rc;\r\nmemset(buffer, 0, 16);\r\nif (16 != (rc = tuner_i2c_xfer_recv(&priv->i2c_props, buffer, 16))) {\r\ntuner_warn("i2c i/o error: rc == %d (should be 16)\n", rc);\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int tea5761_signal(struct dvb_frontend *fe, const char *buffer)\r\n{\r\nstruct tea5761_priv *priv = fe->tuner_priv;\r\nint signal = ((buffer[9] & TEA5761_TUNCHECK_LEV_MASK) << (13 - 4));\r\ntuner_dbg("Signal strength: %d\n", signal);\r\nreturn signal;\r\n}\r\nstatic inline int tea5761_stereo(struct dvb_frontend *fe, const char *buffer)\r\n{\r\nstruct tea5761_priv *priv = fe->tuner_priv;\r\nint stereo = buffer[9] & TEA5761_TUNCHECK_STEREO;\r\ntuner_dbg("Radio ST GET = %02x\n", stereo);\r\nreturn (stereo ? V4L2_TUNER_SUB_STEREO : 0);\r\n}\r\nstatic int tea5761_get_status(struct dvb_frontend *fe, u32 *status)\r\n{\r\nunsigned char buffer[16];\r\n*status = 0;\r\nif (0 == tea5761_read_status(fe, buffer)) {\r\nif (tea5761_signal(fe, buffer))\r\n*status = TUNER_STATUS_LOCKED;\r\nif (tea5761_stereo(fe, buffer))\r\n*status |= TUNER_STATUS_STEREO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tea5761_get_rf_strength(struct dvb_frontend *fe, u16 *strength)\r\n{\r\nunsigned char buffer[16];\r\n*strength = 0;\r\nif (0 == tea5761_read_status(fe, buffer))\r\n*strength = tea5761_signal(fe, buffer);\r\nreturn 0;\r\n}\r\nint tea5761_autodetection(struct i2c_adapter* i2c_adap, u8 i2c_addr)\r\n{\r\nunsigned char buffer[16];\r\nint rc;\r\nstruct tuner_i2c_props i2c = { .adap = i2c_adap, .addr = i2c_addr };\r\nif (16 != (rc = tuner_i2c_xfer_recv(&i2c, buffer, 16))) {\r\nprintk(KERN_WARNING "it is not a TEA5761. Received %i chars.\n", rc);\r\nreturn -EINVAL;\r\n}\r\nif ((buffer[13] != 0x2b) || (buffer[14] != 0x57) || (buffer[15] != 0x061)) {\r\nprintk(KERN_WARNING "Manufacturer ID= 0x%02x, Chip ID = %02x%02x. It is not a TEA5761\n",\r\nbuffer[13], buffer[14], buffer[15]);\r\nreturn -EINVAL;\r\n}\r\nprintk(KERN_WARNING "tea5761: TEA%02x%02x detected. Manufacturer ID= 0x%02x\n",\r\nbuffer[14], buffer[15], buffer[13]);\r\nreturn 0;\r\n}\r\nstatic void tea5761_release(struct dvb_frontend *fe)\r\n{\r\nkfree(fe->tuner_priv);\r\nfe->tuner_priv = NULL;\r\n}\r\nstatic int tea5761_get_frequency(struct dvb_frontend *fe, u32 *frequency)\r\n{\r\nstruct tea5761_priv *priv = fe->tuner_priv;\r\n*frequency = priv->frequency;\r\nreturn 0;\r\n}\r\nstruct dvb_frontend *tea5761_attach(struct dvb_frontend *fe,\r\nstruct i2c_adapter* i2c_adap,\r\nu8 i2c_addr)\r\n{\r\nstruct tea5761_priv *priv = NULL;\r\nif (tea5761_autodetection(i2c_adap, i2c_addr) != 0)\r\nreturn NULL;\r\npriv = kzalloc(sizeof(struct tea5761_priv), GFP_KERNEL);\r\nif (priv == NULL)\r\nreturn NULL;\r\nfe->tuner_priv = priv;\r\npriv->i2c_props.addr = i2c_addr;\r\npriv->i2c_props.adap = i2c_adap;\r\npriv->i2c_props.name = "tea5761";\r\nmemcpy(&fe->ops.tuner_ops, &tea5761_tuner_ops,\r\nsizeof(struct dvb_tuner_ops));\r\ntuner_info("type set to %s\n", "Philips TEA5761HN FM Radio");\r\nreturn fe;\r\n}

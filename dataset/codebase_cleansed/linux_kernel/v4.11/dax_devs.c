static void nd_dax_release(struct device *dev)\r\n{\r\nstruct nd_region *nd_region = to_nd_region(dev->parent);\r\nstruct nd_dax *nd_dax = to_nd_dax(dev);\r\nstruct nd_pfn *nd_pfn = &nd_dax->nd_pfn;\r\ndev_dbg(dev, "%s\n", __func__);\r\nnd_detach_ndns(dev, &nd_pfn->ndns);\r\nida_simple_remove(&nd_region->dax_ida, nd_pfn->id);\r\nkfree(nd_pfn->uuid);\r\nkfree(nd_dax);\r\n}\r\nbool is_nd_dax(struct device *dev)\r\n{\r\nreturn dev ? dev->type == &nd_dax_device_type : false;\r\n}\r\nstruct nd_dax *to_nd_dax(struct device *dev)\r\n{\r\nstruct nd_dax *nd_dax = container_of(dev, struct nd_dax, nd_pfn.dev);\r\nWARN_ON(!is_nd_dax(dev));\r\nreturn nd_dax;\r\n}\r\nstatic struct nd_dax *nd_dax_alloc(struct nd_region *nd_region)\r\n{\r\nstruct nd_pfn *nd_pfn;\r\nstruct nd_dax *nd_dax;\r\nstruct device *dev;\r\nnd_dax = kzalloc(sizeof(*nd_dax), GFP_KERNEL);\r\nif (!nd_dax)\r\nreturn NULL;\r\nnd_pfn = &nd_dax->nd_pfn;\r\nnd_pfn->id = ida_simple_get(&nd_region->dax_ida, 0, 0, GFP_KERNEL);\r\nif (nd_pfn->id < 0) {\r\nkfree(nd_dax);\r\nreturn NULL;\r\n}\r\ndev = &nd_pfn->dev;\r\ndev_set_name(dev, "dax%d.%d", nd_region->id, nd_pfn->id);\r\ndev->groups = nd_dax_attribute_groups;\r\ndev->type = &nd_dax_device_type;\r\ndev->parent = &nd_region->dev;\r\nreturn nd_dax;\r\n}\r\nstruct device *nd_dax_create(struct nd_region *nd_region)\r\n{\r\nstruct device *dev = NULL;\r\nstruct nd_dax *nd_dax;\r\nif (!is_nd_pmem(&nd_region->dev))\r\nreturn NULL;\r\nnd_dax = nd_dax_alloc(nd_region);\r\nif (nd_dax)\r\ndev = nd_pfn_devinit(&nd_dax->nd_pfn, NULL);\r\n__nd_device_register(dev);\r\nreturn dev;\r\n}\r\nint nd_dax_probe(struct device *dev, struct nd_namespace_common *ndns)\r\n{\r\nint rc;\r\nstruct nd_dax *nd_dax;\r\nstruct device *dax_dev;\r\nstruct nd_pfn *nd_pfn;\r\nstruct nd_pfn_sb *pfn_sb;\r\nstruct nd_region *nd_region = to_nd_region(ndns->dev.parent);\r\nif (ndns->force_raw)\r\nreturn -ENODEV;\r\nnvdimm_bus_lock(&ndns->dev);\r\nnd_dax = nd_dax_alloc(nd_region);\r\nnd_pfn = &nd_dax->nd_pfn;\r\ndax_dev = nd_pfn_devinit(nd_pfn, ndns);\r\nnvdimm_bus_unlock(&ndns->dev);\r\nif (!dax_dev)\r\nreturn -ENOMEM;\r\npfn_sb = devm_kzalloc(dev, sizeof(*pfn_sb), GFP_KERNEL);\r\nnd_pfn->pfn_sb = pfn_sb;\r\nrc = nd_pfn_validate(nd_pfn, DAX_SIG);\r\ndev_dbg(dev, "%s: dax: %s\n", __func__,\r\nrc == 0 ? dev_name(dax_dev) : "<none>");\r\nif (rc < 0) {\r\n__nd_detach_ndns(dax_dev, &nd_pfn->ndns);\r\nput_device(dax_dev);\r\n} else\r\n__nd_device_register(dax_dev);\r\nreturn rc;\r\n}

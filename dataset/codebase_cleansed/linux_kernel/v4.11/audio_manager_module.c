static ssize_t gb_audio_module_attr_show(\r\nstruct kobject *kobj, struct attribute *attr, char *buf)\r\n{\r\nstruct gb_audio_manager_module_attribute *attribute;\r\nstruct gb_audio_manager_module *module;\r\nattribute = to_gb_audio_module_attr(attr);\r\nmodule = to_gb_audio_module(kobj);\r\nif (!attribute->show)\r\nreturn -EIO;\r\nreturn attribute->show(module, attribute, buf);\r\n}\r\nstatic ssize_t gb_audio_module_attr_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct gb_audio_manager_module_attribute *attribute;\r\nstruct gb_audio_manager_module *module;\r\nattribute = to_gb_audio_module_attr(attr);\r\nmodule = to_gb_audio_module(kobj);\r\nif (!attribute->store)\r\nreturn -EIO;\r\nreturn attribute->store(module, attribute, buf, len);\r\n}\r\nstatic void gb_audio_module_release(struct kobject *kobj)\r\n{\r\nstruct gb_audio_manager_module *module = to_gb_audio_module(kobj);\r\npr_info("Destroying audio module #%d\n", module->id);\r\nkfree(module);\r\n}\r\nstatic ssize_t gb_audio_module_name_show(\r\nstruct gb_audio_manager_module *module,\r\nstruct gb_audio_manager_module_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%s", module->desc.name);\r\n}\r\nstatic ssize_t gb_audio_module_vid_show(\r\nstruct gb_audio_manager_module *module,\r\nstruct gb_audio_manager_module_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%d", module->desc.vid);\r\n}\r\nstatic ssize_t gb_audio_module_pid_show(\r\nstruct gb_audio_manager_module *module,\r\nstruct gb_audio_manager_module_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%d", module->desc.pid);\r\n}\r\nstatic ssize_t gb_audio_module_intf_id_show(\r\nstruct gb_audio_manager_module *module,\r\nstruct gb_audio_manager_module_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%d", module->desc.intf_id);\r\n}\r\nstatic ssize_t gb_audio_module_ip_devices_show(\r\nstruct gb_audio_manager_module *module,\r\nstruct gb_audio_manager_module_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "0x%X", module->desc.ip_devices);\r\n}\r\nstatic ssize_t gb_audio_module_op_devices_show(\r\nstruct gb_audio_manager_module *module,\r\nstruct gb_audio_manager_module_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "0x%X", module->desc.op_devices);\r\n}\r\nstatic void send_add_uevent(struct gb_audio_manager_module *module)\r\n{\r\nchar name_string[128];\r\nchar vid_string[64];\r\nchar pid_string[64];\r\nchar intf_id_string[64];\r\nchar ip_devices_string[64];\r\nchar op_devices_string[64];\r\nchar *envp[] = {\r\nname_string,\r\nvid_string,\r\npid_string,\r\nintf_id_string,\r\nip_devices_string,\r\nop_devices_string,\r\nNULL\r\n};\r\nsnprintf(name_string, 128, "NAME=%s", module->desc.name);\r\nsnprintf(vid_string, 64, "VID=%d", module->desc.vid);\r\nsnprintf(pid_string, 64, "PID=%d", module->desc.pid);\r\nsnprintf(intf_id_string, 64, "INTF_ID=%d", module->desc.intf_id);\r\nsnprintf(ip_devices_string, 64, "I/P DEVICES=0x%X",\r\nmodule->desc.ip_devices);\r\nsnprintf(op_devices_string, 64, "O/P DEVICES=0x%X",\r\nmodule->desc.op_devices);\r\nkobject_uevent_env(&module->kobj, KOBJ_ADD, envp);\r\n}\r\nint gb_audio_manager_module_create(\r\nstruct gb_audio_manager_module **module,\r\nstruct kset *manager_kset,\r\nint id, struct gb_audio_manager_module_descriptor *desc)\r\n{\r\nint err;\r\nstruct gb_audio_manager_module *m;\r\nm = kzalloc(sizeof(*m), GFP_ATOMIC);\r\nif (!m)\r\nreturn -ENOMEM;\r\nINIT_LIST_HEAD(&m->list);\r\nm->id = id;\r\nmemcpy(&m->desc, desc, sizeof(*desc));\r\nm->kobj.kset = manager_kset;\r\nerr = kobject_init_and_add(&m->kobj, &gb_audio_module_type, NULL, "%d",\r\nid);\r\nif (err) {\r\npr_err("failed initializing kobject for audio module #%d\n",\r\nid);\r\nkobject_put(&m->kobj);\r\nreturn err;\r\n}\r\nsend_add_uevent(m);\r\n*module = m;\r\npr_info("Created audio module #%d\n", id);\r\nreturn 0;\r\n}\r\nvoid gb_audio_manager_module_dump(struct gb_audio_manager_module *module)\r\n{\r\npr_info("audio module #%d name=%s vid=%d pid=%d intf_id=%d i/p devices=0x%X o/p devices=0x%X\n",\r\nmodule->id,\r\nmodule->desc.name,\r\nmodule->desc.vid,\r\nmodule->desc.pid,\r\nmodule->desc.intf_id,\r\nmodule->desc.ip_devices,\r\nmodule->desc.op_devices);\r\n}

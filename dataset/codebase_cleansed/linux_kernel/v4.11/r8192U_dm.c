void init_hal_dm(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\npriv->undecorated_smoothed_pwdb = -1;\r\ndm_init_dynamic_txpower(dev);\r\ninit_rate_adaptive(dev);\r\ndm_dig_init(dev);\r\ndm_init_edca_turbo(dev);\r\ndm_init_bandwidth_autoswitch(dev);\r\ndm_init_fsync(dev);\r\ndm_init_rxpath_selection(dev);\r\ndm_init_ctstoself(dev);\r\n}\r\nvoid deinit_hal_dm(struct net_device *dev)\r\n{\r\ndm_deInit_fsync(dev);\r\n}\r\nvoid dm_CheckRxAggregation(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nPRT_HIGH_THROUGHPUT pHTInfo = priv->ieee80211->pHTInfo;\r\nstatic unsigned long lastTxOkCnt;\r\nstatic unsigned long lastRxOkCnt;\r\nunsigned long curTxOkCnt = 0;\r\nunsigned long curRxOkCnt = 0;\r\ncurTxOkCnt = priv->stats.txbytesunicast - lastTxOkCnt;\r\ncurRxOkCnt = priv->stats.rxbytesunicast - lastRxOkCnt;\r\nif ((curTxOkCnt + curRxOkCnt) < 15000000)\r\nreturn;\r\nif (curTxOkCnt > 4*curRxOkCnt) {\r\nif (priv->bCurrentRxAggrEnable) {\r\nwrite_nic_dword(dev, 0x1a8, 0);\r\npriv->bCurrentRxAggrEnable = false;\r\n}\r\n} else {\r\nif (!priv->bCurrentRxAggrEnable && !pHTInfo->bCurrentRT2RTAggregation) {\r\nu32 ulValue;\r\nulValue = (pHTInfo->UsbRxFwAggrEn<<24) | (pHTInfo->UsbRxFwAggrPageNum<<16) |\r\n(pHTInfo->UsbRxFwAggrPacketNum<<8) | (pHTInfo->UsbRxFwAggrTimeout);\r\nwrite_nic_dword(dev, 0x1a8, ulValue);\r\npriv->bCurrentRxAggrEnable = true;\r\n}\r\n}\r\nlastTxOkCnt = priv->stats.txbytesunicast;\r\nlastRxOkCnt = priv->stats.rxbytesunicast;\r\n}\r\nvoid hal_dm_watchdog(struct net_device *dev)\r\n{\r\ndm_check_rate_adaptive(dev);\r\ndm_dynamic_txpower(dev);\r\ndm_check_txrateandretrycount(dev);\r\ndm_check_txpower_tracking(dev);\r\ndm_ctrl_initgain_byrssi(dev);\r\ndm_check_edca_turbo(dev);\r\ndm_bandwidth_autoswitch(dev);\r\ndm_check_rx_path_selection(dev);\r\ndm_check_fsync(dev);\r\ndm_check_pbc_gpio(dev);\r\ndm_send_rssi_tofw(dev);\r\ndm_ctstoself(dev);\r\n#ifdef USB_RX_AGGREGATION_SUPPORT\r\ndm_CheckRxAggregation(dev);\r\n#endif\r\n}\r\nvoid init_rate_adaptive(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nprate_adaptive pra = (prate_adaptive)&priv->rate_adaptive;\r\npra->ratr_state = DM_RATR_STA_MAX;\r\npra->high2low_rssi_thresh_for_ra = RateAdaptiveTH_High;\r\npra->low2high_rssi_thresh_for_ra20M = RateAdaptiveTH_Low_20M+5;\r\npra->low2high_rssi_thresh_for_ra40M = RateAdaptiveTH_Low_40M+5;\r\npra->high_rssi_thresh_for_ra = RateAdaptiveTH_High+5;\r\npra->low_rssi_thresh_for_ra20M = RateAdaptiveTH_Low_20M;\r\npra->low_rssi_thresh_for_ra40M = RateAdaptiveTH_Low_40M;\r\nif (priv->CustomerID == RT_CID_819x_Netcore)\r\npra->ping_rssi_enable = 1;\r\nelse\r\npra->ping_rssi_enable = 0;\r\npra->ping_rssi_thresh_for_ra = 15;\r\nif (priv->rf_type == RF_2T4R) {\r\npra->upper_rssi_threshold_ratr = 0x8f0f0000;\r\npra->middle_rssi_threshold_ratr = 0x8f0ff000;\r\npra->low_rssi_threshold_ratr = 0x8f0ff001;\r\npra->low_rssi_threshold_ratr_40M = 0x8f0ff005;\r\npra->low_rssi_threshold_ratr_20M = 0x8f0ff001;\r\npra->ping_rssi_ratr = 0x0000000d;\r\n} else if (priv->rf_type == RF_1T2R) {\r\npra->upper_rssi_threshold_ratr = 0x000f0000;\r\npra->middle_rssi_threshold_ratr = 0x000ff000;\r\npra->low_rssi_threshold_ratr = 0x000ff001;\r\npra->low_rssi_threshold_ratr_40M = 0x000ff005;\r\npra->low_rssi_threshold_ratr_20M = 0x000ff001;\r\npra->ping_rssi_ratr = 0x0000000d;\r\n}\r\n}\r\nstatic void dm_check_rate_adaptive(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nPRT_HIGH_THROUGHPUT pHTInfo = priv->ieee80211->pHTInfo;\r\nprate_adaptive pra = (prate_adaptive)&priv->rate_adaptive;\r\nu32 currentRATR, targetRATR = 0;\r\nu32 LowRSSIThreshForRA = 0, HighRSSIThreshForRA = 0;\r\nbool bshort_gi_enabled = false;\r\nstatic u8 ping_rssi_state;\r\nif (!priv->up) {\r\nRT_TRACE(COMP_RATE, "<---- dm_check_rate_adaptive(): driver is going to unload\n");\r\nreturn;\r\n}\r\nif (pra->rate_adaptive_disabled)\r\nreturn;\r\nif (!(priv->ieee80211->mode == WIRELESS_MODE_N_24G ||\r\npriv->ieee80211->mode == WIRELESS_MODE_N_5G))\r\nreturn;\r\nif (priv->ieee80211->state == IEEE80211_LINKED) {\r\nbshort_gi_enabled = (pHTInfo->bCurTxBW40MHz && pHTInfo->bCurShortGI40MHz) ||\r\n(!pHTInfo->bCurTxBW40MHz && pHTInfo->bCurShortGI20MHz);\r\npra->upper_rssi_threshold_ratr =\r\n(pra->upper_rssi_threshold_ratr & (~BIT(31))) |\r\n((bshort_gi_enabled) ? BIT(31) : 0);\r\npra->middle_rssi_threshold_ratr =\r\n(pra->middle_rssi_threshold_ratr & (~BIT(31))) |\r\n((bshort_gi_enabled) ? BIT(31) : 0);\r\nif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\r\npra->low_rssi_threshold_ratr =\r\n(pra->low_rssi_threshold_ratr_40M & (~BIT(31))) |\r\n((bshort_gi_enabled) ? BIT(31) : 0);\r\n} else {\r\npra->low_rssi_threshold_ratr =\r\n(pra->low_rssi_threshold_ratr_20M & (~BIT(31))) |\r\n((bshort_gi_enabled) ? BIT(31) : 0);\r\n}\r\npra->ping_rssi_ratr =\r\n(pra->ping_rssi_ratr & (~BIT(31))) |\r\n((bshort_gi_enabled) ? BIT(31) : 0);\r\nif (pra->ratr_state == DM_RATR_STA_HIGH) {\r\nHighRSSIThreshForRA = pra->high2low_rssi_thresh_for_ra;\r\nLowRSSIThreshForRA = (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) ?\r\n(pra->low_rssi_thresh_for_ra40M):(pra->low_rssi_thresh_for_ra20M);\r\n} else if (pra->ratr_state == DM_RATR_STA_LOW) {\r\nHighRSSIThreshForRA = pra->high_rssi_thresh_for_ra;\r\nLowRSSIThreshForRA = (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) ?\r\n(pra->low2high_rssi_thresh_for_ra40M):(pra->low2high_rssi_thresh_for_ra20M);\r\n} else {\r\nHighRSSIThreshForRA = pra->high_rssi_thresh_for_ra;\r\nLowRSSIThreshForRA = (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) ?\r\n(pra->low_rssi_thresh_for_ra40M):(pra->low_rssi_thresh_for_ra20M);\r\n}\r\nif (priv->undecorated_smoothed_pwdb >= (long)HighRSSIThreshForRA) {\r\npra->ratr_state = DM_RATR_STA_HIGH;\r\ntargetRATR = pra->upper_rssi_threshold_ratr;\r\n} else if (priv->undecorated_smoothed_pwdb >= (long)LowRSSIThreshForRA) {\r\npra->ratr_state = DM_RATR_STA_MIDDLE;\r\ntargetRATR = pra->middle_rssi_threshold_ratr;\r\n} else {\r\npra->ratr_state = DM_RATR_STA_LOW;\r\ntargetRATR = pra->low_rssi_threshold_ratr;\r\n}\r\nif (pra->ping_rssi_enable) {\r\nif (priv->undecorated_smoothed_pwdb < (long)(pra->ping_rssi_thresh_for_ra+5)) {\r\nif ((priv->undecorated_smoothed_pwdb < (long)pra->ping_rssi_thresh_for_ra) ||\r\nping_rssi_state) {\r\npra->ratr_state = DM_RATR_STA_LOW;\r\ntargetRATR = pra->ping_rssi_ratr;\r\nping_rssi_state = 1;\r\n}\r\n} else {\r\nping_rssi_state = 0;\r\n}\r\n}\r\nif (priv->ieee80211->GetHalfNmodeSupportByAPsHandler(dev))\r\ntargetRATR &= 0xf00fffff;\r\nread_nic_dword(dev, RATR0, &currentRATR);\r\nif (targetRATR != currentRATR) {\r\nu32 ratr_value;\r\nratr_value = targetRATR;\r\nRT_TRACE(COMP_RATE, "currentRATR = %x, targetRATR = %x\n", currentRATR, targetRATR);\r\nif (priv->rf_type == RF_1T2R)\r\nratr_value &= ~(RATE_ALL_OFDM_2SS);\r\nwrite_nic_dword(dev, RATR0, ratr_value);\r\nwrite_nic_byte(dev, UFWP, 1);\r\npra->last_ratr = targetRATR;\r\n}\r\n} else {\r\npra->ratr_state = DM_RATR_STA_MAX;\r\n}\r\n}\r\nstatic void dm_init_bandwidth_autoswitch(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\npriv->ieee80211->bandwidth_auto_switch.threshold_20Mhzto40Mhz = BW_AUTO_SWITCH_LOW_HIGH;\r\npriv->ieee80211->bandwidth_auto_switch.threshold_40Mhzto20Mhz = BW_AUTO_SWITCH_HIGH_LOW;\r\npriv->ieee80211->bandwidth_auto_switch.bforced_tx20Mhz = false;\r\npriv->ieee80211->bandwidth_auto_switch.bautoswitch_enable = false;\r\n}\r\nstatic void dm_bandwidth_autoswitch(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nif (priv->CurrentChannelBW == HT_CHANNEL_WIDTH_20 || !priv->ieee80211->bandwidth_auto_switch.bautoswitch_enable)\r\nreturn;\r\nif (!priv->ieee80211->bandwidth_auto_switch.bforced_tx20Mhz) {\r\nif (priv->undecorated_smoothed_pwdb <= priv->ieee80211->bandwidth_auto_switch.threshold_40Mhzto20Mhz)\r\npriv->ieee80211->bandwidth_auto_switch.bforced_tx20Mhz = true;\r\n} else {\r\nif (priv->undecorated_smoothed_pwdb >= priv->ieee80211->bandwidth_auto_switch.threshold_20Mhzto40Mhz)\r\npriv->ieee80211->bandwidth_auto_switch.bforced_tx20Mhz = false;\r\n}\r\n}\r\nstatic void dm_TXPowerTrackingCallback_TSSI(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nbool bHighpowerstate, viviflag = false;\r\nDCMD_TXCMD_T tx_cmd;\r\nu8 powerlevelOFDM24G;\r\nint i = 0, j = 0, k = 0;\r\nu8 RF_Type, tmp_report[5] = {0, 0, 0, 0, 0};\r\nu32 Value;\r\nu8 Pwr_Flag;\r\nu16 Avg_TSSI_Meas, TSSI_13dBm, Avg_TSSI_Meas_from_driver = 0;\r\nbool rtStatus = true;\r\nu32 delta = 0;\r\nwrite_nic_byte(dev, 0x1ba, 0);\r\npriv->ieee80211->bdynamic_txpower_enable = false;\r\nbHighpowerstate = priv->bDynamicTxHighPower;\r\npowerlevelOFDM24G = (u8)(priv->Pwr_Track>>24);\r\nRF_Type = priv->rf_type;\r\nValue = (RF_Type<<8) | powerlevelOFDM24G;\r\nRT_TRACE(COMP_POWER_TRACKING, "powerlevelOFDM24G = %x\n", powerlevelOFDM24G);\r\nfor (j = 0; j <= 30; j++) {\r\ntx_cmd.Op = TXCMD_SET_TX_PWR_TRACKING;\r\ntx_cmd.Length = 4;\r\ntx_cmd.Value = Value;\r\nrtStatus = SendTxCommandPacket(dev, &tx_cmd, 12);\r\nif (rtStatus == RT_STATUS_FAILURE)\r\nRT_TRACE(COMP_POWER_TRACKING, "Set configuration with tx cmd queue fail!\n");\r\nmdelay(1);\r\nfor (i = 0; i <= 30; i++) {\r\nread_nic_byte(dev, 0x1ba, &Pwr_Flag);\r\nif (Pwr_Flag == 0) {\r\nmdelay(1);\r\ncontinue;\r\n}\r\nread_nic_word(dev, 0x13c, &Avg_TSSI_Meas);\r\nif (Avg_TSSI_Meas == 0) {\r\nwrite_nic_byte(dev, 0x1ba, 0);\r\nbreak;\r\n}\r\nfor (k = 0; k < 5; k++) {\r\nif (k != 4)\r\nread_nic_byte(dev, 0x134+k, &tmp_report[k]);\r\nelse\r\nread_nic_byte(dev, 0x13e, &tmp_report[k]);\r\nRT_TRACE(COMP_POWER_TRACKING, "TSSI_report_value = %d\n", tmp_report[k]);\r\n}\r\nfor (k = 0; k < 5; k++) {\r\nif (tmp_report[k] <= 20) {\r\nviviflag = true;\r\nbreak;\r\n}\r\n}\r\nif (viviflag) {\r\nwrite_nic_byte(dev, 0x1ba, 0);\r\nviviflag = false;\r\nRT_TRACE(COMP_POWER_TRACKING, "we filtered the data\n");\r\nfor (k = 0; k < 5; k++)\r\ntmp_report[k] = 0;\r\nbreak;\r\n}\r\nfor (k = 0; k < 5; k++)\r\nAvg_TSSI_Meas_from_driver += tmp_report[k];\r\nAvg_TSSI_Meas_from_driver = Avg_TSSI_Meas_from_driver*100/5;\r\nRT_TRACE(COMP_POWER_TRACKING, "Avg_TSSI_Meas_from_driver = %d\n", Avg_TSSI_Meas_from_driver);\r\nTSSI_13dBm = priv->TSSI_13dBm;\r\nRT_TRACE(COMP_POWER_TRACKING, "TSSI_13dBm = %d\n", TSSI_13dBm);\r\nif (Avg_TSSI_Meas_from_driver > TSSI_13dBm)\r\ndelta = Avg_TSSI_Meas_from_driver - TSSI_13dBm;\r\nelse\r\ndelta = TSSI_13dBm - Avg_TSSI_Meas_from_driver;\r\nif (delta <= E_FOR_TX_POWER_TRACK) {\r\npriv->ieee80211->bdynamic_txpower_enable = true;\r\nwrite_nic_byte(dev, 0x1ba, 0);\r\nRT_TRACE(COMP_POWER_TRACKING, "tx power track is done\n");\r\nRT_TRACE(COMP_POWER_TRACKING, "priv->rfa_txpowertrackingindex = %d\n", priv->rfa_txpowertrackingindex);\r\nRT_TRACE(COMP_POWER_TRACKING, "priv->rfa_txpowertrackingindex_real = %d\n", priv->rfa_txpowertrackingindex_real);\r\nRT_TRACE(COMP_POWER_TRACKING, "priv->cck_present_attentuation_difference = %d\n", priv->cck_present_attentuation_difference);\r\nRT_TRACE(COMP_POWER_TRACKING, "priv->cck_present_attentuation = %d\n", priv->cck_present_attentuation);\r\nreturn;\r\n}\r\nif (Avg_TSSI_Meas_from_driver < TSSI_13dBm - E_FOR_TX_POWER_TRACK) {\r\nif (priv->rfa_txpowertrackingindex > 0) {\r\npriv->rfa_txpowertrackingindex--;\r\nif (priv->rfa_txpowertrackingindex_real > 4) {\r\npriv->rfa_txpowertrackingindex_real--;\r\nrtl8192_setBBreg(dev, rOFDM0_XATxIQImbalance, bMaskDWord, priv->txbbgain_table[priv->rfa_txpowertrackingindex_real].txbbgain_value);\r\n}\r\n}\r\n} else {\r\nif (priv->rfa_txpowertrackingindex < 36) {\r\npriv->rfa_txpowertrackingindex++;\r\npriv->rfa_txpowertrackingindex_real++;\r\nrtl8192_setBBreg(dev, rOFDM0_XATxIQImbalance, bMaskDWord, priv->txbbgain_table[priv->rfa_txpowertrackingindex_real].txbbgain_value);\r\n}\r\n}\r\npriv->cck_present_attentuation_difference\r\n= priv->rfa_txpowertrackingindex - priv->rfa_txpowertracking_default;\r\nif (priv->CurrentChannelBW == HT_CHANNEL_WIDTH_20)\r\npriv->cck_present_attentuation\r\n= priv->cck_present_attentuation_20Mdefault + priv->cck_present_attentuation_difference;\r\nelse\r\npriv->cck_present_attentuation\r\n= priv->cck_present_attentuation_40Mdefault + priv->cck_present_attentuation_difference;\r\nif (priv->cck_present_attentuation > -1 && priv->cck_present_attentuation < 23) {\r\nif (priv->ieee80211->current_network.channel == 14 && !priv->bcck_in_ch14) {\r\npriv->bcck_in_ch14 = true;\r\ndm_cck_txpower_adjust(dev, priv->bcck_in_ch14);\r\n} else if (priv->ieee80211->current_network.channel != 14 && priv->bcck_in_ch14) {\r\npriv->bcck_in_ch14 = false;\r\ndm_cck_txpower_adjust(dev, priv->bcck_in_ch14);\r\n} else\r\ndm_cck_txpower_adjust(dev, priv->bcck_in_ch14);\r\n}\r\nRT_TRACE(COMP_POWER_TRACKING, "priv->rfa_txpowertrackingindex = %d\n", priv->rfa_txpowertrackingindex);\r\nRT_TRACE(COMP_POWER_TRACKING, "priv->rfa_txpowertrackingindex_real = %d\n", priv->rfa_txpowertrackingindex_real);\r\nRT_TRACE(COMP_POWER_TRACKING, "priv->cck_present_attentuation_difference = %d\n", priv->cck_present_attentuation_difference);\r\nRT_TRACE(COMP_POWER_TRACKING, "priv->cck_present_attentuation = %d\n", priv->cck_present_attentuation);\r\nif (priv->cck_present_attentuation_difference <= -12 || priv->cck_present_attentuation_difference >= 24) {\r\npriv->ieee80211->bdynamic_txpower_enable = true;\r\nwrite_nic_byte(dev, 0x1ba, 0);\r\nRT_TRACE(COMP_POWER_TRACKING, "tx power track--->limited\n");\r\nreturn;\r\n}\r\nwrite_nic_byte(dev, 0x1ba, 0);\r\nAvg_TSSI_Meas_from_driver = 0;\r\nfor (k = 0; k < 5; k++)\r\ntmp_report[k] = 0;\r\nbreak;\r\n}\r\n}\r\npriv->ieee80211->bdynamic_txpower_enable = true;\r\nwrite_nic_byte(dev, 0x1ba, 0);\r\n}\r\nstatic void dm_TXPowerTrackingCallback_ThermalMeter(struct net_device *dev)\r\n{\r\n#define ThermalMeterVal 9\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nu32 tmpRegA, TempCCk;\r\nu8 tmpOFDMindex, tmpCCKindex, tmpCCK20Mindex, tmpCCK40Mindex, tmpval;\r\nint i = 0, CCKSwingNeedUpdate = 0;\r\nif (!priv->btxpower_trackingInit) {\r\ntmpRegA = rtl8192_QueryBBReg(dev, rOFDM0_XATxIQImbalance, bMaskDWord);\r\nfor (i = 0; i < OFDM_Table_Length; i++) {\r\nif (tmpRegA == OFDMSwingTable[i]) {\r\npriv->OFDM_index = (u8)i;\r\nRT_TRACE(COMP_POWER_TRACKING, "Initial reg0x%x = 0x%x, OFDM_index=0x%x\n",\r\nrOFDM0_XATxIQImbalance, tmpRegA, priv->OFDM_index);\r\n}\r\n}\r\nTempCCk = rtl8192_QueryBBReg(dev, rCCK0_TxFilter1, bMaskByte2);\r\nfor (i = 0; i < CCK_Table_length; i++) {\r\nif (TempCCk == (u32)CCKSwingTable_Ch1_Ch13[i][0]) {\r\npriv->CCK_index = (u8) i;\r\nRT_TRACE(COMP_POWER_TRACKING, "Initial reg0x%x = 0x%x, CCK_index=0x%x\n",\r\nrCCK0_TxFilter1, TempCCk, priv->CCK_index);\r\nbreak;\r\n}\r\n}\r\npriv->btxpower_trackingInit = true;\r\nreturn;\r\n}\r\ntmpRegA = rtl8192_phy_QueryRFReg(dev, RF90_PATH_A, 0x12, 0x078);\r\nRT_TRACE(COMP_POWER_TRACKING, "Readback ThermalMeterA = %d\n", tmpRegA);\r\nif (tmpRegA < 3 || tmpRegA > 13)\r\nreturn;\r\nif (tmpRegA >= 12)\r\ntmpRegA = 12;\r\nRT_TRACE(COMP_POWER_TRACKING, "Valid ThermalMeterA = %d\n", tmpRegA);\r\npriv->ThermalMeter[0] = ThermalMeterVal;\r\npriv->ThermalMeter[1] = ThermalMeterVal;\r\nif (priv->ThermalMeter[0] >= (u8)tmpRegA) {\r\ntmpOFDMindex = tmpCCK20Mindex = 6+(priv->ThermalMeter[0]-(u8)tmpRegA);\r\ntmpCCK40Mindex = tmpCCK20Mindex - 6;\r\nif (tmpOFDMindex >= OFDM_Table_Length)\r\ntmpOFDMindex = OFDM_Table_Length-1;\r\nif (tmpCCK20Mindex >= CCK_Table_length)\r\ntmpCCK20Mindex = CCK_Table_length-1;\r\nif (tmpCCK40Mindex >= CCK_Table_length)\r\ntmpCCK40Mindex = CCK_Table_length-1;\r\n} else {\r\ntmpval = (u8)tmpRegA - priv->ThermalMeter[0];\r\nif (tmpval >= 6)\r\ntmpOFDMindex = tmpCCK20Mindex = 0;\r\nelse\r\ntmpOFDMindex = tmpCCK20Mindex = 6 - tmpval;\r\ntmpCCK40Mindex = 0;\r\n}\r\nif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20)\r\ntmpCCKindex = tmpCCK40Mindex;\r\nelse\r\ntmpCCKindex = tmpCCK20Mindex;\r\nif (priv->ieee80211->current_network.channel == 14 && !priv->bcck_in_ch14) {\r\npriv->bcck_in_ch14 = true;\r\nCCKSwingNeedUpdate = 1;\r\n} else if (priv->ieee80211->current_network.channel != 14 && priv->bcck_in_ch14) {\r\npriv->bcck_in_ch14 = false;\r\nCCKSwingNeedUpdate = 1;\r\n}\r\nif (priv->CCK_index != tmpCCKindex) {\r\npriv->CCK_index = tmpCCKindex;\r\nCCKSwingNeedUpdate = 1;\r\n}\r\nif (CCKSwingNeedUpdate) {\r\ndm_cck_txpower_adjust(dev, priv->bcck_in_ch14);\r\n}\r\nif (priv->OFDM_index != tmpOFDMindex) {\r\npriv->OFDM_index = tmpOFDMindex;\r\nrtl8192_setBBreg(dev, rOFDM0_XATxIQImbalance, bMaskDWord, OFDMSwingTable[priv->OFDM_index]);\r\nRT_TRACE(COMP_POWER_TRACKING, "Update OFDMSwing[%d] = 0x%x\n",\r\npriv->OFDM_index, OFDMSwingTable[priv->OFDM_index]);\r\n}\r\npriv->txpower_count = 0;\r\n}\r\nvoid dm_txpower_trackingcallback(struct work_struct *work)\r\n{\r\nstruct delayed_work *dwork = to_delayed_work(work);\r\nstruct r8192_priv *priv = container_of(dwork, struct r8192_priv, txpower_tracking_wq);\r\nstruct net_device *dev = priv->ieee80211->dev;\r\nif (priv->bDcut)\r\ndm_TXPowerTrackingCallback_TSSI(dev);\r\nelse\r\ndm_TXPowerTrackingCallback_ThermalMeter(dev);\r\n}\r\nstatic void dm_InitializeTXPowerTracking_TSSI(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\npriv->txbbgain_table[0].txbb_iq_amplifygain = 12;\r\npriv->txbbgain_table[0].txbbgain_value = 0x7f8001fe;\r\npriv->txbbgain_table[1].txbb_iq_amplifygain = 11;\r\npriv->txbbgain_table[1].txbbgain_value = 0x788001e2;\r\npriv->txbbgain_table[2].txbb_iq_amplifygain = 10;\r\npriv->txbbgain_table[2].txbbgain_value = 0x71c001c7;\r\npriv->txbbgain_table[3].txbb_iq_amplifygain = 9;\r\npriv->txbbgain_table[3].txbbgain_value = 0x6b8001ae;\r\npriv->txbbgain_table[4].txbb_iq_amplifygain = 8;\r\npriv->txbbgain_table[4].txbbgain_value = 0x65400195;\r\npriv->txbbgain_table[5].txbb_iq_amplifygain = 7;\r\npriv->txbbgain_table[5].txbbgain_value = 0x5fc0017f;\r\npriv->txbbgain_table[6].txbb_iq_amplifygain = 6;\r\npriv->txbbgain_table[6].txbbgain_value = 0x5a400169;\r\npriv->txbbgain_table[7].txbb_iq_amplifygain = 5;\r\npriv->txbbgain_table[7].txbbgain_value = 0x55400155;\r\npriv->txbbgain_table[8].txbb_iq_amplifygain = 4;\r\npriv->txbbgain_table[8].txbbgain_value = 0x50800142;\r\npriv->txbbgain_table[9].txbb_iq_amplifygain = 3;\r\npriv->txbbgain_table[9].txbbgain_value = 0x4c000130;\r\npriv->txbbgain_table[10].txbb_iq_amplifygain = 2;\r\npriv->txbbgain_table[10].txbbgain_value = 0x47c0011f;\r\npriv->txbbgain_table[11].txbb_iq_amplifygain = 1;\r\npriv->txbbgain_table[11].txbbgain_value = 0x43c0010f;\r\npriv->txbbgain_table[12].txbb_iq_amplifygain = 0;\r\npriv->txbbgain_table[12].txbbgain_value = 0x40000100;\r\npriv->txbbgain_table[13].txbb_iq_amplifygain = -1;\r\npriv->txbbgain_table[13].txbbgain_value = 0x3c8000f2;\r\npriv->txbbgain_table[14].txbb_iq_amplifygain = -2;\r\npriv->txbbgain_table[14].txbbgain_value = 0x390000e4;\r\npriv->txbbgain_table[15].txbb_iq_amplifygain = -3;\r\npriv->txbbgain_table[15].txbbgain_value = 0x35c000d7;\r\npriv->txbbgain_table[16].txbb_iq_amplifygain = -4;\r\npriv->txbbgain_table[16].txbbgain_value = 0x32c000cb;\r\npriv->txbbgain_table[17].txbb_iq_amplifygain = -5;\r\npriv->txbbgain_table[17].txbbgain_value = 0x300000c0;\r\npriv->txbbgain_table[18].txbb_iq_amplifygain = -6;\r\npriv->txbbgain_table[18].txbbgain_value = 0x2d4000b5;\r\npriv->txbbgain_table[19].txbb_iq_amplifygain = -7;\r\npriv->txbbgain_table[19].txbbgain_value = 0x2ac000ab;\r\npriv->txbbgain_table[20].txbb_iq_amplifygain = -8;\r\npriv->txbbgain_table[20].txbbgain_value = 0x288000a2;\r\npriv->txbbgain_table[21].txbb_iq_amplifygain = -9;\r\npriv->txbbgain_table[21].txbbgain_value = 0x26000098;\r\npriv->txbbgain_table[22].txbb_iq_amplifygain = -10;\r\npriv->txbbgain_table[22].txbbgain_value = 0x24000090;\r\npriv->txbbgain_table[23].txbb_iq_amplifygain = -11;\r\npriv->txbbgain_table[23].txbbgain_value = 0x22000088;\r\npriv->txbbgain_table[24].txbb_iq_amplifygain = -12;\r\npriv->txbbgain_table[24].txbbgain_value = 0x20000080;\r\npriv->txbbgain_table[25].txbb_iq_amplifygain = -13;\r\npriv->txbbgain_table[25].txbbgain_value = 0x1a00006c;\r\npriv->txbbgain_table[26].txbb_iq_amplifygain = -14;\r\npriv->txbbgain_table[26].txbbgain_value = 0x1c800072;\r\npriv->txbbgain_table[27].txbb_iq_amplifygain = -15;\r\npriv->txbbgain_table[27].txbbgain_value = 0x18000060;\r\npriv->txbbgain_table[28].txbb_iq_amplifygain = -16;\r\npriv->txbbgain_table[28].txbbgain_value = 0x19800066;\r\npriv->txbbgain_table[29].txbb_iq_amplifygain = -17;\r\npriv->txbbgain_table[29].txbbgain_value = 0x15800056;\r\npriv->txbbgain_table[30].txbb_iq_amplifygain = -18;\r\npriv->txbbgain_table[30].txbbgain_value = 0x26c0005b;\r\npriv->txbbgain_table[31].txbb_iq_amplifygain = -19;\r\npriv->txbbgain_table[31].txbbgain_value = 0x14400051;\r\npriv->txbbgain_table[32].txbb_iq_amplifygain = -20;\r\npriv->txbbgain_table[32].txbbgain_value = 0x24400051;\r\npriv->txbbgain_table[33].txbb_iq_amplifygain = -21;\r\npriv->txbbgain_table[33].txbbgain_value = 0x1300004c;\r\npriv->txbbgain_table[34].txbb_iq_amplifygain = -22;\r\npriv->txbbgain_table[34].txbbgain_value = 0x12000048;\r\npriv->txbbgain_table[35].txbb_iq_amplifygain = -23;\r\npriv->txbbgain_table[35].txbbgain_value = 0x11000044;\r\npriv->txbbgain_table[36].txbb_iq_amplifygain = -24;\r\npriv->txbbgain_table[36].txbbgain_value = 0x10000040;\r\npriv->cck_txbbgain_table[0].ccktxbb_valuearray[0] = 0x36;\r\npriv->cck_txbbgain_table[0].ccktxbb_valuearray[1] = 0x35;\r\npriv->cck_txbbgain_table[0].ccktxbb_valuearray[2] = 0x2e;\r\npriv->cck_txbbgain_table[0].ccktxbb_valuearray[3] = 0x25;\r\npriv->cck_txbbgain_table[0].ccktxbb_valuearray[4] = 0x1c;\r\npriv->cck_txbbgain_table[0].ccktxbb_valuearray[5] = 0x12;\r\npriv->cck_txbbgain_table[0].ccktxbb_valuearray[6] = 0x09;\r\npriv->cck_txbbgain_table[0].ccktxbb_valuearray[7] = 0x04;\r\npriv->cck_txbbgain_table[1].ccktxbb_valuearray[0] = 0x33;\r\npriv->cck_txbbgain_table[1].ccktxbb_valuearray[1] = 0x32;\r\npriv->cck_txbbgain_table[1].ccktxbb_valuearray[2] = 0x2b;\r\npriv->cck_txbbgain_table[1].ccktxbb_valuearray[3] = 0x23;\r\npriv->cck_txbbgain_table[1].ccktxbb_valuearray[4] = 0x1a;\r\npriv->cck_txbbgain_table[1].ccktxbb_valuearray[5] = 0x11;\r\npriv->cck_txbbgain_table[1].ccktxbb_valuearray[6] = 0x08;\r\npriv->cck_txbbgain_table[1].ccktxbb_valuearray[7] = 0x04;\r\npriv->cck_txbbgain_table[2].ccktxbb_valuearray[0] = 0x30;\r\npriv->cck_txbbgain_table[2].ccktxbb_valuearray[1] = 0x2f;\r\npriv->cck_txbbgain_table[2].ccktxbb_valuearray[2] = 0x29;\r\npriv->cck_txbbgain_table[2].ccktxbb_valuearray[3] = 0x21;\r\npriv->cck_txbbgain_table[2].ccktxbb_valuearray[4] = 0x19;\r\npriv->cck_txbbgain_table[2].ccktxbb_valuearray[5] = 0x10;\r\npriv->cck_txbbgain_table[2].ccktxbb_valuearray[6] = 0x08;\r\npriv->cck_txbbgain_table[2].ccktxbb_valuearray[7] = 0x03;\r\npriv->cck_txbbgain_table[3].ccktxbb_valuearray[0] = 0x2d;\r\npriv->cck_txbbgain_table[3].ccktxbb_valuearray[1] = 0x2d;\r\npriv->cck_txbbgain_table[3].ccktxbb_valuearray[2] = 0x27;\r\npriv->cck_txbbgain_table[3].ccktxbb_valuearray[3] = 0x1f;\r\npriv->cck_txbbgain_table[3].ccktxbb_valuearray[4] = 0x18;\r\npriv->cck_txbbgain_table[3].ccktxbb_valuearray[5] = 0x0f;\r\npriv->cck_txbbgain_table[3].ccktxbb_valuearray[6] = 0x08;\r\npriv->cck_txbbgain_table[3].ccktxbb_valuearray[7] = 0x03;\r\npriv->cck_txbbgain_table[4].ccktxbb_valuearray[0] = 0x2b;\r\npriv->cck_txbbgain_table[4].ccktxbb_valuearray[1] = 0x2a;\r\npriv->cck_txbbgain_table[4].ccktxbb_valuearray[2] = 0x25;\r\npriv->cck_txbbgain_table[4].ccktxbb_valuearray[3] = 0x1e;\r\npriv->cck_txbbgain_table[4].ccktxbb_valuearray[4] = 0x16;\r\npriv->cck_txbbgain_table[4].ccktxbb_valuearray[5] = 0x0e;\r\npriv->cck_txbbgain_table[4].ccktxbb_valuearray[6] = 0x07;\r\npriv->cck_txbbgain_table[4].ccktxbb_valuearray[7] = 0x03;\r\npriv->cck_txbbgain_table[5].ccktxbb_valuearray[0] = 0x28;\r\npriv->cck_txbbgain_table[5].ccktxbb_valuearray[1] = 0x28;\r\npriv->cck_txbbgain_table[5].ccktxbb_valuearray[2] = 0x22;\r\npriv->cck_txbbgain_table[5].ccktxbb_valuearray[3] = 0x1c;\r\npriv->cck_txbbgain_table[5].ccktxbb_valuearray[4] = 0x15;\r\npriv->cck_txbbgain_table[5].ccktxbb_valuearray[5] = 0x0d;\r\npriv->cck_txbbgain_table[5].ccktxbb_valuearray[6] = 0x07;\r\npriv->cck_txbbgain_table[5].ccktxbb_valuearray[7] = 0x03;\r\npriv->cck_txbbgain_table[6].ccktxbb_valuearray[0] = 0x26;\r\npriv->cck_txbbgain_table[6].ccktxbb_valuearray[1] = 0x25;\r\npriv->cck_txbbgain_table[6].ccktxbb_valuearray[2] = 0x21;\r\npriv->cck_txbbgain_table[6].ccktxbb_valuearray[3] = 0x1b;\r\npriv->cck_txbbgain_table[6].ccktxbb_valuearray[4] = 0x14;\r\npriv->cck_txbbgain_table[6].ccktxbb_valuearray[5] = 0x0d;\r\npriv->cck_txbbgain_table[6].ccktxbb_valuearray[6] = 0x06;\r\npriv->cck_txbbgain_table[6].ccktxbb_valuearray[7] = 0x03;\r\npriv->cck_txbbgain_table[7].ccktxbb_valuearray[0] = 0x24;\r\npriv->cck_txbbgain_table[7].ccktxbb_valuearray[1] = 0x23;\r\npriv->cck_txbbgain_table[7].ccktxbb_valuearray[2] = 0x1f;\r\npriv->cck_txbbgain_table[7].ccktxbb_valuearray[3] = 0x19;\r\npriv->cck_txbbgain_table[7].ccktxbb_valuearray[4] = 0x13;\r\npriv->cck_txbbgain_table[7].ccktxbb_valuearray[5] = 0x0c;\r\npriv->cck_txbbgain_table[7].ccktxbb_valuearray[6] = 0x06;\r\npriv->cck_txbbgain_table[7].ccktxbb_valuearray[7] = 0x03;\r\npriv->cck_txbbgain_table[8].ccktxbb_valuearray[0] = 0x22;\r\npriv->cck_txbbgain_table[8].ccktxbb_valuearray[1] = 0x21;\r\npriv->cck_txbbgain_table[8].ccktxbb_valuearray[2] = 0x1d;\r\npriv->cck_txbbgain_table[8].ccktxbb_valuearray[3] = 0x18;\r\npriv->cck_txbbgain_table[8].ccktxbb_valuearray[4] = 0x11;\r\npriv->cck_txbbgain_table[8].ccktxbb_valuearray[5] = 0x0b;\r\npriv->cck_txbbgain_table[8].ccktxbb_valuearray[6] = 0x06;\r\npriv->cck_txbbgain_table[8].ccktxbb_valuearray[7] = 0x02;\r\npriv->cck_txbbgain_table[9].ccktxbb_valuearray[0] = 0x20;\r\npriv->cck_txbbgain_table[9].ccktxbb_valuearray[1] = 0x20;\r\npriv->cck_txbbgain_table[9].ccktxbb_valuearray[2] = 0x1b;\r\npriv->cck_txbbgain_table[9].ccktxbb_valuearray[3] = 0x16;\r\npriv->cck_txbbgain_table[9].ccktxbb_valuearray[4] = 0x11;\r\npriv->cck_txbbgain_table[9].ccktxbb_valuearray[5] = 0x08;\r\npriv->cck_txbbgain_table[9].ccktxbb_valuearray[6] = 0x05;\r\npriv->cck_txbbgain_table[9].ccktxbb_valuearray[7] = 0x02;\r\npriv->cck_txbbgain_table[10].ccktxbb_valuearray[0] = 0x1f;\r\npriv->cck_txbbgain_table[10].ccktxbb_valuearray[1] = 0x1e;\r\npriv->cck_txbbgain_table[10].ccktxbb_valuearray[2] = 0x1a;\r\npriv->cck_txbbgain_table[10].ccktxbb_valuearray[3] = 0x15;\r\npriv->cck_txbbgain_table[10].ccktxbb_valuearray[4] = 0x10;\r\npriv->cck_txbbgain_table[10].ccktxbb_valuearray[5] = 0x0a;\r\npriv->cck_txbbgain_table[10].ccktxbb_valuearray[6] = 0x05;\r\npriv->cck_txbbgain_table[10].ccktxbb_valuearray[7] = 0x02;\r\npriv->cck_txbbgain_table[11].ccktxbb_valuearray[0] = 0x1d;\r\npriv->cck_txbbgain_table[11].ccktxbb_valuearray[1] = 0x1c;\r\npriv->cck_txbbgain_table[11].ccktxbb_valuearray[2] = 0x18;\r\npriv->cck_txbbgain_table[11].ccktxbb_valuearray[3] = 0x14;\r\npriv->cck_txbbgain_table[11].ccktxbb_valuearray[4] = 0x0f;\r\npriv->cck_txbbgain_table[11].ccktxbb_valuearray[5] = 0x0a;\r\npriv->cck_txbbgain_table[11].ccktxbb_valuearray[6] = 0x05;\r\npriv->cck_txbbgain_table[11].ccktxbb_valuearray[7] = 0x02;\r\npriv->cck_txbbgain_table[12].ccktxbb_valuearray[0] = 0x1b;\r\npriv->cck_txbbgain_table[12].ccktxbb_valuearray[1] = 0x1a;\r\npriv->cck_txbbgain_table[12].ccktxbb_valuearray[2] = 0x17;\r\npriv->cck_txbbgain_table[12].ccktxbb_valuearray[3] = 0x13;\r\npriv->cck_txbbgain_table[12].ccktxbb_valuearray[4] = 0x0e;\r\npriv->cck_txbbgain_table[12].ccktxbb_valuearray[5] = 0x09;\r\npriv->cck_txbbgain_table[12].ccktxbb_valuearray[6] = 0x04;\r\npriv->cck_txbbgain_table[12].ccktxbb_valuearray[7] = 0x02;\r\npriv->cck_txbbgain_table[13].ccktxbb_valuearray[0] = 0x1a;\r\npriv->cck_txbbgain_table[13].ccktxbb_valuearray[1] = 0x19;\r\npriv->cck_txbbgain_table[13].ccktxbb_valuearray[2] = 0x16;\r\npriv->cck_txbbgain_table[13].ccktxbb_valuearray[3] = 0x12;\r\npriv->cck_txbbgain_table[13].ccktxbb_valuearray[4] = 0x0d;\r\npriv->cck_txbbgain_table[13].ccktxbb_valuearray[5] = 0x09;\r\npriv->cck_txbbgain_table[13].ccktxbb_valuearray[6] = 0x04;\r\npriv->cck_txbbgain_table[13].ccktxbb_valuearray[7] = 0x02;\r\npriv->cck_txbbgain_table[14].ccktxbb_valuearray[0] = 0x18;\r\npriv->cck_txbbgain_table[14].ccktxbb_valuearray[1] = 0x17;\r\npriv->cck_txbbgain_table[14].ccktxbb_valuearray[2] = 0x15;\r\npriv->cck_txbbgain_table[14].ccktxbb_valuearray[3] = 0x11;\r\npriv->cck_txbbgain_table[14].ccktxbb_valuearray[4] = 0x0c;\r\npriv->cck_txbbgain_table[14].ccktxbb_valuearray[5] = 0x08;\r\npriv->cck_txbbgain_table[14].ccktxbb_valuearray[6] = 0x04;\r\npriv->cck_txbbgain_table[14].ccktxbb_valuearray[7] = 0x02;\r\npriv->cck_txbbgain_table[15].ccktxbb_valuearray[0] = 0x17;\r\npriv->cck_txbbgain_table[15].ccktxbb_valuearray[1] = 0x16;\r\npriv->cck_txbbgain_table[15].ccktxbb_valuearray[2] = 0x13;\r\npriv->cck_txbbgain_table[15].ccktxbb_valuearray[3] = 0x10;\r\npriv->cck_txbbgain_table[15].ccktxbb_valuearray[4] = 0x0c;\r\npriv->cck_txbbgain_table[15].ccktxbb_valuearray[5] = 0x08;\r\npriv->cck_txbbgain_table[15].ccktxbb_valuearray[6] = 0x04;\r\npriv->cck_txbbgain_table[15].ccktxbb_valuearray[7] = 0x02;\r\npriv->cck_txbbgain_table[16].ccktxbb_valuearray[0] = 0x16;\r\npriv->cck_txbbgain_table[16].ccktxbb_valuearray[1] = 0x15;\r\npriv->cck_txbbgain_table[16].ccktxbb_valuearray[2] = 0x12;\r\npriv->cck_txbbgain_table[16].ccktxbb_valuearray[3] = 0x0f;\r\npriv->cck_txbbgain_table[16].ccktxbb_valuearray[4] = 0x0b;\r\npriv->cck_txbbgain_table[16].ccktxbb_valuearray[5] = 0x07;\r\npriv->cck_txbbgain_table[16].ccktxbb_valuearray[6] = 0x04;\r\npriv->cck_txbbgain_table[16].ccktxbb_valuearray[7] = 0x01;\r\npriv->cck_txbbgain_table[17].ccktxbb_valuearray[0] = 0x14;\r\npriv->cck_txbbgain_table[17].ccktxbb_valuearray[1] = 0x14;\r\npriv->cck_txbbgain_table[17].ccktxbb_valuearray[2] = 0x11;\r\npriv->cck_txbbgain_table[17].ccktxbb_valuearray[3] = 0x0e;\r\npriv->cck_txbbgain_table[17].ccktxbb_valuearray[4] = 0x0b;\r\npriv->cck_txbbgain_table[17].ccktxbb_valuearray[5] = 0x07;\r\npriv->cck_txbbgain_table[17].ccktxbb_valuearray[6] = 0x03;\r\npriv->cck_txbbgain_table[17].ccktxbb_valuearray[7] = 0x02;\r\npriv->cck_txbbgain_table[18].ccktxbb_valuearray[0] = 0x13;\r\npriv->cck_txbbgain_table[18].ccktxbb_valuearray[1] = 0x13;\r\npriv->cck_txbbgain_table[18].ccktxbb_valuearray[2] = 0x10;\r\npriv->cck_txbbgain_table[18].ccktxbb_valuearray[3] = 0x0d;\r\npriv->cck_txbbgain_table[18].ccktxbb_valuearray[4] = 0x0a;\r\npriv->cck_txbbgain_table[18].ccktxbb_valuearray[5] = 0x06;\r\npriv->cck_txbbgain_table[18].ccktxbb_valuearray[6] = 0x03;\r\npriv->cck_txbbgain_table[18].ccktxbb_valuearray[7] = 0x01;\r\npriv->cck_txbbgain_table[19].ccktxbb_valuearray[0] = 0x12;\r\npriv->cck_txbbgain_table[19].ccktxbb_valuearray[1] = 0x12;\r\npriv->cck_txbbgain_table[19].ccktxbb_valuearray[2] = 0x0f;\r\npriv->cck_txbbgain_table[19].ccktxbb_valuearray[3] = 0x0c;\r\npriv->cck_txbbgain_table[19].ccktxbb_valuearray[4] = 0x09;\r\npriv->cck_txbbgain_table[19].ccktxbb_valuearray[5] = 0x06;\r\npriv->cck_txbbgain_table[19].ccktxbb_valuearray[6] = 0x03;\r\npriv->cck_txbbgain_table[19].ccktxbb_valuearray[7] = 0x01;\r\npriv->cck_txbbgain_table[20].ccktxbb_valuearray[0] = 0x11;\r\npriv->cck_txbbgain_table[20].ccktxbb_valuearray[1] = 0x11;\r\npriv->cck_txbbgain_table[20].ccktxbb_valuearray[2] = 0x0f;\r\npriv->cck_txbbgain_table[20].ccktxbb_valuearray[3] = 0x0c;\r\npriv->cck_txbbgain_table[20].ccktxbb_valuearray[4] = 0x09;\r\npriv->cck_txbbgain_table[20].ccktxbb_valuearray[5] = 0x06;\r\npriv->cck_txbbgain_table[20].ccktxbb_valuearray[6] = 0x03;\r\npriv->cck_txbbgain_table[20].ccktxbb_valuearray[7] = 0x01;\r\npriv->cck_txbbgain_table[21].ccktxbb_valuearray[0] = 0x10;\r\npriv->cck_txbbgain_table[21].ccktxbb_valuearray[1] = 0x10;\r\npriv->cck_txbbgain_table[21].ccktxbb_valuearray[2] = 0x0e;\r\npriv->cck_txbbgain_table[21].ccktxbb_valuearray[3] = 0x0b;\r\npriv->cck_txbbgain_table[21].ccktxbb_valuearray[4] = 0x08;\r\npriv->cck_txbbgain_table[21].ccktxbb_valuearray[5] = 0x05;\r\npriv->cck_txbbgain_table[21].ccktxbb_valuearray[6] = 0x03;\r\npriv->cck_txbbgain_table[21].ccktxbb_valuearray[7] = 0x01;\r\npriv->cck_txbbgain_table[22].ccktxbb_valuearray[0] = 0x0f;\r\npriv->cck_txbbgain_table[22].ccktxbb_valuearray[1] = 0x0f;\r\npriv->cck_txbbgain_table[22].ccktxbb_valuearray[2] = 0x0d;\r\npriv->cck_txbbgain_table[22].ccktxbb_valuearray[3] = 0x0b;\r\npriv->cck_txbbgain_table[22].ccktxbb_valuearray[4] = 0x08;\r\npriv->cck_txbbgain_table[22].ccktxbb_valuearray[5] = 0x05;\r\npriv->cck_txbbgain_table[22].ccktxbb_valuearray[6] = 0x03;\r\npriv->cck_txbbgain_table[22].ccktxbb_valuearray[7] = 0x01;\r\npriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[0] = 0x36;\r\npriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[1] = 0x35;\r\npriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[2] = 0x2e;\r\npriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[3] = 0x1b;\r\npriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[0].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[0] = 0x33;\r\npriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[1] = 0x32;\r\npriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[2] = 0x2b;\r\npriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[3] = 0x19;\r\npriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[1].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[0] = 0x30;\r\npriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[1] = 0x2f;\r\npriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[2] = 0x29;\r\npriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[3] = 0x18;\r\npriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[2].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[0] = 0x2d;\r\npriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[1] = 0x2d;\r\npriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[2] = 0x27;\r\npriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[3] = 0x17;\r\npriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[3].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[0] = 0x2b;\r\npriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[1] = 0x2a;\r\npriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[2] = 0x25;\r\npriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[3] = 0x15;\r\npriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[4].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[0] = 0x28;\r\npriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[1] = 0x28;\r\npriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[2] = 0x22;\r\npriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[3] = 0x14;\r\npriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[5].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[0] = 0x26;\r\npriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[1] = 0x25;\r\npriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[2] = 0x21;\r\npriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[3] = 0x13;\r\npriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[6].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[0] = 0x24;\r\npriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[1] = 0x23;\r\npriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[2] = 0x1f;\r\npriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[3] = 0x12;\r\npriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[7].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[0] = 0x22;\r\npriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[1] = 0x21;\r\npriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[2] = 0x1d;\r\npriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[3] = 0x11;\r\npriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[8].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[0] = 0x20;\r\npriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[1] = 0x20;\r\npriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[2] = 0x1b;\r\npriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[3] = 0x10;\r\npriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[9].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[0] = 0x1f;\r\npriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[1] = 0x1e;\r\npriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[2] = 0x1a;\r\npriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[3] = 0x0f;\r\npriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[10].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[0] = 0x1d;\r\npriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[1] = 0x1c;\r\npriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[2] = 0x18;\r\npriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[3] = 0x0e;\r\npriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[11].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[0] = 0x1b;\r\npriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[1] = 0x1a;\r\npriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[2] = 0x17;\r\npriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[3] = 0x0e;\r\npriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[12].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[0] = 0x1a;\r\npriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[1] = 0x19;\r\npriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[2] = 0x16;\r\npriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[3] = 0x0d;\r\npriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[13].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[0] = 0x18;\r\npriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[1] = 0x17;\r\npriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[2] = 0x15;\r\npriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[3] = 0x0c;\r\npriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[14].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[0] = 0x17;\r\npriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[1] = 0x16;\r\npriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[2] = 0x13;\r\npriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[3] = 0x0b;\r\npriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[15].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[0] = 0x16;\r\npriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[1] = 0x15;\r\npriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[2] = 0x12;\r\npriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[3] = 0x0b;\r\npriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[16].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[0] = 0x14;\r\npriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[1] = 0x14;\r\npriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[2] = 0x11;\r\npriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[3] = 0x0a;\r\npriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[17].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[0] = 0x13;\r\npriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[1] = 0x13;\r\npriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[2] = 0x10;\r\npriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[3] = 0x0a;\r\npriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[18].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[0] = 0x12;\r\npriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[1] = 0x12;\r\npriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[2] = 0x0f;\r\npriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[3] = 0x09;\r\npriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[19].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[0] = 0x11;\r\npriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[1] = 0x11;\r\npriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[2] = 0x0f;\r\npriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[3] = 0x09;\r\npriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[20].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[0] = 0x10;\r\npriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[1] = 0x10;\r\npriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[2] = 0x0e;\r\npriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[3] = 0x08;\r\npriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[21].ccktxbb_valuearray[7] = 0x00;\r\npriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[0] = 0x0f;\r\npriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[1] = 0x0f;\r\npriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[2] = 0x0d;\r\npriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[3] = 0x08;\r\npriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[4] = 0x00;\r\npriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[5] = 0x00;\r\npriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[6] = 0x00;\r\npriv->cck_txbbgain_ch14_table[22].ccktxbb_valuearray[7] = 0x00;\r\npriv->btxpower_tracking = true;\r\npriv->txpower_count = 0;\r\npriv->btxpower_trackingInit = false;\r\n}\r\nstatic void dm_InitializeTXPowerTracking_ThermalMeter(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nif (priv->ieee80211->FwRWRF)\r\npriv->btxpower_tracking = true;\r\nelse\r\npriv->btxpower_tracking = false;\r\npriv->txpower_count = 0;\r\npriv->btxpower_trackingInit = false;\r\n}\r\nvoid dm_initialize_txpower_tracking(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nif (priv->bDcut)\r\ndm_InitializeTXPowerTracking_TSSI(dev);\r\nelse\r\ndm_InitializeTXPowerTracking_ThermalMeter(dev);\r\n}\r\nstatic void dm_CheckTXPowerTracking_TSSI(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nstatic u32 tx_power_track_counter;\r\nif (!priv->btxpower_tracking)\r\nreturn;\r\nif ((tx_power_track_counter % 30 == 0) && (tx_power_track_counter != 0))\r\nqueue_delayed_work(priv->priv_wq, &priv->txpower_tracking_wq, 0);\r\ntx_power_track_counter++;\r\n}\r\nstatic void dm_CheckTXPowerTracking_ThermalMeter(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nstatic u8 TM_Trigger;\r\nif (!priv->btxpower_tracking)\r\nreturn;\r\nif (priv->txpower_count <= 2) {\r\npriv->txpower_count++;\r\nreturn;\r\n}\r\nif (!TM_Trigger) {\r\nrtl8192_phy_SetRFReg(dev, RF90_PATH_A, 0x02, bMask12Bits, 0x4d);\r\nrtl8192_phy_SetRFReg(dev, RF90_PATH_A, 0x02, bMask12Bits, 0x4f);\r\nrtl8192_phy_SetRFReg(dev, RF90_PATH_A, 0x02, bMask12Bits, 0x4d);\r\nrtl8192_phy_SetRFReg(dev, RF90_PATH_A, 0x02, bMask12Bits, 0x4f);\r\nTM_Trigger = 1;\r\nreturn;\r\n}\r\nqueue_delayed_work(priv->priv_wq, &priv->txpower_tracking_wq, 0);\r\nTM_Trigger = 0;\r\n}\r\nstatic void dm_check_txpower_tracking(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\n#ifdef RTL8190P\r\ndm_CheckTXPowerTracking_TSSI(dev);\r\n#else\r\nif (priv->bDcut)\r\ndm_CheckTXPowerTracking_TSSI(dev);\r\nelse\r\ndm_CheckTXPowerTracking_ThermalMeter(dev);\r\n#endif\r\n}\r\nstatic void dm_CCKTxPowerAdjust_TSSI(struct net_device *dev, bool bInCH14)\r\n{\r\nu32 TempVal;\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nTempVal = 0;\r\nif (!bInCH14) {\r\nTempVal = priv->cck_txbbgain_table[priv->cck_present_attentuation].ccktxbb_valuearray[0] +\r\n(priv->cck_txbbgain_table[priv->cck_present_attentuation].ccktxbb_valuearray[1]<<8);\r\nrtl8192_setBBreg(dev, rCCK0_TxFilter1, bMaskHWord, TempVal);\r\nTempVal = priv->cck_txbbgain_table[priv->cck_present_attentuation].ccktxbb_valuearray[2] +\r\n(priv->cck_txbbgain_table[priv->cck_present_attentuation].ccktxbb_valuearray[3]<<8) +\r\n(priv->cck_txbbgain_table[priv->cck_present_attentuation].ccktxbb_valuearray[4]<<16)+\r\n(priv->cck_txbbgain_table[priv->cck_present_attentuation].ccktxbb_valuearray[5]<<24);\r\nrtl8192_setBBreg(dev, rCCK0_TxFilter2, bMaskDWord, TempVal);\r\nTempVal = priv->cck_txbbgain_table[priv->cck_present_attentuation].ccktxbb_valuearray[6] +\r\n(priv->cck_txbbgain_table[priv->cck_present_attentuation].ccktxbb_valuearray[7]<<8);\r\nrtl8192_setBBreg(dev, rCCK0_DebugPort, bMaskLWord, TempVal);\r\n} else {\r\nTempVal = priv->cck_txbbgain_ch14_table[priv->cck_present_attentuation].ccktxbb_valuearray[0] +\r\n(priv->cck_txbbgain_ch14_table[priv->cck_present_attentuation].ccktxbb_valuearray[1]<<8);\r\nrtl8192_setBBreg(dev, rCCK0_TxFilter1, bMaskHWord, TempVal);\r\nTempVal = priv->cck_txbbgain_ch14_table[priv->cck_present_attentuation].ccktxbb_valuearray[2] +\r\n(priv->cck_txbbgain_ch14_table[priv->cck_present_attentuation].ccktxbb_valuearray[3]<<8) +\r\n(priv->cck_txbbgain_ch14_table[priv->cck_present_attentuation].ccktxbb_valuearray[4]<<16)+\r\n(priv->cck_txbbgain_ch14_table[priv->cck_present_attentuation].ccktxbb_valuearray[5]<<24);\r\nrtl8192_setBBreg(dev, rCCK0_TxFilter2, bMaskDWord, TempVal);\r\nTempVal = priv->cck_txbbgain_ch14_table[priv->cck_present_attentuation].ccktxbb_valuearray[6] +\r\n(priv->cck_txbbgain_ch14_table[priv->cck_present_attentuation].ccktxbb_valuearray[7]<<8);\r\nrtl8192_setBBreg(dev, rCCK0_DebugPort, bMaskLWord, TempVal);\r\n}\r\n}\r\nstatic void dm_CCKTxPowerAdjust_ThermalMeter(struct net_device *dev, bool bInCH14)\r\n{\r\nu32 TempVal;\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nTempVal = 0;\r\nif (!bInCH14) {\r\nTempVal = CCKSwingTable_Ch1_Ch13[priv->CCK_index][0] +\r\n(CCKSwingTable_Ch1_Ch13[priv->CCK_index][1]<<8);\r\nrtl8192_setBBreg(dev, rCCK0_TxFilter1, bMaskHWord, TempVal);\r\nRT_TRACE(COMP_POWER_TRACKING, "CCK not chnl 14, reg 0x%x = 0x%x\n",\r\nrCCK0_TxFilter1, TempVal);\r\nTempVal = CCKSwingTable_Ch1_Ch13[priv->CCK_index][2] +\r\n(CCKSwingTable_Ch1_Ch13[priv->CCK_index][3]<<8) +\r\n(CCKSwingTable_Ch1_Ch13[priv->CCK_index][4]<<16)+\r\n(CCKSwingTable_Ch1_Ch13[priv->CCK_index][5]<<24);\r\nrtl8192_setBBreg(dev, rCCK0_TxFilter2, bMaskDWord, TempVal);\r\nRT_TRACE(COMP_POWER_TRACKING, "CCK not chnl 14, reg 0x%x = 0x%x\n",\r\nrCCK0_TxFilter2, TempVal);\r\nTempVal = CCKSwingTable_Ch1_Ch13[priv->CCK_index][6] +\r\n(CCKSwingTable_Ch1_Ch13[priv->CCK_index][7]<<8);\r\nrtl8192_setBBreg(dev, rCCK0_DebugPort, bMaskLWord, TempVal);\r\nRT_TRACE(COMP_POWER_TRACKING, "CCK not chnl 14, reg 0x%x = 0x%x\n",\r\nrCCK0_DebugPort, TempVal);\r\n} else {\r\nTempVal = CCKSwingTable_Ch14[priv->CCK_index][0] +\r\n(CCKSwingTable_Ch14[priv->CCK_index][1]<<8);\r\nrtl8192_setBBreg(dev, rCCK0_TxFilter1, bMaskHWord, TempVal);\r\nRT_TRACE(COMP_POWER_TRACKING, "CCK chnl 14, reg 0x%x = 0x%x\n",\r\nrCCK0_TxFilter1, TempVal);\r\nTempVal = CCKSwingTable_Ch14[priv->CCK_index][2] +\r\n(CCKSwingTable_Ch14[priv->CCK_index][3]<<8) +\r\n(CCKSwingTable_Ch14[priv->CCK_index][4]<<16)+\r\n(CCKSwingTable_Ch14[priv->CCK_index][5]<<24);\r\nrtl8192_setBBreg(dev, rCCK0_TxFilter2, bMaskDWord, TempVal);\r\nRT_TRACE(COMP_POWER_TRACKING, "CCK chnl 14, reg 0x%x = 0x%x\n",\r\nrCCK0_TxFilter2, TempVal);\r\nTempVal = CCKSwingTable_Ch14[priv->CCK_index][6] +\r\n(CCKSwingTable_Ch14[priv->CCK_index][7]<<8);\r\nrtl8192_setBBreg(dev, rCCK0_DebugPort, bMaskLWord, TempVal);\r\nRT_TRACE(COMP_POWER_TRACKING, "CCK chnl 14, reg 0x%x = 0x%x\n",\r\nrCCK0_DebugPort, TempVal);\r\n}\r\n}\r\nvoid dm_cck_txpower_adjust(struct net_device *dev, bool binch14)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nif (priv->bDcut)\r\ndm_CCKTxPowerAdjust_TSSI(dev, binch14);\r\nelse\r\ndm_CCKTxPowerAdjust_ThermalMeter(dev, binch14);\r\n}\r\nstatic void dm_txpower_reset_recovery(\r\nstruct net_device *dev\r\n)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nRT_TRACE(COMP_POWER_TRACKING, "Start Reset Recovery ==>\n");\r\nrtl8192_setBBreg(dev, rOFDM0_XATxIQImbalance, bMaskDWord, priv->txbbgain_table[priv->rfa_txpowertrackingindex].txbbgain_value);\r\nRT_TRACE(COMP_POWER_TRACKING, "Reset Recovery: Fill in 0xc80 is %08x\n", priv->txbbgain_table[priv->rfa_txpowertrackingindex].txbbgain_value);\r\nRT_TRACE(COMP_POWER_TRACKING, "Reset Recovery: Fill in RFA_txPowerTrackingIndex is %x\n", priv->rfa_txpowertrackingindex);\r\nRT_TRACE(COMP_POWER_TRACKING, "Reset Recovery : RF A I/Q Amplify Gain is %ld\n", priv->txbbgain_table[priv->rfa_txpowertrackingindex].txbb_iq_amplifygain);\r\nRT_TRACE(COMP_POWER_TRACKING, "Reset Recovery: CCK Attenuation is %d dB\n", priv->cck_present_attentuation);\r\ndm_cck_txpower_adjust(dev, priv->bcck_in_ch14);\r\nrtl8192_setBBreg(dev, rOFDM0_XCTxIQImbalance, bMaskDWord, priv->txbbgain_table[priv->rfc_txpowertrackingindex].txbbgain_value);\r\nRT_TRACE(COMP_POWER_TRACKING, "Reset Recovery: Fill in 0xc90 is %08x\n", priv->txbbgain_table[priv->rfc_txpowertrackingindex].txbbgain_value);\r\nRT_TRACE(COMP_POWER_TRACKING, "Reset Recovery: Fill in RFC_txPowerTrackingIndex is %x\n", priv->rfc_txpowertrackingindex);\r\nRT_TRACE(COMP_POWER_TRACKING, "Reset Recovery : RF C I/Q Amplify Gain is %ld\n", priv->txbbgain_table[priv->rfc_txpowertrackingindex].txbb_iq_amplifygain);\r\n}\r\nvoid dm_restore_dynamic_mechanism_state(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nu32 reg_ratr = priv->rate_adaptive.last_ratr;\r\nif (!priv->up) {\r\nRT_TRACE(COMP_RATE, "<---- dm_restore_dynamic_mechanism_state(): driver is going to unload\n");\r\nreturn;\r\n}\r\nif (priv->rate_adaptive.rate_adaptive_disabled)\r\nreturn;\r\nif (!(priv->ieee80211->mode == WIRELESS_MODE_N_24G ||\r\npriv->ieee80211->mode == WIRELESS_MODE_N_5G))\r\nreturn;\r\n{\r\nu32 ratr_value;\r\nratr_value = reg_ratr;\r\nif (priv->rf_type == RF_1T2R) {\r\nratr_value &= ~(RATE_ALL_OFDM_2SS);\r\n}\r\nwrite_nic_dword(dev, RATR0, ratr_value);\r\nwrite_nic_byte(dev, UFWP, 1);\r\n}\r\nif (priv->btxpower_trackingInit && priv->btxpower_tracking)\r\ndm_txpower_reset_recovery(dev);\r\ndm_bb_initialgain_restore(dev);\r\n}\r\nstatic void dm_bb_initialgain_restore(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nu32 bit_mask = 0x7f;\r\nif (dm_digtable.dig_algorithm == DIG_ALGO_BY_RSSI)\r\nreturn;\r\nrtl8192_setBBreg(dev, UFWP, bMaskByte1, 0x8);\r\nrtl8192_setBBreg(dev, rOFDM0_XAAGCCore1, bit_mask, (u32)priv->initgain_backup.xaagccore1);\r\nrtl8192_setBBreg(dev, rOFDM0_XBAGCCore1, bit_mask, (u32)priv->initgain_backup.xbagccore1);\r\nrtl8192_setBBreg(dev, rOFDM0_XCAGCCore1, bit_mask, (u32)priv->initgain_backup.xcagccore1);\r\nrtl8192_setBBreg(dev, rOFDM0_XDAGCCore1, bit_mask, (u32)priv->initgain_backup.xdagccore1);\r\nbit_mask = bMaskByte2;\r\nrtl8192_setBBreg(dev, rCCK0_CCA, bit_mask, (u32)priv->initgain_backup.cca);\r\nRT_TRACE(COMP_DIG, "dm_BBInitialGainRestore 0xc50 is %x\n", priv->initgain_backup.xaagccore1);\r\nRT_TRACE(COMP_DIG, "dm_BBInitialGainRestore 0xc58 is %x\n", priv->initgain_backup.xbagccore1);\r\nRT_TRACE(COMP_DIG, "dm_BBInitialGainRestore 0xc60 is %x\n", priv->initgain_backup.xcagccore1);\r\nRT_TRACE(COMP_DIG, "dm_BBInitialGainRestore 0xc68 is %x\n", priv->initgain_backup.xdagccore1);\r\nRT_TRACE(COMP_DIG, "dm_BBInitialGainRestore 0xa0a is %x\n", priv->initgain_backup.cca);\r\nrtl8192_setBBreg(dev, UFWP, bMaskByte1, 0x1);\r\n}\r\nvoid dm_backup_dynamic_mechanism_state(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\npriv->bswitch_fsync = false;\r\npriv->bfsync_processing = false;\r\ndm_bb_initialgain_backup(dev);\r\n}\r\nstatic void dm_bb_initialgain_backup(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nu32 bit_mask = bMaskByte0;\r\nif (dm_digtable.dig_algorithm == DIG_ALGO_BY_RSSI)\r\nreturn;\r\nrtl8192_setBBreg(dev, UFWP, bMaskByte1, 0x8);\r\npriv->initgain_backup.xaagccore1 = (u8)rtl8192_QueryBBReg(dev, rOFDM0_XAAGCCore1, bit_mask);\r\npriv->initgain_backup.xbagccore1 = (u8)rtl8192_QueryBBReg(dev, rOFDM0_XBAGCCore1, bit_mask);\r\npriv->initgain_backup.xcagccore1 = (u8)rtl8192_QueryBBReg(dev, rOFDM0_XCAGCCore1, bit_mask);\r\npriv->initgain_backup.xdagccore1 = (u8)rtl8192_QueryBBReg(dev, rOFDM0_XDAGCCore1, bit_mask);\r\nbit_mask = bMaskByte2;\r\npriv->initgain_backup.cca = (u8)rtl8192_QueryBBReg(dev, rCCK0_CCA, bit_mask);\r\nRT_TRACE(COMP_DIG, "BBInitialGainBackup 0xc50 is %x\n", priv->initgain_backup.xaagccore1);\r\nRT_TRACE(COMP_DIG, "BBInitialGainBackup 0xc58 is %x\n", priv->initgain_backup.xbagccore1);\r\nRT_TRACE(COMP_DIG, "BBInitialGainBackup 0xc60 is %x\n", priv->initgain_backup.xcagccore1);\r\nRT_TRACE(COMP_DIG, "BBInitialGainBackup 0xc68 is %x\n", priv->initgain_backup.xdagccore1);\r\nRT_TRACE(COMP_DIG, "BBInitialGainBackup 0xa0a is %x\n", priv->initgain_backup.cca);\r\n}\r\nvoid dm_change_dynamic_initgain_thresh(struct net_device *dev, u32 dm_type,\r\nu32 dm_value)\r\n{\r\nswitch (dm_type) {\r\ncase DIG_TYPE_THRESH_HIGH:\r\ndm_digtable.rssi_high_thresh = dm_value;\r\nbreak;\r\ncase DIG_TYPE_THRESH_LOW:\r\ndm_digtable.rssi_low_thresh = dm_value;\r\nbreak;\r\ncase DIG_TYPE_THRESH_HIGHPWR_HIGH:\r\ndm_digtable.rssi_high_power_highthresh = dm_value;\r\nbreak;\r\ncase DIG_TYPE_THRESH_HIGHPWR_LOW:\r\ndm_digtable.rssi_high_power_lowthresh = dm_value;\r\nbreak;\r\ncase DIG_TYPE_ENABLE:\r\ndm_digtable.dig_state = DM_STA_DIG_MAX;\r\ndm_digtable.dig_enable_flag = true;\r\nbreak;\r\ncase DIG_TYPE_DISABLE:\r\ndm_digtable.dig_state = DM_STA_DIG_MAX;\r\ndm_digtable.dig_enable_flag = false;\r\nbreak;\r\ncase DIG_TYPE_DBG_MODE:\r\nif (dm_value >= DM_DBG_MAX)\r\ndm_value = DM_DBG_OFF;\r\ndm_digtable.dbg_mode = (u8)dm_value;\r\nbreak;\r\ncase DIG_TYPE_RSSI:\r\nif (dm_value > 100)\r\ndm_value = 30;\r\ndm_digtable.rssi_val = (long)dm_value;\r\nbreak;\r\ncase DIG_TYPE_ALGORITHM:\r\nif (dm_value >= DIG_ALGO_MAX)\r\ndm_value = DIG_ALGO_BY_FALSE_ALARM;\r\nif (dm_digtable.dig_algorithm != (u8)dm_value)\r\ndm_digtable.dig_algorithm_switch = 1;\r\ndm_digtable.dig_algorithm = (u8)dm_value;\r\nbreak;\r\ncase DIG_TYPE_BACKOFF:\r\nif (dm_value > 30)\r\ndm_value = 30;\r\ndm_digtable.backoff_val = (u8)dm_value;\r\nbreak;\r\ncase DIG_TYPE_RX_GAIN_MIN:\r\nif (dm_value == 0)\r\ndm_value = 0x1;\r\ndm_digtable.rx_gain_range_min = (u8)dm_value;\r\nbreak;\r\ncase DIG_TYPE_RX_GAIN_MAX:\r\nif (dm_value > 0x50)\r\ndm_value = 0x50;\r\ndm_digtable.rx_gain_range_max = (u8)dm_value;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void dm_dig_init(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\ndm_digtable.dig_enable_flag = true;\r\ndm_digtable.dig_algorithm = DIG_ALGO_BY_RSSI;\r\ndm_digtable.dbg_mode = DM_DBG_OFF;\r\ndm_digtable.dig_algorithm_switch = 0;\r\ndm_digtable.dig_state = DM_STA_DIG_MAX;\r\ndm_digtable.dig_highpwr_state = DM_STA_DIG_MAX;\r\ndm_digtable.initialgain_lowerbound_state = false;\r\ndm_digtable.rssi_low_thresh = DM_DIG_THRESH_LOW;\r\ndm_digtable.rssi_high_thresh = DM_DIG_THRESH_HIGH;\r\ndm_digtable.rssi_high_power_lowthresh = DM_DIG_HIGH_PWR_THRESH_LOW;\r\ndm_digtable.rssi_high_power_highthresh = DM_DIG_HIGH_PWR_THRESH_HIGH;\r\ndm_digtable.rssi_val = 50;\r\ndm_digtable.backoff_val = DM_DIG_BACKOFF;\r\ndm_digtable.rx_gain_range_max = DM_DIG_MAX;\r\nif (priv->CustomerID == RT_CID_819x_Netcore)\r\ndm_digtable.rx_gain_range_min = DM_DIG_MIN_Netcore;\r\nelse\r\ndm_digtable.rx_gain_range_min = DM_DIG_MIN;\r\n}\r\nstatic void dm_ctrl_initgain_byrssi(struct net_device *dev)\r\n{\r\nif (!dm_digtable.dig_enable_flag)\r\nreturn;\r\nif (dm_digtable.dig_algorithm == DIG_ALGO_BY_FALSE_ALARM)\r\ndm_ctrl_initgain_byrssi_by_fwfalse_alarm(dev);\r\nelse if (dm_digtable.dig_algorithm == DIG_ALGO_BY_RSSI)\r\ndm_ctrl_initgain_byrssi_by_driverrssi(dev);\r\nelse\r\nreturn;\r\n}\r\nstatic void dm_ctrl_initgain_byrssi_by_driverrssi(\r\nstruct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nu8 i;\r\nstatic u8 fw_dig;\r\nif (!dm_digtable.dig_enable_flag)\r\nreturn;\r\nif (dm_digtable.dig_algorithm_switch)\r\nfw_dig = 0;\r\nif (fw_dig <= 3) {\r\nfor (i = 0; i < 3; i++)\r\nrtl8192_setBBreg(dev, UFWP, bMaskByte1, 0x8);\r\nfw_dig++;\r\ndm_digtable.dig_state = DM_STA_DIG_OFF;\r\n}\r\nif (priv->ieee80211->state == IEEE80211_LINKED)\r\ndm_digtable.cur_connect_state = DIG_CONNECT;\r\nelse\r\ndm_digtable.cur_connect_state = DIG_DISCONNECT;\r\nif (dm_digtable.dbg_mode == DM_DBG_OFF)\r\ndm_digtable.rssi_val = priv->undecorated_smoothed_pwdb;\r\ndm_initial_gain(dev);\r\ndm_pd_th(dev);\r\ndm_cs_ratio(dev);\r\nif (dm_digtable.dig_algorithm_switch)\r\ndm_digtable.dig_algorithm_switch = 0;\r\ndm_digtable.pre_connect_state = dm_digtable.cur_connect_state;\r\n}\r\nstatic void dm_ctrl_initgain_byrssi_by_fwfalse_alarm(\r\nstruct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nstatic u32 reset_cnt;\r\nu8 i;\r\nif (!dm_digtable.dig_enable_flag)\r\nreturn;\r\nif (dm_digtable.dig_algorithm_switch) {\r\ndm_digtable.dig_state = DM_STA_DIG_MAX;\r\nfor (i = 0; i < 3; i++)\r\nrtl8192_setBBreg(dev, UFWP, bMaskByte1, 0x1);\r\ndm_digtable.dig_algorithm_switch = 0;\r\n}\r\nif (priv->ieee80211->state != IEEE80211_LINKED)\r\nreturn;\r\nif ((priv->undecorated_smoothed_pwdb > dm_digtable.rssi_low_thresh) &&\r\n(priv->undecorated_smoothed_pwdb < dm_digtable.rssi_high_thresh))\r\nreturn;\r\nif (priv->undecorated_smoothed_pwdb <= dm_digtable.rssi_low_thresh) {\r\nif (dm_digtable.dig_state == DM_STA_DIG_OFF &&\r\n(priv->reset_count == reset_cnt)) {\r\nreturn;\r\n}\r\nreset_cnt = priv->reset_count;\r\ndm_digtable.dig_highpwr_state = DM_STA_DIG_MAX;\r\ndm_digtable.dig_state = DM_STA_DIG_OFF;\r\nrtl8192_setBBreg(dev, UFWP, bMaskByte1, 0x8);\r\nwrite_nic_byte(dev, rOFDM0_XAAGCCore1, 0x17);\r\nwrite_nic_byte(dev, rOFDM0_XBAGCCore1, 0x17);\r\nwrite_nic_byte(dev, rOFDM0_XCAGCCore1, 0x17);\r\nwrite_nic_byte(dev, rOFDM0_XDAGCCore1, 0x17);\r\nif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\r\nwrite_nic_byte(dev, (rOFDM0_XATxAFE+3), 0x00);\r\n} else\r\nwrite_nic_byte(dev, rOFDM0_RxDetector1, 0x42);\r\nwrite_nic_byte(dev, 0xa0a, 0x08);\r\nreturn;\r\n}\r\nif (priv->undecorated_smoothed_pwdb >= dm_digtable.rssi_high_thresh) {\r\nu8 reset_flag = 0;\r\nif (dm_digtable.dig_state == DM_STA_DIG_ON &&\r\n(priv->reset_count == reset_cnt)) {\r\ndm_ctrl_initgain_byrssi_highpwr(dev);\r\nreturn;\r\n}\r\nif (priv->reset_count != reset_cnt)\r\nreset_flag = 1;\r\nreset_cnt = priv->reset_count;\r\ndm_digtable.dig_state = DM_STA_DIG_ON;\r\nif (reset_flag == 1) {\r\nwrite_nic_byte(dev, rOFDM0_XAAGCCore1, 0x2c);\r\nwrite_nic_byte(dev, rOFDM0_XBAGCCore1, 0x2c);\r\nwrite_nic_byte(dev, rOFDM0_XCAGCCore1, 0x2c);\r\nwrite_nic_byte(dev, rOFDM0_XDAGCCore1, 0x2c);\r\n} else {\r\nwrite_nic_byte(dev, rOFDM0_XAAGCCore1, 0x20);\r\nwrite_nic_byte(dev, rOFDM0_XBAGCCore1, 0x20);\r\nwrite_nic_byte(dev, rOFDM0_XCAGCCore1, 0x20);\r\nwrite_nic_byte(dev, rOFDM0_XDAGCCore1, 0x20);\r\n}\r\nif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\r\nwrite_nic_byte(dev, (rOFDM0_XATxAFE+3), 0x20);\r\n} else\r\nwrite_nic_byte(dev, rOFDM0_RxDetector1, 0x44);\r\nwrite_nic_byte(dev, 0xa0a, 0xcd);\r\nrtl8192_setBBreg(dev, UFWP, bMaskByte1, 0x1);\r\n}\r\ndm_ctrl_initgain_byrssi_highpwr(dev);\r\n}\r\nstatic void dm_ctrl_initgain_byrssi_highpwr(\r\nstruct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nstatic u32 reset_cnt_highpwr;\r\nif ((priv->undecorated_smoothed_pwdb > dm_digtable.rssi_high_power_lowthresh) &&\r\n(priv->undecorated_smoothed_pwdb < dm_digtable.rssi_high_power_highthresh))\r\nreturn;\r\nif (priv->undecorated_smoothed_pwdb >= dm_digtable.rssi_high_power_highthresh) {\r\nif (dm_digtable.dig_highpwr_state == DM_STA_DIG_ON &&\r\n(priv->reset_count == reset_cnt_highpwr))\r\nreturn;\r\ndm_digtable.dig_highpwr_state = DM_STA_DIG_ON;\r\nif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\r\nwrite_nic_byte(dev, (rOFDM0_XATxAFE+3), 0x10);\r\n} else\r\nwrite_nic_byte(dev, rOFDM0_RxDetector1, 0x43);\r\n} else {\r\nif (dm_digtable.dig_highpwr_state == DM_STA_DIG_OFF &&\r\n(priv->reset_count == reset_cnt_highpwr))\r\nreturn;\r\ndm_digtable.dig_highpwr_state = DM_STA_DIG_OFF;\r\nif (priv->undecorated_smoothed_pwdb < dm_digtable.rssi_high_power_lowthresh &&\r\npriv->undecorated_smoothed_pwdb >= dm_digtable.rssi_high_thresh) {\r\nif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\r\nwrite_nic_byte(dev, (rOFDM0_XATxAFE+3), 0x20);\r\n} else\r\nwrite_nic_byte(dev, rOFDM0_RxDetector1, 0x44);\r\n}\r\n}\r\nreset_cnt_highpwr = priv->reset_count;\r\n}\r\nstatic void dm_initial_gain(\r\nstruct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nu8 initial_gain = 0;\r\nstatic u8 initialized, force_write;\r\nstatic u32 reset_cnt;\r\nu8 tmp;\r\nif (dm_digtable.dig_algorithm_switch) {\r\ninitialized = 0;\r\nreset_cnt = 0;\r\n}\r\nif (dm_digtable.pre_connect_state == dm_digtable.cur_connect_state) {\r\nif (dm_digtable.cur_connect_state == DIG_CONNECT) {\r\nif ((dm_digtable.rssi_val+10-dm_digtable.backoff_val) > dm_digtable.rx_gain_range_max)\r\ndm_digtable.cur_ig_value = dm_digtable.rx_gain_range_max;\r\nelse if ((dm_digtable.rssi_val+10-dm_digtable.backoff_val) < dm_digtable.rx_gain_range_min)\r\ndm_digtable.cur_ig_value = dm_digtable.rx_gain_range_min;\r\nelse\r\ndm_digtable.cur_ig_value = dm_digtable.rssi_val+10-dm_digtable.backoff_val;\r\n} else {\r\nif (dm_digtable.cur_ig_value == 0)\r\ndm_digtable.cur_ig_value = priv->DefaultInitialGain[0];\r\nelse\r\ndm_digtable.cur_ig_value = dm_digtable.pre_ig_value;\r\n}\r\n} else {\r\ndm_digtable.cur_ig_value = priv->DefaultInitialGain[0];\r\ndm_digtable.pre_ig_value = 0;\r\n}\r\nif (priv->reset_count != reset_cnt) {\r\nforce_write = 1;\r\nreset_cnt = priv->reset_count;\r\n}\r\nread_nic_byte(dev, rOFDM0_XAAGCCore1, &tmp);\r\nif (dm_digtable.pre_ig_value != tmp)\r\nforce_write = 1;\r\n{\r\nif ((dm_digtable.pre_ig_value != dm_digtable.cur_ig_value)\r\n|| !initialized || force_write) {\r\ninitial_gain = (u8)dm_digtable.cur_ig_value;\r\nwrite_nic_byte(dev, rOFDM0_XAAGCCore1, initial_gain);\r\nwrite_nic_byte(dev, rOFDM0_XBAGCCore1, initial_gain);\r\nwrite_nic_byte(dev, rOFDM0_XCAGCCore1, initial_gain);\r\nwrite_nic_byte(dev, rOFDM0_XDAGCCore1, initial_gain);\r\ndm_digtable.pre_ig_value = dm_digtable.cur_ig_value;\r\ninitialized = 1;\r\nforce_write = 0;\r\n}\r\n}\r\n}\r\nstatic void dm_pd_th(\r\nstruct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nstatic u8 initialized, force_write;\r\nstatic u32 reset_cnt;\r\nif (dm_digtable.dig_algorithm_switch) {\r\ninitialized = 0;\r\nreset_cnt = 0;\r\n}\r\nif (dm_digtable.pre_connect_state == dm_digtable.cur_connect_state) {\r\nif (dm_digtable.cur_connect_state == DIG_CONNECT) {\r\nif (dm_digtable.rssi_val >= dm_digtable.rssi_high_power_highthresh)\r\ndm_digtable.curpd_thstate = DIG_PD_AT_HIGH_POWER;\r\nelse if (dm_digtable.rssi_val <= dm_digtable.rssi_low_thresh)\r\ndm_digtable.curpd_thstate = DIG_PD_AT_LOW_POWER;\r\nelse if ((dm_digtable.rssi_val >= dm_digtable.rssi_high_thresh) &&\r\n(dm_digtable.rssi_val < dm_digtable.rssi_high_power_lowthresh))\r\ndm_digtable.curpd_thstate = DIG_PD_AT_NORMAL_POWER;\r\nelse\r\ndm_digtable.curpd_thstate = dm_digtable.prepd_thstate;\r\n} else {\r\ndm_digtable.curpd_thstate = DIG_PD_AT_LOW_POWER;\r\n}\r\n} else {\r\ndm_digtable.curpd_thstate = DIG_PD_AT_LOW_POWER;\r\n}\r\nif (priv->reset_count != reset_cnt) {\r\nforce_write = 1;\r\nreset_cnt = priv->reset_count;\r\n}\r\n{\r\nif ((dm_digtable.prepd_thstate != dm_digtable.curpd_thstate) ||\r\n(initialized <= 3) || force_write) {\r\nif (dm_digtable.curpd_thstate == DIG_PD_AT_LOW_POWER) {\r\nif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\r\nwrite_nic_byte(dev, (rOFDM0_XATxAFE+3), 0x00);\r\n} else\r\nwrite_nic_byte(dev, rOFDM0_RxDetector1, 0x42);\r\n} else if (dm_digtable.curpd_thstate == DIG_PD_AT_NORMAL_POWER) {\r\nif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\r\nwrite_nic_byte(dev, (rOFDM0_XATxAFE+3), 0x20);\r\n} else\r\nwrite_nic_byte(dev, rOFDM0_RxDetector1, 0x44);\r\n} else if (dm_digtable.curpd_thstate == DIG_PD_AT_HIGH_POWER) {\r\nif (priv->CurrentChannelBW != HT_CHANNEL_WIDTH_20) {\r\nwrite_nic_byte(dev, (rOFDM0_XATxAFE+3), 0x10);\r\n} else\r\nwrite_nic_byte(dev, rOFDM0_RxDetector1, 0x43);\r\n}\r\ndm_digtable.prepd_thstate = dm_digtable.curpd_thstate;\r\nif (initialized <= 3)\r\ninitialized++;\r\nforce_write = 0;\r\n}\r\n}\r\n}\r\nstatic void dm_cs_ratio(\r\nstruct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nstatic u8 initialized, force_write;\r\nstatic u32 reset_cnt;\r\nif (dm_digtable.dig_algorithm_switch) {\r\ninitialized = 0;\r\nreset_cnt = 0;\r\n}\r\nif (dm_digtable.pre_connect_state == dm_digtable.cur_connect_state) {\r\nif (dm_digtable.cur_connect_state == DIG_CONNECT) {\r\nif (dm_digtable.rssi_val <= dm_digtable.rssi_low_thresh)\r\ndm_digtable.curcs_ratio_state = DIG_CS_RATIO_LOWER;\r\nelse if (dm_digtable.rssi_val >= dm_digtable.rssi_high_thresh)\r\ndm_digtable.curcs_ratio_state = DIG_CS_RATIO_HIGHER;\r\nelse\r\ndm_digtable.curcs_ratio_state = dm_digtable.precs_ratio_state;\r\n} else {\r\ndm_digtable.curcs_ratio_state = DIG_CS_RATIO_LOWER;\r\n}\r\n} else\r\ndm_digtable.curcs_ratio_state = DIG_CS_RATIO_LOWER;\r\nif (priv->reset_count != reset_cnt) {\r\nforce_write = 1;\r\nreset_cnt = priv->reset_count;\r\n}\r\n{\r\nif ((dm_digtable.precs_ratio_state != dm_digtable.curcs_ratio_state) ||\r\n!initialized || force_write) {\r\nif (dm_digtable.curcs_ratio_state == DIG_CS_RATIO_LOWER) {\r\nwrite_nic_byte(dev, 0xa0a, 0x08);\r\n} else if (dm_digtable.curcs_ratio_state == DIG_CS_RATIO_HIGHER) {\r\nwrite_nic_byte(dev, 0xa0a, 0xcd);\r\n}\r\ndm_digtable.precs_ratio_state = dm_digtable.curcs_ratio_state;\r\ninitialized = 1;\r\nforce_write = 0;\r\n}\r\n}\r\n}\r\nvoid dm_init_edca_turbo(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\npriv->bcurrent_turbo_EDCA = false;\r\npriv->ieee80211->bis_any_nonbepkts = false;\r\npriv->bis_cur_rdlstate = false;\r\n}\r\nstatic void dm_check_edca_turbo(\r\nstruct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nPRT_HIGH_THROUGHPUT pHTInfo = priv->ieee80211->pHTInfo;\r\nstatic unsigned long lastTxOkCnt;\r\nstatic unsigned long lastRxOkCnt;\r\nunsigned long curTxOkCnt = 0;\r\nunsigned long curRxOkCnt = 0;\r\nif (priv->ieee80211->state != IEEE80211_LINKED)\r\ngoto dm_CheckEdcaTurbo_EXIT;\r\nif (priv->ieee80211->pHTInfo->IOTAction & HT_IOT_ACT_DISABLE_EDCA_TURBO)\r\ngoto dm_CheckEdcaTurbo_EXIT;\r\nif (!priv->ieee80211->bis_any_nonbepkts) {\r\ncurTxOkCnt = priv->stats.txbytesunicast - lastTxOkCnt;\r\ncurRxOkCnt = priv->stats.rxbytesunicast - lastRxOkCnt;\r\nif (curRxOkCnt > 4*curTxOkCnt) {\r\nif (!priv->bis_cur_rdlstate || !priv->bcurrent_turbo_EDCA) {\r\nwrite_nic_dword(dev, EDCAPARA_BE, edca_setting_DL[pHTInfo->IOTPeer]);\r\npriv->bis_cur_rdlstate = true;\r\n}\r\n} else {\r\nif (priv->bis_cur_rdlstate || !priv->bcurrent_turbo_EDCA) {\r\nwrite_nic_dword(dev, EDCAPARA_BE, edca_setting_UL[pHTInfo->IOTPeer]);\r\npriv->bis_cur_rdlstate = false;\r\n}\r\n}\r\npriv->bcurrent_turbo_EDCA = true;\r\n} else {\r\nif (priv->bcurrent_turbo_EDCA) {\r\n{\r\nu8 u1bAIFS;\r\nu32 u4bAcParam;\r\nstruct ieee80211_qos_parameters *qos_parameters = &priv->ieee80211->current_network.qos_data.parameters;\r\nu8 mode = priv->ieee80211->mode;\r\ndm_init_edca_turbo(dev);\r\nu1bAIFS = qos_parameters->aifs[0] * ((mode&(IEEE_G|IEEE_N_24G)) ? 9 : 20) + aSifsTime;\r\nu4bAcParam = (((u32)(qos_parameters->tx_op_limit[0])) << AC_PARAM_TXOP_LIMIT_OFFSET)|\r\n(((u32)(qos_parameters->cw_max[0])) << AC_PARAM_ECW_MAX_OFFSET)|\r\n(((u32)(qos_parameters->cw_min[0])) << AC_PARAM_ECW_MIN_OFFSET)|\r\n((u32)u1bAIFS << AC_PARAM_AIFS_OFFSET);\r\nwrite_nic_dword(dev, EDCAPARA_BE, u4bAcParam);\r\n{\r\nPACI_AIFSN pAciAifsn = (PACI_AIFSN)&(qos_parameters->aifs[0]);\r\nu8 AcmCtrl;\r\nread_nic_byte(dev, AcmHwCtrl, &AcmCtrl);\r\nif (pAciAifsn->f.ACM) {\r\nAcmCtrl |= AcmHw_BeqEn;\r\n} else {\r\nAcmCtrl &= (~AcmHw_BeqEn);\r\n}\r\nRT_TRACE(COMP_QOS, "SetHwReg8190pci(): [HW_VAR_ACM_CTRL] Write 0x%X\n", AcmCtrl);\r\nwrite_nic_byte(dev, AcmHwCtrl, AcmCtrl);\r\n}\r\n}\r\npriv->bcurrent_turbo_EDCA = false;\r\n}\r\n}\r\ndm_CheckEdcaTurbo_EXIT:\r\npriv->ieee80211->bis_any_nonbepkts = false;\r\nlastTxOkCnt = priv->stats.txbytesunicast;\r\nlastRxOkCnt = priv->stats.rxbytesunicast;\r\n}\r\nstatic void dm_init_ctstoself(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\npriv->ieee80211->bCTSToSelfEnable = true;\r\npriv->ieee80211->CTSToSelfTH = CTSToSelfTHVal;\r\n}\r\nstatic void dm_ctstoself(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nPRT_HIGH_THROUGHPUT pHTInfo = priv->ieee80211->pHTInfo;\r\nstatic unsigned long lastTxOkCnt;\r\nstatic unsigned long lastRxOkCnt;\r\nunsigned long curTxOkCnt = 0;\r\nunsigned long curRxOkCnt = 0;\r\nif (priv->ieee80211->bCTSToSelfEnable != true) {\r\npHTInfo->IOTAction &= ~HT_IOT_ACT_FORCED_CTS2SELF;\r\nreturn;\r\n}\r\nif (pHTInfo->IOTPeer == HT_IOT_PEER_BROADCOM) {\r\ncurTxOkCnt = priv->stats.txbytesunicast - lastTxOkCnt;\r\ncurRxOkCnt = priv->stats.rxbytesunicast - lastRxOkCnt;\r\nif (curRxOkCnt > 4*curTxOkCnt) {\r\npHTInfo->IOTAction &= ~HT_IOT_ACT_FORCED_CTS2SELF;\r\n} else {\r\npHTInfo->IOTAction |= HT_IOT_ACT_FORCED_CTS2SELF;\r\n}\r\nlastTxOkCnt = priv->stats.txbytesunicast;\r\nlastRxOkCnt = priv->stats.rxbytesunicast;\r\n}\r\n}\r\nstatic void dm_check_pbc_gpio(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nu8 tmp1byte;\r\nread_nic_byte(dev, GPI, &tmp1byte);\r\nif (tmp1byte == 0xff)\r\nreturn;\r\nif (tmp1byte & BIT(6) || tmp1byte & BIT(0)) {\r\nRT_TRACE(COMP_IO, "CheckPbcGPIO - PBC is pressed\n");\r\npriv->bpbc_pressed = true;\r\n}\r\n}\r\nvoid dm_rf_pathcheck_workitemcallback(struct work_struct *work)\r\n{\r\nstruct delayed_work *dwork = to_delayed_work(work);\r\nstruct r8192_priv *priv = container_of(dwork, struct r8192_priv, rfpath_check_wq);\r\nstruct net_device *dev = priv->ieee80211->dev;\r\nu8 rfpath = 0, i;\r\nread_nic_byte(dev, 0xc04, &rfpath);\r\nfor (i = 0; i < RF90_PATH_MAX; i++) {\r\nif (rfpath & (0x01<<i))\r\npriv->brfpath_rxenable[i] = true;\r\nelse\r\npriv->brfpath_rxenable[i] = false;\r\n}\r\nif (!DM_RxPathSelTable.Enable)\r\nreturn;\r\ndm_rxpath_sel_byrssi(dev);\r\n}\r\nstatic void dm_init_rxpath_selection(struct net_device *dev)\r\n{\r\nu8 i;\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nDM_RxPathSelTable.Enable = 1;\r\nDM_RxPathSelTable.SS_TH_low = RxPathSelection_SS_TH_low;\r\nDM_RxPathSelTable.diff_TH = RxPathSelection_diff_TH;\r\nif (priv->CustomerID == RT_CID_819x_Netcore)\r\nDM_RxPathSelTable.cck_method = CCK_Rx_Version_2;\r\nelse\r\nDM_RxPathSelTable.cck_method = CCK_Rx_Version_1;\r\nDM_RxPathSelTable.DbgMode = DM_DBG_OFF;\r\nDM_RxPathSelTable.disabledRF = 0;\r\nfor (i = 0; i < 4; i++) {\r\nDM_RxPathSelTable.rf_rssi[i] = 50;\r\nDM_RxPathSelTable.cck_pwdb_sta[i] = -64;\r\nDM_RxPathSelTable.rf_enable_rssi_th[i] = 100;\r\n}\r\n}\r\nstatic void dm_rxpath_sel_byrssi(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nu8 i, max_rssi_index = 0, min_rssi_index = 0, sec_rssi_index = 0, rf_num = 0;\r\nu8 tmp_max_rssi = 0, tmp_min_rssi = 0, tmp_sec_rssi = 0;\r\nu8 cck_default_Rx = 0x2;\r\nu8 cck_optional_Rx = 0x3;\r\nlong tmp_cck_max_pwdb = 0, tmp_cck_min_pwdb = 0, tmp_cck_sec_pwdb = 0;\r\nu8 cck_rx_ver2_max_index = 0, cck_rx_ver2_min_index = 0, cck_rx_ver2_sec_index = 0;\r\nu8 cur_rf_rssi;\r\nlong cur_cck_pwdb;\r\nstatic u8 disabled_rf_cnt, cck_Rx_Path_initialized;\r\nu8 update_cck_rx_path;\r\nif (priv->rf_type != RF_2T4R)\r\nreturn;\r\nif (!cck_Rx_Path_initialized) {\r\nread_nic_byte(dev, 0xa07, &DM_RxPathSelTable.cck_Rx_path);\r\nDM_RxPathSelTable.cck_Rx_path &= 0xf;\r\ncck_Rx_Path_initialized = 1;\r\n}\r\nread_nic_byte(dev, 0xc04, &DM_RxPathSelTable.disabledRF);\r\nDM_RxPathSelTable.disabledRF = ~DM_RxPathSelTable.disabledRF & 0xf;\r\nif (priv->ieee80211->mode == WIRELESS_MODE_B) {\r\nDM_RxPathSelTable.cck_method = CCK_Rx_Version_2;\r\n}\r\nfor (i = 0; i < RF90_PATH_MAX; i++) {\r\nif (!DM_RxPathSelTable.DbgMode)\r\nDM_RxPathSelTable.rf_rssi[i] = priv->stats.rx_rssi_percentage[i];\r\nif (priv->brfpath_rxenable[i]) {\r\nrf_num++;\r\ncur_rf_rssi = DM_RxPathSelTable.rf_rssi[i];\r\nif (rf_num == 1) {\r\nmax_rssi_index = min_rssi_index = sec_rssi_index = i;\r\ntmp_max_rssi = tmp_min_rssi = tmp_sec_rssi = cur_rf_rssi;\r\n} else if (rf_num == 2) {\r\nif (cur_rf_rssi >= tmp_max_rssi) {\r\ntmp_max_rssi = cur_rf_rssi;\r\nmax_rssi_index = i;\r\n} else {\r\ntmp_sec_rssi = tmp_min_rssi = cur_rf_rssi;\r\nsec_rssi_index = min_rssi_index = i;\r\n}\r\n} else {\r\nif (cur_rf_rssi > tmp_max_rssi) {\r\ntmp_sec_rssi = tmp_max_rssi;\r\nsec_rssi_index = max_rssi_index;\r\ntmp_max_rssi = cur_rf_rssi;\r\nmax_rssi_index = i;\r\n} else if (cur_rf_rssi == tmp_max_rssi) {\r\ntmp_sec_rssi = cur_rf_rssi;\r\nsec_rssi_index = i;\r\n} else if ((cur_rf_rssi < tmp_max_rssi) && (cur_rf_rssi > tmp_sec_rssi)) {\r\ntmp_sec_rssi = cur_rf_rssi;\r\nsec_rssi_index = i;\r\n} else if (cur_rf_rssi == tmp_sec_rssi) {\r\nif (tmp_sec_rssi == tmp_min_rssi) {\r\ntmp_sec_rssi = cur_rf_rssi;\r\nsec_rssi_index = i;\r\n} else {\r\n}\r\n} else if ((cur_rf_rssi < tmp_sec_rssi) && (cur_rf_rssi > tmp_min_rssi)) {\r\n} else if (cur_rf_rssi == tmp_min_rssi) {\r\nif (tmp_sec_rssi == tmp_min_rssi) {\r\ntmp_min_rssi = cur_rf_rssi;\r\nmin_rssi_index = i;\r\n} else {\r\n}\r\n} else if (cur_rf_rssi < tmp_min_rssi) {\r\ntmp_min_rssi = cur_rf_rssi;\r\nmin_rssi_index = i;\r\n}\r\n}\r\n}\r\n}\r\nrf_num = 0;\r\nif (DM_RxPathSelTable.cck_method == CCK_Rx_Version_2) {\r\nfor (i = 0; i < RF90_PATH_MAX; i++) {\r\nif (priv->brfpath_rxenable[i]) {\r\nrf_num++;\r\ncur_cck_pwdb = DM_RxPathSelTable.cck_pwdb_sta[i];\r\nif (rf_num == 1) {\r\ncck_rx_ver2_max_index = cck_rx_ver2_min_index = cck_rx_ver2_sec_index = i;\r\ntmp_cck_max_pwdb = tmp_cck_min_pwdb = tmp_cck_sec_pwdb = cur_cck_pwdb;\r\n} else if (rf_num == 2) {\r\nif (cur_cck_pwdb >= tmp_cck_max_pwdb) {\r\ntmp_cck_max_pwdb = cur_cck_pwdb;\r\ncck_rx_ver2_max_index = i;\r\n} else {\r\ntmp_cck_sec_pwdb = tmp_cck_min_pwdb = cur_cck_pwdb;\r\ncck_rx_ver2_sec_index = cck_rx_ver2_min_index = i;\r\n}\r\n} else {\r\nif (cur_cck_pwdb > tmp_cck_max_pwdb) {\r\ntmp_cck_sec_pwdb = tmp_cck_max_pwdb;\r\ncck_rx_ver2_sec_index = cck_rx_ver2_max_index;\r\ntmp_cck_max_pwdb = cur_cck_pwdb;\r\ncck_rx_ver2_max_index = i;\r\n} else if (cur_cck_pwdb == tmp_cck_max_pwdb) {\r\ntmp_cck_sec_pwdb = cur_cck_pwdb;\r\ncck_rx_ver2_sec_index = i;\r\n} else if ((cur_cck_pwdb < tmp_cck_max_pwdb) && (cur_cck_pwdb > tmp_cck_sec_pwdb)) {\r\ntmp_cck_sec_pwdb = cur_cck_pwdb;\r\ncck_rx_ver2_sec_index = i;\r\n} else if (cur_cck_pwdb == tmp_cck_sec_pwdb && tmp_cck_sec_pwdb == tmp_cck_min_pwdb) {\r\ntmp_cck_sec_pwdb = cur_cck_pwdb;\r\ncck_rx_ver2_sec_index = i;\r\n} else if ((cur_cck_pwdb < tmp_cck_sec_pwdb) && (cur_cck_pwdb > tmp_cck_min_pwdb)) {\r\n} else if (cur_cck_pwdb == tmp_cck_min_pwdb && tmp_cck_sec_pwdb == tmp_cck_min_pwdb) {\r\ntmp_cck_min_pwdb = cur_cck_pwdb;\r\ncck_rx_ver2_min_index = i;\r\n} else if (cur_cck_pwdb < tmp_cck_min_pwdb) {\r\ntmp_cck_min_pwdb = cur_cck_pwdb;\r\ncck_rx_ver2_min_index = i;\r\n}\r\n}\r\n}\r\n}\r\n}\r\nupdate_cck_rx_path = 0;\r\nif (DM_RxPathSelTable.cck_method == CCK_Rx_Version_2) {\r\ncck_default_Rx = cck_rx_ver2_max_index;\r\ncck_optional_Rx = cck_rx_ver2_sec_index;\r\nif (tmp_cck_max_pwdb != -64)\r\nupdate_cck_rx_path = 1;\r\n}\r\nif (tmp_min_rssi < DM_RxPathSelTable.SS_TH_low && disabled_rf_cnt < 2) {\r\nif ((tmp_max_rssi - tmp_min_rssi) >= DM_RxPathSelTable.diff_TH) {\r\nDM_RxPathSelTable.rf_enable_rssi_th[min_rssi_index] = tmp_max_rssi+5;\r\nrtl8192_setBBreg(dev, rOFDM0_TRxPathEnable, 0x1<<min_rssi_index, 0x0);\r\nrtl8192_setBBreg(dev, rOFDM1_TRxPathEnable, 0x1<<min_rssi_index, 0x0);\r\ndisabled_rf_cnt++;\r\n}\r\nif (DM_RxPathSelTable.cck_method == CCK_Rx_Version_1) {\r\ncck_default_Rx = max_rssi_index;\r\ncck_optional_Rx = sec_rssi_index;\r\nif (tmp_max_rssi)\r\nupdate_cck_rx_path = 1;\r\n}\r\n}\r\nif (update_cck_rx_path) {\r\nDM_RxPathSelTable.cck_Rx_path = (cck_default_Rx<<2)|(cck_optional_Rx);\r\nrtl8192_setBBreg(dev, rCCK0_AFESetting, 0x0f000000, DM_RxPathSelTable.cck_Rx_path);\r\n}\r\nif (DM_RxPathSelTable.disabledRF) {\r\nfor (i = 0; i < 4; i++) {\r\nif ((DM_RxPathSelTable.disabledRF>>i) & 0x1) {\r\nif (tmp_max_rssi >= DM_RxPathSelTable.rf_enable_rssi_th[i]) {\r\nrtl8192_setBBreg(dev, rOFDM0_TRxPathEnable, 0x1<<i, 0x1);\r\nrtl8192_setBBreg(dev, rOFDM1_TRxPathEnable, 0x1<<i, 0x1);\r\nDM_RxPathSelTable.rf_enable_rssi_th[i] = 100;\r\ndisabled_rf_cnt--;\r\n}\r\n}\r\n}\r\n}\r\n}\r\nstatic void dm_check_rx_path_selection(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nqueue_delayed_work(priv->priv_wq, &priv->rfpath_check_wq, 0);\r\n}\r\nstatic void dm_init_fsync(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\npriv->ieee80211->fsync_time_interval = 500;\r\npriv->ieee80211->fsync_rate_bitmap = 0x0f000800;\r\npriv->ieee80211->fsync_rssi_threshold = 30;\r\npriv->ieee80211->bfsync_enable = false;\r\npriv->ieee80211->fsync_multiple_timeinterval = 3;\r\npriv->ieee80211->fsync_firstdiff_ratethreshold = 100;\r\npriv->ieee80211->fsync_seconddiff_ratethreshold = 200;\r\npriv->ieee80211->fsync_state = Default_Fsync;\r\npriv->framesyncMonitor = 1;\r\nsetup_timer(&priv->fsync_timer, dm_fsync_timer_callback,\r\n(unsigned long)dev);\r\n}\r\nstatic void dm_deInit_fsync(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\ndel_timer_sync(&priv->fsync_timer);\r\n}\r\nvoid dm_fsync_timer_callback(unsigned long data)\r\n{\r\nstruct net_device *dev = (struct net_device *)data;\r\nstruct r8192_priv *priv = ieee80211_priv((struct net_device *)data);\r\nu32 rate_index, rate_count = 0, rate_count_diff = 0;\r\nbool bSwitchFromCountDiff = false;\r\nbool bDoubleTimeInterval = false;\r\nif (priv->ieee80211->state == IEEE80211_LINKED &&\r\npriv->ieee80211->bfsync_enable &&\r\n(priv->ieee80211->pHTInfo->IOTAction & HT_IOT_ACT_CDD_FSYNC)) {\r\nu32 rate_bitmap;\r\nfor (rate_index = 0; rate_index <= 27; rate_index++) {\r\nrate_bitmap = 1 << rate_index;\r\nif (priv->ieee80211->fsync_rate_bitmap & rate_bitmap)\r\nrate_count += priv->stats.received_rate_histogram[1][rate_index];\r\n}\r\nif (rate_count < priv->rate_record)\r\nrate_count_diff = 0xffffffff - rate_count + priv->rate_record;\r\nelse\r\nrate_count_diff = rate_count - priv->rate_record;\r\nif (rate_count_diff < priv->rateCountDiffRecord) {\r\nu32 DiffNum = priv->rateCountDiffRecord - rate_count_diff;\r\nif (DiffNum >= priv->ieee80211->fsync_seconddiff_ratethreshold)\r\npriv->ContinueDiffCount++;\r\nelse\r\npriv->ContinueDiffCount = 0;\r\nif (priv->ContinueDiffCount >= 2) {\r\nbSwitchFromCountDiff = true;\r\npriv->ContinueDiffCount = 0;\r\n}\r\n} else {\r\npriv->ContinueDiffCount = 0;\r\n}\r\nif (rate_count_diff <= priv->ieee80211->fsync_firstdiff_ratethreshold) {\r\nbSwitchFromCountDiff = true;\r\npriv->ContinueDiffCount = 0;\r\n}\r\npriv->rate_record = rate_count;\r\npriv->rateCountDiffRecord = rate_count_diff;\r\nRT_TRACE(COMP_HALDM, "rateRecord %d rateCount %d, rateCountdiff %d bSwitchFsync %d\n", priv->rate_record, rate_count, rate_count_diff, priv->bswitch_fsync);\r\nif (priv->undecorated_smoothed_pwdb > priv->ieee80211->fsync_rssi_threshold && bSwitchFromCountDiff) {\r\nbDoubleTimeInterval = true;\r\npriv->bswitch_fsync = !priv->bswitch_fsync;\r\nif (priv->bswitch_fsync) {\r\nwrite_nic_byte(dev, 0xC36, 0x1c);\r\nwrite_nic_byte(dev, 0xC3e, 0x90);\r\n} else {\r\nwrite_nic_byte(dev, 0xC36, 0x5c);\r\nwrite_nic_byte(dev, 0xC3e, 0x96);\r\n}\r\n} else if (priv->undecorated_smoothed_pwdb <= priv->ieee80211->fsync_rssi_threshold) {\r\nif (priv->bswitch_fsync) {\r\npriv->bswitch_fsync = false;\r\nwrite_nic_byte(dev, 0xC36, 0x5c);\r\nwrite_nic_byte(dev, 0xC3e, 0x96);\r\n}\r\n}\r\nif (bDoubleTimeInterval) {\r\nif (timer_pending(&priv->fsync_timer))\r\ndel_timer_sync(&priv->fsync_timer);\r\npriv->fsync_timer.expires = jiffies +\r\nmsecs_to_jiffies(priv->ieee80211->fsync_time_interval*priv->ieee80211->fsync_multiple_timeinterval);\r\nadd_timer(&priv->fsync_timer);\r\n} else {\r\nif (timer_pending(&priv->fsync_timer))\r\ndel_timer_sync(&priv->fsync_timer);\r\npriv->fsync_timer.expires = jiffies +\r\nmsecs_to_jiffies(priv->ieee80211->fsync_time_interval);\r\nadd_timer(&priv->fsync_timer);\r\n}\r\n} else {\r\nif (priv->bswitch_fsync) {\r\npriv->bswitch_fsync = false;\r\nwrite_nic_byte(dev, 0xC36, 0x5c);\r\nwrite_nic_byte(dev, 0xC3e, 0x96);\r\n}\r\npriv->ContinueDiffCount = 0;\r\nwrite_nic_dword(dev, rOFDM0_RxDetector2, 0x465c52cd);\r\n}\r\nRT_TRACE(COMP_HALDM, "ContinueDiffCount %d\n", priv->ContinueDiffCount);\r\nRT_TRACE(COMP_HALDM, "rateRecord %d rateCount %d, rateCountdiff %d bSwitchFsync %d\n", priv->rate_record, rate_count, rate_count_diff, priv->bswitch_fsync);\r\n}\r\nstatic void dm_StartHWFsync(struct net_device *dev)\r\n{\r\nRT_TRACE(COMP_HALDM, "%s\n", __func__);\r\nwrite_nic_dword(dev, rOFDM0_RxDetector2, 0x465c12cf);\r\nwrite_nic_byte(dev, 0xc3b, 0x41);\r\n}\r\nstatic void dm_EndSWFsync(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nRT_TRACE(COMP_HALDM, "%s\n", __func__);\r\ndel_timer_sync(&(priv->fsync_timer));\r\nif (priv->bswitch_fsync) {\r\npriv->bswitch_fsync = false;\r\nwrite_nic_byte(dev, 0xC36, 0x5c);\r\nwrite_nic_byte(dev, 0xC3e, 0x96);\r\n}\r\npriv->ContinueDiffCount = 0;\r\nwrite_nic_dword(dev, rOFDM0_RxDetector2, 0x465c52cd);\r\n}\r\nstatic void dm_StartSWFsync(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nu32 rateIndex;\r\nu32 rateBitmap;\r\nRT_TRACE(COMP_HALDM, "%s\n", __func__);\r\npriv->rate_record = 0;\r\npriv->ContinueDiffCount = 0;\r\npriv->rateCountDiffRecord = 0;\r\npriv->bswitch_fsync = false;\r\nif (priv->ieee80211->mode == WIRELESS_MODE_N_24G) {\r\npriv->ieee80211->fsync_firstdiff_ratethreshold = 600;\r\npriv->ieee80211->fsync_seconddiff_ratethreshold = 0xffff;\r\n} else {\r\npriv->ieee80211->fsync_firstdiff_ratethreshold = 200;\r\npriv->ieee80211->fsync_seconddiff_ratethreshold = 200;\r\n}\r\nfor (rateIndex = 0; rateIndex <= 27; rateIndex++) {\r\nrateBitmap = 1 << rateIndex;\r\nif (priv->ieee80211->fsync_rate_bitmap & rateBitmap)\r\npriv->rate_record += priv->stats.received_rate_histogram[1][rateIndex];\r\n}\r\nif (timer_pending(&priv->fsync_timer))\r\ndel_timer_sync(&priv->fsync_timer);\r\npriv->fsync_timer.expires = jiffies +\r\nmsecs_to_jiffies(priv->ieee80211->fsync_time_interval);\r\nadd_timer(&priv->fsync_timer);\r\nwrite_nic_dword(dev, rOFDM0_RxDetector2, 0x465c12cd);\r\n}\r\nstatic void dm_EndHWFsync(struct net_device *dev)\r\n{\r\nRT_TRACE(COMP_HALDM, "%s\n", __func__);\r\nwrite_nic_dword(dev, rOFDM0_RxDetector2, 0x465c52cd);\r\nwrite_nic_byte(dev, 0xc3b, 0x49);\r\n}\r\nvoid dm_check_fsync(struct net_device *dev)\r\n{\r\n#define RegC38_Default 0\r\n#define RegC38_NonFsync_Other_AP 1\r\n#define RegC38_Fsync_AP_BCM 2\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nstatic u8 reg_c38_State = RegC38_Default;\r\nstatic u32 reset_cnt;\r\nRT_TRACE(COMP_HALDM, "RSSI %d TimeInterval %d MultipleTimeInterval %d\n", priv->ieee80211->fsync_rssi_threshold, priv->ieee80211->fsync_time_interval, priv->ieee80211->fsync_multiple_timeinterval);\r\nRT_TRACE(COMP_HALDM, "RateBitmap 0x%x FirstDiffRateThreshold %d SecondDiffRateThreshold %d\n", priv->ieee80211->fsync_rate_bitmap, priv->ieee80211->fsync_firstdiff_ratethreshold, priv->ieee80211->fsync_seconddiff_ratethreshold);\r\nif (priv->ieee80211->state == IEEE80211_LINKED &&\r\n(priv->ieee80211->pHTInfo->IOTAction & HT_IOT_ACT_CDD_FSYNC)) {\r\nif (priv->ieee80211->bfsync_enable == 0) {\r\nswitch (priv->ieee80211->fsync_state) {\r\ncase Default_Fsync:\r\ndm_StartHWFsync(dev);\r\npriv->ieee80211->fsync_state = HW_Fsync;\r\nbreak;\r\ncase SW_Fsync:\r\ndm_EndSWFsync(dev);\r\ndm_StartHWFsync(dev);\r\npriv->ieee80211->fsync_state = HW_Fsync;\r\nbreak;\r\ncase HW_Fsync:\r\ndefault:\r\nbreak;\r\n}\r\n} else {\r\nswitch (priv->ieee80211->fsync_state) {\r\ncase Default_Fsync:\r\ndm_StartSWFsync(dev);\r\npriv->ieee80211->fsync_state = SW_Fsync;\r\nbreak;\r\ncase HW_Fsync:\r\ndm_EndHWFsync(dev);\r\ndm_StartSWFsync(dev);\r\npriv->ieee80211->fsync_state = SW_Fsync;\r\nbreak;\r\ncase SW_Fsync:\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nif (priv->framesyncMonitor) {\r\nif (reg_c38_State != RegC38_Fsync_AP_BCM) {\r\nwrite_nic_byte(dev, rOFDM0_RxDetector3, 0x95);\r\nreg_c38_State = RegC38_Fsync_AP_BCM;\r\n}\r\n}\r\n} else {\r\nswitch (priv->ieee80211->fsync_state) {\r\ncase HW_Fsync:\r\ndm_EndHWFsync(dev);\r\npriv->ieee80211->fsync_state = Default_Fsync;\r\nbreak;\r\ncase SW_Fsync:\r\ndm_EndSWFsync(dev);\r\npriv->ieee80211->fsync_state = Default_Fsync;\r\nbreak;\r\ncase Default_Fsync:\r\ndefault:\r\nbreak;\r\n}\r\nif (priv->framesyncMonitor) {\r\nif (priv->ieee80211->state == IEEE80211_LINKED) {\r\nif (priv->undecorated_smoothed_pwdb <= RegC38_TH) {\r\nif (reg_c38_State != RegC38_NonFsync_Other_AP) {\r\nwrite_nic_byte(dev, rOFDM0_RxDetector3, 0x90);\r\nreg_c38_State = RegC38_NonFsync_Other_AP;\r\n}\r\n} else if (priv->undecorated_smoothed_pwdb >= (RegC38_TH+5)) {\r\nif (reg_c38_State) {\r\nwrite_nic_byte(dev, rOFDM0_RxDetector3, priv->framesync);\r\nreg_c38_State = RegC38_Default;\r\n}\r\n}\r\n} else {\r\nif (reg_c38_State) {\r\nwrite_nic_byte(dev, rOFDM0_RxDetector3, priv->framesync);\r\nreg_c38_State = RegC38_Default;\r\n}\r\n}\r\n}\r\n}\r\nif (priv->framesyncMonitor) {\r\nif (priv->reset_count != reset_cnt) {\r\nwrite_nic_byte(dev, rOFDM0_RxDetector3, priv->framesync);\r\nreg_c38_State = RegC38_Default;\r\nreset_cnt = priv->reset_count;\r\n}\r\n} else {\r\nif (reg_c38_State) {\r\nwrite_nic_byte(dev, rOFDM0_RxDetector3, priv->framesync);\r\nreg_c38_State = RegC38_Default;\r\n}\r\n}\r\n}\r\nvoid dm_shadow_init(struct net_device *dev)\r\n{\r\nu8 page;\r\nu16 offset;\r\nfor (page = 0; page < 5; page++)\r\nfor (offset = 0; offset < 256; offset++) {\r\nread_nic_byte(dev, offset+page*256, &dm_shadow[page][offset]);\r\n}\r\nfor (page = 8; page < 11; page++)\r\nfor (offset = 0; offset < 256; offset++)\r\nread_nic_byte(dev, offset+page*256, &dm_shadow[page][offset]);\r\nfor (page = 12; page < 15; page++)\r\nfor (offset = 0; offset < 256; offset++)\r\nread_nic_byte(dev, offset+page*256, &dm_shadow[page][offset]);\r\n}\r\nstatic void dm_init_dynamic_txpower(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\npriv->ieee80211->bdynamic_txpower_enable = true;\r\npriv->bLastDTPFlag_High = false;\r\npriv->bLastDTPFlag_Low = false;\r\npriv->bDynamicTxHighPower = false;\r\npriv->bDynamicTxLowPower = false;\r\n}\r\nstatic void dm_dynamic_txpower(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nunsigned int txhipower_threshhold = 0;\r\nunsigned int txlowpower_threshold = 0;\r\nif (priv->ieee80211->bdynamic_txpower_enable != true) {\r\npriv->bDynamicTxHighPower = false;\r\npriv->bDynamicTxLowPower = false;\r\nreturn;\r\n}\r\nif ((priv->ieee80211->current_network.atheros_cap_exist) && (priv->ieee80211->mode == IEEE_G)) {\r\ntxhipower_threshhold = TX_POWER_ATHEROAP_THRESH_HIGH;\r\ntxlowpower_threshold = TX_POWER_ATHEROAP_THRESH_LOW;\r\n} else {\r\ntxhipower_threshhold = TX_POWER_NEAR_FIELD_THRESH_HIGH;\r\ntxlowpower_threshold = TX_POWER_NEAR_FIELD_THRESH_LOW;\r\n}\r\nRT_TRACE(COMP_TXAGC, "priv->undecorated_smoothed_pwdb = %ld\n", priv->undecorated_smoothed_pwdb);\r\nif (priv->ieee80211->state == IEEE80211_LINKED) {\r\nif (priv->undecorated_smoothed_pwdb >= txhipower_threshhold) {\r\npriv->bDynamicTxHighPower = true;\r\npriv->bDynamicTxLowPower = false;\r\n} else {\r\nif (priv->undecorated_smoothed_pwdb < txlowpower_threshold && priv->bDynamicTxHighPower)\r\npriv->bDynamicTxHighPower = false;\r\nif (priv->undecorated_smoothed_pwdb < 35)\r\npriv->bDynamicTxLowPower = true;\r\nelse if (priv->undecorated_smoothed_pwdb >= 40)\r\npriv->bDynamicTxLowPower = false;\r\n}\r\n} else {\r\npriv->bDynamicTxHighPower = false;\r\npriv->bDynamicTxLowPower = false;\r\n}\r\nif ((priv->bDynamicTxHighPower != priv->bLastDTPFlag_High) ||\r\n(priv->bDynamicTxLowPower != priv->bLastDTPFlag_Low)) {\r\nRT_TRACE(COMP_TXAGC, "SetTxPowerLevel8190() channel = %d\n", priv->ieee80211->current_network.channel);\r\n#if defined(RTL8190P) || defined(RTL8192E)\r\nSetTxPowerLevel8190(Adapter, pHalData->CurrentChannel);\r\n#endif\r\nrtl8192_phy_setTxPower(dev, priv->ieee80211->current_network.channel);\r\n}\r\npriv->bLastDTPFlag_High = priv->bDynamicTxHighPower;\r\npriv->bLastDTPFlag_Low = priv->bDynamicTxLowPower;\r\n}\r\nstatic void dm_check_txrateandretrycount(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nstruct ieee80211_device *ieee = priv->ieee80211;\r\nread_nic_byte(dev, Current_Tx_Rate_Reg, &ieee->softmac_stats.CurrentShowTxate);\r\nread_nic_byte(dev, Initial_Tx_Rate_Reg, &ieee->softmac_stats.last_packet_rate);\r\nread_nic_dword(dev, Tx_Retry_Count_Reg, &ieee->softmac_stats.txretrycount);\r\n}\r\nstatic void dm_send_rssi_tofw(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = ieee80211_priv(dev);\r\nwrite_nic_byte(dev, DRIVER_RSSI, (u8)priv->undecorated_smoothed_pwdb);\r\n}

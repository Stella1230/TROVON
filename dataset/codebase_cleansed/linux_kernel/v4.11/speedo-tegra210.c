static u8 __init get_speedo_revision(void)\r\n{\r\nreturn tegra_fuse_read_spare(4) << 2 |\r\ntegra_fuse_read_spare(3) << 1 |\r\ntegra_fuse_read_spare(2) << 0;\r\n}\r\nstatic void __init rev_sku_to_speedo_ids(struct tegra_sku_info *sku_info,\r\nu8 speedo_rev, int *threshold)\r\n{\r\nint sku = sku_info->sku_id;\r\nsku_info->cpu_speedo_id = 0;\r\nsku_info->soc_speedo_id = 0;\r\nsku_info->gpu_speedo_id = 0;\r\n*threshold = THRESHOLD_INDEX_0;\r\nswitch (sku) {\r\ncase 0x00:\r\ncase 0x01:\r\ncase 0x07:\r\ncase 0x17:\r\ncase 0x27:\r\nif (speedo_rev >= 2)\r\nsku_info->gpu_speedo_id = 1;\r\nbreak;\r\ncase 0x13:\r\nif (speedo_rev >= 2)\r\nsku_info->gpu_speedo_id = 1;\r\nsku_info->cpu_speedo_id = 1;\r\nbreak;\r\ndefault:\r\npr_err("Tegra210: unknown SKU %#04x\n", sku);\r\nbreak;\r\n}\r\n}\r\nstatic int get_process_id(int value, const u32 *speedos, unsigned int num)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < num; i++)\r\nif (value < speedos[num])\r\nreturn i;\r\nreturn -EINVAL;\r\n}\r\nvoid __init tegra210_init_speedo_data(struct tegra_sku_info *sku_info)\r\n{\r\nint cpu_speedo[3], soc_speedo[3], cpu_iddq, gpu_iddq, soc_iddq;\r\nunsigned int index;\r\nu8 speedo_revision;\r\nBUILD_BUG_ON(ARRAY_SIZE(cpu_process_speedos) !=\r\nTHRESHOLD_INDEX_COUNT);\r\nBUILD_BUG_ON(ARRAY_SIZE(gpu_process_speedos) !=\r\nTHRESHOLD_INDEX_COUNT);\r\nBUILD_BUG_ON(ARRAY_SIZE(soc_process_speedos) !=\r\nTHRESHOLD_INDEX_COUNT);\r\ncpu_speedo[0] = tegra_fuse_read_early(FUSE_CPU_SPEEDO_0);\r\ncpu_speedo[1] = tegra_fuse_read_early(FUSE_CPU_SPEEDO_1);\r\ncpu_speedo[2] = tegra_fuse_read_early(FUSE_CPU_SPEEDO_2);\r\nsoc_speedo[0] = tegra_fuse_read_early(FUSE_SOC_SPEEDO_0);\r\nsoc_speedo[1] = tegra_fuse_read_early(FUSE_SOC_SPEEDO_1);\r\nsoc_speedo[2] = tegra_fuse_read_early(FUSE_CPU_SPEEDO_2);\r\ncpu_iddq = tegra_fuse_read_early(FUSE_CPU_IDDQ) * 4;\r\nsoc_iddq = tegra_fuse_read_early(FUSE_SOC_IDDQ) * 4;\r\ngpu_iddq = tegra_fuse_read_early(FUSE_GPU_IDDQ) * 5;\r\nspeedo_revision = get_speedo_revision();\r\npr_info("Speedo Revision %u\n", speedo_revision);\r\nif (speedo_revision >= 3) {\r\nsku_info->cpu_speedo_value = cpu_speedo[0];\r\nsku_info->gpu_speedo_value = cpu_speedo[2];\r\nsku_info->soc_speedo_value = soc_speedo[0];\r\n} else if (speedo_revision == 2) {\r\nsku_info->cpu_speedo_value = (-1938 + (1095 * cpu_speedo[0] / 100)) / 10;\r\nsku_info->gpu_speedo_value = (-1662 + (1082 * cpu_speedo[2] / 100)) / 10;\r\nsku_info->soc_speedo_value = ( -705 + (1037 * soc_speedo[0] / 100)) / 10;\r\n} else {\r\nsku_info->cpu_speedo_value = 2100;\r\nsku_info->gpu_speedo_value = cpu_speedo[2] - 75;\r\nsku_info->soc_speedo_value = 1900;\r\n}\r\nif ((sku_info->cpu_speedo_value <= 0) ||\r\n(sku_info->gpu_speedo_value <= 0) ||\r\n(sku_info->soc_speedo_value <= 0)) {\r\nWARN(1, "speedo value not fused\n");\r\nreturn;\r\n}\r\nrev_sku_to_speedo_ids(sku_info, speedo_revision, &index);\r\nsku_info->gpu_process_id = get_process_id(sku_info->gpu_speedo_value,\r\ngpu_process_speedos[index],\r\nGPU_PROCESS_CORNERS);\r\nsku_info->cpu_process_id = get_process_id(sku_info->cpu_speedo_value,\r\ncpu_process_speedos[index],\r\nCPU_PROCESS_CORNERS);\r\nsku_info->soc_process_id = get_process_id(sku_info->soc_speedo_value,\r\nsoc_process_speedos[index],\r\nSOC_PROCESS_CORNERS);\r\npr_debug("Tegra GPU Speedo ID=%d, Speedo Value=%d\n",\r\nsku_info->gpu_speedo_id, sku_info->gpu_speedo_value);\r\n}

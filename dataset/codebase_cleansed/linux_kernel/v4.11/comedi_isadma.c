void comedi_isadma_program(struct comedi_isadma_desc *desc)\r\n{\r\nunsigned long flags;\r\nflags = claim_dma_lock();\r\nclear_dma_ff(desc->chan);\r\nset_dma_mode(desc->chan, desc->mode);\r\nset_dma_addr(desc->chan, desc->hw_addr);\r\nset_dma_count(desc->chan, desc->size);\r\nenable_dma(desc->chan);\r\nrelease_dma_lock(flags);\r\n}\r\nunsigned int comedi_isadma_disable(unsigned int dma_chan)\r\n{\r\nunsigned long flags;\r\nunsigned int residue;\r\nflags = claim_dma_lock();\r\ndisable_dma(dma_chan);\r\nresidue = get_dma_residue(dma_chan);\r\nrelease_dma_lock(flags);\r\nreturn residue;\r\n}\r\nunsigned int comedi_isadma_disable_on_sample(unsigned int dma_chan,\r\nunsigned int size)\r\n{\r\nint stalled = 0;\r\nunsigned long flags;\r\nunsigned int residue;\r\nunsigned int new_residue;\r\nresidue = comedi_isadma_disable(dma_chan);\r\nwhile (residue % size) {\r\nflags = claim_dma_lock();\r\nenable_dma(dma_chan);\r\nrelease_dma_lock(flags);\r\nudelay(2);\r\nnew_residue = comedi_isadma_disable(dma_chan);\r\nif (new_residue == residue) {\r\nstalled++;\r\nif (stalled > 10)\r\nbreak;\r\n} else {\r\nresidue = new_residue;\r\nstalled = 0;\r\n}\r\n}\r\nreturn residue;\r\n}\r\nunsigned int comedi_isadma_poll(struct comedi_isadma *dma)\r\n{\r\nstruct comedi_isadma_desc *desc = &dma->desc[dma->cur_dma];\r\nunsigned long flags;\r\nunsigned int result;\r\nunsigned int result1;\r\nflags = claim_dma_lock();\r\nclear_dma_ff(desc->chan);\r\nif (!isa_dma_bridge_buggy)\r\ndisable_dma(desc->chan);\r\nresult = get_dma_residue(desc->chan);\r\nresult1 = get_dma_residue(desc->chan);\r\nif (!isa_dma_bridge_buggy)\r\nenable_dma(desc->chan);\r\nrelease_dma_lock(flags);\r\nif (result < result1)\r\nresult = result1;\r\nif (result >= desc->size || result == 0)\r\nreturn 0;\r\nreturn desc->size - result;\r\n}\r\nvoid comedi_isadma_set_mode(struct comedi_isadma_desc *desc, char dma_dir)\r\n{\r\ndesc->mode = (dma_dir == COMEDI_ISADMA_READ) ? DMA_MODE_READ\r\n: DMA_MODE_WRITE;\r\n}\r\nstruct comedi_isadma *comedi_isadma_alloc(struct comedi_device *dev,\r\nint n_desc, unsigned int dma_chan1,\r\nunsigned int dma_chan2,\r\nunsigned int maxsize, char dma_dir)\r\n{\r\nstruct comedi_isadma *dma = NULL;\r\nstruct comedi_isadma_desc *desc;\r\nunsigned int dma_chans[2];\r\nint i;\r\nif (n_desc < 1 || n_desc > 2)\r\ngoto no_dma;\r\ndma = kzalloc(sizeof(*dma), GFP_KERNEL);\r\nif (!dma)\r\ngoto no_dma;\r\ndesc = kcalloc(n_desc, sizeof(*desc), GFP_KERNEL);\r\nif (!desc)\r\ngoto no_dma;\r\ndma->desc = desc;\r\ndma->n_desc = n_desc;\r\ndma_chans[0] = dma_chan1;\r\nif (dma_chan2 == 0 || dma_chan2 == dma_chan1)\r\ndma_chans[1] = dma_chan1;\r\nelse\r\ndma_chans[1] = dma_chan2;\r\nif (request_dma(dma_chans[0], dev->board_name))\r\ngoto no_dma;\r\ndma->chan = dma_chans[0];\r\nif (dma_chans[1] != dma_chans[0]) {\r\nif (request_dma(dma_chans[1], dev->board_name))\r\ngoto no_dma;\r\n}\r\ndma->chan2 = dma_chans[1];\r\nfor (i = 0; i < n_desc; i++) {\r\ndesc = &dma->desc[i];\r\ndesc->chan = dma_chans[i];\r\ndesc->maxsize = maxsize;\r\ndesc->virt_addr = dma_alloc_coherent(NULL, desc->maxsize,\r\n&desc->hw_addr,\r\nGFP_KERNEL);\r\nif (!desc->virt_addr)\r\ngoto no_dma;\r\ncomedi_isadma_set_mode(desc, dma_dir);\r\n}\r\nreturn dma;\r\nno_dma:\r\ncomedi_isadma_free(dma);\r\nreturn NULL;\r\n}\r\nvoid comedi_isadma_free(struct comedi_isadma *dma)\r\n{\r\nstruct comedi_isadma_desc *desc;\r\nint i;\r\nif (!dma)\r\nreturn;\r\nif (dma->desc) {\r\nfor (i = 0; i < dma->n_desc; i++) {\r\ndesc = &dma->desc[i];\r\nif (desc->virt_addr)\r\ndma_free_coherent(NULL, desc->maxsize,\r\ndesc->virt_addr,\r\ndesc->hw_addr);\r\n}\r\nkfree(dma->desc);\r\n}\r\nif (dma->chan2 && dma->chan2 != dma->chan)\r\nfree_dma(dma->chan2);\r\nif (dma->chan)\r\nfree_dma(dma->chan);\r\nkfree(dma);\r\n}\r\nstatic int __init comedi_isadma_init(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit comedi_isadma_exit(void)\r\n{\r\n}

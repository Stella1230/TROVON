static char *op_str(unsigned int op, char *name_array[], int array_len)\r\n{\r\nif (op >= array_len)\r\nreturn "UNKNOWN_OP";\r\nreturn name_array[op];\r\n}\r\nlong cxl_h_attach_process(u64 unit_address,\r\nstruct cxl_process_element_hcall *element,\r\nu64 *process_token, u64 *mmio_addr, u64 *mmio_size)\r\n{\r\nunsigned long retbuf[PLPAR_HCALL_BUFSIZE];\r\nlong rc;\r\nCXL_H_WAIT_UNTIL_DONE(rc, retbuf, H_ATTACH_CA_PROCESS, unit_address, virt_to_phys(element));\r\n_PRINT_MSG(rc, "cxl_h_attach_process(%#.16llx, %#.16lx): %li\n",\r\nunit_address, virt_to_phys(element), rc);\r\ntrace_cxl_hcall_attach(unit_address, virt_to_phys(element), retbuf[0], retbuf[1], retbuf[2], rc);\r\npr_devel("token: 0x%.8lx mmio_addr: 0x%lx mmio_size: 0x%lx\nProcess Element Structure:\n",\r\nretbuf[0], retbuf[1], retbuf[2]);\r\ncxl_dump_debug_buffer(element, sizeof(*element));\r\nswitch (rc) {\r\ncase H_SUCCESS:\r\n*process_token = retbuf[0];\r\nif (mmio_addr)\r\n*mmio_addr = retbuf[1];\r\nif (mmio_size)\r\n*mmio_size = retbuf[2];\r\nreturn 0;\r\ncase H_PARAMETER:\r\ncase H_FUNCTION:\r\nreturn -EINVAL;\r\ncase H_AUTHORITY:\r\ncase H_RESOURCE:\r\ncase H_HARDWARE:\r\ncase H_STATE:\r\ncase H_BUSY:\r\nreturn -EBUSY;\r\ndefault:\r\nWARN(1, "Unexpected return code: %lx", rc);\r\nreturn -EINVAL;\r\n}\r\n}\r\nlong cxl_h_detach_process(u64 unit_address, u64 process_token)\r\n{\r\nunsigned long retbuf[PLPAR_HCALL_BUFSIZE];\r\nlong rc;\r\nCXL_H_WAIT_UNTIL_DONE(rc, retbuf, H_DETACH_CA_PROCESS, unit_address, process_token);\r\n_PRINT_MSG(rc, "cxl_h_detach_process(%#.16llx, 0x%.8llx): %li\n", unit_address, process_token, rc);\r\ntrace_cxl_hcall_detach(unit_address, process_token, rc);\r\nswitch (rc) {\r\ncase H_SUCCESS:\r\nreturn 0;\r\ncase H_PARAMETER:\r\nreturn -EINVAL;\r\ncase H_AUTHORITY:\r\ncase H_RESOURCE:\r\ncase H_HARDWARE:\r\ncase H_STATE:\r\ncase H_BUSY:\r\nreturn -EBUSY;\r\ndefault:\r\nWARN(1, "Unexpected return code: %lx", rc);\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic long cxl_h_control_function(u64 unit_address, u64 op,\r\nu64 p1, u64 p2, u64 p3, u64 p4, u64 *out)\r\n{\r\nunsigned long retbuf[PLPAR_HCALL9_BUFSIZE];\r\nlong rc;\r\nCXL_H9_WAIT_UNTIL_DONE(rc, retbuf, H_CONTROL_CA_FUNCTION, unit_address, op, p1, p2, p3, p4);\r\n_PRINT_MSG(rc, "cxl_h_control_function(%#.16llx, %s(%#llx, %#llx, %#llx, %#llx, R4: %#lx)): %li\n",\r\nunit_address, OP_STR_AFU(op), p1, p2, p3, p4, retbuf[0], rc);\r\ntrace_cxl_hcall_control_function(unit_address, OP_STR_AFU(op), p1, p2, p3, p4, retbuf[0], rc);\r\nswitch (rc) {\r\ncase H_SUCCESS:\r\nif ((op == H_CONTROL_CA_FUNCTION_GET_FUNCTION_ERR_INT ||\r\nop == H_CONTROL_CA_FUNCTION_READ_ERR_STATE ||\r\nop == H_CONTROL_CA_FUNCTION_COLLECT_VPD))\r\n*out = retbuf[0];\r\nreturn 0;\r\ncase H_PARAMETER:\r\ncase H_FUNCTION:\r\ncase H_NOT_FOUND:\r\ncase H_NOT_AVAILABLE:\r\ncase H_SG_LIST:\r\nreturn -EINVAL;\r\ncase H_AUTHORITY:\r\ncase H_RESOURCE:\r\ncase H_HARDWARE:\r\ncase H_STATE:\r\ncase H_BUSY:\r\nreturn -EBUSY;\r\ndefault:\r\nWARN(1, "Unexpected return code: %lx", rc);\r\nreturn -EINVAL;\r\n}\r\n}\r\nlong cxl_h_reset_afu(u64 unit_address)\r\n{\r\nreturn cxl_h_control_function(unit_address,\r\nH_CONTROL_CA_FUNCTION_RESET,\r\n0, 0, 0, 0,\r\nNULL);\r\n}\r\nlong cxl_h_suspend_process(u64 unit_address, u64 process_token)\r\n{\r\nreturn cxl_h_control_function(unit_address,\r\nH_CONTROL_CA_FUNCTION_SUSPEND_PROCESS,\r\nprocess_token, 0, 0, 0,\r\nNULL);\r\n}\r\nlong cxl_h_resume_process(u64 unit_address, u64 process_token)\r\n{\r\nreturn cxl_h_control_function(unit_address,\r\nH_CONTROL_CA_FUNCTION_RESUME_PROCESS,\r\nprocess_token, 0, 0, 0,\r\nNULL);\r\n}\r\nlong cxl_h_read_error_state(u64 unit_address, u64 *state)\r\n{\r\nreturn cxl_h_control_function(unit_address,\r\nH_CONTROL_CA_FUNCTION_READ_ERR_STATE,\r\n0, 0, 0, 0,\r\nstate);\r\n}\r\nlong cxl_h_get_afu_err(u64 unit_address, u64 offset,\r\nu64 buf_address, u64 len)\r\n{\r\nreturn cxl_h_control_function(unit_address,\r\nH_CONTROL_CA_FUNCTION_GET_AFU_ERR,\r\noffset, buf_address, len, 0,\r\nNULL);\r\n}\r\nlong cxl_h_get_config(u64 unit_address, u64 cr_num, u64 offset,\r\nu64 buf_address, u64 len)\r\n{\r\nreturn cxl_h_control_function(unit_address,\r\nH_CONTROL_CA_FUNCTION_GET_CONFIG,\r\ncr_num, offset, buf_address, len,\r\nNULL);\r\n}\r\nlong cxl_h_terminate_process(u64 unit_address, u64 process_token)\r\n{\r\nreturn cxl_h_control_function(unit_address,\r\nH_CONTROL_CA_FUNCTION_TERMINATE_PROCESS,\r\nprocess_token, 0, 0, 0,\r\nNULL);\r\n}\r\nlong cxl_h_collect_vpd(u64 unit_address, u64 record, u64 list_address,\r\nu64 num, u64 *out)\r\n{\r\nreturn cxl_h_control_function(unit_address,\r\nH_CONTROL_CA_FUNCTION_COLLECT_VPD,\r\nrecord, list_address, num, 0,\r\nout);\r\n}\r\nlong cxl_h_get_fn_error_interrupt(u64 unit_address, u64 *reg)\r\n{\r\nreturn cxl_h_control_function(unit_address,\r\nH_CONTROL_CA_FUNCTION_GET_FUNCTION_ERR_INT,\r\n0, 0, 0, 0, reg);\r\n}\r\nlong cxl_h_ack_fn_error_interrupt(u64 unit_address, u64 value)\r\n{\r\nreturn cxl_h_control_function(unit_address,\r\nH_CONTROL_CA_FUNCTION_ACK_FUNCTION_ERR_INT,\r\nvalue, 0, 0, 0,\r\nNULL);\r\n}\r\nlong cxl_h_get_error_log(u64 unit_address, u64 value)\r\n{\r\nreturn cxl_h_control_function(unit_address,\r\nH_CONTROL_CA_FUNCTION_GET_ERROR_LOG,\r\n0, 0, 0, 0,\r\nNULL);\r\n}\r\nlong cxl_h_collect_int_info(u64 unit_address, u64 process_token,\r\nstruct cxl_irq_info *info)\r\n{\r\nlong rc;\r\nBUG_ON(sizeof(*info) != sizeof(unsigned long[PLPAR_HCALL9_BUFSIZE]));\r\nrc = plpar_hcall9(H_COLLECT_CA_INT_INFO, (unsigned long *) info,\r\nunit_address, process_token);\r\n_PRINT_MSG(rc, "cxl_h_collect_int_info(%#.16llx, 0x%llx): %li\n",\r\nunit_address, process_token, rc);\r\ntrace_cxl_hcall_collect_int_info(unit_address, process_token, rc);\r\nswitch (rc) {\r\ncase H_SUCCESS:\r\npr_devel("dsisr:%#llx, dar:%#llx, dsr:%#llx, pid:%u, tid:%u, afu_err:%#llx, errstat:%#llx\n",\r\ninfo->dsisr, info->dar, info->dsr, info->pid,\r\ninfo->tid, info->afu_err, info->errstat);\r\nreturn 0;\r\ncase H_PARAMETER:\r\nreturn -EINVAL;\r\ncase H_AUTHORITY:\r\ncase H_HARDWARE:\r\ncase H_STATE:\r\nreturn -EBUSY;\r\ndefault:\r\nWARN(1, "Unexpected return code: %lx", rc);\r\nreturn -EINVAL;\r\n}\r\n}\r\nlong cxl_h_control_faults(u64 unit_address, u64 process_token,\r\nu64 control_mask, u64 reset_mask)\r\n{\r\nunsigned long retbuf[PLPAR_HCALL_BUFSIZE];\r\nlong rc;\r\nmemset(retbuf, 0, sizeof(retbuf));\r\nrc = plpar_hcall(H_CONTROL_CA_FAULTS, retbuf, unit_address,\r\nH_CONTROL_CA_FAULTS_RESPOND_PSL, process_token,\r\ncontrol_mask, reset_mask);\r\n_PRINT_MSG(rc, "cxl_h_control_faults(%#.16llx, 0x%llx, %#llx, %#llx): %li (%#lx)\n",\r\nunit_address, process_token, control_mask, reset_mask,\r\nrc, retbuf[0]);\r\ntrace_cxl_hcall_control_faults(unit_address, process_token,\r\ncontrol_mask, reset_mask, retbuf[0], rc);\r\nswitch (rc) {\r\ncase H_SUCCESS:\r\nreturn 0;\r\ncase H_PARAMETER:\r\nreturn -EINVAL;\r\ncase H_HARDWARE:\r\ncase H_STATE:\r\ncase H_AUTHORITY:\r\nreturn -EBUSY;\r\ncase H_FUNCTION:\r\ncase H_NOT_FOUND:\r\nreturn -EINVAL;\r\ndefault:\r\nWARN(1, "Unexpected return code: %lx", rc);\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic long cxl_h_control_facility(u64 unit_address, u64 op,\r\nu64 p1, u64 p2, u64 p3, u64 p4, u64 *out)\r\n{\r\nunsigned long retbuf[PLPAR_HCALL9_BUFSIZE];\r\nlong rc;\r\nCXL_H9_WAIT_UNTIL_DONE(rc, retbuf, H_CONTROL_CA_FACILITY, unit_address, op, p1, p2, p3, p4);\r\n_PRINT_MSG(rc, "cxl_h_control_facility(%#.16llx, %s(%#llx, %#llx, %#llx, %#llx, R4: %#lx)): %li\n",\r\nunit_address, OP_STR_CONTROL_ADAPTER(op), p1, p2, p3, p4, retbuf[0], rc);\r\ntrace_cxl_hcall_control_facility(unit_address, OP_STR_CONTROL_ADAPTER(op), p1, p2, p3, p4, retbuf[0], rc);\r\nswitch (rc) {\r\ncase H_SUCCESS:\r\nif (op == H_CONTROL_CA_FACILITY_COLLECT_VPD)\r\n*out = retbuf[0];\r\nreturn 0;\r\ncase H_PARAMETER:\r\ncase H_FUNCTION:\r\ncase H_NOT_FOUND:\r\ncase H_NOT_AVAILABLE:\r\ncase H_SG_LIST:\r\nreturn -EINVAL;\r\ncase H_AUTHORITY:\r\ncase H_RESOURCE:\r\ncase H_HARDWARE:\r\ncase H_STATE:\r\ncase H_BUSY:\r\nreturn -EBUSY;\r\ndefault:\r\nWARN(1, "Unexpected return code: %lx", rc);\r\nreturn -EINVAL;\r\n}\r\n}\r\nlong cxl_h_reset_adapter(u64 unit_address)\r\n{\r\nreturn cxl_h_control_facility(unit_address,\r\nH_CONTROL_CA_FACILITY_RESET,\r\n0, 0, 0, 0,\r\nNULL);\r\n}\r\nlong cxl_h_collect_vpd_adapter(u64 unit_address, u64 list_address,\r\nu64 num, u64 *out)\r\n{\r\nreturn cxl_h_control_facility(unit_address,\r\nH_CONTROL_CA_FACILITY_COLLECT_VPD,\r\nlist_address, num, 0, 0,\r\nout);\r\n}\r\nstatic long cxl_h_download_facility(u64 unit_address, u64 op,\r\nu64 list_address, u64 num,\r\nu64 *out)\r\n{\r\nunsigned long retbuf[PLPAR_HCALL_BUFSIZE];\r\nunsigned int delay, total_delay = 0;\r\nu64 token = 0;\r\nlong rc;\r\nif (*out != 0)\r\ntoken = *out;\r\nmemset(retbuf, 0, sizeof(retbuf));\r\nwhile (1) {\r\nrc = plpar_hcall(H_DOWNLOAD_CA_FACILITY, retbuf,\r\nunit_address, op, list_address, num,\r\ntoken);\r\ntoken = retbuf[0];\r\nif (rc != H_BUSY && !H_IS_LONG_BUSY(rc))\r\nbreak;\r\nif (rc != H_BUSY) {\r\ndelay = get_longbusy_msecs(rc);\r\ntotal_delay += delay;\r\nif (total_delay > CXL_HCALL_TIMEOUT_DOWNLOAD) {\r\nWARN(1, "Warning: Giving up waiting for CXL hcall "\r\n"%#x after %u msec\n",\r\nH_DOWNLOAD_CA_FACILITY, total_delay);\r\nrc = H_BUSY;\r\nbreak;\r\n}\r\nmsleep(delay);\r\n}\r\n}\r\n_PRINT_MSG(rc, "cxl_h_download_facility(%#.16llx, %s(%#llx, %#llx), %#lx): %li\n",\r\nunit_address, OP_STR_DOWNLOAD_ADAPTER(op), list_address, num, retbuf[0], rc);\r\ntrace_cxl_hcall_download_facility(unit_address, OP_STR_DOWNLOAD_ADAPTER(op), list_address, num, retbuf[0], rc);\r\nswitch (rc) {\r\ncase H_SUCCESS:\r\nreturn 0;\r\ncase H_PARAMETER:\r\ncase H_FUNCTION:\r\ncase H_SG_LIST:\r\ncase H_BAD_DATA:\r\nreturn -EINVAL;\r\ncase H_AUTHORITY:\r\ncase H_RESOURCE:\r\ncase H_HARDWARE:\r\ncase H_STATE:\r\ncase H_BUSY:\r\nreturn -EBUSY;\r\ncase H_CONTINUE:\r\n*out = retbuf[0];\r\nreturn 1;\r\ndefault:\r\nWARN(1, "Unexpected return code: %lx", rc);\r\nreturn -EINVAL;\r\n}\r\n}\r\nlong cxl_h_download_adapter_image(u64 unit_address,\r\nu64 list_address, u64 num,\r\nu64 *out)\r\n{\r\nreturn cxl_h_download_facility(unit_address,\r\nH_DOWNLOAD_CA_FACILITY_DOWNLOAD,\r\nlist_address, num, out);\r\n}\r\nlong cxl_h_validate_adapter_image(u64 unit_address,\r\nu64 list_address, u64 num,\r\nu64 *out)\r\n{\r\nreturn cxl_h_download_facility(unit_address,\r\nH_DOWNLOAD_CA_FACILITY_VALIDATE,\r\nlist_address, num, out);\r\n}

static int s3c24xx_uda134x_startup(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct s3c24xx_uda134x *priv = snd_soc_card_get_drvdata(rtd->card);\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nint ret = 0;\r\nmutex_lock(&priv->clk_lock);\r\nif (priv->clk_users == 0) {\r\npriv->xtal = clk_get(rtd->dev, "xtal");\r\nif (IS_ERR(priv->xtal)) {\r\ndev_err(rtd->dev, "%s cannot get xtal\n", __func__);\r\nret = PTR_ERR(priv->xtal);\r\n} else {\r\npriv->pclk = clk_get(cpu_dai->dev, "iis");\r\nif (IS_ERR(priv->pclk)) {\r\ndev_err(rtd->dev, "%s cannot get pclk\n",\r\n__func__);\r\nclk_put(priv->xtal);\r\nret = PTR_ERR(priv->pclk);\r\n}\r\n}\r\nif (!ret) {\r\nint i, j;\r\nfor (i = 0; i < 2; i++) {\r\nint fs = i ? 256 : 384;\r\nrates[i*33] = clk_get_rate(priv->xtal) / fs;\r\nfor (j = 1; j < 33; j++)\r\nrates[i*33 + j] = clk_get_rate(priv->pclk) /\r\n(j * fs);\r\n}\r\n}\r\n}\r\npriv->clk_users += 1;\r\nmutex_unlock(&priv->clk_lock);\r\nif (!ret) {\r\n#ifdef ENFORCE_RATES\r\nret = snd_pcm_hw_constraint_list(substream->runtime, 0,\r\nSNDRV_PCM_HW_PARAM_RATE,\r\n&hw_constraints_rates);\r\nif (ret < 0)\r\ndev_err(rtd->dev, "%s cannot set constraints\n",\r\n__func__);\r\n#endif\r\n}\r\nreturn ret;\r\n}\r\nstatic void s3c24xx_uda134x_shutdown(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct s3c24xx_uda134x *priv = snd_soc_card_get_drvdata(rtd->card);\r\nmutex_lock(&priv->clk_lock);\r\npriv->clk_users -= 1;\r\nif (priv->clk_users == 0) {\r\nclk_put(priv->xtal);\r\npriv->xtal = NULL;\r\nclk_put(priv->pclk);\r\npriv->pclk = NULL;\r\n}\r\nmutex_unlock(&priv->clk_lock);\r\n}\r\nstatic int s3c24xx_uda134x_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nunsigned int clk = 0;\r\nint ret = 0;\r\nint clk_source, fs_mode;\r\nunsigned long rate = params_rate(params);\r\nlong err, cerr;\r\nunsigned int div;\r\nint i, bi;\r\nerr = 999999;\r\nbi = 0;\r\nfor (i = 0; i < 2*33; i++) {\r\ncerr = rates[i] - rate;\r\nif (cerr < 0)\r\ncerr = -cerr;\r\nif (cerr < err) {\r\nerr = cerr;\r\nbi = i;\r\n}\r\n}\r\nif (bi / 33 == 1)\r\nfs_mode = S3C2410_IISMOD_256FS;\r\nelse\r\nfs_mode = S3C2410_IISMOD_384FS;\r\nif (bi % 33 == 0) {\r\nclk_source = S3C24XX_CLKSRC_MPLL;\r\ndiv = 1;\r\n} else {\r\nclk_source = S3C24XX_CLKSRC_PCLK;\r\ndiv = bi % 33;\r\n}\r\ndev_dbg(rtd->dev, "%s desired rate %lu, %d\n", __func__, rate, bi);\r\nclk = (fs_mode == S3C2410_IISMOD_384FS ? 384 : 256) * rate;\r\ndev_dbg(rtd->dev, "%s will use: %s %s %d sysclk %d err %ld\n", __func__,\r\nfs_mode == S3C2410_IISMOD_384FS ? "384FS" : "256FS",\r\nclk_source == S3C24XX_CLKSRC_MPLL ? "MPLLin" : "PCLK",\r\ndiv, clk, err);\r\nif ((err * 100 / rate) > 5) {\r\ndev_err(rtd->dev, "effective frequency too different "\r\n"from desired (%ld%%)\n", err * 100 / rate);\r\nreturn -EINVAL;\r\n}\r\nret = snd_soc_dai_set_sysclk(cpu_dai, clk_source , clk,\r\nSND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_clkdiv(cpu_dai, S3C24XX_DIV_MCLK, fs_mode);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_clkdiv(cpu_dai, S3C24XX_DIV_BCLK,\r\nS3C2410_IISMOD_32FS);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_clkdiv(cpu_dai, S3C24XX_DIV_PRESCALER,\r\nS3C24XX_PRESCALE(div, div));\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, 0, clk,\r\nSND_SOC_CLOCK_OUT);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int s3c24xx_uda134x_probe(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = &snd_soc_s3c24xx_uda134x;\r\nstruct s3c24xx_uda134x *priv;\r\nint ret;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nmutex_init(&priv->clk_lock);\r\ncard->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, card);\r\nsnd_soc_card_set_drvdata(card, priv);\r\nret = devm_snd_soc_register_card(&pdev->dev, card);\r\nif (ret)\r\ndev_err(&pdev->dev, "failed to register card: %d\n", ret);\r\nreturn ret;\r\n}

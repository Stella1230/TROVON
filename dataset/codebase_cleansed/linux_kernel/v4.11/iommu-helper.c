int iommu_is_span_boundary(unsigned int index, unsigned int nr,\r\nunsigned long shift,\r\nunsigned long boundary_size)\r\n{\r\nBUG_ON(!is_power_of_2(boundary_size));\r\nshift = (shift + index) & (boundary_size - 1);\r\nreturn shift + nr > boundary_size;\r\n}\r\nunsigned long iommu_area_alloc(unsigned long *map, unsigned long size,\r\nunsigned long start, unsigned int nr,\r\nunsigned long shift, unsigned long boundary_size,\r\nunsigned long align_mask)\r\n{\r\nunsigned long index;\r\nsize -= 1;\r\nagain:\r\nindex = bitmap_find_next_zero_area(map, size, start, nr, align_mask);\r\nif (index < size) {\r\nif (iommu_is_span_boundary(index, nr, shift, boundary_size)) {\r\nstart = ALIGN(shift + index, boundary_size) - shift;\r\ngoto again;\r\n}\r\nbitmap_set(map, index, nr);\r\nreturn index;\r\n}\r\nreturn -1;\r\n}

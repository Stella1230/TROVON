static int rockchip_ddrclk_sip_set_rate(struct clk_hw *hw, unsigned long drate,\r\nunsigned long prate)\r\n{\r\nstruct rockchip_ddrclk *ddrclk = to_rockchip_ddrclk_hw(hw);\r\nunsigned long flags;\r\nstruct arm_smccc_res res;\r\nspin_lock_irqsave(ddrclk->lock, flags);\r\narm_smccc_smc(ROCKCHIP_SIP_DRAM_FREQ, drate, 0,\r\nROCKCHIP_SIP_CONFIG_DRAM_SET_RATE,\r\n0, 0, 0, 0, &res);\r\nspin_unlock_irqrestore(ddrclk->lock, flags);\r\nreturn res.a0;\r\n}\r\nstatic unsigned long\r\nrockchip_ddrclk_sip_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct arm_smccc_res res;\r\narm_smccc_smc(ROCKCHIP_SIP_DRAM_FREQ, 0, 0,\r\nROCKCHIP_SIP_CONFIG_DRAM_GET_RATE,\r\n0, 0, 0, 0, &res);\r\nreturn res.a0;\r\n}\r\nstatic long rockchip_ddrclk_sip_round_rate(struct clk_hw *hw,\r\nunsigned long rate,\r\nunsigned long *prate)\r\n{\r\nstruct arm_smccc_res res;\r\narm_smccc_smc(ROCKCHIP_SIP_DRAM_FREQ, rate, 0,\r\nROCKCHIP_SIP_CONFIG_DRAM_ROUND_RATE,\r\n0, 0, 0, 0, &res);\r\nreturn res.a0;\r\n}\r\nstatic u8 rockchip_ddrclk_get_parent(struct clk_hw *hw)\r\n{\r\nstruct rockchip_ddrclk *ddrclk = to_rockchip_ddrclk_hw(hw);\r\nint num_parents = clk_hw_get_num_parents(hw);\r\nu32 val;\r\nval = clk_readl(ddrclk->reg_base +\r\nddrclk->mux_offset) >> ddrclk->mux_shift;\r\nval &= GENMASK(ddrclk->mux_width - 1, 0);\r\nif (val >= num_parents)\r\nreturn -EINVAL;\r\nreturn val;\r\n}\r\nstruct clk *rockchip_clk_register_ddrclk(const char *name, int flags,\r\nconst char *const *parent_names,\r\nu8 num_parents, int mux_offset,\r\nint mux_shift, int mux_width,\r\nint div_shift, int div_width,\r\nint ddr_flag, void __iomem *reg_base,\r\nspinlock_t *lock)\r\n{\r\nstruct rockchip_ddrclk *ddrclk;\r\nstruct clk_init_data init;\r\nstruct clk *clk;\r\nddrclk = kzalloc(sizeof(*ddrclk), GFP_KERNEL);\r\nif (!ddrclk)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.parent_names = parent_names;\r\ninit.num_parents = num_parents;\r\ninit.flags = flags;\r\ninit.flags |= CLK_SET_RATE_NO_REPARENT;\r\nswitch (ddr_flag) {\r\ncase ROCKCHIP_DDRCLK_SIP:\r\ninit.ops = &rockchip_ddrclk_sip_ops;\r\nbreak;\r\ndefault:\r\npr_err("%s: unsupported ddrclk type %d\n", __func__, ddr_flag);\r\nkfree(ddrclk);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nddrclk->reg_base = reg_base;\r\nddrclk->lock = lock;\r\nddrclk->hw.init = &init;\r\nddrclk->mux_offset = mux_offset;\r\nddrclk->mux_shift = mux_shift;\r\nddrclk->mux_width = mux_width;\r\nddrclk->div_shift = div_shift;\r\nddrclk->div_width = div_width;\r\nddrclk->ddr_flag = ddr_flag;\r\nclk = clk_register(NULL, &ddrclk->hw);\r\nif (IS_ERR(clk))\r\nkfree(ddrclk);\r\nreturn clk;\r\n}

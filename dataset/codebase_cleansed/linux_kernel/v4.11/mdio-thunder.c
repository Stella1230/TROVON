static int thunder_mdiobus_pci_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct device_node *node;\r\nstruct fwnode_handle *fwn;\r\nstruct thunder_mdiobus_nexus *nexus;\r\nint err;\r\nint i;\r\nnexus = devm_kzalloc(&pdev->dev, sizeof(*nexus), GFP_KERNEL);\r\nif (!nexus)\r\nreturn -ENOMEM;\r\npci_set_drvdata(pdev, nexus);\r\nerr = pcim_enable_device(pdev);\r\nif (err) {\r\ndev_err(&pdev->dev, "Failed to enable PCI device\n");\r\npci_set_drvdata(pdev, NULL);\r\nreturn err;\r\n}\r\nerr = pci_request_regions(pdev, KBUILD_MODNAME);\r\nif (err) {\r\ndev_err(&pdev->dev, "pci_request_regions failed\n");\r\ngoto err_disable_device;\r\n}\r\nnexus->bar0 = pcim_iomap(pdev, 0, pci_resource_len(pdev, 0));\r\nif (!nexus->bar0) {\r\nerr = -ENOMEM;\r\ngoto err_release_regions;\r\n}\r\ni = 0;\r\ndevice_for_each_child_node(&pdev->dev, fwn) {\r\nstruct resource r;\r\nstruct mii_bus *mii_bus;\r\nstruct cavium_mdiobus *bus;\r\nunion cvmx_smix_en smi_en;\r\nnode = to_of_node(fwn);\r\nif (!node)\r\nbreak;\r\nerr = of_address_to_resource(node, 0, &r);\r\nif (err) {\r\ndev_err(&pdev->dev,\r\n"Couldn't translate address for \"%s\"\n",\r\nnode->name);\r\nbreak;\r\n}\r\nmii_bus = devm_mdiobus_alloc_size(&pdev->dev, sizeof(*bus));\r\nif (!mii_bus)\r\nbreak;\r\nbus = mii_bus->priv;\r\nbus->mii_bus = mii_bus;\r\nnexus->buses[i] = bus;\r\ni++;\r\nbus->register_base = (u64)nexus->bar0 +\r\nr.start - pci_resource_start(pdev, 0);\r\nsmi_en.u64 = 0;\r\nsmi_en.s.en = 1;\r\noct_mdio_writeq(smi_en.u64, bus->register_base + SMI_EN);\r\nbus->mii_bus->name = KBUILD_MODNAME;\r\nsnprintf(bus->mii_bus->id, MII_BUS_ID_SIZE, "%llx", r.start);\r\nbus->mii_bus->parent = &pdev->dev;\r\nbus->mii_bus->read = cavium_mdiobus_read;\r\nbus->mii_bus->write = cavium_mdiobus_write;\r\nerr = of_mdiobus_register(bus->mii_bus, node);\r\nif (err)\r\ndev_err(&pdev->dev, "of_mdiobus_register failed\n");\r\ndev_info(&pdev->dev, "Added bus at %llx\n", r.start);\r\nif (i >= ARRAY_SIZE(nexus->buses))\r\nbreak;\r\n}\r\nreturn 0;\r\nerr_release_regions:\r\npci_release_regions(pdev);\r\nerr_disable_device:\r\npci_set_drvdata(pdev, NULL);\r\nreturn err;\r\n}\r\nstatic void thunder_mdiobus_pci_remove(struct pci_dev *pdev)\r\n{\r\nint i;\r\nstruct thunder_mdiobus_nexus *nexus = pci_get_drvdata(pdev);\r\nfor (i = 0; i < ARRAY_SIZE(nexus->buses); i++) {\r\nstruct cavium_mdiobus *bus = nexus->buses[i];\r\nif (!bus)\r\ncontinue;\r\nmdiobus_unregister(bus->mii_bus);\r\nmdiobus_free(bus->mii_bus);\r\noct_mdio_writeq(0, bus->register_base + SMI_EN);\r\n}\r\npci_set_drvdata(pdev, NULL);\r\n}

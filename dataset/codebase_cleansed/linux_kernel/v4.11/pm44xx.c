static int omap4_pm_suspend(void)\r\n{\r\nstruct power_state *pwrst;\r\nint state, ret = 0;\r\nu32 cpu_id = smp_processor_id();\r\nlist_for_each_entry(pwrst, &pwrst_list, node) {\r\npwrst->saved_state = pwrdm_read_next_pwrst(pwrst->pwrdm);\r\npwrst->saved_logic_state = pwrdm_read_logic_retst(pwrst->pwrdm);\r\n}\r\nlist_for_each_entry(pwrst, &pwrst_list, node) {\r\nomap_set_pwrdm_state(pwrst->pwrdm, pwrst->next_state);\r\npwrdm_set_logic_retst(pwrst->pwrdm, pwrst->next_logic_state);\r\n}\r\nomap4_enter_lowpower(cpu_id, cpu_suspend_state);\r\nlist_for_each_entry(pwrst, &pwrst_list, node) {\r\nstate = pwrdm_read_prev_pwrst(pwrst->pwrdm);\r\nif (state > pwrst->next_state) {\r\npr_info("Powerdomain (%s) didn't enter target state %d\n",\r\npwrst->pwrdm->name, pwrst->next_state);\r\nret = -1;\r\n}\r\nomap_set_pwrdm_state(pwrst->pwrdm, pwrst->saved_state);\r\npwrdm_set_logic_retst(pwrst->pwrdm, pwrst->saved_logic_state);\r\n}\r\nif (ret) {\r\npr_crit("Could not enter target state in pm_suspend\n");\r\npr_warn("A possible cause could be an old bootloader - try u-boot >= v2012.07\n");\r\n} else {\r\npr_info("Successfully put all powerdomains to target state\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init pwrdms_setup(struct powerdomain *pwrdm, void *unused)\r\n{\r\nstruct power_state *pwrst;\r\nif (!pwrdm->pwrsts)\r\nreturn 0;\r\nif (!strncmp(pwrdm->name, "cpu", 3)) {\r\nif (IS_PM44XX_ERRATUM(PM_OMAP4_CPU_OSWR_DISABLE))\r\ncpu_suspend_state = PWRDM_POWER_RET;\r\nreturn 0;\r\n}\r\npwrst = kmalloc(sizeof(struct power_state), GFP_ATOMIC);\r\nif (!pwrst)\r\nreturn -ENOMEM;\r\npwrst->pwrdm = pwrdm;\r\npwrst->next_state = pwrdm_get_valid_lp_state(pwrdm, false,\r\nPWRDM_POWER_RET);\r\npwrst->next_logic_state = pwrdm_get_valid_lp_state(pwrdm, true,\r\nPWRDM_POWER_OFF);\r\nlist_add(&pwrst->node, &pwrst_list);\r\nreturn omap_set_pwrdm_state(pwrst->pwrdm, pwrst->next_state);\r\n}\r\nstatic void omap_default_idle(void)\r\n{\r\nomap_do_wfi();\r\n}\r\nstatic inline int omap4plus_init_static_deps(const struct static_dep_map *map)\r\n{\r\nint ret;\r\nstruct clockdomain *from, *to;\r\nif (!map)\r\nreturn 0;\r\nwhile (map->from) {\r\nfrom = clkdm_lookup(map->from);\r\nto = clkdm_lookup(map->to);\r\nif (!from || !to) {\r\npr_err("Failed lookup %s or %s for wakeup dependency\n",\r\nmap->from, map->to);\r\nreturn -EINVAL;\r\n}\r\nret = clkdm_add_wkdep(from, to);\r\nif (ret) {\r\npr_err("Failed to add %s -> %s wakeup dependency(%d)\n",\r\nmap->from, map->to, ret);\r\nreturn ret;\r\n}\r\nmap++;\r\n}\r\nreturn 0;\r\n}\r\nint __init omap4_pm_init_early(void)\r\n{\r\nif (cpu_is_omap446x())\r\npm44xx_errata |= PM_OMAP4_ROM_SMP_BOOT_ERRATUM_GICD;\r\nif (soc_is_omap54xx() || soc_is_dra7xx())\r\npm44xx_errata |= PM_OMAP4_CPU_OSWR_DISABLE;\r\nreturn 0;\r\n}\r\nint __init omap4_pm_init(void)\r\n{\r\nint ret = 0;\r\nif (omap_rev() == OMAP4430_REV_ES1_0) {\r\nWARN(1, "Power Management not supported on OMAP4430 ES1.0\n");\r\nreturn -ENODEV;\r\n}\r\npr_info("Power Management for TI OMAP4+ devices.\n");\r\nif (cpu_is_omap44xx())\r\npr_warn("OMAP4 PM: u-boot >= v2012.07 is required for full PM support\n");\r\nret = pwrdm_for_each(pwrdms_setup, NULL);\r\nif (ret) {\r\npr_err("Failed to setup powerdomains.\n");\r\ngoto err2;\r\n}\r\nif (cpu_is_omap44xx())\r\nret = omap4plus_init_static_deps(omap4_static_dep_map);\r\nelse if (soc_is_omap54xx() || soc_is_dra7xx())\r\nret = omap4plus_init_static_deps(omap5_dra7_static_dep_map);\r\nif (ret) {\r\npr_err("Failed to initialise static dependencies.\n");\r\ngoto err2;\r\n}\r\nret = omap4_mpuss_init();\r\nif (ret) {\r\npr_err("Failed to initialise OMAP4 MPUSS\n");\r\ngoto err2;\r\n}\r\n(void) clkdm_for_each(omap_pm_clkdms_setup, NULL);\r\nomap_common_suspend_init(omap4_pm_suspend);\r\narm_pm_idle = omap_default_idle;\r\nif (cpu_is_omap44xx() || soc_is_omap54xx())\r\nomap4_idle_init();\r\nerr2:\r\nreturn ret;\r\n}

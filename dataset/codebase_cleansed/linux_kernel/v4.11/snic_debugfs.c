int\r\nsnic_debugfs_init(void)\r\n{\r\nint rc = -1;\r\nstruct dentry *de = NULL;\r\nde = debugfs_create_dir("snic", NULL);\r\nif (!de) {\r\nSNIC_DBG("Cannot create debugfs root\n");\r\nreturn rc;\r\n}\r\nsnic_glob->trc_root = de;\r\nde = debugfs_create_dir("statistics", snic_glob->trc_root);\r\nif (!de) {\r\nSNIC_DBG("Cannot create Statistics directory\n");\r\nreturn rc;\r\n}\r\nsnic_glob->stats_root = de;\r\nrc = 0;\r\nreturn rc;\r\n}\r\nvoid\r\nsnic_debugfs_term(void)\r\n{\r\ndebugfs_remove(snic_glob->stats_root);\r\nsnic_glob->stats_root = NULL;\r\ndebugfs_remove(snic_glob->trc_root);\r\nsnic_glob->trc_root = NULL;\r\n}\r\nstatic int\r\nsnic_reset_stats_open(struct inode *inode, struct file *filp)\r\n{\r\nSNIC_BUG_ON(!inode->i_private);\r\nfilp->private_data = inode->i_private;\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nsnic_reset_stats_read(struct file *filp,\r\nchar __user *ubuf,\r\nsize_t cnt,\r\nloff_t *ppos)\r\n{\r\nstruct snic *snic = (struct snic *) filp->private_data;\r\nchar buf[64];\r\nint len;\r\nlen = sprintf(buf, "%u\n", snic->reset_stats);\r\nreturn simple_read_from_buffer(ubuf, cnt, ppos, buf, len);\r\n}\r\nstatic ssize_t\r\nsnic_reset_stats_write(struct file *filp,\r\nconst char __user *ubuf,\r\nsize_t cnt,\r\nloff_t *ppos)\r\n{\r\nstruct snic *snic = (struct snic *) filp->private_data;\r\nstruct snic_stats *stats = &snic->s_stats;\r\nu64 *io_stats_p = (u64 *) &stats->io;\r\nu64 *fw_stats_p = (u64 *) &stats->fw;\r\nchar buf[64];\r\nunsigned long val;\r\nint ret;\r\nif (cnt >= sizeof(buf))\r\nreturn -EINVAL;\r\nif (copy_from_user(&buf, ubuf, cnt))\r\nreturn -EFAULT;\r\nbuf[cnt] = '\0';\r\nret = kstrtoul(buf, 10, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nsnic->reset_stats = val;\r\nif (snic->reset_stats) {\r\natomic64_set(&snic->io_cmpl_skip,\r\natomic64_read(&stats->io.active));\r\nmemset(&stats->abts, 0, sizeof(struct snic_abort_stats));\r\nmemset(&stats->reset, 0, sizeof(struct snic_reset_stats));\r\nmemset(&stats->misc, 0, sizeof(struct snic_misc_stats));\r\nmemset(io_stats_p+1,\r\n0,\r\nsizeof(struct snic_io_stats) - sizeof(u64));\r\nmemset(fw_stats_p+1,\r\n0,\r\nsizeof(struct snic_fw_stats) - sizeof(u64));\r\n}\r\n(*ppos)++;\r\nSNIC_HOST_INFO(snic->shost, "Reset Op: Driver statistics.\n");\r\nreturn cnt;\r\n}\r\nstatic int\r\nsnic_reset_stats_release(struct inode *inode, struct file *filp)\r\n{\r\nfilp->private_data = NULL;\r\nreturn 0;\r\n}\r\nstatic int\r\nsnic_stats_show(struct seq_file *sfp, void *data)\r\n{\r\nstruct snic *snic = (struct snic *) sfp->private;\r\nstruct snic_stats *stats = &snic->s_stats;\r\nstruct timespec last_isr_tms, last_ack_tms;\r\nu64 maxio_tm;\r\nint i;\r\nseq_printf(sfp,\r\n"------------------------------------------\n"\r\n"\t\t IO Statistics\n"\r\n"------------------------------------------\n");\r\nmaxio_tm = (u64) atomic64_read(&stats->io.max_time);\r\nseq_printf(sfp,\r\n"Active IOs : %lld\n"\r\n"Max Active IOs : %lld\n"\r\n"Total IOs : %lld\n"\r\n"IOs Completed : %lld\n"\r\n"IOs Failed : %lld\n"\r\n"IOs Not Found : %lld\n"\r\n"Memory Alloc Failures : %lld\n"\r\n"REQs Null : %lld\n"\r\n"SCSI Cmd Pointers Null : %lld\n"\r\n"Max SGL for any IO : %lld\n"\r\n"Max IO Size : %lld Sectors\n"\r\n"Max Queuing Time : %lld\n"\r\n"Max Completion Time : %lld\n"\r\n"Max IO Process Time(FW) : %lld (%u msec)\n",\r\n(u64) atomic64_read(&stats->io.active),\r\n(u64) atomic64_read(&stats->io.max_active),\r\n(u64) atomic64_read(&stats->io.num_ios),\r\n(u64) atomic64_read(&stats->io.compl),\r\n(u64) atomic64_read(&stats->io.fail),\r\n(u64) atomic64_read(&stats->io.io_not_found),\r\n(u64) atomic64_read(&stats->io.alloc_fail),\r\n(u64) atomic64_read(&stats->io.req_null),\r\n(u64) atomic64_read(&stats->io.sc_null),\r\n(u64) atomic64_read(&stats->io.max_sgl),\r\n(u64) atomic64_read(&stats->io.max_io_sz),\r\n(u64) atomic64_read(&stats->io.max_qtime),\r\n(u64) atomic64_read(&stats->io.max_cmpl_time),\r\nmaxio_tm,\r\njiffies_to_msecs(maxio_tm));\r\nseq_puts(sfp, "\nSGL Counters\n");\r\nfor (i = 0; i < SNIC_MAX_SG_DESC_CNT; i++) {\r\nseq_printf(sfp,\r\n"%10lld ",\r\n(u64) atomic64_read(&stats->io.sgl_cnt[i]));\r\nif ((i + 1) % 8 == 0)\r\nseq_puts(sfp, "\n");\r\n}\r\nseq_printf(sfp,\r\n"\n-------------------------------------------\n"\r\n"\t\t Abort Statistics\n"\r\n"---------------------------------------------\n");\r\nseq_printf(sfp,\r\n"Aborts : %lld\n"\r\n"Aborts Fail : %lld\n"\r\n"Aborts Driver Timeout : %lld\n"\r\n"Abort FW Timeout : %lld\n"\r\n"Abort IO NOT Found : %lld\n"\r\n"Abort Queuing Failed : %lld\n",\r\n(u64) atomic64_read(&stats->abts.num),\r\n(u64) atomic64_read(&stats->abts.fail),\r\n(u64) atomic64_read(&stats->abts.drv_tmo),\r\n(u64) atomic64_read(&stats->abts.fw_tmo),\r\n(u64) atomic64_read(&stats->abts.io_not_found),\r\n(u64) atomic64_read(&stats->abts.q_fail));\r\nseq_printf(sfp,\r\n"\n-------------------------------------------\n"\r\n"\t\t Reset Statistics\n"\r\n"---------------------------------------------\n");\r\nseq_printf(sfp,\r\n"HBA Resets : %lld\n"\r\n"HBA Reset Cmpls : %lld\n"\r\n"HBA Reset Fail : %lld\n",\r\n(u64) atomic64_read(&stats->reset.hba_resets),\r\n(u64) atomic64_read(&stats->reset.hba_reset_cmpl),\r\n(u64) atomic64_read(&stats->reset.hba_reset_fail));\r\nseq_printf(sfp,\r\n"\n-------------------------------------------\n"\r\n"\t\t Firmware Statistics\n"\r\n"---------------------------------------------\n");\r\nseq_printf(sfp,\r\n"Active FW Requests : %lld\n"\r\n"Max FW Requests : %lld\n"\r\n"FW Out Of Resource Errs : %lld\n"\r\n"FW IO Errors : %lld\n"\r\n"FW SCSI Errors : %lld\n",\r\n(u64) atomic64_read(&stats->fw.actv_reqs),\r\n(u64) atomic64_read(&stats->fw.max_actv_reqs),\r\n(u64) atomic64_read(&stats->fw.out_of_res),\r\n(u64) atomic64_read(&stats->fw.io_errs),\r\n(u64) atomic64_read(&stats->fw.scsi_errs));\r\nseq_printf(sfp,\r\n"\n---------------------------------------------\n"\r\n"\t\t Other Statistics\n"\r\n"\n---------------------------------------------\n");\r\njiffies_to_timespec(stats->misc.last_isr_time, &last_isr_tms);\r\njiffies_to_timespec(stats->misc.last_ack_time, &last_ack_tms);\r\nseq_printf(sfp,\r\n"Last ISR Time : %llu (%8lu.%8lu)\n"\r\n"Last Ack Time : %llu (%8lu.%8lu)\n"\r\n"Ack ISRs : %llu\n"\r\n"IO Cmpl ISRs : %llu\n"\r\n"Err Notify ISRs : %llu\n"\r\n"Max CQ Entries : %lld\n"\r\n"Data Count Mismatch : %lld\n"\r\n"IOs w/ Timeout Status : %lld\n"\r\n"IOs w/ Aborted Status : %lld\n"\r\n"IOs w/ SGL Invalid Stat : %lld\n"\r\n"WQ Desc Alloc Fail : %lld\n"\r\n"Queue Full : %lld\n"\r\n"Queue Ramp Up : %lld\n"\r\n"Queue Ramp Down : %lld\n"\r\n"Queue Last Queue Depth : %lld\n"\r\n"Target Not Ready : %lld\n",\r\n(u64) stats->misc.last_isr_time,\r\nlast_isr_tms.tv_sec, last_isr_tms.tv_nsec,\r\n(u64)stats->misc.last_ack_time,\r\nlast_ack_tms.tv_sec, last_ack_tms.tv_nsec,\r\n(u64) atomic64_read(&stats->misc.ack_isr_cnt),\r\n(u64) atomic64_read(&stats->misc.cmpl_isr_cnt),\r\n(u64) atomic64_read(&stats->misc.errnotify_isr_cnt),\r\n(u64) atomic64_read(&stats->misc.max_cq_ents),\r\n(u64) atomic64_read(&stats->misc.data_cnt_mismat),\r\n(u64) atomic64_read(&stats->misc.io_tmo),\r\n(u64) atomic64_read(&stats->misc.io_aborted),\r\n(u64) atomic64_read(&stats->misc.sgl_inval),\r\n(u64) atomic64_read(&stats->misc.wq_alloc_fail),\r\n(u64) atomic64_read(&stats->misc.qfull),\r\n(u64) atomic64_read(&stats->misc.qsz_rampup),\r\n(u64) atomic64_read(&stats->misc.qsz_rampdown),\r\n(u64) atomic64_read(&stats->misc.last_qsz),\r\n(u64) atomic64_read(&stats->misc.tgt_not_rdy));\r\nreturn 0;\r\n}\r\nstatic int\r\nsnic_stats_open(struct inode *inode, struct file *filp)\r\n{\r\nreturn single_open(filp, snic_stats_show, inode->i_private);\r\n}\r\nint\r\nsnic_stats_debugfs_init(struct snic *snic)\r\n{\r\nint rc = -1;\r\nchar name[16];\r\nstruct dentry *de = NULL;\r\nsnprintf(name, sizeof(name), "host%d", snic->shost->host_no);\r\nif (!snic_glob->stats_root) {\r\nSNIC_DBG("snic_stats root doesn't exist\n");\r\nreturn rc;\r\n}\r\nde = debugfs_create_dir(name, snic_glob->stats_root);\r\nif (!de) {\r\nSNIC_DBG("Cannot create host directory\n");\r\nreturn rc;\r\n}\r\nsnic->stats_host = de;\r\nde = debugfs_create_file("stats",\r\nS_IFREG|S_IRUGO,\r\nsnic->stats_host,\r\nsnic,\r\n&snic_stats_fops);\r\nif (!de) {\r\nSNIC_DBG("Cannot create host's stats file\n");\r\nreturn rc;\r\n}\r\nsnic->stats_file = de;\r\nde = debugfs_create_file("reset_stats",\r\nS_IFREG|S_IRUGO|S_IWUSR,\r\nsnic->stats_host,\r\nsnic,\r\n&snic_reset_stats_fops);\r\nif (!de) {\r\nSNIC_DBG("Cannot create host's reset_stats file\n");\r\nreturn rc;\r\n}\r\nsnic->reset_stats_file = de;\r\nrc = 0;\r\nreturn rc;\r\n}\r\nvoid\r\nsnic_stats_debugfs_remove(struct snic *snic)\r\n{\r\ndebugfs_remove(snic->stats_file);\r\nsnic->stats_file = NULL;\r\ndebugfs_remove(snic->reset_stats_file);\r\nsnic->reset_stats_file = NULL;\r\ndebugfs_remove(snic->stats_host);\r\nsnic->stats_host = NULL;\r\n}\r\nstatic void *\r\nsnic_trc_seq_start(struct seq_file *sfp, loff_t *pos)\r\n{\r\nreturn &snic_glob->trc;\r\n}\r\nstatic void *\r\nsnic_trc_seq_next(struct seq_file *sfp, void *data, loff_t *pos)\r\n{\r\nreturn NULL;\r\n}\r\nstatic void\r\nsnic_trc_seq_stop(struct seq_file *sfp, void *data)\r\n{\r\n}\r\nstatic int\r\nsnic_trc_seq_show(struct seq_file *sfp, void *data)\r\n{\r\nchar buf[SNIC_TRC_PBLEN];\r\nif (snic_get_trc_data(buf, SNIC_TRC_PBLEN) > 0)\r\nseq_printf(sfp, "%s\n", buf);\r\nreturn 0;\r\n}\r\nstatic int\r\nsnic_trc_open(struct inode *inode, struct file *filp)\r\n{\r\nreturn seq_open(filp, &snic_trc_seq_ops);\r\n}\r\nint\r\nsnic_trc_debugfs_init(void)\r\n{\r\nstruct dentry *de = NULL;\r\nint ret = -1;\r\nif (!snic_glob->trc_root) {\r\nSNIC_ERR("Debugfs root directory for snic doesn't exist.\n");\r\nreturn ret;\r\n}\r\nde = debugfs_create_bool("tracing_enable",\r\nS_IFREG | S_IRUGO | S_IWUSR,\r\nsnic_glob->trc_root,\r\n&snic_glob->trc.enable);\r\nif (!de) {\r\nSNIC_ERR("Can't create trace_enable file.\n");\r\nreturn ret;\r\n}\r\nsnic_glob->trc.trc_enable = de;\r\nde = debugfs_create_file("trace",\r\nS_IFREG | S_IRUGO | S_IWUSR,\r\nsnic_glob->trc_root,\r\nNULL,\r\n&snic_trc_fops);\r\nif (!de) {\r\nSNIC_ERR("Cann't create trace file.\n");\r\nreturn ret;\r\n}\r\nsnic_glob->trc.trc_file = de;\r\nret = 0;\r\nreturn ret;\r\n}\r\nvoid\r\nsnic_trc_debugfs_term(void)\r\n{\r\ndebugfs_remove(snic_glob->trc.trc_file);\r\nsnic_glob->trc.trc_file = NULL;\r\ndebugfs_remove(snic_glob->trc.trc_enable);\r\nsnic_glob->trc.trc_enable = NULL;\r\n}

static union ieee754dp _dp_maddf(union ieee754dp z, union ieee754dp x,\r\nunion ieee754dp y, enum maddf_flags flags)\r\n{\r\nint re;\r\nint rs;\r\nu64 rm;\r\nunsigned lxm;\r\nunsigned hxm;\r\nunsigned lym;\r\nunsigned hym;\r\nu64 lrm;\r\nu64 hrm;\r\nu64 t;\r\nu64 at;\r\nint s;\r\nCOMPXDP;\r\nCOMPYDP;\r\nCOMPZDP;\r\nEXPLODEXDP;\r\nEXPLODEYDP;\r\nEXPLODEZDP;\r\nFLUSHXDP;\r\nFLUSHYDP;\r\nFLUSHZDP;\r\nieee754_clearcx();\r\nswitch (zc) {\r\ncase IEEE754_CLASS_SNAN:\r\nieee754_setcx(IEEE754_INVALID_OPERATION);\r\nreturn ieee754dp_nanxcpt(z);\r\ncase IEEE754_CLASS_DNORM:\r\nDPDNORMZ;\r\n}\r\nswitch (CLPAIR(xc, yc)) {\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_SNAN):\r\nreturn ieee754dp_nanxcpt(y);\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_ZERO):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_NORM):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_DNORM):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_INF):\r\nreturn ieee754dp_nanxcpt(x);\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_QNAN):\r\nreturn y;\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_ZERO):\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_NORM):\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_DNORM):\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_INF):\r\nreturn x;\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_ZERO):\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_INF):\r\nif (zc == IEEE754_CLASS_QNAN)\r\nreturn z;\r\nieee754_setcx(IEEE754_INVALID_OPERATION);\r\nreturn ieee754dp_indef();\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_INF):\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_INF):\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_NORM):\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_DNORM):\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_INF):\r\nif (zc == IEEE754_CLASS_QNAN)\r\nreturn z;\r\nreturn ieee754dp_inf(xs ^ ys);\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_ZERO):\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_NORM):\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_DNORM):\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_ZERO):\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_ZERO):\r\nif (zc == IEEE754_CLASS_INF)\r\nreturn ieee754dp_inf(zs);\r\nreturn z;\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_DNORM):\r\nDPDNORMX;\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_DNORM):\r\nif (zc == IEEE754_CLASS_QNAN)\r\nreturn z;\r\nelse if (zc == IEEE754_CLASS_INF)\r\nreturn ieee754dp_inf(zs);\r\nDPDNORMY;\r\nbreak;\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_NORM):\r\nif (zc == IEEE754_CLASS_QNAN)\r\nreturn z;\r\nelse if (zc == IEEE754_CLASS_INF)\r\nreturn ieee754dp_inf(zs);\r\nDPDNORMX;\r\nbreak;\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_NORM):\r\nif (zc == IEEE754_CLASS_QNAN)\r\nreturn z;\r\nelse if (zc == IEEE754_CLASS_INF)\r\nreturn ieee754dp_inf(zs);\r\n}\r\nassert(xm & DP_HIDDEN_BIT);\r\nassert(ym & DP_HIDDEN_BIT);\r\nre = xe + ye;\r\nrs = xs ^ ys;\r\nif (flags & maddf_negate_product)\r\nrs ^= 1;\r\nxm <<= 64 - (DP_FBITS + 1);\r\nym <<= 64 - (DP_FBITS + 1);\r\n#define DPXMULT(x, y) ((u64)(x) * (u64)y)\r\nlxm = xm;\r\nhxm = xm >> 32;\r\nlym = ym;\r\nhym = ym >> 32;\r\nlrm = DPXMULT(lxm, lym);\r\nhrm = DPXMULT(hxm, hym);\r\nt = DPXMULT(lxm, hym);\r\nat = lrm + (t << 32);\r\nhrm += at < lrm;\r\nlrm = at;\r\nhrm = hrm + (t >> 32);\r\nt = DPXMULT(hxm, lym);\r\nat = lrm + (t << 32);\r\nhrm += at < lrm;\r\nlrm = at;\r\nhrm = hrm + (t >> 32);\r\nrm = hrm | (lrm != 0);\r\nif ((s64) rm < 0) {\r\nrm = (rm >> (64 - (DP_FBITS + 1 + 3))) |\r\n((rm << (DP_FBITS + 1 + 3)) != 0);\r\nre++;\r\n} else {\r\nrm = (rm >> (64 - (DP_FBITS + 1 + 3 + 1))) |\r\n((rm << (DP_FBITS + 1 + 3 + 1)) != 0);\r\n}\r\nassert(rm & (DP_HIDDEN_BIT << 3));\r\nassert(zm & DP_HIDDEN_BIT);\r\nzm <<= 3;\r\nif (ze > re) {\r\ns = ze - re;\r\nrm = XDPSRS(rm, s);\r\nre += s;\r\n} else if (re > ze) {\r\ns = re - ze;\r\nzm = XDPSRS(zm, s);\r\nze += s;\r\n}\r\nassert(ze == re);\r\nassert(ze <= DP_EMAX);\r\nif (zs == rs) {\r\nzm = zm + rm;\r\nif (zm >> (DP_FBITS + 1 + 3)) {\r\nzm = XDPSRS1(zm);\r\nze++;\r\n}\r\n} else {\r\nif (zm >= rm) {\r\nzm = zm - rm;\r\n} else {\r\nzm = rm - zm;\r\nzs = rs;\r\n}\r\nif (zm == 0)\r\nreturn ieee754dp_zero(ieee754_csr.rm == FPU_CSR_RD);\r\nwhile ((zm >> (DP_FBITS + 3)) == 0) {\r\nzm <<= 1;\r\nze--;\r\n}\r\n}\r\nreturn ieee754dp_format(zs, ze, zm);\r\n}\r\nunion ieee754dp ieee754dp_maddf(union ieee754dp z, union ieee754dp x,\r\nunion ieee754dp y)\r\n{\r\nreturn _dp_maddf(z, x, y, 0);\r\n}\r\nunion ieee754dp ieee754dp_msubf(union ieee754dp z, union ieee754dp x,\r\nunion ieee754dp y)\r\n{\r\nreturn _dp_maddf(z, x, y, maddf_negate_product);\r\n}

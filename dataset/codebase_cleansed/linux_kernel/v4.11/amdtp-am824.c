int amdtp_am824_set_parameters(struct amdtp_stream *s, unsigned int rate,\r\nunsigned int pcm_channels,\r\nunsigned int midi_ports,\r\nbool double_pcm_frames)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\nunsigned int midi_channels;\r\nunsigned int i;\r\nint err;\r\nif (amdtp_stream_running(s))\r\nreturn -EINVAL;\r\nif (pcm_channels > AM824_MAX_CHANNELS_FOR_PCM)\r\nreturn -EINVAL;\r\nmidi_channels = DIV_ROUND_UP(midi_ports, 8);\r\nif (midi_channels > AM824_MAX_CHANNELS_FOR_MIDI)\r\nreturn -EINVAL;\r\nif (WARN_ON(amdtp_stream_running(s)) ||\r\nWARN_ON(pcm_channels > AM824_MAX_CHANNELS_FOR_PCM) ||\r\nWARN_ON(midi_channels > AM824_MAX_CHANNELS_FOR_MIDI))\r\nreturn -EINVAL;\r\nerr = amdtp_stream_set_parameters(s, rate,\r\npcm_channels + midi_channels);\r\nif (err < 0)\r\nreturn err;\r\ns->fdf = AMDTP_FDF_AM824 | s->sfc;\r\np->pcm_channels = pcm_channels;\r\np->midi_ports = midi_ports;\r\nif (double_pcm_frames)\r\np->frame_multiplier = 2;\r\nelse\r\np->frame_multiplier = 1;\r\nfor (i = 0; i < pcm_channels; i++)\r\np->pcm_positions[i] = i;\r\np->midi_position = p->pcm_channels;\r\np->midi_fifo_limit = rate - MIDI_BYTES_PER_SECOND * s->syt_interval + 1;\r\nreturn 0;\r\n}\r\nvoid amdtp_am824_set_pcm_position(struct amdtp_stream *s, unsigned int index,\r\nunsigned int position)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\nif (index < p->pcm_channels)\r\np->pcm_positions[index] = position;\r\n}\r\nvoid amdtp_am824_set_midi_position(struct amdtp_stream *s,\r\nunsigned int position)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\np->midi_position = position;\r\n}\r\nstatic void write_pcm_s32(struct amdtp_stream *s,\r\nstruct snd_pcm_substream *pcm,\r\n__be32 *buffer, unsigned int frames)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\nstruct snd_pcm_runtime *runtime = pcm->runtime;\r\nunsigned int channels, remaining_frames, i, c;\r\nconst u32 *src;\r\nchannels = p->pcm_channels;\r\nsrc = (void *)runtime->dma_area +\r\nframes_to_bytes(runtime, s->pcm_buffer_pointer);\r\nremaining_frames = runtime->buffer_size - s->pcm_buffer_pointer;\r\nfor (i = 0; i < frames; ++i) {\r\nfor (c = 0; c < channels; ++c) {\r\nbuffer[p->pcm_positions[c]] =\r\ncpu_to_be32((*src >> 8) | 0x40000000);\r\nsrc++;\r\n}\r\nbuffer += s->data_block_quadlets;\r\nif (--remaining_frames == 0)\r\nsrc = (void *)runtime->dma_area;\r\n}\r\n}\r\nstatic void write_pcm_s16(struct amdtp_stream *s,\r\nstruct snd_pcm_substream *pcm,\r\n__be32 *buffer, unsigned int frames)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\nstruct snd_pcm_runtime *runtime = pcm->runtime;\r\nunsigned int channels, remaining_frames, i, c;\r\nconst u16 *src;\r\nchannels = p->pcm_channels;\r\nsrc = (void *)runtime->dma_area +\r\nframes_to_bytes(runtime, s->pcm_buffer_pointer);\r\nremaining_frames = runtime->buffer_size - s->pcm_buffer_pointer;\r\nfor (i = 0; i < frames; ++i) {\r\nfor (c = 0; c < channels; ++c) {\r\nbuffer[p->pcm_positions[c]] =\r\ncpu_to_be32((*src << 8) | 0x42000000);\r\nsrc++;\r\n}\r\nbuffer += s->data_block_quadlets;\r\nif (--remaining_frames == 0)\r\nsrc = (void *)runtime->dma_area;\r\n}\r\n}\r\nstatic void read_pcm_s32(struct amdtp_stream *s,\r\nstruct snd_pcm_substream *pcm,\r\n__be32 *buffer, unsigned int frames)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\nstruct snd_pcm_runtime *runtime = pcm->runtime;\r\nunsigned int channels, remaining_frames, i, c;\r\nu32 *dst;\r\nchannels = p->pcm_channels;\r\ndst = (void *)runtime->dma_area +\r\nframes_to_bytes(runtime, s->pcm_buffer_pointer);\r\nremaining_frames = runtime->buffer_size - s->pcm_buffer_pointer;\r\nfor (i = 0; i < frames; ++i) {\r\nfor (c = 0; c < channels; ++c) {\r\n*dst = be32_to_cpu(buffer[p->pcm_positions[c]]) << 8;\r\ndst++;\r\n}\r\nbuffer += s->data_block_quadlets;\r\nif (--remaining_frames == 0)\r\ndst = (void *)runtime->dma_area;\r\n}\r\n}\r\nstatic void write_pcm_silence(struct amdtp_stream *s,\r\n__be32 *buffer, unsigned int frames)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\nunsigned int i, c, channels = p->pcm_channels;\r\nfor (i = 0; i < frames; ++i) {\r\nfor (c = 0; c < channels; ++c)\r\nbuffer[p->pcm_positions[c]] = cpu_to_be32(0x40000000);\r\nbuffer += s->data_block_quadlets;\r\n}\r\n}\r\nvoid amdtp_am824_set_pcm_format(struct amdtp_stream *s, snd_pcm_format_t format)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\nif (WARN_ON(amdtp_stream_pcm_running(s)))\r\nreturn;\r\nswitch (format) {\r\ndefault:\r\nWARN_ON(1);\r\ncase SNDRV_PCM_FORMAT_S16:\r\nif (s->direction == AMDTP_OUT_STREAM) {\r\np->transfer_samples = write_pcm_s16;\r\nbreak;\r\n}\r\nWARN_ON(1);\r\ncase SNDRV_PCM_FORMAT_S32:\r\nif (s->direction == AMDTP_OUT_STREAM)\r\np->transfer_samples = write_pcm_s32;\r\nelse\r\np->transfer_samples = read_pcm_s32;\r\nbreak;\r\n}\r\n}\r\nint amdtp_am824_add_pcm_hw_constraints(struct amdtp_stream *s,\r\nstruct snd_pcm_runtime *runtime)\r\n{\r\nint err;\r\nerr = amdtp_stream_add_pcm_hw_constraints(s, runtime);\r\nif (err < 0)\r\nreturn err;\r\nreturn snd_pcm_hw_constraint_msbits(runtime, 0, 32, 24);\r\n}\r\nvoid amdtp_am824_midi_trigger(struct amdtp_stream *s, unsigned int port,\r\nstruct snd_rawmidi_substream *midi)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\nif (port < p->midi_ports)\r\nACCESS_ONCE(p->midi[port]) = midi;\r\n}\r\nstatic bool midi_ratelimit_per_packet(struct amdtp_stream *s, unsigned int port)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\nint used;\r\nused = p->midi_fifo_used[port];\r\nif (used == 0)\r\nreturn true;\r\nused -= MIDI_BYTES_PER_SECOND * s->syt_interval;\r\nused = max(used, 0);\r\np->midi_fifo_used[port] = used;\r\nreturn used < p->midi_fifo_limit;\r\n}\r\nstatic void midi_rate_use_one_byte(struct amdtp_stream *s, unsigned int port)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\np->midi_fifo_used[port] += amdtp_rate_table[s->sfc];\r\n}\r\nstatic void write_midi_messages(struct amdtp_stream *s, __be32 *buffer,\r\nunsigned int frames)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\nunsigned int f, port;\r\nu8 *b;\r\nfor (f = 0; f < frames; f++) {\r\nb = (u8 *)&buffer[p->midi_position];\r\nport = (s->data_block_counter + f) % 8;\r\nif (f < MAX_MIDI_RX_BLOCKS &&\r\nmidi_ratelimit_per_packet(s, port) &&\r\np->midi[port] != NULL &&\r\nsnd_rawmidi_transmit(p->midi[port], &b[1], 1) == 1) {\r\nmidi_rate_use_one_byte(s, port);\r\nb[0] = 0x81;\r\n} else {\r\nb[0] = 0x80;\r\nb[1] = 0;\r\n}\r\nb[2] = 0;\r\nb[3] = 0;\r\nbuffer += s->data_block_quadlets;\r\n}\r\n}\r\nstatic void read_midi_messages(struct amdtp_stream *s,\r\n__be32 *buffer, unsigned int frames)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\nunsigned int f, port;\r\nint len;\r\nu8 *b;\r\nfor (f = 0; f < frames; f++) {\r\nport = (s->data_block_counter + f) % 8;\r\nb = (u8 *)&buffer[p->midi_position];\r\nlen = b[0] - 0x80;\r\nif ((1 <= len) && (len <= 3) && (p->midi[port]))\r\nsnd_rawmidi_receive(p->midi[port], b + 1, len);\r\nbuffer += s->data_block_quadlets;\r\n}\r\n}\r\nstatic unsigned int process_rx_data_blocks(struct amdtp_stream *s, __be32 *buffer,\r\nunsigned int data_blocks, unsigned int *syt)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\nstruct snd_pcm_substream *pcm = ACCESS_ONCE(s->pcm);\r\nunsigned int pcm_frames;\r\nif (pcm) {\r\np->transfer_samples(s, pcm, buffer, data_blocks);\r\npcm_frames = data_blocks * p->frame_multiplier;\r\n} else {\r\nwrite_pcm_silence(s, buffer, data_blocks);\r\npcm_frames = 0;\r\n}\r\nif (p->midi_ports)\r\nwrite_midi_messages(s, buffer, data_blocks);\r\nreturn pcm_frames;\r\n}\r\nstatic unsigned int process_tx_data_blocks(struct amdtp_stream *s, __be32 *buffer,\r\nunsigned int data_blocks, unsigned int *syt)\r\n{\r\nstruct amdtp_am824 *p = s->protocol;\r\nstruct snd_pcm_substream *pcm = ACCESS_ONCE(s->pcm);\r\nunsigned int pcm_frames;\r\nif (pcm) {\r\np->transfer_samples(s, pcm, buffer, data_blocks);\r\npcm_frames = data_blocks * p->frame_multiplier;\r\n} else {\r\npcm_frames = 0;\r\n}\r\nif (p->midi_ports)\r\nread_midi_messages(s, buffer, data_blocks);\r\nreturn pcm_frames;\r\n}\r\nint amdtp_am824_init(struct amdtp_stream *s, struct fw_unit *unit,\r\nenum amdtp_stream_direction dir, enum cip_flags flags)\r\n{\r\namdtp_stream_process_data_blocks_t process_data_blocks;\r\nif (dir == AMDTP_IN_STREAM)\r\nprocess_data_blocks = process_tx_data_blocks;\r\nelse\r\nprocess_data_blocks = process_rx_data_blocks;\r\nreturn amdtp_stream_init(s, unit, dir, flags, CIP_FMT_AM,\r\nprocess_data_blocks,\r\nsizeof(struct amdtp_am824));\r\n}

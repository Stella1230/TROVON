static inline void bridge_w32(u32 val, unsigned reg)\r\n{\r\niowrite32(val, bridge_base + reg);\r\n}\r\nstatic inline u32 bridge_r32(unsigned reg)\r\n{\r\nreturn ioread32(bridge_base + reg);\r\n}\r\nstatic inline void pcie_w32(u32 val, unsigned reg)\r\n{\r\niowrite32(val, pcie_base + reg);\r\n}\r\nstatic inline u32 pcie_r32(unsigned reg)\r\n{\r\nreturn ioread32(pcie_base + reg);\r\n}\r\nstatic inline void pcie_m32(u32 clr, u32 set, unsigned reg)\r\n{\r\nu32 val = pcie_r32(reg);\r\nval &= ~clr;\r\nval |= set;\r\npcie_w32(val, reg);\r\n}\r\nstatic int wait_pciephy_busy(void)\r\n{\r\nunsigned long reg_value = 0x0, retry = 0;\r\nwhile (1) {\r\nreg_value = pcie_r32(PCIEPHY0_CFG);\r\nif (reg_value & BUSY)\r\nmdelay(100);\r\nelse\r\nbreak;\r\nif (retry++ > WAITRETRY_MAX) {\r\nprintk(KERN_WARN "PCIE-PHY retry failed.\n");\r\nreturn -1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void pcie_phy(unsigned long addr, unsigned long val)\r\n{\r\nwait_pciephy_busy();\r\npcie_w32(WRITE_MODE | (val << DATA_SHIFT) | (addr << ADDR_SHIFT),\r\nPCIEPHY0_CFG);\r\nmdelay(1);\r\nwait_pciephy_busy();\r\n}\r\nstatic int pci_config_read(struct pci_bus *bus, unsigned int devfn, int where,\r\nint size, u32 *val)\r\n{\r\nunsigned int slot = PCI_SLOT(devfn);\r\nu8 func = PCI_FUNC(devfn);\r\nu32 address;\r\nu32 data;\r\nu32 num = 0;\r\nif (bus)\r\nnum = bus->number;\r\naddress = (((where & 0xF00) >> 8) << 24) | (num << 16) | (slot << 11) |\r\n(func << 8) | (where & 0xfc) | 0x80000000;\r\nbridge_w32(address, RALINK_PCI_CONFIG_ADDR);\r\ndata = bridge_r32(RALINK_PCI_CONFIG_DATA_VIRT_REG);\r\nswitch (size) {\r\ncase 1:\r\n*val = (data >> ((where & 3) << 3)) & 0xff;\r\nbreak;\r\ncase 2:\r\n*val = (data >> ((where & 3) << 3)) & 0xffff;\r\nbreak;\r\ncase 4:\r\n*val = data;\r\nbreak;\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int pci_config_write(struct pci_bus *bus, unsigned int devfn, int where,\r\nint size, u32 val)\r\n{\r\nunsigned int slot = PCI_SLOT(devfn);\r\nu8 func = PCI_FUNC(devfn);\r\nu32 address;\r\nu32 data;\r\nu32 num = 0;\r\nif (bus)\r\nnum = bus->number;\r\naddress = (((where & 0xF00) >> 8) << 24) | (num << 16) | (slot << 11) |\r\n(func << 8) | (where & 0xfc) | 0x80000000;\r\nbridge_w32(address, RALINK_PCI_CONFIG_ADDR);\r\ndata = bridge_r32(RALINK_PCI_CONFIG_DATA_VIRT_REG);\r\nswitch (size) {\r\ncase 1:\r\ndata = (data & ~(0xff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\nbreak;\r\ncase 2:\r\ndata = (data & ~(0xffff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\nbreak;\r\ncase 4:\r\ndata = val;\r\nbreak;\r\n}\r\nbridge_w32(data, RALINK_PCI_CONFIG_DATA_VIRT_REG);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int mt7620_pci_hw_init(struct platform_device *pdev)\r\n{\r\npcie_phy(0x0, 0x80);\r\npcie_phy(0x1, 0x04);\r\npcie_phy(0x68, 0xB4);\r\npcie_m32(0, PCIRST, RALINK_PCI_PCICFG_ADDR);\r\nreset_control_assert(rstpcie0);\r\nrt_sysc_m32(RALINK_PCIE0_CLK_EN, 0, RALINK_CLKCFG1);\r\nrt_sysc_m32(LC_CKDRVPD, PDRV_SW_SET, PPLL_DRV);\r\nreset_control_deassert(rstpcie0);\r\nrt_sysc_m32(0, RALINK_PCIE0_CLK_EN, RALINK_CLKCFG1);\r\nmdelay(100);\r\nif (!(rt_sysc_r32(PPLL_CFG1) & PDRV_SW_SET)) {\r\ndev_err(&pdev->dev, "MT7620 PPLL unlock\n");\r\nreset_control_assert(rstpcie0);\r\nrt_sysc_m32(RALINK_PCIE0_CLK_EN, 0, RALINK_CLKCFG1);\r\nreturn -1;\r\n}\r\nrt_sysc_m32(LC_CKDRVHZ | LC_CKDRVOHZ, LC_CKDRVPD | PDRV_SW_SET,\r\nPPLL_DRV);\r\nreturn 0;\r\n}\r\nstatic int mt7628_pci_hw_init(struct platform_device *pdev)\r\n{\r\nu32 val = 0;\r\nrt_sysc_m32(BIT(16), 0, RALINK_GPIOMODE);\r\nreset_control_deassert(rstpcie0);\r\nrt_sysc_m32(0, RALINK_PCIE0_CLK_EN, RALINK_CLKCFG1);\r\nmdelay(100);\r\npcie_m32(~0xff, 0x5, RALINK_PCIEPHY_P0_CTL_OFFSET);\r\npci_config_read(NULL, 0, 0x70c, 4, &val);\r\nval &= ~(0xff) << 8;\r\nval |= 0x50 << 8;\r\npci_config_write(NULL, 0, 0x70c, 4, val);\r\npci_config_read(NULL, 0, 0x70c, 4, &val);\r\ndev_err(&pdev->dev, "Port 0 N_FTS = %x\n", (unsigned int) val);\r\nreturn 0;\r\n}\r\nstatic int mt7620_pci_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *bridge_res = platform_get_resource(pdev,\r\nIORESOURCE_MEM, 0);\r\nstruct resource *pcie_res = platform_get_resource(pdev,\r\nIORESOURCE_MEM, 1);\r\nu32 val = 0;\r\nrstpcie0 = devm_reset_control_get(&pdev->dev, "pcie0");\r\nif (IS_ERR(rstpcie0))\r\nreturn PTR_ERR(rstpcie0);\r\nbridge_base = devm_ioremap_resource(&pdev->dev, bridge_res);\r\nif (IS_ERR(bridge_base))\r\nreturn PTR_ERR(bridge_base);\r\npcie_base = devm_ioremap_resource(&pdev->dev, pcie_res);\r\nif (IS_ERR(pcie_base))\r\nreturn PTR_ERR(pcie_base);\r\niomem_resource.start = 0;\r\niomem_resource.end = ~0;\r\nioport_resource.start = 0;\r\nioport_resource.end = ~0;\r\nswitch (ralink_soc) {\r\ncase MT762X_SOC_MT7620A:\r\nif (mt7620_pci_hw_init(pdev))\r\nreturn -1;\r\nbreak;\r\ncase MT762X_SOC_MT7628AN:\r\nif (mt7628_pci_hw_init(pdev))\r\nreturn -1;\r\nbreak;\r\ndefault:\r\ndev_err(&pdev->dev, "pcie is not supported on this hardware\n");\r\nreturn -1;\r\n}\r\nmdelay(50);\r\npcie_m32(PCIRST, 0, RALINK_PCI_PCICFG_ADDR);\r\nmdelay(100);\r\nif ((pcie_r32(RALINK_PCI0_STATUS) & PCIE_LINK_UP_ST) == 0) {\r\nreset_control_assert(rstpcie0);\r\nrt_sysc_m32(RALINK_PCIE0_CLK_EN, 0, RALINK_CLKCFG1);\r\nif (ralink_soc == MT762X_SOC_MT7620A)\r\nrt_sysc_m32(LC_CKDRVPD, PDRV_SW_SET, PPLL_DRV);\r\ndev_err(&pdev->dev, "PCIE0 no card, disable it(RST&CLK)\n");\r\nreturn -1;\r\n}\r\nbridge_w32(0xffffffff, RALINK_PCI_MEMBASE);\r\nbridge_w32(RALINK_PCI_IO_MAP_BASE, RALINK_PCI_IOBASE);\r\npcie_w32(0x7FFF0001, RALINK_PCI0_BAR0SETUP_ADDR);\r\npcie_w32(RALINK_PCI_MEMORY_BASE, RALINK_PCI0_IMBASEBAR0_ADDR);\r\npcie_w32(0x06040001, RALINK_PCI0_CLASS);\r\npcie_m32(0, PCIINT2, RALINK_PCI_PCIENA);\r\npci_config_read(NULL, 0, 4, 4, &val);\r\npci_config_write(NULL, 0, 4, 4, val | 0x7);\r\npci_load_of_ranges(&mt7620_controller, pdev->dev.of_node);\r\nregister_pci_controller(&mt7620_controller);\r\nreturn 0;\r\n}\r\nint __init pcibios_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nu16 cmd;\r\nu32 val;\r\nint irq = 0;\r\nif ((dev->bus->number == 0) && (slot == 0)) {\r\npcie_w32(0x7FFF0001, RALINK_PCI0_BAR0SETUP_ADDR);\r\npci_config_write(dev->bus, 0, PCI_BASE_ADDRESS_0, 4,\r\nRALINK_PCI_MEMORY_BASE);\r\npci_config_read(dev->bus, 0, PCI_BASE_ADDRESS_0, 4, &val);\r\n} else if ((dev->bus->number == 1) && (slot == 0x0)) {\r\nirq = RALINK_INT_PCIE0;\r\n} else {\r\ndev_err(&dev->dev, "no irq found - bus=0x%x, slot = 0x%x\n",\r\ndev->bus->number, slot);\r\nreturn 0;\r\n}\r\ndev_err(&dev->dev, "card - bus=0x%x, slot = 0x%x irq=%d\n",\r\ndev->bus->number, slot, irq);\r\npci_write_config_byte(dev, PCI_CACHE_LINE_SIZE, 0x14);\r\npci_write_config_byte(dev, PCI_LATENCY_TIMER, 0xff);\r\npci_read_config_word(dev, PCI_COMMAND, &cmd);\r\ncmd = cmd | PCI_COMMAND_MASTER | PCI_COMMAND_IO | PCI_COMMAND_MEMORY;\r\npci_write_config_word(dev, PCI_COMMAND, cmd);\r\npci_write_config_byte(dev, PCI_INTERRUPT_LINE, dev->irq);\r\nreturn irq;\r\n}\r\nint pcibios_plat_dev_init(struct pci_dev *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __init mt7620_pci_init(void)\r\n{\r\nreturn platform_driver_register(&mt7620_pci_driver);\r\n}

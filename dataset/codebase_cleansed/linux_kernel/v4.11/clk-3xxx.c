static void omap3430es2_clk_ssi_find_idlest(struct clk_hw_omap *clk,\r\nvoid __iomem **idlest_reg,\r\nu8 *idlest_bit,\r\nu8 *idlest_val)\r\n{\r\nu32 r;\r\nr = (((__force u32)clk->enable_reg & ~0xf0) | 0x20);\r\n*idlest_reg = (__force void __iomem *)r;\r\n*idlest_bit = OMAP3430ES2_ST_SSI_IDLE_SHIFT;\r\n*idlest_val = OMAP34XX_CM_IDLEST_VAL;\r\n}\r\nstatic void omap3430es2_clk_dss_usbhost_find_idlest(struct clk_hw_omap *clk,\r\nvoid __iomem **idlest_reg,\r\nu8 *idlest_bit,\r\nu8 *idlest_val)\r\n{\r\nu32 r;\r\nr = (((__force u32)clk->enable_reg & ~0xf0) | 0x20);\r\n*idlest_reg = (__force void __iomem *)r;\r\n*idlest_bit = OMAP3430ES2_ST_DSS_IDLE_SHIFT;\r\n*idlest_val = OMAP34XX_CM_IDLEST_VAL;\r\n}\r\nstatic void omap3430es2_clk_hsotgusb_find_idlest(struct clk_hw_omap *clk,\r\nvoid __iomem **idlest_reg,\r\nu8 *idlest_bit,\r\nu8 *idlest_val)\r\n{\r\nu32 r;\r\nr = (((__force u32)clk->enable_reg & ~0xf0) | 0x20);\r\n*idlest_reg = (__force void __iomem *)r;\r\n*idlest_bit = OMAP3430ES2_ST_HSOTGUSB_IDLE_SHIFT;\r\n*idlest_val = OMAP34XX_CM_IDLEST_VAL;\r\n}\r\nstatic void am35xx_clk_find_idlest(struct clk_hw_omap *clk,\r\nvoid __iomem **idlest_reg,\r\nu8 *idlest_bit,\r\nu8 *idlest_val)\r\n{\r\n*idlest_reg = (__force void __iomem *)(clk->enable_reg);\r\n*idlest_bit = clk->enable_bit + AM35XX_IPSS_ICK_EN_ACK_OFFSET;\r\n*idlest_val = AM35XX_IPSS_CLK_IDLEST_VAL;\r\n}\r\nstatic void am35xx_clk_find_companion(struct clk_hw_omap *clk,\r\nvoid __iomem **other_reg,\r\nu8 *other_bit)\r\n{\r\n*other_reg = (__force void __iomem *)(clk->enable_reg);\r\nif (clk->enable_bit & AM35XX_IPSS_ICK_MASK)\r\n*other_bit = clk->enable_bit + AM35XX_IPSS_ICK_FCK_OFFSET;\r\nelse\r\n*other_bit = clk->enable_bit - AM35XX_IPSS_ICK_FCK_OFFSET;\r\n}\r\nstatic void am35xx_clk_ipss_find_idlest(struct clk_hw_omap *clk,\r\nvoid __iomem **idlest_reg,\r\nu8 *idlest_bit,\r\nu8 *idlest_val)\r\n{\r\nu32 r;\r\nr = (((__force u32)clk->enable_reg & ~0xf0) | 0x20);\r\n*idlest_reg = (__force void __iomem *)r;\r\n*idlest_bit = AM35XX_ST_IPSS_SHIFT;\r\n*idlest_val = OMAP34XX_CM_IDLEST_VAL;\r\n}\r\nvoid __init omap3_clk_lock_dpll5(void)\r\n{\r\nstruct clk *dpll5_clk;\r\nstruct clk *dpll5_m2_clk;\r\ndpll5_clk = clk_get(NULL, "dpll5_ck");\r\nclk_set_rate(dpll5_clk, OMAP3_DPLL5_FREQ_FOR_USBHOST * 8);\r\nclk_prepare_enable(dpll5_clk);\r\ndpll5_m2_clk = clk_get(NULL, "dpll5_m2_ck");\r\nclk_prepare_enable(dpll5_m2_clk);\r\nclk_set_rate(dpll5_m2_clk, OMAP3_DPLL5_FREQ_FOR_USBHOST);\r\nclk_disable_unprepare(dpll5_m2_clk);\r\nclk_disable_unprepare(dpll5_clk);\r\n}\r\nstatic int __init omap3xxx_dt_clk_init(int soc_type)\r\n{\r\nif (soc_type == OMAP3_SOC_AM35XX || soc_type == OMAP3_SOC_OMAP3630 ||\r\nsoc_type == OMAP3_SOC_OMAP3430_ES1 ||\r\nsoc_type == OMAP3_SOC_OMAP3430_ES2_PLUS)\r\nti_dt_clocks_register(omap3xxx_clks);\r\nif (soc_type == OMAP3_SOC_AM35XX)\r\nti_dt_clocks_register(am35xx_clks);\r\nif (soc_type == OMAP3_SOC_OMAP3630 || soc_type == OMAP3_SOC_AM35XX ||\r\nsoc_type == OMAP3_SOC_OMAP3430_ES2_PLUS)\r\nti_dt_clocks_register(omap36xx_am35xx_omap3430es2plus_clks);\r\nif (soc_type == OMAP3_SOC_OMAP3430_ES1)\r\nti_dt_clocks_register(omap3430es1_clks);\r\nif (soc_type == OMAP3_SOC_OMAP3430_ES2_PLUS ||\r\nsoc_type == OMAP3_SOC_OMAP3630)\r\nti_dt_clocks_register(omap36xx_omap3430es2plus_clks);\r\nif (soc_type == OMAP3_SOC_OMAP3430_ES1 ||\r\nsoc_type == OMAP3_SOC_OMAP3430_ES2_PLUS ||\r\nsoc_type == OMAP3_SOC_OMAP3630)\r\nti_dt_clocks_register(omap34xx_omap36xx_clks);\r\nif (soc_type == OMAP3_SOC_OMAP3630)\r\nti_dt_clocks_register(omap36xx_clks);\r\nomap2_clk_disable_autoidle_all();\r\nomap2_clk_enable_init_clocks(enable_init_clks,\r\nARRAY_SIZE(enable_init_clks));\r\npr_info("Clocking rate (Crystal/Core/MPU): %ld.%01ld/%ld/%ld MHz\n",\r\n(clk_get_rate(clk_get_sys(NULL, "osc_sys_ck")) / 1000000),\r\n(clk_get_rate(clk_get_sys(NULL, "osc_sys_ck")) / 100000) % 10,\r\n(clk_get_rate(clk_get_sys(NULL, "core_ck")) / 1000000),\r\n(clk_get_rate(clk_get_sys(NULL, "arm_fck")) / 1000000));\r\nif (soc_type != OMAP3_SOC_OMAP3430_ES1)\r\nomap3_clk_lock_dpll5();\r\nreturn 0;\r\n}\r\nint __init omap3430_dt_clk_init(void)\r\n{\r\nreturn omap3xxx_dt_clk_init(OMAP3_SOC_OMAP3430_ES2_PLUS);\r\n}\r\nint __init omap3630_dt_clk_init(void)\r\n{\r\nreturn omap3xxx_dt_clk_init(OMAP3_SOC_OMAP3630);\r\n}\r\nint __init am35xx_dt_clk_init(void)\r\n{\r\nreturn omap3xxx_dt_clk_init(OMAP3_SOC_AM35XX);\r\n}

static int hts221_trig_set_state(struct iio_trigger *trig, bool state)\r\n{\r\nstruct iio_dev *iio_dev = iio_trigger_get_drvdata(trig);\r\nstruct hts221_hw *hw = iio_priv(iio_dev);\r\nreturn hts221_config_drdy(hw, state);\r\n}\r\nstatic irqreturn_t hts221_trigger_handler_thread(int irq, void *private)\r\n{\r\nstruct hts221_hw *hw = (struct hts221_hw *)private;\r\nu8 status;\r\nint err;\r\nerr = hw->tf->read(hw->dev, HTS221_REG_STATUS_ADDR, sizeof(status),\r\n&status);\r\nif (err < 0)\r\nreturn IRQ_HANDLED;\r\nif (!(status & HTS221_RH_DRDY_MASK))\r\nreturn IRQ_NONE;\r\niio_trigger_poll_chained(hw->trig);\r\nreturn IRQ_HANDLED;\r\n}\r\nint hts221_allocate_trigger(struct hts221_hw *hw)\r\n{\r\nstruct iio_dev *iio_dev = iio_priv_to_dev(hw);\r\nunsigned long irq_type;\r\nint err;\r\nirq_type = irqd_get_trigger_type(irq_get_irq_data(hw->irq));\r\nswitch (irq_type) {\r\ncase IRQF_TRIGGER_HIGH:\r\ncase IRQF_TRIGGER_RISING:\r\nbreak;\r\ndefault:\r\ndev_info(hw->dev,\r\n"mode %lx unsupported, using IRQF_TRIGGER_RISING\n",\r\nirq_type);\r\nirq_type = IRQF_TRIGGER_RISING;\r\nbreak;\r\n}\r\nerr = devm_request_threaded_irq(hw->dev, hw->irq, NULL,\r\nhts221_trigger_handler_thread,\r\nirq_type | IRQF_ONESHOT,\r\nhw->name, hw);\r\nif (err) {\r\ndev_err(hw->dev, "failed to request trigger irq %d\n",\r\nhw->irq);\r\nreturn err;\r\n}\r\nhw->trig = devm_iio_trigger_alloc(hw->dev, "%s-trigger",\r\niio_dev->name);\r\nif (!hw->trig)\r\nreturn -ENOMEM;\r\niio_trigger_set_drvdata(hw->trig, iio_dev);\r\nhw->trig->ops = &hts221_trigger_ops;\r\nhw->trig->dev.parent = hw->dev;\r\niio_dev->trig = iio_trigger_get(hw->trig);\r\nreturn devm_iio_trigger_register(hw->dev, hw->trig);\r\n}\r\nstatic int hts221_buffer_preenable(struct iio_dev *iio_dev)\r\n{\r\nreturn hts221_power_on(iio_priv(iio_dev));\r\n}\r\nstatic int hts221_buffer_postdisable(struct iio_dev *iio_dev)\r\n{\r\nreturn hts221_power_off(iio_priv(iio_dev));\r\n}\r\nstatic irqreturn_t hts221_buffer_handler_thread(int irq, void *p)\r\n{\r\nu8 buffer[ALIGN(2 * HTS221_DATA_SIZE, sizeof(s64)) + sizeof(s64)];\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *iio_dev = pf->indio_dev;\r\nstruct hts221_hw *hw = iio_priv(iio_dev);\r\nstruct iio_chan_spec const *ch;\r\nint err;\r\nch = &iio_dev->channels[HTS221_SENSOR_H];\r\nerr = hw->tf->read(hw->dev, ch->address, HTS221_DATA_SIZE,\r\nbuffer);\r\nif (err < 0)\r\ngoto out;\r\nch = &iio_dev->channels[HTS221_SENSOR_T];\r\nerr = hw->tf->read(hw->dev, ch->address, HTS221_DATA_SIZE,\r\nbuffer + HTS221_DATA_SIZE);\r\nif (err < 0)\r\ngoto out;\r\niio_push_to_buffers_with_timestamp(iio_dev, buffer,\r\niio_get_time_ns(iio_dev));\r\nout:\r\niio_trigger_notify_done(hw->trig);\r\nreturn IRQ_HANDLED;\r\n}\r\nint hts221_allocate_buffers(struct hts221_hw *hw)\r\n{\r\nreturn devm_iio_triggered_buffer_setup(hw->dev, iio_priv_to_dev(hw),\r\nNULL, hts221_buffer_handler_thread,\r\n&hts221_buffer_ops);\r\n}

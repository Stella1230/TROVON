static int twl6040_pdmclk_is_prepared(struct clk_hw *hw)\r\n{\r\nstruct twl6040_pdmclk *pdmclk = container_of(hw, struct twl6040_pdmclk,\r\npdmclk_hw);\r\nreturn pdmclk->enabled;\r\n}\r\nstatic int twl6040_pdmclk_prepare(struct clk_hw *hw)\r\n{\r\nstruct twl6040_pdmclk *pdmclk = container_of(hw, struct twl6040_pdmclk,\r\npdmclk_hw);\r\nint ret;\r\nret = twl6040_power(pdmclk->twl6040, 1);\r\nif (!ret)\r\npdmclk->enabled = 1;\r\nreturn ret;\r\n}\r\nstatic void twl6040_pdmclk_unprepare(struct clk_hw *hw)\r\n{\r\nstruct twl6040_pdmclk *pdmclk = container_of(hw, struct twl6040_pdmclk,\r\npdmclk_hw);\r\nint ret;\r\nret = twl6040_power(pdmclk->twl6040, 0);\r\nif (!ret)\r\npdmclk->enabled = 0;\r\n}\r\nstatic unsigned long twl6040_pdmclk_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct twl6040_pdmclk *pdmclk = container_of(hw, struct twl6040_pdmclk,\r\npdmclk_hw);\r\nreturn twl6040_get_sysclk(pdmclk->twl6040);\r\n}\r\nstatic int twl6040_pdmclk_probe(struct platform_device *pdev)\r\n{\r\nstruct twl6040 *twl6040 = dev_get_drvdata(pdev->dev.parent);\r\nstruct twl6040_pdmclk *clkdata;\r\nint ret;\r\nclkdata = devm_kzalloc(&pdev->dev, sizeof(*clkdata), GFP_KERNEL);\r\nif (!clkdata)\r\nreturn -ENOMEM;\r\nclkdata->dev = &pdev->dev;\r\nclkdata->twl6040 = twl6040;\r\nclkdata->pdmclk_hw.init = &twl6040_pdmclk_init;\r\nret = devm_clk_hw_register(&pdev->dev, &clkdata->pdmclk_hw);\r\nif (ret)\r\nreturn ret;\r\nplatform_set_drvdata(pdev, clkdata);\r\nreturn of_clk_add_hw_provider(pdev->dev.parent->of_node,\r\nof_clk_hw_simple_get,\r\n&clkdata->pdmclk_hw);\r\n}

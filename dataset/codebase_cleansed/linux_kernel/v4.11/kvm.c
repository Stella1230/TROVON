static inline void kvm_patch_ins(u32 *inst, u32 new_inst)\r\n{\r\n*inst = new_inst;\r\nflush_icache_range((ulong)inst, (ulong)inst + 4);\r\n}\r\nstatic void kvm_patch_ins_ll(u32 *inst, long addr, u32 rt)\r\n{\r\n#ifdef CONFIG_64BIT\r\nkvm_patch_ins(inst, KVM_INST_LD | rt | (addr & 0x0000fffc));\r\n#else\r\nkvm_patch_ins(inst, KVM_INST_LWZ | rt | (addr & 0x0000fffc));\r\n#endif\r\n}\r\nstatic void kvm_patch_ins_ld(u32 *inst, long addr, u32 rt)\r\n{\r\n#ifdef CONFIG_64BIT\r\nkvm_patch_ins(inst, KVM_INST_LD | rt | (addr & 0x0000fffc));\r\n#else\r\nkvm_patch_ins(inst, KVM_INST_LWZ | rt | ((addr + 4) & 0x0000fffc));\r\n#endif\r\n}\r\nstatic void kvm_patch_ins_lwz(u32 *inst, long addr, u32 rt)\r\n{\r\nkvm_patch_ins(inst, KVM_INST_LWZ | rt | (addr & 0x0000ffff));\r\n}\r\nstatic void kvm_patch_ins_std(u32 *inst, long addr, u32 rt)\r\n{\r\n#ifdef CONFIG_64BIT\r\nkvm_patch_ins(inst, KVM_INST_STD | rt | (addr & 0x0000fffc));\r\n#else\r\nkvm_patch_ins(inst, KVM_INST_STW | rt | ((addr + 4) & 0x0000fffc));\r\n#endif\r\n}\r\nstatic void kvm_patch_ins_stw(u32 *inst, long addr, u32 rt)\r\n{\r\nkvm_patch_ins(inst, KVM_INST_STW | rt | (addr & 0x0000fffc));\r\n}\r\nstatic void kvm_patch_ins_nop(u32 *inst)\r\n{\r\nkvm_patch_ins(inst, KVM_INST_NOP);\r\n}\r\nstatic void kvm_patch_ins_b(u32 *inst, int addr)\r\n{\r\n#if defined(CONFIG_RELOCATABLE) && defined(CONFIG_PPC_BOOK3S)\r\nif ((ulong)inst < (ulong)&__end_interrupts)\r\nreturn;\r\n#endif\r\nkvm_patch_ins(inst, KVM_INST_B | (addr & KVM_INST_B_MASK));\r\n}\r\nstatic u32 *kvm_alloc(int len)\r\n{\r\nu32 *p;\r\nif ((kvm_tmp_index + len) > ARRAY_SIZE(kvm_tmp)) {\r\nprintk(KERN_ERR "KVM: No more space (%d + %d)\n",\r\nkvm_tmp_index, len);\r\nkvm_patching_worked = false;\r\nreturn NULL;\r\n}\r\np = (void*)&kvm_tmp[kvm_tmp_index];\r\nkvm_tmp_index += len;\r\nreturn p;\r\n}\r\nstatic void kvm_patch_ins_mtmsrd(u32 *inst, u32 rt)\r\n{\r\nu32 *p;\r\nint distance_start;\r\nint distance_end;\r\nulong next_inst;\r\np = kvm_alloc(kvm_emulate_mtmsrd_len * 4);\r\nif (!p)\r\nreturn;\r\ndistance_start = (ulong)p - (ulong)inst;\r\nnext_inst = ((ulong)inst + 4);\r\ndistance_end = next_inst - (ulong)&p[kvm_emulate_mtmsrd_branch_offs];\r\nif (distance_start > KVM_INST_B_MAX) {\r\nkvm_patching_worked = false;\r\nreturn;\r\n}\r\nmemcpy(p, kvm_emulate_mtmsrd, kvm_emulate_mtmsrd_len * 4);\r\np[kvm_emulate_mtmsrd_branch_offs] |= distance_end & KVM_INST_B_MASK;\r\nswitch (get_rt(rt)) {\r\ncase 30:\r\nkvm_patch_ins_ll(&p[kvm_emulate_mtmsrd_reg_offs],\r\nmagic_var(scratch2), KVM_RT_30);\r\nbreak;\r\ncase 31:\r\nkvm_patch_ins_ll(&p[kvm_emulate_mtmsrd_reg_offs],\r\nmagic_var(scratch1), KVM_RT_30);\r\nbreak;\r\ndefault:\r\np[kvm_emulate_mtmsrd_reg_offs] |= rt;\r\nbreak;\r\n}\r\np[kvm_emulate_mtmsrd_orig_ins_offs] = *inst;\r\nflush_icache_range((ulong)p, (ulong)p + kvm_emulate_mtmsrd_len * 4);\r\nkvm_patch_ins_b(inst, distance_start);\r\n}\r\nstatic void kvm_patch_ins_mtmsr(u32 *inst, u32 rt)\r\n{\r\nu32 *p;\r\nint distance_start;\r\nint distance_end;\r\nulong next_inst;\r\np = kvm_alloc(kvm_emulate_mtmsr_len * 4);\r\nif (!p)\r\nreturn;\r\ndistance_start = (ulong)p - (ulong)inst;\r\nnext_inst = ((ulong)inst + 4);\r\ndistance_end = next_inst - (ulong)&p[kvm_emulate_mtmsr_branch_offs];\r\nif (distance_start > KVM_INST_B_MAX) {\r\nkvm_patching_worked = false;\r\nreturn;\r\n}\r\nmemcpy(p, kvm_emulate_mtmsr, kvm_emulate_mtmsr_len * 4);\r\np[kvm_emulate_mtmsr_branch_offs] |= distance_end & KVM_INST_B_MASK;\r\nswitch (get_rt(rt)) {\r\ncase 30:\r\nkvm_patch_ins_ll(&p[kvm_emulate_mtmsr_reg1_offs],\r\nmagic_var(scratch2), KVM_RT_30);\r\nkvm_patch_ins_ll(&p[kvm_emulate_mtmsr_reg2_offs],\r\nmagic_var(scratch2), KVM_RT_30);\r\nbreak;\r\ncase 31:\r\nkvm_patch_ins_ll(&p[kvm_emulate_mtmsr_reg1_offs],\r\nmagic_var(scratch1), KVM_RT_30);\r\nkvm_patch_ins_ll(&p[kvm_emulate_mtmsr_reg2_offs],\r\nmagic_var(scratch1), KVM_RT_30);\r\nbreak;\r\ndefault:\r\np[kvm_emulate_mtmsr_reg1_offs] |= rt;\r\np[kvm_emulate_mtmsr_reg2_offs] |= rt;\r\nbreak;\r\n}\r\np[kvm_emulate_mtmsr_orig_ins_offs] = *inst;\r\nflush_icache_range((ulong)p, (ulong)p + kvm_emulate_mtmsr_len * 4);\r\nkvm_patch_ins_b(inst, distance_start);\r\n}\r\nstatic void kvm_patch_ins_wrtee(u32 *inst, u32 rt, int imm_one)\r\n{\r\nu32 *p;\r\nint distance_start;\r\nint distance_end;\r\nulong next_inst;\r\np = kvm_alloc(kvm_emulate_wrtee_len * 4);\r\nif (!p)\r\nreturn;\r\ndistance_start = (ulong)p - (ulong)inst;\r\nnext_inst = ((ulong)inst + 4);\r\ndistance_end = next_inst - (ulong)&p[kvm_emulate_wrtee_branch_offs];\r\nif (distance_start > KVM_INST_B_MAX) {\r\nkvm_patching_worked = false;\r\nreturn;\r\n}\r\nmemcpy(p, kvm_emulate_wrtee, kvm_emulate_wrtee_len * 4);\r\np[kvm_emulate_wrtee_branch_offs] |= distance_end & KVM_INST_B_MASK;\r\nif (imm_one) {\r\np[kvm_emulate_wrtee_reg_offs] =\r\nKVM_INST_LI | __PPC_RT(R30) | MSR_EE;\r\n} else {\r\nswitch (get_rt(rt)) {\r\ncase 30:\r\nkvm_patch_ins_ll(&p[kvm_emulate_wrtee_reg_offs],\r\nmagic_var(scratch2), KVM_RT_30);\r\nbreak;\r\ncase 31:\r\nkvm_patch_ins_ll(&p[kvm_emulate_wrtee_reg_offs],\r\nmagic_var(scratch1), KVM_RT_30);\r\nbreak;\r\ndefault:\r\np[kvm_emulate_wrtee_reg_offs] |= rt;\r\nbreak;\r\n}\r\n}\r\np[kvm_emulate_wrtee_orig_ins_offs] = *inst;\r\nflush_icache_range((ulong)p, (ulong)p + kvm_emulate_wrtee_len * 4);\r\nkvm_patch_ins_b(inst, distance_start);\r\n}\r\nstatic void kvm_patch_ins_wrteei_0(u32 *inst)\r\n{\r\nu32 *p;\r\nint distance_start;\r\nint distance_end;\r\nulong next_inst;\r\np = kvm_alloc(kvm_emulate_wrteei_0_len * 4);\r\nif (!p)\r\nreturn;\r\ndistance_start = (ulong)p - (ulong)inst;\r\nnext_inst = ((ulong)inst + 4);\r\ndistance_end = next_inst - (ulong)&p[kvm_emulate_wrteei_0_branch_offs];\r\nif (distance_start > KVM_INST_B_MAX) {\r\nkvm_patching_worked = false;\r\nreturn;\r\n}\r\nmemcpy(p, kvm_emulate_wrteei_0, kvm_emulate_wrteei_0_len * 4);\r\np[kvm_emulate_wrteei_0_branch_offs] |= distance_end & KVM_INST_B_MASK;\r\nflush_icache_range((ulong)p, (ulong)p + kvm_emulate_wrteei_0_len * 4);\r\nkvm_patch_ins_b(inst, distance_start);\r\n}\r\nstatic void kvm_patch_ins_mtsrin(u32 *inst, u32 rt, u32 rb)\r\n{\r\nu32 *p;\r\nint distance_start;\r\nint distance_end;\r\nulong next_inst;\r\np = kvm_alloc(kvm_emulate_mtsrin_len * 4);\r\nif (!p)\r\nreturn;\r\ndistance_start = (ulong)p - (ulong)inst;\r\nnext_inst = ((ulong)inst + 4);\r\ndistance_end = next_inst - (ulong)&p[kvm_emulate_mtsrin_branch_offs];\r\nif (distance_start > KVM_INST_B_MAX) {\r\nkvm_patching_worked = false;\r\nreturn;\r\n}\r\nmemcpy(p, kvm_emulate_mtsrin, kvm_emulate_mtsrin_len * 4);\r\np[kvm_emulate_mtsrin_branch_offs] |= distance_end & KVM_INST_B_MASK;\r\np[kvm_emulate_mtsrin_reg1_offs] |= (rb << 10);\r\np[kvm_emulate_mtsrin_reg2_offs] |= rt;\r\np[kvm_emulate_mtsrin_orig_ins_offs] = *inst;\r\nflush_icache_range((ulong)p, (ulong)p + kvm_emulate_mtsrin_len * 4);\r\nkvm_patch_ins_b(inst, distance_start);\r\n}\r\nstatic void kvm_map_magic_page(void *data)\r\n{\r\nu32 *features = data;\r\nulong in[8] = {0};\r\nulong out[8];\r\nin[0] = KVM_MAGIC_PAGE;\r\nin[1] = KVM_MAGIC_PAGE | MAGIC_PAGE_FLAG_NOT_MAPPED_NX;\r\nepapr_hypercall(in, out, KVM_HCALL_TOKEN(KVM_HC_PPC_MAP_MAGIC_PAGE));\r\n*features = out[0];\r\n}\r\nstatic void kvm_check_ins(u32 *inst, u32 features)\r\n{\r\nu32 _inst = *inst;\r\nu32 inst_no_rt = _inst & ~KVM_MASK_RT;\r\nu32 inst_rt = _inst & KVM_MASK_RT;\r\nswitch (inst_no_rt) {\r\ncase KVM_INST_MFMSR:\r\nkvm_patch_ins_ld(inst, magic_var(msr), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_SPRG0):\r\nkvm_patch_ins_ld(inst, magic_var(sprg0), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_SPRG1):\r\nkvm_patch_ins_ld(inst, magic_var(sprg1), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_SPRG2):\r\nkvm_patch_ins_ld(inst, magic_var(sprg2), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_SPRG3):\r\nkvm_patch_ins_ld(inst, magic_var(sprg3), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_SRR0):\r\nkvm_patch_ins_ld(inst, magic_var(srr0), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_SRR1):\r\nkvm_patch_ins_ld(inst, magic_var(srr1), inst_rt);\r\nbreak;\r\n#ifdef CONFIG_BOOKE\r\ncase KVM_INST_MFSPR(SPRN_DEAR):\r\n#else\r\ncase KVM_INST_MFSPR(SPRN_DAR):\r\n#endif\r\nkvm_patch_ins_ld(inst, magic_var(dar), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_DSISR):\r\nkvm_patch_ins_lwz(inst, magic_var(dsisr), inst_rt);\r\nbreak;\r\n#ifdef CONFIG_PPC_BOOK3E_MMU\r\ncase KVM_INST_MFSPR(SPRN_MAS0):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_lwz(inst, magic_var(mas0), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_MAS1):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_lwz(inst, magic_var(mas1), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_MAS2):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_ld(inst, magic_var(mas2), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_MAS3):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_lwz(inst, magic_var(mas7_3) + 4, inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_MAS4):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_lwz(inst, magic_var(mas4), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_MAS6):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_lwz(inst, magic_var(mas6), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_MAS7):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_lwz(inst, magic_var(mas7_3), inst_rt);\r\nbreak;\r\n#endif\r\ncase KVM_INST_MFSPR(SPRN_SPRG4):\r\n#ifdef CONFIG_BOOKE\r\ncase KVM_INST_MFSPR(SPRN_SPRG4R):\r\n#endif\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_ld(inst, magic_var(sprg4), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_SPRG5):\r\n#ifdef CONFIG_BOOKE\r\ncase KVM_INST_MFSPR(SPRN_SPRG5R):\r\n#endif\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_ld(inst, magic_var(sprg5), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_SPRG6):\r\n#ifdef CONFIG_BOOKE\r\ncase KVM_INST_MFSPR(SPRN_SPRG6R):\r\n#endif\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_ld(inst, magic_var(sprg6), inst_rt);\r\nbreak;\r\ncase KVM_INST_MFSPR(SPRN_SPRG7):\r\n#ifdef CONFIG_BOOKE\r\ncase KVM_INST_MFSPR(SPRN_SPRG7R):\r\n#endif\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_ld(inst, magic_var(sprg7), inst_rt);\r\nbreak;\r\n#ifdef CONFIG_BOOKE\r\ncase KVM_INST_MFSPR(SPRN_ESR):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_lwz(inst, magic_var(esr), inst_rt);\r\nbreak;\r\n#endif\r\ncase KVM_INST_MFSPR(SPRN_PIR):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_lwz(inst, magic_var(pir), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_SPRG0):\r\nkvm_patch_ins_std(inst, magic_var(sprg0), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_SPRG1):\r\nkvm_patch_ins_std(inst, magic_var(sprg1), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_SPRG2):\r\nkvm_patch_ins_std(inst, magic_var(sprg2), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_SPRG3):\r\nkvm_patch_ins_std(inst, magic_var(sprg3), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_SRR0):\r\nkvm_patch_ins_std(inst, magic_var(srr0), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_SRR1):\r\nkvm_patch_ins_std(inst, magic_var(srr1), inst_rt);\r\nbreak;\r\n#ifdef CONFIG_BOOKE\r\ncase KVM_INST_MTSPR(SPRN_DEAR):\r\n#else\r\ncase KVM_INST_MTSPR(SPRN_DAR):\r\n#endif\r\nkvm_patch_ins_std(inst, magic_var(dar), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_DSISR):\r\nkvm_patch_ins_stw(inst, magic_var(dsisr), inst_rt);\r\nbreak;\r\n#ifdef CONFIG_PPC_BOOK3E_MMU\r\ncase KVM_INST_MTSPR(SPRN_MAS0):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_stw(inst, magic_var(mas0), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_MAS1):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_stw(inst, magic_var(mas1), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_MAS2):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_std(inst, magic_var(mas2), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_MAS3):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_stw(inst, magic_var(mas7_3) + 4, inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_MAS4):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_stw(inst, magic_var(mas4), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_MAS6):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_stw(inst, magic_var(mas6), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_MAS7):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_stw(inst, magic_var(mas7_3), inst_rt);\r\nbreak;\r\n#endif\r\ncase KVM_INST_MTSPR(SPRN_SPRG4):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_std(inst, magic_var(sprg4), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_SPRG5):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_std(inst, magic_var(sprg5), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_SPRG6):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_std(inst, magic_var(sprg6), inst_rt);\r\nbreak;\r\ncase KVM_INST_MTSPR(SPRN_SPRG7):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_std(inst, magic_var(sprg7), inst_rt);\r\nbreak;\r\n#ifdef CONFIG_BOOKE\r\ncase KVM_INST_MTSPR(SPRN_ESR):\r\nif (features & KVM_MAGIC_FEAT_MAS0_TO_SPRG7)\r\nkvm_patch_ins_stw(inst, magic_var(esr), inst_rt);\r\nbreak;\r\n#endif\r\ncase KVM_INST_TLBSYNC:\r\nkvm_patch_ins_nop(inst);\r\nbreak;\r\ncase KVM_INST_MTMSRD_L1:\r\nkvm_patch_ins_mtmsrd(inst, inst_rt);\r\nbreak;\r\ncase KVM_INST_MTMSR:\r\ncase KVM_INST_MTMSRD_L0:\r\nkvm_patch_ins_mtmsr(inst, inst_rt);\r\nbreak;\r\n#ifdef CONFIG_BOOKE\r\ncase KVM_INST_WRTEE:\r\nkvm_patch_ins_wrtee(inst, inst_rt, 0);\r\nbreak;\r\n#endif\r\n}\r\nswitch (inst_no_rt & ~KVM_MASK_RB) {\r\n#ifdef CONFIG_PPC_BOOK3S_32\r\ncase KVM_INST_MTSRIN:\r\nif (features & KVM_MAGIC_FEAT_SR) {\r\nu32 inst_rb = _inst & KVM_MASK_RB;\r\nkvm_patch_ins_mtsrin(inst, inst_rt, inst_rb);\r\n}\r\nbreak;\r\n#endif\r\n}\r\nswitch (_inst) {\r\n#ifdef CONFIG_BOOKE\r\ncase KVM_INST_WRTEEI_0:\r\nkvm_patch_ins_wrteei_0(inst);\r\nbreak;\r\ncase KVM_INST_WRTEEI_1:\r\nkvm_patch_ins_wrtee(inst, 0, 1);\r\nbreak;\r\n#endif\r\n}\r\n}\r\nstatic void kvm_use_magic_page(void)\r\n{\r\nu32 *p;\r\nu32 *start, *end;\r\nu32 tmp;\r\nu32 features;\r\non_each_cpu(kvm_map_magic_page, &features, 1);\r\nif (__get_user(tmp, (u32*)KVM_MAGIC_PAGE)) {\r\nkvm_patching_worked = false;\r\nreturn;\r\n}\r\nstart = (void*)_stext;\r\nend = (void*)_etext;\r\nlocal_irq_disable();\r\nfor (p = start; p < end; p++) {\r\nif (p >= kvm_template_start && p < kvm_template_end) {\r\np = kvm_template_end - 1;\r\ncontinue;\r\n}\r\nkvm_check_ins(p, features);\r\n}\r\nlocal_irq_enable();\r\nprintk(KERN_INFO "KVM: Live patching for a fast VM %s\n",\r\nkvm_patching_worked ? "worked" : "failed");\r\n}\r\nstatic __init void kvm_free_tmp(void)\r\n{\r\nfree_reserved_area(&kvm_tmp[kvm_tmp_index],\r\n&kvm_tmp[ARRAY_SIZE(kvm_tmp)], -1, NULL);\r\n}\r\nstatic int __init kvm_guest_init(void)\r\n{\r\nif (!kvm_para_available())\r\ngoto free_tmp;\r\nif (!epapr_paravirt_enabled)\r\ngoto free_tmp;\r\nif (kvm_para_has_feature(KVM_FEATURE_MAGIC_PAGE))\r\nkvm_use_magic_page();\r\n#ifdef CONFIG_PPC_BOOK3S_64\r\npowersave_nap = 1;\r\n#endif\r\nfree_tmp:\r\nkvm_free_tmp();\r\nreturn 0;\r\n}

static int arc_mdio_complete_wait(struct arc_emac_priv *priv)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < ARC_MDIO_COMPLETE_POLL_COUNT * 40; i++) {\r\nunsigned int status = arc_reg_get(priv, R_STATUS);\r\nstatus &= MDIO_MASK;\r\nif (status) {\r\narc_reg_set(priv, R_STATUS, status);\r\nreturn 0;\r\n}\r\nmsleep(25);\r\n}\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int arc_mdio_read(struct mii_bus *bus, int phy_addr, int reg_num)\r\n{\r\nstruct arc_emac_priv *priv = bus->priv;\r\nunsigned int value;\r\nint error;\r\narc_reg_set(priv, R_MDIO,\r\n0x60020000 | (phy_addr << 23) | (reg_num << 18));\r\nerror = arc_mdio_complete_wait(priv);\r\nif (error < 0)\r\nreturn error;\r\nvalue = arc_reg_get(priv, R_MDIO) & 0xffff;\r\ndev_dbg(priv->dev, "arc_mdio_read(phy_addr=%i, reg_num=%x) = %x\n",\r\nphy_addr, reg_num, value);\r\nreturn value;\r\n}\r\nstatic int arc_mdio_write(struct mii_bus *bus, int phy_addr,\r\nint reg_num, u16 value)\r\n{\r\nstruct arc_emac_priv *priv = bus->priv;\r\ndev_dbg(priv->dev,\r\n"arc_mdio_write(phy_addr=%i, reg_num=%x, value=%x)\n",\r\nphy_addr, reg_num, value);\r\narc_reg_set(priv, R_MDIO,\r\n0x50020000 | (phy_addr << 23) | (reg_num << 18) | value);\r\nreturn arc_mdio_complete_wait(priv);\r\n}\r\nstatic int arc_mdio_reset(struct mii_bus *bus)\r\n{\r\nstruct arc_emac_priv *priv = bus->priv;\r\nstruct arc_emac_mdio_bus_data *data = &priv->bus_data;\r\nif (data->reset_gpio) {\r\ngpiod_set_value_cansleep(data->reset_gpio, 1);\r\nmsleep(data->msec);\r\ngpiod_set_value_cansleep(data->reset_gpio, 0);\r\n}\r\nreturn 0;\r\n}\r\nint arc_mdio_probe(struct arc_emac_priv *priv)\r\n{\r\nstruct arc_emac_mdio_bus_data *data = &priv->bus_data;\r\nstruct device_node *np = priv->dev->of_node;\r\nstruct mii_bus *bus;\r\nint error;\r\nbus = mdiobus_alloc();\r\nif (!bus)\r\nreturn -ENOMEM;\r\npriv->bus = bus;\r\nbus->priv = priv;\r\nbus->parent = priv->dev;\r\nbus->name = "Synopsys MII Bus";\r\nbus->read = &arc_mdio_read;\r\nbus->write = &arc_mdio_write;\r\nbus->reset = &arc_mdio_reset;\r\ndata->reset_gpio = devm_gpiod_get_optional(priv->dev, "phy-reset",\r\nGPIOD_OUT_LOW);\r\nif (IS_ERR(data->reset_gpio)) {\r\nerror = PTR_ERR(data->reset_gpio);\r\ndev_err(priv->dev, "Failed to request gpio: %d\n", error);\r\nreturn error;\r\n}\r\nof_property_read_u32(np, "phy-reset-duration", &data->msec);\r\nif (data->msec > 1000)\r\ndata->msec = 1;\r\nsnprintf(bus->id, MII_BUS_ID_SIZE, "%s", bus->name);\r\nerror = of_mdiobus_register(bus, priv->dev->of_node);\r\nif (error) {\r\ndev_err(priv->dev, "cannot register MDIO bus %s\n", bus->name);\r\nmdiobus_free(bus);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nint arc_mdio_remove(struct arc_emac_priv *priv)\r\n{\r\nmdiobus_unregister(priv->bus);\r\nmdiobus_free(priv->bus);\r\npriv->bus = NULL;\r\nreturn 0;\r\n}

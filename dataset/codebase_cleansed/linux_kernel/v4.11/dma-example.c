static int __init example_init(void)\r\n{\r\nint i;\r\nunsigned int ret;\r\nunsigned int nents;\r\nstruct scatterlist sg[10];\r\nprintk(KERN_INFO "DMA fifo test start\n");\r\nif (kfifo_alloc(&fifo, FIFO_SIZE, GFP_KERNEL)) {\r\nprintk(KERN_WARNING "error kfifo_alloc\n");\r\nreturn -ENOMEM;\r\n}\r\nprintk(KERN_INFO "queue size: %u\n", kfifo_size(&fifo));\r\nkfifo_in(&fifo, "test", 4);\r\nfor (i = 0; i != 9; i++)\r\nkfifo_put(&fifo, i);\r\nkfifo_skip(&fifo);\r\nprintk(KERN_INFO "queue len: %u\n", kfifo_len(&fifo));\r\nsg_init_table(sg, ARRAY_SIZE(sg));\r\nnents = kfifo_dma_in_prepare(&fifo, sg, ARRAY_SIZE(sg), FIFO_SIZE);\r\nprintk(KERN_INFO "DMA sgl entries: %d\n", nents);\r\nif (!nents) {\r\nprintk(KERN_WARNING "error kfifo_dma_in_prepare\n");\r\nreturn -EIO;\r\n}\r\nprintk(KERN_INFO "scatterlist for receive:\n");\r\nfor (i = 0; i < nents; i++) {\r\nprintk(KERN_INFO\r\n"sg[%d] -> "\r\n"page_link 0x%.8lx offset 0x%.8x length 0x%.8x\n",\r\ni, sg[i].page_link, sg[i].offset, sg[i].length);\r\nif (sg_is_last(&sg[i]))\r\nbreak;\r\n}\r\nret = 0;\r\nkfifo_dma_in_finish(&fifo, ret);\r\nnents = kfifo_dma_out_prepare(&fifo, sg, ARRAY_SIZE(sg), 8);\r\nprintk(KERN_INFO "DMA sgl entries: %d\n", nents);\r\nif (!nents) {\r\nprintk(KERN_WARNING "error kfifo_dma_out_prepare\n");\r\nreturn -EIO;\r\n}\r\nprintk(KERN_INFO "scatterlist for transmit:\n");\r\nfor (i = 0; i < nents; i++) {\r\nprintk(KERN_INFO\r\n"sg[%d] -> "\r\n"page_link 0x%.8lx offset 0x%.8x length 0x%.8x\n",\r\ni, sg[i].page_link, sg[i].offset, sg[i].length);\r\nif (sg_is_last(&sg[i]))\r\nbreak;\r\n}\r\nret = 5;\r\nkfifo_dma_out_finish(&fifo, ret);\r\nret = kfifo_len(&fifo);\r\nprintk(KERN_INFO "queue len: %u\n", kfifo_len(&fifo));\r\nif (ret != 7) {\r\nprintk(KERN_WARNING "size mismatch: test failed");\r\nreturn -EIO;\r\n}\r\nprintk(KERN_INFO "test passed\n");\r\nreturn 0;\r\n}\r\nstatic void __exit example_exit(void)\r\n{\r\nkfifo_free(&fifo);\r\n}

static int hsr_netdev_notify(struct notifier_block *nb, unsigned long event,\r\nvoid *ptr)\r\n{\r\nstruct net_device *dev;\r\nstruct hsr_port *port, *master;\r\nstruct hsr_priv *hsr;\r\nint mtu_max;\r\nint res;\r\ndev = netdev_notifier_info_to_dev(ptr);\r\nport = hsr_port_get_rtnl(dev);\r\nif (port == NULL) {\r\nif (!is_hsr_master(dev))\r\nreturn NOTIFY_DONE;\r\nhsr = netdev_priv(dev);\r\nport = hsr_port_get_hsr(hsr, HSR_PT_MASTER);\r\nif (port == NULL) {\r\nreturn NOTIFY_DONE;\r\n}\r\n} else {\r\nhsr = port->hsr;\r\n}\r\nswitch (event) {\r\ncase NETDEV_UP:\r\ncase NETDEV_DOWN:\r\ncase NETDEV_CHANGE:\r\nhsr_check_carrier_and_operstate(hsr);\r\nbreak;\r\ncase NETDEV_CHANGEADDR:\r\nif (port->type == HSR_PT_MASTER) {\r\nbreak;\r\n}\r\nmaster = hsr_port_get_hsr(hsr, HSR_PT_MASTER);\r\nif (port->type == HSR_PT_SLAVE_A) {\r\nether_addr_copy(master->dev->dev_addr, dev->dev_addr);\r\ncall_netdevice_notifiers(NETDEV_CHANGEADDR, master->dev);\r\n}\r\nport = hsr_port_get_hsr(hsr, HSR_PT_SLAVE_B);\r\nres = hsr_create_self_node(&hsr->self_node_db,\r\nmaster->dev->dev_addr,\r\nport ?\r\nport->dev->dev_addr :\r\nmaster->dev->dev_addr);\r\nif (res)\r\nnetdev_warn(master->dev,\r\n"Could not update HSR node address.\n");\r\nbreak;\r\ncase NETDEV_CHANGEMTU:\r\nif (port->type == HSR_PT_MASTER)\r\nbreak;\r\nmtu_max = hsr_get_max_mtu(port->hsr);\r\nmaster = hsr_port_get_hsr(port->hsr, HSR_PT_MASTER);\r\nmaster->dev->mtu = mtu_max;\r\nbreak;\r\ncase NETDEV_UNREGISTER:\r\nhsr_del_port(port);\r\nbreak;\r\ncase NETDEV_PRE_TYPE_CHANGE:\r\nreturn NOTIFY_BAD;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstruct hsr_port *hsr_port_get_hsr(struct hsr_priv *hsr, enum hsr_port_type pt)\r\n{\r\nstruct hsr_port *port;\r\nhsr_for_each_port(hsr, port)\r\nif (port->type == pt)\r\nreturn port;\r\nreturn NULL;\r\n}\r\nstatic int __init hsr_init(void)\r\n{\r\nint res;\r\nBUILD_BUG_ON(sizeof(struct hsr_tag) != HSR_HLEN);\r\nregister_netdevice_notifier(&hsr_nb);\r\nres = hsr_netlink_init();\r\nreturn res;\r\n}\r\nstatic void __exit hsr_exit(void)\r\n{\r\nunregister_netdevice_notifier(&hsr_nb);\r\nhsr_netlink_exit();\r\n}

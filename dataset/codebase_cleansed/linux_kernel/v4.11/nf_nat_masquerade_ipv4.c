unsigned int\r\nnf_nat_masquerade_ipv4(struct sk_buff *skb, unsigned int hooknum,\r\nconst struct nf_nat_range *range,\r\nconst struct net_device *out)\r\n{\r\nstruct nf_conn *ct;\r\nstruct nf_conn_nat *nat;\r\nenum ip_conntrack_info ctinfo;\r\nstruct nf_nat_range newrange;\r\nconst struct rtable *rt;\r\n__be32 newsrc, nh;\r\nNF_CT_ASSERT(hooknum == NF_INET_POST_ROUTING);\r\nct = nf_ct_get(skb, &ctinfo);\r\nnat = nfct_nat(ct);\r\nNF_CT_ASSERT(ct && (ctinfo == IP_CT_NEW || ctinfo == IP_CT_RELATED ||\r\nctinfo == IP_CT_RELATED_REPLY));\r\nif (ct->tuplehash[IP_CT_DIR_ORIGINAL].tuple.src.u3.ip == 0)\r\nreturn NF_ACCEPT;\r\nrt = skb_rtable(skb);\r\nnh = rt_nexthop(rt, ip_hdr(skb)->daddr);\r\nnewsrc = inet_select_addr(out, nh, RT_SCOPE_UNIVERSE);\r\nif (!newsrc) {\r\npr_info("%s ate my IP address\n", out->name);\r\nreturn NF_DROP;\r\n}\r\nnat->masq_index = out->ifindex;\r\nmemset(&newrange.min_addr, 0, sizeof(newrange.min_addr));\r\nmemset(&newrange.max_addr, 0, sizeof(newrange.max_addr));\r\nnewrange.flags = range->flags | NF_NAT_RANGE_MAP_IPS;\r\nnewrange.min_addr.ip = newsrc;\r\nnewrange.max_addr.ip = newsrc;\r\nnewrange.min_proto = range->min_proto;\r\nnewrange.max_proto = range->max_proto;\r\nreturn nf_nat_setup_info(ct, &newrange, NF_NAT_MANIP_SRC);\r\n}\r\nstatic int device_cmp(struct nf_conn *i, void *ifindex)\r\n{\r\nconst struct nf_conn_nat *nat = nfct_nat(i);\r\nif (!nat)\r\nreturn 0;\r\nif (nf_ct_l3num(i) != NFPROTO_IPV4)\r\nreturn 0;\r\nreturn nat->masq_index == (int)(long)ifindex;\r\n}\r\nstatic int masq_device_event(struct notifier_block *this,\r\nunsigned long event,\r\nvoid *ptr)\r\n{\r\nconst struct net_device *dev = netdev_notifier_info_to_dev(ptr);\r\nstruct net *net = dev_net(dev);\r\nif (event == NETDEV_DOWN) {\r\nNF_CT_ASSERT(dev->ifindex != 0);\r\nnf_ct_iterate_cleanup(net, device_cmp,\r\n(void *)(long)dev->ifindex, 0, 0);\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int masq_inet_event(struct notifier_block *this,\r\nunsigned long event,\r\nvoid *ptr)\r\n{\r\nstruct in_device *idev = ((struct in_ifaddr *)ptr)->ifa_dev;\r\nstruct netdev_notifier_info info;\r\nif (idev->dead)\r\nreturn NOTIFY_DONE;\r\nnetdev_notifier_info_init(&info, idev->dev);\r\nreturn masq_device_event(this, event, &info);\r\n}\r\nvoid nf_nat_masquerade_ipv4_register_notifier(void)\r\n{\r\nif (atomic_inc_return(&masquerade_notifier_refcount) > 1)\r\nreturn;\r\nregister_netdevice_notifier(&masq_dev_notifier);\r\nregister_inetaddr_notifier(&masq_inet_notifier);\r\n}\r\nvoid nf_nat_masquerade_ipv4_unregister_notifier(void)\r\n{\r\nif (atomic_dec_return(&masquerade_notifier_refcount) > 0)\r\nreturn;\r\nunregister_netdevice_notifier(&masq_dev_notifier);\r\nunregister_inetaddr_notifier(&masq_inet_notifier);\r\n}

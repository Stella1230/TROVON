static int ppc4xx_trng_data_present(struct hwrng *rng, int wait)\r\n{\r\nstruct crypto4xx_device *dev = (void *)rng->priv;\r\nint busy, i, present = 0;\r\nfor (i = 0; i < 20; i++) {\r\nbusy = (in_le32(dev->trng_base + PPC4XX_TRNG_STAT) &\r\nPPC4XX_TRNG_STAT_B);\r\nif (!busy || !wait) {\r\npresent = 1;\r\nbreak;\r\n}\r\nudelay(10);\r\n}\r\nreturn present;\r\n}\r\nstatic int ppc4xx_trng_data_read(struct hwrng *rng, u32 *data)\r\n{\r\nstruct crypto4xx_device *dev = (void *)rng->priv;\r\n*data = in_le32(dev->trng_base + PPC4XX_TRNG_DATA);\r\nreturn 4;\r\n}\r\nstatic void ppc4xx_trng_enable(struct crypto4xx_device *dev, bool enable)\r\n{\r\nu32 device_ctrl;\r\ndevice_ctrl = readl(dev->ce_base + CRYPTO4XX_DEVICE_CTRL);\r\nif (enable)\r\ndevice_ctrl |= PPC4XX_TRNG_EN;\r\nelse\r\ndevice_ctrl &= ~PPC4XX_TRNG_EN;\r\nwritel(device_ctrl, dev->ce_base + CRYPTO4XX_DEVICE_CTRL);\r\n}\r\nvoid ppc4xx_trng_probe(struct crypto4xx_core_device *core_dev)\r\n{\r\nstruct crypto4xx_device *dev = core_dev->dev;\r\nstruct device_node *trng = NULL;\r\nstruct hwrng *rng = NULL;\r\nint err;\r\ntrng = of_find_matching_node(NULL, ppc4xx_trng_match);\r\nif (!trng || !of_device_is_available(trng))\r\nreturn;\r\ndev->trng_base = of_iomap(trng, 0);\r\nof_node_put(trng);\r\nif (!dev->trng_base)\r\ngoto err_out;\r\nrng = kzalloc(sizeof(*rng), GFP_KERNEL);\r\nif (!rng)\r\ngoto err_out;\r\nrng->name = MODULE_NAME;\r\nrng->data_present = ppc4xx_trng_data_present;\r\nrng->data_read = ppc4xx_trng_data_read;\r\nrng->priv = (unsigned long) dev;\r\ncore_dev->trng = rng;\r\nppc4xx_trng_enable(dev, true);\r\nout_le32(dev->trng_base + PPC4XX_TRNG_CTRL, PPC4XX_TRNG_CTRL_DALM);\r\nerr = devm_hwrng_register(core_dev->device, core_dev->trng);\r\nif (err) {\r\nppc4xx_trng_enable(dev, false);\r\ndev_err(core_dev->device, "failed to register hwrng (%d).\n",\r\nerr);\r\ngoto err_out;\r\n}\r\nreturn;\r\nerr_out:\r\nof_node_put(trng);\r\niounmap(dev->trng_base);\r\nkfree(rng);\r\ndev->trng_base = NULL;\r\ncore_dev->trng = NULL;\r\n}\r\nvoid ppc4xx_trng_remove(struct crypto4xx_core_device *core_dev)\r\n{\r\nif (core_dev && core_dev->trng) {\r\nstruct crypto4xx_device *dev = core_dev->dev;\r\ndevm_hwrng_unregister(core_dev->device, core_dev->trng);\r\nppc4xx_trng_enable(dev, false);\r\niounmap(dev->trng_base);\r\nkfree(core_dev->trng);\r\n}\r\n}

static inline const char *i8k_get_dmi_data(int field)\r\n{\r\nconst char *dmi_data = dmi_get_system_info(field);\r\nreturn dmi_data && *dmi_data ? dmi_data : "?";\r\n}\r\nstatic int i8k_smm_func(void *par)\r\n{\r\nint rc;\r\nstruct smm_regs *regs = par;\r\nint eax = regs->eax;\r\n#ifdef DEBUG\r\nint ebx = regs->ebx;\r\nunsigned long duration;\r\nktime_t calltime, delta, rettime;\r\ncalltime = ktime_get();\r\n#endif\r\nif (smp_processor_id() != 0)\r\nreturn -EBUSY;\r\n#if defined(CONFIG_X86_64)\r\nasm volatile("pushq %%rax\n\t"\r\n"movl 0(%%rax),%%edx\n\t"\r\n"pushq %%rdx\n\t"\r\n"movl 4(%%rax),%%ebx\n\t"\r\n"movl 8(%%rax),%%ecx\n\t"\r\n"movl 12(%%rax),%%edx\n\t"\r\n"movl 16(%%rax),%%esi\n\t"\r\n"movl 20(%%rax),%%edi\n\t"\r\n"popq %%rax\n\t"\r\n"out %%al,$0xb2\n\t"\r\n"out %%al,$0x84\n\t"\r\n"xchgq %%rax,(%%rsp)\n\t"\r\n"movl %%ebx,4(%%rax)\n\t"\r\n"movl %%ecx,8(%%rax)\n\t"\r\n"movl %%edx,12(%%rax)\n\t"\r\n"movl %%esi,16(%%rax)\n\t"\r\n"movl %%edi,20(%%rax)\n\t"\r\n"popq %%rdx\n\t"\r\n"movl %%edx,0(%%rax)\n\t"\r\n"pushfq\n\t"\r\n"popq %%rax\n\t"\r\n"andl $1,%%eax\n"\r\n: "=a"(rc)\r\n: "a"(regs)\r\n: "%ebx", "%ecx", "%edx", "%esi", "%edi", "memory");\r\n#else\r\nasm volatile("pushl %%eax\n\t"\r\n"movl 0(%%eax),%%edx\n\t"\r\n"push %%edx\n\t"\r\n"movl 4(%%eax),%%ebx\n\t"\r\n"movl 8(%%eax),%%ecx\n\t"\r\n"movl 12(%%eax),%%edx\n\t"\r\n"movl 16(%%eax),%%esi\n\t"\r\n"movl 20(%%eax),%%edi\n\t"\r\n"popl %%eax\n\t"\r\n"out %%al,$0xb2\n\t"\r\n"out %%al,$0x84\n\t"\r\n"xchgl %%eax,(%%esp)\n\t"\r\n"movl %%ebx,4(%%eax)\n\t"\r\n"movl %%ecx,8(%%eax)\n\t"\r\n"movl %%edx,12(%%eax)\n\t"\r\n"movl %%esi,16(%%eax)\n\t"\r\n"movl %%edi,20(%%eax)\n\t"\r\n"popl %%edx\n\t"\r\n"movl %%edx,0(%%eax)\n\t"\r\n"lahf\n\t"\r\n"shrl $8,%%eax\n\t"\r\n"andl $1,%%eax\n"\r\n: "=a"(rc)\r\n: "a"(regs)\r\n: "%ebx", "%ecx", "%edx", "%esi", "%edi", "memory");\r\n#endif\r\nif (rc != 0 || (regs->eax & 0xffff) == 0xffff || regs->eax == eax)\r\nrc = -EINVAL;\r\n#ifdef DEBUG\r\nrettime = ktime_get();\r\ndelta = ktime_sub(rettime, calltime);\r\nduration = ktime_to_ns(delta) >> 10;\r\npr_debug("smm(0x%.4x 0x%.4x) = 0x%.4x (took %7lu usecs)\n", eax, ebx,\r\n(rc ? 0xffff : regs->eax & 0xffff), duration);\r\n#endif\r\nreturn rc;\r\n}\r\nstatic int i8k_smm(struct smm_regs *regs)\r\n{\r\nint ret;\r\nget_online_cpus();\r\nret = smp_call_on_cpu(0, i8k_smm_func, regs, true);\r\nput_online_cpus();\r\nreturn ret;\r\n}\r\nstatic int i8k_get_fan_status(int fan)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_GET_FAN, };\r\nregs.ebx = fan & 0xff;\r\nreturn i8k_smm(&regs) ? : regs.eax & 0xff;\r\n}\r\nstatic int i8k_get_fan_speed(int fan)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_GET_SPEED, };\r\nregs.ebx = fan & 0xff;\r\nreturn i8k_smm(&regs) ? : (regs.eax & 0xffff) * i8k_fan_mult;\r\n}\r\nstatic int _i8k_get_fan_type(int fan)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_GET_FAN_TYPE, };\r\nif (disallow_fan_type_call)\r\nreturn -EINVAL;\r\nregs.ebx = fan & 0xff;\r\nreturn i8k_smm(&regs) ? : regs.eax & 0xff;\r\n}\r\nstatic int i8k_get_fan_type(int fan)\r\n{\r\nstatic int types[3] = { INT_MIN, INT_MIN, INT_MIN };\r\nif (types[fan] == INT_MIN)\r\ntypes[fan] = _i8k_get_fan_type(fan);\r\nreturn types[fan];\r\n}\r\nstatic int i8k_get_fan_nominal_speed(int fan, int speed)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_GET_NOM_SPEED, };\r\nregs.ebx = (fan & 0xff) | (speed << 8);\r\nreturn i8k_smm(&regs) ? : (regs.eax & 0xffff) * i8k_fan_mult;\r\n}\r\nstatic int i8k_set_fan(int fan, int speed)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_SET_FAN, };\r\nspeed = (speed < 0) ? 0 : ((speed > i8k_fan_max) ? i8k_fan_max : speed);\r\nregs.ebx = (fan & 0xff) | (speed << 8);\r\nreturn i8k_smm(&regs) ? : i8k_get_fan_status(fan);\r\n}\r\nstatic int i8k_get_temp_type(int sensor)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_GET_TEMP_TYPE, };\r\nregs.ebx = sensor & 0xff;\r\nreturn i8k_smm(&regs) ? : regs.eax & 0xff;\r\n}\r\nstatic int _i8k_get_temp(int sensor)\r\n{\r\nstruct smm_regs regs = {\r\n.eax = I8K_SMM_GET_TEMP,\r\n.ebx = sensor & 0xff,\r\n};\r\nreturn i8k_smm(&regs) ? : regs.eax & 0xff;\r\n}\r\nstatic int i8k_get_temp(int sensor)\r\n{\r\nint temp = _i8k_get_temp(sensor);\r\nif (temp == 0x99) {\r\nmsleep(100);\r\ntemp = _i8k_get_temp(sensor);\r\n}\r\nif (temp > I8K_MAX_TEMP)\r\nreturn -ENODATA;\r\nreturn temp;\r\n}\r\nstatic int i8k_get_dell_signature(int req_fn)\r\n{\r\nstruct smm_regs regs = { .eax = req_fn, };\r\nint rc;\r\nrc = i8k_smm(&regs);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn regs.eax == 1145651527 && regs.edx == 1145392204 ? 0 : -1;\r\n}\r\nstatic int i8k_get_fn_status(void)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_FN_STATUS, };\r\nint rc;\r\nrc = i8k_smm(&regs);\r\nif (rc < 0)\r\nreturn rc;\r\nswitch ((regs.eax >> I8K_FN_SHIFT) & I8K_FN_MASK) {\r\ncase I8K_FN_UP:\r\nreturn I8K_VOL_UP;\r\ncase I8K_FN_DOWN:\r\nreturn I8K_VOL_DOWN;\r\ncase I8K_FN_MUTE:\r\nreturn I8K_VOL_MUTE;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic int i8k_get_power_status(void)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_POWER_STATUS, };\r\nint rc;\r\nrc = i8k_smm(&regs);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn (regs.eax & 0xff) == I8K_POWER_AC ? I8K_AC : I8K_BATTERY;\r\n}\r\nstatic int\r\ni8k_ioctl_unlocked(struct file *fp, unsigned int cmd, unsigned long arg)\r\n{\r\nint val = 0;\r\nint speed;\r\nunsigned char buff[16];\r\nint __user *argp = (int __user *)arg;\r\nif (!argp)\r\nreturn -EINVAL;\r\nswitch (cmd) {\r\ncase I8K_BIOS_VERSION:\r\nif (!isdigit(bios_version[0]) || !isdigit(bios_version[1]) ||\r\n!isdigit(bios_version[2]))\r\nreturn -EINVAL;\r\nval = (bios_version[0] << 16) |\r\n(bios_version[1] << 8) | bios_version[2];\r\nbreak;\r\ncase I8K_MACHINE_ID:\r\nif (restricted && !capable(CAP_SYS_ADMIN))\r\nreturn -EPERM;\r\nmemset(buff, 0, sizeof(buff));\r\nstrlcpy(buff, bios_machineid, sizeof(buff));\r\nbreak;\r\ncase I8K_FN_STATUS:\r\nval = i8k_get_fn_status();\r\nbreak;\r\ncase I8K_POWER_STATUS:\r\nval = i8k_get_power_status();\r\nbreak;\r\ncase I8K_GET_TEMP:\r\nval = i8k_get_temp(0);\r\nbreak;\r\ncase I8K_GET_SPEED:\r\nif (copy_from_user(&val, argp, sizeof(int)))\r\nreturn -EFAULT;\r\nval = i8k_get_fan_speed(val);\r\nbreak;\r\ncase I8K_GET_FAN:\r\nif (copy_from_user(&val, argp, sizeof(int)))\r\nreturn -EFAULT;\r\nval = i8k_get_fan_status(val);\r\nbreak;\r\ncase I8K_SET_FAN:\r\nif (restricted && !capable(CAP_SYS_ADMIN))\r\nreturn -EPERM;\r\nif (copy_from_user(&val, argp, sizeof(int)))\r\nreturn -EFAULT;\r\nif (copy_from_user(&speed, argp + 1, sizeof(int)))\r\nreturn -EFAULT;\r\nval = i8k_set_fan(val, speed);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (val < 0)\r\nreturn val;\r\nswitch (cmd) {\r\ncase I8K_BIOS_VERSION:\r\nif (copy_to_user(argp, &val, 4))\r\nreturn -EFAULT;\r\nbreak;\r\ncase I8K_MACHINE_ID:\r\nif (copy_to_user(argp, buff, 16))\r\nreturn -EFAULT;\r\nbreak;\r\ndefault:\r\nif (copy_to_user(argp, &val, sizeof(int)))\r\nreturn -EFAULT;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic long i8k_ioctl(struct file *fp, unsigned int cmd, unsigned long arg)\r\n{\r\nlong ret;\r\nmutex_lock(&i8k_mutex);\r\nret = i8k_ioctl_unlocked(fp, cmd, arg);\r\nmutex_unlock(&i8k_mutex);\r\nreturn ret;\r\n}\r\nstatic int i8k_proc_show(struct seq_file *seq, void *offset)\r\n{\r\nint fn_key, cpu_temp, ac_power;\r\nint left_fan, right_fan, left_speed, right_speed;\r\ncpu_temp = i8k_get_temp(0);\r\nleft_fan = i8k_get_fan_status(I8K_FAN_LEFT);\r\nright_fan = i8k_get_fan_status(I8K_FAN_RIGHT);\r\nleft_speed = i8k_get_fan_speed(I8K_FAN_LEFT);\r\nright_speed = i8k_get_fan_speed(I8K_FAN_RIGHT);\r\nfn_key = i8k_get_fn_status();\r\nif (power_status)\r\nac_power = i8k_get_power_status();\r\nelse\r\nac_power = -1;\r\nseq_printf(seq, "%s %s %s %d %d %d %d %d %d %d\n",\r\nI8K_PROC_FMT,\r\nbios_version,\r\n(restricted && !capable(CAP_SYS_ADMIN)) ? "-1" : bios_machineid,\r\ncpu_temp,\r\nleft_fan, right_fan, left_speed, right_speed,\r\nac_power, fn_key);\r\nreturn 0;\r\n}\r\nstatic int i8k_open_fs(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, i8k_proc_show, NULL);\r\n}\r\nstatic void __init i8k_init_procfs(void)\r\n{\r\nproc_create("i8k", 0, NULL, &i8k_fops);\r\n}\r\nstatic void __exit i8k_exit_procfs(void)\r\n{\r\nremove_proc_entry("i8k", NULL);\r\n}\r\nstatic inline void __init i8k_init_procfs(void)\r\n{\r\n}\r\nstatic inline void __exit i8k_exit_procfs(void)\r\n{\r\n}\r\nstatic ssize_t i8k_hwmon_show_temp_label(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstatic const char * const labels[] = {\r\n"CPU",\r\n"GPU",\r\n"SODIMM",\r\n"Other",\r\n"Ambient",\r\n"Other",\r\n};\r\nint index = to_sensor_dev_attr(devattr)->index;\r\nint type;\r\ntype = i8k_get_temp_type(index);\r\nif (type < 0)\r\nreturn type;\r\nif (type >= ARRAY_SIZE(labels))\r\ntype = ARRAY_SIZE(labels) - 1;\r\nreturn sprintf(buf, "%s\n", labels[type]);\r\n}\r\nstatic ssize_t i8k_hwmon_show_temp(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nint index = to_sensor_dev_attr(devattr)->index;\r\nint temp;\r\ntemp = i8k_get_temp(index);\r\nif (temp < 0)\r\nreturn temp;\r\nreturn sprintf(buf, "%d\n", temp * 1000);\r\n}\r\nstatic ssize_t i8k_hwmon_show_fan_label(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstatic const char * const labels[] = {\r\n"Processor Fan",\r\n"Motherboard Fan",\r\n"Video Fan",\r\n"Power Supply Fan",\r\n"Chipset Fan",\r\n"Other Fan",\r\n};\r\nint index = to_sensor_dev_attr(devattr)->index;\r\nbool dock = false;\r\nint type;\r\ntype = i8k_get_fan_type(index);\r\nif (type < 0)\r\nreturn type;\r\nif (type & 0x10) {\r\ndock = true;\r\ntype &= 0x0F;\r\n}\r\nif (type >= ARRAY_SIZE(labels))\r\ntype = (ARRAY_SIZE(labels) - 1);\r\nreturn sprintf(buf, "%s%s\n", (dock ? "Docking " : ""), labels[type]);\r\n}\r\nstatic ssize_t i8k_hwmon_show_fan(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nint index = to_sensor_dev_attr(devattr)->index;\r\nint fan_speed;\r\nfan_speed = i8k_get_fan_speed(index);\r\nif (fan_speed < 0)\r\nreturn fan_speed;\r\nreturn sprintf(buf, "%d\n", fan_speed);\r\n}\r\nstatic ssize_t i8k_hwmon_show_pwm(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nint index = to_sensor_dev_attr(devattr)->index;\r\nint status;\r\nstatus = i8k_get_fan_status(index);\r\nif (status < 0)\r\nreturn -EIO;\r\nreturn sprintf(buf, "%d\n", clamp_val(status * i8k_pwm_mult, 0, 255));\r\n}\r\nstatic ssize_t i8k_hwmon_set_pwm(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nint index = to_sensor_dev_attr(attr)->index;\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nval = clamp_val(DIV_ROUND_CLOSEST(val, i8k_pwm_mult), 0, i8k_fan_max);\r\nmutex_lock(&i8k_mutex);\r\nerr = i8k_set_fan(index, val);\r\nmutex_unlock(&i8k_mutex);\r\nreturn err < 0 ? -EIO : count;\r\n}\r\nstatic umode_t i8k_is_visible(struct kobject *kobj, struct attribute *attr,\r\nint index)\r\n{\r\nif (disallow_fan_type_call &&\r\n(index == 9 || index == 12 || index == 15))\r\nreturn 0;\r\nif (index >= 0 && index <= 1 &&\r\n!(i8k_hwmon_flags & I8K_HWMON_HAVE_TEMP1))\r\nreturn 0;\r\nif (index >= 2 && index <= 3 &&\r\n!(i8k_hwmon_flags & I8K_HWMON_HAVE_TEMP2))\r\nreturn 0;\r\nif (index >= 4 && index <= 5 &&\r\n!(i8k_hwmon_flags & I8K_HWMON_HAVE_TEMP3))\r\nreturn 0;\r\nif (index >= 6 && index <= 7 &&\r\n!(i8k_hwmon_flags & I8K_HWMON_HAVE_TEMP4))\r\nreturn 0;\r\nif (index >= 8 && index <= 10 &&\r\n!(i8k_hwmon_flags & I8K_HWMON_HAVE_FAN1))\r\nreturn 0;\r\nif (index >= 11 && index <= 13 &&\r\n!(i8k_hwmon_flags & I8K_HWMON_HAVE_FAN2))\r\nreturn 0;\r\nif (index >= 14 && index <= 16 &&\r\n!(i8k_hwmon_flags & I8K_HWMON_HAVE_FAN3))\r\nreturn 0;\r\nreturn attr->mode;\r\n}\r\nstatic int __init i8k_init_hwmon(void)\r\n{\r\nint err;\r\ni8k_hwmon_flags = 0;\r\nerr = i8k_get_temp_type(0);\r\nif (err >= 0)\r\ni8k_hwmon_flags |= I8K_HWMON_HAVE_TEMP1;\r\nerr = i8k_get_temp_type(1);\r\nif (err >= 0)\r\ni8k_hwmon_flags |= I8K_HWMON_HAVE_TEMP2;\r\nerr = i8k_get_temp_type(2);\r\nif (err >= 0)\r\ni8k_hwmon_flags |= I8K_HWMON_HAVE_TEMP3;\r\nerr = i8k_get_temp_type(3);\r\nif (err >= 0)\r\ni8k_hwmon_flags |= I8K_HWMON_HAVE_TEMP4;\r\nerr = i8k_get_fan_status(0);\r\nif (err < 0)\r\nerr = i8k_get_fan_type(0);\r\nif (err >= 0)\r\ni8k_hwmon_flags |= I8K_HWMON_HAVE_FAN1;\r\nerr = i8k_get_fan_status(1);\r\nif (err < 0)\r\nerr = i8k_get_fan_type(1);\r\nif (err >= 0)\r\ni8k_hwmon_flags |= I8K_HWMON_HAVE_FAN2;\r\nerr = i8k_get_fan_status(2);\r\nif (err < 0)\r\nerr = i8k_get_fan_type(2);\r\nif (err >= 0)\r\ni8k_hwmon_flags |= I8K_HWMON_HAVE_FAN3;\r\ni8k_hwmon_dev = hwmon_device_register_with_groups(NULL, "dell_smm",\r\nNULL, i8k_groups);\r\nif (IS_ERR(i8k_hwmon_dev)) {\r\nerr = PTR_ERR(i8k_hwmon_dev);\r\ni8k_hwmon_dev = NULL;\r\npr_err("hwmon registration failed (%d)\n", err);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init i8k_probe(void)\r\n{\r\nconst struct dmi_system_id *id;\r\nint fan, ret;\r\nif (!dmi_check_system(i8k_dmi_table)) {\r\nif (!ignore_dmi && !force)\r\nreturn -ENODEV;\r\npr_info("not running on a supported Dell system.\n");\r\npr_info("vendor=%s, model=%s, version=%s\n",\r\ni8k_get_dmi_data(DMI_SYS_VENDOR),\r\ni8k_get_dmi_data(DMI_PRODUCT_NAME),\r\ni8k_get_dmi_data(DMI_BIOS_VERSION));\r\n}\r\nif (dmi_check_system(i8k_blacklist_fan_type_dmi_table))\r\ndisallow_fan_type_call = true;\r\nstrlcpy(bios_version, i8k_get_dmi_data(DMI_BIOS_VERSION),\r\nsizeof(bios_version));\r\nstrlcpy(bios_machineid, i8k_get_dmi_data(DMI_PRODUCT_SERIAL),\r\nsizeof(bios_machineid));\r\nif (i8k_get_dell_signature(I8K_SMM_GET_DELL_SIG1) &&\r\ni8k_get_dell_signature(I8K_SMM_GET_DELL_SIG2)) {\r\npr_err("unable to get SMM Dell signature\n");\r\nif (!force)\r\nreturn -ENODEV;\r\n}\r\nid = dmi_first_match(i8k_dmi_table);\r\nif (id && id->driver_data) {\r\nconst struct i8k_config_data *conf = id->driver_data;\r\nif (!fan_mult && conf->fan_mult)\r\nfan_mult = conf->fan_mult;\r\nif (!fan_max && conf->fan_max)\r\nfan_max = conf->fan_max;\r\n}\r\ni8k_fan_max = fan_max ? : I8K_FAN_HIGH;\r\ni8k_pwm_mult = DIV_ROUND_UP(255, i8k_fan_max);\r\nif (!fan_mult) {\r\nfor (fan = 0; fan < 2; ++fan) {\r\nret = i8k_get_fan_nominal_speed(fan, i8k_fan_max);\r\nif (ret < 0)\r\ncontinue;\r\nif (ret > I8K_FAN_MAX_RPM)\r\ni8k_fan_mult = 1;\r\nbreak;\r\n}\r\n} else {\r\ni8k_fan_mult = fan_mult;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init i8k_init(void)\r\n{\r\nint err;\r\nif (i8k_probe())\r\nreturn -ENODEV;\r\nerr = i8k_init_hwmon();\r\nif (err)\r\nreturn err;\r\ni8k_init_procfs();\r\nreturn 0;\r\n}\r\nstatic void __exit i8k_exit(void)\r\n{\r\nhwmon_device_unregister(i8k_hwmon_dev);\r\ni8k_exit_procfs();\r\n}

static int b53_srab_request_grant(struct b53_device *dev)\r\n{\r\nstruct b53_srab_priv *priv = dev->priv;\r\nu8 __iomem *regs = priv->regs;\r\nu32 ctrls;\r\nint i;\r\nctrls = readl(regs + B53_SRAB_CTRLS);\r\nctrls |= B53_SRAB_CTRLS_RCAREQ;\r\nwritel(ctrls, regs + B53_SRAB_CTRLS);\r\nfor (i = 0; i < 20; i++) {\r\nctrls = readl(regs + B53_SRAB_CTRLS);\r\nif (ctrls & B53_SRAB_CTRLS_RCAGNT)\r\nbreak;\r\nusleep_range(10, 100);\r\n}\r\nif (WARN_ON(i == 5))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic void b53_srab_release_grant(struct b53_device *dev)\r\n{\r\nstruct b53_srab_priv *priv = dev->priv;\r\nu8 __iomem *regs = priv->regs;\r\nu32 ctrls;\r\nctrls = readl(regs + B53_SRAB_CTRLS);\r\nctrls &= ~B53_SRAB_CTRLS_RCAREQ;\r\nwritel(ctrls, regs + B53_SRAB_CTRLS);\r\n}\r\nstatic int b53_srab_op(struct b53_device *dev, u8 page, u8 reg, u32 op)\r\n{\r\nstruct b53_srab_priv *priv = dev->priv;\r\nu8 __iomem *regs = priv->regs;\r\nint i;\r\nu32 cmdstat;\r\ncmdstat = (page << B53_SRAB_CMDSTAT_PAGE) |\r\n(reg << B53_SRAB_CMDSTAT_REG) |\r\nB53_SRAB_CMDSTAT_GORDYN |\r\nop;\r\nwritel(cmdstat, regs + B53_SRAB_CMDSTAT);\r\nfor (i = 0; i < 5; ++i) {\r\ncmdstat = readl(regs + B53_SRAB_CMDSTAT);\r\nif (!(cmdstat & B53_SRAB_CMDSTAT_GORDYN))\r\nbreak;\r\nusleep_range(10, 100);\r\n}\r\nif (WARN_ON(i == 5))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int b53_srab_read8(struct b53_device *dev, u8 page, u8 reg, u8 *val)\r\n{\r\nstruct b53_srab_priv *priv = dev->priv;\r\nu8 __iomem *regs = priv->regs;\r\nint ret = 0;\r\nret = b53_srab_request_grant(dev);\r\nif (ret)\r\ngoto err;\r\nret = b53_srab_op(dev, page, reg, 0);\r\nif (ret)\r\ngoto err;\r\n*val = readl(regs + B53_SRAB_RD_L) & 0xff;\r\nerr:\r\nb53_srab_release_grant(dev);\r\nreturn ret;\r\n}\r\nstatic int b53_srab_read16(struct b53_device *dev, u8 page, u8 reg, u16 *val)\r\n{\r\nstruct b53_srab_priv *priv = dev->priv;\r\nu8 __iomem *regs = priv->regs;\r\nint ret = 0;\r\nret = b53_srab_request_grant(dev);\r\nif (ret)\r\ngoto err;\r\nret = b53_srab_op(dev, page, reg, 0);\r\nif (ret)\r\ngoto err;\r\n*val = readl(regs + B53_SRAB_RD_L) & 0xffff;\r\nerr:\r\nb53_srab_release_grant(dev);\r\nreturn ret;\r\n}\r\nstatic int b53_srab_read32(struct b53_device *dev, u8 page, u8 reg, u32 *val)\r\n{\r\nstruct b53_srab_priv *priv = dev->priv;\r\nu8 __iomem *regs = priv->regs;\r\nint ret = 0;\r\nret = b53_srab_request_grant(dev);\r\nif (ret)\r\ngoto err;\r\nret = b53_srab_op(dev, page, reg, 0);\r\nif (ret)\r\ngoto err;\r\n*val = readl(regs + B53_SRAB_RD_L);\r\nerr:\r\nb53_srab_release_grant(dev);\r\nreturn ret;\r\n}\r\nstatic int b53_srab_read48(struct b53_device *dev, u8 page, u8 reg, u64 *val)\r\n{\r\nstruct b53_srab_priv *priv = dev->priv;\r\nu8 __iomem *regs = priv->regs;\r\nint ret = 0;\r\nret = b53_srab_request_grant(dev);\r\nif (ret)\r\ngoto err;\r\nret = b53_srab_op(dev, page, reg, 0);\r\nif (ret)\r\ngoto err;\r\n*val = readl(regs + B53_SRAB_RD_L);\r\n*val += ((u64)readl(regs + B53_SRAB_RD_H) & 0xffff) << 32;\r\nerr:\r\nb53_srab_release_grant(dev);\r\nreturn ret;\r\n}\r\nstatic int b53_srab_read64(struct b53_device *dev, u8 page, u8 reg, u64 *val)\r\n{\r\nstruct b53_srab_priv *priv = dev->priv;\r\nu8 __iomem *regs = priv->regs;\r\nint ret = 0;\r\nret = b53_srab_request_grant(dev);\r\nif (ret)\r\ngoto err;\r\nret = b53_srab_op(dev, page, reg, 0);\r\nif (ret)\r\ngoto err;\r\n*val = readl(regs + B53_SRAB_RD_L);\r\n*val += (u64)readl(regs + B53_SRAB_RD_H) << 32;\r\nerr:\r\nb53_srab_release_grant(dev);\r\nreturn ret;\r\n}\r\nstatic int b53_srab_write8(struct b53_device *dev, u8 page, u8 reg, u8 value)\r\n{\r\nstruct b53_srab_priv *priv = dev->priv;\r\nu8 __iomem *regs = priv->regs;\r\nint ret = 0;\r\nret = b53_srab_request_grant(dev);\r\nif (ret)\r\ngoto err;\r\nwritel(value, regs + B53_SRAB_WD_L);\r\nret = b53_srab_op(dev, page, reg, B53_SRAB_CMDSTAT_WRITE);\r\nerr:\r\nb53_srab_release_grant(dev);\r\nreturn ret;\r\n}\r\nstatic int b53_srab_write16(struct b53_device *dev, u8 page, u8 reg,\r\nu16 value)\r\n{\r\nstruct b53_srab_priv *priv = dev->priv;\r\nu8 __iomem *regs = priv->regs;\r\nint ret = 0;\r\nret = b53_srab_request_grant(dev);\r\nif (ret)\r\ngoto err;\r\nwritel(value, regs + B53_SRAB_WD_L);\r\nret = b53_srab_op(dev, page, reg, B53_SRAB_CMDSTAT_WRITE);\r\nerr:\r\nb53_srab_release_grant(dev);\r\nreturn ret;\r\n}\r\nstatic int b53_srab_write32(struct b53_device *dev, u8 page, u8 reg,\r\nu32 value)\r\n{\r\nstruct b53_srab_priv *priv = dev->priv;\r\nu8 __iomem *regs = priv->regs;\r\nint ret = 0;\r\nret = b53_srab_request_grant(dev);\r\nif (ret)\r\ngoto err;\r\nwritel(value, regs + B53_SRAB_WD_L);\r\nret = b53_srab_op(dev, page, reg, B53_SRAB_CMDSTAT_WRITE);\r\nerr:\r\nb53_srab_release_grant(dev);\r\nreturn ret;\r\n}\r\nstatic int b53_srab_write48(struct b53_device *dev, u8 page, u8 reg,\r\nu64 value)\r\n{\r\nstruct b53_srab_priv *priv = dev->priv;\r\nu8 __iomem *regs = priv->regs;\r\nint ret = 0;\r\nret = b53_srab_request_grant(dev);\r\nif (ret)\r\ngoto err;\r\nwritel((u32)value, regs + B53_SRAB_WD_L);\r\nwritel((u16)(value >> 32), regs + B53_SRAB_WD_H);\r\nret = b53_srab_op(dev, page, reg, B53_SRAB_CMDSTAT_WRITE);\r\nerr:\r\nb53_srab_release_grant(dev);\r\nreturn ret;\r\n}\r\nstatic int b53_srab_write64(struct b53_device *dev, u8 page, u8 reg,\r\nu64 value)\r\n{\r\nstruct b53_srab_priv *priv = dev->priv;\r\nu8 __iomem *regs = priv->regs;\r\nint ret = 0;\r\nret = b53_srab_request_grant(dev);\r\nif (ret)\r\ngoto err;\r\nwritel((u32)value, regs + B53_SRAB_WD_L);\r\nwritel((u32)(value >> 32), regs + B53_SRAB_WD_H);\r\nret = b53_srab_op(dev, page, reg, B53_SRAB_CMDSTAT_WRITE);\r\nerr:\r\nb53_srab_release_grant(dev);\r\nreturn ret;\r\n}\r\nstatic int b53_srab_probe(struct platform_device *pdev)\r\n{\r\nstruct b53_platform_data *pdata = pdev->dev.platform_data;\r\nstruct device_node *dn = pdev->dev.of_node;\r\nconst struct of_device_id *of_id = NULL;\r\nstruct b53_srab_priv *priv;\r\nstruct b53_device *dev;\r\nstruct resource *r;\r\nif (dn)\r\nof_id = of_match_node(b53_srab_of_match, dn);\r\nif (of_id) {\r\npdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\npdata->chip_id = (u32)(unsigned long)of_id->data;\r\n}\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->regs = devm_ioremap_resource(&pdev->dev, r);\r\nif (IS_ERR(priv->regs))\r\nreturn -ENOMEM;\r\ndev = b53_switch_alloc(&pdev->dev, &b53_srab_ops, priv);\r\nif (!dev)\r\nreturn -ENOMEM;\r\nif (pdata)\r\ndev->pdata = pdata;\r\nplatform_set_drvdata(pdev, dev);\r\nreturn b53_switch_register(dev);\r\n}\r\nstatic int b53_srab_remove(struct platform_device *pdev)\r\n{\r\nstruct b53_device *dev = platform_get_drvdata(pdev);\r\nif (dev)\r\nb53_switch_remove(dev);\r\nreturn 0;\r\n}

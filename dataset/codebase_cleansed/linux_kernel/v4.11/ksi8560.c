static void __noreturn machine_restart(char *cmd)\r\n{\r\nif (cpld_base)\r\nout_8(cpld_base + KSI8560_CPLD_RCR1, KSI8560_CPLD_RCR1_CPUHR);\r\nelse\r\nprintk(KERN_ERR "Can't find CPLD base, hang forever\n");\r\nfor (;;);\r\n}\r\nstatic void __init ksi8560_pic_init(void)\r\n{\r\nstruct mpic *mpic = mpic_alloc(NULL, 0, MPIC_BIG_ENDIAN,\r\n0, 256, " OpenPIC ");\r\nBUG_ON(mpic == NULL);\r\nmpic_init(mpic);\r\nmpc85xx_cpm2_pic_init();\r\n}\r\nstatic void __init init_ioports(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ksi8560_pins); i++) {\r\nstruct cpm_pin *pin = &ksi8560_pins[i];\r\ncpm2_set_pin(pin->port, pin->pin, pin->flags);\r\n}\r\ncpm2_clk_setup(CPM_CLK_SCC1, CPM_BRG1, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_SCC1, CPM_BRG1, CPM_CLK_TX);\r\ncpm2_clk_setup(CPM_CLK_SCC2, CPM_BRG2, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_SCC2, CPM_BRG2, CPM_CLK_TX);\r\ncpm2_clk_setup(CPM_CLK_FCC1, CPM_CLK9, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_FCC1, CPM_CLK10, CPM_CLK_TX);\r\n}\r\nstatic void __init ksi8560_setup_arch(void)\r\n{\r\nstruct device_node *cpld;\r\ncpld = of_find_compatible_node(NULL, NULL, "emerson,KSI8560-cpld");\r\nif (cpld)\r\ncpld_base = of_iomap(cpld, 0);\r\nelse\r\nprintk(KERN_ERR "Can't find CPLD in device tree\n");\r\nif (ppc_md.progress)\r\nppc_md.progress("ksi8560_setup_arch()", 0);\r\n#ifdef CONFIG_CPM2\r\ncpm2_reset();\r\ninit_ioports();\r\n#endif\r\n}\r\nstatic void ksi8560_show_cpuinfo(struct seq_file *m)\r\n{\r\nuint pvid, svid, phid1;\r\npvid = mfspr(SPRN_PVR);\r\nsvid = mfspr(SPRN_SVR);\r\nseq_printf(m, "Vendor\t\t: Emerson Network Power\n");\r\nseq_printf(m, "Board\t\t: KSI8560\n");\r\nif (cpld_base) {\r\nseq_printf(m, "Hardware rev\t: %d\n",\r\nin_8(cpld_base + KSI8560_CPLD_HVR));\r\nseq_printf(m, "CPLD rev\t: %d\n",\r\nin_8(cpld_base + KSI8560_CPLD_PVR));\r\n} else\r\nseq_printf(m, "Unknown Hardware and CPLD revs\n");\r\nseq_printf(m, "PVR\t\t: 0x%x\n", pvid);\r\nseq_printf(m, "SVR\t\t: 0x%x\n", svid);\r\nphid1 = mfspr(SPRN_HID1);\r\nseq_printf(m, "PLL setting\t: 0x%x\n", ((phid1 >> 24) & 0x3f));\r\n}\r\nstatic int __init ksi8560_probe(void)\r\n{\r\nreturn of_machine_is_compatible("emerson,KSI8560");\r\n}

static inline bool has_rndis(void)\r\n{\r\n#ifdef USB_ETH_RNDIS\r\nreturn true;\r\n#else\r\nreturn false;\r\n#endif\r\n}\r\nstatic int rndis_do_config(struct usb_configuration *c)\r\n{\r\nint status;\r\nif (gadget_is_otg(c->cdev->gadget)) {\r\nc->descriptors = otg_desc;\r\nc->bmAttributes |= USB_CONFIG_ATT_WAKEUP;\r\n}\r\nf_rndis = usb_get_function(fi_rndis);\r\nif (IS_ERR(f_rndis))\r\nreturn PTR_ERR(f_rndis);\r\nstatus = usb_add_function(c, f_rndis);\r\nif (status < 0)\r\nusb_put_function(f_rndis);\r\nreturn status;\r\n}\r\nstatic int eth_do_config(struct usb_configuration *c)\r\n{\r\nint status = 0;\r\nif (gadget_is_otg(c->cdev->gadget)) {\r\nc->descriptors = otg_desc;\r\nc->bmAttributes |= USB_CONFIG_ATT_WAKEUP;\r\n}\r\nif (use_eem) {\r\nf_eem = usb_get_function(fi_eem);\r\nif (IS_ERR(f_eem))\r\nreturn PTR_ERR(f_eem);\r\nstatus = usb_add_function(c, f_eem);\r\nif (status < 0)\r\nusb_put_function(f_eem);\r\nreturn status;\r\n} else if (can_support_ecm(c->cdev->gadget)) {\r\nf_ecm = usb_get_function(fi_ecm);\r\nif (IS_ERR(f_ecm))\r\nreturn PTR_ERR(f_ecm);\r\nstatus = usb_add_function(c, f_ecm);\r\nif (status < 0)\r\nusb_put_function(f_ecm);\r\nreturn status;\r\n} else {\r\nf_geth = usb_get_function(fi_geth);\r\nif (IS_ERR(f_geth))\r\nreturn PTR_ERR(f_geth);\r\nstatus = usb_add_function(c, f_geth);\r\nif (status < 0)\r\nusb_put_function(f_geth);\r\nreturn status;\r\n}\r\n}\r\nstatic int eth_bind(struct usb_composite_dev *cdev)\r\n{\r\nstruct usb_gadget *gadget = cdev->gadget;\r\nstruct f_eem_opts *eem_opts = NULL;\r\nstruct f_ecm_opts *ecm_opts = NULL;\r\nstruct f_gether_opts *geth_opts = NULL;\r\nstruct net_device *net;\r\nint status;\r\nif (use_eem) {\r\nfi_eem = usb_get_function_instance("eem");\r\nif (IS_ERR(fi_eem))\r\nreturn PTR_ERR(fi_eem);\r\neem_opts = container_of(fi_eem, struct f_eem_opts, func_inst);\r\nnet = eem_opts->net;\r\neth_config_driver.label = "CDC Ethernet (EEM)";\r\ndevice_desc.idVendor = cpu_to_le16(EEM_VENDOR_NUM);\r\ndevice_desc.idProduct = cpu_to_le16(EEM_PRODUCT_NUM);\r\n} else if (can_support_ecm(gadget)) {\r\nfi_ecm = usb_get_function_instance("ecm");\r\nif (IS_ERR(fi_ecm))\r\nreturn PTR_ERR(fi_ecm);\r\necm_opts = container_of(fi_ecm, struct f_ecm_opts, func_inst);\r\nnet = ecm_opts->net;\r\neth_config_driver.label = "CDC Ethernet (ECM)";\r\n} else {\r\nfi_geth = usb_get_function_instance("geth");\r\nif (IS_ERR(fi_geth))\r\nreturn PTR_ERR(fi_geth);\r\ngeth_opts = container_of(fi_geth, struct f_gether_opts,\r\nfunc_inst);\r\nnet = geth_opts->net;\r\neth_config_driver.label = "CDC Subset/SAFE";\r\ndevice_desc.idVendor = cpu_to_le16(SIMPLE_VENDOR_NUM);\r\ndevice_desc.idProduct = cpu_to_le16(SIMPLE_PRODUCT_NUM);\r\nif (!has_rndis())\r\ndevice_desc.bDeviceClass = USB_CLASS_VENDOR_SPEC;\r\n}\r\ngether_set_qmult(net, qmult);\r\nif (!gether_set_host_addr(net, host_addr))\r\npr_info("using host ethernet address: %s", host_addr);\r\nif (!gether_set_dev_addr(net, dev_addr))\r\npr_info("using self ethernet address: %s", dev_addr);\r\nif (has_rndis()) {\r\ngether_set_gadget(net, cdev->gadget);\r\nstatus = gether_register_netdev(net);\r\nif (status)\r\ngoto fail;\r\nif (use_eem)\r\neem_opts->bound = true;\r\nelse if (can_support_ecm(gadget))\r\necm_opts->bound = true;\r\nelse\r\ngeth_opts->bound = true;\r\nfi_rndis = usb_get_function_instance("rndis");\r\nif (IS_ERR(fi_rndis)) {\r\nstatus = PTR_ERR(fi_rndis);\r\ngoto fail;\r\n}\r\nrndis_borrow_net(fi_rndis, net);\r\ndevice_desc.idVendor = cpu_to_le16(RNDIS_VENDOR_NUM);\r\ndevice_desc.idProduct = cpu_to_le16(RNDIS_PRODUCT_NUM);\r\ndevice_desc.bNumConfigurations = 2;\r\n}\r\nstatus = usb_string_ids_tab(cdev, strings_dev);\r\nif (status < 0)\r\ngoto fail1;\r\ndevice_desc.iManufacturer = strings_dev[USB_GADGET_MANUFACTURER_IDX].id;\r\ndevice_desc.iProduct = strings_dev[USB_GADGET_PRODUCT_IDX].id;\r\nif (gadget_is_otg(gadget) && !otg_desc[0]) {\r\nstruct usb_descriptor_header *usb_desc;\r\nusb_desc = usb_otg_descriptor_alloc(gadget);\r\nif (!usb_desc)\r\ngoto fail1;\r\nusb_otg_descriptor_init(gadget, usb_desc);\r\notg_desc[0] = usb_desc;\r\notg_desc[1] = NULL;\r\n}\r\nif (has_rndis()) {\r\nstatus = usb_add_config(cdev, &rndis_config_driver,\r\nrndis_do_config);\r\nif (status < 0)\r\ngoto fail2;\r\n}\r\nstatus = usb_add_config(cdev, &eth_config_driver, eth_do_config);\r\nif (status < 0)\r\ngoto fail2;\r\nusb_composite_overwrite_options(cdev, &coverwrite);\r\ndev_info(&gadget->dev, "%s, version: " DRIVER_VERSION "\n",\r\nDRIVER_DESC);\r\nreturn 0;\r\nfail2:\r\nkfree(otg_desc[0]);\r\notg_desc[0] = NULL;\r\nfail1:\r\nif (has_rndis())\r\nusb_put_function_instance(fi_rndis);\r\nfail:\r\nif (use_eem)\r\nusb_put_function_instance(fi_eem);\r\nelse if (can_support_ecm(gadget))\r\nusb_put_function_instance(fi_ecm);\r\nelse\r\nusb_put_function_instance(fi_geth);\r\nreturn status;\r\n}\r\nstatic int eth_unbind(struct usb_composite_dev *cdev)\r\n{\r\nif (has_rndis()) {\r\nusb_put_function(f_rndis);\r\nusb_put_function_instance(fi_rndis);\r\n}\r\nif (use_eem) {\r\nusb_put_function(f_eem);\r\nusb_put_function_instance(fi_eem);\r\n} else if (can_support_ecm(cdev->gadget)) {\r\nusb_put_function(f_ecm);\r\nusb_put_function_instance(fi_ecm);\r\n} else {\r\nusb_put_function(f_geth);\r\nusb_put_function_instance(fi_geth);\r\n}\r\nkfree(otg_desc[0]);\r\notg_desc[0] = NULL;\r\nreturn 0;\r\n}

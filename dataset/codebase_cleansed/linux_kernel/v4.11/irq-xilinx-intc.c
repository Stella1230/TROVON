static void xintc_write(int reg, u32 data)\r\n{\r\nif (static_branch_unlikely(&xintc_is_be))\r\niowrite32be(data, xintc_irqc->base + reg);\r\nelse\r\niowrite32(data, xintc_irqc->base + reg);\r\n}\r\nstatic unsigned int xintc_read(int reg)\r\n{\r\nif (static_branch_unlikely(&xintc_is_be))\r\nreturn ioread32be(xintc_irqc->base + reg);\r\nelse\r\nreturn ioread32(xintc_irqc->base + reg);\r\n}\r\nstatic void intc_enable_or_unmask(struct irq_data *d)\r\n{\r\nunsigned long mask = 1 << d->hwirq;\r\npr_debug("irq-xilinx: enable_or_unmask: %ld\n", d->hwirq);\r\nif (irqd_is_level_type(d))\r\nxintc_write(IAR, mask);\r\nxintc_write(SIE, mask);\r\n}\r\nstatic void intc_disable_or_mask(struct irq_data *d)\r\n{\r\npr_debug("irq-xilinx: disable: %ld\n", d->hwirq);\r\nxintc_write(CIE, 1 << d->hwirq);\r\n}\r\nstatic void intc_ack(struct irq_data *d)\r\n{\r\npr_debug("irq-xilinx: ack: %ld\n", d->hwirq);\r\nxintc_write(IAR, 1 << d->hwirq);\r\n}\r\nstatic void intc_mask_ack(struct irq_data *d)\r\n{\r\nunsigned long mask = 1 << d->hwirq;\r\npr_debug("irq-xilinx: disable_and_ack: %ld\n", d->hwirq);\r\nxintc_write(CIE, mask);\r\nxintc_write(IAR, mask);\r\n}\r\nunsigned int xintc_get_irq(void)\r\n{\r\nunsigned int hwirq, irq = -1;\r\nhwirq = xintc_read(IVR);\r\nif (hwirq != -1U)\r\nirq = irq_find_mapping(xintc_irqc->root_domain, hwirq);\r\npr_debug("irq-xilinx: hwirq=%d, irq=%d\n", hwirq, irq);\r\nreturn irq;\r\n}\r\nstatic int xintc_map(struct irq_domain *d, unsigned int irq, irq_hw_number_t hw)\r\n{\r\nif (xintc_irqc->intr_mask & (1 << hw)) {\r\nirq_set_chip_and_handler_name(irq, &intc_dev,\r\nhandle_edge_irq, "edge");\r\nirq_clear_status_flags(irq, IRQ_LEVEL);\r\n} else {\r\nirq_set_chip_and_handler_name(irq, &intc_dev,\r\nhandle_level_irq, "level");\r\nirq_set_status_flags(irq, IRQ_LEVEL);\r\n}\r\nreturn 0;\r\n}\r\nstatic void xil_intc_irq_handler(struct irq_desc *desc)\r\n{\r\nstruct irq_chip *chip = irq_desc_get_chip(desc);\r\nu32 pending;\r\nchained_irq_enter(chip, desc);\r\ndo {\r\npending = xintc_get_irq();\r\nif (pending == -1U)\r\nbreak;\r\ngeneric_handle_irq(pending);\r\n} while (true);\r\nchained_irq_exit(chip, desc);\r\n}\r\nstatic int __init xilinx_intc_of_init(struct device_node *intc,\r\nstruct device_node *parent)\r\n{\r\nu32 nr_irq;\r\nint ret, irq;\r\nstruct xintc_irq_chip *irqc;\r\nif (xintc_irqc) {\r\npr_err("irq-xilinx: Multiple instances aren't supported\n");\r\nreturn -EINVAL;\r\n}\r\nirqc = kzalloc(sizeof(*irqc), GFP_KERNEL);\r\nif (!irqc)\r\nreturn -ENOMEM;\r\nxintc_irqc = irqc;\r\nirqc->base = of_iomap(intc, 0);\r\nBUG_ON(!irqc->base);\r\nret = of_property_read_u32(intc, "xlnx,num-intr-inputs", &nr_irq);\r\nif (ret < 0) {\r\npr_err("irq-xilinx: unable to read xlnx,num-intr-inputs\n");\r\ngoto err_alloc;\r\n}\r\nret = of_property_read_u32(intc, "xlnx,kind-of-intr", &irqc->intr_mask);\r\nif (ret < 0) {\r\npr_warn("irq-xilinx: unable to read xlnx,kind-of-intr\n");\r\nirqc->intr_mask = 0;\r\n}\r\nif (irqc->intr_mask >> nr_irq)\r\npr_warn("irq-xilinx: mismatch in kind-of-intr param\n");\r\npr_info("irq-xilinx: %s: num_irq=%d, edge=0x%x\n",\r\nintc->full_name, nr_irq, irqc->intr_mask);\r\nxintc_write(IER, 0);\r\nxintc_write(IAR, 0xffffffff);\r\nxintc_write(MER, MER_HIE | MER_ME);\r\nif (!(xintc_read(MER) & (MER_HIE | MER_ME))) {\r\nstatic_branch_enable(&xintc_is_be);\r\nxintc_write(MER, MER_HIE | MER_ME);\r\n}\r\nirqc->root_domain = irq_domain_add_linear(intc, nr_irq,\r\n&xintc_irq_domain_ops, irqc);\r\nif (!irqc->root_domain) {\r\npr_err("irq-xilinx: Unable to create IRQ domain\n");\r\ngoto err_alloc;\r\n}\r\nif (parent) {\r\nirq = irq_of_parse_and_map(intc, 0);\r\nif (irq) {\r\nirq_set_chained_handler_and_data(irq,\r\nxil_intc_irq_handler,\r\nirqc);\r\n} else {\r\npr_err("irq-xilinx: interrupts property not in DT\n");\r\nret = -EINVAL;\r\ngoto err_alloc;\r\n}\r\n} else {\r\nirq_set_default_host(irqc->root_domain);\r\n}\r\nreturn 0;\r\nerr_alloc:\r\nxintc_irqc = NULL;\r\nkfree(irqc);\r\nreturn ret;\r\n}

static void int3403_notify(acpi_handle handle,\r\nu32 event, void *data)\r\n{\r\nstruct int3403_priv *priv = data;\r\nstruct int3403_sensor *obj;\r\nif (!priv)\r\nreturn;\r\nobj = priv->priv;\r\nif (priv->type != INT3403_TYPE_SENSOR || !obj)\r\nreturn;\r\nswitch (event) {\r\ncase INT3403_PERF_CHANGED_EVENT:\r\nbreak;\r\ncase INT3403_THERMAL_EVENT:\r\nint340x_thermal_zone_device_update(obj->int340x_zone,\r\nTHERMAL_TRIP_VIOLATED);\r\nbreak;\r\ncase INT3403_PERF_TRIP_POINT_CHANGED:\r\nint340x_thermal_read_trips(obj->int340x_zone);\r\nint340x_thermal_zone_device_update(obj->int340x_zone,\r\nTHERMAL_TRIP_CHANGED);\r\nbreak;\r\ndefault:\r\ndev_err(&priv->pdev->dev, "Unsupported event [0x%x]\n", event);\r\nbreak;\r\n}\r\n}\r\nstatic int int3403_sensor_add(struct int3403_priv *priv)\r\n{\r\nint result = 0;\r\nstruct int3403_sensor *obj;\r\nobj = devm_kzalloc(&priv->pdev->dev, sizeof(*obj), GFP_KERNEL);\r\nif (!obj)\r\nreturn -ENOMEM;\r\npriv->priv = obj;\r\nobj->int340x_zone = int340x_thermal_zone_add(priv->adev, NULL);\r\nif (IS_ERR(obj->int340x_zone))\r\nreturn PTR_ERR(obj->int340x_zone);\r\nresult = acpi_install_notify_handler(priv->adev->handle,\r\nACPI_DEVICE_NOTIFY, int3403_notify,\r\n(void *)priv);\r\nif (result)\r\ngoto err_free_obj;\r\nreturn 0;\r\nerr_free_obj:\r\nint340x_thermal_zone_remove(obj->int340x_zone);\r\nreturn result;\r\n}\r\nstatic int int3403_sensor_remove(struct int3403_priv *priv)\r\n{\r\nstruct int3403_sensor *obj = priv->priv;\r\nacpi_remove_notify_handler(priv->adev->handle,\r\nACPI_DEVICE_NOTIFY, int3403_notify);\r\nint340x_thermal_zone_remove(obj->int340x_zone);\r\nreturn 0;\r\n}\r\nstatic int int3403_get_max_state(struct thermal_cooling_device *cdev,\r\nunsigned long *state)\r\n{\r\nstruct int3403_priv *priv = cdev->devdata;\r\nstruct int3403_cdev *obj = priv->priv;\r\n*state = obj->max_state;\r\nreturn 0;\r\n}\r\nstatic int int3403_get_cur_state(struct thermal_cooling_device *cdev,\r\nunsigned long *state)\r\n{\r\nstruct int3403_priv *priv = cdev->devdata;\r\nunsigned long long level;\r\nacpi_status status;\r\nstatus = acpi_evaluate_integer(priv->adev->handle, "PPPC", NULL, &level);\r\nif (ACPI_SUCCESS(status)) {\r\n*state = level;\r\nreturn 0;\r\n} else\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nint3403_set_cur_state(struct thermal_cooling_device *cdev, unsigned long state)\r\n{\r\nstruct int3403_priv *priv = cdev->devdata;\r\nacpi_status status;\r\nstatus = acpi_execute_simple_method(priv->adev->handle, "SPPC", state);\r\nif (ACPI_SUCCESS(status))\r\nreturn 0;\r\nelse\r\nreturn -EINVAL;\r\n}\r\nstatic int int3403_cdev_add(struct int3403_priv *priv)\r\n{\r\nint result = 0;\r\nacpi_status status;\r\nstruct int3403_cdev *obj;\r\nstruct acpi_buffer buf = { ACPI_ALLOCATE_BUFFER, NULL };\r\nunion acpi_object *p;\r\nobj = devm_kzalloc(&priv->pdev->dev, sizeof(*obj), GFP_KERNEL);\r\nif (!obj)\r\nreturn -ENOMEM;\r\nstatus = acpi_evaluate_object(priv->adev->handle, "PPSS", NULL, &buf);\r\nif (ACPI_FAILURE(status))\r\nreturn -ENODEV;\r\np = buf.pointer;\r\nif (!p || (p->type != ACPI_TYPE_PACKAGE)) {\r\nprintk(KERN_WARNING "Invalid PPSS data\n");\r\nkfree(buf.pointer);\r\nreturn -EFAULT;\r\n}\r\nobj->max_state = p->package.count - 1;\r\nobj->cdev =\r\nthermal_cooling_device_register(acpi_device_bid(priv->adev),\r\npriv, &int3403_cooling_ops);\r\nif (IS_ERR(obj->cdev))\r\nresult = PTR_ERR(obj->cdev);\r\npriv->priv = obj;\r\nkfree(buf.pointer);\r\nreturn result;\r\n}\r\nstatic int int3403_cdev_remove(struct int3403_priv *priv)\r\n{\r\nstruct int3403_cdev *obj = priv->priv;\r\nthermal_cooling_device_unregister(obj->cdev);\r\nreturn 0;\r\n}\r\nstatic int int3403_add(struct platform_device *pdev)\r\n{\r\nstruct int3403_priv *priv;\r\nint result = 0;\r\nacpi_status status;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(struct int3403_priv),\r\nGFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->pdev = pdev;\r\npriv->adev = ACPI_COMPANION(&(pdev->dev));\r\nif (!priv->adev) {\r\nresult = -EINVAL;\r\ngoto err;\r\n}\r\nstatus = acpi_evaluate_integer(priv->adev->handle, "PTYP",\r\nNULL, &priv->type);\r\nif (ACPI_FAILURE(status)) {\r\nresult = -EINVAL;\r\ngoto err;\r\n}\r\nplatform_set_drvdata(pdev, priv);\r\nswitch (priv->type) {\r\ncase INT3403_TYPE_SENSOR:\r\nresult = int3403_sensor_add(priv);\r\nbreak;\r\ncase INT3403_TYPE_CHARGER:\r\ncase INT3403_TYPE_BATTERY:\r\nresult = int3403_cdev_add(priv);\r\nbreak;\r\ndefault:\r\nresult = -EINVAL;\r\n}\r\nif (result)\r\ngoto err;\r\nreturn result;\r\nerr:\r\nreturn result;\r\n}\r\nstatic int int3403_remove(struct platform_device *pdev)\r\n{\r\nstruct int3403_priv *priv = platform_get_drvdata(pdev);\r\nswitch (priv->type) {\r\ncase INT3403_TYPE_SENSOR:\r\nint3403_sensor_remove(priv);\r\nbreak;\r\ncase INT3403_TYPE_CHARGER:\r\ncase INT3403_TYPE_BATTERY:\r\nint3403_cdev_remove(priv);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}

static u8 d40_width_to_bits(enum dma_slave_buswidth width)\r\n{\r\nif (width == DMA_SLAVE_BUSWIDTH_1_BYTE)\r\nreturn STEDMA40_ESIZE_8_BIT;\r\nelse if (width == DMA_SLAVE_BUSWIDTH_2_BYTES)\r\nreturn STEDMA40_ESIZE_16_BIT;\r\nelse if (width == DMA_SLAVE_BUSWIDTH_8_BYTES)\r\nreturn STEDMA40_ESIZE_64_BIT;\r\nelse\r\nreturn STEDMA40_ESIZE_32_BIT;\r\n}\r\nvoid d40_log_cfg(struct stedma40_chan_cfg *cfg,\r\nu32 *lcsp1, u32 *lcsp3)\r\n{\r\nu32 l3 = 0;\r\nu32 l1 = 0;\r\nif (cfg->dir == DMA_MEM_TO_DEV ||\r\ncfg->dir == DMA_MEM_TO_MEM)\r\nl1 |= BIT(D40_MEM_LCSP1_SCFG_INCR_POS);\r\nif (cfg->dir == DMA_DEV_TO_MEM ||\r\ncfg->dir == DMA_MEM_TO_MEM)\r\nl3 |= BIT(D40_MEM_LCSP3_DCFG_INCR_POS);\r\nif (cfg->dir == DMA_DEV_TO_MEM ||\r\ncfg->dir == DMA_DEV_TO_DEV)\r\nl1 |= BIT(D40_MEM_LCSP1_SCFG_MST_POS);\r\nif (cfg->dir == DMA_MEM_TO_DEV ||\r\ncfg->dir == DMA_DEV_TO_DEV)\r\nl3 |= BIT(D40_MEM_LCSP3_DCFG_MST_POS);\r\nl3 |= BIT(D40_MEM_LCSP3_DCFG_EIM_POS);\r\nl3 |= cfg->dst_info.psize << D40_MEM_LCSP3_DCFG_PSIZE_POS;\r\nl3 |= d40_width_to_bits(cfg->dst_info.data_width)\r\n<< D40_MEM_LCSP3_DCFG_ESIZE_POS;\r\nl1 |= BIT(D40_MEM_LCSP1_SCFG_EIM_POS);\r\nl1 |= cfg->src_info.psize << D40_MEM_LCSP1_SCFG_PSIZE_POS;\r\nl1 |= d40_width_to_bits(cfg->src_info.data_width)\r\n<< D40_MEM_LCSP1_SCFG_ESIZE_POS;\r\n*lcsp1 = l1;\r\n*lcsp3 = l3;\r\n}\r\nvoid d40_phy_cfg(struct stedma40_chan_cfg *cfg, u32 *src_cfg, u32 *dst_cfg)\r\n{\r\nu32 src = 0;\r\nu32 dst = 0;\r\nif ((cfg->dir == DMA_DEV_TO_MEM) ||\r\n(cfg->dir == DMA_DEV_TO_DEV)) {\r\nsrc |= BIT(D40_SREG_CFG_MST_POS);\r\nsrc |= D40_TYPE_TO_EVENT(cfg->dev_type);\r\nif (cfg->src_info.flow_ctrl == STEDMA40_NO_FLOW_CTRL)\r\nsrc |= BIT(D40_SREG_CFG_PHY_TM_POS);\r\nelse\r\nsrc |= 3 << D40_SREG_CFG_PHY_TM_POS;\r\n}\r\nif ((cfg->dir == DMA_MEM_TO_DEV) ||\r\n(cfg->dir == DMA_DEV_TO_DEV)) {\r\ndst |= BIT(D40_SREG_CFG_MST_POS);\r\ndst |= D40_TYPE_TO_EVENT(cfg->dev_type);\r\nif (cfg->dst_info.flow_ctrl == STEDMA40_NO_FLOW_CTRL)\r\ndst |= BIT(D40_SREG_CFG_PHY_TM_POS);\r\nelse\r\ndst |= 3 << D40_SREG_CFG_PHY_TM_POS;\r\n}\r\ndst |= BIT(D40_SREG_CFG_TIM_POS);\r\nsrc |= BIT(D40_SREG_CFG_EIM_POS);\r\ndst |= BIT(D40_SREG_CFG_EIM_POS);\r\nif (cfg->src_info.psize != STEDMA40_PSIZE_PHY_1) {\r\nsrc |= BIT(D40_SREG_CFG_PHY_PEN_POS);\r\nsrc |= cfg->src_info.psize << D40_SREG_CFG_PSIZE_POS;\r\n}\r\nif (cfg->dst_info.psize != STEDMA40_PSIZE_PHY_1) {\r\ndst |= BIT(D40_SREG_CFG_PHY_PEN_POS);\r\ndst |= cfg->dst_info.psize << D40_SREG_CFG_PSIZE_POS;\r\n}\r\nsrc |= d40_width_to_bits(cfg->src_info.data_width)\r\n<< D40_SREG_CFG_ESIZE_POS;\r\ndst |= d40_width_to_bits(cfg->dst_info.data_width)\r\n<< D40_SREG_CFG_ESIZE_POS;\r\nif (cfg->high_priority) {\r\nsrc |= BIT(D40_SREG_CFG_PRI_POS);\r\ndst |= BIT(D40_SREG_CFG_PRI_POS);\r\n}\r\nif (cfg->src_info.big_endian)\r\nsrc |= BIT(D40_SREG_CFG_LBE_POS);\r\nif (cfg->dst_info.big_endian)\r\ndst |= BIT(D40_SREG_CFG_LBE_POS);\r\n*src_cfg = src;\r\n*dst_cfg = dst;\r\n}\r\nstatic int d40_phy_fill_lli(struct d40_phy_lli *lli,\r\ndma_addr_t data,\r\nu32 data_size,\r\ndma_addr_t next_lli,\r\nu32 reg_cfg,\r\nstruct stedma40_half_channel_info *info,\r\nunsigned int flags)\r\n{\r\nbool addr_inc = flags & LLI_ADDR_INC;\r\nbool term_int = flags & LLI_TERM_INT;\r\nunsigned int data_width = info->data_width;\r\nint psize = info->psize;\r\nint num_elems;\r\nif (psize == STEDMA40_PSIZE_PHY_1)\r\nnum_elems = 1;\r\nelse\r\nnum_elems = 2 << psize;\r\nif (!IS_ALIGNED(data, data_width))\r\nreturn -EINVAL;\r\nif (data_size < num_elems * data_width)\r\nreturn -EINVAL;\r\nlli->reg_elt = (data_size / data_width) << D40_SREG_ELEM_PHY_ECNT_POS;\r\nif (addr_inc)\r\nlli->reg_elt |= data_width << D40_SREG_ELEM_PHY_EIDX_POS;\r\nlli->reg_ptr = data;\r\nlli->reg_cfg = reg_cfg;\r\nif (next_lli == 0)\r\nlli->reg_lnk = BIT(D40_SREG_LNK_PHY_TCP_POS);\r\nelse\r\nlli->reg_lnk = next_lli;\r\nif (term_int)\r\nlli->reg_cfg |= BIT(D40_SREG_CFG_TIM_POS);\r\nelse\r\nlli->reg_cfg &= ~BIT(D40_SREG_CFG_TIM_POS);\r\nreturn 0;\r\n}\r\nstatic int d40_seg_size(int size, int data_width1, int data_width2)\r\n{\r\nu32 max_w = max(data_width1, data_width2);\r\nu32 min_w = min(data_width1, data_width2);\r\nu32 seg_max = ALIGN(STEDMA40_MAX_SEG_SIZE * min_w, max_w);\r\nif (seg_max > STEDMA40_MAX_SEG_SIZE)\r\nseg_max -= max_w;\r\nif (size <= seg_max)\r\nreturn size;\r\nif (size <= 2 * seg_max)\r\nreturn ALIGN(size / 2, max_w);\r\nreturn seg_max;\r\n}\r\nstatic struct d40_phy_lli *\r\nd40_phy_buf_to_lli(struct d40_phy_lli *lli, dma_addr_t addr, u32 size,\r\ndma_addr_t lli_phys, dma_addr_t first_phys, u32 reg_cfg,\r\nstruct stedma40_half_channel_info *info,\r\nstruct stedma40_half_channel_info *otherinfo,\r\nunsigned long flags)\r\n{\r\nbool lastlink = flags & LLI_LAST_LINK;\r\nbool addr_inc = flags & LLI_ADDR_INC;\r\nbool term_int = flags & LLI_TERM_INT;\r\nbool cyclic = flags & LLI_CYCLIC;\r\nint err;\r\ndma_addr_t next = lli_phys;\r\nint size_rest = size;\r\nint size_seg = 0;\r\nif (term_int)\r\nflags &= ~LLI_TERM_INT;\r\ndo {\r\nsize_seg = d40_seg_size(size_rest, info->data_width,\r\notherinfo->data_width);\r\nsize_rest -= size_seg;\r\nif (size_rest == 0 && term_int)\r\nflags |= LLI_TERM_INT;\r\nif (size_rest == 0 && lastlink)\r\nnext = cyclic ? first_phys : 0;\r\nelse\r\nnext = ALIGN(next + sizeof(struct d40_phy_lli),\r\nD40_LLI_ALIGN);\r\nerr = d40_phy_fill_lli(lli, addr, size_seg, next,\r\nreg_cfg, info, flags);\r\nif (err)\r\ngoto err;\r\nlli++;\r\nif (addr_inc)\r\naddr += size_seg;\r\n} while (size_rest);\r\nreturn lli;\r\nerr:\r\nreturn NULL;\r\n}\r\nint d40_phy_sg_to_lli(struct scatterlist *sg,\r\nint sg_len,\r\ndma_addr_t target,\r\nstruct d40_phy_lli *lli_sg,\r\ndma_addr_t lli_phys,\r\nu32 reg_cfg,\r\nstruct stedma40_half_channel_info *info,\r\nstruct stedma40_half_channel_info *otherinfo,\r\nunsigned long flags)\r\n{\r\nint total_size = 0;\r\nint i;\r\nstruct scatterlist *current_sg = sg;\r\nstruct d40_phy_lli *lli = lli_sg;\r\ndma_addr_t l_phys = lli_phys;\r\nif (!target)\r\nflags |= LLI_ADDR_INC;\r\nfor_each_sg(sg, current_sg, sg_len, i) {\r\ndma_addr_t sg_addr = sg_dma_address(current_sg);\r\nunsigned int len = sg_dma_len(current_sg);\r\ndma_addr_t dst = target ?: sg_addr;\r\ntotal_size += sg_dma_len(current_sg);\r\nif (i == sg_len - 1)\r\nflags |= LLI_TERM_INT | LLI_LAST_LINK;\r\nl_phys = ALIGN(lli_phys + (lli - lli_sg) *\r\nsizeof(struct d40_phy_lli), D40_LLI_ALIGN);\r\nlli = d40_phy_buf_to_lli(lli, dst, len, l_phys, lli_phys,\r\nreg_cfg, info, otherinfo, flags);\r\nif (lli == NULL)\r\nreturn -EINVAL;\r\n}\r\nreturn total_size;\r\n}\r\nstatic void d40_log_lli_link(struct d40_log_lli *lli_dst,\r\nstruct d40_log_lli *lli_src,\r\nint next, unsigned int flags)\r\n{\r\nbool interrupt = flags & LLI_TERM_INT;\r\nu32 slos = 0;\r\nu32 dlos = 0;\r\nif (next != -EINVAL) {\r\nslos = next * 2;\r\ndlos = next * 2 + 1;\r\n}\r\nif (interrupt) {\r\nlli_dst->lcsp13 |= D40_MEM_LCSP1_SCFG_TIM_MASK;\r\nlli_dst->lcsp13 |= D40_MEM_LCSP3_DTCP_MASK;\r\n}\r\nlli_src->lcsp13 = (lli_src->lcsp13 & ~D40_MEM_LCSP1_SLOS_MASK) |\r\n(slos << D40_MEM_LCSP1_SLOS_POS);\r\nlli_dst->lcsp13 = (lli_dst->lcsp13 & ~D40_MEM_LCSP1_SLOS_MASK) |\r\n(dlos << D40_MEM_LCSP1_SLOS_POS);\r\n}\r\nvoid d40_log_lli_lcpa_write(struct d40_log_lli_full *lcpa,\r\nstruct d40_log_lli *lli_dst,\r\nstruct d40_log_lli *lli_src,\r\nint next, unsigned int flags)\r\n{\r\nd40_log_lli_link(lli_dst, lli_src, next, flags);\r\nwritel_relaxed(lli_src->lcsp02, &lcpa[0].lcsp0);\r\nwritel_relaxed(lli_src->lcsp13, &lcpa[0].lcsp1);\r\nwritel_relaxed(lli_dst->lcsp02, &lcpa[0].lcsp2);\r\nwritel_relaxed(lli_dst->lcsp13, &lcpa[0].lcsp3);\r\n}\r\nvoid d40_log_lli_lcla_write(struct d40_log_lli *lcla,\r\nstruct d40_log_lli *lli_dst,\r\nstruct d40_log_lli *lli_src,\r\nint next, unsigned int flags)\r\n{\r\nd40_log_lli_link(lli_dst, lli_src, next, flags);\r\nwritel_relaxed(lli_src->lcsp02, &lcla[0].lcsp02);\r\nwritel_relaxed(lli_src->lcsp13, &lcla[0].lcsp13);\r\nwritel_relaxed(lli_dst->lcsp02, &lcla[1].lcsp02);\r\nwritel_relaxed(lli_dst->lcsp13, &lcla[1].lcsp13);\r\n}\r\nstatic void d40_log_fill_lli(struct d40_log_lli *lli,\r\ndma_addr_t data, u32 data_size,\r\nu32 reg_cfg,\r\nu32 data_width,\r\nunsigned int flags)\r\n{\r\nbool addr_inc = flags & LLI_ADDR_INC;\r\nlli->lcsp13 = reg_cfg;\r\nlli->lcsp02 = ((data_size / data_width) <<\r\nD40_MEM_LCSP0_ECNT_POS) & D40_MEM_LCSP0_ECNT_MASK;\r\nBUG_ON((data_size / data_width) > STEDMA40_MAX_SEG_SIZE);\r\nlli->lcsp02 |= data & D40_MEM_LCSP0_SPTR_MASK;\r\nlli->lcsp13 |= data & D40_MEM_LCSP1_SPTR_MASK;\r\nif (addr_inc)\r\nlli->lcsp13 |= D40_MEM_LCSP1_SCFG_INCR_MASK;\r\n}\r\nstatic struct d40_log_lli *d40_log_buf_to_lli(struct d40_log_lli *lli_sg,\r\ndma_addr_t addr,\r\nint size,\r\nu32 lcsp13,\r\nu32 data_width1,\r\nu32 data_width2,\r\nunsigned int flags)\r\n{\r\nbool addr_inc = flags & LLI_ADDR_INC;\r\nstruct d40_log_lli *lli = lli_sg;\r\nint size_rest = size;\r\nint size_seg = 0;\r\ndo {\r\nsize_seg = d40_seg_size(size_rest, data_width1, data_width2);\r\nsize_rest -= size_seg;\r\nd40_log_fill_lli(lli,\r\naddr,\r\nsize_seg,\r\nlcsp13, data_width1,\r\nflags);\r\nif (addr_inc)\r\naddr += size_seg;\r\nlli++;\r\n} while (size_rest);\r\nreturn lli;\r\n}\r\nint d40_log_sg_to_lli(struct scatterlist *sg,\r\nint sg_len,\r\ndma_addr_t dev_addr,\r\nstruct d40_log_lli *lli_sg,\r\nu32 lcsp13,\r\nu32 data_width1, u32 data_width2)\r\n{\r\nint total_size = 0;\r\nstruct scatterlist *current_sg = sg;\r\nint i;\r\nstruct d40_log_lli *lli = lli_sg;\r\nunsigned long flags = 0;\r\nif (!dev_addr)\r\nflags |= LLI_ADDR_INC;\r\nfor_each_sg(sg, current_sg, sg_len, i) {\r\ndma_addr_t sg_addr = sg_dma_address(current_sg);\r\nunsigned int len = sg_dma_len(current_sg);\r\ndma_addr_t addr = dev_addr ?: sg_addr;\r\ntotal_size += sg_dma_len(current_sg);\r\nlli = d40_log_buf_to_lli(lli, addr, len,\r\nlcsp13,\r\ndata_width1,\r\ndata_width2,\r\nflags);\r\n}\r\nreturn total_size;\r\n}

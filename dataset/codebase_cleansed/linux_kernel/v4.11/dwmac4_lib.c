int dwmac4_dma_reset(void __iomem *ioaddr)\r\n{\r\nu32 value = readl(ioaddr + DMA_BUS_MODE);\r\nint limit;\r\nvalue |= DMA_BUS_MODE_SFT_RESET;\r\nwritel(value, ioaddr + DMA_BUS_MODE);\r\nlimit = 10;\r\nwhile (limit--) {\r\nif (!(readl(ioaddr + DMA_BUS_MODE) & DMA_BUS_MODE_SFT_RESET))\r\nbreak;\r\nmdelay(10);\r\n}\r\nif (limit < 0)\r\nreturn -EBUSY;\r\nreturn 0;\r\n}\r\nvoid dwmac4_set_rx_tail_ptr(void __iomem *ioaddr, u32 tail_ptr, u32 chan)\r\n{\r\nwritel(tail_ptr, ioaddr + DMA_CHAN_RX_END_ADDR(0));\r\n}\r\nvoid dwmac4_set_tx_tail_ptr(void __iomem *ioaddr, u32 tail_ptr, u32 chan)\r\n{\r\nwritel(tail_ptr, ioaddr + DMA_CHAN_TX_END_ADDR(0));\r\n}\r\nvoid dwmac4_dma_start_tx(void __iomem *ioaddr)\r\n{\r\nu32 value = readl(ioaddr + DMA_CHAN_TX_CONTROL(STMMAC_CHAN0));\r\nvalue |= DMA_CONTROL_ST;\r\nwritel(value, ioaddr + DMA_CHAN_TX_CONTROL(STMMAC_CHAN0));\r\nvalue = readl(ioaddr + GMAC_CONFIG);\r\nvalue |= GMAC_CONFIG_TE;\r\nwritel(value, ioaddr + GMAC_CONFIG);\r\n}\r\nvoid dwmac4_dma_stop_tx(void __iomem *ioaddr)\r\n{\r\nu32 value = readl(ioaddr + DMA_CHAN_TX_CONTROL(STMMAC_CHAN0));\r\nvalue &= ~DMA_CONTROL_ST;\r\nwritel(value, ioaddr + DMA_CHAN_TX_CONTROL(STMMAC_CHAN0));\r\nvalue = readl(ioaddr + GMAC_CONFIG);\r\nvalue &= ~GMAC_CONFIG_TE;\r\nwritel(value, ioaddr + GMAC_CONFIG);\r\n}\r\nvoid dwmac4_dma_start_rx(void __iomem *ioaddr)\r\n{\r\nu32 value = readl(ioaddr + DMA_CHAN_RX_CONTROL(STMMAC_CHAN0));\r\nvalue |= DMA_CONTROL_SR;\r\nwritel(value, ioaddr + DMA_CHAN_RX_CONTROL(STMMAC_CHAN0));\r\nvalue = readl(ioaddr + GMAC_CONFIG);\r\nvalue |= GMAC_CONFIG_RE;\r\nwritel(value, ioaddr + GMAC_CONFIG);\r\n}\r\nvoid dwmac4_dma_stop_rx(void __iomem *ioaddr)\r\n{\r\nu32 value = readl(ioaddr + DMA_CHAN_RX_CONTROL(STMMAC_CHAN0));\r\nvalue &= ~DMA_CONTROL_SR;\r\nwritel(value, ioaddr + DMA_CHAN_RX_CONTROL(STMMAC_CHAN0));\r\nvalue = readl(ioaddr + GMAC_CONFIG);\r\nvalue &= ~GMAC_CONFIG_RE;\r\nwritel(value, ioaddr + GMAC_CONFIG);\r\n}\r\nvoid dwmac4_set_tx_ring_len(void __iomem *ioaddr, u32 len)\r\n{\r\nwritel(len, ioaddr + DMA_CHAN_TX_RING_LEN(STMMAC_CHAN0));\r\n}\r\nvoid dwmac4_set_rx_ring_len(void __iomem *ioaddr, u32 len)\r\n{\r\nwritel(len, ioaddr + DMA_CHAN_RX_RING_LEN(STMMAC_CHAN0));\r\n}\r\nvoid dwmac4_enable_dma_irq(void __iomem *ioaddr)\r\n{\r\nwritel(DMA_CHAN_INTR_DEFAULT_MASK, ioaddr +\r\nDMA_CHAN_INTR_ENA(STMMAC_CHAN0));\r\n}\r\nvoid dwmac410_enable_dma_irq(void __iomem *ioaddr)\r\n{\r\nwritel(DMA_CHAN_INTR_DEFAULT_MASK_4_10,\r\nioaddr + DMA_CHAN_INTR_ENA(STMMAC_CHAN0));\r\n}\r\nvoid dwmac4_disable_dma_irq(void __iomem *ioaddr)\r\n{\r\nwritel(0, ioaddr + DMA_CHAN_INTR_ENA(STMMAC_CHAN0));\r\n}\r\nint dwmac4_dma_interrupt(void __iomem *ioaddr,\r\nstruct stmmac_extra_stats *x)\r\n{\r\nint ret = 0;\r\nu32 intr_status = readl(ioaddr + DMA_CHAN_STATUS(0));\r\nif (unlikely(intr_status & DMA_CHAN_STATUS_AIS)) {\r\nif (unlikely(intr_status & DMA_CHAN_STATUS_RBU))\r\nx->rx_buf_unav_irq++;\r\nif (unlikely(intr_status & DMA_CHAN_STATUS_RPS))\r\nx->rx_process_stopped_irq++;\r\nif (unlikely(intr_status & DMA_CHAN_STATUS_RWT))\r\nx->rx_watchdog_irq++;\r\nif (unlikely(intr_status & DMA_CHAN_STATUS_ETI))\r\nx->tx_early_irq++;\r\nif (unlikely(intr_status & DMA_CHAN_STATUS_TPS)) {\r\nx->tx_process_stopped_irq++;\r\nret = tx_hard_error;\r\n}\r\nif (unlikely(intr_status & DMA_CHAN_STATUS_FBE)) {\r\nx->fatal_bus_error_irq++;\r\nret = tx_hard_error;\r\n}\r\n}\r\nif (likely(intr_status & DMA_CHAN_STATUS_NIS)) {\r\nx->normal_irq_n++;\r\nif (likely(intr_status & DMA_CHAN_STATUS_RI)) {\r\nu32 value;\r\nvalue = readl(ioaddr + DMA_CHAN_INTR_ENA(STMMAC_CHAN0));\r\nif (likely(value & DMA_CHAN_INTR_ENA_RIE)) {\r\nx->rx_normal_irq_n++;\r\nret |= handle_rx;\r\n}\r\n}\r\nif (likely(intr_status & DMA_CHAN_STATUS_TI)) {\r\nx->tx_normal_irq_n++;\r\nret |= handle_tx;\r\n}\r\nif (unlikely(intr_status & DMA_CHAN_STATUS_ERI))\r\nx->rx_early_irq++;\r\n}\r\nwritel((intr_status & 0x3fffc7),\r\nioaddr + DMA_CHAN_STATUS(STMMAC_CHAN0));\r\nreturn ret;\r\n}\r\nvoid stmmac_dwmac4_set_mac_addr(void __iomem *ioaddr, u8 addr[6],\r\nunsigned int high, unsigned int low)\r\n{\r\nunsigned long data;\r\ndata = (addr[5] << 8) | addr[4];\r\ndata |= (STMMAC_CHAN0 << GMAC_HI_DCS_SHIFT);\r\nwritel(data | GMAC_HI_REG_AE, ioaddr + high);\r\ndata = (addr[3] << 24) | (addr[2] << 16) | (addr[1] << 8) | addr[0];\r\nwritel(data, ioaddr + low);\r\n}\r\nvoid stmmac_dwmac4_set_mac(void __iomem *ioaddr, bool enable)\r\n{\r\nu32 value = readl(ioaddr + GMAC_CONFIG);\r\nif (enable)\r\nvalue |= GMAC_CONFIG_RE | GMAC_CONFIG_TE;\r\nelse\r\nvalue &= ~(GMAC_CONFIG_TE | GMAC_CONFIG_RE);\r\nwritel(value, ioaddr + GMAC_CONFIG);\r\n}\r\nvoid stmmac_dwmac4_get_mac_addr(void __iomem *ioaddr, unsigned char *addr,\r\nunsigned int high, unsigned int low)\r\n{\r\nunsigned int hi_addr, lo_addr;\r\nhi_addr = readl(ioaddr + high);\r\nlo_addr = readl(ioaddr + low);\r\naddr[0] = lo_addr & 0xff;\r\naddr[1] = (lo_addr >> 8) & 0xff;\r\naddr[2] = (lo_addr >> 16) & 0xff;\r\naddr[3] = (lo_addr >> 24) & 0xff;\r\naddr[4] = hi_addr & 0xff;\r\naddr[5] = (hi_addr >> 8) & 0xff;\r\n}

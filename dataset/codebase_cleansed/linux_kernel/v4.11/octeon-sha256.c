static void octeon_sha256_store_hash(struct sha256_state *sctx)\r\n{\r\nu64 *hash = (u64 *)sctx->state;\r\nwrite_octeon_64bit_hash_dword(hash[0], 0);\r\nwrite_octeon_64bit_hash_dword(hash[1], 1);\r\nwrite_octeon_64bit_hash_dword(hash[2], 2);\r\nwrite_octeon_64bit_hash_dword(hash[3], 3);\r\n}\r\nstatic void octeon_sha256_read_hash(struct sha256_state *sctx)\r\n{\r\nu64 *hash = (u64 *)sctx->state;\r\nhash[0] = read_octeon_64bit_hash_dword(0);\r\nhash[1] = read_octeon_64bit_hash_dword(1);\r\nhash[2] = read_octeon_64bit_hash_dword(2);\r\nhash[3] = read_octeon_64bit_hash_dword(3);\r\n}\r\nstatic void octeon_sha256_transform(const void *_block)\r\n{\r\nconst u64 *block = _block;\r\nwrite_octeon_64bit_block_dword(block[0], 0);\r\nwrite_octeon_64bit_block_dword(block[1], 1);\r\nwrite_octeon_64bit_block_dword(block[2], 2);\r\nwrite_octeon_64bit_block_dword(block[3], 3);\r\nwrite_octeon_64bit_block_dword(block[4], 4);\r\nwrite_octeon_64bit_block_dword(block[5], 5);\r\nwrite_octeon_64bit_block_dword(block[6], 6);\r\nocteon_sha256_start(block[7]);\r\n}\r\nstatic int octeon_sha224_init(struct shash_desc *desc)\r\n{\r\nstruct sha256_state *sctx = shash_desc_ctx(desc);\r\nsctx->state[0] = SHA224_H0;\r\nsctx->state[1] = SHA224_H1;\r\nsctx->state[2] = SHA224_H2;\r\nsctx->state[3] = SHA224_H3;\r\nsctx->state[4] = SHA224_H4;\r\nsctx->state[5] = SHA224_H5;\r\nsctx->state[6] = SHA224_H6;\r\nsctx->state[7] = SHA224_H7;\r\nsctx->count = 0;\r\nreturn 0;\r\n}\r\nstatic int octeon_sha256_init(struct shash_desc *desc)\r\n{\r\nstruct sha256_state *sctx = shash_desc_ctx(desc);\r\nsctx->state[0] = SHA256_H0;\r\nsctx->state[1] = SHA256_H1;\r\nsctx->state[2] = SHA256_H2;\r\nsctx->state[3] = SHA256_H3;\r\nsctx->state[4] = SHA256_H4;\r\nsctx->state[5] = SHA256_H5;\r\nsctx->state[6] = SHA256_H6;\r\nsctx->state[7] = SHA256_H7;\r\nsctx->count = 0;\r\nreturn 0;\r\n}\r\nstatic void __octeon_sha256_update(struct sha256_state *sctx, const u8 *data,\r\nunsigned int len)\r\n{\r\nunsigned int partial;\r\nunsigned int done;\r\nconst u8 *src;\r\npartial = sctx->count % SHA256_BLOCK_SIZE;\r\nsctx->count += len;\r\ndone = 0;\r\nsrc = data;\r\nif ((partial + len) >= SHA256_BLOCK_SIZE) {\r\nif (partial) {\r\ndone = -partial;\r\nmemcpy(sctx->buf + partial, data,\r\ndone + SHA256_BLOCK_SIZE);\r\nsrc = sctx->buf;\r\n}\r\ndo {\r\nocteon_sha256_transform(src);\r\ndone += SHA256_BLOCK_SIZE;\r\nsrc = data + done;\r\n} while (done + SHA256_BLOCK_SIZE <= len);\r\npartial = 0;\r\n}\r\nmemcpy(sctx->buf + partial, src, len - done);\r\n}\r\nstatic int octeon_sha256_update(struct shash_desc *desc, const u8 *data,\r\nunsigned int len)\r\n{\r\nstruct sha256_state *sctx = shash_desc_ctx(desc);\r\nstruct octeon_cop2_state state;\r\nunsigned long flags;\r\nif ((sctx->count % SHA256_BLOCK_SIZE) + len < SHA256_BLOCK_SIZE)\r\nreturn crypto_sha256_update(desc, data, len);\r\nflags = octeon_crypto_enable(&state);\r\nocteon_sha256_store_hash(sctx);\r\n__octeon_sha256_update(sctx, data, len);\r\nocteon_sha256_read_hash(sctx);\r\nocteon_crypto_disable(&state, flags);\r\nreturn 0;\r\n}\r\nstatic int octeon_sha256_final(struct shash_desc *desc, u8 *out)\r\n{\r\nstruct sha256_state *sctx = shash_desc_ctx(desc);\r\nstatic const u8 padding[64] = { 0x80, };\r\nstruct octeon_cop2_state state;\r\n__be32 *dst = (__be32 *)out;\r\nunsigned int pad_len;\r\nunsigned long flags;\r\nunsigned int index;\r\n__be64 bits;\r\nint i;\r\nbits = cpu_to_be64(sctx->count << 3);\r\nindex = sctx->count & 0x3f;\r\npad_len = (index < 56) ? (56 - index) : ((64+56) - index);\r\nflags = octeon_crypto_enable(&state);\r\nocteon_sha256_store_hash(sctx);\r\n__octeon_sha256_update(sctx, padding, pad_len);\r\n__octeon_sha256_update(sctx, (const u8 *)&bits, sizeof(bits));\r\nocteon_sha256_read_hash(sctx);\r\nocteon_crypto_disable(&state, flags);\r\nfor (i = 0; i < 8; i++)\r\ndst[i] = cpu_to_be32(sctx->state[i]);\r\nmemset(sctx, 0, sizeof(*sctx));\r\nreturn 0;\r\n}\r\nstatic int octeon_sha224_final(struct shash_desc *desc, u8 *hash)\r\n{\r\nu8 D[SHA256_DIGEST_SIZE];\r\nocteon_sha256_final(desc, D);\r\nmemcpy(hash, D, SHA224_DIGEST_SIZE);\r\nmemzero_explicit(D, SHA256_DIGEST_SIZE);\r\nreturn 0;\r\n}\r\nstatic int octeon_sha256_export(struct shash_desc *desc, void *out)\r\n{\r\nstruct sha256_state *sctx = shash_desc_ctx(desc);\r\nmemcpy(out, sctx, sizeof(*sctx));\r\nreturn 0;\r\n}\r\nstatic int octeon_sha256_import(struct shash_desc *desc, const void *in)\r\n{\r\nstruct sha256_state *sctx = shash_desc_ctx(desc);\r\nmemcpy(sctx, in, sizeof(*sctx));\r\nreturn 0;\r\n}\r\nstatic int __init octeon_sha256_mod_init(void)\r\n{\r\nif (!octeon_has_crypto())\r\nreturn -ENOTSUPP;\r\nreturn crypto_register_shashes(octeon_sha256_algs,\r\nARRAY_SIZE(octeon_sha256_algs));\r\n}\r\nstatic void __exit octeon_sha256_mod_fini(void)\r\n{\r\ncrypto_unregister_shashes(octeon_sha256_algs,\r\nARRAY_SIZE(octeon_sha256_algs));\r\n}

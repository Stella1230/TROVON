static u8 jz4780_otg_phy_get_parent(struct clk_hw *hw)\r\n{\r\nreturn 0;\r\n}\r\nstatic int jz4780_otg_phy_set_parent(struct clk_hw *hw, u8 idx)\r\n{\r\nunsigned long flags;\r\nu32 usbpcr1;\r\nif (idx > 0)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&cgu->lock, flags);\r\nusbpcr1 = readl(cgu->base + CGU_REG_USBPCR1);\r\nusbpcr1 &= ~USBPCR1_REFCLKSEL_MASK;\r\nusbpcr1 |= USBPCR1_REFCLKSEL_CORE;\r\nwritel(usbpcr1, cgu->base + CGU_REG_USBPCR1);\r\nspin_unlock_irqrestore(&cgu->lock, flags);\r\nreturn 0;\r\n}\r\nstatic unsigned long jz4780_otg_phy_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nu32 usbpcr1;\r\nunsigned refclk_div;\r\nusbpcr1 = readl(cgu->base + CGU_REG_USBPCR1);\r\nrefclk_div = usbpcr1 & USBPCR1_REFCLKDIV_MASK;\r\nswitch (refclk_div) {\r\ncase USBPCR1_REFCLKDIV_12:\r\nreturn 12000000;\r\ncase USBPCR1_REFCLKDIV_24:\r\nreturn 24000000;\r\ncase USBPCR1_REFCLKDIV_48:\r\nreturn 48000000;\r\ncase USBPCR1_REFCLKDIV_19_2:\r\nreturn 19200000;\r\n}\r\nBUG();\r\nreturn parent_rate;\r\n}\r\nstatic long jz4780_otg_phy_round_rate(struct clk_hw *hw, unsigned long req_rate,\r\nunsigned long *parent_rate)\r\n{\r\nif (req_rate < 15600000)\r\nreturn 12000000;\r\nif (req_rate < 21600000)\r\nreturn 19200000;\r\nif (req_rate < 36000000)\r\nreturn 24000000;\r\nreturn 48000000;\r\n}\r\nstatic int jz4780_otg_phy_set_rate(struct clk_hw *hw, unsigned long req_rate,\r\nunsigned long parent_rate)\r\n{\r\nunsigned long flags;\r\nu32 usbpcr1, div_bits;\r\nswitch (req_rate) {\r\ncase 12000000:\r\ndiv_bits = USBPCR1_REFCLKDIV_12;\r\nbreak;\r\ncase 19200000:\r\ndiv_bits = USBPCR1_REFCLKDIV_19_2;\r\nbreak;\r\ncase 24000000:\r\ndiv_bits = USBPCR1_REFCLKDIV_24;\r\nbreak;\r\ncase 48000000:\r\ndiv_bits = USBPCR1_REFCLKDIV_48;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nspin_lock_irqsave(&cgu->lock, flags);\r\nusbpcr1 = readl(cgu->base + CGU_REG_USBPCR1);\r\nusbpcr1 &= ~USBPCR1_REFCLKDIV_MASK;\r\nusbpcr1 |= div_bits;\r\nwritel(usbpcr1, cgu->base + CGU_REG_USBPCR1);\r\nspin_unlock_irqrestore(&cgu->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void __init jz4780_cgu_init(struct device_node *np)\r\n{\r\nint retval;\r\ncgu = ingenic_cgu_new(jz4780_cgu_clocks,\r\nARRAY_SIZE(jz4780_cgu_clocks), np);\r\nif (!cgu) {\r\npr_err("%s: failed to initialise CGU\n", __func__);\r\nreturn;\r\n}\r\nretval = ingenic_cgu_register_clocks(cgu);\r\nif (retval) {\r\npr_err("%s: failed to register CGU Clocks\n", __func__);\r\nreturn;\r\n}\r\n}

static inline void vsp1_bru_write(struct vsp1_bru *bru, struct vsp1_dl_list *dl,\r\nu32 reg, u32 data)\r\n{\r\nvsp1_dl_list_write(dl, reg, data);\r\n}\r\nstatic int bru_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct vsp1_bru *bru =\r\ncontainer_of(ctrl->handler, struct vsp1_bru, ctrls);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_BG_COLOR:\r\nbru->bgcolor = ctrl->val;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bru_enum_mbus_code(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_mbus_code_enum *code)\r\n{\r\nstatic const unsigned int codes[] = {\r\nMEDIA_BUS_FMT_ARGB8888_1X32,\r\nMEDIA_BUS_FMT_AYUV8_1X32,\r\n};\r\nreturn vsp1_subdev_enum_mbus_code(subdev, cfg, code, codes,\r\nARRAY_SIZE(codes));\r\n}\r\nstatic int bru_enum_frame_size(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_frame_size_enum *fse)\r\n{\r\nif (fse->index)\r\nreturn -EINVAL;\r\nif (fse->code != MEDIA_BUS_FMT_ARGB8888_1X32 &&\r\nfse->code != MEDIA_BUS_FMT_AYUV8_1X32)\r\nreturn -EINVAL;\r\nfse->min_width = BRU_MIN_SIZE;\r\nfse->max_width = BRU_MAX_SIZE;\r\nfse->min_height = BRU_MIN_SIZE;\r\nfse->max_height = BRU_MAX_SIZE;\r\nreturn 0;\r\n}\r\nstatic struct v4l2_rect *bru_get_compose(struct vsp1_bru *bru,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nunsigned int pad)\r\n{\r\nreturn v4l2_subdev_get_try_compose(&bru->entity.subdev, cfg, pad);\r\n}\r\nstatic void bru_try_format(struct vsp1_bru *bru,\r\nstruct v4l2_subdev_pad_config *config,\r\nunsigned int pad, struct v4l2_mbus_framefmt *fmt)\r\n{\r\nstruct v4l2_mbus_framefmt *format;\r\nswitch (pad) {\r\ncase BRU_PAD_SINK(0):\r\nif (fmt->code != MEDIA_BUS_FMT_ARGB8888_1X32 &&\r\nfmt->code != MEDIA_BUS_FMT_AYUV8_1X32)\r\nfmt->code = MEDIA_BUS_FMT_AYUV8_1X32;\r\nbreak;\r\ndefault:\r\nformat = vsp1_entity_get_pad_format(&bru->entity, config,\r\nBRU_PAD_SINK(0));\r\nfmt->code = format->code;\r\nbreak;\r\n}\r\nfmt->width = clamp(fmt->width, BRU_MIN_SIZE, BRU_MAX_SIZE);\r\nfmt->height = clamp(fmt->height, BRU_MIN_SIZE, BRU_MAX_SIZE);\r\nfmt->field = V4L2_FIELD_NONE;\r\nfmt->colorspace = V4L2_COLORSPACE_SRGB;\r\n}\r\nstatic int bru_set_format(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct vsp1_bru *bru = to_bru(subdev);\r\nstruct v4l2_subdev_pad_config *config;\r\nstruct v4l2_mbus_framefmt *format;\r\nint ret = 0;\r\nmutex_lock(&bru->entity.lock);\r\nconfig = vsp1_entity_get_pad_config(&bru->entity, cfg, fmt->which);\r\nif (!config) {\r\nret = -EINVAL;\r\ngoto done;\r\n}\r\nbru_try_format(bru, config, fmt->pad, &fmt->format);\r\nformat = vsp1_entity_get_pad_format(&bru->entity, config, fmt->pad);\r\n*format = fmt->format;\r\nif (fmt->pad != bru->entity.source_pad) {\r\nstruct v4l2_rect *compose;\r\ncompose = bru_get_compose(bru, config, fmt->pad);\r\ncompose->left = 0;\r\ncompose->top = 0;\r\ncompose->width = format->width;\r\ncompose->height = format->height;\r\n}\r\nif (fmt->pad == BRU_PAD_SINK(0)) {\r\nunsigned int i;\r\nfor (i = 0; i <= bru->entity.source_pad; ++i) {\r\nformat = vsp1_entity_get_pad_format(&bru->entity,\r\nconfig, i);\r\nformat->code = fmt->format.code;\r\n}\r\n}\r\ndone:\r\nmutex_unlock(&bru->entity.lock);\r\nreturn ret;\r\n}\r\nstatic int bru_get_selection(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_selection *sel)\r\n{\r\nstruct vsp1_bru *bru = to_bru(subdev);\r\nstruct v4l2_subdev_pad_config *config;\r\nif (sel->pad == bru->entity.source_pad)\r\nreturn -EINVAL;\r\nswitch (sel->target) {\r\ncase V4L2_SEL_TGT_COMPOSE_BOUNDS:\r\nsel->r.left = 0;\r\nsel->r.top = 0;\r\nsel->r.width = BRU_MAX_SIZE;\r\nsel->r.height = BRU_MAX_SIZE;\r\nreturn 0;\r\ncase V4L2_SEL_TGT_COMPOSE:\r\nconfig = vsp1_entity_get_pad_config(&bru->entity, cfg,\r\nsel->which);\r\nif (!config)\r\nreturn -EINVAL;\r\nmutex_lock(&bru->entity.lock);\r\nsel->r = *bru_get_compose(bru, config, sel->pad);\r\nmutex_unlock(&bru->entity.lock);\r\nreturn 0;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int bru_set_selection(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_selection *sel)\r\n{\r\nstruct vsp1_bru *bru = to_bru(subdev);\r\nstruct v4l2_subdev_pad_config *config;\r\nstruct v4l2_mbus_framefmt *format;\r\nstruct v4l2_rect *compose;\r\nint ret = 0;\r\nif (sel->pad == bru->entity.source_pad)\r\nreturn -EINVAL;\r\nif (sel->target != V4L2_SEL_TGT_COMPOSE)\r\nreturn -EINVAL;\r\nmutex_lock(&bru->entity.lock);\r\nconfig = vsp1_entity_get_pad_config(&bru->entity, cfg, sel->which);\r\nif (!config) {\r\nret = -EINVAL;\r\ngoto done;\r\n}\r\nformat = vsp1_entity_get_pad_format(&bru->entity, config,\r\nbru->entity.source_pad);\r\nsel->r.left = clamp_t(unsigned int, sel->r.left, 0, format->width - 1);\r\nsel->r.top = clamp_t(unsigned int, sel->r.top, 0, format->height - 1);\r\nformat = vsp1_entity_get_pad_format(&bru->entity, config, sel->pad);\r\nsel->r.width = format->width;\r\nsel->r.height = format->height;\r\ncompose = bru_get_compose(bru, config, sel->pad);\r\n*compose = sel->r;\r\ndone:\r\nmutex_unlock(&bru->entity.lock);\r\nreturn ret;\r\n}\r\nstatic void bru_configure(struct vsp1_entity *entity,\r\nstruct vsp1_pipeline *pipe,\r\nstruct vsp1_dl_list *dl,\r\nenum vsp1_entity_params params)\r\n{\r\nstruct vsp1_bru *bru = to_bru(&entity->subdev);\r\nstruct v4l2_mbus_framefmt *format;\r\nunsigned int flags;\r\nunsigned int i;\r\nif (params != VSP1_ENTITY_PARAMS_INIT)\r\nreturn;\r\nformat = vsp1_entity_get_pad_format(&bru->entity, bru->entity.config,\r\nbru->entity.source_pad);\r\nflags = pipe->output ? pipe->output->format.flags : 0;\r\nvsp1_bru_write(bru, dl, VI6_BRU_INCTRL,\r\nflags & V4L2_PIX_FMT_FLAG_PREMUL_ALPHA ?\r\n0 : VI6_BRU_INCTRL_NRM);\r\nvsp1_bru_write(bru, dl, VI6_BRU_VIRRPF_SIZE,\r\n(format->width << VI6_BRU_VIRRPF_SIZE_HSIZE_SHIFT) |\r\n(format->height << VI6_BRU_VIRRPF_SIZE_VSIZE_SHIFT));\r\nvsp1_bru_write(bru, dl, VI6_BRU_VIRRPF_LOC, 0);\r\nvsp1_bru_write(bru, dl, VI6_BRU_VIRRPF_COL, bru->bgcolor |\r\n(0xff << VI6_BRU_VIRRPF_COL_A_SHIFT));\r\nvsp1_bru_write(bru, dl, VI6_BRU_ROP, VI6_BRU_ROP_DSTSEL_BRUIN(1) |\r\nVI6_BRU_ROP_CROP(VI6_ROP_NOP) |\r\nVI6_BRU_ROP_AROP(VI6_ROP_NOP));\r\nfor (i = 0; i < bru->entity.source_pad; ++i) {\r\nbool premultiplied = false;\r\nu32 ctrl = 0;\r\nif (bru->inputs[i].rpf) {\r\nctrl |= VI6_BRU_CTRL_RBC;\r\npremultiplied = bru->inputs[i].rpf->format.flags\r\n& V4L2_PIX_FMT_FLAG_PREMUL_ALPHA;\r\n} else {\r\nctrl |= VI6_BRU_CTRL_CROP(VI6_ROP_NOP)\r\n| VI6_BRU_CTRL_AROP(VI6_ROP_NOP);\r\n}\r\nif (i == 0)\r\nctrl |= VI6_BRU_CTRL_DSTSEL_VRPF;\r\nif (i != 1)\r\nctrl |= VI6_BRU_CTRL_SRCSEL_BRUIN(i);\r\nvsp1_bru_write(bru, dl, VI6_BRU_CTRL(i), ctrl);\r\nvsp1_bru_write(bru, dl, VI6_BRU_BLD(i),\r\nVI6_BRU_BLD_CCMDX_255_SRC_A |\r\n(premultiplied ? VI6_BRU_BLD_CCMDY_COEFY :\r\nVI6_BRU_BLD_CCMDY_SRC_A) |\r\nVI6_BRU_BLD_ACMDX_255_SRC_A |\r\nVI6_BRU_BLD_ACMDY_COEFY |\r\n(0xff << VI6_BRU_BLD_COEFY_SHIFT));\r\n}\r\n}\r\nstruct vsp1_bru *vsp1_bru_create(struct vsp1_device *vsp1)\r\n{\r\nstruct vsp1_bru *bru;\r\nint ret;\r\nbru = devm_kzalloc(vsp1->dev, sizeof(*bru), GFP_KERNEL);\r\nif (bru == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nbru->entity.ops = &bru_entity_ops;\r\nbru->entity.type = VSP1_ENTITY_BRU;\r\nret = vsp1_entity_init(vsp1, &bru->entity, "bru",\r\nvsp1->info->num_bru_inputs + 1, &bru_ops,\r\nMEDIA_ENT_F_PROC_VIDEO_COMPOSER);\r\nif (ret < 0)\r\nreturn ERR_PTR(ret);\r\nv4l2_ctrl_handler_init(&bru->ctrls, 1);\r\nv4l2_ctrl_new_std(&bru->ctrls, &bru_ctrl_ops, V4L2_CID_BG_COLOR,\r\n0, 0xffffff, 1, 0);\r\nbru->bgcolor = 0;\r\nbru->entity.subdev.ctrl_handler = &bru->ctrls;\r\nif (bru->ctrls.error) {\r\ndev_err(vsp1->dev, "bru: failed to initialize controls\n");\r\nret = bru->ctrls.error;\r\nvsp1_entity_destroy(&bru->entity);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn bru;\r\n}

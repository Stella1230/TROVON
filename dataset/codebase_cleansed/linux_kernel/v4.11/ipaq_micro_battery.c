static void micro_battery_work(struct work_struct *work)\r\n{\r\nstruct micro_battery *mb = container_of(work,\r\nstruct micro_battery, update.work);\r\nstruct ipaq_micro_msg msg_battery = {\r\n.id = MSG_BATTERY,\r\n};\r\nstruct ipaq_micro_msg msg_sensor = {\r\n.id = MSG_THERMAL_SENSOR,\r\n};\r\nipaq_micro_tx_msg_sync(mb->micro, &msg_battery);\r\nif (msg_battery.rx_len < 4)\r\npr_info("ERROR");\r\nmb->ac = msg_battery.rx_data[0];\r\nmb->chemistry = msg_battery.rx_data[1];\r\nmb->voltage = ((((unsigned short)msg_battery.rx_data[3] << 8) +\r\nmsg_battery.rx_data[2]) * 5000L) * 1000 / 1024;\r\nmb->flag = msg_battery.rx_data[4];\r\nif (msg_battery.rx_len == 9)\r\npr_debug("second battery ignored\n");\r\nipaq_micro_tx_msg_sync(mb->micro, &msg_sensor);\r\nmb->temperature = msg_sensor.rx_data[1] << 8 | msg_sensor.rx_data[0];\r\nqueue_delayed_work(mb->wq, &mb->update, msecs_to_jiffies(BATT_PERIOD));\r\n}\r\nstatic int get_capacity(struct power_supply *b)\r\n{\r\nstruct micro_battery *mb = dev_get_drvdata(b->dev.parent);\r\nswitch (mb->flag & 0x07) {\r\ncase MICRO_BATT_STATUS_HIGH:\r\nreturn 100;\r\nbreak;\r\ncase MICRO_BATT_STATUS_LOW:\r\nreturn 50;\r\nbreak;\r\ncase MICRO_BATT_STATUS_CRITICAL:\r\nreturn 5;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int get_status(struct power_supply *b)\r\n{\r\nstruct micro_battery *mb = dev_get_drvdata(b->dev.parent);\r\nif (mb->flag == MICRO_BATT_STATUS_UNKNOWN)\r\nreturn POWER_SUPPLY_STATUS_UNKNOWN;\r\nif (mb->flag & MICRO_BATT_STATUS_FULL)\r\nreturn POWER_SUPPLY_STATUS_FULL;\r\nif ((mb->flag & MICRO_BATT_STATUS_CHARGING) ||\r\n(mb->flag & MICRO_BATT_STATUS_CHARGEMAIN))\r\nreturn POWER_SUPPLY_STATUS_CHARGING;\r\nreturn POWER_SUPPLY_STATUS_DISCHARGING;\r\n}\r\nstatic int micro_batt_get_property(struct power_supply *b,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct micro_battery *mb = dev_get_drvdata(b->dev.parent);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nswitch (mb->chemistry) {\r\ncase MICRO_BATT_CHEM_NICD:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_NiCd;\r\nbreak;\r\ncase MICRO_BATT_CHEM_NIMH:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_NiMH;\r\nbreak;\r\ncase MICRO_BATT_CHEM_LION:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\r\nbreak;\r\ncase MICRO_BATT_CHEM_LIPOLY:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_LIPO;\r\nbreak;\r\ndefault:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_UNKNOWN;\r\nbreak;\r\n};\r\nbreak;\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nval->intval = get_status(b);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN:\r\nval->intval = 4700000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CAPACITY:\r\nval->intval = get_capacity(b);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP:\r\nval->intval = mb->temperature;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nval->intval = mb->voltage;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n};\r\nreturn 0;\r\n}\r\nstatic int micro_ac_get_property(struct power_supply *b,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct micro_battery *mb = dev_get_drvdata(b->dev.parent);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = mb->ac;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n};\r\nreturn 0;\r\n}\r\nstatic int micro_batt_probe(struct platform_device *pdev)\r\n{\r\nstruct micro_battery *mb;\r\nint ret;\r\nmb = devm_kzalloc(&pdev->dev, sizeof(*mb), GFP_KERNEL);\r\nif (!mb)\r\nreturn -ENOMEM;\r\nmb->micro = dev_get_drvdata(pdev->dev.parent);\r\nmb->wq = alloc_workqueue("ipaq-battery-wq", WQ_MEM_RECLAIM, 0);\r\nif (!mb->wq)\r\nreturn -ENOMEM;\r\nINIT_DELAYED_WORK(&mb->update, micro_battery_work);\r\nplatform_set_drvdata(pdev, mb);\r\nqueue_delayed_work(mb->wq, &mb->update, 1);\r\nmicro_batt_power = power_supply_register(&pdev->dev,\r\n&micro_batt_power_desc, NULL);\r\nif (IS_ERR(micro_batt_power)) {\r\nret = PTR_ERR(micro_batt_power);\r\ngoto batt_err;\r\n}\r\nmicro_ac_power = power_supply_register(&pdev->dev,\r\n&micro_ac_power_desc, NULL);\r\nif (IS_ERR(micro_ac_power)) {\r\nret = PTR_ERR(micro_ac_power);\r\ngoto ac_err;\r\n}\r\ndev_info(&pdev->dev, "iPAQ micro battery driver\n");\r\nreturn 0;\r\nac_err:\r\npower_supply_unregister(micro_batt_power);\r\nbatt_err:\r\ncancel_delayed_work_sync(&mb->update);\r\ndestroy_workqueue(mb->wq);\r\nreturn ret;\r\n}\r\nstatic int micro_batt_remove(struct platform_device *pdev)\r\n{\r\nstruct micro_battery *mb = platform_get_drvdata(pdev);\r\npower_supply_unregister(micro_ac_power);\r\npower_supply_unregister(micro_batt_power);\r\ncancel_delayed_work_sync(&mb->update);\r\ndestroy_workqueue(mb->wq);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused micro_batt_suspend(struct device *dev)\r\n{\r\nstruct micro_battery *mb = dev_get_drvdata(dev);\r\ncancel_delayed_work_sync(&mb->update);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused micro_batt_resume(struct device *dev)\r\n{\r\nstruct micro_battery *mb = dev_get_drvdata(dev);\r\nqueue_delayed_work(mb->wq, &mb->update, msecs_to_jiffies(BATT_PERIOD));\r\nreturn 0;\r\n}

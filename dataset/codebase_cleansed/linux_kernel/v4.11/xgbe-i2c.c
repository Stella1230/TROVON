static int xgbe_i2c_abort(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int wait = XGBE_ABORT_COUNT;\r\nXI2C_IOWRITE_BITS(pdata, IC_ENABLE, EN, 1);\r\nXI2C_IOWRITE_BITS(pdata, IC_ENABLE, ABORT, 1);\r\nwhile (wait--) {\r\nif (!XI2C_IOREAD_BITS(pdata, IC_ENABLE, ABORT))\r\nreturn 0;\r\nusleep_range(500, 600);\r\n}\r\nreturn -EBUSY;\r\n}\r\nstatic int xgbe_i2c_set_enable(struct xgbe_prv_data *pdata, bool enable)\r\n{\r\nunsigned int wait = XGBE_DISABLE_COUNT;\r\nunsigned int mode = enable ? 1 : 0;\r\nwhile (wait--) {\r\nXI2C_IOWRITE_BITS(pdata, IC_ENABLE, EN, mode);\r\nif (XI2C_IOREAD_BITS(pdata, IC_ENABLE_STATUS, EN) == mode)\r\nreturn 0;\r\nusleep_range(100, 110);\r\n}\r\nreturn -EBUSY;\r\n}\r\nstatic int xgbe_i2c_disable(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int ret;\r\nret = xgbe_i2c_set_enable(pdata, false);\r\nif (ret) {\r\nret = xgbe_i2c_abort(pdata);\r\nif (ret)\r\nreturn ret;\r\nret = xgbe_i2c_set_enable(pdata, false);\r\n}\r\nreturn ret;\r\n}\r\nstatic int xgbe_i2c_enable(struct xgbe_prv_data *pdata)\r\n{\r\nreturn xgbe_i2c_set_enable(pdata, true);\r\n}\r\nstatic void xgbe_i2c_clear_all_interrupts(struct xgbe_prv_data *pdata)\r\n{\r\nXI2C_IOREAD(pdata, IC_CLR_INTR);\r\n}\r\nstatic void xgbe_i2c_disable_interrupts(struct xgbe_prv_data *pdata)\r\n{\r\nXI2C_IOWRITE(pdata, IC_INTR_MASK, 0);\r\n}\r\nstatic void xgbe_i2c_enable_interrupts(struct xgbe_prv_data *pdata)\r\n{\r\nXI2C_IOWRITE(pdata, IC_INTR_MASK, XGBE_DEFAULT_INT_MASK);\r\n}\r\nstatic void xgbe_i2c_write(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_i2c_op_state *state = &pdata->i2c.op_state;\r\nunsigned int tx_slots;\r\nunsigned int cmd;\r\ntx_slots = pdata->i2c.tx_fifo_size - XI2C_IOREAD(pdata, IC_TXFLR);\r\nwhile (tx_slots && state->tx_len) {\r\nif (state->op->cmd == XGBE_I2C_CMD_READ)\r\ncmd = XGBE_I2C_READ;\r\nelse\r\ncmd = *state->tx_buf++;\r\nif (state->tx_len == 1)\r\nXI2C_SET_BITS(cmd, IC_DATA_CMD, STOP, 1);\r\nXI2C_IOWRITE(pdata, IC_DATA_CMD, cmd);\r\ntx_slots--;\r\nstate->tx_len--;\r\n}\r\nif (!state->tx_len)\r\nXI2C_IOWRITE_BITS(pdata, IC_INTR_MASK, TX_EMPTY, 0);\r\n}\r\nstatic void xgbe_i2c_read(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_i2c_op_state *state = &pdata->i2c.op_state;\r\nunsigned int rx_slots;\r\nif (state->op->cmd != XGBE_I2C_CMD_READ)\r\nreturn;\r\nrx_slots = XI2C_IOREAD(pdata, IC_RXFLR);\r\nwhile (rx_slots && state->rx_len) {\r\n*state->rx_buf++ = XI2C_IOREAD(pdata, IC_DATA_CMD);\r\nstate->rx_len--;\r\nrx_slots--;\r\n}\r\n}\r\nstatic void xgbe_i2c_clear_isr_interrupts(struct xgbe_prv_data *pdata,\r\nunsigned int isr)\r\n{\r\nstruct xgbe_i2c_op_state *state = &pdata->i2c.op_state;\r\nif (isr & XGBE_INTR_TX_ABRT) {\r\nstate->tx_abort_source = XI2C_IOREAD(pdata, IC_TX_ABRT_SOURCE);\r\nXI2C_IOREAD(pdata, IC_CLR_TX_ABRT);\r\n}\r\nif (isr & XGBE_INTR_STOP_DET)\r\nXI2C_IOREAD(pdata, IC_CLR_STOP_DET);\r\n}\r\nstatic irqreturn_t xgbe_i2c_isr(int irq, void *data)\r\n{\r\nstruct xgbe_prv_data *pdata = (struct xgbe_prv_data *)data;\r\nstruct xgbe_i2c_op_state *state = &pdata->i2c.op_state;\r\nunsigned int isr;\r\nisr = XI2C_IOREAD(pdata, IC_RAW_INTR_STAT);\r\nnetif_dbg(pdata, intr, pdata->netdev,\r\n"I2C interrupt received: status=%#010x\n", isr);\r\nxgbe_i2c_clear_isr_interrupts(pdata, isr);\r\nif (isr & XGBE_INTR_TX_ABRT) {\r\nnetif_dbg(pdata, link, pdata->netdev,\r\n"I2C TX_ABRT received (%#010x) for target %#04x\n",\r\nstate->tx_abort_source, state->op->target);\r\nxgbe_i2c_disable_interrupts(pdata);\r\nstate->ret = -EIO;\r\ngoto out;\r\n}\r\nxgbe_i2c_read(pdata);\r\nxgbe_i2c_write(pdata);\r\nout:\r\nif (state->ret || XI2C_GET_BITS(isr, IC_RAW_INTR_STAT, STOP_DET))\r\ncomplete(&pdata->i2c_complete);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void xgbe_i2c_set_mode(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int reg;\r\nreg = XI2C_IOREAD(pdata, IC_CON);\r\nXI2C_SET_BITS(reg, IC_CON, MASTER_MODE, 1);\r\nXI2C_SET_BITS(reg, IC_CON, SLAVE_DISABLE, 1);\r\nXI2C_SET_BITS(reg, IC_CON, RESTART_EN, 1);\r\nXI2C_SET_BITS(reg, IC_CON, SPEED, XGBE_STD_SPEED);\r\nXI2C_SET_BITS(reg, IC_CON, RX_FIFO_FULL_HOLD, 1);\r\nXI2C_IOWRITE(pdata, IC_CON, reg);\r\n}\r\nstatic void xgbe_i2c_get_features(struct xgbe_prv_data *pdata)\r\n{\r\nstruct xgbe_i2c *i2c = &pdata->i2c;\r\nunsigned int reg;\r\nreg = XI2C_IOREAD(pdata, IC_COMP_PARAM_1);\r\ni2c->max_speed_mode = XI2C_GET_BITS(reg, IC_COMP_PARAM_1,\r\nMAX_SPEED_MODE);\r\ni2c->rx_fifo_size = XI2C_GET_BITS(reg, IC_COMP_PARAM_1,\r\nRX_BUFFER_DEPTH);\r\ni2c->tx_fifo_size = XI2C_GET_BITS(reg, IC_COMP_PARAM_1,\r\nTX_BUFFER_DEPTH);\r\nif (netif_msg_probe(pdata))\r\ndev_dbg(pdata->dev, "I2C features: %s=%u, %s=%u, %s=%u\n",\r\n"MAX_SPEED_MODE", i2c->max_speed_mode,\r\n"RX_BUFFER_DEPTH", i2c->rx_fifo_size,\r\n"TX_BUFFER_DEPTH", i2c->tx_fifo_size);\r\n}\r\nstatic void xgbe_i2c_set_target(struct xgbe_prv_data *pdata, unsigned int addr)\r\n{\r\nXI2C_IOWRITE(pdata, IC_TAR, addr);\r\n}\r\nstatic irqreturn_t xgbe_i2c_combined_isr(int irq, struct xgbe_prv_data *pdata)\r\n{\r\nif (!XI2C_IOREAD(pdata, IC_RAW_INTR_STAT))\r\nreturn IRQ_HANDLED;\r\nreturn xgbe_i2c_isr(irq, pdata);\r\n}\r\nstatic int xgbe_i2c_xfer(struct xgbe_prv_data *pdata, struct xgbe_i2c_op *op)\r\n{\r\nstruct xgbe_i2c_op_state *state = &pdata->i2c.op_state;\r\nint ret;\r\nmutex_lock(&pdata->i2c_mutex);\r\nreinit_completion(&pdata->i2c_complete);\r\nret = xgbe_i2c_disable(pdata);\r\nif (ret) {\r\nnetdev_err(pdata->netdev, "failed to disable i2c master\n");\r\ngoto unlock;\r\n}\r\nxgbe_i2c_set_target(pdata, op->target);\r\nmemset(state, 0, sizeof(*state));\r\nstate->op = op;\r\nstate->tx_len = op->len;\r\nstate->tx_buf = op->buf;\r\nstate->rx_len = op->len;\r\nstate->rx_buf = op->buf;\r\nxgbe_i2c_clear_all_interrupts(pdata);\r\nret = xgbe_i2c_enable(pdata);\r\nif (ret) {\r\nnetdev_err(pdata->netdev, "failed to enable i2c master\n");\r\ngoto unlock;\r\n}\r\nxgbe_i2c_enable_interrupts(pdata);\r\nif (!wait_for_completion_timeout(&pdata->i2c_complete, HZ)) {\r\nnetdev_err(pdata->netdev, "i2c operation timed out\n");\r\nret = -ETIMEDOUT;\r\ngoto disable;\r\n}\r\nret = state->ret;\r\nif (ret) {\r\nif (state->tx_abort_source & IC_TX_ABRT_7B_ADDR_NOACK)\r\nret = -ENOTCONN;\r\nelse if (state->tx_abort_source & IC_TX_ABRT_ARB_LOST)\r\nret = -EAGAIN;\r\n}\r\ndisable:\r\nxgbe_i2c_disable_interrupts(pdata);\r\nxgbe_i2c_disable(pdata);\r\nunlock:\r\nmutex_unlock(&pdata->i2c_mutex);\r\nreturn ret;\r\n}\r\nstatic void xgbe_i2c_stop(struct xgbe_prv_data *pdata)\r\n{\r\nif (!pdata->i2c.started)\r\nreturn;\r\nnetif_dbg(pdata, link, pdata->netdev, "stopping I2C\n");\r\npdata->i2c.started = 0;\r\nxgbe_i2c_disable_interrupts(pdata);\r\nxgbe_i2c_disable(pdata);\r\nxgbe_i2c_clear_all_interrupts(pdata);\r\nif (pdata->dev_irq != pdata->i2c_irq)\r\ndevm_free_irq(pdata->dev, pdata->i2c_irq, pdata);\r\n}\r\nstatic int xgbe_i2c_start(struct xgbe_prv_data *pdata)\r\n{\r\nint ret;\r\nif (pdata->i2c.started)\r\nreturn 0;\r\nnetif_dbg(pdata, link, pdata->netdev, "starting I2C\n");\r\nif (pdata->dev_irq != pdata->i2c_irq) {\r\nret = devm_request_irq(pdata->dev, pdata->i2c_irq,\r\nxgbe_i2c_isr, 0, pdata->i2c_name,\r\npdata);\r\nif (ret) {\r\nnetdev_err(pdata->netdev, "i2c irq request failed\n");\r\nreturn ret;\r\n}\r\n}\r\npdata->i2c.started = 1;\r\nreturn 0;\r\n}\r\nstatic int xgbe_i2c_init(struct xgbe_prv_data *pdata)\r\n{\r\nint ret;\r\nxgbe_i2c_disable_interrupts(pdata);\r\nret = xgbe_i2c_disable(pdata);\r\nif (ret) {\r\ndev_err(pdata->dev, "failed to disable i2c master\n");\r\nreturn ret;\r\n}\r\nxgbe_i2c_get_features(pdata);\r\nxgbe_i2c_set_mode(pdata);\r\nxgbe_i2c_clear_all_interrupts(pdata);\r\nreturn 0;\r\n}\r\nvoid xgbe_init_function_ptrs_i2c(struct xgbe_i2c_if *i2c_if)\r\n{\r\ni2c_if->i2c_init = xgbe_i2c_init;\r\ni2c_if->i2c_start = xgbe_i2c_start;\r\ni2c_if->i2c_stop = xgbe_i2c_stop;\r\ni2c_if->i2c_xfer = xgbe_i2c_xfer;\r\ni2c_if->i2c_isr = xgbe_i2c_combined_isr;\r\n}

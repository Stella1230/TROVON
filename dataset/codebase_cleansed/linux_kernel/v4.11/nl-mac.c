static int nla_put_hwaddr(struct sk_buff *msg, int type, __le64 hwaddr,\r\nint padattr)\r\n{\r\nreturn nla_put_u64_64bit(msg, type, swab64((__force u64)hwaddr),\r\npadattr);\r\n}\r\nstatic __le64 nla_get_hwaddr(const struct nlattr *nla)\r\n{\r\nreturn ieee802154_devaddr_from_raw(nla_data(nla));\r\n}\r\nstatic int nla_put_shortaddr(struct sk_buff *msg, int type, __le16 addr)\r\n{\r\nreturn nla_put_u16(msg, type, le16_to_cpu(addr));\r\n}\r\nstatic __le16 nla_get_shortaddr(const struct nlattr *nla)\r\n{\r\nreturn cpu_to_le16(nla_get_u16(nla));\r\n}\r\nstatic int ieee802154_nl_start_confirm(struct net_device *dev, u8 status)\r\n{\r\nstruct sk_buff *msg;\r\npr_debug("%s\n", __func__);\r\nmsg = ieee802154_nl_create(0, IEEE802154_START_CONF);\r\nif (!msg)\r\nreturn -ENOBUFS;\r\nif (nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name) ||\r\nnla_put_u32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex) ||\r\nnla_put(msg, IEEE802154_ATTR_HW_ADDR, IEEE802154_ADDR_LEN,\r\ndev->dev_addr) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_STATUS, status))\r\ngoto nla_put_failure;\r\nreturn ieee802154_nl_mcast(msg, IEEE802154_COORD_MCGRP);\r\nnla_put_failure:\r\nnlmsg_free(msg);\r\nreturn -ENOBUFS;\r\n}\r\nstatic int ieee802154_nl_fill_iface(struct sk_buff *msg, u32 portid,\r\nu32 seq, int flags, struct net_device *dev)\r\n{\r\nvoid *hdr;\r\nstruct wpan_phy *phy;\r\nstruct ieee802154_mlme_ops *ops;\r\n__le16 short_addr, pan_id;\r\npr_debug("%s\n", __func__);\r\nhdr = genlmsg_put(msg, 0, seq, &nl802154_family, flags,\r\nIEEE802154_LIST_IFACE);\r\nif (!hdr)\r\ngoto out;\r\nops = ieee802154_mlme_ops(dev);\r\nphy = dev->ieee802154_ptr->wpan_phy;\r\nBUG_ON(!phy);\r\nget_device(&phy->dev);\r\nrtnl_lock();\r\nshort_addr = dev->ieee802154_ptr->short_addr;\r\npan_id = dev->ieee802154_ptr->pan_id;\r\nrtnl_unlock();\r\nif (nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name) ||\r\nnla_put_string(msg, IEEE802154_ATTR_PHY_NAME, wpan_phy_name(phy)) ||\r\nnla_put_u32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex) ||\r\nnla_put(msg, IEEE802154_ATTR_HW_ADDR, IEEE802154_ADDR_LEN,\r\ndev->dev_addr) ||\r\nnla_put_shortaddr(msg, IEEE802154_ATTR_SHORT_ADDR, short_addr) ||\r\nnla_put_shortaddr(msg, IEEE802154_ATTR_PAN_ID, pan_id))\r\ngoto nla_put_failure;\r\nif (ops->get_mac_params) {\r\nstruct ieee802154_mac_params params;\r\nrtnl_lock();\r\nops->get_mac_params(dev, &params);\r\nrtnl_unlock();\r\nif (nla_put_s8(msg, IEEE802154_ATTR_TXPOWER,\r\nparams.transmit_power / 100) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_LBT_ENABLED, params.lbt) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_CCA_MODE,\r\nparams.cca.mode) ||\r\nnla_put_s32(msg, IEEE802154_ATTR_CCA_ED_LEVEL,\r\nparams.cca_ed_level / 100) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_CSMA_RETRIES,\r\nparams.csma_retries) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_CSMA_MIN_BE,\r\nparams.min_be) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_CSMA_MAX_BE,\r\nparams.max_be) ||\r\nnla_put_s8(msg, IEEE802154_ATTR_FRAME_RETRIES,\r\nparams.frame_retries))\r\ngoto nla_put_failure;\r\n}\r\nwpan_phy_put(phy);\r\ngenlmsg_end(msg, hdr);\r\nreturn 0;\r\nnla_put_failure:\r\nwpan_phy_put(phy);\r\ngenlmsg_cancel(msg, hdr);\r\nout:\r\nreturn -EMSGSIZE;\r\n}\r\nstatic struct net_device *ieee802154_nl_get_dev(struct genl_info *info)\r\n{\r\nstruct net_device *dev;\r\nif (info->attrs[IEEE802154_ATTR_DEV_NAME]) {\r\nchar name[IFNAMSIZ + 1];\r\nnla_strlcpy(name, info->attrs[IEEE802154_ATTR_DEV_NAME],\r\nsizeof(name));\r\ndev = dev_get_by_name(&init_net, name);\r\n} else if (info->attrs[IEEE802154_ATTR_DEV_INDEX]) {\r\ndev = dev_get_by_index(&init_net,\r\nnla_get_u32(info->attrs[IEEE802154_ATTR_DEV_INDEX]));\r\n} else {\r\nreturn NULL;\r\n}\r\nif (!dev)\r\nreturn NULL;\r\nif (dev->type != ARPHRD_IEEE802154) {\r\ndev_put(dev);\r\nreturn NULL;\r\n}\r\nreturn dev;\r\n}\r\nint ieee802154_associate_req(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net_device *dev;\r\nstruct ieee802154_addr addr;\r\nu8 page;\r\nint ret = -EOPNOTSUPP;\r\nif (!info->attrs[IEEE802154_ATTR_CHANNEL] ||\r\n!info->attrs[IEEE802154_ATTR_COORD_PAN_ID] ||\r\n(!info->attrs[IEEE802154_ATTR_COORD_HW_ADDR] &&\r\n!info->attrs[IEEE802154_ATTR_COORD_SHORT_ADDR]) ||\r\n!info->attrs[IEEE802154_ATTR_CAPABILITY])\r\nreturn -EINVAL;\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nif (!ieee802154_mlme_ops(dev)->assoc_req)\r\ngoto out;\r\nif (info->attrs[IEEE802154_ATTR_COORD_HW_ADDR]) {\r\naddr.mode = IEEE802154_ADDR_LONG;\r\naddr.extended_addr = nla_get_hwaddr(\r\ninfo->attrs[IEEE802154_ATTR_COORD_HW_ADDR]);\r\n} else {\r\naddr.mode = IEEE802154_ADDR_SHORT;\r\naddr.short_addr = nla_get_shortaddr(\r\ninfo->attrs[IEEE802154_ATTR_COORD_SHORT_ADDR]);\r\n}\r\naddr.pan_id = nla_get_shortaddr(\r\ninfo->attrs[IEEE802154_ATTR_COORD_PAN_ID]);\r\nif (info->attrs[IEEE802154_ATTR_PAGE])\r\npage = nla_get_u8(info->attrs[IEEE802154_ATTR_PAGE]);\r\nelse\r\npage = 0;\r\nret = ieee802154_mlme_ops(dev)->assoc_req(dev, &addr,\r\nnla_get_u8(info->attrs[IEEE802154_ATTR_CHANNEL]),\r\npage,\r\nnla_get_u8(info->attrs[IEEE802154_ATTR_CAPABILITY]));\r\nout:\r\ndev_put(dev);\r\nreturn ret;\r\n}\r\nint ieee802154_associate_resp(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net_device *dev;\r\nstruct ieee802154_addr addr;\r\nint ret = -EOPNOTSUPP;\r\nif (!info->attrs[IEEE802154_ATTR_STATUS] ||\r\n!info->attrs[IEEE802154_ATTR_DEST_HW_ADDR] ||\r\n!info->attrs[IEEE802154_ATTR_DEST_SHORT_ADDR])\r\nreturn -EINVAL;\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nif (!ieee802154_mlme_ops(dev)->assoc_resp)\r\ngoto out;\r\naddr.mode = IEEE802154_ADDR_LONG;\r\naddr.extended_addr = nla_get_hwaddr(\r\ninfo->attrs[IEEE802154_ATTR_DEST_HW_ADDR]);\r\nrtnl_lock();\r\naddr.pan_id = dev->ieee802154_ptr->pan_id;\r\nrtnl_unlock();\r\nret = ieee802154_mlme_ops(dev)->assoc_resp(dev, &addr,\r\nnla_get_shortaddr(info->attrs[IEEE802154_ATTR_DEST_SHORT_ADDR]),\r\nnla_get_u8(info->attrs[IEEE802154_ATTR_STATUS]));\r\nout:\r\ndev_put(dev);\r\nreturn ret;\r\n}\r\nint ieee802154_disassociate_req(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net_device *dev;\r\nstruct ieee802154_addr addr;\r\nint ret = -EOPNOTSUPP;\r\nif ((!info->attrs[IEEE802154_ATTR_DEST_HW_ADDR] &&\r\n!info->attrs[IEEE802154_ATTR_DEST_SHORT_ADDR]) ||\r\n!info->attrs[IEEE802154_ATTR_REASON])\r\nreturn -EINVAL;\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nif (!ieee802154_mlme_ops(dev)->disassoc_req)\r\ngoto out;\r\nif (info->attrs[IEEE802154_ATTR_DEST_HW_ADDR]) {\r\naddr.mode = IEEE802154_ADDR_LONG;\r\naddr.extended_addr = nla_get_hwaddr(\r\ninfo->attrs[IEEE802154_ATTR_DEST_HW_ADDR]);\r\n} else {\r\naddr.mode = IEEE802154_ADDR_SHORT;\r\naddr.short_addr = nla_get_shortaddr(\r\ninfo->attrs[IEEE802154_ATTR_DEST_SHORT_ADDR]);\r\n}\r\nrtnl_lock();\r\naddr.pan_id = dev->ieee802154_ptr->pan_id;\r\nrtnl_unlock();\r\nret = ieee802154_mlme_ops(dev)->disassoc_req(dev, &addr,\r\nnla_get_u8(info->attrs[IEEE802154_ATTR_REASON]));\r\nout:\r\ndev_put(dev);\r\nreturn ret;\r\n}\r\nint ieee802154_start_req(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net_device *dev;\r\nstruct ieee802154_addr addr;\r\nu8 channel, bcn_ord, sf_ord;\r\nu8 page;\r\nint pan_coord, blx, coord_realign;\r\nint ret = -EBUSY;\r\nif (!info->attrs[IEEE802154_ATTR_COORD_PAN_ID] ||\r\n!info->attrs[IEEE802154_ATTR_COORD_SHORT_ADDR] ||\r\n!info->attrs[IEEE802154_ATTR_CHANNEL] ||\r\n!info->attrs[IEEE802154_ATTR_BCN_ORD] ||\r\n!info->attrs[IEEE802154_ATTR_SF_ORD] ||\r\n!info->attrs[IEEE802154_ATTR_PAN_COORD] ||\r\n!info->attrs[IEEE802154_ATTR_BAT_EXT] ||\r\n!info->attrs[IEEE802154_ATTR_COORD_REALIGN]\r\n)\r\nreturn -EINVAL;\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nif (netif_running(dev))\r\ngoto out;\r\nif (!ieee802154_mlme_ops(dev)->start_req) {\r\nret = -EOPNOTSUPP;\r\ngoto out;\r\n}\r\naddr.mode = IEEE802154_ADDR_SHORT;\r\naddr.short_addr = nla_get_shortaddr(\r\ninfo->attrs[IEEE802154_ATTR_COORD_SHORT_ADDR]);\r\naddr.pan_id = nla_get_shortaddr(\r\ninfo->attrs[IEEE802154_ATTR_COORD_PAN_ID]);\r\nchannel = nla_get_u8(info->attrs[IEEE802154_ATTR_CHANNEL]);\r\nbcn_ord = nla_get_u8(info->attrs[IEEE802154_ATTR_BCN_ORD]);\r\nsf_ord = nla_get_u8(info->attrs[IEEE802154_ATTR_SF_ORD]);\r\npan_coord = nla_get_u8(info->attrs[IEEE802154_ATTR_PAN_COORD]);\r\nblx = nla_get_u8(info->attrs[IEEE802154_ATTR_BAT_EXT]);\r\ncoord_realign = nla_get_u8(info->attrs[IEEE802154_ATTR_COORD_REALIGN]);\r\nif (info->attrs[IEEE802154_ATTR_PAGE])\r\npage = nla_get_u8(info->attrs[IEEE802154_ATTR_PAGE]);\r\nelse\r\npage = 0;\r\nif (addr.short_addr == cpu_to_le16(IEEE802154_ADDR_BROADCAST)) {\r\nieee802154_nl_start_confirm(dev, IEEE802154_NO_SHORT_ADDRESS);\r\ndev_put(dev);\r\nreturn -EINVAL;\r\n}\r\nrtnl_lock();\r\nret = ieee802154_mlme_ops(dev)->start_req(dev, &addr, channel, page,\r\nbcn_ord, sf_ord, pan_coord, blx, coord_realign);\r\nrtnl_unlock();\r\nieee802154_nl_start_confirm(dev, IEEE802154_SUCCESS);\r\nout:\r\ndev_put(dev);\r\nreturn ret;\r\n}\r\nint ieee802154_scan_req(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net_device *dev;\r\nint ret = -EOPNOTSUPP;\r\nu8 type;\r\nu32 channels;\r\nu8 duration;\r\nu8 page;\r\nif (!info->attrs[IEEE802154_ATTR_SCAN_TYPE] ||\r\n!info->attrs[IEEE802154_ATTR_CHANNELS] ||\r\n!info->attrs[IEEE802154_ATTR_DURATION])\r\nreturn -EINVAL;\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nif (!ieee802154_mlme_ops(dev)->scan_req)\r\ngoto out;\r\ntype = nla_get_u8(info->attrs[IEEE802154_ATTR_SCAN_TYPE]);\r\nchannels = nla_get_u32(info->attrs[IEEE802154_ATTR_CHANNELS]);\r\nduration = nla_get_u8(info->attrs[IEEE802154_ATTR_DURATION]);\r\nif (info->attrs[IEEE802154_ATTR_PAGE])\r\npage = nla_get_u8(info->attrs[IEEE802154_ATTR_PAGE]);\r\nelse\r\npage = 0;\r\nret = ieee802154_mlme_ops(dev)->scan_req(dev, type, channels,\r\npage, duration);\r\nout:\r\ndev_put(dev);\r\nreturn ret;\r\n}\r\nint ieee802154_list_iface(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct sk_buff *msg;\r\nstruct net_device *dev = NULL;\r\nint rc = -ENOBUFS;\r\npr_debug("%s\n", __func__);\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nmsg = nlmsg_new(NLMSG_DEFAULT_SIZE, GFP_KERNEL);\r\nif (!msg)\r\ngoto out_dev;\r\nrc = ieee802154_nl_fill_iface(msg, info->snd_portid, info->snd_seq,\r\n0, dev);\r\nif (rc < 0)\r\ngoto out_free;\r\ndev_put(dev);\r\nreturn genlmsg_reply(msg, info);\r\nout_free:\r\nnlmsg_free(msg);\r\nout_dev:\r\ndev_put(dev);\r\nreturn rc;\r\n}\r\nint ieee802154_dump_iface(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nstruct net *net = sock_net(skb->sk);\r\nstruct net_device *dev;\r\nint idx;\r\nint s_idx = cb->args[0];\r\npr_debug("%s\n", __func__);\r\nidx = 0;\r\nfor_each_netdev(net, dev) {\r\nif (idx < s_idx || dev->type != ARPHRD_IEEE802154)\r\ngoto cont;\r\nif (ieee802154_nl_fill_iface(skb, NETLINK_CB(cb->skb).portid,\r\ncb->nlh->nlmsg_seq,\r\nNLM_F_MULTI, dev) < 0)\r\nbreak;\r\ncont:\r\nidx++;\r\n}\r\ncb->args[0] = idx;\r\nreturn skb->len;\r\n}\r\nint ieee802154_set_macparams(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net_device *dev = NULL;\r\nstruct ieee802154_mlme_ops *ops;\r\nstruct ieee802154_mac_params params;\r\nstruct wpan_phy *phy;\r\nint rc = -EINVAL;\r\npr_debug("%s\n", __func__);\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nops = ieee802154_mlme_ops(dev);\r\nif (!ops->get_mac_params || !ops->set_mac_params) {\r\nrc = -EOPNOTSUPP;\r\ngoto out;\r\n}\r\nif (netif_running(dev)) {\r\nrc = -EBUSY;\r\ngoto out;\r\n}\r\nif (!info->attrs[IEEE802154_ATTR_LBT_ENABLED] &&\r\n!info->attrs[IEEE802154_ATTR_CCA_MODE] &&\r\n!info->attrs[IEEE802154_ATTR_CCA_ED_LEVEL] &&\r\n!info->attrs[IEEE802154_ATTR_CSMA_RETRIES] &&\r\n!info->attrs[IEEE802154_ATTR_CSMA_MIN_BE] &&\r\n!info->attrs[IEEE802154_ATTR_CSMA_MAX_BE] &&\r\n!info->attrs[IEEE802154_ATTR_FRAME_RETRIES])\r\ngoto out;\r\nphy = dev->ieee802154_ptr->wpan_phy;\r\nget_device(&phy->dev);\r\nrtnl_lock();\r\nops->get_mac_params(dev, &params);\r\nif (info->attrs[IEEE802154_ATTR_TXPOWER])\r\nparams.transmit_power = nla_get_s8(info->attrs[IEEE802154_ATTR_TXPOWER]) * 100;\r\nif (info->attrs[IEEE802154_ATTR_LBT_ENABLED])\r\nparams.lbt = nla_get_u8(info->attrs[IEEE802154_ATTR_LBT_ENABLED]);\r\nif (info->attrs[IEEE802154_ATTR_CCA_MODE])\r\nparams.cca.mode = nla_get_u8(info->attrs[IEEE802154_ATTR_CCA_MODE]);\r\nif (info->attrs[IEEE802154_ATTR_CCA_ED_LEVEL])\r\nparams.cca_ed_level = nla_get_s32(info->attrs[IEEE802154_ATTR_CCA_ED_LEVEL]) * 100;\r\nif (info->attrs[IEEE802154_ATTR_CSMA_RETRIES])\r\nparams.csma_retries = nla_get_u8(info->attrs[IEEE802154_ATTR_CSMA_RETRIES]);\r\nif (info->attrs[IEEE802154_ATTR_CSMA_MIN_BE])\r\nparams.min_be = nla_get_u8(info->attrs[IEEE802154_ATTR_CSMA_MIN_BE]);\r\nif (info->attrs[IEEE802154_ATTR_CSMA_MAX_BE])\r\nparams.max_be = nla_get_u8(info->attrs[IEEE802154_ATTR_CSMA_MAX_BE]);\r\nif (info->attrs[IEEE802154_ATTR_FRAME_RETRIES])\r\nparams.frame_retries = nla_get_s8(info->attrs[IEEE802154_ATTR_FRAME_RETRIES]);\r\nrc = ops->set_mac_params(dev, &params);\r\nrtnl_unlock();\r\nwpan_phy_put(phy);\r\ndev_put(dev);\r\nreturn 0;\r\nout:\r\ndev_put(dev);\r\nreturn rc;\r\n}\r\nstatic int\r\nieee802154_llsec_parse_key_id(struct genl_info *info,\r\nstruct ieee802154_llsec_key_id *desc)\r\n{\r\nmemset(desc, 0, sizeof(*desc));\r\nif (!info->attrs[IEEE802154_ATTR_LLSEC_KEY_MODE])\r\nreturn -EINVAL;\r\ndesc->mode = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_KEY_MODE]);\r\nif (desc->mode == IEEE802154_SCF_KEY_IMPLICIT) {\r\nif (!info->attrs[IEEE802154_ATTR_PAN_ID] &&\r\n!(info->attrs[IEEE802154_ATTR_SHORT_ADDR] ||\r\ninfo->attrs[IEEE802154_ATTR_HW_ADDR]))\r\nreturn -EINVAL;\r\ndesc->device_addr.pan_id = nla_get_shortaddr(info->attrs[IEEE802154_ATTR_PAN_ID]);\r\nif (info->attrs[IEEE802154_ATTR_SHORT_ADDR]) {\r\ndesc->device_addr.mode = IEEE802154_ADDR_SHORT;\r\ndesc->device_addr.short_addr = nla_get_shortaddr(info->attrs[IEEE802154_ATTR_SHORT_ADDR]);\r\n} else {\r\ndesc->device_addr.mode = IEEE802154_ADDR_LONG;\r\ndesc->device_addr.extended_addr = nla_get_hwaddr(info->attrs[IEEE802154_ATTR_HW_ADDR]);\r\n}\r\n}\r\nif (desc->mode != IEEE802154_SCF_KEY_IMPLICIT &&\r\n!info->attrs[IEEE802154_ATTR_LLSEC_KEY_ID])\r\nreturn -EINVAL;\r\nif (desc->mode == IEEE802154_SCF_KEY_SHORT_INDEX &&\r\n!info->attrs[IEEE802154_ATTR_LLSEC_KEY_SOURCE_SHORT])\r\nreturn -EINVAL;\r\nif (desc->mode == IEEE802154_SCF_KEY_HW_INDEX &&\r\n!info->attrs[IEEE802154_ATTR_LLSEC_KEY_SOURCE_EXTENDED])\r\nreturn -EINVAL;\r\nif (desc->mode != IEEE802154_SCF_KEY_IMPLICIT)\r\ndesc->id = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_KEY_ID]);\r\nswitch (desc->mode) {\r\ncase IEEE802154_SCF_KEY_SHORT_INDEX:\r\n{\r\nu32 source = nla_get_u32(info->attrs[IEEE802154_ATTR_LLSEC_KEY_SOURCE_SHORT]);\r\ndesc->short_source = cpu_to_le32(source);\r\nbreak;\r\n}\r\ncase IEEE802154_SCF_KEY_HW_INDEX:\r\ndesc->extended_source = nla_get_hwaddr(info->attrs[IEEE802154_ATTR_LLSEC_KEY_SOURCE_EXTENDED]);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nieee802154_llsec_fill_key_id(struct sk_buff *msg,\r\nconst struct ieee802154_llsec_key_id *desc)\r\n{\r\nif (nla_put_u8(msg, IEEE802154_ATTR_LLSEC_KEY_MODE, desc->mode))\r\nreturn -EMSGSIZE;\r\nif (desc->mode == IEEE802154_SCF_KEY_IMPLICIT) {\r\nif (nla_put_shortaddr(msg, IEEE802154_ATTR_PAN_ID,\r\ndesc->device_addr.pan_id))\r\nreturn -EMSGSIZE;\r\nif (desc->device_addr.mode == IEEE802154_ADDR_SHORT &&\r\nnla_put_shortaddr(msg, IEEE802154_ATTR_SHORT_ADDR,\r\ndesc->device_addr.short_addr))\r\nreturn -EMSGSIZE;\r\nif (desc->device_addr.mode == IEEE802154_ADDR_LONG &&\r\nnla_put_hwaddr(msg, IEEE802154_ATTR_HW_ADDR,\r\ndesc->device_addr.extended_addr,\r\nIEEE802154_ATTR_PAD))\r\nreturn -EMSGSIZE;\r\n}\r\nif (desc->mode != IEEE802154_SCF_KEY_IMPLICIT &&\r\nnla_put_u8(msg, IEEE802154_ATTR_LLSEC_KEY_ID, desc->id))\r\nreturn -EMSGSIZE;\r\nif (desc->mode == IEEE802154_SCF_KEY_SHORT_INDEX &&\r\nnla_put_u32(msg, IEEE802154_ATTR_LLSEC_KEY_SOURCE_SHORT,\r\nle32_to_cpu(desc->short_source)))\r\nreturn -EMSGSIZE;\r\nif (desc->mode == IEEE802154_SCF_KEY_HW_INDEX &&\r\nnla_put_hwaddr(msg, IEEE802154_ATTR_LLSEC_KEY_SOURCE_EXTENDED,\r\ndesc->extended_source, IEEE802154_ATTR_PAD))\r\nreturn -EMSGSIZE;\r\nreturn 0;\r\n}\r\nint ieee802154_llsec_getparams(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct sk_buff *msg;\r\nstruct net_device *dev = NULL;\r\nint rc = -ENOBUFS;\r\nstruct ieee802154_mlme_ops *ops;\r\nvoid *hdr;\r\nstruct ieee802154_llsec_params params;\r\npr_debug("%s\n", __func__);\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nops = ieee802154_mlme_ops(dev);\r\nif (!ops->llsec) {\r\nrc = -EOPNOTSUPP;\r\ngoto out_dev;\r\n}\r\nmsg = nlmsg_new(NLMSG_DEFAULT_SIZE, GFP_KERNEL);\r\nif (!msg)\r\ngoto out_dev;\r\nhdr = genlmsg_put(msg, 0, info->snd_seq, &nl802154_family, 0,\r\nIEEE802154_LLSEC_GETPARAMS);\r\nif (!hdr)\r\ngoto out_free;\r\nrc = ops->llsec->get_params(dev, &params);\r\nif (rc < 0)\r\ngoto out_free;\r\nif (nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name) ||\r\nnla_put_u32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_LLSEC_ENABLED, params.enabled) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_LLSEC_SECLEVEL, params.out_level) ||\r\nnla_put_u32(msg, IEEE802154_ATTR_LLSEC_FRAME_COUNTER,\r\nbe32_to_cpu(params.frame_counter)) ||\r\nieee802154_llsec_fill_key_id(msg, &params.out_key))\r\ngoto out_free;\r\ndev_put(dev);\r\nreturn ieee802154_nl_reply(msg, info);\r\nout_free:\r\nnlmsg_free(msg);\r\nout_dev:\r\ndev_put(dev);\r\nreturn rc;\r\n}\r\nint ieee802154_llsec_setparams(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net_device *dev = NULL;\r\nint rc = -EINVAL;\r\nstruct ieee802154_mlme_ops *ops;\r\nstruct ieee802154_llsec_params params;\r\nint changed = 0;\r\npr_debug("%s\n", __func__);\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nif (!info->attrs[IEEE802154_ATTR_LLSEC_ENABLED] &&\r\n!info->attrs[IEEE802154_ATTR_LLSEC_KEY_MODE] &&\r\n!info->attrs[IEEE802154_ATTR_LLSEC_SECLEVEL])\r\ngoto out;\r\nops = ieee802154_mlme_ops(dev);\r\nif (!ops->llsec) {\r\nrc = -EOPNOTSUPP;\r\ngoto out;\r\n}\r\nif (info->attrs[IEEE802154_ATTR_LLSEC_SECLEVEL] &&\r\nnla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_SECLEVEL]) > 7)\r\ngoto out;\r\nif (info->attrs[IEEE802154_ATTR_LLSEC_ENABLED]) {\r\nparams.enabled = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_ENABLED]);\r\nchanged |= IEEE802154_LLSEC_PARAM_ENABLED;\r\n}\r\nif (info->attrs[IEEE802154_ATTR_LLSEC_KEY_MODE]) {\r\nif (ieee802154_llsec_parse_key_id(info, &params.out_key))\r\ngoto out;\r\nchanged |= IEEE802154_LLSEC_PARAM_OUT_KEY;\r\n}\r\nif (info->attrs[IEEE802154_ATTR_LLSEC_SECLEVEL]) {\r\nparams.out_level = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_SECLEVEL]);\r\nchanged |= IEEE802154_LLSEC_PARAM_OUT_LEVEL;\r\n}\r\nif (info->attrs[IEEE802154_ATTR_LLSEC_FRAME_COUNTER]) {\r\nu32 fc = nla_get_u32(info->attrs[IEEE802154_ATTR_LLSEC_FRAME_COUNTER]);\r\nparams.frame_counter = cpu_to_be32(fc);\r\nchanged |= IEEE802154_LLSEC_PARAM_FRAME_COUNTER;\r\n}\r\nrc = ops->llsec->set_params(dev, &params, changed);\r\ndev_put(dev);\r\nreturn rc;\r\nout:\r\ndev_put(dev);\r\nreturn rc;\r\n}\r\nstatic int\r\nieee802154_llsec_dump_table(struct sk_buff *skb, struct netlink_callback *cb,\r\nint (*step)(struct llsec_dump_data *))\r\n{\r\nstruct net *net = sock_net(skb->sk);\r\nstruct net_device *dev;\r\nstruct llsec_dump_data data;\r\nint idx = 0;\r\nint first_dev = cb->args[0];\r\nint rc;\r\nfor_each_netdev(net, dev) {\r\nif (idx < first_dev || dev->type != ARPHRD_IEEE802154)\r\ngoto skip;\r\ndata.ops = ieee802154_mlme_ops(dev);\r\nif (!data.ops->llsec)\r\ngoto skip;\r\ndata.skb = skb;\r\ndata.s_idx = cb->args[1];\r\ndata.s_idx2 = cb->args[2];\r\ndata.dev = dev;\r\ndata.portid = NETLINK_CB(cb->skb).portid;\r\ndata.nlmsg_seq = cb->nlh->nlmsg_seq;\r\ndata.ops->llsec->lock_table(dev);\r\ndata.ops->llsec->get_table(data.dev, &data.table);\r\nrc = step(&data);\r\ndata.ops->llsec->unlock_table(dev);\r\nif (rc < 0)\r\nbreak;\r\nskip:\r\nidx++;\r\n}\r\ncb->args[0] = idx;\r\nreturn skb->len;\r\n}\r\nstatic int\r\nieee802154_nl_llsec_change(struct sk_buff *skb, struct genl_info *info,\r\nint (*fn)(struct net_device*, struct genl_info*))\r\n{\r\nstruct net_device *dev = NULL;\r\nint rc = -EINVAL;\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nif (!ieee802154_mlme_ops(dev)->llsec)\r\nrc = -EOPNOTSUPP;\r\nelse\r\nrc = fn(dev, info);\r\ndev_put(dev);\r\nreturn rc;\r\n}\r\nstatic int\r\nieee802154_llsec_parse_key(struct genl_info *info,\r\nstruct ieee802154_llsec_key *key)\r\n{\r\nu8 frames;\r\nu32 commands[256 / 32];\r\nmemset(key, 0, sizeof(*key));\r\nif (!info->attrs[IEEE802154_ATTR_LLSEC_KEY_USAGE_FRAME_TYPES] ||\r\n!info->attrs[IEEE802154_ATTR_LLSEC_KEY_BYTES])\r\nreturn -EINVAL;\r\nframes = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_KEY_USAGE_FRAME_TYPES]);\r\nif ((frames & BIT(IEEE802154_FC_TYPE_MAC_CMD)) &&\r\n!info->attrs[IEEE802154_ATTR_LLSEC_KEY_USAGE_COMMANDS])\r\nreturn -EINVAL;\r\nif (info->attrs[IEEE802154_ATTR_LLSEC_KEY_USAGE_COMMANDS]) {\r\nnla_memcpy(commands,\r\ninfo->attrs[IEEE802154_ATTR_LLSEC_KEY_USAGE_COMMANDS],\r\n256 / 8);\r\nif (commands[0] || commands[1] || commands[2] || commands[3] ||\r\ncommands[4] || commands[5] || commands[6] ||\r\ncommands[7] >= BIT(IEEE802154_CMD_GTS_REQ + 1))\r\nreturn -EINVAL;\r\nkey->cmd_frame_ids = commands[7];\r\n}\r\nkey->frame_types = frames;\r\nnla_memcpy(key->key, info->attrs[IEEE802154_ATTR_LLSEC_KEY_BYTES],\r\nIEEE802154_LLSEC_KEY_SIZE);\r\nreturn 0;\r\n}\r\nstatic int llsec_add_key(struct net_device *dev, struct genl_info *info)\r\n{\r\nstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\r\nstruct ieee802154_llsec_key key;\r\nstruct ieee802154_llsec_key_id id;\r\nif (ieee802154_llsec_parse_key(info, &key) ||\r\nieee802154_llsec_parse_key_id(info, &id))\r\nreturn -EINVAL;\r\nreturn ops->llsec->add_key(dev, &id, &key);\r\n}\r\nint ieee802154_llsec_add_key(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nif ((info->nlhdr->nlmsg_flags & (NLM_F_CREATE | NLM_F_EXCL)) !=\r\n(NLM_F_CREATE | NLM_F_EXCL))\r\nreturn -EINVAL;\r\nreturn ieee802154_nl_llsec_change(skb, info, llsec_add_key);\r\n}\r\nstatic int llsec_remove_key(struct net_device *dev, struct genl_info *info)\r\n{\r\nstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\r\nstruct ieee802154_llsec_key_id id;\r\nif (ieee802154_llsec_parse_key_id(info, &id))\r\nreturn -EINVAL;\r\nreturn ops->llsec->del_key(dev, &id);\r\n}\r\nint ieee802154_llsec_del_key(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nreturn ieee802154_nl_llsec_change(skb, info, llsec_remove_key);\r\n}\r\nstatic int\r\nieee802154_nl_fill_key(struct sk_buff *msg, u32 portid, u32 seq,\r\nconst struct ieee802154_llsec_key_entry *key,\r\nconst struct net_device *dev)\r\n{\r\nvoid *hdr;\r\nu32 commands[256 / 32];\r\nhdr = genlmsg_put(msg, 0, seq, &nl802154_family, NLM_F_MULTI,\r\nIEEE802154_LLSEC_LIST_KEY);\r\nif (!hdr)\r\ngoto out;\r\nif (nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name) ||\r\nnla_put_u32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex) ||\r\nieee802154_llsec_fill_key_id(msg, &key->id) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_LLSEC_KEY_USAGE_FRAME_TYPES,\r\nkey->key->frame_types))\r\ngoto nla_put_failure;\r\nif (key->key->frame_types & BIT(IEEE802154_FC_TYPE_MAC_CMD)) {\r\nmemset(commands, 0, sizeof(commands));\r\ncommands[7] = key->key->cmd_frame_ids;\r\nif (nla_put(msg, IEEE802154_ATTR_LLSEC_KEY_USAGE_COMMANDS,\r\nsizeof(commands), commands))\r\ngoto nla_put_failure;\r\n}\r\nif (nla_put(msg, IEEE802154_ATTR_LLSEC_KEY_BYTES,\r\nIEEE802154_LLSEC_KEY_SIZE, key->key->key))\r\ngoto nla_put_failure;\r\ngenlmsg_end(msg, hdr);\r\nreturn 0;\r\nnla_put_failure:\r\ngenlmsg_cancel(msg, hdr);\r\nout:\r\nreturn -EMSGSIZE;\r\n}\r\nstatic int llsec_iter_keys(struct llsec_dump_data *data)\r\n{\r\nstruct ieee802154_llsec_key_entry *pos;\r\nint rc = 0, idx = 0;\r\nlist_for_each_entry(pos, &data->table->keys, list) {\r\nif (idx++ < data->s_idx)\r\ncontinue;\r\nif (ieee802154_nl_fill_key(data->skb, data->portid,\r\ndata->nlmsg_seq, pos, data->dev)) {\r\nrc = -EMSGSIZE;\r\nbreak;\r\n}\r\ndata->s_idx++;\r\n}\r\nreturn rc;\r\n}\r\nint ieee802154_llsec_dump_keys(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nreturn ieee802154_llsec_dump_table(skb, cb, llsec_iter_keys);\r\n}\r\nstatic int\r\nllsec_parse_dev(struct genl_info *info,\r\nstruct ieee802154_llsec_device *dev)\r\n{\r\nmemset(dev, 0, sizeof(*dev));\r\nif (!info->attrs[IEEE802154_ATTR_LLSEC_FRAME_COUNTER] ||\r\n!info->attrs[IEEE802154_ATTR_HW_ADDR] ||\r\n!info->attrs[IEEE802154_ATTR_LLSEC_DEV_OVERRIDE] ||\r\n!info->attrs[IEEE802154_ATTR_LLSEC_DEV_KEY_MODE] ||\r\n(!!info->attrs[IEEE802154_ATTR_PAN_ID] !=\r\n!!info->attrs[IEEE802154_ATTR_SHORT_ADDR]))\r\nreturn -EINVAL;\r\nif (info->attrs[IEEE802154_ATTR_PAN_ID]) {\r\ndev->pan_id = nla_get_shortaddr(info->attrs[IEEE802154_ATTR_PAN_ID]);\r\ndev->short_addr = nla_get_shortaddr(info->attrs[IEEE802154_ATTR_SHORT_ADDR]);\r\n} else {\r\ndev->short_addr = cpu_to_le16(IEEE802154_ADDR_UNDEF);\r\n}\r\ndev->hwaddr = nla_get_hwaddr(info->attrs[IEEE802154_ATTR_HW_ADDR]);\r\ndev->frame_counter = nla_get_u32(info->attrs[IEEE802154_ATTR_LLSEC_FRAME_COUNTER]);\r\ndev->seclevel_exempt = !!nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_DEV_OVERRIDE]);\r\ndev->key_mode = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_DEV_KEY_MODE]);\r\nif (dev->key_mode >= __IEEE802154_LLSEC_DEVKEY_MAX)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int llsec_add_dev(struct net_device *dev, struct genl_info *info)\r\n{\r\nstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\r\nstruct ieee802154_llsec_device desc;\r\nif (llsec_parse_dev(info, &desc))\r\nreturn -EINVAL;\r\nreturn ops->llsec->add_dev(dev, &desc);\r\n}\r\nint ieee802154_llsec_add_dev(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nif ((info->nlhdr->nlmsg_flags & (NLM_F_CREATE | NLM_F_EXCL)) !=\r\n(NLM_F_CREATE | NLM_F_EXCL))\r\nreturn -EINVAL;\r\nreturn ieee802154_nl_llsec_change(skb, info, llsec_add_dev);\r\n}\r\nstatic int llsec_del_dev(struct net_device *dev, struct genl_info *info)\r\n{\r\nstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\r\n__le64 devaddr;\r\nif (!info->attrs[IEEE802154_ATTR_HW_ADDR])\r\nreturn -EINVAL;\r\ndevaddr = nla_get_hwaddr(info->attrs[IEEE802154_ATTR_HW_ADDR]);\r\nreturn ops->llsec->del_dev(dev, devaddr);\r\n}\r\nint ieee802154_llsec_del_dev(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nreturn ieee802154_nl_llsec_change(skb, info, llsec_del_dev);\r\n}\r\nstatic int\r\nieee802154_nl_fill_dev(struct sk_buff *msg, u32 portid, u32 seq,\r\nconst struct ieee802154_llsec_device *desc,\r\nconst struct net_device *dev)\r\n{\r\nvoid *hdr;\r\nhdr = genlmsg_put(msg, 0, seq, &nl802154_family, NLM_F_MULTI,\r\nIEEE802154_LLSEC_LIST_DEV);\r\nif (!hdr)\r\ngoto out;\r\nif (nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name) ||\r\nnla_put_u32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex) ||\r\nnla_put_shortaddr(msg, IEEE802154_ATTR_PAN_ID, desc->pan_id) ||\r\nnla_put_shortaddr(msg, IEEE802154_ATTR_SHORT_ADDR,\r\ndesc->short_addr) ||\r\nnla_put_hwaddr(msg, IEEE802154_ATTR_HW_ADDR, desc->hwaddr,\r\nIEEE802154_ATTR_PAD) ||\r\nnla_put_u32(msg, IEEE802154_ATTR_LLSEC_FRAME_COUNTER,\r\ndesc->frame_counter) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_LLSEC_DEV_OVERRIDE,\r\ndesc->seclevel_exempt) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_LLSEC_DEV_KEY_MODE, desc->key_mode))\r\ngoto nla_put_failure;\r\ngenlmsg_end(msg, hdr);\r\nreturn 0;\r\nnla_put_failure:\r\ngenlmsg_cancel(msg, hdr);\r\nout:\r\nreturn -EMSGSIZE;\r\n}\r\nstatic int llsec_iter_devs(struct llsec_dump_data *data)\r\n{\r\nstruct ieee802154_llsec_device *pos;\r\nint rc = 0, idx = 0;\r\nlist_for_each_entry(pos, &data->table->devices, list) {\r\nif (idx++ < data->s_idx)\r\ncontinue;\r\nif (ieee802154_nl_fill_dev(data->skb, data->portid,\r\ndata->nlmsg_seq, pos, data->dev)) {\r\nrc = -EMSGSIZE;\r\nbreak;\r\n}\r\ndata->s_idx++;\r\n}\r\nreturn rc;\r\n}\r\nint ieee802154_llsec_dump_devs(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nreturn ieee802154_llsec_dump_table(skb, cb, llsec_iter_devs);\r\n}\r\nstatic int llsec_add_devkey(struct net_device *dev, struct genl_info *info)\r\n{\r\nstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\r\nstruct ieee802154_llsec_device_key key;\r\n__le64 devaddr;\r\nif (!info->attrs[IEEE802154_ATTR_LLSEC_FRAME_COUNTER] ||\r\n!info->attrs[IEEE802154_ATTR_HW_ADDR] ||\r\nieee802154_llsec_parse_key_id(info, &key.key_id))\r\nreturn -EINVAL;\r\ndevaddr = nla_get_hwaddr(info->attrs[IEEE802154_ATTR_HW_ADDR]);\r\nkey.frame_counter = nla_get_u32(info->attrs[IEEE802154_ATTR_LLSEC_FRAME_COUNTER]);\r\nreturn ops->llsec->add_devkey(dev, devaddr, &key);\r\n}\r\nint ieee802154_llsec_add_devkey(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nif ((info->nlhdr->nlmsg_flags & (NLM_F_CREATE | NLM_F_EXCL)) !=\r\n(NLM_F_CREATE | NLM_F_EXCL))\r\nreturn -EINVAL;\r\nreturn ieee802154_nl_llsec_change(skb, info, llsec_add_devkey);\r\n}\r\nstatic int llsec_del_devkey(struct net_device *dev, struct genl_info *info)\r\n{\r\nstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\r\nstruct ieee802154_llsec_device_key key;\r\n__le64 devaddr;\r\nif (!info->attrs[IEEE802154_ATTR_HW_ADDR] ||\r\nieee802154_llsec_parse_key_id(info, &key.key_id))\r\nreturn -EINVAL;\r\ndevaddr = nla_get_hwaddr(info->attrs[IEEE802154_ATTR_HW_ADDR]);\r\nreturn ops->llsec->del_devkey(dev, devaddr, &key);\r\n}\r\nint ieee802154_llsec_del_devkey(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nreturn ieee802154_nl_llsec_change(skb, info, llsec_del_devkey);\r\n}\r\nstatic int\r\nieee802154_nl_fill_devkey(struct sk_buff *msg, u32 portid, u32 seq,\r\n__le64 devaddr,\r\nconst struct ieee802154_llsec_device_key *devkey,\r\nconst struct net_device *dev)\r\n{\r\nvoid *hdr;\r\nhdr = genlmsg_put(msg, 0, seq, &nl802154_family, NLM_F_MULTI,\r\nIEEE802154_LLSEC_LIST_DEVKEY);\r\nif (!hdr)\r\ngoto out;\r\nif (nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name) ||\r\nnla_put_u32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex) ||\r\nnla_put_hwaddr(msg, IEEE802154_ATTR_HW_ADDR, devaddr,\r\nIEEE802154_ATTR_PAD) ||\r\nnla_put_u32(msg, IEEE802154_ATTR_LLSEC_FRAME_COUNTER,\r\ndevkey->frame_counter) ||\r\nieee802154_llsec_fill_key_id(msg, &devkey->key_id))\r\ngoto nla_put_failure;\r\ngenlmsg_end(msg, hdr);\r\nreturn 0;\r\nnla_put_failure:\r\ngenlmsg_cancel(msg, hdr);\r\nout:\r\nreturn -EMSGSIZE;\r\n}\r\nstatic int llsec_iter_devkeys(struct llsec_dump_data *data)\r\n{\r\nstruct ieee802154_llsec_device *dpos;\r\nstruct ieee802154_llsec_device_key *kpos;\r\nint rc = 0, idx = 0, idx2;\r\nlist_for_each_entry(dpos, &data->table->devices, list) {\r\nif (idx++ < data->s_idx)\r\ncontinue;\r\nidx2 = 0;\r\nlist_for_each_entry(kpos, &dpos->keys, list) {\r\nif (idx2++ < data->s_idx2)\r\ncontinue;\r\nif (ieee802154_nl_fill_devkey(data->skb, data->portid,\r\ndata->nlmsg_seq,\r\ndpos->hwaddr, kpos,\r\ndata->dev)) {\r\nreturn rc = -EMSGSIZE;\r\n}\r\ndata->s_idx2++;\r\n}\r\ndata->s_idx++;\r\n}\r\nreturn rc;\r\n}\r\nint ieee802154_llsec_dump_devkeys(struct sk_buff *skb,\r\nstruct netlink_callback *cb)\r\n{\r\nreturn ieee802154_llsec_dump_table(skb, cb, llsec_iter_devkeys);\r\n}\r\nstatic int\r\nllsec_parse_seclevel(struct genl_info *info,\r\nstruct ieee802154_llsec_seclevel *sl)\r\n{\r\nmemset(sl, 0, sizeof(*sl));\r\nif (!info->attrs[IEEE802154_ATTR_LLSEC_FRAME_TYPE] ||\r\n!info->attrs[IEEE802154_ATTR_LLSEC_SECLEVELS] ||\r\n!info->attrs[IEEE802154_ATTR_LLSEC_DEV_OVERRIDE])\r\nreturn -EINVAL;\r\nsl->frame_type = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_FRAME_TYPE]);\r\nif (sl->frame_type == IEEE802154_FC_TYPE_MAC_CMD) {\r\nif (!info->attrs[IEEE802154_ATTR_LLSEC_CMD_FRAME_ID])\r\nreturn -EINVAL;\r\nsl->cmd_frame_id = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_CMD_FRAME_ID]);\r\n}\r\nsl->sec_levels = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_SECLEVELS]);\r\nsl->device_override = nla_get_u8(info->attrs[IEEE802154_ATTR_LLSEC_DEV_OVERRIDE]);\r\nreturn 0;\r\n}\r\nstatic int llsec_add_seclevel(struct net_device *dev, struct genl_info *info)\r\n{\r\nstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\r\nstruct ieee802154_llsec_seclevel sl;\r\nif (llsec_parse_seclevel(info, &sl))\r\nreturn -EINVAL;\r\nreturn ops->llsec->add_seclevel(dev, &sl);\r\n}\r\nint ieee802154_llsec_add_seclevel(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nif ((info->nlhdr->nlmsg_flags & (NLM_F_CREATE | NLM_F_EXCL)) !=\r\n(NLM_F_CREATE | NLM_F_EXCL))\r\nreturn -EINVAL;\r\nreturn ieee802154_nl_llsec_change(skb, info, llsec_add_seclevel);\r\n}\r\nstatic int llsec_del_seclevel(struct net_device *dev, struct genl_info *info)\r\n{\r\nstruct ieee802154_mlme_ops *ops = ieee802154_mlme_ops(dev);\r\nstruct ieee802154_llsec_seclevel sl;\r\nif (llsec_parse_seclevel(info, &sl))\r\nreturn -EINVAL;\r\nreturn ops->llsec->del_seclevel(dev, &sl);\r\n}\r\nint ieee802154_llsec_del_seclevel(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nreturn ieee802154_nl_llsec_change(skb, info, llsec_del_seclevel);\r\n}\r\nstatic int\r\nieee802154_nl_fill_seclevel(struct sk_buff *msg, u32 portid, u32 seq,\r\nconst struct ieee802154_llsec_seclevel *sl,\r\nconst struct net_device *dev)\r\n{\r\nvoid *hdr;\r\nhdr = genlmsg_put(msg, 0, seq, &nl802154_family, NLM_F_MULTI,\r\nIEEE802154_LLSEC_LIST_SECLEVEL);\r\nif (!hdr)\r\ngoto out;\r\nif (nla_put_string(msg, IEEE802154_ATTR_DEV_NAME, dev->name) ||\r\nnla_put_u32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_LLSEC_FRAME_TYPE, sl->frame_type) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_LLSEC_SECLEVELS, sl->sec_levels) ||\r\nnla_put_u8(msg, IEEE802154_ATTR_LLSEC_DEV_OVERRIDE,\r\nsl->device_override))\r\ngoto nla_put_failure;\r\nif (sl->frame_type == IEEE802154_FC_TYPE_MAC_CMD &&\r\nnla_put_u8(msg, IEEE802154_ATTR_LLSEC_CMD_FRAME_ID,\r\nsl->cmd_frame_id))\r\ngoto nla_put_failure;\r\ngenlmsg_end(msg, hdr);\r\nreturn 0;\r\nnla_put_failure:\r\ngenlmsg_cancel(msg, hdr);\r\nout:\r\nreturn -EMSGSIZE;\r\n}\r\nstatic int llsec_iter_seclevels(struct llsec_dump_data *data)\r\n{\r\nstruct ieee802154_llsec_seclevel *pos;\r\nint rc = 0, idx = 0;\r\nlist_for_each_entry(pos, &data->table->security_levels, list) {\r\nif (idx++ < data->s_idx)\r\ncontinue;\r\nif (ieee802154_nl_fill_seclevel(data->skb, data->portid,\r\ndata->nlmsg_seq, pos,\r\ndata->dev)) {\r\nrc = -EMSGSIZE;\r\nbreak;\r\n}\r\ndata->s_idx++;\r\n}\r\nreturn rc;\r\n}\r\nint ieee802154_llsec_dump_seclevels(struct sk_buff *skb,\r\nstruct netlink_callback *cb)\r\n{\r\nreturn ieee802154_llsec_dump_table(skb, cb, llsec_iter_seclevels);\r\n}

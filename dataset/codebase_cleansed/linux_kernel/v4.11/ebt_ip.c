static bool\r\nebt_ip_mt(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct ebt_ip_info *info = par->matchinfo;\r\nconst struct iphdr *ih;\r\nstruct iphdr _iph;\r\nconst struct tcpudphdr *pptr;\r\nstruct tcpudphdr _ports;\r\nih = skb_header_pointer(skb, 0, sizeof(_iph), &_iph);\r\nif (ih == NULL)\r\nreturn false;\r\nif ((info->bitmask & EBT_IP_TOS) &&\r\nNF_INVF(info, EBT_IP_TOS, info->tos != ih->tos))\r\nreturn false;\r\nif ((info->bitmask & EBT_IP_SOURCE) &&\r\nNF_INVF(info, EBT_IP_SOURCE,\r\n(ih->saddr & info->smsk) != info->saddr))\r\nreturn false;\r\nif ((info->bitmask & EBT_IP_DEST) &&\r\nNF_INVF(info, EBT_IP_DEST,\r\n(ih->daddr & info->dmsk) != info->daddr))\r\nreturn false;\r\nif (info->bitmask & EBT_IP_PROTO) {\r\nif (NF_INVF(info, EBT_IP_PROTO, info->protocol != ih->protocol))\r\nreturn false;\r\nif (!(info->bitmask & EBT_IP_DPORT) &&\r\n!(info->bitmask & EBT_IP_SPORT))\r\nreturn true;\r\nif (ntohs(ih->frag_off) & IP_OFFSET)\r\nreturn false;\r\npptr = skb_header_pointer(skb, ih->ihl*4,\r\nsizeof(_ports), &_ports);\r\nif (pptr == NULL)\r\nreturn false;\r\nif (info->bitmask & EBT_IP_DPORT) {\r\nu32 dst = ntohs(pptr->dst);\r\nif (NF_INVF(info, EBT_IP_DPORT,\r\ndst < info->dport[0] ||\r\ndst > info->dport[1]))\r\nreturn false;\r\n}\r\nif (info->bitmask & EBT_IP_SPORT) {\r\nu32 src = ntohs(pptr->src);\r\nif (NF_INVF(info, EBT_IP_SPORT,\r\nsrc < info->sport[0] ||\r\nsrc > info->sport[1]))\r\nreturn false;\r\n}\r\n}\r\nreturn true;\r\n}\r\nstatic int ebt_ip_mt_check(const struct xt_mtchk_param *par)\r\n{\r\nconst struct ebt_ip_info *info = par->matchinfo;\r\nconst struct ebt_entry *e = par->entryinfo;\r\nif (e->ethproto != htons(ETH_P_IP) ||\r\ne->invflags & EBT_IPROTO)\r\nreturn -EINVAL;\r\nif (info->bitmask & ~EBT_IP_MASK || info->invflags & ~EBT_IP_MASK)\r\nreturn -EINVAL;\r\nif (info->bitmask & (EBT_IP_DPORT | EBT_IP_SPORT)) {\r\nif (info->invflags & EBT_IP_PROTO)\r\nreturn -EINVAL;\r\nif (info->protocol != IPPROTO_TCP &&\r\ninfo->protocol != IPPROTO_UDP &&\r\ninfo->protocol != IPPROTO_UDPLITE &&\r\ninfo->protocol != IPPROTO_SCTP &&\r\ninfo->protocol != IPPROTO_DCCP)\r\nreturn -EINVAL;\r\n}\r\nif (info->bitmask & EBT_IP_DPORT && info->dport[0] > info->dport[1])\r\nreturn -EINVAL;\r\nif (info->bitmask & EBT_IP_SPORT && info->sport[0] > info->sport[1])\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int __init ebt_ip_init(void)\r\n{\r\nreturn xt_register_match(&ebt_ip_mt_reg);\r\n}\r\nstatic void __exit ebt_ip_fini(void)\r\n{\r\nxt_unregister_match(&ebt_ip_mt_reg);\r\n}

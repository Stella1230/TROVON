static void bs_init(struct bs *s, void *buf, int size)\r\n{\r\ns->buf = buf;\r\ns->ptr = buf;\r\ns->buf_end = s->ptr + size;\r\ns->bits_left = 8;\r\n}\r\nstatic int bs_len(struct bs *s)\r\n{\r\nreturn s->ptr - s->buf;\r\n}\r\nstatic void bs_write(struct bs *s, int count, u32 bits)\r\n{\r\nif (s->ptr >= s->buf_end - 4)\r\nreturn;\r\nwhile (count > 0) {\r\nif (count < 32)\r\nbits &= (1 << count) - 1;\r\nif (count < s->bits_left) {\r\n*s->ptr = (*s->ptr << count) | bits;\r\ns->bits_left -= count;\r\nbreak;\r\n}\r\n*s->ptr = (*s->ptr << s->bits_left) |\r\n(bits >> (count - s->bits_left));\r\ncount -= s->bits_left;\r\ns->ptr++;\r\ns->bits_left = 8;\r\n}\r\n}\r\nstatic void bs_write1(struct bs *s, u32 bit)\r\n{\r\nif (s->ptr < s->buf_end) {\r\n*s->ptr <<= 1;\r\n*s->ptr |= bit;\r\ns->bits_left--;\r\nif (s->bits_left == 0) {\r\ns->ptr++;\r\ns->bits_left = 8;\r\n}\r\n}\r\n}\r\nstatic void bs_write_ue(struct bs *s, u32 val)\r\n{\r\nif (val == 0) {\r\nbs_write1(s, 1);\r\n} else {\r\nval++;\r\nbs_write(s, 2 * fls(val) - 1, val);\r\n}\r\n}\r\nstatic void bs_write_se(struct bs *s, int val)\r\n{\r\nbs_write_ue(s, val <= 0 ? -val * 2 : val * 2 - 1);\r\n}\r\nstatic void bs_rbsp_trailing(struct bs *s)\r\n{\r\nbs_write1(s, 1);\r\nif (s->bits_left != 8)\r\nbs_write(s, s->bits_left, 0x00);\r\n}\r\nstatic int tw5864_h264_gen_sps_rbsp(u8 *buf, size_t size, int width, int height)\r\n{\r\nstruct bs bs, *s;\r\ns = &bs;\r\nbs_init(s, buf, size);\r\nbs_write(s, 8, 0x42);\r\nbs_write(s, 1, 1);\r\nbs_write(s, 1, 1);\r\nbs_write(s, 1, 0);\r\nbs_write(s, 5, 0);\r\nbs_write(s, 8, 0x1e);\r\nbs_write_ue(s, 0);\r\nbs_write_ue(s, ilog2(MAX_GOP_SIZE) - 4);\r\nbs_write_ue(s, 0);\r\nbs_write_ue(s, ilog2(MAX_GOP_SIZE) - 4);\r\nbs_write_ue(s, 1);\r\nbs_write(s, 1, 0);\r\nbs_write_ue(s, width / 16 - 1);\r\nbs_write_ue(s, height / 16 - 1);\r\nbs_write(s, 1, 1);\r\nbs_write(s, 1, 0);\r\nbs_write(s, 1, 0);\r\nbs_write(s, 1, 0);\r\nbs_rbsp_trailing(s);\r\nreturn bs_len(s);\r\n}\r\nstatic int tw5864_h264_gen_pps_rbsp(u8 *buf, size_t size, int qp)\r\n{\r\nstruct bs bs, *s;\r\ns = &bs;\r\nbs_init(s, buf, size);\r\nbs_write_ue(s, 0);\r\nbs_write_ue(s, 0);\r\nbs_write(s, 1, 0);\r\nbs_write(s, 1, 0);\r\nbs_write_ue(s, 0);\r\nbs_write_ue(s, 0);\r\nbs_write_ue(s, 0);\r\nbs_write(s, 1, 0);\r\nbs_write(s, 2, 0);\r\nbs_write_se(s, qp - 26);\r\nbs_write_se(s, qp - 26);\r\nbs_write_se(s, 0);\r\nbs_write(s, 1, 0);\r\nbs_write(s, 1, 0);\r\nbs_write(s, 1, 0);\r\nbs_rbsp_trailing(s);\r\nreturn bs_len(s);\r\n}\r\nstatic int tw5864_h264_gen_slice_head(u8 *buf, size_t size,\r\nunsigned int idr_pic_id,\r\nunsigned int frame_gop_seqno,\r\nint *tail_nb_bits, u8 *tail)\r\n{\r\nstruct bs bs, *s;\r\nint is_i_frame = frame_gop_seqno == 0;\r\ns = &bs;\r\nbs_init(s, buf, size);\r\nbs_write_ue(s, 0);\r\nbs_write_ue(s, is_i_frame ? 2 : 5);\r\nbs_write_ue(s, 0);\r\nbs_write(s, ilog2(MAX_GOP_SIZE), frame_gop_seqno);\r\nif (is_i_frame)\r\nbs_write_ue(s, idr_pic_id);\r\nbs_write(s, ilog2(MAX_GOP_SIZE), frame_gop_seqno);\r\nif (is_i_frame) {\r\nbs_write1(s, 0);\r\nbs_write1(s, 0);\r\n} else {\r\nbs_write1(s, 0);\r\nbs_write1(s, 0);\r\nbs_write1(s, 0);\r\n}\r\nbs_write_se(s, 0);\r\nif (s->bits_left != 8) {\r\n*tail = ((s->ptr[0]) << s->bits_left);\r\n*tail_nb_bits = 8 - s->bits_left;\r\n} else {\r\n*tail = 0;\r\n*tail_nb_bits = 0;\r\n}\r\nreturn bs_len(s);\r\n}\r\nvoid tw5864_h264_put_stream_header(u8 **buf, size_t *space_left, int qp,\r\nint width, int height)\r\n{\r\nint nal_len;\r\nmemcpy(*buf, marker, sizeof(marker));\r\n*buf += 4;\r\n*space_left -= 4;\r\n**buf = 0x67;\r\n*buf += 1;\r\n*space_left -= 1;\r\nnal_len = tw5864_h264_gen_sps_rbsp(*buf, *space_left, width, height);\r\n*buf += nal_len;\r\n*space_left -= nal_len;\r\nmemcpy(*buf, marker, sizeof(marker));\r\n*buf += 4;\r\n*space_left -= 4;\r\n**buf = 0x68;\r\n*buf += 1;\r\n*space_left -= 1;\r\nnal_len = tw5864_h264_gen_pps_rbsp(*buf, *space_left, qp);\r\n*buf += nal_len;\r\n*space_left -= nal_len;\r\n}\r\nvoid tw5864_h264_put_slice_header(u8 **buf, size_t *space_left,\r\nunsigned int idr_pic_id,\r\nunsigned int frame_gop_seqno,\r\nint *tail_nb_bits, u8 *tail)\r\n{\r\nint nal_len;\r\nmemcpy(*buf, marker, sizeof(marker));\r\n*buf += 4;\r\n*space_left -= 4;\r\n**buf = (frame_gop_seqno == 0) ? 0x25 : 0x21;\r\n*buf += 1;\r\n*space_left -= 1;\r\nnal_len = tw5864_h264_gen_slice_head(*buf, *space_left, idr_pic_id,\r\nframe_gop_seqno, tail_nb_bits,\r\ntail);\r\n*buf += nal_len;\r\n*space_left -= nal_len;\r\n}

static unsigned int log2(unsigned int v)\r\n{\r\nunsigned int r;\r\nunsigned int shift;\r\nr = (v > 0xFFFF) << 4; v >>= r;\r\nshift = (v > 0xFF) << 3; v >>= shift; r |= shift;\r\nshift = (v > 0xF) << 2; v >>= shift; r |= shift;\r\nshift = (v > 0x3) << 1; v >>= shift; r |= shift;\r\nr |= (v >> 1);\r\nreturn r;\r\n}\r\nstatic unsigned int log2l(unsigned long v)\r\n{\r\nunsigned int hi = v >> 32;\r\nif (hi)\r\nreturn log2(hi) + 32;\r\nelse\r\nreturn log2(v);\r\n}\r\nint do_len_hist(struct __sk_buff *skb)\r\n{\r\n__u64 *value, key, init_val = 1;\r\nkey = log2l(skb->len);\r\nvalue = bpf_map_lookup_elem(&lwt_len_hist_map, &key);\r\nif (value)\r\n__sync_fetch_and_add(value, 1);\r\nelse\r\nbpf_map_update_elem(&lwt_len_hist_map, &key, &init_val, BPF_ANY);\r\nreturn BPF_OK;\r\n}

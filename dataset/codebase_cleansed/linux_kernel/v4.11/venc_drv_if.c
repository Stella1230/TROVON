int venc_if_init(struct mtk_vcodec_ctx *ctx, unsigned int fourcc)\r\n{\r\nint ret = 0;\r\nswitch (fourcc) {\r\ncase V4L2_PIX_FMT_VP8:\r\nctx->enc_if = get_vp8_enc_comm_if();\r\nbreak;\r\ncase V4L2_PIX_FMT_H264:\r\nctx->enc_if = get_h264_enc_comm_if();\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nmtk_venc_lock(ctx);\r\nmtk_vcodec_enc_clock_on(&ctx->dev->pm);\r\nret = ctx->enc_if->init(ctx, (unsigned long *)&ctx->drv_handle);\r\nmtk_vcodec_enc_clock_off(&ctx->dev->pm);\r\nmtk_venc_unlock(ctx);\r\nreturn ret;\r\n}\r\nint venc_if_set_param(struct mtk_vcodec_ctx *ctx,\r\nenum venc_set_param_type type, struct venc_enc_param *in)\r\n{\r\nint ret = 0;\r\nmtk_venc_lock(ctx);\r\nmtk_vcodec_enc_clock_on(&ctx->dev->pm);\r\nret = ctx->enc_if->set_param(ctx->drv_handle, type, in);\r\nmtk_vcodec_enc_clock_off(&ctx->dev->pm);\r\nmtk_venc_unlock(ctx);\r\nreturn ret;\r\n}\r\nint venc_if_encode(struct mtk_vcodec_ctx *ctx,\r\nenum venc_start_opt opt, struct venc_frm_buf *frm_buf,\r\nstruct mtk_vcodec_mem *bs_buf,\r\nstruct venc_done_result *result)\r\n{\r\nint ret = 0;\r\nunsigned long flags;\r\nmtk_venc_lock(ctx);\r\nspin_lock_irqsave(&ctx->dev->irqlock, flags);\r\nctx->dev->curr_ctx = ctx;\r\nspin_unlock_irqrestore(&ctx->dev->irqlock, flags);\r\nmtk_vcodec_enc_clock_on(&ctx->dev->pm);\r\nret = ctx->enc_if->encode(ctx->drv_handle, opt, frm_buf,\r\nbs_buf, result);\r\nmtk_vcodec_enc_clock_off(&ctx->dev->pm);\r\nspin_lock_irqsave(&ctx->dev->irqlock, flags);\r\nctx->dev->curr_ctx = NULL;\r\nspin_unlock_irqrestore(&ctx->dev->irqlock, flags);\r\nmtk_venc_unlock(ctx);\r\nreturn ret;\r\n}\r\nint venc_if_deinit(struct mtk_vcodec_ctx *ctx)\r\n{\r\nint ret = 0;\r\nif (ctx->drv_handle == 0)\r\nreturn 0;\r\nmtk_venc_lock(ctx);\r\nmtk_vcodec_enc_clock_on(&ctx->dev->pm);\r\nret = ctx->enc_if->deinit(ctx->drv_handle);\r\nmtk_vcodec_enc_clock_off(&ctx->dev->pm);\r\nmtk_venc_unlock(ctx);\r\nctx->drv_handle = 0;\r\nreturn ret;\r\n}

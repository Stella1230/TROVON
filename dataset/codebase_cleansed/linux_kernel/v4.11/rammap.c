u32\r\nnvbios_rammapTe(struct nvkm_bios *bios, u8 *ver, u8 *hdr,\r\nu8 *cnt, u8 *len, u8 *snr, u8 *ssz)\r\n{\r\nstruct bit_entry bit_P;\r\nu32 rammap = 0x0000;\r\nif (!bit_entry(bios, 'P', &bit_P)) {\r\nif (bit_P.version == 2)\r\nrammap = nvbios_rd32(bios, bit_P.offset + 4);\r\nif (rammap) {\r\n*ver = nvbios_rd08(bios, rammap + 0);\r\nswitch (*ver) {\r\ncase 0x10:\r\ncase 0x11:\r\n*hdr = nvbios_rd08(bios, rammap + 1);\r\n*cnt = nvbios_rd08(bios, rammap + 5);\r\n*len = nvbios_rd08(bios, rammap + 2);\r\n*snr = nvbios_rd08(bios, rammap + 4);\r\n*ssz = nvbios_rd08(bios, rammap + 3);\r\nreturn rammap;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn 0x0000;\r\n}\r\nu32\r\nnvbios_rammapEe(struct nvkm_bios *bios, int idx,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len)\r\n{\r\nu8 snr, ssz;\r\nu32 rammap = nvbios_rammapTe(bios, ver, hdr, cnt, len, &snr, &ssz);\r\nif (rammap && idx < *cnt) {\r\nrammap = rammap + *hdr + (idx * (*len + (snr * ssz)));\r\n*hdr = *len;\r\n*cnt = snr;\r\n*len = ssz;\r\nreturn rammap;\r\n}\r\nreturn 0x0000;\r\n}\r\nu32\r\nnvbios_rammapEp_from_perf(struct nvkm_bios *bios, u32 data, u8 size,\r\nstruct nvbios_ramcfg *p)\r\n{\r\nmemset(p, 0x00, sizeof(*p));\r\np->rammap_00_16_20 = (nvbios_rd08(bios, data + 0x16) & 0x20) >> 5;\r\np->rammap_00_16_40 = (nvbios_rd08(bios, data + 0x16) & 0x40) >> 6;\r\np->rammap_00_17_02 = (nvbios_rd08(bios, data + 0x17) & 0x02) >> 1;\r\nreturn data;\r\n}\r\nu32\r\nnvbios_rammapEp(struct nvkm_bios *bios, int idx,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len, struct nvbios_ramcfg *p)\r\n{\r\nu32 data = nvbios_rammapEe(bios, idx, ver, hdr, cnt, len), temp;\r\nmemset(p, 0x00, sizeof(*p));\r\np->rammap_ver = *ver;\r\np->rammap_hdr = *hdr;\r\nswitch (!!data * *ver) {\r\ncase 0x10:\r\np->rammap_min = nvbios_rd16(bios, data + 0x00);\r\np->rammap_max = nvbios_rd16(bios, data + 0x02);\r\np->rammap_10_04_02 = (nvbios_rd08(bios, data + 0x04) & 0x02) >> 1;\r\np->rammap_10_04_08 = (nvbios_rd08(bios, data + 0x04) & 0x08) >> 3;\r\nbreak;\r\ncase 0x11:\r\np->rammap_min = nvbios_rd16(bios, data + 0x00);\r\np->rammap_max = nvbios_rd16(bios, data + 0x02);\r\np->rammap_11_08_01 = (nvbios_rd08(bios, data + 0x08) & 0x01) >> 0;\r\np->rammap_11_08_0c = (nvbios_rd08(bios, data + 0x08) & 0x0c) >> 2;\r\np->rammap_11_08_10 = (nvbios_rd08(bios, data + 0x08) & 0x10) >> 4;\r\ntemp = nvbios_rd32(bios, data + 0x09);\r\np->rammap_11_09_01ff = (temp & 0x000001ff) >> 0;\r\np->rammap_11_0a_03fe = (temp & 0x0003fe00) >> 9;\r\np->rammap_11_0a_0400 = (temp & 0x00040000) >> 18;\r\np->rammap_11_0a_0800 = (temp & 0x00080000) >> 19;\r\np->rammap_11_0b_01f0 = (temp & 0x01f00000) >> 20;\r\np->rammap_11_0b_0200 = (temp & 0x02000000) >> 25;\r\np->rammap_11_0b_0400 = (temp & 0x04000000) >> 26;\r\np->rammap_11_0b_0800 = (temp & 0x08000000) >> 27;\r\np->rammap_11_0d = nvbios_rd08(bios, data + 0x0d);\r\np->rammap_11_0e = nvbios_rd08(bios, data + 0x0e);\r\np->rammap_11_0f = nvbios_rd08(bios, data + 0x0f);\r\np->rammap_11_11_0c = (nvbios_rd08(bios, data + 0x11) & 0x0c) >> 2;\r\nbreak;\r\ndefault:\r\ndata = 0;\r\nbreak;\r\n}\r\nreturn data;\r\n}\r\nu32\r\nnvbios_rammapEm(struct nvkm_bios *bios, u16 mhz,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len, struct nvbios_ramcfg *info)\r\n{\r\nint idx = 0;\r\nu32 data;\r\nwhile ((data = nvbios_rammapEp(bios, idx++, ver, hdr, cnt, len, info))) {\r\nif (mhz >= info->rammap_min && mhz <= info->rammap_max)\r\nbreak;\r\n}\r\nreturn data;\r\n}\r\nu32\r\nnvbios_rammapSe(struct nvkm_bios *bios, u32 data,\r\nu8 ever, u8 ehdr, u8 ecnt, u8 elen, int idx, u8 *ver, u8 *hdr)\r\n{\r\nif (idx < ecnt) {\r\ndata = data + ehdr + (idx * elen);\r\n*ver = ever;\r\n*hdr = elen;\r\nreturn data;\r\n}\r\nreturn 0;\r\n}\r\nu32\r\nnvbios_rammapSp_from_perf(struct nvkm_bios *bios, u32 data, u8 size, int idx,\r\nstruct nvbios_ramcfg *p)\r\n{\r\ndata += (idx * size);\r\nif (size < 11)\r\nreturn 0x00000000;\r\np->ramcfg_ver = 0;\r\np->ramcfg_timing = nvbios_rd08(bios, data + 0x01);\r\np->ramcfg_00_03_01 = (nvbios_rd08(bios, data + 0x03) & 0x01) >> 0;\r\np->ramcfg_00_03_02 = (nvbios_rd08(bios, data + 0x03) & 0x02) >> 1;\r\np->ramcfg_DLLoff = (nvbios_rd08(bios, data + 0x03) & 0x04) >> 2;\r\np->ramcfg_00_03_08 = (nvbios_rd08(bios, data + 0x03) & 0x08) >> 3;\r\np->ramcfg_RON = (nvbios_rd08(bios, data + 0x03) & 0x10) >> 3;\r\np->ramcfg_FBVDDQ = (nvbios_rd08(bios, data + 0x03) & 0x80) >> 7;\r\np->ramcfg_00_04_02 = (nvbios_rd08(bios, data + 0x04) & 0x02) >> 1;\r\np->ramcfg_00_04_04 = (nvbios_rd08(bios, data + 0x04) & 0x04) >> 2;\r\np->ramcfg_00_04_20 = (nvbios_rd08(bios, data + 0x04) & 0x20) >> 5;\r\np->ramcfg_00_05 = (nvbios_rd08(bios, data + 0x05) & 0xff) >> 0;\r\np->ramcfg_00_06 = (nvbios_rd08(bios, data + 0x06) & 0xff) >> 0;\r\np->ramcfg_00_07 = (nvbios_rd08(bios, data + 0x07) & 0xff) >> 0;\r\np->ramcfg_00_08 = (nvbios_rd08(bios, data + 0x08) & 0xff) >> 0;\r\np->ramcfg_00_09 = (nvbios_rd08(bios, data + 0x09) & 0xff) >> 0;\r\np->ramcfg_00_0a_0f = (nvbios_rd08(bios, data + 0x0a) & 0x0f) >> 0;\r\np->ramcfg_00_0a_f0 = (nvbios_rd08(bios, data + 0x0a) & 0xf0) >> 4;\r\nreturn data;\r\n}\r\nu32\r\nnvbios_rammapSp(struct nvkm_bios *bios, u32 data,\r\nu8 ever, u8 ehdr, u8 ecnt, u8 elen, int idx,\r\nu8 *ver, u8 *hdr, struct nvbios_ramcfg *p)\r\n{\r\ndata = nvbios_rammapSe(bios, data, ever, ehdr, ecnt, elen, idx, ver, hdr);\r\np->ramcfg_ver = *ver;\r\np->ramcfg_hdr = *hdr;\r\nswitch (!!data * *ver) {\r\ncase 0x10:\r\np->ramcfg_timing = nvbios_rd08(bios, data + 0x01);\r\np->ramcfg_10_02_01 = (nvbios_rd08(bios, data + 0x02) & 0x01) >> 0;\r\np->ramcfg_10_02_02 = (nvbios_rd08(bios, data + 0x02) & 0x02) >> 1;\r\np->ramcfg_10_02_04 = (nvbios_rd08(bios, data + 0x02) & 0x04) >> 2;\r\np->ramcfg_10_02_08 = (nvbios_rd08(bios, data + 0x02) & 0x08) >> 3;\r\np->ramcfg_10_02_10 = (nvbios_rd08(bios, data + 0x02) & 0x10) >> 4;\r\np->ramcfg_10_02_20 = (nvbios_rd08(bios, data + 0x02) & 0x20) >> 5;\r\np->ramcfg_DLLoff = (nvbios_rd08(bios, data + 0x02) & 0x40) >> 6;\r\np->ramcfg_10_03_0f = (nvbios_rd08(bios, data + 0x03) & 0x0f) >> 0;\r\np->ramcfg_10_04_01 = (nvbios_rd08(bios, data + 0x04) & 0x01) >> 0;\r\np->ramcfg_FBVDDQ = (nvbios_rd08(bios, data + 0x04) & 0x08) >> 3;\r\np->ramcfg_10_05 = (nvbios_rd08(bios, data + 0x05) & 0xff) >> 0;\r\np->ramcfg_10_06 = (nvbios_rd08(bios, data + 0x06) & 0xff) >> 0;\r\np->ramcfg_10_07 = (nvbios_rd08(bios, data + 0x07) & 0xff) >> 0;\r\np->ramcfg_10_08 = (nvbios_rd08(bios, data + 0x08) & 0xff) >> 0;\r\np->ramcfg_10_09_0f = (nvbios_rd08(bios, data + 0x09) & 0x0f) >> 0;\r\np->ramcfg_10_09_f0 = (nvbios_rd08(bios, data + 0x09) & 0xf0) >> 4;\r\nbreak;\r\ncase 0x11:\r\np->ramcfg_timing = nvbios_rd08(bios, data + 0x00);\r\np->ramcfg_11_01_01 = (nvbios_rd08(bios, data + 0x01) & 0x01) >> 0;\r\np->ramcfg_11_01_02 = (nvbios_rd08(bios, data + 0x01) & 0x02) >> 1;\r\np->ramcfg_11_01_04 = (nvbios_rd08(bios, data + 0x01) & 0x04) >> 2;\r\np->ramcfg_11_01_08 = (nvbios_rd08(bios, data + 0x01) & 0x08) >> 3;\r\np->ramcfg_11_01_10 = (nvbios_rd08(bios, data + 0x01) & 0x10) >> 4;\r\np->ramcfg_DLLoff = (nvbios_rd08(bios, data + 0x01) & 0x20) >> 5;\r\np->ramcfg_11_01_40 = (nvbios_rd08(bios, data + 0x01) & 0x40) >> 6;\r\np->ramcfg_11_01_80 = (nvbios_rd08(bios, data + 0x01) & 0x80) >> 7;\r\np->ramcfg_11_02_03 = (nvbios_rd08(bios, data + 0x02) & 0x03) >> 0;\r\np->ramcfg_11_02_04 = (nvbios_rd08(bios, data + 0x02) & 0x04) >> 2;\r\np->ramcfg_11_02_08 = (nvbios_rd08(bios, data + 0x02) & 0x08) >> 3;\r\np->ramcfg_11_02_10 = (nvbios_rd08(bios, data + 0x02) & 0x10) >> 4;\r\np->ramcfg_11_02_40 = (nvbios_rd08(bios, data + 0x02) & 0x40) >> 6;\r\np->ramcfg_11_02_80 = (nvbios_rd08(bios, data + 0x02) & 0x80) >> 7;\r\np->ramcfg_11_03_0f = (nvbios_rd08(bios, data + 0x03) & 0x0f) >> 0;\r\np->ramcfg_11_03_30 = (nvbios_rd08(bios, data + 0x03) & 0x30) >> 4;\r\np->ramcfg_11_03_c0 = (nvbios_rd08(bios, data + 0x03) & 0xc0) >> 6;\r\np->ramcfg_11_03_f0 = (nvbios_rd08(bios, data + 0x03) & 0xf0) >> 4;\r\np->ramcfg_11_04 = (nvbios_rd08(bios, data + 0x04) & 0xff) >> 0;\r\np->ramcfg_11_06 = (nvbios_rd08(bios, data + 0x06) & 0xff) >> 0;\r\np->ramcfg_11_07_02 = (nvbios_rd08(bios, data + 0x07) & 0x02) >> 1;\r\np->ramcfg_11_07_04 = (nvbios_rd08(bios, data + 0x07) & 0x04) >> 2;\r\np->ramcfg_11_07_08 = (nvbios_rd08(bios, data + 0x07) & 0x08) >> 3;\r\np->ramcfg_11_07_10 = (nvbios_rd08(bios, data + 0x07) & 0x10) >> 4;\r\np->ramcfg_11_07_40 = (nvbios_rd08(bios, data + 0x07) & 0x40) >> 6;\r\np->ramcfg_11_07_80 = (nvbios_rd08(bios, data + 0x07) & 0x80) >> 7;\r\np->ramcfg_11_08_01 = (nvbios_rd08(bios, data + 0x08) & 0x01) >> 0;\r\np->ramcfg_11_08_02 = (nvbios_rd08(bios, data + 0x08) & 0x02) >> 1;\r\np->ramcfg_11_08_04 = (nvbios_rd08(bios, data + 0x08) & 0x04) >> 2;\r\np->ramcfg_11_08_08 = (nvbios_rd08(bios, data + 0x08) & 0x08) >> 3;\r\np->ramcfg_11_08_10 = (nvbios_rd08(bios, data + 0x08) & 0x10) >> 4;\r\np->ramcfg_11_08_20 = (nvbios_rd08(bios, data + 0x08) & 0x20) >> 5;\r\np->ramcfg_11_09 = (nvbios_rd08(bios, data + 0x09) & 0xff) >> 0;\r\nbreak;\r\ndefault:\r\ndata = 0;\r\nbreak;\r\n}\r\nreturn data;\r\n}

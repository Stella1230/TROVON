static int rmi_f55_detect(struct rmi_function *fn)\r\n{\r\nstruct rmi_device *rmi_dev = fn->rmi_dev;\r\nstruct rmi_driver_data *drv_data = dev_get_drvdata(&rmi_dev->dev);\r\nstruct f55_data *f55;\r\nint error;\r\nf55 = dev_get_drvdata(&fn->dev);\r\nerror = rmi_read_block(fn->rmi_dev, fn->fd.query_base_addr,\r\n&f55->qry, sizeof(f55->qry));\r\nif (error) {\r\ndev_err(&fn->dev, "%s: Failed to query F55 properties\n",\r\n__func__);\r\nreturn error;\r\n}\r\nf55->num_rx_electrodes = f55->qry[F55_NUM_RX_OFFSET];\r\nf55->num_tx_electrodes = f55->qry[F55_NUM_TX_OFFSET];\r\nf55->cfg_num_rx_electrodes = f55->num_rx_electrodes;\r\nf55->cfg_num_tx_electrodes = f55->num_rx_electrodes;\r\ndrv_data->num_rx_electrodes = f55->cfg_num_rx_electrodes;\r\ndrv_data->num_tx_electrodes = f55->cfg_num_rx_electrodes;\r\nif (f55->qry[F55_PHYS_CHAR_OFFSET] & F55_CAP_SENSOR_ASSIGN) {\r\nint i, total;\r\nu8 buf[256];\r\nerror = rmi_read_block(fn->rmi_dev,\r\nfn->fd.control_base_addr + 1,\r\nbuf, f55->num_rx_electrodes);\r\nif (!error) {\r\ntotal = 0;\r\nfor (i = 0; i < f55->num_rx_electrodes; i++) {\r\nif (buf[i] != 0xff)\r\ntotal++;\r\n}\r\nf55->cfg_num_rx_electrodes = total;\r\ndrv_data->num_rx_electrodes = total;\r\n}\r\nerror = rmi_read_block(fn->rmi_dev,\r\nfn->fd.control_base_addr + 2,\r\nbuf, f55->num_tx_electrodes);\r\nif (!error) {\r\ntotal = 0;\r\nfor (i = 0; i < f55->num_tx_electrodes; i++) {\r\nif (buf[i] != 0xff)\r\ntotal++;\r\n}\r\nf55->cfg_num_tx_electrodes = total;\r\ndrv_data->num_tx_electrodes = total;\r\n}\r\n}\r\nrmi_dbg(RMI_DEBUG_FN, &fn->dev, "F55 num_rx_electrodes: %d (raw %d)\n",\r\nf55->cfg_num_rx_electrodes, f55->num_rx_electrodes);\r\nrmi_dbg(RMI_DEBUG_FN, &fn->dev, "F55 num_tx_electrodes: %d (raw %d)\n",\r\nf55->cfg_num_tx_electrodes, f55->num_tx_electrodes);\r\nreturn 0;\r\n}\r\nstatic int rmi_f55_probe(struct rmi_function *fn)\r\n{\r\nstruct f55_data *f55;\r\nf55 = devm_kzalloc(&fn->dev, sizeof(struct f55_data), GFP_KERNEL);\r\nif (!f55)\r\nreturn -ENOMEM;\r\nf55->fn = fn;\r\ndev_set_drvdata(&fn->dev, f55);\r\nreturn rmi_f55_detect(fn);\r\n}

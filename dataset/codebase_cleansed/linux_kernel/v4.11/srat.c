void __init\r\nacpi_numa_x2apic_affinity_init(struct acpi_srat_x2apic_cpu_affinity *pa)\r\n{\r\nint pxm, node;\r\nint apic_id;\r\nif (srat_disabled())\r\nreturn;\r\nif (pa->header.length < sizeof(struct acpi_srat_x2apic_cpu_affinity)) {\r\nbad_srat();\r\nreturn;\r\n}\r\nif ((pa->flags & ACPI_SRAT_CPU_ENABLED) == 0)\r\nreturn;\r\npxm = pa->proximity_domain;\r\napic_id = pa->apic_id;\r\nif (!apic->apic_id_valid(apic_id)) {\r\nprintk(KERN_INFO "SRAT: PXM %u -> X2APIC 0x%04x ignored\n",\r\npxm, apic_id);\r\nreturn;\r\n}\r\nnode = acpi_map_pxm_to_node(pxm);\r\nif (node < 0) {\r\nprintk(KERN_ERR "SRAT: Too many proximity domains %x\n", pxm);\r\nbad_srat();\r\nreturn;\r\n}\r\nif (apic_id >= MAX_LOCAL_APIC) {\r\nprintk(KERN_INFO "SRAT: PXM %u -> APIC 0x%04x -> Node %u skipped apicid that is too big\n", pxm, apic_id, node);\r\nreturn;\r\n}\r\nset_apicid_to_node(apic_id, node);\r\nnode_set(node, numa_nodes_parsed);\r\nprintk(KERN_INFO "SRAT: PXM %u -> APIC 0x%04x -> Node %u\n",\r\npxm, apic_id, node);\r\n}\r\nvoid __init\r\nacpi_numa_processor_affinity_init(struct acpi_srat_cpu_affinity *pa)\r\n{\r\nint pxm, node;\r\nint apic_id;\r\nif (srat_disabled())\r\nreturn;\r\nif (pa->header.length != sizeof(struct acpi_srat_cpu_affinity)) {\r\nbad_srat();\r\nreturn;\r\n}\r\nif ((pa->flags & ACPI_SRAT_CPU_ENABLED) == 0)\r\nreturn;\r\npxm = pa->proximity_domain_lo;\r\nif (acpi_srat_revision >= 2)\r\npxm |= *((unsigned int*)pa->proximity_domain_hi) << 8;\r\nnode = acpi_map_pxm_to_node(pxm);\r\nif (node < 0) {\r\nprintk(KERN_ERR "SRAT: Too many proximity domains %x\n", pxm);\r\nbad_srat();\r\nreturn;\r\n}\r\nif (get_uv_system_type() >= UV_X2APIC)\r\napic_id = (pa->apic_id << 8) | pa->local_sapic_eid;\r\nelse\r\napic_id = pa->apic_id;\r\nif (apic_id >= MAX_LOCAL_APIC) {\r\nprintk(KERN_INFO "SRAT: PXM %u -> APIC 0x%02x -> Node %u skipped apicid that is too big\n", pxm, apic_id, node);\r\nreturn;\r\n}\r\nset_apicid_to_node(apic_id, node);\r\nnode_set(node, numa_nodes_parsed);\r\nprintk(KERN_INFO "SRAT: PXM %u -> APIC 0x%02x -> Node %u\n",\r\npxm, apic_id, node);\r\n}\r\nint __init x86_acpi_numa_init(void)\r\n{\r\nint ret;\r\nret = acpi_numa_init();\r\nif (ret < 0)\r\nreturn ret;\r\nreturn srat_disabled() ? -EINVAL : 0;\r\n}

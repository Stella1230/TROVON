int read_block(char *buf, int buf_size, FILE *fin)\r\n{\r\nchar *curr = buf, *const buf_end = buf + buf_size;\r\nwhile (buf_end - curr > 1 && fgets(curr, buf_end - curr, fin)) {\r\nif (*curr == '\n')\r\nreturn curr - buf;\r\ncurr += strlen(curr);\r\n}\r\nreturn -1;\r\n}\r\nstatic int compare_txt(const void *p1, const void *p2)\r\n{\r\nconst struct block_list *l1 = p1, *l2 = p2;\r\nreturn strcmp(l1->txt, l2->txt);\r\n}\r\nstatic int compare_num(const void *p1, const void *p2)\r\n{\r\nconst struct block_list *l1 = p1, *l2 = p2;\r\nreturn l2->num - l1->num;\r\n}\r\nstatic void add_list(char *buf, int len)\r\n{\r\nif (list_size != 0 &&\r\nlen == list[list_size-1].len &&\r\nmemcmp(buf, list[list_size-1].txt, len) == 0) {\r\nlist[list_size-1].num++;\r\nreturn;\r\n}\r\nif (list_size == max_size) {\r\nprintf("max_size too small??\n");\r\nexit(1);\r\n}\r\nlist[list_size].txt = malloc(len+1);\r\nlist[list_size].len = len;\r\nlist[list_size].num = 1;\r\nmemcpy(list[list_size].txt, buf, len);\r\nlist[list_size].txt[len] = 0;\r\nlist_size++;\r\nif (list_size % 1000 == 0) {\r\nprintf("loaded %d\r", list_size);\r\nfflush(stdout);\r\n}\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nFILE *fin, *fout;\r\nchar *buf;\r\nint ret, i, count;\r\nstruct block_list *list2;\r\nstruct stat st;\r\nif (argc < 3) {\r\nprintf("Usage: ./program <input> <output>\n");\r\nperror("open: ");\r\nexit(1);\r\n}\r\nfin = fopen(argv[1], "r");\r\nfout = fopen(argv[2], "w");\r\nif (!fin || !fout) {\r\nprintf("Usage: ./program <input> <output>\n");\r\nperror("open: ");\r\nexit(1);\r\n}\r\nfstat(fileno(fin), &st);\r\nmax_size = st.st_size / 100;\r\nlist = malloc(max_size * sizeof(*list));\r\nbuf = malloc(BUF_SIZE);\r\nif (!list || !buf) {\r\nprintf("Out of memory\n");\r\nexit(1);\r\n}\r\nfor ( ; ; ) {\r\nret = read_block(buf, BUF_SIZE, fin);\r\nif (ret < 0)\r\nbreak;\r\nadd_list(buf, ret);\r\n}\r\nprintf("loaded %d\n", list_size);\r\nprintf("sorting ....\n");\r\nqsort(list, list_size, sizeof(list[0]), compare_txt);\r\nlist2 = malloc(sizeof(*list) * list_size);\r\nprintf("culling\n");\r\nfor (i = count = 0; i < list_size; i++) {\r\nif (count == 0 ||\r\nstrcmp(list2[count-1].txt, list[i].txt) != 0) {\r\nlist2[count++] = list[i];\r\n} else {\r\nlist2[count-1].num += list[i].num;\r\n}\r\n}\r\nqsort(list2, count, sizeof(list[0]), compare_num);\r\nfor (i = 0; i < count; i++)\r\nfprintf(fout, "%d times:\n%s\n", list2[i].num, list2[i].txt);\r\nreturn 0;\r\n}

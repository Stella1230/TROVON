static unsigned long fman_muram_vbase_to_offset(struct muram_info *muram,\r\nunsigned long vaddr)\r\n{\r\nreturn vaddr - (unsigned long)muram->vbase;\r\n}\r\nstruct muram_info *fman_muram_init(phys_addr_t base, size_t size)\r\n{\r\nstruct muram_info *muram;\r\nvoid __iomem *vaddr;\r\nint ret;\r\nmuram = kzalloc(sizeof(*muram), GFP_KERNEL);\r\nif (!muram)\r\nreturn NULL;\r\nmuram->pool = gen_pool_create(ilog2(64), -1);\r\nif (!muram->pool) {\r\npr_err("%s(): MURAM pool create failed\n", __func__);\r\ngoto muram_free;\r\n}\r\nvaddr = ioremap(base, size);\r\nif (!vaddr) {\r\npr_err("%s(): MURAM ioremap failed\n", __func__);\r\ngoto pool_destroy;\r\n}\r\nret = gen_pool_add_virt(muram->pool, (unsigned long)vaddr,\r\nbase, size, -1);\r\nif (ret < 0) {\r\npr_err("%s(): MURAM pool add failed\n", __func__);\r\niounmap(vaddr);\r\ngoto pool_destroy;\r\n}\r\nmemset_io(vaddr, 0, (int)size);\r\nmuram->vbase = vaddr;\r\nmuram->pbase = base;\r\nreturn muram;\r\npool_destroy:\r\ngen_pool_destroy(muram->pool);\r\nmuram_free:\r\nkfree(muram);\r\nreturn NULL;\r\n}\r\nunsigned long fman_muram_offset_to_vbase(struct muram_info *muram,\r\nunsigned long offset)\r\n{\r\nreturn offset + (unsigned long)muram->vbase;\r\n}\r\nunsigned long fman_muram_alloc(struct muram_info *muram, size_t size)\r\n{\r\nunsigned long vaddr;\r\nvaddr = gen_pool_alloc(muram->pool, size);\r\nif (!vaddr)\r\nreturn -ENOMEM;\r\nmemset_io((void __iomem *)vaddr, 0, size);\r\nreturn fman_muram_vbase_to_offset(muram, vaddr);\r\n}\r\nvoid fman_muram_free_mem(struct muram_info *muram, unsigned long offset,\r\nsize_t size)\r\n{\r\nunsigned long addr = fman_muram_offset_to_vbase(muram, offset);\r\ngen_pool_free(muram->pool, addr, size);\r\n}

static void print_audio_widget(struct snd_info_buffer *buffer,\r\nstruct lola *chip, int nid, const char *name)\r\n{\r\nunsigned int val;\r\nlola_read_param(chip, nid, LOLA_PAR_AUDIO_WIDGET_CAP, &val);\r\nsnd_iprintf(buffer, "Node 0x%02x %s wcaps 0x%x\n", nid, name, val);\r\nlola_read_param(chip, nid, LOLA_PAR_STREAM_FORMATS, &val);\r\nsnd_iprintf(buffer, " Formats: 0x%x\n", val);\r\n}\r\nstatic void print_pin_widget(struct snd_info_buffer *buffer,\r\nstruct lola *chip, int nid, unsigned int ampcap,\r\nconst char *name)\r\n{\r\nunsigned int val;\r\nlola_read_param(chip, nid, LOLA_PAR_AUDIO_WIDGET_CAP, &val);\r\nsnd_iprintf(buffer, "Node 0x%02x %s wcaps 0x%x\n", nid, name, val);\r\nif (val == 0x00400200)\r\nreturn;\r\nlola_read_param(chip, nid, ampcap, &val);\r\nsnd_iprintf(buffer, " Amp-Caps: 0x%x\n", val);\r\nsnd_iprintf(buffer, " mute=%d, step-size=%d, steps=%d, ofs=%d\n",\r\nLOLA_AMP_MUTE_CAPABLE(val),\r\nLOLA_AMP_STEP_SIZE(val),\r\nLOLA_AMP_NUM_STEPS(val),\r\nLOLA_AMP_OFFSET(val));\r\nlola_codec_read(chip, nid, LOLA_VERB_GET_MAX_LEVEL, 0, 0, &val, NULL);\r\nsnd_iprintf(buffer, " Max-level: 0x%x\n", val);\r\n}\r\nstatic void print_clock_widget(struct snd_info_buffer *buffer,\r\nstruct lola *chip, int nid)\r\n{\r\nint i, j, num_clocks;\r\nunsigned int val;\r\nlola_read_param(chip, nid, LOLA_PAR_AUDIO_WIDGET_CAP, &val);\r\nsnd_iprintf(buffer, "Node 0x%02x [Clock] wcaps 0x%x\n", nid, val);\r\nnum_clocks = val & 0xff;\r\nfor (i = 0; i < num_clocks; i += 4) {\r\nunsigned int res_ex;\r\nunsigned short items[4];\r\nconst char *name;\r\nlola_codec_read(chip, nid, LOLA_VERB_GET_CLOCK_LIST,\r\ni, 0, &val, &res_ex);\r\nitems[0] = val & 0xfff;\r\nitems[1] = (val >> 16) & 0xfff;\r\nitems[2] = res_ex & 0xfff;\r\nitems[3] = (res_ex >> 16) & 0xfff;\r\nfor (j = 0; j < 4; j++) {\r\nunsigned char type = items[j] >> 8;\r\nunsigned int freq = items[j] & 0xff;\r\nif (i + j >= num_clocks)\r\nbreak;\r\nif (type == LOLA_CLOCK_TYPE_INTERNAL) {\r\nname = "Internal";\r\nfreq = lola_sample_rate_convert(freq);\r\n} else if (type == LOLA_CLOCK_TYPE_VIDEO) {\r\nname = "Video";\r\nfreq = lola_sample_rate_convert(freq);\r\n} else {\r\nname = "Other";\r\n}\r\nsnd_iprintf(buffer, " Clock %d: Type %d:%s, freq=%d\n",\r\ni + j, type, name, freq);\r\n}\r\n}\r\n}\r\nstatic void print_mixer_widget(struct snd_info_buffer *buffer,\r\nstruct lola *chip, int nid)\r\n{\r\nunsigned int val;\r\nlola_read_param(chip, nid, LOLA_PAR_AUDIO_WIDGET_CAP, &val);\r\nsnd_iprintf(buffer, "Node 0x%02x [Mixer] wcaps 0x%x\n", nid, val);\r\n}\r\nstatic void lola_proc_codec_read(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct lola *chip = entry->private_data;\r\nunsigned int val;\r\nint i, nid;\r\nlola_read_param(chip, 0, LOLA_PAR_VENDOR_ID, &val);\r\nsnd_iprintf(buffer, "Vendor: 0x%08x\n", val);\r\nlola_read_param(chip, 1, LOLA_PAR_FUNCTION_TYPE, &val);\r\nsnd_iprintf(buffer, "Function Type: %d\n", val);\r\nlola_read_param(chip, 1, LOLA_PAR_SPECIFIC_CAPS, &val);\r\nsnd_iprintf(buffer, "Specific-Caps: 0x%08x\n", val);\r\nsnd_iprintf(buffer, " Pins-In %d, Pins-Out %d\n",\r\nchip->pin[CAPT].num_pins, chip->pin[PLAY].num_pins);\r\nnid = 2;\r\nfor (i = 0; i < chip->pcm[CAPT].num_streams; i++, nid++)\r\nprint_audio_widget(buffer, chip, nid, "[Audio-In]");\r\nfor (i = 0; i < chip->pcm[PLAY].num_streams; i++, nid++)\r\nprint_audio_widget(buffer, chip, nid, "[Audio-Out]");\r\nfor (i = 0; i < chip->pin[CAPT].num_pins; i++, nid++)\r\nprint_pin_widget(buffer, chip, nid, LOLA_PAR_AMP_IN_CAP,\r\n"[Pin-In]");\r\nfor (i = 0; i < chip->pin[PLAY].num_pins; i++, nid++)\r\nprint_pin_widget(buffer, chip, nid, LOLA_PAR_AMP_OUT_CAP,\r\n"[Pin-Out]");\r\nif (LOLA_AFG_CLOCK_WIDGET_PRESENT(chip->lola_caps)) {\r\nprint_clock_widget(buffer, chip, nid);\r\nnid++;\r\n}\r\nif (LOLA_AFG_MIXER_WIDGET_PRESENT(chip->lola_caps)) {\r\nprint_mixer_widget(buffer, chip, nid);\r\nnid++;\r\n}\r\n}\r\nstatic void lola_proc_codec_rw_write(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct lola *chip = entry->private_data;\r\nchar line[64];\r\nunsigned int id, verb, data, extdata;\r\nwhile (!snd_info_get_line(buffer, line, sizeof(line))) {\r\nif (sscanf(line, "%u %u %u %u", &id, &verb, &data, &extdata) != 4)\r\ncontinue;\r\nlola_codec_read(chip, id, verb, data, extdata,\r\n&chip->debug_res,\r\n&chip->debug_res_ex);\r\n}\r\n}\r\nstatic void lola_proc_codec_rw_read(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct lola *chip = entry->private_data;\r\nsnd_iprintf(buffer, "0x%x 0x%x\n", chip->debug_res, chip->debug_res_ex);\r\n}\r\nstatic void lola_proc_regs_read(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct lola *chip = entry->private_data;\r\nint i;\r\nfor (i = 0; i < 0x40; i += 4) {\r\nsnd_iprintf(buffer, "BAR0 %02x: %08x\n", i,\r\nreadl(chip->bar[BAR0].remap_addr + i));\r\n}\r\nsnd_iprintf(buffer, "\n");\r\nfor (i = 0; i < 0x30; i += 4) {\r\nsnd_iprintf(buffer, "BAR1 %02x: %08x\n", i,\r\nreadl(chip->bar[BAR1].remap_addr + i));\r\n}\r\nsnd_iprintf(buffer, "\n");\r\nfor (i = 0x80; i < 0xa0; i += 4) {\r\nsnd_iprintf(buffer, "BAR1 %02x: %08x\n", i,\r\nreadl(chip->bar[BAR1].remap_addr + i));\r\n}\r\nsnd_iprintf(buffer, "\n");\r\nfor (i = 0; i < 32; i++) {\r\nsnd_iprintf(buffer, "DSD %02x STS %08x\n", i,\r\nlola_dsd_read(chip, i, STS));\r\nsnd_iprintf(buffer, "DSD %02x LPIB %08x\n", i,\r\nlola_dsd_read(chip, i, LPIB));\r\nsnd_iprintf(buffer, "DSD %02x CTL %08x\n", i,\r\nlola_dsd_read(chip, i, CTL));\r\nsnd_iprintf(buffer, "DSD %02x LVIL %08x\n", i,\r\nlola_dsd_read(chip, i, LVI));\r\nsnd_iprintf(buffer, "DSD %02x BDPL %08x\n", i,\r\nlola_dsd_read(chip, i, BDPL));\r\nsnd_iprintf(buffer, "DSD %02x BDPU %08x\n", i,\r\nlola_dsd_read(chip, i, BDPU));\r\n}\r\n}\r\nvoid lola_proc_debug_new(struct lola *chip)\r\n{\r\nstruct snd_info_entry *entry;\r\nif (!snd_card_proc_new(chip->card, "codec", &entry))\r\nsnd_info_set_text_ops(entry, chip, lola_proc_codec_read);\r\nif (!snd_card_proc_new(chip->card, "codec_rw", &entry)) {\r\nsnd_info_set_text_ops(entry, chip, lola_proc_codec_rw_read);\r\nentry->mode |= S_IWUSR;\r\nentry->c.text.write = lola_proc_codec_rw_write;\r\n}\r\nif (!snd_card_proc_new(chip->card, "regs", &entry))\r\nsnd_info_set_text_ops(entry, chip, lola_proc_regs_read);\r\n}

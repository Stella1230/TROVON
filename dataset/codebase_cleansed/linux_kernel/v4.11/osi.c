static u32 acpi_osi_handler(acpi_string interface, u32 supported)\r\n{\r\nif (!strcmp("Linux", interface)) {\r\npr_notice_once(FW_BUG\r\n"BIOS _OSI(Linux) query %s%s\n",\r\nosi_config.linux_enable ? "honored" : "ignored",\r\nosi_config.linux_cmdline ? " via cmdline" :\r\nosi_config.linux_dmi ? " via DMI" : "");\r\n}\r\nif (!strcmp("Darwin", interface)) {\r\npr_notice_once(\r\n"BIOS _OSI(Darwin) query %s%s\n",\r\nosi_config.darwin_enable ? "honored" : "ignored",\r\nosi_config.darwin_cmdline ? " via cmdline" :\r\nosi_config.darwin_dmi ? " via DMI" : "");\r\n}\r\nreturn supported;\r\n}\r\nvoid __init acpi_osi_setup(char *str)\r\n{\r\nstruct acpi_osi_entry *osi;\r\nbool enable = true;\r\nint i;\r\nif (!acpi_gbl_create_osi_method)\r\nreturn;\r\nif (str == NULL || *str == '\0') {\r\npr_info("_OSI method disabled\n");\r\nacpi_gbl_create_osi_method = FALSE;\r\nreturn;\r\n}\r\nif (*str == '!') {\r\nstr++;\r\nif (*str == '\0') {\r\nif (!osi_config.default_disabling)\r\nosi_config.default_disabling =\r\nACPI_DISABLE_ALL_VENDOR_STRINGS;\r\nreturn;\r\n} else if (*str == '*') {\r\nosi_config.default_disabling = ACPI_DISABLE_ALL_STRINGS;\r\nfor (i = 0; i < OSI_STRING_ENTRIES_MAX; i++) {\r\nosi = &osi_setup_entries[i];\r\nosi->enable = false;\r\n}\r\nreturn;\r\n} else if (*str == '!') {\r\nosi_config.default_disabling = 0;\r\nreturn;\r\n}\r\nenable = false;\r\n}\r\nfor (i = 0; i < OSI_STRING_ENTRIES_MAX; i++) {\r\nosi = &osi_setup_entries[i];\r\nif (!strcmp(osi->string, str)) {\r\nosi->enable = enable;\r\nbreak;\r\n} else if (osi->string[0] == '\0') {\r\nosi->enable = enable;\r\nstrncpy(osi->string, str, OSI_STRING_LENGTH_MAX);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void __init __acpi_osi_setup_darwin(bool enable)\r\n{\r\nosi_config.darwin_enable = !!enable;\r\nif (enable) {\r\nacpi_osi_setup("!");\r\nacpi_osi_setup("Darwin");\r\n} else {\r\nacpi_osi_setup("!!");\r\nacpi_osi_setup("!Darwin");\r\n}\r\n}\r\nstatic void __init acpi_osi_setup_darwin(bool enable)\r\n{\r\nosi_config.darwin_dmi = 0;\r\nosi_config.darwin_cmdline = 1;\r\n__acpi_osi_setup_darwin(enable);\r\n}\r\nstatic void __init __acpi_osi_setup_linux(bool enable)\r\n{\r\nosi_config.linux_enable = !!enable;\r\nif (enable)\r\nacpi_osi_setup("Linux");\r\nelse\r\nacpi_osi_setup("!Linux");\r\n}\r\nstatic void __init acpi_osi_setup_linux(bool enable)\r\n{\r\nosi_config.linux_dmi = 0;\r\nosi_config.linux_cmdline = 1;\r\n__acpi_osi_setup_linux(enable);\r\n}\r\nstatic void __init acpi_osi_setup_late(void)\r\n{\r\nstruct acpi_osi_entry *osi;\r\nchar *str;\r\nint i;\r\nacpi_status status;\r\nif (osi_config.default_disabling) {\r\nstatus = acpi_update_interfaces(osi_config.default_disabling);\r\nif (ACPI_SUCCESS(status))\r\npr_info("Disabled all _OSI OS vendors%s\n",\r\nosi_config.default_disabling ==\r\nACPI_DISABLE_ALL_STRINGS ?\r\n" and feature groups" : "");\r\n}\r\nfor (i = 0; i < OSI_STRING_ENTRIES_MAX; i++) {\r\nosi = &osi_setup_entries[i];\r\nstr = osi->string;\r\nif (*str == '\0')\r\nbreak;\r\nif (osi->enable) {\r\nstatus = acpi_install_interface(str);\r\nif (ACPI_SUCCESS(status))\r\npr_info("Added _OSI(%s)\n", str);\r\n} else {\r\nstatus = acpi_remove_interface(str);\r\nif (ACPI_SUCCESS(status))\r\npr_info("Deleted _OSI(%s)\n", str);\r\n}\r\n}\r\n}\r\nstatic int __init osi_setup(char *str)\r\n{\r\nif (str && !strcmp("Linux", str))\r\nacpi_osi_setup_linux(true);\r\nelse if (str && !strcmp("!Linux", str))\r\nacpi_osi_setup_linux(false);\r\nelse if (str && !strcmp("Darwin", str))\r\nacpi_osi_setup_darwin(true);\r\nelse if (str && !strcmp("!Darwin", str))\r\nacpi_osi_setup_darwin(false);\r\nelse\r\nacpi_osi_setup(str);\r\nreturn 1;\r\n}\r\nbool acpi_osi_is_win8(void)\r\n{\r\nreturn acpi_gbl_osi_data >= ACPI_OSI_WIN_8;\r\n}\r\nstatic void __init acpi_osi_dmi_darwin(bool enable,\r\nconst struct dmi_system_id *d)\r\n{\r\npr_notice("DMI detected to setup _OSI(\"Darwin\"): %s\n", d->ident);\r\nosi_config.darwin_dmi = 1;\r\n__acpi_osi_setup_darwin(enable);\r\n}\r\nvoid __init acpi_osi_dmi_linux(bool enable, const struct dmi_system_id *d)\r\n{\r\npr_notice("DMI detected to setup _OSI(\"Linux\"): %s\n", d->ident);\r\nosi_config.linux_dmi = 1;\r\n__acpi_osi_setup_linux(enable);\r\n}\r\nstatic int __init dmi_enable_osi_darwin(const struct dmi_system_id *d)\r\n{\r\nacpi_osi_dmi_darwin(true, d);\r\nreturn 0;\r\n}\r\nstatic int __init dmi_enable_osi_linux(const struct dmi_system_id *d)\r\n{\r\nacpi_osi_dmi_linux(true, d);\r\nreturn 0;\r\n}\r\nstatic int __init dmi_disable_osi_vista(const struct dmi_system_id *d)\r\n{\r\npr_notice("DMI detected: %s\n", d->ident);\r\nacpi_osi_setup("!Windows 2006");\r\nacpi_osi_setup("!Windows 2006 SP1");\r\nacpi_osi_setup("!Windows 2006 SP2");\r\nreturn 0;\r\n}\r\nstatic int __init dmi_disable_osi_win7(const struct dmi_system_id *d)\r\n{\r\npr_notice("DMI detected: %s\n", d->ident);\r\nacpi_osi_setup("!Windows 2009");\r\nreturn 0;\r\n}\r\nstatic int __init dmi_disable_osi_win8(const struct dmi_system_id *d)\r\n{\r\npr_notice("DMI detected: %s\n", d->ident);\r\nacpi_osi_setup("!Windows 2012");\r\nreturn 0;\r\n}\r\nstatic __init void acpi_osi_dmi_blacklisted(void)\r\n{\r\ndmi_check_system(acpi_osi_dmi_table);\r\n}\r\nint __init early_acpi_osi_init(void)\r\n{\r\nacpi_osi_dmi_blacklisted();\r\nreturn 0;\r\n}\r\nint __init acpi_osi_init(void)\r\n{\r\nacpi_install_interface_handler(acpi_osi_handler);\r\nacpi_osi_setup_late();\r\nreturn 0;\r\n}

static int pcf85063_stop_clock(struct i2c_client *client, u8 *ctrl1)\r\n{\r\ns32 ret;\r\nret = i2c_smbus_read_byte_data(client, PCF85063_REG_CTRL1);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "Failing to stop the clock\n");\r\nreturn -EIO;\r\n}\r\nret |= PCF85063_REG_CTRL1_STOP;\r\nret = i2c_smbus_write_byte_data(client, PCF85063_REG_CTRL1, ret);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "Failing to stop the clock\n");\r\nreturn -EIO;\r\n}\r\n*ctrl1 = ret;\r\nreturn 0;\r\n}\r\nstatic int pcf85063_start_clock(struct i2c_client *client, u8 ctrl1)\r\n{\r\ns32 ret;\r\nctrl1 &= PCF85063_REG_CTRL1_STOP;\r\nret = i2c_smbus_write_byte_data(client, PCF85063_REG_CTRL1, ctrl1);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "Failing to start the clock\n");\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pcf85063_get_datetime(struct i2c_client *client, struct rtc_time *tm)\r\n{\r\nint rc;\r\nu8 regs[7];\r\nrc = i2c_smbus_read_i2c_block_data(client, PCF85063_REG_SC,\r\nsizeof(regs), regs);\r\nif (rc != sizeof(regs)) {\r\ndev_err(&client->dev, "date/time register read error\n");\r\nreturn -EIO;\r\n}\r\nif (regs[0] & PCF85063_REG_SC_OS) {\r\ndev_warn(&client->dev, "Power loss detected, invalid time\n");\r\nreturn -EINVAL;\r\n}\r\ntm->tm_sec = bcd2bin(regs[0] & 0x7F);\r\ntm->tm_min = bcd2bin(regs[1] & 0x7F);\r\ntm->tm_hour = bcd2bin(regs[2] & 0x3F);\r\ntm->tm_mday = bcd2bin(regs[3] & 0x3F);\r\ntm->tm_wday = regs[4] & 0x07;\r\ntm->tm_mon = bcd2bin(regs[5] & 0x1F) - 1;\r\ntm->tm_year = bcd2bin(regs[6]);\r\ntm->tm_year += 100;\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int pcf85063_set_datetime(struct i2c_client *client, struct rtc_time *tm)\r\n{\r\nint rc;\r\nu8 regs[7];\r\nu8 ctrl1;\r\nif ((tm->tm_year < 100) || (tm->tm_year > 199))\r\nreturn -EINVAL;\r\nrc = pcf85063_stop_clock(client, &ctrl1);\r\nif (rc != 0)\r\nreturn rc;\r\nregs[0] = bin2bcd(tm->tm_sec) & 0x7F;\r\nregs[1] = bin2bcd(tm->tm_min);\r\nregs[2] = bin2bcd(tm->tm_hour);\r\nregs[3] = bin2bcd(tm->tm_mday);\r\nregs[4] = tm->tm_wday & 0x07;\r\nregs[5] = bin2bcd(tm->tm_mon + 1);\r\nregs[6] = bin2bcd(tm->tm_year - 100);\r\nrc = i2c_smbus_write_i2c_block_data(client, PCF85063_REG_SC,\r\nsizeof(regs), regs);\r\nif (rc < 0) {\r\ndev_err(&client->dev, "date/time register write error\n");\r\nreturn rc;\r\n}\r\nrc = pcf85063_start_clock(client, ctrl1);\r\nif (rc != 0)\r\nreturn rc;\r\nreturn 0;\r\n}\r\nstatic int pcf85063_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nreturn pcf85063_get_datetime(to_i2c_client(dev), tm);\r\n}\r\nstatic int pcf85063_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nreturn pcf85063_set_datetime(to_i2c_client(dev), tm);\r\n}\r\nstatic int pcf85063_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct rtc_device *rtc;\r\nint err;\r\ndev_dbg(&client->dev, "%s\n", __func__);\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C))\r\nreturn -ENODEV;\r\nerr = i2c_smbus_read_byte_data(client, PCF85063_REG_CTRL1);\r\nif (err < 0) {\r\ndev_err(&client->dev, "RTC chip is not present\n");\r\nreturn err;\r\n}\r\nrtc = devm_rtc_device_register(&client->dev,\r\npcf85063_driver.driver.name,\r\n&pcf85063_rtc_ops, THIS_MODULE);\r\nreturn PTR_ERR_OR_ZERO(rtc);\r\n}

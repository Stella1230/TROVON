static inline unsigned int icp_hv_get_xirr(unsigned char cppr)\r\n{\r\nunsigned long retbuf[PLPAR_HCALL_BUFSIZE];\r\nlong rc;\r\nunsigned int ret = XICS_IRQ_SPURIOUS;\r\nrc = plpar_hcall(H_XIRR, retbuf, cppr);\r\nif (rc == H_SUCCESS) {\r\nret = (unsigned int)retbuf[0];\r\n} else {\r\npr_err("%s: bad return code xirr cppr=0x%x returned %ld\n",\r\n__func__, cppr, rc);\r\nWARN_ON_ONCE(1);\r\n}\r\nreturn ret;\r\n}\r\nstatic inline void icp_hv_set_cppr(u8 value)\r\n{\r\nlong rc = plpar_hcall_norets(H_CPPR, value);\r\nif (rc != H_SUCCESS) {\r\npr_err("%s: bad return code cppr cppr=0x%x returned %ld\n",\r\n__func__, value, rc);\r\nWARN_ON_ONCE(1);\r\n}\r\n}\r\nstatic inline void icp_hv_set_xirr(unsigned int value)\r\n{\r\nlong rc = plpar_hcall_norets(H_EOI, value);\r\nif (rc != H_SUCCESS) {\r\npr_err("%s: bad return code eoi xirr=0x%x returned %ld\n",\r\n__func__, value, rc);\r\nWARN_ON_ONCE(1);\r\nicp_hv_set_cppr(value >> 24);\r\n}\r\n}\r\nstatic inline void icp_hv_set_qirr(int n_cpu , u8 value)\r\n{\r\nint hw_cpu = get_hard_smp_processor_id(n_cpu);\r\nlong rc;\r\nmb();\r\nrc = plpar_hcall_norets(H_IPI, hw_cpu, value);\r\nif (rc != H_SUCCESS) {\r\npr_err("%s: bad return code qirr cpu=%d hw_cpu=%d mfrr=0x%x "\r\n"returned %ld\n", __func__, n_cpu, hw_cpu, value, rc);\r\nWARN_ON_ONCE(1);\r\n}\r\n}\r\nstatic void icp_hv_eoi(struct irq_data *d)\r\n{\r\nunsigned int hw_irq = (unsigned int)irqd_to_hwirq(d);\r\niosync();\r\nicp_hv_set_xirr((xics_pop_cppr() << 24) | hw_irq);\r\n}\r\nstatic void icp_hv_teardown_cpu(void)\r\n{\r\nint cpu = smp_processor_id();\r\nicp_hv_set_qirr(cpu, 0xff);\r\n}\r\nstatic void icp_hv_flush_ipi(void)\r\n{\r\nicp_hv_set_xirr((0x00 << 24) | XICS_IPI);\r\n}\r\nstatic unsigned int icp_hv_get_irq(void)\r\n{\r\nunsigned int xirr = icp_hv_get_xirr(xics_cppr_top());\r\nunsigned int vec = xirr & 0x00ffffff;\r\nunsigned int irq;\r\nif (vec == XICS_IRQ_SPURIOUS)\r\nreturn 0;\r\nirq = irq_find_mapping(xics_host, vec);\r\nif (likely(irq)) {\r\nxics_push_cppr(vec);\r\nreturn irq;\r\n}\r\nxics_mask_unknown_vec(vec);\r\nicp_hv_set_xirr(xirr);\r\nreturn 0;\r\n}\r\nstatic void icp_hv_set_cpu_priority(unsigned char cppr)\r\n{\r\nxics_set_base_cppr(cppr);\r\nicp_hv_set_cppr(cppr);\r\niosync();\r\n}\r\nstatic void icp_hv_cause_ipi(int cpu, unsigned long data)\r\n{\r\nicp_hv_set_qirr(cpu, IPI_PRIORITY);\r\n}\r\nstatic irqreturn_t icp_hv_ipi_action(int irq, void *dev_id)\r\n{\r\nint cpu = smp_processor_id();\r\nicp_hv_set_qirr(cpu, 0xff);\r\nreturn smp_ipi_demux();\r\n}\r\nint icp_hv_init(void)\r\n{\r\nstruct device_node *np;\r\nnp = of_find_compatible_node(NULL, NULL, "ibm,ppc-xicp");\r\nif (!np)\r\nnp = of_find_node_by_type(NULL,\r\n"PowerPC-External-Interrupt-Presentation");\r\nif (!np)\r\nreturn -ENODEV;\r\nicp_ops = &icp_hv_ops;\r\nreturn 0;\r\n}

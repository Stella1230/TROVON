static unsigned long hi6220_clkdiv_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned int val;\r\nstruct hi6220_clk_divider *dclk = to_hi6220_clk_divider(hw);\r\nval = readl_relaxed(dclk->reg) >> dclk->shift;\r\nval &= div_mask(dclk->width);\r\nreturn divider_recalc_rate(hw, parent_rate, val, dclk->table,\r\nCLK_DIVIDER_ROUND_CLOSEST);\r\n}\r\nstatic long hi6220_clkdiv_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *prate)\r\n{\r\nstruct hi6220_clk_divider *dclk = to_hi6220_clk_divider(hw);\r\nreturn divider_round_rate(hw, rate, prate, dclk->table,\r\ndclk->width, CLK_DIVIDER_ROUND_CLOSEST);\r\n}\r\nstatic int hi6220_clkdiv_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nint value;\r\nunsigned long flags = 0;\r\nu32 data;\r\nstruct hi6220_clk_divider *dclk = to_hi6220_clk_divider(hw);\r\nvalue = divider_get_val(rate, parent_rate, dclk->table,\r\ndclk->width, CLK_DIVIDER_ROUND_CLOSEST);\r\nif (dclk->lock)\r\nspin_lock_irqsave(dclk->lock, flags);\r\ndata = readl_relaxed(dclk->reg);\r\ndata &= ~(div_mask(dclk->width) << dclk->shift);\r\ndata |= value << dclk->shift;\r\ndata |= dclk->mask;\r\nwritel_relaxed(data, dclk->reg);\r\nif (dclk->lock)\r\nspin_unlock_irqrestore(dclk->lock, flags);\r\nreturn 0;\r\n}\r\nstruct clk *hi6220_register_clkdiv(struct device *dev, const char *name,\r\nconst char *parent_name, unsigned long flags, void __iomem *reg,\r\nu8 shift, u8 width, u32 mask_bit, spinlock_t *lock)\r\n{\r\nstruct hi6220_clk_divider *div;\r\nstruct clk *clk;\r\nstruct clk_init_data init;\r\nstruct clk_div_table *table;\r\nu32 max_div, min_div;\r\nint i;\r\ndiv = kzalloc(sizeof(*div), GFP_KERNEL);\r\nif (!div)\r\nreturn ERR_PTR(-ENOMEM);\r\nmax_div = div_mask(width) + 1;\r\nmin_div = 1;\r\ntable = kcalloc(max_div + 1, sizeof(*table), GFP_KERNEL);\r\nif (!table) {\r\nkfree(div);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nfor (i = 0; i < max_div; i++) {\r\ntable[i].div = min_div + i;\r\ntable[i].val = table[i].div - 1;\r\n}\r\ninit.name = name;\r\ninit.ops = &hi6220_clkdiv_ops;\r\ninit.flags = flags;\r\ninit.parent_names = parent_name ? &parent_name : NULL;\r\ninit.num_parents = parent_name ? 1 : 0;\r\ndiv->reg = reg;\r\ndiv->shift = shift;\r\ndiv->width = width;\r\ndiv->mask = mask_bit ? BIT(mask_bit) : 0;\r\ndiv->lock = lock;\r\ndiv->hw.init = &init;\r\ndiv->table = table;\r\nclk = clk_register(dev, &div->hw);\r\nif (IS_ERR(clk)) {\r\nkfree(table);\r\nkfree(div);\r\n}\r\nreturn clk;\r\n}

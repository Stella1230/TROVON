int __init da8xx_register_usb_phy(void)\r\n{\r\nreturn platform_device_register(&da8xx_usb_phy);\r\n}\r\nint __init da8xx_register_usb20(unsigned int mA, unsigned int potpgt)\r\n{\r\nusb_data.power = mA > 510 ? 255 : mA / 2;\r\nusb_data.potpgt = (potpgt + 1) / 2;\r\nreturn platform_device_register(&da8xx_usb20_dev);\r\n}\r\nint __init da8xx_register_usb11(struct da8xx_ohci_root_hub *pdata)\r\n{\r\nda8xx_usb11_device.dev.platform_data = pdata;\r\nreturn platform_device_register(&da8xx_usb11_device);\r\n}\r\nint __init da8xx_register_usb_refclkin(int rate)\r\n{\r\nint ret;\r\nusb_refclkin.rate = rate;\r\nret = clk_register(&usb_refclkin);\r\nif (ret)\r\nreturn ret;\r\nclkdev_add(&usb_refclkin_lookup);\r\nreturn 0;\r\n}\r\nstatic void usb20_phy_clk_enable(struct clk *clk)\r\n{\r\nu32 val;\r\nu32 timeout = 500000;\r\nval = readl(DA8XX_SYSCFG0_VIRT(DA8XX_CFGCHIP2_REG));\r\ndavinci_clk_enable(usb20_clk);\r\nval &= ~(CFGCHIP2_RESET | CFGCHIP2_PHYPWRDN);\r\nval |= CFGCHIP2_PHY_PLLON;\r\nwritel(val, DA8XX_SYSCFG0_VIRT(DA8XX_CFGCHIP2_REG));\r\nwhile (--timeout) {\r\nval = readl(DA8XX_SYSCFG0_VIRT(DA8XX_CFGCHIP2_REG));\r\nif (val & CFGCHIP2_PHYCLKGD)\r\ngoto done;\r\nudelay(1);\r\n}\r\npr_err("Timeout waiting for USB 2.0 PHY clock good\n");\r\ndone:\r\ndavinci_clk_disable(usb20_clk);\r\n}\r\nstatic void usb20_phy_clk_disable(struct clk *clk)\r\n{\r\nu32 val;\r\nval = readl(DA8XX_SYSCFG0_VIRT(DA8XX_CFGCHIP2_REG));\r\nval |= CFGCHIP2_PHYPWRDN;\r\nwritel(val, DA8XX_SYSCFG0_VIRT(DA8XX_CFGCHIP2_REG));\r\n}\r\nstatic int usb20_phy_clk_set_parent(struct clk *clk, struct clk *parent)\r\n{\r\nu32 val;\r\nval = readl(DA8XX_SYSCFG0_VIRT(DA8XX_CFGCHIP2_REG));\r\nif (parent == &usb_refclkin) {\r\nval &= ~CFGCHIP2_USB2PHYCLKMUX;\r\n} else if (strcmp(parent->name, "pll0_aux_clk") == 0) {\r\nval |= CFGCHIP2_USB2PHYCLKMUX;\r\n} else {\r\npr_err("Bad parent on USB 2.0 PHY clock\n");\r\nreturn -EINVAL;\r\n}\r\nval &= ~CFGCHIP2_REFFREQ_MASK;\r\nswitch (clk_get_rate(parent)) {\r\ncase 12000000:\r\nval |= CFGCHIP2_REFFREQ_12MHZ;\r\nbreak;\r\ncase 13000000:\r\nval |= CFGCHIP2_REFFREQ_13MHZ;\r\nbreak;\r\ncase 19200000:\r\nval |= CFGCHIP2_REFFREQ_19_2MHZ;\r\nbreak;\r\ncase 20000000:\r\nval |= CFGCHIP2_REFFREQ_20MHZ;\r\nbreak;\r\ncase 24000000:\r\nval |= CFGCHIP2_REFFREQ_24MHZ;\r\nbreak;\r\ncase 26000000:\r\nval |= CFGCHIP2_REFFREQ_26MHZ;\r\nbreak;\r\ncase 38400000:\r\nval |= CFGCHIP2_REFFREQ_38_4MHZ;\r\nbreak;\r\ncase 40000000:\r\nval |= CFGCHIP2_REFFREQ_40MHZ;\r\nbreak;\r\ncase 48000000:\r\nval |= CFGCHIP2_REFFREQ_48MHZ;\r\nbreak;\r\ndefault:\r\npr_err("Bad parent clock rate on USB 2.0 PHY clock\n");\r\nreturn -EINVAL;\r\n}\r\nwritel(val, DA8XX_SYSCFG0_VIRT(DA8XX_CFGCHIP2_REG));\r\nreturn 0;\r\n}\r\nint __init da8xx_register_usb20_phy_clk(bool use_usb_refclkin)\r\n{\r\nstruct clk *parent;\r\nint ret;\r\nusb20_clk = clk_get(&da8xx_usb20_dev.dev, "usb20");\r\nret = PTR_ERR_OR_ZERO(usb20_clk);\r\nif (ret)\r\nreturn ret;\r\nparent = clk_get(NULL, use_usb_refclkin ? "usb_refclkin" : "pll0_aux");\r\nret = PTR_ERR_OR_ZERO(parent);\r\nif (ret) {\r\nclk_put(usb20_clk);\r\nreturn ret;\r\n}\r\nusb20_phy_clk.parent = parent;\r\nret = clk_register(&usb20_phy_clk);\r\nif (!ret)\r\nclkdev_add(&usb20_phy_clk_lookup);\r\nclk_put(parent);\r\nreturn ret;\r\n}\r\nstatic int usb11_phy_clk_set_parent(struct clk *clk, struct clk *parent)\r\n{\r\nu32 val;\r\nval = readl(DA8XX_SYSCFG0_VIRT(DA8XX_CFGCHIP2_REG));\r\nif (parent == &usb20_phy_clk) {\r\nval &= ~CFGCHIP2_USB1PHYCLKMUX;\r\n} else if (parent == &usb_refclkin) {\r\nval |= CFGCHIP2_USB1PHYCLKMUX;\r\n} else {\r\npr_err("Bad parent on USB 1.1 PHY clock\n");\r\nreturn -EINVAL;\r\n}\r\nwritel(val, DA8XX_SYSCFG0_VIRT(DA8XX_CFGCHIP2_REG));\r\nreturn 0;\r\n}\r\nint __init da8xx_register_usb11_phy_clk(bool use_usb_refclkin)\r\n{\r\nstruct clk *parent;\r\nint ret = 0;\r\nif (use_usb_refclkin)\r\nparent = clk_get(NULL, "usb_refclkin");\r\nelse\r\nparent = clk_get(&da8xx_usb_phy.dev, "usb20_phy");\r\nif (IS_ERR(parent))\r\nreturn PTR_ERR(parent);\r\nusb11_phy_clk.parent = parent;\r\nret = clk_register(&usb11_phy_clk);\r\nif (!ret)\r\nclkdev_add(&usb11_phy_clk_lookup);\r\nclk_put(parent);\r\nreturn ret;\r\n}

int max8997_read_reg(struct i2c_client *i2c, u8 reg, u8 *dest)\r\n{\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&max8997->iolock);\r\nret = i2c_smbus_read_byte_data(i2c, reg);\r\nmutex_unlock(&max8997->iolock);\r\nif (ret < 0)\r\nreturn ret;\r\nret &= 0xff;\r\n*dest = ret;\r\nreturn 0;\r\n}\r\nint max8997_bulk_read(struct i2c_client *i2c, u8 reg, int count, u8 *buf)\r\n{\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&max8997->iolock);\r\nret = i2c_smbus_read_i2c_block_data(i2c, reg, count, buf);\r\nmutex_unlock(&max8997->iolock);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint max8997_write_reg(struct i2c_client *i2c, u8 reg, u8 value)\r\n{\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&max8997->iolock);\r\nret = i2c_smbus_write_byte_data(i2c, reg, value);\r\nmutex_unlock(&max8997->iolock);\r\nreturn ret;\r\n}\r\nint max8997_bulk_write(struct i2c_client *i2c, u8 reg, int count, u8 *buf)\r\n{\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&max8997->iolock);\r\nret = i2c_smbus_write_i2c_block_data(i2c, reg, count, buf);\r\nmutex_unlock(&max8997->iolock);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint max8997_update_reg(struct i2c_client *i2c, u8 reg, u8 val, u8 mask)\r\n{\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&max8997->iolock);\r\nret = i2c_smbus_read_byte_data(i2c, reg);\r\nif (ret >= 0) {\r\nu8 old_val = ret & 0xff;\r\nu8 new_val = (val & mask) | (old_val & (~mask));\r\nret = i2c_smbus_write_byte_data(i2c, reg, new_val);\r\n}\r\nmutex_unlock(&max8997->iolock);\r\nreturn ret;\r\n}\r\nstatic struct max8997_platform_data *max8997_i2c_parse_dt_pdata(\r\nstruct device *dev)\r\n{\r\nstruct max8997_platform_data *pd;\r\npd = devm_kzalloc(dev, sizeof(*pd), GFP_KERNEL);\r\nif (!pd) {\r\ndev_err(dev, "could not allocate memory for pdata\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\npd->ono = irq_of_parse_and_map(dev->of_node, 1);\r\nreturn pd;\r\n}\r\nstatic inline unsigned long max8997_i2c_get_driver_data(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nif (IS_ENABLED(CONFIG_OF) && i2c->dev.of_node) {\r\nconst struct of_device_id *match;\r\nmatch = of_match_node(max8997_pmic_dt_match, i2c->dev.of_node);\r\nreturn (unsigned long)match->data;\r\n}\r\nreturn id->driver_data;\r\n}\r\nstatic int max8997_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct max8997_dev *max8997;\r\nstruct max8997_platform_data *pdata = dev_get_platdata(&i2c->dev);\r\nint ret = 0;\r\nmax8997 = devm_kzalloc(&i2c->dev, sizeof(struct max8997_dev),\r\nGFP_KERNEL);\r\nif (max8997 == NULL)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(i2c, max8997);\r\nmax8997->dev = &i2c->dev;\r\nmax8997->i2c = i2c;\r\nmax8997->type = max8997_i2c_get_driver_data(i2c, id);\r\nmax8997->irq = i2c->irq;\r\nif (IS_ENABLED(CONFIG_OF) && max8997->dev->of_node) {\r\npdata = max8997_i2c_parse_dt_pdata(max8997->dev);\r\nif (IS_ERR(pdata))\r\nreturn PTR_ERR(pdata);\r\n}\r\nif (!pdata)\r\nreturn ret;\r\nmax8997->pdata = pdata;\r\nmax8997->ono = pdata->ono;\r\nmutex_init(&max8997->iolock);\r\nmax8997->rtc = i2c_new_dummy(i2c->adapter, I2C_ADDR_RTC);\r\nif (!max8997->rtc) {\r\ndev_err(max8997->dev, "Failed to allocate I2C device for RTC\n");\r\nreturn -ENODEV;\r\n}\r\ni2c_set_clientdata(max8997->rtc, max8997);\r\nmax8997->haptic = i2c_new_dummy(i2c->adapter, I2C_ADDR_HAPTIC);\r\nif (!max8997->haptic) {\r\ndev_err(max8997->dev, "Failed to allocate I2C device for Haptic\n");\r\nret = -ENODEV;\r\ngoto err_i2c_haptic;\r\n}\r\ni2c_set_clientdata(max8997->haptic, max8997);\r\nmax8997->muic = i2c_new_dummy(i2c->adapter, I2C_ADDR_MUIC);\r\nif (!max8997->muic) {\r\ndev_err(max8997->dev, "Failed to allocate I2C device for MUIC\n");\r\nret = -ENODEV;\r\ngoto err_i2c_muic;\r\n}\r\ni2c_set_clientdata(max8997->muic, max8997);\r\npm_runtime_set_active(max8997->dev);\r\nmax8997_irq_init(max8997);\r\nret = mfd_add_devices(max8997->dev, -1, max8997_devs,\r\nARRAY_SIZE(max8997_devs),\r\nNULL, 0, NULL);\r\nif (ret < 0) {\r\ndev_err(max8997->dev, "failed to add MFD devices %d\n", ret);\r\ngoto err_mfd;\r\n}\r\ndevice_init_wakeup(max8997->dev, pdata->wakeup);\r\nreturn ret;\r\nerr_mfd:\r\nmfd_remove_devices(max8997->dev);\r\ni2c_unregister_device(max8997->muic);\r\nerr_i2c_muic:\r\ni2c_unregister_device(max8997->haptic);\r\nerr_i2c_haptic:\r\ni2c_unregister_device(max8997->rtc);\r\nreturn ret;\r\n}\r\nstatic int max8997_freeze(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_pmic); i++)\r\nmax8997_read_reg(i2c, max8997_dumpaddr_pmic[i],\r\n&max8997->reg_dump[i]);\r\nfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_muic); i++)\r\nmax8997_read_reg(i2c, max8997_dumpaddr_muic[i],\r\n&max8997->reg_dump[i + MAX8997_REG_PMIC_END]);\r\nfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_haptic); i++)\r\nmax8997_read_reg(i2c, max8997_dumpaddr_haptic[i],\r\n&max8997->reg_dump[i + MAX8997_REG_PMIC_END +\r\nMAX8997_MUIC_REG_END]);\r\nreturn 0;\r\n}\r\nstatic int max8997_restore(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_pmic); i++)\r\nmax8997_write_reg(i2c, max8997_dumpaddr_pmic[i],\r\nmax8997->reg_dump[i]);\r\nfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_muic); i++)\r\nmax8997_write_reg(i2c, max8997_dumpaddr_muic[i],\r\nmax8997->reg_dump[i + MAX8997_REG_PMIC_END]);\r\nfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_haptic); i++)\r\nmax8997_write_reg(i2c, max8997_dumpaddr_haptic[i],\r\nmax8997->reg_dump[i + MAX8997_REG_PMIC_END +\r\nMAX8997_MUIC_REG_END]);\r\nreturn 0;\r\n}\r\nstatic int max8997_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nif (device_may_wakeup(dev))\r\nirq_set_irq_wake(max8997->irq, 1);\r\nreturn 0;\r\n}\r\nstatic int max8997_resume(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nif (device_may_wakeup(dev))\r\nirq_set_irq_wake(max8997->irq, 0);\r\nreturn max8997_irq_resume(max8997);\r\n}\r\nstatic int __init max8997_i2c_init(void)\r\n{\r\nreturn i2c_add_driver(&max8997_i2c_driver);\r\n}

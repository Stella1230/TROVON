static int xicor_read(uint8_t addr)\r\n{\r\nwhile (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_BUSY)\r\n;\r\n__raw_writeq((addr >> 8) & 0x7, SMB_CSR(R_SMB_CMD));\r\n__raw_writeq(addr & 0xff, SMB_CSR(R_SMB_DATA));\r\n__raw_writeq(V_SMB_ADDR(X1241_CCR_ADDRESS) | V_SMB_TT_WR2BYTE,\r\nSMB_CSR(R_SMB_START));\r\nwhile (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_BUSY)\r\n;\r\n__raw_writeq(V_SMB_ADDR(X1241_CCR_ADDRESS) | V_SMB_TT_RD1BYTE,\r\nSMB_CSR(R_SMB_START));\r\nwhile (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_BUSY)\r\n;\r\nif (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_ERROR) {\r\n__raw_writeq(M_SMB_ERROR, SMB_CSR(R_SMB_STATUS));\r\nreturn -1;\r\n}\r\nreturn __raw_readq(SMB_CSR(R_SMB_DATA)) & 0xff;\r\n}\r\nstatic int xicor_write(uint8_t addr, int b)\r\n{\r\nwhile (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_BUSY)\r\n;\r\n__raw_writeq(addr, SMB_CSR(R_SMB_CMD));\r\n__raw_writeq((addr & 0xff) | ((b & 0xff) << 8), SMB_CSR(R_SMB_DATA));\r\n__raw_writeq(V_SMB_ADDR(X1241_CCR_ADDRESS) | V_SMB_TT_WR3BYTE,\r\nSMB_CSR(R_SMB_START));\r\nwhile (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_BUSY)\r\n;\r\nif (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_ERROR) {\r\n__raw_writeq(M_SMB_ERROR, SMB_CSR(R_SMB_STATUS));\r\nreturn -1;\r\n} else {\r\nreturn 0;\r\n}\r\n}\r\nint xicor_set_time(unsigned long t)\r\n{\r\nstruct rtc_time tm;\r\nint tmp;\r\nunsigned long flags;\r\nrtc_time_to_tm(t, &tm);\r\ntm.tm_year += 1900;\r\nspin_lock_irqsave(&rtc_lock, flags);\r\nxicor_write(X1241REG_SR, X1241REG_SR_WEL);\r\nxicor_write(X1241REG_SR, X1241REG_SR_WEL | X1241REG_SR_RWEL);\r\ntm.tm_sec = bin2bcd(tm.tm_sec);\r\nxicor_write(X1241REG_SC, tm.tm_sec);\r\ntm.tm_min = bin2bcd(tm.tm_min);\r\nxicor_write(X1241REG_MN, tm.tm_min);\r\ntm.tm_mday = bin2bcd(tm.tm_mday);\r\nxicor_write(X1241REG_DT, tm.tm_mday);\r\ntm.tm_mon ++;\r\ntm.tm_mon = bin2bcd(tm.tm_mon);\r\nxicor_write(X1241REG_MO, tm.tm_mon);\r\ntmp = tm.tm_year / 100;\r\ntm.tm_year %= 100;\r\nxicor_write(X1241REG_YR, tm.tm_year);\r\nxicor_write(X1241REG_Y2K, tmp);\r\ntmp = xicor_read(X1241REG_HR);\r\nif (tmp & X1241REG_HR_MIL) {\r\ntm.tm_hour = bin2bcd(tm.tm_hour);\r\ntmp = (tmp & ~0x3f) | (tm.tm_hour & 0x3f);\r\n} else {\r\ntmp = tmp & ~0x3f;\r\nif (tm.tm_hour >= 12) {\r\ntmp |= 0x20;\r\ntm.tm_hour -= 12;\r\n}\r\ntm.tm_hour = bin2bcd(tm.tm_hour);\r\ntmp |= tm.tm_hour;\r\n}\r\nxicor_write(X1241REG_HR, tmp);\r\nxicor_write(X1241REG_SR, 0);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nreturn 0;\r\n}\r\nunsigned long xicor_get_time(void)\r\n{\r\nunsigned int year, mon, day, hour, min, sec, y2k;\r\nunsigned long flags;\r\nspin_lock_irqsave(&rtc_lock, flags);\r\nsec = xicor_read(X1241REG_SC);\r\nmin = xicor_read(X1241REG_MN);\r\nhour = xicor_read(X1241REG_HR);\r\nif (hour & X1241REG_HR_MIL) {\r\nhour &= 0x3f;\r\n} else {\r\nif (hour & 0x20)\r\nhour = (hour & 0xf) + 0x12;\r\n}\r\nday = xicor_read(X1241REG_DT);\r\nmon = xicor_read(X1241REG_MO);\r\nyear = xicor_read(X1241REG_YR);\r\ny2k = xicor_read(X1241REG_Y2K);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nsec = bcd2bin(sec);\r\nmin = bcd2bin(min);\r\nhour = bcd2bin(hour);\r\nday = bcd2bin(day);\r\nmon = bcd2bin(mon);\r\nyear = bcd2bin(year);\r\ny2k = bcd2bin(y2k);\r\nyear += (y2k * 100);\r\nreturn mktime(year, mon, day, hour, min, sec);\r\n}\r\nint xicor_probe(void)\r\n{\r\nreturn xicor_read(X1241REG_SC) != -1;\r\n}

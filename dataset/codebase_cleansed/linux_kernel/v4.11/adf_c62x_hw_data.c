static u32 get_accel_mask(u32 fuse)\r\n{\r\nreturn (~fuse) >> ADF_C62X_ACCELERATORS_REG_OFFSET &\r\nADF_C62X_ACCELERATORS_MASK;\r\n}\r\nstatic u32 get_ae_mask(u32 fuse)\r\n{\r\nreturn (~fuse) & ADF_C62X_ACCELENGINES_MASK;\r\n}\r\nstatic u32 get_num_accels(struct adf_hw_device_data *self)\r\n{\r\nu32 i, ctr = 0;\r\nif (!self || !self->accel_mask)\r\nreturn 0;\r\nfor (i = 0; i < ADF_C62X_MAX_ACCELERATORS; i++) {\r\nif (self->accel_mask & (1 << i))\r\nctr++;\r\n}\r\nreturn ctr;\r\n}\r\nstatic u32 get_num_aes(struct adf_hw_device_data *self)\r\n{\r\nu32 i, ctr = 0;\r\nif (!self || !self->ae_mask)\r\nreturn 0;\r\nfor (i = 0; i < ADF_C62X_MAX_ACCELENGINES; i++) {\r\nif (self->ae_mask & (1 << i))\r\nctr++;\r\n}\r\nreturn ctr;\r\n}\r\nstatic u32 get_misc_bar_id(struct adf_hw_device_data *self)\r\n{\r\nreturn ADF_C62X_PMISC_BAR;\r\n}\r\nstatic u32 get_etr_bar_id(struct adf_hw_device_data *self)\r\n{\r\nreturn ADF_C62X_ETR_BAR;\r\n}\r\nstatic u32 get_sram_bar_id(struct adf_hw_device_data *self)\r\n{\r\nreturn ADF_C62X_SRAM_BAR;\r\n}\r\nstatic enum dev_sku_info get_sku(struct adf_hw_device_data *self)\r\n{\r\nint aes = get_num_aes(self);\r\nif (aes == 8)\r\nreturn DEV_SKU_2;\r\nelse if (aes == 10)\r\nreturn DEV_SKU_4;\r\nreturn DEV_SKU_UNKNOWN;\r\n}\r\nstatic void adf_get_arbiter_mapping(struct adf_accel_dev *accel_dev,\r\nu32 const **arb_map_config)\r\n{\r\nswitch (accel_dev->accel_pci_dev.sku) {\r\ncase DEV_SKU_2:\r\n*arb_map_config = thrd_to_arb_map_8_me_sku;\r\nbreak;\r\ncase DEV_SKU_4:\r\n*arb_map_config = thrd_to_arb_map_10_me_sku;\r\nbreak;\r\ndefault:\r\ndev_err(&GET_DEV(accel_dev),\r\n"The configuration doesn't match any SKU");\r\n*arb_map_config = NULL;\r\n}\r\n}\r\nstatic u32 get_pf2vf_offset(u32 i)\r\n{\r\nreturn ADF_C62X_PF2VF_OFFSET(i);\r\n}\r\nstatic u32 get_vintmsk_offset(u32 i)\r\n{\r\nreturn ADF_C62X_VINTMSK_OFFSET(i);\r\n}\r\nstatic void adf_enable_error_correction(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_hw_device_data *hw_device = accel_dev->hw_device;\r\nstruct adf_bar *misc_bar = &GET_BARS(accel_dev)[ADF_C62X_PMISC_BAR];\r\nvoid __iomem *csr = misc_bar->virt_addr;\r\nunsigned int val, i;\r\nfor (i = 0; i < hw_device->get_num_aes(hw_device); i++) {\r\nval = ADF_CSR_RD(csr, ADF_C62X_AE_CTX_ENABLES(i));\r\nval |= ADF_C62X_ENABLE_AE_ECC_ERR;\r\nADF_CSR_WR(csr, ADF_C62X_AE_CTX_ENABLES(i), val);\r\nval = ADF_CSR_RD(csr, ADF_C62X_AE_MISC_CONTROL(i));\r\nval |= ADF_C62X_ENABLE_AE_ECC_PARITY_CORR;\r\nADF_CSR_WR(csr, ADF_C62X_AE_MISC_CONTROL(i), val);\r\n}\r\nfor (i = 0; i < hw_device->get_num_accels(hw_device); i++) {\r\nval = ADF_CSR_RD(csr, ADF_C62X_UERRSSMSH(i));\r\nval |= ADF_C62X_ERRSSMSH_EN;\r\nADF_CSR_WR(csr, ADF_C62X_UERRSSMSH(i), val);\r\nval = ADF_CSR_RD(csr, ADF_C62X_CERRSSMSH(i));\r\nval |= ADF_C62X_ERRSSMSH_EN;\r\nADF_CSR_WR(csr, ADF_C62X_CERRSSMSH(i), val);\r\n}\r\n}\r\nstatic void adf_enable_ints(struct adf_accel_dev *accel_dev)\r\n{\r\nvoid __iomem *addr;\r\naddr = (&GET_BARS(accel_dev)[ADF_C62X_PMISC_BAR])->virt_addr;\r\nADF_CSR_WR(addr, ADF_C62X_SMIAPF0_MASK_OFFSET,\r\nADF_C62X_SMIA0_MASK);\r\nADF_CSR_WR(addr, ADF_C62X_SMIAPF1_MASK_OFFSET,\r\nADF_C62X_SMIA1_MASK);\r\n}\r\nstatic int adf_pf_enable_vf2pf_comms(struct adf_accel_dev *accel_dev)\r\n{\r\nreturn 0;\r\n}\r\nvoid adf_init_hw_data_c62x(struct adf_hw_device_data *hw_data)\r\n{\r\nhw_data->dev_class = &c62x_class;\r\nhw_data->instance_id = c62x_class.instances++;\r\nhw_data->num_banks = ADF_C62X_ETR_MAX_BANKS;\r\nhw_data->num_accel = ADF_C62X_MAX_ACCELERATORS;\r\nhw_data->num_logical_accel = 1;\r\nhw_data->num_engines = ADF_C62X_MAX_ACCELENGINES;\r\nhw_data->tx_rx_gap = ADF_C62X_RX_RINGS_OFFSET;\r\nhw_data->tx_rings_mask = ADF_C62X_TX_RINGS_MASK;\r\nhw_data->alloc_irq = adf_isr_resource_alloc;\r\nhw_data->free_irq = adf_isr_resource_free;\r\nhw_data->enable_error_correction = adf_enable_error_correction;\r\nhw_data->get_accel_mask = get_accel_mask;\r\nhw_data->get_ae_mask = get_ae_mask;\r\nhw_data->get_num_accels = get_num_accels;\r\nhw_data->get_num_aes = get_num_aes;\r\nhw_data->get_sram_bar_id = get_sram_bar_id;\r\nhw_data->get_etr_bar_id = get_etr_bar_id;\r\nhw_data->get_misc_bar_id = get_misc_bar_id;\r\nhw_data->get_pf2vf_offset = get_pf2vf_offset;\r\nhw_data->get_vintmsk_offset = get_vintmsk_offset;\r\nhw_data->get_sku = get_sku;\r\nhw_data->fw_name = ADF_C62X_FW;\r\nhw_data->fw_mmp_name = ADF_C62X_MMP;\r\nhw_data->init_admin_comms = adf_init_admin_comms;\r\nhw_data->exit_admin_comms = adf_exit_admin_comms;\r\nhw_data->disable_iov = adf_disable_sriov;\r\nhw_data->send_admin_init = adf_send_admin_init;\r\nhw_data->init_arb = adf_init_arb;\r\nhw_data->exit_arb = adf_exit_arb;\r\nhw_data->get_arb_mapping = adf_get_arbiter_mapping;\r\nhw_data->enable_ints = adf_enable_ints;\r\nhw_data->enable_vf2pf_comms = adf_pf_enable_vf2pf_comms;\r\nhw_data->reset_device = adf_reset_flr;\r\nhw_data->min_iov_compat_ver = ADF_PFVF_COMPATIBILITY_VERSION;\r\n}\r\nvoid adf_clean_hw_data_c62x(struct adf_hw_device_data *hw_data)\r\n{\r\nhw_data->dev_class->instances--;\r\n}

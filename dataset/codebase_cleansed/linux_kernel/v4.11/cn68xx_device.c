static void lio_cn68xx_set_dpi_regs(struct octeon_device *oct)\r\n{\r\nu32 i;\r\nu32 fifo_sizes[6] = { 3, 3, 1, 1, 1, 8 };\r\nlio_pci_writeq(oct, CN6XXX_DPI_DMA_CTL_MASK, CN6XXX_DPI_DMA_CONTROL);\r\ndev_dbg(&oct->pci_dev->dev, "DPI_DMA_CONTROL: 0x%016llx\n",\r\nlio_pci_readq(oct, CN6XXX_DPI_DMA_CONTROL));\r\nfor (i = 0; i < 6; i++) {\r\nlio_pci_writeq(oct, 0, CN6XXX_DPI_DMA_ENG_ENB(i));\r\nlio_pci_writeq(oct, fifo_sizes[i], CN6XXX_DPI_DMA_ENG_BUF(i));\r\ndev_dbg(&oct->pci_dev->dev, "DPI_ENG_BUF%d: 0x%016llx\n", i,\r\nlio_pci_readq(oct, CN6XXX_DPI_DMA_ENG_BUF(i)));\r\n}\r\nlio_pci_writeq(oct, 1, CN6XXX_DPI_CTL);\r\ndev_dbg(&oct->pci_dev->dev, "DPI_CTL: 0x%016llx\n",\r\nlio_pci_readq(oct, CN6XXX_DPI_CTL));\r\n}\r\nstatic int lio_cn68xx_soft_reset(struct octeon_device *oct)\r\n{\r\nlio_cn6xxx_soft_reset(oct);\r\nlio_cn68xx_set_dpi_regs(oct);\r\nreturn 0;\r\n}\r\nstatic void lio_cn68xx_setup_pkt_ctl_regs(struct octeon_device *oct)\r\n{\r\nstruct octeon_cn6xxx *cn68xx = (struct octeon_cn6xxx *)oct->chip;\r\nu64 pktctl, tx_pipe, max_oqs;\r\npktctl = octeon_read_csr64(oct, CN6XXX_SLI_PKT_CTL);\r\nmax_oqs = CFG_GET_OQ_MAX_Q(CHIP_CONF(oct, cn6xxx));\r\ntx_pipe = octeon_read_csr64(oct, CN68XX_SLI_TX_PIPE);\r\ntx_pipe &= 0xffffffffff00ffffULL;\r\ntx_pipe |= max_oqs << 16;\r\nocteon_write_csr64(oct, CN68XX_SLI_TX_PIPE, tx_pipe);\r\nif (CFG_GET_IS_SLI_BP_ON(cn68xx->conf))\r\npktctl |= 0xF;\r\nelse\r\npktctl &= ~0xF;\r\nocteon_write_csr64(oct, CN6XXX_SLI_PKT_CTL, pktctl);\r\n}\r\nstatic int lio_cn68xx_setup_device_regs(struct octeon_device *oct)\r\n{\r\nlio_cn6xxx_setup_pcie_mps(oct, PCIE_MPS_DEFAULT);\r\nlio_cn6xxx_setup_pcie_mrrs(oct, PCIE_MRRS_256B);\r\nlio_cn6xxx_enable_error_reporting(oct);\r\nlio_cn6xxx_setup_global_input_regs(oct);\r\nlio_cn68xx_setup_pkt_ctl_regs(oct);\r\nlio_cn6xxx_setup_global_output_regs(oct);\r\nocteon_write_csr64(oct, CN6XXX_SLI_WINDOW_CTL, 0x200000ULL);\r\nreturn 0;\r\n}\r\nstatic inline void lio_cn68xx_vendor_message_fix(struct octeon_device *oct)\r\n{\r\nu32 val = 0;\r\npci_read_config_dword(oct->pci_dev, CN6XXX_PCIE_FLTMSK, &val);\r\nval |= 0x3;\r\npci_write_config_dword(oct->pci_dev, CN6XXX_PCIE_FLTMSK, val);\r\n}\r\nstatic int lio_is_210nv(struct octeon_device *oct)\r\n{\r\nu64 mio_qlm4_cfg = lio_pci_readq(oct, CN6XXX_MIO_QLM4_CFG);\r\nreturn ((mio_qlm4_cfg & CN6XXX_MIO_QLM_CFG_MASK) == 0);\r\n}\r\nint lio_setup_cn68xx_octeon_device(struct octeon_device *oct)\r\n{\r\nstruct octeon_cn6xxx *cn68xx = (struct octeon_cn6xxx *)oct->chip;\r\nu16 card_type = LIO_410NV;\r\nif (octeon_map_pci_barx(oct, 0, 0))\r\nreturn 1;\r\nif (octeon_map_pci_barx(oct, 1, MAX_BAR1_IOREMAP_SIZE)) {\r\ndev_err(&oct->pci_dev->dev, "%s CN68XX BAR1 map failed\n",\r\n__func__);\r\nocteon_unmap_pci_barx(oct, 0);\r\nreturn 1;\r\n}\r\nspin_lock_init(&cn68xx->lock_for_droq_int_enb_reg);\r\noct->fn_list.setup_iq_regs = lio_cn6xxx_setup_iq_regs;\r\noct->fn_list.setup_oq_regs = lio_cn6xxx_setup_oq_regs;\r\noct->fn_list.process_interrupt_regs = lio_cn6xxx_process_interrupt_regs;\r\noct->fn_list.soft_reset = lio_cn68xx_soft_reset;\r\noct->fn_list.setup_device_regs = lio_cn68xx_setup_device_regs;\r\noct->fn_list.update_iq_read_idx = lio_cn6xxx_update_read_index;\r\noct->fn_list.bar1_idx_setup = lio_cn6xxx_bar1_idx_setup;\r\noct->fn_list.bar1_idx_write = lio_cn6xxx_bar1_idx_write;\r\noct->fn_list.bar1_idx_read = lio_cn6xxx_bar1_idx_read;\r\noct->fn_list.enable_interrupt = lio_cn6xxx_enable_interrupt;\r\noct->fn_list.disable_interrupt = lio_cn6xxx_disable_interrupt;\r\noct->fn_list.enable_io_queues = lio_cn6xxx_enable_io_queues;\r\noct->fn_list.disable_io_queues = lio_cn6xxx_disable_io_queues;\r\nlio_cn6xxx_setup_reg_address(oct, oct->chip, &oct->reg_list);\r\nif (lio_is_210nv(oct))\r\ncard_type = LIO_210NV;\r\ncn68xx->conf = (struct octeon_config *)\r\noct_get_config_info(oct, card_type);\r\nif (!cn68xx->conf) {\r\ndev_err(&oct->pci_dev->dev, "%s No Config found for CN68XX %s\n",\r\n__func__,\r\n(card_type == LIO_410NV) ? LIO_410NV_NAME :\r\nLIO_210NV_NAME);\r\nocteon_unmap_pci_barx(oct, 0);\r\nocteon_unmap_pci_barx(oct, 1);\r\nreturn 1;\r\n}\r\noct->coproc_clock_rate = 1000000ULL * lio_cn6xxx_coprocessor_clock(oct);\r\nlio_cn68xx_vendor_message_fix(oct);\r\nreturn 0;\r\n}

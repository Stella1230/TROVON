static void tx4939_irq_unmask(struct irq_data *d)\r\n{\r\nunsigned int irq_nr = d->irq - TXX9_IRQ_BASE;\r\nu32 __iomem *lvlp;\r\nint ofs;\r\nif (irq_nr < 32) {\r\nirq_nr--;\r\nlvlp = &tx4939_ircptr->lvl[(irq_nr % 16) / 2].r;\r\n} else {\r\nirq_nr -= 32;\r\nlvlp = &tx4939_ircptr->lvl[8 + (irq_nr % 16) / 2].r;\r\n}\r\nofs = (irq_nr & 16) + (irq_nr & 1) * 8;\r\n__raw_writel((__raw_readl(lvlp) & ~(0xff << ofs))\r\n| (tx4939irq[irq_nr].level << ofs),\r\nlvlp);\r\n}\r\nstatic inline void tx4939_irq_mask(struct irq_data *d)\r\n{\r\nunsigned int irq_nr = d->irq - TXX9_IRQ_BASE;\r\nu32 __iomem *lvlp;\r\nint ofs;\r\nif (irq_nr < 32) {\r\nirq_nr--;\r\nlvlp = &tx4939_ircptr->lvl[(irq_nr % 16) / 2].r;\r\n} else {\r\nirq_nr -= 32;\r\nlvlp = &tx4939_ircptr->lvl[8 + (irq_nr % 16) / 2].r;\r\n}\r\nofs = (irq_nr & 16) + (irq_nr & 1) * 8;\r\n__raw_writel((__raw_readl(lvlp) & ~(0xff << ofs))\r\n| (irc_dlevel << ofs),\r\nlvlp);\r\nmmiowb();\r\n}\r\nstatic void tx4939_irq_mask_ack(struct irq_data *d)\r\n{\r\nunsigned int irq_nr = d->irq - TXX9_IRQ_BASE;\r\ntx4939_irq_mask(d);\r\nif (TXx9_IRCR_EDGE(tx4939irq[irq_nr].mode)) {\r\nirq_nr--;\r\n__raw_writel((TXx9_IRSCR_EIClrE | (irq_nr & 0xf))\r\n<< (irq_nr & 0x10),\r\n&tx4939_ircptr->edc.r);\r\n}\r\n}\r\nstatic int tx4939_irq_set_type(struct irq_data *d, unsigned int flow_type)\r\n{\r\nunsigned int irq_nr = d->irq - TXX9_IRQ_BASE;\r\nu32 cr;\r\nu32 __iomem *crp;\r\nint ofs;\r\nint mode;\r\nif (flow_type & IRQF_TRIGGER_PROBE)\r\nreturn 0;\r\nswitch (flow_type & IRQF_TRIGGER_MASK) {\r\ncase IRQF_TRIGGER_RISING:\r\nmode = TXx9_IRCR_UP;\r\nbreak;\r\ncase IRQF_TRIGGER_FALLING:\r\nmode = TXx9_IRCR_DOWN;\r\nbreak;\r\ncase IRQF_TRIGGER_HIGH:\r\nmode = TXx9_IRCR_HIGH;\r\nbreak;\r\ncase IRQF_TRIGGER_LOW:\r\nmode = TXx9_IRCR_LOW;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (irq_nr < 32) {\r\nirq_nr--;\r\ncrp = &tx4939_ircptr->dm[(irq_nr & 8) >> 3].r;\r\n} else {\r\nirq_nr -= 32;\r\ncrp = &tx4939_ircptr->dm2[((irq_nr & 8) >> 3)].r;\r\n}\r\nofs = (((irq_nr & 16) >> 1) | (irq_nr & (8 - 1))) * 2;\r\ncr = __raw_readl(crp);\r\ncr &= ~(0x3 << ofs);\r\ncr |= (mode & 0x3) << ofs;\r\n__raw_writel(cr, crp);\r\ntx4939irq[irq_nr].mode = mode;\r\nreturn 0;\r\n}\r\nstatic int tx4939_irq_set_pri(int irc_irq, int new_pri)\r\n{\r\nint old_pri;\r\nif ((unsigned int)irc_irq >= TX4939_NUM_IR)\r\nreturn 0;\r\nold_pri = tx4939irq[irc_irq].level;\r\ntx4939irq[irc_irq].level = new_pri;\r\nreturn old_pri;\r\n}\r\nvoid __init tx4939_irq_init(void)\r\n{\r\nint i;\r\nmips_cpu_irq_init();\r\n__raw_writel(0, &tx4939_ircptr->den.r);\r\n__raw_writel(0, &tx4939_ircptr->maskint.r);\r\n__raw_writel(0, &tx4939_ircptr->maskext.r);\r\nfor (i = 1; i < TX4939_NUM_IR; i++) {\r\ntx4939irq[i].level = 4;\r\ntx4939irq[i].mode = TXx9_IRCR_LOW;\r\nirq_set_chip_and_handler(TXX9_IRQ_BASE + i, &tx4939_irq_chip,\r\nhandle_level_irq);\r\n}\r\n__raw_writel(0, &tx4939_ircptr->msk.r);\r\nfor (i = 0; i < 16; i++)\r\n__raw_writel(0, &tx4939_ircptr->lvl[i].r);\r\nfor (i = 0; i < 2; i++)\r\n__raw_writel(0, &tx4939_ircptr->dm[i].r);\r\nfor (i = 0; i < 2; i++)\r\n__raw_writel(0, &tx4939_ircptr->dm2[i].r);\r\n__raw_writel(TXx9_IRCER_ICE, &tx4939_ircptr->den.r);\r\n__raw_writel(irc_elevel, &tx4939_ircptr->msk.r);\r\nirq_set_chained_handler(MIPS_CPU_IRQ_BASE + TX4939_IRC_INT,\r\nhandle_simple_irq);\r\ntx4939_irq_set_pri(TX4939_IR_WTOERR, 7);\r\ntx4939_irq_set_pri(TX4939_IR_PCIERR, 7);\r\ntx4939_irq_set_pri(TX4939_IR_PCIPME, 7);\r\nfor (i = 0; i < TX4939_NUM_IR_TMR; i++)\r\ntx4939_irq_set_pri(TX4939_IR_TMR(i), 6);\r\nfor (i = 0; i < TX4939_NUM_IR_SIO; i++)\r\ntx4939_irq_set_pri(TX4939_IR_SIO(i), 5);\r\n}\r\nint tx4939_irq(void)\r\n{\r\nu32 csr = __raw_readl(&tx4939_ircptr->cs.r);\r\nif (likely(!(csr & TXx9_IRCSR_IF)))\r\nreturn TXX9_IRQ_BASE + (csr & (TX4939_NUM_IR - 1));\r\nreturn -1;\r\n}

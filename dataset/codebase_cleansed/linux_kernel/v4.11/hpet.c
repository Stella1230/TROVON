static unsigned int smbus_read(int offset)\r\n{\r\nreturn *(volatile unsigned int *)(SMBUS_CFG_BASE + offset);\r\n}\r\nstatic void smbus_write(int offset, int data)\r\n{\r\n*(volatile unsigned int *)(SMBUS_CFG_BASE + offset) = data;\r\n}\r\nstatic void smbus_enable(int offset, int bit)\r\n{\r\nunsigned int cfg = smbus_read(offset);\r\ncfg |= bit;\r\nsmbus_write(offset, cfg);\r\n}\r\nstatic int hpet_read(int offset)\r\n{\r\nreturn *(volatile unsigned int *)(HPET_MMIO_ADDR + offset);\r\n}\r\nstatic void hpet_write(int offset, int data)\r\n{\r\n*(volatile unsigned int *)(HPET_MMIO_ADDR + offset) = data;\r\n}\r\nstatic void hpet_start_counter(void)\r\n{\r\nunsigned int cfg = hpet_read(HPET_CFG);\r\ncfg |= HPET_CFG_ENABLE;\r\nhpet_write(HPET_CFG, cfg);\r\n}\r\nstatic void hpet_stop_counter(void)\r\n{\r\nunsigned int cfg = hpet_read(HPET_CFG);\r\ncfg &= ~HPET_CFG_ENABLE;\r\nhpet_write(HPET_CFG, cfg);\r\n}\r\nstatic void hpet_reset_counter(void)\r\n{\r\nhpet_write(HPET_COUNTER, 0);\r\nhpet_write(HPET_COUNTER + 4, 0);\r\n}\r\nstatic void hpet_restart_counter(void)\r\n{\r\nhpet_stop_counter();\r\nhpet_reset_counter();\r\nhpet_start_counter();\r\n}\r\nstatic void hpet_enable_legacy_int(void)\r\n{\r\n}\r\nstatic int hpet_set_state_periodic(struct clock_event_device *evt)\r\n{\r\nint cfg;\r\nspin_lock(&hpet_lock);\r\npr_info("set clock event to periodic mode!\n");\r\nhpet_stop_counter();\r\ncfg = hpet_read(HPET_T0_CFG);\r\ncfg &= ~HPET_TN_LEVEL;\r\ncfg |= HPET_TN_ENABLE | HPET_TN_PERIODIC | HPET_TN_SETVAL |\r\nHPET_TN_32BIT;\r\nhpet_write(HPET_T0_CFG, cfg);\r\nhpet_write(HPET_T0_CMP, HPET_COMPARE_VAL);\r\nudelay(1);\r\nhpet_write(HPET_T0_CMP, HPET_COMPARE_VAL);\r\nhpet_start_counter();\r\nspin_unlock(&hpet_lock);\r\nreturn 0;\r\n}\r\nstatic int hpet_set_state_shutdown(struct clock_event_device *evt)\r\n{\r\nint cfg;\r\nspin_lock(&hpet_lock);\r\ncfg = hpet_read(HPET_T0_CFG);\r\ncfg &= ~HPET_TN_ENABLE;\r\nhpet_write(HPET_T0_CFG, cfg);\r\nspin_unlock(&hpet_lock);\r\nreturn 0;\r\n}\r\nstatic int hpet_set_state_oneshot(struct clock_event_device *evt)\r\n{\r\nint cfg;\r\nspin_lock(&hpet_lock);\r\npr_info("set clock event to one shot mode!\n");\r\ncfg = hpet_read(HPET_T0_CFG);\r\ncfg &= ~HPET_TN_PERIODIC;\r\ncfg |= HPET_TN_ENABLE | HPET_TN_32BIT;\r\nhpet_write(HPET_T0_CFG, cfg);\r\nspin_unlock(&hpet_lock);\r\nreturn 0;\r\n}\r\nstatic int hpet_tick_resume(struct clock_event_device *evt)\r\n{\r\nspin_lock(&hpet_lock);\r\nhpet_enable_legacy_int();\r\nspin_unlock(&hpet_lock);\r\nreturn 0;\r\n}\r\nstatic int hpet_next_event(unsigned long delta,\r\nstruct clock_event_device *evt)\r\n{\r\nu32 cnt;\r\ns32 res;\r\ncnt = hpet_read(HPET_COUNTER);\r\ncnt += (u32) delta;\r\nhpet_write(HPET_T0_CMP, cnt);\r\nres = (s32)(cnt - hpet_read(HPET_COUNTER));\r\nreturn res < HPET_MIN_CYCLES ? -ETIME : 0;\r\n}\r\nstatic irqreturn_t hpet_irq_handler(int irq, void *data)\r\n{\r\nint is_irq;\r\nstruct clock_event_device *cd;\r\nunsigned int cpu = smp_processor_id();\r\nis_irq = hpet_read(HPET_STATUS);\r\nif (is_irq & HPET_T0_IRS) {\r\nhpet_write(HPET_STATUS, HPET_T0_IRS);\r\ncd = &per_cpu(hpet_clockevent_device, cpu);\r\ncd->event_handler(cd);\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic void hpet_setup(void)\r\n{\r\nsmbus_write(SMBUS_PCI_REGB4, HPET_ADDR);\r\nsmbus_enable(SMBUS_PCI_REG40, (1 << 28));\r\nsmbus_enable(SMBUS_PCI_REG64, (1 << 10));\r\nhpet_enable_legacy_int();\r\n}\r\nvoid __init setup_hpet_timer(void)\r\n{\r\nunsigned int cpu = smp_processor_id();\r\nstruct clock_event_device *cd;\r\nhpet_setup();\r\ncd = &per_cpu(hpet_clockevent_device, cpu);\r\ncd->name = "hpet";\r\ncd->rating = 100;\r\ncd->features = CLOCK_EVT_FEAT_PERIODIC | CLOCK_EVT_FEAT_ONESHOT;\r\ncd->set_state_shutdown = hpet_set_state_shutdown;\r\ncd->set_state_periodic = hpet_set_state_periodic;\r\ncd->set_state_oneshot = hpet_set_state_oneshot;\r\ncd->tick_resume = hpet_tick_resume;\r\ncd->set_next_event = hpet_next_event;\r\ncd->irq = HPET_T0_IRQ;\r\ncd->cpumask = cpumask_of(cpu);\r\nclockevent_set_clock(cd, HPET_FREQ);\r\ncd->max_delta_ns = clockevent_delta2ns(0x7fffffff, cd);\r\ncd->min_delta_ns = clockevent_delta2ns(HPET_MIN_PROG_DELTA, cd);\r\nclockevents_register_device(cd);\r\nsetup_irq(HPET_T0_IRQ, &hpet_irq);\r\npr_info("hpet clock event device register\n");\r\n}\r\nstatic u64 hpet_read_counter(struct clocksource *cs)\r\n{\r\nreturn (u64)hpet_read(HPET_COUNTER);\r\n}\r\nstatic void hpet_suspend(struct clocksource *cs)\r\n{\r\n}\r\nstatic void hpet_resume(struct clocksource *cs)\r\n{\r\nhpet_setup();\r\nhpet_restart_counter();\r\n}\r\nint __init init_hpet_clocksource(void)\r\n{\r\ncsrc_hpet.mult = clocksource_hz2mult(HPET_FREQ, csrc_hpet.shift);\r\nreturn clocksource_register_hz(&csrc_hpet, HPET_FREQ);\r\n}

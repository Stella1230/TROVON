static int cmd_pending(struct hns_roce_dev *hr_dev)\r\n{\r\nu32 status = readl(hr_dev->cmd.hcr + HCR_TOKEN_OFFSET);\r\nreturn (!!(status & (1 << HCR_GO_BIT)));\r\n}\r\nstatic int __hns_roce_cmd_mbox_post_hw(struct hns_roce_dev *hr_dev,\r\nu64 in_param, u64 out_param,\r\nu32 in_modifier, u8 op_modifier, u16 op,\r\nu16 token, int event)\r\n{\r\nstruct hns_roce_cmdq *cmd = &hr_dev->cmd;\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nu32 __iomem *hcr = (u32 *)cmd->hcr;\r\nint ret = -EAGAIN;\r\nunsigned long end;\r\nu32 val = 0;\r\nend = msecs_to_jiffies(GO_BIT_TIMEOUT_MSECS) + jiffies;\r\nwhile (cmd_pending(hr_dev)) {\r\nif (time_after(jiffies, end)) {\r\ndev_dbg(dev, "jiffies=%d end=%d\n", (int)jiffies,\r\n(int)end);\r\ngoto out;\r\n}\r\ncond_resched();\r\n}\r\nroce_set_field(val, ROCEE_MB6_ROCEE_MB_CMD_M, ROCEE_MB6_ROCEE_MB_CMD_S,\r\nop);\r\nroce_set_field(val, ROCEE_MB6_ROCEE_MB_CMD_MDF_M,\r\nROCEE_MB6_ROCEE_MB_CMD_MDF_S, op_modifier);\r\nroce_set_bit(val, ROCEE_MB6_ROCEE_MB_EVENT_S, event);\r\nroce_set_bit(val, ROCEE_MB6_ROCEE_MB_HW_RUN_S, 1);\r\nroce_set_field(val, ROCEE_MB6_ROCEE_MB_TOKEN_M,\r\nROCEE_MB6_ROCEE_MB_TOKEN_S, token);\r\n__raw_writeq(cpu_to_le64(in_param), hcr + 0);\r\n__raw_writeq(cpu_to_le64(out_param), hcr + 2);\r\n__raw_writel(cpu_to_le32(in_modifier), hcr + 4);\r\nwmb();\r\n__raw_writel(cpu_to_le32(val), hcr + 5);\r\nmmiowb();\r\nret = 0;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int hns_roce_cmd_mbox_post_hw(struct hns_roce_dev *hr_dev, u64 in_param,\r\nu64 out_param, u32 in_modifier,\r\nu8 op_modifier, u16 op, u16 token,\r\nint event)\r\n{\r\nstruct hns_roce_cmdq *cmd = &hr_dev->cmd;\r\nint ret = -EAGAIN;\r\nmutex_lock(&cmd->hcr_mutex);\r\nret = __hns_roce_cmd_mbox_post_hw(hr_dev, in_param, out_param,\r\nin_modifier, op_modifier, op, token,\r\nevent);\r\nmutex_unlock(&cmd->hcr_mutex);\r\nreturn ret;\r\n}\r\nstatic int __hns_roce_cmd_mbox_poll(struct hns_roce_dev *hr_dev, u64 in_param,\r\nu64 out_param, unsigned long in_modifier,\r\nu8 op_modifier, u16 op,\r\nunsigned long timeout)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nu8 __iomem *hcr = hr_dev->cmd.hcr;\r\nunsigned long end = 0;\r\nu32 status = 0;\r\nint ret;\r\nret = hns_roce_cmd_mbox_post_hw(hr_dev, in_param, out_param,\r\nin_modifier, op_modifier, op,\r\nCMD_POLL_TOKEN, 0);\r\nif (ret) {\r\ndev_err(dev, "[cmd_poll]hns_roce_cmd_mbox_post_hw failed\n");\r\ngoto out;\r\n}\r\nend = msecs_to_jiffies(timeout) + jiffies;\r\nwhile (cmd_pending(hr_dev) && time_before(jiffies, end))\r\ncond_resched();\r\nif (cmd_pending(hr_dev)) {\r\ndev_err(dev, "[cmd_poll]hw run cmd TIMEDOUT!\n");\r\nret = -ETIMEDOUT;\r\ngoto out;\r\n}\r\nstatus = le32_to_cpu((__force __be32)\r\n__raw_readl(hcr + HCR_STATUS_OFFSET));\r\nif ((status & STATUS_MASK) != 0x1) {\r\ndev_err(dev, "mailbox status 0x%x!\n", status);\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nstatic int hns_roce_cmd_mbox_poll(struct hns_roce_dev *hr_dev, u64 in_param,\r\nu64 out_param, unsigned long in_modifier,\r\nu8 op_modifier, u16 op, unsigned long timeout)\r\n{\r\nint ret;\r\ndown(&hr_dev->cmd.poll_sem);\r\nret = __hns_roce_cmd_mbox_poll(hr_dev, in_param, out_param, in_modifier,\r\nop_modifier, op, timeout);\r\nup(&hr_dev->cmd.poll_sem);\r\nreturn ret;\r\n}\r\nvoid hns_roce_cmd_event(struct hns_roce_dev *hr_dev, u16 token, u8 status,\r\nu64 out_param)\r\n{\r\nstruct hns_roce_cmd_context\r\n*context = &hr_dev->cmd.context[token & hr_dev->cmd.token_mask];\r\nif (token != context->token)\r\nreturn;\r\ncontext->result = (status == HNS_ROCE_CMD_SUCCESS) ? 0 : (-EIO);\r\ncontext->out_param = out_param;\r\ncomplete(&context->done);\r\n}\r\nstatic int __hns_roce_cmd_mbox_wait(struct hns_roce_dev *hr_dev, u64 in_param,\r\nu64 out_param, unsigned long in_modifier,\r\nu8 op_modifier, u16 op,\r\nunsigned long timeout)\r\n{\r\nstruct hns_roce_cmdq *cmd = &hr_dev->cmd;\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nstruct hns_roce_cmd_context *context;\r\nint ret = 0;\r\nspin_lock(&cmd->context_lock);\r\nWARN_ON(cmd->free_head < 0);\r\ncontext = &cmd->context[cmd->free_head];\r\ncontext->token += cmd->token_mask + 1;\r\ncmd->free_head = context->next;\r\nspin_unlock(&cmd->context_lock);\r\ninit_completion(&context->done);\r\nret = hns_roce_cmd_mbox_post_hw(hr_dev, in_param, out_param,\r\nin_modifier, op_modifier, op,\r\ncontext->token, 1);\r\nif (ret)\r\ngoto out;\r\nif (!wait_for_completion_timeout(&context->done,\r\nmsecs_to_jiffies(timeout))) {\r\ndev_err(dev, "[cmd]wait_for_completion_timeout timeout\n");\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\nret = context->result;\r\nif (ret) {\r\ndev_err(dev, "[cmd]event mod cmd process error!err=%d\n", ret);\r\ngoto out;\r\n}\r\nout:\r\nspin_lock(&cmd->context_lock);\r\ncontext->next = cmd->free_head;\r\ncmd->free_head = context - cmd->context;\r\nspin_unlock(&cmd->context_lock);\r\nreturn ret;\r\n}\r\nstatic int hns_roce_cmd_mbox_wait(struct hns_roce_dev *hr_dev, u64 in_param,\r\nu64 out_param, unsigned long in_modifier,\r\nu8 op_modifier, u16 op, unsigned long timeout)\r\n{\r\nint ret = 0;\r\ndown(&hr_dev->cmd.event_sem);\r\nret = __hns_roce_cmd_mbox_wait(hr_dev, in_param, out_param,\r\nin_modifier, op_modifier, op, timeout);\r\nup(&hr_dev->cmd.event_sem);\r\nreturn ret;\r\n}\r\nint hns_roce_cmd_mbox(struct hns_roce_dev *hr_dev, u64 in_param, u64 out_param,\r\nunsigned long in_modifier, u8 op_modifier, u16 op,\r\nunsigned long timeout)\r\n{\r\nif (hr_dev->cmd.use_events)\r\nreturn hns_roce_cmd_mbox_wait(hr_dev, in_param, out_param,\r\nin_modifier, op_modifier, op,\r\ntimeout);\r\nelse\r\nreturn hns_roce_cmd_mbox_poll(hr_dev, in_param, out_param,\r\nin_modifier, op_modifier, op,\r\ntimeout);\r\n}\r\nint hns_roce_cmd_init(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct device *dev = &hr_dev->pdev->dev;\r\nmutex_init(&hr_dev->cmd.hcr_mutex);\r\nsema_init(&hr_dev->cmd.poll_sem, 1);\r\nhr_dev->cmd.use_events = 0;\r\nhr_dev->cmd.toggle = 1;\r\nhr_dev->cmd.max_cmds = CMD_MAX_NUM;\r\nhr_dev->cmd.hcr = hr_dev->reg_base + ROCEE_MB1_REG;\r\nhr_dev->cmd.pool = dma_pool_create("hns_roce_cmd", dev,\r\nHNS_ROCE_MAILBOX_SIZE,\r\nHNS_ROCE_MAILBOX_SIZE, 0);\r\nif (!hr_dev->cmd.pool)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nvoid hns_roce_cmd_cleanup(struct hns_roce_dev *hr_dev)\r\n{\r\ndma_pool_destroy(hr_dev->cmd.pool);\r\n}\r\nint hns_roce_cmd_use_events(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct hns_roce_cmdq *hr_cmd = &hr_dev->cmd;\r\nint i;\r\nhr_cmd->context = kmalloc(hr_cmd->max_cmds *\r\nsizeof(struct hns_roce_cmd_context),\r\nGFP_KERNEL);\r\nif (!hr_cmd->context)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < hr_cmd->max_cmds; ++i) {\r\nhr_cmd->context[i].token = i;\r\nhr_cmd->context[i].next = i + 1;\r\n}\r\nhr_cmd->context[hr_cmd->max_cmds - 1].next = -1;\r\nhr_cmd->free_head = 0;\r\nsema_init(&hr_cmd->event_sem, hr_cmd->max_cmds);\r\nspin_lock_init(&hr_cmd->context_lock);\r\nhr_cmd->token_mask = CMD_TOKEN_MASK;\r\nhr_cmd->use_events = 1;\r\ndown(&hr_cmd->poll_sem);\r\nreturn 0;\r\n}\r\nvoid hns_roce_cmd_use_polling(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct hns_roce_cmdq *hr_cmd = &hr_dev->cmd;\r\nint i;\r\nhr_cmd->use_events = 0;\r\nfor (i = 0; i < hr_cmd->max_cmds; ++i)\r\ndown(&hr_cmd->event_sem);\r\nkfree(hr_cmd->context);\r\nup(&hr_cmd->poll_sem);\r\n}\r\nstruct hns_roce_cmd_mailbox\r\n*hns_roce_alloc_cmd_mailbox(struct hns_roce_dev *hr_dev)\r\n{\r\nstruct hns_roce_cmd_mailbox *mailbox;\r\nmailbox = kmalloc(sizeof(*mailbox), GFP_KERNEL);\r\nif (!mailbox)\r\nreturn ERR_PTR(-ENOMEM);\r\nmailbox->buf = dma_pool_alloc(hr_dev->cmd.pool, GFP_KERNEL,\r\n&mailbox->dma);\r\nif (!mailbox->buf) {\r\nkfree(mailbox);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nreturn mailbox;\r\n}\r\nvoid hns_roce_free_cmd_mailbox(struct hns_roce_dev *hr_dev,\r\nstruct hns_roce_cmd_mailbox *mailbox)\r\n{\r\nif (!mailbox)\r\nreturn;\r\ndma_pool_free(hr_dev->cmd.pool, mailbox->buf, mailbox->dma);\r\nkfree(mailbox);\r\n}

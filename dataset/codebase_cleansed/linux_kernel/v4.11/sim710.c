static __init int\r\nparam_setup(char *str)\r\n{\r\nchar *pos = str, *next;\r\nint slot = -1;\r\nwhile(pos != NULL && (next = strchr(pos, ':')) != NULL) {\r\nint val = (int)simple_strtoul(++next, NULL, 0);\r\nif(!strncmp(pos, "slot:", 5))\r\nslot = val;\r\nelse if(!strncmp(pos, "id:", 3)) {\r\nif(slot == -1) {\r\nprintk(KERN_WARNING "sim710: Must specify slot for id parameter\n");\r\n} else if(slot >= MAX_SLOTS) {\r\nprintk(KERN_WARNING "sim710: Illegal slot %d for id %d\n", slot, val);\r\n} else {\r\nid_array[slot] = val;\r\n}\r\n}\r\nif((pos = strchr(pos, ARG_SEP)) != NULL)\r\npos++;\r\n}\r\nreturn 1;\r\n}\r\nstatic int sim710_probe_common(struct device *dev, unsigned long base_addr,\r\nint irq, int clock, int differential,\r\nint scsi_id)\r\n{\r\nstruct Scsi_Host * host = NULL;\r\nstruct NCR_700_Host_Parameters *hostdata =\r\nkzalloc(sizeof(struct NCR_700_Host_Parameters), GFP_KERNEL);\r\nprintk(KERN_NOTICE "sim710: %s\n", dev_name(dev));\r\nprintk(KERN_NOTICE "sim710: irq = %d, clock = %d, base = 0x%lx, scsi_id = %d\n",\r\nirq, clock, base_addr, scsi_id);\r\nif(hostdata == NULL) {\r\nprintk(KERN_ERR "sim710: Failed to allocate host data\n");\r\ngoto out;\r\n}\r\nif(request_region(base_addr, 64, "sim710") == NULL) {\r\nprintk(KERN_ERR "sim710: Failed to reserve IO region 0x%lx\n",\r\nbase_addr);\r\ngoto out_free;\r\n}\r\nhostdata->base = ioport_map(base_addr, 64);\r\nhostdata->differential = differential;\r\nhostdata->clock = clock;\r\nhostdata->chip710 = 1;\r\nhostdata->burst_length = 8;\r\nif((host = NCR_700_detect(&sim710_driver_template, hostdata, dev))\r\n== NULL) {\r\nprintk(KERN_ERR "sim710: No host detected; card configuration problem?\n");\r\ngoto out_release;\r\n}\r\nhost->this_id = scsi_id;\r\nhost->base = base_addr;\r\nhost->irq = irq;\r\nif (request_irq(irq, NCR_700_intr, IRQF_SHARED, "sim710", host)) {\r\nprintk(KERN_ERR "sim710: request_irq failed\n");\r\ngoto out_put_host;\r\n}\r\ndev_set_drvdata(dev, host);\r\nscsi_scan_host(host);\r\nreturn 0;\r\nout_put_host:\r\nscsi_host_put(host);\r\nout_release:\r\nrelease_region(base_addr, 64);\r\nout_free:\r\nkfree(hostdata);\r\nout:\r\nreturn -ENODEV;\r\n}\r\nstatic int sim710_device_remove(struct device *dev)\r\n{\r\nstruct Scsi_Host *host = dev_get_drvdata(dev);\r\nstruct NCR_700_Host_Parameters *hostdata =\r\n(struct NCR_700_Host_Parameters *)host->hostdata[0];\r\nscsi_remove_host(host);\r\nNCR_700_release(host);\r\nkfree(hostdata);\r\nfree_irq(host->irq, host);\r\nrelease_region(host->base, 64);\r\nreturn 0;\r\n}\r\nstatic int sim710_eisa_probe(struct device *dev)\r\n{\r\nstruct eisa_device *edev = to_eisa_device(dev);\r\nunsigned long io_addr = edev->base_addr;\r\nchar eisa_cpq_irqs[] = { 11, 14, 15, 10, 9, 0 };\r\nchar eisa_hwp_irqs[] = { 3, 4, 5, 7, 12, 10, 11, 0};\r\nchar *eisa_irqs;\r\nunsigned char irq_index;\r\nunsigned char irq, differential = 0, scsi_id = 7;\r\nif(strcmp(edev->id.sig, "HWP0C80") == 0) {\r\n__u8 val;\r\neisa_irqs = eisa_hwp_irqs;\r\nirq_index = (inb(io_addr + 0xc85) & 0x7) - 1;\r\nval = inb(io_addr + 0x4);\r\nscsi_id = ffs(val) - 1;\r\nif(scsi_id > 7 || (val & ~(1<<scsi_id)) != 0) {\r\nprintk(KERN_ERR "sim710.c, EISA card %s has incorrect scsi_id, setting to 7\n", dev_name(dev));\r\nscsi_id = 7;\r\n}\r\n} else {\r\neisa_irqs = eisa_cpq_irqs;\r\nirq_index = inb(io_addr + 0xc88) & 0x07;\r\n}\r\nif(irq_index >= strlen(eisa_irqs)) {\r\nprintk("sim710.c: irq nasty\n");\r\nreturn -ENODEV;\r\n}\r\nirq = eisa_irqs[irq_index];\r\nreturn sim710_probe_common(dev, io_addr, irq, 50,\r\ndifferential, scsi_id);\r\n}\r\nstatic int __init sim710_init(void)\r\n{\r\nint err = -ENODEV;\r\n#ifdef MODULE\r\nif (sim710)\r\nparam_setup(sim710);\r\n#endif\r\n#ifdef CONFIG_EISA\r\nerr = eisa_driver_register(&sim710_eisa_driver);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void __exit sim710_exit(void)\r\n{\r\n#ifdef CONFIG_EISA\r\neisa_driver_unregister(&sim710_eisa_driver);\r\n#endif\r\n}

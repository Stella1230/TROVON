int sharpsl_pm_pxa_read_max1111(int channel)\r\n{\r\nif (machine_is_tosa())\r\nreturn 0;\r\nreturn max1111_read_channel(channel >> 1);\r\n}\r\nstatic int get_percentage(int voltage)\r\n{\r\nint i = sharpsl_pm.machinfo->bat_levels - 1;\r\nint bl_status = sharpsl_pm.machinfo->backlight_get_status ? sharpsl_pm.machinfo->backlight_get_status() : 0;\r\nstruct battery_thresh *thresh;\r\nif (sharpsl_pm.charge_mode == CHRG_ON)\r\nthresh = bl_status ? sharpsl_pm.machinfo->bat_levels_acin_bl : sharpsl_pm.machinfo->bat_levels_acin;\r\nelse\r\nthresh = bl_status ? sharpsl_pm.machinfo->bat_levels_noac_bl : sharpsl_pm.machinfo->bat_levels_noac;\r\nwhile (i > 0 && (voltage > thresh[i].voltage))\r\ni--;\r\nreturn thresh[i].percentage;\r\n}\r\nstatic int get_apm_status(int voltage)\r\n{\r\nint low_thresh, high_thresh;\r\nif (sharpsl_pm.charge_mode == CHRG_ON) {\r\nhigh_thresh = sharpsl_pm.machinfo->status_high_acin;\r\nlow_thresh = sharpsl_pm.machinfo->status_low_acin;\r\n} else {\r\nhigh_thresh = sharpsl_pm.machinfo->status_high_noac;\r\nlow_thresh = sharpsl_pm.machinfo->status_low_noac;\r\n}\r\nif (voltage >= high_thresh)\r\nreturn APM_BATTERY_STATUS_HIGH;\r\nif (voltage >= low_thresh)\r\nreturn APM_BATTERY_STATUS_LOW;\r\nreturn APM_BATTERY_STATUS_CRITICAL;\r\n}\r\nvoid sharpsl_battery_kick(void)\r\n{\r\nschedule_delayed_work(&sharpsl_bat, msecs_to_jiffies(125));\r\n}\r\nstatic void sharpsl_battery_thread(struct work_struct *private_)\r\n{\r\nint voltage, percent, apm_status, i;\r\nif (!sharpsl_pm.machinfo)\r\nreturn;\r\nsharpsl_pm.battstat.ac_status = (sharpsl_pm.machinfo->read_devdata(SHARPSL_STATUS_ACIN) ? APM_AC_ONLINE : APM_AC_OFFLINE);\r\nif (!sharpsl_pm.machinfo->batfull_irq && (sharpsl_pm.charge_mode == CHRG_ON)\r\n&& time_after(jiffies, sharpsl_pm.charge_start_time + SHARPSL_CHARGE_ON_TIME_INTERVAL))\r\nschedule_delayed_work(&toggle_charger, 0);\r\nfor (i = 0; i < 5; i++) {\r\nvoltage = sharpsl_pm.machinfo->read_devdata(SHARPSL_BATT_VOLT);\r\nif (voltage > 0)\r\nbreak;\r\n}\r\nif (voltage <= 0) {\r\nvoltage = sharpsl_pm.machinfo->bat_levels_noac[0].voltage;\r\ndev_warn(sharpsl_pm.dev, "Warning: Cannot read main battery!\n");\r\n}\r\nvoltage = sharpsl_average_value(voltage);\r\napm_status = get_apm_status(voltage);\r\npercent = get_percentage(voltage);\r\nif ((sharpsl_pm.battstat.ac_status == APM_AC_ONLINE)\r\n|| (apm_status == APM_BATTERY_STATUS_HIGH)\r\n|| percent <= sharpsl_pm.battstat.mainbat_percent) {\r\nsharpsl_pm.battstat.mainbat_voltage = voltage;\r\nsharpsl_pm.battstat.mainbat_status = apm_status;\r\nsharpsl_pm.battstat.mainbat_percent = percent;\r\n}\r\ndev_dbg(sharpsl_pm.dev, "Battery: voltage: %d, status: %d, percentage: %d, time: %ld\n", voltage,\r\nsharpsl_pm.battstat.mainbat_status, sharpsl_pm.battstat.mainbat_percent, jiffies);\r\nif ((sharpsl_pm.battstat.ac_status != APM_AC_ONLINE)\r\n&& (sharpsl_pm.battstat.mainbat_status == APM_BATTERY_STATUS_CRITICAL)\r\n&& !(sharpsl_pm.flags & SHARPSL_APM_QUEUED)) {\r\nsharpsl_pm.flags |= SHARPSL_APM_QUEUED;\r\ndev_err(sharpsl_pm.dev, "Fatal Off\n");\r\napm_queue_event(APM_CRITICAL_SUSPEND);\r\n}\r\nschedule_delayed_work(&sharpsl_bat, SHARPSL_BATCHK_TIME);\r\n}\r\nvoid sharpsl_pm_led(int val)\r\n{\r\nif (val == SHARPSL_LED_ERROR) {\r\ndev_err(sharpsl_pm.dev, "Charging Error!\n");\r\n} else if (val == SHARPSL_LED_ON) {\r\ndev_dbg(sharpsl_pm.dev, "Charge LED On\n");\r\nled_trigger_event(sharpsl_charge_led_trigger, LED_FULL);\r\n} else {\r\ndev_dbg(sharpsl_pm.dev, "Charge LED Off\n");\r\nled_trigger_event(sharpsl_charge_led_trigger, LED_OFF);\r\n}\r\n}\r\nstatic void sharpsl_charge_on(void)\r\n{\r\ndev_dbg(sharpsl_pm.dev, "Turning Charger On\n");\r\nsharpsl_pm.full_count = 0;\r\nsharpsl_pm.charge_mode = CHRG_ON;\r\nschedule_delayed_work(&toggle_charger, msecs_to_jiffies(250));\r\nschedule_delayed_work(&sharpsl_bat, msecs_to_jiffies(500));\r\n}\r\nstatic void sharpsl_charge_off(void)\r\n{\r\ndev_dbg(sharpsl_pm.dev, "Turning Charger Off\n");\r\nsharpsl_pm.machinfo->charge(0);\r\nsharpsl_pm_led(SHARPSL_LED_OFF);\r\nsharpsl_pm.charge_mode = CHRG_OFF;\r\nschedule_delayed_work(&sharpsl_bat, 0);\r\n}\r\nstatic void sharpsl_charge_error(void)\r\n{\r\nsharpsl_pm_led(SHARPSL_LED_ERROR);\r\nsharpsl_pm.machinfo->charge(0);\r\nsharpsl_pm.charge_mode = CHRG_ERROR;\r\n}\r\nstatic void sharpsl_charge_toggle(struct work_struct *private_)\r\n{\r\ndev_dbg(sharpsl_pm.dev, "Toggling Charger at time: %lx\n", jiffies);\r\nif (!sharpsl_pm.machinfo->read_devdata(SHARPSL_STATUS_ACIN)) {\r\nsharpsl_charge_off();\r\nreturn;\r\n} else if ((sharpsl_check_battery_temp() < 0) || (sharpsl_ac_check() < 0)) {\r\nsharpsl_charge_error();\r\nreturn;\r\n}\r\nsharpsl_pm_led(SHARPSL_LED_ON);\r\nsharpsl_pm.machinfo->charge(0);\r\nmdelay(SHARPSL_CHARGE_WAIT_TIME);\r\nsharpsl_pm.machinfo->charge(1);\r\nsharpsl_pm.charge_start_time = jiffies;\r\n}\r\nstatic void sharpsl_ac_timer(unsigned long data)\r\n{\r\nint acin = sharpsl_pm.machinfo->read_devdata(SHARPSL_STATUS_ACIN);\r\ndev_dbg(sharpsl_pm.dev, "AC Status: %d\n", acin);\r\nsharpsl_average_clear();\r\nif (acin && (sharpsl_pm.charge_mode != CHRG_ON))\r\nsharpsl_charge_on();\r\nelse if (sharpsl_pm.charge_mode == CHRG_ON)\r\nsharpsl_charge_off();\r\nschedule_delayed_work(&sharpsl_bat, 0);\r\n}\r\nstatic irqreturn_t sharpsl_ac_isr(int irq, void *dev_id)\r\n{\r\nmod_timer(&sharpsl_pm.ac_timer, jiffies + msecs_to_jiffies(250));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void sharpsl_chrg_full_timer(unsigned long data)\r\n{\r\ndev_dbg(sharpsl_pm.dev, "Charge Full at time: %lx\n", jiffies);\r\nsharpsl_pm.full_count++;\r\nif (!sharpsl_pm.machinfo->read_devdata(SHARPSL_STATUS_ACIN)) {\r\ndev_dbg(sharpsl_pm.dev, "Charge Full: AC removed - stop charging!\n");\r\nif (sharpsl_pm.charge_mode == CHRG_ON)\r\nsharpsl_charge_off();\r\n} else if (sharpsl_pm.full_count < 2) {\r\ndev_dbg(sharpsl_pm.dev, "Charge Full: Count too low\n");\r\nschedule_delayed_work(&toggle_charger, 0);\r\n} else if (time_after(jiffies, sharpsl_pm.charge_start_time + SHARPSL_CHARGE_FINISH_TIME)) {\r\ndev_dbg(sharpsl_pm.dev, "Charge Full: Interrupt generated too slowly - retry.\n");\r\nschedule_delayed_work(&toggle_charger, 0);\r\n} else {\r\nsharpsl_charge_off();\r\nsharpsl_pm.charge_mode = CHRG_DONE;\r\ndev_dbg(sharpsl_pm.dev, "Charge Full: Charging Finished\n");\r\n}\r\n}\r\nstatic irqreturn_t sharpsl_chrg_full_isr(int irq, void *dev_id)\r\n{\r\nif (sharpsl_pm.flags & SHARPSL_SUSPENDED)\r\nreturn IRQ_HANDLED;\r\nmod_timer(&sharpsl_pm.chrg_full_timer, jiffies + msecs_to_jiffies(500));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t sharpsl_fatal_isr(int irq, void *dev_id)\r\n{\r\nint is_fatal = 0;\r\nif (!sharpsl_pm.machinfo->read_devdata(SHARPSL_STATUS_LOCK)) {\r\ndev_err(sharpsl_pm.dev, "Battery now Unlocked! Suspending.\n");\r\nis_fatal = 1;\r\n}\r\nif (!sharpsl_pm.machinfo->read_devdata(SHARPSL_STATUS_FATAL)) {\r\ndev_err(sharpsl_pm.dev, "Fatal Batt Error! Suspending.\n");\r\nis_fatal = 1;\r\n}\r\nif (!(sharpsl_pm.flags & SHARPSL_APM_QUEUED) && is_fatal) {\r\nsharpsl_pm.flags |= SHARPSL_APM_QUEUED;\r\napm_queue_event(APM_CRITICAL_SUSPEND);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void sharpsl_average_clear(void)\r\n{\r\nsharpsl_ad_index = 0;\r\n}\r\nstatic int sharpsl_average_value(int ad)\r\n{\r\nint i, ad_val = 0;\r\nstatic int sharpsl_ad[SHARPSL_CNV_VALUE_NUM+1];\r\nif (sharpsl_pm.battstat.mainbat_status != APM_BATTERY_STATUS_HIGH) {\r\nsharpsl_ad_index = 0;\r\nreturn ad;\r\n}\r\nsharpsl_ad[sharpsl_ad_index] = ad;\r\nsharpsl_ad_index++;\r\nif (sharpsl_ad_index >= SHARPSL_CNV_VALUE_NUM) {\r\nfor (i = 0; i < (SHARPSL_CNV_VALUE_NUM-1); i++)\r\nsharpsl_ad[i] = sharpsl_ad[i+1];\r\nsharpsl_ad_index = SHARPSL_CNV_VALUE_NUM - 1;\r\n}\r\nfor (i = 0; i < sharpsl_ad_index; i++)\r\nad_val += sharpsl_ad[i];\r\nreturn ad_val / sharpsl_ad_index;\r\n}\r\nstatic int get_select_val(int *val)\r\n{\r\nint i, j, k, temp, sum = 0;\r\ntemp = val[0];\r\nj = 0;\r\nfor (i = 1; i < 5; i++) {\r\nif (temp < val[i]) {\r\ntemp = val[i];\r\nj = i;\r\n}\r\n}\r\ntemp = val[4];\r\nk = 4;\r\nfor (i = 3; i >= 0; i--) {\r\nif (temp > val[i]) {\r\ntemp = val[i];\r\nk = i;\r\n}\r\n}\r\nfor (i = 0; i < 5; i++)\r\nif (i != j && i != k)\r\nsum += val[i];\r\ndev_dbg(sharpsl_pm.dev, "Average: %d from values: %d, %d, %d, %d, %d\n", sum/3, val[0], val[1], val[2], val[3], val[4]);\r\nreturn sum/3;\r\n}\r\nstatic int sharpsl_check_battery_temp(void)\r\n{\r\nint val, i, buff[5];\r\nfor (i = 0; i < 5; i++) {\r\nmdelay(SHARPSL_CHECK_BATTERY_WAIT_TIME_TEMP);\r\nsharpsl_pm.machinfo->measure_temp(1);\r\nmdelay(SHARPSL_CHECK_BATTERY_WAIT_TIME_TEMP);\r\nbuff[i] = sharpsl_pm.machinfo->read_devdata(SHARPSL_BATT_TEMP);\r\nsharpsl_pm.machinfo->measure_temp(0);\r\n}\r\nval = get_select_val(buff);\r\ndev_dbg(sharpsl_pm.dev, "Temperature: %d\n", val);\r\nif (val > sharpsl_pm.machinfo->charge_on_temp) {\r\nprintk(KERN_WARNING "Not charging: temperature out of limits.\n");\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sharpsl_check_battery_voltage(void)\r\n{\r\nint val, i, buff[5];\r\nsharpsl_pm.machinfo->charge(0);\r\nsharpsl_pm.machinfo->discharge(1);\r\nmdelay(SHARPSL_WAIT_DISCHARGE_ON);\r\nif (sharpsl_pm.machinfo->discharge1)\r\nsharpsl_pm.machinfo->discharge1(1);\r\nfor (i = 0; i < 5; i++) {\r\nbuff[i] = sharpsl_pm.machinfo->read_devdata(SHARPSL_BATT_VOLT);\r\nmdelay(SHARPSL_CHECK_BATTERY_WAIT_TIME_VOLT);\r\n}\r\nif (sharpsl_pm.machinfo->discharge1)\r\nsharpsl_pm.machinfo->discharge1(0);\r\nsharpsl_pm.machinfo->discharge(0);\r\nval = get_select_val(buff);\r\ndev_dbg(sharpsl_pm.dev, "Battery Voltage: %d\n", val);\r\nif (val < sharpsl_pm.machinfo->charge_on_volt)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int sharpsl_ac_check(void)\r\n{\r\nint temp, i, buff[5];\r\nfor (i = 0; i < 5; i++) {\r\nbuff[i] = sharpsl_pm.machinfo->read_devdata(SHARPSL_ACIN_VOLT);\r\nmdelay(SHARPSL_CHECK_BATTERY_WAIT_TIME_ACIN);\r\n}\r\ntemp = get_select_val(buff);\r\ndev_dbg(sharpsl_pm.dev, "AC Voltage: %d\n", temp);\r\nif ((temp > sharpsl_pm.machinfo->charge_acin_high) || (temp < sharpsl_pm.machinfo->charge_acin_low)) {\r\ndev_err(sharpsl_pm.dev, "Error: AC check failed: voltage %d.\n", temp);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sharpsl_pm_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nsharpsl_pm.flags |= SHARPSL_SUSPENDED;\r\nflush_delayed_work(&toggle_charger);\r\nflush_delayed_work(&sharpsl_bat);\r\nif (sharpsl_pm.charge_mode == CHRG_ON)\r\nsharpsl_pm.flags |= SHARPSL_DO_OFFLINE_CHRG;\r\nelse\r\nsharpsl_pm.flags &= ~SHARPSL_DO_OFFLINE_CHRG;\r\nreturn 0;\r\n}\r\nstatic int sharpsl_pm_resume(struct platform_device *pdev)\r\n{\r\nRCSR = 0x0f;\r\nsharpsl_average_clear();\r\nsharpsl_pm.flags &= ~SHARPSL_APM_QUEUED;\r\nsharpsl_pm.flags &= ~SHARPSL_SUSPENDED;\r\nreturn 0;\r\n}\r\nstatic void corgi_goto_sleep(unsigned long alarm_time, unsigned int alarm_enable, suspend_state_t state)\r\n{\r\ndev_dbg(sharpsl_pm.dev, "Time is: %08x\n", RCNR);\r\ndev_dbg(sharpsl_pm.dev, "Offline Charge Activate = %d\n", sharpsl_pm.flags & SHARPSL_DO_OFFLINE_CHRG);\r\nif ((sharpsl_pm.flags & SHARPSL_DO_OFFLINE_CHRG) && (sharpsl_pm.machinfo->read_devdata(SHARPSL_STATUS_ACIN))) {\r\ndev_dbg(sharpsl_pm.dev, "Activating Offline Charger...\n");\r\nsharpsl_pm.charge_mode = CHRG_OFF;\r\nsharpsl_pm.flags &= ~SHARPSL_DO_OFFLINE_CHRG;\r\nsharpsl_off_charge_battery();\r\n}\r\nsharpsl_pm.machinfo->presuspend();\r\nPEDR = 0xffffffff;\r\nsharpsl_pm.flags &= ~SHARPSL_ALARM_ACTIVE;\r\nif ((sharpsl_pm.charge_mode == CHRG_ON) && ((alarm_enable && ((alarm_time - RCNR) > (SHARPSL_BATCHK_TIME_SUSPEND + 30))) || !alarm_enable)) {\r\nRTSR &= RTSR_ALE;\r\nRTAR = RCNR + SHARPSL_BATCHK_TIME_SUSPEND;\r\ndev_dbg(sharpsl_pm.dev, "Charging alarm at: %08x\n", RTAR);\r\nsharpsl_pm.flags |= SHARPSL_ALARM_ACTIVE;\r\n} else if (alarm_enable) {\r\nRTSR &= RTSR_ALE;\r\nRTAR = alarm_time;\r\ndev_dbg(sharpsl_pm.dev, "User alarm at: %08x\n", RTAR);\r\n} else {\r\ndev_dbg(sharpsl_pm.dev, "No alarms set.\n");\r\n}\r\npxa_pm_enter(state);\r\nsharpsl_pm.machinfo->postsuspend();\r\ndev_dbg(sharpsl_pm.dev, "Corgi woken up from suspend: %08x\n", PEDR);\r\n}\r\nstatic int corgi_enter_suspend(unsigned long alarm_time, unsigned int alarm_enable, suspend_state_t state)\r\n{\r\nif (!sharpsl_pm.machinfo->should_wakeup(!(sharpsl_pm.flags & SHARPSL_ALARM_ACTIVE) && alarm_enable)) {\r\nif (!(sharpsl_pm.flags & SHARPSL_ALARM_ACTIVE)) {\r\ndev_dbg(sharpsl_pm.dev, "No user triggered wakeup events and not charging. Strange. Suspend.\n");\r\ncorgi_goto_sleep(alarm_time, alarm_enable, state);\r\nreturn 1;\r\n}\r\nif (sharpsl_off_charge_battery()) {\r\ndev_dbg(sharpsl_pm.dev, "Charging. Suspend...\n");\r\ncorgi_goto_sleep(alarm_time, alarm_enable, state);\r\nreturn 1;\r\n}\r\ndev_dbg(sharpsl_pm.dev, "User triggered wakeup in offline charger.\n");\r\n}\r\nif ((!sharpsl_pm.machinfo->read_devdata(SHARPSL_STATUS_LOCK)) ||\r\n(!sharpsl_pm.machinfo->read_devdata(SHARPSL_STATUS_FATAL))) {\r\ndev_err(sharpsl_pm.dev, "Fatal condition. Suspend.\n");\r\ncorgi_goto_sleep(alarm_time, alarm_enable, state);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int corgi_pxa_pm_enter(suspend_state_t state)\r\n{\r\nunsigned long alarm_time = RTAR;\r\nunsigned int alarm_status = ((RTSR & RTSR_ALE) != 0);\r\ndev_dbg(sharpsl_pm.dev, "SharpSL suspending for first time.\n");\r\ncorgi_goto_sleep(alarm_time, alarm_status, state);\r\nwhile (corgi_enter_suspend(alarm_time, alarm_status, state))\r\n{}\r\nif (sharpsl_pm.machinfo->earlyresume)\r\nsharpsl_pm.machinfo->earlyresume();\r\ndev_dbg(sharpsl_pm.dev, "SharpSL resuming...\n");\r\nreturn 0;\r\n}\r\nstatic int sharpsl_off_charge_error(void)\r\n{\r\ndev_err(sharpsl_pm.dev, "Offline Charger: Error occurred.\n");\r\nsharpsl_pm.machinfo->charge(0);\r\nsharpsl_pm_led(SHARPSL_LED_ERROR);\r\nsharpsl_pm.charge_mode = CHRG_ERROR;\r\nreturn 1;\r\n}\r\nstatic int sharpsl_off_charge_battery(void)\r\n{\r\nint time;\r\ndev_dbg(sharpsl_pm.dev, "Charge Mode: %d\n", sharpsl_pm.charge_mode);\r\nif (sharpsl_pm.charge_mode == CHRG_OFF) {\r\ndev_dbg(sharpsl_pm.dev, "Offline Charger: Step 1\n");\r\nif ((sharpsl_ac_check() < 0) || (sharpsl_check_battery_temp() < 0))\r\nreturn sharpsl_off_charge_error();\r\nsharpsl_pm_led(SHARPSL_LED_ON);\r\nsharpsl_pm.machinfo->charge(0);\r\nmdelay(SHARPSL_CHARGE_WAIT_TIME);\r\nsharpsl_pm.machinfo->charge(1);\r\nsharpsl_pm.charge_mode = CHRG_ON;\r\nsharpsl_pm.full_count = 0;\r\nreturn 1;\r\n} else if (sharpsl_pm.charge_mode != CHRG_ON) {\r\nreturn 1;\r\n}\r\nif (sharpsl_pm.full_count == 0) {\r\nint time;\r\ndev_dbg(sharpsl_pm.dev, "Offline Charger: Step 2\n");\r\nif ((sharpsl_check_battery_temp() < 0) || (sharpsl_check_battery_voltage() < 0))\r\nreturn sharpsl_off_charge_error();\r\nsharpsl_pm.machinfo->charge(0);\r\nmdelay(SHARPSL_CHARGE_WAIT_TIME);\r\nsharpsl_pm.machinfo->charge(1);\r\nsharpsl_pm.charge_mode = CHRG_ON;\r\nmdelay(SHARPSL_CHARGE_CO_CHECK_TIME);\r\ntime = RCNR;\r\nwhile (1) {\r\nif (sharpsl_pm.machinfo->charger_wakeup())\r\nreturn 0;\r\nif ((RCNR - time) > SHARPSL_WAIT_CO_TIME)\r\nreturn 1;\r\nif (sharpsl_pm.machinfo->read_devdata(SHARPSL_STATUS_CHRGFULL)) {\r\ndev_dbg(sharpsl_pm.dev, "Offline Charger: Charge full occurred. Retrying to check\n");\r\nsharpsl_pm.full_count++;\r\nsharpsl_pm.machinfo->charge(0);\r\nmdelay(SHARPSL_CHARGE_WAIT_TIME);\r\nsharpsl_pm.machinfo->charge(1);\r\nreturn 1;\r\n}\r\n}\r\n}\r\ndev_dbg(sharpsl_pm.dev, "Offline Charger: Step 3\n");\r\nmdelay(SHARPSL_CHARGE_CO_CHECK_TIME);\r\ntime = RCNR;\r\nwhile (1) {\r\nif (sharpsl_pm.machinfo->charger_wakeup())\r\nreturn 0;\r\nif ((RCNR-time) > SHARPSL_WAIT_CO_TIME) {\r\nif (sharpsl_pm.full_count > SHARPSL_CHARGE_RETRY_CNT) {\r\ndev_dbg(sharpsl_pm.dev, "Offline Charger: Not charged sufficiently. Retrying.\n");\r\nsharpsl_pm.full_count = 0;\r\n}\r\nsharpsl_pm.full_count++;\r\nreturn 1;\r\n}\r\nif (sharpsl_pm.machinfo->read_devdata(SHARPSL_STATUS_CHRGFULL)) {\r\ndev_dbg(sharpsl_pm.dev, "Offline Charger: Charging complete.\n");\r\nsharpsl_pm_led(SHARPSL_LED_OFF);\r\nsharpsl_pm.machinfo->charge(0);\r\nsharpsl_pm.charge_mode = CHRG_DONE;\r\nreturn 1;\r\n}\r\n}\r\n}\r\nstatic ssize_t battery_percentage_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", sharpsl_pm.battstat.mainbat_percent);\r\n}\r\nstatic ssize_t battery_voltage_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", sharpsl_pm.battstat.mainbat_voltage);\r\n}\r\nstatic void sharpsl_apm_get_power_status(struct apm_power_info *info)\r\n{\r\ninfo->ac_line_status = sharpsl_pm.battstat.ac_status;\r\nif (sharpsl_pm.charge_mode == CHRG_ON)\r\ninfo->battery_status = APM_BATTERY_STATUS_CHARGING;\r\nelse\r\ninfo->battery_status = sharpsl_pm.battstat.mainbat_status;\r\ninfo->battery_flag = (1 << info->battery_status);\r\ninfo->battery_life = sharpsl_pm.battstat.mainbat_percent;\r\n}\r\nstatic int sharpsl_pm_probe(struct platform_device *pdev)\r\n{\r\nint ret, irq;\r\nif (!pdev->dev.platform_data)\r\nreturn -EINVAL;\r\nsharpsl_pm.dev = &pdev->dev;\r\nsharpsl_pm.machinfo = pdev->dev.platform_data;\r\nsharpsl_pm.charge_mode = CHRG_OFF;\r\nsharpsl_pm.flags = 0;\r\nsetup_timer(&sharpsl_pm.ac_timer, sharpsl_ac_timer, 0UL);\r\nsetup_timer(&sharpsl_pm.chrg_full_timer, sharpsl_chrg_full_timer, 0UL);\r\nled_trigger_register_simple("sharpsl-charge", &sharpsl_charge_led_trigger);\r\nsharpsl_pm.machinfo->init();\r\ngpio_request(sharpsl_pm.machinfo->gpio_acin, "AC IN");\r\ngpio_direction_input(sharpsl_pm.machinfo->gpio_acin);\r\ngpio_request(sharpsl_pm.machinfo->gpio_batfull, "Battery Full");\r\ngpio_direction_input(sharpsl_pm.machinfo->gpio_batfull);\r\ngpio_request(sharpsl_pm.machinfo->gpio_batlock, "Battery Lock");\r\ngpio_direction_input(sharpsl_pm.machinfo->gpio_batlock);\r\nirq = gpio_to_irq(sharpsl_pm.machinfo->gpio_acin);\r\nif (request_irq(irq, sharpsl_ac_isr, IRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING, "AC Input Detect", sharpsl_ac_isr)) {\r\ndev_err(sharpsl_pm.dev, "Could not get irq %d.\n", irq);\r\n}\r\nirq = gpio_to_irq(sharpsl_pm.machinfo->gpio_batlock);\r\nif (request_irq(irq, sharpsl_fatal_isr, IRQF_TRIGGER_FALLING, "Battery Cover", sharpsl_fatal_isr)) {\r\ndev_err(sharpsl_pm.dev, "Could not get irq %d.\n", irq);\r\n}\r\nif (sharpsl_pm.machinfo->gpio_fatal) {\r\nirq = gpio_to_irq(sharpsl_pm.machinfo->gpio_fatal);\r\nif (request_irq(irq, sharpsl_fatal_isr, IRQF_TRIGGER_FALLING, "Fatal Battery", sharpsl_fatal_isr)) {\r\ndev_err(sharpsl_pm.dev, "Could not get irq %d.\n", irq);\r\n}\r\n}\r\nif (sharpsl_pm.machinfo->batfull_irq) {\r\nirq = gpio_to_irq(sharpsl_pm.machinfo->gpio_batfull);\r\nif (request_irq(irq, sharpsl_chrg_full_isr, IRQF_TRIGGER_RISING, "CO", sharpsl_chrg_full_isr)) {\r\ndev_err(sharpsl_pm.dev, "Could not get irq %d.\n", irq);\r\n}\r\n}\r\nret = device_create_file(&pdev->dev, &dev_attr_battery_percentage);\r\nret |= device_create_file(&pdev->dev, &dev_attr_battery_voltage);\r\nif (ret != 0)\r\ndev_warn(&pdev->dev, "Failed to register attributes (%d)\n", ret);\r\napm_get_power_status = sharpsl_apm_get_power_status;\r\n#ifdef CONFIG_PM\r\nsuspend_set_ops(&sharpsl_pm_ops);\r\n#endif\r\nmod_timer(&sharpsl_pm.ac_timer, jiffies + msecs_to_jiffies(250));\r\nreturn 0;\r\n}\r\nstatic int sharpsl_pm_remove(struct platform_device *pdev)\r\n{\r\nsuspend_set_ops(NULL);\r\ndevice_remove_file(&pdev->dev, &dev_attr_battery_percentage);\r\ndevice_remove_file(&pdev->dev, &dev_attr_battery_voltage);\r\nled_trigger_unregister_simple(sharpsl_charge_led_trigger);\r\nfree_irq(gpio_to_irq(sharpsl_pm.machinfo->gpio_acin), sharpsl_ac_isr);\r\nfree_irq(gpio_to_irq(sharpsl_pm.machinfo->gpio_batlock), sharpsl_fatal_isr);\r\nif (sharpsl_pm.machinfo->gpio_fatal)\r\nfree_irq(gpio_to_irq(sharpsl_pm.machinfo->gpio_fatal), sharpsl_fatal_isr);\r\nif (sharpsl_pm.machinfo->batfull_irq)\r\nfree_irq(gpio_to_irq(sharpsl_pm.machinfo->gpio_batfull), sharpsl_chrg_full_isr);\r\ngpio_free(sharpsl_pm.machinfo->gpio_batlock);\r\ngpio_free(sharpsl_pm.machinfo->gpio_batfull);\r\ngpio_free(sharpsl_pm.machinfo->gpio_acin);\r\nif (sharpsl_pm.machinfo->exit)\r\nsharpsl_pm.machinfo->exit();\r\ndel_timer_sync(&sharpsl_pm.chrg_full_timer);\r\ndel_timer_sync(&sharpsl_pm.ac_timer);\r\nreturn 0;\r\n}\r\nstatic int sharpsl_pm_init(void)\r\n{\r\nreturn platform_driver_register(&sharpsl_pm_driver);\r\n}\r\nstatic void sharpsl_pm_exit(void)\r\n{\r\nplatform_driver_unregister(&sharpsl_pm_driver);\r\n}

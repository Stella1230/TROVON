static int mc5_cmd_write(struct adapter *adapter, u32 cmd)\r\n{\r\nt3_write_reg(adapter, A_MC5_DB_DBGI_REQ_CMD, cmd);\r\nreturn t3_wait_op_done(adapter, A_MC5_DB_DBGI_RSP_STATUS,\r\nF_DBGIRSPVALID, 1, MAX_WRITE_ATTEMPTS, 1);\r\n}\r\nstatic inline void dbgi_wr_data3(struct adapter *adapter, u32 v1, u32 v2,\r\nu32 v3)\r\n{\r\nt3_write_reg(adapter, A_MC5_DB_DBGI_REQ_DATA0, v1);\r\nt3_write_reg(adapter, A_MC5_DB_DBGI_REQ_DATA1, v2);\r\nt3_write_reg(adapter, A_MC5_DB_DBGI_REQ_DATA2, v3);\r\n}\r\nstatic int mc5_write(struct adapter *adapter, u32 addr_lo, u32 cmd)\r\n{\r\nt3_write_reg(adapter, A_MC5_DB_DBGI_REQ_ADDR0, addr_lo);\r\nif (mc5_cmd_write(adapter, cmd) == 0)\r\nreturn 0;\r\nCH_ERR(adapter, "MC5 timeout writing to TCAM address 0x%x\n",\r\naddr_lo);\r\nreturn -1;\r\n}\r\nstatic int init_mask_data_array(struct mc5 *mc5, u32 mask_array_base,\r\nu32 data_array_base, u32 write_cmd,\r\nint addr_shift)\r\n{\r\nunsigned int i;\r\nstruct adapter *adap = mc5->adapter;\r\nunsigned int size72 = mc5->tcam_size;\r\nunsigned int server_base = t3_read_reg(adap, A_MC5_DB_SERVER_INDEX);\r\nif (mc5->mode == MC5_MODE_144_BIT) {\r\nsize72 *= 2;\r\nserver_base *= 2;\r\n}\r\ndbgi_wr_data3(adap, 0, 0, 0);\r\nfor (i = 0; i < size72; i++)\r\nif (mc5_write(adap, data_array_base + (i << addr_shift),\r\nwrite_cmd))\r\nreturn -1;\r\ndbgi_wr_data3(adap, 0xffffffff, 0xffffffff, 0xff);\r\nfor (i = 0; i < size72; i++) {\r\nif (i == server_base)\r\nt3_write_reg(adap, A_MC5_DB_DBGI_REQ_DATA0,\r\nmc5->mode == MC5_MODE_144_BIT ?\r\n0xfffffff9 : 0xfffffffd);\r\nif (mc5_write(adap, mask_array_base + (i << addr_shift),\r\nwrite_cmd))\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int init_idt52100(struct mc5 *mc5)\r\n{\r\nint i;\r\nstruct adapter *adap = mc5->adapter;\r\nt3_write_reg(adap, A_MC5_DB_RSP_LATENCY,\r\nV_RDLAT(0x15) | V_LRNLAT(0x15) | V_SRCHLAT(0x15));\r\nt3_write_reg(adap, A_MC5_DB_PART_ID_INDEX, 2);\r\nt3_write_reg(adap, A_MC5_DB_POPEN_DATA_WR_CMD, IDT_CMD_WRITE);\r\nt3_write_reg(adap, A_MC5_DB_POPEN_MASK_WR_CMD, IDT_CMD_WRITE);\r\nt3_write_reg(adap, A_MC5_DB_AOPEN_SRCH_CMD, IDT_CMD_SEARCH);\r\nt3_write_reg(adap, A_MC5_DB_AOPEN_LRN_CMD, IDT_CMD_LEARN);\r\nt3_write_reg(adap, A_MC5_DB_SYN_SRCH_CMD, IDT_CMD_SEARCH | 0x6000);\r\nt3_write_reg(adap, A_MC5_DB_SYN_LRN_CMD, IDT_CMD_LEARN);\r\nt3_write_reg(adap, A_MC5_DB_ACK_SRCH_CMD, IDT_CMD_SEARCH);\r\nt3_write_reg(adap, A_MC5_DB_ACK_LRN_CMD, IDT_CMD_LEARN);\r\nt3_write_reg(adap, A_MC5_DB_ILOOKUP_CMD, IDT_CMD_SEARCH);\r\nt3_write_reg(adap, A_MC5_DB_ELOOKUP_CMD, IDT_CMD_SEARCH | 0x7000);\r\nt3_write_reg(adap, A_MC5_DB_DATA_WRITE_CMD, IDT_CMD_WRITE);\r\nt3_write_reg(adap, A_MC5_DB_DATA_READ_CMD, IDT_CMD_READ);\r\nt3_write_reg(adap, A_MC5_DB_DBGI_CONFIG, DBGI_MODE_IDT52100);\r\ndbgi_wr_data3(adap, IDT_LAR_MODE144, 0, 0);\r\nif (mc5_write(adap, IDT_LAR_ADR0, IDT_CMD_WRITE))\r\ngoto err;\r\ndbgi_wr_data3(adap, 0xffffffff, 0xffffffff, 0);\r\nif (mc5_write(adap, IDT_SSR0_ADR0, IDT_CMD_WRITE) ||\r\nmc5_write(adap, IDT_SSR1_ADR0, IDT_CMD_WRITE))\r\ngoto err;\r\nfor (i = 0; i < 32; ++i) {\r\nif (i >= 12 && i < 15)\r\ndbgi_wr_data3(adap, 0xfffffff9, 0xffffffff, 0xff);\r\nelse if (i == 15)\r\ndbgi_wr_data3(adap, 0xfffffff9, 0xffff8007, 0xff);\r\nelse\r\ndbgi_wr_data3(adap, 0xffffffff, 0xffffffff, 0xff);\r\nif (mc5_write(adap, IDT_GMR_BASE_ADR0 + i, IDT_CMD_WRITE))\r\ngoto err;\r\n}\r\ndbgi_wr_data3(adap, 1, 0, 0);\r\nif (mc5_write(adap, IDT_SCR_ADR0, IDT_CMD_WRITE))\r\ngoto err;\r\nreturn init_mask_data_array(mc5, IDT_MSKARY_BASE_ADR0,\r\nIDT_DATARY_BASE_ADR0, IDT_CMD_WRITE, 0);\r\nerr:\r\nreturn -EIO;\r\n}\r\nstatic int init_idt43102(struct mc5 *mc5)\r\n{\r\nint i;\r\nstruct adapter *adap = mc5->adapter;\r\nt3_write_reg(adap, A_MC5_DB_RSP_LATENCY,\r\nadap->params.rev == 0 ? V_RDLAT(0xd) | V_SRCHLAT(0x11) :\r\nV_RDLAT(0xd) | V_SRCHLAT(0x12));\r\nt3_write_reg(adap, A_MC5_DB_POPEN_DATA_WR_CMD, IDT4_CMD_WRITE);\r\nt3_write_reg(adap, A_MC5_DB_POPEN_MASK_WR_CMD, IDT4_CMD_WRITE);\r\nt3_write_reg(adap, A_MC5_DB_AOPEN_SRCH_CMD,\r\nIDT4_CMD_SEARCH144 | 0x3800);\r\nt3_write_reg(adap, A_MC5_DB_SYN_SRCH_CMD, IDT4_CMD_SEARCH144);\r\nt3_write_reg(adap, A_MC5_DB_ACK_SRCH_CMD, IDT4_CMD_SEARCH144 | 0x3800);\r\nt3_write_reg(adap, A_MC5_DB_ILOOKUP_CMD, IDT4_CMD_SEARCH144 | 0x3800);\r\nt3_write_reg(adap, A_MC5_DB_ELOOKUP_CMD, IDT4_CMD_SEARCH144 | 0x800);\r\nt3_write_reg(adap, A_MC5_DB_DATA_WRITE_CMD, IDT4_CMD_WRITE);\r\nt3_write_reg(adap, A_MC5_DB_DATA_READ_CMD, IDT4_CMD_READ);\r\nt3_write_reg(adap, A_MC5_DB_PART_ID_INDEX, 3);\r\nt3_write_reg(adap, A_MC5_DB_DBGI_CONFIG, DBGI_MODE_IDT52100);\r\ndbgi_wr_data3(adap, 0xffffffff, 0xffffffff, 0xff);\r\nfor (i = 0; i < 7; ++i)\r\nif (mc5_write(adap, IDT4_GMR_BASE0 + i, IDT4_CMD_WRITE))\r\ngoto err;\r\nfor (i = 0; i < 4; ++i)\r\nif (mc5_write(adap, IDT4_GMR_BASE2 + i, IDT4_CMD_WRITE))\r\ngoto err;\r\ndbgi_wr_data3(adap, 0xfffffff9, 0xffffffff, 0xff);\r\nif (mc5_write(adap, IDT4_GMR_BASE1, IDT4_CMD_WRITE) ||\r\nmc5_write(adap, IDT4_GMR_BASE1 + 1, IDT4_CMD_WRITE) ||\r\nmc5_write(adap, IDT4_GMR_BASE1 + 4, IDT4_CMD_WRITE))\r\ngoto err;\r\ndbgi_wr_data3(adap, 0xfffffff9, 0xffff8007, 0xff);\r\nif (mc5_write(adap, IDT4_GMR_BASE1 + 5, IDT4_CMD_WRITE))\r\ngoto err;\r\ndbgi_wr_data3(adap, 0xf0000000, 0, 0);\r\nif (mc5_write(adap, IDT4_SCR_ADR0, IDT4_CMD_WRITE))\r\ngoto err;\r\nreturn init_mask_data_array(mc5, IDT4_MSKARY_BASE_ADR0,\r\nIDT4_DATARY_BASE_ADR0, IDT4_CMD_WRITE, 1);\r\nerr:\r\nreturn -EIO;\r\n}\r\nstatic inline void mc5_dbgi_mode_enable(const struct mc5 *mc5)\r\n{\r\nt3_write_reg(mc5->adapter, A_MC5_DB_CONFIG,\r\nV_TMMODE(mc5->mode == MC5_MODE_72_BIT) | F_DBGIEN);\r\n}\r\nstatic void mc5_dbgi_mode_disable(const struct mc5 *mc5)\r\n{\r\nt3_write_reg(mc5->adapter, A_MC5_DB_CONFIG,\r\nV_TMMODE(mc5->mode == MC5_MODE_72_BIT) |\r\nV_COMPEN(mc5->mode == MC5_MODE_72_BIT) |\r\nV_PRTYEN(mc5->parity_enabled) | F_MBUSEN);\r\n}\r\nint t3_mc5_init(struct mc5 *mc5, unsigned int nservers, unsigned int nfilters,\r\nunsigned int nroutes)\r\n{\r\nu32 cfg;\r\nint err;\r\nunsigned int tcam_size = mc5->tcam_size;\r\nstruct adapter *adap = mc5->adapter;\r\nif (!tcam_size)\r\nreturn 0;\r\nif (nroutes > MAX_ROUTES || nroutes + nservers + nfilters > tcam_size)\r\nreturn -EINVAL;\r\ncfg = t3_read_reg(adap, A_MC5_DB_CONFIG) & ~F_TMMODE;\r\ncfg |= V_TMMODE(mc5->mode == MC5_MODE_72_BIT) | F_TMRST;\r\nt3_write_reg(adap, A_MC5_DB_CONFIG, cfg);\r\nif (t3_wait_op_done(adap, A_MC5_DB_CONFIG, F_TMRDY, 1, 500, 0)) {\r\nCH_ERR(adap, "TCAM reset timed out\n");\r\nreturn -1;\r\n}\r\nt3_write_reg(adap, A_MC5_DB_ROUTING_TABLE_INDEX, tcam_size - nroutes);\r\nt3_write_reg(adap, A_MC5_DB_FILTER_TABLE,\r\ntcam_size - nroutes - nfilters);\r\nt3_write_reg(adap, A_MC5_DB_SERVER_INDEX,\r\ntcam_size - nroutes - nfilters - nservers);\r\nmc5->parity_enabled = 1;\r\nt3_write_reg(adap, A_MC5_DB_DBGI_REQ_ADDR1, 0);\r\nt3_write_reg(adap, A_MC5_DB_DBGI_REQ_ADDR2, 0);\r\nmc5_dbgi_mode_enable(mc5);\r\nswitch (mc5->part_type) {\r\ncase IDT75P52100:\r\nerr = init_idt52100(mc5);\r\nbreak;\r\ncase IDT75N43102:\r\nerr = init_idt43102(mc5);\r\nbreak;\r\ndefault:\r\nCH_ERR(adap, "Unsupported TCAM type %d\n", mc5->part_type);\r\nerr = -EINVAL;\r\nbreak;\r\n}\r\nmc5_dbgi_mode_disable(mc5);\r\nreturn err;\r\n}\r\nvoid t3_mc5_intr_handler(struct mc5 *mc5)\r\n{\r\nstruct adapter *adap = mc5->adapter;\r\nu32 cause = t3_read_reg(adap, A_MC5_DB_INT_CAUSE);\r\nif ((cause & F_PARITYERR) && mc5->parity_enabled) {\r\nCH_ALERT(adap, "MC5 parity error\n");\r\nmc5->stats.parity_err++;\r\n}\r\nif (cause & F_REQQPARERR) {\r\nCH_ALERT(adap, "MC5 request queue parity error\n");\r\nmc5->stats.reqq_parity_err++;\r\n}\r\nif (cause & F_DISPQPARERR) {\r\nCH_ALERT(adap, "MC5 dispatch queue parity error\n");\r\nmc5->stats.dispq_parity_err++;\r\n}\r\nif (cause & F_ACTRGNFULL)\r\nmc5->stats.active_rgn_full++;\r\nif (cause & F_NFASRCHFAIL)\r\nmc5->stats.nfa_srch_err++;\r\nif (cause & F_UNKNOWNCMD)\r\nmc5->stats.unknown_cmd++;\r\nif (cause & F_DELACTEMPTY)\r\nmc5->stats.del_act_empty++;\r\nif (cause & MC5_INT_FATAL)\r\nt3_fatal_err(adap);\r\nt3_write_reg(adap, A_MC5_DB_INT_CAUSE, cause);\r\n}\r\nvoid t3_mc5_prep(struct adapter *adapter, struct mc5 *mc5, int mode)\r\n{\r\n#define K * 1024\r\nstatic unsigned int tcam_part_size[] = {\r\n64 K, 128 K, 256 K, 32 K\r\n};\r\n#undef K\r\nu32 cfg = t3_read_reg(adapter, A_MC5_DB_CONFIG);\r\nmc5->adapter = adapter;\r\nmc5->mode = (unsigned char)mode;\r\nmc5->part_type = (unsigned char)G_TMTYPE(cfg);\r\nif (cfg & F_TMTYPEHI)\r\nmc5->part_type |= 4;\r\nmc5->tcam_size = tcam_part_size[G_TMPARTSIZE(cfg)];\r\nif (mode == MC5_MODE_144_BIT)\r\nmc5->tcam_size /= 2;\r\n}

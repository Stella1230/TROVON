static void ks8695_gpio_mode(unsigned int pin, short gpio)\r\n{\r\nunsigned int enable[] = { IOPC_IOEINT0EN, IOPC_IOEINT1EN, IOPC_IOEINT2EN, IOPC_IOEINT3EN, IOPC_IOTIM0EN, IOPC_IOTIM1EN };\r\nunsigned long x, flags;\r\nif (pin > KS8695_GPIO_5)\r\nreturn;\r\nlocal_irq_save(flags);\r\nx = __raw_readl(KS8695_GPIO_VA + KS8695_IOPC);\r\nif (gpio)\r\nx &= ~enable[pin];\r\nelse\r\nx |= enable[pin];\r\n__raw_writel(x, KS8695_GPIO_VA + KS8695_IOPC);\r\nlocal_irq_restore(flags);\r\n}\r\nint ks8695_gpio_interrupt(unsigned int pin, unsigned int type)\r\n{\r\nunsigned long x, flags;\r\nif (pin > KS8695_GPIO_3)\r\nreturn -EINVAL;\r\nlocal_irq_save(flags);\r\nx = __raw_readl(KS8695_GPIO_VA + KS8695_IOPM);\r\nx &= ~IOPM(pin);\r\n__raw_writel(x, KS8695_GPIO_VA + KS8695_IOPM);\r\nlocal_irq_restore(flags);\r\nirq_set_irq_type(gpio_irq[pin], type);\r\nks8695_gpio_mode(pin, 0);\r\nreturn 0;\r\n}\r\nstatic int ks8695_gpio_direction_input(struct gpio_chip *gc, unsigned int pin)\r\n{\r\nunsigned long x, flags;\r\nif (pin > KS8695_GPIO_15)\r\nreturn -EINVAL;\r\nks8695_gpio_mode(pin, 1);\r\nlocal_irq_save(flags);\r\nx = __raw_readl(KS8695_GPIO_VA + KS8695_IOPM);\r\nx &= ~IOPM(pin);\r\n__raw_writel(x, KS8695_GPIO_VA + KS8695_IOPM);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int ks8695_gpio_direction_output(struct gpio_chip *gc,\r\nunsigned int pin, int state)\r\n{\r\nunsigned long x, flags;\r\nif (pin > KS8695_GPIO_15)\r\nreturn -EINVAL;\r\nks8695_gpio_mode(pin, 1);\r\nlocal_irq_save(flags);\r\nx = __raw_readl(KS8695_GPIO_VA + KS8695_IOPD);\r\nif (state)\r\nx |= IOPD(pin);\r\nelse\r\nx &= ~IOPD(pin);\r\n__raw_writel(x, KS8695_GPIO_VA + KS8695_IOPD);\r\nx = __raw_readl(KS8695_GPIO_VA + KS8695_IOPM);\r\nx |= IOPM(pin);\r\n__raw_writel(x, KS8695_GPIO_VA + KS8695_IOPM);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic void ks8695_gpio_set_value(struct gpio_chip *gc,\r\nunsigned int pin, int state)\r\n{\r\nunsigned long x, flags;\r\nif (pin > KS8695_GPIO_15)\r\nreturn;\r\nlocal_irq_save(flags);\r\nx = __raw_readl(KS8695_GPIO_VA + KS8695_IOPD);\r\nif (state)\r\nx |= IOPD(pin);\r\nelse\r\nx &= ~IOPD(pin);\r\n__raw_writel(x, KS8695_GPIO_VA + KS8695_IOPD);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic int ks8695_gpio_get_value(struct gpio_chip *gc, unsigned int pin)\r\n{\r\nunsigned long x;\r\nif (pin > KS8695_GPIO_15)\r\nreturn -EINVAL;\r\nx = __raw_readl(KS8695_GPIO_VA + KS8695_IOPD);\r\nreturn (x & IOPD(pin)) != 0;\r\n}\r\nstatic int ks8695_gpio_to_irq(struct gpio_chip *gc, unsigned int pin)\r\n{\r\nif (pin > KS8695_GPIO_3)\r\nreturn -EINVAL;\r\nreturn gpio_irq[pin];\r\n}\r\nvoid ks8695_register_gpios(void)\r\n{\r\nif (gpiochip_add_data(&ks8695_gpio_chip, NULL))\r\nprintk(KERN_ERR "Unable to register core GPIOs\n");\r\n}\r\nstatic int ks8695_gpio_show(struct seq_file *s, void *unused)\r\n{\r\nunsigned int enable[] = { IOPC_IOEINT0EN, IOPC_IOEINT1EN, IOPC_IOEINT2EN, IOPC_IOEINT3EN, IOPC_IOTIM0EN, IOPC_IOTIM1EN };\r\nunsigned int intmask[] = { IOPC_IOEINT0TM, IOPC_IOEINT1TM, IOPC_IOEINT2TM, IOPC_IOEINT3TM };\r\nunsigned long mode, ctrl, data;\r\nint i;\r\nmode = __raw_readl(KS8695_GPIO_VA + KS8695_IOPM);\r\nctrl = __raw_readl(KS8695_GPIO_VA + KS8695_IOPC);\r\ndata = __raw_readl(KS8695_GPIO_VA + KS8695_IOPD);\r\nseq_printf(s, "Pin\tI/O\tFunction\tState\n\n");\r\nfor (i = KS8695_GPIO_0; i <= KS8695_GPIO_15 ; i++) {\r\nseq_printf(s, "%i:\t", i);\r\nseq_printf(s, "%s\t", (mode & IOPM(i)) ? "Output" : "Input");\r\nif (i <= KS8695_GPIO_3) {\r\nif (ctrl & enable[i]) {\r\nseq_printf(s, "EXT%i ", i);\r\nswitch ((ctrl & intmask[i]) >> (4 * i)) {\r\ncase IOPC_TM_LOW:\r\nseq_printf(s, "(Low)"); break;\r\ncase IOPC_TM_HIGH:\r\nseq_printf(s, "(High)"); break;\r\ncase IOPC_TM_RISING:\r\nseq_printf(s, "(Rising)"); break;\r\ncase IOPC_TM_FALLING:\r\nseq_printf(s, "(Falling)"); break;\r\ncase IOPC_TM_EDGE:\r\nseq_printf(s, "(Edges)"); break;\r\n}\r\n} else\r\nseq_printf(s, "GPIO\t");\r\n} else if (i <= KS8695_GPIO_5) {\r\nif (ctrl & enable[i])\r\nseq_printf(s, "TOUT%i\t", i - KS8695_GPIO_4);\r\nelse\r\nseq_printf(s, "GPIO\t");\r\n} else {\r\nseq_printf(s, "GPIO\t");\r\n}\r\nseq_printf(s, "\t");\r\nseq_printf(s, "%i\n", (data & IOPD(i)) ? 1 : 0);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ks8695_gpio_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ks8695_gpio_show, NULL);\r\n}\r\nstatic int __init ks8695_gpio_debugfs_init(void)\r\n{\r\n(void) debugfs_create_file("ks8695_gpio", S_IFREG | S_IRUGO, NULL, NULL, &ks8695_gpio_operations);\r\nreturn 0;\r\n}

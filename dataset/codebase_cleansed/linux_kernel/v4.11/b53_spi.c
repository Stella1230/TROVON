static inline int b53_spi_read_reg(struct spi_device *spi, u8 reg, u8 *val,\r\nunsigned int len)\r\n{\r\nu8 txbuf[2];\r\ntxbuf[0] = B53_SPI_CMD_NORMAL | B53_SPI_CMD_READ;\r\ntxbuf[1] = reg;\r\nreturn spi_write_then_read(spi, txbuf, 2, val, len);\r\n}\r\nstatic inline int b53_spi_clear_status(struct spi_device *spi)\r\n{\r\nunsigned int i;\r\nu8 rxbuf;\r\nint ret;\r\nfor (i = 0; i < 10; i++) {\r\nret = b53_spi_read_reg(spi, B53_SPI_STATUS, &rxbuf, 1);\r\nif (ret)\r\nreturn ret;\r\nif (!(rxbuf & B53_SPI_CMD_SPIF))\r\nbreak;\r\nmdelay(1);\r\n}\r\nif (i == 10)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic inline int b53_spi_set_page(struct spi_device *spi, u8 page)\r\n{\r\nu8 txbuf[3];\r\ntxbuf[0] = B53_SPI_CMD_NORMAL | B53_SPI_CMD_WRITE;\r\ntxbuf[1] = B53_SPI_PAGE_SELECT;\r\ntxbuf[2] = page;\r\nreturn spi_write(spi, txbuf, sizeof(txbuf));\r\n}\r\nstatic inline int b53_prepare_reg_access(struct spi_device *spi, u8 page)\r\n{\r\nint ret = b53_spi_clear_status(spi);\r\nif (ret)\r\nreturn ret;\r\nreturn b53_spi_set_page(spi, page);\r\n}\r\nstatic int b53_spi_prepare_reg_read(struct spi_device *spi, u8 reg)\r\n{\r\nu8 rxbuf;\r\nint retry_count;\r\nint ret;\r\nret = b53_spi_read_reg(spi, reg, &rxbuf, 1);\r\nif (ret)\r\nreturn ret;\r\nfor (retry_count = 0; retry_count < 10; retry_count++) {\r\nret = b53_spi_read_reg(spi, B53_SPI_STATUS, &rxbuf, 1);\r\nif (ret)\r\nreturn ret;\r\nif (rxbuf & B53_SPI_CMD_RACK)\r\nbreak;\r\nmdelay(1);\r\n}\r\nif (retry_count == 10)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int b53_spi_read(struct b53_device *dev, u8 page, u8 reg, u8 *data,\r\nunsigned int len)\r\n{\r\nstruct spi_device *spi = dev->priv;\r\nint ret;\r\nret = b53_prepare_reg_access(spi, page);\r\nif (ret)\r\nreturn ret;\r\nret = b53_spi_prepare_reg_read(spi, reg);\r\nif (ret)\r\nreturn ret;\r\nreturn b53_spi_read_reg(spi, B53_SPI_DATA, data, len);\r\n}\r\nstatic int b53_spi_read8(struct b53_device *dev, u8 page, u8 reg, u8 *val)\r\n{\r\nreturn b53_spi_read(dev, page, reg, val, 1);\r\n}\r\nstatic int b53_spi_read16(struct b53_device *dev, u8 page, u8 reg, u16 *val)\r\n{\r\nint ret = b53_spi_read(dev, page, reg, (u8 *)val, 2);\r\nif (!ret)\r\n*val = le16_to_cpu(*val);\r\nreturn ret;\r\n}\r\nstatic int b53_spi_read32(struct b53_device *dev, u8 page, u8 reg, u32 *val)\r\n{\r\nint ret = b53_spi_read(dev, page, reg, (u8 *)val, 4);\r\nif (!ret)\r\n*val = le32_to_cpu(*val);\r\nreturn ret;\r\n}\r\nstatic int b53_spi_read48(struct b53_device *dev, u8 page, u8 reg, u64 *val)\r\n{\r\nint ret;\r\n*val = 0;\r\nret = b53_spi_read(dev, page, reg, (u8 *)val, 6);\r\nif (!ret)\r\n*val = le64_to_cpu(*val);\r\nreturn ret;\r\n}\r\nstatic int b53_spi_read64(struct b53_device *dev, u8 page, u8 reg, u64 *val)\r\n{\r\nint ret = b53_spi_read(dev, page, reg, (u8 *)val, 8);\r\nif (!ret)\r\n*val = le64_to_cpu(*val);\r\nreturn ret;\r\n}\r\nstatic int b53_spi_write8(struct b53_device *dev, u8 page, u8 reg, u8 value)\r\n{\r\nstruct spi_device *spi = dev->priv;\r\nint ret;\r\nu8 txbuf[3];\r\nret = b53_prepare_reg_access(spi, page);\r\nif (ret)\r\nreturn ret;\r\ntxbuf[0] = B53_SPI_CMD_NORMAL | B53_SPI_CMD_WRITE;\r\ntxbuf[1] = reg;\r\ntxbuf[2] = value;\r\nreturn spi_write(spi, txbuf, sizeof(txbuf));\r\n}\r\nstatic int b53_spi_write16(struct b53_device *dev, u8 page, u8 reg, u16 value)\r\n{\r\nstruct spi_device *spi = dev->priv;\r\nint ret;\r\nu8 txbuf[4];\r\nret = b53_prepare_reg_access(spi, page);\r\nif (ret)\r\nreturn ret;\r\ntxbuf[0] = B53_SPI_CMD_NORMAL | B53_SPI_CMD_WRITE;\r\ntxbuf[1] = reg;\r\nput_unaligned_le16(value, &txbuf[2]);\r\nreturn spi_write(spi, txbuf, sizeof(txbuf));\r\n}\r\nstatic int b53_spi_write32(struct b53_device *dev, u8 page, u8 reg, u32 value)\r\n{\r\nstruct spi_device *spi = dev->priv;\r\nint ret;\r\nu8 txbuf[6];\r\nret = b53_prepare_reg_access(spi, page);\r\nif (ret)\r\nreturn ret;\r\ntxbuf[0] = B53_SPI_CMD_NORMAL | B53_SPI_CMD_WRITE;\r\ntxbuf[1] = reg;\r\nput_unaligned_le32(value, &txbuf[2]);\r\nreturn spi_write(spi, txbuf, sizeof(txbuf));\r\n}\r\nstatic int b53_spi_write48(struct b53_device *dev, u8 page, u8 reg, u64 value)\r\n{\r\nstruct spi_device *spi = dev->priv;\r\nint ret;\r\nu8 txbuf[10];\r\nret = b53_prepare_reg_access(spi, page);\r\nif (ret)\r\nreturn ret;\r\ntxbuf[0] = B53_SPI_CMD_NORMAL | B53_SPI_CMD_WRITE;\r\ntxbuf[1] = reg;\r\nput_unaligned_le64(value, &txbuf[2]);\r\nreturn spi_write(spi, txbuf, sizeof(txbuf) - 2);\r\n}\r\nstatic int b53_spi_write64(struct b53_device *dev, u8 page, u8 reg, u64 value)\r\n{\r\nstruct spi_device *spi = dev->priv;\r\nint ret;\r\nu8 txbuf[10];\r\nret = b53_prepare_reg_access(spi, page);\r\nif (ret)\r\nreturn ret;\r\ntxbuf[0] = B53_SPI_CMD_NORMAL | B53_SPI_CMD_WRITE;\r\ntxbuf[1] = reg;\r\nput_unaligned_le64(value, &txbuf[2]);\r\nreturn spi_write(spi, txbuf, sizeof(txbuf));\r\n}\r\nstatic int b53_spi_probe(struct spi_device *spi)\r\n{\r\nstruct b53_device *dev;\r\nint ret;\r\ndev = b53_switch_alloc(&spi->dev, &b53_spi_ops, spi);\r\nif (!dev)\r\nreturn -ENOMEM;\r\nif (spi->dev.platform_data)\r\ndev->pdata = spi->dev.platform_data;\r\nret = b53_switch_register(dev);\r\nif (ret)\r\nreturn ret;\r\nspi_set_drvdata(spi, dev);\r\nreturn 0;\r\n}\r\nstatic int b53_spi_remove(struct spi_device *spi)\r\n{\r\nstruct b53_device *dev = spi_get_drvdata(spi);\r\nif (dev)\r\nb53_switch_remove(dev);\r\nreturn 0;\r\n}

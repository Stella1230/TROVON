static unsigned long\r\nberlin2_pll_recalc_rate(struct clk_hw *hw, unsigned long parent_rate)\r\n{\r\nstruct berlin2_pll *pll = to_berlin2_pll(hw);\r\nstruct berlin2_pll_map *map = &pll->map;\r\nu32 val, fbdiv, rfdiv, vcodivsel, vcodiv;\r\nu64 rate = parent_rate;\r\nval = readl_relaxed(pll->base + SPLL_CTRL0);\r\nfbdiv = (val >> map->fbdiv_shift) & FBDIV_MASK;\r\nrfdiv = (val >> map->rfdiv_shift) & RFDIV_MASK;\r\nif (rfdiv == 0) {\r\npr_warn("%s has zero rfdiv\n", clk_hw_get_name(hw));\r\nrfdiv = 1;\r\n}\r\nval = readl_relaxed(pll->base + SPLL_CTRL1);\r\nvcodivsel = (val >> map->divsel_shift) & DIVSEL_MASK;\r\nvcodiv = map->vcodiv[vcodivsel];\r\nif (vcodiv == 0) {\r\npr_warn("%s has zero vcodiv (index %d)\n",\r\nclk_hw_get_name(hw), vcodivsel);\r\nvcodiv = 1;\r\n}\r\nrate *= fbdiv * map->mult;\r\ndo_div(rate, rfdiv * vcodiv);\r\nreturn (unsigned long)rate;\r\n}\r\nint __init\r\nberlin2_pll_register(const struct berlin2_pll_map *map,\r\nvoid __iomem *base, const char *name,\r\nconst char *parent_name, unsigned long flags)\r\n{\r\nstruct clk_init_data init;\r\nstruct berlin2_pll *pll;\r\npll = kzalloc(sizeof(*pll), GFP_KERNEL);\r\nif (!pll)\r\nreturn -ENOMEM;\r\nmemcpy(&pll->map, map, sizeof(*map));\r\npll->base = base;\r\npll->hw.init = &init;\r\ninit.name = name;\r\ninit.ops = &berlin2_pll_ops;\r\ninit.parent_names = &parent_name;\r\ninit.num_parents = 1;\r\ninit.flags = flags;\r\nreturn clk_hw_register(NULL, &pll->hw);\r\n}

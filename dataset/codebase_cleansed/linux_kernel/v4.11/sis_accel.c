static void\r\nSiS300Sync(struct sis_video_info *ivideo)\r\n{\r\nSiS300Idle\r\n}\r\nstatic void\r\nSiS300SetupForScreenToScreenCopy(struct sis_video_info *ivideo, int xdir, int ydir,\r\nint rop, int trans_color)\r\n{\r\nSiS300SetupDSTColorDepth(ivideo->DstColor);\r\nSiS300SetupSRCPitch(ivideo->video_linelength)\r\nSiS300SetupDSTRect(ivideo->video_linelength, 0xffff)\r\nif(trans_color != -1) {\r\nSiS300SetupROP(0x0A)\r\nSiS300SetupSRCTrans(trans_color)\r\nSiS300SetupCMDFlag(TRANSPARENT_BITBLT)\r\n} else {\r\nSiS300SetupROP(sisALUConv[rop])\r\n}\r\nif(xdir > 0) {\r\nSiS300SetupCMDFlag(X_INC)\r\n}\r\nif(ydir > 0) {\r\nSiS300SetupCMDFlag(Y_INC)\r\n}\r\n}\r\nstatic void\r\nSiS300SubsequentScreenToScreenCopy(struct sis_video_info *ivideo, int src_x,\r\nint src_y, int dst_x, int dst_y, int width, int height)\r\n{\r\nu32 srcbase = 0, dstbase = 0;\r\nif(src_y >= 2048) {\r\nsrcbase = ivideo->video_linelength * src_y;\r\nsrc_y = 0;\r\n}\r\nif(dst_y >= 2048) {\r\ndstbase = ivideo->video_linelength * dst_y;\r\ndst_y = 0;\r\n}\r\nSiS300SetupSRCBase(srcbase);\r\nSiS300SetupDSTBase(dstbase);\r\nif(!(ivideo->CommandReg & X_INC)) {\r\nsrc_x += width-1;\r\ndst_x += width-1;\r\n}\r\nif(!(ivideo->CommandReg & Y_INC)) {\r\nsrc_y += height-1;\r\ndst_y += height-1;\r\n}\r\nSiS300SetupRect(width, height)\r\nSiS300SetupSRCXY(src_x, src_y)\r\nSiS300SetupDSTXY(dst_x, dst_y)\r\nSiS300DoCMD\r\n}\r\nstatic void\r\nSiS300SetupForSolidFill(struct sis_video_info *ivideo, u32 color, int rop)\r\n{\r\nSiS300SetupPATFG(color)\r\nSiS300SetupDSTRect(ivideo->video_linelength, 0xffff)\r\nSiS300SetupDSTColorDepth(ivideo->DstColor);\r\nSiS300SetupROP(sisPatALUConv[rop])\r\nSiS300SetupCMDFlag(PATFG)\r\n}\r\nstatic void\r\nSiS300SubsequentSolidFillRect(struct sis_video_info *ivideo, int x, int y, int w, int h)\r\n{\r\nu32 dstbase = 0;\r\nif(y >= 2048) {\r\ndstbase = ivideo->video_linelength * y;\r\ny = 0;\r\n}\r\nSiS300SetupDSTBase(dstbase)\r\nSiS300SetupDSTXY(x,y)\r\nSiS300SetupRect(w,h)\r\nSiS300SetupCMDFlag(X_INC | Y_INC | BITBLT)\r\nSiS300DoCMD\r\n}\r\nstatic void\r\nSiS310Sync(struct sis_video_info *ivideo)\r\n{\r\nSiS310Idle\r\n}\r\nstatic void\r\nSiS310SetupForScreenToScreenCopy(struct sis_video_info *ivideo, int rop, int trans_color)\r\n{\r\nSiS310SetupDSTColorDepth(ivideo->DstColor);\r\nSiS310SetupSRCPitch(ivideo->video_linelength)\r\nSiS310SetupDSTRect(ivideo->video_linelength, 0x0fff)\r\nif(trans_color != -1) {\r\nSiS310SetupROP(0x0A)\r\nSiS310SetupSRCTrans(trans_color)\r\nSiS310SetupCMDFlag(TRANSPARENT_BITBLT)\r\n} else {\r\nSiS310SetupROP(sisALUConv[rop])\r\n}\r\nSiS310SetupCMDFlag(ivideo->SiS310_AccelDepth)\r\n}\r\nstatic void\r\nSiS310SubsequentScreenToScreenCopy(struct sis_video_info *ivideo, int src_x, int src_y,\r\nint dst_x, int dst_y, int width, int height)\r\n{\r\nu32 srcbase = 0, dstbase = 0;\r\nint mymin = min(src_y, dst_y);\r\nint mymax = max(src_y, dst_y);\r\nif((mymax - mymin) < height) {\r\nif((src_y >= 2048) || (dst_y >= 2048)) {\r\nsrcbase = ivideo->video_linelength * mymin;\r\ndstbase = ivideo->video_linelength * mymin;\r\nsrc_y -= mymin;\r\ndst_y -= mymin;\r\n}\r\n} else {\r\nif(src_y >= 2048) {\r\nsrcbase = ivideo->video_linelength * src_y;\r\nsrc_y = 0;\r\n}\r\nif(dst_y >= 2048) {\r\ndstbase = ivideo->video_linelength * dst_y;\r\ndst_y = 0;\r\n}\r\n}\r\nsrcbase += ivideo->video_offset;\r\ndstbase += ivideo->video_offset;\r\nSiS310SetupSRCBase(srcbase);\r\nSiS310SetupDSTBase(dstbase);\r\nSiS310SetupRect(width, height)\r\nSiS310SetupSRCXY(src_x, src_y)\r\nSiS310SetupDSTXY(dst_x, dst_y)\r\nSiS310DoCMD\r\n}\r\nstatic void\r\nSiS310SetupForSolidFill(struct sis_video_info *ivideo, u32 color, int rop)\r\n{\r\nSiS310SetupPATFG(color)\r\nSiS310SetupDSTRect(ivideo->video_linelength, 0x0fff)\r\nSiS310SetupDSTColorDepth(ivideo->DstColor);\r\nSiS310SetupROP(sisPatALUConv[rop])\r\nSiS310SetupCMDFlag(PATFG | ivideo->SiS310_AccelDepth)\r\n}\r\nstatic void\r\nSiS310SubsequentSolidFillRect(struct sis_video_info *ivideo, int x, int y, int w, int h)\r\n{\r\nu32 dstbase = 0;\r\nif(y >= 2048) {\r\ndstbase = ivideo->video_linelength * y;\r\ny = 0;\r\n}\r\ndstbase += ivideo->video_offset;\r\nSiS310SetupDSTBase(dstbase)\r\nSiS310SetupDSTXY(x,y)\r\nSiS310SetupRect(w,h)\r\nSiS310SetupCMDFlag(BITBLT)\r\nSiS310DoCMD\r\n}\r\nint sisfb_initaccel(struct sis_video_info *ivideo)\r\n{\r\n#ifdef SISFB_USE_SPINLOCKS\r\nspin_lock_init(&ivideo->lockaccel);\r\n#endif\r\nreturn 0;\r\n}\r\nvoid sisfb_syncaccel(struct sis_video_info *ivideo)\r\n{\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\n#ifdef CONFIG_FB_SIS_300\r\nSiS300Sync(ivideo);\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nSiS310Sync(ivideo);\r\n#endif\r\n}\r\n}\r\nint fbcon_sis_sync(struct fb_info *info)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)info->par;\r\nCRITFLAGS\r\nif((!ivideo->accel) || (!ivideo->engineok))\r\nreturn 0;\r\nCRITBEGIN\r\nsisfb_syncaccel(ivideo);\r\nCRITEND\r\nreturn 0;\r\n}\r\nvoid fbcon_sis_fillrect(struct fb_info *info, const struct fb_fillrect *rect)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)info->par;\r\nu32 col = 0;\r\nu32 vxres = info->var.xres_virtual;\r\nu32 vyres = info->var.yres_virtual;\r\nint width, height;\r\nCRITFLAGS\r\nif(info->state != FBINFO_STATE_RUNNING)\r\nreturn;\r\nif((!ivideo->accel) || (!ivideo->engineok)) {\r\ncfb_fillrect(info, rect);\r\nreturn;\r\n}\r\nif(!rect->width || !rect->height || rect->dx >= vxres || rect->dy >= vyres)\r\nreturn;\r\nwidth = ((rect->dx + rect->width) > vxres) ? (vxres - rect->dx) : rect->width;\r\nheight = ((rect->dy + rect->height) > vyres) ? (vyres - rect->dy) : rect->height;\r\nswitch(info->var.bits_per_pixel) {\r\ncase 8: col = rect->color;\r\nbreak;\r\ncase 16:\r\ncase 32: col = ((u32 *)(info->pseudo_palette))[rect->color];\r\nbreak;\r\n}\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\n#ifdef CONFIG_FB_SIS_300\r\nCRITBEGIN\r\nSiS300SetupForSolidFill(ivideo, col, myrops[rect->rop]);\r\nSiS300SubsequentSolidFillRect(ivideo, rect->dx, rect->dy, width, height);\r\nCRITEND\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nCRITBEGIN\r\nSiS310SetupForSolidFill(ivideo, col, myrops[rect->rop]);\r\nSiS310SubsequentSolidFillRect(ivideo, rect->dx, rect->dy, width, height);\r\nCRITEND\r\n#endif\r\n}\r\nsisfb_syncaccel(ivideo);\r\n}\r\nvoid fbcon_sis_copyarea(struct fb_info *info, const struct fb_copyarea *area)\r\n{\r\nstruct sis_video_info *ivideo = (struct sis_video_info *)info->par;\r\nu32 vxres = info->var.xres_virtual;\r\nu32 vyres = info->var.yres_virtual;\r\nint width = area->width;\r\nint height = area->height;\r\nCRITFLAGS\r\nif(info->state != FBINFO_STATE_RUNNING)\r\nreturn;\r\nif((!ivideo->accel) || (!ivideo->engineok)) {\r\ncfb_copyarea(info, area);\r\nreturn;\r\n}\r\nif(!width || !height ||\r\narea->sx >= vxres || area->sy >= vyres ||\r\narea->dx >= vxres || area->dy >= vyres)\r\nreturn;\r\nif((area->sx + width) > vxres) width = vxres - area->sx;\r\nif((area->dx + width) > vxres) width = vxres - area->dx;\r\nif((area->sy + height) > vyres) height = vyres - area->sy;\r\nif((area->dy + height) > vyres) height = vyres - area->dy;\r\nif(ivideo->sisvga_engine == SIS_300_VGA) {\r\n#ifdef CONFIG_FB_SIS_300\r\nint xdir, ydir;\r\nif(area->sx < area->dx) xdir = 0;\r\nelse xdir = 1;\r\nif(area->sy < area->dy) ydir = 0;\r\nelse ydir = 1;\r\nCRITBEGIN\r\nSiS300SetupForScreenToScreenCopy(ivideo, xdir, ydir, 3, -1);\r\nSiS300SubsequentScreenToScreenCopy(ivideo, area->sx, area->sy,\r\narea->dx, area->dy, width, height);\r\nCRITEND\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nCRITBEGIN\r\nSiS310SetupForScreenToScreenCopy(ivideo, 3, -1);\r\nSiS310SubsequentScreenToScreenCopy(ivideo, area->sx, area->sy,\r\narea->dx, area->dy, width, height);\r\nCRITEND\r\n#endif\r\n}\r\nsisfb_syncaccel(ivideo);\r\n}

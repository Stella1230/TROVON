void socfpga_init_ocram_ecc(void)\r\n{\r\nstruct device_node *np;\r\nvoid __iomem *mapped_ocr_edac_addr;\r\nnp = of_find_compatible_node(NULL, NULL, "altr,socfpga-ocram-ecc");\r\nif (!np) {\r\npr_err("Unable to find socfpga-ocram-ecc\n");\r\nreturn;\r\n}\r\nmapped_ocr_edac_addr = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!mapped_ocr_edac_addr) {\r\npr_err("Unable to map OCRAM ecc regs.\n");\r\nreturn;\r\n}\r\nwritel(ALTR_OCRAM_CLEAR_ECC, mapped_ocr_edac_addr);\r\nwritel(ALTR_OCRAM_ECC_EN, mapped_ocr_edac_addr);\r\niounmap(mapped_ocr_edac_addr);\r\n}\r\nstatic inline void ecc_set_bits(u32 bit_mask, void __iomem *ioaddr)\r\n{\r\nu32 value = readl(ioaddr);\r\nvalue |= bit_mask;\r\nwritel(value, ioaddr);\r\n}\r\nstatic inline void ecc_clear_bits(u32 bit_mask, void __iomem *ioaddr)\r\n{\r\nu32 value = readl(ioaddr);\r\nvalue &= ~bit_mask;\r\nwritel(value, ioaddr);\r\n}\r\nstatic inline int ecc_test_bits(u32 bit_mask, void __iomem *ioaddr)\r\n{\r\nu32 value = readl(ioaddr);\r\nreturn (value & bit_mask) ? 1 : 0;\r\n}\r\nstatic int altr_init_memory_port(void __iomem *ioaddr)\r\n{\r\nint limit = ALTR_A10_ECC_INIT_WATCHDOG_10US;\r\necc_set_bits(ALTR_A10_ECC_INITA, (ioaddr + ALTR_A10_ECC_CTRL_OFST));\r\nwhile (limit--) {\r\nif (ecc_test_bits(ALTR_A10_ECC_INITCOMPLETEA,\r\n(ioaddr + ALTR_A10_ECC_INITSTAT_OFST)))\r\nbreak;\r\nudelay(1);\r\n}\r\nif (limit < 0)\r\nreturn -EBUSY;\r\nwritel(ALTR_A10_ECC_ERRPENA_MASK,\r\n(ioaddr + ALTR_A10_ECC_INTSTAT_OFST));\r\nreturn 0;\r\n}\r\nvoid socfpga_init_arria10_ocram_ecc(void)\r\n{\r\nstruct device_node *np;\r\nint ret = 0;\r\nvoid __iomem *ecc_block_base;\r\nif (!sys_manager_base_addr) {\r\npr_err("SOCFPGA: sys-mgr is not initialized\n");\r\nreturn;\r\n}\r\nnp = of_find_compatible_node(NULL, NULL, "altr,socfpga-a10-ocram-ecc");\r\nif (!np) {\r\npr_err("Unable to find socfpga-a10-ocram-ecc\n");\r\nreturn;\r\n}\r\necc_block_base = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!ecc_block_base) {\r\npr_err("Unable to map OCRAM ECC block\n");\r\nreturn;\r\n}\r\nwritel(ALTR_A10_OCRAM_ECC_EN_CTL,\r\nsys_manager_base_addr + A10_SYSMGR_ECC_INTMASK_SET_OFST);\r\necc_clear_bits(ALTR_A10_ECC_SERRINTEN,\r\n(ecc_block_base + ALTR_A10_ECC_ERRINTEN_OFST));\r\necc_clear_bits(ALTR_A10_OCRAM_ECC_EN_CTL,\r\n(ecc_block_base + ALTR_A10_ECC_CTRL_OFST));\r\nwmb();\r\nret = altr_init_memory_port(ecc_block_base);\r\nif (ret) {\r\npr_err("ECC: cannot init OCRAM PORTA memory\n");\r\ngoto exit;\r\n}\r\necc_set_bits(ALTR_A10_OCRAM_ECC_EN_CTL,\r\n(ecc_block_base + ALTR_A10_ECC_CTRL_OFST));\r\necc_set_bits(ALTR_A10_ECC_SERRINTEN,\r\n(ecc_block_base + ALTR_A10_ECC_ERRINTEN_OFST));\r\nwritel(ALTR_A10_OCRAM_ECC_EN_CTL,\r\nsys_manager_base_addr + A10_SYSMGR_ECC_INTMASK_CLR_OFST);\r\nwmb();\r\nexit:\r\niounmap(ecc_block_base);\r\n}

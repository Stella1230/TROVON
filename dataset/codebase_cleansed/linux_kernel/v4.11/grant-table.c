int arch_gnttab_map_shared(unsigned long *frames, unsigned long nr_gframes,\r\nunsigned long max_nr_gframes,\r\nvoid **__shared)\r\n{\r\nvoid *shared = *__shared;\r\nunsigned long addr;\r\nunsigned long i;\r\nif (shared == NULL)\r\n*__shared = shared = gnttab_shared_vm_area.area->addr;\r\naddr = (unsigned long)shared;\r\nfor (i = 0; i < nr_gframes; i++) {\r\nset_pte_at(&init_mm, addr, gnttab_shared_vm_area.ptes[i],\r\nmfn_pte(frames[i], PAGE_KERNEL));\r\naddr += PAGE_SIZE;\r\n}\r\nreturn 0;\r\n}\r\nvoid arch_gnttab_unmap(void *shared, unsigned long nr_gframes)\r\n{\r\nunsigned long addr;\r\nunsigned long i;\r\naddr = (unsigned long)shared;\r\nfor (i = 0; i < nr_gframes; i++) {\r\nset_pte_at(&init_mm, addr, gnttab_shared_vm_area.ptes[i],\r\n__pte(0));\r\naddr += PAGE_SIZE;\r\n}\r\n}\r\nstatic int arch_gnttab_valloc(struct gnttab_vm_area *area, unsigned nr_frames)\r\n{\r\narea->ptes = kmalloc_array(nr_frames, sizeof(*area->ptes), GFP_KERNEL);\r\nif (area->ptes == NULL)\r\nreturn -ENOMEM;\r\narea->area = alloc_vm_area(PAGE_SIZE * nr_frames, area->ptes);\r\nif (area->area == NULL) {\r\nkfree(area->ptes);\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nint arch_gnttab_init(unsigned long nr_shared)\r\n{\r\nif (!xen_pv_domain())\r\nreturn 0;\r\nreturn arch_gnttab_valloc(&gnttab_shared_vm_area, nr_shared);\r\n}\r\nstatic int __init xen_pvh_gnttab_setup(void)\r\n{\r\nif (!xen_pvh_domain())\r\nreturn -ENODEV;\r\nxen_auto_xlat_grant_frames.count = gnttab_max_grant_frames();\r\nreturn xen_xlate_map_ballooned_pages(&xen_auto_xlat_grant_frames.pfn,\r\n&xen_auto_xlat_grant_frames.vaddr,\r\nxen_auto_xlat_grant_frames.count);\r\n}

static inline u_int pxa2xx_mcxx_hold(u_int pcmcia_cycle_ns,\r\nu_int mem_clk_10khz)\r\n{\r\nu_int code = pcmcia_cycle_ns * mem_clk_10khz;\r\nreturn (code / 300000) + ((code % 300000) ? 1 : 0) - 1;\r\n}\r\nstatic inline u_int pxa2xx_mcxx_asst(u_int pcmcia_cycle_ns,\r\nu_int mem_clk_10khz)\r\n{\r\nu_int code = pcmcia_cycle_ns * mem_clk_10khz;\r\nreturn (code / 300000) + ((code % 300000) ? 1 : 0) + 1;\r\n}\r\nstatic inline u_int pxa2xx_mcxx_setup(u_int pcmcia_cycle_ns,\r\nu_int mem_clk_10khz)\r\n{\r\nu_int code = pcmcia_cycle_ns * mem_clk_10khz;\r\nreturn (code / 100000) + ((code % 100000) ? 1 : 0) - 1;\r\n}\r\nstatic inline u_int pxa2xx_pcmcia_cmd_time(u_int mem_clk_10khz,\r\nu_int pcmcia_mcxx_asst)\r\n{\r\nreturn (300000 * (pcmcia_mcxx_asst + 1) / mem_clk_10khz);\r\n}\r\nstatic int pxa2xx_pcmcia_set_mcmem( int sock, int speed, int clock )\r\n{\r\nuint32_t val;\r\nval = ((pxa2xx_mcxx_setup(speed, clock)\r\n& MCXX_SETUP_MASK) << MCXX_SETUP_SHIFT)\r\n| ((pxa2xx_mcxx_asst(speed, clock)\r\n& MCXX_ASST_MASK) << MCXX_ASST_SHIFT)\r\n| ((pxa2xx_mcxx_hold(speed, clock)\r\n& MCXX_HOLD_MASK) << MCXX_HOLD_SHIFT);\r\n__raw_writel(val, MCMEM(sock));\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_pcmcia_set_mcio( int sock, int speed, int clock )\r\n{\r\nuint32_t val;\r\nval = ((pxa2xx_mcxx_setup(speed, clock)\r\n& MCXX_SETUP_MASK) << MCXX_SETUP_SHIFT)\r\n| ((pxa2xx_mcxx_asst(speed, clock)\r\n& MCXX_ASST_MASK) << MCXX_ASST_SHIFT)\r\n| ((pxa2xx_mcxx_hold(speed, clock)\r\n& MCXX_HOLD_MASK) << MCXX_HOLD_SHIFT);\r\n__raw_writel(val, MCIO(sock));\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_pcmcia_set_mcatt( int sock, int speed, int clock )\r\n{\r\nuint32_t val;\r\nval = ((pxa2xx_mcxx_setup(speed, clock)\r\n& MCXX_SETUP_MASK) << MCXX_SETUP_SHIFT)\r\n| ((pxa2xx_mcxx_asst(speed, clock)\r\n& MCXX_ASST_MASK) << MCXX_ASST_SHIFT)\r\n| ((pxa2xx_mcxx_hold(speed, clock)\r\n& MCXX_HOLD_MASK) << MCXX_HOLD_SHIFT);\r\n__raw_writel(val, MCATT(sock));\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_pcmcia_set_mcxx(struct soc_pcmcia_socket *skt, unsigned int clk)\r\n{\r\nstruct soc_pcmcia_timing timing;\r\nint sock = skt->nr;\r\nsoc_common_pcmcia_get_timing(skt, &timing);\r\npxa2xx_pcmcia_set_mcmem(sock, timing.mem, clk);\r\npxa2xx_pcmcia_set_mcatt(sock, timing.attr, clk);\r\npxa2xx_pcmcia_set_mcio(sock, timing.io, clk);\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_pcmcia_set_timing(struct soc_pcmcia_socket *skt)\r\n{\r\nunsigned long clk = clk_get_rate(skt->clk);\r\nreturn pxa2xx_pcmcia_set_mcxx(skt, clk / 10000);\r\n}\r\nstatic int\r\npxa2xx_pcmcia_frequency_change(struct soc_pcmcia_socket *skt,\r\nunsigned long val,\r\nstruct cpufreq_freqs *freqs)\r\n{\r\nswitch (val) {\r\ncase CPUFREQ_PRECHANGE:\r\nif (freqs->new > freqs->old) {\r\ndebug(skt, 2, "new frequency %u.%uMHz > %u.%uMHz, "\r\n"pre-updating\n",\r\nfreqs->new / 1000, (freqs->new / 100) % 10,\r\nfreqs->old / 1000, (freqs->old / 100) % 10);\r\npxa2xx_pcmcia_set_timing(skt);\r\n}\r\nbreak;\r\ncase CPUFREQ_POSTCHANGE:\r\nif (freqs->new < freqs->old) {\r\ndebug(skt, 2, "new frequency %u.%uMHz < %u.%uMHz, "\r\n"post-updating\n",\r\nfreqs->new / 1000, (freqs->new / 100) % 10,\r\nfreqs->old / 1000, (freqs->old / 100) % 10);\r\npxa2xx_pcmcia_set_timing(skt);\r\n}\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nvoid pxa2xx_configure_sockets(struct device *dev, struct pcmcia_low_level *ops)\r\n{\r\nuint32_t mecr = MECR_CIT;\r\nif ((ops->first + ops->nr) > 1 ||\r\nmachine_is_viper() || machine_is_arcom_zeus())\r\nmecr |= MECR_NOS;\r\n__raw_writel(mecr, MECR);\r\n}\r\nint pxa2xx_drv_pcmcia_add_one(struct soc_pcmcia_socket *skt)\r\n{\r\nskt->res_skt.start = _PCMCIA(skt->nr);\r\nskt->res_skt.end = _PCMCIA(skt->nr) + PCMCIASp - 1;\r\nskt->res_skt.name = skt_names[skt->nr];\r\nskt->res_skt.flags = IORESOURCE_MEM;\r\nskt->res_io.start = _PCMCIAIO(skt->nr);\r\nskt->res_io.end = _PCMCIAIO(skt->nr) + PCMCIAIOSp - 1;\r\nskt->res_io.name = "io";\r\nskt->res_io.flags = IORESOURCE_MEM | IORESOURCE_BUSY;\r\nskt->res_mem.start = _PCMCIAMem(skt->nr);\r\nskt->res_mem.end = _PCMCIAMem(skt->nr) + PCMCIAMemSp - 1;\r\nskt->res_mem.name = "memory";\r\nskt->res_mem.flags = IORESOURCE_MEM;\r\nskt->res_attr.start = _PCMCIAAttr(skt->nr);\r\nskt->res_attr.end = _PCMCIAAttr(skt->nr) + PCMCIAAttrSp - 1;\r\nskt->res_attr.name = "attribute";\r\nskt->res_attr.flags = IORESOURCE_MEM;\r\nreturn soc_pcmcia_add_one(skt);\r\n}\r\nvoid pxa2xx_drv_pcmcia_ops(struct pcmcia_low_level *ops)\r\n{\r\nops->set_timing = pxa2xx_pcmcia_set_timing;\r\n#ifdef CONFIG_CPU_FREQ\r\nops->frequency_change = pxa2xx_pcmcia_frequency_change;\r\n#endif\r\n}\r\nstatic int pxa2xx_drv_pcmcia_probe(struct platform_device *dev)\r\n{\r\nint i, ret = 0;\r\nstruct pcmcia_low_level *ops;\r\nstruct skt_dev_info *sinfo;\r\nstruct soc_pcmcia_socket *skt;\r\nstruct clk *clk;\r\nops = (struct pcmcia_low_level *)dev->dev.platform_data;\r\nif (!ops) {\r\nret = -ENODEV;\r\ngoto err0;\r\n}\r\nif (cpu_is_pxa320() && ops->nr > 1) {\r\ndev_err(&dev->dev, "pxa320 supports only one pcmcia slot");\r\nret = -EINVAL;\r\ngoto err0;\r\n}\r\nclk = devm_clk_get(&dev->dev, NULL);\r\nif (IS_ERR(clk))\r\nreturn -ENODEV;\r\npxa2xx_drv_pcmcia_ops(ops);\r\nsinfo = devm_kzalloc(&dev->dev, SKT_DEV_INFO_SIZE(ops->nr),\r\nGFP_KERNEL);\r\nif (!sinfo)\r\nreturn -ENOMEM;\r\nsinfo->nskt = ops->nr;\r\nfor (i = 0; i < ops->nr; i++) {\r\nskt = &sinfo->skt[i];\r\nskt->nr = ops->first + i;\r\nskt->clk = clk;\r\nsoc_pcmcia_init_one(skt, ops, &dev->dev);\r\nret = pxa2xx_drv_pcmcia_add_one(skt);\r\nif (ret)\r\ngoto err1;\r\n}\r\npxa2xx_configure_sockets(&dev->dev, ops);\r\ndev_set_drvdata(&dev->dev, sinfo);\r\nreturn 0;\r\nerr1:\r\nwhile (--i >= 0)\r\nsoc_pcmcia_remove_one(&sinfo->skt[i]);\r\nerr0:\r\nreturn ret;\r\n}\r\nstatic int pxa2xx_drv_pcmcia_remove(struct platform_device *dev)\r\n{\r\nstruct skt_dev_info *sinfo = platform_get_drvdata(dev);\r\nint i;\r\nfor (i = 0; i < sinfo->nskt; i++)\r\nsoc_pcmcia_remove_one(&sinfo->skt[i]);\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_drv_pcmcia_resume(struct device *dev)\r\n{\r\nstruct pcmcia_low_level *ops = (struct pcmcia_low_level *)dev->platform_data;\r\npxa2xx_configure_sockets(dev, ops);\r\nreturn 0;\r\n}\r\nstatic int __init pxa2xx_pcmcia_init(void)\r\n{\r\nreturn platform_driver_register(&pxa2xx_pcmcia_driver);\r\n}\r\nstatic void __exit pxa2xx_pcmcia_exit(void)\r\n{\r\nplatform_driver_unregister(&pxa2xx_pcmcia_driver);\r\n}

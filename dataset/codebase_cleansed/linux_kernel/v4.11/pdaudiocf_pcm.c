static int pdacf_pcm_clear_sram(struct snd_pdacf *chip)\r\n{\r\nint max_loop = 64 * 1024;\r\nwhile (inw(chip->port + PDAUDIOCF_REG_RDP) != inw(chip->port + PDAUDIOCF_REG_WDP)) {\r\nif (max_loop-- < 0)\r\nreturn -EIO;\r\ninw(chip->port + PDAUDIOCF_REG_MD);\r\n}\r\nreturn 0;\r\n}\r\nstatic int pdacf_pcm_trigger(struct snd_pcm_substream *subs, int cmd)\r\n{\r\nstruct snd_pdacf *chip = snd_pcm_substream_chip(subs);\r\nstruct snd_pcm_runtime *runtime = subs->runtime;\r\nint inc, ret = 0, rate;\r\nunsigned short mask, val, tmp;\r\nif (chip->chip_status & PDAUDIOCF_STAT_IS_STALE)\r\nreturn -EBUSY;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nchip->pcm_hwptr = 0;\r\nchip->pcm_tdone = 0;\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\nmask = 0;\r\nval = PDAUDIOCF_RECORD;\r\ninc = 1;\r\nrate = snd_ak4117_check_rate_and_errors(chip->ak4117, AK4117_CHECK_NO_STAT|AK4117_CHECK_NO_RATE);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\nmask = PDAUDIOCF_RECORD;\r\nval = 0;\r\ninc = -1;\r\nrate = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nmutex_lock(&chip->reg_lock);\r\nchip->pcm_running += inc;\r\ntmp = pdacf_reg_read(chip, PDAUDIOCF_REG_SCR);\r\nif (chip->pcm_running) {\r\nif ((chip->ak4117->rcs0 & AK4117_UNLCK) || runtime->rate != rate) {\r\nchip->pcm_running -= inc;\r\nret = -EIO;\r\ngoto __end;\r\n}\r\n}\r\ntmp &= ~mask;\r\ntmp |= val;\r\npdacf_reg_write(chip, PDAUDIOCF_REG_SCR, tmp);\r\n__end:\r\nmutex_unlock(&chip->reg_lock);\r\nsnd_ak4117_check_rate_and_errors(chip->ak4117, AK4117_CHECK_NO_RATE);\r\nreturn ret;\r\n}\r\nstatic int pdacf_pcm_hw_params(struct snd_pcm_substream *subs,\r\nstruct snd_pcm_hw_params *hw_params)\r\n{\r\nreturn snd_pcm_lib_alloc_vmalloc_32_buffer\r\n(subs, params_buffer_bytes(hw_params));\r\n}\r\nstatic int pdacf_pcm_hw_free(struct snd_pcm_substream *subs)\r\n{\r\nreturn snd_pcm_lib_free_vmalloc_buffer(subs);\r\n}\r\nstatic int pdacf_pcm_prepare(struct snd_pcm_substream *subs)\r\n{\r\nstruct snd_pdacf *chip = snd_pcm_substream_chip(subs);\r\nstruct snd_pcm_runtime *runtime = subs->runtime;\r\nu16 val, nval, aval;\r\nif (chip->chip_status & PDAUDIOCF_STAT_IS_STALE)\r\nreturn -EBUSY;\r\nchip->pcm_channels = runtime->channels;\r\nchip->pcm_little = snd_pcm_format_little_endian(runtime->format) > 0;\r\n#ifdef SNDRV_LITTLE_ENDIAN\r\nchip->pcm_swab = snd_pcm_format_big_endian(runtime->format) > 0;\r\n#else\r\nchip->pcm_swab = chip->pcm_little;\r\n#endif\r\nif (snd_pcm_format_unsigned(runtime->format))\r\nchip->pcm_xor = 0x80008000;\r\nif (pdacf_pcm_clear_sram(chip) < 0)\r\nreturn -EIO;\r\nval = nval = pdacf_reg_read(chip, PDAUDIOCF_REG_SCR);\r\nnval &= ~(PDAUDIOCF_DATAFMT0|PDAUDIOCF_DATAFMT1);\r\nswitch (runtime->format) {\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\ncase SNDRV_PCM_FORMAT_S16_BE:\r\nbreak;\r\ndefault:\r\nnval |= PDAUDIOCF_DATAFMT0 | PDAUDIOCF_DATAFMT1;\r\nbreak;\r\n}\r\naval = 0;\r\nchip->pcm_sample = 4;\r\nswitch (runtime->format) {\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\ncase SNDRV_PCM_FORMAT_S16_BE:\r\naval = AK4117_DIF_16R;\r\nchip->pcm_frame = 2;\r\nchip->pcm_sample = 2;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S24_3LE:\r\ncase SNDRV_PCM_FORMAT_S24_3BE:\r\nchip->pcm_sample = 3;\r\ndefault:\r\naval = AK4117_DIF_24R;\r\nchip->pcm_frame = 3;\r\nchip->pcm_xor &= 0xffff0000;\r\nbreak;\r\n}\r\nif (val != nval) {\r\nsnd_ak4117_reg_write(chip->ak4117, AK4117_REG_IO, AK4117_DIF2|AK4117_DIF1|AK4117_DIF0, aval);\r\npdacf_reg_write(chip, PDAUDIOCF_REG_SCR, nval);\r\n}\r\nval = pdacf_reg_read(chip, PDAUDIOCF_REG_IER);\r\nval &= ~(PDAUDIOCF_IRQLVLEN1);\r\nval |= PDAUDIOCF_IRQLVLEN0;\r\npdacf_reg_write(chip, PDAUDIOCF_REG_IER, val);\r\nchip->pcm_size = runtime->buffer_size;\r\nchip->pcm_period = runtime->period_size;\r\nchip->pcm_area = runtime->dma_area;\r\nreturn 0;\r\n}\r\nstatic int pdacf_pcm_capture_open(struct snd_pcm_substream *subs)\r\n{\r\nstruct snd_pcm_runtime *runtime = subs->runtime;\r\nstruct snd_pdacf *chip = snd_pcm_substream_chip(subs);\r\nif (chip->chip_status & PDAUDIOCF_STAT_IS_STALE)\r\nreturn -EBUSY;\r\nruntime->hw = pdacf_pcm_capture_hw;\r\nruntime->private_data = chip;\r\nchip->pcm_substream = subs;\r\nreturn 0;\r\n}\r\nstatic int pdacf_pcm_capture_close(struct snd_pcm_substream *subs)\r\n{\r\nstruct snd_pdacf *chip = snd_pcm_substream_chip(subs);\r\nif (!chip)\r\nreturn -EINVAL;\r\npdacf_reinit(chip, 0);\r\nchip->pcm_substream = NULL;\r\nreturn 0;\r\n}\r\nstatic snd_pcm_uframes_t pdacf_pcm_capture_pointer(struct snd_pcm_substream *subs)\r\n{\r\nstruct snd_pdacf *chip = snd_pcm_substream_chip(subs);\r\nreturn chip->pcm_hwptr;\r\n}\r\nint snd_pdacf_pcm_new(struct snd_pdacf *chip)\r\n{\r\nstruct snd_pcm *pcm;\r\nint err;\r\nerr = snd_pcm_new(chip->card, "PDAudioCF", 0, 0, 1, &pcm);\r\nif (err < 0)\r\nreturn err;\r\nsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_CAPTURE, &pdacf_pcm_capture_ops);\r\npcm->private_data = chip;\r\npcm->info_flags = 0;\r\npcm->nonatomic = true;\r\nstrcpy(pcm->name, chip->card->shortname);\r\nchip->pcm = pcm;\r\nerr = snd_ak4117_build(chip->ak4117, pcm->streams[SNDRV_PCM_STREAM_CAPTURE].substream);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}

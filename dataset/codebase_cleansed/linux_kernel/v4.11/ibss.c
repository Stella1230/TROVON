void __cfg80211_ibss_joined(struct net_device *dev, const u8 *bssid,\r\nstruct ieee80211_channel *channel)\r\n{\r\nstruct wireless_dev *wdev = dev->ieee80211_ptr;\r\nstruct cfg80211_bss *bss;\r\n#ifdef CONFIG_CFG80211_WEXT\r\nunion iwreq_data wrqu;\r\n#endif\r\nif (WARN_ON(wdev->iftype != NL80211_IFTYPE_ADHOC))\r\nreturn;\r\nif (!wdev->ssid_len)\r\nreturn;\r\nbss = cfg80211_get_bss(wdev->wiphy, channel, bssid, NULL, 0,\r\nIEEE80211_BSS_TYPE_IBSS, IEEE80211_PRIVACY_ANY);\r\nif (WARN_ON(!bss))\r\nreturn;\r\nif (wdev->current_bss) {\r\ncfg80211_unhold_bss(wdev->current_bss);\r\ncfg80211_put_bss(wdev->wiphy, &wdev->current_bss->pub);\r\n}\r\ncfg80211_hold_bss(bss_from_pub(bss));\r\nwdev->current_bss = bss_from_pub(bss);\r\nif (!(wdev->wiphy->flags & WIPHY_FLAG_HAS_STATIC_WEP))\r\ncfg80211_upload_connect_keys(wdev);\r\nnl80211_send_ibss_bssid(wiphy_to_rdev(wdev->wiphy), dev, bssid,\r\nGFP_KERNEL);\r\n#ifdef CONFIG_CFG80211_WEXT\r\nmemset(&wrqu, 0, sizeof(wrqu));\r\nmemcpy(wrqu.ap_addr.sa_data, bssid, ETH_ALEN);\r\nwireless_send_event(dev, SIOCGIWAP, &wrqu, NULL);\r\n#endif\r\n}\r\nvoid cfg80211_ibss_joined(struct net_device *dev, const u8 *bssid,\r\nstruct ieee80211_channel *channel, gfp_t gfp)\r\n{\r\nstruct wireless_dev *wdev = dev->ieee80211_ptr;\r\nstruct cfg80211_registered_device *rdev = wiphy_to_rdev(wdev->wiphy);\r\nstruct cfg80211_event *ev;\r\nunsigned long flags;\r\ntrace_cfg80211_ibss_joined(dev, bssid, channel);\r\nif (WARN_ON(!channel))\r\nreturn;\r\nev = kzalloc(sizeof(*ev), gfp);\r\nif (!ev)\r\nreturn;\r\nev->type = EVENT_IBSS_JOINED;\r\nmemcpy(ev->ij.bssid, bssid, ETH_ALEN);\r\nev->ij.channel = channel;\r\nspin_lock_irqsave(&wdev->event_lock, flags);\r\nlist_add_tail(&ev->list, &wdev->event_list);\r\nspin_unlock_irqrestore(&wdev->event_lock, flags);\r\nqueue_work(cfg80211_wq, &rdev->event_work);\r\n}\r\nstatic int __cfg80211_join_ibss(struct cfg80211_registered_device *rdev,\r\nstruct net_device *dev,\r\nstruct cfg80211_ibss_params *params,\r\nstruct cfg80211_cached_keys *connkeys)\r\n{\r\nstruct wireless_dev *wdev = dev->ieee80211_ptr;\r\nint err;\r\nASSERT_WDEV_LOCK(wdev);\r\nif (wdev->ssid_len)\r\nreturn -EALREADY;\r\nif (!params->basic_rates) {\r\nstruct ieee80211_supported_band *sband =\r\nrdev->wiphy.bands[params->chandef.chan->band];\r\nint j;\r\nu32 flag = params->chandef.chan->band == NL80211_BAND_5GHZ ?\r\nIEEE80211_RATE_MANDATORY_A :\r\nIEEE80211_RATE_MANDATORY_B;\r\nfor (j = 0; j < sband->n_bitrates; j++) {\r\nif (sband->bitrates[j].flags & flag)\r\nparams->basic_rates |= BIT(j);\r\n}\r\n}\r\nif (WARN_ON(connkeys && connkeys->def < 0))\r\nreturn -EINVAL;\r\nif (WARN_ON(wdev->connect_keys))\r\nkzfree(wdev->connect_keys);\r\nwdev->connect_keys = connkeys;\r\nwdev->ibss_fixed = params->channel_fixed;\r\nwdev->ibss_dfs_possible = params->userspace_handles_dfs;\r\nwdev->chandef = params->chandef;\r\n#ifdef CONFIG_CFG80211_WEXT\r\nwdev->wext.ibss.chandef = params->chandef;\r\n#endif\r\nerr = rdev_join_ibss(rdev, dev, params);\r\nif (err) {\r\nwdev->connect_keys = NULL;\r\nreturn err;\r\n}\r\nmemcpy(wdev->ssid, params->ssid, params->ssid_len);\r\nwdev->ssid_len = params->ssid_len;\r\nreturn 0;\r\n}\r\nint cfg80211_join_ibss(struct cfg80211_registered_device *rdev,\r\nstruct net_device *dev,\r\nstruct cfg80211_ibss_params *params,\r\nstruct cfg80211_cached_keys *connkeys)\r\n{\r\nstruct wireless_dev *wdev = dev->ieee80211_ptr;\r\nint err;\r\nASSERT_RTNL();\r\nwdev_lock(wdev);\r\nerr = __cfg80211_join_ibss(rdev, dev, params, connkeys);\r\nwdev_unlock(wdev);\r\nreturn err;\r\n}\r\nstatic void __cfg80211_clear_ibss(struct net_device *dev, bool nowext)\r\n{\r\nstruct wireless_dev *wdev = dev->ieee80211_ptr;\r\nstruct cfg80211_registered_device *rdev = wiphy_to_rdev(wdev->wiphy);\r\nint i;\r\nASSERT_WDEV_LOCK(wdev);\r\nkzfree(wdev->connect_keys);\r\nwdev->connect_keys = NULL;\r\nrdev_set_qos_map(rdev, dev, NULL);\r\nif (rdev->ops->del_key)\r\nfor (i = 0; i < 6; i++)\r\nrdev_del_key(rdev, dev, i, false, NULL);\r\nif (wdev->current_bss) {\r\ncfg80211_unhold_bss(wdev->current_bss);\r\ncfg80211_put_bss(wdev->wiphy, &wdev->current_bss->pub);\r\n}\r\nwdev->current_bss = NULL;\r\nwdev->ssid_len = 0;\r\nmemset(&wdev->chandef, 0, sizeof(wdev->chandef));\r\n#ifdef CONFIG_CFG80211_WEXT\r\nif (!nowext)\r\nwdev->wext.ibss.ssid_len = 0;\r\n#endif\r\n}\r\nvoid cfg80211_clear_ibss(struct net_device *dev, bool nowext)\r\n{\r\nstruct wireless_dev *wdev = dev->ieee80211_ptr;\r\nwdev_lock(wdev);\r\n__cfg80211_clear_ibss(dev, nowext);\r\nwdev_unlock(wdev);\r\n}\r\nint __cfg80211_leave_ibss(struct cfg80211_registered_device *rdev,\r\nstruct net_device *dev, bool nowext)\r\n{\r\nstruct wireless_dev *wdev = dev->ieee80211_ptr;\r\nint err;\r\nASSERT_WDEV_LOCK(wdev);\r\nif (!wdev->ssid_len)\r\nreturn -ENOLINK;\r\nerr = rdev_leave_ibss(rdev, dev);\r\nif (err)\r\nreturn err;\r\n__cfg80211_clear_ibss(dev, nowext);\r\nreturn 0;\r\n}\r\nint cfg80211_leave_ibss(struct cfg80211_registered_device *rdev,\r\nstruct net_device *dev, bool nowext)\r\n{\r\nstruct wireless_dev *wdev = dev->ieee80211_ptr;\r\nint err;\r\nwdev_lock(wdev);\r\nerr = __cfg80211_leave_ibss(rdev, dev, nowext);\r\nwdev_unlock(wdev);\r\nreturn err;\r\n}\r\nint cfg80211_ibss_wext_join(struct cfg80211_registered_device *rdev,\r\nstruct wireless_dev *wdev)\r\n{\r\nstruct cfg80211_cached_keys *ck = NULL;\r\nenum nl80211_band band;\r\nint i, err;\r\nASSERT_WDEV_LOCK(wdev);\r\nif (!wdev->wext.ibss.beacon_interval)\r\nwdev->wext.ibss.beacon_interval = 100;\r\nif (!wdev->wext.ibss.chandef.chan) {\r\nstruct ieee80211_channel *new_chan = NULL;\r\nfor (band = 0; band < NUM_NL80211_BANDS; band++) {\r\nstruct ieee80211_supported_band *sband;\r\nstruct ieee80211_channel *chan;\r\nsband = rdev->wiphy.bands[band];\r\nif (!sband)\r\ncontinue;\r\nfor (i = 0; i < sband->n_channels; i++) {\r\nchan = &sband->channels[i];\r\nif (chan->flags & IEEE80211_CHAN_NO_IR)\r\ncontinue;\r\nif (chan->flags & IEEE80211_CHAN_DISABLED)\r\ncontinue;\r\nnew_chan = chan;\r\nbreak;\r\n}\r\nif (new_chan)\r\nbreak;\r\n}\r\nif (!new_chan)\r\nreturn -EINVAL;\r\ncfg80211_chandef_create(&wdev->wext.ibss.chandef, new_chan,\r\nNL80211_CHAN_NO_HT);\r\n}\r\nif (!wdev->wext.ibss.ssid_len)\r\nreturn 0;\r\nif (!netif_running(wdev->netdev))\r\nreturn 0;\r\nif (wdev->wext.keys)\r\nwdev->wext.keys->def = wdev->wext.default_key;\r\nwdev->wext.ibss.privacy = wdev->wext.default_key != -1;\r\nif (wdev->wext.keys && wdev->wext.keys->def != -1) {\r\nck = kmemdup(wdev->wext.keys, sizeof(*ck), GFP_KERNEL);\r\nif (!ck)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < CFG80211_MAX_WEP_KEYS; i++)\r\nck->params[i].key = ck->data[i];\r\n}\r\nerr = __cfg80211_join_ibss(rdev, wdev->netdev,\r\n&wdev->wext.ibss, ck);\r\nif (err)\r\nkfree(ck);\r\nreturn err;\r\n}\r\nint cfg80211_ibss_wext_siwfreq(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nstruct iw_freq *wextfreq, char *extra)\r\n{\r\nstruct wireless_dev *wdev = dev->ieee80211_ptr;\r\nstruct cfg80211_registered_device *rdev = wiphy_to_rdev(wdev->wiphy);\r\nstruct ieee80211_channel *chan = NULL;\r\nint err, freq;\r\nif (WARN_ON(wdev->iftype != NL80211_IFTYPE_ADHOC))\r\nreturn -EINVAL;\r\nif (!rdev->ops->join_ibss)\r\nreturn -EOPNOTSUPP;\r\nfreq = cfg80211_wext_freq(wextfreq);\r\nif (freq < 0)\r\nreturn freq;\r\nif (freq) {\r\nchan = ieee80211_get_channel(wdev->wiphy, freq);\r\nif (!chan)\r\nreturn -EINVAL;\r\nif (chan->flags & IEEE80211_CHAN_NO_IR ||\r\nchan->flags & IEEE80211_CHAN_DISABLED)\r\nreturn -EINVAL;\r\n}\r\nif (wdev->wext.ibss.chandef.chan == chan)\r\nreturn 0;\r\nwdev_lock(wdev);\r\nerr = 0;\r\nif (wdev->ssid_len)\r\nerr = __cfg80211_leave_ibss(rdev, dev, true);\r\nwdev_unlock(wdev);\r\nif (err)\r\nreturn err;\r\nif (chan) {\r\ncfg80211_chandef_create(&wdev->wext.ibss.chandef, chan,\r\nNL80211_CHAN_NO_HT);\r\nwdev->wext.ibss.channel_fixed = true;\r\n} else {\r\nwdev->wext.ibss.channel_fixed = false;\r\n}\r\nwdev_lock(wdev);\r\nerr = cfg80211_ibss_wext_join(rdev, wdev);\r\nwdev_unlock(wdev);\r\nreturn err;\r\n}\r\nint cfg80211_ibss_wext_giwfreq(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nstruct iw_freq *freq, char *extra)\r\n{\r\nstruct wireless_dev *wdev = dev->ieee80211_ptr;\r\nstruct ieee80211_channel *chan = NULL;\r\nif (WARN_ON(wdev->iftype != NL80211_IFTYPE_ADHOC))\r\nreturn -EINVAL;\r\nwdev_lock(wdev);\r\nif (wdev->current_bss)\r\nchan = wdev->current_bss->pub.channel;\r\nelse if (wdev->wext.ibss.chandef.chan)\r\nchan = wdev->wext.ibss.chandef.chan;\r\nwdev_unlock(wdev);\r\nif (chan) {\r\nfreq->m = chan->center_freq;\r\nfreq->e = 6;\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nint cfg80211_ibss_wext_siwessid(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nstruct iw_point *data, char *ssid)\r\n{\r\nstruct wireless_dev *wdev = dev->ieee80211_ptr;\r\nstruct cfg80211_registered_device *rdev = wiphy_to_rdev(wdev->wiphy);\r\nsize_t len = data->length;\r\nint err;\r\nif (WARN_ON(wdev->iftype != NL80211_IFTYPE_ADHOC))\r\nreturn -EINVAL;\r\nif (!rdev->ops->join_ibss)\r\nreturn -EOPNOTSUPP;\r\nwdev_lock(wdev);\r\nerr = 0;\r\nif (wdev->ssid_len)\r\nerr = __cfg80211_leave_ibss(rdev, dev, true);\r\nwdev_unlock(wdev);\r\nif (err)\r\nreturn err;\r\nif (len > 0 && ssid[len - 1] == '\0')\r\nlen--;\r\nmemcpy(wdev->ssid, ssid, len);\r\nwdev->wext.ibss.ssid = wdev->ssid;\r\nwdev->wext.ibss.ssid_len = len;\r\nwdev_lock(wdev);\r\nerr = cfg80211_ibss_wext_join(rdev, wdev);\r\nwdev_unlock(wdev);\r\nreturn err;\r\n}\r\nint cfg80211_ibss_wext_giwessid(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nstruct iw_point *data, char *ssid)\r\n{\r\nstruct wireless_dev *wdev = dev->ieee80211_ptr;\r\nif (WARN_ON(wdev->iftype != NL80211_IFTYPE_ADHOC))\r\nreturn -EINVAL;\r\ndata->flags = 0;\r\nwdev_lock(wdev);\r\nif (wdev->ssid_len) {\r\ndata->flags = 1;\r\ndata->length = wdev->ssid_len;\r\nmemcpy(ssid, wdev->ssid, data->length);\r\n} else if (wdev->wext.ibss.ssid && wdev->wext.ibss.ssid_len) {\r\ndata->flags = 1;\r\ndata->length = wdev->wext.ibss.ssid_len;\r\nmemcpy(ssid, wdev->wext.ibss.ssid, data->length);\r\n}\r\nwdev_unlock(wdev);\r\nreturn 0;\r\n}\r\nint cfg80211_ibss_wext_siwap(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nstruct sockaddr *ap_addr, char *extra)\r\n{\r\nstruct wireless_dev *wdev = dev->ieee80211_ptr;\r\nstruct cfg80211_registered_device *rdev = wiphy_to_rdev(wdev->wiphy);\r\nu8 *bssid = ap_addr->sa_data;\r\nint err;\r\nif (WARN_ON(wdev->iftype != NL80211_IFTYPE_ADHOC))\r\nreturn -EINVAL;\r\nif (!rdev->ops->join_ibss)\r\nreturn -EOPNOTSUPP;\r\nif (ap_addr->sa_family != ARPHRD_ETHER)\r\nreturn -EINVAL;\r\nif (is_zero_ether_addr(bssid) || is_broadcast_ether_addr(bssid))\r\nbssid = NULL;\r\nif (bssid && !is_valid_ether_addr(bssid))\r\nreturn -EINVAL;\r\nif (!bssid && !wdev->wext.ibss.bssid)\r\nreturn 0;\r\nif (wdev->wext.ibss.bssid && bssid &&\r\nether_addr_equal(bssid, wdev->wext.ibss.bssid))\r\nreturn 0;\r\nwdev_lock(wdev);\r\nerr = 0;\r\nif (wdev->ssid_len)\r\nerr = __cfg80211_leave_ibss(rdev, dev, true);\r\nwdev_unlock(wdev);\r\nif (err)\r\nreturn err;\r\nif (bssid) {\r\nmemcpy(wdev->wext.bssid, bssid, ETH_ALEN);\r\nwdev->wext.ibss.bssid = wdev->wext.bssid;\r\n} else\r\nwdev->wext.ibss.bssid = NULL;\r\nwdev_lock(wdev);\r\nerr = cfg80211_ibss_wext_join(rdev, wdev);\r\nwdev_unlock(wdev);\r\nreturn err;\r\n}\r\nint cfg80211_ibss_wext_giwap(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nstruct sockaddr *ap_addr, char *extra)\r\n{\r\nstruct wireless_dev *wdev = dev->ieee80211_ptr;\r\nif (WARN_ON(wdev->iftype != NL80211_IFTYPE_ADHOC))\r\nreturn -EINVAL;\r\nap_addr->sa_family = ARPHRD_ETHER;\r\nwdev_lock(wdev);\r\nif (wdev->current_bss)\r\nmemcpy(ap_addr->sa_data, wdev->current_bss->pub.bssid, ETH_ALEN);\r\nelse if (wdev->wext.ibss.bssid)\r\nmemcpy(ap_addr->sa_data, wdev->wext.ibss.bssid, ETH_ALEN);\r\nelse\r\neth_zero_addr(ap_addr->sa_data);\r\nwdev_unlock(wdev);\r\nreturn 0;\r\n}

static inline void vsp1_lut_write(struct vsp1_lut *lut, struct vsp1_dl_list *dl,\r\nu32 reg, u32 data)\r\n{\r\nvsp1_dl_list_write(dl, reg, data);\r\n}\r\nstatic int lut_set_table(struct vsp1_lut *lut, struct v4l2_ctrl *ctrl)\r\n{\r\nstruct vsp1_dl_body *dlb;\r\nunsigned int i;\r\ndlb = vsp1_dl_fragment_alloc(lut->entity.vsp1, 256);\r\nif (!dlb)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < 256; ++i)\r\nvsp1_dl_fragment_write(dlb, VI6_LUT_TABLE + 4 * i,\r\nctrl->p_new.p_u32[i]);\r\nspin_lock_irq(&lut->lock);\r\nswap(lut->lut, dlb);\r\nspin_unlock_irq(&lut->lock);\r\nvsp1_dl_fragment_free(dlb);\r\nreturn 0;\r\n}\r\nstatic int lut_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct vsp1_lut *lut =\r\ncontainer_of(ctrl->handler, struct vsp1_lut, ctrls);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_VSP1_LUT_TABLE:\r\nlut_set_table(lut, ctrl);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lut_enum_mbus_code(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_mbus_code_enum *code)\r\n{\r\nstatic const unsigned int codes[] = {\r\nMEDIA_BUS_FMT_ARGB8888_1X32,\r\nMEDIA_BUS_FMT_AHSV8888_1X32,\r\nMEDIA_BUS_FMT_AYUV8_1X32,\r\n};\r\nreturn vsp1_subdev_enum_mbus_code(subdev, cfg, code, codes,\r\nARRAY_SIZE(codes));\r\n}\r\nstatic int lut_enum_frame_size(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_frame_size_enum *fse)\r\n{\r\nreturn vsp1_subdev_enum_frame_size(subdev, cfg, fse, LUT_MIN_SIZE,\r\nLUT_MIN_SIZE, LUT_MAX_SIZE,\r\nLUT_MAX_SIZE);\r\n}\r\nstatic int lut_set_format(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct vsp1_lut *lut = to_lut(subdev);\r\nstruct v4l2_subdev_pad_config *config;\r\nstruct v4l2_mbus_framefmt *format;\r\nint ret = 0;\r\nmutex_lock(&lut->entity.lock);\r\nconfig = vsp1_entity_get_pad_config(&lut->entity, cfg, fmt->which);\r\nif (!config) {\r\nret = -EINVAL;\r\ngoto done;\r\n}\r\nif (fmt->format.code != MEDIA_BUS_FMT_ARGB8888_1X32 &&\r\nfmt->format.code != MEDIA_BUS_FMT_AHSV8888_1X32 &&\r\nfmt->format.code != MEDIA_BUS_FMT_AYUV8_1X32)\r\nfmt->format.code = MEDIA_BUS_FMT_AYUV8_1X32;\r\nformat = vsp1_entity_get_pad_format(&lut->entity, config, fmt->pad);\r\nif (fmt->pad == LUT_PAD_SOURCE) {\r\nfmt->format = *format;\r\ngoto done;\r\n}\r\nformat->code = fmt->format.code;\r\nformat->width = clamp_t(unsigned int, fmt->format.width,\r\nLUT_MIN_SIZE, LUT_MAX_SIZE);\r\nformat->height = clamp_t(unsigned int, fmt->format.height,\r\nLUT_MIN_SIZE, LUT_MAX_SIZE);\r\nformat->field = V4L2_FIELD_NONE;\r\nformat->colorspace = V4L2_COLORSPACE_SRGB;\r\nfmt->format = *format;\r\nformat = vsp1_entity_get_pad_format(&lut->entity, config,\r\nLUT_PAD_SOURCE);\r\n*format = fmt->format;\r\ndone:\r\nmutex_unlock(&lut->entity.lock);\r\nreturn ret;\r\n}\r\nstatic void lut_configure(struct vsp1_entity *entity,\r\nstruct vsp1_pipeline *pipe,\r\nstruct vsp1_dl_list *dl,\r\nenum vsp1_entity_params params)\r\n{\r\nstruct vsp1_lut *lut = to_lut(&entity->subdev);\r\nstruct vsp1_dl_body *dlb;\r\nunsigned long flags;\r\nswitch (params) {\r\ncase VSP1_ENTITY_PARAMS_INIT:\r\nvsp1_lut_write(lut, dl, VI6_LUT_CTRL, VI6_LUT_CTRL_EN);\r\nbreak;\r\ncase VSP1_ENTITY_PARAMS_PARTITION:\r\nbreak;\r\ncase VSP1_ENTITY_PARAMS_RUNTIME:\r\nspin_lock_irqsave(&lut->lock, flags);\r\ndlb = lut->lut;\r\nlut->lut = NULL;\r\nspin_unlock_irqrestore(&lut->lock, flags);\r\nif (dlb)\r\nvsp1_dl_list_add_fragment(dl, dlb);\r\nbreak;\r\n}\r\n}\r\nstruct vsp1_lut *vsp1_lut_create(struct vsp1_device *vsp1)\r\n{\r\nstruct vsp1_lut *lut;\r\nint ret;\r\nlut = devm_kzalloc(vsp1->dev, sizeof(*lut), GFP_KERNEL);\r\nif (lut == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nspin_lock_init(&lut->lock);\r\nlut->entity.ops = &lut_entity_ops;\r\nlut->entity.type = VSP1_ENTITY_LUT;\r\nret = vsp1_entity_init(vsp1, &lut->entity, "lut", 2, &lut_ops,\r\nMEDIA_ENT_F_PROC_VIDEO_LUT);\r\nif (ret < 0)\r\nreturn ERR_PTR(ret);\r\nv4l2_ctrl_handler_init(&lut->ctrls, 1);\r\nv4l2_ctrl_new_custom(&lut->ctrls, &lut_table_control, NULL);\r\nlut->entity.subdev.ctrl_handler = &lut->ctrls;\r\nif (lut->ctrls.error) {\r\ndev_err(vsp1->dev, "lut: failed to initialize controls\n");\r\nret = lut->ctrls.error;\r\nvsp1_entity_destroy(&lut->entity);\r\nreturn ERR_PTR(ret);\r\n}\r\nv4l2_ctrl_handler_setup(&lut->ctrls);\r\nreturn lut;\r\n}

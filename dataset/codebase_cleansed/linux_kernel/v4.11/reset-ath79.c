static int ath79_reset_update(struct reset_controller_dev *rcdev,\r\nunsigned long id, bool assert)\r\n{\r\nstruct ath79_reset *ath79_reset =\r\ncontainer_of(rcdev, struct ath79_reset, rcdev);\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&ath79_reset->lock, flags);\r\nval = readl(ath79_reset->base);\r\nif (assert)\r\nval |= BIT(id);\r\nelse\r\nval &= ~BIT(id);\r\nwritel(val, ath79_reset->base);\r\nspin_unlock_irqrestore(&ath79_reset->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int ath79_reset_assert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nreturn ath79_reset_update(rcdev, id, true);\r\n}\r\nstatic int ath79_reset_deassert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nreturn ath79_reset_update(rcdev, id, false);\r\n}\r\nstatic int ath79_reset_status(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct ath79_reset *ath79_reset =\r\ncontainer_of(rcdev, struct ath79_reset, rcdev);\r\nu32 val;\r\nval = readl(ath79_reset->base);\r\nreturn !!(val & BIT(id));\r\n}\r\nstatic int ath79_reset_restart_handler(struct notifier_block *nb,\r\nunsigned long action, void *data)\r\n{\r\nstruct ath79_reset *ath79_reset =\r\ncontainer_of(nb, struct ath79_reset, restart_nb);\r\nath79_reset_assert(&ath79_reset->rcdev, FULL_CHIP_RESET);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int ath79_reset_probe(struct platform_device *pdev)\r\n{\r\nstruct ath79_reset *ath79_reset;\r\nstruct resource *res;\r\nint err;\r\nath79_reset = devm_kzalloc(&pdev->dev,\r\nsizeof(*ath79_reset), GFP_KERNEL);\r\nif (!ath79_reset)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, ath79_reset);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nath79_reset->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(ath79_reset->base))\r\nreturn PTR_ERR(ath79_reset->base);\r\nspin_lock_init(&ath79_reset->lock);\r\nath79_reset->rcdev.ops = &ath79_reset_ops;\r\nath79_reset->rcdev.owner = THIS_MODULE;\r\nath79_reset->rcdev.of_node = pdev->dev.of_node;\r\nath79_reset->rcdev.of_reset_n_cells = 1;\r\nath79_reset->rcdev.nr_resets = 32;\r\nerr = devm_reset_controller_register(&pdev->dev, &ath79_reset->rcdev);\r\nif (err)\r\nreturn err;\r\nath79_reset->restart_nb.notifier_call = ath79_reset_restart_handler;\r\nath79_reset->restart_nb.priority = 128;\r\nerr = register_restart_handler(&ath79_reset->restart_nb);\r\nif (err)\r\ndev_warn(&pdev->dev, "Failed to register restart handler\n");\r\nreturn 0;\r\n}\r\nstatic int ath79_reset_remove(struct platform_device *pdev)\r\n{\r\nstruct ath79_reset *ath79_reset = platform_get_drvdata(pdev);\r\nunregister_restart_handler(&ath79_reset->restart_nb);\r\nreturn 0;\r\n}

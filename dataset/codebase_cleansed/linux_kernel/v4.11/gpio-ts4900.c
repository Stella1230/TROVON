static int ts4900_gpio_get_direction(struct gpio_chip *chip,\r\nunsigned int offset)\r\n{\r\nstruct ts4900_gpio_priv *priv = gpiochip_get_data(chip);\r\nunsigned int reg;\r\nregmap_read(priv->regmap, offset, &reg);\r\nreturn !(reg & TS4900_GPIO_OE);\r\n}\r\nstatic int ts4900_gpio_direction_input(struct gpio_chip *chip,\r\nunsigned int offset)\r\n{\r\nstruct ts4900_gpio_priv *priv = gpiochip_get_data(chip);\r\nreturn regmap_write(priv->regmap, offset, 0);\r\n}\r\nstatic int ts4900_gpio_direction_output(struct gpio_chip *chip,\r\nunsigned int offset, int value)\r\n{\r\nstruct ts4900_gpio_priv *priv = gpiochip_get_data(chip);\r\nint ret;\r\nif (value)\r\nret = regmap_write(priv->regmap, offset, TS4900_GPIO_OE |\r\nTS4900_GPIO_OUT);\r\nelse\r\nret = regmap_write(priv->regmap, offset, TS4900_GPIO_OE);\r\nreturn ret;\r\n}\r\nstatic int ts4900_gpio_get(struct gpio_chip *chip, unsigned int offset)\r\n{\r\nstruct ts4900_gpio_priv *priv = gpiochip_get_data(chip);\r\nunsigned int reg;\r\nregmap_read(priv->regmap, offset, &reg);\r\nreturn !!(reg & priv->input_bit);\r\n}\r\nstatic void ts4900_gpio_set(struct gpio_chip *chip, unsigned int offset,\r\nint value)\r\n{\r\nstruct ts4900_gpio_priv *priv = gpiochip_get_data(chip);\r\nif (value)\r\nregmap_update_bits(priv->regmap, offset, TS4900_GPIO_OUT,\r\nTS4900_GPIO_OUT);\r\nelse\r\nregmap_update_bits(priv->regmap, offset, TS4900_GPIO_OUT, 0);\r\n}\r\nstatic int ts4900_gpio_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nconst struct of_device_id *match;\r\nstruct ts4900_gpio_priv *priv;\r\nu32 ngpio;\r\nint ret;\r\nmatch = of_match_device(ts4900_gpio_of_match_table, &client->dev);\r\nif (!match)\r\nreturn -EINVAL;\r\nif (of_property_read_u32(client->dev.of_node, "ngpios", &ngpio))\r\nngpio = DEFAULT_PIN_NUMBER;\r\npriv = devm_kzalloc(&client->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->gpio_chip = template_chip;\r\npriv->gpio_chip.label = "ts4900-gpio";\r\npriv->gpio_chip.ngpio = ngpio;\r\npriv->gpio_chip.parent = &client->dev;\r\npriv->input_bit = (uintptr_t)match->data;\r\npriv->regmap = devm_regmap_init_i2c(client, &ts4900_regmap_config);\r\nif (IS_ERR(priv->regmap)) {\r\nret = PTR_ERR(priv->regmap);\r\ndev_err(&client->dev, "Failed to allocate register map: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = devm_gpiochip_add_data(&client->dev, &priv->gpio_chip, priv);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "Unable to register gpiochip\n");\r\nreturn ret;\r\n}\r\ni2c_set_clientdata(client, priv);\r\nreturn 0;\r\n}

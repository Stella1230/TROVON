bool ccu_frac_helper_is_enabled(struct ccu_common *common,\r\nstruct ccu_frac_internal *cf)\r\n{\r\nif (!(common->features & CCU_FEATURE_FRACTIONAL))\r\nreturn false;\r\nreturn !(readl(common->base + common->reg) & cf->enable);\r\n}\r\nvoid ccu_frac_helper_enable(struct ccu_common *common,\r\nstruct ccu_frac_internal *cf)\r\n{\r\nunsigned long flags;\r\nu32 reg;\r\nif (!(common->features & CCU_FEATURE_FRACTIONAL))\r\nreturn;\r\nspin_lock_irqsave(common->lock, flags);\r\nreg = readl(common->base + common->reg);\r\nwritel(reg & ~cf->enable, common->base + common->reg);\r\nspin_unlock_irqrestore(common->lock, flags);\r\n}\r\nvoid ccu_frac_helper_disable(struct ccu_common *common,\r\nstruct ccu_frac_internal *cf)\r\n{\r\nunsigned long flags;\r\nu32 reg;\r\nif (!(common->features & CCU_FEATURE_FRACTIONAL))\r\nreturn;\r\nspin_lock_irqsave(common->lock, flags);\r\nreg = readl(common->base + common->reg);\r\nwritel(reg | cf->enable, common->base + common->reg);\r\nspin_unlock_irqrestore(common->lock, flags);\r\n}\r\nbool ccu_frac_helper_has_rate(struct ccu_common *common,\r\nstruct ccu_frac_internal *cf,\r\nunsigned long rate)\r\n{\r\nif (!(common->features & CCU_FEATURE_FRACTIONAL))\r\nreturn false;\r\nreturn (cf->rates[0] == rate) || (cf->rates[1] == rate);\r\n}\r\nunsigned long ccu_frac_helper_read_rate(struct ccu_common *common,\r\nstruct ccu_frac_internal *cf)\r\n{\r\nu32 reg;\r\nprintk("%s: Read fractional\n", clk_hw_get_name(&common->hw));\r\nif (!(common->features & CCU_FEATURE_FRACTIONAL))\r\nreturn 0;\r\nprintk("%s: clock is fractional (rates %lu and %lu)\n",\r\nclk_hw_get_name(&common->hw), cf->rates[0], cf->rates[1]);\r\nreg = readl(common->base + common->reg);\r\nprintk("%s: clock reg is 0x%x (select is 0x%x)\n",\r\nclk_hw_get_name(&common->hw), reg, cf->select);\r\nreturn (reg & cf->select) ? cf->rates[1] : cf->rates[0];\r\n}\r\nint ccu_frac_helper_set_rate(struct ccu_common *common,\r\nstruct ccu_frac_internal *cf,\r\nunsigned long rate)\r\n{\r\nunsigned long flags;\r\nu32 reg, sel;\r\nif (!(common->features & CCU_FEATURE_FRACTIONAL))\r\nreturn -EINVAL;\r\nif (cf->rates[0] == rate)\r\nsel = 0;\r\nelse if (cf->rates[1] == rate)\r\nsel = cf->select;\r\nelse\r\nreturn -EINVAL;\r\nspin_lock_irqsave(common->lock, flags);\r\nreg = readl(common->base + common->reg);\r\nreg &= ~cf->select;\r\nwritel(reg | sel, common->base + common->reg);\r\nspin_unlock_irqrestore(common->lock, flags);\r\nreturn 0;\r\n}

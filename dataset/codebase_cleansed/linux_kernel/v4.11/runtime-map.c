static inline struct map_attribute *to_map_attr(struct attribute *attr)\r\n{\r\nreturn container_of(attr, struct map_attribute, attr);\r\n}\r\nstatic ssize_t type_show(struct efi_runtime_map_entry *entry, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "0x%x\n", entry->md.type);\r\n}\r\nstatic inline struct efi_runtime_map_entry *to_map_entry(struct kobject *kobj)\r\n{\r\nreturn container_of(kobj, struct efi_runtime_map_entry, kobj);\r\n}\r\nstatic ssize_t map_attr_show(struct kobject *kobj, struct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct efi_runtime_map_entry *entry = to_map_entry(kobj);\r\nstruct map_attribute *map_attr = to_map_attr(attr);\r\nreturn map_attr->show(entry, buf);\r\n}\r\nstatic void map_release(struct kobject *kobj)\r\n{\r\nstruct efi_runtime_map_entry *entry;\r\nentry = to_map_entry(kobj);\r\nkfree(entry);\r\n}\r\nstatic struct efi_runtime_map_entry *\r\nadd_sysfs_runtime_map_entry(struct kobject *kobj, int nr,\r\nefi_memory_desc_t *md)\r\n{\r\nint ret;\r\nstruct efi_runtime_map_entry *entry;\r\nif (!map_kset) {\r\nmap_kset = kset_create_and_add("runtime-map", NULL, kobj);\r\nif (!map_kset)\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nentry = kzalloc(sizeof(*entry), GFP_KERNEL);\r\nif (!entry) {\r\nkset_unregister(map_kset);\r\nmap_kset = NULL;\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nmemcpy(&entry->md, md, sizeof(efi_memory_desc_t));\r\nkobject_init(&entry->kobj, &map_ktype);\r\nentry->kobj.kset = map_kset;\r\nret = kobject_add(&entry->kobj, NULL, "%d", nr);\r\nif (ret) {\r\nkobject_put(&entry->kobj);\r\nkset_unregister(map_kset);\r\nmap_kset = NULL;\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn entry;\r\n}\r\nint efi_get_runtime_map_size(void)\r\n{\r\nreturn efi.memmap.nr_map * efi.memmap.desc_size;\r\n}\r\nint efi_get_runtime_map_desc_size(void)\r\n{\r\nreturn efi.memmap.desc_size;\r\n}\r\nint efi_runtime_map_copy(void *buf, size_t bufsz)\r\n{\r\nsize_t sz = efi_get_runtime_map_size();\r\nif (sz > bufsz)\r\nsz = bufsz;\r\nmemcpy(buf, efi.memmap.map, sz);\r\nreturn 0;\r\n}\r\nint __init efi_runtime_map_init(struct kobject *efi_kobj)\r\n{\r\nint i, j, ret = 0;\r\nstruct efi_runtime_map_entry *entry;\r\nefi_memory_desc_t *md;\r\nif (!efi_enabled(EFI_MEMMAP))\r\nreturn 0;\r\nmap_entries = kzalloc(efi.memmap.nr_map * sizeof(entry), GFP_KERNEL);\r\nif (!map_entries) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\ni = 0;\r\nfor_each_efi_memory_desc(md) {\r\nentry = add_sysfs_runtime_map_entry(efi_kobj, i, md);\r\nif (IS_ERR(entry)) {\r\nret = PTR_ERR(entry);\r\ngoto out_add_entry;\r\n}\r\n*(map_entries + i++) = entry;\r\n}\r\nreturn 0;\r\nout_add_entry:\r\nfor (j = i - 1; j >= 0; j--) {\r\nentry = *(map_entries + j);\r\nkobject_put(&entry->kobj);\r\n}\r\nout:\r\nreturn ret;\r\n}

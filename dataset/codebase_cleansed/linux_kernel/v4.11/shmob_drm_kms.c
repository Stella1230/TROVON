const struct shmob_drm_format_info *shmob_drm_format_info(u32 fourcc)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(shmob_drm_format_infos); ++i) {\r\nif (shmob_drm_format_infos[i].fourcc == fourcc)\r\nreturn &shmob_drm_format_infos[i];\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct drm_framebuffer *\r\nshmob_drm_fb_create(struct drm_device *dev, struct drm_file *file_priv,\r\nconst struct drm_mode_fb_cmd2 *mode_cmd)\r\n{\r\nconst struct shmob_drm_format_info *format;\r\nformat = shmob_drm_format_info(mode_cmd->pixel_format);\r\nif (format == NULL) {\r\ndev_dbg(dev->dev, "unsupported pixel format %08x\n",\r\nmode_cmd->pixel_format);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nif (mode_cmd->pitches[0] & 7 || mode_cmd->pitches[0] >= 65536) {\r\ndev_dbg(dev->dev, "invalid pitch value %u\n",\r\nmode_cmd->pitches[0]);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nif (format->yuv) {\r\nunsigned int chroma_cpp = format->bpp == 24 ? 2 : 1;\r\nif (mode_cmd->pitches[1] != mode_cmd->pitches[0] * chroma_cpp) {\r\ndev_dbg(dev->dev,\r\n"luma and chroma pitches do not match\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\n}\r\nreturn drm_fb_cma_create(dev, file_priv, mode_cmd);\r\n}\r\nint shmob_drm_modeset_init(struct shmob_drm_device *sdev)\r\n{\r\ndrm_mode_config_init(sdev->ddev);\r\nshmob_drm_crtc_create(sdev);\r\nshmob_drm_encoder_create(sdev);\r\nshmob_drm_connector_create(sdev, &sdev->encoder.encoder);\r\ndrm_kms_helper_poll_init(sdev->ddev);\r\nsdev->ddev->mode_config.min_width = 0;\r\nsdev->ddev->mode_config.min_height = 0;\r\nsdev->ddev->mode_config.max_width = 4095;\r\nsdev->ddev->mode_config.max_height = 4095;\r\nsdev->ddev->mode_config.funcs = &shmob_drm_mode_config_funcs;\r\ndrm_helper_disable_unused_functions(sdev->ddev);\r\nreturn 0;\r\n}

void smt_timer_init(struct s_smc *smc)\r\n{\r\nsmc->t.st_queue = NULL;\r\nsmc->t.st_fast.tm_active = FALSE ;\r\nsmc->t.st_fast.tm_next = NULL;\r\nhwt_init(smc) ;\r\n}\r\nvoid smt_timer_stop(struct s_smc *smc, struct smt_timer *timer)\r\n{\r\nstruct smt_timer **prev ;\r\nstruct smt_timer *tm ;\r\ntimer->tm_active = FALSE ;\r\nif (smc->t.st_queue == timer && !timer->tm_next) {\r\nhwt_stop(smc) ;\r\n}\r\nfor (prev = &smc->t.st_queue ; (tm = *prev) ; prev = &tm->tm_next ) {\r\nif (tm == timer) {\r\n*prev = tm->tm_next ;\r\nif (tm->tm_next) {\r\ntm->tm_next->tm_delta += tm->tm_delta ;\r\n}\r\nreturn ;\r\n}\r\n}\r\n}\r\nvoid smt_timer_start(struct s_smc *smc, struct smt_timer *timer, u_long time,\r\nu_long token)\r\n{\r\nstruct smt_timer **prev ;\r\nstruct smt_timer *tm ;\r\nu_long delta = 0 ;\r\ntime /= 16 ;\r\nif (!time)\r\ntime = 1 ;\r\nsmt_timer_stop(smc,timer) ;\r\ntimer->tm_smc = smc ;\r\ntimer->tm_token = token ;\r\ntimer->tm_active = TRUE ;\r\nif (!smc->t.st_queue) {\r\nsmc->t.st_queue = timer ;\r\ntimer->tm_next = NULL;\r\ntimer->tm_delta = time ;\r\nhwt_start(smc,time) ;\r\nreturn ;\r\n}\r\ntimer_done(smc,0) ;\r\ndelta = 0 ;\r\nfor (prev = &smc->t.st_queue ; (tm = *prev) ; prev = &tm->tm_next ) {\r\nif (delta + tm->tm_delta > time) {\r\nbreak ;\r\n}\r\ndelta += tm->tm_delta ;\r\n}\r\n*prev = timer ;\r\ntimer->tm_next = tm ;\r\ntimer->tm_delta = time - delta ;\r\nif (tm)\r\ntm->tm_delta -= timer->tm_delta ;\r\nhwt_start(smc,smc->t.st_queue->tm_delta) ;\r\n}\r\nvoid smt_force_irq(struct s_smc *smc)\r\n{\r\nsmt_timer_start(smc,&smc->t.st_fast,32L, EV_TOKEN(EVENT_SMT,SM_FAST));\r\n}\r\nvoid smt_timer_done(struct s_smc *smc)\r\n{\r\ntimer_done(smc,1) ;\r\n}\r\nstatic void timer_done(struct s_smc *smc, int restart)\r\n{\r\nu_long delta ;\r\nstruct smt_timer *tm ;\r\nstruct smt_timer *next ;\r\nstruct smt_timer **last ;\r\nint done = 0 ;\r\ndelta = hwt_read(smc) ;\r\nlast = &smc->t.st_queue ;\r\ntm = smc->t.st_queue ;\r\nwhile (tm && !done) {\r\nif (delta >= tm->tm_delta) {\r\ntm->tm_active = FALSE ;\r\ndelta -= tm->tm_delta ;\r\nlast = &tm->tm_next ;\r\ntm = tm->tm_next ;\r\n}\r\nelse {\r\ntm->tm_delta -= delta ;\r\ndelta = 0 ;\r\ndone = 1 ;\r\n}\r\n}\r\n*last = NULL;\r\nnext = smc->t.st_queue ;\r\nsmc->t.st_queue = tm ;\r\nfor ( tm = next ; tm ; tm = next) {\r\nnext = tm->tm_next ;\r\ntimer_event(smc,tm->tm_token) ;\r\n}\r\nif (restart && smc->t.st_queue)\r\nhwt_start(smc,smc->t.st_queue->tm_delta) ;\r\n}

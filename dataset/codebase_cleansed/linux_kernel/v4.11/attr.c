static int __hfs_setxattr(struct inode *inode, enum hfs_xattr_type type,\r\nconst void *value, size_t size, int flags)\r\n{\r\nstruct hfs_find_data fd;\r\nhfs_cat_rec rec;\r\nstruct hfs_cat_file *file;\r\nint res;\r\nif (!S_ISREG(inode->i_mode) || HFS_IS_RSRC(inode))\r\nreturn -EOPNOTSUPP;\r\nres = hfs_find_init(HFS_SB(inode->i_sb)->cat_tree, &fd);\r\nif (res)\r\nreturn res;\r\nfd.search_key->cat = HFS_I(inode)->cat_key;\r\nres = hfs_brec_find(&fd);\r\nif (res)\r\ngoto out;\r\nhfs_bnode_read(fd.bnode, &rec, fd.entryoffset,\r\nsizeof(struct hfs_cat_file));\r\nfile = &rec.file;\r\nswitch (type) {\r\ncase HFS_TYPE:\r\nif (size == 4)\r\nmemcpy(&file->UsrWds.fdType, value, 4);\r\nelse\r\nres = -ERANGE;\r\nbreak;\r\ncase HFS_CREATOR:\r\nif (size == 4)\r\nmemcpy(&file->UsrWds.fdCreator, value, 4);\r\nelse\r\nres = -ERANGE;\r\nbreak;\r\n}\r\nif (!res)\r\nhfs_bnode_write(fd.bnode, &rec, fd.entryoffset,\r\nsizeof(struct hfs_cat_file));\r\nout:\r\nhfs_find_exit(&fd);\r\nreturn res;\r\n}\r\nstatic ssize_t __hfs_getxattr(struct inode *inode, enum hfs_xattr_type type,\r\nvoid *value, size_t size)\r\n{\r\nstruct hfs_find_data fd;\r\nhfs_cat_rec rec;\r\nstruct hfs_cat_file *file;\r\nssize_t res = 0;\r\nif (!S_ISREG(inode->i_mode) || HFS_IS_RSRC(inode))\r\nreturn -EOPNOTSUPP;\r\nif (size) {\r\nres = hfs_find_init(HFS_SB(inode->i_sb)->cat_tree, &fd);\r\nif (res)\r\nreturn res;\r\nfd.search_key->cat = HFS_I(inode)->cat_key;\r\nres = hfs_brec_find(&fd);\r\nif (res)\r\ngoto out;\r\nhfs_bnode_read(fd.bnode, &rec, fd.entryoffset,\r\nsizeof(struct hfs_cat_file));\r\n}\r\nfile = &rec.file;\r\nswitch (type) {\r\ncase HFS_TYPE:\r\nif (size >= 4) {\r\nmemcpy(value, &file->UsrWds.fdType, 4);\r\nres = 4;\r\n} else\r\nres = size ? -ERANGE : 4;\r\nbreak;\r\ncase HFS_CREATOR:\r\nif (size >= 4) {\r\nmemcpy(value, &file->UsrWds.fdCreator, 4);\r\nres = 4;\r\n} else\r\nres = size ? -ERANGE : 4;\r\nbreak;\r\n}\r\nout:\r\nif (size)\r\nhfs_find_exit(&fd);\r\nreturn res;\r\n}\r\nstatic int hfs_xattr_get(const struct xattr_handler *handler,\r\nstruct dentry *unused, struct inode *inode,\r\nconst char *name, void *value, size_t size)\r\n{\r\nreturn __hfs_getxattr(inode, handler->flags, value, size);\r\n}\r\nstatic int hfs_xattr_set(const struct xattr_handler *handler,\r\nstruct dentry *unused, struct inode *inode,\r\nconst char *name, const void *value, size_t size,\r\nint flags)\r\n{\r\nif (!value)\r\nreturn -EOPNOTSUPP;\r\nreturn __hfs_setxattr(inode, handler->flags, value, size, flags);\r\n}

int __pxa2xx_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct dma_chan *chan = snd_dmaengine_pcm_get_chan(substream);\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_dmaengine_dai_dma_data *dma_params;\r\nstruct dma_slave_config config;\r\nint ret;\r\ndma_params = snd_soc_dai_get_dma_data(rtd->cpu_dai, substream);\r\nif (!dma_params)\r\nreturn 0;\r\nret = snd_hwparams_to_dma_slave_config(substream, params, &config);\r\nif (ret)\r\nreturn ret;\r\nsnd_dmaengine_pcm_set_config_from_dai_data(substream,\r\nsnd_soc_dai_get_dma_data(rtd->cpu_dai, substream),\r\n&config);\r\nret = dmaengine_slave_config(chan, &config);\r\nif (ret)\r\nreturn ret;\r\nsnd_pcm_set_runtime_buffer(substream, &substream->dma_buffer);\r\nreturn 0;\r\n}\r\nint __pxa2xx_pcm_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nsnd_pcm_set_runtime_buffer(substream, NULL);\r\nreturn 0;\r\n}\r\nint pxa2xx_pcm_trigger(struct snd_pcm_substream *substream, int cmd)\r\n{\r\nreturn snd_dmaengine_pcm_trigger(substream, cmd);\r\n}\r\nsnd_pcm_uframes_t\r\npxa2xx_pcm_pointer(struct snd_pcm_substream *substream)\r\n{\r\nreturn snd_dmaengine_pcm_pointer(substream);\r\n}\r\nint __pxa2xx_pcm_prepare(struct snd_pcm_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nint __pxa2xx_pcm_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct snd_dmaengine_dai_dma_data *dma_params;\r\nint ret;\r\nruntime->hw = pxa2xx_pcm_hardware;\r\ndma_params = snd_soc_dai_get_dma_data(rtd->cpu_dai, substream);\r\nif (!dma_params)\r\nreturn 0;\r\nret = snd_pcm_hw_constraint_step(runtime, 0,\r\nSNDRV_PCM_HW_PARAM_PERIOD_BYTES, 32);\r\nif (ret)\r\nreturn ret;\r\nret = snd_pcm_hw_constraint_step(runtime, 0,\r\nSNDRV_PCM_HW_PARAM_BUFFER_BYTES, 32);\r\nif (ret)\r\nreturn ret;\r\nret = snd_pcm_hw_constraint_integer(runtime,\r\nSNDRV_PCM_HW_PARAM_PERIODS);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn snd_dmaengine_pcm_open_request_chan(substream,\r\npxad_filter_fn,\r\ndma_params->filter_data);\r\n}\r\nint __pxa2xx_pcm_close(struct snd_pcm_substream *substream)\r\n{\r\nreturn snd_dmaengine_pcm_close_release_chan(substream);\r\n}\r\nint pxa2xx_pcm_mmap(struct snd_pcm_substream *substream,\r\nstruct vm_area_struct *vma)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nreturn dma_mmap_wc(substream->pcm->card->dev, vma, runtime->dma_area,\r\nruntime->dma_addr, runtime->dma_bytes);\r\n}\r\nint pxa2xx_pcm_preallocate_dma_buffer(struct snd_pcm *pcm, int stream)\r\n{\r\nstruct snd_pcm_substream *substream = pcm->streams[stream].substream;\r\nstruct snd_dma_buffer *buf = &substream->dma_buffer;\r\nsize_t size = pxa2xx_pcm_hardware.buffer_bytes_max;\r\nbuf->dev.type = SNDRV_DMA_TYPE_DEV;\r\nbuf->dev.dev = pcm->card->dev;\r\nbuf->private_data = NULL;\r\nbuf->area = dma_alloc_wc(pcm->card->dev, size, &buf->addr, GFP_KERNEL);\r\nif (!buf->area)\r\nreturn -ENOMEM;\r\nbuf->bytes = size;\r\nreturn 0;\r\n}\r\nvoid pxa2xx_pcm_free_dma_buffers(struct snd_pcm *pcm)\r\n{\r\nstruct snd_pcm_substream *substream;\r\nstruct snd_dma_buffer *buf;\r\nint stream;\r\nfor (stream = 0; stream < 2; stream++) {\r\nsubstream = pcm->streams[stream].substream;\r\nif (!substream)\r\ncontinue;\r\nbuf = &substream->dma_buffer;\r\nif (!buf->area)\r\ncontinue;\r\ndma_free_wc(pcm->card->dev, buf->bytes, buf->area, buf->addr);\r\nbuf->area = NULL;\r\n}\r\n}

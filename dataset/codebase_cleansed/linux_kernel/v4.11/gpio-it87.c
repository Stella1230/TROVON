static inline int superio_enter(void)\r\n{\r\nif (!request_muxed_region(REG, 2, KBUILD_MODNAME))\r\nreturn -EBUSY;\r\noutb(0x87, REG);\r\noutb(0x01, REG);\r\noutb(0x55, REG);\r\noutb(0x55, REG);\r\nreturn 0;\r\n}\r\nstatic inline void superio_exit(void)\r\n{\r\noutb(0x02, REG);\r\noutb(0x02, VAL);\r\nrelease_region(REG, 2);\r\n}\r\nstatic inline void superio_select(int ldn)\r\n{\r\noutb(LDNREG, REG);\r\noutb(ldn, VAL);\r\n}\r\nstatic inline int superio_inb(int reg)\r\n{\r\noutb(reg, REG);\r\nreturn inb(VAL);\r\n}\r\nstatic inline void superio_outb(int val, int reg)\r\n{\r\noutb(reg, REG);\r\noutb(val, VAL);\r\n}\r\nstatic inline int superio_inw(int reg)\r\n{\r\nint val;\r\noutb(reg++, REG);\r\nval = inb(VAL) << 8;\r\noutb(reg, REG);\r\nval |= inb(VAL);\r\nreturn val;\r\n}\r\nstatic inline void superio_outw(int val, int reg)\r\n{\r\noutb(reg++, REG);\r\noutb(val >> 8, VAL);\r\noutb(reg, REG);\r\noutb(val, VAL);\r\n}\r\nstatic inline void superio_set_mask(int mask, int reg)\r\n{\r\nu8 curr_val = superio_inb(reg);\r\nu8 new_val = curr_val | mask;\r\nif (curr_val != new_val)\r\nsuperio_outb(new_val, reg);\r\n}\r\nstatic inline void superio_clear_mask(int mask, int reg)\r\n{\r\nu8 curr_val = superio_inb(reg);\r\nu8 new_val = curr_val & ~mask;\r\nif (curr_val != new_val)\r\nsuperio_outb(new_val, reg);\r\n}\r\nstatic int it87_gpio_request(struct gpio_chip *chip, unsigned gpio_num)\r\n{\r\nu8 mask, group;\r\nint rc = 0;\r\nstruct it87_gpio *it87_gpio = gpiochip_get_data(chip);\r\nmask = 1 << (gpio_num % 8);\r\ngroup = (gpio_num / 8);\r\nspin_lock(&it87_gpio->lock);\r\nrc = superio_enter();\r\nif (rc)\r\ngoto exit;\r\nif (group < it87_gpio->simple_size)\r\nsuperio_set_mask(mask, group + it87_gpio->simple_base);\r\nsuperio_clear_mask(mask, group + it87_gpio->output_base);\r\nsuperio_exit();\r\nexit:\r\nspin_unlock(&it87_gpio->lock);\r\nreturn rc;\r\n}\r\nstatic int it87_gpio_get(struct gpio_chip *chip, unsigned gpio_num)\r\n{\r\nu16 reg;\r\nu8 mask;\r\nstruct it87_gpio *it87_gpio = gpiochip_get_data(chip);\r\nmask = 1 << (gpio_num % 8);\r\nreg = (gpio_num / 8) + it87_gpio->io_base;\r\nreturn !!(inb(reg) & mask);\r\n}\r\nstatic int it87_gpio_direction_in(struct gpio_chip *chip, unsigned gpio_num)\r\n{\r\nu8 mask, group;\r\nint rc = 0;\r\nstruct it87_gpio *it87_gpio = gpiochip_get_data(chip);\r\nmask = 1 << (gpio_num % 8);\r\ngroup = (gpio_num / 8);\r\nspin_lock(&it87_gpio->lock);\r\nrc = superio_enter();\r\nif (rc)\r\ngoto exit;\r\nsuperio_clear_mask(mask, group + it87_gpio->output_base);\r\nsuperio_exit();\r\nexit:\r\nspin_unlock(&it87_gpio->lock);\r\nreturn rc;\r\n}\r\nstatic void it87_gpio_set(struct gpio_chip *chip,\r\nunsigned gpio_num, int val)\r\n{\r\nu8 mask, curr_vals;\r\nu16 reg;\r\nstruct it87_gpio *it87_gpio = gpiochip_get_data(chip);\r\nmask = 1 << (gpio_num % 8);\r\nreg = (gpio_num / 8) + it87_gpio->io_base;\r\ncurr_vals = inb(reg);\r\nif (val)\r\noutb(curr_vals | mask, reg);\r\nelse\r\noutb(curr_vals & ~mask, reg);\r\n}\r\nstatic int it87_gpio_direction_out(struct gpio_chip *chip,\r\nunsigned gpio_num, int val)\r\n{\r\nu8 mask, group;\r\nint rc = 0;\r\nstruct it87_gpio *it87_gpio = gpiochip_get_data(chip);\r\nmask = 1 << (gpio_num % 8);\r\ngroup = (gpio_num / 8);\r\nspin_lock(&it87_gpio->lock);\r\nrc = superio_enter();\r\nif (rc)\r\ngoto exit;\r\nsuperio_set_mask(mask, group + it87_gpio->output_base);\r\nit87_gpio_set(chip, gpio_num, val);\r\nsuperio_exit();\r\nexit:\r\nspin_unlock(&it87_gpio->lock);\r\nreturn rc;\r\n}\r\nstatic int __init it87_gpio_init(void)\r\n{\r\nint rc = 0, i;\r\nu16 chip_type;\r\nu8 chip_rev, gpio_ba_reg;\r\nchar *labels, **labels_table;\r\nstruct it87_gpio *it87_gpio = &it87_gpio_chip;\r\nrc = superio_enter();\r\nif (rc)\r\nreturn rc;\r\nchip_type = superio_inw(CHIPID);\r\nchip_rev = superio_inb(CHIPREV) & 0x0f;\r\nsuperio_exit();\r\nit87_gpio->chip = it87_template_chip;\r\nswitch (chip_type) {\r\ncase IT8620_ID:\r\ncase IT8628_ID:\r\ngpio_ba_reg = 0x62;\r\nit87_gpio->io_size = 11;\r\nit87_gpio->output_base = 0xc8;\r\nit87_gpio->simple_size = 0;\r\nit87_gpio->chip.ngpio = 64;\r\nbreak;\r\ncase IT8728_ID:\r\ncase IT8732_ID:\r\ngpio_ba_reg = 0x62;\r\nit87_gpio->io_size = 8;\r\nit87_gpio->output_base = 0xc8;\r\nit87_gpio->simple_base = 0xc0;\r\nit87_gpio->simple_size = 5;\r\nit87_gpio->chip.ngpio = 64;\r\nbreak;\r\ncase IT8761_ID:\r\ngpio_ba_reg = 0x60;\r\nit87_gpio->io_size = 4;\r\nit87_gpio->output_base = 0xf0;\r\nit87_gpio->simple_size = 0;\r\nit87_gpio->chip.ngpio = 16;\r\nbreak;\r\ncase NO_DEV_ID:\r\npr_err("no device\n");\r\nreturn -ENODEV;\r\ndefault:\r\npr_err("Unknown Chip found, Chip %04x Revision %x\n",\r\nchip_type, chip_rev);\r\nreturn -ENODEV;\r\n}\r\nrc = superio_enter();\r\nif (rc)\r\nreturn rc;\r\nsuperio_select(GPIO);\r\nit87_gpio->io_base = superio_inw(gpio_ba_reg);\r\nsuperio_exit();\r\npr_info("Found Chip IT%04x rev %x. %u GPIO lines starting at %04xh\n",\r\nchip_type, chip_rev, it87_gpio->chip.ngpio,\r\nit87_gpio->io_base);\r\nif (!request_region(it87_gpio->io_base, it87_gpio->io_size,\r\nKBUILD_MODNAME))\r\nreturn -EBUSY;\r\nlabels = kcalloc(it87_gpio->chip.ngpio, sizeof("it87_gpXY"),\r\nGFP_KERNEL);\r\nlabels_table = kcalloc(it87_gpio->chip.ngpio, sizeof(const char *),\r\nGFP_KERNEL);\r\nif (!labels || !labels_table) {\r\nrc = -ENOMEM;\r\ngoto labels_free;\r\n}\r\nfor (i = 0; i < it87_gpio->chip.ngpio; i++) {\r\nchar *label = &labels[i * sizeof("it87_gpXY")];\r\nsprintf(label, "it87_gp%u%u", 1+(i/8), i%8);\r\nlabels_table[i] = label;\r\n}\r\nit87_gpio->chip.names = (const char *const*)labels_table;\r\nrc = gpiochip_add_data(&it87_gpio->chip, it87_gpio);\r\nif (rc)\r\ngoto labels_free;\r\nreturn 0;\r\nlabels_free:\r\nkfree(labels_table);\r\nkfree(labels);\r\nrelease_region(it87_gpio->io_base, it87_gpio->io_size);\r\nreturn rc;\r\n}\r\nstatic void __exit it87_gpio_exit(void)\r\n{\r\nstruct it87_gpio *it87_gpio = &it87_gpio_chip;\r\ngpiochip_remove(&it87_gpio->chip);\r\nrelease_region(it87_gpio->io_base, it87_gpio->io_size);\r\nkfree(it87_gpio->chip.names[0]);\r\nkfree(it87_gpio->chip.names);\r\n}

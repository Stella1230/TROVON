static int hibmc_connector_get_modes(struct drm_connector *connector)\r\n{\r\nreturn drm_add_modes_noedid(connector, 800, 600);\r\n}\r\nstatic int hibmc_connector_mode_valid(struct drm_connector *connector,\r\nstruct drm_display_mode *mode)\r\n{\r\nreturn MODE_OK;\r\n}\r\nstatic struct drm_encoder *\r\nhibmc_connector_best_encoder(struct drm_connector *connector)\r\n{\r\nreturn drm_encoder_find(connector->dev, connector->encoder_ids[0]);\r\n}\r\nstatic struct drm_connector *\r\nhibmc_connector_init(struct hibmc_drm_private *priv)\r\n{\r\nstruct drm_device *dev = priv->dev;\r\nstruct drm_connector *connector;\r\nint ret;\r\nconnector = devm_kzalloc(dev->dev, sizeof(*connector), GFP_KERNEL);\r\nif (!connector) {\r\nDRM_ERROR("failed to alloc memory when init connector\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nret = drm_connector_init(dev, connector,\r\n&hibmc_connector_funcs,\r\nDRM_MODE_CONNECTOR_VGA);\r\nif (ret) {\r\nDRM_ERROR("failed to init connector: %d\n", ret);\r\nreturn ERR_PTR(ret);\r\n}\r\ndrm_connector_helper_add(connector,\r\n&hibmc_connector_helper_funcs);\r\nreturn connector;\r\n}\r\nstatic void hibmc_encoder_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adj_mode)\r\n{\r\nu32 reg;\r\nstruct drm_device *dev = encoder->dev;\r\nstruct hibmc_drm_private *priv = dev->dev_private;\r\nreg = readl(priv->mmio + HIBMC_DISPLAY_CONTROL_HISILE);\r\nreg |= HIBMC_DISPLAY_CONTROL_FPVDDEN(1);\r\nreg |= HIBMC_DISPLAY_CONTROL_PANELDATE(1);\r\nreg |= HIBMC_DISPLAY_CONTROL_FPEN(1);\r\nreg |= HIBMC_DISPLAY_CONTROL_VBIASEN(1);\r\nwritel(reg, priv->mmio + HIBMC_DISPLAY_CONTROL_HISILE);\r\n}\r\nint hibmc_vdac_init(struct hibmc_drm_private *priv)\r\n{\r\nstruct drm_device *dev = priv->dev;\r\nstruct drm_encoder *encoder;\r\nstruct drm_connector *connector;\r\nint ret;\r\nconnector = hibmc_connector_init(priv);\r\nif (IS_ERR(connector)) {\r\nDRM_ERROR("failed to create connector: %ld\n",\r\nPTR_ERR(connector));\r\nreturn PTR_ERR(connector);\r\n}\r\nencoder = devm_kzalloc(dev->dev, sizeof(*encoder), GFP_KERNEL);\r\nif (!encoder) {\r\nDRM_ERROR("failed to alloc memory when init encoder\n");\r\nreturn -ENOMEM;\r\n}\r\nencoder->possible_crtcs = 0x1;\r\nret = drm_encoder_init(dev, encoder, &hibmc_encoder_funcs,\r\nDRM_MODE_ENCODER_DAC, NULL);\r\nif (ret) {\r\nDRM_ERROR("failed to init encoder: %d\n", ret);\r\nreturn ret;\r\n}\r\ndrm_encoder_helper_add(encoder, &hibmc_encoder_helper_funcs);\r\ndrm_mode_connector_attach_encoder(connector, encoder);\r\nreturn 0;\r\n}

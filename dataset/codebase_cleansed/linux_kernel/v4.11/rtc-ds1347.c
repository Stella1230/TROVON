static int ds1347_read_time(struct device *dev, struct rtc_time *dt)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct regmap *map;\r\nint err;\r\nunsigned char buf[8];\r\nmap = spi_get_drvdata(spi);\r\nerr = regmap_bulk_read(map, DS1347_CLOCK_BURST, buf, 8);\r\nif (err)\r\nreturn err;\r\ndt->tm_sec = bcd2bin(buf[0]);\r\ndt->tm_min = bcd2bin(buf[1]);\r\ndt->tm_hour = bcd2bin(buf[2] & 0x3F);\r\ndt->tm_mday = bcd2bin(buf[3]);\r\ndt->tm_mon = bcd2bin(buf[4]) - 1;\r\ndt->tm_wday = bcd2bin(buf[5]) - 1;\r\ndt->tm_year = bcd2bin(buf[6]) + 100;\r\nreturn rtc_valid_tm(dt);\r\n}\r\nstatic int ds1347_set_time(struct device *dev, struct rtc_time *dt)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct regmap *map;\r\nunsigned char buf[8];\r\nmap = spi_get_drvdata(spi);\r\nbuf[0] = bin2bcd(dt->tm_sec);\r\nbuf[1] = bin2bcd(dt->tm_min);\r\nbuf[2] = (bin2bcd(dt->tm_hour) & 0x3F);\r\nbuf[3] = bin2bcd(dt->tm_mday);\r\nbuf[4] = bin2bcd(dt->tm_mon + 1);\r\nbuf[5] = bin2bcd(dt->tm_wday + 1);\r\ndt->tm_year = dt->tm_year % 100;\r\nbuf[6] = bin2bcd(dt->tm_year);\r\nbuf[7] = bin2bcd(0x00);\r\nreturn regmap_bulk_write(map, DS1347_CLOCK_BURST, buf, 8);\r\n}\r\nstatic int ds1347_probe(struct spi_device *spi)\r\n{\r\nstruct rtc_device *rtc;\r\nstruct regmap_config config;\r\nstruct regmap *map;\r\nunsigned int data;\r\nint res;\r\nmemset(&config, 0, sizeof(config));\r\nconfig.reg_bits = 8;\r\nconfig.val_bits = 8;\r\nconfig.read_flag_mask = 0x80;\r\nconfig.max_register = 0x3F;\r\nconfig.wr_table = &ds1347_access_table;\r\nspi->mode = SPI_MODE_3;\r\nspi->bits_per_word = 8;\r\nspi_setup(spi);\r\nmap = devm_regmap_init_spi(spi, &config);\r\nif (IS_ERR(map)) {\r\ndev_err(&spi->dev, "ds1347 regmap init spi failed\n");\r\nreturn PTR_ERR(map);\r\n}\r\nspi_set_drvdata(spi, map);\r\nres = regmap_read(map, DS1347_SECONDS_REG, &data);\r\nif (res)\r\nreturn res;\r\nregmap_read(map, DS1347_CONTROL_REG, &data);\r\ndata = data & ~(1<<7);\r\nregmap_write(map, DS1347_CONTROL_REG, data);\r\nregmap_read(map, DS1347_STATUS_REG, &data);\r\ndata = data & 0x1B;\r\nregmap_write(map, DS1347_STATUS_REG, data);\r\nregmap_read(map, DS1347_CONTROL_REG, &data);\r\ndev_info(&spi->dev, "DS1347 RTC CTRL Reg = 0x%02x\n", data);\r\nregmap_read(map, DS1347_STATUS_REG, &data);\r\ndev_info(&spi->dev, "DS1347 RTC Status Reg = 0x%02x\n", data);\r\nrtc = devm_rtc_device_register(&spi->dev, "ds1347",\r\n&ds1347_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\nreturn 0;\r\n}

static int loongson2_cpu_freq_notifier(struct notifier_block *nb,\r\nunsigned long val, void *data)\r\n{\r\nif (val == CPUFREQ_POSTCHANGE)\r\ncurrent_cpu_data.udelay_val = loops_per_jiffy;\r\nreturn 0;\r\n}\r\nstatic int loongson2_cpufreq_target(struct cpufreq_policy *policy,\r\nunsigned int index)\r\n{\r\nunsigned int cpu = policy->cpu;\r\ncpumask_t cpus_allowed;\r\nunsigned int freq;\r\ncpus_allowed = current->cpus_allowed;\r\nset_cpus_allowed_ptr(current, cpumask_of(cpu));\r\nfreq =\r\n((cpu_clock_freq / 1000) *\r\nloongson2_clockmod_table[index].driver_data) / 8;\r\nset_cpus_allowed_ptr(current, &cpus_allowed);\r\nclk_set_rate(policy->clk, freq * 1000);\r\nreturn 0;\r\n}\r\nstatic int loongson2_cpufreq_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nstruct clk *cpuclk;\r\nint i;\r\nunsigned long rate;\r\nint ret;\r\ncpuclk = clk_get(NULL, "cpu_clk");\r\nif (IS_ERR(cpuclk)) {\r\npr_err("couldn't get CPU clk\n");\r\nreturn PTR_ERR(cpuclk);\r\n}\r\nrate = cpu_clock_freq / 1000;\r\nif (!rate) {\r\nclk_put(cpuclk);\r\nreturn -EINVAL;\r\n}\r\nfor (i = 2;\r\n(loongson2_clockmod_table[i].frequency != CPUFREQ_TABLE_END);\r\ni++)\r\nloongson2_clockmod_table[i].frequency = (rate * i) / 8;\r\nret = clk_set_rate(cpuclk, rate * 1000);\r\nif (ret) {\r\nclk_put(cpuclk);\r\nreturn ret;\r\n}\r\npolicy->clk = cpuclk;\r\nreturn cpufreq_generic_init(policy, &loongson2_clockmod_table[0], 0);\r\n}\r\nstatic int loongson2_cpufreq_exit(struct cpufreq_policy *policy)\r\n{\r\nclk_put(policy->clk);\r\nreturn 0;\r\n}\r\nstatic void loongson2_cpu_wait(void)\r\n{\r\nunsigned long flags;\r\nu32 cpu_freq;\r\nspin_lock_irqsave(&loongson2_wait_lock, flags);\r\ncpu_freq = LOONGSON_CHIPCFG(0);\r\nLOONGSON_CHIPCFG(0) &= ~0x7;\r\nLOONGSON_CHIPCFG(0) = cpu_freq;\r\nspin_unlock_irqrestore(&loongson2_wait_lock, flags);\r\nlocal_irq_enable();\r\n}\r\nstatic int __init cpufreq_init(void)\r\n{\r\nint ret;\r\nret = platform_driver_register(&platform_driver);\r\nif (ret)\r\nreturn ret;\r\npr_info("Loongson-2F CPU frequency driver\n");\r\ncpufreq_register_notifier(&loongson2_cpufreq_notifier_block,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\nret = cpufreq_register_driver(&loongson2_cpufreq_driver);\r\nif (!ret && !nowait) {\r\nsaved_cpu_wait = cpu_wait;\r\ncpu_wait = loongson2_cpu_wait;\r\n}\r\nreturn ret;\r\n}\r\nstatic void __exit cpufreq_exit(void)\r\n{\r\nif (!nowait && saved_cpu_wait)\r\ncpu_wait = saved_cpu_wait;\r\ncpufreq_unregister_driver(&loongson2_cpufreq_driver);\r\ncpufreq_unregister_notifier(&loongson2_cpufreq_notifier_block,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\nplatform_driver_unregister(&platform_driver);\r\n}

static int i2c_demux_master_xfer(struct i2c_adapter *adap, struct i2c_msg msgs[], int num)\r\n{\r\nstruct i2c_demux_pinctrl_priv *priv = adap->algo_data;\r\nstruct i2c_adapter *parent = priv->chan[priv->cur_chan].parent_adap;\r\nreturn __i2c_transfer(parent, msgs, num);\r\n}\r\nstatic u32 i2c_demux_functionality(struct i2c_adapter *adap)\r\n{\r\nstruct i2c_demux_pinctrl_priv *priv = adap->algo_data;\r\nstruct i2c_adapter *parent = priv->chan[priv->cur_chan].parent_adap;\r\nreturn parent->algo->functionality(parent);\r\n}\r\nstatic int i2c_demux_activate_master(struct i2c_demux_pinctrl_priv *priv, u32 new_chan)\r\n{\r\nstruct i2c_adapter *adap;\r\nstruct pinctrl *p;\r\nint ret;\r\nret = of_changeset_apply(&priv->chan[new_chan].chgset);\r\nif (ret)\r\ngoto err;\r\nadap = of_find_i2c_adapter_by_node(priv->chan[new_chan].parent_np);\r\nif (!adap) {\r\nret = -ENODEV;\r\ngoto err_with_revert;\r\n}\r\np = devm_pinctrl_get(adap->dev.parent);\r\nif (IS_ERR(p)) {\r\nret = PTR_ERR(p);\r\nif (ret != -ENODEV)\r\ngoto err_with_put;\r\n} else {\r\nstruct pinctrl_state *s = pinctrl_lookup_state(p, priv->bus_name);\r\nif (IS_ERR(s)) {\r\nret = PTR_ERR(s);\r\ngoto err_with_put;\r\n}\r\nret = pinctrl_select_state(p, s);\r\nif (ret < 0)\r\ngoto err_with_put;\r\n}\r\npriv->chan[new_chan].parent_adap = adap;\r\npriv->cur_chan = new_chan;\r\npriv->algo.master_xfer = i2c_demux_master_xfer;\r\npriv->algo.functionality = i2c_demux_functionality;\r\nsnprintf(priv->cur_adap.name, sizeof(priv->cur_adap.name),\r\n"i2c-demux (master i2c-%d)", i2c_adapter_id(adap));\r\npriv->cur_adap.owner = THIS_MODULE;\r\npriv->cur_adap.algo = &priv->algo;\r\npriv->cur_adap.algo_data = priv;\r\npriv->cur_adap.dev.parent = priv->dev;\r\npriv->cur_adap.class = adap->class;\r\npriv->cur_adap.retries = adap->retries;\r\npriv->cur_adap.timeout = adap->timeout;\r\npriv->cur_adap.quirks = adap->quirks;\r\npriv->cur_adap.dev.of_node = priv->dev->of_node;\r\nret = i2c_add_adapter(&priv->cur_adap);\r\nif (ret < 0)\r\ngoto err_with_put;\r\nreturn 0;\r\nerr_with_put:\r\ni2c_put_adapter(adap);\r\nerr_with_revert:\r\nof_changeset_revert(&priv->chan[new_chan].chgset);\r\nerr:\r\ndev_err(priv->dev, "failed to setup demux-adapter %d (%d)\n", new_chan, ret);\r\npriv->cur_chan = -EINVAL;\r\nreturn ret;\r\n}\r\nstatic int i2c_demux_deactivate_master(struct i2c_demux_pinctrl_priv *priv)\r\n{\r\nint ret, cur = priv->cur_chan;\r\nif (cur < 0)\r\nreturn 0;\r\ni2c_del_adapter(&priv->cur_adap);\r\ni2c_put_adapter(priv->chan[cur].parent_adap);\r\nret = of_changeset_revert(&priv->chan[cur].chgset);\r\npriv->chan[cur].parent_adap = NULL;\r\npriv->cur_chan = -EINVAL;\r\nreturn ret;\r\n}\r\nstatic int i2c_demux_change_master(struct i2c_demux_pinctrl_priv *priv, u32 new_chan)\r\n{\r\nint ret;\r\nif (new_chan == priv->cur_chan)\r\nreturn 0;\r\nret = i2c_demux_deactivate_master(priv);\r\nif (ret)\r\nreturn ret;\r\nreturn i2c_demux_activate_master(priv, new_chan);\r\n}\r\nstatic ssize_t available_masters_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct i2c_demux_pinctrl_priv *priv = dev_get_drvdata(dev);\r\nint count = 0, i;\r\nfor (i = 0; i < priv->num_chan && count < PAGE_SIZE; i++)\r\ncount += scnprintf(buf + count, PAGE_SIZE - count, "%d:%s%c",\r\ni, priv->chan[i].parent_np->full_name,\r\ni == priv->num_chan - 1 ? '\n' : ' ');\r\nreturn count;\r\n}\r\nstatic ssize_t current_master_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct i2c_demux_pinctrl_priv *priv = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n", priv->cur_chan);\r\n}\r\nstatic ssize_t current_master_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_demux_pinctrl_priv *priv = dev_get_drvdata(dev);\r\nunsigned int val;\r\nint ret;\r\nret = kstrtouint(buf, 0, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nif (val >= priv->num_chan)\r\nreturn -EINVAL;\r\nret = i2c_demux_change_master(priv, val);\r\nreturn ret < 0 ? ret : count;\r\n}\r\nstatic int i2c_demux_pinctrl_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct i2c_demux_pinctrl_priv *priv;\r\nstruct property *props;\r\nint num_chan, i, j, err;\r\nnum_chan = of_count_phandle_with_args(np, "i2c-parent", NULL);\r\nif (num_chan < 2) {\r\ndev_err(&pdev->dev, "Need at least two I2C masters to switch\n");\r\nreturn -EINVAL;\r\n}\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv)\r\n+ num_chan * sizeof(struct i2c_demux_pinctrl_chan), GFP_KERNEL);\r\nprops = devm_kcalloc(&pdev->dev, num_chan, sizeof(*props), GFP_KERNEL);\r\nif (!priv || !props)\r\nreturn -ENOMEM;\r\nerr = of_property_read_string(np, "i2c-bus-name", &priv->bus_name);\r\nif (err)\r\nreturn err;\r\nfor (i = 0; i < num_chan; i++) {\r\nstruct device_node *adap_np;\r\nadap_np = of_parse_phandle(np, "i2c-parent", i);\r\nif (!adap_np) {\r\ndev_err(&pdev->dev, "can't get phandle for parent %d\n", i);\r\nerr = -ENOENT;\r\ngoto err_rollback;\r\n}\r\npriv->chan[i].parent_np = adap_np;\r\nprops[i].name = devm_kstrdup(&pdev->dev, "status", GFP_KERNEL);\r\nprops[i].value = devm_kstrdup(&pdev->dev, "ok", GFP_KERNEL);\r\nprops[i].length = 3;\r\nof_changeset_init(&priv->chan[i].chgset);\r\nof_changeset_update_property(&priv->chan[i].chgset, adap_np, &props[i]);\r\n}\r\npriv->num_chan = num_chan;\r\npriv->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, priv);\r\ni2c_demux_activate_master(priv, 0);\r\nerr = device_create_file(&pdev->dev, &dev_attr_available_masters);\r\nif (err)\r\ngoto err_rollback;\r\nerr = device_create_file(&pdev->dev, &dev_attr_current_master);\r\nif (err)\r\ngoto err_rollback_available;\r\nreturn 0;\r\nerr_rollback_available:\r\ndevice_remove_file(&pdev->dev, &dev_attr_available_masters);\r\nerr_rollback:\r\nfor (j = 0; j < i; j++) {\r\nof_node_put(priv->chan[j].parent_np);\r\nof_changeset_destroy(&priv->chan[j].chgset);\r\n}\r\nreturn err;\r\n}\r\nstatic int i2c_demux_pinctrl_remove(struct platform_device *pdev)\r\n{\r\nstruct i2c_demux_pinctrl_priv *priv = platform_get_drvdata(pdev);\r\nint i;\r\ndevice_remove_file(&pdev->dev, &dev_attr_current_master);\r\ndevice_remove_file(&pdev->dev, &dev_attr_available_masters);\r\ni2c_demux_deactivate_master(priv);\r\nfor (i = 0; i < priv->num_chan; i++) {\r\nof_node_put(priv->chan[i].parent_np);\r\nof_changeset_destroy(&priv->chan[i].chgset);\r\n}\r\nreturn 0;\r\n}

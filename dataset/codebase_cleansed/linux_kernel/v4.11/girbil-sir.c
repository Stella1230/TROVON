static int __init girbil_sir_init(void)\r\n{\r\nreturn irda_register_dongle(&girbil);\r\n}\r\nstatic void __exit girbil_sir_cleanup(void)\r\n{\r\nirda_unregister_dongle(&girbil);\r\n}\r\nstatic int girbil_open(struct sir_dev *dev)\r\n{\r\nstruct qos_info *qos = &dev->qos;\r\nsirdev_set_dtr_rts(dev, TRUE, TRUE);\r\nqos->baud_rate.bits &= IR_9600|IR_19200|IR_38400|IR_57600|IR_115200;\r\nqos->min_turn_time.bits = 0x03;\r\nirda_qos_bits_to_value(qos);\r\nreturn 0;\r\n}\r\nstatic int girbil_close(struct sir_dev *dev)\r\n{\r\nsirdev_set_dtr_rts(dev, FALSE, FALSE);\r\nreturn 0;\r\n}\r\nstatic int girbil_change_speed(struct sir_dev *dev, unsigned speed)\r\n{\r\nunsigned state = dev->fsm.substate;\r\nunsigned delay = 0;\r\nu8 control[2];\r\nstatic int ret = 0;\r\nswitch(state) {\r\ncase SIRDEV_STATE_DONGLE_SPEED:\r\nsirdev_set_dtr_rts(dev, FALSE, TRUE);\r\nudelay(25);\r\nret = 0;\r\nswitch (speed) {\r\ndefault:\r\nret = -EINVAL;\r\ncase 9600:\r\ncontrol[0] = GIRBIL_9600;\r\nbreak;\r\ncase 19200:\r\ncontrol[0] = GIRBIL_19200;\r\nbreak;\r\ncase 34800:\r\ncontrol[0] = GIRBIL_38400;\r\nbreak;\r\ncase 57600:\r\ncontrol[0] = GIRBIL_57600;\r\nbreak;\r\ncase 115200:\r\ncontrol[0] = GIRBIL_115200;\r\nbreak;\r\n}\r\ncontrol[1] = GIRBIL_LOAD;\r\nsirdev_raw_write(dev, control, 2);\r\ndev->speed = speed;\r\nstate = GIRBIL_STATE_WAIT_SPEED;\r\ndelay = 100;\r\nbreak;\r\ncase GIRBIL_STATE_WAIT_SPEED:\r\nsirdev_set_dtr_rts(dev, TRUE, TRUE);\r\nudelay(25);\r\nbreak;\r\ndefault:\r\nnet_err_ratelimited("%s - undefined state %d\n",\r\n__func__, state);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\ndev->fsm.substate = state;\r\nreturn (delay > 0) ? delay : ret;\r\n}\r\nstatic int girbil_reset(struct sir_dev *dev)\r\n{\r\nunsigned state = dev->fsm.substate;\r\nunsigned delay = 0;\r\nu8 control = GIRBIL_TXEN | GIRBIL_RXEN;\r\nint ret = 0;\r\nswitch (state) {\r\ncase SIRDEV_STATE_DONGLE_RESET:\r\nsirdev_set_dtr_rts(dev, TRUE, FALSE);\r\ndelay = 20;\r\nstate = GIRBIL_STATE_WAIT1_RESET;\r\nbreak;\r\ncase GIRBIL_STATE_WAIT1_RESET:\r\nsirdev_set_dtr_rts(dev, FALSE, TRUE);\r\ndelay = 20;\r\nstate = GIRBIL_STATE_WAIT2_RESET;\r\nbreak;\r\ncase GIRBIL_STATE_WAIT2_RESET:\r\nsirdev_raw_write(dev, &control, 1);\r\ndelay = 20;\r\nstate = GIRBIL_STATE_WAIT3_RESET;\r\nbreak;\r\ncase GIRBIL_STATE_WAIT3_RESET:\r\nsirdev_set_dtr_rts(dev, TRUE, TRUE);\r\ndev->speed = 9600;\r\nbreak;\r\ndefault:\r\nnet_err_ratelimited("%s(), undefined state %d\n",\r\n__func__, state);\r\nret = -1;\r\nbreak;\r\n}\r\ndev->fsm.substate = state;\r\nreturn (delay > 0) ? delay : ret;\r\n}

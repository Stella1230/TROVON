static void xprt_switch_add_xprt_locked(struct rpc_xprt_switch *xps,\r\nstruct rpc_xprt *xprt)\r\n{\r\nif (unlikely(xprt_get(xprt) == NULL))\r\nreturn;\r\nlist_add_tail_rcu(&xprt->xprt_switch, &xps->xps_xprt_list);\r\nsmp_wmb();\r\nif (xps->xps_nxprts == 0)\r\nxps->xps_net = xprt->xprt_net;\r\nxps->xps_nxprts++;\r\n}\r\nvoid rpc_xprt_switch_add_xprt(struct rpc_xprt_switch *xps,\r\nstruct rpc_xprt *xprt)\r\n{\r\nif (xprt == NULL)\r\nreturn;\r\nspin_lock(&xps->xps_lock);\r\nif ((xps->xps_net == xprt->xprt_net || xps->xps_net == NULL) &&\r\n!rpc_xprt_switch_has_addr(xps, (struct sockaddr *)&xprt->addr))\r\nxprt_switch_add_xprt_locked(xps, xprt);\r\nspin_unlock(&xps->xps_lock);\r\n}\r\nstatic void xprt_switch_remove_xprt_locked(struct rpc_xprt_switch *xps,\r\nstruct rpc_xprt *xprt)\r\n{\r\nif (unlikely(xprt == NULL))\r\nreturn;\r\nxps->xps_nxprts--;\r\nif (xps->xps_nxprts == 0)\r\nxps->xps_net = NULL;\r\nsmp_wmb();\r\nlist_del_rcu(&xprt->xprt_switch);\r\n}\r\nvoid rpc_xprt_switch_remove_xprt(struct rpc_xprt_switch *xps,\r\nstruct rpc_xprt *xprt)\r\n{\r\nspin_lock(&xps->xps_lock);\r\nxprt_switch_remove_xprt_locked(xps, xprt);\r\nspin_unlock(&xps->xps_lock);\r\nxprt_put(xprt);\r\n}\r\nstruct rpc_xprt_switch *xprt_switch_alloc(struct rpc_xprt *xprt,\r\ngfp_t gfp_flags)\r\n{\r\nstruct rpc_xprt_switch *xps;\r\nxps = kmalloc(sizeof(*xps), gfp_flags);\r\nif (xps != NULL) {\r\nspin_lock_init(&xps->xps_lock);\r\nkref_init(&xps->xps_kref);\r\nxps->xps_nxprts = 0;\r\nINIT_LIST_HEAD(&xps->xps_xprt_list);\r\nxps->xps_iter_ops = &rpc_xprt_iter_singular;\r\nxprt_switch_add_xprt_locked(xps, xprt);\r\n}\r\nreturn xps;\r\n}\r\nstatic void xprt_switch_free_entries(struct rpc_xprt_switch *xps)\r\n{\r\nspin_lock(&xps->xps_lock);\r\nwhile (!list_empty(&xps->xps_xprt_list)) {\r\nstruct rpc_xprt *xprt;\r\nxprt = list_first_entry(&xps->xps_xprt_list,\r\nstruct rpc_xprt, xprt_switch);\r\nxprt_switch_remove_xprt_locked(xps, xprt);\r\nspin_unlock(&xps->xps_lock);\r\nxprt_put(xprt);\r\nspin_lock(&xps->xps_lock);\r\n}\r\nspin_unlock(&xps->xps_lock);\r\n}\r\nstatic void xprt_switch_free(struct kref *kref)\r\n{\r\nstruct rpc_xprt_switch *xps = container_of(kref,\r\nstruct rpc_xprt_switch, xps_kref);\r\nxprt_switch_free_entries(xps);\r\nkfree_rcu(xps, xps_rcu);\r\n}\r\nstruct rpc_xprt_switch *xprt_switch_get(struct rpc_xprt_switch *xps)\r\n{\r\nif (xps != NULL && kref_get_unless_zero(&xps->xps_kref))\r\nreturn xps;\r\nreturn NULL;\r\n}\r\nvoid xprt_switch_put(struct rpc_xprt_switch *xps)\r\n{\r\nif (xps != NULL)\r\nkref_put(&xps->xps_kref, xprt_switch_free);\r\n}\r\nvoid rpc_xprt_switch_set_roundrobin(struct rpc_xprt_switch *xps)\r\n{\r\nif (READ_ONCE(xps->xps_iter_ops) != &rpc_xprt_iter_roundrobin)\r\nWRITE_ONCE(xps->xps_iter_ops, &rpc_xprt_iter_roundrobin);\r\n}\r\nstatic\r\nconst struct rpc_xprt_iter_ops *xprt_iter_ops(const struct rpc_xprt_iter *xpi)\r\n{\r\nif (xpi->xpi_ops != NULL)\r\nreturn xpi->xpi_ops;\r\nreturn rcu_dereference(xpi->xpi_xpswitch)->xps_iter_ops;\r\n}\r\nstatic\r\nvoid xprt_iter_no_rewind(struct rpc_xprt_iter *xpi)\r\n{\r\n}\r\nstatic\r\nvoid xprt_iter_default_rewind(struct rpc_xprt_iter *xpi)\r\n{\r\nWRITE_ONCE(xpi->xpi_cursor, NULL);\r\n}\r\nstatic\r\nstruct rpc_xprt *xprt_switch_find_first_entry(struct list_head *head)\r\n{\r\nreturn list_first_or_null_rcu(head, struct rpc_xprt, xprt_switch);\r\n}\r\nstatic\r\nstruct rpc_xprt *xprt_iter_first_entry(struct rpc_xprt_iter *xpi)\r\n{\r\nstruct rpc_xprt_switch *xps = rcu_dereference(xpi->xpi_xpswitch);\r\nif (xps == NULL)\r\nreturn NULL;\r\nreturn xprt_switch_find_first_entry(&xps->xps_xprt_list);\r\n}\r\nstatic\r\nstruct rpc_xprt *xprt_switch_find_current_entry(struct list_head *head,\r\nconst struct rpc_xprt *cur)\r\n{\r\nstruct rpc_xprt *pos;\r\nlist_for_each_entry_rcu(pos, head, xprt_switch) {\r\nif (cur == pos)\r\nreturn pos;\r\n}\r\nreturn NULL;\r\n}\r\nstatic\r\nstruct rpc_xprt *xprt_iter_current_entry(struct rpc_xprt_iter *xpi)\r\n{\r\nstruct rpc_xprt_switch *xps = rcu_dereference(xpi->xpi_xpswitch);\r\nstruct list_head *head;\r\nif (xps == NULL)\r\nreturn NULL;\r\nhead = &xps->xps_xprt_list;\r\nif (xpi->xpi_cursor == NULL || xps->xps_nxprts < 2)\r\nreturn xprt_switch_find_first_entry(head);\r\nreturn xprt_switch_find_current_entry(head, xpi->xpi_cursor);\r\n}\r\nbool rpc_xprt_switch_has_addr(struct rpc_xprt_switch *xps,\r\nconst struct sockaddr *sap)\r\n{\r\nstruct list_head *head;\r\nstruct rpc_xprt *pos;\r\nif (xps == NULL || sap == NULL)\r\nreturn false;\r\nhead = &xps->xps_xprt_list;\r\nlist_for_each_entry_rcu(pos, head, xprt_switch) {\r\nif (rpc_cmp_addr_port(sap, (struct sockaddr *)&pos->addr)) {\r\npr_info("RPC: addr %s already in xprt switch\n",\r\npos->address_strings[RPC_DISPLAY_ADDR]);\r\nreturn true;\r\n}\r\n}\r\nreturn false;\r\n}\r\nstatic\r\nstruct rpc_xprt *xprt_switch_find_next_entry(struct list_head *head,\r\nconst struct rpc_xprt *cur)\r\n{\r\nstruct rpc_xprt *pos, *prev = NULL;\r\nlist_for_each_entry_rcu(pos, head, xprt_switch) {\r\nif (cur == prev)\r\nreturn pos;\r\nprev = pos;\r\n}\r\nreturn NULL;\r\n}\r\nstatic\r\nstruct rpc_xprt *xprt_switch_set_next_cursor(struct list_head *head,\r\nstruct rpc_xprt **cursor,\r\nxprt_switch_find_xprt_t find_next)\r\n{\r\nstruct rpc_xprt *cur, *pos, *old;\r\ncur = READ_ONCE(*cursor);\r\nfor (;;) {\r\nold = cur;\r\npos = find_next(head, old);\r\nif (pos == NULL)\r\nbreak;\r\ncur = cmpxchg_relaxed(cursor, old, pos);\r\nif (cur == old)\r\nbreak;\r\n}\r\nreturn pos;\r\n}\r\nstatic\r\nstruct rpc_xprt *xprt_iter_next_entry_multiple(struct rpc_xprt_iter *xpi,\r\nxprt_switch_find_xprt_t find_next)\r\n{\r\nstruct rpc_xprt_switch *xps = rcu_dereference(xpi->xpi_xpswitch);\r\nif (xps == NULL)\r\nreturn NULL;\r\nreturn xprt_switch_set_next_cursor(&xps->xps_xprt_list,\r\n&xpi->xpi_cursor,\r\nfind_next);\r\n}\r\nstatic\r\nstruct rpc_xprt *xprt_switch_find_next_entry_roundrobin(struct list_head *head,\r\nconst struct rpc_xprt *cur)\r\n{\r\nstruct rpc_xprt *ret;\r\nret = xprt_switch_find_next_entry(head, cur);\r\nif (ret != NULL)\r\nreturn ret;\r\nreturn xprt_switch_find_first_entry(head);\r\n}\r\nstatic\r\nstruct rpc_xprt *xprt_iter_next_entry_roundrobin(struct rpc_xprt_iter *xpi)\r\n{\r\nreturn xprt_iter_next_entry_multiple(xpi,\r\nxprt_switch_find_next_entry_roundrobin);\r\n}\r\nstatic\r\nstruct rpc_xprt *xprt_iter_next_entry_all(struct rpc_xprt_iter *xpi)\r\n{\r\nreturn xprt_iter_next_entry_multiple(xpi, xprt_switch_find_next_entry);\r\n}\r\nstatic\r\nvoid xprt_iter_rewind(struct rpc_xprt_iter *xpi)\r\n{\r\nrcu_read_lock();\r\nxprt_iter_ops(xpi)->xpi_rewind(xpi);\r\nrcu_read_unlock();\r\n}\r\nstatic void __xprt_iter_init(struct rpc_xprt_iter *xpi,\r\nstruct rpc_xprt_switch *xps,\r\nconst struct rpc_xprt_iter_ops *ops)\r\n{\r\nrcu_assign_pointer(xpi->xpi_xpswitch, xprt_switch_get(xps));\r\nxpi->xpi_cursor = NULL;\r\nxpi->xpi_ops = ops;\r\n}\r\nvoid xprt_iter_init(struct rpc_xprt_iter *xpi,\r\nstruct rpc_xprt_switch *xps)\r\n{\r\n__xprt_iter_init(xpi, xps, NULL);\r\n}\r\nvoid xprt_iter_init_listall(struct rpc_xprt_iter *xpi,\r\nstruct rpc_xprt_switch *xps)\r\n{\r\n__xprt_iter_init(xpi, xps, &rpc_xprt_iter_listall);\r\n}\r\nstruct rpc_xprt_switch *xprt_iter_xchg_switch(struct rpc_xprt_iter *xpi,\r\nstruct rpc_xprt_switch *newswitch)\r\n{\r\nstruct rpc_xprt_switch __rcu *oldswitch;\r\noldswitch = xchg(&xpi->xpi_xpswitch, RCU_INITIALIZER(newswitch));\r\nif (newswitch != NULL)\r\nxprt_iter_rewind(xpi);\r\nreturn rcu_dereference_protected(oldswitch, true);\r\n}\r\nvoid xprt_iter_destroy(struct rpc_xprt_iter *xpi)\r\n{\r\nxprt_switch_put(xprt_iter_xchg_switch(xpi, NULL));\r\n}\r\nstruct rpc_xprt *xprt_iter_xprt(struct rpc_xprt_iter *xpi)\r\n{\r\nWARN_ON_ONCE(!rcu_read_lock_held());\r\nreturn xprt_iter_ops(xpi)->xpi_xprt(xpi);\r\n}\r\nstruct rpc_xprt *xprt_iter_get_xprt(struct rpc_xprt_iter *xpi)\r\n{\r\nstruct rpc_xprt *xprt;\r\nrcu_read_lock();\r\nxprt = xprt_iter_get_helper(xpi, xprt_iter_ops(xpi)->xpi_xprt);\r\nrcu_read_unlock();\r\nreturn xprt;\r\n}\r\nstruct rpc_xprt *xprt_iter_get_next(struct rpc_xprt_iter *xpi)\r\n{\r\nstruct rpc_xprt *xprt;\r\nrcu_read_lock();\r\nxprt = xprt_iter_get_helper(xpi, xprt_iter_ops(xpi)->xpi_next);\r\nrcu_read_unlock();\r\nreturn xprt;\r\n}

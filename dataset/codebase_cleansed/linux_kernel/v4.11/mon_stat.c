static int mon_stat_open(struct inode *inode, struct file *file)\r\n{\r\nstruct mon_bus *mbus;\r\nstruct snap *sp;\r\nsp = kmalloc(sizeof(struct snap), GFP_KERNEL);\r\nif (sp == NULL)\r\nreturn -ENOMEM;\r\nmbus = inode->i_private;\r\nsp->slen = snprintf(sp->str, STAT_BUF_SIZE,\r\n"nreaders %d events %u text_lost %u\n",\r\nmbus->nreaders, mbus->cnt_events, mbus->cnt_text_lost);\r\nfile->private_data = sp;\r\nreturn 0;\r\n}\r\nstatic ssize_t mon_stat_read(struct file *file, char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nstruct snap *sp = file->private_data;\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, sp->str, sp->slen);\r\n}\r\nstatic int mon_stat_release(struct inode *inode, struct file *file)\r\n{\r\nstruct snap *sp = file->private_data;\r\nfile->private_data = NULL;\r\nkfree(sp);\r\nreturn 0;\r\n}

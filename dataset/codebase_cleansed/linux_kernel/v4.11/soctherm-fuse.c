static s64 div64_s64_precise(s64 a, s32 b)\r\n{\r\ns64 r, al;\r\nal = a << 16;\r\nr = div64_s64(al * 2 + 1, 2 * b);\r\nreturn r >> 16;\r\n}\r\nint tegra_calc_shared_calib(const struct tegra_soctherm_fuse *tfuse,\r\nstruct tsensor_shared_calib *shared)\r\n{\r\nu32 val;\r\ns32 shifted_cp, shifted_ft;\r\nint err;\r\nerr = tegra_fuse_readl(FUSE_TSENSOR_COMMON, &val);\r\nif (err)\r\nreturn err;\r\nshared->base_cp = (val & tfuse->fuse_base_cp_mask) >>\r\ntfuse->fuse_base_cp_shift;\r\nshared->base_ft = (val & tfuse->fuse_base_ft_mask) >>\r\ntfuse->fuse_base_ft_shift;\r\nshifted_ft = (val & tfuse->fuse_shift_ft_mask) >>\r\ntfuse->fuse_shift_ft_shift;\r\nshifted_ft = sign_extend32(shifted_ft, 4);\r\nif (tfuse->fuse_spare_realignment) {\r\nerr = tegra_fuse_readl(tfuse->fuse_spare_realignment, &val);\r\nif (err)\r\nreturn err;\r\n}\r\nshifted_cp = sign_extend32(val, 5);\r\nshared->actual_temp_cp = 2 * NOMINAL_CALIB_CP + shifted_cp;\r\nshared->actual_temp_ft = 2 * NOMINAL_CALIB_FT + shifted_ft;\r\nreturn 0;\r\n}\r\nint tegra_calc_tsensor_calib(const struct tegra_tsensor *sensor,\r\nconst struct tsensor_shared_calib *shared,\r\nu32 *calibration)\r\n{\r\nconst struct tegra_tsensor_group *sensor_group;\r\nu32 val, calib;\r\ns32 actual_tsensor_ft, actual_tsensor_cp;\r\ns32 delta_sens, delta_temp;\r\ns32 mult, div;\r\ns16 therma, thermb;\r\ns64 temp;\r\nint err;\r\nsensor_group = sensor->group;\r\nerr = tegra_fuse_readl(sensor->calib_fuse_offset, &val);\r\nif (err)\r\nreturn err;\r\nactual_tsensor_cp = (shared->base_cp * 64) + sign_extend32(val, 12);\r\nval = (val & FUSE_TSENSOR_CALIB_FT_TS_BASE_MASK) >>\r\nFUSE_TSENSOR_CALIB_FT_TS_BASE_SHIFT;\r\nactual_tsensor_ft = (shared->base_ft * 32) + sign_extend32(val, 12);\r\ndelta_sens = actual_tsensor_ft - actual_tsensor_cp;\r\ndelta_temp = shared->actual_temp_ft - shared->actual_temp_cp;\r\nmult = sensor_group->pdiv * sensor->config->tsample_ate;\r\ndiv = sensor->config->tsample * sensor_group->pdiv_ate;\r\ntemp = (s64)delta_temp * (1LL << 13) * mult;\r\ntherma = div64_s64_precise(temp, (s64)delta_sens * div);\r\ntemp = ((s64)actual_tsensor_ft * shared->actual_temp_cp) -\r\n((s64)actual_tsensor_cp * shared->actual_temp_ft);\r\nthermb = div64_s64_precise(temp, delta_sens);\r\ntemp = (s64)therma * sensor->fuse_corr_alpha;\r\ntherma = div64_s64_precise(temp, CALIB_COEFFICIENT);\r\ntemp = (s64)thermb * sensor->fuse_corr_alpha + sensor->fuse_corr_beta;\r\nthermb = div64_s64_precise(temp, CALIB_COEFFICIENT);\r\ncalib = ((u16)therma << SENSOR_CONFIG2_THERMA_SHIFT) |\r\n((u16)thermb << SENSOR_CONFIG2_THERMB_SHIFT);\r\n*calibration = calib;\r\nreturn 0;\r\n}

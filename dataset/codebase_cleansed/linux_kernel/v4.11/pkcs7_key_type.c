static int pkcs7_view_content(void *ctx, const void *data, size_t len,\r\nsize_t asn1hdrlen)\r\n{\r\nstruct key_preparsed_payload *prep = ctx;\r\nconst void *saved_prep_data;\r\nsize_t saved_prep_datalen;\r\nint ret;\r\nsaved_prep_data = prep->data;\r\nsaved_prep_datalen = prep->datalen;\r\nprep->data = data;\r\nprep->datalen = len;\r\nret = user_preparse(prep);\r\nprep->data = saved_prep_data;\r\nprep->datalen = saved_prep_datalen;\r\nreturn ret;\r\n}\r\nstatic int pkcs7_preparse(struct key_preparsed_payload *prep)\r\n{\r\nenum key_being_used_for usage = pkcs7_usage;\r\nif (usage >= NR__KEY_BEING_USED_FOR) {\r\npr_err("Invalid usage type %d\n", usage);\r\nreturn -EINVAL;\r\n}\r\nreturn verify_pkcs7_signature(NULL, 0,\r\nprep->data, prep->datalen,\r\n(void *)1UL, usage,\r\npkcs7_view_content, prep);\r\n}\r\nstatic int __init pkcs7_key_init(void)\r\n{\r\nreturn register_key_type(&key_type_pkcs7);\r\n}\r\nstatic void __exit pkcs7_key_cleanup(void)\r\n{\r\nunregister_key_type(&key_type_pkcs7);\r\n}

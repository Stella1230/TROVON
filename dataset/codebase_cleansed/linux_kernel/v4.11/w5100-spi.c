static int w5100_spi_read(struct net_device *ndev, u32 addr)\r\n{\r\nstruct spi_device *spi = to_spi_device(ndev->dev.parent);\r\nu8 cmd[3] = { W5100_SPI_READ_OPCODE, addr >> 8, addr & 0xff };\r\nu8 data;\r\nint ret;\r\nret = spi_write_then_read(spi, cmd, sizeof(cmd), &data, 1);\r\nreturn ret ? ret : data;\r\n}\r\nstatic int w5100_spi_write(struct net_device *ndev, u32 addr, u8 data)\r\n{\r\nstruct spi_device *spi = to_spi_device(ndev->dev.parent);\r\nu8 cmd[4] = { W5100_SPI_WRITE_OPCODE, addr >> 8, addr & 0xff, data};\r\nreturn spi_write_then_read(spi, cmd, sizeof(cmd), NULL, 0);\r\n}\r\nstatic int w5100_spi_read16(struct net_device *ndev, u32 addr)\r\n{\r\nu16 data;\r\nint ret;\r\nret = w5100_spi_read(ndev, addr);\r\nif (ret < 0)\r\nreturn ret;\r\ndata = ret << 8;\r\nret = w5100_spi_read(ndev, addr + 1);\r\nreturn ret < 0 ? ret : data | ret;\r\n}\r\nstatic int w5100_spi_write16(struct net_device *ndev, u32 addr, u16 data)\r\n{\r\nint ret;\r\nret = w5100_spi_write(ndev, addr, data >> 8);\r\nif (ret)\r\nreturn ret;\r\nreturn w5100_spi_write(ndev, addr + 1, data & 0xff);\r\n}\r\nstatic int w5100_spi_readbulk(struct net_device *ndev, u32 addr, u8 *buf,\r\nint len)\r\n{\r\nint i;\r\nfor (i = 0; i < len; i++) {\r\nint ret = w5100_spi_read(ndev, addr + i);\r\nif (ret < 0)\r\nreturn ret;\r\nbuf[i] = ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int w5100_spi_writebulk(struct net_device *ndev, u32 addr, const u8 *buf,\r\nint len)\r\n{\r\nint i;\r\nfor (i = 0; i < len; i++) {\r\nint ret = w5100_spi_write(ndev, addr + i, buf[i]);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic struct w5200_spi_priv *w5200_spi_priv(struct net_device *ndev)\r\n{\r\nreturn w5100_ops_priv(ndev);\r\n}\r\nstatic int w5200_spi_init(struct net_device *ndev)\r\n{\r\nstruct w5200_spi_priv *spi_priv = w5200_spi_priv(ndev);\r\nmutex_init(&spi_priv->cmd_lock);\r\nreturn 0;\r\n}\r\nstatic int w5200_spi_read(struct net_device *ndev, u32 addr)\r\n{\r\nstruct spi_device *spi = to_spi_device(ndev->dev.parent);\r\nu8 cmd[4] = { addr >> 8, addr & 0xff, 0, 1 };\r\nu8 data;\r\nint ret;\r\nret = spi_write_then_read(spi, cmd, sizeof(cmd), &data, 1);\r\nreturn ret ? ret : data;\r\n}\r\nstatic int w5200_spi_write(struct net_device *ndev, u32 addr, u8 data)\r\n{\r\nstruct spi_device *spi = to_spi_device(ndev->dev.parent);\r\nu8 cmd[5] = { addr >> 8, addr & 0xff, W5200_SPI_WRITE_OPCODE, 1, data };\r\nreturn spi_write_then_read(spi, cmd, sizeof(cmd), NULL, 0);\r\n}\r\nstatic int w5200_spi_read16(struct net_device *ndev, u32 addr)\r\n{\r\nstruct spi_device *spi = to_spi_device(ndev->dev.parent);\r\nu8 cmd[4] = { addr >> 8, addr & 0xff, 0, 2 };\r\n__be16 data;\r\nint ret;\r\nret = spi_write_then_read(spi, cmd, sizeof(cmd), &data, sizeof(data));\r\nreturn ret ? ret : be16_to_cpu(data);\r\n}\r\nstatic int w5200_spi_write16(struct net_device *ndev, u32 addr, u16 data)\r\n{\r\nstruct spi_device *spi = to_spi_device(ndev->dev.parent);\r\nu8 cmd[6] = {\r\naddr >> 8, addr & 0xff,\r\nW5200_SPI_WRITE_OPCODE, 2,\r\ndata >> 8, data & 0xff\r\n};\r\nreturn spi_write_then_read(spi, cmd, sizeof(cmd), NULL, 0);\r\n}\r\nstatic int w5200_spi_readbulk(struct net_device *ndev, u32 addr, u8 *buf,\r\nint len)\r\n{\r\nstruct spi_device *spi = to_spi_device(ndev->dev.parent);\r\nstruct w5200_spi_priv *spi_priv = w5200_spi_priv(ndev);\r\nstruct spi_transfer xfer[] = {\r\n{\r\n.tx_buf = spi_priv->cmd_buf,\r\n.len = sizeof(spi_priv->cmd_buf),\r\n},\r\n{\r\n.rx_buf = buf,\r\n.len = len,\r\n},\r\n};\r\nint ret;\r\nmutex_lock(&spi_priv->cmd_lock);\r\nspi_priv->cmd_buf[0] = addr >> 8;\r\nspi_priv->cmd_buf[1] = addr;\r\nspi_priv->cmd_buf[2] = len >> 8;\r\nspi_priv->cmd_buf[3] = len;\r\nret = spi_sync_transfer(spi, xfer, ARRAY_SIZE(xfer));\r\nmutex_unlock(&spi_priv->cmd_lock);\r\nreturn ret;\r\n}\r\nstatic int w5200_spi_writebulk(struct net_device *ndev, u32 addr, const u8 *buf,\r\nint len)\r\n{\r\nstruct spi_device *spi = to_spi_device(ndev->dev.parent);\r\nstruct w5200_spi_priv *spi_priv = w5200_spi_priv(ndev);\r\nstruct spi_transfer xfer[] = {\r\n{\r\n.tx_buf = spi_priv->cmd_buf,\r\n.len = sizeof(spi_priv->cmd_buf),\r\n},\r\n{\r\n.tx_buf = buf,\r\n.len = len,\r\n},\r\n};\r\nint ret;\r\nmutex_lock(&spi_priv->cmd_lock);\r\nspi_priv->cmd_buf[0] = addr >> 8;\r\nspi_priv->cmd_buf[1] = addr;\r\nspi_priv->cmd_buf[2] = W5200_SPI_WRITE_OPCODE | (len >> 8);\r\nspi_priv->cmd_buf[3] = len;\r\nret = spi_sync_transfer(spi, xfer, ARRAY_SIZE(xfer));\r\nmutex_unlock(&spi_priv->cmd_lock);\r\nreturn ret;\r\n}\r\nstatic struct w5500_spi_priv *w5500_spi_priv(struct net_device *ndev)\r\n{\r\nreturn w5100_ops_priv(ndev);\r\n}\r\nstatic int w5500_spi_init(struct net_device *ndev)\r\n{\r\nstruct w5500_spi_priv *spi_priv = w5500_spi_priv(ndev);\r\nmutex_init(&spi_priv->cmd_lock);\r\nreturn 0;\r\n}\r\nstatic int w5500_spi_read(struct net_device *ndev, u32 addr)\r\n{\r\nstruct spi_device *spi = to_spi_device(ndev->dev.parent);\r\nu8 cmd[3] = {\r\naddr >> 8,\r\naddr,\r\nW5500_SPI_READ_CONTROL(addr)\r\n};\r\nu8 data;\r\nint ret;\r\nret = spi_write_then_read(spi, cmd, sizeof(cmd), &data, 1);\r\nreturn ret ? ret : data;\r\n}\r\nstatic int w5500_spi_write(struct net_device *ndev, u32 addr, u8 data)\r\n{\r\nstruct spi_device *spi = to_spi_device(ndev->dev.parent);\r\nu8 cmd[4] = {\r\naddr >> 8,\r\naddr,\r\nW5500_SPI_WRITE_CONTROL(addr),\r\ndata\r\n};\r\nreturn spi_write_then_read(spi, cmd, sizeof(cmd), NULL, 0);\r\n}\r\nstatic int w5500_spi_read16(struct net_device *ndev, u32 addr)\r\n{\r\nstruct spi_device *spi = to_spi_device(ndev->dev.parent);\r\nu8 cmd[3] = {\r\naddr >> 8,\r\naddr,\r\nW5500_SPI_READ_CONTROL(addr)\r\n};\r\n__be16 data;\r\nint ret;\r\nret = spi_write_then_read(spi, cmd, sizeof(cmd), &data, sizeof(data));\r\nreturn ret ? ret : be16_to_cpu(data);\r\n}\r\nstatic int w5500_spi_write16(struct net_device *ndev, u32 addr, u16 data)\r\n{\r\nstruct spi_device *spi = to_spi_device(ndev->dev.parent);\r\nu8 cmd[5] = {\r\naddr >> 8,\r\naddr,\r\nW5500_SPI_WRITE_CONTROL(addr),\r\ndata >> 8,\r\ndata\r\n};\r\nreturn spi_write_then_read(spi, cmd, sizeof(cmd), NULL, 0);\r\n}\r\nstatic int w5500_spi_readbulk(struct net_device *ndev, u32 addr, u8 *buf,\r\nint len)\r\n{\r\nstruct spi_device *spi = to_spi_device(ndev->dev.parent);\r\nstruct w5500_spi_priv *spi_priv = w5500_spi_priv(ndev);\r\nstruct spi_transfer xfer[] = {\r\n{\r\n.tx_buf = spi_priv->cmd_buf,\r\n.len = sizeof(spi_priv->cmd_buf),\r\n},\r\n{\r\n.rx_buf = buf,\r\n.len = len,\r\n},\r\n};\r\nint ret;\r\nmutex_lock(&spi_priv->cmd_lock);\r\nspi_priv->cmd_buf[0] = addr >> 8;\r\nspi_priv->cmd_buf[1] = addr;\r\nspi_priv->cmd_buf[2] = W5500_SPI_READ_CONTROL(addr);\r\nret = spi_sync_transfer(spi, xfer, ARRAY_SIZE(xfer));\r\nmutex_unlock(&spi_priv->cmd_lock);\r\nreturn ret;\r\n}\r\nstatic int w5500_spi_writebulk(struct net_device *ndev, u32 addr, const u8 *buf,\r\nint len)\r\n{\r\nstruct spi_device *spi = to_spi_device(ndev->dev.parent);\r\nstruct w5500_spi_priv *spi_priv = w5500_spi_priv(ndev);\r\nstruct spi_transfer xfer[] = {\r\n{\r\n.tx_buf = spi_priv->cmd_buf,\r\n.len = sizeof(spi_priv->cmd_buf),\r\n},\r\n{\r\n.tx_buf = buf,\r\n.len = len,\r\n},\r\n};\r\nint ret;\r\nmutex_lock(&spi_priv->cmd_lock);\r\nspi_priv->cmd_buf[0] = addr >> 8;\r\nspi_priv->cmd_buf[1] = addr;\r\nspi_priv->cmd_buf[2] = W5500_SPI_WRITE_CONTROL(addr);\r\nret = spi_sync_transfer(spi, xfer, ARRAY_SIZE(xfer));\r\nmutex_unlock(&spi_priv->cmd_lock);\r\nreturn ret;\r\n}\r\nstatic int w5100_spi_probe(struct spi_device *spi)\r\n{\r\nconst struct spi_device_id *id = spi_get_device_id(spi);\r\nconst struct w5100_ops *ops;\r\nint priv_size;\r\nconst void *mac = of_get_mac_address(spi->dev.of_node);\r\nswitch (id->driver_data) {\r\ncase W5100:\r\nops = &w5100_spi_ops;\r\npriv_size = 0;\r\nbreak;\r\ncase W5200:\r\nops = &w5200_ops;\r\npriv_size = sizeof(struct w5200_spi_priv);\r\nbreak;\r\ncase W5500:\r\nops = &w5500_ops;\r\npriv_size = sizeof(struct w5500_spi_priv);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn w5100_probe(&spi->dev, ops, priv_size, mac, spi->irq, -EINVAL);\r\n}\r\nstatic int w5100_spi_remove(struct spi_device *spi)\r\n{\r\nreturn w5100_remove(&spi->dev);\r\n}

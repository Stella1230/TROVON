static ssize_t mlog_mask_show(u64 mask, char *buf)\r\n{\r\nchar *state;\r\nif (__mlog_test_u64(mask, mlog_and_bits))\r\nstate = "allow";\r\nelse if (__mlog_test_u64(mask, mlog_not_bits))\r\nstate = "deny";\r\nelse\r\nstate = "off";\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n", state);\r\n}\r\nstatic ssize_t mlog_mask_store(u64 mask, const char *buf, size_t count)\r\n{\r\nif (!strncasecmp(buf, "allow", 5)) {\r\n__mlog_set_u64(mask, mlog_and_bits);\r\n__mlog_clear_u64(mask, mlog_not_bits);\r\n} else if (!strncasecmp(buf, "deny", 4)) {\r\n__mlog_set_u64(mask, mlog_not_bits);\r\n__mlog_clear_u64(mask, mlog_and_bits);\r\n} else if (!strncasecmp(buf, "off", 3)) {\r\n__mlog_clear_u64(mask, mlog_not_bits);\r\n__mlog_clear_u64(mask, mlog_and_bits);\r\n} else\r\nreturn -EINVAL;\r\nreturn count;\r\n}\r\nvoid __mlog_printk(const u64 *mask, const char *func, int line,\r\nconst char *fmt, ...)\r\n{\r\nstruct va_format vaf;\r\nva_list args;\r\nconst char *level;\r\nconst char *prefix = "";\r\nif (!__mlog_test_u64(*mask, mlog_and_bits) ||\r\n__mlog_test_u64(*mask, mlog_not_bits))\r\nreturn;\r\nif (*mask & ML_ERROR) {\r\nlevel = KERN_ERR;\r\nprefix = "ERROR: ";\r\n} else if (*mask & ML_NOTICE) {\r\nlevel = KERN_NOTICE;\r\n} else {\r\nlevel = KERN_INFO;\r\n}\r\nva_start(args, fmt);\r\nvaf.fmt = fmt;\r\nvaf.va = &args;\r\nprintk("%s(%s,%u,%u):%s:%d %s%pV",\r\nlevel, current->comm, task_pid_nr(current),\r\nraw_smp_processor_id(), func, line, prefix, &vaf);\r\nva_end(args);\r\n}\r\nstatic ssize_t mlog_show(struct kobject *obj, struct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct mlog_attribute *mlog_attr = to_mlog_attr(attr);\r\nreturn mlog_mask_show(mlog_attr->mask, buf);\r\n}\r\nstatic ssize_t mlog_store(struct kobject *obj, struct attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct mlog_attribute *mlog_attr = to_mlog_attr(attr);\r\nreturn mlog_mask_store(mlog_attr->mask, buf, count);\r\n}\r\nint mlog_sys_init(struct kset *o2cb_kset)\r\n{\r\nint i = 0;\r\nwhile (mlog_attrs[i].attr.mode) {\r\nmlog_attr_ptrs[i] = &mlog_attrs[i].attr;\r\ni++;\r\n}\r\nmlog_attr_ptrs[i] = NULL;\r\nkobject_set_name(&mlog_kset.kobj, "logmask");\r\nmlog_kset.kobj.kset = o2cb_kset;\r\nreturn kset_register(&mlog_kset);\r\n}\r\nvoid mlog_sys_shutdown(void)\r\n{\r\nkset_unregister(&mlog_kset);\r\n}

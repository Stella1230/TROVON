int l3mdev_master_ifindex_rcu(const struct net_device *dev)\r\n{\r\nint ifindex = 0;\r\nif (!dev)\r\nreturn 0;\r\nif (netif_is_l3_master(dev)) {\r\nifindex = dev->ifindex;\r\n} else if (netif_is_l3_slave(dev)) {\r\nstruct net_device *master;\r\nstruct net_device *_dev = (struct net_device *)dev;\r\nmaster = netdev_master_upper_dev_get_rcu(_dev);\r\nif (master)\r\nifindex = master->ifindex;\r\n}\r\nreturn ifindex;\r\n}\r\nu32 l3mdev_fib_table_rcu(const struct net_device *dev)\r\n{\r\nu32 tb_id = 0;\r\nif (!dev)\r\nreturn 0;\r\nif (netif_is_l3_master(dev)) {\r\nif (dev->l3mdev_ops->l3mdev_fib_table)\r\ntb_id = dev->l3mdev_ops->l3mdev_fib_table(dev);\r\n} else if (netif_is_l3_slave(dev)) {\r\nstruct net_device *_dev = (struct net_device *) dev;\r\nconst struct net_device *master;\r\nmaster = netdev_master_upper_dev_get_rcu(_dev);\r\nif (master &&\r\nmaster->l3mdev_ops->l3mdev_fib_table)\r\ntb_id = master->l3mdev_ops->l3mdev_fib_table(master);\r\n}\r\nreturn tb_id;\r\n}\r\nu32 l3mdev_fib_table_by_index(struct net *net, int ifindex)\r\n{\r\nstruct net_device *dev;\r\nu32 tb_id = 0;\r\nif (!ifindex)\r\nreturn 0;\r\nrcu_read_lock();\r\ndev = dev_get_by_index_rcu(net, ifindex);\r\nif (dev)\r\ntb_id = l3mdev_fib_table_rcu(dev);\r\nrcu_read_unlock();\r\nreturn tb_id;\r\n}\r\nstruct dst_entry *l3mdev_link_scope_lookup(struct net *net,\r\nstruct flowi6 *fl6)\r\n{\r\nstruct dst_entry *dst = NULL;\r\nstruct net_device *dev;\r\nif (fl6->flowi6_oif) {\r\nrcu_read_lock();\r\ndev = dev_get_by_index_rcu(net, fl6->flowi6_oif);\r\nif (dev && netif_is_l3_slave(dev))\r\ndev = netdev_master_upper_dev_get_rcu(dev);\r\nif (dev && netif_is_l3_master(dev) &&\r\ndev->l3mdev_ops->l3mdev_link_scope_lookup)\r\ndst = dev->l3mdev_ops->l3mdev_link_scope_lookup(dev, fl6);\r\nrcu_read_unlock();\r\n}\r\nreturn dst;\r\n}\r\nint l3mdev_fib_rule_match(struct net *net, struct flowi *fl,\r\nstruct fib_lookup_arg *arg)\r\n{\r\nstruct net_device *dev;\r\nint rc = 0;\r\nrcu_read_lock();\r\ndev = dev_get_by_index_rcu(net, fl->flowi_oif);\r\nif (dev && netif_is_l3_master(dev) &&\r\ndev->l3mdev_ops->l3mdev_fib_table) {\r\narg->table = dev->l3mdev_ops->l3mdev_fib_table(dev);\r\nrc = 1;\r\ngoto out;\r\n}\r\ndev = dev_get_by_index_rcu(net, fl->flowi_iif);\r\nif (dev && netif_is_l3_master(dev) &&\r\ndev->l3mdev_ops->l3mdev_fib_table) {\r\narg->table = dev->l3mdev_ops->l3mdev_fib_table(dev);\r\nrc = 1;\r\ngoto out;\r\n}\r\nout:\r\nrcu_read_unlock();\r\nreturn rc;\r\n}\r\nvoid l3mdev_update_flow(struct net *net, struct flowi *fl)\r\n{\r\nstruct net_device *dev;\r\nint ifindex;\r\nrcu_read_lock();\r\nif (fl->flowi_oif) {\r\ndev = dev_get_by_index_rcu(net, fl->flowi_oif);\r\nif (dev) {\r\nifindex = l3mdev_master_ifindex_rcu(dev);\r\nif (ifindex) {\r\nfl->flowi_oif = ifindex;\r\nfl->flowi_flags |= FLOWI_FLAG_SKIP_NH_OIF;\r\ngoto out;\r\n}\r\n}\r\n}\r\nif (fl->flowi_iif) {\r\ndev = dev_get_by_index_rcu(net, fl->flowi_iif);\r\nif (dev) {\r\nifindex = l3mdev_master_ifindex_rcu(dev);\r\nif (ifindex) {\r\nfl->flowi_iif = ifindex;\r\nfl->flowi_flags |= FLOWI_FLAG_SKIP_NH_OIF;\r\n}\r\n}\r\n}\r\nout:\r\nrcu_read_unlock();\r\n}

int __opal_async_get_token(void)\r\n{\r\nunsigned long flags;\r\nint token;\r\nspin_lock_irqsave(&opal_async_comp_lock, flags);\r\ntoken = find_first_bit(opal_async_complete_map, opal_max_async_tokens);\r\nif (token >= opal_max_async_tokens) {\r\ntoken = -EBUSY;\r\ngoto out;\r\n}\r\nif (__test_and_set_bit(token, opal_async_token_map)) {\r\ntoken = -EBUSY;\r\ngoto out;\r\n}\r\n__clear_bit(token, opal_async_complete_map);\r\nout:\r\nspin_unlock_irqrestore(&opal_async_comp_lock, flags);\r\nreturn token;\r\n}\r\nint opal_async_get_token_interruptible(void)\r\n{\r\nint token;\r\nif (down_interruptible(&opal_async_sem))\r\nreturn -ERESTARTSYS;\r\ntoken = __opal_async_get_token();\r\nif (token < 0)\r\nup(&opal_async_sem);\r\nreturn token;\r\n}\r\nint __opal_async_release_token(int token)\r\n{\r\nunsigned long flags;\r\nif (token < 0 || token >= opal_max_async_tokens) {\r\npr_err("%s: Passed token is out of range, token %d\n",\r\n__func__, token);\r\nreturn -EINVAL;\r\n}\r\nspin_lock_irqsave(&opal_async_comp_lock, flags);\r\n__set_bit(token, opal_async_complete_map);\r\n__clear_bit(token, opal_async_token_map);\r\nspin_unlock_irqrestore(&opal_async_comp_lock, flags);\r\nreturn 0;\r\n}\r\nint opal_async_release_token(int token)\r\n{\r\nint ret;\r\nret = __opal_async_release_token(token);\r\nif (ret)\r\nreturn ret;\r\nup(&opal_async_sem);\r\nreturn 0;\r\n}\r\nint opal_async_wait_response(uint64_t token, struct opal_msg *msg)\r\n{\r\nif (token >= opal_max_async_tokens) {\r\npr_err("%s: Invalid token passed\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nif (!msg) {\r\npr_err("%s: Invalid message pointer passed\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nopal_wake_poller();\r\nwait_event(opal_async_wait, test_bit(token, opal_async_complete_map));\r\nmemcpy(msg, &opal_async_responses[token], sizeof(*msg));\r\nreturn 0;\r\n}\r\nstatic int opal_async_comp_event(struct notifier_block *nb,\r\nunsigned long msg_type, void *msg)\r\n{\r\nstruct opal_msg *comp_msg = msg;\r\nunsigned long flags;\r\nuint64_t token;\r\nif (msg_type != OPAL_MSG_ASYNC_COMP)\r\nreturn 0;\r\ntoken = be64_to_cpu(comp_msg->params[0]);\r\nmemcpy(&opal_async_responses[token], comp_msg, sizeof(*comp_msg));\r\nspin_lock_irqsave(&opal_async_comp_lock, flags);\r\n__set_bit(token, opal_async_complete_map);\r\nspin_unlock_irqrestore(&opal_async_comp_lock, flags);\r\nwake_up(&opal_async_wait);\r\nreturn 0;\r\n}\r\nint __init opal_async_comp_init(void)\r\n{\r\nstruct device_node *opal_node;\r\nconst __be32 *async;\r\nint err;\r\nopal_node = of_find_node_by_path("/ibm,opal");\r\nif (!opal_node) {\r\npr_err("%s: Opal node not found\n", __func__);\r\nerr = -ENOENT;\r\ngoto out;\r\n}\r\nasync = of_get_property(opal_node, "opal-msg-async-num", NULL);\r\nif (!async) {\r\npr_err("%s: %s has no opal-msg-async-num\n",\r\n__func__, opal_node->full_name);\r\nerr = -ENOENT;\r\ngoto out_opal_node;\r\n}\r\nopal_max_async_tokens = be32_to_cpup(async);\r\nif (opal_max_async_tokens > N_ASYNC_COMPLETIONS)\r\nopal_max_async_tokens = N_ASYNC_COMPLETIONS;\r\nerr = opal_message_notifier_register(OPAL_MSG_ASYNC_COMP,\r\n&opal_async_comp_nb);\r\nif (err) {\r\npr_err("%s: Can't register OPAL event notifier (%d)\n",\r\n__func__, err);\r\ngoto out_opal_node;\r\n}\r\nopal_async_responses = kzalloc(\r\nsizeof(*opal_async_responses) * opal_max_async_tokens,\r\nGFP_KERNEL);\r\nif (!opal_async_responses) {\r\npr_err("%s: Out of memory, failed to do asynchronous "\r\n"completion init\n", __func__);\r\nerr = -ENOMEM;\r\ngoto out_opal_node;\r\n}\r\nsema_init(&opal_async_sem, opal_max_async_tokens - 1);\r\nout_opal_node:\r\nof_node_put(opal_node);\r\nout:\r\nreturn err;\r\n}

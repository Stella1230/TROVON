asmlinkage void plat_irq_dispatch(void)\r\n{\r\nunsigned long pending;\r\nint irq;\r\npending = read_c0_status() & read_c0_cause() & ST0_IM;\r\nif (!pending) {\r\nspurious_interrupt();\r\nreturn;\r\n}\r\npending >>= CAUSEB_IP;\r\nwhile (pending) {\r\nirq = fls(pending) - 1;\r\nif (irq < ARRAY_SIZE(irq_wb_chan) && irq_wb_chan[irq] != -1)\r\nath79_ddr_wb_flush(irq_wb_chan[irq]);\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + irq);\r\npending &= ~BIT(irq);\r\n}\r\n}\r\nstatic int __init ar79_cpu_intc_of_init(\r\nstruct device_node *node, struct device_node *parent)\r\n{\r\nint err, i, count;\r\ncount = of_count_phandle_with_args(\r\nnode, "qca,ddr-wb-channels", "#qca,ddr-wb-channel-cells");\r\nfor (i = 0; i < count; i++) {\r\nstruct of_phandle_args args;\r\nu32 irq = i;\r\nof_property_read_u32_index(\r\nnode, "qca,ddr-wb-channel-interrupts", i, &irq);\r\nif (irq >= ARRAY_SIZE(irq_wb_chan))\r\ncontinue;\r\nerr = of_parse_phandle_with_args(\r\nnode, "qca,ddr-wb-channels",\r\n"#qca,ddr-wb-channel-cells",\r\ni, &args);\r\nif (err)\r\nreturn err;\r\nirq_wb_chan[irq] = args.args[0];\r\n}\r\nreturn mips_cpu_irq_of_init(node, parent);\r\n}\r\nvoid __init ath79_cpu_irq_init(unsigned irq_wb_chan2, unsigned irq_wb_chan3)\r\n{\r\nirq_wb_chan[2] = irq_wb_chan2;\r\nirq_wb_chan[3] = irq_wb_chan3;\r\nmips_cpu_irq_init();\r\n}

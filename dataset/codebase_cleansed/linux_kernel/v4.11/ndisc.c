static int lowpan_ndisc_is_useropt(u8 nd_opt_type)\r\n{\r\nreturn nd_opt_type == ND_OPT_6CO;\r\n}\r\nstatic int lowpan_ndisc_parse_802154_options(const struct net_device *dev,\r\nstruct nd_opt_hdr *nd_opt,\r\nstruct ndisc_options *ndopts)\r\n{\r\nswitch (nd_opt->nd_opt_len) {\r\ncase NDISC_802154_SHORT_ADDR_LENGTH:\r\nif (ndopts->nd_802154_opt_array[nd_opt->nd_opt_type])\r\nND_PRINTK(2, warn,\r\n"%s: duplicated short addr ND6 option found: type=%d\n",\r\n__func__, nd_opt->nd_opt_type);\r\nelse\r\nndopts->nd_802154_opt_array[nd_opt->nd_opt_type] = nd_opt;\r\nreturn 1;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic int lowpan_ndisc_parse_options(const struct net_device *dev,\r\nstruct nd_opt_hdr *nd_opt,\r\nstruct ndisc_options *ndopts)\r\n{\r\nif (!lowpan_is_ll(dev, LOWPAN_LLTYPE_IEEE802154))\r\nreturn 0;\r\nswitch (nd_opt->nd_opt_type) {\r\ncase ND_OPT_SOURCE_LL_ADDR:\r\ncase ND_OPT_TARGET_LL_ADDR:\r\nreturn lowpan_ndisc_parse_802154_options(dev, nd_opt, ndopts);\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic void lowpan_ndisc_802154_update(struct neighbour *n, u32 flags,\r\nu8 icmp6_type,\r\nconst struct ndisc_options *ndopts)\r\n{\r\nstruct lowpan_802154_neigh *neigh = lowpan_802154_neigh(neighbour_priv(n));\r\nu8 *lladdr_short = NULL;\r\nswitch (icmp6_type) {\r\ncase NDISC_ROUTER_SOLICITATION:\r\ncase NDISC_ROUTER_ADVERTISEMENT:\r\ncase NDISC_NEIGHBOUR_SOLICITATION:\r\nif (ndopts->nd_802154_opts_src_lladdr) {\r\nlladdr_short = __ndisc_opt_addr_data(ndopts->nd_802154_opts_src_lladdr,\r\nIEEE802154_SHORT_ADDR_LEN, 0);\r\nif (!lladdr_short) {\r\nND_PRINTK(2, warn,\r\n"NA: invalid short link-layer address length\n");\r\nreturn;\r\n}\r\n}\r\nbreak;\r\ncase NDISC_REDIRECT:\r\ncase NDISC_NEIGHBOUR_ADVERTISEMENT:\r\nif (ndopts->nd_802154_opts_tgt_lladdr) {\r\nlladdr_short = __ndisc_opt_addr_data(ndopts->nd_802154_opts_tgt_lladdr,\r\nIEEE802154_SHORT_ADDR_LEN, 0);\r\nif (!lladdr_short) {\r\nND_PRINTK(2, warn,\r\n"NA: invalid short link-layer address length\n");\r\nreturn;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nwrite_lock_bh(&n->lock);\r\nif (lladdr_short) {\r\nieee802154_be16_to_le16(&neigh->short_addr, lladdr_short);\r\nif (!lowpan_802154_is_valid_src_short_addr(neigh->short_addr))\r\nneigh->short_addr = cpu_to_le16(IEEE802154_ADDR_SHORT_UNSPEC);\r\n}\r\nwrite_unlock_bh(&n->lock);\r\n}\r\nstatic void lowpan_ndisc_update(const struct net_device *dev,\r\nstruct neighbour *n, u32 flags, u8 icmp6_type,\r\nconst struct ndisc_options *ndopts)\r\n{\r\nif (!lowpan_is_ll(dev, LOWPAN_LLTYPE_IEEE802154))\r\nreturn;\r\nif (flags & NEIGH_UPDATE_F_OVERRIDE)\r\nlowpan_ndisc_802154_update(n, flags, icmp6_type, ndopts);\r\n}\r\nstatic int lowpan_ndisc_opt_addr_space(const struct net_device *dev,\r\nu8 icmp6_type, struct neighbour *neigh,\r\nu8 *ha_buf, u8 **ha)\r\n{\r\nstruct lowpan_802154_neigh *n;\r\nstruct wpan_dev *wpan_dev;\r\nint addr_space = 0;\r\nif (!lowpan_is_ll(dev, LOWPAN_LLTYPE_IEEE802154))\r\nreturn 0;\r\nswitch (icmp6_type) {\r\ncase NDISC_REDIRECT:\r\nn = lowpan_802154_neigh(neighbour_priv(neigh));\r\nread_lock_bh(&neigh->lock);\r\nif (lowpan_802154_is_valid_src_short_addr(n->short_addr)) {\r\nmemcpy(ha_buf, &n->short_addr,\r\nIEEE802154_SHORT_ADDR_LEN);\r\nread_unlock_bh(&neigh->lock);\r\naddr_space += __ndisc_opt_addr_space(IEEE802154_SHORT_ADDR_LEN, 0);\r\n*ha = ha_buf;\r\n} else {\r\nread_unlock_bh(&neigh->lock);\r\n}\r\nbreak;\r\ncase NDISC_NEIGHBOUR_ADVERTISEMENT:\r\ncase NDISC_NEIGHBOUR_SOLICITATION:\r\ncase NDISC_ROUTER_SOLICITATION:\r\nwpan_dev = lowpan_802154_dev(dev)->wdev->ieee802154_ptr;\r\nif (lowpan_802154_is_valid_src_short_addr(wpan_dev->short_addr))\r\naddr_space = __ndisc_opt_addr_space(IEEE802154_SHORT_ADDR_LEN, 0);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn addr_space;\r\n}\r\nstatic void lowpan_ndisc_fill_addr_option(const struct net_device *dev,\r\nstruct sk_buff *skb, u8 icmp6_type,\r\nconst u8 *ha)\r\n{\r\nstruct wpan_dev *wpan_dev;\r\n__be16 short_addr;\r\nu8 opt_type;\r\nif (!lowpan_is_ll(dev, LOWPAN_LLTYPE_IEEE802154))\r\nreturn;\r\nswitch (icmp6_type) {\r\ncase NDISC_REDIRECT:\r\nif (ha) {\r\nieee802154_le16_to_be16(&short_addr, ha);\r\n__ndisc_fill_addr_option(skb, ND_OPT_TARGET_LL_ADDR,\r\n&short_addr,\r\nIEEE802154_SHORT_ADDR_LEN, 0);\r\n}\r\nreturn;\r\ncase NDISC_NEIGHBOUR_ADVERTISEMENT:\r\nopt_type = ND_OPT_TARGET_LL_ADDR;\r\nbreak;\r\ncase NDISC_ROUTER_SOLICITATION:\r\ncase NDISC_NEIGHBOUR_SOLICITATION:\r\nopt_type = ND_OPT_SOURCE_LL_ADDR;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nwpan_dev = lowpan_802154_dev(dev)->wdev->ieee802154_ptr;\r\nif (lowpan_802154_is_valid_src_short_addr(wpan_dev->short_addr)) {\r\nieee802154_le16_to_be16(&short_addr,\r\n&wpan_dev->short_addr);\r\n__ndisc_fill_addr_option(skb, opt_type, &short_addr,\r\nIEEE802154_SHORT_ADDR_LEN, 0);\r\n}\r\n}\r\nstatic void lowpan_ndisc_prefix_rcv_add_addr(struct net *net,\r\nstruct net_device *dev,\r\nconst struct prefix_info *pinfo,\r\nstruct inet6_dev *in6_dev,\r\nstruct in6_addr *addr,\r\nint addr_type, u32 addr_flags,\r\nbool sllao, bool tokenized,\r\n__u32 valid_lft,\r\nu32 prefered_lft,\r\nbool dev_addr_generated)\r\n{\r\nint err;\r\nif (lowpan_is_ll(dev, LOWPAN_LLTYPE_IEEE802154) && dev_addr_generated &&\r\n!addrconf_ifid_802154_6lowpan(addr->s6_addr + 8, dev)) {\r\nerr = addrconf_prefix_rcv_add_addr(net, dev, pinfo, in6_dev,\r\naddr, addr_type, addr_flags,\r\nsllao, tokenized, valid_lft,\r\nprefered_lft);\r\nif (err)\r\nND_PRINTK(2, warn,\r\n"RA: could not add a short address based address for prefix: %pI6c\n",\r\n&pinfo->prefix);\r\n}\r\n}

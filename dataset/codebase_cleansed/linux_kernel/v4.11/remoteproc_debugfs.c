static ssize_t rproc_trace_read(struct file *filp, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct rproc_mem_entry *trace = filp->private_data;\r\nint len = strnlen(trace->va, trace->len);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, trace->va, len);\r\n}\r\nstatic ssize_t rproc_name_read(struct file *filp, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct rproc *rproc = filp->private_data;\r\nchar buf[100];\r\nint i;\r\ni = scnprintf(buf, sizeof(buf), "%.98s\n", rproc->name);\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, i);\r\n}\r\nstatic ssize_t rproc_recovery_read(struct file *filp, char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct rproc *rproc = filp->private_data;\r\nchar *buf = rproc->recovery_disabled ? "disabled\n" : "enabled\n";\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, strlen(buf));\r\n}\r\nstatic ssize_t\r\nrproc_recovery_write(struct file *filp, const char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct rproc *rproc = filp->private_data;\r\nchar buf[10];\r\nint ret;\r\nif (count < 1 || count > sizeof(buf))\r\nreturn -EINVAL;\r\nret = copy_from_user(buf, user_buf, count);\r\nif (ret)\r\nreturn -EFAULT;\r\nif (buf[count - 1] == '\n')\r\nbuf[count - 1] = '\0';\r\nif (!strncmp(buf, "enabled", count)) {\r\nrproc->recovery_disabled = false;\r\nif (rproc->state == RPROC_CRASHED)\r\nrproc_trigger_recovery(rproc);\r\n} else if (!strncmp(buf, "disabled", count)) {\r\nrproc->recovery_disabled = true;\r\n} else if (!strncmp(buf, "recover", count)) {\r\nif (rproc->state == RPROC_CRASHED)\r\nrproc_trigger_recovery(rproc);\r\n}\r\nreturn count;\r\n}\r\nvoid rproc_remove_trace_file(struct dentry *tfile)\r\n{\r\ndebugfs_remove(tfile);\r\n}\r\nstruct dentry *rproc_create_trace_file(const char *name, struct rproc *rproc,\r\nstruct rproc_mem_entry *trace)\r\n{\r\nstruct dentry *tfile;\r\ntfile = debugfs_create_file(name, 0400, rproc->dbg_dir, trace,\r\n&trace_rproc_ops);\r\nif (!tfile) {\r\ndev_err(&rproc->dev, "failed to create debugfs trace entry\n");\r\nreturn NULL;\r\n}\r\nreturn tfile;\r\n}\r\nvoid rproc_delete_debug_dir(struct rproc *rproc)\r\n{\r\nif (!rproc->dbg_dir)\r\nreturn;\r\ndebugfs_remove_recursive(rproc->dbg_dir);\r\n}\r\nvoid rproc_create_debug_dir(struct rproc *rproc)\r\n{\r\nstruct device *dev = &rproc->dev;\r\nif (!rproc_dbg)\r\nreturn;\r\nrproc->dbg_dir = debugfs_create_dir(dev_name(dev), rproc_dbg);\r\nif (!rproc->dbg_dir)\r\nreturn;\r\ndebugfs_create_file("name", 0400, rproc->dbg_dir,\r\nrproc, &rproc_name_ops);\r\ndebugfs_create_file("recovery", 0400, rproc->dbg_dir,\r\nrproc, &rproc_recovery_ops);\r\n}\r\nvoid __init rproc_init_debugfs(void)\r\n{\r\nif (debugfs_initialized()) {\r\nrproc_dbg = debugfs_create_dir(KBUILD_MODNAME, NULL);\r\nif (!rproc_dbg)\r\npr_err("can't create debugfs dir\n");\r\n}\r\n}\r\nvoid __exit rproc_exit_debugfs(void)\r\n{\r\ndebugfs_remove(rproc_dbg);\r\n}

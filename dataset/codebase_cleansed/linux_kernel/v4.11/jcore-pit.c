static notrace u64 jcore_sched_clock_read(void)\r\n{\r\nu32 seclo, nsec, seclo0;\r\n__iomem void *base = jcore_pit_base;\r\nseclo = readl(base + REG_SECLO);\r\ndo {\r\nseclo0 = seclo;\r\nnsec = readl(base + REG_NSEC);\r\nseclo = readl(base + REG_SECLO);\r\n} while (seclo0 != seclo);\r\nreturn seclo * NSEC_PER_SEC + nsec;\r\n}\r\nstatic u64 jcore_clocksource_read(struct clocksource *cs)\r\n{\r\nreturn jcore_sched_clock_read();\r\n}\r\nstatic int jcore_pit_disable(struct jcore_pit *pit)\r\n{\r\nwritel(0, pit->base + REG_PITEN);\r\nreturn 0;\r\n}\r\nstatic int jcore_pit_set(unsigned long delta, struct jcore_pit *pit)\r\n{\r\njcore_pit_disable(pit);\r\nwritel(delta, pit->base + REG_THROT);\r\nwritel(pit->enable_val, pit->base + REG_PITEN);\r\nreturn 0;\r\n}\r\nstatic int jcore_pit_set_state_shutdown(struct clock_event_device *ced)\r\n{\r\nstruct jcore_pit *pit = container_of(ced, struct jcore_pit, ced);\r\nreturn jcore_pit_disable(pit);\r\n}\r\nstatic int jcore_pit_set_state_oneshot(struct clock_event_device *ced)\r\n{\r\nstruct jcore_pit *pit = container_of(ced, struct jcore_pit, ced);\r\nreturn jcore_pit_disable(pit);\r\n}\r\nstatic int jcore_pit_set_state_periodic(struct clock_event_device *ced)\r\n{\r\nstruct jcore_pit *pit = container_of(ced, struct jcore_pit, ced);\r\nreturn jcore_pit_set(pit->periodic_delta, pit);\r\n}\r\nstatic int jcore_pit_set_next_event(unsigned long delta,\r\nstruct clock_event_device *ced)\r\n{\r\nstruct jcore_pit *pit = container_of(ced, struct jcore_pit, ced);\r\nreturn jcore_pit_set(delta, pit);\r\n}\r\nstatic int jcore_pit_local_init(unsigned cpu)\r\n{\r\nstruct jcore_pit *pit = this_cpu_ptr(jcore_pit_percpu);\r\nunsigned buspd, freq;\r\npr_info("Local J-Core PIT init on cpu %u\n", cpu);\r\nbuspd = readl(pit->base + REG_BUSPD);\r\nfreq = DIV_ROUND_CLOSEST(NSEC_PER_SEC, buspd);\r\npit->periodic_delta = DIV_ROUND_CLOSEST(NSEC_PER_SEC, HZ * buspd);\r\nclockevents_config_and_register(&pit->ced, freq, 1, ULONG_MAX);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t jcore_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct jcore_pit *pit = this_cpu_ptr(dev_id);\r\nif (clockevent_state_oneshot(&pit->ced))\r\njcore_pit_disable(pit);\r\npit->ced.event_handler(&pit->ced);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init jcore_pit_init(struct device_node *node)\r\n{\r\nint err;\r\nunsigned pit_irq, cpu;\r\nunsigned long hwirq;\r\nu32 irqprio, enable_val;\r\njcore_pit_base = of_iomap(node, 0);\r\nif (!jcore_pit_base) {\r\npr_err("Error: Cannot map base address for J-Core PIT\n");\r\nreturn -ENXIO;\r\n}\r\npit_irq = irq_of_parse_and_map(node, 0);\r\nif (!pit_irq) {\r\npr_err("Error: J-Core PIT has no IRQ\n");\r\nreturn -ENXIO;\r\n}\r\npr_info("Initializing J-Core PIT at %p IRQ %d\n",\r\njcore_pit_base, pit_irq);\r\nerr = clocksource_mmio_init(jcore_pit_base, "jcore_pit_cs",\r\nNSEC_PER_SEC, 400, 32,\r\njcore_clocksource_read);\r\nif (err) {\r\npr_err("Error registering clocksource device: %d\n", err);\r\nreturn err;\r\n}\r\nsched_clock_register(jcore_sched_clock_read, 32, NSEC_PER_SEC);\r\njcore_pit_percpu = alloc_percpu(struct jcore_pit);\r\nif (!jcore_pit_percpu) {\r\npr_err("Failed to allocate memory for clock event device\n");\r\nreturn -ENOMEM;\r\n}\r\nerr = request_irq(pit_irq, jcore_timer_interrupt,\r\nIRQF_TIMER | IRQF_PERCPU,\r\n"jcore_pit", jcore_pit_percpu);\r\nif (err) {\r\npr_err("pit irq request failed: %d\n", err);\r\nfree_percpu(jcore_pit_percpu);\r\nreturn err;\r\n}\r\nhwirq = irq_get_irq_data(pit_irq)->hwirq;\r\nirqprio = (hwirq >> 2) & PIT_PRIO_MASK;\r\nenable_val = (1U << PIT_ENABLE_SHIFT)\r\n| (hwirq << PIT_IRQ_SHIFT)\r\n| (irqprio << PIT_PRIO_SHIFT);\r\nfor_each_present_cpu(cpu) {\r\nstruct jcore_pit *pit = per_cpu_ptr(jcore_pit_percpu, cpu);\r\npit->base = of_iomap(node, cpu);\r\nif (!pit->base) {\r\npr_err("Unable to map PIT for cpu %u\n", cpu);\r\ncontinue;\r\n}\r\npit->ced.name = "jcore_pit";\r\npit->ced.features = CLOCK_EVT_FEAT_PERIODIC\r\n| CLOCK_EVT_FEAT_ONESHOT\r\n| CLOCK_EVT_FEAT_PERCPU;\r\npit->ced.cpumask = cpumask_of(cpu);\r\npit->ced.rating = 400;\r\npit->ced.irq = pit_irq;\r\npit->ced.set_state_shutdown = jcore_pit_set_state_shutdown;\r\npit->ced.set_state_periodic = jcore_pit_set_state_periodic;\r\npit->ced.set_state_oneshot = jcore_pit_set_state_oneshot;\r\npit->ced.set_next_event = jcore_pit_set_next_event;\r\npit->enable_val = enable_val;\r\n}\r\ncpuhp_setup_state(CPUHP_AP_JCORE_TIMER_STARTING,\r\n"clockevents/jcore:starting",\r\njcore_pit_local_init, NULL);\r\nreturn 0;\r\n}

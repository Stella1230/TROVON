static inline struct tegra_clk_periph_fixed *\r\nto_tegra_clk_periph_fixed(struct clk_hw *hw)\r\n{\r\nreturn container_of(hw, struct tegra_clk_periph_fixed, hw);\r\n}\r\nstatic int tegra_clk_periph_fixed_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct tegra_clk_periph_fixed *fixed = to_tegra_clk_periph_fixed(hw);\r\nu32 mask = 1 << (fixed->num % 32), value;\r\nvalue = readl(fixed->base + fixed->regs->enb_reg);\r\nif (value & mask) {\r\nvalue = readl(fixed->base + fixed->regs->rst_reg);\r\nif ((value & mask) == 0)\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tegra_clk_periph_fixed_enable(struct clk_hw *hw)\r\n{\r\nstruct tegra_clk_periph_fixed *fixed = to_tegra_clk_periph_fixed(hw);\r\nu32 mask = 1 << (fixed->num % 32);\r\nwritel(mask, fixed->base + fixed->regs->enb_set_reg);\r\nreturn 0;\r\n}\r\nstatic void tegra_clk_periph_fixed_disable(struct clk_hw *hw)\r\n{\r\nstruct tegra_clk_periph_fixed *fixed = to_tegra_clk_periph_fixed(hw);\r\nu32 mask = 1 << (fixed->num % 32);\r\nwritel(mask, fixed->base + fixed->regs->enb_clr_reg);\r\n}\r\nstatic unsigned long\r\ntegra_clk_periph_fixed_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct tegra_clk_periph_fixed *fixed = to_tegra_clk_periph_fixed(hw);\r\nunsigned long long rate;\r\nrate = (unsigned long long)parent_rate * fixed->mul;\r\ndo_div(rate, fixed->div);\r\nreturn (unsigned long)rate;\r\n}\r\nstruct clk *tegra_clk_register_periph_fixed(const char *name,\r\nconst char *parent,\r\nunsigned long flags,\r\nvoid __iomem *base,\r\nunsigned int mul,\r\nunsigned int div,\r\nunsigned int num)\r\n{\r\nconst struct tegra_clk_periph_regs *regs;\r\nstruct tegra_clk_periph_fixed *fixed;\r\nstruct clk_init_data init;\r\nstruct clk *clk;\r\nregs = get_reg_bank(num);\r\nif (!regs)\r\nreturn ERR_PTR(-EINVAL);\r\nfixed = kzalloc(sizeof(*fixed), GFP_KERNEL);\r\nif (!fixed)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.flags = flags;\r\ninit.parent_names = parent ? &parent : NULL;\r\ninit.num_parents = parent ? 1 : 0;\r\ninit.ops = &tegra_clk_periph_fixed_ops;\r\nfixed->base = base;\r\nfixed->regs = regs;\r\nfixed->mul = mul;\r\nfixed->div = div;\r\nfixed->num = num;\r\nfixed->hw.init = &init;\r\nclk = clk_register(NULL, &fixed->hw);\r\nif (IS_ERR(clk))\r\nkfree(fixed);\r\nreturn clk;\r\n}

void zfcp_unit_scsi_scan(struct zfcp_unit *unit)\r\n{\r\nstruct fc_rport *rport = unit->port->rport;\r\nu64 lun;\r\nlun = scsilun_to_int((struct scsi_lun *) &unit->fcp_lun);\r\nif (rport && rport->port_state == FC_PORTSTATE_ONLINE)\r\nscsi_scan_target(&rport->dev, 0, rport->scsi_target_id, lun,\r\nSCSI_SCAN_MANUAL);\r\n}\r\nstatic void zfcp_unit_scsi_scan_work(struct work_struct *work)\r\n{\r\nstruct zfcp_unit *unit = container_of(work, struct zfcp_unit,\r\nscsi_work);\r\nzfcp_unit_scsi_scan(unit);\r\nput_device(&unit->dev);\r\n}\r\nvoid zfcp_unit_queue_scsi_scan(struct zfcp_port *port)\r\n{\r\nstruct zfcp_unit *unit;\r\nread_lock_irq(&port->unit_list_lock);\r\nlist_for_each_entry(unit, &port->unit_list, list) {\r\nget_device(&unit->dev);\r\nif (scsi_queue_work(port->adapter->scsi_host,\r\n&unit->scsi_work) <= 0)\r\nput_device(&unit->dev);\r\n}\r\nread_unlock_irq(&port->unit_list_lock);\r\n}\r\nstatic struct zfcp_unit *_zfcp_unit_find(struct zfcp_port *port, u64 fcp_lun)\r\n{\r\nstruct zfcp_unit *unit;\r\nlist_for_each_entry(unit, &port->unit_list, list)\r\nif (unit->fcp_lun == fcp_lun) {\r\nget_device(&unit->dev);\r\nreturn unit;\r\n}\r\nreturn NULL;\r\n}\r\nstruct zfcp_unit *zfcp_unit_find(struct zfcp_port *port, u64 fcp_lun)\r\n{\r\nstruct zfcp_unit *unit;\r\nread_lock_irq(&port->unit_list_lock);\r\nunit = _zfcp_unit_find(port, fcp_lun);\r\nread_unlock_irq(&port->unit_list_lock);\r\nreturn unit;\r\n}\r\nstatic void zfcp_unit_release(struct device *dev)\r\n{\r\nstruct zfcp_unit *unit = container_of(dev, struct zfcp_unit, dev);\r\natomic_dec(&unit->port->units);\r\nkfree(unit);\r\n}\r\nint zfcp_unit_add(struct zfcp_port *port, u64 fcp_lun)\r\n{\r\nstruct zfcp_unit *unit;\r\nint retval = 0;\r\nmutex_lock(&zfcp_sysfs_port_units_mutex);\r\nif (atomic_read(&port->units) == -1) {\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\nunit = zfcp_unit_find(port, fcp_lun);\r\nif (unit) {\r\nput_device(&unit->dev);\r\nretval = -EEXIST;\r\ngoto out;\r\n}\r\nunit = kzalloc(sizeof(struct zfcp_unit), GFP_KERNEL);\r\nif (!unit) {\r\nretval = -ENOMEM;\r\ngoto out;\r\n}\r\nunit->port = port;\r\nunit->fcp_lun = fcp_lun;\r\nunit->dev.parent = &port->dev;\r\nunit->dev.release = zfcp_unit_release;\r\nunit->dev.groups = zfcp_unit_attr_groups;\r\nINIT_WORK(&unit->scsi_work, zfcp_unit_scsi_scan_work);\r\nif (dev_set_name(&unit->dev, "0x%016llx",\r\n(unsigned long long) fcp_lun)) {\r\nkfree(unit);\r\nretval = -ENOMEM;\r\ngoto out;\r\n}\r\nif (device_register(&unit->dev)) {\r\nput_device(&unit->dev);\r\nretval = -ENOMEM;\r\ngoto out;\r\n}\r\natomic_inc(&port->units);\r\nwrite_lock_irq(&port->unit_list_lock);\r\nlist_add_tail(&unit->list, &port->unit_list);\r\nwrite_unlock_irq(&port->unit_list_lock);\r\nzfcp_unit_scsi_scan(unit);\r\nout:\r\nmutex_unlock(&zfcp_sysfs_port_units_mutex);\r\nreturn retval;\r\n}\r\nstruct scsi_device *zfcp_unit_sdev(struct zfcp_unit *unit)\r\n{\r\nstruct Scsi_Host *shost;\r\nstruct zfcp_port *port;\r\nu64 lun;\r\nlun = scsilun_to_int((struct scsi_lun *) &unit->fcp_lun);\r\nport = unit->port;\r\nshost = port->adapter->scsi_host;\r\nreturn scsi_device_lookup(shost, 0, port->starget_id, lun);\r\n}\r\nunsigned int zfcp_unit_sdev_status(struct zfcp_unit *unit)\r\n{\r\nunsigned int status = 0;\r\nstruct scsi_device *sdev;\r\nstruct zfcp_scsi_dev *zfcp_sdev;\r\nsdev = zfcp_unit_sdev(unit);\r\nif (sdev) {\r\nzfcp_sdev = sdev_to_zfcp(sdev);\r\nstatus = atomic_read(&zfcp_sdev->status);\r\nscsi_device_put(sdev);\r\n}\r\nreturn status;\r\n}\r\nint zfcp_unit_remove(struct zfcp_port *port, u64 fcp_lun)\r\n{\r\nstruct zfcp_unit *unit;\r\nstruct scsi_device *sdev;\r\nwrite_lock_irq(&port->unit_list_lock);\r\nunit = _zfcp_unit_find(port, fcp_lun);\r\nif (unit)\r\nlist_del(&unit->list);\r\nwrite_unlock_irq(&port->unit_list_lock);\r\nif (!unit)\r\nreturn -EINVAL;\r\nsdev = zfcp_unit_sdev(unit);\r\nif (sdev) {\r\nscsi_remove_device(sdev);\r\nscsi_device_put(sdev);\r\n}\r\nput_device(&unit->dev);\r\ndevice_unregister(&unit->dev);\r\nreturn 0;\r\n}

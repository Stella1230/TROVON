static void do_set_sstate(unsigned long state, const char *msg)\r\n{\r\nunsigned long err;\r\nif (!hv_supports_soft_state)\r\nreturn;\r\nerr = sun4v_mach_set_soft_state(state, kimage_addr_to_ra(msg));\r\nif (err) {\r\nprintk(KERN_WARNING "SSTATE: Failed to set soft-state to "\r\n"state[%lx] msg[%s], err=%lu\n",\r\nstate, msg, err);\r\n}\r\n}\r\nstatic int sstate_reboot_call(struct notifier_block *np, unsigned long type, void *_unused)\r\n{\r\nconst char *msg;\r\nswitch (type) {\r\ncase SYS_DOWN:\r\ndefault:\r\nmsg = rebooting_msg;\r\nbreak;\r\ncase SYS_HALT:\r\nmsg = halting_msg;\r\nbreak;\r\ncase SYS_POWER_OFF:\r\nmsg = poweroff_msg;\r\nbreak;\r\n}\r\ndo_set_sstate(HV_SOFT_STATE_TRANSITION, msg);\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int sstate_panic_event(struct notifier_block *n, unsigned long event, void *ptr)\r\n{\r\ndo_set_sstate(HV_SOFT_STATE_TRANSITION, panicking_msg);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init sstate_init(void)\r\n{\r\nunsigned long major, minor;\r\nif (tlb_type != hypervisor)\r\nreturn 0;\r\nmajor = 1;\r\nminor = 0;\r\nif (sun4v_hvapi_register(HV_GRP_SOFT_STATE, major, &minor))\r\nreturn 0;\r\nhv_supports_soft_state = 1;\r\nprom_sun4v_guest_soft_state();\r\ndo_set_sstate(HV_SOFT_STATE_TRANSITION, booting_msg);\r\natomic_notifier_chain_register(&panic_notifier_list,\r\n&sstate_panic_block);\r\nregister_reboot_notifier(&sstate_reboot_notifier);\r\nreturn 0;\r\n}\r\nstatic int __init sstate_running(void)\r\n{\r\ndo_set_sstate(HV_SOFT_STATE_NORMAL, running_msg);\r\nreturn 0;\r\n}

static int __init renesas_soc_init(void)\r\n{\r\nstruct soc_device_attribute *soc_dev_attr;\r\nconst struct renesas_family *family;\r\nconst struct of_device_id *match;\r\nconst struct renesas_soc *soc;\r\nvoid __iomem *chipid = NULL;\r\nstruct soc_device *soc_dev;\r\nstruct device_node *np;\r\nunsigned int product;\r\nmatch = of_match_node(renesas_socs, of_root);\r\nif (!match)\r\nreturn -ENODEV;\r\nsoc = match->data;\r\nfamily = soc->family;\r\nnp = of_find_compatible_node(NULL, NULL, "renesas,prr");\r\nif (np) {\r\nchipid = of_iomap(np, 0);\r\nof_node_put(np);\r\n} else if (soc->id) {\r\nchipid = ioremap(family->reg, 4);\r\n}\r\nif (chipid) {\r\nproduct = readl(chipid);\r\niounmap(chipid);\r\nif (soc->id && ((product >> 8) & 0xff) != soc->id) {\r\npr_warn("SoC mismatch (product = 0x%x)\n", product);\r\nreturn -ENODEV;\r\n}\r\n}\r\nsoc_dev_attr = kzalloc(sizeof(*soc_dev_attr), GFP_KERNEL);\r\nif (!soc_dev_attr)\r\nreturn -ENOMEM;\r\nnp = of_find_node_by_path("/");\r\nof_property_read_string(np, "model", &soc_dev_attr->machine);\r\nof_node_put(np);\r\nsoc_dev_attr->family = kstrdup_const(family->name, GFP_KERNEL);\r\nsoc_dev_attr->soc_id = kstrdup_const(strchr(match->compatible, ',') + 1,\r\nGFP_KERNEL);\r\nif (chipid)\r\nsoc_dev_attr->revision = kasprintf(GFP_KERNEL, "ES%u.%u",\r\n((product >> 4) & 0x0f) + 1,\r\nproduct & 0xf);\r\npr_info("Detected Renesas %s %s %s\n", soc_dev_attr->family,\r\nsoc_dev_attr->soc_id, soc_dev_attr->revision ?: "");\r\nsoc_dev = soc_device_register(soc_dev_attr);\r\nif (IS_ERR(soc_dev)) {\r\nkfree(soc_dev_attr->revision);\r\nkfree_const(soc_dev_attr->soc_id);\r\nkfree_const(soc_dev_attr->family);\r\nkfree(soc_dev_attr);\r\nreturn PTR_ERR(soc_dev);\r\n}\r\nreturn 0;\r\n}

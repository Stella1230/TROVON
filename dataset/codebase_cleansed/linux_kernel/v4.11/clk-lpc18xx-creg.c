static int clk_creg_32k_prepare(struct clk_hw *hw)\r\n{\r\nstruct clk_creg_data *creg = to_clk_creg(hw);\r\nint ret;\r\nret = regmap_update_bits(creg->reg, LPC18XX_CREG_CREG0,\r\nLPC18XX_CREG_CREG0_PD32KHZ |\r\nLPC18XX_CREG_CREG0_RESET32KHZ, 0);\r\nmsleep(2500);\r\nreturn ret;\r\n}\r\nstatic void clk_creg_32k_unprepare(struct clk_hw *hw)\r\n{\r\nstruct clk_creg_data *creg = to_clk_creg(hw);\r\nregmap_update_bits(creg->reg, LPC18XX_CREG_CREG0,\r\nLPC18XX_CREG_CREG0_PD32KHZ,\r\nLPC18XX_CREG_CREG0_PD32KHZ);\r\n}\r\nstatic int clk_creg_32k_is_prepared(struct clk_hw *hw)\r\n{\r\nstruct clk_creg_data *creg = to_clk_creg(hw);\r\nu32 reg;\r\nregmap_read(creg->reg, LPC18XX_CREG_CREG0, &reg);\r\nreturn !(reg & LPC18XX_CREG_CREG0_PD32KHZ) &&\r\n!(reg & LPC18XX_CREG_CREG0_RESET32KHZ);\r\n}\r\nstatic unsigned long clk_creg_1k_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nreturn parent_rate / 32;\r\n}\r\nstatic int clk_creg_enable(struct clk_hw *hw)\r\n{\r\nstruct clk_creg_data *creg = to_clk_creg(hw);\r\nreturn regmap_update_bits(creg->reg, LPC18XX_CREG_CREG0,\r\ncreg->en_mask, creg->en_mask);\r\n}\r\nstatic void clk_creg_disable(struct clk_hw *hw)\r\n{\r\nstruct clk_creg_data *creg = to_clk_creg(hw);\r\nregmap_update_bits(creg->reg, LPC18XX_CREG_CREG0,\r\ncreg->en_mask, 0);\r\n}\r\nstatic int clk_creg_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct clk_creg_data *creg = to_clk_creg(hw);\r\nu32 reg;\r\nregmap_read(creg->reg, LPC18XX_CREG_CREG0, &reg);\r\nreturn !!(reg & creg->en_mask);\r\n}\r\nstatic struct clk *clk_register_creg_clk(struct device *dev,\r\nstruct clk_creg_data *creg_clk,\r\nconst char **parent_name,\r\nstruct regmap *syscon)\r\n{\r\nstruct clk_init_data init;\r\ninit.ops = creg_clk->ops;\r\ninit.name = creg_clk->name;\r\ninit.parent_names = parent_name;\r\ninit.num_parents = 1;\r\ninit.flags = 0;\r\ncreg_clk->reg = syscon;\r\ncreg_clk->hw.init = &init;\r\nif (dev)\r\nreturn devm_clk_register(dev, &creg_clk->hw);\r\nreturn clk_register(NULL, &creg_clk->hw);\r\n}\r\nstatic void __init lpc18xx_creg_clk_init(struct device_node *np)\r\n{\r\nconst char *clk_32khz_parent;\r\nstruct regmap *syscon;\r\nsyscon = syscon_node_to_regmap(np->parent);\r\nif (IS_ERR(syscon)) {\r\npr_err("%s: syscon lookup failed\n", __func__);\r\nreturn;\r\n}\r\nclk_32khz_parent = of_clk_get_parent_name(np, 0);\r\nclk_creg_early[CREG_CLK_32KHZ] =\r\nclk_register_creg_clk(NULL, &clk_creg_clocks[CREG_CLK_32KHZ],\r\n&clk_32khz_parent, syscon);\r\nclk_creg_early[CREG_CLK_1KHZ] = ERR_PTR(-EPROBE_DEFER);\r\nof_clk_add_provider(np, of_clk_src_onecell_get, &clk_creg_early_data);\r\n}\r\nstatic int lpc18xx_creg_clk_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct regmap *syscon;\r\nsyscon = syscon_node_to_regmap(np->parent);\r\nif (IS_ERR(syscon)) {\r\ndev_err(&pdev->dev, "syscon lookup failed\n");\r\nreturn PTR_ERR(syscon);\r\n}\r\nclk_creg[CREG_CLK_32KHZ] = clk_creg_early[CREG_CLK_32KHZ];\r\nclk_creg[CREG_CLK_1KHZ] =\r\nclk_register_creg_clk(NULL, &clk_creg_clocks[CREG_CLK_1KHZ],\r\n&clk_creg_clocks[CREG_CLK_32KHZ].name,\r\nsyscon);\r\nreturn of_clk_add_provider(np, of_clk_src_onecell_get, &clk_creg_data);\r\n}

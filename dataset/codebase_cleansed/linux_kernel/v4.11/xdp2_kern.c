static void swap_src_dst_mac(void *data)\r\n{\r\nunsigned short *p = data;\r\nunsigned short dst[3];\r\ndst[0] = p[0];\r\ndst[1] = p[1];\r\ndst[2] = p[2];\r\np[0] = p[3];\r\np[1] = p[4];\r\np[2] = p[5];\r\np[3] = dst[0];\r\np[4] = dst[1];\r\np[5] = dst[2];\r\n}\r\nstatic int parse_ipv4(void *data, u64 nh_off, void *data_end)\r\n{\r\nstruct iphdr *iph = data + nh_off;\r\nif (iph + 1 > data_end)\r\nreturn 0;\r\nreturn iph->protocol;\r\n}\r\nstatic int parse_ipv6(void *data, u64 nh_off, void *data_end)\r\n{\r\nstruct ipv6hdr *ip6h = data + nh_off;\r\nif (ip6h + 1 > data_end)\r\nreturn 0;\r\nreturn ip6h->nexthdr;\r\n}\r\nint xdp_prog1(struct xdp_md *ctx)\r\n{\r\nvoid *data_end = (void *)(long)ctx->data_end;\r\nvoid *data = (void *)(long)ctx->data;\r\nstruct ethhdr *eth = data;\r\nint rc = XDP_DROP;\r\nlong *value;\r\nu16 h_proto;\r\nu64 nh_off;\r\nu32 ipproto;\r\nnh_off = sizeof(*eth);\r\nif (data + nh_off > data_end)\r\nreturn rc;\r\nh_proto = eth->h_proto;\r\nif (h_proto == htons(ETH_P_8021Q) || h_proto == htons(ETH_P_8021AD)) {\r\nstruct vlan_hdr *vhdr;\r\nvhdr = data + nh_off;\r\nnh_off += sizeof(struct vlan_hdr);\r\nif (data + nh_off > data_end)\r\nreturn rc;\r\nh_proto = vhdr->h_vlan_encapsulated_proto;\r\n}\r\nif (h_proto == htons(ETH_P_8021Q) || h_proto == htons(ETH_P_8021AD)) {\r\nstruct vlan_hdr *vhdr;\r\nvhdr = data + nh_off;\r\nnh_off += sizeof(struct vlan_hdr);\r\nif (data + nh_off > data_end)\r\nreturn rc;\r\nh_proto = vhdr->h_vlan_encapsulated_proto;\r\n}\r\nif (h_proto == htons(ETH_P_IP))\r\nipproto = parse_ipv4(data, nh_off, data_end);\r\nelse if (h_proto == htons(ETH_P_IPV6))\r\nipproto = parse_ipv6(data, nh_off, data_end);\r\nelse\r\nipproto = 0;\r\nvalue = bpf_map_lookup_elem(&rxcnt, &ipproto);\r\nif (value)\r\n*value += 1;\r\nif (ipproto == IPPROTO_UDP) {\r\nswap_src_dst_mac(data);\r\nrc = XDP_TX;\r\n}\r\nreturn rc;\r\n}

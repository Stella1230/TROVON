static char *state2str(unsigned short state)\r\n{\r\nswitch (state) {\r\ncase CAPI_CTR_DETECTED: return "detected";\r\ncase CAPI_CTR_LOADING: return "loading";\r\ncase CAPI_CTR_RUNNING: return "running";\r\ndefault: return "???";\r\n}\r\n}\r\nstatic void *controller_start(struct seq_file *seq, loff_t *pos)\r\n__acquires(capi_controller_lock)\r\n{\r\nmutex_lock(&capi_controller_lock);\r\nif (*pos < CAPI_MAXCONTR)\r\nreturn &capi_controller[*pos];\r\nreturn NULL;\r\n}\r\nstatic void *controller_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\n++*pos;\r\nif (*pos < CAPI_MAXCONTR)\r\nreturn &capi_controller[*pos];\r\nreturn NULL;\r\n}\r\nstatic void controller_stop(struct seq_file *seq, void *v)\r\n__releases(capi_controller_lock)\r\n{\r\nmutex_unlock(&capi_controller_lock);\r\n}\r\nstatic int controller_show(struct seq_file *seq, void *v)\r\n{\r\nstruct capi_ctr *ctr = *(struct capi_ctr **) v;\r\nif (!ctr)\r\nreturn 0;\r\nseq_printf(seq, "%d %-10s %-8s %-16s %s\n",\r\nctr->cnr, ctr->driver_name,\r\nstate2str(ctr->state),\r\nctr->name,\r\nctr->procinfo ? ctr->procinfo(ctr) : "");\r\nreturn 0;\r\n}\r\nstatic int contrstats_show(struct seq_file *seq, void *v)\r\n{\r\nstruct capi_ctr *ctr = *(struct capi_ctr **) v;\r\nif (!ctr)\r\nreturn 0;\r\nseq_printf(seq, "%d %lu %lu %lu %lu\n",\r\nctr->cnr,\r\nctr->nrecvctlpkt,\r\nctr->nrecvdatapkt,\r\nctr->nsentctlpkt,\r\nctr->nsentdatapkt);\r\nreturn 0;\r\n}\r\nstatic int seq_controller_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &seq_controller_ops);\r\n}\r\nstatic int seq_contrstats_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &seq_contrstats_ops);\r\n}\r\nstatic void *applications_start(struct seq_file *seq, loff_t *pos)\r\n__acquires(capi_controller_lock)\r\n{\r\nmutex_lock(&capi_controller_lock);\r\nif (*pos < CAPI_MAXAPPL)\r\nreturn &capi_applications[*pos];\r\nreturn NULL;\r\n}\r\nstatic void *\r\napplications_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\n++*pos;\r\nif (*pos < CAPI_MAXAPPL)\r\nreturn &capi_applications[*pos];\r\nreturn NULL;\r\n}\r\nstatic void applications_stop(struct seq_file *seq, void *v)\r\n__releases(capi_controller_lock)\r\n{\r\nmutex_unlock(&capi_controller_lock);\r\n}\r\nstatic int\r\napplications_show(struct seq_file *seq, void *v)\r\n{\r\nstruct capi20_appl *ap = *(struct capi20_appl **) v;\r\nif (!ap)\r\nreturn 0;\r\nseq_printf(seq, "%u %d %d %d\n",\r\nap->applid,\r\nap->rparam.level3cnt,\r\nap->rparam.datablkcnt,\r\nap->rparam.datablklen);\r\nreturn 0;\r\n}\r\nstatic int\r\napplstats_show(struct seq_file *seq, void *v)\r\n{\r\nstruct capi20_appl *ap = *(struct capi20_appl **) v;\r\nif (!ap)\r\nreturn 0;\r\nseq_printf(seq, "%u %lu %lu %lu %lu\n",\r\nap->applid,\r\nap->nrecvctlpkt,\r\nap->nrecvdatapkt,\r\nap->nsentctlpkt,\r\nap->nsentdatapkt);\r\nreturn 0;\r\n}\r\nstatic int\r\nseq_applications_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &seq_applications_ops);\r\n}\r\nstatic int\r\nseq_applstats_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &seq_applstats_ops);\r\n}\r\nstatic void *capi_driver_start(struct seq_file *seq, loff_t *pos)\r\n__acquires(&capi_drivers_lock\r\nstatic void *capi_driver_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nreturn seq_list_next(v, &capi_drivers, pos);\r\n}\r\nstatic void capi_driver_stop(struct seq_file *seq, void *v)\r\n__releases(&capi_drivers_lock\r\nstatic int capi_driver_show(struct seq_file *seq, void *v)\r\n{\r\nstruct capi_driver *drv = list_entry(v, struct capi_driver, list);\r\nseq_printf(seq, "%-32s %s\n", drv->name, drv->revision);\r\nreturn 0;\r\n}\r\nstatic int\r\nseq_capi_driver_open(struct inode *inode, struct file *file)\r\n{\r\nint err;\r\nerr = seq_open(file, &seq_capi_driver_ops);\r\nreturn err;\r\n}\r\nvoid __init\r\nkcapi_proc_init(void)\r\n{\r\nproc_mkdir("capi", NULL);\r\nproc_mkdir("capi/controllers", NULL);\r\nproc_create("capi/controller", 0, NULL, &proc_controller_ops);\r\nproc_create("capi/contrstats", 0, NULL, &proc_contrstats_ops);\r\nproc_create("capi/applications", 0, NULL, &proc_applications_ops);\r\nproc_create("capi/applstats", 0, NULL, &proc_applstats_ops);\r\nproc_create("capi/driver", 0, NULL, &proc_driver_ops);\r\n}\r\nvoid __exit\r\nkcapi_proc_exit(void)\r\n{\r\nremove_proc_entry("capi/driver", NULL);\r\nremove_proc_entry("capi/controller", NULL);\r\nremove_proc_entry("capi/contrstats", NULL);\r\nremove_proc_entry("capi/applications", NULL);\r\nremove_proc_entry("capi/applstats", NULL);\r\nremove_proc_entry("capi/controllers", NULL);\r\nremove_proc_entry("capi", NULL);\r\n}

static struct xgbe_version_data *xgbe_acpi_vdata(struct xgbe_prv_data *pdata)\r\n{\r\nconst struct acpi_device_id *id;\r\nid = acpi_match_device(xgbe_acpi_match, pdata->dev);\r\nreturn id ? (struct xgbe_version_data *)id->driver_data : NULL;\r\n}\r\nstatic int xgbe_acpi_support(struct xgbe_prv_data *pdata)\r\n{\r\nstruct device *dev = pdata->dev;\r\nu32 property;\r\nint ret;\r\nret = device_property_read_u32(dev, XGBE_ACPI_DMA_FREQ, &property);\r\nif (ret) {\r\ndev_err(dev, "unable to obtain %s property\n",\r\nXGBE_ACPI_DMA_FREQ);\r\nreturn ret;\r\n}\r\npdata->sysclk_rate = property;\r\nret = device_property_read_u32(dev, XGBE_ACPI_PTP_FREQ, &property);\r\nif (ret) {\r\ndev_err(dev, "unable to obtain %s property\n",\r\nXGBE_ACPI_PTP_FREQ);\r\nreturn ret;\r\n}\r\npdata->ptpclk_rate = property;\r\nreturn 0;\r\n}\r\nstatic struct xgbe_version_data *xgbe_acpi_vdata(struct xgbe_prv_data *pdata)\r\n{\r\nreturn NULL;\r\n}\r\nstatic int xgbe_acpi_support(struct xgbe_prv_data *pdata)\r\n{\r\nreturn -EINVAL;\r\n}\r\nstatic struct xgbe_version_data *xgbe_of_vdata(struct xgbe_prv_data *pdata)\r\n{\r\nconst struct of_device_id *id;\r\nid = of_match_device(xgbe_of_match, pdata->dev);\r\nreturn id ? (struct xgbe_version_data *)id->data : NULL;\r\n}\r\nstatic int xgbe_of_support(struct xgbe_prv_data *pdata)\r\n{\r\nstruct device *dev = pdata->dev;\r\npdata->sysclk = devm_clk_get(dev, XGBE_DMA_CLOCK);\r\nif (IS_ERR(pdata->sysclk)) {\r\ndev_err(dev, "dma devm_clk_get failed\n");\r\nreturn PTR_ERR(pdata->sysclk);\r\n}\r\npdata->sysclk_rate = clk_get_rate(pdata->sysclk);\r\npdata->ptpclk = devm_clk_get(dev, XGBE_PTP_CLOCK);\r\nif (IS_ERR(pdata->ptpclk)) {\r\ndev_err(dev, "ptp devm_clk_get failed\n");\r\nreturn PTR_ERR(pdata->ptpclk);\r\n}\r\npdata->ptpclk_rate = clk_get_rate(pdata->ptpclk);\r\nreturn 0;\r\n}\r\nstatic struct platform_device *xgbe_of_get_phy_pdev(struct xgbe_prv_data *pdata)\r\n{\r\nstruct device *dev = pdata->dev;\r\nstruct device_node *phy_node;\r\nstruct platform_device *phy_pdev;\r\nphy_node = of_parse_phandle(dev->of_node, "phy-handle", 0);\r\nif (phy_node) {\r\nphy_pdev = of_find_device_by_node(phy_node);\r\nof_node_put(phy_node);\r\n} else {\r\nget_device(dev);\r\nphy_pdev = pdata->platdev;\r\n}\r\nreturn phy_pdev;\r\n}\r\nstatic struct xgbe_version_data *xgbe_of_vdata(struct xgbe_prv_data *pdata)\r\n{\r\nreturn NULL;\r\n}\r\nstatic int xgbe_of_support(struct xgbe_prv_data *pdata)\r\n{\r\nreturn -EINVAL;\r\n}\r\nstatic struct platform_device *xgbe_of_get_phy_pdev(struct xgbe_prv_data *pdata)\r\n{\r\nreturn NULL;\r\n}\r\nstatic unsigned int xgbe_resource_count(struct platform_device *pdev,\r\nunsigned int type)\r\n{\r\nunsigned int count;\r\nint i;\r\nfor (i = 0, count = 0; i < pdev->num_resources; i++) {\r\nstruct resource *res = &pdev->resource[i];\r\nif (type == resource_type(res))\r\ncount++;\r\n}\r\nreturn count;\r\n}\r\nstatic struct platform_device *xgbe_get_phy_pdev(struct xgbe_prv_data *pdata)\r\n{\r\nstruct platform_device *phy_pdev;\r\nif (pdata->use_acpi) {\r\nget_device(pdata->dev);\r\nphy_pdev = pdata->platdev;\r\n} else {\r\nphy_pdev = xgbe_of_get_phy_pdev(pdata);\r\n}\r\nreturn phy_pdev;\r\n}\r\nstatic struct xgbe_version_data *xgbe_get_vdata(struct xgbe_prv_data *pdata)\r\n{\r\nreturn pdata->use_acpi ? xgbe_acpi_vdata(pdata)\r\n: xgbe_of_vdata(pdata);\r\n}\r\nstatic int xgbe_platform_probe(struct platform_device *pdev)\r\n{\r\nstruct xgbe_prv_data *pdata;\r\nstruct device *dev = &pdev->dev;\r\nstruct platform_device *phy_pdev;\r\nstruct resource *res;\r\nconst char *phy_mode;\r\nunsigned int phy_memnum, phy_irqnum;\r\nunsigned int dma_irqnum, dma_irqend;\r\nenum dev_dma_attr attr;\r\nint ret;\r\npdata = xgbe_alloc_pdata(dev);\r\nif (IS_ERR(pdata)) {\r\nret = PTR_ERR(pdata);\r\ngoto err_alloc;\r\n}\r\npdata->platdev = pdev;\r\npdata->adev = ACPI_COMPANION(dev);\r\nplatform_set_drvdata(pdev, pdata);\r\npdata->use_acpi = dev->of_node ? 0 : 1;\r\npdata->vdata = xgbe_get_vdata(pdata);\r\nphy_pdev = xgbe_get_phy_pdev(pdata);\r\nif (!phy_pdev) {\r\ndev_err(dev, "unable to obtain phy device\n");\r\nret = -EINVAL;\r\ngoto err_phydev;\r\n}\r\npdata->phy_platdev = phy_pdev;\r\npdata->phy_dev = &phy_pdev->dev;\r\nif (pdev == phy_pdev) {\r\nphy_memnum = xgbe_resource_count(pdev, IORESOURCE_MEM) - 3;\r\nphy_irqnum = xgbe_resource_count(pdev, IORESOURCE_IRQ) - 1;\r\ndma_irqnum = 1;\r\ndma_irqend = phy_irqnum;\r\n} else {\r\nphy_memnum = 0;\r\nphy_irqnum = 0;\r\ndma_irqnum = 1;\r\ndma_irqend = xgbe_resource_count(pdev, IORESOURCE_IRQ);\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npdata->xgmac_regs = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(pdata->xgmac_regs)) {\r\ndev_err(dev, "xgmac ioremap failed\n");\r\nret = PTR_ERR(pdata->xgmac_regs);\r\ngoto err_io;\r\n}\r\nif (netif_msg_probe(pdata))\r\ndev_dbg(dev, "xgmac_regs = %p\n", pdata->xgmac_regs);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\npdata->xpcs_regs = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(pdata->xpcs_regs)) {\r\ndev_err(dev, "xpcs ioremap failed\n");\r\nret = PTR_ERR(pdata->xpcs_regs);\r\ngoto err_io;\r\n}\r\nif (netif_msg_probe(pdata))\r\ndev_dbg(dev, "xpcs_regs = %p\n", pdata->xpcs_regs);\r\nres = platform_get_resource(phy_pdev, IORESOURCE_MEM, phy_memnum++);\r\npdata->rxtx_regs = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(pdata->rxtx_regs)) {\r\ndev_err(dev, "rxtx ioremap failed\n");\r\nret = PTR_ERR(pdata->rxtx_regs);\r\ngoto err_io;\r\n}\r\nif (netif_msg_probe(pdata))\r\ndev_dbg(dev, "rxtx_regs = %p\n", pdata->rxtx_regs);\r\nres = platform_get_resource(phy_pdev, IORESOURCE_MEM, phy_memnum++);\r\npdata->sir0_regs = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(pdata->sir0_regs)) {\r\ndev_err(dev, "sir0 ioremap failed\n");\r\nret = PTR_ERR(pdata->sir0_regs);\r\ngoto err_io;\r\n}\r\nif (netif_msg_probe(pdata))\r\ndev_dbg(dev, "sir0_regs = %p\n", pdata->sir0_regs);\r\nres = platform_get_resource(phy_pdev, IORESOURCE_MEM, phy_memnum++);\r\npdata->sir1_regs = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(pdata->sir1_regs)) {\r\ndev_err(dev, "sir1 ioremap failed\n");\r\nret = PTR_ERR(pdata->sir1_regs);\r\ngoto err_io;\r\n}\r\nif (netif_msg_probe(pdata))\r\ndev_dbg(dev, "sir1_regs = %p\n", pdata->sir1_regs);\r\nret = device_property_read_u8_array(dev, XGBE_MAC_ADDR_PROPERTY,\r\npdata->mac_addr,\r\nsizeof(pdata->mac_addr));\r\nif (ret || !is_valid_ether_addr(pdata->mac_addr)) {\r\ndev_err(dev, "invalid %s property\n", XGBE_MAC_ADDR_PROPERTY);\r\nif (!ret)\r\nret = -EINVAL;\r\ngoto err_io;\r\n}\r\nret = device_property_read_string(dev, XGBE_PHY_MODE_PROPERTY,\r\n&phy_mode);\r\nif (ret || strcmp(phy_mode, phy_modes(PHY_INTERFACE_MODE_XGMII))) {\r\ndev_err(dev, "invalid %s property\n", XGBE_PHY_MODE_PROPERTY);\r\nif (!ret)\r\nret = -EINVAL;\r\ngoto err_io;\r\n}\r\npdata->phy_mode = PHY_INTERFACE_MODE_XGMII;\r\nif (device_property_present(dev, XGBE_DMA_IRQS_PROPERTY)) {\r\npdata->per_channel_irq = 1;\r\npdata->channel_irq_mode = XGBE_IRQ_MODE_EDGE;\r\n}\r\nif (pdata->use_acpi)\r\nret = xgbe_acpi_support(pdata);\r\nelse\r\nret = xgbe_of_support(pdata);\r\nif (ret)\r\ngoto err_io;\r\nattr = device_get_dma_attr(dev);\r\nif (attr == DEV_DMA_NOT_SUPPORTED) {\r\ndev_err(dev, "DMA is not supported");\r\nret = -ENODEV;\r\ngoto err_io;\r\n}\r\npdata->coherent = (attr == DEV_DMA_COHERENT);\r\nif (pdata->coherent) {\r\npdata->axdomain = XGBE_DMA_OS_AXDOMAIN;\r\npdata->arcache = XGBE_DMA_OS_ARCACHE;\r\npdata->awcache = XGBE_DMA_OS_AWCACHE;\r\n} else {\r\npdata->axdomain = XGBE_DMA_SYS_AXDOMAIN;\r\npdata->arcache = XGBE_DMA_SYS_ARCACHE;\r\npdata->awcache = XGBE_DMA_SYS_AWCACHE;\r\n}\r\npdata->tx_max_fifo_size = pdata->vdata->tx_max_fifo_size;\r\npdata->rx_max_fifo_size = pdata->vdata->rx_max_fifo_size;\r\nxgbe_set_counts(pdata);\r\npdata->irq_count = 2;\r\nret = platform_get_irq(pdev, 0);\r\nif (ret < 0) {\r\ndev_err(dev, "platform_get_irq 0 failed\n");\r\ngoto err_io;\r\n}\r\npdata->dev_irq = ret;\r\nif (pdata->per_channel_irq) {\r\nunsigned int i, max = ARRAY_SIZE(pdata->channel_irq);\r\nfor (i = 0; (i < max) && (dma_irqnum < dma_irqend); i++) {\r\nret = platform_get_irq(pdata->platdev, dma_irqnum++);\r\nif (ret < 0) {\r\nnetdev_err(pdata->netdev,\r\n"platform_get_irq %u failed\n",\r\ndma_irqnum - 1);\r\ngoto err_io;\r\n}\r\npdata->channel_irq[i] = ret;\r\n}\r\npdata->channel_irq_count = max;\r\npdata->irq_count += max;\r\n}\r\nret = platform_get_irq(phy_pdev, phy_irqnum++);\r\nif (ret < 0) {\r\ndev_err(dev, "platform_get_irq phy 0 failed\n");\r\ngoto err_io;\r\n}\r\npdata->an_irq = ret;\r\nret = xgbe_config_netdev(pdata);\r\nif (ret)\r\ngoto err_io;\r\nnetdev_notice(pdata->netdev, "net device enabled\n");\r\nreturn 0;\r\nerr_io:\r\nplatform_device_put(phy_pdev);\r\nerr_phydev:\r\nxgbe_free_pdata(pdata);\r\nerr_alloc:\r\ndev_notice(dev, "net device not enabled\n");\r\nreturn ret;\r\n}\r\nstatic int xgbe_platform_remove(struct platform_device *pdev)\r\n{\r\nstruct xgbe_prv_data *pdata = platform_get_drvdata(pdev);\r\nxgbe_deconfig_netdev(pdata);\r\nplatform_device_put(pdata->phy_platdev);\r\nxgbe_free_pdata(pdata);\r\nreturn 0;\r\n}\r\nstatic int xgbe_platform_suspend(struct device *dev)\r\n{\r\nstruct xgbe_prv_data *pdata = dev_get_drvdata(dev);\r\nstruct net_device *netdev = pdata->netdev;\r\nint ret = 0;\r\nDBGPR("-->xgbe_suspend\n");\r\nif (netif_running(netdev))\r\nret = xgbe_powerdown(netdev, XGMAC_DRIVER_CONTEXT);\r\npdata->lpm_ctrl = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_CTRL1);\r\npdata->lpm_ctrl |= MDIO_CTRL1_LPOWER;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PCS, MDIO_CTRL1, pdata->lpm_ctrl);\r\nDBGPR("<--xgbe_suspend\n");\r\nreturn ret;\r\n}\r\nstatic int xgbe_platform_resume(struct device *dev)\r\n{\r\nstruct xgbe_prv_data *pdata = dev_get_drvdata(dev);\r\nstruct net_device *netdev = pdata->netdev;\r\nint ret = 0;\r\nDBGPR("-->xgbe_resume\n");\r\npdata->lpm_ctrl &= ~MDIO_CTRL1_LPOWER;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PCS, MDIO_CTRL1, pdata->lpm_ctrl);\r\nif (netif_running(netdev)) {\r\nret = xgbe_powerup(netdev, XGMAC_DRIVER_CONTEXT);\r\nschedule_work(&pdata->restart_work);\r\n}\r\nDBGPR("<--xgbe_resume\n");\r\nreturn ret;\r\n}\r\nint xgbe_platform_init(void)\r\n{\r\nreturn platform_driver_register(&xgbe_driver);\r\n}\r\nvoid xgbe_platform_exit(void)\r\n{\r\nplatform_driver_unregister(&xgbe_driver);\r\n}

static void mmio_event_get_key(struct perf_evsel *evsel, struct perf_sample *sample,\r\nstruct event_key *key)\r\n{\r\nkey->key = perf_evsel__intval(evsel, sample, "gpa");\r\nkey->info = perf_evsel__intval(evsel, sample, "type");\r\n}\r\nstatic bool mmio_event_begin(struct perf_evsel *evsel,\r\nstruct perf_sample *sample, struct event_key *key)\r\n{\r\nif (kvm_exit_event(evsel))\r\nreturn true;\r\nif (!strcmp(evsel->name, "kvm:kvm_mmio") &&\r\nperf_evsel__intval(evsel, sample, "type") == KVM_TRACE_MMIO_WRITE) {\r\nmmio_event_get_key(evsel, sample, key);\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool mmio_event_end(struct perf_evsel *evsel, struct perf_sample *sample,\r\nstruct event_key *key)\r\n{\r\nif (kvm_entry_event(evsel))\r\nreturn true;\r\nif (!strcmp(evsel->name, "kvm:kvm_mmio") &&\r\nperf_evsel__intval(evsel, sample, "type") == KVM_TRACE_MMIO_READ) {\r\nmmio_event_get_key(evsel, sample, key);\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic void mmio_event_decode_key(struct perf_kvm_stat *kvm __maybe_unused,\r\nstruct event_key *key,\r\nchar *decode)\r\n{\r\nscnprintf(decode, decode_str_len, "%#lx:%s",\r\n(unsigned long)key->key,\r\nkey->info == KVM_TRACE_MMIO_WRITE ? "W" : "R");\r\n}\r\nstatic void ioport_event_get_key(struct perf_evsel *evsel,\r\nstruct perf_sample *sample,\r\nstruct event_key *key)\r\n{\r\nkey->key = perf_evsel__intval(evsel, sample, "port");\r\nkey->info = perf_evsel__intval(evsel, sample, "rw");\r\n}\r\nstatic bool ioport_event_begin(struct perf_evsel *evsel,\r\nstruct perf_sample *sample,\r\nstruct event_key *key)\r\n{\r\nif (!strcmp(evsel->name, "kvm:kvm_pio")) {\r\nioport_event_get_key(evsel, sample, key);\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool ioport_event_end(struct perf_evsel *evsel,\r\nstruct perf_sample *sample __maybe_unused,\r\nstruct event_key *key __maybe_unused)\r\n{\r\nreturn kvm_entry_event(evsel);\r\n}\r\nstatic void ioport_event_decode_key(struct perf_kvm_stat *kvm __maybe_unused,\r\nstruct event_key *key,\r\nchar *decode)\r\n{\r\nscnprintf(decode, decode_str_len, "%#llx:%s",\r\n(unsigned long long)key->key,\r\nkey->info ? "POUT" : "PIN");\r\n}\r\nint cpu_isa_init(struct perf_kvm_stat *kvm, const char *cpuid)\r\n{\r\nif (strstr(cpuid, "Intel")) {\r\nkvm->exit_reasons = vmx_exit_reasons;\r\nkvm->exit_reasons_isa = "VMX";\r\n} else if (strstr(cpuid, "AMD")) {\r\nkvm->exit_reasons = svm_exit_reasons;\r\nkvm->exit_reasons_isa = "SVM";\r\n} else\r\nreturn -ENOTSUP;\r\nreturn 0;\r\n}

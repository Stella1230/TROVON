static void sa1100_mask_irq(struct irq_data *d)\r\n{\r\nu32 reg;\r\nreg = readl_relaxed(iobase + ICMR);\r\nreg &= ~BIT(d->hwirq);\r\nwritel_relaxed(reg, iobase + ICMR);\r\n}\r\nstatic void sa1100_unmask_irq(struct irq_data *d)\r\n{\r\nu32 reg;\r\nreg = readl_relaxed(iobase + ICMR);\r\nreg |= BIT(d->hwirq);\r\nwritel_relaxed(reg, iobase + ICMR);\r\n}\r\nstatic int sa1100_set_wake(struct irq_data *d, unsigned int on)\r\n{\r\nreturn sa11x0_sc_set_wake(d->hwirq, on);\r\n}\r\nstatic int sa1100_normal_irqdomain_map(struct irq_domain *d,\r\nunsigned int irq, irq_hw_number_t hwirq)\r\n{\r\nirq_set_chip_and_handler(irq, &sa1100_normal_chip,\r\nhandle_level_irq);\r\nreturn 0;\r\n}\r\nstatic int sa1100irq_suspend(void)\r\n{\r\nstruct sa1100irq_state *st = &sa1100irq_state;\r\nst->saved = 1;\r\nst->icmr = readl_relaxed(iobase + ICMR);\r\nst->iclr = readl_relaxed(iobase + ICLR);\r\nst->iccr = readl_relaxed(iobase + ICCR);\r\nwritel_relaxed(st->icmr & 0xfffff000, iobase + ICMR);\r\nreturn 0;\r\n}\r\nstatic void sa1100irq_resume(void)\r\n{\r\nstruct sa1100irq_state *st = &sa1100irq_state;\r\nif (st->saved) {\r\nwritel_relaxed(st->iccr, iobase + ICCR);\r\nwritel_relaxed(st->iclr, iobase + ICLR);\r\nwritel_relaxed(st->icmr, iobase + ICMR);\r\n}\r\n}\r\nstatic int __init sa1100irq_init_devicefs(void)\r\n{\r\nregister_syscore_ops(&sa1100irq_syscore_ops);\r\nreturn 0;\r\n}\r\nstatic asmlinkage void __exception_irq_entry\r\nsa1100_handle_irq(struct pt_regs *regs)\r\n{\r\nuint32_t icip, icmr, mask;\r\ndo {\r\nicip = readl_relaxed(iobase + ICIP);\r\nicmr = readl_relaxed(iobase + ICMR);\r\nmask = icip & icmr;\r\nif (mask == 0)\r\nbreak;\r\nhandle_domain_irq(sa1100_normal_irqdomain,\r\nffs(mask) - 1, regs);\r\n} while (1);\r\n}\r\nvoid __init sa11x0_init_irq_nodt(int irq_start, resource_size_t io_start)\r\n{\r\niobase = ioremap(io_start, SZ_64K);\r\nif (WARN_ON(!iobase))\r\nreturn;\r\nwritel_relaxed(0, iobase + ICMR);\r\nwritel_relaxed(0, iobase + ICLR);\r\nwritel_relaxed(1, iobase + ICCR);\r\nsa1100_normal_irqdomain = irq_domain_add_simple(NULL,\r\n32, irq_start,\r\n&sa1100_normal_irqdomain_ops, NULL);\r\nset_handle_irq(sa1100_handle_irq);\r\n}

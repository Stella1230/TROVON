unsigned long unwind_get_return_address(struct unwind_state *state)\r\n{\r\nunsigned long addr;\r\nif (unwind_done(state))\r\nreturn 0;\r\naddr = READ_ONCE_NOCHECK(*state->sp);\r\nreturn ftrace_graph_ret_addr(state->task, &state->graph_idx,\r\naddr, state->sp);\r\n}\r\nbool unwind_next_frame(struct unwind_state *state)\r\n{\r\nstruct stack_info *info = &state->stack_info;\r\nif (unwind_done(state))\r\nreturn false;\r\ndo {\r\nfor (state->sp++; state->sp < info->end; state->sp++) {\r\nunsigned long addr = READ_ONCE_NOCHECK(*state->sp);\r\nif (__kernel_text_address(addr))\r\nreturn true;\r\n}\r\nstate->sp = info->next_sp;\r\n} while (!get_stack_info(state->sp, state->task, info,\r\n&state->stack_mask));\r\nreturn false;\r\n}\r\nvoid __unwind_start(struct unwind_state *state, struct task_struct *task,\r\nstruct pt_regs *regs, unsigned long *first_frame)\r\n{\r\nmemset(state, 0, sizeof(*state));\r\nstate->task = task;\r\nstate->sp = first_frame;\r\nget_stack_info(first_frame, state->task, &state->stack_info,\r\n&state->stack_mask);\r\nif (!unwind_done(state) &&\r\n(!on_stack(&state->stack_info, first_frame, sizeof(long)) ||\r\n!__kernel_text_address(*first_frame)))\r\nunwind_next_frame(state);\r\n}

static int int340x_thermal_get_zone_temp(struct thermal_zone_device *zone,\r\nint *temp)\r\n{\r\nstruct int34x_thermal_zone *d = zone->devdata;\r\nunsigned long long tmp;\r\nacpi_status status;\r\nif (d->override_ops && d->override_ops->get_temp)\r\nreturn d->override_ops->get_temp(zone, temp);\r\nstatus = acpi_evaluate_integer(d->adev->handle, "_TMP", NULL, &tmp);\r\nif (ACPI_FAILURE(status))\r\nreturn -EIO;\r\nif (d->lpat_table) {\r\nint conv_temp;\r\nconv_temp = acpi_lpat_raw_to_temp(d->lpat_table, (int)tmp);\r\nif (conv_temp < 0)\r\nreturn conv_temp;\r\n*temp = (unsigned long)conv_temp * 10;\r\n} else\r\n*temp = DECI_KELVIN_TO_MILLICELSIUS(tmp);\r\nreturn 0;\r\n}\r\nstatic int int340x_thermal_get_trip_temp(struct thermal_zone_device *zone,\r\nint trip, int *temp)\r\n{\r\nstruct int34x_thermal_zone *d = zone->devdata;\r\nint i;\r\nif (d->override_ops && d->override_ops->get_trip_temp)\r\nreturn d->override_ops->get_trip_temp(zone, trip, temp);\r\nif (trip < d->aux_trip_nr)\r\n*temp = d->aux_trips[trip];\r\nelse if (trip == d->crt_trip_id)\r\n*temp = d->crt_temp;\r\nelse if (trip == d->psv_trip_id)\r\n*temp = d->psv_temp;\r\nelse if (trip == d->hot_trip_id)\r\n*temp = d->hot_temp;\r\nelse {\r\nfor (i = 0; i < INT340X_THERMAL_MAX_ACT_TRIP_COUNT; i++) {\r\nif (d->act_trips[i].valid &&\r\nd->act_trips[i].id == trip) {\r\n*temp = d->act_trips[i].temp;\r\nbreak;\r\n}\r\n}\r\nif (i == INT340X_THERMAL_MAX_ACT_TRIP_COUNT)\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int int340x_thermal_get_trip_type(struct thermal_zone_device *zone,\r\nint trip,\r\nenum thermal_trip_type *type)\r\n{\r\nstruct int34x_thermal_zone *d = zone->devdata;\r\nint i;\r\nif (d->override_ops && d->override_ops->get_trip_type)\r\nreturn d->override_ops->get_trip_type(zone, trip, type);\r\nif (trip < d->aux_trip_nr)\r\n*type = THERMAL_TRIP_PASSIVE;\r\nelse if (trip == d->crt_trip_id)\r\n*type = THERMAL_TRIP_CRITICAL;\r\nelse if (trip == d->hot_trip_id)\r\n*type = THERMAL_TRIP_HOT;\r\nelse if (trip == d->psv_trip_id)\r\n*type = THERMAL_TRIP_PASSIVE;\r\nelse {\r\nfor (i = 0; i < INT340X_THERMAL_MAX_ACT_TRIP_COUNT; i++) {\r\nif (d->act_trips[i].valid &&\r\nd->act_trips[i].id == trip) {\r\n*type = THERMAL_TRIP_ACTIVE;\r\nbreak;\r\n}\r\n}\r\nif (i == INT340X_THERMAL_MAX_ACT_TRIP_COUNT)\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int int340x_thermal_set_trip_temp(struct thermal_zone_device *zone,\r\nint trip, int temp)\r\n{\r\nstruct int34x_thermal_zone *d = zone->devdata;\r\nacpi_status status;\r\nchar name[10];\r\nif (d->override_ops && d->override_ops->set_trip_temp)\r\nreturn d->override_ops->set_trip_temp(zone, trip, temp);\r\nsnprintf(name, sizeof(name), "PAT%d", trip);\r\nstatus = acpi_execute_simple_method(d->adev->handle, name,\r\nMILLICELSIUS_TO_DECI_KELVIN(temp));\r\nif (ACPI_FAILURE(status))\r\nreturn -EIO;\r\nd->aux_trips[trip] = temp;\r\nreturn 0;\r\n}\r\nstatic int int340x_thermal_get_trip_hyst(struct thermal_zone_device *zone,\r\nint trip, int *temp)\r\n{\r\nstruct int34x_thermal_zone *d = zone->devdata;\r\nacpi_status status;\r\nunsigned long long hyst;\r\nif (d->override_ops && d->override_ops->get_trip_hyst)\r\nreturn d->override_ops->get_trip_hyst(zone, trip, temp);\r\nstatus = acpi_evaluate_integer(d->adev->handle, "GTSH", NULL, &hyst);\r\nif (ACPI_FAILURE(status))\r\nreturn -EIO;\r\n*temp = hyst * 100;\r\nreturn 0;\r\n}\r\nstatic int int340x_thermal_get_trip_config(acpi_handle handle, char *name,\r\nint *temp)\r\n{\r\nunsigned long long r;\r\nacpi_status status;\r\nstatus = acpi_evaluate_integer(handle, name, NULL, &r);\r\nif (ACPI_FAILURE(status))\r\nreturn -EIO;\r\n*temp = DECI_KELVIN_TO_MILLICELSIUS(r);\r\nreturn 0;\r\n}\r\nint int340x_thermal_read_trips(struct int34x_thermal_zone *int34x_zone)\r\n{\r\nint trip_cnt = int34x_zone->aux_trip_nr;\r\nint i;\r\nint34x_zone->crt_trip_id = -1;\r\nif (!int340x_thermal_get_trip_config(int34x_zone->adev->handle, "_CRT",\r\n&int34x_zone->crt_temp))\r\nint34x_zone->crt_trip_id = trip_cnt++;\r\nint34x_zone->hot_trip_id = -1;\r\nif (!int340x_thermal_get_trip_config(int34x_zone->adev->handle, "_HOT",\r\n&int34x_zone->hot_temp))\r\nint34x_zone->hot_trip_id = trip_cnt++;\r\nint34x_zone->psv_trip_id = -1;\r\nif (!int340x_thermal_get_trip_config(int34x_zone->adev->handle, "_PSV",\r\n&int34x_zone->psv_temp))\r\nint34x_zone->psv_trip_id = trip_cnt++;\r\nfor (i = 0; i < INT340X_THERMAL_MAX_ACT_TRIP_COUNT; i++) {\r\nchar name[5] = { '_', 'A', 'C', '0' + i, '\0' };\r\nif (int340x_thermal_get_trip_config(int34x_zone->adev->handle,\r\nname,\r\n&int34x_zone->act_trips[i].temp))\r\nbreak;\r\nint34x_zone->act_trips[i].id = trip_cnt++;\r\nint34x_zone->act_trips[i].valid = true;\r\n}\r\nreturn trip_cnt;\r\n}\r\nstruct int34x_thermal_zone *int340x_thermal_zone_add(struct acpi_device *adev,\r\nstruct thermal_zone_device_ops *override_ops)\r\n{\r\nstruct int34x_thermal_zone *int34x_thermal_zone;\r\nacpi_status status;\r\nunsigned long long trip_cnt;\r\nint trip_mask = 0;\r\nint ret;\r\nint34x_thermal_zone = kzalloc(sizeof(*int34x_thermal_zone),\r\nGFP_KERNEL);\r\nif (!int34x_thermal_zone)\r\nreturn ERR_PTR(-ENOMEM);\r\nint34x_thermal_zone->adev = adev;\r\nint34x_thermal_zone->override_ops = override_ops;\r\nstatus = acpi_evaluate_integer(adev->handle, "PATC", NULL, &trip_cnt);\r\nif (ACPI_FAILURE(status))\r\ntrip_cnt = 0;\r\nelse {\r\nint34x_thermal_zone->aux_trips = kzalloc(\r\nsizeof(*int34x_thermal_zone->aux_trips) *\r\ntrip_cnt, GFP_KERNEL);\r\nif (!int34x_thermal_zone->aux_trips) {\r\nret = -ENOMEM;\r\ngoto err_trip_alloc;\r\n}\r\ntrip_mask = BIT(trip_cnt) - 1;\r\nint34x_thermal_zone->aux_trip_nr = trip_cnt;\r\n}\r\ntrip_cnt = int340x_thermal_read_trips(int34x_thermal_zone);\r\nint34x_thermal_zone->lpat_table = acpi_lpat_get_conversion_table(\r\nadev->handle);\r\nint34x_thermal_zone->zone = thermal_zone_device_register(\r\nacpi_device_bid(adev),\r\ntrip_cnt,\r\ntrip_mask, int34x_thermal_zone,\r\n&int340x_thermal_zone_ops,\r\n&int340x_thermal_params,\r\n0, 0);\r\nif (IS_ERR(int34x_thermal_zone->zone)) {\r\nret = PTR_ERR(int34x_thermal_zone->zone);\r\ngoto err_thermal_zone;\r\n}\r\nreturn int34x_thermal_zone;\r\nerr_thermal_zone:\r\nacpi_lpat_free_conversion_table(int34x_thermal_zone->lpat_table);\r\nkfree(int34x_thermal_zone->aux_trips);\r\nerr_trip_alloc:\r\nkfree(int34x_thermal_zone);\r\nreturn ERR_PTR(ret);\r\n}\r\nvoid int340x_thermal_zone_remove(struct int34x_thermal_zone\r\n*int34x_thermal_zone)\r\n{\r\nthermal_zone_device_unregister(int34x_thermal_zone->zone);\r\nacpi_lpat_free_conversion_table(int34x_thermal_zone->lpat_table);\r\nkfree(int34x_thermal_zone->aux_trips);\r\nkfree(int34x_thermal_zone);\r\n}

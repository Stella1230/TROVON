static bool rt5677_volatile_register(struct device *dev, unsigned int reg)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(rt5677_ranges); i++) {\r\nif (reg >= rt5677_ranges[i].range_min &&\r\nreg <= rt5677_ranges[i].range_max) {\r\nreturn true;\r\n}\r\n}\r\nswitch (reg) {\r\ncase RT5677_RESET:\r\ncase RT5677_SLIMBUS_PARAM:\r\ncase RT5677_PDM_DATA_CTRL1:\r\ncase RT5677_PDM_DATA_CTRL2:\r\ncase RT5677_PDM1_DATA_CTRL4:\r\ncase RT5677_PDM2_DATA_CTRL4:\r\ncase RT5677_I2C_MASTER_CTRL1:\r\ncase RT5677_I2C_MASTER_CTRL7:\r\ncase RT5677_I2C_MASTER_CTRL8:\r\ncase RT5677_HAP_GENE_CTRL2:\r\ncase RT5677_PWR_DSP_ST:\r\ncase RT5677_PRIV_DATA:\r\ncase RT5677_ASRC_22:\r\ncase RT5677_ASRC_23:\r\ncase RT5677_VAD_CTRL5:\r\ncase RT5677_ADC_EQ_CTRL1:\r\ncase RT5677_EQ_CTRL1:\r\ncase RT5677_IRQ_CTRL1:\r\ncase RT5677_IRQ_CTRL2:\r\ncase RT5677_GPIO_ST:\r\ncase RT5677_DSP_INB1_SRC_CTRL4:\r\ncase RT5677_DSP_INB2_SRC_CTRL4:\r\ncase RT5677_DSP_INB3_SRC_CTRL4:\r\ncase RT5677_DSP_OUTB1_SRC_CTRL4:\r\ncase RT5677_DSP_OUTB2_SRC_CTRL4:\r\ncase RT5677_VENDOR_ID:\r\ncase RT5677_VENDOR_ID1:\r\ncase RT5677_VENDOR_ID2:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool rt5677_readable_register(struct device *dev, unsigned int reg)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(rt5677_ranges); i++) {\r\nif (reg >= rt5677_ranges[i].range_min &&\r\nreg <= rt5677_ranges[i].range_max) {\r\nreturn true;\r\n}\r\n}\r\nswitch (reg) {\r\ncase RT5677_RESET:\r\ncase RT5677_LOUT1:\r\ncase RT5677_IN1:\r\ncase RT5677_MICBIAS:\r\ncase RT5677_SLIMBUS_PARAM:\r\ncase RT5677_SLIMBUS_RX:\r\ncase RT5677_SLIMBUS_CTRL:\r\ncase RT5677_SIDETONE_CTRL:\r\ncase RT5677_ANA_DAC1_2_3_SRC:\r\ncase RT5677_IF_DSP_DAC3_4_MIXER:\r\ncase RT5677_DAC4_DIG_VOL:\r\ncase RT5677_DAC3_DIG_VOL:\r\ncase RT5677_DAC1_DIG_VOL:\r\ncase RT5677_DAC2_DIG_VOL:\r\ncase RT5677_IF_DSP_DAC2_MIXER:\r\ncase RT5677_STO1_ADC_DIG_VOL:\r\ncase RT5677_MONO_ADC_DIG_VOL:\r\ncase RT5677_STO1_2_ADC_BST:\r\ncase RT5677_STO2_ADC_DIG_VOL:\r\ncase RT5677_ADC_BST_CTRL2:\r\ncase RT5677_STO3_4_ADC_BST:\r\ncase RT5677_STO3_ADC_DIG_VOL:\r\ncase RT5677_STO4_ADC_DIG_VOL:\r\ncase RT5677_STO4_ADC_MIXER:\r\ncase RT5677_STO3_ADC_MIXER:\r\ncase RT5677_STO2_ADC_MIXER:\r\ncase RT5677_STO1_ADC_MIXER:\r\ncase RT5677_MONO_ADC_MIXER:\r\ncase RT5677_ADC_IF_DSP_DAC1_MIXER:\r\ncase RT5677_STO1_DAC_MIXER:\r\ncase RT5677_MONO_DAC_MIXER:\r\ncase RT5677_DD1_MIXER:\r\ncase RT5677_DD2_MIXER:\r\ncase RT5677_IF3_DATA:\r\ncase RT5677_IF4_DATA:\r\ncase RT5677_PDM_OUT_CTRL:\r\ncase RT5677_PDM_DATA_CTRL1:\r\ncase RT5677_PDM_DATA_CTRL2:\r\ncase RT5677_PDM1_DATA_CTRL2:\r\ncase RT5677_PDM1_DATA_CTRL3:\r\ncase RT5677_PDM1_DATA_CTRL4:\r\ncase RT5677_PDM2_DATA_CTRL2:\r\ncase RT5677_PDM2_DATA_CTRL3:\r\ncase RT5677_PDM2_DATA_CTRL4:\r\ncase RT5677_TDM1_CTRL1:\r\ncase RT5677_TDM1_CTRL2:\r\ncase RT5677_TDM1_CTRL3:\r\ncase RT5677_TDM1_CTRL4:\r\ncase RT5677_TDM1_CTRL5:\r\ncase RT5677_TDM2_CTRL1:\r\ncase RT5677_TDM2_CTRL2:\r\ncase RT5677_TDM2_CTRL3:\r\ncase RT5677_TDM2_CTRL4:\r\ncase RT5677_TDM2_CTRL5:\r\ncase RT5677_I2C_MASTER_CTRL1:\r\ncase RT5677_I2C_MASTER_CTRL2:\r\ncase RT5677_I2C_MASTER_CTRL3:\r\ncase RT5677_I2C_MASTER_CTRL4:\r\ncase RT5677_I2C_MASTER_CTRL5:\r\ncase RT5677_I2C_MASTER_CTRL6:\r\ncase RT5677_I2C_MASTER_CTRL7:\r\ncase RT5677_I2C_MASTER_CTRL8:\r\ncase RT5677_DMIC_CTRL1:\r\ncase RT5677_DMIC_CTRL2:\r\ncase RT5677_HAP_GENE_CTRL1:\r\ncase RT5677_HAP_GENE_CTRL2:\r\ncase RT5677_HAP_GENE_CTRL3:\r\ncase RT5677_HAP_GENE_CTRL4:\r\ncase RT5677_HAP_GENE_CTRL5:\r\ncase RT5677_HAP_GENE_CTRL6:\r\ncase RT5677_HAP_GENE_CTRL7:\r\ncase RT5677_HAP_GENE_CTRL8:\r\ncase RT5677_HAP_GENE_CTRL9:\r\ncase RT5677_HAP_GENE_CTRL10:\r\ncase RT5677_PWR_DIG1:\r\ncase RT5677_PWR_DIG2:\r\ncase RT5677_PWR_ANLG1:\r\ncase RT5677_PWR_ANLG2:\r\ncase RT5677_PWR_DSP1:\r\ncase RT5677_PWR_DSP_ST:\r\ncase RT5677_PWR_DSP2:\r\ncase RT5677_ADC_DAC_HPF_CTRL1:\r\ncase RT5677_PRIV_INDEX:\r\ncase RT5677_PRIV_DATA:\r\ncase RT5677_I2S4_SDP:\r\ncase RT5677_I2S1_SDP:\r\ncase RT5677_I2S2_SDP:\r\ncase RT5677_I2S3_SDP:\r\ncase RT5677_CLK_TREE_CTRL1:\r\ncase RT5677_CLK_TREE_CTRL2:\r\ncase RT5677_CLK_TREE_CTRL3:\r\ncase RT5677_PLL1_CTRL1:\r\ncase RT5677_PLL1_CTRL2:\r\ncase RT5677_PLL2_CTRL1:\r\ncase RT5677_PLL2_CTRL2:\r\ncase RT5677_GLB_CLK1:\r\ncase RT5677_GLB_CLK2:\r\ncase RT5677_ASRC_1:\r\ncase RT5677_ASRC_2:\r\ncase RT5677_ASRC_3:\r\ncase RT5677_ASRC_4:\r\ncase RT5677_ASRC_5:\r\ncase RT5677_ASRC_6:\r\ncase RT5677_ASRC_7:\r\ncase RT5677_ASRC_8:\r\ncase RT5677_ASRC_9:\r\ncase RT5677_ASRC_10:\r\ncase RT5677_ASRC_11:\r\ncase RT5677_ASRC_12:\r\ncase RT5677_ASRC_13:\r\ncase RT5677_ASRC_14:\r\ncase RT5677_ASRC_15:\r\ncase RT5677_ASRC_16:\r\ncase RT5677_ASRC_17:\r\ncase RT5677_ASRC_18:\r\ncase RT5677_ASRC_19:\r\ncase RT5677_ASRC_20:\r\ncase RT5677_ASRC_21:\r\ncase RT5677_ASRC_22:\r\ncase RT5677_ASRC_23:\r\ncase RT5677_VAD_CTRL1:\r\ncase RT5677_VAD_CTRL2:\r\ncase RT5677_VAD_CTRL3:\r\ncase RT5677_VAD_CTRL4:\r\ncase RT5677_VAD_CTRL5:\r\ncase RT5677_DSP_INB_CTRL1:\r\ncase RT5677_DSP_INB_CTRL2:\r\ncase RT5677_DSP_IN_OUTB_CTRL:\r\ncase RT5677_DSP_OUTB0_1_DIG_VOL:\r\ncase RT5677_DSP_OUTB2_3_DIG_VOL:\r\ncase RT5677_DSP_OUTB4_5_DIG_VOL:\r\ncase RT5677_DSP_OUTB6_7_DIG_VOL:\r\ncase RT5677_ADC_EQ_CTRL1:\r\ncase RT5677_ADC_EQ_CTRL2:\r\ncase RT5677_EQ_CTRL1:\r\ncase RT5677_EQ_CTRL2:\r\ncase RT5677_EQ_CTRL3:\r\ncase RT5677_SOFT_VOL_ZERO_CROSS1:\r\ncase RT5677_JD_CTRL1:\r\ncase RT5677_JD_CTRL2:\r\ncase RT5677_JD_CTRL3:\r\ncase RT5677_IRQ_CTRL1:\r\ncase RT5677_IRQ_CTRL2:\r\ncase RT5677_GPIO_ST:\r\ncase RT5677_GPIO_CTRL1:\r\ncase RT5677_GPIO_CTRL2:\r\ncase RT5677_GPIO_CTRL3:\r\ncase RT5677_STO1_ADC_HI_FILTER1:\r\ncase RT5677_STO1_ADC_HI_FILTER2:\r\ncase RT5677_MONO_ADC_HI_FILTER1:\r\ncase RT5677_MONO_ADC_HI_FILTER2:\r\ncase RT5677_STO2_ADC_HI_FILTER1:\r\ncase RT5677_STO2_ADC_HI_FILTER2:\r\ncase RT5677_STO3_ADC_HI_FILTER1:\r\ncase RT5677_STO3_ADC_HI_FILTER2:\r\ncase RT5677_STO4_ADC_HI_FILTER1:\r\ncase RT5677_STO4_ADC_HI_FILTER2:\r\ncase RT5677_MB_DRC_CTRL1:\r\ncase RT5677_DRC1_CTRL1:\r\ncase RT5677_DRC1_CTRL2:\r\ncase RT5677_DRC1_CTRL3:\r\ncase RT5677_DRC1_CTRL4:\r\ncase RT5677_DRC1_CTRL5:\r\ncase RT5677_DRC1_CTRL6:\r\ncase RT5677_DRC2_CTRL1:\r\ncase RT5677_DRC2_CTRL2:\r\ncase RT5677_DRC2_CTRL3:\r\ncase RT5677_DRC2_CTRL4:\r\ncase RT5677_DRC2_CTRL5:\r\ncase RT5677_DRC2_CTRL6:\r\ncase RT5677_DRC1_HL_CTRL1:\r\ncase RT5677_DRC1_HL_CTRL2:\r\ncase RT5677_DRC2_HL_CTRL1:\r\ncase RT5677_DRC2_HL_CTRL2:\r\ncase RT5677_DSP_INB1_SRC_CTRL1:\r\ncase RT5677_DSP_INB1_SRC_CTRL2:\r\ncase RT5677_DSP_INB1_SRC_CTRL3:\r\ncase RT5677_DSP_INB1_SRC_CTRL4:\r\ncase RT5677_DSP_INB2_SRC_CTRL1:\r\ncase RT5677_DSP_INB2_SRC_CTRL2:\r\ncase RT5677_DSP_INB2_SRC_CTRL3:\r\ncase RT5677_DSP_INB2_SRC_CTRL4:\r\ncase RT5677_DSP_INB3_SRC_CTRL1:\r\ncase RT5677_DSP_INB3_SRC_CTRL2:\r\ncase RT5677_DSP_INB3_SRC_CTRL3:\r\ncase RT5677_DSP_INB3_SRC_CTRL4:\r\ncase RT5677_DSP_OUTB1_SRC_CTRL1:\r\ncase RT5677_DSP_OUTB1_SRC_CTRL2:\r\ncase RT5677_DSP_OUTB1_SRC_CTRL3:\r\ncase RT5677_DSP_OUTB1_SRC_CTRL4:\r\ncase RT5677_DSP_OUTB2_SRC_CTRL1:\r\ncase RT5677_DSP_OUTB2_SRC_CTRL2:\r\ncase RT5677_DSP_OUTB2_SRC_CTRL3:\r\ncase RT5677_DSP_OUTB2_SRC_CTRL4:\r\ncase RT5677_DSP_OUTB_0123_MIXER_CTRL:\r\ncase RT5677_DSP_OUTB_45_MIXER_CTRL:\r\ncase RT5677_DSP_OUTB_67_MIXER_CTRL:\r\ncase RT5677_DIG_MISC:\r\ncase RT5677_GEN_CTRL1:\r\ncase RT5677_GEN_CTRL2:\r\ncase RT5677_VENDOR_ID:\r\ncase RT5677_VENDOR_ID1:\r\ncase RT5677_VENDOR_ID2:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic int rt5677_dsp_mode_i2c_write_addr(struct rt5677_priv *rt5677,\r\nunsigned int addr, unsigned int value, unsigned int opcode)\r\n{\r\nstruct snd_soc_codec *codec = rt5677->codec;\r\nint ret;\r\nmutex_lock(&rt5677->dsp_cmd_lock);\r\nret = regmap_write(rt5677->regmap_physical, RT5677_DSP_I2C_ADDR_MSB,\r\naddr >> 16);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to set addr msb value: %d\n", ret);\r\ngoto err;\r\n}\r\nret = regmap_write(rt5677->regmap_physical, RT5677_DSP_I2C_ADDR_LSB,\r\naddr & 0xffff);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to set addr lsb value: %d\n", ret);\r\ngoto err;\r\n}\r\nret = regmap_write(rt5677->regmap_physical, RT5677_DSP_I2C_DATA_MSB,\r\nvalue >> 16);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to set data msb value: %d\n", ret);\r\ngoto err;\r\n}\r\nret = regmap_write(rt5677->regmap_physical, RT5677_DSP_I2C_DATA_LSB,\r\nvalue & 0xffff);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to set data lsb value: %d\n", ret);\r\ngoto err;\r\n}\r\nret = regmap_write(rt5677->regmap_physical, RT5677_DSP_I2C_OP_CODE,\r\nopcode);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to set op code value: %d\n", ret);\r\ngoto err;\r\n}\r\nerr:\r\nmutex_unlock(&rt5677->dsp_cmd_lock);\r\nreturn ret;\r\n}\r\nstatic int rt5677_dsp_mode_i2c_read_addr(\r\nstruct rt5677_priv *rt5677, unsigned int addr, unsigned int *value)\r\n{\r\nstruct snd_soc_codec *codec = rt5677->codec;\r\nint ret;\r\nunsigned int msb, lsb;\r\nmutex_lock(&rt5677->dsp_cmd_lock);\r\nret = regmap_write(rt5677->regmap_physical, RT5677_DSP_I2C_ADDR_MSB,\r\naddr >> 16);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to set addr msb value: %d\n", ret);\r\ngoto err;\r\n}\r\nret = regmap_write(rt5677->regmap_physical, RT5677_DSP_I2C_ADDR_LSB,\r\naddr & 0xffff);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to set addr lsb value: %d\n", ret);\r\ngoto err;\r\n}\r\nret = regmap_write(rt5677->regmap_physical, RT5677_DSP_I2C_OP_CODE,\r\n0x0002);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to set op code value: %d\n", ret);\r\ngoto err;\r\n}\r\nregmap_read(rt5677->regmap_physical, RT5677_DSP_I2C_DATA_MSB, &msb);\r\nregmap_read(rt5677->regmap_physical, RT5677_DSP_I2C_DATA_LSB, &lsb);\r\n*value = (msb << 16) | lsb;\r\nerr:\r\nmutex_unlock(&rt5677->dsp_cmd_lock);\r\nreturn ret;\r\n}\r\nstatic int rt5677_dsp_mode_i2c_write(struct rt5677_priv *rt5677,\r\nunsigned int reg, unsigned int value)\r\n{\r\nreturn rt5677_dsp_mode_i2c_write_addr(rt5677, 0x18020000 + reg * 2,\r\nvalue, 0x0001);\r\n}\r\nstatic int rt5677_dsp_mode_i2c_read(\r\nstruct rt5677_priv *rt5677, unsigned int reg, unsigned int *value)\r\n{\r\nint ret = rt5677_dsp_mode_i2c_read_addr(rt5677, 0x18020000 + reg * 2,\r\nvalue);\r\n*value &= 0xffff;\r\nreturn ret;\r\n}\r\nstatic void rt5677_set_dsp_mode(struct snd_soc_codec *codec, bool on)\r\n{\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nif (on) {\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_DSP1, 0x2, 0x2);\r\nrt5677->is_dsp_mode = true;\r\n} else {\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_DSP1, 0x2, 0x0);\r\nrt5677->is_dsp_mode = false;\r\n}\r\n}\r\nstatic int rt5677_set_dsp_vad(struct snd_soc_codec *codec, bool on)\r\n{\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nstatic bool activity;\r\nint ret;\r\nif (!IS_ENABLED(CONFIG_SND_SOC_RT5677_SPI))\r\nreturn -ENXIO;\r\nif (on && !activity) {\r\nactivity = true;\r\nregcache_cache_only(rt5677->regmap, false);\r\nregcache_cache_bypass(rt5677->regmap, true);\r\nregmap_update_bits(rt5677->regmap, RT5677_DIG_MISC, 0x1, 0x1);\r\nregmap_update_bits(rt5677->regmap,\r\nRT5677_PR_BASE + RT5677_BIAS_CUR4, 0x0f00, 0x0f00);\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_ANLG1,\r\nRT5677_LDO1_SEL_MASK, 0x0);\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_ANLG2,\r\nRT5677_PWR_LDO1, RT5677_PWR_LDO1);\r\nswitch (rt5677->type) {\r\ncase RT5677:\r\nregmap_update_bits(rt5677->regmap, RT5677_GLB_CLK1,\r\nRT5677_MCLK_SRC_MASK, RT5677_MCLK2_SRC);\r\nregmap_update_bits(rt5677->regmap, RT5677_GLB_CLK2,\r\nRT5677_PLL2_PR_SRC_MASK |\r\nRT5677_DSP_CLK_SRC_MASK,\r\nRT5677_PLL2_PR_SRC_MCLK2 |\r\nRT5677_DSP_CLK_SRC_BYPASS);\r\nbreak;\r\ncase RT5676:\r\nregmap_update_bits(rt5677->regmap, RT5677_GLB_CLK2,\r\nRT5677_DSP_CLK_SRC_MASK,\r\nRT5677_DSP_CLK_SRC_BYPASS);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nregmap_write(rt5677->regmap, RT5677_PWR_DSP2, 0x07ff);\r\nregmap_write(rt5677->regmap, RT5677_PWR_DSP1, 0x07fd);\r\nrt5677_set_dsp_mode(codec, true);\r\nret = request_firmware(&rt5677->fw1, RT5677_FIRMWARE1,\r\ncodec->dev);\r\nif (ret == 0) {\r\nrt5677_spi_write_firmware(0x50000000, rt5677->fw1);\r\nrelease_firmware(rt5677->fw1);\r\n}\r\nret = request_firmware(&rt5677->fw2, RT5677_FIRMWARE2,\r\ncodec->dev);\r\nif (ret == 0) {\r\nrt5677_spi_write_firmware(0x60000000, rt5677->fw2);\r\nrelease_firmware(rt5677->fw2);\r\n}\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_DSP1, 0x1, 0x0);\r\nregcache_cache_bypass(rt5677->regmap, false);\r\nregcache_cache_only(rt5677->regmap, true);\r\n} else if (!on && activity) {\r\nactivity = false;\r\nregcache_cache_only(rt5677->regmap, false);\r\nregcache_cache_bypass(rt5677->regmap, true);\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_DSP1, 0x1, 0x1);\r\nrt5677_set_dsp_mode(codec, false);\r\nregmap_write(rt5677->regmap, RT5677_PWR_DSP1, 0x0001);\r\nregmap_write(rt5677->regmap, RT5677_RESET, 0x10ec);\r\nregcache_cache_bypass(rt5677->regmap, false);\r\nregcache_mark_dirty(rt5677->regmap);\r\nregcache_sync(rt5677->regmap);\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_dsp_vad_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_component *component = snd_kcontrol_chip(kcontrol);\r\nstruct rt5677_priv *rt5677 = snd_soc_component_get_drvdata(component);\r\nucontrol->value.integer.value[0] = rt5677->dsp_vad_en;\r\nreturn 0;\r\n}\r\nstatic int rt5677_dsp_vad_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_component *component = snd_kcontrol_chip(kcontrol);\r\nstruct rt5677_priv *rt5677 = snd_soc_component_get_drvdata(component);\r\nstruct snd_soc_codec *codec = snd_soc_component_to_codec(component);\r\nrt5677->dsp_vad_en = !!ucontrol->value.integer.value[0];\r\nif (snd_soc_codec_get_bias_level(codec) == SND_SOC_BIAS_OFF)\r\nrt5677_set_dsp_vad(codec, rt5677->dsp_vad_en);\r\nreturn 0;\r\n}\r\nstatic int set_dmic_clk(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nint idx, rate;\r\nrate = rt5677->sysclk / rl6231_get_pre_div(rt5677->regmap,\r\nRT5677_CLK_TREE_CTRL1, RT5677_I2S_PD1_SFT);\r\nidx = rl6231_calc_dmic_clk(rate);\r\nif (idx < 0)\r\ndev_err(codec->dev, "Failed to set DMIC clock\n");\r\nelse\r\nregmap_update_bits(rt5677->regmap, RT5677_DMIC_CTRL1,\r\nRT5677_DMIC_CLK_MASK, idx << RT5677_DMIC_CLK_SFT);\r\nreturn idx;\r\n}\r\nstatic int is_sys_clk_from_pll(struct snd_soc_dapm_widget *source,\r\nstruct snd_soc_dapm_widget *sink)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(source->dapm);\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int val;\r\nregmap_read(rt5677->regmap, RT5677_GLB_CLK1, &val);\r\nval &= RT5677_SCLK_SRC_MASK;\r\nif (val == RT5677_SCLK_SRC_PLL1)\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic int is_using_asrc(struct snd_soc_dapm_widget *source,\r\nstruct snd_soc_dapm_widget *sink)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(source->dapm);\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int reg, shift, val;\r\nif (source->reg == RT5677_ASRC_1) {\r\nswitch (source->shift) {\r\ncase 12:\r\nreg = RT5677_ASRC_4;\r\nshift = 0;\r\nbreak;\r\ncase 13:\r\nreg = RT5677_ASRC_4;\r\nshift = 4;\r\nbreak;\r\ncase 14:\r\nreg = RT5677_ASRC_4;\r\nshift = 8;\r\nbreak;\r\ncase 15:\r\nreg = RT5677_ASRC_4;\r\nshift = 12;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\n} else {\r\nswitch (source->shift) {\r\ncase 0:\r\nreg = RT5677_ASRC_6;\r\nshift = 8;\r\nbreak;\r\ncase 1:\r\nreg = RT5677_ASRC_6;\r\nshift = 12;\r\nbreak;\r\ncase 2:\r\nreg = RT5677_ASRC_5;\r\nshift = 0;\r\nbreak;\r\ncase 3:\r\nreg = RT5677_ASRC_5;\r\nshift = 4;\r\nbreak;\r\ncase 4:\r\nreg = RT5677_ASRC_5;\r\nshift = 8;\r\nbreak;\r\ncase 5:\r\nreg = RT5677_ASRC_5;\r\nshift = 12;\r\nbreak;\r\ncase 12:\r\nreg = RT5677_ASRC_3;\r\nshift = 0;\r\nbreak;\r\ncase 13:\r\nreg = RT5677_ASRC_3;\r\nshift = 4;\r\nbreak;\r\ncase 14:\r\nreg = RT5677_ASRC_3;\r\nshift = 12;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nregmap_read(rt5677->regmap, reg, &val);\r\nval = (val >> shift) & 0xf;\r\nswitch (val) {\r\ncase 1 ... 6:\r\nreturn 1;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic int can_use_asrc(struct snd_soc_dapm_widget *source,\r\nstruct snd_soc_dapm_widget *sink)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(source->dapm);\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nif (rt5677->sysclk > rt5677->lrck[RT5677_AIF1] * 384)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nint rt5677_sel_asrc_clk_src(struct snd_soc_codec *codec,\r\nunsigned int filter_mask, unsigned int clk_src)\r\n{\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int asrc3_mask = 0, asrc3_value = 0;\r\nunsigned int asrc4_mask = 0, asrc4_value = 0;\r\nunsigned int asrc5_mask = 0, asrc5_value = 0;\r\nunsigned int asrc6_mask = 0, asrc6_value = 0;\r\nunsigned int asrc7_mask = 0, asrc7_value = 0;\r\nunsigned int asrc8_mask = 0, asrc8_value = 0;\r\nswitch (clk_src) {\r\ncase RT5677_CLK_SEL_SYS:\r\ncase RT5677_CLK_SEL_I2S1_ASRC:\r\ncase RT5677_CLK_SEL_I2S2_ASRC:\r\ncase RT5677_CLK_SEL_I2S3_ASRC:\r\ncase RT5677_CLK_SEL_I2S4_ASRC:\r\ncase RT5677_CLK_SEL_I2S5_ASRC:\r\ncase RT5677_CLK_SEL_I2S6_ASRC:\r\ncase RT5677_CLK_SEL_SYS2:\r\ncase RT5677_CLK_SEL_SYS3:\r\ncase RT5677_CLK_SEL_SYS4:\r\ncase RT5677_CLK_SEL_SYS5:\r\ncase RT5677_CLK_SEL_SYS6:\r\ncase RT5677_CLK_SEL_SYS7:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (filter_mask & RT5677_DA_STEREO_FILTER) {\r\nasrc3_mask |= RT5677_DA_STO_CLK_SEL_MASK;\r\nasrc3_value = (asrc3_value & ~RT5677_DA_STO_CLK_SEL_MASK)\r\n| (clk_src << RT5677_DA_STO_CLK_SEL_SFT);\r\n}\r\nif (filter_mask & RT5677_DA_MONO2_L_FILTER) {\r\nasrc3_mask |= RT5677_DA_MONO2L_CLK_SEL_MASK;\r\nasrc3_value = (asrc3_value & ~RT5677_DA_MONO2L_CLK_SEL_MASK)\r\n| (clk_src << RT5677_DA_MONO2L_CLK_SEL_SFT);\r\n}\r\nif (filter_mask & RT5677_DA_MONO2_R_FILTER) {\r\nasrc3_mask |= RT5677_DA_MONO2R_CLK_SEL_MASK;\r\nasrc3_value = (asrc3_value & ~RT5677_DA_MONO2R_CLK_SEL_MASK)\r\n| (clk_src << RT5677_DA_MONO2R_CLK_SEL_SFT);\r\n}\r\nif (asrc3_mask)\r\nregmap_update_bits(rt5677->regmap, RT5677_ASRC_3, asrc3_mask,\r\nasrc3_value);\r\nif (filter_mask & RT5677_DA_MONO3_L_FILTER) {\r\nasrc4_mask |= RT5677_DA_MONO3L_CLK_SEL_MASK;\r\nasrc4_value = (asrc4_value & ~RT5677_DA_MONO3L_CLK_SEL_MASK)\r\n| (clk_src << RT5677_DA_MONO3L_CLK_SEL_SFT);\r\n}\r\nif (filter_mask & RT5677_DA_MONO3_R_FILTER) {\r\nasrc4_mask |= RT5677_DA_MONO3R_CLK_SEL_MASK;\r\nasrc4_value = (asrc4_value & ~RT5677_DA_MONO3R_CLK_SEL_MASK)\r\n| (clk_src << RT5677_DA_MONO3R_CLK_SEL_SFT);\r\n}\r\nif (filter_mask & RT5677_DA_MONO4_L_FILTER) {\r\nasrc4_mask |= RT5677_DA_MONO4L_CLK_SEL_MASK;\r\nasrc4_value = (asrc4_value & ~RT5677_DA_MONO4L_CLK_SEL_MASK)\r\n| (clk_src << RT5677_DA_MONO4L_CLK_SEL_SFT);\r\n}\r\nif (filter_mask & RT5677_DA_MONO4_R_FILTER) {\r\nasrc4_mask |= RT5677_DA_MONO4R_CLK_SEL_MASK;\r\nasrc4_value = (asrc4_value & ~RT5677_DA_MONO4R_CLK_SEL_MASK)\r\n| (clk_src << RT5677_DA_MONO4R_CLK_SEL_SFT);\r\n}\r\nif (asrc4_mask)\r\nregmap_update_bits(rt5677->regmap, RT5677_ASRC_4, asrc4_mask,\r\nasrc4_value);\r\nif (filter_mask & RT5677_AD_STEREO1_FILTER) {\r\nasrc5_mask |= RT5677_AD_STO1_CLK_SEL_MASK;\r\nasrc5_value = (asrc5_value & ~RT5677_AD_STO1_CLK_SEL_MASK)\r\n| (clk_src << RT5677_AD_STO1_CLK_SEL_SFT);\r\n}\r\nif (filter_mask & RT5677_AD_STEREO2_FILTER) {\r\nasrc5_mask |= RT5677_AD_STO2_CLK_SEL_MASK;\r\nasrc5_value = (asrc5_value & ~RT5677_AD_STO2_CLK_SEL_MASK)\r\n| (clk_src << RT5677_AD_STO2_CLK_SEL_SFT);\r\n}\r\nif (filter_mask & RT5677_AD_STEREO3_FILTER) {\r\nasrc5_mask |= RT5677_AD_STO3_CLK_SEL_MASK;\r\nasrc5_value = (asrc5_value & ~RT5677_AD_STO3_CLK_SEL_MASK)\r\n| (clk_src << RT5677_AD_STO3_CLK_SEL_SFT);\r\n}\r\nif (filter_mask & RT5677_AD_STEREO4_FILTER) {\r\nasrc5_mask |= RT5677_AD_STO4_CLK_SEL_MASK;\r\nasrc5_value = (asrc5_value & ~RT5677_AD_STO4_CLK_SEL_MASK)\r\n| (clk_src << RT5677_AD_STO4_CLK_SEL_SFT);\r\n}\r\nif (asrc5_mask)\r\nregmap_update_bits(rt5677->regmap, RT5677_ASRC_5, asrc5_mask,\r\nasrc5_value);\r\nif (filter_mask & RT5677_AD_MONO_L_FILTER) {\r\nasrc6_mask |= RT5677_AD_MONOL_CLK_SEL_MASK;\r\nasrc6_value = (asrc6_value & ~RT5677_AD_MONOL_CLK_SEL_MASK)\r\n| (clk_src << RT5677_AD_MONOL_CLK_SEL_SFT);\r\n}\r\nif (filter_mask & RT5677_AD_MONO_R_FILTER) {\r\nasrc6_mask |= RT5677_AD_MONOR_CLK_SEL_MASK;\r\nasrc6_value = (asrc6_value & ~RT5677_AD_MONOR_CLK_SEL_MASK)\r\n| (clk_src << RT5677_AD_MONOR_CLK_SEL_SFT);\r\n}\r\nif (asrc6_mask)\r\nregmap_update_bits(rt5677->regmap, RT5677_ASRC_6, asrc6_mask,\r\nasrc6_value);\r\nif (filter_mask & RT5677_DSP_OB_0_3_FILTER) {\r\nasrc7_mask |= RT5677_DSP_OB_0_3_CLK_SEL_MASK;\r\nasrc7_value = (asrc7_value & ~RT5677_DSP_OB_0_3_CLK_SEL_MASK)\r\n| (clk_src << RT5677_DSP_OB_0_3_CLK_SEL_SFT);\r\n}\r\nif (filter_mask & RT5677_DSP_OB_4_7_FILTER) {\r\nasrc7_mask |= RT5677_DSP_OB_4_7_CLK_SEL_MASK;\r\nasrc7_value = (asrc7_value & ~RT5677_DSP_OB_4_7_CLK_SEL_MASK)\r\n| (clk_src << RT5677_DSP_OB_4_7_CLK_SEL_SFT);\r\n}\r\nif (asrc7_mask)\r\nregmap_update_bits(rt5677->regmap, RT5677_ASRC_7, asrc7_mask,\r\nasrc7_value);\r\nif (filter_mask & RT5677_I2S1_SOURCE) {\r\nasrc8_mask |= RT5677_I2S1_CLK_SEL_MASK;\r\nasrc8_value = (asrc8_value & ~RT5677_I2S1_CLK_SEL_MASK)\r\n| ((clk_src - 1) << RT5677_I2S1_CLK_SEL_SFT);\r\n}\r\nif (filter_mask & RT5677_I2S2_SOURCE) {\r\nasrc8_mask |= RT5677_I2S2_CLK_SEL_MASK;\r\nasrc8_value = (asrc8_value & ~RT5677_I2S2_CLK_SEL_MASK)\r\n| ((clk_src - 1) << RT5677_I2S2_CLK_SEL_SFT);\r\n}\r\nif (filter_mask & RT5677_I2S3_SOURCE) {\r\nasrc8_mask |= RT5677_I2S3_CLK_SEL_MASK;\r\nasrc8_value = (asrc8_value & ~RT5677_I2S3_CLK_SEL_MASK)\r\n| ((clk_src - 1) << RT5677_I2S3_CLK_SEL_SFT);\r\n}\r\nif (filter_mask & RT5677_I2S4_SOURCE) {\r\nasrc8_mask |= RT5677_I2S4_CLK_SEL_MASK;\r\nasrc8_value = (asrc8_value & ~RT5677_I2S4_CLK_SEL_MASK)\r\n| ((clk_src - 1) << RT5677_I2S4_CLK_SEL_SFT);\r\n}\r\nif (asrc8_mask)\r\nregmap_update_bits(rt5677->regmap, RT5677_ASRC_8, asrc8_mask,\r\nasrc8_value);\r\nreturn 0;\r\n}\r\nstatic int rt5677_dmic_use_asrc(struct snd_soc_dapm_widget *source,\r\nstruct snd_soc_dapm_widget *sink)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(source->dapm);\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int asrc_setting;\r\nswitch (source->shift) {\r\ncase 11:\r\nregmap_read(rt5677->regmap, RT5677_ASRC_5, &asrc_setting);\r\nasrc_setting = (asrc_setting & RT5677_AD_STO1_CLK_SEL_MASK) >>\r\nRT5677_AD_STO1_CLK_SEL_SFT;\r\nbreak;\r\ncase 10:\r\nregmap_read(rt5677->regmap, RT5677_ASRC_5, &asrc_setting);\r\nasrc_setting = (asrc_setting & RT5677_AD_STO2_CLK_SEL_MASK) >>\r\nRT5677_AD_STO2_CLK_SEL_SFT;\r\nbreak;\r\ncase 9:\r\nregmap_read(rt5677->regmap, RT5677_ASRC_5, &asrc_setting);\r\nasrc_setting = (asrc_setting & RT5677_AD_STO3_CLK_SEL_MASK) >>\r\nRT5677_AD_STO3_CLK_SEL_SFT;\r\nbreak;\r\ncase 8:\r\nregmap_read(rt5677->regmap, RT5677_ASRC_5, &asrc_setting);\r\nasrc_setting = (asrc_setting & RT5677_AD_STO4_CLK_SEL_MASK) >>\r\nRT5677_AD_STO4_CLK_SEL_SFT;\r\nbreak;\r\ncase 7:\r\nregmap_read(rt5677->regmap, RT5677_ASRC_6, &asrc_setting);\r\nasrc_setting = (asrc_setting & RT5677_AD_MONOL_CLK_SEL_MASK) >>\r\nRT5677_AD_MONOL_CLK_SEL_SFT;\r\nbreak;\r\ncase 6:\r\nregmap_read(rt5677->regmap, RT5677_ASRC_6, &asrc_setting);\r\nasrc_setting = (asrc_setting & RT5677_AD_MONOR_CLK_SEL_MASK) >>\r\nRT5677_AD_MONOR_CLK_SEL_SFT;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nif (asrc_setting >= RT5677_CLK_SEL_I2S1_ASRC &&\r\nasrc_setting <= RT5677_CLK_SEL_I2S6_ASRC)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int rt5677_bst1_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nswitch (event) {\r\ncase SND_SOC_DAPM_POST_PMU:\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_ANLG2,\r\nRT5677_PWR_BST1_P, RT5677_PWR_BST1_P);\r\nbreak;\r\ncase SND_SOC_DAPM_PRE_PMD:\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_ANLG2,\r\nRT5677_PWR_BST1_P, 0);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_bst2_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nswitch (event) {\r\ncase SND_SOC_DAPM_POST_PMU:\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_ANLG2,\r\nRT5677_PWR_BST2_P, RT5677_PWR_BST2_P);\r\nbreak;\r\ncase SND_SOC_DAPM_PRE_PMD:\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_ANLG2,\r\nRT5677_PWR_BST2_P, 0);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_set_pll1_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nswitch (event) {\r\ncase SND_SOC_DAPM_PRE_PMU:\r\nregmap_update_bits(rt5677->regmap, RT5677_PLL1_CTRL2, 0x2, 0x2);\r\nbreak;\r\ncase SND_SOC_DAPM_POST_PMU:\r\nregmap_update_bits(rt5677->regmap, RT5677_PLL1_CTRL2, 0x2, 0x0);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_set_pll2_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nswitch (event) {\r\ncase SND_SOC_DAPM_PRE_PMU:\r\nregmap_update_bits(rt5677->regmap, RT5677_PLL2_CTRL2, 0x2, 0x2);\r\nbreak;\r\ncase SND_SOC_DAPM_POST_PMU:\r\nregmap_update_bits(rt5677->regmap, RT5677_PLL2_CTRL2, 0x2, 0x0);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_set_micbias1_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nswitch (event) {\r\ncase SND_SOC_DAPM_POST_PMU:\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_ANLG2,\r\nRT5677_PWR_CLK_MB1 | RT5677_PWR_PP_MB1 |\r\nRT5677_PWR_CLK_MB, RT5677_PWR_CLK_MB1 |\r\nRT5677_PWR_PP_MB1 | RT5677_PWR_CLK_MB);\r\nbreak;\r\ncase SND_SOC_DAPM_PRE_PMD:\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_ANLG2,\r\nRT5677_PWR_CLK_MB1 | RT5677_PWR_PP_MB1 |\r\nRT5677_PWR_CLK_MB, 0);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_if1_adc_tdm_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int value;\r\nswitch (event) {\r\ncase SND_SOC_DAPM_PRE_PMU:\r\nregmap_read(rt5677->regmap, RT5677_TDM1_CTRL2, &value);\r\nif (value & RT5677_IF1_ADC_CTRL_MASK)\r\nregmap_update_bits(rt5677->regmap, RT5677_TDM1_CTRL1,\r\nRT5677_IF1_ADC_MODE_MASK,\r\nRT5677_IF1_ADC_MODE_TDM);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_if2_adc_tdm_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int value;\r\nswitch (event) {\r\ncase SND_SOC_DAPM_PRE_PMU:\r\nregmap_read(rt5677->regmap, RT5677_TDM2_CTRL2, &value);\r\nif (value & RT5677_IF2_ADC_CTRL_MASK)\r\nregmap_update_bits(rt5677->regmap, RT5677_TDM2_CTRL1,\r\nRT5677_IF2_ADC_MODE_MASK,\r\nRT5677_IF2_ADC_MODE_TDM);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_vref_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nswitch (event) {\r\ncase SND_SOC_DAPM_POST_PMU:\r\nif (snd_soc_codec_get_bias_level(codec) != SND_SOC_BIAS_ON &&\r\n!rt5677->is_vref_slow) {\r\nmdelay(20);\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_ANLG1,\r\nRT5677_PWR_FV1 | RT5677_PWR_FV2,\r\nRT5677_PWR_FV1 | RT5677_PWR_FV2);\r\nrt5677->is_vref_slow = true;\r\n}\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_filter_power_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nswitch (event) {\r\ncase SND_SOC_DAPM_POST_PMU:\r\nmsleep(50);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int val_len = 0, val_clk, mask_clk;\r\nint pre_div, bclk_ms, frame_size;\r\nrt5677->lrck[dai->id] = params_rate(params);\r\npre_div = rl6231_get_clk_info(rt5677->sysclk, rt5677->lrck[dai->id]);\r\nif (pre_div < 0) {\r\ndev_err(codec->dev, "Unsupported clock setting: sysclk=%dHz lrck=%dHz\n",\r\nrt5677->sysclk, rt5677->lrck[dai->id]);\r\nreturn -EINVAL;\r\n}\r\nframe_size = snd_soc_params_to_frame_size(params);\r\nif (frame_size < 0) {\r\ndev_err(codec->dev, "Unsupported frame size: %d\n", frame_size);\r\nreturn -EINVAL;\r\n}\r\nbclk_ms = frame_size > 32;\r\nrt5677->bclk[dai->id] = rt5677->lrck[dai->id] * (32 << bclk_ms);\r\ndev_dbg(dai->dev, "bclk is %dHz and lrck is %dHz\n",\r\nrt5677->bclk[dai->id], rt5677->lrck[dai->id]);\r\ndev_dbg(dai->dev, "bclk_ms is %d and pre_div is %d for iis %d\n",\r\nbclk_ms, pre_div, dai->id);\r\nswitch (params_width(params)) {\r\ncase 16:\r\nbreak;\r\ncase 20:\r\nval_len |= RT5677_I2S_DL_20;\r\nbreak;\r\ncase 24:\r\nval_len |= RT5677_I2S_DL_24;\r\nbreak;\r\ncase 8:\r\nval_len |= RT5677_I2S_DL_8;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (dai->id) {\r\ncase RT5677_AIF1:\r\nmask_clk = RT5677_I2S_PD1_MASK;\r\nval_clk = pre_div << RT5677_I2S_PD1_SFT;\r\nregmap_update_bits(rt5677->regmap, RT5677_I2S1_SDP,\r\nRT5677_I2S_DL_MASK, val_len);\r\nregmap_update_bits(rt5677->regmap, RT5677_CLK_TREE_CTRL1,\r\nmask_clk, val_clk);\r\nbreak;\r\ncase RT5677_AIF2:\r\nmask_clk = RT5677_I2S_PD2_MASK;\r\nval_clk = pre_div << RT5677_I2S_PD2_SFT;\r\nregmap_update_bits(rt5677->regmap, RT5677_I2S2_SDP,\r\nRT5677_I2S_DL_MASK, val_len);\r\nregmap_update_bits(rt5677->regmap, RT5677_CLK_TREE_CTRL1,\r\nmask_clk, val_clk);\r\nbreak;\r\ncase RT5677_AIF3:\r\nmask_clk = RT5677_I2S_BCLK_MS3_MASK | RT5677_I2S_PD3_MASK;\r\nval_clk = bclk_ms << RT5677_I2S_BCLK_MS3_SFT |\r\npre_div << RT5677_I2S_PD3_SFT;\r\nregmap_update_bits(rt5677->regmap, RT5677_I2S3_SDP,\r\nRT5677_I2S_DL_MASK, val_len);\r\nregmap_update_bits(rt5677->regmap, RT5677_CLK_TREE_CTRL1,\r\nmask_clk, val_clk);\r\nbreak;\r\ncase RT5677_AIF4:\r\nmask_clk = RT5677_I2S_BCLK_MS4_MASK | RT5677_I2S_PD4_MASK;\r\nval_clk = bclk_ms << RT5677_I2S_BCLK_MS4_SFT |\r\npre_div << RT5677_I2S_PD4_SFT;\r\nregmap_update_bits(rt5677->regmap, RT5677_I2S4_SDP,\r\nRT5677_I2S_DL_MASK, val_len);\r\nregmap_update_bits(rt5677->regmap, RT5677_CLK_TREE_CTRL1,\r\nmask_clk, val_clk);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_set_dai_fmt(struct snd_soc_dai *dai, unsigned int fmt)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int reg_val = 0;\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\nrt5677->master[dai->id] = 1;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\nreg_val |= RT5677_I2S_MS_S;\r\nrt5677->master[dai->id] = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\r\ncase SND_SOC_DAIFMT_NB_NF:\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_NF:\r\nreg_val |= RT5677_I2S_BP_INV;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\nbreak;\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\nreg_val |= RT5677_I2S_DF_LEFT;\r\nbreak;\r\ncase SND_SOC_DAIFMT_DSP_A:\r\nreg_val |= RT5677_I2S_DF_PCM_A;\r\nbreak;\r\ncase SND_SOC_DAIFMT_DSP_B:\r\nreg_val |= RT5677_I2S_DF_PCM_B;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (dai->id) {\r\ncase RT5677_AIF1:\r\nregmap_update_bits(rt5677->regmap, RT5677_I2S1_SDP,\r\nRT5677_I2S_MS_MASK | RT5677_I2S_BP_MASK |\r\nRT5677_I2S_DF_MASK, reg_val);\r\nbreak;\r\ncase RT5677_AIF2:\r\nregmap_update_bits(rt5677->regmap, RT5677_I2S2_SDP,\r\nRT5677_I2S_MS_MASK | RT5677_I2S_BP_MASK |\r\nRT5677_I2S_DF_MASK, reg_val);\r\nbreak;\r\ncase RT5677_AIF3:\r\nregmap_update_bits(rt5677->regmap, RT5677_I2S3_SDP,\r\nRT5677_I2S_MS_MASK | RT5677_I2S_BP_MASK |\r\nRT5677_I2S_DF_MASK, reg_val);\r\nbreak;\r\ncase RT5677_AIF4:\r\nregmap_update_bits(rt5677->regmap, RT5677_I2S4_SDP,\r\nRT5677_I2S_MS_MASK | RT5677_I2S_BP_MASK |\r\nRT5677_I2S_DF_MASK, reg_val);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_set_dai_sysclk(struct snd_soc_dai *dai,\r\nint clk_id, unsigned int freq, int dir)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int reg_val = 0;\r\nif (freq == rt5677->sysclk && clk_id == rt5677->sysclk_src)\r\nreturn 0;\r\nswitch (clk_id) {\r\ncase RT5677_SCLK_S_MCLK:\r\nreg_val |= RT5677_SCLK_SRC_MCLK;\r\nbreak;\r\ncase RT5677_SCLK_S_PLL1:\r\nreg_val |= RT5677_SCLK_SRC_PLL1;\r\nbreak;\r\ncase RT5677_SCLK_S_RCCLK:\r\nreg_val |= RT5677_SCLK_SRC_RCCLK;\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Invalid clock id (%d)\n", clk_id);\r\nreturn -EINVAL;\r\n}\r\nregmap_update_bits(rt5677->regmap, RT5677_GLB_CLK1,\r\nRT5677_SCLK_SRC_MASK, reg_val);\r\nrt5677->sysclk = freq;\r\nrt5677->sysclk_src = clk_id;\r\ndev_dbg(dai->dev, "Sysclk is %dHz and clock id is %d\n", freq, clk_id);\r\nreturn 0;\r\n}\r\nstatic int rt5677_pll_calc(const unsigned int freq_in,\r\nconst unsigned int freq_out, struct rl6231_pll_code *pll_code)\r\n{\r\nif (RT5677_PLL_INP_MIN > freq_in)\r\nreturn -EINVAL;\r\nreturn rl6231_pll_calc(freq_in, freq_out, pll_code);\r\n}\r\nstatic int rt5677_set_dai_pll(struct snd_soc_dai *dai, int pll_id, int source,\r\nunsigned int freq_in, unsigned int freq_out)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nstruct rl6231_pll_code pll_code;\r\nint ret;\r\nif (source == rt5677->pll_src && freq_in == rt5677->pll_in &&\r\nfreq_out == rt5677->pll_out)\r\nreturn 0;\r\nif (!freq_in || !freq_out) {\r\ndev_dbg(codec->dev, "PLL disabled\n");\r\nrt5677->pll_in = 0;\r\nrt5677->pll_out = 0;\r\nregmap_update_bits(rt5677->regmap, RT5677_GLB_CLK1,\r\nRT5677_SCLK_SRC_MASK, RT5677_SCLK_SRC_MCLK);\r\nreturn 0;\r\n}\r\nswitch (source) {\r\ncase RT5677_PLL1_S_MCLK:\r\nregmap_update_bits(rt5677->regmap, RT5677_GLB_CLK1,\r\nRT5677_PLL1_SRC_MASK, RT5677_PLL1_SRC_MCLK);\r\nbreak;\r\ncase RT5677_PLL1_S_BCLK1:\r\ncase RT5677_PLL1_S_BCLK2:\r\ncase RT5677_PLL1_S_BCLK3:\r\ncase RT5677_PLL1_S_BCLK4:\r\nswitch (dai->id) {\r\ncase RT5677_AIF1:\r\nregmap_update_bits(rt5677->regmap, RT5677_GLB_CLK1,\r\nRT5677_PLL1_SRC_MASK, RT5677_PLL1_SRC_BCLK1);\r\nbreak;\r\ncase RT5677_AIF2:\r\nregmap_update_bits(rt5677->regmap, RT5677_GLB_CLK1,\r\nRT5677_PLL1_SRC_MASK, RT5677_PLL1_SRC_BCLK2);\r\nbreak;\r\ncase RT5677_AIF3:\r\nregmap_update_bits(rt5677->regmap, RT5677_GLB_CLK1,\r\nRT5677_PLL1_SRC_MASK, RT5677_PLL1_SRC_BCLK3);\r\nbreak;\r\ncase RT5677_AIF4:\r\nregmap_update_bits(rt5677->regmap, RT5677_GLB_CLK1,\r\nRT5677_PLL1_SRC_MASK, RT5677_PLL1_SRC_BCLK4);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Unknown PLL source %d\n", source);\r\nreturn -EINVAL;\r\n}\r\nret = rt5677_pll_calc(freq_in, freq_out, &pll_code);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Unsupport input clock %d\n", freq_in);\r\nreturn ret;\r\n}\r\ndev_dbg(codec->dev, "m_bypass=%d m=%d n=%d k=%d\n",\r\npll_code.m_bp, (pll_code.m_bp ? 0 : pll_code.m_code),\r\npll_code.n_code, pll_code.k_code);\r\nregmap_write(rt5677->regmap, RT5677_PLL1_CTRL1,\r\npll_code.n_code << RT5677_PLL_N_SFT | pll_code.k_code);\r\nregmap_write(rt5677->regmap, RT5677_PLL1_CTRL2,\r\n(pll_code.m_bp ? 0 : pll_code.m_code) << RT5677_PLL_M_SFT |\r\npll_code.m_bp << RT5677_PLL_M_BP_SFT);\r\nrt5677->pll_in = freq_in;\r\nrt5677->pll_out = freq_out;\r\nrt5677->pll_src = source;\r\nreturn 0;\r\n}\r\nstatic int rt5677_set_tdm_slot(struct snd_soc_dai *dai, unsigned int tx_mask,\r\nunsigned int rx_mask, int slots, int slot_width)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int val = 0, slot_width_25 = 0;\r\nif (rx_mask || tx_mask)\r\nval |= (1 << 12);\r\nswitch (slots) {\r\ncase 4:\r\nval |= (1 << 10);\r\nbreak;\r\ncase 6:\r\nval |= (2 << 10);\r\nbreak;\r\ncase 8:\r\nval |= (3 << 10);\r\nbreak;\r\ncase 2:\r\ndefault:\r\nbreak;\r\n}\r\nswitch (slot_width) {\r\ncase 20:\r\nval |= (1 << 8);\r\nbreak;\r\ncase 25:\r\nslot_width_25 = 0x8080;\r\ncase 24:\r\nval |= (2 << 8);\r\nbreak;\r\ncase 32:\r\nval |= (3 << 8);\r\nbreak;\r\ncase 16:\r\ndefault:\r\nbreak;\r\n}\r\nswitch (dai->id) {\r\ncase RT5677_AIF1:\r\nregmap_update_bits(rt5677->regmap, RT5677_TDM1_CTRL1, 0x1f00,\r\nval);\r\nregmap_update_bits(rt5677->regmap, RT5677_DIG_MISC, 0x8000,\r\nslot_width_25);\r\nbreak;\r\ncase RT5677_AIF2:\r\nregmap_update_bits(rt5677->regmap, RT5677_TDM2_CTRL1, 0x1f00,\r\nval);\r\nregmap_update_bits(rt5677->regmap, RT5677_DIG_MISC, 0x80,\r\nslot_width_25);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_set_bias_level(struct snd_soc_codec *codec,\r\nenum snd_soc_bias_level level)\r\n{\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nswitch (level) {\r\ncase SND_SOC_BIAS_ON:\r\nbreak;\r\ncase SND_SOC_BIAS_PREPARE:\r\nif (snd_soc_codec_get_bias_level(codec) == SND_SOC_BIAS_STANDBY) {\r\nrt5677_set_dsp_vad(codec, false);\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_ANLG1,\r\nRT5677_LDO1_SEL_MASK | RT5677_LDO2_SEL_MASK,\r\n0x0055);\r\nregmap_update_bits(rt5677->regmap,\r\nRT5677_PR_BASE + RT5677_BIAS_CUR4,\r\n0x0f00, 0x0f00);\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_ANLG1,\r\nRT5677_PWR_FV1 | RT5677_PWR_FV2 |\r\nRT5677_PWR_VREF1 | RT5677_PWR_MB |\r\nRT5677_PWR_BG | RT5677_PWR_VREF2,\r\nRT5677_PWR_VREF1 | RT5677_PWR_MB |\r\nRT5677_PWR_BG | RT5677_PWR_VREF2);\r\nrt5677->is_vref_slow = false;\r\nregmap_update_bits(rt5677->regmap, RT5677_PWR_ANLG2,\r\nRT5677_PWR_CORE, RT5677_PWR_CORE);\r\nregmap_update_bits(rt5677->regmap, RT5677_DIG_MISC,\r\n0x1, 0x1);\r\n}\r\nbreak;\r\ncase SND_SOC_BIAS_STANDBY:\r\nbreak;\r\ncase SND_SOC_BIAS_OFF:\r\nregmap_update_bits(rt5677->regmap, RT5677_DIG_MISC, 0x1, 0x0);\r\nregmap_write(rt5677->regmap, RT5677_PWR_DIG1, 0x0000);\r\nregmap_write(rt5677->regmap, RT5677_PWR_DIG2, 0x0000);\r\nregmap_write(rt5677->regmap, RT5677_PWR_ANLG1, 0x0022);\r\nregmap_write(rt5677->regmap, RT5677_PWR_ANLG2, 0x0000);\r\nregmap_update_bits(rt5677->regmap,\r\nRT5677_PR_BASE + RT5677_BIAS_CUR4, 0x0f00, 0x0000);\r\nif (rt5677->dsp_vad_en)\r\nrt5677_set_dsp_vad(codec, true);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic void rt5677_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nstruct rt5677_priv *rt5677 = gpiochip_get_data(chip);\r\nswitch (offset) {\r\ncase RT5677_GPIO1 ... RT5677_GPIO5:\r\nregmap_update_bits(rt5677->regmap, RT5677_GPIO_CTRL2,\r\n0x1 << (offset * 3 + 1), !!value << (offset * 3 + 1));\r\nbreak;\r\ncase RT5677_GPIO6:\r\nregmap_update_bits(rt5677->regmap, RT5677_GPIO_CTRL3,\r\nRT5677_GPIO6_OUT_MASK, !!value << RT5677_GPIO6_OUT_SFT);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic int rt5677_gpio_direction_out(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nstruct rt5677_priv *rt5677 = gpiochip_get_data(chip);\r\nswitch (offset) {\r\ncase RT5677_GPIO1 ... RT5677_GPIO5:\r\nregmap_update_bits(rt5677->regmap, RT5677_GPIO_CTRL2,\r\n0x3 << (offset * 3 + 1),\r\n(0x2 | !!value) << (offset * 3 + 1));\r\nbreak;\r\ncase RT5677_GPIO6:\r\nregmap_update_bits(rt5677->regmap, RT5677_GPIO_CTRL3,\r\nRT5677_GPIO6_DIR_MASK | RT5677_GPIO6_OUT_MASK,\r\nRT5677_GPIO6_DIR_OUT | !!value << RT5677_GPIO6_OUT_SFT);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct rt5677_priv *rt5677 = gpiochip_get_data(chip);\r\nint value, ret;\r\nret = regmap_read(rt5677->regmap, RT5677_GPIO_ST, &value);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn (value & (0x1 << offset)) >> offset;\r\n}\r\nstatic int rt5677_gpio_direction_in(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct rt5677_priv *rt5677 = gpiochip_get_data(chip);\r\nswitch (offset) {\r\ncase RT5677_GPIO1 ... RT5677_GPIO5:\r\nregmap_update_bits(rt5677->regmap, RT5677_GPIO_CTRL2,\r\n0x1 << (offset * 3 + 2), 0x0);\r\nbreak;\r\ncase RT5677_GPIO6:\r\nregmap_update_bits(rt5677->regmap, RT5677_GPIO_CTRL3,\r\nRT5677_GPIO6_DIR_MASK, RT5677_GPIO6_DIR_IN);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic void rt5677_gpio_config(struct rt5677_priv *rt5677, unsigned offset,\r\nint value)\r\n{\r\nint shift;\r\nswitch (offset) {\r\ncase RT5677_GPIO1 ... RT5677_GPIO2:\r\nshift = 2 * (1 - offset);\r\nregmap_update_bits(rt5677->regmap,\r\nRT5677_PR_BASE + RT5677_DIG_IN_PIN_ST_CTRL2,\r\n0x3 << shift,\r\n(value & 0x3) << shift);\r\nbreak;\r\ncase RT5677_GPIO3 ... RT5677_GPIO6:\r\nshift = 2 * (9 - offset);\r\nregmap_update_bits(rt5677->regmap,\r\nRT5677_PR_BASE + RT5677_DIG_IN_PIN_ST_CTRL3,\r\n0x3 << shift,\r\n(value & 0x3) << shift);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic int rt5677_to_irq(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct rt5677_priv *rt5677 = gpiochip_get_data(chip);\r\nstruct regmap_irq_chip_data *data = rt5677->irq_data;\r\nint irq;\r\nif (offset >= RT5677_GPIO1 && offset <= RT5677_GPIO3) {\r\nif ((rt5677->pdata.jd1_gpio == 1 && offset == RT5677_GPIO1) ||\r\n(rt5677->pdata.jd1_gpio == 2 &&\r\noffset == RT5677_GPIO2) ||\r\n(rt5677->pdata.jd1_gpio == 3 &&\r\noffset == RT5677_GPIO3)) {\r\nirq = RT5677_IRQ_JD1;\r\n} else {\r\nreturn -ENXIO;\r\n}\r\n}\r\nif (offset >= RT5677_GPIO4 && offset <= RT5677_GPIO6) {\r\nif ((rt5677->pdata.jd2_gpio == 1 && offset == RT5677_GPIO4) ||\r\n(rt5677->pdata.jd2_gpio == 2 &&\r\noffset == RT5677_GPIO5) ||\r\n(rt5677->pdata.jd2_gpio == 3 &&\r\noffset == RT5677_GPIO6)) {\r\nirq = RT5677_IRQ_JD2;\r\n} else if ((rt5677->pdata.jd3_gpio == 1 &&\r\noffset == RT5677_GPIO4) ||\r\n(rt5677->pdata.jd3_gpio == 2 &&\r\noffset == RT5677_GPIO5) ||\r\n(rt5677->pdata.jd3_gpio == 3 &&\r\noffset == RT5677_GPIO6)) {\r\nirq = RT5677_IRQ_JD3;\r\n} else {\r\nreturn -ENXIO;\r\n}\r\n}\r\nreturn regmap_irq_get_virq(data, irq);\r\n}\r\nstatic void rt5677_init_gpio(struct i2c_client *i2c)\r\n{\r\nstruct rt5677_priv *rt5677 = i2c_get_clientdata(i2c);\r\nint ret;\r\nrt5677->gpio_chip = rt5677_template_chip;\r\nrt5677->gpio_chip.ngpio = RT5677_GPIO_NUM;\r\nrt5677->gpio_chip.parent = &i2c->dev;\r\nrt5677->gpio_chip.base = -1;\r\nret = gpiochip_add_data(&rt5677->gpio_chip, rt5677);\r\nif (ret != 0)\r\ndev_err(&i2c->dev, "Failed to add GPIOs: %d\n", ret);\r\n}\r\nstatic void rt5677_free_gpio(struct i2c_client *i2c)\r\n{\r\nstruct rt5677_priv *rt5677 = i2c_get_clientdata(i2c);\r\ngpiochip_remove(&rt5677->gpio_chip);\r\n}\r\nstatic void rt5677_gpio_config(struct rt5677_priv *rt5677, unsigned offset,\r\nint value)\r\n{\r\n}\r\nstatic void rt5677_init_gpio(struct i2c_client *i2c)\r\n{\r\n}\r\nstatic void rt5677_free_gpio(struct i2c_client *i2c)\r\n{\r\n}\r\nstatic int rt5677_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nint i;\r\nrt5677->codec = codec;\r\nif (rt5677->pdata.dmic2_clk_pin == RT5677_DMIC_CLK2) {\r\nsnd_soc_dapm_add_routes(dapm,\r\nrt5677_dmic2_clk_2,\r\nARRAY_SIZE(rt5677_dmic2_clk_2));\r\n} else {\r\nsnd_soc_dapm_add_routes(dapm,\r\nrt5677_dmic2_clk_1,\r\nARRAY_SIZE(rt5677_dmic2_clk_1));\r\n}\r\nsnd_soc_codec_force_bias_level(codec, SND_SOC_BIAS_OFF);\r\nregmap_write(rt5677->regmap, RT5677_DIG_MISC, 0x0020);\r\nregmap_write(rt5677->regmap, RT5677_PWR_DSP2, 0x0c00);\r\nfor (i = 0; i < RT5677_GPIO_NUM; i++)\r\nrt5677_gpio_config(rt5677, i, rt5677->pdata.gpio_config[i]);\r\nif (rt5677->irq_data) {\r\nregmap_update_bits(rt5677->regmap, RT5677_GPIO_CTRL1, 0x8000,\r\n0x8000);\r\nregmap_update_bits(rt5677->regmap, RT5677_DIG_MISC, 0x0018,\r\n0x0008);\r\nif (rt5677->pdata.jd1_gpio)\r\nregmap_update_bits(rt5677->regmap, RT5677_JD_CTRL1,\r\nRT5677_SEL_GPIO_JD1_MASK,\r\nrt5677->pdata.jd1_gpio <<\r\nRT5677_SEL_GPIO_JD1_SFT);\r\nif (rt5677->pdata.jd2_gpio)\r\nregmap_update_bits(rt5677->regmap, RT5677_JD_CTRL1,\r\nRT5677_SEL_GPIO_JD2_MASK,\r\nrt5677->pdata.jd2_gpio <<\r\nRT5677_SEL_GPIO_JD2_SFT);\r\nif (rt5677->pdata.jd3_gpio)\r\nregmap_update_bits(rt5677->regmap, RT5677_JD_CTRL1,\r\nRT5677_SEL_GPIO_JD3_MASK,\r\nrt5677->pdata.jd3_gpio <<\r\nRT5677_SEL_GPIO_JD3_SFT);\r\n}\r\nmutex_init(&rt5677->dsp_cmd_lock);\r\nmutex_init(&rt5677->dsp_pri_lock);\r\nreturn 0;\r\n}\r\nstatic int rt5677_remove(struct snd_soc_codec *codec)\r\n{\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nregmap_write(rt5677->regmap, RT5677_RESET, 0x10ec);\r\ngpiod_set_value_cansleep(rt5677->pow_ldo2, 0);\r\ngpiod_set_value_cansleep(rt5677->reset_pin, 1);\r\nreturn 0;\r\n}\r\nstatic int rt5677_suspend(struct snd_soc_codec *codec)\r\n{\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nif (!rt5677->dsp_vad_en) {\r\nregcache_cache_only(rt5677->regmap, true);\r\nregcache_mark_dirty(rt5677->regmap);\r\ngpiod_set_value_cansleep(rt5677->pow_ldo2, 0);\r\ngpiod_set_value_cansleep(rt5677->reset_pin, 1);\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_resume(struct snd_soc_codec *codec)\r\n{\r\nstruct rt5677_priv *rt5677 = snd_soc_codec_get_drvdata(codec);\r\nif (!rt5677->dsp_vad_en) {\r\nrt5677->pll_src = 0;\r\nrt5677->pll_in = 0;\r\nrt5677->pll_out = 0;\r\ngpiod_set_value_cansleep(rt5677->pow_ldo2, 1);\r\ngpiod_set_value_cansleep(rt5677->reset_pin, 0);\r\nif (rt5677->pow_ldo2 || rt5677->reset_pin)\r\nmsleep(10);\r\nregcache_cache_only(rt5677->regmap, false);\r\nregcache_sync(rt5677->regmap);\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_read(void *context, unsigned int reg, unsigned int *val)\r\n{\r\nstruct i2c_client *client = context;\r\nstruct rt5677_priv *rt5677 = i2c_get_clientdata(client);\r\nif (rt5677->is_dsp_mode) {\r\nif (reg > 0xff) {\r\nmutex_lock(&rt5677->dsp_pri_lock);\r\nrt5677_dsp_mode_i2c_write(rt5677, RT5677_PRIV_INDEX,\r\nreg & 0xff);\r\nrt5677_dsp_mode_i2c_read(rt5677, RT5677_PRIV_DATA, val);\r\nmutex_unlock(&rt5677->dsp_pri_lock);\r\n} else {\r\nrt5677_dsp_mode_i2c_read(rt5677, reg, val);\r\n}\r\n} else {\r\nregmap_read(rt5677->regmap_physical, reg, val);\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5677_write(void *context, unsigned int reg, unsigned int val)\r\n{\r\nstruct i2c_client *client = context;\r\nstruct rt5677_priv *rt5677 = i2c_get_clientdata(client);\r\nif (rt5677->is_dsp_mode) {\r\nif (reg > 0xff) {\r\nmutex_lock(&rt5677->dsp_pri_lock);\r\nrt5677_dsp_mode_i2c_write(rt5677, RT5677_PRIV_INDEX,\r\nreg & 0xff);\r\nrt5677_dsp_mode_i2c_write(rt5677, RT5677_PRIV_DATA,\r\nval);\r\nmutex_unlock(&rt5677->dsp_pri_lock);\r\n} else {\r\nrt5677_dsp_mode_i2c_write(rt5677, reg, val);\r\n}\r\n} else {\r\nregmap_write(rt5677->regmap_physical, reg, val);\r\n}\r\nreturn 0;\r\n}\r\nstatic void rt5677_read_acpi_properties(struct rt5677_priv *rt5677,\r\nstruct device *dev)\r\n{\r\nint ret;\r\nu32 val;\r\nret = acpi_dev_add_driver_gpios(ACPI_COMPANION(dev),\r\nbdw_rt5677_gpios);\r\nif (ret)\r\ndev_warn(dev, "Failed to add driver gpios\n");\r\nif (!device_property_read_u32(dev, "DCLK", &val))\r\nrt5677->pdata.dmic2_clk_pin = val;\r\nrt5677->pdata.in1_diff = device_property_read_bool(dev, "IN1");\r\nrt5677->pdata.in2_diff = device_property_read_bool(dev, "IN2");\r\nrt5677->pdata.lout1_diff = device_property_read_bool(dev, "OUT1");\r\nrt5677->pdata.lout2_diff = device_property_read_bool(dev, "OUT2");\r\nrt5677->pdata.lout3_diff = device_property_read_bool(dev, "OUT3");\r\ndevice_property_read_u32(dev, "JD1", &rt5677->pdata.jd1_gpio);\r\ndevice_property_read_u32(dev, "JD2", &rt5677->pdata.jd2_gpio);\r\ndevice_property_read_u32(dev, "JD3", &rt5677->pdata.jd3_gpio);\r\n}\r\nstatic void rt5677_read_device_properties(struct rt5677_priv *rt5677,\r\nstruct device *dev)\r\n{\r\nrt5677->pdata.in1_diff = device_property_read_bool(dev,\r\n"realtek,in1-differential");\r\nrt5677->pdata.in2_diff = device_property_read_bool(dev,\r\n"realtek,in2-differential");\r\nrt5677->pdata.lout1_diff = device_property_read_bool(dev,\r\n"realtek,lout1-differential");\r\nrt5677->pdata.lout2_diff = device_property_read_bool(dev,\r\n"realtek,lout2-differential");\r\nrt5677->pdata.lout3_diff = device_property_read_bool(dev,\r\n"realtek,lout3-differential");\r\ndevice_property_read_u8_array(dev, "realtek,gpio-config",\r\nrt5677->pdata.gpio_config, RT5677_GPIO_NUM);\r\ndevice_property_read_u32(dev, "realtek,jd1-gpio",\r\n&rt5677->pdata.jd1_gpio);\r\ndevice_property_read_u32(dev, "realtek,jd2-gpio",\r\n&rt5677->pdata.jd2_gpio);\r\ndevice_property_read_u32(dev, "realtek,jd3-gpio",\r\n&rt5677->pdata.jd3_gpio);\r\n}\r\nstatic int rt5677_init_irq(struct i2c_client *i2c)\r\n{\r\nint ret;\r\nstruct rt5677_priv *rt5677 = i2c_get_clientdata(i2c);\r\nif (!rt5677->pdata.jd1_gpio &&\r\n!rt5677->pdata.jd2_gpio &&\r\n!rt5677->pdata.jd3_gpio)\r\nreturn 0;\r\nif (!i2c->irq) {\r\ndev_err(&i2c->dev, "No interrupt specified\n");\r\nreturn -EINVAL;\r\n}\r\nret = regmap_add_irq_chip(rt5677->regmap, i2c->irq,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING | IRQF_ONESHOT, 0,\r\n&rt5677_irq_chip, &rt5677->irq_data);\r\nif (ret != 0) {\r\ndev_err(&i2c->dev, "Failed to register IRQ chip: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void rt5677_free_irq(struct i2c_client *i2c)\r\n{\r\nstruct rt5677_priv *rt5677 = i2c_get_clientdata(i2c);\r\nif (rt5677->irq_data)\r\nregmap_del_irq_chip(i2c->irq, rt5677->irq_data);\r\n}\r\nstatic int rt5677_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct rt5677_platform_data *pdata = dev_get_platdata(&i2c->dev);\r\nstruct rt5677_priv *rt5677;\r\nint ret;\r\nunsigned int val;\r\nrt5677 = devm_kzalloc(&i2c->dev, sizeof(struct rt5677_priv),\r\nGFP_KERNEL);\r\nif (rt5677 == NULL)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(i2c, rt5677);\r\nrt5677->type = id->driver_data;\r\nif (pdata)\r\nrt5677->pdata = *pdata;\r\nelse if (i2c->dev.of_node)\r\nrt5677_read_device_properties(rt5677, &i2c->dev);\r\nelse if (ACPI_HANDLE(&i2c->dev))\r\nrt5677_read_acpi_properties(rt5677, &i2c->dev);\r\nelse\r\nreturn -EINVAL;\r\nrt5677->pow_ldo2 = devm_gpiod_get_optional(&i2c->dev,\r\n"realtek,pow-ldo2", GPIOD_OUT_HIGH);\r\nif (IS_ERR(rt5677->pow_ldo2)) {\r\nret = PTR_ERR(rt5677->pow_ldo2);\r\ndev_err(&i2c->dev, "Failed to request POW_LDO2: %d\n", ret);\r\nreturn ret;\r\n}\r\nrt5677->reset_pin = devm_gpiod_get_optional(&i2c->dev,\r\n"realtek,reset", GPIOD_OUT_LOW);\r\nif (IS_ERR(rt5677->reset_pin)) {\r\nret = PTR_ERR(rt5677->reset_pin);\r\ndev_err(&i2c->dev, "Failed to request RESET: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (rt5677->pow_ldo2 || rt5677->reset_pin) {\r\nmsleep(10);\r\n}\r\nrt5677->regmap_physical = devm_regmap_init_i2c(i2c,\r\n&rt5677_regmap_physical);\r\nif (IS_ERR(rt5677->regmap_physical)) {\r\nret = PTR_ERR(rt5677->regmap_physical);\r\ndev_err(&i2c->dev, "Failed to allocate register map: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nrt5677->regmap = devm_regmap_init(&i2c->dev, NULL, i2c, &rt5677_regmap);\r\nif (IS_ERR(rt5677->regmap)) {\r\nret = PTR_ERR(rt5677->regmap);\r\ndev_err(&i2c->dev, "Failed to allocate register map: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nregmap_read(rt5677->regmap, RT5677_VENDOR_ID2, &val);\r\nif (val != RT5677_DEVICE_ID) {\r\ndev_err(&i2c->dev,\r\n"Device with ID register %#x is not rt5677\n", val);\r\nreturn -ENODEV;\r\n}\r\nregmap_write(rt5677->regmap, RT5677_RESET, 0x10ec);\r\nret = regmap_register_patch(rt5677->regmap, init_list,\r\nARRAY_SIZE(init_list));\r\nif (ret != 0)\r\ndev_warn(&i2c->dev, "Failed to apply regmap patch: %d\n", ret);\r\nif (rt5677->pdata.in1_diff)\r\nregmap_update_bits(rt5677->regmap, RT5677_IN1,\r\nRT5677_IN_DF1, RT5677_IN_DF1);\r\nif (rt5677->pdata.in2_diff)\r\nregmap_update_bits(rt5677->regmap, RT5677_IN1,\r\nRT5677_IN_DF2, RT5677_IN_DF2);\r\nif (rt5677->pdata.lout1_diff)\r\nregmap_update_bits(rt5677->regmap, RT5677_LOUT1,\r\nRT5677_LOUT1_L_DF, RT5677_LOUT1_L_DF);\r\nif (rt5677->pdata.lout2_diff)\r\nregmap_update_bits(rt5677->regmap, RT5677_LOUT1,\r\nRT5677_LOUT2_L_DF, RT5677_LOUT2_L_DF);\r\nif (rt5677->pdata.lout3_diff)\r\nregmap_update_bits(rt5677->regmap, RT5677_LOUT1,\r\nRT5677_LOUT3_L_DF, RT5677_LOUT3_L_DF);\r\nif (rt5677->pdata.dmic2_clk_pin == RT5677_DMIC_CLK2) {\r\nregmap_update_bits(rt5677->regmap, RT5677_GEN_CTRL2,\r\nRT5677_GPIO5_FUNC_MASK,\r\nRT5677_GPIO5_FUNC_DMIC);\r\nregmap_update_bits(rt5677->regmap, RT5677_GPIO_CTRL2,\r\nRT5677_GPIO5_DIR_MASK,\r\nRT5677_GPIO5_DIR_OUT);\r\n}\r\nif (rt5677->pdata.micbias1_vdd_3v3)\r\nregmap_update_bits(rt5677->regmap, RT5677_MICBIAS,\r\nRT5677_MICBIAS1_CTRL_VDD_MASK,\r\nRT5677_MICBIAS1_CTRL_VDD_3_3V);\r\nrt5677_init_gpio(i2c);\r\nrt5677_init_irq(i2c);\r\nreturn snd_soc_register_codec(&i2c->dev, &soc_codec_dev_rt5677,\r\nrt5677_dai, ARRAY_SIZE(rt5677_dai));\r\n}\r\nstatic int rt5677_i2c_remove(struct i2c_client *i2c)\r\n{\r\nsnd_soc_unregister_codec(&i2c->dev);\r\nrt5677_free_irq(i2c);\r\nrt5677_free_gpio(i2c);\r\nreturn 0;\r\n}

static int vbi_queue_setup(struct vb2_queue *vq,\r\nunsigned int *nbuffers, unsigned int *nplanes,\r\nunsigned int sizes[], struct device *alloc_devs[])\r\n{\r\nstruct em28xx *dev = vb2_get_drv_priv(vq);\r\nstruct em28xx_v4l2 *v4l2 = dev->v4l2;\r\nunsigned long size = v4l2->vbi_width * v4l2->vbi_height * 2;\r\nif (*nbuffers < 2)\r\n*nbuffers = 2;\r\nif (*nplanes) {\r\nif (sizes[0] < size)\r\nreturn -EINVAL;\r\nsize = sizes[0];\r\n}\r\n*nplanes = 1;\r\nsizes[0] = size;\r\nreturn 0;\r\n}\r\nstatic int vbi_buffer_prepare(struct vb2_buffer *vb)\r\n{\r\nstruct em28xx *dev = vb2_get_drv_priv(vb->vb2_queue);\r\nstruct em28xx_v4l2 *v4l2 = dev->v4l2;\r\nunsigned long size;\r\nsize = v4l2->vbi_width * v4l2->vbi_height * 2;\r\nif (vb2_plane_size(vb, 0) < size) {\r\ndev_info(&dev->intf->dev,\r\n"%s data will not fit into plane (%lu < %lu)\n",\r\n__func__, vb2_plane_size(vb, 0), size);\r\nreturn -EINVAL;\r\n}\r\nvb2_set_plane_payload(vb, 0, size);\r\nreturn 0;\r\n}\r\nstatic void\r\nvbi_buffer_queue(struct vb2_buffer *vb)\r\n{\r\nstruct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb);\r\nstruct em28xx *dev = vb2_get_drv_priv(vb->vb2_queue);\r\nstruct em28xx_buffer *buf =\r\ncontainer_of(vbuf, struct em28xx_buffer, vb);\r\nstruct em28xx_dmaqueue *vbiq = &dev->vbiq;\r\nunsigned long flags = 0;\r\nbuf->mem = vb2_plane_vaddr(vb, 0);\r\nbuf->length = vb2_plane_size(vb, 0);\r\nspin_lock_irqsave(&dev->slock, flags);\r\nlist_add_tail(&buf->list, &vbiq->active);\r\nspin_unlock_irqrestore(&dev->slock, flags);\r\n}

static void __init\r\nsio_init_irq(void)\r\n{\r\nif (alpha_using_srm)\r\nalpha_mv.device_interrupt = srm_device_interrupt;\r\ninit_i8259a_irqs();\r\ncommon_init_isa_dma();\r\n}\r\nstatic inline void __init\r\nalphabook1_init_arch(void)\r\n{\r\nscreen_info.orig_y = 37;\r\nscreen_info.orig_video_cols = 100;\r\nscreen_info.orig_video_lines = 37;\r\nlca_init_arch();\r\n}\r\nstatic void __init\r\nsio_pci_route(void)\r\n{\r\nunsigned int orig_route_tab;\r\npci_bus_read_config_dword(pci_isa_hose->bus, PCI_DEVFN(7, 0), 0x60,\r\n&orig_route_tab);\r\nprintk("%s: PIRQ original 0x%x new 0x%x\n", __func__,\r\norig_route_tab, alpha_mv.sys.sio.route_tab);\r\n#if defined(ALPHA_RESTORE_SRM_SETUP)\r\nsaved_config.orig_route_tab = orig_route_tab;\r\n#endif\r\npci_bus_write_config_dword(pci_isa_hose->bus, PCI_DEVFN(7, 0), 0x60,\r\nalpha_mv.sys.sio.route_tab);\r\n}\r\nstatic unsigned int __init\r\nsio_collect_irq_levels(void)\r\n{\r\nunsigned int level_bits = 0;\r\nstruct pci_dev *dev = NULL;\r\nfor_each_pci_dev(dev) {\r\nif ((dev->class >> 16 == PCI_BASE_CLASS_BRIDGE) &&\r\n(dev->class >> 8 != PCI_CLASS_BRIDGE_PCMCIA))\r\ncontinue;\r\nif (dev->irq)\r\nlevel_bits |= (1 << dev->irq);\r\n}\r\nreturn level_bits;\r\n}\r\nstatic void __init\r\nsio_fixup_irq_levels(unsigned int level_bits)\r\n{\r\nunsigned int old_level_bits;\r\nold_level_bits = inb(0x4d0) | (inb(0x4d1) << 8);\r\nlevel_bits |= (old_level_bits & 0x71ff);\r\noutb((level_bits >> 0) & 0xff, 0x4d0);\r\noutb((level_bits >> 8) & 0xff, 0x4d1);\r\n}\r\nstatic inline int __init\r\nnoname_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstatic char irq_tab[][5] __initdata = {\r\n{ 3, 3, 3, 3, 3},\r\n{-1, -1, -1, -1, -1},\r\n{ 2, 2, -1, -1, -1},\r\n{-1, -1, -1, -1, -1},\r\n{-1, -1, -1, -1, -1},\r\n{ 0, 0, 2, 1, 0},\r\n{ 1, 1, 0, 2, 1},\r\n{ 2, 2, 1, 0, 2},\r\n{ 0, 0, 0, 0, 0},\r\n};\r\nconst long min_idsel = 6, max_idsel = 14, irqs_per_slot = 5;\r\nint irq = COMMON_TABLE_LOOKUP, tmp;\r\ntmp = __kernel_extbl(alpha_mv.sys.sio.route_tab, irq);\r\nreturn irq >= 0 ? tmp : -1;\r\n}\r\nstatic inline int __init\r\np2k_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstatic char irq_tab[][5] __initdata = {\r\n{ 0, 0, -1, -1, -1},\r\n{-1, -1, -1, -1, -1},\r\n{ 1, 1, 2, 3, 0},\r\n{ 2, 2, 3, 0, 1},\r\n{-1, -1, -1, -1, -1},\r\n{-1, -1, -1, -1, -1},\r\n{ 3, 3, -1, -1, -1},\r\n};\r\nconst long min_idsel = 6, max_idsel = 12, irqs_per_slot = 5;\r\nint irq = COMMON_TABLE_LOOKUP, tmp;\r\ntmp = __kernel_extbl(alpha_mv.sys.sio.route_tab, irq);\r\nreturn irq >= 0 ? tmp : -1;\r\n}\r\nstatic inline void __init\r\nnoname_init_pci(void)\r\n{\r\ncommon_init_pci();\r\nsio_pci_route();\r\nsio_fixup_irq_levels(sio_collect_irq_levels());\r\nif (pc873xx_probe() == -1) {\r\nprintk(KERN_ERR "Probing for PC873xx Super IO chip failed.\n");\r\n} else {\r\nprintk(KERN_INFO "Found %s Super IO chip at 0x%x\n",\r\npc873xx_get_model(), pc873xx_get_base());\r\n#if !defined(CONFIG_ALPHA_AVANTI)\r\npc873xx_enable_ide();\r\n#endif\r\npc873xx_enable_epp19();\r\n}\r\n}\r\nstatic inline void __init\r\nalphabook1_init_pci(void)\r\n{\r\nstruct pci_dev *dev;\r\nunsigned char orig, config;\r\ncommon_init_pci();\r\nsio_pci_route();\r\ndev = NULL;\r\nwhile ((dev = pci_get_device(PCI_VENDOR_ID_NCR, PCI_ANY_ID, dev))) {\r\nif (dev->device == PCI_DEVICE_ID_NCR_53C810\r\n|| dev->device == PCI_DEVICE_ID_NCR_53C815\r\n|| dev->device == PCI_DEVICE_ID_NCR_53C820\r\n|| dev->device == PCI_DEVICE_ID_NCR_53C825) {\r\nunsigned long io_port;\r\nunsigned char ctest4;\r\nio_port = dev->resource[0].start;\r\nctest4 = inb(io_port+0x21);\r\nif (!(ctest4 & 0x80)) {\r\nprintk("AlphaBook1 NCR init: setting"\r\n" burst disable\n");\r\noutb(ctest4 | 0x80, io_port+0x21);\r\n}\r\n}\r\n}\r\nsio_fixup_irq_levels(0);\r\noutb(0x0f, 0x3ce); orig = inb(0x3cf);\r\noutb(0x0f, 0x3ce); outb(0x05, 0x3cf);\r\noutb(0x0b, 0x3ce); config = inb(0x3cf);\r\nif ((config & 0xc0) != 0xc0) {\r\nprintk("AlphaBook1 VGA init: setting 1Mb memory\n");\r\nconfig |= 0xc0;\r\noutb(0x0b, 0x3ce); outb(config, 0x3cf);\r\n}\r\noutb(0x0f, 0x3ce); outb(orig, 0x3cf);\r\n}\r\nvoid\r\nsio_kill_arch(int mode)\r\n{\r\n#if defined(ALPHA_RESTORE_SRM_SETUP)\r\npci_bus_write_config_dword(pci_isa_hose->bus, PCI_DEVFN(7, 0), 0x60,\r\nsaved_config.orig_route_tab);\r\n#endif\r\n}

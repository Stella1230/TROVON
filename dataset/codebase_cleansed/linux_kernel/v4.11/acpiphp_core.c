int acpiphp_register_attention(struct acpiphp_attention_info *info)\r\n{\r\nint retval = -EINVAL;\r\nif (info && info->owner && info->set_attn &&\r\ninfo->get_attn && !attention_info) {\r\nretval = 0;\r\nattention_info = info;\r\n}\r\nreturn retval;\r\n}\r\nint acpiphp_unregister_attention(struct acpiphp_attention_info *info)\r\n{\r\nint retval = -EINVAL;\r\nif (info && attention_info == info) {\r\nattention_info = NULL;\r\nretval = 0;\r\n}\r\nreturn retval;\r\n}\r\nstatic int enable_slot(struct hotplug_slot *hotplug_slot)\r\n{\r\nstruct slot *slot = hotplug_slot->private;\r\npr_debug("%s - physical_slot = %s\n", __func__, slot_name(slot));\r\nreturn acpiphp_enable_slot(slot->acpi_slot);\r\n}\r\nstatic int disable_slot(struct hotplug_slot *hotplug_slot)\r\n{\r\nstruct slot *slot = hotplug_slot->private;\r\npr_debug("%s - physical_slot = %s\n", __func__, slot_name(slot));\r\nreturn acpiphp_disable_slot(slot->acpi_slot);\r\n}\r\nstatic int set_attention_status(struct hotplug_slot *hotplug_slot, u8 status)\r\n{\r\nint retval = -ENODEV;\r\npr_debug("%s - physical_slot = %s\n", __func__,\r\nhotplug_slot_name(hotplug_slot));\r\nif (attention_info && try_module_get(attention_info->owner)) {\r\nretval = attention_info->set_attn(hotplug_slot, status);\r\nmodule_put(attention_info->owner);\r\n} else\r\nattention_info = NULL;\r\nreturn retval;\r\n}\r\nstatic int get_power_status(struct hotplug_slot *hotplug_slot, u8 *value)\r\n{\r\nstruct slot *slot = hotplug_slot->private;\r\npr_debug("%s - physical_slot = %s\n", __func__, slot_name(slot));\r\n*value = acpiphp_get_power_status(slot->acpi_slot);\r\nreturn 0;\r\n}\r\nstatic int get_attention_status(struct hotplug_slot *hotplug_slot, u8 *value)\r\n{\r\nint retval = -EINVAL;\r\npr_debug("%s - physical_slot = %s\n", __func__,\r\nhotplug_slot_name(hotplug_slot));\r\nif (attention_info && try_module_get(attention_info->owner)) {\r\nretval = attention_info->get_attn(hotplug_slot, value);\r\nmodule_put(attention_info->owner);\r\n} else\r\nattention_info = NULL;\r\nreturn retval;\r\n}\r\nstatic int get_latch_status(struct hotplug_slot *hotplug_slot, u8 *value)\r\n{\r\nstruct slot *slot = hotplug_slot->private;\r\npr_debug("%s - physical_slot = %s\n", __func__, slot_name(slot));\r\n*value = acpiphp_get_latch_status(slot->acpi_slot);\r\nreturn 0;\r\n}\r\nstatic int get_adapter_status(struct hotplug_slot *hotplug_slot, u8 *value)\r\n{\r\nstruct slot *slot = hotplug_slot->private;\r\npr_debug("%s - physical_slot = %s\n", __func__, slot_name(slot));\r\n*value = acpiphp_get_adapter_status(slot->acpi_slot);\r\nreturn 0;\r\n}\r\nstatic void release_slot(struct hotplug_slot *hotplug_slot)\r\n{\r\nstruct slot *slot = hotplug_slot->private;\r\npr_debug("%s - physical_slot = %s\n", __func__, slot_name(slot));\r\nkfree(slot->hotplug_slot);\r\nkfree(slot);\r\n}\r\nint acpiphp_register_hotplug_slot(struct acpiphp_slot *acpiphp_slot,\r\nunsigned int sun)\r\n{\r\nstruct slot *slot;\r\nint retval = -ENOMEM;\r\nchar name[SLOT_NAME_SIZE];\r\nslot = kzalloc(sizeof(*slot), GFP_KERNEL);\r\nif (!slot)\r\ngoto error;\r\nslot->hotplug_slot = kzalloc(sizeof(*slot->hotplug_slot), GFP_KERNEL);\r\nif (!slot->hotplug_slot)\r\ngoto error_slot;\r\nslot->hotplug_slot->info = &slot->info;\r\nslot->hotplug_slot->private = slot;\r\nslot->hotplug_slot->release = &release_slot;\r\nslot->hotplug_slot->ops = &acpi_hotplug_slot_ops;\r\nslot->acpi_slot = acpiphp_slot;\r\nslot->hotplug_slot->info->power_status = acpiphp_get_power_status(slot->acpi_slot);\r\nslot->hotplug_slot->info->attention_status = 0;\r\nslot->hotplug_slot->info->latch_status = acpiphp_get_latch_status(slot->acpi_slot);\r\nslot->hotplug_slot->info->adapter_status = acpiphp_get_adapter_status(slot->acpi_slot);\r\nacpiphp_slot->slot = slot;\r\nslot->sun = sun;\r\nsnprintf(name, SLOT_NAME_SIZE, "%u", sun);\r\nretval = pci_hp_register(slot->hotplug_slot, acpiphp_slot->bus,\r\nacpiphp_slot->device, name);\r\nif (retval == -EBUSY)\r\ngoto error_hpslot;\r\nif (retval) {\r\npr_err("pci_hp_register failed with error %d\n", retval);\r\ngoto error_hpslot;\r\n}\r\npr_info("Slot [%s] registered\n", slot_name(slot));\r\nreturn 0;\r\nerror_hpslot:\r\nkfree(slot->hotplug_slot);\r\nerror_slot:\r\nkfree(slot);\r\nerror:\r\nreturn retval;\r\n}\r\nvoid acpiphp_unregister_hotplug_slot(struct acpiphp_slot *acpiphp_slot)\r\n{\r\nstruct slot *slot = acpiphp_slot->slot;\r\nint retval = 0;\r\npr_info("Slot [%s] unregistered\n", slot_name(slot));\r\nretval = pci_hp_deregister(slot->hotplug_slot);\r\nif (retval)\r\npr_err("pci_hp_deregister failed with error %d\n", retval);\r\n}\r\nvoid __init acpiphp_init(void)\r\n{\r\npr_info(DRIVER_DESC " version: " DRIVER_VERSION "%s\n",\r\nacpiphp_disabled ? ", disabled by user; please report a bug"\r\n: "");\r\n}

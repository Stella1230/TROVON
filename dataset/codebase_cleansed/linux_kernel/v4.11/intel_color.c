static bool crtc_state_is_legacy(struct drm_crtc_state *state)\r\n{\r\nreturn !state->degamma_lut &&\r\n!state->ctm &&\r\nstate->gamma_lut &&\r\nstate->gamma_lut->length == LEGACY_LUT_LENGTH;\r\n}\r\nstatic void ctm_mult_by_limited(uint64_t *result, int64_t *input)\r\n{\r\nint i;\r\nfor (i = 0; i < 9; i++)\r\nresult[i] = 0;\r\nfor (i = 0; i < 3; i++) {\r\nint64_t user_coeff = input[i * 3 + i];\r\nuint64_t limited_coeff = CTM_COEFF_LIMITED_RANGE >> 2;\r\nuint64_t abs_coeff = clamp_val(CTM_COEFF_ABS(user_coeff),\r\n0,\r\nCTM_COEFF_4_0 - 1) >> 2;\r\nresult[i * 3 + i] = (limited_coeff * abs_coeff) >> 27;\r\nif (CTM_COEFF_NEGATIVE(user_coeff))\r\nresult[i * 3 + i] |= CTM_COEFF_SIGN;\r\n}\r\n}\r\nstatic void i9xx_load_csc_matrix(struct drm_crtc_state *crtc_state)\r\n{\r\nstruct drm_crtc *crtc = crtc_state->crtc;\r\nstruct drm_i915_private *dev_priv = to_i915(crtc->dev);\r\nstruct intel_crtc *intel_crtc = to_intel_crtc(crtc);\r\nint i, pipe = intel_crtc->pipe;\r\nuint16_t coeffs[9] = { 0, };\r\nstruct intel_crtc_state *intel_crtc_state = to_intel_crtc_state(crtc_state);\r\nif (crtc_state->ctm) {\r\nstruct drm_color_ctm *ctm =\r\n(struct drm_color_ctm *)crtc_state->ctm->data;\r\nuint64_t input[9] = { 0, };\r\nif (intel_crtc_state->limited_color_range) {\r\nctm_mult_by_limited(input, ctm->matrix);\r\n} else {\r\nfor (i = 0; i < ARRAY_SIZE(input); i++)\r\ninput[i] = ctm->matrix[i];\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(coeffs); i++) {\r\nuint64_t abs_coeff = ((1ULL << 63) - 1) & input[i];\r\nabs_coeff = clamp_val(abs_coeff, 0, CTM_COEFF_4_0 - 1);\r\nif (CTM_COEFF_NEGATIVE(input[i]))\r\ncoeffs[i] |= 1 << 15;\r\nif (abs_coeff < CTM_COEFF_0_125)\r\ncoeffs[i] |= (3 << 12) |\r\nI9XX_CSC_COEFF_FP(abs_coeff, 12);\r\nelse if (abs_coeff < CTM_COEFF_0_25)\r\ncoeffs[i] |= (2 << 12) |\r\nI9XX_CSC_COEFF_FP(abs_coeff, 11);\r\nelse if (abs_coeff < CTM_COEFF_0_5)\r\ncoeffs[i] |= (1 << 12) |\r\nI9XX_CSC_COEFF_FP(abs_coeff, 10);\r\nelse if (abs_coeff < CTM_COEFF_1_0)\r\ncoeffs[i] |= I9XX_CSC_COEFF_FP(abs_coeff, 9);\r\nelse if (abs_coeff < CTM_COEFF_2_0)\r\ncoeffs[i] |= (7 << 12) |\r\nI9XX_CSC_COEFF_FP(abs_coeff, 8);\r\nelse\r\ncoeffs[i] |= (6 << 12) |\r\nI9XX_CSC_COEFF_FP(abs_coeff, 7);\r\n}\r\n} else {\r\nfor (i = 0; i < 3; i++) {\r\nif (intel_crtc_state->limited_color_range)\r\ncoeffs[i * 3 + i] =\r\nI9XX_CSC_COEFF_LIMITED_RANGE;\r\nelse\r\ncoeffs[i * 3 + i] = I9XX_CSC_COEFF_1_0;\r\n}\r\n}\r\nI915_WRITE(PIPE_CSC_COEFF_RY_GY(pipe), coeffs[0] << 16 | coeffs[1]);\r\nI915_WRITE(PIPE_CSC_COEFF_BY(pipe), coeffs[2] << 16);\r\nI915_WRITE(PIPE_CSC_COEFF_RU_GU(pipe), coeffs[3] << 16 | coeffs[4]);\r\nI915_WRITE(PIPE_CSC_COEFF_BU(pipe), coeffs[5] << 16);\r\nI915_WRITE(PIPE_CSC_COEFF_RV_GV(pipe), coeffs[6] << 16 | coeffs[7]);\r\nI915_WRITE(PIPE_CSC_COEFF_BV(pipe), coeffs[8] << 16);\r\nI915_WRITE(PIPE_CSC_PREOFF_HI(pipe), 0);\r\nI915_WRITE(PIPE_CSC_PREOFF_ME(pipe), 0);\r\nI915_WRITE(PIPE_CSC_PREOFF_LO(pipe), 0);\r\nif (INTEL_GEN(dev_priv) > 6) {\r\nuint16_t postoff = 0;\r\nif (intel_crtc_state->limited_color_range)\r\npostoff = (16 * (1 << 12) / 255) & 0x1fff;\r\nI915_WRITE(PIPE_CSC_POSTOFF_HI(pipe), postoff);\r\nI915_WRITE(PIPE_CSC_POSTOFF_ME(pipe), postoff);\r\nI915_WRITE(PIPE_CSC_POSTOFF_LO(pipe), postoff);\r\nI915_WRITE(PIPE_CSC_MODE(pipe), 0);\r\n} else {\r\nuint32_t mode = CSC_MODE_YUV_TO_RGB;\r\nif (intel_crtc_state->limited_color_range)\r\nmode |= CSC_BLACK_SCREEN_OFFSET;\r\nI915_WRITE(PIPE_CSC_MODE(pipe), mode);\r\n}\r\n}\r\nstatic void cherryview_load_csc_matrix(struct drm_crtc_state *state)\r\n{\r\nstruct drm_crtc *crtc = state->crtc;\r\nstruct drm_device *dev = crtc->dev;\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nint pipe = to_intel_crtc(crtc)->pipe;\r\nuint32_t mode;\r\nif (state->ctm) {\r\nstruct drm_color_ctm *ctm =\r\n(struct drm_color_ctm *) state->ctm->data;\r\nuint16_t coeffs[9] = { 0, };\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(coeffs); i++) {\r\nuint64_t abs_coeff =\r\n((1ULL << 63) - 1) & ctm->matrix[i];\r\nabs_coeff += 1 << (32 - 13);\r\nabs_coeff = clamp_val(abs_coeff, 0, CTM_COEFF_8_0 - 1);\r\nif (ctm->matrix[i] & (1ULL << 63))\r\ncoeffs[i] = 1 << 15;\r\ncoeffs[i] |= ((abs_coeff >> 32) & 7) << 12;\r\ncoeffs[i] |= (abs_coeff >> 20) & 0xfff;\r\n}\r\nI915_WRITE(CGM_PIPE_CSC_COEFF01(pipe),\r\ncoeffs[1] << 16 | coeffs[0]);\r\nI915_WRITE(CGM_PIPE_CSC_COEFF23(pipe),\r\ncoeffs[3] << 16 | coeffs[2]);\r\nI915_WRITE(CGM_PIPE_CSC_COEFF45(pipe),\r\ncoeffs[5] << 16 | coeffs[4]);\r\nI915_WRITE(CGM_PIPE_CSC_COEFF67(pipe),\r\ncoeffs[7] << 16 | coeffs[6]);\r\nI915_WRITE(CGM_PIPE_CSC_COEFF8(pipe), coeffs[8]);\r\n}\r\nmode = (state->ctm ? CGM_PIPE_MODE_CSC : 0);\r\nif (!crtc_state_is_legacy(state)) {\r\nmode |= (state->degamma_lut ? CGM_PIPE_MODE_DEGAMMA : 0) |\r\n(state->gamma_lut ? CGM_PIPE_MODE_GAMMA : 0);\r\n}\r\nI915_WRITE(CGM_PIPE_MODE(pipe), mode);\r\n}\r\nvoid intel_color_set_csc(struct drm_crtc_state *crtc_state)\r\n{\r\nstruct drm_device *dev = crtc_state->crtc->dev;\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nif (dev_priv->display.load_csc_matrix)\r\ndev_priv->display.load_csc_matrix(crtc_state);\r\n}\r\nstatic void i9xx_load_luts_internal(struct drm_crtc *crtc,\r\nstruct drm_property_blob *blob,\r\nstruct intel_crtc_state *crtc_state)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nstruct intel_crtc *intel_crtc = to_intel_crtc(crtc);\r\nenum pipe pipe = intel_crtc->pipe;\r\nint i;\r\nif (HAS_GMCH_DISPLAY(dev_priv)) {\r\nif (intel_crtc_has_type(crtc_state, INTEL_OUTPUT_DSI))\r\nassert_dsi_pll_enabled(dev_priv);\r\nelse\r\nassert_pll_enabled(dev_priv, pipe);\r\n}\r\nif (blob) {\r\nstruct drm_color_lut *lut = (struct drm_color_lut *) blob->data;\r\nfor (i = 0; i < 256; i++) {\r\nuint32_t word =\r\n(drm_color_lut_extract(lut[i].red, 8) << 16) |\r\n(drm_color_lut_extract(lut[i].green, 8) << 8) |\r\ndrm_color_lut_extract(lut[i].blue, 8);\r\nif (HAS_GMCH_DISPLAY(dev_priv))\r\nI915_WRITE(PALETTE(pipe, i), word);\r\nelse\r\nI915_WRITE(LGC_PALETTE(pipe, i), word);\r\n}\r\n} else {\r\nfor (i = 0; i < 256; i++) {\r\nuint32_t word = (i << 16) | (i << 8) | i;\r\nif (HAS_GMCH_DISPLAY(dev_priv))\r\nI915_WRITE(PALETTE(pipe, i), word);\r\nelse\r\nI915_WRITE(LGC_PALETTE(pipe, i), word);\r\n}\r\n}\r\n}\r\nstatic void i9xx_load_luts(struct drm_crtc_state *crtc_state)\r\n{\r\ni9xx_load_luts_internal(crtc_state->crtc, crtc_state->gamma_lut,\r\nto_intel_crtc_state(crtc_state));\r\n}\r\nstatic void haswell_load_luts(struct drm_crtc_state *crtc_state)\r\n{\r\nstruct drm_crtc *crtc = crtc_state->crtc;\r\nstruct drm_device *dev = crtc->dev;\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nstruct intel_crtc *intel_crtc = to_intel_crtc(crtc);\r\nstruct intel_crtc_state *intel_crtc_state =\r\nto_intel_crtc_state(crtc_state);\r\nbool reenable_ips = false;\r\nif (IS_HASWELL(dev_priv) && intel_crtc_state->ips_enabled &&\r\n(intel_crtc_state->gamma_mode == GAMMA_MODE_MODE_SPLIT)) {\r\nhsw_disable_ips(intel_crtc);\r\nreenable_ips = true;\r\n}\r\nintel_crtc_state->gamma_mode = GAMMA_MODE_MODE_8BIT;\r\nI915_WRITE(GAMMA_MODE(intel_crtc->pipe), GAMMA_MODE_MODE_8BIT);\r\ni9xx_load_luts(crtc_state);\r\nif (reenable_ips)\r\nhsw_enable_ips(intel_crtc);\r\n}\r\nstatic void broadwell_load_luts(struct drm_crtc_state *state)\r\n{\r\nstruct drm_crtc *crtc = state->crtc;\r\nstruct drm_i915_private *dev_priv = to_i915(crtc->dev);\r\nstruct intel_crtc_state *intel_state = to_intel_crtc_state(state);\r\nenum pipe pipe = to_intel_crtc(crtc)->pipe;\r\nuint32_t i, lut_size = INTEL_INFO(dev_priv)->color.degamma_lut_size;\r\nif (crtc_state_is_legacy(state)) {\r\nhaswell_load_luts(state);\r\nreturn;\r\n}\r\nI915_WRITE(PREC_PAL_INDEX(pipe),\r\nPAL_PREC_SPLIT_MODE | PAL_PREC_AUTO_INCREMENT);\r\nif (state->degamma_lut) {\r\nstruct drm_color_lut *lut =\r\n(struct drm_color_lut *) state->degamma_lut->data;\r\nfor (i = 0; i < lut_size; i++) {\r\nuint32_t word =\r\ndrm_color_lut_extract(lut[i].red, 10) << 20 |\r\ndrm_color_lut_extract(lut[i].green, 10) << 10 |\r\ndrm_color_lut_extract(lut[i].blue, 10);\r\nI915_WRITE(PREC_PAL_DATA(pipe), word);\r\n}\r\n} else {\r\nfor (i = 0; i < lut_size; i++) {\r\nuint32_t v = (i * ((1 << 10) - 1)) / (lut_size - 1);\r\nI915_WRITE(PREC_PAL_DATA(pipe),\r\n(v << 20) | (v << 10) | v);\r\n}\r\n}\r\nif (state->gamma_lut) {\r\nstruct drm_color_lut *lut =\r\n(struct drm_color_lut *) state->gamma_lut->data;\r\nfor (i = 0; i < lut_size; i++) {\r\nuint32_t word =\r\n(drm_color_lut_extract(lut[i].red, 10) << 20) |\r\n(drm_color_lut_extract(lut[i].green, 10) << 10) |\r\ndrm_color_lut_extract(lut[i].blue, 10);\r\nI915_WRITE(PREC_PAL_DATA(pipe), word);\r\n}\r\nI915_WRITE(PREC_PAL_GC_MAX(pipe, 0),\r\ndrm_color_lut_extract(lut[i].red, 16));\r\nI915_WRITE(PREC_PAL_GC_MAX(pipe, 1),\r\ndrm_color_lut_extract(lut[i].green, 16));\r\nI915_WRITE(PREC_PAL_GC_MAX(pipe, 2),\r\ndrm_color_lut_extract(lut[i].blue, 16));\r\n} else {\r\nfor (i = 0; i < lut_size; i++) {\r\nuint32_t v = (i * ((1 << 10) - 1)) / (lut_size - 1);\r\nI915_WRITE(PREC_PAL_DATA(pipe),\r\n(v << 20) | (v << 10) | v);\r\n}\r\nI915_WRITE(PREC_PAL_GC_MAX(pipe, 0), (1 << 16) - 1);\r\nI915_WRITE(PREC_PAL_GC_MAX(pipe, 1), (1 << 16) - 1);\r\nI915_WRITE(PREC_PAL_GC_MAX(pipe, 2), (1 << 16) - 1);\r\n}\r\nintel_state->gamma_mode = GAMMA_MODE_MODE_SPLIT;\r\nI915_WRITE(GAMMA_MODE(pipe), GAMMA_MODE_MODE_SPLIT);\r\nPOSTING_READ(GAMMA_MODE(pipe));\r\nI915_WRITE(PREC_PAL_INDEX(pipe), 0);\r\n}\r\nstatic void cherryview_load_luts(struct drm_crtc_state *state)\r\n{\r\nstruct drm_crtc *crtc = state->crtc;\r\nstruct drm_i915_private *dev_priv = to_i915(crtc->dev);\r\nenum pipe pipe = to_intel_crtc(crtc)->pipe;\r\nstruct drm_color_lut *lut;\r\nuint32_t i, lut_size;\r\nuint32_t word0, word1;\r\nif (crtc_state_is_legacy(state)) {\r\nI915_WRITE(CGM_PIPE_MODE(pipe),\r\n(state->ctm ? CGM_PIPE_MODE_CSC : 0));\r\ni9xx_load_luts_internal(crtc, state->gamma_lut,\r\nto_intel_crtc_state(state));\r\nreturn;\r\n}\r\nif (state->degamma_lut) {\r\nlut = (struct drm_color_lut *) state->degamma_lut->data;\r\nlut_size = INTEL_INFO(dev_priv)->color.degamma_lut_size;\r\nfor (i = 0; i < lut_size; i++) {\r\nword0 =\r\n(drm_color_lut_extract(lut[i].green, 14) << 16) |\r\ndrm_color_lut_extract(lut[i].blue, 14);\r\nword1 = drm_color_lut_extract(lut[i].red, 14);\r\nI915_WRITE(CGM_PIPE_DEGAMMA(pipe, i, 0), word0);\r\nI915_WRITE(CGM_PIPE_DEGAMMA(pipe, i, 1), word1);\r\n}\r\n}\r\nif (state->gamma_lut) {\r\nlut = (struct drm_color_lut *) state->gamma_lut->data;\r\nlut_size = INTEL_INFO(dev_priv)->color.gamma_lut_size;\r\nfor (i = 0; i < lut_size; i++) {\r\nword0 =\r\n(drm_color_lut_extract(lut[i].green, 10) << 16) |\r\ndrm_color_lut_extract(lut[i].blue, 10);\r\nword1 = drm_color_lut_extract(lut[i].red, 10);\r\nI915_WRITE(CGM_PIPE_GAMMA(pipe, i, 0), word0);\r\nI915_WRITE(CGM_PIPE_GAMMA(pipe, i, 1), word1);\r\n}\r\n}\r\nI915_WRITE(CGM_PIPE_MODE(pipe),\r\n(state->ctm ? CGM_PIPE_MODE_CSC : 0) |\r\n(state->degamma_lut ? CGM_PIPE_MODE_DEGAMMA : 0) |\r\n(state->gamma_lut ? CGM_PIPE_MODE_GAMMA : 0));\r\ni9xx_load_luts_internal(crtc, NULL, to_intel_crtc_state(state));\r\n}\r\nvoid intel_color_load_luts(struct drm_crtc_state *crtc_state)\r\n{\r\nstruct drm_device *dev = crtc_state->crtc->dev;\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\ndev_priv->display.load_luts(crtc_state);\r\n}\r\nint intel_color_check(struct drm_crtc *crtc,\r\nstruct drm_crtc_state *crtc_state)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(crtc->dev);\r\nsize_t gamma_length, degamma_length;\r\ndegamma_length = INTEL_INFO(dev_priv)->color.degamma_lut_size *\r\nsizeof(struct drm_color_lut);\r\ngamma_length = INTEL_INFO(dev_priv)->color.gamma_lut_size *\r\nsizeof(struct drm_color_lut);\r\nif ((!crtc_state->degamma_lut ||\r\ncrtc_state->degamma_lut->length == degamma_length) &&\r\n(!crtc_state->gamma_lut ||\r\ncrtc_state->gamma_lut->length == gamma_length))\r\nreturn 0;\r\nif (!crtc_state->degamma_lut &&\r\ncrtc_state->gamma_lut &&\r\ncrtc_state->gamma_lut->length == LEGACY_LUT_LENGTH)\r\nreturn 0;\r\nreturn -EINVAL;\r\n}\r\nvoid intel_color_init(struct drm_crtc *crtc)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(crtc->dev);\r\ndrm_mode_crtc_set_gamma_size(crtc, 256);\r\nif (IS_CHERRYVIEW(dev_priv)) {\r\ndev_priv->display.load_csc_matrix = cherryview_load_csc_matrix;\r\ndev_priv->display.load_luts = cherryview_load_luts;\r\n} else if (IS_HASWELL(dev_priv)) {\r\ndev_priv->display.load_csc_matrix = i9xx_load_csc_matrix;\r\ndev_priv->display.load_luts = haswell_load_luts;\r\n} else if (IS_BROADWELL(dev_priv) || IS_SKYLAKE(dev_priv) ||\r\nIS_BROXTON(dev_priv) || IS_KABYLAKE(dev_priv)) {\r\ndev_priv->display.load_csc_matrix = i9xx_load_csc_matrix;\r\ndev_priv->display.load_luts = broadwell_load_luts;\r\n} else {\r\ndev_priv->display.load_luts = i9xx_load_luts;\r\n}\r\nif (INTEL_INFO(dev_priv)->color.degamma_lut_size != 0 &&\r\nINTEL_INFO(dev_priv)->color.gamma_lut_size != 0)\r\ndrm_crtc_enable_color_mgmt(crtc,\r\nINTEL_INFO(dev_priv)->color.degamma_lut_size,\r\ntrue,\r\nINTEL_INFO(dev_priv)->color.gamma_lut_size);\r\n}

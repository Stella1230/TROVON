static void write_state(struct trace_seq *s, int val)\r\n{\r\nconst char states[] = "SDTtZXxW";\r\nint found = 0;\r\nint i;\r\nfor (i = 0; i < (sizeof(states) - 1); i++) {\r\nif (!(val & (1 << i)))\r\ncontinue;\r\nif (found)\r\ntrace_seq_putc(s, '|');\r\nfound = 1;\r\ntrace_seq_putc(s, states[i]);\r\n}\r\nif (!found)\r\ntrace_seq_putc(s, 'R');\r\n}\r\nstatic void write_and_save_comm(struct format_field *field,\r\nstruct pevent_record *record,\r\nstruct trace_seq *s, int pid)\r\n{\r\nconst char *comm;\r\nint len;\r\ncomm = (char *)(record->data + field->offset);\r\nlen = s->len;\r\ntrace_seq_printf(s, "%.*s",\r\nfield->size, comm);\r\ntrace_seq_terminate(s);\r\ncomm = &s->buffer[len];\r\npevent_register_comm(field->event->pevent, comm, pid);\r\n}\r\nstatic int sched_wakeup_handler(struct trace_seq *s,\r\nstruct pevent_record *record,\r\nstruct event_format *event, void *context)\r\n{\r\nstruct format_field *field;\r\nunsigned long long val;\r\nif (pevent_get_field_val(s, event, "pid", record, &val, 1))\r\nreturn trace_seq_putc(s, '!');\r\nfield = pevent_find_any_field(event, "comm");\r\nif (field) {\r\nwrite_and_save_comm(field, record, s, val);\r\ntrace_seq_putc(s, ':');\r\n}\r\ntrace_seq_printf(s, "%lld", val);\r\nif (pevent_get_field_val(s, event, "prio", record, &val, 0) == 0)\r\ntrace_seq_printf(s, " [%lld]", val);\r\nif (pevent_get_field_val(s, event, "success", record, &val, 1) == 0)\r\ntrace_seq_printf(s, " success=%lld", val);\r\nif (pevent_get_field_val(s, event, "target_cpu", record, &val, 0) == 0)\r\ntrace_seq_printf(s, " CPU:%03llu", val);\r\nreturn 0;\r\n}\r\nstatic int sched_switch_handler(struct trace_seq *s,\r\nstruct pevent_record *record,\r\nstruct event_format *event, void *context)\r\n{\r\nstruct format_field *field;\r\nunsigned long long val;\r\nif (pevent_get_field_val(s, event, "prev_pid", record, &val, 1))\r\nreturn trace_seq_putc(s, '!');\r\nfield = pevent_find_any_field(event, "prev_comm");\r\nif (field) {\r\nwrite_and_save_comm(field, record, s, val);\r\ntrace_seq_putc(s, ':');\r\n}\r\ntrace_seq_printf(s, "%lld ", val);\r\nif (pevent_get_field_val(s, event, "prev_prio", record, &val, 0) == 0)\r\ntrace_seq_printf(s, "[%d] ", (int) val);\r\nif (pevent_get_field_val(s, event, "prev_state", record, &val, 0) == 0)\r\nwrite_state(s, val);\r\ntrace_seq_puts(s, " ==> ");\r\nif (pevent_get_field_val(s, event, "next_pid", record, &val, 1))\r\nreturn trace_seq_putc(s, '!');\r\nfield = pevent_find_any_field(event, "next_comm");\r\nif (field) {\r\nwrite_and_save_comm(field, record, s, val);\r\ntrace_seq_putc(s, ':');\r\n}\r\ntrace_seq_printf(s, "%lld", val);\r\nif (pevent_get_field_val(s, event, "next_prio", record, &val, 0) == 0)\r\ntrace_seq_printf(s, " [%d]", (int) val);\r\nreturn 0;\r\n}\r\nint PEVENT_PLUGIN_LOADER(struct pevent *pevent)\r\n{\r\npevent_register_event_handler(pevent, -1, "sched", "sched_switch",\r\nsched_switch_handler, NULL);\r\npevent_register_event_handler(pevent, -1, "sched", "sched_wakeup",\r\nsched_wakeup_handler, NULL);\r\npevent_register_event_handler(pevent, -1, "sched", "sched_wakeup_new",\r\nsched_wakeup_handler, NULL);\r\nreturn 0;\r\n}\r\nvoid PEVENT_PLUGIN_UNLOADER(struct pevent *pevent)\r\n{\r\npevent_unregister_event_handler(pevent, -1, "sched", "sched_switch",\r\nsched_switch_handler, NULL);\r\npevent_unregister_event_handler(pevent, -1, "sched", "sched_wakeup",\r\nsched_wakeup_handler, NULL);\r\npevent_unregister_event_handler(pevent, -1, "sched", "sched_wakeup_new",\r\nsched_wakeup_handler, NULL);\r\n}

static int cf_pit_set_periodic(struct clock_event_device *evt)\r\n{\r\n__raw_writew(MCFPIT_PCSR_DISABLE, TA(MCFPIT_PCSR));\r\n__raw_writew(PIT_CYCLES_PER_JIFFY, TA(MCFPIT_PMR));\r\n__raw_writew(MCFPIT_PCSR_EN | MCFPIT_PCSR_PIE |\r\nMCFPIT_PCSR_OVW | MCFPIT_PCSR_RLD |\r\nMCFPIT_PCSR_CLK64, TA(MCFPIT_PCSR));\r\nreturn 0;\r\n}\r\nstatic int cf_pit_set_oneshot(struct clock_event_device *evt)\r\n{\r\n__raw_writew(MCFPIT_PCSR_DISABLE, TA(MCFPIT_PCSR));\r\n__raw_writew(MCFPIT_PCSR_EN | MCFPIT_PCSR_PIE |\r\nMCFPIT_PCSR_OVW | MCFPIT_PCSR_CLK64, TA(MCFPIT_PCSR));\r\nreturn 0;\r\n}\r\nstatic int cf_pit_shutdown(struct clock_event_device *evt)\r\n{\r\n__raw_writew(MCFPIT_PCSR_DISABLE, TA(MCFPIT_PCSR));\r\nreturn 0;\r\n}\r\nstatic int cf_pit_next_event(unsigned long delta,\r\nstruct clock_event_device *evt)\r\n{\r\n__raw_writew(delta, TA(MCFPIT_PMR));\r\nreturn 0;\r\n}\r\nstatic irqreturn_t pit_tick(int irq, void *dummy)\r\n{\r\nstruct clock_event_device *evt = &cf_pit_clockevent;\r\nu16 pcsr;\r\npcsr = __raw_readw(TA(MCFPIT_PCSR));\r\n__raw_writew(pcsr | MCFPIT_PCSR_PIF, TA(MCFPIT_PCSR));\r\npit_cnt += PIT_CYCLES_PER_JIFFY;\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic u64 pit_read_clk(struct clocksource *cs)\r\n{\r\nunsigned long flags;\r\nu32 cycles;\r\nu16 pcntr;\r\nlocal_irq_save(flags);\r\npcntr = __raw_readw(TA(MCFPIT_PCNTR));\r\ncycles = pit_cnt;\r\nlocal_irq_restore(flags);\r\nreturn cycles + PIT_CYCLES_PER_JIFFY - pcntr;\r\n}\r\nvoid hw_timer_init(irq_handler_t handler)\r\n{\r\ncf_pit_clockevent.cpumask = cpumask_of(smp_processor_id());\r\ncf_pit_clockevent.mult = div_sc(FREQ, NSEC_PER_SEC, 32);\r\ncf_pit_clockevent.max_delta_ns =\r\nclockevent_delta2ns(0xFFFF, &cf_pit_clockevent);\r\ncf_pit_clockevent.min_delta_ns =\r\nclockevent_delta2ns(0x3f, &cf_pit_clockevent);\r\nclockevents_register_device(&cf_pit_clockevent);\r\nsetup_irq(MCF_IRQ_PIT1, &pit_irq);\r\nclocksource_register_hz(&pit_clk, FREQ);\r\n}

static efi_system_table_t __init *xen_efi_probe(void)\r\n{\r\nstruct xen_platform_op op = {\r\n.cmd = XENPF_firmware_info,\r\n.u.firmware_info = {\r\n.type = XEN_FW_EFI_INFO,\r\n.index = XEN_FW_EFI_CONFIG_TABLE\r\n}\r\n};\r\nunion xenpf_efi_info *info = &op.u.firmware_info.u.efi_info;\r\nif (!xen_initial_domain() || HYPERVISOR_platform_op(&op) < 0)\r\nreturn NULL;\r\nefi = efi_xen;\r\nefi_systab_xen.tables = info->cfg.addr;\r\nefi_systab_xen.nr_tables = info->cfg.nent;\r\nop.cmd = XENPF_firmware_info;\r\nop.u.firmware_info.type = XEN_FW_EFI_INFO;\r\nop.u.firmware_info.index = XEN_FW_EFI_VENDOR;\r\ninfo->vendor.bufsz = sizeof(vendor);\r\nset_xen_guest_handle(info->vendor.name, vendor);\r\nif (HYPERVISOR_platform_op(&op) == 0) {\r\nefi_systab_xen.fw_vendor = __pa_symbol(vendor);\r\nefi_systab_xen.fw_revision = info->vendor.revision;\r\n} else\r\nefi_systab_xen.fw_vendor = __pa_symbol(L"UNKNOWN");\r\nop.cmd = XENPF_firmware_info;\r\nop.u.firmware_info.type = XEN_FW_EFI_INFO;\r\nop.u.firmware_info.index = XEN_FW_EFI_VERSION;\r\nif (HYPERVISOR_platform_op(&op) == 0)\r\nefi_systab_xen.hdr.revision = info->version;\r\nop.cmd = XENPF_firmware_info;\r\nop.u.firmware_info.type = XEN_FW_EFI_INFO;\r\nop.u.firmware_info.index = XEN_FW_EFI_RT_VERSION;\r\nif (HYPERVISOR_platform_op(&op) == 0)\r\nefi.runtime_version = info->version;\r\nreturn &efi_systab_xen;\r\n}\r\nvoid __init xen_efi_init(void)\r\n{\r\nefi_system_table_t *efi_systab_xen;\r\nefi_systab_xen = xen_efi_probe();\r\nif (efi_systab_xen == NULL)\r\nreturn;\r\nstrncpy((char *)&boot_params.efi_info.efi_loader_signature, "Xen",\r\nsizeof(boot_params.efi_info.efi_loader_signature));\r\nboot_params.efi_info.efi_systab = (__u32)__pa(efi_systab_xen);\r\nboot_params.efi_info.efi_systab_hi = (__u32)(__pa(efi_systab_xen) >> 32);\r\nset_bit(EFI_BOOT, &efi.flags);\r\nset_bit(EFI_PARAVIRT, &efi.flags);\r\nset_bit(EFI_64BIT, &efi.flags);\r\n}

static int da9055_rtc_enable_alarm(struct da9055_rtc *rtc, bool enable)\r\n{\r\nint ret;\r\nif (enable) {\r\nret = da9055_reg_update(rtc->da9055, DA9055_REG_ALARM_Y,\r\nDA9055_RTC_ALM_EN,\r\nDA9055_RTC_ALM_EN);\r\nif (ret != 0)\r\ndev_err(rtc->da9055->dev, "Failed to enable ALM: %d\n",\r\nret);\r\nrtc->alarm_enable = 1;\r\n} else {\r\nret = da9055_reg_update(rtc->da9055, DA9055_REG_ALARM_Y,\r\nDA9055_RTC_ALM_EN, 0);\r\nif (ret != 0)\r\ndev_err(rtc->da9055->dev,\r\n"Failed to disable ALM: %d\n", ret);\r\nrtc->alarm_enable = 0;\r\n}\r\nreturn ret;\r\n}\r\nstatic irqreturn_t da9055_rtc_alm_irq(int irq, void *data)\r\n{\r\nstruct da9055_rtc *rtc = data;\r\nda9055_rtc_enable_alarm(rtc, 0);\r\nrtc_update_irq(rtc->rtc, 1, RTC_IRQF | RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int da9055_read_alarm(struct da9055 *da9055, struct rtc_time *rtc_tm)\r\n{\r\nint ret;\r\nuint8_t v[5];\r\nret = da9055_group_read(da9055, DA9055_REG_ALARM_MI, 5, v);\r\nif (ret != 0) {\r\ndev_err(da9055->dev, "Failed to group read ALM: %d\n", ret);\r\nreturn ret;\r\n}\r\nrtc_tm->tm_year = (v[4] & DA9055_RTC_ALM_YEAR) + 100;\r\nrtc_tm->tm_mon = (v[3] & DA9055_RTC_ALM_MONTH) - 1;\r\nrtc_tm->tm_mday = v[2] & DA9055_RTC_ALM_DAY;\r\nrtc_tm->tm_hour = v[1] & DA9055_RTC_ALM_HOUR;\r\nrtc_tm->tm_min = v[0] & DA9055_RTC_ALM_MIN;\r\nrtc_tm->tm_sec = 0;\r\nreturn rtc_valid_tm(rtc_tm);\r\n}\r\nstatic int da9055_set_alarm(struct da9055 *da9055, struct rtc_time *rtc_tm)\r\n{\r\nint ret;\r\nuint8_t v[2];\r\nrtc_tm->tm_year -= 100;\r\nrtc_tm->tm_mon += 1;\r\nret = da9055_reg_update(da9055, DA9055_REG_ALARM_MI,\r\nDA9055_RTC_ALM_MIN, rtc_tm->tm_min);\r\nif (ret != 0) {\r\ndev_err(da9055->dev, "Failed to write ALRM MIN: %d\n", ret);\r\nreturn ret;\r\n}\r\nv[0] = rtc_tm->tm_hour;\r\nv[1] = rtc_tm->tm_mday;\r\nret = da9055_group_write(da9055, DA9055_REG_ALARM_H, 2, v);\r\nif (ret < 0)\r\nreturn ret;\r\nret = da9055_reg_update(da9055, DA9055_REG_ALARM_MO,\r\nDA9055_RTC_ALM_MONTH, rtc_tm->tm_mon);\r\nif (ret < 0)\r\ndev_err(da9055->dev, "Failed to write ALM Month:%d\n", ret);\r\nret = da9055_reg_update(da9055, DA9055_REG_ALARM_Y,\r\nDA9055_RTC_ALM_YEAR, rtc_tm->tm_year);\r\nif (ret < 0)\r\ndev_err(da9055->dev, "Failed to write ALM Year:%d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int da9055_rtc_get_alarm_status(struct da9055 *da9055)\r\n{\r\nint ret;\r\nret = da9055_reg_read(da9055, DA9055_REG_ALARM_Y);\r\nif (ret < 0) {\r\ndev_err(da9055->dev, "Failed to read ALM: %d\n", ret);\r\nreturn ret;\r\n}\r\nret &= DA9055_RTC_ALM_EN;\r\nreturn (ret > 0) ? 1 : 0;\r\n}\r\nstatic int da9055_rtc_read_time(struct device *dev, struct rtc_time *rtc_tm)\r\n{\r\nstruct da9055_rtc *rtc = dev_get_drvdata(dev);\r\nuint8_t v[6];\r\nint ret;\r\nret = da9055_reg_read(rtc->da9055, DA9055_REG_COUNT_S);\r\nif (ret < 0)\r\nreturn ret;\r\nif (!(ret & DA9055_RTC_READ))\r\nreturn -EBUSY;\r\nret = da9055_group_read(rtc->da9055, DA9055_REG_COUNT_S, 6, v);\r\nif (ret < 0) {\r\ndev_err(rtc->da9055->dev, "Failed to read RTC time : %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nrtc_tm->tm_year = (v[5] & DA9055_RTC_YEAR) + 100;\r\nrtc_tm->tm_mon = (v[4] & DA9055_RTC_MONTH) - 1;\r\nrtc_tm->tm_mday = v[3] & DA9055_RTC_DAY;\r\nrtc_tm->tm_hour = v[2] & DA9055_RTC_HOUR;\r\nrtc_tm->tm_min = v[1] & DA9055_RTC_MIN;\r\nrtc_tm->tm_sec = v[0] & DA9055_RTC_SEC;\r\nreturn rtc_valid_tm(rtc_tm);\r\n}\r\nstatic int da9055_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct da9055_rtc *rtc;\r\nuint8_t v[6];\r\nrtc = dev_get_drvdata(dev);\r\nv[0] = tm->tm_sec;\r\nv[1] = tm->tm_min;\r\nv[2] = tm->tm_hour;\r\nv[3] = tm->tm_mday;\r\nv[4] = tm->tm_mon + 1;\r\nv[5] = tm->tm_year - 100;\r\nreturn da9055_group_write(rtc->da9055, DA9055_REG_COUNT_S, 6, v);\r\n}\r\nstatic int da9055_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nint ret;\r\nstruct rtc_time *tm = &alrm->time;\r\nstruct da9055_rtc *rtc = dev_get_drvdata(dev);\r\nret = da9055_read_alarm(rtc->da9055, tm);\r\nif (ret)\r\nreturn ret;\r\nalrm->enabled = da9055_rtc_get_alarm_status(rtc->da9055);\r\nreturn 0;\r\n}\r\nstatic int da9055_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nint ret;\r\nstruct rtc_time *tm = &alrm->time;\r\nstruct da9055_rtc *rtc = dev_get_drvdata(dev);\r\nret = da9055_rtc_enable_alarm(rtc, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = da9055_set_alarm(rtc->da9055, tm);\r\nif (ret)\r\nreturn ret;\r\nret = da9055_rtc_enable_alarm(rtc, 1);\r\nreturn ret;\r\n}\r\nstatic int da9055_rtc_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct da9055_rtc *rtc = dev_get_drvdata(dev);\r\nreturn da9055_rtc_enable_alarm(rtc, enabled);\r\n}\r\nstatic int da9055_rtc_device_init(struct da9055 *da9055,\r\nstruct da9055_pdata *pdata)\r\n{\r\nint ret;\r\nret = da9055_reg_update(da9055, DA9055_REG_CONTROL_B,\r\nDA9055_RTC_EN, DA9055_RTC_EN);\r\nif (ret < 0)\r\nreturn ret;\r\nret = da9055_reg_update(da9055, DA9055_REG_EN_32K,\r\nDA9055_CRYSTAL_EN, DA9055_CRYSTAL_EN);\r\nif (ret < 0)\r\nreturn ret;\r\nret = da9055_reg_update(da9055, DA9055_REG_CONTROL_B,\r\nDA9055_RTC_MODE_PD, DA9055_RTC_MODE_PD);\r\nif (ret < 0)\r\nreturn ret;\r\nif (pdata && pdata->reset_enable) {\r\nret = da9055_reg_update(da9055, DA9055_REG_CONTROL_B,\r\nDA9055_RTC_MODE_SD,\r\nDA9055_RTC_MODE_SD <<\r\nDA9055_RTC_MODE_SD_SHIFT);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nret = da9055_reg_update(da9055, DA9055_REG_ALARM_MO,\r\nDA9055_RTC_TICK_WAKE_MASK, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int da9055_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct da9055_rtc *rtc;\r\nstruct da9055_pdata *pdata = NULL;\r\nint ret, alm_irq;\r\nrtc = devm_kzalloc(&pdev->dev, sizeof(struct da9055_rtc), GFP_KERNEL);\r\nif (!rtc)\r\nreturn -ENOMEM;\r\nrtc->da9055 = dev_get_drvdata(pdev->dev.parent);\r\npdata = dev_get_platdata(rtc->da9055->dev);\r\nplatform_set_drvdata(pdev, rtc);\r\nret = da9055_rtc_device_init(rtc->da9055, pdata);\r\nif (ret < 0)\r\ngoto err_rtc;\r\nret = da9055_reg_read(rtc->da9055, DA9055_REG_ALARM_Y);\r\nif (ret < 0)\r\ngoto err_rtc;\r\nif (ret & DA9055_RTC_ALM_EN)\r\nrtc->alarm_enable = 1;\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nrtc->rtc = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&da9055_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc->rtc)) {\r\nret = PTR_ERR(rtc->rtc);\r\ngoto err_rtc;\r\n}\r\nalm_irq = platform_get_irq_byname(pdev, "ALM");\r\nif (alm_irq < 0)\r\nreturn alm_irq;\r\nret = devm_request_threaded_irq(&pdev->dev, alm_irq, NULL,\r\nda9055_rtc_alm_irq,\r\nIRQF_TRIGGER_HIGH | IRQF_ONESHOT,\r\n"ALM", rtc);\r\nif (ret != 0)\r\ndev_err(rtc->da9055->dev, "irq registration failed: %d\n", ret);\r\nerr_rtc:\r\nreturn ret;\r\n}\r\nstatic int da9055_rtc_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct da9055_rtc *rtc = dev_get_drvdata(&pdev->dev);\r\nint ret;\r\nif (!device_may_wakeup(&pdev->dev)) {\r\nret = da9055_rtc_enable_alarm(rtc, 0);\r\nif (ret < 0)\r\ndev_err(&pdev->dev, "Failed to disable RTC ALM\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int da9055_rtc_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct da9055_rtc *rtc = dev_get_drvdata(&pdev->dev);\r\nint ret;\r\nif (!device_may_wakeup(&pdev->dev)) {\r\nif (rtc->alarm_enable) {\r\nret = da9055_rtc_enable_alarm(rtc, 1);\r\nif (ret < 0)\r\ndev_err(&pdev->dev,\r\n"Failed to restart RTC ALM\n");\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int da9055_rtc_freeze(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct da9055_rtc *rtc = dev_get_drvdata(&pdev->dev);\r\nint ret;\r\nret = da9055_rtc_enable_alarm(rtc, 0);\r\nif (ret < 0)\r\ndev_err(&pdev->dev, "Failed to freeze RTC ALMs\n");\r\nreturn 0;\r\n}

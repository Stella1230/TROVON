int perf_read_values_init(struct perf_read_values *values)\r\n{\r\nvalues->threads_max = 16;\r\nvalues->pid = malloc(values->threads_max * sizeof(*values->pid));\r\nvalues->tid = malloc(values->threads_max * sizeof(*values->tid));\r\nvalues->value = malloc(values->threads_max * sizeof(*values->value));\r\nif (!values->pid || !values->tid || !values->value) {\r\npr_debug("failed to allocate read_values threads arrays");\r\ngoto out_free_pid;\r\n}\r\nvalues->threads = 0;\r\nvalues->counters_max = 16;\r\nvalues->counterrawid = malloc(values->counters_max\r\n* sizeof(*values->counterrawid));\r\nvalues->countername = malloc(values->counters_max\r\n* sizeof(*values->countername));\r\nif (!values->counterrawid || !values->countername) {\r\npr_debug("failed to allocate read_values counters arrays");\r\ngoto out_free_counter;\r\n}\r\nvalues->counters = 0;\r\nreturn 0;\r\nout_free_counter:\r\nzfree(&values->counterrawid);\r\nzfree(&values->countername);\r\nout_free_pid:\r\nzfree(&values->pid);\r\nzfree(&values->tid);\r\nzfree(&values->value);\r\nreturn -ENOMEM;\r\n}\r\nvoid perf_read_values_destroy(struct perf_read_values *values)\r\n{\r\nint i;\r\nif (!values->threads_max || !values->counters_max)\r\nreturn;\r\nfor (i = 0; i < values->threads; i++)\r\nzfree(&values->value[i]);\r\nzfree(&values->value);\r\nzfree(&values->pid);\r\nzfree(&values->tid);\r\nzfree(&values->counterrawid);\r\nfor (i = 0; i < values->counters; i++)\r\nzfree(&values->countername[i]);\r\nzfree(&values->countername);\r\n}\r\nstatic int perf_read_values__enlarge_threads(struct perf_read_values *values)\r\n{\r\nint nthreads_max = values->threads_max * 2;\r\nvoid *npid = realloc(values->pid, nthreads_max * sizeof(*values->pid)),\r\n*ntid = realloc(values->tid, nthreads_max * sizeof(*values->tid)),\r\n*nvalue = realloc(values->value, nthreads_max * sizeof(*values->value));\r\nif (!npid || !ntid || !nvalue)\r\ngoto out_err;\r\nvalues->threads_max = nthreads_max;\r\nvalues->pid = npid;\r\nvalues->tid = ntid;\r\nvalues->value = nvalue;\r\nreturn 0;\r\nout_err:\r\nfree(npid);\r\nfree(ntid);\r\nfree(nvalue);\r\npr_debug("failed to enlarge read_values threads arrays");\r\nreturn -ENOMEM;\r\n}\r\nstatic int perf_read_values__findnew_thread(struct perf_read_values *values,\r\nu32 pid, u32 tid)\r\n{\r\nint i;\r\nfor (i = 0; i < values->threads; i++)\r\nif (values->pid[i] == pid && values->tid[i] == tid)\r\nreturn i;\r\nif (values->threads == values->threads_max) {\r\ni = perf_read_values__enlarge_threads(values);\r\nif (i < 0)\r\nreturn i;\r\n}\r\ni = values->threads + 1;\r\nvalues->value[i] = malloc(values->counters_max * sizeof(**values->value));\r\nif (!values->value[i]) {\r\npr_debug("failed to allocate read_values counters array");\r\nreturn -ENOMEM;\r\n}\r\nvalues->pid[i] = pid;\r\nvalues->tid[i] = tid;\r\nvalues->threads = i;\r\nreturn i;\r\n}\r\nstatic void perf_read_values__enlarge_counters(struct perf_read_values *values)\r\n{\r\nint i;\r\nvalues->counters_max *= 2;\r\nvalues->counterrawid = realloc(values->counterrawid,\r\nvalues->counters_max * sizeof(*values->counterrawid));\r\nvalues->countername = realloc(values->countername,\r\nvalues->counters_max * sizeof(*values->countername));\r\nif (!values->counterrawid || !values->countername)\r\ndie("failed to enlarge read_values counters arrays");\r\nfor (i = 0; i < values->threads; i++) {\r\nvalues->value[i] = realloc(values->value[i],\r\nvalues->counters_max * sizeof(**values->value));\r\nif (!values->value[i])\r\ndie("failed to enlarge read_values counters arrays");\r\n}\r\n}\r\nstatic int perf_read_values__findnew_counter(struct perf_read_values *values,\r\nu64 rawid, const char *name)\r\n{\r\nint i;\r\nfor (i = 0; i < values->counters; i++)\r\nif (values->counterrawid[i] == rawid)\r\nreturn i;\r\nif (values->counters == values->counters_max)\r\nperf_read_values__enlarge_counters(values);\r\ni = values->counters++;\r\nvalues->counterrawid[i] = rawid;\r\nvalues->countername[i] = strdup(name);\r\nreturn i;\r\n}\r\nint perf_read_values_add_value(struct perf_read_values *values,\r\nu32 pid, u32 tid,\r\nu64 rawid, const char *name, u64 value)\r\n{\r\nint tindex, cindex;\r\ntindex = perf_read_values__findnew_thread(values, pid, tid);\r\nif (tindex < 0)\r\nreturn tindex;\r\ncindex = perf_read_values__findnew_counter(values, rawid, name);\r\nif (cindex < 0)\r\nreturn cindex;\r\nvalues->value[tindex][cindex] = value;\r\nreturn 0;\r\n}\r\nstatic void perf_read_values__display_pretty(FILE *fp,\r\nstruct perf_read_values *values)\r\n{\r\nint i, j;\r\nint pidwidth, tidwidth;\r\nint *counterwidth;\r\ncounterwidth = malloc(values->counters * sizeof(*counterwidth));\r\nif (!counterwidth)\r\ndie("failed to allocate counterwidth array");\r\ntidwidth = 3;\r\npidwidth = 3;\r\nfor (j = 0; j < values->counters; j++)\r\ncounterwidth[j] = strlen(values->countername[j]);\r\nfor (i = 0; i < values->threads; i++) {\r\nint width;\r\nwidth = snprintf(NULL, 0, "%d", values->pid[i]);\r\nif (width > pidwidth)\r\npidwidth = width;\r\nwidth = snprintf(NULL, 0, "%d", values->tid[i]);\r\nif (width > tidwidth)\r\ntidwidth = width;\r\nfor (j = 0; j < values->counters; j++) {\r\nwidth = snprintf(NULL, 0, "%" PRIu64, values->value[i][j]);\r\nif (width > counterwidth[j])\r\ncounterwidth[j] = width;\r\n}\r\n}\r\nfprintf(fp, "# %*s %*s", pidwidth, "PID", tidwidth, "TID");\r\nfor (j = 0; j < values->counters; j++)\r\nfprintf(fp, " %*s", counterwidth[j], values->countername[j]);\r\nfprintf(fp, "\n");\r\nfor (i = 0; i < values->threads; i++) {\r\nfprintf(fp, " %*d %*d", pidwidth, values->pid[i],\r\ntidwidth, values->tid[i]);\r\nfor (j = 0; j < values->counters; j++)\r\nfprintf(fp, " %*" PRIu64,\r\ncounterwidth[j], values->value[i][j]);\r\nfprintf(fp, "\n");\r\n}\r\nfree(counterwidth);\r\n}\r\nstatic void perf_read_values__display_raw(FILE *fp,\r\nstruct perf_read_values *values)\r\n{\r\nint width, pidwidth, tidwidth, namewidth, rawwidth, countwidth;\r\nint i, j;\r\ntidwidth = 3;\r\npidwidth = 3;\r\nnamewidth = 4;\r\nrawwidth = 3;\r\ncountwidth = 5;\r\nfor (i = 0; i < values->threads; i++) {\r\nwidth = snprintf(NULL, 0, "%d", values->pid[i]);\r\nif (width > pidwidth)\r\npidwidth = width;\r\nwidth = snprintf(NULL, 0, "%d", values->tid[i]);\r\nif (width > tidwidth)\r\ntidwidth = width;\r\n}\r\nfor (j = 0; j < values->counters; j++) {\r\nwidth = strlen(values->countername[j]);\r\nif (width > namewidth)\r\nnamewidth = width;\r\nwidth = snprintf(NULL, 0, "%" PRIx64, values->counterrawid[j]);\r\nif (width > rawwidth)\r\nrawwidth = width;\r\n}\r\nfor (i = 0; i < values->threads; i++) {\r\nfor (j = 0; j < values->counters; j++) {\r\nwidth = snprintf(NULL, 0, "%" PRIu64, values->value[i][j]);\r\nif (width > countwidth)\r\ncountwidth = width;\r\n}\r\n}\r\nfprintf(fp, "# %*s %*s %*s %*s %*s\n",\r\npidwidth, "PID", tidwidth, "TID",\r\nnamewidth, "Name", rawwidth, "Raw",\r\ncountwidth, "Count");\r\nfor (i = 0; i < values->threads; i++)\r\nfor (j = 0; j < values->counters; j++)\r\nfprintf(fp, " %*d %*d %*s %*" PRIx64 " %*" PRIu64,\r\npidwidth, values->pid[i],\r\ntidwidth, values->tid[i],\r\nnamewidth, values->countername[j],\r\nrawwidth, values->counterrawid[j],\r\ncountwidth, values->value[i][j]);\r\n}\r\nvoid perf_read_values_display(FILE *fp, struct perf_read_values *values, int raw)\r\n{\r\nif (raw)\r\nperf_read_values__display_raw(fp, values);\r\nelse\r\nperf_read_values__display_pretty(fp, values);\r\n}

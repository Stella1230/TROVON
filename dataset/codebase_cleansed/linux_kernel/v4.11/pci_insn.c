static inline void zpci_err_insn(u8 cc, u8 status, u64 req, u64 offset)\r\n{\r\nstruct {\r\nu64 req;\r\nu64 offset;\r\nu8 cc;\r\nu8 status;\r\n} __packed data = {req, offset, cc, status};\r\nzpci_err_hex(&data, sizeof(data));\r\n}\r\nstatic inline u8 __mpcifc(u64 req, struct zpci_fib *fib, u8 *status)\r\n{\r\nu8 cc;\r\nasm volatile (\r\n" .insn rxy,0xe300000000d0,%[req],%[fib]\n"\r\n" ipm %[cc]\n"\r\n" srl %[cc],28\n"\r\n: [cc] "=d" (cc), [req] "+d" (req), [fib] "+Q" (*fib)\r\n: : "cc");\r\n*status = req >> 24 & 0xff;\r\nreturn cc;\r\n}\r\nint zpci_mod_fc(u64 req, struct zpci_fib *fib)\r\n{\r\nu8 cc, status;\r\ndo {\r\ncc = __mpcifc(req, fib, &status);\r\nif (cc == 2)\r\nmsleep(ZPCI_INSN_BUSY_DELAY);\r\n} while (cc == 2);\r\nif (cc)\r\nzpci_err_insn(cc, status, req, 0);\r\nreturn (cc) ? -EIO : 0;\r\n}\r\nstatic inline u8 __rpcit(u64 fn, u64 addr, u64 range, u8 *status)\r\n{\r\nregister u64 __addr asm("2") = addr;\r\nregister u64 __range asm("3") = range;\r\nu8 cc;\r\nasm volatile (\r\n" .insn rre,0xb9d30000,%[fn],%[addr]\n"\r\n" ipm %[cc]\n"\r\n" srl %[cc],28\n"\r\n: [cc] "=d" (cc), [fn] "+d" (fn)\r\n: [addr] "d" (__addr), "d" (__range)\r\n: "cc");\r\n*status = fn >> 24 & 0xff;\r\nreturn cc;\r\n}\r\nint zpci_refresh_trans(u64 fn, u64 addr, u64 range)\r\n{\r\nu8 cc, status;\r\ndo {\r\ncc = __rpcit(fn, addr, range, &status);\r\nif (cc == 2)\r\nudelay(ZPCI_INSN_BUSY_DELAY);\r\n} while (cc == 2);\r\nif (cc)\r\nzpci_err_insn(cc, status, addr, range);\r\nreturn (cc) ? -EIO : 0;\r\n}\r\nvoid zpci_set_irq_ctrl(u16 ctl, char *unused, u8 isc)\r\n{\r\nasm volatile (\r\n" .insn rsy,0xeb00000000d1,%[ctl],%[isc],%[u]\n"\r\n: : [ctl] "d" (ctl), [isc] "d" (isc << 27), [u] "Q" (*unused));\r\n}\r\nstatic inline int ____pcilg(u64 *data, u64 req, u64 offset, u8 *status)\r\n{\r\nregister u64 __req asm("2") = req;\r\nregister u64 __offset asm("3") = offset;\r\nint cc = -ENXIO;\r\nu64 __data;\r\nasm volatile (\r\n" .insn rre,0xb9d20000,%[data],%[req]\n"\r\n"0: ipm %[cc]\n"\r\n" srl %[cc],28\n"\r\n"1:\n"\r\nEX_TABLE(0b, 1b)\r\n: [cc] "+d" (cc), [data] "=d" (__data), [req] "+d" (__req)\r\n: "d" (__offset)\r\n: "cc");\r\n*status = __req >> 24 & 0xff;\r\n*data = __data;\r\nreturn cc;\r\n}\r\nstatic inline int __pcilg(u64 *data, u64 req, u64 offset, u8 *status)\r\n{\r\nu64 __data;\r\nint cc;\r\ncc = ____pcilg(&__data, req, offset, status);\r\nif (!cc)\r\n*data = __data;\r\nreturn cc;\r\n}\r\nint zpci_load(u64 *data, u64 req, u64 offset)\r\n{\r\nu8 status;\r\nint cc;\r\ndo {\r\ncc = __pcilg(data, req, offset, &status);\r\nif (cc == 2)\r\nudelay(ZPCI_INSN_BUSY_DELAY);\r\n} while (cc == 2);\r\nif (cc)\r\nzpci_err_insn(cc, status, req, offset);\r\nreturn (cc > 0) ? -EIO : cc;\r\n}\r\nstatic inline int __pcistg(u64 data, u64 req, u64 offset, u8 *status)\r\n{\r\nregister u64 __req asm("2") = req;\r\nregister u64 __offset asm("3") = offset;\r\nint cc = -ENXIO;\r\nasm volatile (\r\n" .insn rre,0xb9d00000,%[data],%[req]\n"\r\n"0: ipm %[cc]\n"\r\n" srl %[cc],28\n"\r\n"1:\n"\r\nEX_TABLE(0b, 1b)\r\n: [cc] "+d" (cc), [req] "+d" (__req)\r\n: "d" (__offset), [data] "d" (data)\r\n: "cc");\r\n*status = __req >> 24 & 0xff;\r\nreturn cc;\r\n}\r\nint zpci_store(u64 data, u64 req, u64 offset)\r\n{\r\nu8 status;\r\nint cc;\r\ndo {\r\ncc = __pcistg(data, req, offset, &status);\r\nif (cc == 2)\r\nudelay(ZPCI_INSN_BUSY_DELAY);\r\n} while (cc == 2);\r\nif (cc)\r\nzpci_err_insn(cc, status, req, offset);\r\nreturn (cc > 0) ? -EIO : cc;\r\n}\r\nstatic inline int __pcistb(const u64 *data, u64 req, u64 offset, u8 *status)\r\n{\r\nint cc = -ENXIO;\r\nasm volatile (\r\n" .insn rsy,0xeb00000000d0,%[req],%[offset],%[data]\n"\r\n"0: ipm %[cc]\n"\r\n" srl %[cc],28\n"\r\n"1:\n"\r\nEX_TABLE(0b, 1b)\r\n: [cc] "+d" (cc), [req] "+d" (req)\r\n: [offset] "d" (offset), [data] "Q" (*data)\r\n: "cc");\r\n*status = req >> 24 & 0xff;\r\nreturn cc;\r\n}\r\nint zpci_store_block(const u64 *data, u64 req, u64 offset)\r\n{\r\nu8 status;\r\nint cc;\r\ndo {\r\ncc = __pcistb(data, req, offset, &status);\r\nif (cc == 2)\r\nudelay(ZPCI_INSN_BUSY_DELAY);\r\n} while (cc == 2);\r\nif (cc)\r\nzpci_err_insn(cc, status, req, offset);\r\nreturn (cc > 0) ? -EIO : cc;\r\n}

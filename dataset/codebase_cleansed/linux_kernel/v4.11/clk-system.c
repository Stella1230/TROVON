static inline int is_pck(int id)\r\n{\r\nreturn (id >= 8) && (id <= 15);\r\n}\r\nstatic inline bool clk_system_ready(struct regmap *regmap, int id)\r\n{\r\nunsigned int status;\r\nregmap_read(regmap, AT91_PMC_SR, &status);\r\nreturn status & (1 << id) ? 1 : 0;\r\n}\r\nstatic int clk_system_prepare(struct clk_hw *hw)\r\n{\r\nstruct clk_system *sys = to_clk_system(hw);\r\nregmap_write(sys->regmap, AT91_PMC_SCER, 1 << sys->id);\r\nif (!is_pck(sys->id))\r\nreturn 0;\r\nwhile (!clk_system_ready(sys->regmap, sys->id))\r\ncpu_relax();\r\nreturn 0;\r\n}\r\nstatic void clk_system_unprepare(struct clk_hw *hw)\r\n{\r\nstruct clk_system *sys = to_clk_system(hw);\r\nregmap_write(sys->regmap, AT91_PMC_SCDR, 1 << sys->id);\r\n}\r\nstatic int clk_system_is_prepared(struct clk_hw *hw)\r\n{\r\nstruct clk_system *sys = to_clk_system(hw);\r\nunsigned int status;\r\nregmap_read(sys->regmap, AT91_PMC_SCSR, &status);\r\nif (!(status & (1 << sys->id)))\r\nreturn 0;\r\nif (!is_pck(sys->id))\r\nreturn 1;\r\nregmap_read(sys->regmap, AT91_PMC_SR, &status);\r\nreturn status & (1 << sys->id) ? 1 : 0;\r\n}\r\nstatic struct clk_hw * __init\r\nat91_clk_register_system(struct regmap *regmap, const char *name,\r\nconst char *parent_name, u8 id)\r\n{\r\nstruct clk_system *sys;\r\nstruct clk_hw *hw;\r\nstruct clk_init_data init;\r\nint ret;\r\nif (!parent_name || id > SYSTEM_MAX_ID)\r\nreturn ERR_PTR(-EINVAL);\r\nsys = kzalloc(sizeof(*sys), GFP_KERNEL);\r\nif (!sys)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.ops = &system_ops;\r\ninit.parent_names = &parent_name;\r\ninit.num_parents = 1;\r\ninit.flags = CLK_SET_RATE_PARENT;\r\nsys->id = id;\r\nsys->hw.init = &init;\r\nsys->regmap = regmap;\r\nhw = &sys->hw;\r\nret = clk_hw_register(NULL, &sys->hw);\r\nif (ret) {\r\nkfree(sys);\r\nhw = ERR_PTR(ret);\r\n}\r\nreturn hw;\r\n}\r\nstatic void __init of_at91rm9200_clk_sys_setup(struct device_node *np)\r\n{\r\nint num;\r\nu32 id;\r\nstruct clk_hw *hw;\r\nconst char *name;\r\nstruct device_node *sysclknp;\r\nconst char *parent_name;\r\nstruct regmap *regmap;\r\nnum = of_get_child_count(np);\r\nif (num > (SYSTEM_MAX_ID + 1))\r\nreturn;\r\nregmap = syscon_node_to_regmap(of_get_parent(np));\r\nif (IS_ERR(regmap))\r\nreturn;\r\nfor_each_child_of_node(np, sysclknp) {\r\nif (of_property_read_u32(sysclknp, "reg", &id))\r\ncontinue;\r\nif (of_property_read_string(np, "clock-output-names", &name))\r\nname = sysclknp->name;\r\nparent_name = of_clk_get_parent_name(sysclknp, 0);\r\nhw = at91_clk_register_system(regmap, name, parent_name, id);\r\nif (IS_ERR(hw))\r\ncontinue;\r\nof_clk_add_hw_provider(sysclknp, of_clk_hw_simple_get, hw);\r\n}\r\n}

static __inline__ u8 matrox_w1_read_reg(struct matrox_device *dev, u8 reg)\r\n{\r\nu8 ret;\r\nwriteb(reg, dev->port_index);\r\nret = readb(dev->port_data);\r\nbarrier();\r\nreturn ret;\r\n}\r\nstatic __inline__ void matrox_w1_write_reg(struct matrox_device *dev, u8 reg, u8 val)\r\n{\r\nwriteb(reg, dev->port_index);\r\nwriteb(val, dev->port_data);\r\nwmb();\r\n}\r\nstatic void matrox_w1_write_ddc_bit(void *data, u8 bit)\r\n{\r\nu8 ret;\r\nstruct matrox_device *dev = data;\r\nif (bit)\r\nbit = 0;\r\nelse\r\nbit = dev->data_mask;\r\nret = matrox_w1_read_reg(dev, MATROX_GET_CONTROL);\r\nmatrox_w1_write_reg(dev, MATROX_GET_CONTROL, ((ret & ~dev->data_mask) | bit));\r\nmatrox_w1_write_reg(dev, MATROX_GET_DATA, 0x00);\r\n}\r\nstatic u8 matrox_w1_read_ddc_bit(void *data)\r\n{\r\nu8 ret;\r\nstruct matrox_device *dev = data;\r\nret = matrox_w1_read_reg(dev, MATROX_GET_DATA);\r\nreturn ret;\r\n}\r\nstatic void matrox_w1_hw_init(struct matrox_device *dev)\r\n{\r\nmatrox_w1_write_reg(dev, MATROX_GET_DATA, 0xFF);\r\nmatrox_w1_write_reg(dev, MATROX_GET_CONTROL, 0x00);\r\n}\r\nstatic int matrox_w1_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nstruct matrox_device *dev;\r\nint err;\r\nassert(pdev != NULL);\r\nassert(ent != NULL);\r\nif (pdev->vendor != PCI_VENDOR_ID_MATROX || pdev->device != PCI_DEVICE_ID_MATROX_G400)\r\nreturn -ENODEV;\r\ndev = kzalloc(sizeof(struct matrox_device) +\r\nsizeof(struct w1_bus_master), GFP_KERNEL);\r\nif (!dev) {\r\ndev_err(&pdev->dev,\r\n"%s: Failed to create new matrox_device object.\n",\r\n__func__);\r\nreturn -ENOMEM;\r\n}\r\ndev->bus_master = (struct w1_bus_master *)(dev + 1);\r\ndev->phys_addr = pci_resource_start(pdev, 1);\r\ndev->virt_addr = ioremap_nocache(dev->phys_addr, 16384);\r\nif (!dev->virt_addr) {\r\ndev_err(&pdev->dev, "%s: failed to ioremap(0x%lx, %d).\n",\r\n__func__, dev->phys_addr, 16384);\r\nerr = -EIO;\r\ngoto err_out_free_device;\r\n}\r\ndev->base_addr = dev->virt_addr + MATROX_BASE;\r\ndev->port_index = dev->base_addr + MATROX_PORT_INDEX_OFFSET;\r\ndev->port_data = dev->base_addr + MATROX_PORT_DATA_OFFSET;\r\ndev->data_mask = (MATROX_G400_DDC_DATA);\r\nmatrox_w1_hw_init(dev);\r\ndev->bus_master->data = dev;\r\ndev->bus_master->read_bit = &matrox_w1_read_ddc_bit;\r\ndev->bus_master->write_bit = &matrox_w1_write_ddc_bit;\r\nerr = w1_add_master_device(dev->bus_master);\r\nif (err)\r\ngoto err_out_free_device;\r\npci_set_drvdata(pdev, dev);\r\ndev->found = 1;\r\ndev_info(&pdev->dev, "Matrox G400 GPIO transport layer for 1-wire.\n");\r\nreturn 0;\r\nerr_out_free_device:\r\nif (dev->virt_addr)\r\niounmap(dev->virt_addr);\r\nkfree(dev);\r\nreturn err;\r\n}\r\nstatic void matrox_w1_remove(struct pci_dev *pdev)\r\n{\r\nstruct matrox_device *dev = pci_get_drvdata(pdev);\r\nassert(dev != NULL);\r\nif (dev->found) {\r\nw1_remove_master_device(dev->bus_master);\r\niounmap(dev->virt_addr);\r\n}\r\nkfree(dev);\r\n}

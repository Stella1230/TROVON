static int hsw_ext_get_count(enum intel_hsw_ext_id id, unsigned long long *val,\r\nunsigned int cpu)\r\n{\r\nint msr;\r\nswitch (id) {\r\ncase PC8:\r\nmsr = MSR_PKG_C8_RESIDENCY;\r\nbreak;\r\ncase PC9:\r\nmsr = MSR_PKG_C9_RESIDENCY;\r\nbreak;\r\ncase PC10:\r\nmsr = MSR_PKG_C10_RESIDENCY;\r\nbreak;\r\ncase TSC:\r\nmsr = MSR_TSC;\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n};\r\nif (read_msr(cpu, msr, val))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int hsw_ext_get_count_percent(unsigned int id, double *percent,\r\nunsigned int cpu)\r\n{\r\n*percent = 0.0;\r\nif (!is_valid[cpu])\r\nreturn -1;\r\n*percent = (100.0 *\r\n(current_count[id][cpu] - previous_count[id][cpu])) /\r\n(tsc_at_measure_end - tsc_at_measure_start);\r\ndprint("%s: previous: %llu - current: %llu - (%u)\n",\r\nhsw_ext_cstates[id].name, previous_count[id][cpu],\r\ncurrent_count[id][cpu], cpu);\r\ndprint("%s: tsc_diff: %llu - count_diff: %llu - percent: %2.f (%u)\n",\r\nhsw_ext_cstates[id].name,\r\n(unsigned long long) tsc_at_measure_end - tsc_at_measure_start,\r\ncurrent_count[id][cpu] - previous_count[id][cpu],\r\n*percent, cpu);\r\nreturn 0;\r\n}\r\nstatic int hsw_ext_start(void)\r\n{\r\nint num, cpu;\r\nunsigned long long val;\r\nfor (num = 0; num < HSW_EXT_CSTATE_COUNT; num++) {\r\nfor (cpu = 0; cpu < cpu_count; cpu++) {\r\nhsw_ext_get_count(num, &val, cpu);\r\nprevious_count[num][cpu] = val;\r\n}\r\n}\r\nhsw_ext_get_count(TSC, &tsc_at_measure_start, 0);\r\nreturn 0;\r\n}\r\nstatic int hsw_ext_stop(void)\r\n{\r\nunsigned long long val;\r\nint num, cpu;\r\nhsw_ext_get_count(TSC, &tsc_at_measure_end, 0);\r\nfor (num = 0; num < HSW_EXT_CSTATE_COUNT; num++) {\r\nfor (cpu = 0; cpu < cpu_count; cpu++) {\r\nis_valid[cpu] = !hsw_ext_get_count(num, &val, cpu);\r\ncurrent_count[num][cpu] = val;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic struct cpuidle_monitor *hsw_ext_register(void)\r\n{\r\nint num;\r\nif (cpupower_cpu_info.vendor != X86_VENDOR_INTEL\r\n|| cpupower_cpu_info.family != 6)\r\nreturn NULL;\r\nswitch (cpupower_cpu_info.model) {\r\ncase 0x45:\r\nbreak;\r\ndefault:\r\nreturn NULL;\r\n}\r\nis_valid = calloc(cpu_count, sizeof(int));\r\nfor (num = 0; num < HSW_EXT_CSTATE_COUNT; num++) {\r\nprevious_count[num] = calloc(cpu_count,\r\nsizeof(unsigned long long));\r\ncurrent_count[num] = calloc(cpu_count,\r\nsizeof(unsigned long long));\r\n}\r\nintel_hsw_ext_monitor.name_len = strlen(intel_hsw_ext_monitor.name);\r\nreturn &intel_hsw_ext_monitor;\r\n}\r\nvoid hsw_ext_unregister(void)\r\n{\r\nint num;\r\nfree(is_valid);\r\nfor (num = 0; num < HSW_EXT_CSTATE_COUNT; num++) {\r\nfree(previous_count[num]);\r\nfree(current_count[num]);\r\n}\r\n}

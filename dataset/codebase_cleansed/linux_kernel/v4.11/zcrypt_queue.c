static ssize_t zcrypt_queue_online_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct zcrypt_queue *zq = to_ap_queue(dev)->private;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", zq->online);\r\n}\r\nstatic ssize_t zcrypt_queue_online_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct zcrypt_queue *zq = to_ap_queue(dev)->private;\r\nstruct zcrypt_card *zc = zq->zcard;\r\nint online;\r\nif (sscanf(buf, "%d\n", &online) != 1 || online < 0 || online > 1)\r\nreturn -EINVAL;\r\nif (online && !zc->online)\r\nreturn -EINVAL;\r\nzq->online = online;\r\nZCRYPT_DBF(DBF_INFO, "queue=%02x.%04x online=%d\n",\r\nAP_QID_CARD(zq->queue->qid),\r\nAP_QID_QUEUE(zq->queue->qid),\r\nonline);\r\nif (!online)\r\nap_flush_queue(zq->queue);\r\nreturn count;\r\n}\r\nvoid zcrypt_queue_force_online(struct zcrypt_queue *zq, int online)\r\n{\r\nzq->online = online;\r\nif (!online)\r\nap_flush_queue(zq->queue);\r\n}\r\nstruct zcrypt_queue *zcrypt_queue_alloc(size_t max_response_size)\r\n{\r\nstruct zcrypt_queue *zq;\r\nzq = kzalloc(sizeof(struct zcrypt_queue), GFP_KERNEL);\r\nif (!zq)\r\nreturn NULL;\r\nzq->reply.message = kmalloc(max_response_size, GFP_KERNEL);\r\nif (!zq->reply.message)\r\ngoto out_free;\r\nzq->reply.length = max_response_size;\r\nINIT_LIST_HEAD(&zq->list);\r\nkref_init(&zq->refcount);\r\nreturn zq;\r\nout_free:\r\nkfree(zq);\r\nreturn NULL;\r\n}\r\nvoid zcrypt_queue_free(struct zcrypt_queue *zq)\r\n{\r\nkfree(zq->reply.message);\r\nkfree(zq);\r\n}\r\nstatic void zcrypt_queue_release(struct kref *kref)\r\n{\r\nstruct zcrypt_queue *zq =\r\ncontainer_of(kref, struct zcrypt_queue, refcount);\r\nzcrypt_queue_free(zq);\r\n}\r\nvoid zcrypt_queue_get(struct zcrypt_queue *zq)\r\n{\r\nkref_get(&zq->refcount);\r\n}\r\nint zcrypt_queue_put(struct zcrypt_queue *zq)\r\n{\r\nreturn kref_put(&zq->refcount, zcrypt_queue_release);\r\n}\r\nint zcrypt_queue_register(struct zcrypt_queue *zq)\r\n{\r\nstruct zcrypt_card *zc;\r\nint rc;\r\nspin_lock(&zcrypt_list_lock);\r\nzc = zq->queue->card->private;\r\nzcrypt_card_get(zc);\r\nzq->zcard = zc;\r\nzq->online = 1;\r\nZCRYPT_DBF(DBF_INFO, "queue=%02x.%04x register online=1\n",\r\nAP_QID_CARD(zq->queue->qid), AP_QID_QUEUE(zq->queue->qid));\r\nlist_add_tail(&zq->list, &zc->zqueues);\r\nzcrypt_device_count++;\r\nspin_unlock(&zcrypt_list_lock);\r\nrc = sysfs_create_group(&zq->queue->ap_dev.device.kobj,\r\n&zcrypt_queue_attr_group);\r\nif (rc)\r\ngoto out;\r\nget_device(&zq->queue->ap_dev.device);\r\nif (zq->ops->rng) {\r\nrc = zcrypt_rng_device_add();\r\nif (rc)\r\ngoto out_unregister;\r\n}\r\nreturn 0;\r\nout_unregister:\r\nsysfs_remove_group(&zq->queue->ap_dev.device.kobj,\r\n&zcrypt_queue_attr_group);\r\nput_device(&zq->queue->ap_dev.device);\r\nout:\r\nspin_lock(&zcrypt_list_lock);\r\nlist_del_init(&zq->list);\r\nspin_unlock(&zcrypt_list_lock);\r\nzcrypt_card_put(zc);\r\nreturn rc;\r\n}\r\nvoid zcrypt_queue_unregister(struct zcrypt_queue *zq)\r\n{\r\nstruct zcrypt_card *zc;\r\nZCRYPT_DBF(DBF_INFO, "queue=%02x.%04x unregister\n",\r\nAP_QID_CARD(zq->queue->qid), AP_QID_QUEUE(zq->queue->qid));\r\nzc = zq->zcard;\r\nspin_lock(&zcrypt_list_lock);\r\nlist_del_init(&zq->list);\r\nzcrypt_device_count--;\r\nspin_unlock(&zcrypt_list_lock);\r\nzcrypt_card_put(zc);\r\nif (zq->ops->rng)\r\nzcrypt_rng_device_remove();\r\nsysfs_remove_group(&zq->queue->ap_dev.device.kobj,\r\n&zcrypt_queue_attr_group);\r\nput_device(&zq->queue->ap_dev.device);\r\nzcrypt_queue_put(zq);\r\n}

int setup_cgroup_environment(void)\r\n{\r\nchar cgroup_workdir[PATH_MAX + 1];\r\nformat_cgroup_path(cgroup_workdir, "");\r\nif (unshare(CLONE_NEWNS)) {\r\nlog_err("unshare");\r\nreturn 1;\r\n}\r\nif (mount("none", "/", NULL, MS_REC | MS_PRIVATE, NULL)) {\r\nlog_err("mount fakeroot");\r\nreturn 1;\r\n}\r\nif (mount("none", CGROUP_MOUNT_PATH, "cgroup2", 0, NULL)) {\r\nlog_err("mount cgroup2");\r\nreturn 1;\r\n}\r\ncleanup_cgroup_environment();\r\nif (mkdir(cgroup_workdir, 0777) && errno != EEXIST) {\r\nlog_err("mkdir cgroup work dir");\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int nftwfunc(const char *filename, const struct stat *statptr,\r\nint fileflags, struct FTW *pfwt)\r\n{\r\nif ((fileflags & FTW_D) && rmdir(filename))\r\nlog_err("Removing cgroup: %s", filename);\r\nreturn 0;\r\n}\r\nstatic int join_cgroup_from_top(char *cgroup_path)\r\n{\r\nchar cgroup_procs_path[PATH_MAX + 1];\r\npid_t pid = getpid();\r\nint fd, rc = 0;\r\nsnprintf(cgroup_procs_path, sizeof(cgroup_procs_path),\r\n"%s/cgroup.procs", cgroup_path);\r\nfd = open(cgroup_procs_path, O_WRONLY);\r\nif (fd < 0) {\r\nlog_err("Opening Cgroup Procs: %s", cgroup_procs_path);\r\nreturn 1;\r\n}\r\nif (dprintf(fd, "%d\n", pid) < 0) {\r\nlog_err("Joining Cgroup");\r\nrc = 1;\r\n}\r\nclose(fd);\r\nreturn rc;\r\n}\r\nint join_cgroup(char *path)\r\n{\r\nchar cgroup_path[PATH_MAX + 1];\r\nformat_cgroup_path(cgroup_path, path);\r\nreturn join_cgroup_from_top(cgroup_path);\r\n}\r\nvoid cleanup_cgroup_environment(void)\r\n{\r\nchar cgroup_workdir[PATH_MAX + 1];\r\nformat_cgroup_path(cgroup_workdir, "");\r\njoin_cgroup_from_top(CGROUP_MOUNT_PATH);\r\nnftw(cgroup_workdir, nftwfunc, WALK_FD_LIMIT, FTW_DEPTH | FTW_MOUNT);\r\n}\r\nint create_and_get_cgroup(char *path)\r\n{\r\nchar cgroup_path[PATH_MAX + 1];\r\nint fd;\r\nformat_cgroup_path(cgroup_path, path);\r\nif (mkdir(cgroup_path, 0777) && errno != EEXIST) {\r\nlog_err("mkdiring cgroup");\r\nreturn 0;\r\n}\r\nfd = open(cgroup_path, O_RDONLY);\r\nif (fd < 0) {\r\nlog_err("Opening Cgroup");\r\nreturn 0;\r\n}\r\nreturn fd;\r\n}

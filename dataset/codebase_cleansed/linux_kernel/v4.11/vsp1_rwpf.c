struct v4l2_rect *vsp1_rwpf_get_crop(struct vsp1_rwpf *rwpf,\r\nstruct v4l2_subdev_pad_config *config)\r\n{\r\nreturn v4l2_subdev_get_try_crop(&rwpf->entity.subdev, config,\r\nRWPF_PAD_SINK);\r\n}\r\nstatic int vsp1_rwpf_enum_mbus_code(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_mbus_code_enum *code)\r\n{\r\nstatic const unsigned int codes[] = {\r\nMEDIA_BUS_FMT_ARGB8888_1X32,\r\nMEDIA_BUS_FMT_AHSV8888_1X32,\r\nMEDIA_BUS_FMT_AYUV8_1X32,\r\n};\r\nif (code->index >= ARRAY_SIZE(codes))\r\nreturn -EINVAL;\r\ncode->code = codes[code->index];\r\nreturn 0;\r\n}\r\nstatic int vsp1_rwpf_enum_frame_size(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_frame_size_enum *fse)\r\n{\r\nstruct vsp1_rwpf *rwpf = to_rwpf(subdev);\r\nreturn vsp1_subdev_enum_frame_size(subdev, cfg, fse, RWPF_MIN_WIDTH,\r\nRWPF_MIN_HEIGHT, rwpf->max_width,\r\nrwpf->max_height);\r\n}\r\nstatic int vsp1_rwpf_set_format(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct vsp1_rwpf *rwpf = to_rwpf(subdev);\r\nstruct v4l2_subdev_pad_config *config;\r\nstruct v4l2_mbus_framefmt *format;\r\nint ret = 0;\r\nmutex_lock(&rwpf->entity.lock);\r\nconfig = vsp1_entity_get_pad_config(&rwpf->entity, cfg, fmt->which);\r\nif (!config) {\r\nret = -EINVAL;\r\ngoto done;\r\n}\r\nif (fmt->format.code != MEDIA_BUS_FMT_ARGB8888_1X32 &&\r\nfmt->format.code != MEDIA_BUS_FMT_AHSV8888_1X32 &&\r\nfmt->format.code != MEDIA_BUS_FMT_AYUV8_1X32)\r\nfmt->format.code = MEDIA_BUS_FMT_AYUV8_1X32;\r\nformat = vsp1_entity_get_pad_format(&rwpf->entity, config, fmt->pad);\r\nif (fmt->pad == RWPF_PAD_SOURCE) {\r\nformat->code = fmt->format.code;\r\nfmt->format = *format;\r\ngoto done;\r\n}\r\nformat->code = fmt->format.code;\r\nformat->width = clamp_t(unsigned int, fmt->format.width,\r\nRWPF_MIN_WIDTH, rwpf->max_width);\r\nformat->height = clamp_t(unsigned int, fmt->format.height,\r\nRWPF_MIN_HEIGHT, rwpf->max_height);\r\nformat->field = V4L2_FIELD_NONE;\r\nformat->colorspace = V4L2_COLORSPACE_SRGB;\r\nfmt->format = *format;\r\nif (rwpf->entity.type == VSP1_ENTITY_RPF) {\r\nstruct v4l2_rect *crop;\r\ncrop = vsp1_rwpf_get_crop(rwpf, config);\r\ncrop->left = 0;\r\ncrop->top = 0;\r\ncrop->width = fmt->format.width;\r\ncrop->height = fmt->format.height;\r\n}\r\nformat = vsp1_entity_get_pad_format(&rwpf->entity, config,\r\nRWPF_PAD_SOURCE);\r\n*format = fmt->format;\r\ndone:\r\nmutex_unlock(&rwpf->entity.lock);\r\nreturn ret;\r\n}\r\nstatic int vsp1_rwpf_get_selection(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_selection *sel)\r\n{\r\nstruct vsp1_rwpf *rwpf = to_rwpf(subdev);\r\nstruct v4l2_subdev_pad_config *config;\r\nstruct v4l2_mbus_framefmt *format;\r\nint ret = 0;\r\nif (rwpf->entity.type == VSP1_ENTITY_WPF || sel->pad != RWPF_PAD_SINK)\r\nreturn -EINVAL;\r\nmutex_lock(&rwpf->entity.lock);\r\nconfig = vsp1_entity_get_pad_config(&rwpf->entity, cfg, sel->which);\r\nif (!config) {\r\nret = -EINVAL;\r\ngoto done;\r\n}\r\nswitch (sel->target) {\r\ncase V4L2_SEL_TGT_CROP:\r\nsel->r = *vsp1_rwpf_get_crop(rwpf, config);\r\nbreak;\r\ncase V4L2_SEL_TGT_CROP_BOUNDS:\r\nformat = vsp1_entity_get_pad_format(&rwpf->entity, config,\r\nRWPF_PAD_SINK);\r\nsel->r.left = 0;\r\nsel->r.top = 0;\r\nsel->r.width = format->width;\r\nsel->r.height = format->height;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\ndone:\r\nmutex_unlock(&rwpf->entity.lock);\r\nreturn ret;\r\n}\r\nstatic int vsp1_rwpf_set_selection(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_selection *sel)\r\n{\r\nstruct vsp1_rwpf *rwpf = to_rwpf(subdev);\r\nstruct v4l2_subdev_pad_config *config;\r\nstruct v4l2_mbus_framefmt *format;\r\nstruct v4l2_rect *crop;\r\nint ret = 0;\r\nif (rwpf->entity.type == VSP1_ENTITY_WPF || sel->pad != RWPF_PAD_SINK)\r\nreturn -EINVAL;\r\nif (sel->target != V4L2_SEL_TGT_CROP)\r\nreturn -EINVAL;\r\nmutex_lock(&rwpf->entity.lock);\r\nconfig = vsp1_entity_get_pad_config(&rwpf->entity, cfg, sel->which);\r\nif (!config) {\r\nret = -EINVAL;\r\ngoto done;\r\n}\r\nformat = vsp1_entity_get_pad_format(&rwpf->entity, config,\r\nRWPF_PAD_SINK);\r\nif (format->code == MEDIA_BUS_FMT_AYUV8_1X32) {\r\nsel->r.left = ALIGN(sel->r.left, 2);\r\nsel->r.top = ALIGN(sel->r.top, 2);\r\nsel->r.width = round_down(sel->r.width, 2);\r\nsel->r.height = round_down(sel->r.height, 2);\r\n}\r\nsel->r.left = min_t(unsigned int, sel->r.left, format->width - 2);\r\nsel->r.top = min_t(unsigned int, sel->r.top, format->height - 2);\r\nsel->r.width = min_t(unsigned int, sel->r.width,\r\nformat->width - sel->r.left);\r\nsel->r.height = min_t(unsigned int, sel->r.height,\r\nformat->height - sel->r.top);\r\ncrop = vsp1_rwpf_get_crop(rwpf, config);\r\n*crop = sel->r;\r\nformat = vsp1_entity_get_pad_format(&rwpf->entity, config,\r\nRWPF_PAD_SOURCE);\r\nformat->width = crop->width;\r\nformat->height = crop->height;\r\ndone:\r\nmutex_unlock(&rwpf->entity.lock);\r\nreturn ret;\r\n}\r\nstatic int vsp1_rwpf_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct vsp1_rwpf *rwpf =\r\ncontainer_of(ctrl->handler, struct vsp1_rwpf, ctrls);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_ALPHA_COMPONENT:\r\nrwpf->alpha = ctrl->val;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nint vsp1_rwpf_init_ctrls(struct vsp1_rwpf *rwpf, unsigned int ncontrols)\r\n{\r\nv4l2_ctrl_handler_init(&rwpf->ctrls, ncontrols + 1);\r\nv4l2_ctrl_new_std(&rwpf->ctrls, &vsp1_rwpf_ctrl_ops,\r\nV4L2_CID_ALPHA_COMPONENT, 0, 255, 1, 255);\r\nrwpf->entity.subdev.ctrl_handler = &rwpf->ctrls;\r\nreturn rwpf->ctrls.error;\r\n}

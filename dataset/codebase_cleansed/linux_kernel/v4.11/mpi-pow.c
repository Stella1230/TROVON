int mpi_powm(MPI res, MPI base, MPI exp, MPI mod)\r\n{\r\nmpi_ptr_t mp_marker = NULL, bp_marker = NULL, ep_marker = NULL;\r\nmpi_ptr_t xp_marker = NULL;\r\nmpi_ptr_t tspace = NULL;\r\nmpi_ptr_t rp, ep, mp, bp;\r\nmpi_size_t esize, msize, bsize, rsize;\r\nint esign, msign, bsign, rsign;\r\nmpi_size_t size;\r\nint mod_shift_cnt;\r\nint negative_result;\r\nint assign_rp = 0;\r\nmpi_size_t tsize = 0;\r\nint rc = -ENOMEM;\r\nesize = exp->nlimbs;\r\nmsize = mod->nlimbs;\r\nsize = 2 * msize;\r\nesign = exp->sign;\r\nmsign = mod->sign;\r\nrp = res->d;\r\nep = exp->d;\r\nif (!msize)\r\nreturn -EINVAL;\r\nif (!esize) {\r\nres->nlimbs = (msize == 1 && mod->d[0] == 1) ? 0 : 1;\r\nif (res->nlimbs) {\r\nif (mpi_resize(res, 1) < 0)\r\ngoto enomem;\r\nrp = res->d;\r\nrp[0] = 1;\r\n}\r\nres->sign = 0;\r\ngoto leave;\r\n}\r\nmp = mp_marker = mpi_alloc_limb_space(msize);\r\nif (!mp)\r\ngoto enomem;\r\nmod_shift_cnt = count_leading_zeros(mod->d[msize - 1]);\r\nif (mod_shift_cnt)\r\nmpihelp_lshift(mp, mod->d, msize, mod_shift_cnt);\r\nelse\r\nMPN_COPY(mp, mod->d, msize);\r\nbsize = base->nlimbs;\r\nbsign = base->sign;\r\nif (bsize > msize) {\r\nbp = bp_marker = mpi_alloc_limb_space(bsize + 1);\r\nif (!bp)\r\ngoto enomem;\r\nMPN_COPY(bp, base->d, bsize);\r\nmpihelp_divrem(bp + msize, 0, bp, bsize, mp, msize);\r\nbsize = msize;\r\nMPN_NORMALIZE(bp, bsize);\r\n} else\r\nbp = base->d;\r\nif (!bsize) {\r\nres->nlimbs = 0;\r\nres->sign = 0;\r\ngoto leave;\r\n}\r\nif (res->alloced < size) {\r\nif (rp == ep || rp == mp || rp == bp) {\r\nrp = mpi_alloc_limb_space(size);\r\nif (!rp)\r\ngoto enomem;\r\nassign_rp = 1;\r\n} else {\r\nif (mpi_resize(res, size) < 0)\r\ngoto enomem;\r\nrp = res->d;\r\n}\r\n} else {\r\nif (rp == bp) {\r\nBUG_ON(bp_marker);\r\nbp = bp_marker = mpi_alloc_limb_space(bsize);\r\nif (!bp)\r\ngoto enomem;\r\nMPN_COPY(bp, rp, bsize);\r\n}\r\nif (rp == ep) {\r\nep = ep_marker = mpi_alloc_limb_space(esize);\r\nif (!ep)\r\ngoto enomem;\r\nMPN_COPY(ep, rp, esize);\r\n}\r\nif (rp == mp) {\r\nBUG_ON(mp_marker);\r\nmp = mp_marker = mpi_alloc_limb_space(msize);\r\nif (!mp)\r\ngoto enomem;\r\nMPN_COPY(mp, rp, msize);\r\n}\r\n}\r\nMPN_COPY(rp, bp, bsize);\r\nrsize = bsize;\r\nrsign = bsign;\r\n{\r\nmpi_size_t i;\r\nmpi_ptr_t xp;\r\nint c;\r\nmpi_limb_t e;\r\nmpi_limb_t carry_limb;\r\nstruct karatsuba_ctx karactx;\r\nxp = xp_marker = mpi_alloc_limb_space(2 * (msize + 1));\r\nif (!xp)\r\ngoto enomem;\r\nmemset(&karactx, 0, sizeof karactx);\r\nnegative_result = (ep[0] & 1) && base->sign;\r\ni = esize - 1;\r\ne = ep[i];\r\nc = count_leading_zeros(e);\r\ne = (e << c) << 1;\r\nc = BITS_PER_MPI_LIMB - 1 - c;\r\nfor (;;) {\r\nwhile (c) {\r\nmpi_ptr_t tp;\r\nmpi_size_t xsize;\r\nif (rsize < KARATSUBA_THRESHOLD)\r\nmpih_sqr_n_basecase(xp, rp, rsize);\r\nelse {\r\nif (!tspace) {\r\ntsize = 2 * rsize;\r\ntspace =\r\nmpi_alloc_limb_space(tsize);\r\nif (!tspace)\r\ngoto enomem;\r\n} else if (tsize < (2 * rsize)) {\r\nmpi_free_limb_space(tspace);\r\ntsize = 2 * rsize;\r\ntspace =\r\nmpi_alloc_limb_space(tsize);\r\nif (!tspace)\r\ngoto enomem;\r\n}\r\nmpih_sqr_n(xp, rp, rsize, tspace);\r\n}\r\nxsize = 2 * rsize;\r\nif (xsize > msize) {\r\nmpihelp_divrem(xp + msize, 0, xp, xsize,\r\nmp, msize);\r\nxsize = msize;\r\n}\r\ntp = rp;\r\nrp = xp;\r\nxp = tp;\r\nrsize = xsize;\r\nif ((mpi_limb_signed_t) e < 0) {\r\nif (bsize < KARATSUBA_THRESHOLD) {\r\nmpi_limb_t tmp;\r\nif (mpihelp_mul\r\n(xp, rp, rsize, bp, bsize,\r\n&tmp) < 0)\r\ngoto enomem;\r\n} else {\r\nif (mpihelp_mul_karatsuba_case\r\n(xp, rp, rsize, bp, bsize,\r\n&karactx) < 0)\r\ngoto enomem;\r\n}\r\nxsize = rsize + bsize;\r\nif (xsize > msize) {\r\nmpihelp_divrem(xp + msize, 0,\r\nxp, xsize, mp,\r\nmsize);\r\nxsize = msize;\r\n}\r\ntp = rp;\r\nrp = xp;\r\nxp = tp;\r\nrsize = xsize;\r\n}\r\ne <<= 1;\r\nc--;\r\n}\r\ni--;\r\nif (i < 0)\r\nbreak;\r\ne = ep[i];\r\nc = BITS_PER_MPI_LIMB;\r\n}\r\nif (mod_shift_cnt) {\r\ncarry_limb =\r\nmpihelp_lshift(res->d, rp, rsize, mod_shift_cnt);\r\nrp = res->d;\r\nif (carry_limb) {\r\nrp[rsize] = carry_limb;\r\nrsize++;\r\n}\r\n} else {\r\nMPN_COPY(res->d, rp, rsize);\r\nrp = res->d;\r\n}\r\nif (rsize >= msize) {\r\nmpihelp_divrem(rp + msize, 0, rp, rsize, mp, msize);\r\nrsize = msize;\r\n}\r\nif (mod_shift_cnt)\r\nmpihelp_rshift(rp, rp, rsize, mod_shift_cnt);\r\nMPN_NORMALIZE(rp, rsize);\r\nmpihelp_release_karatsuba_ctx(&karactx);\r\n}\r\nif (negative_result && rsize) {\r\nif (mod_shift_cnt)\r\nmpihelp_rshift(mp, mp, msize, mod_shift_cnt);\r\nmpihelp_sub(rp, mp, msize, rp, rsize);\r\nrsize = msize;\r\nrsign = msign;\r\nMPN_NORMALIZE(rp, rsize);\r\n}\r\nres->nlimbs = rsize;\r\nres->sign = rsign;\r\nleave:\r\nrc = 0;\r\nenomem:\r\nif (assign_rp)\r\nmpi_assign_limb_space(res, rp, size);\r\nif (mp_marker)\r\nmpi_free_limb_space(mp_marker);\r\nif (bp_marker)\r\nmpi_free_limb_space(bp_marker);\r\nif (ep_marker)\r\nmpi_free_limb_space(ep_marker);\r\nif (xp_marker)\r\nmpi_free_limb_space(xp_marker);\r\nif (tspace)\r\nmpi_free_limb_space(tspace);\r\nreturn rc;\r\n}

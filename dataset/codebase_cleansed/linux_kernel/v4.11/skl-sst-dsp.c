void skl_dsp_set_state_locked(struct sst_dsp *ctx, int state)\r\n{\r\nmutex_lock(&ctx->mutex);\r\nctx->sst_state = state;\r\nmutex_unlock(&ctx->mutex);\r\n}\r\nvoid skl_dsp_init_core_state(struct sst_dsp *ctx)\r\n{\r\nstruct skl_sst *skl = ctx->thread_context;\r\nint i;\r\nskl->cores.state[SKL_DSP_CORE0_ID] = SKL_DSP_RUNNING;\r\nskl->cores.usage_count[SKL_DSP_CORE0_ID] = 1;\r\nfor (i = SKL_DSP_CORE0_ID + 1; i < SKL_DSP_CORES_MAX; i++) {\r\nskl->cores.state[i] = SKL_DSP_RESET;\r\nskl->cores.usage_count[i] = 0;\r\n}\r\n}\r\nunsigned int skl_dsp_get_enabled_cores(struct sst_dsp *ctx)\r\n{\r\nstruct skl_sst *skl = ctx->thread_context;\r\nunsigned int core_mask, en_cores_mask;\r\nu32 val;\r\ncore_mask = SKL_DSP_CORES_MASK(skl->cores.count);\r\nval = sst_dsp_shim_read_unlocked(ctx, SKL_ADSP_REG_ADSPCS);\r\nen_cores_mask = (val & SKL_ADSPCS_CPA_MASK(core_mask)) >>\r\nSKL_ADSPCS_CPA_SHIFT;\r\nen_cores_mask &= (~val & SKL_ADSPCS_CRST_MASK(core_mask)) >>\r\nSKL_ADSPCS_CRST_SHIFT;\r\nen_cores_mask &= (~val & SKL_ADSPCS_CSTALL_MASK(core_mask)) >>\r\nSKL_ADSPCS_CSTALL_SHIFT;\r\nen_cores_mask &= core_mask;\r\ndev_dbg(ctx->dev, "DSP enabled cores mask = %x\n", en_cores_mask);\r\nreturn en_cores_mask;\r\n}\r\nstatic int\r\nskl_dsp_core_set_reset_state(struct sst_dsp *ctx, unsigned int core_mask)\r\n{\r\nint ret;\r\nsst_dsp_shim_update_bits_unlocked(ctx,\r\nSKL_ADSP_REG_ADSPCS, SKL_ADSPCS_CRST_MASK(core_mask),\r\nSKL_ADSPCS_CRST_MASK(core_mask));\r\nret = sst_dsp_register_poll(ctx,\r\nSKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_CRST_MASK(core_mask),\r\nSKL_ADSPCS_CRST_MASK(core_mask),\r\nSKL_DSP_RESET_TO,\r\n"Set reset");\r\nif ((sst_dsp_shim_read_unlocked(ctx, SKL_ADSP_REG_ADSPCS) &\r\nSKL_ADSPCS_CRST_MASK(core_mask)) !=\r\nSKL_ADSPCS_CRST_MASK(core_mask)) {\r\ndev_err(ctx->dev, "Set reset state failed: core_mask %x\n",\r\ncore_mask);\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nint skl_dsp_core_unset_reset_state(\r\nstruct sst_dsp *ctx, unsigned int core_mask)\r\n{\r\nint ret;\r\ndev_dbg(ctx->dev, "In %s\n", __func__);\r\nsst_dsp_shim_update_bits_unlocked(ctx, SKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_CRST_MASK(core_mask), 0);\r\nret = sst_dsp_register_poll(ctx,\r\nSKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_CRST_MASK(core_mask),\r\n0,\r\nSKL_DSP_RESET_TO,\r\n"Unset reset");\r\nif ((sst_dsp_shim_read_unlocked(ctx, SKL_ADSP_REG_ADSPCS) &\r\nSKL_ADSPCS_CRST_MASK(core_mask)) != 0) {\r\ndev_err(ctx->dev, "Unset reset state failed: core_mask %x\n",\r\ncore_mask);\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic bool\r\nis_skl_dsp_core_enable(struct sst_dsp *ctx, unsigned int core_mask)\r\n{\r\nint val;\r\nbool is_enable;\r\nval = sst_dsp_shim_read_unlocked(ctx, SKL_ADSP_REG_ADSPCS);\r\nis_enable = ((val & SKL_ADSPCS_CPA_MASK(core_mask)) &&\r\n(val & SKL_ADSPCS_SPA_MASK(core_mask)) &&\r\n!(val & SKL_ADSPCS_CRST_MASK(core_mask)) &&\r\n!(val & SKL_ADSPCS_CSTALL_MASK(core_mask)));\r\ndev_dbg(ctx->dev, "DSP core(s) enabled? %d : core_mask %x\n",\r\nis_enable, core_mask);\r\nreturn is_enable;\r\n}\r\nstatic int skl_dsp_reset_core(struct sst_dsp *ctx, unsigned int core_mask)\r\n{\r\nsst_dsp_shim_update_bits_unlocked(ctx, SKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_CSTALL_MASK(core_mask),\r\nSKL_ADSPCS_CSTALL_MASK(core_mask));\r\nreturn skl_dsp_core_set_reset_state(ctx, core_mask);\r\n}\r\nint skl_dsp_start_core(struct sst_dsp *ctx, unsigned int core_mask)\r\n{\r\nint ret;\r\nret = skl_dsp_core_unset_reset_state(ctx, core_mask);\r\nif (ret < 0)\r\nreturn ret;\r\ndev_dbg(ctx->dev, "unstall/run core: core_mask = %x\n", core_mask);\r\nsst_dsp_shim_update_bits_unlocked(ctx, SKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_CSTALL_MASK(core_mask), 0);\r\nif (!is_skl_dsp_core_enable(ctx, core_mask)) {\r\nskl_dsp_reset_core(ctx, core_mask);\r\ndev_err(ctx->dev, "DSP start core failed: core_mask %x\n",\r\ncore_mask);\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nint skl_dsp_core_power_up(struct sst_dsp *ctx, unsigned int core_mask)\r\n{\r\nint ret;\r\nsst_dsp_shim_update_bits_unlocked(ctx, SKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_SPA_MASK(core_mask),\r\nSKL_ADSPCS_SPA_MASK(core_mask));\r\nret = sst_dsp_register_poll(ctx,\r\nSKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_CPA_MASK(core_mask),\r\nSKL_ADSPCS_CPA_MASK(core_mask),\r\nSKL_DSP_PU_TO,\r\n"Power up");\r\nif ((sst_dsp_shim_read_unlocked(ctx, SKL_ADSP_REG_ADSPCS) &\r\nSKL_ADSPCS_CPA_MASK(core_mask)) !=\r\nSKL_ADSPCS_CPA_MASK(core_mask)) {\r\ndev_err(ctx->dev, "DSP core power up failed: core_mask %x\n",\r\ncore_mask);\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nint skl_dsp_core_power_down(struct sst_dsp *ctx, unsigned int core_mask)\r\n{\r\nsst_dsp_shim_update_bits_unlocked(ctx, SKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_SPA_MASK(core_mask), 0);\r\nreturn sst_dsp_register_poll(ctx,\r\nSKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_CPA_MASK(core_mask),\r\n0,\r\nSKL_DSP_PD_TO,\r\n"Power down");\r\n}\r\nint skl_dsp_enable_core(struct sst_dsp *ctx, unsigned int core_mask)\r\n{\r\nint ret;\r\nret = skl_dsp_core_power_up(ctx, core_mask);\r\nif (ret < 0) {\r\ndev_err(ctx->dev, "dsp core power up failed: core_mask %x\n",\r\ncore_mask);\r\nreturn ret;\r\n}\r\nreturn skl_dsp_start_core(ctx, core_mask);\r\n}\r\nint skl_dsp_disable_core(struct sst_dsp *ctx, unsigned int core_mask)\r\n{\r\nint ret;\r\nret = skl_dsp_reset_core(ctx, core_mask);\r\nif (ret < 0) {\r\ndev_err(ctx->dev, "dsp core reset failed: core_mask %x\n",\r\ncore_mask);\r\nreturn ret;\r\n}\r\nret = skl_dsp_core_power_down(ctx, core_mask);\r\nif (ret < 0) {\r\ndev_err(ctx->dev, "dsp core power down fail mask %x: %d\n",\r\ncore_mask, ret);\r\nreturn ret;\r\n}\r\nif (is_skl_dsp_core_enable(ctx, core_mask)) {\r\ndev_err(ctx->dev, "dsp core disable fail mask %x: %d\n",\r\ncore_mask, ret);\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nint skl_dsp_boot(struct sst_dsp *ctx)\r\n{\r\nint ret;\r\nif (is_skl_dsp_core_enable(ctx, SKL_DSP_CORE0_MASK)) {\r\nret = skl_dsp_reset_core(ctx, SKL_DSP_CORE0_MASK);\r\nif (ret < 0) {\r\ndev_err(ctx->dev, "dsp core0 reset fail: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = skl_dsp_start_core(ctx, SKL_DSP_CORE0_MASK);\r\nif (ret < 0) {\r\ndev_err(ctx->dev, "dsp core0 start fail: %d\n", ret);\r\nreturn ret;\r\n}\r\n} else {\r\nret = skl_dsp_disable_core(ctx, SKL_DSP_CORE0_MASK);\r\nif (ret < 0) {\r\ndev_err(ctx->dev, "dsp core0 disable fail: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = skl_dsp_enable_core(ctx, SKL_DSP_CORE0_MASK);\r\n}\r\nreturn ret;\r\n}\r\nirqreturn_t skl_dsp_sst_interrupt(int irq, void *dev_id)\r\n{\r\nstruct sst_dsp *ctx = dev_id;\r\nu32 val;\r\nirqreturn_t result = IRQ_NONE;\r\nspin_lock(&ctx->spinlock);\r\nval = sst_dsp_shim_read_unlocked(ctx, SKL_ADSP_REG_ADSPIS);\r\nctx->intr_status = val;\r\nif (val == 0xffffffff) {\r\nspin_unlock(&ctx->spinlock);\r\nreturn IRQ_NONE;\r\n}\r\nif (val & SKL_ADSPIS_IPC) {\r\nskl_ipc_int_disable(ctx);\r\nresult = IRQ_WAKE_THREAD;\r\n}\r\nif (val & SKL_ADSPIS_CL_DMA) {\r\nskl_cldma_int_disable(ctx);\r\nresult = IRQ_WAKE_THREAD;\r\n}\r\nspin_unlock(&ctx->spinlock);\r\nreturn result;\r\n}\r\nint skl_dsp_get_core(struct sst_dsp *ctx, unsigned int core_id)\r\n{\r\nstruct skl_sst *skl = ctx->thread_context;\r\nint ret = 0;\r\nif (core_id >= skl->cores.count) {\r\ndev_err(ctx->dev, "invalid core id: %d\n", core_id);\r\nreturn -EINVAL;\r\n}\r\nif (skl->cores.state[core_id] == SKL_DSP_RESET) {\r\nret = ctx->fw_ops.set_state_D0(ctx, core_id);\r\nif (ret < 0) {\r\ndev_err(ctx->dev, "unable to get core%d\n", core_id);\r\nreturn ret;\r\n}\r\n}\r\nskl->cores.usage_count[core_id]++;\r\ndev_dbg(ctx->dev, "core id %d state %d usage_count %d\n",\r\ncore_id, skl->cores.state[core_id],\r\nskl->cores.usage_count[core_id]);\r\nreturn ret;\r\n}\r\nint skl_dsp_put_core(struct sst_dsp *ctx, unsigned int core_id)\r\n{\r\nstruct skl_sst *skl = ctx->thread_context;\r\nint ret = 0;\r\nif (core_id >= skl->cores.count) {\r\ndev_err(ctx->dev, "invalid core id: %d\n", core_id);\r\nreturn -EINVAL;\r\n}\r\nif (--skl->cores.usage_count[core_id] == 0) {\r\nret = ctx->fw_ops.set_state_D3(ctx, core_id);\r\nif (ret < 0) {\r\ndev_err(ctx->dev, "unable to put core %d: %d\n",\r\ncore_id, ret);\r\nskl->cores.usage_count[core_id]++;\r\n}\r\n}\r\ndev_dbg(ctx->dev, "core id %d state %d usage_count %d\n",\r\ncore_id, skl->cores.state[core_id],\r\nskl->cores.usage_count[core_id]);\r\nreturn ret;\r\n}\r\nint skl_dsp_wake(struct sst_dsp *ctx)\r\n{\r\nreturn skl_dsp_get_core(ctx, SKL_DSP_CORE0_ID);\r\n}\r\nint skl_dsp_sleep(struct sst_dsp *ctx)\r\n{\r\nreturn skl_dsp_put_core(ctx, SKL_DSP_CORE0_ID);\r\n}\r\nstruct sst_dsp *skl_dsp_ctx_init(struct device *dev,\r\nstruct sst_dsp_device *sst_dev, int irq)\r\n{\r\nint ret;\r\nstruct sst_dsp *sst;\r\nsst = devm_kzalloc(dev, sizeof(*sst), GFP_KERNEL);\r\nif (sst == NULL)\r\nreturn NULL;\r\nspin_lock_init(&sst->spinlock);\r\nmutex_init(&sst->mutex);\r\nsst->dev = dev;\r\nsst->sst_dev = sst_dev;\r\nsst->irq = irq;\r\nsst->ops = sst_dev->ops;\r\nsst->thread_context = sst_dev->thread_context;\r\nif (sst->ops->init) {\r\nret = sst->ops->init(sst, NULL);\r\nif (ret < 0)\r\nreturn NULL;\r\n}\r\nret = request_threaded_irq(sst->irq, sst->ops->irq_handler,\r\nsst_dev->thread, IRQF_SHARED, "AudioDSP", sst);\r\nif (ret) {\r\ndev_err(sst->dev, "unable to grab threaded IRQ %d, disabling device\n",\r\nsst->irq);\r\nreturn NULL;\r\n}\r\nreturn sst;\r\n}\r\nvoid skl_dsp_free(struct sst_dsp *dsp)\r\n{\r\nskl_ipc_int_disable(dsp);\r\nfree_irq(dsp->irq, dsp);\r\nskl_ipc_op_int_disable(dsp);\r\nskl_dsp_disable_core(dsp, SKL_DSP_CORE0_MASK);\r\n}\r\nbool is_skl_dsp_running(struct sst_dsp *ctx)\r\n{\r\nreturn (ctx->sst_state == SKL_DSP_RUNNING);\r\n}

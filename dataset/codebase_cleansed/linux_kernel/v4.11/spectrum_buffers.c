static struct mlxsw_sp_sb_pr *mlxsw_sp_sb_pr_get(struct mlxsw_sp *mlxsw_sp,\r\nu8 pool,\r\nenum mlxsw_reg_sbxx_dir dir)\r\n{\r\nreturn &mlxsw_sp->sb.prs[dir][pool];\r\n}\r\nstatic struct mlxsw_sp_sb_cm *mlxsw_sp_sb_cm_get(struct mlxsw_sp *mlxsw_sp,\r\nu8 local_port, u8 pg_buff,\r\nenum mlxsw_reg_sbxx_dir dir)\r\n{\r\nreturn &mlxsw_sp->sb.ports[local_port].cms[dir][pg_buff];\r\n}\r\nstatic struct mlxsw_sp_sb_pm *mlxsw_sp_sb_pm_get(struct mlxsw_sp *mlxsw_sp,\r\nu8 local_port, u8 pool,\r\nenum mlxsw_reg_sbxx_dir dir)\r\n{\r\nreturn &mlxsw_sp->sb.ports[local_port].pms[dir][pool];\r\n}\r\nstatic int mlxsw_sp_sb_pr_write(struct mlxsw_sp *mlxsw_sp, u8 pool,\r\nenum mlxsw_reg_sbxx_dir dir,\r\nenum mlxsw_reg_sbpr_mode mode, u32 size)\r\n{\r\nchar sbpr_pl[MLXSW_REG_SBPR_LEN];\r\nstruct mlxsw_sp_sb_pr *pr;\r\nint err;\r\nmlxsw_reg_sbpr_pack(sbpr_pl, pool, dir, mode, size);\r\nerr = mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(sbpr), sbpr_pl);\r\nif (err)\r\nreturn err;\r\npr = mlxsw_sp_sb_pr_get(mlxsw_sp, pool, dir);\r\npr->mode = mode;\r\npr->size = size;\r\nreturn 0;\r\n}\r\nstatic int mlxsw_sp_sb_cm_write(struct mlxsw_sp *mlxsw_sp, u8 local_port,\r\nu8 pg_buff, enum mlxsw_reg_sbxx_dir dir,\r\nu32 min_buff, u32 max_buff, u8 pool)\r\n{\r\nchar sbcm_pl[MLXSW_REG_SBCM_LEN];\r\nint err;\r\nmlxsw_reg_sbcm_pack(sbcm_pl, local_port, pg_buff, dir,\r\nmin_buff, max_buff, pool);\r\nerr = mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(sbcm), sbcm_pl);\r\nif (err)\r\nreturn err;\r\nif (pg_buff < MLXSW_SP_SB_TC_COUNT) {\r\nstruct mlxsw_sp_sb_cm *cm;\r\ncm = mlxsw_sp_sb_cm_get(mlxsw_sp, local_port, pg_buff, dir);\r\ncm->min_buff = min_buff;\r\ncm->max_buff = max_buff;\r\ncm->pool = pool;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mlxsw_sp_sb_pm_write(struct mlxsw_sp *mlxsw_sp, u8 local_port,\r\nu8 pool, enum mlxsw_reg_sbxx_dir dir,\r\nu32 min_buff, u32 max_buff)\r\n{\r\nchar sbpm_pl[MLXSW_REG_SBPM_LEN];\r\nstruct mlxsw_sp_sb_pm *pm;\r\nint err;\r\nmlxsw_reg_sbpm_pack(sbpm_pl, local_port, pool, dir, false,\r\nmin_buff, max_buff);\r\nerr = mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(sbpm), sbpm_pl);\r\nif (err)\r\nreturn err;\r\npm = mlxsw_sp_sb_pm_get(mlxsw_sp, local_port, pool, dir);\r\npm->min_buff = min_buff;\r\npm->max_buff = max_buff;\r\nreturn 0;\r\n}\r\nstatic int mlxsw_sp_sb_pm_occ_clear(struct mlxsw_sp *mlxsw_sp, u8 local_port,\r\nu8 pool, enum mlxsw_reg_sbxx_dir dir,\r\nstruct list_head *bulk_list)\r\n{\r\nchar sbpm_pl[MLXSW_REG_SBPM_LEN];\r\nmlxsw_reg_sbpm_pack(sbpm_pl, local_port, pool, dir, true, 0, 0);\r\nreturn mlxsw_reg_trans_query(mlxsw_sp->core, MLXSW_REG(sbpm), sbpm_pl,\r\nbulk_list, NULL, 0);\r\n}\r\nstatic void mlxsw_sp_sb_pm_occ_query_cb(struct mlxsw_core *mlxsw_core,\r\nchar *sbpm_pl, size_t sbpm_pl_len,\r\nunsigned long cb_priv)\r\n{\r\nstruct mlxsw_sp_sb_pm *pm = (struct mlxsw_sp_sb_pm *) cb_priv;\r\nmlxsw_reg_sbpm_unpack(sbpm_pl, &pm->occ.cur, &pm->occ.max);\r\n}\r\nstatic int mlxsw_sp_sb_pm_occ_query(struct mlxsw_sp *mlxsw_sp, u8 local_port,\r\nu8 pool, enum mlxsw_reg_sbxx_dir dir,\r\nstruct list_head *bulk_list)\r\n{\r\nchar sbpm_pl[MLXSW_REG_SBPM_LEN];\r\nstruct mlxsw_sp_sb_pm *pm;\r\npm = mlxsw_sp_sb_pm_get(mlxsw_sp, local_port, pool, dir);\r\nmlxsw_reg_sbpm_pack(sbpm_pl, local_port, pool, dir, false, 0, 0);\r\nreturn mlxsw_reg_trans_query(mlxsw_sp->core, MLXSW_REG(sbpm), sbpm_pl,\r\nbulk_list,\r\nmlxsw_sp_sb_pm_occ_query_cb,\r\n(unsigned long) pm);\r\n}\r\nstatic int mlxsw_sp_port_pb_init(struct mlxsw_sp_port *mlxsw_sp_port)\r\n{\r\nchar pbmc_pl[MLXSW_REG_PBMC_LEN];\r\nint i;\r\nmlxsw_reg_pbmc_pack(pbmc_pl, mlxsw_sp_port->local_port,\r\n0xffff, 0xffff / 2);\r\nfor (i = 0; i < MLXSW_SP_PBS_LEN; i++) {\r\nif (i == MLXSW_SP_PB_UNUSED)\r\ncontinue;\r\nmlxsw_reg_pbmc_lossy_buffer_pack(pbmc_pl, i, mlxsw_sp_pbs[i]);\r\n}\r\nmlxsw_reg_pbmc_lossy_buffer_pack(pbmc_pl,\r\nMLXSW_REG_PBMC_PORT_SHARED_BUF_IDX, 0);\r\nreturn mlxsw_reg_write(mlxsw_sp_port->mlxsw_sp->core,\r\nMLXSW_REG(pbmc), pbmc_pl);\r\n}\r\nstatic int mlxsw_sp_port_pb_prio_init(struct mlxsw_sp_port *mlxsw_sp_port)\r\n{\r\nchar pptb_pl[MLXSW_REG_PPTB_LEN];\r\nint i;\r\nmlxsw_reg_pptb_pack(pptb_pl, mlxsw_sp_port->local_port);\r\nfor (i = 0; i < IEEE_8021QAZ_MAX_TCS; i++)\r\nmlxsw_reg_pptb_prio_to_buff_pack(pptb_pl, i, 0);\r\nreturn mlxsw_reg_write(mlxsw_sp_port->mlxsw_sp->core, MLXSW_REG(pptb),\r\npptb_pl);\r\n}\r\nstatic int mlxsw_sp_port_headroom_init(struct mlxsw_sp_port *mlxsw_sp_port)\r\n{\r\nint err;\r\nerr = mlxsw_sp_port_pb_init(mlxsw_sp_port);\r\nif (err)\r\nreturn err;\r\nreturn mlxsw_sp_port_pb_prio_init(mlxsw_sp_port);\r\n}\r\nstatic int __mlxsw_sp_sb_prs_init(struct mlxsw_sp *mlxsw_sp,\r\nenum mlxsw_reg_sbxx_dir dir,\r\nconst struct mlxsw_sp_sb_pr *prs,\r\nsize_t prs_len)\r\n{\r\nint i;\r\nint err;\r\nfor (i = 0; i < prs_len; i++) {\r\nconst struct mlxsw_sp_sb_pr *pr;\r\npr = &prs[i];\r\nerr = mlxsw_sp_sb_pr_write(mlxsw_sp, i, dir,\r\npr->mode, pr->size);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mlxsw_sp_sb_prs_init(struct mlxsw_sp *mlxsw_sp)\r\n{\r\nint err;\r\nerr = __mlxsw_sp_sb_prs_init(mlxsw_sp, MLXSW_REG_SBXX_DIR_INGRESS,\r\nmlxsw_sp_sb_prs_ingress,\r\nMLXSW_SP_SB_PRS_INGRESS_LEN);\r\nif (err)\r\nreturn err;\r\nreturn __mlxsw_sp_sb_prs_init(mlxsw_sp, MLXSW_REG_SBXX_DIR_EGRESS,\r\nmlxsw_sp_sb_prs_egress,\r\nMLXSW_SP_SB_PRS_EGRESS_LEN);\r\n}\r\nstatic int __mlxsw_sp_sb_cms_init(struct mlxsw_sp *mlxsw_sp, u8 local_port,\r\nenum mlxsw_reg_sbxx_dir dir,\r\nconst struct mlxsw_sp_sb_cm *cms,\r\nsize_t cms_len)\r\n{\r\nint i;\r\nint err;\r\nfor (i = 0; i < cms_len; i++) {\r\nconst struct mlxsw_sp_sb_cm *cm;\r\nif (i == 8 && dir == MLXSW_REG_SBXX_DIR_INGRESS)\r\ncontinue;\r\ncm = &cms[i];\r\nerr = mlxsw_sp_sb_cm_write(mlxsw_sp, local_port, i, dir,\r\ncm->min_buff, cm->max_buff,\r\ncm->pool);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mlxsw_sp_port_sb_cms_init(struct mlxsw_sp_port *mlxsw_sp_port)\r\n{\r\nint err;\r\nerr = __mlxsw_sp_sb_cms_init(mlxsw_sp_port->mlxsw_sp,\r\nmlxsw_sp_port->local_port,\r\nMLXSW_REG_SBXX_DIR_INGRESS,\r\nmlxsw_sp_sb_cms_ingress,\r\nMLXSW_SP_SB_CMS_INGRESS_LEN);\r\nif (err)\r\nreturn err;\r\nreturn __mlxsw_sp_sb_cms_init(mlxsw_sp_port->mlxsw_sp,\r\nmlxsw_sp_port->local_port,\r\nMLXSW_REG_SBXX_DIR_EGRESS,\r\nmlxsw_sp_sb_cms_egress,\r\nMLXSW_SP_SB_CMS_EGRESS_LEN);\r\n}\r\nstatic int mlxsw_sp_cpu_port_sb_cms_init(struct mlxsw_sp *mlxsw_sp)\r\n{\r\nreturn __mlxsw_sp_sb_cms_init(mlxsw_sp, 0, MLXSW_REG_SBXX_DIR_EGRESS,\r\nmlxsw_sp_cpu_port_sb_cms,\r\nMLXSW_SP_CPU_PORT_SB_MCS_LEN);\r\n}\r\nstatic int __mlxsw_sp_port_sb_pms_init(struct mlxsw_sp *mlxsw_sp, u8 local_port,\r\nenum mlxsw_reg_sbxx_dir dir,\r\nconst struct mlxsw_sp_sb_pm *pms,\r\nsize_t pms_len)\r\n{\r\nint i;\r\nint err;\r\nfor (i = 0; i < pms_len; i++) {\r\nconst struct mlxsw_sp_sb_pm *pm;\r\npm = &pms[i];\r\nerr = mlxsw_sp_sb_pm_write(mlxsw_sp, local_port, i, dir,\r\npm->min_buff, pm->max_buff);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mlxsw_sp_port_sb_pms_init(struct mlxsw_sp_port *mlxsw_sp_port)\r\n{\r\nint err;\r\nerr = __mlxsw_sp_port_sb_pms_init(mlxsw_sp_port->mlxsw_sp,\r\nmlxsw_sp_port->local_port,\r\nMLXSW_REG_SBXX_DIR_INGRESS,\r\nmlxsw_sp_sb_pms_ingress,\r\nMLXSW_SP_SB_PMS_INGRESS_LEN);\r\nif (err)\r\nreturn err;\r\nreturn __mlxsw_sp_port_sb_pms_init(mlxsw_sp_port->mlxsw_sp,\r\nmlxsw_sp_port->local_port,\r\nMLXSW_REG_SBXX_DIR_EGRESS,\r\nmlxsw_sp_sb_pms_egress,\r\nMLXSW_SP_SB_PMS_EGRESS_LEN);\r\n}\r\nstatic int mlxsw_sp_sb_mms_init(struct mlxsw_sp *mlxsw_sp)\r\n{\r\nchar sbmm_pl[MLXSW_REG_SBMM_LEN];\r\nint i;\r\nint err;\r\nfor (i = 0; i < MLXSW_SP_SB_MMS_LEN; i++) {\r\nconst struct mlxsw_sp_sb_mm *mc;\r\nmc = &mlxsw_sp_sb_mms[i];\r\nmlxsw_reg_sbmm_pack(sbmm_pl, i, mc->min_buff,\r\nmc->max_buff, mc->pool);\r\nerr = mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(sbmm), sbmm_pl);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nint mlxsw_sp_buffers_init(struct mlxsw_sp *mlxsw_sp)\r\n{\r\nint err;\r\nerr = mlxsw_sp_sb_prs_init(mlxsw_sp);\r\nif (err)\r\nreturn err;\r\nerr = mlxsw_sp_cpu_port_sb_cms_init(mlxsw_sp);\r\nif (err)\r\nreturn err;\r\nerr = mlxsw_sp_sb_mms_init(mlxsw_sp);\r\nif (err)\r\nreturn err;\r\nreturn devlink_sb_register(priv_to_devlink(mlxsw_sp->core), 0,\r\nMLXSW_SP_SB_SIZE,\r\nMLXSW_SP_SB_POOL_COUNT,\r\nMLXSW_SP_SB_POOL_COUNT,\r\nMLXSW_SP_SB_TC_COUNT,\r\nMLXSW_SP_SB_TC_COUNT);\r\n}\r\nvoid mlxsw_sp_buffers_fini(struct mlxsw_sp *mlxsw_sp)\r\n{\r\ndevlink_sb_unregister(priv_to_devlink(mlxsw_sp->core), 0);\r\n}\r\nint mlxsw_sp_port_buffers_init(struct mlxsw_sp_port *mlxsw_sp_port)\r\n{\r\nint err;\r\nerr = mlxsw_sp_port_headroom_init(mlxsw_sp_port);\r\nif (err)\r\nreturn err;\r\nerr = mlxsw_sp_port_sb_cms_init(mlxsw_sp_port);\r\nif (err)\r\nreturn err;\r\nerr = mlxsw_sp_port_sb_pms_init(mlxsw_sp_port);\r\nreturn err;\r\n}\r\nstatic u8 pool_get(u16 pool_index)\r\n{\r\nreturn pool_index % MLXSW_SP_SB_POOL_COUNT;\r\n}\r\nstatic u16 pool_index_get(u8 pool, enum mlxsw_reg_sbxx_dir dir)\r\n{\r\nu16 pool_index;\r\npool_index = pool;\r\nif (dir == MLXSW_REG_SBXX_DIR_EGRESS)\r\npool_index += MLXSW_SP_SB_POOL_COUNT;\r\nreturn pool_index;\r\n}\r\nstatic enum mlxsw_reg_sbxx_dir dir_get(u16 pool_index)\r\n{\r\nreturn pool_index < MLXSW_SP_SB_POOL_COUNT ?\r\nMLXSW_REG_SBXX_DIR_INGRESS : MLXSW_REG_SBXX_DIR_EGRESS;\r\n}\r\nint mlxsw_sp_sb_pool_get(struct mlxsw_core *mlxsw_core,\r\nunsigned int sb_index, u16 pool_index,\r\nstruct devlink_sb_pool_info *pool_info)\r\n{\r\nstruct mlxsw_sp *mlxsw_sp = mlxsw_core_driver_priv(mlxsw_core);\r\nu8 pool = pool_get(pool_index);\r\nenum mlxsw_reg_sbxx_dir dir = dir_get(pool_index);\r\nstruct mlxsw_sp_sb_pr *pr = mlxsw_sp_sb_pr_get(mlxsw_sp, pool, dir);\r\npool_info->pool_type = (enum devlink_sb_pool_type) dir;\r\npool_info->size = MLXSW_SP_CELLS_TO_BYTES(pr->size);\r\npool_info->threshold_type = (enum devlink_sb_threshold_type) pr->mode;\r\nreturn 0;\r\n}\r\nint mlxsw_sp_sb_pool_set(struct mlxsw_core *mlxsw_core,\r\nunsigned int sb_index, u16 pool_index, u32 size,\r\nenum devlink_sb_threshold_type threshold_type)\r\n{\r\nstruct mlxsw_sp *mlxsw_sp = mlxsw_core_driver_priv(mlxsw_core);\r\nu8 pool = pool_get(pool_index);\r\nenum mlxsw_reg_sbxx_dir dir = dir_get(pool_index);\r\nu32 pool_size = MLXSW_SP_BYTES_TO_CELLS(size);\r\nenum mlxsw_reg_sbpr_mode mode;\r\nif (size > MLXSW_CORE_RES_GET(mlxsw_sp->core, MAX_BUFFER_SIZE))\r\nreturn -EINVAL;\r\nmode = (enum mlxsw_reg_sbpr_mode) threshold_type;\r\nreturn mlxsw_sp_sb_pr_write(mlxsw_sp, pool, dir, mode, pool_size);\r\n}\r\nstatic u32 mlxsw_sp_sb_threshold_out(struct mlxsw_sp *mlxsw_sp, u8 pool,\r\nenum mlxsw_reg_sbxx_dir dir, u32 max_buff)\r\n{\r\nstruct mlxsw_sp_sb_pr *pr = mlxsw_sp_sb_pr_get(mlxsw_sp, pool, dir);\r\nif (pr->mode == MLXSW_REG_SBPR_MODE_DYNAMIC)\r\nreturn max_buff - MLXSW_SP_SB_THRESHOLD_TO_ALPHA_OFFSET;\r\nreturn MLXSW_SP_CELLS_TO_BYTES(max_buff);\r\n}\r\nstatic int mlxsw_sp_sb_threshold_in(struct mlxsw_sp *mlxsw_sp, u8 pool,\r\nenum mlxsw_reg_sbxx_dir dir, u32 threshold,\r\nu32 *p_max_buff)\r\n{\r\nstruct mlxsw_sp_sb_pr *pr = mlxsw_sp_sb_pr_get(mlxsw_sp, pool, dir);\r\nif (pr->mode == MLXSW_REG_SBPR_MODE_DYNAMIC) {\r\nint val;\r\nval = threshold + MLXSW_SP_SB_THRESHOLD_TO_ALPHA_OFFSET;\r\nif (val < MLXSW_REG_SBXX_DYN_MAX_BUFF_MIN ||\r\nval > MLXSW_REG_SBXX_DYN_MAX_BUFF_MAX)\r\nreturn -EINVAL;\r\n*p_max_buff = val;\r\n} else {\r\n*p_max_buff = MLXSW_SP_BYTES_TO_CELLS(threshold);\r\n}\r\nreturn 0;\r\n}\r\nint mlxsw_sp_sb_port_pool_get(struct mlxsw_core_port *mlxsw_core_port,\r\nunsigned int sb_index, u16 pool_index,\r\nu32 *p_threshold)\r\n{\r\nstruct mlxsw_sp_port *mlxsw_sp_port =\r\nmlxsw_core_port_driver_priv(mlxsw_core_port);\r\nstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\r\nu8 local_port = mlxsw_sp_port->local_port;\r\nu8 pool = pool_get(pool_index);\r\nenum mlxsw_reg_sbxx_dir dir = dir_get(pool_index);\r\nstruct mlxsw_sp_sb_pm *pm = mlxsw_sp_sb_pm_get(mlxsw_sp, local_port,\r\npool, dir);\r\n*p_threshold = mlxsw_sp_sb_threshold_out(mlxsw_sp, pool, dir,\r\npm->max_buff);\r\nreturn 0;\r\n}\r\nint mlxsw_sp_sb_port_pool_set(struct mlxsw_core_port *mlxsw_core_port,\r\nunsigned int sb_index, u16 pool_index,\r\nu32 threshold)\r\n{\r\nstruct mlxsw_sp_port *mlxsw_sp_port =\r\nmlxsw_core_port_driver_priv(mlxsw_core_port);\r\nstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\r\nu8 local_port = mlxsw_sp_port->local_port;\r\nu8 pool = pool_get(pool_index);\r\nenum mlxsw_reg_sbxx_dir dir = dir_get(pool_index);\r\nu32 max_buff;\r\nint err;\r\nerr = mlxsw_sp_sb_threshold_in(mlxsw_sp, pool, dir,\r\nthreshold, &max_buff);\r\nif (err)\r\nreturn err;\r\nreturn mlxsw_sp_sb_pm_write(mlxsw_sp, local_port, pool, dir,\r\n0, max_buff);\r\n}\r\nint mlxsw_sp_sb_tc_pool_bind_get(struct mlxsw_core_port *mlxsw_core_port,\r\nunsigned int sb_index, u16 tc_index,\r\nenum devlink_sb_pool_type pool_type,\r\nu16 *p_pool_index, u32 *p_threshold)\r\n{\r\nstruct mlxsw_sp_port *mlxsw_sp_port =\r\nmlxsw_core_port_driver_priv(mlxsw_core_port);\r\nstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\r\nu8 local_port = mlxsw_sp_port->local_port;\r\nu8 pg_buff = tc_index;\r\nenum mlxsw_reg_sbxx_dir dir = (enum mlxsw_reg_sbxx_dir) pool_type;\r\nstruct mlxsw_sp_sb_cm *cm = mlxsw_sp_sb_cm_get(mlxsw_sp, local_port,\r\npg_buff, dir);\r\n*p_threshold = mlxsw_sp_sb_threshold_out(mlxsw_sp, cm->pool, dir,\r\ncm->max_buff);\r\n*p_pool_index = pool_index_get(cm->pool, dir);\r\nreturn 0;\r\n}\r\nint mlxsw_sp_sb_tc_pool_bind_set(struct mlxsw_core_port *mlxsw_core_port,\r\nunsigned int sb_index, u16 tc_index,\r\nenum devlink_sb_pool_type pool_type,\r\nu16 pool_index, u32 threshold)\r\n{\r\nstruct mlxsw_sp_port *mlxsw_sp_port =\r\nmlxsw_core_port_driver_priv(mlxsw_core_port);\r\nstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\r\nu8 local_port = mlxsw_sp_port->local_port;\r\nu8 pg_buff = tc_index;\r\nenum mlxsw_reg_sbxx_dir dir = (enum mlxsw_reg_sbxx_dir) pool_type;\r\nu8 pool = pool_get(pool_index);\r\nu32 max_buff;\r\nint err;\r\nif (dir != dir_get(pool_index))\r\nreturn -EINVAL;\r\nerr = mlxsw_sp_sb_threshold_in(mlxsw_sp, pool, dir,\r\nthreshold, &max_buff);\r\nif (err)\r\nreturn err;\r\nreturn mlxsw_sp_sb_cm_write(mlxsw_sp, local_port, pg_buff, dir,\r\n0, max_buff, pool);\r\n}\r\nstatic void mlxsw_sp_sb_sr_occ_query_cb(struct mlxsw_core *mlxsw_core,\r\nchar *sbsr_pl, size_t sbsr_pl_len,\r\nunsigned long cb_priv)\r\n{\r\nstruct mlxsw_sp *mlxsw_sp = mlxsw_core_driver_priv(mlxsw_core);\r\nstruct mlxsw_sp_sb_sr_occ_query_cb_ctx cb_ctx;\r\nu8 masked_count;\r\nu8 local_port;\r\nint rec_index = 0;\r\nstruct mlxsw_sp_sb_cm *cm;\r\nint i;\r\nmemcpy(&cb_ctx, &cb_priv, sizeof(cb_ctx));\r\nmasked_count = 0;\r\nfor (local_port = cb_ctx.local_port_1;\r\nlocal_port < MLXSW_PORT_MAX_PORTS; local_port++) {\r\nif (!mlxsw_sp->ports[local_port])\r\ncontinue;\r\nfor (i = 0; i < MLXSW_SP_SB_TC_COUNT; i++) {\r\ncm = mlxsw_sp_sb_cm_get(mlxsw_sp, local_port, i,\r\nMLXSW_REG_SBXX_DIR_INGRESS);\r\nmlxsw_reg_sbsr_rec_unpack(sbsr_pl, rec_index++,\r\n&cm->occ.cur, &cm->occ.max);\r\n}\r\nif (++masked_count == cb_ctx.masked_count)\r\nbreak;\r\n}\r\nmasked_count = 0;\r\nfor (local_port = cb_ctx.local_port_1;\r\nlocal_port < MLXSW_PORT_MAX_PORTS; local_port++) {\r\nif (!mlxsw_sp->ports[local_port])\r\ncontinue;\r\nfor (i = 0; i < MLXSW_SP_SB_TC_COUNT; i++) {\r\ncm = mlxsw_sp_sb_cm_get(mlxsw_sp, local_port, i,\r\nMLXSW_REG_SBXX_DIR_EGRESS);\r\nmlxsw_reg_sbsr_rec_unpack(sbsr_pl, rec_index++,\r\n&cm->occ.cur, &cm->occ.max);\r\n}\r\nif (++masked_count == cb_ctx.masked_count)\r\nbreak;\r\n}\r\n}\r\nint mlxsw_sp_sb_occ_snapshot(struct mlxsw_core *mlxsw_core,\r\nunsigned int sb_index)\r\n{\r\nstruct mlxsw_sp *mlxsw_sp = mlxsw_core_driver_priv(mlxsw_core);\r\nstruct mlxsw_sp_sb_sr_occ_query_cb_ctx cb_ctx;\r\nunsigned long cb_priv;\r\nLIST_HEAD(bulk_list);\r\nchar *sbsr_pl;\r\nu8 masked_count;\r\nu8 local_port_1;\r\nu8 local_port = 0;\r\nint i;\r\nint err;\r\nint err2;\r\nsbsr_pl = kmalloc(MLXSW_REG_SBSR_LEN, GFP_KERNEL);\r\nif (!sbsr_pl)\r\nreturn -ENOMEM;\r\nnext_batch:\r\nlocal_port++;\r\nlocal_port_1 = local_port;\r\nmasked_count = 0;\r\nmlxsw_reg_sbsr_pack(sbsr_pl, false);\r\nfor (i = 0; i < MLXSW_SP_SB_TC_COUNT; i++) {\r\nmlxsw_reg_sbsr_pg_buff_mask_set(sbsr_pl, i, 1);\r\nmlxsw_reg_sbsr_tclass_mask_set(sbsr_pl, i, 1);\r\n}\r\nfor (; local_port < MLXSW_PORT_MAX_PORTS; local_port++) {\r\nif (!mlxsw_sp->ports[local_port])\r\ncontinue;\r\nmlxsw_reg_sbsr_ingress_port_mask_set(sbsr_pl, local_port, 1);\r\nmlxsw_reg_sbsr_egress_port_mask_set(sbsr_pl, local_port, 1);\r\nfor (i = 0; i < MLXSW_SP_SB_POOL_COUNT; i++) {\r\nerr = mlxsw_sp_sb_pm_occ_query(mlxsw_sp, local_port, i,\r\nMLXSW_REG_SBXX_DIR_INGRESS,\r\n&bulk_list);\r\nif (err)\r\ngoto out;\r\nerr = mlxsw_sp_sb_pm_occ_query(mlxsw_sp, local_port, i,\r\nMLXSW_REG_SBXX_DIR_EGRESS,\r\n&bulk_list);\r\nif (err)\r\ngoto out;\r\n}\r\nif (++masked_count == MASKED_COUNT_MAX)\r\ngoto do_query;\r\n}\r\ndo_query:\r\ncb_ctx.masked_count = masked_count;\r\ncb_ctx.local_port_1 = local_port_1;\r\nmemcpy(&cb_priv, &cb_ctx, sizeof(cb_ctx));\r\nerr = mlxsw_reg_trans_query(mlxsw_core, MLXSW_REG(sbsr), sbsr_pl,\r\n&bulk_list, mlxsw_sp_sb_sr_occ_query_cb,\r\ncb_priv);\r\nif (err)\r\ngoto out;\r\nif (local_port < MLXSW_PORT_MAX_PORTS)\r\ngoto next_batch;\r\nout:\r\nerr2 = mlxsw_reg_trans_bulk_wait(&bulk_list);\r\nif (!err)\r\nerr = err2;\r\nkfree(sbsr_pl);\r\nreturn err;\r\n}\r\nint mlxsw_sp_sb_occ_max_clear(struct mlxsw_core *mlxsw_core,\r\nunsigned int sb_index)\r\n{\r\nstruct mlxsw_sp *mlxsw_sp = mlxsw_core_driver_priv(mlxsw_core);\r\nLIST_HEAD(bulk_list);\r\nchar *sbsr_pl;\r\nunsigned int masked_count;\r\nu8 local_port = 0;\r\nint i;\r\nint err;\r\nint err2;\r\nsbsr_pl = kmalloc(MLXSW_REG_SBSR_LEN, GFP_KERNEL);\r\nif (!sbsr_pl)\r\nreturn -ENOMEM;\r\nnext_batch:\r\nlocal_port++;\r\nmasked_count = 0;\r\nmlxsw_reg_sbsr_pack(sbsr_pl, true);\r\nfor (i = 0; i < MLXSW_SP_SB_TC_COUNT; i++) {\r\nmlxsw_reg_sbsr_pg_buff_mask_set(sbsr_pl, i, 1);\r\nmlxsw_reg_sbsr_tclass_mask_set(sbsr_pl, i, 1);\r\n}\r\nfor (; local_port < MLXSW_PORT_MAX_PORTS; local_port++) {\r\nif (!mlxsw_sp->ports[local_port])\r\ncontinue;\r\nmlxsw_reg_sbsr_ingress_port_mask_set(sbsr_pl, local_port, 1);\r\nmlxsw_reg_sbsr_egress_port_mask_set(sbsr_pl, local_port, 1);\r\nfor (i = 0; i < MLXSW_SP_SB_POOL_COUNT; i++) {\r\nerr = mlxsw_sp_sb_pm_occ_clear(mlxsw_sp, local_port, i,\r\nMLXSW_REG_SBXX_DIR_INGRESS,\r\n&bulk_list);\r\nif (err)\r\ngoto out;\r\nerr = mlxsw_sp_sb_pm_occ_clear(mlxsw_sp, local_port, i,\r\nMLXSW_REG_SBXX_DIR_EGRESS,\r\n&bulk_list);\r\nif (err)\r\ngoto out;\r\n}\r\nif (++masked_count == MASKED_COUNT_MAX)\r\ngoto do_query;\r\n}\r\ndo_query:\r\nerr = mlxsw_reg_trans_query(mlxsw_core, MLXSW_REG(sbsr), sbsr_pl,\r\n&bulk_list, NULL, 0);\r\nif (err)\r\ngoto out;\r\nif (local_port < MLXSW_PORT_MAX_PORTS)\r\ngoto next_batch;\r\nout:\r\nerr2 = mlxsw_reg_trans_bulk_wait(&bulk_list);\r\nif (!err)\r\nerr = err2;\r\nkfree(sbsr_pl);\r\nreturn err;\r\n}\r\nint mlxsw_sp_sb_occ_port_pool_get(struct mlxsw_core_port *mlxsw_core_port,\r\nunsigned int sb_index, u16 pool_index,\r\nu32 *p_cur, u32 *p_max)\r\n{\r\nstruct mlxsw_sp_port *mlxsw_sp_port =\r\nmlxsw_core_port_driver_priv(mlxsw_core_port);\r\nstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\r\nu8 local_port = mlxsw_sp_port->local_port;\r\nu8 pool = pool_get(pool_index);\r\nenum mlxsw_reg_sbxx_dir dir = dir_get(pool_index);\r\nstruct mlxsw_sp_sb_pm *pm = mlxsw_sp_sb_pm_get(mlxsw_sp, local_port,\r\npool, dir);\r\n*p_cur = MLXSW_SP_CELLS_TO_BYTES(pm->occ.cur);\r\n*p_max = MLXSW_SP_CELLS_TO_BYTES(pm->occ.max);\r\nreturn 0;\r\n}\r\nint mlxsw_sp_sb_occ_tc_port_bind_get(struct mlxsw_core_port *mlxsw_core_port,\r\nunsigned int sb_index, u16 tc_index,\r\nenum devlink_sb_pool_type pool_type,\r\nu32 *p_cur, u32 *p_max)\r\n{\r\nstruct mlxsw_sp_port *mlxsw_sp_port =\r\nmlxsw_core_port_driver_priv(mlxsw_core_port);\r\nstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\r\nu8 local_port = mlxsw_sp_port->local_port;\r\nu8 pg_buff = tc_index;\r\nenum mlxsw_reg_sbxx_dir dir = (enum mlxsw_reg_sbxx_dir) pool_type;\r\nstruct mlxsw_sp_sb_cm *cm = mlxsw_sp_sb_cm_get(mlxsw_sp, local_port,\r\npg_buff, dir);\r\n*p_cur = MLXSW_SP_CELLS_TO_BYTES(cm->occ.cur);\r\n*p_max = MLXSW_SP_CELLS_TO_BYTES(cm->occ.max);\r\nreturn 0;\r\n}

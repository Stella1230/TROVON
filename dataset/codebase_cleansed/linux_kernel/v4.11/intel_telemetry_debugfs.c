static int telemetry_debugfs_check_evts(void)\r\n{\r\nif ((debugfs_conf->pss_idle_evts > TELEM_PSS_IDLE_EVTS) ||\r\n(debugfs_conf->pcs_idle_blkd_evts > TELEM_PSS_IDLE_BLOCKED_EVTS) ||\r\n(debugfs_conf->pcs_s0ix_blkd_evts > TELEM_PSS_S0IX_BLOCKED_EVTS) ||\r\n(debugfs_conf->pss_ltr_evts > TELEM_PSS_LTR_BLOCKING_EVTS) ||\r\n(debugfs_conf->pss_wakeup_evts > TELEM_PSS_S0IX_WAKEUP_EVTS) ||\r\n(debugfs_conf->ioss_d0ix_evts > TELEM_IOSS_DX_D0IX_EVTS) ||\r\n(debugfs_conf->ioss_pg_evts > TELEM_IOSS_PG_EVTS))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int telem_pss_states_show(struct seq_file *s, void *unused)\r\n{\r\nstruct telemetry_evtlog evtlog[TELEM_MAX_OS_ALLOCATED_EVENTS];\r\nstruct telemetry_debugfs_conf *conf = debugfs_conf;\r\nconst char *name[TELEM_MAX_OS_ALLOCATED_EVENTS];\r\nu32 pcs_idle_blkd[TELEM_PSS_IDLE_BLOCKED_EVTS],\r\npcs_s0ix_blkd[TELEM_PSS_S0IX_BLOCKED_EVTS],\r\npss_s0ix_wakeup[TELEM_PSS_S0IX_WAKEUP_EVTS],\r\npss_ltr_blkd[TELEM_PSS_LTR_BLOCKING_EVTS],\r\npss_idle[TELEM_PSS_IDLE_EVTS];\r\nint index, idx, ret, err = 0;\r\nu64 pstates = 0;\r\nret = telemetry_read_eventlog(TELEM_PSS, evtlog,\r\nTELEM_MAX_OS_ALLOCATED_EVENTS);\r\nif (ret < 0)\r\nreturn ret;\r\nerr = telemetry_get_evtname(TELEM_PSS, name,\r\nTELEM_MAX_OS_ALLOCATED_EVENTS);\r\nif (err < 0)\r\nreturn err;\r\nseq_puts(s, "\n----------------------------------------------------\n");\r\nseq_puts(s, "\tPSS TELEM EVENTLOG (Residency = field/19.2 us\n");\r\nseq_puts(s, "----------------------------------------------------\n");\r\nfor (index = 0; index < ret; index++) {\r\nseq_printf(s, "%-32s %llu\n",\r\nname[index], evtlog[index].telem_evtlog);\r\nif (evtlog[index].telem_evtid == conf->pss_idle_id) {\r\npss_idle[conf->pss_idle_evts - 1] =\r\n(evtlog[index].telem_evtlog >>\r\nconf->pss_idle_data[conf->pss_idle_evts - 1].bit_pos) &\r\nTELEM_APL_MASK_PCS_STATE;\r\n}\r\nTELEM_CHECK_AND_PARSE_EVTS(conf->pss_idle_id,\r\nconf->pss_idle_evts - 1,\r\npss_idle, evtlog[index].telem_evtlog,\r\nconf->pss_idle_data, TELEM_MASK_BIT);\r\nTELEM_CHECK_AND_PARSE_EVTS(conf->pcs_idle_blkd_id,\r\nconf->pcs_idle_blkd_evts,\r\npcs_idle_blkd,\r\nevtlog[index].telem_evtlog,\r\nconf->pcs_idle_blkd_data,\r\nTELEM_MASK_BYTE);\r\nTELEM_CHECK_AND_PARSE_EVTS(conf->pcs_s0ix_blkd_id,\r\nconf->pcs_s0ix_blkd_evts,\r\npcs_s0ix_blkd,\r\nevtlog[index].telem_evtlog,\r\nconf->pcs_s0ix_blkd_data,\r\nTELEM_MASK_BYTE);\r\nTELEM_CHECK_AND_PARSE_EVTS(conf->pss_wakeup_id,\r\nconf->pss_wakeup_evts,\r\npss_s0ix_wakeup,\r\nevtlog[index].telem_evtlog,\r\nconf->pss_wakeup, TELEM_MASK_BYTE);\r\nTELEM_CHECK_AND_PARSE_EVTS(conf->pss_ltr_blocking_id,\r\nconf->pss_ltr_evts, pss_ltr_blkd,\r\nevtlog[index].telem_evtlog,\r\nconf->pss_ltr_data, TELEM_MASK_BYTE);\r\nif (evtlog[index].telem_evtid == debugfs_conf->pstates_id)\r\npstates = evtlog[index].telem_evtlog;\r\n}\r\nseq_puts(s, "\n--------------------------------------\n");\r\nseq_puts(s, "PStates\n");\r\nseq_puts(s, "--------------------------------------\n");\r\nseq_puts(s, "Domain\t\t\t\tFreq(Mhz)\n");\r\nseq_printf(s, " IA\t\t\t\t %llu\n GT\t\t\t\t %llu\n",\r\n(pstates & TELEM_MASK_BYTE)*100,\r\n((pstates >> 8) & TELEM_MASK_BYTE)*50/3);\r\nseq_printf(s, " IUNIT\t\t\t\t %llu\n SA\t\t\t\t %llu\n",\r\n((pstates >> 16) & TELEM_MASK_BYTE)*25,\r\n((pstates >> 24) & TELEM_MASK_BYTE)*50/3);\r\nseq_puts(s, "\n--------------------------------------\n");\r\nseq_puts(s, "PSS IDLE Status\n");\r\nseq_puts(s, "--------------------------------------\n");\r\nseq_puts(s, "Device\t\t\t\t\tIDLE\n");\r\nfor (index = 0; index < debugfs_conf->pss_idle_evts; index++) {\r\nseq_printf(s, "%-32s\t%u\n",\r\ndebugfs_conf->pss_idle_data[index].name,\r\npss_idle[index]);\r\n}\r\nseq_puts(s, "\n--------------------------------------\n");\r\nseq_puts(s, "PSS Idle blkd Status (~1ms saturating bucket)\n");\r\nseq_puts(s, "--------------------------------------\n");\r\nseq_puts(s, "Blocker\t\t\t\t\tCount\n");\r\nfor (index = 0; index < debugfs_conf->pcs_idle_blkd_evts; index++) {\r\nseq_printf(s, "%-32s\t%u\n",\r\ndebugfs_conf->pcs_idle_blkd_data[index].name,\r\npcs_idle_blkd[index]);\r\n}\r\nseq_puts(s, "\n--------------------------------------\n");\r\nseq_puts(s, "PSS S0ix blkd Status (~1ms saturating bucket)\n");\r\nseq_puts(s, "--------------------------------------\n");\r\nseq_puts(s, "Blocker\t\t\t\t\tCount\n");\r\nfor (index = 0; index < debugfs_conf->pcs_s0ix_blkd_evts; index++) {\r\nseq_printf(s, "%-32s\t%u\n",\r\ndebugfs_conf->pcs_s0ix_blkd_data[index].name,\r\npcs_s0ix_blkd[index]);\r\n}\r\nseq_puts(s, "\n--------------------------------------\n");\r\nseq_puts(s, "LTR Blocking Status (~1ms saturating bucket)\n");\r\nseq_puts(s, "--------------------------------------\n");\r\nseq_puts(s, "Blocker\t\t\t\t\tCount\n");\r\nfor (index = 0; index < debugfs_conf->pss_ltr_evts; index++) {\r\nseq_printf(s, "%-32s\t%u\n",\r\ndebugfs_conf->pss_ltr_data[index].name,\r\npss_s0ix_wakeup[index]);\r\n}\r\nseq_puts(s, "\n--------------------------------------\n");\r\nseq_puts(s, "Wakes Status (~1ms saturating bucket)\n");\r\nseq_puts(s, "--------------------------------------\n");\r\nseq_puts(s, "Wakes\t\t\t\t\tCount\n");\r\nfor (index = 0; index < debugfs_conf->pss_wakeup_evts; index++) {\r\nseq_printf(s, "%-32s\t%u\n",\r\ndebugfs_conf->pss_wakeup[index].name,\r\npss_ltr_blkd[index]);\r\n}\r\nreturn 0;\r\n}\r\nstatic int telem_pss_state_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, telem_pss_states_show, inode->i_private);\r\n}\r\nstatic int telem_ioss_states_show(struct seq_file *s, void *unused)\r\n{\r\nstruct telemetry_evtlog evtlog[TELEM_MAX_OS_ALLOCATED_EVENTS];\r\nconst char *name[TELEM_MAX_OS_ALLOCATED_EVENTS];\r\nint index, ret, err;\r\nret = telemetry_read_eventlog(TELEM_IOSS, evtlog,\r\nTELEM_MAX_OS_ALLOCATED_EVENTS);\r\nif (ret < 0)\r\nreturn ret;\r\nerr = telemetry_get_evtname(TELEM_IOSS, name,\r\nTELEM_MAX_OS_ALLOCATED_EVENTS);\r\nif (err < 0)\r\nreturn err;\r\nseq_puts(s, "--------------------------------------\n");\r\nseq_puts(s, "\tI0SS TELEMETRY EVENTLOG\n");\r\nseq_puts(s, "--------------------------------------\n");\r\nfor (index = 0; index < ret; index++) {\r\nseq_printf(s, "%-32s 0x%llx\n",\r\nname[index], evtlog[index].telem_evtlog);\r\n}\r\nreturn 0;\r\n}\r\nstatic int telem_ioss_state_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, telem_ioss_states_show, inode->i_private);\r\n}\r\nstatic int telem_soc_states_show(struct seq_file *s, void *unused)\r\n{\r\nu32 d3_sts[TELEM_IOSS_DX_D0IX_EVTS], d0ix_sts[TELEM_IOSS_DX_D0IX_EVTS];\r\nu32 pg_sts[TELEM_IOSS_PG_EVTS], pss_idle[TELEM_PSS_IDLE_EVTS];\r\nstruct telemetry_evtlog evtlog[TELEM_MAX_OS_ALLOCATED_EVENTS];\r\nu32 s0ix_total_ctr = 0, s0ix_shlw_ctr = 0, s0ix_deep_ctr = 0;\r\nu64 s0ix_total_res = 0, s0ix_shlw_res = 0, s0ix_deep_res = 0;\r\nstruct telemetry_debugfs_conf *conf = debugfs_conf;\r\nstruct pci_dev *dev = NULL;\r\nint index, idx, ret;\r\nu32 d3_state;\r\nu16 pmcsr;\r\nret = telemetry_read_eventlog(TELEM_IOSS, evtlog,\r\nTELEM_MAX_OS_ALLOCATED_EVENTS);\r\nif (ret < 0)\r\nreturn ret;\r\nfor (index = 0; index < ret; index++) {\r\nTELEM_CHECK_AND_PARSE_EVTS(conf->ioss_d3_id,\r\nconf->ioss_d0ix_evts,\r\nd3_sts, evtlog[index].telem_evtlog,\r\nconf->ioss_d0ix_data,\r\nTELEM_MASK_BIT);\r\nTELEM_CHECK_AND_PARSE_EVTS(conf->ioss_pg_id, conf->ioss_pg_evts,\r\npg_sts, evtlog[index].telem_evtlog,\r\nconf->ioss_pg_data, TELEM_MASK_BIT);\r\nTELEM_CHECK_AND_PARSE_EVTS(conf->ioss_d0ix_id,\r\nconf->ioss_d0ix_evts,\r\nd0ix_sts, evtlog[index].telem_evtlog,\r\nconf->ioss_d0ix_data,\r\nTELEM_MASK_BIT);\r\nTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_total_occ_id,\r\ns0ix_total_ctr);\r\nTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_shlw_occ_id,\r\ns0ix_shlw_ctr);\r\nTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_deep_occ_id,\r\ns0ix_deep_ctr);\r\nTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_total_res_id,\r\ns0ix_total_res);\r\nTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_shlw_res_id,\r\ns0ix_shlw_res);\r\nTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_deep_res_id,\r\ns0ix_deep_res);\r\n}\r\nseq_puts(s, "\n---------------------------------------------------\n");\r\nseq_puts(s, "S0IX Type\t\t\t Occurrence\t\t Residency(us)\n");\r\nseq_puts(s, "---------------------------------------------------\n");\r\nseq_printf(s, "S0IX Shallow\t\t\t %10u\t %10llu\n",\r\ns0ix_shlw_ctr -\r\nconf->suspend_stats.shlw_ctr -\r\nconf->suspend_stats.shlw_swake_ctr,\r\n(u64)((s0ix_shlw_res -\r\nconf->suspend_stats.shlw_res -\r\nconf->suspend_stats.shlw_swake_res)*10/192));\r\nseq_printf(s, "S0IX Deep\t\t\t %10u\t %10llu\n",\r\ns0ix_deep_ctr -\r\nconf->suspend_stats.deep_ctr -\r\nconf->suspend_stats.deep_swake_ctr,\r\n(u64)((s0ix_deep_res -\r\nconf->suspend_stats.deep_res -\r\nconf->suspend_stats.deep_swake_res)*10/192));\r\nseq_printf(s, "Suspend(With S0ixShallow)\t %10u\t %10llu\n",\r\nconf->suspend_stats.shlw_ctr,\r\n(u64)(conf->suspend_stats.shlw_res*10)/192);\r\nseq_printf(s, "Suspend(With S0ixDeep)\t\t %10u\t %10llu\n",\r\nconf->suspend_stats.deep_ctr,\r\n(u64)(conf->suspend_stats.deep_res*10)/192);\r\nseq_printf(s, "Suspend(With Shallow-Wakes)\t %10u\t %10llu\n",\r\nconf->suspend_stats.shlw_swake_ctr +\r\nconf->suspend_stats.deep_swake_ctr,\r\n(u64)((conf->suspend_stats.shlw_swake_res +\r\nconf->suspend_stats.deep_swake_res)*10/192));\r\nseq_printf(s, "S0IX+Suspend Total\t\t %10u\t %10llu\n", s0ix_total_ctr,\r\n(u64)(s0ix_total_res*10/192));\r\nseq_puts(s, "\n-------------------------------------------------\n");\r\nseq_puts(s, "\t\tDEVICE STATES\n");\r\nseq_puts(s, "-------------------------------------------------\n");\r\nfor_each_pci_dev(dev) {\r\npci_read_config_word(dev, dev->pm_cap + PCI_PM_CTRL, &pmcsr);\r\nd3_state = ((pmcsr & PCI_PM_CTRL_STATE_MASK) ==\r\n(__force int)PCI_D3hot) ? 1 : 0;\r\nseq_printf(s, "pci %04x %04X %s %20.20s: ",\r\ndev->vendor, dev->device, dev_name(&dev->dev),\r\ndev_driver_string(&dev->dev));\r\nseq_printf(s, " d3:%x\n", d3_state);\r\n}\r\nseq_puts(s, "\n--------------------------------------\n");\r\nseq_puts(s, "D3/D0i3 Status\n");\r\nseq_puts(s, "--------------------------------------\n");\r\nseq_puts(s, "Block\t\t D3\t D0i3\n");\r\nfor (index = 0; index < conf->ioss_d0ix_evts; index++) {\r\nseq_printf(s, "%-10s\t %u\t %u\n",\r\nconf->ioss_d0ix_data[index].name,\r\nd3_sts[index], d0ix_sts[index]);\r\n}\r\nseq_puts(s, "\n--------------------------------------\n");\r\nseq_puts(s, "South Complex PowerGate Status\n");\r\nseq_puts(s, "--------------------------------------\n");\r\nseq_puts(s, "Device\t\t PG\n");\r\nfor (index = 0; index < conf->ioss_pg_evts; index++) {\r\nseq_printf(s, "%-10s\t %u\n",\r\nconf->ioss_pg_data[index].name,\r\npg_sts[index]);\r\n}\r\nevtlog->telem_evtid = conf->pss_idle_id;\r\nret = telemetry_read_events(TELEM_PSS, evtlog, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nseq_puts(s, "\n-----------------------------------------\n");\r\nseq_puts(s, "North Idle Status\n");\r\nseq_puts(s, "-----------------------------------------\n");\r\nfor (idx = 0; idx < conf->pss_idle_evts - 1; idx++) {\r\npss_idle[idx] = (evtlog->telem_evtlog >>\r\nconf->pss_idle_data[idx].bit_pos) &\r\nTELEM_MASK_BIT;\r\n}\r\npss_idle[idx] = (evtlog->telem_evtlog >>\r\nconf->pss_idle_data[idx].bit_pos) &\r\nTELEM_APL_MASK_PCS_STATE;\r\nfor (index = 0; index < conf->pss_idle_evts; index++) {\r\nseq_printf(s, "%-30s %u\n",\r\nconf->pss_idle_data[index].name,\r\npss_idle[index]);\r\n}\r\nseq_puts(s, "\nPCS_STATUS Code\n");\r\nseq_puts(s, "0:C0 1:C1 2:C1_DN_WT_DEV 3:C2 4:C2_WT_DE_MEM_UP\n");\r\nseq_puts(s, "5:C2_WT_DE_MEM_DOWN 6:C2_UP_WT_DEV 7:C2_DN 8:C2_VOA\n");\r\nseq_puts(s, "9:C2_VOA_UP 10:S0IX_PRE 11:S0IX\n");\r\nreturn 0;\r\n}\r\nstatic int telem_soc_state_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, telem_soc_states_show, inode->i_private);\r\n}\r\nstatic int telem_pss_trc_verb_show(struct seq_file *s, void *unused)\r\n{\r\nu32 verbosity;\r\nint err;\r\nerr = telemetry_get_trace_verbosity(TELEM_PSS, &verbosity);\r\nif (err) {\r\npr_err("Get PSS Trace Verbosity Failed with Error %d\n", err);\r\nreturn -EFAULT;\r\n}\r\nseq_printf(s, "PSS Trace Verbosity %u\n", verbosity);\r\nreturn 0;\r\n}\r\nstatic ssize_t telem_pss_trc_verb_write(struct file *file,\r\nconst char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nu32 verbosity;\r\nint err;\r\nif (kstrtou32_from_user(userbuf, count, 0, &verbosity))\r\nreturn -EFAULT;\r\nerr = telemetry_set_trace_verbosity(TELEM_PSS, verbosity);\r\nif (err) {\r\npr_err("Changing PSS Trace Verbosity Failed. Error %d\n", err);\r\ncount = err;\r\n}\r\nreturn count;\r\n}\r\nstatic int telem_pss_trc_verb_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, telem_pss_trc_verb_show, inode->i_private);\r\n}\r\nstatic int telem_ioss_trc_verb_show(struct seq_file *s, void *unused)\r\n{\r\nu32 verbosity;\r\nint err;\r\nerr = telemetry_get_trace_verbosity(TELEM_IOSS, &verbosity);\r\nif (err) {\r\npr_err("Get IOSS Trace Verbosity Failed with Error %d\n", err);\r\nreturn -EFAULT;\r\n}\r\nseq_printf(s, "IOSS Trace Verbosity %u\n", verbosity);\r\nreturn 0;\r\n}\r\nstatic ssize_t telem_ioss_trc_verb_write(struct file *file,\r\nconst char __user *userbuf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nu32 verbosity;\r\nint err;\r\nif (kstrtou32_from_user(userbuf, count, 0, &verbosity))\r\nreturn -EFAULT;\r\nerr = telemetry_set_trace_verbosity(TELEM_IOSS, verbosity);\r\nif (err) {\r\npr_err("Changing IOSS Trace Verbosity Failed. Error %d\n", err);\r\ncount = err;\r\n}\r\nreturn count;\r\n}\r\nstatic int telem_ioss_trc_verb_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, telem_ioss_trc_verb_show, inode->i_private);\r\n}\r\nstatic int pm_suspend_prep_cb(void)\r\n{\r\nstruct telemetry_evtlog evtlog[TELEM_MAX_OS_ALLOCATED_EVENTS];\r\nstruct telemetry_debugfs_conf *conf = debugfs_conf;\r\nint ret, index;\r\nret = telemetry_raw_read_eventlog(TELEM_IOSS, evtlog,\r\nTELEM_MAX_OS_ALLOCATED_EVENTS);\r\nif (ret < 0) {\r\nsuspend_prep_ok = 0;\r\ngoto out;\r\n}\r\nfor (index = 0; index < ret; index++) {\r\nTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_shlw_occ_id,\r\nsuspend_shlw_ctr_temp);\r\nTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_deep_occ_id,\r\nsuspend_deep_ctr_temp);\r\nTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_shlw_res_id,\r\nsuspend_shlw_res_temp);\r\nTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_deep_res_id,\r\nsuspend_deep_res_temp);\r\n}\r\nsuspend_prep_ok = 1;\r\nout:\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int pm_suspend_exit_cb(void)\r\n{\r\nstruct telemetry_evtlog evtlog[TELEM_MAX_OS_ALLOCATED_EVENTS];\r\nstatic u32 suspend_shlw_ctr_exit, suspend_deep_ctr_exit;\r\nstatic u64 suspend_shlw_res_exit, suspend_deep_res_exit;\r\nstruct telemetry_debugfs_conf *conf = debugfs_conf;\r\nint ret, index;\r\nif (!suspend_prep_ok)\r\ngoto out;\r\nret = telemetry_raw_read_eventlog(TELEM_IOSS, evtlog,\r\nTELEM_MAX_OS_ALLOCATED_EVENTS);\r\nif (ret < 0)\r\ngoto out;\r\nfor (index = 0; index < ret; index++) {\r\nTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_shlw_occ_id,\r\nsuspend_shlw_ctr_exit);\r\nTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_deep_occ_id,\r\nsuspend_deep_ctr_exit);\r\nTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_shlw_res_id,\r\nsuspend_shlw_res_exit);\r\nTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_deep_res_id,\r\nsuspend_deep_res_exit);\r\n}\r\nif ((suspend_shlw_ctr_exit < suspend_shlw_ctr_temp) ||\r\n(suspend_deep_ctr_exit < suspend_deep_ctr_temp) ||\r\n(suspend_shlw_res_exit < suspend_shlw_res_temp) ||\r\n(suspend_deep_res_exit < suspend_deep_res_temp)) {\r\npr_err("Wrong s0ix counters detected\n");\r\ngoto out;\r\n}\r\nsuspend_shlw_ctr_exit -= suspend_shlw_ctr_temp;\r\nsuspend_deep_ctr_exit -= suspend_deep_ctr_temp;\r\nsuspend_shlw_res_exit -= suspend_shlw_res_temp;\r\nsuspend_deep_res_exit -= suspend_deep_res_temp;\r\nif (suspend_shlw_ctr_exit == 1) {\r\nconf->suspend_stats.shlw_ctr +=\r\nsuspend_shlw_ctr_exit;\r\nconf->suspend_stats.shlw_res +=\r\nsuspend_shlw_res_exit;\r\n}\r\nelse if (suspend_shlw_ctr_exit > 1) {\r\nconf->suspend_stats.shlw_swake_ctr +=\r\nsuspend_shlw_ctr_exit;\r\nconf->suspend_stats.shlw_swake_res +=\r\nsuspend_shlw_res_exit;\r\n}\r\nif (suspend_deep_ctr_exit == 1) {\r\nconf->suspend_stats.deep_ctr +=\r\nsuspend_deep_ctr_exit;\r\nconf->suspend_stats.deep_res +=\r\nsuspend_deep_res_exit;\r\n}\r\nelse if (suspend_deep_ctr_exit > 1) {\r\nconf->suspend_stats.deep_swake_ctr +=\r\nsuspend_deep_ctr_exit;\r\nconf->suspend_stats.deep_swake_res +=\r\nsuspend_deep_res_exit;\r\n}\r\nout:\r\nsuspend_prep_ok = 0;\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int pm_notification(struct notifier_block *this,\r\nunsigned long event, void *ptr)\r\n{\r\nswitch (event) {\r\ncase PM_SUSPEND_PREPARE:\r\nreturn pm_suspend_prep_cb();\r\ncase PM_POST_SUSPEND:\r\nreturn pm_suspend_exit_cb();\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init telemetry_debugfs_init(void)\r\n{\r\nconst struct x86_cpu_id *id;\r\nint err = -ENOMEM;\r\nstruct dentry *f;\r\nid = x86_match_cpu(telemetry_debugfs_cpu_ids);\r\nif (!id)\r\nreturn -ENODEV;\r\ndebugfs_conf = (struct telemetry_debugfs_conf *)id->driver_data;\r\nerr = telemetry_pltconfig_valid();\r\nif (err < 0)\r\nreturn -ENODEV;\r\nerr = telemetry_debugfs_check_evts();\r\nif (err < 0)\r\nreturn -EINVAL;\r\n#ifdef CONFIG_PM_SLEEP\r\nregister_pm_notifier(&pm_notifier);\r\n#endif\r\ndebugfs_conf->telemetry_dbg_dir = debugfs_create_dir("telemetry", NULL);\r\nif (!debugfs_conf->telemetry_dbg_dir)\r\nreturn -ENOMEM;\r\nf = debugfs_create_file("pss_info", S_IFREG | S_IRUGO,\r\ndebugfs_conf->telemetry_dbg_dir, NULL,\r\n&telem_pss_ops);\r\nif (!f) {\r\npr_err("pss_sample_info debugfs register failed\n");\r\ngoto out;\r\n}\r\nf = debugfs_create_file("ioss_info", S_IFREG | S_IRUGO,\r\ndebugfs_conf->telemetry_dbg_dir, NULL,\r\n&telem_ioss_ops);\r\nif (!f) {\r\npr_err("ioss_sample_info debugfs register failed\n");\r\ngoto out;\r\n}\r\nf = debugfs_create_file("soc_states", S_IFREG | S_IRUGO,\r\ndebugfs_conf->telemetry_dbg_dir,\r\nNULL, &telem_socstate_ops);\r\nif (!f) {\r\npr_err("ioss_sample_info debugfs register failed\n");\r\ngoto out;\r\n}\r\nf = debugfs_create_file("pss_trace_verbosity", S_IFREG | S_IRUGO,\r\ndebugfs_conf->telemetry_dbg_dir, NULL,\r\n&telem_pss_trc_verb_ops);\r\nif (!f) {\r\npr_err("pss_trace_verbosity debugfs register failed\n");\r\ngoto out;\r\n}\r\nf = debugfs_create_file("ioss_trace_verbosity", S_IFREG | S_IRUGO,\r\ndebugfs_conf->telemetry_dbg_dir, NULL,\r\n&telem_ioss_trc_verb_ops);\r\nif (!f) {\r\npr_err("ioss_trace_verbosity debugfs register failed\n");\r\ngoto out;\r\n}\r\nreturn 0;\r\nout:\r\ndebugfs_remove_recursive(debugfs_conf->telemetry_dbg_dir);\r\ndebugfs_conf->telemetry_dbg_dir = NULL;\r\nreturn err;\r\n}\r\nstatic void __exit telemetry_debugfs_exit(void)\r\n{\r\ndebugfs_remove_recursive(debugfs_conf->telemetry_dbg_dir);\r\ndebugfs_conf->telemetry_dbg_dir = NULL;\r\n}

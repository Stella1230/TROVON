static int saitek_probe(struct hid_device *hdev,\r\nconst struct hid_device_id *id)\r\n{\r\nunsigned long quirks = id->driver_data;\r\nstruct saitek_sc *ssc;\r\nint ret;\r\nssc = devm_kzalloc(&hdev->dev, sizeof(*ssc), GFP_KERNEL);\r\nif (ssc == NULL) {\r\nhid_err(hdev, "can't alloc saitek descriptor\n");\r\nreturn -ENOMEM;\r\n}\r\nssc->quirks = quirks;\r\nssc->mode = -1;\r\nhid_set_drvdata(hdev, ssc);\r\nret = hid_parse(hdev);\r\nif (ret) {\r\nhid_err(hdev, "parse failed\n");\r\nreturn ret;\r\n}\r\nret = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\r\nif (ret) {\r\nhid_err(hdev, "hw start failed\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic __u8 *saitek_report_fixup(struct hid_device *hdev, __u8 *rdesc,\r\nunsigned int *rsize)\r\n{\r\nstruct saitek_sc *ssc = hid_get_drvdata(hdev);\r\nif ((ssc->quirks & SAITEK_FIX_PS1000) && *rsize == 137 &&\r\nrdesc[20] == 0x09 && rdesc[21] == 0x33 &&\r\nrdesc[94] == 0x81 && rdesc[95] == 0x03 &&\r\nrdesc[110] == 0x81 && rdesc[111] == 0x03) {\r\nhid_info(hdev, "Fixing up Saitek PS1000 report descriptor\n");\r\nrdesc[20] = 0x15;\r\nrdesc[21] = 0x00;\r\nrdesc[95] = 0x02;\r\nrdesc[111] = 0x02;\r\n}\r\nreturn rdesc;\r\n}\r\nstatic int saitek_raw_event(struct hid_device *hdev,\r\nstruct hid_report *report, u8 *raw_data, int size)\r\n{\r\nstruct saitek_sc *ssc = hid_get_drvdata(hdev);\r\nif (ssc->quirks & SAITEK_RELEASE_MODE_RAT7 && size == 7) {\r\nint mode = -1;\r\nif (raw_data[1] & 0x01)\r\nmode = 0;\r\nelse if (raw_data[1] & 0x02)\r\nmode = 1;\r\nelse if (raw_data[1] & 0x04)\r\nmode = 2;\r\nraw_data[1] &= ~0x07;\r\nif (mode != ssc->mode) {\r\nhid_dbg(hdev, "entered mode %d\n", mode);\r\nif (ssc->mode != -1) {\r\nraw_data[1] |= 0x04;\r\n}\r\nssc->mode = mode;\r\n}\r\n} else if (ssc->quirks & SAITEK_RELEASE_MODE_MMO7 && size == 8) {\r\nint mode = -1;\r\nif (raw_data[1] & 0x80)\r\nmode = 0;\r\nelse if (raw_data[2] & 0x01)\r\nmode = 1;\r\nelse if (raw_data[2] & 0x02)\r\nmode = 2;\r\nraw_data[1] &= ~0x80;\r\nraw_data[2] &= ~0x03;\r\nif (mode != ssc->mode) {\r\nhid_dbg(hdev, "entered mode %d\n", mode);\r\nif (ssc->mode != -1) {\r\nraw_data[1] |= 0x80;\r\n}\r\nssc->mode = mode;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int saitek_event(struct hid_device *hdev, struct hid_field *field,\r\nstruct hid_usage *usage, __s32 value)\r\n{\r\nstruct saitek_sc *ssc = hid_get_drvdata(hdev);\r\nstruct input_dev *input = field->hidinput->input;\r\nif (usage->type == EV_KEY && value &&\r\n(((ssc->quirks & SAITEK_RELEASE_MODE_RAT7) &&\r\nusage->code - BTN_MOUSE == 10) ||\r\n((ssc->quirks & SAITEK_RELEASE_MODE_MMO7) &&\r\nusage->code - BTN_MOUSE == 15))) {\r\ninput_report_key(input, usage->code, 1);\r\ninput_report_key(input, usage->code, 0);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}

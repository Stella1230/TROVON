static void fsl_dcu_drm_crtc_atomic_flush(struct drm_crtc *crtc,\r\nstruct drm_crtc_state *old_crtc_state)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct fsl_dcu_drm_device *fsl_dev = dev->dev_private;\r\nstruct drm_pending_vblank_event *event = crtc->state->event;\r\nregmap_write(fsl_dev->regmap,\r\nDCU_UPDATE_MODE, DCU_UPDATE_MODE_READREG);\r\nif (event) {\r\ncrtc->state->event = NULL;\r\nspin_lock_irq(&crtc->dev->event_lock);\r\nif (drm_crtc_vblank_get(crtc) == 0)\r\ndrm_crtc_arm_vblank_event(crtc, event);\r\nelse\r\ndrm_crtc_send_vblank_event(crtc, event);\r\nspin_unlock_irq(&crtc->dev->event_lock);\r\n}\r\n}\r\nstatic void fsl_dcu_drm_crtc_atomic_disable(struct drm_crtc *crtc,\r\nstruct drm_crtc_state *old_crtc_state)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct fsl_dcu_drm_device *fsl_dev = dev->dev_private;\r\ndrm_atomic_helper_disable_planes_on_crtc(old_crtc_state, true);\r\ndrm_crtc_vblank_off(crtc);\r\nregmap_update_bits(fsl_dev->regmap, DCU_DCU_MODE,\r\nDCU_MODE_DCU_MODE_MASK,\r\nDCU_MODE_DCU_MODE(DCU_MODE_OFF));\r\nregmap_write(fsl_dev->regmap, DCU_UPDATE_MODE,\r\nDCU_UPDATE_MODE_READREG);\r\nclk_disable_unprepare(fsl_dev->pix_clk);\r\n}\r\nstatic void fsl_dcu_drm_crtc_enable(struct drm_crtc *crtc)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct fsl_dcu_drm_device *fsl_dev = dev->dev_private;\r\nclk_prepare_enable(fsl_dev->pix_clk);\r\nregmap_update_bits(fsl_dev->regmap, DCU_DCU_MODE,\r\nDCU_MODE_DCU_MODE_MASK,\r\nDCU_MODE_DCU_MODE(DCU_MODE_NORMAL));\r\nregmap_write(fsl_dev->regmap, DCU_UPDATE_MODE,\r\nDCU_UPDATE_MODE_READREG);\r\ndrm_crtc_vblank_on(crtc);\r\n}\r\nstatic void fsl_dcu_drm_crtc_mode_set_nofb(struct drm_crtc *crtc)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct fsl_dcu_drm_device *fsl_dev = dev->dev_private;\r\nstruct drm_connector *con = &fsl_dev->connector.base;\r\nstruct drm_display_mode *mode = &crtc->state->mode;\r\nunsigned int hbp, hfp, hsw, vbp, vfp, vsw, index, pol = 0;\r\nindex = drm_crtc_index(crtc);\r\nclk_set_rate(fsl_dev->pix_clk, mode->clock * 1000);\r\nhbp = mode->htotal - mode->hsync_end;\r\nhfp = mode->hsync_start - mode->hdisplay;\r\nhsw = mode->hsync_end - mode->hsync_start;\r\nvbp = mode->vtotal - mode->vsync_end;\r\nvfp = mode->vsync_start - mode->vdisplay;\r\nvsw = mode->vsync_end - mode->vsync_start;\r\nif (!(con->display_info.bus_flags & DRM_BUS_FLAG_PIXDATA_POSEDGE))\r\npol |= DCU_SYN_POL_INV_PXCK;\r\nif (mode->flags & DRM_MODE_FLAG_NHSYNC)\r\npol |= DCU_SYN_POL_INV_HS_LOW;\r\nif (mode->flags & DRM_MODE_FLAG_NVSYNC)\r\npol |= DCU_SYN_POL_INV_VS_LOW;\r\nregmap_write(fsl_dev->regmap, DCU_HSYN_PARA,\r\nDCU_HSYN_PARA_BP(hbp) |\r\nDCU_HSYN_PARA_PW(hsw) |\r\nDCU_HSYN_PARA_FP(hfp));\r\nregmap_write(fsl_dev->regmap, DCU_VSYN_PARA,\r\nDCU_VSYN_PARA_BP(vbp) |\r\nDCU_VSYN_PARA_PW(vsw) |\r\nDCU_VSYN_PARA_FP(vfp));\r\nregmap_write(fsl_dev->regmap, DCU_DISP_SIZE,\r\nDCU_DISP_SIZE_DELTA_Y(mode->vdisplay) |\r\nDCU_DISP_SIZE_DELTA_X(mode->hdisplay));\r\nregmap_write(fsl_dev->regmap, DCU_SYN_POL, pol);\r\nregmap_write(fsl_dev->regmap, DCU_BGND, DCU_BGND_R(0) |\r\nDCU_BGND_G(0) | DCU_BGND_B(0));\r\nregmap_write(fsl_dev->regmap, DCU_DCU_MODE,\r\nDCU_MODE_BLEND_ITER(1) | DCU_MODE_RASTER_EN);\r\nregmap_write(fsl_dev->regmap, DCU_THRESHOLD,\r\nDCU_THRESHOLD_LS_BF_VS(BF_VS_VAL) |\r\nDCU_THRESHOLD_OUT_BUF_HIGH(BUF_MAX_VAL) |\r\nDCU_THRESHOLD_OUT_BUF_LOW(BUF_MIN_VAL));\r\nreturn;\r\n}\r\nint fsl_dcu_drm_crtc_create(struct fsl_dcu_drm_device *fsl_dev)\r\n{\r\nstruct drm_plane *primary;\r\nstruct drm_crtc *crtc = &fsl_dev->crtc;\r\nint ret;\r\nfsl_dcu_drm_init_planes(fsl_dev->drm);\r\nprimary = fsl_dcu_drm_primary_create_plane(fsl_dev->drm);\r\nif (!primary)\r\nreturn -ENOMEM;\r\nret = drm_crtc_init_with_planes(fsl_dev->drm, crtc, primary, NULL,\r\n&fsl_dcu_drm_crtc_funcs, NULL);\r\nif (ret) {\r\nprimary->funcs->destroy(primary);\r\nreturn ret;\r\n}\r\ndrm_crtc_helper_add(crtc, &fsl_dcu_drm_crtc_helper_funcs);\r\nreturn 0;\r\n}

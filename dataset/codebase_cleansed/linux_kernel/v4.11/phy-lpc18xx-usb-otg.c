static int lpc18xx_usb_otg_phy_init(struct phy *phy)\r\n{\r\nstruct lpc18xx_usb_otg_phy *lpc = phy_get_drvdata(phy);\r\nint ret;\r\nret = clk_set_rate(lpc->clk, 480000000);\r\nif (ret)\r\nreturn ret;\r\nreturn clk_prepare(lpc->clk);\r\n}\r\nstatic int lpc18xx_usb_otg_phy_exit(struct phy *phy)\r\n{\r\nstruct lpc18xx_usb_otg_phy *lpc = phy_get_drvdata(phy);\r\nclk_unprepare(lpc->clk);\r\nreturn 0;\r\n}\r\nstatic int lpc18xx_usb_otg_phy_power_on(struct phy *phy)\r\n{\r\nstruct lpc18xx_usb_otg_phy *lpc = phy_get_drvdata(phy);\r\nint ret;\r\nret = clk_enable(lpc->clk);\r\nif (ret)\r\nreturn ret;\r\nreturn regmap_update_bits(lpc->reg, LPC18XX_CREG_CREG0,\r\nLPC18XX_CREG_CREG0_USB0PHY, 0);\r\n}\r\nstatic int lpc18xx_usb_otg_phy_power_off(struct phy *phy)\r\n{\r\nstruct lpc18xx_usb_otg_phy *lpc = phy_get_drvdata(phy);\r\nint ret;\r\nret = regmap_update_bits(lpc->reg, LPC18XX_CREG_CREG0,\r\nLPC18XX_CREG_CREG0_USB0PHY,\r\nLPC18XX_CREG_CREG0_USB0PHY);\r\nif (ret)\r\nreturn ret;\r\nclk_disable(lpc->clk);\r\nreturn 0;\r\n}\r\nstatic int lpc18xx_usb_otg_phy_probe(struct platform_device *pdev)\r\n{\r\nstruct phy_provider *phy_provider;\r\nstruct lpc18xx_usb_otg_phy *lpc;\r\nlpc = devm_kzalloc(&pdev->dev, sizeof(*lpc), GFP_KERNEL);\r\nif (!lpc)\r\nreturn -ENOMEM;\r\nlpc->reg = syscon_node_to_regmap(pdev->dev.of_node->parent);\r\nif (IS_ERR(lpc->reg)) {\r\ndev_err(&pdev->dev, "failed to get syscon\n");\r\nreturn PTR_ERR(lpc->reg);\r\n}\r\nlpc->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(lpc->clk)) {\r\ndev_err(&pdev->dev, "failed to get clock\n");\r\nreturn PTR_ERR(lpc->clk);\r\n}\r\nlpc->phy = devm_phy_create(&pdev->dev, NULL, &lpc18xx_usb_otg_phy_ops);\r\nif (IS_ERR(lpc->phy)) {\r\ndev_err(&pdev->dev, "failed to create PHY\n");\r\nreturn PTR_ERR(lpc->phy);\r\n}\r\nphy_set_drvdata(lpc->phy, lpc);\r\nphy_provider = devm_of_phy_provider_register(&pdev->dev,\r\nof_phy_simple_xlate);\r\nreturn PTR_ERR_OR_ZERO(phy_provider);\r\n}

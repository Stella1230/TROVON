void sun4i_tcon_disable(struct sun4i_tcon *tcon)\r\n{\r\nDRM_DEBUG_DRIVER("Disabling TCON\n");\r\nregmap_update_bits(tcon->regs, SUN4I_TCON_GCTL_REG,\r\nSUN4I_TCON_GCTL_TCON_ENABLE, 0);\r\n}\r\nvoid sun4i_tcon_enable(struct sun4i_tcon *tcon)\r\n{\r\nDRM_DEBUG_DRIVER("Enabling TCON\n");\r\nregmap_update_bits(tcon->regs, SUN4I_TCON_GCTL_REG,\r\nSUN4I_TCON_GCTL_TCON_ENABLE,\r\nSUN4I_TCON_GCTL_TCON_ENABLE);\r\n}\r\nvoid sun4i_tcon_channel_disable(struct sun4i_tcon *tcon, int channel)\r\n{\r\nif (channel == 0) {\r\nregmap_update_bits(tcon->regs, SUN4I_TCON0_CTL_REG,\r\nSUN4I_TCON0_CTL_TCON_ENABLE, 0);\r\nclk_disable_unprepare(tcon->dclk);\r\nreturn;\r\n}\r\nWARN_ON(!tcon->quirks->has_channel_1);\r\nregmap_update_bits(tcon->regs, SUN4I_TCON1_CTL_REG,\r\nSUN4I_TCON1_CTL_TCON_ENABLE, 0);\r\nclk_disable_unprepare(tcon->sclk1);\r\n}\r\nvoid sun4i_tcon_channel_enable(struct sun4i_tcon *tcon, int channel)\r\n{\r\nif (channel == 0) {\r\nregmap_update_bits(tcon->regs, SUN4I_TCON0_CTL_REG,\r\nSUN4I_TCON0_CTL_TCON_ENABLE,\r\nSUN4I_TCON0_CTL_TCON_ENABLE);\r\nclk_prepare_enable(tcon->dclk);\r\nreturn;\r\n}\r\nWARN_ON(!tcon->quirks->has_channel_1);\r\nregmap_update_bits(tcon->regs, SUN4I_TCON1_CTL_REG,\r\nSUN4I_TCON1_CTL_TCON_ENABLE,\r\nSUN4I_TCON1_CTL_TCON_ENABLE);\r\nclk_prepare_enable(tcon->sclk1);\r\n}\r\nvoid sun4i_tcon_enable_vblank(struct sun4i_tcon *tcon, bool enable)\r\n{\r\nu32 mask, val = 0;\r\nDRM_DEBUG_DRIVER("%sabling VBLANK interrupt\n", enable ? "En" : "Dis");\r\nmask = SUN4I_TCON_GINT0_VBLANK_ENABLE(0) |\r\nSUN4I_TCON_GINT0_VBLANK_ENABLE(1);\r\nif (enable)\r\nval = mask;\r\nregmap_update_bits(tcon->regs, SUN4I_TCON_GINT0_REG, mask, val);\r\n}\r\nstatic int sun4i_tcon_get_clk_delay(struct drm_display_mode *mode,\r\nint channel)\r\n{\r\nint delay = mode->vtotal - mode->vdisplay;\r\nif (mode->flags & DRM_MODE_FLAG_INTERLACE)\r\ndelay /= 2;\r\nif (channel == 1)\r\ndelay -= 2;\r\ndelay = min(delay, 30);\r\nDRM_DEBUG_DRIVER("TCON %d clock delay %u\n", channel, delay);\r\nreturn delay;\r\n}\r\nvoid sun4i_tcon0_mode_set(struct sun4i_tcon *tcon,\r\nstruct drm_display_mode *mode)\r\n{\r\nunsigned int bp, hsync, vsync;\r\nu8 clk_delay;\r\nu32 val = 0;\r\nclk_delay = sun4i_tcon_get_clk_delay(mode, 0);\r\nregmap_update_bits(tcon->regs, SUN4I_TCON0_CTL_REG,\r\nSUN4I_TCON0_CTL_CLK_DELAY_MASK,\r\nSUN4I_TCON0_CTL_CLK_DELAY(clk_delay));\r\nregmap_write(tcon->regs, SUN4I_TCON0_BASIC0_REG,\r\nSUN4I_TCON0_BASIC0_X(mode->crtc_hdisplay) |\r\nSUN4I_TCON0_BASIC0_Y(mode->crtc_vdisplay));\r\nbp = mode->crtc_htotal - mode->crtc_hsync_start;\r\nDRM_DEBUG_DRIVER("Setting horizontal total %d, backporch %d\n",\r\nmode->crtc_htotal, bp);\r\nregmap_write(tcon->regs, SUN4I_TCON0_BASIC1_REG,\r\nSUN4I_TCON0_BASIC1_H_TOTAL(mode->crtc_htotal) |\r\nSUN4I_TCON0_BASIC1_H_BACKPORCH(bp));\r\nbp = mode->crtc_vtotal - mode->crtc_vsync_start;\r\nDRM_DEBUG_DRIVER("Setting vertical total %d, backporch %d\n",\r\nmode->crtc_vtotal, bp);\r\nregmap_write(tcon->regs, SUN4I_TCON0_BASIC2_REG,\r\nSUN4I_TCON0_BASIC2_V_TOTAL(mode->crtc_vtotal) |\r\nSUN4I_TCON0_BASIC2_V_BACKPORCH(bp));\r\nhsync = mode->crtc_hsync_end - mode->crtc_hsync_start;\r\nvsync = mode->crtc_vsync_end - mode->crtc_vsync_start;\r\nDRM_DEBUG_DRIVER("Setting HSYNC %d, VSYNC %d\n", hsync, vsync);\r\nregmap_write(tcon->regs, SUN4I_TCON0_BASIC3_REG,\r\nSUN4I_TCON0_BASIC3_V_SYNC(vsync) |\r\nSUN4I_TCON0_BASIC3_H_SYNC(hsync));\r\nif (!(mode->flags & DRM_MODE_FLAG_PHSYNC))\r\nval |= SUN4I_TCON0_IO_POL_HSYNC_POSITIVE;\r\nif (!(mode->flags & DRM_MODE_FLAG_PVSYNC))\r\nval |= SUN4I_TCON0_IO_POL_VSYNC_POSITIVE;\r\nregmap_update_bits(tcon->regs, SUN4I_TCON0_IO_POL_REG,\r\nSUN4I_TCON0_IO_POL_HSYNC_POSITIVE | SUN4I_TCON0_IO_POL_VSYNC_POSITIVE,\r\nval);\r\nregmap_update_bits(tcon->regs, SUN4I_TCON_GCTL_REG,\r\nSUN4I_TCON_GCTL_IOMAP_MASK,\r\nSUN4I_TCON_GCTL_IOMAP_TCON0);\r\nregmap_write(tcon->regs, SUN4I_TCON0_IO_TRI_REG, 0);\r\n}\r\nvoid sun4i_tcon1_mode_set(struct sun4i_tcon *tcon,\r\nstruct drm_display_mode *mode)\r\n{\r\nunsigned int bp, hsync, vsync;\r\nu8 clk_delay;\r\nu32 val;\r\nWARN_ON(!tcon->quirks->has_channel_1);\r\nclk_delay = sun4i_tcon_get_clk_delay(mode, 1);\r\nregmap_update_bits(tcon->regs, SUN4I_TCON1_CTL_REG,\r\nSUN4I_TCON1_CTL_CLK_DELAY_MASK,\r\nSUN4I_TCON1_CTL_CLK_DELAY(clk_delay));\r\nif (mode->flags & DRM_MODE_FLAG_INTERLACE)\r\nval = SUN4I_TCON1_CTL_INTERLACE_ENABLE;\r\nelse\r\nval = 0;\r\nregmap_update_bits(tcon->regs, SUN4I_TCON1_CTL_REG,\r\nSUN4I_TCON1_CTL_INTERLACE_ENABLE,\r\nval);\r\nregmap_write(tcon->regs, SUN4I_TCON1_BASIC0_REG,\r\nSUN4I_TCON1_BASIC0_X(mode->crtc_hdisplay) |\r\nSUN4I_TCON1_BASIC0_Y(mode->crtc_vdisplay));\r\nregmap_write(tcon->regs, SUN4I_TCON1_BASIC1_REG,\r\nSUN4I_TCON1_BASIC1_X(mode->crtc_hdisplay) |\r\nSUN4I_TCON1_BASIC1_Y(mode->crtc_vdisplay));\r\nregmap_write(tcon->regs, SUN4I_TCON1_BASIC2_REG,\r\nSUN4I_TCON1_BASIC2_X(mode->crtc_hdisplay) |\r\nSUN4I_TCON1_BASIC2_Y(mode->crtc_vdisplay));\r\nbp = mode->crtc_htotal - mode->crtc_hsync_end;\r\nDRM_DEBUG_DRIVER("Setting horizontal total %d, backporch %d\n",\r\nmode->htotal, bp);\r\nregmap_write(tcon->regs, SUN4I_TCON1_BASIC3_REG,\r\nSUN4I_TCON1_BASIC3_H_TOTAL(mode->crtc_htotal) |\r\nSUN4I_TCON1_BASIC3_H_BACKPORCH(bp));\r\nbp = mode->crtc_vtotal - mode->crtc_vsync_end;\r\nDRM_DEBUG_DRIVER("Setting vertical total %d, backporch %d\n",\r\nmode->vtotal, bp);\r\nregmap_write(tcon->regs, SUN4I_TCON1_BASIC4_REG,\r\nSUN4I_TCON1_BASIC4_V_TOTAL(mode->vtotal) |\r\nSUN4I_TCON1_BASIC4_V_BACKPORCH(bp));\r\nhsync = mode->crtc_hsync_end - mode->crtc_hsync_start;\r\nvsync = mode->crtc_vsync_end - mode->crtc_vsync_start;\r\nDRM_DEBUG_DRIVER("Setting HSYNC %d, VSYNC %d\n", hsync, vsync);\r\nregmap_write(tcon->regs, SUN4I_TCON1_BASIC5_REG,\r\nSUN4I_TCON1_BASIC5_V_SYNC(vsync) |\r\nSUN4I_TCON1_BASIC5_H_SYNC(hsync));\r\nregmap_update_bits(tcon->regs, SUN4I_TCON_GCTL_REG,\r\nSUN4I_TCON_GCTL_IOMAP_MASK,\r\nSUN4I_TCON_GCTL_IOMAP_TCON1);\r\nif (tcon->quirks->has_unknown_mux)\r\nregmap_write(tcon->regs, SUN4I_TCON_MUX_CTRL_REG, 1);\r\n}\r\nstatic void sun4i_tcon_finish_page_flip(struct drm_device *dev,\r\nstruct sun4i_crtc *scrtc)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->event_lock, flags);\r\nif (scrtc->event) {\r\ndrm_crtc_send_vblank_event(&scrtc->crtc, scrtc->event);\r\ndrm_crtc_vblank_put(&scrtc->crtc);\r\nscrtc->event = NULL;\r\n}\r\nspin_unlock_irqrestore(&dev->event_lock, flags);\r\n}\r\nstatic irqreturn_t sun4i_tcon_handler(int irq, void *private)\r\n{\r\nstruct sun4i_tcon *tcon = private;\r\nstruct drm_device *drm = tcon->drm;\r\nstruct sun4i_drv *drv = drm->dev_private;\r\nstruct sun4i_crtc *scrtc = drv->crtc;\r\nunsigned int status;\r\nregmap_read(tcon->regs, SUN4I_TCON_GINT0_REG, &status);\r\nif (!(status & (SUN4I_TCON_GINT0_VBLANK_INT(0) |\r\nSUN4I_TCON_GINT0_VBLANK_INT(1))))\r\nreturn IRQ_NONE;\r\ndrm_crtc_handle_vblank(&scrtc->crtc);\r\nsun4i_tcon_finish_page_flip(drm, scrtc);\r\nregmap_update_bits(tcon->regs, SUN4I_TCON_GINT0_REG,\r\nSUN4I_TCON_GINT0_VBLANK_INT(0) |\r\nSUN4I_TCON_GINT0_VBLANK_INT(1),\r\n0);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int sun4i_tcon_init_clocks(struct device *dev,\r\nstruct sun4i_tcon *tcon)\r\n{\r\ntcon->clk = devm_clk_get(dev, "ahb");\r\nif (IS_ERR(tcon->clk)) {\r\ndev_err(dev, "Couldn't get the TCON bus clock\n");\r\nreturn PTR_ERR(tcon->clk);\r\n}\r\nclk_prepare_enable(tcon->clk);\r\ntcon->sclk0 = devm_clk_get(dev, "tcon-ch0");\r\nif (IS_ERR(tcon->sclk0)) {\r\ndev_err(dev, "Couldn't get the TCON channel 0 clock\n");\r\nreturn PTR_ERR(tcon->sclk0);\r\n}\r\nif (tcon->quirks->has_channel_1) {\r\ntcon->sclk1 = devm_clk_get(dev, "tcon-ch1");\r\nif (IS_ERR(tcon->sclk1)) {\r\ndev_err(dev, "Couldn't get the TCON channel 1 clock\n");\r\nreturn PTR_ERR(tcon->sclk1);\r\n}\r\n}\r\nreturn sun4i_dclk_create(dev, tcon);\r\n}\r\nstatic void sun4i_tcon_free_clocks(struct sun4i_tcon *tcon)\r\n{\r\nsun4i_dclk_free(tcon);\r\nclk_disable_unprepare(tcon->clk);\r\n}\r\nstatic int sun4i_tcon_init_irq(struct device *dev,\r\nstruct sun4i_tcon *tcon)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nint irq, ret;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(dev, "Couldn't retrieve the TCON interrupt\n");\r\nreturn irq;\r\n}\r\nret = devm_request_irq(dev, irq, sun4i_tcon_handler, 0,\r\ndev_name(dev), tcon);\r\nif (ret) {\r\ndev_err(dev, "Couldn't request the IRQ\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sun4i_tcon_init_regmap(struct device *dev,\r\nstruct sun4i_tcon *tcon)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct resource *res;\r\nvoid __iomem *regs;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nregs = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(regs))\r\nreturn PTR_ERR(regs);\r\ntcon->regs = devm_regmap_init_mmio(dev, regs,\r\n&sun4i_tcon_regmap_config);\r\nif (IS_ERR(tcon->regs)) {\r\ndev_err(dev, "Couldn't create the TCON regmap\n");\r\nreturn PTR_ERR(tcon->regs);\r\n}\r\nregmap_write(tcon->regs, SUN4I_TCON_GCTL_REG, 0);\r\nregmap_write(tcon->regs, SUN4I_TCON_GINT0_REG, 0);\r\nregmap_write(tcon->regs, SUN4I_TCON_GINT1_REG, 0);\r\nregmap_write(tcon->regs, SUN4I_TCON0_IO_TRI_REG, ~0);\r\nregmap_write(tcon->regs, SUN4I_TCON1_IO_TRI_REG, ~0);\r\nreturn 0;\r\n}\r\nstruct drm_panel *sun4i_tcon_find_panel(struct device_node *node)\r\n{\r\nstruct device_node *port, *remote, *child;\r\nstruct device_node *end_node = NULL;\r\nport = of_graph_get_port_by_id(node, 1);\r\nfor_each_child_of_node(port, child) {\r\nu32 reg;\r\nof_property_read_u32(child, "reg", &reg);\r\nif (reg == 0)\r\nend_node = child;\r\n}\r\nif (!end_node) {\r\nDRM_DEBUG_DRIVER("Missing panel endpoint\n");\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\nremote = of_graph_get_remote_port_parent(end_node);\r\nif (!remote) {\r\nDRM_DEBUG_DRIVER("Unable to parse remote node\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nreturn of_drm_find_panel(remote) ?: ERR_PTR(-EPROBE_DEFER);\r\n}\r\nstruct drm_bridge *sun4i_tcon_find_bridge(struct device_node *node)\r\n{\r\nstruct device_node *port, *remote, *child;\r\nstruct device_node *end_node = NULL;\r\nport = of_graph_get_port_by_id(node, 1);\r\nfor_each_child_of_node(port, child) {\r\nu32 reg;\r\nof_property_read_u32(child, "reg", &reg);\r\nif (reg == 0)\r\nend_node = child;\r\n}\r\nif (!end_node) {\r\nDRM_DEBUG_DRIVER("Missing bridge endpoint\n");\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\nremote = of_graph_get_remote_port_parent(end_node);\r\nif (!remote) {\r\nDRM_DEBUG_DRIVER("Enable to parse remote node\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nreturn of_drm_find_bridge(remote) ?: ERR_PTR(-EPROBE_DEFER);\r\n}\r\nstatic int sun4i_tcon_bind(struct device *dev, struct device *master,\r\nvoid *data)\r\n{\r\nstruct drm_device *drm = data;\r\nstruct sun4i_drv *drv = drm->dev_private;\r\nstruct sun4i_tcon *tcon;\r\nint ret;\r\ntcon = devm_kzalloc(dev, sizeof(*tcon), GFP_KERNEL);\r\nif (!tcon)\r\nreturn -ENOMEM;\r\ndev_set_drvdata(dev, tcon);\r\ndrv->tcon = tcon;\r\ntcon->drm = drm;\r\ntcon->dev = dev;\r\ntcon->quirks = of_device_get_match_data(dev);\r\ntcon->lcd_rst = devm_reset_control_get(dev, "lcd");\r\nif (IS_ERR(tcon->lcd_rst)) {\r\ndev_err(dev, "Couldn't get our reset line\n");\r\nreturn PTR_ERR(tcon->lcd_rst);\r\n}\r\nif (!reset_control_status(tcon->lcd_rst))\r\nreset_control_assert(tcon->lcd_rst);\r\nret = reset_control_deassert(tcon->lcd_rst);\r\nif (ret) {\r\ndev_err(dev, "Couldn't deassert our reset line\n");\r\nreturn ret;\r\n}\r\nret = sun4i_tcon_init_regmap(dev, tcon);\r\nif (ret) {\r\ndev_err(dev, "Couldn't init our TCON regmap\n");\r\ngoto err_assert_reset;\r\n}\r\nret = sun4i_tcon_init_clocks(dev, tcon);\r\nif (ret) {\r\ndev_err(dev, "Couldn't init our TCON clocks\n");\r\ngoto err_assert_reset;\r\n}\r\nret = sun4i_tcon_init_irq(dev, tcon);\r\nif (ret) {\r\ndev_err(dev, "Couldn't init our TCON interrupts\n");\r\ngoto err_free_clocks;\r\n}\r\nret = sun4i_rgb_init(drm);\r\nif (ret < 0)\r\ngoto err_free_clocks;\r\nreturn 0;\r\nerr_free_clocks:\r\nsun4i_tcon_free_clocks(tcon);\r\nerr_assert_reset:\r\nreset_control_assert(tcon->lcd_rst);\r\nreturn ret;\r\n}\r\nstatic void sun4i_tcon_unbind(struct device *dev, struct device *master,\r\nvoid *data)\r\n{\r\nstruct sun4i_tcon *tcon = dev_get_drvdata(dev);\r\nsun4i_tcon_free_clocks(tcon);\r\n}\r\nstatic int sun4i_tcon_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct drm_bridge *bridge;\r\nstruct drm_panel *panel;\r\npanel = sun4i_tcon_find_panel(node);\r\nbridge = sun4i_tcon_find_bridge(node);\r\nif ((PTR_ERR(panel) == -EPROBE_DEFER) &&\r\n(PTR_ERR(bridge) == -EPROBE_DEFER)) {\r\nDRM_DEBUG_DRIVER("Still waiting for our panel/bridge. Deferring...\n");\r\nreturn -EPROBE_DEFER;\r\n}\r\nreturn component_add(&pdev->dev, &sun4i_tcon_ops);\r\n}\r\nstatic int sun4i_tcon_remove(struct platform_device *pdev)\r\n{\r\ncomponent_del(&pdev->dev, &sun4i_tcon_ops);\r\nreturn 0;\r\n}

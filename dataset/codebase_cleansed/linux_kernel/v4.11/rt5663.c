static bool rt5663_volatile_register(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase RT5663_RESET:\r\ncase RT5663_SIL_DET_CTL:\r\ncase RT5663_HP_IMP_GAIN_2:\r\ncase RT5663_AD_DA_MIXER:\r\ncase RT5663_FRAC_DIV_2:\r\ncase RT5663_MICBIAS_1:\r\ncase RT5663_ASRC_11_2:\r\ncase RT5663_ADC_EQ_1:\r\ncase RT5663_INT_ST_1:\r\ncase RT5663_INT_ST_2:\r\ncase RT5663_GPIO_STA1:\r\ncase RT5663_SIN_GEN_1:\r\ncase RT5663_IL_CMD_1:\r\ncase RT5663_IL_CMD_5:\r\ncase RT5663_IL_CMD_PWRSAV1:\r\ncase RT5663_EM_JACK_TYPE_1:\r\ncase RT5663_EM_JACK_TYPE_2:\r\ncase RT5663_EM_JACK_TYPE_3:\r\ncase RT5663_JD_CTRL2:\r\ncase RT5663_VENDOR_ID:\r\ncase RT5663_VENDOR_ID_1:\r\ncase RT5663_VENDOR_ID_2:\r\ncase RT5663_PLL_INT_REG:\r\ncase RT5663_SOFT_RAMP:\r\ncase RT5663_STO_DRE_1:\r\ncase RT5663_STO_DRE_5:\r\ncase RT5663_STO_DRE_6:\r\ncase RT5663_STO_DRE_7:\r\ncase RT5663_MIC_DECRO_1:\r\ncase RT5663_MIC_DECRO_4:\r\ncase RT5663_HP_IMP_SEN_1:\r\ncase RT5663_HP_IMP_SEN_3:\r\ncase RT5663_HP_IMP_SEN_4:\r\ncase RT5663_HP_IMP_SEN_5:\r\ncase RT5663_HP_CALIB_1_1:\r\ncase RT5663_HP_CALIB_9:\r\ncase RT5663_HP_CALIB_ST1:\r\ncase RT5663_HP_CALIB_ST2:\r\ncase RT5663_HP_CALIB_ST3:\r\ncase RT5663_HP_CALIB_ST4:\r\ncase RT5663_HP_CALIB_ST5:\r\ncase RT5663_HP_CALIB_ST6:\r\ncase RT5663_HP_CALIB_ST7:\r\ncase RT5663_HP_CALIB_ST8:\r\ncase RT5663_HP_CALIB_ST9:\r\ncase RT5663_ANA_JD:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool rt5663_readable_register(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase RT5663_RESET:\r\ncase RT5663_HP_OUT_EN:\r\ncase RT5663_HP_LCH_DRE:\r\ncase RT5663_HP_RCH_DRE:\r\ncase RT5663_CALIB_BST:\r\ncase RT5663_RECMIX:\r\ncase RT5663_SIL_DET_CTL:\r\ncase RT5663_PWR_SAV_SILDET:\r\ncase RT5663_SIDETONE_CTL:\r\ncase RT5663_STO1_DAC_DIG_VOL:\r\ncase RT5663_STO1_ADC_DIG_VOL:\r\ncase RT5663_STO1_BOOST:\r\ncase RT5663_HP_IMP_GAIN_1:\r\ncase RT5663_HP_IMP_GAIN_2:\r\ncase RT5663_STO1_ADC_MIXER:\r\ncase RT5663_AD_DA_MIXER:\r\ncase RT5663_STO_DAC_MIXER:\r\ncase RT5663_DIG_SIDE_MIXER:\r\ncase RT5663_BYPASS_STO_DAC:\r\ncase RT5663_CALIB_REC_MIX:\r\ncase RT5663_PWR_DIG_1:\r\ncase RT5663_PWR_DIG_2:\r\ncase RT5663_PWR_ANLG_1:\r\ncase RT5663_PWR_ANLG_2:\r\ncase RT5663_PWR_ANLG_3:\r\ncase RT5663_PWR_MIXER:\r\ncase RT5663_SIG_CLK_DET:\r\ncase RT5663_PRE_DIV_GATING_1:\r\ncase RT5663_PRE_DIV_GATING_2:\r\ncase RT5663_I2S1_SDP:\r\ncase RT5663_ADDA_CLK_1:\r\ncase RT5663_ADDA_RST:\r\ncase RT5663_FRAC_DIV_1:\r\ncase RT5663_FRAC_DIV_2:\r\ncase RT5663_TDM_1:\r\ncase RT5663_TDM_2:\r\ncase RT5663_TDM_3:\r\ncase RT5663_TDM_4:\r\ncase RT5663_TDM_5:\r\ncase RT5663_GLB_CLK:\r\ncase RT5663_PLL_1:\r\ncase RT5663_PLL_2:\r\ncase RT5663_ASRC_1:\r\ncase RT5663_ASRC_2:\r\ncase RT5663_ASRC_4:\r\ncase RT5663_DUMMY_REG:\r\ncase RT5663_ASRC_8:\r\ncase RT5663_ASRC_9:\r\ncase RT5663_ASRC_11:\r\ncase RT5663_DEPOP_1:\r\ncase RT5663_DEPOP_2:\r\ncase RT5663_DEPOP_3:\r\ncase RT5663_HP_CHARGE_PUMP_1:\r\ncase RT5663_HP_CHARGE_PUMP_2:\r\ncase RT5663_MICBIAS_1:\r\ncase RT5663_RC_CLK:\r\ncase RT5663_ASRC_11_2:\r\ncase RT5663_DUMMY_REG_2:\r\ncase RT5663_REC_PATH_GAIN:\r\ncase RT5663_AUTO_1MRC_CLK:\r\ncase RT5663_ADC_EQ_1:\r\ncase RT5663_ADC_EQ_2:\r\ncase RT5663_IRQ_1:\r\ncase RT5663_IRQ_2:\r\ncase RT5663_IRQ_3:\r\ncase RT5663_IRQ_4:\r\ncase RT5663_IRQ_5:\r\ncase RT5663_INT_ST_1:\r\ncase RT5663_INT_ST_2:\r\ncase RT5663_GPIO_1:\r\ncase RT5663_GPIO_2:\r\ncase RT5663_GPIO_STA1:\r\ncase RT5663_SIN_GEN_1:\r\ncase RT5663_SIN_GEN_2:\r\ncase RT5663_SIN_GEN_3:\r\ncase RT5663_SOF_VOL_ZC1:\r\ncase RT5663_IL_CMD_1:\r\ncase RT5663_IL_CMD_2:\r\ncase RT5663_IL_CMD_3:\r\ncase RT5663_IL_CMD_4:\r\ncase RT5663_IL_CMD_5:\r\ncase RT5663_IL_CMD_6:\r\ncase RT5663_IL_CMD_7:\r\ncase RT5663_IL_CMD_8:\r\ncase RT5663_IL_CMD_PWRSAV1:\r\ncase RT5663_IL_CMD_PWRSAV2:\r\ncase RT5663_EM_JACK_TYPE_1:\r\ncase RT5663_EM_JACK_TYPE_2:\r\ncase RT5663_EM_JACK_TYPE_3:\r\ncase RT5663_EM_JACK_TYPE_4:\r\ncase RT5663_EM_JACK_TYPE_5:\r\ncase RT5663_EM_JACK_TYPE_6:\r\ncase RT5663_STO1_HPF_ADJ1:\r\ncase RT5663_STO1_HPF_ADJ2:\r\ncase RT5663_FAST_OFF_MICBIAS:\r\ncase RT5663_JD_CTRL1:\r\ncase RT5663_JD_CTRL2:\r\ncase RT5663_DIG_MISC:\r\ncase RT5663_VENDOR_ID:\r\ncase RT5663_VENDOR_ID_1:\r\ncase RT5663_VENDOR_ID_2:\r\ncase RT5663_DIG_VOL_ZCD:\r\ncase RT5663_ANA_BIAS_CUR_1:\r\ncase RT5663_ANA_BIAS_CUR_2:\r\ncase RT5663_ANA_BIAS_CUR_3:\r\ncase RT5663_ANA_BIAS_CUR_4:\r\ncase RT5663_ANA_BIAS_CUR_5:\r\ncase RT5663_ANA_BIAS_CUR_6:\r\ncase RT5663_BIAS_CUR_5:\r\ncase RT5663_BIAS_CUR_6:\r\ncase RT5663_BIAS_CUR_7:\r\ncase RT5663_BIAS_CUR_8:\r\ncase RT5663_DACREF_LDO:\r\ncase RT5663_DUMMY_REG_3:\r\ncase RT5663_BIAS_CUR_9:\r\ncase RT5663_DUMMY_REG_4:\r\ncase RT5663_VREFADJ_OP:\r\ncase RT5663_VREF_RECMIX:\r\ncase RT5663_CHARGE_PUMP_1:\r\ncase RT5663_CHARGE_PUMP_1_2:\r\ncase RT5663_CHARGE_PUMP_1_3:\r\ncase RT5663_CHARGE_PUMP_2:\r\ncase RT5663_DIG_IN_PIN1:\r\ncase RT5663_PAD_DRV_CTL:\r\ncase RT5663_PLL_INT_REG:\r\ncase RT5663_CHOP_DAC_L:\r\ncase RT5663_CHOP_ADC:\r\ncase RT5663_CALIB_ADC:\r\ncase RT5663_CHOP_DAC_R:\r\ncase RT5663_DUMMY_CTL_DACLR:\r\ncase RT5663_DUMMY_REG_5:\r\ncase RT5663_SOFT_RAMP:\r\ncase RT5663_TEST_MODE_1:\r\ncase RT5663_TEST_MODE_2:\r\ncase RT5663_TEST_MODE_3:\r\ncase RT5663_STO_DRE_1:\r\ncase RT5663_STO_DRE_2:\r\ncase RT5663_STO_DRE_3:\r\ncase RT5663_STO_DRE_4:\r\ncase RT5663_STO_DRE_5:\r\ncase RT5663_STO_DRE_6:\r\ncase RT5663_STO_DRE_7:\r\ncase RT5663_STO_DRE_8:\r\ncase RT5663_STO_DRE_9:\r\ncase RT5663_STO_DRE_10:\r\ncase RT5663_MIC_DECRO_1:\r\ncase RT5663_MIC_DECRO_2:\r\ncase RT5663_MIC_DECRO_3:\r\ncase RT5663_MIC_DECRO_4:\r\ncase RT5663_MIC_DECRO_5:\r\ncase RT5663_MIC_DECRO_6:\r\ncase RT5663_HP_DECRO_1:\r\ncase RT5663_HP_DECRO_2:\r\ncase RT5663_HP_DECRO_3:\r\ncase RT5663_HP_DECRO_4:\r\ncase RT5663_HP_DECOUP:\r\ncase RT5663_HP_IMP_SEN_MAP8:\r\ncase RT5663_HP_IMP_SEN_MAP9:\r\ncase RT5663_HP_IMP_SEN_MAP10:\r\ncase RT5663_HP_IMP_SEN_MAP11:\r\ncase RT5663_HP_IMP_SEN_1:\r\ncase RT5663_HP_IMP_SEN_2:\r\ncase RT5663_HP_IMP_SEN_3:\r\ncase RT5663_HP_IMP_SEN_4:\r\ncase RT5663_HP_IMP_SEN_5:\r\ncase RT5663_HP_IMP_SEN_6:\r\ncase RT5663_HP_IMP_SEN_7:\r\ncase RT5663_HP_IMP_SEN_8:\r\ncase RT5663_HP_IMP_SEN_9:\r\ncase RT5663_HP_IMP_SEN_10:\r\ncase RT5663_HP_IMP_SEN_11:\r\ncase RT5663_HP_IMP_SEN_12:\r\ncase RT5663_HP_IMP_SEN_13:\r\ncase RT5663_HP_IMP_SEN_14:\r\ncase RT5663_HP_IMP_SEN_15:\r\ncase RT5663_HP_IMP_SEN_16:\r\ncase RT5663_HP_IMP_SEN_17:\r\ncase RT5663_HP_IMP_SEN_18:\r\ncase RT5663_HP_IMP_SEN_19:\r\ncase RT5663_HP_IMPSEN_DIG5:\r\ncase RT5663_HP_IMPSEN_MAP1:\r\ncase RT5663_HP_IMPSEN_MAP2:\r\ncase RT5663_HP_IMPSEN_MAP3:\r\ncase RT5663_HP_IMPSEN_MAP4:\r\ncase RT5663_HP_IMPSEN_MAP5:\r\ncase RT5663_HP_IMPSEN_MAP7:\r\ncase RT5663_HP_LOGIC_1:\r\ncase RT5663_HP_LOGIC_2:\r\ncase RT5663_HP_CALIB_1:\r\ncase RT5663_HP_CALIB_1_1:\r\ncase RT5663_HP_CALIB_2:\r\ncase RT5663_HP_CALIB_3:\r\ncase RT5663_HP_CALIB_4:\r\ncase RT5663_HP_CALIB_5:\r\ncase RT5663_HP_CALIB_5_1:\r\ncase RT5663_HP_CALIB_6:\r\ncase RT5663_HP_CALIB_7:\r\ncase RT5663_HP_CALIB_9:\r\ncase RT5663_HP_CALIB_10:\r\ncase RT5663_HP_CALIB_11:\r\ncase RT5663_HP_CALIB_ST1:\r\ncase RT5663_HP_CALIB_ST2:\r\ncase RT5663_HP_CALIB_ST3:\r\ncase RT5663_HP_CALIB_ST4:\r\ncase RT5663_HP_CALIB_ST5:\r\ncase RT5663_HP_CALIB_ST6:\r\ncase RT5663_HP_CALIB_ST7:\r\ncase RT5663_HP_CALIB_ST8:\r\ncase RT5663_HP_CALIB_ST9:\r\ncase RT5663_HP_AMP_DET:\r\ncase RT5663_DUMMY_REG_6:\r\ncase RT5663_HP_BIAS:\r\ncase RT5663_CBJ_1:\r\ncase RT5663_CBJ_2:\r\ncase RT5663_CBJ_3:\r\ncase RT5663_DUMMY_1:\r\ncase RT5663_DUMMY_2:\r\ncase RT5663_DUMMY_3:\r\ncase RT5663_ANA_JD:\r\ncase RT5663_ADC_LCH_LPF1_A1:\r\ncase RT5663_ADC_RCH_LPF1_A1:\r\ncase RT5663_ADC_LCH_LPF1_H0:\r\ncase RT5663_ADC_RCH_LPF1_H0:\r\ncase RT5663_ADC_LCH_BPF1_A1:\r\ncase RT5663_ADC_RCH_BPF1_A1:\r\ncase RT5663_ADC_LCH_BPF1_A2:\r\ncase RT5663_ADC_RCH_BPF1_A2:\r\ncase RT5663_ADC_LCH_BPF1_H0:\r\ncase RT5663_ADC_RCH_BPF1_H0:\r\ncase RT5663_ADC_LCH_BPF2_A1:\r\ncase RT5663_ADC_RCH_BPF2_A1:\r\ncase RT5663_ADC_LCH_BPF2_A2:\r\ncase RT5663_ADC_RCH_BPF2_A2:\r\ncase RT5663_ADC_LCH_BPF2_H0:\r\ncase RT5663_ADC_RCH_BPF2_H0:\r\ncase RT5663_ADC_LCH_BPF3_A1:\r\ncase RT5663_ADC_RCH_BPF3_A1:\r\ncase RT5663_ADC_LCH_BPF3_A2:\r\ncase RT5663_ADC_RCH_BPF3_A2:\r\ncase RT5663_ADC_LCH_BPF3_H0:\r\ncase RT5663_ADC_RCH_BPF3_H0:\r\ncase RT5663_ADC_LCH_BPF4_A1:\r\ncase RT5663_ADC_RCH_BPF4_A1:\r\ncase RT5663_ADC_LCH_BPF4_A2:\r\ncase RT5663_ADC_RCH_BPF4_A2:\r\ncase RT5663_ADC_LCH_BPF4_H0:\r\ncase RT5663_ADC_RCH_BPF4_H0:\r\ncase RT5663_ADC_LCH_HPF1_A1:\r\ncase RT5663_ADC_RCH_HPF1_A1:\r\ncase RT5663_ADC_LCH_HPF1_H0:\r\ncase RT5663_ADC_RCH_HPF1_H0:\r\ncase RT5663_ADC_EQ_PRE_VOL_L:\r\ncase RT5663_ADC_EQ_PRE_VOL_R:\r\ncase RT5663_ADC_EQ_POST_VOL_L:\r\ncase RT5663_ADC_EQ_POST_VOL_R:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool rt5663_v2_volatile_register(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase RT5663_RESET:\r\ncase RT5663_CBJ_TYPE_2:\r\ncase RT5663_PDM_OUT_CTL:\r\ncase RT5663_PDM_I2C_DATA_CTL1:\r\ncase RT5663_PDM_I2C_DATA_CTL4:\r\ncase RT5663_ALC_BK_GAIN:\r\ncase RT5663_PLL_2:\r\ncase RT5663_MICBIAS_1:\r\ncase RT5663_ADC_EQ_1:\r\ncase RT5663_INT_ST_1:\r\ncase RT5663_GPIO_STA2:\r\ncase RT5663_IL_CMD_1:\r\ncase RT5663_IL_CMD_5:\r\ncase RT5663_A_JD_CTRL:\r\ncase RT5663_JD_CTRL2:\r\ncase RT5663_VENDOR_ID:\r\ncase RT5663_VENDOR_ID_1:\r\ncase RT5663_VENDOR_ID_2:\r\ncase RT5663_STO_DRE_1:\r\ncase RT5663_STO_DRE_5:\r\ncase RT5663_STO_DRE_6:\r\ncase RT5663_STO_DRE_7:\r\ncase RT5663_MONO_DYNA_6:\r\ncase RT5663_STO1_SIL_DET:\r\ncase RT5663_MONOL_SIL_DET:\r\ncase RT5663_MONOR_SIL_DET:\r\ncase RT5663_STO2_DAC_SIL:\r\ncase RT5663_MONO_AMP_CAL_ST1:\r\ncase RT5663_MONO_AMP_CAL_ST2:\r\ncase RT5663_MONO_AMP_CAL_ST3:\r\ncase RT5663_MONO_AMP_CAL_ST4:\r\ncase RT5663_HP_IMP_SEN_2:\r\ncase RT5663_HP_IMP_SEN_3:\r\ncase RT5663_HP_IMP_SEN_4:\r\ncase RT5663_HP_IMP_SEN_10:\r\ncase RT5663_HP_CALIB_1:\r\ncase RT5663_HP_CALIB_10:\r\ncase RT5663_HP_CALIB_ST1:\r\ncase RT5663_HP_CALIB_ST4:\r\ncase RT5663_HP_CALIB_ST5:\r\ncase RT5663_HP_CALIB_ST6:\r\ncase RT5663_HP_CALIB_ST7:\r\ncase RT5663_HP_CALIB_ST8:\r\ncase RT5663_HP_CALIB_ST9:\r\ncase RT5663_HP_CALIB_ST10:\r\ncase RT5663_HP_CALIB_ST11:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool rt5663_v2_readable_register(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase RT5663_LOUT_CTRL:\r\ncase RT5663_HP_AMP_2:\r\ncase RT5663_MONO_OUT:\r\ncase RT5663_MONO_GAIN:\r\ncase RT5663_AEC_BST:\r\ncase RT5663_IN1_IN2:\r\ncase RT5663_IN3_IN4:\r\ncase RT5663_INL1_INR1:\r\ncase RT5663_CBJ_TYPE_2:\r\ncase RT5663_CBJ_TYPE_3:\r\ncase RT5663_CBJ_TYPE_4:\r\ncase RT5663_CBJ_TYPE_5:\r\ncase RT5663_CBJ_TYPE_8:\r\ncase RT5663_DAC3_DIG_VOL:\r\ncase RT5663_DAC3_CTRL:\r\ncase RT5663_MONO_ADC_DIG_VOL:\r\ncase RT5663_STO2_ADC_DIG_VOL:\r\ncase RT5663_MONO_ADC_BST_GAIN:\r\ncase RT5663_STO2_ADC_BST_GAIN:\r\ncase RT5663_SIDETONE_CTRL:\r\ncase RT5663_MONO1_ADC_MIXER:\r\ncase RT5663_STO2_ADC_MIXER:\r\ncase RT5663_MONO_DAC_MIXER:\r\ncase RT5663_DAC2_SRC_CTRL:\r\ncase RT5663_IF_3_4_DATA_CTL:\r\ncase RT5663_IF_5_DATA_CTL:\r\ncase RT5663_PDM_OUT_CTL:\r\ncase RT5663_PDM_I2C_DATA_CTL1:\r\ncase RT5663_PDM_I2C_DATA_CTL2:\r\ncase RT5663_PDM_I2C_DATA_CTL3:\r\ncase RT5663_PDM_I2C_DATA_CTL4:\r\ncase RT5663_RECMIX1_NEW:\r\ncase RT5663_RECMIX1L_0:\r\ncase RT5663_RECMIX1L:\r\ncase RT5663_RECMIX1R_0:\r\ncase RT5663_RECMIX1R:\r\ncase RT5663_RECMIX2_NEW:\r\ncase RT5663_RECMIX2_L_2:\r\ncase RT5663_RECMIX2_R:\r\ncase RT5663_RECMIX2_R_2:\r\ncase RT5663_CALIB_REC_LR:\r\ncase RT5663_ALC_BK_GAIN:\r\ncase RT5663_MONOMIX_GAIN:\r\ncase RT5663_MONOMIX_IN_GAIN:\r\ncase RT5663_OUT_MIXL_GAIN:\r\ncase RT5663_OUT_LMIX_IN_GAIN:\r\ncase RT5663_OUT_RMIX_IN_GAIN:\r\ncase RT5663_OUT_RMIX_IN_GAIN1:\r\ncase RT5663_LOUT_MIXER_CTRL:\r\ncase RT5663_PWR_VOL:\r\ncase RT5663_ADCDAC_RST:\r\ncase RT5663_I2S34_SDP:\r\ncase RT5663_I2S5_SDP:\r\ncase RT5663_TDM_6:\r\ncase RT5663_TDM_7:\r\ncase RT5663_TDM_8:\r\ncase RT5663_TDM_9:\r\ncase RT5663_ASRC_3:\r\ncase RT5663_ASRC_6:\r\ncase RT5663_ASRC_7:\r\ncase RT5663_PLL_TRK_13:\r\ncase RT5663_I2S_M_CLK_CTL:\r\ncase RT5663_FDIV_I2S34_M_CLK:\r\ncase RT5663_FDIV_I2S34_M_CLK2:\r\ncase RT5663_FDIV_I2S5_M_CLK:\r\ncase RT5663_FDIV_I2S5_M_CLK2:\r\ncase RT5663_V2_IRQ_4:\r\ncase RT5663_GPIO_3:\r\ncase RT5663_GPIO_4:\r\ncase RT5663_GPIO_STA2:\r\ncase RT5663_HP_AMP_DET1:\r\ncase RT5663_HP_AMP_DET2:\r\ncase RT5663_HP_AMP_DET3:\r\ncase RT5663_MID_BD_HP_AMP:\r\ncase RT5663_LOW_BD_HP_AMP:\r\ncase RT5663_SOF_VOL_ZC2:\r\ncase RT5663_ADC_STO2_ADJ1:\r\ncase RT5663_ADC_STO2_ADJ2:\r\ncase RT5663_A_JD_CTRL:\r\ncase RT5663_JD1_TRES_CTRL:\r\ncase RT5663_JD2_TRES_CTRL:\r\ncase RT5663_V2_JD_CTRL2:\r\ncase RT5663_DUM_REG_2:\r\ncase RT5663_DUM_REG_3:\r\ncase RT5663_VENDOR_ID:\r\ncase RT5663_VENDOR_ID_1:\r\ncase RT5663_VENDOR_ID_2:\r\ncase RT5663_DACADC_DIG_VOL2:\r\ncase RT5663_DIG_IN_PIN2:\r\ncase RT5663_PAD_DRV_CTL1:\r\ncase RT5663_SOF_RAM_DEPOP:\r\ncase RT5663_VOL_TEST:\r\ncase RT5663_TEST_MODE_4:\r\ncase RT5663_TEST_MODE_5:\r\ncase RT5663_STO_DRE_9:\r\ncase RT5663_MONO_DYNA_1:\r\ncase RT5663_MONO_DYNA_2:\r\ncase RT5663_MONO_DYNA_3:\r\ncase RT5663_MONO_DYNA_4:\r\ncase RT5663_MONO_DYNA_5:\r\ncase RT5663_MONO_DYNA_6:\r\ncase RT5663_STO1_SIL_DET:\r\ncase RT5663_MONOL_SIL_DET:\r\ncase RT5663_MONOR_SIL_DET:\r\ncase RT5663_STO2_DAC_SIL:\r\ncase RT5663_PWR_SAV_CTL1:\r\ncase RT5663_PWR_SAV_CTL2:\r\ncase RT5663_PWR_SAV_CTL3:\r\ncase RT5663_PWR_SAV_CTL4:\r\ncase RT5663_PWR_SAV_CTL5:\r\ncase RT5663_PWR_SAV_CTL6:\r\ncase RT5663_MONO_AMP_CAL1:\r\ncase RT5663_MONO_AMP_CAL2:\r\ncase RT5663_MONO_AMP_CAL3:\r\ncase RT5663_MONO_AMP_CAL4:\r\ncase RT5663_MONO_AMP_CAL5:\r\ncase RT5663_MONO_AMP_CAL6:\r\ncase RT5663_MONO_AMP_CAL7:\r\ncase RT5663_MONO_AMP_CAL_ST1:\r\ncase RT5663_MONO_AMP_CAL_ST2:\r\ncase RT5663_MONO_AMP_CAL_ST3:\r\ncase RT5663_MONO_AMP_CAL_ST4:\r\ncase RT5663_MONO_AMP_CAL_ST5:\r\ncase RT5663_V2_HP_IMP_SEN_13:\r\ncase RT5663_V2_HP_IMP_SEN_14:\r\ncase RT5663_V2_HP_IMP_SEN_6:\r\ncase RT5663_V2_HP_IMP_SEN_7:\r\ncase RT5663_V2_HP_IMP_SEN_8:\r\ncase RT5663_V2_HP_IMP_SEN_9:\r\ncase RT5663_V2_HP_IMP_SEN_10:\r\ncase RT5663_HP_LOGIC_3:\r\ncase RT5663_HP_CALIB_ST10:\r\ncase RT5663_HP_CALIB_ST11:\r\ncase RT5663_PRO_REG_TBL_4:\r\ncase RT5663_PRO_REG_TBL_5:\r\ncase RT5663_PRO_REG_TBL_6:\r\ncase RT5663_PRO_REG_TBL_7:\r\ncase RT5663_PRO_REG_TBL_8:\r\ncase RT5663_PRO_REG_TBL_9:\r\ncase RT5663_SAR_ADC_INL_1:\r\ncase RT5663_SAR_ADC_INL_2:\r\ncase RT5663_SAR_ADC_INL_3:\r\ncase RT5663_SAR_ADC_INL_4:\r\ncase RT5663_SAR_ADC_INL_5:\r\ncase RT5663_SAR_ADC_INL_6:\r\ncase RT5663_SAR_ADC_INL_7:\r\ncase RT5663_SAR_ADC_INL_8:\r\ncase RT5663_SAR_ADC_INL_9:\r\ncase RT5663_SAR_ADC_INL_10:\r\ncase RT5663_SAR_ADC_INL_11:\r\ncase RT5663_SAR_ADC_INL_12:\r\ncase RT5663_DRC_CTRL_1:\r\ncase RT5663_DRC1_CTRL_2:\r\ncase RT5663_DRC1_CTRL_3:\r\ncase RT5663_DRC1_CTRL_4:\r\ncase RT5663_DRC1_CTRL_5:\r\ncase RT5663_DRC1_CTRL_6:\r\ncase RT5663_DRC1_HD_CTRL_1:\r\ncase RT5663_DRC1_HD_CTRL_2:\r\ncase RT5663_DRC1_PRI_REG_1:\r\ncase RT5663_DRC1_PRI_REG_2:\r\ncase RT5663_DRC1_PRI_REG_3:\r\ncase RT5663_DRC1_PRI_REG_4:\r\ncase RT5663_DRC1_PRI_REG_5:\r\ncase RT5663_DRC1_PRI_REG_6:\r\ncase RT5663_DRC1_PRI_REG_7:\r\ncase RT5663_DRC1_PRI_REG_8:\r\ncase RT5663_ALC_PGA_CTL_1:\r\ncase RT5663_ALC_PGA_CTL_2:\r\ncase RT5663_ALC_PGA_CTL_3:\r\ncase RT5663_ALC_PGA_CTL_4:\r\ncase RT5663_ALC_PGA_CTL_5:\r\ncase RT5663_ALC_PGA_CTL_6:\r\ncase RT5663_ALC_PGA_CTL_7:\r\ncase RT5663_ALC_PGA_CTL_8:\r\ncase RT5663_ALC_PGA_REG_1:\r\ncase RT5663_ALC_PGA_REG_2:\r\ncase RT5663_ALC_PGA_REG_3:\r\ncase RT5663_ADC_EQ_RECOV_1:\r\ncase RT5663_ADC_EQ_RECOV_2:\r\ncase RT5663_ADC_EQ_RECOV_3:\r\ncase RT5663_ADC_EQ_RECOV_4:\r\ncase RT5663_ADC_EQ_RECOV_5:\r\ncase RT5663_ADC_EQ_RECOV_6:\r\ncase RT5663_ADC_EQ_RECOV_7:\r\ncase RT5663_ADC_EQ_RECOV_8:\r\ncase RT5663_ADC_EQ_RECOV_9:\r\ncase RT5663_ADC_EQ_RECOV_10:\r\ncase RT5663_ADC_EQ_RECOV_11:\r\ncase RT5663_ADC_EQ_RECOV_12:\r\ncase RT5663_ADC_EQ_RECOV_13:\r\ncase RT5663_VID_HIDDEN:\r\ncase RT5663_VID_CUSTOMER:\r\ncase RT5663_SCAN_MODE:\r\ncase RT5663_I2C_BYPA:\r\nreturn true;\r\ncase RT5663_TDM_1:\r\ncase RT5663_DEPOP_3:\r\ncase RT5663_ASRC_11_2:\r\ncase RT5663_INT_ST_2:\r\ncase RT5663_GPIO_STA1:\r\ncase RT5663_SIN_GEN_1:\r\ncase RT5663_SIN_GEN_2:\r\ncase RT5663_SIN_GEN_3:\r\ncase RT5663_IL_CMD_PWRSAV1:\r\ncase RT5663_IL_CMD_PWRSAV2:\r\ncase RT5663_EM_JACK_TYPE_1:\r\ncase RT5663_EM_JACK_TYPE_2:\r\ncase RT5663_EM_JACK_TYPE_3:\r\ncase RT5663_EM_JACK_TYPE_4:\r\ncase RT5663_FAST_OFF_MICBIAS:\r\ncase RT5663_ANA_BIAS_CUR_1:\r\ncase RT5663_ANA_BIAS_CUR_2:\r\ncase RT5663_BIAS_CUR_9:\r\ncase RT5663_DUMMY_REG_4:\r\ncase RT5663_VREF_RECMIX:\r\ncase RT5663_CHARGE_PUMP_1_2:\r\ncase RT5663_CHARGE_PUMP_1_3:\r\ncase RT5663_CHARGE_PUMP_2:\r\ncase RT5663_CHOP_DAC_R:\r\ncase RT5663_DUMMY_CTL_DACLR:\r\ncase RT5663_DUMMY_REG_5:\r\ncase RT5663_SOFT_RAMP:\r\ncase RT5663_TEST_MODE_1:\r\ncase RT5663_STO_DRE_10:\r\ncase RT5663_MIC_DECRO_1:\r\ncase RT5663_MIC_DECRO_2:\r\ncase RT5663_MIC_DECRO_3:\r\ncase RT5663_MIC_DECRO_4:\r\ncase RT5663_MIC_DECRO_5:\r\ncase RT5663_MIC_DECRO_6:\r\ncase RT5663_HP_DECRO_1:\r\ncase RT5663_HP_DECRO_2:\r\ncase RT5663_HP_DECRO_3:\r\ncase RT5663_HP_DECRO_4:\r\ncase RT5663_HP_DECOUP:\r\ncase RT5663_HP_IMPSEN_MAP4:\r\ncase RT5663_HP_IMPSEN_MAP5:\r\ncase RT5663_HP_IMPSEN_MAP7:\r\ncase RT5663_HP_CALIB_1:\r\ncase RT5663_CBJ_1:\r\ncase RT5663_CBJ_2:\r\ncase RT5663_CBJ_3:\r\nreturn false;\r\ndefault:\r\nreturn rt5663_readable_register(dev, reg);\r\n}\r\n}\r\nstatic void rt5663_enable_push_button_irq(struct snd_soc_codec *codec,\r\nbool enable)\r\n{\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nif (enable) {\r\nsnd_soc_update_bits(codec, RT5663_IL_CMD_6,\r\nRT5663_EN_4BTN_INL_MASK, RT5663_EN_4BTN_INL_EN);\r\nsnd_soc_update_bits(codec, RT5663_IL_CMD_6,\r\nRT5663_RESET_4BTN_INL_MASK,\r\nRT5663_RESET_4BTN_INL_RESET);\r\nsnd_soc_update_bits(codec, RT5663_IL_CMD_6,\r\nRT5663_RESET_4BTN_INL_MASK,\r\nRT5663_RESET_4BTN_INL_NOR);\r\nswitch (rt5663->codec_ver) {\r\ncase CODEC_VER_1:\r\nsnd_soc_update_bits(codec, RT5663_IRQ_3,\r\nRT5663_V2_EN_IRQ_INLINE_MASK,\r\nRT5663_V2_EN_IRQ_INLINE_NOR);\r\nbreak;\r\ncase CODEC_VER_0:\r\nsnd_soc_update_bits(codec, RT5663_IRQ_2,\r\nRT5663_EN_IRQ_INLINE_MASK,\r\nRT5663_EN_IRQ_INLINE_NOR);\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Unknown CODEC Version\n");\r\n}\r\n} else {\r\nswitch (rt5663->codec_ver) {\r\ncase CODEC_VER_1:\r\nsnd_soc_update_bits(codec, RT5663_IRQ_3,\r\nRT5663_V2_EN_IRQ_INLINE_MASK,\r\nRT5663_V2_EN_IRQ_INLINE_BYP);\r\nbreak;\r\ncase CODEC_VER_0:\r\nsnd_soc_update_bits(codec, RT5663_IRQ_2,\r\nRT5663_EN_IRQ_INLINE_MASK,\r\nRT5663_EN_IRQ_INLINE_BYP);\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Unknown CODEC Version\n");\r\n}\r\nsnd_soc_update_bits(codec, RT5663_IL_CMD_6,\r\nRT5663_EN_4BTN_INL_MASK, RT5663_EN_4BTN_INL_DIS);\r\nsnd_soc_update_bits(codec, RT5663_IL_CMD_6,\r\nRT5663_RESET_4BTN_INL_MASK,\r\nRT5663_RESET_4BTN_INL_RESET);\r\nsnd_soc_update_bits(codec, RT5663_IL_CMD_6,\r\nRT5663_RESET_4BTN_INL_MASK,\r\nRT5663_RESET_4BTN_INL_NOR);\r\n}\r\n}\r\nstatic int rt5663_v2_jack_detect(struct snd_soc_codec *codec, int jack_insert)\r\n{\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nint val, i = 0, sleep_time[5] = {300, 150, 100, 50, 30};\r\ndev_dbg(codec->dev, "%s jack_insert:%d\n", __func__, jack_insert);\r\nif (jack_insert) {\r\nsnd_soc_write(codec, RT5663_CBJ_TYPE_2, 0x8040);\r\nsnd_soc_write(codec, RT5663_CBJ_TYPE_3, 0x1484);\r\nsnd_soc_dapm_force_enable_pin(dapm, "MICBIAS1");\r\nsnd_soc_dapm_force_enable_pin(dapm, "MICBIAS2");\r\nsnd_soc_dapm_force_enable_pin(dapm, "Mic Det Power");\r\nsnd_soc_dapm_force_enable_pin(dapm, "CBJ Power");\r\nsnd_soc_dapm_sync(dapm);\r\nsnd_soc_update_bits(codec, RT5663_RC_CLK,\r\nRT5663_DIG_1M_CLK_MASK, RT5663_DIG_1M_CLK_EN);\r\nsnd_soc_update_bits(codec, RT5663_RECMIX, 0x8, 0x8);\r\nwhile (i < 5) {\r\nmsleep(sleep_time[i]);\r\nval = snd_soc_read(codec, RT5663_CBJ_TYPE_2) & 0x0003;\r\nif (val == 0x1 || val == 0x2 || val == 0x3)\r\nbreak;\r\ndev_dbg(codec->dev, "%s: MX-0011 val=%x sleep %d\n",\r\n__func__, val, sleep_time[i]);\r\ni++;\r\n}\r\ndev_dbg(codec->dev, "%s val = %d\n", __func__, val);\r\nswitch (val) {\r\ncase 1:\r\ncase 2:\r\nrt5663->jack_type = SND_JACK_HEADSET;\r\nrt5663_enable_push_button_irq(codec, true);\r\nbreak;\r\ndefault:\r\nsnd_soc_dapm_disable_pin(dapm, "MICBIAS1");\r\nsnd_soc_dapm_disable_pin(dapm, "MICBIAS2");\r\nsnd_soc_dapm_disable_pin(dapm, "Mic Det Power");\r\nsnd_soc_dapm_disable_pin(dapm, "CBJ Power");\r\nsnd_soc_dapm_sync(dapm);\r\nrt5663->jack_type = SND_JACK_HEADPHONE;\r\nbreak;\r\n}\r\n} else {\r\nsnd_soc_update_bits(codec, RT5663_RECMIX, 0x8, 0x0);\r\nif (rt5663->jack_type == SND_JACK_HEADSET) {\r\nrt5663_enable_push_button_irq(codec, false);\r\nsnd_soc_dapm_disable_pin(dapm, "MICBIAS1");\r\nsnd_soc_dapm_disable_pin(dapm, "MICBIAS2");\r\nsnd_soc_dapm_disable_pin(dapm, "Mic Det Power");\r\nsnd_soc_dapm_disable_pin(dapm, "CBJ Power");\r\nsnd_soc_dapm_sync(dapm);\r\n}\r\nrt5663->jack_type = 0;\r\n}\r\ndev_dbg(codec->dev, "jack_type = %d\n", rt5663->jack_type);\r\nreturn rt5663->jack_type;\r\n}\r\nstatic int rt5663_jack_detect(struct snd_soc_codec *codec, int jack_insert)\r\n{\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nint val, i = 0, sleep_time[5] = {300, 150, 100, 50, 30};\r\ndev_dbg(codec->dev, "%s jack_insert:%d\n", __func__, jack_insert);\r\nif (jack_insert) {\r\nsnd_soc_update_bits(codec, RT5663_DIG_MISC,\r\nRT5663_DIG_GATE_CTRL_MASK, RT5663_DIG_GATE_CTRL_EN);\r\nsnd_soc_update_bits(codec, RT5663_HP_CHARGE_PUMP_1,\r\nRT5663_SI_HP_MASK | RT5663_OSW_HP_L_MASK |\r\nRT5663_OSW_HP_R_MASK, RT5663_SI_HP_EN |\r\nRT5663_OSW_HP_L_DIS | RT5663_OSW_HP_R_DIS);\r\nsnd_soc_update_bits(codec, RT5663_DUMMY_1,\r\nRT5663_EMB_CLK_MASK | RT5663_HPA_CPL_BIAS_MASK |\r\nRT5663_HPA_CPR_BIAS_MASK, RT5663_EMB_CLK_EN |\r\nRT5663_HPA_CPL_BIAS_1 | RT5663_HPA_CPR_BIAS_1);\r\nsnd_soc_update_bits(codec, RT5663_CBJ_1,\r\nRT5663_INBUF_CBJ_BST1_MASK | RT5663_CBJ_SENSE_BST1_MASK,\r\nRT5663_INBUF_CBJ_BST1_ON | RT5663_CBJ_SENSE_BST1_L);\r\nsnd_soc_update_bits(codec, RT5663_IL_CMD_2,\r\nRT5663_PWR_MIC_DET_MASK, RT5663_PWR_MIC_DET_ON);\r\nsnd_soc_update_bits(codec, RT5663_PWR_ANLG_2,\r\nRT5663_PWR_BST1_MASK, RT5663_PWR_BST1_ON);\r\nsnd_soc_update_bits(codec, RT5663_EM_JACK_TYPE_1,\r\nRT5663_CBJ_DET_MASK | RT5663_EXT_JD_MASK |\r\nRT5663_POL_EXT_JD_MASK, RT5663_CBJ_DET_EN |\r\nRT5663_EXT_JD_EN | RT5663_POL_EXT_JD_EN);\r\nsnd_soc_update_bits(codec, RT5663_PWR_ANLG_1,\r\nRT5663_PWR_MB_MASK | RT5663_LDO1_DVO_MASK |\r\nRT5663_AMP_HP_MASK, RT5663_PWR_MB |\r\nRT5663_LDO1_DVO_0_9V | RT5663_AMP_HP_3X);\r\nsnd_soc_update_bits(codec, RT5663_AUTO_1MRC_CLK,\r\nRT5663_IRQ_POW_SAV_MASK, RT5663_IRQ_POW_SAV_EN);\r\nsnd_soc_update_bits(codec, RT5663_IRQ_1,\r\nRT5663_EN_IRQ_JD1_MASK, RT5663_EN_IRQ_JD1_EN);\r\nwhile (i < 5) {\r\nmsleep(sleep_time[i]);\r\nval = snd_soc_read(codec, RT5663_EM_JACK_TYPE_2) &\r\n0x0003;\r\ndev_dbg(codec->dev, "%s: MX-00e7 val=%x sleep %d\n",\r\n__func__, val, sleep_time[i]);\r\ni++;\r\nif (val == 0x1 || val == 0x2 || val == 0x3)\r\nbreak;\r\n}\r\ndev_dbg(codec->dev, "%s val = %d\n", __func__, val);\r\nswitch (val) {\r\ncase 1:\r\ncase 2:\r\nrt5663->jack_type = SND_JACK_HEADSET;\r\nrt5663_enable_push_button_irq(codec, true);\r\nbreak;\r\ndefault:\r\nrt5663->jack_type = SND_JACK_HEADPHONE;\r\nbreak;\r\n}\r\n} else {\r\nif (rt5663->jack_type == SND_JACK_HEADSET)\r\nrt5663_enable_push_button_irq(codec, false);\r\nrt5663->jack_type = 0;\r\n}\r\ndev_dbg(codec->dev, "jack_type = %d\n", rt5663->jack_type);\r\nreturn rt5663->jack_type;\r\n}\r\nstatic int rt5663_button_detect(struct snd_soc_codec *codec)\r\n{\r\nint btn_type, val;\r\nval = snd_soc_read(codec, RT5663_IL_CMD_5);\r\ndev_dbg(codec->dev, "%s: val=0x%x\n", __func__, val);\r\nbtn_type = val & 0xfff0;\r\nsnd_soc_write(codec, RT5663_IL_CMD_5, val);\r\nreturn btn_type;\r\n}\r\nstatic irqreturn_t rt5663_irq(int irq, void *data)\r\n{\r\nstruct rt5663_priv *rt5663 = data;\r\ndev_dbg(rt5663->codec->dev, "%s IRQ queue work\n", __func__);\r\nqueue_delayed_work(system_wq, &rt5663->jack_detect_work,\r\nmsecs_to_jiffies(250));\r\nreturn IRQ_HANDLED;\r\n}\r\nint rt5663_set_jack_detect(struct snd_soc_codec *codec,\r\nstruct snd_soc_jack *hs_jack)\r\n{\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nrt5663->hs_jack = hs_jack;\r\nrt5663_irq(0, rt5663);\r\nreturn 0;\r\n}\r\nstatic bool rt5663_check_jd_status(struct snd_soc_codec *codec)\r\n{\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nint val = snd_soc_read(codec, RT5663_INT_ST_1);\r\ndev_dbg(codec->dev, "%s val=%x\n", __func__, val);\r\nswitch (rt5663->codec_ver) {\r\ncase CODEC_VER_1:\r\nreturn !(val & 0x2000);\r\ncase CODEC_VER_0:\r\nreturn !(val & 0x1000);\r\ndefault:\r\ndev_err(codec->dev, "Unknown CODEC Version\n");\r\n}\r\nreturn false;\r\n}\r\nstatic void rt5663_jack_detect_work(struct work_struct *work)\r\n{\r\nstruct rt5663_priv *rt5663 =\r\ncontainer_of(work, struct rt5663_priv, jack_detect_work.work);\r\nstruct snd_soc_codec *codec = rt5663->codec;\r\nint btn_type, report = 0;\r\nif (!codec)\r\nreturn;\r\nif (rt5663_check_jd_status(codec)) {\r\nif (rt5663->jack_type == 0) {\r\nswitch (rt5663->codec_ver) {\r\ncase CODEC_VER_1:\r\nreport = rt5663_v2_jack_detect(\r\nrt5663->codec, 1);\r\nbreak;\r\ncase CODEC_VER_0:\r\nreport = rt5663_jack_detect(rt5663->codec, 1);\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Unknown CODEC Version\n");\r\n}\r\n} else {\r\nreport = SND_JACK_HEADSET;\r\nbtn_type = rt5663_button_detect(rt5663->codec);\r\nswitch (btn_type) {\r\ncase 0x8000:\r\ncase 0x4000:\r\ncase 0x2000:\r\nreport |= SND_JACK_BTN_0;\r\nbreak;\r\ncase 0x1000:\r\ncase 0x0800:\r\ncase 0x0400:\r\nreport |= SND_JACK_BTN_1;\r\nbreak;\r\ncase 0x0200:\r\ncase 0x0100:\r\ncase 0x0080:\r\nreport |= SND_JACK_BTN_2;\r\nbreak;\r\ncase 0x0040:\r\ncase 0x0020:\r\ncase 0x0010:\r\nreport |= SND_JACK_BTN_3;\r\nbreak;\r\ncase 0x0000:\r\nbreak;\r\ndefault:\r\nbtn_type = 0;\r\ndev_err(rt5663->codec->dev,\r\n"Unexpected button code 0x%04x\n",\r\nbtn_type);\r\nbreak;\r\n}\r\nif (btn_type == 0)\r\nreport = rt5663->jack_type;\r\n}\r\n} else {\r\nswitch (rt5663->codec_ver) {\r\ncase CODEC_VER_1:\r\nreport = rt5663_v2_jack_detect(rt5663->codec, 0);\r\nbreak;\r\ncase CODEC_VER_0:\r\nreport = rt5663_jack_detect(rt5663->codec, 0);\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Unknown CODEC Version\n");\r\n}\r\n}\r\ndev_dbg(codec->dev, "%s jack report: 0x%04x\n", __func__, report);\r\nsnd_soc_jack_report(rt5663->hs_jack, report, SND_JACK_HEADSET |\r\nSND_JACK_BTN_0 | SND_JACK_BTN_1 |\r\nSND_JACK_BTN_2 | SND_JACK_BTN_3);\r\n}\r\nstatic int rt5663_is_sys_clk_from_pll(struct snd_soc_dapm_widget *w,\r\nstruct snd_soc_dapm_widget *sink)\r\n{\r\nunsigned int val;\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nval = snd_soc_read(codec, RT5663_GLB_CLK);\r\nval &= RT5663_SCLK_SRC_MASK;\r\nif (val == RT5663_SCLK_SRC_PLL1)\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic int rt5663_is_using_asrc(struct snd_soc_dapm_widget *w,\r\nstruct snd_soc_dapm_widget *sink)\r\n{\r\nunsigned int reg, shift, val;\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nif (rt5663->codec_ver == CODEC_VER_1) {\r\nswitch (w->shift) {\r\ncase RT5663_ADC_STO1_ASRC_SHIFT:\r\nreg = RT5663_ASRC_3;\r\nshift = RT5663_V2_AD_STO1_TRACK_SHIFT;\r\nbreak;\r\ncase RT5663_DAC_STO1_ASRC_SHIFT:\r\nreg = RT5663_ASRC_2;\r\nshift = RT5663_DA_STO1_TRACK_SHIFT;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\n} else {\r\nswitch (w->shift) {\r\ncase RT5663_ADC_STO1_ASRC_SHIFT:\r\nreg = RT5663_ASRC_2;\r\nshift = RT5663_AD_STO1_TRACK_SHIFT;\r\nbreak;\r\ncase RT5663_DAC_STO1_ASRC_SHIFT:\r\nreg = RT5663_ASRC_2;\r\nshift = RT5663_DA_STO1_TRACK_SHIFT;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nval = (snd_soc_read(codec, reg) >> shift) & 0x7;\r\nif (val)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int rt5663_i2s_use_asrc(struct snd_soc_dapm_widget *source,\r\nstruct snd_soc_dapm_widget *sink)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(source->dapm);\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nint da_asrc_en, ad_asrc_en;\r\nda_asrc_en = (snd_soc_read(codec, RT5663_ASRC_2) &\r\nRT5663_DA_STO1_TRACK_MASK) ? 1 : 0;\r\nswitch (rt5663->codec_ver) {\r\ncase CODEC_VER_1:\r\nad_asrc_en = (snd_soc_read(codec, RT5663_ASRC_3) &\r\nRT5663_V2_AD_STO1_TRACK_MASK) ? 1 : 0;\r\nbreak;\r\ncase CODEC_VER_0:\r\nad_asrc_en = (snd_soc_read(codec, RT5663_ASRC_2) &\r\nRT5663_AD_STO1_TRACK_MASK) ? 1 : 0;\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Unknown CODEC Version\n");\r\nreturn 1;\r\n}\r\nif (da_asrc_en || ad_asrc_en)\r\nif (rt5663->sysclk > rt5663->lrck * 384)\r\nreturn 1;\r\ndev_err(codec->dev, "sysclk < 384 x fs, disable i2s asrc\n");\r\nreturn 0;\r\n}\r\nint rt5663_sel_asrc_clk_src(struct snd_soc_codec *codec,\r\nunsigned int filter_mask, unsigned int clk_src)\r\n{\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int asrc2_mask = 0;\r\nunsigned int asrc2_value = 0;\r\nunsigned int asrc3_mask = 0;\r\nunsigned int asrc3_value = 0;\r\nswitch (clk_src) {\r\ncase RT5663_CLK_SEL_SYS:\r\ncase RT5663_CLK_SEL_I2S1_ASRC:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (filter_mask & RT5663_DA_STEREO_FILTER) {\r\nasrc2_mask |= RT5663_DA_STO1_TRACK_MASK;\r\nasrc2_value |= clk_src << RT5663_DA_STO1_TRACK_SHIFT;\r\n}\r\nif (filter_mask & RT5663_AD_STEREO_FILTER) {\r\nswitch (rt5663->codec_ver) {\r\ncase CODEC_VER_1:\r\nasrc3_mask |= RT5663_V2_AD_STO1_TRACK_MASK;\r\nasrc3_value |= clk_src << RT5663_V2_AD_STO1_TRACK_SHIFT;\r\nbreak;\r\ncase CODEC_VER_0:\r\nasrc2_mask |= RT5663_AD_STO1_TRACK_MASK;\r\nasrc2_value |= clk_src << RT5663_AD_STO1_TRACK_SHIFT;\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Unknown CODEC Version\n");\r\n}\r\n}\r\nif (asrc2_mask)\r\nsnd_soc_update_bits(codec, RT5663_ASRC_2, asrc2_mask,\r\nasrc2_value);\r\nif (asrc3_mask)\r\nsnd_soc_update_bits(codec, RT5663_ASRC_3, asrc3_mask,\r\nasrc3_value);\r\nreturn 0;\r\n}\r\nstatic int rt5663_hp_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nswitch (event) {\r\ncase SND_SOC_DAPM_POST_PMU:\r\nif (rt5663->codec_ver == CODEC_VER_1) {\r\nsnd_soc_update_bits(codec, RT5663_HP_CHARGE_PUMP_1,\r\nRT5663_SEL_PM_HP_SHIFT, RT5663_SEL_PM_HP_HIGH);\r\nsnd_soc_update_bits(codec, RT5663_HP_LOGIC_2,\r\nRT5663_HP_SIG_SRC1_MASK,\r\nRT5663_HP_SIG_SRC1_SILENCE);\r\n} else {\r\nsnd_soc_write(codec, RT5663_DEPOP_2, 0x3003);\r\nsnd_soc_update_bits(codec, RT5663_DEPOP_1, 0x000b,\r\n0x000b);\r\nsnd_soc_update_bits(codec, RT5663_DEPOP_1, 0x0030,\r\n0x0030);\r\nsnd_soc_update_bits(codec, RT5663_HP_CHARGE_PUMP_1,\r\nRT5663_OVCD_HP_MASK, RT5663_OVCD_HP_DIS);\r\nsnd_soc_write(codec, RT5663_HP_CHARGE_PUMP_2, 0x1371);\r\nsnd_soc_write(codec, RT5663_HP_BIAS, 0xabba);\r\nsnd_soc_write(codec, RT5663_CHARGE_PUMP_1, 0x2224);\r\nsnd_soc_write(codec, RT5663_ANA_BIAS_CUR_1, 0x7766);\r\nsnd_soc_write(codec, RT5663_HP_BIAS, 0xafaa);\r\nsnd_soc_write(codec, RT5663_CHARGE_PUMP_2, 0x7777);\r\nsnd_soc_update_bits(codec, RT5663_DEPOP_1, 0x3000,\r\n0x3000);\r\n}\r\nbreak;\r\ncase SND_SOC_DAPM_PRE_PMD:\r\nif (rt5663->codec_ver == CODEC_VER_1) {\r\nsnd_soc_update_bits(codec, RT5663_HP_LOGIC_2,\r\nRT5663_HP_SIG_SRC1_MASK,\r\nRT5663_HP_SIG_SRC1_REG);\r\n} else {\r\nsnd_soc_update_bits(codec, RT5663_DEPOP_1, 0x3000, 0x0);\r\nsnd_soc_update_bits(codec, RT5663_HP_CHARGE_PUMP_1,\r\nRT5663_OVCD_HP_MASK, RT5663_OVCD_HP_EN);\r\nsnd_soc_update_bits(codec, RT5663_DEPOP_1, 0x0030, 0x0);\r\nsnd_soc_update_bits(codec, RT5663_DEPOP_1, 0x000b,\r\n0x000b);\r\n}\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5663_bst2_power(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nswitch (event) {\r\ncase SND_SOC_DAPM_POST_PMU:\r\nsnd_soc_update_bits(codec, RT5663_PWR_ANLG_2,\r\nRT5663_PWR_BST2_MASK | RT5663_PWR_BST2_OP_MASK,\r\nRT5663_PWR_BST2 | RT5663_PWR_BST2_OP);\r\nbreak;\r\ncase SND_SOC_DAPM_PRE_PMD:\r\nsnd_soc_update_bits(codec, RT5663_PWR_ANLG_2,\r\nRT5663_PWR_BST2_MASK | RT5663_PWR_BST2_OP_MASK, 0);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5663_pre_div_power(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nswitch (event) {\r\ncase SND_SOC_DAPM_POST_PMU:\r\nsnd_soc_write(codec, RT5663_PRE_DIV_GATING_1, 0xff00);\r\nsnd_soc_write(codec, RT5663_PRE_DIV_GATING_2, 0xfffc);\r\nbreak;\r\ncase SND_SOC_DAPM_PRE_PMD:\r\nsnd_soc_write(codec, RT5663_PRE_DIV_GATING_1, 0x0000);\r\nsnd_soc_write(codec, RT5663_PRE_DIV_GATING_2, 0x0000);\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5663_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int val_len = 0;\r\nint pre_div;\r\nrt5663->lrck = params_rate(params);\r\ndev_dbg(dai->dev, "bclk is %dHz and sysclk is %dHz\n",\r\nrt5663->lrck, rt5663->sysclk);\r\npre_div = rl6231_get_clk_info(rt5663->sysclk, rt5663->lrck);\r\nif (pre_div < 0) {\r\ndev_err(codec->dev, "Unsupported clock setting %d for DAI %d\n",\r\nrt5663->lrck, dai->id);\r\nreturn -EINVAL;\r\n}\r\ndev_dbg(dai->dev, "pre_div is %d for iis %d\n", pre_div, dai->id);\r\nswitch (params_width(params)) {\r\ncase 8:\r\nval_len = RT5663_I2S_DL_8;\r\nbreak;\r\ncase 16:\r\nval_len = RT5663_I2S_DL_16;\r\nbreak;\r\ncase 20:\r\nval_len = RT5663_I2S_DL_20;\r\nbreak;\r\ncase 24:\r\nval_len = RT5663_I2S_DL_24;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nsnd_soc_update_bits(codec, RT5663_I2S1_SDP,\r\nRT5663_I2S_DL_MASK, val_len);\r\nsnd_soc_update_bits(codec, RT5663_ADDA_CLK_1,\r\nRT5663_I2S_PD1_MASK, pre_div << RT5663_I2S_PD1_SHIFT);\r\nreturn 0;\r\n}\r\nstatic int rt5663_set_dai_fmt(struct snd_soc_dai *dai, unsigned int fmt)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nunsigned int reg_val = 0;\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\nreg_val |= RT5663_I2S_MS_S;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\r\ncase SND_SOC_DAIFMT_NB_NF:\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_NF:\r\nreg_val |= RT5663_I2S_BP_INV;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\nbreak;\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\nreg_val |= RT5663_I2S_DF_LEFT;\r\nbreak;\r\ncase SND_SOC_DAIFMT_DSP_A:\r\nreg_val |= RT5663_I2S_DF_PCM_A;\r\nbreak;\r\ncase SND_SOC_DAIFMT_DSP_B:\r\nreg_val |= RT5663_I2S_DF_PCM_B;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nsnd_soc_update_bits(codec, RT5663_I2S1_SDP, RT5663_I2S_MS_MASK |\r\nRT5663_I2S_BP_MASK | RT5663_I2S_DF_MASK, reg_val);\r\nreturn 0;\r\n}\r\nstatic int rt5663_set_dai_sysclk(struct snd_soc_dai *dai, int clk_id,\r\nunsigned int freq, int dir)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int reg_val = 0;\r\nif (freq == rt5663->sysclk && clk_id == rt5663->sysclk_src)\r\nreturn 0;\r\nswitch (clk_id) {\r\ncase RT5663_SCLK_S_MCLK:\r\nreg_val |= RT5663_SCLK_SRC_MCLK;\r\nbreak;\r\ncase RT5663_SCLK_S_PLL1:\r\nreg_val |= RT5663_SCLK_SRC_PLL1;\r\nbreak;\r\ncase RT5663_SCLK_S_RCCLK:\r\nreg_val |= RT5663_SCLK_SRC_RCCLK;\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Invalid clock id (%d)\n", clk_id);\r\nreturn -EINVAL;\r\n}\r\nsnd_soc_update_bits(codec, RT5663_GLB_CLK, RT5663_SCLK_SRC_MASK,\r\nreg_val);\r\nrt5663->sysclk = freq;\r\nrt5663->sysclk_src = clk_id;\r\ndev_dbg(codec->dev, "Sysclk is %dHz and clock id is %d\n",\r\nfreq, clk_id);\r\nreturn 0;\r\n}\r\nstatic int rt5663_set_dai_pll(struct snd_soc_dai *dai, int pll_id, int source,\r\nunsigned int freq_in, unsigned int freq_out)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nstruct rl6231_pll_code pll_code;\r\nint ret;\r\nint mask, shift, val;\r\nif (source == rt5663->pll_src && freq_in == rt5663->pll_in &&\r\nfreq_out == rt5663->pll_out)\r\nreturn 0;\r\nif (!freq_in || !freq_out) {\r\ndev_dbg(codec->dev, "PLL disabled\n");\r\nrt5663->pll_in = 0;\r\nrt5663->pll_out = 0;\r\nsnd_soc_update_bits(codec, RT5663_GLB_CLK,\r\nRT5663_SCLK_SRC_MASK, RT5663_SCLK_SRC_MCLK);\r\nreturn 0;\r\n}\r\nswitch (rt5663->codec_ver) {\r\ncase CODEC_VER_1:\r\nmask = RT5663_V2_PLL1_SRC_MASK;\r\nshift = RT5663_V2_PLL1_SRC_SHIFT;\r\nbreak;\r\ncase CODEC_VER_0:\r\nmask = RT5663_PLL1_SRC_MASK;\r\nshift = RT5663_PLL1_SRC_SHIFT;\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Unknown CODEC Version\n");\r\nreturn -EINVAL;\r\n}\r\nswitch (source) {\r\ncase RT5663_PLL1_S_MCLK:\r\nval = 0x0;\r\nbreak;\r\ncase RT5663_PLL1_S_BCLK1:\r\nval = 0x1;\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Unknown PLL source %d\n", source);\r\nreturn -EINVAL;\r\n}\r\nsnd_soc_update_bits(codec, RT5663_GLB_CLK, mask, (val << shift));\r\nret = rl6231_pll_calc(freq_in, freq_out, &pll_code);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Unsupport input clock %d\n", freq_in);\r\nreturn ret;\r\n}\r\ndev_dbg(codec->dev, "bypass=%d m=%d n=%d k=%d\n", pll_code.m_bp,\r\n(pll_code.m_bp ? 0 : pll_code.m_code), pll_code.n_code,\r\npll_code.k_code);\r\nsnd_soc_write(codec, RT5663_PLL_1,\r\npll_code.n_code << RT5663_PLL_N_SHIFT | pll_code.k_code);\r\nsnd_soc_write(codec, RT5663_PLL_2,\r\n(pll_code.m_bp ? 0 : pll_code.m_code) << RT5663_PLL_M_SHIFT |\r\npll_code.m_bp << RT5663_PLL_M_BP_SHIFT);\r\nrt5663->pll_in = freq_in;\r\nrt5663->pll_out = freq_out;\r\nrt5663->pll_src = source;\r\nreturn 0;\r\n}\r\nstatic int rt5663_set_tdm_slot(struct snd_soc_dai *dai, unsigned int tx_mask,\r\nunsigned int rx_mask, int slots, int slot_width)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int val = 0, reg;\r\nif (rx_mask || tx_mask)\r\nval |= RT5663_TDM_MODE_TDM;\r\nswitch (slots) {\r\ncase 4:\r\nval |= RT5663_TDM_IN_CH_4;\r\nval |= RT5663_TDM_OUT_CH_4;\r\nbreak;\r\ncase 6:\r\nval |= RT5663_TDM_IN_CH_6;\r\nval |= RT5663_TDM_OUT_CH_6;\r\nbreak;\r\ncase 8:\r\nval |= RT5663_TDM_IN_CH_8;\r\nval |= RT5663_TDM_OUT_CH_8;\r\nbreak;\r\ncase 2:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (slot_width) {\r\ncase 20:\r\nval |= RT5663_TDM_IN_LEN_20;\r\nval |= RT5663_TDM_OUT_LEN_20;\r\nbreak;\r\ncase 24:\r\nval |= RT5663_TDM_IN_LEN_24;\r\nval |= RT5663_TDM_OUT_LEN_24;\r\nbreak;\r\ncase 32:\r\nval |= RT5663_TDM_IN_LEN_32;\r\nval |= RT5663_TDM_OUT_LEN_32;\r\nbreak;\r\ncase 16:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (rt5663->codec_ver) {\r\ncase CODEC_VER_1:\r\nreg = RT5663_TDM_2;\r\nbreak;\r\ncase CODEC_VER_0:\r\nreg = RT5663_TDM_1;\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Unknown CODEC Version\n");\r\nreturn -EINVAL;\r\n}\r\nsnd_soc_update_bits(codec, reg, RT5663_TDM_MODE_MASK |\r\nRT5663_TDM_IN_CH_MASK | RT5663_TDM_OUT_CH_MASK |\r\nRT5663_TDM_IN_LEN_MASK | RT5663_TDM_OUT_LEN_MASK, val);\r\nreturn 0;\r\n}\r\nstatic int rt5663_set_bclk_ratio(struct snd_soc_dai *dai, unsigned int ratio)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int reg;\r\ndev_dbg(codec->dev, "%s ratio = %d\n", __func__, ratio);\r\nif (rt5663->codec_ver == CODEC_VER_1)\r\nreg = RT5663_TDM_9;\r\nelse\r\nreg = RT5663_TDM_5;\r\nswitch (ratio) {\r\ncase 32:\r\nsnd_soc_update_bits(codec, reg,\r\nRT5663_TDM_LENGTN_MASK,\r\nRT5663_TDM_LENGTN_16);\r\nbreak;\r\ncase 40:\r\nsnd_soc_update_bits(codec, reg,\r\nRT5663_TDM_LENGTN_MASK,\r\nRT5663_TDM_LENGTN_20);\r\nbreak;\r\ncase 48:\r\nsnd_soc_update_bits(codec, reg,\r\nRT5663_TDM_LENGTN_MASK,\r\nRT5663_TDM_LENGTN_24);\r\nbreak;\r\ncase 64:\r\nsnd_soc_update_bits(codec, reg,\r\nRT5663_TDM_LENGTN_MASK,\r\nRT5663_TDM_LENGTN_32);\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Invalid ratio!\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5663_set_bias_level(struct snd_soc_codec *codec,\r\nenum snd_soc_bias_level level)\r\n{\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nswitch (level) {\r\ncase SND_SOC_BIAS_ON:\r\nsnd_soc_update_bits(codec, RT5663_PWR_ANLG_1,\r\nRT5663_PWR_FV1_MASK | RT5663_PWR_FV2_MASK,\r\nRT5663_PWR_FV1 | RT5663_PWR_FV2);\r\nbreak;\r\ncase SND_SOC_BIAS_PREPARE:\r\nif (rt5663->codec_ver == CODEC_VER_1) {\r\nsnd_soc_update_bits(codec, RT5663_DIG_MISC,\r\nRT5663_DIG_GATE_CTRL_MASK,\r\nRT5663_DIG_GATE_CTRL_EN);\r\nsnd_soc_update_bits(codec, RT5663_SIG_CLK_DET,\r\nRT5663_EN_ANA_CLK_DET_MASK |\r\nRT5663_PWR_CLK_DET_MASK,\r\nRT5663_EN_ANA_CLK_DET_AUTO |\r\nRT5663_PWR_CLK_DET_EN);\r\n}\r\nbreak;\r\ncase SND_SOC_BIAS_STANDBY:\r\nif (rt5663->codec_ver == CODEC_VER_1)\r\nsnd_soc_update_bits(codec, RT5663_DIG_MISC,\r\nRT5663_DIG_GATE_CTRL_MASK,\r\nRT5663_DIG_GATE_CTRL_DIS);\r\nsnd_soc_update_bits(codec, RT5663_PWR_ANLG_1,\r\nRT5663_PWR_VREF1_MASK | RT5663_PWR_VREF2_MASK |\r\nRT5663_PWR_FV1_MASK | RT5663_PWR_FV2_MASK |\r\nRT5663_PWR_MB_MASK, RT5663_PWR_VREF1 |\r\nRT5663_PWR_VREF2 | RT5663_PWR_MB);\r\nusleep_range(10000, 10005);\r\nif (rt5663->codec_ver == CODEC_VER_1) {\r\nsnd_soc_update_bits(codec, RT5663_SIG_CLK_DET,\r\nRT5663_EN_ANA_CLK_DET_MASK |\r\nRT5663_PWR_CLK_DET_MASK,\r\nRT5663_EN_ANA_CLK_DET_DIS |\r\nRT5663_PWR_CLK_DET_DIS);\r\n}\r\nbreak;\r\ncase SND_SOC_BIAS_OFF:\r\nsnd_soc_update_bits(codec, RT5663_PWR_ANLG_1,\r\nRT5663_PWR_VREF1_MASK | RT5663_PWR_VREF2_MASK |\r\nRT5663_PWR_FV1 | RT5663_PWR_FV2, 0x0);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5663_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nrt5663->codec = codec;\r\nswitch (rt5663->codec_ver) {\r\ncase CODEC_VER_1:\r\nsnd_soc_dapm_new_controls(dapm,\r\nrt5663_v2_specific_dapm_widgets,\r\nARRAY_SIZE(rt5663_v2_specific_dapm_widgets));\r\nsnd_soc_dapm_add_routes(dapm,\r\nrt5663_v2_specific_dapm_routes,\r\nARRAY_SIZE(rt5663_v2_specific_dapm_routes));\r\nsnd_soc_add_codec_controls(codec, rt5663_v2_specific_controls,\r\nARRAY_SIZE(rt5663_v2_specific_controls));\r\nbreak;\r\ncase CODEC_VER_0:\r\nsnd_soc_dapm_new_controls(dapm,\r\nrt5663_specific_dapm_widgets,\r\nARRAY_SIZE(rt5663_specific_dapm_widgets));\r\nsnd_soc_dapm_add_routes(dapm,\r\nrt5663_specific_dapm_routes,\r\nARRAY_SIZE(rt5663_specific_dapm_routes));\r\nsnd_soc_add_codec_controls(codec, rt5663_specific_controls,\r\nARRAY_SIZE(rt5663_specific_controls));\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt5663_remove(struct snd_soc_codec *codec)\r\n{\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nregmap_write(rt5663->regmap, RT5663_RESET, 0);\r\nreturn 0;\r\n}\r\nstatic int rt5663_suspend(struct snd_soc_codec *codec)\r\n{\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nregcache_cache_only(rt5663->regmap, true);\r\nregcache_mark_dirty(rt5663->regmap);\r\nreturn 0;\r\n}\r\nstatic int rt5663_resume(struct snd_soc_codec *codec)\r\n{\r\nstruct rt5663_priv *rt5663 = snd_soc_codec_get_drvdata(codec);\r\nregcache_cache_only(rt5663->regmap, false);\r\nregcache_sync(rt5663->regmap);\r\nreturn 0;\r\n}\r\nstatic void rt5663_v2_calibrate(struct rt5663_priv *rt5663)\r\n{\r\nregmap_write(rt5663->regmap, RT5663_BIAS_CUR_8, 0xa402);\r\nregmap_write(rt5663->regmap, RT5663_PWR_DIG_1, 0x0100);\r\nregmap_write(rt5663->regmap, RT5663_RECMIX, 0x4040);\r\nregmap_write(rt5663->regmap, RT5663_DIG_MISC, 0x0001);\r\nregmap_write(rt5663->regmap, RT5663_RC_CLK, 0x0380);\r\nregmap_write(rt5663->regmap, RT5663_GLB_CLK, 0x8000);\r\nregmap_write(rt5663->regmap, RT5663_ADDA_CLK_1, 0x1000);\r\nregmap_write(rt5663->regmap, RT5663_CHOP_DAC_L, 0x3030);\r\nregmap_write(rt5663->regmap, RT5663_CALIB_ADC, 0x3c05);\r\nregmap_write(rt5663->regmap, RT5663_PWR_ANLG_1, 0xa23e);\r\nmsleep(40);\r\nregmap_write(rt5663->regmap, RT5663_PWR_ANLG_1, 0xf23e);\r\nregmap_write(rt5663->regmap, RT5663_HP_CALIB_2, 0x0321);\r\nregmap_write(rt5663->regmap, RT5663_HP_CALIB_1, 0xfc00);\r\nmsleep(500);\r\n}\r\nstatic void rt5663_calibrate(struct rt5663_priv *rt5663)\r\n{\r\nint value, count;\r\nregmap_write(rt5663->regmap, RT5663_RC_CLK, 0x0280);\r\nregmap_write(rt5663->regmap, RT5663_GLB_CLK, 0x8000);\r\nregmap_write(rt5663->regmap, RT5663_DIG_MISC, 0x8001);\r\nregmap_write(rt5663->regmap, RT5663_VREF_RECMIX, 0x0032);\r\nregmap_write(rt5663->regmap, RT5663_PWR_ANLG_1, 0xa2be);\r\nmsleep(20);\r\nregmap_write(rt5663->regmap, RT5663_PWR_ANLG_1, 0xf2be);\r\nregmap_write(rt5663->regmap, RT5663_PWR_DIG_2, 0x8400);\r\nregmap_write(rt5663->regmap, RT5663_CHOP_ADC, 0x3000);\r\nregmap_write(rt5663->regmap, RT5663_DEPOP_1, 0x003b);\r\nregmap_write(rt5663->regmap, RT5663_PWR_DIG_1, 0x8df8);\r\nregmap_write(rt5663->regmap, RT5663_PWR_ANLG_2, 0x0003);\r\nregmap_write(rt5663->regmap, RT5663_PWR_ANLG_3, 0x018c);\r\nregmap_write(rt5663->regmap, RT5663_ADDA_CLK_1, 0x1111);\r\nregmap_write(rt5663->regmap, RT5663_PRE_DIV_GATING_1, 0xffff);\r\nregmap_write(rt5663->regmap, RT5663_PRE_DIV_GATING_2, 0xffff);\r\nregmap_write(rt5663->regmap, RT5663_DEPOP_2, 0x3003);\r\nregmap_write(rt5663->regmap, RT5663_DEPOP_1, 0x003b);\r\nregmap_write(rt5663->regmap, RT5663_HP_CHARGE_PUMP_1, 0x1e32);\r\nregmap_write(rt5663->regmap, RT5663_HP_CHARGE_PUMP_2, 0x1371);\r\nregmap_write(rt5663->regmap, RT5663_DACREF_LDO, 0x3b0b);\r\nregmap_write(rt5663->regmap, RT5663_STO_DAC_MIXER, 0x2080);\r\nregmap_write(rt5663->regmap, RT5663_BYPASS_STO_DAC, 0x000c);\r\nregmap_write(rt5663->regmap, RT5663_HP_BIAS, 0xabba);\r\nregmap_write(rt5663->regmap, RT5663_CHARGE_PUMP_1, 0x2224);\r\nregmap_write(rt5663->regmap, RT5663_HP_OUT_EN, 0x8088);\r\nregmap_write(rt5663->regmap, RT5663_STO_DRE_9, 0x0017);\r\nregmap_write(rt5663->regmap, RT5663_STO_DRE_10, 0x0017);\r\nregmap_write(rt5663->regmap, RT5663_STO1_ADC_MIXER, 0x4040);\r\nregmap_write(rt5663->regmap, RT5663_RECMIX, 0x0005);\r\nregmap_write(rt5663->regmap, RT5663_ADDA_RST, 0xc000);\r\nregmap_write(rt5663->regmap, RT5663_STO1_HPF_ADJ1, 0x3320);\r\nregmap_write(rt5663->regmap, RT5663_HP_CALIB_2, 0x00c9);\r\nregmap_write(rt5663->regmap, RT5663_DUMMY_1, 0x004c);\r\nregmap_write(rt5663->regmap, RT5663_ANA_BIAS_CUR_1, 0x7766);\r\nregmap_write(rt5663->regmap, RT5663_BIAS_CUR_8, 0x4702);\r\nmsleep(200);\r\nregmap_write(rt5663->regmap, RT5663_HP_CALIB_1, 0x0069);\r\nregmap_write(rt5663->regmap, RT5663_HP_CALIB_3, 0x06c2);\r\nregmap_write(rt5663->regmap, RT5663_HP_CALIB_1_1, 0x7b00);\r\nregmap_write(rt5663->regmap, RT5663_HP_CALIB_1_1, 0xfb00);\r\ncount = 0;\r\nwhile (true) {\r\nregmap_read(rt5663->regmap, RT5663_HP_CALIB_1_1, &value);\r\nif (value & 0x8000)\r\nusleep_range(10000, 10005);\r\nelse\r\nbreak;\r\nif (count > 200)\r\nreturn;\r\ncount++;\r\n}\r\n}\r\nstatic int rt5663_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct rt5663_priv *rt5663;\r\nint ret;\r\nunsigned int val;\r\nstruct regmap *regmap;\r\nrt5663 = devm_kzalloc(&i2c->dev, sizeof(struct rt5663_priv),\r\nGFP_KERNEL);\r\nif (rt5663 == NULL)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(i2c, rt5663);\r\nregmap = devm_regmap_init_i2c(i2c, &temp_regmap);\r\nif (IS_ERR(regmap)) {\r\nret = PTR_ERR(regmap);\r\ndev_err(&i2c->dev, "Failed to allocate temp register map: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nregmap_read(regmap, RT5663_VENDOR_ID_2, &val);\r\nswitch (val) {\r\ncase RT5663_DEVICE_ID_2:\r\nrt5663->regmap = devm_regmap_init_i2c(i2c, &rt5663_v2_regmap);\r\nrt5663->codec_ver = CODEC_VER_1;\r\nbreak;\r\ncase RT5663_DEVICE_ID_1:\r\nrt5663->regmap = devm_regmap_init_i2c(i2c, &rt5663_regmap);\r\nrt5663->codec_ver = CODEC_VER_0;\r\nbreak;\r\ndefault:\r\ndev_err(&i2c->dev,\r\n"Device with ID register %#x is not rt5663\n",\r\nval);\r\nreturn -ENODEV;\r\n}\r\nif (IS_ERR(rt5663->regmap)) {\r\nret = PTR_ERR(rt5663->regmap);\r\ndev_err(&i2c->dev, "Failed to allocate register map: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nregmap_write(rt5663->regmap, RT5663_RESET, 0);\r\nregcache_cache_bypass(rt5663->regmap, true);\r\nswitch (rt5663->codec_ver) {\r\ncase CODEC_VER_1:\r\nrt5663_v2_calibrate(rt5663);\r\nbreak;\r\ncase CODEC_VER_0:\r\nrt5663_calibrate(rt5663);\r\nbreak;\r\ndefault:\r\ndev_err(&i2c->dev, "%s:Unknown codec type\n", __func__);\r\n}\r\nregcache_cache_bypass(rt5663->regmap, false);\r\nregmap_write(rt5663->regmap, RT5663_RESET, 0);\r\ndev_dbg(&i2c->dev, "calibrate done\n");\r\nregmap_update_bits(rt5663->regmap, RT5663_GPIO_1, RT5663_GP1_PIN_MASK,\r\nRT5663_GP1_PIN_IRQ);\r\nregmap_update_bits(rt5663->regmap, RT5663_IL_CMD_5,\r\nRT5663_4BTN_CLK_DEB_MASK, RT5663_4BTN_CLK_DEB_65MS);\r\nswitch (rt5663->codec_ver) {\r\ncase CODEC_VER_1:\r\nregmap_write(rt5663->regmap, RT5663_BIAS_CUR_8, 0xa402);\r\nregmap_update_bits(rt5663->regmap, RT5663_AUTO_1MRC_CLK,\r\nRT5663_IRQ_POW_SAV_MASK | RT5663_IRQ_POW_SAV_JD1_MASK,\r\nRT5663_IRQ_POW_SAV_EN | RT5663_IRQ_POW_SAV_JD1_EN);\r\nregmap_update_bits(rt5663->regmap, RT5663_PWR_ANLG_2,\r\nRT5663_PWR_JD1_MASK, RT5663_PWR_JD1);\r\nregmap_update_bits(rt5663->regmap, RT5663_IRQ_1,\r\nRT5663_EN_CB_JD_MASK, RT5663_EN_CB_JD_EN);\r\nregmap_update_bits(rt5663->regmap, RT5663_HP_LOGIC_2,\r\nRT5663_HP_SIG_SRC1_MASK, RT5663_HP_SIG_SRC1_REG);\r\nregmap_update_bits(rt5663->regmap, RT5663_RECMIX,\r\nRT5663_VREF_BIAS_MASK | RT5663_CBJ_DET_MASK |\r\nRT5663_DET_TYPE_MASK, RT5663_VREF_BIAS_REG |\r\nRT5663_CBJ_DET_EN | RT5663_DET_TYPE_QFN);\r\nregmap_update_bits(rt5663->regmap, RT5663_GPIO_2,\r\nRT5663_GP4_PIN_CONF_MASK, RT5663_GP4_PIN_CONF_INPUT);\r\nregmap_update_bits(rt5663->regmap, RT5663_GPIO_3,\r\nRT5663_GP8_PIN_CONF_MASK, RT5663_GP8_PIN_CONF_INPUT);\r\nregmap_update_bits(rt5663->regmap, RT5663_PWR_ANLG_1,\r\nRT5663_LDO1_DVO_MASK | RT5663_AMP_HP_MASK,\r\nRT5663_LDO1_DVO_0_9V | RT5663_AMP_HP_3X);\r\nbreak;\r\ncase CODEC_VER_0:\r\nregmap_update_bits(rt5663->regmap, RT5663_DIG_MISC,\r\nRT5663_DIG_GATE_CTRL_MASK, RT5663_DIG_GATE_CTRL_EN);\r\nregmap_update_bits(rt5663->regmap, RT5663_AUTO_1MRC_CLK,\r\nRT5663_IRQ_POW_SAV_MASK, RT5663_IRQ_POW_SAV_EN);\r\nregmap_update_bits(rt5663->regmap, RT5663_IRQ_1,\r\nRT5663_EN_IRQ_JD1_MASK, RT5663_EN_IRQ_JD1_EN);\r\nregmap_update_bits(rt5663->regmap, RT5663_GPIO_1,\r\nRT5663_GPIO1_TYPE_MASK, RT5663_GPIO1_TYPE_EN);\r\nregmap_write(rt5663->regmap, RT5663_VREF_RECMIX, 0x0032);\r\nregmap_write(rt5663->regmap, RT5663_PWR_ANLG_1, 0xa2be);\r\nmsleep(20);\r\nregmap_write(rt5663->regmap, RT5663_PWR_ANLG_1, 0xf2be);\r\nregmap_update_bits(rt5663->regmap, RT5663_GPIO_2,\r\nRT5663_GP1_PIN_CONF_MASK | RT5663_SEL_GPIO1_MASK,\r\nRT5663_GP1_PIN_CONF_OUTPUT | RT5663_SEL_GPIO1_EN);\r\nregmap_update_bits(rt5663->regmap, RT5663_DACREF_LDO, 0x3e0e,\r\n0x3a0a);\r\nregmap_update_bits(rt5663->regmap, RT5663_RECMIX,\r\nRT5663_RECMIX1_BST1_MASK, RT5663_RECMIX1_BST1_ON);\r\nregmap_update_bits(rt5663->regmap, RT5663_TDM_2,\r\nRT5663_DATA_SWAP_ADCDAT1_MASK,\r\nRT5663_DATA_SWAP_ADCDAT1_LL);\r\nbreak;\r\ndefault:\r\ndev_err(&i2c->dev, "%s:Unknown codec type\n", __func__);\r\n}\r\nINIT_DELAYED_WORK(&rt5663->jack_detect_work, rt5663_jack_detect_work);\r\nif (i2c->irq) {\r\nret = request_irq(i2c->irq, rt5663_irq,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING\r\n| IRQF_ONESHOT, "rt5663", rt5663);\r\nif (ret)\r\ndev_err(&i2c->dev, "%s Failed to reguest IRQ: %d\n",\r\n__func__, ret);\r\n}\r\nret = snd_soc_register_codec(&i2c->dev, &soc_codec_dev_rt5663,\r\nrt5663_dai, ARRAY_SIZE(rt5663_dai));\r\nif (ret) {\r\nif (i2c->irq)\r\nfree_irq(i2c->irq, rt5663);\r\n}\r\nreturn ret;\r\n}\r\nstatic int rt5663_i2c_remove(struct i2c_client *i2c)\r\n{\r\nstruct rt5663_priv *rt5663 = i2c_get_clientdata(i2c);\r\nif (i2c->irq)\r\nfree_irq(i2c->irq, rt5663);\r\nsnd_soc_unregister_codec(&i2c->dev);\r\nreturn 0;\r\n}\r\nstatic void rt5663_i2c_shutdown(struct i2c_client *client)\r\n{\r\nstruct rt5663_priv *rt5663 = i2c_get_clientdata(client);\r\nregmap_write(rt5663->regmap, RT5663_RESET, 0);\r\n}

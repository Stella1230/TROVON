unsigned short pxa2xx_ac97_read(struct snd_ac97 *ac97, unsigned short reg)\r\n{\r\nunsigned short val = -1;\r\nvolatile u32 *reg_addr;\r\nmutex_lock(&car_mutex);\r\nif (cpu_is_pxa25x() && reg == AC97_GPIO_STATUS)\r\nreg_addr = ac97->num ? &SMC_REG_BASE : &PMC_REG_BASE;\r\nelse\r\nreg_addr = ac97->num ? &SAC_REG_BASE : &PAC_REG_BASE;\r\nreg_addr += (reg >> 1);\r\nGSR = GSR_CDONE | GSR_SDONE;\r\ngsr_bits = 0;\r\nval = *reg_addr;\r\nif (reg == AC97_GPIO_STATUS)\r\ngoto out;\r\nif (wait_event_timeout(gsr_wq, (GSR | gsr_bits) & GSR_SDONE, 1) <= 0 &&\r\n!((GSR | gsr_bits) & GSR_SDONE)) {\r\nprintk(KERN_ERR "%s: read error (ac97_reg=%d GSR=%#lx)\n",\r\n__func__, reg, GSR | gsr_bits);\r\nval = -1;\r\ngoto out;\r\n}\r\nGSR = GSR_CDONE | GSR_SDONE;\r\ngsr_bits = 0;\r\nval = *reg_addr;\r\nwait_event_timeout(gsr_wq, (GSR | gsr_bits) & GSR_SDONE, 1);\r\nout: mutex_unlock(&car_mutex);\r\nreturn val;\r\n}\r\nvoid pxa2xx_ac97_write(struct snd_ac97 *ac97, unsigned short reg,\r\nunsigned short val)\r\n{\r\nvolatile u32 *reg_addr;\r\nmutex_lock(&car_mutex);\r\nif (cpu_is_pxa25x() && reg == AC97_GPIO_STATUS)\r\nreg_addr = ac97->num ? &SMC_REG_BASE : &PMC_REG_BASE;\r\nelse\r\nreg_addr = ac97->num ? &SAC_REG_BASE : &PAC_REG_BASE;\r\nreg_addr += (reg >> 1);\r\nGSR = GSR_CDONE | GSR_SDONE;\r\ngsr_bits = 0;\r\n*reg_addr = val;\r\nif (wait_event_timeout(gsr_wq, (GSR | gsr_bits) & GSR_CDONE, 1) <= 0 &&\r\n!((GSR | gsr_bits) & GSR_CDONE))\r\nprintk(KERN_ERR "%s: write error (ac97_reg=%d GSR=%#lx)\n",\r\n__func__, reg, GSR | gsr_bits);\r\nmutex_unlock(&car_mutex);\r\n}\r\nstatic inline void pxa_ac97_warm_pxa25x(void)\r\n{\r\ngsr_bits = 0;\r\nGCR |= GCR_WARM_RST;\r\n}\r\nstatic inline void pxa_ac97_cold_pxa25x(void)\r\n{\r\nGCR &= GCR_COLD_RST;\r\nGCR &= ~GCR_COLD_RST;\r\ngsr_bits = 0;\r\nGCR = GCR_COLD_RST;\r\n}\r\nstatic inline void pxa_ac97_warm_pxa27x(void)\r\n{\r\ngsr_bits = 0;\r\npxa27x_configure_ac97reset(reset_gpio, true);\r\nudelay(10);\r\nGCR |= GCR_WARM_RST;\r\npxa27x_configure_ac97reset(reset_gpio, false);\r\nudelay(500);\r\n}\r\nstatic inline void pxa_ac97_cold_pxa27x(void)\r\n{\r\nGCR &= GCR_COLD_RST;\r\nGCR &= ~GCR_COLD_RST;\r\ngsr_bits = 0;\r\nclk_prepare_enable(ac97conf_clk);\r\nudelay(5);\r\nclk_disable_unprepare(ac97conf_clk);\r\nGCR = GCR_COLD_RST | GCR_WARM_RST;\r\n}\r\nstatic inline void pxa_ac97_warm_pxa3xx(void)\r\n{\r\ngsr_bits = 0;\r\nGCR |= GCR_WARM_RST;\r\n}\r\nstatic inline void pxa_ac97_cold_pxa3xx(void)\r\n{\r\nGCR = 0;\r\nGCR = GCR_CLKBPB;\r\nudelay(100);\r\nGCR = 0;\r\nGCR &= GCR_COLD_RST;\r\nGCR &= ~GCR_COLD_RST;\r\ngsr_bits = 0;\r\nGCR &= ~(GCR_PRIRDY_IEN|GCR_SECRDY_IEN);\r\nGCR = GCR_WARM_RST | GCR_COLD_RST;\r\n}\r\nbool pxa2xx_ac97_try_warm_reset(struct snd_ac97 *ac97)\r\n{\r\nunsigned long gsr;\r\nunsigned int timeout = 100;\r\n#ifdef CONFIG_PXA25x\r\nif (cpu_is_pxa25x())\r\npxa_ac97_warm_pxa25x();\r\nelse\r\n#endif\r\n#ifdef CONFIG_PXA27x\r\nif (cpu_is_pxa27x())\r\npxa_ac97_warm_pxa27x();\r\nelse\r\n#endif\r\n#ifdef CONFIG_PXA3xx\r\nif (cpu_is_pxa3xx())\r\npxa_ac97_warm_pxa3xx();\r\nelse\r\n#endif\r\nsnd_BUG();\r\nwhile (!((GSR | gsr_bits) & (GSR_PCR | GSR_SCR)) && timeout--)\r\nmdelay(1);\r\ngsr = GSR | gsr_bits;\r\nif (!(gsr & (GSR_PCR | GSR_SCR))) {\r\nprintk(KERN_INFO "%s: warm reset timeout (GSR=%#lx)\n",\r\n__func__, gsr);\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nbool pxa2xx_ac97_try_cold_reset(struct snd_ac97 *ac97)\r\n{\r\nunsigned long gsr;\r\nunsigned int timeout = 1000;\r\n#ifdef CONFIG_PXA25x\r\nif (cpu_is_pxa25x())\r\npxa_ac97_cold_pxa25x();\r\nelse\r\n#endif\r\n#ifdef CONFIG_PXA27x\r\nif (cpu_is_pxa27x())\r\npxa_ac97_cold_pxa27x();\r\nelse\r\n#endif\r\n#ifdef CONFIG_PXA3xx\r\nif (cpu_is_pxa3xx())\r\npxa_ac97_cold_pxa3xx();\r\nelse\r\n#endif\r\nsnd_BUG();\r\nwhile (!((GSR | gsr_bits) & (GSR_PCR | GSR_SCR)) && timeout--)\r\nmdelay(1);\r\ngsr = GSR | gsr_bits;\r\nif (!(gsr & (GSR_PCR | GSR_SCR))) {\r\nprintk(KERN_INFO "%s: cold reset timeout (GSR=%#lx)\n",\r\n__func__, gsr);\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nvoid pxa2xx_ac97_finish_reset(struct snd_ac97 *ac97)\r\n{\r\nGCR &= ~(GCR_PRIRDY_IEN|GCR_SECRDY_IEN);\r\nGCR |= GCR_SDONE_IE|GCR_CDONE_IE;\r\n}\r\nstatic irqreturn_t pxa2xx_ac97_irq(int irq, void *dev_id)\r\n{\r\nlong status;\r\nstatus = GSR;\r\nif (status) {\r\nGSR = status;\r\ngsr_bits |= status;\r\nwake_up(&gsr_wq);\r\nif (cpu_is_pxa27x()) {\r\nMISR = MISR_EOC;\r\nPISR = PISR_EOC;\r\nMCSR = MCSR_EOC;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nint pxa2xx_ac97_hw_suspend(void)\r\n{\r\nGCR |= GCR_ACLINK_OFF;\r\nclk_disable_unprepare(ac97_clk);\r\nreturn 0;\r\n}\r\nint pxa2xx_ac97_hw_resume(void)\r\n{\r\nclk_prepare_enable(ac97_clk);\r\nreturn 0;\r\n}\r\nint pxa2xx_ac97_hw_probe(struct platform_device *dev)\r\n{\r\nint ret;\r\npxa2xx_audio_ops_t *pdata = dev->dev.platform_data;\r\nif (pdata) {\r\nswitch (pdata->reset_gpio) {\r\ncase 95:\r\ncase 113:\r\nreset_gpio = pdata->reset_gpio;\r\nbreak;\r\ncase 0:\r\nreset_gpio = 113;\r\nbreak;\r\ncase -1:\r\nbreak;\r\ndefault:\r\ndev_err(&dev->dev, "Invalid reset GPIO %d\n",\r\npdata->reset_gpio);\r\n}\r\n} else {\r\nif (cpu_is_pxa27x())\r\nreset_gpio = 113;\r\n}\r\nif (cpu_is_pxa27x()) {\r\nret = gpio_request_one(reset_gpio, GPIOF_OUT_INIT_HIGH,\r\n"pxa27x ac97 reset");\r\nif (ret < 0) {\r\npr_err("%s: gpio_request_one() failed: %d\n",\r\n__func__, ret);\r\ngoto err_conf;\r\n}\r\npxa27x_configure_ac97reset(reset_gpio, false);\r\nac97conf_clk = clk_get(&dev->dev, "AC97CONFCLK");\r\nif (IS_ERR(ac97conf_clk)) {\r\nret = PTR_ERR(ac97conf_clk);\r\nac97conf_clk = NULL;\r\ngoto err_conf;\r\n}\r\n}\r\nac97_clk = clk_get(&dev->dev, "AC97CLK");\r\nif (IS_ERR(ac97_clk)) {\r\nret = PTR_ERR(ac97_clk);\r\nac97_clk = NULL;\r\ngoto err_clk;\r\n}\r\nret = clk_prepare_enable(ac97_clk);\r\nif (ret)\r\ngoto err_clk2;\r\nret = request_irq(IRQ_AC97, pxa2xx_ac97_irq, 0, "AC97", NULL);\r\nif (ret < 0)\r\ngoto err_irq;\r\nreturn 0;\r\nerr_irq:\r\nGCR |= GCR_ACLINK_OFF;\r\nerr_clk2:\r\nclk_put(ac97_clk);\r\nac97_clk = NULL;\r\nerr_clk:\r\nif (ac97conf_clk) {\r\nclk_put(ac97conf_clk);\r\nac97conf_clk = NULL;\r\n}\r\nerr_conf:\r\nreturn ret;\r\n}\r\nvoid pxa2xx_ac97_hw_remove(struct platform_device *dev)\r\n{\r\nif (cpu_is_pxa27x())\r\ngpio_free(reset_gpio);\r\nGCR |= GCR_ACLINK_OFF;\r\nfree_irq(IRQ_AC97, NULL);\r\nif (ac97conf_clk) {\r\nclk_put(ac97conf_clk);\r\nac97conf_clk = NULL;\r\n}\r\nclk_disable_unprepare(ac97_clk);\r\nclk_put(ac97_clk);\r\nac97_clk = NULL;\r\n}

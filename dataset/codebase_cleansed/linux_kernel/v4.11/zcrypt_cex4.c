static int zcrypt_cex4_card_probe(struct ap_device *ap_dev)\r\n{\r\nstatic const int CEX4A_SPEED_IDX[] = {\r\n5, 6, 59, 20, 115, 581, 0, 0};\r\nstatic const int CEX5A_SPEED_IDX[] = {\r\n3, 3, 6, 8, 32, 218, 0, 0};\r\nstatic const int CEX4C_SPEED_IDX[] = {\r\n24, 25, 82, 41, 138, 1111, 79, 8};\r\nstatic const int CEX5C_SPEED_IDX[] = {\r\n10, 14, 23, 17, 45, 242, 63, 4};\r\nstatic const int CEX4P_SPEED_IDX[] = {\r\n142, 198, 1852, 203, 331, 1563, 0, 8};\r\nstatic const int CEX5P_SPEED_IDX[] = {\r\n49, 67, 131, 52, 85, 287, 0, 4};\r\nstruct ap_card *ac = to_ap_card(&ap_dev->device);\r\nstruct zcrypt_card *zc;\r\nint rc = 0;\r\nzc = zcrypt_card_alloc();\r\nif (!zc)\r\nreturn -ENOMEM;\r\nzc->card = ac;\r\nac->private = zc;\r\nif (ap_test_bit(&ac->functions, AP_FUNC_ACCEL)) {\r\nif (ac->ap_dev.device_type == AP_DEVICE_TYPE_CEX4) {\r\nzc->type_string = "CEX4A";\r\nzc->user_space_type = ZCRYPT_CEX4;\r\nmemcpy(zc->speed_rating, CEX4A_SPEED_IDX,\r\nsizeof(CEX4A_SPEED_IDX));\r\n} else {\r\nzc->type_string = "CEX5A";\r\nzc->user_space_type = ZCRYPT_CEX5;\r\nmemcpy(zc->speed_rating, CEX5A_SPEED_IDX,\r\nsizeof(CEX5A_SPEED_IDX));\r\n}\r\nzc->min_mod_size = CEX4A_MIN_MOD_SIZE;\r\nif (ap_test_bit(&ac->functions, AP_FUNC_MEX4K) &&\r\nap_test_bit(&ac->functions, AP_FUNC_CRT4K)) {\r\nzc->max_mod_size = CEX4A_MAX_MOD_SIZE_4K;\r\nzc->max_exp_bit_length =\r\nCEX4A_MAX_MOD_SIZE_4K;\r\n} else {\r\nzc->max_mod_size = CEX4A_MAX_MOD_SIZE_2K;\r\nzc->max_exp_bit_length =\r\nCEX4A_MAX_MOD_SIZE_2K;\r\n}\r\n} else if (ap_test_bit(&ac->functions, AP_FUNC_COPRO)) {\r\nif (ac->ap_dev.device_type == AP_DEVICE_TYPE_CEX4) {\r\nzc->type_string = "CEX4C";\r\nzc->user_space_type = ZCRYPT_CEX3C;\r\nmemcpy(zc->speed_rating, CEX4C_SPEED_IDX,\r\nsizeof(CEX4C_SPEED_IDX));\r\n} else {\r\nzc->type_string = "CEX5C";\r\nzc->user_space_type = ZCRYPT_CEX3C;\r\nmemcpy(zc->speed_rating, CEX5C_SPEED_IDX,\r\nsizeof(CEX5C_SPEED_IDX));\r\n}\r\nzc->min_mod_size = CEX4C_MIN_MOD_SIZE;\r\nzc->max_mod_size = CEX4C_MAX_MOD_SIZE;\r\nzc->max_exp_bit_length = CEX4C_MAX_MOD_SIZE;\r\n} else if (ap_test_bit(&ac->functions, AP_FUNC_EP11)) {\r\nif (ac->ap_dev.device_type == AP_DEVICE_TYPE_CEX4) {\r\nzc->type_string = "CEX4P";\r\nzc->user_space_type = ZCRYPT_CEX4;\r\nmemcpy(zc->speed_rating, CEX4P_SPEED_IDX,\r\nsizeof(CEX4P_SPEED_IDX));\r\n} else {\r\nzc->type_string = "CEX5P";\r\nzc->user_space_type = ZCRYPT_CEX5;\r\nmemcpy(zc->speed_rating, CEX5P_SPEED_IDX,\r\nsizeof(CEX5P_SPEED_IDX));\r\n}\r\nzc->min_mod_size = CEX4C_MIN_MOD_SIZE;\r\nzc->max_mod_size = CEX4C_MAX_MOD_SIZE;\r\nzc->max_exp_bit_length = CEX4C_MAX_MOD_SIZE;\r\n} else {\r\nzcrypt_card_free(zc);\r\nreturn -ENODEV;\r\n}\r\nzc->online = 1;\r\nrc = zcrypt_card_register(zc);\r\nif (rc) {\r\nac->private = NULL;\r\nzcrypt_card_free(zc);\r\n}\r\nreturn rc;\r\n}\r\nstatic void zcrypt_cex4_card_remove(struct ap_device *ap_dev)\r\n{\r\nstruct zcrypt_card *zc = to_ap_card(&ap_dev->device)->private;\r\nif (zc)\r\nzcrypt_card_unregister(zc);\r\n}\r\nstatic int zcrypt_cex4_queue_probe(struct ap_device *ap_dev)\r\n{\r\nstruct ap_queue *aq = to_ap_queue(&ap_dev->device);\r\nstruct zcrypt_queue *zq;\r\nint rc;\r\nif (ap_test_bit(&aq->card->functions, AP_FUNC_ACCEL)) {\r\nzq = zcrypt_queue_alloc(CEX4A_MAX_MESSAGE_SIZE);\r\nif (!zq)\r\nreturn -ENOMEM;\r\nzq->ops = zcrypt_msgtype(MSGTYPE50_NAME,\r\nMSGTYPE50_VARIANT_DEFAULT);\r\n} else if (ap_test_bit(&aq->card->functions, AP_FUNC_COPRO)) {\r\nzq = zcrypt_queue_alloc(CEX4C_MAX_MESSAGE_SIZE);\r\nif (!zq)\r\nreturn -ENOMEM;\r\nzq->ops = zcrypt_msgtype(MSGTYPE06_NAME,\r\nMSGTYPE06_VARIANT_DEFAULT);\r\n} else if (ap_test_bit(&aq->card->functions, AP_FUNC_EP11)) {\r\nzq = zcrypt_queue_alloc(CEX4C_MAX_MESSAGE_SIZE);\r\nif (!zq)\r\nreturn -ENOMEM;\r\nzq->ops = zcrypt_msgtype(MSGTYPE06_NAME,\r\nMSGTYPE06_VARIANT_EP11);\r\n} else {\r\nreturn -ENODEV;\r\n}\r\nzq->queue = aq;\r\nzq->online = 1;\r\natomic_set(&zq->load, 0);\r\nap_queue_init_reply(aq, &zq->reply);\r\naq->request_timeout = CEX4_CLEANUP_TIME,\r\naq->private = zq;\r\nrc = zcrypt_queue_register(zq);\r\nif (rc) {\r\naq->private = NULL;\r\nzcrypt_queue_free(zq);\r\n}\r\nreturn rc;\r\n}\r\nstatic void zcrypt_cex4_queue_remove(struct ap_device *ap_dev)\r\n{\r\nstruct ap_queue *aq = to_ap_queue(&ap_dev->device);\r\nstruct zcrypt_queue *zq = aq->private;\r\nap_queue_remove(aq);\r\nif (zq)\r\nzcrypt_queue_unregister(zq);\r\n}\r\nint __init zcrypt_cex4_init(void)\r\n{\r\nint rc;\r\nrc = ap_driver_register(&zcrypt_cex4_card_driver,\r\nTHIS_MODULE, "cex4card");\r\nif (rc)\r\nreturn rc;\r\nrc = ap_driver_register(&zcrypt_cex4_queue_driver,\r\nTHIS_MODULE, "cex4queue");\r\nif (rc)\r\nap_driver_unregister(&zcrypt_cex4_card_driver);\r\nreturn rc;\r\n}\r\nvoid __exit zcrypt_cex4_exit(void)\r\n{\r\nap_driver_unregister(&zcrypt_cex4_queue_driver);\r\nap_driver_unregister(&zcrypt_cex4_card_driver);\r\n}

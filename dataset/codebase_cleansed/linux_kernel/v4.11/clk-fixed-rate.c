static unsigned long clk_fixed_rate_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nreturn to_clk_fixed_rate(hw)->fixed_rate;\r\n}\r\nstatic unsigned long clk_fixed_rate_recalc_accuracy(struct clk_hw *hw,\r\nunsigned long parent_accuracy)\r\n{\r\nreturn to_clk_fixed_rate(hw)->fixed_accuracy;\r\n}\r\nstruct clk_hw *clk_hw_register_fixed_rate_with_accuracy(struct device *dev,\r\nconst char *name, const char *parent_name, unsigned long flags,\r\nunsigned long fixed_rate, unsigned long fixed_accuracy)\r\n{\r\nstruct clk_fixed_rate *fixed;\r\nstruct clk_hw *hw;\r\nstruct clk_init_data init;\r\nint ret;\r\nfixed = kzalloc(sizeof(*fixed), GFP_KERNEL);\r\nif (!fixed)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.ops = &clk_fixed_rate_ops;\r\ninit.flags = flags | CLK_IS_BASIC;\r\ninit.parent_names = (parent_name ? &parent_name: NULL);\r\ninit.num_parents = (parent_name ? 1 : 0);\r\nfixed->fixed_rate = fixed_rate;\r\nfixed->fixed_accuracy = fixed_accuracy;\r\nfixed->hw.init = &init;\r\nhw = &fixed->hw;\r\nret = clk_hw_register(dev, hw);\r\nif (ret) {\r\nkfree(fixed);\r\nhw = ERR_PTR(ret);\r\n}\r\nreturn hw;\r\n}\r\nstruct clk *clk_register_fixed_rate_with_accuracy(struct device *dev,\r\nconst char *name, const char *parent_name, unsigned long flags,\r\nunsigned long fixed_rate, unsigned long fixed_accuracy)\r\n{\r\nstruct clk_hw *hw;\r\nhw = clk_hw_register_fixed_rate_with_accuracy(dev, name, parent_name,\r\nflags, fixed_rate, fixed_accuracy);\r\nif (IS_ERR(hw))\r\nreturn ERR_CAST(hw);\r\nreturn hw->clk;\r\n}\r\nstruct clk_hw *clk_hw_register_fixed_rate(struct device *dev, const char *name,\r\nconst char *parent_name, unsigned long flags,\r\nunsigned long fixed_rate)\r\n{\r\nreturn clk_hw_register_fixed_rate_with_accuracy(dev, name, parent_name,\r\nflags, fixed_rate, 0);\r\n}\r\nstruct clk *clk_register_fixed_rate(struct device *dev, const char *name,\r\nconst char *parent_name, unsigned long flags,\r\nunsigned long fixed_rate)\r\n{\r\nreturn clk_register_fixed_rate_with_accuracy(dev, name, parent_name,\r\nflags, fixed_rate, 0);\r\n}\r\nvoid clk_unregister_fixed_rate(struct clk *clk)\r\n{\r\nstruct clk_hw *hw;\r\nhw = __clk_get_hw(clk);\r\nif (!hw)\r\nreturn;\r\nclk_unregister(clk);\r\nkfree(to_clk_fixed_rate(hw));\r\n}\r\nvoid clk_hw_unregister_fixed_rate(struct clk_hw *hw)\r\n{\r\nstruct clk_fixed_rate *fixed;\r\nfixed = to_clk_fixed_rate(hw);\r\nclk_hw_unregister(hw);\r\nkfree(fixed);\r\n}\r\nstatic struct clk *_of_fixed_clk_setup(struct device_node *node)\r\n{\r\nstruct clk *clk;\r\nconst char *clk_name = node->name;\r\nu32 rate;\r\nu32 accuracy = 0;\r\nint ret;\r\nif (of_property_read_u32(node, "clock-frequency", &rate))\r\nreturn ERR_PTR(-EIO);\r\nof_property_read_u32(node, "clock-accuracy", &accuracy);\r\nof_property_read_string(node, "clock-output-names", &clk_name);\r\nclk = clk_register_fixed_rate_with_accuracy(NULL, clk_name, NULL,\r\n0, rate, accuracy);\r\nif (IS_ERR(clk))\r\nreturn clk;\r\nret = of_clk_add_provider(node, of_clk_src_simple_get, clk);\r\nif (ret) {\r\nclk_unregister(clk);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn clk;\r\n}\r\nvoid __init of_fixed_clk_setup(struct device_node *node)\r\n{\r\n_of_fixed_clk_setup(node);\r\n}\r\nstatic int of_fixed_clk_remove(struct platform_device *pdev)\r\n{\r\nstruct clk *clk = platform_get_drvdata(pdev);\r\nclk_unregister_fixed_rate(clk);\r\nreturn 0;\r\n}\r\nstatic int of_fixed_clk_probe(struct platform_device *pdev)\r\n{\r\nstruct clk *clk;\r\nclk = _of_fixed_clk_setup(pdev->dev.of_node);\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nplatform_set_drvdata(pdev, clk);\r\nreturn 0;\r\n}

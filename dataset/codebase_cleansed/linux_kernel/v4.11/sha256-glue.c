static int sha256_update(struct shash_desc *desc, const u8 *data,\r\nunsigned int len)\r\n{\r\nreturn sha256_base_do_update(desc, data, len,\r\n(sha256_block_fn *)sha256_block_data_order);\r\n}\r\nstatic int sha256_finup(struct shash_desc *desc, const u8 *data,\r\nunsigned int len, u8 *out)\r\n{\r\nif (len)\r\nsha256_base_do_update(desc, data, len,\r\n(sha256_block_fn *)sha256_block_data_order);\r\nsha256_base_do_finalize(desc,\r\n(sha256_block_fn *)sha256_block_data_order);\r\nreturn sha256_base_finish(desc, out);\r\n}\r\nstatic int sha256_final(struct shash_desc *desc, u8 *out)\r\n{\r\nreturn sha256_finup(desc, NULL, 0, out);\r\n}\r\nstatic int sha256_update_neon(struct shash_desc *desc, const u8 *data,\r\nunsigned int len)\r\n{\r\nif (!may_use_simd())\r\nreturn sha256_base_do_update(desc, data, len,\r\n(sha256_block_fn *)sha256_block_data_order);\r\nkernel_neon_begin();\r\nsha256_base_do_update(desc, data, len,\r\n(sha256_block_fn *)sha256_block_neon);\r\nkernel_neon_end();\r\nreturn 0;\r\n}\r\nstatic int sha256_finup_neon(struct shash_desc *desc, const u8 *data,\r\nunsigned int len, u8 *out)\r\n{\r\nif (!may_use_simd()) {\r\nif (len)\r\nsha256_base_do_update(desc, data, len,\r\n(sha256_block_fn *)sha256_block_data_order);\r\nsha256_base_do_finalize(desc,\r\n(sha256_block_fn *)sha256_block_data_order);\r\n} else {\r\nkernel_neon_begin();\r\nif (len)\r\nsha256_base_do_update(desc, data, len,\r\n(sha256_block_fn *)sha256_block_neon);\r\nsha256_base_do_finalize(desc,\r\n(sha256_block_fn *)sha256_block_neon);\r\nkernel_neon_end();\r\n}\r\nreturn sha256_base_finish(desc, out);\r\n}\r\nstatic int sha256_final_neon(struct shash_desc *desc, u8 *out)\r\n{\r\nreturn sha256_finup_neon(desc, NULL, 0, out);\r\n}\r\nstatic int __init sha256_mod_init(void)\r\n{\r\nint ret = crypto_register_shashes(algs, ARRAY_SIZE(algs));\r\nif (ret)\r\nreturn ret;\r\nif (elf_hwcap & HWCAP_ASIMD) {\r\nret = crypto_register_shashes(neon_algs, ARRAY_SIZE(neon_algs));\r\nif (ret)\r\ncrypto_unregister_shashes(algs, ARRAY_SIZE(algs));\r\n}\r\nreturn ret;\r\n}\r\nstatic void __exit sha256_mod_fini(void)\r\n{\r\nif (elf_hwcap & HWCAP_ASIMD)\r\ncrypto_unregister_shashes(neon_algs, ARRAY_SIZE(neon_algs));\r\ncrypto_unregister_shashes(algs, ARRAY_SIZE(algs));\r\n}

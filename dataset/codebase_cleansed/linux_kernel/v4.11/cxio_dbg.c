void cxio_dump_tpt(struct cxio_rdev *rdev, u32 stag)\r\n{\r\nstruct ch_mem_range *m;\r\nu64 *data;\r\nint rc;\r\nint size = 32;\r\nm = kmalloc(sizeof(*m) + size, GFP_ATOMIC);\r\nif (!m)\r\nreturn;\r\nm->mem_id = MEM_PMRX;\r\nm->addr = (stag>>8) * 32 + rdev->rnic_info.tpt_base;\r\nm->len = size;\r\nPDBG("%s TPT addr 0x%x len %d\n", __func__, m->addr, m->len);\r\nrc = rdev->t3cdev_p->ctl(rdev->t3cdev_p, RDMA_GET_MEM, m);\r\nif (rc) {\r\nPDBG("%s toectl returned error %d\n", __func__, rc);\r\nkfree(m);\r\nreturn;\r\n}\r\ndata = (u64 *)m->buf;\r\nwhile (size > 0) {\r\nPDBG("TPT %08x: %016llx\n", m->addr, (unsigned long long) *data);\r\nsize -= 8;\r\ndata++;\r\nm->addr += 8;\r\n}\r\nkfree(m);\r\n}\r\nvoid cxio_dump_pbl(struct cxio_rdev *rdev, u32 pbl_addr, uint len, u8 shift)\r\n{\r\nstruct ch_mem_range *m;\r\nu64 *data;\r\nint rc;\r\nint size, npages;\r\nshift += 12;\r\nnpages = (len + (1ULL << shift) - 1) >> shift;\r\nsize = npages * sizeof(u64);\r\nm = kmalloc(sizeof(*m) + size, GFP_ATOMIC);\r\nif (!m)\r\nreturn;\r\nm->mem_id = MEM_PMRX;\r\nm->addr = pbl_addr;\r\nm->len = size;\r\nPDBG("%s PBL addr 0x%x len %d depth %d\n",\r\n__func__, m->addr, m->len, npages);\r\nrc = rdev->t3cdev_p->ctl(rdev->t3cdev_p, RDMA_GET_MEM, m);\r\nif (rc) {\r\nPDBG("%s toectl returned error %d\n", __func__, rc);\r\nkfree(m);\r\nreturn;\r\n}\r\ndata = (u64 *)m->buf;\r\nwhile (size > 0) {\r\nPDBG("PBL %08x: %016llx\n", m->addr, (unsigned long long) *data);\r\nsize -= 8;\r\ndata++;\r\nm->addr += 8;\r\n}\r\nkfree(m);\r\n}\r\nvoid cxio_dump_wqe(union t3_wr *wqe)\r\n{\r\n__be64 *data = (__be64 *)wqe;\r\nuint size = (uint)(be64_to_cpu(*data) & 0xff);\r\nif (size == 0)\r\nsize = 8;\r\nwhile (size > 0) {\r\nPDBG("WQE %p: %016llx\n", data,\r\n(unsigned long long) be64_to_cpu(*data));\r\nsize--;\r\ndata++;\r\n}\r\n}\r\nvoid cxio_dump_wce(struct t3_cqe *wce)\r\n{\r\n__be64 *data = (__be64 *)wce;\r\nint size = sizeof(*wce);\r\nwhile (size > 0) {\r\nPDBG("WCE %p: %016llx\n", data,\r\n(unsigned long long) be64_to_cpu(*data));\r\nsize -= 8;\r\ndata++;\r\n}\r\n}\r\nvoid cxio_dump_rqt(struct cxio_rdev *rdev, u32 hwtid, int nents)\r\n{\r\nstruct ch_mem_range *m;\r\nint size = nents * 64;\r\nu64 *data;\r\nint rc;\r\nm = kmalloc(sizeof(*m) + size, GFP_ATOMIC);\r\nif (!m)\r\nreturn;\r\nm->mem_id = MEM_PMRX;\r\nm->addr = ((hwtid)<<10) + rdev->rnic_info.rqt_base;\r\nm->len = size;\r\nPDBG("%s RQT addr 0x%x len %d\n", __func__, m->addr, m->len);\r\nrc = rdev->t3cdev_p->ctl(rdev->t3cdev_p, RDMA_GET_MEM, m);\r\nif (rc) {\r\nPDBG("%s toectl returned error %d\n", __func__, rc);\r\nkfree(m);\r\nreturn;\r\n}\r\ndata = (u64 *)m->buf;\r\nwhile (size > 0) {\r\nPDBG("RQT %08x: %016llx\n", m->addr, (unsigned long long) *data);\r\nsize -= 8;\r\ndata++;\r\nm->addr += 8;\r\n}\r\nkfree(m);\r\n}\r\nvoid cxio_dump_tcb(struct cxio_rdev *rdev, u32 hwtid)\r\n{\r\nstruct ch_mem_range *m;\r\nint size = TCB_SIZE;\r\nu32 *data;\r\nint rc;\r\nm = kmalloc(sizeof(*m) + size, GFP_ATOMIC);\r\nif (!m)\r\nreturn;\r\nm->mem_id = MEM_CM;\r\nm->addr = hwtid * size;\r\nm->len = size;\r\nPDBG("%s TCB %d len %d\n", __func__, m->addr, m->len);\r\nrc = rdev->t3cdev_p->ctl(rdev->t3cdev_p, RDMA_GET_MEM, m);\r\nif (rc) {\r\nPDBG("%s toectl returned error %d\n", __func__, rc);\r\nkfree(m);\r\nreturn;\r\n}\r\ndata = (u32 *)m->buf;\r\nwhile (size > 0) {\r\nprintk("%2u: %08x %08x %08x %08x %08x %08x %08x %08x\n",\r\nm->addr,\r\n*(data+2), *(data+3), *(data),*(data+1),\r\n*(data+6), *(data+7), *(data+4), *(data+5));\r\nsize -= 32;\r\ndata += 8;\r\nm->addr += 32;\r\n}\r\nkfree(m);\r\n}

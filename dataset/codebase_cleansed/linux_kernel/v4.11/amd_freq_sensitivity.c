static unsigned int amd_powersave_bias_target(struct cpufreq_policy *policy,\r\nunsigned int freq_next,\r\nunsigned int relation)\r\n{\r\nint sensitivity;\r\nlong d_actual, d_reference;\r\nstruct msr actual, reference;\r\nstruct cpu_data_t *data = &per_cpu(cpu_data, policy->cpu);\r\nstruct policy_dbs_info *policy_dbs = policy->governor_data;\r\nstruct dbs_data *od_data = policy_dbs->dbs_data;\r\nstruct od_dbs_tuners *od_tuners = od_data->tuners;\r\nif (!policy->freq_table)\r\nreturn freq_next;\r\nrdmsr_on_cpu(policy->cpu, MSR_AMD64_FREQ_SENSITIVITY_ACTUAL,\r\n&actual.l, &actual.h);\r\nrdmsr_on_cpu(policy->cpu, MSR_AMD64_FREQ_SENSITIVITY_REFERENCE,\r\n&reference.l, &reference.h);\r\nactual.h &= 0x00ffffff;\r\nreference.h &= 0x00ffffff;\r\nif (actual.q < data->actual || reference.q < data->reference) {\r\nfreq_next = policy->cur;\r\ngoto out;\r\n}\r\nd_actual = actual.q - data->actual;\r\nd_reference = reference.q - data->reference;\r\nif (d_reference == 0) {\r\nfreq_next = policy->cur;\r\ngoto out;\r\n}\r\nsensitivity = POWERSAVE_BIAS_MAX -\r\n(POWERSAVE_BIAS_MAX * (d_reference - d_actual) / d_reference);\r\nclamp(sensitivity, 0, POWERSAVE_BIAS_MAX);\r\nif (sensitivity < od_tuners->powersave_bias) {\r\nif (data->freq_prev == policy->cur)\r\nfreq_next = policy->cur;\r\nif (freq_next > policy->cur)\r\nfreq_next = policy->cur;\r\nelse if (freq_next < policy->cur)\r\nfreq_next = policy->min;\r\nelse {\r\nunsigned int index;\r\nindex = cpufreq_table_find_index_h(policy,\r\npolicy->cur - 1);\r\nfreq_next = policy->freq_table[index].frequency;\r\n}\r\ndata->freq_prev = freq_next;\r\n} else\r\ndata->freq_prev = 0;\r\nout:\r\ndata->actual = actual.q;\r\ndata->reference = reference.q;\r\nreturn freq_next;\r\n}\r\nstatic int __init amd_freq_sensitivity_init(void)\r\n{\r\nu64 val;\r\nif (boot_cpu_data.x86_vendor != X86_VENDOR_AMD)\r\nreturn -ENODEV;\r\nif (!static_cpu_has(X86_FEATURE_PROC_FEEDBACK))\r\nreturn -ENODEV;\r\nif (rdmsrl_safe(MSR_AMD64_FREQ_SENSITIVITY_ACTUAL, &val))\r\nreturn -ENODEV;\r\nif (!(val >> CLASS_CODE_SHIFT))\r\nreturn -ENODEV;\r\nod_register_powersave_bias_handler(amd_powersave_bias_target,\r\nPOWERSAVE_BIAS_DEF);\r\nreturn 0;\r\n}\r\nstatic void __exit amd_freq_sensitivity_exit(void)\r\n{\r\nod_unregister_powersave_bias_handler();\r\n}

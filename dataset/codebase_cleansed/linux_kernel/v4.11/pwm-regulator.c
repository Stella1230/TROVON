static void pwm_regulator_init_state(struct regulator_dev *rdev)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(rdev);\r\nstruct pwm_state pwm_state;\r\nunsigned int dutycycle;\r\nint i;\r\npwm_get_state(drvdata->pwm, &pwm_state);\r\ndutycycle = pwm_get_relative_duty_cycle(&pwm_state, 100);\r\nfor (i = 0; i < rdev->desc->n_voltages; i++) {\r\nif (dutycycle == drvdata->duty_cycle_table[i].dutycycle) {\r\ndrvdata->state = i;\r\nreturn;\r\n}\r\n}\r\n}\r\nstatic int pwm_regulator_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(rdev);\r\nif (drvdata->state < 0)\r\npwm_regulator_init_state(rdev);\r\nreturn drvdata->state;\r\n}\r\nstatic int pwm_regulator_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(rdev);\r\nstruct pwm_state pstate;\r\nint ret;\r\npwm_init_state(drvdata->pwm, &pstate);\r\npwm_set_relative_duty_cycle(&pstate,\r\ndrvdata->duty_cycle_table[selector].dutycycle, 100);\r\nret = pwm_apply_state(drvdata->pwm, &pstate);\r\nif (ret) {\r\ndev_err(&rdev->dev, "Failed to configure PWM: %d\n", ret);\r\nreturn ret;\r\n}\r\ndrvdata->state = selector;\r\nreturn 0;\r\n}\r\nstatic int pwm_regulator_list_voltage(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(rdev);\r\nif (selector >= rdev->desc->n_voltages)\r\nreturn -EINVAL;\r\nreturn drvdata->duty_cycle_table[selector].uV;\r\n}\r\nstatic int pwm_regulator_enable(struct regulator_dev *dev)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(dev);\r\nif (drvdata->enb_gpio)\r\ngpiod_set_value_cansleep(drvdata->enb_gpio, 1);\r\nreturn pwm_enable(drvdata->pwm);\r\n}\r\nstatic int pwm_regulator_disable(struct regulator_dev *dev)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(dev);\r\npwm_disable(drvdata->pwm);\r\nif (drvdata->enb_gpio)\r\ngpiod_set_value_cansleep(drvdata->enb_gpio, 0);\r\nreturn 0;\r\n}\r\nstatic int pwm_regulator_is_enabled(struct regulator_dev *dev)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(dev);\r\nif (drvdata->enb_gpio && !gpiod_get_value_cansleep(drvdata->enb_gpio))\r\nreturn false;\r\nreturn pwm_is_enabled(drvdata->pwm);\r\n}\r\nstatic int pwm_regulator_get_voltage(struct regulator_dev *rdev)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(rdev);\r\nunsigned int min_uV_duty = drvdata->continuous.min_uV_dutycycle;\r\nunsigned int max_uV_duty = drvdata->continuous.max_uV_dutycycle;\r\nunsigned int duty_unit = drvdata->continuous.dutycycle_unit;\r\nint min_uV = rdev->constraints->min_uV;\r\nint max_uV = rdev->constraints->max_uV;\r\nint diff_uV = max_uV - min_uV;\r\nstruct pwm_state pstate;\r\nunsigned int diff_duty;\r\nunsigned int voltage;\r\npwm_get_state(drvdata->pwm, &pstate);\r\nvoltage = pwm_get_relative_duty_cycle(&pstate, duty_unit);\r\nif (max_uV_duty < min_uV_duty) {\r\nvoltage = min_uV_duty - voltage;\r\ndiff_duty = min_uV_duty - max_uV_duty;\r\n} else {\r\nvoltage = voltage - min_uV_duty;\r\ndiff_duty = max_uV_duty - min_uV_duty;\r\n}\r\nvoltage = DIV_ROUND_CLOSEST_ULL((u64)voltage * diff_uV, diff_duty);\r\nreturn voltage + min_uV;\r\n}\r\nstatic int pwm_regulator_set_voltage(struct regulator_dev *rdev,\r\nint req_min_uV, int req_max_uV,\r\nunsigned int *selector)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(rdev);\r\nunsigned int min_uV_duty = drvdata->continuous.min_uV_dutycycle;\r\nunsigned int max_uV_duty = drvdata->continuous.max_uV_dutycycle;\r\nunsigned int duty_unit = drvdata->continuous.dutycycle_unit;\r\nint min_uV = rdev->constraints->min_uV;\r\nint max_uV = rdev->constraints->max_uV;\r\nint diff_uV = max_uV - min_uV;\r\nstruct pwm_state pstate;\r\nunsigned int diff_duty;\r\nunsigned int dutycycle;\r\nint ret;\r\npwm_init_state(drvdata->pwm, &pstate);\r\nif (max_uV_duty < min_uV_duty)\r\ndiff_duty = min_uV_duty - max_uV_duty;\r\nelse\r\ndiff_duty = max_uV_duty - min_uV_duty;\r\ndutycycle = DIV_ROUND_CLOSEST_ULL((u64)(req_min_uV - min_uV) *\r\ndiff_duty,\r\ndiff_uV);\r\nif (max_uV_duty < min_uV_duty)\r\ndutycycle = min_uV_duty - dutycycle;\r\nelse\r\ndutycycle = min_uV_duty + dutycycle;\r\npwm_set_relative_duty_cycle(&pstate, dutycycle, duty_unit);\r\nret = pwm_apply_state(drvdata->pwm, &pstate);\r\nif (ret) {\r\ndev_err(&rdev->dev, "Failed to configure PWM: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pwm_regulator_init_table(struct platform_device *pdev,\r\nstruct pwm_regulator_data *drvdata)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct pwm_voltages *duty_cycle_table;\r\nunsigned int length = 0;\r\nint ret;\r\nof_find_property(np, "voltage-table", &length);\r\nif ((length < sizeof(*duty_cycle_table)) ||\r\n(length % sizeof(*duty_cycle_table))) {\r\ndev_err(&pdev->dev, "voltage-table length(%d) is invalid\n",\r\nlength);\r\nreturn -EINVAL;\r\n}\r\nduty_cycle_table = devm_kzalloc(&pdev->dev, length, GFP_KERNEL);\r\nif (!duty_cycle_table)\r\nreturn -ENOMEM;\r\nret = of_property_read_u32_array(np, "voltage-table",\r\n(u32 *)duty_cycle_table,\r\nlength / sizeof(u32));\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to read voltage-table: %d\n", ret);\r\nreturn ret;\r\n}\r\ndrvdata->state = -EINVAL;\r\ndrvdata->duty_cycle_table = duty_cycle_table;\r\nmemcpy(&drvdata->ops, &pwm_regulator_voltage_table_ops,\r\nsizeof(drvdata->ops));\r\ndrvdata->desc.ops = &drvdata->ops;\r\ndrvdata->desc.n_voltages = length / sizeof(*duty_cycle_table);\r\nreturn 0;\r\n}\r\nstatic int pwm_regulator_init_continuous(struct platform_device *pdev,\r\nstruct pwm_regulator_data *drvdata)\r\n{\r\nu32 dutycycle_range[2] = { 0, 100 };\r\nu32 dutycycle_unit = 100;\r\nmemcpy(&drvdata->ops, &pwm_regulator_voltage_continuous_ops,\r\nsizeof(drvdata->ops));\r\ndrvdata->desc.ops = &drvdata->ops;\r\ndrvdata->desc.continuous_voltage_range = true;\r\nof_property_read_u32_array(pdev->dev.of_node,\r\n"pwm-dutycycle-range",\r\ndutycycle_range, 2);\r\nof_property_read_u32(pdev->dev.of_node, "pwm-dutycycle-unit",\r\n&dutycycle_unit);\r\nif (dutycycle_range[0] > dutycycle_unit ||\r\ndutycycle_range[1] > dutycycle_unit)\r\nreturn -EINVAL;\r\ndrvdata->continuous.dutycycle_unit = dutycycle_unit;\r\ndrvdata->continuous.min_uV_dutycycle = dutycycle_range[0];\r\ndrvdata->continuous.max_uV_dutycycle = dutycycle_range[1];\r\nreturn 0;\r\n}\r\nstatic int pwm_regulator_probe(struct platform_device *pdev)\r\n{\r\nconst struct regulator_init_data *init_data;\r\nstruct pwm_regulator_data *drvdata;\r\nstruct regulator_dev *regulator;\r\nstruct regulator_config config = { };\r\nstruct device_node *np = pdev->dev.of_node;\r\nenum gpiod_flags gpio_flags;\r\nint ret;\r\nif (!np) {\r\ndev_err(&pdev->dev, "Device Tree node missing\n");\r\nreturn -EINVAL;\r\n}\r\ndrvdata = devm_kzalloc(&pdev->dev, sizeof(*drvdata), GFP_KERNEL);\r\nif (!drvdata)\r\nreturn -ENOMEM;\r\nmemcpy(&drvdata->desc, &pwm_regulator_desc, sizeof(drvdata->desc));\r\nif (of_find_property(np, "voltage-table", NULL))\r\nret = pwm_regulator_init_table(pdev, drvdata);\r\nelse\r\nret = pwm_regulator_init_continuous(pdev, drvdata);\r\nif (ret)\r\nreturn ret;\r\ninit_data = of_get_regulator_init_data(&pdev->dev, np,\r\n&drvdata->desc);\r\nif (!init_data)\r\nreturn -ENOMEM;\r\nconfig.of_node = np;\r\nconfig.dev = &pdev->dev;\r\nconfig.driver_data = drvdata;\r\nconfig.init_data = init_data;\r\ndrvdata->pwm = devm_pwm_get(&pdev->dev, NULL);\r\nif (IS_ERR(drvdata->pwm)) {\r\nret = PTR_ERR(drvdata->pwm);\r\ndev_err(&pdev->dev, "Failed to get PWM: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (init_data->constraints.boot_on || init_data->constraints.always_on)\r\ngpio_flags = GPIOD_OUT_HIGH;\r\nelse\r\ngpio_flags = GPIOD_OUT_LOW;\r\ndrvdata->enb_gpio = devm_gpiod_get_optional(&pdev->dev, "enable",\r\ngpio_flags);\r\nif (IS_ERR(drvdata->enb_gpio)) {\r\nret = PTR_ERR(drvdata->enb_gpio);\r\ndev_err(&pdev->dev, "Failed to get enable GPIO: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = pwm_adjust_config(drvdata->pwm);\r\nif (ret)\r\nreturn ret;\r\nregulator = devm_regulator_register(&pdev->dev,\r\n&drvdata->desc, &config);\r\nif (IS_ERR(regulator)) {\r\nret = PTR_ERR(regulator);\r\ndev_err(&pdev->dev, "Failed to register regulator %s: %d\n",\r\ndrvdata->desc.name, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

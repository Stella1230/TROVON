int mtk_mdp_comp_get_id(struct device *dev, struct device_node *node,\r\nenum mtk_mdp_comp_type comp_type)\r\n{\r\nint id = of_alias_get_id(node, mtk_mdp_comp_stem[comp_type]);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(mtk_mdp_matches); i++) {\r\nif (comp_type == mtk_mdp_matches[i].type &&\r\nid == mtk_mdp_matches[i].alias_id)\r\nreturn i;\r\n}\r\ndev_err(dev, "Failed to get id. type: %d, id: %d\n", comp_type, id);\r\nreturn -EINVAL;\r\n}\r\nvoid mtk_mdp_comp_clock_on(struct device *dev, struct mtk_mdp_comp *comp)\r\n{\r\nint i, err;\r\nif (comp->larb_dev) {\r\nerr = mtk_smi_larb_get(comp->larb_dev);\r\nif (err)\r\ndev_err(dev,\r\n"failed to get larb, err %d. type:%d id:%d\n",\r\nerr, comp->type, comp->id);\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(comp->clk); i++) {\r\nif (!comp->clk[i])\r\ncontinue;\r\nerr = clk_prepare_enable(comp->clk[i]);\r\nif (err)\r\ndev_err(dev,\r\n"failed to enable clock, err %d. type:%d id:%d i:%d\n",\r\nerr, comp->type, comp->id, i);\r\n}\r\n}\r\nvoid mtk_mdp_comp_clock_off(struct device *dev, struct mtk_mdp_comp *comp)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(comp->clk); i++) {\r\nif (!comp->clk[i])\r\ncontinue;\r\nclk_disable_unprepare(comp->clk[i]);\r\n}\r\nif (comp->larb_dev)\r\nmtk_smi_larb_put(comp->larb_dev);\r\n}\r\nint mtk_mdp_comp_init(struct device *dev, struct device_node *node,\r\nstruct mtk_mdp_comp *comp, enum mtk_mdp_comp_id comp_id)\r\n{\r\nstruct device_node *larb_node;\r\nstruct platform_device *larb_pdev;\r\nint i;\r\nif (comp_id < 0 || comp_id >= MTK_MDP_COMP_ID_MAX) {\r\ndev_err(dev, "Invalid comp_id %d\n", comp_id);\r\nreturn -EINVAL;\r\n}\r\ncomp->dev_node = of_node_get(node);\r\ncomp->id = comp_id;\r\ncomp->type = mtk_mdp_matches[comp_id].type;\r\ncomp->regs = of_iomap(node, 0);\r\nfor (i = 0; i < ARRAY_SIZE(comp->clk); i++) {\r\ncomp->clk[i] = of_clk_get(node, i);\r\nif (comp->type != MTK_MDP_RDMA)\r\nbreak;\r\n}\r\ncomp->larb_dev = NULL;\r\nif (comp->type != MTK_MDP_RDMA &&\r\ncomp->type != MTK_MDP_WDMA &&\r\ncomp->type != MTK_MDP_WROT)\r\nreturn 0;\r\nlarb_node = of_parse_phandle(node, "mediatek,larb", 0);\r\nif (!larb_node) {\r\ndev_err(dev,\r\n"Missing mediadek,larb phandle in %s node\n",\r\nnode->full_name);\r\nreturn -EINVAL;\r\n}\r\nlarb_pdev = of_find_device_by_node(larb_node);\r\nif (!larb_pdev) {\r\ndev_warn(dev, "Waiting for larb device %s\n",\r\nlarb_node->full_name);\r\nof_node_put(larb_node);\r\nreturn -EPROBE_DEFER;\r\n}\r\nof_node_put(larb_node);\r\ncomp->larb_dev = &larb_pdev->dev;\r\nreturn 0;\r\n}\r\nvoid mtk_mdp_comp_deinit(struct device *dev, struct mtk_mdp_comp *comp)\r\n{\r\nof_node_put(comp->dev_node);\r\n}

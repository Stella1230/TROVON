static int max6900_i2c_read_regs(struct i2c_client *client, u8 *buf)\r\n{\r\nu8 reg_burst_read[1] = { MAX6900_REG_BURST_READ };\r\nu8 reg_century_read[1] = { MAX6900_REG_CENTURY_READ };\r\nstruct i2c_msg msgs[4] = {\r\n{\r\n.addr = client->addr,\r\n.flags = 0,\r\n.len = sizeof(reg_burst_read),\r\n.buf = reg_burst_read}\r\n,\r\n{\r\n.addr = client->addr,\r\n.flags = I2C_M_RD,\r\n.len = MAX6900_BURST_LEN,\r\n.buf = buf}\r\n,\r\n{\r\n.addr = client->addr,\r\n.flags = 0,\r\n.len = sizeof(reg_century_read),\r\n.buf = reg_century_read}\r\n,\r\n{\r\n.addr = client->addr,\r\n.flags = I2C_M_RD,\r\n.len = sizeof(buf[MAX6900_REG_CENTURY]),\r\n.buf = &buf[MAX6900_REG_CENTURY]\r\n}\r\n};\r\nint rc;\r\nrc = i2c_transfer(client->adapter, msgs, ARRAY_SIZE(msgs));\r\nif (rc != ARRAY_SIZE(msgs)) {\r\ndev_err(&client->dev, "%s: register read failed\n", __func__);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max6900_i2c_write_regs(struct i2c_client *client, u8 const *buf)\r\n{\r\nu8 i2c_century_buf[1 + 1] = { MAX6900_REG_CENTURY_WRITE };\r\nstruct i2c_msg century_msgs[1] = {\r\n{\r\n.addr = client->addr,\r\n.flags = 0,\r\n.len = sizeof(i2c_century_buf),\r\n.buf = i2c_century_buf}\r\n};\r\nu8 i2c_burst_buf[MAX6900_BURST_LEN + 1] = { MAX6900_REG_BURST_WRITE };\r\nstruct i2c_msg burst_msgs[1] = {\r\n{\r\n.addr = client->addr,\r\n.flags = 0,\r\n.len = sizeof(i2c_burst_buf),\r\n.buf = i2c_burst_buf}\r\n};\r\nint rc;\r\ni2c_century_buf[1] = buf[MAX6900_REG_CENTURY];\r\nrc = i2c_transfer(client->adapter, century_msgs,\r\nARRAY_SIZE(century_msgs));\r\nif (rc != ARRAY_SIZE(century_msgs))\r\ngoto write_failed;\r\nmsleep(MAX6900_IDLE_TIME_AFTER_WRITE);\r\nmemcpy(&i2c_burst_buf[1], buf, MAX6900_BURST_LEN);\r\nrc = i2c_transfer(client->adapter, burst_msgs, ARRAY_SIZE(burst_msgs));\r\nif (rc != ARRAY_SIZE(burst_msgs))\r\ngoto write_failed;\r\nmsleep(MAX6900_IDLE_TIME_AFTER_WRITE);\r\nreturn 0;\r\nwrite_failed:\r\ndev_err(&client->dev, "%s: register write failed\n", __func__);\r\nreturn -EIO;\r\n}\r\nstatic int max6900_i2c_read_time(struct i2c_client *client, struct rtc_time *tm)\r\n{\r\nint rc;\r\nu8 regs[MAX6900_REG_LEN];\r\nrc = max6900_i2c_read_regs(client, regs);\r\nif (rc < 0)\r\nreturn rc;\r\ntm->tm_sec = bcd2bin(regs[MAX6900_REG_SC]);\r\ntm->tm_min = bcd2bin(regs[MAX6900_REG_MN]);\r\ntm->tm_hour = bcd2bin(regs[MAX6900_REG_HR] & 0x3f);\r\ntm->tm_mday = bcd2bin(regs[MAX6900_REG_DT]);\r\ntm->tm_mon = bcd2bin(regs[MAX6900_REG_MO]) - 1;\r\ntm->tm_year = bcd2bin(regs[MAX6900_REG_YR]) +\r\nbcd2bin(regs[MAX6900_REG_CENTURY]) * 100 - 1900;\r\ntm->tm_wday = bcd2bin(regs[MAX6900_REG_DW]);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int max6900_i2c_clear_write_protect(struct i2c_client *client)\r\n{\r\nreturn i2c_smbus_write_byte_data(client, MAX6900_REG_CONTROL_WRITE, 0);\r\n}\r\nstatic int\r\nmax6900_i2c_set_time(struct i2c_client *client, struct rtc_time const *tm)\r\n{\r\nu8 regs[MAX6900_REG_LEN];\r\nint rc;\r\nrc = max6900_i2c_clear_write_protect(client);\r\nif (rc < 0)\r\nreturn rc;\r\nregs[MAX6900_REG_SC] = bin2bcd(tm->tm_sec);\r\nregs[MAX6900_REG_MN] = bin2bcd(tm->tm_min);\r\nregs[MAX6900_REG_HR] = bin2bcd(tm->tm_hour);\r\nregs[MAX6900_REG_DT] = bin2bcd(tm->tm_mday);\r\nregs[MAX6900_REG_MO] = bin2bcd(tm->tm_mon + 1);\r\nregs[MAX6900_REG_DW] = bin2bcd(tm->tm_wday);\r\nregs[MAX6900_REG_YR] = bin2bcd(tm->tm_year % 100);\r\nregs[MAX6900_REG_CENTURY] = bin2bcd((tm->tm_year + 1900) / 100);\r\nregs[MAX6900_REG_CT] = MAX6900_REG_CT_WP;\r\nrc = max6900_i2c_write_regs(client, regs);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn 0;\r\n}\r\nstatic int max6900_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nreturn max6900_i2c_read_time(to_i2c_client(dev), tm);\r\n}\r\nstatic int max6900_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nreturn max6900_i2c_set_time(to_i2c_client(dev), tm);\r\n}\r\nstatic int\r\nmax6900_probe(struct i2c_client *client, const struct i2c_device_id *id)\r\n{\r\nstruct rtc_device *rtc;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C))\r\nreturn -ENODEV;\r\nrtc = devm_rtc_device_register(&client->dev, max6900_driver.driver.name,\r\n&max6900_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\ni2c_set_clientdata(client, rtc);\r\nreturn 0;\r\n}

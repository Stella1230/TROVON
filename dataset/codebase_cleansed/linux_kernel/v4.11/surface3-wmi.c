static int s3_wmi_query_block(const char *guid, int instance, int *ret)\r\n{\r\nstruct acpi_buffer output = { ACPI_ALLOCATE_BUFFER, NULL };\r\nacpi_status status;\r\nunion acpi_object *obj;\r\nint error = 0;\r\nmutex_lock(&s3_wmi_lock);\r\nstatus = wmi_query_block(guid, instance, &output);\r\nobj = output.pointer;\r\nif (!obj || obj->type != ACPI_TYPE_INTEGER) {\r\nif (obj) {\r\npr_err("query block returned object type: %d - buffer length:%d\n",\r\nobj->type,\r\nobj->type == ACPI_TYPE_BUFFER ?\r\nobj->buffer.length : 0);\r\n}\r\nerror = -EINVAL;\r\ngoto out_free_unlock;\r\n}\r\n*ret = obj->integer.value;\r\nout_free_unlock:\r\nkfree(obj);\r\nmutex_unlock(&s3_wmi_lock);\r\nreturn error;\r\n}\r\nstatic inline int s3_wmi_query_lid(int *ret)\r\n{\r\nreturn s3_wmi_query_block(SURFACE3_LID_GUID, 0, ret);\r\n}\r\nstatic int s3_wmi_send_lid_state(void)\r\n{\r\nint ret, lid_sw;\r\nret = s3_wmi_query_lid(&lid_sw);\r\nif (ret)\r\nreturn ret;\r\ninput_report_switch(s3_wmi.input, SW_LID, lid_sw);\r\ninput_sync(s3_wmi.input);\r\nreturn 0;\r\n}\r\nstatic int s3_wmi_hp_notify(struct acpi_device *adev, u32 value)\r\n{\r\nreturn s3_wmi_send_lid_state();\r\n}\r\nstatic acpi_status s3_wmi_attach_spi_device(acpi_handle handle,\r\nu32 level,\r\nvoid *data,\r\nvoid **return_value)\r\n{\r\nstruct acpi_device *adev, **ts_adev;\r\nif (acpi_bus_get_device(handle, &adev))\r\nreturn AE_OK;\r\nts_adev = data;\r\nif (strncmp(acpi_device_bid(adev), SPI_TS_OBJ_NAME,\r\nstrlen(SPI_TS_OBJ_NAME)))\r\nreturn AE_OK;\r\nif (*ts_adev) {\r\npr_err("duplicate entry %s\n", SPI_TS_OBJ_NAME);\r\nreturn AE_OK;\r\n}\r\n*ts_adev = adev;\r\nreturn AE_OK;\r\n}\r\nstatic int s3_wmi_check_platform_device(struct device *dev, void *data)\r\n{\r\nstruct acpi_device *adev, *ts_adev = NULL;\r\nacpi_handle handle;\r\nacpi_status status;\r\nhandle = ACPI_HANDLE(dev);\r\nif (!handle || acpi_bus_get_device(handle, &adev))\r\nreturn 0;\r\nif (!strcmp(ACPI_BUTTON_HID_LID, acpi_device_hid(adev))) {\r\ns3_wmi.pnp0c0d_adev = adev;\r\nreturn 0;\r\n}\r\nif (strncmp(acpi_device_bid(adev), SPI_CTL_OBJ_NAME,\r\nstrlen(SPI_CTL_OBJ_NAME)))\r\nreturn 0;\r\nstatus = acpi_walk_namespace(ACPI_TYPE_DEVICE, handle, 1,\r\ns3_wmi_attach_spi_device, NULL,\r\n&ts_adev, NULL);\r\nif (ACPI_FAILURE(status))\r\ndev_warn(dev, "failed to enumerate SPI slaves\n");\r\nif (!ts_adev)\r\nreturn 0;\r\ns3_wmi.touchscreen_adev = ts_adev;\r\nreturn 0;\r\n}\r\nstatic int s3_wmi_create_and_register_input(struct platform_device *pdev)\r\n{\r\nstruct input_dev *input;\r\nint error;\r\ninput = devm_input_allocate_device(&pdev->dev);\r\nif (!input)\r\nreturn -ENOMEM;\r\ninput->name = "Lid Switch";\r\ninput->phys = "button/input0";\r\ninput->id.bustype = BUS_HOST;\r\ninput->id.product = 0x0005;\r\ninput_set_capability(input, EV_SW, SW_LID);\r\nerror = input_register_device(input);\r\nif (error)\r\ngoto out_err;\r\ns3_wmi.input = input;\r\nreturn 0;\r\nout_err:\r\ninput_free_device(s3_wmi.input);\r\nreturn error;\r\n}\r\nstatic int __init s3_wmi_probe(struct platform_device *pdev)\r\n{\r\nint error;\r\nif (!dmi_check_system(surface3_dmi_table))\r\nreturn -ENODEV;\r\nmemset(&s3_wmi, 0, sizeof(s3_wmi));\r\nbus_for_each_dev(&platform_bus_type, NULL, NULL,\r\ns3_wmi_check_platform_device);\r\nif (!s3_wmi.touchscreen_adev)\r\nreturn -ENODEV;\r\nacpi_bus_trim(s3_wmi.pnp0c0d_adev);\r\nerror = s3_wmi_create_and_register_input(pdev);\r\nif (error)\r\ngoto restore_acpi_lid;\r\nacpi_initialize_hp_context(s3_wmi.touchscreen_adev, &s3_wmi.hp,\r\ns3_wmi_hp_notify, NULL);\r\ns3_wmi_send_lid_state();\r\nreturn 0;\r\nrestore_acpi_lid:\r\nacpi_bus_scan(s3_wmi.pnp0c0d_adev->handle);\r\nreturn error;\r\n}\r\nstatic int s3_wmi_remove(struct platform_device *device)\r\n{\r\ns3_wmi.touchscreen_adev->hp = NULL;\r\nacpi_bus_scan(s3_wmi.pnp0c0d_adev->handle);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused s3_wmi_resume(struct device *dev)\r\n{\r\ns3_wmi_send_lid_state();\r\nreturn 0;\r\n}\r\nstatic int __init s3_wmi_init(void)\r\n{\r\nint error;\r\ns3_wmi_pdev = platform_device_alloc("surface3-wmi", -1);\r\nif (!s3_wmi_pdev)\r\nreturn -ENOMEM;\r\nerror = platform_device_add(s3_wmi_pdev);\r\nif (error)\r\ngoto err_device_put;\r\nerror = platform_driver_probe(&s3_wmi_driver, s3_wmi_probe);\r\nif (error)\r\ngoto err_device_del;\r\npr_info("Surface 3 WMI Extras loaded\n");\r\nreturn 0;\r\nerr_device_del:\r\nplatform_device_del(s3_wmi_pdev);\r\nerr_device_put:\r\nplatform_device_put(s3_wmi_pdev);\r\nreturn error;\r\n}\r\nstatic void __exit s3_wmi_exit(void)\r\n{\r\nplatform_device_unregister(s3_wmi_pdev);\r\nplatform_driver_unregister(&s3_wmi_driver);\r\n}

static void int_exit(int sig)\r\n{\r\nset_link_xdp_fd(ifindex, -1);\r\nexit(0);\r\n}\r\nstatic void poll_stats(int interval)\r\n{\r\nunsigned int nr_cpus = bpf_num_possible_cpus();\r\nconst unsigned int nr_keys = 256;\r\n__u64 values[nr_cpus], prev[nr_keys][nr_cpus];\r\n__u32 key;\r\nint i;\r\nmemset(prev, 0, sizeof(prev));\r\nwhile (1) {\r\nsleep(interval);\r\nfor (key = 0; key < nr_keys; key++) {\r\n__u64 sum = 0;\r\nassert(bpf_map_lookup_elem(map_fd[0], &key, values) == 0);\r\nfor (i = 0; i < nr_cpus; i++)\r\nsum += (values[i] - prev[key][i]);\r\nif (sum)\r\nprintf("proto %u: %10llu pkt/s\n",\r\nkey, sum / interval);\r\nmemcpy(prev[key], values, sizeof(values));\r\n}\r\n}\r\n}\r\nint main(int ac, char **argv)\r\n{\r\nchar filename[256];\r\nsnprintf(filename, sizeof(filename), "%s_kern.o", argv[0]);\r\nif (ac != 2) {\r\nprintf("usage: %s IFINDEX\n", argv[0]);\r\nreturn 1;\r\n}\r\nifindex = strtoul(argv[1], NULL, 0);\r\nif (load_bpf_file(filename)) {\r\nprintf("%s", bpf_log_buf);\r\nreturn 1;\r\n}\r\nif (!prog_fd[0]) {\r\nprintf("load_bpf_file: %s\n", strerror(errno));\r\nreturn 1;\r\n}\r\nsignal(SIGINT, int_exit);\r\nif (set_link_xdp_fd(ifindex, prog_fd[0]) < 0) {\r\nprintf("link set xdp fd failed\n");\r\nreturn 1;\r\n}\r\npoll_stats(2);\r\nreturn 0;\r\n}

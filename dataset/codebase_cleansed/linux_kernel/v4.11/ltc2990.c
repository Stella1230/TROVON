static int ltc2990_voltage_to_int(int raw)\r\n{\r\nif (raw & BIT(14))\r\nreturn -(0x4000 - (raw & 0x3FFF)) << 2;\r\nelse\r\nreturn (raw & 0x3FFF) << 2;\r\n}\r\nstatic int ltc2990_get_value(struct i2c_client *i2c, u8 reg, int *result)\r\n{\r\nint val;\r\nval = i2c_smbus_read_word_swapped(i2c, reg);\r\nif (unlikely(val < 0))\r\nreturn val;\r\nswitch (reg) {\r\ncase LTC2990_TINT_MSB:\r\nval = (val & 0x1FFF) << 3;\r\n*result = (val * 1000) >> 7;\r\nbreak;\r\ncase LTC2990_V1_MSB:\r\ncase LTC2990_V3_MSB:\r\n*result = ltc2990_voltage_to_int(val) * 1942 / (4 * 100);\r\nbreak;\r\ncase LTC2990_VCC_MSB:\r\n*result = (ltc2990_voltage_to_int(val) * 30518 /\r\n(4 * 100 * 1000)) + 2500;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t ltc2990_show_value(struct device *dev,\r\nstruct device_attribute *da, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nint value;\r\nint ret;\r\nret = ltc2990_get_value(dev_get_drvdata(dev), attr->index, &value);\r\nif (unlikely(ret < 0))\r\nreturn ret;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", value);\r\n}\r\nstatic int ltc2990_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nint ret;\r\nstruct device *hwmon_dev;\r\nif (!i2c_check_functionality(i2c->adapter, I2C_FUNC_SMBUS_BYTE_DATA |\r\nI2C_FUNC_SMBUS_WORD_DATA))\r\nreturn -ENODEV;\r\nret = i2c_smbus_write_byte_data(i2c, LTC2990_CONTROL,\r\nLTC2990_CONTROL_MEASURE_ALL |\r\nLTC2990_CONTROL_MODE_CURRENT);\r\nif (ret < 0) {\r\ndev_err(&i2c->dev, "Error: Failed to set control mode.\n");\r\nreturn ret;\r\n}\r\nret = i2c_smbus_write_byte_data(i2c, LTC2990_TRIGGER, 1);\r\nif (ret < 0) {\r\ndev_err(&i2c->dev, "Error: Failed to start acquisition.\n");\r\nreturn ret;\r\n}\r\nhwmon_dev = devm_hwmon_device_register_with_groups(&i2c->dev,\r\ni2c->name,\r\ni2c,\r\nltc2990_groups);\r\nreturn PTR_ERR_OR_ZERO(hwmon_dev);\r\n}

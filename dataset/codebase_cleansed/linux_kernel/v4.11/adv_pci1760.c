static int pci1760_send_cmd(struct comedi_device *dev,\r\nunsigned char cmd, unsigned short val)\r\n{\r\nunsigned long timeout;\r\noutb(val & 0xff, dev->iobase + PCI1760_OMB_REG(0));\r\noutb((val >> 8) & 0xff, dev->iobase + PCI1760_OMB_REG(1));\r\noutb(cmd, dev->iobase + PCI1760_OMB_REG(2));\r\noutb(0, dev->iobase + PCI1760_OMB_REG(3));\r\ntimeout = jiffies + usecs_to_jiffies(PCI1760_CMD_TIMEOUT);\r\ndo {\r\nif (inb(dev->iobase + PCI1760_IMB_REG(2)) == cmd) {\r\nreturn inb(dev->iobase + PCI1760_IMB_REG(0)) |\r\n(inb(dev->iobase + PCI1760_IMB_REG(1)) << 8);\r\n}\r\ncpu_relax();\r\n} while (time_before(jiffies, timeout));\r\nreturn -EBUSY;\r\n}\r\nstatic int pci1760_cmd(struct comedi_device *dev,\r\nunsigned char cmd, unsigned short val)\r\n{\r\nint repeats;\r\nint ret;\r\nif (inb(dev->iobase + PCI1760_IMB_REG(2)) == cmd) {\r\nret = pci1760_send_cmd(dev, PCI1760_CMD_CLR_IMB2, 0);\r\nif (ret < 0) {\r\nret = pci1760_send_cmd(dev, PCI1760_CMD_CLR_IMB2, 0);\r\nif (ret < 0)\r\nreturn -ETIMEDOUT;\r\n}\r\n}\r\nfor (repeats = 0; repeats < PCI1760_CMD_RETRIES; repeats++) {\r\nret = pci1760_send_cmd(dev, cmd, val);\r\nif (ret >= 0)\r\nreturn ret;\r\n}\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int pci1760_di_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\ndata[1] = inb(dev->iobase + PCI1760_IMB_REG(3));\r\nreturn insn->n;\r\n}\r\nstatic int pci1760_do_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nint ret;\r\nif (comedi_dio_update_state(s, data)) {\r\nret = pci1760_cmd(dev, PCI1760_CMD_SET_DO, s->state);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\ndata[1] = s->state;\r\nreturn insn->n;\r\n}\r\nstatic int pci1760_pwm_ns_to_div(unsigned int flags, unsigned int ns)\r\n{\r\nunsigned int divisor;\r\nswitch (flags) {\r\ncase CMDF_ROUND_NEAREST:\r\ndivisor = DIV_ROUND_CLOSEST(ns, PCI1760_PWM_TIMEBASE);\r\nbreak;\r\ncase CMDF_ROUND_UP:\r\ndivisor = DIV_ROUND_UP(ns, PCI1760_PWM_TIMEBASE);\r\nbreak;\r\ncase CMDF_ROUND_DOWN:\r\ndivisor = ns / PCI1760_PWM_TIMEBASE;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (divisor < 1)\r\ndivisor = 1;\r\nif (divisor > 0xffff)\r\ndivisor = 0xffff;\r\nreturn divisor;\r\n}\r\nstatic int pci1760_pwm_enable(struct comedi_device *dev,\r\nunsigned int chan, bool enable)\r\n{\r\nint ret;\r\nret = pci1760_cmd(dev, PCI1760_CMD_GET_STATUS, PCI1760_CMD_ENA_PWM);\r\nif (ret < 0)\r\nreturn ret;\r\nif (enable)\r\nret |= BIT(chan);\r\nelse\r\nret &= ~BIT(chan);\r\nreturn pci1760_cmd(dev, PCI1760_CMD_ENA_PWM, ret);\r\n}\r\nstatic int pci1760_pwm_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nint hi_div;\r\nint lo_div;\r\nint ret;\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_ARM:\r\nret = pci1760_pwm_enable(dev, chan, false);\r\nif (ret < 0)\r\nreturn ret;\r\nif (data[1] > 0xffff)\r\nreturn -EINVAL;\r\nret = pci1760_cmd(dev, PCI1760_CMD_SET_PWM_CNT(chan), data[1]);\r\nif (ret < 0)\r\nreturn ret;\r\nret = pci1760_pwm_enable(dev, chan, true);\r\nif (ret < 0)\r\nreturn ret;\r\nbreak;\r\ncase INSN_CONFIG_DISARM:\r\nret = pci1760_pwm_enable(dev, chan, false);\r\nif (ret < 0)\r\nreturn ret;\r\nbreak;\r\ncase INSN_CONFIG_PWM_OUTPUT:\r\nret = pci1760_pwm_enable(dev, chan, false);\r\nif (ret < 0)\r\nreturn ret;\r\nhi_div = pci1760_pwm_ns_to_div(data[1], data[2]);\r\nlo_div = pci1760_pwm_ns_to_div(data[3], data[4]);\r\nif (hi_div < 0 || lo_div < 0)\r\nreturn -EINVAL;\r\nif ((hi_div * PCI1760_PWM_TIMEBASE) != data[2] ||\r\n(lo_div * PCI1760_PWM_TIMEBASE) != data[4]) {\r\ndata[2] = hi_div * PCI1760_PWM_TIMEBASE;\r\ndata[4] = lo_div * PCI1760_PWM_TIMEBASE;\r\nreturn -EAGAIN;\r\n}\r\nret = pci1760_cmd(dev, PCI1760_CMD_SET_PWM_HI(chan), hi_div);\r\nif (ret < 0)\r\nreturn ret;\r\nret = pci1760_cmd(dev, PCI1760_CMD_SET_PWM_LO(chan), lo_div);\r\nif (ret < 0)\r\nreturn ret;\r\nbreak;\r\ncase INSN_CONFIG_GET_PWM_OUTPUT:\r\nhi_div = pci1760_cmd(dev, PCI1760_CMD_GET_STATUS,\r\nPCI1760_CMD_SET_PWM_HI(chan));\r\nlo_div = pci1760_cmd(dev, PCI1760_CMD_GET_STATUS,\r\nPCI1760_CMD_SET_PWM_LO(chan));\r\nif (hi_div < 0 || lo_div < 0)\r\nreturn -ETIMEDOUT;\r\ndata[1] = hi_div * PCI1760_PWM_TIMEBASE;\r\ndata[2] = lo_div * PCI1760_PWM_TIMEBASE;\r\nbreak;\r\ncase INSN_CONFIG_GET_PWM_STATUS:\r\nret = pci1760_cmd(dev, PCI1760_CMD_GET_STATUS,\r\nPCI1760_CMD_ENA_PWM);\r\nif (ret < 0)\r\nreturn ret;\r\ndata[1] = (ret & BIT(chan)) ? 1 : 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic void pci1760_reset(struct comedi_device *dev)\r\n{\r\nint i;\r\noutb(0, dev->iobase + PCI1760_INTCSR_REG(0));\r\noutb(0, dev->iobase + PCI1760_INTCSR_REG(1));\r\noutb(0, dev->iobase + PCI1760_INTCSR_REG(3));\r\npci1760_cmd(dev, PCI1760_CMD_ENA_CNT, 0);\r\npci1760_cmd(dev, PCI1760_CMD_ENA_CNT_OFLOW, 0);\r\npci1760_cmd(dev, PCI1760_CMD_ENA_CNT_MATCH, 0);\r\nfor (i = 0; i < 8; i++) {\r\npci1760_cmd(dev, PCI1760_CMD_SET_CNT_MATCH(i), 0x8000);\r\npci1760_cmd(dev, PCI1760_CMD_SET_CNT(i), 0x0000);\r\n}\r\npci1760_cmd(dev, PCI1760_CMD_RST_CNT, 0xff);\r\npci1760_cmd(dev, PCI1760_CMD_SET_CNT_EDGE, 0);\r\npci1760_cmd(dev, PCI1760_CMD_ENA_FILT, 0);\r\npci1760_cmd(dev, PCI1760_CMD_ENA_PAT_MATCH, 0);\r\npci1760_cmd(dev, PCI1760_CMD_SET_PAT_MATCH, 0);\r\n}\r\nstatic int pci1760_auto_attach(struct comedi_device *dev,\r\nunsigned long context)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nstruct comedi_subdevice *s;\r\nint ret;\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\ndev->iobase = pci_resource_start(pcidev, 0);\r\npci1760_reset(dev);\r\nret = comedi_alloc_subdevices(dev, 4);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan = 8;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = pci1760_di_insn_bits;\r\ns = &dev->subdevices[1];\r\ns->type = COMEDI_SUBD_DO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = 8;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = pci1760_do_insn_bits;\r\nret = pci1760_cmd(dev, PCI1760_CMD_GET_DO, 0);\r\nif (ret < 0)\r\nreturn ret;\r\ns->state = ret;\r\ns = &dev->subdevices[2];\r\ns->type = COMEDI_SUBD_PWM;\r\ns->subdev_flags = SDF_PWM_COUNTER;\r\ns->n_chan = 2;\r\ns->insn_config = pci1760_pwm_insn_config;\r\ns = &dev->subdevices[3];\r\ns->type = COMEDI_SUBD_UNUSED;\r\nreturn 0;\r\n}\r\nstatic int pci1760_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &pci1760_driver, id->driver_data);\r\n}

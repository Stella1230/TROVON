static int cio_dac_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan, int *val, int *val2, long mask)\r\n{\r\nstruct cio_dac_iio *const priv = iio_priv(indio_dev);\r\nif (mask != IIO_CHAN_INFO_RAW)\r\nreturn -EINVAL;\r\n*val = priv->chan_out_states[chan->channel];\r\nreturn IIO_VAL_INT;\r\n}\r\nstatic int cio_dac_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan, int val, int val2, long mask)\r\n{\r\nstruct cio_dac_iio *const priv = iio_priv(indio_dev);\r\nconst unsigned int chan_addr_offset = 2 * chan->channel;\r\nif (mask != IIO_CHAN_INFO_RAW)\r\nreturn -EINVAL;\r\nif ((unsigned int)val > 65535)\r\nreturn -EINVAL;\r\npriv->chan_out_states[chan->channel] = val;\r\noutw(val, priv->base + chan_addr_offset);\r\nreturn 0;\r\n}\r\nstatic int cio_dac_probe(struct device *dev, unsigned int id)\r\n{\r\nstruct iio_dev *indio_dev;\r\nstruct cio_dac_iio *priv;\r\nunsigned int i;\r\nindio_dev = devm_iio_device_alloc(dev, sizeof(*priv));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\nif (!devm_request_region(dev, base[id], CIO_DAC_EXTENT,\r\ndev_name(dev))) {\r\ndev_err(dev, "Unable to request port addresses (0x%X-0x%X)\n",\r\nbase[id], base[id] + CIO_DAC_EXTENT);\r\nreturn -EBUSY;\r\n}\r\nindio_dev->info = &cio_dac_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = cio_dac_channels;\r\nindio_dev->num_channels = CIO_DAC_NUM_CHAN;\r\nindio_dev->name = dev_name(dev);\r\npriv = iio_priv(indio_dev);\r\npriv->base = base[id];\r\nfor (i = 0; i < 32; i += 2)\r\noutw(0, base[id] + i);\r\nreturn devm_iio_device_register(dev, indio_dev);\r\n}

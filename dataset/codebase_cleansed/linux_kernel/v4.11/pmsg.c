static ssize_t write_pmsg(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nu64 id;\r\nint ret;\r\nif (!count)\r\nreturn 0;\r\nif (!access_ok(VERIFY_READ, buf, count))\r\nreturn -EFAULT;\r\nmutex_lock(&pmsg_lock);\r\nret = psinfo->write_buf_user(PSTORE_TYPE_PMSG, 0, &id, 0, buf, 0, count,\r\npsinfo);\r\nmutex_unlock(&pmsg_lock);\r\nreturn ret ? ret : count;\r\n}\r\nstatic char *pmsg_devnode(struct device *dev, umode_t *mode)\r\n{\r\nif (mode)\r\n*mode = 0220;\r\nreturn NULL;\r\n}\r\nvoid pstore_register_pmsg(void)\r\n{\r\nstruct device *pmsg_device;\r\npmsg_major = register_chrdev(0, PMSG_NAME, &pmsg_fops);\r\nif (pmsg_major < 0) {\r\npr_err("register_chrdev failed\n");\r\ngoto err;\r\n}\r\npmsg_class = class_create(THIS_MODULE, PMSG_NAME);\r\nif (IS_ERR(pmsg_class)) {\r\npr_err("device class file already in use\n");\r\ngoto err_class;\r\n}\r\npmsg_class->devnode = pmsg_devnode;\r\npmsg_device = device_create(pmsg_class, NULL, MKDEV(pmsg_major, 0),\r\nNULL, "%s%d", PMSG_NAME, 0);\r\nif (IS_ERR(pmsg_device)) {\r\npr_err("failed to create device\n");\r\ngoto err_device;\r\n}\r\nreturn;\r\nerr_device:\r\nclass_destroy(pmsg_class);\r\nerr_class:\r\nunregister_chrdev(pmsg_major, PMSG_NAME);\r\nerr:\r\nreturn;\r\n}\r\nvoid pstore_unregister_pmsg(void)\r\n{\r\ndevice_destroy(pmsg_class, MKDEV(pmsg_major, 0));\r\nclass_destroy(pmsg_class);\r\nunregister_chrdev(pmsg_major, PMSG_NAME);\r\n}

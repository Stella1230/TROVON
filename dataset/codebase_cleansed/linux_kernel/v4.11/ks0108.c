void ks0108_writedata(unsigned char byte)\r\n{\r\nparport_write_data(ks0108_parport, byte);\r\n}\r\nvoid ks0108_writecontrol(unsigned char byte)\r\n{\r\nudelay(ks0108_delay);\r\nparport_write_control(ks0108_parport, byte ^ (bit(0) | bit(1) | bit(3)));\r\n}\r\nvoid ks0108_displaystate(unsigned char state)\r\n{\r\nks0108_writedata((state ? bit(0) : 0) | bit(1) | bit(2) | bit(3) | bit(4) | bit(5));\r\n}\r\nvoid ks0108_startline(unsigned char startline)\r\n{\r\nks0108_writedata(min_t(unsigned char, startline, 63) | bit(6) |\r\nbit(7));\r\n}\r\nvoid ks0108_address(unsigned char address)\r\n{\r\nks0108_writedata(min_t(unsigned char, address, 63) | bit(6));\r\n}\r\nvoid ks0108_page(unsigned char page)\r\n{\r\nks0108_writedata(min_t(unsigned char, page, 7) | bit(3) | bit(4) |\r\nbit(5) | bit(7));\r\n}\r\nunsigned char ks0108_isinited(void)\r\n{\r\nreturn ks0108_inited;\r\n}\r\nstatic void ks0108_parport_attach(struct parport *port)\r\n{\r\nstruct pardev_cb ks0108_cb;\r\nif (port->base != ks0108_port)\r\nreturn;\r\nmemset(&ks0108_cb, 0, sizeof(ks0108_cb));\r\nks0108_cb.flags = PARPORT_DEV_EXCL;\r\nks0108_pardevice = parport_register_dev_model(port, KS0108_NAME,\r\n&ks0108_cb, 0);\r\nif (!ks0108_pardevice) {\r\npr_err("ERROR: parport didn't register new device\n");\r\nreturn;\r\n}\r\nif (parport_claim(ks0108_pardevice)) {\r\npr_err("could not claim access to parport %i. Aborting.\n",\r\nks0108_port);\r\ngoto err_unreg_device;\r\n}\r\nks0108_parport = port;\r\nks0108_inited = 1;\r\nreturn;\r\nerr_unreg_device:\r\nparport_unregister_device(ks0108_pardevice);\r\nks0108_pardevice = NULL;\r\n}\r\nstatic void ks0108_parport_detach(struct parport *port)\r\n{\r\nif (port->base != ks0108_port)\r\nreturn;\r\nif (!ks0108_pardevice) {\r\npr_err("%s: already unregistered.\n", KS0108_NAME);\r\nreturn;\r\n}\r\nparport_release(ks0108_pardevice);\r\nparport_unregister_device(ks0108_pardevice);\r\nks0108_pardevice = NULL;\r\nks0108_parport = NULL;\r\n}\r\nstatic int __init ks0108_init(void)\r\n{\r\nreturn parport_register_driver(&ks0108_parport_driver);\r\n}\r\nstatic void __exit ks0108_exit(void)\r\n{\r\nparport_unregister_driver(&ks0108_parport_driver);\r\n}

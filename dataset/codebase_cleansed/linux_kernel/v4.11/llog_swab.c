static void print_llogd_body(struct llogd_body *d)\r\n{\r\nCDEBUG(D_OTHER, "llogd body: %p\n", d);\r\nCDEBUG(D_OTHER, "\tlgd_logid.lgl_oi: "DOSTID"\n",\r\nPOSTID(&d->lgd_logid.lgl_oi));\r\nCDEBUG(D_OTHER, "\tlgd_logid.lgl_ogen: %#x\n", d->lgd_logid.lgl_ogen);\r\nCDEBUG(D_OTHER, "\tlgd_ctxt_idx: %#x\n", d->lgd_ctxt_idx);\r\nCDEBUG(D_OTHER, "\tlgd_llh_flags: %#x\n", d->lgd_llh_flags);\r\nCDEBUG(D_OTHER, "\tlgd_index: %#x\n", d->lgd_index);\r\nCDEBUG(D_OTHER, "\tlgd_saved_index: %#x\n", d->lgd_saved_index);\r\nCDEBUG(D_OTHER, "\tlgd_len: %#x\n", d->lgd_len);\r\nCDEBUG(D_OTHER, "\tlgd_cur_offset: %#llx\n", d->lgd_cur_offset);\r\n}\r\nvoid lustre_swab_lu_fid(struct lu_fid *fid)\r\n{\r\n__swab64s(&fid->f_seq);\r\n__swab32s(&fid->f_oid);\r\n__swab32s(&fid->f_ver);\r\n}\r\nvoid lustre_swab_ost_id(struct ost_id *oid)\r\n{\r\nif (fid_seq_is_mdt0(oid->oi.oi_seq)) {\r\n__swab64s(&oid->oi.oi_id);\r\n__swab64s(&oid->oi.oi_seq);\r\n} else {\r\nlustre_swab_lu_fid(&oid->oi_fid);\r\n}\r\n}\r\nstatic void lustre_swab_llog_id(struct llog_logid *log_id)\r\n{\r\n__swab64s(&log_id->lgl_oi.oi.oi_id);\r\n__swab64s(&log_id->lgl_oi.oi.oi_seq);\r\n__swab32s(&log_id->lgl_ogen);\r\n}\r\nvoid lustre_swab_llogd_body(struct llogd_body *d)\r\n{\r\nprint_llogd_body(d);\r\nlustre_swab_llog_id(&d->lgd_logid);\r\n__swab32s(&d->lgd_ctxt_idx);\r\n__swab32s(&d->lgd_llh_flags);\r\n__swab32s(&d->lgd_index);\r\n__swab32s(&d->lgd_saved_index);\r\n__swab32s(&d->lgd_len);\r\n__swab64s(&d->lgd_cur_offset);\r\nprint_llogd_body(d);\r\n}\r\nvoid lustre_swab_llogd_conn_body(struct llogd_conn_body *d)\r\n{\r\n__swab64s(&d->lgdc_gen.mnt_cnt);\r\n__swab64s(&d->lgdc_gen.conn_cnt);\r\nlustre_swab_llog_id(&d->lgdc_logid);\r\n__swab32s(&d->lgdc_ctxt_idx);\r\n}\r\nstatic void lustre_swab_ll_fid(struct ll_fid *fid)\r\n{\r\n__swab64s(&fid->id);\r\n__swab32s(&fid->generation);\r\n__swab32s(&fid->f_type);\r\n}\r\nvoid lustre_swab_lu_seq_range(struct lu_seq_range *range)\r\n{\r\n__swab64s(&range->lsr_start);\r\n__swab64s(&range->lsr_end);\r\n__swab32s(&range->lsr_index);\r\n__swab32s(&range->lsr_flags);\r\n}\r\nvoid lustre_swab_llog_rec(struct llog_rec_hdr *rec)\r\n{\r\nstruct llog_rec_tail *tail = NULL;\r\n__swab32s(&rec->lrh_len);\r\n__swab32s(&rec->lrh_index);\r\n__swab32s(&rec->lrh_type);\r\n__swab32s(&rec->lrh_id);\r\nswitch (rec->lrh_type) {\r\ncase OST_SZ_REC:\r\n{\r\nstruct llog_size_change_rec *lsc =\r\n(struct llog_size_change_rec *)rec;\r\nlustre_swab_ll_fid(&lsc->lsc_fid);\r\n__swab32s(&lsc->lsc_ioepoch);\r\ntail = &lsc->lsc_tail;\r\nbreak;\r\n}\r\ncase MDS_UNLINK_REC:\r\n{\r\nstruct llog_unlink_rec *lur = (struct llog_unlink_rec *)rec;\r\n__swab64s(&lur->lur_oid);\r\n__swab32s(&lur->lur_oseq);\r\n__swab32s(&lur->lur_count);\r\ntail = &lur->lur_tail;\r\nbreak;\r\n}\r\ncase MDS_UNLINK64_REC:\r\n{\r\nstruct llog_unlink64_rec *lur =\r\n(struct llog_unlink64_rec *)rec;\r\nlustre_swab_lu_fid(&lur->lur_fid);\r\n__swab32s(&lur->lur_count);\r\ntail = &lur->lur_tail;\r\nbreak;\r\n}\r\ncase CHANGELOG_REC:\r\n{\r\nstruct llog_changelog_rec *cr =\r\n(struct llog_changelog_rec *)rec;\r\n__swab16s(&cr->cr.cr_namelen);\r\n__swab16s(&cr->cr.cr_flags);\r\n__swab32s(&cr->cr.cr_type);\r\n__swab64s(&cr->cr.cr_index);\r\n__swab64s(&cr->cr.cr_prev);\r\n__swab64s(&cr->cr.cr_time);\r\nlustre_swab_lu_fid(&cr->cr.cr_tfid);\r\nlustre_swab_lu_fid(&cr->cr.cr_pfid);\r\nif (cr->cr.cr_flags & CLF_RENAME) {\r\nstruct changelog_ext_rename *rnm =\r\nchangelog_rec_rename(&cr->cr);\r\nlustre_swab_lu_fid(&rnm->cr_sfid);\r\nlustre_swab_lu_fid(&rnm->cr_spfid);\r\n}\r\ntail = (struct llog_rec_tail *)((char *)&cr->cr +\r\nchangelog_rec_size(&cr->cr) +\r\ncr->cr.cr_namelen);\r\nbreak;\r\n}\r\ncase CHANGELOG_USER_REC:\r\n{\r\nstruct llog_changelog_user_rec *cur =\r\n(struct llog_changelog_user_rec *)rec;\r\n__swab32s(&cur->cur_id);\r\n__swab64s(&cur->cur_endrec);\r\ntail = &cur->cur_tail;\r\nbreak;\r\n}\r\ncase HSM_AGENT_REC: {\r\nstruct llog_agent_req_rec *arr =\r\n(struct llog_agent_req_rec *)rec;\r\n__swab32s(&arr->arr_hai.hai_len);\r\n__swab32s(&arr->arr_hai.hai_action);\r\nlustre_swab_lu_fid(&arr->arr_hai.hai_fid);\r\nlustre_swab_lu_fid(&arr->arr_hai.hai_dfid);\r\n__swab64s(&arr->arr_hai.hai_cookie);\r\n__swab64s(&arr->arr_hai.hai_extent.offset);\r\n__swab64s(&arr->arr_hai.hai_extent.length);\r\n__swab64s(&arr->arr_hai.hai_gid);\r\nbreak;\r\n}\r\ncase MDS_SETATTR64_REC:\r\n{\r\nstruct llog_setattr64_rec *lsr =\r\n(struct llog_setattr64_rec *)rec;\r\nlustre_swab_ost_id(&lsr->lsr_oi);\r\n__swab32s(&lsr->lsr_uid);\r\n__swab32s(&lsr->lsr_uid_h);\r\n__swab32s(&lsr->lsr_gid);\r\n__swab32s(&lsr->lsr_gid_h);\r\n__swab64s(&lsr->lsr_valid);\r\ntail = &lsr->lsr_tail;\r\nbreak;\r\n}\r\ncase OBD_CFG_REC:\r\nbreak;\r\ncase LLOG_HDR_MAGIC:\r\n{\r\nstruct llog_log_hdr *llh = (struct llog_log_hdr *)rec;\r\n__swab64s(&llh->llh_timestamp);\r\n__swab32s(&llh->llh_count);\r\n__swab32s(&llh->llh_bitmap_offset);\r\n__swab32s(&llh->llh_flags);\r\n__swab32s(&llh->llh_size);\r\n__swab32s(&llh->llh_cat_idx);\r\ntail = LLOG_HDR_TAIL(llh);\r\nbreak;\r\n}\r\ncase LLOG_LOGID_MAGIC:\r\n{\r\nstruct llog_logid_rec *lid = (struct llog_logid_rec *)rec;\r\nlustre_swab_llog_id(&lid->lid_id);\r\ntail = &lid->lid_tail;\r\nbreak;\r\n}\r\ncase LLOG_GEN_REC:\r\n{\r\nstruct llog_gen_rec *lgr = (struct llog_gen_rec *)rec;\r\n__swab64s(&lgr->lgr_gen.mnt_cnt);\r\n__swab64s(&lgr->lgr_gen.conn_cnt);\r\ntail = &lgr->lgr_tail;\r\nbreak;\r\n}\r\ncase LLOG_PAD_MAGIC:\r\nbreak;\r\ndefault:\r\nCERROR("Unknown llog rec type %#x swabbing rec %p\n",\r\nrec->lrh_type, rec);\r\n}\r\nif (tail) {\r\n__swab32s(&tail->lrt_len);\r\n__swab32s(&tail->lrt_index);\r\n}\r\n}\r\nstatic void print_llog_hdr(struct llog_log_hdr *h)\r\n{\r\nCDEBUG(D_OTHER, "llog header: %p\n", h);\r\nCDEBUG(D_OTHER, "\tllh_hdr.lrh_index: %#x\n", h->llh_hdr.lrh_index);\r\nCDEBUG(D_OTHER, "\tllh_hdr.lrh_len: %#x\n", h->llh_hdr.lrh_len);\r\nCDEBUG(D_OTHER, "\tllh_hdr.lrh_type: %#x\n", h->llh_hdr.lrh_type);\r\nCDEBUG(D_OTHER, "\tllh_timestamp: %#llx\n", h->llh_timestamp);\r\nCDEBUG(D_OTHER, "\tllh_count: %#x\n", h->llh_count);\r\nCDEBUG(D_OTHER, "\tllh_bitmap_offset: %#x\n", h->llh_bitmap_offset);\r\nCDEBUG(D_OTHER, "\tllh_flags: %#x\n", h->llh_flags);\r\nCDEBUG(D_OTHER, "\tllh_size: %#x\n", h->llh_size);\r\nCDEBUG(D_OTHER, "\tllh_cat_idx: %#x\n", h->llh_cat_idx);\r\nCDEBUG(D_OTHER, "\tllh_tail.lrt_index: %#x\n",\r\nLLOG_HDR_TAIL(h)->lrt_index);\r\nCDEBUG(D_OTHER, "\tllh_tail.lrt_len: %#x\n",\r\nLLOG_HDR_TAIL(h)->lrt_len);\r\n}\r\nvoid lustre_swab_llog_hdr(struct llog_log_hdr *h)\r\n{\r\nprint_llog_hdr(h);\r\nlustre_swab_llog_rec(&h->llh_hdr);\r\nprint_llog_hdr(h);\r\n}\r\nstatic void print_lustre_cfg(struct lustre_cfg *lcfg)\r\n{\r\nint i;\r\nif (!(libcfs_debug & D_OTHER))\r\nreturn;\r\nCDEBUG(D_OTHER, "lustre_cfg: %p\n", lcfg);\r\nCDEBUG(D_OTHER, "\tlcfg->lcfg_version: %#x\n", lcfg->lcfg_version);\r\nCDEBUG(D_OTHER, "\tlcfg->lcfg_command: %#x\n", lcfg->lcfg_command);\r\nCDEBUG(D_OTHER, "\tlcfg->lcfg_num: %#x\n", lcfg->lcfg_num);\r\nCDEBUG(D_OTHER, "\tlcfg->lcfg_flags: %#x\n", lcfg->lcfg_flags);\r\nCDEBUG(D_OTHER, "\tlcfg->lcfg_nid: %s\n", libcfs_nid2str(lcfg->lcfg_nid));\r\nCDEBUG(D_OTHER, "\tlcfg->lcfg_bufcount: %d\n", lcfg->lcfg_bufcount);\r\nif (lcfg->lcfg_bufcount < LUSTRE_CFG_MAX_BUFCOUNT)\r\nfor (i = 0; i < lcfg->lcfg_bufcount; i++)\r\nCDEBUG(D_OTHER, "\tlcfg->lcfg_buflens[%d]: %d\n",\r\ni, lcfg->lcfg_buflens[i]);\r\n}\r\nvoid lustre_swab_lustre_cfg(struct lustre_cfg *lcfg)\r\n{\r\nint i;\r\n__swab32s(&lcfg->lcfg_version);\r\nif (lcfg->lcfg_version != LUSTRE_CFG_VERSION) {\r\nCERROR("not swabbing lustre_cfg version %#x (expecting %#x)\n",\r\nlcfg->lcfg_version, LUSTRE_CFG_VERSION);\r\nreturn;\r\n}\r\n__swab32s(&lcfg->lcfg_command);\r\n__swab32s(&lcfg->lcfg_num);\r\n__swab32s(&lcfg->lcfg_flags);\r\n__swab64s(&lcfg->lcfg_nid);\r\n__swab32s(&lcfg->lcfg_bufcount);\r\nfor (i = 0; i < lcfg->lcfg_bufcount && i < LUSTRE_CFG_MAX_BUFCOUNT; i++)\r\n__swab32s(&lcfg->lcfg_buflens[i]);\r\nprint_lustre_cfg(lcfg);\r\n}\r\nvoid lustre_swab_cfg_marker(struct cfg_marker *marker, int swab, int size)\r\n{\r\nstruct cfg_marker32 *cm32 = (struct cfg_marker32 *)marker;\r\nif (swab) {\r\n__swab32s(&marker->cm_step);\r\n__swab32s(&marker->cm_flags);\r\n__swab32s(&marker->cm_vers);\r\n}\r\nif (size == sizeof(*cm32)) {\r\n__u32 createtime, canceltime;\r\ncreatetime = cm32->cm_createtime;\r\ncanceltime = cm32->cm_canceltime;\r\nmemmove(marker->cm_comment, cm32->cm_comment, MTI_NAMELEN32);\r\nmarker->cm_comment[MTI_NAMELEN32 - 1] = '\0';\r\nmemmove(marker->cm_tgtname, cm32->cm_tgtname,\r\nsizeof(marker->cm_tgtname));\r\nif (swab) {\r\n__swab32s(&createtime);\r\n__swab32s(&canceltime);\r\n}\r\nmarker->cm_createtime = createtime;\r\nmarker->cm_canceltime = canceltime;\r\nCDEBUG(D_CONFIG, "Find old cfg_marker(Srv32b,Clt64b) for target %s, converting\n",\r\nmarker->cm_tgtname);\r\n} else if (swab) {\r\n__swab64s(&marker->cm_createtime);\r\n__swab64s(&marker->cm_canceltime);\r\n}\r\n}

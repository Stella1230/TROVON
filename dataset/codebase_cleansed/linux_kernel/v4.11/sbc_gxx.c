static inline void sbc_gxx_page(struct map_info *map, unsigned long ofs)\r\n{\r\nunsigned long page = ofs >> WINDOW_SHIFT;\r\nif( page!=page_in_window ) {\r\noutw( page | DEVICE_ENABLE, PAGE_IO );\r\npage_in_window = page;\r\n}\r\n}\r\nstatic map_word sbc_gxx_read8(struct map_info *map, unsigned long ofs)\r\n{\r\nmap_word ret;\r\nspin_lock(&sbc_gxx_spin);\r\nsbc_gxx_page(map, ofs);\r\nret.x[0] = readb(iomapadr + (ofs & WINDOW_MASK));\r\nspin_unlock(&sbc_gxx_spin);\r\nreturn ret;\r\n}\r\nstatic void sbc_gxx_copy_from(struct map_info *map, void *to, unsigned long from, ssize_t len)\r\n{\r\nwhile(len) {\r\nunsigned long thislen = len;\r\nif (len > (WINDOW_LENGTH - (from & WINDOW_MASK)))\r\nthislen = WINDOW_LENGTH-(from & WINDOW_MASK);\r\nspin_lock(&sbc_gxx_spin);\r\nsbc_gxx_page(map, from);\r\nmemcpy_fromio(to, iomapadr + (from & WINDOW_MASK), thislen);\r\nspin_unlock(&sbc_gxx_spin);\r\nto += thislen;\r\nfrom += thislen;\r\nlen -= thislen;\r\n}\r\n}\r\nstatic void sbc_gxx_write8(struct map_info *map, map_word d, unsigned long adr)\r\n{\r\nspin_lock(&sbc_gxx_spin);\r\nsbc_gxx_page(map, adr);\r\nwriteb(d.x[0], iomapadr + (adr & WINDOW_MASK));\r\nspin_unlock(&sbc_gxx_spin);\r\n}\r\nstatic void sbc_gxx_copy_to(struct map_info *map, unsigned long to, const void *from, ssize_t len)\r\n{\r\nwhile(len) {\r\nunsigned long thislen = len;\r\nif (len > (WINDOW_LENGTH - (to & WINDOW_MASK)))\r\nthislen = WINDOW_LENGTH-(to & WINDOW_MASK);\r\nspin_lock(&sbc_gxx_spin);\r\nsbc_gxx_page(map, to);\r\nmemcpy_toio(iomapadr + (to & WINDOW_MASK), from, thislen);\r\nspin_unlock(&sbc_gxx_spin);\r\nto += thislen;\r\nfrom += thislen;\r\nlen -= thislen;\r\n}\r\n}\r\nstatic void cleanup_sbc_gxx(void)\r\n{\r\nif( all_mtd ) {\r\nmtd_device_unregister(all_mtd);\r\nmap_destroy( all_mtd );\r\n}\r\niounmap(iomapadr);\r\nrelease_region(PAGE_IO,PAGE_IO_SIZE);\r\n}\r\nstatic int __init init_sbc_gxx(void)\r\n{\r\niomapadr = ioremap(WINDOW_START, WINDOW_LENGTH);\r\nif (!iomapadr) {\r\nprintk( KERN_ERR"%s: failed to ioremap memory region\n",\r\nsbc_gxx_map.name );\r\nreturn -EIO;\r\n}\r\nif (!request_region( PAGE_IO, PAGE_IO_SIZE, "SBC-GXx flash")) {\r\nprintk( KERN_ERR"%s: IO ports 0x%x-0x%x in use\n",\r\nsbc_gxx_map.name,\r\nPAGE_IO, PAGE_IO+PAGE_IO_SIZE-1 );\r\niounmap(iomapadr);\r\nreturn -EAGAIN;\r\n}\r\nprintk( KERN_INFO"%s: IO:0x%x-0x%x MEM:0x%x-0x%x\n",\r\nsbc_gxx_map.name,\r\nPAGE_IO, PAGE_IO+PAGE_IO_SIZE-1,\r\nWINDOW_START, WINDOW_START+WINDOW_LENGTH-1 );\r\nall_mtd = do_map_probe( "cfi_probe", &sbc_gxx_map );\r\nif( !all_mtd ) {\r\ncleanup_sbc_gxx();\r\nreturn -ENXIO;\r\n}\r\nall_mtd->owner = THIS_MODULE;\r\nmtd_device_register(all_mtd, partition_info, NUM_PARTITIONS);\r\nreturn 0;\r\n}

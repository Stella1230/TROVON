int ieee80211_aes_ccm_encrypt(struct crypto_aead *tfm, u8 *b_0, u8 *aad,\r\nu8 *data, size_t data_len, u8 *mic,\r\nsize_t mic_len)\r\n{\r\nstruct scatterlist sg[3];\r\nstruct aead_request *aead_req;\r\nint reqsize = sizeof(*aead_req) + crypto_aead_reqsize(tfm);\r\nu8 *__aad;\r\naead_req = kzalloc(reqsize + CCM_AAD_LEN, GFP_ATOMIC);\r\nif (!aead_req)\r\nreturn -ENOMEM;\r\n__aad = (u8 *)aead_req + reqsize;\r\nmemcpy(__aad, aad, CCM_AAD_LEN);\r\nsg_init_table(sg, 3);\r\nsg_set_buf(&sg[0], &__aad[2], be16_to_cpup((__be16 *)__aad));\r\nsg_set_buf(&sg[1], data, data_len);\r\nsg_set_buf(&sg[2], mic, mic_len);\r\naead_request_set_tfm(aead_req, tfm);\r\naead_request_set_crypt(aead_req, sg, sg, data_len, b_0);\r\naead_request_set_ad(aead_req, sg[0].length);\r\ncrypto_aead_encrypt(aead_req);\r\nkzfree(aead_req);\r\nreturn 0;\r\n}\r\nint ieee80211_aes_ccm_decrypt(struct crypto_aead *tfm, u8 *b_0, u8 *aad,\r\nu8 *data, size_t data_len, u8 *mic,\r\nsize_t mic_len)\r\n{\r\nstruct scatterlist sg[3];\r\nstruct aead_request *aead_req;\r\nint reqsize = sizeof(*aead_req) + crypto_aead_reqsize(tfm);\r\nu8 *__aad;\r\nint err;\r\nif (data_len == 0)\r\nreturn -EINVAL;\r\naead_req = kzalloc(reqsize + CCM_AAD_LEN, GFP_ATOMIC);\r\nif (!aead_req)\r\nreturn -ENOMEM;\r\n__aad = (u8 *)aead_req + reqsize;\r\nmemcpy(__aad, aad, CCM_AAD_LEN);\r\nsg_init_table(sg, 3);\r\nsg_set_buf(&sg[0], &__aad[2], be16_to_cpup((__be16 *)__aad));\r\nsg_set_buf(&sg[1], data, data_len);\r\nsg_set_buf(&sg[2], mic, mic_len);\r\naead_request_set_tfm(aead_req, tfm);\r\naead_request_set_crypt(aead_req, sg, sg, data_len + mic_len, b_0);\r\naead_request_set_ad(aead_req, sg[0].length);\r\nerr = crypto_aead_decrypt(aead_req);\r\nkzfree(aead_req);\r\nreturn err;\r\n}\r\nstruct crypto_aead *ieee80211_aes_key_setup_encrypt(const u8 key[],\r\nsize_t key_len,\r\nsize_t mic_len)\r\n{\r\nstruct crypto_aead *tfm;\r\nint err;\r\ntfm = crypto_alloc_aead("ccm(aes)", 0, CRYPTO_ALG_ASYNC);\r\nif (IS_ERR(tfm))\r\nreturn tfm;\r\nerr = crypto_aead_setkey(tfm, key, key_len);\r\nif (err)\r\ngoto free_aead;\r\nerr = crypto_aead_setauthsize(tfm, mic_len);\r\nif (err)\r\ngoto free_aead;\r\nreturn tfm;\r\nfree_aead:\r\ncrypto_free_aead(tfm);\r\nreturn ERR_PTR(err);\r\n}\r\nvoid ieee80211_aes_key_free(struct crypto_aead *tfm)\r\n{\r\ncrypto_free_aead(tfm);\r\n}

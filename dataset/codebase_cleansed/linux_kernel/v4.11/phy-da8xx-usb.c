static int da8xx_usb11_phy_power_on(struct phy *phy)\r\n{\r\nstruct da8xx_usb_phy *d_phy = phy_get_drvdata(phy);\r\nint ret;\r\nret = clk_prepare_enable(d_phy->usb11_clk);\r\nif (ret)\r\nreturn ret;\r\nregmap_write_bits(d_phy->regmap, CFGCHIP(2), CFGCHIP2_USB1SUSPENDM,\r\nCFGCHIP2_USB1SUSPENDM);\r\nreturn 0;\r\n}\r\nstatic int da8xx_usb11_phy_power_off(struct phy *phy)\r\n{\r\nstruct da8xx_usb_phy *d_phy = phy_get_drvdata(phy);\r\nregmap_write_bits(d_phy->regmap, CFGCHIP(2), CFGCHIP2_USB1SUSPENDM, 0);\r\nclk_disable_unprepare(d_phy->usb11_clk);\r\nreturn 0;\r\n}\r\nstatic int da8xx_usb20_phy_power_on(struct phy *phy)\r\n{\r\nstruct da8xx_usb_phy *d_phy = phy_get_drvdata(phy);\r\nint ret;\r\nret = clk_prepare_enable(d_phy->usb20_clk);\r\nif (ret)\r\nreturn ret;\r\nregmap_write_bits(d_phy->regmap, CFGCHIP(2), CFGCHIP2_OTGPWRDN, 0);\r\nreturn 0;\r\n}\r\nstatic int da8xx_usb20_phy_power_off(struct phy *phy)\r\n{\r\nstruct da8xx_usb_phy *d_phy = phy_get_drvdata(phy);\r\nregmap_write_bits(d_phy->regmap, CFGCHIP(2), CFGCHIP2_OTGPWRDN,\r\nCFGCHIP2_OTGPWRDN);\r\nclk_disable_unprepare(d_phy->usb20_clk);\r\nreturn 0;\r\n}\r\nstatic int da8xx_usb20_phy_set_mode(struct phy *phy, enum phy_mode mode)\r\n{\r\nstruct da8xx_usb_phy *d_phy = phy_get_drvdata(phy);\r\nu32 val;\r\nswitch (mode) {\r\ncase PHY_MODE_USB_HOST:\r\nval = CFGCHIP2_OTGMODE_FORCE_HOST;\r\nbreak;\r\ncase PHY_MODE_USB_DEVICE:\r\nval = CFGCHIP2_OTGMODE_FORCE_DEVICE;\r\nbreak;\r\ncase PHY_MODE_USB_OTG:\r\nval = CFGCHIP2_OTGMODE_NO_OVERRIDE;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nregmap_write_bits(d_phy->regmap, CFGCHIP(2), CFGCHIP2_OTGMODE_MASK,\r\nval);\r\nreturn 0;\r\n}\r\nstatic struct phy *da8xx_usb_phy_of_xlate(struct device *dev,\r\nstruct of_phandle_args *args)\r\n{\r\nstruct da8xx_usb_phy *d_phy = dev_get_drvdata(dev);\r\nif (!d_phy)\r\nreturn ERR_PTR(-ENODEV);\r\nswitch (args->args[0]) {\r\ncase 0:\r\nreturn d_phy->usb20_phy;\r\ncase 1:\r\nreturn d_phy->usb11_phy;\r\ndefault:\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\n}\r\nstatic int da8xx_usb_phy_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *node = dev->of_node;\r\nstruct da8xx_usb_phy *d_phy;\r\nd_phy = devm_kzalloc(dev, sizeof(*d_phy), GFP_KERNEL);\r\nif (!d_phy)\r\nreturn -ENOMEM;\r\nif (node)\r\nd_phy->regmap = syscon_regmap_lookup_by_compatible(\r\n"ti,da830-cfgchip");\r\nelse\r\nd_phy->regmap = syscon_regmap_lookup_by_pdevname("syscon");\r\nif (IS_ERR(d_phy->regmap)) {\r\ndev_err(dev, "Failed to get syscon\n");\r\nreturn PTR_ERR(d_phy->regmap);\r\n}\r\nd_phy->usb11_clk = devm_clk_get(dev, "usb11_phy");\r\nif (IS_ERR(d_phy->usb11_clk)) {\r\ndev_err(dev, "Failed to get usb11_phy clock\n");\r\nreturn PTR_ERR(d_phy->usb11_clk);\r\n}\r\nd_phy->usb20_clk = devm_clk_get(dev, "usb20_phy");\r\nif (IS_ERR(d_phy->usb20_clk)) {\r\ndev_err(dev, "Failed to get usb20_phy clock\n");\r\nreturn PTR_ERR(d_phy->usb20_clk);\r\n}\r\nd_phy->usb11_phy = devm_phy_create(dev, node, &da8xx_usb11_phy_ops);\r\nif (IS_ERR(d_phy->usb11_phy)) {\r\ndev_err(dev, "Failed to create usb11 phy\n");\r\nreturn PTR_ERR(d_phy->usb11_phy);\r\n}\r\nd_phy->usb20_phy = devm_phy_create(dev, node, &da8xx_usb20_phy_ops);\r\nif (IS_ERR(d_phy->usb20_phy)) {\r\ndev_err(dev, "Failed to create usb20 phy\n");\r\nreturn PTR_ERR(d_phy->usb20_phy);\r\n}\r\nplatform_set_drvdata(pdev, d_phy);\r\nphy_set_drvdata(d_phy->usb11_phy, d_phy);\r\nphy_set_drvdata(d_phy->usb20_phy, d_phy);\r\nif (node) {\r\nd_phy->phy_provider = devm_of_phy_provider_register(dev,\r\nda8xx_usb_phy_of_xlate);\r\nif (IS_ERR(d_phy->phy_provider)) {\r\ndev_err(dev, "Failed to create phy provider\n");\r\nreturn PTR_ERR(d_phy->phy_provider);\r\n}\r\n} else {\r\nint ret;\r\nret = phy_create_lookup(d_phy->usb11_phy, "usb-phy",\r\n"ohci-da8xx");\r\nif (ret)\r\ndev_warn(dev, "Failed to create usb11 phy lookup\n");\r\nret = phy_create_lookup(d_phy->usb20_phy, "usb-phy",\r\n"musb-da8xx");\r\nif (ret)\r\ndev_warn(dev, "Failed to create usb20 phy lookup\n");\r\n}\r\nregmap_write_bits(d_phy->regmap, CFGCHIP(2),\r\nPHY_INIT_BITS, PHY_INIT_BITS);\r\nreturn 0;\r\n}\r\nstatic int da8xx_usb_phy_remove(struct platform_device *pdev)\r\n{\r\nstruct da8xx_usb_phy *d_phy = platform_get_drvdata(pdev);\r\nif (!pdev->dev.of_node) {\r\nphy_remove_lookup(d_phy->usb20_phy, "usb-phy", "musb-da8xx");\r\nphy_remove_lookup(d_phy->usb11_phy, "usb-phy", "ohci-da8xx");\r\n}\r\nreturn 0;\r\n}

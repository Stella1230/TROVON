void iwl_write8(struct iwl_trans *trans, u32 ofs, u8 val)\r\n{\r\ntrace_iwlwifi_dev_iowrite8(trans->dev, ofs, val);\r\niwl_trans_write8(trans, ofs, val);\r\n}\r\nvoid iwl_write32(struct iwl_trans *trans, u32 ofs, u32 val)\r\n{\r\ntrace_iwlwifi_dev_iowrite32(trans->dev, ofs, val);\r\niwl_trans_write32(trans, ofs, val);\r\n}\r\nvoid iwl_write64(struct iwl_trans *trans, u64 ofs, u64 val)\r\n{\r\ntrace_iwlwifi_dev_iowrite64(trans->dev, ofs, val);\r\niwl_trans_write32(trans, ofs, val & 0xffffffff);\r\niwl_trans_write32(trans, ofs + 4, val >> 32);\r\n}\r\nu32 iwl_read32(struct iwl_trans *trans, u32 ofs)\r\n{\r\nu32 val = iwl_trans_read32(trans, ofs);\r\ntrace_iwlwifi_dev_ioread32(trans->dev, ofs, val);\r\nreturn val;\r\n}\r\nint iwl_poll_bit(struct iwl_trans *trans, u32 addr,\r\nu32 bits, u32 mask, int timeout)\r\n{\r\nint t = 0;\r\ndo {\r\nif ((iwl_read32(trans, addr) & mask) == (bits & mask))\r\nreturn t;\r\nudelay(IWL_POLL_INTERVAL);\r\nt += IWL_POLL_INTERVAL;\r\n} while (t < timeout);\r\nreturn -ETIMEDOUT;\r\n}\r\nu32 iwl_read_direct32(struct iwl_trans *trans, u32 reg)\r\n{\r\nu32 value = 0x5a5a5a5a;\r\nunsigned long flags;\r\nif (iwl_trans_grab_nic_access(trans, &flags)) {\r\nvalue = iwl_read32(trans, reg);\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\nreturn value;\r\n}\r\nvoid iwl_write_direct32(struct iwl_trans *trans, u32 reg, u32 value)\r\n{\r\nunsigned long flags;\r\nif (iwl_trans_grab_nic_access(trans, &flags)) {\r\niwl_write32(trans, reg, value);\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\n}\r\nvoid iwl_write_direct64(struct iwl_trans *trans, u64 reg, u64 value)\r\n{\r\nunsigned long flags;\r\nif (iwl_trans_grab_nic_access(trans, &flags)) {\r\niwl_write64(trans, reg, value);\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\n}\r\nint iwl_poll_direct_bit(struct iwl_trans *trans, u32 addr, u32 mask,\r\nint timeout)\r\n{\r\nint t = 0;\r\ndo {\r\nif ((iwl_read_direct32(trans, addr) & mask) == mask)\r\nreturn t;\r\nudelay(IWL_POLL_INTERVAL);\r\nt += IWL_POLL_INTERVAL;\r\n} while (t < timeout);\r\nreturn -ETIMEDOUT;\r\n}\r\nu32 iwl_read_prph_no_grab(struct iwl_trans *trans, u32 ofs)\r\n{\r\nu32 val = iwl_trans_read_prph(trans, ofs);\r\ntrace_iwlwifi_dev_ioread_prph32(trans->dev, ofs, val);\r\nreturn val;\r\n}\r\nvoid iwl_write_prph_no_grab(struct iwl_trans *trans, u32 ofs, u32 val)\r\n{\r\ntrace_iwlwifi_dev_iowrite_prph32(trans->dev, ofs, val);\r\niwl_trans_write_prph(trans, ofs, val);\r\n}\r\nvoid iwl_write_prph64_no_grab(struct iwl_trans *trans, u64 ofs, u64 val)\r\n{\r\ntrace_iwlwifi_dev_iowrite_prph64(trans->dev, ofs, val);\r\niwl_write_prph_no_grab(trans, ofs, val & 0xffffffff);\r\niwl_write_prph_no_grab(trans, ofs + 4, val >> 32);\r\n}\r\nu32 iwl_read_prph(struct iwl_trans *trans, u32 ofs)\r\n{\r\nunsigned long flags;\r\nu32 val = 0x5a5a5a5a;\r\nif (iwl_trans_grab_nic_access(trans, &flags)) {\r\nval = iwl_read_prph_no_grab(trans, ofs);\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\nreturn val;\r\n}\r\nvoid iwl_write_prph(struct iwl_trans *trans, u32 ofs, u32 val)\r\n{\r\nunsigned long flags;\r\nif (iwl_trans_grab_nic_access(trans, &flags)) {\r\niwl_write_prph_no_grab(trans, ofs, val);\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\n}\r\nint iwl_poll_prph_bit(struct iwl_trans *trans, u32 addr,\r\nu32 bits, u32 mask, int timeout)\r\n{\r\nint t = 0;\r\ndo {\r\nif ((iwl_read_prph(trans, addr) & mask) == (bits & mask))\r\nreturn t;\r\nudelay(IWL_POLL_INTERVAL);\r\nt += IWL_POLL_INTERVAL;\r\n} while (t < timeout);\r\nreturn -ETIMEDOUT;\r\n}\r\nvoid iwl_set_bits_prph(struct iwl_trans *trans, u32 ofs, u32 mask)\r\n{\r\nunsigned long flags;\r\nif (iwl_trans_grab_nic_access(trans, &flags)) {\r\niwl_write_prph_no_grab(trans, ofs,\r\niwl_read_prph_no_grab(trans, ofs) |\r\nmask);\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\n}\r\nvoid iwl_set_bits_mask_prph(struct iwl_trans *trans, u32 ofs,\r\nu32 bits, u32 mask)\r\n{\r\nunsigned long flags;\r\nif (iwl_trans_grab_nic_access(trans, &flags)) {\r\niwl_write_prph_no_grab(trans, ofs,\r\n(iwl_read_prph_no_grab(trans, ofs) &\r\nmask) | bits);\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\n}\r\nvoid iwl_clear_bits_prph(struct iwl_trans *trans, u32 ofs, u32 mask)\r\n{\r\nunsigned long flags;\r\nu32 val;\r\nif (iwl_trans_grab_nic_access(trans, &flags)) {\r\nval = iwl_read_prph_no_grab(trans, ofs);\r\niwl_write_prph_no_grab(trans, ofs, (val & ~mask));\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\n}\r\nvoid iwl_force_nmi(struct iwl_trans *trans)\r\n{\r\nif (trans->cfg->device_family != IWL_DEVICE_FAMILY_8000) {\r\niwl_write_prph(trans, DEVICE_SET_NMI_REG,\r\nDEVICE_SET_NMI_VAL_DRV);\r\niwl_write_prph(trans, DEVICE_SET_NMI_REG,\r\nDEVICE_SET_NMI_VAL_HW);\r\n} else {\r\niwl_write_prph(trans, DEVICE_SET_NMI_8000_REG,\r\nDEVICE_SET_NMI_8000_VAL);\r\niwl_write_prph(trans, DEVICE_SET_NMI_REG,\r\nDEVICE_SET_NMI_VAL_DRV);\r\n}\r\n}\r\nstatic const char *get_rfh_string(int cmd)\r\n{\r\n#define IWL_CMD(x) case x: return #x\r\n#define IWL_CMD_MQ(arg, reg, q) { if (arg == reg(q)) return #reg; }\r\nint i;\r\nfor (i = 0; i < IWL_MAX_RX_HW_QUEUES; i++) {\r\nIWL_CMD_MQ(cmd, RFH_Q_FRBDCB_BA_LSB, i);\r\nIWL_CMD_MQ(cmd, RFH_Q_FRBDCB_WIDX, i);\r\nIWL_CMD_MQ(cmd, RFH_Q_FRBDCB_RIDX, i);\r\nIWL_CMD_MQ(cmd, RFH_Q_URBD_STTS_WPTR_LSB, i);\r\n}\r\nswitch (cmd) {\r\nIWL_CMD(RFH_RXF_DMA_CFG);\r\nIWL_CMD(RFH_GEN_CFG);\r\nIWL_CMD(RFH_GEN_STATUS);\r\nIWL_CMD(FH_TSSR_TX_STATUS_REG);\r\nIWL_CMD(FH_TSSR_TX_ERROR_REG);\r\ndefault:\r\nreturn "UNKNOWN";\r\n}\r\n#undef IWL_CMD_MQ\r\n}\r\nstatic int iwl_dump_rfh(struct iwl_trans *trans, char **buf)\r\n{\r\nint i, q;\r\nint num_q = trans->num_rx_queues;\r\nstatic const u32 rfh_tbl[] = {\r\nRFH_RXF_DMA_CFG,\r\nRFH_GEN_CFG,\r\nRFH_GEN_STATUS,\r\nFH_TSSR_TX_STATUS_REG,\r\nFH_TSSR_TX_ERROR_REG,\r\n};\r\nstatic const struct reg rfh_mq_tbl[] = {\r\n{ RFH_Q0_FRBDCB_BA_LSB, true },\r\n{ RFH_Q0_FRBDCB_WIDX, false },\r\n{ RFH_Q0_FRBDCB_RIDX, false },\r\n{ RFH_Q0_URBD_STTS_WPTR_LSB, true },\r\n};\r\n#ifdef CONFIG_IWLWIFI_DEBUGFS\r\nif (buf) {\r\nint pos = 0;\r\nsize_t bufsz = ARRAY_SIZE(rfh_tbl) * 53 +\r\nARRAY_SIZE(rfh_mq_tbl) * 53 * num_q + 40;\r\n*buf = kmalloc(bufsz, GFP_KERNEL);\r\nif (!*buf)\r\nreturn -ENOMEM;\r\npos += scnprintf(*buf + pos, bufsz - pos,\r\n"RFH register values:\n");\r\nfor (i = 0; i < ARRAY_SIZE(rfh_tbl); i++)\r\npos += scnprintf(*buf + pos, bufsz - pos,\r\n"%40s: 0X%08x\n",\r\nget_rfh_string(rfh_tbl[i]),\r\niwl_read_prph(trans, rfh_tbl[i]));\r\nfor (i = 0; i < ARRAY_SIZE(rfh_mq_tbl); i++)\r\nfor (q = 0; q < num_q; q++) {\r\nu32 addr = rfh_mq_tbl[i].addr;\r\naddr += q * (rfh_mq_tbl[i].is64 ? 8 : 4);\r\npos += scnprintf(*buf + pos, bufsz - pos,\r\n"%34s(q %2d): 0X%08x\n",\r\nget_rfh_string(addr), q,\r\niwl_read_prph(trans, addr));\r\n}\r\nreturn pos;\r\n}\r\n#endif\r\nIWL_ERR(trans, "RFH register values:\n");\r\nfor (i = 0; i < ARRAY_SIZE(rfh_tbl); i++)\r\nIWL_ERR(trans, " %34s: 0X%08x\n",\r\nget_rfh_string(rfh_tbl[i]),\r\niwl_read_prph(trans, rfh_tbl[i]));\r\nfor (i = 0; i < ARRAY_SIZE(rfh_mq_tbl); i++)\r\nfor (q = 0; q < num_q; q++) {\r\nu32 addr = rfh_mq_tbl[i].addr;\r\naddr += q * (rfh_mq_tbl[i].is64 ? 8 : 4);\r\nIWL_ERR(trans, " %34s(q %d): 0X%08x\n",\r\nget_rfh_string(addr), q,\r\niwl_read_prph(trans, addr));\r\n}\r\nreturn 0;\r\n}\r\nstatic const char *get_fh_string(int cmd)\r\n{\r\nswitch (cmd) {\r\nIWL_CMD(FH_RSCSR_CHNL0_STTS_WPTR_REG);\r\nIWL_CMD(FH_RSCSR_CHNL0_RBDCB_BASE_REG);\r\nIWL_CMD(FH_RSCSR_CHNL0_WPTR);\r\nIWL_CMD(FH_MEM_RCSR_CHNL0_CONFIG_REG);\r\nIWL_CMD(FH_MEM_RSSR_SHARED_CTRL_REG);\r\nIWL_CMD(FH_MEM_RSSR_RX_STATUS_REG);\r\nIWL_CMD(FH_MEM_RSSR_RX_ENABLE_ERR_IRQ2DRV);\r\nIWL_CMD(FH_TSSR_TX_STATUS_REG);\r\nIWL_CMD(FH_TSSR_TX_ERROR_REG);\r\ndefault:\r\nreturn "UNKNOWN";\r\n}\r\n#undef IWL_CMD\r\n}\r\nint iwl_dump_fh(struct iwl_trans *trans, char **buf)\r\n{\r\nint i;\r\nstatic const u32 fh_tbl[] = {\r\nFH_RSCSR_CHNL0_STTS_WPTR_REG,\r\nFH_RSCSR_CHNL0_RBDCB_BASE_REG,\r\nFH_RSCSR_CHNL0_WPTR,\r\nFH_MEM_RCSR_CHNL0_CONFIG_REG,\r\nFH_MEM_RSSR_SHARED_CTRL_REG,\r\nFH_MEM_RSSR_RX_STATUS_REG,\r\nFH_MEM_RSSR_RX_ENABLE_ERR_IRQ2DRV,\r\nFH_TSSR_TX_STATUS_REG,\r\nFH_TSSR_TX_ERROR_REG\r\n};\r\nif (trans->cfg->mq_rx_supported)\r\nreturn iwl_dump_rfh(trans, buf);\r\n#ifdef CONFIG_IWLWIFI_DEBUGFS\r\nif (buf) {\r\nint pos = 0;\r\nsize_t bufsz = ARRAY_SIZE(fh_tbl) * 48 + 40;\r\n*buf = kmalloc(bufsz, GFP_KERNEL);\r\nif (!*buf)\r\nreturn -ENOMEM;\r\npos += scnprintf(*buf + pos, bufsz - pos,\r\n"FH register values:\n");\r\nfor (i = 0; i < ARRAY_SIZE(fh_tbl); i++)\r\npos += scnprintf(*buf + pos, bufsz - pos,\r\n" %34s: 0X%08x\n",\r\nget_fh_string(fh_tbl[i]),\r\niwl_read_direct32(trans, fh_tbl[i]));\r\nreturn pos;\r\n}\r\n#endif\r\nIWL_ERR(trans, "FH register values:\n");\r\nfor (i = 0; i < ARRAY_SIZE(fh_tbl); i++)\r\nIWL_ERR(trans, " %34s: 0X%08x\n",\r\nget_fh_string(fh_tbl[i]),\r\niwl_read_direct32(trans, fh_tbl[i]));\r\nreturn 0;\r\n}

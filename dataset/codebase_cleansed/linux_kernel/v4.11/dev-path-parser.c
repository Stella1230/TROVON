static int __init match_acpi_dev(struct device *dev, void *data)\r\n{\r\nstruct acpi_hid_uid hid_uid = *(struct acpi_hid_uid *)data;\r\nstruct acpi_device *adev = to_acpi_device(dev);\r\nif (acpi_match_device_ids(adev, hid_uid.hid))\r\nreturn 0;\r\nif (adev->pnp.unique_id)\r\nreturn !strcmp(adev->pnp.unique_id, hid_uid.uid);\r\nelse\r\nreturn !strcmp("0", hid_uid.uid);\r\n}\r\nstatic long __init parse_acpi_path(struct efi_dev_path *node,\r\nstruct device *parent, struct device **child)\r\n{\r\nstruct acpi_hid_uid hid_uid = {};\r\nstruct device *phys_dev;\r\nif (node->length != 12)\r\nreturn -EINVAL;\r\nsprintf(hid_uid.hid[0].id, "%c%c%c%04X",\r\n'A' + ((node->acpi.hid >> 10) & 0x1f) - 1,\r\n'A' + ((node->acpi.hid >> 5) & 0x1f) - 1,\r\n'A' + ((node->acpi.hid >> 0) & 0x1f) - 1,\r\nnode->acpi.hid >> 16);\r\nsprintf(hid_uid.uid, "%u", node->acpi.uid);\r\n*child = bus_find_device(&acpi_bus_type, NULL, &hid_uid,\r\nmatch_acpi_dev);\r\nif (!*child)\r\nreturn -ENODEV;\r\nphys_dev = acpi_get_first_physical_node(to_acpi_device(*child));\r\nif (phys_dev) {\r\nget_device(phys_dev);\r\nput_device(*child);\r\n*child = phys_dev;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init match_pci_dev(struct device *dev, void *data)\r\n{\r\nunsigned int devfn = *(unsigned int *)data;\r\nreturn dev_is_pci(dev) && to_pci_dev(dev)->devfn == devfn;\r\n}\r\nstatic long __init parse_pci_path(struct efi_dev_path *node,\r\nstruct device *parent, struct device **child)\r\n{\r\nunsigned int devfn;\r\nif (node->length != 6)\r\nreturn -EINVAL;\r\nif (!parent)\r\nreturn -EINVAL;\r\ndevfn = PCI_DEVFN(node->pci.dev, node->pci.fn);\r\n*child = device_find_child(parent, &devfn, match_pci_dev);\r\nif (!*child)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic long __init parse_end_path(struct efi_dev_path *node,\r\nstruct device *parent, struct device **child)\r\n{\r\nif (node->length != 4)\r\nreturn -EINVAL;\r\nif (node->sub_type != EFI_DEV_END_INSTANCE &&\r\nnode->sub_type != EFI_DEV_END_ENTIRE)\r\nreturn -EINVAL;\r\nif (!parent)\r\nreturn -ENODEV;\r\n*child = get_device(parent);\r\nreturn node->sub_type;\r\n}\r\nstruct device * __init efi_get_device_by_path(struct efi_dev_path **node,\r\nsize_t *len)\r\n{\r\nstruct device *parent = NULL, *child;\r\nlong ret = 0;\r\nif (!*len)\r\nreturn NULL;\r\nwhile (!ret) {\r\nif (*len < 4 || *len < (*node)->length)\r\nret = -EINVAL;\r\nelse if ((*node)->type == EFI_DEV_ACPI &&\r\n(*node)->sub_type == EFI_DEV_BASIC_ACPI)\r\nret = parse_acpi_path(*node, parent, &child);\r\nelse if ((*node)->type == EFI_DEV_HW &&\r\n(*node)->sub_type == EFI_DEV_PCI)\r\nret = parse_pci_path(*node, parent, &child);\r\nelse if (((*node)->type == EFI_DEV_END_PATH ||\r\n(*node)->type == EFI_DEV_END_PATH2))\r\nret = parse_end_path(*node, parent, &child);\r\nelse\r\nret = -ENOTSUPP;\r\nput_device(parent);\r\nif (ret < 0)\r\nreturn ERR_PTR(ret);\r\nparent = child;\r\n*node = (void *)*node + (*node)->length;\r\n*len -= (*node)->length;\r\n}\r\nif (ret == EFI_DEV_END_ENTIRE)\r\n*len = 0;\r\nreturn child;\r\n}

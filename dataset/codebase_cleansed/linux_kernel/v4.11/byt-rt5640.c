static int byt_rt5640_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nint ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, RT5640_SCLK_S_PLL1,\r\nparams_rate(params) * 256,\r\nSND_SOC_CLOCK_IN);\r\nif (ret < 0) {\r\ndev_err(codec_dai->dev, "can't set codec clock %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_pll(codec_dai, 0, RT5640_PLL1_S_BCLK1,\r\nparams_rate(params) * 64,\r\nparams_rate(params) * 256);\r\nif (ret < 0) {\r\ndev_err(codec_dai->dev, "can't set codec pll: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int byt_rt5640_quirk_cb(const struct dmi_system_id *id)\r\n{\r\nbyt_rt5640_quirk = (unsigned long)id->driver_data;\r\nreturn 1;\r\n}\r\nstatic int byt_rt5640_init(struct snd_soc_pcm_runtime *runtime)\r\n{\r\nint ret;\r\nstruct snd_soc_codec *codec = runtime->codec;\r\nstruct snd_soc_card *card = runtime->card;\r\nconst struct snd_soc_dapm_route *custom_map;\r\nint num_routes;\r\ncard->dapm.idle_bias_off = true;\r\nret = snd_soc_add_card_controls(card, byt_rt5640_controls,\r\nARRAY_SIZE(byt_rt5640_controls));\r\nif (ret) {\r\ndev_err(card->dev, "unable to add card controls\n");\r\nreturn ret;\r\n}\r\ndmi_check_system(byt_rt5640_quirk_table);\r\nswitch (BYT_RT5640_MAP(byt_rt5640_quirk)) {\r\ncase BYT_RT5640_IN1_MAP:\r\ncustom_map = byt_rt5640_intmic_in1_map;\r\nnum_routes = ARRAY_SIZE(byt_rt5640_intmic_in1_map);\r\nbreak;\r\ncase BYT_RT5640_DMIC2_MAP:\r\ncustom_map = byt_rt5640_intmic_dmic2_map;\r\nnum_routes = ARRAY_SIZE(byt_rt5640_intmic_dmic2_map);\r\nbreak;\r\ndefault:\r\ncustom_map = byt_rt5640_intmic_dmic1_map;\r\nnum_routes = ARRAY_SIZE(byt_rt5640_intmic_dmic1_map);\r\n}\r\nret = snd_soc_dapm_add_routes(&card->dapm, custom_map, num_routes);\r\nif (ret)\r\nreturn ret;\r\nif (byt_rt5640_quirk & BYT_RT5640_DMIC_EN) {\r\nret = rt5640_dmic_enable(codec, 0, 0);\r\nif (ret)\r\nreturn ret;\r\n}\r\nsnd_soc_dapm_ignore_suspend(&card->dapm, "Headphone");\r\nsnd_soc_dapm_ignore_suspend(&card->dapm, "Speaker");\r\nreturn ret;\r\n}\r\nstatic int byt_rt5640_probe(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = &byt_rt5640_card;\r\ncard->dev = &pdev->dev;\r\nreturn devm_snd_soc_register_card(&pdev->dev, card);\r\n}

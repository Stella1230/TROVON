static unsigned int ad9834_calc_freqreg(unsigned long mclk, unsigned long fout)\r\n{\r\nunsigned long long freqreg = (u64)fout * (u64)BIT(AD9834_FREQ_BITS);\r\ndo_div(freqreg, mclk);\r\nreturn freqreg;\r\n}\r\nstatic int ad9834_write_frequency(struct ad9834_state *st,\r\nunsigned long addr, unsigned long fout)\r\n{\r\nunsigned long regval;\r\nif (fout > (st->mclk / 2))\r\nreturn -EINVAL;\r\nregval = ad9834_calc_freqreg(st->mclk, fout);\r\nst->freq_data[0] = cpu_to_be16(addr | (regval &\r\nRES_MASK(AD9834_FREQ_BITS / 2)));\r\nst->freq_data[1] = cpu_to_be16(addr | ((regval >>\r\n(AD9834_FREQ_BITS / 2)) &\r\nRES_MASK(AD9834_FREQ_BITS / 2)));\r\nreturn spi_sync(st->spi, &st->freq_msg);\r\n}\r\nstatic int ad9834_write_phase(struct ad9834_state *st,\r\nunsigned long addr, unsigned long phase)\r\n{\r\nif (phase > BIT(AD9834_PHASE_BITS))\r\nreturn -EINVAL;\r\nst->data = cpu_to_be16(addr | phase);\r\nreturn spi_sync(st->spi, &st->msg);\r\n}\r\nstatic ssize_t ad9834_write(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ad9834_state *st = iio_priv(indio_dev);\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nint ret;\r\nunsigned long val;\r\nret = kstrtoul(buf, 10, &val);\r\nif (ret)\r\ngoto error_ret;\r\nmutex_lock(&indio_dev->mlock);\r\nswitch ((u32)this_attr->address) {\r\ncase AD9834_REG_FREQ0:\r\ncase AD9834_REG_FREQ1:\r\nret = ad9834_write_frequency(st, this_attr->address, val);\r\nbreak;\r\ncase AD9834_REG_PHASE0:\r\ncase AD9834_REG_PHASE1:\r\nret = ad9834_write_phase(st, this_attr->address, val);\r\nbreak;\r\ncase AD9834_OPBITEN:\r\nif (st->control & AD9834_MODE) {\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nif (val)\r\nst->control |= AD9834_OPBITEN;\r\nelse\r\nst->control &= ~AD9834_OPBITEN;\r\nst->data = cpu_to_be16(AD9834_REG_CMD | st->control);\r\nret = spi_sync(st->spi, &st->msg);\r\nbreak;\r\ncase AD9834_PIN_SW:\r\nif (val)\r\nst->control |= AD9834_PIN_SW;\r\nelse\r\nst->control &= ~AD9834_PIN_SW;\r\nst->data = cpu_to_be16(AD9834_REG_CMD | st->control);\r\nret = spi_sync(st->spi, &st->msg);\r\nbreak;\r\ncase AD9834_FSEL:\r\ncase AD9834_PSEL:\r\nif (!val) {\r\nst->control &= ~(this_attr->address | AD9834_PIN_SW);\r\n} else if (val == 1) {\r\nst->control |= this_attr->address;\r\nst->control &= ~AD9834_PIN_SW;\r\n} else {\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nst->data = cpu_to_be16(AD9834_REG_CMD | st->control);\r\nret = spi_sync(st->spi, &st->msg);\r\nbreak;\r\ncase AD9834_RESET:\r\nif (val)\r\nst->control &= ~AD9834_RESET;\r\nelse\r\nst->control |= AD9834_RESET;\r\nst->data = cpu_to_be16(AD9834_REG_CMD | st->control);\r\nret = spi_sync(st->spi, &st->msg);\r\nbreak;\r\ndefault:\r\nret = -ENODEV;\r\n}\r\nmutex_unlock(&indio_dev->mlock);\r\nerror_ret:\r\nreturn ret ? ret : len;\r\n}\r\nstatic ssize_t ad9834_store_wavetype(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ad9834_state *st = iio_priv(indio_dev);\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nint ret = 0;\r\nbool is_ad9833_7 = (st->devid == ID_AD9833) || (st->devid == ID_AD9837);\r\nmutex_lock(&indio_dev->mlock);\r\nswitch ((u32)this_attr->address) {\r\ncase 0:\r\nif (sysfs_streq(buf, "sine")) {\r\nst->control &= ~AD9834_MODE;\r\nif (is_ad9833_7)\r\nst->control &= ~AD9834_OPBITEN;\r\n} else if (sysfs_streq(buf, "triangle")) {\r\nif (is_ad9833_7) {\r\nst->control &= ~AD9834_OPBITEN;\r\nst->control |= AD9834_MODE;\r\n} else if (st->control & AD9834_OPBITEN) {\r\nret = -EINVAL;\r\n} else {\r\nst->control |= AD9834_MODE;\r\n}\r\n} else if (is_ad9833_7 && sysfs_streq(buf, "square")) {\r\nst->control &= ~AD9834_MODE;\r\nst->control |= AD9834_OPBITEN;\r\n} else {\r\nret = -EINVAL;\r\n}\r\nbreak;\r\ncase 1:\r\nif (sysfs_streq(buf, "square") &&\r\n!(st->control & AD9834_MODE)) {\r\nst->control &= ~AD9834_MODE;\r\nst->control |= AD9834_OPBITEN;\r\n} else {\r\nret = -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nif (!ret) {\r\nst->data = cpu_to_be16(AD9834_REG_CMD | st->control);\r\nret = spi_sync(st->spi, &st->msg);\r\n}\r\nmutex_unlock(&indio_dev->mlock);\r\nreturn ret ? ret : len;\r\n}\r\nstatic\r\nssize_t ad9834_show_out0_wavetype_available(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ad9834_state *st = iio_priv(indio_dev);\r\nchar *str;\r\nif ((st->devid == ID_AD9833) || (st->devid == ID_AD9837))\r\nstr = "sine triangle square";\r\nelse if (st->control & AD9834_OPBITEN)\r\nstr = "sine";\r\nelse\r\nstr = "sine triangle";\r\nreturn sprintf(buf, "%s\n", str);\r\n}\r\nstatic\r\nssize_t ad9834_show_out1_wavetype_available(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ad9834_state *st = iio_priv(indio_dev);\r\nchar *str;\r\nif (st->control & AD9834_MODE)\r\nstr = "";\r\nelse\r\nstr = "square";\r\nreturn sprintf(buf, "%s\n", str);\r\n}\r\nstatic int ad9834_probe(struct spi_device *spi)\r\n{\r\nstruct ad9834_platform_data *pdata = dev_get_platdata(&spi->dev);\r\nstruct ad9834_state *st;\r\nstruct iio_dev *indio_dev;\r\nstruct regulator *reg;\r\nint ret;\r\nif (!pdata) {\r\ndev_dbg(&spi->dev, "no platform data?\n");\r\nreturn -ENODEV;\r\n}\r\nreg = devm_regulator_get(&spi->dev, "avdd");\r\nif (IS_ERR(reg))\r\nreturn PTR_ERR(reg);\r\nret = regulator_enable(reg);\r\nif (ret) {\r\ndev_err(&spi->dev, "Failed to enable specified AVDD supply\n");\r\nreturn ret;\r\n}\r\nindio_dev = devm_iio_device_alloc(&spi->dev, sizeof(*st));\r\nif (!indio_dev) {\r\nret = -ENOMEM;\r\ngoto error_disable_reg;\r\n}\r\nspi_set_drvdata(spi, indio_dev);\r\nst = iio_priv(indio_dev);\r\nst->mclk = pdata->mclk;\r\nst->spi = spi;\r\nst->devid = spi_get_device_id(spi)->driver_data;\r\nst->reg = reg;\r\nindio_dev->dev.parent = &spi->dev;\r\nindio_dev->name = spi_get_device_id(spi)->name;\r\nswitch (st->devid) {\r\ncase ID_AD9833:\r\ncase ID_AD9837:\r\nindio_dev->info = &ad9833_info;\r\nbreak;\r\ndefault:\r\nindio_dev->info = &ad9834_info;\r\nbreak;\r\n}\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nst->xfer.tx_buf = &st->data;\r\nst->xfer.len = 2;\r\nspi_message_init(&st->msg);\r\nspi_message_add_tail(&st->xfer, &st->msg);\r\nst->freq_xfer[0].tx_buf = &st->freq_data[0];\r\nst->freq_xfer[0].len = 2;\r\nst->freq_xfer[0].cs_change = 1;\r\nst->freq_xfer[1].tx_buf = &st->freq_data[1];\r\nst->freq_xfer[1].len = 2;\r\nspi_message_init(&st->freq_msg);\r\nspi_message_add_tail(&st->freq_xfer[0], &st->freq_msg);\r\nspi_message_add_tail(&st->freq_xfer[1], &st->freq_msg);\r\nst->control = AD9834_B28 | AD9834_RESET;\r\nif (!pdata->en_div2)\r\nst->control |= AD9834_DIV2;\r\nif (!pdata->en_signbit_msb_out && (st->devid == ID_AD9834))\r\nst->control |= AD9834_SIGN_PIB;\r\nst->data = cpu_to_be16(AD9834_REG_CMD | st->control);\r\nret = spi_sync(st->spi, &st->msg);\r\nif (ret) {\r\ndev_err(&spi->dev, "device init failed\n");\r\ngoto error_disable_reg;\r\n}\r\nret = ad9834_write_frequency(st, AD9834_REG_FREQ0, pdata->freq0);\r\nif (ret)\r\ngoto error_disable_reg;\r\nret = ad9834_write_frequency(st, AD9834_REG_FREQ1, pdata->freq1);\r\nif (ret)\r\ngoto error_disable_reg;\r\nret = ad9834_write_phase(st, AD9834_REG_PHASE0, pdata->phase0);\r\nif (ret)\r\ngoto error_disable_reg;\r\nret = ad9834_write_phase(st, AD9834_REG_PHASE1, pdata->phase1);\r\nif (ret)\r\ngoto error_disable_reg;\r\nret = iio_device_register(indio_dev);\r\nif (ret)\r\ngoto error_disable_reg;\r\nreturn 0;\r\nerror_disable_reg:\r\nregulator_disable(reg);\r\nreturn ret;\r\n}\r\nstatic int ad9834_remove(struct spi_device *spi)\r\n{\r\nstruct iio_dev *indio_dev = spi_get_drvdata(spi);\r\nstruct ad9834_state *st = iio_priv(indio_dev);\r\niio_device_unregister(indio_dev);\r\nregulator_disable(st->reg);\r\nreturn 0;\r\n}

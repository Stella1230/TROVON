static inline int need_bs_quote(char c)\r\n{\r\nreturn (c == '\'' || c == '!');\r\n}\r\nstatic int sq_quote_buf(struct strbuf *dst, const char *src)\r\n{\r\nchar *to_free = NULL;\r\nint ret;\r\nif (dst->buf == src)\r\nto_free = strbuf_detach(dst, NULL);\r\nret = strbuf_addch(dst, '\'');\r\nwhile (!ret && *src) {\r\nsize_t len = strcspn(src, "'!");\r\nret = strbuf_add(dst, src, len);\r\nsrc += len;\r\nwhile (!ret && need_bs_quote(*src))\r\nret = strbuf_addf(dst, "'\\%c\'", *src++);\r\n}\r\nif (!ret)\r\nret = strbuf_addch(dst, '\'');\r\nfree(to_free);\r\nreturn ret;\r\n}\r\nint sq_quote_argv(struct strbuf *dst, const char** argv, size_t maxlen)\r\n{\r\nint i, ret;\r\nret = strbuf_grow(dst, 255);\r\nfor (i = 0; !ret && argv[i]; ++i) {\r\nret = strbuf_addch(dst, ' ');\r\nif (ret)\r\nbreak;\r\nret = sq_quote_buf(dst, argv[i]);\r\nif (maxlen && dst->len > maxlen)\r\nreturn -ENOSPC;\r\n}\r\nreturn ret;\r\n}

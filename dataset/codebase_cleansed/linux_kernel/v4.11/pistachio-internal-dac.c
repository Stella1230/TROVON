static void pistachio_internal_dac_reg_writel(struct regmap *top_regs,\r\nu32 val, u32 reg)\r\n{\r\nregmap_update_bits(top_regs, PISTACHIO_INTERNAL_DAC_GTI_CTRL,\r\nPISTACHIO_INTERNAL_DAC_GTI_CTRL_ADDR_MASK,\r\nreg << PISTACHIO_INTERNAL_DAC_GTI_CTRL_ADDR_SHIFT);\r\nregmap_update_bits(top_regs, PISTACHIO_INTERNAL_DAC_GTI_CTRL,\r\nPISTACHIO_INTERNAL_DAC_GTI_CTRL_WDATA_MASK,\r\nval << PISTACHIO_INTERNAL_DAC_GTI_CTRL_WDATA_SHIFT);\r\nregmap_update_bits(top_regs, PISTACHIO_INTERNAL_DAC_GTI_CTRL,\r\nPISTACHIO_INTERNAL_DAC_GTI_CTRL_WE_MASK,\r\nPISTACHIO_INTERNAL_DAC_GTI_CTRL_WE_MASK);\r\nregmap_update_bits(top_regs, PISTACHIO_INTERNAL_DAC_GTI_CTRL,\r\nPISTACHIO_INTERNAL_DAC_GTI_CTRL_WE_MASK, 0);\r\n}\r\nstatic void pistachio_internal_dac_pwr_off(struct pistachio_internal_dac *dac)\r\n{\r\nregmap_update_bits(dac->regmap, PISTACHIO_INTERNAL_DAC_CTRL,\r\nPISTACHIO_INTERNAL_DAC_CTRL_PWRDN_MASK,\r\nPISTACHIO_INTERNAL_DAC_CTRL_PWRDN_MASK);\r\npistachio_internal_dac_reg_writel(dac->regmap, 0,\r\nPISTACHIO_INTERNAL_DAC_PWR);\r\n}\r\nstatic void pistachio_internal_dac_pwr_on(struct pistachio_internal_dac *dac)\r\n{\r\nregmap_update_bits(dac->regmap, PISTACHIO_INTERNAL_DAC_SRST,\r\nPISTACHIO_INTERNAL_DAC_SRST_MASK,\r\nPISTACHIO_INTERNAL_DAC_SRST_MASK);\r\nregmap_update_bits(dac->regmap, PISTACHIO_INTERNAL_DAC_SRST,\r\nPISTACHIO_INTERNAL_DAC_SRST_MASK, 0);\r\npistachio_internal_dac_reg_writel(dac->regmap,\r\nPISTACHIO_INTERNAL_DAC_PWR_MASK,\r\nPISTACHIO_INTERNAL_DAC_PWR);\r\nregmap_update_bits(dac->regmap, PISTACHIO_INTERNAL_DAC_CTRL,\r\nPISTACHIO_INTERNAL_DAC_CTRL_PWRDN_MASK, 0);\r\n}\r\nstatic int pistachio_internal_dac_codec_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct pistachio_internal_dac *dac = snd_soc_codec_get_drvdata(codec);\r\nsnd_soc_codec_init_regmap(codec, dac->regmap);\r\nreturn 0;\r\n}\r\nstatic int pistachio_internal_dac_probe(struct platform_device *pdev)\r\n{\r\nstruct pistachio_internal_dac *dac;\r\nint ret, voltage;\r\nstruct device *dev = &pdev->dev;\r\nu32 reg;\r\ndac = devm_kzalloc(dev, sizeof(*dac), GFP_KERNEL);\r\nif (!dac)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, dac);\r\ndac->regmap = syscon_regmap_lookup_by_phandle(pdev->dev.of_node,\r\n"img,cr-top");\r\nif (IS_ERR(dac->regmap))\r\nreturn PTR_ERR(dac->regmap);\r\ndac->supply = devm_regulator_get(dev, "VDD");\r\nif (IS_ERR(dac->supply)) {\r\nret = PTR_ERR(dac->supply);\r\nif (ret != -EPROBE_DEFER)\r\ndev_err(dev, "failed to acquire supply 'VDD-supply': %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regulator_enable(dac->supply);\r\nif (ret) {\r\ndev_err(dev, "failed to enable supply: %d\n", ret);\r\nreturn ret;\r\n}\r\nvoltage = regulator_get_voltage(dac->supply);\r\nswitch (voltage) {\r\ncase 1800000:\r\nreg = 0;\r\nbreak;\r\ncase 3300000:\r\nreg = PISTACHIO_INTERNAL_DAC_CTRL_PWR_SEL_MASK;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "invalid voltage: %d\n", voltage);\r\nret = -EINVAL;\r\ngoto err_regulator;\r\n}\r\nregmap_update_bits(dac->regmap, PISTACHIO_INTERNAL_DAC_CTRL,\r\nPISTACHIO_INTERNAL_DAC_CTRL_PWR_SEL_MASK, reg);\r\npistachio_internal_dac_pwr_off(dac);\r\npistachio_internal_dac_pwr_on(dac);\r\npm_runtime_set_active(dev);\r\npm_runtime_enable(dev);\r\npm_runtime_idle(dev);\r\nret = snd_soc_register_codec(dev, &pistachio_internal_dac_driver,\r\npistachio_internal_dac_dais,\r\nARRAY_SIZE(pistachio_internal_dac_dais));\r\nif (ret) {\r\ndev_err(dev, "failed to register codec: %d\n", ret);\r\ngoto err_pwr;\r\n}\r\nreturn 0;\r\nerr_pwr:\r\npm_runtime_disable(&pdev->dev);\r\npistachio_internal_dac_pwr_off(dac);\r\nerr_regulator:\r\nregulator_disable(dac->supply);\r\nreturn ret;\r\n}\r\nstatic int pistachio_internal_dac_remove(struct platform_device *pdev)\r\n{\r\nstruct pistachio_internal_dac *dac = dev_get_drvdata(&pdev->dev);\r\nsnd_soc_unregister_codec(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\npistachio_internal_dac_pwr_off(dac);\r\nregulator_disable(dac->supply);\r\nreturn 0;\r\n}\r\nstatic int pistachio_internal_dac_rt_resume(struct device *dev)\r\n{\r\nstruct pistachio_internal_dac *dac = dev_get_drvdata(dev);\r\nint ret;\r\nret = regulator_enable(dac->supply);\r\nif (ret) {\r\ndev_err(dev, "failed to enable supply: %d\n", ret);\r\nreturn ret;\r\n}\r\npistachio_internal_dac_pwr_on(dac);\r\nreturn 0;\r\n}\r\nstatic int pistachio_internal_dac_rt_suspend(struct device *dev)\r\n{\r\nstruct pistachio_internal_dac *dac = dev_get_drvdata(dev);\r\npistachio_internal_dac_pwr_off(dac);\r\nregulator_disable(dac->supply);\r\nreturn 0;\r\n}

void\r\nxfs_inobp_check(\r\nxfs_mount_t *mp,\r\nxfs_buf_t *bp)\r\n{\r\nint i;\r\nint j;\r\nxfs_dinode_t *dip;\r\nj = mp->m_inode_cluster_size >> mp->m_sb.sb_inodelog;\r\nfor (i = 0; i < j; i++) {\r\ndip = xfs_buf_offset(bp, i * mp->m_sb.sb_inodesize);\r\nif (!dip->di_next_unlinked) {\r\nxfs_alert(mp,\r\n"Detected bogus zero next_unlinked field in inode %d buffer 0x%llx.",\r\ni, (long long)bp->b_bn);\r\n}\r\n}\r\n}\r\nbool\r\nxfs_dinode_good_version(\r\nstruct xfs_mount *mp,\r\n__u8 version)\r\n{\r\nif (xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn version == 3;\r\nreturn version == 1 || version == 2;\r\n}\r\nstatic void\r\nxfs_inode_buf_verify(\r\nstruct xfs_buf *bp,\r\nbool readahead)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nint i;\r\nint ni;\r\nni = XFS_BB_TO_FSB(mp, bp->b_length) * mp->m_sb.sb_inopblock;\r\nfor (i = 0; i < ni; i++) {\r\nint di_ok;\r\nxfs_dinode_t *dip;\r\ndip = xfs_buf_offset(bp, (i << mp->m_sb.sb_inodelog));\r\ndi_ok = dip->di_magic == cpu_to_be16(XFS_DINODE_MAGIC) &&\r\nxfs_dinode_good_version(mp, dip->di_version);\r\nif (unlikely(XFS_TEST_ERROR(!di_ok, mp,\r\nXFS_ERRTAG_ITOBP_INOTOBP,\r\nXFS_RANDOM_ITOBP_INOTOBP))) {\r\nif (readahead) {\r\nbp->b_flags &= ~XBF_DONE;\r\nxfs_buf_ioerror(bp, -EIO);\r\nreturn;\r\n}\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nxfs_verifier_error(bp);\r\n#ifdef DEBUG\r\nxfs_alert(mp,\r\n"bad inode magic/vsn daddr %lld #%d (magic=%x)",\r\n(unsigned long long)bp->b_bn, i,\r\nbe16_to_cpu(dip->di_magic));\r\n#endif\r\n}\r\n}\r\nxfs_inobp_check(mp, bp);\r\n}\r\nstatic void\r\nxfs_inode_buf_read_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nxfs_inode_buf_verify(bp, false);\r\n}\r\nstatic void\r\nxfs_inode_buf_readahead_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nxfs_inode_buf_verify(bp, true);\r\n}\r\nstatic void\r\nxfs_inode_buf_write_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nxfs_inode_buf_verify(bp, false);\r\n}\r\nint\r\nxfs_imap_to_bp(\r\nstruct xfs_mount *mp,\r\nstruct xfs_trans *tp,\r\nstruct xfs_imap *imap,\r\nstruct xfs_dinode **dipp,\r\nstruct xfs_buf **bpp,\r\nuint buf_flags,\r\nuint iget_flags)\r\n{\r\nstruct xfs_buf *bp;\r\nint error;\r\nbuf_flags |= XBF_UNMAPPED;\r\nerror = xfs_trans_read_buf(mp, tp, mp->m_ddev_targp, imap->im_blkno,\r\n(int)imap->im_len, buf_flags, &bp,\r\n&xfs_inode_buf_ops);\r\nif (error) {\r\nif (error == -EAGAIN) {\r\nASSERT(buf_flags & XBF_TRYLOCK);\r\nreturn error;\r\n}\r\nif (error == -EFSCORRUPTED &&\r\n(iget_flags & XFS_IGET_UNTRUSTED))\r\nreturn -EINVAL;\r\nxfs_warn(mp, "%s: xfs_trans_read_buf() returned error %d.",\r\n__func__, error);\r\nreturn error;\r\n}\r\n*bpp = bp;\r\n*dipp = xfs_buf_offset(bp, imap->im_boffset);\r\nreturn 0;\r\n}\r\nvoid\r\nxfs_inode_from_disk(\r\nstruct xfs_inode *ip,\r\nstruct xfs_dinode *from)\r\n{\r\nstruct xfs_icdinode *to = &ip->i_d;\r\nstruct inode *inode = VFS_I(ip);\r\nto->di_version = from->di_version;\r\nif (to->di_version == 1) {\r\nset_nlink(inode, be16_to_cpu(from->di_onlink));\r\nto->di_projid_lo = 0;\r\nto->di_projid_hi = 0;\r\nto->di_version = 2;\r\n} else {\r\nset_nlink(inode, be32_to_cpu(from->di_nlink));\r\nto->di_projid_lo = be16_to_cpu(from->di_projid_lo);\r\nto->di_projid_hi = be16_to_cpu(from->di_projid_hi);\r\n}\r\nto->di_format = from->di_format;\r\nto->di_uid = be32_to_cpu(from->di_uid);\r\nto->di_gid = be32_to_cpu(from->di_gid);\r\nto->di_flushiter = be16_to_cpu(from->di_flushiter);\r\ninode->i_atime.tv_sec = (int)be32_to_cpu(from->di_atime.t_sec);\r\ninode->i_atime.tv_nsec = (int)be32_to_cpu(from->di_atime.t_nsec);\r\ninode->i_mtime.tv_sec = (int)be32_to_cpu(from->di_mtime.t_sec);\r\ninode->i_mtime.tv_nsec = (int)be32_to_cpu(from->di_mtime.t_nsec);\r\ninode->i_ctime.tv_sec = (int)be32_to_cpu(from->di_ctime.t_sec);\r\ninode->i_ctime.tv_nsec = (int)be32_to_cpu(from->di_ctime.t_nsec);\r\ninode->i_generation = be32_to_cpu(from->di_gen);\r\ninode->i_mode = be16_to_cpu(from->di_mode);\r\nto->di_size = be64_to_cpu(from->di_size);\r\nto->di_nblocks = be64_to_cpu(from->di_nblocks);\r\nto->di_extsize = be32_to_cpu(from->di_extsize);\r\nto->di_nextents = be32_to_cpu(from->di_nextents);\r\nto->di_anextents = be16_to_cpu(from->di_anextents);\r\nto->di_forkoff = from->di_forkoff;\r\nto->di_aformat = from->di_aformat;\r\nto->di_dmevmask = be32_to_cpu(from->di_dmevmask);\r\nto->di_dmstate = be16_to_cpu(from->di_dmstate);\r\nto->di_flags = be16_to_cpu(from->di_flags);\r\nif (to->di_version == 3) {\r\ninode->i_version = be64_to_cpu(from->di_changecount);\r\nto->di_crtime.t_sec = be32_to_cpu(from->di_crtime.t_sec);\r\nto->di_crtime.t_nsec = be32_to_cpu(from->di_crtime.t_nsec);\r\nto->di_flags2 = be64_to_cpu(from->di_flags2);\r\nto->di_cowextsize = be32_to_cpu(from->di_cowextsize);\r\n}\r\n}\r\nvoid\r\nxfs_inode_to_disk(\r\nstruct xfs_inode *ip,\r\nstruct xfs_dinode *to,\r\nxfs_lsn_t lsn)\r\n{\r\nstruct xfs_icdinode *from = &ip->i_d;\r\nstruct inode *inode = VFS_I(ip);\r\nto->di_magic = cpu_to_be16(XFS_DINODE_MAGIC);\r\nto->di_onlink = 0;\r\nto->di_version = from->di_version;\r\nto->di_format = from->di_format;\r\nto->di_uid = cpu_to_be32(from->di_uid);\r\nto->di_gid = cpu_to_be32(from->di_gid);\r\nto->di_projid_lo = cpu_to_be16(from->di_projid_lo);\r\nto->di_projid_hi = cpu_to_be16(from->di_projid_hi);\r\nmemset(to->di_pad, 0, sizeof(to->di_pad));\r\nto->di_atime.t_sec = cpu_to_be32(inode->i_atime.tv_sec);\r\nto->di_atime.t_nsec = cpu_to_be32(inode->i_atime.tv_nsec);\r\nto->di_mtime.t_sec = cpu_to_be32(inode->i_mtime.tv_sec);\r\nto->di_mtime.t_nsec = cpu_to_be32(inode->i_mtime.tv_nsec);\r\nto->di_ctime.t_sec = cpu_to_be32(inode->i_ctime.tv_sec);\r\nto->di_ctime.t_nsec = cpu_to_be32(inode->i_ctime.tv_nsec);\r\nto->di_nlink = cpu_to_be32(inode->i_nlink);\r\nto->di_gen = cpu_to_be32(inode->i_generation);\r\nto->di_mode = cpu_to_be16(inode->i_mode);\r\nto->di_size = cpu_to_be64(from->di_size);\r\nto->di_nblocks = cpu_to_be64(from->di_nblocks);\r\nto->di_extsize = cpu_to_be32(from->di_extsize);\r\nto->di_nextents = cpu_to_be32(from->di_nextents);\r\nto->di_anextents = cpu_to_be16(from->di_anextents);\r\nto->di_forkoff = from->di_forkoff;\r\nto->di_aformat = from->di_aformat;\r\nto->di_dmevmask = cpu_to_be32(from->di_dmevmask);\r\nto->di_dmstate = cpu_to_be16(from->di_dmstate);\r\nto->di_flags = cpu_to_be16(from->di_flags);\r\nif (from->di_version == 3) {\r\nto->di_changecount = cpu_to_be64(inode->i_version);\r\nto->di_crtime.t_sec = cpu_to_be32(from->di_crtime.t_sec);\r\nto->di_crtime.t_nsec = cpu_to_be32(from->di_crtime.t_nsec);\r\nto->di_flags2 = cpu_to_be64(from->di_flags2);\r\nto->di_cowextsize = cpu_to_be32(from->di_cowextsize);\r\nto->di_ino = cpu_to_be64(ip->i_ino);\r\nto->di_lsn = cpu_to_be64(lsn);\r\nmemset(to->di_pad2, 0, sizeof(to->di_pad2));\r\nuuid_copy(&to->di_uuid, &ip->i_mount->m_sb.sb_meta_uuid);\r\nto->di_flushiter = 0;\r\n} else {\r\nto->di_flushiter = cpu_to_be16(from->di_flushiter);\r\n}\r\n}\r\nvoid\r\nxfs_log_dinode_to_disk(\r\nstruct xfs_log_dinode *from,\r\nstruct xfs_dinode *to)\r\n{\r\nto->di_magic = cpu_to_be16(from->di_magic);\r\nto->di_mode = cpu_to_be16(from->di_mode);\r\nto->di_version = from->di_version;\r\nto->di_format = from->di_format;\r\nto->di_onlink = 0;\r\nto->di_uid = cpu_to_be32(from->di_uid);\r\nto->di_gid = cpu_to_be32(from->di_gid);\r\nto->di_nlink = cpu_to_be32(from->di_nlink);\r\nto->di_projid_lo = cpu_to_be16(from->di_projid_lo);\r\nto->di_projid_hi = cpu_to_be16(from->di_projid_hi);\r\nmemcpy(to->di_pad, from->di_pad, sizeof(to->di_pad));\r\nto->di_atime.t_sec = cpu_to_be32(from->di_atime.t_sec);\r\nto->di_atime.t_nsec = cpu_to_be32(from->di_atime.t_nsec);\r\nto->di_mtime.t_sec = cpu_to_be32(from->di_mtime.t_sec);\r\nto->di_mtime.t_nsec = cpu_to_be32(from->di_mtime.t_nsec);\r\nto->di_ctime.t_sec = cpu_to_be32(from->di_ctime.t_sec);\r\nto->di_ctime.t_nsec = cpu_to_be32(from->di_ctime.t_nsec);\r\nto->di_size = cpu_to_be64(from->di_size);\r\nto->di_nblocks = cpu_to_be64(from->di_nblocks);\r\nto->di_extsize = cpu_to_be32(from->di_extsize);\r\nto->di_nextents = cpu_to_be32(from->di_nextents);\r\nto->di_anextents = cpu_to_be16(from->di_anextents);\r\nto->di_forkoff = from->di_forkoff;\r\nto->di_aformat = from->di_aformat;\r\nto->di_dmevmask = cpu_to_be32(from->di_dmevmask);\r\nto->di_dmstate = cpu_to_be16(from->di_dmstate);\r\nto->di_flags = cpu_to_be16(from->di_flags);\r\nto->di_gen = cpu_to_be32(from->di_gen);\r\nif (from->di_version == 3) {\r\nto->di_changecount = cpu_to_be64(from->di_changecount);\r\nto->di_crtime.t_sec = cpu_to_be32(from->di_crtime.t_sec);\r\nto->di_crtime.t_nsec = cpu_to_be32(from->di_crtime.t_nsec);\r\nto->di_flags2 = cpu_to_be64(from->di_flags2);\r\nto->di_cowextsize = cpu_to_be32(from->di_cowextsize);\r\nto->di_ino = cpu_to_be64(from->di_ino);\r\nto->di_lsn = cpu_to_be64(from->di_lsn);\r\nmemcpy(to->di_pad2, from->di_pad2, sizeof(to->di_pad2));\r\nuuid_copy(&to->di_uuid, &from->di_uuid);\r\nto->di_flushiter = 0;\r\n} else {\r\nto->di_flushiter = cpu_to_be16(from->di_flushiter);\r\n}\r\n}\r\nstatic bool\r\nxfs_dinode_verify(\r\nstruct xfs_mount *mp,\r\nxfs_ino_t ino,\r\nstruct xfs_dinode *dip)\r\n{\r\nuint16_t mode;\r\nuint16_t flags;\r\nuint64_t flags2;\r\nif (dip->di_magic != cpu_to_be16(XFS_DINODE_MAGIC))\r\nreturn false;\r\nif (be64_to_cpu(dip->di_size) & (1ULL << 63))\r\nreturn false;\r\nmode = be16_to_cpu(dip->di_mode);\r\nif (mode && xfs_mode_to_ftype(mode) == XFS_DIR3_FT_UNKNOWN)\r\nreturn false;\r\nif ((S_ISLNK(mode) || S_ISDIR(mode)) && dip->di_size == 0)\r\nreturn false;\r\nif (dip->di_version < 3)\r\nreturn true;\r\nif (!xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn false;\r\nif (!xfs_verify_cksum((char *)dip, mp->m_sb.sb_inodesize,\r\nXFS_DINODE_CRC_OFF))\r\nreturn false;\r\nif (be64_to_cpu(dip->di_ino) != ino)\r\nreturn false;\r\nif (!uuid_equal(&dip->di_uuid, &mp->m_sb.sb_meta_uuid))\r\nreturn false;\r\nflags = be16_to_cpu(dip->di_flags);\r\nflags2 = be64_to_cpu(dip->di_flags2);\r\nif ((flags2 & (XFS_DIFLAG2_REFLINK | XFS_DIFLAG2_COWEXTSIZE)) &&\r\n!xfs_sb_version_hasreflink(&mp->m_sb))\r\nreturn false;\r\nif ((flags2 & XFS_DIFLAG2_REFLINK) && (flags & XFS_DIFLAG_REALTIME))\r\nreturn false;\r\nif ((flags2 & XFS_DIFLAG2_REFLINK) && (flags2 & XFS_DIFLAG2_DAX))\r\nreturn false;\r\nreturn true;\r\n}\r\nvoid\r\nxfs_dinode_calc_crc(\r\nstruct xfs_mount *mp,\r\nstruct xfs_dinode *dip)\r\n{\r\n__uint32_t crc;\r\nif (dip->di_version < 3)\r\nreturn;\r\nASSERT(xfs_sb_version_hascrc(&mp->m_sb));\r\ncrc = xfs_start_cksum_update((char *)dip, mp->m_sb.sb_inodesize,\r\nXFS_DINODE_CRC_OFF);\r\ndip->di_crc = xfs_end_cksum(crc);\r\n}\r\nint\r\nxfs_iread(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_inode_t *ip,\r\nuint iget_flags)\r\n{\r\nxfs_buf_t *bp;\r\nxfs_dinode_t *dip;\r\nint error;\r\nerror = xfs_imap(mp, tp, ip->i_ino, &ip->i_imap, iget_flags);\r\nif (error)\r\nreturn error;\r\nif ((iget_flags & XFS_IGET_CREATE) &&\r\nxfs_sb_version_hascrc(&mp->m_sb) &&\r\n!(mp->m_flags & XFS_MOUNT_IKEEP)) {\r\nmemset(&ip->i_d, 0, sizeof(ip->i_d));\r\nVFS_I(ip)->i_generation = prandom_u32();\r\nif (xfs_sb_version_hascrc(&mp->m_sb))\r\nip->i_d.di_version = 3;\r\nelse\r\nip->i_d.di_version = 2;\r\nreturn 0;\r\n}\r\nerror = xfs_imap_to_bp(mp, tp, &ip->i_imap, &dip, &bp, 0, iget_flags);\r\nif (error)\r\nreturn error;\r\nif (!xfs_dinode_verify(mp, ip->i_ino, dip)) {\r\nxfs_alert(mp, "%s: validation failed for inode %lld failed",\r\n__func__, ip->i_ino);\r\nXFS_CORRUPTION_ERROR(__func__, XFS_ERRLEVEL_LOW, mp, dip);\r\nerror = -EFSCORRUPTED;\r\ngoto out_brelse;\r\n}\r\nif (dip->di_mode) {\r\nxfs_inode_from_disk(ip, dip);\r\nerror = xfs_iformat_fork(ip, dip);\r\nif (error) {\r\n#ifdef DEBUG\r\nxfs_alert(mp, "%s: xfs_iformat() returned error %d",\r\n__func__, error);\r\n#endif\r\ngoto out_brelse;\r\n}\r\n} else {\r\nip->i_d.di_version = dip->di_version;\r\nVFS_I(ip)->i_generation = be32_to_cpu(dip->di_gen);\r\nip->i_d.di_flushiter = be16_to_cpu(dip->di_flushiter);\r\nVFS_I(ip)->i_mode = 0;\r\n}\r\nASSERT(ip->i_d.di_version >= 2);\r\nip->i_delayed_blks = 0;\r\nxfs_buf_set_ref(bp, XFS_INO_REF);\r\nout_brelse:\r\nxfs_trans_brelse(tp, bp);\r\nreturn error;\r\n}

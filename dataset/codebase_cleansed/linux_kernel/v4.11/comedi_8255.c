static int subdev_8255_io(struct comedi_device *dev,\r\nint dir, int port, int data, unsigned long regbase)\r\n{\r\nif (dir) {\r\noutb(data, dev->iobase + regbase + port);\r\nreturn 0;\r\n}\r\nreturn inb(dev->iobase + regbase + port);\r\n}\r\nstatic int subdev_8255_mmio(struct comedi_device *dev,\r\nint dir, int port, int data, unsigned long regbase)\r\n{\r\nif (dir) {\r\nwriteb(data, dev->mmio + regbase + port);\r\nreturn 0;\r\n}\r\nreturn readb(dev->mmio + regbase + port);\r\n}\r\nstatic int subdev_8255_insn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct subdev_8255_private *spriv = s->private;\r\nunsigned long regbase = spriv->regbase;\r\nunsigned int mask;\r\nunsigned int v;\r\nmask = comedi_dio_update_state(s, data);\r\nif (mask) {\r\nif (mask & 0xff)\r\nspriv->io(dev, 1, I8255_DATA_A_REG,\r\ns->state & 0xff, regbase);\r\nif (mask & 0xff00)\r\nspriv->io(dev, 1, I8255_DATA_B_REG,\r\n(s->state >> 8) & 0xff, regbase);\r\nif (mask & 0xff0000)\r\nspriv->io(dev, 1, I8255_DATA_C_REG,\r\n(s->state >> 16) & 0xff, regbase);\r\n}\r\nv = spriv->io(dev, 0, I8255_DATA_A_REG, 0, regbase);\r\nv |= (spriv->io(dev, 0, I8255_DATA_B_REG, 0, regbase) << 8);\r\nv |= (spriv->io(dev, 0, I8255_DATA_C_REG, 0, regbase) << 16);\r\ndata[1] = v;\r\nreturn insn->n;\r\n}\r\nstatic void subdev_8255_do_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct subdev_8255_private *spriv = s->private;\r\nunsigned long regbase = spriv->regbase;\r\nint config;\r\nconfig = I8255_CTRL_CW;\r\nif (!(s->io_bits & 0x0000ff))\r\nconfig |= I8255_CTRL_A_IO;\r\nif (!(s->io_bits & 0x00ff00))\r\nconfig |= I8255_CTRL_B_IO;\r\nif (!(s->io_bits & 0x0f0000))\r\nconfig |= I8255_CTRL_C_LO_IO;\r\nif (!(s->io_bits & 0xf00000))\r\nconfig |= I8255_CTRL_C_HI_IO;\r\nspriv->io(dev, 1, I8255_CTRL_REG, config, regbase);\r\n}\r\nstatic int subdev_8255_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int mask;\r\nint ret;\r\nif (chan < 8)\r\nmask = 0x0000ff;\r\nelse if (chan < 16)\r\nmask = 0x00ff00;\r\nelse if (chan < 20)\r\nmask = 0x0f0000;\r\nelse\r\nmask = 0xf00000;\r\nret = comedi_dio_insn_config(dev, s, insn, data, mask);\r\nif (ret)\r\nreturn ret;\r\nsubdev_8255_do_config(dev, s);\r\nreturn insn->n;\r\n}\r\nstatic int __subdev_8255_init(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nint (*io)(struct comedi_device *dev,\r\nint dir, int port, int data,\r\nunsigned long regbase),\r\nunsigned long regbase,\r\nbool is_mmio)\r\n{\r\nstruct subdev_8255_private *spriv;\r\nspriv = comedi_alloc_spriv(s, sizeof(*spriv));\r\nif (!spriv)\r\nreturn -ENOMEM;\r\nif (io)\r\nspriv->io = io;\r\nelse if (is_mmio)\r\nspriv->io = subdev_8255_mmio;\r\nelse\r\nspriv->io = subdev_8255_io;\r\nspriv->regbase = regbase;\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 24;\r\ns->range_table = &range_digital;\r\ns->maxdata = 1;\r\ns->insn_bits = subdev_8255_insn;\r\ns->insn_config = subdev_8255_insn_config;\r\nsubdev_8255_do_config(dev, s);\r\nreturn 0;\r\n}\r\nint subdev_8255_init(struct comedi_device *dev, struct comedi_subdevice *s,\r\nint (*io)(struct comedi_device *dev, int dir, int port,\r\nint data, unsigned long regbase),\r\nunsigned long regbase)\r\n{\r\nreturn __subdev_8255_init(dev, s, io, regbase, false);\r\n}\r\nint subdev_8255_mm_init(struct comedi_device *dev, struct comedi_subdevice *s,\r\nint (*io)(struct comedi_device *dev, int dir, int port,\r\nint data, unsigned long regbase),\r\nunsigned long regbase)\r\n{\r\nreturn __subdev_8255_init(dev, s, io, regbase, true);\r\n}\r\nunsigned long subdev_8255_regbase(struct comedi_subdevice *s)\r\n{\r\nstruct subdev_8255_private *spriv = s->private;\r\nreturn spriv->regbase;\r\n}\r\nstatic int __init comedi_8255_module_init(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit comedi_8255_module_exit(void)\r\n{\r\n}

static ssize_t zcrypt_card_type_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct zcrypt_card *zc = to_ap_card(dev)->private;\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n", zc->type_string);\r\n}\r\nstatic ssize_t zcrypt_card_online_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct zcrypt_card *zc = to_ap_card(dev)->private;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", zc->online);\r\n}\r\nstatic ssize_t zcrypt_card_online_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct zcrypt_card *zc = to_ap_card(dev)->private;\r\nstruct zcrypt_queue *zq;\r\nint online, id;\r\nif (sscanf(buf, "%d\n", &online) != 1 || online < 0 || online > 1)\r\nreturn -EINVAL;\r\nzc->online = online;\r\nid = zc->card->id;\r\nZCRYPT_DBF(DBF_INFO, "card=%02x online=%d\n", id, online);\r\nspin_lock(&zcrypt_list_lock);\r\nlist_for_each_entry(zq, &zc->zqueues, list)\r\nzcrypt_queue_force_online(zq, online);\r\nspin_unlock(&zcrypt_list_lock);\r\nreturn count;\r\n}\r\nstruct zcrypt_card *zcrypt_card_alloc(void)\r\n{\r\nstruct zcrypt_card *zc;\r\nzc = kzalloc(sizeof(struct zcrypt_card), GFP_KERNEL);\r\nif (!zc)\r\nreturn NULL;\r\nINIT_LIST_HEAD(&zc->list);\r\nINIT_LIST_HEAD(&zc->zqueues);\r\nkref_init(&zc->refcount);\r\nreturn zc;\r\n}\r\nvoid zcrypt_card_free(struct zcrypt_card *zc)\r\n{\r\nkfree(zc);\r\n}\r\nstatic void zcrypt_card_release(struct kref *kref)\r\n{\r\nstruct zcrypt_card *zdev =\r\ncontainer_of(kref, struct zcrypt_card, refcount);\r\nzcrypt_card_free(zdev);\r\n}\r\nvoid zcrypt_card_get(struct zcrypt_card *zc)\r\n{\r\nkref_get(&zc->refcount);\r\n}\r\nint zcrypt_card_put(struct zcrypt_card *zc)\r\n{\r\nreturn kref_put(&zc->refcount, zcrypt_card_release);\r\n}\r\nint zcrypt_card_register(struct zcrypt_card *zc)\r\n{\r\nint rc;\r\nrc = sysfs_create_group(&zc->card->ap_dev.device.kobj,\r\n&zcrypt_card_attr_group);\r\nif (rc)\r\nreturn rc;\r\nspin_lock(&zcrypt_list_lock);\r\nlist_add_tail(&zc->list, &zcrypt_card_list);\r\nspin_unlock(&zcrypt_list_lock);\r\nzc->online = 1;\r\nZCRYPT_DBF(DBF_INFO, "card=%02x register online=1\n", zc->card->id);\r\nreturn rc;\r\n}\r\nvoid zcrypt_card_unregister(struct zcrypt_card *zc)\r\n{\r\nZCRYPT_DBF(DBF_INFO, "card=%02x unregister\n", zc->card->id);\r\nspin_lock(&zcrypt_list_lock);\r\nlist_del_init(&zc->list);\r\nspin_unlock(&zcrypt_list_lock);\r\nsysfs_remove_group(&zc->card->ap_dev.device.kobj,\r\n&zcrypt_card_attr_group);\r\n}

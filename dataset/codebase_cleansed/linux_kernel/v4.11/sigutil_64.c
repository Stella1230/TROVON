int save_fpu_state(struct pt_regs *regs, __siginfo_fpu_t __user *fpu)\r\n{\r\nunsigned long *fpregs = current_thread_info()->fpregs;\r\nunsigned long fprs;\r\nint err = 0;\r\nfprs = current_thread_info()->fpsaved[0];\r\nif (fprs & FPRS_DL)\r\nerr |= copy_to_user(&fpu->si_float_regs[0], fpregs,\r\n(sizeof(unsigned int) * 32));\r\nif (fprs & FPRS_DU)\r\nerr |= copy_to_user(&fpu->si_float_regs[32], fpregs+16,\r\n(sizeof(unsigned int) * 32));\r\nerr |= __put_user(current_thread_info()->xfsr[0], &fpu->si_fsr);\r\nerr |= __put_user(current_thread_info()->gsr[0], &fpu->si_gsr);\r\nerr |= __put_user(fprs, &fpu->si_fprs);\r\nreturn err;\r\n}\r\nint restore_fpu_state(struct pt_regs *regs, __siginfo_fpu_t __user *fpu)\r\n{\r\nunsigned long *fpregs = current_thread_info()->fpregs;\r\nunsigned long fprs;\r\nint err;\r\nif (((unsigned long) fpu) & 7)\r\nreturn -EFAULT;\r\nerr = get_user(fprs, &fpu->si_fprs);\r\nfprs_write(0);\r\nregs->tstate &= ~TSTATE_PEF;\r\nif (fprs & FPRS_DL)\r\nerr |= copy_from_user(fpregs, &fpu->si_float_regs[0],\r\n(sizeof(unsigned int) * 32));\r\nif (fprs & FPRS_DU)\r\nerr |= copy_from_user(fpregs+16, &fpu->si_float_regs[32],\r\n(sizeof(unsigned int) * 32));\r\nerr |= __get_user(current_thread_info()->xfsr[0], &fpu->si_fsr);\r\nerr |= __get_user(current_thread_info()->gsr[0], &fpu->si_gsr);\r\ncurrent_thread_info()->fpsaved[0] |= fprs;\r\nreturn err;\r\n}\r\nint save_rwin_state(int wsaved, __siginfo_rwin_t __user *rwin)\r\n{\r\nint i, err = __put_user(wsaved, &rwin->wsaved);\r\nfor (i = 0; i < wsaved; i++) {\r\nstruct reg_window *rp = &current_thread_info()->reg_window[i];\r\nunsigned long fp = current_thread_info()->rwbuf_stkptrs[i];\r\nerr |= copy_to_user(&rwin->reg_window[i], rp,\r\nsizeof(struct reg_window));\r\nerr |= __put_user(fp, &rwin->rwbuf_stkptrs[i]);\r\n}\r\nreturn err;\r\n}\r\nint restore_rwin_state(__siginfo_rwin_t __user *rp)\r\n{\r\nstruct thread_info *t = current_thread_info();\r\nint i, wsaved, err;\r\nif (((unsigned long) rp) & 7)\r\nreturn -EFAULT;\r\nget_user(wsaved, &rp->wsaved);\r\nif (wsaved > NSWINS)\r\nreturn -EFAULT;\r\nerr = 0;\r\nfor (i = 0; i < wsaved; i++) {\r\nerr |= copy_from_user(&t->reg_window[i],\r\n&rp->reg_window[i],\r\nsizeof(struct reg_window));\r\nerr |= __get_user(t->rwbuf_stkptrs[i],\r\n&rp->rwbuf_stkptrs[i]);\r\n}\r\nif (err)\r\nreturn err;\r\nset_thread_wsaved(wsaved);\r\nsynchronize_user_stack();\r\nif (get_thread_wsaved())\r\nreturn -EFAULT;\r\nreturn 0;\r\n}

static int midibuf_message_length(unsigned char code)\r\n{\r\nint message_length;\r\nif (code < 0x80)\r\nmessage_length = -1;\r\nelse if (code < 0xf0) {\r\nstatic const int length[] = { 3, 3, 3, 3, 2, 2, 3 };\r\nmessage_length = length[(code >> 4) - 8];\r\n} else {\r\nstatic const int length[] = { -1, 2, -1, 2, -1, -1, 1, 1, 1, 1,\r\n1, 1, 1, -1, 1, 1\r\n};\r\nmessage_length = length[code & 0x0f];\r\n}\r\nreturn message_length;\r\n}\r\nstatic int midibuf_is_empty(struct midi_buffer *this)\r\n{\r\nreturn (this->pos_read == this->pos_write) && !this->full;\r\n}\r\nstatic int midibuf_is_full(struct midi_buffer *this)\r\n{\r\nreturn this->full;\r\n}\r\nvoid line6_midibuf_reset(struct midi_buffer *this)\r\n{\r\nthis->pos_read = this->pos_write = this->full = 0;\r\nthis->command_prev = -1;\r\n}\r\nint line6_midibuf_init(struct midi_buffer *this, int size, int split)\r\n{\r\nthis->buf = kmalloc(size, GFP_KERNEL);\r\nif (this->buf == NULL)\r\nreturn -ENOMEM;\r\nthis->size = size;\r\nthis->split = split;\r\nline6_midibuf_reset(this);\r\nreturn 0;\r\n}\r\nint line6_midibuf_bytes_free(struct midi_buffer *this)\r\n{\r\nreturn\r\nmidibuf_is_full(this) ?\r\n0 :\r\n(this->pos_read - this->pos_write + this->size - 1) % this->size +\r\n1;\r\n}\r\nint line6_midibuf_bytes_used(struct midi_buffer *this)\r\n{\r\nreturn\r\nmidibuf_is_empty(this) ?\r\n0 :\r\n(this->pos_write - this->pos_read + this->size - 1) % this->size +\r\n1;\r\n}\r\nint line6_midibuf_write(struct midi_buffer *this, unsigned char *data,\r\nint length)\r\n{\r\nint bytes_free;\r\nint length1, length2;\r\nint skip_active_sense = 0;\r\nif (midibuf_is_full(this) || (length <= 0))\r\nreturn 0;\r\nif (data[length - 1] == 0xfe) {\r\n--length;\r\nskip_active_sense = 1;\r\n}\r\nbytes_free = line6_midibuf_bytes_free(this);\r\nif (length > bytes_free)\r\nlength = bytes_free;\r\nif (length > 0) {\r\nlength1 = this->size - this->pos_write;\r\nif (length < length1) {\r\nmemcpy(this->buf + this->pos_write, data, length);\r\nthis->pos_write += length;\r\n} else {\r\nlength2 = length - length1;\r\nmemcpy(this->buf + this->pos_write, data, length1);\r\nmemcpy(this->buf, data + length1, length2);\r\nthis->pos_write = length2;\r\n}\r\nif (this->pos_write == this->pos_read)\r\nthis->full = 1;\r\n}\r\nreturn length + skip_active_sense;\r\n}\r\nint line6_midibuf_read(struct midi_buffer *this, unsigned char *data,\r\nint length)\r\n{\r\nint bytes_used;\r\nint length1, length2;\r\nint command;\r\nint midi_length;\r\nint repeat = 0;\r\nint i;\r\nif (length < 3)\r\nreturn -EINVAL;\r\nif (midibuf_is_empty(this))\r\nreturn 0;\r\nbytes_used = line6_midibuf_bytes_used(this);\r\nif (length > bytes_used)\r\nlength = bytes_used;\r\nlength1 = this->size - this->pos_read;\r\ncommand = this->buf[this->pos_read];\r\nif (command & 0x80) {\r\nmidi_length = midibuf_message_length(command);\r\nthis->command_prev = command;\r\n} else {\r\nif (this->command_prev > 0) {\r\nint midi_length_prev =\r\nmidibuf_message_length(this->command_prev);\r\nif (midi_length_prev > 0) {\r\nmidi_length = midi_length_prev - 1;\r\nrepeat = 1;\r\n} else\r\nmidi_length = -1;\r\n} else\r\nmidi_length = -1;\r\n}\r\nif (midi_length < 0) {\r\nif (length < length1) {\r\nfor (i = 1; i < length; ++i)\r\nif (this->buf[this->pos_read + i] & 0x80)\r\nbreak;\r\nmidi_length = i;\r\n} else {\r\nlength2 = length - length1;\r\nfor (i = 1; i < length1; ++i)\r\nif (this->buf[this->pos_read + i] & 0x80)\r\nbreak;\r\nif (i < length1)\r\nmidi_length = i;\r\nelse {\r\nfor (i = 0; i < length2; ++i)\r\nif (this->buf[i] & 0x80)\r\nbreak;\r\nmidi_length = length1 + i;\r\n}\r\n}\r\nif (midi_length == length)\r\nmidi_length = -1;\r\n}\r\nif (midi_length < 0) {\r\nif (!this->split)\r\nreturn 0;\r\n} else {\r\nif (length < midi_length)\r\nreturn 0;\r\nlength = midi_length;\r\n}\r\nif (length < length1) {\r\nmemcpy(data + repeat, this->buf + this->pos_read, length);\r\nthis->pos_read += length;\r\n} else {\r\nlength2 = length - length1;\r\nmemcpy(data + repeat, this->buf + this->pos_read, length1);\r\nmemcpy(data + repeat + length1, this->buf, length2);\r\nthis->pos_read = length2;\r\n}\r\nif (repeat)\r\ndata[0] = this->command_prev;\r\nthis->full = 0;\r\nreturn length + repeat;\r\n}\r\nint line6_midibuf_ignore(struct midi_buffer *this, int length)\r\n{\r\nint bytes_used = line6_midibuf_bytes_used(this);\r\nif (length > bytes_used)\r\nlength = bytes_used;\r\nthis->pos_read = (this->pos_read + length) % this->size;\r\nthis->full = 0;\r\nreturn length;\r\n}\r\nvoid line6_midibuf_destroy(struct midi_buffer *this)\r\n{\r\nkfree(this->buf);\r\nthis->buf = NULL;\r\n}

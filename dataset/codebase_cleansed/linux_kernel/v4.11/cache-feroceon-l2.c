static inline unsigned long l2_get_va(unsigned long paddr)\r\n{\r\n#ifdef CONFIG_HIGHMEM\r\nvoid *vaddr = kmap_atomic_pfn(paddr >> PAGE_SHIFT);\r\nreturn (unsigned long)vaddr + (paddr & ~PAGE_MASK);\r\n#else\r\nreturn __phys_to_virt(paddr);\r\n#endif\r\n}\r\nstatic inline void l2_put_va(unsigned long vaddr)\r\n{\r\n#ifdef CONFIG_HIGHMEM\r\nkunmap_atomic((void *)vaddr);\r\n#endif\r\n}\r\nstatic inline void l2_clean_pa(unsigned long addr)\r\n{\r\n__asm__("mcr p15, 1, %0, c15, c9, 3" : : "r" (addr));\r\n}\r\nstatic inline void l2_clean_pa_range(unsigned long start, unsigned long end)\r\n{\r\nunsigned long va_start, va_end, flags;\r\nBUG_ON((start ^ end) >> PAGE_SHIFT);\r\nva_start = l2_get_va(start);\r\nva_end = va_start + (end - start);\r\nraw_local_irq_save(flags);\r\n__asm__("mcr p15, 1, %0, c15, c9, 4\n\t"\r\n"mcr p15, 1, %1, c15, c9, 5"\r\n: : "r" (va_start), "r" (va_end));\r\nraw_local_irq_restore(flags);\r\nl2_put_va(va_start);\r\n}\r\nstatic inline void l2_clean_inv_pa(unsigned long addr)\r\n{\r\n__asm__("mcr p15, 1, %0, c15, c10, 3" : : "r" (addr));\r\n}\r\nstatic inline void l2_inv_pa(unsigned long addr)\r\n{\r\n__asm__("mcr p15, 1, %0, c15, c11, 3" : : "r" (addr));\r\n}\r\nstatic inline void l2_inv_pa_range(unsigned long start, unsigned long end)\r\n{\r\nunsigned long va_start, va_end, flags;\r\nBUG_ON((start ^ end) >> PAGE_SHIFT);\r\nva_start = l2_get_va(start);\r\nva_end = va_start + (end - start);\r\nraw_local_irq_save(flags);\r\n__asm__("mcr p15, 1, %0, c15, c11, 4\n\t"\r\n"mcr p15, 1, %1, c15, c11, 5"\r\n: : "r" (va_start), "r" (va_end));\r\nraw_local_irq_restore(flags);\r\nl2_put_va(va_start);\r\n}\r\nstatic inline void l2_inv_all(void)\r\n{\r\n__asm__("mcr p15, 1, %0, c15, c11, 0" : : "r" (0));\r\n}\r\nstatic unsigned long calc_range_end(unsigned long start, unsigned long end)\r\n{\r\nunsigned long range_end;\r\nBUG_ON(start & (CACHE_LINE_SIZE - 1));\r\nBUG_ON(end & (CACHE_LINE_SIZE - 1));\r\nrange_end = end;\r\nif (range_end > start + MAX_RANGE_SIZE)\r\nrange_end = start + MAX_RANGE_SIZE;\r\nif (range_end > (start | (PAGE_SIZE - 1)) + 1)\r\nrange_end = (start | (PAGE_SIZE - 1)) + 1;\r\nreturn range_end;\r\n}\r\nstatic void feroceon_l2_inv_range(unsigned long start, unsigned long end)\r\n{\r\nif (start & (CACHE_LINE_SIZE - 1)) {\r\nl2_clean_inv_pa(start & ~(CACHE_LINE_SIZE - 1));\r\nstart = (start | (CACHE_LINE_SIZE - 1)) + 1;\r\n}\r\nif (start < end && end & (CACHE_LINE_SIZE - 1)) {\r\nl2_clean_inv_pa(end & ~(CACHE_LINE_SIZE - 1));\r\nend &= ~(CACHE_LINE_SIZE - 1);\r\n}\r\nwhile (start < end) {\r\nunsigned long range_end = calc_range_end(start, end);\r\nl2_inv_pa_range(start, range_end - CACHE_LINE_SIZE);\r\nstart = range_end;\r\n}\r\ndsb();\r\n}\r\nstatic void feroceon_l2_clean_range(unsigned long start, unsigned long end)\r\n{\r\nif (!l2_wt_override) {\r\nstart &= ~(CACHE_LINE_SIZE - 1);\r\nend = (end + CACHE_LINE_SIZE - 1) & ~(CACHE_LINE_SIZE - 1);\r\nwhile (start != end) {\r\nunsigned long range_end = calc_range_end(start, end);\r\nl2_clean_pa_range(start, range_end - CACHE_LINE_SIZE);\r\nstart = range_end;\r\n}\r\n}\r\ndsb();\r\n}\r\nstatic void feroceon_l2_flush_range(unsigned long start, unsigned long end)\r\n{\r\nstart &= ~(CACHE_LINE_SIZE - 1);\r\nend = (end + CACHE_LINE_SIZE - 1) & ~(CACHE_LINE_SIZE - 1);\r\nwhile (start != end) {\r\nunsigned long range_end = calc_range_end(start, end);\r\nif (!l2_wt_override)\r\nl2_clean_pa_range(start, range_end - CACHE_LINE_SIZE);\r\nl2_inv_pa_range(start, range_end - CACHE_LINE_SIZE);\r\nstart = range_end;\r\n}\r\ndsb();\r\n}\r\nstatic int __init flush_and_disable_dcache(void)\r\n{\r\nu32 cr;\r\ncr = get_cr();\r\nif (cr & CR_C) {\r\nunsigned long flags;\r\nraw_local_irq_save(flags);\r\nflush_cache_all();\r\nset_cr(cr & ~CR_C);\r\nraw_local_irq_restore(flags);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __init enable_dcache(void)\r\n{\r\nu32 cr;\r\ncr = get_cr();\r\nset_cr(cr | CR_C);\r\n}\r\nstatic void __init __invalidate_icache(void)\r\n{\r\n__asm__("mcr p15, 0, %0, c7, c5, 0" : : "r" (0));\r\n}\r\nstatic int __init invalidate_and_disable_icache(void)\r\n{\r\nu32 cr;\r\ncr = get_cr();\r\nif (cr & CR_I) {\r\nset_cr(cr & ~CR_I);\r\n__invalidate_icache();\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __init enable_icache(void)\r\n{\r\nu32 cr;\r\ncr = get_cr();\r\nset_cr(cr | CR_I);\r\n}\r\nstatic inline u32 read_extra_features(void)\r\n{\r\nu32 u;\r\n__asm__("mrc p15, 1, %0, c15, c1, 0" : "=r" (u));\r\nreturn u;\r\n}\r\nstatic inline void write_extra_features(u32 u)\r\n{\r\n__asm__("mcr p15, 1, %0, c15, c1, 0" : : "r" (u));\r\n}\r\nstatic void __init disable_l2_prefetch(void)\r\n{\r\nu32 u;\r\nu = read_extra_features();\r\nif (!(u & 0x01000000)) {\r\npr_info("Feroceon L2: Disabling L2 prefetch.\n");\r\nwrite_extra_features(u | 0x01000000);\r\n}\r\n}\r\nstatic void __init enable_l2(void)\r\n{\r\nu32 u;\r\nu = read_extra_features();\r\nif (!(u & 0x00400000)) {\r\nint i, d;\r\npr_info("Feroceon L2: Enabling L2\n");\r\nd = flush_and_disable_dcache();\r\ni = invalidate_and_disable_icache();\r\nl2_inv_all();\r\nwrite_extra_features(u | 0x00400000);\r\nif (i)\r\nenable_icache();\r\nif (d)\r\nenable_dcache();\r\n} else\r\npr_err(FW_BUG\r\n"Feroceon L2: bootloader left the L2 cache on!\n");\r\n}\r\nvoid __init feroceon_l2_init(int __l2_wt_override)\r\n{\r\nl2_wt_override = __l2_wt_override;\r\ndisable_l2_prefetch();\r\nouter_cache.inv_range = feroceon_l2_inv_range;\r\nouter_cache.clean_range = feroceon_l2_clean_range;\r\nouter_cache.flush_range = feroceon_l2_flush_range;\r\nenable_l2();\r\npr_info("Feroceon L2: Cache support initialised%s.\n",\r\nl2_wt_override ? ", in WT override mode" : "");\r\n}\r\nint __init feroceon_of_init(void)\r\n{\r\nstruct device_node *node;\r\nvoid __iomem *base;\r\nbool l2_wt_override = false;\r\n#if defined(CONFIG_CACHE_FEROCEON_L2_WRITETHROUGH)\r\nl2_wt_override = true;\r\n#endif\r\nnode = of_find_matching_node(NULL, feroceon_ids);\r\nif (node && of_device_is_compatible(node, "marvell,kirkwood-cache")) {\r\nbase = of_iomap(node, 0);\r\nif (!base)\r\nreturn -ENOMEM;\r\nif (l2_wt_override)\r\nwritel(readl(base) | L2_WRITETHROUGH_KIRKWOOD, base);\r\nelse\r\nwritel(readl(base) & ~L2_WRITETHROUGH_KIRKWOOD, base);\r\n}\r\nferoceon_l2_init(l2_wt_override);\r\nreturn 0;\r\n}

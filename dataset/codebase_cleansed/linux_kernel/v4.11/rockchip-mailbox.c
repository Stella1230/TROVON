static int rockchip_mbox_send_data(struct mbox_chan *chan, void *data)\r\n{\r\nstruct rockchip_mbox *mb = dev_get_drvdata(chan->mbox->dev);\r\nstruct rockchip_mbox_msg *msg = data;\r\nstruct rockchip_mbox_chan *chans = mb->chans;\r\nif (!msg)\r\nreturn -EINVAL;\r\nif (msg->rx_size > mb->buf_size) {\r\ndev_err(mb->mbox.dev, "Transmit size over buf size(%d)\n",\r\nmb->buf_size);\r\nreturn -EINVAL;\r\n}\r\ndev_dbg(mb->mbox.dev, "Chan[%d]: A2B message, cmd 0x%08x\n",\r\nchans->idx, msg->cmd);\r\nmb->chans[chans->idx].msg = msg;\r\nwritel_relaxed(msg->cmd, mb->mbox_base + MAILBOX_A2B_CMD(chans->idx));\r\nwritel_relaxed(msg->rx_size, mb->mbox_base +\r\nMAILBOX_A2B_DAT(chans->idx));\r\nreturn 0;\r\n}\r\nstatic int rockchip_mbox_startup(struct mbox_chan *chan)\r\n{\r\nstruct rockchip_mbox *mb = dev_get_drvdata(chan->mbox->dev);\r\nwritel_relaxed((1 << mb->mbox.num_chans) - 1,\r\nmb->mbox_base + MAILBOX_B2A_INTEN);\r\nreturn 0;\r\n}\r\nstatic void rockchip_mbox_shutdown(struct mbox_chan *chan)\r\n{\r\nstruct rockchip_mbox *mb = dev_get_drvdata(chan->mbox->dev);\r\nstruct rockchip_mbox_chan *chans = mb->chans;\r\nwritel_relaxed(0, mb->mbox_base + MAILBOX_B2A_INTEN);\r\nmb->chans[chans->idx].msg = NULL;\r\n}\r\nstatic irqreturn_t rockchip_mbox_irq(int irq, void *dev_id)\r\n{\r\nint idx;\r\nstruct rockchip_mbox *mb = (struct rockchip_mbox *)dev_id;\r\nu32 status = readl_relaxed(mb->mbox_base + MAILBOX_B2A_STATUS);\r\nfor (idx = 0; idx < mb->mbox.num_chans; idx++) {\r\nif ((status & (1 << idx)) && (irq == mb->chans[idx].irq)) {\r\nwritel_relaxed(1 << idx,\r\nmb->mbox_base + MAILBOX_B2A_STATUS);\r\nreturn IRQ_WAKE_THREAD;\r\n}\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic irqreturn_t rockchip_mbox_isr(int irq, void *dev_id)\r\n{\r\nint idx;\r\nstruct rockchip_mbox_msg *msg = NULL;\r\nstruct rockchip_mbox *mb = (struct rockchip_mbox *)dev_id;\r\nfor (idx = 0; idx < mb->mbox.num_chans; idx++) {\r\nif (irq != mb->chans[idx].irq)\r\ncontinue;\r\nmsg = mb->chans[idx].msg;\r\nif (!msg) {\r\ndev_err(mb->mbox.dev,\r\n"Chan[%d]: B2A message is NULL\n", idx);\r\nbreak;\r\n}\r\nmbox_chan_received_data(&mb->mbox.chans[idx], msg);\r\nmb->chans[idx].msg = NULL;\r\ndev_dbg(mb->mbox.dev, "Chan[%d]: B2A message, cmd 0x%08x\n",\r\nidx, msg->cmd);\r\nbreak;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int rockchip_mbox_probe(struct platform_device *pdev)\r\n{\r\nstruct rockchip_mbox *mb;\r\nconst struct of_device_id *match;\r\nconst struct rockchip_mbox_data *drv_data;\r\nstruct resource *res;\r\nint ret, irq, i;\r\nif (!pdev->dev.of_node)\r\nreturn -ENODEV;\r\nmatch = of_match_node(rockchip_mbox_of_match, pdev->dev.of_node);\r\ndrv_data = (const struct rockchip_mbox_data *)match->data;\r\nmb = devm_kzalloc(&pdev->dev, sizeof(*mb), GFP_KERNEL);\r\nif (!mb)\r\nreturn -ENOMEM;\r\nmb->chans = devm_kcalloc(&pdev->dev, drv_data->num_chans,\r\nsizeof(*mb->chans), GFP_KERNEL);\r\nif (!mb->chans)\r\nreturn -ENOMEM;\r\nmb->mbox.chans = devm_kcalloc(&pdev->dev, drv_data->num_chans,\r\nsizeof(*mb->mbox.chans), GFP_KERNEL);\r\nif (!mb->mbox.chans)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, mb);\r\nmb->mbox.dev = &pdev->dev;\r\nmb->mbox.num_chans = drv_data->num_chans;\r\nmb->mbox.ops = &rockchip_mbox_chan_ops;\r\nmb->mbox.txdone_irq = true;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\nmb->mbox_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(mb->mbox_base))\r\nreturn PTR_ERR(mb->mbox_base);\r\nmb->buf_size = (size_t)resource_size(res) / (drv_data->num_chans * 2);\r\nmb->pclk = devm_clk_get(&pdev->dev, "pclk_mailbox");\r\nif (IS_ERR(mb->pclk)) {\r\nret = PTR_ERR(mb->pclk);\r\ndev_err(&pdev->dev, "failed to get pclk_mailbox clock: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = clk_prepare_enable(mb->pclk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to enable pclk: %d\n", ret);\r\nreturn ret;\r\n}\r\nfor (i = 0; i < mb->mbox.num_chans; i++) {\r\nirq = platform_get_irq(pdev, i);\r\nif (irq < 0)\r\nreturn irq;\r\nret = devm_request_threaded_irq(&pdev->dev, irq,\r\nrockchip_mbox_irq,\r\nrockchip_mbox_isr, IRQF_ONESHOT,\r\ndev_name(&pdev->dev), mb);\r\nif (ret < 0)\r\nreturn ret;\r\nmb->chans[i].idx = i;\r\nmb->chans[i].irq = irq;\r\nmb->chans[i].mb = mb;\r\nmb->chans[i].msg = NULL;\r\n}\r\nret = mbox_controller_register(&mb->mbox);\r\nif (ret < 0)\r\ndev_err(&pdev->dev, "Failed to register mailbox: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int rockchip_mbox_remove(struct platform_device *pdev)\r\n{\r\nstruct rockchip_mbox *mb = platform_get_drvdata(pdev);\r\nif (!mb)\r\nreturn -EINVAL;\r\nmbox_controller_unregister(&mb->mbox);\r\nreturn 0;\r\n}

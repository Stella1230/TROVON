int loongson3_cpu_temp(int cpu)\r\n{\r\nu32 reg;\r\nreg = LOONGSON_CHIPTEMP(cpu);\r\nif ((read_c0_prid() & PRID_REV_MASK) == PRID_REV_LOONGSON3A_R1)\r\nreg = (reg >> 8) & 0xff;\r\nelse\r\nreg = ((reg >> 8) & 0xff) - 100;\r\nreturn (int)reg * 1000;\r\n}\r\nstatic ssize_t get_hwmon_name(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "cpu-hwmon\n");\r\n}\r\nstatic ssize_t cpu0_temp_label(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "CPU 0 Temperature\n");\r\n}\r\nstatic ssize_t cpu1_temp_label(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "CPU 1 Temperature\n");\r\n}\r\nstatic ssize_t get_cpu0_temp(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nint value = loongson3_cpu_temp(0);\r\nreturn sprintf(buf, "%d\n", value);\r\n}\r\nstatic ssize_t get_cpu1_temp(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nint value = loongson3_cpu_temp(1);\r\nreturn sprintf(buf, "%d\n", value);\r\n}\r\nstatic int create_sysfs_cputemp_files(struct kobject *kobj)\r\n{\r\nint ret;\r\nret = sysfs_create_files(kobj, hwmon_cputemp1);\r\nif (ret)\r\ngoto sysfs_create_temp1_fail;\r\nif (loongson_sysconf.nr_cpus <= loongson_sysconf.cores_per_package)\r\nreturn 0;\r\nret = sysfs_create_files(kobj, hwmon_cputemp2);\r\nif (ret)\r\ngoto sysfs_create_temp2_fail;\r\nreturn 0;\r\nsysfs_create_temp2_fail:\r\nsysfs_remove_files(kobj, hwmon_cputemp1);\r\nsysfs_create_temp1_fail:\r\nreturn -1;\r\n}\r\nstatic void remove_sysfs_cputemp_files(struct kobject *kobj)\r\n{\r\nsysfs_remove_files(&cpu_hwmon_dev->kobj, hwmon_cputemp1);\r\nif (loongson_sysconf.nr_cpus > loongson_sysconf.cores_per_package)\r\nsysfs_remove_files(&cpu_hwmon_dev->kobj, hwmon_cputemp2);\r\n}\r\nstatic void do_thermal_timer(struct work_struct *work)\r\n{\r\nint value = loongson3_cpu_temp(0);\r\nif (value <= CPU_THERMAL_THRESHOLD)\r\nschedule_delayed_work(&thermal_work, msecs_to_jiffies(5000));\r\nelse\r\norderly_poweroff(true);\r\n}\r\nstatic int __init loongson_hwmon_init(void)\r\n{\r\nint ret;\r\npr_info("Loongson Hwmon Enter...\n");\r\ncpu_hwmon_dev = hwmon_device_register(NULL);\r\nif (IS_ERR(cpu_hwmon_dev)) {\r\nret = -ENOMEM;\r\npr_err("hwmon_device_register fail!\n");\r\ngoto fail_hwmon_device_register;\r\n}\r\nret = sysfs_create_group(&cpu_hwmon_dev->kobj,\r\n&cpu_hwmon_attribute_group);\r\nif (ret) {\r\npr_err("fail to create loongson hwmon!\n");\r\ngoto fail_sysfs_create_group_hwmon;\r\n}\r\nret = create_sysfs_cputemp_files(&cpu_hwmon_dev->kobj);\r\nif (ret) {\r\npr_err("fail to create cpu temperature interface!\n");\r\ngoto fail_create_sysfs_cputemp_files;\r\n}\r\nINIT_DEFERRABLE_WORK(&thermal_work, do_thermal_timer);\r\nschedule_delayed_work(&thermal_work, msecs_to_jiffies(20000));\r\nreturn ret;\r\nfail_create_sysfs_cputemp_files:\r\nsysfs_remove_group(&cpu_hwmon_dev->kobj,\r\n&cpu_hwmon_attribute_group);\r\nfail_sysfs_create_group_hwmon:\r\nhwmon_device_unregister(cpu_hwmon_dev);\r\nfail_hwmon_device_register:\r\nreturn ret;\r\n}\r\nstatic void __exit loongson_hwmon_exit(void)\r\n{\r\ncancel_delayed_work_sync(&thermal_work);\r\nremove_sysfs_cputemp_files(&cpu_hwmon_dev->kobj);\r\nsysfs_remove_group(&cpu_hwmon_dev->kobj,\r\n&cpu_hwmon_attribute_group);\r\nhwmon_device_unregister(cpu_hwmon_dev);\r\n}

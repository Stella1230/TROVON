static int tps6105x_startup(struct tps6105x *tps6105x)\r\n{\r\nint ret;\r\nunsigned int regval;\r\nret = regmap_read(tps6105x->regmap, TPS6105X_REG_0, &regval);\r\nif (ret)\r\nreturn ret;\r\nswitch (regval >> TPS6105X_REG0_MODE_SHIFT) {\r\ncase TPS6105X_REG0_MODE_SHUTDOWN:\r\ndev_info(&tps6105x->client->dev,\r\n"TPS6105x found in SHUTDOWN mode\n");\r\nbreak;\r\ncase TPS6105X_REG0_MODE_TORCH:\r\ndev_info(&tps6105x->client->dev,\r\n"TPS6105x found in TORCH mode\n");\r\nbreak;\r\ncase TPS6105X_REG0_MODE_TORCH_FLASH:\r\ndev_info(&tps6105x->client->dev,\r\n"TPS6105x found in FLASH mode\n");\r\nbreak;\r\ncase TPS6105X_REG0_MODE_VOLTAGE:\r\ndev_info(&tps6105x->client->dev,\r\n"TPS6105x found in VOLTAGE mode\n");\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int tps6105x_add_device(struct tps6105x *tps6105x,\r\nstruct mfd_cell *cell)\r\n{\r\ncell->platform_data = tps6105x;\r\ncell->pdata_size = sizeof(*tps6105x);\r\nreturn mfd_add_devices(&tps6105x->client->dev,\r\nPLATFORM_DEVID_AUTO, cell, 1, NULL, 0, NULL);\r\n}\r\nstatic int tps6105x_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct tps6105x *tps6105x;\r\nstruct tps6105x_platform_data *pdata;\r\nint ret;\r\npdata = dev_get_platdata(&client->dev);\r\nif (!pdata) {\r\ndev_err(&client->dev, "missing platform data\n");\r\nreturn -ENODEV;\r\n}\r\ntps6105x = devm_kmalloc(&client->dev, sizeof(*tps6105x), GFP_KERNEL);\r\nif (!tps6105x)\r\nreturn -ENOMEM;\r\ntps6105x->regmap = devm_regmap_init_i2c(client, &tps6105x_regmap_config);\r\nif (IS_ERR(tps6105x->regmap))\r\nreturn PTR_ERR(tps6105x->regmap);\r\ni2c_set_clientdata(client, tps6105x);\r\ntps6105x->client = client;\r\ntps6105x->pdata = pdata;\r\nret = tps6105x_startup(tps6105x);\r\nif (ret) {\r\ndev_err(&client->dev, "chip initialization failed\n");\r\nreturn ret;\r\n}\r\nret = tps6105x_add_device(tps6105x, &tps6105x_gpio_cell);\r\nif (ret)\r\nreturn ret;\r\nswitch (pdata->mode) {\r\ncase TPS6105X_MODE_SHUTDOWN:\r\ndev_info(&client->dev,\r\n"present, not used for anything, only GPIO\n");\r\nbreak;\r\ncase TPS6105X_MODE_TORCH:\r\nret = tps6105x_add_device(tps6105x, &tps6105x_leds_cell);\r\nbreak;\r\ncase TPS6105X_MODE_TORCH_FLASH:\r\nret = tps6105x_add_device(tps6105x, &tps6105x_flash_cell);\r\nbreak;\r\ncase TPS6105X_MODE_VOLTAGE:\r\nret = tps6105x_add_device(tps6105x, &tps6105x_regulator_cell);\r\nbreak;\r\ndefault:\r\ndev_warn(&client->dev, "invalid mode: %d\n", pdata->mode);\r\nbreak;\r\n}\r\nif (ret)\r\nmfd_remove_devices(&client->dev);\r\nreturn ret;\r\n}\r\nstatic int tps6105x_remove(struct i2c_client *client)\r\n{\r\nstruct tps6105x *tps6105x = i2c_get_clientdata(client);\r\nmfd_remove_devices(&client->dev);\r\nregmap_update_bits(tps6105x->regmap, TPS6105X_REG_0,\r\nTPS6105X_REG0_MODE_MASK,\r\nTPS6105X_MODE_SHUTDOWN << TPS6105X_REG0_MODE_SHIFT);\r\nreturn 0;\r\n}\r\nstatic int __init tps6105x_init(void)\r\n{\r\nreturn i2c_add_driver(&tps6105x_driver);\r\n}\r\nstatic void __exit tps6105x_exit(void)\r\n{\r\ni2c_del_driver(&tps6105x_driver);\r\n}

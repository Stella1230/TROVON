static int bdw_rt5677_event_hp(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *k, int event)\r\n{\r\nstruct snd_soc_dapm_context *dapm = w->dapm;\r\nstruct snd_soc_card *card = dapm->card;\r\nstruct bdw_rt5677_priv *bdw_rt5677 = snd_soc_card_get_drvdata(card);\r\nif (SND_SOC_DAPM_EVENT_ON(event))\r\nmsleep(70);\r\ngpiod_set_value_cansleep(bdw_rt5677->gpio_hp_en,\r\nSND_SOC_DAPM_EVENT_ON(event));\r\nreturn 0;\r\n}\r\nstatic int broadwell_ssp0_fixup(struct snd_soc_pcm_runtime *rtd,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_interval *rate = hw_param_interval(params,\r\nSNDRV_PCM_HW_PARAM_RATE);\r\nstruct snd_interval *channels = hw_param_interval(params,\r\nSNDRV_PCM_HW_PARAM_CHANNELS);\r\nrate->min = rate->max = 48000;\r\nchannels->min = channels->max = 2;\r\nsnd_mask_set(&params->masks[SNDRV_PCM_HW_PARAM_FORMAT -\r\nSNDRV_PCM_HW_PARAM_FIRST_MASK],\r\nSNDRV_PCM_FORMAT_S16_LE);\r\nreturn 0;\r\n}\r\nstatic int bdw_rt5677_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nint ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, RT5677_SCLK_S_MCLK, 24576000,\r\nSND_SOC_CLOCK_IN);\r\nif (ret < 0) {\r\ndev_err(rtd->dev, "can't set codec sysclk configuration\n");\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic int bdw_rt5677_rtd_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct sst_pdata *pdata = dev_get_platdata(rtd->platform->dev);\r\nstruct sst_hsw *broadwell = pdata->dsp;\r\nint ret;\r\nret = sst_hsw_device_set_config(broadwell, SST_HSW_DEVICE_SSP_0,\r\nSST_HSW_DEVICE_MCLK_FREQ_24_MHZ,\r\nSST_HSW_DEVICE_CLOCK_MASTER, 9);\r\nif (ret < 0) {\r\ndev_err(rtd->dev, "error: failed to set device config\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bdw_rt5677_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct bdw_rt5677_priv *bdw_rt5677 =\r\nsnd_soc_card_get_drvdata(rtd->card);\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nrt5677_sel_asrc_clk_src(codec, RT5677_DA_STEREO_FILTER |\r\nRT5677_AD_STEREO1_FILTER | RT5677_I2S1_SOURCE,\r\nRT5677_CLK_SEL_I2S1_ASRC);\r\nbdw_rt5677->gpio_hp_en = devm_gpiod_get_index(codec->dev,\r\n"headphone-enable", 0, 0);\r\nif (IS_ERR(bdw_rt5677->gpio_hp_en)) {\r\ndev_err(codec->dev, "Can't find HP_AMP_SHDN_L gpio\n");\r\nreturn PTR_ERR(bdw_rt5677->gpio_hp_en);\r\n}\r\ngpiod_direction_output(bdw_rt5677->gpio_hp_en, 0);\r\nif (!snd_soc_card_jack_new(rtd->card, "Headphone Jack",\r\nSND_JACK_HEADPHONE, &headphone_jack,\r\n&headphone_jack_pin, 1)) {\r\nheadphone_jack_gpio.gpiod_dev = codec->dev;\r\nif (snd_soc_jack_add_gpios(&headphone_jack, 1,\r\n&headphone_jack_gpio))\r\ndev_err(codec->dev, "Can't add headphone jack gpio\n");\r\n} else {\r\ndev_err(codec->dev, "Can't create headphone jack\n");\r\n}\r\nif (!snd_soc_card_jack_new(rtd->card, "Mic Jack",\r\nSND_JACK_MICROPHONE, &mic_jack,\r\n&mic_jack_pin, 1)) {\r\nmic_jack_gpio.gpiod_dev = codec->dev;\r\nif (snd_soc_jack_add_gpios(&mic_jack, 1, &mic_jack_gpio))\r\ndev_err(codec->dev, "Can't add mic jack gpio\n");\r\n} else {\r\ndev_err(codec->dev, "Can't create mic jack\n");\r\n}\r\nbdw_rt5677->codec = codec;\r\nsnd_soc_dapm_force_enable_pin(dapm, "MICBIAS1");\r\nreturn 0;\r\n}\r\nstatic int bdw_rt5677_suspend_pre(struct snd_soc_card *card)\r\n{\r\nstruct bdw_rt5677_priv *bdw_rt5677 = snd_soc_card_get_drvdata(card);\r\nstruct snd_soc_dapm_context *dapm;\r\nif (bdw_rt5677->codec) {\r\ndapm = snd_soc_codec_get_dapm(bdw_rt5677->codec);\r\nsnd_soc_dapm_disable_pin(dapm, "MICBIAS1");\r\n}\r\nreturn 0;\r\n}\r\nstatic int bdw_rt5677_resume_post(struct snd_soc_card *card)\r\n{\r\nstruct bdw_rt5677_priv *bdw_rt5677 = snd_soc_card_get_drvdata(card);\r\nstruct snd_soc_dapm_context *dapm;\r\nif (bdw_rt5677->codec) {\r\ndapm = snd_soc_codec_get_dapm(bdw_rt5677->codec);\r\nsnd_soc_dapm_force_enable_pin(dapm, "MICBIAS1");\r\n}\r\nreturn 0;\r\n}\r\nstatic int bdw_rt5677_probe(struct platform_device *pdev)\r\n{\r\nstruct bdw_rt5677_priv *bdw_rt5677;\r\nbdw_rt5677_card.dev = &pdev->dev;\r\nbdw_rt5677 = devm_kzalloc(&pdev->dev, sizeof(struct bdw_rt5677_priv),\r\nGFP_KERNEL);\r\nif (!bdw_rt5677) {\r\ndev_err(&pdev->dev, "Can't allocate bdw_rt5677\n");\r\nreturn -ENOMEM;\r\n}\r\nsnd_soc_card_set_drvdata(&bdw_rt5677_card, bdw_rt5677);\r\nreturn devm_snd_soc_register_card(&pdev->dev, &bdw_rt5677_card);\r\n}

void pager_init(const char *pager_env)\r\n{\r\nsubcmd_config.pager_env = pager_env;\r\n}\r\nstatic void pager_preexec(void)\r\n{\r\nfd_set in;\r\nFD_ZERO(&in);\r\nFD_SET(0, &in);\r\nselect(1, &in, NULL, &in, NULL);\r\nsetenv("LESS", "FRSX", 0);\r\n}\r\nstatic void wait_for_pager(void)\r\n{\r\nfflush(stdout);\r\nfflush(stderr);\r\nclose(1);\r\nclose(2);\r\nfinish_command(&pager_process);\r\n}\r\nstatic void wait_for_pager_signal(int signo)\r\n{\r\nwait_for_pager();\r\nsigchain_pop(signo);\r\nraise(signo);\r\n}\r\nvoid setup_pager(void)\r\n{\r\nconst char *pager = getenv(subcmd_config.pager_env);\r\nstruct winsize sz;\r\nif (!isatty(1))\r\nreturn;\r\nif (ioctl(1, TIOCGWINSZ, &sz) == 0)\r\npager_columns = sz.ws_col;\r\nif (!pager)\r\npager = getenv("PAGER");\r\nif (!(pager || access("/usr/bin/pager", X_OK)))\r\npager = "/usr/bin/pager";\r\nif (!(pager || access("/usr/bin/less", X_OK)))\r\npager = "/usr/bin/less";\r\nif (!pager)\r\npager = "cat";\r\nif (!*pager || !strcmp(pager, "cat"))\r\nreturn;\r\nspawned_pager = 1;\r\npager_argv[2] = pager;\r\npager_process.argv = pager_argv;\r\npager_process.in = -1;\r\npager_process.preexec_cb = pager_preexec;\r\nif (start_command(&pager_process))\r\nreturn;\r\ndup2(pager_process.in, 1);\r\nif (isatty(2))\r\ndup2(pager_process.in, 2);\r\nclose(pager_process.in);\r\nsigchain_push_common(wait_for_pager_signal);\r\natexit(wait_for_pager);\r\n}\r\nint pager_in_use(void)\r\n{\r\nreturn spawned_pager;\r\n}\r\nint pager_get_columns(void)\r\n{\r\nchar *s;\r\ns = getenv("COLUMNS");\r\nif (s)\r\nreturn atoi(s);\r\nreturn (pager_columns ? pager_columns : 80) - 2;\r\n}

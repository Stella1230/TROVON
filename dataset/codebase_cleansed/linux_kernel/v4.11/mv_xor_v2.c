static void mv_xor_v2_set_data_buffers(struct mv_xor_v2_device *xor_dev,\r\nstruct mv_xor_v2_descriptor *desc,\r\ndma_addr_t src, int index)\r\n{\r\nint arr_index = ((index >> 1) * 3);\r\nif ((index & 0x1) == 0) {\r\ndesc->data_buff_addr[arr_index] = lower_32_bits(src);\r\ndesc->data_buff_addr[arr_index + 2] &= ~0xFFFF;\r\ndesc->data_buff_addr[arr_index + 2] |=\r\nupper_32_bits(src) & 0xFFFF;\r\n} else {\r\ndesc->data_buff_addr[arr_index + 1] =\r\nlower_32_bits(src);\r\ndesc->data_buff_addr[arr_index + 2] &= ~0xFFFF0000;\r\ndesc->data_buff_addr[arr_index + 2] |=\r\n(upper_32_bits(src) & 0xFFFF) << 16;\r\n}\r\n}\r\nstatic int mv_xor_v2_get_desq_write_ptr(struct mv_xor_v2_device *xor_dev)\r\n{\r\nu32 reg = readl(xor_dev->dma_base + MV_XOR_V2_DMA_DESQ_ALLOC_OFF);\r\nreturn ((reg >> MV_XOR_V2_DMA_DESQ_ALLOC_WRPTR_SHIFT)\r\n& MV_XOR_V2_DMA_DESQ_ALLOC_WRPTR_MASK);\r\n}\r\nstatic void mv_xor_v2_add_desc_to_desq(struct mv_xor_v2_device *xor_dev,\r\nint num_of_desc)\r\n{\r\nwritel(num_of_desc, xor_dev->dma_base + MV_XOR_V2_DMA_DESQ_ADD_OFF);\r\n}\r\nstatic void mv_xor_v2_free_desc_from_desq(struct mv_xor_v2_device *xor_dev,\r\nint num_of_desc)\r\n{\r\nwritel(num_of_desc, xor_dev->dma_base + MV_XOR_V2_DMA_DESQ_DEALLOC_OFF);\r\n}\r\nstatic int mv_xor_v2_set_desc_size(struct mv_xor_v2_device *xor_dev)\r\n{\r\nwritel(MV_XOR_V2_DMA_DESQ_CTRL_128B,\r\nxor_dev->dma_base + MV_XOR_V2_DMA_DESQ_CTRL_OFF);\r\nreturn MV_XOR_V2_EXT_DESC_SIZE;\r\n}\r\nstatic inline\r\nvoid mv_xor_v2_set_imsg_thrd(struct mv_xor_v2_device *xor_dev, int thrd_val)\r\n{\r\nu32 reg;\r\nreg = readl(xor_dev->dma_base + MV_XOR_V2_DMA_IMSG_THRD_OFF);\r\nreg &= (~MV_XOR_V2_DMA_IMSG_THRD_MASK << MV_XOR_V2_DMA_IMSG_THRD_SHIFT);\r\nreg |= (thrd_val << MV_XOR_V2_DMA_IMSG_THRD_SHIFT);\r\nwritel(reg, xor_dev->dma_base + MV_XOR_V2_DMA_IMSG_THRD_OFF);\r\n}\r\nstatic irqreturn_t mv_xor_v2_interrupt_handler(int irq, void *data)\r\n{\r\nstruct mv_xor_v2_device *xor_dev = data;\r\nunsigned int ndescs;\r\nu32 reg;\r\nreg = readl(xor_dev->dma_base + MV_XOR_V2_DMA_DESQ_DONE_OFF);\r\nndescs = ((reg >> MV_XOR_V2_DMA_DESQ_DONE_PENDING_SHIFT) &\r\nMV_XOR_V2_DMA_DESQ_DONE_PENDING_MASK);\r\nif (!ndescs)\r\nreturn IRQ_NONE;\r\nmv_xor_v2_set_imsg_thrd(xor_dev, MV_XOR_V2_DESC_NUM);\r\ntasklet_schedule(&xor_dev->irq_tasklet);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic dma_cookie_t\r\nmv_xor_v2_tx_submit(struct dma_async_tx_descriptor *tx)\r\n{\r\nint desq_ptr;\r\nvoid *dest_hw_desc;\r\ndma_cookie_t cookie;\r\nstruct mv_xor_v2_sw_desc *sw_desc =\r\ncontainer_of(tx, struct mv_xor_v2_sw_desc, async_tx);\r\nstruct mv_xor_v2_device *xor_dev =\r\ncontainer_of(tx->chan, struct mv_xor_v2_device, dmachan);\r\ndev_dbg(xor_dev->dmadev.dev,\r\n"%s sw_desc %p: async_tx %p\n",\r\n__func__, sw_desc, &sw_desc->async_tx);\r\nspin_lock_bh(&xor_dev->lock);\r\ncookie = dma_cookie_assign(tx);\r\ndesq_ptr = mv_xor_v2_get_desq_write_ptr(xor_dev);\r\ndest_hw_desc = xor_dev->hw_desq_virt + desq_ptr;\r\nmemcpy(dest_hw_desc, &sw_desc->hw_desc, xor_dev->desc_size);\r\nxor_dev->npendings++;\r\nspin_unlock_bh(&xor_dev->lock);\r\nreturn cookie;\r\n}\r\nstatic struct mv_xor_v2_sw_desc *\r\nmv_xor_v2_prep_sw_desc(struct mv_xor_v2_device *xor_dev)\r\n{\r\nstruct mv_xor_v2_sw_desc *sw_desc;\r\nspin_lock_bh(&xor_dev->lock);\r\nif (list_empty(&xor_dev->free_sw_desc)) {\r\nspin_unlock_bh(&xor_dev->lock);\r\ntasklet_schedule(&xor_dev->irq_tasklet);\r\nreturn NULL;\r\n}\r\nsw_desc = list_first_entry(&xor_dev->free_sw_desc,\r\nstruct mv_xor_v2_sw_desc, free_list);\r\nlist_del(&sw_desc->free_list);\r\nspin_unlock_bh(&xor_dev->lock);\r\ndma_async_tx_descriptor_init(&sw_desc->async_tx, &xor_dev->dmachan);\r\nsw_desc->async_tx.tx_submit = mv_xor_v2_tx_submit;\r\nasync_tx_ack(&sw_desc->async_tx);\r\nreturn sw_desc;\r\n}\r\nstatic struct dma_async_tx_descriptor *\r\nmv_xor_v2_prep_dma_memcpy(struct dma_chan *chan, dma_addr_t dest,\r\ndma_addr_t src, size_t len, unsigned long flags)\r\n{\r\nstruct mv_xor_v2_sw_desc *sw_desc;\r\nstruct mv_xor_v2_descriptor *hw_descriptor;\r\nstruct mv_xor_v2_device *xor_dev;\r\nxor_dev = container_of(chan, struct mv_xor_v2_device, dmachan);\r\ndev_dbg(xor_dev->dmadev.dev,\r\n"%s len: %zu src %pad dest %pad flags: %ld\n",\r\n__func__, len, &src, &dest, flags);\r\nsw_desc = mv_xor_v2_prep_sw_desc(xor_dev);\r\nsw_desc->async_tx.flags = flags;\r\nhw_descriptor = &sw_desc->hw_desc;\r\nhw_descriptor->desc_id = sw_desc->idx;\r\nhw_descriptor->desc_ctrl =\r\nDESC_OP_MODE_MEMCPY << DESC_OP_MODE_SHIFT;\r\nif (flags & DMA_PREP_INTERRUPT)\r\nhw_descriptor->desc_ctrl |= DESC_IOD;\r\nhw_descriptor->fill_pattern_src_addr[0] = lower_32_bits(src);\r\nhw_descriptor->fill_pattern_src_addr[1] =\r\nupper_32_bits(src) & 0xFFFF;\r\nhw_descriptor->fill_pattern_src_addr[2] = lower_32_bits(dest);\r\nhw_descriptor->fill_pattern_src_addr[3] =\r\nupper_32_bits(dest) & 0xFFFF;\r\nhw_descriptor->buff_size = len;\r\nreturn &sw_desc->async_tx;\r\n}\r\nstatic struct dma_async_tx_descriptor *\r\nmv_xor_v2_prep_dma_xor(struct dma_chan *chan, dma_addr_t dest, dma_addr_t *src,\r\nunsigned int src_cnt, size_t len, unsigned long flags)\r\n{\r\nstruct mv_xor_v2_sw_desc *sw_desc;\r\nstruct mv_xor_v2_descriptor *hw_descriptor;\r\nstruct mv_xor_v2_device *xor_dev =\r\ncontainer_of(chan, struct mv_xor_v2_device, dmachan);\r\nint i;\r\nif (src_cnt > MV_XOR_V2_CMD_LINE_NUM_MAX_D_BUF || src_cnt < 1)\r\nreturn NULL;\r\ndev_dbg(xor_dev->dmadev.dev,\r\n"%s src_cnt: %d len: %zu dest %pad flags: %ld\n",\r\n__func__, src_cnt, len, &dest, flags);\r\nsw_desc = mv_xor_v2_prep_sw_desc(xor_dev);\r\nsw_desc->async_tx.flags = flags;\r\nhw_descriptor = &sw_desc->hw_desc;\r\nhw_descriptor->desc_id = sw_desc->idx;\r\nhw_descriptor->desc_ctrl =\r\nDESC_OP_MODE_XOR << DESC_OP_MODE_SHIFT;\r\nhw_descriptor->desc_ctrl |= DESC_P_BUFFER_ENABLE;\r\nif (flags & DMA_PREP_INTERRUPT)\r\nhw_descriptor->desc_ctrl |= DESC_IOD;\r\nfor (i = 0; i < src_cnt; i++)\r\nmv_xor_v2_set_data_buffers(xor_dev, hw_descriptor, src[i], i);\r\nhw_descriptor->desc_ctrl |=\r\nsrc_cnt << DESC_NUM_ACTIVE_D_BUF_SHIFT;\r\nhw_descriptor->fill_pattern_src_addr[2] = lower_32_bits(dest);\r\nhw_descriptor->fill_pattern_src_addr[3] =\r\nupper_32_bits(dest) & 0xFFFF;\r\nhw_descriptor->buff_size = len;\r\nreturn &sw_desc->async_tx;\r\n}\r\nstatic struct dma_async_tx_descriptor *\r\nmv_xor_v2_prep_dma_interrupt(struct dma_chan *chan, unsigned long flags)\r\n{\r\nstruct mv_xor_v2_sw_desc *sw_desc;\r\nstruct mv_xor_v2_descriptor *hw_descriptor;\r\nstruct mv_xor_v2_device *xor_dev =\r\ncontainer_of(chan, struct mv_xor_v2_device, dmachan);\r\nsw_desc = mv_xor_v2_prep_sw_desc(xor_dev);\r\nhw_descriptor = &sw_desc->hw_desc;\r\nhw_descriptor->desc_id = sw_desc->idx;\r\nhw_descriptor->desc_ctrl =\r\nDESC_OP_MODE_NOP << DESC_OP_MODE_SHIFT;\r\nhw_descriptor->desc_ctrl |= DESC_IOD;\r\nreturn &sw_desc->async_tx;\r\n}\r\nstatic void mv_xor_v2_issue_pending(struct dma_chan *chan)\r\n{\r\nstruct mv_xor_v2_device *xor_dev =\r\ncontainer_of(chan, struct mv_xor_v2_device, dmachan);\r\nspin_lock_bh(&xor_dev->lock);\r\nmv_xor_v2_add_desc_to_desq(xor_dev, xor_dev->npendings);\r\nxor_dev->npendings = 0;\r\nwritel(0, xor_dev->dma_base + MV_XOR_V2_DMA_DESQ_STOP_OFF);\r\nspin_unlock_bh(&xor_dev->lock);\r\n}\r\nstatic inline\r\nint mv_xor_v2_get_pending_params(struct mv_xor_v2_device *xor_dev,\r\nint *pending_ptr)\r\n{\r\nu32 reg;\r\nreg = readl(xor_dev->dma_base + MV_XOR_V2_DMA_DESQ_DONE_OFF);\r\n*pending_ptr = ((reg >> MV_XOR_V2_DMA_DESQ_DONE_READ_PTR_SHIFT) &\r\nMV_XOR_V2_DMA_DESQ_DONE_READ_PTR_MASK);\r\nreturn ((reg >> MV_XOR_V2_DMA_DESQ_DONE_PENDING_SHIFT) &\r\nMV_XOR_V2_DMA_DESQ_DONE_PENDING_MASK);\r\n}\r\nstatic void mv_xor_v2_tasklet(unsigned long data)\r\n{\r\nstruct mv_xor_v2_device *xor_dev = (struct mv_xor_v2_device *) data;\r\nint pending_ptr, num_of_pending, i;\r\nstruct mv_xor_v2_descriptor *next_pending_hw_desc = NULL;\r\nstruct mv_xor_v2_sw_desc *next_pending_sw_desc = NULL;\r\ndev_dbg(xor_dev->dmadev.dev, "%s %d\n", __func__, __LINE__);\r\nnum_of_pending = mv_xor_v2_get_pending_params(xor_dev, &pending_ptr);\r\nnext_pending_hw_desc = xor_dev->hw_desq_virt + pending_ptr;\r\nfor (i = 0; i < num_of_pending; i++) {\r\nif (pending_ptr > MV_XOR_V2_DESC_NUM)\r\npending_ptr = 0;\r\nif (next_pending_sw_desc != NULL)\r\nnext_pending_hw_desc++;\r\nnext_pending_sw_desc =\r\n&xor_dev->sw_desq[next_pending_hw_desc->desc_id];\r\nif (next_pending_sw_desc->async_tx.cookie > 0) {\r\ndma_cookie_complete(&next_pending_sw_desc->async_tx);\r\nif (next_pending_sw_desc->async_tx.callback)\r\nnext_pending_sw_desc->async_tx.callback(\r\nnext_pending_sw_desc->async_tx.callback_param);\r\ndma_descriptor_unmap(&next_pending_sw_desc->async_tx);\r\n}\r\ndma_run_dependencies(&next_pending_sw_desc->async_tx);\r\nspin_lock_bh(&xor_dev->lock);\r\nlist_add(&next_pending_sw_desc->free_list,\r\n&xor_dev->free_sw_desc);\r\nspin_unlock_bh(&xor_dev->lock);\r\npending_ptr++;\r\n}\r\nif (num_of_pending != 0) {\r\nmv_xor_v2_free_desc_from_desq(xor_dev, num_of_pending);\r\n}\r\nmv_xor_v2_set_imsg_thrd(xor_dev, 0);\r\n}\r\nstatic void mv_xor_v2_set_msi_msg(struct msi_desc *desc, struct msi_msg *msg)\r\n{\r\nstruct mv_xor_v2_device *xor_dev = dev_get_drvdata(desc->dev);\r\nwritel(msg->address_lo,\r\nxor_dev->dma_base + MV_XOR_V2_DMA_IMSG_BALR_OFF);\r\nwritel(msg->address_hi & 0xFFFF,\r\nxor_dev->dma_base + MV_XOR_V2_DMA_IMSG_BAHR_OFF);\r\nwritel(msg->data,\r\nxor_dev->dma_base + MV_XOR_V2_DMA_IMSG_CDAT_OFF);\r\n}\r\nstatic int mv_xor_v2_descq_init(struct mv_xor_v2_device *xor_dev)\r\n{\r\nu32 reg;\r\nwritel(MV_XOR_V2_DESC_NUM,\r\nxor_dev->dma_base + MV_XOR_V2_DMA_DESQ_SIZE_OFF);\r\nwritel(xor_dev->hw_desq & 0xFFFFFFFF,\r\nxor_dev->dma_base + MV_XOR_V2_DMA_DESQ_BALR_OFF);\r\nwritel((xor_dev->hw_desq & 0xFFFF00000000) >> 32,\r\nxor_dev->dma_base + MV_XOR_V2_DMA_DESQ_BAHR_OFF);\r\nwritel(0, xor_dev->dma_base + MV_XOR_V2_DMA_DESQ_STOP_OFF);\r\nreg = readl(xor_dev->dma_base + MV_XOR_V2_DMA_DESQ_ARATTR_OFF);\r\nreg &= ~MV_XOR_V2_DMA_DESQ_ATTR_CACHE_MASK;\r\nreg |= MV_XOR_V2_DMA_DESQ_ATTR_OUTER_SHAREABLE |\r\nMV_XOR_V2_DMA_DESQ_ATTR_CACHEABLE;\r\nwritel(reg, xor_dev->dma_base + MV_XOR_V2_DMA_DESQ_ARATTR_OFF);\r\nreg = readl(xor_dev->dma_base + MV_XOR_V2_DMA_DESQ_AWATTR_OFF);\r\nreg &= ~MV_XOR_V2_DMA_DESQ_ATTR_CACHE_MASK;\r\nreg |= MV_XOR_V2_DMA_DESQ_ATTR_OUTER_SHAREABLE |\r\nMV_XOR_V2_DMA_DESQ_ATTR_CACHEABLE;\r\nwritel(reg, xor_dev->dma_base + MV_XOR_V2_DMA_DESQ_AWATTR_OFF);\r\nreg = ((MV_XOR_V2_GLOB_BW_CTRL_NUM_OSTD_RD_VAL <<\r\nMV_XOR_V2_GLOB_BW_CTRL_NUM_OSTD_RD_SHIFT) |\r\n(MV_XOR_V2_GLOB_BW_CTRL_NUM_OSTD_WR_VAL <<\r\nMV_XOR_V2_GLOB_BW_CTRL_NUM_OSTD_WR_SHIFT) |\r\n(MV_XOR_V2_GLOB_BW_CTRL_RD_BURST_LEN_VAL <<\r\nMV_XOR_V2_GLOB_BW_CTRL_RD_BURST_LEN_SHIFT) |\r\n(MV_XOR_V2_GLOB_BW_CTRL_WR_BURST_LEN_VAL <<\r\nMV_XOR_V2_GLOB_BW_CTRL_WR_BURST_LEN_SHIFT));\r\nwritel(reg, xor_dev->glob_base + MV_XOR_V2_GLOB_BW_CTRL);\r\nreg = readl(xor_dev->glob_base + MV_XOR_V2_GLOB_PAUSE);\r\nreg |= MV_XOR_V2_GLOB_PAUSE_AXI_TIME_DIS_VAL;\r\nwritel(reg, xor_dev->glob_base + MV_XOR_V2_GLOB_PAUSE);\r\nreturn 0;\r\n}\r\nstatic int mv_xor_v2_probe(struct platform_device *pdev)\r\n{\r\nstruct mv_xor_v2_device *xor_dev;\r\nstruct resource *res;\r\nint i, ret = 0;\r\nstruct dma_device *dma_dev;\r\nstruct mv_xor_v2_sw_desc *sw_desc;\r\nstruct msi_desc *msi_desc;\r\nBUILD_BUG_ON(sizeof(struct mv_xor_v2_descriptor) !=\r\nMV_XOR_V2_EXT_DESC_SIZE);\r\nxor_dev = devm_kzalloc(&pdev->dev, sizeof(*xor_dev), GFP_KERNEL);\r\nif (!xor_dev)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nxor_dev->dma_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(xor_dev->dma_base))\r\nreturn PTR_ERR(xor_dev->dma_base);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nxor_dev->glob_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(xor_dev->glob_base))\r\nreturn PTR_ERR(xor_dev->glob_base);\r\nplatform_set_drvdata(pdev, xor_dev);\r\nxor_dev->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(xor_dev->clk) && PTR_ERR(xor_dev->clk) == -EPROBE_DEFER)\r\nreturn -EPROBE_DEFER;\r\nif (!IS_ERR(xor_dev->clk)) {\r\nret = clk_prepare_enable(xor_dev->clk);\r\nif (ret)\r\nreturn ret;\r\n}\r\nret = platform_msi_domain_alloc_irqs(&pdev->dev, 1,\r\nmv_xor_v2_set_msi_msg);\r\nif (ret)\r\ngoto disable_clk;\r\nmsi_desc = first_msi_entry(&pdev->dev);\r\nif (!msi_desc)\r\ngoto free_msi_irqs;\r\nret = devm_request_irq(&pdev->dev, msi_desc->irq,\r\nmv_xor_v2_interrupt_handler, 0,\r\ndev_name(&pdev->dev), xor_dev);\r\nif (ret)\r\ngoto free_msi_irqs;\r\ntasklet_init(&xor_dev->irq_tasklet, mv_xor_v2_tasklet,\r\n(unsigned long) xor_dev);\r\nxor_dev->desc_size = mv_xor_v2_set_desc_size(xor_dev);\r\ndma_cookie_init(&xor_dev->dmachan);\r\nxor_dev->hw_desq_virt =\r\ndma_alloc_coherent(&pdev->dev,\r\nxor_dev->desc_size * MV_XOR_V2_DESC_NUM,\r\n&xor_dev->hw_desq, GFP_KERNEL);\r\nif (!xor_dev->hw_desq_virt) {\r\nret = -ENOMEM;\r\ngoto free_msi_irqs;\r\n}\r\nxor_dev->sw_desq = devm_kzalloc(&pdev->dev, sizeof(*sw_desc) *\r\nMV_XOR_V2_DESC_NUM, GFP_KERNEL);\r\nif (!xor_dev->sw_desq) {\r\nret = -ENOMEM;\r\ngoto free_hw_desq;\r\n}\r\nspin_lock_init(&xor_dev->lock);\r\nINIT_LIST_HEAD(&xor_dev->free_sw_desc);\r\nfor (i = 0; i < MV_XOR_V2_DESC_NUM; i++) {\r\nxor_dev->sw_desq[i].idx = i;\r\nlist_add(&xor_dev->sw_desq[i].free_list,\r\n&xor_dev->free_sw_desc);\r\n}\r\ndma_dev = &xor_dev->dmadev;\r\ndma_cap_zero(dma_dev->cap_mask);\r\ndma_cap_set(DMA_MEMCPY, dma_dev->cap_mask);\r\ndma_cap_set(DMA_XOR, dma_dev->cap_mask);\r\ndma_cap_set(DMA_INTERRUPT, dma_dev->cap_mask);\r\nINIT_LIST_HEAD(&dma_dev->channels);\r\ndma_dev->device_tx_status = dma_cookie_status;\r\ndma_dev->device_issue_pending = mv_xor_v2_issue_pending;\r\ndma_dev->dev = &pdev->dev;\r\ndma_dev->device_prep_dma_memcpy = mv_xor_v2_prep_dma_memcpy;\r\ndma_dev->device_prep_dma_interrupt = mv_xor_v2_prep_dma_interrupt;\r\ndma_dev->max_xor = 8;\r\ndma_dev->device_prep_dma_xor = mv_xor_v2_prep_dma_xor;\r\nxor_dev->dmachan.device = dma_dev;\r\nlist_add_tail(&xor_dev->dmachan.device_node,\r\n&dma_dev->channels);\r\nmv_xor_v2_descq_init(xor_dev);\r\nret = dma_async_device_register(dma_dev);\r\nif (ret)\r\ngoto free_hw_desq;\r\ndev_notice(&pdev->dev, "Marvell Version 2 XOR driver\n");\r\nreturn 0;\r\nfree_hw_desq:\r\ndma_free_coherent(&pdev->dev,\r\nxor_dev->desc_size * MV_XOR_V2_DESC_NUM,\r\nxor_dev->hw_desq_virt, xor_dev->hw_desq);\r\nfree_msi_irqs:\r\nplatform_msi_domain_free_irqs(&pdev->dev);\r\ndisable_clk:\r\nif (!IS_ERR(xor_dev->clk))\r\nclk_disable_unprepare(xor_dev->clk);\r\nreturn ret;\r\n}\r\nstatic int mv_xor_v2_remove(struct platform_device *pdev)\r\n{\r\nstruct mv_xor_v2_device *xor_dev = platform_get_drvdata(pdev);\r\ndma_async_device_unregister(&xor_dev->dmadev);\r\ndma_free_coherent(&pdev->dev,\r\nxor_dev->desc_size * MV_XOR_V2_DESC_NUM,\r\nxor_dev->hw_desq_virt, xor_dev->hw_desq);\r\nplatform_msi_domain_free_irqs(&pdev->dev);\r\nclk_disable_unprepare(xor_dev->clk);\r\nreturn 0;\r\n}

static struct datalink_proto *find_snap_client(const unsigned char *desc)\r\n{\r\nstruct datalink_proto *proto = NULL, *p;\r\nlist_for_each_entry_rcu(p, &snap_list, node) {\r\nif (!memcmp(p->type, desc, 5)) {\r\nproto = p;\r\nbreak;\r\n}\r\n}\r\nreturn proto;\r\n}\r\nstatic int snap_rcv(struct sk_buff *skb, struct net_device *dev,\r\nstruct packet_type *pt, struct net_device *orig_dev)\r\n{\r\nint rc = 1;\r\nstruct datalink_proto *proto;\r\nstatic struct packet_type snap_packet_type = {\r\n.type = cpu_to_be16(ETH_P_SNAP),\r\n};\r\nif (unlikely(!pskb_may_pull(skb, 5)))\r\ngoto drop;\r\nrcu_read_lock();\r\nproto = find_snap_client(skb_transport_header(skb));\r\nif (proto) {\r\nskb->transport_header += 5;\r\nskb_pull_rcsum(skb, 5);\r\nrc = proto->rcvfunc(skb, dev, &snap_packet_type, orig_dev);\r\n}\r\nrcu_read_unlock();\r\nif (unlikely(!proto))\r\ngoto drop;\r\nout:\r\nreturn rc;\r\ndrop:\r\nkfree_skb(skb);\r\ngoto out;\r\n}\r\nstatic int snap_request(struct datalink_proto *dl,\r\nstruct sk_buff *skb, u8 *dest)\r\n{\r\nmemcpy(skb_push(skb, 5), dl->type, 5);\r\nllc_build_and_send_ui_pkt(snap_sap, skb, dest, snap_sap->laddr.lsap);\r\nreturn 0;\r\n}\r\nstatic int __init snap_init(void)\r\n{\r\nsnap_sap = llc_sap_open(0xAA, snap_rcv);\r\nif (!snap_sap) {\r\nprintk(snap_err_msg);\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit snap_exit(void)\r\n{\r\nllc_sap_put(snap_sap);\r\n}\r\nstruct datalink_proto *register_snap_client(const unsigned char *desc,\r\nint (*rcvfunc)(struct sk_buff *,\r\nstruct net_device *,\r\nstruct packet_type *,\r\nstruct net_device *))\r\n{\r\nstruct datalink_proto *proto = NULL;\r\nspin_lock_bh(&snap_lock);\r\nif (find_snap_client(desc))\r\ngoto out;\r\nproto = kmalloc(sizeof(*proto), GFP_ATOMIC);\r\nif (proto) {\r\nmemcpy(proto->type, desc, 5);\r\nproto->rcvfunc = rcvfunc;\r\nproto->header_length = 5 + 3;\r\nproto->request = snap_request;\r\nlist_add_rcu(&proto->node, &snap_list);\r\n}\r\nout:\r\nspin_unlock_bh(&snap_lock);\r\nreturn proto;\r\n}\r\nvoid unregister_snap_client(struct datalink_proto *proto)\r\n{\r\nspin_lock_bh(&snap_lock);\r\nlist_del_rcu(&proto->node);\r\nspin_unlock_bh(&snap_lock);\r\nsynchronize_net();\r\nkfree(proto);\r\n}

static int read_eeprom_bytes(struct mantis_pci *mantis, u8 reg, u8 *data, u8 length)\r\n{\r\nstruct i2c_adapter *adapter = &mantis->adapter;\r\nint err;\r\nu8 buf = reg;\r\nstruct i2c_msg msg[] = {\r\n{ .addr = 0x50, .flags = 0, .buf = &buf, .len = 1 },\r\n{ .addr = 0x50, .flags = I2C_M_RD, .buf = data, .len = length },\r\n};\r\nerr = i2c_transfer(adapter, msg, 2);\r\nif (err < 0) {\r\ndprintk(MANTIS_ERROR, 1, "ERROR: i2c read: < err=%i d0=0x%02x d1=0x%02x >",\r\nerr, data[0], data[1]);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nint mantis_get_mac(struct mantis_pci *mantis)\r\n{\r\nint err;\r\nu8 mac_addr[6] = {0};\r\nerr = read_eeprom_bytes(mantis, 0x08, mac_addr, 6);\r\nif (err < 0) {\r\ndprintk(MANTIS_ERROR, 1, "ERROR: Mantis EEPROM read error <%d>", err);\r\nreturn err;\r\n}\r\ndprintk(MANTIS_ERROR, 0, " MAC Address=[%pM]\n", mac_addr);\r\nreturn 0;\r\n}\r\nvoid mantis_gpio_set_bits(struct mantis_pci *mantis, u32 bitpos, u8 value)\r\n{\r\nu32 cur;\r\ndprintk(MANTIS_DEBUG, 1, "Set Bit <%d> to <%d>", bitpos, value);\r\ncur = mmread(MANTIS_GPIF_ADDR);\r\nif (value)\r\nmantis->gpio_status = cur | (1 << bitpos);\r\nelse\r\nmantis->gpio_status = cur & (~(1 << bitpos));\r\ndprintk(MANTIS_DEBUG, 1, "GPIO Value <%02x>", mantis->gpio_status);\r\nmmwrite(mantis->gpio_status, MANTIS_GPIF_ADDR);\r\nmmwrite(0x00, MANTIS_GPIF_DOUT);\r\n}\r\nint mantis_stream_control(struct mantis_pci *mantis, enum mantis_stream_control stream_ctl)\r\n{\r\nu32 reg;\r\nreg = mmread(MANTIS_CONTROL);\r\nswitch (stream_ctl) {\r\ncase STREAM_TO_HIF:\r\ndprintk(MANTIS_DEBUG, 1, "Set stream to HIF");\r\nreg &= 0xff - MANTIS_BYPASS;\r\nmmwrite(reg, MANTIS_CONTROL);\r\nreg |= MANTIS_BYPASS;\r\nmmwrite(reg, MANTIS_CONTROL);\r\nbreak;\r\ncase STREAM_TO_CAM:\r\ndprintk(MANTIS_DEBUG, 1, "Set stream to CAM");\r\nreg |= MANTIS_BYPASS;\r\nmmwrite(reg, MANTIS_CONTROL);\r\nreg &= 0xff - MANTIS_BYPASS;\r\nmmwrite(reg, MANTIS_CONTROL);\r\nbreak;\r\ndefault:\r\ndprintk(MANTIS_ERROR, 1, "Unknown MODE <%02x>", stream_ctl);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}

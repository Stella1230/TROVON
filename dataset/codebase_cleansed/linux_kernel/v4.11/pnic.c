void pnic_do_nway(struct net_device *dev)\r\n{\r\nstruct tulip_private *tp = netdev_priv(dev);\r\nvoid __iomem *ioaddr = tp->base_addr;\r\nu32 phy_reg = ioread32(ioaddr + 0xB8);\r\nu32 new_csr6 = tp->csr6 & ~0x40C40200;\r\nif (phy_reg & 0x78000000) {\r\nif (phy_reg & 0x20000000) dev->if_port = 5;\r\nelse if (phy_reg & 0x40000000) dev->if_port = 3;\r\nelse if (phy_reg & 0x10000000) dev->if_port = 4;\r\nelse if (phy_reg & 0x08000000) dev->if_port = 0;\r\ntp->nwayset = 1;\r\nnew_csr6 = (dev->if_port & 1) ? 0x01860000 : 0x00420000;\r\niowrite32(0x32 | (dev->if_port & 1), ioaddr + CSR12);\r\nif (dev->if_port & 1)\r\niowrite32(0x1F868, ioaddr + 0xB8);\r\nif (phy_reg & 0x30000000) {\r\ntp->full_duplex = 1;\r\nnew_csr6 |= 0x00000200;\r\n}\r\nif (tulip_debug > 1)\r\nnetdev_dbg(dev, "PNIC autonegotiated status %08x, %s\n",\r\nphy_reg, medianame[dev->if_port]);\r\nif (tp->csr6 != new_csr6) {\r\ntp->csr6 = new_csr6;\r\ntulip_restart_rxtx(tp);\r\nnetif_trans_update(dev);\r\n}\r\n}\r\n}\r\nvoid pnic_lnk_change(struct net_device *dev, int csr5)\r\n{\r\nstruct tulip_private *tp = netdev_priv(dev);\r\nvoid __iomem *ioaddr = tp->base_addr;\r\nint phy_reg = ioread32(ioaddr + 0xB8);\r\nif (tulip_debug > 1)\r\nnetdev_dbg(dev, "PNIC link changed state %08x, CSR5 %08x\n",\r\nphy_reg, csr5);\r\nif (ioread32(ioaddr + CSR5) & TPLnkFail) {\r\niowrite32((ioread32(ioaddr + CSR7) & ~TPLnkFail) | TPLnkPass, ioaddr + CSR7);\r\nif (tulip_media_cap[dev->if_port] & MediaIsMII)\r\nreturn;\r\nif (! tp->nwayset || time_after(jiffies, dev_trans_start(dev) + 1*HZ)) {\r\ntp->csr6 = 0x00420000 | (tp->csr6 & 0x0000fdff);\r\niowrite32(tp->csr6, ioaddr + CSR6);\r\niowrite32(0x30, ioaddr + CSR12);\r\niowrite32(0x0201F078, ioaddr + 0xB8);\r\nnetif_trans_update(dev);\r\n}\r\n} else if (ioread32(ioaddr + CSR5) & TPLnkPass) {\r\nif (tulip_media_cap[dev->if_port] & MediaIsMII) {\r\nspin_lock(&tp->lock);\r\ntulip_check_duplex(dev);\r\nspin_unlock(&tp->lock);\r\n} else {\r\npnic_do_nway(dev);\r\n}\r\niowrite32((ioread32(ioaddr + CSR7) & ~TPLnkPass) | TPLnkFail, ioaddr + CSR7);\r\n}\r\n}\r\nvoid pnic_timer(unsigned long data)\r\n{\r\nstruct net_device *dev = (struct net_device *)data;\r\nstruct tulip_private *tp = netdev_priv(dev);\r\nvoid __iomem *ioaddr = tp->base_addr;\r\nint next_tick = 60*HZ;\r\nif(!ioread32(ioaddr + CSR7)) {\r\ngoto too_good_connection;\r\n}\r\nif (tulip_media_cap[dev->if_port] & MediaIsMII) {\r\nspin_lock_irq(&tp->lock);\r\nif (tulip_check_duplex(dev) > 0)\r\nnext_tick = 3*HZ;\r\nspin_unlock_irq(&tp->lock);\r\n} else {\r\nint csr12 = ioread32(ioaddr + CSR12);\r\nint new_csr6 = tp->csr6 & ~0x40C40200;\r\nint phy_reg = ioread32(ioaddr + 0xB8);\r\nint csr5 = ioread32(ioaddr + CSR5);\r\nif (tulip_debug > 1)\r\nnetdev_dbg(dev, "PNIC timer PHY status %08x, %s CSR5 %08x\n",\r\nphy_reg, medianame[dev->if_port], csr5);\r\nif (phy_reg & 0x04000000) {\r\niowrite32(0x0201F078, ioaddr + 0xB8);\r\nnext_tick = 1*HZ;\r\ntp->nwayset = 0;\r\n} else if (phy_reg & 0x78000000) {\r\npnic_do_nway(dev);\r\nnext_tick = 60*HZ;\r\n} else if (csr5 & TPLnkFail) {\r\nif (tulip_debug > 1)\r\nnetdev_dbg(dev, "%s link beat failed, CSR12 %04x, CSR5 %08x, PHY %03x\n",\r\nmedianame[dev->if_port],\r\ncsr12,\r\nioread32(ioaddr + CSR5),\r\nioread32(ioaddr + 0xB8));\r\nnext_tick = 3*HZ;\r\nif (tp->medialock) {\r\n} else if (tp->nwayset && (dev->if_port & 1)) {\r\nnext_tick = 1*HZ;\r\n} else if (dev->if_port == 0) {\r\ndev->if_port = 3;\r\niowrite32(0x33, ioaddr + CSR12);\r\nnew_csr6 = 0x01860000;\r\niowrite32(0x1F868, ioaddr + 0xB8);\r\n} else {\r\ndev->if_port = 0;\r\niowrite32(0x32, ioaddr + CSR12);\r\nnew_csr6 = 0x00420000;\r\niowrite32(0x1F078, ioaddr + 0xB8);\r\n}\r\nif (tp->csr6 != new_csr6) {\r\ntp->csr6 = new_csr6;\r\ntulip_restart_rxtx(tp);\r\nnetif_trans_update(dev);\r\nif (tulip_debug > 1)\r\ndev_info(&dev->dev,\r\n"Changing PNIC configuration to %s %s-duplex, CSR6 %08x\n",\r\nmedianame[dev->if_port],\r\ntp->full_duplex ? "full" : "half",\r\nnew_csr6);\r\n}\r\n}\r\n}\r\ntoo_good_connection:\r\nmod_timer(&tp->timer, RUN_AT(next_tick));\r\nif(!ioread32(ioaddr + CSR7)) {\r\nif (tulip_debug > 1)\r\ndev_info(&dev->dev, "sw timer wakeup\n");\r\ndisable_irq(dev->irq);\r\ntulip_refill_rx(dev);\r\nenable_irq(dev->irq);\r\niowrite32(tulip_tbl[tp->chip_id].valid_intrs, ioaddr + CSR7);\r\n}\r\n}

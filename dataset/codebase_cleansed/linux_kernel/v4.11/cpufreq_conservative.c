static inline struct cs_policy_dbs_info *to_dbs_info(struct policy_dbs_info *policy_dbs)\r\n{\r\nreturn container_of(policy_dbs, struct cs_policy_dbs_info, policy_dbs);\r\n}\r\nstatic inline unsigned int get_freq_step(struct cs_dbs_tuners *cs_tuners,\r\nstruct cpufreq_policy *policy)\r\n{\r\nunsigned int freq_step = (cs_tuners->freq_step * policy->max) / 100;\r\nif (unlikely(freq_step == 0))\r\nfreq_step = DEF_FREQUENCY_STEP;\r\nreturn freq_step;\r\n}\r\nstatic unsigned int cs_dbs_update(struct cpufreq_policy *policy)\r\n{\r\nstruct policy_dbs_info *policy_dbs = policy->governor_data;\r\nstruct cs_policy_dbs_info *dbs_info = to_dbs_info(policy_dbs);\r\nunsigned int requested_freq = dbs_info->requested_freq;\r\nstruct dbs_data *dbs_data = policy_dbs->dbs_data;\r\nstruct cs_dbs_tuners *cs_tuners = dbs_data->tuners;\r\nunsigned int load = dbs_update(policy);\r\nunsigned int freq_step;\r\nif (cs_tuners->freq_step == 0)\r\ngoto out;\r\nif (requested_freq > policy->max || requested_freq < policy->min)\r\nrequested_freq = policy->cur;\r\nfreq_step = get_freq_step(cs_tuners, policy);\r\nif (policy_dbs->idle_periods < UINT_MAX) {\r\nunsigned int freq_steps = policy_dbs->idle_periods * freq_step;\r\nif (requested_freq > freq_steps)\r\nrequested_freq -= freq_steps;\r\nelse\r\nrequested_freq = policy->min;\r\npolicy_dbs->idle_periods = UINT_MAX;\r\n}\r\nif (load > dbs_data->up_threshold) {\r\ndbs_info->down_skip = 0;\r\nif (requested_freq == policy->max)\r\ngoto out;\r\nrequested_freq += freq_step;\r\nif (requested_freq > policy->max)\r\nrequested_freq = policy->max;\r\n__cpufreq_driver_target(policy, requested_freq, CPUFREQ_RELATION_H);\r\ndbs_info->requested_freq = requested_freq;\r\ngoto out;\r\n}\r\nif (++dbs_info->down_skip < dbs_data->sampling_down_factor)\r\ngoto out;\r\ndbs_info->down_skip = 0;\r\nif (load < cs_tuners->down_threshold) {\r\nif (requested_freq == policy->min)\r\ngoto out;\r\nif (requested_freq > freq_step)\r\nrequested_freq -= freq_step;\r\nelse\r\nrequested_freq = policy->min;\r\n__cpufreq_driver_target(policy, requested_freq, CPUFREQ_RELATION_L);\r\ndbs_info->requested_freq = requested_freq;\r\n}\r\nout:\r\nreturn dbs_data->sampling_rate;\r\n}\r\nstatic ssize_t store_sampling_down_factor(struct gov_attr_set *attr_set,\r\nconst char *buf, size_t count)\r\n{\r\nstruct dbs_data *dbs_data = to_dbs_data(attr_set);\r\nunsigned int input;\r\nint ret;\r\nret = sscanf(buf, "%u", &input);\r\nif (ret != 1 || input > MAX_SAMPLING_DOWN_FACTOR || input < 1)\r\nreturn -EINVAL;\r\ndbs_data->sampling_down_factor = input;\r\nreturn count;\r\n}\r\nstatic ssize_t store_up_threshold(struct gov_attr_set *attr_set,\r\nconst char *buf, size_t count)\r\n{\r\nstruct dbs_data *dbs_data = to_dbs_data(attr_set);\r\nstruct cs_dbs_tuners *cs_tuners = dbs_data->tuners;\r\nunsigned int input;\r\nint ret;\r\nret = sscanf(buf, "%u", &input);\r\nif (ret != 1 || input > 100 || input <= cs_tuners->down_threshold)\r\nreturn -EINVAL;\r\ndbs_data->up_threshold = input;\r\nreturn count;\r\n}\r\nstatic ssize_t store_down_threshold(struct gov_attr_set *attr_set,\r\nconst char *buf, size_t count)\r\n{\r\nstruct dbs_data *dbs_data = to_dbs_data(attr_set);\r\nstruct cs_dbs_tuners *cs_tuners = dbs_data->tuners;\r\nunsigned int input;\r\nint ret;\r\nret = sscanf(buf, "%u", &input);\r\nif (ret != 1 || input < 11 || input > 100 ||\r\ninput >= dbs_data->up_threshold)\r\nreturn -EINVAL;\r\ncs_tuners->down_threshold = input;\r\nreturn count;\r\n}\r\nstatic ssize_t store_ignore_nice_load(struct gov_attr_set *attr_set,\r\nconst char *buf, size_t count)\r\n{\r\nstruct dbs_data *dbs_data = to_dbs_data(attr_set);\r\nunsigned int input;\r\nint ret;\r\nret = sscanf(buf, "%u", &input);\r\nif (ret != 1)\r\nreturn -EINVAL;\r\nif (input > 1)\r\ninput = 1;\r\nif (input == dbs_data->ignore_nice_load)\r\nreturn count;\r\ndbs_data->ignore_nice_load = input;\r\ngov_update_cpu_data(dbs_data);\r\nreturn count;\r\n}\r\nstatic ssize_t store_freq_step(struct gov_attr_set *attr_set, const char *buf,\r\nsize_t count)\r\n{\r\nstruct dbs_data *dbs_data = to_dbs_data(attr_set);\r\nstruct cs_dbs_tuners *cs_tuners = dbs_data->tuners;\r\nunsigned int input;\r\nint ret;\r\nret = sscanf(buf, "%u", &input);\r\nif (ret != 1)\r\nreturn -EINVAL;\r\nif (input > 100)\r\ninput = 100;\r\ncs_tuners->freq_step = input;\r\nreturn count;\r\n}\r\nstatic struct policy_dbs_info *cs_alloc(void)\r\n{\r\nstruct cs_policy_dbs_info *dbs_info;\r\ndbs_info = kzalloc(sizeof(*dbs_info), GFP_KERNEL);\r\nreturn dbs_info ? &dbs_info->policy_dbs : NULL;\r\n}\r\nstatic void cs_free(struct policy_dbs_info *policy_dbs)\r\n{\r\nkfree(to_dbs_info(policy_dbs));\r\n}\r\nstatic int cs_init(struct dbs_data *dbs_data)\r\n{\r\nstruct cs_dbs_tuners *tuners;\r\ntuners = kzalloc(sizeof(*tuners), GFP_KERNEL);\r\nif (!tuners)\r\nreturn -ENOMEM;\r\ntuners->down_threshold = DEF_FREQUENCY_DOWN_THRESHOLD;\r\ntuners->freq_step = DEF_FREQUENCY_STEP;\r\ndbs_data->up_threshold = DEF_FREQUENCY_UP_THRESHOLD;\r\ndbs_data->sampling_down_factor = DEF_SAMPLING_DOWN_FACTOR;\r\ndbs_data->ignore_nice_load = 0;\r\ndbs_data->tuners = tuners;\r\ndbs_data->min_sampling_rate = MIN_SAMPLING_RATE_RATIO *\r\njiffies_to_usecs(10);\r\nreturn 0;\r\n}\r\nstatic void cs_exit(struct dbs_data *dbs_data)\r\n{\r\nkfree(dbs_data->tuners);\r\n}\r\nstatic void cs_start(struct cpufreq_policy *policy)\r\n{\r\nstruct cs_policy_dbs_info *dbs_info = to_dbs_info(policy->governor_data);\r\ndbs_info->down_skip = 0;\r\ndbs_info->requested_freq = policy->cur;\r\n}\r\nstatic int __init cpufreq_gov_dbs_init(void)\r\n{\r\nreturn cpufreq_register_governor(CPU_FREQ_GOV_CONSERVATIVE);\r\n}\r\nstatic void __exit cpufreq_gov_dbs_exit(void)\r\n{\r\ncpufreq_unregister_governor(CPU_FREQ_GOV_CONSERVATIVE);\r\n}\r\nstruct cpufreq_governor *cpufreq_default_governor(void)\r\n{\r\nreturn CPU_FREQ_GOV_CONSERVATIVE;\r\n}

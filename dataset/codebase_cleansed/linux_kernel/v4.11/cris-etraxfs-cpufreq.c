static unsigned int cris_freq_get_cpu_frequency(unsigned int cpu)\r\n{\r\nreg_config_rw_clk_ctrl clk_ctrl;\r\nclk_ctrl = REG_RD(config, regi_config, rw_clk_ctrl);\r\nreturn clk_ctrl.pll ? 200000 : 6000;\r\n}\r\nstatic int cris_freq_target(struct cpufreq_policy *policy, unsigned int state)\r\n{\r\nreg_config_rw_clk_ctrl clk_ctrl;\r\nclk_ctrl = REG_RD(config, regi_config, rw_clk_ctrl);\r\nlocal_irq_disable();\r\nif (cris_freq_table[state].frequency == 200000)\r\nclk_ctrl.pll = 1;\r\nelse\r\nclk_ctrl.pll = 0;\r\nREG_WR(config, regi_config, rw_clk_ctrl, clk_ctrl);\r\nlocal_irq_enable();\r\nreturn 0;\r\n}\r\nstatic int cris_freq_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nreturn cpufreq_generic_init(policy, cris_freq_table, 1000000);\r\n}\r\nstatic int __init cris_freq_init(void)\r\n{\r\nint ret;\r\nret = cpufreq_register_driver(&cris_freq_driver);\r\ncpufreq_register_notifier(&cris_sdram_freq_notifier_block,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\nreturn ret;\r\n}\r\nstatic int\r\ncris_sdram_freq_notifier(struct notifier_block *nb, unsigned long val,\r\nvoid *data)\r\n{\r\nint i;\r\nstruct cpufreq_freqs *freqs = data;\r\nif (val == CPUFREQ_PRECHANGE) {\r\nreg_bif_core_rw_sdram_timing timing =\r\nREG_RD(bif_core, regi_bif_core, rw_sdram_timing);\r\ntiming.cpd = (freqs->new == 200000 ? 0 : 1);\r\nif (freqs->new == 200000)\r\nfor (i = 0; i < 50000; i++) ;\r\nREG_WR(bif_core, regi_bif_core, rw_sdram_timing, timing);\r\n}\r\nreturn 0;\r\n}

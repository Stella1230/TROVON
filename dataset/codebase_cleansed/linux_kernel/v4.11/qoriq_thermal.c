static void tmu_write(struct qoriq_tmu_data *p, u32 val, void __iomem *addr)\r\n{\r\nif (p->little_endian)\r\niowrite32(val, addr);\r\nelse\r\niowrite32be(val, addr);\r\n}\r\nstatic u32 tmu_read(struct qoriq_tmu_data *p, void __iomem *addr)\r\n{\r\nif (p->little_endian)\r\nreturn ioread32(addr);\r\nelse\r\nreturn ioread32be(addr);\r\n}\r\nstatic int tmu_get_temp(void *p, int *temp)\r\n{\r\nu32 val;\r\nstruct qoriq_tmu_data *data = p;\r\nval = tmu_read(data, &data->regs->site[data->sensor_id].tritsr);\r\n*temp = (val & 0xff) * 1000;\r\nreturn 0;\r\n}\r\nstatic int qoriq_tmu_get_sensor_id(void)\r\n{\r\nint ret, id;\r\nstruct of_phandle_args sensor_specs;\r\nstruct device_node *np, *sensor_np;\r\nnp = of_find_node_by_name(NULL, "thermal-zones");\r\nif (!np)\r\nreturn -ENODEV;\r\nsensor_np = of_get_next_child(np, NULL);\r\nret = of_parse_phandle_with_args(sensor_np, "thermal-sensors",\r\n"#thermal-sensor-cells",\r\n0, &sensor_specs);\r\nif (ret) {\r\nof_node_put(np);\r\nof_node_put(sensor_np);\r\nreturn ret;\r\n}\r\nif (sensor_specs.args_count >= 1) {\r\nid = sensor_specs.args[0];\r\nWARN(sensor_specs.args_count > 1,\r\n"%s: too many cells in sensor specifier %d\n",\r\nsensor_specs.np->name, sensor_specs.args_count);\r\n} else {\r\nid = 0;\r\n}\r\nof_node_put(np);\r\nof_node_put(sensor_np);\r\nreturn id;\r\n}\r\nstatic int qoriq_tmu_calibration(struct platform_device *pdev)\r\n{\r\nint i, val, len;\r\nu32 range[4];\r\nconst u32 *calibration;\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct qoriq_tmu_data *data = platform_get_drvdata(pdev);\r\nif (of_property_read_u32_array(np, "fsl,tmu-range", range, 4)) {\r\ndev_err(&pdev->dev, "missing calibration range.\n");\r\nreturn -ENODEV;\r\n}\r\ntmu_write(data, range[0], &data->regs->ttr0cr);\r\ntmu_write(data, range[1], &data->regs->ttr1cr);\r\ntmu_write(data, range[2], &data->regs->ttr2cr);\r\ntmu_write(data, range[3], &data->regs->ttr3cr);\r\ncalibration = of_get_property(np, "fsl,tmu-calibration", &len);\r\nif (calibration == NULL || len % 8) {\r\ndev_err(&pdev->dev, "invalid calibration data.\n");\r\nreturn -ENODEV;\r\n}\r\nfor (i = 0; i < len; i += 8, calibration += 2) {\r\nval = of_read_number(calibration, 1);\r\ntmu_write(data, val, &data->regs->ttcfgr);\r\nval = of_read_number(calibration + 1, 1);\r\ntmu_write(data, val, &data->regs->tscfgr);\r\n}\r\nreturn 0;\r\n}\r\nstatic void qoriq_tmu_init_device(struct qoriq_tmu_data *data)\r\n{\r\ntmu_write(data, TIER_DISABLE, &data->regs->tier);\r\ntmu_write(data, TMTMIR_DEFAULT, &data->regs->tmtmir);\r\ntmu_write(data, TMR_DISABLE, &data->regs->tmr);\r\n}\r\nstatic int qoriq_tmu_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nconst struct thermal_trip *trip;\r\nstruct qoriq_tmu_data *data;\r\nstruct device_node *np = pdev->dev.of_node;\r\nu32 site = 0;\r\nif (!np) {\r\ndev_err(&pdev->dev, "Device OF-Node is NULL");\r\nreturn -ENODEV;\r\n}\r\ndata = devm_kzalloc(&pdev->dev, sizeof(struct qoriq_tmu_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, data);\r\ndata->little_endian = of_property_read_bool(np, "little-endian");\r\ndata->sensor_id = qoriq_tmu_get_sensor_id();\r\nif (data->sensor_id < 0) {\r\ndev_err(&pdev->dev, "Failed to get sensor id\n");\r\nret = -ENODEV;\r\ngoto err_iomap;\r\n}\r\ndata->regs = of_iomap(np, 0);\r\nif (!data->regs) {\r\ndev_err(&pdev->dev, "Failed to get memory region\n");\r\nret = -ENODEV;\r\ngoto err_iomap;\r\n}\r\nqoriq_tmu_init_device(data);\r\nret = qoriq_tmu_calibration(pdev);\r\nif (ret < 0)\r\ngoto err_tmu;\r\ndata->tz = thermal_zone_of_sensor_register(&pdev->dev, data->sensor_id,\r\ndata, &tmu_tz_ops);\r\nif (IS_ERR(data->tz)) {\r\nret = PTR_ERR(data->tz);\r\ndev_err(&pdev->dev,\r\n"Failed to register thermal zone device %d\n", ret);\r\ngoto err_tmu;\r\n}\r\ntrip = of_thermal_get_trip_points(data->tz);\r\nsite |= 0x1 << (15 - data->sensor_id);\r\ntmu_write(data, site | TMR_ME | TMR_ALPF, &data->regs->tmr);\r\nreturn 0;\r\nerr_tmu:\r\niounmap(data->regs);\r\nerr_iomap:\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn ret;\r\n}\r\nstatic int qoriq_tmu_remove(struct platform_device *pdev)\r\n{\r\nstruct qoriq_tmu_data *data = platform_get_drvdata(pdev);\r\nthermal_zone_of_sensor_unregister(&pdev->dev, data->tz);\r\ntmu_write(data, TMR_DISABLE, &data->regs->tmr);\r\niounmap(data->regs);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int qoriq_tmu_suspend(struct device *dev)\r\n{\r\nu32 tmr;\r\nstruct qoriq_tmu_data *data = dev_get_drvdata(dev);\r\ntmr = tmu_read(data, &data->regs->tmr);\r\ntmr &= ~TMR_ME;\r\ntmu_write(data, tmr, &data->regs->tmr);\r\nreturn 0;\r\n}\r\nstatic int qoriq_tmu_resume(struct device *dev)\r\n{\r\nu32 tmr;\r\nstruct qoriq_tmu_data *data = dev_get_drvdata(dev);\r\ntmr = tmu_read(data, &data->regs->tmr);\r\ntmr |= TMR_ME;\r\ntmu_write(data, tmr, &data->regs->tmr);\r\nreturn 0;\r\n}

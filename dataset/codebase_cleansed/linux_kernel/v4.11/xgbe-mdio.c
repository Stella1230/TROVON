static void xgbe_an37_clear_interrupts(struct xgbe_prv_data *pdata)\r\n{\r\nint reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_VEND2, MDIO_VEND2_AN_STAT);\r\nreg &= ~XGBE_AN_CL37_INT_MASK;\r\nXMDIO_WRITE(pdata, MDIO_MMD_VEND2, MDIO_VEND2_AN_STAT, reg);\r\n}\r\nstatic void xgbe_an37_disable_interrupts(struct xgbe_prv_data *pdata)\r\n{\r\nint reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_VEND2, MDIO_VEND2_AN_CTRL);\r\nreg &= ~XGBE_AN_CL37_INT_MASK;\r\nXMDIO_WRITE(pdata, MDIO_MMD_VEND2, MDIO_VEND2_AN_CTRL, reg);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_PCS_DIG_CTRL);\r\nreg &= ~XGBE_PCS_CL37_BP;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PCS, MDIO_PCS_DIG_CTRL, reg);\r\n}\r\nstatic void xgbe_an37_enable_interrupts(struct xgbe_prv_data *pdata)\r\n{\r\nint reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_PCS_DIG_CTRL);\r\nreg |= XGBE_PCS_CL37_BP;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PCS, MDIO_PCS_DIG_CTRL, reg);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_VEND2, MDIO_VEND2_AN_CTRL);\r\nreg |= XGBE_AN_CL37_INT_MASK;\r\nXMDIO_WRITE(pdata, MDIO_MMD_VEND2, MDIO_VEND2_AN_CTRL, reg);\r\n}\r\nstatic void xgbe_an73_clear_interrupts(struct xgbe_prv_data *pdata)\r\n{\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_INT, 0);\r\n}\r\nstatic void xgbe_an73_disable_interrupts(struct xgbe_prv_data *pdata)\r\n{\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_INTMASK, 0);\r\n}\r\nstatic void xgbe_an73_enable_interrupts(struct xgbe_prv_data *pdata)\r\n{\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_INTMASK, XGBE_AN_CL73_INT_MASK);\r\n}\r\nstatic void xgbe_an_enable_interrupts(struct xgbe_prv_data *pdata)\r\n{\r\nswitch (pdata->an_mode) {\r\ncase XGBE_AN_MODE_CL73:\r\ncase XGBE_AN_MODE_CL73_REDRV:\r\nxgbe_an73_enable_interrupts(pdata);\r\nbreak;\r\ncase XGBE_AN_MODE_CL37:\r\ncase XGBE_AN_MODE_CL37_SGMII:\r\nxgbe_an37_enable_interrupts(pdata);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void xgbe_an_clear_interrupts_all(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_an73_clear_interrupts(pdata);\r\nxgbe_an37_clear_interrupts(pdata);\r\n}\r\nstatic void xgbe_an73_enable_kr_training(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_PMD_CTRL);\r\nreg |= XGBE_KR_TRAINING_ENABLE;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_PMD_CTRL, reg);\r\n}\r\nstatic void xgbe_an73_disable_kr_training(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_PMD_CTRL);\r\nreg &= ~XGBE_KR_TRAINING_ENABLE;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_PMD_CTRL, reg);\r\n}\r\nstatic void xgbe_kr_mode(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_an73_enable_kr_training(pdata);\r\npdata->hw_if.set_speed(pdata, SPEED_10000);\r\npdata->phy_if.phy_impl.set_mode(pdata, XGBE_MODE_KR);\r\n}\r\nstatic void xgbe_kx_2500_mode(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_an73_disable_kr_training(pdata);\r\npdata->hw_if.set_speed(pdata, SPEED_2500);\r\npdata->phy_if.phy_impl.set_mode(pdata, XGBE_MODE_KX_2500);\r\n}\r\nstatic void xgbe_kx_1000_mode(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_an73_disable_kr_training(pdata);\r\npdata->hw_if.set_speed(pdata, SPEED_1000);\r\npdata->phy_if.phy_impl.set_mode(pdata, XGBE_MODE_KX_1000);\r\n}\r\nstatic void xgbe_sfi_mode(struct xgbe_prv_data *pdata)\r\n{\r\nif (pdata->kr_redrv)\r\nreturn xgbe_kr_mode(pdata);\r\nxgbe_an73_disable_kr_training(pdata);\r\npdata->hw_if.set_speed(pdata, SPEED_10000);\r\npdata->phy_if.phy_impl.set_mode(pdata, XGBE_MODE_SFI);\r\n}\r\nstatic void xgbe_x_mode(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_an73_disable_kr_training(pdata);\r\npdata->hw_if.set_speed(pdata, SPEED_1000);\r\npdata->phy_if.phy_impl.set_mode(pdata, XGBE_MODE_X);\r\n}\r\nstatic void xgbe_sgmii_1000_mode(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_an73_disable_kr_training(pdata);\r\npdata->hw_if.set_speed(pdata, SPEED_1000);\r\npdata->phy_if.phy_impl.set_mode(pdata, XGBE_MODE_SGMII_1000);\r\n}\r\nstatic void xgbe_sgmii_100_mode(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_an73_disable_kr_training(pdata);\r\npdata->hw_if.set_speed(pdata, SPEED_1000);\r\npdata->phy_if.phy_impl.set_mode(pdata, XGBE_MODE_SGMII_100);\r\n}\r\nstatic enum xgbe_mode xgbe_cur_mode(struct xgbe_prv_data *pdata)\r\n{\r\nreturn pdata->phy_if.phy_impl.cur_mode(pdata);\r\n}\r\nstatic bool xgbe_in_kr_mode(struct xgbe_prv_data *pdata)\r\n{\r\nreturn (xgbe_cur_mode(pdata) == XGBE_MODE_KR);\r\n}\r\nstatic void xgbe_change_mode(struct xgbe_prv_data *pdata,\r\nenum xgbe_mode mode)\r\n{\r\nswitch (mode) {\r\ncase XGBE_MODE_KX_1000:\r\nxgbe_kx_1000_mode(pdata);\r\nbreak;\r\ncase XGBE_MODE_KX_2500:\r\nxgbe_kx_2500_mode(pdata);\r\nbreak;\r\ncase XGBE_MODE_KR:\r\nxgbe_kr_mode(pdata);\r\nbreak;\r\ncase XGBE_MODE_SGMII_100:\r\nxgbe_sgmii_100_mode(pdata);\r\nbreak;\r\ncase XGBE_MODE_SGMII_1000:\r\nxgbe_sgmii_1000_mode(pdata);\r\nbreak;\r\ncase XGBE_MODE_X:\r\nxgbe_x_mode(pdata);\r\nbreak;\r\ncase XGBE_MODE_SFI:\r\nxgbe_sfi_mode(pdata);\r\nbreak;\r\ncase XGBE_MODE_UNKNOWN:\r\nbreak;\r\ndefault:\r\nnetif_dbg(pdata, link, pdata->netdev,\r\n"invalid operation mode requested (%u)\n", mode);\r\n}\r\n}\r\nstatic void xgbe_switch_mode(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_change_mode(pdata, pdata->phy_if.phy_impl.switch_mode(pdata));\r\n}\r\nstatic void xgbe_set_mode(struct xgbe_prv_data *pdata,\r\nenum xgbe_mode mode)\r\n{\r\nif (mode == xgbe_cur_mode(pdata))\r\nreturn;\r\nxgbe_change_mode(pdata, mode);\r\n}\r\nstatic bool xgbe_use_mode(struct xgbe_prv_data *pdata,\r\nenum xgbe_mode mode)\r\n{\r\nreturn pdata->phy_if.phy_impl.use_mode(pdata, mode);\r\n}\r\nstatic void xgbe_an37_set(struct xgbe_prv_data *pdata, bool enable,\r\nbool restart)\r\n{\r\nunsigned int reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_VEND2, MDIO_CTRL1);\r\nreg &= ~MDIO_VEND2_CTRL1_AN_ENABLE;\r\nif (enable)\r\nreg |= MDIO_VEND2_CTRL1_AN_ENABLE;\r\nif (restart)\r\nreg |= MDIO_VEND2_CTRL1_AN_RESTART;\r\nXMDIO_WRITE(pdata, MDIO_MMD_VEND2, MDIO_CTRL1, reg);\r\n}\r\nstatic void xgbe_an37_restart(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_an37_enable_interrupts(pdata);\r\nxgbe_an37_set(pdata, true, true);\r\nnetif_dbg(pdata, link, pdata->netdev, "CL37 AN enabled/restarted\n");\r\n}\r\nstatic void xgbe_an37_disable(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_an37_set(pdata, false, false);\r\nxgbe_an37_disable_interrupts(pdata);\r\nnetif_dbg(pdata, link, pdata->netdev, "CL37 AN disabled\n");\r\n}\r\nstatic void xgbe_an73_set(struct xgbe_prv_data *pdata, bool enable,\r\nbool restart)\r\n{\r\nunsigned int reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_CTRL1);\r\nreg &= ~MDIO_AN_CTRL1_ENABLE;\r\nif (enable)\r\nreg |= MDIO_AN_CTRL1_ENABLE;\r\nif (restart)\r\nreg |= MDIO_AN_CTRL1_RESTART;\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_CTRL1, reg);\r\n}\r\nstatic void xgbe_an73_restart(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_an73_enable_interrupts(pdata);\r\nxgbe_an73_set(pdata, true, true);\r\nnetif_dbg(pdata, link, pdata->netdev, "CL73 AN enabled/restarted\n");\r\n}\r\nstatic void xgbe_an73_disable(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_an73_set(pdata, false, false);\r\nxgbe_an73_disable_interrupts(pdata);\r\nnetif_dbg(pdata, link, pdata->netdev, "CL73 AN disabled\n");\r\n}\r\nstatic void xgbe_an_restart(struct xgbe_prv_data *pdata)\r\n{\r\nswitch (pdata->an_mode) {\r\ncase XGBE_AN_MODE_CL73:\r\ncase XGBE_AN_MODE_CL73_REDRV:\r\nxgbe_an73_restart(pdata);\r\nbreak;\r\ncase XGBE_AN_MODE_CL37:\r\ncase XGBE_AN_MODE_CL37_SGMII:\r\nxgbe_an37_restart(pdata);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void xgbe_an_disable(struct xgbe_prv_data *pdata)\r\n{\r\nswitch (pdata->an_mode) {\r\ncase XGBE_AN_MODE_CL73:\r\ncase XGBE_AN_MODE_CL73_REDRV:\r\nxgbe_an73_disable(pdata);\r\nbreak;\r\ncase XGBE_AN_MODE_CL37:\r\ncase XGBE_AN_MODE_CL37_SGMII:\r\nxgbe_an37_disable(pdata);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void xgbe_an_disable_all(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_an73_disable(pdata);\r\nxgbe_an37_disable(pdata);\r\n}\r\nstatic enum xgbe_an xgbe_an73_tx_training(struct xgbe_prv_data *pdata,\r\nenum xgbe_rx *state)\r\n{\r\nunsigned int ad_reg, lp_reg, reg;\r\n*state = XGBE_RX_COMPLETE;\r\nif (!xgbe_in_kr_mode(pdata))\r\nreturn XGBE_AN_PAGE_RECEIVED;\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 2);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPA + 2);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_FECCTRL);\r\nreg &= ~(MDIO_PMA_10GBR_FECABLE_ABLE | MDIO_PMA_10GBR_FECABLE_ERRABLE);\r\nif ((ad_reg & 0xc000) && (lp_reg & 0xc000))\r\nreg |= pdata->fec_ability;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_FECCTRL, reg);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_PMD_CTRL);\r\nif (reg & XGBE_KR_TRAINING_ENABLE) {\r\nif (pdata->phy_if.phy_impl.kr_training_pre)\r\npdata->phy_if.phy_impl.kr_training_pre(pdata);\r\nreg |= XGBE_KR_TRAINING_START;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_PMD_CTRL,\r\nreg);\r\nif (pdata->phy_if.phy_impl.kr_training_post)\r\npdata->phy_if.phy_impl.kr_training_post(pdata);\r\nnetif_dbg(pdata, link, pdata->netdev,\r\n"KR training initiated\n");\r\n}\r\nreturn XGBE_AN_PAGE_RECEIVED;\r\n}\r\nstatic enum xgbe_an xgbe_an73_tx_xnp(struct xgbe_prv_data *pdata,\r\nenum xgbe_rx *state)\r\n{\r\nu16 msg;\r\n*state = XGBE_RX_XNP;\r\nmsg = XGBE_XNP_MCF_NULL_MESSAGE;\r\nmsg |= XGBE_XNP_MP_FORMATTED;\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_XNP + 2, 0);\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_XNP + 1, 0);\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_XNP, msg);\r\nreturn XGBE_AN_PAGE_RECEIVED;\r\n}\r\nstatic enum xgbe_an xgbe_an73_rx_bpa(struct xgbe_prv_data *pdata,\r\nenum xgbe_rx *state)\r\n{\r\nunsigned int link_support;\r\nunsigned int reg, ad_reg, lp_reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPA + 1);\r\nlink_support = xgbe_in_kr_mode(pdata) ? 0x80 : 0x20;\r\nif (!(reg & link_support))\r\nreturn XGBE_AN_INCOMPAT_LINK;\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPA);\r\nreturn ((ad_reg & XGBE_XNP_NP_EXCHANGE) ||\r\n(lp_reg & XGBE_XNP_NP_EXCHANGE))\r\n? xgbe_an73_tx_xnp(pdata, state)\r\n: xgbe_an73_tx_training(pdata, state);\r\n}\r\nstatic enum xgbe_an xgbe_an73_rx_xnp(struct xgbe_prv_data *pdata,\r\nenum xgbe_rx *state)\r\n{\r\nunsigned int ad_reg, lp_reg;\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_XNP);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPX);\r\nreturn ((ad_reg & XGBE_XNP_NP_EXCHANGE) ||\r\n(lp_reg & XGBE_XNP_NP_EXCHANGE))\r\n? xgbe_an73_tx_xnp(pdata, state)\r\n: xgbe_an73_tx_training(pdata, state);\r\n}\r\nstatic enum xgbe_an xgbe_an73_page_received(struct xgbe_prv_data *pdata)\r\n{\r\nenum xgbe_rx *state;\r\nunsigned long an_timeout;\r\nenum xgbe_an ret;\r\nif (!pdata->an_start) {\r\npdata->an_start = jiffies;\r\n} else {\r\nan_timeout = pdata->an_start +\r\nmsecs_to_jiffies(XGBE_AN_MS_TIMEOUT);\r\nif (time_after(jiffies, an_timeout)) {\r\npdata->kr_state = XGBE_RX_BPA;\r\npdata->kx_state = XGBE_RX_BPA;\r\npdata->an_start = jiffies;\r\nnetif_dbg(pdata, link, pdata->netdev,\r\n"CL73 AN timed out, resetting state\n");\r\n}\r\n}\r\nstate = xgbe_in_kr_mode(pdata) ? &pdata->kr_state\r\n: &pdata->kx_state;\r\nswitch (*state) {\r\ncase XGBE_RX_BPA:\r\nret = xgbe_an73_rx_bpa(pdata, state);\r\nbreak;\r\ncase XGBE_RX_XNP:\r\nret = xgbe_an73_rx_xnp(pdata, state);\r\nbreak;\r\ndefault:\r\nret = XGBE_AN_ERROR;\r\n}\r\nreturn ret;\r\n}\r\nstatic enum xgbe_an xgbe_an73_incompat_link(struct xgbe_prv_data *pdata)\r\n{\r\nif (xgbe_in_kr_mode(pdata)) {\r\npdata->kr_state = XGBE_RX_ERROR;\r\nif (!(pdata->phy.advertising & ADVERTISED_1000baseKX_Full) &&\r\n!(pdata->phy.advertising & ADVERTISED_2500baseX_Full))\r\nreturn XGBE_AN_NO_LINK;\r\nif (pdata->kx_state != XGBE_RX_BPA)\r\nreturn XGBE_AN_NO_LINK;\r\n} else {\r\npdata->kx_state = XGBE_RX_ERROR;\r\nif (!(pdata->phy.advertising & ADVERTISED_10000baseKR_Full))\r\nreturn XGBE_AN_NO_LINK;\r\nif (pdata->kr_state != XGBE_RX_BPA)\r\nreturn XGBE_AN_NO_LINK;\r\n}\r\nxgbe_an73_disable(pdata);\r\nxgbe_switch_mode(pdata);\r\nxgbe_an73_restart(pdata);\r\nreturn XGBE_AN_INCOMPAT_LINK;\r\n}\r\nstatic void xgbe_an37_isr(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int reg;\r\nxgbe_an37_disable_interrupts(pdata);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_VEND2, MDIO_VEND2_AN_STAT);\r\npdata->an_int = reg & XGBE_AN_CL37_INT_MASK;\r\npdata->an_status = reg & ~XGBE_AN_CL37_INT_MASK;\r\nif (pdata->an_int) {\r\nreg &= ~XGBE_AN_CL37_INT_MASK;\r\nXMDIO_WRITE(pdata, MDIO_MMD_VEND2, MDIO_VEND2_AN_STAT, reg);\r\nqueue_work(pdata->an_workqueue, &pdata->an_irq_work);\r\n} else {\r\nxgbe_an37_enable_interrupts(pdata);\r\n}\r\n}\r\nstatic void xgbe_an73_isr(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_an73_disable_interrupts(pdata);\r\npdata->an_int = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_INT);\r\nif (pdata->an_int) {\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_INT, ~pdata->an_int);\r\nqueue_work(pdata->an_workqueue, &pdata->an_irq_work);\r\n} else {\r\nxgbe_an73_enable_interrupts(pdata);\r\n}\r\n}\r\nstatic irqreturn_t xgbe_an_isr(int irq, void *data)\r\n{\r\nstruct xgbe_prv_data *pdata = (struct xgbe_prv_data *)data;\r\nnetif_dbg(pdata, intr, pdata->netdev, "AN interrupt received\n");\r\nswitch (pdata->an_mode) {\r\ncase XGBE_AN_MODE_CL73:\r\ncase XGBE_AN_MODE_CL73_REDRV:\r\nxgbe_an73_isr(pdata);\r\nbreak;\r\ncase XGBE_AN_MODE_CL37:\r\ncase XGBE_AN_MODE_CL37_SGMII:\r\nxgbe_an37_isr(pdata);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t xgbe_an_combined_isr(int irq, struct xgbe_prv_data *pdata)\r\n{\r\nreturn xgbe_an_isr(irq, pdata);\r\n}\r\nstatic void xgbe_an_irq_work(struct work_struct *work)\r\n{\r\nstruct xgbe_prv_data *pdata = container_of(work,\r\nstruct xgbe_prv_data,\r\nan_irq_work);\r\nflush_work(&pdata->an_work);\r\nqueue_work(pdata->an_workqueue, &pdata->an_work);\r\n}\r\nstatic const char *xgbe_state_as_string(enum xgbe_an state)\r\n{\r\nswitch (state) {\r\ncase XGBE_AN_READY:\r\nreturn "Ready";\r\ncase XGBE_AN_PAGE_RECEIVED:\r\nreturn "Page-Received";\r\ncase XGBE_AN_INCOMPAT_LINK:\r\nreturn "Incompatible-Link";\r\ncase XGBE_AN_COMPLETE:\r\nreturn "Complete";\r\ncase XGBE_AN_NO_LINK:\r\nreturn "No-Link";\r\ncase XGBE_AN_ERROR:\r\nreturn "Error";\r\ndefault:\r\nreturn "Undefined";\r\n}\r\n}\r\nstatic void xgbe_an37_state_machine(struct xgbe_prv_data *pdata)\r\n{\r\nenum xgbe_an cur_state = pdata->an_state;\r\nif (!pdata->an_int)\r\nreturn;\r\nif (pdata->an_int & XGBE_AN_CL37_INT_CMPLT) {\r\npdata->an_state = XGBE_AN_COMPLETE;\r\npdata->an_int &= ~XGBE_AN_CL37_INT_CMPLT;\r\nif ((pdata->an_mode == XGBE_AN_MODE_CL37_SGMII) &&\r\n!(pdata->an_status & XGBE_SGMII_AN_LINK_STATUS))\r\npdata->an_state = XGBE_AN_NO_LINK;\r\n}\r\nnetif_dbg(pdata, link, pdata->netdev, "CL37 AN %s\n",\r\nxgbe_state_as_string(pdata->an_state));\r\ncur_state = pdata->an_state;\r\nswitch (pdata->an_state) {\r\ncase XGBE_AN_READY:\r\nbreak;\r\ncase XGBE_AN_COMPLETE:\r\nnetif_dbg(pdata, link, pdata->netdev,\r\n"Auto negotiation successful\n");\r\nbreak;\r\ncase XGBE_AN_NO_LINK:\r\nbreak;\r\ndefault:\r\npdata->an_state = XGBE_AN_ERROR;\r\n}\r\nif (pdata->an_state == XGBE_AN_ERROR) {\r\nnetdev_err(pdata->netdev,\r\n"error during auto-negotiation, state=%u\n",\r\ncur_state);\r\npdata->an_int = 0;\r\nxgbe_an37_clear_interrupts(pdata);\r\n}\r\nif (pdata->an_state >= XGBE_AN_COMPLETE) {\r\npdata->an_result = pdata->an_state;\r\npdata->an_state = XGBE_AN_READY;\r\nnetif_dbg(pdata, link, pdata->netdev, "CL37 AN result: %s\n",\r\nxgbe_state_as_string(pdata->an_result));\r\n}\r\nxgbe_an37_enable_interrupts(pdata);\r\n}\r\nstatic void xgbe_an73_state_machine(struct xgbe_prv_data *pdata)\r\n{\r\nenum xgbe_an cur_state = pdata->an_state;\r\nif (!pdata->an_int)\r\nreturn;\r\nnext_int:\r\nif (pdata->an_int & XGBE_AN_CL73_PG_RCV) {\r\npdata->an_state = XGBE_AN_PAGE_RECEIVED;\r\npdata->an_int &= ~XGBE_AN_CL73_PG_RCV;\r\n} else if (pdata->an_int & XGBE_AN_CL73_INC_LINK) {\r\npdata->an_state = XGBE_AN_INCOMPAT_LINK;\r\npdata->an_int &= ~XGBE_AN_CL73_INC_LINK;\r\n} else if (pdata->an_int & XGBE_AN_CL73_INT_CMPLT) {\r\npdata->an_state = XGBE_AN_COMPLETE;\r\npdata->an_int &= ~XGBE_AN_CL73_INT_CMPLT;\r\n} else {\r\npdata->an_state = XGBE_AN_ERROR;\r\n}\r\nagain:\r\nnetif_dbg(pdata, link, pdata->netdev, "CL73 AN %s\n",\r\nxgbe_state_as_string(pdata->an_state));\r\ncur_state = pdata->an_state;\r\nswitch (pdata->an_state) {\r\ncase XGBE_AN_READY:\r\npdata->an_supported = 0;\r\nbreak;\r\ncase XGBE_AN_PAGE_RECEIVED:\r\npdata->an_state = xgbe_an73_page_received(pdata);\r\npdata->an_supported++;\r\nbreak;\r\ncase XGBE_AN_INCOMPAT_LINK:\r\npdata->an_supported = 0;\r\npdata->parallel_detect = 0;\r\npdata->an_state = xgbe_an73_incompat_link(pdata);\r\nbreak;\r\ncase XGBE_AN_COMPLETE:\r\npdata->parallel_detect = pdata->an_supported ? 0 : 1;\r\nnetif_dbg(pdata, link, pdata->netdev, "%s successful\n",\r\npdata->an_supported ? "Auto negotiation"\r\n: "Parallel detection");\r\nbreak;\r\ncase XGBE_AN_NO_LINK:\r\nbreak;\r\ndefault:\r\npdata->an_state = XGBE_AN_ERROR;\r\n}\r\nif (pdata->an_state == XGBE_AN_NO_LINK) {\r\npdata->an_int = 0;\r\nxgbe_an73_clear_interrupts(pdata);\r\n} else if (pdata->an_state == XGBE_AN_ERROR) {\r\nnetdev_err(pdata->netdev,\r\n"error during auto-negotiation, state=%u\n",\r\ncur_state);\r\npdata->an_int = 0;\r\nxgbe_an73_clear_interrupts(pdata);\r\n}\r\nif (pdata->an_state >= XGBE_AN_COMPLETE) {\r\npdata->an_result = pdata->an_state;\r\npdata->an_state = XGBE_AN_READY;\r\npdata->kr_state = XGBE_RX_BPA;\r\npdata->kx_state = XGBE_RX_BPA;\r\npdata->an_start = 0;\r\nnetif_dbg(pdata, link, pdata->netdev, "CL73 AN result: %s\n",\r\nxgbe_state_as_string(pdata->an_result));\r\n}\r\nif (cur_state != pdata->an_state)\r\ngoto again;\r\nif (pdata->an_int)\r\ngoto next_int;\r\nxgbe_an73_enable_interrupts(pdata);\r\n}\r\nstatic void xgbe_an_state_machine(struct work_struct *work)\r\n{\r\nstruct xgbe_prv_data *pdata = container_of(work,\r\nstruct xgbe_prv_data,\r\nan_work);\r\nmutex_lock(&pdata->an_mutex);\r\nswitch (pdata->an_mode) {\r\ncase XGBE_AN_MODE_CL73:\r\ncase XGBE_AN_MODE_CL73_REDRV:\r\nxgbe_an73_state_machine(pdata);\r\nbreak;\r\ncase XGBE_AN_MODE_CL37:\r\ncase XGBE_AN_MODE_CL37_SGMII:\r\nxgbe_an37_state_machine(pdata);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nmutex_unlock(&pdata->an_mutex);\r\n}\r\nstatic void xgbe_an37_init(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int advertising, reg;\r\nadvertising = pdata->phy_if.phy_impl.an_advertising(pdata);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_VEND2, MDIO_VEND2_AN_ADVERTISE);\r\nif (advertising & ADVERTISED_Pause)\r\nreg |= 0x100;\r\nelse\r\nreg &= ~0x100;\r\nif (advertising & ADVERTISED_Asym_Pause)\r\nreg |= 0x80;\r\nelse\r\nreg &= ~0x80;\r\nreg |= XGBE_AN_CL37_FD_MASK;\r\nreg &= ~XGBE_AN_CL37_HD_MASK;\r\nXMDIO_WRITE(pdata, MDIO_MMD_VEND2, MDIO_VEND2_AN_ADVERTISE, reg);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_VEND2, MDIO_VEND2_AN_CTRL);\r\nreg &= ~XGBE_AN_CL37_TX_CONFIG_MASK;\r\nreg &= ~XGBE_AN_CL37_PCS_MODE_MASK;\r\nswitch (pdata->an_mode) {\r\ncase XGBE_AN_MODE_CL37:\r\nreg |= XGBE_AN_CL37_PCS_MODE_BASEX;\r\nbreak;\r\ncase XGBE_AN_MODE_CL37_SGMII:\r\nreg |= XGBE_AN_CL37_PCS_MODE_SGMII;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nXMDIO_WRITE(pdata, MDIO_MMD_VEND2, MDIO_VEND2_AN_CTRL, reg);\r\nnetif_dbg(pdata, link, pdata->netdev, "CL37 AN (%s) initialized\n",\r\n(pdata->an_mode == XGBE_AN_MODE_CL37) ? "BaseX" : "SGMII");\r\n}\r\nstatic void xgbe_an73_init(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int advertising, reg;\r\nadvertising = pdata->phy_if.phy_impl.an_advertising(pdata);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 2);\r\nif (advertising & ADVERTISED_10000baseR_FEC)\r\nreg |= 0xc000;\r\nelse\r\nreg &= ~0xc000;\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 2, reg);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 1);\r\nif (advertising & ADVERTISED_10000baseKR_Full)\r\nreg |= 0x80;\r\nelse\r\nreg &= ~0x80;\r\nif ((advertising & ADVERTISED_1000baseKX_Full) ||\r\n(advertising & ADVERTISED_2500baseX_Full))\r\nreg |= 0x20;\r\nelse\r\nreg &= ~0x20;\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 1, reg);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE);\r\nif (advertising & ADVERTISED_Pause)\r\nreg |= 0x400;\r\nelse\r\nreg &= ~0x400;\r\nif (advertising & ADVERTISED_Asym_Pause)\r\nreg |= 0x800;\r\nelse\r\nreg &= ~0x800;\r\nreg &= ~XGBE_XNP_NP_EXCHANGE;\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE, reg);\r\nnetif_dbg(pdata, link, pdata->netdev, "CL73 AN initialized\n");\r\n}\r\nstatic void xgbe_an_init(struct xgbe_prv_data *pdata)\r\n{\r\npdata->an_mode = pdata->phy_if.phy_impl.an_mode(pdata);\r\nswitch (pdata->an_mode) {\r\ncase XGBE_AN_MODE_CL73:\r\ncase XGBE_AN_MODE_CL73_REDRV:\r\nxgbe_an73_init(pdata);\r\nbreak;\r\ncase XGBE_AN_MODE_CL37:\r\ncase XGBE_AN_MODE_CL37_SGMII:\r\nxgbe_an37_init(pdata);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic const char *xgbe_phy_fc_string(struct xgbe_prv_data *pdata)\r\n{\r\nif (pdata->tx_pause && pdata->rx_pause)\r\nreturn "rx/tx";\r\nelse if (pdata->rx_pause)\r\nreturn "rx";\r\nelse if (pdata->tx_pause)\r\nreturn "tx";\r\nelse\r\nreturn "off";\r\n}\r\nstatic const char *xgbe_phy_speed_string(int speed)\r\n{\r\nswitch (speed) {\r\ncase SPEED_100:\r\nreturn "100Mbps";\r\ncase SPEED_1000:\r\nreturn "1Gbps";\r\ncase SPEED_2500:\r\nreturn "2.5Gbps";\r\ncase SPEED_10000:\r\nreturn "10Gbps";\r\ncase SPEED_UNKNOWN:\r\nreturn "Unknown";\r\ndefault:\r\nreturn "Unsupported";\r\n}\r\n}\r\nstatic void xgbe_phy_print_status(struct xgbe_prv_data *pdata)\r\n{\r\nif (pdata->phy.link)\r\nnetdev_info(pdata->netdev,\r\n"Link is Up - %s/%s - flow control %s\n",\r\nxgbe_phy_speed_string(pdata->phy.speed),\r\npdata->phy.duplex == DUPLEX_FULL ? "Full" : "Half",\r\nxgbe_phy_fc_string(pdata));\r\nelse\r\nnetdev_info(pdata->netdev, "Link is Down\n");\r\n}\r\nstatic void xgbe_phy_adjust_link(struct xgbe_prv_data *pdata)\r\n{\r\nint new_state = 0;\r\nif (pdata->phy.link) {\r\npdata->pause_autoneg = pdata->phy.pause_autoneg;\r\nif (pdata->tx_pause != pdata->phy.tx_pause) {\r\nnew_state = 1;\r\npdata->hw_if.config_tx_flow_control(pdata);\r\npdata->tx_pause = pdata->phy.tx_pause;\r\n}\r\nif (pdata->rx_pause != pdata->phy.rx_pause) {\r\nnew_state = 1;\r\npdata->hw_if.config_rx_flow_control(pdata);\r\npdata->rx_pause = pdata->phy.rx_pause;\r\n}\r\nif (pdata->phy_speed != pdata->phy.speed) {\r\nnew_state = 1;\r\npdata->phy_speed = pdata->phy.speed;\r\n}\r\nif (pdata->phy_link != pdata->phy.link) {\r\nnew_state = 1;\r\npdata->phy_link = pdata->phy.link;\r\n}\r\n} else if (pdata->phy_link) {\r\nnew_state = 1;\r\npdata->phy_link = 0;\r\npdata->phy_speed = SPEED_UNKNOWN;\r\n}\r\nif (new_state && netif_msg_link(pdata))\r\nxgbe_phy_print_status(pdata);\r\n}\r\nstatic bool xgbe_phy_valid_speed(struct xgbe_prv_data *pdata, int speed)\r\n{\r\nreturn pdata->phy_if.phy_impl.valid_speed(pdata, speed);\r\n}\r\nstatic int xgbe_phy_config_fixed(struct xgbe_prv_data *pdata)\r\n{\r\nenum xgbe_mode mode;\r\nnetif_dbg(pdata, link, pdata->netdev, "fixed PHY configuration\n");\r\nxgbe_an_disable(pdata);\r\nmode = pdata->phy_if.phy_impl.get_mode(pdata, pdata->phy.speed);\r\nswitch (mode) {\r\ncase XGBE_MODE_KX_1000:\r\ncase XGBE_MODE_KX_2500:\r\ncase XGBE_MODE_KR:\r\ncase XGBE_MODE_SGMII_100:\r\ncase XGBE_MODE_SGMII_1000:\r\ncase XGBE_MODE_X:\r\ncase XGBE_MODE_SFI:\r\nbreak;\r\ncase XGBE_MODE_UNKNOWN:\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (pdata->phy.duplex != DUPLEX_FULL)\r\nreturn -EINVAL;\r\nxgbe_set_mode(pdata, mode);\r\nreturn 0;\r\n}\r\nstatic int __xgbe_phy_config_aneg(struct xgbe_prv_data *pdata)\r\n{\r\nint ret;\r\nset_bit(XGBE_LINK_INIT, &pdata->dev_state);\r\npdata->link_check = jiffies;\r\nret = pdata->phy_if.phy_impl.an_config(pdata);\r\nif (ret)\r\nreturn ret;\r\nif (pdata->phy.autoneg != AUTONEG_ENABLE) {\r\nret = xgbe_phy_config_fixed(pdata);\r\nif (ret || !pdata->kr_redrv)\r\nreturn ret;\r\nnetif_dbg(pdata, link, pdata->netdev, "AN redriver support\n");\r\n} else {\r\nnetif_dbg(pdata, link, pdata->netdev, "AN PHY configuration\n");\r\n}\r\ndisable_irq(pdata->an_irq);\r\nif (xgbe_use_mode(pdata, XGBE_MODE_KR)) {\r\nxgbe_set_mode(pdata, XGBE_MODE_KR);\r\n} else if (xgbe_use_mode(pdata, XGBE_MODE_KX_2500)) {\r\nxgbe_set_mode(pdata, XGBE_MODE_KX_2500);\r\n} else if (xgbe_use_mode(pdata, XGBE_MODE_KX_1000)) {\r\nxgbe_set_mode(pdata, XGBE_MODE_KX_1000);\r\n} else if (xgbe_use_mode(pdata, XGBE_MODE_SFI)) {\r\nxgbe_set_mode(pdata, XGBE_MODE_SFI);\r\n} else if (xgbe_use_mode(pdata, XGBE_MODE_X)) {\r\nxgbe_set_mode(pdata, XGBE_MODE_X);\r\n} else if (xgbe_use_mode(pdata, XGBE_MODE_SGMII_1000)) {\r\nxgbe_set_mode(pdata, XGBE_MODE_SGMII_1000);\r\n} else if (xgbe_use_mode(pdata, XGBE_MODE_SGMII_100)) {\r\nxgbe_set_mode(pdata, XGBE_MODE_SGMII_100);\r\n} else {\r\nenable_irq(pdata->an_irq);\r\nreturn -EINVAL;\r\n}\r\nxgbe_an_disable_all(pdata);\r\nxgbe_an_clear_interrupts_all(pdata);\r\npdata->an_result = XGBE_AN_READY;\r\npdata->an_state = XGBE_AN_READY;\r\npdata->kr_state = XGBE_RX_BPA;\r\npdata->kx_state = XGBE_RX_BPA;\r\nenable_irq(pdata->an_irq);\r\nxgbe_an_init(pdata);\r\nxgbe_an_restart(pdata);\r\nreturn 0;\r\n}\r\nstatic int xgbe_phy_config_aneg(struct xgbe_prv_data *pdata)\r\n{\r\nint ret;\r\nmutex_lock(&pdata->an_mutex);\r\nret = __xgbe_phy_config_aneg(pdata);\r\nif (ret)\r\nset_bit(XGBE_LINK_ERR, &pdata->dev_state);\r\nelse\r\nclear_bit(XGBE_LINK_ERR, &pdata->dev_state);\r\nmutex_unlock(&pdata->an_mutex);\r\nreturn ret;\r\n}\r\nstatic bool xgbe_phy_aneg_done(struct xgbe_prv_data *pdata)\r\n{\r\nreturn (pdata->an_result == XGBE_AN_COMPLETE);\r\n}\r\nstatic void xgbe_check_link_timeout(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned long link_timeout;\r\nlink_timeout = pdata->link_check + (XGBE_LINK_TIMEOUT * HZ);\r\nif (time_after(jiffies, link_timeout)) {\r\nnetif_dbg(pdata, link, pdata->netdev, "AN link timeout\n");\r\nxgbe_phy_config_aneg(pdata);\r\n}\r\n}\r\nstatic enum xgbe_mode xgbe_phy_status_aneg(struct xgbe_prv_data *pdata)\r\n{\r\nreturn pdata->phy_if.phy_impl.an_outcome(pdata);\r\n}\r\nstatic void xgbe_phy_status_result(struct xgbe_prv_data *pdata)\r\n{\r\nenum xgbe_mode mode;\r\npdata->phy.lp_advertising = 0;\r\nif ((pdata->phy.autoneg != AUTONEG_ENABLE) || pdata->parallel_detect)\r\nmode = xgbe_cur_mode(pdata);\r\nelse\r\nmode = xgbe_phy_status_aneg(pdata);\r\nswitch (mode) {\r\ncase XGBE_MODE_SGMII_100:\r\npdata->phy.speed = SPEED_100;\r\nbreak;\r\ncase XGBE_MODE_X:\r\ncase XGBE_MODE_KX_1000:\r\ncase XGBE_MODE_SGMII_1000:\r\npdata->phy.speed = SPEED_1000;\r\nbreak;\r\ncase XGBE_MODE_KX_2500:\r\npdata->phy.speed = SPEED_2500;\r\nbreak;\r\ncase XGBE_MODE_KR:\r\ncase XGBE_MODE_SFI:\r\npdata->phy.speed = SPEED_10000;\r\nbreak;\r\ncase XGBE_MODE_UNKNOWN:\r\ndefault:\r\npdata->phy.speed = SPEED_UNKNOWN;\r\n}\r\npdata->phy.duplex = DUPLEX_FULL;\r\nxgbe_set_mode(pdata, mode);\r\n}\r\nstatic void xgbe_phy_status(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int link_aneg;\r\nint an_restart;\r\nif (test_bit(XGBE_LINK_ERR, &pdata->dev_state)) {\r\nnetif_carrier_off(pdata->netdev);\r\npdata->phy.link = 0;\r\ngoto adjust_link;\r\n}\r\nlink_aneg = (pdata->phy.autoneg == AUTONEG_ENABLE);\r\npdata->phy.link = pdata->phy_if.phy_impl.link_status(pdata,\r\n&an_restart);\r\nif (an_restart) {\r\nxgbe_phy_config_aneg(pdata);\r\nreturn;\r\n}\r\nif (pdata->phy.link) {\r\nif (link_aneg && !xgbe_phy_aneg_done(pdata)) {\r\nxgbe_check_link_timeout(pdata);\r\nreturn;\r\n}\r\nxgbe_phy_status_result(pdata);\r\nif (test_bit(XGBE_LINK_INIT, &pdata->dev_state))\r\nclear_bit(XGBE_LINK_INIT, &pdata->dev_state);\r\nnetif_carrier_on(pdata->netdev);\r\n} else {\r\nif (test_bit(XGBE_LINK_INIT, &pdata->dev_state)) {\r\nxgbe_check_link_timeout(pdata);\r\nif (link_aneg)\r\nreturn;\r\n}\r\nxgbe_phy_status_result(pdata);\r\nnetif_carrier_off(pdata->netdev);\r\n}\r\nadjust_link:\r\nxgbe_phy_adjust_link(pdata);\r\n}\r\nstatic void xgbe_phy_stop(struct xgbe_prv_data *pdata)\r\n{\r\nnetif_dbg(pdata, link, pdata->netdev, "stopping PHY\n");\r\nif (!pdata->phy_started)\r\nreturn;\r\npdata->phy_started = 0;\r\nxgbe_an_disable_all(pdata);\r\nif (pdata->dev_irq != pdata->an_irq)\r\ndevm_free_irq(pdata->dev, pdata->an_irq, pdata);\r\npdata->phy_if.phy_impl.stop(pdata);\r\npdata->phy.link = 0;\r\nnetif_carrier_off(pdata->netdev);\r\nxgbe_phy_adjust_link(pdata);\r\n}\r\nstatic int xgbe_phy_start(struct xgbe_prv_data *pdata)\r\n{\r\nstruct net_device *netdev = pdata->netdev;\r\nint ret;\r\nnetif_dbg(pdata, link, pdata->netdev, "starting PHY\n");\r\nret = pdata->phy_if.phy_impl.start(pdata);\r\nif (ret)\r\nreturn ret;\r\nif (pdata->dev_irq != pdata->an_irq) {\r\nret = devm_request_irq(pdata->dev, pdata->an_irq,\r\nxgbe_an_isr, 0, pdata->an_name,\r\npdata);\r\nif (ret) {\r\nnetdev_err(netdev, "phy irq request failed\n");\r\ngoto err_stop;\r\n}\r\n}\r\nif (xgbe_use_mode(pdata, XGBE_MODE_KR)) {\r\nxgbe_kr_mode(pdata);\r\n} else if (xgbe_use_mode(pdata, XGBE_MODE_KX_2500)) {\r\nxgbe_kx_2500_mode(pdata);\r\n} else if (xgbe_use_mode(pdata, XGBE_MODE_KX_1000)) {\r\nxgbe_kx_1000_mode(pdata);\r\n} else if (xgbe_use_mode(pdata, XGBE_MODE_SFI)) {\r\nxgbe_sfi_mode(pdata);\r\n} else if (xgbe_use_mode(pdata, XGBE_MODE_X)) {\r\nxgbe_x_mode(pdata);\r\n} else if (xgbe_use_mode(pdata, XGBE_MODE_SGMII_1000)) {\r\nxgbe_sgmii_1000_mode(pdata);\r\n} else if (xgbe_use_mode(pdata, XGBE_MODE_SGMII_100)) {\r\nxgbe_sgmii_100_mode(pdata);\r\n} else {\r\nret = -EINVAL;\r\ngoto err_irq;\r\n}\r\npdata->phy_started = 1;\r\nxgbe_an_init(pdata);\r\nxgbe_an_enable_interrupts(pdata);\r\nreturn xgbe_phy_config_aneg(pdata);\r\nerr_irq:\r\nif (pdata->dev_irq != pdata->an_irq)\r\ndevm_free_irq(pdata->dev, pdata->an_irq, pdata);\r\nerr_stop:\r\npdata->phy_if.phy_impl.stop(pdata);\r\nreturn ret;\r\n}\r\nstatic int xgbe_phy_reset(struct xgbe_prv_data *pdata)\r\n{\r\nint ret;\r\nret = pdata->phy_if.phy_impl.reset(pdata);\r\nif (ret)\r\nreturn ret;\r\nxgbe_an_disable_all(pdata);\r\nxgbe_an_clear_interrupts_all(pdata);\r\nreturn 0;\r\n}\r\nstatic void xgbe_dump_phy_registers(struct xgbe_prv_data *pdata)\r\n{\r\nstruct device *dev = pdata->dev;\r\ndev_dbg(dev, "\n************* PHY Reg dump **********************\n");\r\ndev_dbg(dev, "PCS Control Reg (%#06x) = %#06x\n", MDIO_CTRL1,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_CTRL1));\r\ndev_dbg(dev, "PCS Status Reg (%#06x) = %#06x\n", MDIO_STAT1,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_STAT1));\r\ndev_dbg(dev, "Phy Id (PHYS ID 1 %#06x)= %#06x\n", MDIO_DEVID1,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_DEVID1));\r\ndev_dbg(dev, "Phy Id (PHYS ID 2 %#06x)= %#06x\n", MDIO_DEVID2,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_DEVID2));\r\ndev_dbg(dev, "Devices in Package (%#06x)= %#06x\n", MDIO_DEVS1,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_DEVS1));\r\ndev_dbg(dev, "Devices in Package (%#06x)= %#06x\n", MDIO_DEVS2,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_DEVS2));\r\ndev_dbg(dev, "Auto-Neg Control Reg (%#06x) = %#06x\n", MDIO_CTRL1,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_CTRL1));\r\ndev_dbg(dev, "Auto-Neg Status Reg (%#06x) = %#06x\n", MDIO_STAT1,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_STAT1));\r\ndev_dbg(dev, "Auto-Neg Ad Reg 1 (%#06x) = %#06x\n",\r\nMDIO_AN_ADVERTISE,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE));\r\ndev_dbg(dev, "Auto-Neg Ad Reg 2 (%#06x) = %#06x\n",\r\nMDIO_AN_ADVERTISE + 1,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 1));\r\ndev_dbg(dev, "Auto-Neg Ad Reg 3 (%#06x) = %#06x\n",\r\nMDIO_AN_ADVERTISE + 2,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 2));\r\ndev_dbg(dev, "Auto-Neg Completion Reg (%#06x) = %#06x\n",\r\nMDIO_AN_COMP_STAT,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_COMP_STAT));\r\ndev_dbg(dev, "\n*************************************************\n");\r\n}\r\nstatic int xgbe_phy_best_advertised_speed(struct xgbe_prv_data *pdata)\r\n{\r\nif (pdata->phy.advertising & ADVERTISED_10000baseKR_Full)\r\nreturn SPEED_10000;\r\nelse if (pdata->phy.advertising & ADVERTISED_10000baseT_Full)\r\nreturn SPEED_10000;\r\nelse if (pdata->phy.advertising & ADVERTISED_2500baseX_Full)\r\nreturn SPEED_2500;\r\nelse if (pdata->phy.advertising & ADVERTISED_1000baseKX_Full)\r\nreturn SPEED_1000;\r\nelse if (pdata->phy.advertising & ADVERTISED_1000baseT_Full)\r\nreturn SPEED_1000;\r\nelse if (pdata->phy.advertising & ADVERTISED_100baseT_Full)\r\nreturn SPEED_100;\r\nreturn SPEED_UNKNOWN;\r\n}\r\nstatic void xgbe_phy_exit(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_phy_stop(pdata);\r\npdata->phy_if.phy_impl.exit(pdata);\r\n}\r\nstatic int xgbe_phy_init(struct xgbe_prv_data *pdata)\r\n{\r\nint ret;\r\nmutex_init(&pdata->an_mutex);\r\nINIT_WORK(&pdata->an_irq_work, xgbe_an_irq_work);\r\nINIT_WORK(&pdata->an_work, xgbe_an_state_machine);\r\npdata->mdio_mmd = MDIO_MMD_PCS;\r\npdata->fec_ability = XMDIO_READ(pdata, MDIO_MMD_PMAPMD,\r\nMDIO_PMA_10GBR_FECABLE);\r\npdata->fec_ability &= (MDIO_PMA_10GBR_FECABLE_ABLE |\r\nMDIO_PMA_10GBR_FECABLE_ERRABLE);\r\nret = pdata->phy_if.phy_impl.init(pdata);\r\nif (ret)\r\nreturn ret;\r\npdata->phy.advertising = pdata->phy.supported;\r\npdata->phy.address = 0;\r\nif (pdata->phy.advertising & ADVERTISED_Autoneg) {\r\npdata->phy.autoneg = AUTONEG_ENABLE;\r\npdata->phy.speed = SPEED_UNKNOWN;\r\npdata->phy.duplex = DUPLEX_UNKNOWN;\r\n} else {\r\npdata->phy.autoneg = AUTONEG_DISABLE;\r\npdata->phy.speed = xgbe_phy_best_advertised_speed(pdata);\r\npdata->phy.duplex = DUPLEX_FULL;\r\n}\r\npdata->phy.link = 0;\r\npdata->phy.pause_autoneg = pdata->pause_autoneg;\r\npdata->phy.tx_pause = pdata->tx_pause;\r\npdata->phy.rx_pause = pdata->rx_pause;\r\npdata->phy.advertising &= ~ADVERTISED_Pause;\r\npdata->phy.advertising &= ~ADVERTISED_Asym_Pause;\r\nif (pdata->rx_pause) {\r\npdata->phy.advertising |= ADVERTISED_Pause;\r\npdata->phy.advertising |= ADVERTISED_Asym_Pause;\r\n}\r\nif (pdata->tx_pause)\r\npdata->phy.advertising ^= ADVERTISED_Asym_Pause;\r\nif (netif_msg_drv(pdata))\r\nxgbe_dump_phy_registers(pdata);\r\nreturn 0;\r\n}\r\nvoid xgbe_init_function_ptrs_phy(struct xgbe_phy_if *phy_if)\r\n{\r\nphy_if->phy_init = xgbe_phy_init;\r\nphy_if->phy_exit = xgbe_phy_exit;\r\nphy_if->phy_reset = xgbe_phy_reset;\r\nphy_if->phy_start = xgbe_phy_start;\r\nphy_if->phy_stop = xgbe_phy_stop;\r\nphy_if->phy_status = xgbe_phy_status;\r\nphy_if->phy_config_aneg = xgbe_phy_config_aneg;\r\nphy_if->phy_valid_speed = xgbe_phy_valid_speed;\r\nphy_if->an_isr = xgbe_an_combined_isr;\r\n}

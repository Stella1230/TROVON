static inline void vsp1_lif_write(struct vsp1_lif *lif, struct vsp1_dl_list *dl,\r\nu32 reg, u32 data)\r\n{\r\nvsp1_dl_list_write(dl, reg, data);\r\n}\r\nstatic int lif_enum_mbus_code(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_mbus_code_enum *code)\r\n{\r\nstatic const unsigned int codes[] = {\r\nMEDIA_BUS_FMT_ARGB8888_1X32,\r\nMEDIA_BUS_FMT_AYUV8_1X32,\r\n};\r\nreturn vsp1_subdev_enum_mbus_code(subdev, cfg, code, codes,\r\nARRAY_SIZE(codes));\r\n}\r\nstatic int lif_enum_frame_size(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_frame_size_enum *fse)\r\n{\r\nreturn vsp1_subdev_enum_frame_size(subdev, cfg, fse, LIF_MIN_SIZE,\r\nLIF_MIN_SIZE, LIF_MAX_SIZE,\r\nLIF_MAX_SIZE);\r\n}\r\nstatic int lif_set_format(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct vsp1_lif *lif = to_lif(subdev);\r\nstruct v4l2_subdev_pad_config *config;\r\nstruct v4l2_mbus_framefmt *format;\r\nint ret = 0;\r\nmutex_lock(&lif->entity.lock);\r\nconfig = vsp1_entity_get_pad_config(&lif->entity, cfg, fmt->which);\r\nif (!config) {\r\nret = -EINVAL;\r\ngoto done;\r\n}\r\nif (fmt->format.code != MEDIA_BUS_FMT_ARGB8888_1X32 &&\r\nfmt->format.code != MEDIA_BUS_FMT_AYUV8_1X32)\r\nfmt->format.code = MEDIA_BUS_FMT_AYUV8_1X32;\r\nformat = vsp1_entity_get_pad_format(&lif->entity, config, fmt->pad);\r\nif (fmt->pad == LIF_PAD_SOURCE) {\r\nfmt->format = *format;\r\ngoto done;\r\n}\r\nformat->code = fmt->format.code;\r\nformat->width = clamp_t(unsigned int, fmt->format.width,\r\nLIF_MIN_SIZE, LIF_MAX_SIZE);\r\nformat->height = clamp_t(unsigned int, fmt->format.height,\r\nLIF_MIN_SIZE, LIF_MAX_SIZE);\r\nformat->field = V4L2_FIELD_NONE;\r\nformat->colorspace = V4L2_COLORSPACE_SRGB;\r\nfmt->format = *format;\r\nformat = vsp1_entity_get_pad_format(&lif->entity, config,\r\nLIF_PAD_SOURCE);\r\n*format = fmt->format;\r\ndone:\r\nmutex_unlock(&lif->entity.lock);\r\nreturn ret;\r\n}\r\nstatic void lif_configure(struct vsp1_entity *entity,\r\nstruct vsp1_pipeline *pipe,\r\nstruct vsp1_dl_list *dl,\r\nenum vsp1_entity_params params)\r\n{\r\nconst struct v4l2_mbus_framefmt *format;\r\nstruct vsp1_lif *lif = to_lif(&entity->subdev);\r\nunsigned int hbth = 1300;\r\nunsigned int obth = 400;\r\nunsigned int lbth = 200;\r\nif (params != VSP1_ENTITY_PARAMS_INIT)\r\nreturn;\r\nformat = vsp1_entity_get_pad_format(&lif->entity, lif->entity.config,\r\nLIF_PAD_SOURCE);\r\nobth = min(obth, (format->width + 1) / 2 * format->height - 4);\r\nvsp1_lif_write(lif, dl, VI6_LIF_CSBTH,\r\n(hbth << VI6_LIF_CSBTH_HBTH_SHIFT) |\r\n(lbth << VI6_LIF_CSBTH_LBTH_SHIFT));\r\nvsp1_lif_write(lif, dl, VI6_LIF_CTRL,\r\n(obth << VI6_LIF_CTRL_OBTH_SHIFT) |\r\n(format->code == 0 ? VI6_LIF_CTRL_CFMT : 0) |\r\nVI6_LIF_CTRL_REQSEL | VI6_LIF_CTRL_LIF_EN);\r\n}\r\nstruct vsp1_lif *vsp1_lif_create(struct vsp1_device *vsp1)\r\n{\r\nstruct vsp1_lif *lif;\r\nint ret;\r\nlif = devm_kzalloc(vsp1->dev, sizeof(*lif), GFP_KERNEL);\r\nif (lif == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nlif->entity.ops = &lif_entity_ops;\r\nlif->entity.type = VSP1_ENTITY_LIF;\r\nret = vsp1_entity_init(vsp1, &lif->entity, "lif", 2, &lif_ops,\r\nMEDIA_ENT_F_PROC_VIDEO_PIXEL_FORMATTER);\r\nif (ret < 0)\r\nreturn ERR_PTR(ret);\r\nreturn lif;\r\n}

u8\r\nnvkm_rdport(struct nvkm_device *device, int head, u16 port)\r\n{\r\nif (device->card_type >= NV_50)\r\nreturn nvkm_rd08(device, 0x601000 + port);\r\nif (port == 0x03c0 || port == 0x03c1 ||\r\nport == 0x03c2 || port == 0x03da ||\r\nport == 0x03d4 || port == 0x03d5)\r\nreturn nvkm_rd08(device, 0x601000 + (head * 0x2000) + port);\r\nif (port == 0x03c2 || port == 0x03cc ||\r\nport == 0x03c4 || port == 0x03c5 ||\r\nport == 0x03ce || port == 0x03cf) {\r\nif (device->card_type < NV_40)\r\nhead = 0;\r\nreturn nvkm_rd08(device, 0x0c0000 + (head * 0x2000) + port);\r\n}\r\nreturn 0x00;\r\n}\r\nvoid\r\nnvkm_wrport(struct nvkm_device *device, int head, u16 port, u8 data)\r\n{\r\nif (device->card_type >= NV_50)\r\nnvkm_wr08(device, 0x601000 + port, data);\r\nelse\r\nif (port == 0x03c0 || port == 0x03c1 ||\r\nport == 0x03c2 || port == 0x03da ||\r\nport == 0x03d4 || port == 0x03d5)\r\nnvkm_wr08(device, 0x601000 + (head * 0x2000) + port, data);\r\nelse\r\nif (port == 0x03c2 || port == 0x03cc ||\r\nport == 0x03c4 || port == 0x03c5 ||\r\nport == 0x03ce || port == 0x03cf) {\r\nif (device->card_type < NV_40)\r\nhead = 0;\r\nnvkm_wr08(device, 0x0c0000 + (head * 0x2000) + port, data);\r\n}\r\n}\r\nu8\r\nnvkm_rdvgas(struct nvkm_device *device, int head, u8 index)\r\n{\r\nnvkm_wrport(device, head, 0x03c4, index);\r\nreturn nvkm_rdport(device, head, 0x03c5);\r\n}\r\nvoid\r\nnvkm_wrvgas(struct nvkm_device *device, int head, u8 index, u8 value)\r\n{\r\nnvkm_wrport(device, head, 0x03c4, index);\r\nnvkm_wrport(device, head, 0x03c5, value);\r\n}\r\nu8\r\nnvkm_rdvgag(struct nvkm_device *device, int head, u8 index)\r\n{\r\nnvkm_wrport(device, head, 0x03ce, index);\r\nreturn nvkm_rdport(device, head, 0x03cf);\r\n}\r\nvoid\r\nnvkm_wrvgag(struct nvkm_device *device, int head, u8 index, u8 value)\r\n{\r\nnvkm_wrport(device, head, 0x03ce, index);\r\nnvkm_wrport(device, head, 0x03cf, value);\r\n}\r\nu8\r\nnvkm_rdvgac(struct nvkm_device *device, int head, u8 index)\r\n{\r\nnvkm_wrport(device, head, 0x03d4, index);\r\nreturn nvkm_rdport(device, head, 0x03d5);\r\n}\r\nvoid\r\nnvkm_wrvgac(struct nvkm_device *device, int head, u8 index, u8 value)\r\n{\r\nnvkm_wrport(device, head, 0x03d4, index);\r\nnvkm_wrport(device, head, 0x03d5, value);\r\n}\r\nu8\r\nnvkm_rdvgai(struct nvkm_device *device, int head, u16 port, u8 index)\r\n{\r\nif (port == 0x03c4) return nvkm_rdvgas(device, head, index);\r\nif (port == 0x03ce) return nvkm_rdvgag(device, head, index);\r\nif (port == 0x03d4) return nvkm_rdvgac(device, head, index);\r\nreturn 0x00;\r\n}\r\nvoid\r\nnvkm_wrvgai(struct nvkm_device *device, int head, u16 port, u8 index, u8 value)\r\n{\r\nif (port == 0x03c4) nvkm_wrvgas(device, head, index, value);\r\nelse if (port == 0x03ce) nvkm_wrvgag(device, head, index, value);\r\nelse if (port == 0x03d4) nvkm_wrvgac(device, head, index, value);\r\n}\r\nbool\r\nnvkm_lockvgac(struct nvkm_device *device, bool lock)\r\n{\r\nbool locked = !nvkm_rdvgac(device, 0, 0x1f);\r\nu8 data = lock ? 0x99 : 0x57;\r\nif (device->card_type < NV_50)\r\nnvkm_wrvgac(device, 0, 0x1f, data);\r\nelse\r\nnvkm_wrvgac(device, 0, 0x3f, data);\r\nif (device->chipset == 0x11) {\r\nif (!(nvkm_rd32(device, 0x001084) & 0x10000000))\r\nnvkm_wrvgac(device, 1, 0x1f, data);\r\n}\r\nreturn locked;\r\n}\r\nu8\r\nnvkm_rdvgaowner(struct nvkm_device *device)\r\n{\r\nif (device->card_type < NV_50) {\r\nif (device->chipset == 0x11) {\r\nu32 tied = nvkm_rd32(device, 0x001084) & 0x10000000;\r\nif (tied == 0) {\r\nu8 slA = nvkm_rdvgac(device, 0, 0x28) & 0x80;\r\nu8 tvA = nvkm_rdvgac(device, 0, 0x33) & 0x01;\r\nu8 slB = nvkm_rdvgac(device, 1, 0x28) & 0x80;\r\nu8 tvB = nvkm_rdvgac(device, 1, 0x33) & 0x01;\r\nif (slA && !tvA) return 0x00;\r\nif (slB && !tvB) return 0x03;\r\nif (slA) return 0x00;\r\nif (slB) return 0x03;\r\nreturn 0x00;\r\n}\r\nreturn 0x04;\r\n}\r\nreturn nvkm_rdvgac(device, 0, 0x44);\r\n}\r\nreturn 0x00;\r\n}\r\nvoid\r\nnvkm_wrvgaowner(struct nvkm_device *device, u8 select)\r\n{\r\nif (device->card_type < NV_50) {\r\nu8 owner = (select == 1) ? 3 : select;\r\nif (device->chipset == 0x11) {\r\nnvkm_rdvgac(device, 0, 0x1f);\r\nnvkm_rdvgac(device, 1, 0x1f);\r\n}\r\nnvkm_wrvgac(device, 0, 0x44, owner);\r\nif (device->chipset == 0x11) {\r\nnvkm_wrvgac(device, 0, 0x2e, owner);\r\nnvkm_wrvgac(device, 0, 0x2e, owner);\r\n}\r\n}\r\n}

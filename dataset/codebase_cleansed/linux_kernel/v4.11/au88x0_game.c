static unsigned char vortex_game_read(struct gameport *gameport)\r\n{\r\nvortex_t *vortex = gameport_get_port_data(gameport);\r\nreturn hwread(vortex->mmio, VORTEX_GAME_LEGACY);\r\n}\r\nstatic void vortex_game_trigger(struct gameport *gameport)\r\n{\r\nvortex_t *vortex = gameport_get_port_data(gameport);\r\nhwwrite(vortex->mmio, VORTEX_GAME_LEGACY, 0xff);\r\n}\r\nstatic int\r\nvortex_game_cooked_read(struct gameport *gameport, int *axes, int *buttons)\r\n{\r\nvortex_t *vortex = gameport_get_port_data(gameport);\r\nint i;\r\n*buttons = (~hwread(vortex->mmio, VORTEX_GAME_LEGACY) >> 4) & 0xf;\r\nfor (i = 0; i < 4; i++) {\r\naxes[i] =\r\nhwread(vortex->mmio, VORTEX_GAME_AXIS + (i * AXIS_SIZE));\r\nif (axes[i] == AXIS_RANGE)\r\naxes[i] = -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int vortex_game_open(struct gameport *gameport, int mode)\r\n{\r\nvortex_t *vortex = gameport_get_port_data(gameport);\r\nswitch (mode) {\r\ncase GAMEPORT_MODE_COOKED:\r\nhwwrite(vortex->mmio, VORTEX_CTRL2,\r\nhwread(vortex->mmio,\r\nVORTEX_CTRL2) | CTRL2_GAME_ADCMODE);\r\nmsleep(VORTEX_GAME_DWAIT);\r\nreturn 0;\r\ncase GAMEPORT_MODE_RAW:\r\nhwwrite(vortex->mmio, VORTEX_CTRL2,\r\nhwread(vortex->mmio,\r\nVORTEX_CTRL2) & ~CTRL2_GAME_ADCMODE);\r\nreturn 0;\r\ndefault:\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int vortex_gameport_register(vortex_t *vortex)\r\n{\r\nstruct gameport *gp;\r\nvortex->gameport = gp = gameport_allocate_port();\r\nif (!gp) {\r\ndev_err(vortex->card->dev,\r\n"cannot allocate memory for gameport\n");\r\nreturn -ENOMEM;\r\n}\r\ngameport_set_name(gp, "AU88x0 Gameport");\r\ngameport_set_phys(gp, "pci%s/gameport0", pci_name(vortex->pci_dev));\r\ngameport_set_dev_parent(gp, &vortex->pci_dev->dev);\r\ngp->read = vortex_game_read;\r\ngp->trigger = vortex_game_trigger;\r\ngp->cooked_read = vortex_game_cooked_read;\r\ngp->open = vortex_game_open;\r\ngameport_set_port_data(gp, vortex);\r\ngp->fuzz = 64;\r\ngameport_register_port(gp);\r\nreturn 0;\r\n}\r\nstatic void vortex_gameport_unregister(vortex_t * vortex)\r\n{\r\nif (vortex->gameport) {\r\ngameport_unregister_port(vortex->gameport);\r\nvortex->gameport = NULL;\r\n}\r\n}\r\nstatic inline int vortex_gameport_register(vortex_t * vortex) { return -ENOSYS; }\r\nstatic inline void vortex_gameport_unregister(vortex_t * vortex) { }

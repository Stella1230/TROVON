static int cyberjack_attach(struct usb_serial *serial)\r\n{\r\nif (serial->num_bulk_out < serial->num_ports)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int cyberjack_port_probe(struct usb_serial_port *port)\r\n{\r\nstruct cyberjack_private *priv;\r\nint result;\r\npriv = kmalloc(sizeof(struct cyberjack_private), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nspin_lock_init(&priv->lock);\r\npriv->rdtodo = 0;\r\npriv->wrfilled = 0;\r\npriv->wrsent = 0;\r\nusb_set_serial_port_data(port, priv);\r\nresult = usb_submit_urb(port->interrupt_in_urb, GFP_KERNEL);\r\nif (result)\r\ndev_err(&port->dev, "usb_submit_urb(read int) failed\n");\r\nreturn 0;\r\n}\r\nstatic int cyberjack_port_remove(struct usb_serial_port *port)\r\n{\r\nstruct cyberjack_private *priv;\r\nusb_kill_urb(port->interrupt_in_urb);\r\npriv = usb_get_serial_port_data(port);\r\nkfree(priv);\r\nreturn 0;\r\n}\r\nstatic int cyberjack_open(struct tty_struct *tty,\r\nstruct usb_serial_port *port)\r\n{\r\nstruct cyberjack_private *priv;\r\nunsigned long flags;\r\ndev_dbg(&port->dev, "%s - usb_clear_halt\n", __func__);\r\nusb_clear_halt(port->serial->dev, port->write_urb->pipe);\r\npriv = usb_get_serial_port_data(port);\r\nspin_lock_irqsave(&priv->lock, flags);\r\npriv->rdtodo = 0;\r\npriv->wrfilled = 0;\r\npriv->wrsent = 0;\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void cyberjack_close(struct usb_serial_port *port)\r\n{\r\nusb_kill_urb(port->write_urb);\r\nusb_kill_urb(port->read_urb);\r\n}\r\nstatic int cyberjack_write(struct tty_struct *tty,\r\nstruct usb_serial_port *port, const unsigned char *buf, int count)\r\n{\r\nstruct device *dev = &port->dev;\r\nstruct cyberjack_private *priv = usb_get_serial_port_data(port);\r\nunsigned long flags;\r\nint result;\r\nint wrexpected;\r\nif (count == 0) {\r\ndev_dbg(dev, "%s - write request of 0 bytes\n", __func__);\r\nreturn 0;\r\n}\r\nif (!test_and_clear_bit(0, &port->write_urbs_free)) {\r\ndev_dbg(dev, "%s - already writing\n", __func__);\r\nreturn 0;\r\n}\r\nspin_lock_irqsave(&priv->lock, flags);\r\nif (count+priv->wrfilled > sizeof(priv->wrbuf)) {\r\npriv->wrfilled = 0;\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nset_bit(0, &port->write_urbs_free);\r\nreturn 0;\r\n}\r\nmemcpy(priv->wrbuf + priv->wrfilled, buf, count);\r\nusb_serial_debug_data(dev, __func__, count, priv->wrbuf + priv->wrfilled);\r\npriv->wrfilled += count;\r\nif (priv->wrfilled >= 3) {\r\nwrexpected = ((int)priv->wrbuf[2]<<8)+priv->wrbuf[1]+3;\r\ndev_dbg(dev, "%s - expected data: %d\n", __func__, wrexpected);\r\n} else\r\nwrexpected = sizeof(priv->wrbuf);\r\nif (priv->wrfilled >= wrexpected) {\r\nint length;\r\ndev_dbg(dev, "%s - transmitting data (frame 1)\n", __func__);\r\nlength = (wrexpected > port->bulk_out_size) ?\r\nport->bulk_out_size : wrexpected;\r\nmemcpy(port->write_urb->transfer_buffer, priv->wrbuf, length);\r\npriv->wrsent = length;\r\nport->write_urb->transfer_buffer_length = length;\r\nresult = usb_submit_urb(port->write_urb, GFP_ATOMIC);\r\nif (result) {\r\ndev_err(&port->dev,\r\n"%s - failed submitting write urb, error %d\n",\r\n__func__, result);\r\npriv->wrfilled = 0;\r\npriv->wrsent = 0;\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nset_bit(0, &port->write_urbs_free);\r\nreturn 0;\r\n}\r\ndev_dbg(dev, "%s - priv->wrsent=%d\n", __func__, priv->wrsent);\r\ndev_dbg(dev, "%s - priv->wrfilled=%d\n", __func__, priv->wrfilled);\r\nif (priv->wrsent >= priv->wrfilled) {\r\ndev_dbg(dev, "%s - buffer cleaned\n", __func__);\r\nmemset(priv->wrbuf, 0, sizeof(priv->wrbuf));\r\npriv->wrfilled = 0;\r\npriv->wrsent = 0;\r\n}\r\n}\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nreturn count;\r\n}\r\nstatic int cyberjack_write_room(struct tty_struct *tty)\r\n{\r\nreturn CYBERJACK_LOCAL_BUF_SIZE;\r\n}\r\nstatic void cyberjack_read_int_callback(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nstruct cyberjack_private *priv = usb_get_serial_port_data(port);\r\nstruct device *dev = &port->dev;\r\nunsigned char *data = urb->transfer_buffer;\r\nint status = urb->status;\r\nint result;\r\nif (status)\r\nreturn;\r\nusb_serial_debug_data(dev, __func__, urb->actual_length, data);\r\nif (urb->actual_length == 4 && data[0] == 0x01) {\r\nshort old_rdtodo;\r\nunsigned short size = ((unsigned short)data[3]<<8)+data[2]+3;\r\nspin_lock(&priv->lock);\r\nold_rdtodo = priv->rdtodo;\r\nif (old_rdtodo > SHRT_MAX - size) {\r\ndev_dbg(dev, "To many bulk_in urbs to do.\n");\r\nspin_unlock(&priv->lock);\r\ngoto resubmit;\r\n}\r\npriv->rdtodo += size;\r\ndev_dbg(dev, "%s - rdtodo: %d\n", __func__, priv->rdtodo);\r\nspin_unlock(&priv->lock);\r\nif (!old_rdtodo) {\r\nresult = usb_submit_urb(port->read_urb, GFP_ATOMIC);\r\nif (result)\r\ndev_err(dev, "%s - failed resubmitting read urb, error %d\n",\r\n__func__, result);\r\ndev_dbg(dev, "%s - usb_submit_urb(read urb)\n", __func__);\r\n}\r\n}\r\nresubmit:\r\nresult = usb_submit_urb(port->interrupt_in_urb, GFP_ATOMIC);\r\nif (result)\r\ndev_err(&port->dev, "usb_submit_urb(read int) failed\n");\r\ndev_dbg(dev, "%s - usb_submit_urb(int urb)\n", __func__);\r\n}\r\nstatic void cyberjack_read_bulk_callback(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nstruct cyberjack_private *priv = usb_get_serial_port_data(port);\r\nstruct device *dev = &port->dev;\r\nunsigned char *data = urb->transfer_buffer;\r\nshort todo;\r\nint result;\r\nint status = urb->status;\r\nusb_serial_debug_data(dev, __func__, urb->actual_length, data);\r\nif (status) {\r\ndev_dbg(dev, "%s - nonzero read bulk status received: %d\n",\r\n__func__, status);\r\nreturn;\r\n}\r\nif (urb->actual_length) {\r\ntty_insert_flip_string(&port->port, data, urb->actual_length);\r\ntty_flip_buffer_push(&port->port);\r\n}\r\nspin_lock(&priv->lock);\r\npriv->rdtodo -= urb->actual_length;\r\nif (priv->rdtodo < 0)\r\npriv->rdtodo = 0;\r\ntodo = priv->rdtodo;\r\nspin_unlock(&priv->lock);\r\ndev_dbg(dev, "%s - rdtodo: %d\n", __func__, todo);\r\nif (todo ) {\r\nresult = usb_submit_urb(port->read_urb, GFP_ATOMIC);\r\nif (result)\r\ndev_err(dev, "%s - failed resubmitting read urb, error %d\n",\r\n__func__, result);\r\ndev_dbg(dev, "%s - usb_submit_urb(read urb)\n", __func__);\r\n}\r\n}\r\nstatic void cyberjack_write_bulk_callback(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nstruct cyberjack_private *priv = usb_get_serial_port_data(port);\r\nstruct device *dev = &port->dev;\r\nint status = urb->status;\r\nset_bit(0, &port->write_urbs_free);\r\nif (status) {\r\ndev_dbg(dev, "%s - nonzero write bulk status received: %d\n",\r\n__func__, status);\r\nreturn;\r\n}\r\nspin_lock(&priv->lock);\r\nif (priv->wrfilled) {\r\nint length, blksize, result;\r\ndev_dbg(dev, "%s - transmitting data (frame n)\n", __func__);\r\nlength = ((priv->wrfilled - priv->wrsent) > port->bulk_out_size) ?\r\nport->bulk_out_size : (priv->wrfilled - priv->wrsent);\r\nmemcpy(port->write_urb->transfer_buffer,\r\npriv->wrbuf + priv->wrsent, length);\r\npriv->wrsent += length;\r\nport->write_urb->transfer_buffer_length = length;\r\nresult = usb_submit_urb(port->write_urb, GFP_ATOMIC);\r\nif (result) {\r\ndev_err(dev, "%s - failed submitting write urb, error %d\n",\r\n__func__, result);\r\npriv->wrfilled = 0;\r\npriv->wrsent = 0;\r\ngoto exit;\r\n}\r\ndev_dbg(dev, "%s - priv->wrsent=%d\n", __func__, priv->wrsent);\r\ndev_dbg(dev, "%s - priv->wrfilled=%d\n", __func__, priv->wrfilled);\r\nblksize = ((int)priv->wrbuf[2]<<8)+priv->wrbuf[1]+3;\r\nif (priv->wrsent >= priv->wrfilled ||\r\npriv->wrsent >= blksize) {\r\ndev_dbg(dev, "%s - buffer cleaned\n", __func__);\r\nmemset(priv->wrbuf, 0, sizeof(priv->wrbuf));\r\npriv->wrfilled = 0;\r\npriv->wrsent = 0;\r\n}\r\n}\r\nexit:\r\nspin_unlock(&priv->lock);\r\nusb_serial_port_softint(port);\r\n}

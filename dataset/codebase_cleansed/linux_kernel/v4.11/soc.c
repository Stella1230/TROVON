static int __init at91_get_cidr_exid_from_dbgu(u32 *cidr, u32 *exid)\r\n{\r\nstruct device_node *np;\r\nvoid __iomem *regs;\r\nnp = of_find_compatible_node(NULL, NULL, "atmel,at91rm9200-dbgu");\r\nif (!np)\r\nnp = of_find_compatible_node(NULL, NULL,\r\n"atmel,at91sam9260-dbgu");\r\nif (!np)\r\nreturn -ENODEV;\r\nregs = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!regs) {\r\npr_warn("Could not map DBGU iomem range");\r\nreturn -ENXIO;\r\n}\r\n*cidr = readl(regs + AT91_DBGU_CIDR);\r\n*exid = readl(regs + AT91_DBGU_EXID);\r\niounmap(regs);\r\nreturn 0;\r\n}\r\nstatic int __init at91_get_cidr_exid_from_chipid(u32 *cidr, u32 *exid)\r\n{\r\nstruct device_node *np;\r\nvoid __iomem *regs;\r\nnp = of_find_compatible_node(NULL, NULL, "atmel,sama5d2-chipid");\r\nif (!np)\r\nreturn -ENODEV;\r\nregs = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!regs) {\r\npr_warn("Could not map DBGU iomem range");\r\nreturn -ENXIO;\r\n}\r\n*cidr = readl(regs + AT91_CHIPID_CIDR);\r\n*exid = readl(regs + AT91_CHIPID_EXID);\r\niounmap(regs);\r\nreturn 0;\r\n}\r\nstruct soc_device * __init at91_soc_init(const struct at91_soc *socs)\r\n{\r\nstruct soc_device_attribute *soc_dev_attr;\r\nconst struct at91_soc *soc;\r\nstruct soc_device *soc_dev;\r\nu32 cidr, exid;\r\nint ret;\r\nret = at91_get_cidr_exid_from_dbgu(&cidr, &exid);\r\nif (ret)\r\nret = at91_get_cidr_exid_from_chipid(&cidr, &exid);\r\nif (ret) {\r\nif (ret == -ENODEV)\r\npr_warn("Could not find identification node");\r\nreturn NULL;\r\n}\r\nfor (soc = socs; soc->name; soc++) {\r\nif (soc->cidr_match != (cidr & AT91_CIDR_MATCH_MASK))\r\ncontinue;\r\nif (!(cidr & AT91_CIDR_EXT) || soc->exid_match == exid)\r\nbreak;\r\n}\r\nif (!soc->name) {\r\npr_warn("Could not find matching SoC description\n");\r\nreturn NULL;\r\n}\r\nsoc_dev_attr = kzalloc(sizeof(*soc_dev_attr), GFP_KERNEL);\r\nif (!soc_dev_attr)\r\nreturn NULL;\r\nsoc_dev_attr->family = soc->family;\r\nsoc_dev_attr->soc_id = soc->name;\r\nsoc_dev_attr->revision = kasprintf(GFP_KERNEL, "%X",\r\nAT91_CIDR_VERSION(cidr));\r\nsoc_dev = soc_device_register(soc_dev_attr);\r\nif (IS_ERR(soc_dev)) {\r\nkfree(soc_dev_attr->revision);\r\nkfree(soc_dev_attr);\r\npr_warn("Could not register SoC device\n");\r\nreturn NULL;\r\n}\r\nif (soc->family)\r\npr_info("Detected SoC family: %s\n", soc->family);\r\npr_info("Detected SoC: %s, revision %X\n", soc->name,\r\nAT91_CIDR_VERSION(cidr));\r\nreturn soc_dev;\r\n}

bool acpi_has_watchdog(void)\r\n{\r\nstruct acpi_table_header hdr;\r\nif (acpi_disabled)\r\nreturn false;\r\nreturn ACPI_SUCCESS(acpi_get_table_header(ACPI_SIG_WDAT, 0, &hdr));\r\n}\r\nvoid __init acpi_watchdog_init(void)\r\n{\r\nconst struct acpi_wdat_entry *entries;\r\nconst struct acpi_table_wdat *wdat;\r\nstruct list_head resource_list;\r\nstruct resource_entry *rentry;\r\nstruct platform_device *pdev;\r\nstruct resource *resources;\r\nsize_t nresources = 0;\r\nacpi_status status;\r\nint i;\r\nstatus = acpi_get_table(ACPI_SIG_WDAT, 0,\r\n(struct acpi_table_header **)&wdat);\r\nif (ACPI_FAILURE(status)) {\r\nreturn;\r\n}\r\nif (!(wdat->flags & ACPI_WDAT_ENABLED))\r\nreturn;\r\nif (wdat->pci_segment != 0xff || wdat->pci_bus != 0xff ||\r\nwdat->pci_device != 0xff || wdat->pci_function != 0xff)\r\nreturn;\r\nINIT_LIST_HEAD(&resource_list);\r\nentries = (struct acpi_wdat_entry *)(wdat + 1);\r\nfor (i = 0; i < wdat->entries; i++) {\r\nconst struct acpi_generic_address *gas;\r\nstruct resource_entry *rentry;\r\nstruct resource res;\r\nbool found;\r\ngas = &entries[i].register_region;\r\nres.start = gas->address;\r\nif (gas->space_id == ACPI_ADR_SPACE_SYSTEM_MEMORY) {\r\nres.flags = IORESOURCE_MEM;\r\nres.end = res.start + ALIGN(gas->access_width, 4);\r\n} else if (gas->space_id == ACPI_ADR_SPACE_SYSTEM_IO) {\r\nres.flags = IORESOURCE_IO;\r\nres.end = res.start + gas->access_width;\r\n} else {\r\npr_warn("Unsupported address space: %u\n",\r\ngas->space_id);\r\ngoto fail_free_resource_list;\r\n}\r\nfound = false;\r\nresource_list_for_each_entry(rentry, &resource_list) {\r\nif (resource_contains(rentry->res, &res)) {\r\nfound = true;\r\nbreak;\r\n}\r\n}\r\nif (!found) {\r\nrentry = resource_list_create_entry(NULL, 0);\r\nif (!rentry)\r\ngoto fail_free_resource_list;\r\n*rentry->res = res;\r\nresource_list_add_tail(rentry, &resource_list);\r\nnresources++;\r\n}\r\n}\r\nresources = kcalloc(nresources, sizeof(*resources), GFP_KERNEL);\r\nif (!resources)\r\ngoto fail_free_resource_list;\r\ni = 0;\r\nresource_list_for_each_entry(rentry, &resource_list)\r\nresources[i++] = *rentry->res;\r\npdev = platform_device_register_simple("wdat_wdt", PLATFORM_DEVID_NONE,\r\nresources, nresources);\r\nif (IS_ERR(pdev))\r\npr_err("Device creation failed: %ld\n", PTR_ERR(pdev));\r\nkfree(resources);\r\nfail_free_resource_list:\r\nresource_list_free(&resource_list);\r\n}

u32 __hyp_text __init_stage2_translation(void)\r\n{\r\nu64 val = VTCR_EL2_FLAGS;\r\nu64 parange;\r\nu64 tmp;\r\nparange = read_sysreg(id_aa64mmfr0_el1) & 7;\r\nval |= parange << 16;\r\nswitch (parange) {\r\ncase 0:\r\nparange = 32;\r\nbreak;\r\ncase 1:\r\nparange = 36;\r\nbreak;\r\ncase 2:\r\nparange = 40;\r\nbreak;\r\ncase 3:\r\nparange = 42;\r\nbreak;\r\ncase 4:\r\nparange = 44;\r\nbreak;\r\ncase 5:\r\ndefault:\r\nparange = 48;\r\nbreak;\r\n}\r\nval |= 64 - (parange > 40 ? 40 : parange);\r\ntmp = (read_sysreg(id_aa64mmfr1_el1) >> ID_AA64MMFR1_HADBS_SHIFT) & 0xf;\r\nif (IS_ENABLED(CONFIG_ARM64_HW_AFDBM) && tmp)\r\nval |= VTCR_EL2_HA;\r\ntmp = (read_sysreg(id_aa64mmfr1_el1) >> ID_AA64MMFR1_VMIDBITS_SHIFT) & 0xf;\r\nval |= (tmp == ID_AA64MMFR1_VMIDBITS_16) ?\r\nVTCR_EL2_VS_16BIT :\r\nVTCR_EL2_VS_8BIT;\r\nwrite_sysreg(val, vtcr_el2);\r\nreturn parange;\r\n}

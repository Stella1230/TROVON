static inline struct ecdh_ctx *ecdh_get_ctx(struct crypto_kpp *tfm)\r\n{\r\nreturn kpp_tfm_ctx(tfm);\r\n}\r\nstatic unsigned int ecdh_supported_curve(unsigned int curve_id)\r\n{\r\nswitch (curve_id) {\r\ncase ECC_CURVE_NIST_P192: return 3;\r\ncase ECC_CURVE_NIST_P256: return 4;\r\ndefault: return 0;\r\n}\r\n}\r\nstatic int ecdh_set_secret(struct crypto_kpp *tfm, void *buf, unsigned int len)\r\n{\r\nstruct ecdh_ctx *ctx = ecdh_get_ctx(tfm);\r\nstruct ecdh params;\r\nunsigned int ndigits;\r\nif (crypto_ecdh_decode_key(buf, len, &params) < 0)\r\nreturn -EINVAL;\r\nndigits = ecdh_supported_curve(params.curve_id);\r\nif (!ndigits)\r\nreturn -EINVAL;\r\nctx->curve_id = params.curve_id;\r\nctx->ndigits = ndigits;\r\nif (ecc_is_key_valid(ctx->curve_id, ctx->ndigits,\r\n(const u8 *)params.key, params.key_size) < 0)\r\nreturn -EINVAL;\r\nmemcpy(ctx->private_key, params.key, params.key_size);\r\nreturn 0;\r\n}\r\nstatic int ecdh_compute_value(struct kpp_request *req)\r\n{\r\nint ret = 0;\r\nstruct crypto_kpp *tfm = crypto_kpp_reqtfm(req);\r\nstruct ecdh_ctx *ctx = ecdh_get_ctx(tfm);\r\nsize_t copied, nbytes;\r\nvoid *buf;\r\nnbytes = ctx->ndigits << ECC_DIGITS_TO_BYTES_SHIFT;\r\nif (req->src) {\r\ncopied = sg_copy_to_buffer(req->src, 1, ctx->public_key,\r\n2 * nbytes);\r\nif (copied != 2 * nbytes)\r\nreturn -EINVAL;\r\nret = crypto_ecdh_shared_secret(ctx->curve_id, ctx->ndigits,\r\n(const u8 *)ctx->private_key, nbytes,\r\n(const u8 *)ctx->public_key, 2 * nbytes,\r\n(u8 *)ctx->shared_secret, nbytes);\r\nbuf = ctx->shared_secret;\r\n} else {\r\nret = ecdh_make_pub_key(ctx->curve_id, ctx->ndigits,\r\n(const u8 *)ctx->private_key, nbytes,\r\n(u8 *)ctx->public_key,\r\nsizeof(ctx->public_key));\r\nbuf = ctx->public_key;\r\nnbytes *= 2;\r\n}\r\nif (ret < 0)\r\nreturn ret;\r\ncopied = sg_copy_from_buffer(req->dst, 1, buf, nbytes);\r\nif (copied != nbytes)\r\nreturn -EINVAL;\r\nreturn ret;\r\n}\r\nstatic int ecdh_max_size(struct crypto_kpp *tfm)\r\n{\r\nstruct ecdh_ctx *ctx = ecdh_get_ctx(tfm);\r\nint nbytes = ctx->ndigits << ECC_DIGITS_TO_BYTES_SHIFT;\r\nreturn 2 * nbytes;\r\n}\r\nstatic void no_exit_tfm(struct crypto_kpp *tfm)\r\n{\r\nreturn;\r\n}\r\nstatic int ecdh_init(void)\r\n{\r\nreturn crypto_register_kpp(&ecdh);\r\n}\r\nstatic void ecdh_exit(void)\r\n{\r\ncrypto_unregister_kpp(&ecdh);\r\n}

int\r\nmain(int argc, const char ** argv)\r\n{\r\nunsigned int i;\r\nargc--;\r\nargv++;\r\nif (!argc) {\r\nfprintf(stderr, "-hpet: requires command\n");\r\nreturn -1;\r\n}\r\nfor (i = 0; i < (sizeof (hpet_command) / sizeof (hpet_command[0])); i++)\r\nif (!strcmp(argv[0], hpet_command[i].command)) {\r\nargc--;\r\nargv++;\r\nfprintf(stderr, "-hpet: executing %s\n",\r\nhpet_command[i].command);\r\nhpet_command[i].func(argc, argv);\r\nreturn 0;\r\n}\r\nfprintf(stderr, "do_hpet: command %s not implemented\n", argv[0]);\r\nreturn -1;\r\n}\r\nvoid\r\nhpet_open_close(int argc, const char **argv)\r\n{\r\nint fd;\r\nif (argc != 1) {\r\nfprintf(stderr, "hpet_open_close: device-name\n");\r\nreturn;\r\n}\r\nfd = open(argv[0], O_RDONLY);\r\nif (fd < 0)\r\nfprintf(stderr, "hpet_open_close: open failed\n");\r\nelse\r\nclose(fd);\r\nreturn;\r\n}\r\nvoid\r\nhpet_info(int argc, const char **argv)\r\n{\r\nstruct hpet_info info;\r\nint fd;\r\nif (argc != 1) {\r\nfprintf(stderr, "hpet_info: device-name\n");\r\nreturn;\r\n}\r\nfd = open(argv[0], O_RDONLY);\r\nif (fd < 0) {\r\nfprintf(stderr, "hpet_info: open of %s failed\n", argv[0]);\r\nreturn;\r\n}\r\nif (ioctl(fd, HPET_INFO, &info) < 0) {\r\nfprintf(stderr, "hpet_info: failed to get info\n");\r\ngoto out;\r\n}\r\nfprintf(stderr, "hpet_info: hi_irqfreq 0x%lx hi_flags 0x%lx ",\r\ninfo.hi_ireqfreq, info.hi_flags);\r\nfprintf(stderr, "hi_hpet %d hi_timer %d\n",\r\ninfo.hi_hpet, info.hi_timer);\r\nout:\r\nclose(fd);\r\nreturn;\r\n}\r\nvoid\r\nhpet_poll(int argc, const char **argv)\r\n{\r\nunsigned long freq;\r\nint iterations, i, fd;\r\nstruct pollfd pfd;\r\nstruct hpet_info info;\r\nstruct timeval stv, etv;\r\nstruct timezone tz;\r\nlong usec;\r\nif (argc != 3) {\r\nfprintf(stderr, "hpet_poll: device-name freq iterations\n");\r\nreturn;\r\n}\r\nfreq = atoi(argv[1]);\r\niterations = atoi(argv[2]);\r\nfd = open(argv[0], O_RDONLY);\r\nif (fd < 0) {\r\nfprintf(stderr, "hpet_poll: open of %s failed\n", argv[0]);\r\nreturn;\r\n}\r\nif (ioctl(fd, HPET_IRQFREQ, freq) < 0) {\r\nfprintf(stderr, "hpet_poll: HPET_IRQFREQ failed\n");\r\ngoto out;\r\n}\r\nif (ioctl(fd, HPET_INFO, &info) < 0) {\r\nfprintf(stderr, "hpet_poll: failed to get info\n");\r\ngoto out;\r\n}\r\nfprintf(stderr, "hpet_poll: info.hi_flags 0x%lx\n", info.hi_flags);\r\nif (info.hi_flags && (ioctl(fd, HPET_EPI, 0) < 0)) {\r\nfprintf(stderr, "hpet_poll: HPET_EPI failed\n");\r\ngoto out;\r\n}\r\nif (ioctl(fd, HPET_IE_ON, 0) < 0) {\r\nfprintf(stderr, "hpet_poll, HPET_IE_ON failed\n");\r\ngoto out;\r\n}\r\npfd.fd = fd;\r\npfd.events = POLLIN;\r\nfor (i = 0; i < iterations; i++) {\r\npfd.revents = 0;\r\ngettimeofday(&stv, &tz);\r\nif (poll(&pfd, 1, -1) < 0)\r\nfprintf(stderr, "hpet_poll: poll failed\n");\r\nelse {\r\nlong data;\r\ngettimeofday(&etv, &tz);\r\nusec = stv.tv_sec * 1000000 + stv.tv_usec;\r\nusec = (etv.tv_sec * 1000000 + etv.tv_usec) - usec;\r\nfprintf(stderr,\r\n"hpet_poll: expired time = 0x%lx\n", usec);\r\nfprintf(stderr, "hpet_poll: revents = 0x%x\n",\r\npfd.revents);\r\nif (read(fd, &data, sizeof(data)) != sizeof(data)) {\r\nfprintf(stderr, "hpet_poll: read failed\n");\r\n}\r\nelse\r\nfprintf(stderr, "hpet_poll: data 0x%lx\n",\r\ndata);\r\n}\r\n}\r\nout:\r\nclose(fd);\r\nreturn;\r\n}\r\nstatic void\r\nhpet_sigio(int val)\r\n{\r\nfprintf(stderr, "hpet_sigio: called\n");\r\nhpet_sigio_count++;\r\n}\r\nvoid\r\nhpet_fasync(int argc, const char **argv)\r\n{\r\nunsigned long freq;\r\nint iterations, i, fd, value;\r\nsig_t oldsig;\r\nstruct hpet_info info;\r\nhpet_sigio_count = 0;\r\nfd = -1;\r\nif ((oldsig = signal(SIGIO, hpet_sigio)) == SIG_ERR) {\r\nfprintf(stderr, "hpet_fasync: failed to set signal handler\n");\r\nreturn;\r\n}\r\nif (argc != 3) {\r\nfprintf(stderr, "hpet_fasync: device-name freq iterations\n");\r\ngoto out;\r\n}\r\nfd = open(argv[0], O_RDONLY);\r\nif (fd < 0) {\r\nfprintf(stderr, "hpet_fasync: failed to open %s\n", argv[0]);\r\nreturn;\r\n}\r\nif ((fcntl(fd, F_SETOWN, getpid()) == 1) ||\r\n((value = fcntl(fd, F_GETFL)) == 1) ||\r\n(fcntl(fd, F_SETFL, value | O_ASYNC) == 1)) {\r\nfprintf(stderr, "hpet_fasync: fcntl failed\n");\r\ngoto out;\r\n}\r\nfreq = atoi(argv[1]);\r\niterations = atoi(argv[2]);\r\nif (ioctl(fd, HPET_IRQFREQ, freq) < 0) {\r\nfprintf(stderr, "hpet_fasync: HPET_IRQFREQ failed\n");\r\ngoto out;\r\n}\r\nif (ioctl(fd, HPET_INFO, &info) < 0) {\r\nfprintf(stderr, "hpet_fasync: failed to get info\n");\r\ngoto out;\r\n}\r\nfprintf(stderr, "hpet_fasync: info.hi_flags 0x%lx\n", info.hi_flags);\r\nif (info.hi_flags && (ioctl(fd, HPET_EPI, 0) < 0)) {\r\nfprintf(stderr, "hpet_fasync: HPET_EPI failed\n");\r\ngoto out;\r\n}\r\nif (ioctl(fd, HPET_IE_ON, 0) < 0) {\r\nfprintf(stderr, "hpet_fasync, HPET_IE_ON failed\n");\r\ngoto out;\r\n}\r\nfor (i = 0; i < iterations; i++) {\r\n(void) pause();\r\nfprintf(stderr, "hpet_fasync: count = %d\n", hpet_sigio_count);\r\n}\r\nout:\r\nsignal(SIGIO, oldsig);\r\nif (fd >= 0)\r\nclose(fd);\r\nreturn;\r\n}

static int intel_vbtn_input_setup(struct platform_device *device)\r\n{\r\nstruct intel_vbtn_priv *priv = dev_get_drvdata(&device->dev);\r\nint ret;\r\npriv->input_dev = devm_input_allocate_device(&device->dev);\r\nif (!priv->input_dev)\r\nreturn -ENOMEM;\r\nret = sparse_keymap_setup(priv->input_dev, intel_vbtn_keymap, NULL);\r\nif (ret)\r\nreturn ret;\r\npriv->input_dev->dev.parent = &device->dev;\r\npriv->input_dev->name = "Intel Virtual Button driver";\r\npriv->input_dev->id.bustype = BUS_HOST;\r\nreturn input_register_device(priv->input_dev);\r\n}\r\nstatic void notify_handler(acpi_handle handle, u32 event, void *context)\r\n{\r\nstruct platform_device *device = context;\r\nstruct intel_vbtn_priv *priv = dev_get_drvdata(&device->dev);\r\nif (!sparse_keymap_report_event(priv->input_dev, event, 1, true))\r\ndev_info(&device->dev, "unknown event index 0x%x\n",\r\nevent);\r\n}\r\nstatic int intel_vbtn_probe(struct platform_device *device)\r\n{\r\nacpi_handle handle = ACPI_HANDLE(&device->dev);\r\nstruct intel_vbtn_priv *priv;\r\nacpi_status status;\r\nint err;\r\nstatus = acpi_evaluate_object(handle, "VBDL", NULL, NULL);\r\nif (ACPI_FAILURE(status)) {\r\ndev_warn(&device->dev, "failed to read Intel Virtual Button driver\n");\r\nreturn -ENODEV;\r\n}\r\npriv = devm_kzalloc(&device->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\ndev_set_drvdata(&device->dev, priv);\r\nerr = intel_vbtn_input_setup(device);\r\nif (err) {\r\npr_err("Failed to setup Intel Virtual Button\n");\r\nreturn err;\r\n}\r\nstatus = acpi_install_notify_handler(handle,\r\nACPI_DEVICE_NOTIFY,\r\nnotify_handler,\r\ndevice);\r\nif (ACPI_FAILURE(status))\r\nreturn -EBUSY;\r\nreturn 0;\r\n}\r\nstatic int intel_vbtn_remove(struct platform_device *device)\r\n{\r\nacpi_handle handle = ACPI_HANDLE(&device->dev);\r\nacpi_remove_notify_handler(handle, ACPI_DEVICE_NOTIFY, notify_handler);\r\nreturn 0;\r\n}\r\nstatic acpi_status __init\r\ncheck_acpi_dev(acpi_handle handle, u32 lvl, void *context, void **rv)\r\n{\r\nconst struct acpi_device_id *ids = context;\r\nstruct acpi_device *dev;\r\nif (acpi_bus_get_device(handle, &dev) != 0)\r\nreturn AE_OK;\r\nif (acpi_match_device_ids(dev, ids) == 0)\r\nif (acpi_create_platform_device(dev, NULL))\r\ndev_info(&dev->dev,\r\n"intel-vbtn: created platform device\n");\r\nreturn AE_OK;\r\n}\r\nstatic int __init intel_vbtn_init(void)\r\n{\r\nacpi_walk_namespace(ACPI_TYPE_DEVICE, ACPI_ROOT_OBJECT,\r\nACPI_UINT32_MAX, check_acpi_dev, NULL,\r\n(void *)intel_vbtn_ids, NULL);\r\nreturn platform_driver_register(&intel_vbtn_pl_driver);\r\n}\r\nstatic void __exit intel_vbtn_exit(void)\r\n{\r\nplatform_driver_unregister(&intel_vbtn_pl_driver);\r\n}

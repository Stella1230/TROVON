static void reg_rw(struct gspca_dev *gspca_dev,\r\nu8 bRequestType, u8 bRequest,\r\nu16 wValue, u16 wIndex, u16 wLength)\r\n{\r\nstruct usb_device *udev = gspca_dev->dev;\r\nint ret;\r\nif (gspca_dev->usb_err < 0)\r\nreturn;\r\nret = usb_control_msg(udev,\r\nusb_rcvctrlpipe(udev, 0),\r\nbRequest,\r\nbRequestType,\r\nwValue, wIndex,\r\ngspca_dev->usb_buf, wLength, 500);\r\nif (ret < 0) {\r\ngspca_dev->usb_err = ret;\r\npr_err("usb_control_msg error %d\n", ret);\r\n}\r\nreturn;\r\n}\r\nstatic int reg_reqs(struct gspca_dev *gspca_dev,\r\nconst struct dtcs033_usb_requests *preqs, int n_reqs)\r\n{\r\nint i = 0;\r\nconst struct dtcs033_usb_requests *preq;\r\nwhile ((i < n_reqs) && (gspca_dev->usb_err >= 0)) {\r\npreq = &preqs[i];\r\nreg_rw(gspca_dev, preq->bRequestType, preq->bRequest,\r\npreq->wValue, preq->wIndex, preq->wLength);\r\nif (gspca_dev->usb_err < 0) {\r\nPERR("usb error request no: %d / %d\n",\r\ni, n_reqs);\r\n} else if (preq->bRequestType & USB_DIR_IN) {\r\nPDEBUG(D_STREAM,\r\n"USB IN (%d) returned[%d] %02X %02X %02X %s",\r\ni,\r\npreq->wLength,\r\ngspca_dev->usb_buf[0],\r\ngspca_dev->usb_buf[1],\r\ngspca_dev->usb_buf[2],\r\npreq->wLength > 3 ? "...\n" : "\n");\r\n}\r\ni++;\r\n}\r\nreturn gspca_dev->usb_err;\r\n}\r\nstatic int sd_config(struct gspca_dev *gspca_dev,\r\nconst struct usb_device_id *id)\r\n{\r\ngspca_dev->cam.cam_mode = dtcs033_mode;\r\ngspca_dev->cam.nmodes = ARRAY_SIZE(dtcs033_mode);\r\ngspca_dev->cam.bulk = 1;\r\ngspca_dev->cam.bulk_nurbs = 1;\r\ngspca_dev->cam.bulk_size = DT_COLS*512;\r\nreturn 0;\r\n}\r\nstatic int sd_init(struct gspca_dev *gspca_dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic void dtcs033_pkt_scan(struct gspca_dev *gspca_dev,\r\nu8 *data,\r\nint len)\r\n{\r\nif (len != DT_COLS*512) {\r\ngspca_dev->last_packet_type = DISCARD_PACKET;\r\nreturn;\r\n}\r\ngspca_frame_add(gspca_dev, FIRST_PACKET, NULL, 0);\r\ngspca_frame_add(gspca_dev, INTER_PACKET,\r\ndata + 16*DT_COLS,\r\nlen - 32*DT_COLS);\r\ngspca_frame_add(gspca_dev, LAST_PACKET, NULL, 0);\r\nreturn;\r\n}\r\nstatic void dtcs033_setexposure(struct gspca_dev *gspca_dev,\r\ns32 expo, s32 gain)\r\n{\r\nu16 sGain = (u16)gain;\r\nu16 gainVal = 224+(sGain-14)*(768-224)/(33-14);\r\nu16 wIndex = 0x0100|(0x00FF&gainVal);\r\nu16 wValue = (0xFF00&gainVal)>>8;\r\nu16 sXTime = (u16)expo;\r\nu16 xtimeVal = (524*(150-(sXTime-1)))/150;\r\nconst u8 bRequestType =\r\nUSB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE;\r\nconst u8 bRequest = 0x18;\r\nreg_rw(gspca_dev,\r\nbRequestType, bRequest, wValue, wIndex, 0);\r\nif (gspca_dev->usb_err < 0)\r\nPERR("usb error in setexposure(gain) sequence.\n");\r\nreg_rw(gspca_dev,\r\nbRequestType, bRequest, (xtimeVal<<4), 0x6300, 0);\r\nif (gspca_dev->usb_err < 0)\r\nPERR("usb error in setexposure(time) sequence.\n");\r\n}\r\nstatic int sd_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct gspca_dev *gspca_dev =\r\ncontainer_of(ctrl->handler,\r\nstruct gspca_dev, ctrl_handler);\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ngspca_dev->usb_err = 0;\r\nif (!gspca_dev->streaming)\r\nreturn 0;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_EXPOSURE:\r\ndtcs033_setexposure(gspca_dev,\r\nctrl->val, sd->gain->val);\r\nbreak;\r\ncase V4L2_CID_GAIN:\r\ndtcs033_setexposure(gspca_dev,\r\nsd->exposure->val, ctrl->val);\r\nbreak;\r\n}\r\nreturn gspca_dev->usb_err;\r\n}\r\nstatic int dtcs033_init_controls(struct gspca_dev *gspca_dev)\r\n{\r\nstruct v4l2_ctrl_handler *hdl = &gspca_dev->ctrl_handler;\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ngspca_dev->vdev.ctrl_handler = hdl;\r\nv4l2_ctrl_handler_init(hdl, 2);\r\nsd->exposure = v4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\r\nV4L2_CID_EXPOSURE,\r\n1, 150, 1, 75);\r\nsd->gain = v4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\r\nV4L2_CID_GAIN,\r\n14, 33, 1, 24);\r\nif (hdl->error) {\r\nPERR("Could not initialize controls: %d\n",\r\nhdl->error);\r\nreturn hdl->error;\r\n}\r\nv4l2_ctrl_cluster(2, &sd->exposure);\r\nreturn 0;\r\n}\r\nstatic int sd_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nreturn gspca_dev_probe(intf, id,\r\n&sd_desc, sizeof(struct sd),\r\nTHIS_MODULE);\r\n}\r\nstatic int dtcs033_start(struct gspca_dev *gspca_dev)\r\n{\r\nreturn reg_reqs(gspca_dev, dtcs033_start_reqs,\r\nARRAY_SIZE(dtcs033_start_reqs));\r\n}\r\nstatic void dtcs033_stopN(struct gspca_dev *gspca_dev)\r\n{\r\nreg_reqs(gspca_dev, dtcs033_stop_reqs,\r\nARRAY_SIZE(dtcs033_stop_reqs));\r\nreturn;\r\n}

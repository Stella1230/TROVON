static void __hyp_text __sysreg_do_nothing(struct kvm_cpu_context *ctxt) { }\r\nstatic void __hyp_text __sysreg_save_common_state(struct kvm_cpu_context *ctxt)\r\n{\r\nctxt->sys_regs[ACTLR_EL1] = read_sysreg(actlr_el1);\r\nctxt->sys_regs[TPIDR_EL0] = read_sysreg(tpidr_el0);\r\nctxt->sys_regs[TPIDRRO_EL0] = read_sysreg(tpidrro_el0);\r\nctxt->sys_regs[TPIDR_EL1] = read_sysreg(tpidr_el1);\r\nctxt->sys_regs[MDSCR_EL1] = read_sysreg(mdscr_el1);\r\nctxt->gp_regs.regs.sp = read_sysreg(sp_el0);\r\nctxt->gp_regs.regs.pc = read_sysreg_el2(elr);\r\nctxt->gp_regs.regs.pstate = read_sysreg_el2(spsr);\r\n}\r\nstatic void __hyp_text __sysreg_save_state(struct kvm_cpu_context *ctxt)\r\n{\r\nctxt->sys_regs[MPIDR_EL1] = read_sysreg(vmpidr_el2);\r\nctxt->sys_regs[CSSELR_EL1] = read_sysreg(csselr_el1);\r\nctxt->sys_regs[SCTLR_EL1] = read_sysreg_el1(sctlr);\r\nctxt->sys_regs[CPACR_EL1] = read_sysreg_el1(cpacr);\r\nctxt->sys_regs[TTBR0_EL1] = read_sysreg_el1(ttbr0);\r\nctxt->sys_regs[TTBR1_EL1] = read_sysreg_el1(ttbr1);\r\nctxt->sys_regs[TCR_EL1] = read_sysreg_el1(tcr);\r\nctxt->sys_regs[ESR_EL1] = read_sysreg_el1(esr);\r\nctxt->sys_regs[AFSR0_EL1] = read_sysreg_el1(afsr0);\r\nctxt->sys_regs[AFSR1_EL1] = read_sysreg_el1(afsr1);\r\nctxt->sys_regs[FAR_EL1] = read_sysreg_el1(far);\r\nctxt->sys_regs[MAIR_EL1] = read_sysreg_el1(mair);\r\nctxt->sys_regs[VBAR_EL1] = read_sysreg_el1(vbar);\r\nctxt->sys_regs[CONTEXTIDR_EL1] = read_sysreg_el1(contextidr);\r\nctxt->sys_regs[AMAIR_EL1] = read_sysreg_el1(amair);\r\nctxt->sys_regs[CNTKCTL_EL1] = read_sysreg_el1(cntkctl);\r\nctxt->sys_regs[PAR_EL1] = read_sysreg(par_el1);\r\nctxt->gp_regs.sp_el1 = read_sysreg(sp_el1);\r\nctxt->gp_regs.elr_el1 = read_sysreg_el1(elr);\r\nctxt->gp_regs.spsr[KVM_SPSR_EL1]= read_sysreg_el1(spsr);\r\n}\r\nvoid __hyp_text __sysreg_save_host_state(struct kvm_cpu_context *ctxt)\r\n{\r\n__sysreg_call_save_host_state()(ctxt);\r\n__sysreg_save_common_state(ctxt);\r\n}\r\nvoid __hyp_text __sysreg_save_guest_state(struct kvm_cpu_context *ctxt)\r\n{\r\n__sysreg_save_state(ctxt);\r\n__sysreg_save_common_state(ctxt);\r\n}\r\nstatic void __hyp_text __sysreg_restore_common_state(struct kvm_cpu_context *ctxt)\r\n{\r\nwrite_sysreg(ctxt->sys_regs[ACTLR_EL1], actlr_el1);\r\nwrite_sysreg(ctxt->sys_regs[TPIDR_EL0], tpidr_el0);\r\nwrite_sysreg(ctxt->sys_regs[TPIDRRO_EL0], tpidrro_el0);\r\nwrite_sysreg(ctxt->sys_regs[TPIDR_EL1], tpidr_el1);\r\nwrite_sysreg(ctxt->sys_regs[MDSCR_EL1], mdscr_el1);\r\nwrite_sysreg(ctxt->gp_regs.regs.sp, sp_el0);\r\nwrite_sysreg_el2(ctxt->gp_regs.regs.pc, elr);\r\nwrite_sysreg_el2(ctxt->gp_regs.regs.pstate, spsr);\r\n}\r\nstatic void __hyp_text __sysreg_restore_state(struct kvm_cpu_context *ctxt)\r\n{\r\nwrite_sysreg(ctxt->sys_regs[MPIDR_EL1], vmpidr_el2);\r\nwrite_sysreg(ctxt->sys_regs[CSSELR_EL1], csselr_el1);\r\nwrite_sysreg_el1(ctxt->sys_regs[SCTLR_EL1], sctlr);\r\nwrite_sysreg_el1(ctxt->sys_regs[CPACR_EL1], cpacr);\r\nwrite_sysreg_el1(ctxt->sys_regs[TTBR0_EL1], ttbr0);\r\nwrite_sysreg_el1(ctxt->sys_regs[TTBR1_EL1], ttbr1);\r\nwrite_sysreg_el1(ctxt->sys_regs[TCR_EL1], tcr);\r\nwrite_sysreg_el1(ctxt->sys_regs[ESR_EL1], esr);\r\nwrite_sysreg_el1(ctxt->sys_regs[AFSR0_EL1], afsr0);\r\nwrite_sysreg_el1(ctxt->sys_regs[AFSR1_EL1], afsr1);\r\nwrite_sysreg_el1(ctxt->sys_regs[FAR_EL1], far);\r\nwrite_sysreg_el1(ctxt->sys_regs[MAIR_EL1], mair);\r\nwrite_sysreg_el1(ctxt->sys_regs[VBAR_EL1], vbar);\r\nwrite_sysreg_el1(ctxt->sys_regs[CONTEXTIDR_EL1],contextidr);\r\nwrite_sysreg_el1(ctxt->sys_regs[AMAIR_EL1], amair);\r\nwrite_sysreg_el1(ctxt->sys_regs[CNTKCTL_EL1], cntkctl);\r\nwrite_sysreg(ctxt->sys_regs[PAR_EL1], par_el1);\r\nwrite_sysreg(ctxt->gp_regs.sp_el1, sp_el1);\r\nwrite_sysreg_el1(ctxt->gp_regs.elr_el1, elr);\r\nwrite_sysreg_el1(ctxt->gp_regs.spsr[KVM_SPSR_EL1],spsr);\r\n}\r\nvoid __hyp_text __sysreg_restore_host_state(struct kvm_cpu_context *ctxt)\r\n{\r\n__sysreg_call_restore_host_state()(ctxt);\r\n__sysreg_restore_common_state(ctxt);\r\n}\r\nvoid __hyp_text __sysreg_restore_guest_state(struct kvm_cpu_context *ctxt)\r\n{\r\n__sysreg_restore_state(ctxt);\r\n__sysreg_restore_common_state(ctxt);\r\n}\r\nvoid __hyp_text __sysreg32_save_state(struct kvm_vcpu *vcpu)\r\n{\r\nu64 *spsr, *sysreg;\r\nif (read_sysreg(hcr_el2) & HCR_RW)\r\nreturn;\r\nspsr = vcpu->arch.ctxt.gp_regs.spsr;\r\nsysreg = vcpu->arch.ctxt.sys_regs;\r\nspsr[KVM_SPSR_ABT] = read_sysreg(spsr_abt);\r\nspsr[KVM_SPSR_UND] = read_sysreg(spsr_und);\r\nspsr[KVM_SPSR_IRQ] = read_sysreg(spsr_irq);\r\nspsr[KVM_SPSR_FIQ] = read_sysreg(spsr_fiq);\r\nsysreg[DACR32_EL2] = read_sysreg(dacr32_el2);\r\nsysreg[IFSR32_EL2] = read_sysreg(ifsr32_el2);\r\nif (__fpsimd_enabled())\r\nsysreg[FPEXC32_EL2] = read_sysreg(fpexc32_el2);\r\nif (vcpu->arch.debug_flags & KVM_ARM64_DEBUG_DIRTY)\r\nsysreg[DBGVCR32_EL2] = read_sysreg(dbgvcr32_el2);\r\n}\r\nvoid __hyp_text __sysreg32_restore_state(struct kvm_vcpu *vcpu)\r\n{\r\nu64 *spsr, *sysreg;\r\nif (read_sysreg(hcr_el2) & HCR_RW)\r\nreturn;\r\nspsr = vcpu->arch.ctxt.gp_regs.spsr;\r\nsysreg = vcpu->arch.ctxt.sys_regs;\r\nwrite_sysreg(spsr[KVM_SPSR_ABT], spsr_abt);\r\nwrite_sysreg(spsr[KVM_SPSR_UND], spsr_und);\r\nwrite_sysreg(spsr[KVM_SPSR_IRQ], spsr_irq);\r\nwrite_sysreg(spsr[KVM_SPSR_FIQ], spsr_fiq);\r\nwrite_sysreg(sysreg[DACR32_EL2], dacr32_el2);\r\nwrite_sysreg(sysreg[IFSR32_EL2], ifsr32_el2);\r\nif (vcpu->arch.debug_flags & KVM_ARM64_DEBUG_DIRTY)\r\nwrite_sysreg(sysreg[DBGVCR32_EL2], dbgvcr32_el2);\r\n}

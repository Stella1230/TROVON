static void exynos_lpass_core_sw_reset(struct exynos_lpass *lpass, int mask)\r\n{\r\nunsigned int val = 0;\r\nregmap_read(lpass->top, SFR_LPASS_CORE_SW_RESET, &val);\r\nval &= ~mask;\r\nregmap_write(lpass->top, SFR_LPASS_CORE_SW_RESET, val);\r\nusleep_range(100, 150);\r\nval |= mask;\r\nregmap_write(lpass->top, SFR_LPASS_CORE_SW_RESET, val);\r\n}\r\nstatic void exynos_lpass_enable(struct exynos_lpass *lpass)\r\n{\r\nregmap_write(lpass->top, SFR_LPASS_INTR_CA5_MASK,\r\nLPASS_INTR_SFR | LPASS_INTR_DMA | LPASS_INTR_I2S);\r\nregmap_write(lpass->top, SFR_LPASS_INTR_CPU_MASK,\r\nLPASS_INTR_SFR | LPASS_INTR_DMA | LPASS_INTR_I2S);\r\nregmap_write(lpass->pmu, EXYNOS5433_PAD_RETENTION_AUD_OPTION,\r\nEXYNOS5433_PAD_INITIATE_WAKEUP_FROM_LOWPWR);\r\nexynos_lpass_core_sw_reset(lpass, LPASS_I2S_SW_RESET);\r\nexynos_lpass_core_sw_reset(lpass, LPASS_DMA_SW_RESET);\r\nexynos_lpass_core_sw_reset(lpass, LPASS_MEM_SW_RESET);\r\n}\r\nstatic void exynos_lpass_disable(struct exynos_lpass *lpass)\r\n{\r\nregmap_write(lpass->top, SFR_LPASS_INTR_CPU_MASK, 0);\r\nregmap_write(lpass->top, SFR_LPASS_INTR_CA5_MASK, 0);\r\nregmap_write(lpass->pmu, EXYNOS5433_PAD_RETENTION_AUD_OPTION, 0);\r\n}\r\nstatic int exynos_lpass_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct exynos_lpass *lpass;\r\nvoid __iomem *base_top;\r\nstruct resource *res;\r\nlpass = devm_kzalloc(dev, sizeof(*lpass), GFP_KERNEL);\r\nif (!lpass)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase_top = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(base_top))\r\nreturn PTR_ERR(base_top);\r\nlpass->top = regmap_init_mmio(dev, base_top,\r\n&exynos_lpass_reg_conf);\r\nif (IS_ERR(lpass->top)) {\r\ndev_err(dev, "LPASS top regmap initialization failed\n");\r\nreturn PTR_ERR(lpass->top);\r\n}\r\nlpass->pmu = syscon_regmap_lookup_by_phandle(dev->of_node,\r\n"samsung,pmu-syscon");\r\nif (IS_ERR(lpass->pmu)) {\r\ndev_err(dev, "Failed to lookup PMU regmap\n");\r\nreturn PTR_ERR(lpass->pmu);\r\n}\r\nplatform_set_drvdata(pdev, lpass);\r\nexynos_lpass_enable(lpass);\r\nreturn of_platform_populate(dev->of_node, NULL, NULL, dev);\r\n}\r\nstatic int __maybe_unused exynos_lpass_suspend(struct device *dev)\r\n{\r\nstruct exynos_lpass *lpass = dev_get_drvdata(dev);\r\nexynos_lpass_disable(lpass);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused exynos_lpass_resume(struct device *dev)\r\n{\r\nstruct exynos_lpass *lpass = dev_get_drvdata(dev);\r\nexynos_lpass_enable(lpass);\r\nreturn 0;\r\n}

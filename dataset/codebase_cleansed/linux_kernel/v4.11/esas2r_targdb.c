void esas2r_targ_db_initialize(struct esas2r_adapter *a)\r\n{\r\nstruct esas2r_target *t;\r\nfor (t = a->targetdb; t < a->targetdb_end; t++) {\r\nmemset(t, 0, sizeof(struct esas2r_target));\r\nt->target_state = TS_NOT_PRESENT;\r\nt->buffered_target_state = TS_NOT_PRESENT;\r\nt->new_target_state = TS_INVALID;\r\n}\r\n}\r\nvoid esas2r_targ_db_remove_all(struct esas2r_adapter *a, bool notify)\r\n{\r\nstruct esas2r_target *t;\r\nunsigned long flags;\r\nfor (t = a->targetdb; t < a->targetdb_end; t++) {\r\nif (t->target_state != TS_PRESENT)\r\ncontinue;\r\nspin_lock_irqsave(&a->mem_lock, flags);\r\nesas2r_targ_db_remove(a, t);\r\nspin_unlock_irqrestore(&a->mem_lock, flags);\r\nif (notify) {\r\nesas2r_trace("remove id:%d", esas2r_targ_get_id(t,\r\na));\r\nesas2r_target_state_changed(a, esas2r_targ_get_id(t,\r\na),\r\nTS_NOT_PRESENT);\r\n}\r\n}\r\n}\r\nvoid esas2r_targ_db_report_changes(struct esas2r_adapter *a)\r\n{\r\nstruct esas2r_target *t;\r\nunsigned long flags;\r\nesas2r_trace_enter();\r\nif (test_bit(AF_DISC_PENDING, &a->flags)) {\r\nesas2r_trace_exit();\r\nreturn;\r\n}\r\nfor (t = a->targetdb; t < a->targetdb_end; t++) {\r\nu8 state = TS_INVALID;\r\nspin_lock_irqsave(&a->mem_lock, flags);\r\nif (t->buffered_target_state != t->target_state)\r\nstate = t->buffered_target_state = t->target_state;\r\nspin_unlock_irqrestore(&a->mem_lock, flags);\r\nif (state != TS_INVALID) {\r\nesas2r_trace("targ_db_report_changes:%d",\r\nesas2r_targ_get_id(\r\nt,\r\na));\r\nesas2r_trace("state:%d", state);\r\nesas2r_target_state_changed(a,\r\nesas2r_targ_get_id(t,\r\na),\r\nstate);\r\n}\r\n}\r\nesas2r_trace_exit();\r\n}\r\nstruct esas2r_target *esas2r_targ_db_add_raid(struct esas2r_adapter *a,\r\nstruct esas2r_disc_context *\r\ndc)\r\n{\r\nstruct esas2r_target *t;\r\nesas2r_trace_enter();\r\nif (dc->curr_virt_id >= ESAS2R_MAX_TARGETS) {\r\nesas2r_bugon();\r\nesas2r_trace_exit();\r\nreturn NULL;\r\n}\r\nt = a->targetdb + dc->curr_virt_id;\r\nif (t->target_state == TS_PRESENT) {\r\nesas2r_trace_exit();\r\nreturn NULL;\r\n}\r\nesas2r_hdebug("add RAID %s, T:%d", dc->raid_grp_name,\r\nesas2r_targ_get_id(\r\nt,\r\na));\r\nif (dc->interleave == 0\r\n|| dc->block_size == 0) {\r\nesas2r_hdebug("invalid RAID group dimensions");\r\nesas2r_trace_exit();\r\nreturn NULL;\r\n}\r\nt->block_size = dc->block_size;\r\nt->inter_byte = dc->interleave;\r\nt->inter_block = dc->interleave / dc->block_size;\r\nt->virt_targ_id = dc->curr_virt_id;\r\nt->phys_targ_id = ESAS2R_TARG_ID_INV;\r\nt->flags &= ~TF_PASS_THRU;\r\nt->flags |= TF_USED;\r\nt->identifier_len = 0;\r\nt->target_state = TS_PRESENT;\r\nreturn t;\r\n}\r\nstruct esas2r_target *esas2r_targ_db_add_pthru(struct esas2r_adapter *a,\r\nstruct esas2r_disc_context *dc,\r\nu8 *ident,\r\nu8 ident_len)\r\n{\r\nstruct esas2r_target *t;\r\nesas2r_trace_enter();\r\nif (dc->curr_virt_id >= ESAS2R_MAX_TARGETS) {\r\nesas2r_bugon();\r\nesas2r_trace_exit();\r\nreturn NULL;\r\n}\r\nt = esas2r_targ_db_find_by_ident(a, ident, ident_len);\r\nif (t == NULL) {\r\nt = a->targetdb + dc->curr_virt_id;\r\nif (ident_len > sizeof(t->identifier)\r\n|| t->target_state == TS_PRESENT) {\r\nesas2r_trace_exit();\r\nreturn NULL;\r\n}\r\n}\r\nesas2r_hdebug("add PT; T:%d, V:%d, P:%d", esas2r_targ_get_id(t, a),\r\ndc->curr_virt_id,\r\ndc->curr_phys_id);\r\nt->block_size = 0;\r\nt->inter_byte = 0;\r\nt->inter_block = 0;\r\nt->virt_targ_id = dc->curr_virt_id;\r\nt->phys_targ_id = dc->curr_phys_id;\r\nt->identifier_len = ident_len;\r\nmemcpy(t->identifier, ident, ident_len);\r\nt->flags |= TF_PASS_THRU | TF_USED;\r\nt->target_state = TS_PRESENT;\r\nreturn t;\r\n}\r\nvoid esas2r_targ_db_remove(struct esas2r_adapter *a, struct esas2r_target *t)\r\n{\r\nesas2r_trace_enter();\r\nt->target_state = TS_NOT_PRESENT;\r\nesas2r_trace("remove id:%d", esas2r_targ_get_id(t, a));\r\nesas2r_trace_exit();\r\n}\r\nstruct esas2r_target *esas2r_targ_db_find_by_sas_addr(struct esas2r_adapter *a,\r\nu64 *sas_addr)\r\n{\r\nstruct esas2r_target *t;\r\nfor (t = a->targetdb; t < a->targetdb_end; t++)\r\nif (t->sas_addr == *sas_addr)\r\nreturn t;\r\nreturn NULL;\r\n}\r\nstruct esas2r_target *esas2r_targ_db_find_by_ident(struct esas2r_adapter *a,\r\nvoid *identifier,\r\nu8 ident_len)\r\n{\r\nstruct esas2r_target *t;\r\nfor (t = a->targetdb; t < a->targetdb_end; t++) {\r\nif (ident_len == t->identifier_len\r\n&& memcmp(&t->identifier[0], identifier,\r\nident_len) == 0)\r\nreturn t;\r\n}\r\nreturn NULL;\r\n}\r\nu16 esas2r_targ_db_find_next_present(struct esas2r_adapter *a, u16 target_id)\r\n{\r\nu16 id = target_id + 1;\r\nwhile (id < ESAS2R_MAX_TARGETS) {\r\nstruct esas2r_target *t = a->targetdb + id;\r\nif (t->target_state == TS_PRESENT)\r\nbreak;\r\nid++;\r\n}\r\nreturn id;\r\n}\r\nstruct esas2r_target *esas2r_targ_db_find_by_virt_id(struct esas2r_adapter *a,\r\nu16 virt_id)\r\n{\r\nstruct esas2r_target *t;\r\nfor (t = a->targetdb; t < a->targetdb_end; t++) {\r\nif (t->target_state != TS_PRESENT)\r\ncontinue;\r\nif (t->virt_targ_id == virt_id)\r\nreturn t;\r\n}\r\nreturn NULL;\r\n}\r\nu16 esas2r_targ_db_get_tgt_cnt(struct esas2r_adapter *a)\r\n{\r\nu16 devcnt = 0;\r\nstruct esas2r_target *t;\r\nunsigned long flags;\r\nspin_lock_irqsave(&a->mem_lock, flags);\r\nfor (t = a->targetdb; t < a->targetdb_end; t++)\r\nif (t->target_state == TS_PRESENT)\r\ndevcnt++;\r\nspin_unlock_irqrestore(&a->mem_lock, flags);\r\nreturn devcnt;\r\n}

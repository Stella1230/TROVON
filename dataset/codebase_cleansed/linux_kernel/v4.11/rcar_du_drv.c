static void rcar_du_lastclose(struct drm_device *dev)\r\n{\r\nstruct rcar_du_device *rcdu = dev->dev_private;\r\ndrm_fbdev_cma_restore_mode(rcdu->fbdev);\r\n}\r\nstatic int rcar_du_enable_vblank(struct drm_device *dev, unsigned int pipe)\r\n{\r\nstruct rcar_du_device *rcdu = dev->dev_private;\r\nrcar_du_crtc_enable_vblank(&rcdu->crtcs[pipe], true);\r\nreturn 0;\r\n}\r\nstatic void rcar_du_disable_vblank(struct drm_device *dev, unsigned int pipe)\r\n{\r\nstruct rcar_du_device *rcdu = dev->dev_private;\r\nrcar_du_crtc_enable_vblank(&rcdu->crtcs[pipe], false);\r\n}\r\nstatic int rcar_du_pm_suspend(struct device *dev)\r\n{\r\nstruct rcar_du_device *rcdu = dev_get_drvdata(dev);\r\ndrm_kms_helper_poll_disable(rcdu->ddev);\r\nreturn 0;\r\n}\r\nstatic int rcar_du_pm_resume(struct device *dev)\r\n{\r\nstruct rcar_du_device *rcdu = dev_get_drvdata(dev);\r\ndrm_kms_helper_poll_enable(rcdu->ddev);\r\nreturn 0;\r\n}\r\nstatic int rcar_du_remove(struct platform_device *pdev)\r\n{\r\nstruct rcar_du_device *rcdu = platform_get_drvdata(pdev);\r\nstruct drm_device *ddev = rcdu->ddev;\r\ndrm_dev_unregister(ddev);\r\nif (rcdu->fbdev)\r\ndrm_fbdev_cma_fini(rcdu->fbdev);\r\ndrm_kms_helper_poll_fini(ddev);\r\ndrm_mode_config_cleanup(ddev);\r\ndrm_dev_unref(ddev);\r\nreturn 0;\r\n}\r\nstatic int rcar_du_probe(struct platform_device *pdev)\r\n{\r\nstruct rcar_du_device *rcdu;\r\nstruct drm_device *ddev;\r\nstruct resource *mem;\r\nint ret;\r\nrcdu = devm_kzalloc(&pdev->dev, sizeof(*rcdu), GFP_KERNEL);\r\nif (rcdu == NULL)\r\nreturn -ENOMEM;\r\ninit_waitqueue_head(&rcdu->commit.wait);\r\nrcdu->dev = &pdev->dev;\r\nrcdu->info = of_match_device(rcar_du_of_table, rcdu->dev)->data;\r\nplatform_set_drvdata(pdev, rcdu);\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nrcdu->mmio = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(rcdu->mmio))\r\nreturn PTR_ERR(rcdu->mmio);\r\nddev = drm_dev_alloc(&rcar_du_driver, &pdev->dev);\r\nif (IS_ERR(ddev))\r\nreturn PTR_ERR(ddev);\r\nrcdu->ddev = ddev;\r\nddev->dev_private = rcdu;\r\nret = rcar_du_modeset_init(rcdu);\r\nif (ret < 0) {\r\nif (ret != -EPROBE_DEFER)\r\ndev_err(&pdev->dev,\r\n"failed to initialize DRM/KMS (%d)\n", ret);\r\ngoto error;\r\n}\r\nddev->irq_enabled = 1;\r\nret = drm_dev_register(ddev, 0);\r\nif (ret)\r\ngoto error;\r\nDRM_INFO("Device %s probed\n", dev_name(&pdev->dev));\r\nreturn 0;\r\nerror:\r\nrcar_du_remove(pdev);\r\nreturn ret;\r\n}

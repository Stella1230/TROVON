static inline void pcf2123_delay_trec(void)\r\n{\r\nndelay(30);\r\n}\r\nstatic int pcf2123_read(struct device *dev, u8 reg, u8 *rxbuf, size_t size)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nint ret;\r\nreg |= PCF2123_READ;\r\nret = spi_write_then_read(spi, &reg, 1, rxbuf, size);\r\npcf2123_delay_trec();\r\nreturn ret;\r\n}\r\nstatic int pcf2123_write(struct device *dev, u8 *txbuf, size_t size)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nint ret;\r\ntxbuf[0] |= PCF2123_WRITE;\r\nret = spi_write(spi, txbuf, size);\r\npcf2123_delay_trec();\r\nreturn ret;\r\n}\r\nstatic int pcf2123_write_reg(struct device *dev, u8 reg, u8 val)\r\n{\r\nu8 txbuf[2];\r\ntxbuf[0] = reg;\r\ntxbuf[1] = val;\r\nreturn pcf2123_write(dev, txbuf, sizeof(txbuf));\r\n}\r\nstatic ssize_t pcf2123_show(struct device *dev, struct device_attribute *attr,\r\nchar *buffer)\r\n{\r\nstruct pcf2123_sysfs_reg *r;\r\nu8 rxbuf[1];\r\nunsigned long reg;\r\nint ret;\r\nr = container_of(attr, struct pcf2123_sysfs_reg, attr);\r\nret = kstrtoul(r->name, 16, &reg);\r\nif (ret)\r\nreturn ret;\r\nret = pcf2123_read(dev, reg, rxbuf, 1);\r\nif (ret < 0)\r\nreturn -EIO;\r\nreturn sprintf(buffer, "0x%x\n", rxbuf[0]);\r\n}\r\nstatic ssize_t pcf2123_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buffer, size_t count)\r\n{\r\nstruct pcf2123_sysfs_reg *r;\r\nunsigned long reg;\r\nunsigned long val;\r\nint ret;\r\nr = container_of(attr, struct pcf2123_sysfs_reg, attr);\r\nret = kstrtoul(r->name, 16, &reg);\r\nif (ret)\r\nreturn ret;\r\nret = kstrtoul(buffer, 10, &val);\r\nif (ret)\r\nreturn ret;\r\nret = pcf2123_write_reg(dev, reg, val);\r\nif (ret < 0)\r\nreturn -EIO;\r\nreturn count;\r\n}\r\nstatic int pcf2123_read_offset(struct device *dev, long *offset)\r\n{\r\nint ret;\r\ns8 reg;\r\nret = pcf2123_read(dev, PCF2123_REG_OFFSET, &reg, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nif (reg & OFFSET_COARSE)\r\nreg <<= 1;\r\nelse\r\nreg = sign_extend32(reg, OFFSET_SIGN_BIT);\r\n*offset = ((long)reg) * OFFSET_STEP;\r\nreturn 0;\r\n}\r\nstatic int pcf2123_set_offset(struct device *dev, long offset)\r\n{\r\ns8 reg;\r\nif (offset > OFFSET_STEP * 127)\r\nreg = 127;\r\nelse if (offset < OFFSET_STEP * -128)\r\nreg = -128;\r\nelse\r\nreg = (s8)((offset + (OFFSET_STEP >> 1)) / OFFSET_STEP);\r\nif (reg & 1 && reg <= 63 && reg >= -64) {\r\nreg &= ~OFFSET_COARSE;\r\n} else {\r\nreg >>= 1;\r\nreg |= OFFSET_COARSE;\r\n}\r\nreturn pcf2123_write_reg(dev, PCF2123_REG_OFFSET, reg);\r\n}\r\nstatic int pcf2123_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nu8 rxbuf[7];\r\nint ret;\r\nret = pcf2123_read(dev, PCF2123_REG_SC, rxbuf, sizeof(rxbuf));\r\nif (ret < 0)\r\nreturn ret;\r\nif (rxbuf[0] & OSC_HAS_STOPPED) {\r\ndev_info(dev, "clock was stopped. Time is not valid\n");\r\nreturn -EINVAL;\r\n}\r\ntm->tm_sec = bcd2bin(rxbuf[0] & 0x7F);\r\ntm->tm_min = bcd2bin(rxbuf[1] & 0x7F);\r\ntm->tm_hour = bcd2bin(rxbuf[2] & 0x3F);\r\ntm->tm_mday = bcd2bin(rxbuf[3] & 0x3F);\r\ntm->tm_wday = rxbuf[4] & 0x07;\r\ntm->tm_mon = bcd2bin(rxbuf[5] & 0x1F) - 1;\r\ntm->tm_year = bcd2bin(rxbuf[6]);\r\nif (tm->tm_year < 70)\r\ntm->tm_year += 100;\r\ndev_dbg(dev, "%s: tm is secs=%d, mins=%d, hours=%d, "\r\n"mday=%d, mon=%d, year=%d, wday=%d\n",\r\n__func__,\r\ntm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year, tm->tm_wday);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int pcf2123_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nu8 txbuf[8];\r\nint ret;\r\ndev_dbg(dev, "%s: tm is secs=%d, mins=%d, hours=%d, "\r\n"mday=%d, mon=%d, year=%d, wday=%d\n",\r\n__func__,\r\ntm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year, tm->tm_wday);\r\nret = pcf2123_write_reg(dev, PCF2123_REG_CTRL1, CTRL1_STOP);\r\nif (ret < 0)\r\nreturn ret;\r\ntxbuf[0] = PCF2123_REG_SC;\r\ntxbuf[1] = bin2bcd(tm->tm_sec & 0x7F);\r\ntxbuf[2] = bin2bcd(tm->tm_min & 0x7F);\r\ntxbuf[3] = bin2bcd(tm->tm_hour & 0x3F);\r\ntxbuf[4] = bin2bcd(tm->tm_mday & 0x3F);\r\ntxbuf[5] = tm->tm_wday & 0x07;\r\ntxbuf[6] = bin2bcd((tm->tm_mon + 1) & 0x1F);\r\ntxbuf[7] = bin2bcd(tm->tm_year < 100 ? tm->tm_year : tm->tm_year - 100);\r\nret = pcf2123_write(dev, txbuf, sizeof(txbuf));\r\nif (ret < 0)\r\nreturn ret;\r\nret = pcf2123_write_reg(dev, PCF2123_REG_CTRL1, CTRL1_CLEAR);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int pcf2123_reset(struct device *dev)\r\n{\r\nint ret;\r\nu8 rxbuf[2];\r\nret = pcf2123_write_reg(dev, PCF2123_REG_CTRL1, CTRL1_SW_RESET);\r\nif (ret < 0)\r\nreturn ret;\r\ndev_dbg(dev, "stopping RTC\n");\r\nret = pcf2123_write_reg(dev, PCF2123_REG_CTRL1, CTRL1_STOP);\r\nif (ret < 0)\r\nreturn ret;\r\ndev_dbg(dev, "checking for presence of RTC\n");\r\nret = pcf2123_read(dev, PCF2123_REG_CTRL1, rxbuf, sizeof(rxbuf));\r\nif (ret < 0)\r\nreturn ret;\r\ndev_dbg(dev, "received data from RTC (0x%02X 0x%02X)\n",\r\nrxbuf[0], rxbuf[1]);\r\nif (!(rxbuf[0] & CTRL1_STOP))\r\nreturn -ENODEV;\r\nret = pcf2123_write_reg(dev, PCF2123_REG_CTRL1, CTRL1_CLEAR);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int pcf2123_probe(struct spi_device *spi)\r\n{\r\nstruct rtc_device *rtc;\r\nstruct rtc_time tm;\r\nstruct pcf2123_plat_data *pdata;\r\nint ret, i;\r\npdata = devm_kzalloc(&spi->dev, sizeof(struct pcf2123_plat_data),\r\nGFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\nspi->dev.platform_data = pdata;\r\nret = pcf2123_rtc_read_time(&spi->dev, &tm);\r\nif (ret < 0) {\r\nret = pcf2123_reset(&spi->dev);\r\nif (ret < 0) {\r\ndev_err(&spi->dev, "chip not found\n");\r\ngoto kfree_exit;\r\n}\r\n}\r\ndev_info(&spi->dev, "spiclk %u KHz.\n",\r\n(spi->max_speed_hz + 500) / 1000);\r\nrtc = devm_rtc_device_register(&spi->dev, pcf2123_driver.driver.name,\r\n&pcf2123_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc)) {\r\ndev_err(&spi->dev, "failed to register.\n");\r\nret = PTR_ERR(rtc);\r\ngoto kfree_exit;\r\n}\r\npdata->rtc = rtc;\r\nfor (i = 0; i < 16; i++) {\r\nsysfs_attr_init(&pdata->regs[i].attr.attr);\r\nsprintf(pdata->regs[i].name, "%1x", i);\r\npdata->regs[i].attr.attr.mode = S_IRUGO | S_IWUSR;\r\npdata->regs[i].attr.attr.name = pdata->regs[i].name;\r\npdata->regs[i].attr.show = pcf2123_show;\r\npdata->regs[i].attr.store = pcf2123_store;\r\nret = device_create_file(&spi->dev, &pdata->regs[i].attr);\r\nif (ret) {\r\ndev_err(&spi->dev, "Unable to create sysfs %s\n",\r\npdata->regs[i].name);\r\ngoto sysfs_exit;\r\n}\r\n}\r\nreturn 0;\r\nsysfs_exit:\r\nfor (i--; i >= 0; i--)\r\ndevice_remove_file(&spi->dev, &pdata->regs[i].attr);\r\nkfree_exit:\r\nspi->dev.platform_data = NULL;\r\nreturn ret;\r\n}\r\nstatic int pcf2123_remove(struct spi_device *spi)\r\n{\r\nstruct pcf2123_plat_data *pdata = dev_get_platdata(&spi->dev);\r\nint i;\r\nif (pdata) {\r\nfor (i = 0; i < 16; i++)\r\nif (pdata->regs[i].name[0])\r\ndevice_remove_file(&spi->dev,\r\n&pdata->regs[i].attr);\r\n}\r\nreturn 0;\r\n}

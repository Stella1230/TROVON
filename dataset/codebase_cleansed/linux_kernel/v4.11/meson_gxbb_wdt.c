static int meson_gxbb_wdt_start(struct watchdog_device *wdt_dev)\r\n{\r\nstruct meson_gxbb_wdt *data = watchdog_get_drvdata(wdt_dev);\r\nwritel(readl(data->reg_base + GXBB_WDT_CTRL_REG) | GXBB_WDT_CTRL_EN,\r\ndata->reg_base + GXBB_WDT_CTRL_REG);\r\nreturn 0;\r\n}\r\nstatic int meson_gxbb_wdt_stop(struct watchdog_device *wdt_dev)\r\n{\r\nstruct meson_gxbb_wdt *data = watchdog_get_drvdata(wdt_dev);\r\nwritel(readl(data->reg_base + GXBB_WDT_CTRL_REG) & ~GXBB_WDT_CTRL_EN,\r\ndata->reg_base + GXBB_WDT_CTRL_REG);\r\nreturn 0;\r\n}\r\nstatic int meson_gxbb_wdt_ping(struct watchdog_device *wdt_dev)\r\n{\r\nstruct meson_gxbb_wdt *data = watchdog_get_drvdata(wdt_dev);\r\nwritel(0, data->reg_base + GXBB_WDT_RSET_REG);\r\nreturn 0;\r\n}\r\nstatic int meson_gxbb_wdt_set_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int timeout)\r\n{\r\nstruct meson_gxbb_wdt *data = watchdog_get_drvdata(wdt_dev);\r\nunsigned long tcnt = timeout * 1000;\r\nif (tcnt > GXBB_WDT_TCNT_SETUP_MASK)\r\ntcnt = GXBB_WDT_TCNT_SETUP_MASK;\r\nwdt_dev->timeout = timeout;\r\nmeson_gxbb_wdt_ping(wdt_dev);\r\nwritel(tcnt, data->reg_base + GXBB_WDT_TCNT_REG);\r\nreturn 0;\r\n}\r\nstatic unsigned int meson_gxbb_wdt_get_timeleft(struct watchdog_device *wdt_dev)\r\n{\r\nstruct meson_gxbb_wdt *data = watchdog_get_drvdata(wdt_dev);\r\nunsigned long reg;\r\nreg = readl(data->reg_base + GXBB_WDT_TCNT_REG);\r\nreturn ((reg >> GXBB_WDT_TCNT_CNT_SHIFT) -\r\n(reg & GXBB_WDT_TCNT_SETUP_MASK)) / 1000;\r\n}\r\nstatic int __maybe_unused meson_gxbb_wdt_resume(struct device *dev)\r\n{\r\nstruct meson_gxbb_wdt *data = dev_get_drvdata(dev);\r\nif (watchdog_active(&data->wdt_dev))\r\nmeson_gxbb_wdt_start(&data->wdt_dev);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused meson_gxbb_wdt_suspend(struct device *dev)\r\n{\r\nstruct meson_gxbb_wdt *data = dev_get_drvdata(dev);\r\nif (watchdog_active(&data->wdt_dev))\r\nmeson_gxbb_wdt_stop(&data->wdt_dev);\r\nreturn 0;\r\n}\r\nstatic int meson_gxbb_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct meson_gxbb_wdt *data;\r\nstruct resource *res;\r\nint ret;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndata->reg_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(data->reg_base))\r\nreturn PTR_ERR(data->reg_base);\r\ndata->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(data->clk))\r\nreturn PTR_ERR(data->clk);\r\nclk_prepare_enable(data->clk);\r\nplatform_set_drvdata(pdev, data);\r\ndata->wdt_dev.parent = &pdev->dev;\r\ndata->wdt_dev.info = &meson_gxbb_wdt_info;\r\ndata->wdt_dev.ops = &meson_gxbb_wdt_ops;\r\ndata->wdt_dev.max_hw_heartbeat_ms = GXBB_WDT_TCNT_SETUP_MASK;\r\ndata->wdt_dev.min_timeout = 1;\r\ndata->wdt_dev.timeout = DEFAULT_TIMEOUT;\r\nwatchdog_set_drvdata(&data->wdt_dev, data);\r\nwritel(((clk_get_rate(data->clk) / 1000) & GXBB_WDT_CTRL_DIV_MASK) |\r\nGXBB_WDT_CTRL_EE_RESET |\r\nGXBB_WDT_CTRL_CLK_EN |\r\nGXBB_WDT_CTRL_CLKDIV_EN,\r\ndata->reg_base + GXBB_WDT_CTRL_REG);\r\nmeson_gxbb_wdt_set_timeout(&data->wdt_dev, data->wdt_dev.timeout);\r\nret = watchdog_register_device(&data->wdt_dev);\r\nif (ret) {\r\nclk_disable_unprepare(data->clk);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int meson_gxbb_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct meson_gxbb_wdt *data = platform_get_drvdata(pdev);\r\nwatchdog_unregister_device(&data->wdt_dev);\r\nclk_disable_unprepare(data->clk);\r\nreturn 0;\r\n}\r\nstatic void meson_gxbb_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nstruct meson_gxbb_wdt *data = platform_get_drvdata(pdev);\r\nmeson_gxbb_wdt_stop(&data->wdt_dev);\r\n}

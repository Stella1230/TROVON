static int sdhci_brcmstb_suspend(struct device *dev)\r\n{\r\nstruct sdhci_host *host = dev_get_drvdata(dev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nint res;\r\nres = sdhci_suspend_host(host);\r\nif (res)\r\nreturn res;\r\nclk_disable_unprepare(pltfm_host->clk);\r\nreturn res;\r\n}\r\nstatic int sdhci_brcmstb_resume(struct device *dev)\r\n{\r\nstruct sdhci_host *host = dev_get_drvdata(dev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nint err;\r\nerr = clk_prepare_enable(pltfm_host->clk);\r\nif (err)\r\nreturn err;\r\nreturn sdhci_resume_host(host);\r\n}\r\nstatic int sdhci_brcmstb_probe(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host;\r\nstruct sdhci_pltfm_host *pltfm_host;\r\nstruct clk *clk;\r\nint res;\r\nclk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(clk)) {\r\ndev_err(&pdev->dev, "Clock not found in Device Tree\n");\r\nclk = NULL;\r\n}\r\nres = clk_prepare_enable(clk);\r\nif (res)\r\nreturn res;\r\nhost = sdhci_pltfm_init(pdev, &sdhci_brcmstb_pdata, 0);\r\nif (IS_ERR(host)) {\r\nres = PTR_ERR(host);\r\ngoto err_clk;\r\n}\r\nhost->mmc->caps2 |= MMC_CAP2_HC_ERASE_SZ;\r\nsdhci_get_of_property(pdev);\r\nmmc_of_parse(host->mmc);\r\nhost->caps = sdhci_readl(host, SDHCI_CAPABILITIES);\r\nif (of_device_is_compatible(pdev->dev.of_node, "brcm,bcm7425-sdhci"))\r\nhost->caps &= ~SDHCI_CAN_64BIT;\r\nhost->caps1 = sdhci_readl(host, SDHCI_CAPABILITIES_1);\r\nhost->caps1 &= ~(SDHCI_SUPPORT_SDR50 | SDHCI_SUPPORT_SDR104 |\r\nSDHCI_SUPPORT_DDR50);\r\nhost->quirks |= SDHCI_QUIRK_MISSING_CAPS |\r\nSDHCI_QUIRK_BROKEN_TIMEOUT_VAL;\r\nres = sdhci_add_host(host);\r\nif (res)\r\ngoto err;\r\npltfm_host = sdhci_priv(host);\r\npltfm_host->clk = clk;\r\nreturn res;\r\nerr:\r\nsdhci_pltfm_free(pdev);\r\nerr_clk:\r\nclk_disable_unprepare(clk);\r\nreturn res;\r\n}

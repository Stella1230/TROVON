static void usage(char *name)\r\n{\r\nprintf("usage: %s [-m] policy_file context_file\n", name);\r\nexit(1);\r\n}\r\nint main(int argc, char *argv[])\r\n{\r\nint i, j, mls = 0;\r\nint initial_sid_to_string_len;\r\nchar **arg, *polout, *ctxout;\r\nFILE *fout;\r\nif (argc < 3)\r\nusage(argv[0]);\r\narg = argv+1;\r\nif (argc==4 && strcmp(argv[1], "-m") == 0) {\r\nmls = 1;\r\narg++;\r\n}\r\npolout = *arg++;\r\nctxout = *arg;\r\nfout = fopen(polout, "w");\r\nif (!fout) {\r\nprintf("Could not open %s for writing\n", polout);\r\nusage(argv[0]);\r\n}\r\nfor (i = 0; secclass_map[i].name; i++)\r\nfprintf(fout, "class %s\n", secclass_map[i].name);\r\nfprintf(fout, "\n");\r\ninitial_sid_to_string_len = sizeof(initial_sid_to_string) / sizeof (char *);\r\nfor (i = 1; i < initial_sid_to_string_len; i++)\r\nfprintf(fout, "sid %s\n", initial_sid_to_string[i]);\r\nfprintf(fout, "\n");\r\nfor (i = 0; secclass_map[i].name; i++) {\r\nstruct security_class_mapping *map = &secclass_map[i];\r\nfprintf(fout, "class %s\n", map->name);\r\nfprintf(fout, "{\n");\r\nfor (j = 0; map->perms[j]; j++)\r\nfprintf(fout, "\t%s\n", map->perms[j]);\r\nfprintf(fout, "}\n\n");\r\n}\r\nfprintf(fout, "\n");\r\nif (mls) {\r\nprintf("MLS not yet implemented\n");\r\nexit(1);\r\n}\r\nfprintf(fout, "type base_t;\n");\r\nfprintf(fout, "role base_r;\n");\r\nfprintf(fout, "role base_r types { base_t };\n");\r\nfor (i = 0; secclass_map[i].name; i++)\r\nfprintf(fout, "allow base_t base_t:%s *;\n",\r\nsecclass_map[i].name);\r\nfprintf(fout, "user user_u roles { base_r };\n");\r\nfprintf(fout, "\n");\r\nfor (i = 1; i < initial_sid_to_string_len; i++)\r\nfprintf(fout, "sid %s user_u:base_r:base_t\n", initial_sid_to_string[i]);\r\nfprintf(fout, "\n");\r\nfprintf(fout, "fs_use_xattr ext2 user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_xattr ext3 user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_xattr ext4 user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_xattr jfs user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_xattr xfs user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_xattr reiserfs user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_xattr jffs2 user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_xattr gfs2 user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_xattr lustre user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_task eventpollfs user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_task pipefs user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_task sockfs user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_trans mqueue user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_trans devpts user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_trans hugetlbfs user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_trans tmpfs user_u:base_r:base_t;\n");\r\nfprintf(fout, "fs_use_trans shm user_u:base_r:base_t;\n");\r\nfprintf(fout, "genfscon proc / user_u:base_r:base_t\n");\r\nfclose(fout);\r\nfout = fopen(ctxout, "w");\r\nif (!fout) {\r\nprintf("Wrote policy, but cannot open %s for writing\n", ctxout);\r\nusage(argv[0]);\r\n}\r\nfprintf(fout, "/ user_u:base_r:base_t\n");\r\nfprintf(fout, "/.* user_u:base_r:base_t\n");\r\nfclose(fout);\r\nreturn 0;\r\n}

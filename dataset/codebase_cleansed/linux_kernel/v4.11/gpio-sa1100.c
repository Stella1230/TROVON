static int sa1100_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nreturn !!(GPLR & GPIO_GPIO(offset));\r\n}\r\nstatic void sa1100_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nif (value)\r\nGPSR = GPIO_GPIO(offset);\r\nelse\r\nGPCR = GPIO_GPIO(offset);\r\n}\r\nstatic int sa1100_direction_input(struct gpio_chip *chip, unsigned offset)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nGPDR &= ~GPIO_GPIO(offset);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int sa1100_direction_output(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nsa1100_gpio_set(chip, offset, value);\r\nGPDR |= GPIO_GPIO(offset);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int sa1100_to_irq(struct gpio_chip *chip, unsigned offset)\r\n{\r\nreturn IRQ_GPIO0 + offset;\r\n}\r\nstatic int sa1100_gpio_type(struct irq_data *d, unsigned int type)\r\n{\r\nunsigned int mask;\r\nmask = BIT(d->hwirq);\r\nif (type == IRQ_TYPE_PROBE) {\r\nif ((GPIO_IRQ_rising_edge | GPIO_IRQ_falling_edge) & mask)\r\nreturn 0;\r\ntype = IRQ_TYPE_EDGE_RISING | IRQ_TYPE_EDGE_FALLING;\r\n}\r\nif (type & IRQ_TYPE_EDGE_RISING)\r\nGPIO_IRQ_rising_edge |= mask;\r\nelse\r\nGPIO_IRQ_rising_edge &= ~mask;\r\nif (type & IRQ_TYPE_EDGE_FALLING)\r\nGPIO_IRQ_falling_edge |= mask;\r\nelse\r\nGPIO_IRQ_falling_edge &= ~mask;\r\nGRER = GPIO_IRQ_rising_edge & GPIO_IRQ_mask;\r\nGFER = GPIO_IRQ_falling_edge & GPIO_IRQ_mask;\r\nreturn 0;\r\n}\r\nstatic void sa1100_gpio_ack(struct irq_data *d)\r\n{\r\nGEDR = BIT(d->hwirq);\r\n}\r\nstatic void sa1100_gpio_mask(struct irq_data *d)\r\n{\r\nunsigned int mask = BIT(d->hwirq);\r\nGPIO_IRQ_mask &= ~mask;\r\nGRER &= ~mask;\r\nGFER &= ~mask;\r\n}\r\nstatic void sa1100_gpio_unmask(struct irq_data *d)\r\n{\r\nunsigned int mask = BIT(d->hwirq);\r\nGPIO_IRQ_mask |= mask;\r\nGRER = GPIO_IRQ_rising_edge & GPIO_IRQ_mask;\r\nGFER = GPIO_IRQ_falling_edge & GPIO_IRQ_mask;\r\n}\r\nstatic int sa1100_gpio_wake(struct irq_data *d, unsigned int on)\r\n{\r\nif (on)\r\nPWER |= BIT(d->hwirq);\r\nelse\r\nPWER &= ~BIT(d->hwirq);\r\nreturn 0;\r\n}\r\nstatic int sa1100_gpio_irqdomain_map(struct irq_domain *d,\r\nunsigned int irq, irq_hw_number_t hwirq)\r\n{\r\nirq_set_chip_and_handler(irq, &sa1100_gpio_irq_chip,\r\nhandle_edge_irq);\r\nirq_set_probe(irq);\r\nreturn 0;\r\n}\r\nstatic void sa1100_gpio_handler(struct irq_desc *desc)\r\n{\r\nunsigned int irq, mask;\r\nmask = GEDR;\r\ndo {\r\nGEDR = mask;\r\nirq = IRQ_GPIO0;\r\ndo {\r\nif (mask & 1)\r\ngeneric_handle_irq(irq);\r\nmask >>= 1;\r\nirq++;\r\n} while (mask);\r\nmask = GEDR;\r\n} while (mask);\r\n}\r\nstatic int sa1100_gpio_suspend(void)\r\n{\r\nGRER = PWER & GPIO_IRQ_rising_edge;\r\nGFER = PWER & GPIO_IRQ_falling_edge;\r\nGEDR = GEDR;\r\nreturn 0;\r\n}\r\nstatic void sa1100_gpio_resume(void)\r\n{\r\nGRER = GPIO_IRQ_rising_edge & GPIO_IRQ_mask;\r\nGFER = GPIO_IRQ_falling_edge & GPIO_IRQ_mask;\r\n}\r\nstatic int __init sa1100_gpio_init_devicefs(void)\r\n{\r\nregister_syscore_ops(&sa1100_gpio_syscore_ops);\r\nreturn 0;\r\n}\r\nvoid __init sa1100_init_gpio(void)\r\n{\r\nGFER = 0;\r\nGRER = 0;\r\nGEDR = -1;\r\ngpiochip_add_data(&sa1100_gpio_chip, NULL);\r\nsa1100_gpio_irqdomain = irq_domain_add_simple(NULL,\r\n28, IRQ_GPIO0,\r\n&sa1100_gpio_irqdomain_ops, NULL);\r\nirq_set_chained_handler(IRQ_GPIO0_SC, sa1100_gpio_handler);\r\nirq_set_chained_handler(IRQ_GPIO1_SC, sa1100_gpio_handler);\r\nirq_set_chained_handler(IRQ_GPIO2_SC, sa1100_gpio_handler);\r\nirq_set_chained_handler(IRQ_GPIO3_SC, sa1100_gpio_handler);\r\nirq_set_chained_handler(IRQ_GPIO4_SC, sa1100_gpio_handler);\r\nirq_set_chained_handler(IRQ_GPIO5_SC, sa1100_gpio_handler);\r\nirq_set_chained_handler(IRQ_GPIO6_SC, sa1100_gpio_handler);\r\nirq_set_chained_handler(IRQ_GPIO7_SC, sa1100_gpio_handler);\r\nirq_set_chained_handler(IRQ_GPIO8_SC, sa1100_gpio_handler);\r\nirq_set_chained_handler(IRQ_GPIO9_SC, sa1100_gpio_handler);\r\nirq_set_chained_handler(IRQ_GPIO10_SC, sa1100_gpio_handler);\r\nirq_set_chained_handler(IRQ_GPIO11_27, sa1100_gpio_handler);\r\n}

struct xfs_cud_log_item *\r\nxfs_trans_get_cud(\r\nstruct xfs_trans *tp,\r\nstruct xfs_cui_log_item *cuip)\r\n{\r\nstruct xfs_cud_log_item *cudp;\r\ncudp = xfs_cud_init(tp->t_mountp, cuip);\r\nxfs_trans_add_item(tp, &cudp->cud_item);\r\nreturn cudp;\r\n}\r\nint\r\nxfs_trans_log_finish_refcount_update(\r\nstruct xfs_trans *tp,\r\nstruct xfs_cud_log_item *cudp,\r\nstruct xfs_defer_ops *dop,\r\nenum xfs_refcount_intent_type type,\r\nxfs_fsblock_t startblock,\r\nxfs_extlen_t blockcount,\r\nxfs_fsblock_t *new_fsb,\r\nxfs_extlen_t *new_len,\r\nstruct xfs_btree_cur **pcur)\r\n{\r\nint error;\r\nerror = xfs_refcount_finish_one(tp, dop, type, startblock,\r\nblockcount, new_fsb, new_len, pcur);\r\ntp->t_flags |= XFS_TRANS_DIRTY;\r\ncudp->cud_item.li_desc->lid_flags |= XFS_LID_DIRTY;\r\nreturn error;\r\n}\r\nstatic int\r\nxfs_refcount_update_diff_items(\r\nvoid *priv,\r\nstruct list_head *a,\r\nstruct list_head *b)\r\n{\r\nstruct xfs_mount *mp = priv;\r\nstruct xfs_refcount_intent *ra;\r\nstruct xfs_refcount_intent *rb;\r\nra = container_of(a, struct xfs_refcount_intent, ri_list);\r\nrb = container_of(b, struct xfs_refcount_intent, ri_list);\r\nreturn XFS_FSB_TO_AGNO(mp, ra->ri_startblock) -\r\nXFS_FSB_TO_AGNO(mp, rb->ri_startblock);\r\n}\r\nSTATIC void *\r\nxfs_refcount_update_create_intent(\r\nstruct xfs_trans *tp,\r\nunsigned int count)\r\n{\r\nstruct xfs_cui_log_item *cuip;\r\nASSERT(tp != NULL);\r\nASSERT(count > 0);\r\ncuip = xfs_cui_init(tp->t_mountp, count);\r\nASSERT(cuip != NULL);\r\nxfs_trans_add_item(tp, &cuip->cui_item);\r\nreturn cuip;\r\n}\r\nstatic void\r\nxfs_trans_set_refcount_flags(\r\nstruct xfs_phys_extent *refc,\r\nenum xfs_refcount_intent_type type)\r\n{\r\nrefc->pe_flags = 0;\r\nswitch (type) {\r\ncase XFS_REFCOUNT_INCREASE:\r\ncase XFS_REFCOUNT_DECREASE:\r\ncase XFS_REFCOUNT_ALLOC_COW:\r\ncase XFS_REFCOUNT_FREE_COW:\r\nrefc->pe_flags |= type;\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\n}\r\n}\r\nSTATIC void\r\nxfs_refcount_update_log_item(\r\nstruct xfs_trans *tp,\r\nvoid *intent,\r\nstruct list_head *item)\r\n{\r\nstruct xfs_cui_log_item *cuip = intent;\r\nstruct xfs_refcount_intent *refc;\r\nuint next_extent;\r\nstruct xfs_phys_extent *ext;\r\nrefc = container_of(item, struct xfs_refcount_intent, ri_list);\r\ntp->t_flags |= XFS_TRANS_DIRTY;\r\ncuip->cui_item.li_desc->lid_flags |= XFS_LID_DIRTY;\r\nnext_extent = atomic_inc_return(&cuip->cui_next_extent) - 1;\r\nASSERT(next_extent < cuip->cui_format.cui_nextents);\r\next = &cuip->cui_format.cui_extents[next_extent];\r\next->pe_startblock = refc->ri_startblock;\r\next->pe_len = refc->ri_blockcount;\r\nxfs_trans_set_refcount_flags(ext, refc->ri_type);\r\n}\r\nSTATIC void *\r\nxfs_refcount_update_create_done(\r\nstruct xfs_trans *tp,\r\nvoid *intent,\r\nunsigned int count)\r\n{\r\nreturn xfs_trans_get_cud(tp, intent);\r\n}\r\nSTATIC int\r\nxfs_refcount_update_finish_item(\r\nstruct xfs_trans *tp,\r\nstruct xfs_defer_ops *dop,\r\nstruct list_head *item,\r\nvoid *done_item,\r\nvoid **state)\r\n{\r\nstruct xfs_refcount_intent *refc;\r\nxfs_fsblock_t new_fsb;\r\nxfs_extlen_t new_aglen;\r\nint error;\r\nrefc = container_of(item, struct xfs_refcount_intent, ri_list);\r\nerror = xfs_trans_log_finish_refcount_update(tp, done_item, dop,\r\nrefc->ri_type,\r\nrefc->ri_startblock,\r\nrefc->ri_blockcount,\r\n&new_fsb, &new_aglen,\r\n(struct xfs_btree_cur **)state);\r\nif (!error && new_aglen > 0) {\r\nASSERT(refc->ri_type == XFS_REFCOUNT_INCREASE ||\r\nrefc->ri_type == XFS_REFCOUNT_DECREASE);\r\nrefc->ri_startblock = new_fsb;\r\nrefc->ri_blockcount = new_aglen;\r\nreturn -EAGAIN;\r\n}\r\nkmem_free(refc);\r\nreturn error;\r\n}\r\nSTATIC void\r\nxfs_refcount_update_finish_cleanup(\r\nstruct xfs_trans *tp,\r\nvoid *state,\r\nint error)\r\n{\r\nstruct xfs_btree_cur *rcur = state;\r\nxfs_refcount_finish_one_cleanup(tp, rcur, error);\r\n}\r\nSTATIC void\r\nxfs_refcount_update_abort_intent(\r\nvoid *intent)\r\n{\r\nxfs_cui_release(intent);\r\n}\r\nSTATIC void\r\nxfs_refcount_update_cancel_item(\r\nstruct list_head *item)\r\n{\r\nstruct xfs_refcount_intent *refc;\r\nrefc = container_of(item, struct xfs_refcount_intent, ri_list);\r\nkmem_free(refc);\r\n}\r\nvoid\r\nxfs_refcount_update_init_defer_op(void)\r\n{\r\nxfs_defer_init_op_type(&xfs_refcount_update_defer_type);\r\n}

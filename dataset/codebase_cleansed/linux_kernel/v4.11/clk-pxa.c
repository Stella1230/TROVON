static unsigned long cken_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct pxa_clk *pclk = to_pxa_clk(hw);\r\nstruct clk_fixed_factor *fix;\r\nif (!pclk->is_in_low_power || pclk->is_in_low_power())\r\nfix = &pclk->lp;\r\nelse\r\nfix = &pclk->hp;\r\n__clk_hw_set_clk(&fix->hw, hw);\r\nreturn clk_fixed_factor_ops.recalc_rate(&fix->hw, parent_rate);\r\n}\r\nstatic u8 cken_get_parent(struct clk_hw *hw)\r\n{\r\nstruct pxa_clk *pclk = to_pxa_clk(hw);\r\nif (!pclk->is_in_low_power)\r\nreturn 0;\r\nreturn pclk->is_in_low_power() ? 0 : 1;\r\n}\r\nvoid __init clkdev_pxa_register(int ckid, const char *con_id,\r\nconst char *dev_id, struct clk *clk)\r\n{\r\nif (!IS_ERR(clk) && (ckid != CLK_NONE))\r\npxa_clocks[ckid] = clk;\r\nif (!IS_ERR(clk))\r\nclk_register_clkdev(clk, con_id, dev_id);\r\n}\r\nint __init clk_pxa_cken_init(const struct desc_clk_cken *clks, int nb_clks)\r\n{\r\nint i;\r\nstruct pxa_clk *pxa_clk;\r\nstruct clk *clk;\r\nfor (i = 0; i < nb_clks; i++) {\r\npxa_clk = kzalloc(sizeof(*pxa_clk), GFP_KERNEL);\r\npxa_clk->is_in_low_power = clks[i].is_in_low_power;\r\npxa_clk->lp = clks[i].lp;\r\npxa_clk->hp = clks[i].hp;\r\npxa_clk->gate = clks[i].gate;\r\npxa_clk->gate.lock = &pxa_clk_lock;\r\nclk = clk_register_composite(NULL, clks[i].name,\r\nclks[i].parent_names, 2,\r\n&pxa_clk->hw, &cken_mux_ops,\r\n&pxa_clk->hw, &cken_rate_ops,\r\n&pxa_clk->gate.hw, &clk_gate_ops,\r\nclks[i].flags);\r\nclkdev_pxa_register(clks[i].ckid, clks[i].con_id,\r\nclks[i].dev_id, clk);\r\n}\r\nreturn 0;\r\n}\r\nvoid __init clk_pxa_dt_common_init(struct device_node *np)\r\n{\r\nof_clk_add_provider(np, of_clk_src_onecell_get, &onecell_data);\r\n}\r\nvoid pxa2xx_core_turbo_switch(bool on)\r\n{\r\nunsigned long flags;\r\nunsigned int unused, clkcfg;\r\nlocal_irq_save(flags);\r\nasm("mrc p14, 0, %0, c6, c0, 0" : "=r" (clkcfg));\r\nclkcfg &= ~CLKCFG_TURBO & ~CLKCFG_HALFTURBO;\r\nif (on)\r\nclkcfg |= CLKCFG_TURBO;\r\nclkcfg |= CLKCFG_FCS;\r\nasm volatile(\r\n" b 2f\n"\r\n" .align 5\n"\r\n"1: mcr p14, 0, %1, c6, c0, 0\n"\r\n" b 3f\n"\r\n"2: b 1b\n"\r\n"3: nop\n"\r\n: "=&r" (unused)\r\n: "r" (clkcfg)\r\n: );\r\nlocal_irq_restore(flags);\r\n}\r\nvoid pxa2xx_cpll_change(struct pxa2xx_freq *freq,\r\nu32 (*mdrefr_dri)(unsigned int), void __iomem *mdrefr,\r\nvoid __iomem *cccr)\r\n{\r\nunsigned int clkcfg = freq->clkcfg;\r\nunsigned int unused, preset_mdrefr, postset_mdrefr;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\npreset_mdrefr = postset_mdrefr = readl(mdrefr);\r\nif ((preset_mdrefr & MDREFR_DRI_MASK) > mdrefr_dri(freq->membus_khz)) {\r\npreset_mdrefr = (preset_mdrefr & ~MDREFR_DRI_MASK);\r\npreset_mdrefr |= mdrefr_dri(freq->membus_khz);\r\n}\r\npostset_mdrefr =\r\n(postset_mdrefr & ~MDREFR_DRI_MASK) |\r\nmdrefr_dri(freq->membus_khz);\r\nif (freq->div2) {\r\npreset_mdrefr |= MDREFR_DB2_MASK;\r\npostset_mdrefr |= MDREFR_DB2_MASK;\r\n} else {\r\npostset_mdrefr &= ~MDREFR_DB2_MASK;\r\n}\r\nwritel(freq->cccr, cccr);\r\nasm volatile(\r\n" ldr r4, [%1]\n"\r\n" b 2f\n"\r\n" .align 5\n"\r\n"1: str %3, [%1] /* preset the MDREFR */\n"\r\n" mcr p14, 0, %2, c6, c0, 0 /* set CLKCFG[FCS] */\n"\r\n" str %4, [%1] /* postset the MDREFR */\n"\r\n" b 3f\n"\r\n"2: b 1b\n"\r\n"3: nop\n"\r\n: "=&r" (unused)\r\n: "r" (mdrefr), "r" (clkcfg), "r" (preset_mdrefr),\r\n"r" (postset_mdrefr)\r\n: "r4", "r5");\r\nlocal_irq_restore(flags);\r\n}\r\nint pxa2xx_determine_rate(struct clk_rate_request *req,\r\nstruct pxa2xx_freq *freqs, int nb_freqs)\r\n{\r\nint i, closest_below = -1, closest_above = -1;\r\nunsigned long rate;\r\nfor (i = 0; i < nb_freqs; i++) {\r\nrate = freqs[i].cpll;\r\nif (rate == req->rate)\r\nbreak;\r\nif (rate < req->min_rate)\r\ncontinue;\r\nif (rate > req->max_rate)\r\ncontinue;\r\nif (rate <= req->rate)\r\nclosest_below = i;\r\nif ((rate >= req->rate) && (closest_above == -1))\r\nclosest_above = i;\r\n}\r\nreq->best_parent_hw = NULL;\r\nif (i < nb_freqs) {\r\nrate = req->rate;\r\n} else if (closest_below >= 0) {\r\nrate = freqs[closest_below].cpll;\r\n} else if (closest_above >= 0) {\r\nrate = freqs[closest_above].cpll;\r\n} else {\r\npr_debug("%s(rate=%lu) no match\n", __func__, req->rate);\r\nreturn -EINVAL;\r\n}\r\npr_debug("%s(rate=%lu) rate=%lu\n", __func__, req->rate, rate);\r\nreq->rate = rate;\r\nreturn 0;\r\n}

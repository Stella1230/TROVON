static dma_addr_t bmips_phys_to_dma(struct device *dev, phys_addr_t pa)\r\n{\r\nstruct bmips_dma_range *r;\r\nfor (r = bmips_dma_ranges; r && r->size; r++) {\r\nif (pa >= r->child_addr &&\r\npa < (r->child_addr + r->size))\r\nreturn pa - r->child_addr + r->parent_addr;\r\n}\r\nreturn pa;\r\n}\r\ndma_addr_t plat_map_dma_mem(struct device *dev, void *addr, size_t size)\r\n{\r\nreturn bmips_phys_to_dma(dev, virt_to_phys(addr));\r\n}\r\ndma_addr_t plat_map_dma_mem_page(struct device *dev, struct page *page)\r\n{\r\nreturn bmips_phys_to_dma(dev, page_to_phys(page));\r\n}\r\nunsigned long plat_dma_addr_to_phys(struct device *dev, dma_addr_t dma_addr)\r\n{\r\nstruct bmips_dma_range *r;\r\nfor (r = bmips_dma_ranges; r && r->size; r++) {\r\nif (dma_addr >= r->parent_addr &&\r\ndma_addr < (r->parent_addr + r->size))\r\nreturn dma_addr - r->parent_addr + r->child_addr;\r\n}\r\nreturn dma_addr;\r\n}\r\nstatic int __init bmips_init_dma_ranges(void)\r\n{\r\nstruct device_node *np =\r\nof_find_compatible_node(NULL, NULL, "brcm,ubus");\r\nconst __be32 *data;\r\nstruct bmips_dma_range *r;\r\nint len;\r\nif (!np)\r\nreturn 0;\r\ndata = of_get_property(np, "dma-ranges", &len);\r\nif (!data)\r\ngoto out_good;\r\nlen /= sizeof(*data) * 3;\r\nif (!len)\r\ngoto out_bad;\r\nbmips_dma_ranges = kzalloc(sizeof(struct bmips_dma_range) * (len + 1),\r\nGFP_KERNEL);\r\nif (!bmips_dma_ranges)\r\ngoto out_bad;\r\nfor (r = bmips_dma_ranges; len; len--, r++) {\r\nr->child_addr = be32_to_cpup(data++);\r\nr->parent_addr = be32_to_cpup(data++);\r\nr->size = be32_to_cpup(data++);\r\n}\r\nout_good:\r\nof_node_put(np);\r\nreturn 0;\r\nout_bad:\r\npr_err("error parsing dma-ranges property\n");\r\nof_node_put(np);\r\nreturn -EINVAL;\r\n}

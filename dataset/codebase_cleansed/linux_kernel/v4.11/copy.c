static snd_pcm_sframes_t copy_transfer(struct snd_pcm_plugin *plugin,\r\nconst struct snd_pcm_plugin_channel *src_channels,\r\nstruct snd_pcm_plugin_channel *dst_channels,\r\nsnd_pcm_uframes_t frames)\r\n{\r\nunsigned int channel;\r\nunsigned int nchannels;\r\nif (snd_BUG_ON(!plugin || !src_channels || !dst_channels))\r\nreturn -ENXIO;\r\nif (frames == 0)\r\nreturn 0;\r\nnchannels = plugin->src_format.channels;\r\nfor (channel = 0; channel < nchannels; channel++) {\r\nif (snd_BUG_ON(src_channels->area.first % 8 ||\r\nsrc_channels->area.step % 8))\r\nreturn -ENXIO;\r\nif (snd_BUG_ON(dst_channels->area.first % 8 ||\r\ndst_channels->area.step % 8))\r\nreturn -ENXIO;\r\nif (!src_channels->enabled) {\r\nif (dst_channels->wanted)\r\nsnd_pcm_area_silence(&dst_channels->area, 0, frames, plugin->dst_format.format);\r\ndst_channels->enabled = 0;\r\ncontinue;\r\n}\r\ndst_channels->enabled = 1;\r\nsnd_pcm_area_copy(&src_channels->area, 0, &dst_channels->area, 0, frames, plugin->src_format.format);\r\nsrc_channels++;\r\ndst_channels++;\r\n}\r\nreturn frames;\r\n}\r\nint snd_pcm_plugin_build_copy(struct snd_pcm_substream *plug,\r\nstruct snd_pcm_plugin_format *src_format,\r\nstruct snd_pcm_plugin_format *dst_format,\r\nstruct snd_pcm_plugin **r_plugin)\r\n{\r\nint err;\r\nstruct snd_pcm_plugin *plugin;\r\nint width;\r\nif (snd_BUG_ON(!r_plugin))\r\nreturn -ENXIO;\r\n*r_plugin = NULL;\r\nif (snd_BUG_ON(src_format->format != dst_format->format))\r\nreturn -ENXIO;\r\nif (snd_BUG_ON(src_format->rate != dst_format->rate))\r\nreturn -ENXIO;\r\nif (snd_BUG_ON(src_format->channels != dst_format->channels))\r\nreturn -ENXIO;\r\nwidth = snd_pcm_format_physical_width(src_format->format);\r\nif (snd_BUG_ON(width <= 0))\r\nreturn -ENXIO;\r\nerr = snd_pcm_plugin_build(plug, "copy", src_format, dst_format,\r\n0, &plugin);\r\nif (err < 0)\r\nreturn err;\r\nplugin->transfer = copy_transfer;\r\n*r_plugin = plugin;\r\nreturn 0;\r\n}

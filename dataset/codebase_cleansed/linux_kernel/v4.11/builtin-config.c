static int set_config(struct perf_config_set *set, const char *file_name,\r\nconst char *var, const char *value)\r\n{\r\nstruct perf_config_section *section = NULL;\r\nstruct perf_config_item *item = NULL;\r\nconst char *first_line = "# this file is auto-generated.";\r\nFILE *fp;\r\nif (set == NULL)\r\nreturn -1;\r\nfp = fopen(file_name, "w");\r\nif (!fp)\r\nreturn -1;\r\nperf_config_set__collect(set, file_name, var, value);\r\nfprintf(fp, "%s\n", first_line);\r\nperf_config_items__for_each_entry(&set->sections, section) {\r\nif (!use_system_config && section->from_system_config)\r\ncontinue;\r\nfprintf(fp, "[%s]\n", section->name);\r\nperf_config_items__for_each_entry(&section->items, item) {\r\nif (!use_system_config && section->from_system_config)\r\ncontinue;\r\nif (item->value)\r\nfprintf(fp, "\t%s = %s\n",\r\nitem->name, item->value);\r\n}\r\n}\r\nfclose(fp);\r\nreturn 0;\r\n}\r\nstatic int show_spec_config(struct perf_config_set *set, const char *var)\r\n{\r\nstruct perf_config_section *section;\r\nstruct perf_config_item *item;\r\nif (set == NULL)\r\nreturn -1;\r\nperf_config_items__for_each_entry(&set->sections, section) {\r\nif (prefixcmp(var, section->name) != 0)\r\ncontinue;\r\nperf_config_items__for_each_entry(&section->items, item) {\r\nconst char *name = var + strlen(section->name) + 1;\r\nif (strcmp(name, item->name) == 0) {\r\nchar *value = item->value;\r\nif (value) {\r\nprintf("%s=%s\n", var, value);\r\nreturn 0;\r\n}\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int show_config(struct perf_config_set *set)\r\n{\r\nstruct perf_config_section *section;\r\nstruct perf_config_item *item;\r\nif (set == NULL)\r\nreturn -1;\r\nperf_config_set__for_each_entry(set, section, item) {\r\nchar *value = item->value;\r\nif (value)\r\nprintf("%s.%s=%s\n", section->name,\r\nitem->name, value);\r\n}\r\nreturn 0;\r\n}\r\nstatic int parse_config_arg(char *arg, char **var, char **value)\r\n{\r\nconst char *last_dot = strchr(arg, '.');\r\nif (last_dot == NULL || last_dot == arg) {\r\npr_err("The config variable does not contain a section name: %s\n", arg);\r\nreturn -1;\r\n}\r\nif (!last_dot[1]) {\r\npr_err("The config variable does not contain a variable name: %s\n", arg);\r\nreturn -1;\r\n}\r\n*value = strchr(arg, '=');\r\nif (*value == NULL)\r\n*var = arg;\r\nelse if (!strcmp(*value, "=")) {\r\npr_err("The config variable does not contain a value: %s\n", arg);\r\nreturn -1;\r\n} else {\r\n*value = *value + 1;\r\n*var = strsep(&arg, "=");\r\nif (*var[0] == '\0') {\r\npr_err("invalid config variable: %s\n", arg);\r\nreturn -1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint cmd_config(int argc, const char **argv, const char *prefix __maybe_unused)\r\n{\r\nint i, ret = 0;\r\nstruct perf_config_set *set;\r\nchar *user_config = mkpath("%s/.perfconfig", getenv("HOME"));\r\nargc = parse_options(argc, argv, config_options, config_usage,\r\nPARSE_OPT_STOP_AT_NON_OPTION);\r\nif (use_system_config && use_user_config) {\r\npr_err("Error: only one config file at a time\n");\r\nparse_options_usage(config_usage, config_options, "user", 0);\r\nparse_options_usage(NULL, config_options, "system", 0);\r\nreturn -1;\r\n}\r\nif (use_system_config)\r\nconfig_exclusive_filename = perf_etc_perfconfig();\r\nelse if (use_user_config)\r\nconfig_exclusive_filename = user_config;\r\nset = perf_config_set__new();\r\nif (!set) {\r\nret = -1;\r\ngoto out_err;\r\n}\r\nswitch (actions) {\r\ncase ACTION_LIST:\r\nif (argc) {\r\npr_err("Error: takes no arguments\n");\r\nparse_options_usage(config_usage, config_options, "l", 1);\r\n} else {\r\nret = show_config(set);\r\nif (ret < 0) {\r\nconst char * config_filename = config_exclusive_filename;\r\nif (!config_exclusive_filename)\r\nconfig_filename = user_config;\r\npr_err("Nothing configured, "\r\n"please check your %s \n", config_filename);\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nif (argc) {\r\nfor (i = 0; argv[i]; i++) {\r\nchar *var, *value;\r\nchar *arg = strdup(argv[i]);\r\nif (!arg) {\r\npr_err("%s: strdup failed\n", __func__);\r\nret = -1;\r\nbreak;\r\n}\r\nif (parse_config_arg(arg, &var, &value) < 0) {\r\nfree(arg);\r\nret = -1;\r\nbreak;\r\n}\r\nif (value == NULL)\r\nret = show_spec_config(set, var);\r\nelse {\r\nconst char *config_filename = config_exclusive_filename;\r\nif (!config_exclusive_filename)\r\nconfig_filename = user_config;\r\nret = set_config(set, config_filename, var, value);\r\n}\r\nfree(arg);\r\n}\r\n} else\r\nusage_with_options(config_usage, config_options);\r\n}\r\nperf_config_set__delete(set);\r\nout_err:\r\nreturn ret;\r\n}

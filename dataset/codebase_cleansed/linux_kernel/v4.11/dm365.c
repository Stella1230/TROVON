void __init dm365_init_spi0(unsigned chipselect_mask,\r\nconst struct spi_board_info *info, unsigned len)\r\n{\r\ndavinci_cfg_reg(DM365_SPI0_SCLK);\r\ndavinci_cfg_reg(DM365_SPI0_SDI);\r\ndavinci_cfg_reg(DM365_SPI0_SDO);\r\nif (chipselect_mask & BIT(0))\r\ndavinci_cfg_reg(DM365_SPI0_SDENA0);\r\nif (chipselect_mask & BIT(1))\r\ndavinci_cfg_reg(DM365_SPI0_SDENA1);\r\nspi_register_board_info(info, len);\r\nplatform_device_register(&dm365_spi0_device);\r\n}\r\nint __init dm365_gpio_register(void)\r\n{\r\nreturn davinci_gpio_register(dm365_gpio_resources,\r\nARRAY_SIZE(dm365_gpio_resources),\r\n&dm365_gpio_platform_data);\r\n}\r\nvoid __init dm365_init_asp(void)\r\n{\r\ndavinci_cfg_reg(DM365_MCBSP0_BDX);\r\ndavinci_cfg_reg(DM365_MCBSP0_X);\r\ndavinci_cfg_reg(DM365_MCBSP0_BFSX);\r\ndavinci_cfg_reg(DM365_MCBSP0_BDR);\r\ndavinci_cfg_reg(DM365_MCBSP0_R);\r\ndavinci_cfg_reg(DM365_MCBSP0_BFSR);\r\ndavinci_cfg_reg(DM365_EVT2_ASP_TX);\r\ndavinci_cfg_reg(DM365_EVT3_ASP_RX);\r\nplatform_device_register(&dm365_asp_device);\r\n}\r\nvoid __init dm365_init_vc(void)\r\n{\r\ndavinci_cfg_reg(DM365_EVT2_VC_TX);\r\ndavinci_cfg_reg(DM365_EVT3_VC_RX);\r\nplatform_device_register(&dm365_vc_device);\r\n}\r\nvoid __init dm365_init_ks(struct davinci_ks_platform_data *pdata)\r\n{\r\ndm365_ks_device.dev.platform_data = pdata;\r\nplatform_device_register(&dm365_ks_device);\r\n}\r\nvoid __init dm365_init_rtc(void)\r\n{\r\ndavinci_cfg_reg(DM365_INT_PRTCSS);\r\nplatform_device_register(&dm365_rtc_device);\r\n}\r\nvoid __init dm365_init(void)\r\n{\r\ndavinci_common_init(&davinci_soc_info_dm365);\r\ndavinci_map_sysmod();\r\ndavinci_clk_init(davinci_soc_info_dm365.cpu_clks);\r\n}\r\nstatic void dm365_isif_setup_pinmux(void)\r\n{\r\ndavinci_cfg_reg(DM365_VIN_CAM_WEN);\r\ndavinci_cfg_reg(DM365_VIN_CAM_VD);\r\ndavinci_cfg_reg(DM365_VIN_CAM_HD);\r\ndavinci_cfg_reg(DM365_VIN_YIN4_7_EN);\r\ndavinci_cfg_reg(DM365_VIN_YIN0_3_EN);\r\n}\r\nstatic int dm365_vpbe_setup_pinmux(u32 if_type, int field)\r\n{\r\nswitch (if_type) {\r\ncase MEDIA_BUS_FMT_SGRBG8_1X8:\r\ndavinci_cfg_reg(DM365_VOUT_FIELD_G81);\r\ndavinci_cfg_reg(DM365_VOUT_COUTL_EN);\r\ndavinci_cfg_reg(DM365_VOUT_COUTH_EN);\r\nbreak;\r\ncase MEDIA_BUS_FMT_YUYV10_1X20:\r\nif (field)\r\ndavinci_cfg_reg(DM365_VOUT_FIELD);\r\nelse\r\ndavinci_cfg_reg(DM365_VOUT_FIELD_G81);\r\ndavinci_cfg_reg(DM365_VOUT_COUTL_EN);\r\ndavinci_cfg_reg(DM365_VOUT_COUTH_EN);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int dm365_venc_setup_clock(enum vpbe_enc_timings_type type,\r\nunsigned int pclock)\r\n{\r\nvoid __iomem *vpss_clkctl_reg;\r\nu32 val;\r\nvpss_clkctl_reg = DAVINCI_SYSMOD_VIRT(SYSMOD_VPSS_CLKCTL);\r\nswitch (type) {\r\ncase VPBE_ENC_STD:\r\nval = VPSS_VENCCLKEN_ENABLE | VPSS_DACCLKEN_ENABLE;\r\nbreak;\r\ncase VPBE_ENC_DV_TIMINGS:\r\nif (pclock <= 27000000) {\r\nval = VPSS_VENCCLKEN_ENABLE | VPSS_DACCLKEN_ENABLE;\r\n} else {\r\nval = VPSS_PLLC2SYSCLK5_ENABLE | VPSS_DACCLKEN_ENABLE |\r\nVPSS_VENCCLKEN_ENABLE;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nwritel(val, vpss_clkctl_reg);\r\nreturn 0;\r\n}\r\nint __init dm365_init_video(struct vpfe_config *vpfe_cfg,\r\nstruct vpbe_config *vpbe_cfg)\r\n{\r\nif (vpfe_cfg || vpbe_cfg)\r\nplatform_device_register(&dm365_vpss_device);\r\nif (vpfe_cfg) {\r\nvpfe_capture_dev.dev.platform_data = vpfe_cfg;\r\nplatform_device_register(&dm365_isif_dev);\r\nplatform_device_register(&vpfe_capture_dev);\r\n}\r\nif (vpbe_cfg) {\r\ndm365_vpbe_dev.dev.platform_data = vpbe_cfg;\r\nplatform_device_register(&dm365_osd_dev);\r\nplatform_device_register(&dm365_venc_dev);\r\nplatform_device_register(&dm365_vpbe_dev);\r\nplatform_device_register(&dm365_vpbe_display);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init dm365_init_devices(void)\r\n{\r\nint ret = 0;\r\nif (!cpu_is_davinci_dm365())\r\nreturn 0;\r\ndavinci_cfg_reg(DM365_INT_EDMA_CC);\r\nplatform_device_register(&dm365_edma_device);\r\nplatform_device_register(&dm365_mdio_device);\r\nplatform_device_register(&dm365_emac_device);\r\nret = davinci_init_wdt();\r\nif (ret)\r\npr_warn("%s: watchdog init failed: %d\n", __func__, ret);\r\nreturn ret;\r\n}

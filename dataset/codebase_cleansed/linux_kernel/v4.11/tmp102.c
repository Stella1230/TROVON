static inline int tmp102_reg_to_mC(s16 val)\r\n{\r\nreturn ((val & ~0x01) * 1000) / 128;\r\n}\r\nstatic inline u16 tmp102_mC_to_reg(int val)\r\n{\r\nreturn (val * 128) / 1000;\r\n}\r\nstatic int tmp102_read(struct device *dev, enum hwmon_sensor_types type,\r\nu32 attr, int channel, long *temp)\r\n{\r\nstruct tmp102 *tmp102 = dev_get_drvdata(dev);\r\nunsigned int regval;\r\nint err, reg;\r\nswitch (attr) {\r\ncase hwmon_temp_input:\r\nif (time_before(jiffies, tmp102->ready_time)) {\r\ndev_dbg(dev, "%s: Conversion not ready yet..\n", __func__);\r\nreturn -EAGAIN;\r\n}\r\nreg = TMP102_TEMP_REG;\r\nbreak;\r\ncase hwmon_temp_max_hyst:\r\nreg = TMP102_TLOW_REG;\r\nbreak;\r\ncase hwmon_temp_max:\r\nreg = TMP102_THIGH_REG;\r\nbreak;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\nerr = regmap_read(tmp102->regmap, reg, &regval);\r\nif (err < 0)\r\nreturn err;\r\n*temp = tmp102_reg_to_mC(regval);\r\nreturn 0;\r\n}\r\nstatic int tmp102_write(struct device *dev, enum hwmon_sensor_types type,\r\nu32 attr, int channel, long temp)\r\n{\r\nstruct tmp102 *tmp102 = dev_get_drvdata(dev);\r\nint reg;\r\nswitch (attr) {\r\ncase hwmon_temp_max_hyst:\r\nreg = TMP102_TLOW_REG;\r\nbreak;\r\ncase hwmon_temp_max:\r\nreg = TMP102_THIGH_REG;\r\nbreak;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\ntemp = clamp_val(temp, -256000, 255000);\r\nreturn regmap_write(tmp102->regmap, reg, tmp102_mC_to_reg(temp));\r\n}\r\nstatic umode_t tmp102_is_visible(const void *data, enum hwmon_sensor_types type,\r\nu32 attr, int channel)\r\n{\r\nif (type != hwmon_temp)\r\nreturn 0;\r\nswitch (attr) {\r\ncase hwmon_temp_input:\r\nreturn S_IRUGO;\r\ncase hwmon_temp_max_hyst:\r\ncase hwmon_temp_max:\r\nreturn S_IRUGO | S_IWUSR;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic void tmp102_restore_config(void *data)\r\n{\r\nstruct tmp102 *tmp102 = data;\r\nregmap_write(tmp102->regmap, TMP102_CONF_REG, tmp102->config_orig);\r\n}\r\nstatic bool tmp102_is_writeable_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn reg != TMP102_TEMP_REG;\r\n}\r\nstatic bool tmp102_is_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn reg == TMP102_TEMP_REG;\r\n}\r\nstatic int tmp102_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct device *hwmon_dev;\r\nstruct tmp102 *tmp102;\r\nunsigned int regval;\r\nint err;\r\nif (!i2c_check_functionality(client->adapter,\r\nI2C_FUNC_SMBUS_WORD_DATA)) {\r\ndev_err(dev,\r\n"adapter doesn't support SMBus word transactions\n");\r\nreturn -ENODEV;\r\n}\r\ntmp102 = devm_kzalloc(dev, sizeof(*tmp102), GFP_KERNEL);\r\nif (!tmp102)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, tmp102);\r\ntmp102->regmap = devm_regmap_init_i2c(client, &tmp102_regmap_config);\r\nif (IS_ERR(tmp102->regmap))\r\nreturn PTR_ERR(tmp102->regmap);\r\nerr = regmap_read(tmp102->regmap, TMP102_CONF_REG, &regval);\r\nif (err < 0) {\r\ndev_err(dev, "error reading config register\n");\r\nreturn err;\r\n}\r\nif ((regval & ~TMP102_CONFREG_MASK) !=\r\n(TMP102_CONF_R0 | TMP102_CONF_R1)) {\r\ndev_err(dev, "unexpected config register value\n");\r\nreturn -ENODEV;\r\n}\r\ntmp102->config_orig = regval;\r\nerr = devm_add_action_or_reset(dev, tmp102_restore_config, tmp102);\r\nif (err)\r\nreturn err;\r\nregval &= ~TMP102_CONFIG_CLEAR;\r\nregval |= TMP102_CONFIG_SET;\r\nerr = regmap_write(tmp102->regmap, TMP102_CONF_REG, regval);\r\nif (err < 0) {\r\ndev_err(dev, "error writing config register\n");\r\nreturn err;\r\n}\r\ntmp102->ready_time = jiffies;\r\nif (tmp102->config_orig & TMP102_CONF_SD) {\r\ntmp102->ready_time += msecs_to_jiffies(CONVERSION_TIME_MS);\r\n}\r\nhwmon_dev = devm_hwmon_device_register_with_info(dev, client->name,\r\ntmp102,\r\n&tmp102_chip_info,\r\nNULL);\r\nif (IS_ERR(hwmon_dev)) {\r\ndev_dbg(dev, "unable to register hwmon device\n");\r\nreturn PTR_ERR(hwmon_dev);\r\n}\r\ndev_info(dev, "initialized\n");\r\nreturn 0;\r\n}\r\nstatic int tmp102_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct tmp102 *tmp102 = i2c_get_clientdata(client);\r\nreturn regmap_update_bits(tmp102->regmap, TMP102_CONF_REG,\r\nTMP102_CONF_SD, TMP102_CONF_SD);\r\n}\r\nstatic int tmp102_resume(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct tmp102 *tmp102 = i2c_get_clientdata(client);\r\nint err;\r\nerr = regmap_update_bits(tmp102->regmap, TMP102_CONF_REG,\r\nTMP102_CONF_SD, 0);\r\ntmp102->ready_time = jiffies + msecs_to_jiffies(CONVERSION_TIME_MS);\r\nreturn err;\r\n}

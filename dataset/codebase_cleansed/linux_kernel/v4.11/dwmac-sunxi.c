static int sun7i_gmac_init(struct platform_device *pdev, void *priv)\r\n{\r\nstruct sunxi_priv_data *gmac = priv;\r\nint ret;\r\nif (gmac->regulator) {\r\nret = regulator_enable(gmac->regulator);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (gmac->interface == PHY_INTERFACE_MODE_RGMII) {\r\nclk_set_rate(gmac->tx_clk, SUN7I_GMAC_GMII_RGMII_RATE);\r\nclk_prepare_enable(gmac->tx_clk);\r\ngmac->clk_enabled = 1;\r\n} else {\r\nclk_set_rate(gmac->tx_clk, SUN7I_GMAC_MII_RATE);\r\nclk_prepare(gmac->tx_clk);\r\n}\r\nreturn 0;\r\n}\r\nstatic void sun7i_gmac_exit(struct platform_device *pdev, void *priv)\r\n{\r\nstruct sunxi_priv_data *gmac = priv;\r\nif (gmac->clk_enabled) {\r\nclk_disable(gmac->tx_clk);\r\ngmac->clk_enabled = 0;\r\n}\r\nclk_unprepare(gmac->tx_clk);\r\nif (gmac->regulator)\r\nregulator_disable(gmac->regulator);\r\n}\r\nstatic void sun7i_fix_speed(void *priv, unsigned int speed)\r\n{\r\nstruct sunxi_priv_data *gmac = priv;\r\nif (gmac->interface != PHY_INTERFACE_MODE_GMII)\r\nreturn;\r\nif (gmac->clk_enabled) {\r\nclk_disable(gmac->tx_clk);\r\ngmac->clk_enabled = 0;\r\n}\r\nclk_unprepare(gmac->tx_clk);\r\nif (speed == 1000) {\r\nclk_set_rate(gmac->tx_clk, SUN7I_GMAC_GMII_RGMII_RATE);\r\nclk_prepare_enable(gmac->tx_clk);\r\ngmac->clk_enabled = 1;\r\n} else {\r\nclk_set_rate(gmac->tx_clk, SUN7I_GMAC_MII_RATE);\r\nclk_prepare(gmac->tx_clk);\r\n}\r\n}\r\nstatic int sun7i_gmac_probe(struct platform_device *pdev)\r\n{\r\nstruct plat_stmmacenet_data *plat_dat;\r\nstruct stmmac_resources stmmac_res;\r\nstruct sunxi_priv_data *gmac;\r\nstruct device *dev = &pdev->dev;\r\nint ret;\r\nret = stmmac_get_platform_resources(pdev, &stmmac_res);\r\nif (ret)\r\nreturn ret;\r\nplat_dat = stmmac_probe_config_dt(pdev, &stmmac_res.mac);\r\nif (IS_ERR(plat_dat))\r\nreturn PTR_ERR(plat_dat);\r\ngmac = devm_kzalloc(dev, sizeof(*gmac), GFP_KERNEL);\r\nif (!gmac) {\r\nret = -ENOMEM;\r\ngoto err_remove_config_dt;\r\n}\r\ngmac->interface = of_get_phy_mode(dev->of_node);\r\ngmac->tx_clk = devm_clk_get(dev, "allwinner_gmac_tx");\r\nif (IS_ERR(gmac->tx_clk)) {\r\ndev_err(dev, "could not get tx clock\n");\r\nret = PTR_ERR(gmac->tx_clk);\r\ngoto err_remove_config_dt;\r\n}\r\ngmac->regulator = devm_regulator_get_optional(dev, "phy");\r\nif (IS_ERR(gmac->regulator)) {\r\nif (PTR_ERR(gmac->regulator) == -EPROBE_DEFER) {\r\nret = -EPROBE_DEFER;\r\ngoto err_remove_config_dt;\r\n}\r\ndev_info(dev, "no regulator found\n");\r\ngmac->regulator = NULL;\r\n}\r\nplat_dat->tx_coe = 1;\r\nplat_dat->has_gmac = true;\r\nplat_dat->bsp_priv = gmac;\r\nplat_dat->init = sun7i_gmac_init;\r\nplat_dat->exit = sun7i_gmac_exit;\r\nplat_dat->fix_mac_speed = sun7i_fix_speed;\r\nret = sun7i_gmac_init(pdev, plat_dat->bsp_priv);\r\nif (ret)\r\ngoto err_remove_config_dt;\r\nret = stmmac_dvr_probe(&pdev->dev, plat_dat, &stmmac_res);\r\nif (ret)\r\ngoto err_gmac_exit;\r\nreturn 0;\r\nerr_gmac_exit:\r\nsun7i_gmac_exit(pdev, plat_dat->bsp_priv);\r\nerr_remove_config_dt:\r\nstmmac_remove_config_dt(pdev, plat_dat);\r\nreturn ret;\r\n}

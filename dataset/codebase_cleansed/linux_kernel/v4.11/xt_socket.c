static bool\r\nsocket_match(const struct sk_buff *skb, struct xt_action_param *par,\r\nconst struct xt_socket_mtinfo1 *info)\r\n{\r\nstruct sk_buff *pskb = (struct sk_buff *)skb;\r\nstruct sock *sk = skb->sk;\r\nif (!sk)\r\nsk = nf_sk_lookup_slow_v4(xt_net(par), skb, xt_in(par));\r\nif (sk) {\r\nbool wildcard;\r\nbool transparent = true;\r\nwildcard = (!(info->flags & XT_SOCKET_NOWILDCARD) &&\r\nsk_fullsock(sk) &&\r\ninet_sk(sk)->inet_rcv_saddr == 0);\r\nif (info->flags & XT_SOCKET_TRANSPARENT)\r\ntransparent = nf_sk_is_transparent(sk);\r\nif (info->flags & XT_SOCKET_RESTORESKMARK && !wildcard &&\r\ntransparent)\r\npskb->mark = sk->sk_mark;\r\nif (sk != skb->sk)\r\nsock_gen_put(sk);\r\nif (wildcard || !transparent)\r\nsk = NULL;\r\n}\r\nreturn sk != NULL;\r\n}\r\nstatic bool\r\nsocket_mt4_v0(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nstatic struct xt_socket_mtinfo1 xt_info_v0 = {\r\n.flags = 0,\r\n};\r\nreturn socket_match(skb, par, &xt_info_v0);\r\n}\r\nstatic bool\r\nsocket_mt4_v1_v2_v3(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nreturn socket_match(skb, par, par->matchinfo);\r\n}\r\nstatic bool\r\nsocket_mt6_v1_v2_v3(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_socket_mtinfo1 *info = (struct xt_socket_mtinfo1 *) par->matchinfo;\r\nstruct sk_buff *pskb = (struct sk_buff *)skb;\r\nstruct sock *sk = skb->sk;\r\nif (!sk)\r\nsk = nf_sk_lookup_slow_v6(xt_net(par), skb, xt_in(par));\r\nif (sk) {\r\nbool wildcard;\r\nbool transparent = true;\r\nwildcard = (!(info->flags & XT_SOCKET_NOWILDCARD) &&\r\nsk_fullsock(sk) &&\r\nipv6_addr_any(&sk->sk_v6_rcv_saddr));\r\nif (info->flags & XT_SOCKET_TRANSPARENT)\r\ntransparent = nf_sk_is_transparent(sk);\r\nif (info->flags & XT_SOCKET_RESTORESKMARK && !wildcard &&\r\ntransparent)\r\npskb->mark = sk->sk_mark;\r\nif (sk != skb->sk)\r\nsock_gen_put(sk);\r\nif (wildcard || !transparent)\r\nsk = NULL;\r\n}\r\nreturn sk != NULL;\r\n}\r\nstatic int socket_mt_enable_defrag(struct net *net, int family)\r\n{\r\nswitch (family) {\r\ncase NFPROTO_IPV4:\r\nreturn nf_defrag_ipv4_enable(net);\r\n#ifdef XT_SOCKET_HAVE_IPV6\r\ncase NFPROTO_IPV6:\r\nreturn nf_defrag_ipv6_enable(net);\r\n#endif\r\n}\r\nWARN_ONCE(1, "Unknown family %d\n", family);\r\nreturn 0;\r\n}\r\nstatic int socket_mt_v1_check(const struct xt_mtchk_param *par)\r\n{\r\nconst struct xt_socket_mtinfo1 *info = (struct xt_socket_mtinfo1 *) par->matchinfo;\r\nint err;\r\nerr = socket_mt_enable_defrag(par->net, par->family);\r\nif (err)\r\nreturn err;\r\nif (info->flags & ~XT_SOCKET_FLAGS_V1) {\r\npr_info("unknown flags 0x%x\n", info->flags & ~XT_SOCKET_FLAGS_V1);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int socket_mt_v2_check(const struct xt_mtchk_param *par)\r\n{\r\nconst struct xt_socket_mtinfo2 *info = (struct xt_socket_mtinfo2 *) par->matchinfo;\r\nint err;\r\nerr = socket_mt_enable_defrag(par->net, par->family);\r\nif (err)\r\nreturn err;\r\nif (info->flags & ~XT_SOCKET_FLAGS_V2) {\r\npr_info("unknown flags 0x%x\n", info->flags & ~XT_SOCKET_FLAGS_V2);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int socket_mt_v3_check(const struct xt_mtchk_param *par)\r\n{\r\nconst struct xt_socket_mtinfo3 *info =\r\n(struct xt_socket_mtinfo3 *)par->matchinfo;\r\nint err;\r\nerr = socket_mt_enable_defrag(par->net, par->family);\r\nif (err)\r\nreturn err;\r\nif (info->flags & ~XT_SOCKET_FLAGS_V3) {\r\npr_info("unknown flags 0x%x\n",\r\ninfo->flags & ~XT_SOCKET_FLAGS_V3);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init socket_mt_init(void)\r\n{\r\nreturn xt_register_matches(socket_mt_reg, ARRAY_SIZE(socket_mt_reg));\r\n}\r\nstatic void __exit socket_mt_exit(void)\r\n{\r\nxt_unregister_matches(socket_mt_reg, ARRAY_SIZE(socket_mt_reg));\r\n}

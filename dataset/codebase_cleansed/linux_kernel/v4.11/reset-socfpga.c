static int socfpga_reset_assert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct socfpga_reset_data *data = container_of(rcdev,\r\nstruct socfpga_reset_data,\r\nrcdev);\r\nint bank = id / BITS_PER_LONG;\r\nint offset = id % BITS_PER_LONG;\r\nunsigned long flags;\r\nu32 reg;\r\nspin_lock_irqsave(&data->lock, flags);\r\nreg = readl(data->membase + (bank * NR_BANKS));\r\nwritel(reg | BIT(offset), data->membase + (bank * NR_BANKS));\r\nspin_unlock_irqrestore(&data->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int socfpga_reset_deassert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct socfpga_reset_data *data = container_of(rcdev,\r\nstruct socfpga_reset_data,\r\nrcdev);\r\nint bank = id / BITS_PER_LONG;\r\nint offset = id % BITS_PER_LONG;\r\nunsigned long flags;\r\nu32 reg;\r\nspin_lock_irqsave(&data->lock, flags);\r\nreg = readl(data->membase + (bank * NR_BANKS));\r\nwritel(reg & ~BIT(offset), data->membase + (bank * NR_BANKS));\r\nspin_unlock_irqrestore(&data->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int socfpga_reset_status(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct socfpga_reset_data *data = container_of(rcdev,\r\nstruct socfpga_reset_data, rcdev);\r\nint bank = id / BITS_PER_LONG;\r\nint offset = id % BITS_PER_LONG;\r\nu32 reg;\r\nreg = readl(data->membase + (bank * NR_BANKS));\r\nreturn !(reg & BIT(offset));\r\n}\r\nstatic int socfpga_reset_probe(struct platform_device *pdev)\r\n{\r\nstruct socfpga_reset_data *data;\r\nstruct resource *res;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nu32 modrst_offset;\r\nif (!of_find_property(pdev->dev.of_node, "#reset-cells", NULL)) {\r\ndev_err(&pdev->dev, "%s missing #reset-cells property\n",\r\npdev->dev.of_node->full_name);\r\nreturn -EINVAL;\r\n}\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndata->membase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(data->membase))\r\nreturn PTR_ERR(data->membase);\r\nif (of_property_read_u32(np, "altr,modrst-offset", &modrst_offset)) {\r\ndev_warn(dev, "missing altr,modrst-offset property, assuming 0x10!\n");\r\nmodrst_offset = 0x10;\r\n}\r\ndata->membase += modrst_offset;\r\nspin_lock_init(&data->lock);\r\ndata->rcdev.owner = THIS_MODULE;\r\ndata->rcdev.nr_resets = NR_BANKS * BITS_PER_LONG;\r\ndata->rcdev.ops = &socfpga_reset_ops;\r\ndata->rcdev.of_node = pdev->dev.of_node;\r\nreturn devm_reset_controller_register(dev, &data->rcdev);\r\n}

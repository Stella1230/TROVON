void perf_hooks__invoke(const struct perf_hook_desc *desc)\r\n{\r\nif (!(desc && desc->p_hook_func && *desc->p_hook_func))\r\nreturn;\r\nif (sigsetjmp(jmpbuf, 1)) {\r\npr_warning("Fatal error (SEGFAULT) in perf hook '%s'\n",\r\ndesc->hook_name);\r\n*(current_perf_hook->p_hook_func) = NULL;\r\n} else {\r\ncurrent_perf_hook = desc;\r\n(**desc->p_hook_func)(desc->hook_ctx);\r\n}\r\ncurrent_perf_hook = NULL;\r\n}\r\nvoid perf_hooks__recover(void)\r\n{\r\nif (current_perf_hook)\r\nsiglongjmp(jmpbuf, 1);\r\n}\r\nint perf_hooks__set_hook(const char *hook_name,\r\nperf_hook_func_t hook_func,\r\nvoid *hook_ctx)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(perf_hooks); i++) {\r\nif (strcmp(hook_name, perf_hooks[i]->hook_name) != 0)\r\ncontinue;\r\nif (*(perf_hooks[i]->p_hook_func))\r\npr_warning("Overwrite existing hook: %s\n", hook_name);\r\n*(perf_hooks[i]->p_hook_func) = hook_func;\r\nperf_hooks[i]->hook_ctx = hook_ctx;\r\nreturn 0;\r\n}\r\nreturn -ENOENT;\r\n}\r\nperf_hook_func_t perf_hooks__get_hook(const char *hook_name)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(perf_hooks); i++) {\r\nif (strcmp(hook_name, perf_hooks[i]->hook_name) != 0)\r\ncontinue;\r\nreturn *(perf_hooks[i]->p_hook_func);\r\n}\r\nreturn ERR_PTR(-ENOENT);\r\n}

int __hash_page_4K(unsigned long ea, unsigned long access, unsigned long vsid,\r\npte_t *ptep, unsigned long trap, unsigned long flags,\r\nint ssize, int subpg_prot)\r\n{\r\nunsigned long hpte_group;\r\nunsigned long rflags, pa;\r\nunsigned long old_pte, new_pte;\r\nunsigned long vpn, hash, slot;\r\nunsigned long shift = mmu_psize_defs[MMU_PAGE_4K].shift;\r\ndo {\r\npte_t pte = READ_ONCE(*ptep);\r\nold_pte = pte_val(pte);\r\nif (unlikely(old_pte & H_PAGE_BUSY))\r\nreturn 0;\r\nif (unlikely(!check_pte_access(access, old_pte)))\r\nreturn 1;\r\nnew_pte = old_pte | H_PAGE_BUSY | _PAGE_ACCESSED;\r\nif (access & _PAGE_WRITE)\r\nnew_pte |= _PAGE_DIRTY;\r\n} while (!pte_xchg(ptep, __pte(old_pte), __pte(new_pte)));\r\nrflags = htab_convert_pte_flags(new_pte);\r\nif (cpu_has_feature(CPU_FTR_NOEXECUTE) &&\r\n!cpu_has_feature(CPU_FTR_COHERENT_ICACHE))\r\nrflags = hash_page_do_lazy_icache(rflags, __pte(old_pte), trap);\r\nvpn = hpt_vpn(ea, vsid, ssize);\r\nif (unlikely(old_pte & H_PAGE_HASHPTE)) {\r\nhash = hpt_hash(vpn, shift, ssize);\r\nif (old_pte & H_PAGE_F_SECOND)\r\nhash = ~hash;\r\nslot = (hash & htab_hash_mask) * HPTES_PER_GROUP;\r\nslot += (old_pte & H_PAGE_F_GIX) >> H_PAGE_F_GIX_SHIFT;\r\nif (mmu_hash_ops.hpte_updatepp(slot, rflags, vpn, MMU_PAGE_4K,\r\nMMU_PAGE_4K, ssize, flags) == -1)\r\nold_pte &= ~_PAGE_HPTEFLAGS;\r\n}\r\nif (likely(!(old_pte & H_PAGE_HASHPTE))) {\r\npa = pte_pfn(__pte(old_pte)) << PAGE_SHIFT;\r\nhash = hpt_hash(vpn, shift, ssize);\r\nrepeat:\r\nhpte_group = ((hash & htab_hash_mask) * HPTES_PER_GROUP) & ~0x7UL;\r\nslot = mmu_hash_ops.hpte_insert(hpte_group, vpn, pa, rflags, 0,\r\nMMU_PAGE_4K, MMU_PAGE_4K, ssize);\r\nif (unlikely(slot == -1)) {\r\nhpte_group = ((~hash & htab_hash_mask) * HPTES_PER_GROUP) & ~0x7UL;\r\nslot = mmu_hash_ops.hpte_insert(hpte_group, vpn, pa,\r\nrflags,\r\nHPTE_V_SECONDARY,\r\nMMU_PAGE_4K,\r\nMMU_PAGE_4K, ssize);\r\nif (slot == -1) {\r\nif (mftb() & 0x1)\r\nhpte_group = ((hash & htab_hash_mask) *\r\nHPTES_PER_GROUP) & ~0x7UL;\r\nmmu_hash_ops.hpte_remove(hpte_group);\r\ngoto repeat;\r\n}\r\n}\r\nif (unlikely(slot == -2)) {\r\n*ptep = __pte(old_pte);\r\nhash_failure_debug(ea, access, vsid, trap, ssize,\r\nMMU_PAGE_4K, MMU_PAGE_4K, old_pte);\r\nreturn -1;\r\n}\r\nnew_pte = (new_pte & ~_PAGE_HPTEFLAGS) | H_PAGE_HASHPTE;\r\nnew_pte |= (slot << H_PAGE_F_GIX_SHIFT) &\r\n(H_PAGE_F_SECOND | H_PAGE_F_GIX);\r\n}\r\n*ptep = __pte(new_pte & ~H_PAGE_BUSY);\r\nreturn 0;\r\n}

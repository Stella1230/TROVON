static inline u32 mlx_to_net_policy(enum port_state_policy mlx_policy)\r\n{\r\nswitch (mlx_policy) {\r\ncase MLX5_POLICY_DOWN:\r\nreturn IFLA_VF_LINK_STATE_DISABLE;\r\ncase MLX5_POLICY_UP:\r\nreturn IFLA_VF_LINK_STATE_ENABLE;\r\ncase MLX5_POLICY_FOLLOW:\r\nreturn IFLA_VF_LINK_STATE_AUTO;\r\ndefault:\r\nreturn __IFLA_VF_LINK_STATE_MAX;\r\n}\r\n}\r\nint mlx5_ib_get_vf_config(struct ib_device *device, int vf, u8 port,\r\nstruct ifla_vf_info *info)\r\n{\r\nstruct mlx5_ib_dev *dev = to_mdev(device);\r\nstruct mlx5_core_dev *mdev = dev->mdev;\r\nstruct mlx5_hca_vport_context *rep;\r\nint err;\r\nrep = kzalloc(sizeof(*rep), GFP_KERNEL);\r\nif (!rep)\r\nreturn -ENOMEM;\r\nerr = mlx5_query_hca_vport_context(mdev, 1, 1, vf + 1, rep);\r\nif (err) {\r\nmlx5_ib_warn(dev, "failed to query port policy for vf %d (%d)\n",\r\nvf, err);\r\ngoto free;\r\n}\r\nmemset(info, 0, sizeof(*info));\r\ninfo->linkstate = mlx_to_net_policy(rep->policy);\r\nif (info->linkstate == __IFLA_VF_LINK_STATE_MAX)\r\nerr = -EINVAL;\r\nfree:\r\nkfree(rep);\r\nreturn err;\r\n}\r\nstatic inline enum port_state_policy net_to_mlx_policy(int policy)\r\n{\r\nswitch (policy) {\r\ncase IFLA_VF_LINK_STATE_DISABLE:\r\nreturn MLX5_POLICY_DOWN;\r\ncase IFLA_VF_LINK_STATE_ENABLE:\r\nreturn MLX5_POLICY_UP;\r\ncase IFLA_VF_LINK_STATE_AUTO:\r\nreturn MLX5_POLICY_FOLLOW;\r\ndefault:\r\nreturn MLX5_POLICY_INVALID;\r\n}\r\n}\r\nint mlx5_ib_set_vf_link_state(struct ib_device *device, int vf,\r\nu8 port, int state)\r\n{\r\nstruct mlx5_ib_dev *dev = to_mdev(device);\r\nstruct mlx5_core_dev *mdev = dev->mdev;\r\nstruct mlx5_hca_vport_context *in;\r\nint err;\r\nin = kzalloc(sizeof(*in), GFP_KERNEL);\r\nif (!in)\r\nreturn -ENOMEM;\r\nin->policy = net_to_mlx_policy(state);\r\nif (in->policy == MLX5_POLICY_INVALID) {\r\nerr = -EINVAL;\r\ngoto out;\r\n}\r\nin->field_select = MLX5_HCA_VPORT_SEL_STATE_POLICY;\r\nerr = mlx5_core_modify_hca_vport_context(mdev, 1, 1, vf + 1, in);\r\nout:\r\nkfree(in);\r\nreturn err;\r\n}\r\nint mlx5_ib_get_vf_stats(struct ib_device *device, int vf,\r\nu8 port, struct ifla_vf_stats *stats)\r\n{\r\nint out_sz = MLX5_ST_SZ_BYTES(query_vport_counter_out);\r\nstruct mlx5_core_dev *mdev;\r\nstruct mlx5_ib_dev *dev;\r\nvoid *out;\r\nint err;\r\ndev = to_mdev(device);\r\nmdev = dev->mdev;\r\nout = kzalloc(out_sz, GFP_KERNEL);\r\nif (!out)\r\nreturn -ENOMEM;\r\nerr = mlx5_core_query_vport_counter(mdev, true, vf, port, out, out_sz);\r\nif (err)\r\ngoto ex;\r\nstats->rx_packets = MLX5_GET64_PR(query_vport_counter_out, out, received_ib_unicast.packets);\r\nstats->tx_packets = MLX5_GET64_PR(query_vport_counter_out, out, transmitted_ib_unicast.packets);\r\nstats->rx_bytes = MLX5_GET64_PR(query_vport_counter_out, out, received_ib_unicast.octets);\r\nstats->tx_bytes = MLX5_GET64_PR(query_vport_counter_out, out, transmitted_ib_unicast.octets);\r\nstats->multicast = MLX5_GET64_PR(query_vport_counter_out, out, received_ib_multicast.packets);\r\nex:\r\nkfree(out);\r\nreturn err;\r\n}\r\nstatic int set_vf_node_guid(struct ib_device *device, int vf, u8 port, u64 guid)\r\n{\r\nstruct mlx5_ib_dev *dev = to_mdev(device);\r\nstruct mlx5_core_dev *mdev = dev->mdev;\r\nstruct mlx5_hca_vport_context *in;\r\nint err;\r\nin = kzalloc(sizeof(*in), GFP_KERNEL);\r\nif (!in)\r\nreturn -ENOMEM;\r\nin->field_select = MLX5_HCA_VPORT_SEL_NODE_GUID;\r\nin->node_guid = guid;\r\nerr = mlx5_core_modify_hca_vport_context(mdev, 1, 1, vf + 1, in);\r\nkfree(in);\r\nreturn err;\r\n}\r\nstatic int set_vf_port_guid(struct ib_device *device, int vf, u8 port, u64 guid)\r\n{\r\nstruct mlx5_ib_dev *dev = to_mdev(device);\r\nstruct mlx5_core_dev *mdev = dev->mdev;\r\nstruct mlx5_hca_vport_context *in;\r\nint err;\r\nin = kzalloc(sizeof(*in), GFP_KERNEL);\r\nif (!in)\r\nreturn -ENOMEM;\r\nin->field_select = MLX5_HCA_VPORT_SEL_PORT_GUID;\r\nin->port_guid = guid;\r\nerr = mlx5_core_modify_hca_vport_context(mdev, 1, 1, vf + 1, in);\r\nkfree(in);\r\nreturn err;\r\n}\r\nint mlx5_ib_set_vf_guid(struct ib_device *device, int vf, u8 port,\r\nu64 guid, int type)\r\n{\r\nif (type == IFLA_VF_IB_NODE_GUID)\r\nreturn set_vf_node_guid(device, vf, port, guid);\r\nelse if (type == IFLA_VF_IB_PORT_GUID)\r\nreturn set_vf_port_guid(device, vf, port, guid);\r\nreturn -EINVAL;\r\n}

static int berlin2_adc_read(struct iio_dev *indio_dev, int channel)\r\n{\r\nstruct berlin2_adc_priv *priv = iio_priv(indio_dev);\r\nint data, ret;\r\nmutex_lock(&priv->lock);\r\nregmap_write(priv->regmap, BERLIN2_SM_ADC_STATUS,\r\nBERLIN2_SM_ADC_STATUS_INT_EN(channel));\r\nregmap_update_bits(priv->regmap, BERLIN2_SM_CTRL,\r\nBERLIN2_SM_CTRL_ADC_RESET |\r\nBERLIN2_SM_CTRL_ADC_SEL_MASK |\r\nBERLIN2_SM_CTRL_ADC_START,\r\nBERLIN2_SM_CTRL_ADC_SEL(channel) |\r\nBERLIN2_SM_CTRL_ADC_START);\r\nret = wait_event_interruptible_timeout(priv->wq, priv->data_available,\r\nmsecs_to_jiffies(1000));\r\nregmap_update_bits(priv->regmap, BERLIN2_SM_ADC_STATUS,\r\nBERLIN2_SM_ADC_STATUS_INT_EN(channel), 0);\r\nif (ret == 0)\r\nret = -ETIMEDOUT;\r\nif (ret < 0) {\r\nmutex_unlock(&priv->lock);\r\nreturn ret;\r\n}\r\nregmap_update_bits(priv->regmap, BERLIN2_SM_CTRL,\r\nBERLIN2_SM_CTRL_ADC_START, 0);\r\ndata = priv->data;\r\npriv->data_available = false;\r\nmutex_unlock(&priv->lock);\r\nreturn data;\r\n}\r\nstatic int berlin2_adc_tsen_read(struct iio_dev *indio_dev)\r\n{\r\nstruct berlin2_adc_priv *priv = iio_priv(indio_dev);\r\nint data, ret;\r\nmutex_lock(&priv->lock);\r\nregmap_write(priv->regmap, BERLIN2_SM_TSEN_STATUS,\r\nBERLIN2_SM_TSEN_STATUS_INT_EN);\r\nregmap_update_bits(priv->regmap, BERLIN2_SM_CTRL,\r\nBERLIN2_SM_CTRL_TSEN_RESET |\r\nBERLIN2_SM_CTRL_ADC_ROTATE,\r\nBERLIN2_SM_CTRL_ADC_ROTATE);\r\nregmap_update_bits(priv->regmap, BERLIN2_SM_TSEN_CTRL,\r\nBERLIN2_SM_TSEN_CTRL_TRIM_MASK |\r\nBERLIN2_SM_TSEN_CTRL_SETTLING_MASK |\r\nBERLIN2_SM_TSEN_CTRL_START,\r\nBERLIN2_SM_TSEN_CTRL_TRIM(3) |\r\nBERLIN2_SM_TSEN_CTRL_SETTLING_12 |\r\nBERLIN2_SM_TSEN_CTRL_START);\r\nret = wait_event_interruptible_timeout(priv->wq, priv->data_available,\r\nmsecs_to_jiffies(1000));\r\nregmap_update_bits(priv->regmap, BERLIN2_SM_TSEN_STATUS,\r\nBERLIN2_SM_TSEN_STATUS_INT_EN, 0);\r\nif (ret == 0)\r\nret = -ETIMEDOUT;\r\nif (ret < 0) {\r\nmutex_unlock(&priv->lock);\r\nreturn ret;\r\n}\r\nregmap_update_bits(priv->regmap, BERLIN2_SM_TSEN_CTRL,\r\nBERLIN2_SM_TSEN_CTRL_START, 0);\r\ndata = priv->data;\r\npriv->data_available = false;\r\nmutex_unlock(&priv->lock);\r\nreturn data;\r\n}\r\nstatic int berlin2_adc_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan, int *val,\r\nint *val2, long mask)\r\n{\r\nint temp;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nif (chan->type != IIO_VOLTAGE)\r\nreturn -EINVAL;\r\n*val = berlin2_adc_read(indio_dev, chan->channel);\r\nif (*val < 0)\r\nreturn *val;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_PROCESSED:\r\nif (chan->type != IIO_TEMP)\r\nreturn -EINVAL;\r\ntemp = berlin2_adc_tsen_read(indio_dev);\r\nif (temp < 0)\r\nreturn temp;\r\nif (temp > 2047)\r\ntemp -= 4096;\r\n*val = ((temp * 100000) / 264 - 270000);\r\nreturn IIO_VAL_INT;\r\ndefault:\r\nbreak;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic irqreturn_t berlin2_adc_irq(int irq, void *private)\r\n{\r\nstruct berlin2_adc_priv *priv = iio_priv(private);\r\nunsigned val;\r\nregmap_read(priv->regmap, BERLIN2_SM_ADC_STATUS, &val);\r\nif (val & BERLIN2_SM_ADC_STATUS_DATA_RDY_MASK) {\r\nregmap_read(priv->regmap, BERLIN2_SM_ADC_DATA, &priv->data);\r\npriv->data &= BERLIN2_SM_ADC_MASK;\r\nval &= ~BERLIN2_SM_ADC_STATUS_DATA_RDY_MASK;\r\nregmap_write(priv->regmap, BERLIN2_SM_ADC_STATUS, val);\r\npriv->data_available = true;\r\nwake_up_interruptible(&priv->wq);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t berlin2_adc_tsen_irq(int irq, void *private)\r\n{\r\nstruct berlin2_adc_priv *priv = iio_priv(private);\r\nunsigned val;\r\nregmap_read(priv->regmap, BERLIN2_SM_TSEN_STATUS, &val);\r\nif (val & BERLIN2_SM_TSEN_STATUS_DATA_RDY) {\r\nregmap_read(priv->regmap, BERLIN2_SM_TSEN_DATA, &priv->data);\r\npriv->data &= BERLIN2_SM_TSEN_MASK;\r\nval &= ~BERLIN2_SM_TSEN_STATUS_DATA_RDY;\r\nregmap_write(priv->regmap, BERLIN2_SM_TSEN_STATUS, val);\r\npriv->data_available = true;\r\nwake_up_interruptible(&priv->wq);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int berlin2_adc_probe(struct platform_device *pdev)\r\n{\r\nstruct iio_dev *indio_dev;\r\nstruct berlin2_adc_priv *priv;\r\nstruct device_node *parent_np = of_get_parent(pdev->dev.of_node);\r\nint irq, tsen_irq;\r\nint ret;\r\nindio_dev = devm_iio_device_alloc(&pdev->dev, sizeof(*priv));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\npriv = iio_priv(indio_dev);\r\nplatform_set_drvdata(pdev, indio_dev);\r\npriv->regmap = syscon_node_to_regmap(parent_np);\r\nof_node_put(parent_np);\r\nif (IS_ERR(priv->regmap))\r\nreturn PTR_ERR(priv->regmap);\r\nirq = platform_get_irq_byname(pdev, "adc");\r\nif (irq < 0)\r\nreturn irq;\r\ntsen_irq = platform_get_irq_byname(pdev, "tsen");\r\nif (tsen_irq < 0)\r\nreturn tsen_irq;\r\nret = devm_request_irq(&pdev->dev, irq, berlin2_adc_irq, 0,\r\npdev->dev.driver->name, indio_dev);\r\nif (ret)\r\nreturn ret;\r\nret = devm_request_irq(&pdev->dev, tsen_irq, berlin2_adc_tsen_irq,\r\n0, pdev->dev.driver->name, indio_dev);\r\nif (ret)\r\nreturn ret;\r\ninit_waitqueue_head(&priv->wq);\r\nmutex_init(&priv->lock);\r\nindio_dev->dev.parent = &pdev->dev;\r\nindio_dev->name = dev_name(&pdev->dev);\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->info = &berlin2_adc_info;\r\nindio_dev->channels = berlin2_adc_channels;\r\nindio_dev->num_channels = ARRAY_SIZE(berlin2_adc_channels);\r\nregmap_update_bits(priv->regmap, BERLIN2_SM_CTRL,\r\nBERLIN2_SM_CTRL_ADC_POWER,\r\nBERLIN2_SM_CTRL_ADC_POWER);\r\nret = iio_device_register(indio_dev);\r\nif (ret) {\r\nregmap_update_bits(priv->regmap, BERLIN2_SM_CTRL,\r\nBERLIN2_SM_CTRL_ADC_POWER, 0);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int berlin2_adc_remove(struct platform_device *pdev)\r\n{\r\nstruct iio_dev *indio_dev = platform_get_drvdata(pdev);\r\nstruct berlin2_adc_priv *priv = iio_priv(indio_dev);\r\niio_device_unregister(indio_dev);\r\nregmap_update_bits(priv->regmap, BERLIN2_SM_CTRL,\r\nBERLIN2_SM_CTRL_ADC_POWER, 0);\r\nreturn 0;\r\n}

static void nps400_irq_mask(struct irq_data *irqd)\r\n{\r\nunsigned int ienb;\r\nunsigned int irq = irqd_to_hwirq(irqd);\r\nienb = read_aux_reg(AUX_IENABLE);\r\nienb &= ~(1 << irq);\r\nwrite_aux_reg(AUX_IENABLE, ienb);\r\n}\r\nstatic void nps400_irq_unmask(struct irq_data *irqd)\r\n{\r\nunsigned int ienb;\r\nunsigned int irq = irqd_to_hwirq(irqd);\r\nienb = read_aux_reg(AUX_IENABLE);\r\nienb |= (1 << irq);\r\nwrite_aux_reg(AUX_IENABLE, ienb);\r\n}\r\nstatic void nps400_irq_eoi_global(struct irq_data *irqd)\r\n{\r\nunsigned int __maybe_unused irq = irqd_to_hwirq(irqd);\r\nwrite_aux_reg(CTOP_AUX_IACK, 1 << irq);\r\nmb();\r\nnps_ack_gic();\r\n}\r\nstatic void nps400_irq_ack(struct irq_data *irqd)\r\n{\r\nunsigned int __maybe_unused irq = irqd_to_hwirq(irqd);\r\nwrite_aux_reg(CTOP_AUX_IACK, 1 << irq);\r\n}\r\nstatic int nps400_irq_map(struct irq_domain *d, unsigned int virq,\r\nirq_hw_number_t hw)\r\n{\r\nswitch (hw) {\r\ncase NPS_TIMER0_IRQ:\r\n#ifdef CONFIG_SMP\r\ncase NPS_IPI_IRQ:\r\n#endif\r\nirq_set_percpu_devid(virq);\r\nirq_set_chip_and_handler(virq, &nps400_irq_chip_percpu,\r\nhandle_percpu_devid_irq);\r\nbreak;\r\ndefault:\r\nirq_set_chip_and_handler(virq, &nps400_irq_chip_fasteoi,\r\nhandle_fasteoi_irq);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init nps400_of_init(struct device_node *node,\r\nstruct device_node *parent)\r\n{\r\nstruct irq_domain *nps400_root_domain;\r\nif (parent) {\r\npr_err("DeviceTree incore ic not a root irq controller\n");\r\nreturn -EINVAL;\r\n}\r\nnps400_root_domain = irq_domain_add_linear(node, NPS_NR_CPU_IRQS,\r\n&nps400_irq_ops, NULL);\r\nif (!nps400_root_domain) {\r\npr_err("nps400 root irq domain not avail\n");\r\nreturn -ENOMEM;\r\n}\r\nirq_set_default_host(nps400_root_domain);\r\n#ifdef CONFIG_SMP\r\nirq_create_mapping(nps400_root_domain, NPS_IPI_IRQ);\r\n#endif\r\nreturn 0;\r\n}

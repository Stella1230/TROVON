static bool pcm179x_accessible_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn reg >= 0x10 && reg <= 0x17;\r\n}\r\nstatic bool pcm179x_writeable_reg(struct device *dev, unsigned int reg)\r\n{\r\nbool accessible;\r\naccessible = pcm179x_accessible_reg(dev, reg);\r\nreturn accessible && reg != 0x16 && reg != 0x17;\r\n}\r\nstatic int pcm179x_set_dai_fmt(struct snd_soc_dai *codec_dai,\r\nunsigned int format)\r\n{\r\nstruct snd_soc_codec *codec = codec_dai->codec;\r\nstruct pcm179x_private *priv = snd_soc_codec_get_drvdata(codec);\r\npriv->format = format;\r\nreturn 0;\r\n}\r\nstatic int pcm179x_digital_mute(struct snd_soc_dai *dai, int mute)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct pcm179x_private *priv = snd_soc_codec_get_drvdata(codec);\r\nint ret;\r\nret = regmap_update_bits(priv->regmap, PCM179X_SOFT_MUTE,\r\nPCM179X_MUTE_MASK, !!mute);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int pcm179x_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct pcm179x_private *priv = snd_soc_codec_get_drvdata(codec);\r\nint val = 0, ret;\r\npriv->rate = params_rate(params);\r\nswitch (priv->format & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_RIGHT_J:\r\nswitch (params_width(params)) {\r\ncase 24:\r\ncase 32:\r\nval = 2;\r\nbreak;\r\ncase 16:\r\nval = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase SND_SOC_DAIFMT_I2S:\r\nswitch (params_width(params)) {\r\ncase 24:\r\ncase 32:\r\nval = 5;\r\nbreak;\r\ncase 16:\r\nval = 4;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Invalid DAI format\n");\r\nreturn -EINVAL;\r\n}\r\nval = val << PCM179X_FMT_SHIFT | PCM179X_ATLD_ENABLE;\r\nret = regmap_update_bits(priv->regmap, PCM179X_FMT_CONTROL,\r\nPCM179X_FMT_MASK | PCM179X_ATLD_ENABLE, val);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint pcm179x_common_init(struct device *dev, struct regmap *regmap)\r\n{\r\nstruct pcm179x_private *pcm179x;\r\npcm179x = devm_kzalloc(dev, sizeof(struct pcm179x_private),\r\nGFP_KERNEL);\r\nif (!pcm179x)\r\nreturn -ENOMEM;\r\npcm179x->regmap = regmap;\r\ndev_set_drvdata(dev, pcm179x);\r\nreturn snd_soc_register_codec(dev,\r\n&soc_codec_dev_pcm179x, &pcm179x_dai, 1);\r\n}\r\nint pcm179x_common_exit(struct device *dev)\r\n{\r\nsnd_soc_unregister_codec(dev);\r\nreturn 0;\r\n}

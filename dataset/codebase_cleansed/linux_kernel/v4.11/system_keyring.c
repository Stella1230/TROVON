int restrict_link_by_builtin_trusted(struct key *keyring,\r\nconst struct key_type *type,\r\nconst union key_payload *payload)\r\n{\r\nreturn restrict_link_by_signature(builtin_trusted_keys, type, payload);\r\n}\r\nint restrict_link_by_builtin_and_secondary_trusted(\r\nstruct key *keyring,\r\nconst struct key_type *type,\r\nconst union key_payload *payload)\r\n{\r\nif (type == &key_type_keyring &&\r\nkeyring == secondary_trusted_keys &&\r\npayload == &builtin_trusted_keys->payload)\r\nreturn 0;\r\nreturn restrict_link_by_signature(secondary_trusted_keys, type, payload);\r\n}\r\nstatic __init int system_trusted_keyring_init(void)\r\n{\r\npr_notice("Initialise system trusted keyrings\n");\r\nbuiltin_trusted_keys =\r\nkeyring_alloc(".builtin_trusted_keys",\r\nKUIDT_INIT(0), KGIDT_INIT(0), current_cred(),\r\n((KEY_POS_ALL & ~KEY_POS_SETATTR) |\r\nKEY_USR_VIEW | KEY_USR_READ | KEY_USR_SEARCH),\r\nKEY_ALLOC_NOT_IN_QUOTA,\r\nNULL, NULL);\r\nif (IS_ERR(builtin_trusted_keys))\r\npanic("Can't allocate builtin trusted keyring\n");\r\n#ifdef CONFIG_SECONDARY_TRUSTED_KEYRING\r\nsecondary_trusted_keys =\r\nkeyring_alloc(".secondary_trusted_keys",\r\nKUIDT_INIT(0), KGIDT_INIT(0), current_cred(),\r\n((KEY_POS_ALL & ~KEY_POS_SETATTR) |\r\nKEY_USR_VIEW | KEY_USR_READ | KEY_USR_SEARCH |\r\nKEY_USR_WRITE),\r\nKEY_ALLOC_NOT_IN_QUOTA,\r\nrestrict_link_by_builtin_and_secondary_trusted,\r\nNULL);\r\nif (IS_ERR(secondary_trusted_keys))\r\npanic("Can't allocate secondary trusted keyring\n");\r\nif (key_link(secondary_trusted_keys, builtin_trusted_keys) < 0)\r\npanic("Can't link trusted keyrings\n");\r\n#endif\r\nreturn 0;\r\n}\r\nstatic __init int load_system_certificate_list(void)\r\n{\r\nkey_ref_t key;\r\nconst u8 *p, *end;\r\nsize_t plen;\r\npr_notice("Loading compiled-in X.509 certificates\n");\r\np = system_certificate_list;\r\nend = p + system_certificate_list_size;\r\nwhile (p < end) {\r\nif (end - p < 4)\r\ngoto dodgy_cert;\r\nif (p[0] != 0x30 &&\r\np[1] != 0x82)\r\ngoto dodgy_cert;\r\nplen = (p[2] << 8) | p[3];\r\nplen += 4;\r\nif (plen > end - p)\r\ngoto dodgy_cert;\r\nkey = key_create_or_update(make_key_ref(builtin_trusted_keys, 1),\r\n"asymmetric",\r\nNULL,\r\np,\r\nplen,\r\n((KEY_POS_ALL & ~KEY_POS_SETATTR) |\r\nKEY_USR_VIEW | KEY_USR_READ),\r\nKEY_ALLOC_NOT_IN_QUOTA |\r\nKEY_ALLOC_BUILT_IN |\r\nKEY_ALLOC_BYPASS_RESTRICTION);\r\nif (IS_ERR(key)) {\r\npr_err("Problem loading in-kernel X.509 certificate (%ld)\n",\r\nPTR_ERR(key));\r\n} else {\r\npr_notice("Loaded X.509 cert '%s'\n",\r\nkey_ref_to_ptr(key)->description);\r\nkey_ref_put(key);\r\n}\r\np += plen;\r\n}\r\nreturn 0;\r\ndodgy_cert:\r\npr_err("Problem parsing in-kernel X.509 certificate list\n");\r\nreturn 0;\r\n}\r\nint verify_pkcs7_signature(const void *data, size_t len,\r\nconst void *raw_pkcs7, size_t pkcs7_len,\r\nstruct key *trusted_keys,\r\nenum key_being_used_for usage,\r\nint (*view_content)(void *ctx,\r\nconst void *data, size_t len,\r\nsize_t asn1hdrlen),\r\nvoid *ctx)\r\n{\r\nstruct pkcs7_message *pkcs7;\r\nint ret;\r\npkcs7 = pkcs7_parse_message(raw_pkcs7, pkcs7_len);\r\nif (IS_ERR(pkcs7))\r\nreturn PTR_ERR(pkcs7);\r\nif (data && pkcs7_supply_detached_data(pkcs7, data, len) < 0) {\r\npr_err("PKCS#7 signature with non-detached data\n");\r\nret = -EBADMSG;\r\ngoto error;\r\n}\r\nret = pkcs7_verify(pkcs7, usage);\r\nif (ret < 0)\r\ngoto error;\r\nif (!trusted_keys) {\r\ntrusted_keys = builtin_trusted_keys;\r\n} else if (trusted_keys == (void *)1UL) {\r\n#ifdef CONFIG_SECONDARY_TRUSTED_KEYRING\r\ntrusted_keys = secondary_trusted_keys;\r\n#else\r\ntrusted_keys = builtin_trusted_keys;\r\n#endif\r\n}\r\nret = pkcs7_validate_trust(pkcs7, trusted_keys);\r\nif (ret < 0) {\r\nif (ret == -ENOKEY)\r\npr_err("PKCS#7 signature not signed with a trusted key\n");\r\ngoto error;\r\n}\r\nif (view_content) {\r\nsize_t asn1hdrlen;\r\nret = pkcs7_get_content_data(pkcs7, &data, &len, &asn1hdrlen);\r\nif (ret < 0) {\r\nif (ret == -ENODATA)\r\npr_devel("PKCS#7 message does not contain data\n");\r\ngoto error;\r\n}\r\nret = view_content(ctx, data, len, asn1hdrlen);\r\n}\r\nerror:\r\npkcs7_free_message(pkcs7);\r\npr_devel("<==%s() = %d\n", __func__, ret);\r\nreturn ret;\r\n}

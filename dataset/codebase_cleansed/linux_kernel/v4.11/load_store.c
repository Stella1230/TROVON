int FPU_load_store(u_char type, fpu_addr_modes addr_modes,\r\nvoid __user * data_address)\r\n{\r\nFPU_REG loaded_data;\r\nFPU_REG *st0_ptr;\r\nu_char st0_tag = TAG_Empty;\r\nu_char loaded_tag;\r\nint sv_cw;\r\nst0_ptr = NULL;\r\nif (addr_modes.default_mode & PROTECTED) {\r\nif (addr_modes.default_mode == SEG32) {\r\nif (access_limit < data_sizes_32[type])\r\nmath_abort(FPU_info, SIGSEGV);\r\n} else if (addr_modes.default_mode == PM16) {\r\nif (access_limit < data_sizes_16[type])\r\nmath_abort(FPU_info, SIGSEGV);\r\n}\r\n#ifdef PARANOID\r\nelse\r\nEXCEPTION(EX_INTERNAL | 0x140);\r\n#endif\r\n}\r\nswitch (type_table[type]) {\r\ncase _NONE_:\r\nbreak;\r\ncase _REG0_:\r\nst0_ptr = &st(0);\r\nst0_tag = FPU_gettag0();\r\nbreak;\r\ncase _PUSH_:\r\n{\r\nif (FPU_gettagi(-1) != TAG_Empty) {\r\nFPU_stack_overflow();\r\nreturn 0;\r\n}\r\ntop--;\r\nst0_ptr = &st(0);\r\n}\r\nbreak;\r\ncase _null_:\r\nFPU_illegal();\r\nreturn 0;\r\n#ifdef PARANOID\r\ndefault:\r\nEXCEPTION(EX_INTERNAL | 0x141);\r\nreturn 0;\r\n#endif\r\n}\r\nswitch (type) {\r\ncase 000:\r\nclear_C1();\r\nloaded_tag =\r\nFPU_load_single((float __user *)data_address, &loaded_data);\r\nif ((loaded_tag == TAG_Special)\r\n&& isNaN(&loaded_data)\r\n&& (real_1op_NaN(&loaded_data) < 0)) {\r\ntop++;\r\nbreak;\r\n}\r\nFPU_copy_to_reg0(&loaded_data, loaded_tag);\r\nbreak;\r\ncase 001:\r\nclear_C1();\r\nloaded_tag =\r\nFPU_load_int32((long __user *)data_address, &loaded_data);\r\nFPU_copy_to_reg0(&loaded_data, loaded_tag);\r\nbreak;\r\ncase 002:\r\nclear_C1();\r\nloaded_tag =\r\nFPU_load_double((double __user *)data_address,\r\n&loaded_data);\r\nif ((loaded_tag == TAG_Special)\r\n&& isNaN(&loaded_data)\r\n&& (real_1op_NaN(&loaded_data) < 0)) {\r\ntop++;\r\nbreak;\r\n}\r\nFPU_copy_to_reg0(&loaded_data, loaded_tag);\r\nbreak;\r\ncase 003:\r\nclear_C1();\r\nloaded_tag =\r\nFPU_load_int16((short __user *)data_address, &loaded_data);\r\nFPU_copy_to_reg0(&loaded_data, loaded_tag);\r\nbreak;\r\ncase 005:\r\nclear_C1();\r\nsv_cw = control_word;\r\ncontrol_word |= RC_CHOP;\r\nif (FPU_store_int32\r\n(st0_ptr, st0_tag, (long __user *)data_address))\r\npop_0();\r\ncontrol_word = sv_cw;\r\nbreak;\r\ncase 006:\r\nclear_C1();\r\nsv_cw = control_word;\r\ncontrol_word |= RC_CHOP;\r\nif (FPU_store_int64\r\n(st0_ptr, st0_tag, (long long __user *)data_address))\r\npop_0();\r\ncontrol_word = sv_cw;\r\nbreak;\r\ncase 007:\r\nclear_C1();\r\nsv_cw = control_word;\r\ncontrol_word |= RC_CHOP;\r\nif (FPU_store_int16\r\n(st0_ptr, st0_tag, (short __user *)data_address))\r\npop_0();\r\ncontrol_word = sv_cw;\r\nbreak;\r\ncase 010:\r\nclear_C1();\r\nFPU_store_single(st0_ptr, st0_tag,\r\n(float __user *)data_address);\r\nbreak;\r\ncase 011:\r\nclear_C1();\r\nFPU_store_int32(st0_ptr, st0_tag, (long __user *)data_address);\r\nbreak;\r\ncase 012:\r\nclear_C1();\r\nFPU_store_double(st0_ptr, st0_tag,\r\n(double __user *)data_address);\r\nbreak;\r\ncase 013:\r\nclear_C1();\r\nFPU_store_int16(st0_ptr, st0_tag, (short __user *)data_address);\r\nbreak;\r\ncase 014:\r\nclear_C1();\r\nif (FPU_store_single\r\n(st0_ptr, st0_tag, (float __user *)data_address))\r\npop_0();\r\nbreak;\r\ncase 015:\r\nclear_C1();\r\nif (FPU_store_int32\r\n(st0_ptr, st0_tag, (long __user *)data_address))\r\npop_0();\r\nbreak;\r\ncase 016:\r\nclear_C1();\r\nif (FPU_store_double\r\n(st0_ptr, st0_tag, (double __user *)data_address))\r\npop_0();\r\nbreak;\r\ncase 017:\r\nclear_C1();\r\nif (FPU_store_int16\r\n(st0_ptr, st0_tag, (short __user *)data_address))\r\npop_0();\r\nbreak;\r\ncase 020:\r\nfldenv(addr_modes, (u_char __user *) data_address);\r\nreturn 1;\r\ncase 022:\r\nfrstor(addr_modes, (u_char __user *) data_address);\r\nreturn 1;\r\ncase 023:\r\nclear_C1();\r\nloaded_tag = FPU_load_bcd((u_char __user *) data_address);\r\nFPU_settag0(loaded_tag);\r\nbreak;\r\ncase 024:\r\nRE_ENTRANT_CHECK_OFF;\r\nFPU_access_ok(VERIFY_READ, data_address, 2);\r\nFPU_get_user(control_word,\r\n(unsigned short __user *)data_address);\r\nRE_ENTRANT_CHECK_ON;\r\nif (partial_status & ~control_word & CW_Exceptions)\r\npartial_status |= (SW_Summary | SW_Backward);\r\nelse\r\npartial_status &= ~(SW_Summary | SW_Backward);\r\n#ifdef PECULIAR_486\r\ncontrol_word |= 0x40;\r\n#endif\r\nreturn 1;\r\ncase 025:\r\nclear_C1();\r\nloaded_tag =\r\nFPU_load_extended((long double __user *)data_address, 0);\r\nFPU_settag0(loaded_tag);\r\nbreak;\r\ncase 027:\r\nclear_C1();\r\nloaded_tag = FPU_load_int64((long long __user *)data_address);\r\nif (loaded_tag == TAG_Error)\r\nreturn 0;\r\nFPU_settag0(loaded_tag);\r\nbreak;\r\ncase 030:\r\nfstenv(addr_modes, (u_char __user *) data_address);\r\nreturn 1;\r\ncase 032:\r\nfsave(addr_modes, (u_char __user *) data_address);\r\nreturn 1;\r\ncase 033:\r\nclear_C1();\r\nif (FPU_store_bcd\r\n(st0_ptr, st0_tag, (u_char __user *) data_address))\r\npop_0();\r\nbreak;\r\ncase 034:\r\nRE_ENTRANT_CHECK_OFF;\r\nFPU_access_ok(VERIFY_WRITE, data_address, 2);\r\nFPU_put_user(control_word,\r\n(unsigned short __user *)data_address);\r\nRE_ENTRANT_CHECK_ON;\r\nreturn 1;\r\ncase 035:\r\nclear_C1();\r\nif (FPU_store_extended\r\n(st0_ptr, st0_tag, (long double __user *)data_address))\r\npop_0();\r\nbreak;\r\ncase 036:\r\nRE_ENTRANT_CHECK_OFF;\r\nFPU_access_ok(VERIFY_WRITE, data_address, 2);\r\nFPU_put_user(status_word(),\r\n(unsigned short __user *)data_address);\r\nRE_ENTRANT_CHECK_ON;\r\nreturn 1;\r\ncase 037:\r\nclear_C1();\r\nif (FPU_store_int64\r\n(st0_ptr, st0_tag, (long long __user *)data_address))\r\npop_0();\r\nbreak;\r\n}\r\nreturn 0;\r\n}

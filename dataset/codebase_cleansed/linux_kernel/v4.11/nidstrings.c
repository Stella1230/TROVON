char *\r\nlibcfs_next_nidstring(void)\r\n{\r\nchar *str;\r\nunsigned long flags;\r\nspin_lock_irqsave(&libcfs_nidstring_lock, flags);\r\nstr = libcfs_nidstrings[libcfs_nidstring_idx++];\r\nif (libcfs_nidstring_idx == ARRAY_SIZE(libcfs_nidstrings))\r\nlibcfs_nidstring_idx = 0;\r\nspin_unlock_irqrestore(&libcfs_nidstring_lock, flags);\r\nreturn str;\r\n}\r\nstatic int\r\nparse_addrange(const struct cfs_lstr *src, struct nidrange *nidrange)\r\n{\r\nstruct addrrange *addrrange;\r\nif (src->ls_len == 1 && src->ls_str[0] == '*') {\r\nnidrange->nr_all = 1;\r\nreturn 0;\r\n}\r\nLIBCFS_ALLOC(addrrange, sizeof(struct addrrange));\r\nif (!addrrange)\r\nreturn -ENOMEM;\r\nlist_add_tail(&addrrange->ar_link, &nidrange->nr_addrranges);\r\nINIT_LIST_HEAD(&addrrange->ar_numaddr_ranges);\r\nreturn nidrange->nr_netstrfns->nf_parse_addrlist(src->ls_str,\r\nsrc->ls_len,\r\n&addrrange->ar_numaddr_ranges);\r\n}\r\nstatic struct nidrange *\r\nadd_nidrange(const struct cfs_lstr *src,\r\nstruct list_head *nidlist)\r\n{\r\nstruct netstrfns *nf;\r\nstruct nidrange *nr;\r\nint endlen;\r\nunsigned int netnum;\r\nif (src->ls_len >= LNET_NIDSTR_SIZE)\r\nreturn NULL;\r\nnf = libcfs_namenum2netstrfns(src->ls_str);\r\nif (!nf)\r\nreturn NULL;\r\nendlen = src->ls_len - strlen(nf->nf_name);\r\nif (!endlen)\r\nnetnum = 0;\r\nelse {\r\nif (!cfs_str2num_check(src->ls_str + strlen(nf->nf_name),\r\nendlen, &netnum, 0, MAX_NUMERIC_VALUE))\r\nreturn NULL;\r\n}\r\nlist_for_each_entry(nr, nidlist, nr_link) {\r\nif (nr->nr_netstrfns != nf)\r\ncontinue;\r\nif (nr->nr_netnum != netnum)\r\ncontinue;\r\nreturn nr;\r\n}\r\nLIBCFS_ALLOC(nr, sizeof(struct nidrange));\r\nif (!nr)\r\nreturn NULL;\r\nlist_add_tail(&nr->nr_link, nidlist);\r\nINIT_LIST_HEAD(&nr->nr_addrranges);\r\nnr->nr_netstrfns = nf;\r\nnr->nr_all = 0;\r\nnr->nr_netnum = netnum;\r\nreturn nr;\r\n}\r\nstatic int\r\nparse_nidrange(struct cfs_lstr *src, struct list_head *nidlist)\r\n{\r\nstruct cfs_lstr addrrange;\r\nstruct cfs_lstr net;\r\nstruct nidrange *nr;\r\nif (!cfs_gettok(src, '@', &addrrange))\r\ngoto failed;\r\nif (!cfs_gettok(src, '@', &net) || src->ls_str)\r\ngoto failed;\r\nnr = add_nidrange(&net, nidlist);\r\nif (!nr)\r\ngoto failed;\r\nif (parse_addrange(&addrrange, nr))\r\ngoto failed;\r\nreturn 1;\r\nfailed:\r\nreturn 0;\r\n}\r\nstatic void\r\nfree_addrranges(struct list_head *list)\r\n{\r\nwhile (!list_empty(list)) {\r\nstruct addrrange *ar;\r\nar = list_entry(list->next, struct addrrange, ar_link);\r\ncfs_expr_list_free_list(&ar->ar_numaddr_ranges);\r\nlist_del(&ar->ar_link);\r\nLIBCFS_FREE(ar, sizeof(struct addrrange));\r\n}\r\n}\r\nvoid\r\ncfs_free_nidlist(struct list_head *list)\r\n{\r\nstruct list_head *pos, *next;\r\nstruct nidrange *nr;\r\nlist_for_each_safe(pos, next, list) {\r\nnr = list_entry(pos, struct nidrange, nr_link);\r\nfree_addrranges(&nr->nr_addrranges);\r\nlist_del(pos);\r\nLIBCFS_FREE(nr, sizeof(struct nidrange));\r\n}\r\n}\r\nint\r\ncfs_parse_nidlist(char *str, int len, struct list_head *nidlist)\r\n{\r\nstruct cfs_lstr src;\r\nstruct cfs_lstr res;\r\nint rc;\r\nsrc.ls_str = str;\r\nsrc.ls_len = len;\r\nINIT_LIST_HEAD(nidlist);\r\nwhile (src.ls_str) {\r\nrc = cfs_gettok(&src, ' ', &res);\r\nif (!rc) {\r\ncfs_free_nidlist(nidlist);\r\nreturn 0;\r\n}\r\nrc = parse_nidrange(&res, nidlist);\r\nif (!rc) {\r\ncfs_free_nidlist(nidlist);\r\nreturn 0;\r\n}\r\n}\r\nreturn 1;\r\n}\r\nint cfs_match_nid(lnet_nid_t nid, struct list_head *nidlist)\r\n{\r\nstruct nidrange *nr;\r\nstruct addrrange *ar;\r\nlist_for_each_entry(nr, nidlist, nr_link) {\r\nif (nr->nr_netstrfns->nf_type != LNET_NETTYP(LNET_NIDNET(nid)))\r\ncontinue;\r\nif (nr->nr_netnum != LNET_NETNUM(LNET_NIDNET(nid)))\r\ncontinue;\r\nif (nr->nr_all)\r\nreturn 1;\r\nlist_for_each_entry(ar, &nr->nr_addrranges, ar_link)\r\nif (nr->nr_netstrfns->nf_match_addr(LNET_NIDADDR(nid),\r\n&ar->ar_numaddr_ranges))\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\ncfs_print_network(char *buffer, int count, struct nidrange *nr)\r\n{\r\nstruct netstrfns *nf = nr->nr_netstrfns;\r\nif (!nr->nr_netnum)\r\nreturn scnprintf(buffer, count, "@%s", nf->nf_name);\r\nelse\r\nreturn scnprintf(buffer, count, "@%s%u",\r\nnf->nf_name, nr->nr_netnum);\r\n}\r\nstatic int\r\ncfs_print_addrranges(char *buffer, int count, struct list_head *addrranges,\r\nstruct nidrange *nr)\r\n{\r\nint i = 0;\r\nstruct addrrange *ar;\r\nstruct netstrfns *nf = nr->nr_netstrfns;\r\nlist_for_each_entry(ar, addrranges, ar_link) {\r\nif (i)\r\ni += scnprintf(buffer + i, count - i, " ");\r\ni += nf->nf_print_addrlist(buffer + i, count - i,\r\n&ar->ar_numaddr_ranges);\r\ni += cfs_print_network(buffer + i, count - i, nr);\r\n}\r\nreturn i;\r\n}\r\nint cfs_print_nidlist(char *buffer, int count, struct list_head *nidlist)\r\n{\r\nint i = 0;\r\nstruct nidrange *nr;\r\nif (count <= 0)\r\nreturn 0;\r\nlist_for_each_entry(nr, nidlist, nr_link) {\r\nif (i)\r\ni += scnprintf(buffer + i, count - i, " ");\r\nif (nr->nr_all) {\r\nLASSERT(list_empty(&nr->nr_addrranges));\r\ni += scnprintf(buffer + i, count - i, "*");\r\ni += cfs_print_network(buffer + i, count - i, nr);\r\n} else {\r\ni += cfs_print_addrranges(buffer + i, count - i,\r\n&nr->nr_addrranges, nr);\r\n}\r\n}\r\nreturn i;\r\n}\r\nstatic void cfs_ip_ar_min_max(struct addrrange *ar, __u32 *min_nid,\r\n__u32 *max_nid)\r\n{\r\nstruct cfs_expr_list *el;\r\nstruct cfs_range_expr *re;\r\n__u32 tmp_ip_addr = 0;\r\nunsigned int min_ip[4] = {0};\r\nunsigned int max_ip[4] = {0};\r\nint re_count = 0;\r\nlist_for_each_entry(el, &ar->ar_numaddr_ranges, el_link) {\r\nlist_for_each_entry(re, &el->el_exprs, re_link) {\r\nmin_ip[re_count] = re->re_lo;\r\nmax_ip[re_count] = re->re_hi;\r\nre_count++;\r\n}\r\n}\r\ntmp_ip_addr = ((min_ip[0] << 24) | (min_ip[1] << 16) |\r\n(min_ip[2] << 8) | min_ip[3]);\r\nif (min_nid)\r\n*min_nid = tmp_ip_addr;\r\ntmp_ip_addr = ((max_ip[0] << 24) | (max_ip[1] << 16) |\r\n(max_ip[2] << 8) | max_ip[3]);\r\nif (max_nid)\r\n*max_nid = tmp_ip_addr;\r\n}\r\nstatic void cfs_num_ar_min_max(struct addrrange *ar, __u32 *min_nid,\r\n__u32 *max_nid)\r\n{\r\nstruct cfs_expr_list *el;\r\nstruct cfs_range_expr *re;\r\nunsigned int min_addr = 0;\r\nunsigned int max_addr = 0;\r\nlist_for_each_entry(el, &ar->ar_numaddr_ranges, el_link) {\r\nlist_for_each_entry(re, &el->el_exprs, re_link) {\r\nif (re->re_lo < min_addr || !min_addr)\r\nmin_addr = re->re_lo;\r\nif (re->re_hi > max_addr)\r\nmax_addr = re->re_hi;\r\n}\r\n}\r\nif (min_nid)\r\n*min_nid = min_addr;\r\nif (max_nid)\r\n*max_nid = max_addr;\r\n}\r\nbool cfs_nidrange_is_contiguous(struct list_head *nidlist)\r\n{\r\nstruct nidrange *nr;\r\nstruct netstrfns *nf = NULL;\r\nchar *lndname = NULL;\r\nint netnum = -1;\r\nlist_for_each_entry(nr, nidlist, nr_link) {\r\nnf = nr->nr_netstrfns;\r\nif (!lndname)\r\nlndname = nf->nf_name;\r\nif (netnum == -1)\r\nnetnum = nr->nr_netnum;\r\nif (strcmp(lndname, nf->nf_name) ||\r\nnetnum != nr->nr_netnum)\r\nreturn false;\r\n}\r\nif (!nf)\r\nreturn false;\r\nif (!nf->nf_is_contiguous(nidlist))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic bool cfs_num_is_contiguous(struct list_head *nidlist)\r\n{\r\nstruct nidrange *nr;\r\nstruct addrrange *ar;\r\nstruct cfs_expr_list *el;\r\nstruct cfs_range_expr *re;\r\nint last_hi = 0;\r\n__u32 last_end_nid = 0;\r\n__u32 current_start_nid = 0;\r\n__u32 current_end_nid = 0;\r\nlist_for_each_entry(nr, nidlist, nr_link) {\r\nlist_for_each_entry(ar, &nr->nr_addrranges, ar_link) {\r\ncfs_num_ar_min_max(ar, &current_start_nid,\r\n&current_end_nid);\r\nif (last_end_nid &&\r\n(current_start_nid - last_end_nid != 1))\r\nreturn false;\r\nlast_end_nid = current_end_nid;\r\nlist_for_each_entry(el, &ar->ar_numaddr_ranges,\r\nel_link) {\r\nlist_for_each_entry(re, &el->el_exprs,\r\nre_link) {\r\nif (re->re_stride > 1)\r\nreturn false;\r\nelse if (last_hi &&\r\nre->re_hi - last_hi != 1)\r\nreturn false;\r\nlast_hi = re->re_hi;\r\n}\r\n}\r\n}\r\n}\r\nreturn true;\r\n}\r\nstatic bool cfs_ip_is_contiguous(struct list_head *nidlist)\r\n{\r\nstruct nidrange *nr;\r\nstruct addrrange *ar;\r\nstruct cfs_expr_list *el;\r\nstruct cfs_range_expr *re;\r\nint expr_count;\r\nint last_hi = 255;\r\nint last_diff = 0;\r\n__u32 last_end_nid = 0;\r\n__u32 current_start_nid = 0;\r\n__u32 current_end_nid = 0;\r\nlist_for_each_entry(nr, nidlist, nr_link) {\r\nlist_for_each_entry(ar, &nr->nr_addrranges, ar_link) {\r\nlast_hi = 255;\r\nlast_diff = 0;\r\ncfs_ip_ar_min_max(ar, &current_start_nid,\r\n&current_end_nid);\r\nif (last_end_nid &&\r\n(current_start_nid - last_end_nid != 1))\r\nreturn false;\r\nlast_end_nid = current_end_nid;\r\nlist_for_each_entry(el, &ar->ar_numaddr_ranges,\r\nel_link) {\r\nexpr_count = 0;\r\nlist_for_each_entry(re, &el->el_exprs,\r\nre_link) {\r\nexpr_count++;\r\nif (re->re_stride > 1 ||\r\n(last_diff > 0 && last_hi != 255) ||\r\n(last_diff > 0 && last_hi == 255 &&\r\nre->re_lo > 0))\r\nreturn false;\r\nlast_hi = re->re_hi;\r\nlast_diff = re->re_hi - re->re_lo;\r\n}\r\n}\r\n}\r\n}\r\nreturn true;\r\n}\r\nvoid cfs_nidrange_find_min_max(struct list_head *nidlist, char *min_nid,\r\nchar *max_nid, size_t nidstr_length)\r\n{\r\nstruct nidrange *nr;\r\nstruct netstrfns *nf = NULL;\r\nint netnum = -1;\r\n__u32 min_addr;\r\n__u32 max_addr;\r\nchar *lndname = NULL;\r\nchar min_addr_str[IPSTRING_LENGTH];\r\nchar max_addr_str[IPSTRING_LENGTH];\r\nlist_for_each_entry(nr, nidlist, nr_link) {\r\nnf = nr->nr_netstrfns;\r\nlndname = nf->nf_name;\r\nif (netnum == -1)\r\nnetnum = nr->nr_netnum;\r\nnf->nf_min_max(nidlist, &min_addr, &max_addr);\r\n}\r\nnf->nf_addr2str(min_addr, min_addr_str, sizeof(min_addr_str));\r\nnf->nf_addr2str(max_addr, max_addr_str, sizeof(max_addr_str));\r\nsnprintf(min_nid, nidstr_length, "%s@%s%d", min_addr_str, lndname,\r\nnetnum);\r\nsnprintf(max_nid, nidstr_length, "%s@%s%d", max_addr_str, lndname,\r\nnetnum);\r\n}\r\nstatic void cfs_num_min_max(struct list_head *nidlist, __u32 *min_nid,\r\n__u32 *max_nid)\r\n{\r\nstruct nidrange *nr;\r\nstruct addrrange *ar;\r\nunsigned int tmp_min_addr = 0;\r\nunsigned int tmp_max_addr = 0;\r\nunsigned int min_addr = 0;\r\nunsigned int max_addr = 0;\r\nlist_for_each_entry(nr, nidlist, nr_link) {\r\nlist_for_each_entry(ar, &nr->nr_addrranges, ar_link) {\r\ncfs_num_ar_min_max(ar, &tmp_min_addr,\r\n&tmp_max_addr);\r\nif (tmp_min_addr < min_addr || !min_addr)\r\nmin_addr = tmp_min_addr;\r\nif (tmp_max_addr > max_addr)\r\nmax_addr = tmp_min_addr;\r\n}\r\n}\r\n*max_nid = max_addr;\r\n*min_nid = min_addr;\r\n}\r\nstatic void cfs_ip_min_max(struct list_head *nidlist, __u32 *min_nid,\r\n__u32 *max_nid)\r\n{\r\nstruct nidrange *nr;\r\nstruct addrrange *ar;\r\n__u32 tmp_min_ip_addr = 0;\r\n__u32 tmp_max_ip_addr = 0;\r\n__u32 min_ip_addr = 0;\r\n__u32 max_ip_addr = 0;\r\nlist_for_each_entry(nr, nidlist, nr_link) {\r\nlist_for_each_entry(ar, &nr->nr_addrranges, ar_link) {\r\ncfs_ip_ar_min_max(ar, &tmp_min_ip_addr,\r\n&tmp_max_ip_addr);\r\nif (tmp_min_ip_addr < min_ip_addr || !min_ip_addr)\r\nmin_ip_addr = tmp_min_ip_addr;\r\nif (tmp_max_ip_addr > max_ip_addr)\r\nmax_ip_addr = tmp_max_ip_addr;\r\n}\r\n}\r\nif (min_nid)\r\n*min_nid = min_ip_addr;\r\nif (max_nid)\r\n*max_nid = max_ip_addr;\r\n}\r\nstatic int\r\nlibcfs_lo_str2addr(const char *str, int nob, __u32 *addr)\r\n{\r\n*addr = 0;\r\nreturn 1;\r\n}\r\nstatic void\r\nlibcfs_ip_addr2str(__u32 addr, char *str, size_t size)\r\n{\r\nsnprintf(str, size, "%u.%u.%u.%u",\r\n(addr >> 24) & 0xff, (addr >> 16) & 0xff,\r\n(addr >> 8) & 0xff, addr & 0xff);\r\n}\r\nstatic int\r\nlibcfs_ip_str2addr(const char *str, int nob, __u32 *addr)\r\n{\r\nunsigned int a;\r\nunsigned int b;\r\nunsigned int c;\r\nunsigned int d;\r\nint n = nob;\r\nif (sscanf(str, "%u.%u.%u.%u%n", &a, &b, &c, &d, &n) >= 4 &&\r\nn == nob &&\r\n!(a & ~0xff) && !(b & ~0xff) &&\r\n!(c & ~0xff) && !(d & ~0xff)) {\r\n*addr = ((a << 24) | (b << 16) | (c << 8) | d);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nint\r\ncfs_ip_addr_parse(char *str, int len, struct list_head *list)\r\n{\r\nstruct cfs_expr_list *el;\r\nstruct cfs_lstr src;\r\nint rc;\r\nint i;\r\nsrc.ls_str = str;\r\nsrc.ls_len = len;\r\ni = 0;\r\nwhile (src.ls_str) {\r\nstruct cfs_lstr res;\r\nif (!cfs_gettok(&src, '.', &res)) {\r\nrc = -EINVAL;\r\ngoto out;\r\n}\r\nrc = cfs_expr_list_parse(res.ls_str, res.ls_len, 0, 255, &el);\r\nif (rc)\r\ngoto out;\r\nlist_add_tail(&el->el_link, list);\r\ni++;\r\n}\r\nif (i == 4)\r\nreturn 0;\r\nrc = -EINVAL;\r\nout:\r\ncfs_expr_list_free_list(list);\r\nreturn rc;\r\n}\r\nstatic int\r\nlibcfs_ip_addr_range_print(char *buffer, int count, struct list_head *list)\r\n{\r\nint i = 0, j = 0;\r\nstruct cfs_expr_list *el;\r\nlist_for_each_entry(el, list, el_link) {\r\nLASSERT(j++ < 4);\r\nif (i)\r\ni += scnprintf(buffer + i, count - i, ".");\r\ni += cfs_expr_list_print(buffer + i, count - i, el);\r\n}\r\nreturn i;\r\n}\r\nint\r\ncfs_ip_addr_match(__u32 addr, struct list_head *list)\r\n{\r\nstruct cfs_expr_list *el;\r\nint i = 0;\r\nlist_for_each_entry_reverse(el, list, el_link) {\r\nif (!cfs_expr_list_match(addr & 0xff, el))\r\nreturn 0;\r\naddr >>= 8;\r\ni++;\r\n}\r\nreturn i == 4;\r\n}\r\nstatic void\r\nlibcfs_decnum_addr2str(__u32 addr, char *str, size_t size)\r\n{\r\nsnprintf(str, size, "%u", addr);\r\n}\r\nstatic int\r\nlibcfs_num_str2addr(const char *str, int nob, __u32 *addr)\r\n{\r\nint n;\r\nn = nob;\r\nif (sscanf(str, "0x%x%n", addr, &n) >= 1 && n == nob)\r\nreturn 1;\r\nn = nob;\r\nif (sscanf(str, "0X%x%n", addr, &n) >= 1 && n == nob)\r\nreturn 1;\r\nn = nob;\r\nif (sscanf(str, "%u%n", addr, &n) >= 1 && n == nob)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int\r\nlibcfs_num_parse(char *str, int len, struct list_head *list)\r\n{\r\nstruct cfs_expr_list *el;\r\nint rc;\r\nrc = cfs_expr_list_parse(str, len, 0, MAX_NUMERIC_VALUE, &el);\r\nif (!rc)\r\nlist_add_tail(&el->el_link, list);\r\nreturn rc;\r\n}\r\nstatic int\r\nlibcfs_num_addr_range_print(char *buffer, int count, struct list_head *list)\r\n{\r\nint i = 0, j = 0;\r\nstruct cfs_expr_list *el;\r\nlist_for_each_entry(el, list, el_link) {\r\nLASSERT(j++ < 1);\r\ni += cfs_expr_list_print(buffer + i, count - i, el);\r\n}\r\nreturn i;\r\n}\r\nstatic int\r\nlibcfs_num_match(__u32 addr, struct list_head *numaddr)\r\n{\r\nstruct cfs_expr_list *el;\r\nLASSERT(!list_empty(numaddr));\r\nel = list_entry(numaddr->next, struct cfs_expr_list, el_link);\r\nreturn cfs_expr_list_match(addr, el);\r\n}\r\nstatic struct netstrfns *\r\nlibcfs_lnd2netstrfns(__u32 lnd)\r\n{\r\nint i;\r\nfor (i = 0; i < libcfs_nnetstrfns; i++)\r\nif (lnd == libcfs_netstrfns[i].nf_type)\r\nreturn &libcfs_netstrfns[i];\r\nreturn NULL;\r\n}\r\nstatic struct netstrfns *\r\nlibcfs_namenum2netstrfns(const char *name)\r\n{\r\nstruct netstrfns *nf;\r\nint i;\r\nfor (i = 0; i < libcfs_nnetstrfns; i++) {\r\nnf = &libcfs_netstrfns[i];\r\nif (!strncmp(name, nf->nf_name, strlen(nf->nf_name)))\r\nreturn nf;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct netstrfns *\r\nlibcfs_name2netstrfns(const char *name)\r\n{\r\nint i;\r\nfor (i = 0; i < libcfs_nnetstrfns; i++)\r\nif (!strcmp(libcfs_netstrfns[i].nf_name, name))\r\nreturn &libcfs_netstrfns[i];\r\nreturn NULL;\r\n}\r\nint\r\nlibcfs_isknown_lnd(__u32 lnd)\r\n{\r\nreturn !!libcfs_lnd2netstrfns(lnd);\r\n}\r\nchar *\r\nlibcfs_lnd2modname(__u32 lnd)\r\n{\r\nstruct netstrfns *nf = libcfs_lnd2netstrfns(lnd);\r\nreturn nf ? nf->nf_modname : NULL;\r\n}\r\nint\r\nlibcfs_str2lnd(const char *str)\r\n{\r\nstruct netstrfns *nf = libcfs_name2netstrfns(str);\r\nif (nf)\r\nreturn nf->nf_type;\r\nreturn -ENXIO;\r\n}\r\nchar *\r\nlibcfs_lnd2str_r(__u32 lnd, char *buf, size_t buf_size)\r\n{\r\nstruct netstrfns *nf;\r\nnf = libcfs_lnd2netstrfns(lnd);\r\nif (!nf)\r\nsnprintf(buf, buf_size, "?%u?", lnd);\r\nelse\r\nsnprintf(buf, buf_size, "%s", nf->nf_name);\r\nreturn buf;\r\n}\r\nchar *\r\nlibcfs_net2str_r(__u32 net, char *buf, size_t buf_size)\r\n{\r\n__u32 nnum = LNET_NETNUM(net);\r\n__u32 lnd = LNET_NETTYP(net);\r\nstruct netstrfns *nf;\r\nnf = libcfs_lnd2netstrfns(lnd);\r\nif (!nf)\r\nsnprintf(buf, buf_size, "<%u:%u>", lnd, nnum);\r\nelse if (!nnum)\r\nsnprintf(buf, buf_size, "%s", nf->nf_name);\r\nelse\r\nsnprintf(buf, buf_size, "%s%u", nf->nf_name, nnum);\r\nreturn buf;\r\n}\r\nchar *\r\nlibcfs_nid2str_r(lnet_nid_t nid, char *buf, size_t buf_size)\r\n{\r\n__u32 addr = LNET_NIDADDR(nid);\r\n__u32 net = LNET_NIDNET(nid);\r\n__u32 nnum = LNET_NETNUM(net);\r\n__u32 lnd = LNET_NETTYP(net);\r\nstruct netstrfns *nf;\r\nif (nid == LNET_NID_ANY) {\r\nstrncpy(buf, "<?>", buf_size);\r\nbuf[buf_size - 1] = '\0';\r\nreturn buf;\r\n}\r\nnf = libcfs_lnd2netstrfns(lnd);\r\nif (!nf) {\r\nsnprintf(buf, buf_size, "%x@<%u:%u>", addr, lnd, nnum);\r\n} else {\r\nsize_t addr_len;\r\nnf->nf_addr2str(addr, buf, buf_size);\r\naddr_len = strlen(buf);\r\nif (!nnum)\r\nsnprintf(buf + addr_len, buf_size - addr_len, "@%s",\r\nnf->nf_name);\r\nelse\r\nsnprintf(buf + addr_len, buf_size - addr_len, "@%s%u",\r\nnf->nf_name, nnum);\r\n}\r\nreturn buf;\r\n}\r\nstatic struct netstrfns *\r\nlibcfs_str2net_internal(const char *str, __u32 *net)\r\n{\r\nstruct netstrfns *nf = NULL;\r\nint nob;\r\nunsigned int netnum;\r\nint i;\r\nfor (i = 0; i < libcfs_nnetstrfns; i++) {\r\nnf = &libcfs_netstrfns[i];\r\nif (!strncmp(str, nf->nf_name, strlen(nf->nf_name)))\r\nbreak;\r\n}\r\nif (i == libcfs_nnetstrfns)\r\nreturn NULL;\r\nnob = strlen(nf->nf_name);\r\nif (strlen(str) == (unsigned int)nob) {\r\nnetnum = 0;\r\n} else {\r\nif (nf->nf_type == LOLND)\r\nreturn NULL;\r\nstr += nob;\r\ni = strlen(str);\r\nif (sscanf(str, "%u%n", &netnum, &i) < 1 ||\r\ni != (int)strlen(str))\r\nreturn NULL;\r\n}\r\n*net = LNET_MKNET(nf->nf_type, netnum);\r\nreturn nf;\r\n}\r\n__u32\r\nlibcfs_str2net(const char *str)\r\n{\r\n__u32 net;\r\nif (libcfs_str2net_internal(str, &net))\r\nreturn net;\r\nreturn LNET_NIDNET(LNET_NID_ANY);\r\n}\r\nlnet_nid_t\r\nlibcfs_str2nid(const char *str)\r\n{\r\nconst char *sep = strchr(str, '@');\r\nstruct netstrfns *nf;\r\n__u32 net;\r\n__u32 addr;\r\nif (sep) {\r\nnf = libcfs_str2net_internal(sep + 1, &net);\r\nif (!nf)\r\nreturn LNET_NID_ANY;\r\n} else {\r\nsep = str + strlen(str);\r\nnet = LNET_MKNET(SOCKLND, 0);\r\nnf = libcfs_lnd2netstrfns(SOCKLND);\r\nLASSERT(nf);\r\n}\r\nif (!nf->nf_str2addr(str, (int)(sep - str), &addr))\r\nreturn LNET_NID_ANY;\r\nreturn LNET_MKNID(net, addr);\r\n}\r\nchar *\r\nlibcfs_id2str(lnet_process_id_t id)\r\n{\r\nchar *str = libcfs_next_nidstring();\r\nif (id.pid == LNET_PID_ANY) {\r\nsnprintf(str, LNET_NIDSTR_SIZE,\r\n"LNET_PID_ANY-%s", libcfs_nid2str(id.nid));\r\nreturn str;\r\n}\r\nsnprintf(str, LNET_NIDSTR_SIZE, "%s%u-%s",\r\nid.pid & LNET_PID_USERFLAG ? "U" : "",\r\nid.pid & ~LNET_PID_USERFLAG, libcfs_nid2str(id.nid));\r\nreturn str;\r\n}\r\nint\r\nlibcfs_str2anynid(lnet_nid_t *nidp, const char *str)\r\n{\r\nif (!strcmp(str, "*")) {\r\n*nidp = LNET_NID_ANY;\r\nreturn 1;\r\n}\r\n*nidp = libcfs_str2nid(str);\r\nreturn *nidp != LNET_NID_ANY;\r\n}

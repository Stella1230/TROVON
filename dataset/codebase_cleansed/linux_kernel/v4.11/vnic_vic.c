struct vic_provinfo *vic_provinfo_alloc(gfp_t flags, const u8 *oui,\r\nconst u8 type)\r\n{\r\nstruct vic_provinfo *vp;\r\nif (!oui)\r\nreturn NULL;\r\nvp = kzalloc(VIC_PROVINFO_MAX_DATA, flags);\r\nif (!vp)\r\nreturn NULL;\r\nmemcpy(vp->oui, oui, sizeof(vp->oui));\r\nvp->type = type;\r\nvp->length = htonl(sizeof(vp->num_tlvs));\r\nreturn vp;\r\n}\r\nvoid vic_provinfo_free(struct vic_provinfo *vp)\r\n{\r\nkfree(vp);\r\n}\r\nint vic_provinfo_add_tlv(struct vic_provinfo *vp, u16 type, u16 length,\r\nconst void *value)\r\n{\r\nstruct vic_provinfo_tlv *tlv;\r\nif (!vp || !value)\r\nreturn -EINVAL;\r\nif (ntohl(vp->length) + offsetof(struct vic_provinfo_tlv, value) +\r\nlength > VIC_PROVINFO_MAX_TLV_DATA)\r\nreturn -ENOMEM;\r\ntlv = (struct vic_provinfo_tlv *)((u8 *)vp->tlv +\r\nntohl(vp->length) - sizeof(vp->num_tlvs));\r\ntlv->type = htons(type);\r\ntlv->length = htons(length);\r\nmemcpy(tlv->value, value, length);\r\nvp->num_tlvs = htonl(ntohl(vp->num_tlvs) + 1);\r\nvp->length = htonl(ntohl(vp->length) +\r\noffsetof(struct vic_provinfo_tlv, value) + length);\r\nreturn 0;\r\n}\r\nsize_t vic_provinfo_size(struct vic_provinfo *vp)\r\n{\r\nreturn vp ? ntohl(vp->length) + sizeof(*vp) - sizeof(vp->num_tlvs) : 0;\r\n}

static void bt_link_release(struct device *dev)\r\n{\r\nstruct hci_conn *conn = to_hci_conn(dev);\r\nkfree(conn);\r\n}\r\nstatic int __match_tty(struct device *dev, void *data)\r\n{\r\nreturn !strncmp(dev_name(dev), "rfcomm", 6);\r\n}\r\nvoid hci_conn_init_sysfs(struct hci_conn *conn)\r\n{\r\nstruct hci_dev *hdev = conn->hdev;\r\nBT_DBG("conn %p", conn);\r\nconn->dev.type = &bt_link;\r\nconn->dev.class = bt_class;\r\nconn->dev.parent = &hdev->dev;\r\ndevice_initialize(&conn->dev);\r\n}\r\nvoid hci_conn_add_sysfs(struct hci_conn *conn)\r\n{\r\nstruct hci_dev *hdev = conn->hdev;\r\nBT_DBG("conn %p", conn);\r\ndev_set_name(&conn->dev, "%s:%d", hdev->name, conn->handle);\r\nif (device_add(&conn->dev) < 0) {\r\nBT_ERR("Failed to register connection device");\r\nreturn;\r\n}\r\nhci_dev_hold(hdev);\r\n}\r\nvoid hci_conn_del_sysfs(struct hci_conn *conn)\r\n{\r\nstruct hci_dev *hdev = conn->hdev;\r\nif (!device_is_registered(&conn->dev))\r\nreturn;\r\nwhile (1) {\r\nstruct device *dev;\r\ndev = device_find_child(&conn->dev, NULL, __match_tty);\r\nif (!dev)\r\nbreak;\r\ndevice_move(dev, NULL, DPM_ORDER_DEV_LAST);\r\nput_device(dev);\r\n}\r\ndevice_del(&conn->dev);\r\nhci_dev_put(hdev);\r\n}\r\nstatic void bt_host_release(struct device *dev)\r\n{\r\nstruct hci_dev *hdev = to_hci_dev(dev);\r\nkfree(hdev);\r\nmodule_put(THIS_MODULE);\r\n}\r\nvoid hci_init_sysfs(struct hci_dev *hdev)\r\n{\r\nstruct device *dev = &hdev->dev;\r\ndev->type = &bt_host;\r\ndev->class = bt_class;\r\n__module_get(THIS_MODULE);\r\ndevice_initialize(dev);\r\n}\r\nint __init bt_sysfs_init(void)\r\n{\r\nbt_class = class_create(THIS_MODULE, "bluetooth");\r\nreturn PTR_ERR_OR_ZERO(bt_class);\r\n}\r\nvoid bt_sysfs_cleanup(void)\r\n{\r\nclass_destroy(bt_class);\r\n}

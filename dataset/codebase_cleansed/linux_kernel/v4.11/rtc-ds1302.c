static int ds1302_rtc_set_time(struct device *dev, struct rtc_time *time)\r\n{\r\nstruct spi_device *spi = dev_get_drvdata(dev);\r\nu8 buf[1 + RTC_CLCK_LEN];\r\nu8 *bp = buf;\r\nint status;\r\nbp = buf;\r\n*bp++ = RTC_ADDR_CTRL << 1 | RTC_CMD_WRITE;\r\n*bp++ = RTC_CMD_WRITE_ENABLE;\r\nstatus = spi_write_then_read(spi, buf, 2,\r\nNULL, 0);\r\nif (status)\r\nreturn status;\r\nbp = buf;\r\n*bp++ = RTC_CLCK_BURST << 1 | RTC_CMD_WRITE;\r\n*bp++ = bin2bcd(time->tm_sec);\r\n*bp++ = bin2bcd(time->tm_min);\r\n*bp++ = bin2bcd(time->tm_hour);\r\n*bp++ = bin2bcd(time->tm_mday);\r\n*bp++ = bin2bcd(time->tm_mon + 1);\r\n*bp++ = time->tm_wday + 1;\r\n*bp++ = bin2bcd(time->tm_year % 100);\r\n*bp++ = RTC_CMD_WRITE_DISABLE;\r\nreturn spi_write_then_read(spi, buf, sizeof(buf),\r\nNULL, 0);\r\n}\r\nstatic int ds1302_rtc_get_time(struct device *dev, struct rtc_time *time)\r\n{\r\nstruct spi_device *spi = dev_get_drvdata(dev);\r\nu8 addr = RTC_CLCK_BURST << 1 | RTC_CMD_READ;\r\nu8 buf[RTC_CLCK_LEN - 1];\r\nint status;\r\nstatus = spi_write_then_read(spi, &addr, sizeof(addr),\r\nbuf, sizeof(buf));\r\nif (status < 0)\r\nreturn status;\r\ntime->tm_sec = bcd2bin(buf[RTC_ADDR_SEC]);\r\ntime->tm_min = bcd2bin(buf[RTC_ADDR_MIN]);\r\ntime->tm_hour = bcd2bin(buf[RTC_ADDR_HOUR]);\r\ntime->tm_wday = buf[RTC_ADDR_DAY] - 1;\r\ntime->tm_mday = bcd2bin(buf[RTC_ADDR_DATE]);\r\ntime->tm_mon = bcd2bin(buf[RTC_ADDR_MON]) - 1;\r\ntime->tm_year = bcd2bin(buf[RTC_ADDR_YEAR]) + 100;\r\nreturn rtc_valid_tm(time);\r\n}\r\nstatic int ds1302_probe(struct spi_device *spi)\r\n{\r\nstruct rtc_device *rtc;\r\nu8 addr;\r\nu8 buf[4];\r\nu8 *bp = buf;\r\nint status;\r\nif (spi->bits_per_word && (spi->bits_per_word != 8)) {\r\ndev_err(&spi->dev, "bad word length\n");\r\nreturn -EINVAL;\r\n} else if (spi->max_speed_hz > 2000000) {\r\ndev_err(&spi->dev, "speed is too high\n");\r\nreturn -EINVAL;\r\n} else if (spi->mode & SPI_CPHA) {\r\ndev_err(&spi->dev, "bad mode\n");\r\nreturn -EINVAL;\r\n}\r\naddr = RTC_ADDR_CTRL << 1 | RTC_CMD_READ;\r\nstatus = spi_write_then_read(spi, &addr, sizeof(addr), buf, 1);\r\nif (status < 0) {\r\ndev_err(&spi->dev, "control register read error %d\n",\r\nstatus);\r\nreturn status;\r\n}\r\nif ((buf[0] & ~RTC_CMD_WRITE_DISABLE) != 0) {\r\nstatus = spi_write_then_read(spi, &addr, sizeof(addr), buf, 1);\r\nif (status < 0) {\r\ndev_err(&spi->dev, "control register read error %d\n",\r\nstatus);\r\nreturn status;\r\n}\r\nif ((buf[0] & ~RTC_CMD_WRITE_DISABLE) != 0) {\r\ndev_err(&spi->dev, "junk in control register\n");\r\nreturn -ENODEV;\r\n}\r\n}\r\nif (buf[0] == 0) {\r\nbp = buf;\r\n*bp++ = RTC_ADDR_CTRL << 1 | RTC_CMD_WRITE;\r\n*bp++ = RTC_CMD_WRITE_DISABLE;\r\nstatus = spi_write_then_read(spi, buf, 2, NULL, 0);\r\nif (status < 0) {\r\ndev_err(&spi->dev, "control register write error %d\n",\r\nstatus);\r\nreturn status;\r\n}\r\naddr = RTC_ADDR_CTRL << 1 | RTC_CMD_READ;\r\nstatus = spi_write_then_read(spi, &addr, sizeof(addr), buf, 1);\r\nif (status < 0) {\r\ndev_err(&spi->dev,\r\n"error %d reading control register\n",\r\nstatus);\r\nreturn status;\r\n}\r\nif (buf[0] != RTC_CMD_WRITE_DISABLE) {\r\ndev_err(&spi->dev, "failed to detect chip\n");\r\nreturn -ENODEV;\r\n}\r\n}\r\nspi_set_drvdata(spi, spi);\r\nrtc = devm_rtc_device_register(&spi->dev, "ds1302",\r\n&ds1302_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc)) {\r\nstatus = PTR_ERR(rtc);\r\ndev_err(&spi->dev, "error %d registering rtc\n", status);\r\nreturn status;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ds1302_remove(struct spi_device *spi)\r\n{\r\nspi_set_drvdata(spi, NULL);\r\nreturn 0;\r\n}

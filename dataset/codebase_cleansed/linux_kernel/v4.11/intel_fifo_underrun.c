static bool ivb_can_enable_err_int(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nstruct intel_crtc *crtc;\r\nenum pipe pipe;\r\nassert_spin_locked(&dev_priv->irq_lock);\r\nfor_each_pipe(dev_priv, pipe) {\r\ncrtc = intel_get_crtc_for_pipe(dev_priv, pipe);\r\nif (crtc->cpu_fifo_underrun_disabled)\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic bool cpt_can_enable_serr_int(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nenum pipe pipe;\r\nstruct intel_crtc *crtc;\r\nassert_spin_locked(&dev_priv->irq_lock);\r\nfor_each_pipe(dev_priv, pipe) {\r\ncrtc = intel_get_crtc_for_pipe(dev_priv, pipe);\r\nif (crtc->pch_fifo_underrun_disabled)\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic void i9xx_check_fifo_underruns(struct intel_crtc *crtc)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\r\ni915_reg_t reg = PIPESTAT(crtc->pipe);\r\nu32 pipestat = I915_READ(reg) & 0xffff0000;\r\nassert_spin_locked(&dev_priv->irq_lock);\r\nif ((pipestat & PIPE_FIFO_UNDERRUN_STATUS) == 0)\r\nreturn;\r\nI915_WRITE(reg, pipestat | PIPE_FIFO_UNDERRUN_STATUS);\r\nPOSTING_READ(reg);\r\nDRM_ERROR("pipe %c underrun\n", pipe_name(crtc->pipe));\r\n}\r\nstatic void i9xx_set_fifo_underrun_reporting(struct drm_device *dev,\r\nenum pipe pipe,\r\nbool enable, bool old)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\ni915_reg_t reg = PIPESTAT(pipe);\r\nu32 pipestat = I915_READ(reg) & 0xffff0000;\r\nassert_spin_locked(&dev_priv->irq_lock);\r\nif (enable) {\r\nI915_WRITE(reg, pipestat | PIPE_FIFO_UNDERRUN_STATUS);\r\nPOSTING_READ(reg);\r\n} else {\r\nif (old && pipestat & PIPE_FIFO_UNDERRUN_STATUS)\r\nDRM_ERROR("pipe %c underrun\n", pipe_name(pipe));\r\n}\r\n}\r\nstatic void ironlake_set_fifo_underrun_reporting(struct drm_device *dev,\r\nenum pipe pipe, bool enable)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nuint32_t bit = (pipe == PIPE_A) ? DE_PIPEA_FIFO_UNDERRUN :\r\nDE_PIPEB_FIFO_UNDERRUN;\r\nif (enable)\r\nilk_enable_display_irq(dev_priv, bit);\r\nelse\r\nilk_disable_display_irq(dev_priv, bit);\r\n}\r\nstatic void ivybridge_check_fifo_underruns(struct intel_crtc *crtc)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\r\nenum pipe pipe = crtc->pipe;\r\nuint32_t err_int = I915_READ(GEN7_ERR_INT);\r\nassert_spin_locked(&dev_priv->irq_lock);\r\nif ((err_int & ERR_INT_FIFO_UNDERRUN(pipe)) == 0)\r\nreturn;\r\nI915_WRITE(GEN7_ERR_INT, ERR_INT_FIFO_UNDERRUN(pipe));\r\nPOSTING_READ(GEN7_ERR_INT);\r\nDRM_ERROR("fifo underrun on pipe %c\n", pipe_name(pipe));\r\n}\r\nstatic void ivybridge_set_fifo_underrun_reporting(struct drm_device *dev,\r\nenum pipe pipe,\r\nbool enable, bool old)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nif (enable) {\r\nI915_WRITE(GEN7_ERR_INT, ERR_INT_FIFO_UNDERRUN(pipe));\r\nif (!ivb_can_enable_err_int(dev))\r\nreturn;\r\nilk_enable_display_irq(dev_priv, DE_ERR_INT_IVB);\r\n} else {\r\nilk_disable_display_irq(dev_priv, DE_ERR_INT_IVB);\r\nif (old &&\r\nI915_READ(GEN7_ERR_INT) & ERR_INT_FIFO_UNDERRUN(pipe)) {\r\nDRM_ERROR("uncleared fifo underrun on pipe %c\n",\r\npipe_name(pipe));\r\n}\r\n}\r\n}\r\nstatic void broadwell_set_fifo_underrun_reporting(struct drm_device *dev,\r\nenum pipe pipe, bool enable)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nif (enable)\r\nbdw_enable_pipe_irq(dev_priv, pipe, GEN8_PIPE_FIFO_UNDERRUN);\r\nelse\r\nbdw_disable_pipe_irq(dev_priv, pipe, GEN8_PIPE_FIFO_UNDERRUN);\r\n}\r\nstatic void ibx_set_fifo_underrun_reporting(struct drm_device *dev,\r\nenum transcoder pch_transcoder,\r\nbool enable)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nuint32_t bit = (pch_transcoder == TRANSCODER_A) ?\r\nSDE_TRANSA_FIFO_UNDER : SDE_TRANSB_FIFO_UNDER;\r\nif (enable)\r\nibx_enable_display_interrupt(dev_priv, bit);\r\nelse\r\nibx_disable_display_interrupt(dev_priv, bit);\r\n}\r\nstatic void cpt_check_pch_fifo_underruns(struct intel_crtc *crtc)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(crtc->base.dev);\r\nenum transcoder pch_transcoder = (enum transcoder) crtc->pipe;\r\nuint32_t serr_int = I915_READ(SERR_INT);\r\nassert_spin_locked(&dev_priv->irq_lock);\r\nif ((serr_int & SERR_INT_TRANS_FIFO_UNDERRUN(pch_transcoder)) == 0)\r\nreturn;\r\nI915_WRITE(SERR_INT, SERR_INT_TRANS_FIFO_UNDERRUN(pch_transcoder));\r\nPOSTING_READ(SERR_INT);\r\nDRM_ERROR("pch fifo underrun on pch transcoder %s\n",\r\ntranscoder_name(pch_transcoder));\r\n}\r\nstatic void cpt_set_fifo_underrun_reporting(struct drm_device *dev,\r\nenum transcoder pch_transcoder,\r\nbool enable, bool old)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nif (enable) {\r\nI915_WRITE(SERR_INT,\r\nSERR_INT_TRANS_FIFO_UNDERRUN(pch_transcoder));\r\nif (!cpt_can_enable_serr_int(dev))\r\nreturn;\r\nibx_enable_display_interrupt(dev_priv, SDE_ERROR_CPT);\r\n} else {\r\nibx_disable_display_interrupt(dev_priv, SDE_ERROR_CPT);\r\nif (old && I915_READ(SERR_INT) &\r\nSERR_INT_TRANS_FIFO_UNDERRUN(pch_transcoder)) {\r\nDRM_ERROR("uncleared pch fifo underrun on pch transcoder %s\n",\r\ntranscoder_name(pch_transcoder));\r\n}\r\n}\r\n}\r\nstatic bool __intel_set_cpu_fifo_underrun_reporting(struct drm_device *dev,\r\nenum pipe pipe, bool enable)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nstruct intel_crtc *crtc = intel_get_crtc_for_pipe(dev_priv, pipe);\r\nbool old;\r\nassert_spin_locked(&dev_priv->irq_lock);\r\nold = !crtc->cpu_fifo_underrun_disabled;\r\ncrtc->cpu_fifo_underrun_disabled = !enable;\r\nif (HAS_GMCH_DISPLAY(dev_priv))\r\ni9xx_set_fifo_underrun_reporting(dev, pipe, enable, old);\r\nelse if (IS_GEN5(dev_priv) || IS_GEN6(dev_priv))\r\nironlake_set_fifo_underrun_reporting(dev, pipe, enable);\r\nelse if (IS_GEN7(dev_priv))\r\nivybridge_set_fifo_underrun_reporting(dev, pipe, enable, old);\r\nelse if (IS_GEN8(dev_priv) || IS_GEN9(dev_priv))\r\nbroadwell_set_fifo_underrun_reporting(dev, pipe, enable);\r\nreturn old;\r\n}\r\nbool intel_set_cpu_fifo_underrun_reporting(struct drm_i915_private *dev_priv,\r\nenum pipe pipe, bool enable)\r\n{\r\nunsigned long flags;\r\nbool ret;\r\nspin_lock_irqsave(&dev_priv->irq_lock, flags);\r\nret = __intel_set_cpu_fifo_underrun_reporting(&dev_priv->drm, pipe,\r\nenable);\r\nspin_unlock_irqrestore(&dev_priv->irq_lock, flags);\r\nreturn ret;\r\n}\r\nbool intel_set_pch_fifo_underrun_reporting(struct drm_i915_private *dev_priv,\r\nenum transcoder pch_transcoder,\r\nbool enable)\r\n{\r\nstruct intel_crtc *crtc =\r\nintel_get_crtc_for_pipe(dev_priv, (enum pipe) pch_transcoder);\r\nunsigned long flags;\r\nbool old;\r\nspin_lock_irqsave(&dev_priv->irq_lock, flags);\r\nold = !crtc->pch_fifo_underrun_disabled;\r\ncrtc->pch_fifo_underrun_disabled = !enable;\r\nif (HAS_PCH_IBX(dev_priv))\r\nibx_set_fifo_underrun_reporting(&dev_priv->drm,\r\npch_transcoder,\r\nenable);\r\nelse\r\ncpt_set_fifo_underrun_reporting(&dev_priv->drm,\r\npch_transcoder,\r\nenable, old);\r\nspin_unlock_irqrestore(&dev_priv->irq_lock, flags);\r\nreturn old;\r\n}\r\nvoid intel_cpu_fifo_underrun_irq_handler(struct drm_i915_private *dev_priv,\r\nenum pipe pipe)\r\n{\r\nstruct intel_crtc *crtc = intel_get_crtc_for_pipe(dev_priv, pipe);\r\nif (crtc == NULL)\r\nreturn;\r\nif (HAS_GMCH_DISPLAY(dev_priv) &&\r\ncrtc->cpu_fifo_underrun_disabled)\r\nreturn;\r\nif (intel_set_cpu_fifo_underrun_reporting(dev_priv, pipe, false))\r\nDRM_ERROR("CPU pipe %c FIFO underrun\n",\r\npipe_name(pipe));\r\nintel_fbc_handle_fifo_underrun_irq(dev_priv);\r\n}\r\nvoid intel_pch_fifo_underrun_irq_handler(struct drm_i915_private *dev_priv,\r\nenum transcoder pch_transcoder)\r\n{\r\nif (intel_set_pch_fifo_underrun_reporting(dev_priv, pch_transcoder,\r\nfalse))\r\nDRM_ERROR("PCH transcoder %s FIFO underrun\n",\r\ntranscoder_name(pch_transcoder));\r\n}\r\nvoid intel_check_cpu_fifo_underruns(struct drm_i915_private *dev_priv)\r\n{\r\nstruct intel_crtc *crtc;\r\nspin_lock_irq(&dev_priv->irq_lock);\r\nfor_each_intel_crtc(&dev_priv->drm, crtc) {\r\nif (crtc->cpu_fifo_underrun_disabled)\r\ncontinue;\r\nif (HAS_GMCH_DISPLAY(dev_priv))\r\ni9xx_check_fifo_underruns(crtc);\r\nelse if (IS_GEN7(dev_priv))\r\nivybridge_check_fifo_underruns(crtc);\r\n}\r\nspin_unlock_irq(&dev_priv->irq_lock);\r\n}\r\nvoid intel_check_pch_fifo_underruns(struct drm_i915_private *dev_priv)\r\n{\r\nstruct intel_crtc *crtc;\r\nspin_lock_irq(&dev_priv->irq_lock);\r\nfor_each_intel_crtc(&dev_priv->drm, crtc) {\r\nif (crtc->pch_fifo_underrun_disabled)\r\ncontinue;\r\nif (HAS_PCH_CPT(dev_priv))\r\ncpt_check_pch_fifo_underruns(crtc);\r\n}\r\nspin_unlock_irq(&dev_priv->irq_lock);\r\n}

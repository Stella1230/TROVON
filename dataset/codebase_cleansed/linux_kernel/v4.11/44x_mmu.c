static void ppc44x_update_tlb_hwater(void)\r\n{\r\nextern unsigned int tlb_44x_patch_hwater_D[];\r\nextern unsigned int tlb_44x_patch_hwater_I[];\r\ntlb_44x_patch_hwater_D[0] = (tlb_44x_patch_hwater_D[0] & 0xffff0000) |\r\ntlb_44x_hwater;\r\nflush_icache_range((unsigned long)&tlb_44x_patch_hwater_D[0],\r\n(unsigned long)&tlb_44x_patch_hwater_D[1]);\r\ntlb_44x_patch_hwater_I[0] = (tlb_44x_patch_hwater_I[0] & 0xffff0000) |\r\ntlb_44x_hwater;\r\nflush_icache_range((unsigned long)&tlb_44x_patch_hwater_I[0],\r\n(unsigned long)&tlb_44x_patch_hwater_I[1]);\r\n}\r\nstatic void __init ppc44x_pin_tlb(unsigned int virt, unsigned int phys)\r\n{\r\nunsigned int entry = tlb_44x_hwater--;\r\nppc44x_update_tlb_hwater();\r\nmtspr(SPRN_MMUCR, 0);\r\n__asm__ __volatile__(\r\n"tlbwe %2,%3,%4\n"\r\n"tlbwe %1,%3,%5\n"\r\n"tlbwe %0,%3,%6\n"\r\n:\r\n: "r" (PPC44x_TLB_SW | PPC44x_TLB_SR | PPC44x_TLB_SX | PPC44x_TLB_G),\r\n"r" (phys),\r\n"r" (virt | PPC44x_TLB_VALID | PPC44x_TLB_256M),\r\n"r" (entry),\r\n"i" (PPC44x_TLB_PAGEID),\r\n"i" (PPC44x_TLB_XLAT),\r\n"i" (PPC44x_TLB_ATTRIB));\r\n}\r\nstatic int __init ppc47x_find_free_bolted(void)\r\n{\r\nunsigned int mmube0 = mfspr(SPRN_MMUBE0);\r\nunsigned int mmube1 = mfspr(SPRN_MMUBE1);\r\nif (!(mmube0 & MMUBE0_VBE0))\r\nreturn 0;\r\nif (!(mmube0 & MMUBE0_VBE1))\r\nreturn 1;\r\nif (!(mmube0 & MMUBE0_VBE2))\r\nreturn 2;\r\nif (!(mmube1 & MMUBE1_VBE3))\r\nreturn 3;\r\nif (!(mmube1 & MMUBE1_VBE4))\r\nreturn 4;\r\nif (!(mmube1 & MMUBE1_VBE5))\r\nreturn 5;\r\nreturn -1;\r\n}\r\nstatic void __init ppc47x_update_boltmap(void)\r\n{\r\nunsigned int mmube0 = mfspr(SPRN_MMUBE0);\r\nunsigned int mmube1 = mfspr(SPRN_MMUBE1);\r\nif (mmube0 & MMUBE0_VBE0)\r\n__set_bit((mmube0 >> MMUBE0_IBE0_SHIFT) & 0xff,\r\ntlb_47x_boltmap);\r\nif (mmube0 & MMUBE0_VBE1)\r\n__set_bit((mmube0 >> MMUBE0_IBE1_SHIFT) & 0xff,\r\ntlb_47x_boltmap);\r\nif (mmube0 & MMUBE0_VBE2)\r\n__set_bit((mmube0 >> MMUBE0_IBE2_SHIFT) & 0xff,\r\ntlb_47x_boltmap);\r\nif (mmube1 & MMUBE1_VBE3)\r\n__set_bit((mmube1 >> MMUBE1_IBE3_SHIFT) & 0xff,\r\ntlb_47x_boltmap);\r\nif (mmube1 & MMUBE1_VBE4)\r\n__set_bit((mmube1 >> MMUBE1_IBE4_SHIFT) & 0xff,\r\ntlb_47x_boltmap);\r\nif (mmube1 & MMUBE1_VBE5)\r\n__set_bit((mmube1 >> MMUBE1_IBE5_SHIFT) & 0xff,\r\ntlb_47x_boltmap);\r\n}\r\nstatic void ppc47x_pin_tlb(unsigned int virt, unsigned int phys)\r\n{\r\nunsigned int rA;\r\nint bolted;\r\nrA = 0x88000000;\r\nbolted = ppc47x_find_free_bolted();\r\nBUG_ON(bolted < 0);\r\nrA |= bolted << 24;\r\npr_debug("256M TLB entry for 0x%08x->0x%08x in bolt slot %d\n",\r\nvirt, phys, bolted);\r\nmtspr(SPRN_MMUCR, 0);\r\n__asm__ __volatile__(\r\n"tlbwe %2,%3,0\n"\r\n"tlbwe %1,%3,1\n"\r\n"tlbwe %0,%3,2\n"\r\n:\r\n: "r" (PPC47x_TLB2_SW | PPC47x_TLB2_SR |\r\nPPC47x_TLB2_SX\r\n#ifdef CONFIG_SMP\r\n| PPC47x_TLB2_M\r\n#endif\r\n),\r\n"r" (phys),\r\n"r" (virt | PPC47x_TLB0_VALID | PPC47x_TLB0_256M),\r\n"r" (rA));\r\n}\r\nvoid __init MMU_init_hw(void)\r\n{\r\nppc44x_update_tlb_hwater();\r\nflush_instruction_cache();\r\n}\r\nunsigned long __init mmu_mapin_ram(unsigned long top)\r\n{\r\nunsigned long addr;\r\nunsigned long memstart = memstart_addr & ~(PPC_PIN_SIZE - 1);\r\nfor (addr = memstart + PPC_PIN_SIZE; addr < lowmem_end_addr;\r\naddr += PPC_PIN_SIZE) {\r\nif (mmu_has_feature(MMU_FTR_TYPE_47x))\r\nppc47x_pin_tlb(addr + PAGE_OFFSET, addr);\r\nelse\r\nppc44x_pin_tlb(addr + PAGE_OFFSET, addr);\r\n}\r\nif (mmu_has_feature(MMU_FTR_TYPE_47x)) {\r\nppc47x_update_boltmap();\r\n#ifdef DEBUG\r\n{\r\nint i;\r\nprintk(KERN_DEBUG "bolted entries: ");\r\nfor (i = 0; i < 255; i++) {\r\nif (test_bit(i, tlb_47x_boltmap))\r\nprintk("%d ", i);\r\n}\r\nprintk("\n");\r\n}\r\n#endif\r\n}\r\nreturn total_lowmem;\r\n}\r\nvoid setup_initial_memory_limit(phys_addr_t first_memblock_base,\r\nphys_addr_t first_memblock_size)\r\n{\r\nu64 size;\r\n#ifndef CONFIG_NONSTATIC_KERNEL\r\nBUG_ON(first_memblock_base != 0);\r\n#endif\r\nsize = (min_t(u64, first_memblock_size, PPC_PIN_SIZE));\r\nmemblock_set_current_limit(first_memblock_base + size);\r\n}\r\nvoid mmu_init_secondary(int cpu)\r\n{\r\nunsigned long addr;\r\nunsigned long memstart = memstart_addr & ~(PPC_PIN_SIZE - 1);\r\nfor (addr = memstart + PPC_PIN_SIZE; addr < lowmem_end_addr;\r\naddr += PPC_PIN_SIZE) {\r\nif (mmu_has_feature(MMU_FTR_TYPE_47x))\r\nppc47x_pin_tlb(addr + PAGE_OFFSET, addr);\r\nelse\r\nppc44x_pin_tlb(addr + PAGE_OFFSET, addr);\r\n}\r\n}

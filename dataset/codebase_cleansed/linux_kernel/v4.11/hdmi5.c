static int hdmi_runtime_get(void)\r\n{\r\nint r;\r\nDSSDBG("hdmi_runtime_get\n");\r\nr = pm_runtime_get_sync(&hdmi.pdev->dev);\r\nWARN_ON(r < 0);\r\nif (r < 0)\r\nreturn r;\r\nreturn 0;\r\n}\r\nstatic void hdmi_runtime_put(void)\r\n{\r\nint r;\r\nDSSDBG("hdmi_runtime_put\n");\r\nr = pm_runtime_put_sync(&hdmi.pdev->dev);\r\nWARN_ON(r < 0 && r != -ENOSYS);\r\n}\r\nstatic irqreturn_t hdmi_irq_handler(int irq, void *data)\r\n{\r\nstruct hdmi_wp_data *wp = data;\r\nu32 irqstatus;\r\nirqstatus = hdmi_wp_get_irqstatus(wp);\r\nhdmi_wp_set_irqstatus(wp, irqstatus);\r\nif ((irqstatus & HDMI_IRQ_LINK_CONNECT) &&\r\nirqstatus & HDMI_IRQ_LINK_DISCONNECT) {\r\nu32 v;\r\nhdmi_wp_set_phy_pwr(wp, HDMI_PHYPWRCMD_OFF);\r\nv = hdmi_read_reg(hdmi.phy.base, HDMI_TXPHY_PAD_CFG_CTRL);\r\nv = FLD_MOD(v, 1, 15, 15);\r\nv = FLD_MOD(v, 0, 14, 7);\r\nhdmi_write_reg(hdmi.phy.base, HDMI_TXPHY_PAD_CFG_CTRL, v);\r\nhdmi_wp_set_irqstatus(wp, HDMI_IRQ_LINK_CONNECT |\r\nHDMI_IRQ_LINK_DISCONNECT);\r\nhdmi_wp_set_phy_pwr(wp, HDMI_PHYPWRCMD_LDOON);\r\nREG_FLD_MOD(hdmi.phy.base, HDMI_TXPHY_PAD_CFG_CTRL, 0, 15, 15);\r\n} else if (irqstatus & HDMI_IRQ_LINK_CONNECT) {\r\nhdmi_wp_set_phy_pwr(wp, HDMI_PHYPWRCMD_TXON);\r\n} else if (irqstatus & HDMI_IRQ_LINK_DISCONNECT) {\r\nhdmi_wp_set_phy_pwr(wp, HDMI_PHYPWRCMD_LDOON);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int hdmi_init_regulator(void)\r\n{\r\nstruct regulator *reg;\r\nif (hdmi.vdda_reg != NULL)\r\nreturn 0;\r\nreg = devm_regulator_get(&hdmi.pdev->dev, "vdda");\r\nif (IS_ERR(reg)) {\r\nDSSERR("can't get VDDA regulator\n");\r\nreturn PTR_ERR(reg);\r\n}\r\nhdmi.vdda_reg = reg;\r\nreturn 0;\r\n}\r\nstatic int hdmi_power_on_core(struct omap_dss_device *dssdev)\r\n{\r\nint r;\r\nr = regulator_enable(hdmi.vdda_reg);\r\nif (r)\r\nreturn r;\r\nr = hdmi_runtime_get();\r\nif (r)\r\ngoto err_runtime_get;\r\ndss_select_hdmi_venc_clk_source(DSS_HDMI_M_PCLK);\r\nhdmi.core_enabled = true;\r\nreturn 0;\r\nerr_runtime_get:\r\nregulator_disable(hdmi.vdda_reg);\r\nreturn r;\r\n}\r\nstatic void hdmi_power_off_core(struct omap_dss_device *dssdev)\r\n{\r\nhdmi.core_enabled = false;\r\nhdmi_runtime_put();\r\nregulator_disable(hdmi.vdda_reg);\r\n}\r\nstatic int hdmi_power_on_full(struct omap_dss_device *dssdev)\r\n{\r\nint r;\r\nstruct omap_video_timings *p;\r\nstruct omap_overlay_manager *mgr = hdmi.output.manager;\r\nstruct dss_pll_clock_info hdmi_cinfo = { 0 };\r\nr = hdmi_power_on_core(dssdev);\r\nif (r)\r\nreturn r;\r\np = &hdmi.cfg.timings;\r\nDSSDBG("hdmi_power_on x_res= %d y_res = %d\n", p->x_res, p->y_res);\r\nhdmi_pll_compute(&hdmi.pll, p->pixelclock, &hdmi_cinfo);\r\nhdmi_wp_clear_irqenable(&hdmi.wp, 0xffffffff);\r\nhdmi_wp_set_irqstatus(&hdmi.wp,\r\nhdmi_wp_get_irqstatus(&hdmi.wp));\r\nr = dss_pll_enable(&hdmi.pll.pll);\r\nif (r) {\r\nDSSERR("Failed to enable PLL\n");\r\ngoto err_pll_enable;\r\n}\r\nr = dss_pll_set_config(&hdmi.pll.pll, &hdmi_cinfo);\r\nif (r) {\r\nDSSERR("Failed to configure PLL\n");\r\ngoto err_pll_cfg;\r\n}\r\nr = hdmi_phy_configure(&hdmi.phy, hdmi_cinfo.clkdco,\r\nhdmi_cinfo.clkout[0]);\r\nif (r) {\r\nDSSDBG("Failed to start PHY\n");\r\ngoto err_phy_cfg;\r\n}\r\nr = hdmi_wp_set_phy_pwr(&hdmi.wp, HDMI_PHYPWRCMD_LDOON);\r\nif (r)\r\ngoto err_phy_pwr;\r\nhdmi5_configure(&hdmi.core, &hdmi.wp, &hdmi.cfg);\r\ndispc_enable_gamma_table(0);\r\ndss_mgr_set_timings(mgr, p);\r\nr = hdmi_wp_video_start(&hdmi.wp);\r\nif (r)\r\ngoto err_vid_enable;\r\nr = dss_mgr_enable(mgr);\r\nif (r)\r\ngoto err_mgr_enable;\r\nhdmi_wp_set_irqenable(&hdmi.wp,\r\nHDMI_IRQ_LINK_CONNECT | HDMI_IRQ_LINK_DISCONNECT);\r\nreturn 0;\r\nerr_mgr_enable:\r\nhdmi_wp_video_stop(&hdmi.wp);\r\nerr_vid_enable:\r\nhdmi_wp_set_phy_pwr(&hdmi.wp, HDMI_PHYPWRCMD_OFF);\r\nerr_phy_pwr:\r\nerr_phy_cfg:\r\nerr_pll_cfg:\r\ndss_pll_disable(&hdmi.pll.pll);\r\nerr_pll_enable:\r\nhdmi_power_off_core(dssdev);\r\nreturn -EIO;\r\n}\r\nstatic void hdmi_power_off_full(struct omap_dss_device *dssdev)\r\n{\r\nstruct omap_overlay_manager *mgr = hdmi.output.manager;\r\nhdmi_wp_clear_irqenable(&hdmi.wp, 0xffffffff);\r\ndss_mgr_disable(mgr);\r\nhdmi_wp_video_stop(&hdmi.wp);\r\nhdmi_wp_set_phy_pwr(&hdmi.wp, HDMI_PHYPWRCMD_OFF);\r\ndss_pll_disable(&hdmi.pll.pll);\r\nhdmi_power_off_core(dssdev);\r\n}\r\nstatic int hdmi_display_check_timing(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nstruct omap_dss_device *out = &hdmi.output;\r\nif (timings->interlace)\r\nreturn -EINVAL;\r\nif (!dispc_mgr_timings_ok(out->dispc_channel, timings))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic void hdmi_display_set_timing(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nmutex_lock(&hdmi.lock);\r\nhdmi.cfg.timings = *timings;\r\ndispc_set_tv_pclk(timings->pixelclock);\r\nmutex_unlock(&hdmi.lock);\r\n}\r\nstatic void hdmi_display_get_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\n*timings = hdmi.cfg.timings;\r\n}\r\nstatic void hdmi_dump_regs(struct seq_file *s)\r\n{\r\nmutex_lock(&hdmi.lock);\r\nif (hdmi_runtime_get()) {\r\nmutex_unlock(&hdmi.lock);\r\nreturn;\r\n}\r\nhdmi_wp_dump(&hdmi.wp, s);\r\nhdmi_pll_dump(&hdmi.pll, s);\r\nhdmi_phy_dump(&hdmi.phy, s);\r\nhdmi5_core_dump(&hdmi.core, s);\r\nhdmi_runtime_put();\r\nmutex_unlock(&hdmi.lock);\r\n}\r\nstatic int read_edid(u8 *buf, int len)\r\n{\r\nint r;\r\nint idlemode;\r\nmutex_lock(&hdmi.lock);\r\nr = hdmi_runtime_get();\r\nBUG_ON(r);\r\nidlemode = REG_GET(hdmi.wp.base, HDMI_WP_SYSCONFIG, 3, 2);\r\nREG_FLD_MOD(hdmi.wp.base, HDMI_WP_SYSCONFIG, 1, 3, 2);\r\nr = hdmi5_read_edid(&hdmi.core, buf, len);\r\nREG_FLD_MOD(hdmi.wp.base, HDMI_WP_SYSCONFIG, idlemode, 3, 2);\r\nhdmi_runtime_put();\r\nmutex_unlock(&hdmi.lock);\r\nreturn r;\r\n}\r\nstatic void hdmi_start_audio_stream(struct omap_hdmi *hd)\r\n{\r\nREG_FLD_MOD(hdmi.wp.base, HDMI_WP_SYSCONFIG, 1, 3, 2);\r\nhdmi_wp_audio_enable(&hd->wp, true);\r\nhdmi_wp_audio_core_req_enable(&hd->wp, true);\r\n}\r\nstatic void hdmi_stop_audio_stream(struct omap_hdmi *hd)\r\n{\r\nhdmi_wp_audio_core_req_enable(&hd->wp, false);\r\nhdmi_wp_audio_enable(&hd->wp, false);\r\nREG_FLD_MOD(hd->wp.base, HDMI_WP_SYSCONFIG, hd->wp_idlemode, 3, 2);\r\n}\r\nstatic int hdmi_display_enable(struct omap_dss_device *dssdev)\r\n{\r\nstruct omap_dss_device *out = &hdmi.output;\r\nunsigned long flags;\r\nint r = 0;\r\nDSSDBG("ENTER hdmi_display_enable\n");\r\nmutex_lock(&hdmi.lock);\r\nif (out->manager == NULL) {\r\nDSSERR("failed to enable display: no output/manager\n");\r\nr = -ENODEV;\r\ngoto err0;\r\n}\r\nr = hdmi_power_on_full(dssdev);\r\nif (r) {\r\nDSSERR("failed to power on device\n");\r\ngoto err0;\r\n}\r\nif (hdmi.audio_configured) {\r\nr = hdmi5_audio_config(&hdmi.core, &hdmi.wp, &hdmi.audio_config,\r\nhdmi.cfg.timings.pixelclock);\r\nif (r) {\r\nDSSERR("Error restoring audio configuration: %d", r);\r\nhdmi.audio_abort_cb(&hdmi.pdev->dev);\r\nhdmi.audio_configured = false;\r\n}\r\n}\r\nspin_lock_irqsave(&hdmi.audio_playing_lock, flags);\r\nif (hdmi.audio_configured && hdmi.audio_playing)\r\nhdmi_start_audio_stream(&hdmi);\r\nhdmi.display_enabled = true;\r\nspin_unlock_irqrestore(&hdmi.audio_playing_lock, flags);\r\nmutex_unlock(&hdmi.lock);\r\nreturn 0;\r\nerr0:\r\nmutex_unlock(&hdmi.lock);\r\nreturn r;\r\n}\r\nstatic void hdmi_display_disable(struct omap_dss_device *dssdev)\r\n{\r\nunsigned long flags;\r\nDSSDBG("Enter hdmi_display_disable\n");\r\nmutex_lock(&hdmi.lock);\r\nspin_lock_irqsave(&hdmi.audio_playing_lock, flags);\r\nhdmi_stop_audio_stream(&hdmi);\r\nhdmi.display_enabled = false;\r\nspin_unlock_irqrestore(&hdmi.audio_playing_lock, flags);\r\nhdmi_power_off_full(dssdev);\r\nmutex_unlock(&hdmi.lock);\r\n}\r\nstatic int hdmi_core_enable(struct omap_dss_device *dssdev)\r\n{\r\nint r = 0;\r\nDSSDBG("ENTER omapdss_hdmi_core_enable\n");\r\nmutex_lock(&hdmi.lock);\r\nr = hdmi_power_on_core(dssdev);\r\nif (r) {\r\nDSSERR("failed to power on device\n");\r\ngoto err0;\r\n}\r\nmutex_unlock(&hdmi.lock);\r\nreturn 0;\r\nerr0:\r\nmutex_unlock(&hdmi.lock);\r\nreturn r;\r\n}\r\nstatic void hdmi_core_disable(struct omap_dss_device *dssdev)\r\n{\r\nDSSDBG("Enter omapdss_hdmi_core_disable\n");\r\nmutex_lock(&hdmi.lock);\r\nhdmi_power_off_core(dssdev);\r\nmutex_unlock(&hdmi.lock);\r\n}\r\nstatic int hdmi_connect(struct omap_dss_device *dssdev,\r\nstruct omap_dss_device *dst)\r\n{\r\nstruct omap_overlay_manager *mgr;\r\nint r;\r\nr = hdmi_init_regulator();\r\nif (r)\r\nreturn r;\r\nmgr = omap_dss_get_overlay_manager(dssdev->dispc_channel);\r\nif (!mgr)\r\nreturn -ENODEV;\r\nr = dss_mgr_connect(mgr, dssdev);\r\nif (r)\r\nreturn r;\r\nr = omapdss_output_set_device(dssdev, dst);\r\nif (r) {\r\nDSSERR("failed to connect output to new device: %s\n",\r\ndst->name);\r\ndss_mgr_disconnect(mgr, dssdev);\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nstatic void hdmi_disconnect(struct omap_dss_device *dssdev,\r\nstruct omap_dss_device *dst)\r\n{\r\nWARN_ON(dst != dssdev->dst);\r\nif (dst != dssdev->dst)\r\nreturn;\r\nomapdss_output_unset_device(dssdev);\r\nif (dssdev->manager)\r\ndss_mgr_disconnect(dssdev->manager, dssdev);\r\n}\r\nstatic int hdmi_read_edid(struct omap_dss_device *dssdev,\r\nu8 *edid, int len)\r\n{\r\nbool need_enable;\r\nint r;\r\nneed_enable = hdmi.core_enabled == false;\r\nif (need_enable) {\r\nr = hdmi_core_enable(dssdev);\r\nif (r)\r\nreturn r;\r\n}\r\nr = read_edid(edid, len);\r\nif (need_enable)\r\nhdmi_core_disable(dssdev);\r\nreturn r;\r\n}\r\nstatic int hdmi_set_infoframe(struct omap_dss_device *dssdev,\r\nconst struct hdmi_avi_infoframe *avi)\r\n{\r\nhdmi.cfg.infoframe = *avi;\r\nreturn 0;\r\n}\r\nstatic int hdmi_set_hdmi_mode(struct omap_dss_device *dssdev,\r\nbool hdmi_mode)\r\n{\r\nhdmi.cfg.hdmi_dvi_mode = hdmi_mode ? HDMI_HDMI : HDMI_DVI;\r\nreturn 0;\r\n}\r\nstatic void hdmi_init_output(struct platform_device *pdev)\r\n{\r\nstruct omap_dss_device *out = &hdmi.output;\r\nout->dev = &pdev->dev;\r\nout->id = OMAP_DSS_OUTPUT_HDMI;\r\nout->output_type = OMAP_DISPLAY_TYPE_HDMI;\r\nout->name = "hdmi.0";\r\nout->dispc_channel = OMAP_DSS_CHANNEL_DIGIT;\r\nout->ops.hdmi = &hdmi_ops;\r\nout->owner = THIS_MODULE;\r\nomapdss_register_output(out);\r\n}\r\nstatic void hdmi_uninit_output(struct platform_device *pdev)\r\n{\r\nstruct omap_dss_device *out = &hdmi.output;\r\nomapdss_unregister_output(out);\r\n}\r\nstatic int hdmi_probe_of(struct platform_device *pdev)\r\n{\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct device_node *ep;\r\nint r;\r\nep = omapdss_of_get_first_endpoint(node);\r\nif (!ep)\r\nreturn 0;\r\nr = hdmi_parse_lanes_of(pdev, ep, &hdmi.phy);\r\nif (r)\r\ngoto err;\r\nof_node_put(ep);\r\nreturn 0;\r\nerr:\r\nof_node_put(ep);\r\nreturn r;\r\n}\r\nstatic int hdmi_audio_startup(struct device *dev,\r\nvoid (*abort_cb)(struct device *dev))\r\n{\r\nstruct omap_hdmi *hd = dev_get_drvdata(dev);\r\nint ret = 0;\r\nmutex_lock(&hd->lock);\r\nif (!hdmi_mode_has_audio(&hd->cfg) || !hd->display_enabled) {\r\nret = -EPERM;\r\ngoto out;\r\n}\r\nhd->audio_abort_cb = abort_cb;\r\nout:\r\nmutex_unlock(&hd->lock);\r\nreturn ret;\r\n}\r\nstatic int hdmi_audio_shutdown(struct device *dev)\r\n{\r\nstruct omap_hdmi *hd = dev_get_drvdata(dev);\r\nmutex_lock(&hd->lock);\r\nhd->audio_abort_cb = NULL;\r\nhd->audio_configured = false;\r\nhd->audio_playing = false;\r\nmutex_unlock(&hd->lock);\r\nreturn 0;\r\n}\r\nstatic int hdmi_audio_start(struct device *dev)\r\n{\r\nstruct omap_hdmi *hd = dev_get_drvdata(dev);\r\nunsigned long flags;\r\nWARN_ON(!hdmi_mode_has_audio(&hd->cfg));\r\nspin_lock_irqsave(&hd->audio_playing_lock, flags);\r\nif (hd->display_enabled)\r\nhdmi_start_audio_stream(hd);\r\nhd->audio_playing = true;\r\nspin_unlock_irqrestore(&hd->audio_playing_lock, flags);\r\nreturn 0;\r\n}\r\nstatic void hdmi_audio_stop(struct device *dev)\r\n{\r\nstruct omap_hdmi *hd = dev_get_drvdata(dev);\r\nunsigned long flags;\r\nWARN_ON(!hdmi_mode_has_audio(&hd->cfg));\r\nspin_lock_irqsave(&hd->audio_playing_lock, flags);\r\nif (hd->display_enabled)\r\nhdmi_stop_audio_stream(hd);\r\nhd->audio_playing = false;\r\nspin_unlock_irqrestore(&hd->audio_playing_lock, flags);\r\n}\r\nstatic int hdmi_audio_config(struct device *dev,\r\nstruct omap_dss_audio *dss_audio)\r\n{\r\nstruct omap_hdmi *hd = dev_get_drvdata(dev);\r\nint ret;\r\nmutex_lock(&hd->lock);\r\nif (!hdmi_mode_has_audio(&hd->cfg) || !hd->display_enabled) {\r\nret = -EPERM;\r\ngoto out;\r\n}\r\nret = hdmi5_audio_config(&hd->core, &hd->wp, dss_audio,\r\nhd->cfg.timings.pixelclock);\r\nif (!ret) {\r\nhd->audio_configured = true;\r\nhd->audio_config = *dss_audio;\r\n}\r\nout:\r\nmutex_unlock(&hd->lock);\r\nreturn ret;\r\n}\r\nstatic int hdmi_audio_register(struct device *dev)\r\n{\r\nstruct omap_hdmi_audio_pdata pdata = {\r\n.dev = dev,\r\n.dss_version = omapdss_get_version(),\r\n.audio_dma_addr = hdmi_wp_get_audio_dma_addr(&hdmi.wp),\r\n.ops = &hdmi_audio_ops,\r\n};\r\nhdmi.audio_pdev = platform_device_register_data(\r\ndev, "omap-hdmi-audio", PLATFORM_DEVID_AUTO,\r\n&pdata, sizeof(pdata));\r\nif (IS_ERR(hdmi.audio_pdev))\r\nreturn PTR_ERR(hdmi.audio_pdev);\r\nhdmi_runtime_get();\r\nhdmi.wp_idlemode =\r\nREG_GET(hdmi.wp.base, HDMI_WP_SYSCONFIG, 3, 2);\r\nhdmi_runtime_put();\r\nreturn 0;\r\n}\r\nstatic int hdmi5_bind(struct device *dev, struct device *master, void *data)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nint r;\r\nint irq;\r\nhdmi.pdev = pdev;\r\ndev_set_drvdata(&pdev->dev, &hdmi);\r\nmutex_init(&hdmi.lock);\r\nspin_lock_init(&hdmi.audio_playing_lock);\r\nif (pdev->dev.of_node) {\r\nr = hdmi_probe_of(pdev);\r\nif (r)\r\nreturn r;\r\n}\r\nr = hdmi_wp_init(pdev, &hdmi.wp);\r\nif (r)\r\nreturn r;\r\nr = hdmi_pll_init(pdev, &hdmi.pll, &hdmi.wp);\r\nif (r)\r\nreturn r;\r\nr = hdmi_phy_init(pdev, &hdmi.phy);\r\nif (r)\r\ngoto err;\r\nr = hdmi5_core_init(pdev, &hdmi.core);\r\nif (r)\r\ngoto err;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\nDSSERR("platform_get_irq failed\n");\r\nr = -ENODEV;\r\ngoto err;\r\n}\r\nr = devm_request_threaded_irq(&pdev->dev, irq,\r\nNULL, hdmi_irq_handler,\r\nIRQF_ONESHOT, "OMAP HDMI", &hdmi.wp);\r\nif (r) {\r\nDSSERR("HDMI IRQ request failed\n");\r\ngoto err;\r\n}\r\npm_runtime_enable(&pdev->dev);\r\nhdmi_init_output(pdev);\r\nr = hdmi_audio_register(&pdev->dev);\r\nif (r) {\r\nDSSERR("Registering HDMI audio failed %d\n", r);\r\nhdmi_uninit_output(pdev);\r\npm_runtime_disable(&pdev->dev);\r\nreturn r;\r\n}\r\ndss_debugfs_create_file("hdmi", hdmi_dump_regs);\r\nreturn 0;\r\nerr:\r\nhdmi_pll_uninit(&hdmi.pll);\r\nreturn r;\r\n}\r\nstatic void hdmi5_unbind(struct device *dev, struct device *master, void *data)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nif (hdmi.audio_pdev)\r\nplatform_device_unregister(hdmi.audio_pdev);\r\nhdmi_uninit_output(pdev);\r\nhdmi_pll_uninit(&hdmi.pll);\r\npm_runtime_disable(&pdev->dev);\r\n}\r\nstatic int hdmi5_probe(struct platform_device *pdev)\r\n{\r\nreturn component_add(&pdev->dev, &hdmi5_component_ops);\r\n}\r\nstatic int hdmi5_remove(struct platform_device *pdev)\r\n{\r\ncomponent_del(&pdev->dev, &hdmi5_component_ops);\r\nreturn 0;\r\n}\r\nstatic int hdmi_runtime_suspend(struct device *dev)\r\n{\r\ndispc_runtime_put();\r\nreturn 0;\r\n}\r\nstatic int hdmi_runtime_resume(struct device *dev)\r\n{\r\nint r;\r\nr = dispc_runtime_get();\r\nif (r < 0)\r\nreturn r;\r\nreturn 0;\r\n}\r\nint __init hdmi5_init_platform_driver(void)\r\n{\r\nreturn platform_driver_register(&omapdss_hdmihw_driver);\r\n}\r\nvoid hdmi5_uninit_platform_driver(void)\r\n{\r\nplatform_driver_unregister(&omapdss_hdmihw_driver);\r\n}

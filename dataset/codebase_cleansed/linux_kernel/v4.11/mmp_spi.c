static inline int lcd_spi_write(struct spi_device *spi, u32 data)\r\n{\r\nint timeout = 100000, isr, ret = 0;\r\nu32 tmp;\r\nvoid *reg_base =\r\n*(void **)spi_master_get_devdata(spi->master);\r\nwritel_relaxed(~SPI_IRQ_MASK, reg_base + SPU_IRQ_ISR);\r\nswitch (spi->bits_per_word) {\r\ncase 8:\r\nwritel_relaxed((u8)data, reg_base + LCD_SPU_SPI_TXDATA);\r\nbreak;\r\ncase 16:\r\nwritel_relaxed((u16)data, reg_base + LCD_SPU_SPI_TXDATA);\r\nbreak;\r\ncase 32:\r\nwritel_relaxed((u32)data, reg_base + LCD_SPU_SPI_TXDATA);\r\nbreak;\r\ndefault:\r\ndev_err(&spi->dev, "Wrong spi bit length\n");\r\n}\r\ntmp = readl_relaxed(reg_base + LCD_SPU_SPI_CTRL);\r\ntmp &= ~CFG_SPI_START_MASK;\r\ntmp |= CFG_SPI_START(1);\r\nwritel(tmp, reg_base + LCD_SPU_SPI_CTRL);\r\nisr = readl_relaxed(reg_base + SPU_IRQ_ISR);\r\nwhile (!(isr & SPI_IRQ_ENA_MASK)) {\r\nudelay(100);\r\nisr = readl_relaxed(reg_base + SPU_IRQ_ISR);\r\nif (!--timeout) {\r\nret = -ETIMEDOUT;\r\ndev_err(&spi->dev, "spi cmd send time out\n");\r\nbreak;\r\n}\r\n}\r\ntmp = readl_relaxed(reg_base + LCD_SPU_SPI_CTRL);\r\ntmp &= ~CFG_SPI_START_MASK;\r\ntmp |= CFG_SPI_START(0);\r\nwritel_relaxed(tmp, reg_base + LCD_SPU_SPI_CTRL);\r\nwritel_relaxed(~SPI_IRQ_MASK, reg_base + SPU_IRQ_ISR);\r\nreturn ret;\r\n}\r\nstatic int lcd_spi_setup(struct spi_device *spi)\r\n{\r\nvoid *reg_base =\r\n*(void **)spi_master_get_devdata(spi->master);\r\nu32 tmp;\r\ntmp = CFG_SCLKCNT(16) |\r\nCFG_TXBITS(spi->bits_per_word) |\r\nCFG_SPI_SEL(1) | CFG_SPI_ENA(1) |\r\nCFG_SPI_3W4WB(1);\r\nwritel(tmp, reg_base + LCD_SPU_SPI_CTRL);\r\ntmp = readl_relaxed(reg_base + SPU_IOPAD_CONTROL);\r\nif ((tmp & CFG_IOPADMODE_MASK) != IOPAD_DUMB18SPI)\r\nwritel_relaxed(IOPAD_DUMB18SPI |\r\n(tmp & ~CFG_IOPADMODE_MASK),\r\nreg_base + SPU_IOPAD_CONTROL);\r\nudelay(20);\r\nreturn 0;\r\n}\r\nstatic int lcd_spi_one_transfer(struct spi_device *spi, struct spi_message *m)\r\n{\r\nstruct spi_transfer *t;\r\nint i;\r\nlist_for_each_entry(t, &m->transfers, transfer_list) {\r\nswitch (spi->bits_per_word) {\r\ncase 8:\r\nfor (i = 0; i < t->len; i++)\r\nlcd_spi_write(spi, ((u8 *)t->tx_buf)[i]);\r\nbreak;\r\ncase 16:\r\nfor (i = 0; i < t->len/2; i++)\r\nlcd_spi_write(spi, ((u16 *)t->tx_buf)[i]);\r\nbreak;\r\ncase 32:\r\nfor (i = 0; i < t->len/4; i++)\r\nlcd_spi_write(spi, ((u32 *)t->tx_buf)[i]);\r\nbreak;\r\ndefault:\r\ndev_err(&spi->dev, "Wrong spi bit length\n");\r\n}\r\n}\r\nm->status = 0;\r\nif (m->complete)\r\nm->complete(m->context);\r\nreturn 0;\r\n}\r\nint lcd_spi_register(struct mmphw_ctrl *ctrl)\r\n{\r\nstruct spi_master *master;\r\nvoid **p_regbase;\r\nint err;\r\nmaster = spi_alloc_master(ctrl->dev, sizeof(void *));\r\nif (!master) {\r\ndev_err(ctrl->dev, "unable to allocate SPI master\n");\r\nreturn -ENOMEM;\r\n}\r\np_regbase = spi_master_get_devdata(master);\r\n*p_regbase = ctrl->reg_base;\r\nmaster->bus_num = 5;\r\nmaster->num_chipselect = 1;\r\nmaster->setup = lcd_spi_setup;\r\nmaster->transfer = lcd_spi_one_transfer;\r\nerr = spi_register_master(master);\r\nif (err < 0) {\r\ndev_err(ctrl->dev, "unable to register SPI master\n");\r\nspi_master_put(master);\r\nreturn err;\r\n}\r\ndev_info(&master->dev, "registered\n");\r\nreturn 0;\r\n}

static unsigned int\r\nebt_arpreply_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct ebt_arpreply_info *info = par->targinfo;\r\nconst __be32 *siptr, *diptr;\r\n__be32 _sip, _dip;\r\nconst struct arphdr *ap;\r\nstruct arphdr _ah;\r\nconst unsigned char *shp;\r\nunsigned char _sha[ETH_ALEN];\r\nap = skb_header_pointer(skb, 0, sizeof(_ah), &_ah);\r\nif (ap == NULL)\r\nreturn EBT_DROP;\r\nif (ap->ar_op != htons(ARPOP_REQUEST) ||\r\nap->ar_hln != ETH_ALEN ||\r\nap->ar_pro != htons(ETH_P_IP) ||\r\nap->ar_pln != 4)\r\nreturn EBT_CONTINUE;\r\nshp = skb_header_pointer(skb, sizeof(_ah), ETH_ALEN, &_sha);\r\nif (shp == NULL)\r\nreturn EBT_DROP;\r\nsiptr = skb_header_pointer(skb, sizeof(_ah) + ETH_ALEN,\r\nsizeof(_sip), &_sip);\r\nif (siptr == NULL)\r\nreturn EBT_DROP;\r\ndiptr = skb_header_pointer(skb,\r\nsizeof(_ah) + 2 * ETH_ALEN + sizeof(_sip),\r\nsizeof(_dip), &_dip);\r\nif (diptr == NULL)\r\nreturn EBT_DROP;\r\narp_send(ARPOP_REPLY, ETH_P_ARP, *siptr,\r\n(struct net_device *)xt_in(par),\r\n*diptr, shp, info->mac, shp);\r\nreturn info->target;\r\n}\r\nstatic int ebt_arpreply_tg_check(const struct xt_tgchk_param *par)\r\n{\r\nconst struct ebt_arpreply_info *info = par->targinfo;\r\nconst struct ebt_entry *e = par->entryinfo;\r\nif (BASE_CHAIN && info->target == EBT_RETURN)\r\nreturn -EINVAL;\r\nif (e->ethproto != htons(ETH_P_ARP) ||\r\ne->invflags & EBT_IPROTO)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int __init ebt_arpreply_init(void)\r\n{\r\nreturn xt_register_target(&ebt_arpreply_tg_reg);\r\n}\r\nstatic void __exit ebt_arpreply_fini(void)\r\n{\r\nxt_unregister_target(&ebt_arpreply_tg_reg);\r\n}

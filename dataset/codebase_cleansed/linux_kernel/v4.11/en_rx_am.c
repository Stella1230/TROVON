static inline struct mlx5e_cq_moder mlx5e_am_get_profile(u8 cq_period_mode, int ix)\r\n{\r\nreturn profile[cq_period_mode][ix];\r\n}\r\nstruct mlx5e_cq_moder mlx5e_am_get_def_profile(u8 rx_cq_period_mode)\r\n{\r\nint default_profile_ix;\r\nif (rx_cq_period_mode == MLX5_CQ_PERIOD_MODE_START_FROM_CQE)\r\ndefault_profile_ix = MLX5E_RX_AM_DEF_PROFILE_CQE;\r\nelse\r\ndefault_profile_ix = MLX5E_RX_AM_DEF_PROFILE_EQE;\r\nreturn profile[rx_cq_period_mode][default_profile_ix];\r\n}\r\nstatic bool mlx5e_am_on_top(struct mlx5e_rx_am *am)\r\n{\r\nswitch (am->tune_state) {\r\ncase MLX5E_AM_PARKING_ON_TOP:\r\ncase MLX5E_AM_PARKING_TIRED:\r\nreturn true;\r\ncase MLX5E_AM_GOING_RIGHT:\r\nreturn (am->steps_left > 1) && (am->steps_right == 1);\r\ndefault:\r\nreturn (am->steps_right > 1) && (am->steps_left == 1);\r\n}\r\n}\r\nstatic void mlx5e_am_turn(struct mlx5e_rx_am *am)\r\n{\r\nswitch (am->tune_state) {\r\ncase MLX5E_AM_PARKING_ON_TOP:\r\ncase MLX5E_AM_PARKING_TIRED:\r\nbreak;\r\ncase MLX5E_AM_GOING_RIGHT:\r\nam->tune_state = MLX5E_AM_GOING_LEFT;\r\nam->steps_left = 0;\r\nbreak;\r\ncase MLX5E_AM_GOING_LEFT:\r\nam->tune_state = MLX5E_AM_GOING_RIGHT;\r\nam->steps_right = 0;\r\nbreak;\r\n}\r\n}\r\nstatic int mlx5e_am_step(struct mlx5e_rx_am *am)\r\n{\r\nif (am->tired == (MLX5E_PARAMS_AM_NUM_PROFILES * 2))\r\nreturn MLX5E_AM_TOO_TIRED;\r\nswitch (am->tune_state) {\r\ncase MLX5E_AM_PARKING_ON_TOP:\r\ncase MLX5E_AM_PARKING_TIRED:\r\nbreak;\r\ncase MLX5E_AM_GOING_RIGHT:\r\nif (am->profile_ix == (MLX5E_PARAMS_AM_NUM_PROFILES - 1))\r\nreturn MLX5E_AM_ON_EDGE;\r\nam->profile_ix++;\r\nam->steps_right++;\r\nbreak;\r\ncase MLX5E_AM_GOING_LEFT:\r\nif (am->profile_ix == 0)\r\nreturn MLX5E_AM_ON_EDGE;\r\nam->profile_ix--;\r\nam->steps_left++;\r\nbreak;\r\n}\r\nam->tired++;\r\nreturn MLX5E_AM_STEPPED;\r\n}\r\nstatic void mlx5e_am_park_on_top(struct mlx5e_rx_am *am)\r\n{\r\nam->steps_right = 0;\r\nam->steps_left = 0;\r\nam->tired = 0;\r\nam->tune_state = MLX5E_AM_PARKING_ON_TOP;\r\n}\r\nstatic void mlx5e_am_park_tired(struct mlx5e_rx_am *am)\r\n{\r\nam->steps_right = 0;\r\nam->steps_left = 0;\r\nam->tune_state = MLX5E_AM_PARKING_TIRED;\r\n}\r\nstatic void mlx5e_am_exit_parking(struct mlx5e_rx_am *am)\r\n{\r\nam->tune_state = am->profile_ix ? MLX5E_AM_GOING_LEFT :\r\nMLX5E_AM_GOING_RIGHT;\r\nmlx5e_am_step(am);\r\n}\r\nstatic int mlx5e_am_stats_compare(struct mlx5e_rx_am_stats *curr,\r\nstruct mlx5e_rx_am_stats *prev)\r\n{\r\nint diff;\r\nif (!prev->ppms)\r\nreturn curr->ppms ? MLX5E_AM_STATS_BETTER :\r\nMLX5E_AM_STATS_SAME;\r\ndiff = curr->ppms - prev->ppms;\r\nif (((100 * abs(diff)) / prev->ppms) > 10)\r\nreturn (diff > 0) ? MLX5E_AM_STATS_BETTER :\r\nMLX5E_AM_STATS_WORSE;\r\nif (!prev->epms)\r\nreturn curr->epms ? MLX5E_AM_STATS_WORSE :\r\nMLX5E_AM_STATS_SAME;\r\ndiff = curr->epms - prev->epms;\r\nif (((100 * abs(diff)) / prev->epms) > 10)\r\nreturn (diff < 0) ? MLX5E_AM_STATS_BETTER :\r\nMLX5E_AM_STATS_WORSE;\r\nreturn MLX5E_AM_STATS_SAME;\r\n}\r\nstatic bool mlx5e_am_decision(struct mlx5e_rx_am_stats *curr_stats,\r\nstruct mlx5e_rx_am *am)\r\n{\r\nint prev_state = am->tune_state;\r\nint prev_ix = am->profile_ix;\r\nint stats_res;\r\nint step_res;\r\nswitch (am->tune_state) {\r\ncase MLX5E_AM_PARKING_ON_TOP:\r\nstats_res = mlx5e_am_stats_compare(curr_stats, &am->prev_stats);\r\nif (stats_res != MLX5E_AM_STATS_SAME)\r\nmlx5e_am_exit_parking(am);\r\nbreak;\r\ncase MLX5E_AM_PARKING_TIRED:\r\nam->tired--;\r\nif (!am->tired)\r\nmlx5e_am_exit_parking(am);\r\nbreak;\r\ncase MLX5E_AM_GOING_RIGHT:\r\ncase MLX5E_AM_GOING_LEFT:\r\nstats_res = mlx5e_am_stats_compare(curr_stats, &am->prev_stats);\r\nif (stats_res != MLX5E_AM_STATS_BETTER)\r\nmlx5e_am_turn(am);\r\nif (mlx5e_am_on_top(am)) {\r\nmlx5e_am_park_on_top(am);\r\nbreak;\r\n}\r\nstep_res = mlx5e_am_step(am);\r\nswitch (step_res) {\r\ncase MLX5E_AM_ON_EDGE:\r\nmlx5e_am_park_on_top(am);\r\nbreak;\r\ncase MLX5E_AM_TOO_TIRED:\r\nmlx5e_am_park_tired(am);\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nif ((prev_state != MLX5E_AM_PARKING_ON_TOP) ||\r\n(am->tune_state != MLX5E_AM_PARKING_ON_TOP))\r\nam->prev_stats = *curr_stats;\r\nreturn am->profile_ix != prev_ix;\r\n}\r\nstatic void mlx5e_am_sample(struct mlx5e_rq *rq,\r\nstruct mlx5e_rx_am_sample *s)\r\n{\r\ns->time = ktime_get();\r\ns->pkt_ctr = rq->stats.packets;\r\ns->event_ctr = rq->cq.event_ctr;\r\n}\r\nstatic void mlx5e_am_calc_stats(struct mlx5e_rx_am_sample *start,\r\nstruct mlx5e_rx_am_sample *end,\r\nstruct mlx5e_rx_am_stats *curr_stats)\r\n{\r\nu32 delta_us = ktime_us_delta(end->time, start->time);\r\nunsigned int npkts = end->pkt_ctr - start->pkt_ctr;\r\nif (!delta_us)\r\nreturn;\r\ncurr_stats->ppms = (npkts * USEC_PER_MSEC) / delta_us;\r\ncurr_stats->epms = (MLX5E_AM_NEVENTS * USEC_PER_MSEC) / delta_us;\r\n}\r\nvoid mlx5e_rx_am_work(struct work_struct *work)\r\n{\r\nstruct mlx5e_rx_am *am = container_of(work, struct mlx5e_rx_am,\r\nwork);\r\nstruct mlx5e_rq *rq = container_of(am, struct mlx5e_rq, am);\r\nstruct mlx5e_cq_moder cur_profile = profile[am->mode][am->profile_ix];\r\nmlx5_core_modify_cq_moderation(rq->priv->mdev, &rq->cq.mcq,\r\ncur_profile.usec, cur_profile.pkts);\r\nam->state = MLX5E_AM_START_MEASURE;\r\n}\r\nvoid mlx5e_rx_am(struct mlx5e_rq *rq)\r\n{\r\nstruct mlx5e_rx_am *am = &rq->am;\r\nstruct mlx5e_rx_am_sample end_sample;\r\nstruct mlx5e_rx_am_stats curr_stats;\r\nu16 nevents;\r\nswitch (am->state) {\r\ncase MLX5E_AM_MEASURE_IN_PROGRESS:\r\nnevents = rq->cq.event_ctr - am->start_sample.event_ctr;\r\nif (nevents < MLX5E_AM_NEVENTS)\r\nbreak;\r\nmlx5e_am_sample(rq, &end_sample);\r\nmlx5e_am_calc_stats(&am->start_sample, &end_sample,\r\n&curr_stats);\r\nif (mlx5e_am_decision(&curr_stats, am)) {\r\nam->state = MLX5E_AM_APPLY_NEW_PROFILE;\r\nschedule_work(&am->work);\r\nbreak;\r\n}\r\ncase MLX5E_AM_START_MEASURE:\r\nmlx5e_am_sample(rq, &am->start_sample);\r\nam->state = MLX5E_AM_MEASURE_IN_PROGRESS;\r\nbreak;\r\ncase MLX5E_AM_APPLY_NEW_PROFILE:\r\nbreak;\r\n}\r\n}

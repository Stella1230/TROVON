static int atmel_pcm_preallocate_dma_buffer(struct snd_pcm *pcm,\r\nint stream)\r\n{\r\nstruct snd_pcm_substream *substream = pcm->streams[stream].substream;\r\nstruct snd_dma_buffer *buf = &substream->dma_buffer;\r\nsize_t size = ATMEL_SSC_DMABUF_SIZE;\r\nbuf->dev.type = SNDRV_DMA_TYPE_DEV;\r\nbuf->dev.dev = pcm->card->dev;\r\nbuf->private_data = NULL;\r\nbuf->area = dma_alloc_coherent(pcm->card->dev, size,\r\n&buf->addr, GFP_KERNEL);\r\npr_debug("atmel-pcm: alloc dma buffer: area=%p, addr=%p, size=%zu\n",\r\n(void *)buf->area, (void *)(long)buf->addr, size);\r\nif (!buf->area)\r\nreturn -ENOMEM;\r\nbuf->bytes = size;\r\nreturn 0;\r\n}\r\nstatic int atmel_pcm_mmap(struct snd_pcm_substream *substream,\r\nstruct vm_area_struct *vma)\r\n{\r\nreturn remap_pfn_range(vma, vma->vm_start,\r\nsubstream->dma_buffer.addr >> PAGE_SHIFT,\r\nvma->vm_end - vma->vm_start, vma->vm_page_prot);\r\n}\r\nstatic int atmel_pcm_new(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_card *card = rtd->card->snd_card;\r\nstruct snd_pcm *pcm = rtd->pcm;\r\nint ret;\r\nret = dma_coerce_mask_and_coherent(card->dev, DMA_BIT_MASK(32));\r\nif (ret)\r\nreturn ret;\r\nif (pcm->streams[SNDRV_PCM_STREAM_PLAYBACK].substream) {\r\npr_debug("atmel-pcm: allocating PCM playback DMA buffer\n");\r\nret = atmel_pcm_preallocate_dma_buffer(pcm,\r\nSNDRV_PCM_STREAM_PLAYBACK);\r\nif (ret)\r\ngoto out;\r\n}\r\nif (pcm->streams[SNDRV_PCM_STREAM_CAPTURE].substream) {\r\npr_debug("atmel-pcm: allocating PCM capture DMA buffer\n");\r\nret = atmel_pcm_preallocate_dma_buffer(pcm,\r\nSNDRV_PCM_STREAM_CAPTURE);\r\nif (ret)\r\ngoto out;\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nstatic void atmel_pcm_free(struct snd_pcm *pcm)\r\n{\r\nstruct snd_pcm_substream *substream;\r\nstruct snd_dma_buffer *buf;\r\nint stream;\r\nfor (stream = 0; stream < 2; stream++) {\r\nsubstream = pcm->streams[stream].substream;\r\nif (!substream)\r\ncontinue;\r\nbuf = &substream->dma_buffer;\r\nif (!buf->area)\r\ncontinue;\r\ndma_free_coherent(pcm->card->dev, buf->bytes,\r\nbuf->area, buf->addr);\r\nbuf->area = NULL;\r\n}\r\n}\r\nstatic void atmel_pcm_dma_irq(u32 ssc_sr,\r\nstruct snd_pcm_substream *substream)\r\n{\r\nstruct atmel_runtime_data *prtd = substream->runtime->private_data;\r\nstruct atmel_pcm_dma_params *params = prtd->params;\r\nstatic int count;\r\ncount++;\r\nif (ssc_sr & params->mask->ssc_endbuf) {\r\npr_warn("atmel-pcm: buffer %s on %s (SSC_SR=%#x, count=%d)\n",\r\nsubstream->stream == SNDRV_PCM_STREAM_PLAYBACK\r\n? "underrun" : "overrun",\r\nparams->name, ssc_sr, count);\r\nssc_writex(params->ssc->regs, ATMEL_PDC_PTCR,\r\nparams->mask->pdc_disable);\r\nprtd->period_ptr += prtd->period_size;\r\nif (prtd->period_ptr >= prtd->dma_buffer_end)\r\nprtd->period_ptr = prtd->dma_buffer;\r\nssc_writex(params->ssc->regs, params->pdc->xpr,\r\nprtd->period_ptr);\r\nssc_writex(params->ssc->regs, params->pdc->xcr,\r\nprtd->period_size / params->pdc_xfer_size);\r\nssc_writex(params->ssc->regs, ATMEL_PDC_PTCR,\r\nparams->mask->pdc_enable);\r\n}\r\nif (ssc_sr & params->mask->ssc_endx) {\r\nprtd->period_ptr += prtd->period_size;\r\nif (prtd->period_ptr >= prtd->dma_buffer_end)\r\nprtd->period_ptr = prtd->dma_buffer;\r\nssc_writex(params->ssc->regs, params->pdc->xnpr,\r\nprtd->period_ptr);\r\nssc_writex(params->ssc->regs, params->pdc->xncr,\r\nprtd->period_size / params->pdc_xfer_size);\r\n}\r\nsnd_pcm_period_elapsed(substream);\r\n}\r\nstatic int atmel_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct atmel_runtime_data *prtd = runtime->private_data;\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nsnd_pcm_set_runtime_buffer(substream, &substream->dma_buffer);\r\nruntime->dma_bytes = params_buffer_bytes(params);\r\nprtd->params = snd_soc_dai_get_dma_data(rtd->cpu_dai, substream);\r\nprtd->params->dma_intr_handler = atmel_pcm_dma_irq;\r\nprtd->dma_buffer = runtime->dma_addr;\r\nprtd->dma_buffer_end = runtime->dma_addr + runtime->dma_bytes;\r\nprtd->period_size = params_period_bytes(params);\r\npr_debug("atmel-pcm: "\r\n"hw_params: DMA for %s initialized "\r\n"(dma_bytes=%zu, period_size=%zu)\n",\r\nprtd->params->name,\r\nruntime->dma_bytes,\r\nprtd->period_size);\r\nreturn 0;\r\n}\r\nstatic int atmel_pcm_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct atmel_runtime_data *prtd = substream->runtime->private_data;\r\nstruct atmel_pcm_dma_params *params = prtd->params;\r\nif (params != NULL) {\r\nssc_writex(params->ssc->regs, SSC_PDC_PTCR,\r\nparams->mask->pdc_disable);\r\nprtd->params->dma_intr_handler = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int atmel_pcm_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct atmel_runtime_data *prtd = substream->runtime->private_data;\r\nstruct atmel_pcm_dma_params *params = prtd->params;\r\nssc_writex(params->ssc->regs, SSC_IDR,\r\nparams->mask->ssc_endx | params->mask->ssc_endbuf);\r\nssc_writex(params->ssc->regs, ATMEL_PDC_PTCR,\r\nparams->mask->pdc_disable);\r\nreturn 0;\r\n}\r\nstatic int atmel_pcm_trigger(struct snd_pcm_substream *substream,\r\nint cmd)\r\n{\r\nstruct snd_pcm_runtime *rtd = substream->runtime;\r\nstruct atmel_runtime_data *prtd = rtd->private_data;\r\nstruct atmel_pcm_dma_params *params = prtd->params;\r\nint ret = 0;\r\npr_debug("atmel-pcm:buffer_size = %ld,"\r\n"dma_area = %p, dma_bytes = %zu\n",\r\nrtd->buffer_size, rtd->dma_area, rtd->dma_bytes);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nprtd->period_ptr = prtd->dma_buffer;\r\nssc_writex(params->ssc->regs, params->pdc->xpr,\r\nprtd->period_ptr);\r\nssc_writex(params->ssc->regs, params->pdc->xcr,\r\nprtd->period_size / params->pdc_xfer_size);\r\nprtd->period_ptr += prtd->period_size;\r\nssc_writex(params->ssc->regs, params->pdc->xnpr,\r\nprtd->period_ptr);\r\nssc_writex(params->ssc->regs, params->pdc->xncr,\r\nprtd->period_size / params->pdc_xfer_size);\r\npr_debug("atmel-pcm: trigger: "\r\n"period_ptr=%lx, xpr=%u, "\r\n"xcr=%u, xnpr=%u, xncr=%u\n",\r\n(unsigned long)prtd->period_ptr,\r\nssc_readx(params->ssc->regs, params->pdc->xpr),\r\nssc_readx(params->ssc->regs, params->pdc->xcr),\r\nssc_readx(params->ssc->regs, params->pdc->xnpr),\r\nssc_readx(params->ssc->regs, params->pdc->xncr));\r\nssc_writex(params->ssc->regs, SSC_IER,\r\nparams->mask->ssc_endx | params->mask->ssc_endbuf);\r\nssc_writex(params->ssc->regs, SSC_PDC_PTCR,\r\nparams->mask->pdc_enable);\r\npr_debug("sr=%u imr=%u\n",\r\nssc_readx(params->ssc->regs, SSC_SR),\r\nssc_readx(params->ssc->regs, SSC_IER));\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nssc_writex(params->ssc->regs, ATMEL_PDC_PTCR,\r\nparams->mask->pdc_disable);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nssc_writex(params->ssc->regs, ATMEL_PDC_PTCR,\r\nparams->mask->pdc_enable);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic snd_pcm_uframes_t atmel_pcm_pointer(\r\nstruct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct atmel_runtime_data *prtd = runtime->private_data;\r\nstruct atmel_pcm_dma_params *params = prtd->params;\r\ndma_addr_t ptr;\r\nsnd_pcm_uframes_t x;\r\nptr = (dma_addr_t) ssc_readx(params->ssc->regs, params->pdc->xpr);\r\nx = bytes_to_frames(runtime, ptr - prtd->dma_buffer);\r\nif (x == runtime->buffer_size)\r\nx = 0;\r\nreturn x;\r\n}\r\nstatic int atmel_pcm_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct atmel_runtime_data *prtd;\r\nint ret = 0;\r\nsnd_soc_set_runtime_hwparams(substream, &atmel_pcm_hardware);\r\nret = snd_pcm_hw_constraint_integer(runtime,\r\nSNDRV_PCM_HW_PARAM_PERIODS);\r\nif (ret < 0)\r\ngoto out;\r\nprtd = kzalloc(sizeof(struct atmel_runtime_data), GFP_KERNEL);\r\nif (prtd == NULL) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nruntime->private_data = prtd;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int atmel_pcm_close(struct snd_pcm_substream *substream)\r\n{\r\nstruct atmel_runtime_data *prtd = substream->runtime->private_data;\r\nkfree(prtd);\r\nreturn 0;\r\n}\r\nint atmel_pcm_pdc_platform_register(struct device *dev)\r\n{\r\nreturn snd_soc_register_platform(dev, &atmel_soc_platform);\r\n}\r\nvoid atmel_pcm_pdc_platform_unregister(struct device *dev)\r\n{\r\nsnd_soc_unregister_platform(dev);\r\n}

static int rv3029_read_regs(struct device *dev, u8 reg, u8 *buf,\r\nunsigned int len)\r\n{\r\nstruct rv3029_data *rv3029 = dev_get_drvdata(dev);\r\nif ((reg > RV3029_USR1_RAM_PAGE + 7) ||\r\n(reg + len > RV3029_USR1_RAM_PAGE + 8))\r\nreturn -EINVAL;\r\nreturn regmap_bulk_read(rv3029->regmap, reg, buf, len);\r\n}\r\nstatic int rv3029_write_regs(struct device *dev, u8 reg, u8 const buf[],\r\nunsigned int len)\r\n{\r\nstruct rv3029_data *rv3029 = dev_get_drvdata(dev);\r\nif ((reg > RV3029_USR1_RAM_PAGE + 7) ||\r\n(reg + len > RV3029_USR1_RAM_PAGE + 8))\r\nreturn -EINVAL;\r\nreturn regmap_bulk_write(rv3029->regmap, reg, buf, len);\r\n}\r\nstatic int rv3029_update_bits(struct device *dev, u8 reg, u8 mask, u8 set)\r\n{\r\nu8 buf;\r\nint ret;\r\nret = rv3029_read_regs(dev, reg, &buf, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nbuf &= ~mask;\r\nbuf |= set & mask;\r\nret = rv3029_write_regs(dev, reg, &buf, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int rv3029_get_sr(struct device *dev, u8 *buf)\r\n{\r\nint ret = rv3029_read_regs(dev, RV3029_STATUS, buf, 1);\r\nif (ret < 0)\r\nreturn -EIO;\r\ndev_dbg(dev, "status = 0x%.2x (%d)\n", buf[0], buf[0]);\r\nreturn 0;\r\n}\r\nstatic int rv3029_set_sr(struct device *dev, u8 val)\r\n{\r\nu8 buf[1];\r\nint sr;\r\nbuf[0] = val;\r\nsr = rv3029_write_regs(dev, RV3029_STATUS, buf, 1);\r\ndev_dbg(dev, "status = 0x%.2x (%d)\n", buf[0], buf[0]);\r\nif (sr < 0)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int rv3029_eeprom_busywait(struct device *dev)\r\n{\r\nint i, ret;\r\nu8 sr;\r\nfor (i = 100; i > 0; i--) {\r\nret = rv3029_get_sr(dev, &sr);\r\nif (ret < 0)\r\nbreak;\r\nif (!(sr & RV3029_STATUS_EEBUSY))\r\nbreak;\r\nusleep_range(1000, 10000);\r\n}\r\nif (i <= 0) {\r\ndev_err(dev, "EEPROM busy wait timeout.\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn ret;\r\n}\r\nstatic int rv3029_eeprom_exit(struct device *dev)\r\n{\r\nreturn rv3029_update_bits(dev, RV3029_ONOFF_CTRL,\r\nRV3029_ONOFF_CTRL_EERE,\r\nRV3029_ONOFF_CTRL_EERE);\r\n}\r\nstatic int rv3029_eeprom_enter(struct device *dev)\r\n{\r\nint ret;\r\nu8 sr;\r\nret = rv3029_get_sr(dev, &sr);\r\nif (ret < 0)\r\nreturn ret;\r\nif (sr & (RV3029_STATUS_VLOW1 | RV3029_STATUS_VLOW2)) {\r\nsr &= ~RV3029_STATUS_VLOW1;\r\nsr &= ~RV3029_STATUS_VLOW2;\r\nret = rv3029_set_sr(dev, sr);\r\nif (ret < 0)\r\nreturn ret;\r\nusleep_range(1000, 10000);\r\nret = rv3029_get_sr(dev, &sr);\r\nif (ret < 0)\r\nreturn ret;\r\nif (sr & (RV3029_STATUS_VLOW1 | RV3029_STATUS_VLOW2)) {\r\ndev_err(dev,\r\n"Supply voltage is too low to safely access the EEPROM.\n");\r\nreturn -ENODEV;\r\n}\r\n}\r\nret = rv3029_update_bits(dev, RV3029_ONOFF_CTRL, RV3029_ONOFF_CTRL_EERE,\r\n0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = rv3029_eeprom_busywait(dev);\r\nif (ret < 0)\r\nrv3029_eeprom_exit(dev);\r\nreturn ret;\r\n}\r\nstatic int rv3029_eeprom_read(struct device *dev, u8 reg,\r\nu8 buf[], size_t len)\r\n{\r\nint ret, err;\r\nerr = rv3029_eeprom_enter(dev);\r\nif (err < 0)\r\nreturn err;\r\nret = rv3029_read_regs(dev, reg, buf, len);\r\nerr = rv3029_eeprom_exit(dev);\r\nif (err < 0)\r\nreturn err;\r\nreturn ret;\r\n}\r\nstatic int rv3029_eeprom_write(struct device *dev, u8 reg,\r\nu8 const buf[], size_t len)\r\n{\r\nint ret, err;\r\nsize_t i;\r\nu8 tmp;\r\nerr = rv3029_eeprom_enter(dev);\r\nif (err < 0)\r\nreturn err;\r\nfor (i = 0; i < len; i++, reg++) {\r\nret = rv3029_read_regs(dev, reg, &tmp, 1);\r\nif (ret < 0)\r\nbreak;\r\nif (tmp != buf[i]) {\r\nret = rv3029_write_regs(dev, reg, &buf[i], 1);\r\nif (ret < 0)\r\nbreak;\r\n}\r\nret = rv3029_eeprom_busywait(dev);\r\nif (ret < 0)\r\nbreak;\r\n}\r\nerr = rv3029_eeprom_exit(dev);\r\nif (err < 0)\r\nreturn err;\r\nreturn ret;\r\n}\r\nstatic int rv3029_eeprom_update_bits(struct device *dev,\r\nu8 reg, u8 mask, u8 set)\r\n{\r\nu8 buf;\r\nint ret;\r\nret = rv3029_eeprom_read(dev, reg, &buf, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nbuf &= ~mask;\r\nbuf |= set & mask;\r\nret = rv3029_eeprom_write(dev, reg, &buf, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t rv3029_handle_irq(int irq, void *dev_id)\r\n{\r\nstruct device *dev = dev_id;\r\nstruct rv3029_data *rv3029 = dev_get_drvdata(dev);\r\nstruct mutex *lock = &rv3029->rtc->ops_lock;\r\nunsigned long events = 0;\r\nu8 flags, controls;\r\nint ret;\r\nmutex_lock(lock);\r\nret = rv3029_read_regs(dev, RV3029_IRQ_CTRL, &controls, 1);\r\nif (ret) {\r\ndev_warn(dev, "Read IRQ Control Register error %d\n", ret);\r\nmutex_unlock(lock);\r\nreturn IRQ_NONE;\r\n}\r\nret = rv3029_read_regs(dev, RV3029_IRQ_FLAGS, &flags, 1);\r\nif (ret) {\r\ndev_warn(dev, "Read IRQ Flags Register error %d\n", ret);\r\nmutex_unlock(lock);\r\nreturn IRQ_NONE;\r\n}\r\nif (flags & RV3029_IRQ_FLAGS_AF) {\r\nflags &= ~RV3029_IRQ_FLAGS_AF;\r\ncontrols &= ~RV3029_IRQ_CTRL_AIE;\r\nevents |= RTC_AF;\r\n}\r\nif (events) {\r\nrtc_update_irq(rv3029->rtc, 1, events);\r\nrv3029_write_regs(dev, RV3029_IRQ_FLAGS, &flags, 1);\r\nrv3029_write_regs(dev, RV3029_IRQ_CTRL, &controls, 1);\r\n}\r\nmutex_unlock(lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int rv3029_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nu8 buf[1];\r\nint ret;\r\nu8 regs[RV3029_WATCH_SECTION_LEN] = { 0, };\r\nret = rv3029_get_sr(dev, buf);\r\nif (ret < 0) {\r\ndev_err(dev, "%s: reading SR failed\n", __func__);\r\nreturn -EIO;\r\n}\r\nret = rv3029_read_regs(dev, RV3029_W_SEC, regs,\r\nRV3029_WATCH_SECTION_LEN);\r\nif (ret < 0) {\r\ndev_err(dev, "%s: reading RTC section failed\n", __func__);\r\nreturn ret;\r\n}\r\ntm->tm_sec = bcd2bin(regs[RV3029_W_SEC - RV3029_W_SEC]);\r\ntm->tm_min = bcd2bin(regs[RV3029_W_MINUTES - RV3029_W_SEC]);\r\n{\r\nconst u8 _hr = regs[RV3029_W_HOURS - RV3029_W_SEC];\r\nif (_hr & RV3029_REG_HR_12_24) {\r\ntm->tm_hour = bcd2bin(_hr & 0x1f);\r\nif (_hr & RV3029_REG_HR_PM)\r\ntm->tm_hour += 12;\r\n} else\r\ntm->tm_hour = bcd2bin(_hr & 0x3f);\r\n}\r\ntm->tm_mday = bcd2bin(regs[RV3029_W_DATE - RV3029_W_SEC]);\r\ntm->tm_mon = bcd2bin(regs[RV3029_W_MONTHS - RV3029_W_SEC]) - 1;\r\ntm->tm_year = bcd2bin(regs[RV3029_W_YEARS - RV3029_W_SEC]) + 100;\r\ntm->tm_wday = bcd2bin(regs[RV3029_W_DAYS - RV3029_W_SEC]) - 1;\r\nreturn 0;\r\n}\r\nstatic int rv3029_read_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nstruct rtc_time *const tm = &alarm->time;\r\nint ret;\r\nu8 regs[8], controls, flags;\r\nret = rv3029_get_sr(dev, regs);\r\nif (ret < 0) {\r\ndev_err(dev, "%s: reading SR failed\n", __func__);\r\nreturn -EIO;\r\n}\r\nret = rv3029_read_regs(dev, RV3029_A_SC, regs,\r\nRV3029_ALARM_SECTION_LEN);\r\nif (ret < 0) {\r\ndev_err(dev, "%s: reading alarm section failed\n", __func__);\r\nreturn ret;\r\n}\r\nret = rv3029_read_regs(dev, RV3029_IRQ_CTRL, &controls, 1);\r\nif (ret) {\r\ndev_err(dev, "Read IRQ Control Register error %d\n", ret);\r\nreturn ret;\r\n}\r\nret = rv3029_read_regs(dev, RV3029_IRQ_FLAGS, &flags, 1);\r\nif (ret < 0) {\r\ndev_err(dev, "Read IRQ Flags Register error %d\n", ret);\r\nreturn ret;\r\n}\r\ntm->tm_sec = bcd2bin(regs[RV3029_A_SC - RV3029_A_SC] & 0x7f);\r\ntm->tm_min = bcd2bin(regs[RV3029_A_MN - RV3029_A_SC] & 0x7f);\r\ntm->tm_hour = bcd2bin(regs[RV3029_A_HR - RV3029_A_SC] & 0x3f);\r\ntm->tm_mday = bcd2bin(regs[RV3029_A_DT - RV3029_A_SC] & 0x3f);\r\ntm->tm_mon = bcd2bin(regs[RV3029_A_MO - RV3029_A_SC] & 0x1f) - 1;\r\ntm->tm_year = bcd2bin(regs[RV3029_A_YR - RV3029_A_SC] & 0x7f) + 100;\r\ntm->tm_wday = bcd2bin(regs[RV3029_A_DW - RV3029_A_SC] & 0x07) - 1;\r\nalarm->enabled = !!(controls & RV3029_IRQ_CTRL_AIE);\r\nalarm->pending = (flags & RV3029_IRQ_FLAGS_AF) && alarm->enabled;\r\nreturn 0;\r\n}\r\nstatic int rv3029_alarm_irq_enable(struct device *dev, unsigned int enable)\r\n{\r\nint ret;\r\nu8 controls;\r\nret = rv3029_read_regs(dev, RV3029_IRQ_CTRL, &controls, 1);\r\nif (ret < 0) {\r\ndev_warn(dev, "Read IRQ Control Register error %d\n", ret);\r\nreturn ret;\r\n}\r\nif (enable)\r\ncontrols |= RV3029_IRQ_CTRL_AIE;\r\nelse\r\ncontrols &= ~RV3029_IRQ_CTRL_AIE;\r\nret = rv3029_write_regs(dev, RV3029_IRQ_CTRL, &controls, 1);\r\nif (ret < 0) {\r\ndev_err(dev, "can't update INT reg\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rv3029_set_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nstruct rtc_time *const tm = &alarm->time;\r\nint ret;\r\nu8 regs[8];\r\nif (tm->tm_year < 100)\r\nreturn -EINVAL;\r\nret = rv3029_get_sr(dev, regs);\r\nif (ret < 0) {\r\ndev_err(dev, "%s: reading SR failed\n", __func__);\r\nreturn -EIO;\r\n}\r\nregs[RV3029_A_SC - RV3029_A_SC] = bin2bcd(tm->tm_sec) | RV3029_A_AE_X;\r\nregs[RV3029_A_MN - RV3029_A_SC] = bin2bcd(tm->tm_min) | RV3029_A_AE_X;\r\nregs[RV3029_A_HR - RV3029_A_SC] = (bin2bcd(tm->tm_hour) & 0x3f)\r\n| RV3029_A_AE_X;\r\nregs[RV3029_A_DT - RV3029_A_SC] = (bin2bcd(tm->tm_mday) & 0x3f)\r\n| RV3029_A_AE_X;\r\nregs[RV3029_A_MO - RV3029_A_SC] = (bin2bcd(tm->tm_mon + 1) & 0x1f)\r\n| RV3029_A_AE_X;\r\nregs[RV3029_A_DW - RV3029_A_SC] = (bin2bcd(tm->tm_wday + 1) & 0x7)\r\n| RV3029_A_AE_X;\r\nregs[RV3029_A_YR - RV3029_A_SC] = (bin2bcd(tm->tm_year - 100))\r\n| RV3029_A_AE_X;\r\nret = rv3029_write_regs(dev, RV3029_A_SC, regs,\r\nRV3029_ALARM_SECTION_LEN);\r\nif (ret < 0)\r\nreturn ret;\r\nif (alarm->enabled) {\r\nret = rv3029_alarm_irq_enable(dev, 1);\r\nif (ret)\r\nreturn ret;\r\n} else {\r\nret = rv3029_alarm_irq_enable(dev, 0);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rv3029_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nu8 regs[8];\r\nint ret;\r\nif (tm->tm_year < 100)\r\nreturn -EINVAL;\r\nregs[RV3029_W_SEC - RV3029_W_SEC] = bin2bcd(tm->tm_sec);\r\nregs[RV3029_W_MINUTES - RV3029_W_SEC] = bin2bcd(tm->tm_min);\r\nregs[RV3029_W_HOURS - RV3029_W_SEC] = bin2bcd(tm->tm_hour);\r\nregs[RV3029_W_DATE - RV3029_W_SEC] = bin2bcd(tm->tm_mday);\r\nregs[RV3029_W_MONTHS - RV3029_W_SEC] = bin2bcd(tm->tm_mon + 1);\r\nregs[RV3029_W_DAYS - RV3029_W_SEC] = bin2bcd(tm->tm_wday + 1) & 0x7;\r\nregs[RV3029_W_YEARS - RV3029_W_SEC] = bin2bcd(tm->tm_year - 100);\r\nret = rv3029_write_regs(dev, RV3029_W_SEC, regs,\r\nRV3029_WATCH_SECTION_LEN);\r\nif (ret < 0)\r\nreturn ret;\r\nret = rv3029_get_sr(dev, regs);\r\nif (ret < 0) {\r\ndev_err(dev, "%s: reading SR failed\n", __func__);\r\nreturn ret;\r\n}\r\nret = rv3029_set_sr(dev, (regs[0] & ~RV3029_STATUS_PON));\r\nif (ret < 0) {\r\ndev_err(dev, "%s: reading SR failed\n", __func__);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void rv3029_trickle_config(struct device *dev)\r\n{\r\nstruct device_node *of_node = dev->of_node;\r\nconst struct rv3029_trickle_tab_elem *elem;\r\nint i, err;\r\nu32 ohms;\r\nu8 trickle_set_bits;\r\nif (!of_node)\r\nreturn;\r\nerr = of_property_read_u32(of_node, "trickle-resistor-ohms", &ohms);\r\nif (err) {\r\ntrickle_set_bits = 0;\r\n} else {\r\nfor (i = 0; i < ARRAY_SIZE(rv3029_trickle_tab); i++) {\r\nelem = &rv3029_trickle_tab[i];\r\nif (elem->r >= ohms)\r\nbreak;\r\n}\r\ntrickle_set_bits = elem->conf;\r\ndev_info(dev,\r\n"Trickle charger enabled at %d ohms resistance.\n",\r\nelem->r);\r\n}\r\nerr = rv3029_eeprom_update_bits(dev, RV3029_CONTROL_E2P_EECTRL,\r\nRV3029_TRICKLE_MASK,\r\ntrickle_set_bits);\r\nif (err < 0)\r\ndev_err(dev, "Failed to update trickle charger config\n");\r\n}\r\nstatic int rv3029_read_temp(struct device *dev, int *temp_mC)\r\n{\r\nint ret;\r\nu8 temp;\r\nret = rv3029_read_regs(dev, RV3029_TEMP_PAGE, &temp, 1);\r\nif (ret < 0)\r\nreturn ret;\r\n*temp_mC = ((int)temp - 60) * 1000;\r\nreturn 0;\r\n}\r\nstatic ssize_t rv3029_hwmon_show_temp(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint ret, temp_mC;\r\nret = rv3029_read_temp(dev, &temp_mC);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", temp_mC);\r\n}\r\nstatic ssize_t rv3029_hwmon_set_update_interval(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nunsigned long interval_ms;\r\nint ret;\r\nu8 th_set_bits = 0;\r\nret = kstrtoul(buf, 10, &interval_ms);\r\nif (ret < 0)\r\nreturn ret;\r\nif (interval_ms != 0) {\r\nth_set_bits |= RV3029_EECTRL_THE;\r\nif (interval_ms >= 16000)\r\nth_set_bits |= RV3029_EECTRL_THP;\r\n}\r\nret = rv3029_eeprom_update_bits(dev, RV3029_CONTROL_E2P_EECTRL,\r\nRV3029_EECTRL_THE | RV3029_EECTRL_THP,\r\nth_set_bits);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn count;\r\n}\r\nstatic ssize_t rv3029_hwmon_show_update_interval(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint ret, interval_ms;\r\nu8 eectrl;\r\nret = rv3029_eeprom_read(dev, RV3029_CONTROL_E2P_EECTRL,\r\n&eectrl, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nif (eectrl & RV3029_EECTRL_THE) {\r\nif (eectrl & RV3029_EECTRL_THP)\r\ninterval_ms = 16000;\r\nelse\r\ninterval_ms = 1000;\r\n} else {\r\ninterval_ms = 0;\r\n}\r\nreturn sprintf(buf, "%d\n", interval_ms);\r\n}\r\nstatic void rv3029_hwmon_register(struct device *dev, const char *name)\r\n{\r\nstruct rv3029_data *rv3029 = dev_get_drvdata(dev);\r\nstruct device *hwmon_dev;\r\nhwmon_dev = devm_hwmon_device_register_with_groups(dev, name, rv3029,\r\nrv3029_hwmon_groups);\r\nif (IS_ERR(hwmon_dev)) {\r\ndev_warn(dev, "unable to register hwmon device %ld\n",\r\nPTR_ERR(hwmon_dev));\r\n}\r\n}\r\nstatic void rv3029_hwmon_register(struct device *dev, const char *name)\r\n{\r\n}\r\nstatic int rv3029_probe(struct device *dev, struct regmap *regmap, int irq,\r\nconst char *name)\r\n{\r\nstruct rv3029_data *rv3029;\r\nint rc = 0;\r\nu8 buf[1];\r\nrv3029 = devm_kzalloc(dev, sizeof(*rv3029), GFP_KERNEL);\r\nif (!rv3029)\r\nreturn -ENOMEM;\r\nrv3029->regmap = regmap;\r\nrv3029->irq = irq;\r\nrv3029->dev = dev;\r\ndev_set_drvdata(dev, rv3029);\r\nrc = rv3029_get_sr(dev, buf);\r\nif (rc < 0) {\r\ndev_err(dev, "reading status failed\n");\r\nreturn rc;\r\n}\r\nrv3029_trickle_config(dev);\r\nrv3029_hwmon_register(dev, name);\r\nrv3029->rtc = devm_rtc_device_register(dev, name, &rv3029_rtc_ops,\r\nTHIS_MODULE);\r\nif (IS_ERR(rv3029->rtc)) {\r\ndev_err(dev, "unable to register the class device\n");\r\nreturn PTR_ERR(rv3029->rtc);\r\n}\r\nif (rv3029->irq > 0) {\r\nrc = devm_request_threaded_irq(dev, rv3029->irq,\r\nNULL, rv3029_handle_irq,\r\nIRQF_TRIGGER_LOW | IRQF_ONESHOT,\r\n"rv3029", dev);\r\nif (rc) {\r\ndev_warn(dev, "unable to request IRQ, alarms disabled\n");\r\nrv3029->irq = 0;\r\n} else {\r\nrv3029_rtc_ops.read_alarm = rv3029_read_alarm;\r\nrv3029_rtc_ops.set_alarm = rv3029_set_alarm;\r\nrv3029_rtc_ops.alarm_irq_enable = rv3029_alarm_irq_enable;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int rv3029_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct regmap *regmap;\r\nstatic const struct regmap_config config = {\r\n.reg_bits = 8,\r\n.val_bits = 8,\r\n};\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_I2C_BLOCK |\r\nI2C_FUNC_SMBUS_BYTE)) {\r\ndev_err(&client->dev, "Adapter does not support SMBUS_I2C_BLOCK or SMBUS_I2C_BYTE\n");\r\nreturn -ENODEV;\r\n}\r\nregmap = devm_regmap_init_i2c(client, &config);\r\nif (IS_ERR(regmap)) {\r\ndev_err(&client->dev, "%s: regmap allocation failed: %ld\n",\r\n__func__, PTR_ERR(regmap));\r\nreturn PTR_ERR(regmap);\r\n}\r\nreturn rv3029_probe(&client->dev, regmap, client->irq, client->name);\r\n}\r\nstatic int rv3029_register_driver(void)\r\n{\r\nreturn i2c_add_driver(&rv3029_driver);\r\n}\r\nstatic void rv3029_unregister_driver(void)\r\n{\r\ni2c_del_driver(&rv3029_driver);\r\n}\r\nstatic int rv3029_register_driver(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void rv3029_unregister_driver(void)\r\n{\r\n}\r\nstatic int rv3049_probe(struct spi_device *spi)\r\n{\r\nstatic const struct regmap_config config = {\r\n.reg_bits = 8,\r\n.val_bits = 8,\r\n};\r\nstruct regmap *regmap;\r\nregmap = devm_regmap_init_spi(spi, &config);\r\nif (IS_ERR(regmap)) {\r\ndev_err(&spi->dev, "%s: regmap allocation failed: %ld\n",\r\n__func__, PTR_ERR(regmap));\r\nreturn PTR_ERR(regmap);\r\n}\r\nreturn rv3029_probe(&spi->dev, regmap, spi->irq, "rv3049");\r\n}\r\nstatic int rv3049_register_driver(void)\r\n{\r\nreturn spi_register_driver(&rv3049_driver);\r\n}\r\nstatic void rv3049_unregister_driver(void)\r\n{\r\nspi_unregister_driver(&rv3049_driver);\r\n}\r\nstatic int rv3049_register_driver(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void rv3049_unregister_driver(void)\r\n{\r\n}\r\nstatic int __init rv30x9_init(void)\r\n{\r\nint ret;\r\nret = rv3029_register_driver();\r\nif (ret) {\r\npr_err("Failed to register rv3029 driver: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = rv3049_register_driver();\r\nif (ret) {\r\npr_err("Failed to register rv3049 driver: %d\n", ret);\r\nrv3029_unregister_driver();\r\n}\r\nreturn ret;\r\n}\r\nstatic void __exit rv30x9_exit(void)\r\n{\r\nrv3049_unregister_driver();\r\nrv3029_unregister_driver();\r\n}

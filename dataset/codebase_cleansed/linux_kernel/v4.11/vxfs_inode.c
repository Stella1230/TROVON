void\r\nvxfs_dumpi(struct vxfs_inode_info *vip, ino_t ino)\r\n{\r\nprintk(KERN_DEBUG "\n\n");\r\nif (ino)\r\nprintk(KERN_DEBUG "dumping vxfs inode %ld\n", ino);\r\nelse\r\nprintk(KERN_DEBUG "dumping unknown vxfs inode\n");\r\nprintk(KERN_DEBUG "---------------------------\n");\r\nprintk(KERN_DEBUG "mode is %x\n", vip->vii_mode);\r\nprintk(KERN_DEBUG "nlink:%u, uid:%u, gid:%u\n",\r\nvip->vii_nlink, vip->vii_uid, vip->vii_gid);\r\nprintk(KERN_DEBUG "size:%Lx, blocks:%u\n",\r\nvip->vii_size, vip->vii_blocks);\r\nprintk(KERN_DEBUG "orgtype:%u\n", vip->vii_orgtype);\r\n}\r\nstatic __inline__ umode_t\r\nvxfs_transmod(struct vxfs_inode_info *vip)\r\n{\r\numode_t ret = vip->vii_mode & ~VXFS_TYPE_MASK;\r\nif (VXFS_ISFIFO(vip))\r\nret |= S_IFIFO;\r\nif (VXFS_ISCHR(vip))\r\nret |= S_IFCHR;\r\nif (VXFS_ISDIR(vip))\r\nret |= S_IFDIR;\r\nif (VXFS_ISBLK(vip))\r\nret |= S_IFBLK;\r\nif (VXFS_ISLNK(vip))\r\nret |= S_IFLNK;\r\nif (VXFS_ISREG(vip))\r\nret |= S_IFREG;\r\nif (VXFS_ISSOC(vip))\r\nret |= S_IFSOCK;\r\nreturn (ret);\r\n}\r\nstatic inline void dip2vip_cpy(struct vxfs_sb_info *sbi,\r\nstruct vxfs_inode_info *vip, struct vxfs_dinode *dip)\r\n{\r\nstruct inode *inode = &vip->vfs_inode;\r\nvip->vii_mode = fs32_to_cpu(sbi, dip->vdi_mode);\r\nvip->vii_nlink = fs32_to_cpu(sbi, dip->vdi_nlink);\r\nvip->vii_uid = fs32_to_cpu(sbi, dip->vdi_uid);\r\nvip->vii_gid = fs32_to_cpu(sbi, dip->vdi_gid);\r\nvip->vii_size = fs64_to_cpu(sbi, dip->vdi_size);\r\nvip->vii_atime = fs32_to_cpu(sbi, dip->vdi_atime);\r\nvip->vii_autime = fs32_to_cpu(sbi, dip->vdi_autime);\r\nvip->vii_mtime = fs32_to_cpu(sbi, dip->vdi_mtime);\r\nvip->vii_mutime = fs32_to_cpu(sbi, dip->vdi_mutime);\r\nvip->vii_ctime = fs32_to_cpu(sbi, dip->vdi_ctime);\r\nvip->vii_cutime = fs32_to_cpu(sbi, dip->vdi_cutime);\r\nvip->vii_orgtype = dip->vdi_orgtype;\r\nvip->vii_blocks = fs32_to_cpu(sbi, dip->vdi_blocks);\r\nvip->vii_gen = fs32_to_cpu(sbi, dip->vdi_gen);\r\nif (VXFS_ISDIR(vip))\r\nvip->vii_dotdot = fs32_to_cpu(sbi, dip->vdi_dotdot);\r\nelse if (!VXFS_ISREG(vip) && !VXFS_ISLNK(vip))\r\nvip->vii_rdev = fs32_to_cpu(sbi, dip->vdi_rdev);\r\nmemcpy(&vip->vii_org, &dip->vdi_org, sizeof(vip->vii_org));\r\ninode->i_mode = vxfs_transmod(vip);\r\ni_uid_write(inode, (uid_t)vip->vii_uid);\r\ni_gid_write(inode, (gid_t)vip->vii_gid);\r\nset_nlink(inode, vip->vii_nlink);\r\ninode->i_size = vip->vii_size;\r\ninode->i_atime.tv_sec = vip->vii_atime;\r\ninode->i_ctime.tv_sec = vip->vii_ctime;\r\ninode->i_mtime.tv_sec = vip->vii_mtime;\r\ninode->i_atime.tv_nsec = 0;\r\ninode->i_ctime.tv_nsec = 0;\r\ninode->i_mtime.tv_nsec = 0;\r\ninode->i_blocks = vip->vii_blocks;\r\ninode->i_generation = vip->vii_gen;\r\n}\r\nstruct inode *\r\nvxfs_blkiget(struct super_block *sbp, u_long extent, ino_t ino)\r\n{\r\nstruct buffer_head *bp;\r\nstruct inode *inode;\r\nu_long block, offset;\r\ninode = new_inode(sbp);\r\nif (!inode)\r\nreturn NULL;\r\ninode->i_ino = get_next_ino();\r\nblock = extent + ((ino * VXFS_ISIZE) / sbp->s_blocksize);\r\noffset = ((ino % (sbp->s_blocksize / VXFS_ISIZE)) * VXFS_ISIZE);\r\nbp = sb_bread(sbp, block);\r\nif (bp && buffer_mapped(bp)) {\r\nstruct vxfs_inode_info *vip = VXFS_INO(inode);\r\nstruct vxfs_dinode *dip;\r\ndip = (struct vxfs_dinode *)(bp->b_data + offset);\r\ndip2vip_cpy(VXFS_SBI(sbp), vip, dip);\r\nvip->vfs_inode.i_mapping->a_ops = &vxfs_aops;\r\n#ifdef DIAGNOSTIC\r\nvxfs_dumpi(vip, ino);\r\n#endif\r\nbrelse(bp);\r\nreturn inode;\r\n}\r\nprintk(KERN_WARNING "vxfs: unable to read block %ld\n", block);\r\nbrelse(bp);\r\niput(inode);\r\nreturn NULL;\r\n}\r\nstatic int\r\n__vxfs_iget(struct inode *ilistp, struct vxfs_inode_info *vip, ino_t ino)\r\n{\r\nstruct page *pp;\r\nu_long offset;\r\noffset = (ino % (PAGE_SIZE / VXFS_ISIZE)) * VXFS_ISIZE;\r\npp = vxfs_get_page(ilistp->i_mapping, ino * VXFS_ISIZE / PAGE_SIZE);\r\nif (!IS_ERR(pp)) {\r\nstruct vxfs_dinode *dip;\r\ncaddr_t kaddr = (char *)page_address(pp);\r\ndip = (struct vxfs_dinode *)(kaddr + offset);\r\ndip2vip_cpy(VXFS_SBI(ilistp->i_sb), vip, dip);\r\nvip->vfs_inode.i_mapping->a_ops = &vxfs_aops;\r\n#ifdef DIAGNOSTIC\r\nvxfs_dumpi(vip, ino);\r\n#endif\r\nvxfs_put_page(pp);\r\nreturn 0;\r\n}\r\nprintk(KERN_WARNING "vxfs: error on page 0x%p for inode %ld\n",\r\npp, (unsigned long)ino);\r\nreturn PTR_ERR(pp);\r\n}\r\nstruct inode *\r\nvxfs_stiget(struct super_block *sbp, ino_t ino)\r\n{\r\nstruct inode *inode;\r\nint error;\r\ninode = new_inode(sbp);\r\nif (!inode)\r\nreturn NULL;\r\ninode->i_ino = get_next_ino();\r\nerror = __vxfs_iget(VXFS_SBI(sbp)->vsi_stilist, VXFS_INO(inode), ino);\r\nif (error) {\r\niput(inode);\r\nreturn NULL;\r\n}\r\nreturn inode;\r\n}\r\nstruct inode *\r\nvxfs_iget(struct super_block *sbp, ino_t ino)\r\n{\r\nstruct vxfs_inode_info *vip;\r\nconst struct address_space_operations *aops;\r\nstruct inode *ip;\r\nint error;\r\nip = iget_locked(sbp, ino);\r\nif (!ip)\r\nreturn ERR_PTR(-ENOMEM);\r\nif (!(ip->i_state & I_NEW))\r\nreturn ip;\r\nvip = VXFS_INO(ip);\r\nerror = __vxfs_iget(VXFS_SBI(sbp)->vsi_ilist, vip, ino);\r\nif (error) {\r\niget_failed(ip);\r\nreturn ERR_PTR(error);\r\n}\r\nif (VXFS_ISIMMED(vip))\r\naops = &vxfs_immed_aops;\r\nelse\r\naops = &vxfs_aops;\r\nif (S_ISREG(ip->i_mode)) {\r\nip->i_fop = &generic_ro_fops;\r\nip->i_mapping->a_ops = aops;\r\n} else if (S_ISDIR(ip->i_mode)) {\r\nip->i_op = &vxfs_dir_inode_ops;\r\nip->i_fop = &vxfs_dir_operations;\r\nip->i_mapping->a_ops = aops;\r\n} else if (S_ISLNK(ip->i_mode)) {\r\nif (!VXFS_ISIMMED(vip)) {\r\nip->i_op = &page_symlink_inode_operations;\r\ninode_nohighmem(ip);\r\nip->i_mapping->a_ops = &vxfs_aops;\r\n} else {\r\nip->i_op = &simple_symlink_inode_operations;\r\nip->i_link = vip->vii_immed.vi_immed;\r\nnd_terminate_link(ip->i_link, ip->i_size,\r\nsizeof(vip->vii_immed.vi_immed) - 1);\r\n}\r\n} else\r\ninit_special_inode(ip, ip->i_mode, old_decode_dev(vip->vii_rdev));\r\nunlock_new_inode(ip);\r\nreturn ip;\r\n}\r\nvoid\r\nvxfs_evict_inode(struct inode *ip)\r\n{\r\ntruncate_inode_pages_final(&ip->i_data);\r\nclear_inode(ip);\r\n}

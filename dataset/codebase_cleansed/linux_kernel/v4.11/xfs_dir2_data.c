int\r\n__xfs_dir3_data_check(\r\nstruct xfs_inode *dp,\r\nstruct xfs_buf *bp)\r\n{\r\nxfs_dir2_dataptr_t addr;\r\nxfs_dir2_data_free_t *bf;\r\nxfs_dir2_block_tail_t *btp=NULL;\r\nint count;\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_dir2_data_free_t *dfp;\r\nxfs_dir2_data_unused_t *dup;\r\nchar *endp;\r\nint freeseen;\r\nxfs_dahash_t hash;\r\nint i;\r\nint lastfree;\r\nxfs_dir2_leaf_entry_t *lep=NULL;\r\nxfs_mount_t *mp;\r\nchar *p;\r\nint stale;\r\nstruct xfs_name name;\r\nconst struct xfs_dir_ops *ops;\r\nstruct xfs_da_geometry *geo;\r\nmp = bp->b_target->bt_mount;\r\ngeo = mp->m_dir_geo;\r\nops = xfs_dir_get_ops(mp, dp);\r\nhdr = bp->b_addr;\r\np = (char *)ops->data_entry_p(hdr);\r\nswitch (hdr->magic) {\r\ncase cpu_to_be32(XFS_DIR3_BLOCK_MAGIC):\r\ncase cpu_to_be32(XFS_DIR2_BLOCK_MAGIC):\r\nbtp = xfs_dir2_block_tail_p(geo, hdr);\r\nlep = xfs_dir2_block_leaf_p(btp);\r\nendp = (char *)lep;\r\nXFS_WANT_CORRUPTED_RETURN(mp, be32_to_cpu(btp->count) <\r\n((char *)btp - p) / sizeof(struct xfs_dir2_leaf_entry));\r\nbreak;\r\ncase cpu_to_be32(XFS_DIR3_DATA_MAGIC):\r\ncase cpu_to_be32(XFS_DIR2_DATA_MAGIC):\r\nendp = (char *)hdr + geo->blksize;\r\nbreak;\r\ndefault:\r\nXFS_ERROR_REPORT("Bad Magic", XFS_ERRLEVEL_LOW, mp);\r\nreturn -EFSCORRUPTED;\r\n}\r\nbf = ops->data_bestfree_p(hdr);\r\ncount = lastfree = freeseen = 0;\r\nif (!bf[0].length) {\r\nXFS_WANT_CORRUPTED_RETURN(mp, !bf[0].offset);\r\nfreeseen |= 1 << 0;\r\n}\r\nif (!bf[1].length) {\r\nXFS_WANT_CORRUPTED_RETURN(mp, !bf[1].offset);\r\nfreeseen |= 1 << 1;\r\n}\r\nif (!bf[2].length) {\r\nXFS_WANT_CORRUPTED_RETURN(mp, !bf[2].offset);\r\nfreeseen |= 1 << 2;\r\n}\r\nXFS_WANT_CORRUPTED_RETURN(mp, be16_to_cpu(bf[0].length) >=\r\nbe16_to_cpu(bf[1].length));\r\nXFS_WANT_CORRUPTED_RETURN(mp, be16_to_cpu(bf[1].length) >=\r\nbe16_to_cpu(bf[2].length));\r\nwhile (p < endp) {\r\ndup = (xfs_dir2_data_unused_t *)p;\r\nif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\r\nXFS_WANT_CORRUPTED_RETURN(mp, lastfree == 0);\r\nXFS_WANT_CORRUPTED_RETURN(mp,\r\nbe16_to_cpu(*xfs_dir2_data_unused_tag_p(dup)) ==\r\n(char *)dup - (char *)hdr);\r\ndfp = xfs_dir2_data_freefind(hdr, bf, dup);\r\nif (dfp) {\r\ni = (int)(dfp - bf);\r\nXFS_WANT_CORRUPTED_RETURN(mp,\r\n(freeseen & (1 << i)) == 0);\r\nfreeseen |= 1 << i;\r\n} else {\r\nXFS_WANT_CORRUPTED_RETURN(mp,\r\nbe16_to_cpu(dup->length) <=\r\nbe16_to_cpu(bf[2].length));\r\n}\r\np += be16_to_cpu(dup->length);\r\nlastfree = 1;\r\ncontinue;\r\n}\r\ndep = (xfs_dir2_data_entry_t *)p;\r\nXFS_WANT_CORRUPTED_RETURN(mp, dep->namelen != 0);\r\nXFS_WANT_CORRUPTED_RETURN(mp,\r\n!xfs_dir_ino_validate(mp, be64_to_cpu(dep->inumber)));\r\nXFS_WANT_CORRUPTED_RETURN(mp,\r\nbe16_to_cpu(*ops->data_entry_tag_p(dep)) ==\r\n(char *)dep - (char *)hdr);\r\nXFS_WANT_CORRUPTED_RETURN(mp,\r\nops->data_get_ftype(dep) < XFS_DIR3_FT_MAX);\r\ncount++;\r\nlastfree = 0;\r\nif (hdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_BLOCK_MAGIC)) {\r\naddr = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\r\n(xfs_dir2_data_aoff_t)\r\n((char *)dep - (char *)hdr));\r\nname.name = dep->name;\r\nname.len = dep->namelen;\r\nhash = mp->m_dirnameops->hashname(&name);\r\nfor (i = 0; i < be32_to_cpu(btp->count); i++) {\r\nif (be32_to_cpu(lep[i].address) == addr &&\r\nbe32_to_cpu(lep[i].hashval) == hash)\r\nbreak;\r\n}\r\nXFS_WANT_CORRUPTED_RETURN(mp,\r\ni < be32_to_cpu(btp->count));\r\n}\r\np += ops->data_entsize(dep->namelen);\r\n}\r\nXFS_WANT_CORRUPTED_RETURN(mp, freeseen == 7);\r\nif (hdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_BLOCK_MAGIC)) {\r\nfor (i = stale = 0; i < be32_to_cpu(btp->count); i++) {\r\nif (lep[i].address ==\r\ncpu_to_be32(XFS_DIR2_NULL_DATAPTR))\r\nstale++;\r\nif (i > 0)\r\nXFS_WANT_CORRUPTED_RETURN(mp,\r\nbe32_to_cpu(lep[i].hashval) >=\r\nbe32_to_cpu(lep[i - 1].hashval));\r\n}\r\nXFS_WANT_CORRUPTED_RETURN(mp, count ==\r\nbe32_to_cpu(btp->count) - be32_to_cpu(btp->stale));\r\nXFS_WANT_CORRUPTED_RETURN(mp, stale == be32_to_cpu(btp->stale));\r\n}\r\nreturn 0;\r\n}\r\nstatic bool\r\nxfs_dir3_data_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_dir3_blk_hdr *hdr3 = bp->b_addr;\r\nif (xfs_sb_version_hascrc(&mp->m_sb)) {\r\nif (hdr3->magic != cpu_to_be32(XFS_DIR3_DATA_MAGIC))\r\nreturn false;\r\nif (!uuid_equal(&hdr3->uuid, &mp->m_sb.sb_meta_uuid))\r\nreturn false;\r\nif (be64_to_cpu(hdr3->blkno) != bp->b_bn)\r\nreturn false;\r\nif (!xfs_log_check_lsn(mp, be64_to_cpu(hdr3->lsn)))\r\nreturn false;\r\n} else {\r\nif (hdr3->magic != cpu_to_be32(XFS_DIR2_DATA_MAGIC))\r\nreturn false;\r\n}\r\nif (__xfs_dir3_data_check(NULL, bp))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic void\r\nxfs_dir3_data_reada_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_dir2_data_hdr *hdr = bp->b_addr;\r\nswitch (hdr->magic) {\r\ncase cpu_to_be32(XFS_DIR2_BLOCK_MAGIC):\r\ncase cpu_to_be32(XFS_DIR3_BLOCK_MAGIC):\r\nbp->b_ops = &xfs_dir3_block_buf_ops;\r\nbp->b_ops->verify_read(bp);\r\nreturn;\r\ncase cpu_to_be32(XFS_DIR2_DATA_MAGIC):\r\ncase cpu_to_be32(XFS_DIR3_DATA_MAGIC):\r\nbp->b_ops = &xfs_dir3_data_buf_ops;\r\nbp->b_ops->verify_read(bp);\r\nreturn;\r\ndefault:\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nxfs_verifier_error(bp);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nxfs_dir3_data_read_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nif (xfs_sb_version_hascrc(&mp->m_sb) &&\r\n!xfs_buf_verify_cksum(bp, XFS_DIR3_DATA_CRC_OFF))\r\nxfs_buf_ioerror(bp, -EFSBADCRC);\r\nelse if (!xfs_dir3_data_verify(bp))\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nif (bp->b_error)\r\nxfs_verifier_error(bp);\r\n}\r\nstatic void\r\nxfs_dir3_data_write_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_buf_log_item *bip = bp->b_fspriv;\r\nstruct xfs_dir3_blk_hdr *hdr3 = bp->b_addr;\r\nif (!xfs_dir3_data_verify(bp)) {\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nxfs_verifier_error(bp);\r\nreturn;\r\n}\r\nif (!xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn;\r\nif (bip)\r\nhdr3->lsn = cpu_to_be64(bip->bli_item.li_lsn);\r\nxfs_buf_update_cksum(bp, XFS_DIR3_DATA_CRC_OFF);\r\n}\r\nint\r\nxfs_dir3_data_read(\r\nstruct xfs_trans *tp,\r\nstruct xfs_inode *dp,\r\nxfs_dablk_t bno,\r\nxfs_daddr_t mapped_bno,\r\nstruct xfs_buf **bpp)\r\n{\r\nint err;\r\nerr = xfs_da_read_buf(tp, dp, bno, mapped_bno, bpp,\r\nXFS_DATA_FORK, &xfs_dir3_data_buf_ops);\r\nif (!err && tp && *bpp)\r\nxfs_trans_buf_set_type(tp, *bpp, XFS_BLFT_DIR_DATA_BUF);\r\nreturn err;\r\n}\r\nint\r\nxfs_dir3_data_readahead(\r\nstruct xfs_inode *dp,\r\nxfs_dablk_t bno,\r\nxfs_daddr_t mapped_bno)\r\n{\r\nreturn xfs_da_reada_buf(dp, bno, mapped_bno,\r\nXFS_DATA_FORK, &xfs_dir3_data_reada_buf_ops);\r\n}\r\nxfs_dir2_data_free_t *\r\nxfs_dir2_data_freefind(\r\nstruct xfs_dir2_data_hdr *hdr,\r\nstruct xfs_dir2_data_free *bf,\r\nstruct xfs_dir2_data_unused *dup)\r\n{\r\nxfs_dir2_data_free_t *dfp;\r\nxfs_dir2_data_aoff_t off;\r\n#ifdef DEBUG\r\nint matched;\r\nint seenzero;\r\n#endif\r\noff = (xfs_dir2_data_aoff_t)((char *)dup - (char *)hdr);\r\n#ifdef DEBUG\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_BLOCK_MAGIC));\r\nfor (dfp = &bf[0], seenzero = matched = 0;\r\ndfp < &bf[XFS_DIR2_DATA_FD_COUNT];\r\ndfp++) {\r\nif (!dfp->offset) {\r\nASSERT(!dfp->length);\r\nseenzero = 1;\r\ncontinue;\r\n}\r\nASSERT(seenzero == 0);\r\nif (be16_to_cpu(dfp->offset) == off) {\r\nmatched = 1;\r\nASSERT(dfp->length == dup->length);\r\n} else if (off < be16_to_cpu(dfp->offset))\r\nASSERT(off + be16_to_cpu(dup->length) <= be16_to_cpu(dfp->offset));\r\nelse\r\nASSERT(be16_to_cpu(dfp->offset) + be16_to_cpu(dfp->length) <= off);\r\nASSERT(matched || be16_to_cpu(dfp->length) >= be16_to_cpu(dup->length));\r\nif (dfp > &bf[0])\r\nASSERT(be16_to_cpu(dfp[-1].length) >= be16_to_cpu(dfp[0].length));\r\n}\r\n#endif\r\nif (be16_to_cpu(dup->length) <\r\nbe16_to_cpu(bf[XFS_DIR2_DATA_FD_COUNT - 1].length))\r\nreturn NULL;\r\nfor (dfp = &bf[0]; dfp < &bf[XFS_DIR2_DATA_FD_COUNT]; dfp++) {\r\nif (!dfp->offset)\r\nreturn NULL;\r\nif (be16_to_cpu(dfp->offset) == off)\r\nreturn dfp;\r\n}\r\nreturn NULL;\r\n}\r\nxfs_dir2_data_free_t *\r\nxfs_dir2_data_freeinsert(\r\nstruct xfs_dir2_data_hdr *hdr,\r\nstruct xfs_dir2_data_free *dfp,\r\nstruct xfs_dir2_data_unused *dup,\r\nint *loghead)\r\n{\r\nxfs_dir2_data_free_t new;\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_BLOCK_MAGIC));\r\nnew.length = dup->length;\r\nnew.offset = cpu_to_be16((char *)dup - (char *)hdr);\r\nif (be16_to_cpu(new.length) > be16_to_cpu(dfp[0].length)) {\r\ndfp[2] = dfp[1];\r\ndfp[1] = dfp[0];\r\ndfp[0] = new;\r\n*loghead = 1;\r\nreturn &dfp[0];\r\n}\r\nif (be16_to_cpu(new.length) > be16_to_cpu(dfp[1].length)) {\r\ndfp[2] = dfp[1];\r\ndfp[1] = new;\r\n*loghead = 1;\r\nreturn &dfp[1];\r\n}\r\nif (be16_to_cpu(new.length) > be16_to_cpu(dfp[2].length)) {\r\ndfp[2] = new;\r\n*loghead = 1;\r\nreturn &dfp[2];\r\n}\r\nreturn NULL;\r\n}\r\nSTATIC void\r\nxfs_dir2_data_freeremove(\r\nstruct xfs_dir2_data_hdr *hdr,\r\nstruct xfs_dir2_data_free *bf,\r\nstruct xfs_dir2_data_free *dfp,\r\nint *loghead)\r\n{\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_BLOCK_MAGIC));\r\nif (dfp == &bf[0]) {\r\nbf[0] = bf[1];\r\nbf[1] = bf[2];\r\n}\r\nelse if (dfp == &bf[1])\r\nbf[1] = bf[2];\r\nelse\r\nASSERT(dfp == &bf[2]);\r\nbf[2].length = 0;\r\nbf[2].offset = 0;\r\n*loghead = 1;\r\n}\r\nvoid\r\nxfs_dir2_data_freescan_int(\r\nstruct xfs_da_geometry *geo,\r\nconst struct xfs_dir_ops *ops,\r\nstruct xfs_dir2_data_hdr *hdr,\r\nint *loghead)\r\n{\r\nxfs_dir2_block_tail_t *btp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_dir2_data_unused_t *dup;\r\nstruct xfs_dir2_data_free *bf;\r\nchar *endp;\r\nchar *p;\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_BLOCK_MAGIC));\r\nbf = ops->data_bestfree_p(hdr);\r\nmemset(bf, 0, sizeof(*bf) * XFS_DIR2_DATA_FD_COUNT);\r\n*loghead = 1;\r\np = (char *)ops->data_entry_p(hdr);\r\nif (hdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_BLOCK_MAGIC)) {\r\nbtp = xfs_dir2_block_tail_p(geo, hdr);\r\nendp = (char *)xfs_dir2_block_leaf_p(btp);\r\n} else\r\nendp = (char *)hdr + geo->blksize;\r\nwhile (p < endp) {\r\ndup = (xfs_dir2_data_unused_t *)p;\r\nif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\r\nASSERT((char *)dup - (char *)hdr ==\r\nbe16_to_cpu(*xfs_dir2_data_unused_tag_p(dup)));\r\nxfs_dir2_data_freeinsert(hdr, bf, dup, loghead);\r\np += be16_to_cpu(dup->length);\r\n}\r\nelse {\r\ndep = (xfs_dir2_data_entry_t *)p;\r\nASSERT((char *)dep - (char *)hdr ==\r\nbe16_to_cpu(*ops->data_entry_tag_p(dep)));\r\np += ops->data_entsize(dep->namelen);\r\n}\r\n}\r\n}\r\nvoid\r\nxfs_dir2_data_freescan(\r\nstruct xfs_inode *dp,\r\nstruct xfs_dir2_data_hdr *hdr,\r\nint *loghead)\r\n{\r\nreturn xfs_dir2_data_freescan_int(dp->i_mount->m_dir_geo, dp->d_ops,\r\nhdr, loghead);\r\n}\r\nint\r\nxfs_dir3_data_init(\r\nxfs_da_args_t *args,\r\nxfs_dir2_db_t blkno,\r\nstruct xfs_buf **bpp)\r\n{\r\nstruct xfs_buf *bp;\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_inode_t *dp;\r\nxfs_dir2_data_unused_t *dup;\r\nstruct xfs_dir2_data_free *bf;\r\nint error;\r\nint i;\r\nxfs_mount_t *mp;\r\nxfs_trans_t *tp;\r\nint t;\r\ndp = args->dp;\r\nmp = dp->i_mount;\r\ntp = args->trans;\r\nerror = xfs_da_get_buf(tp, dp, xfs_dir2_db_to_da(args->geo, blkno),\r\n-1, &bp, XFS_DATA_FORK);\r\nif (error)\r\nreturn error;\r\nbp->b_ops = &xfs_dir3_data_buf_ops;\r\nxfs_trans_buf_set_type(tp, bp, XFS_BLFT_DIR_DATA_BUF);\r\nhdr = bp->b_addr;\r\nif (xfs_sb_version_hascrc(&mp->m_sb)) {\r\nstruct xfs_dir3_blk_hdr *hdr3 = bp->b_addr;\r\nmemset(hdr3, 0, sizeof(*hdr3));\r\nhdr3->magic = cpu_to_be32(XFS_DIR3_DATA_MAGIC);\r\nhdr3->blkno = cpu_to_be64(bp->b_bn);\r\nhdr3->owner = cpu_to_be64(dp->i_ino);\r\nuuid_copy(&hdr3->uuid, &mp->m_sb.sb_meta_uuid);\r\n} else\r\nhdr->magic = cpu_to_be32(XFS_DIR2_DATA_MAGIC);\r\nbf = dp->d_ops->data_bestfree_p(hdr);\r\nbf[0].offset = cpu_to_be16(dp->d_ops->data_entry_offset);\r\nfor (i = 1; i < XFS_DIR2_DATA_FD_COUNT; i++) {\r\nbf[i].length = 0;\r\nbf[i].offset = 0;\r\n}\r\ndup = dp->d_ops->data_unused_p(hdr);\r\ndup->freetag = cpu_to_be16(XFS_DIR2_DATA_FREE_TAG);\r\nt = args->geo->blksize - (uint)dp->d_ops->data_entry_offset;\r\nbf[0].length = cpu_to_be16(t);\r\ndup->length = cpu_to_be16(t);\r\n*xfs_dir2_data_unused_tag_p(dup) = cpu_to_be16((char *)dup - (char *)hdr);\r\nxfs_dir2_data_log_header(args, bp);\r\nxfs_dir2_data_log_unused(args, bp, dup);\r\n*bpp = bp;\r\nreturn 0;\r\n}\r\nvoid\r\nxfs_dir2_data_log_entry(\r\nstruct xfs_da_args *args,\r\nstruct xfs_buf *bp,\r\nxfs_dir2_data_entry_t *dep)\r\n{\r\nstruct xfs_dir2_data_hdr *hdr = bp->b_addr;\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_BLOCK_MAGIC));\r\nxfs_trans_log_buf(args->trans, bp, (uint)((char *)dep - (char *)hdr),\r\n(uint)((char *)(args->dp->d_ops->data_entry_tag_p(dep) + 1) -\r\n(char *)hdr - 1));\r\n}\r\nvoid\r\nxfs_dir2_data_log_header(\r\nstruct xfs_da_args *args,\r\nstruct xfs_buf *bp)\r\n{\r\n#ifdef DEBUG\r\nstruct xfs_dir2_data_hdr *hdr = bp->b_addr;\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_BLOCK_MAGIC));\r\n#endif\r\nxfs_trans_log_buf(args->trans, bp, 0,\r\nargs->dp->d_ops->data_entry_offset - 1);\r\n}\r\nvoid\r\nxfs_dir2_data_log_unused(\r\nstruct xfs_da_args *args,\r\nstruct xfs_buf *bp,\r\nxfs_dir2_data_unused_t *dup)\r\n{\r\nxfs_dir2_data_hdr_t *hdr = bp->b_addr;\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_BLOCK_MAGIC));\r\nxfs_trans_log_buf(args->trans, bp, (uint)((char *)dup - (char *)hdr),\r\n(uint)((char *)&dup->length + sizeof(dup->length) -\r\n1 - (char *)hdr));\r\nxfs_trans_log_buf(args->trans, bp,\r\n(uint)((char *)xfs_dir2_data_unused_tag_p(dup) - (char *)hdr),\r\n(uint)((char *)xfs_dir2_data_unused_tag_p(dup) - (char *)hdr +\r\nsizeof(xfs_dir2_data_off_t) - 1));\r\n}\r\nvoid\r\nxfs_dir2_data_make_free(\r\nstruct xfs_da_args *args,\r\nstruct xfs_buf *bp,\r\nxfs_dir2_data_aoff_t offset,\r\nxfs_dir2_data_aoff_t len,\r\nint *needlogp,\r\nint *needscanp)\r\n{\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_data_free_t *dfp;\r\nchar *endptr;\r\nint needscan;\r\nxfs_dir2_data_unused_t *newdup;\r\nxfs_dir2_data_unused_t *postdup;\r\nxfs_dir2_data_unused_t *prevdup;\r\nstruct xfs_dir2_data_free *bf;\r\nhdr = bp->b_addr;\r\nif (hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_DATA_MAGIC))\r\nendptr = (char *)hdr + args->geo->blksize;\r\nelse {\r\nxfs_dir2_block_tail_t *btp;\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_BLOCK_MAGIC));\r\nbtp = xfs_dir2_block_tail_p(args->geo, hdr);\r\nendptr = (char *)xfs_dir2_block_leaf_p(btp);\r\n}\r\nif (offset > args->dp->d_ops->data_entry_offset) {\r\n__be16 *tagp;\r\ntagp = (__be16 *)((char *)hdr + offset) - 1;\r\nprevdup = (xfs_dir2_data_unused_t *)((char *)hdr + be16_to_cpu(*tagp));\r\nif (be16_to_cpu(prevdup->freetag) != XFS_DIR2_DATA_FREE_TAG)\r\nprevdup = NULL;\r\n} else\r\nprevdup = NULL;\r\nif ((char *)hdr + offset + len < endptr) {\r\npostdup =\r\n(xfs_dir2_data_unused_t *)((char *)hdr + offset + len);\r\nif (be16_to_cpu(postdup->freetag) != XFS_DIR2_DATA_FREE_TAG)\r\npostdup = NULL;\r\n} else\r\npostdup = NULL;\r\nASSERT(*needscanp == 0);\r\nneedscan = 0;\r\nbf = args->dp->d_ops->data_bestfree_p(hdr);\r\nif (prevdup && postdup) {\r\nxfs_dir2_data_free_t *dfp2;\r\ndfp = xfs_dir2_data_freefind(hdr, bf, prevdup);\r\ndfp2 = xfs_dir2_data_freefind(hdr, bf, postdup);\r\nneedscan = (bf[2].length != 0);\r\nbe16_add_cpu(&prevdup->length, len + be16_to_cpu(postdup->length));\r\n*xfs_dir2_data_unused_tag_p(prevdup) =\r\ncpu_to_be16((char *)prevdup - (char *)hdr);\r\nxfs_dir2_data_log_unused(args, bp, prevdup);\r\nif (!needscan) {\r\nASSERT(dfp && dfp2);\r\nif (dfp == &bf[1]) {\r\ndfp = &bf[0];\r\nASSERT(dfp2 == dfp);\r\ndfp2 = &bf[1];\r\n}\r\nxfs_dir2_data_freeremove(hdr, bf, dfp2, needlogp);\r\nxfs_dir2_data_freeremove(hdr, bf, dfp, needlogp);\r\ndfp = xfs_dir2_data_freeinsert(hdr, bf, prevdup,\r\nneedlogp);\r\nASSERT(dfp == &bf[0]);\r\nASSERT(dfp->length == prevdup->length);\r\nASSERT(!dfp[1].length);\r\nASSERT(!dfp[2].length);\r\n}\r\n}\r\nelse if (prevdup) {\r\ndfp = xfs_dir2_data_freefind(hdr, bf, prevdup);\r\nbe16_add_cpu(&prevdup->length, len);\r\n*xfs_dir2_data_unused_tag_p(prevdup) =\r\ncpu_to_be16((char *)prevdup - (char *)hdr);\r\nxfs_dir2_data_log_unused(args, bp, prevdup);\r\nif (dfp) {\r\nxfs_dir2_data_freeremove(hdr, bf, dfp, needlogp);\r\nxfs_dir2_data_freeinsert(hdr, bf, prevdup, needlogp);\r\n}\r\nelse {\r\nneedscan = be16_to_cpu(prevdup->length) >\r\nbe16_to_cpu(bf[2].length);\r\n}\r\n}\r\nelse if (postdup) {\r\ndfp = xfs_dir2_data_freefind(hdr, bf, postdup);\r\nnewdup = (xfs_dir2_data_unused_t *)((char *)hdr + offset);\r\nnewdup->freetag = cpu_to_be16(XFS_DIR2_DATA_FREE_TAG);\r\nnewdup->length = cpu_to_be16(len + be16_to_cpu(postdup->length));\r\n*xfs_dir2_data_unused_tag_p(newdup) =\r\ncpu_to_be16((char *)newdup - (char *)hdr);\r\nxfs_dir2_data_log_unused(args, bp, newdup);\r\nif (dfp) {\r\nxfs_dir2_data_freeremove(hdr, bf, dfp, needlogp);\r\nxfs_dir2_data_freeinsert(hdr, bf, newdup, needlogp);\r\n}\r\nelse {\r\nneedscan = be16_to_cpu(newdup->length) >\r\nbe16_to_cpu(bf[2].length);\r\n}\r\n}\r\nelse {\r\nnewdup = (xfs_dir2_data_unused_t *)((char *)hdr + offset);\r\nnewdup->freetag = cpu_to_be16(XFS_DIR2_DATA_FREE_TAG);\r\nnewdup->length = cpu_to_be16(len);\r\n*xfs_dir2_data_unused_tag_p(newdup) =\r\ncpu_to_be16((char *)newdup - (char *)hdr);\r\nxfs_dir2_data_log_unused(args, bp, newdup);\r\nxfs_dir2_data_freeinsert(hdr, bf, newdup, needlogp);\r\n}\r\n*needscanp = needscan;\r\n}\r\nvoid\r\nxfs_dir2_data_use_free(\r\nstruct xfs_da_args *args,\r\nstruct xfs_buf *bp,\r\nxfs_dir2_data_unused_t *dup,\r\nxfs_dir2_data_aoff_t offset,\r\nxfs_dir2_data_aoff_t len,\r\nint *needlogp,\r\nint *needscanp)\r\n{\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_data_free_t *dfp;\r\nint matchback;\r\nint matchfront;\r\nint needscan;\r\nxfs_dir2_data_unused_t *newdup;\r\nxfs_dir2_data_unused_t *newdup2;\r\nint oldlen;\r\nstruct xfs_dir2_data_free *bf;\r\nhdr = bp->b_addr;\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_BLOCK_MAGIC));\r\nASSERT(be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG);\r\nASSERT(offset >= (char *)dup - (char *)hdr);\r\nASSERT(offset + len <= (char *)dup + be16_to_cpu(dup->length) - (char *)hdr);\r\nASSERT((char *)dup - (char *)hdr == be16_to_cpu(*xfs_dir2_data_unused_tag_p(dup)));\r\noldlen = be16_to_cpu(dup->length);\r\nbf = args->dp->d_ops->data_bestfree_p(hdr);\r\ndfp = xfs_dir2_data_freefind(hdr, bf, dup);\r\nASSERT(dfp || oldlen <= be16_to_cpu(bf[2].length));\r\nmatchfront = (char *)dup - (char *)hdr == offset;\r\nmatchback = (char *)dup + oldlen - (char *)hdr == offset + len;\r\nASSERT(*needscanp == 0);\r\nneedscan = 0;\r\nif (matchfront && matchback) {\r\nif (dfp) {\r\nneedscan = (bf[2].offset != 0);\r\nif (!needscan)\r\nxfs_dir2_data_freeremove(hdr, bf, dfp,\r\nneedlogp);\r\n}\r\n}\r\nelse if (matchfront) {\r\nnewdup = (xfs_dir2_data_unused_t *)((char *)hdr + offset + len);\r\nnewdup->freetag = cpu_to_be16(XFS_DIR2_DATA_FREE_TAG);\r\nnewdup->length = cpu_to_be16(oldlen - len);\r\n*xfs_dir2_data_unused_tag_p(newdup) =\r\ncpu_to_be16((char *)newdup - (char *)hdr);\r\nxfs_dir2_data_log_unused(args, bp, newdup);\r\nif (dfp) {\r\nxfs_dir2_data_freeremove(hdr, bf, dfp, needlogp);\r\ndfp = xfs_dir2_data_freeinsert(hdr, bf, newdup,\r\nneedlogp);\r\nASSERT(dfp != NULL);\r\nASSERT(dfp->length == newdup->length);\r\nASSERT(be16_to_cpu(dfp->offset) == (char *)newdup - (char *)hdr);\r\nneedscan = dfp == &bf[2];\r\n}\r\n}\r\nelse if (matchback) {\r\nnewdup = dup;\r\nnewdup->length = cpu_to_be16(((char *)hdr + offset) - (char *)newdup);\r\n*xfs_dir2_data_unused_tag_p(newdup) =\r\ncpu_to_be16((char *)newdup - (char *)hdr);\r\nxfs_dir2_data_log_unused(args, bp, newdup);\r\nif (dfp) {\r\nxfs_dir2_data_freeremove(hdr, bf, dfp, needlogp);\r\ndfp = xfs_dir2_data_freeinsert(hdr, bf, newdup,\r\nneedlogp);\r\nASSERT(dfp != NULL);\r\nASSERT(dfp->length == newdup->length);\r\nASSERT(be16_to_cpu(dfp->offset) == (char *)newdup - (char *)hdr);\r\nneedscan = dfp == &bf[2];\r\n}\r\n}\r\nelse {\r\nnewdup = dup;\r\nnewdup->length = cpu_to_be16(((char *)hdr + offset) - (char *)newdup);\r\n*xfs_dir2_data_unused_tag_p(newdup) =\r\ncpu_to_be16((char *)newdup - (char *)hdr);\r\nxfs_dir2_data_log_unused(args, bp, newdup);\r\nnewdup2 = (xfs_dir2_data_unused_t *)((char *)hdr + offset + len);\r\nnewdup2->freetag = cpu_to_be16(XFS_DIR2_DATA_FREE_TAG);\r\nnewdup2->length = cpu_to_be16(oldlen - len - be16_to_cpu(newdup->length));\r\n*xfs_dir2_data_unused_tag_p(newdup2) =\r\ncpu_to_be16((char *)newdup2 - (char *)hdr);\r\nxfs_dir2_data_log_unused(args, bp, newdup2);\r\nif (dfp) {\r\nneedscan = (bf[2].length != 0);\r\nif (!needscan) {\r\nxfs_dir2_data_freeremove(hdr, bf, dfp,\r\nneedlogp);\r\nxfs_dir2_data_freeinsert(hdr, bf, newdup,\r\nneedlogp);\r\nxfs_dir2_data_freeinsert(hdr, bf, newdup2,\r\nneedlogp);\r\n}\r\n}\r\n}\r\n*needscanp = needscan;\r\n}

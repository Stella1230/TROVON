int opal_tracepoint_regfunc(void)\r\n{\r\nstatic_key_slow_inc(&opal_tracepoint_key);\r\nreturn 0;\r\n}\r\nvoid opal_tracepoint_unregfunc(void)\r\n{\r\nstatic_key_slow_dec(&opal_tracepoint_key);\r\n}\r\nint opal_tracepoint_regfunc(void)\r\n{\r\nopal_tracepoint_refcount++;\r\nreturn 0;\r\n}\r\nvoid opal_tracepoint_unregfunc(void)\r\n{\r\nopal_tracepoint_refcount--;\r\n}\r\nvoid __trace_opal_entry(unsigned long opcode, unsigned long *args)\r\n{\r\nunsigned long flags;\r\nunsigned int *depth;\r\nlocal_irq_save(flags);\r\ndepth = this_cpu_ptr(&opal_trace_depth);\r\nif (*depth)\r\ngoto out;\r\n(*depth)++;\r\npreempt_disable();\r\ntrace_opal_entry(opcode, args);\r\n(*depth)--;\r\nout:\r\nlocal_irq_restore(flags);\r\n}\r\nvoid __trace_opal_exit(long opcode, unsigned long retval)\r\n{\r\nunsigned long flags;\r\nunsigned int *depth;\r\nlocal_irq_save(flags);\r\ndepth = this_cpu_ptr(&opal_trace_depth);\r\nif (*depth)\r\ngoto out;\r\n(*depth)++;\r\ntrace_opal_exit(opcode, retval);\r\npreempt_enable();\r\n(*depth)--;\r\nout:\r\nlocal_irq_restore(flags);\r\n}

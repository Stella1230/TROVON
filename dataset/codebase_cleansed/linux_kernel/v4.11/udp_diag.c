static int sk_diag_dump(struct sock *sk, struct sk_buff *skb,\r\nstruct netlink_callback *cb,\r\nconst struct inet_diag_req_v2 *req,\r\nstruct nlattr *bc, bool net_admin)\r\n{\r\nif (!inet_diag_bc_sk(bc, sk))\r\nreturn 0;\r\nreturn inet_sk_diag_fill(sk, NULL, skb, req,\r\nsk_user_ns(NETLINK_CB(cb->skb).sk),\r\nNETLINK_CB(cb->skb).portid,\r\ncb->nlh->nlmsg_seq, NLM_F_MULTI, cb->nlh, net_admin);\r\n}\r\nstatic int udp_dump_one(struct udp_table *tbl, struct sk_buff *in_skb,\r\nconst struct nlmsghdr *nlh,\r\nconst struct inet_diag_req_v2 *req)\r\n{\r\nint err = -EINVAL;\r\nstruct sock *sk = NULL;\r\nstruct sk_buff *rep;\r\nstruct net *net = sock_net(in_skb->sk);\r\nrcu_read_lock();\r\nif (req->sdiag_family == AF_INET)\r\nsk = __udp4_lib_lookup(net,\r\nreq->id.idiag_src[0], req->id.idiag_sport,\r\nreq->id.idiag_dst[0], req->id.idiag_dport,\r\nreq->id.idiag_if, tbl, NULL);\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nelse if (req->sdiag_family == AF_INET6)\r\nsk = __udp6_lib_lookup(net,\r\n(struct in6_addr *)req->id.idiag_src,\r\nreq->id.idiag_sport,\r\n(struct in6_addr *)req->id.idiag_dst,\r\nreq->id.idiag_dport,\r\nreq->id.idiag_if, tbl, NULL);\r\n#endif\r\nif (sk && !atomic_inc_not_zero(&sk->sk_refcnt))\r\nsk = NULL;\r\nrcu_read_unlock();\r\nerr = -ENOENT;\r\nif (!sk)\r\ngoto out_nosk;\r\nerr = sock_diag_check_cookie(sk, req->id.idiag_cookie);\r\nif (err)\r\ngoto out;\r\nerr = -ENOMEM;\r\nrep = nlmsg_new(sizeof(struct inet_diag_msg) +\r\nsizeof(struct inet_diag_meminfo) + 64,\r\nGFP_KERNEL);\r\nif (!rep)\r\ngoto out;\r\nerr = inet_sk_diag_fill(sk, NULL, rep, req,\r\nsk_user_ns(NETLINK_CB(in_skb).sk),\r\nNETLINK_CB(in_skb).portid,\r\nnlh->nlmsg_seq, 0, nlh,\r\nnetlink_net_capable(in_skb, CAP_NET_ADMIN));\r\nif (err < 0) {\r\nWARN_ON(err == -EMSGSIZE);\r\nkfree_skb(rep);\r\ngoto out;\r\n}\r\nerr = netlink_unicast(net->diag_nlsk, rep, NETLINK_CB(in_skb).portid,\r\nMSG_DONTWAIT);\r\nif (err > 0)\r\nerr = 0;\r\nout:\r\nif (sk)\r\nsock_put(sk);\r\nout_nosk:\r\nreturn err;\r\n}\r\nstatic void udp_dump(struct udp_table *table, struct sk_buff *skb,\r\nstruct netlink_callback *cb,\r\nconst struct inet_diag_req_v2 *r, struct nlattr *bc)\r\n{\r\nbool net_admin = netlink_net_capable(cb->skb, CAP_NET_ADMIN);\r\nstruct net *net = sock_net(skb->sk);\r\nint num, s_num, slot, s_slot;\r\ns_slot = cb->args[0];\r\nnum = s_num = cb->args[1];\r\nfor (slot = s_slot; slot <= table->mask; s_num = 0, slot++) {\r\nstruct udp_hslot *hslot = &table->hash[slot];\r\nstruct sock *sk;\r\nnum = 0;\r\nif (hlist_empty(&hslot->head))\r\ncontinue;\r\nspin_lock_bh(&hslot->lock);\r\nsk_for_each(sk, &hslot->head) {\r\nstruct inet_sock *inet = inet_sk(sk);\r\nif (!net_eq(sock_net(sk), net))\r\ncontinue;\r\nif (num < s_num)\r\ngoto next;\r\nif (!(r->idiag_states & (1 << sk->sk_state)))\r\ngoto next;\r\nif (r->sdiag_family != AF_UNSPEC &&\r\nsk->sk_family != r->sdiag_family)\r\ngoto next;\r\nif (r->id.idiag_sport != inet->inet_sport &&\r\nr->id.idiag_sport)\r\ngoto next;\r\nif (r->id.idiag_dport != inet->inet_dport &&\r\nr->id.idiag_dport)\r\ngoto next;\r\nif (sk_diag_dump(sk, skb, cb, r, bc, net_admin) < 0) {\r\nspin_unlock_bh(&hslot->lock);\r\ngoto done;\r\n}\r\nnext:\r\nnum++;\r\n}\r\nspin_unlock_bh(&hslot->lock);\r\n}\r\ndone:\r\ncb->args[0] = slot;\r\ncb->args[1] = num;\r\n}\r\nstatic void udp_diag_dump(struct sk_buff *skb, struct netlink_callback *cb,\r\nconst struct inet_diag_req_v2 *r, struct nlattr *bc)\r\n{\r\nudp_dump(&udp_table, skb, cb, r, bc);\r\n}\r\nstatic int udp_diag_dump_one(struct sk_buff *in_skb, const struct nlmsghdr *nlh,\r\nconst struct inet_diag_req_v2 *req)\r\n{\r\nreturn udp_dump_one(&udp_table, in_skb, nlh, req);\r\n}\r\nstatic void udp_diag_get_info(struct sock *sk, struct inet_diag_msg *r,\r\nvoid *info)\r\n{\r\nr->idiag_rqueue = sk_rmem_alloc_get(sk);\r\nr->idiag_wqueue = sk_wmem_alloc_get(sk);\r\n}\r\nstatic int __udp_diag_destroy(struct sk_buff *in_skb,\r\nconst struct inet_diag_req_v2 *req,\r\nstruct udp_table *tbl)\r\n{\r\nstruct net *net = sock_net(in_skb->sk);\r\nstruct sock *sk;\r\nint err;\r\nrcu_read_lock();\r\nif (req->sdiag_family == AF_INET)\r\nsk = __udp4_lib_lookup(net,\r\nreq->id.idiag_dst[0], req->id.idiag_dport,\r\nreq->id.idiag_src[0], req->id.idiag_sport,\r\nreq->id.idiag_if, tbl, NULL);\r\n#if IS_ENABLED(CONFIG_IPV6)\r\nelse if (req->sdiag_family == AF_INET6) {\r\nif (ipv6_addr_v4mapped((struct in6_addr *)req->id.idiag_dst) &&\r\nipv6_addr_v4mapped((struct in6_addr *)req->id.idiag_src))\r\nsk = __udp4_lib_lookup(net,\r\nreq->id.idiag_dst[3], req->id.idiag_dport,\r\nreq->id.idiag_src[3], req->id.idiag_sport,\r\nreq->id.idiag_if, tbl, NULL);\r\nelse\r\nsk = __udp6_lib_lookup(net,\r\n(struct in6_addr *)req->id.idiag_dst,\r\nreq->id.idiag_dport,\r\n(struct in6_addr *)req->id.idiag_src,\r\nreq->id.idiag_sport,\r\nreq->id.idiag_if, tbl, NULL);\r\n}\r\n#endif\r\nelse {\r\nrcu_read_unlock();\r\nreturn -EINVAL;\r\n}\r\nif (sk && !atomic_inc_not_zero(&sk->sk_refcnt))\r\nsk = NULL;\r\nrcu_read_unlock();\r\nif (!sk)\r\nreturn -ENOENT;\r\nif (sock_diag_check_cookie(sk, req->id.idiag_cookie)) {\r\nsock_put(sk);\r\nreturn -ENOENT;\r\n}\r\nerr = sock_diag_destroy(sk, ECONNABORTED);\r\nsock_put(sk);\r\nreturn err;\r\n}\r\nstatic int udp_diag_destroy(struct sk_buff *in_skb,\r\nconst struct inet_diag_req_v2 *req)\r\n{\r\nreturn __udp_diag_destroy(in_skb, req, &udp_table);\r\n}\r\nstatic int udplite_diag_destroy(struct sk_buff *in_skb,\r\nconst struct inet_diag_req_v2 *req)\r\n{\r\nreturn __udp_diag_destroy(in_skb, req, &udplite_table);\r\n}\r\nstatic void udplite_diag_dump(struct sk_buff *skb, struct netlink_callback *cb,\r\nconst struct inet_diag_req_v2 *r,\r\nstruct nlattr *bc)\r\n{\r\nudp_dump(&udplite_table, skb, cb, r, bc);\r\n}\r\nstatic int udplite_diag_dump_one(struct sk_buff *in_skb, const struct nlmsghdr *nlh,\r\nconst struct inet_diag_req_v2 *req)\r\n{\r\nreturn udp_dump_one(&udplite_table, in_skb, nlh, req);\r\n}\r\nstatic int __init udp_diag_init(void)\r\n{\r\nint err;\r\nerr = inet_diag_register(&udp_diag_handler);\r\nif (err)\r\ngoto out;\r\nerr = inet_diag_register(&udplite_diag_handler);\r\nif (err)\r\ngoto out_lite;\r\nout:\r\nreturn err;\r\nout_lite:\r\ninet_diag_unregister(&udp_diag_handler);\r\ngoto out;\r\n}\r\nstatic void __exit udp_diag_exit(void)\r\n{\r\ninet_diag_unregister(&udplite_diag_handler);\r\ninet_diag_unregister(&udp_diag_handler);\r\n}

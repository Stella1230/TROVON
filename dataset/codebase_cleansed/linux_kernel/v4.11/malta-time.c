static void mips_timer_dispatch(void)\r\n{\r\ndo_IRQ(mips_cpu_timer_irq);\r\n}\r\nstatic void mips_perf_dispatch(void)\r\n{\r\ndo_IRQ(mips_cpu_perf_irq);\r\n}\r\nstatic unsigned int freqround(unsigned int freq, unsigned int amount)\r\n{\r\nfreq += amount;\r\nfreq -= freq % (amount*2);\r\nreturn freq;\r\n}\r\nstatic void __init estimate_frequencies(void)\r\n{\r\nunsigned long flags;\r\nunsigned int count, start;\r\nunsigned char secs1, secs2, ctrl;\r\nint secs;\r\nu64 giccount = 0, gicstart = 0;\r\n#if defined(CONFIG_KVM_GUEST) && CONFIG_KVM_GUEST_TIMER_FREQ\r\nmips_hpt_frequency = CONFIG_KVM_GUEST_TIMER_FREQ * 1000000;\r\nreturn;\r\n#endif\r\nlocal_irq_save(flags);\r\nif (gic_present)\r\ngic_start_count();\r\nwhile (CMOS_READ(RTC_REG_A) & RTC_UIP);\r\nwhile (!(CMOS_READ(RTC_REG_A) & RTC_UIP));\r\nstart = read_c0_count();\r\nif (gic_present)\r\ngicstart = gic_read_count();\r\nwhile (CMOS_READ(RTC_REG_A) & RTC_UIP);\r\nsecs1 = CMOS_READ(RTC_SECONDS);\r\nwhile (!(CMOS_READ(RTC_REG_A) & RTC_UIP));\r\ncount = read_c0_count();\r\nif (gic_present)\r\ngiccount = gic_read_count();\r\nwhile (CMOS_READ(RTC_REG_A) & RTC_UIP);\r\nsecs2 = CMOS_READ(RTC_SECONDS);\r\nctrl = CMOS_READ(RTC_CONTROL);\r\nlocal_irq_restore(flags);\r\nif (!(ctrl & RTC_DM_BINARY) || RTC_ALWAYS_BCD) {\r\nsecs1 = bcd2bin(secs1);\r\nsecs2 = bcd2bin(secs2);\r\n}\r\nsecs = secs2 - secs1;\r\nif (secs < 1)\r\nsecs += 60;\r\ncount -= start;\r\ncount /= secs;\r\nmips_hpt_frequency = count;\r\nif (gic_present) {\r\ngiccount = div_u64(giccount - gicstart, secs);\r\ngic_frequency = giccount;\r\n}\r\n}\r\nvoid read_persistent_clock(struct timespec *ts)\r\n{\r\nts->tv_sec = mc146818_get_cmos_time();\r\nts->tv_nsec = 0;\r\n}\r\nint get_c0_fdc_int(void)\r\n{\r\nswitch (current_cpu_type()) {\r\ncase CPU_INTERAPTIV:\r\ncase CPU_PROAPTIV:\r\nreturn -1;\r\n};\r\nif (cpu_has_veic)\r\nreturn -1;\r\nelse if (gic_present)\r\nreturn gic_get_c0_fdc_int();\r\nelse if (cp0_fdc_irq >= 0)\r\nreturn MIPS_CPU_IRQ_BASE + cp0_fdc_irq;\r\nelse\r\nreturn -1;\r\n}\r\nint get_c0_perfcount_int(void)\r\n{\r\nif (cpu_has_veic) {\r\nset_vi_handler(MSC01E_INT_PERFCTR, mips_perf_dispatch);\r\nmips_cpu_perf_irq = MSC01E_INT_BASE + MSC01E_INT_PERFCTR;\r\n} else if (gic_present) {\r\nmips_cpu_perf_irq = gic_get_c0_perfcount_int();\r\n} else if (cp0_perfcount_irq >= 0) {\r\nmips_cpu_perf_irq = MIPS_CPU_IRQ_BASE + cp0_perfcount_irq;\r\n} else {\r\nmips_cpu_perf_irq = -1;\r\n}\r\nreturn mips_cpu_perf_irq;\r\n}\r\nunsigned int get_c0_compare_int(void)\r\n{\r\nif (cpu_has_veic) {\r\nset_vi_handler(MSC01E_INT_CPUCTR, mips_timer_dispatch);\r\nmips_cpu_timer_irq = MSC01E_INT_BASE + MSC01E_INT_CPUCTR;\r\n} else if (gic_present) {\r\nmips_cpu_timer_irq = gic_get_c0_compare_int();\r\n} else {\r\nmips_cpu_timer_irq = MIPS_CPU_IRQ_BASE + cp0_compare_irq;\r\n}\r\nreturn mips_cpu_timer_irq;\r\n}\r\nstatic void __init init_rtc(void)\r\n{\r\nunsigned char freq, ctrl;\r\nfreq = CMOS_READ(RTC_FREQ_SELECT);\r\nif ((freq & RTC_DIV_CTL) != RTC_REF_CLCK_32KHZ)\r\nCMOS_WRITE(RTC_REF_CLCK_32KHZ, RTC_FREQ_SELECT);\r\nctrl = CMOS_READ(RTC_CONTROL);\r\nif (ctrl & RTC_SET)\r\nCMOS_WRITE(ctrl & ~RTC_SET, RTC_CONTROL);\r\n}\r\nvoid __init plat_time_init(void)\r\n{\r\nunsigned int prid = read_c0_prid() & (PRID_COMP_MASK | PRID_IMP_MASK);\r\nunsigned int freq;\r\ninit_rtc();\r\nestimate_frequencies();\r\nfreq = mips_hpt_frequency;\r\nif ((prid != (PRID_COMP_MIPS | PRID_IMP_20KC)) &&\r\n(prid != (PRID_COMP_MIPS | PRID_IMP_25KF)))\r\nfreq *= 2;\r\nfreq = freqround(freq, 5000);\r\nprintk("CPU frequency %d.%02d MHz\n", freq/1000000,\r\n(freq%1000000)*100/1000000);\r\nmips_scroll_message();\r\n#ifdef CONFIG_I8253\r\nsetup_pit_timer();\r\n#endif\r\n#ifdef CONFIG_MIPS_GIC\r\nif (gic_present) {\r\nfreq = freqround(gic_frequency, 5000);\r\nprintk("GIC frequency %d.%02d MHz\n", freq/1000000,\r\n(freq%1000000)*100/1000000);\r\n#ifdef CONFIG_CLKSRC_MIPS_GIC\r\ngic_clocksource_init(gic_frequency);\r\n#endif\r\n}\r\n#endif\r\n}

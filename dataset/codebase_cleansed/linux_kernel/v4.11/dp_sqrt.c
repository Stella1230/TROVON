union ieee754dp ieee754dp_sqrt(union ieee754dp x)\r\n{\r\nstruct _ieee754_csr oldcsr;\r\nunion ieee754dp y, z, t;\r\nunsigned scalx, yh;\r\nCOMPXDP;\r\nEXPLODEXDP;\r\nieee754_clearcx();\r\nFLUSHXDP;\r\nswitch (xc) {\r\ncase IEEE754_CLASS_SNAN:\r\nreturn ieee754dp_nanxcpt(x);\r\ncase IEEE754_CLASS_QNAN:\r\nreturn x;\r\ncase IEEE754_CLASS_ZERO:\r\nreturn x;\r\ncase IEEE754_CLASS_INF:\r\nif (xs) {\r\nieee754_setcx(IEEE754_INVALID_OPERATION);\r\nreturn ieee754dp_indef();\r\n}\r\nreturn x;\r\ncase IEEE754_CLASS_DNORM:\r\nDPDNORMX;\r\ncase IEEE754_CLASS_NORM:\r\nif (xs) {\r\nieee754_setcx(IEEE754_INVALID_OPERATION);\r\nreturn ieee754dp_indef();\r\n}\r\nbreak;\r\n}\r\noldcsr = ieee754_csr;\r\nieee754_csr.mx &= ~IEEE754_INEXACT;\r\nieee754_csr.sx &= ~IEEE754_INEXACT;\r\nieee754_csr.rm = FPU_CSR_RN;\r\nscalx = 0;\r\nif (xe > 512) {\r\nxe -= 512;\r\nscalx += 256;\r\n} else if (xe < -512) {\r\nxe += 512;\r\nscalx -= 256;\r\n}\r\ny = x = builddp(0, xe + DP_EBIAS, xm & ~DP_HIDDEN_BIT);\r\nyh = y.bits >> 32;\r\nyh = (yh >> 1) + 0x1ff80000;\r\nyh = yh - table[(yh >> 15) & 31];\r\ny.bits = ((u64) yh << 32) | (y.bits & 0xffffffff);\r\nt = ieee754dp_div(x, y);\r\ny = ieee754dp_add(y, t);\r\ny.bits -= 0x0010000600000000LL;\r\ny.bits &= 0xffffffff00000000LL;\r\nz = t = ieee754dp_mul(y, y);\r\nt.bexp += 0x001;\r\nt = ieee754dp_add(t, z);\r\nz = ieee754dp_mul(ieee754dp_sub(x, z), y);\r\nt = ieee754dp_div(z, ieee754dp_add(t, x));\r\nt.bexp += 0x001;\r\ny = ieee754dp_add(y, t);\r\nieee754_csr.rm = FPU_CSR_RZ;\r\nieee754_csr.sx &= ~IEEE754_INEXACT;\r\nt = ieee754dp_div(x, y);\r\nif (ieee754_csr.sx & IEEE754_INEXACT || t.bits != y.bits) {\r\nif (!(ieee754_csr.sx & IEEE754_INEXACT))\r\nt.bits -= 1;\r\noldcsr.cx |= IEEE754_INEXACT;\r\noldcsr.sx |= IEEE754_INEXACT;\r\nswitch (oldcsr.rm) {\r\ncase FPU_CSR_RU:\r\ny.bits += 1;\r\ncase FPU_CSR_RN:\r\nt.bits += 1;\r\nbreak;\r\n}\r\ny = ieee754dp_add(y, t);\r\nscalx -= 1;\r\n}\r\ny.bexp += scalx;\r\nieee754_csr = oldcsr;\r\nreturn y;\r\n}

static void omap3_rom_rng_idle(struct work_struct *work)\r\n{\r\nint r;\r\nr = omap3_rom_rng_call(0, 0, RNG_RESET);\r\nif (r != 0) {\r\npr_err("reset failed: %d\n", r);\r\nreturn;\r\n}\r\nclk_disable_unprepare(rng_clk);\r\nrng_idle = 1;\r\n}\r\nstatic int omap3_rom_rng_get_random(void *buf, unsigned int count)\r\n{\r\nu32 r;\r\nu32 ptr;\r\ncancel_delayed_work_sync(&idle_work);\r\nif (rng_idle) {\r\nclk_prepare_enable(rng_clk);\r\nr = omap3_rom_rng_call(0, 0, RNG_GEN_PRNG_HW_INIT);\r\nif (r != 0) {\r\nclk_disable_unprepare(rng_clk);\r\npr_err("HW init failed: %d\n", r);\r\nreturn -EIO;\r\n}\r\nrng_idle = 0;\r\n}\r\nptr = virt_to_phys(buf);\r\nr = omap3_rom_rng_call(ptr, count, RNG_GEN_HW);\r\nschedule_delayed_work(&idle_work, msecs_to_jiffies(500));\r\nif (r != 0)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int omap3_rom_rng_read(struct hwrng *rng, void *data, size_t max, bool w)\r\n{\r\nint r;\r\nr = omap3_rom_rng_get_random(data, 4);\r\nif (r < 0)\r\nreturn r;\r\nreturn 4;\r\n}\r\nstatic int omap3_rom_rng_probe(struct platform_device *pdev)\r\n{\r\npr_info("initializing\n");\r\nomap3_rom_rng_call = pdev->dev.platform_data;\r\nif (!omap3_rom_rng_call) {\r\npr_err("omap3_rom_rng_call is NULL\n");\r\nreturn -EINVAL;\r\n}\r\nINIT_DELAYED_WORK(&idle_work, omap3_rom_rng_idle);\r\nrng_clk = devm_clk_get(&pdev->dev, "ick");\r\nif (IS_ERR(rng_clk)) {\r\npr_err("unable to get RNG clock\n");\r\nreturn PTR_ERR(rng_clk);\r\n}\r\nclk_prepare_enable(rng_clk);\r\nomap3_rom_rng_idle(0);\r\nreturn hwrng_register(&omap3_rom_rng_ops);\r\n}\r\nstatic int omap3_rom_rng_remove(struct platform_device *pdev)\r\n{\r\ncancel_delayed_work_sync(&idle_work);\r\nhwrng_unregister(&omap3_rom_rng_ops);\r\nclk_disable_unprepare(rng_clk);\r\nreturn 0;\r\n}

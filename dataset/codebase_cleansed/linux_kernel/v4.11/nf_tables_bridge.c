static unsigned int\r\nnft_do_chain_bridge(void *priv,\r\nstruct sk_buff *skb,\r\nconst struct nf_hook_state *state)\r\n{\r\nstruct nft_pktinfo pkt;\r\nswitch (eth_hdr(skb)->h_proto) {\r\ncase htons(ETH_P_IP):\r\nnft_set_pktinfo_ipv4_validate(&pkt, skb, state);\r\nbreak;\r\ncase htons(ETH_P_IPV6):\r\nnft_set_pktinfo_ipv6_validate(&pkt, skb, state);\r\nbreak;\r\ndefault:\r\nnft_set_pktinfo_unspec(&pkt, skb, state);\r\nbreak;\r\n}\r\nreturn nft_do_chain(&pkt, priv);\r\n}\r\nstatic int nf_tables_bridge_init_net(struct net *net)\r\n{\r\nnet->nft.bridge = kmalloc(sizeof(struct nft_af_info), GFP_KERNEL);\r\nif (net->nft.bridge == NULL)\r\nreturn -ENOMEM;\r\nmemcpy(net->nft.bridge, &nft_af_bridge, sizeof(nft_af_bridge));\r\nif (nft_register_afinfo(net, net->nft.bridge) < 0)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\nkfree(net->nft.bridge);\r\nreturn -ENOMEM;\r\n}\r\nstatic void nf_tables_bridge_exit_net(struct net *net)\r\n{\r\nnft_unregister_afinfo(net, net->nft.bridge);\r\nkfree(net->nft.bridge);\r\n}\r\nstatic void nf_br_saveroute(const struct sk_buff *skb,\r\nstruct nf_queue_entry *entry)\r\n{\r\n}\r\nstatic int nf_br_reroute(struct net *net, struct sk_buff *skb,\r\nconst struct nf_queue_entry *entry)\r\n{\r\nreturn 0;\r\n}\r\nstatic __sum16 nf_br_checksum(struct sk_buff *skb, unsigned int hook,\r\nunsigned int dataoff, u_int8_t protocol)\r\n{\r\nreturn 0;\r\n}\r\nstatic __sum16 nf_br_checksum_partial(struct sk_buff *skb, unsigned int hook,\r\nunsigned int dataoff, unsigned int len,\r\nu_int8_t protocol)\r\n{\r\nreturn 0;\r\n}\r\nstatic int nf_br_route(struct net *net, struct dst_entry **dst,\r\nstruct flowi *fl, bool strict __always_unused)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __init nf_tables_bridge_init(void)\r\n{\r\nint ret;\r\nnf_register_afinfo(&nf_br_afinfo);\r\nret = nft_register_chain_type(&filter_bridge);\r\nif (ret < 0)\r\ngoto err1;\r\nret = register_pernet_subsys(&nf_tables_bridge_net_ops);\r\nif (ret < 0)\r\ngoto err2;\r\nreturn ret;\r\nerr2:\r\nnft_unregister_chain_type(&filter_bridge);\r\nerr1:\r\nnf_unregister_afinfo(&nf_br_afinfo);\r\nreturn ret;\r\n}\r\nstatic void __exit nf_tables_bridge_exit(void)\r\n{\r\nunregister_pernet_subsys(&nf_tables_bridge_net_ops);\r\nnft_unregister_chain_type(&filter_bridge);\r\nnf_unregister_afinfo(&nf_br_afinfo);\r\n}

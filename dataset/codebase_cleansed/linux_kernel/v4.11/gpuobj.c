static u32\r\nnvkm_gpuobj_rd32_fast(struct nvkm_gpuobj *gpuobj, u32 offset)\r\n{\r\nreturn ioread32_native(gpuobj->map + offset);\r\n}\r\nstatic void\r\nnvkm_gpuobj_wr32_fast(struct nvkm_gpuobj *gpuobj, u32 offset, u32 data)\r\n{\r\niowrite32_native(data, gpuobj->map + offset);\r\n}\r\nstatic u32\r\nnvkm_gpuobj_heap_rd32(struct nvkm_gpuobj *gpuobj, u32 offset)\r\n{\r\nreturn nvkm_ro32(gpuobj->memory, offset);\r\n}\r\nstatic void\r\nnvkm_gpuobj_heap_wr32(struct nvkm_gpuobj *gpuobj, u32 offset, u32 data)\r\n{\r\nnvkm_wo32(gpuobj->memory, offset, data);\r\n}\r\nstatic void\r\nnvkm_gpuobj_heap_release(struct nvkm_gpuobj *gpuobj)\r\n{\r\ngpuobj->func = &nvkm_gpuobj_heap;\r\nnvkm_done(gpuobj->memory);\r\n}\r\nstatic void *\r\nnvkm_gpuobj_heap_acquire(struct nvkm_gpuobj *gpuobj)\r\n{\r\ngpuobj->map = nvkm_kmap(gpuobj->memory);\r\nif (likely(gpuobj->map))\r\ngpuobj->func = &nvkm_gpuobj_heap_fast;\r\nelse\r\ngpuobj->func = &nvkm_gpuobj_heap_slow;\r\nreturn gpuobj->map;\r\n}\r\nstatic u32\r\nnvkm_gpuobj_rd32(struct nvkm_gpuobj *gpuobj, u32 offset)\r\n{\r\nreturn nvkm_ro32(gpuobj->parent, gpuobj->node->offset + offset);\r\n}\r\nstatic void\r\nnvkm_gpuobj_wr32(struct nvkm_gpuobj *gpuobj, u32 offset, u32 data)\r\n{\r\nnvkm_wo32(gpuobj->parent, gpuobj->node->offset + offset, data);\r\n}\r\nstatic void\r\nnvkm_gpuobj_release(struct nvkm_gpuobj *gpuobj)\r\n{\r\ngpuobj->func = &nvkm_gpuobj_func;\r\nnvkm_done(gpuobj->parent);\r\n}\r\nstatic void *\r\nnvkm_gpuobj_acquire(struct nvkm_gpuobj *gpuobj)\r\n{\r\ngpuobj->map = nvkm_kmap(gpuobj->parent);\r\nif (likely(gpuobj->map)) {\r\ngpuobj->map = (u8 *)gpuobj->map + gpuobj->node->offset;\r\ngpuobj->func = &nvkm_gpuobj_fast;\r\n} else {\r\ngpuobj->func = &nvkm_gpuobj_slow;\r\n}\r\nreturn gpuobj->map;\r\n}\r\nstatic int\r\nnvkm_gpuobj_ctor(struct nvkm_device *device, u32 size, int align, bool zero,\r\nstruct nvkm_gpuobj *parent, struct nvkm_gpuobj *gpuobj)\r\n{\r\nu32 offset;\r\nint ret;\r\nif (parent) {\r\nif (align >= 0) {\r\nret = nvkm_mm_head(&parent->heap, 0, 1, size, size,\r\nmax(align, 1), &gpuobj->node);\r\n} else {\r\nret = nvkm_mm_tail(&parent->heap, 0, 1, size, size,\r\n-align, &gpuobj->node);\r\n}\r\nif (ret)\r\nreturn ret;\r\ngpuobj->parent = parent;\r\ngpuobj->func = &nvkm_gpuobj_func;\r\ngpuobj->addr = parent->addr + gpuobj->node->offset;\r\ngpuobj->size = gpuobj->node->length;\r\nif (zero) {\r\nnvkm_kmap(gpuobj);\r\nfor (offset = 0; offset < gpuobj->size; offset += 4)\r\nnvkm_wo32(gpuobj, offset, 0x00000000);\r\nnvkm_done(gpuobj);\r\n}\r\n} else {\r\nret = nvkm_memory_new(device, NVKM_MEM_TARGET_INST, size,\r\nabs(align), zero, &gpuobj->memory);\r\nif (ret)\r\nreturn ret;\r\ngpuobj->func = &nvkm_gpuobj_heap;\r\ngpuobj->addr = nvkm_memory_addr(gpuobj->memory);\r\ngpuobj->size = nvkm_memory_size(gpuobj->memory);\r\n}\r\nreturn nvkm_mm_init(&gpuobj->heap, 0, gpuobj->size, 1);\r\n}\r\nvoid\r\nnvkm_gpuobj_del(struct nvkm_gpuobj **pgpuobj)\r\n{\r\nstruct nvkm_gpuobj *gpuobj = *pgpuobj;\r\nif (gpuobj) {\r\nif (gpuobj->parent)\r\nnvkm_mm_free(&gpuobj->parent->heap, &gpuobj->node);\r\nnvkm_mm_fini(&gpuobj->heap);\r\nnvkm_memory_del(&gpuobj->memory);\r\nkfree(*pgpuobj);\r\n*pgpuobj = NULL;\r\n}\r\n}\r\nint\r\nnvkm_gpuobj_new(struct nvkm_device *device, u32 size, int align, bool zero,\r\nstruct nvkm_gpuobj *parent, struct nvkm_gpuobj **pgpuobj)\r\n{\r\nstruct nvkm_gpuobj *gpuobj;\r\nint ret;\r\nif (!(gpuobj = *pgpuobj = kzalloc(sizeof(*gpuobj), GFP_KERNEL)))\r\nreturn -ENOMEM;\r\nret = nvkm_gpuobj_ctor(device, size, align, zero, parent, gpuobj);\r\nif (ret)\r\nnvkm_gpuobj_del(pgpuobj);\r\nreturn ret;\r\n}\r\nint\r\nnvkm_gpuobj_map(struct nvkm_gpuobj *gpuobj, struct nvkm_vm *vm,\r\nu32 access, struct nvkm_vma *vma)\r\n{\r\nstruct nvkm_memory *memory = gpuobj->memory;\r\nint ret = nvkm_vm_get(vm, gpuobj->size, 12, access, vma);\r\nif (ret == 0)\r\nnvkm_memory_map(memory, vma, 0);\r\nreturn ret;\r\n}\r\nvoid\r\nnvkm_gpuobj_unmap(struct nvkm_vma *vma)\r\n{\r\nif (vma->node) {\r\nnvkm_vm_unmap(vma);\r\nnvkm_vm_put(vma);\r\n}\r\n}\r\nint\r\nnvkm_gpuobj_wrap(struct nvkm_memory *memory, struct nvkm_gpuobj **pgpuobj)\r\n{\r\nif (!(*pgpuobj = kzalloc(sizeof(**pgpuobj), GFP_KERNEL)))\r\nreturn -ENOMEM;\r\n(*pgpuobj)->addr = nvkm_memory_addr(memory);\r\n(*pgpuobj)->size = nvkm_memory_size(memory);\r\nreturn 0;\r\n}\r\nvoid\r\nnvkm_gpuobj_memcpy_to(struct nvkm_gpuobj *dst, u32 dstoffset, void *src,\r\nu32 length)\r\n{\r\nint i;\r\nfor (i = 0; i < length; i += 4)\r\nnvkm_wo32(dst, dstoffset + i, *(u32 *)(src + i));\r\n}\r\nvoid\r\nnvkm_gpuobj_memcpy_from(void *dst, struct nvkm_gpuobj *src, u32 srcoffset,\r\nu32 length)\r\n{\r\nint i;\r\nfor (i = 0; i < length; i += 4)\r\n((u32 *)src)[i / 4] = nvkm_ro32(src, srcoffset + i);\r\n}

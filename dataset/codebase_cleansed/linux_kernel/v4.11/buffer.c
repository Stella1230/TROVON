void __init usb_init_pool_max(void)\r\n{\r\nif (ARCH_KMALLOC_MINALIGN <= 32)\r\n;\r\nelse if (ARCH_KMALLOC_MINALIGN <= 64)\r\npool_max[0] = 64;\r\nelse if (ARCH_KMALLOC_MINALIGN <= 128)\r\npool_max[0] = 0;\r\nelse\r\nBUILD_BUG();\r\n}\r\nint hcd_buffer_create(struct usb_hcd *hcd)\r\n{\r\nchar name[16];\r\nint i, size;\r\nif (!IS_ENABLED(CONFIG_HAS_DMA) ||\r\n(!hcd->self.controller->dma_mask &&\r\n!(hcd->driver->flags & HCD_LOCAL_MEM)))\r\nreturn 0;\r\nfor (i = 0; i < HCD_BUFFER_POOLS; i++) {\r\nsize = pool_max[i];\r\nif (!size)\r\ncontinue;\r\nsnprintf(name, sizeof(name), "buffer-%d", size);\r\nhcd->pool[i] = dma_pool_create(name, hcd->self.controller,\r\nsize, size, 0);\r\nif (!hcd->pool[i]) {\r\nhcd_buffer_destroy(hcd);\r\nreturn -ENOMEM;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid hcd_buffer_destroy(struct usb_hcd *hcd)\r\n{\r\nint i;\r\nif (!IS_ENABLED(CONFIG_HAS_DMA))\r\nreturn;\r\nfor (i = 0; i < HCD_BUFFER_POOLS; i++) {\r\nstruct dma_pool *pool = hcd->pool[i];\r\nif (pool) {\r\ndma_pool_destroy(pool);\r\nhcd->pool[i] = NULL;\r\n}\r\n}\r\n}\r\nvoid *hcd_buffer_alloc(\r\nstruct usb_bus *bus,\r\nsize_t size,\r\ngfp_t mem_flags,\r\ndma_addr_t *dma\r\n)\r\n{\r\nstruct usb_hcd *hcd = bus_to_hcd(bus);\r\nint i;\r\nif (size == 0)\r\nreturn NULL;\r\nif (!IS_ENABLED(CONFIG_HAS_DMA) ||\r\n(!bus->controller->dma_mask &&\r\n!(hcd->driver->flags & HCD_LOCAL_MEM))) {\r\n*dma = ~(dma_addr_t) 0;\r\nreturn kmalloc(size, mem_flags);\r\n}\r\nfor (i = 0; i < HCD_BUFFER_POOLS; i++) {\r\nif (size <= pool_max[i])\r\nreturn dma_pool_alloc(hcd->pool[i], mem_flags, dma);\r\n}\r\nreturn dma_alloc_coherent(hcd->self.controller, size, dma, mem_flags);\r\n}\r\nvoid hcd_buffer_free(\r\nstruct usb_bus *bus,\r\nsize_t size,\r\nvoid *addr,\r\ndma_addr_t dma\r\n)\r\n{\r\nstruct usb_hcd *hcd = bus_to_hcd(bus);\r\nint i;\r\nif (!addr)\r\nreturn;\r\nif (!IS_ENABLED(CONFIG_HAS_DMA) ||\r\n(!bus->controller->dma_mask &&\r\n!(hcd->driver->flags & HCD_LOCAL_MEM))) {\r\nkfree(addr);\r\nreturn;\r\n}\r\nfor (i = 0; i < HCD_BUFFER_POOLS; i++) {\r\nif (size <= pool_max[i]) {\r\ndma_pool_free(hcd->pool[i], addr, dma);\r\nreturn;\r\n}\r\n}\r\ndma_free_coherent(hcd->self.controller, size, addr, dma);\r\n}

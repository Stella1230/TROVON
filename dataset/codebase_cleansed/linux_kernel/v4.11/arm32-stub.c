efi_status_t check_platform_features(efi_system_table_t *sys_table_arg)\r\n{\r\nint block;\r\nif (!IS_ENABLED(CONFIG_ARM_LPAE))\r\nreturn EFI_SUCCESS;\r\nblock = cpuid_feature_extract(CPUID_EXT_MMFR0, 0);\r\nif (block < 5) {\r\npr_efi_err(sys_table_arg, "This LPAE kernel is not supported by your CPU\n");\r\nreturn EFI_UNSUPPORTED;\r\n}\r\nreturn EFI_SUCCESS;\r\n}\r\nstruct screen_info *alloc_screen_info(efi_system_table_t *sys_table_arg)\r\n{\r\nstruct screen_info *si;\r\nefi_status_t status;\r\nstatus = efi_call_early(allocate_pool, EFI_RUNTIME_SERVICES_DATA,\r\nsizeof(*si), (void **)&si);\r\nif (status != EFI_SUCCESS)\r\nreturn NULL;\r\nstatus = efi_call_early(install_configuration_table,\r\n&screen_info_guid, si);\r\nif (status == EFI_SUCCESS)\r\nreturn si;\r\nefi_call_early(free_pool, si);\r\nreturn NULL;\r\n}\r\nvoid free_screen_info(efi_system_table_t *sys_table_arg, struct screen_info *si)\r\n{\r\nif (!si)\r\nreturn;\r\nefi_call_early(install_configuration_table, &screen_info_guid, NULL);\r\nefi_call_early(free_pool, si);\r\n}\r\nefi_status_t handle_kernel_image(efi_system_table_t *sys_table,\r\nunsigned long *image_addr,\r\nunsigned long *image_size,\r\nunsigned long *reserve_addr,\r\nunsigned long *reserve_size,\r\nunsigned long dram_base,\r\nefi_loaded_image_t *image)\r\n{\r\nunsigned long nr_pages;\r\nefi_status_t status;\r\nefi_physical_addr_t alloc_addr;\r\ndram_base = round_up(dram_base, SZ_128M);\r\nalloc_addr = dram_base;\r\n*reserve_size = MAX_UNCOMP_KERNEL_SIZE;\r\nnr_pages = round_up(*reserve_size, EFI_PAGE_SIZE) / EFI_PAGE_SIZE;\r\nstatus = sys_table->boottime->allocate_pages(EFI_ALLOCATE_ADDRESS,\r\nEFI_LOADER_DATA,\r\nnr_pages, &alloc_addr);\r\nif (status != EFI_SUCCESS) {\r\n*reserve_size = 0;\r\npr_efi_err(sys_table, "Unable to allocate memory for uncompressed kernel.\n");\r\nreturn status;\r\n}\r\n*reserve_addr = alloc_addr;\r\n*image_size = image->image_size;\r\nstatus = efi_relocate_kernel(sys_table, image_addr, *image_size,\r\n*image_size,\r\ndram_base + MAX_UNCOMP_KERNEL_SIZE, 0);\r\nif (status != EFI_SUCCESS) {\r\npr_efi_err(sys_table, "Failed to relocate kernel.\n");\r\nefi_free(sys_table, *reserve_size, *reserve_addr);\r\n*reserve_size = 0;\r\nreturn status;\r\n}\r\nif (*image_addr + *image_size > dram_base + ZIMAGE_OFFSET_LIMIT) {\r\npr_efi_err(sys_table, "Failed to relocate kernel, no low memory available.\n");\r\nefi_free(sys_table, *reserve_size, *reserve_addr);\r\n*reserve_size = 0;\r\nefi_free(sys_table, *image_size, *image_addr);\r\n*image_size = 0;\r\nreturn EFI_LOAD_ERROR;\r\n}\r\nreturn EFI_SUCCESS;\r\n}

static inline struct gov_attr_set *to_gov_attr_set(struct kobject *kobj)\r\n{\r\nreturn container_of(kobj, struct gov_attr_set, kobj);\r\n}\r\nstatic inline struct governor_attr *to_gov_attr(struct attribute *attr)\r\n{\r\nreturn container_of(attr, struct governor_attr, attr);\r\n}\r\nstatic ssize_t governor_show(struct kobject *kobj, struct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct governor_attr *gattr = to_gov_attr(attr);\r\nreturn gattr->show(to_gov_attr_set(kobj), buf);\r\n}\r\nstatic ssize_t governor_store(struct kobject *kobj, struct attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct gov_attr_set *attr_set = to_gov_attr_set(kobj);\r\nstruct governor_attr *gattr = to_gov_attr(attr);\r\nint ret;\r\nmutex_lock(&attr_set->update_lock);\r\nret = attr_set->usage_count ? gattr->store(attr_set, buf, count) : -EBUSY;\r\nmutex_unlock(&attr_set->update_lock);\r\nreturn ret;\r\n}\r\nvoid gov_attr_set_init(struct gov_attr_set *attr_set, struct list_head *list_node)\r\n{\r\nINIT_LIST_HEAD(&attr_set->policy_list);\r\nmutex_init(&attr_set->update_lock);\r\nattr_set->usage_count = 1;\r\nlist_add(list_node, &attr_set->policy_list);\r\n}\r\nvoid gov_attr_set_get(struct gov_attr_set *attr_set, struct list_head *list_node)\r\n{\r\nmutex_lock(&attr_set->update_lock);\r\nattr_set->usage_count++;\r\nlist_add(list_node, &attr_set->policy_list);\r\nmutex_unlock(&attr_set->update_lock);\r\n}\r\nunsigned int gov_attr_set_put(struct gov_attr_set *attr_set, struct list_head *list_node)\r\n{\r\nunsigned int count;\r\nmutex_lock(&attr_set->update_lock);\r\nlist_del(list_node);\r\ncount = --attr_set->usage_count;\r\nmutex_unlock(&attr_set->update_lock);\r\nif (count)\r\nreturn count;\r\nkobject_put(&attr_set->kobj);\r\nmutex_destroy(&attr_set->update_lock);\r\nreturn 0;\r\n}

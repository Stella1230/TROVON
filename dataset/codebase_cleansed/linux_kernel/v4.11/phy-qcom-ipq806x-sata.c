static int qcom_ipq806x_sata_phy_init(struct phy *generic_phy)\r\n{\r\nstruct qcom_ipq806x_sata_phy *phy = phy_get_drvdata(generic_phy);\r\nu32 reg;\r\nreg = readl_relaxed(phy->mmio + SATA_PHY_P0_PARAM3);\r\nreg = reg | SATA_PHY_SSC_EN;\r\nwritel_relaxed(reg, phy->mmio + SATA_PHY_P0_PARAM3);\r\nreg = readl_relaxed(phy->mmio + SATA_PHY_P0_PARAM0) &\r\n~(SATA_PHY_P0_PARAM0_P0_TX_PREEMPH_GEN3_MASK |\r\nSATA_PHY_P0_PARAM0_P0_TX_PREEMPH_GEN2_MASK |\r\nSATA_PHY_P0_PARAM0_P0_TX_PREEMPH_GEN1_MASK);\r\nreg |= SATA_PHY_P0_PARAM0_P0_TX_PREEMPH_GEN3(0xf);\r\nwritel_relaxed(reg, phy->mmio + SATA_PHY_P0_PARAM0);\r\nreg = readl_relaxed(phy->mmio + SATA_PHY_P0_PARAM1) &\r\n~(SATA_PHY_P0_PARAM1_P0_TX_AMPLITUDE_GEN3_MASK |\r\nSATA_PHY_P0_PARAM1_P0_TX_AMPLITUDE_GEN2_MASK |\r\nSATA_PHY_P0_PARAM1_P0_TX_AMPLITUDE_GEN1_MASK);\r\nreg |= SATA_PHY_P0_PARAM1_P0_TX_AMPLITUDE_GEN3(0x55) |\r\nSATA_PHY_P0_PARAM1_P0_TX_AMPLITUDE_GEN2(0x55) |\r\nSATA_PHY_P0_PARAM1_P0_TX_AMPLITUDE_GEN1(0x55);\r\nwritel_relaxed(reg, phy->mmio + SATA_PHY_P0_PARAM1);\r\nreg = readl_relaxed(phy->mmio + SATA_PHY_P0_PARAM2) &\r\n~SATA_PHY_P0_PARAM2_RX_EQ_MASK;\r\nreg |= SATA_PHY_P0_PARAM2_RX_EQ(0x3);\r\nwritel_relaxed(reg, phy->mmio + SATA_PHY_P0_PARAM2);\r\nreg = readl_relaxed(phy->mmio + SATA_PHY_P0_PARAM4);\r\nreg = reg | SATA_PHY_RESET;\r\nwritel_relaxed(reg, phy->mmio + SATA_PHY_P0_PARAM4);\r\nreg = readl_relaxed(phy->mmio + SATA_PHY_P0_PARAM4);\r\nreg = reg | SATA_PHY_REF_SSP_EN | SATA_PHY_RESET;\r\nwritel_relaxed(reg, phy->mmio + SATA_PHY_P0_PARAM4);\r\nmb();\r\nusleep_range(20, 20 + 50);\r\nreg = readl_relaxed(phy->mmio + SATA_PHY_P0_PARAM4);\r\nreg = reg & ~SATA_PHY_RESET;\r\nwritel_relaxed(reg, phy->mmio + SATA_PHY_P0_PARAM4);\r\nreturn 0;\r\n}\r\nstatic int qcom_ipq806x_sata_phy_exit(struct phy *generic_phy)\r\n{\r\nstruct qcom_ipq806x_sata_phy *phy = phy_get_drvdata(generic_phy);\r\nu32 reg;\r\nreg = readl_relaxed(phy->mmio + SATA_PHY_P0_PARAM4);\r\nreg = reg | SATA_PHY_RESET;\r\nwritel_relaxed(reg, phy->mmio + SATA_PHY_P0_PARAM4);\r\nreturn 0;\r\n}\r\nstatic int qcom_ipq806x_sata_phy_probe(struct platform_device *pdev)\r\n{\r\nstruct qcom_ipq806x_sata_phy *phy;\r\nstruct device *dev = &pdev->dev;\r\nstruct resource *res;\r\nstruct phy_provider *phy_provider;\r\nstruct phy *generic_phy;\r\nint ret;\r\nphy = devm_kzalloc(dev, sizeof(*phy), GFP_KERNEL);\r\nif (!phy)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nphy->mmio = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(phy->mmio))\r\nreturn PTR_ERR(phy->mmio);\r\ngeneric_phy = devm_phy_create(dev, NULL, &qcom_ipq806x_sata_phy_ops);\r\nif (IS_ERR(generic_phy)) {\r\ndev_err(dev, "%s: failed to create phy\n", __func__);\r\nreturn PTR_ERR(generic_phy);\r\n}\r\nphy->dev = dev;\r\nphy_set_drvdata(generic_phy, phy);\r\nplatform_set_drvdata(pdev, phy);\r\nphy->cfg_clk = devm_clk_get(dev, "cfg");\r\nif (IS_ERR(phy->cfg_clk)) {\r\ndev_err(dev, "Failed to get sata cfg clock\n");\r\nreturn PTR_ERR(phy->cfg_clk);\r\n}\r\nret = clk_prepare_enable(phy->cfg_clk);\r\nif (ret)\r\nreturn ret;\r\nphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\r\nif (IS_ERR(phy_provider)) {\r\nclk_disable_unprepare(phy->cfg_clk);\r\ndev_err(dev, "%s: failed to register phy\n", __func__);\r\nreturn PTR_ERR(phy_provider);\r\n}\r\nreturn 0;\r\n}\r\nstatic int qcom_ipq806x_sata_phy_remove(struct platform_device *pdev)\r\n{\r\nstruct qcom_ipq806x_sata_phy *phy = platform_get_drvdata(pdev);\r\nclk_disable_unprepare(phy->cfg_clk);\r\nreturn 0;\r\n}

static void ath79_misc_irq_handler(struct irq_desc *desc)\r\n{\r\nstruct irq_domain *domain = irq_desc_get_handler_data(desc);\r\nstruct irq_chip *chip = irq_desc_get_chip(desc);\r\nvoid __iomem *base = domain->host_data;\r\nu32 pending;\r\nchained_irq_enter(chip, desc);\r\npending = __raw_readl(base + AR71XX_RESET_REG_MISC_INT_STATUS) &\r\n__raw_readl(base + AR71XX_RESET_REG_MISC_INT_ENABLE);\r\nif (!pending) {\r\nspurious_interrupt();\r\nchained_irq_exit(chip, desc);\r\nreturn;\r\n}\r\nwhile (pending) {\r\nint bit = __ffs(pending);\r\ngeneric_handle_irq(irq_linear_revmap(domain, bit));\r\npending &= ~BIT(bit);\r\n}\r\nchained_irq_exit(chip, desc);\r\n}\r\nstatic void ar71xx_misc_irq_unmask(struct irq_data *d)\r\n{\r\nvoid __iomem *base = irq_data_get_irq_chip_data(d);\r\nunsigned int irq = d->hwirq;\r\nu32 t;\r\nt = __raw_readl(base + AR71XX_RESET_REG_MISC_INT_ENABLE);\r\n__raw_writel(t | BIT(irq), base + AR71XX_RESET_REG_MISC_INT_ENABLE);\r\n__raw_readl(base + AR71XX_RESET_REG_MISC_INT_ENABLE);\r\n}\r\nstatic void ar71xx_misc_irq_mask(struct irq_data *d)\r\n{\r\nvoid __iomem *base = irq_data_get_irq_chip_data(d);\r\nunsigned int irq = d->hwirq;\r\nu32 t;\r\nt = __raw_readl(base + AR71XX_RESET_REG_MISC_INT_ENABLE);\r\n__raw_writel(t & ~BIT(irq), base + AR71XX_RESET_REG_MISC_INT_ENABLE);\r\n__raw_readl(base + AR71XX_RESET_REG_MISC_INT_ENABLE);\r\n}\r\nstatic void ar724x_misc_irq_ack(struct irq_data *d)\r\n{\r\nvoid __iomem *base = irq_data_get_irq_chip_data(d);\r\nunsigned int irq = d->hwirq;\r\nu32 t;\r\nt = __raw_readl(base + AR71XX_RESET_REG_MISC_INT_STATUS);\r\n__raw_writel(t & ~BIT(irq), base + AR71XX_RESET_REG_MISC_INT_STATUS);\r\n__raw_readl(base + AR71XX_RESET_REG_MISC_INT_STATUS);\r\n}\r\nstatic int misc_map(struct irq_domain *d, unsigned int irq, irq_hw_number_t hw)\r\n{\r\nirq_set_chip_and_handler(irq, &ath79_misc_irq_chip, handle_level_irq);\r\nirq_set_chip_data(irq, d->host_data);\r\nreturn 0;\r\n}\r\nstatic void __init ath79_misc_intc_domain_init(\r\nstruct irq_domain *domain, int irq)\r\n{\r\nvoid __iomem *base = domain->host_data;\r\n__raw_writel(0, base + AR71XX_RESET_REG_MISC_INT_ENABLE);\r\n__raw_writel(0, base + AR71XX_RESET_REG_MISC_INT_STATUS);\r\nirq_set_chained_handler_and_data(irq, ath79_misc_irq_handler, domain);\r\n}\r\nstatic int __init ath79_misc_intc_of_init(\r\nstruct device_node *node, struct device_node *parent)\r\n{\r\nstruct irq_domain *domain;\r\nvoid __iomem *base;\r\nint irq;\r\nirq = irq_of_parse_and_map(node, 0);\r\nif (!irq) {\r\npr_err("Failed to get MISC IRQ\n");\r\nreturn -EINVAL;\r\n}\r\nbase = of_iomap(node, 0);\r\nif (!base) {\r\npr_err("Failed to get MISC IRQ registers\n");\r\nreturn -ENOMEM;\r\n}\r\ndomain = irq_domain_add_linear(node, ATH79_MISC_IRQ_COUNT,\r\n&misc_irq_domain_ops, base);\r\nif (!domain) {\r\npr_err("Failed to add MISC irqdomain\n");\r\nreturn -EINVAL;\r\n}\r\nath79_misc_intc_domain_init(domain, irq);\r\nreturn 0;\r\n}\r\nstatic int __init ar7100_misc_intc_of_init(\r\nstruct device_node *node, struct device_node *parent)\r\n{\r\nath79_misc_irq_chip.irq_mask_ack = ar71xx_misc_irq_mask;\r\nreturn ath79_misc_intc_of_init(node, parent);\r\n}\r\nstatic int __init ar7240_misc_intc_of_init(\r\nstruct device_node *node, struct device_node *parent)\r\n{\r\nath79_misc_irq_chip.irq_ack = ar724x_misc_irq_ack;\r\nreturn ath79_misc_intc_of_init(node, parent);\r\n}\r\nvoid __init ath79_misc_irq_init(void __iomem *regs, int irq,\r\nint irq_base, bool is_ar71xx)\r\n{\r\nstruct irq_domain *domain;\r\nif (is_ar71xx)\r\nath79_misc_irq_chip.irq_mask_ack = ar71xx_misc_irq_mask;\r\nelse\r\nath79_misc_irq_chip.irq_ack = ar724x_misc_irq_ack;\r\ndomain = irq_domain_add_legacy(NULL, ATH79_MISC_IRQ_COUNT,\r\nirq_base, 0, &misc_irq_domain_ops, regs);\r\nif (!domain)\r\npanic("Failed to create MISC irqdomain");\r\nath79_misc_intc_domain_init(domain, irq);\r\n}

static void sclp_ftp_txcb(struct sclp_req *req, void *data)\r\n{\r\nstruct completion *completion = data;\r\n#ifdef DEBUG\r\npr_debug("SCLP (ET7) TX-IRQ, SCCB @ 0x%p: %*phN\n",\r\nreq->sccb, 24, req->sccb);\r\n#endif\r\ncomplete(completion);\r\n}\r\nstatic void sclp_ftp_rxcb(struct evbuf_header *evbuf)\r\n{\r\nstruct sclp_diag_evbuf *diag = (struct sclp_diag_evbuf *) evbuf;\r\nif (evbuf->type != EVTYP_DIAG_TEST ||\r\ndiag->route != SCLP_DIAG_FTP_ROUTE ||\r\ndiag->mdd.ftp.pcx != SCLP_DIAG_FTP_XPCX ||\r\nevbuf->length < SCLP_DIAG_FTP_EVBUF_LEN)\r\nreturn;\r\n#ifdef DEBUG\r\npr_debug("SCLP (ET7) RX-IRQ, Event @ 0x%p: %*phN\n",\r\nevbuf, 24, evbuf);\r\n#endif\r\nsclp_ftp_ldflg = diag->mdd.ftp.ldflg;\r\nsclp_ftp_fsize = diag->mdd.ftp.fsize;\r\nsclp_ftp_length = diag->mdd.ftp.length;\r\ncomplete(&sclp_ftp_rx_complete);\r\n}\r\nstatic int sclp_ftp_et7(const struct hmcdrv_ftp_cmdspec *ftp)\r\n{\r\nstruct completion completion;\r\nstruct sclp_diag_sccb *sccb;\r\nstruct sclp_req *req;\r\nsize_t len;\r\nint rc;\r\nreq = kzalloc(sizeof(*req), GFP_KERNEL);\r\nsccb = (void *) get_zeroed_page(GFP_KERNEL | GFP_DMA);\r\nif (!req || !sccb) {\r\nrc = -ENOMEM;\r\ngoto out_free;\r\n}\r\nsccb->hdr.length = SCLP_DIAG_FTP_EVBUF_LEN +\r\nsizeof(struct sccb_header);\r\nsccb->evbuf.hdr.type = EVTYP_DIAG_TEST;\r\nsccb->evbuf.hdr.length = SCLP_DIAG_FTP_EVBUF_LEN;\r\nsccb->evbuf.hdr.flags = 0;\r\nsccb->evbuf.route = SCLP_DIAG_FTP_ROUTE;\r\nsccb->evbuf.mdd.ftp.pcx = SCLP_DIAG_FTP_XPCX;\r\nsccb->evbuf.mdd.ftp.srcflg = 0;\r\nsccb->evbuf.mdd.ftp.pgsize = 0;\r\nsccb->evbuf.mdd.ftp.asce = _ASCE_REAL_SPACE;\r\nsccb->evbuf.mdd.ftp.ldflg = SCLP_DIAG_FTP_LDFAIL;\r\nsccb->evbuf.mdd.ftp.fsize = 0;\r\nsccb->evbuf.mdd.ftp.cmd = ftp->id;\r\nsccb->evbuf.mdd.ftp.offset = ftp->ofs;\r\nsccb->evbuf.mdd.ftp.length = ftp->len;\r\nsccb->evbuf.mdd.ftp.bufaddr = virt_to_phys(ftp->buf);\r\nlen = strlcpy(sccb->evbuf.mdd.ftp.fident, ftp->fname,\r\nHMCDRV_FTP_FIDENT_MAX);\r\nif (len >= HMCDRV_FTP_FIDENT_MAX) {\r\nrc = -EINVAL;\r\ngoto out_free;\r\n}\r\nreq->command = SCLP_CMDW_WRITE_EVENT_DATA;\r\nreq->sccb = sccb;\r\nreq->status = SCLP_REQ_FILLED;\r\nreq->callback = sclp_ftp_txcb;\r\nreq->callback_data = &completion;\r\ninit_completion(&completion);\r\nrc = sclp_add_request(req);\r\nif (rc)\r\ngoto out_free;\r\nwait_for_completion(&completion);\r\n#ifdef DEBUG\r\npr_debug("status of SCLP (ET7) request is 0x%04x (0x%02x)\n",\r\nsccb->hdr.response_code, sccb->evbuf.hdr.flags);\r\n#endif\r\nif (req->status != SCLP_REQ_DONE ||\r\n(sccb->evbuf.hdr.flags & 0x80) == 0 ||\r\n(sccb->hdr.response_code & 0xffU) != 0x20U) {\r\nrc = -EIO;\r\n}\r\nout_free:\r\nfree_page((unsigned long) sccb);\r\nkfree(req);\r\nreturn rc;\r\n}\r\nssize_t sclp_ftp_cmd(const struct hmcdrv_ftp_cmdspec *ftp, size_t *fsize)\r\n{\r\nssize_t len;\r\n#ifdef DEBUG\r\nunsigned long start_jiffies;\r\npr_debug("starting SCLP (ET7), cmd %d for '%s' at %lld with %zd bytes\n",\r\nftp->id, ftp->fname, (long long) ftp->ofs, ftp->len);\r\nstart_jiffies = jiffies;\r\n#endif\r\ninit_completion(&sclp_ftp_rx_complete);\r\nlen = sclp_ftp_et7(ftp);\r\nif (len)\r\ngoto out_unlock;\r\nwait_for_completion(&sclp_ftp_rx_complete);\r\n#ifdef DEBUG\r\npr_debug("completed SCLP (ET7) request after %lu ms (all)\n",\r\n(jiffies - start_jiffies) * 1000 / HZ);\r\npr_debug("return code of SCLP (ET7) FTP Service is 0x%02x, with %lld/%lld bytes\n",\r\nsclp_ftp_ldflg, sclp_ftp_length, sclp_ftp_fsize);\r\n#endif\r\nswitch (sclp_ftp_ldflg) {\r\ncase SCLP_DIAG_FTP_OK:\r\nlen = sclp_ftp_length;\r\nif (fsize)\r\n*fsize = sclp_ftp_fsize;\r\nbreak;\r\ncase SCLP_DIAG_FTP_LDNPERM:\r\nlen = -EPERM;\r\nbreak;\r\ncase SCLP_DIAG_FTP_LDRUNS:\r\nlen = -EBUSY;\r\nbreak;\r\ncase SCLP_DIAG_FTP_LDFAIL:\r\nlen = -ENOENT;\r\nbreak;\r\ndefault:\r\nlen = -EIO;\r\nbreak;\r\n}\r\nout_unlock:\r\nreturn len;\r\n}\r\nint sclp_ftp_startup(void)\r\n{\r\n#ifdef DEBUG\r\nunsigned long info;\r\n#endif\r\nint rc;\r\nrc = sclp_register(&sclp_ftp_event);\r\nif (rc)\r\nreturn rc;\r\n#ifdef DEBUG\r\ninfo = get_zeroed_page(GFP_KERNEL);\r\nif (info != 0) {\r\nstruct sysinfo_2_2_2 *info222 = (struct sysinfo_2_2_2 *)info;\r\nif (!stsi(info222, 2, 2, 2)) {\r\ninfo222->name[sizeof(info222->name) - 1] = '\0';\r\nEBCASC_500(info222->name, sizeof(info222->name) - 1);\r\npr_debug("SCLP (ET7) FTP Service working on LPAR %u (%s)\n",\r\ninfo222->lpar_number, info222->name);\r\n}\r\nfree_page(info);\r\n}\r\n#endif\r\nreturn 0;\r\n}\r\nvoid sclp_ftp_shutdown(void)\r\n{\r\nsclp_unregister(&sclp_ftp_event);\r\n}

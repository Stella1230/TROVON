static inline struct tfp410 *\r\ndrm_bridge_to_tfp410(struct drm_bridge *bridge)\r\n{\r\nreturn container_of(bridge, struct tfp410, bridge);\r\n}\r\nstatic inline struct tfp410 *\r\ndrm_connector_to_tfp410(struct drm_connector *connector)\r\n{\r\nreturn container_of(connector, struct tfp410, connector);\r\n}\r\nstatic int tfp410_get_modes(struct drm_connector *connector)\r\n{\r\nstruct tfp410 *dvi = drm_connector_to_tfp410(connector);\r\nstruct edid *edid;\r\nint ret;\r\nif (!dvi->ddc)\r\ngoto fallback;\r\nedid = drm_get_edid(connector, dvi->ddc);\r\nif (!edid) {\r\nDRM_INFO("EDID read failed. Fallback to standard modes\n");\r\ngoto fallback;\r\n}\r\ndrm_mode_connector_update_edid_property(connector, edid);\r\nreturn drm_add_edid_modes(connector, edid);\r\nfallback:\r\nret = drm_add_modes_noedid(connector, 1920, 1200);\r\ndrm_set_preferred_mode(connector, 1024, 768);\r\nreturn ret;\r\n}\r\nstatic enum drm_connector_status\r\ntfp410_connector_detect(struct drm_connector *connector, bool force)\r\n{\r\nstruct tfp410 *dvi = drm_connector_to_tfp410(connector);\r\nif (dvi->ddc) {\r\nif (drm_probe_ddc(dvi->ddc))\r\nreturn connector_status_connected;\r\nelse\r\nreturn connector_status_disconnected;\r\n}\r\nreturn connector_status_unknown;\r\n}\r\nstatic int tfp410_attach(struct drm_bridge *bridge)\r\n{\r\nstruct tfp410 *dvi = drm_bridge_to_tfp410(bridge);\r\nint ret;\r\nif (!bridge->encoder) {\r\ndev_err(dvi->dev, "Missing encoder\n");\r\nreturn -ENODEV;\r\n}\r\ndrm_connector_helper_add(&dvi->connector,\r\n&tfp410_con_helper_funcs);\r\nret = drm_connector_init(bridge->dev, &dvi->connector,\r\n&tfp410_con_funcs, DRM_MODE_CONNECTOR_HDMIA);\r\nif (ret) {\r\ndev_err(dvi->dev, "drm_connector_init() failed: %d\n", ret);\r\nreturn ret;\r\n}\r\ndrm_mode_connector_attach_encoder(&dvi->connector,\r\nbridge->encoder);\r\nreturn 0;\r\n}\r\nstatic int tfp410_get_connector_ddc(struct tfp410 *dvi)\r\n{\r\nstruct device_node *ep = NULL, *connector_node = NULL;\r\nstruct device_node *ddc_phandle = NULL;\r\nint ret = 0;\r\nep = of_graph_get_endpoint_by_regs(dvi->dev->of_node, 1, -1);\r\nif (!ep)\r\ngoto fail;\r\nconnector_node = of_graph_get_remote_port_parent(ep);\r\nif (!connector_node)\r\ngoto fail;\r\nddc_phandle = of_parse_phandle(connector_node, "ddc-i2c-bus", 0);\r\nif (!ddc_phandle)\r\ngoto fail;\r\ndvi->ddc = of_get_i2c_adapter_by_node(ddc_phandle);\r\nif (dvi->ddc)\r\ndev_info(dvi->dev, "Connector's ddc i2c bus found\n");\r\nelse\r\nret = -EPROBE_DEFER;\r\nfail:\r\nof_node_put(ep);\r\nof_node_put(connector_node);\r\nof_node_put(ddc_phandle);\r\nreturn ret;\r\n}\r\nstatic int tfp410_init(struct device *dev)\r\n{\r\nstruct tfp410 *dvi;\r\nint ret;\r\nif (!dev->of_node) {\r\ndev_err(dev, "device-tree data is missing\n");\r\nreturn -ENXIO;\r\n}\r\ndvi = devm_kzalloc(dev, sizeof(*dvi), GFP_KERNEL);\r\nif (!dvi)\r\nreturn -ENOMEM;\r\ndev_set_drvdata(dev, dvi);\r\ndvi->bridge.funcs = &tfp410_bridge_funcs;\r\ndvi->bridge.of_node = dev->of_node;\r\ndvi->dev = dev;\r\nret = tfp410_get_connector_ddc(dvi);\r\nif (ret)\r\ngoto fail;\r\nret = drm_bridge_add(&dvi->bridge);\r\nif (ret) {\r\ndev_err(dev, "drm_bridge_add() failed: %d\n", ret);\r\ngoto fail;\r\n}\r\nreturn 0;\r\nfail:\r\ni2c_put_adapter(dvi->ddc);\r\nreturn ret;\r\n}\r\nstatic int tfp410_fini(struct device *dev)\r\n{\r\nstruct tfp410 *dvi = dev_get_drvdata(dev);\r\ndrm_bridge_remove(&dvi->bridge);\r\nif (dvi->ddc)\r\ni2c_put_adapter(dvi->ddc);\r\nreturn 0;\r\n}\r\nstatic int tfp410_probe(struct platform_device *pdev)\r\n{\r\nreturn tfp410_init(&pdev->dev);\r\n}\r\nstatic int tfp410_remove(struct platform_device *pdev)\r\n{\r\nreturn tfp410_fini(&pdev->dev);\r\n}\r\nstatic int tfp410_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nint reg;\r\nif (!client->dev.of_node ||\r\nof_property_read_u32(client->dev.of_node, "reg", &reg)) {\r\ndev_err(&client->dev,\r\n"Can't get i2c reg property from device-tree\n");\r\nreturn -ENXIO;\r\n}\r\nreturn tfp410_init(&client->dev);\r\n}\r\nstatic int tfp410_i2c_remove(struct i2c_client *client)\r\n{\r\nreturn tfp410_fini(&client->dev);\r\n}\r\nstatic int __init tfp410_module_init(void)\r\n{\r\nint ret;\r\n#if IS_ENABLED(CONFIG_I2C)\r\nret = i2c_add_driver(&tfp410_i2c_driver);\r\nif (ret)\r\npr_err("%s: registering i2c driver failed: %d",\r\n__func__, ret);\r\nelse\r\ntfp410_registered_driver.i2c = 1;\r\n#endif\r\nret = platform_driver_register(&tfp410_platform_driver);\r\nif (ret)\r\npr_err("%s: registering platform driver failed: %d",\r\n__func__, ret);\r\nelse\r\ntfp410_registered_driver.platform = 1;\r\nif (tfp410_registered_driver.i2c ||\r\ntfp410_registered_driver.platform)\r\nreturn 0;\r\nreturn ret;\r\n}\r\nstatic void __exit tfp410_module_exit(void)\r\n{\r\n#if IS_ENABLED(CONFIG_I2C)\r\nif (tfp410_registered_driver.i2c)\r\ni2c_del_driver(&tfp410_i2c_driver);\r\n#endif\r\nif (tfp410_registered_driver.platform)\r\nplatform_driver_unregister(&tfp410_platform_driver);\r\n}

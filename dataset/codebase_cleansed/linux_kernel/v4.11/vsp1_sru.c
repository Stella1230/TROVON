static inline void vsp1_sru_write(struct vsp1_sru *sru, struct vsp1_dl_list *dl,\r\nu32 reg, u32 data)\r\n{\r\nvsp1_dl_list_write(dl, reg, data);\r\n}\r\nstatic int sru_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct vsp1_sru *sru =\r\ncontainer_of(ctrl->handler, struct vsp1_sru, ctrls);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_VSP1_SRU_INTENSITY:\r\nsru->intensity = ctrl->val;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sru_enum_mbus_code(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_mbus_code_enum *code)\r\n{\r\nstatic const unsigned int codes[] = {\r\nMEDIA_BUS_FMT_ARGB8888_1X32,\r\nMEDIA_BUS_FMT_AYUV8_1X32,\r\n};\r\nreturn vsp1_subdev_enum_mbus_code(subdev, cfg, code, codes,\r\nARRAY_SIZE(codes));\r\n}\r\nstatic int sru_enum_frame_size(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_frame_size_enum *fse)\r\n{\r\nstruct vsp1_sru *sru = to_sru(subdev);\r\nstruct v4l2_subdev_pad_config *config;\r\nstruct v4l2_mbus_framefmt *format;\r\nint ret = 0;\r\nconfig = vsp1_entity_get_pad_config(&sru->entity, cfg, fse->which);\r\nif (!config)\r\nreturn -EINVAL;\r\nformat = vsp1_entity_get_pad_format(&sru->entity, config, SRU_PAD_SINK);\r\nmutex_lock(&sru->entity.lock);\r\nif (fse->index || fse->code != format->code) {\r\nret = -EINVAL;\r\ngoto done;\r\n}\r\nif (fse->pad == SRU_PAD_SINK) {\r\nfse->min_width = SRU_MIN_SIZE;\r\nfse->max_width = SRU_MAX_SIZE;\r\nfse->min_height = SRU_MIN_SIZE;\r\nfse->max_height = SRU_MAX_SIZE;\r\n} else {\r\nfse->min_width = format->width;\r\nfse->min_height = format->height;\r\nif (format->width <= SRU_MAX_SIZE / 2 &&\r\nformat->height <= SRU_MAX_SIZE / 2) {\r\nfse->max_width = format->width * 2;\r\nfse->max_height = format->height * 2;\r\n} else {\r\nfse->max_width = format->width;\r\nfse->max_height = format->height;\r\n}\r\n}\r\ndone:\r\nmutex_unlock(&sru->entity.lock);\r\nreturn ret;\r\n}\r\nstatic void sru_try_format(struct vsp1_sru *sru,\r\nstruct v4l2_subdev_pad_config *config,\r\nunsigned int pad, struct v4l2_mbus_framefmt *fmt)\r\n{\r\nstruct v4l2_mbus_framefmt *format;\r\nunsigned int input_area;\r\nunsigned int output_area;\r\nswitch (pad) {\r\ncase SRU_PAD_SINK:\r\nif (fmt->code != MEDIA_BUS_FMT_ARGB8888_1X32 &&\r\nfmt->code != MEDIA_BUS_FMT_AYUV8_1X32)\r\nfmt->code = MEDIA_BUS_FMT_AYUV8_1X32;\r\nfmt->width = clamp(fmt->width, SRU_MIN_SIZE, SRU_MAX_SIZE);\r\nfmt->height = clamp(fmt->height, SRU_MIN_SIZE, SRU_MAX_SIZE);\r\nbreak;\r\ncase SRU_PAD_SOURCE:\r\nformat = vsp1_entity_get_pad_format(&sru->entity, config,\r\nSRU_PAD_SINK);\r\nfmt->code = format->code;\r\ninput_area = format->width * format->height;\r\noutput_area = min(fmt->width, SRU_MAX_SIZE)\r\n* min(fmt->height, SRU_MAX_SIZE);\r\nif (fmt->width <= SRU_MAX_SIZE / 2 &&\r\nfmt->height <= SRU_MAX_SIZE / 2 &&\r\noutput_area > input_area * 9 / 4) {\r\nfmt->width = format->width * 2;\r\nfmt->height = format->height * 2;\r\n} else {\r\nfmt->width = format->width;\r\nfmt->height = format->height;\r\n}\r\nbreak;\r\n}\r\nfmt->field = V4L2_FIELD_NONE;\r\nfmt->colorspace = V4L2_COLORSPACE_SRGB;\r\n}\r\nstatic int sru_set_format(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct vsp1_sru *sru = to_sru(subdev);\r\nstruct v4l2_subdev_pad_config *config;\r\nstruct v4l2_mbus_framefmt *format;\r\nint ret = 0;\r\nmutex_lock(&sru->entity.lock);\r\nconfig = vsp1_entity_get_pad_config(&sru->entity, cfg, fmt->which);\r\nif (!config) {\r\nret = -EINVAL;\r\ngoto done;\r\n}\r\nsru_try_format(sru, config, fmt->pad, &fmt->format);\r\nformat = vsp1_entity_get_pad_format(&sru->entity, config, fmt->pad);\r\n*format = fmt->format;\r\nif (fmt->pad == SRU_PAD_SINK) {\r\nformat = vsp1_entity_get_pad_format(&sru->entity, config,\r\nSRU_PAD_SOURCE);\r\n*format = fmt->format;\r\nsru_try_format(sru, config, SRU_PAD_SOURCE, format);\r\n}\r\ndone:\r\nmutex_unlock(&sru->entity.lock);\r\nreturn ret;\r\n}\r\nstatic void sru_configure(struct vsp1_entity *entity,\r\nstruct vsp1_pipeline *pipe,\r\nstruct vsp1_dl_list *dl,\r\nenum vsp1_entity_params params)\r\n{\r\nconst struct vsp1_sru_param *param;\r\nstruct vsp1_sru *sru = to_sru(&entity->subdev);\r\nstruct v4l2_mbus_framefmt *input;\r\nstruct v4l2_mbus_framefmt *output;\r\nu32 ctrl0;\r\nif (params != VSP1_ENTITY_PARAMS_INIT)\r\nreturn;\r\ninput = vsp1_entity_get_pad_format(&sru->entity, sru->entity.config,\r\nSRU_PAD_SINK);\r\noutput = vsp1_entity_get_pad_format(&sru->entity, sru->entity.config,\r\nSRU_PAD_SOURCE);\r\nif (input->code == MEDIA_BUS_FMT_ARGB8888_1X32)\r\nctrl0 = VI6_SRU_CTRL0_PARAM2 | VI6_SRU_CTRL0_PARAM3\r\n| VI6_SRU_CTRL0_PARAM4;\r\nelse\r\nctrl0 = VI6_SRU_CTRL0_PARAM3;\r\nif (input->width != output->width)\r\nctrl0 |= VI6_SRU_CTRL0_MODE_UPSCALE;\r\nparam = &vsp1_sru_params[sru->intensity - 1];\r\nctrl0 |= param->ctrl0;\r\nvsp1_sru_write(sru, dl, VI6_SRU_CTRL0, ctrl0);\r\nvsp1_sru_write(sru, dl, VI6_SRU_CTRL1, VI6_SRU_CTRL1_PARAM5);\r\nvsp1_sru_write(sru, dl, VI6_SRU_CTRL2, param->ctrl2);\r\n}\r\nstatic unsigned int sru_max_width(struct vsp1_entity *entity,\r\nstruct vsp1_pipeline *pipe)\r\n{\r\nstruct vsp1_sru *sru = to_sru(&entity->subdev);\r\nstruct v4l2_mbus_framefmt *input;\r\nstruct v4l2_mbus_framefmt *output;\r\ninput = vsp1_entity_get_pad_format(&sru->entity, sru->entity.config,\r\nSRU_PAD_SINK);\r\noutput = vsp1_entity_get_pad_format(&sru->entity, sru->entity.config,\r\nSRU_PAD_SOURCE);\r\nif (input->width != output->width)\r\nreturn 512;\r\nelse\r\nreturn 256;\r\n}\r\nstruct vsp1_sru *vsp1_sru_create(struct vsp1_device *vsp1)\r\n{\r\nstruct vsp1_sru *sru;\r\nint ret;\r\nsru = devm_kzalloc(vsp1->dev, sizeof(*sru), GFP_KERNEL);\r\nif (sru == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nsru->entity.ops = &sru_entity_ops;\r\nsru->entity.type = VSP1_ENTITY_SRU;\r\nret = vsp1_entity_init(vsp1, &sru->entity, "sru", 2, &sru_ops,\r\nMEDIA_ENT_F_PROC_VIDEO_SCALER);\r\nif (ret < 0)\r\nreturn ERR_PTR(ret);\r\nv4l2_ctrl_handler_init(&sru->ctrls, 1);\r\nv4l2_ctrl_new_custom(&sru->ctrls, &sru_intensity_control, NULL);\r\nsru->intensity = 1;\r\nsru->entity.subdev.ctrl_handler = &sru->ctrls;\r\nif (sru->ctrls.error) {\r\ndev_err(vsp1->dev, "sru: failed to initialize controls\n");\r\nret = sru->ctrls.error;\r\nvsp1_entity_destroy(&sru->entity);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn sru;\r\n}

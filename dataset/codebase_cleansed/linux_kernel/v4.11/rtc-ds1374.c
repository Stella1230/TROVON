static int ds1374_read_rtc(struct i2c_client *client, u32 *time,\r\nint reg, int nbytes)\r\n{\r\nu8 buf[4];\r\nint ret;\r\nint i;\r\nif (WARN_ON(nbytes > 4))\r\nreturn -EINVAL;\r\nret = i2c_smbus_read_i2c_block_data(client, reg, nbytes, buf);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret < nbytes)\r\nreturn -EIO;\r\nfor (i = nbytes - 1, *time = 0; i >= 0; i--)\r\n*time = (*time << 8) | buf[i];\r\nreturn 0;\r\n}\r\nstatic int ds1374_write_rtc(struct i2c_client *client, u32 time,\r\nint reg, int nbytes)\r\n{\r\nu8 buf[4];\r\nint i;\r\nif (nbytes > 4) {\r\nWARN_ON(1);\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < nbytes; i++) {\r\nbuf[i] = time & 0xff;\r\ntime >>= 8;\r\n}\r\nreturn i2c_smbus_write_i2c_block_data(client, reg, nbytes, buf);\r\n}\r\nstatic int ds1374_check_rtc_status(struct i2c_client *client)\r\n{\r\nint ret = 0;\r\nint control, stat;\r\nstat = i2c_smbus_read_byte_data(client, DS1374_REG_SR);\r\nif (stat < 0)\r\nreturn stat;\r\nif (stat & DS1374_REG_SR_OSF)\r\ndev_warn(&client->dev,\r\n"oscillator discontinuity flagged, time unreliable\n");\r\nstat &= ~(DS1374_REG_SR_OSF | DS1374_REG_SR_AF);\r\nret = i2c_smbus_write_byte_data(client, DS1374_REG_SR, stat);\r\nif (ret < 0)\r\nreturn ret;\r\ncontrol = i2c_smbus_read_byte_data(client, DS1374_REG_CR);\r\nif (control < 0)\r\nreturn control;\r\ncontrol &= ~(DS1374_REG_CR_WACE | DS1374_REG_CR_AIE);\r\nreturn i2c_smbus_write_byte_data(client, DS1374_REG_CR, control);\r\n}\r\nstatic int ds1374_read_time(struct device *dev, struct rtc_time *time)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nu32 itime;\r\nint ret;\r\nret = ds1374_read_rtc(client, &itime, DS1374_REG_TOD0, 4);\r\nif (!ret)\r\nrtc_time_to_tm(itime, time);\r\nreturn ret;\r\n}\r\nstatic int ds1374_set_time(struct device *dev, struct rtc_time *time)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nunsigned long itime;\r\nrtc_tm_to_time(time, &itime);\r\nreturn ds1374_write_rtc(client, itime, DS1374_REG_TOD0, 4);\r\n}\r\nstatic int ds1374_read_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ds1374 *ds1374 = i2c_get_clientdata(client);\r\nu32 now, cur_alarm;\r\nint cr, sr;\r\nint ret = 0;\r\nif (client->irq <= 0)\r\nreturn -EINVAL;\r\nmutex_lock(&ds1374->mutex);\r\ncr = ret = i2c_smbus_read_byte_data(client, DS1374_REG_CR);\r\nif (ret < 0)\r\ngoto out;\r\nsr = ret = i2c_smbus_read_byte_data(client, DS1374_REG_SR);\r\nif (ret < 0)\r\ngoto out;\r\nret = ds1374_read_rtc(client, &now, DS1374_REG_TOD0, 4);\r\nif (ret)\r\ngoto out;\r\nret = ds1374_read_rtc(client, &cur_alarm, DS1374_REG_WDALM0, 3);\r\nif (ret)\r\ngoto out;\r\nrtc_time_to_tm(now + cur_alarm, &alarm->time);\r\nalarm->enabled = !!(cr & DS1374_REG_CR_WACE);\r\nalarm->pending = !!(sr & DS1374_REG_SR_AF);\r\nout:\r\nmutex_unlock(&ds1374->mutex);\r\nreturn ret;\r\n}\r\nstatic int ds1374_set_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ds1374 *ds1374 = i2c_get_clientdata(client);\r\nstruct rtc_time now;\r\nunsigned long new_alarm, itime;\r\nint cr;\r\nint ret = 0;\r\nif (client->irq <= 0)\r\nreturn -EINVAL;\r\nret = ds1374_read_time(dev, &now);\r\nif (ret < 0)\r\nreturn ret;\r\nrtc_tm_to_time(&alarm->time, &new_alarm);\r\nrtc_tm_to_time(&now, &itime);\r\nif (time_before_eq(new_alarm, itime))\r\nnew_alarm = 1;\r\nelse\r\nnew_alarm -= itime;\r\nmutex_lock(&ds1374->mutex);\r\nret = cr = i2c_smbus_read_byte_data(client, DS1374_REG_CR);\r\nif (ret < 0)\r\ngoto out;\r\ncr &= ~DS1374_REG_CR_WACE;\r\nret = i2c_smbus_write_byte_data(client, DS1374_REG_CR, cr);\r\nif (ret < 0)\r\ngoto out;\r\nret = ds1374_write_rtc(client, new_alarm, DS1374_REG_WDALM0, 3);\r\nif (ret)\r\ngoto out;\r\nif (alarm->enabled) {\r\ncr |= DS1374_REG_CR_WACE | DS1374_REG_CR_AIE;\r\ncr &= ~DS1374_REG_CR_WDALM;\r\nret = i2c_smbus_write_byte_data(client, DS1374_REG_CR, cr);\r\n}\r\nout:\r\nmutex_unlock(&ds1374->mutex);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t ds1374_irq(int irq, void *dev_id)\r\n{\r\nstruct i2c_client *client = dev_id;\r\nstruct ds1374 *ds1374 = i2c_get_clientdata(client);\r\ndisable_irq_nosync(irq);\r\nschedule_work(&ds1374->work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void ds1374_work(struct work_struct *work)\r\n{\r\nstruct ds1374 *ds1374 = container_of(work, struct ds1374, work);\r\nstruct i2c_client *client = ds1374->client;\r\nint stat, control;\r\nmutex_lock(&ds1374->mutex);\r\nstat = i2c_smbus_read_byte_data(client, DS1374_REG_SR);\r\nif (stat < 0)\r\ngoto unlock;\r\nif (stat & DS1374_REG_SR_AF) {\r\nstat &= ~DS1374_REG_SR_AF;\r\ni2c_smbus_write_byte_data(client, DS1374_REG_SR, stat);\r\ncontrol = i2c_smbus_read_byte_data(client, DS1374_REG_CR);\r\nif (control < 0)\r\ngoto out;\r\ncontrol &= ~(DS1374_REG_CR_WACE | DS1374_REG_CR_AIE);\r\ni2c_smbus_write_byte_data(client, DS1374_REG_CR, control);\r\nrtc_update_irq(ds1374->rtc, 1, RTC_AF | RTC_IRQF);\r\n}\r\nout:\r\nif (!ds1374->exiting)\r\nenable_irq(client->irq);\r\nunlock:\r\nmutex_unlock(&ds1374->mutex);\r\n}\r\nstatic int ds1374_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ds1374 *ds1374 = i2c_get_clientdata(client);\r\nint ret;\r\nmutex_lock(&ds1374->mutex);\r\nret = i2c_smbus_read_byte_data(client, DS1374_REG_CR);\r\nif (ret < 0)\r\ngoto out;\r\nif (enabled) {\r\nret |= DS1374_REG_CR_WACE | DS1374_REG_CR_AIE;\r\nret &= ~DS1374_REG_CR_WDALM;\r\n} else {\r\nret &= ~DS1374_REG_CR_WACE;\r\n}\r\nret = i2c_smbus_write_byte_data(client, DS1374_REG_CR, ret);\r\nout:\r\nmutex_unlock(&ds1374->mutex);\r\nreturn ret;\r\n}\r\nstatic int ds1374_wdt_settimeout(unsigned int timeout)\r\n{\r\nint ret = -ENOIOCTLCMD;\r\nint cr;\r\nret = cr = i2c_smbus_read_byte_data(save_client, DS1374_REG_CR);\r\nif (ret < 0)\r\ngoto out;\r\ncr &= ~DS1374_REG_CR_WACE;\r\nret = i2c_smbus_write_byte_data(save_client, DS1374_REG_CR, cr);\r\nif (ret < 0)\r\ngoto out;\r\nret = ds1374_write_rtc(save_client, timeout, DS1374_REG_WDALM0, 3);\r\nif (ret) {\r\npr_info("couldn't set new watchdog time\n");\r\ngoto out;\r\n}\r\ncr |= DS1374_REG_CR_WACE | DS1374_REG_CR_WDALM;\r\ncr &= ~DS1374_REG_CR_AIE;\r\nret = i2c_smbus_write_byte_data(save_client, DS1374_REG_CR, cr);\r\nif (ret < 0)\r\ngoto out;\r\nreturn 0;\r\nout:\r\nreturn ret;\r\n}\r\nstatic void ds1374_wdt_ping(void)\r\n{\r\nu32 val;\r\nint ret = 0;\r\nret = ds1374_read_rtc(save_client, &val, DS1374_REG_WDALM0, 3);\r\nif (ret)\r\npr_info("WD TICK FAIL!!!!!!!!!! %i\n", ret);\r\n}\r\nstatic void ds1374_wdt_disable(void)\r\n{\r\nint ret = -ENOIOCTLCMD;\r\nint cr;\r\ncr = i2c_smbus_read_byte_data(save_client, DS1374_REG_CR);\r\ncr &= ~DS1374_REG_CR_WACE;\r\nret = i2c_smbus_write_byte_data(save_client, DS1374_REG_CR, cr);\r\n}\r\nstatic int ds1374_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nstruct ds1374 *ds1374 = i2c_get_clientdata(save_client);\r\nif (MINOR(inode->i_rdev) == WATCHDOG_MINOR) {\r\nmutex_lock(&ds1374->mutex);\r\nif (test_and_set_bit(0, &wdt_is_open)) {\r\nmutex_unlock(&ds1374->mutex);\r\nreturn -EBUSY;\r\n}\r\nwdt_is_open = 1;\r\nmutex_unlock(&ds1374->mutex);\r\nreturn nonseekable_open(inode, file);\r\n}\r\nreturn -ENODEV;\r\n}\r\nstatic int ds1374_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nif (MINOR(inode->i_rdev) == WATCHDOG_MINOR)\r\nclear_bit(0, &wdt_is_open);\r\nreturn 0;\r\n}\r\nstatic ssize_t ds1374_wdt_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nds1374_wdt_ping();\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t ds1374_wdt_read(struct file *file, char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nreturn 0;\r\n}\r\nstatic long ds1374_wdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint new_margin, options;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nreturn copy_to_user((struct watchdog_info __user *)arg,\r\n&ds1374_wdt_info, sizeof(ds1374_wdt_info)) ? -EFAULT : 0;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, (int __user *)arg);\r\ncase WDIOC_KEEPALIVE:\r\nds1374_wdt_ping();\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT:\r\nif (get_user(new_margin, (int __user *)arg))\r\nreturn -EFAULT;\r\nif (new_margin < 1 || new_margin > 16777216)\r\nreturn -EINVAL;\r\nwdt_margin = new_margin;\r\nds1374_wdt_settimeout(new_margin);\r\nds1374_wdt_ping();\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(wdt_margin, (int __user *)arg);\r\ncase WDIOC_SETOPTIONS:\r\nif (copy_from_user(&options, (int __user *)arg, sizeof(int)))\r\nreturn -EFAULT;\r\nif (options & WDIOS_DISABLECARD) {\r\npr_info("disable watchdog\n");\r\nds1374_wdt_disable();\r\n}\r\nif (options & WDIOS_ENABLECARD) {\r\npr_info("enable watchdog\n");\r\nds1374_wdt_settimeout(wdt_margin);\r\nds1374_wdt_ping();\r\n}\r\nreturn -EINVAL;\r\n}\r\nreturn -ENOTTY;\r\n}\r\nstatic long ds1374_wdt_unlocked_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint ret;\r\nstruct ds1374 *ds1374 = i2c_get_clientdata(save_client);\r\nmutex_lock(&ds1374->mutex);\r\nret = ds1374_wdt_ioctl(file, cmd, arg);\r\nmutex_unlock(&ds1374->mutex);\r\nreturn ret;\r\n}\r\nstatic int ds1374_wdt_notify_sys(struct notifier_block *this,\r\nunsigned long code, void *unused)\r\n{\r\nif (code == SYS_DOWN || code == SYS_HALT)\r\nds1374_wdt_disable();\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int ds1374_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct ds1374 *ds1374;\r\nint ret;\r\nds1374 = devm_kzalloc(&client->dev, sizeof(struct ds1374), GFP_KERNEL);\r\nif (!ds1374)\r\nreturn -ENOMEM;\r\nds1374->client = client;\r\ni2c_set_clientdata(client, ds1374);\r\nINIT_WORK(&ds1374->work, ds1374_work);\r\nmutex_init(&ds1374->mutex);\r\nret = ds1374_check_rtc_status(client);\r\nif (ret)\r\nreturn ret;\r\nif (client->irq > 0) {\r\nret = devm_request_irq(&client->dev, client->irq, ds1374_irq, 0,\r\n"ds1374", client);\r\nif (ret) {\r\ndev_err(&client->dev, "unable to request IRQ\n");\r\nreturn ret;\r\n}\r\ndevice_set_wakeup_capable(&client->dev, 1);\r\n}\r\nds1374->rtc = devm_rtc_device_register(&client->dev, client->name,\r\n&ds1374_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(ds1374->rtc)) {\r\ndev_err(&client->dev, "unable to register the class device\n");\r\nreturn PTR_ERR(ds1374->rtc);\r\n}\r\n#ifdef CONFIG_RTC_DRV_DS1374_WDT\r\nsave_client = client;\r\nret = misc_register(&ds1374_miscdev);\r\nif (ret)\r\nreturn ret;\r\nret = register_reboot_notifier(&ds1374_wdt_notifier);\r\nif (ret) {\r\nmisc_deregister(&ds1374_miscdev);\r\nreturn ret;\r\n}\r\nds1374_wdt_settimeout(131072);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int ds1374_remove(struct i2c_client *client)\r\n{\r\nstruct ds1374 *ds1374 = i2c_get_clientdata(client);\r\n#ifdef CONFIG_RTC_DRV_DS1374_WDT\r\nmisc_deregister(&ds1374_miscdev);\r\nds1374_miscdev.parent = NULL;\r\nunregister_reboot_notifier(&ds1374_wdt_notifier);\r\n#endif\r\nif (client->irq > 0) {\r\nmutex_lock(&ds1374->mutex);\r\nds1374->exiting = 1;\r\nmutex_unlock(&ds1374->mutex);\r\ndevm_free_irq(&client->dev, client->irq, client);\r\ncancel_work_sync(&ds1374->work);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ds1374_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nif (client->irq > 0 && device_may_wakeup(&client->dev))\r\nenable_irq_wake(client->irq);\r\nreturn 0;\r\n}\r\nstatic int ds1374_resume(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nif (client->irq > 0 && device_may_wakeup(&client->dev))\r\ndisable_irq_wake(client->irq);\r\nreturn 0;\r\n}

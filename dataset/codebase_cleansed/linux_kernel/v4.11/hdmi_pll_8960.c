static inline void pll_write(struct hdmi_pll_8960 *pll, u32 reg, u32 data)\r\n{\r\nmsm_writel(data, pll->mmio + reg);\r\n}\r\nstatic inline u32 pll_read(struct hdmi_pll_8960 *pll, u32 reg)\r\n{\r\nreturn msm_readl(pll->mmio + reg);\r\n}\r\nstatic inline struct hdmi_phy *pll_get_phy(struct hdmi_pll_8960 *pll)\r\n{\r\nreturn platform_get_drvdata(pll->pdev);\r\n}\r\nstatic int hdmi_pll_enable(struct clk_hw *hw)\r\n{\r\nstruct hdmi_pll_8960 *pll = hw_clk_to_pll(hw);\r\nstruct hdmi_phy *phy = pll_get_phy(pll);\r\nint timeout_count, pll_lock_retry = 10;\r\nunsigned int val;\r\nDBG("");\r\npll_write(pll, REG_HDMI_8960_PHY_PLL_LOCKDET_CFG2, 0x8d);\r\npll_write(pll, REG_HDMI_8960_PHY_PLL_LOCKDET_CFG0, 0x10);\r\npll_write(pll, REG_HDMI_8960_PHY_PLL_LOCKDET_CFG1, 0x1a);\r\nudelay(10);\r\npll_write(pll, REG_HDMI_8960_PHY_PLL_LOCKDET_CFG2, 0x0d);\r\nval = hdmi_phy_read(phy, REG_HDMI_8960_PHY_REG12);\r\nval |= HDMI_8960_PHY_REG12_SW_RESET;\r\nhdmi_phy_write(phy, REG_HDMI_8960_PHY_REG12, val);\r\nval &= ~HDMI_8960_PHY_REG12_SW_RESET;\r\nudelay(10);\r\nhdmi_phy_write(phy, REG_HDMI_8960_PHY_REG12, val);\r\nhdmi_phy_write(phy, REG_HDMI_8960_PHY_REG2, 0x3f);\r\nval = hdmi_phy_read(phy, REG_HDMI_8960_PHY_REG12);\r\nval |= HDMI_8960_PHY_REG12_PWRDN_B;\r\nhdmi_phy_write(phy, REG_HDMI_8960_PHY_REG12, val);\r\nmb();\r\nudelay(10);\r\nval = pll_read(pll, REG_HDMI_8960_PHY_PLL_PWRDN_B);\r\nval |= HDMI_8960_PHY_PLL_PWRDN_B_PLL_PWRDN_B;\r\nval &= ~HDMI_8960_PHY_PLL_PWRDN_B_PD_PLL;\r\npll_write(pll, REG_HDMI_8960_PHY_PLL_PWRDN_B, val);\r\nhdmi_phy_write(phy, REG_HDMI_8960_PHY_REG2, 0x80);\r\ntimeout_count = 1000;\r\nwhile (--pll_lock_retry > 0) {\r\nval = pll_read(pll, REG_HDMI_8960_PHY_PLL_STATUS0);\r\nif (val & HDMI_8960_PHY_PLL_STATUS0_PLL_LOCK)\r\nbreak;\r\nudelay(1);\r\nif (--timeout_count > 0)\r\ncontinue;\r\npll_write(pll, REG_HDMI_8960_PHY_PLL_LOCKDET_CFG2, 0x8d);\r\nudelay(10);\r\npll_write(pll, REG_HDMI_8960_PHY_PLL_LOCKDET_CFG2, 0x0d);\r\nudelay(350);\r\ntimeout_count = 1000;\r\n}\r\nreturn 0;\r\n}\r\nstatic void hdmi_pll_disable(struct clk_hw *hw)\r\n{\r\nstruct hdmi_pll_8960 *pll = hw_clk_to_pll(hw);\r\nstruct hdmi_phy *phy = pll_get_phy(pll);\r\nunsigned int val;\r\nDBG("");\r\nval = hdmi_phy_read(phy, REG_HDMI_8960_PHY_REG12);\r\nval &= ~HDMI_8960_PHY_REG12_PWRDN_B;\r\nhdmi_phy_write(phy, REG_HDMI_8960_PHY_REG12, val);\r\nval = pll_read(pll, REG_HDMI_8960_PHY_PLL_PWRDN_B);\r\nval |= HDMI_8960_PHY_REG12_SW_RESET;\r\nval &= ~HDMI_8960_PHY_REG12_PWRDN_B;\r\npll_write(pll, REG_HDMI_8960_PHY_PLL_PWRDN_B, val);\r\nmb();\r\n}\r\nstatic const struct pll_rate *find_rate(unsigned long rate)\r\n{\r\nint i;\r\nfor (i = 1; i < ARRAY_SIZE(freqtbl); i++)\r\nif (rate > freqtbl[i].rate)\r\nreturn &freqtbl[i - 1];\r\nreturn &freqtbl[i - 1];\r\n}\r\nstatic unsigned long hdmi_pll_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct hdmi_pll_8960 *pll = hw_clk_to_pll(hw);\r\nreturn pll->pixclk;\r\n}\r\nstatic long hdmi_pll_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nconst struct pll_rate *pll_rate = find_rate(rate);\r\nreturn pll_rate->rate;\r\n}\r\nstatic int hdmi_pll_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct hdmi_pll_8960 *pll = hw_clk_to_pll(hw);\r\nconst struct pll_rate *pll_rate = find_rate(rate);\r\nint i;\r\nDBG("rate=%lu", rate);\r\nfor (i = 0; i < pll_rate->num_reg; i++)\r\npll_write(pll, pll_rate->conf[i].reg, pll_rate->conf[i].val);\r\npll->pixclk = rate;\r\nreturn 0;\r\n}\r\nint msm_hdmi_pll_8960_init(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct hdmi_pll_8960 *pll;\r\nstruct clk *clk;\r\nint i;\r\nfor (i = 0; i < (ARRAY_SIZE(freqtbl) - 1); i++)\r\nif (WARN_ON(freqtbl[i].rate < freqtbl[i + 1].rate))\r\nreturn -EINVAL;\r\npll = devm_kzalloc(dev, sizeof(*pll), GFP_KERNEL);\r\nif (!pll)\r\nreturn -ENOMEM;\r\npll->mmio = msm_ioremap(pdev, "hdmi_pll", "HDMI_PLL");\r\nif (IS_ERR(pll->mmio)) {\r\ndev_err(dev, "failed to map pll base\n");\r\nreturn -ENOMEM;\r\n}\r\npll->pdev = pdev;\r\npll->clk_hw.init = &pll_init;\r\nclk = devm_clk_register(dev, &pll->clk_hw);\r\nif (IS_ERR(clk)) {\r\ndev_err(dev, "failed to register pll clock\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}

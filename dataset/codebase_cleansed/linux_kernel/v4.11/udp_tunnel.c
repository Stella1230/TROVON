int udp_sock_create4(struct net *net, struct udp_port_cfg *cfg,\r\nstruct socket **sockp)\r\n{\r\nint err;\r\nstruct socket *sock = NULL;\r\nstruct sockaddr_in udp_addr;\r\nerr = sock_create_kern(net, AF_INET, SOCK_DGRAM, 0, &sock);\r\nif (err < 0)\r\ngoto error;\r\nudp_addr.sin_family = AF_INET;\r\nudp_addr.sin_addr = cfg->local_ip;\r\nudp_addr.sin_port = cfg->local_udp_port;\r\nerr = kernel_bind(sock, (struct sockaddr *)&udp_addr,\r\nsizeof(udp_addr));\r\nif (err < 0)\r\ngoto error;\r\nif (cfg->peer_udp_port) {\r\nudp_addr.sin_family = AF_INET;\r\nudp_addr.sin_addr = cfg->peer_ip;\r\nudp_addr.sin_port = cfg->peer_udp_port;\r\nerr = kernel_connect(sock, (struct sockaddr *)&udp_addr,\r\nsizeof(udp_addr), 0);\r\nif (err < 0)\r\ngoto error;\r\n}\r\nsock->sk->sk_no_check_tx = !cfg->use_udp_checksums;\r\n*sockp = sock;\r\nreturn 0;\r\nerror:\r\nif (sock) {\r\nkernel_sock_shutdown(sock, SHUT_RDWR);\r\nsock_release(sock);\r\n}\r\n*sockp = NULL;\r\nreturn err;\r\n}\r\nvoid setup_udp_tunnel_sock(struct net *net, struct socket *sock,\r\nstruct udp_tunnel_sock_cfg *cfg)\r\n{\r\nstruct sock *sk = sock->sk;\r\ninet_sk(sk)->mc_loop = 0;\r\ninet_inc_convert_csum(sk);\r\nrcu_assign_sk_user_data(sk, cfg->sk_user_data);\r\nudp_sk(sk)->encap_type = cfg->encap_type;\r\nudp_sk(sk)->encap_rcv = cfg->encap_rcv;\r\nudp_sk(sk)->encap_destroy = cfg->encap_destroy;\r\nudp_sk(sk)->gro_receive = cfg->gro_receive;\r\nudp_sk(sk)->gro_complete = cfg->gro_complete;\r\nudp_tunnel_encap_enable(sock);\r\n}\r\nvoid udp_tunnel_push_rx_port(struct net_device *dev, struct socket *sock,\r\nunsigned short type)\r\n{\r\nstruct sock *sk = sock->sk;\r\nstruct udp_tunnel_info ti;\r\nif (!dev->netdev_ops->ndo_udp_tunnel_add)\r\nreturn;\r\nti.type = type;\r\nti.sa_family = sk->sk_family;\r\nti.port = inet_sk(sk)->inet_sport;\r\ndev->netdev_ops->ndo_udp_tunnel_add(dev, &ti);\r\n}\r\nvoid udp_tunnel_notify_add_rx_port(struct socket *sock, unsigned short type)\r\n{\r\nstruct sock *sk = sock->sk;\r\nstruct net *net = sock_net(sk);\r\nstruct udp_tunnel_info ti;\r\nstruct net_device *dev;\r\nti.type = type;\r\nti.sa_family = sk->sk_family;\r\nti.port = inet_sk(sk)->inet_sport;\r\nrcu_read_lock();\r\nfor_each_netdev_rcu(net, dev) {\r\nif (!dev->netdev_ops->ndo_udp_tunnel_add)\r\ncontinue;\r\ndev->netdev_ops->ndo_udp_tunnel_add(dev, &ti);\r\n}\r\nrcu_read_unlock();\r\n}\r\nvoid udp_tunnel_notify_del_rx_port(struct socket *sock, unsigned short type)\r\n{\r\nstruct sock *sk = sock->sk;\r\nstruct net *net = sock_net(sk);\r\nstruct udp_tunnel_info ti;\r\nstruct net_device *dev;\r\nti.type = type;\r\nti.sa_family = sk->sk_family;\r\nti.port = inet_sk(sk)->inet_sport;\r\nrcu_read_lock();\r\nfor_each_netdev_rcu(net, dev) {\r\nif (!dev->netdev_ops->ndo_udp_tunnel_del)\r\ncontinue;\r\ndev->netdev_ops->ndo_udp_tunnel_del(dev, &ti);\r\n}\r\nrcu_read_unlock();\r\n}\r\nvoid udp_tunnel_xmit_skb(struct rtable *rt, struct sock *sk, struct sk_buff *skb,\r\n__be32 src, __be32 dst, __u8 tos, __u8 ttl,\r\n__be16 df, __be16 src_port, __be16 dst_port,\r\nbool xnet, bool nocheck)\r\n{\r\nstruct udphdr *uh;\r\n__skb_push(skb, sizeof(*uh));\r\nskb_reset_transport_header(skb);\r\nuh = udp_hdr(skb);\r\nuh->dest = dst_port;\r\nuh->source = src_port;\r\nuh->len = htons(skb->len);\r\nmemset(&(IPCB(skb)->opt), 0, sizeof(IPCB(skb)->opt));\r\nudp_set_csum(nocheck, skb, src, dst, skb->len);\r\niptunnel_xmit(sk, rt, skb, src, dst, IPPROTO_UDP, tos, ttl, df, xnet);\r\n}\r\nvoid udp_tunnel_sock_release(struct socket *sock)\r\n{\r\nrcu_assign_sk_user_data(sock->sk, NULL);\r\nkernel_sock_shutdown(sock, SHUT_RDWR);\r\nsock_release(sock);\r\n}\r\nstruct metadata_dst *udp_tun_rx_dst(struct sk_buff *skb, unsigned short family,\r\n__be16 flags, __be64 tunnel_id, int md_size)\r\n{\r\nstruct metadata_dst *tun_dst;\r\nstruct ip_tunnel_info *info;\r\nif (family == AF_INET)\r\ntun_dst = ip_tun_rx_dst(skb, flags, tunnel_id, md_size);\r\nelse\r\ntun_dst = ipv6_tun_rx_dst(skb, flags, tunnel_id, md_size);\r\nif (!tun_dst)\r\nreturn NULL;\r\ninfo = &tun_dst->u.tun_info;\r\ninfo->key.tp_src = udp_hdr(skb)->source;\r\ninfo->key.tp_dst = udp_hdr(skb)->dest;\r\nif (udp_hdr(skb)->check)\r\ninfo->key.tun_flags |= TUNNEL_CSUM;\r\nreturn tun_dst;\r\n}

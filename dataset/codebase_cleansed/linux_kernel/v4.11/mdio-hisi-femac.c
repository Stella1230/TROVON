static int hisi_femac_mdio_wait_ready(struct hisi_femac_mdio_data *data)\r\n{\r\nu32 val;\r\nreturn readl_poll_timeout(data->membase + MDIO_RWCTRL,\r\nval, val & MDIO_RW_FINISH, 20, 10000);\r\n}\r\nstatic int hisi_femac_mdio_read(struct mii_bus *bus, int mii_id, int regnum)\r\n{\r\nstruct hisi_femac_mdio_data *data = bus->priv;\r\nint ret;\r\nret = hisi_femac_mdio_wait_ready(data);\r\nif (ret)\r\nreturn ret;\r\nwritel((mii_id << BIT_PHY_ADDR_OFFSET) | regnum,\r\ndata->membase + MDIO_RWCTRL);\r\nret = hisi_femac_mdio_wait_ready(data);\r\nif (ret)\r\nreturn ret;\r\nreturn readl(data->membase + MDIO_RO_DATA) & 0xFFFF;\r\n}\r\nstatic int hisi_femac_mdio_write(struct mii_bus *bus, int mii_id, int regnum,\r\nu16 value)\r\n{\r\nstruct hisi_femac_mdio_data *data = bus->priv;\r\nint ret;\r\nret = hisi_femac_mdio_wait_ready(data);\r\nif (ret)\r\nreturn ret;\r\nwritel(MDIO_WRITE | (value << BIT_WR_DATA_OFFSET) |\r\n(mii_id << BIT_PHY_ADDR_OFFSET) | regnum,\r\ndata->membase + MDIO_RWCTRL);\r\nreturn hisi_femac_mdio_wait_ready(data);\r\n}\r\nstatic int hisi_femac_mdio_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct mii_bus *bus;\r\nstruct hisi_femac_mdio_data *data;\r\nstruct resource *res;\r\nint ret;\r\nbus = mdiobus_alloc_size(sizeof(*data));\r\nif (!bus)\r\nreturn -ENOMEM;\r\nbus->name = "hisi_femac_mii_bus";\r\nbus->read = &hisi_femac_mdio_read;\r\nbus->write = &hisi_femac_mdio_write;\r\nsnprintf(bus->id, MII_BUS_ID_SIZE, "%s", pdev->name);\r\nbus->parent = &pdev->dev;\r\ndata = bus->priv;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndata->membase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(data->membase)) {\r\nret = PTR_ERR(data->membase);\r\ngoto err_out_free_mdiobus;\r\n}\r\ndata->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(data->clk)) {\r\nret = PTR_ERR(data->clk);\r\ngoto err_out_free_mdiobus;\r\n}\r\nret = clk_prepare_enable(data->clk);\r\nif (ret)\r\ngoto err_out_free_mdiobus;\r\nret = of_mdiobus_register(bus, np);\r\nif (ret)\r\ngoto err_out_disable_clk;\r\nplatform_set_drvdata(pdev, bus);\r\nreturn 0;\r\nerr_out_disable_clk:\r\nclk_disable_unprepare(data->clk);\r\nerr_out_free_mdiobus:\r\nmdiobus_free(bus);\r\nreturn ret;\r\n}\r\nstatic int hisi_femac_mdio_remove(struct platform_device *pdev)\r\n{\r\nstruct mii_bus *bus = platform_get_drvdata(pdev);\r\nstruct hisi_femac_mdio_data *data = bus->priv;\r\nmdiobus_unregister(bus);\r\nclk_disable_unprepare(data->clk);\r\nmdiobus_free(bus);\r\nreturn 0;\r\n}

static int __init cmp_fake_mem(const void *x1, const void *x2)\r\n{\r\nconst struct efi_mem_range *m1 = x1;\r\nconst struct efi_mem_range *m2 = x2;\r\nif (m1->range.start < m2->range.start)\r\nreturn -1;\r\nif (m1->range.start > m2->range.start)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nvoid __init efi_fake_memmap(void)\r\n{\r\nint new_nr_map = efi.memmap.nr_map;\r\nefi_memory_desc_t *md;\r\nphys_addr_t new_memmap_phy;\r\nvoid *new_memmap;\r\nint i;\r\nif (!nr_fake_mem)\r\nreturn;\r\nfor (i = 0; i < nr_fake_mem; i++) {\r\nfor_each_efi_memory_desc(md) {\r\nstruct range *r = &fake_mems[i].range;\r\nnew_nr_map += efi_memmap_split_count(md, r);\r\n}\r\n}\r\nnew_memmap_phy = efi_memmap_alloc(new_nr_map);\r\nif (!new_memmap_phy)\r\nreturn;\r\nnew_memmap = early_memremap(new_memmap_phy,\r\nefi.memmap.desc_size * new_nr_map);\r\nif (!new_memmap) {\r\nmemblock_free(new_memmap_phy, efi.memmap.desc_size * new_nr_map);\r\nreturn;\r\n}\r\nfor (i = 0; i < nr_fake_mem; i++)\r\nefi_memmap_insert(&efi.memmap, new_memmap, &fake_mems[i]);\r\nearly_memunmap(new_memmap, efi.memmap.desc_size * new_nr_map);\r\nefi_memmap_install(new_memmap_phy, new_nr_map);\r\nefi_print_memmap();\r\n}\r\nstatic int __init setup_fake_mem(char *p)\r\n{\r\nu64 start = 0, mem_size = 0, attribute = 0;\r\nint i;\r\nif (!p)\r\nreturn -EINVAL;\r\nwhile (*p != '\0') {\r\nmem_size = memparse(p, &p);\r\nif (*p == '@')\r\nstart = memparse(p+1, &p);\r\nelse\r\nbreak;\r\nif (*p == ':')\r\nattribute = simple_strtoull(p+1, &p, 0);\r\nelse\r\nbreak;\r\nif (nr_fake_mem >= EFI_MAX_FAKEMEM)\r\nbreak;\r\nfake_mems[nr_fake_mem].range.start = start;\r\nfake_mems[nr_fake_mem].range.end = start + mem_size - 1;\r\nfake_mems[nr_fake_mem].attribute = attribute;\r\nnr_fake_mem++;\r\nif (*p == ',')\r\np++;\r\n}\r\nsort(fake_mems, nr_fake_mem, sizeof(struct efi_mem_range),\r\ncmp_fake_mem, NULL);\r\nfor (i = 0; i < nr_fake_mem; i++)\r\npr_info("efi_fake_mem: add attr=0x%016llx to [mem 0x%016llx-0x%016llx]",\r\nfake_mems[i].attribute, fake_mems[i].range.start,\r\nfake_mems[i].range.end);\r\nreturn *p == '\0' ? 0 : -EINVAL;\r\n}

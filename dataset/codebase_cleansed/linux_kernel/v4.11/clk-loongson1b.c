static unsigned long ls1x_pll_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nu32 pll, rate;\r\npll = __raw_readl(LS1X_CLK_PLL_FREQ);\r\nrate = 12 + (pll & GENMASK(5, 0));\r\nrate *= OSC;\r\nrate >>= 1;\r\nreturn rate;\r\n}\r\nvoid __init ls1x_clk_init(void)\r\n{\r\nstruct clk_hw *hw;\r\nhw = clk_hw_register_fixed_rate(NULL, "osc_clk", NULL, 0, OSC);\r\nclk_hw_register_clkdev(hw, "osc_clk", NULL);\r\nhw = clk_hw_register_pll(NULL, "pll_clk", "osc_clk",\r\n&ls1x_pll_clk_ops, 0);\r\nclk_hw_register_clkdev(hw, "pll_clk", NULL);\r\nhw = clk_hw_register_divider(NULL, "cpu_clk_div", "pll_clk",\r\nCLK_GET_RATE_NOCACHE, LS1X_CLK_PLL_DIV,\r\nDIV_CPU_SHIFT, DIV_CPU_WIDTH,\r\nCLK_DIVIDER_ONE_BASED |\r\nCLK_DIVIDER_ROUND_CLOSEST, &_lock);\r\nclk_hw_register_clkdev(hw, "cpu_clk_div", NULL);\r\nhw = clk_hw_register_mux(NULL, "cpu_clk", cpu_parents,\r\nARRAY_SIZE(cpu_parents),\r\nCLK_SET_RATE_NO_REPARENT, LS1X_CLK_PLL_DIV,\r\nBYPASS_CPU_SHIFT, BYPASS_CPU_WIDTH, 0, &_lock);\r\nclk_hw_register_clkdev(hw, "cpu_clk", NULL);\r\nhw = clk_hw_register_divider(NULL, "dc_clk_div", "pll_clk",\r\n0, LS1X_CLK_PLL_DIV, DIV_DC_SHIFT,\r\nDIV_DC_WIDTH, CLK_DIVIDER_ONE_BASED, &_lock);\r\nclk_hw_register_clkdev(hw, "dc_clk_div", NULL);\r\nhw = clk_hw_register_mux(NULL, "dc_clk", dc_parents,\r\nARRAY_SIZE(dc_parents),\r\nCLK_SET_RATE_NO_REPARENT, LS1X_CLK_PLL_DIV,\r\nBYPASS_DC_SHIFT, BYPASS_DC_WIDTH, 0, &_lock);\r\nclk_hw_register_clkdev(hw, "dc_clk", NULL);\r\nhw = clk_hw_register_divider(NULL, "ahb_clk_div", "pll_clk",\r\n0, LS1X_CLK_PLL_DIV, DIV_DDR_SHIFT,\r\nDIV_DDR_WIDTH, CLK_DIVIDER_ONE_BASED,\r\n&_lock);\r\nclk_hw_register_clkdev(hw, "ahb_clk_div", NULL);\r\nhw = clk_hw_register_mux(NULL, "ahb_clk", ahb_parents,\r\nARRAY_SIZE(ahb_parents),\r\nCLK_SET_RATE_NO_REPARENT, LS1X_CLK_PLL_DIV,\r\nBYPASS_DDR_SHIFT, BYPASS_DDR_WIDTH, 0, &_lock);\r\nclk_hw_register_clkdev(hw, "ahb_clk", NULL);\r\nclk_hw_register_clkdev(hw, "ls1x-dma", NULL);\r\nclk_hw_register_clkdev(hw, "stmmaceth", NULL);\r\nhw = clk_hw_register_fixed_factor(NULL, "apb_clk", "ahb_clk", 0, 1,\r\nDIV_APB);\r\nclk_hw_register_clkdev(hw, "apb_clk", NULL);\r\nclk_hw_register_clkdev(hw, "ls1x-ac97", NULL);\r\nclk_hw_register_clkdev(hw, "ls1x-i2c", NULL);\r\nclk_hw_register_clkdev(hw, "ls1x-nand", NULL);\r\nclk_hw_register_clkdev(hw, "ls1x-pwmtimer", NULL);\r\nclk_hw_register_clkdev(hw, "ls1x-spi", NULL);\r\nclk_hw_register_clkdev(hw, "ls1x-wdt", NULL);\r\nclk_hw_register_clkdev(hw, "serial8250", NULL);\r\n}

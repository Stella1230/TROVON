static int ms5611_i2c_reset(struct device *dev)\r\n{\r\nstruct ms5611_state *st = iio_priv(dev_to_iio_dev(dev));\r\nreturn i2c_smbus_write_byte(st->client, MS5611_RESET);\r\n}\r\nstatic int ms5611_i2c_read_prom_word(struct device *dev, int index, u16 *word)\r\n{\r\nint ret;\r\nstruct ms5611_state *st = iio_priv(dev_to_iio_dev(dev));\r\nret = i2c_smbus_read_word_swapped(st->client,\r\nMS5611_READ_PROM_WORD + (index << 1));\r\nif (ret < 0)\r\nreturn ret;\r\n*word = ret;\r\nreturn 0;\r\n}\r\nstatic int ms5611_i2c_read_adc(struct ms5611_state *st, s32 *val)\r\n{\r\nint ret;\r\nu8 buf[3];\r\nret = i2c_smbus_read_i2c_block_data(st->client, MS5611_READ_ADC,\r\n3, buf);\r\nif (ret < 0)\r\nreturn ret;\r\n*val = (buf[0] << 16) | (buf[1] << 8) | buf[2];\r\nreturn 0;\r\n}\r\nstatic int ms5611_i2c_read_adc_temp_and_pressure(struct device *dev,\r\ns32 *temp, s32 *pressure)\r\n{\r\nint ret;\r\nstruct ms5611_state *st = iio_priv(dev_to_iio_dev(dev));\r\nconst struct ms5611_osr *osr = st->temp_osr;\r\nret = i2c_smbus_write_byte(st->client, osr->cmd);\r\nif (ret < 0)\r\nreturn ret;\r\nusleep_range(osr->conv_usec, osr->conv_usec + (osr->conv_usec / 10UL));\r\nret = ms5611_i2c_read_adc(st, temp);\r\nif (ret < 0)\r\nreturn ret;\r\nosr = st->pressure_osr;\r\nret = i2c_smbus_write_byte(st->client, osr->cmd);\r\nif (ret < 0)\r\nreturn ret;\r\nusleep_range(osr->conv_usec, osr->conv_usec + (osr->conv_usec / 10UL));\r\nreturn ms5611_i2c_read_adc(st, pressure);\r\n}\r\nstatic int ms5611_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct ms5611_state *st;\r\nstruct iio_dev *indio_dev;\r\nif (!i2c_check_functionality(client->adapter,\r\nI2C_FUNC_SMBUS_WRITE_BYTE |\r\nI2C_FUNC_SMBUS_READ_WORD_DATA |\r\nI2C_FUNC_SMBUS_READ_I2C_BLOCK))\r\nreturn -EOPNOTSUPP;\r\nindio_dev = devm_iio_device_alloc(&client->dev, sizeof(*st));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\nst = iio_priv(indio_dev);\r\ni2c_set_clientdata(client, indio_dev);\r\nst->reset = ms5611_i2c_reset;\r\nst->read_prom_word = ms5611_i2c_read_prom_word;\r\nst->read_adc_temp_and_pressure = ms5611_i2c_read_adc_temp_and_pressure;\r\nst->client = client;\r\nreturn ms5611_probe(indio_dev, &client->dev, id->name, id->driver_data);\r\n}\r\nstatic int ms5611_i2c_remove(struct i2c_client *client)\r\n{\r\nreturn ms5611_remove(i2c_get_clientdata(client));\r\n}

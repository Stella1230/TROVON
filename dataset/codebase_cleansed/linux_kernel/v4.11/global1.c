int mv88e6xxx_g1_read(struct mv88e6xxx_chip *chip, int reg, u16 *val)\r\n{\r\nint addr = chip->info->global1_addr;\r\nreturn mv88e6xxx_read(chip, addr, reg, val);\r\n}\r\nint mv88e6xxx_g1_write(struct mv88e6xxx_chip *chip, int reg, u16 val)\r\n{\r\nint addr = chip->info->global1_addr;\r\nreturn mv88e6xxx_write(chip, addr, reg, val);\r\n}\r\nint mv88e6xxx_g1_wait(struct mv88e6xxx_chip *chip, int reg, u16 mask)\r\n{\r\nreturn mv88e6xxx_wait(chip, chip->info->global1_addr, reg, mask);\r\n}\r\nstatic int mv88e6185_g1_wait_ppu_disabled(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 state;\r\nint i, err;\r\nfor (i = 0; i < 16; i++) {\r\nerr = mv88e6xxx_g1_read(chip, GLOBAL_STATUS, &state);\r\nif (err)\r\nreturn err;\r\nstate &= GLOBAL_STATUS_PPU_STATE_MASK;\r\nif (state != GLOBAL_STATUS_PPU_STATE_POLLING)\r\nreturn 0;\r\nusleep_range(1000, 2000);\r\n}\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int mv88e6185_g1_wait_ppu_polling(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 state;\r\nint i, err;\r\nfor (i = 0; i < 16; ++i) {\r\nerr = mv88e6xxx_g1_read(chip, GLOBAL_STATUS, &state);\r\nif (err)\r\nreturn err;\r\nstate &= GLOBAL_STATUS_PPU_STATE_MASK;\r\nif (state == GLOBAL_STATUS_PPU_STATE_POLLING)\r\nreturn 0;\r\nusleep_range(1000, 2000);\r\n}\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int mv88e6352_g1_wait_ppu_polling(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 state;\r\nint i, err;\r\nfor (i = 0; i < 16; ++i) {\r\nerr = mv88e6xxx_g1_read(chip, GLOBAL_STATUS, &state);\r\nif (err)\r\nreturn err;\r\nif (state & GLOBAL_STATUS_PPU_STATE)\r\nreturn 0;\r\nusleep_range(1000, 2000);\r\n}\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int mv88e6xxx_g1_wait_init_ready(struct mv88e6xxx_chip *chip)\r\n{\r\nconst unsigned long timeout = jiffies + 1 * HZ;\r\nu16 val;\r\nint err;\r\nwhile (time_before(jiffies, timeout)) {\r\nerr = mv88e6xxx_g1_read(chip, GLOBAL_STATUS, &val);\r\nif (err)\r\nreturn err;\r\nif (val & GLOBAL_STATUS_INIT_READY)\r\nbreak;\r\nusleep_range(1000, 2000);\r\n}\r\nif (time_after(jiffies, timeout))\r\nreturn -ETIMEDOUT;\r\nreturn 0;\r\n}\r\nint mv88e6185_g1_reset(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, GLOBAL_CONTROL, &val);\r\nif (err)\r\nreturn err;\r\nval |= GLOBAL_CONTROL_SW_RESET;\r\nval |= GLOBAL_CONTROL_PPU_ENABLE;\r\nerr = mv88e6xxx_g1_write(chip, GLOBAL_CONTROL, val);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_wait_init_ready(chip);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6185_g1_wait_ppu_polling(chip);\r\n}\r\nint mv88e6352_g1_reset(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, GLOBAL_CONTROL, &val);\r\nif (err)\r\nreturn err;\r\nval |= GLOBAL_CONTROL_SW_RESET;\r\nerr = mv88e6xxx_g1_write(chip, GLOBAL_CONTROL, val);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6xxx_g1_wait_init_ready(chip);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6352_g1_wait_ppu_polling(chip);\r\n}\r\nint mv88e6185_g1_ppu_enable(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, GLOBAL_CONTROL, &val);\r\nif (err)\r\nreturn err;\r\nval |= GLOBAL_CONTROL_PPU_ENABLE;\r\nerr = mv88e6xxx_g1_write(chip, GLOBAL_CONTROL, val);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6185_g1_wait_ppu_polling(chip);\r\n}\r\nint mv88e6185_g1_ppu_disable(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, GLOBAL_CONTROL, &val);\r\nif (err)\r\nreturn err;\r\nval &= ~GLOBAL_CONTROL_PPU_ENABLE;\r\nerr = mv88e6xxx_g1_write(chip, GLOBAL_CONTROL, val);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6185_g1_wait_ppu_disabled(chip);\r\n}\r\nint mv88e6095_g1_set_egress_port(struct mv88e6xxx_chip *chip, int port)\r\n{\r\nu16 reg;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, GLOBAL_MONITOR_CONTROL, &reg);\r\nif (err)\r\nreturn err;\r\nreg &= ~(GLOBAL_MONITOR_CONTROL_INGRESS_MASK |\r\nGLOBAL_MONITOR_CONTROL_EGRESS_MASK);\r\nreg |= port << GLOBAL_MONITOR_CONTROL_INGRESS_SHIFT |\r\nport << GLOBAL_MONITOR_CONTROL_EGRESS_SHIFT;\r\nreturn mv88e6xxx_g1_write(chip, GLOBAL_MONITOR_CONTROL, reg);\r\n}\r\nint mv88e6095_g1_set_cpu_port(struct mv88e6xxx_chip *chip, int port)\r\n{\r\nu16 reg;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, GLOBAL_MONITOR_CONTROL, &reg);\r\nif (err)\r\nreturn err;\r\nreg &= ~GLOBAL_MONITOR_CONTROL_ARP_MASK;\r\nreg |= port << GLOBAL_MONITOR_CONTROL_ARP_SHIFT;\r\nreturn mv88e6xxx_g1_write(chip, GLOBAL_MONITOR_CONTROL, reg);\r\n}\r\nstatic int mv88e6390_g1_monitor_write(struct mv88e6xxx_chip *chip,\r\nu16 pointer, u8 data)\r\n{\r\nu16 reg;\r\nreg = GLOBAL_MONITOR_CONTROL_UPDATE | pointer | data;\r\nreturn mv88e6xxx_g1_write(chip, GLOBAL_MONITOR_CONTROL, reg);\r\n}\r\nint mv88e6390_g1_set_egress_port(struct mv88e6xxx_chip *chip, int port)\r\n{\r\nint err;\r\nerr = mv88e6390_g1_monitor_write(chip, GLOBAL_MONITOR_CONTROL_INGRESS,\r\nport);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6390_g1_monitor_write(chip, GLOBAL_MONITOR_CONTROL_EGRESS,\r\nport);\r\n}\r\nint mv88e6390_g1_set_cpu_port(struct mv88e6xxx_chip *chip, int port)\r\n{\r\nreturn mv88e6390_g1_monitor_write(chip, GLOBAL_MONITOR_CONTROL_CPU_DEST,\r\nport);\r\n}\r\nint mv88e6390_g1_mgmt_rsvd2cpu(struct mv88e6xxx_chip *chip)\r\n{\r\nint err;\r\nerr = mv88e6390_g1_monitor_write(\r\nchip, GLOBAL_MONITOR_CONTROL_0180C280000000XLO, 0xff);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6390_g1_monitor_write(\r\nchip, GLOBAL_MONITOR_CONTROL_0180C280000000XHI, 0xff);\r\nif (err)\r\nreturn err;\r\nerr = mv88e6390_g1_monitor_write(\r\nchip, GLOBAL_MONITOR_CONTROL_0180C280000002XLO, 0xff);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6390_g1_monitor_write(\r\nchip, GLOBAL_MONITOR_CONTROL_0180C280000002XHI, 0xff);\r\n}\r\nint mv88e6390_g1_stats_set_histogram(struct mv88e6xxx_chip *chip)\r\n{\r\nu16 val;\r\nint err;\r\nerr = mv88e6xxx_g1_read(chip, GLOBAL_CONTROL_2, &val);\r\nif (err)\r\nreturn err;\r\nval |= GLOBAL_CONTROL_2_HIST_RX_TX;\r\nerr = mv88e6xxx_g1_write(chip, GLOBAL_CONTROL_2, val);\r\nreturn err;\r\n}\r\nint mv88e6xxx_g1_stats_wait(struct mv88e6xxx_chip *chip)\r\n{\r\nreturn mv88e6xxx_g1_wait(chip, GLOBAL_STATS_OP, GLOBAL_STATS_OP_BUSY);\r\n}\r\nint mv88e6xxx_g1_stats_snapshot(struct mv88e6xxx_chip *chip, int port)\r\n{\r\nint err;\r\nerr = mv88e6xxx_g1_write(chip, GLOBAL_STATS_OP,\r\nGLOBAL_STATS_OP_CAPTURE_PORT |\r\nGLOBAL_STATS_OP_HIST_RX_TX | port);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6xxx_g1_stats_wait(chip);\r\n}\r\nint mv88e6320_g1_stats_snapshot(struct mv88e6xxx_chip *chip, int port)\r\n{\r\nport = (port + 1) << 5;\r\nreturn mv88e6xxx_g1_stats_snapshot(chip, port);\r\n}\r\nint mv88e6390_g1_stats_snapshot(struct mv88e6xxx_chip *chip, int port)\r\n{\r\nint err;\r\nport = (port + 1) << 5;\r\nerr = mv88e6xxx_g1_write(chip, GLOBAL_STATS_OP,\r\nGLOBAL_STATS_OP_CAPTURE_PORT | port);\r\nif (err)\r\nreturn err;\r\nreturn mv88e6xxx_g1_stats_wait(chip);\r\n}\r\nvoid mv88e6xxx_g1_stats_read(struct mv88e6xxx_chip *chip, int stat, u32 *val)\r\n{\r\nu32 value;\r\nu16 reg;\r\nint err;\r\n*val = 0;\r\nerr = mv88e6xxx_g1_write(chip, GLOBAL_STATS_OP,\r\nGLOBAL_STATS_OP_READ_CAPTURED | stat);\r\nif (err)\r\nreturn;\r\nerr = mv88e6xxx_g1_stats_wait(chip);\r\nif (err)\r\nreturn;\r\nerr = mv88e6xxx_g1_read(chip, GLOBAL_STATS_COUNTER_32, &reg);\r\nif (err)\r\nreturn;\r\nvalue = reg << 16;\r\nerr = mv88e6xxx_g1_read(chip, GLOBAL_STATS_COUNTER_01, &reg);\r\nif (err)\r\nreturn;\r\n*val = value | reg;\r\n}

static const char *lzma_strerror(lzma_ret ret)\r\n{\r\nswitch ((int) ret) {\r\ncase LZMA_MEM_ERROR:\r\nreturn "Memory allocation failed";\r\ncase LZMA_OPTIONS_ERROR:\r\nreturn "Unsupported decompressor flags";\r\ncase LZMA_FORMAT_ERROR:\r\nreturn "The input is not in the .xz format";\r\ncase LZMA_DATA_ERROR:\r\nreturn "Compressed file is corrupt";\r\ncase LZMA_BUF_ERROR:\r\nreturn "Compressed file is truncated or otherwise corrupt";\r\ndefault:\r\nreturn "Unknown error, possibly a bug";\r\n}\r\n}\r\nint lzma_decompress_to_file(const char *input, int output_fd)\r\n{\r\nlzma_action action = LZMA_RUN;\r\nlzma_stream strm = LZMA_STREAM_INIT;\r\nlzma_ret ret;\r\nint err = -1;\r\nu8 buf_in[BUFSIZE];\r\nu8 buf_out[BUFSIZE];\r\nFILE *infile;\r\ninfile = fopen(input, "rb");\r\nif (!infile) {\r\npr_err("lzma: fopen failed on %s: '%s'\n",\r\ninput, strerror(errno));\r\nreturn -1;\r\n}\r\nret = lzma_stream_decoder(&strm, UINT64_MAX, LZMA_CONCATENATED);\r\nif (ret != LZMA_OK) {\r\npr_err("lzma: lzma_stream_decoder failed %s (%d)\n",\r\nlzma_strerror(ret), ret);\r\ngoto err_fclose;\r\n}\r\nstrm.next_in = NULL;\r\nstrm.avail_in = 0;\r\nstrm.next_out = buf_out;\r\nstrm.avail_out = sizeof(buf_out);\r\nwhile (1) {\r\nif (strm.avail_in == 0 && !feof(infile)) {\r\nstrm.next_in = buf_in;\r\nstrm.avail_in = fread(buf_in, 1, sizeof(buf_in), infile);\r\nif (ferror(infile)) {\r\npr_err("lzma: read error: %s\n", strerror(errno));\r\ngoto err_fclose;\r\n}\r\nif (feof(infile))\r\naction = LZMA_FINISH;\r\n}\r\nret = lzma_code(&strm, action);\r\nif (strm.avail_out == 0 || ret == LZMA_STREAM_END) {\r\nssize_t write_size = sizeof(buf_out) - strm.avail_out;\r\nif (writen(output_fd, buf_out, write_size) != write_size) {\r\npr_err("lzma: write error: %s\n", strerror(errno));\r\ngoto err_fclose;\r\n}\r\nstrm.next_out = buf_out;\r\nstrm.avail_out = sizeof(buf_out);\r\n}\r\nif (ret != LZMA_OK) {\r\nif (ret == LZMA_STREAM_END)\r\nbreak;\r\npr_err("lzma: failed %s\n", lzma_strerror(ret));\r\ngoto err_fclose;\r\n}\r\n}\r\nerr = 0;\r\nerr_fclose:\r\nfclose(infile);\r\nreturn err;\r\n}

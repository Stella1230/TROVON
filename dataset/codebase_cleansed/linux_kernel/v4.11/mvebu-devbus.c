static int get_timing_param_ps(struct devbus *devbus,\r\nstruct device_node *node,\r\nconst char *name,\r\nu32 *ticks)\r\n{\r\nu32 time_ps;\r\nint err;\r\nerr = of_property_read_u32(node, name, &time_ps);\r\nif (err < 0) {\r\ndev_err(devbus->dev, "%s has no '%s' property\n",\r\nname, node->full_name);\r\nreturn err;\r\n}\r\n*ticks = (time_ps + devbus->tick_ps - 1) / devbus->tick_ps;\r\ndev_dbg(devbus->dev, "%s: %u ps -> 0x%x\n",\r\nname, time_ps, *ticks);\r\nreturn 0;\r\n}\r\nstatic int devbus_get_timing_params(struct devbus *devbus,\r\nstruct device_node *node,\r\nstruct devbus_read_params *r,\r\nstruct devbus_write_params *w)\r\n{\r\nint err;\r\nerr = of_property_read_u32(node, "devbus,bus-width", &r->bus_width);\r\nif (err < 0) {\r\ndev_err(devbus->dev,\r\n"%s has no 'devbus,bus-width' property\n",\r\nnode->full_name);\r\nreturn err;\r\n}\r\nif (r->bus_width == 8)\r\nr->bus_width = 0;\r\nelse if (r->bus_width == 16)\r\nr->bus_width = 1;\r\nelse {\r\ndev_err(devbus->dev, "invalid bus width %d\n", r->bus_width);\r\nreturn -EINVAL;\r\n}\r\nerr = get_timing_param_ps(devbus, node, "devbus,badr-skew-ps",\r\n&r->badr_skew);\r\nif (err < 0)\r\nreturn err;\r\nerr = get_timing_param_ps(devbus, node, "devbus,turn-off-ps",\r\n&r->turn_off);\r\nif (err < 0)\r\nreturn err;\r\nerr = get_timing_param_ps(devbus, node, "devbus,acc-first-ps",\r\n&r->acc_first);\r\nif (err < 0)\r\nreturn err;\r\nerr = get_timing_param_ps(devbus, node, "devbus,acc-next-ps",\r\n&r->acc_next);\r\nif (err < 0)\r\nreturn err;\r\nif (of_device_is_compatible(devbus->dev->of_node, "marvell,mvebu-devbus")) {\r\nerr = get_timing_param_ps(devbus, node, "devbus,rd-setup-ps",\r\n&r->rd_setup);\r\nif (err < 0)\r\nreturn err;\r\nerr = get_timing_param_ps(devbus, node, "devbus,rd-hold-ps",\r\n&r->rd_hold);\r\nif (err < 0)\r\nreturn err;\r\nerr = of_property_read_u32(node, "devbus,sync-enable",\r\n&w->sync_enable);\r\nif (err < 0) {\r\ndev_err(devbus->dev,\r\n"%s has no 'devbus,sync-enable' property\n",\r\nnode->full_name);\r\nreturn err;\r\n}\r\n}\r\nerr = get_timing_param_ps(devbus, node, "devbus,ale-wr-ps",\r\n&w->ale_wr);\r\nif (err < 0)\r\nreturn err;\r\nerr = get_timing_param_ps(devbus, node, "devbus,wr-low-ps",\r\n&w->wr_low);\r\nif (err < 0)\r\nreturn err;\r\nerr = get_timing_param_ps(devbus, node, "devbus,wr-high-ps",\r\n&w->wr_high);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic void devbus_orion_set_timing_params(struct devbus *devbus,\r\nstruct device_node *node,\r\nstruct devbus_read_params *r,\r\nstruct devbus_write_params *w)\r\n{\r\nu32 value;\r\nvalue = (r->turn_off & ORION_TURN_OFF_MASK) << ORION_TURN_OFF_SHIFT |\r\n(r->acc_first & ORION_ACC_FIRST_MASK) << ORION_ACC_FIRST_SHIFT |\r\n(r->acc_next & ORION_ACC_NEXT_MASK) << ORION_ACC_NEXT_SHIFT |\r\n(w->ale_wr & ORION_ALE_WR_MASK) << ORION_ALE_WR_SHIFT |\r\n(w->wr_low & ORION_WR_LOW_MASK) << ORION_WR_LOW_SHIFT |\r\n(w->wr_high & ORION_WR_HIGH_MASK) << ORION_WR_HIGH_SHIFT |\r\nr->bus_width << ORION_DEV_WIDTH_SHIFT |\r\n((r->turn_off & ORION_TURN_OFF_EXT_MASK) ? ORION_TURN_OFF_EXT_BIT : 0) |\r\n((r->acc_first & ORION_ACC_FIRST_EXT_MASK) ? ORION_ACC_FIRST_EXT_BIT : 0) |\r\n((r->acc_next & ORION_ACC_NEXT_EXT_MASK) ? ORION_ACC_NEXT_EXT_BIT : 0) |\r\n((w->ale_wr & ORION_ALE_WR_EXT_MASK) ? ORION_ALE_WR_EXT_BIT : 0) |\r\n((w->wr_low & ORION_WR_LOW_EXT_MASK) ? ORION_WR_LOW_EXT_BIT : 0) |\r\n((w->wr_high & ORION_WR_HIGH_EXT_MASK) ? ORION_WR_HIGH_EXT_BIT : 0) |\r\n(r->badr_skew << ORION_BADR_SKEW_SHIFT) |\r\nORION_RESERVED;\r\nwritel(value, devbus->base);\r\n}\r\nstatic void devbus_armada_set_timing_params(struct devbus *devbus,\r\nstruct device_node *node,\r\nstruct devbus_read_params *r,\r\nstruct devbus_write_params *w)\r\n{\r\nu32 value;\r\nvalue = r->bus_width << ARMADA_DEV_WIDTH_SHIFT |\r\nr->badr_skew << ARMADA_BADR_SKEW_SHIFT |\r\nr->rd_hold << ARMADA_RD_HOLD_SHIFT |\r\nr->acc_next << ARMADA_ACC_NEXT_SHIFT |\r\nr->rd_setup << ARMADA_RD_SETUP_SHIFT |\r\nr->acc_first << ARMADA_ACC_FIRST_SHIFT |\r\nr->turn_off;\r\ndev_dbg(devbus->dev, "read parameters register 0x%p = 0x%x\n",\r\ndevbus->base + ARMADA_READ_PARAM_OFFSET,\r\nvalue);\r\nwritel(value, devbus->base + ARMADA_READ_PARAM_OFFSET);\r\nvalue = w->sync_enable << ARMADA_SYNC_ENABLE_SHIFT |\r\nw->wr_low << ARMADA_WR_LOW_SHIFT |\r\nw->wr_high << ARMADA_WR_HIGH_SHIFT |\r\nw->ale_wr;\r\ndev_dbg(devbus->dev, "write parameters register: 0x%p = 0x%x\n",\r\ndevbus->base + ARMADA_WRITE_PARAM_OFFSET,\r\nvalue);\r\nwritel(value, devbus->base + ARMADA_WRITE_PARAM_OFFSET);\r\n}\r\nstatic int mvebu_devbus_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct devbus_read_params r;\r\nstruct devbus_write_params w;\r\nstruct devbus *devbus;\r\nstruct resource *res;\r\nstruct clk *clk;\r\nunsigned long rate;\r\nint err;\r\ndevbus = devm_kzalloc(&pdev->dev, sizeof(struct devbus), GFP_KERNEL);\r\nif (!devbus)\r\nreturn -ENOMEM;\r\ndevbus->dev = dev;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndevbus->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(devbus->base))\r\nreturn PTR_ERR(devbus->base);\r\nclk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nclk_prepare_enable(clk);\r\nrate = clk_get_rate(clk) / 1000;\r\ndevbus->tick_ps = 1000000000 / rate;\r\ndev_dbg(devbus->dev, "Setting timing parameter, tick is %lu ps\n",\r\ndevbus->tick_ps);\r\nif (!of_property_read_bool(node, "devbus,keep-config")) {\r\nerr = devbus_get_timing_params(devbus, node, &r, &w);\r\nif (err < 0)\r\nreturn err;\r\nif (of_device_is_compatible(node, "marvell,orion-devbus"))\r\ndevbus_orion_set_timing_params(devbus, node, &r, &w);\r\nelse\r\ndevbus_armada_set_timing_params(devbus, node, &r, &w);\r\n}\r\nerr = of_platform_populate(node, NULL, NULL, dev);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int __init mvebu_devbus_init(void)\r\n{\r\nreturn platform_driver_register(&mvebu_devbus_driver);\r\n}

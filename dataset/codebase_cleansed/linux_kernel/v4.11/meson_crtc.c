static void meson_crtc_enable(struct drm_crtc *crtc)\r\n{\r\nstruct meson_crtc *meson_crtc = to_meson_crtc(crtc);\r\nstruct drm_plane *plane = meson_crtc->priv->primary_plane;\r\nstruct meson_drm *priv = meson_crtc->priv;\r\nwritel(plane->state->crtc_w,\r\npriv->io_base + _REG(VPP_POSTBLEND_H_SIZE));\r\nwritel_bits_relaxed(VPP_POSTBLEND_ENABLE, VPP_POSTBLEND_ENABLE,\r\npriv->io_base + _REG(VPP_MISC));\r\npriv->viu.osd1_enabled = true;\r\n}\r\nstatic void meson_crtc_disable(struct drm_crtc *crtc)\r\n{\r\nstruct meson_crtc *meson_crtc = to_meson_crtc(crtc);\r\nstruct meson_drm *priv = meson_crtc->priv;\r\npriv->viu.osd1_enabled = false;\r\nwritel_bits_relaxed(VPP_POSTBLEND_ENABLE, 0,\r\npriv->io_base + _REG(VPP_MISC));\r\nif (crtc->state->event && !crtc->state->active) {\r\nspin_lock_irq(&crtc->dev->event_lock);\r\ndrm_crtc_send_vblank_event(crtc, crtc->state->event);\r\nspin_unlock_irq(&crtc->dev->event_lock);\r\ncrtc->state->event = NULL;\r\n}\r\n}\r\nstatic void meson_crtc_atomic_begin(struct drm_crtc *crtc,\r\nstruct drm_crtc_state *state)\r\n{\r\nstruct meson_crtc *meson_crtc = to_meson_crtc(crtc);\r\nunsigned long flags;\r\nif (crtc->state->event) {\r\nWARN_ON(drm_crtc_vblank_get(crtc) != 0);\r\nspin_lock_irqsave(&crtc->dev->event_lock, flags);\r\nmeson_crtc->event = crtc->state->event;\r\nspin_unlock_irqrestore(&crtc->dev->event_lock, flags);\r\ncrtc->state->event = NULL;\r\n}\r\n}\r\nstatic void meson_crtc_atomic_flush(struct drm_crtc *crtc,\r\nstruct drm_crtc_state *old_crtc_state)\r\n{\r\nstruct meson_crtc *meson_crtc = to_meson_crtc(crtc);\r\nstruct meson_drm *priv = meson_crtc->priv;\r\nif (priv->viu.osd1_enabled)\r\npriv->viu.osd1_commit = true;\r\n}\r\nvoid meson_crtc_irq(struct meson_drm *priv)\r\n{\r\nstruct meson_crtc *meson_crtc = to_meson_crtc(priv->crtc);\r\nunsigned long flags;\r\nif (priv->viu.osd1_enabled && priv->viu.osd1_commit) {\r\nwritel_relaxed(priv->viu.osd1_ctrl_stat,\r\npriv->io_base + _REG(VIU_OSD1_CTRL_STAT));\r\nwritel_relaxed(priv->viu.osd1_blk0_cfg[0],\r\npriv->io_base + _REG(VIU_OSD1_BLK0_CFG_W0));\r\nwritel_relaxed(priv->viu.osd1_blk0_cfg[1],\r\npriv->io_base + _REG(VIU_OSD1_BLK0_CFG_W1));\r\nwritel_relaxed(priv->viu.osd1_blk0_cfg[2],\r\npriv->io_base + _REG(VIU_OSD1_BLK0_CFG_W2));\r\nwritel_relaxed(priv->viu.osd1_blk0_cfg[3],\r\npriv->io_base + _REG(VIU_OSD1_BLK0_CFG_W3));\r\nwritel_relaxed(priv->viu.osd1_blk0_cfg[4],\r\npriv->io_base + _REG(VIU_OSD1_BLK0_CFG_W4));\r\nif (priv->viu.osd1_interlace) {\r\nstruct drm_plane *plane = priv->primary_plane;\r\nstruct drm_plane_state *state = plane->state;\r\nstruct drm_rect dest = {\r\n.x1 = state->crtc_x,\r\n.y1 = state->crtc_y,\r\n.x2 = state->crtc_x + state->crtc_w,\r\n.y2 = state->crtc_y + state->crtc_h,\r\n};\r\nmeson_vpp_setup_interlace_vscaler_osd1(priv, &dest);\r\n} else\r\nmeson_vpp_disable_interlace_vscaler_osd1(priv);\r\nwritel_bits_relaxed(VPP_OSD1_POSTBLEND, VPP_OSD1_POSTBLEND,\r\npriv->io_base + _REG(VPP_MISC));\r\npriv->viu.osd1_commit = false;\r\n}\r\ndrm_crtc_handle_vblank(priv->crtc);\r\nspin_lock_irqsave(&priv->drm->event_lock, flags);\r\nif (meson_crtc->event) {\r\ndrm_crtc_send_vblank_event(priv->crtc, meson_crtc->event);\r\ndrm_crtc_vblank_put(priv->crtc);\r\nmeson_crtc->event = NULL;\r\n}\r\nspin_unlock_irqrestore(&priv->drm->event_lock, flags);\r\n}\r\nint meson_crtc_create(struct meson_drm *priv)\r\n{\r\nstruct meson_crtc *meson_crtc;\r\nstruct drm_crtc *crtc;\r\nint ret;\r\nmeson_crtc = devm_kzalloc(priv->drm->dev, sizeof(*meson_crtc),\r\nGFP_KERNEL);\r\nif (!meson_crtc)\r\nreturn -ENOMEM;\r\nmeson_crtc->priv = priv;\r\ncrtc = &meson_crtc->base;\r\nret = drm_crtc_init_with_planes(priv->drm, crtc,\r\npriv->primary_plane, NULL,\r\n&meson_crtc_funcs, "meson_crtc");\r\nif (ret) {\r\ndev_err(priv->drm->dev, "Failed to init CRTC\n");\r\nreturn ret;\r\n}\r\ndrm_crtc_helper_add(crtc, &meson_crtc_helper_funcs);\r\npriv->crtc = crtc;\r\nreturn 0;\r\n}

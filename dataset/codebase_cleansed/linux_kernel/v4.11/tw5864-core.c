void tw5864_irqmask_apply(struct tw5864_dev *dev)\r\n{\r\ntw_writel(TW5864_INTR_ENABLE_L, dev->irqmask & 0xffff);\r\ntw_writel(TW5864_INTR_ENABLE_H, (dev->irqmask >> 16));\r\n}\r\nstatic void tw5864_interrupts_disable(struct tw5864_dev *dev)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->slock, flags);\r\ndev->irqmask = 0;\r\ntw5864_irqmask_apply(dev);\r\nspin_unlock_irqrestore(&dev->slock, flags);\r\n}\r\nstatic irqreturn_t tw5864_isr(int irq, void *dev_id)\r\n{\r\nstruct tw5864_dev *dev = dev_id;\r\nu32 status;\r\nstatus = tw_readl(TW5864_INTR_STATUS_L) |\r\ntw_readl(TW5864_INTR_STATUS_H) << 16;\r\nif (!status)\r\nreturn IRQ_NONE;\r\ntw_writel(TW5864_INTR_CLR_L, 0xffff);\r\ntw_writel(TW5864_INTR_CLR_H, 0xffff);\r\nif (status & TW5864_INTR_VLC_DONE)\r\ntw5864_h264_isr(dev);\r\nif (status & TW5864_INTR_TIMER)\r\ntw5864_timer_isr(dev);\r\nif (!(status & (TW5864_INTR_TIMER | TW5864_INTR_VLC_DONE))) {\r\ndev_dbg(&dev->pci->dev, "Unknown interrupt, status 0x%08X\n",\r\nstatus);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void tw5864_h264_isr(struct tw5864_dev *dev)\r\n{\r\nint channel = tw_readl(TW5864_DSP) & TW5864_DSP_ENC_CHN;\r\nstruct tw5864_input *input = &dev->inputs[channel];\r\nint cur_frame_index, next_frame_index;\r\nstruct tw5864_h264_frame *cur_frame, *next_frame;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->slock, flags);\r\ncur_frame_index = dev->h264_buf_w_index;\r\nnext_frame_index = (cur_frame_index + 1) % H264_BUF_CNT;\r\ncur_frame = &dev->h264_buf[cur_frame_index];\r\nnext_frame = &dev->h264_buf[next_frame_index];\r\nif (next_frame_index != dev->h264_buf_r_index) {\r\ncur_frame->vlc_len = tw_readl(TW5864_VLC_LENGTH) << 2;\r\ncur_frame->checksum = tw_readl(TW5864_VLC_CRC_REG);\r\ncur_frame->input = input;\r\ncur_frame->timestamp = ktime_get_ns();\r\ncur_frame->seqno = input->frame_seqno;\r\ncur_frame->gop_seqno = input->frame_gop_seqno;\r\ndev->h264_buf_w_index = next_frame_index;\r\ntasklet_schedule(&dev->tasklet);\r\ncur_frame = next_frame;\r\nspin_lock(&input->slock);\r\ninput->frame_seqno++;\r\ninput->frame_gop_seqno++;\r\nif (input->frame_gop_seqno >= input->gop)\r\ninput->frame_gop_seqno = 0;\r\nspin_unlock(&input->slock);\r\n} else {\r\ndev_err(&dev->pci->dev,\r\n"Skipped frame on input %d because all buffers busy\n",\r\nchannel);\r\n}\r\ndev->encoder_busy = 0;\r\nspin_unlock_irqrestore(&dev->slock, flags);\r\ntw_writel(TW5864_VLC_STREAM_BASE_ADDR, cur_frame->vlc.dma_addr);\r\ntw_writel(TW5864_MV_STREAM_BASE_ADDR, cur_frame->mv.dma_addr);\r\ntw_writel(TW5864_VLC_DSP_INTR, 0x00000001);\r\ntw_writel(TW5864_PCI_INTR_STATUS, TW5864_VLC_DONE_INTR);\r\n}\r\nstatic void tw5864_input_deadline_update(struct tw5864_input *input)\r\n{\r\ninput->new_frame_deadline = jiffies + msecs_to_jiffies(1000);\r\n}\r\nstatic void tw5864_timer_isr(struct tw5864_dev *dev)\r\n{\r\nunsigned long flags;\r\nint i;\r\nint encoder_busy;\r\ntw_writel(TW5864_PCI_INTR_STATUS, TW5864_TIMER_INTR);\r\nspin_lock_irqsave(&dev->slock, flags);\r\nencoder_busy = dev->encoder_busy;\r\nspin_unlock_irqrestore(&dev->slock, flags);\r\nif (encoder_busy)\r\nreturn;\r\nfor (i = 0; i < TW5864_INPUTS; i++) {\r\nint next_input = (i + dev->next_input) % TW5864_INPUTS;\r\nstruct tw5864_input *input = &dev->inputs[next_input];\r\nint raw_buf_id;\r\nspin_lock_irqsave(&input->slock, flags);\r\nif (!input->enabled)\r\ngoto next;\r\nraw_buf_id = tw_mask_shift_readl(TW5864_SENIF_ORG_FRM_PTR1, 0x3,\r\n2 * input->nr);\r\nif (input->buf_id != raw_buf_id) {\r\ninput->buf_id = raw_buf_id;\r\ntw5864_input_deadline_update(input);\r\nspin_unlock_irqrestore(&input->slock, flags);\r\nspin_lock_irqsave(&dev->slock, flags);\r\ndev->encoder_busy = 1;\r\ndev->next_input = (next_input + 1) % TW5864_INPUTS;\r\nspin_unlock_irqrestore(&dev->slock, flags);\r\ntw5864_request_encoded_frame(input);\r\nbreak;\r\n}\r\nif (time_is_after_jiffies(input->new_frame_deadline)) {\r\ntw_mask_shift_writel(TW5864_ENC_BUF_PTR_REC1, 0x3,\r\n2 * input->nr, input->buf_id + 3);\r\ntw5864_input_deadline_update(input);\r\n}\r\nnext:\r\nspin_unlock_irqrestore(&input->slock, flags);\r\n}\r\n}\r\nstatic int tw5864_initdev(struct pci_dev *pci_dev,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nstruct tw5864_dev *dev;\r\nint err;\r\ndev = devm_kzalloc(&pci_dev->dev, sizeof(*dev), GFP_KERNEL);\r\nif (!dev)\r\nreturn -ENOMEM;\r\nsnprintf(dev->name, sizeof(dev->name), "tw5864:%s", pci_name(pci_dev));\r\nerr = v4l2_device_register(&pci_dev->dev, &dev->v4l2_dev);\r\nif (err)\r\nreturn err;\r\ndev->pci = pci_dev;\r\nerr = pci_enable_device(pci_dev);\r\nif (err) {\r\ndev_err(&dev->pci->dev, "pci_enable_device() failed\n");\r\ngoto unreg_v4l2;\r\n}\r\npci_set_master(pci_dev);\r\nerr = pci_set_dma_mask(pci_dev, DMA_BIT_MASK(32));\r\nif (err) {\r\ndev_err(&dev->pci->dev, "32 bit PCI DMA is not supported\n");\r\ngoto disable_pci;\r\n}\r\nerr = pci_request_regions(pci_dev, dev->name);\r\nif (err) {\r\ndev_err(&dev->pci->dev, "Cannot request regions for MMIO\n");\r\ngoto disable_pci;\r\n}\r\ndev->mmio = pci_ioremap_bar(pci_dev, 0);\r\nif (!dev->mmio) {\r\nerr = -EIO;\r\ndev_err(&dev->pci->dev, "can't ioremap() MMIO memory\n");\r\ngoto release_mmio;\r\n}\r\nspin_lock_init(&dev->slock);\r\ndev_info(&pci_dev->dev, "TW5864 hardware version: %04x\n",\r\ntw_readl(TW5864_HW_VERSION));\r\ndev_info(&pci_dev->dev, "TW5864 H.264 core version: %04x:%04x\n",\r\ntw_readl(TW5864_H264REV),\r\ntw_readl(TW5864_UNDECLARED_H264REV_PART2));\r\nerr = tw5864_video_init(dev, video_nr);\r\nif (err)\r\ngoto unmap_mmio;\r\nerr = devm_request_irq(&pci_dev->dev, pci_dev->irq, tw5864_isr,\r\nIRQF_SHARED, "tw5864", dev);\r\nif (err < 0) {\r\ndev_err(&dev->pci->dev, "can't get IRQ %d\n", pci_dev->irq);\r\ngoto fini_video;\r\n}\r\ndev_info(&pci_dev->dev, "Note: there are known video quality issues. For details\n");\r\ndev_info(&pci_dev->dev, "see the comment in drivers/media/pci/tw5864/tw5864-core.c.\n");\r\nreturn 0;\r\nfini_video:\r\ntw5864_video_fini(dev);\r\nunmap_mmio:\r\niounmap(dev->mmio);\r\nrelease_mmio:\r\npci_release_regions(pci_dev);\r\ndisable_pci:\r\npci_disable_device(pci_dev);\r\nunreg_v4l2:\r\nv4l2_device_unregister(&dev->v4l2_dev);\r\nreturn err;\r\n}\r\nstatic void tw5864_finidev(struct pci_dev *pci_dev)\r\n{\r\nstruct v4l2_device *v4l2_dev = pci_get_drvdata(pci_dev);\r\nstruct tw5864_dev *dev =\r\ncontainer_of(v4l2_dev, struct tw5864_dev, v4l2_dev);\r\ntw5864_interrupts_disable(dev);\r\ntw5864_video_fini(dev);\r\niounmap(dev->mmio);\r\nrelease_mem_region(pci_resource_start(pci_dev, 0),\r\npci_resource_len(pci_dev, 0));\r\nv4l2_device_unregister(&dev->v4l2_dev);\r\ndevm_kfree(&pci_dev->dev, dev);\r\n}

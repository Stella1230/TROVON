static void hi655x_local_irq_clear(struct regmap *map)\r\n{\r\nint i;\r\nregmap_write(map, HI655X_ANA_IRQM_BASE, HI655X_IRQ_CLR);\r\nfor (i = 0; i < HI655X_IRQ_ARRAY; i++) {\r\nregmap_write(map, HI655X_IRQ_STAT_BASE + i * HI655X_STRIDE,\r\nHI655X_IRQ_CLR);\r\n}\r\n}\r\nstatic int hi655x_pmic_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct hi655x_pmic *pmic;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nvoid __iomem *base;\r\npmic = devm_kzalloc(dev, sizeof(*pmic), GFP_KERNEL);\r\nif (!pmic)\r\nreturn -ENOMEM;\r\npmic->dev = dev;\r\npmic->res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(dev, pmic->res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\npmic->regmap = devm_regmap_init_mmio_clk(dev, NULL, base,\r\n&hi655x_regmap_config);\r\nregmap_read(pmic->regmap, HI655X_BUS_ADDR(HI655X_VER_REG), &pmic->ver);\r\nif ((pmic->ver < PMU_VER_START) || (pmic->ver > PMU_VER_END)) {\r\ndev_warn(dev, "PMU version %d unsupported\n", pmic->ver);\r\nreturn -EINVAL;\r\n}\r\nhi655x_local_irq_clear(pmic->regmap);\r\npmic->gpio = of_get_named_gpio(np, "pmic-gpios", 0);\r\nif (!gpio_is_valid(pmic->gpio)) {\r\ndev_err(dev, "Failed to get the pmic-gpios\n");\r\nreturn -ENODEV;\r\n}\r\nret = devm_gpio_request_one(dev, pmic->gpio, GPIOF_IN,\r\n"hi655x_pmic_irq");\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to request gpio %d ret = %d\n",\r\npmic->gpio, ret);\r\nreturn ret;\r\n}\r\nret = regmap_add_irq_chip(pmic->regmap, gpio_to_irq(pmic->gpio),\r\nIRQF_TRIGGER_LOW | IRQF_NO_SUSPEND, 0,\r\n&hi655x_irq_chip, &pmic->irq_data);\r\nif (ret) {\r\ndev_err(dev, "Failed to obtain 'hi655x_pmic_irq' %d\n", ret);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, pmic);\r\nret = mfd_add_devices(dev, PLATFORM_DEVID_AUTO, hi655x_pmic_devs,\r\nARRAY_SIZE(hi655x_pmic_devs), NULL, 0,\r\nregmap_irq_get_domain(pmic->irq_data));\r\nif (ret) {\r\ndev_err(dev, "Failed to register device %d\n", ret);\r\nregmap_del_irq_chip(gpio_to_irq(pmic->gpio), pmic->irq_data);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hi655x_pmic_remove(struct platform_device *pdev)\r\n{\r\nstruct hi655x_pmic *pmic = platform_get_drvdata(pdev);\r\nregmap_del_irq_chip(gpio_to_irq(pmic->gpio), pmic->irq_data);\r\nmfd_remove_devices(&pdev->dev);\r\nreturn 0;\r\n}

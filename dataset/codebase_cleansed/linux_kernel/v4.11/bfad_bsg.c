int\r\nbfad_iocmd_ioc_enable(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nif (!bfa_ioc_is_disabled(&bfad->bfa.ioc)) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\ninit_completion(&bfad->enable_comp);\r\nbfa_iocfc_enable(&bfad->bfa);\r\niocmd->status = BFA_STATUS_OK;\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nwait_for_completion(&bfad->enable_comp);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_ioc_disable(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nif (bfa_ioc_is_disabled(&bfad->bfa.ioc)) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\nif (bfad->disable_active) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn -EBUSY;\r\n}\r\nbfad->disable_active = BFA_TRUE;\r\ninit_completion(&bfad->disable_comp);\r\nbfa_iocfc_disable(&bfad->bfa);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nwait_for_completion(&bfad->disable_comp);\r\nbfad->disable_active = BFA_FALSE;\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\nstatic int\r\nbfad_iocmd_ioc_get_info(struct bfad_s *bfad, void *cmd)\r\n{\r\nint i;\r\nstruct bfa_bsg_ioc_info_s *iocmd = (struct bfa_bsg_ioc_info_s *)cmd;\r\nstruct bfad_im_port_s *im_port;\r\nstruct bfa_port_attr_s pattr;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nbfa_fcport_get_attr(&bfad->bfa, &pattr);\r\niocmd->nwwn = pattr.nwwn;\r\niocmd->pwwn = pattr.pwwn;\r\niocmd->ioc_type = bfa_get_type(&bfad->bfa);\r\niocmd->mac = bfa_get_mac(&bfad->bfa);\r\niocmd->factory_mac = bfa_get_mfg_mac(&bfad->bfa);\r\nbfa_get_adapter_serial_num(&bfad->bfa, iocmd->serialnum);\r\niocmd->factorynwwn = pattr.factorynwwn;\r\niocmd->factorypwwn = pattr.factorypwwn;\r\niocmd->bfad_num = bfad->inst_no;\r\nim_port = bfad->pport.im_port;\r\niocmd->host = im_port->shost->host_no;\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nstrcpy(iocmd->name, bfad->adapter_name);\r\nstrcpy(iocmd->port_name, bfad->port_name);\r\nstrcpy(iocmd->hwpath, bfad->pci_name);\r\nstrcpy(iocmd->adapter_hwpath, bfad->pci_name);\r\nfor (i = 0; iocmd->adapter_hwpath[i] != ':' && i < BFA_STRING_32; i++)\r\n;\r\nfor (; iocmd->adapter_hwpath[++i] != ':' && i < BFA_STRING_32; )\r\n;\r\niocmd->adapter_hwpath[i] = '\0';\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\nstatic int\r\nbfad_iocmd_ioc_get_attr(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_ioc_attr_s *iocmd = (struct bfa_bsg_ioc_attr_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nbfa_ioc_get_attr(&bfad->bfa.ioc, &iocmd->ioc_attr);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nstrcpy(iocmd->ioc_attr.driver_attr.driver, BFAD_DRIVER_NAME);\r\nstrncpy(iocmd->ioc_attr.driver_attr.driver_ver,\r\nBFAD_DRIVER_VERSION, BFA_VERSION_LEN);\r\nstrcpy(iocmd->ioc_attr.driver_attr.fw_ver,\r\niocmd->ioc_attr.adapter_attr.fw_ver);\r\nstrcpy(iocmd->ioc_attr.driver_attr.bios_ver,\r\niocmd->ioc_attr.adapter_attr.optrom_ver);\r\nmemcpy(bfad->pci_attr.chip_rev, iocmd->ioc_attr.pci_attr.chip_rev,\r\nsizeof(bfad->pci_attr.chip_rev));\r\nmemcpy(&iocmd->ioc_attr.pci_attr, &bfad->pci_attr,\r\nsizeof(struct bfa_ioc_pci_attr_s));\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_ioc_get_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_ioc_stats_s *iocmd = (struct bfa_bsg_ioc_stats_s *)cmd;\r\nbfa_ioc_get_stats(&bfad->bfa, &iocmd->ioc_stats);\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_ioc_get_fwstats(struct bfad_s *bfad, void *cmd,\r\nunsigned int payload_len)\r\n{\r\nstruct bfa_bsg_ioc_fwstats_s *iocmd =\r\n(struct bfa_bsg_ioc_fwstats_s *)cmd;\r\nvoid *iocmd_bufptr;\r\nunsigned long flags;\r\nif (bfad_chk_iocmd_sz(payload_len,\r\nsizeof(struct bfa_bsg_ioc_fwstats_s),\r\nsizeof(struct bfa_fw_stats_s)) != BFA_STATUS_OK) {\r\niocmd->status = BFA_STATUS_VERSION_FAIL;\r\ngoto out;\r\n}\r\niocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_ioc_fwstats_s);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_ioc_fw_stats_get(&bfad->bfa.ioc, iocmd_bufptr);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK) {\r\nbfa_trc(bfad, iocmd->status);\r\ngoto out;\r\n}\r\nout:\r\nbfa_trc(bfad, 0x6666);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_ioc_reset_stats(struct bfad_s *bfad, void *cmd, unsigned int v_cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nunsigned long flags;\r\nif (v_cmd == IOCMD_IOC_RESET_STATS) {\r\nbfa_ioc_clear_stats(&bfad->bfa);\r\niocmd->status = BFA_STATUS_OK;\r\n} else if (v_cmd == IOCMD_IOC_RESET_FWSTATS) {\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_ioc_fw_stats_clear(&bfad->bfa.ioc);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_ioc_set_name(struct bfad_s *bfad, void *cmd, unsigned int v_cmd)\r\n{\r\nstruct bfa_bsg_ioc_name_s *iocmd = (struct bfa_bsg_ioc_name_s *) cmd;\r\nif (v_cmd == IOCMD_IOC_SET_ADAPTER_NAME)\r\nstrcpy(bfad->adapter_name, iocmd->name);\r\nelse if (v_cmd == IOCMD_IOC_SET_PORT_NAME)\r\nstrcpy(bfad->port_name, iocmd->name);\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_iocfc_get_attr(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_iocfc_attr_s *iocmd = (struct bfa_bsg_iocfc_attr_s *)cmd;\r\niocmd->status = BFA_STATUS_OK;\r\nbfa_iocfc_get_attr(&bfad->bfa, &iocmd->iocfc_attr);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_ioc_fw_sig_inv(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_ioc_fwsig_invalidate(&bfad->bfa.ioc);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_iocfc_set_intr(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_iocfc_intr_s *iocmd = (struct bfa_bsg_iocfc_intr_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_iocfc_israttr_set(&bfad->bfa, &iocmd->attr);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_port_enable(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_port_enable(&bfad->bfa.modules.port,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK) {\r\nbfa_trc(bfad, iocmd->status);\r\nreturn 0;\r\n}\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_port_disable(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_port_disable(&bfad->bfa.modules.port,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK) {\r\nbfa_trc(bfad, iocmd->status);\r\nreturn 0;\r\n}\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nreturn 0;\r\n}\r\nstatic int\r\nbfad_iocmd_port_get_attr(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_port_attr_s *iocmd = (struct bfa_bsg_port_attr_s *)cmd;\r\nstruct bfa_lport_attr_s port_attr;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nbfa_fcport_get_attr(&bfad->bfa, &iocmd->attr);\r\nbfa_fcs_lport_get_attr(&bfad->bfa_fcs.fabric.bport, &port_attr);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->attr.topology != BFA_PORT_TOPOLOGY_NONE)\r\niocmd->attr.pid = port_attr.pid;\r\nelse\r\niocmd->attr.pid = 0;\r\niocmd->attr.port_type = port_attr.port_type;\r\niocmd->attr.loopback = port_attr.loopback;\r\niocmd->attr.authfail = port_attr.authfail;\r\nstrncpy(iocmd->attr.port_symname.symname,\r\nport_attr.port_cfg.sym_name.symname,\r\nsizeof(port_attr.port_cfg.sym_name.symname));\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_port_get_stats(struct bfad_s *bfad, void *cmd,\r\nunsigned int payload_len)\r\n{\r\nstruct bfa_bsg_port_stats_s *iocmd = (struct bfa_bsg_port_stats_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nvoid *iocmd_bufptr;\r\nunsigned long flags;\r\nif (bfad_chk_iocmd_sz(payload_len,\r\nsizeof(struct bfa_bsg_port_stats_s),\r\nsizeof(union bfa_port_stats_u)) != BFA_STATUS_OK) {\r\niocmd->status = BFA_STATUS_VERSION_FAIL;\r\nreturn 0;\r\n}\r\niocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_port_stats_s);\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_port_get_stats(&bfad->bfa.modules.port,\r\niocmd_bufptr, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK) {\r\nbfa_trc(bfad, iocmd->status);\r\ngoto out;\r\n}\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_port_reset_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_port_clear_stats(&bfad->bfa.modules.port,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK) {\r\nbfa_trc(bfad, iocmd->status);\r\nreturn 0;\r\n}\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_set_port_cfg(struct bfad_s *bfad, void *iocmd, unsigned int v_cmd)\r\n{\r\nstruct bfa_bsg_port_cfg_s *cmd = (struct bfa_bsg_port_cfg_s *)iocmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nif (v_cmd == IOCMD_PORT_CFG_TOPO)\r\ncmd->status = bfa_fcport_cfg_topology(&bfad->bfa, cmd->param);\r\nelse if (v_cmd == IOCMD_PORT_CFG_SPEED)\r\ncmd->status = bfa_fcport_cfg_speed(&bfad->bfa, cmd->param);\r\nelse if (v_cmd == IOCMD_PORT_CFG_ALPA)\r\ncmd->status = bfa_fcport_cfg_hardalpa(&bfad->bfa, cmd->param);\r\nelse if (v_cmd == IOCMD_PORT_CLR_ALPA)\r\ncmd->status = bfa_fcport_clr_hardalpa(&bfad->bfa);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_port_cfg_maxfrsize(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_port_cfg_maxfrsize_s *iocmd =\r\n(struct bfa_bsg_port_cfg_maxfrsize_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fcport_cfg_maxfrsize(&bfad->bfa, iocmd->maxfrsize);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_port_cfg_bbcr(struct bfad_s *bfad, unsigned int cmd, void *pcmd)\r\n{\r\nstruct bfa_bsg_bbcr_enable_s *iocmd =\r\n(struct bfa_bsg_bbcr_enable_s *)pcmd;\r\nunsigned long flags;\r\nint rc;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nif (cmd == IOCMD_PORT_BBCR_ENABLE)\r\nrc = bfa_fcport_cfg_bbcr(&bfad->bfa, BFA_TRUE, iocmd->bb_scn);\r\nelse if (cmd == IOCMD_PORT_BBCR_DISABLE)\r\nrc = bfa_fcport_cfg_bbcr(&bfad->bfa, BFA_FALSE, 0);\r\nelse {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn -EINVAL;\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = rc;\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_port_get_bbcr_attr(struct bfad_s *bfad, void *pcmd)\r\n{\r\nstruct bfa_bsg_bbcr_attr_s *iocmd = (struct bfa_bsg_bbcr_attr_s *) pcmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status =\r\nbfa_fcport_get_bbcr_attr(&bfad->bfa, &iocmd->attr);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int\r\nbfad_iocmd_lport_get_attr(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nstruct bfa_bsg_lport_attr_s *iocmd = (struct bfa_bsg_lport_attr_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->pwwn);\r\nif (fcs_port == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\ngoto out;\r\n}\r\nbfa_fcs_lport_get_attr(fcs_port, &iocmd->port_attr);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_lport_get_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nstruct bfa_bsg_lport_stats_s *iocmd =\r\n(struct bfa_bsg_lport_stats_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->pwwn);\r\nif (fcs_port == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\ngoto out;\r\n}\r\nbfa_fcs_lport_get_stats(fcs_port, &iocmd->port_stats);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_lport_reset_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nstruct bfa_bsg_reset_stats_s *iocmd =\r\n(struct bfa_bsg_reset_stats_s *)cmd;\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(&bfad->bfa);\r\nstruct list_head *qe, *qen;\r\nstruct bfa_itnim_s *itnim;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->vpwwn);\r\nif (fcs_port == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\ngoto out;\r\n}\r\nbfa_fcs_lport_clear_stats(fcs_port);\r\nlist_for_each_safe(qe, qen, &fcpim->itnim_q) {\r\nitnim = (struct bfa_itnim_s *) qe;\r\nif (itnim->rport->rport_info.lp_tag != fcs_port->lp_tag)\r\ncontinue;\r\nbfa_itnim_clear_stats(itnim);\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_lport_get_iostats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nstruct bfa_bsg_lport_iostats_s *iocmd =\r\n(struct bfa_bsg_lport_iostats_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->pwwn);\r\nif (fcs_port == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\ngoto out;\r\n}\r\nbfa_fcpim_port_iostats(&bfad->bfa, &iocmd->iostats,\r\nfcs_port->lp_tag);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_lport_get_rports(struct bfad_s *bfad, void *cmd,\r\nunsigned int payload_len)\r\n{\r\nstruct bfa_bsg_lport_get_rports_s *iocmd =\r\n(struct bfa_bsg_lport_get_rports_s *)cmd;\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nunsigned long flags;\r\nvoid *iocmd_bufptr;\r\nif (iocmd->nrports == 0)\r\nreturn -EINVAL;\r\nif (bfad_chk_iocmd_sz(payload_len,\r\nsizeof(struct bfa_bsg_lport_get_rports_s),\r\nsizeof(struct bfa_rport_qualifier_s) * iocmd->nrports)\r\n!= BFA_STATUS_OK) {\r\niocmd->status = BFA_STATUS_VERSION_FAIL;\r\nreturn 0;\r\n}\r\niocmd_bufptr = (char *)iocmd +\r\nsizeof(struct bfa_bsg_lport_get_rports_s);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->pwwn);\r\nif (fcs_port == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nbfa_trc(bfad, 0);\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\ngoto out;\r\n}\r\nbfa_fcs_lport_get_rport_quals(fcs_port,\r\n(struct bfa_rport_qualifier_s *)iocmd_bufptr,\r\n&iocmd->nrports);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_rport_get_attr(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_rport_attr_s *iocmd = (struct bfa_bsg_rport_attr_s *)cmd;\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nstruct bfa_fcs_rport_s *fcs_rport;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->pwwn);\r\nif (fcs_port == NULL) {\r\nbfa_trc(bfad, 0);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\ngoto out;\r\n}\r\nif (iocmd->pid)\r\nfcs_rport = bfa_fcs_lport_get_rport_by_qualifier(fcs_port,\r\niocmd->rpwwn, iocmd->pid);\r\nelse\r\nfcs_rport = bfa_fcs_rport_lookup(fcs_port, iocmd->rpwwn);\r\nif (fcs_rport == NULL) {\r\nbfa_trc(bfad, 0);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_RWWN;\r\ngoto out;\r\n}\r\nbfa_fcs_rport_get_attr(fcs_rport, &iocmd->attr);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nstatic int\r\nbfad_iocmd_rport_get_addr(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_rport_scsi_addr_s *iocmd =\r\n(struct bfa_bsg_rport_scsi_addr_s *)cmd;\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nstruct bfa_fcs_itnim_s *fcs_itnim;\r\nstruct bfad_itnim_s *drv_itnim;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->pwwn);\r\nif (fcs_port == NULL) {\r\nbfa_trc(bfad, 0);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\ngoto out;\r\n}\r\nfcs_itnim = bfa_fcs_itnim_lookup(fcs_port, iocmd->rpwwn);\r\nif (fcs_itnim == NULL) {\r\nbfa_trc(bfad, 0);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_RWWN;\r\ngoto out;\r\n}\r\ndrv_itnim = fcs_itnim->itnim_drv;\r\nif (drv_itnim && drv_itnim->im_port)\r\niocmd->host = drv_itnim->im_port->shost->host_no;\r\nelse {\r\nbfa_trc(bfad, 0);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_RWWN;\r\ngoto out;\r\n}\r\niocmd->target = drv_itnim->scsi_tgt_id;\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->bus = 0;\r\niocmd->lun = 0;\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_rport_get_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_rport_stats_s *iocmd =\r\n(struct bfa_bsg_rport_stats_s *)cmd;\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nstruct bfa_fcs_rport_s *fcs_rport;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->pwwn);\r\nif (fcs_port == NULL) {\r\nbfa_trc(bfad, 0);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\ngoto out;\r\n}\r\nfcs_rport = bfa_fcs_rport_lookup(fcs_port, iocmd->rpwwn);\r\nif (fcs_rport == NULL) {\r\nbfa_trc(bfad, 0);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_RWWN;\r\ngoto out;\r\n}\r\nmemcpy((void *)&iocmd->stats, (void *)&fcs_rport->stats,\r\nsizeof(struct bfa_rport_stats_s));\r\nif (bfa_fcs_rport_get_halrport(fcs_rport)) {\r\nmemcpy((void *)&iocmd->stats.hal_stats,\r\n(void *)&(bfa_fcs_rport_get_halrport(fcs_rport)->stats),\r\nsizeof(struct bfa_rport_hal_stats_s));\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_rport_clr_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_rport_reset_stats_s *iocmd =\r\n(struct bfa_bsg_rport_reset_stats_s *)cmd;\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nstruct bfa_fcs_rport_s *fcs_rport;\r\nstruct bfa_rport_s *rport;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->pwwn);\r\nif (fcs_port == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\ngoto out;\r\n}\r\nfcs_rport = bfa_fcs_rport_lookup(fcs_port, iocmd->rpwwn);\r\nif (fcs_rport == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_RWWN;\r\ngoto out;\r\n}\r\nmemset((char *)&fcs_rport->stats, 0, sizeof(struct bfa_rport_stats_s));\r\nrport = bfa_fcs_rport_get_halrport(fcs_rport);\r\nif (rport)\r\nmemset(&rport->stats, 0, sizeof(rport->stats));\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_rport_set_speed(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_rport_set_speed_s *iocmd =\r\n(struct bfa_bsg_rport_set_speed_s *)cmd;\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nstruct bfa_fcs_rport_s *fcs_rport;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->pwwn);\r\nif (fcs_port == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\ngoto out;\r\n}\r\nfcs_rport = bfa_fcs_rport_lookup(fcs_port, iocmd->rpwwn);\r\nif (fcs_rport == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_RWWN;\r\ngoto out;\r\n}\r\nfcs_rport->rpf.assigned_speed = iocmd->speed;\r\nif (fcs_rport->rpf.rpsc_speed == BFA_PORT_SPEED_UNKNOWN)\r\nif (fcs_rport->bfa_rport)\r\nbfa_rport_speed(fcs_rport->bfa_rport, iocmd->speed);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_vport_get_attr(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_fcs_vport_s *fcs_vport;\r\nstruct bfa_bsg_vport_attr_s *iocmd = (struct bfa_bsg_vport_attr_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_vport = bfa_fcs_vport_lookup(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->vpwwn);\r\nif (fcs_vport == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_VWWN;\r\ngoto out;\r\n}\r\nbfa_fcs_vport_get_attr(fcs_vport, &iocmd->vport_attr);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_vport_get_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_fcs_vport_s *fcs_vport;\r\nstruct bfa_bsg_vport_stats_s *iocmd =\r\n(struct bfa_bsg_vport_stats_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_vport = bfa_fcs_vport_lookup(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->vpwwn);\r\nif (fcs_vport == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_VWWN;\r\ngoto out;\r\n}\r\nmemcpy((void *)&iocmd->vport_stats, (void *)&fcs_vport->vport_stats,\r\nsizeof(struct bfa_vport_stats_s));\r\nmemcpy((void *)&iocmd->vport_stats.port_stats,\r\n(void *)&fcs_vport->lport.stats,\r\nsizeof(struct bfa_lport_stats_s));\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_vport_clr_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_fcs_vport_s *fcs_vport;\r\nstruct bfa_bsg_reset_stats_s *iocmd =\r\n(struct bfa_bsg_reset_stats_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_vport = bfa_fcs_vport_lookup(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->vpwwn);\r\nif (fcs_vport == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_VWWN;\r\ngoto out;\r\n}\r\nmemset(&fcs_vport->vport_stats, 0, sizeof(struct bfa_vport_stats_s));\r\nmemset(&fcs_vport->lport.stats, 0, sizeof(struct bfa_lport_stats_s));\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nstatic int\r\nbfad_iocmd_fabric_get_lports(struct bfad_s *bfad, void *cmd,\r\nunsigned int payload_len)\r\n{\r\nstruct bfa_bsg_fabric_get_lports_s *iocmd =\r\n(struct bfa_bsg_fabric_get_lports_s *)cmd;\r\nbfa_fcs_vf_t *fcs_vf;\r\nuint32_t nports = iocmd->nports;\r\nunsigned long flags;\r\nvoid *iocmd_bufptr;\r\nif (nports == 0) {\r\niocmd->status = BFA_STATUS_EINVAL;\r\ngoto out;\r\n}\r\nif (bfad_chk_iocmd_sz(payload_len,\r\nsizeof(struct bfa_bsg_fabric_get_lports_s),\r\nsizeof(wwn_t[iocmd->nports])) != BFA_STATUS_OK) {\r\niocmd->status = BFA_STATUS_VERSION_FAIL;\r\ngoto out;\r\n}\r\niocmd_bufptr = (char *)iocmd +\r\nsizeof(struct bfa_bsg_fabric_get_lports_s);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_vf = bfa_fcs_vf_lookup(&bfad->bfa_fcs, iocmd->vf_id);\r\nif (fcs_vf == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_VFID;\r\ngoto out;\r\n}\r\nbfa_fcs_vf_get_ports(fcs_vf, (wwn_t *)iocmd_bufptr, &nports);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->nports = nports;\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_qos_set_bw(struct bfad_s *bfad, void *pcmd)\r\n{\r\nstruct bfa_bsg_qos_bw_s *iocmd = (struct bfa_bsg_qos_bw_s *)pcmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fcport_set_qos_bw(&bfad->bfa, &iocmd->qos_bw);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_ratelim(struct bfad_s *bfad, unsigned int cmd, void *pcmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)pcmd;\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) &&\r\n(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\r\niocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\r\nelse {\r\nif (cmd == IOCMD_RATELIM_ENABLE)\r\nfcport->cfg.ratelimit = BFA_TRUE;\r\nelse if (cmd == IOCMD_RATELIM_DISABLE)\r\nfcport->cfg.ratelimit = BFA_FALSE;\r\nif (fcport->cfg.trl_def_speed == BFA_PORT_SPEED_UNKNOWN)\r\nfcport->cfg.trl_def_speed = BFA_PORT_SPEED_1GBPS;\r\niocmd->status = BFA_STATUS_OK;\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_ratelim_speed(struct bfad_s *bfad, unsigned int cmd, void *pcmd)\r\n{\r\nstruct bfa_bsg_trl_speed_s *iocmd = (struct bfa_bsg_trl_speed_s *)pcmd;\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nif ((iocmd->speed == BFA_PORT_SPEED_AUTO) ||\r\n(iocmd->speed > fcport->speed_sup)) {\r\niocmd->status = BFA_STATUS_UNSUPP_SPEED;\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) &&\r\n(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\r\niocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\r\nelse {\r\nfcport->cfg.trl_def_speed = iocmd->speed;\r\niocmd->status = BFA_STATUS_OK;\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_cfg_fcpim(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_fcpim_s *iocmd = (struct bfa_bsg_fcpim_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nbfa_fcpim_path_tov_set(&bfad->bfa, iocmd->param);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fcpim_get_modstats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_fcpim_modstats_s *iocmd =\r\n(struct bfa_bsg_fcpim_modstats_s *)cmd;\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(&bfad->bfa);\r\nstruct list_head *qe, *qen;\r\nstruct bfa_itnim_s *itnim;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nmemset((void *)&iocmd->modstats, 0, sizeof(struct bfa_itnim_iostats_s));\r\nlist_for_each_safe(qe, qen, &fcpim->itnim_q) {\r\nitnim = (struct bfa_itnim_s *) qe;\r\nbfa_fcpim_add_stats(&iocmd->modstats, &(itnim->stats));\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fcpim_clr_modstats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_fcpim_modstatsclr_s *iocmd =\r\n(struct bfa_bsg_fcpim_modstatsclr_s *)cmd;\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(&bfad->bfa);\r\nstruct list_head *qe, *qen;\r\nstruct bfa_itnim_s *itnim;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nlist_for_each_safe(qe, qen, &fcpim->itnim_q) {\r\nitnim = (struct bfa_itnim_s *) qe;\r\nbfa_itnim_clear_stats(itnim);\r\n}\r\nmemset(&fcpim->del_itn_stats, 0,\r\nsizeof(struct bfa_fcpim_del_itn_stats_s));\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fcpim_get_del_itn_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_fcpim_del_itn_stats_s *iocmd =\r\n(struct bfa_bsg_fcpim_del_itn_stats_s *)cmd;\r\nstruct bfa_fcpim_s *fcpim = BFA_FCPIM(&bfad->bfa);\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nmemcpy((void *)&iocmd->modstats, (void *)&fcpim->del_itn_stats,\r\nsizeof(struct bfa_fcpim_del_itn_stats_s));\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\nstatic int\r\nbfad_iocmd_itnim_get_attr(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_itnim_attr_s *iocmd = (struct bfa_bsg_itnim_attr_s *)cmd;\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->lpwwn);\r\nif (!fcs_port)\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\nelse\r\niocmd->status = bfa_fcs_itnim_attr_get(fcs_port,\r\niocmd->rpwwn, &iocmd->attr);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int\r\nbfad_iocmd_itnim_get_iostats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_itnim_iostats_s *iocmd =\r\n(struct bfa_bsg_itnim_iostats_s *)cmd;\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nstruct bfa_fcs_itnim_s *itnim;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->lpwwn);\r\nif (!fcs_port) {\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\nbfa_trc(bfad, 0);\r\n} else {\r\nitnim = bfa_fcs_itnim_lookup(fcs_port, iocmd->rpwwn);\r\nif (itnim == NULL)\r\niocmd->status = BFA_STATUS_UNKNOWN_RWWN;\r\nelse {\r\niocmd->status = BFA_STATUS_OK;\r\nif (bfa_fcs_itnim_get_halitn(itnim))\r\nmemcpy((void *)&iocmd->iostats, (void *)\r\n&(bfa_fcs_itnim_get_halitn(itnim)->stats),\r\nsizeof(struct bfa_itnim_iostats_s));\r\n}\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int\r\nbfad_iocmd_itnim_reset_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_rport_reset_stats_s *iocmd =\r\n(struct bfa_bsg_rport_reset_stats_s *)cmd;\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nstruct bfa_fcs_itnim_s *itnim;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->pwwn);\r\nif (!fcs_port)\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\nelse {\r\nitnim = bfa_fcs_itnim_lookup(fcs_port, iocmd->rpwwn);\r\nif (itnim == NULL)\r\niocmd->status = BFA_STATUS_UNKNOWN_RWWN;\r\nelse {\r\niocmd->status = BFA_STATUS_OK;\r\nbfa_fcs_itnim_stats_clear(fcs_port, iocmd->rpwwn);\r\nbfa_itnim_clear_stats(bfa_fcs_itnim_get_halitn(itnim));\r\n}\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int\r\nbfad_iocmd_itnim_get_itnstats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_itnim_itnstats_s *iocmd =\r\n(struct bfa_bsg_itnim_itnstats_s *)cmd;\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nstruct bfa_fcs_itnim_s *itnim;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->lpwwn);\r\nif (!fcs_port) {\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\nbfa_trc(bfad, 0);\r\n} else {\r\nitnim = bfa_fcs_itnim_lookup(fcs_port, iocmd->rpwwn);\r\nif (itnim == NULL)\r\niocmd->status = BFA_STATUS_UNKNOWN_RWWN;\r\nelse {\r\niocmd->status = BFA_STATUS_OK;\r\nbfa_fcs_itnim_stats_get(fcs_port, iocmd->rpwwn,\r\n&iocmd->itnstats);\r\n}\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fcport_enable(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fcport_enable(&bfad->bfa);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fcport_disable(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fcport_disable(&bfad->bfa);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_ioc_get_pcifn_cfg(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_pcifn_cfg_s *iocmd = (struct bfa_bsg_pcifn_cfg_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_ablk_query(&bfad->bfa.modules.ablk,\r\n&iocmd->pcifn_cfg,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_pcifn_create(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_pcifn_s *iocmd = (struct bfa_bsg_pcifn_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_ablk_pf_create(&bfad->bfa.modules.ablk,\r\n&iocmd->pcifn_id, iocmd->port,\r\niocmd->pcifn_class, iocmd->bw_min,\r\niocmd->bw_max, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_pcifn_delete(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_pcifn_s *iocmd = (struct bfa_bsg_pcifn_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_ablk_pf_delete(&bfad->bfa.modules.ablk,\r\niocmd->pcifn_id,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_pcifn_bw(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_pcifn_s *iocmd = (struct bfa_bsg_pcifn_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_ablk_pf_update(&bfad->bfa.modules.ablk,\r\niocmd->pcifn_id, iocmd->bw_min,\r\niocmd->bw_max, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nbfa_trc(bfad, iocmd->status);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nbfa_trc(bfad, iocmd->status);\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_adapter_cfg_mode(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_adapter_cfg_mode_s *iocmd =\r\n(struct bfa_bsg_adapter_cfg_mode_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags = 0;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_ablk_adapter_config(&bfad->bfa.modules.ablk,\r\niocmd->cfg.mode, iocmd->cfg.max_pf,\r\niocmd->cfg.max_vf, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_port_cfg_mode(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_port_cfg_mode_s *iocmd =\r\n(struct bfa_bsg_port_cfg_mode_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags = 0;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_ablk_port_config(&bfad->bfa.modules.ablk,\r\niocmd->instance, iocmd->cfg.mode,\r\niocmd->cfg.max_pf, iocmd->cfg.max_vf,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_ablk_optrom(struct bfad_s *bfad, unsigned int cmd, void *pcmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)pcmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nif (cmd == IOCMD_FLASH_ENABLE_OPTROM)\r\niocmd->status = bfa_ablk_optrom_en(&bfad->bfa.modules.ablk,\r\nbfad_hcb_comp, &fcomp);\r\nelse\r\niocmd->status = bfa_ablk_optrom_dis(&bfad->bfa.modules.ablk,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_faa_query(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_faa_attr_s *iocmd = (struct bfa_bsg_faa_attr_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\niocmd->status = BFA_STATUS_OK;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_faa_query(&bfad->bfa, &iocmd->faa_attr,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_cee_attr(struct bfad_s *bfad, void *cmd, unsigned int payload_len)\r\n{\r\nstruct bfa_bsg_cee_attr_s *iocmd =\r\n(struct bfa_bsg_cee_attr_s *)cmd;\r\nvoid *iocmd_bufptr;\r\nstruct bfad_hal_comp cee_comp;\r\nunsigned long flags;\r\nif (bfad_chk_iocmd_sz(payload_len,\r\nsizeof(struct bfa_bsg_cee_attr_s),\r\nsizeof(struct bfa_cee_attr_s)) != BFA_STATUS_OK) {\r\niocmd->status = BFA_STATUS_VERSION_FAIL;\r\nreturn 0;\r\n}\r\niocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_cee_attr_s);\r\ncee_comp.status = 0;\r\ninit_completion(&cee_comp.comp);\r\nmutex_lock(&bfad_mutex);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_cee_get_attr(&bfad->bfa.modules.cee, iocmd_bufptr,\r\nbfad_hcb_comp, &cee_comp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK) {\r\nmutex_unlock(&bfad_mutex);\r\nbfa_trc(bfad, 0x5555);\r\ngoto out;\r\n}\r\nwait_for_completion(&cee_comp.comp);\r\nmutex_unlock(&bfad_mutex);\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_cee_get_stats(struct bfad_s *bfad, void *cmd,\r\nunsigned int payload_len)\r\n{\r\nstruct bfa_bsg_cee_stats_s *iocmd =\r\n(struct bfa_bsg_cee_stats_s *)cmd;\r\nvoid *iocmd_bufptr;\r\nstruct bfad_hal_comp cee_comp;\r\nunsigned long flags;\r\nif (bfad_chk_iocmd_sz(payload_len,\r\nsizeof(struct bfa_bsg_cee_stats_s),\r\nsizeof(struct bfa_cee_stats_s)) != BFA_STATUS_OK) {\r\niocmd->status = BFA_STATUS_VERSION_FAIL;\r\nreturn 0;\r\n}\r\niocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_cee_stats_s);\r\ncee_comp.status = 0;\r\ninit_completion(&cee_comp.comp);\r\nmutex_lock(&bfad_mutex);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_cee_get_stats(&bfad->bfa.modules.cee, iocmd_bufptr,\r\nbfad_hcb_comp, &cee_comp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK) {\r\nmutex_unlock(&bfad_mutex);\r\nbfa_trc(bfad, 0x5555);\r\ngoto out;\r\n}\r\nwait_for_completion(&cee_comp.comp);\r\nmutex_unlock(&bfad_mutex);\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_cee_reset_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_cee_reset_stats(&bfad->bfa.modules.cee, NULL, NULL);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\nbfa_trc(bfad, 0x5555);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_sfp_media(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_sfp_media_s *iocmd = (struct bfa_bsg_sfp_media_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_sfp_media(BFA_SFP_MOD(&bfad->bfa), &iocmd->media,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nbfa_trc(bfad, iocmd->status);\r\nif (iocmd->status != BFA_STATUS_SFP_NOT_READY)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_sfp_speed(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_sfp_speed_s *iocmd = (struct bfa_bsg_sfp_speed_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_sfp_speed(BFA_SFP_MOD(&bfad->bfa), iocmd->speed,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nbfa_trc(bfad, iocmd->status);\r\nif (iocmd->status != BFA_STATUS_SFP_NOT_READY)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_flash_get_attr(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_flash_attr_s *iocmd =\r\n(struct bfa_bsg_flash_attr_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_flash_get_attr(BFA_FLASH(&bfad->bfa), &iocmd->attr,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_flash_erase_part(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_flash_s *iocmd = (struct bfa_bsg_flash_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_flash_erase_part(BFA_FLASH(&bfad->bfa), iocmd->type,\r\niocmd->instance, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_flash_update_part(struct bfad_s *bfad, void *cmd,\r\nunsigned int payload_len)\r\n{\r\nstruct bfa_bsg_flash_s *iocmd = (struct bfa_bsg_flash_s *)cmd;\r\nvoid *iocmd_bufptr;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\nif (bfad_chk_iocmd_sz(payload_len,\r\nsizeof(struct bfa_bsg_flash_s),\r\niocmd->bufsz) != BFA_STATUS_OK) {\r\niocmd->status = BFA_STATUS_VERSION_FAIL;\r\nreturn 0;\r\n}\r\niocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_flash_s);\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_flash_update_part(BFA_FLASH(&bfad->bfa),\r\niocmd->type, iocmd->instance, iocmd_bufptr,\r\niocmd->bufsz, 0, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_flash_read_part(struct bfad_s *bfad, void *cmd,\r\nunsigned int payload_len)\r\n{\r\nstruct bfa_bsg_flash_s *iocmd = (struct bfa_bsg_flash_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nvoid *iocmd_bufptr;\r\nunsigned long flags;\r\nif (bfad_chk_iocmd_sz(payload_len,\r\nsizeof(struct bfa_bsg_flash_s),\r\niocmd->bufsz) != BFA_STATUS_OK) {\r\niocmd->status = BFA_STATUS_VERSION_FAIL;\r\nreturn 0;\r\n}\r\niocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_flash_s);\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_flash_read_part(BFA_FLASH(&bfad->bfa), iocmd->type,\r\niocmd->instance, iocmd_bufptr, iocmd->bufsz, 0,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_diag_temp(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_diag_get_temp_s *iocmd =\r\n(struct bfa_bsg_diag_get_temp_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_diag_tsensor_query(BFA_DIAG_MOD(&bfad->bfa),\r\n&iocmd->result, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nbfa_trc(bfad, iocmd->status);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_diag_memtest(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_diag_memtest_s *iocmd =\r\n(struct bfa_bsg_diag_memtest_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_diag_memtest(BFA_DIAG_MOD(&bfad->bfa),\r\n&iocmd->memtest, iocmd->pat,\r\n&iocmd->result, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nbfa_trc(bfad, iocmd->status);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_diag_loopback(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_diag_loopback_s *iocmd =\r\n(struct bfa_bsg_diag_loopback_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fcdiag_loopback(&bfad->bfa, iocmd->opmode,\r\niocmd->speed, iocmd->lpcnt, iocmd->pat,\r\n&iocmd->result, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nbfa_trc(bfad, iocmd->status);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_diag_fwping(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_diag_fwping_s *iocmd =\r\n(struct bfa_bsg_diag_fwping_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_diag_fwping(BFA_DIAG_MOD(&bfad->bfa), iocmd->cnt,\r\niocmd->pattern, &iocmd->result,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nbfa_trc(bfad, iocmd->status);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nbfa_trc(bfad, 0x77771);\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_diag_queuetest(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_diag_qtest_s *iocmd = (struct bfa_bsg_diag_qtest_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fcdiag_queuetest(&bfad->bfa, iocmd->force,\r\niocmd->queue, &iocmd->result,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_diag_sfp(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_sfp_show_s *iocmd =\r\n(struct bfa_bsg_sfp_show_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_sfp_show(BFA_SFP_MOD(&bfad->bfa), &iocmd->sfp,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nbfa_trc(bfad, iocmd->status);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nbfa_trc(bfad, iocmd->status);\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_diag_led(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_diag_led_s *iocmd = (struct bfa_bsg_diag_led_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_diag_ledtest(BFA_DIAG_MOD(&bfad->bfa),\r\n&iocmd->ledtest);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_diag_beacon_lport(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_diag_beacon_s *iocmd =\r\n(struct bfa_bsg_diag_beacon_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_diag_beacon_port(BFA_DIAG_MOD(&bfad->bfa),\r\niocmd->beacon, iocmd->link_e2e_beacon,\r\niocmd->second);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_diag_lb_stat(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_diag_lb_stat_s *iocmd =\r\n(struct bfa_bsg_diag_lb_stat_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fcdiag_lb_is_running(&bfad->bfa);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nbfa_trc(bfad, iocmd->status);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_diag_dport_enable(struct bfad_s *bfad, void *pcmd)\r\n{\r\nstruct bfa_bsg_dport_enable_s *iocmd =\r\n(struct bfa_bsg_dport_enable_s *)pcmd;\r\nunsigned long flags;\r\nstruct bfad_hal_comp fcomp;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_dport_enable(&bfad->bfa, iocmd->lpcnt,\r\niocmd->pat, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\nbfa_trc(bfad, iocmd->status);\r\nelse {\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\n}\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_diag_dport_disable(struct bfad_s *bfad, void *pcmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)pcmd;\r\nunsigned long flags;\r\nstruct bfad_hal_comp fcomp;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_dport_disable(&bfad->bfa, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\nbfa_trc(bfad, iocmd->status);\r\nelse {\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\n}\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_diag_dport_start(struct bfad_s *bfad, void *pcmd)\r\n{\r\nstruct bfa_bsg_dport_enable_s *iocmd =\r\n(struct bfa_bsg_dport_enable_s *)pcmd;\r\nunsigned long flags;\r\nstruct bfad_hal_comp fcomp;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_dport_start(&bfad->bfa, iocmd->lpcnt,\r\niocmd->pat, bfad_hcb_comp,\r\n&fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK) {\r\nbfa_trc(bfad, iocmd->status);\r\n} else {\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\n}\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_diag_dport_show(struct bfad_s *bfad, void *pcmd)\r\n{\r\nstruct bfa_bsg_diag_dport_show_s *iocmd =\r\n(struct bfa_bsg_diag_dport_show_s *)pcmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_dport_show(&bfad->bfa, &iocmd->result);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_phy_get_attr(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_phy_attr_s *iocmd =\r\n(struct bfa_bsg_phy_attr_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_phy_get_attr(BFA_PHY(&bfad->bfa), iocmd->instance,\r\n&iocmd->attr, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_phy_get_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_phy_stats_s *iocmd =\r\n(struct bfa_bsg_phy_stats_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_phy_get_stats(BFA_PHY(&bfad->bfa), iocmd->instance,\r\n&iocmd->stats, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_phy_read(struct bfad_s *bfad, void *cmd, unsigned int payload_len)\r\n{\r\nstruct bfa_bsg_phy_s *iocmd = (struct bfa_bsg_phy_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nvoid *iocmd_bufptr;\r\nunsigned long flags;\r\nif (bfad_chk_iocmd_sz(payload_len,\r\nsizeof(struct bfa_bsg_phy_s),\r\niocmd->bufsz) != BFA_STATUS_OK) {\r\niocmd->status = BFA_STATUS_VERSION_FAIL;\r\nreturn 0;\r\n}\r\niocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_phy_s);\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_phy_read(BFA_PHY(&bfad->bfa),\r\niocmd->instance, iocmd_bufptr, iocmd->bufsz,\r\n0, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_vhba_query(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_vhba_attr_s *iocmd =\r\n(struct bfa_bsg_vhba_attr_s *)cmd;\r\nstruct bfa_vhba_attr_s *attr = &iocmd->attr;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nattr->pwwn = bfad->bfa.ioc.attr->pwwn;\r\nattr->nwwn = bfad->bfa.ioc.attr->nwwn;\r\nattr->plog_enabled = (bfa_boolean_t)bfad->bfa.plog->plog_enabled;\r\nattr->io_profile = bfa_fcpim_get_io_profile(&bfad->bfa);\r\nattr->path_tov = bfa_fcpim_path_tov_get(&bfad->bfa);\r\niocmd->status = BFA_STATUS_OK;\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_phy_update(struct bfad_s *bfad, void *cmd, unsigned int payload_len)\r\n{\r\nstruct bfa_bsg_phy_s *iocmd = (struct bfa_bsg_phy_s *)cmd;\r\nvoid *iocmd_bufptr;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\nif (bfad_chk_iocmd_sz(payload_len,\r\nsizeof(struct bfa_bsg_phy_s),\r\niocmd->bufsz) != BFA_STATUS_OK) {\r\niocmd->status = BFA_STATUS_VERSION_FAIL;\r\nreturn 0;\r\n}\r\niocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_phy_s);\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_phy_update(BFA_PHY(&bfad->bfa),\r\niocmd->instance, iocmd_bufptr, iocmd->bufsz,\r\n0, bfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_porglog_get(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_debug_s *iocmd = (struct bfa_bsg_debug_s *)cmd;\r\nvoid *iocmd_bufptr;\r\nif (iocmd->bufsz < sizeof(struct bfa_plog_s)) {\r\nbfa_trc(bfad, sizeof(struct bfa_plog_s));\r\niocmd->status = BFA_STATUS_EINVAL;\r\ngoto out;\r\n}\r\niocmd->status = BFA_STATUS_OK;\r\niocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_debug_s);\r\nmemcpy(iocmd_bufptr, (u8 *) &bfad->plog_buf, sizeof(struct bfa_plog_s));\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_debug_fw_core(struct bfad_s *bfad, void *cmd,\r\nunsigned int payload_len)\r\n{\r\nstruct bfa_bsg_debug_s *iocmd = (struct bfa_bsg_debug_s *)cmd;\r\nvoid *iocmd_bufptr;\r\nunsigned long flags;\r\nu32 offset;\r\nif (bfad_chk_iocmd_sz(payload_len, sizeof(struct bfa_bsg_debug_s),\r\nBFA_DEBUG_FW_CORE_CHUNK_SZ) != BFA_STATUS_OK) {\r\niocmd->status = BFA_STATUS_VERSION_FAIL;\r\nreturn 0;\r\n}\r\nif (iocmd->bufsz < BFA_DEBUG_FW_CORE_CHUNK_SZ ||\r\n!IS_ALIGNED(iocmd->bufsz, sizeof(u16)) ||\r\n!IS_ALIGNED(iocmd->offset, sizeof(u32))) {\r\nbfa_trc(bfad, BFA_DEBUG_FW_CORE_CHUNK_SZ);\r\niocmd->status = BFA_STATUS_EINVAL;\r\ngoto out;\r\n}\r\niocmd_bufptr = (char *)iocmd + sizeof(struct bfa_bsg_debug_s);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\noffset = iocmd->offset;\r\niocmd->status = bfa_ioc_debug_fwcore(&bfad->bfa.ioc, iocmd_bufptr,\r\n&offset, &iocmd->bufsz);\r\niocmd->offset = offset;\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_debug_ctl(struct bfad_s *bfad, void *cmd, unsigned int v_cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nunsigned long flags;\r\nif (v_cmd == IOCMD_DEBUG_FW_STATE_CLR) {\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nbfad->bfa.ioc.dbg_fwsave_once = BFA_TRUE;\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\n} else if (v_cmd == IOCMD_DEBUG_PORTLOG_CLR)\r\nbfad->plog_buf.head = bfad->plog_buf.tail = 0;\r\nelse if (v_cmd == IOCMD_DEBUG_START_DTRC)\r\nbfa_trc_init(bfad->trcmod);\r\nelse if (v_cmd == IOCMD_DEBUG_STOP_DTRC)\r\nbfa_trc_stop(bfad->trcmod);\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_porglog_ctl(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_portlogctl_s *iocmd = (struct bfa_bsg_portlogctl_s *)cmd;\r\nif (iocmd->ctl == BFA_TRUE)\r\nbfad->plog_buf.plog_enabled = 1;\r\nelse\r\nbfad->plog_buf.plog_enabled = 0;\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fcpim_cfg_profile(struct bfad_s *bfad, void *cmd, unsigned int v_cmd)\r\n{\r\nstruct bfa_bsg_fcpim_profile_s *iocmd =\r\n(struct bfa_bsg_fcpim_profile_s *)cmd;\r\nstruct timeval tv;\r\nunsigned long flags;\r\ndo_gettimeofday(&tv);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nif (v_cmd == IOCMD_FCPIM_PROFILE_ON)\r\niocmd->status = bfa_fcpim_profile_on(&bfad->bfa, tv.tv_sec);\r\nelse if (v_cmd == IOCMD_FCPIM_PROFILE_OFF)\r\niocmd->status = bfa_fcpim_profile_off(&bfad->bfa);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int\r\nbfad_iocmd_itnim_get_ioprofile(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_itnim_ioprofile_s *iocmd =\r\n(struct bfa_bsg_itnim_ioprofile_s *)cmd;\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nstruct bfa_fcs_itnim_s *itnim;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs,\r\niocmd->vf_id, iocmd->lpwwn);\r\nif (!fcs_port)\r\niocmd->status = BFA_STATUS_UNKNOWN_LWWN;\r\nelse {\r\nitnim = bfa_fcs_itnim_lookup(fcs_port, iocmd->rpwwn);\r\nif (itnim == NULL)\r\niocmd->status = BFA_STATUS_UNKNOWN_RWWN;\r\nelse\r\niocmd->status = bfa_itnim_get_ioprofile(\r\nbfa_fcs_itnim_get_halitn(itnim),\r\n&iocmd->ioprofile);\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fcport_get_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_fcport_stats_s *iocmd =\r\n(struct bfa_bsg_fcport_stats_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\nstruct bfa_cb_pending_q_s cb_qe;\r\ninit_completion(&fcomp.comp);\r\nbfa_pending_q_init(&cb_qe, (bfa_cb_cbfn_t)bfad_hcb_comp,\r\n&fcomp, &iocmd->stats);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fcport_get_stats(&bfad->bfa, &cb_qe);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK) {\r\nbfa_trc(bfad, iocmd->status);\r\ngoto out;\r\n}\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fcport_reset_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\nstruct bfa_cb_pending_q_s cb_qe;\r\ninit_completion(&fcomp.comp);\r\nbfa_pending_q_init(&cb_qe, (bfa_cb_cbfn_t)bfad_hcb_comp, &fcomp, NULL);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fcport_clear_stats(&bfad->bfa, &cb_qe);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK) {\r\nbfa_trc(bfad, iocmd->status);\r\ngoto out;\r\n}\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_boot_cfg(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_boot_s *iocmd = (struct bfa_bsg_boot_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_flash_update_part(BFA_FLASH(&bfad->bfa),\r\nBFA_FLASH_PART_BOOT, bfad->bfa.ioc.port_id,\r\n&iocmd->cfg, sizeof(struct bfa_boot_cfg_s), 0,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_boot_query(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_boot_s *iocmd = (struct bfa_bsg_boot_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_flash_read_part(BFA_FLASH(&bfad->bfa),\r\nBFA_FLASH_PART_BOOT, bfad->bfa.ioc.port_id,\r\n&iocmd->cfg, sizeof(struct bfa_boot_cfg_s), 0,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_preboot_query(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_preboot_s *iocmd = (struct bfa_bsg_preboot_s *)cmd;\r\nstruct bfi_iocfc_cfgrsp_s *cfgrsp = bfad->bfa.iocfc.cfgrsp;\r\nstruct bfa_boot_pbc_s *pbcfg = &iocmd->cfg;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\npbcfg->enable = cfgrsp->pbc_cfg.boot_enabled;\r\npbcfg->nbluns = cfgrsp->pbc_cfg.nbluns;\r\npbcfg->speed = cfgrsp->pbc_cfg.port_speed;\r\nmemcpy(pbcfg->pblun, cfgrsp->pbc_cfg.blun, sizeof(pbcfg->pblun));\r\niocmd->status = BFA_STATUS_OK;\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_ethboot_cfg(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_ethboot_s *iocmd = (struct bfa_bsg_ethboot_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_flash_update_part(BFA_FLASH(&bfad->bfa),\r\nBFA_FLASH_PART_PXECFG,\r\nbfad->bfa.ioc.port_id, &iocmd->cfg,\r\nsizeof(struct bfa_ethboot_cfg_s), 0,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_ethboot_query(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_ethboot_s *iocmd = (struct bfa_bsg_ethboot_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_flash_read_part(BFA_FLASH(&bfad->bfa),\r\nBFA_FLASH_PART_PXECFG,\r\nbfad->bfa.ioc.port_id, &iocmd->cfg,\r\nsizeof(struct bfa_ethboot_cfg_s), 0,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK)\r\ngoto out;\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_cfg_trunk(struct bfad_s *bfad, void *cmd, unsigned int v_cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\r\nstruct bfa_fcport_trunk_s *trunk = &fcport->trunk;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nif (bfa_fcport_is_dport(&bfad->bfa)) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn BFA_STATUS_DPORT_ERR;\r\n}\r\nif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) ||\r\n(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\r\niocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\r\nelse {\r\nif (v_cmd == IOCMD_TRUNK_ENABLE) {\r\ntrunk->attr.state = BFA_TRUNK_OFFLINE;\r\nbfa_fcport_disable(&bfad->bfa);\r\nfcport->cfg.trunked = BFA_TRUE;\r\n} else if (v_cmd == IOCMD_TRUNK_DISABLE) {\r\ntrunk->attr.state = BFA_TRUNK_DISABLED;\r\nbfa_fcport_disable(&bfad->bfa);\r\nfcport->cfg.trunked = BFA_FALSE;\r\n}\r\nif (!bfa_fcport_is_disabled(&bfad->bfa))\r\nbfa_fcport_enable(&bfad->bfa);\r\niocmd->status = BFA_STATUS_OK;\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_trunk_get_attr(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_trunk_attr_s *iocmd = (struct bfa_bsg_trunk_attr_s *)cmd;\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\r\nstruct bfa_fcport_trunk_s *trunk = &fcport->trunk;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) ||\r\n(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\r\niocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\r\nelse {\r\nmemcpy((void *)&iocmd->attr, (void *)&trunk->attr,\r\nsizeof(struct bfa_trunk_attr_s));\r\niocmd->attr.port_id = bfa_lps_get_base_pid(&bfad->bfa);\r\niocmd->status = BFA_STATUS_OK;\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_qos(struct bfad_s *bfad, void *cmd, unsigned int v_cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nif (bfa_ioc_get_type(&bfad->bfa.ioc) == BFA_IOC_TYPE_FC) {\r\nif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) &&\r\n(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\r\niocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\r\nelse {\r\nif (v_cmd == IOCMD_QOS_ENABLE)\r\nfcport->cfg.qos_enabled = BFA_TRUE;\r\nelse if (v_cmd == IOCMD_QOS_DISABLE) {\r\nfcport->cfg.qos_enabled = BFA_FALSE;\r\nfcport->cfg.qos_bw.high = BFA_QOS_BW_HIGH;\r\nfcport->cfg.qos_bw.med = BFA_QOS_BW_MED;\r\nfcport->cfg.qos_bw.low = BFA_QOS_BW_LOW;\r\n}\r\n}\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_qos_get_attr(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_qos_attr_s *iocmd = (struct bfa_bsg_qos_attr_s *)cmd;\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) &&\r\n(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\r\niocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\r\nelse {\r\niocmd->attr.state = fcport->qos_attr.state;\r\niocmd->attr.total_bb_cr =\r\nbe32_to_cpu(fcport->qos_attr.total_bb_cr);\r\niocmd->attr.qos_bw.high = fcport->cfg.qos_bw.high;\r\niocmd->attr.qos_bw.med = fcport->cfg.qos_bw.med;\r\niocmd->attr.qos_bw.low = fcport->cfg.qos_bw.low;\r\niocmd->attr.qos_bw_op = fcport->qos_attr.qos_bw_op;\r\niocmd->status = BFA_STATUS_OK;\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_qos_get_vc_attr(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_qos_vc_attr_s *iocmd =\r\n(struct bfa_bsg_qos_vc_attr_s *)cmd;\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\r\nstruct bfa_qos_vc_attr_s *bfa_vc_attr = &fcport->qos_vc_attr;\r\nunsigned long flags;\r\nu32 i = 0;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->attr.total_vc_count = be16_to_cpu(bfa_vc_attr->total_vc_count);\r\niocmd->attr.shared_credit = be16_to_cpu(bfa_vc_attr->shared_credit);\r\niocmd->attr.elp_opmode_flags =\r\nbe32_to_cpu(bfa_vc_attr->elp_opmode_flags);\r\nwhile (i < iocmd->attr.total_vc_count) {\r\niocmd->attr.vc_info[i].vc_credit =\r\nbfa_vc_attr->vc_info[i].vc_credit;\r\niocmd->attr.vc_info[i].borrow_credit =\r\nbfa_vc_attr->vc_info[i].borrow_credit;\r\niocmd->attr.vc_info[i].priority =\r\nbfa_vc_attr->vc_info[i].priority;\r\ni++;\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_qos_get_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_fcport_stats_s *iocmd =\r\n(struct bfa_bsg_fcport_stats_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\nstruct bfa_cb_pending_q_s cb_qe;\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\r\ninit_completion(&fcomp.comp);\r\nbfa_pending_q_init(&cb_qe, (bfa_cb_cbfn_t)bfad_hcb_comp,\r\n&fcomp, &iocmd->stats);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nWARN_ON(!bfa_ioc_get_fcmode(&bfad->bfa.ioc));\r\nif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) &&\r\n(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\r\niocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\r\nelse\r\niocmd->status = bfa_fcport_get_stats(&bfad->bfa, &cb_qe);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK) {\r\nbfa_trc(bfad, iocmd->status);\r\ngoto out;\r\n}\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_qos_reset_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags;\r\nstruct bfa_cb_pending_q_s cb_qe;\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(&bfad->bfa);\r\ninit_completion(&fcomp.comp);\r\nbfa_pending_q_init(&cb_qe, (bfa_cb_cbfn_t)bfad_hcb_comp,\r\n&fcomp, NULL);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nWARN_ON(!bfa_ioc_get_fcmode(&bfad->bfa.ioc));\r\nif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) &&\r\n(fcport->topology == BFA_PORT_TOPOLOGY_LOOP))\r\niocmd->status = BFA_STATUS_TOPOLOGY_LOOP;\r\nelse\r\niocmd->status = bfa_fcport_clear_stats(&bfad->bfa, &cb_qe);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status != BFA_STATUS_OK) {\r\nbfa_trc(bfad, iocmd->status);\r\ngoto out;\r\n}\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_vf_get_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_vf_stats_s *iocmd =\r\n(struct bfa_bsg_vf_stats_s *)cmd;\r\nstruct bfa_fcs_fabric_s *fcs_vf;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_vf = bfa_fcs_vf_lookup(&bfad->bfa_fcs, iocmd->vf_id);\r\nif (fcs_vf == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_VFID;\r\ngoto out;\r\n}\r\nmemcpy((void *)&iocmd->stats, (void *)&fcs_vf->stats,\r\nsizeof(struct bfa_vf_stats_s));\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_vf_clr_stats(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_vf_reset_stats_s *iocmd =\r\n(struct bfa_bsg_vf_reset_stats_s *)cmd;\r\nstruct bfa_fcs_fabric_s *fcs_vf;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_vf = bfa_fcs_vf_lookup(&bfad->bfa_fcs, iocmd->vf_id);\r\nif (fcs_vf == NULL) {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_UNKNOWN_VFID;\r\ngoto out;\r\n}\r\nmemset((void *)&fcs_vf->stats, 0, sizeof(struct bfa_vf_stats_s));\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\niocmd->status = BFA_STATUS_OK;\r\nout:\r\nreturn 0;\r\n}\r\nstatic void\r\nbfad_iocmd_lunmask_reset_lunscan_mode(struct bfad_s *bfad, int lunmask_cfg)\r\n{\r\nstruct bfad_im_port_s *pport_im = bfad->pport.im_port;\r\nstruct bfad_vport_s *vport = NULL;\r\nbfad_reset_sdev_bflags(pport_im, lunmask_cfg);\r\nlist_for_each_entry(vport, &bfad->vport_list, list_entry)\r\nbfad_reset_sdev_bflags(vport->drv_port.im_port, lunmask_cfg);\r\n}\r\nint\r\nbfad_iocmd_lunmask(struct bfad_s *bfad, void *pcmd, unsigned int v_cmd)\r\n{\r\nstruct bfa_bsg_gen_s *iocmd = (struct bfa_bsg_gen_s *)pcmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nif (v_cmd == IOCMD_FCPIM_LUNMASK_ENABLE) {\r\niocmd->status = bfa_fcpim_lunmask_update(&bfad->bfa, BFA_TRUE);\r\nif (iocmd->status == BFA_STATUS_OK)\r\nbfad_iocmd_lunmask_reset_lunscan_mode(bfad, BFA_TRUE);\r\n} else if (v_cmd == IOCMD_FCPIM_LUNMASK_DISABLE) {\r\niocmd->status = bfa_fcpim_lunmask_update(&bfad->bfa, BFA_FALSE);\r\nif (iocmd->status == BFA_STATUS_OK)\r\nbfad_iocmd_lunmask_reset_lunscan_mode(bfad, BFA_FALSE);\r\n} else if (v_cmd == IOCMD_FCPIM_LUNMASK_CLEAR)\r\niocmd->status = bfa_fcpim_lunmask_clear(&bfad->bfa);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fcpim_lunmask_query(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_fcpim_lunmask_query_s *iocmd =\r\n(struct bfa_bsg_fcpim_lunmask_query_s *)cmd;\r\nstruct bfa_lunmask_cfg_s *lun_mask = &iocmd->lun_mask;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fcpim_lunmask_query(&bfad->bfa, lun_mask);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fcpim_cfg_lunmask(struct bfad_s *bfad, void *cmd, unsigned int v_cmd)\r\n{\r\nstruct bfa_bsg_fcpim_lunmask_s *iocmd =\r\n(struct bfa_bsg_fcpim_lunmask_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nif (v_cmd == IOCMD_FCPIM_LUNMASK_ADD)\r\niocmd->status = bfa_fcpim_lunmask_add(&bfad->bfa, iocmd->vf_id,\r\n&iocmd->pwwn, iocmd->rpwwn, iocmd->lun);\r\nelse if (v_cmd == IOCMD_FCPIM_LUNMASK_DELETE)\r\niocmd->status = bfa_fcpim_lunmask_delete(&bfad->bfa,\r\niocmd->vf_id, &iocmd->pwwn,\r\niocmd->rpwwn, iocmd->lun);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fcpim_throttle_query(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_fcpim_throttle_s *iocmd =\r\n(struct bfa_bsg_fcpim_throttle_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fcpim_throttle_get(&bfad->bfa,\r\n(void *)&iocmd->throttle);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fcpim_throttle_set(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_fcpim_throttle_s *iocmd =\r\n(struct bfa_bsg_fcpim_throttle_s *)cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fcpim_throttle_set(&bfad->bfa,\r\niocmd->throttle.cfg_value);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_tfru_read(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_tfru_s *iocmd =\r\n(struct bfa_bsg_tfru_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags = 0;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_tfru_read(BFA_FRU(&bfad->bfa),\r\n&iocmd->data, iocmd->len, iocmd->offset,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status == BFA_STATUS_OK) {\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\n}\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_tfru_write(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_tfru_s *iocmd =\r\n(struct bfa_bsg_tfru_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags = 0;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_tfru_write(BFA_FRU(&bfad->bfa),\r\n&iocmd->data, iocmd->len, iocmd->offset,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status == BFA_STATUS_OK) {\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\n}\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fruvpd_read(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_fruvpd_s *iocmd =\r\n(struct bfa_bsg_fruvpd_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags = 0;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fruvpd_read(BFA_FRU(&bfad->bfa),\r\n&iocmd->data, iocmd->len, iocmd->offset,\r\nbfad_hcb_comp, &fcomp);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status == BFA_STATUS_OK) {\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\n}\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fruvpd_update(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_fruvpd_s *iocmd =\r\n(struct bfa_bsg_fruvpd_s *)cmd;\r\nstruct bfad_hal_comp fcomp;\r\nunsigned long flags = 0;\r\ninit_completion(&fcomp.comp);\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fruvpd_update(BFA_FRU(&bfad->bfa),\r\n&iocmd->data, iocmd->len, iocmd->offset,\r\nbfad_hcb_comp, &fcomp, iocmd->trfr_cmpl);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nif (iocmd->status == BFA_STATUS_OK) {\r\nwait_for_completion(&fcomp.comp);\r\niocmd->status = fcomp.status;\r\n}\r\nreturn 0;\r\n}\r\nint\r\nbfad_iocmd_fruvpd_get_max_size(struct bfad_s *bfad, void *cmd)\r\n{\r\nstruct bfa_bsg_fruvpd_max_size_s *iocmd =\r\n(struct bfa_bsg_fruvpd_max_size_s *)cmd;\r\nunsigned long flags = 0;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\niocmd->status = bfa_fruvpd_get_max_size(BFA_FRU(&bfad->bfa),\r\n&iocmd->max_size);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int\r\nbfad_iocmd_handler(struct bfad_s *bfad, unsigned int cmd, void *iocmd,\r\nunsigned int payload_len)\r\n{\r\nint rc = -EINVAL;\r\nswitch (cmd) {\r\ncase IOCMD_IOC_ENABLE:\r\nrc = bfad_iocmd_ioc_enable(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_IOC_DISABLE:\r\nrc = bfad_iocmd_ioc_disable(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_IOC_GET_INFO:\r\nrc = bfad_iocmd_ioc_get_info(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_IOC_GET_ATTR:\r\nrc = bfad_iocmd_ioc_get_attr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_IOC_GET_STATS:\r\nrc = bfad_iocmd_ioc_get_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_IOC_GET_FWSTATS:\r\nrc = bfad_iocmd_ioc_get_fwstats(bfad, iocmd, payload_len);\r\nbreak;\r\ncase IOCMD_IOC_RESET_STATS:\r\ncase IOCMD_IOC_RESET_FWSTATS:\r\nrc = bfad_iocmd_ioc_reset_stats(bfad, iocmd, cmd);\r\nbreak;\r\ncase IOCMD_IOC_SET_ADAPTER_NAME:\r\ncase IOCMD_IOC_SET_PORT_NAME:\r\nrc = bfad_iocmd_ioc_set_name(bfad, iocmd, cmd);\r\nbreak;\r\ncase IOCMD_IOCFC_GET_ATTR:\r\nrc = bfad_iocmd_iocfc_get_attr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_IOCFC_SET_INTR:\r\nrc = bfad_iocmd_iocfc_set_intr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_PORT_ENABLE:\r\nrc = bfad_iocmd_port_enable(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_PORT_DISABLE:\r\nrc = bfad_iocmd_port_disable(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_PORT_GET_ATTR:\r\nrc = bfad_iocmd_port_get_attr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_PORT_GET_STATS:\r\nrc = bfad_iocmd_port_get_stats(bfad, iocmd, payload_len);\r\nbreak;\r\ncase IOCMD_PORT_RESET_STATS:\r\nrc = bfad_iocmd_port_reset_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_PORT_CFG_TOPO:\r\ncase IOCMD_PORT_CFG_SPEED:\r\ncase IOCMD_PORT_CFG_ALPA:\r\ncase IOCMD_PORT_CLR_ALPA:\r\nrc = bfad_iocmd_set_port_cfg(bfad, iocmd, cmd);\r\nbreak;\r\ncase IOCMD_PORT_CFG_MAXFRSZ:\r\nrc = bfad_iocmd_port_cfg_maxfrsize(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_PORT_BBCR_ENABLE:\r\ncase IOCMD_PORT_BBCR_DISABLE:\r\nrc = bfad_iocmd_port_cfg_bbcr(bfad, cmd, iocmd);\r\nbreak;\r\ncase IOCMD_PORT_BBCR_GET_ATTR:\r\nrc = bfad_iocmd_port_get_bbcr_attr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_LPORT_GET_ATTR:\r\nrc = bfad_iocmd_lport_get_attr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_LPORT_GET_STATS:\r\nrc = bfad_iocmd_lport_get_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_LPORT_RESET_STATS:\r\nrc = bfad_iocmd_lport_reset_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_LPORT_GET_IOSTATS:\r\nrc = bfad_iocmd_lport_get_iostats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_LPORT_GET_RPORTS:\r\nrc = bfad_iocmd_lport_get_rports(bfad, iocmd, payload_len);\r\nbreak;\r\ncase IOCMD_RPORT_GET_ATTR:\r\nrc = bfad_iocmd_rport_get_attr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_RPORT_GET_ADDR:\r\nrc = bfad_iocmd_rport_get_addr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_RPORT_GET_STATS:\r\nrc = bfad_iocmd_rport_get_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_RPORT_RESET_STATS:\r\nrc = bfad_iocmd_rport_clr_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_RPORT_SET_SPEED:\r\nrc = bfad_iocmd_rport_set_speed(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_VPORT_GET_ATTR:\r\nrc = bfad_iocmd_vport_get_attr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_VPORT_GET_STATS:\r\nrc = bfad_iocmd_vport_get_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_VPORT_RESET_STATS:\r\nrc = bfad_iocmd_vport_clr_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FABRIC_GET_LPORTS:\r\nrc = bfad_iocmd_fabric_get_lports(bfad, iocmd, payload_len);\r\nbreak;\r\ncase IOCMD_RATELIM_ENABLE:\r\ncase IOCMD_RATELIM_DISABLE:\r\nrc = bfad_iocmd_ratelim(bfad, cmd, iocmd);\r\nbreak;\r\ncase IOCMD_RATELIM_DEF_SPEED:\r\nrc = bfad_iocmd_ratelim_speed(bfad, cmd, iocmd);\r\nbreak;\r\ncase IOCMD_FCPIM_FAILOVER:\r\nrc = bfad_iocmd_cfg_fcpim(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FCPIM_MODSTATS:\r\nrc = bfad_iocmd_fcpim_get_modstats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FCPIM_MODSTATSCLR:\r\nrc = bfad_iocmd_fcpim_clr_modstats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FCPIM_DEL_ITN_STATS:\r\nrc = bfad_iocmd_fcpim_get_del_itn_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_ITNIM_GET_ATTR:\r\nrc = bfad_iocmd_itnim_get_attr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_ITNIM_GET_IOSTATS:\r\nrc = bfad_iocmd_itnim_get_iostats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_ITNIM_RESET_STATS:\r\nrc = bfad_iocmd_itnim_reset_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_ITNIM_GET_ITNSTATS:\r\nrc = bfad_iocmd_itnim_get_itnstats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FCPORT_ENABLE:\r\nrc = bfad_iocmd_fcport_enable(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FCPORT_DISABLE:\r\nrc = bfad_iocmd_fcport_disable(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_IOC_PCIFN_CFG:\r\nrc = bfad_iocmd_ioc_get_pcifn_cfg(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_IOC_FW_SIG_INV:\r\nrc = bfad_iocmd_ioc_fw_sig_inv(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_PCIFN_CREATE:\r\nrc = bfad_iocmd_pcifn_create(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_PCIFN_DELETE:\r\nrc = bfad_iocmd_pcifn_delete(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_PCIFN_BW:\r\nrc = bfad_iocmd_pcifn_bw(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_ADAPTER_CFG_MODE:\r\nrc = bfad_iocmd_adapter_cfg_mode(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_PORT_CFG_MODE:\r\nrc = bfad_iocmd_port_cfg_mode(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FLASH_ENABLE_OPTROM:\r\ncase IOCMD_FLASH_DISABLE_OPTROM:\r\nrc = bfad_iocmd_ablk_optrom(bfad, cmd, iocmd);\r\nbreak;\r\ncase IOCMD_FAA_QUERY:\r\nrc = bfad_iocmd_faa_query(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_CEE_GET_ATTR:\r\nrc = bfad_iocmd_cee_attr(bfad, iocmd, payload_len);\r\nbreak;\r\ncase IOCMD_CEE_GET_STATS:\r\nrc = bfad_iocmd_cee_get_stats(bfad, iocmd, payload_len);\r\nbreak;\r\ncase IOCMD_CEE_RESET_STATS:\r\nrc = bfad_iocmd_cee_reset_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_SFP_MEDIA:\r\nrc = bfad_iocmd_sfp_media(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_SFP_SPEED:\r\nrc = bfad_iocmd_sfp_speed(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FLASH_GET_ATTR:\r\nrc = bfad_iocmd_flash_get_attr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FLASH_ERASE_PART:\r\nrc = bfad_iocmd_flash_erase_part(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FLASH_UPDATE_PART:\r\nrc = bfad_iocmd_flash_update_part(bfad, iocmd, payload_len);\r\nbreak;\r\ncase IOCMD_FLASH_READ_PART:\r\nrc = bfad_iocmd_flash_read_part(bfad, iocmd, payload_len);\r\nbreak;\r\ncase IOCMD_DIAG_TEMP:\r\nrc = bfad_iocmd_diag_temp(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_DIAG_MEMTEST:\r\nrc = bfad_iocmd_diag_memtest(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_DIAG_LOOPBACK:\r\nrc = bfad_iocmd_diag_loopback(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_DIAG_FWPING:\r\nrc = bfad_iocmd_diag_fwping(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_DIAG_QUEUETEST:\r\nrc = bfad_iocmd_diag_queuetest(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_DIAG_SFP:\r\nrc = bfad_iocmd_diag_sfp(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_DIAG_LED:\r\nrc = bfad_iocmd_diag_led(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_DIAG_BEACON_LPORT:\r\nrc = bfad_iocmd_diag_beacon_lport(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_DIAG_LB_STAT:\r\nrc = bfad_iocmd_diag_lb_stat(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_DIAG_DPORT_ENABLE:\r\nrc = bfad_iocmd_diag_dport_enable(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_DIAG_DPORT_DISABLE:\r\nrc = bfad_iocmd_diag_dport_disable(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_DIAG_DPORT_SHOW:\r\nrc = bfad_iocmd_diag_dport_show(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_DIAG_DPORT_START:\r\nrc = bfad_iocmd_diag_dport_start(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_PHY_GET_ATTR:\r\nrc = bfad_iocmd_phy_get_attr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_PHY_GET_STATS:\r\nrc = bfad_iocmd_phy_get_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_PHY_UPDATE_FW:\r\nrc = bfad_iocmd_phy_update(bfad, iocmd, payload_len);\r\nbreak;\r\ncase IOCMD_PHY_READ_FW:\r\nrc = bfad_iocmd_phy_read(bfad, iocmd, payload_len);\r\nbreak;\r\ncase IOCMD_VHBA_QUERY:\r\nrc = bfad_iocmd_vhba_query(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_DEBUG_PORTLOG:\r\nrc = bfad_iocmd_porglog_get(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_DEBUG_FW_CORE:\r\nrc = bfad_iocmd_debug_fw_core(bfad, iocmd, payload_len);\r\nbreak;\r\ncase IOCMD_DEBUG_FW_STATE_CLR:\r\ncase IOCMD_DEBUG_PORTLOG_CLR:\r\ncase IOCMD_DEBUG_START_DTRC:\r\ncase IOCMD_DEBUG_STOP_DTRC:\r\nrc = bfad_iocmd_debug_ctl(bfad, iocmd, cmd);\r\nbreak;\r\ncase IOCMD_DEBUG_PORTLOG_CTL:\r\nrc = bfad_iocmd_porglog_ctl(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FCPIM_PROFILE_ON:\r\ncase IOCMD_FCPIM_PROFILE_OFF:\r\nrc = bfad_iocmd_fcpim_cfg_profile(bfad, iocmd, cmd);\r\nbreak;\r\ncase IOCMD_ITNIM_GET_IOPROFILE:\r\nrc = bfad_iocmd_itnim_get_ioprofile(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FCPORT_GET_STATS:\r\nrc = bfad_iocmd_fcport_get_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FCPORT_RESET_STATS:\r\nrc = bfad_iocmd_fcport_reset_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_BOOT_CFG:\r\nrc = bfad_iocmd_boot_cfg(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_BOOT_QUERY:\r\nrc = bfad_iocmd_boot_query(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_PREBOOT_QUERY:\r\nrc = bfad_iocmd_preboot_query(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_ETHBOOT_CFG:\r\nrc = bfad_iocmd_ethboot_cfg(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_ETHBOOT_QUERY:\r\nrc = bfad_iocmd_ethboot_query(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_TRUNK_ENABLE:\r\ncase IOCMD_TRUNK_DISABLE:\r\nrc = bfad_iocmd_cfg_trunk(bfad, iocmd, cmd);\r\nbreak;\r\ncase IOCMD_TRUNK_GET_ATTR:\r\nrc = bfad_iocmd_trunk_get_attr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_QOS_ENABLE:\r\ncase IOCMD_QOS_DISABLE:\r\nrc = bfad_iocmd_qos(bfad, iocmd, cmd);\r\nbreak;\r\ncase IOCMD_QOS_GET_ATTR:\r\nrc = bfad_iocmd_qos_get_attr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_QOS_GET_VC_ATTR:\r\nrc = bfad_iocmd_qos_get_vc_attr(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_QOS_GET_STATS:\r\nrc = bfad_iocmd_qos_get_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_QOS_RESET_STATS:\r\nrc = bfad_iocmd_qos_reset_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_QOS_SET_BW:\r\nrc = bfad_iocmd_qos_set_bw(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_VF_GET_STATS:\r\nrc = bfad_iocmd_vf_get_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_VF_RESET_STATS:\r\nrc = bfad_iocmd_vf_clr_stats(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FCPIM_LUNMASK_ENABLE:\r\ncase IOCMD_FCPIM_LUNMASK_DISABLE:\r\ncase IOCMD_FCPIM_LUNMASK_CLEAR:\r\nrc = bfad_iocmd_lunmask(bfad, iocmd, cmd);\r\nbreak;\r\ncase IOCMD_FCPIM_LUNMASK_QUERY:\r\nrc = bfad_iocmd_fcpim_lunmask_query(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FCPIM_LUNMASK_ADD:\r\ncase IOCMD_FCPIM_LUNMASK_DELETE:\r\nrc = bfad_iocmd_fcpim_cfg_lunmask(bfad, iocmd, cmd);\r\nbreak;\r\ncase IOCMD_FCPIM_THROTTLE_QUERY:\r\nrc = bfad_iocmd_fcpim_throttle_query(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FCPIM_THROTTLE_SET:\r\nrc = bfad_iocmd_fcpim_throttle_set(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_TFRU_READ:\r\nrc = bfad_iocmd_tfru_read(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_TFRU_WRITE:\r\nrc = bfad_iocmd_tfru_write(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FRUVPD_READ:\r\nrc = bfad_iocmd_fruvpd_read(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FRUVPD_UPDATE:\r\nrc = bfad_iocmd_fruvpd_update(bfad, iocmd);\r\nbreak;\r\ncase IOCMD_FRUVPD_GET_MAX_SIZE:\r\nrc = bfad_iocmd_fruvpd_get_max_size(bfad, iocmd);\r\nbreak;\r\ndefault:\r\nrc = -EINVAL;\r\nbreak;\r\n}\r\nreturn rc;\r\n}\r\nstatic int\r\nbfad_im_bsg_vendor_request(struct bsg_job *job)\r\n{\r\nstruct fc_bsg_request *bsg_request = job->request;\r\nstruct fc_bsg_reply *bsg_reply = job->reply;\r\nuint32_t vendor_cmd = bsg_request->rqst_data.h_vendor.vendor_cmd[0];\r\nstruct bfad_im_port_s *im_port = shost_priv(fc_bsg_to_shost(job));\r\nstruct bfad_s *bfad = im_port->bfad;\r\nstruct request_queue *request_q = job->req->q;\r\nvoid *payload_kbuf;\r\nint rc = -EINVAL;\r\nblk_queue_max_segments(request_q, 256);\r\npayload_kbuf = kzalloc(job->request_payload.payload_len, GFP_KERNEL);\r\nif (!payload_kbuf) {\r\nrc = -ENOMEM;\r\ngoto out;\r\n}\r\nsg_copy_to_buffer(job->request_payload.sg_list,\r\njob->request_payload.sg_cnt, payload_kbuf,\r\njob->request_payload.payload_len);\r\nrc = bfad_iocmd_handler(bfad, vendor_cmd, payload_kbuf,\r\njob->request_payload.payload_len);\r\nif (rc != BFA_STATUS_OK)\r\ngoto error;\r\nsg_copy_from_buffer(job->reply_payload.sg_list,\r\njob->reply_payload.sg_cnt,\r\npayload_kbuf,\r\njob->reply_payload.payload_len);\r\nkfree(payload_kbuf);\r\njob->reply_len = job->reply_payload.payload_len;\r\nbsg_reply->reply_payload_rcv_len = job->reply_payload.payload_len;\r\nbsg_reply->result = rc;\r\nbsg_job_done(job, bsg_reply->result,\r\nbsg_reply->reply_payload_rcv_len);\r\nreturn rc;\r\nerror:\r\nkfree(payload_kbuf);\r\nout:\r\nbsg_reply->result = rc;\r\njob->reply_len = sizeof(uint32_t);\r\nbsg_reply->reply_payload_rcv_len = 0;\r\nreturn rc;\r\n}\r\nu64\r\nbfad_fcxp_get_req_sgaddr_cb(void *bfad_fcxp, int sgeid)\r\n{\r\nstruct bfad_fcxp *drv_fcxp = bfad_fcxp;\r\nstruct bfa_sge_s *sge;\r\nu64 addr;\r\nsge = drv_fcxp->req_sge + sgeid;\r\naddr = (u64)(size_t) sge->sg_addr;\r\nreturn addr;\r\n}\r\nu32\r\nbfad_fcxp_get_req_sglen_cb(void *bfad_fcxp, int sgeid)\r\n{\r\nstruct bfad_fcxp *drv_fcxp = bfad_fcxp;\r\nstruct bfa_sge_s *sge;\r\nsge = drv_fcxp->req_sge + sgeid;\r\nreturn sge->sg_len;\r\n}\r\nu64\r\nbfad_fcxp_get_rsp_sgaddr_cb(void *bfad_fcxp, int sgeid)\r\n{\r\nstruct bfad_fcxp *drv_fcxp = bfad_fcxp;\r\nstruct bfa_sge_s *sge;\r\nu64 addr;\r\nsge = drv_fcxp->rsp_sge + sgeid;\r\naddr = (u64)(size_t) sge->sg_addr;\r\nreturn addr;\r\n}\r\nu32\r\nbfad_fcxp_get_rsp_sglen_cb(void *bfad_fcxp, int sgeid)\r\n{\r\nstruct bfad_fcxp *drv_fcxp = bfad_fcxp;\r\nstruct bfa_sge_s *sge;\r\nsge = drv_fcxp->rsp_sge + sgeid;\r\nreturn sge->sg_len;\r\n}\r\nvoid\r\nbfad_send_fcpt_cb(void *bfad_fcxp, struct bfa_fcxp_s *fcxp, void *cbarg,\r\nbfa_status_t req_status, u32 rsp_len, u32 resid_len,\r\nstruct fchs_s *rsp_fchs)\r\n{\r\nstruct bfad_fcxp *drv_fcxp = bfad_fcxp;\r\ndrv_fcxp->req_status = req_status;\r\ndrv_fcxp->rsp_len = rsp_len;\r\ndrv_fcxp->bfa_fcxp = NULL;\r\ncomplete(&drv_fcxp->comp);\r\n}\r\nstruct bfad_buf_info *\r\nbfad_fcxp_map_sg(struct bfad_s *bfad, void *payload_kbuf,\r\nuint32_t payload_len, uint32_t *num_sgles)\r\n{\r\nstruct bfad_buf_info *buf_base, *buf_info;\r\nstruct bfa_sge_s *sg_table;\r\nint sge_num = 1;\r\nbuf_base = kzalloc((sizeof(struct bfad_buf_info) +\r\nsizeof(struct bfa_sge_s)) * sge_num, GFP_KERNEL);\r\nif (!buf_base)\r\nreturn NULL;\r\nsg_table = (struct bfa_sge_s *) (((uint8_t *)buf_base) +\r\n(sizeof(struct bfad_buf_info) * sge_num));\r\nbuf_info = buf_base;\r\nbuf_info->size = payload_len;\r\nbuf_info->virt = dma_zalloc_coherent(&bfad->pcidev->dev,\r\nbuf_info->size, &buf_info->phys,\r\nGFP_KERNEL);\r\nif (!buf_info->virt)\r\ngoto out_free_mem;\r\nmemcpy(buf_info->virt, payload_kbuf, buf_info->size);\r\nsg_table->sg_len = buf_info->size;\r\nsg_table->sg_addr = (void *)(size_t) buf_info->phys;\r\n*num_sgles = sge_num;\r\nreturn buf_base;\r\nout_free_mem:\r\nkfree(buf_base);\r\nreturn NULL;\r\n}\r\nvoid\r\nbfad_fcxp_free_mem(struct bfad_s *bfad, struct bfad_buf_info *buf_base,\r\nuint32_t num_sgles)\r\n{\r\nint i;\r\nstruct bfad_buf_info *buf_info = buf_base;\r\nif (buf_base) {\r\nfor (i = 0; i < num_sgles; buf_info++, i++) {\r\nif (buf_info->virt != NULL)\r\ndma_free_coherent(&bfad->pcidev->dev,\r\nbuf_info->size, buf_info->virt,\r\nbuf_info->phys);\r\n}\r\nkfree(buf_base);\r\n}\r\n}\r\nint\r\nbfad_fcxp_bsg_send(struct bsg_job *job, struct bfad_fcxp *drv_fcxp,\r\nbfa_bsg_fcpt_t *bsg_fcpt)\r\n{\r\nstruct bfa_fcxp_s *hal_fcxp;\r\nstruct bfad_s *bfad = drv_fcxp->port->bfad;\r\nunsigned long flags;\r\nuint8_t lp_tag;\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nhal_fcxp = bfa_fcxp_req_rsp_alloc(drv_fcxp, &bfad->bfa,\r\ndrv_fcxp->num_req_sgles,\r\ndrv_fcxp->num_rsp_sgles,\r\nbfad_fcxp_get_req_sgaddr_cb,\r\nbfad_fcxp_get_req_sglen_cb,\r\nbfad_fcxp_get_rsp_sgaddr_cb,\r\nbfad_fcxp_get_rsp_sglen_cb, BFA_TRUE);\r\nif (!hal_fcxp) {\r\nbfa_trc(bfad, 0);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn BFA_STATUS_ENOMEM;\r\n}\r\ndrv_fcxp->bfa_fcxp = hal_fcxp;\r\nlp_tag = bfa_lps_get_tag_from_pid(&bfad->bfa, bsg_fcpt->fchs.s_id);\r\nbfa_fcxp_send(hal_fcxp, drv_fcxp->bfa_rport, bsg_fcpt->vf_id, lp_tag,\r\nbsg_fcpt->cts, bsg_fcpt->cos,\r\njob->request_payload.payload_len,\r\n&bsg_fcpt->fchs, bfad_send_fcpt_cb, bfad,\r\njob->reply_payload.payload_len, bsg_fcpt->tsecs);\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreturn BFA_STATUS_OK;\r\n}\r\nint\r\nbfad_im_bsg_els_ct_request(struct bsg_job *job)\r\n{\r\nstruct bfa_bsg_data *bsg_data;\r\nstruct bfad_im_port_s *im_port = shost_priv(fc_bsg_to_shost(job));\r\nstruct bfad_s *bfad = im_port->bfad;\r\nbfa_bsg_fcpt_t *bsg_fcpt;\r\nstruct bfad_fcxp *drv_fcxp;\r\nstruct bfa_fcs_lport_s *fcs_port;\r\nstruct bfa_fcs_rport_s *fcs_rport;\r\nstruct fc_bsg_request *bsg_request = job->request;\r\nstruct fc_bsg_reply *bsg_reply = job->reply;\r\nuint32_t command_type = bsg_request->msgcode;\r\nunsigned long flags;\r\nstruct bfad_buf_info *rsp_buf_info;\r\nvoid *req_kbuf = NULL, *rsp_kbuf = NULL;\r\nint rc = -EINVAL;\r\njob->reply_len = sizeof(uint32_t);\r\nbsg_reply->reply_payload_rcv_len = 0;\r\nbsg_data = (struct bfa_bsg_data *) (((char *)bsg_request) +\r\nsizeof(struct fc_bsg_request));\r\nif (bsg_data == NULL)\r\ngoto out;\r\nbsg_fcpt = kzalloc(bsg_data->payload_len, GFP_KERNEL);\r\nif (!bsg_fcpt) {\r\nrc = -ENOMEM;\r\ngoto out;\r\n}\r\nif (copy_from_user((uint8_t *)bsg_fcpt,\r\n(void *)(unsigned long)bsg_data->payload,\r\nbsg_data->payload_len)) {\r\nkfree(bsg_fcpt);\r\nrc = -EIO;\r\ngoto out;\r\n}\r\ndrv_fcxp = kzalloc(sizeof(struct bfad_fcxp), GFP_KERNEL);\r\nif (drv_fcxp == NULL) {\r\nkfree(bsg_fcpt);\r\nrc = -ENOMEM;\r\ngoto out;\r\n}\r\nspin_lock_irqsave(&bfad->bfad_lock, flags);\r\nfcs_port = bfa_fcs_lookup_port(&bfad->bfa_fcs, bsg_fcpt->vf_id,\r\nbsg_fcpt->lpwwn);\r\nif (fcs_port == NULL) {\r\nbsg_fcpt->status = BFA_STATUS_UNKNOWN_LWWN;\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\ngoto out_free_mem;\r\n}\r\nif (!bfa_fcs_lport_is_online(fcs_port)) {\r\nbsg_fcpt->status = BFA_STATUS_PORT_OFFLINE;\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\ngoto out_free_mem;\r\n}\r\ndrv_fcxp->port = fcs_port->bfad_port;\r\nif (drv_fcxp->port->bfad == 0)\r\ndrv_fcxp->port->bfad = bfad;\r\nif (command_type == FC_BSG_HST_ELS_NOLOGIN ||\r\ncommand_type == FC_BSG_HST_CT) {\r\ndrv_fcxp->bfa_rport = NULL;\r\n} else if (command_type == FC_BSG_RPT_ELS ||\r\ncommand_type == FC_BSG_RPT_CT) {\r\nfcs_rport = bfa_fcs_lport_get_rport_by_pwwn(fcs_port,\r\nbsg_fcpt->dpwwn);\r\nif (fcs_rport == NULL) {\r\nbsg_fcpt->status = BFA_STATUS_UNKNOWN_RWWN;\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\ngoto out_free_mem;\r\n}\r\ndrv_fcxp->bfa_rport = fcs_rport->bfa_rport;\r\n} else {\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\ngoto out_free_mem;\r\n}\r\nspin_unlock_irqrestore(&bfad->bfad_lock, flags);\r\nreq_kbuf = kzalloc(job->request_payload.payload_len, GFP_KERNEL);\r\nif (!req_kbuf) {\r\nprintk(KERN_INFO "bfa %s: fcpt request buffer alloc failed\n",\r\nbfad->pci_name);\r\nrc = -ENOMEM;\r\ngoto out_free_mem;\r\n}\r\nrsp_kbuf = kzalloc(job->reply_payload.payload_len, GFP_KERNEL);\r\nif (!rsp_kbuf) {\r\nprintk(KERN_INFO "bfa %s: fcpt response buffer alloc failed\n",\r\nbfad->pci_name);\r\nrc = -ENOMEM;\r\ngoto out_free_mem;\r\n}\r\nsg_copy_to_buffer(job->request_payload.sg_list,\r\njob->request_payload.sg_cnt, req_kbuf,\r\njob->request_payload.payload_len);\r\ndrv_fcxp->reqbuf_info = bfad_fcxp_map_sg(bfad, req_kbuf,\r\njob->request_payload.payload_len,\r\n&drv_fcxp->num_req_sgles);\r\nif (!drv_fcxp->reqbuf_info) {\r\nprintk(KERN_INFO "bfa %s: fcpt request fcxp_map_sg failed\n",\r\nbfad->pci_name);\r\nrc = -ENOMEM;\r\ngoto out_free_mem;\r\n}\r\ndrv_fcxp->req_sge = (struct bfa_sge_s *)\r\n(((uint8_t *)drv_fcxp->reqbuf_info) +\r\n(sizeof(struct bfad_buf_info) *\r\ndrv_fcxp->num_req_sgles));\r\ndrv_fcxp->rspbuf_info = bfad_fcxp_map_sg(bfad, rsp_kbuf,\r\njob->reply_payload.payload_len,\r\n&drv_fcxp->num_rsp_sgles);\r\nif (!drv_fcxp->rspbuf_info) {\r\nprintk(KERN_INFO "bfa %s: fcpt response fcxp_map_sg failed\n",\r\nbfad->pci_name);\r\nrc = -ENOMEM;\r\ngoto out_free_mem;\r\n}\r\nrsp_buf_info = (struct bfad_buf_info *)drv_fcxp->rspbuf_info;\r\ndrv_fcxp->rsp_sge = (struct bfa_sge_s *)\r\n(((uint8_t *)drv_fcxp->rspbuf_info) +\r\n(sizeof(struct bfad_buf_info) *\r\ndrv_fcxp->num_rsp_sgles));\r\ninit_completion(&drv_fcxp->comp);\r\nrc = bfad_fcxp_bsg_send(job, drv_fcxp, bsg_fcpt);\r\nif (rc == BFA_STATUS_OK) {\r\nwait_for_completion(&drv_fcxp->comp);\r\nbsg_fcpt->status = drv_fcxp->req_status;\r\n} else {\r\nbsg_fcpt->status = rc;\r\ngoto out_free_mem;\r\n}\r\nif (drv_fcxp->req_status == BFA_STATUS_OK) {\r\njob->reply_len = drv_fcxp->rsp_len;\r\nbsg_reply->reply_payload_rcv_len = drv_fcxp->rsp_len;\r\nbsg_reply->reply_data.ctels_reply.status = FC_CTELS_STATUS_OK;\r\n} else {\r\nbsg_reply->reply_payload_rcv_len =\r\nsizeof(struct fc_bsg_ctels_reply);\r\njob->reply_len = sizeof(uint32_t);\r\nbsg_reply->reply_data.ctels_reply.status =\r\nFC_CTELS_STATUS_REJECT;\r\n}\r\nsg_copy_from_buffer(job->reply_payload.sg_list,\r\njob->reply_payload.sg_cnt,\r\n(uint8_t *)rsp_buf_info->virt,\r\njob->reply_payload.payload_len);\r\nout_free_mem:\r\nbfad_fcxp_free_mem(bfad, drv_fcxp->rspbuf_info,\r\ndrv_fcxp->num_rsp_sgles);\r\nbfad_fcxp_free_mem(bfad, drv_fcxp->reqbuf_info,\r\ndrv_fcxp->num_req_sgles);\r\nkfree(req_kbuf);\r\nkfree(rsp_kbuf);\r\nif (copy_to_user((void *)(unsigned long)bsg_data->payload,\r\n(void *)bsg_fcpt, bsg_data->payload_len))\r\nrc = -EIO;\r\nkfree(bsg_fcpt);\r\nkfree(drv_fcxp);\r\nout:\r\nbsg_reply->result = rc;\r\nif (rc == BFA_STATUS_OK)\r\nbsg_job_done(job, bsg_reply->result,\r\nbsg_reply->reply_payload_rcv_len);\r\nreturn rc;\r\n}\r\nint\r\nbfad_im_bsg_request(struct bsg_job *job)\r\n{\r\nstruct fc_bsg_request *bsg_request = job->request;\r\nstruct fc_bsg_reply *bsg_reply = job->reply;\r\nuint32_t rc = BFA_STATUS_OK;\r\nswitch (bsg_request->msgcode) {\r\ncase FC_BSG_HST_VENDOR:\r\nrc = bfad_im_bsg_vendor_request(job);\r\nbreak;\r\ncase FC_BSG_HST_ELS_NOLOGIN:\r\ncase FC_BSG_RPT_ELS:\r\ncase FC_BSG_HST_CT:\r\ncase FC_BSG_RPT_CT:\r\nrc = bfad_im_bsg_els_ct_request(job);\r\nbreak;\r\ndefault:\r\nbsg_reply->result = rc = -EINVAL;\r\nbsg_reply->reply_payload_rcv_len = 0;\r\nbreak;\r\n}\r\nreturn rc;\r\n}\r\nint\r\nbfad_im_bsg_timeout(struct bsg_job *job)\r\n{\r\nreturn -EAGAIN;\r\n}

static int visstrim_camera_power(struct device *dev, int on)\r\n{\r\ngpio_set_value(TVP5150_PWDN, on);\r\nreturn 0;\r\n}\r\nstatic int visstrim_camera_reset(struct device *dev)\r\n{\r\ngpio_set_value(TVP5150_RSTN, 0);\r\nndelay(500);\r\ngpio_set_value(TVP5150_RSTN, 1);\r\nreturn 0;\r\n}\r\nstatic void __init visstrim_analog_camera_init(void)\r\n{\r\nstruct platform_device *pdev;\r\nint dma;\r\ngpio_set_value(TVP5150_PWDN, 1);\r\nndelay(1);\r\ngpio_set_value(TVP5150_RSTN, 0);\r\nndelay(500);\r\ngpio_set_value(TVP5150_RSTN, 1);\r\nndelay(200000);\r\npdev = imx27_add_mx2_camera(&visstrim_camera);\r\nif (IS_ERR(pdev))\r\nreturn;\r\ndma = dma_declare_coherent_memory(&pdev->dev,\r\nmx2_camera_base, mx2_camera_base,\r\nMX2_CAMERA_BUF_SIZE,\r\nDMA_MEMORY_MAP | DMA_MEMORY_EXCLUSIVE);\r\nif (!(dma & DMA_MEMORY_MAP))\r\nreturn;\r\n}\r\nstatic void __init visstrim_reserve(void)\r\n{\r\nmx2_camera_base = arm_memblock_steal(3 * MX2_CAMERA_BUF_SIZE,\r\nMX2_CAMERA_BUF_SIZE);\r\n}\r\nstatic int visstrim_m10_sdhc1_init(struct device *dev,\r\nirq_handler_t detect_irq, void *data)\r\n{\r\nint ret;\r\nret = request_irq(gpio_to_irq(SDHC1_IRQ_GPIO), detect_irq,\r\nIRQF_TRIGGER_FALLING, "mmc-detect", data);\r\nreturn ret;\r\n}\r\nstatic void visstrim_m10_sdhc1_exit(struct device *dev, void *data)\r\n{\r\nfree_irq(gpio_to_irq(SDHC1_IRQ_GPIO), data);\r\n}\r\nstatic int otg_phy_init(struct platform_device *pdev)\r\n{\r\nreturn mx27_initialize_usb_hw(pdev->id, MXC_EHCI_POWER_PINS_ENABLED);\r\n}\r\nstatic void __init visstrim_coda_init(void)\r\n{\r\nstruct platform_device *pdev;\r\nint dma;\r\npdev = imx27_add_coda();\r\ndma = dma_declare_coherent_memory(&pdev->dev,\r\nmx2_camera_base + MX2_CAMERA_BUF_SIZE,\r\nmx2_camera_base + MX2_CAMERA_BUF_SIZE,\r\nMX2_CAMERA_BUF_SIZE,\r\nDMA_MEMORY_MAP | DMA_MEMORY_EXCLUSIVE);\r\nif (!(dma & DMA_MEMORY_MAP))\r\nreturn;\r\n}\r\nstatic void __init visstrim_deinterlace_init(void)\r\n{\r\nint ret = -ENOMEM;\r\nstruct platform_device *pdev = &visstrim_deinterlace;\r\nint dma;\r\nret = platform_device_register(pdev);\r\ndma = dma_declare_coherent_memory(&pdev->dev,\r\nmx2_camera_base + 2 * MX2_CAMERA_BUF_SIZE,\r\nmx2_camera_base + 2 * MX2_CAMERA_BUF_SIZE,\r\nMX2_CAMERA_BUF_SIZE,\r\nDMA_MEMORY_MAP | DMA_MEMORY_EXCLUSIVE);\r\nif (!(dma & DMA_MEMORY_MAP))\r\nreturn;\r\n}\r\nstatic void __init visstrim_emmaprp_init(void)\r\n{\r\nstruct platform_device *pdev;\r\nint dma;\r\npdev = imx27_add_mx2_emmaprp();\r\nif (IS_ERR(pdev))\r\nreturn;\r\ndma = dma_declare_coherent_memory(&pdev->dev,\r\nmx2_camera_base, mx2_camera_base,\r\nMX2_CAMERA_BUF_SIZE,\r\nDMA_MEMORY_MAP | DMA_MEMORY_EXCLUSIVE);\r\nif (!(dma & DMA_MEMORY_MAP))\r\npr_err("Failed to declare memory for emmaprp\n");\r\n}\r\nstatic void __init visstrim_m10_revision(void)\r\n{\r\nint exp_version = 0;\r\nint mo_version = 0;\r\nint ret;\r\nret = gpio_request_array(visstrim_m10_version_gpios,\r\nARRAY_SIZE(visstrim_m10_version_gpios));\r\nif (ret) {\r\npr_err("Failed to request version gpios");\r\nreturn;\r\n}\r\nexp_version |= !gpio_get_value(EXPBOARD_BIT2) << 2;\r\nexp_version |= !gpio_get_value(EXPBOARD_BIT1) << 1;\r\nexp_version |= !gpio_get_value(EXPBOARD_BIT0);\r\nmo_version |= !gpio_get_value(MOTHERBOARD_BIT2) << 2;\r\nmo_version |= !gpio_get_value(MOTHERBOARD_BIT1) << 1;\r\nmo_version |= !gpio_get_value(MOTHERBOARD_BIT0);\r\nsystem_rev = 0x27000;\r\nsystem_rev |= (mo_version << MOTHERBOARD_SHIFT);\r\nsystem_rev |= (exp_version << EXPBOARD_SHIFT);\r\n}\r\nstatic void __init visstrim_m10_board_init(void)\r\n{\r\nint ret;\r\nimx27_soc_init();\r\nvisstrim_m10_revision();\r\nret = mxc_gpio_setup_multiple_pins(visstrim_m10_pins,\r\nARRAY_SIZE(visstrim_m10_pins), "VISSTRIM_M10");\r\nif (ret)\r\npr_err("Failed to setup pins (%d)\n", ret);\r\nimx27_add_imx_ssi(0, &visstrim_m10_ssi_pdata);\r\nimx27_add_imx_uart0(&uart_pdata);\r\nimx27_add_imx_i2c(0, &visstrim_m10_i2c_data);\r\nimx27_add_imx_i2c(1, &visstrim_m10_i2c_data);\r\ni2c_register_board_info(0, visstrim_m10_i2c_devices,\r\nARRAY_SIZE(visstrim_m10_i2c_devices));\r\nimx27_add_mxc_mmc(0, &visstrim_m10_sdhc_pdata);\r\nimx27_add_mxc_ehci_otg(&visstrim_m10_usbotg_pdata);\r\nimx27_add_fec(NULL);\r\nplatform_add_devices(platform_devices, ARRAY_SIZE(platform_devices));\r\n}\r\nstatic void __init visstrim_m10_late_init(void)\r\n{\r\nint mo_version, ret;\r\nret = gpio_request_array(visstrim_m10_gpios,\r\nARRAY_SIZE(visstrim_m10_gpios));\r\nif (ret)\r\npr_err("Failed to request gpios (%d)\n", ret);\r\nimx_add_gpio_keys(&visstrim_gpio_keys_platform_data);\r\nimx_add_platform_device("mx27vis", 0, NULL, 0, &snd_mx27vis_pdata,\r\nsizeof(snd_mx27vis_pdata));\r\nplatform_device_register_resndata(NULL, "soc-camera-pdrv", 0, NULL, 0,\r\n&iclink_tvp5150, sizeof(iclink_tvp5150));\r\ngpio_led_register_device(0, &visstrim_m10_led_data);\r\nmo_version = (system_rev >> MOTHERBOARD_SHIFT) & VERSION_MASK;\r\nif (mo_version & 0x1) {\r\nvisstrim_emmaprp_init();\r\ngpio_set_value(TVP5150_PWDN, 1);\r\nndelay(1);\r\ngpio_set_value(TVP5150_RSTN, 0);\r\n} else {\r\nvisstrim_deinterlace_init();\r\nvisstrim_analog_camera_init();\r\n}\r\nvisstrim_coda_init();\r\n}\r\nstatic void __init visstrim_m10_timer_init(void)\r\n{\r\nmx27_clocks_init((unsigned long)25000000);\r\n}

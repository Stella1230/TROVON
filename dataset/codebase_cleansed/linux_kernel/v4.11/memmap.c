static phys_addr_t __init __efi_memmap_alloc_early(unsigned long size)\r\n{\r\nreturn memblock_alloc(size, 0);\r\n}\r\nstatic phys_addr_t __init __efi_memmap_alloc_late(unsigned long size)\r\n{\r\nunsigned int order = get_order(size);\r\nstruct page *p = alloc_pages(GFP_KERNEL, order);\r\nif (!p)\r\nreturn 0;\r\nreturn PFN_PHYS(page_to_pfn(p));\r\n}\r\nphys_addr_t __init efi_memmap_alloc(unsigned int num_entries)\r\n{\r\nunsigned long size = num_entries * efi.memmap.desc_size;\r\nif (slab_is_available())\r\nreturn __efi_memmap_alloc_late(size);\r\nreturn __efi_memmap_alloc_early(size);\r\n}\r\nstatic int __init\r\n__efi_memmap_init(struct efi_memory_map_data *data, bool late)\r\n{\r\nstruct efi_memory_map map;\r\nphys_addr_t phys_map;\r\nif (efi_enabled(EFI_PARAVIRT))\r\nreturn 0;\r\nphys_map = data->phys_map;\r\nif (late)\r\nmap.map = memremap(phys_map, data->size, MEMREMAP_WB);\r\nelse\r\nmap.map = early_memremap(phys_map, data->size);\r\nif (!map.map) {\r\npr_err("Could not map the memory map!\n");\r\nreturn -ENOMEM;\r\n}\r\nmap.phys_map = data->phys_map;\r\nmap.nr_map = data->size / data->desc_size;\r\nmap.map_end = map.map + data->size;\r\nmap.desc_version = data->desc_version;\r\nmap.desc_size = data->desc_size;\r\nmap.late = late;\r\nset_bit(EFI_MEMMAP, &efi.flags);\r\nefi.memmap = map;\r\nreturn 0;\r\n}\r\nint __init efi_memmap_init_early(struct efi_memory_map_data *data)\r\n{\r\nWARN_ON(efi.memmap.late);\r\nreturn __efi_memmap_init(data, false);\r\n}\r\nvoid __init efi_memmap_unmap(void)\r\n{\r\nif (!efi.memmap.late) {\r\nunsigned long size;\r\nsize = efi.memmap.desc_size * efi.memmap.nr_map;\r\nearly_memunmap(efi.memmap.map, size);\r\n} else {\r\nmemunmap(efi.memmap.map);\r\n}\r\nefi.memmap.map = NULL;\r\nclear_bit(EFI_MEMMAP, &efi.flags);\r\n}\r\nint __init efi_memmap_init_late(phys_addr_t addr, unsigned long size)\r\n{\r\nstruct efi_memory_map_data data = {\r\n.phys_map = addr,\r\n.size = size,\r\n};\r\nWARN_ON(efi.memmap.map);\r\nWARN_ON(efi.memmap.late);\r\ndata.desc_version = efi.memmap.desc_version;\r\ndata.desc_size = efi.memmap.desc_size;\r\nreturn __efi_memmap_init(&data, true);\r\n}\r\nint __init efi_memmap_install(phys_addr_t addr, unsigned int nr_map)\r\n{\r\nstruct efi_memory_map_data data;\r\nefi_memmap_unmap();\r\ndata.phys_map = addr;\r\ndata.size = efi.memmap.desc_size * nr_map;\r\ndata.desc_version = efi.memmap.desc_version;\r\ndata.desc_size = efi.memmap.desc_size;\r\nreturn __efi_memmap_init(&data, efi.memmap.late);\r\n}\r\nint __init efi_memmap_split_count(efi_memory_desc_t *md, struct range *range)\r\n{\r\nu64 m_start, m_end;\r\nu64 start, end;\r\nint count = 0;\r\nstart = md->phys_addr;\r\nend = start + (md->num_pages << EFI_PAGE_SHIFT) - 1;\r\nm_start = range->start;\r\nm_end = range->end;\r\nif (m_start <= start) {\r\nif (start < m_end && m_end < end)\r\ncount++;\r\n}\r\nif (start < m_start && m_start < end) {\r\nif (m_end < end)\r\ncount += 2;\r\nif (end <= m_end)\r\ncount++;\r\n}\r\nreturn count;\r\n}\r\nvoid __init efi_memmap_insert(struct efi_memory_map *old_memmap, void *buf,\r\nstruct efi_mem_range *mem)\r\n{\r\nu64 m_start, m_end, m_attr;\r\nefi_memory_desc_t *md;\r\nu64 start, end;\r\nvoid *old, *new;\r\nm_start = mem->range.start;\r\nm_end = mem->range.end;\r\nm_attr = mem->attribute;\r\nif (!IS_ALIGNED(m_start, EFI_PAGE_SIZE) ||\r\n!IS_ALIGNED(m_end + 1, EFI_PAGE_SIZE)) {\r\nWARN_ON(1);\r\nreturn;\r\n}\r\nfor (old = old_memmap->map, new = buf;\r\nold < old_memmap->map_end;\r\nold += old_memmap->desc_size, new += old_memmap->desc_size) {\r\nmemcpy(new, old, old_memmap->desc_size);\r\nmd = new;\r\nstart = md->phys_addr;\r\nend = md->phys_addr + (md->num_pages << EFI_PAGE_SHIFT) - 1;\r\nif (m_start <= start && end <= m_end)\r\nmd->attribute |= m_attr;\r\nif (m_start <= start &&\r\n(start < m_end && m_end < end)) {\r\nmd->attribute |= m_attr;\r\nmd->num_pages = (m_end - md->phys_addr + 1) >>\r\nEFI_PAGE_SHIFT;\r\nnew += old_memmap->desc_size;\r\nmemcpy(new, old, old_memmap->desc_size);\r\nmd = new;\r\nmd->phys_addr = m_end + 1;\r\nmd->num_pages = (end - md->phys_addr + 1) >>\r\nEFI_PAGE_SHIFT;\r\n}\r\nif ((start < m_start && m_start < end) && m_end < end) {\r\nmd->num_pages = (m_start - md->phys_addr) >>\r\nEFI_PAGE_SHIFT;\r\nnew += old_memmap->desc_size;\r\nmemcpy(new, old, old_memmap->desc_size);\r\nmd = new;\r\nmd->attribute |= m_attr;\r\nmd->phys_addr = m_start;\r\nmd->num_pages = (m_end - m_start + 1) >>\r\nEFI_PAGE_SHIFT;\r\nnew += old_memmap->desc_size;\r\nmemcpy(new, old, old_memmap->desc_size);\r\nmd = new;\r\nmd->phys_addr = m_end + 1;\r\nmd->num_pages = (end - m_end) >>\r\nEFI_PAGE_SHIFT;\r\n}\r\nif ((start < m_start && m_start < end) &&\r\n(end <= m_end)) {\r\nmd->num_pages = (m_start - md->phys_addr) >>\r\nEFI_PAGE_SHIFT;\r\nnew += old_memmap->desc_size;\r\nmemcpy(new, old, old_memmap->desc_size);\r\nmd = new;\r\nmd->phys_addr = m_start;\r\nmd->num_pages = (end - md->phys_addr + 1) >>\r\nEFI_PAGE_SHIFT;\r\nmd->attribute |= m_attr;\r\n}\r\n}\r\n}

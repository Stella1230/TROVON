void mdp5_set_irqmask(struct mdp_kms *mdp_kms, uint32_t irqmask,\r\nuint32_t old_irqmask)\r\n{\r\nmdp5_write(to_mdp5_kms(mdp_kms), REG_MDP5_INTR_CLEAR,\r\nirqmask ^ (irqmask & old_irqmask));\r\nmdp5_write(to_mdp5_kms(mdp_kms), REG_MDP5_INTR_EN, irqmask);\r\n}\r\nstatic void mdp5_irq_error_handler(struct mdp_irq *irq, uint32_t irqstatus)\r\n{\r\nstruct mdp5_kms *mdp5_kms = container_of(irq, struct mdp5_kms, error_handler);\r\nstatic DEFINE_RATELIMIT_STATE(rs, 5*HZ, 1);\r\nextern bool dumpstate;\r\nDRM_ERROR_RATELIMITED("errors: %08x\n", irqstatus);\r\nif (dumpstate && __ratelimit(&rs)) {\r\nstruct drm_printer p = drm_info_printer(mdp5_kms->dev->dev);\r\ndrm_state_dump(mdp5_kms->dev, &p);\r\nif (mdp5_kms->smp)\r\nmdp5_smp_dump(mdp5_kms->smp, &p);\r\n}\r\n}\r\nvoid mdp5_irq_preinstall(struct msm_kms *kms)\r\n{\r\nstruct mdp5_kms *mdp5_kms = to_mdp5_kms(to_mdp_kms(kms));\r\nmdp5_enable(mdp5_kms);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTR_CLEAR, 0xffffffff);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTR_EN, 0x00000000);\r\nmdp5_disable(mdp5_kms);\r\n}\r\nint mdp5_irq_postinstall(struct msm_kms *kms)\r\n{\r\nstruct mdp_kms *mdp_kms = to_mdp_kms(kms);\r\nstruct mdp5_kms *mdp5_kms = to_mdp5_kms(mdp_kms);\r\nstruct mdp_irq *error_handler = &mdp5_kms->error_handler;\r\nerror_handler->irq = mdp5_irq_error_handler;\r\nerror_handler->irqmask = MDP5_IRQ_INTF0_UNDER_RUN |\r\nMDP5_IRQ_INTF1_UNDER_RUN |\r\nMDP5_IRQ_INTF2_UNDER_RUN |\r\nMDP5_IRQ_INTF3_UNDER_RUN;\r\nmdp5_enable(mdp5_kms);\r\nmdp_irq_register(mdp_kms, error_handler);\r\nmdp5_disable(mdp5_kms);\r\nreturn 0;\r\n}\r\nvoid mdp5_irq_uninstall(struct msm_kms *kms)\r\n{\r\nstruct mdp5_kms *mdp5_kms = to_mdp5_kms(to_mdp_kms(kms));\r\nmdp5_enable(mdp5_kms);\r\nmdp5_write(mdp5_kms, REG_MDP5_INTR_EN, 0x00000000);\r\nmdp5_disable(mdp5_kms);\r\n}\r\nirqreturn_t mdp5_irq(struct msm_kms *kms)\r\n{\r\nstruct mdp_kms *mdp_kms = to_mdp_kms(kms);\r\nstruct mdp5_kms *mdp5_kms = to_mdp5_kms(mdp_kms);\r\nstruct drm_device *dev = mdp5_kms->dev;\r\nstruct msm_drm_private *priv = dev->dev_private;\r\nunsigned int id;\r\nuint32_t status, enable;\r\nenable = mdp5_read(mdp5_kms, REG_MDP5_INTR_EN);\r\nstatus = mdp5_read(mdp5_kms, REG_MDP5_INTR_STATUS) & enable;\r\nmdp5_write(mdp5_kms, REG_MDP5_INTR_CLEAR, status);\r\nVERB("status=%08x", status);\r\nmdp_dispatch_irqs(mdp_kms, status);\r\nfor (id = 0; id < priv->num_crtcs; id++)\r\nif (status & mdp5_crtc_vblank(priv->crtcs[id]))\r\ndrm_handle_vblank(dev, id);\r\nreturn IRQ_HANDLED;\r\n}\r\nint mdp5_enable_vblank(struct msm_kms *kms, struct drm_crtc *crtc)\r\n{\r\nstruct mdp5_kms *mdp5_kms = to_mdp5_kms(to_mdp_kms(kms));\r\nmdp5_enable(mdp5_kms);\r\nmdp_update_vblank_mask(to_mdp_kms(kms),\r\nmdp5_crtc_vblank(crtc), true);\r\nmdp5_disable(mdp5_kms);\r\nreturn 0;\r\n}\r\nvoid mdp5_disable_vblank(struct msm_kms *kms, struct drm_crtc *crtc)\r\n{\r\nstruct mdp5_kms *mdp5_kms = to_mdp5_kms(to_mdp_kms(kms));\r\nmdp5_enable(mdp5_kms);\r\nmdp_update_vblank_mask(to_mdp_kms(kms),\r\nmdp5_crtc_vblank(crtc), false);\r\nmdp5_disable(mdp5_kms);\r\n}

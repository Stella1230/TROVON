int rxe_av_chk_attr(struct rxe_dev *rxe, struct ib_ah_attr *attr)\r\n{\r\nstruct rxe_port *port;\r\nif (attr->port_num != 1) {\r\npr_info("invalid port_num = %d\n", attr->port_num);\r\nreturn -EINVAL;\r\n}\r\nport = &rxe->port;\r\nif (attr->ah_flags & IB_AH_GRH) {\r\nif (attr->grh.sgid_index > port->attr.gid_tbl_len) {\r\npr_info("invalid sgid index = %d\n",\r\nattr->grh.sgid_index);\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint rxe_av_from_attr(struct rxe_dev *rxe, u8 port_num,\r\nstruct rxe_av *av, struct ib_ah_attr *attr)\r\n{\r\nmemset(av, 0, sizeof(*av));\r\nmemcpy(&av->grh, &attr->grh, sizeof(attr->grh));\r\nav->port_num = port_num;\r\nreturn 0;\r\n}\r\nint rxe_av_to_attr(struct rxe_dev *rxe, struct rxe_av *av,\r\nstruct ib_ah_attr *attr)\r\n{\r\nmemcpy(&attr->grh, &av->grh, sizeof(av->grh));\r\nattr->port_num = av->port_num;\r\nreturn 0;\r\n}\r\nint rxe_av_fill_ip_info(struct rxe_dev *rxe,\r\nstruct rxe_av *av,\r\nstruct ib_ah_attr *attr,\r\nstruct ib_gid_attr *sgid_attr,\r\nunion ib_gid *sgid)\r\n{\r\nrdma_gid2ip(&av->sgid_addr._sockaddr, sgid);\r\nrdma_gid2ip(&av->dgid_addr._sockaddr, &attr->grh.dgid);\r\nav->network_type = ib_gid_to_network_type(sgid_attr->gid_type, sgid);\r\nreturn 0;\r\n}\r\nstruct rxe_av *rxe_get_av(struct rxe_pkt_info *pkt)\r\n{\r\nif (!pkt || !pkt->qp)\r\nreturn NULL;\r\nif (qp_type(pkt->qp) == IB_QPT_RC || qp_type(pkt->qp) == IB_QPT_UC)\r\nreturn &pkt->qp->pri_av;\r\nreturn (pkt->wqe) ? &pkt->wqe->av : NULL;\r\n}

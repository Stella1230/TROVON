static struct mdp4_kms *get_kms(struct drm_crtc *crtc)\r\n{\r\nstruct msm_drm_private *priv = crtc->dev->dev_private;\r\nreturn to_mdp4_kms(to_mdp_kms(priv->kms));\r\n}\r\nstatic void request_pending(struct drm_crtc *crtc, uint32_t pending)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\natomic_or(pending, &mdp4_crtc->pending);\r\nmdp_irq_register(&get_kms(crtc)->base, &mdp4_crtc->vblank);\r\n}\r\nstatic void crtc_flush(struct drm_crtc *crtc)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nstruct mdp4_kms *mdp4_kms = get_kms(crtc);\r\nstruct drm_plane *plane;\r\nuint32_t flush = 0;\r\ndrm_atomic_crtc_for_each_plane(plane, crtc) {\r\nenum mdp4_pipe pipe_id = mdp4_plane_pipe(plane);\r\nflush |= pipe2flush(pipe_id);\r\n}\r\nflush |= ovlp2flush(mdp4_crtc->ovlp);\r\nDBG("%s: flush=%08x", mdp4_crtc->name, flush);\r\nmdp4_crtc->flushed_mask = flush;\r\nmdp4_write(mdp4_kms, REG_MDP4_OVERLAY_FLUSH, flush);\r\n}\r\nstatic void complete_flip(struct drm_crtc *crtc, struct drm_file *file)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nstruct drm_device *dev = crtc->dev;\r\nstruct drm_pending_vblank_event *event;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->event_lock, flags);\r\nevent = mdp4_crtc->event;\r\nif (event) {\r\nif (!file || (event->base.file_priv == file)) {\r\nmdp4_crtc->event = NULL;\r\nDBG("%s: send event: %p", mdp4_crtc->name, event);\r\ndrm_crtc_send_vblank_event(crtc, event);\r\n}\r\n}\r\nspin_unlock_irqrestore(&dev->event_lock, flags);\r\n}\r\nstatic void unref_cursor_worker(struct drm_flip_work *work, void *val)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc =\r\ncontainer_of(work, struct mdp4_crtc, unref_cursor_work);\r\nstruct mdp4_kms *mdp4_kms = get_kms(&mdp4_crtc->base);\r\nmsm_gem_put_iova(val, mdp4_kms->id);\r\ndrm_gem_object_unreference_unlocked(val);\r\n}\r\nstatic void mdp4_crtc_destroy(struct drm_crtc *crtc)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\ndrm_crtc_cleanup(crtc);\r\ndrm_flip_work_cleanup(&mdp4_crtc->unref_cursor_work);\r\nkfree(mdp4_crtc);\r\n}\r\nstatic void setup_mixer(struct mdp4_kms *mdp4_kms)\r\n{\r\nstruct drm_mode_config *config = &mdp4_kms->dev->mode_config;\r\nstruct drm_crtc *crtc;\r\nuint32_t mixer_cfg = 0;\r\nstatic const enum mdp_mixer_stage_id stages[] = {\r\nSTAGE_BASE, STAGE0, STAGE1, STAGE2, STAGE3,\r\n};\r\nlist_for_each_entry(crtc, &config->crtc_list, head) {\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nstruct drm_plane *plane;\r\ndrm_atomic_crtc_for_each_plane(plane, crtc) {\r\nenum mdp4_pipe pipe_id = mdp4_plane_pipe(plane);\r\nint idx = idxs[pipe_id];\r\nmixer_cfg = mixercfg(mixer_cfg, mdp4_crtc->mixer,\r\npipe_id, stages[idx]);\r\n}\r\n}\r\nmdp4_write(mdp4_kms, REG_MDP4_LAYERMIXER_IN_CFG, mixer_cfg);\r\n}\r\nstatic void blend_setup(struct drm_crtc *crtc)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nstruct mdp4_kms *mdp4_kms = get_kms(crtc);\r\nstruct drm_plane *plane;\r\nint i, ovlp = mdp4_crtc->ovlp;\r\nbool alpha[4]= { false, false, false, false };\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_TRANSP_LOW0(ovlp), 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_TRANSP_LOW1(ovlp), 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_TRANSP_HIGH0(ovlp), 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_TRANSP_HIGH1(ovlp), 0);\r\ndrm_atomic_crtc_for_each_plane(plane, crtc) {\r\nenum mdp4_pipe pipe_id = mdp4_plane_pipe(plane);\r\nint idx = idxs[pipe_id];\r\nif (idx > 0) {\r\nconst struct mdp_format *format =\r\nto_mdp_format(msm_framebuffer_format(plane->fb));\r\nalpha[idx-1] = format->alpha_enable;\r\n}\r\n}\r\nfor (i = 0; i < 4; i++) {\r\nuint32_t op;\r\nif (alpha[i]) {\r\nop = MDP4_OVLP_STAGE_OP_FG_ALPHA(FG_PIXEL) |\r\nMDP4_OVLP_STAGE_OP_BG_ALPHA(FG_PIXEL) |\r\nMDP4_OVLP_STAGE_OP_BG_INV_ALPHA;\r\n} else {\r\nop = MDP4_OVLP_STAGE_OP_FG_ALPHA(FG_CONST) |\r\nMDP4_OVLP_STAGE_OP_BG_ALPHA(BG_CONST);\r\n}\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_STAGE_FG_ALPHA(ovlp, i), 0xff);\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_STAGE_BG_ALPHA(ovlp, i), 0x00);\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_STAGE_OP(ovlp, i), op);\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_STAGE_CO3(ovlp, i), 1);\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_STAGE_TRANSP_LOW0(ovlp, i), 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_STAGE_TRANSP_LOW1(ovlp, i), 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_STAGE_TRANSP_HIGH0(ovlp, i), 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_STAGE_TRANSP_HIGH1(ovlp, i), 0);\r\n}\r\nsetup_mixer(mdp4_kms);\r\n}\r\nstatic void mdp4_crtc_mode_set_nofb(struct drm_crtc *crtc)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nstruct mdp4_kms *mdp4_kms = get_kms(crtc);\r\nenum mdp4_dma dma = mdp4_crtc->dma;\r\nint ovlp = mdp4_crtc->ovlp;\r\nstruct drm_display_mode *mode;\r\nif (WARN_ON(!crtc->state))\r\nreturn;\r\nmode = &crtc->state->adjusted_mode;\r\nDBG("%s: set mode: %d:\"%s\" %d %d %d %d %d %d %d %d %d %d 0x%x 0x%x",\r\nmdp4_crtc->name, mode->base.id, mode->name,\r\nmode->vrefresh, mode->clock,\r\nmode->hdisplay, mode->hsync_start,\r\nmode->hsync_end, mode->htotal,\r\nmode->vdisplay, mode->vsync_start,\r\nmode->vsync_end, mode->vtotal,\r\nmode->type, mode->flags);\r\nmdp4_write(mdp4_kms, REG_MDP4_DMA_SRC_SIZE(dma),\r\nMDP4_DMA_SRC_SIZE_WIDTH(mode->hdisplay) |\r\nMDP4_DMA_SRC_SIZE_HEIGHT(mode->vdisplay));\r\nmdp4_write(mdp4_kms, REG_MDP4_DMA_SRC_BASE(dma), 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_DMA_SRC_STRIDE(dma), 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_DMA_DST_SIZE(dma),\r\nMDP4_DMA_DST_SIZE_WIDTH(0) |\r\nMDP4_DMA_DST_SIZE_HEIGHT(0));\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_BASE(ovlp), 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_SIZE(ovlp),\r\nMDP4_OVLP_SIZE_WIDTH(mode->hdisplay) |\r\nMDP4_OVLP_SIZE_HEIGHT(mode->vdisplay));\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_STRIDE(ovlp), 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_OVLP_CFG(ovlp), 1);\r\nif (dma == DMA_E) {\r\nmdp4_write(mdp4_kms, REG_MDP4_DMA_E_QUANT(0), 0x00ff0000);\r\nmdp4_write(mdp4_kms, REG_MDP4_DMA_E_QUANT(1), 0x00ff0000);\r\nmdp4_write(mdp4_kms, REG_MDP4_DMA_E_QUANT(2), 0x00ff0000);\r\n}\r\n}\r\nstatic void mdp4_crtc_disable(struct drm_crtc *crtc)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nstruct mdp4_kms *mdp4_kms = get_kms(crtc);\r\nDBG("%s", mdp4_crtc->name);\r\nif (WARN_ON(!mdp4_crtc->enabled))\r\nreturn;\r\nmdp_irq_unregister(&mdp4_kms->base, &mdp4_crtc->err);\r\nmdp4_disable(mdp4_kms);\r\nmdp4_crtc->enabled = false;\r\n}\r\nstatic void mdp4_crtc_enable(struct drm_crtc *crtc)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nstruct mdp4_kms *mdp4_kms = get_kms(crtc);\r\nDBG("%s", mdp4_crtc->name);\r\nif (WARN_ON(mdp4_crtc->enabled))\r\nreturn;\r\nmdp4_enable(mdp4_kms);\r\nmdp_irq_register(&mdp4_kms->base, &mdp4_crtc->err);\r\ncrtc_flush(crtc);\r\nmdp4_crtc->enabled = true;\r\n}\r\nstatic int mdp4_crtc_atomic_check(struct drm_crtc *crtc,\r\nstruct drm_crtc_state *state)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nDBG("%s: check", mdp4_crtc->name);\r\nreturn 0;\r\n}\r\nstatic void mdp4_crtc_atomic_begin(struct drm_crtc *crtc,\r\nstruct drm_crtc_state *old_crtc_state)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nDBG("%s: begin", mdp4_crtc->name);\r\n}\r\nstatic void mdp4_crtc_atomic_flush(struct drm_crtc *crtc,\r\nstruct drm_crtc_state *old_crtc_state)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nstruct drm_device *dev = crtc->dev;\r\nunsigned long flags;\r\nDBG("%s: event: %p", mdp4_crtc->name, crtc->state->event);\r\nWARN_ON(mdp4_crtc->event);\r\nspin_lock_irqsave(&dev->event_lock, flags);\r\nmdp4_crtc->event = crtc->state->event;\r\nspin_unlock_irqrestore(&dev->event_lock, flags);\r\nblend_setup(crtc);\r\ncrtc_flush(crtc);\r\nrequest_pending(crtc, PENDING_FLIP);\r\n}\r\nstatic void update_cursor(struct drm_crtc *crtc)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nstruct mdp4_kms *mdp4_kms = get_kms(crtc);\r\nenum mdp4_dma dma = mdp4_crtc->dma;\r\nunsigned long flags;\r\nspin_lock_irqsave(&mdp4_crtc->cursor.lock, flags);\r\nif (mdp4_crtc->cursor.stale) {\r\nstruct drm_gem_object *next_bo = mdp4_crtc->cursor.next_bo;\r\nstruct drm_gem_object *prev_bo = mdp4_crtc->cursor.scanout_bo;\r\nuint64_t iova = mdp4_crtc->cursor.next_iova;\r\nif (next_bo) {\r\ndrm_gem_object_reference(next_bo);\r\nmsm_gem_get_iova_locked(next_bo, mdp4_kms->id, &iova);\r\nmdp4_write(mdp4_kms, REG_MDP4_DMA_CURSOR_SIZE(dma),\r\nMDP4_DMA_CURSOR_SIZE_WIDTH(mdp4_crtc->cursor.width) |\r\nMDP4_DMA_CURSOR_SIZE_HEIGHT(mdp4_crtc->cursor.height));\r\nmdp4_write(mdp4_kms, REG_MDP4_DMA_CURSOR_BASE(dma), iova);\r\nmdp4_write(mdp4_kms, REG_MDP4_DMA_CURSOR_BLEND_CONFIG(dma),\r\nMDP4_DMA_CURSOR_BLEND_CONFIG_FORMAT(CURSOR_ARGB) |\r\nMDP4_DMA_CURSOR_BLEND_CONFIG_CURSOR_EN);\r\n} else {\r\nmdp4_write(mdp4_kms, REG_MDP4_DMA_CURSOR_BASE(dma),\r\nmdp4_kms->blank_cursor_iova);\r\n}\r\nif (prev_bo)\r\ndrm_flip_work_queue(&mdp4_crtc->unref_cursor_work, prev_bo);\r\nmdp4_crtc->cursor.scanout_bo = next_bo;\r\nmdp4_crtc->cursor.stale = false;\r\n}\r\nmdp4_write(mdp4_kms, REG_MDP4_DMA_CURSOR_POS(dma),\r\nMDP4_DMA_CURSOR_POS_X(mdp4_crtc->cursor.x) |\r\nMDP4_DMA_CURSOR_POS_Y(mdp4_crtc->cursor.y));\r\nspin_unlock_irqrestore(&mdp4_crtc->cursor.lock, flags);\r\n}\r\nstatic int mdp4_crtc_cursor_set(struct drm_crtc *crtc,\r\nstruct drm_file *file_priv, uint32_t handle,\r\nuint32_t width, uint32_t height)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nstruct mdp4_kms *mdp4_kms = get_kms(crtc);\r\nstruct drm_device *dev = crtc->dev;\r\nstruct drm_gem_object *cursor_bo, *old_bo;\r\nunsigned long flags;\r\nuint64_t iova;\r\nint ret;\r\nif ((width > CURSOR_WIDTH) || (height > CURSOR_HEIGHT)) {\r\ndev_err(dev->dev, "bad cursor size: %dx%d\n", width, height);\r\nreturn -EINVAL;\r\n}\r\nif (handle) {\r\ncursor_bo = drm_gem_object_lookup(file_priv, handle);\r\nif (!cursor_bo)\r\nreturn -ENOENT;\r\n} else {\r\ncursor_bo = NULL;\r\n}\r\nif (cursor_bo) {\r\nret = msm_gem_get_iova(cursor_bo, mdp4_kms->id, &iova);\r\nif (ret)\r\ngoto fail;\r\n} else {\r\niova = 0;\r\n}\r\nspin_lock_irqsave(&mdp4_crtc->cursor.lock, flags);\r\nold_bo = mdp4_crtc->cursor.next_bo;\r\nmdp4_crtc->cursor.next_bo = cursor_bo;\r\nmdp4_crtc->cursor.next_iova = iova;\r\nmdp4_crtc->cursor.width = width;\r\nmdp4_crtc->cursor.height = height;\r\nmdp4_crtc->cursor.stale = true;\r\nspin_unlock_irqrestore(&mdp4_crtc->cursor.lock, flags);\r\nif (old_bo) {\r\ndrm_flip_work_queue(&mdp4_crtc->unref_cursor_work, old_bo);\r\n}\r\nrequest_pending(crtc, PENDING_CURSOR);\r\nreturn 0;\r\nfail:\r\ndrm_gem_object_unreference_unlocked(cursor_bo);\r\nreturn ret;\r\n}\r\nstatic int mdp4_crtc_cursor_move(struct drm_crtc *crtc, int x, int y)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nunsigned long flags;\r\nspin_lock_irqsave(&mdp4_crtc->cursor.lock, flags);\r\nmdp4_crtc->cursor.x = x;\r\nmdp4_crtc->cursor.y = y;\r\nspin_unlock_irqrestore(&mdp4_crtc->cursor.lock, flags);\r\ncrtc_flush(crtc);\r\nrequest_pending(crtc, PENDING_CURSOR);\r\nreturn 0;\r\n}\r\nstatic void mdp4_crtc_vblank_irq(struct mdp_irq *irq, uint32_t irqstatus)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = container_of(irq, struct mdp4_crtc, vblank);\r\nstruct drm_crtc *crtc = &mdp4_crtc->base;\r\nstruct msm_drm_private *priv = crtc->dev->dev_private;\r\nunsigned pending;\r\nmdp_irq_unregister(&get_kms(crtc)->base, &mdp4_crtc->vblank);\r\npending = atomic_xchg(&mdp4_crtc->pending, 0);\r\nif (pending & PENDING_FLIP) {\r\ncomplete_flip(crtc, NULL);\r\n}\r\nif (pending & PENDING_CURSOR) {\r\nupdate_cursor(crtc);\r\ndrm_flip_work_commit(&mdp4_crtc->unref_cursor_work, priv->wq);\r\n}\r\n}\r\nstatic void mdp4_crtc_err_irq(struct mdp_irq *irq, uint32_t irqstatus)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = container_of(irq, struct mdp4_crtc, err);\r\nstruct drm_crtc *crtc = &mdp4_crtc->base;\r\nDBG("%s: error: %08x", mdp4_crtc->name, irqstatus);\r\ncrtc_flush(crtc);\r\n}\r\nstatic void mdp4_crtc_wait_for_flush_done(struct drm_crtc *crtc)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nstruct mdp4_kms *mdp4_kms = get_kms(crtc);\r\nint ret;\r\nret = drm_crtc_vblank_get(crtc);\r\nif (ret)\r\nreturn;\r\nret = wait_event_timeout(dev->vblank[drm_crtc_index(crtc)].queue,\r\n!(mdp4_read(mdp4_kms, REG_MDP4_OVERLAY_FLUSH) &\r\nmdp4_crtc->flushed_mask),\r\nmsecs_to_jiffies(50));\r\nif (ret <= 0)\r\ndev_warn(dev->dev, "vblank time out, crtc=%d\n", mdp4_crtc->id);\r\nmdp4_crtc->flushed_mask = 0;\r\ndrm_crtc_vblank_put(crtc);\r\n}\r\nuint32_t mdp4_crtc_vblank(struct drm_crtc *crtc)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nreturn mdp4_crtc->vblank.irqmask;\r\n}\r\nvoid mdp4_crtc_set_config(struct drm_crtc *crtc, uint32_t config)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nstruct mdp4_kms *mdp4_kms = get_kms(crtc);\r\nmdp4_write(mdp4_kms, REG_MDP4_DMA_CONFIG(mdp4_crtc->dma), config);\r\n}\r\nvoid mdp4_crtc_set_intf(struct drm_crtc *crtc, enum mdp4_intf intf, int mixer)\r\n{\r\nstruct mdp4_crtc *mdp4_crtc = to_mdp4_crtc(crtc);\r\nstruct mdp4_kms *mdp4_kms = get_kms(crtc);\r\nuint32_t intf_sel;\r\nintf_sel = mdp4_read(mdp4_kms, REG_MDP4_DISP_INTF_SEL);\r\nswitch (mdp4_crtc->dma) {\r\ncase DMA_P:\r\nintf_sel &= ~MDP4_DISP_INTF_SEL_PRIM__MASK;\r\nintf_sel |= MDP4_DISP_INTF_SEL_PRIM(intf);\r\nbreak;\r\ncase DMA_S:\r\nintf_sel &= ~MDP4_DISP_INTF_SEL_SEC__MASK;\r\nintf_sel |= MDP4_DISP_INTF_SEL_SEC(intf);\r\nbreak;\r\ncase DMA_E:\r\nintf_sel &= ~MDP4_DISP_INTF_SEL_EXT__MASK;\r\nintf_sel |= MDP4_DISP_INTF_SEL_EXT(intf);\r\nbreak;\r\n}\r\nif (intf == INTF_DSI_VIDEO) {\r\nintf_sel &= ~MDP4_DISP_INTF_SEL_DSI_CMD;\r\nintf_sel |= MDP4_DISP_INTF_SEL_DSI_VIDEO;\r\n} else if (intf == INTF_DSI_CMD) {\r\nintf_sel &= ~MDP4_DISP_INTF_SEL_DSI_VIDEO;\r\nintf_sel |= MDP4_DISP_INTF_SEL_DSI_CMD;\r\n}\r\nmdp4_crtc->mixer = mixer;\r\nblend_setup(crtc);\r\nDBG("%s: intf_sel=%08x", mdp4_crtc->name, intf_sel);\r\nmdp4_write(mdp4_kms, REG_MDP4_DISP_INTF_SEL, intf_sel);\r\n}\r\nvoid mdp4_crtc_wait_for_commit_done(struct drm_crtc *crtc)\r\n{\r\nmdp4_crtc_wait_for_flush_done(crtc);\r\n}\r\nstruct drm_crtc *mdp4_crtc_init(struct drm_device *dev,\r\nstruct drm_plane *plane, int id, int ovlp_id,\r\nenum mdp4_dma dma_id)\r\n{\r\nstruct drm_crtc *crtc = NULL;\r\nstruct mdp4_crtc *mdp4_crtc;\r\nmdp4_crtc = kzalloc(sizeof(*mdp4_crtc), GFP_KERNEL);\r\nif (!mdp4_crtc)\r\nreturn ERR_PTR(-ENOMEM);\r\ncrtc = &mdp4_crtc->base;\r\nmdp4_crtc->id = id;\r\nmdp4_crtc->ovlp = ovlp_id;\r\nmdp4_crtc->dma = dma_id;\r\nmdp4_crtc->vblank.irqmask = dma2irq(mdp4_crtc->dma);\r\nmdp4_crtc->vblank.irq = mdp4_crtc_vblank_irq;\r\nmdp4_crtc->err.irqmask = dma2err(mdp4_crtc->dma);\r\nmdp4_crtc->err.irq = mdp4_crtc_err_irq;\r\nsnprintf(mdp4_crtc->name, sizeof(mdp4_crtc->name), "%s:%d",\r\ndma_names[dma_id], ovlp_id);\r\nspin_lock_init(&mdp4_crtc->cursor.lock);\r\ndrm_flip_work_init(&mdp4_crtc->unref_cursor_work,\r\n"unref cursor", unref_cursor_worker);\r\ndrm_crtc_init_with_planes(dev, crtc, plane, NULL, &mdp4_crtc_funcs,\r\nNULL);\r\ndrm_crtc_helper_add(crtc, &mdp4_crtc_helper_funcs);\r\nplane->crtc = crtc;\r\nreturn crtc;\r\n}

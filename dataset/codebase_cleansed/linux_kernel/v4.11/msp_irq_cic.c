static inline void cic_wmb(void)\r\n{\r\nconst volatile void __iomem *cic_mem = CIC_VPE0_MSK_REG;\r\nvolatile u32 dummy_read;\r\nwmb();\r\ndummy_read = __raw_readl(cic_mem);\r\ndummy_read++;\r\n}\r\nstatic void unmask_cic_irq(struct irq_data *d)\r\n{\r\nvolatile u32 *cic_msk_reg = CIC_VPE0_MSK_REG;\r\nint vpe;\r\n#ifdef CONFIG_SMP\r\nunsigned int mtflags;\r\nunsigned long flags;\r\nif (!cpumask_test_cpu(smp_processor_id(),\r\nirq_data_get_affinity_mask(d)))\r\nreturn;\r\n#endif\r\nvpe = get_current_vpe();\r\nLOCK_VPE(flags, mtflags);\r\ncic_msk_reg[vpe] |= (1 << (d->irq - MSP_CIC_INTBASE));\r\nUNLOCK_VPE(flags, mtflags);\r\ncic_wmb();\r\n}\r\nstatic void mask_cic_irq(struct irq_data *d)\r\n{\r\nvolatile u32 *cic_msk_reg = CIC_VPE0_MSK_REG;\r\nint vpe = get_current_vpe();\r\n#ifdef CONFIG_SMP\r\nunsigned long flags, mtflags;\r\n#endif\r\nLOCK_VPE(flags, mtflags);\r\ncic_msk_reg[vpe] &= ~(1 << (d->irq - MSP_CIC_INTBASE));\r\nUNLOCK_VPE(flags, mtflags);\r\ncic_wmb();\r\n}\r\nstatic void msp_cic_irq_ack(struct irq_data *d)\r\n{\r\nmask_cic_irq(d);\r\n*CIC_STS_REG = (1 << (d->irq - MSP_CIC_INTBASE));\r\n}\r\nstatic int msp_cic_irq_set_affinity(struct irq_data *d,\r\nconst struct cpumask *cpumask, bool force)\r\n{\r\nint cpu;\r\nunsigned long flags;\r\nunsigned int mtflags;\r\nunsigned long imask = (1 << (d->irq - MSP_CIC_INTBASE));\r\nvolatile u32 *cic_mask = (volatile u32 *)CIC_VPE0_MSK_REG;\r\nBUG_ON(d->irq == MSP_INT_VPE0_TIMER || d->irq == MSP_INT_VPE1_TIMER);\r\nLOCK_CORE(flags, mtflags);\r\nfor_each_online_cpu(cpu) {\r\nif (cpumask_test_cpu(cpu, cpumask))\r\ncic_mask[cpu] |= imask;\r\nelse\r\ncic_mask[cpu] &= ~imask;\r\n}\r\nUNLOCK_CORE(flags, mtflags);\r\nreturn 0;\r\n}\r\nvoid __init msp_cic_irq_init(void)\r\n{\r\nint i;\r\n*CIC_VPE0_MSK_REG = 0x00000000;\r\n*CIC_VPE1_MSK_REG = 0x00000000;\r\n*CIC_STS_REG = 0xFFFFFFFF;\r\n*CIC_EXT_CFG_REG &= 0xFFFF8F8F;\r\nfor (i = MSP_CIC_INTBASE ; i < MSP_CIC_INTBASE + 32 ; i++) {\r\nirq_set_chip_and_handler(i, &msp_cic_irq_controller,\r\nhandle_level_irq);\r\n}\r\nmsp_per_irq_init();\r\n}\r\nvoid msp_cic_irq_dispatch(void)\r\n{\r\nvolatile u32 *cic_msk_reg = (volatile u32 *)CIC_VPE0_MSK_REG;\r\nu32 cic_mask;\r\nu32 pending;\r\nint cic_status = *CIC_STS_REG;\r\ncic_mask = cic_msk_reg[get_current_vpe()];\r\npending = cic_status & cic_mask;\r\nif (pending & (1 << (MSP_INT_VPE0_TIMER - MSP_CIC_INTBASE))) {\r\ndo_IRQ(MSP_INT_VPE0_TIMER);\r\n} else if (pending & (1 << (MSP_INT_VPE1_TIMER - MSP_CIC_INTBASE))) {\r\ndo_IRQ(MSP_INT_VPE1_TIMER);\r\n} else if (pending & (1 << (MSP_INT_PER - MSP_CIC_INTBASE))) {\r\nmsp_per_irq_dispatch();\r\n} else if (pending) {\r\ndo_IRQ(ffs(pending) + MSP_CIC_INTBASE - 1);\r\n} else{\r\nspurious_interrupt();\r\n}\r\n}

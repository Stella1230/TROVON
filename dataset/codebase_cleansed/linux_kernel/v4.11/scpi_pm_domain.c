static int scpi_pd_power(struct scpi_pm_domain *pd, bool power_on)\r\n{\r\nint ret;\r\nenum scpi_power_domain_state state;\r\nif (power_on)\r\nstate = SCPI_PD_STATE_ON;\r\nelse\r\nstate = SCPI_PD_STATE_OFF;\r\nret = pd->ops->device_set_power_state(pd->domain, state);\r\nif (ret)\r\nreturn ret;\r\nreturn !(state == pd->ops->device_get_power_state(pd->domain));\r\n}\r\nstatic int scpi_pd_power_on(struct generic_pm_domain *domain)\r\n{\r\nstruct scpi_pm_domain *pd = to_scpi_pd(domain);\r\nreturn scpi_pd_power(pd, true);\r\n}\r\nstatic int scpi_pd_power_off(struct generic_pm_domain *domain)\r\n{\r\nstruct scpi_pm_domain *pd = to_scpi_pd(domain);\r\nreturn scpi_pd_power(pd, false);\r\n}\r\nstatic int scpi_pm_domain_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct scpi_pm_domain *scpi_pd;\r\nstruct genpd_onecell_data *scpi_pd_data;\r\nstruct generic_pm_domain **domains;\r\nstruct scpi_ops *scpi_ops;\r\nint ret, num_domains, i;\r\nscpi_ops = get_scpi_ops();\r\nif (!scpi_ops)\r\nreturn -EPROBE_DEFER;\r\nif (!np) {\r\ndev_err(dev, "device tree node not found\n");\r\nreturn -ENODEV;\r\n}\r\nif (!scpi_ops->device_set_power_state ||\r\n!scpi_ops->device_get_power_state) {\r\ndev_err(dev, "power domains not supported in the firmware\n");\r\nreturn -ENODEV;\r\n}\r\nret = of_property_read_u32(np, "num-domains", &num_domains);\r\nif (ret) {\r\ndev_err(dev, "number of domains not found\n");\r\nreturn -EINVAL;\r\n}\r\nscpi_pd = devm_kcalloc(dev, num_domains, sizeof(*scpi_pd), GFP_KERNEL);\r\nif (!scpi_pd)\r\nreturn -ENOMEM;\r\nscpi_pd_data = devm_kzalloc(dev, sizeof(*scpi_pd_data), GFP_KERNEL);\r\nif (!scpi_pd_data)\r\nreturn -ENOMEM;\r\ndomains = devm_kcalloc(dev, num_domains, sizeof(*domains), GFP_KERNEL);\r\nif (!domains)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < num_domains; i++, scpi_pd++) {\r\ndomains[i] = &scpi_pd->genpd;\r\nscpi_pd->domain = i;\r\nscpi_pd->ops = scpi_ops;\r\nsprintf(scpi_pd->name, "%s.%d", np->name, i);\r\nscpi_pd->genpd.name = scpi_pd->name;\r\nscpi_pd->genpd.power_off = scpi_pd_power_off;\r\nscpi_pd->genpd.power_on = scpi_pd_power_on;\r\npm_genpd_init(&scpi_pd->genpd, NULL, true);\r\n}\r\nscpi_pd_data->domains = domains;\r\nscpi_pd_data->num_domains = num_domains;\r\nof_genpd_add_provider_onecell(np, scpi_pd_data);\r\nreturn 0;\r\n}

static void meson6_dwmac_fix_mac_speed(void *priv, unsigned int speed)\r\n{\r\nstruct meson_dwmac *dwmac = priv;\r\nunsigned int val;\r\nval = readl(dwmac->reg);\r\nswitch (speed) {\r\ncase SPEED_10:\r\nval &= ~ETHMAC_SPEED_100;\r\nbreak;\r\ncase SPEED_100:\r\nval |= ETHMAC_SPEED_100;\r\nbreak;\r\n}\r\nwritel(val, dwmac->reg);\r\n}\r\nstatic int meson6_dwmac_probe(struct platform_device *pdev)\r\n{\r\nstruct plat_stmmacenet_data *plat_dat;\r\nstruct stmmac_resources stmmac_res;\r\nstruct meson_dwmac *dwmac;\r\nstruct resource *res;\r\nint ret;\r\nret = stmmac_get_platform_resources(pdev, &stmmac_res);\r\nif (ret)\r\nreturn ret;\r\nplat_dat = stmmac_probe_config_dt(pdev, &stmmac_res.mac);\r\nif (IS_ERR(plat_dat))\r\nreturn PTR_ERR(plat_dat);\r\ndwmac = devm_kzalloc(&pdev->dev, sizeof(*dwmac), GFP_KERNEL);\r\nif (!dwmac) {\r\nret = -ENOMEM;\r\ngoto err_remove_config_dt;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\ndwmac->reg = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(dwmac->reg)) {\r\nret = PTR_ERR(dwmac->reg);\r\ngoto err_remove_config_dt;\r\n}\r\nplat_dat->bsp_priv = dwmac;\r\nplat_dat->fix_mac_speed = meson6_dwmac_fix_mac_speed;\r\nret = stmmac_dvr_probe(&pdev->dev, plat_dat, &stmmac_res);\r\nif (ret)\r\ngoto err_remove_config_dt;\r\nreturn 0;\r\nerr_remove_config_dt:\r\nstmmac_remove_config_dt(pdev, plat_dat);\r\nreturn ret;\r\n}

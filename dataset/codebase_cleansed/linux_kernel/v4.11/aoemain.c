static void\r\ndiscover_timer(ulong vp)\r\n{\r\nstatic struct timer_list t;\r\nstatic volatile ulong die;\r\nstatic spinlock_t lock;\r\nulong flags;\r\nenum { DTIMERTICK = HZ * 60 };\r\nswitch (vp) {\r\ncase TINIT:\r\ninit_timer(&t);\r\nspin_lock_init(&lock);\r\nt.data = TRUN;\r\nt.function = discover_timer;\r\ndie = 0;\r\ncase TRUN:\r\nspin_lock_irqsave(&lock, flags);\r\nif (!die) {\r\nt.expires = jiffies + DTIMERTICK;\r\nadd_timer(&t);\r\n}\r\nspin_unlock_irqrestore(&lock, flags);\r\naoecmd_cfg(0xffff, 0xff);\r\nreturn;\r\ncase TKILL:\r\nspin_lock_irqsave(&lock, flags);\r\ndie = 1;\r\nspin_unlock_irqrestore(&lock, flags);\r\ndel_timer_sync(&t);\r\ndefault:\r\nreturn;\r\n}\r\n}\r\nstatic void\r\naoe_exit(void)\r\n{\r\ndiscover_timer(TKILL);\r\naoenet_exit();\r\nunregister_blkdev(AOE_MAJOR, DEVICE_NAME);\r\naoecmd_exit();\r\naoechr_exit();\r\naoedev_exit();\r\naoeblk_exit();\r\n}\r\nstatic int __init\r\naoe_init(void)\r\n{\r\nint ret;\r\nret = aoedev_init();\r\nif (ret)\r\nreturn ret;\r\nret = aoechr_init();\r\nif (ret)\r\ngoto chr_fail;\r\nret = aoeblk_init();\r\nif (ret)\r\ngoto blk_fail;\r\nret = aoenet_init();\r\nif (ret)\r\ngoto net_fail;\r\nret = aoecmd_init();\r\nif (ret)\r\ngoto cmd_fail;\r\nret = register_blkdev(AOE_MAJOR, DEVICE_NAME);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "aoe: can't register major\n");\r\ngoto blkreg_fail;\r\n}\r\nprintk(KERN_INFO "aoe: AoE v%s initialised.\n", VERSION);\r\ndiscover_timer(TINIT);\r\nreturn 0;\r\nblkreg_fail:\r\naoecmd_exit();\r\ncmd_fail:\r\naoenet_exit();\r\nnet_fail:\r\naoeblk_exit();\r\nblk_fail:\r\naoechr_exit();\r\nchr_fail:\r\naoedev_exit();\r\nprintk(KERN_INFO "aoe: initialisation failure.\n");\r\nreturn ret;\r\n}

static void host1x_intr_syncpt_handle(struct host1x_syncpt *syncpt)\r\n{\r\nunsigned int id = syncpt->id;\r\nstruct host1x *host = syncpt->host;\r\nhost1x_sync_writel(host, BIT_MASK(id),\r\nHOST1X_SYNC_SYNCPT_THRESH_INT_DISABLE(BIT_WORD(id)));\r\nhost1x_sync_writel(host, BIT_MASK(id),\r\nHOST1X_SYNC_SYNCPT_THRESH_CPU0_INT_STATUS(BIT_WORD(id)));\r\nschedule_work(&syncpt->intr.work);\r\n}\r\nstatic irqreturn_t syncpt_thresh_isr(int irq, void *dev_id)\r\n{\r\nstruct host1x *host = dev_id;\r\nunsigned long reg;\r\nunsigned int i, id;\r\nfor (i = 0; i < DIV_ROUND_UP(host->info->nb_pts, 32); i++) {\r\nreg = host1x_sync_readl(host,\r\nHOST1X_SYNC_SYNCPT_THRESH_CPU0_INT_STATUS(i));\r\nfor_each_set_bit(id, &reg, BITS_PER_LONG) {\r\nstruct host1x_syncpt *syncpt =\r\nhost->syncpt + (i * BITS_PER_LONG + id);\r\nhost1x_intr_syncpt_handle(syncpt);\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void _host1x_intr_disable_all_syncpt_intrs(struct host1x *host)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < DIV_ROUND_UP(host->info->nb_pts, 32); ++i) {\r\nhost1x_sync_writel(host, 0xffffffffu,\r\nHOST1X_SYNC_SYNCPT_THRESH_INT_DISABLE(i));\r\nhost1x_sync_writel(host, 0xffffffffu,\r\nHOST1X_SYNC_SYNCPT_THRESH_CPU0_INT_STATUS(i));\r\n}\r\n}\r\nstatic int\r\n_host1x_intr_init_host_sync(struct host1x *host, u32 cpm,\r\nvoid (*syncpt_thresh_work)(struct work_struct *))\r\n{\r\nunsigned int i;\r\nint err;\r\nhost1x_hw_intr_disable_all_syncpt_intrs(host);\r\nfor (i = 0; i < host->info->nb_pts; i++)\r\nINIT_WORK(&host->syncpt[i].intr.work, syncpt_thresh_work);\r\nerr = devm_request_irq(host->dev, host->intr_syncpt_irq,\r\nsyncpt_thresh_isr, IRQF_SHARED,\r\n"host1x_syncpt", host);\r\nif (err < 0) {\r\nWARN_ON(1);\r\nreturn err;\r\n}\r\nhost1x_sync_writel(host, 0, HOST1X_SYNC_IP_BUSY_TIMEOUT);\r\nhost1x_sync_writel(host, 0xff, HOST1X_SYNC_CTXSW_TIMEOUT_CFG);\r\nhost1x_sync_writel(host, cpm, HOST1X_SYNC_USEC_CLK);\r\nreturn 0;\r\n}\r\nstatic void _host1x_intr_set_syncpt_threshold(struct host1x *host,\r\nunsigned int id,\r\nu32 thresh)\r\n{\r\nhost1x_sync_writel(host, thresh, HOST1X_SYNC_SYNCPT_INT_THRESH(id));\r\n}\r\nstatic void _host1x_intr_enable_syncpt_intr(struct host1x *host,\r\nunsigned int id)\r\n{\r\nhost1x_sync_writel(host, BIT_MASK(id),\r\nHOST1X_SYNC_SYNCPT_THRESH_INT_ENABLE_CPU0(BIT_WORD(id)));\r\n}\r\nstatic void _host1x_intr_disable_syncpt_intr(struct host1x *host,\r\nunsigned int id)\r\n{\r\nhost1x_sync_writel(host, BIT_MASK(id),\r\nHOST1X_SYNC_SYNCPT_THRESH_INT_DISABLE(BIT_WORD(id)));\r\nhost1x_sync_writel(host, BIT_MASK(id),\r\nHOST1X_SYNC_SYNCPT_THRESH_CPU0_INT_STATUS(BIT_WORD(id)));\r\n}\r\nstatic int _host1x_free_syncpt_irq(struct host1x *host)\r\n{\r\nunsigned int i;\r\ndevm_free_irq(host->dev, host->intr_syncpt_irq, host);\r\nfor (i = 0; i < host->info->nb_pts; i++)\r\ncancel_work_sync(&host->syncpt[i].intr.work);\r\nreturn 0;\r\n}

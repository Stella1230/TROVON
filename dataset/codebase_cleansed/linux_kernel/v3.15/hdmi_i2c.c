static void init_ddc(struct hdmi_i2c_adapter *hdmi_i2c)\r\n{\r\nstruct hdmi *hdmi = hdmi_i2c->hdmi;\r\nhdmi_write(hdmi, REG_HDMI_DDC_CTRL,\r\nHDMI_DDC_CTRL_SW_STATUS_RESET);\r\nhdmi_write(hdmi, REG_HDMI_DDC_CTRL,\r\nHDMI_DDC_CTRL_SOFT_RESET);\r\nhdmi_write(hdmi, REG_HDMI_DDC_SPEED,\r\nHDMI_DDC_SPEED_THRESHOLD(2) |\r\nHDMI_DDC_SPEED_PRESCALE(10));\r\nhdmi_write(hdmi, REG_HDMI_DDC_SETUP,\r\nHDMI_DDC_SETUP_TIMEOUT(0xff));\r\nhdmi_write(hdmi, REG_HDMI_DDC_REF,\r\nHDMI_DDC_REF_REFTIMER_ENABLE |\r\nHDMI_DDC_REF_REFTIMER(27));\r\n}\r\nstatic int ddc_clear_irq(struct hdmi_i2c_adapter *hdmi_i2c)\r\n{\r\nstruct hdmi *hdmi = hdmi_i2c->hdmi;\r\nstruct drm_device *dev = hdmi->dev;\r\nuint32_t retry = 0xffff;\r\nuint32_t ddc_int_ctrl;\r\ndo {\r\n--retry;\r\nhdmi_write(hdmi, REG_HDMI_DDC_INT_CTRL,\r\nHDMI_DDC_INT_CTRL_SW_DONE_ACK |\r\nHDMI_DDC_INT_CTRL_SW_DONE_MASK);\r\nddc_int_ctrl = hdmi_read(hdmi, REG_HDMI_DDC_INT_CTRL);\r\n} while ((ddc_int_ctrl & HDMI_DDC_INT_CTRL_SW_DONE_INT) && retry);\r\nif (!retry) {\r\ndev_err(dev->dev, "timeout waiting for DDC\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nhdmi_i2c->sw_done = false;\r\nreturn 0;\r\n}\r\nstatic bool sw_done(struct hdmi_i2c_adapter *hdmi_i2c)\r\n{\r\nstruct hdmi *hdmi = hdmi_i2c->hdmi;\r\nif (!hdmi_i2c->sw_done) {\r\nuint32_t ddc_int_ctrl;\r\nddc_int_ctrl = hdmi_read(hdmi, REG_HDMI_DDC_INT_CTRL);\r\nif ((ddc_int_ctrl & HDMI_DDC_INT_CTRL_SW_DONE_MASK) &&\r\n(ddc_int_ctrl & HDMI_DDC_INT_CTRL_SW_DONE_INT)) {\r\nhdmi_i2c->sw_done = true;\r\nhdmi_write(hdmi, REG_HDMI_DDC_INT_CTRL,\r\nHDMI_DDC_INT_CTRL_SW_DONE_ACK);\r\n}\r\n}\r\nreturn hdmi_i2c->sw_done;\r\n}\r\nstatic int hdmi_i2c_xfer(struct i2c_adapter *i2c,\r\nstruct i2c_msg *msgs, int num)\r\n{\r\nstruct hdmi_i2c_adapter *hdmi_i2c = to_hdmi_i2c_adapter(i2c);\r\nstruct hdmi *hdmi = hdmi_i2c->hdmi;\r\nstruct drm_device *dev = hdmi->dev;\r\nstatic const uint32_t nack[] = {\r\nHDMI_DDC_SW_STATUS_NACK0, HDMI_DDC_SW_STATUS_NACK1,\r\nHDMI_DDC_SW_STATUS_NACK2, HDMI_DDC_SW_STATUS_NACK3,\r\n};\r\nint indices[MAX_TRANSACTIONS];\r\nint ret, i, j, index = 0;\r\nuint32_t ddc_status, ddc_data, i2c_trans;\r\nnum = min(num, MAX_TRANSACTIONS);\r\nWARN_ON(!(hdmi_read(hdmi, REG_HDMI_CTRL) & HDMI_CTRL_ENABLE));\r\nif (num == 0)\r\nreturn num;\r\ninit_ddc(hdmi_i2c);\r\nret = ddc_clear_irq(hdmi_i2c);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < num; i++) {\r\nstruct i2c_msg *p = &msgs[i];\r\nuint32_t raw_addr = p->addr << 1;\r\nif (p->flags & I2C_M_RD)\r\nraw_addr |= 1;\r\nddc_data = HDMI_DDC_DATA_DATA(raw_addr) |\r\nHDMI_DDC_DATA_DATA_RW(DDC_WRITE);\r\nif (i == 0) {\r\nddc_data |= HDMI_DDC_DATA_INDEX(0) |\r\nHDMI_DDC_DATA_INDEX_WRITE;\r\n}\r\nhdmi_write(hdmi, REG_HDMI_DDC_DATA, ddc_data);\r\nindex++;\r\nindices[i] = index;\r\nif (p->flags & I2C_M_RD) {\r\nindex += p->len;\r\n} else {\r\nfor (j = 0; j < p->len; j++) {\r\nddc_data = HDMI_DDC_DATA_DATA(p->buf[j]) |\r\nHDMI_DDC_DATA_DATA_RW(DDC_WRITE);\r\nhdmi_write(hdmi, REG_HDMI_DDC_DATA, ddc_data);\r\nindex++;\r\n}\r\n}\r\ni2c_trans = HDMI_I2C_TRANSACTION_REG_CNT(p->len) |\r\nHDMI_I2C_TRANSACTION_REG_RW(\r\n(p->flags & I2C_M_RD) ? DDC_READ : DDC_WRITE) |\r\nHDMI_I2C_TRANSACTION_REG_START;\r\nif (i == (num - 1))\r\ni2c_trans |= HDMI_I2C_TRANSACTION_REG_STOP;\r\nhdmi_write(hdmi, REG_HDMI_I2C_TRANSACTION(i), i2c_trans);\r\n}\r\nhdmi_write(hdmi, REG_HDMI_DDC_CTRL,\r\nHDMI_DDC_CTRL_TRANSACTION_CNT(num - 1) |\r\nHDMI_DDC_CTRL_GO);\r\nret = wait_event_timeout(hdmi_i2c->ddc_event, sw_done(hdmi_i2c), HZ/4);\r\nif (ret <= 0) {\r\nif (ret == 0)\r\nret = -ETIMEDOUT;\r\ndev_warn(dev->dev, "DDC timeout: %d\n", ret);\r\nDBG("sw_status=%08x, hw_status=%08x, int_ctrl=%08x",\r\nhdmi_read(hdmi, REG_HDMI_DDC_SW_STATUS),\r\nhdmi_read(hdmi, REG_HDMI_DDC_HW_STATUS),\r\nhdmi_read(hdmi, REG_HDMI_DDC_INT_CTRL));\r\nreturn ret;\r\n}\r\nddc_status = hdmi_read(hdmi, REG_HDMI_DDC_SW_STATUS);\r\nfor (i = 0; i < num; i++) {\r\nstruct i2c_msg *p = &msgs[i];\r\nif (!(p->flags & I2C_M_RD))\r\ncontinue;\r\nif (ddc_status & nack[i]) {\r\nDBG("ddc_status=%08x", ddc_status);\r\nbreak;\r\n}\r\nddc_data = HDMI_DDC_DATA_DATA_RW(DDC_READ) |\r\nHDMI_DDC_DATA_INDEX(indices[i]) |\r\nHDMI_DDC_DATA_INDEX_WRITE;\r\nhdmi_write(hdmi, REG_HDMI_DDC_DATA, ddc_data);\r\nhdmi_read(hdmi, REG_HDMI_DDC_DATA);\r\nfor (j = 0; j < p->len; j++) {\r\nddc_data = hdmi_read(hdmi, REG_HDMI_DDC_DATA);\r\np->buf[j] = FIELD(ddc_data, HDMI_DDC_DATA_DATA);\r\n}\r\n}\r\nreturn i;\r\n}\r\nstatic u32 hdmi_i2c_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL;\r\n}\r\nvoid hdmi_i2c_irq(struct i2c_adapter *i2c)\r\n{\r\nstruct hdmi_i2c_adapter *hdmi_i2c = to_hdmi_i2c_adapter(i2c);\r\nif (sw_done(hdmi_i2c))\r\nwake_up_all(&hdmi_i2c->ddc_event);\r\n}\r\nvoid hdmi_i2c_destroy(struct i2c_adapter *i2c)\r\n{\r\nstruct hdmi_i2c_adapter *hdmi_i2c = to_hdmi_i2c_adapter(i2c);\r\ni2c_del_adapter(i2c);\r\nkfree(hdmi_i2c);\r\n}\r\nstruct i2c_adapter *hdmi_i2c_init(struct hdmi *hdmi)\r\n{\r\nstruct drm_device *dev = hdmi->dev;\r\nstruct hdmi_i2c_adapter *hdmi_i2c;\r\nstruct i2c_adapter *i2c = NULL;\r\nint ret;\r\nhdmi_i2c = kzalloc(sizeof(*hdmi_i2c), GFP_KERNEL);\r\nif (!hdmi_i2c) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\ni2c = &hdmi_i2c->base;\r\nhdmi_i2c->hdmi = hdmi;\r\ninit_waitqueue_head(&hdmi_i2c->ddc_event);\r\ni2c->owner = THIS_MODULE;\r\ni2c->class = I2C_CLASS_DDC;\r\nsnprintf(i2c->name, sizeof(i2c->name), "msm hdmi i2c");\r\ni2c->dev.parent = &hdmi->pdev->dev;\r\ni2c->algo = &hdmi_i2c_algorithm;\r\nret = i2c_add_adapter(i2c);\r\nif (ret) {\r\ndev_err(dev->dev, "failed to register hdmi i2c: %d\n", ret);\r\ngoto fail;\r\n}\r\nreturn i2c;\r\nfail:\r\nif (i2c)\r\nhdmi_i2c_destroy(i2c);\r\nreturn ERR_PTR(ret);\r\n}

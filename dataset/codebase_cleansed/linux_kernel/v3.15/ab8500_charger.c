static void ab8500_enable_disable_sw_fallback(struct ab8500_charger *di,\r\nbool fallback)\r\n{\r\nu8 val;\r\nu8 reg;\r\nu8 bank;\r\nu8 bit;\r\nint ret;\r\ndev_dbg(di->dev, "SW Fallback: %d\n", fallback);\r\nif (is_ab8500(di->parent)) {\r\nbank = 0x15;\r\nreg = 0x0;\r\nbit = 3;\r\n} else {\r\nbank = AB8500_SYS_CTRL1_BLOCK;\r\nreg = AB8500_SW_CONTROL_FALLBACK;\r\nbit = 0;\r\n}\r\nret = abx500_get_register_interruptible(di->dev, bank, reg, &val);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%d read failed\n", __LINE__);\r\nreturn;\r\n}\r\nif (is_ab8500(di->parent)) {\r\nret = abx500_set_register_interruptible(di->dev, 0x11, 0x00, 0x2);\r\nif (ret) {\r\ndev_err(di->dev, "%d write failed\n", __LINE__);\r\ngoto disable_otp;\r\n}\r\n}\r\nif (fallback)\r\nval |= (1 << bit);\r\nelse\r\nval &= ~(1 << bit);\r\nret = abx500_set_register_interruptible(di->dev, bank, reg, val);\r\nif (ret) {\r\ndev_err(di->dev, "%d write failed\n", __LINE__);\r\n}\r\ndisable_otp:\r\nif (is_ab8500(di->parent)) {\r\nret = abx500_set_register_interruptible(di->dev, 0x11, 0x00, 0x0);\r\nif (ret) {\r\ndev_err(di->dev, "%d write failed\n", __LINE__);\r\n}\r\n}\r\n}\r\nstatic void ab8500_power_supply_changed(struct ab8500_charger *di,\r\nstruct power_supply *psy)\r\n{\r\nif (di->autopower_cfg) {\r\nif (!di->usb.charger_connected &&\r\n!di->ac.charger_connected &&\r\ndi->autopower) {\r\ndi->autopower = false;\r\nab8500_enable_disable_sw_fallback(di, false);\r\n} else if (!di->autopower &&\r\n(di->ac.charger_connected ||\r\ndi->usb.charger_connected)) {\r\ndi->autopower = true;\r\nab8500_enable_disable_sw_fallback(di, true);\r\n}\r\n}\r\npower_supply_changed(psy);\r\n}\r\nstatic void ab8500_charger_set_usb_connected(struct ab8500_charger *di,\r\nbool connected)\r\n{\r\nif (connected != di->usb.charger_connected) {\r\ndev_dbg(di->dev, "USB connected:%i\n", connected);\r\ndi->usb.charger_connected = connected;\r\nif (!connected)\r\ndi->flags.vbus_drop_end = false;\r\nsysfs_notify(&di->usb_chg.psy.dev->kobj, NULL, "present");\r\nif (connected) {\r\nmutex_lock(&di->charger_attached_mutex);\r\nmutex_unlock(&di->charger_attached_mutex);\r\nif (is_ab8500(di->parent))\r\nqueue_delayed_work(di->charger_wq,\r\n&di->usb_charger_attached_work,\r\nHZ);\r\n} else {\r\ncancel_delayed_work_sync(&di->usb_charger_attached_work);\r\nmutex_lock(&di->charger_attached_mutex);\r\nmutex_unlock(&di->charger_attached_mutex);\r\n}\r\n}\r\n}\r\nstatic int ab8500_charger_get_ac_voltage(struct ab8500_charger *di)\r\n{\r\nint vch;\r\nif (di->ac.charger_connected) {\r\nvch = ab8500_gpadc_convert(di->gpadc, MAIN_CHARGER_V);\r\nif (vch < 0)\r\ndev_err(di->dev, "%s gpadc conv failed,\n", __func__);\r\n} else {\r\nvch = 0;\r\n}\r\nreturn vch;\r\n}\r\nstatic int ab8500_charger_ac_cv(struct ab8500_charger *di)\r\n{\r\nu8 val;\r\nint ret = 0;\r\nif (di->ac.charger_online) {\r\nret = abx500_get_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_CH_STATUS1_REG, &val);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s ab8500 read failed\n", __func__);\r\nreturn 0;\r\n}\r\nif (val & MAIN_CH_CV_ON)\r\nret = 1;\r\nelse\r\nret = 0;\r\n}\r\nreturn ret;\r\n}\r\nstatic int ab8500_charger_get_vbus_voltage(struct ab8500_charger *di)\r\n{\r\nint vch;\r\nif (di->usb.charger_connected) {\r\nvch = ab8500_gpadc_convert(di->gpadc, VBUS_V);\r\nif (vch < 0)\r\ndev_err(di->dev, "%s gpadc conv failed\n", __func__);\r\n} else {\r\nvch = 0;\r\n}\r\nreturn vch;\r\n}\r\nstatic int ab8500_charger_get_usb_current(struct ab8500_charger *di)\r\n{\r\nint ich;\r\nif (di->usb.charger_online) {\r\nich = ab8500_gpadc_convert(di->gpadc, USB_CHARGER_C);\r\nif (ich < 0)\r\ndev_err(di->dev, "%s gpadc conv failed\n", __func__);\r\n} else {\r\nich = 0;\r\n}\r\nreturn ich;\r\n}\r\nstatic int ab8500_charger_get_ac_current(struct ab8500_charger *di)\r\n{\r\nint ich;\r\nif (di->ac.charger_online) {\r\nich = ab8500_gpadc_convert(di->gpadc, MAIN_CHARGER_C);\r\nif (ich < 0)\r\ndev_err(di->dev, "%s gpadc conv failed\n", __func__);\r\n} else {\r\nich = 0;\r\n}\r\nreturn ich;\r\n}\r\nstatic int ab8500_charger_usb_cv(struct ab8500_charger *di)\r\n{\r\nint ret;\r\nu8 val;\r\nif (di->usb.charger_online) {\r\nret = abx500_get_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_CH_USBCH_STAT1_REG, &val);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s ab8500 read failed\n", __func__);\r\nreturn 0;\r\n}\r\nif (val & USB_CH_CV_ON)\r\nret = 1;\r\nelse\r\nret = 0;\r\n} else {\r\nret = 0;\r\n}\r\nreturn ret;\r\n}\r\nstatic int ab8500_charger_detect_chargers(struct ab8500_charger *di, bool probe)\r\n{\r\nint result = NO_PW_CONN;\r\nint ret;\r\nu8 val;\r\nret = abx500_get_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_CH_STATUS1_REG, &val);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s ab8500 read failed\n", __func__);\r\nreturn ret;\r\n}\r\nif (val & MAIN_CH_DET)\r\nresult = AC_PW_CONN;\r\nif (!probe) {\r\nmsleep(110);\r\n}\r\nret = abx500_get_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_CH_USBCH_STAT1_REG, &val);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s ab8500 read failed\n", __func__);\r\nreturn ret;\r\n}\r\ndev_dbg(di->dev,\r\n"%s AB8500_CH_USBCH_STAT1_REG %x\n", __func__,\r\nval);\r\nif ((val & VBUS_DET_DBNC1) && (val & VBUS_DET_DBNC100))\r\nresult |= USB_PW_CONN;\r\nreturn result;\r\n}\r\nstatic int ab8500_charger_max_usb_curr(struct ab8500_charger *di,\r\nenum ab8500_charger_link_status link_status)\r\n{\r\nint ret = 0;\r\ndi->usb_device_is_unrecognised = false;\r\nswitch (link_status) {\r\ncase USB_STAT_STD_HOST_NC:\r\ncase USB_STAT_STD_HOST_C_NS:\r\ncase USB_STAT_STD_HOST_C_S:\r\ndev_dbg(di->dev, "USB Type - Standard host is "\r\n"detected through USB driver\n");\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P5;\r\ndi->is_aca_rid = 0;\r\nbreak;\r\ncase USB_STAT_HOST_CHG_HS_CHIRP:\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P5;\r\ndi->is_aca_rid = 0;\r\nbreak;\r\ncase USB_STAT_HOST_CHG_HS:\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P5;\r\ndi->is_aca_rid = 0;\r\nbreak;\r\ncase USB_STAT_ACA_RID_C_HS:\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P9;\r\ndi->is_aca_rid = 0;\r\nbreak;\r\ncase USB_STAT_ACA_RID_A:\r\ndev_dbg(di->dev, "USB_STAT_ACA_RID_A detected\n");\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P5;\r\ndi->is_aca_rid = 1;\r\nbreak;\r\ncase USB_STAT_ACA_RID_B:\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_1P3;\r\ndev_dbg(di->dev, "USB Type - 0x%02x MaxCurr: %d", link_status,\r\ndi->max_usb_in_curr.usb_type_max);\r\ndi->is_aca_rid = 1;\r\nbreak;\r\ncase USB_STAT_HOST_CHG_NM:\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P5;\r\ndi->is_aca_rid = 0;\r\nbreak;\r\ncase USB_STAT_DEDICATED_CHG:\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_1P5;\r\ndi->is_aca_rid = 0;\r\nbreak;\r\ncase USB_STAT_ACA_RID_C_HS_CHIRP:\r\ncase USB_STAT_ACA_RID_C_NM:\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_1P5;\r\ndi->is_aca_rid = 1;\r\nbreak;\r\ncase USB_STAT_NOT_CONFIGURED:\r\nif (di->vbus_detected) {\r\ndi->usb_device_is_unrecognised = true;\r\ndev_dbg(di->dev, "USB Type - Legacy charger.\n");\r\ndi->max_usb_in_curr.usb_type_max =\r\nUSB_CH_IP_CUR_LVL_1P5;\r\nbreak;\r\n}\r\ncase USB_STAT_HM_IDGND:\r\ndev_err(di->dev, "USB Type - Charging not allowed\n");\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P05;\r\nret = -ENXIO;\r\nbreak;\r\ncase USB_STAT_RESERVED:\r\nif (is_ab8500(di->parent)) {\r\ndi->flags.vbus_collapse = true;\r\ndev_err(di->dev, "USB Type - USB_STAT_RESERVED "\r\n"VBUS has collapsed\n");\r\nret = -ENXIO;\r\nbreak;\r\n} else {\r\ndev_dbg(di->dev, "USB Type - Charging not allowed\n");\r\ndi->max_usb_in_curr.usb_type_max =\r\nUSB_CH_IP_CUR_LVL_0P05;\r\ndev_dbg(di->dev, "USB Type - 0x%02x MaxCurr: %d",\r\nlink_status,\r\ndi->max_usb_in_curr.usb_type_max);\r\nret = -ENXIO;\r\nbreak;\r\n}\r\ncase USB_STAT_CARKIT_1:\r\ncase USB_STAT_CARKIT_2:\r\ncase USB_STAT_ACA_DOCK_CHARGER:\r\ncase USB_STAT_CHARGER_LINE_1:\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P5;\r\ndev_dbg(di->dev, "USB Type - 0x%02x MaxCurr: %d", link_status,\r\ndi->max_usb_in_curr.usb_type_max);\r\nbreak;\r\ncase USB_STAT_NOT_VALID_LINK:\r\ndev_err(di->dev, "USB Type invalid - try charging anyway\n");\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P5;\r\nbreak;\r\ndefault:\r\ndev_err(di->dev, "USB Type - Unknown\n");\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P05;\r\nret = -ENXIO;\r\nbreak;\r\n};\r\ndi->max_usb_in_curr.set_max = di->max_usb_in_curr.usb_type_max;\r\ndev_dbg(di->dev, "USB Type - 0x%02x MaxCurr: %d",\r\nlink_status, di->max_usb_in_curr.set_max);\r\nreturn ret;\r\n}\r\nstatic int ab8500_charger_read_usb_type(struct ab8500_charger *di)\r\n{\r\nint ret;\r\nu8 val;\r\nret = abx500_get_register_interruptible(di->dev,\r\nAB8500_INTERRUPT, AB8500_IT_SOURCE21_REG, &val);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s ab8500 read failed\n", __func__);\r\nreturn ret;\r\n}\r\nif (is_ab8500(di->parent))\r\nret = abx500_get_register_interruptible(di->dev, AB8500_USB,\r\nAB8500_USB_LINE_STAT_REG, &val);\r\nelse\r\nret = abx500_get_register_interruptible(di->dev,\r\nAB8500_USB, AB8500_USB_LINK1_STAT_REG, &val);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s ab8500 read failed\n", __func__);\r\nreturn ret;\r\n}\r\nif (is_ab8500(di->parent))\r\nval = (val & AB8500_USB_LINK_STATUS) >> USB_LINK_STATUS_SHIFT;\r\nelse\r\nval = (val & AB8505_USB_LINK_STATUS) >> USB_LINK_STATUS_SHIFT;\r\nret = ab8500_charger_max_usb_curr(di,\r\n(enum ab8500_charger_link_status) val);\r\nreturn ret;\r\n}\r\nstatic int ab8500_charger_detect_usb_type(struct ab8500_charger *di)\r\n{\r\nint i, ret;\r\nu8 val;\r\nfor (i = 0; i < 10; i++) {\r\nmsleep(250);\r\nret = abx500_get_register_interruptible(di->dev,\r\nAB8500_INTERRUPT, AB8500_IT_SOURCE21_REG,\r\n&val);\r\ndev_dbg(di->dev, "%s AB8500_IT_SOURCE21_REG %x\n",\r\n__func__, val);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s ab8500 read failed\n", __func__);\r\nreturn ret;\r\n}\r\nif (is_ab8500(di->parent))\r\nret = abx500_get_register_interruptible(di->dev,\r\nAB8500_USB, AB8500_USB_LINE_STAT_REG, &val);\r\nelse\r\nret = abx500_get_register_interruptible(di->dev,\r\nAB8500_USB, AB8500_USB_LINK1_STAT_REG, &val);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s ab8500 read failed\n", __func__);\r\nreturn ret;\r\n}\r\ndev_dbg(di->dev, "%s AB8500_USB_LINE_STAT_REG %x\n", __func__,\r\nval);\r\nif (is_ab8500(di->parent))\r\nval = (val & AB8500_USB_LINK_STATUS) >>\r\nUSB_LINK_STATUS_SHIFT;\r\nelse\r\nval = (val & AB8505_USB_LINK_STATUS) >>\r\nUSB_LINK_STATUS_SHIFT;\r\nif (val)\r\nbreak;\r\n}\r\nret = ab8500_charger_max_usb_curr(di,\r\n(enum ab8500_charger_link_status) val);\r\nreturn ret;\r\n}\r\nstatic int ab8500_voltage_to_regval(int voltage)\r\n{\r\nint i;\r\nif (voltage < ab8500_charger_voltage_map[0])\r\nreturn LOW_VOLT_REG;\r\nfor (i = 1; i < ARRAY_SIZE(ab8500_charger_voltage_map); i++) {\r\nif (voltage < ab8500_charger_voltage_map[i])\r\nreturn i - 1;\r\n}\r\ni = ARRAY_SIZE(ab8500_charger_voltage_map) - 1;\r\nif (voltage == ab8500_charger_voltage_map[i])\r\nreturn i;\r\nelse\r\nreturn -1;\r\n}\r\nstatic int ab8500_current_to_regval(struct ab8500_charger *di, int curr)\r\n{\r\nint i;\r\nif (curr < di->bm->chg_output_curr[0])\r\nreturn 0;\r\nfor (i = 0; i < di->bm->n_chg_out_curr; i++) {\r\nif (curr < di->bm->chg_output_curr[i])\r\nreturn i - 1;\r\n}\r\ni = di->bm->n_chg_out_curr - 1;\r\nif (curr == di->bm->chg_output_curr[i])\r\nreturn i;\r\nelse\r\nreturn -1;\r\n}\r\nstatic int ab8500_vbus_in_curr_to_regval(struct ab8500_charger *di, int curr)\r\n{\r\nint i;\r\nif (curr < di->bm->chg_input_curr[0])\r\nreturn 0;\r\nfor (i = 0; i < di->bm->n_chg_in_curr; i++) {\r\nif (curr < di->bm->chg_input_curr[i])\r\nreturn i - 1;\r\n}\r\ni = di->bm->n_chg_in_curr - 1;\r\nif (curr == di->bm->chg_input_curr[i])\r\nreturn i;\r\nelse\r\nreturn -1;\r\n}\r\nstatic int ab8500_charger_get_usb_cur(struct ab8500_charger *di)\r\n{\r\nint ret = 0;\r\nswitch (di->usb_state.usb_current) {\r\ncase 100:\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P09;\r\nbreak;\r\ncase 200:\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P19;\r\nbreak;\r\ncase 300:\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P29;\r\nbreak;\r\ncase 400:\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P38;\r\nbreak;\r\ncase 500:\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P5;\r\nbreak;\r\ndefault:\r\ndi->max_usb_in_curr.usb_type_max = USB_CH_IP_CUR_LVL_0P05;\r\nret = -EPERM;\r\nbreak;\r\n};\r\ndi->max_usb_in_curr.set_max = di->max_usb_in_curr.usb_type_max;\r\nreturn ret;\r\n}\r\nstatic bool ab8500_charger_check_continue_stepping(struct ab8500_charger *di,\r\nint reg)\r\n{\r\nif (reg == AB8500_USBCH_IPT_CRNTLVL_REG)\r\nreturn !di->flags.vbus_drop_end;\r\nelse\r\nreturn true;\r\n}\r\nstatic int ab8500_charger_set_current(struct ab8500_charger *di,\r\nint ich, int reg)\r\n{\r\nint ret = 0;\r\nint curr_index, prev_curr_index, shift_value, i;\r\nu8 reg_value;\r\nu32 step_udelay;\r\nbool no_stepping = false;\r\natomic_inc(&di->current_stepping_sessions);\r\nret = abx500_get_register_interruptible(di->dev, AB8500_CHARGER,\r\nreg, &reg_value);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s read failed\n", __func__);\r\ngoto exit_set_current;\r\n}\r\nswitch (reg) {\r\ncase AB8500_MCH_IPT_CURLVL_REG:\r\nshift_value = MAIN_CH_INPUT_CURR_SHIFT;\r\nprev_curr_index = (reg_value >> shift_value);\r\ncurr_index = ab8500_current_to_regval(di, ich);\r\nstep_udelay = STEP_UDELAY;\r\nif (!di->ac.charger_connected)\r\nno_stepping = true;\r\nbreak;\r\ncase AB8500_USBCH_IPT_CRNTLVL_REG:\r\nif (is_ab8540(di->parent))\r\nshift_value = AB8540_VBUS_IN_CURR_LIM_SHIFT;\r\nelse\r\nshift_value = VBUS_IN_CURR_LIM_SHIFT;\r\nprev_curr_index = (reg_value >> shift_value);\r\ncurr_index = ab8500_vbus_in_curr_to_regval(di, ich);\r\nstep_udelay = STEP_UDELAY * 100;\r\nif (!di->usb.charger_connected)\r\nno_stepping = true;\r\nbreak;\r\ncase AB8500_CH_OPT_CRNTLVL_REG:\r\nshift_value = 0;\r\nprev_curr_index = (reg_value >> shift_value);\r\ncurr_index = ab8500_current_to_regval(di, ich);\r\nstep_udelay = STEP_UDELAY;\r\nif (curr_index && (curr_index - prev_curr_index) > 1)\r\nstep_udelay *= 100;\r\nif (!di->usb.charger_connected && !di->ac.charger_connected)\r\nno_stepping = true;\r\nbreak;\r\ndefault:\r\ndev_err(di->dev, "%s current register not valid\n", __func__);\r\nret = -ENXIO;\r\ngoto exit_set_current;\r\n}\r\nif (curr_index < 0) {\r\ndev_err(di->dev, "requested current limit out-of-range\n");\r\nret = -ENXIO;\r\ngoto exit_set_current;\r\n}\r\nif (prev_curr_index == curr_index) {\r\ndev_dbg(di->dev, "%s current not changed for reg: 0x%02x\n",\r\n__func__, reg);\r\nret = 0;\r\ngoto exit_set_current;\r\n}\r\ndev_dbg(di->dev, "%s set charger current: %d mA for reg: 0x%02x\n",\r\n__func__, ich, reg);\r\nif (no_stepping) {\r\nret = abx500_set_register_interruptible(di->dev, AB8500_CHARGER,\r\nreg, (u8)curr_index << shift_value);\r\nif (ret)\r\ndev_err(di->dev, "%s write failed\n", __func__);\r\n} else if (prev_curr_index > curr_index) {\r\nfor (i = prev_curr_index - 1; i >= curr_index; i--) {\r\ndev_dbg(di->dev, "curr change_1 to: %x for 0x%02x\n",\r\n(u8) i << shift_value, reg);\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_CHARGER, reg, (u8)i << shift_value);\r\nif (ret) {\r\ndev_err(di->dev, "%s write failed\n", __func__);\r\ngoto exit_set_current;\r\n}\r\nif (i != curr_index)\r\nusleep_range(step_udelay, step_udelay * 2);\r\n}\r\n} else {\r\nbool allow = true;\r\nfor (i = prev_curr_index + 1; i <= curr_index && allow; i++) {\r\ndev_dbg(di->dev, "curr change_2 to: %x for 0x%02x\n",\r\n(u8)i << shift_value, reg);\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_CHARGER, reg, (u8)i << shift_value);\r\nif (ret) {\r\ndev_err(di->dev, "%s write failed\n", __func__);\r\ngoto exit_set_current;\r\n}\r\nif (i != curr_index)\r\nusleep_range(step_udelay, step_udelay * 2);\r\nallow = ab8500_charger_check_continue_stepping(di, reg);\r\n}\r\n}\r\nexit_set_current:\r\natomic_dec(&di->current_stepping_sessions);\r\nreturn ret;\r\n}\r\nstatic int ab8500_charger_set_vbus_in_curr(struct ab8500_charger *di,\r\nint ich_in)\r\n{\r\nint min_value;\r\nint ret;\r\nmin_value = min(di->bm->chg_params->usb_curr_max, ich_in);\r\nif (di->max_usb_in_curr.set_max > 0)\r\nmin_value = min(di->max_usb_in_curr.set_max, min_value);\r\nif (di->usb_state.usb_current >= 0)\r\nmin_value = min(di->usb_state.usb_current, min_value);\r\nswitch (min_value) {\r\ncase 100:\r\nif (di->vbat < VBAT_TRESH_IP_CUR_RED)\r\nmin_value = USB_CH_IP_CUR_LVL_0P05;\r\nbreak;\r\ncase 500:\r\nif (di->vbat < VBAT_TRESH_IP_CUR_RED)\r\nmin_value = USB_CH_IP_CUR_LVL_0P45;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ndev_info(di->dev, "VBUS input current limit set to %d mA\n", min_value);\r\nmutex_lock(&di->usb_ipt_crnt_lock);\r\nret = ab8500_charger_set_current(di, min_value,\r\nAB8500_USBCH_IPT_CRNTLVL_REG);\r\nmutex_unlock(&di->usb_ipt_crnt_lock);\r\nreturn ret;\r\n}\r\nstatic int ab8500_charger_set_main_in_curr(struct ab8500_charger *di,\r\nint ich_in)\r\n{\r\nreturn ab8500_charger_set_current(di, ich_in,\r\nAB8500_MCH_IPT_CURLVL_REG);\r\n}\r\nstatic int ab8500_charger_set_output_curr(struct ab8500_charger *di,\r\nint ich_out)\r\n{\r\nreturn ab8500_charger_set_current(di, ich_out,\r\nAB8500_CH_OPT_CRNTLVL_REG);\r\n}\r\nstatic int ab8500_charger_led_en(struct ab8500_charger *di, int on)\r\n{\r\nint ret;\r\nif (on) {\r\nret = abx500_set_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_LED_INDICATOR_PWM_CTRL,\r\n(LED_IND_CUR_5MA | LED_INDICATOR_PWM_ENA));\r\nif (ret) {\r\ndev_err(di->dev, "Power ON LED failed\n");\r\nreturn ret;\r\n}\r\nret = abx500_set_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_LED_INDICATOR_PWM_DUTY,\r\nLED_INDICATOR_PWM_DUTY_252_256);\r\nif (ret) {\r\ndev_err(di->dev, "Set LED PWM duty cycle failed\n");\r\nreturn ret;\r\n}\r\n} else {\r\nret = abx500_set_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_LED_INDICATOR_PWM_CTRL,\r\nLED_INDICATOR_PWM_DIS);\r\nif (ret) {\r\ndev_err(di->dev, "Power-off LED failed\n");\r\nreturn ret;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int ab8500_charger_ac_en(struct ux500_charger *charger,\r\nint enable, int vset, int iset)\r\n{\r\nint ret;\r\nint volt_index;\r\nint curr_index;\r\nint input_curr_index;\r\nu8 overshoot = 0;\r\nstruct ab8500_charger *di = to_ab8500_charger_ac_device_info(charger);\r\nif (enable) {\r\nif (!di->ac.charger_connected) {\r\ndev_err(di->dev, "AC charger not connected\n");\r\nreturn -ENXIO;\r\n}\r\ndev_dbg(di->dev, "Enable AC: %dmV %dmA\n", vset, iset);\r\nif (!di->vddadc_en_ac) {\r\nret = regulator_enable(di->regu);\r\nif (ret)\r\ndev_warn(di->dev,\r\n"Failed to enable regulator\n");\r\nelse\r\ndi->vddadc_en_ac = true;\r\n}\r\nvolt_index = ab8500_voltage_to_regval(vset);\r\ncurr_index = ab8500_current_to_regval(di, iset);\r\ninput_curr_index = ab8500_current_to_regval(di,\r\ndi->bm->chg_params->ac_curr_max);\r\nif (volt_index < 0 || curr_index < 0 || input_curr_index < 0) {\r\ndev_err(di->dev,\r\n"Charger voltage or current too high, "\r\n"charging not started\n");\r\nreturn -ENXIO;\r\n}\r\nret = abx500_set_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_CH_VOLT_LVL_REG, (u8) volt_index);\r\nif (ret) {\r\ndev_err(di->dev, "%s write failed\n", __func__);\r\nreturn ret;\r\n}\r\nret = ab8500_charger_set_main_in_curr(di,\r\ndi->bm->chg_params->ac_curr_max);\r\nif (ret) {\r\ndev_err(di->dev, "%s Failed to set MainChInputCurr\n",\r\n__func__);\r\nreturn ret;\r\n}\r\nret = ab8500_charger_set_output_curr(di, iset);\r\nif (ret) {\r\ndev_err(di->dev, "%s "\r\n"Failed to set ChOutputCurentLevel\n",\r\n__func__);\r\nreturn ret;\r\n}\r\nif (!di->bm->enable_overshoot)\r\novershoot = MAIN_CH_NO_OVERSHOOT_ENA_N;\r\nret = abx500_set_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_MCH_CTRL1, MAIN_CH_ENA | overshoot);\r\nif (ret) {\r\ndev_err(di->dev, "%s write failed\n", __func__);\r\nreturn ret;\r\n}\r\nret = ab8500_charger_led_en(di, true);\r\nif (ret < 0)\r\ndev_err(di->dev, "failed to enable LED\n");\r\ndi->ac.charger_online = 1;\r\n} else {\r\nif (is_ab8500_1p1_or_earlier(di->parent)) {\r\nif (di->ac_conn) {\r\nqueue_delayed_work(di->charger_wq,\r\n&di->kick_wd_work,\r\nround_jiffies(WD_KICK_INTERVAL));\r\n}\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_CHARGER,\r\nAB8500_CH_VOLT_LVL_REG, CH_VOL_LVL_3P5);\r\nif (ret) {\r\ndev_err(di->dev,\r\n"%s write failed\n", __func__);\r\nreturn ret;\r\n}\r\nret = ab8500_charger_set_output_curr(di, 0);\r\nif (ret) {\r\ndev_err(di->dev, "%s "\r\n"Failed to set ChOutputCurentLevel\n",\r\n__func__);\r\nreturn ret;\r\n}\r\n} else {\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_CHARGER,\r\nAB8500_MCH_CTRL1, 0);\r\nif (ret) {\r\ndev_err(di->dev,\r\n"%s write failed\n", __func__);\r\nreturn ret;\r\n}\r\n}\r\nret = ab8500_charger_led_en(di, false);\r\nif (ret < 0)\r\ndev_err(di->dev, "failed to disable LED\n");\r\ndi->ac.charger_online = 0;\r\ndi->ac.wd_expired = false;\r\nif (di->vddadc_en_ac) {\r\nregulator_disable(di->regu);\r\ndi->vddadc_en_ac = false;\r\n}\r\ndev_dbg(di->dev, "%s Disabled AC charging\n", __func__);\r\n}\r\nab8500_power_supply_changed(di, &di->ac_chg.psy);\r\nreturn ret;\r\n}\r\nstatic int ab8500_charger_usb_en(struct ux500_charger *charger,\r\nint enable, int vset, int ich_out)\r\n{\r\nint ret;\r\nint volt_index;\r\nint curr_index;\r\nu8 overshoot = 0;\r\nstruct ab8500_charger *di = to_ab8500_charger_usb_device_info(charger);\r\nif (enable) {\r\nif (!di->usb.charger_connected) {\r\ndev_err(di->dev, "USB charger not connected\n");\r\nreturn -ENXIO;\r\n}\r\nif (!di->vddadc_en_usb) {\r\nret = regulator_enable(di->regu);\r\nif (ret)\r\ndev_warn(di->dev,\r\n"Failed to enable regulator\n");\r\nelse\r\ndi->vddadc_en_usb = true;\r\n}\r\ndev_dbg(di->dev, "Enable USB: %dmV %dmA\n", vset, ich_out);\r\nvolt_index = ab8500_voltage_to_regval(vset);\r\ncurr_index = ab8500_current_to_regval(di, ich_out);\r\nif (volt_index < 0 || curr_index < 0) {\r\ndev_err(di->dev,\r\n"Charger voltage or current too high, "\r\n"charging not started\n");\r\nreturn -ENXIO;\r\n}\r\nret = abx500_set_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_CH_VOLT_LVL_REG, (u8) volt_index);\r\nif (ret) {\r\ndev_err(di->dev, "%s write failed\n", __func__);\r\nreturn ret;\r\n}\r\nif (!di->bm->enable_overshoot)\r\novershoot = USB_CHG_NO_OVERSHOOT_ENA_N;\r\ndev_dbg(di->dev,\r\n"Enabling USB with write to AB8500_USBCH_CTRL1_REG\n");\r\nret = abx500_set_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_USBCH_CTRL1_REG, USB_CH_ENA | overshoot);\r\nif (ret) {\r\ndev_err(di->dev, "%s write failed\n", __func__);\r\nreturn ret;\r\n}\r\nret = ab8500_charger_led_en(di, true);\r\nif (ret < 0)\r\ndev_err(di->dev, "failed to enable LED\n");\r\ndi->usb.charger_online = 1;\r\nret = ab8500_charger_set_vbus_in_curr(di,\r\ndi->max_usb_in_curr.usb_type_max);\r\nif (ret) {\r\ndev_err(di->dev, "setting USBChInputCurr failed\n");\r\nreturn ret;\r\n}\r\nret = ab8500_charger_set_output_curr(di, ich_out);\r\nif (ret) {\r\ndev_err(di->dev, "%s "\r\n"Failed to set ChOutputCurentLevel\n",\r\n__func__);\r\nreturn ret;\r\n}\r\nqueue_delayed_work(di->charger_wq, &di->check_vbat_work, HZ);\r\n} else {\r\ndev_dbg(di->dev, "%s Disabled USB charging\n", __func__);\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_CHARGER,\r\nAB8500_USBCH_CTRL1_REG, 0);\r\nif (ret) {\r\ndev_err(di->dev,\r\n"%s write failed\n", __func__);\r\nreturn ret;\r\n}\r\nret = ab8500_charger_led_en(di, false);\r\nif (ret < 0)\r\ndev_err(di->dev, "failed to disable LED\n");\r\nret = ab8500_charger_set_vbus_in_curr(di, 0);\r\nif (ret) {\r\ndev_err(di->dev, "setting USBChInputCurr failed\n");\r\nreturn ret;\r\n}\r\nret = ab8500_charger_set_output_curr(di, 0);\r\nif (ret) {\r\ndev_err(di->dev, "%s "\r\n"Failed to reset ChOutputCurentLevel\n",\r\n__func__);\r\nreturn ret;\r\n}\r\ndi->usb.charger_online = 0;\r\ndi->usb.wd_expired = false;\r\nif (di->vddadc_en_usb) {\r\nregulator_disable(di->regu);\r\ndi->vddadc_en_usb = false;\r\n}\r\ndev_dbg(di->dev, "%s Disabled USB charging\n", __func__);\r\ncancel_delayed_work(&di->check_vbat_work);\r\n}\r\nab8500_power_supply_changed(di, &di->usb_chg.psy);\r\nreturn ret;\r\n}\r\nstatic int ab8500_external_charger_prepare(struct notifier_block *charger_nb,\r\nunsigned long event, void *data)\r\n{\r\nint ret;\r\nstruct device *dev = data;\r\nret = abx500_set_register_interruptible(dev, AB8500_SYS_CTRL1_BLOCK,\r\nAB8500_SYS_CHARGER_CONTROL_REG,\r\nEXTERNAL_CHARGER_DISABLE_REG_VAL);\r\nif (ret < 0) {\r\ndev_err(dev, "write reg failed %d\n", ret);\r\ngoto out;\r\n}\r\nret = abx500_set_register_interruptible(dev, AB8500_SYS_CTRL1_BLOCK,\r\nAB8500_SYS_CHARGER_CONTROL_REG,\r\nEXTERNAL_CHARGER_ENABLE_REG_VAL);\r\nif (ret < 0)\r\ndev_err(dev, "Write reg failed %d\n", ret);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int ab8500_charger_usb_check_enable(struct ux500_charger *charger,\r\nint vset, int iset)\r\n{\r\nu8 usbch_ctrl1 = 0;\r\nint ret = 0;\r\nstruct ab8500_charger *di = to_ab8500_charger_usb_device_info(charger);\r\nif (!di->usb.charger_connected)\r\nreturn ret;\r\nret = abx500_get_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_USBCH_CTRL1_REG, &usbch_ctrl1);\r\nif (ret < 0) {\r\ndev_err(di->dev, "ab8500 read failed %d\n", __LINE__);\r\nreturn ret;\r\n}\r\ndev_dbg(di->dev, "USB charger ctrl: 0x%02x\n", usbch_ctrl1);\r\nif (!(usbch_ctrl1 & USB_CH_ENA)) {\r\ndev_info(di->dev, "Charging has been disabled abnormally and will be re-enabled\n");\r\nret = abx500_mask_and_set_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8500_CHARGER_CTRL,\r\nDROP_COUNT_RESET, DROP_COUNT_RESET);\r\nif (ret < 0) {\r\ndev_err(di->dev, "ab8500 write failed %d\n", __LINE__);\r\nreturn ret;\r\n}\r\nret = ab8500_charger_usb_en(&di->usb_chg, true, vset, iset);\r\nif (ret < 0) {\r\ndev_err(di->dev, "Failed to enable VBUS charger %d\n",\r\n__LINE__);\r\nreturn ret;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int ab8500_charger_ac_check_enable(struct ux500_charger *charger,\r\nint vset, int iset)\r\n{\r\nu8 mainch_ctrl1 = 0;\r\nint ret = 0;\r\nstruct ab8500_charger *di = to_ab8500_charger_ac_device_info(charger);\r\nif (!di->ac.charger_connected)\r\nreturn ret;\r\nret = abx500_get_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_MCH_CTRL1, &mainch_ctrl1);\r\nif (ret < 0) {\r\ndev_err(di->dev, "ab8500 read failed %d\n", __LINE__);\r\nreturn ret;\r\n}\r\ndev_dbg(di->dev, "AC charger ctrl: 0x%02x\n", mainch_ctrl1);\r\nif (!(mainch_ctrl1 & MAIN_CH_ENA)) {\r\ndev_info(di->dev, "Charging has been disabled abnormally and will be re-enabled\n");\r\nret = abx500_mask_and_set_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8500_CHARGER_CTRL,\r\nDROP_COUNT_RESET, DROP_COUNT_RESET);\r\nif (ret < 0) {\r\ndev_err(di->dev, "ab8500 write failed %d\n", __LINE__);\r\nreturn ret;\r\n}\r\nret = ab8500_charger_ac_en(&di->usb_chg, true, vset, iset);\r\nif (ret < 0) {\r\ndev_err(di->dev, "failed to enable AC charger %d\n",\r\n__LINE__);\r\nreturn ret;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int ab8500_charger_watchdog_kick(struct ux500_charger *charger)\r\n{\r\nint ret;\r\nstruct ab8500_charger *di;\r\nif (charger->psy.type == POWER_SUPPLY_TYPE_MAINS)\r\ndi = to_ab8500_charger_ac_device_info(charger);\r\nelse if (charger->psy.type == POWER_SUPPLY_TYPE_USB)\r\ndi = to_ab8500_charger_usb_device_info(charger);\r\nelse\r\nreturn -ENXIO;\r\nret = abx500_set_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_CHARG_WD_CTRL, CHARG_WD_KICK);\r\nif (ret)\r\ndev_err(di->dev, "Failed to kick WD!\n");\r\nreturn ret;\r\n}\r\nstatic int ab8500_charger_update_charger_current(struct ux500_charger *charger,\r\nint ich_out)\r\n{\r\nint ret;\r\nstruct ab8500_charger *di;\r\nif (charger->psy.type == POWER_SUPPLY_TYPE_MAINS)\r\ndi = to_ab8500_charger_ac_device_info(charger);\r\nelse if (charger->psy.type == POWER_SUPPLY_TYPE_USB)\r\ndi = to_ab8500_charger_usb_device_info(charger);\r\nelse\r\nreturn -ENXIO;\r\nret = ab8500_charger_set_output_curr(di, ich_out);\r\nif (ret) {\r\ndev_err(di->dev, "%s "\r\n"Failed to set ChOutputCurentLevel\n",\r\n__func__);\r\nreturn ret;\r\n}\r\nret = abx500_set_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_CHARGER_CTRL, DROP_COUNT_RESET);\r\nif (ret) {\r\ndev_err(di->dev, "%s write failed\n", __func__);\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic int ab8540_charger_power_path_enable(struct ux500_charger *charger,\r\nbool enable)\r\n{\r\nint ret;\r\nstruct ab8500_charger *di;\r\nif (charger->psy.type == POWER_SUPPLY_TYPE_USB)\r\ndi = to_ab8500_charger_usb_device_info(charger);\r\nelse\r\nreturn -ENXIO;\r\nret = abx500_mask_and_set_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8540_USB_PP_MODE_REG,\r\nBUS_POWER_PATH_MODE_ENA, enable);\r\nif (ret) {\r\ndev_err(di->dev, "%s write failed\n", __func__);\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic int ab8540_charger_usb_pre_chg_enable(struct ux500_charger *charger,\r\nbool enable)\r\n{\r\nint ret;\r\nstruct ab8500_charger *di;\r\nif (charger->psy.type == POWER_SUPPLY_TYPE_USB)\r\ndi = to_ab8500_charger_usb_device_info(charger);\r\nelse\r\nreturn -ENXIO;\r\nret = abx500_mask_and_set_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8540_USB_PP_CHR_REG,\r\nBUS_POWER_PATH_PRECHG_ENA, enable);\r\nif (ret) {\r\ndev_err(di->dev, "%s write failed\n", __func__);\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic int ab8500_charger_get_ext_psy_data(struct device *dev, void *data)\r\n{\r\nstruct power_supply *psy;\r\nstruct power_supply *ext;\r\nstruct ab8500_charger *di;\r\nunion power_supply_propval ret;\r\nint i, j;\r\nbool psy_found = false;\r\nstruct ux500_charger *usb_chg;\r\nusb_chg = (struct ux500_charger *)data;\r\npsy = &usb_chg->psy;\r\ndi = to_ab8500_charger_usb_device_info(usb_chg);\r\next = dev_get_drvdata(dev);\r\nfor (i = 0; i < ext->num_supplicants; i++) {\r\nif (!strcmp(ext->supplied_to[i], psy->name))\r\npsy_found = true;\r\n}\r\nif (!psy_found)\r\nreturn 0;\r\nfor (j = 0; j < ext->num_properties; j++) {\r\nenum power_supply_property prop;\r\nprop = ext->properties[j];\r\nif (ext->get_property(ext, prop, &ret))\r\ncontinue;\r\nswitch (prop) {\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nswitch (ext->type) {\r\ncase POWER_SUPPLY_TYPE_BATTERY:\r\ndi->vbat = ret.intval / 1000;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void ab8500_charger_check_vbat_work(struct work_struct *work)\r\n{\r\nint t = 10;\r\nstruct ab8500_charger *di = container_of(work,\r\nstruct ab8500_charger, check_vbat_work.work);\r\nclass_for_each_device(power_supply_class, NULL,\r\n&di->usb_chg.psy, ab8500_charger_get_ext_psy_data);\r\nif (di->old_vbat == 0)\r\ndi->old_vbat = di->vbat;\r\nif (!((di->old_vbat <= VBAT_TRESH_IP_CUR_RED &&\r\ndi->vbat <= VBAT_TRESH_IP_CUR_RED) ||\r\n(di->old_vbat > VBAT_TRESH_IP_CUR_RED &&\r\ndi->vbat > VBAT_TRESH_IP_CUR_RED))) {\r\ndev_dbg(di->dev, "Vbat did cross threshold, curr: %d, new: %d,"\r\n" old: %d\n", di->max_usb_in_curr.usb_type_max,\r\ndi->vbat, di->old_vbat);\r\nab8500_charger_set_vbus_in_curr(di,\r\ndi->max_usb_in_curr.usb_type_max);\r\npower_supply_changed(&di->usb_chg.psy);\r\n}\r\ndi->old_vbat = di->vbat;\r\nif (di->vbat < (VBAT_TRESH_IP_CUR_RED + 100) &&\r\n(di->vbat > (VBAT_TRESH_IP_CUR_RED - 100)))\r\nt = 1;\r\nqueue_delayed_work(di->charger_wq, &di->check_vbat_work, t * HZ);\r\n}\r\nstatic void ab8500_charger_check_hw_failure_work(struct work_struct *work)\r\n{\r\nint ret;\r\nu8 reg_value;\r\nstruct ab8500_charger *di = container_of(work,\r\nstruct ab8500_charger, check_hw_failure_work.work);\r\nif (di->flags.mainextchnotok) {\r\nret = abx500_get_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8500_CH_STATUS2_REG, &reg_value);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s ab8500 read failed\n", __func__);\r\nreturn;\r\n}\r\nif (!(reg_value & MAIN_CH_NOK)) {\r\ndi->flags.mainextchnotok = false;\r\nab8500_power_supply_changed(di, &di->ac_chg.psy);\r\n}\r\n}\r\nif (di->flags.vbus_ovv) {\r\nret = abx500_get_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8500_CH_USBCH_STAT2_REG,\r\n&reg_value);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s ab8500 read failed\n", __func__);\r\nreturn;\r\n}\r\nif (!(reg_value & VBUS_OVV_TH)) {\r\ndi->flags.vbus_ovv = false;\r\nab8500_power_supply_changed(di, &di->usb_chg.psy);\r\n}\r\n}\r\nif (di->flags.mainextchnotok || di->flags.vbus_ovv) {\r\nqueue_delayed_work(di->charger_wq,\r\n&di->check_hw_failure_work, round_jiffies(HZ));\r\n}\r\n}\r\nstatic void ab8500_charger_kick_watchdog_work(struct work_struct *work)\r\n{\r\nint ret;\r\nstruct ab8500_charger *di = container_of(work,\r\nstruct ab8500_charger, kick_wd_work.work);\r\nret = abx500_set_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_CHARG_WD_CTRL, CHARG_WD_KICK);\r\nif (ret)\r\ndev_err(di->dev, "Failed to kick WD!\n");\r\nqueue_delayed_work(di->charger_wq,\r\n&di->kick_wd_work, round_jiffies(WD_KICK_INTERVAL));\r\n}\r\nstatic void ab8500_charger_ac_work(struct work_struct *work)\r\n{\r\nint ret;\r\nstruct ab8500_charger *di = container_of(work,\r\nstruct ab8500_charger, ac_work);\r\nret = ab8500_charger_detect_chargers(di, false);\r\nif (ret < 0)\r\nreturn;\r\nif (ret & AC_PW_CONN) {\r\ndi->ac.charger_connected = 1;\r\ndi->ac_conn = true;\r\n} else {\r\ndi->ac.charger_connected = 0;\r\n}\r\nab8500_power_supply_changed(di, &di->ac_chg.psy);\r\nsysfs_notify(&di->ac_chg.psy.dev->kobj, NULL, "present");\r\n}\r\nstatic void ab8500_charger_usb_attached_work(struct work_struct *work)\r\n{\r\nstruct ab8500_charger *di = container_of(work,\r\nstruct ab8500_charger,\r\nusb_charger_attached_work.work);\r\nint usbch = (USB_CH_VBUSDROP | USB_CH_VBUSDETDBNC);\r\nint ret, i;\r\nu8 statval;\r\nfor (i = 0; i < 10; i++) {\r\nret = abx500_get_register_interruptible(di->dev,\r\nAB8500_CHARGER,\r\nAB8500_CH_USBCH_STAT1_REG,\r\n&statval);\r\nif (ret < 0) {\r\ndev_err(di->dev, "ab8500 read failed %d\n", __LINE__);\r\ngoto reschedule;\r\n}\r\nif ((statval & usbch) != usbch)\r\ngoto reschedule;\r\nmsleep(CHARGER_STATUS_POLL);\r\n}\r\nab8500_charger_usb_en(&di->usb_chg, 0, 0, 0);\r\nmutex_lock(&di->charger_attached_mutex);\r\nmutex_unlock(&di->charger_attached_mutex);\r\nreturn;\r\nreschedule:\r\nqueue_delayed_work(di->charger_wq,\r\n&di->usb_charger_attached_work,\r\nHZ);\r\n}\r\nstatic void ab8500_charger_ac_attached_work(struct work_struct *work)\r\n{\r\nstruct ab8500_charger *di = container_of(work,\r\nstruct ab8500_charger,\r\nac_charger_attached_work.work);\r\nint mainch = (MAIN_CH_STATUS2_MAINCHGDROP |\r\nMAIN_CH_STATUS2_MAINCHARGERDETDBNC);\r\nint ret, i;\r\nu8 statval;\r\nfor (i = 0; i < 10; i++) {\r\nret = abx500_get_register_interruptible(di->dev,\r\nAB8500_CHARGER,\r\nAB8500_CH_STATUS2_REG,\r\n&statval);\r\nif (ret < 0) {\r\ndev_err(di->dev, "ab8500 read failed %d\n", __LINE__);\r\ngoto reschedule;\r\n}\r\nif ((statval & mainch) != mainch)\r\ngoto reschedule;\r\nmsleep(CHARGER_STATUS_POLL);\r\n}\r\nab8500_charger_ac_en(&di->ac_chg, 0, 0, 0);\r\nqueue_work(di->charger_wq, &di->ac_work);\r\nmutex_lock(&di->charger_attached_mutex);\r\nmutex_unlock(&di->charger_attached_mutex);\r\nreturn;\r\nreschedule:\r\nqueue_delayed_work(di->charger_wq,\r\n&di->ac_charger_attached_work,\r\nHZ);\r\n}\r\nstatic void ab8500_charger_detect_usb_type_work(struct work_struct *work)\r\n{\r\nint ret;\r\nstruct ab8500_charger *di = container_of(work,\r\nstruct ab8500_charger, detect_usb_type_work);\r\nret = ab8500_charger_detect_chargers(di, false);\r\nif (ret < 0)\r\nreturn;\r\nif (!(ret & USB_PW_CONN)) {\r\ndev_dbg(di->dev, "%s di->vbus_detected = false\n", __func__);\r\ndi->vbus_detected = false;\r\nab8500_charger_set_usb_connected(di, false);\r\nab8500_power_supply_changed(di, &di->usb_chg.psy);\r\n} else {\r\ndev_dbg(di->dev, "%s di->vbus_detected = true\n", __func__);\r\ndi->vbus_detected = true;\r\nif (is_ab8500_1p1_or_earlier(di->parent)) {\r\nret = ab8500_charger_detect_usb_type(di);\r\nif (!ret) {\r\nab8500_charger_set_usb_connected(di, true);\r\nab8500_power_supply_changed(di,\r\n&di->usb_chg.psy);\r\n}\r\n} else {\r\nif (di->vbus_detected_start) {\r\ndi->vbus_detected_start = false;\r\nret = ab8500_charger_detect_usb_type(di);\r\nif (!ret) {\r\nab8500_charger_set_usb_connected(di,\r\ntrue);\r\nab8500_power_supply_changed(di,\r\n&di->usb_chg.psy);\r\n}\r\n}\r\n}\r\n}\r\n}\r\nstatic void ab8500_charger_usb_link_attach_work(struct work_struct *work)\r\n{\r\nstruct ab8500_charger *di =\r\ncontainer_of(work, struct ab8500_charger, attach_work.work);\r\nint ret;\r\nif (!di->usb.charger_online) {\r\nret = ab8500_charger_set_vbus_in_curr(di,\r\ndi->max_usb_in_curr.usb_type_max);\r\nif (ret)\r\nreturn;\r\n}\r\nab8500_charger_set_usb_connected(di, true);\r\nab8500_power_supply_changed(di, &di->usb_chg.psy);\r\n}\r\nstatic void ab8500_charger_usb_link_status_work(struct work_struct *work)\r\n{\r\nint detected_chargers;\r\nint ret;\r\nu8 val;\r\nu8 link_status;\r\nstruct ab8500_charger *di = container_of(work,\r\nstruct ab8500_charger, usb_link_status_work);\r\ndetected_chargers = ab8500_charger_detect_chargers(di, false);\r\nif (detected_chargers < 0)\r\nreturn;\r\nif (is_ab8500(di->parent))\r\nret = abx500_get_register_interruptible(di->dev, AB8500_USB,\r\nAB8500_USB_LINE_STAT_REG, &val);\r\nelse\r\nret = abx500_get_register_interruptible(di->dev, AB8500_USB,\r\nAB8500_USB_LINK1_STAT_REG, &val);\r\nif (ret >= 0)\r\ndev_dbg(di->dev, "UsbLineStatus register = 0x%02x\n", val);\r\nelse\r\ndev_dbg(di->dev, "Error reading USB link status\n");\r\nif (is_ab8500(di->parent))\r\nlink_status = AB8500_USB_LINK_STATUS;\r\nelse\r\nlink_status = AB8505_USB_LINK_STATUS;\r\nif (detected_chargers & USB_PW_CONN) {\r\nif (((val & link_status) >> USB_LINK_STATUS_SHIFT) ==\r\nUSB_STAT_NOT_VALID_LINK &&\r\ndi->invalid_charger_detect_state == 0) {\r\ndev_dbg(di->dev,\r\n"Invalid charger detected, state= 0\n");\r\nabx500_mask_and_set_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8500_USBCH_CTRL1_REG,\r\nUSB_CH_ENA, USB_CH_ENA);\r\nabx500_mask_and_set_register_interruptible(di->dev,\r\nAB8500_USB, AB8500_USB_LINE_CTRL2_REG,\r\nUSB_CH_DET, USB_CH_DET);\r\ndi->invalid_charger_detect_state = 1;\r\nreturn;\r\n}\r\nif (di->invalid_charger_detect_state == 1) {\r\ndev_dbg(di->dev,\r\n"Invalid charger detected, state= 1\n");\r\nabx500_mask_and_set_register_interruptible(di->dev,\r\nAB8500_USB, AB8500_USB_LINE_CTRL2_REG,\r\nUSB_CH_DET, 0x00);\r\nif (is_ab8500(di->parent))\r\nret = abx500_get_register_interruptible(di->dev,\r\nAB8500_USB, AB8500_USB_LINE_STAT_REG,\r\n&val);\r\nelse\r\nret = abx500_get_register_interruptible(di->dev,\r\nAB8500_USB, AB8500_USB_LINK1_STAT_REG,\r\n&val);\r\ndev_dbg(di->dev, "USB link status= 0x%02x\n",\r\n(val & link_status) >> USB_LINK_STATUS_SHIFT);\r\ndi->invalid_charger_detect_state = 2;\r\n}\r\n} else {\r\ndi->invalid_charger_detect_state = 0;\r\n}\r\nif (!(detected_chargers & USB_PW_CONN)) {\r\ndi->vbus_detected = false;\r\nab8500_charger_set_usb_connected(di, false);\r\nab8500_power_supply_changed(di, &di->usb_chg.psy);\r\nreturn;\r\n}\r\ndev_dbg(di->dev,"%s di->vbus_detected = true\n",__func__);\r\ndi->vbus_detected = true;\r\nret = ab8500_charger_read_usb_type(di);\r\nif (ret) {\r\nif (ret == -ENXIO) {\r\nab8500_charger_set_usb_connected(di, false);\r\nab8500_power_supply_changed(di, &di->usb_chg.psy);\r\n}\r\nreturn;\r\n}\r\nif (di->usb_device_is_unrecognised) {\r\ndev_dbg(di->dev,\r\n"Potential Legacy Charger device. "\r\n"Delay work for %d msec for USB enum "\r\n"to finish",\r\nWAIT_ACA_RID_ENUMERATION);\r\nqueue_delayed_work(di->charger_wq,\r\n&di->attach_work,\r\nmsecs_to_jiffies(WAIT_ACA_RID_ENUMERATION));\r\n} else if (di->is_aca_rid == 1) {\r\ndi->is_aca_rid++;\r\ndev_dbg(di->dev,\r\n"%s Wait %d msec for USB enum to finish",\r\n__func__, WAIT_ACA_RID_ENUMERATION);\r\nqueue_delayed_work(di->charger_wq,\r\n&di->attach_work,\r\nmsecs_to_jiffies(WAIT_ACA_RID_ENUMERATION));\r\n} else {\r\nqueue_delayed_work(di->charger_wq,\r\n&di->attach_work,\r\n0);\r\n}\r\n}\r\nstatic void ab8500_charger_usb_state_changed_work(struct work_struct *work)\r\n{\r\nint ret;\r\nunsigned long flags;\r\nstruct ab8500_charger *di = container_of(work,\r\nstruct ab8500_charger, usb_state_changed_work.work);\r\nif (!di->vbus_detected) {\r\ndev_dbg(di->dev,\r\n"%s !di->vbus_detected\n",\r\n__func__);\r\nreturn;\r\n}\r\nspin_lock_irqsave(&di->usb_state.usb_lock, flags);\r\ndi->usb_state.state = di->usb_state.state_tmp;\r\ndi->usb_state.usb_current = di->usb_state.usb_current_tmp;\r\nspin_unlock_irqrestore(&di->usb_state.usb_lock, flags);\r\ndev_dbg(di->dev, "%s USB state: 0x%02x mA: %d\n",\r\n__func__, di->usb_state.state, di->usb_state.usb_current);\r\nswitch (di->usb_state.state) {\r\ncase AB8500_BM_USB_STATE_RESET_HS:\r\ncase AB8500_BM_USB_STATE_RESET_FS:\r\ncase AB8500_BM_USB_STATE_SUSPEND:\r\ncase AB8500_BM_USB_STATE_MAX:\r\nab8500_charger_set_usb_connected(di, false);\r\nab8500_power_supply_changed(di, &di->usb_chg.psy);\r\nbreak;\r\ncase AB8500_BM_USB_STATE_RESUME:\r\nmsleep(1000);\r\ncase AB8500_BM_USB_STATE_CONFIGURED:\r\nif (!ab8500_charger_get_usb_cur(di)) {\r\nret = ab8500_charger_set_vbus_in_curr(di,\r\ndi->max_usb_in_curr.usb_type_max);\r\nif (ret)\r\nreturn;\r\nab8500_charger_set_usb_connected(di, true);\r\nab8500_power_supply_changed(di, &di->usb_chg.psy);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n};\r\n}\r\nstatic void ab8500_charger_check_usbchargernotok_work(struct work_struct *work)\r\n{\r\nint ret;\r\nu8 reg_value;\r\nbool prev_status;\r\nstruct ab8500_charger *di = container_of(work,\r\nstruct ab8500_charger, check_usbchgnotok_work.work);\r\nret = abx500_get_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8500_CH_USBCH_STAT2_REG, &reg_value);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s ab8500 read failed\n", __func__);\r\nreturn;\r\n}\r\nprev_status = di->flags.usbchargernotok;\r\nif (reg_value & VBUS_CH_NOK) {\r\ndi->flags.usbchargernotok = true;\r\nqueue_delayed_work(di->charger_wq,\r\n&di->check_usbchgnotok_work, HZ);\r\n} else {\r\ndi->flags.usbchargernotok = false;\r\ndi->flags.vbus_collapse = false;\r\n}\r\nif (prev_status != di->flags.usbchargernotok)\r\nab8500_power_supply_changed(di, &di->usb_chg.psy);\r\n}\r\nstatic void ab8500_charger_check_main_thermal_prot_work(\r\nstruct work_struct *work)\r\n{\r\nint ret;\r\nu8 reg_value;\r\nstruct ab8500_charger *di = container_of(work,\r\nstruct ab8500_charger, check_main_thermal_prot_work);\r\nret = abx500_get_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8500_CH_STATUS2_REG, &reg_value);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s ab8500 read failed\n", __func__);\r\nreturn;\r\n}\r\nif (reg_value & MAIN_CH_TH_PROT)\r\ndi->flags.main_thermal_prot = true;\r\nelse\r\ndi->flags.main_thermal_prot = false;\r\nab8500_power_supply_changed(di, &di->ac_chg.psy);\r\n}\r\nstatic void ab8500_charger_check_usb_thermal_prot_work(\r\nstruct work_struct *work)\r\n{\r\nint ret;\r\nu8 reg_value;\r\nstruct ab8500_charger *di = container_of(work,\r\nstruct ab8500_charger, check_usb_thermal_prot_work);\r\nret = abx500_get_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8500_CH_USBCH_STAT2_REG, &reg_value);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s ab8500 read failed\n", __func__);\r\nreturn;\r\n}\r\nif (reg_value & USB_CH_TH_PROT)\r\ndi->flags.usb_thermal_prot = true;\r\nelse\r\ndi->flags.usb_thermal_prot = false;\r\nab8500_power_supply_changed(di, &di->usb_chg.psy);\r\n}\r\nstatic irqreturn_t ab8500_charger_mainchunplugdet_handler(int irq, void *_di)\r\n{\r\nstruct ab8500_charger *di = _di;\r\ndev_dbg(di->dev, "Main charger unplugged\n");\r\nqueue_work(di->charger_wq, &di->ac_work);\r\ncancel_delayed_work_sync(&di->ac_charger_attached_work);\r\nmutex_lock(&di->charger_attached_mutex);\r\nmutex_unlock(&di->charger_attached_mutex);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_charger_mainchplugdet_handler(int irq, void *_di)\r\n{\r\nstruct ab8500_charger *di = _di;\r\ndev_dbg(di->dev, "Main charger plugged\n");\r\nqueue_work(di->charger_wq, &di->ac_work);\r\nmutex_lock(&di->charger_attached_mutex);\r\nmutex_unlock(&di->charger_attached_mutex);\r\nif (is_ab8500(di->parent))\r\nqueue_delayed_work(di->charger_wq,\r\n&di->ac_charger_attached_work,\r\nHZ);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_charger_mainextchnotok_handler(int irq, void *_di)\r\n{\r\nstruct ab8500_charger *di = _di;\r\ndev_dbg(di->dev, "Main charger not ok\n");\r\ndi->flags.mainextchnotok = true;\r\nab8500_power_supply_changed(di, &di->ac_chg.psy);\r\nqueue_delayed_work(di->charger_wq, &di->check_hw_failure_work, 0);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_charger_mainchthprotr_handler(int irq, void *_di)\r\n{\r\nstruct ab8500_charger *di = _di;\r\ndev_dbg(di->dev,\r\n"Die temp above Main charger thermal protection threshold\n");\r\nqueue_work(di->charger_wq, &di->check_main_thermal_prot_work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_charger_mainchthprotf_handler(int irq, void *_di)\r\n{\r\nstruct ab8500_charger *di = _di;\r\ndev_dbg(di->dev,\r\n"Die temp ok for Main charger thermal protection threshold\n");\r\nqueue_work(di->charger_wq, &di->check_main_thermal_prot_work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void ab8500_charger_vbus_drop_end_work(struct work_struct *work)\r\n{\r\nstruct ab8500_charger *di = container_of(work,\r\nstruct ab8500_charger, vbus_drop_end_work.work);\r\nint ret, curr;\r\nu8 reg_value;\r\ndi->flags.vbus_drop_end = false;\r\nabx500_set_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8500_CHARGER_CTRL, 0x01);\r\nif (is_ab8540(di->parent))\r\nret = abx500_get_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8540_CH_USBCH_STAT3_REG, &reg_value);\r\nelse\r\nret = abx500_get_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_CH_USBCH_STAT2_REG, &reg_value);\r\nif (ret < 0) {\r\ndev_err(di->dev, "%s read failed\n", __func__);\r\nreturn;\r\n}\r\nif (is_ab8540(di->parent))\r\ncurr = di->bm->chg_input_curr[\r\nreg_value & AB8540_AUTO_VBUS_IN_CURR_MASK];\r\nelse\r\ncurr = di->bm->chg_input_curr[\r\nreg_value >> AUTO_VBUS_IN_CURR_LIM_SHIFT];\r\nif (di->max_usb_in_curr.calculated_max != curr) {\r\ndi->max_usb_in_curr.calculated_max = curr;\r\ndev_dbg(di->dev,\r\n"VBUS input current limiting to %d mA\n",\r\ndi->max_usb_in_curr.calculated_max);\r\n} else {\r\ndi->max_usb_in_curr.set_max =\r\ndi->max_usb_in_curr.calculated_max;\r\ndev_dbg(di->dev,\r\n"VBUS input current limited to %d mA\n",\r\ndi->max_usb_in_curr.set_max);\r\n}\r\nif (di->usb.charger_connected)\r\nab8500_charger_set_vbus_in_curr(di,\r\ndi->max_usb_in_curr.usb_type_max);\r\n}\r\nstatic irqreturn_t ab8500_charger_vbusdetf_handler(int irq, void *_di)\r\n{\r\nstruct ab8500_charger *di = _di;\r\ndi->vbus_detected = false;\r\ndev_dbg(di->dev, "VBUS falling detected\n");\r\nqueue_work(di->charger_wq, &di->detect_usb_type_work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_charger_vbusdetr_handler(int irq, void *_di)\r\n{\r\nstruct ab8500_charger *di = _di;\r\ndi->vbus_detected = true;\r\ndev_dbg(di->dev, "VBUS rising detected\n");\r\nqueue_work(di->charger_wq, &di->detect_usb_type_work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_charger_usblinkstatus_handler(int irq, void *_di)\r\n{\r\nstruct ab8500_charger *di = _di;\r\ndev_dbg(di->dev, "USB link status changed\n");\r\nqueue_work(di->charger_wq, &di->usb_link_status_work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_charger_usbchthprotr_handler(int irq, void *_di)\r\n{\r\nstruct ab8500_charger *di = _di;\r\ndev_dbg(di->dev,\r\n"Die temp above USB charger thermal protection threshold\n");\r\nqueue_work(di->charger_wq, &di->check_usb_thermal_prot_work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_charger_usbchthprotf_handler(int irq, void *_di)\r\n{\r\nstruct ab8500_charger *di = _di;\r\ndev_dbg(di->dev,\r\n"Die temp ok for USB charger thermal protection threshold\n");\r\nqueue_work(di->charger_wq, &di->check_usb_thermal_prot_work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_charger_usbchargernotokr_handler(int irq, void *_di)\r\n{\r\nstruct ab8500_charger *di = _di;\r\ndev_dbg(di->dev, "Not allowed USB charger detected\n");\r\nqueue_delayed_work(di->charger_wq, &di->check_usbchgnotok_work, 0);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_charger_chwdexp_handler(int irq, void *_di)\r\n{\r\nstruct ab8500_charger *di = _di;\r\ndev_dbg(di->dev, "Charger watchdog expired\n");\r\nif (di->ac.charger_online) {\r\ndi->ac.wd_expired = true;\r\nab8500_power_supply_changed(di, &di->ac_chg.psy);\r\n}\r\nif (di->usb.charger_online) {\r\ndi->usb.wd_expired = true;\r\nab8500_power_supply_changed(di, &di->usb_chg.psy);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_charger_vbuschdropend_handler(int irq, void *_di)\r\n{\r\nstruct ab8500_charger *di = _di;\r\ndev_dbg(di->dev, "VBUS charger drop ended\n");\r\ndi->flags.vbus_drop_end = true;\r\nqueue_delayed_work(di->charger_wq, &di->vbus_drop_end_work,\r\nround_jiffies(VBUS_IN_CURR_LIM_RETRY_SET_TIME * HZ));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_charger_vbusovv_handler(int irq, void *_di)\r\n{\r\nstruct ab8500_charger *di = _di;\r\ndev_dbg(di->dev, "VBUS overvoltage detected\n");\r\ndi->flags.vbus_ovv = true;\r\nab8500_power_supply_changed(di, &di->usb_chg.psy);\r\nqueue_delayed_work(di->charger_wq, &di->check_hw_failure_work, 0);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ab8500_charger_ac_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct ab8500_charger *di;\r\nint ret;\r\ndi = to_ab8500_charger_ac_device_info(psy_to_ux500_charger(psy));\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nif (di->flags.mainextchnotok)\r\nval->intval = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\r\nelse if (di->ac.wd_expired || di->usb.wd_expired)\r\nval->intval = POWER_SUPPLY_HEALTH_DEAD;\r\nelse if (di->flags.main_thermal_prot)\r\nval->intval = POWER_SUPPLY_HEALTH_OVERHEAT;\r\nelse\r\nval->intval = POWER_SUPPLY_HEALTH_GOOD;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = di->ac.charger_online;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = di->ac.charger_connected;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nret = ab8500_charger_get_ac_voltage(di);\r\nif (ret >= 0)\r\ndi->ac.charger_voltage = ret;\r\nval->intval = di->ac.charger_voltage * 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_AVG:\r\ndi->ac.cv_active = ab8500_charger_ac_cv(di);\r\nval->intval = di->ac.cv_active;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_NOW:\r\nret = ab8500_charger_get_ac_current(di);\r\nif (ret >= 0)\r\ndi->ac.charger_current = ret;\r\nval->intval = di->ac.charger_current * 1000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab8500_charger_usb_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct ab8500_charger *di;\r\nint ret;\r\ndi = to_ab8500_charger_usb_device_info(psy_to_ux500_charger(psy));\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nif (di->flags.usbchargernotok)\r\nval->intval = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\r\nelse if (di->ac.wd_expired || di->usb.wd_expired)\r\nval->intval = POWER_SUPPLY_HEALTH_DEAD;\r\nelse if (di->flags.usb_thermal_prot)\r\nval->intval = POWER_SUPPLY_HEALTH_OVERHEAT;\r\nelse if (di->flags.vbus_ovv)\r\nval->intval = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\r\nelse\r\nval->intval = POWER_SUPPLY_HEALTH_GOOD;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = di->usb.charger_online;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = di->usb.charger_connected;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nret = ab8500_charger_get_vbus_voltage(di);\r\nif (ret >= 0)\r\ndi->usb.charger_voltage = ret;\r\nval->intval = di->usb.charger_voltage * 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_AVG:\r\ndi->usb.cv_active = ab8500_charger_usb_cv(di);\r\nval->intval = di->usb.cv_active;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_NOW:\r\nret = ab8500_charger_get_usb_current(di);\r\nif (ret >= 0)\r\ndi->usb.charger_current = ret;\r\nval->intval = di->usb.charger_current * 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_AVG:\r\nif (di->flags.vbus_collapse)\r\nval->intval = 1;\r\nelse\r\nval->intval = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab8500_charger_init_hw_registers(struct ab8500_charger *di)\r\n{\r\nint ret = 0;\r\nu8 bup_vch_range = 0, vbup33_vrtcn = 0;\r\nif (!is_ab8500_1p1_or_earlier(di->parent)) {\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_CHARGER,\r\nAB8500_CH_VOLT_LVL_MAX_REG, CH_VOL_LVL_4P6);\r\nif (ret) {\r\ndev_err(di->dev,\r\n"failed to set CH_VOLT_LVL_MAX_REG\n");\r\ngoto out;\r\n}\r\nif (is_ab8540(di->parent))\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8500_CH_OPT_CRNTLVL_MAX_REG,\r\nCH_OP_CUR_LVL_2P);\r\nelse\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8500_CH_OPT_CRNTLVL_MAX_REG,\r\nCH_OP_CUR_LVL_1P6);\r\nif (ret) {\r\ndev_err(di->dev,\r\n"failed to set CH_OPT_CRNTLVL_MAX_REG\n");\r\ngoto out;\r\n}\r\n}\r\nif (is_ab9540_2p0(di->parent) || is_ab9540_3p0(di->parent)\r\n|| is_ab8505_2p0(di->parent) || is_ab8540(di->parent))\r\nret = abx500_mask_and_set_register_interruptible(di->dev,\r\nAB8500_CHARGER,\r\nAB8500_USBCH_CTRL2_REG,\r\nVBUS_AUTO_IN_CURR_LIM_ENA,\r\nVBUS_AUTO_IN_CURR_LIM_ENA);\r\nelse\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_CHARGER,\r\nAB8500_USBCH_CTRL2_REG,\r\nVBUS_OVV_SELECT_6P3V | VBUS_AUTO_IN_CURR_LIM_ENA);\r\nif (ret) {\r\ndev_err(di->dev,\r\n"failed to set automatic current limitation\n");\r\ngoto out;\r\n}\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_OTP_EMUL, AB8500_OTP_CONF_15, OTP_ENABLE_WD);\r\nif (ret) {\r\ndev_err(di->dev, "failed to enable main WD in OTP\n");\r\ngoto out;\r\n}\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_SYS_CTRL2_BLOCK,\r\nAB8500_MAIN_WDOG_CTRL_REG, MAIN_WDOG_ENA);\r\nif (ret) {\r\ndev_err(di->dev, "faile to enable main watchdog\n");\r\ngoto out;\r\n}\r\nudelay(63);\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_SYS_CTRL2_BLOCK,\r\nAB8500_MAIN_WDOG_CTRL_REG,\r\n(MAIN_WDOG_ENA | MAIN_WDOG_KICK));\r\nif (ret) {\r\ndev_err(di->dev, "failed to kick main watchdog\n");\r\ngoto out;\r\n}\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_SYS_CTRL2_BLOCK,\r\nAB8500_MAIN_WDOG_CTRL_REG, MAIN_WDOG_DIS);\r\nif (ret) {\r\ndev_err(di->dev, "failed to disable main watchdog\n");\r\ngoto out;\r\n}\r\nret = abx500_set_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_CH_WD_TIMER_REG, WD_TIMER);\r\nif (ret) {\r\ndev_err(di->dev, "failed to set charger watchdog timeout\n");\r\ngoto out;\r\n}\r\nret = ab8500_charger_led_en(di, false);\r\nif (ret < 0) {\r\ndev_err(di->dev, "failed to disable LED\n");\r\ngoto out;\r\n}\r\nif (di->bm->bkup_bat_v > BUP_VCH_SEL_3P1V)\r\nbup_vch_range = BUP_VCH_RANGE;\r\nif (di->bm->bkup_bat_v == BUP_VCH_SEL_3P3V)\r\nvbup33_vrtcn = VBUP33_VRTCN;\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_RTC,\r\nAB8500_RTC_BACKUP_CHG_REG,\r\n(di->bm->bkup_bat_v & 0x3) | di->bm->bkup_bat_i);\r\nif (ret) {\r\ndev_err(di->dev, "failed to setup backup battery charging\n");\r\ngoto out;\r\n}\r\nif (is_ab8540(di->parent)) {\r\nret = abx500_set_register_interruptible(di->dev,\r\nAB8500_RTC,\r\nAB8500_RTC_CTRL1_REG,\r\nbup_vch_range | vbup33_vrtcn);\r\nif (ret) {\r\ndev_err(di->dev,\r\n"failed to setup backup battery charging\n");\r\ngoto out;\r\n}\r\n}\r\nabx500_mask_and_set_register_interruptible(di->dev,\r\nAB8500_RTC, AB8500_RTC_CTRL_REG,\r\nRTC_BUP_CH_ENA, RTC_BUP_CH_ENA);\r\nif (ret < 0)\r\ndev_err(di->dev, "%s mask and set failed\n", __func__);\r\nif (is_ab8540(di->parent)) {\r\nret = abx500_mask_and_set_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8540_USB_PP_MODE_REG,\r\nBUS_VSYS_VOL_SELECT_MASK, BUS_VSYS_VOL_SELECT_3P6V);\r\nif (ret) {\r\ndev_err(di->dev,\r\n"failed to setup usb power path vsys voltage\n");\r\ngoto out;\r\n}\r\nret = abx500_mask_and_set_register_interruptible(di->dev,\r\nAB8500_CHARGER, AB8540_USB_PP_CHR_REG,\r\nBUS_PP_PRECHG_CURRENT_MASK, 0);\r\nif (ret) {\r\ndev_err(di->dev,\r\n"failed to setup usb power path prechage current\n");\r\ngoto out;\r\n}\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nstatic int ab8500_charger_usb_notifier_call(struct notifier_block *nb,\r\nunsigned long event, void *power)\r\n{\r\nstruct ab8500_charger *di =\r\ncontainer_of(nb, struct ab8500_charger, nb);\r\nenum ab8500_usb_state bm_usb_state;\r\nunsigned mA = *((unsigned *)power);\r\nif (!di)\r\nreturn NOTIFY_DONE;\r\nif (event != USB_EVENT_VBUS) {\r\ndev_dbg(di->dev, "not a standard host, returning\n");\r\nreturn NOTIFY_DONE;\r\n}\r\nif ((di->usb_state.usb_current == 2) && (mA > 2))\r\nbm_usb_state = AB8500_BM_USB_STATE_RESUME;\r\nelse if (mA == 0)\r\nbm_usb_state = AB8500_BM_USB_STATE_RESET_HS;\r\nelse if (mA == 2)\r\nbm_usb_state = AB8500_BM_USB_STATE_SUSPEND;\r\nelse if (mA >= 8)\r\nbm_usb_state = AB8500_BM_USB_STATE_CONFIGURED;\r\nelse\r\nbm_usb_state = AB8500_BM_USB_STATE_RESET_FS;\r\ndev_dbg(di->dev, "%s usb_state: 0x%02x mA: %d\n",\r\n__func__, bm_usb_state, mA);\r\nspin_lock(&di->usb_state.usb_lock);\r\ndi->usb_state.state_tmp = bm_usb_state;\r\ndi->usb_state.usb_current_tmp = mA;\r\nspin_unlock(&di->usb_state.usb_lock);\r\nqueue_delayed_work(di->charger_wq, &di->usb_state_changed_work, HZ/2);\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int ab8500_charger_resume(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct ab8500_charger *di = platform_get_drvdata(pdev);\r\nif (di->ac_conn && is_ab8500_1p1_or_earlier(di->parent)) {\r\nret = abx500_set_register_interruptible(di->dev, AB8500_CHARGER,\r\nAB8500_CHARG_WD_CTRL, CHARG_WD_KICK);\r\nif (ret)\r\ndev_err(di->dev, "Failed to kick WD!\n");\r\nqueue_delayed_work(di->charger_wq, &di->kick_wd_work,\r\nround_jiffies(WD_KICK_INTERVAL));\r\n}\r\nif (di->flags.mainextchnotok || di->flags.vbus_ovv) {\r\nqueue_delayed_work(di->charger_wq,\r\n&di->check_hw_failure_work, 0);\r\n}\r\nif (di->flags.vbus_drop_end)\r\nqueue_delayed_work(di->charger_wq, &di->vbus_drop_end_work, 0);\r\nreturn 0;\r\n}\r\nstatic int ab8500_charger_suspend(struct platform_device *pdev,\r\npm_message_t state)\r\n{\r\nstruct ab8500_charger *di = platform_get_drvdata(pdev);\r\ncancel_delayed_work(&di->check_hw_failure_work);\r\ncancel_delayed_work(&di->vbus_drop_end_work);\r\nflush_delayed_work(&di->attach_work);\r\nflush_delayed_work(&di->usb_charger_attached_work);\r\nflush_delayed_work(&di->ac_charger_attached_work);\r\nflush_delayed_work(&di->check_usbchgnotok_work);\r\nflush_delayed_work(&di->check_vbat_work);\r\nflush_delayed_work(&di->kick_wd_work);\r\nflush_work(&di->usb_link_status_work);\r\nflush_work(&di->ac_work);\r\nflush_work(&di->detect_usb_type_work);\r\nif (atomic_read(&di->current_stepping_sessions))\r\nreturn -EAGAIN;\r\nreturn 0;\r\n}\r\nstatic int ab8500_charger_remove(struct platform_device *pdev)\r\n{\r\nstruct ab8500_charger *di = platform_get_drvdata(pdev);\r\nint i, irq, ret;\r\nab8500_charger_ac_en(&di->ac_chg, false, 0, 0);\r\nab8500_charger_usb_en(&di->usb_chg, false, 0, 0);\r\nfor (i = 0; i < ARRAY_SIZE(ab8500_charger_irq); i++) {\r\nirq = platform_get_irq_byname(pdev, ab8500_charger_irq[i].name);\r\nfree_irq(irq, di);\r\n}\r\nret = abx500_mask_and_set_register_interruptible(di->dev,\r\nAB8500_RTC, AB8500_RTC_CTRL_REG, RTC_BUP_CH_ENA, 0);\r\nif (ret < 0)\r\ndev_err(di->dev, "%s mask and set failed\n", __func__);\r\nusb_unregister_notifier(di->usb_phy, &di->nb);\r\nusb_put_phy(di->usb_phy);\r\ndestroy_workqueue(di->charger_wq);\r\nif (!di->ac_chg.enabled)\r\nblocking_notifier_chain_unregister(\r\n&charger_notifier_list, &charger_nb);\r\nflush_scheduled_work();\r\nif (di->usb_chg.enabled)\r\npower_supply_unregister(&di->usb_chg.psy);\r\nif (di->ac_chg.enabled && !di->ac_chg.external)\r\npower_supply_unregister(&di->ac_chg.psy);\r\nreturn 0;\r\n}\r\nstatic int ab8500_charger_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct abx500_bm_data *plat = pdev->dev.platform_data;\r\nstruct ab8500_charger *di;\r\nint irq, i, charger_status, ret = 0, ch_stat;\r\ndi = devm_kzalloc(&pdev->dev, sizeof(*di), GFP_KERNEL);\r\nif (!di) {\r\ndev_err(&pdev->dev, "%s no mem for ab8500_charger\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\nif (!plat) {\r\ndev_err(&pdev->dev, "no battery management data supplied\n");\r\nreturn -EINVAL;\r\n}\r\ndi->bm = plat;\r\nif (np) {\r\nret = ab8500_bm_of_probe(&pdev->dev, np, di->bm);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to get battery information\n");\r\nreturn ret;\r\n}\r\ndi->autopower_cfg = of_property_read_bool(np, "autopower_cfg");\r\n} else\r\ndi->autopower_cfg = false;\r\ndi->dev = &pdev->dev;\r\ndi->parent = dev_get_drvdata(pdev->dev.parent);\r\ndi->gpadc = ab8500_gpadc_get("ab8500-gpadc.0");\r\nspin_lock_init(&di->usb_state.usb_lock);\r\nmutex_init(&di->usb_ipt_crnt_lock);\r\ndi->autopower = false;\r\ndi->invalid_charger_detect_state = 0;\r\ndi->ac_chg.psy.name = "ab8500_ac";\r\ndi->ac_chg.psy.type = POWER_SUPPLY_TYPE_MAINS;\r\ndi->ac_chg.psy.properties = ab8500_charger_ac_props;\r\ndi->ac_chg.psy.num_properties = ARRAY_SIZE(ab8500_charger_ac_props);\r\ndi->ac_chg.psy.get_property = ab8500_charger_ac_get_property;\r\ndi->ac_chg.psy.supplied_to = supply_interface;\r\ndi->ac_chg.psy.num_supplicants = ARRAY_SIZE(supply_interface),\r\ndi->ac_chg.ops.enable = &ab8500_charger_ac_en;\r\ndi->ac_chg.ops.check_enable = &ab8500_charger_ac_check_enable;\r\ndi->ac_chg.ops.kick_wd = &ab8500_charger_watchdog_kick;\r\ndi->ac_chg.ops.update_curr = &ab8500_charger_update_charger_current;\r\ndi->ac_chg.max_out_volt = ab8500_charger_voltage_map[\r\nARRAY_SIZE(ab8500_charger_voltage_map) - 1];\r\ndi->ac_chg.max_out_curr =\r\ndi->bm->chg_output_curr[di->bm->n_chg_out_curr - 1];\r\ndi->ac_chg.wdt_refresh = CHG_WD_INTERVAL;\r\ndi->ac_chg.enabled = di->bm->ac_enabled;\r\ndi->ac_chg.external = false;\r\nif (!di->ac_chg.enabled)\r\nblocking_notifier_chain_register(\r\n&charger_notifier_list, &charger_nb);\r\ndi->usb_chg.psy.name = "ab8500_usb";\r\ndi->usb_chg.psy.type = POWER_SUPPLY_TYPE_USB;\r\ndi->usb_chg.psy.properties = ab8500_charger_usb_props;\r\ndi->usb_chg.psy.num_properties = ARRAY_SIZE(ab8500_charger_usb_props);\r\ndi->usb_chg.psy.get_property = ab8500_charger_usb_get_property;\r\ndi->usb_chg.psy.supplied_to = supply_interface;\r\ndi->usb_chg.psy.num_supplicants = ARRAY_SIZE(supply_interface),\r\ndi->usb_chg.ops.enable = &ab8500_charger_usb_en;\r\ndi->usb_chg.ops.check_enable = &ab8500_charger_usb_check_enable;\r\ndi->usb_chg.ops.kick_wd = &ab8500_charger_watchdog_kick;\r\ndi->usb_chg.ops.update_curr = &ab8500_charger_update_charger_current;\r\ndi->usb_chg.ops.pp_enable = &ab8540_charger_power_path_enable;\r\ndi->usb_chg.ops.pre_chg_enable = &ab8540_charger_usb_pre_chg_enable;\r\ndi->usb_chg.max_out_volt = ab8500_charger_voltage_map[\r\nARRAY_SIZE(ab8500_charger_voltage_map) - 1];\r\ndi->usb_chg.max_out_curr =\r\ndi->bm->chg_output_curr[di->bm->n_chg_out_curr - 1];\r\ndi->usb_chg.wdt_refresh = CHG_WD_INTERVAL;\r\ndi->usb_chg.enabled = di->bm->usb_enabled;\r\ndi->usb_chg.external = false;\r\ndi->usb_chg.power_path = di->bm->usb_power_path;\r\ndi->usb_state.usb_current = -1;\r\ndi->charger_wq =\r\ncreate_singlethread_workqueue("ab8500_charger_wq");\r\nif (di->charger_wq == NULL) {\r\ndev_err(di->dev, "failed to create work queue\n");\r\nreturn -ENOMEM;\r\n}\r\nmutex_init(&di->charger_attached_mutex);\r\nINIT_DEFERRABLE_WORK(&di->check_hw_failure_work,\r\nab8500_charger_check_hw_failure_work);\r\nINIT_DEFERRABLE_WORK(&di->check_usbchgnotok_work,\r\nab8500_charger_check_usbchargernotok_work);\r\nINIT_DELAYED_WORK(&di->ac_charger_attached_work,\r\nab8500_charger_ac_attached_work);\r\nINIT_DELAYED_WORK(&di->usb_charger_attached_work,\r\nab8500_charger_usb_attached_work);\r\nINIT_DEFERRABLE_WORK(&di->kick_wd_work,\r\nab8500_charger_kick_watchdog_work);\r\nINIT_DEFERRABLE_WORK(&di->check_vbat_work,\r\nab8500_charger_check_vbat_work);\r\nINIT_DELAYED_WORK(&di->attach_work,\r\nab8500_charger_usb_link_attach_work);\r\nINIT_DELAYED_WORK(&di->usb_state_changed_work,\r\nab8500_charger_usb_state_changed_work);\r\nINIT_DELAYED_WORK(&di->vbus_drop_end_work,\r\nab8500_charger_vbus_drop_end_work);\r\nINIT_WORK(&di->usb_link_status_work,\r\nab8500_charger_usb_link_status_work);\r\nINIT_WORK(&di->ac_work, ab8500_charger_ac_work);\r\nINIT_WORK(&di->detect_usb_type_work,\r\nab8500_charger_detect_usb_type_work);\r\nINIT_WORK(&di->check_main_thermal_prot_work,\r\nab8500_charger_check_main_thermal_prot_work);\r\nINIT_WORK(&di->check_usb_thermal_prot_work,\r\nab8500_charger_check_usb_thermal_prot_work);\r\ndi->regu = devm_regulator_get(di->dev, "vddadc");\r\nif (IS_ERR(di->regu)) {\r\nret = PTR_ERR(di->regu);\r\ndev_err(di->dev, "failed to get vddadc regulator\n");\r\ngoto free_charger_wq;\r\n}\r\nret = ab8500_charger_init_hw_registers(di);\r\nif (ret) {\r\ndev_err(di->dev, "failed to initialize ABB registers\n");\r\ngoto free_charger_wq;\r\n}\r\nif (di->ac_chg.enabled) {\r\nret = power_supply_register(di->dev, &di->ac_chg.psy);\r\nif (ret) {\r\ndev_err(di->dev, "failed to register AC charger\n");\r\ngoto free_charger_wq;\r\n}\r\n}\r\nif (di->usb_chg.enabled) {\r\nret = power_supply_register(di->dev, &di->usb_chg.psy);\r\nif (ret) {\r\ndev_err(di->dev, "failed to register USB charger\n");\r\ngoto free_ac;\r\n}\r\n}\r\ndi->usb_phy = usb_get_phy(USB_PHY_TYPE_USB2);\r\nif (IS_ERR_OR_NULL(di->usb_phy)) {\r\ndev_err(di->dev, "failed to get usb transceiver\n");\r\nret = -EINVAL;\r\ngoto free_usb;\r\n}\r\ndi->nb.notifier_call = ab8500_charger_usb_notifier_call;\r\nret = usb_register_notifier(di->usb_phy, &di->nb);\r\nif (ret) {\r\ndev_err(di->dev, "failed to register usb notifier\n");\r\ngoto put_usb_phy;\r\n}\r\ncharger_status = ab8500_charger_detect_chargers(di, true);\r\nif (charger_status & AC_PW_CONN) {\r\ndi->ac.charger_connected = 1;\r\ndi->ac_conn = true;\r\nab8500_power_supply_changed(di, &di->ac_chg.psy);\r\nsysfs_notify(&di->ac_chg.psy.dev->kobj, NULL, "present");\r\n}\r\nif (charger_status & USB_PW_CONN) {\r\ndi->vbus_detected = true;\r\ndi->vbus_detected_start = true;\r\nqueue_work(di->charger_wq,\r\n&di->detect_usb_type_work);\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(ab8500_charger_irq); i++) {\r\nirq = platform_get_irq_byname(pdev, ab8500_charger_irq[i].name);\r\nret = request_threaded_irq(irq, NULL, ab8500_charger_irq[i].isr,\r\nIRQF_SHARED | IRQF_NO_SUSPEND,\r\nab8500_charger_irq[i].name, di);\r\nif (ret != 0) {\r\ndev_err(di->dev, "failed to request %s IRQ %d: %d\n"\r\n, ab8500_charger_irq[i].name, irq, ret);\r\ngoto free_irq;\r\n}\r\ndev_dbg(di->dev, "Requested %s IRQ %d: %d\n",\r\nab8500_charger_irq[i].name, irq, ret);\r\n}\r\nplatform_set_drvdata(pdev, di);\r\nmutex_lock(&di->charger_attached_mutex);\r\nch_stat = ab8500_charger_detect_chargers(di, false);\r\nif ((ch_stat & AC_PW_CONN) == AC_PW_CONN) {\r\nif (is_ab8500(di->parent))\r\nqueue_delayed_work(di->charger_wq,\r\n&di->ac_charger_attached_work,\r\nHZ);\r\n}\r\nif ((ch_stat & USB_PW_CONN) == USB_PW_CONN) {\r\nif (is_ab8500(di->parent))\r\nqueue_delayed_work(di->charger_wq,\r\n&di->usb_charger_attached_work,\r\nHZ);\r\n}\r\nmutex_unlock(&di->charger_attached_mutex);\r\nreturn ret;\r\nfree_irq:\r\nusb_unregister_notifier(di->usb_phy, &di->nb);\r\nfor (i = i - 1; i >= 0; i--) {\r\nirq = platform_get_irq_byname(pdev, ab8500_charger_irq[i].name);\r\nfree_irq(irq, di);\r\n}\r\nput_usb_phy:\r\nusb_put_phy(di->usb_phy);\r\nfree_usb:\r\nif (di->usb_chg.enabled)\r\npower_supply_unregister(&di->usb_chg.psy);\r\nfree_ac:\r\nif (di->ac_chg.enabled)\r\npower_supply_unregister(&di->ac_chg.psy);\r\nfree_charger_wq:\r\ndestroy_workqueue(di->charger_wq);\r\nreturn ret;\r\n}\r\nstatic int __init ab8500_charger_init(void)\r\n{\r\nreturn platform_driver_register(&ab8500_charger_driver);\r\n}\r\nstatic void __exit ab8500_charger_exit(void)\r\n{\r\nplatform_driver_unregister(&ab8500_charger_driver);\r\n}

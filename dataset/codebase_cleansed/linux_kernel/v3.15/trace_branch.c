static void\r\nprobe_likely_condition(struct ftrace_branch_data *f, int val, int expect)\r\n{\r\nstruct ftrace_event_call *call = &event_branch;\r\nstruct trace_array *tr = branch_tracer;\r\nstruct trace_array_cpu *data;\r\nstruct ring_buffer_event *event;\r\nstruct trace_branch *entry;\r\nstruct ring_buffer *buffer;\r\nunsigned long flags;\r\nint cpu, pc;\r\nconst char *p;\r\nif (unlikely(!tr))\r\nreturn;\r\nlocal_irq_save(flags);\r\ncpu = raw_smp_processor_id();\r\ndata = per_cpu_ptr(tr->trace_buffer.data, cpu);\r\nif (atomic_inc_return(&data->disabled) != 1)\r\ngoto out;\r\npc = preempt_count();\r\nbuffer = tr->trace_buffer.buffer;\r\nevent = trace_buffer_lock_reserve(buffer, TRACE_BRANCH,\r\nsizeof(*entry), flags, pc);\r\nif (!event)\r\ngoto out;\r\nentry = ring_buffer_event_data(event);\r\np = f->file + strlen(f->file);\r\nwhile (p >= f->file && *p != '/')\r\np--;\r\np++;\r\nstrncpy(entry->func, f->func, TRACE_FUNC_SIZE);\r\nstrncpy(entry->file, p, TRACE_FILE_SIZE);\r\nentry->func[TRACE_FUNC_SIZE] = 0;\r\nentry->file[TRACE_FILE_SIZE] = 0;\r\nentry->line = f->line;\r\nentry->correct = val == expect;\r\nif (!call_filter_check_discard(call, entry, buffer, event))\r\n__buffer_unlock_commit(buffer, event);\r\nout:\r\natomic_dec(&data->disabled);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic inline\r\nvoid trace_likely_condition(struct ftrace_branch_data *f, int val, int expect)\r\n{\r\nif (!branch_tracing_enabled)\r\nreturn;\r\nprobe_likely_condition(f, val, expect);\r\n}\r\nint enable_branch_tracing(struct trace_array *tr)\r\n{\r\nmutex_lock(&branch_tracing_mutex);\r\nbranch_tracer = tr;\r\nsmp_wmb();\r\nbranch_tracing_enabled++;\r\nmutex_unlock(&branch_tracing_mutex);\r\nreturn 0;\r\n}\r\nvoid disable_branch_tracing(void)\r\n{\r\nmutex_lock(&branch_tracing_mutex);\r\nif (!branch_tracing_enabled)\r\ngoto out_unlock;\r\nbranch_tracing_enabled--;\r\nout_unlock:\r\nmutex_unlock(&branch_tracing_mutex);\r\n}\r\nstatic void start_branch_trace(struct trace_array *tr)\r\n{\r\nenable_branch_tracing(tr);\r\n}\r\nstatic void stop_branch_trace(struct trace_array *tr)\r\n{\r\ndisable_branch_tracing();\r\n}\r\nstatic int branch_trace_init(struct trace_array *tr)\r\n{\r\nstart_branch_trace(tr);\r\nreturn 0;\r\n}\r\nstatic void branch_trace_reset(struct trace_array *tr)\r\n{\r\nstop_branch_trace(tr);\r\n}\r\nstatic enum print_line_t trace_branch_print(struct trace_iterator *iter,\r\nint flags, struct trace_event *event)\r\n{\r\nstruct trace_branch *field;\r\ntrace_assign_type(field, iter->ent);\r\nif (trace_seq_printf(&iter->seq, "[%s] %s:%s:%d\n",\r\nfield->correct ? " ok " : " MISS ",\r\nfield->func,\r\nfield->file,\r\nfield->line))\r\nreturn TRACE_TYPE_PARTIAL_LINE;\r\nreturn TRACE_TYPE_HANDLED;\r\n}\r\nstatic void branch_print_header(struct seq_file *s)\r\n{\r\nseq_puts(s, "# TASK-PID CPU# TIMESTAMP CORRECT"\r\n" FUNC:FILE:LINE\n");\r\nseq_puts(s, "# | | | | | "\r\n" |\n");\r\n}\r\n__init static int init_branch_tracer(void)\r\n{\r\nint ret;\r\nret = register_ftrace_event(&trace_branch_event);\r\nif (!ret) {\r\nprintk(KERN_WARNING "Warning: could not register "\r\n"branch events\n");\r\nreturn 1;\r\n}\r\nreturn register_tracer(&branch_trace);\r\n}\r\nstatic inline\r\nvoid trace_likely_condition(struct ftrace_branch_data *f, int val, int expect)\r\n{\r\n}\r\nvoid ftrace_likely_update(struct ftrace_branch_data *f, int val, int expect)\r\n{\r\ntrace_likely_condition(f, val, expect);\r\nif (val == expect)\r\nf->correct++;\r\nelse\r\nf->incorrect++;\r\n}\r\nstatic int annotated_branch_stat_headers(struct seq_file *m)\r\n{\r\nseq_printf(m, " correct incorrect %% ");\r\nseq_printf(m, " Function "\r\n" File Line\n"\r\n" ------- --------- - "\r\n" -------- "\r\n" ---- ----\n");\r\nreturn 0;\r\n}\r\nstatic inline long get_incorrect_percent(struct ftrace_branch_data *p)\r\n{\r\nlong percent;\r\nif (p->correct) {\r\npercent = p->incorrect * 100;\r\npercent /= p->correct + p->incorrect;\r\n} else\r\npercent = p->incorrect ? 100 : -1;\r\nreturn percent;\r\n}\r\nstatic int branch_stat_show(struct seq_file *m, void *v)\r\n{\r\nstruct ftrace_branch_data *p = v;\r\nconst char *f;\r\nlong percent;\r\nf = p->file + strlen(p->file);\r\nwhile (f >= p->file && *f != '/')\r\nf--;\r\nf++;\r\npercent = get_incorrect_percent(p);\r\nseq_printf(m, "%8lu %8lu ", p->correct, p->incorrect);\r\nif (percent < 0)\r\nseq_printf(m, " X ");\r\nelse\r\nseq_printf(m, "%3ld ", percent);\r\nseq_printf(m, "%-30.30s %-20.20s %d\n", p->func, f, p->line);\r\nreturn 0;\r\n}\r\nstatic void *annotated_branch_stat_start(struct tracer_stat *trace)\r\n{\r\nreturn __start_annotated_branch_profile;\r\n}\r\nstatic void *\r\nannotated_branch_stat_next(void *v, int idx)\r\n{\r\nstruct ftrace_branch_data *p = v;\r\n++p;\r\nif ((void *)p >= (void *)__stop_annotated_branch_profile)\r\nreturn NULL;\r\nreturn p;\r\n}\r\nstatic int annotated_branch_stat_cmp(void *p1, void *p2)\r\n{\r\nstruct ftrace_branch_data *a = p1;\r\nstruct ftrace_branch_data *b = p2;\r\nlong percent_a, percent_b;\r\npercent_a = get_incorrect_percent(a);\r\npercent_b = get_incorrect_percent(b);\r\nif (percent_a < percent_b)\r\nreturn -1;\r\nif (percent_a > percent_b)\r\nreturn 1;\r\nif (a->incorrect < b->incorrect)\r\nreturn -1;\r\nif (a->incorrect > b->incorrect)\r\nreturn 1;\r\nif (a->correct > b->correct)\r\nreturn -1;\r\nif (a->correct < b->correct)\r\nreturn 1;\r\nreturn 0;\r\n}\r\n__init static int init_annotated_branch_stats(void)\r\n{\r\nint ret;\r\nret = register_stat_tracer(&annotated_branch_stats);\r\nif (!ret) {\r\nprintk(KERN_WARNING "Warning: could not register "\r\n"annotated branches stats\n");\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int all_branch_stat_headers(struct seq_file *m)\r\n{\r\nseq_printf(m, " miss hit %% ");\r\nseq_printf(m, " Function "\r\n" File Line\n"\r\n" ------- --------- - "\r\n" -------- "\r\n" ---- ----\n");\r\nreturn 0;\r\n}\r\nstatic void *all_branch_stat_start(struct tracer_stat *trace)\r\n{\r\nreturn __start_branch_profile;\r\n}\r\nstatic void *\r\nall_branch_stat_next(void *v, int idx)\r\n{\r\nstruct ftrace_branch_data *p = v;\r\n++p;\r\nif ((void *)p >= (void *)__stop_branch_profile)\r\nreturn NULL;\r\nreturn p;\r\n}\r\n__init static int all_annotated_branch_stats(void)\r\n{\r\nint ret;\r\nret = register_stat_tracer(&all_branch_stats);\r\nif (!ret) {\r\nprintk(KERN_WARNING "Warning: could not register "\r\n"all branches stats\n");\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}

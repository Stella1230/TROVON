static int sb_register_oss(struct sb_card_config *scc, struct sb_module_options *sbmo)\r\n{\r\nif (!request_region(scc->conf.io_base, 16, "soundblaster")) {\r\nprintk(KERN_ERR "sb: ports busy.\n");\r\nkfree(scc);\r\nreturn -EBUSY;\r\n}\r\nif (!sb_dsp_detect(&scc->conf, 0, 0, sbmo)) {\r\nrelease_region(scc->conf.io_base, 16);\r\nprintk(KERN_ERR "sb: Failed DSP Detect.\n");\r\nkfree(scc);\r\nreturn -ENODEV;\r\n}\r\nif(!sb_dsp_init(&scc->conf, THIS_MODULE)) {\r\nprintk(KERN_ERR "sb: Failed DSP init.\n");\r\nkfree(scc);\r\nreturn -ENODEV;\r\n}\r\nif(scc->mpucnf.io_base > 0) {\r\nscc->mpu = 1;\r\nprintk(KERN_INFO "sb: Turning on MPU\n");\r\nif(!probe_sbmpu(&scc->mpucnf, THIS_MODULE))\r\nscc->mpu = 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic void sb_unload(struct sb_card_config *scc)\r\n{\r\nsb_dsp_unload(&scc->conf, 0);\r\nif(scc->mpu)\r\nunload_sbmpu(&scc->mpucnf);\r\nkfree(scc);\r\n}\r\nstatic int __init sb_init_legacy(void)\r\n{\r\nstruct sb_module_options sbmo = {0};\r\nif((legacy = kzalloc(sizeof(struct sb_card_config), GFP_KERNEL)) == NULL) {\r\nprintk(KERN_ERR "sb: Error: Could not allocate memory\n");\r\nreturn -ENOMEM;\r\n}\r\nlegacy->conf.io_base = io;\r\nlegacy->conf.irq = irq;\r\nlegacy->conf.dma = dma;\r\nlegacy->conf.dma2 = dma16;\r\nlegacy->conf.card_subtype = type;\r\nlegacy->mpucnf.io_base = mpu_io;\r\nlegacy->mpucnf.irq = -1;\r\nlegacy->mpucnf.dma = -1;\r\nlegacy->mpucnf.dma2 = -1;\r\nsbmo.esstype = esstype;\r\nsbmo.sm_games = sm_games;\r\nsbmo.acer = acer;\r\nreturn sb_register_oss(legacy, &sbmo);\r\n}\r\nstatic void sb_dev2cfg(struct pnp_dev *dev, struct sb_card_config *scc)\r\n{\r\nscc->conf.io_base = -1;\r\nscc->conf.irq = -1;\r\nscc->conf.dma = -1;\r\nscc->conf.dma2 = -1;\r\nscc->mpucnf.io_base = -1;\r\nscc->mpucnf.irq = -1;\r\nscc->mpucnf.dma = -1;\r\nscc->mpucnf.dma2 = -1;\r\nif(!strncmp("CTL",scc->card_id,3)) {\r\nscc->conf.io_base = pnp_port_start(dev,0);\r\nscc->conf.irq = pnp_irq(dev,0);\r\nscc->conf.dma = pnp_dma(dev,0);\r\nscc->conf.dma2 = pnp_dma(dev,1);\r\nscc->mpucnf.io_base = pnp_port_start(dev,1);\r\nreturn;\r\n}\r\nif(!strncmp("tBA",scc->card_id,3)) {\r\nscc->conf.io_base = pnp_port_start(dev,0);\r\nscc->conf.irq = pnp_irq(dev,0);\r\nscc->conf.dma = pnp_dma(dev,0);\r\nscc->conf.dma2 = pnp_dma(dev,1);\r\nreturn;\r\n}\r\nif(!strncmp("ESS",scc->card_id,3)) {\r\nscc->conf.io_base = pnp_port_start(dev,0);\r\nscc->conf.irq = pnp_irq(dev,0);\r\nscc->conf.dma = pnp_dma(dev,0);\r\nscc->conf.dma2 = pnp_dma(dev,1);\r\nscc->mpucnf.io_base = pnp_port_start(dev,2);\r\nreturn;\r\n}\r\nif(!strncmp("CMI",scc->card_id,3)) {\r\nscc->conf.io_base = pnp_port_start(dev,0);\r\nscc->conf.irq = pnp_irq(dev,0);\r\nscc->conf.dma = pnp_dma(dev,0);\r\nscc->conf.dma2 = pnp_dma(dev,1);\r\nreturn;\r\n}\r\nif(!strncmp("RWB",scc->card_id,3)) {\r\nscc->conf.io_base = pnp_port_start(dev,0);\r\nscc->conf.irq = pnp_irq(dev,0);\r\nscc->conf.dma = pnp_dma(dev,0);\r\nreturn;\r\n}\r\nif(!strncmp("ALS",scc->card_id,3)) {\r\nif(!strncmp("ALS0007",scc->card_id,7)) {\r\nscc->conf.io_base = pnp_port_start(dev,0);\r\nscc->conf.irq = pnp_irq(dev,0);\r\nscc->conf.dma = pnp_dma(dev,0);\r\n} else {\r\nscc->conf.io_base = pnp_port_start(dev,0);\r\nscc->conf.irq = pnp_irq(dev,0);\r\nscc->conf.dma = pnp_dma(dev,1);\r\nscc->conf.dma2 = pnp_dma(dev,0);\r\n}\r\nreturn;\r\n}\r\nif(!strncmp("RTL",scc->card_id,3)) {\r\nscc->conf.io_base = pnp_port_start(dev,0);\r\nscc->conf.irq = pnp_irq(dev,0);\r\nscc->conf.dma = pnp_dma(dev,1);\r\nscc->conf.dma2 = pnp_dma(dev,0);\r\n}\r\n}\r\nstatic int sb_pnp_probe(struct pnp_card_link *card, const struct pnp_card_device_id *card_id)\r\n{\r\nstruct sb_card_config *scc;\r\nstruct sb_module_options sbmo = {0};\r\nstruct pnp_dev *dev = pnp_request_card_device(card, card_id->devs[0].id, NULL);\r\nif(!dev){\r\nreturn -EBUSY;\r\n}\r\nif((scc = kzalloc(sizeof(struct sb_card_config), GFP_KERNEL)) == NULL) {\r\nprintk(KERN_ERR "sb: Error: Could not allocate memory\n");\r\nreturn -ENOMEM;\r\n}\r\nprintk(KERN_INFO "sb: PnP: Found Card Named = \"%s\", Card PnP id = " \\r\n"%s, Device PnP id = %s\n", card->card->name, card_id->id,\r\ndev->id->id);\r\nscc->card_id = card_id->id;\r\nscc->dev_id = dev->id->id;\r\nsb_dev2cfg(dev, scc);\r\nprintk(KERN_INFO "sb: PnP: Detected at: io=0x%x, irq=%d, " \\r\n"dma=%d, dma16=%d\n", scc->conf.io_base, scc->conf.irq,\r\nscc->conf.dma, scc->conf.dma2);\r\npnp_set_card_drvdata(card, scc);\r\nsb_pnp_devices++;\r\nreturn sb_register_oss(scc, &sbmo);\r\n}\r\nstatic void sb_pnp_remove(struct pnp_card_link *card)\r\n{\r\nstruct sb_card_config *scc = pnp_get_card_drvdata(card);\r\nif(!scc)\r\nreturn;\r\nprintk(KERN_INFO "sb: PnP: Removing %s\n", scc->card_id);\r\nsb_unload(scc);\r\n}\r\nstatic void sb_unregister_all(void)\r\n{\r\n#ifdef CONFIG_PNP\r\nif (pnp_registered)\r\npnp_unregister_card_driver(&sb_pnp_driver);\r\n#endif\r\n}\r\nstatic int __init sb_init(void)\r\n{\r\nint lres = 0;\r\nint pres = 0;\r\nprintk(KERN_INFO "sb: Init: Starting Probe...\n");\r\nif(io != -1 && irq != -1 && dma != -1) {\r\nprintk(KERN_INFO "sb: Probing legacy card with io=%x, "\\r\n"irq=%d, dma=%d, dma16=%d\n",io, irq, dma, dma16);\r\nlres = sb_init_legacy();\r\n} else if((io != -1 || irq != -1 || dma != -1) ||\r\n(!pnp && (io == -1 && irq == -1 && dma == -1)))\r\nprintk(KERN_ERR "sb: Error: At least io, irq, and dma "\\r\n"must be set for legacy cards.\n");\r\n#ifdef CONFIG_PNP\r\nif(pnp) {\r\nint err = pnp_register_card_driver(&sb_pnp_driver);\r\nif (!err)\r\npnp_registered = 1;\r\npres = sb_pnp_devices;\r\n}\r\n#endif\r\nprintk(KERN_INFO "sb: Init: Done\n");\r\nif (pres == 0 && lres <= 0) {\r\nsb_unregister_all();\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit sb_exit(void)\r\n{\r\nprintk(KERN_INFO "sb: Unloading...\n");\r\nif (legacy) {\r\nprintk (KERN_INFO "sb: Unloading legacy card\n");\r\nsb_unload(legacy);\r\n}\r\nsb_unregister_all();\r\nvfree(smw_free);\r\nsmw_free = NULL;\r\n}

static cycle_t dec_ioasic_hpt_read(struct clocksource *cs)\r\n{\r\nreturn ioasic_read(IO_REG_FCTR);\r\n}\r\nint __init dec_ioasic_clocksource_init(void)\r\n{\r\nunsigned int freq;\r\nu32 start, end;\r\nint i = HZ / 8;\r\nds1287_timer_state();\r\nwhile (!ds1287_timer_state())\r\n;\r\nstart = dec_ioasic_hpt_read(&clocksource_dec);\r\nwhile (i--)\r\nwhile (!ds1287_timer_state())\r\n;\r\nend = dec_ioasic_hpt_read(&clocksource_dec);\r\nfreq = (end - start) * 8;\r\nif (!freq)\r\nreturn -ENXIO;\r\nprintk(KERN_INFO "I/O ASIC clock frequency %dHz\n", freq);\r\nclocksource_dec.rating = 200 + freq / 10000000;\r\nclocksource_register_hz(&clocksource_dec, freq);\r\nreturn 0;\r\n}

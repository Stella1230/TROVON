static u32 phy_CalculateBitShift(u32 BitMask)\r\n{\r\nu32 i;\r\nfor (i = 0; i <= 31; i++) {\r\nif (((BitMask>>i) & 0x1) == 1)\r\nbreak;\r\n}\r\nreturn i;\r\n}\r\nu32\r\nrtl8188e_PHY_QueryBBReg(\r\nstruct adapter *Adapter,\r\nu32 RegAddr,\r\nu32 BitMask\r\n)\r\n{\r\nu32 ReturnValue = 0, OriginalValue, BitShift;\r\nOriginalValue = rtw_read32(Adapter, RegAddr);\r\nBitShift = phy_CalculateBitShift(BitMask);\r\nReturnValue = (OriginalValue & BitMask) >> BitShift;\r\nreturn ReturnValue;\r\n}\r\nvoid rtl8188e_PHY_SetBBReg(struct adapter *Adapter, u32 RegAddr, u32 BitMask, u32 Data)\r\n{\r\nu32 OriginalValue, BitShift;\r\nif (BitMask != bMaskDWord) {\r\nOriginalValue = rtw_read32(Adapter, RegAddr);\r\nBitShift = phy_CalculateBitShift(BitMask);\r\nData = ((OriginalValue & (~BitMask)) | (Data << BitShift));\r\n}\r\nrtw_write32(Adapter, RegAddr, Data);\r\n}\r\nstatic u32\r\nphy_RFSerialRead(\r\nstruct adapter *Adapter,\r\nenum rf_radio_path eRFPath,\r\nu32 Offset\r\n)\r\n{\r\nu32 retValue = 0;\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\nstruct bb_reg_def *pPhyReg = &pHalData->PHYRegDef[eRFPath];\r\nu32 NewOffset;\r\nu32 tmplong, tmplong2;\r\nu8 RfPiEnable = 0;\r\nOffset &= 0xff;\r\nNewOffset = Offset;\r\ntmplong = PHY_QueryBBReg(Adapter, rFPGA0_XA_HSSIParameter2, bMaskDWord);\r\nif (eRFPath == RF_PATH_A)\r\ntmplong2 = tmplong;\r\nelse\r\ntmplong2 = PHY_QueryBBReg(Adapter, pPhyReg->rfHSSIPara2, bMaskDWord);\r\ntmplong2 = (tmplong2 & (~bLSSIReadAddress)) | (NewOffset<<23) | bLSSIReadEdge;\r\nPHY_SetBBReg(Adapter, rFPGA0_XA_HSSIParameter2, bMaskDWord, tmplong&(~bLSSIReadEdge));\r\nudelay(10);\r\nPHY_SetBBReg(Adapter, pPhyReg->rfHSSIPara2, bMaskDWord, tmplong2);\r\nudelay(100);\r\nudelay(10);\r\nif (eRFPath == RF_PATH_A)\r\nRfPiEnable = (u8)PHY_QueryBBReg(Adapter, rFPGA0_XA_HSSIParameter1, BIT8);\r\nelse if (eRFPath == RF_PATH_B)\r\nRfPiEnable = (u8)PHY_QueryBBReg(Adapter, rFPGA0_XB_HSSIParameter1, BIT8);\r\nif (RfPiEnable) {\r\nretValue = PHY_QueryBBReg(Adapter, pPhyReg->rfLSSIReadBackPi, bLSSIReadBackData);\r\n} else {\r\nretValue = PHY_QueryBBReg(Adapter, pPhyReg->rfLSSIReadBack, bLSSIReadBackData);\r\n}\r\nreturn retValue;\r\n}\r\nstatic void\r\nphy_RFSerialWrite(\r\nstruct adapter *Adapter,\r\nenum rf_radio_path eRFPath,\r\nu32 Offset,\r\nu32 Data\r\n)\r\n{\r\nu32 DataAndAddr = 0;\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\nstruct bb_reg_def *pPhyReg = &pHalData->PHYRegDef[eRFPath];\r\nu32 NewOffset;\r\nOffset &= 0xff;\r\nNewOffset = Offset;\r\nDataAndAddr = ((NewOffset<<20) | (Data&0x000fffff)) & 0x0fffffff;\r\nPHY_SetBBReg(Adapter, pPhyReg->rf3wireOffset, bMaskDWord, DataAndAddr);\r\n}\r\nu32 rtl8188e_PHY_QueryRFReg(struct adapter *Adapter, enum rf_radio_path eRFPath,\r\nu32 RegAddr, u32 BitMask)\r\n{\r\nu32 Original_Value, Readback_Value, BitShift;\r\nOriginal_Value = phy_RFSerialRead(Adapter, eRFPath, RegAddr);\r\nBitShift = phy_CalculateBitShift(BitMask);\r\nReadback_Value = (Original_Value & BitMask) >> BitShift;\r\nreturn Readback_Value;\r\n}\r\nvoid\r\nrtl8188e_PHY_SetRFReg(\r\nstruct adapter *Adapter,\r\nenum rf_radio_path eRFPath,\r\nu32 RegAddr,\r\nu32 BitMask,\r\nu32 Data\r\n)\r\n{\r\nu32 Original_Value, BitShift;\r\nif (BitMask != bRFRegOffsetMask) {\r\nOriginal_Value = phy_RFSerialRead(Adapter, eRFPath, RegAddr);\r\nBitShift = phy_CalculateBitShift(BitMask);\r\nData = ((Original_Value & (~BitMask)) | (Data << BitShift));\r\n}\r\nphy_RFSerialWrite(Adapter, eRFPath, RegAddr, Data);\r\n}\r\ns32 PHY_MACConfig8188E(struct adapter *Adapter)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\nint rtStatus = _SUCCESS;\r\nif (HAL_STATUS_FAILURE == ODM_ConfigMACWithHeaderFile(&pHalData->odmpriv))\r\nrtStatus = _FAIL;\r\nrtw_write16(Adapter, REG_MAX_AGGR_NUM, MAX_AGGR_NUM);\r\nreturn rtStatus;\r\n}\r\nstatic void\r\nphy_InitBBRFRegisterDefinition(\r\nstruct adapter *Adapter\r\n)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\npHalData->PHYRegDef[RF_PATH_A].rfintfs = rFPGA0_XAB_RFInterfaceSW;\r\npHalData->PHYRegDef[RF_PATH_B].rfintfs = rFPGA0_XAB_RFInterfaceSW;\r\npHalData->PHYRegDef[RF_PATH_C].rfintfs = rFPGA0_XCD_RFInterfaceSW;\r\npHalData->PHYRegDef[RF_PATH_D].rfintfs = rFPGA0_XCD_RFInterfaceSW;\r\npHalData->PHYRegDef[RF_PATH_A].rfintfi = rFPGA0_XAB_RFInterfaceRB;\r\npHalData->PHYRegDef[RF_PATH_B].rfintfi = rFPGA0_XAB_RFInterfaceRB;\r\npHalData->PHYRegDef[RF_PATH_C].rfintfi = rFPGA0_XCD_RFInterfaceRB;\r\npHalData->PHYRegDef[RF_PATH_D].rfintfi = rFPGA0_XCD_RFInterfaceRB;\r\npHalData->PHYRegDef[RF_PATH_A].rfintfo = rFPGA0_XA_RFInterfaceOE;\r\npHalData->PHYRegDef[RF_PATH_B].rfintfo = rFPGA0_XB_RFInterfaceOE;\r\npHalData->PHYRegDef[RF_PATH_A].rfintfe = rFPGA0_XA_RFInterfaceOE;\r\npHalData->PHYRegDef[RF_PATH_B].rfintfe = rFPGA0_XB_RFInterfaceOE;\r\npHalData->PHYRegDef[RF_PATH_A].rf3wireOffset = rFPGA0_XA_LSSIParameter;\r\npHalData->PHYRegDef[RF_PATH_B].rf3wireOffset = rFPGA0_XB_LSSIParameter;\r\npHalData->PHYRegDef[RF_PATH_A].rfLSSI_Select = rFPGA0_XAB_RFParameter;\r\npHalData->PHYRegDef[RF_PATH_B].rfLSSI_Select = rFPGA0_XAB_RFParameter;\r\npHalData->PHYRegDef[RF_PATH_C].rfLSSI_Select = rFPGA0_XCD_RFParameter;\r\npHalData->PHYRegDef[RF_PATH_D].rfLSSI_Select = rFPGA0_XCD_RFParameter;\r\npHalData->PHYRegDef[RF_PATH_A].rfTxGainStage = rFPGA0_TxGainStage;\r\npHalData->PHYRegDef[RF_PATH_B].rfTxGainStage = rFPGA0_TxGainStage;\r\npHalData->PHYRegDef[RF_PATH_C].rfTxGainStage = rFPGA0_TxGainStage;\r\npHalData->PHYRegDef[RF_PATH_D].rfTxGainStage = rFPGA0_TxGainStage;\r\npHalData->PHYRegDef[RF_PATH_A].rfHSSIPara1 = rFPGA0_XA_HSSIParameter1;\r\npHalData->PHYRegDef[RF_PATH_B].rfHSSIPara1 = rFPGA0_XB_HSSIParameter1;\r\npHalData->PHYRegDef[RF_PATH_A].rfHSSIPara2 = rFPGA0_XA_HSSIParameter2;\r\npHalData->PHYRegDef[RF_PATH_B].rfHSSIPara2 = rFPGA0_XB_HSSIParameter2;\r\npHalData->PHYRegDef[RF_PATH_A].rfSwitchControl = rFPGA0_XAB_SwitchControl;\r\npHalData->PHYRegDef[RF_PATH_B].rfSwitchControl = rFPGA0_XAB_SwitchControl;\r\npHalData->PHYRegDef[RF_PATH_C].rfSwitchControl = rFPGA0_XCD_SwitchControl;\r\npHalData->PHYRegDef[RF_PATH_D].rfSwitchControl = rFPGA0_XCD_SwitchControl;\r\npHalData->PHYRegDef[RF_PATH_A].rfAGCControl1 = rOFDM0_XAAGCCore1;\r\npHalData->PHYRegDef[RF_PATH_B].rfAGCControl1 = rOFDM0_XBAGCCore1;\r\npHalData->PHYRegDef[RF_PATH_C].rfAGCControl1 = rOFDM0_XCAGCCore1;\r\npHalData->PHYRegDef[RF_PATH_D].rfAGCControl1 = rOFDM0_XDAGCCore1;\r\npHalData->PHYRegDef[RF_PATH_A].rfAGCControl2 = rOFDM0_XAAGCCore2;\r\npHalData->PHYRegDef[RF_PATH_B].rfAGCControl2 = rOFDM0_XBAGCCore2;\r\npHalData->PHYRegDef[RF_PATH_C].rfAGCControl2 = rOFDM0_XCAGCCore2;\r\npHalData->PHYRegDef[RF_PATH_D].rfAGCControl2 = rOFDM0_XDAGCCore2;\r\npHalData->PHYRegDef[RF_PATH_A].rfRxIQImbalance = rOFDM0_XARxIQImbalance;\r\npHalData->PHYRegDef[RF_PATH_B].rfRxIQImbalance = rOFDM0_XBRxIQImbalance;\r\npHalData->PHYRegDef[RF_PATH_C].rfRxIQImbalance = rOFDM0_XCRxIQImbalance;\r\npHalData->PHYRegDef[RF_PATH_D].rfRxIQImbalance = rOFDM0_XDRxIQImbalance;\r\npHalData->PHYRegDef[RF_PATH_A].rfRxAFE = rOFDM0_XARxAFE;\r\npHalData->PHYRegDef[RF_PATH_B].rfRxAFE = rOFDM0_XBRxAFE;\r\npHalData->PHYRegDef[RF_PATH_C].rfRxAFE = rOFDM0_XCRxAFE;\r\npHalData->PHYRegDef[RF_PATH_D].rfRxAFE = rOFDM0_XDRxAFE;\r\npHalData->PHYRegDef[RF_PATH_A].rfTxIQImbalance = rOFDM0_XATxIQImbalance;\r\npHalData->PHYRegDef[RF_PATH_B].rfTxIQImbalance = rOFDM0_XBTxIQImbalance;\r\npHalData->PHYRegDef[RF_PATH_C].rfTxIQImbalance = rOFDM0_XCTxIQImbalance;\r\npHalData->PHYRegDef[RF_PATH_D].rfTxIQImbalance = rOFDM0_XDTxIQImbalance;\r\npHalData->PHYRegDef[RF_PATH_A].rfTxAFE = rOFDM0_XATxAFE;\r\npHalData->PHYRegDef[RF_PATH_B].rfTxAFE = rOFDM0_XBTxAFE;\r\npHalData->PHYRegDef[RF_PATH_C].rfTxAFE = rOFDM0_XCTxAFE;\r\npHalData->PHYRegDef[RF_PATH_D].rfTxAFE = rOFDM0_XDTxAFE;\r\npHalData->PHYRegDef[RF_PATH_A].rfLSSIReadBack = rFPGA0_XA_LSSIReadBack;\r\npHalData->PHYRegDef[RF_PATH_B].rfLSSIReadBack = rFPGA0_XB_LSSIReadBack;\r\npHalData->PHYRegDef[RF_PATH_C].rfLSSIReadBack = rFPGA0_XC_LSSIReadBack;\r\npHalData->PHYRegDef[RF_PATH_D].rfLSSIReadBack = rFPGA0_XD_LSSIReadBack;\r\npHalData->PHYRegDef[RF_PATH_A].rfLSSIReadBackPi = TransceiverA_HSPI_Readback;\r\npHalData->PHYRegDef[RF_PATH_B].rfLSSIReadBackPi = TransceiverB_HSPI_Readback;\r\n}\r\nvoid storePwrIndexDiffRateOffset(struct adapter *Adapter, u32 RegAddr, u32 BitMask, u32 Data)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\nif (RegAddr == rTxAGC_A_Rate18_06)\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][0] = Data;\r\nif (RegAddr == rTxAGC_A_Rate54_24)\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][1] = Data;\r\nif (RegAddr == rTxAGC_A_CCK1_Mcs32)\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][6] = Data;\r\nif (RegAddr == rTxAGC_B_CCK11_A_CCK2_11 && BitMask == 0xffffff00)\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][7] = Data;\r\nif (RegAddr == rTxAGC_A_Mcs03_Mcs00)\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][2] = Data;\r\nif (RegAddr == rTxAGC_A_Mcs07_Mcs04)\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][3] = Data;\r\nif (RegAddr == rTxAGC_A_Mcs11_Mcs08)\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][4] = Data;\r\nif (RegAddr == rTxAGC_A_Mcs15_Mcs12) {\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][5] = Data;\r\nif (pHalData->rf_type == RF_1T1R)\r\npHalData->pwrGroupCnt++;\r\n}\r\nif (RegAddr == rTxAGC_B_Rate18_06)\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][8] = Data;\r\nif (RegAddr == rTxAGC_B_Rate54_24)\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][9] = Data;\r\nif (RegAddr == rTxAGC_B_CCK1_55_Mcs32)\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][14] = Data;\r\nif (RegAddr == rTxAGC_B_CCK11_A_CCK2_11 && BitMask == 0x000000ff)\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][15] = Data;\r\nif (RegAddr == rTxAGC_B_Mcs03_Mcs00)\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][10] = Data;\r\nif (RegAddr == rTxAGC_B_Mcs07_Mcs04)\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][11] = Data;\r\nif (RegAddr == rTxAGC_B_Mcs11_Mcs08)\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][12] = Data;\r\nif (RegAddr == rTxAGC_B_Mcs15_Mcs12) {\r\npHalData->MCSTxPowerLevelOriginalOffset[pHalData->pwrGroupCnt][13] = Data;\r\nif (pHalData->rf_type != RF_1T1R)\r\npHalData->pwrGroupCnt++;\r\n}\r\n}\r\nstatic int phy_BB8188E_Config_ParaFile(struct adapter *Adapter)\r\n{\r\nstruct eeprom_priv *pEEPROM = GET_EEPROM_EFUSE_PRIV(Adapter);\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\nint rtStatus = _SUCCESS;\r\nif (HAL_STATUS_FAILURE == ODM_ConfigBBWithHeaderFile(&pHalData->odmpriv, CONFIG_BB_PHY_REG))\r\nrtStatus = _FAIL;\r\nif (rtStatus != _SUCCESS)\r\ngoto phy_BB8190_Config_ParaFile_Fail;\r\nif (!pEEPROM->bautoload_fail_flag) {\r\npHalData->pwrGroupCnt = 0;\r\nif (HAL_STATUS_FAILURE == ODM_ConfigBBWithHeaderFile(&pHalData->odmpriv, CONFIG_BB_PHY_REG_PG))\r\nrtStatus = _FAIL;\r\n}\r\nif (rtStatus != _SUCCESS)\r\ngoto phy_BB8190_Config_ParaFile_Fail;\r\nif (HAL_STATUS_FAILURE == ODM_ConfigBBWithHeaderFile(&pHalData->odmpriv, CONFIG_BB_AGC_TAB))\r\nrtStatus = _FAIL;\r\nif (rtStatus != _SUCCESS)\r\ngoto phy_BB8190_Config_ParaFile_Fail;\r\nphy_BB8190_Config_ParaFile_Fail:\r\nreturn rtStatus;\r\n}\r\nint\r\nPHY_BBConfig8188E(\r\nstruct adapter *Adapter\r\n)\r\n{\r\nint rtStatus = _SUCCESS;\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\nu32 RegVal;\r\nu8 CrystalCap;\r\nphy_InitBBRFRegisterDefinition(Adapter);\r\nRegVal = rtw_read16(Adapter, REG_SYS_FUNC_EN);\r\nrtw_write16(Adapter, REG_SYS_FUNC_EN, (u16)(RegVal|BIT13|BIT0|BIT1));\r\nrtw_write8(Adapter, REG_RF_CTRL, RF_EN|RF_RSTB|RF_SDMRSTB);\r\nrtw_write8(Adapter, REG_SYS_FUNC_EN, FEN_USBA | FEN_USBD | FEN_BB_GLB_RSTn | FEN_BBRSTB);\r\nrtStatus = phy_BB8188E_Config_ParaFile(Adapter);\r\nCrystalCap = pHalData->CrystalCap & 0x3F;\r\nPHY_SetBBReg(Adapter, REG_AFE_XTAL_CTRL, 0x7ff800, (CrystalCap | (CrystalCap << 6)));\r\nreturn rtStatus;\r\n}\r\nint PHY_RFConfig8188E(struct adapter *Adapter)\r\n{\r\nint rtStatus = _SUCCESS;\r\nrtStatus = PHY_RF6052_Config8188E(Adapter);\r\nreturn rtStatus;\r\n}\r\nint rtl8188e_PHY_ConfigRFWithParaFile(struct adapter *Adapter, u8 *pFileName, enum rf_radio_path eRFPath)\r\n{\r\nreturn _SUCCESS;\r\n}\r\nvoid\r\nrtl8192c_PHY_GetHWRegOriginalValue(\r\nstruct adapter *Adapter\r\n)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\npHalData->DefaultInitialGain[0] = (u8)PHY_QueryBBReg(Adapter, rOFDM0_XAAGCCore1, bMaskByte0);\r\npHalData->DefaultInitialGain[1] = (u8)PHY_QueryBBReg(Adapter, rOFDM0_XBAGCCore1, bMaskByte0);\r\npHalData->DefaultInitialGain[2] = (u8)PHY_QueryBBReg(Adapter, rOFDM0_XCAGCCore1, bMaskByte0);\r\npHalData->DefaultInitialGain[3] = (u8)PHY_QueryBBReg(Adapter, rOFDM0_XDAGCCore1, bMaskByte0);\r\npHalData->framesync = (u8)PHY_QueryBBReg(Adapter, rOFDM0_RxDetector3, bMaskByte0);\r\npHalData->framesyncC34 = PHY_QueryBBReg(Adapter, rOFDM0_RxDetector2, bMaskDWord);\r\n}\r\nstatic u8 phy_DbmToTxPwrIdx(struct adapter *Adapter, enum wireless_mode WirelessMode, int PowerInDbm)\r\n{\r\nu8 TxPwrIdx = 0;\r\nint Offset = 0;\r\nswitch (WirelessMode) {\r\ncase WIRELESS_MODE_B:\r\nOffset = -7;\r\nbreak;\r\ncase WIRELESS_MODE_G:\r\ncase WIRELESS_MODE_N_24G:\r\ndefault:\r\nOffset = -8;\r\nbreak;\r\n}\r\nif ((PowerInDbm - Offset) > 0)\r\nTxPwrIdx = (u8)((PowerInDbm - Offset) * 2);\r\nelse\r\nTxPwrIdx = 0;\r\nif (TxPwrIdx > MAX_TXPWR_IDX_NMODE_92S)\r\nTxPwrIdx = MAX_TXPWR_IDX_NMODE_92S;\r\nreturn TxPwrIdx;\r\n}\r\nstatic int phy_TxPwrIdxToDbm(struct adapter *Adapter, enum wireless_mode WirelessMode, u8 TxPwrIdx)\r\n{\r\nint Offset = 0;\r\nint PwrOutDbm = 0;\r\nswitch (WirelessMode) {\r\ncase WIRELESS_MODE_B:\r\nOffset = -7;\r\nbreak;\r\ncase WIRELESS_MODE_G:\r\ncase WIRELESS_MODE_N_24G:\r\ndefault:\r\nOffset = -8;\r\nbreak;\r\n}\r\nPwrOutDbm = TxPwrIdx / 2 + Offset;\r\nreturn PwrOutDbm;\r\n}\r\nvoid PHY_GetTxPowerLevel8188E(struct adapter *Adapter, u32 *powerlevel)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\nu8 TxPwrLevel = 0;\r\nint TxPwrDbm;\r\nTxPwrLevel = pHalData->CurrentCckTxPwrIdx;\r\nTxPwrDbm = phy_TxPwrIdxToDbm(Adapter, WIRELESS_MODE_B, TxPwrLevel);\r\nTxPwrLevel = pHalData->CurrentOfdm24GTxPwrIdx + pHalData->LegacyHTTxPowerDiff;\r\nif (phy_TxPwrIdxToDbm(Adapter, WIRELESS_MODE_G, TxPwrLevel) > TxPwrDbm)\r\nTxPwrDbm = phy_TxPwrIdxToDbm(Adapter, WIRELESS_MODE_G, TxPwrLevel);\r\nTxPwrLevel = pHalData->CurrentOfdm24GTxPwrIdx;\r\nif (phy_TxPwrIdxToDbm(Adapter, WIRELESS_MODE_N_24G, TxPwrLevel) > TxPwrDbm)\r\nTxPwrDbm = phy_TxPwrIdxToDbm(Adapter, WIRELESS_MODE_N_24G, TxPwrLevel);\r\n*powerlevel = TxPwrDbm;\r\n}\r\nstatic void getTxPowerIndex88E(struct adapter *Adapter, u8 channel, u8 *cckPowerLevel,\r\nu8 *ofdmPowerLevel, u8 *BW20PowerLevel,\r\nu8 *BW40PowerLevel)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\nu8 index = (channel - 1);\r\nu8 TxCount = 0, path_nums;\r\nif ((RF_1T2R == pHalData->rf_type) || (RF_1T1R == pHalData->rf_type))\r\npath_nums = 1;\r\nelse\r\npath_nums = 2;\r\nfor (TxCount = 0; TxCount < path_nums; TxCount++) {\r\nif (TxCount == RF_PATH_A) {\r\ncckPowerLevel[TxCount] = pHalData->Index24G_CCK_Base[TxCount][index];\r\nofdmPowerLevel[TxCount] = pHalData->Index24G_BW40_Base[RF_PATH_A][index]+\r\npHalData->OFDM_24G_Diff[TxCount][RF_PATH_A];\r\nBW20PowerLevel[TxCount] = pHalData->Index24G_BW40_Base[RF_PATH_A][index]+\r\npHalData->BW20_24G_Diff[TxCount][RF_PATH_A];\r\nBW40PowerLevel[TxCount] = pHalData->Index24G_BW40_Base[TxCount][index];\r\n} else if (TxCount == RF_PATH_B) {\r\ncckPowerLevel[TxCount] = pHalData->Index24G_CCK_Base[TxCount][index];\r\nofdmPowerLevel[TxCount] = pHalData->Index24G_BW40_Base[RF_PATH_A][index]+\r\npHalData->BW20_24G_Diff[RF_PATH_A][index]+\r\npHalData->BW20_24G_Diff[TxCount][index];\r\nBW20PowerLevel[TxCount] = pHalData->Index24G_BW40_Base[RF_PATH_A][index]+\r\npHalData->BW20_24G_Diff[TxCount][RF_PATH_A]+\r\npHalData->BW20_24G_Diff[TxCount][index];\r\nBW40PowerLevel[TxCount] = pHalData->Index24G_BW40_Base[TxCount][index];\r\n} else if (TxCount == RF_PATH_C) {\r\ncckPowerLevel[TxCount] = pHalData->Index24G_CCK_Base[TxCount][index];\r\nofdmPowerLevel[TxCount] = pHalData->Index24G_BW40_Base[RF_PATH_A][index]+\r\npHalData->BW20_24G_Diff[RF_PATH_A][index]+\r\npHalData->BW20_24G_Diff[RF_PATH_B][index]+\r\npHalData->BW20_24G_Diff[TxCount][index];\r\nBW20PowerLevel[TxCount] = pHalData->Index24G_BW40_Base[RF_PATH_A][index]+\r\npHalData->BW20_24G_Diff[RF_PATH_A][index]+\r\npHalData->BW20_24G_Diff[RF_PATH_B][index]+\r\npHalData->BW20_24G_Diff[TxCount][index];\r\nBW40PowerLevel[TxCount] = pHalData->Index24G_BW40_Base[TxCount][index];\r\n} else if (TxCount == RF_PATH_D) {\r\ncckPowerLevel[TxCount] = pHalData->Index24G_CCK_Base[TxCount][index];\r\nofdmPowerLevel[TxCount] = pHalData->Index24G_BW40_Base[RF_PATH_A][index]+\r\npHalData->BW20_24G_Diff[RF_PATH_A][index]+\r\npHalData->BW20_24G_Diff[RF_PATH_B][index]+\r\npHalData->BW20_24G_Diff[RF_PATH_C][index]+\r\npHalData->BW20_24G_Diff[TxCount][index];\r\nBW20PowerLevel[TxCount] = pHalData->Index24G_BW40_Base[RF_PATH_A][index]+\r\npHalData->BW20_24G_Diff[RF_PATH_A][index]+\r\npHalData->BW20_24G_Diff[RF_PATH_B][index]+\r\npHalData->BW20_24G_Diff[RF_PATH_C][index]+\r\npHalData->BW20_24G_Diff[TxCount][index];\r\nBW40PowerLevel[TxCount] = pHalData->Index24G_BW40_Base[TxCount][index];\r\n}\r\n}\r\n}\r\nstatic void phy_PowerIndexCheck88E(struct adapter *Adapter, u8 channel, u8 *cckPowerLevel,\r\nu8 *ofdmPowerLevel, u8 *BW20PowerLevel, u8 *BW40PowerLevel)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\npHalData->CurrentCckTxPwrIdx = cckPowerLevel[0];\r\npHalData->CurrentOfdm24GTxPwrIdx = ofdmPowerLevel[0];\r\npHalData->CurrentBW2024GTxPwrIdx = BW20PowerLevel[0];\r\npHalData->CurrentBW4024GTxPwrIdx = BW40PowerLevel[0];\r\n}\r\nvoid\r\nPHY_SetTxPowerLevel8188E(\r\nstruct adapter *Adapter,\r\nu8 channel\r\n)\r\n{\r\nu8 cckPowerLevel[MAX_TX_COUNT] = {0};\r\nu8 ofdmPowerLevel[MAX_TX_COUNT] = {0};\r\nu8 BW20PowerLevel[MAX_TX_COUNT] = {0};\r\nu8 BW40PowerLevel[MAX_TX_COUNT] = {0};\r\ngetTxPowerIndex88E(Adapter, channel, &cckPowerLevel[0], &ofdmPowerLevel[0], &BW20PowerLevel[0], &BW40PowerLevel[0]);\r\nphy_PowerIndexCheck88E(Adapter, channel, &cckPowerLevel[0], &ofdmPowerLevel[0], &BW20PowerLevel[0], &BW40PowerLevel[0]);\r\nrtl8188e_PHY_RF6052SetCckTxPower(Adapter, &cckPowerLevel[0]);\r\nrtl8188e_PHY_RF6052SetOFDMTxPower(Adapter, &ofdmPowerLevel[0], &BW20PowerLevel[0], &BW40PowerLevel[0], channel);\r\n}\r\nbool\r\nPHY_UpdateTxPowerDbm8188E(\r\nstruct adapter *Adapter,\r\nint powerInDbm\r\n)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\nu8 idx;\r\nu8 rf_path;\r\nu8 CckTxPwrIdx = phy_DbmToTxPwrIdx(Adapter, WIRELESS_MODE_B, powerInDbm);\r\nu8 OfdmTxPwrIdx = phy_DbmToTxPwrIdx(Adapter, WIRELESS_MODE_N_24G, powerInDbm);\r\nif (OfdmTxPwrIdx - pHalData->LegacyHTTxPowerDiff > 0)\r\nOfdmTxPwrIdx -= pHalData->LegacyHTTxPowerDiff;\r\nelse\r\nOfdmTxPwrIdx = 0;\r\nfor (idx = 0; idx < 14; idx++) {\r\nfor (rf_path = 0; rf_path < 2; rf_path++) {\r\npHalData->TxPwrLevelCck[rf_path][idx] = CckTxPwrIdx;\r\npHalData->TxPwrLevelHT40_1S[rf_path][idx] =\r\npHalData->TxPwrLevelHT40_2S[rf_path][idx] = OfdmTxPwrIdx;\r\n}\r\n}\r\nreturn true;\r\n}\r\nvoid\r\nPHY_ScanOperationBackup8188E(\r\nstruct adapter *Adapter,\r\nu8 Operation\r\n)\r\n{\r\n}\r\nstatic void\r\n_PHY_SetBWMode92C(\r\nstruct adapter *Adapter\r\n)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\nu8 regBwOpMode;\r\nu8 regRRSR_RSC;\r\nif (pHalData->rf_chip == RF_PSEUDO_11N)\r\nreturn;\r\nif (pHalData->rf_chip == RF_8225)\r\nreturn;\r\nif (Adapter->bDriverStopped)\r\nreturn;\r\nregBwOpMode = rtw_read8(Adapter, REG_BWOPMODE);\r\nregRRSR_RSC = rtw_read8(Adapter, REG_RRSR+2);\r\nswitch (pHalData->CurrentChannelBW) {\r\ncase HT_CHANNEL_WIDTH_20:\r\nregBwOpMode |= BW_OPMODE_20MHZ;\r\nrtw_write8(Adapter, REG_BWOPMODE, regBwOpMode);\r\nbreak;\r\ncase HT_CHANNEL_WIDTH_40:\r\nregBwOpMode &= ~BW_OPMODE_20MHZ;\r\nrtw_write8(Adapter, REG_BWOPMODE, regBwOpMode);\r\nregRRSR_RSC = (regRRSR_RSC&0x90) | (pHalData->nCur40MhzPrimeSC<<5);\r\nrtw_write8(Adapter, REG_RRSR+2, regRRSR_RSC);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (pHalData->CurrentChannelBW) {\r\ncase HT_CHANNEL_WIDTH_20:\r\nPHY_SetBBReg(Adapter, rFPGA0_RFMOD, bRFMOD, 0x0);\r\nPHY_SetBBReg(Adapter, rFPGA1_RFMOD, bRFMOD, 0x0);\r\nbreak;\r\ncase HT_CHANNEL_WIDTH_40:\r\nPHY_SetBBReg(Adapter, rFPGA0_RFMOD, bRFMOD, 0x1);\r\nPHY_SetBBReg(Adapter, rFPGA1_RFMOD, bRFMOD, 0x1);\r\nPHY_SetBBReg(Adapter, rCCK0_System, bCCKSideBand, (pHalData->nCur40MhzPrimeSC>>1));\r\nPHY_SetBBReg(Adapter, rOFDM1_LSTF, 0xC00, pHalData->nCur40MhzPrimeSC);\r\nPHY_SetBBReg(Adapter, 0x818, (BIT26 | BIT27),\r\n(pHalData->nCur40MhzPrimeSC == HAL_PRIME_CHNL_OFFSET_LOWER) ? 2 : 1);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (pHalData->rf_chip) {\r\ncase RF_8225:\r\nbreak;\r\ncase RF_8256:\r\nbreak;\r\ncase RF_8258:\r\nbreak;\r\ncase RF_PSEUDO_11N:\r\nbreak;\r\ncase RF_6052:\r\nrtl8188e_PHY_RF6052SetBandwidth(Adapter, pHalData->CurrentChannelBW);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nvoid PHY_SetBWMode8188E(struct adapter *Adapter, enum ht_channel_width Bandwidth,\r\nunsigned char Offset)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\nenum ht_channel_width tmpBW = pHalData->CurrentChannelBW;\r\npHalData->CurrentChannelBW = Bandwidth;\r\npHalData->nCur40MhzPrimeSC = Offset;\r\nif ((!Adapter->bDriverStopped) && (!Adapter->bSurpriseRemoved))\r\n_PHY_SetBWMode92C(Adapter);\r\nelse\r\npHalData->CurrentChannelBW = tmpBW;\r\n}\r\nstatic void _PHY_SwChnl8192C(struct adapter *Adapter, u8 channel)\r\n{\r\nu8 eRFPath;\r\nu32 param1, param2;\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\nif (Adapter->bNotifyChannelChange)\r\nDBG_88E("[%s] ch = %d\n", __func__, channel);\r\nPHY_SetTxPowerLevel8188E(Adapter, channel);\r\nparam1 = RF_CHNLBW;\r\nparam2 = channel;\r\nfor (eRFPath = 0; eRFPath < pHalData->NumTotalRFPath; eRFPath++) {\r\npHalData->RfRegChnlVal[eRFPath] = ((pHalData->RfRegChnlVal[eRFPath] & 0xfffffc00) | param2);\r\nPHY_SetRFReg(Adapter, (enum rf_radio_path)eRFPath, param1, bRFRegOffsetMask, pHalData->RfRegChnlVal[eRFPath]);\r\n}\r\n}\r\nvoid PHY_SwChnl8188E(struct adapter *Adapter, u8 channel)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(Adapter);\r\nu8 tmpchannel = pHalData->CurrentChannel;\r\nbool bResult = true;\r\nif (pHalData->rf_chip == RF_PSEUDO_11N)\r\nreturn;\r\nif (channel == 0)\r\nchannel = 1;\r\npHalData->CurrentChannel = channel;\r\nif ((!Adapter->bDriverStopped) && (!Adapter->bSurpriseRemoved)) {\r\n_PHY_SwChnl8192C(Adapter, channel);\r\nif (bResult)\r\n;\r\nelse\r\npHalData->CurrentChannel = tmpchannel;\r\n} else {\r\npHalData->CurrentChannel = tmpchannel;\r\n}\r\n}

void hdmi_phy_dump(struct hdmi_phy_data *phy, struct seq_file *s)\r\n{\r\n#define DUMPPHY(r) seq_printf(s, "%-35s %08x\n", #r,\\r\nhdmi_read_reg(phy->base, r))\r\nDUMPPHY(HDMI_TXPHY_TX_CTRL);\r\nDUMPPHY(HDMI_TXPHY_DIGITAL_CTRL);\r\nDUMPPHY(HDMI_TXPHY_POWER_CTRL);\r\nDUMPPHY(HDMI_TXPHY_PAD_CFG_CTRL);\r\n}\r\nstatic irqreturn_t hdmi_irq_handler(int irq, void *data)\r\n{\r\nstruct hdmi_wp_data *wp = data;\r\nu32 irqstatus;\r\nirqstatus = hdmi_wp_get_irqstatus(wp);\r\nhdmi_wp_set_irqstatus(wp, irqstatus);\r\nif ((irqstatus & HDMI_IRQ_LINK_CONNECT) &&\r\nirqstatus & HDMI_IRQ_LINK_DISCONNECT) {\r\nhdmi_wp_set_phy_pwr(wp, HDMI_PHYPWRCMD_OFF);\r\nhdmi_wp_set_irqstatus(wp, HDMI_IRQ_LINK_CONNECT |\r\nHDMI_IRQ_LINK_DISCONNECT);\r\nhdmi_wp_set_phy_pwr(wp, HDMI_PHYPWRCMD_LDOON);\r\n} else if (irqstatus & HDMI_IRQ_LINK_CONNECT) {\r\nhdmi_wp_set_phy_pwr(wp, HDMI_PHYPWRCMD_TXON);\r\n} else if (irqstatus & HDMI_IRQ_LINK_DISCONNECT) {\r\nhdmi_wp_set_phy_pwr(wp, HDMI_PHYPWRCMD_LDOON);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nint hdmi_phy_enable(struct hdmi_phy_data *phy, struct hdmi_wp_data *wp,\r\nstruct hdmi_config *cfg)\r\n{\r\nu16 r = 0;\r\nu32 irqstatus;\r\nhdmi_wp_clear_irqenable(wp, 0xffffffff);\r\nirqstatus = hdmi_wp_get_irqstatus(wp);\r\nhdmi_wp_set_irqstatus(wp, irqstatus);\r\nr = hdmi_wp_set_phy_pwr(wp, HDMI_PHYPWRCMD_LDOON);\r\nif (r)\r\nreturn r;\r\nhdmi_read_reg(phy->base, HDMI_TXPHY_TX_CTRL);\r\nREG_FLD_MOD(phy->base, HDMI_TXPHY_TX_CTRL, 0x1, 31, 30);\r\nhdmi_write_reg(phy->base, HDMI_TXPHY_DIGITAL_CTRL, 0xF0000000);\r\nREG_FLD_MOD(phy->base, HDMI_TXPHY_POWER_CTRL, 0xB, 3, 0);\r\nREG_FLD_MOD(phy->base, HDMI_TXPHY_PAD_CFG_CTRL, 0x1, 27, 27);\r\nr = request_threaded_irq(phy->irq, NULL, hdmi_irq_handler,\r\nIRQF_ONESHOT, "OMAP HDMI", wp);\r\nif (r) {\r\nDSSERR("HDMI IRQ request failed\n");\r\nhdmi_wp_set_phy_pwr(wp, HDMI_PHYPWRCMD_OFF);\r\nreturn r;\r\n}\r\nhdmi_wp_set_irqenable(wp,\r\nHDMI_IRQ_LINK_CONNECT | HDMI_IRQ_LINK_DISCONNECT);\r\nreturn 0;\r\n}\r\nvoid hdmi_phy_disable(struct hdmi_phy_data *phy, struct hdmi_wp_data *wp)\r\n{\r\nfree_irq(phy->irq, wp);\r\nhdmi_wp_set_phy_pwr(wp, HDMI_PHYPWRCMD_OFF);\r\n}\r\nint hdmi_phy_init(struct platform_device *pdev, struct hdmi_phy_data *phy)\r\n{\r\nstruct resource *res;\r\nstruct resource temp_res;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "phy");\r\nif (!res) {\r\nDSSDBG("can't get PHY mem resource by name\n");\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\nDSSERR("can't get PHY mem resource\n");\r\nreturn -EINVAL;\r\n}\r\ntemp_res.start = res->start + PHY_OFFSET;\r\ntemp_res.end = temp_res.start + PHY_SIZE - 1;\r\nres = &temp_res;\r\n}\r\nphy->base = devm_ioremap(&pdev->dev, res->start, resource_size(res));\r\nif (!phy->base) {\r\nDSSERR("can't ioremap TX PHY\n");\r\nreturn -ENOMEM;\r\n}\r\nphy->irq = platform_get_irq(pdev, 0);\r\nif (phy->irq < 0) {\r\nDSSERR("platform_get_irq failed\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}

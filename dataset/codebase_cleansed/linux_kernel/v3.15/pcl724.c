static int pcl724_8255mapped_io(int dir, int port, int data,\r\nunsigned long iobase)\r\n{\r\nint movport = SIZE_8255 * (iobase >> 12);\r\niobase &= 0x0fff;\r\nif (dir) {\r\noutb(port + movport, iobase);\r\noutb(data, iobase + 1);\r\nreturn 0;\r\n} else {\r\noutb(port + movport, iobase);\r\nreturn inb(iobase + 1);\r\n}\r\n}\r\nstatic int pcl724_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nconst struct pcl724_board *board = comedi_board(dev);\r\nstruct comedi_subdevice *s;\r\nunsigned long iobase;\r\nunsigned int iorange;\r\nint n_subdevices;\r\nint ret;\r\nint i;\r\niorange = board->io_range;\r\nn_subdevices = board->numofports;\r\nif (board->can_have96 &&\r\n(it->options[2] == 1 || it->options[2] == 96)) {\r\niorange = 0x10;\r\nn_subdevices = 4;\r\n}\r\nret = comedi_request_region(dev, it->options[0], iorange);\r\nif (ret)\r\nreturn ret;\r\nret = comedi_alloc_subdevices(dev, n_subdevices);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < dev->n_subdevices; i++) {\r\ns = &dev->subdevices[i];\r\nif (board->is_pet48) {\r\niobase = dev->iobase + (i * 0x1000);\r\nret = subdev_8255_init(dev, s, pcl724_8255mapped_io,\r\niobase);\r\n} else {\r\niobase = dev->iobase + (i * SIZE_8255);\r\nret = subdev_8255_init(dev, s, NULL, iobase);\r\n}\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

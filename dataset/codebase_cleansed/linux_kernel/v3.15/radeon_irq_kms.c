irqreturn_t radeon_driver_irq_handler_kms(int irq, void *arg)\r\n{\r\nstruct drm_device *dev = (struct drm_device *) arg;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nirqreturn_t ret;\r\nret = radeon_irq_process(rdev);\r\nif (ret == IRQ_HANDLED)\r\npm_runtime_mark_last_busy(dev->dev);\r\nreturn ret;\r\n}\r\nstatic void radeon_hotplug_work_func(struct work_struct *work)\r\n{\r\nstruct radeon_device *rdev = container_of(work, struct radeon_device,\r\nhotplug_work);\r\nstruct drm_device *dev = rdev->ddev;\r\nstruct drm_mode_config *mode_config = &dev->mode_config;\r\nstruct drm_connector *connector;\r\nif (mode_config->num_connector) {\r\nlist_for_each_entry(connector, &mode_config->connector_list, head)\r\nradeon_connector_hotplug(connector);\r\n}\r\ndrm_helper_hpd_irq_event(dev);\r\n}\r\nstatic void radeon_irq_reset_work_func(struct work_struct *work)\r\n{\r\nstruct radeon_device *rdev = container_of(work, struct radeon_device,\r\nreset_work);\r\nradeon_gpu_reset(rdev);\r\n}\r\nvoid radeon_driver_irq_preinstall_kms(struct drm_device *dev)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nunsigned long irqflags;\r\nunsigned i;\r\nspin_lock_irqsave(&rdev->irq.lock, irqflags);\r\nfor (i = 0; i < RADEON_NUM_RINGS; i++)\r\natomic_set(&rdev->irq.ring_int[i], 0);\r\nrdev->irq.dpm_thermal = false;\r\nfor (i = 0; i < RADEON_MAX_HPD_PINS; i++)\r\nrdev->irq.hpd[i] = false;\r\nfor (i = 0; i < RADEON_MAX_CRTCS; i++) {\r\nrdev->irq.crtc_vblank_int[i] = false;\r\natomic_set(&rdev->irq.pflip[i], 0);\r\nrdev->irq.afmt[i] = false;\r\n}\r\nradeon_irq_set(rdev);\r\nspin_unlock_irqrestore(&rdev->irq.lock, irqflags);\r\nradeon_irq_process(rdev);\r\n}\r\nint radeon_driver_irq_postinstall_kms(struct drm_device *dev)\r\n{\r\ndev->max_vblank_count = 0x001fffff;\r\nreturn 0;\r\n}\r\nvoid radeon_driver_irq_uninstall_kms(struct drm_device *dev)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nunsigned long irqflags;\r\nunsigned i;\r\nif (rdev == NULL) {\r\nreturn;\r\n}\r\nspin_lock_irqsave(&rdev->irq.lock, irqflags);\r\nfor (i = 0; i < RADEON_NUM_RINGS; i++)\r\natomic_set(&rdev->irq.ring_int[i], 0);\r\nrdev->irq.dpm_thermal = false;\r\nfor (i = 0; i < RADEON_MAX_HPD_PINS; i++)\r\nrdev->irq.hpd[i] = false;\r\nfor (i = 0; i < RADEON_MAX_CRTCS; i++) {\r\nrdev->irq.crtc_vblank_int[i] = false;\r\natomic_set(&rdev->irq.pflip[i], 0);\r\nrdev->irq.afmt[i] = false;\r\n}\r\nradeon_irq_set(rdev);\r\nspin_unlock_irqrestore(&rdev->irq.lock, irqflags);\r\n}\r\nstatic bool radeon_msi_ok(struct radeon_device *rdev)\r\n{\r\nif (rdev->family < CHIP_RV380)\r\nreturn false;\r\nif (rdev->flags & RADEON_IS_AGP)\r\nreturn false;\r\nif (radeon_msi == 1)\r\nreturn true;\r\nelse if (radeon_msi == 0)\r\nreturn false;\r\nif ((rdev->pdev->device == 0x791f) &&\r\n(rdev->pdev->subsystem_vendor == 0x103c) &&\r\n(rdev->pdev->subsystem_device == 0x30c2))\r\nreturn true;\r\nif ((rdev->pdev->device == 0x791f) &&\r\n(rdev->pdev->subsystem_vendor == 0x1028) &&\r\n(rdev->pdev->subsystem_device == 0x01fc))\r\nreturn true;\r\nif ((rdev->pdev->device == 0x791f) &&\r\n(rdev->pdev->subsystem_vendor == 0x1028) &&\r\n(rdev->pdev->subsystem_device == 0x01fd))\r\nreturn true;\r\nif ((rdev->pdev->device == 0x791f) &&\r\n(rdev->pdev->subsystem_vendor == 0x107b) &&\r\n(rdev->pdev->subsystem_device == 0x0185))\r\nreturn true;\r\nif (rdev->family == CHIP_RS690)\r\nreturn true;\r\nif (rdev->family == CHIP_RV515)\r\nreturn false;\r\nif (rdev->flags & RADEON_IS_IGP) {\r\nif (rdev->family >= CHIP_PALM)\r\nreturn true;\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nint radeon_irq_kms_init(struct radeon_device *rdev)\r\n{\r\nint r = 0;\r\nspin_lock_init(&rdev->irq.lock);\r\nr = drm_vblank_init(rdev->ddev, rdev->num_crtc);\r\nif (r) {\r\nreturn r;\r\n}\r\nrdev->msi_enabled = 0;\r\nif (radeon_msi_ok(rdev)) {\r\nint ret = pci_enable_msi(rdev->pdev);\r\nif (!ret) {\r\nrdev->msi_enabled = 1;\r\ndev_info(rdev->dev, "radeon: using MSI.\n");\r\n}\r\n}\r\nINIT_WORK(&rdev->hotplug_work, radeon_hotplug_work_func);\r\nINIT_WORK(&rdev->audio_work, r600_audio_update_hdmi);\r\nINIT_WORK(&rdev->reset_work, radeon_irq_reset_work_func);\r\nrdev->irq.installed = true;\r\nr = drm_irq_install(rdev->ddev);\r\nif (r) {\r\nrdev->irq.installed = false;\r\nflush_work(&rdev->hotplug_work);\r\nreturn r;\r\n}\r\nDRM_INFO("radeon: irq initialized.\n");\r\nreturn 0;\r\n}\r\nvoid radeon_irq_kms_fini(struct radeon_device *rdev)\r\n{\r\ndrm_vblank_cleanup(rdev->ddev);\r\nif (rdev->irq.installed) {\r\ndrm_irq_uninstall(rdev->ddev);\r\nrdev->irq.installed = false;\r\nif (rdev->msi_enabled)\r\npci_disable_msi(rdev->pdev);\r\nflush_work(&rdev->hotplug_work);\r\n}\r\n}\r\nvoid radeon_irq_kms_sw_irq_get(struct radeon_device *rdev, int ring)\r\n{\r\nunsigned long irqflags;\r\nif (!rdev->ddev->irq_enabled)\r\nreturn;\r\nif (atomic_inc_return(&rdev->irq.ring_int[ring]) == 1) {\r\nspin_lock_irqsave(&rdev->irq.lock, irqflags);\r\nradeon_irq_set(rdev);\r\nspin_unlock_irqrestore(&rdev->irq.lock, irqflags);\r\n}\r\n}\r\nvoid radeon_irq_kms_sw_irq_put(struct radeon_device *rdev, int ring)\r\n{\r\nunsigned long irqflags;\r\nif (!rdev->ddev->irq_enabled)\r\nreturn;\r\nif (atomic_dec_and_test(&rdev->irq.ring_int[ring])) {\r\nspin_lock_irqsave(&rdev->irq.lock, irqflags);\r\nradeon_irq_set(rdev);\r\nspin_unlock_irqrestore(&rdev->irq.lock, irqflags);\r\n}\r\n}\r\nvoid radeon_irq_kms_pflip_irq_get(struct radeon_device *rdev, int crtc)\r\n{\r\nunsigned long irqflags;\r\nif (crtc < 0 || crtc >= rdev->num_crtc)\r\nreturn;\r\nif (!rdev->ddev->irq_enabled)\r\nreturn;\r\nif (atomic_inc_return(&rdev->irq.pflip[crtc]) == 1) {\r\nspin_lock_irqsave(&rdev->irq.lock, irqflags);\r\nradeon_irq_set(rdev);\r\nspin_unlock_irqrestore(&rdev->irq.lock, irqflags);\r\n}\r\n}\r\nvoid radeon_irq_kms_pflip_irq_put(struct radeon_device *rdev, int crtc)\r\n{\r\nunsigned long irqflags;\r\nif (crtc < 0 || crtc >= rdev->num_crtc)\r\nreturn;\r\nif (!rdev->ddev->irq_enabled)\r\nreturn;\r\nif (atomic_dec_and_test(&rdev->irq.pflip[crtc])) {\r\nspin_lock_irqsave(&rdev->irq.lock, irqflags);\r\nradeon_irq_set(rdev);\r\nspin_unlock_irqrestore(&rdev->irq.lock, irqflags);\r\n}\r\n}\r\nvoid radeon_irq_kms_enable_afmt(struct radeon_device *rdev, int block)\r\n{\r\nunsigned long irqflags;\r\nif (!rdev->ddev->irq_enabled)\r\nreturn;\r\nspin_lock_irqsave(&rdev->irq.lock, irqflags);\r\nrdev->irq.afmt[block] = true;\r\nradeon_irq_set(rdev);\r\nspin_unlock_irqrestore(&rdev->irq.lock, irqflags);\r\n}\r\nvoid radeon_irq_kms_disable_afmt(struct radeon_device *rdev, int block)\r\n{\r\nunsigned long irqflags;\r\nif (!rdev->ddev->irq_enabled)\r\nreturn;\r\nspin_lock_irqsave(&rdev->irq.lock, irqflags);\r\nrdev->irq.afmt[block] = false;\r\nradeon_irq_set(rdev);\r\nspin_unlock_irqrestore(&rdev->irq.lock, irqflags);\r\n}\r\nvoid radeon_irq_kms_enable_hpd(struct radeon_device *rdev, unsigned hpd_mask)\r\n{\r\nunsigned long irqflags;\r\nint i;\r\nif (!rdev->ddev->irq_enabled)\r\nreturn;\r\nspin_lock_irqsave(&rdev->irq.lock, irqflags);\r\nfor (i = 0; i < RADEON_MAX_HPD_PINS; ++i)\r\nrdev->irq.hpd[i] |= !!(hpd_mask & (1 << i));\r\nradeon_irq_set(rdev);\r\nspin_unlock_irqrestore(&rdev->irq.lock, irqflags);\r\n}\r\nvoid radeon_irq_kms_disable_hpd(struct radeon_device *rdev, unsigned hpd_mask)\r\n{\r\nunsigned long irqflags;\r\nint i;\r\nif (!rdev->ddev->irq_enabled)\r\nreturn;\r\nspin_lock_irqsave(&rdev->irq.lock, irqflags);\r\nfor (i = 0; i < RADEON_MAX_HPD_PINS; ++i)\r\nrdev->irq.hpd[i] &= !(hpd_mask & (1 << i));\r\nradeon_irq_set(rdev);\r\nspin_unlock_irqrestore(&rdev->irq.lock, irqflags);\r\n}

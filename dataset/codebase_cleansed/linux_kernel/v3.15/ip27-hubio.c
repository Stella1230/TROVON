unsigned long hub_pio_map(cnodeid_t cnode, xwidgetnum_t widget,\r\nunsigned long xtalk_addr, size_t size)\r\n{\r\nnasid_t nasid = COMPACT_TO_NASID_NODEID(cnode);\r\nunsigned i;\r\nif ((xtalk_addr % SWIN_SIZE) + size <= SWIN_SIZE)\r\nreturn NODE_SWIN_BASE(nasid, widget) + (xtalk_addr % SWIN_SIZE);\r\nif ((xtalk_addr % BWIN_SIZE) + size > BWIN_SIZE) {\r\nprintk(KERN_WARNING "PIO mapping at hub %d widget %d addr 0x%lx"\r\n" too big (%ld)\n",\r\nnasid, widget, xtalk_addr, size);\r\nreturn 0;\r\n}\r\nxtalk_addr &= ~(BWIN_SIZE-1);\r\nfor (i = 0; i < HUB_NUM_BIG_WINDOW; i++) {\r\nif (test_and_set_bit(i, hub_data(cnode)->h_bigwin_used))\r\ncontinue;\r\nIIO_ITTE_PUT(nasid, i, HUB_PIO_MAP_TO_MEM, widget, xtalk_addr);\r\n(void) HUB_L(IIO_ITTE_GET(nasid, i));\r\nreturn NODE_BWIN_BASE(nasid, widget) + (xtalk_addr % BWIN_SIZE);\r\n}\r\nprintk(KERN_WARNING "unable to establish PIO mapping for at"\r\n" hub %d widget %d addr 0x%lx\n",\r\nnasid, widget, xtalk_addr);\r\nreturn 0;\r\n}\r\nstatic void hub_setup_prb(nasid_t nasid, int prbnum, int credits)\r\n{\r\niprb_t prb;\r\nint prb_offset;\r\nprb_offset = IIO_IOPRB(prbnum);\r\nprb.iprb_regval = REMOTE_HUB_L(nasid, prb_offset);\r\nprb.iprb_ovflow = 1;\r\nprb.iprb_bnakctr = 0;\r\nprb.iprb_anakctr = 0;\r\nprb.iprb_ff = force_fire_and_forget ? 1 : 0;\r\nprb.iprb_xtalkctr = credits;\r\nREMOTE_HUB_S(nasid, prb_offset, prb.iprb_regval);\r\n}\r\nstatic void hub_set_piomode(nasid_t nasid)\r\n{\r\nhubreg_t ii_iowa;\r\nhubii_wcr_t ii_wcr;\r\nunsigned i;\r\nii_iowa = REMOTE_HUB_L(nasid, IIO_OUTWIDGET_ACCESS);\r\nREMOTE_HUB_S(nasid, IIO_OUTWIDGET_ACCESS, 0);\r\nii_wcr.wcr_reg_value = REMOTE_HUB_L(nasid, IIO_WCR);\r\nif (ii_wcr.iwcr_dir_con) {\r\nhub_setup_prb(nasid, 0, 3);\r\n} else {\r\nhub_setup_prb(nasid, 0, 1);\r\n}\r\nfor (i = HUB_WIDGET_ID_MIN; i <= HUB_WIDGET_ID_MAX; i++)\r\nhub_setup_prb(nasid, i, 3);\r\nREMOTE_HUB_S(nasid, IIO_OUTWIDGET_ACCESS, ii_iowa);\r\n}\r\nvoid hub_pio_init(cnodeid_t cnode)\r\n{\r\nnasid_t nasid = COMPACT_TO_NASID_NODEID(cnode);\r\nunsigned i;\r\nbitmap_zero(hub_data(cnode)->h_bigwin_used, HUB_NUM_BIG_WINDOW);\r\nfor (i = 0; i < HUB_NUM_BIG_WINDOW; i++)\r\nIIO_ITTE_DISABLE(nasid, i);\r\nhub_set_piomode(nasid);\r\n}

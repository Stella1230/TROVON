static inline struct lp3943_pwm *to_lp3943_pwm(struct pwm_chip *_chip)\r\n{\r\nreturn container_of(_chip, struct lp3943_pwm, chip);\r\n}\r\nstatic struct lp3943_pwm_map *\r\nlp3943_pwm_request_map(struct lp3943_pwm *lp3943_pwm, int hwpwm)\r\n{\r\nstruct lp3943_platform_data *pdata = lp3943_pwm->pdata;\r\nstruct lp3943 *lp3943 = lp3943_pwm->lp3943;\r\nstruct lp3943_pwm_map *pwm_map;\r\nint i, offset;\r\npwm_map = kzalloc(sizeof(*pwm_map), GFP_KERNEL);\r\nif (!pwm_map)\r\nreturn ERR_PTR(-ENOMEM);\r\npwm_map->output = pdata->pwms[hwpwm]->output;\r\npwm_map->num_outputs = pdata->pwms[hwpwm]->num_outputs;\r\nfor (i = 0; i < pwm_map->num_outputs; i++) {\r\noffset = pwm_map->output[i];\r\nif (test_and_set_bit(offset, &lp3943->pin_used)) {\r\nkfree(pwm_map);\r\nreturn ERR_PTR(-EBUSY);\r\n}\r\n}\r\nreturn pwm_map;\r\n}\r\nstatic int lp3943_pwm_request(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct lp3943_pwm *lp3943_pwm = to_lp3943_pwm(chip);\r\nstruct lp3943_pwm_map *pwm_map;\r\npwm_map = lp3943_pwm_request_map(lp3943_pwm, pwm->hwpwm);\r\nif (IS_ERR(pwm_map))\r\nreturn PTR_ERR(pwm_map);\r\nreturn pwm_set_chip_data(pwm, pwm_map);\r\n}\r\nstatic void lp3943_pwm_free_map(struct lp3943_pwm *lp3943_pwm,\r\nstruct lp3943_pwm_map *pwm_map)\r\n{\r\nstruct lp3943 *lp3943 = lp3943_pwm->lp3943;\r\nint i, offset;\r\nfor (i = 0; i < pwm_map->num_outputs; i++) {\r\noffset = pwm_map->output[i];\r\nclear_bit(offset, &lp3943->pin_used);\r\n}\r\nkfree(pwm_map);\r\n}\r\nstatic void lp3943_pwm_free(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct lp3943_pwm *lp3943_pwm = to_lp3943_pwm(chip);\r\nstruct lp3943_pwm_map *pwm_map = pwm_get_chip_data(pwm);\r\nlp3943_pwm_free_map(lp3943_pwm, pwm_map);\r\n}\r\nstatic int lp3943_pwm_config(struct pwm_chip *chip, struct pwm_device *pwm,\r\nint duty_ns, int period_ns)\r\n{\r\nstruct lp3943_pwm *lp3943_pwm = to_lp3943_pwm(chip);\r\nstruct lp3943 *lp3943 = lp3943_pwm->lp3943;\r\nu8 val, reg_duty, reg_prescale;\r\nint err;\r\nif (pwm->hwpwm == 0) {\r\nreg_prescale = LP3943_REG_PRESCALE0;\r\nreg_duty = LP3943_REG_PWM0;\r\n} else {\r\nreg_prescale = LP3943_REG_PRESCALE1;\r\nreg_duty = LP3943_REG_PWM1;\r\n}\r\nperiod_ns = clamp(period_ns, LP3943_MIN_PERIOD, LP3943_MAX_PERIOD);\r\nval = (u8)(period_ns / LP3943_MIN_PERIOD - 1);\r\nerr = lp3943_write_byte(lp3943, reg_prescale, val);\r\nif (err)\r\nreturn err;\r\nval = (u8)(duty_ns * LP3943_MAX_DUTY / period_ns);\r\nreturn lp3943_write_byte(lp3943, reg_duty, val);\r\n}\r\nstatic int lp3943_pwm_set_mode(struct lp3943_pwm *lp3943_pwm,\r\nstruct lp3943_pwm_map *pwm_map,\r\nu8 val)\r\n{\r\nstruct lp3943 *lp3943 = lp3943_pwm->lp3943;\r\nconst struct lp3943_reg_cfg *mux = lp3943->mux_cfg;\r\nint i, index, err;\r\nfor (i = 0; i < pwm_map->num_outputs; i++) {\r\nindex = pwm_map->output[i];\r\nerr = lp3943_update_bits(lp3943, mux[index].reg,\r\nmux[index].mask,\r\nval << mux[index].shift);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lp3943_pwm_enable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct lp3943_pwm *lp3943_pwm = to_lp3943_pwm(chip);\r\nstruct lp3943_pwm_map *pwm_map = pwm_get_chip_data(pwm);\r\nu8 val;\r\nif (pwm->hwpwm == 0)\r\nval = LP3943_DIM_PWM0;\r\nelse\r\nval = LP3943_DIM_PWM1;\r\nreturn lp3943_pwm_set_mode(lp3943_pwm, pwm_map, val);\r\n}\r\nstatic void lp3943_pwm_disable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct lp3943_pwm *lp3943_pwm = to_lp3943_pwm(chip);\r\nstruct lp3943_pwm_map *pwm_map = pwm_get_chip_data(pwm);\r\nlp3943_pwm_set_mode(lp3943_pwm, pwm_map, LP3943_GPIO_OUT_HIGH);\r\n}\r\nstatic int lp3943_pwm_parse_dt(struct device *dev,\r\nstruct lp3943_pwm *lp3943_pwm)\r\n{\r\nstatic const char * const name[] = { "ti,pwm0", "ti,pwm1", };\r\nstruct device_node *node = dev->of_node;\r\nstruct lp3943_platform_data *pdata;\r\nstruct lp3943_pwm_map *pwm_map;\r\nenum lp3943_pwm_output *output;\r\nint i, err, proplen, count = 0;\r\nu32 num_outputs;\r\nif (!node)\r\nreturn -EINVAL;\r\npdata = devm_kzalloc(dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < LP3943_NUM_PWMS; i++) {\r\nif (!of_get_property(node, name[i], &proplen))\r\ncontinue;\r\nnum_outputs = proplen / sizeof(u32);\r\nif (num_outputs == 0)\r\ncontinue;\r\noutput = devm_kzalloc(dev, sizeof(*output) * num_outputs,\r\nGFP_KERNEL);\r\nif (!output)\r\nreturn -ENOMEM;\r\nerr = of_property_read_u32_array(node, name[i], output,\r\nnum_outputs);\r\nif (err)\r\nreturn err;\r\npwm_map = devm_kzalloc(dev, sizeof(*pwm_map), GFP_KERNEL);\r\nif (!pwm_map)\r\nreturn -ENOMEM;\r\npwm_map->output = output;\r\npwm_map->num_outputs = num_outputs;\r\npdata->pwms[i] = pwm_map;\r\ncount++;\r\n}\r\nif (count == 0)\r\nreturn -ENODATA;\r\nlp3943_pwm->pdata = pdata;\r\nreturn 0;\r\n}\r\nstatic int lp3943_pwm_probe(struct platform_device *pdev)\r\n{\r\nstruct lp3943 *lp3943 = dev_get_drvdata(pdev->dev.parent);\r\nstruct lp3943_pwm *lp3943_pwm;\r\nint ret;\r\nlp3943_pwm = devm_kzalloc(&pdev->dev, sizeof(*lp3943_pwm), GFP_KERNEL);\r\nif (!lp3943_pwm)\r\nreturn -ENOMEM;\r\nlp3943_pwm->pdata = lp3943->pdata;\r\nif (!lp3943_pwm->pdata) {\r\nif (IS_ENABLED(CONFIG_OF))\r\nret = lp3943_pwm_parse_dt(&pdev->dev, lp3943_pwm);\r\nelse\r\nret = -ENODEV;\r\nif (ret)\r\nreturn ret;\r\n}\r\nlp3943_pwm->lp3943 = lp3943;\r\nlp3943_pwm->chip.dev = &pdev->dev;\r\nlp3943_pwm->chip.ops = &lp3943_pwm_ops;\r\nlp3943_pwm->chip.npwm = LP3943_NUM_PWMS;\r\nplatform_set_drvdata(pdev, lp3943_pwm);\r\nreturn pwmchip_add(&lp3943_pwm->chip);\r\n}\r\nstatic int lp3943_pwm_remove(struct platform_device *pdev)\r\n{\r\nstruct lp3943_pwm *lp3943_pwm = platform_get_drvdata(pdev);\r\nreturn pwmchip_remove(&lp3943_pwm->chip);\r\n}

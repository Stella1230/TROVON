static unsigned long clk_factors_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nu8 n = 1, k = 0, p = 0, m = 0;\r\nu32 reg;\r\nunsigned long rate;\r\nstruct clk_factors *factors = to_clk_factors(hw);\r\nstruct clk_factors_config *config = factors->config;\r\nreg = readl(factors->reg);\r\nif (config->nwidth != SUNXI_FACTORS_NOT_APPLICABLE)\r\nn = FACTOR_GET(config->nshift, config->nwidth, reg);\r\nif (config->kwidth != SUNXI_FACTORS_NOT_APPLICABLE)\r\nk = FACTOR_GET(config->kshift, config->kwidth, reg);\r\nif (config->mwidth != SUNXI_FACTORS_NOT_APPLICABLE)\r\nm = FACTOR_GET(config->mshift, config->mwidth, reg);\r\nif (config->pwidth != SUNXI_FACTORS_NOT_APPLICABLE)\r\np = FACTOR_GET(config->pshift, config->pwidth, reg);\r\nrate = (parent_rate * n * (k + 1) >> p) / (m + 1);\r\nreturn rate;\r\n}\r\nstatic long clk_factors_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nstruct clk_factors *factors = to_clk_factors(hw);\r\nfactors->get_factors((u32 *)&rate, (u32)*parent_rate,\r\nNULL, NULL, NULL, NULL);\r\nreturn rate;\r\n}\r\nstatic int clk_factors_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nu8 n = 0, k = 0, m = 0, p = 0;\r\nu32 reg;\r\nstruct clk_factors *factors = to_clk_factors(hw);\r\nstruct clk_factors_config *config = factors->config;\r\nunsigned long flags = 0;\r\nfactors->get_factors((u32 *)&rate, (u32)parent_rate, &n, &k, &m, &p);\r\nif (factors->lock)\r\nspin_lock_irqsave(factors->lock, flags);\r\nreg = readl(factors->reg);\r\nreg = FACTOR_SET(config->nshift, config->nwidth, reg, n);\r\nreg = FACTOR_SET(config->kshift, config->kwidth, reg, k);\r\nreg = FACTOR_SET(config->mshift, config->mwidth, reg, m);\r\nreg = FACTOR_SET(config->pshift, config->pwidth, reg, p);\r\nwritel(reg, factors->reg);\r\n__delay((rate >> 20) * 500 / 2);\r\nif (factors->lock)\r\nspin_unlock_irqrestore(factors->lock, flags);\r\nreturn 0;\r\n}

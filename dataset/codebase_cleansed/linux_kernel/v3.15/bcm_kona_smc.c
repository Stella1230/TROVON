int __init bcm_kona_smc_init(void)\r\n{\r\nstruct device_node *node;\r\nnode = of_find_matching_node(NULL, bcm_kona_smc_ids);\r\nif (!node)\r\nreturn -ENODEV;\r\nbridge_data.buffer_addr =\r\nbe32_to_cpu(*of_get_address(node, 0, NULL, NULL));\r\nBUG_ON(!bridge_data.buffer_addr);\r\nbridge_data.bounce = of_iomap(node, 0);\r\nBUG_ON(!bridge_data.bounce);\r\nbridge_data.initialized = 1;\r\npr_info("Kona Secure API initialized\n");\r\nreturn 0;\r\n}\r\nstatic void __bcm_kona_smc(void *info)\r\n{\r\nstruct bcm_kona_smc_data *data = info;\r\nu32 *args = bridge_data.bounce;\r\nint rc = 0;\r\nBUG_ON(smp_processor_id() != 0);\r\nBUG_ON(!bridge_data.initialized);\r\nargs[0] = data->arg0;\r\nargs[1] = data->arg1;\r\nargs[2] = data->arg2;\r\nargs[3] = data->arg3;\r\nif (data->service_id != SSAPI_BRCM_START_VC_CORE)\r\nflush_cache_all();\r\nrc = bcm_kona_smc_asm(data->service_id, bridge_data.buffer_addr);\r\nif (rc != SEC_ROM_RET_OK)\r\npr_err("Secure Monitor call failed (0x%x)!\n", rc);\r\n}\r\nunsigned bcm_kona_smc(unsigned service_id, unsigned arg0, unsigned arg1,\r\nunsigned arg2, unsigned arg3)\r\n{\r\nstruct bcm_kona_smc_data data;\r\ndata.service_id = service_id;\r\ndata.arg0 = arg0;\r\ndata.arg1 = arg1;\r\ndata.arg2 = arg2;\r\ndata.arg3 = arg3;\r\nif (get_cpu() != 0)\r\nsmp_call_function_single(0, __bcm_kona_smc, (void *)&data, 1);\r\nelse\r\n__bcm_kona_smc(&data);\r\nput_cpu();\r\nreturn 0;\r\n}

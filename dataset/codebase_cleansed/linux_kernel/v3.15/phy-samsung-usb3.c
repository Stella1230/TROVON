static u32 samsung_usb3phy_set_refclk(struct samsung_usbphy *sphy)\r\n{\r\nu32 reg;\r\nu32 refclk;\r\nrefclk = sphy->ref_clk_freq;\r\nreg = PHYCLKRST_REFCLKSEL_EXT_REFCLK |\r\nPHYCLKRST_FSEL(refclk);\r\nswitch (refclk) {\r\ncase FSEL_CLKSEL_50M:\r\nreg |= (PHYCLKRST_MPLL_MULTIPLIER_50M_REF |\r\nPHYCLKRST_SSC_REFCLKSEL(0x00));\r\nbreak;\r\ncase FSEL_CLKSEL_20M:\r\nreg |= (PHYCLKRST_MPLL_MULTIPLIER_20MHZ_REF |\r\nPHYCLKRST_SSC_REFCLKSEL(0x00));\r\nbreak;\r\ncase FSEL_CLKSEL_19200K:\r\nreg |= (PHYCLKRST_MPLL_MULTIPLIER_19200KHZ_REF |\r\nPHYCLKRST_SSC_REFCLKSEL(0x88));\r\nbreak;\r\ncase FSEL_CLKSEL_24M:\r\ndefault:\r\nreg |= (PHYCLKRST_MPLL_MULTIPLIER_24MHZ_REF |\r\nPHYCLKRST_SSC_REFCLKSEL(0x88));\r\nbreak;\r\n}\r\nreturn reg;\r\n}\r\nstatic void samsung_exynos5_usb3phy_enable(struct samsung_usbphy *sphy)\r\n{\r\nvoid __iomem *regs = sphy->regs;\r\nu32 phyparam0;\r\nu32 phyparam1;\r\nu32 linksystem;\r\nu32 phybatchg;\r\nu32 phytest;\r\nu32 phyclkrst;\r\nwritel(0x0, regs + EXYNOS5_DRD_PHYREG0);\r\nphyparam0 = readl(regs + EXYNOS5_DRD_PHYPARAM0);\r\nphyparam0 &= ~PHYPARAM0_REF_USE_PAD;\r\nphyparam0 &= ~PHYPARAM0_REF_LOSLEVEL_MASK;\r\nphyparam0 |= PHYPARAM0_REF_LOSLEVEL;\r\nwritel(phyparam0, regs + EXYNOS5_DRD_PHYPARAM0);\r\nwritel(0x0, regs + EXYNOS5_DRD_PHYRESUME);\r\nlinksystem = LINKSYSTEM_XHCI_VERSION_CONTROL |\r\nLINKSYSTEM_FLADJ(0x20);\r\nwritel(linksystem, regs + EXYNOS5_DRD_LINKSYSTEM);\r\nphyparam1 = readl(regs + EXYNOS5_DRD_PHYPARAM1);\r\nphyparam1 &= ~PHYPARAM1_PCS_TXDEEMPH_MASK;\r\nphyparam1 |= PHYPARAM1_PCS_TXDEEMPH;\r\nwritel(phyparam1, regs + EXYNOS5_DRD_PHYPARAM1);\r\nphybatchg = readl(regs + EXYNOS5_DRD_PHYBATCHG);\r\nphybatchg |= PHYBATCHG_UTMI_CLKSEL;\r\nwritel(phybatchg, regs + EXYNOS5_DRD_PHYBATCHG);\r\nphytest = readl(regs + EXYNOS5_DRD_PHYTEST);\r\nphytest &= ~(PHYTEST_POWERDOWN_SSP |\r\nPHYTEST_POWERDOWN_HSP);\r\nwritel(phytest, regs + EXYNOS5_DRD_PHYTEST);\r\nwritel(PHYUTMI_OTGDISABLE, regs + EXYNOS5_DRD_PHYUTMI);\r\nphyclkrst = samsung_usb3phy_set_refclk(sphy);\r\nphyclkrst |= PHYCLKRST_PORTRESET |\r\nPHYCLKRST_RETENABLEN |\r\nPHYCLKRST_REF_SSP_EN |\r\nPHYCLKRST_SSC_EN |\r\nPHYCLKRST_COMMONONN;\r\nwritel(phyclkrst, regs + EXYNOS5_DRD_PHYCLKRST);\r\nudelay(10);\r\nphyclkrst &= ~(PHYCLKRST_PORTRESET);\r\nwritel(phyclkrst, regs + EXYNOS5_DRD_PHYCLKRST);\r\n}\r\nstatic void samsung_exynos5_usb3phy_disable(struct samsung_usbphy *sphy)\r\n{\r\nu32 phyutmi;\r\nu32 phyclkrst;\r\nu32 phytest;\r\nvoid __iomem *regs = sphy->regs;\r\nphyutmi = PHYUTMI_OTGDISABLE |\r\nPHYUTMI_FORCESUSPEND |\r\nPHYUTMI_FORCESLEEP;\r\nwritel(phyutmi, regs + EXYNOS5_DRD_PHYUTMI);\r\nphyclkrst = readl(regs + EXYNOS5_DRD_PHYCLKRST);\r\nphyclkrst &= ~(PHYCLKRST_REF_SSP_EN |\r\nPHYCLKRST_SSC_EN |\r\nPHYCLKRST_COMMONONN);\r\nwritel(phyclkrst, regs + EXYNOS5_DRD_PHYCLKRST);\r\nphytest = readl(regs + EXYNOS5_DRD_PHYTEST);\r\nphytest |= (PHYTEST_POWERDOWN_SSP |\r\nPHYTEST_POWERDOWN_HSP);\r\nwritel(phytest, regs + EXYNOS5_DRD_PHYTEST);\r\n}\r\nstatic int samsung_usb3phy_init(struct usb_phy *phy)\r\n{\r\nstruct samsung_usbphy *sphy;\r\nunsigned long flags;\r\nint ret = 0;\r\nsphy = phy_to_sphy(phy);\r\nret = clk_prepare_enable(sphy->clk);\r\nif (ret) {\r\ndev_err(sphy->dev, "%s: clk_prepare_enable failed\n", __func__);\r\nreturn ret;\r\n}\r\nspin_lock_irqsave(&sphy->lock, flags);\r\nsamsung_usbphy_set_type(&sphy->phy, USB_PHY_TYPE_DEVICE);\r\nif (sphy->drv_data->set_isolation)\r\nsphy->drv_data->set_isolation(sphy, false);\r\nsphy->drv_data->phy_enable(sphy);\r\nspin_unlock_irqrestore(&sphy->lock, flags);\r\nclk_disable_unprepare(sphy->clk);\r\nreturn ret;\r\n}\r\nstatic void samsung_usb3phy_shutdown(struct usb_phy *phy)\r\n{\r\nstruct samsung_usbphy *sphy;\r\nunsigned long flags;\r\nsphy = phy_to_sphy(phy);\r\nif (clk_prepare_enable(sphy->clk)) {\r\ndev_err(sphy->dev, "%s: clk_prepare_enable failed\n", __func__);\r\nreturn;\r\n}\r\nspin_lock_irqsave(&sphy->lock, flags);\r\nsamsung_usbphy_set_type(&sphy->phy, USB_PHY_TYPE_DEVICE);\r\nsphy->drv_data->phy_disable(sphy);\r\nif (sphy->drv_data->set_isolation)\r\nsphy->drv_data->set_isolation(sphy, true);\r\nspin_unlock_irqrestore(&sphy->lock, flags);\r\nclk_disable_unprepare(sphy->clk);\r\n}\r\nstatic int samsung_usb3phy_probe(struct platform_device *pdev)\r\n{\r\nstruct samsung_usbphy *sphy;\r\nstruct samsung_usbphy_data *pdata = dev_get_platdata(&pdev->dev);\r\nstruct device *dev = &pdev->dev;\r\nstruct resource *phy_mem;\r\nvoid __iomem *phy_base;\r\nstruct clk *clk;\r\nint ret;\r\nphy_mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nphy_base = devm_ioremap_resource(dev, phy_mem);\r\nif (IS_ERR(phy_base))\r\nreturn PTR_ERR(phy_base);\r\nsphy = devm_kzalloc(dev, sizeof(*sphy), GFP_KERNEL);\r\nif (!sphy)\r\nreturn -ENOMEM;\r\nclk = devm_clk_get(dev, "usbdrd30");\r\nif (IS_ERR(clk)) {\r\ndev_err(dev, "Failed to get device clock\n");\r\nreturn PTR_ERR(clk);\r\n}\r\nsphy->dev = dev;\r\nif (dev->of_node) {\r\nret = samsung_usbphy_parse_dt(sphy);\r\nif (ret < 0)\r\nreturn ret;\r\n} else {\r\nif (!pdata) {\r\ndev_err(dev, "no platform data specified\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nsphy->plat = pdata;\r\nsphy->regs = phy_base;\r\nsphy->clk = clk;\r\nsphy->phy.dev = sphy->dev;\r\nsphy->phy.label = "samsung-usb3phy";\r\nsphy->phy.type = USB_PHY_TYPE_USB3;\r\nsphy->phy.init = samsung_usb3phy_init;\r\nsphy->phy.shutdown = samsung_usb3phy_shutdown;\r\nsphy->drv_data = samsung_usbphy_get_driver_data(pdev);\r\nsphy->ref_clk_freq = samsung_usbphy_get_refclk_freq(sphy);\r\nif (sphy->ref_clk_freq < 0)\r\nreturn -EINVAL;\r\nspin_lock_init(&sphy->lock);\r\nplatform_set_drvdata(pdev, sphy);\r\nreturn usb_add_phy_dev(&sphy->phy);\r\n}\r\nstatic int samsung_usb3phy_remove(struct platform_device *pdev)\r\n{\r\nstruct samsung_usbphy *sphy = platform_get_drvdata(pdev);\r\nusb_remove_phy(&sphy->phy);\r\nif (sphy->pmuregs)\r\niounmap(sphy->pmuregs);\r\nif (sphy->sysreg)\r\niounmap(sphy->sysreg);\r\nreturn 0;\r\n}

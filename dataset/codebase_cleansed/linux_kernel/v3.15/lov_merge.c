int lov_merge_lvb_kms(struct lov_stripe_md *lsm,\r\nstruct ost_lvb *lvb, __u64 *kms_place)\r\n{\r\n__u64 size = 0;\r\n__u64 kms = 0;\r\n__u64 blocks = 0;\r\nobd_time current_mtime = lvb->lvb_mtime;\r\nobd_time current_atime = lvb->lvb_atime;\r\nobd_time current_ctime = lvb->lvb_ctime;\r\nint i;\r\nint rc = 0;\r\nLASSERT(spin_is_locked(&lsm->lsm_lock));\r\nLASSERT(lsm->lsm_lock_owner == current_pid());\r\nCDEBUG(D_INODE, "MDT ID "DOSTID" initial value: s="LPU64" m="LPU64\r\n" a="LPU64" c="LPU64" b="LPU64"\n", POSTID(&lsm->lsm_oi),\r\nlvb->lvb_size, lvb->lvb_mtime, lvb->lvb_atime, lvb->lvb_ctime,\r\nlvb->lvb_blocks);\r\nfor (i = 0; i < lsm->lsm_stripe_count; i++) {\r\nstruct lov_oinfo *loi = lsm->lsm_oinfo[i];\r\nobd_size lov_size, tmpsize;\r\nif (OST_LVB_IS_ERR(loi->loi_lvb.lvb_blocks)) {\r\nrc = OST_LVB_GET_ERR(loi->loi_lvb.lvb_blocks);\r\ncontinue;\r\n}\r\ntmpsize = loi->loi_kms;\r\nlov_size = lov_stripe_size(lsm, tmpsize, i);\r\nif (lov_size > kms)\r\nkms = lov_size;\r\nif (loi->loi_lvb.lvb_size > tmpsize)\r\ntmpsize = loi->loi_lvb.lvb_size;\r\nlov_size = lov_stripe_size(lsm, tmpsize, i);\r\nif (lov_size > size)\r\nsize = lov_size;\r\nblocks += loi->loi_lvb.lvb_blocks;\r\nif (loi->loi_lvb.lvb_mtime > current_mtime)\r\ncurrent_mtime = loi->loi_lvb.lvb_mtime;\r\nif (loi->loi_lvb.lvb_atime > current_atime)\r\ncurrent_atime = loi->loi_lvb.lvb_atime;\r\nif (loi->loi_lvb.lvb_ctime > current_ctime)\r\ncurrent_ctime = loi->loi_lvb.lvb_ctime;\r\nCDEBUG(D_INODE, "MDT ID "DOSTID" on OST[%u]: s="LPU64" m="LPU64\r\n" a="LPU64" c="LPU64" b="LPU64"\n", POSTID(&lsm->lsm_oi),\r\nloi->loi_ost_idx, loi->loi_lvb.lvb_size,\r\nloi->loi_lvb.lvb_mtime, loi->loi_lvb.lvb_atime,\r\nloi->loi_lvb.lvb_ctime, loi->loi_lvb.lvb_blocks);\r\n}\r\n*kms_place = kms;\r\nlvb->lvb_size = size;\r\nlvb->lvb_blocks = blocks;\r\nlvb->lvb_mtime = current_mtime;\r\nlvb->lvb_atime = current_atime;\r\nlvb->lvb_ctime = current_ctime;\r\nreturn rc;\r\n}\r\nint lov_merge_lvb(struct obd_export *exp,\r\nstruct lov_stripe_md *lsm, struct ost_lvb *lvb, int kms_only)\r\n{\r\nint rc;\r\n__u64 kms;\r\nlov_stripe_lock(lsm);\r\nrc = lov_merge_lvb_kms(lsm, lvb, &kms);\r\nlov_stripe_unlock(lsm);\r\nif (kms_only)\r\nlvb->lvb_size = kms;\r\nCDEBUG(D_INODE, "merged for ID "DOSTID" s="LPU64" m="LPU64" a="LPU64\r\n" c="LPU64" b="LPU64"\n", POSTID(&lsm->lsm_oi), lvb->lvb_size,\r\nlvb->lvb_mtime, lvb->lvb_atime, lvb->lvb_ctime, lvb->lvb_blocks);\r\nreturn rc;\r\n}\r\nint lov_adjust_kms(struct obd_export *exp, struct lov_stripe_md *lsm,\r\nobd_off size, int shrink)\r\n{\r\nstruct lov_oinfo *loi;\r\nint stripe = 0;\r\n__u64 kms;\r\nLASSERT(spin_is_locked(&lsm->lsm_lock));\r\nLASSERT(lsm->lsm_lock_owner == current_pid());\r\nif (shrink) {\r\nfor (; stripe < lsm->lsm_stripe_count; stripe++) {\r\nstruct lov_oinfo *loi = lsm->lsm_oinfo[stripe];\r\nkms = lov_size_to_stripe(lsm, size, stripe);\r\nCDEBUG(D_INODE,\r\n"stripe %d KMS %sing "LPU64"->"LPU64"\n",\r\nstripe, kms > loi->loi_kms ? "increase":"shrink",\r\nloi->loi_kms, kms);\r\nloi_kms_set(loi, loi->loi_lvb.lvb_size = kms);\r\n}\r\nreturn 0;\r\n}\r\nif (size > 0)\r\nstripe = lov_stripe_number(lsm, size - 1);\r\nkms = lov_size_to_stripe(lsm, size, stripe);\r\nloi = lsm->lsm_oinfo[stripe];\r\nCDEBUG(D_INODE, "stripe %d KMS %sincreasing "LPU64"->"LPU64"\n",\r\nstripe, kms > loi->loi_kms ? "" : "not ", loi->loi_kms, kms);\r\nif (kms > loi->loi_kms)\r\nloi_kms_set(loi, kms);\r\nreturn 0;\r\n}\r\nvoid lov_merge_attrs(struct obdo *tgt, struct obdo *src, obd_valid valid,\r\nstruct lov_stripe_md *lsm, int stripeno, int *set)\r\n{\r\nvalid &= src->o_valid;\r\nif (*set) {\r\nif (valid & OBD_MD_FLSIZE) {\r\nobd_size lov_size;\r\nlov_size = lov_stripe_size(lsm, src->o_size, stripeno);\r\nif (lov_size > tgt->o_size)\r\ntgt->o_size = lov_size;\r\n}\r\nif (valid & OBD_MD_FLBLOCKS)\r\ntgt->o_blocks += src->o_blocks;\r\nif (valid & OBD_MD_FLBLKSZ)\r\ntgt->o_blksize += src->o_blksize;\r\nif (valid & OBD_MD_FLCTIME && tgt->o_ctime < src->o_ctime)\r\ntgt->o_ctime = src->o_ctime;\r\nif (valid & OBD_MD_FLMTIME && tgt->o_mtime < src->o_mtime)\r\ntgt->o_mtime = src->o_mtime;\r\nif (valid & OBD_MD_FLDATAVERSION)\r\ntgt->o_data_version += src->o_data_version;\r\n} else {\r\nmemcpy(tgt, src, sizeof(*tgt));\r\ntgt->o_oi = lsm->lsm_oi;\r\nif (valid & OBD_MD_FLSIZE)\r\ntgt->o_size = lov_stripe_size(lsm, src->o_size,\r\nstripeno);\r\n}\r\nif (!(valid & OBD_MD_FLDATAVERSION))\r\ntgt->o_valid &= ~OBD_MD_FLDATAVERSION;\r\n*set += 1;\r\n}

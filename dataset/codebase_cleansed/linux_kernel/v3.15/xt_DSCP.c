static unsigned int\r\ndscp_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct xt_DSCP_info *dinfo = par->targinfo;\r\nu_int8_t dscp = ipv4_get_dsfield(ip_hdr(skb)) >> XT_DSCP_SHIFT;\r\nif (dscp != dinfo->dscp) {\r\nif (!skb_make_writable(skb, sizeof(struct iphdr)))\r\nreturn NF_DROP;\r\nipv4_change_dsfield(ip_hdr(skb), (__u8)(~XT_DSCP_MASK),\r\ndinfo->dscp << XT_DSCP_SHIFT);\r\n}\r\nreturn XT_CONTINUE;\r\n}\r\nstatic unsigned int\r\ndscp_tg6(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct xt_DSCP_info *dinfo = par->targinfo;\r\nu_int8_t dscp = ipv6_get_dsfield(ipv6_hdr(skb)) >> XT_DSCP_SHIFT;\r\nif (dscp != dinfo->dscp) {\r\nif (!skb_make_writable(skb, sizeof(struct ipv6hdr)))\r\nreturn NF_DROP;\r\nipv6_change_dsfield(ipv6_hdr(skb), (__u8)(~XT_DSCP_MASK),\r\ndinfo->dscp << XT_DSCP_SHIFT);\r\n}\r\nreturn XT_CONTINUE;\r\n}\r\nstatic int dscp_tg_check(const struct xt_tgchk_param *par)\r\n{\r\nconst struct xt_DSCP_info *info = par->targinfo;\r\nif (info->dscp > XT_DSCP_MAX) {\r\npr_info("dscp %x out of range\n", info->dscp);\r\nreturn -EDOM;\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned int\r\ntos_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct xt_tos_target_info *info = par->targinfo;\r\nstruct iphdr *iph = ip_hdr(skb);\r\nu_int8_t orig, nv;\r\norig = ipv4_get_dsfield(iph);\r\nnv = (orig & ~info->tos_mask) ^ info->tos_value;\r\nif (orig != nv) {\r\nif (!skb_make_writable(skb, sizeof(struct iphdr)))\r\nreturn NF_DROP;\r\niph = ip_hdr(skb);\r\nipv4_change_dsfield(iph, 0, nv);\r\n}\r\nreturn XT_CONTINUE;\r\n}\r\nstatic unsigned int\r\ntos_tg6(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct xt_tos_target_info *info = par->targinfo;\r\nstruct ipv6hdr *iph = ipv6_hdr(skb);\r\nu_int8_t orig, nv;\r\norig = ipv6_get_dsfield(iph);\r\nnv = (orig & ~info->tos_mask) ^ info->tos_value;\r\nif (orig != nv) {\r\nif (!skb_make_writable(skb, sizeof(struct iphdr)))\r\nreturn NF_DROP;\r\niph = ipv6_hdr(skb);\r\nipv6_change_dsfield(iph, 0, nv);\r\n}\r\nreturn XT_CONTINUE;\r\n}\r\nstatic int __init dscp_tg_init(void)\r\n{\r\nreturn xt_register_targets(dscp_tg_reg, ARRAY_SIZE(dscp_tg_reg));\r\n}\r\nstatic void __exit dscp_tg_exit(void)\r\n{\r\nxt_unregister_targets(dscp_tg_reg, ARRAY_SIZE(dscp_tg_reg));\r\n}

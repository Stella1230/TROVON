static int\r\nairport_suspend(struct macio_dev *mdev, pm_message_t state)\r\n{\r\nstruct orinoco_private *priv = dev_get_drvdata(&mdev->ofdev.dev);\r\nstruct net_device *dev = priv->ndev;\r\nstruct airport *card = priv->card;\r\nunsigned long flags;\r\nint err;\r\nprintk(KERN_DEBUG "%s: Airport entering sleep mode\n", dev->name);\r\nerr = orinoco_lock(priv, &flags);\r\nif (err) {\r\nprintk(KERN_ERR "%s: hw_unavailable on PBOOK_SLEEP_NOW\n",\r\ndev->name);\r\nreturn 0;\r\n}\r\norinoco_down(priv);\r\norinoco_unlock(priv, &flags);\r\ndisable_irq(card->irq);\r\npmac_call_feature(PMAC_FTR_AIRPORT_ENABLE,\r\nmacio_get_of_node(mdev), 0, 0);\r\nreturn 0;\r\n}\r\nstatic int\r\nairport_resume(struct macio_dev *mdev)\r\n{\r\nstruct orinoco_private *priv = dev_get_drvdata(&mdev->ofdev.dev);\r\nstruct net_device *dev = priv->ndev;\r\nstruct airport *card = priv->card;\r\nunsigned long flags;\r\nint err;\r\nprintk(KERN_DEBUG "%s: Airport waking up\n", dev->name);\r\npmac_call_feature(PMAC_FTR_AIRPORT_ENABLE,\r\nmacio_get_of_node(mdev), 0, 1);\r\nmsleep(200);\r\nenable_irq(card->irq);\r\npriv->hw.ops->lock_irqsave(&priv->lock, &flags);\r\nerr = orinoco_up(priv);\r\npriv->hw.ops->unlock_irqrestore(&priv->lock, &flags);\r\nreturn err;\r\n}\r\nstatic int\r\nairport_detach(struct macio_dev *mdev)\r\n{\r\nstruct orinoco_private *priv = dev_get_drvdata(&mdev->ofdev.dev);\r\nstruct airport *card = priv->card;\r\nif (card->ndev_registered)\r\norinoco_if_del(priv);\r\ncard->ndev_registered = 0;\r\nif (card->irq_requested)\r\nfree_irq(card->irq, priv);\r\ncard->irq_requested = 0;\r\nif (card->vaddr)\r\niounmap(card->vaddr);\r\ncard->vaddr = NULL;\r\nmacio_release_resource(mdev, 0);\r\npmac_call_feature(PMAC_FTR_AIRPORT_ENABLE,\r\nmacio_get_of_node(mdev), 0, 0);\r\nssleep(1);\r\nmacio_set_drvdata(mdev, NULL);\r\nfree_orinocodev(priv);\r\nreturn 0;\r\n}\r\nstatic int airport_hard_reset(struct orinoco_private *priv)\r\n{\r\n#if 0\r\nstruct airport *card = priv->card;\r\ndisable_irq(card->irq);\r\npmac_call_feature(PMAC_FTR_AIRPORT_ENABLE,\r\nmacio_get_of_node(card->mdev), 0, 0);\r\nssleep(1);\r\npmac_call_feature(PMAC_FTR_AIRPORT_ENABLE,\r\nmacio_get_of_node(card->mdev), 0, 1);\r\nssleep(1);\r\nenable_irq(card->irq);\r\nssleep(1);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int\r\nairport_attach(struct macio_dev *mdev, const struct of_device_id *match)\r\n{\r\nstruct orinoco_private *priv;\r\nstruct airport *card;\r\nunsigned long phys_addr;\r\nstruct hermes *hw;\r\nif (macio_resource_count(mdev) < 1 || macio_irq_count(mdev) < 1) {\r\nprintk(KERN_ERR PFX "Wrong interrupt/addresses in OF tree\n");\r\nreturn -ENODEV;\r\n}\r\npriv = alloc_orinocodev(sizeof(*card), &mdev->ofdev.dev,\r\nairport_hard_reset, NULL);\r\nif (!priv) {\r\nprintk(KERN_ERR PFX "Cannot allocate network device\n");\r\nreturn -ENODEV;\r\n}\r\ncard = priv->card;\r\nhw = &priv->hw;\r\ncard->mdev = mdev;\r\nif (macio_request_resource(mdev, 0, DRIVER_NAME)) {\r\nprintk(KERN_ERR PFX "can't request IO resource !\n");\r\nfree_orinocodev(priv);\r\nreturn -EBUSY;\r\n}\r\nmacio_set_drvdata(mdev, priv);\r\ncard->irq = macio_irq(mdev, 0);\r\nphys_addr = macio_resource_start(mdev, 0);\r\nprintk(KERN_DEBUG PFX "Physical address %lx\n", phys_addr);\r\ncard->vaddr = ioremap(phys_addr, AIRPORT_IO_LEN);\r\nif (!card->vaddr) {\r\nprintk(KERN_ERR PFX "ioremap() failed\n");\r\ngoto failed;\r\n}\r\nhermes_struct_init(hw, card->vaddr, HERMES_16BIT_REGSPACING);\r\npmac_call_feature(PMAC_FTR_AIRPORT_ENABLE,\r\nmacio_get_of_node(mdev), 0, 1);\r\nssleep(1);\r\nhw->ops->init(hw);\r\nif (request_irq(card->irq, orinoco_interrupt, 0, DRIVER_NAME, priv)) {\r\nprintk(KERN_ERR PFX "Couldn't get IRQ %d\n", card->irq);\r\ngoto failed;\r\n}\r\ncard->irq_requested = 1;\r\nif (orinoco_init(priv) != 0) {\r\nprintk(KERN_ERR PFX "orinoco_init() failed\n");\r\ngoto failed;\r\n}\r\nif (orinoco_if_add(priv, phys_addr, card->irq, NULL) != 0) {\r\nprintk(KERN_ERR PFX "orinoco_if_add() failed\n");\r\ngoto failed;\r\n}\r\ncard->ndev_registered = 1;\r\nreturn 0;\r\nfailed:\r\nairport_detach(mdev);\r\nreturn -ENODEV;\r\n}\r\nstatic int __init\r\ninit_airport(void)\r\n{\r\nprintk(KERN_DEBUG "%s\n", version);\r\nreturn macio_register_driver(&airport_driver);\r\n}\r\nstatic void __exit\r\nexit_airport(void)\r\n{\r\nmacio_unregister_driver(&airport_driver);\r\n}

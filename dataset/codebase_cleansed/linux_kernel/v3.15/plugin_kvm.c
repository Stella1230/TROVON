static void init_disassembler(void)\r\n{\r\nud_init(&ud);\r\nud_set_syntax(&ud, UD_SYN_ATT);\r\n}\r\nstatic const char *disassemble(unsigned char *insn, int len, uint64_t rip,\r\nint cr0_pe, int eflags_vm,\r\nint cs_d, int cs_l)\r\n{\r\nint mode;\r\nif (!cr0_pe)\r\nmode = 16;\r\nelse if (eflags_vm)\r\nmode = 16;\r\nelse if (cs_l)\r\nmode = 64;\r\nelse if (cs_d)\r\nmode = 32;\r\nelse\r\nmode = 16;\r\nud_set_pc(&ud, rip);\r\nud_set_mode(&ud, mode);\r\nud_set_input_buffer(&ud, insn, len);\r\nud_disassemble(&ud);\r\nreturn ud_insn_asm(&ud);\r\n}\r\nstatic void init_disassembler(void)\r\n{\r\n}\r\nstatic const char *disassemble(unsigned char *insn, int len, uint64_t rip,\r\nint cr0_pe, int eflags_vm,\r\nint cs_d, int cs_l)\r\n{\r\nstatic char out[15*3+1];\r\nint i;\r\nfor (i = 0; i < len; ++i)\r\nsprintf(out + i * 3, "%02x ", insn[i]);\r\nout[len*3-1] = '\0';\r\nreturn out;\r\n}\r\nstatic const char *find_exit_reason(unsigned isa, int val)\r\n{\r\nstruct str_values *strings = NULL;\r\nint i;\r\nfor (i = 0; isa_exit_reasons[i].strings; ++i)\r\nif (isa_exit_reasons[i].isa == isa) {\r\nstrings = isa_exit_reasons[i].strings;\r\nbreak;\r\n}\r\nif (!strings)\r\nreturn "UNKNOWN-ISA";\r\nfor (i = 0; strings[i].val >= 0; i++)\r\nif (strings[i].val == val)\r\nbreak;\r\nif (strings[i].str)\r\nreturn strings[i].str;\r\nreturn "UNKNOWN";\r\n}\r\nstatic int kvm_exit_handler(struct trace_seq *s, struct pevent_record *record,\r\nstruct event_format *event, void *context)\r\n{\r\nunsigned long long isa;\r\nunsigned long long val;\r\nunsigned long long info1 = 0, info2 = 0;\r\nif (pevent_get_field_val(s, event, "exit_reason", record, &val, 1) < 0)\r\nreturn -1;\r\nif (pevent_get_field_val(s, event, "isa", record, &isa, 0) < 0)\r\nisa = 1;\r\ntrace_seq_printf(s, "reason %s", find_exit_reason(isa, val));\r\npevent_print_num_field(s, " rip 0x%lx", event, "guest_rip", record, 1);\r\nif (pevent_get_field_val(s, event, "info1", record, &info1, 0) >= 0\r\n&& pevent_get_field_val(s, event, "info2", record, &info2, 0) >= 0)\r\ntrace_seq_printf(s, " info %llx %llx", info1, info2);\r\nreturn 0;\r\n}\r\nstatic int kvm_emulate_insn_handler(struct trace_seq *s,\r\nstruct pevent_record *record,\r\nstruct event_format *event, void *context)\r\n{\r\nunsigned long long rip, csbase, len, flags, failed;\r\nint llen;\r\nuint8_t *insn;\r\nconst char *disasm;\r\nif (pevent_get_field_val(s, event, "rip", record, &rip, 1) < 0)\r\nreturn -1;\r\nif (pevent_get_field_val(s, event, "csbase", record, &csbase, 1) < 0)\r\nreturn -1;\r\nif (pevent_get_field_val(s, event, "len", record, &len, 1) < 0)\r\nreturn -1;\r\nif (pevent_get_field_val(s, event, "flags", record, &flags, 1) < 0)\r\nreturn -1;\r\nif (pevent_get_field_val(s, event, "failed", record, &failed, 1) < 0)\r\nreturn -1;\r\ninsn = pevent_get_field_raw(s, event, "insn", record, &llen, 1);\r\nif (!insn)\r\nreturn -1;\r\ndisasm = disassemble(insn, len, rip,\r\nflags & KVM_EMUL_INSN_F_CR0_PE,\r\nflags & KVM_EMUL_INSN_F_EFL_VM,\r\nflags & KVM_EMUL_INSN_F_CS_D,\r\nflags & KVM_EMUL_INSN_F_CS_L);\r\ntrace_seq_printf(s, "%llx:%llx: %s%s", csbase, rip, disasm,\r\nfailed ? " FAIL" : "");\r\nreturn 0;\r\n}\r\nstatic int kvm_mmu_print_role(struct trace_seq *s, struct pevent_record *record,\r\nstruct event_format *event, void *context)\r\n{\r\nunsigned long long val;\r\nstatic const char *access_str[] = {\r\n"---", "--x", "w--", "w-x", "-u-", "-ux", "wu-", "wux"\r\n};\r\nunion kvm_mmu_page_role role;\r\nif (pevent_get_field_val(s, event, "role", record, &val, 1) < 0)\r\nreturn -1;\r\nrole.word = (int)val;\r\nif (pevent_is_file_bigendian(event->pevent) ==\r\npevent_is_host_bigendian(event->pevent)) {\r\ntrace_seq_printf(s, "%u/%u q%u%s %s%s %spge %snxe",\r\nrole.level,\r\nrole.glevels,\r\nrole.quadrant,\r\nrole.direct ? " direct" : "",\r\naccess_str[role.access],\r\nrole.invalid ? " invalid" : "",\r\nrole.cr4_pge ? "" : "!",\r\nrole.nxe ? "" : "!");\r\n} else\r\ntrace_seq_printf(s, "WORD: %08x", role.word);\r\npevent_print_num_field(s, " root %u ", event,\r\n"root_count", record, 1);\r\nif (pevent_get_field_val(s, event, "unsync", record, &val, 1) < 0)\r\nreturn -1;\r\ntrace_seq_printf(s, "%s%c", val ? "unsync" : "sync", 0);\r\nreturn 0;\r\n}\r\nstatic int kvm_mmu_get_page_handler(struct trace_seq *s,\r\nstruct pevent_record *record,\r\nstruct event_format *event, void *context)\r\n{\r\nunsigned long long val;\r\nif (pevent_get_field_val(s, event, "created", record, &val, 1) < 0)\r\nreturn -1;\r\ntrace_seq_printf(s, "%s ", val ? "new" : "existing");\r\nif (pevent_get_field_val(s, event, "gfn", record, &val, 1) < 0)\r\nreturn -1;\r\ntrace_seq_printf(s, "sp gfn %llx ", val);\r\nreturn kvm_mmu_print_role(s, record, event, context);\r\n}\r\nstatic unsigned long long\r\nprocess_is_writable_pte(struct trace_seq *s, unsigned long long *args)\r\n{\r\nunsigned long pte = args[0];\r\nreturn pte & PT_WRITABLE_MASK;\r\n}\r\nint PEVENT_PLUGIN_LOADER(struct pevent *pevent)\r\n{\r\ninit_disassembler();\r\npevent_register_event_handler(pevent, -1, "kvm", "kvm_exit",\r\nkvm_exit_handler, NULL);\r\npevent_register_event_handler(pevent, -1, "kvm", "kvm_emulate_insn",\r\nkvm_emulate_insn_handler, NULL);\r\npevent_register_event_handler(pevent, -1, "kvmmmu", "kvm_mmu_get_page",\r\nkvm_mmu_get_page_handler, NULL);\r\npevent_register_event_handler(pevent, -1, "kvmmmu", "kvm_mmu_sync_page",\r\nkvm_mmu_print_role, NULL);\r\npevent_register_event_handler(pevent, -1,\r\n"kvmmmu", "kvm_mmu_unsync_page",\r\nkvm_mmu_print_role, NULL);\r\npevent_register_event_handler(pevent, -1, "kvmmmu", "kvm_mmu_zap_page",\r\nkvm_mmu_print_role, NULL);\r\npevent_register_event_handler(pevent, -1, "kvmmmu",\r\n"kvm_mmu_prepare_zap_page", kvm_mmu_print_role,\r\nNULL);\r\npevent_register_print_function(pevent,\r\nprocess_is_writable_pte,\r\nPEVENT_FUNC_ARG_INT,\r\n"is_writable_pte",\r\nPEVENT_FUNC_ARG_LONG,\r\nPEVENT_FUNC_ARG_VOID);\r\nreturn 0;\r\n}\r\nvoid PEVENT_PLUGIN_UNLOADER(struct pevent *pevent)\r\n{\r\npevent_unregister_event_handler(pevent, -1, "kvm", "kvm_exit",\r\nkvm_exit_handler, NULL);\r\npevent_unregister_event_handler(pevent, -1, "kvm", "kvm_emulate_insn",\r\nkvm_emulate_insn_handler, NULL);\r\npevent_unregister_event_handler(pevent, -1, "kvmmmu", "kvm_mmu_get_page",\r\nkvm_mmu_get_page_handler, NULL);\r\npevent_unregister_event_handler(pevent, -1, "kvmmmu", "kvm_mmu_sync_page",\r\nkvm_mmu_print_role, NULL);\r\npevent_unregister_event_handler(pevent, -1,\r\n"kvmmmu", "kvm_mmu_unsync_page",\r\nkvm_mmu_print_role, NULL);\r\npevent_unregister_event_handler(pevent, -1, "kvmmmu", "kvm_mmu_zap_page",\r\nkvm_mmu_print_role, NULL);\r\npevent_unregister_event_handler(pevent, -1, "kvmmmu",\r\n"kvm_mmu_prepare_zap_page", kvm_mmu_print_role,\r\nNULL);\r\npevent_unregister_print_function(pevent, process_is_writable_pte,\r\n"is_writable_pte");\r\n}

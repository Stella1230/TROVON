static int parkbd_readlines(void)\r\n{\r\nreturn (parport_read_status(parkbd_dev->port) >> 6) ^ 2;\r\n}\r\nstatic void parkbd_writelines(int data)\r\n{\r\nparport_write_control(parkbd_dev->port, (~data & 3) | 0x10);\r\n}\r\nstatic int parkbd_write(struct serio *port, unsigned char c)\r\n{\r\nunsigned char p;\r\nif (!parkbd_mode) return -1;\r\np = c ^ (c >> 4);\r\np = p ^ (p >> 2);\r\np = p ^ (p >> 1);\r\nparkbd_counter = 0;\r\nparkbd_writing = 1;\r\nparkbd_buffer = c | (((int) (~p & 1)) << 8) | 0x600;\r\nparkbd_writelines(2);\r\nreturn 0;\r\n}\r\nstatic void parkbd_interrupt(void *dev_id)\r\n{\r\nif (parkbd_writing) {\r\nif (parkbd_counter && ((parkbd_counter == 11) || time_after(jiffies, parkbd_last + HZ/100))) {\r\nparkbd_counter = 0;\r\nparkbd_buffer = 0;\r\nparkbd_writing = 0;\r\nparkbd_writelines(3);\r\nreturn;\r\n}\r\nparkbd_writelines(((parkbd_buffer >> parkbd_counter++) & 1) | 2);\r\nif (parkbd_counter == 11) {\r\nparkbd_counter = 0;\r\nparkbd_buffer = 0;\r\nparkbd_writing = 0;\r\nparkbd_writelines(3);\r\n}\r\n} else {\r\nif ((parkbd_counter == parkbd_mode + 10) || time_after(jiffies, parkbd_last + HZ/100)) {\r\nparkbd_counter = 0;\r\nparkbd_buffer = 0;\r\n}\r\nparkbd_buffer |= (parkbd_readlines() >> 1) << parkbd_counter++;\r\nif (parkbd_counter == parkbd_mode + 10)\r\nserio_interrupt(parkbd_port, (parkbd_buffer >> (2 - parkbd_mode)) & 0xff, 0);\r\n}\r\nparkbd_last = jiffies;\r\n}\r\nstatic int parkbd_getport(void)\r\n{\r\nstruct parport *pp;\r\npp = parport_find_number(parkbd_pp_no);\r\nif (pp == NULL) {\r\nprintk(KERN_ERR "parkbd: no such parport\n");\r\nreturn -ENODEV;\r\n}\r\nparkbd_dev = parport_register_device(pp, "parkbd", NULL, NULL, parkbd_interrupt, PARPORT_DEV_EXCL, NULL);\r\nparport_put_port(pp);\r\nif (!parkbd_dev)\r\nreturn -ENODEV;\r\nif (parport_claim(parkbd_dev)) {\r\nparport_unregister_device(parkbd_dev);\r\nreturn -EBUSY;\r\n}\r\nparkbd_start = jiffies;\r\nreturn 0;\r\n}\r\nstatic struct serio * __init parkbd_allocate_serio(void)\r\n{\r\nstruct serio *serio;\r\nserio = kzalloc(sizeof(struct serio), GFP_KERNEL);\r\nif (serio) {\r\nserio->id.type = parkbd_mode;\r\nserio->write = parkbd_write,\r\nstrlcpy(serio->name, "PARKBD AT/XT keyboard adapter", sizeof(serio->name));\r\nsnprintf(serio->phys, sizeof(serio->phys), "%s/serio0", parkbd_dev->port->name);\r\n}\r\nreturn serio;\r\n}\r\nstatic int __init parkbd_init(void)\r\n{\r\nint err;\r\nerr = parkbd_getport();\r\nif (err)\r\nreturn err;\r\nparkbd_port = parkbd_allocate_serio();\r\nif (!parkbd_port) {\r\nparport_release(parkbd_dev);\r\nreturn -ENOMEM;\r\n}\r\nparkbd_writelines(3);\r\nserio_register_port(parkbd_port);\r\nprintk(KERN_INFO "serio: PARKBD %s adapter on %s\n",\r\nparkbd_mode ? "AT" : "XT", parkbd_dev->port->name);\r\nreturn 0;\r\n}\r\nstatic void __exit parkbd_exit(void)\r\n{\r\nparport_release(parkbd_dev);\r\nserio_unregister_port(parkbd_port);\r\nparport_unregister_device(parkbd_dev);\r\n}

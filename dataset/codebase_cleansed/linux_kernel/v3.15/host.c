static irqreturn_t host_irq(struct ci_hdrc *ci)\r\n{\r\nreturn usb_hcd_irq(ci->irq, ci->hcd);\r\n}\r\nstatic int host_start(struct ci_hdrc *ci)\r\n{\r\nstruct usb_hcd *hcd;\r\nstruct ehci_hcd *ehci;\r\nint ret;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nhcd = usb_create_hcd(&ci_ehci_hc_driver, ci->dev, dev_name(ci->dev));\r\nif (!hcd)\r\nreturn -ENOMEM;\r\ndev_set_drvdata(ci->dev, ci);\r\nhcd->rsrc_start = ci->hw_bank.phys;\r\nhcd->rsrc_len = ci->hw_bank.size;\r\nhcd->regs = ci->hw_bank.abs;\r\nhcd->has_tt = 1;\r\nhcd->power_budget = ci->platdata->power_budget;\r\nhcd->phy = ci->transceiver;\r\nehci = hcd_to_ehci(hcd);\r\nehci->caps = ci->hw_bank.cap;\r\nehci->has_hostpc = ci->hw_bank.lpm;\r\nehci->has_tdi_phy_lpm = ci->hw_bank.lpm;\r\nehci->imx28_write_fix = ci->imx28_write_fix;\r\nif (ci->platdata->reg_vbus) {\r\nret = regulator_enable(ci->platdata->reg_vbus);\r\nif (ret) {\r\ndev_err(ci->dev,\r\n"Failed to enable vbus regulator, ret=%d\n",\r\nret);\r\ngoto put_hcd;\r\n}\r\n}\r\nret = usb_add_hcd(hcd, 0, 0);\r\nif (ret)\r\ngoto disable_reg;\r\nelse\r\nci->hcd = hcd;\r\nif (ci->platdata->flags & CI_HDRC_DISABLE_STREAMING)\r\nhw_write(ci, OP_USBMODE, USBMODE_CI_SDIS, USBMODE_CI_SDIS);\r\nreturn ret;\r\ndisable_reg:\r\nif (ci->platdata->reg_vbus)\r\nregulator_disable(ci->platdata->reg_vbus);\r\nput_hcd:\r\nusb_put_hcd(hcd);\r\nreturn ret;\r\n}\r\nstatic void host_stop(struct ci_hdrc *ci)\r\n{\r\nstruct usb_hcd *hcd = ci->hcd;\r\nif (hcd) {\r\nusb_remove_hcd(hcd);\r\nusb_put_hcd(hcd);\r\nif (ci->platdata->reg_vbus)\r\nregulator_disable(ci->platdata->reg_vbus);\r\n}\r\n}\r\nvoid ci_hdrc_host_destroy(struct ci_hdrc *ci)\r\n{\r\nif (ci->role == CI_ROLE_HOST && ci->hcd)\r\nhost_stop(ci);\r\n}\r\nint ci_hdrc_host_init(struct ci_hdrc *ci)\r\n{\r\nstruct ci_role_driver *rdrv;\r\nif (!hw_read(ci, CAP_DCCPARAMS, DCCPARAMS_HC))\r\nreturn -ENXIO;\r\nrdrv = devm_kzalloc(ci->dev, sizeof(struct ci_role_driver), GFP_KERNEL);\r\nif (!rdrv)\r\nreturn -ENOMEM;\r\nrdrv->start = host_start;\r\nrdrv->stop = host_stop;\r\nrdrv->irq = host_irq;\r\nrdrv->name = "host";\r\nci->roles[CI_ROLE_HOST] = rdrv;\r\nehci_init_driver(&ci_ehci_hc_driver, NULL);\r\nreturn 0;\r\n}

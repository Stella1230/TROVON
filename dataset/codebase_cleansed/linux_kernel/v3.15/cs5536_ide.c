void pci_ide_write_reg(int reg, u32 value)\r\n{\r\nu32 hi = 0, lo = value;\r\nswitch (reg) {\r\ncase PCI_COMMAND:\r\n_rdmsr(GLIU_MSR_REG(GLIU_PAE), &hi, &lo);\r\nif (value & PCI_COMMAND_MASTER)\r\nlo |= (0x03 << 4);\r\nelse\r\nlo &= ~(0x03 << 4);\r\n_wrmsr(GLIU_MSR_REG(GLIU_PAE), hi, lo);\r\nbreak;\r\ncase PCI_STATUS:\r\nif (value & PCI_STATUS_PARITY) {\r\n_rdmsr(SB_MSR_REG(SB_ERROR), &hi, &lo);\r\nif (lo & SB_PARE_ERR_FLAG) {\r\nlo = (lo & 0x0000ffff) | SB_PARE_ERR_FLAG;\r\n_wrmsr(SB_MSR_REG(SB_ERROR), hi, lo);\r\n}\r\n}\r\nbreak;\r\ncase PCI_CACHE_LINE_SIZE:\r\nvalue &= 0x0000ff00;\r\n_rdmsr(SB_MSR_REG(SB_CTRL), &hi, &lo);\r\nhi &= 0xffffff00;\r\nhi |= (value >> 8);\r\n_wrmsr(SB_MSR_REG(SB_CTRL), hi, lo);\r\nbreak;\r\ncase PCI_BAR4_REG:\r\nif (value == PCI_BAR_RANGE_MASK) {\r\n_rdmsr(GLCP_MSR_REG(GLCP_SOFT_COM), &hi, &lo);\r\nlo |= SOFT_BAR_IDE_FLAG;\r\n_wrmsr(GLCP_MSR_REG(GLCP_SOFT_COM), hi, lo);\r\n} else if (value & 0x01) {\r\n_rdmsr(IDE_MSR_REG(IDE_IO_BAR), &hi, &lo);\r\nlo = (value & 0xfffffff0) | 0x1;\r\n_wrmsr(IDE_MSR_REG(IDE_IO_BAR), hi, lo);\r\nvalue &= 0xfffffffc;\r\nhi = 0x60000000 | ((value & 0x000ff000) >> 12);\r\nlo = 0x000ffff0 | ((value & 0x00000fff) << 20);\r\n_wrmsr(GLIU_MSR_REG(GLIU_IOD_BM2), hi, lo);\r\n}\r\nbreak;\r\ncase PCI_IDE_CFG_REG:\r\nif (value == CS5536_IDE_FLASH_SIGNATURE) {\r\n_rdmsr(DIVIL_MSR_REG(DIVIL_BALL_OPTS), &hi, &lo);\r\nlo |= 0x01;\r\n_wrmsr(DIVIL_MSR_REG(DIVIL_BALL_OPTS), hi, lo);\r\n} else {\r\n_rdmsr(IDE_MSR_REG(IDE_CFG), &hi, &lo);\r\nlo = value;\r\n_wrmsr(IDE_MSR_REG(IDE_CFG), hi, lo);\r\n}\r\nbreak;\r\ncase PCI_IDE_DTC_REG:\r\n_rdmsr(IDE_MSR_REG(IDE_DTC), &hi, &lo);\r\nlo = value;\r\n_wrmsr(IDE_MSR_REG(IDE_DTC), hi, lo);\r\nbreak;\r\ncase PCI_IDE_CAST_REG:\r\n_rdmsr(IDE_MSR_REG(IDE_CAST), &hi, &lo);\r\nlo = value;\r\n_wrmsr(IDE_MSR_REG(IDE_CAST), hi, lo);\r\nbreak;\r\ncase PCI_IDE_ETC_REG:\r\n_rdmsr(IDE_MSR_REG(IDE_ETC), &hi, &lo);\r\nlo = value;\r\n_wrmsr(IDE_MSR_REG(IDE_ETC), hi, lo);\r\nbreak;\r\ncase PCI_IDE_PM_REG:\r\n_rdmsr(IDE_MSR_REG(IDE_INTERNAL_PM), &hi, &lo);\r\nlo = value;\r\n_wrmsr(IDE_MSR_REG(IDE_INTERNAL_PM), hi, lo);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nu32 pci_ide_read_reg(int reg)\r\n{\r\nu32 conf_data = 0;\r\nu32 hi, lo;\r\nswitch (reg) {\r\ncase PCI_VENDOR_ID:\r\nconf_data =\r\nCFG_PCI_VENDOR_ID(CS5536_IDE_DEVICE_ID, CS5536_VENDOR_ID);\r\nbreak;\r\ncase PCI_COMMAND:\r\n_rdmsr(IDE_MSR_REG(IDE_IO_BAR), &hi, &lo);\r\nif (lo & 0xfffffff0)\r\nconf_data |= PCI_COMMAND_IO;\r\n_rdmsr(GLIU_MSR_REG(GLIU_PAE), &hi, &lo);\r\nif ((lo & 0x30) == 0x30)\r\nconf_data |= PCI_COMMAND_MASTER;\r\nbreak;\r\ncase PCI_STATUS:\r\nconf_data |= PCI_STATUS_66MHZ;\r\nconf_data |= PCI_STATUS_FAST_BACK;\r\n_rdmsr(SB_MSR_REG(SB_ERROR), &hi, &lo);\r\nif (lo & SB_PARE_ERR_FLAG)\r\nconf_data |= PCI_STATUS_PARITY;\r\nconf_data |= PCI_STATUS_DEVSEL_MEDIUM;\r\nbreak;\r\ncase PCI_CLASS_REVISION:\r\n_rdmsr(IDE_MSR_REG(IDE_CAP), &hi, &lo);\r\nconf_data = lo & 0x000000ff;\r\nconf_data |= (CS5536_IDE_CLASS_CODE << 8);\r\nbreak;\r\ncase PCI_CACHE_LINE_SIZE:\r\n_rdmsr(SB_MSR_REG(SB_CTRL), &hi, &lo);\r\nhi &= 0x000000f8;\r\nconf_data = CFG_PCI_CACHE_LINE_SIZE(PCI_NORMAL_HEADER_TYPE, hi);\r\nbreak;\r\ncase PCI_BAR4_REG:\r\n_rdmsr(GLCP_MSR_REG(GLCP_SOFT_COM), &hi, &lo);\r\nif (lo & SOFT_BAR_IDE_FLAG) {\r\nconf_data = CS5536_IDE_RANGE |\r\nPCI_BASE_ADDRESS_SPACE_IO;\r\nlo &= ~SOFT_BAR_IDE_FLAG;\r\n_wrmsr(GLCP_MSR_REG(GLCP_SOFT_COM), hi, lo);\r\n} else {\r\n_rdmsr(IDE_MSR_REG(IDE_IO_BAR), &hi, &lo);\r\nconf_data = lo & 0xfffffff0;\r\nconf_data |= 0x01;\r\nconf_data &= ~0x02;\r\n}\r\nbreak;\r\ncase PCI_CARDBUS_CIS:\r\nconf_data = PCI_CARDBUS_CIS_POINTER;\r\nbreak;\r\ncase PCI_SUBSYSTEM_VENDOR_ID:\r\nconf_data =\r\nCFG_PCI_VENDOR_ID(CS5536_IDE_SUB_ID, CS5536_SUB_VENDOR_ID);\r\nbreak;\r\ncase PCI_ROM_ADDRESS:\r\nconf_data = PCI_EXPANSION_ROM_BAR;\r\nbreak;\r\ncase PCI_CAPABILITY_LIST:\r\nconf_data = PCI_CAPLIST_POINTER;\r\nbreak;\r\ncase PCI_INTERRUPT_LINE:\r\nconf_data =\r\nCFG_PCI_INTERRUPT_LINE(PCI_DEFAULT_PIN, CS5536_IDE_INTR);\r\nbreak;\r\ncase PCI_IDE_CFG_REG:\r\n_rdmsr(IDE_MSR_REG(IDE_CFG), &hi, &lo);\r\nconf_data = lo;\r\nbreak;\r\ncase PCI_IDE_DTC_REG:\r\n_rdmsr(IDE_MSR_REG(IDE_DTC), &hi, &lo);\r\nconf_data = lo;\r\nbreak;\r\ncase PCI_IDE_CAST_REG:\r\n_rdmsr(IDE_MSR_REG(IDE_CAST), &hi, &lo);\r\nconf_data = lo;\r\nbreak;\r\ncase PCI_IDE_ETC_REG:\r\n_rdmsr(IDE_MSR_REG(IDE_ETC), &hi, &lo);\r\nconf_data = lo;\r\nbreak;\r\ncase PCI_IDE_PM_REG:\r\n_rdmsr(IDE_MSR_REG(IDE_INTERNAL_PM), &hi, &lo);\r\nconf_data = lo;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn conf_data;\r\n}

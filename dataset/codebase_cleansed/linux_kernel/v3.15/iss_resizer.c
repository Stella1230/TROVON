static void resizer_print_status(struct iss_resizer_device *resizer)\r\n{\r\nstruct iss_device *iss = to_iss_device(resizer);\r\ndev_dbg(iss->dev, "-------------RESIZER Register dump-------------\n");\r\nRSZ_PRINT_REGISTER(iss, SYSCONFIG);\r\nRSZ_PRINT_REGISTER(iss, IN_FIFO_CTRL);\r\nRSZ_PRINT_REGISTER(iss, FRACDIV);\r\nRSZ_PRINT_REGISTER(iss, SRC_EN);\r\nRSZ_PRINT_REGISTER(iss, SRC_MODE);\r\nRSZ_PRINT_REGISTER(iss, SRC_FMT0);\r\nRSZ_PRINT_REGISTER(iss, SRC_FMT1);\r\nRSZ_PRINT_REGISTER(iss, SRC_VPS);\r\nRSZ_PRINT_REGISTER(iss, SRC_VSZ);\r\nRSZ_PRINT_REGISTER(iss, SRC_HPS);\r\nRSZ_PRINT_REGISTER(iss, SRC_HSZ);\r\nRSZ_PRINT_REGISTER(iss, DMA_RZA);\r\nRSZ_PRINT_REGISTER(iss, DMA_RZB);\r\nRSZ_PRINT_REGISTER(iss, DMA_STA);\r\nRSZ_PRINT_REGISTER(iss, GCK_MMR);\r\nRSZ_PRINT_REGISTER(iss, GCK_SDR);\r\nRSZ_PRINT_REGISTER(iss, IRQ_RZA);\r\nRSZ_PRINT_REGISTER(iss, IRQ_RZB);\r\nRSZ_PRINT_REGISTER(iss, YUV_Y_MIN);\r\nRSZ_PRINT_REGISTER(iss, YUV_Y_MAX);\r\nRSZ_PRINT_REGISTER(iss, YUV_C_MIN);\r\nRSZ_PRINT_REGISTER(iss, YUV_C_MAX);\r\nRSZ_PRINT_REGISTER(iss, SEQ);\r\nRZA_PRINT_REGISTER(iss, EN);\r\nRZA_PRINT_REGISTER(iss, MODE);\r\nRZA_PRINT_REGISTER(iss, 420);\r\nRZA_PRINT_REGISTER(iss, I_VPS);\r\nRZA_PRINT_REGISTER(iss, I_HPS);\r\nRZA_PRINT_REGISTER(iss, O_VSZ);\r\nRZA_PRINT_REGISTER(iss, O_HSZ);\r\nRZA_PRINT_REGISTER(iss, V_PHS_Y);\r\nRZA_PRINT_REGISTER(iss, V_PHS_C);\r\nRZA_PRINT_REGISTER(iss, V_DIF);\r\nRZA_PRINT_REGISTER(iss, V_TYP);\r\nRZA_PRINT_REGISTER(iss, V_LPF);\r\nRZA_PRINT_REGISTER(iss, H_PHS);\r\nRZA_PRINT_REGISTER(iss, H_DIF);\r\nRZA_PRINT_REGISTER(iss, H_TYP);\r\nRZA_PRINT_REGISTER(iss, H_LPF);\r\nRZA_PRINT_REGISTER(iss, DWN_EN);\r\nRZA_PRINT_REGISTER(iss, SDR_Y_BAD_H);\r\nRZA_PRINT_REGISTER(iss, SDR_Y_BAD_L);\r\nRZA_PRINT_REGISTER(iss, SDR_Y_SAD_H);\r\nRZA_PRINT_REGISTER(iss, SDR_Y_SAD_L);\r\nRZA_PRINT_REGISTER(iss, SDR_Y_OFT);\r\nRZA_PRINT_REGISTER(iss, SDR_Y_PTR_S);\r\nRZA_PRINT_REGISTER(iss, SDR_Y_PTR_E);\r\nRZA_PRINT_REGISTER(iss, SDR_C_BAD_H);\r\nRZA_PRINT_REGISTER(iss, SDR_C_BAD_L);\r\nRZA_PRINT_REGISTER(iss, SDR_C_SAD_H);\r\nRZA_PRINT_REGISTER(iss, SDR_C_SAD_L);\r\nRZA_PRINT_REGISTER(iss, SDR_C_OFT);\r\nRZA_PRINT_REGISTER(iss, SDR_C_PTR_S);\r\nRZA_PRINT_REGISTER(iss, SDR_C_PTR_E);\r\ndev_dbg(iss->dev, "-----------------------------------------------\n");\r\n}\r\nstatic void resizer_enable(struct iss_resizer_device *resizer, u8 enable)\r\n{\r\nstruct iss_device *iss = to_iss_device(resizer);\r\niss_reg_update(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_SRC_EN,\r\nRSZ_SRC_EN_SRC_EN, enable ? RSZ_SRC_EN_SRC_EN : 0);\r\niss_reg_update(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_EN, RSZ_EN_EN,\r\nenable ? RSZ_EN_EN : 0);\r\n}\r\nstatic void resizer_set_outaddr(struct iss_resizer_device *resizer, u32 addr)\r\n{\r\nstruct iss_device *iss = to_iss_device(resizer);\r\nstruct v4l2_mbus_framefmt *informat, *outformat;\r\ninformat = &resizer->formats[RESIZER_PAD_SINK];\r\noutformat = &resizer->formats[RESIZER_PAD_SOURCE_MEM];\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_SDR_Y_BAD_H,\r\n(addr >> 16) & 0xffff);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_SDR_Y_BAD_L,\r\naddr & 0xffff);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_SDR_Y_SAD_H,\r\n(addr >> 16) & 0xffff);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_SDR_Y_SAD_L,\r\naddr & 0xffff);\r\nif ((informat->code == V4L2_MBUS_FMT_UYVY8_1X16) &&\r\n(outformat->code == V4L2_MBUS_FMT_YUYV8_1_5X8)) {\r\nu32 c_addr = addr + (resizer->video_out.bpl_value *\r\n(outformat->height - 1));\r\nif ((c_addr ^ addr) & 0x7f) {\r\nc_addr &= ~0x7f;\r\nc_addr += 0x80;\r\nc_addr |= addr & 0x7f;\r\n}\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_SDR_C_BAD_H,\r\n(c_addr >> 16) & 0xffff);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_SDR_C_BAD_L,\r\nc_addr & 0xffff);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_SDR_C_SAD_H,\r\n(c_addr >> 16) & 0xffff);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_SDR_C_SAD_L,\r\nc_addr & 0xffff);\r\n}\r\n}\r\nstatic void resizer_configure(struct iss_resizer_device *resizer)\r\n{\r\nstruct iss_device *iss = to_iss_device(resizer);\r\nstruct v4l2_mbus_framefmt *informat, *outformat;\r\ninformat = &resizer->formats[RESIZER_PAD_SINK];\r\noutformat = &resizer->formats[RESIZER_PAD_SOURCE_MEM];\r\niss_reg_clr(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_SRC_FMT0,\r\nRSZ_SRC_FMT0_BYPASS);\r\niss_reg_update(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_SRC_FMT0,\r\nRSZ_SRC_FMT0_SEL,\r\nresizer->input == RESIZER_INPUT_IPIPEIF ?\r\nRSZ_SRC_FMT0_SEL : 0);\r\niss_reg_clr(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_SRC_MODE,\r\nRSZ_SRC_MODE_WRT);\r\niss_reg_clr(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_SRC_MODE,\r\nRSZ_SRC_MODE_OST);\r\niss_reg_clr(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_MODE,\r\nRZA_MODE_ONE_SHOT);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_SRC_VPS, 0);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_SRC_HPS, 0);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_SRC_VSZ,\r\ninformat->height - 2);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_SRC_HSZ,\r\ninformat->width - 1);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_I_VPS, 0);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_I_HPS, 0);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_O_VSZ,\r\noutformat->height - 2);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_O_HSZ,\r\noutformat->width - 1);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_V_DIF, 0x100);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_H_DIF, 0x100);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_SDR_Y_PTR_S, 0);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_SDR_Y_PTR_E,\r\noutformat->height - 1);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_SDR_Y_OFT,\r\nresizer->video_out.bpl_value);\r\nif ((informat->code == V4L2_MBUS_FMT_UYVY8_1X16) &&\r\n(outformat->code == V4L2_MBUS_FMT_YUYV8_1_5X8)) {\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_420,\r\nRSZ_420_CEN | RSZ_420_YEN);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_SDR_C_PTR_S,\r\n0);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_SDR_C_PTR_E,\r\noutformat->height - 1);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_SDR_C_OFT,\r\nresizer->video_out.bpl_value);\r\n} else {\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_RESIZER, RZA_420, 0);\r\n}\r\n}\r\nstatic void resizer_isr_buffer(struct iss_resizer_device *resizer)\r\n{\r\nstruct iss_buffer *buffer;\r\nresizer_enable(resizer, 0);\r\nbuffer = omap4iss_video_buffer_next(&resizer->video_out);\r\nif (buffer == NULL)\r\nreturn;\r\nresizer_set_outaddr(resizer, buffer->iss_addr);\r\nresizer_enable(resizer, 1);\r\n}\r\nstatic void resizer_int_dma_isr(struct iss_resizer_device *resizer)\r\n{\r\nstruct iss_pipeline *pipe =\r\nto_iss_pipeline(&resizer->subdev.entity);\r\nif (pipe->do_propagation)\r\natomic_inc(&pipe->frame_number);\r\nresizer_isr_buffer(resizer);\r\n}\r\nvoid omap4iss_resizer_isr(struct iss_resizer_device *resizer, u32 events)\r\n{\r\nstruct iss_device *iss = to_iss_device(resizer);\r\nstruct iss_pipeline *pipe =\r\nto_iss_pipeline(&resizer->subdev.entity);\r\nif (events & (ISP5_IRQ_RSZ_FIFO_IN_BLK_ERR |\r\nISP5_IRQ_RSZ_FIFO_OVF)) {\r\ndev_dbg(iss->dev, "RSZ Err: FIFO_IN_BLK:%d, FIFO_OVF:%d\n",\r\nevents & ISP5_IRQ_RSZ_FIFO_IN_BLK_ERR ? 1 : 0,\r\nevents & ISP5_IRQ_RSZ_FIFO_OVF ? 1 : 0);\r\nomap4iss_pipeline_cancel_stream(pipe);\r\n}\r\nif (omap4iss_module_sync_is_stopping(&resizer->wait,\r\n&resizer->stopping))\r\nreturn;\r\nif (events & ISP5_IRQ_RSZ_INT_DMA)\r\nresizer_int_dma_isr(resizer);\r\n}\r\nstatic int resizer_video_queue(struct iss_video *video,\r\nstruct iss_buffer *buffer)\r\n{\r\nstruct iss_resizer_device *resizer = container_of(video,\r\nstruct iss_resizer_device, video_out);\r\nif (!(resizer->output & RESIZER_OUTPUT_MEMORY))\r\nreturn -ENODEV;\r\nresizer_set_outaddr(resizer, buffer->iss_addr);\r\nif (video->dmaqueue_flags & ISS_VIDEO_DMAQUEUE_UNDERRUN) {\r\nresizer_enable(resizer, 1);\r\niss_video_dmaqueue_flags_clr(video);\r\n}\r\nreturn 0;\r\n}\r\nstatic int resizer_set_stream(struct v4l2_subdev *sd, int enable)\r\n{\r\nstruct iss_resizer_device *resizer = v4l2_get_subdevdata(sd);\r\nstruct iss_device *iss = to_iss_device(resizer);\r\nstruct iss_video *video_out = &resizer->video_out;\r\nint ret = 0;\r\nif (resizer->state == ISS_PIPELINE_STREAM_STOPPED) {\r\nif (enable == ISS_PIPELINE_STREAM_STOPPED)\r\nreturn 0;\r\nomap4iss_isp_subclk_enable(iss, OMAP4_ISS_ISP_SUBCLK_RSZ);\r\niss_reg_set(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_GCK_MMR,\r\nRSZ_GCK_MMR_MMR);\r\niss_reg_set(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_GCK_SDR,\r\nRSZ_GCK_SDR_CORE);\r\niss_reg_set(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_SYSCONFIG,\r\nRSZ_SYSCONFIG_RSZA_CLK_EN);\r\n}\r\nswitch (enable) {\r\ncase ISS_PIPELINE_STREAM_CONTINUOUS:\r\nresizer_configure(resizer);\r\nresizer_print_status(resizer);\r\nif (resizer->output & RESIZER_OUTPUT_MEMORY &&\r\n!(video_out->dmaqueue_flags & ISS_VIDEO_DMAQUEUE_QUEUED))\r\nbreak;\r\natomic_set(&resizer->stopping, 0);\r\nresizer_enable(resizer, 1);\r\niss_video_dmaqueue_flags_clr(video_out);\r\nbreak;\r\ncase ISS_PIPELINE_STREAM_STOPPED:\r\nif (resizer->state == ISS_PIPELINE_STREAM_STOPPED)\r\nreturn 0;\r\nif (omap4iss_module_sync_idle(&sd->entity, &resizer->wait,\r\n&resizer->stopping))\r\nret = -ETIMEDOUT;\r\nresizer_enable(resizer, 0);\r\niss_reg_clr(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_SYSCONFIG,\r\nRSZ_SYSCONFIG_RSZA_CLK_EN);\r\niss_reg_clr(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_GCK_SDR,\r\nRSZ_GCK_SDR_CORE);\r\niss_reg_clr(iss, OMAP4_ISS_MEM_ISP_RESIZER, RSZ_GCK_MMR,\r\nRSZ_GCK_MMR_MMR);\r\nomap4iss_isp_subclk_disable(iss, OMAP4_ISS_ISP_SUBCLK_RSZ);\r\niss_video_dmaqueue_flags_clr(video_out);\r\nbreak;\r\n}\r\nresizer->state = enable;\r\nreturn ret;\r\n}\r\nstatic struct v4l2_mbus_framefmt *\r\n__resizer_get_format(struct iss_resizer_device *resizer,\r\nstruct v4l2_subdev_fh *fh, unsigned int pad,\r\nenum v4l2_subdev_format_whence which)\r\n{\r\nif (which == V4L2_SUBDEV_FORMAT_TRY)\r\nreturn v4l2_subdev_get_try_format(fh, pad);\r\nelse\r\nreturn &resizer->formats[pad];\r\n}\r\nstatic void\r\nresizer_try_format(struct iss_resizer_device *resizer,\r\nstruct v4l2_subdev_fh *fh, unsigned int pad,\r\nstruct v4l2_mbus_framefmt *fmt,\r\nenum v4l2_subdev_format_whence which)\r\n{\r\nenum v4l2_mbus_pixelcode pixelcode;\r\nstruct v4l2_mbus_framefmt *format;\r\nunsigned int width = fmt->width;\r\nunsigned int height = fmt->height;\r\nunsigned int i;\r\nswitch (pad) {\r\ncase RESIZER_PAD_SINK:\r\nfor (i = 0; i < ARRAY_SIZE(resizer_fmts); i++) {\r\nif (fmt->code == resizer_fmts[i])\r\nbreak;\r\n}\r\nif (i >= ARRAY_SIZE(resizer_fmts))\r\nfmt->code = V4L2_MBUS_FMT_UYVY8_1X16;\r\nfmt->width = clamp_t(u32, width, 1, 8192);\r\nfmt->height = clamp_t(u32, height, 1, 8192);\r\nbreak;\r\ncase RESIZER_PAD_SOURCE_MEM:\r\npixelcode = fmt->code;\r\nformat = __resizer_get_format(resizer, fh, RESIZER_PAD_SINK,\r\nwhich);\r\nmemcpy(fmt, format, sizeof(*fmt));\r\nif ((pixelcode == V4L2_MBUS_FMT_YUYV8_1_5X8) &&\r\n(fmt->code == V4L2_MBUS_FMT_UYVY8_1X16))\r\nfmt->code = pixelcode;\r\nfmt->width = clamp_t(u32, width, 32, (fmt->width + 15) & ~15);\r\nfmt->width &= ~15;\r\nfmt->height = clamp_t(u32, height, 32, fmt->height);\r\nbreak;\r\n}\r\nfmt->colorspace = V4L2_COLORSPACE_JPEG;\r\nfmt->field = V4L2_FIELD_NONE;\r\n}\r\nstatic int resizer_enum_mbus_code(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_mbus_code_enum *code)\r\n{\r\nstruct iss_resizer_device *resizer = v4l2_get_subdevdata(sd);\r\nstruct v4l2_mbus_framefmt *format;\r\nswitch (code->pad) {\r\ncase RESIZER_PAD_SINK:\r\nif (code->index >= ARRAY_SIZE(resizer_fmts))\r\nreturn -EINVAL;\r\ncode->code = resizer_fmts[code->index];\r\nbreak;\r\ncase RESIZER_PAD_SOURCE_MEM:\r\nformat = __resizer_get_format(resizer, fh, RESIZER_PAD_SINK,\r\nV4L2_SUBDEV_FORMAT_TRY);\r\nif (code->index == 0) {\r\ncode->code = format->code;\r\nbreak;\r\n}\r\nswitch (format->code) {\r\ncase V4L2_MBUS_FMT_UYVY8_1X16:\r\nif (code->index == 1)\r\ncode->code = V4L2_MBUS_FMT_YUYV8_1_5X8;\r\nelse\r\nreturn -EINVAL;\r\nbreak;\r\ndefault:\r\nif (code->index != 0)\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int resizer_enum_frame_size(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_frame_size_enum *fse)\r\n{\r\nstruct iss_resizer_device *resizer = v4l2_get_subdevdata(sd);\r\nstruct v4l2_mbus_framefmt format;\r\nif (fse->index != 0)\r\nreturn -EINVAL;\r\nformat.code = fse->code;\r\nformat.width = 1;\r\nformat.height = 1;\r\nresizer_try_format(resizer, fh, fse->pad, &format,\r\nV4L2_SUBDEV_FORMAT_TRY);\r\nfse->min_width = format.width;\r\nfse->min_height = format.height;\r\nif (format.code != fse->code)\r\nreturn -EINVAL;\r\nformat.code = fse->code;\r\nformat.width = -1;\r\nformat.height = -1;\r\nresizer_try_format(resizer, fh, fse->pad, &format,\r\nV4L2_SUBDEV_FORMAT_TRY);\r\nfse->max_width = format.width;\r\nfse->max_height = format.height;\r\nreturn 0;\r\n}\r\nstatic int resizer_get_format(struct v4l2_subdev *sd, struct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct iss_resizer_device *resizer = v4l2_get_subdevdata(sd);\r\nstruct v4l2_mbus_framefmt *format;\r\nformat = __resizer_get_format(resizer, fh, fmt->pad, fmt->which);\r\nif (format == NULL)\r\nreturn -EINVAL;\r\nfmt->format = *format;\r\nreturn 0;\r\n}\r\nstatic int resizer_set_format(struct v4l2_subdev *sd, struct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct iss_resizer_device *resizer = v4l2_get_subdevdata(sd);\r\nstruct v4l2_mbus_framefmt *format;\r\nformat = __resizer_get_format(resizer, fh, fmt->pad, fmt->which);\r\nif (format == NULL)\r\nreturn -EINVAL;\r\nresizer_try_format(resizer, fh, fmt->pad, &fmt->format, fmt->which);\r\n*format = fmt->format;\r\nif (fmt->pad == RESIZER_PAD_SINK) {\r\nformat = __resizer_get_format(resizer, fh,\r\nRESIZER_PAD_SOURCE_MEM,\r\nfmt->which);\r\n*format = fmt->format;\r\nresizer_try_format(resizer, fh, RESIZER_PAD_SOURCE_MEM, format,\r\nfmt->which);\r\n}\r\nreturn 0;\r\n}\r\nstatic int resizer_link_validate(struct v4l2_subdev *sd,\r\nstruct media_link *link,\r\nstruct v4l2_subdev_format *source_fmt,\r\nstruct v4l2_subdev_format *sink_fmt)\r\n{\r\nif (source_fmt->format.width != sink_fmt->format.width ||\r\nsource_fmt->format.height != sink_fmt->format.height)\r\nreturn -EPIPE;\r\nif (source_fmt->format.code != sink_fmt->format.code)\r\nreturn -EPIPE;\r\nreturn 0;\r\n}\r\nstatic int resizer_init_formats(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_fh *fh)\r\n{\r\nstruct v4l2_subdev_format format;\r\nmemset(&format, 0, sizeof(format));\r\nformat.pad = RESIZER_PAD_SINK;\r\nformat.which = fh ? V4L2_SUBDEV_FORMAT_TRY : V4L2_SUBDEV_FORMAT_ACTIVE;\r\nformat.format.code = V4L2_MBUS_FMT_UYVY8_1X16;\r\nformat.format.width = 4096;\r\nformat.format.height = 4096;\r\nresizer_set_format(sd, fh, &format);\r\nreturn 0;\r\n}\r\nstatic int resizer_link_setup(struct media_entity *entity,\r\nconst struct media_pad *local,\r\nconst struct media_pad *remote, u32 flags)\r\n{\r\nstruct v4l2_subdev *sd = media_entity_to_v4l2_subdev(entity);\r\nstruct iss_resizer_device *resizer = v4l2_get_subdevdata(sd);\r\nstruct iss_device *iss = to_iss_device(resizer);\r\nswitch (local->index | media_entity_type(remote->entity)) {\r\ncase RESIZER_PAD_SINK | MEDIA_ENT_T_V4L2_SUBDEV:\r\nif (!(flags & MEDIA_LNK_FL_ENABLED)) {\r\nresizer->input = RESIZER_INPUT_NONE;\r\nbreak;\r\n}\r\nif (resizer->input != RESIZER_INPUT_NONE)\r\nreturn -EBUSY;\r\nif (remote->entity == &iss->ipipeif.subdev.entity)\r\nresizer->input = RESIZER_INPUT_IPIPEIF;\r\nelse if (remote->entity == &iss->ipipe.subdev.entity)\r\nresizer->input = RESIZER_INPUT_IPIPE;\r\nbreak;\r\ncase RESIZER_PAD_SOURCE_MEM | MEDIA_ENT_T_DEVNODE:\r\nif (flags & MEDIA_LNK_FL_ENABLED) {\r\nif (resizer->output & ~RESIZER_OUTPUT_MEMORY)\r\nreturn -EBUSY;\r\nresizer->output |= RESIZER_OUTPUT_MEMORY;\r\n} else {\r\nresizer->output &= ~RESIZER_OUTPUT_MEMORY;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int resizer_init_entities(struct iss_resizer_device *resizer)\r\n{\r\nstruct v4l2_subdev *sd = &resizer->subdev;\r\nstruct media_pad *pads = resizer->pads;\r\nstruct media_entity *me = &sd->entity;\r\nint ret;\r\nresizer->input = RESIZER_INPUT_NONE;\r\nv4l2_subdev_init(sd, &resizer_v4l2_ops);\r\nsd->internal_ops = &resizer_v4l2_internal_ops;\r\nstrlcpy(sd->name, "OMAP4 ISS ISP resizer", sizeof(sd->name));\r\nsd->grp_id = 1 << 16;\r\nv4l2_set_subdevdata(sd, resizer);\r\nsd->flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;\r\npads[RESIZER_PAD_SINK].flags = MEDIA_PAD_FL_SINK;\r\npads[RESIZER_PAD_SOURCE_MEM].flags = MEDIA_PAD_FL_SOURCE;\r\nme->ops = &resizer_media_ops;\r\nret = media_entity_init(me, RESIZER_PADS_NUM, pads, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nresizer_init_formats(sd, NULL);\r\nresizer->video_out.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\r\nresizer->video_out.ops = &resizer_video_ops;\r\nresizer->video_out.iss = to_iss_device(resizer);\r\nresizer->video_out.capture_mem = PAGE_ALIGN(4096 * 4096) * 3;\r\nresizer->video_out.bpl_alignment = 32;\r\nresizer->video_out.bpl_zero_padding = 1;\r\nresizer->video_out.bpl_max = 0x1ffe0;\r\nret = omap4iss_video_init(&resizer->video_out, "ISP resizer a");\r\nif (ret < 0)\r\nreturn ret;\r\nret = media_entity_create_link(&resizer->subdev.entity,\r\nRESIZER_PAD_SOURCE_MEM,\r\n&resizer->video_out.video.entity, 0, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nvoid omap4iss_resizer_unregister_entities(struct iss_resizer_device *resizer)\r\n{\r\nmedia_entity_cleanup(&resizer->subdev.entity);\r\nv4l2_device_unregister_subdev(&resizer->subdev);\r\nomap4iss_video_unregister(&resizer->video_out);\r\n}\r\nint omap4iss_resizer_register_entities(struct iss_resizer_device *resizer,\r\nstruct v4l2_device *vdev)\r\n{\r\nint ret;\r\nret = v4l2_device_register_subdev(vdev, &resizer->subdev);\r\nif (ret < 0)\r\ngoto error;\r\nret = omap4iss_video_register(&resizer->video_out, vdev);\r\nif (ret < 0)\r\ngoto error;\r\nreturn 0;\r\nerror:\r\nomap4iss_resizer_unregister_entities(resizer);\r\nreturn ret;\r\n}\r\nint omap4iss_resizer_init(struct iss_device *iss)\r\n{\r\nstruct iss_resizer_device *resizer = &iss->resizer;\r\nresizer->state = ISS_PIPELINE_STREAM_STOPPED;\r\ninit_waitqueue_head(&resizer->wait);\r\nreturn resizer_init_entities(resizer);\r\n}\r\nvoid omap4iss_resizer_cleanup(struct iss_device *iss)\r\n{\r\n}

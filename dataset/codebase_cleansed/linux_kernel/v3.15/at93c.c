static void at93c_reg_write(u32 val)\r\n{\r\n*at93c->reg = val;\r\n}\r\nstatic u32 at93c_reg_read(void)\r\n{\r\nu32 tmp = *at93c->reg;\r\nreturn tmp;\r\n}\r\nstatic u32 at93c_datareg_read(void)\r\n{\r\nu32 tmp = *at93c->rdata_reg;\r\nreturn tmp;\r\n}\r\nstatic void at93c_cycle_clk(u32 data)\r\n{\r\nat93c_reg_write(data | at93c->clk);\r\nlasat_ndelay(250);\r\nat93c_reg_write(data & ~at93c->clk);\r\nlasat_ndelay(250);\r\n}\r\nstatic void at93c_write_databit(u8 bit)\r\n{\r\nu32 data = at93c_reg_read();\r\nif (bit)\r\ndata |= 1 << at93c->wdata_shift;\r\nelse\r\ndata &= ~(1 << at93c->wdata_shift);\r\nat93c_reg_write(data);\r\nlasat_ndelay(100);\r\nat93c_cycle_clk(data);\r\n}\r\nstatic unsigned int at93c_read_databit(void)\r\n{\r\nu32 data;\r\nat93c_cycle_clk(at93c_reg_read());\r\ndata = (at93c_datareg_read() >> at93c->rdata_shift) & 1;\r\nreturn data;\r\n}\r\nstatic u8 at93c_read_byte(void)\r\n{\r\nint i;\r\nu8 data = 0;\r\nfor (i = 0; i <= 7; i++) {\r\ndata <<= 1;\r\ndata |= at93c_read_databit();\r\n}\r\nreturn data;\r\n}\r\nstatic void at93c_write_bits(u32 data, int size)\r\n{\r\nint i;\r\nint shift = size - 1;\r\nu32 mask = (1 << shift);\r\nfor (i = 0; i < size; i++) {\r\nat93c_write_databit((data & mask) >> shift);\r\ndata <<= 1;\r\n}\r\n}\r\nstatic void at93c_init_op(void)\r\n{\r\nat93c_reg_write((at93c_reg_read() | at93c->cs) &\r\n~at93c->clk & ~(1 << at93c->rdata_shift));\r\nlasat_ndelay(50);\r\n}\r\nstatic void at93c_end_op(void)\r\n{\r\nat93c_reg_write(at93c_reg_read() & ~at93c->cs);\r\nlasat_ndelay(250);\r\n}\r\nstatic void at93c_wait(void)\r\n{\r\nat93c_init_op();\r\nwhile (!at93c_read_databit())\r\n;\r\nat93c_end_op();\r\n}\r\nstatic void at93c_disable_wp(void)\r\n{\r\nat93c_init_op();\r\nat93c_write_bits(AT93C_WENCMD, 10);\r\nat93c_end_op();\r\n}\r\nstatic void at93c_enable_wp(void)\r\n{\r\nat93c_init_op();\r\nat93c_write_bits(AT93C_WDSCMD, 10);\r\nat93c_end_op();\r\n}\r\nu8 at93c_read(u8 addr)\r\n{\r\nu8 byte;\r\nat93c_init_op();\r\nat93c_write_bits((addr & AT93C_ADDR_MAX)|AT93C_RCMD, 10);\r\nbyte = at93c_read_byte();\r\nat93c_end_op();\r\nreturn byte;\r\n}\r\nvoid at93c_write(u8 addr, u8 data)\r\n{\r\nat93c_disable_wp();\r\nat93c_init_op();\r\nat93c_write_bits((addr & AT93C_ADDR_MAX)|AT93C_WCMD, 10);\r\nat93c_write_bits(data, 8);\r\nat93c_end_op();\r\nat93c_wait();\r\nat93c_enable_wp();\r\n}

static int target_fabric_mappedlun_link(\r\nstruct config_item *lun_acl_ci,\r\nstruct config_item *lun_ci)\r\n{\r\nstruct se_dev_entry *deve;\r\nstruct se_lun *lun = container_of(to_config_group(lun_ci),\r\nstruct se_lun, lun_group);\r\nstruct se_lun_acl *lacl = container_of(to_config_group(lun_acl_ci),\r\nstruct se_lun_acl, se_lun_group);\r\nstruct se_portal_group *se_tpg;\r\nstruct config_item *nacl_ci, *tpg_ci, *tpg_ci_s, *wwn_ci, *wwn_ci_s;\r\nint ret = 0, lun_access;\r\nif (lun->lun_link_magic != SE_LUN_LINK_MAGIC) {\r\npr_err("Bad lun->lun_link_magic, not a valid lun_ci pointer:"\r\n" %p to struct lun: %p\n", lun_ci, lun);\r\nreturn -EFAULT;\r\n}\r\nif (!lun->lun_sep || !lun->lun_sep->sep_tpg) {\r\npr_err("Source se_lun->lun_sep or lun->lun_sep->sep"\r\n"_tpg does not exist\n");\r\nreturn -EINVAL;\r\n}\r\nse_tpg = lun->lun_sep->sep_tpg;\r\nnacl_ci = &lun_acl_ci->ci_parent->ci_group->cg_item;\r\ntpg_ci = &nacl_ci->ci_group->cg_item;\r\nwwn_ci = &tpg_ci->ci_group->cg_item;\r\ntpg_ci_s = &lun_ci->ci_parent->ci_group->cg_item;\r\nwwn_ci_s = &tpg_ci_s->ci_group->cg_item;\r\nif (strcmp(config_item_name(wwn_ci), config_item_name(wwn_ci_s))) {\r\npr_err("Illegal Initiator ACL SymLink outside of %s\n",\r\nconfig_item_name(wwn_ci));\r\nreturn -EINVAL;\r\n}\r\nif (strcmp(config_item_name(tpg_ci), config_item_name(tpg_ci_s))) {\r\npr_err("Illegal Initiator ACL Symlink outside of %s"\r\n" TPGT: %s\n", config_item_name(wwn_ci),\r\nconfig_item_name(tpg_ci));\r\nreturn -EINVAL;\r\n}\r\nspin_lock_irq(&lacl->se_lun_nacl->device_list_lock);\r\ndeve = lacl->se_lun_nacl->device_list[lacl->mapped_lun];\r\nif (deve->lun_flags & TRANSPORT_LUNFLAGS_INITIATOR_ACCESS)\r\nlun_access = deve->lun_flags;\r\nelse\r\nlun_access =\r\n(se_tpg->se_tpg_tfo->tpg_check_prod_mode_write_protect(\r\nse_tpg)) ? TRANSPORT_LUNFLAGS_READ_ONLY :\r\nTRANSPORT_LUNFLAGS_READ_WRITE;\r\nspin_unlock_irq(&lacl->se_lun_nacl->device_list_lock);\r\nret = core_dev_add_initiator_node_lun_acl(se_tpg, lacl,\r\nlun->unpacked_lun, lun_access);\r\nreturn (ret < 0) ? -EINVAL : 0;\r\n}\r\nstatic int target_fabric_mappedlun_unlink(\r\nstruct config_item *lun_acl_ci,\r\nstruct config_item *lun_ci)\r\n{\r\nstruct se_lun *lun;\r\nstruct se_lun_acl *lacl = container_of(to_config_group(lun_acl_ci),\r\nstruct se_lun_acl, se_lun_group);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve = nacl->device_list[lacl->mapped_lun];\r\nstruct se_portal_group *se_tpg;\r\nif (!deve->se_lun)\r\nreturn 0;\r\nlun = container_of(to_config_group(lun_ci), struct se_lun, lun_group);\r\nse_tpg = lun->lun_sep->sep_tpg;\r\ncore_dev_del_initiator_node_lun_acl(se_tpg, lun, lacl);\r\nreturn 0;\r\n}\r\nstatic ssize_t target_fabric_mappedlun_show_write_protect(\r\nstruct se_lun_acl *lacl,\r\nchar *page)\r\n{\r\nstruct se_node_acl *se_nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nssize_t len;\r\nspin_lock_irq(&se_nacl->device_list_lock);\r\ndeve = se_nacl->device_list[lacl->mapped_lun];\r\nlen = sprintf(page, "%d\n",\r\n(deve->lun_flags & TRANSPORT_LUNFLAGS_READ_ONLY) ?\r\n1 : 0);\r\nspin_unlock_irq(&se_nacl->device_list_lock);\r\nreturn len;\r\n}\r\nstatic ssize_t target_fabric_mappedlun_store_write_protect(\r\nstruct se_lun_acl *lacl,\r\nconst char *page,\r\nsize_t count)\r\n{\r\nstruct se_node_acl *se_nacl = lacl->se_lun_nacl;\r\nstruct se_portal_group *se_tpg = se_nacl->se_tpg;\r\nunsigned long op;\r\nint ret;\r\nret = kstrtoul(page, 0, &op);\r\nif (ret)\r\nreturn ret;\r\nif ((op != 1) && (op != 0))\r\nreturn -EINVAL;\r\ncore_update_device_list_access(lacl->mapped_lun, (op) ?\r\nTRANSPORT_LUNFLAGS_READ_ONLY :\r\nTRANSPORT_LUNFLAGS_READ_WRITE,\r\nlacl->se_lun_nacl);\r\npr_debug("%s_ConfigFS: Changed Initiator ACL: %s"\r\n" Mapped LUN: %u Write Protect bit to %s\n",\r\nse_tpg->se_tpg_tfo->get_fabric_name(),\r\nlacl->initiatorname, lacl->mapped_lun, (op) ? "ON" : "OFF");\r\nreturn count;\r\n}\r\nstatic void target_fabric_mappedlun_release(struct config_item *item)\r\n{\r\nstruct se_lun_acl *lacl = container_of(to_config_group(item),\r\nstruct se_lun_acl, se_lun_group);\r\nstruct se_portal_group *se_tpg = lacl->se_lun_nacl->se_tpg;\r\ncore_dev_free_initiator_node_lun_acl(se_tpg, lacl);\r\n}\r\nstatic struct config_group *target_core_mappedlun_stat_mkdir(\r\nstruct config_group *group,\r\nconst char *name)\r\n{\r\nreturn ERR_PTR(-ENOSYS);\r\n}\r\nstatic void target_core_mappedlun_stat_rmdir(\r\nstruct config_group *group,\r\nstruct config_item *item)\r\n{\r\nreturn;\r\n}\r\nstatic struct config_group *target_fabric_make_mappedlun(\r\nstruct config_group *group,\r\nconst char *name)\r\n{\r\nstruct se_node_acl *se_nacl = container_of(group,\r\nstruct se_node_acl, acl_group);\r\nstruct se_portal_group *se_tpg = se_nacl->se_tpg;\r\nstruct target_fabric_configfs *tf = se_tpg->se_tpg_wwn->wwn_tf;\r\nstruct se_lun_acl *lacl;\r\nstruct config_item *acl_ci;\r\nstruct config_group *lacl_cg = NULL, *ml_stat_grp = NULL;\r\nchar *buf;\r\nunsigned long mapped_lun;\r\nint ret = 0;\r\nacl_ci = &group->cg_item;\r\nif (!acl_ci) {\r\npr_err("Unable to locatel acl_ci\n");\r\nreturn NULL;\r\n}\r\nbuf = kzalloc(strlen(name) + 1, GFP_KERNEL);\r\nif (!buf) {\r\npr_err("Unable to allocate memory for name buf\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nsnprintf(buf, strlen(name) + 1, "%s", name);\r\nif (strstr(buf, "lun_") != buf) {\r\npr_err("Unable to locate \"lun_\" from buf: %s"\r\n" name: %s\n", buf, name);\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nret = kstrtoul(buf + 4, 0, &mapped_lun);\r\nif (ret)\r\ngoto out;\r\nif (mapped_lun > UINT_MAX) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nif (mapped_lun > (TRANSPORT_MAX_LUNS_PER_TPG-1)) {\r\npr_err("Mapped LUN: %lu exceeds TRANSPORT_MAX_LUNS_PER_TPG"\r\n"-1: %u for Target Portal Group: %u\n", mapped_lun,\r\nTRANSPORT_MAX_LUNS_PER_TPG-1,\r\nse_tpg->se_tpg_tfo->tpg_get_tag(se_tpg));\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nlacl = core_dev_init_initiator_node_lun_acl(se_tpg, se_nacl,\r\nmapped_lun, &ret);\r\nif (!lacl) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nlacl_cg = &lacl->se_lun_group;\r\nlacl_cg->default_groups = kmalloc(sizeof(struct config_group *) * 2,\r\nGFP_KERNEL);\r\nif (!lacl_cg->default_groups) {\r\npr_err("Unable to allocate lacl_cg->default_groups\n");\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nconfig_group_init_type_name(&lacl->se_lun_group, name,\r\n&tf->tf_cit_tmpl.tfc_tpg_mappedlun_cit);\r\nconfig_group_init_type_name(&lacl->ml_stat_grps.stat_group,\r\n"statistics", &tf->tf_cit_tmpl.tfc_tpg_mappedlun_stat_cit);\r\nlacl_cg->default_groups[0] = &lacl->ml_stat_grps.stat_group;\r\nlacl_cg->default_groups[1] = NULL;\r\nml_stat_grp = &lacl->ml_stat_grps.stat_group;\r\nml_stat_grp->default_groups = kmalloc(sizeof(struct config_group *) * 3,\r\nGFP_KERNEL);\r\nif (!ml_stat_grp->default_groups) {\r\npr_err("Unable to allocate ml_stat_grp->default_groups\n");\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\ntarget_stat_setup_mappedlun_default_groups(lacl);\r\nkfree(buf);\r\nreturn &lacl->se_lun_group;\r\nout:\r\nif (lacl_cg)\r\nkfree(lacl_cg->default_groups);\r\nkfree(buf);\r\nreturn ERR_PTR(ret);\r\n}\r\nstatic void target_fabric_drop_mappedlun(\r\nstruct config_group *group,\r\nstruct config_item *item)\r\n{\r\nstruct se_lun_acl *lacl = container_of(to_config_group(item),\r\nstruct se_lun_acl, se_lun_group);\r\nstruct config_item *df_item;\r\nstruct config_group *lacl_cg = NULL, *ml_stat_grp = NULL;\r\nint i;\r\nml_stat_grp = &lacl->ml_stat_grps.stat_group;\r\nfor (i = 0; ml_stat_grp->default_groups[i]; i++) {\r\ndf_item = &ml_stat_grp->default_groups[i]->cg_item;\r\nml_stat_grp->default_groups[i] = NULL;\r\nconfig_item_put(df_item);\r\n}\r\nkfree(ml_stat_grp->default_groups);\r\nlacl_cg = &lacl->se_lun_group;\r\nfor (i = 0; lacl_cg->default_groups[i]; i++) {\r\ndf_item = &lacl_cg->default_groups[i]->cg_item;\r\nlacl_cg->default_groups[i] = NULL;\r\nconfig_item_put(df_item);\r\n}\r\nkfree(lacl_cg->default_groups);\r\nconfig_item_put(item);\r\n}\r\nstatic void target_fabric_nacl_base_release(struct config_item *item)\r\n{\r\nstruct se_node_acl *se_nacl = container_of(to_config_group(item),\r\nstruct se_node_acl, acl_group);\r\nstruct se_portal_group *se_tpg = se_nacl->se_tpg;\r\nstruct target_fabric_configfs *tf = se_tpg->se_tpg_wwn->wwn_tf;\r\ntf->tf_ops.fabric_drop_nodeacl(se_nacl);\r\n}\r\nstatic struct config_group *target_fabric_make_nodeacl(\r\nstruct config_group *group,\r\nconst char *name)\r\n{\r\nstruct se_portal_group *se_tpg = container_of(group,\r\nstruct se_portal_group, tpg_acl_group);\r\nstruct target_fabric_configfs *tf = se_tpg->se_tpg_wwn->wwn_tf;\r\nstruct se_node_acl *se_nacl;\r\nstruct config_group *nacl_cg;\r\nif (!tf->tf_ops.fabric_make_nodeacl) {\r\npr_err("tf->tf_ops.fabric_make_nodeacl is NULL\n");\r\nreturn ERR_PTR(-ENOSYS);\r\n}\r\nse_nacl = tf->tf_ops.fabric_make_nodeacl(se_tpg, group, name);\r\nif (IS_ERR(se_nacl))\r\nreturn ERR_CAST(se_nacl);\r\nnacl_cg = &se_nacl->acl_group;\r\nnacl_cg->default_groups = se_nacl->acl_default_groups;\r\nnacl_cg->default_groups[0] = &se_nacl->acl_attrib_group;\r\nnacl_cg->default_groups[1] = &se_nacl->acl_auth_group;\r\nnacl_cg->default_groups[2] = &se_nacl->acl_param_group;\r\nnacl_cg->default_groups[3] = &se_nacl->acl_fabric_stat_group;\r\nnacl_cg->default_groups[4] = NULL;\r\nconfig_group_init_type_name(&se_nacl->acl_group, name,\r\n&tf->tf_cit_tmpl.tfc_tpg_nacl_base_cit);\r\nconfig_group_init_type_name(&se_nacl->acl_attrib_group, "attrib",\r\n&tf->tf_cit_tmpl.tfc_tpg_nacl_attrib_cit);\r\nconfig_group_init_type_name(&se_nacl->acl_auth_group, "auth",\r\n&tf->tf_cit_tmpl.tfc_tpg_nacl_auth_cit);\r\nconfig_group_init_type_name(&se_nacl->acl_param_group, "param",\r\n&tf->tf_cit_tmpl.tfc_tpg_nacl_param_cit);\r\nconfig_group_init_type_name(&se_nacl->acl_fabric_stat_group,\r\n"fabric_statistics",\r\n&tf->tf_cit_tmpl.tfc_tpg_nacl_stat_cit);\r\nreturn &se_nacl->acl_group;\r\n}\r\nstatic void target_fabric_drop_nodeacl(\r\nstruct config_group *group,\r\nstruct config_item *item)\r\n{\r\nstruct se_node_acl *se_nacl = container_of(to_config_group(item),\r\nstruct se_node_acl, acl_group);\r\nstruct config_item *df_item;\r\nstruct config_group *nacl_cg;\r\nint i;\r\nnacl_cg = &se_nacl->acl_group;\r\nfor (i = 0; nacl_cg->default_groups[i]; i++) {\r\ndf_item = &nacl_cg->default_groups[i]->cg_item;\r\nnacl_cg->default_groups[i] = NULL;\r\nconfig_item_put(df_item);\r\n}\r\nconfig_item_put(item);\r\n}\r\nstatic void target_fabric_np_base_release(struct config_item *item)\r\n{\r\nstruct se_tpg_np *se_tpg_np = container_of(to_config_group(item),\r\nstruct se_tpg_np, tpg_np_group);\r\nstruct se_portal_group *se_tpg = se_tpg_np->tpg_np_parent;\r\nstruct target_fabric_configfs *tf = se_tpg->se_tpg_wwn->wwn_tf;\r\ntf->tf_ops.fabric_drop_np(se_tpg_np);\r\n}\r\nstatic struct config_group *target_fabric_make_np(\r\nstruct config_group *group,\r\nconst char *name)\r\n{\r\nstruct se_portal_group *se_tpg = container_of(group,\r\nstruct se_portal_group, tpg_np_group);\r\nstruct target_fabric_configfs *tf = se_tpg->se_tpg_wwn->wwn_tf;\r\nstruct se_tpg_np *se_tpg_np;\r\nif (!tf->tf_ops.fabric_make_np) {\r\npr_err("tf->tf_ops.fabric_make_np is NULL\n");\r\nreturn ERR_PTR(-ENOSYS);\r\n}\r\nse_tpg_np = tf->tf_ops.fabric_make_np(se_tpg, group, name);\r\nif (!se_tpg_np || IS_ERR(se_tpg_np))\r\nreturn ERR_PTR(-EINVAL);\r\nse_tpg_np->tpg_np_parent = se_tpg;\r\nconfig_group_init_type_name(&se_tpg_np->tpg_np_group, name,\r\n&tf->tf_cit_tmpl.tfc_tpg_np_base_cit);\r\nreturn &se_tpg_np->tpg_np_group;\r\n}\r\nstatic void target_fabric_drop_np(\r\nstruct config_group *group,\r\nstruct config_item *item)\r\n{\r\nconfig_item_put(item);\r\n}\r\nstatic ssize_t target_fabric_port_show_attr_alua_tg_pt_gp(\r\nstruct se_lun *lun,\r\nchar *page)\r\n{\r\nif (!lun || !lun->lun_sep)\r\nreturn -ENODEV;\r\nreturn core_alua_show_tg_pt_gp_info(lun->lun_sep, page);\r\n}\r\nstatic ssize_t target_fabric_port_store_attr_alua_tg_pt_gp(\r\nstruct se_lun *lun,\r\nconst char *page,\r\nsize_t count)\r\n{\r\nif (!lun || !lun->lun_sep)\r\nreturn -ENODEV;\r\nreturn core_alua_store_tg_pt_gp_info(lun->lun_sep, page, count);\r\n}\r\nstatic ssize_t target_fabric_port_show_attr_alua_tg_pt_offline(\r\nstruct se_lun *lun,\r\nchar *page)\r\n{\r\nif (!lun || !lun->lun_sep)\r\nreturn -ENODEV;\r\nreturn core_alua_show_offline_bit(lun, page);\r\n}\r\nstatic ssize_t target_fabric_port_store_attr_alua_tg_pt_offline(\r\nstruct se_lun *lun,\r\nconst char *page,\r\nsize_t count)\r\n{\r\nif (!lun || !lun->lun_sep)\r\nreturn -ENODEV;\r\nreturn core_alua_store_offline_bit(lun, page, count);\r\n}\r\nstatic ssize_t target_fabric_port_show_attr_alua_tg_pt_status(\r\nstruct se_lun *lun,\r\nchar *page)\r\n{\r\nif (!lun || !lun->lun_sep)\r\nreturn -ENODEV;\r\nreturn core_alua_show_secondary_status(lun, page);\r\n}\r\nstatic ssize_t target_fabric_port_store_attr_alua_tg_pt_status(\r\nstruct se_lun *lun,\r\nconst char *page,\r\nsize_t count)\r\n{\r\nif (!lun || !lun->lun_sep)\r\nreturn -ENODEV;\r\nreturn core_alua_store_secondary_status(lun, page, count);\r\n}\r\nstatic ssize_t target_fabric_port_show_attr_alua_tg_pt_write_md(\r\nstruct se_lun *lun,\r\nchar *page)\r\n{\r\nif (!lun || !lun->lun_sep)\r\nreturn -ENODEV;\r\nreturn core_alua_show_secondary_write_metadata(lun, page);\r\n}\r\nstatic ssize_t target_fabric_port_store_attr_alua_tg_pt_write_md(\r\nstruct se_lun *lun,\r\nconst char *page,\r\nsize_t count)\r\n{\r\nif (!lun || !lun->lun_sep)\r\nreturn -ENODEV;\r\nreturn core_alua_store_secondary_write_metadata(lun, page, count);\r\n}\r\nstatic int target_fabric_port_link(\r\nstruct config_item *lun_ci,\r\nstruct config_item *se_dev_ci)\r\n{\r\nstruct config_item *tpg_ci;\r\nstruct se_lun *lun = container_of(to_config_group(lun_ci),\r\nstruct se_lun, lun_group);\r\nstruct se_lun *lun_p;\r\nstruct se_portal_group *se_tpg;\r\nstruct se_device *dev =\r\ncontainer_of(to_config_group(se_dev_ci), struct se_device, dev_group);\r\nstruct target_fabric_configfs *tf;\r\nint ret;\r\nif (dev->dev_link_magic != SE_DEV_LINK_MAGIC) {\r\npr_err("Bad dev->dev_link_magic, not a valid se_dev_ci pointer:"\r\n" %p to struct se_device: %p\n", se_dev_ci, dev);\r\nreturn -EFAULT;\r\n}\r\nif (!(dev->dev_flags & DF_CONFIGURED)) {\r\npr_err("se_device not configured yet, cannot port link\n");\r\nreturn -ENODEV;\r\n}\r\ntpg_ci = &lun_ci->ci_parent->ci_group->cg_item;\r\nse_tpg = container_of(to_config_group(tpg_ci),\r\nstruct se_portal_group, tpg_group);\r\ntf = se_tpg->se_tpg_wwn->wwn_tf;\r\nif (lun->lun_se_dev != NULL) {\r\npr_err("Port Symlink already exists\n");\r\nreturn -EEXIST;\r\n}\r\nlun_p = core_dev_add_lun(se_tpg, dev, lun->unpacked_lun);\r\nif (IS_ERR(lun_p)) {\r\npr_err("core_dev_add_lun() failed\n");\r\nret = PTR_ERR(lun_p);\r\ngoto out;\r\n}\r\nif (tf->tf_ops.fabric_post_link) {\r\ntf->tf_ops.fabric_post_link(se_tpg, lun);\r\n}\r\nreturn 0;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int target_fabric_port_unlink(\r\nstruct config_item *lun_ci,\r\nstruct config_item *se_dev_ci)\r\n{\r\nstruct se_lun *lun = container_of(to_config_group(lun_ci),\r\nstruct se_lun, lun_group);\r\nstruct se_portal_group *se_tpg = lun->lun_sep->sep_tpg;\r\nstruct target_fabric_configfs *tf = se_tpg->se_tpg_wwn->wwn_tf;\r\nif (tf->tf_ops.fabric_pre_unlink) {\r\ntf->tf_ops.fabric_pre_unlink(se_tpg, lun);\r\n}\r\ncore_dev_del_lun(se_tpg, lun->unpacked_lun);\r\nreturn 0;\r\n}\r\nstatic struct config_group *target_core_port_stat_mkdir(\r\nstruct config_group *group,\r\nconst char *name)\r\n{\r\nreturn ERR_PTR(-ENOSYS);\r\n}\r\nstatic void target_core_port_stat_rmdir(\r\nstruct config_group *group,\r\nstruct config_item *item)\r\n{\r\nreturn;\r\n}\r\nstatic struct config_group *target_fabric_make_lun(\r\nstruct config_group *group,\r\nconst char *name)\r\n{\r\nstruct se_lun *lun;\r\nstruct se_portal_group *se_tpg = container_of(group,\r\nstruct se_portal_group, tpg_lun_group);\r\nstruct target_fabric_configfs *tf = se_tpg->se_tpg_wwn->wwn_tf;\r\nstruct config_group *lun_cg = NULL, *port_stat_grp = NULL;\r\nunsigned long unpacked_lun;\r\nint errno;\r\nif (strstr(name, "lun_") != name) {\r\npr_err("Unable to locate \'_\" in"\r\n" \"lun_$LUN_NUMBER\"\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nerrno = kstrtoul(name + 4, 0, &unpacked_lun);\r\nif (errno)\r\nreturn ERR_PTR(errno);\r\nif (unpacked_lun > UINT_MAX)\r\nreturn ERR_PTR(-EINVAL);\r\nlun = core_get_lun_from_tpg(se_tpg, unpacked_lun);\r\nif (!lun)\r\nreturn ERR_PTR(-EINVAL);\r\nlun_cg = &lun->lun_group;\r\nlun_cg->default_groups = kmalloc(sizeof(struct config_group *) * 2,\r\nGFP_KERNEL);\r\nif (!lun_cg->default_groups) {\r\npr_err("Unable to allocate lun_cg->default_groups\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nconfig_group_init_type_name(&lun->lun_group, name,\r\n&tf->tf_cit_tmpl.tfc_tpg_port_cit);\r\nconfig_group_init_type_name(&lun->port_stat_grps.stat_group,\r\n"statistics", &tf->tf_cit_tmpl.tfc_tpg_port_stat_cit);\r\nlun_cg->default_groups[0] = &lun->port_stat_grps.stat_group;\r\nlun_cg->default_groups[1] = NULL;\r\nport_stat_grp = &lun->port_stat_grps.stat_group;\r\nport_stat_grp->default_groups = kzalloc(sizeof(struct config_group *) * 4,\r\nGFP_KERNEL);\r\nif (!port_stat_grp->default_groups) {\r\npr_err("Unable to allocate port_stat_grp->default_groups\n");\r\nerrno = -ENOMEM;\r\ngoto out;\r\n}\r\ntarget_stat_setup_port_default_groups(lun);\r\nreturn &lun->lun_group;\r\nout:\r\nif (lun_cg)\r\nkfree(lun_cg->default_groups);\r\nreturn ERR_PTR(errno);\r\n}\r\nstatic void target_fabric_drop_lun(\r\nstruct config_group *group,\r\nstruct config_item *item)\r\n{\r\nstruct se_lun *lun = container_of(to_config_group(item),\r\nstruct se_lun, lun_group);\r\nstruct config_item *df_item;\r\nstruct config_group *lun_cg, *port_stat_grp;\r\nint i;\r\nport_stat_grp = &lun->port_stat_grps.stat_group;\r\nfor (i = 0; port_stat_grp->default_groups[i]; i++) {\r\ndf_item = &port_stat_grp->default_groups[i]->cg_item;\r\nport_stat_grp->default_groups[i] = NULL;\r\nconfig_item_put(df_item);\r\n}\r\nkfree(port_stat_grp->default_groups);\r\nlun_cg = &lun->lun_group;\r\nfor (i = 0; lun_cg->default_groups[i]; i++) {\r\ndf_item = &lun_cg->default_groups[i]->cg_item;\r\nlun_cg->default_groups[i] = NULL;\r\nconfig_item_put(df_item);\r\n}\r\nkfree(lun_cg->default_groups);\r\nconfig_item_put(item);\r\n}\r\nstatic void target_fabric_tpg_release(struct config_item *item)\r\n{\r\nstruct se_portal_group *se_tpg = container_of(to_config_group(item),\r\nstruct se_portal_group, tpg_group);\r\nstruct se_wwn *wwn = se_tpg->se_tpg_wwn;\r\nstruct target_fabric_configfs *tf = wwn->wwn_tf;\r\ntf->tf_ops.fabric_drop_tpg(se_tpg);\r\n}\r\nstatic struct config_group *target_fabric_make_tpg(\r\nstruct config_group *group,\r\nconst char *name)\r\n{\r\nstruct se_wwn *wwn = container_of(group, struct se_wwn, wwn_group);\r\nstruct target_fabric_configfs *tf = wwn->wwn_tf;\r\nstruct se_portal_group *se_tpg;\r\nif (!tf->tf_ops.fabric_make_tpg) {\r\npr_err("tf->tf_ops.fabric_make_tpg is NULL\n");\r\nreturn ERR_PTR(-ENOSYS);\r\n}\r\nse_tpg = tf->tf_ops.fabric_make_tpg(wwn, group, name);\r\nif (!se_tpg || IS_ERR(se_tpg))\r\nreturn ERR_PTR(-EINVAL);\r\nse_tpg->tpg_group.default_groups = se_tpg->tpg_default_groups;\r\nse_tpg->tpg_group.default_groups[0] = &se_tpg->tpg_lun_group;\r\nse_tpg->tpg_group.default_groups[1] = &se_tpg->tpg_np_group;\r\nse_tpg->tpg_group.default_groups[2] = &se_tpg->tpg_acl_group;\r\nse_tpg->tpg_group.default_groups[3] = &se_tpg->tpg_attrib_group;\r\nse_tpg->tpg_group.default_groups[4] = &se_tpg->tpg_auth_group;\r\nse_tpg->tpg_group.default_groups[5] = &se_tpg->tpg_param_group;\r\nse_tpg->tpg_group.default_groups[6] = NULL;\r\nconfig_group_init_type_name(&se_tpg->tpg_group, name,\r\n&tf->tf_cit_tmpl.tfc_tpg_base_cit);\r\nconfig_group_init_type_name(&se_tpg->tpg_lun_group, "lun",\r\n&tf->tf_cit_tmpl.tfc_tpg_lun_cit);\r\nconfig_group_init_type_name(&se_tpg->tpg_np_group, "np",\r\n&tf->tf_cit_tmpl.tfc_tpg_np_cit);\r\nconfig_group_init_type_name(&se_tpg->tpg_acl_group, "acls",\r\n&tf->tf_cit_tmpl.tfc_tpg_nacl_cit);\r\nconfig_group_init_type_name(&se_tpg->tpg_attrib_group, "attrib",\r\n&tf->tf_cit_tmpl.tfc_tpg_attrib_cit);\r\nconfig_group_init_type_name(&se_tpg->tpg_auth_group, "auth",\r\n&tf->tf_cit_tmpl.tfc_tpg_auth_cit);\r\nconfig_group_init_type_name(&se_tpg->tpg_param_group, "param",\r\n&tf->tf_cit_tmpl.tfc_tpg_param_cit);\r\nreturn &se_tpg->tpg_group;\r\n}\r\nstatic void target_fabric_drop_tpg(\r\nstruct config_group *group,\r\nstruct config_item *item)\r\n{\r\nstruct se_portal_group *se_tpg = container_of(to_config_group(item),\r\nstruct se_portal_group, tpg_group);\r\nstruct config_group *tpg_cg = &se_tpg->tpg_group;\r\nstruct config_item *df_item;\r\nint i;\r\nfor (i = 0; tpg_cg->default_groups[i]; i++) {\r\ndf_item = &tpg_cg->default_groups[i]->cg_item;\r\ntpg_cg->default_groups[i] = NULL;\r\nconfig_item_put(df_item);\r\n}\r\nconfig_item_put(item);\r\n}\r\nstatic void target_fabric_release_wwn(struct config_item *item)\r\n{\r\nstruct se_wwn *wwn = container_of(to_config_group(item),\r\nstruct se_wwn, wwn_group);\r\nstruct target_fabric_configfs *tf = wwn->wwn_tf;\r\ntf->tf_ops.fabric_drop_wwn(wwn);\r\n}\r\nstatic struct config_group *target_fabric_make_wwn(\r\nstruct config_group *group,\r\nconst char *name)\r\n{\r\nstruct target_fabric_configfs *tf = container_of(group,\r\nstruct target_fabric_configfs, tf_group);\r\nstruct se_wwn *wwn;\r\nif (!tf->tf_ops.fabric_make_wwn) {\r\npr_err("tf->tf_ops.fabric_make_wwn is NULL\n");\r\nreturn ERR_PTR(-ENOSYS);\r\n}\r\nwwn = tf->tf_ops.fabric_make_wwn(tf, group, name);\r\nif (!wwn || IS_ERR(wwn))\r\nreturn ERR_PTR(-EINVAL);\r\nwwn->wwn_tf = tf;\r\nwwn->wwn_group.default_groups = wwn->wwn_default_groups;\r\nwwn->wwn_group.default_groups[0] = &wwn->fabric_stat_group;\r\nwwn->wwn_group.default_groups[1] = NULL;\r\nconfig_group_init_type_name(&wwn->wwn_group, name,\r\n&tf->tf_cit_tmpl.tfc_tpg_cit);\r\nconfig_group_init_type_name(&wwn->fabric_stat_group, "fabric_statistics",\r\n&tf->tf_cit_tmpl.tfc_wwn_fabric_stats_cit);\r\nreturn &wwn->wwn_group;\r\n}\r\nstatic void target_fabric_drop_wwn(\r\nstruct config_group *group,\r\nstruct config_item *item)\r\n{\r\nstruct se_wwn *wwn = container_of(to_config_group(item),\r\nstruct se_wwn, wwn_group);\r\nstruct config_item *df_item;\r\nstruct config_group *cg = &wwn->wwn_group;\r\nint i;\r\nfor (i = 0; cg->default_groups[i]; i++) {\r\ndf_item = &cg->default_groups[i]->cg_item;\r\ncg->default_groups[i] = NULL;\r\nconfig_item_put(df_item);\r\n}\r\nconfig_item_put(item);\r\n}\r\nint target_fabric_setup_cits(struct target_fabric_configfs *tf)\r\n{\r\ntarget_fabric_setup_discovery_cit(tf);\r\ntarget_fabric_setup_wwn_cit(tf);\r\ntarget_fabric_setup_wwn_fabric_stats_cit(tf);\r\ntarget_fabric_setup_tpg_cit(tf);\r\ntarget_fabric_setup_tpg_base_cit(tf);\r\ntarget_fabric_setup_tpg_port_cit(tf);\r\ntarget_fabric_setup_tpg_port_stat_cit(tf);\r\ntarget_fabric_setup_tpg_lun_cit(tf);\r\ntarget_fabric_setup_tpg_np_cit(tf);\r\ntarget_fabric_setup_tpg_np_base_cit(tf);\r\ntarget_fabric_setup_tpg_attrib_cit(tf);\r\ntarget_fabric_setup_tpg_auth_cit(tf);\r\ntarget_fabric_setup_tpg_param_cit(tf);\r\ntarget_fabric_setup_tpg_nacl_cit(tf);\r\ntarget_fabric_setup_tpg_nacl_base_cit(tf);\r\ntarget_fabric_setup_tpg_nacl_attrib_cit(tf);\r\ntarget_fabric_setup_tpg_nacl_auth_cit(tf);\r\ntarget_fabric_setup_tpg_nacl_param_cit(tf);\r\ntarget_fabric_setup_tpg_nacl_stat_cit(tf);\r\ntarget_fabric_setup_tpg_mappedlun_cit(tf);\r\ntarget_fabric_setup_tpg_mappedlun_stat_cit(tf);\r\nreturn 0;\r\n}

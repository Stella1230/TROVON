static int spi_pci_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct dw_spi_pci *dwpci;\r\nstruct dw_spi *dws;\r\nint pci_bar = 0;\r\nint ret;\r\ndev_info(&pdev->dev, "found PCI SPI controller(ID: %04x:%04x)\n",\r\npdev->vendor, pdev->device);\r\nret = pcim_enable_device(pdev);\r\nif (ret)\r\nreturn ret;\r\ndwpci = devm_kzalloc(&pdev->dev, sizeof(struct dw_spi_pci),\r\nGFP_KERNEL);\r\nif (!dwpci)\r\nreturn -ENOMEM;\r\ndwpci->pdev = pdev;\r\ndws = &dwpci->dws;\r\ndws->paddr = pci_resource_start(pdev, pci_bar);\r\nret = pcim_iomap_regions(pdev, 1, dev_name(&pdev->dev));\r\nif (ret)\r\nreturn ret;\r\ndws->bus_num = 0;\r\ndws->num_cs = 4;\r\ndws->irq = pdev->irq;\r\nif (pdev->device == 0x0800) {\r\nret = dw_spi_mid_init(dws);\r\nif (ret)\r\nreturn ret;\r\n}\r\nret = dw_spi_add_host(&pdev->dev, dws);\r\nif (ret)\r\nreturn ret;\r\npci_set_drvdata(pdev, dwpci);\r\nreturn 0;\r\n}\r\nstatic void spi_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct dw_spi_pci *dwpci = pci_get_drvdata(pdev);\r\ndw_spi_remove_host(&dwpci->dws);\r\n}\r\nstatic int spi_suspend(struct pci_dev *pdev, pm_message_t state)\r\n{\r\nstruct dw_spi_pci *dwpci = pci_get_drvdata(pdev);\r\nint ret;\r\nret = dw_spi_suspend_host(&dwpci->dws);\r\nif (ret)\r\nreturn ret;\r\npci_save_state(pdev);\r\npci_disable_device(pdev);\r\npci_set_power_state(pdev, pci_choose_state(pdev, state));\r\nreturn ret;\r\n}\r\nstatic int spi_resume(struct pci_dev *pdev)\r\n{\r\nstruct dw_spi_pci *dwpci = pci_get_drvdata(pdev);\r\nint ret;\r\npci_set_power_state(pdev, PCI_D0);\r\npci_restore_state(pdev);\r\nret = pci_enable_device(pdev);\r\nif (ret)\r\nreturn ret;\r\nreturn dw_spi_resume_host(&dwpci->dws);\r\n}

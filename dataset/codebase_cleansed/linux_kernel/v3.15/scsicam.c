unsigned char *scsi_bios_ptable(struct block_device *dev)\r\n{\r\nunsigned char *res = kmalloc(66, GFP_KERNEL);\r\nif (res) {\r\nstruct block_device *bdev = dev->bd_contains;\r\nSector sect;\r\nvoid *data = read_dev_sector(bdev, 0, &sect);\r\nif (data) {\r\nmemcpy(res, data + 0x1be, 66);\r\nput_dev_sector(sect);\r\n} else {\r\nkfree(res);\r\nres = NULL;\r\n}\r\n}\r\nreturn res;\r\n}\r\nint scsicam_bios_param(struct block_device *bdev, sector_t capacity, int *ip)\r\n{\r\nunsigned char *p;\r\nu64 capacity64 = capacity;\r\nint ret;\r\np = scsi_bios_ptable(bdev);\r\nif (!p)\r\nreturn -1;\r\nret = scsi_partsize(p, (unsigned long)capacity, (unsigned int *)ip + 2,\r\n(unsigned int *)ip + 0, (unsigned int *)ip + 1);\r\nkfree(p);\r\nif (ret == -1 && capacity64 < (1ULL << 32)) {\r\nret = setsize((unsigned long)capacity, (unsigned int *)ip + 2,\r\n(unsigned int *)ip + 0, (unsigned int *)ip + 1);\r\n}\r\nif (ret || ip[0] > 255 || ip[1] > 63) {\r\nif ((capacity >> 11) > 65534) {\r\nip[0] = 255;\r\nip[1] = 63;\r\n} else {\r\nip[0] = 64;\r\nip[1] = 32;\r\n}\r\nif (capacity > 65535*63*255)\r\nip[2] = 65535;\r\nelse\r\nip[2] = (unsigned long)capacity / (ip[0] * ip[1]);\r\n}\r\nreturn 0;\r\n}\r\nint scsi_partsize(unsigned char *buf, unsigned long capacity,\r\nunsigned int *cyls, unsigned int *hds, unsigned int *secs)\r\n{\r\nstruct partition *p = (struct partition *)buf, *largest = NULL;\r\nint i, largest_cyl;\r\nint cyl, ext_cyl, end_head, end_cyl, end_sector;\r\nunsigned int logical_end, physical_end, ext_physical_end;\r\nif (*(unsigned short *) (buf + 64) == 0xAA55) {\r\nfor (largest_cyl = -1, i = 0; i < 4; ++i, ++p) {\r\nif (!p->sys_ind)\r\ncontinue;\r\n#ifdef DEBUG\r\nprintk("scsicam_bios_param : partition %d has system \n",\r\ni);\r\n#endif\r\ncyl = p->cyl + ((p->sector & 0xc0) << 2);\r\nif (cyl > largest_cyl) {\r\nlargest_cyl = cyl;\r\nlargest = p;\r\n}\r\n}\r\n}\r\nif (largest) {\r\nend_cyl = largest->end_cyl + ((largest->end_sector & 0xc0) << 2);\r\nend_head = largest->end_head;\r\nend_sector = largest->end_sector & 0x3f;\r\nif (end_head + 1 == 0 || end_sector == 0)\r\nreturn -1;\r\n#ifdef DEBUG\r\nprintk("scsicam_bios_param : end at h = %d, c = %d, s = %d\n",\r\nend_head, end_cyl, end_sector);\r\n#endif\r\nphysical_end = end_cyl * (end_head + 1) * end_sector +\r\nend_head * end_sector + end_sector;\r\nlogical_end = get_unaligned(&largest->start_sect)\r\n+ get_unaligned(&largest->nr_sects);\r\next_cyl = (logical_end - (end_head * end_sector + end_sector))\r\n/ (end_head + 1) / end_sector;\r\next_physical_end = ext_cyl * (end_head + 1) * end_sector +\r\nend_head * end_sector + end_sector;\r\n#ifdef DEBUG\r\nprintk("scsicam_bios_param : logical_end=%d physical_end=%d ext_physical_end=%d ext_cyl=%d\n"\r\n,logical_end, physical_end, ext_physical_end, ext_cyl);\r\n#endif\r\nif ((logical_end == physical_end) ||\r\n(end_cyl == 1023 && ext_physical_end == logical_end)) {\r\n*secs = end_sector;\r\n*hds = end_head + 1;\r\n*cyls = capacity / ((end_head + 1) * end_sector);\r\nreturn 0;\r\n}\r\n#ifdef DEBUG\r\nprintk("scsicam_bios_param : logical (%u) != physical (%u)\n",\r\nlogical_end, physical_end);\r\n#endif\r\n}\r\nreturn -1;\r\n}\r\nstatic int setsize(unsigned long capacity, unsigned int *cyls, unsigned int *hds,\r\nunsigned int *secs)\r\n{\r\nunsigned int rv = 0;\r\nunsigned long heads, sectors, cylinders, temp;\r\ncylinders = 1024L;\r\nsectors = 62L;\r\ntemp = cylinders * sectors;\r\nheads = capacity / temp;\r\nif (capacity % temp) {\r\nheads++;\r\ntemp = cylinders * heads;\r\nsectors = capacity / temp;\r\nif (capacity % temp) {\r\nsectors++;\r\ntemp = heads * sectors;\r\ncylinders = capacity / temp;\r\n}\r\n}\r\nif (cylinders == 0)\r\nrv = (unsigned) -1;\r\n*cyls = (unsigned int) cylinders;\r\n*secs = (unsigned int) sectors;\r\n*hds = (unsigned int) heads;\r\nreturn (rv);\r\n}

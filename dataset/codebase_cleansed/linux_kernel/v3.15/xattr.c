ssize_t v9fs_fid_xattr_get(struct p9_fid *fid, const char *name,\r\nvoid *buffer, size_t buffer_size)\r\n{\r\nssize_t retval;\r\nint msize, read_count;\r\nu64 offset = 0, attr_size;\r\nstruct p9_fid *attr_fid;\r\nattr_fid = p9_client_xattrwalk(fid, name, &attr_size);\r\nif (IS_ERR(attr_fid)) {\r\nretval = PTR_ERR(attr_fid);\r\np9_debug(P9_DEBUG_VFS, "p9_client_attrwalk failed %zd\n",\r\nretval);\r\nattr_fid = NULL;\r\ngoto error;\r\n}\r\nif (!buffer_size) {\r\nretval = attr_size;\r\ngoto error;\r\n}\r\nif (attr_size > buffer_size) {\r\nretval = -ERANGE;\r\ngoto error;\r\n}\r\nmsize = attr_fid->clnt->msize;\r\nwhile (attr_size) {\r\nif (attr_size > (msize - P9_IOHDRSZ))\r\nread_count = msize - P9_IOHDRSZ;\r\nelse\r\nread_count = attr_size;\r\nread_count = p9_client_read(attr_fid, ((char *)buffer)+offset,\r\nNULL, offset, read_count);\r\nif (read_count < 0) {\r\nretval = read_count;\r\ngoto error;\r\n}\r\noffset += read_count;\r\nattr_size -= read_count;\r\n}\r\nretval = offset;\r\nerror:\r\nif (attr_fid)\r\np9_client_clunk(attr_fid);\r\nreturn retval;\r\n}\r\nssize_t v9fs_xattr_get(struct dentry *dentry, const char *name,\r\nvoid *buffer, size_t buffer_size)\r\n{\r\nstruct p9_fid *fid;\r\np9_debug(P9_DEBUG_VFS, "name = %s value_len = %zu\n",\r\nname, buffer_size);\r\nfid = v9fs_fid_lookup(dentry);\r\nif (IS_ERR(fid))\r\nreturn PTR_ERR(fid);\r\nreturn v9fs_fid_xattr_get(fid, name, buffer, buffer_size);\r\n}\r\nint v9fs_xattr_set(struct dentry *dentry, const char *name,\r\nconst void *value, size_t value_len, int flags)\r\n{\r\nstruct p9_fid *fid = v9fs_fid_lookup(dentry);\r\nif (IS_ERR(fid))\r\nreturn PTR_ERR(fid);\r\nreturn v9fs_fid_xattr_set(fid, name, value, value_len, flags);\r\n}\r\nint v9fs_fid_xattr_set(struct p9_fid *fid, const char *name,\r\nconst void *value, size_t value_len, int flags)\r\n{\r\nu64 offset = 0;\r\nint retval, msize, write_count;\r\np9_debug(P9_DEBUG_VFS, "name = %s value_len = %zu flags = %d\n",\r\nname, value_len, flags);\r\nfid = p9_client_walk(fid, 0, NULL, 1);\r\nif (IS_ERR(fid))\r\nreturn PTR_ERR(fid);\r\nretval = p9_client_xattrcreate(fid, name, value_len, flags);\r\nif (retval < 0) {\r\np9_debug(P9_DEBUG_VFS, "p9_client_xattrcreate failed %d\n",\r\nretval);\r\ngoto err;\r\n}\r\nmsize = fid->clnt->msize;\r\nwhile (value_len) {\r\nif (value_len > (msize - P9_IOHDRSZ))\r\nwrite_count = msize - P9_IOHDRSZ;\r\nelse\r\nwrite_count = value_len;\r\nwrite_count = p9_client_write(fid, ((char *)value)+offset,\r\nNULL, offset, write_count);\r\nif (write_count < 0) {\r\nretval = write_count;\r\ngoto err;\r\n}\r\noffset += write_count;\r\nvalue_len -= write_count;\r\n}\r\nretval = offset;\r\nerr:\r\np9_client_clunk(fid);\r\nreturn retval;\r\n}\r\nssize_t v9fs_listxattr(struct dentry *dentry, char *buffer, size_t buffer_size)\r\n{\r\nreturn v9fs_xattr_get(dentry, NULL, buffer, buffer_size);\r\n}

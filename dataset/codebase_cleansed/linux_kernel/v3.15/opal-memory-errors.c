static void handle_memory_error_event(struct OpalMemoryErrorData *merr_evt)\r\n{\r\nuint64_t paddr_start, paddr_end;\r\npr_debug("%s: Retrived memory error event, type: 0x%x\n",\r\n__func__, merr_evt->type);\r\nswitch (merr_evt->type) {\r\ncase OPAL_MEM_ERR_TYPE_RESILIENCE:\r\npaddr_start = merr_evt->u.resilience.physical_address_start;\r\npaddr_end = merr_evt->u.resilience.physical_address_end;\r\nbreak;\r\ncase OPAL_MEM_ERR_TYPE_DYN_DALLOC:\r\npaddr_start = merr_evt->u.dyn_dealloc.physical_address_start;\r\npaddr_end = merr_evt->u.dyn_dealloc.physical_address_end;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nfor (; paddr_start < paddr_end; paddr_start += PAGE_SIZE) {\r\nmemory_failure(paddr_start >> PAGE_SHIFT, 0, 0);\r\n}\r\n}\r\nstatic void handle_memory_error(void)\r\n{\r\nunsigned long flags;\r\nstruct OpalMemoryErrorData *merr_evt;\r\nstruct OpalMsgNode *msg_node;\r\nspin_lock_irqsave(&opal_mem_err_lock, flags);\r\nwhile (!list_empty(&opal_memory_err_list)) {\r\nmsg_node = list_entry(opal_memory_err_list.next,\r\nstruct OpalMsgNode, list);\r\nlist_del(&msg_node->list);\r\nspin_unlock_irqrestore(&opal_mem_err_lock, flags);\r\nmerr_evt = (struct OpalMemoryErrorData *)\r\n&msg_node->msg.params[0];\r\nhandle_memory_error_event(merr_evt);\r\nkfree(msg_node);\r\nspin_lock_irqsave(&opal_mem_err_lock, flags);\r\n}\r\nspin_unlock_irqrestore(&opal_mem_err_lock, flags);\r\n}\r\nstatic void mem_error_handler(struct work_struct *work)\r\n{\r\nhandle_memory_error();\r\n}\r\nstatic int opal_memory_err_event(struct notifier_block *nb,\r\nunsigned long msg_type, void *msg)\r\n{\r\nunsigned long flags;\r\nstruct OpalMsgNode *msg_node;\r\nif (msg_type != OPAL_MSG_MEM_ERR)\r\nreturn 0;\r\nmsg_node = kzalloc(sizeof(*msg_node), GFP_ATOMIC);\r\nif (!msg_node) {\r\npr_err("MEMORY_ERROR: out of memory, Opal message event not"\r\n"handled\n");\r\nreturn -ENOMEM;\r\n}\r\nmemcpy(&msg_node->msg, msg, sizeof(struct opal_msg));\r\nspin_lock_irqsave(&opal_mem_err_lock, flags);\r\nlist_add(&msg_node->list, &opal_memory_err_list);\r\nspin_unlock_irqrestore(&opal_mem_err_lock, flags);\r\nschedule_work(&mem_error_work);\r\nreturn 0;\r\n}\r\nstatic int __init opal_mem_err_init(void)\r\n{\r\nint ret;\r\nif (!opal_mem_err_nb_init) {\r\nret = opal_message_notifier_register(\r\nOPAL_MSG_MEM_ERR, &opal_mem_err_nb);\r\nif (ret) {\r\npr_err("%s: Can't register OPAL event notifier (%d)\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\nopal_mem_err_nb_init = 1;\r\n}\r\nreturn 0;\r\n}

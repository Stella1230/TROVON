static int ft1000_poll_thread(void *arg)\r\n{\r\nint ret;\r\nwhile (!kthread_should_stop()) {\r\nmsleep(10);\r\nif (!gPollingfailed) {\r\nret = ft1000_poll(arg);\r\nif (ret != 0) {\r\nDEBUG("ft1000_poll_thread: polling failed\n");\r\ngPollingfailed = true;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int ft1000_probe(struct usb_interface *interface,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_host_interface *iface_desc;\r\nstruct usb_endpoint_descriptor *endpoint;\r\nstruct usb_device *dev;\r\nunsigned numaltsetting;\r\nint i, ret = 0, size;\r\nstruct ft1000_usb *ft1000dev;\r\nstruct ft1000_info *pft1000info = NULL;\r\nconst struct firmware *dsp_fw;\r\nft1000dev = kzalloc(sizeof(struct ft1000_usb), GFP_KERNEL);\r\nif (!ft1000dev)\r\nreturn -ENOMEM;\r\ndev = interface_to_usbdev(interface);\r\nDEBUG("ft1000_probe: usb device descriptor info:\n");\r\nDEBUG("ft1000_probe: number of configuration is %d\n",\r\ndev->descriptor.bNumConfigurations);\r\nft1000dev->dev = dev;\r\nft1000dev->status = 0;\r\nft1000dev->net = NULL;\r\nft1000dev->tx_urb = usb_alloc_urb(0, GFP_KERNEL);\r\nft1000dev->rx_urb = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!ft1000dev->tx_urb || !ft1000dev->rx_urb) {\r\nret = -ENOMEM;\r\ngoto err_fw;\r\n}\r\nDEBUG("ft1000_probe is called\n");\r\nnumaltsetting = interface->num_altsetting;\r\nDEBUG("ft1000_probe: number of alt settings is :%d\n", numaltsetting);\r\niface_desc = interface->cur_altsetting;\r\nDEBUG("ft1000_probe: number of endpoints is %d\n",\r\niface_desc->desc.bNumEndpoints);\r\nDEBUG("ft1000_probe: descriptor type is %d\n",\r\niface_desc->desc.bDescriptorType);\r\nDEBUG("ft1000_probe: interface number is %d\n",\r\niface_desc->desc.bInterfaceNumber);\r\nDEBUG("ft1000_probe: alternatesetting is %d\n",\r\niface_desc->desc.bAlternateSetting);\r\nDEBUG("ft1000_probe: interface class is %d\n",\r\niface_desc->desc.bInterfaceClass);\r\nDEBUG("ft1000_probe: control endpoint info:\n");\r\nDEBUG("ft1000_probe: descriptor0 type -- %d\n",\r\niface_desc->endpoint[0].desc.bmAttributes);\r\nDEBUG("ft1000_probe: descriptor1 type -- %d\n",\r\niface_desc->endpoint[1].desc.bmAttributes);\r\nDEBUG("ft1000_probe: descriptor2 type -- %d\n",\r\niface_desc->endpoint[2].desc.bmAttributes);\r\nfor (i = 0; i < iface_desc->desc.bNumEndpoints; i++) {\r\nendpoint =\r\n(struct usb_endpoint_descriptor *)&iface_desc->\r\nendpoint[i].desc;\r\nDEBUG("endpoint %d\n", i);\r\nDEBUG("bEndpointAddress=%x, bmAttributes=%x\n",\r\nendpoint->bEndpointAddress, endpoint->bmAttributes);\r\nif ((endpoint->bEndpointAddress & USB_DIR_IN)\r\n&& ((endpoint->bmAttributes & USB_ENDPOINT_XFERTYPE_MASK) ==\r\nUSB_ENDPOINT_XFER_BULK)) {\r\nft1000dev->bulk_in_endpointAddr =\r\nendpoint->bEndpointAddress;\r\nDEBUG("ft1000_probe: in: %d\n",\r\nendpoint->bEndpointAddress);\r\n}\r\nif (!(endpoint->bEndpointAddress & USB_DIR_IN)\r\n&& ((endpoint->bmAttributes & USB_ENDPOINT_XFERTYPE_MASK) ==\r\nUSB_ENDPOINT_XFER_BULK)) {\r\nft1000dev->bulk_out_endpointAddr =\r\nendpoint->bEndpointAddress;\r\nDEBUG("ft1000_probe: out: %d\n",\r\nendpoint->bEndpointAddress);\r\n}\r\n}\r\nDEBUG("bulk_in=%d, bulk_out=%d\n", ft1000dev->bulk_in_endpointAddr,\r\nft1000dev->bulk_out_endpointAddr);\r\nret = request_firmware(&dsp_fw, "ft3000.img", &dev->dev);\r\nif (ret < 0) {\r\npr_err("Error request_firmware().\n");\r\ngoto err_fw;\r\n}\r\nsize = max_t(uint, dsp_fw->size, 4096);\r\npFileStart = kmalloc(size, GFP_KERNEL);\r\nif (!pFileStart) {\r\nrelease_firmware(dsp_fw);\r\nret = -ENOMEM;\r\ngoto err_fw;\r\n}\r\nmemcpy(pFileStart, dsp_fw->data, dsp_fw->size);\r\nFileLength = dsp_fw->size;\r\nrelease_firmware(dsp_fw);\r\nDEBUG("ft1000_probe: start downloading dsp image...\n");\r\nret = init_ft1000_netdev(ft1000dev);\r\nif (ret)\r\ngoto err_load;\r\npft1000info = netdev_priv(ft1000dev->net);\r\nDEBUG("In probe: pft1000info=%p\n", pft1000info);\r\nret = dsp_reload(ft1000dev);\r\nif (ret) {\r\npr_err("Problem with DSP image loading\n");\r\ngoto err_load;\r\n}\r\ngPollingfailed = false;\r\nft1000dev->pPollThread =\r\nkthread_run(ft1000_poll_thread, ft1000dev, "ft1000_poll");\r\nif (IS_ERR(ft1000dev->pPollThread)) {\r\nret = PTR_ERR(ft1000dev->pPollThread);\r\ngoto err_load;\r\n}\r\nmsleep(500);\r\nwhile (!pft1000info->CardReady) {\r\nif (gPollingfailed) {\r\nret = -EIO;\r\ngoto err_thread;\r\n}\r\nmsleep(100);\r\nDEBUG("ft1000_probe::Waiting for Card Ready\n");\r\n}\r\nDEBUG("ft1000_probe::Card Ready!!!! Registering network device\n");\r\nret = reg_ft1000_netdev(ft1000dev, interface);\r\nif (ret)\r\ngoto err_thread;\r\nret = ft1000_init_proc(ft1000dev->net);\r\nif (ret)\r\ngoto err_proc;\r\nft1000dev->NetDevRegDone = 1;\r\nreturn 0;\r\nerr_proc:\r\nunregister_netdev(ft1000dev->net);\r\nfree_netdev(ft1000dev->net);\r\nerr_thread:\r\nkthread_stop(ft1000dev->pPollThread);\r\nerr_load:\r\nkfree(pFileStart);\r\nerr_fw:\r\nusb_free_urb(ft1000dev->rx_urb);\r\nusb_free_urb(ft1000dev->tx_urb);\r\nkfree(ft1000dev);\r\nreturn ret;\r\n}\r\nstatic void ft1000_disconnect(struct usb_interface *interface)\r\n{\r\nstruct ft1000_info *pft1000info;\r\nstruct ft1000_usb *ft1000dev;\r\nDEBUG("ft1000_disconnect is called\n");\r\npft1000info = (struct ft1000_info *) usb_get_intfdata(interface);\r\nDEBUG("In disconnect pft1000info=%p\n", pft1000info);\r\nif (pft1000info) {\r\nft1000dev = pft1000info->priv;\r\nft1000_cleanup_proc(pft1000info);\r\nif (ft1000dev->pPollThread)\r\nkthread_stop(ft1000dev->pPollThread);\r\nDEBUG("ft1000_disconnect: threads are terminated\n");\r\nif (ft1000dev->net) {\r\nDEBUG("ft1000_disconnect: destroy char driver\n");\r\nft1000_destroy_dev(ft1000dev->net);\r\nunregister_netdev(ft1000dev->net);\r\nDEBUG\r\n("ft1000_disconnect: network device unregistered\n");\r\nfree_netdev(ft1000dev->net);\r\n}\r\nusb_free_urb(ft1000dev->rx_urb);\r\nusb_free_urb(ft1000dev->tx_urb);\r\nDEBUG("ft1000_disconnect: urb freed\n");\r\nkfree(ft1000dev);\r\n}\r\nkfree(pFileStart);\r\nreturn;\r\n}

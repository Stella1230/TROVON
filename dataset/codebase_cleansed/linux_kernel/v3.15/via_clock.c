static inline u32 cle266_encode_pll(struct via_pll_config pll)\r\n{\r\nreturn (pll.multiplier << 8)\r\n| (pll.rshift << 6)\r\n| pll.divisor;\r\n}\r\nstatic inline u32 k800_encode_pll(struct via_pll_config pll)\r\n{\r\nreturn ((pll.divisor - 2) << 16)\r\n| (pll.rshift << 10)\r\n| (pll.multiplier - 2);\r\n}\r\nstatic inline u32 vx855_encode_pll(struct via_pll_config pll)\r\n{\r\nreturn (pll.divisor << 16)\r\n| (pll.rshift << 10)\r\n| pll.multiplier;\r\n}\r\nstatic inline void cle266_set_primary_pll_encoded(u32 data)\r\n{\r\nvia_write_reg_mask(VIASR, 0x40, 0x02, 0x02);\r\nvia_write_reg(VIASR, 0x46, data & 0xFF);\r\nvia_write_reg(VIASR, 0x47, (data >> 8) & 0xFF);\r\nvia_write_reg_mask(VIASR, 0x40, 0x00, 0x02);\r\n}\r\nstatic inline void k800_set_primary_pll_encoded(u32 data)\r\n{\r\nvia_write_reg_mask(VIASR, 0x40, 0x02, 0x02);\r\nvia_write_reg(VIASR, 0x44, data & 0xFF);\r\nvia_write_reg(VIASR, 0x45, (data >> 8) & 0xFF);\r\nvia_write_reg(VIASR, 0x46, (data >> 16) & 0xFF);\r\nvia_write_reg_mask(VIASR, 0x40, 0x00, 0x02);\r\n}\r\nstatic inline void cle266_set_secondary_pll_encoded(u32 data)\r\n{\r\nvia_write_reg_mask(VIASR, 0x40, 0x04, 0x04);\r\nvia_write_reg(VIASR, 0x44, data & 0xFF);\r\nvia_write_reg(VIASR, 0x45, (data >> 8) & 0xFF);\r\nvia_write_reg_mask(VIASR, 0x40, 0x00, 0x04);\r\n}\r\nstatic inline void k800_set_secondary_pll_encoded(u32 data)\r\n{\r\nvia_write_reg_mask(VIASR, 0x40, 0x04, 0x04);\r\nvia_write_reg(VIASR, 0x4A, data & 0xFF);\r\nvia_write_reg(VIASR, 0x4B, (data >> 8) & 0xFF);\r\nvia_write_reg(VIASR, 0x4C, (data >> 16) & 0xFF);\r\nvia_write_reg_mask(VIASR, 0x40, 0x00, 0x04);\r\n}\r\nstatic inline void set_engine_pll_encoded(u32 data)\r\n{\r\nvia_write_reg_mask(VIASR, 0x40, 0x01, 0x01);\r\nvia_write_reg(VIASR, 0x47, data & 0xFF);\r\nvia_write_reg(VIASR, 0x48, (data >> 8) & 0xFF);\r\nvia_write_reg(VIASR, 0x49, (data >> 16) & 0xFF);\r\nvia_write_reg_mask(VIASR, 0x40, 0x00, 0x01);\r\n}\r\nstatic void cle266_set_primary_pll(struct via_pll_config config)\r\n{\r\ncle266_set_primary_pll_encoded(cle266_encode_pll(config));\r\n}\r\nstatic void k800_set_primary_pll(struct via_pll_config config)\r\n{\r\nk800_set_primary_pll_encoded(k800_encode_pll(config));\r\n}\r\nstatic void vx855_set_primary_pll(struct via_pll_config config)\r\n{\r\nk800_set_primary_pll_encoded(vx855_encode_pll(config));\r\n}\r\nstatic void cle266_set_secondary_pll(struct via_pll_config config)\r\n{\r\ncle266_set_secondary_pll_encoded(cle266_encode_pll(config));\r\n}\r\nstatic void k800_set_secondary_pll(struct via_pll_config config)\r\n{\r\nk800_set_secondary_pll_encoded(k800_encode_pll(config));\r\n}\r\nstatic void vx855_set_secondary_pll(struct via_pll_config config)\r\n{\r\nk800_set_secondary_pll_encoded(vx855_encode_pll(config));\r\n}\r\nstatic void k800_set_engine_pll(struct via_pll_config config)\r\n{\r\nset_engine_pll_encoded(k800_encode_pll(config));\r\n}\r\nstatic void vx855_set_engine_pll(struct via_pll_config config)\r\n{\r\nset_engine_pll_encoded(vx855_encode_pll(config));\r\n}\r\nstatic void set_primary_pll_state(u8 state)\r\n{\r\nu8 value;\r\nswitch (state) {\r\ncase VIA_STATE_ON:\r\nvalue = 0x20;\r\nbreak;\r\ncase VIA_STATE_OFF:\r\nvalue = 0x00;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nvia_write_reg_mask(VIASR, 0x2D, value, 0x30);\r\n}\r\nstatic void set_secondary_pll_state(u8 state)\r\n{\r\nu8 value;\r\nswitch (state) {\r\ncase VIA_STATE_ON:\r\nvalue = 0x08;\r\nbreak;\r\ncase VIA_STATE_OFF:\r\nvalue = 0x00;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nvia_write_reg_mask(VIASR, 0x2D, value, 0x0C);\r\n}\r\nstatic void set_engine_pll_state(u8 state)\r\n{\r\nu8 value;\r\nswitch (state) {\r\ncase VIA_STATE_ON:\r\nvalue = 0x02;\r\nbreak;\r\ncase VIA_STATE_OFF:\r\nvalue = 0x00;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nvia_write_reg_mask(VIASR, 0x2D, value, 0x03);\r\n}\r\nstatic void set_primary_clock_state(u8 state)\r\n{\r\nu8 value;\r\nswitch (state) {\r\ncase VIA_STATE_ON:\r\nvalue = 0x20;\r\nbreak;\r\ncase VIA_STATE_OFF:\r\nvalue = 0x00;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nvia_write_reg_mask(VIASR, 0x1B, value, 0x30);\r\n}\r\nstatic void set_secondary_clock_state(u8 state)\r\n{\r\nu8 value;\r\nswitch (state) {\r\ncase VIA_STATE_ON:\r\nvalue = 0x80;\r\nbreak;\r\ncase VIA_STATE_OFF:\r\nvalue = 0x00;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nvia_write_reg_mask(VIASR, 0x1B, value, 0xC0);\r\n}\r\nstatic inline u8 set_clock_source_common(enum via_clksrc source, bool use_pll)\r\n{\r\nu8 data = 0;\r\nswitch (source) {\r\ncase VIA_CLKSRC_X1:\r\ndata = 0x00;\r\nbreak;\r\ncase VIA_CLKSRC_TVX1:\r\ndata = 0x02;\r\nbreak;\r\ncase VIA_CLKSRC_TVPLL:\r\ndata = 0x04;\r\nbreak;\r\ncase VIA_CLKSRC_DVP1TVCLKR:\r\ndata = 0x0A;\r\nbreak;\r\ncase VIA_CLKSRC_CAP0:\r\ndata = 0xC;\r\nbreak;\r\ncase VIA_CLKSRC_CAP1:\r\ndata = 0x0E;\r\nbreak;\r\n}\r\nif (!use_pll)\r\ndata |= 1;\r\nreturn data;\r\n}\r\nstatic void set_primary_clock_source(enum via_clksrc source, bool use_pll)\r\n{\r\nu8 data = set_clock_source_common(source, use_pll) << 4;\r\nvia_write_reg_mask(VIACR, 0x6C, data, 0xF0);\r\n}\r\nstatic void set_secondary_clock_source(enum via_clksrc source, bool use_pll)\r\n{\r\nu8 data = set_clock_source_common(source, use_pll);\r\nvia_write_reg_mask(VIACR, 0x6C, data, 0x0F);\r\n}\r\nstatic void dummy_set_clock_state(u8 state)\r\n{\r\nprintk(KERN_INFO "Using undocumented set clock state.\n%s", via_slap);\r\n}\r\nstatic void dummy_set_clock_source(enum via_clksrc source, bool use_pll)\r\n{\r\nprintk(KERN_INFO "Using undocumented set clock source.\n%s", via_slap);\r\n}\r\nstatic void dummy_set_pll_state(u8 state)\r\n{\r\nprintk(KERN_INFO "Using undocumented set PLL state.\n%s", via_slap);\r\n}\r\nstatic void dummy_set_pll(struct via_pll_config config)\r\n{\r\nprintk(KERN_INFO "Using undocumented set PLL.\n%s", via_slap);\r\n}\r\nstatic void noop_set_clock_state(u8 state)\r\n{\r\n}\r\nvoid via_clock_init(struct via_clock *clock, int gfx_chip)\r\n{\r\nswitch (gfx_chip) {\r\ncase UNICHROME_CLE266:\r\ncase UNICHROME_K400:\r\nclock->set_primary_clock_state = dummy_set_clock_state;\r\nclock->set_primary_clock_source = dummy_set_clock_source;\r\nclock->set_primary_pll_state = dummy_set_pll_state;\r\nclock->set_primary_pll = cle266_set_primary_pll;\r\nclock->set_secondary_clock_state = dummy_set_clock_state;\r\nclock->set_secondary_clock_source = dummy_set_clock_source;\r\nclock->set_secondary_pll_state = dummy_set_pll_state;\r\nclock->set_secondary_pll = cle266_set_secondary_pll;\r\nclock->set_engine_pll_state = dummy_set_pll_state;\r\nclock->set_engine_pll = dummy_set_pll;\r\nbreak;\r\ncase UNICHROME_K800:\r\ncase UNICHROME_PM800:\r\ncase UNICHROME_CN700:\r\ncase UNICHROME_CX700:\r\ncase UNICHROME_CN750:\r\ncase UNICHROME_K8M890:\r\ncase UNICHROME_P4M890:\r\ncase UNICHROME_P4M900:\r\ncase UNICHROME_VX800:\r\nclock->set_primary_clock_state = set_primary_clock_state;\r\nclock->set_primary_clock_source = set_primary_clock_source;\r\nclock->set_primary_pll_state = set_primary_pll_state;\r\nclock->set_primary_pll = k800_set_primary_pll;\r\nclock->set_secondary_clock_state = set_secondary_clock_state;\r\nclock->set_secondary_clock_source = set_secondary_clock_source;\r\nclock->set_secondary_pll_state = set_secondary_pll_state;\r\nclock->set_secondary_pll = k800_set_secondary_pll;\r\nclock->set_engine_pll_state = set_engine_pll_state;\r\nclock->set_engine_pll = k800_set_engine_pll;\r\nbreak;\r\ncase UNICHROME_VX855:\r\ncase UNICHROME_VX900:\r\nclock->set_primary_clock_state = set_primary_clock_state;\r\nclock->set_primary_clock_source = set_primary_clock_source;\r\nclock->set_primary_pll_state = set_primary_pll_state;\r\nclock->set_primary_pll = vx855_set_primary_pll;\r\nclock->set_secondary_clock_state = set_secondary_clock_state;\r\nclock->set_secondary_clock_source = set_secondary_clock_source;\r\nclock->set_secondary_pll_state = set_secondary_pll_state;\r\nclock->set_secondary_pll = vx855_set_secondary_pll;\r\nclock->set_engine_pll_state = set_engine_pll_state;\r\nclock->set_engine_pll = vx855_set_engine_pll;\r\nbreak;\r\n}\r\nif (machine_is_olpc()) {\r\nclock->set_primary_clock_state = noop_set_clock_state;\r\nclock->set_secondary_clock_state = noop_set_clock_state;\r\n}\r\n}

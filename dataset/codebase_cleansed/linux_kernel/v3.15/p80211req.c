int p80211req_dorequest(wlandevice_t *wlandev, u8 *msgbuf)\r\n{\r\nint result = 0;\r\nstruct p80211msg *msg = (struct p80211msg *) msgbuf;\r\nif (!((wlandev->msdstate == WLAN_MSD_HWPRESENT &&\r\nmsg->msgcode == DIDmsg_lnxreq_ifstate) ||\r\nwlandev->msdstate == WLAN_MSD_RUNNING ||\r\nwlandev->msdstate == WLAN_MSD_FWLOAD)) {\r\nreturn -ENODEV;\r\n}\r\nif (!capable(CAP_NET_ADMIN) &&\r\n(msg->msgcode != DIDmsg_dot11req_mibget)) {\r\nprintk(KERN_ERR\r\n"%s: only dot11req_mibget allowed for non-root.\n",\r\nwlandev->name);\r\nreturn -EPERM;\r\n}\r\nif (test_and_set_bit(1, &(wlandev->request_pending)))\r\nreturn -EBUSY;\r\np80211req_handlemsg(wlandev, msg);\r\nif (wlandev->mlmerequest != NULL)\r\nwlandev->mlmerequest(wlandev, msg);\r\nclear_bit(1, &(wlandev->request_pending));\r\nreturn result;\r\n}\r\nstatic void p80211req_handlemsg(wlandevice_t *wlandev, struct p80211msg *msg)\r\n{\r\nswitch (msg->msgcode) {\r\ncase DIDmsg_lnxreq_hostwep:{\r\nstruct p80211msg_lnxreq_hostwep *req =\r\n(struct p80211msg_lnxreq_hostwep *) msg;\r\nwlandev->hostwep &=\r\n~(HOSTWEP_DECRYPT | HOSTWEP_ENCRYPT);\r\nif (req->decrypt.data == P80211ENUM_truth_true)\r\nwlandev->hostwep |= HOSTWEP_DECRYPT;\r\nif (req->encrypt.data == P80211ENUM_truth_true)\r\nwlandev->hostwep |= HOSTWEP_ENCRYPT;\r\nbreak;\r\n}\r\ncase DIDmsg_dot11req_mibget:\r\ncase DIDmsg_dot11req_mibset:{\r\nint isget = (msg->msgcode == DIDmsg_dot11req_mibget);\r\nstruct p80211msg_dot11req_mibget *mib_msg =\r\n(struct p80211msg_dot11req_mibget *) msg;\r\np80211req_mibset_mibget(wlandev, mib_msg, isget);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void p80211req_mibset_mibget(wlandevice_t *wlandev,\r\nstruct p80211msg_dot11req_mibget *mib_msg,\r\nint isget)\r\n{\r\np80211itemd_t *mibitem = (p80211itemd_t *) mib_msg->mibattribute.data;\r\np80211pstrd_t *pstr = (p80211pstrd_t *) mibitem->data;\r\nu8 *key = mibitem->data + sizeof(p80211pstrd_t);\r\nswitch (mibitem->did) {\r\ncase DIDmib_dot11smt_dot11WEPDefaultKeysTable_dot11WEPDefaultKey0:{\r\nif (!isget)\r\nwep_change_key(wlandev, 0, key, pstr->len);\r\nbreak;\r\n}\r\ncase DIDmib_dot11smt_dot11WEPDefaultKeysTable_dot11WEPDefaultKey1:{\r\nif (!isget)\r\nwep_change_key(wlandev, 1, key, pstr->len);\r\nbreak;\r\n}\r\ncase DIDmib_dot11smt_dot11WEPDefaultKeysTable_dot11WEPDefaultKey2:{\r\nif (!isget)\r\nwep_change_key(wlandev, 2, key, pstr->len);\r\nbreak;\r\n}\r\ncase DIDmib_dot11smt_dot11WEPDefaultKeysTable_dot11WEPDefaultKey3:{\r\nif (!isget)\r\nwep_change_key(wlandev, 3, key, pstr->len);\r\nbreak;\r\n}\r\ncase DIDmib_dot11smt_dot11PrivacyTable_dot11WEPDefaultKeyID:{\r\nu32 *data = (u32 *) mibitem->data;\r\nif (isget) {\r\n*data = wlandev->hostwep & HOSTWEP_DEFAULTKEY_MASK;\r\n} else {\r\nwlandev->hostwep &= ~(HOSTWEP_DEFAULTKEY_MASK);\r\nwlandev->hostwep |= (*data & HOSTWEP_DEFAULTKEY_MASK);\r\n}\r\nbreak;\r\n}\r\ncase DIDmib_dot11smt_dot11PrivacyTable_dot11PrivacyInvoked:{\r\nu32 *data = (u32 *) mibitem->data;\r\nif (isget) {\r\nif (wlandev->hostwep & HOSTWEP_PRIVACYINVOKED)\r\n*data = P80211ENUM_truth_true;\r\nelse\r\n*data = P80211ENUM_truth_false;\r\n} else {\r\nwlandev->hostwep &= ~(HOSTWEP_PRIVACYINVOKED);\r\nif (*data == P80211ENUM_truth_true)\r\nwlandev->hostwep |= HOSTWEP_PRIVACYINVOKED;\r\n}\r\nbreak;\r\n}\r\ncase DIDmib_dot11smt_dot11PrivacyTable_dot11ExcludeUnencrypted:{\r\nu32 *data = (u32 *) mibitem->data;\r\nif (isget) {\r\nif (wlandev->hostwep & HOSTWEP_EXCLUDEUNENCRYPTED)\r\n*data = P80211ENUM_truth_true;\r\nelse\r\n*data = P80211ENUM_truth_false;\r\n} else {\r\nwlandev->hostwep &= ~(HOSTWEP_EXCLUDEUNENCRYPTED);\r\nif (*data == P80211ENUM_truth_true)\r\nwlandev->hostwep |= HOSTWEP_EXCLUDEUNENCRYPTED;\r\n}\r\nbreak;\r\n}\r\n}\r\n}

static int ad7879_spi_xfer(struct spi_device *spi,\r\nu16 cmd, u8 count, u16 *tx_buf, u16 *rx_buf)\r\n{\r\nstruct spi_message msg;\r\nstruct spi_transfer *xfers;\r\nvoid *spi_data;\r\nu16 *command;\r\nu16 *_rx_buf = _rx_buf;\r\nu8 idx;\r\nint ret;\r\nxfers = spi_data = kzalloc(sizeof(*xfers) * (count + 2), GFP_KERNEL);\r\nif (!spi_data)\r\nreturn -ENOMEM;\r\nspi_message_init(&msg);\r\ncommand = spi_data;\r\ncommand[0] = cmd;\r\nif (count == 1) {\r\ncommand[1] = *tx_buf;\r\ntx_buf = &command[1];\r\n_rx_buf = rx_buf;\r\nrx_buf = &command[2];\r\n}\r\n++xfers;\r\nxfers[0].tx_buf = command;\r\nxfers[0].len = 2;\r\nspi_message_add_tail(&xfers[0], &msg);\r\n++xfers;\r\nfor (idx = 0; idx < count; ++idx) {\r\nif (rx_buf)\r\nxfers[idx].rx_buf = &rx_buf[idx];\r\nif (tx_buf)\r\nxfers[idx].tx_buf = &tx_buf[idx];\r\nxfers[idx].len = 2;\r\nspi_message_add_tail(&xfers[idx], &msg);\r\n}\r\nret = spi_sync(spi, &msg);\r\nif (count == 1)\r\n_rx_buf[0] = command[2];\r\nkfree(spi_data);\r\nreturn ret;\r\n}\r\nstatic int ad7879_spi_multi_read(struct device *dev,\r\nu8 first_reg, u8 count, u16 *buf)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nreturn ad7879_spi_xfer(spi, AD7879_READCMD(first_reg), count, NULL, buf);\r\n}\r\nstatic int ad7879_spi_read(struct device *dev, u8 reg)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nu16 ret, dummy;\r\nreturn ad7879_spi_xfer(spi, AD7879_READCMD(reg), 1, &dummy, &ret) ? : ret;\r\n}\r\nstatic int ad7879_spi_write(struct device *dev, u8 reg, u16 val)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nu16 dummy;\r\nreturn ad7879_spi_xfer(spi, AD7879_WRITECMD(reg), 1, &val, &dummy);\r\n}\r\nstatic int ad7879_spi_probe(struct spi_device *spi)\r\n{\r\nstruct ad7879 *ts;\r\nint err;\r\nif (spi->max_speed_hz > MAX_SPI_FREQ_HZ) {\r\ndev_err(&spi->dev, "SPI CLK %d Hz?\n", spi->max_speed_hz);\r\nreturn -EINVAL;\r\n}\r\nspi->bits_per_word = 16;\r\nerr = spi_setup(spi);\r\nif (err) {\r\ndev_dbg(&spi->dev, "spi master doesn't support 16 bits/word\n");\r\nreturn err;\r\n}\r\nts = ad7879_probe(&spi->dev, AD7879_DEVID, spi->irq, &ad7879_spi_bus_ops);\r\nif (IS_ERR(ts))\r\nreturn PTR_ERR(ts);\r\nspi_set_drvdata(spi, ts);\r\nreturn 0;\r\n}\r\nstatic int ad7879_spi_remove(struct spi_device *spi)\r\n{\r\nstruct ad7879 *ts = spi_get_drvdata(spi);\r\nad7879_remove(ts);\r\nreturn 0;\r\n}

static int omap2_enter_full_retention(void)\r\n{\r\nu32 l;\r\nclk_disable(osc_ck);\r\nomap2_prm_write_mod_reg(0xffffffff, CORE_MOD, PM_WKST1);\r\nomap2_prm_write_mod_reg(0xffffffff, CORE_MOD, OMAP24XX_PM_WKST2);\r\nomap2_prm_write_mod_reg(0xffffffff, WKUP_MOD, PM_WKST);\r\npwrdm_set_next_pwrst(core_pwrdm, PWRDM_POWER_RET);\r\npwrdm_set_next_pwrst(mpu_pwrdm, PWRDM_POWER_RET);\r\nl = omap_ctrl_readl(OMAP2_CONTROL_DEVCONF0) | OMAP24XX_USBSTANDBYCTRL;\r\nomap_ctrl_writel(l, OMAP2_CONTROL_DEVCONF0);\r\nomap2_gpio_prepare_for_idle(0);\r\nif (omap_irq_pending())\r\ngoto no_sleep;\r\nomap2_sram_suspend(sdrc_read_reg(SDRC_DLLA_CTRL),\r\nOMAP_SDRC_REGADDR(SDRC_DLLA_CTRL),\r\nOMAP_SDRC_REGADDR(SDRC_POWER));\r\nno_sleep:\r\nomap2_gpio_resume_after_idle();\r\nclk_enable(osc_ck);\r\nomap2_prm_write_mod_reg(0xffffffff, CORE_MOD, PM_WKST1);\r\nomap2_prm_write_mod_reg(0xffffffff, CORE_MOD, OMAP24XX_PM_WKST2);\r\nomap2_prm_clear_mod_reg_bits(0x4 | 0x1, WKUP_MOD, PM_WKST);\r\nl = omap2_prm_read_mod_reg(OCP_MOD, OMAP2_PRCM_IRQSTATUS_MPU_OFFSET);\r\nif (l & 0x01)\r\nomap2_prm_write_mod_reg(0x01, OCP_MOD,\r\nOMAP2_PRCM_IRQSTATUS_MPU_OFFSET);\r\nif (l & 0x20)\r\nomap2_prm_write_mod_reg(0x20, OCP_MOD,\r\nOMAP2_PRCM_IRQSTATUS_MPU_OFFSET);\r\nomap2_prm_write_mod_reg(0x0, OCP_MOD, OMAP2_PRCM_IRQSTATUS_MPU_OFFSET);\r\npwrdm_set_next_pwrst(mpu_pwrdm, PWRDM_POWER_ON);\r\npwrdm_set_next_pwrst(core_pwrdm, PWRDM_POWER_ON);\r\nreturn 0;\r\n}\r\nstatic int omap2_allow_mpu_retention(void)\r\n{\r\nif (!omap2xxx_cm_mpu_retention_allowed())\r\nreturn 0;\r\nif (sti_console_enabled)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic void omap2_enter_mpu_retention(void)\r\n{\r\nconst int zero = 0;\r\nif (omap2_allow_mpu_retention()) {\r\nomap2_prm_write_mod_reg(0xffffffff, CORE_MOD, PM_WKST1);\r\nomap2_prm_write_mod_reg(0xffffffff, CORE_MOD, OMAP24XX_PM_WKST2);\r\nomap2_prm_write_mod_reg(0xffffffff, WKUP_MOD, PM_WKST);\r\npwrdm_set_next_pwrst(mpu_pwrdm, PWRDM_POWER_RET);\r\n} else {\r\npwrdm_set_next_pwrst(mpu_pwrdm, PWRDM_POWER_ON);\r\n}\r\nasm("mcr p15, 0, %0, c7, c0, 4" : : "r" (zero) : "memory", "cc");\r\npwrdm_set_next_pwrst(mpu_pwrdm, PWRDM_POWER_ON);\r\n}\r\nstatic int omap2_can_sleep(void)\r\n{\r\nif (omap2xxx_cm_fclks_active())\r\nreturn 0;\r\nif (__clk_is_enabled(osc_ck))\r\nreturn 0;\r\nif (omap_dma_running())\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic void omap2_pm_idle(void)\r\n{\r\nif (!omap2_can_sleep()) {\r\nif (omap_irq_pending())\r\nreturn;\r\nomap2_enter_mpu_retention();\r\nreturn;\r\n}\r\nif (omap_irq_pending())\r\nreturn;\r\nomap2_enter_full_retention();\r\n}\r\nstatic void __init prcm_setup_regs(void)\r\n{\r\nint i, num_mem_banks;\r\nstruct powerdomain *pwrdm;\r\nomap2_prm_write_mod_reg(OMAP24XX_AUTOIDLE_MASK, OCP_MOD,\r\nOMAP2_PRCM_SYSCONFIG_OFFSET);\r\nnum_mem_banks = pwrdm_get_mem_bank_count(core_pwrdm);\r\nfor (i = 0; i < num_mem_banks; i++)\r\npwrdm_set_mem_retst(core_pwrdm, i, PWRDM_POWER_RET);\r\npwrdm_set_logic_retst(core_pwrdm, PWRDM_POWER_RET);\r\npwrdm_set_logic_retst(mpu_pwrdm, PWRDM_POWER_RET);\r\npwrdm = clkdm_get_pwrdm(dsp_clkdm);\r\npwrdm_set_next_pwrst(pwrdm, PWRDM_POWER_OFF);\r\npwrdm = clkdm_get_pwrdm(gfx_clkdm);\r\npwrdm_set_next_pwrst(pwrdm, PWRDM_POWER_OFF);\r\nclkdm_for_each(omap_pm_clkdms_setup, NULL);\r\nclkdm_add_wkdep(mpu_clkdm, wkup_clkdm);\r\n#ifdef CONFIG_SUSPEND\r\nomap_pm_suspend = omap2_enter_full_retention;\r\n#endif\r\nomap2_prm_write_mod_reg(15 << OMAP_SETUP_TIME_SHIFT, OMAP24XX_GR_MOD,\r\nOMAP2_PRCM_CLKSSETUP_OFFSET);\r\nomap2_prm_write_mod_reg(2 << OMAP_SETUP_TIME_SHIFT, OMAP24XX_GR_MOD,\r\nOMAP2_PRCM_VOLTSETUP_OFFSET);\r\nomap2_prm_write_mod_reg(OMAP24XX_AUTO_EXTVOLT_MASK |\r\n(0x1 << OMAP24XX_SETOFF_LEVEL_SHIFT) |\r\nOMAP24XX_MEMRETCTRL_MASK |\r\n(0x1 << OMAP24XX_SETRET_LEVEL_SHIFT) |\r\n(0x0 << OMAP24XX_VOLT_LEVEL_SHIFT),\r\nOMAP24XX_GR_MOD, OMAP2_PRCM_VOLTCTRL_OFFSET);\r\nomap2_prm_write_mod_reg(OMAP24XX_EN_GPIOS_MASK | OMAP24XX_EN_GPT1_MASK,\r\nWKUP_MOD, PM_WKEN);\r\n}\r\nint __init omap2_pm_init(void)\r\n{\r\nu32 l;\r\nprintk(KERN_INFO "Power Management for OMAP2 initializing\n");\r\nl = omap2_prm_read_mod_reg(OCP_MOD, OMAP2_PRCM_REVISION_OFFSET);\r\nprintk(KERN_INFO "PRCM revision %d.%d\n", (l >> 4) & 0x0f, l & 0x0f);\r\nmpu_pwrdm = pwrdm_lookup("mpu_pwrdm");\r\nif (!mpu_pwrdm)\r\npr_err("PM: mpu_pwrdm not found\n");\r\ncore_pwrdm = pwrdm_lookup("core_pwrdm");\r\nif (!core_pwrdm)\r\npr_err("PM: core_pwrdm not found\n");\r\nmpu_clkdm = clkdm_lookup("mpu_clkdm");\r\nif (!mpu_clkdm)\r\npr_err("PM: mpu_clkdm not found\n");\r\nwkup_clkdm = clkdm_lookup("wkup_clkdm");\r\nif (!wkup_clkdm)\r\npr_err("PM: wkup_clkdm not found\n");\r\ndsp_clkdm = clkdm_lookup("dsp_clkdm");\r\nif (!dsp_clkdm)\r\npr_err("PM: dsp_clkdm not found\n");\r\ngfx_clkdm = clkdm_lookup("gfx_clkdm");\r\nif (!gfx_clkdm)\r\npr_err("PM: gfx_clkdm not found\n");\r\nosc_ck = clk_get(NULL, "osc_ck");\r\nif (IS_ERR(osc_ck)) {\r\nprintk(KERN_ERR "could not get osc_ck\n");\r\nreturn -ENODEV;\r\n}\r\nif (cpu_is_omap242x()) {\r\nemul_ck = clk_get(NULL, "emul_ck");\r\nif (IS_ERR(emul_ck)) {\r\nprintk(KERN_ERR "could not get emul_ck\n");\r\nclk_put(osc_ck);\r\nreturn -ENODEV;\r\n}\r\n}\r\nprcm_setup_regs();\r\nomap2_sram_suspend = omap_sram_push(omap24xx_cpu_suspend,\r\nomap24xx_cpu_suspend_sz);\r\narm_pm_idle = omap2_pm_idle;\r\nreturn 0;\r\n}

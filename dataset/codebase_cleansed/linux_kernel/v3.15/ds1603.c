static void rtc_reg_write(unsigned long val)\r\n{\r\n*ds1603->reg = val;\r\n}\r\nstatic unsigned long rtc_reg_read(void)\r\n{\r\nunsigned long tmp = *ds1603->reg;\r\nreturn tmp;\r\n}\r\nstatic unsigned long rtc_datareg_read(void)\r\n{\r\nunsigned long tmp = *ds1603->data_reg;\r\nreturn tmp;\r\n}\r\nstatic void rtc_nrst_high(void)\r\n{\r\nrtc_reg_write(rtc_reg_read() | ds1603->rst);\r\n}\r\nstatic void rtc_nrst_low(void)\r\n{\r\nrtc_reg_write(rtc_reg_read() & ~ds1603->rst);\r\n}\r\nstatic void rtc_cycle_clock(unsigned long data)\r\n{\r\ndata |= ds1603->clk;\r\nrtc_reg_write(data);\r\nlasat_ndelay(250);\r\nif (ds1603->data_reversed)\r\ndata &= ~ds1603->data;\r\nelse\r\ndata |= ds1603->data;\r\ndata &= ~ds1603->clk;\r\nrtc_reg_write(data);\r\nlasat_ndelay(250 + ds1603->huge_delay);\r\n}\r\nstatic void rtc_write_databit(unsigned int bit)\r\n{\r\nunsigned long data = rtc_reg_read();\r\nif (ds1603->data_reversed)\r\nbit = !bit;\r\nif (bit)\r\ndata |= ds1603->data;\r\nelse\r\ndata &= ~ds1603->data;\r\nrtc_reg_write(data);\r\nlasat_ndelay(50 + ds1603->huge_delay);\r\nrtc_cycle_clock(data);\r\n}\r\nstatic unsigned int rtc_read_databit(void)\r\n{\r\nunsigned int data;\r\ndata = (rtc_datareg_read() & (1 << ds1603->data_read_shift))\r\n>> ds1603->data_read_shift;\r\nrtc_cycle_clock(rtc_reg_read());\r\nreturn data;\r\n}\r\nstatic void rtc_write_byte(unsigned int byte)\r\n{\r\nint i;\r\nfor (i = 0; i <= 7; i++) {\r\nrtc_write_databit(byte & 1L);\r\nbyte >>= 1;\r\n}\r\n}\r\nstatic void rtc_write_word(unsigned long word)\r\n{\r\nint i;\r\nfor (i = 0; i <= 31; i++) {\r\nrtc_write_databit(word & 1L);\r\nword >>= 1;\r\n}\r\n}\r\nstatic unsigned long rtc_read_word(void)\r\n{\r\nint i;\r\nunsigned long word = 0;\r\nunsigned long shift = 0;\r\nfor (i = 0; i <= 31; i++) {\r\nword |= rtc_read_databit() << shift;\r\nshift++;\r\n}\r\nreturn word;\r\n}\r\nstatic void rtc_init_op(void)\r\n{\r\nrtc_nrst_high();\r\nrtc_reg_write(rtc_reg_read() & ~ds1603->clk);\r\nlasat_ndelay(50);\r\n}\r\nstatic void rtc_end_op(void)\r\n{\r\nrtc_nrst_low();\r\nlasat_ndelay(1000);\r\n}\r\nvoid read_persistent_clock(struct timespec *ts)\r\n{\r\nunsigned long word;\r\nunsigned long flags;\r\nspin_lock_irqsave(&rtc_lock, flags);\r\nrtc_init_op();\r\nrtc_write_byte(READ_TIME_CMD);\r\nword = rtc_read_word();\r\nrtc_end_op();\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nts->tv_sec = word;\r\nts->tv_nsec = 0;\r\n}\r\nint rtc_mips_set_mmss(unsigned long time)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&rtc_lock, flags);\r\nrtc_init_op();\r\nrtc_write_byte(SET_TIME_CMD);\r\nrtc_write_word(time);\r\nrtc_end_op();\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nreturn 0;\r\n}\r\nvoid ds1603_set_trimmer(unsigned int trimval)\r\n{\r\nrtc_init_op();\r\nrtc_write_byte(((trimval << TRIMMER_SHIFT) & TRIMMER_VALUE_MASK)\r\n| (TRIMMER_SET_CMD));\r\nrtc_end_op();\r\n}\r\nvoid ds1603_disable(void)\r\n{\r\nds1603_set_trimmer(TRIMMER_DISABLE_RTC);\r\n}\r\nvoid ds1603_enable(void)\r\n{\r\nds1603_set_trimmer(TRIMMER_DEFAULT);\r\n}

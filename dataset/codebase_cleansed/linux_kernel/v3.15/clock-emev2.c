static void emev2_smu_write(unsigned long value, int offs)\r\n{\r\nBUG_ON(!smu_base || (offs >= PAGE_SIZE));\r\niowrite32(value, smu_base + offs);\r\n}\r\nstatic unsigned long pll3_recalc(struct clk *clk)\r\n{\r\nreturn clk->parent->rate * 7000;\r\n}\r\nstatic int emev2_gclk_enable(struct clk *clk)\r\n{\r\niowrite32(ioread32(clk->mapped_reg) | (1 << clk->enable_bit),\r\nclk->mapped_reg);\r\nreturn 0;\r\n}\r\nstatic void emev2_gclk_disable(struct clk *clk)\r\n{\r\niowrite32(ioread32(clk->mapped_reg) & ~(1 << clk->enable_bit),\r\nclk->mapped_reg);\r\n}\r\nstatic int __init emev2_gclk_register(struct clk *clks, int nr)\r\n{\r\nstruct clk *clkp;\r\nint ret = 0;\r\nint k;\r\nfor (k = 0; !ret && (k < nr); k++) {\r\nclkp = clks + k;\r\nclkp->ops = &emev2_gclk_clk_ops;\r\nret |= clk_register(clkp);\r\n}\r\nreturn ret;\r\n}\r\nstatic unsigned long emev2_sclkdiv_recalc(struct clk *clk)\r\n{\r\nunsigned int sclk_div;\r\nsclk_div = (ioread32(clk->mapped_reg) >> clk->enable_bit) & 0xff;\r\nreturn clk->parent->rate / (sclk_div + 1);\r\n}\r\nstatic int __init emev2_sclkdiv_register(struct clk *clks, int nr)\r\n{\r\nstruct clk *clkp;\r\nint ret = 0;\r\nint k;\r\nfor (k = 0; !ret && (k < nr); k++) {\r\nclkp = clks + k;\r\nclkp->ops = &emev2_sclkdiv_clk_ops;\r\nret |= clk_register(clkp);\r\n}\r\nreturn ret;\r\n}\r\nvoid __init emev2_clock_init(void)\r\n{\r\nint k, ret = 0;\r\nsmu_base = ioremap(EMEV2_SMU_BASE, PAGE_SIZE);\r\nBUG_ON(!smu_base);\r\nemev2_smu_write(0, STI_CLKSEL);\r\nemev2_smu_write(1, STI_RSTCTRL);\r\nemev2_smu_write(2, USIAU0_RSTCTRL);\r\nemev2_smu_write(2, USIBU1_RSTCTRL);\r\nemev2_smu_write(2, USIBU2_RSTCTRL);\r\nemev2_smu_write(2, USIBU3_RSTCTRL);\r\nfor (k = 0; !ret && (k < ARRAY_SIZE(main_clks)); k++)\r\nret = clk_register(main_clks[k]);\r\nif (!ret)\r\nret = emev2_sclkdiv_register(sclkdiv_clks, SCLKDIV_NR);\r\nif (!ret)\r\nret = emev2_gclk_register(gclk_clks, GCLK_NR);\r\nclkdev_add_table(lookups, ARRAY_SIZE(lookups));\r\nif (!ret)\r\nshmobile_clk_init();\r\nelse\r\npanic("failed to setup emev2 clocks\n");\r\n}

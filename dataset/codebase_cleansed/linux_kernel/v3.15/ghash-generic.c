static int ghash_init(struct shash_desc *desc)\r\n{\r\nstruct ghash_desc_ctx *dctx = shash_desc_ctx(desc);\r\nmemset(dctx, 0, sizeof(*dctx));\r\nreturn 0;\r\n}\r\nstatic int ghash_setkey(struct crypto_shash *tfm,\r\nconst u8 *key, unsigned int keylen)\r\n{\r\nstruct ghash_ctx *ctx = crypto_shash_ctx(tfm);\r\nif (keylen != GHASH_BLOCK_SIZE) {\r\ncrypto_shash_set_flags(tfm, CRYPTO_TFM_RES_BAD_KEY_LEN);\r\nreturn -EINVAL;\r\n}\r\nif (ctx->gf128)\r\ngf128mul_free_4k(ctx->gf128);\r\nctx->gf128 = gf128mul_init_4k_lle((be128 *)key);\r\nif (!ctx->gf128)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic int ghash_update(struct shash_desc *desc,\r\nconst u8 *src, unsigned int srclen)\r\n{\r\nstruct ghash_desc_ctx *dctx = shash_desc_ctx(desc);\r\nstruct ghash_ctx *ctx = crypto_shash_ctx(desc->tfm);\r\nu8 *dst = dctx->buffer;\r\nif (!ctx->gf128)\r\nreturn -ENOKEY;\r\nif (dctx->bytes) {\r\nint n = min(srclen, dctx->bytes);\r\nu8 *pos = dst + (GHASH_BLOCK_SIZE - dctx->bytes);\r\ndctx->bytes -= n;\r\nsrclen -= n;\r\nwhile (n--)\r\n*pos++ ^= *src++;\r\nif (!dctx->bytes)\r\ngf128mul_4k_lle((be128 *)dst, ctx->gf128);\r\n}\r\nwhile (srclen >= GHASH_BLOCK_SIZE) {\r\ncrypto_xor(dst, src, GHASH_BLOCK_SIZE);\r\ngf128mul_4k_lle((be128 *)dst, ctx->gf128);\r\nsrc += GHASH_BLOCK_SIZE;\r\nsrclen -= GHASH_BLOCK_SIZE;\r\n}\r\nif (srclen) {\r\ndctx->bytes = GHASH_BLOCK_SIZE - srclen;\r\nwhile (srclen--)\r\n*dst++ ^= *src++;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ghash_flush(struct ghash_ctx *ctx, struct ghash_desc_ctx *dctx)\r\n{\r\nu8 *dst = dctx->buffer;\r\nif (dctx->bytes) {\r\nu8 *tmp = dst + (GHASH_BLOCK_SIZE - dctx->bytes);\r\nwhile (dctx->bytes--)\r\n*tmp++ ^= 0;\r\ngf128mul_4k_lle((be128 *)dst, ctx->gf128);\r\n}\r\ndctx->bytes = 0;\r\n}\r\nstatic int ghash_final(struct shash_desc *desc, u8 *dst)\r\n{\r\nstruct ghash_desc_ctx *dctx = shash_desc_ctx(desc);\r\nstruct ghash_ctx *ctx = crypto_shash_ctx(desc->tfm);\r\nu8 *buf = dctx->buffer;\r\nif (!ctx->gf128)\r\nreturn -ENOKEY;\r\nghash_flush(ctx, dctx);\r\nmemcpy(dst, buf, GHASH_BLOCK_SIZE);\r\nreturn 0;\r\n}\r\nstatic void ghash_exit_tfm(struct crypto_tfm *tfm)\r\n{\r\nstruct ghash_ctx *ctx = crypto_tfm_ctx(tfm);\r\nif (ctx->gf128)\r\ngf128mul_free_4k(ctx->gf128);\r\n}\r\nstatic int __init ghash_mod_init(void)\r\n{\r\nreturn crypto_register_shash(&ghash_alg);\r\n}\r\nstatic void __exit ghash_mod_exit(void)\r\n{\r\ncrypto_unregister_shash(&ghash_alg);\r\n}

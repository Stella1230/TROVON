static int metag_timer_set_next_event(unsigned long delta,\r\nstruct clock_event_device *dev)\r\n{\r\n__core_reg_set(TXTIMERI, -delta);\r\nreturn 0;\r\n}\r\nstatic void metag_timer_set_mode(enum clock_event_mode mode,\r\nstruct clock_event_device *evt)\r\n{\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_ONESHOT:\r\ncase CLOCK_EVT_MODE_RESUME:\r\nbreak;\r\ncase CLOCK_EVT_MODE_SHUTDOWN:\r\nbreak;\r\ncase CLOCK_EVT_MODE_PERIODIC:\r\ncase CLOCK_EVT_MODE_UNUSED:\r\nWARN_ON(1);\r\nbreak;\r\n};\r\n}\r\nstatic cycle_t metag_clocksource_read(struct clocksource *cs)\r\n{\r\nreturn __core_reg_get(TXTIMER);\r\n}\r\nstatic irqreturn_t metag_timer_interrupt(int irq, void *dummy)\r\n{\r\nstruct clock_event_device *evt = &__get_cpu_var(local_clockevent);\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nunsigned long long sched_clock(void)\r\n{\r\nunsigned long long ticks = __core_reg_get(TXTIMER);\r\nreturn ticks << HARDWARE_TO_NS_SHIFT;\r\n}\r\nstatic void arch_timer_setup(unsigned int cpu)\r\n{\r\nunsigned int txdivtime;\r\nstruct clock_event_device *clk = &per_cpu(local_clockevent, cpu);\r\nchar *name = per_cpu(local_clockevent_name, cpu);\r\ntxdivtime = __core_reg_get(TXDIVTIME);\r\ntxdivtime &= ~TXDIVTIME_DIV_BITS;\r\ntxdivtime |= (HARDWARE_DIV & TXDIVTIME_DIV_BITS);\r\n__core_reg_set(TXDIVTIME, txdivtime);\r\nsprintf(name, "META %d", cpu);\r\nclk->name = name;\r\nclk->features = CLOCK_EVT_FEAT_ONESHOT,\r\nclk->rating = 200,\r\nclk->shift = 12,\r\nclk->irq = tbisig_map(TBID_SIGNUM_TRT),\r\nclk->set_mode = metag_timer_set_mode,\r\nclk->set_next_event = metag_timer_set_next_event,\r\nclk->mult = div_sc(hwtimer_freq, NSEC_PER_SEC, clk->shift);\r\nclk->max_delta_ns = clockevent_delta2ns(0x7fffffff, clk);\r\nclk->min_delta_ns = clockevent_delta2ns(0xf, clk);\r\nclk->cpumask = cpumask_of(cpu);\r\nclockevents_register_device(clk);\r\nif (cpu) {\r\nunsigned int thread0 = cpu_2_hwthread_id[0];\r\nunsigned long val;\r\nval = core_reg_read(TXUCT_ID, TXTIMER_REGNUM, thread0);\r\n__core_reg_set(TXTIMER, val);\r\n}\r\n}\r\nstatic int arch_timer_cpu_notify(struct notifier_block *self,\r\nunsigned long action, void *hcpu)\r\n{\r\nint cpu = (long)hcpu;\r\nswitch (action) {\r\ncase CPU_STARTING:\r\ncase CPU_STARTING_FROZEN:\r\narch_timer_setup(cpu);\r\nbreak;\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nint __init metag_generic_timer_init(void)\r\n{\r\n#ifdef CONFIG_METAG_META21\r\nhwtimer_freq = get_coreclock() / (metag_in32(EXPAND_TIMER_DIV) + 1);\r\n#endif\r\npr_info("Timer frequency: %u Hz\n", hwtimer_freq);\r\nclocksource_register_hz(&clocksource_metag, hwtimer_freq);\r\nsetup_irq(tbisig_map(TBID_SIGNUM_TRT), &metag_timer_irq);\r\narch_timer_setup(smp_processor_id());\r\nregister_cpu_notifier(&arch_timer_cpu_nb);\r\nreturn 0;\r\n}

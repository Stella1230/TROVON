static int ft1000ReadProc(struct seq_file *m, void *v)\r\n{\r\nstatic const char *status[] = {\r\n"Idle (Disconnect)", "Searching", "Active (Connected)",\r\n"Waiting for L2", "Sleep", "No Coverage", "", ""\r\n};\r\nstatic const char *signal[] = { "", "*", "**", "***", "****" };\r\nstruct net_device *dev = m->private;\r\nstruct ft1000_info *info = netdev_priv(dev);\r\nint i;\r\nint strength;\r\nint quality;\r\nstruct timeval tv;\r\ntime_t delta;\r\nif (info->AsicID == ELECTRABUZZ_ID) {\r\nif (info->ProgConStat != 0xFF) {\r\ninfo->LedStat =\r\nft1000_read_dpram(dev, FT1000_DSP_LED);\r\ninfo->ConStat =\r\nft1000_read_dpram(dev, FT1000_DSP_CON_STATE);\r\n} else {\r\ninfo->ConStat = 0xf;\r\n}\r\n} else {\r\nif (info->ProgConStat != 0xFF) {\r\ninfo->LedStat =\r\nntohs(ft1000_read_dpram_mag_16(\r\ndev, FT1000_MAG_DSP_LED,\r\nFT1000_MAG_DSP_LED_INDX));\r\ninfo->ConStat =\r\nntohs(ft1000_read_dpram_mag_16(\r\ndev, FT1000_MAG_DSP_CON_STATE,\r\nFT1000_MAG_DSP_CON_STATE_INDX));\r\n} else {\r\ninfo->ConStat = 0xf;\r\n}\r\n}\r\ni = (info->LedStat) & 0xf;\r\nswitch (i) {\r\ncase 0x1:\r\nstrength = 1;\r\nbreak;\r\ncase 0x3:\r\nstrength = 2;\r\nbreak;\r\ncase 0x7:\r\nstrength = 3;\r\nbreak;\r\ncase 0xf:\r\nstrength = 4;\r\nbreak;\r\ndefault:\r\nstrength = 0;\r\n}\r\ni = (info->LedStat >> 8) & 0xf;\r\nswitch (i) {\r\ncase 0x1:\r\nquality = 1;\r\nbreak;\r\ncase 0x3:\r\nquality = 2;\r\nbreak;\r\ncase 0x7:\r\nquality = 3;\r\nbreak;\r\ncase 0xf:\r\nquality = 4;\r\nbreak;\r\ndefault:\r\nquality = 0;\r\n}\r\ndo_gettimeofday(&tv);\r\ndelta = tv.tv_sec - info->ConTm;\r\nseq_printf(m, "Connection Time: %02ld:%02ld:%02ld\n",\r\n((delta / 3600) % 24), ((delta / 60) % 60), (delta % 60));\r\nseq_printf(m, "Connection Time[s]: %ld\n", delta);\r\nseq_printf(m, "Asic ID: %s\n",\r\ninfo->AsicID ==\r\nELECTRABUZZ_ID ? "ELECTRABUZZ ASIC" : "MAGNEMITE ASIC");\r\nseq_putx(m, "SKU: ", SKUSZ, info->Sku);\r\nseq_putx(m, "EUI64: ", EUISZ, info->eui64);\r\nseq_putd(m, "DSP version number: ", DSPVERSZ, info->DspVer);\r\nseq_putx(m, "Hardware Serial Number: ", HWSERNUMSZ, info->HwSerNum);\r\nseq_putx(m, "Caliberation Version: ", CALVERSZ, info->RfCalVer);\r\nseq_putd(m, "Caliberation Date: ", CALDATESZ, info->RfCalDate);\r\nseq_printf(m, "Media State: %s\n",\r\n(info->mediastate) ? "link" : "no link");\r\nseq_printf(m, "Connection Status: %s\n", status[info->ConStat & 0x7]);\r\nseq_printf(m, "RX packets: %ld\n", info->stats.rx_packets);\r\nseq_printf(m, "TX packets: %ld\n", info->stats.tx_packets);\r\nseq_printf(m, "RX bytes: %ld\n", info->stats.rx_bytes);\r\nseq_printf(m, "TX bytes: %ld\n", info->stats.tx_bytes);\r\nseq_printf(m, "Signal Strength: %s\n", signal[strength]);\r\nseq_printf(m, "Signal Quality: %s\n", signal[quality]);\r\nreturn 0;\r\n}\r\nstatic int ft1000_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ft1000ReadProc, PDE_DATA(inode));\r\n}\r\nstatic int ft1000NotifyProc(struct notifier_block *this, unsigned long event,\r\nvoid *ptr)\r\n{\r\nstruct net_device *dev = netdev_notifier_info_to_dev(ptr);\r\nstruct ft1000_info *info;\r\ninfo = netdev_priv(dev);\r\nswitch (event) {\r\ncase NETDEV_CHANGENAME:\r\nremove_proc_entry(info->netdevname, info->ft1000_proc_dir);\r\nproc_create_data(dev->name, 0644, info->ft1000_proc_dir,\r\n&ft1000_proc_fops, dev);\r\nsnprintf(info->netdevname, IFNAMSIZ, "%s", dev->name);\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nvoid ft1000InitProc(struct net_device *dev)\r\n{\r\nstruct ft1000_info *info;\r\ninfo = netdev_priv(dev);\r\ninfo->ft1000_proc_dir = proc_mkdir(FT1000_PROC, init_net.proc_net);\r\nproc_create_data(dev->name, 0644, info->ft1000_proc_dir,\r\n&ft1000_proc_fops, dev);\r\nsnprintf(info->netdevname, IFNAMSIZ, "%s", dev->name);\r\nregister_netdevice_notifier(&ft1000_netdev_notifier);\r\n}\r\nvoid ft1000CleanupProc(struct net_device *dev)\r\n{\r\nstruct ft1000_info *info;\r\ninfo = netdev_priv(dev);\r\nremove_proc_entry(dev->name, info->ft1000_proc_dir);\r\nremove_proc_entry(FT1000_PROC, init_net.proc_net);\r\nunregister_netdevice_notifier(&ft1000_netdev_notifier);\r\n}

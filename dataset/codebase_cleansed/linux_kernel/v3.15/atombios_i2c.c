static int radeon_process_i2c_ch(struct radeon_i2c_chan *chan,\r\nu8 slave_addr, u8 flags,\r\nu8 *buf, u8 num)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nPROCESS_I2C_CHANNEL_TRANSACTION_PS_ALLOCATION args;\r\nint index = GetIndexIntoMasterTable(COMMAND, ProcessI2cChannelTransaction);\r\nunsigned char *base;\r\nu16 out = cpu_to_le16(0);\r\nmemset(&args, 0, sizeof(args));\r\nbase = (unsigned char *)rdev->mode_info.atom_context->scratch;\r\nif (flags & HW_I2C_WRITE) {\r\nif (num > ATOM_MAX_HW_I2C_WRITE) {\r\nDRM_ERROR("hw i2c: tried to write too many bytes (%d vs 3)\n", num);\r\nreturn -EINVAL;\r\n}\r\nif (buf == NULL)\r\nargs.ucRegIndex = 0;\r\nelse\r\nargs.ucRegIndex = buf[0];\r\nif (num)\r\nnum--;\r\nif (num)\r\nmemcpy(&out, &buf[1], num);\r\nargs.lpI2CDataOut = cpu_to_le16(out);\r\n} else {\r\nif (num > ATOM_MAX_HW_I2C_READ) {\r\nDRM_ERROR("hw i2c: tried to read too many bytes (%d vs 255)\n", num);\r\nreturn -EINVAL;\r\n}\r\nargs.ucRegIndex = 0;\r\nargs.lpI2CDataOut = 0;\r\n}\r\nargs.ucFlag = flags;\r\nargs.ucI2CSpeed = TARGET_HW_I2C_CLOCK;\r\nargs.ucTransBytes = num;\r\nargs.ucSlaveAddr = slave_addr << 1;\r\nargs.ucLineNumber = chan->rec.i2c_id;\r\natom_execute_table(rdev->mode_info.atom_context, index, (uint32_t *)&args);\r\nif (args.ucStatus != HW_ASSISTED_I2C_STATUS_SUCCESS) {\r\nDRM_DEBUG_KMS("hw_i2c error\n");\r\nreturn -EIO;\r\n}\r\nif (!(flags & HW_I2C_WRITE))\r\nradeon_atom_copy_swap(buf, base, num, false);\r\nreturn 0;\r\n}\r\nint radeon_atom_hw_i2c_xfer(struct i2c_adapter *i2c_adap,\r\nstruct i2c_msg *msgs, int num)\r\n{\r\nstruct radeon_i2c_chan *i2c = i2c_get_adapdata(i2c_adap);\r\nstruct i2c_msg *p;\r\nint i, remaining, current_count, buffer_offset, max_bytes, ret;\r\nu8 flags;\r\np = &msgs[0];\r\nif ((num == 1) && (p->len == 0)) {\r\nret = radeon_process_i2c_ch(i2c,\r\np->addr, HW_I2C_WRITE,\r\nNULL, 0);\r\nif (ret)\r\nreturn ret;\r\nelse\r\nreturn num;\r\n}\r\nfor (i = 0; i < num; i++) {\r\np = &msgs[i];\r\nremaining = p->len;\r\nbuffer_offset = 0;\r\nif (p->flags & I2C_M_RD) {\r\nmax_bytes = ATOM_MAX_HW_I2C_READ;\r\nflags = HW_I2C_READ;\r\n} else {\r\nmax_bytes = ATOM_MAX_HW_I2C_WRITE;\r\nflags = HW_I2C_WRITE;\r\n}\r\nwhile (remaining) {\r\nif (remaining > max_bytes)\r\ncurrent_count = max_bytes;\r\nelse\r\ncurrent_count = remaining;\r\nret = radeon_process_i2c_ch(i2c,\r\np->addr, flags,\r\n&p->buf[buffer_offset], current_count);\r\nif (ret)\r\nreturn ret;\r\nremaining -= current_count;\r\nbuffer_offset += current_count;\r\n}\r\n}\r\nreturn num;\r\n}\r\nu32 radeon_atom_hw_i2c_func(struct i2c_adapter *adap)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL;\r\n}

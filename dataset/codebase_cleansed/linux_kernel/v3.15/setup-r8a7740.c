void __init r8a7740_map_io(void)\r\n{\r\niotable_init(r8a7740_io_desc, ARRAY_SIZE(r8a7740_io_desc));\r\n}\r\nvoid __init r8a7740_pinmux_init(void)\r\n{\r\nplatform_device_register_simple("pfc-r8a7740", -1, pfc_resources,\r\nARRAY_SIZE(pfc_resources));\r\n}\r\nvoid r8a7740_meram_workaround(void)\r\n{\r\nvoid __iomem *reg;\r\nreg = ioremap_nocache(MEBUFCNTR, 4);\r\nif (reg) {\r\niowrite32(0x01600164, reg);\r\niounmap(reg);\r\n}\r\n}\r\nstatic void r8a7740_i2c_workaround(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nvoid __iomem *reg;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (unlikely(!res)) {\r\npr_err("r8a7740 i2c workaround fail (cannot find resource)\n");\r\nreturn;\r\n}\r\nreg = ioremap(res->start, resource_size(res));\r\nif (unlikely(!reg)) {\r\npr_err("r8a7740 i2c workaround fail (cannot map IO)\n");\r\nreturn;\r\n}\r\ni2c_write(reg, ICCR, i2c_read(reg, ICCR) | 0x80);\r\ni2c_read(reg, ICCR);\r\ni2c_write(reg, ICSTART, i2c_read(reg, ICSTART) | 0x10);\r\ni2c_read(reg, ICSTART);\r\nudelay(10);\r\ni2c_write(reg, ICCR, 0x01);\r\ni2c_write(reg, ICSTART, 0x00);\r\nudelay(10);\r\ni2c_write(reg, ICCR, 0x10);\r\nudelay(10);\r\ni2c_write(reg, ICCR, 0x00);\r\nudelay(10);\r\ni2c_write(reg, ICCR, 0x10);\r\nudelay(10);\r\niounmap(reg);\r\n}\r\nvoid __init r8a7740_add_standard_devices(void)\r\n{\r\nr8a7740_i2c_workaround(&i2c0_device);\r\nr8a7740_i2c_workaround(&i2c1_device);\r\nr8a7740_init_pm_domains();\r\nplatform_add_devices(r8a7740_early_devices,\r\nARRAY_SIZE(r8a7740_early_devices));\r\nplatform_add_devices(r8a7740_devices_dt,\r\nARRAY_SIZE(r8a7740_devices_dt));\r\nplatform_add_devices(r8a7740_late_devices,\r\nARRAY_SIZE(r8a7740_late_devices));\r\nrmobile_add_device_to_domain("A3SP", &scif0_device);\r\nrmobile_add_device_to_domain("A3SP", &scif1_device);\r\nrmobile_add_device_to_domain("A3SP", &scif2_device);\r\nrmobile_add_device_to_domain("A3SP", &scif3_device);\r\nrmobile_add_device_to_domain("A3SP", &scif4_device);\r\nrmobile_add_device_to_domain("A3SP", &scif5_device);\r\nrmobile_add_device_to_domain("A3SP", &scif6_device);\r\nrmobile_add_device_to_domain("A3SP", &scif7_device);\r\nrmobile_add_device_to_domain("A3SP", &scif8_device);\r\nrmobile_add_device_to_domain("A3SP", &i2c1_device);\r\n}\r\nvoid __init r8a7740_add_early_devices(void)\r\n{\r\nearly_platform_add_devices(r8a7740_early_devices,\r\nARRAY_SIZE(r8a7740_early_devices));\r\nearly_platform_add_devices(r8a7740_devices_dt,\r\nARRAY_SIZE(r8a7740_devices_dt));\r\nshmobile_setup_console();\r\n}\r\nvoid __init r8a7740_add_early_devices_dt(void)\r\n{\r\nshmobile_setup_delay(800, 1, 3);\r\nearly_platform_add_devices(r8a7740_early_devices,\r\nARRAY_SIZE(r8a7740_early_devices));\r\nshmobile_setup_console();\r\n}\r\nvoid __init r8a7740_add_standard_devices_dt(void)\r\n{\r\nplatform_add_devices(r8a7740_devices_dt,\r\nARRAY_SIZE(r8a7740_devices_dt));\r\nof_platform_populate(NULL, of_default_bus_match_table, NULL, NULL);\r\n}\r\nvoid __init r8a7740_init_delay(void)\r\n{\r\nshmobile_setup_delay(800, 1, 3);\r\n}\r\nvoid __init r8a7740_init_irq_of(void)\r\n{\r\nvoid __iomem *intc_prio_base = ioremap_nocache(0xe6900010, 0x10);\r\nvoid __iomem *intc_msk_base = ioremap_nocache(0xe6900040, 0x10);\r\nvoid __iomem *pfc_inta_ctrl = ioremap_nocache(0xe605807c, 0x4);\r\nirqchip_init();\r\niowrite32(0x0, pfc_inta_ctrl);\r\niowrite32(0x0, intc_prio_base + 0x0);\r\niowrite32(0x0, intc_prio_base + 0x4);\r\niowrite32(0x0, intc_prio_base + 0x8);\r\niowrite32(0x0, intc_prio_base + 0xc);\r\niowrite8(0xff, intc_msk_base + 0x0);\r\niowrite8(0xff, intc_msk_base + 0x4);\r\niowrite8(0xff, intc_msk_base + 0x8);\r\niowrite8(0xff, intc_msk_base + 0xc);\r\niounmap(intc_prio_base);\r\niounmap(intc_msk_base);\r\niounmap(pfc_inta_ctrl);\r\n}\r\nstatic void __init r8a7740_generic_init(void)\r\n{\r\nr8a7740_clock_init(0);\r\nr8a7740_add_standard_devices_dt();\r\n}

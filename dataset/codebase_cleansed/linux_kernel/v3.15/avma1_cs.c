static int avma1cs_probe(struct pcmcia_device *p_dev)\r\n{\r\ndev_dbg(&p_dev->dev, "avma1cs_attach()\n");\r\np_dev->config_flags |= CONF_ENABLE_IRQ | CONF_AUTO_SET_IO;\r\np_dev->config_index = 1;\r\np_dev->config_regs = PRESENT_OPTION;\r\nreturn avma1cs_config(p_dev);\r\n}\r\nstatic void avma1cs_detach(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "avma1cs_detach(0x%p)\n", link);\r\navma1cs_release(link);\r\nkfree(link->priv);\r\n}\r\nstatic int avma1cs_configcheck(struct pcmcia_device *p_dev, void *priv_data)\r\n{\r\np_dev->resource[0]->end = 16;\r\np_dev->resource[0]->flags &= ~IO_DATA_PATH_WIDTH;\r\np_dev->resource[0]->flags |= IO_DATA_PATH_WIDTH_8;\r\np_dev->io_lines = 5;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic int avma1cs_config(struct pcmcia_device *link)\r\n{\r\nint i = -1;\r\nchar devname[128];\r\nIsdnCard_t icard;\r\nint busy = 0;\r\ndev_dbg(&link->dev, "avma1cs_config(0x%p)\n", link);\r\ndevname[0] = 0;\r\nif (link->prod_id[1])\r\nstrlcpy(devname, link->prod_id[1], sizeof(devname));\r\nif (pcmcia_loop_config(link, avma1cs_configcheck, NULL))\r\nreturn -ENODEV;\r\ndo {\r\nif (!link->irq) {\r\npcmcia_disable_device(link);\r\nbreak;\r\n}\r\ni = pcmcia_enable_device(link);\r\nif (i != 0) {\r\npcmcia_disable_device(link);\r\nbreak;\r\n}\r\n} while (0);\r\nif (i != 0) {\r\navma1cs_release(link);\r\nreturn -ENODEV;\r\n}\r\nicard.para[0] = link->irq;\r\nicard.para[1] = link->resource[0]->start;\r\nicard.protocol = isdnprot;\r\nicard.typ = ISDN_CTYPE_A1_PCMCIA;\r\ni = hisax_init_pcmcia(link, &busy, &icard);\r\nif (i < 0) {\r\nprintk(KERN_ERR "avma1_cs: failed to initialize AVM A1 "\r\n"PCMCIA %d at i/o %#x\n", i,\r\n(unsigned int) link->resource[0]->start);\r\navma1cs_release(link);\r\nreturn -ENODEV;\r\n}\r\nlink->priv = (void *) (unsigned long) i;\r\nreturn 0;\r\n}\r\nstatic void avma1cs_release(struct pcmcia_device *link)\r\n{\r\nunsigned long minor = (unsigned long) link->priv;\r\ndev_dbg(&link->dev, "avma1cs_release(0x%p)\n", link);\r\nHiSax_closecard(minor);\r\npcmcia_disable_device(link);\r\n}

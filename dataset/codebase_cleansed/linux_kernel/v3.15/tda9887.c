static void dump_read_message(struct dvb_frontend *fe, unsigned char *buf)\r\n{\r\nstruct tda9887_priv *priv = fe->analog_demod_priv;\r\nstatic char *afc[16] = {\r\n"- 12.5 kHz",\r\n"- 37.5 kHz",\r\n"- 62.5 kHz",\r\n"- 87.5 kHz",\r\n"-112.5 kHz",\r\n"-137.5 kHz",\r\n"-162.5 kHz",\r\n"-187.5 kHz [min]",\r\n"+187.5 kHz [max]",\r\n"+162.5 kHz",\r\n"+137.5 kHz",\r\n"+112.5 kHz",\r\n"+ 87.5 kHz",\r\n"+ 62.5 kHz",\r\n"+ 37.5 kHz",\r\n"+ 12.5 kHz",\r\n};\r\ntuner_info("read: 0x%2x\n", buf[0]);\r\ntuner_info(" after power on : %s\n", (buf[0] & 0x01) ? "yes" : "no");\r\ntuner_info(" afc : %s\n", afc[(buf[0] >> 1) & 0x0f]);\r\ntuner_info(" fmif level : %s\n", (buf[0] & 0x20) ? "high" : "low");\r\ntuner_info(" afc window : %s\n", (buf[0] & 0x40) ? "in" : "out");\r\ntuner_info(" vfi level : %s\n", (buf[0] & 0x80) ? "high" : "low");\r\n}\r\nstatic void dump_write_message(struct dvb_frontend *fe, unsigned char *buf)\r\n{\r\nstruct tda9887_priv *priv = fe->analog_demod_priv;\r\nstatic char *sound[4] = {\r\n"AM/TV",\r\n"FM/radio",\r\n"FM/TV",\r\n"FM/radio"\r\n};\r\nstatic char *adjust[32] = {\r\n"-16", "-15", "-14", "-13", "-12", "-11", "-10", "-9",\r\n"-8", "-7", "-6", "-5", "-4", "-3", "-2", "-1",\r\n"0", "+1", "+2", "+3", "+4", "+5", "+6", "+7",\r\n"+8", "+9", "+10", "+11", "+12", "+13", "+14", "+15"\r\n};\r\nstatic char *deemph[4] = {\r\n"no", "no", "75", "50"\r\n};\r\nstatic char *carrier[4] = {\r\n"4.5 MHz",\r\n"5.5 MHz",\r\n"6.0 MHz",\r\n"6.5 MHz / AM"\r\n};\r\nstatic char *vif[8] = {\r\n"58.75 MHz",\r\n"45.75 MHz",\r\n"38.9 MHz",\r\n"38.0 MHz",\r\n"33.9 MHz",\r\n"33.4 MHz",\r\n"45.75 MHz + pin13",\r\n"38.9 MHz + pin13",\r\n};\r\nstatic char *rif[4] = {\r\n"44 MHz",\r\n"52 MHz",\r\n"52 MHz",\r\n"44 MHz",\r\n};\r\ntuner_info("write: byte B 0x%02x\n", buf[1]);\r\ntuner_info(" B0 video mode : %s\n",\r\n(buf[1] & 0x01) ? "video trap" : "sound trap");\r\ntuner_info(" B1 auto mute fm : %s\n",\r\n(buf[1] & 0x02) ? "yes" : "no");\r\ntuner_info(" B2 carrier mode : %s\n",\r\n(buf[1] & 0x04) ? "QSS" : "Intercarrier");\r\ntuner_info(" B3-4 tv sound/radio : %s\n",\r\nsound[(buf[1] & 0x18) >> 3]);\r\ntuner_info(" B5 force mute audio: %s\n",\r\n(buf[1] & 0x20) ? "yes" : "no");\r\ntuner_info(" B6 output port 1 : %s\n",\r\n(buf[1] & 0x40) ? "high (inactive)" : "low (active)");\r\ntuner_info(" B7 output port 2 : %s\n",\r\n(buf[1] & 0x80) ? "high (inactive)" : "low (active)");\r\ntuner_info("write: byte C 0x%02x\n", buf[2]);\r\ntuner_info(" C0-4 top adjustment : %s dB\n",\r\nadjust[buf[2] & 0x1f]);\r\ntuner_info(" C5-6 de-emphasis : %s\n",\r\ndeemph[(buf[2] & 0x60) >> 5]);\r\ntuner_info(" C7 audio gain : %s\n",\r\n(buf[2] & 0x80) ? "-6" : "0");\r\ntuner_info("write: byte E 0x%02x\n", buf[3]);\r\ntuner_info(" E0-1 sound carrier : %s\n",\r\ncarrier[(buf[3] & 0x03)]);\r\ntuner_info(" E6 l pll gating : %s\n",\r\n(buf[3] & 0x40) ? "36" : "13");\r\nif (buf[1] & 0x08) {\r\ntuner_info(" E2-4 video if : %s\n",\r\nrif[(buf[3] & 0x0c) >> 2]);\r\ntuner_info(" E7 vif agc output : %s\n",\r\n(buf[3] & 0x80)\r\n? ((buf[3] & 0x10) ? "fm-agc radio" :\r\n"sif-agc radio")\r\n: "fm radio carrier afc");\r\n} else {\r\ntuner_info(" E2-4 video if : %s\n",\r\nvif[(buf[3] & 0x1c) >> 2]);\r\ntuner_info(" E5 tuner gain : %s\n",\r\n(buf[3] & 0x80)\r\n? ((buf[3] & 0x20) ? "external" : "normal")\r\n: ((buf[3] & 0x20) ? "minimum" : "normal"));\r\ntuner_info(" E7 vif agc output : %s\n",\r\n(buf[3] & 0x80) ? ((buf[3] & 0x20)\r\n? "pin3 port, pin22 vif agc out"\r\n: "pin22 port, pin3 vif acg ext in")\r\n: "pin3+pin22 port");\r\n}\r\ntuner_info("--\n");\r\n}\r\nstatic int tda9887_set_tvnorm(struct dvb_frontend *fe)\r\n{\r\nstruct tda9887_priv *priv = fe->analog_demod_priv;\r\nstruct tvnorm *norm = NULL;\r\nchar *buf = priv->data;\r\nint i;\r\nif (priv->mode == V4L2_TUNER_RADIO) {\r\nif (priv->audmode == V4L2_TUNER_MODE_MONO)\r\nnorm = &radio_mono;\r\nelse\r\nnorm = &radio_stereo;\r\n} else {\r\nfor (i = 0; i < ARRAY_SIZE(tvnorms); i++) {\r\nif (tvnorms[i].std & priv->std) {\r\nnorm = tvnorms+i;\r\nbreak;\r\n}\r\n}\r\n}\r\nif (NULL == norm) {\r\ntuner_dbg("Unsupported tvnorm entry - audio muted\n");\r\nreturn -1;\r\n}\r\ntuner_dbg("configure for: %s\n", norm->name);\r\nbuf[1] = norm->b;\r\nbuf[2] = norm->c;\r\nbuf[3] = norm->e;\r\nreturn 0;\r\n}\r\nstatic int tda9887_set_insmod(struct dvb_frontend *fe)\r\n{\r\nstruct tda9887_priv *priv = fe->analog_demod_priv;\r\nchar *buf = priv->data;\r\nif (UNSET != port1) {\r\nif (port1)\r\nbuf[1] |= cOutputPort1Inactive;\r\nelse\r\nbuf[1] &= ~cOutputPort1Inactive;\r\n}\r\nif (UNSET != port2) {\r\nif (port2)\r\nbuf[1] |= cOutputPort2Inactive;\r\nelse\r\nbuf[1] &= ~cOutputPort2Inactive;\r\n}\r\nif (UNSET != qss) {\r\nif (qss)\r\nbuf[1] |= cQSS;\r\nelse\r\nbuf[1] &= ~cQSS;\r\n}\r\nif (adjust < 0x20) {\r\nbuf[2] &= ~cTopMask;\r\nbuf[2] |= adjust;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tda9887_do_config(struct dvb_frontend *fe)\r\n{\r\nstruct tda9887_priv *priv = fe->analog_demod_priv;\r\nchar *buf = priv->data;\r\nif (priv->config & TDA9887_PORT1_ACTIVE)\r\nbuf[1] &= ~cOutputPort1Inactive;\r\nif (priv->config & TDA9887_PORT1_INACTIVE)\r\nbuf[1] |= cOutputPort1Inactive;\r\nif (priv->config & TDA9887_PORT2_ACTIVE)\r\nbuf[1] &= ~cOutputPort2Inactive;\r\nif (priv->config & TDA9887_PORT2_INACTIVE)\r\nbuf[1] |= cOutputPort2Inactive;\r\nif (priv->config & TDA9887_QSS)\r\nbuf[1] |= cQSS;\r\nif (priv->config & TDA9887_INTERCARRIER)\r\nbuf[1] &= ~cQSS;\r\nif (priv->config & TDA9887_AUTOMUTE)\r\nbuf[1] |= cAutoMuteFmActive;\r\nif (priv->config & TDA9887_DEEMPHASIS_MASK) {\r\nbuf[2] &= ~0x60;\r\nswitch (priv->config & TDA9887_DEEMPHASIS_MASK) {\r\ncase TDA9887_DEEMPHASIS_NONE:\r\nbuf[2] |= cDeemphasisOFF;\r\nbreak;\r\ncase TDA9887_DEEMPHASIS_50:\r\nbuf[2] |= cDeemphasisON | cDeemphasis50;\r\nbreak;\r\ncase TDA9887_DEEMPHASIS_75:\r\nbuf[2] |= cDeemphasisON | cDeemphasis75;\r\nbreak;\r\n}\r\n}\r\nif (priv->config & TDA9887_TOP_SET) {\r\nbuf[2] &= ~cTopMask;\r\nbuf[2] |= (priv->config >> 8) & cTopMask;\r\n}\r\nif ((priv->config & TDA9887_INTERCARRIER_NTSC) &&\r\n(priv->std & V4L2_STD_NTSC))\r\nbuf[1] &= ~cQSS;\r\nif (priv->config & TDA9887_GATING_18)\r\nbuf[3] &= ~cGating_36;\r\nif (priv->mode == V4L2_TUNER_RADIO) {\r\nif (priv->config & TDA9887_RIF_41_3) {\r\nbuf[3] &= ~cVideoIFMask;\r\nbuf[3] |= cRadioIF_41_30;\r\n}\r\nif (priv->config & TDA9887_GAIN_NORMAL)\r\nbuf[3] &= ~cTunerGainLow;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tda9887_status(struct dvb_frontend *fe)\r\n{\r\nstruct tda9887_priv *priv = fe->analog_demod_priv;\r\nunsigned char buf[1];\r\nint rc;\r\nrc = tuner_i2c_xfer_recv(&priv->i2c_props, buf, 1);\r\nif (rc != 1)\r\ntuner_info("i2c i/o error: rc == %d (should be 1)\n", rc);\r\ndump_read_message(fe, buf);\r\nreturn 0;\r\n}\r\nstatic void tda9887_configure(struct dvb_frontend *fe)\r\n{\r\nstruct tda9887_priv *priv = fe->analog_demod_priv;\r\nint rc;\r\nmemset(priv->data,0,sizeof(priv->data));\r\ntda9887_set_tvnorm(fe);\r\npriv->data[1] |= cOutputPort1Inactive;\r\npriv->data[1] |= cOutputPort2Inactive;\r\ntda9887_do_config(fe);\r\ntda9887_set_insmod(fe);\r\nif (priv->standby)\r\npriv->data[1] |= cForcedMuteAudioON;\r\ntuner_dbg("writing: b=0x%02x c=0x%02x e=0x%02x\n",\r\npriv->data[1], priv->data[2], priv->data[3]);\r\nif (debug > 1)\r\ndump_write_message(fe, priv->data);\r\nif (4 != (rc = tuner_i2c_xfer_send(&priv->i2c_props,priv->data,4)))\r\ntuner_info("i2c i/o error: rc == %d (should be 4)\n", rc);\r\nif (debug > 2) {\r\nmsleep_interruptible(1000);\r\ntda9887_status(fe);\r\n}\r\n}\r\nstatic void tda9887_tuner_status(struct dvb_frontend *fe)\r\n{\r\nstruct tda9887_priv *priv = fe->analog_demod_priv;\r\ntuner_info("Data bytes: b=0x%02x c=0x%02x e=0x%02x\n",\r\npriv->data[1], priv->data[2], priv->data[3]);\r\n}\r\nstatic int tda9887_get_afc(struct dvb_frontend *fe, s32 *afc)\r\n{\r\nstruct tda9887_priv *priv = fe->analog_demod_priv;\r\nstatic const int AFC_BITS_2_kHz[] = {\r\n-12500, -37500, -62500, -97500,\r\n-112500, -137500, -162500, -187500,\r\n187500, 162500, 137500, 112500,\r\n97500 , 62500, 37500 , 12500\r\n};\r\n__u8 reg = 0;\r\nif (priv->mode != V4L2_TUNER_RADIO)\r\nreturn 0;\r\nif (1 == tuner_i2c_xfer_recv(&priv->i2c_props, &reg, 1))\r\n*afc = AFC_BITS_2_kHz[(reg >> 1) & 0x0f];\r\nreturn 0;\r\n}\r\nstatic void tda9887_standby(struct dvb_frontend *fe)\r\n{\r\nstruct tda9887_priv *priv = fe->analog_demod_priv;\r\npriv->standby = true;\r\ntda9887_configure(fe);\r\n}\r\nstatic void tda9887_set_params(struct dvb_frontend *fe,\r\nstruct analog_parameters *params)\r\n{\r\nstruct tda9887_priv *priv = fe->analog_demod_priv;\r\npriv->standby = false;\r\npriv->mode = params->mode;\r\npriv->audmode = params->audmode;\r\npriv->std = params->std;\r\ntda9887_configure(fe);\r\n}\r\nstatic int tda9887_set_config(struct dvb_frontend *fe, void *priv_cfg)\r\n{\r\nstruct tda9887_priv *priv = fe->analog_demod_priv;\r\npriv->config = *(unsigned int *)priv_cfg;\r\ntda9887_configure(fe);\r\nreturn 0;\r\n}\r\nstatic void tda9887_release(struct dvb_frontend *fe)\r\n{\r\nstruct tda9887_priv *priv = fe->analog_demod_priv;\r\nmutex_lock(&tda9887_list_mutex);\r\nif (priv)\r\nhybrid_tuner_release_state(priv);\r\nmutex_unlock(&tda9887_list_mutex);\r\nfe->analog_demod_priv = NULL;\r\n}\r\nstruct dvb_frontend *tda9887_attach(struct dvb_frontend *fe,\r\nstruct i2c_adapter *i2c_adap,\r\nu8 i2c_addr)\r\n{\r\nstruct tda9887_priv *priv = NULL;\r\nint instance;\r\nmutex_lock(&tda9887_list_mutex);\r\ninstance = hybrid_tuner_request_state(struct tda9887_priv, priv,\r\nhybrid_tuner_instance_list,\r\ni2c_adap, i2c_addr, "tda9887");\r\nswitch (instance) {\r\ncase 0:\r\nmutex_unlock(&tda9887_list_mutex);\r\nreturn NULL;\r\ncase 1:\r\nfe->analog_demod_priv = priv;\r\npriv->standby = true;\r\ntuner_info("tda988[5/6/7] found\n");\r\nbreak;\r\ndefault:\r\nfe->analog_demod_priv = priv;\r\nbreak;\r\n}\r\nmutex_unlock(&tda9887_list_mutex);\r\nmemcpy(&fe->ops.analog_ops, &tda9887_ops,\r\nsizeof(struct analog_demod_ops));\r\nreturn fe;\r\n}

static int snd_gf1_timer1_start(struct snd_timer * timer)\r\n{\r\nunsigned long flags;\r\nunsigned char tmp;\r\nunsigned int ticks;\r\nstruct snd_gus_card *gus;\r\ngus = snd_timer_chip(timer);\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\nticks = timer->sticks;\r\ntmp = (gus->gf1.timer_enabled |= 4);\r\nsnd_gf1_write8(gus, SNDRV_GF1_GB_ADLIB_TIMER_1, 256 - ticks);\r\nsnd_gf1_write8(gus, SNDRV_GF1_GB_SOUND_BLASTER_CONTROL, tmp);\r\nsnd_gf1_adlib_write(gus, 0x04, tmp >> 2);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int snd_gf1_timer1_stop(struct snd_timer * timer)\r\n{\r\nunsigned long flags;\r\nunsigned char tmp;\r\nstruct snd_gus_card *gus;\r\ngus = snd_timer_chip(timer);\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\ntmp = (gus->gf1.timer_enabled &= ~4);\r\nsnd_gf1_write8(gus, SNDRV_GF1_GB_SOUND_BLASTER_CONTROL, tmp);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int snd_gf1_timer2_start(struct snd_timer * timer)\r\n{\r\nunsigned long flags;\r\nunsigned char tmp;\r\nunsigned int ticks;\r\nstruct snd_gus_card *gus;\r\ngus = snd_timer_chip(timer);\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\nticks = timer->sticks;\r\ntmp = (gus->gf1.timer_enabled |= 8);\r\nsnd_gf1_write8(gus, SNDRV_GF1_GB_ADLIB_TIMER_2, 256 - ticks);\r\nsnd_gf1_write8(gus, SNDRV_GF1_GB_SOUND_BLASTER_CONTROL, tmp);\r\nsnd_gf1_adlib_write(gus, 0x04, tmp >> 2);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int snd_gf1_timer2_stop(struct snd_timer * timer)\r\n{\r\nunsigned long flags;\r\nunsigned char tmp;\r\nstruct snd_gus_card *gus;\r\ngus = snd_timer_chip(timer);\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\ntmp = (gus->gf1.timer_enabled &= ~8);\r\nsnd_gf1_write8(gus, SNDRV_GF1_GB_SOUND_BLASTER_CONTROL, tmp);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\nreturn 0;\r\n}\r\nstatic void snd_gf1_interrupt_timer1(struct snd_gus_card * gus)\r\n{\r\nstruct snd_timer *timer = gus->gf1.timer1;\r\nif (timer == NULL)\r\nreturn;\r\nsnd_timer_interrupt(timer, timer->sticks);\r\n}\r\nstatic void snd_gf1_interrupt_timer2(struct snd_gus_card * gus)\r\n{\r\nstruct snd_timer *timer = gus->gf1.timer2;\r\nif (timer == NULL)\r\nreturn;\r\nsnd_timer_interrupt(timer, timer->sticks);\r\n}\r\nstatic void snd_gf1_timer1_free(struct snd_timer *timer)\r\n{\r\nstruct snd_gus_card *gus = timer->private_data;\r\ngus->gf1.timer1 = NULL;\r\n}\r\nstatic void snd_gf1_timer2_free(struct snd_timer *timer)\r\n{\r\nstruct snd_gus_card *gus = timer->private_data;\r\ngus->gf1.timer2 = NULL;\r\n}\r\nvoid snd_gf1_timers_init(struct snd_gus_card * gus)\r\n{\r\nstruct snd_timer *timer;\r\nstruct snd_timer_id tid;\r\nif (gus->gf1.timer1 != NULL || gus->gf1.timer2 != NULL)\r\nreturn;\r\ngus->gf1.interrupt_handler_timer1 = snd_gf1_interrupt_timer1;\r\ngus->gf1.interrupt_handler_timer2 = snd_gf1_interrupt_timer2;\r\ntid.dev_class = SNDRV_TIMER_CLASS_CARD;\r\ntid.dev_sclass = SNDRV_TIMER_SCLASS_NONE;\r\ntid.card = gus->card->number;\r\ntid.device = gus->timer_dev;\r\ntid.subdevice = 0;\r\nif (snd_timer_new(gus->card, "GF1 timer", &tid, &timer) >= 0) {\r\nstrcpy(timer->name, "GF1 timer #1");\r\ntimer->private_data = gus;\r\ntimer->private_free = snd_gf1_timer1_free;\r\ntimer->hw = snd_gf1_timer1;\r\n}\r\ngus->gf1.timer1 = timer;\r\ntid.device++;\r\nif (snd_timer_new(gus->card, "GF1 timer", &tid, &timer) >= 0) {\r\nstrcpy(timer->name, "GF1 timer #2");\r\ntimer->private_data = gus;\r\ntimer->private_free = snd_gf1_timer2_free;\r\ntimer->hw = snd_gf1_timer2;\r\n}\r\ngus->gf1.timer2 = timer;\r\n}\r\nvoid snd_gf1_timers_done(struct snd_gus_card * gus)\r\n{\r\nsnd_gf1_set_default_handlers(gus, SNDRV_GF1_HANDLER_TIMER1 | SNDRV_GF1_HANDLER_TIMER2);\r\nif (gus->gf1.timer1) {\r\nsnd_device_free(gus->card, gus->gf1.timer1);\r\ngus->gf1.timer1 = NULL;\r\n}\r\nif (gus->gf1.timer2) {\r\nsnd_device_free(gus->card, gus->gf1.timer2);\r\ngus->gf1.timer2 = NULL;\r\n}\r\n}

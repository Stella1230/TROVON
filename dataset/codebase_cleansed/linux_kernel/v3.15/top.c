size_t perf_top__header_snprintf(struct perf_top *top, char *bf, size_t size)\r\n{\r\nfloat samples_per_sec;\r\nfloat ksamples_per_sec;\r\nfloat esamples_percent;\r\nstruct record_opts *opts = &top->record_opts;\r\nstruct target *target = &opts->target;\r\nsize_t ret = 0;\r\nif (top->samples) {\r\nsamples_per_sec = top->samples / top->delay_secs;\r\nksamples_per_sec = top->kernel_samples / top->delay_secs;\r\nesamples_percent = (100.0 * top->exact_samples) / top->samples;\r\n} else {\r\nsamples_per_sec = ksamples_per_sec = esamples_percent = 0.0;\r\n}\r\nif (!perf_guest) {\r\nfloat ksamples_percent = 0.0;\r\nif (samples_per_sec)\r\nksamples_percent = (100.0 * ksamples_per_sec) /\r\nsamples_per_sec;\r\nret = SNPRINTF(bf, size,\r\n" PerfTop:%8.0f irqs/sec kernel:%4.1f%%"\r\n" exact: %4.1f%% [", samples_per_sec,\r\nksamples_percent, esamples_percent);\r\n} else {\r\nfloat us_samples_per_sec = top->us_samples / top->delay_secs;\r\nfloat guest_kernel_samples_per_sec = top->guest_kernel_samples / top->delay_secs;\r\nfloat guest_us_samples_per_sec = top->guest_us_samples / top->delay_secs;\r\nret = SNPRINTF(bf, size,\r\n" PerfTop:%8.0f irqs/sec kernel:%4.1f%% us:%4.1f%%"\r\n" guest kernel:%4.1f%% guest us:%4.1f%%"\r\n" exact: %4.1f%% [", samples_per_sec,\r\n100.0 - (100.0 * ((samples_per_sec - ksamples_per_sec) /\r\nsamples_per_sec)),\r\n100.0 - (100.0 * ((samples_per_sec - us_samples_per_sec) /\r\nsamples_per_sec)),\r\n100.0 - (100.0 * ((samples_per_sec -\r\nguest_kernel_samples_per_sec) /\r\nsamples_per_sec)),\r\n100.0 - (100.0 * ((samples_per_sec -\r\nguest_us_samples_per_sec) /\r\nsamples_per_sec)),\r\nesamples_percent);\r\n}\r\nif (top->evlist->nr_entries == 1) {\r\nstruct perf_evsel *first = perf_evlist__first(top->evlist);\r\nret += SNPRINTF(bf + ret, size - ret, "%" PRIu64 "%s ",\r\n(uint64_t)first->attr.sample_period,\r\nopts->freq ? "Hz" : "");\r\n}\r\nret += SNPRINTF(bf + ret, size - ret, "%s", perf_evsel__name(top->sym_evsel));\r\nret += SNPRINTF(bf + ret, size - ret, "], ");\r\nif (target->pid)\r\nret += SNPRINTF(bf + ret, size - ret, " (target_pid: %s",\r\ntarget->pid);\r\nelse if (target->tid)\r\nret += SNPRINTF(bf + ret, size - ret, " (target_tid: %s",\r\ntarget->tid);\r\nelse if (target->uid_str != NULL)\r\nret += SNPRINTF(bf + ret, size - ret, " (uid: %s",\r\ntarget->uid_str);\r\nelse\r\nret += SNPRINTF(bf + ret, size - ret, " (all");\r\nif (target->cpu_list)\r\nret += SNPRINTF(bf + ret, size - ret, ", CPU%s: %s)",\r\ntop->evlist->cpus->nr > 1 ? "s" : "",\r\ntarget->cpu_list);\r\nelse {\r\nif (target->tid)\r\nret += SNPRINTF(bf + ret, size - ret, ")");\r\nelse\r\nret += SNPRINTF(bf + ret, size - ret, ", %d CPU%s)",\r\ntop->evlist->cpus->nr,\r\ntop->evlist->cpus->nr > 1 ? "s" : "");\r\n}\r\nreturn ret;\r\n}\r\nvoid perf_top__reset_sample_counters(struct perf_top *top)\r\n{\r\ntop->samples = top->us_samples = top->kernel_samples =\r\ntop->exact_samples = top->guest_kernel_samples =\r\ntop->guest_us_samples = 0;\r\n}

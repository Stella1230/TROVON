void __init\r\nwildfire_init_hose(int qbbno, int hoseno)\r\n{\r\nstruct pci_controller *hose;\r\nwildfire_pci *pci;\r\nhose = alloc_pci_controller();\r\nhose->io_space = alloc_resource();\r\nhose->mem_space = alloc_resource();\r\nhose->sparse_mem_base = 0;\r\nhose->sparse_io_base = 0;\r\nhose->dense_mem_base = WILDFIRE_MEM(qbbno, hoseno);\r\nhose->dense_io_base = WILDFIRE_IO(qbbno, hoseno);\r\nhose->config_space_base = WILDFIRE_CONF(qbbno, hoseno);\r\nhose->index = (qbbno << 3) + hoseno;\r\nhose->io_space->start = WILDFIRE_IO(qbbno, hoseno) - WILDFIRE_IO_BIAS;\r\nhose->io_space->end = hose->io_space->start + WILDFIRE_IO_SPACE - 1;\r\nhose->io_space->name = pci_io_names[hoseno];\r\nhose->io_space->flags = IORESOURCE_IO;\r\nhose->mem_space->start = WILDFIRE_MEM(qbbno, hoseno)-WILDFIRE_MEM_BIAS;\r\nhose->mem_space->end = hose->mem_space->start + 0xffffffff;\r\nhose->mem_space->name = pci_mem_names[hoseno];\r\nhose->mem_space->flags = IORESOURCE_MEM;\r\nif (request_resource(&ioport_resource, hose->io_space) < 0)\r\nprintk(KERN_ERR "Failed to request IO on qbb %d hose %d\n",\r\nqbbno, hoseno);\r\nif (request_resource(&iomem_resource, hose->mem_space) < 0)\r\nprintk(KERN_ERR "Failed to request MEM on qbb %d hose %d\n",\r\nqbbno, hoseno);\r\n#if DEBUG_DUMP_REGS\r\nwildfire_dump_pci_regs(qbbno, hoseno);\r\n#endif\r\nhose->sg_isa = iommu_arena_new(hose, 0x00800000, 0x00800000, 0);\r\nhose->sg_pci = iommu_arena_new(hose, 0xc0000000, 0x08000000, 0);\r\npci = WILDFIRE_pci(qbbno, hoseno);\r\npci->pci_window[0].wbase.csr = hose->sg_isa->dma_base | 3;\r\npci->pci_window[0].wmask.csr = (hose->sg_isa->size - 1) & 0xfff00000;\r\npci->pci_window[0].tbase.csr = virt_to_phys(hose->sg_isa->ptes);\r\npci->pci_window[1].wbase.csr = 0x40000000 | 1;\r\npci->pci_window[1].wmask.csr = (0x40000000 -1) & 0xfff00000;\r\npci->pci_window[1].tbase.csr = 0;\r\npci->pci_window[2].wbase.csr = 0x80000000 | 1;\r\npci->pci_window[2].wmask.csr = (0x40000000 -1) & 0xfff00000;\r\npci->pci_window[2].tbase.csr = 0x40000000;\r\npci->pci_window[3].wbase.csr = hose->sg_pci->dma_base | 3;\r\npci->pci_window[3].wmask.csr = (hose->sg_pci->size - 1) & 0xfff00000;\r\npci->pci_window[3].tbase.csr = virt_to_phys(hose->sg_pci->ptes);\r\nwildfire_pci_tbi(hose, 0, 0);\r\n}\r\nvoid __init\r\nwildfire_init_pca(int qbbno, int pcano)\r\n{\r\nif (!WILDFIRE_PCA_EXISTS(qbbno, pcano))\r\nreturn;\r\n#if DEBUG_DUMP_REGS\r\nwildfire_dump_pca_regs(qbbno, pcano);\r\n#endif\r\nwildfire_init_hose(qbbno, (pcano << 1) + 0);\r\nwildfire_init_hose(qbbno, (pcano << 1) + 1);\r\n}\r\nvoid __init\r\nwildfire_init_qbb(int qbbno)\r\n{\r\nint pcano;\r\nif (!WILDFIRE_QBB_EXISTS(qbbno))\r\nreturn;\r\n#if DEBUG_DUMP_REGS\r\nwildfire_dump_qsa_regs(qbbno);\r\nwildfire_dump_qsd_regs(qbbno);\r\nwildfire_dump_iop_regs(qbbno);\r\nwildfire_dump_gp_regs(qbbno);\r\n#endif\r\nfor (pcano = 0; pcano < WILDFIRE_PCA_PER_QBB; pcano++) {\r\nwildfire_init_pca(qbbno, pcano);\r\n}\r\n}\r\nvoid __init\r\nwildfire_hardware_probe(void)\r\n{\r\nunsigned long temp;\r\nunsigned int hard_qbb, soft_qbb;\r\nwildfire_fast_qsd *fast = WILDFIRE_fast_qsd();\r\nwildfire_qsd *qsd;\r\nwildfire_qsa *qsa;\r\nwildfire_iop *iop;\r\nwildfire_gp *gp;\r\nwildfire_ne *ne;\r\nwildfire_fe *fe;\r\nint i;\r\ntemp = fast->qsd_whami.csr;\r\n#if 0\r\nprintk(KERN_ERR "fast QSD_WHAMI at base %p is 0x%lx\n", fast, temp);\r\n#endif\r\nhard_qbb = (temp >> 8) & 7;\r\nsoft_qbb = (temp >> 4) & 7;\r\nwildfire_hard_qbb_mask = (1 << hard_qbb);\r\nwildfire_soft_qbb_mask = (1 << soft_qbb);\r\nwildfire_gp_mask = 0;\r\nwildfire_hs_mask = 0;\r\nwildfire_iop_mask = 0;\r\nwildfire_ior_mask = 0;\r\nwildfire_pca_mask = 0;\r\nwildfire_cpu_mask = 0;\r\nwildfire_mem_mask = 0;\r\nmemset(wildfire_hard_qbb_map, QBB_MAP_EMPTY, WILDFIRE_MAX_QBB);\r\nmemset(wildfire_soft_qbb_map, QBB_MAP_EMPTY, WILDFIRE_MAX_QBB);\r\nqsa = WILDFIRE_qsa(soft_qbb);\r\ntemp = qsa->qsa_qbb_id.csr;\r\n#if 0\r\nprintk(KERN_ERR "QSA_QBB_ID at base %p is 0x%lx\n", qsa, temp);\r\n#endif\r\nif (temp & 0x40)\r\nwildfire_hs_mask = 1;\r\nif (temp & 0x20) {\r\ngp = WILDFIRE_gp(soft_qbb);\r\ntemp = 0;\r\nfor (i = 0; i < 4; i++) {\r\ntemp |= gp->gpa_qbb_map[i].csr << (i * 8);\r\n#if 0\r\nprintk(KERN_ERR "GPA_QBB_MAP[%d] at base %p is 0x%lx\n",\r\ni, gp, temp);\r\n#endif\r\n}\r\nfor (hard_qbb = 0; hard_qbb < WILDFIRE_MAX_QBB; hard_qbb++) {\r\nif (temp & 8) {\r\nsoft_qbb = temp & 7;\r\nwildfire_hard_qbb_mask |= (1 << hard_qbb);\r\nwildfire_soft_qbb_mask |= (1 << soft_qbb);\r\n}\r\ntemp >>= 4;\r\n}\r\nwildfire_gp_mask = wildfire_soft_qbb_mask;\r\n}\r\nfor (soft_qbb = 0; soft_qbb < WILDFIRE_MAX_QBB; soft_qbb++) {\r\nif (WILDFIRE_QBB_EXISTS(soft_qbb)) {\r\nqsd = WILDFIRE_qsd(soft_qbb);\r\ntemp = qsd->qsd_whami.csr;\r\n#if 0\r\nprintk(KERN_ERR "QSD_WHAMI at base %p is 0x%lx\n", qsd, temp);\r\n#endif\r\nhard_qbb = (temp >> 8) & 7;\r\nwildfire_hard_qbb_map[hard_qbb] = soft_qbb;\r\nwildfire_soft_qbb_map[soft_qbb] = hard_qbb;\r\nqsa = WILDFIRE_qsa(soft_qbb);\r\ntemp = qsa->qsa_qbb_pop[0].csr;\r\n#if 0\r\nprintk(KERN_ERR "QSA_QBB_POP_0 at base %p is 0x%lx\n", qsa, temp);\r\n#endif\r\nwildfire_cpu_mask |= ((temp >> 0) & 0xf) << (soft_qbb << 2);\r\nwildfire_mem_mask |= ((temp >> 4) & 0xf) << (soft_qbb << 2);\r\ntemp = qsa->qsa_qbb_pop[1].csr;\r\n#if 0\r\nprintk(KERN_ERR "QSA_QBB_POP_1 at base %p is 0x%lx\n", qsa, temp);\r\n#endif\r\nwildfire_iop_mask |= (1 << soft_qbb);\r\nwildfire_ior_mask |= ((temp >> 4) & 0xf) << (soft_qbb << 2);\r\ntemp = qsa->qsa_qbb_id.csr;\r\n#if 0\r\nprintk(KERN_ERR "QSA_QBB_ID at %p is 0x%lx\n", qsa, temp);\r\n#endif\r\nif (temp & 0x20)\r\nwildfire_gp_mask |= (1 << soft_qbb);\r\nfor (i = 0; i < WILDFIRE_PCA_PER_QBB; i++) {\r\niop = WILDFIRE_iop(soft_qbb);\r\nne = WILDFIRE_ne(soft_qbb, i);\r\nfe = WILDFIRE_fe(soft_qbb, i);\r\nif ((iop->iop_hose[i].init.csr & 1) == 1 &&\r\n((ne->ne_what_am_i.csr & 0xf00000300UL) == 0x100000300UL) &&\r\n((fe->fe_what_am_i.csr & 0xf00000300UL) == 0x100000200UL))\r\n{\r\nwildfire_pca_mask |= 1 << ((soft_qbb << 2) + i);\r\n}\r\n}\r\n}\r\n}\r\n#if DEBUG_DUMP_CONFIG\r\nwildfire_dump_hardware_config();\r\n#endif\r\n}\r\nvoid __init\r\nwildfire_init_arch(void)\r\n{\r\nint qbbno;\r\nioport_resource.end = ~0UL;\r\nwildfire_hardware_probe();\r\nfor (qbbno = 0; qbbno < WILDFIRE_MAX_QBB; qbbno++) {\r\nwildfire_init_qbb(qbbno);\r\n}\r\n__direct_map_base = 0x40000000UL;\r\n__direct_map_size = 0x80000000UL;\r\n}\r\nvoid\r\nwildfire_machine_check(unsigned long vector, unsigned long la_ptr)\r\n{\r\nmb();\r\nmb();\r\ndraina();\r\nwrmces(0x7);\r\nmb();\r\nprocess_mcheck_info(vector, la_ptr, "WILDFIRE",\r\nmcheck_expected(smp_processor_id()));\r\n}\r\nvoid\r\nwildfire_kill_arch(int mode)\r\n{\r\n}\r\nvoid\r\nwildfire_pci_tbi(struct pci_controller *hose, dma_addr_t start, dma_addr_t end)\r\n{\r\nint qbbno = hose->index >> 3;\r\nint hoseno = hose->index & 7;\r\nwildfire_pci *pci = WILDFIRE_pci(qbbno, hoseno);\r\nmb();\r\npci->pci_flush_tlb.csr;\r\n}\r\nstatic int\r\nmk_conf_addr(struct pci_bus *pbus, unsigned int device_fn, int where,\r\nunsigned long *pci_addr, unsigned char *type1)\r\n{\r\nstruct pci_controller *hose = pbus->sysdata;\r\nunsigned long addr;\r\nu8 bus = pbus->number;\r\nDBG_CFG(("mk_conf_addr(bus=%d ,device_fn=0x%x, where=0x%x, "\r\n"pci_addr=0x%p, type1=0x%p)\n",\r\nbus, device_fn, where, pci_addr, type1));\r\nif (!pbus->parent)\r\nbus = 0;\r\n*type1 = (bus != 0);\r\naddr = (bus << 16) | (device_fn << 8) | where;\r\naddr |= hose->config_space_base;\r\n*pci_addr = addr;\r\nDBG_CFG(("mk_conf_addr: returning pci_addr 0x%lx\n", addr));\r\nreturn 0;\r\n}\r\nstatic int\r\nwildfire_read_config(struct pci_bus *bus, unsigned int devfn, int where,\r\nint size, u32 *value)\r\n{\r\nunsigned long addr;\r\nunsigned char type1;\r\nif (mk_conf_addr(bus, devfn, where, &addr, &type1))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nswitch (size) {\r\ncase 1:\r\n*value = __kernel_ldbu(*(vucp)addr);\r\nbreak;\r\ncase 2:\r\n*value = __kernel_ldwu(*(vusp)addr);\r\nbreak;\r\ncase 4:\r\n*value = *(vuip)addr;\r\nbreak;\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int\r\nwildfire_write_config(struct pci_bus *bus, unsigned int devfn, int where,\r\nint size, u32 value)\r\n{\r\nunsigned long addr;\r\nunsigned char type1;\r\nif (mk_conf_addr(bus, devfn, where, &addr, &type1))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nswitch (size) {\r\ncase 1:\r\n__kernel_stb(value, *(vucp)addr);\r\nmb();\r\n__kernel_ldbu(*(vucp)addr);\r\nbreak;\r\ncase 2:\r\n__kernel_stw(value, *(vusp)addr);\r\nmb();\r\n__kernel_ldwu(*(vusp)addr);\r\nbreak;\r\ncase 4:\r\n*(vuip)addr = value;\r\nmb();\r\n*(vuip)addr;\r\nbreak;\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nint wildfire_pa_to_nid(unsigned long pa)\r\n{\r\nreturn pa >> 36;\r\n}\r\nint wildfire_cpuid_to_nid(int cpuid)\r\n{\r\nreturn cpuid >> 2;\r\n}\r\nunsigned long wildfire_node_mem_start(int nid)\r\n{\r\nreturn (unsigned long)nid * (64UL * 1024 * 1024 * 1024);\r\n}\r\nunsigned long wildfire_node_mem_size(int nid)\r\n{\r\nreturn 64UL * 1024 * 1024 * 1024;\r\n}\r\nstatic void __init\r\nwildfire_dump_pci_regs(int qbbno, int hoseno)\r\n{\r\nwildfire_pci *pci = WILDFIRE_pci(qbbno, hoseno);\r\nint i;\r\nprintk(KERN_ERR "PCI registers for QBB %d hose %d (%p)\n",\r\nqbbno, hoseno, pci);\r\nprintk(KERN_ERR " PCI_IO_ADDR_EXT: 0x%16lx\n",\r\npci->pci_io_addr_ext.csr);\r\nprintk(KERN_ERR " PCI_CTRL: 0x%16lx\n", pci->pci_ctrl.csr);\r\nprintk(KERN_ERR " PCI_ERR_SUM: 0x%16lx\n", pci->pci_err_sum.csr);\r\nprintk(KERN_ERR " PCI_ERR_ADDR: 0x%16lx\n", pci->pci_err_addr.csr);\r\nprintk(KERN_ERR " PCI_STALL_CNT: 0x%16lx\n", pci->pci_stall_cnt.csr);\r\nprintk(KERN_ERR " PCI_PEND_INT: 0x%16lx\n", pci->pci_pend_int.csr);\r\nprintk(KERN_ERR " PCI_SENT_INT: 0x%16lx\n", pci->pci_sent_int.csr);\r\nprintk(KERN_ERR " DMA window registers for QBB %d hose %d (%p)\n",\r\nqbbno, hoseno, pci);\r\nfor (i = 0; i < 4; i++) {\r\nprintk(KERN_ERR " window %d: 0x%16lx 0x%16lx 0x%16lx\n", i,\r\npci->pci_window[i].wbase.csr,\r\npci->pci_window[i].wmask.csr,\r\npci->pci_window[i].tbase.csr);\r\n}\r\nprintk(KERN_ERR "\n");\r\n}\r\nstatic void __init\r\nwildfire_dump_pca_regs(int qbbno, int pcano)\r\n{\r\nwildfire_pca *pca = WILDFIRE_pca(qbbno, pcano);\r\nint i;\r\nprintk(KERN_ERR "PCA registers for QBB %d PCA %d (%p)\n",\r\nqbbno, pcano, pca);\r\nprintk(KERN_ERR " PCA_WHAT_AM_I: 0x%16lx\n", pca->pca_what_am_i.csr);\r\nprintk(KERN_ERR " PCA_ERR_SUM: 0x%16lx\n", pca->pca_err_sum.csr);\r\nprintk(KERN_ERR " PCA_PEND_INT: 0x%16lx\n", pca->pca_pend_int.csr);\r\nprintk(KERN_ERR " PCA_SENT_INT: 0x%16lx\n", pca->pca_sent_int.csr);\r\nprintk(KERN_ERR " PCA_STDIO_EL: 0x%16lx\n",\r\npca->pca_stdio_edge_level.csr);\r\nprintk(KERN_ERR " PCA target registers for QBB %d PCA %d (%p)\n",\r\nqbbno, pcano, pca);\r\nfor (i = 0; i < 4; i++) {\r\nprintk(KERN_ERR " target %d: 0x%16lx 0x%16lx\n", i,\r\npca->pca_int[i].target.csr,\r\npca->pca_int[i].enable.csr);\r\n}\r\nprintk(KERN_ERR "\n");\r\n}\r\nstatic void __init\r\nwildfire_dump_qsa_regs(int qbbno)\r\n{\r\nwildfire_qsa *qsa = WILDFIRE_qsa(qbbno);\r\nint i;\r\nprintk(KERN_ERR "QSA registers for QBB %d (%p)\n", qbbno, qsa);\r\nprintk(KERN_ERR " QSA_QBB_ID: 0x%16lx\n", qsa->qsa_qbb_id.csr);\r\nprintk(KERN_ERR " QSA_PORT_ENA: 0x%16lx\n", qsa->qsa_port_ena.csr);\r\nprintk(KERN_ERR " QSA_REF_INT: 0x%16lx\n", qsa->qsa_ref_int.csr);\r\nfor (i = 0; i < 5; i++)\r\nprintk(KERN_ERR " QSA_CONFIG_%d: 0x%16lx\n",\r\ni, qsa->qsa_config[i].csr);\r\nfor (i = 0; i < 2; i++)\r\nprintk(KERN_ERR " QSA_QBB_POP_%d: 0x%16lx\n",\r\ni, qsa->qsa_qbb_pop[0].csr);\r\nprintk(KERN_ERR "\n");\r\n}\r\nstatic void __init\r\nwildfire_dump_qsd_regs(int qbbno)\r\n{\r\nwildfire_qsd *qsd = WILDFIRE_qsd(qbbno);\r\nprintk(KERN_ERR "QSD registers for QBB %d (%p)\n", qbbno, qsd);\r\nprintk(KERN_ERR " QSD_WHAMI: 0x%16lx\n", qsd->qsd_whami.csr);\r\nprintk(KERN_ERR " QSD_REV: 0x%16lx\n", qsd->qsd_rev.csr);\r\nprintk(KERN_ERR " QSD_PORT_PRESENT: 0x%16lx\n",\r\nqsd->qsd_port_present.csr);\r\nprintk(KERN_ERR " QSD_PORT_ACTUVE: 0x%16lx\n",\r\nqsd->qsd_port_active.csr);\r\nprintk(KERN_ERR " QSD_FAULT_ENA: 0x%16lx\n",\r\nqsd->qsd_fault_ena.csr);\r\nprintk(KERN_ERR " QSD_CPU_INT_ENA: 0x%16lx\n",\r\nqsd->qsd_cpu_int_ena.csr);\r\nprintk(KERN_ERR " QSD_MEM_CONFIG: 0x%16lx\n",\r\nqsd->qsd_mem_config.csr);\r\nprintk(KERN_ERR " QSD_ERR_SUM: 0x%16lx\n",\r\nqsd->qsd_err_sum.csr);\r\nprintk(KERN_ERR "\n");\r\n}\r\nstatic void __init\r\nwildfire_dump_iop_regs(int qbbno)\r\n{\r\nwildfire_iop *iop = WILDFIRE_iop(qbbno);\r\nint i;\r\nprintk(KERN_ERR "IOP registers for QBB %d (%p)\n", qbbno, iop);\r\nprintk(KERN_ERR " IOA_CONFIG: 0x%16lx\n", iop->ioa_config.csr);\r\nprintk(KERN_ERR " IOD_CONFIG: 0x%16lx\n", iop->iod_config.csr);\r\nprintk(KERN_ERR " IOP_SWITCH_CREDITS: 0x%16lx\n",\r\niop->iop_switch_credits.csr);\r\nprintk(KERN_ERR " IOP_HOSE_CREDITS: 0x%16lx\n",\r\niop->iop_hose_credits.csr);\r\nfor (i = 0; i < 4; i++)\r\nprintk(KERN_ERR " IOP_HOSE_%d_INIT: 0x%16lx\n",\r\ni, iop->iop_hose[i].init.csr);\r\nfor (i = 0; i < 4; i++)\r\nprintk(KERN_ERR " IOP_DEV_INT_TARGET_%d: 0x%16lx\n",\r\ni, iop->iop_dev_int[i].target.csr);\r\nprintk(KERN_ERR "\n");\r\n}\r\nstatic void __init\r\nwildfire_dump_gp_regs(int qbbno)\r\n{\r\nwildfire_gp *gp = WILDFIRE_gp(qbbno);\r\nint i;\r\nprintk(KERN_ERR "GP registers for QBB %d (%p)\n", qbbno, gp);\r\nfor (i = 0; i < 4; i++)\r\nprintk(KERN_ERR " GPA_QBB_MAP_%d: 0x%16lx\n",\r\ni, gp->gpa_qbb_map[i].csr);\r\nprintk(KERN_ERR " GPA_MEM_POP_MAP: 0x%16lx\n",\r\ngp->gpa_mem_pop_map.csr);\r\nprintk(KERN_ERR " GPA_SCRATCH: 0x%16lx\n", gp->gpa_scratch.csr);\r\nprintk(KERN_ERR " GPA_DIAG: 0x%16lx\n", gp->gpa_diag.csr);\r\nprintk(KERN_ERR " GPA_CONFIG_0: 0x%16lx\n", gp->gpa_config_0.csr);\r\nprintk(KERN_ERR " GPA_INIT_ID: 0x%16lx\n", gp->gpa_init_id.csr);\r\nprintk(KERN_ERR " GPA_CONFIG_2: 0x%16lx\n", gp->gpa_config_2.csr);\r\nprintk(KERN_ERR "\n");\r\n}\r\nstatic void __init\r\nwildfire_dump_hardware_config(void)\r\n{\r\nint i;\r\nprintk(KERN_ERR "Probed Hardware Configuration\n");\r\nprintk(KERN_ERR " hard_qbb_mask: 0x%16lx\n", wildfire_hard_qbb_mask);\r\nprintk(KERN_ERR " soft_qbb_mask: 0x%16lx\n", wildfire_soft_qbb_mask);\r\nprintk(KERN_ERR " gp_mask: 0x%16lx\n", wildfire_gp_mask);\r\nprintk(KERN_ERR " hs_mask: 0x%16lx\n", wildfire_hs_mask);\r\nprintk(KERN_ERR " iop_mask: 0x%16lx\n", wildfire_iop_mask);\r\nprintk(KERN_ERR " ior_mask: 0x%16lx\n", wildfire_ior_mask);\r\nprintk(KERN_ERR " pca_mask: 0x%16lx\n", wildfire_pca_mask);\r\nprintk(KERN_ERR " cpu_mask: 0x%16lx\n", wildfire_cpu_mask);\r\nprintk(KERN_ERR " mem_mask: 0x%16lx\n", wildfire_mem_mask);\r\nprintk(" hard_qbb_map: ");\r\nfor (i = 0; i < WILDFIRE_MAX_QBB; i++)\r\nif (wildfire_hard_qbb_map[i] == QBB_MAP_EMPTY)\r\nprintk("--- ");\r\nelse\r\nprintk("%3d ", wildfire_hard_qbb_map[i]);\r\nprintk("\n");\r\nprintk(" soft_qbb_map: ");\r\nfor (i = 0; i < WILDFIRE_MAX_QBB; i++)\r\nif (wildfire_soft_qbb_map[i] == QBB_MAP_EMPTY)\r\nprintk("--- ");\r\nelse\r\nprintk("%3d ", wildfire_soft_qbb_map[i]);\r\nprintk("\n");\r\n}

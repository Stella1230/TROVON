static int lms501kf03_spi_write_byte(struct lms501kf03 *lcd, int addr, int data)\r\n{\r\nu16 buf[1];\r\nstruct spi_message msg;\r\nstruct spi_transfer xfer = {\r\n.len = 2,\r\n.tx_buf = buf,\r\n};\r\nbuf[0] = (addr << 8) | data;\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfer, &msg);\r\nreturn spi_sync(lcd->spi, &msg);\r\n}\r\nstatic int lms501kf03_spi_write(struct lms501kf03 *lcd, unsigned char address,\r\nunsigned char command)\r\n{\r\nreturn lms501kf03_spi_write_byte(lcd, address, command);\r\n}\r\nstatic int lms501kf03_panel_send_sequence(struct lms501kf03 *lcd,\r\nconst unsigned char *wbuf,\r\nunsigned int len)\r\n{\r\nint ret = 0, i = 0;\r\nwhile (i < len) {\r\nif (i == 0)\r\nret = lms501kf03_spi_write(lcd, COMMAND_ONLY, wbuf[i]);\r\nelse\r\nret = lms501kf03_spi_write(lcd, DATA_ONLY, wbuf[i]);\r\nif (ret)\r\nbreak;\r\ni += 1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int lms501kf03_ldi_init(struct lms501kf03 *lcd)\r\n{\r\nint ret, i;\r\nstatic const unsigned char *init_seq[] = {\r\nseq_password,\r\nseq_power,\r\nseq_display,\r\nseq_rgb_if,\r\nseq_display_inv,\r\nseq_vcom,\r\nseq_gate,\r\nseq_panel,\r\nseq_col_mod,\r\nseq_w_gamma,\r\nseq_rgb_gamma,\r\nseq_sleep_out,\r\n};\r\nstatic const unsigned int size_seq[] = {\r\nARRAY_SIZE(seq_password),\r\nARRAY_SIZE(seq_power),\r\nARRAY_SIZE(seq_display),\r\nARRAY_SIZE(seq_rgb_if),\r\nARRAY_SIZE(seq_display_inv),\r\nARRAY_SIZE(seq_vcom),\r\nARRAY_SIZE(seq_gate),\r\nARRAY_SIZE(seq_panel),\r\nARRAY_SIZE(seq_col_mod),\r\nARRAY_SIZE(seq_w_gamma),\r\nARRAY_SIZE(seq_rgb_gamma),\r\nARRAY_SIZE(seq_sleep_out),\r\n};\r\nfor (i = 0; i < ARRAY_SIZE(init_seq); i++) {\r\nret = lms501kf03_panel_send_sequence(lcd, init_seq[i],\r\nsize_seq[i]);\r\nif (ret)\r\nbreak;\r\n}\r\nmsleep(120);\r\nreturn ret;\r\n}\r\nstatic int lms501kf03_ldi_enable(struct lms501kf03 *lcd)\r\n{\r\nreturn lms501kf03_panel_send_sequence(lcd, seq_display_on,\r\nARRAY_SIZE(seq_display_on));\r\n}\r\nstatic int lms501kf03_ldi_disable(struct lms501kf03 *lcd)\r\n{\r\nreturn lms501kf03_panel_send_sequence(lcd, seq_display_off,\r\nARRAY_SIZE(seq_display_off));\r\n}\r\nstatic int lms501kf03_power_is_on(int power)\r\n{\r\nreturn (power) <= FB_BLANK_NORMAL;\r\n}\r\nstatic int lms501kf03_power_on(struct lms501kf03 *lcd)\r\n{\r\nint ret = 0;\r\nstruct lcd_platform_data *pd;\r\npd = lcd->lcd_pd;\r\nif (!pd->power_on) {\r\ndev_err(lcd->dev, "power_on is NULL.\n");\r\nreturn -EINVAL;\r\n} else {\r\npd->power_on(lcd->ld, 1);\r\nmsleep(pd->power_on_delay);\r\n}\r\nif (!pd->reset) {\r\ndev_err(lcd->dev, "reset is NULL.\n");\r\nreturn -EINVAL;\r\n} else {\r\npd->reset(lcd->ld);\r\nmsleep(pd->reset_delay);\r\n}\r\nret = lms501kf03_ldi_init(lcd);\r\nif (ret) {\r\ndev_err(lcd->dev, "failed to initialize ldi.\n");\r\nreturn ret;\r\n}\r\nret = lms501kf03_ldi_enable(lcd);\r\nif (ret) {\r\ndev_err(lcd->dev, "failed to enable ldi.\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lms501kf03_power_off(struct lms501kf03 *lcd)\r\n{\r\nint ret = 0;\r\nstruct lcd_platform_data *pd;\r\npd = lcd->lcd_pd;\r\nret = lms501kf03_ldi_disable(lcd);\r\nif (ret) {\r\ndev_err(lcd->dev, "lcd setting failed.\n");\r\nreturn -EIO;\r\n}\r\nmsleep(pd->power_off_delay);\r\npd->power_on(lcd->ld, 0);\r\nreturn 0;\r\n}\r\nstatic int lms501kf03_power(struct lms501kf03 *lcd, int power)\r\n{\r\nint ret = 0;\r\nif (lms501kf03_power_is_on(power) &&\r\n!lms501kf03_power_is_on(lcd->power))\r\nret = lms501kf03_power_on(lcd);\r\nelse if (!lms501kf03_power_is_on(power) &&\r\nlms501kf03_power_is_on(lcd->power))\r\nret = lms501kf03_power_off(lcd);\r\nif (!ret)\r\nlcd->power = power;\r\nreturn ret;\r\n}\r\nstatic int lms501kf03_get_power(struct lcd_device *ld)\r\n{\r\nstruct lms501kf03 *lcd = lcd_get_data(ld);\r\nreturn lcd->power;\r\n}\r\nstatic int lms501kf03_set_power(struct lcd_device *ld, int power)\r\n{\r\nstruct lms501kf03 *lcd = lcd_get_data(ld);\r\nif (power != FB_BLANK_UNBLANK && power != FB_BLANK_POWERDOWN &&\r\npower != FB_BLANK_NORMAL) {\r\ndev_err(lcd->dev, "power value should be 0, 1 or 4.\n");\r\nreturn -EINVAL;\r\n}\r\nreturn lms501kf03_power(lcd, power);\r\n}\r\nstatic int lms501kf03_probe(struct spi_device *spi)\r\n{\r\nstruct lms501kf03 *lcd = NULL;\r\nstruct lcd_device *ld = NULL;\r\nint ret = 0;\r\nlcd = devm_kzalloc(&spi->dev, sizeof(struct lms501kf03), GFP_KERNEL);\r\nif (!lcd)\r\nreturn -ENOMEM;\r\nspi->bits_per_word = 9;\r\nret = spi_setup(spi);\r\nif (ret < 0) {\r\ndev_err(&spi->dev, "spi setup failed.\n");\r\nreturn ret;\r\n}\r\nlcd->spi = spi;\r\nlcd->dev = &spi->dev;\r\nlcd->lcd_pd = dev_get_platdata(&spi->dev);\r\nif (!lcd->lcd_pd) {\r\ndev_err(&spi->dev, "platform data is NULL\n");\r\nreturn -EINVAL;\r\n}\r\nld = devm_lcd_device_register(&spi->dev, "lms501kf03", &spi->dev, lcd,\r\n&lms501kf03_lcd_ops);\r\nif (IS_ERR(ld))\r\nreturn PTR_ERR(ld);\r\nlcd->ld = ld;\r\nif (!lcd->lcd_pd->lcd_enabled) {\r\nlcd->power = FB_BLANK_POWERDOWN;\r\nlms501kf03_power(lcd, FB_BLANK_UNBLANK);\r\n} else {\r\nlcd->power = FB_BLANK_UNBLANK;\r\n}\r\nspi_set_drvdata(spi, lcd);\r\ndev_info(&spi->dev, "lms501kf03 panel driver has been probed.\n");\r\nreturn 0;\r\n}\r\nstatic int lms501kf03_remove(struct spi_device *spi)\r\n{\r\nstruct lms501kf03 *lcd = spi_get_drvdata(spi);\r\nlms501kf03_power(lcd, FB_BLANK_POWERDOWN);\r\nreturn 0;\r\n}\r\nstatic int lms501kf03_suspend(struct device *dev)\r\n{\r\nstruct lms501kf03 *lcd = dev_get_drvdata(dev);\r\ndev_dbg(dev, "lcd->power = %d\n", lcd->power);\r\nreturn lms501kf03_power(lcd, FB_BLANK_POWERDOWN);\r\n}\r\nstatic int lms501kf03_resume(struct device *dev)\r\n{\r\nstruct lms501kf03 *lcd = dev_get_drvdata(dev);\r\nlcd->power = FB_BLANK_POWERDOWN;\r\nreturn lms501kf03_power(lcd, FB_BLANK_UNBLANK);\r\n}\r\nstatic void lms501kf03_shutdown(struct spi_device *spi)\r\n{\r\nstruct lms501kf03 *lcd = spi_get_drvdata(spi);\r\nlms501kf03_power(lcd, FB_BLANK_POWERDOWN);\r\n}

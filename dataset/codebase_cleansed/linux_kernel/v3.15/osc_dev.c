static struct lu_device *osc2lu_dev(struct osc_device *osc)\r\n{\r\nreturn &osc->od_cl.cd_lu_dev;\r\n}\r\nstatic void *osc_key_init(const struct lu_context *ctx,\r\nstruct lu_context_key *key)\r\n{\r\nstruct osc_thread_info *info;\r\nOBD_SLAB_ALLOC_PTR_GFP(info, osc_thread_kmem, __GFP_IO);\r\nif (info == NULL)\r\ninfo = ERR_PTR(-ENOMEM);\r\nreturn info;\r\n}\r\nstatic void osc_key_fini(const struct lu_context *ctx,\r\nstruct lu_context_key *key, void *data)\r\n{\r\nstruct osc_thread_info *info = data;\r\nOBD_SLAB_FREE_PTR(info, osc_thread_kmem);\r\n}\r\nstatic void *osc_session_init(const struct lu_context *ctx,\r\nstruct lu_context_key *key)\r\n{\r\nstruct osc_session *info;\r\nOBD_SLAB_ALLOC_PTR_GFP(info, osc_session_kmem, __GFP_IO);\r\nif (info == NULL)\r\ninfo = ERR_PTR(-ENOMEM);\r\nreturn info;\r\n}\r\nstatic void osc_session_fini(const struct lu_context *ctx,\r\nstruct lu_context_key *key, void *data)\r\n{\r\nstruct osc_session *info = data;\r\nOBD_SLAB_FREE_PTR(info, osc_session_kmem);\r\n}\r\nstatic int osc_cl_process_config(const struct lu_env *env,\r\nstruct lu_device *d, struct lustre_cfg *cfg)\r\n{\r\nreturn osc_process_config_base(d->ld_obd, cfg);\r\n}\r\nstatic int osc_device_init(const struct lu_env *env, struct lu_device *d,\r\nconst char *name, struct lu_device *next)\r\n{\r\nreturn 0;\r\n}\r\nstatic struct lu_device *osc_device_fini(const struct lu_env *env,\r\nstruct lu_device *d)\r\n{\r\nreturn 0;\r\n}\r\nstatic struct lu_device *osc_device_free(const struct lu_env *env,\r\nstruct lu_device *d)\r\n{\r\nstruct osc_device *od = lu2osc_dev(d);\r\ncl_device_fini(lu2cl_dev(d));\r\nOBD_FREE_PTR(od);\r\nreturn NULL;\r\n}\r\nstatic struct lu_device *osc_device_alloc(const struct lu_env *env,\r\nstruct lu_device_type *t,\r\nstruct lustre_cfg *cfg)\r\n{\r\nstruct lu_device *d;\r\nstruct osc_device *od;\r\nstruct obd_device *obd;\r\nint rc;\r\nOBD_ALLOC_PTR(od);\r\nif (od == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\ncl_device_init(&od->od_cl, t);\r\nd = osc2lu_dev(od);\r\nd->ld_ops = &osc_lu_ops;\r\nod->od_cl.cd_ops = &osc_cl_ops;\r\nobd = class_name2obd(lustre_cfg_string(cfg, 0));\r\nLASSERT(obd != NULL);\r\nrc = osc_setup(obd, cfg);\r\nif (rc) {\r\nosc_device_free(env, d);\r\nreturn ERR_PTR(rc);\r\n}\r\nod->od_exp = obd->obd_self_export;\r\nreturn d;\r\n}

static int mips_next_event(unsigned long delta,\r\nstruct clock_event_device *evt)\r\n{\r\nunsigned int cnt;\r\nint res;\r\ncnt = read_c0_count();\r\ncnt += delta;\r\nwrite_c0_compare(cnt);\r\nres = ((int)(read_c0_count() - cnt) >= 0) ? -ETIME : 0;\r\nreturn res;\r\n}\r\nvoid mips_set_clock_mode(enum clock_event_mode mode,\r\nstruct clock_event_device *evt)\r\n{\r\n}\r\nirqreturn_t c0_compare_interrupt(int irq, void *dev_id)\r\n{\r\nconst int r2 = cpu_has_mips_r2;\r\nstruct clock_event_device *cd;\r\nint cpu = smp_processor_id();\r\nif (handle_perf_irq(r2))\r\ngoto out;\r\nif (!r2 || (read_c0_cause() & (1 << 30))) {\r\nwrite_c0_compare(read_c0_compare());\r\ncd = &per_cpu(mips_clockevent_device, cpu);\r\n#ifdef CONFIG_CEVT_GIC\r\nif (!gic_present)\r\n#endif\r\ncd->event_handler(cd);\r\n}\r\nout:\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid mips_event_handler(struct clock_event_device *dev)\r\n{\r\n}\r\nstatic int c0_compare_int_pending(void)\r\n{\r\n#ifdef CONFIG_IRQ_GIC\r\nif (cpu_has_veic)\r\nreturn gic_get_timer_pending();\r\n#endif\r\nreturn (read_c0_cause() >> cp0_compare_irq_shift) & (1ul << CAUSEB_IP);\r\n}\r\nint c0_compare_int_usable(void)\r\n{\r\nunsigned int delta;\r\nunsigned int cnt;\r\n#ifdef CONFIG_KVM_GUEST\r\nreturn 1;\r\n#endif\r\nif (c0_compare_int_pending()) {\r\ncnt = read_c0_count();\r\nwrite_c0_compare(cnt);\r\nback_to_back_c0_hazard();\r\nwhile (read_c0_count() < (cnt + COMPARE_INT_SEEN_TICKS))\r\nif (!c0_compare_int_pending())\r\nbreak;\r\nif (c0_compare_int_pending())\r\nreturn 0;\r\n}\r\nfor (delta = 0x10; delta <= 0x400000; delta <<= 1) {\r\ncnt = read_c0_count();\r\ncnt += delta;\r\nwrite_c0_compare(cnt);\r\nback_to_back_c0_hazard();\r\nif ((int)(read_c0_count() - cnt) < 0)\r\nbreak;\r\n}\r\nwhile ((int)(read_c0_count() - cnt) <= 0)\r\n;\r\nwhile (read_c0_count() < (cnt + COMPARE_INT_SEEN_TICKS))\r\nif (c0_compare_int_pending())\r\nbreak;\r\nif (!c0_compare_int_pending())\r\nreturn 0;\r\ncnt = read_c0_count();\r\nwrite_c0_compare(cnt);\r\nback_to_back_c0_hazard();\r\nwhile (read_c0_count() < (cnt + COMPARE_INT_SEEN_TICKS))\r\nif (!c0_compare_int_pending())\r\nbreak;\r\nif (c0_compare_int_pending())\r\nreturn 0;\r\nreturn 1;\r\n}\r\nint r4k_clockevent_init(void)\r\n{\r\nunsigned int cpu = smp_processor_id();\r\nstruct clock_event_device *cd;\r\nunsigned int irq;\r\nif (!cpu_has_counter || !mips_hpt_frequency)\r\nreturn -ENXIO;\r\nif (!c0_compare_int_usable())\r\nreturn -ENXIO;\r\nirq = MIPS_CPU_IRQ_BASE + cp0_compare_irq;\r\nif (get_c0_compare_int)\r\nirq = get_c0_compare_int();\r\ncd = &per_cpu(mips_clockevent_device, cpu);\r\ncd->name = "MIPS";\r\ncd->features = CLOCK_EVT_FEAT_ONESHOT;\r\nclockevent_set_clock(cd, mips_hpt_frequency);\r\ncd->max_delta_ns = clockevent_delta2ns(0x7fffffff, cd);\r\ncd->min_delta_ns = clockevent_delta2ns(0x300, cd);\r\ncd->rating = 300;\r\ncd->irq = irq;\r\ncd->cpumask = cpumask_of(cpu);\r\ncd->set_next_event = mips_next_event;\r\ncd->set_mode = mips_set_clock_mode;\r\ncd->event_handler = mips_event_handler;\r\n#ifdef CONFIG_CEVT_GIC\r\nif (!gic_present)\r\n#endif\r\nclockevents_register_device(cd);\r\nif (cp0_timer_irq_installed)\r\nreturn 0;\r\ncp0_timer_irq_installed = 1;\r\nsetup_irq(irq, &c0_compare_irqaction);\r\nreturn 0;\r\n}

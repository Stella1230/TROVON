void __init bcsr_init(unsigned long bcsr1_phys, unsigned long bcsr2_phys)\r\n{\r\nint i;\r\nbcsr1_phys = KSEG1ADDR(CPHYSADDR(bcsr1_phys));\r\nbcsr2_phys = KSEG1ADDR(CPHYSADDR(bcsr2_phys));\r\nbcsr_virt = (void __iomem *)bcsr1_phys;\r\nfor (i = 0; i < BCSR_CNT; i++) {\r\nif (i >= BCSR_HEXLEDS)\r\nbcsr_regs[i].raddr = (void __iomem *)bcsr2_phys +\r\n(0x04 * (i - BCSR_HEXLEDS));\r\nelse\r\nbcsr_regs[i].raddr = (void __iomem *)bcsr1_phys +\r\n(0x04 * i);\r\nspin_lock_init(&bcsr_regs[i].lock);\r\n}\r\n}\r\nunsigned short bcsr_read(enum bcsr_id reg)\r\n{\r\nunsigned short r;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bcsr_regs[reg].lock, flags);\r\nr = __raw_readw(bcsr_regs[reg].raddr);\r\nspin_unlock_irqrestore(&bcsr_regs[reg].lock, flags);\r\nreturn r;\r\n}\r\nvoid bcsr_write(enum bcsr_id reg, unsigned short val)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&bcsr_regs[reg].lock, flags);\r\n__raw_writew(val, bcsr_regs[reg].raddr);\r\nwmb();\r\nspin_unlock_irqrestore(&bcsr_regs[reg].lock, flags);\r\n}\r\nvoid bcsr_mod(enum bcsr_id reg, unsigned short clr, unsigned short set)\r\n{\r\nunsigned short r;\r\nunsigned long flags;\r\nspin_lock_irqsave(&bcsr_regs[reg].lock, flags);\r\nr = __raw_readw(bcsr_regs[reg].raddr);\r\nr &= ~clr;\r\nr |= set;\r\n__raw_writew(r, bcsr_regs[reg].raddr);\r\nwmb();\r\nspin_unlock_irqrestore(&bcsr_regs[reg].lock, flags);\r\n}\r\nstatic void bcsr_csc_handler(unsigned int irq, struct irq_desc *d)\r\n{\r\nunsigned short bisr = __raw_readw(bcsr_virt + BCSR_REG_INTSTAT);\r\ndisable_irq_nosync(irq);\r\ngeneric_handle_irq(bcsr_csc_base + __ffs(bisr));\r\nenable_irq(irq);\r\n}\r\nstatic void bcsr_irq_mask(struct irq_data *d)\r\n{\r\nunsigned short v = 1 << (d->irq - bcsr_csc_base);\r\n__raw_writew(v, bcsr_virt + BCSR_REG_MASKCLR);\r\nwmb();\r\n}\r\nstatic void bcsr_irq_maskack(struct irq_data *d)\r\n{\r\nunsigned short v = 1 << (d->irq - bcsr_csc_base);\r\n__raw_writew(v, bcsr_virt + BCSR_REG_MASKCLR);\r\n__raw_writew(v, bcsr_virt + BCSR_REG_INTSTAT);\r\nwmb();\r\n}\r\nstatic void bcsr_irq_unmask(struct irq_data *d)\r\n{\r\nunsigned short v = 1 << (d->irq - bcsr_csc_base);\r\n__raw_writew(v, bcsr_virt + BCSR_REG_MASKSET);\r\nwmb();\r\n}\r\nvoid __init bcsr_init_irq(int csc_start, int csc_end, int hook_irq)\r\n{\r\nunsigned int irq;\r\n__raw_writew(0xffff, bcsr_virt + BCSR_REG_MASKCLR);\r\n__raw_writew(0xffff, bcsr_virt + BCSR_REG_INTSET);\r\n__raw_writew(0xffff, bcsr_virt + BCSR_REG_INTSTAT);\r\nwmb();\r\nbcsr_csc_base = csc_start;\r\nfor (irq = csc_start; irq <= csc_end; irq++)\r\nirq_set_chip_and_handler_name(irq, &bcsr_irq_type,\r\nhandle_level_irq, "level");\r\nirq_set_chained_handler(hook_irq, bcsr_csc_handler);\r\n}

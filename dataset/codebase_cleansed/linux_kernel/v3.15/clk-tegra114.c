static int __init tegra114_osc_clk_init(void __iomem *clk_base)\r\n{\r\nstruct clk *clk;\r\nu32 val, pll_ref_div;\r\nval = readl_relaxed(clk_base + OSC_CTRL);\r\nosc_freq = tegra114_input_freq[val >> OSC_CTRL_OSC_FREQ_SHIFT];\r\nif (!osc_freq) {\r\nWARN_ON(1);\r\nreturn -EINVAL;\r\n}\r\nclk = clk_register_fixed_rate(NULL, "clk_m", NULL, CLK_IS_ROOT,\r\nosc_freq);\r\nclks[TEGRA114_CLK_CLK_M] = clk;\r\nval = (val >> OSC_CTRL_PLL_REF_DIV_SHIFT) & 3;\r\npll_ref_div = 1 << val;\r\nclk = clk_register_fixed_factor(NULL, "pll_ref", "clk_m",\r\nCLK_SET_RATE_PARENT, 1, pll_ref_div);\r\nclks[TEGRA114_CLK_PLL_REF] = clk;\r\npll_ref_freq = osc_freq / pll_ref_div;\r\nreturn 0;\r\n}\r\nstatic void __init tegra114_fixed_clk_init(void __iomem *clk_base)\r\n{\r\nstruct clk *clk;\r\nclk = clk_register_fixed_rate(NULL, "clk_32k", NULL, CLK_IS_ROOT,\r\n32768);\r\nclks[TEGRA114_CLK_CLK_32K] = clk;\r\nclk = clk_register_fixed_factor(NULL, "clk_m_div2", "clk_m",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclks[TEGRA114_CLK_CLK_M_DIV2] = clk;\r\nclk = clk_register_fixed_factor(NULL, "clk_m_div4", "clk_m",\r\nCLK_SET_RATE_PARENT, 1, 4);\r\nclks[TEGRA114_CLK_CLK_M_DIV4] = clk;\r\n}\r\nstatic __init void tegra114_utmi_param_configure(void __iomem *clk_base)\r\n{\r\nu32 reg;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(utmi_parameters); i++) {\r\nif (osc_freq == utmi_parameters[i].osc_frequency)\r\nbreak;\r\n}\r\nif (i >= ARRAY_SIZE(utmi_parameters)) {\r\npr_err("%s: Unexpected oscillator freq %lu\n", __func__,\r\nosc_freq);\r\nreturn;\r\n}\r\nreg = readl_relaxed(clk_base + UTMIP_PLL_CFG2);\r\nreg &= ~UTMIP_PLL_CFG2_STABLE_COUNT(~0);\r\nreg |= UTMIP_PLL_CFG2_STABLE_COUNT(utmi_parameters[i].stable_count);\r\nreg &= ~UTMIP_PLL_CFG2_ACTIVE_DLY_COUNT(~0);\r\nreg |= UTMIP_PLL_CFG2_ACTIVE_DLY_COUNT(utmi_parameters[i].\r\nactive_delay_count);\r\nreg &= ~UTMIP_PLL_CFG2_FORCE_PD_SAMP_A_POWERDOWN;\r\nreg &= ~UTMIP_PLL_CFG2_FORCE_PD_SAMP_B_POWERDOWN;\r\nreg &= ~UTMIP_PLL_CFG2_FORCE_PD_SAMP_C_POWERDOWN;\r\nwritel_relaxed(reg, clk_base + UTMIP_PLL_CFG2);\r\nreg = readl_relaxed(clk_base + UTMIP_PLL_CFG1);\r\nreg &= ~UTMIP_PLL_CFG1_ENABLE_DLY_COUNT(~0);\r\nreg |= UTMIP_PLL_CFG1_ENABLE_DLY_COUNT(utmi_parameters[i].\r\nenable_delay_count);\r\nreg &= ~UTMIP_PLL_CFG1_XTAL_FREQ_COUNT(~0);\r\nreg |= UTMIP_PLL_CFG1_XTAL_FREQ_COUNT(utmi_parameters[i].\r\nxtal_freq_count);\r\nreg &= ~UTMIP_PLL_CFG1_FORCE_PLL_ENABLE_POWERDOWN;\r\nreg &= ~UTMIP_PLL_CFG1_FORCE_PLL_ACTIVE_POWERDOWN;\r\nreg &= ~UTMIP_PLL_CFG1_FORCE_PLLU_POWERUP;\r\nreg &= ~UTMIP_PLL_CFG1_FORCE_PLLU_POWERDOWN;\r\nwritel_relaxed(reg, clk_base + UTMIP_PLL_CFG1);\r\nreg = readl_relaxed(clk_base + UTMIPLL_HW_PWRDN_CFG0);\r\nreg |= UTMIPLL_HW_PWRDN_CFG0_USE_LOCKDET;\r\nreg &= ~UTMIPLL_HW_PWRDN_CFG0_CLK_ENABLE_SWCTL;\r\nreg |= UTMIPLL_HW_PWRDN_CFG0_SEQ_START_STATE;\r\nwritel_relaxed(reg, clk_base + UTMIPLL_HW_PWRDN_CFG0);\r\nreg = readl_relaxed(clk_base + UTMIP_PLL_CFG1);\r\nreg &= ~UTMIP_PLL_CFG1_FORCE_PLL_ENABLE_POWERUP;\r\nreg &= ~UTMIP_PLL_CFG1_FORCE_PLL_ENABLE_POWERDOWN;\r\nwritel_relaxed(reg, clk_base + UTMIP_PLL_CFG1);\r\nudelay(1);\r\nreg = readl_relaxed(clk_base + UTMIPLL_HW_PWRDN_CFG0);\r\nreg |= UTMIPLL_HW_PWRDN_CFG0_IDDQ_SWCTL;\r\nreg &= ~UTMIPLL_HW_PWRDN_CFG0_IDDQ_OVERRIDE;\r\nwritel_relaxed(reg, clk_base + UTMIPLL_HW_PWRDN_CFG0);\r\nudelay(1);\r\nreg = readl_relaxed(clk_base + UTMIPLL_HW_PWRDN_CFG0);\r\nreg |= UTMIPLL_HW_PWRDN_CFG0_SEQ_ENABLE;\r\nwritel_relaxed(reg, clk_base + UTMIPLL_HW_PWRDN_CFG0);\r\n}\r\nstatic void __init tegra114_pll_init(void __iomem *clk_base,\r\nvoid __iomem *pmc)\r\n{\r\nu32 val;\r\nstruct clk *clk;\r\nclk = tegra_clk_register_pllxc("pll_c", "pll_ref", clk_base,\r\npmc, 0, &pll_c_params, NULL);\r\nclks[TEGRA114_CLK_PLL_C] = clk;\r\nclk = tegra_clk_register_divider("pll_c_out1_div", "pll_c",\r\nclk_base + PLLC_OUT, 0, TEGRA_DIVIDER_ROUND_UP,\r\n8, 8, 1, NULL);\r\nclk = tegra_clk_register_pll_out("pll_c_out1", "pll_c_out1_div",\r\nclk_base + PLLC_OUT, 1, 0,\r\nCLK_SET_RATE_PARENT, 0, NULL);\r\nclks[TEGRA114_CLK_PLL_C_OUT1] = clk;\r\nclk = tegra_clk_register_pllc("pll_c2", "pll_ref", clk_base, pmc, 0,\r\n&pll_c2_params, NULL);\r\nclks[TEGRA114_CLK_PLL_C2] = clk;\r\nclk = tegra_clk_register_pllc("pll_c3", "pll_ref", clk_base, pmc, 0,\r\n&pll_c3_params, NULL);\r\nclks[TEGRA114_CLK_PLL_C3] = clk;\r\nclk = tegra_clk_register_pllm("pll_m", "pll_ref", clk_base, pmc,\r\nCLK_IGNORE_UNUSED | CLK_SET_RATE_GATE,\r\n&pll_m_params, NULL);\r\nclks[TEGRA114_CLK_PLL_M] = clk;\r\nclk = tegra_clk_register_divider("pll_m_out1_div", "pll_m",\r\nclk_base + PLLM_OUT, 0, TEGRA_DIVIDER_ROUND_UP,\r\n8, 8, 1, NULL);\r\nclk = tegra_clk_register_pll_out("pll_m_out1", "pll_m_out1_div",\r\nclk_base + PLLM_OUT, 1, 0, CLK_IGNORE_UNUSED |\r\nCLK_SET_RATE_PARENT, 0, NULL);\r\nclks[TEGRA114_CLK_PLL_M_OUT1] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_m_ud", "pll_m",\r\nCLK_SET_RATE_PARENT, 1, 1);\r\nval = readl(clk_base + pll_u_params.base_reg);\r\nval &= ~BIT(24);\r\nwritel(val, clk_base + pll_u_params.base_reg);\r\nclk = tegra_clk_register_pll("pll_u", "pll_ref", clk_base, pmc, 0,\r\n&pll_u_params, &pll_u_lock);\r\nclks[TEGRA114_CLK_PLL_U] = clk;\r\ntegra114_utmi_param_configure(clk_base);\r\nclk = clk_register_gate(NULL, "pll_u_480M", "pll_u",\r\nCLK_SET_RATE_PARENT, clk_base + PLLU_BASE,\r\n22, 0, &pll_u_lock);\r\nclks[TEGRA114_CLK_PLL_U_480M] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_u_60M", "pll_u",\r\nCLK_SET_RATE_PARENT, 1, 8);\r\nclks[TEGRA114_CLK_PLL_U_60M] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_u_48M", "pll_u",\r\nCLK_SET_RATE_PARENT, 1, 10);\r\nclks[TEGRA114_CLK_PLL_U_48M] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_u_12M", "pll_u",\r\nCLK_SET_RATE_PARENT, 1, 40);\r\nclks[TEGRA114_CLK_PLL_U_12M] = clk;\r\nclk = tegra_clk_register_pll("pll_d", "pll_ref", clk_base, pmc, 0,\r\n&pll_d_params, &pll_d_lock);\r\nclks[TEGRA114_CLK_PLL_D] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_d_out0", "pll_d",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclks[TEGRA114_CLK_PLL_D_OUT0] = clk;\r\nclk = tegra_clk_register_pll("pll_d2", "pll_ref", clk_base, pmc, 0,\r\n&pll_d2_params, &pll_d2_lock);\r\nclks[TEGRA114_CLK_PLL_D2] = clk;\r\nclk = clk_register_fixed_factor(NULL, "pll_d2_out0", "pll_d2",\r\nCLK_SET_RATE_PARENT, 1, 2);\r\nclks[TEGRA114_CLK_PLL_D2_OUT0] = clk;\r\nclk = tegra_clk_register_pllre("pll_re_vco", "pll_ref", clk_base, pmc,\r\n0, &pll_re_vco_params, &pll_re_lock, pll_ref_freq);\r\nclks[TEGRA114_CLK_PLL_RE_VCO] = clk;\r\nclk = clk_register_divider_table(NULL, "pll_re_out", "pll_re_vco", 0,\r\nclk_base + PLLRE_BASE, 16, 4, 0,\r\npll_re_div_table, &pll_re_lock);\r\nclks[TEGRA114_CLK_PLL_RE_OUT] = clk;\r\nclk = tegra_clk_register_plle_tegra114("pll_e_out0", "pll_ref",\r\nclk_base, 0, &pll_e_params, NULL);\r\nclks[TEGRA114_CLK_PLL_E_OUT0] = clk;\r\n}\r\nstatic __init void tegra114_periph_clk_init(void __iomem *clk_base,\r\nvoid __iomem *pmc_base)\r\n{\r\nstruct clk *clk;\r\nu32 val;\r\nval = readl(clk_base + CLK_SOURCE_XUSB_SS_SRC);\r\nval |= BIT(25);\r\nwritel(val, clk_base + CLK_SOURCE_XUSB_SS_SRC);\r\nclk = clk_register_fixed_factor(NULL, "xusb_hs_src", "pll_u_60M", 0,\r\n1, 1);\r\nclks[TEGRA114_CLK_XUSB_HS_SRC] = clk;\r\nclk = clk_register_mux(NULL, "dsia_mux", mux_plld_out0_plld2_out0,\r\nARRAY_SIZE(mux_plld_out0_plld2_out0),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + PLLD_BASE, 25, 1, 0, &pll_d_lock);\r\nclks[TEGRA114_CLK_DSIA_MUX] = clk;\r\nclk = clk_register_mux(NULL, "dsib_mux", mux_plld_out0_plld2_out0,\r\nARRAY_SIZE(mux_plld_out0_plld2_out0),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + PLLD2_BASE, 25, 1, 0, &pll_d2_lock);\r\nclks[TEGRA114_CLK_DSIB_MUX] = clk;\r\nclk = clk_register_mux(NULL, "emc_mux", mux_pllmcp_clkm,\r\nARRAY_SIZE(mux_pllmcp_clkm),\r\nCLK_SET_RATE_NO_REPARENT,\r\nclk_base + CLK_SOURCE_EMC,\r\n29, 3, 0, NULL);\r\ntegra_periph_clk_init(clk_base, pmc_base, tegra114_clks,\r\n&pll_p_params);\r\n}\r\nstatic void tegra114_wait_cpu_in_reset(u32 cpu)\r\n{\r\nunsigned int reg;\r\ndo {\r\nreg = readl(clk_base + CLK_RST_CONTROLLER_CPU_CMPLX_STATUS);\r\ncpu_relax();\r\n} while (!(reg & (1 << cpu)));\r\n}\r\nstatic void tegra114_disable_cpu_clock(u32 cpu)\r\n{\r\n}\r\nstatic void tegra114_cpu_clock_suspend(void)\r\n{\r\ntegra114_cpu_clk_sctx.clk_csite_src =\r\nreadl(clk_base + CLK_SOURCE_CSITE);\r\nwritel(3 << 30, clk_base + CLK_SOURCE_CSITE);\r\ntegra114_cpu_clk_sctx.cclkg_burst =\r\nreadl(clk_base + CCLKG_BURST_POLICY);\r\ntegra114_cpu_clk_sctx.cclkg_divider =\r\nreadl(clk_base + CCLKG_BURST_POLICY + 4);\r\n}\r\nstatic void tegra114_cpu_clock_resume(void)\r\n{\r\nwritel(tegra114_cpu_clk_sctx.clk_csite_src,\r\nclk_base + CLK_SOURCE_CSITE);\r\nwritel(tegra114_cpu_clk_sctx.cclkg_burst,\r\nclk_base + CCLKG_BURST_POLICY);\r\nwritel(tegra114_cpu_clk_sctx.cclkg_divider,\r\nclk_base + CCLKG_BURST_POLICY + 4);\r\n}\r\nstatic void __init tegra114_clock_apply_init_table(void)\r\n{\r\ntegra_init_from_table(init_table, clks, TEGRA114_CLK_CLK_MAX);\r\n}\r\nstatic void tegra114_car_barrier(void)\r\n{\r\nwmb();\r\nreadl_relaxed(clk_base + CPU_FINETRIM_SELECT);\r\n}\r\nvoid tegra114_clock_tune_cpu_trimmers_high(void)\r\n{\r\nu32 select = 0;\r\nselect |= ~(CPU_FINETRIM_1_FCPU_1 | CPU_FINETRIM_1_FCPU_2 |\r\nCPU_FINETRIM_1_FCPU_3 | CPU_FINETRIM_1_FCPU_4 |\r\nCPU_FINETRIM_1_FCPU_5 | CPU_FINETRIM_1_FCPU_6);\r\nwritel_relaxed(select, clk_base + CPU_FINETRIM_SELECT);\r\ntegra114_car_barrier();\r\n}\r\nvoid tegra114_clock_tune_cpu_trimmers_low(void)\r\n{\r\nu32 select = 0;\r\nselect |= (CPU_FINETRIM_1_FCPU_1 | CPU_FINETRIM_1_FCPU_2 |\r\nCPU_FINETRIM_1_FCPU_3 | CPU_FINETRIM_1_FCPU_4 |\r\nCPU_FINETRIM_1_FCPU_5 | CPU_FINETRIM_1_FCPU_6);\r\nwritel_relaxed(select, clk_base + CPU_FINETRIM_SELECT);\r\ntegra114_car_barrier();\r\n}\r\nvoid tegra114_clock_tune_cpu_trimmers_init(void)\r\n{\r\nu32 dr = 0, r = 0;\r\nr |= (CPU_FINETRIM_R_FCPU_1_MASK | CPU_FINETRIM_R_FCPU_2_MASK |\r\nCPU_FINETRIM_R_FCPU_3_MASK | CPU_FINETRIM_R_FCPU_4_MASK |\r\nCPU_FINETRIM_R_FCPU_5_MASK | CPU_FINETRIM_R_FCPU_6_MASK);\r\nwritel_relaxed(r, clk_base + CPU_FINETRIM_R);\r\ndr |= (CPU_FINETRIM_1_FCPU_1 | CPU_FINETRIM_1_FCPU_2 |\r\nCPU_FINETRIM_1_FCPU_3 | CPU_FINETRIM_1_FCPU_4 |\r\nCPU_FINETRIM_1_FCPU_5 | CPU_FINETRIM_1_FCPU_6);\r\nwritel_relaxed(dr, clk_base + CPU_FINETRIM_DR);\r\ntegra114_clock_tune_cpu_trimmers_low();\r\n}\r\nvoid tegra114_clock_assert_dfll_dvco_reset(void)\r\n{\r\nu32 v;\r\nv = readl_relaxed(clk_base + RST_DFLL_DVCO);\r\nv |= (1 << DVFS_DFLL_RESET_SHIFT);\r\nwritel_relaxed(v, clk_base + RST_DFLL_DVCO);\r\ntegra114_car_barrier();\r\n}\r\nvoid tegra114_clock_deassert_dfll_dvco_reset(void)\r\n{\r\nu32 v;\r\nv = readl_relaxed(clk_base + RST_DFLL_DVCO);\r\nv &= ~(1 << DVFS_DFLL_RESET_SHIFT);\r\nwritel_relaxed(v, clk_base + RST_DFLL_DVCO);\r\ntegra114_car_barrier();\r\n}\r\nstatic void __init tegra114_clock_init(struct device_node *np)\r\n{\r\nstruct device_node *node;\r\nclk_base = of_iomap(np, 0);\r\nif (!clk_base) {\r\npr_err("ioremap tegra114 CAR failed\n");\r\nreturn;\r\n}\r\nnode = of_find_matching_node(NULL, pmc_match);\r\nif (!node) {\r\npr_err("Failed to find pmc node\n");\r\nWARN_ON(1);\r\nreturn;\r\n}\r\npmc_base = of_iomap(node, 0);\r\nif (!pmc_base) {\r\npr_err("Can't map pmc registers\n");\r\nWARN_ON(1);\r\nreturn;\r\n}\r\nclks = tegra_clk_init(clk_base, TEGRA114_CLK_CLK_MAX,\r\nTEGRA114_CLK_PERIPH_BANKS);\r\nif (!clks)\r\nreturn;\r\nif (tegra114_osc_clk_init(clk_base) < 0)\r\nreturn;\r\ntegra114_fixed_clk_init(clk_base);\r\ntegra114_pll_init(clk_base, pmc_base);\r\ntegra114_periph_clk_init(clk_base, pmc_base);\r\ntegra_audio_clk_init(clk_base, pmc_base, tegra114_clks, &pll_a_params);\r\ntegra_pmc_clk_init(pmc_base, tegra114_clks);\r\ntegra_super_clk_gen4_init(clk_base, pmc_base, tegra114_clks,\r\n&pll_x_params);\r\ntegra_add_of_provider(np);\r\ntegra_register_devclks(devclks, ARRAY_SIZE(devclks));\r\ntegra_clk_apply_init_table = tegra114_clock_apply_init_table;\r\ntegra_cpu_car_ops = &tegra114_cpu_car_ops;\r\n}

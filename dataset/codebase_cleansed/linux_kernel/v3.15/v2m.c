static void __init v2m_sp804_init(void __iomem *base, unsigned int irq)\r\n{\r\nif (WARN_ON(!base || irq == NO_IRQ))\r\nreturn;\r\nsp804_clocksource_init(base + TIMER_2_BASE, "v2m-timer1");\r\nsp804_clockevents_init(base + TIMER_1_BASE, irq, "v2m-timer0");\r\n}\r\nstatic void __init v2m_timer_init(void)\r\n{\r\nvexpress_clk_init(ioremap(V2M_SYSCTL, SZ_4K));\r\nv2m_sp804_init(ioremap(V2M_TIMER01, SZ_4K), IRQ_V2M_TIMER0);\r\n}\r\nstatic void __init v2m_init_early(void)\r\n{\r\nif (ct_desc->init_early)\r\nct_desc->init_early();\r\nversatile_sched_clock_init(vexpress_get_24mhz_clock_base(), 24000000);\r\n}\r\nstatic void __init v2m_populate_ct_desc(void)\r\n{\r\nint i;\r\nu32 current_tile_id;\r\nct_desc = NULL;\r\ncurrent_tile_id = vexpress_get_procid(VEXPRESS_SITE_MASTER)\r\n& V2M_CT_ID_MASK;\r\nfor (i = 0; i < ARRAY_SIZE(ct_descs) && !ct_desc; ++i)\r\nif (ct_descs[i]->id == current_tile_id)\r\nct_desc = ct_descs[i];\r\nif (!ct_desc)\r\npanic("vexpress: this kernel does not support core tile ID 0x%08x when booting via ATAGs.\n"\r\n"You may need a device tree blob or a different kernel to boot on this board.\n",\r\ncurrent_tile_id);\r\n}\r\nstatic void __init v2m_map_io(void)\r\n{\r\niotable_init(v2m_io_desc, ARRAY_SIZE(v2m_io_desc));\r\nvexpress_sysreg_early_init(ioremap(V2M_SYSREGS, SZ_4K));\r\nv2m_populate_ct_desc();\r\nct_desc->map_io();\r\n}\r\nstatic void __init v2m_init_irq(void)\r\n{\r\nct_desc->init_irq();\r\n}\r\nstatic void __init v2m_init(void)\r\n{\r\nint i;\r\nregulator_register_fixed(0, v2m_eth_supplies,\r\nARRAY_SIZE(v2m_eth_supplies));\r\nplatform_device_register(&v2m_muxfpga_device);\r\nplatform_device_register(&v2m_shutdown_device);\r\nplatform_device_register(&v2m_reboot_device);\r\nplatform_device_register(&v2m_dvimode_device);\r\nplatform_device_register(&v2m_sysreg_device);\r\nplatform_device_register(&v2m_pcie_i2c_device);\r\nplatform_device_register(&v2m_ddc_i2c_device);\r\nplatform_device_register(&v2m_flash_device);\r\nplatform_device_register(&v2m_cf_device);\r\nplatform_device_register(&v2m_eth_device);\r\nplatform_device_register(&v2m_usb_device);\r\nfor (i = 0; i < ARRAY_SIZE(v2m_amba_devs); i++)\r\namba_device_register(v2m_amba_devs[i], &iomem_resource);\r\nct_desc->init_tile();\r\n}\r\nstatic int __init v2m_dt_scan_memory_map(unsigned long node, const char *uname,\r\nint depth, void *data)\r\n{\r\nconst char **map = data;\r\nif (strcmp(uname, "motherboard") != 0)\r\nreturn 0;\r\n*map = of_get_flat_dt_prop(node, "arm,v2m-memory-map", NULL);\r\nreturn 1;\r\n}\r\nvoid __init v2m_dt_map_io(void)\r\n{\r\nconst char *map = NULL;\r\nof_scan_flat_dt(v2m_dt_scan_memory_map, &map);\r\nif (map && strcmp(map, "rs1") == 0)\r\niotable_init(&v2m_rs1_io_desc, 1);\r\nelse\r\niotable_init(v2m_io_desc, ARRAY_SIZE(v2m_io_desc));\r\n#if defined(CONFIG_SMP)\r\nvexpress_dt_smp_map_io();\r\n#endif\r\n}\r\nvoid __init v2m_dt_init_early(void)\r\n{\r\nu32 dt_hbi;\r\nvexpress_sysreg_of_early_init();\r\nif (of_property_read_u32(of_allnodes, "arm,hbi", &dt_hbi) == 0) {\r\nu32 hbi = vexpress_get_hbi(VEXPRESS_SITE_MASTER);\r\nif (WARN_ON(dt_hbi != hbi))\r\npr_warning("vexpress: DT HBI (%x) is not matching "\r\n"hardware (%x)!\n", dt_hbi, hbi);\r\n}\r\nversatile_sched_clock_init(vexpress_get_24mhz_clock_base(), 24000000);\r\n}\r\nstatic void __init v2m_dt_init(void)\r\n{\r\nl2x0_of_init(0x00400000, 0xfe0fffff);\r\nof_platform_populate(NULL, v2m_dt_bus_match, NULL, NULL);\r\n}

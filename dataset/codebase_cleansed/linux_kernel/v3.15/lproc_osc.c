static int osc_active_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *dev = m->private;\r\nint rc;\r\nLPROCFS_CLIMP_CHECK(dev);\r\nrc = seq_printf(m, "%d\n", !dev->u.cli.cl_import->imp_deactive);\r\nLPROCFS_CLIMP_EXIT(dev);\r\nreturn rc;\r\n}\r\nstatic ssize_t osc_active_seq_write(struct file *file, const char *buffer,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct obd_device *dev = ((struct seq_file *)file->private_data)->private;\r\nint val, rc;\r\nrc = lprocfs_write_helper(buffer, count, &val);\r\nif (rc)\r\nreturn rc;\r\nif (val < 0 || val > 1)\r\nreturn -ERANGE;\r\nif (dev->u.cli.cl_import->imp_deactive == val)\r\nrc = ptlrpc_set_import_active(dev->u.cli.cl_import, val);\r\nelse\r\nCDEBUG(D_CONFIG, "activate %d: ignoring repeat request\n", val);\r\nreturn count;\r\n}\r\nstatic int osc_max_rpcs_in_flight_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *dev = m->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nint rc;\r\nclient_obd_list_lock(&cli->cl_loi_list_lock);\r\nrc = seq_printf(m, "%u\n", cli->cl_max_rpcs_in_flight);\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nreturn rc;\r\n}\r\nstatic ssize_t osc_max_rpcs_in_flight_seq_write(struct file *file,\r\nconst char *buffer, size_t count, loff_t *off)\r\n{\r\nstruct obd_device *dev = ((struct seq_file *)file->private_data)->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nstruct ptlrpc_request_pool *pool = cli->cl_import->imp_rq_pool;\r\nint val, rc;\r\nrc = lprocfs_write_helper(buffer, count, &val);\r\nif (rc)\r\nreturn rc;\r\nif (val < 1 || val > OSC_MAX_RIF_MAX)\r\nreturn -ERANGE;\r\nLPROCFS_CLIMP_CHECK(dev);\r\nif (pool && val > cli->cl_max_rpcs_in_flight)\r\npool->prp_populate(pool, val-cli->cl_max_rpcs_in_flight);\r\nclient_obd_list_lock(&cli->cl_loi_list_lock);\r\ncli->cl_max_rpcs_in_flight = val;\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nLPROCFS_CLIMP_EXIT(dev);\r\nreturn count;\r\n}\r\nstatic int osc_max_dirty_mb_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *dev = m->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nlong val;\r\nint mult;\r\nclient_obd_list_lock(&cli->cl_loi_list_lock);\r\nval = cli->cl_dirty_max;\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nmult = 1 << 20;\r\nreturn lprocfs_seq_read_frac_helper(m, val, mult);\r\n}\r\nstatic ssize_t osc_max_dirty_mb_seq_write(struct file *file, const char *buffer,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct obd_device *dev = ((struct seq_file *)file->private_data)->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nint pages_number, mult, rc;\r\nmult = 1 << (20 - PAGE_CACHE_SHIFT);\r\nrc = lprocfs_write_frac_helper(buffer, count, &pages_number, mult);\r\nif (rc)\r\nreturn rc;\r\nif (pages_number <= 0 ||\r\npages_number > OSC_MAX_DIRTY_MB_MAX << (20 - PAGE_CACHE_SHIFT) ||\r\npages_number > totalram_pages / 4)\r\nreturn -ERANGE;\r\nclient_obd_list_lock(&cli->cl_loi_list_lock);\r\ncli->cl_dirty_max = (obd_count)(pages_number << PAGE_CACHE_SHIFT);\r\nosc_wake_cache_waiters(cli);\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nreturn count;\r\n}\r\nstatic int osc_cached_mb_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *dev = m->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nint shift = 20 - PAGE_CACHE_SHIFT;\r\nint rc;\r\nrc = seq_printf(m,\r\n"used_mb: %d\n"\r\n"busy_cnt: %d\n",\r\n(atomic_read(&cli->cl_lru_in_list) +\r\natomic_read(&cli->cl_lru_busy)) >> shift,\r\natomic_read(&cli->cl_lru_busy));\r\nreturn rc;\r\n}\r\nstatic ssize_t osc_cached_mb_seq_write(struct file *file, const char *buffer,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct obd_device *dev = ((struct seq_file *)file->private_data)->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nint pages_number, mult, rc;\r\nmult = 1 << (20 - PAGE_CACHE_SHIFT);\r\nbuffer = lprocfs_find_named_value(buffer, "used_mb:", &count);\r\nrc = lprocfs_write_frac_helper(buffer, count, &pages_number, mult);\r\nif (rc)\r\nreturn rc;\r\nif (pages_number < 0)\r\nreturn -ERANGE;\r\nrc = atomic_read(&cli->cl_lru_in_list) - pages_number;\r\nif (rc > 0)\r\n(void)osc_lru_shrink(cli, rc);\r\nreturn count;\r\n}\r\nstatic int osc_cur_dirty_bytes_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *dev = m->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nint rc;\r\nclient_obd_list_lock(&cli->cl_loi_list_lock);\r\nrc = seq_printf(m, "%lu\n", cli->cl_dirty);\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nreturn rc;\r\n}\r\nstatic int osc_cur_grant_bytes_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *dev = m->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nint rc;\r\nclient_obd_list_lock(&cli->cl_loi_list_lock);\r\nrc = seq_printf(m, "%lu\n", cli->cl_avail_grant);\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nreturn rc;\r\n}\r\nstatic ssize_t osc_cur_grant_bytes_seq_write(struct file *file, const char *buffer,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct obd_device *obd = ((struct seq_file *)file->private_data)->private;\r\nstruct client_obd *cli = &obd->u.cli;\r\nint rc;\r\n__u64 val;\r\nif (obd == NULL)\r\nreturn 0;\r\nrc = lprocfs_write_u64_helper(buffer, count, &val);\r\nif (rc)\r\nreturn rc;\r\nclient_obd_list_lock(&cli->cl_loi_list_lock);\r\nif (val >= cli->cl_avail_grant) {\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nreturn 0;\r\n}\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nLPROCFS_CLIMP_CHECK(obd);\r\nif (cli->cl_import->imp_state == LUSTRE_IMP_FULL)\r\nrc = osc_shrink_grant_to_target(cli, val);\r\nLPROCFS_CLIMP_EXIT(obd);\r\nif (rc)\r\nreturn rc;\r\nreturn count;\r\n}\r\nstatic int osc_cur_lost_grant_bytes_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *dev = m->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nint rc;\r\nclient_obd_list_lock(&cli->cl_loi_list_lock);\r\nrc = seq_printf(m, "%lu\n", cli->cl_lost_grant);\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nreturn rc;\r\n}\r\nstatic int osc_grant_shrink_interval_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *obd = m->private;\r\nif (obd == NULL)\r\nreturn 0;\r\nreturn seq_printf(m, "%d\n",\r\nobd->u.cli.cl_grant_shrink_interval);\r\n}\r\nstatic ssize_t osc_grant_shrink_interval_seq_write(struct file *file,\r\nconst char *buffer, size_t count, loff_t *off)\r\n{\r\nstruct obd_device *obd = ((struct seq_file *)file->private_data)->private;\r\nint val, rc;\r\nif (obd == NULL)\r\nreturn 0;\r\nrc = lprocfs_write_helper(buffer, count, &val);\r\nif (rc)\r\nreturn rc;\r\nif (val <= 0)\r\nreturn -ERANGE;\r\nobd->u.cli.cl_grant_shrink_interval = val;\r\nreturn count;\r\n}\r\nstatic int osc_checksum_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *obd = m->private;\r\nif (obd == NULL)\r\nreturn 0;\r\nreturn seq_printf(m, "%d\n",\r\nobd->u.cli.cl_checksum ? 1 : 0);\r\n}\r\nstatic ssize_t osc_checksum_seq_write(struct file *file, const char *buffer,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct obd_device *obd = ((struct seq_file *)file->private_data)->private;\r\nint val, rc;\r\nif (obd == NULL)\r\nreturn 0;\r\nrc = lprocfs_write_helper(buffer, count, &val);\r\nif (rc)\r\nreturn rc;\r\nobd->u.cli.cl_checksum = (val ? 1 : 0);\r\nreturn count;\r\n}\r\nstatic int osc_checksum_type_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *obd = m->private;\r\nint i;\r\nDECLARE_CKSUM_NAME;\r\nif (obd == NULL)\r\nreturn 0;\r\nfor (i = 0; i < ARRAY_SIZE(cksum_name); i++) {\r\nif (((1 << i) & obd->u.cli.cl_supp_cksum_types) == 0)\r\ncontinue;\r\nif (obd->u.cli.cl_cksum_type == (1 << i))\r\nseq_printf(m, "[%s] ", cksum_name[i]);\r\nelse\r\nseq_printf(m, "%s ", cksum_name[i]);\r\n}\r\nseq_printf(m, "\n");\r\nreturn 0;\r\n}\r\nstatic ssize_t osc_checksum_type_seq_write(struct file *file, const char *buffer,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct obd_device *obd = ((struct seq_file *)file->private_data)->private;\r\nint i;\r\nDECLARE_CKSUM_NAME;\r\nchar kernbuf[10];\r\nif (obd == NULL)\r\nreturn 0;\r\nif (count > sizeof(kernbuf) - 1)\r\nreturn -EINVAL;\r\nif (copy_from_user(kernbuf, buffer, count))\r\nreturn -EFAULT;\r\nif (count > 0 && kernbuf[count - 1] == '\n')\r\nkernbuf[count - 1] = '\0';\r\nelse\r\nkernbuf[count] = '\0';\r\nfor (i = 0; i < ARRAY_SIZE(cksum_name); i++) {\r\nif (((1 << i) & obd->u.cli.cl_supp_cksum_types) == 0)\r\ncontinue;\r\nif (!strcmp(kernbuf, cksum_name[i])) {\r\nobd->u.cli.cl_cksum_type = 1 << i;\r\nreturn count;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int osc_resend_count_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *obd = m->private;\r\nreturn seq_printf(m, "%u\n", atomic_read(&obd->u.cli.cl_resends));\r\n}\r\nstatic ssize_t osc_resend_count_seq_write(struct file *file, const char *buffer,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct obd_device *obd = ((struct seq_file *)file->private_data)->private;\r\nint val, rc;\r\nrc = lprocfs_write_helper(buffer, count, &val);\r\nif (rc)\r\nreturn rc;\r\nif (val < 0)\r\nreturn -EINVAL;\r\natomic_set(&obd->u.cli.cl_resends, val);\r\nreturn count;\r\n}\r\nstatic int osc_contention_seconds_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *obd = m->private;\r\nstruct osc_device *od = obd2osc_dev(obd);\r\nreturn seq_printf(m, "%u\n", od->od_contention_time);\r\n}\r\nstatic ssize_t osc_contention_seconds_seq_write(struct file *file, const char *buffer,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct obd_device *obd = ((struct seq_file *)file->private_data)->private;\r\nstruct osc_device *od = obd2osc_dev(obd);\r\nreturn lprocfs_write_helper(buffer, count, &od->od_contention_time) ?:\r\ncount;\r\n}\r\nstatic int osc_lockless_truncate_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *obd = m->private;\r\nstruct osc_device *od = obd2osc_dev(obd);\r\nreturn seq_printf(m, "%u\n", od->od_lockless_truncate);\r\n}\r\nstatic ssize_t osc_lockless_truncate_seq_write(struct file *file, const char *buffer,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct obd_device *obd = ((struct seq_file *)file->private_data)->private;\r\nstruct osc_device *od = obd2osc_dev(obd);\r\nreturn lprocfs_write_helper(buffer, count, &od->od_lockless_truncate) ?:\r\ncount;\r\n}\r\nstatic int osc_destroys_in_flight_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *obd = m->private;\r\nreturn seq_printf(m, "%u\n",\r\natomic_read(&obd->u.cli.cl_destroy_in_flight));\r\n}\r\nstatic int osc_obd_max_pages_per_rpc_seq_show(struct seq_file *m, void *v)\r\n{\r\nreturn lprocfs_obd_rd_max_pages_per_rpc(m, m->private);\r\n}\r\nstatic ssize_t osc_obd_max_pages_per_rpc_seq_write(struct file *file,\r\nconst char *buffer, size_t count, loff_t *off)\r\n{\r\nstruct obd_device *dev = ((struct seq_file *)file->private_data)->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nstruct obd_connect_data *ocd = &cli->cl_import->imp_connect_data;\r\nint chunk_mask, rc;\r\n__u64 val;\r\nrc = lprocfs_write_u64_helper(buffer, count, &val);\r\nif (rc)\r\nreturn rc;\r\nif (val >= ONE_MB_BRW_SIZE)\r\nval >>= PAGE_CACHE_SHIFT;\r\nLPROCFS_CLIMP_CHECK(dev);\r\nchunk_mask = ~((1 << (cli->cl_chunkbits - PAGE_CACHE_SHIFT)) - 1);\r\nval = (val + ~chunk_mask) & chunk_mask;\r\nif (val == 0 || val > ocd->ocd_brw_size >> PAGE_CACHE_SHIFT) {\r\nLPROCFS_CLIMP_EXIT(dev);\r\nreturn -ERANGE;\r\n}\r\nclient_obd_list_lock(&cli->cl_loi_list_lock);\r\ncli->cl_max_pages_per_rpc = val;\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nLPROCFS_CLIMP_EXIT(dev);\r\nreturn count;\r\n}\r\nstatic int osc_rpc_stats_seq_show(struct seq_file *seq, void *v)\r\n{\r\nstruct timeval now;\r\nstruct obd_device *dev = seq->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nunsigned long read_tot = 0, write_tot = 0, read_cum, write_cum;\r\nint i;\r\ndo_gettimeofday(&now);\r\nclient_obd_list_lock(&cli->cl_loi_list_lock);\r\nseq_printf(seq, "snapshot_time: %lu.%lu (secs.usecs)\n",\r\nnow.tv_sec, (unsigned long)now.tv_usec);\r\nseq_printf(seq, "read RPCs in flight: %d\n",\r\ncli->cl_r_in_flight);\r\nseq_printf(seq, "write RPCs in flight: %d\n",\r\ncli->cl_w_in_flight);\r\nseq_printf(seq, "pending write pages: %d\n",\r\natomic_read(&cli->cl_pending_w_pages));\r\nseq_printf(seq, "pending read pages: %d\n",\r\natomic_read(&cli->cl_pending_r_pages));\r\nseq_printf(seq, "\n\t\t\tread\t\t\twrite\n");\r\nseq_printf(seq, "pages per rpc rpcs %% cum %% |");\r\nseq_printf(seq, " rpcs %% cum %%\n");\r\nread_tot = lprocfs_oh_sum(&cli->cl_read_page_hist);\r\nwrite_tot = lprocfs_oh_sum(&cli->cl_write_page_hist);\r\nread_cum = 0;\r\nwrite_cum = 0;\r\nfor (i = 0; i < OBD_HIST_MAX; i++) {\r\nunsigned long r = cli->cl_read_page_hist.oh_buckets[i];\r\nunsigned long w = cli->cl_write_page_hist.oh_buckets[i];\r\nread_cum += r;\r\nwrite_cum += w;\r\nseq_printf(seq, "%d:\t\t%10lu %3lu %3lu | %10lu %3lu %3lu\n",\r\n1 << i, r, pct(r, read_tot),\r\npct(read_cum, read_tot), w,\r\npct(w, write_tot),\r\npct(write_cum, write_tot));\r\nif (read_cum == read_tot && write_cum == write_tot)\r\nbreak;\r\n}\r\nseq_printf(seq, "\n\t\t\tread\t\t\twrite\n");\r\nseq_printf(seq, "rpcs in flight rpcs %% cum %% |");\r\nseq_printf(seq, " rpcs %% cum %%\n");\r\nread_tot = lprocfs_oh_sum(&cli->cl_read_rpc_hist);\r\nwrite_tot = lprocfs_oh_sum(&cli->cl_write_rpc_hist);\r\nread_cum = 0;\r\nwrite_cum = 0;\r\nfor (i = 0; i < OBD_HIST_MAX; i++) {\r\nunsigned long r = cli->cl_read_rpc_hist.oh_buckets[i];\r\nunsigned long w = cli->cl_write_rpc_hist.oh_buckets[i];\r\nread_cum += r;\r\nwrite_cum += w;\r\nseq_printf(seq, "%d:\t\t%10lu %3lu %3lu | %10lu %3lu %3lu\n",\r\ni, r, pct(r, read_tot),\r\npct(read_cum, read_tot), w,\r\npct(w, write_tot),\r\npct(write_cum, write_tot));\r\nif (read_cum == read_tot && write_cum == write_tot)\r\nbreak;\r\n}\r\nseq_printf(seq, "\n\t\t\tread\t\t\twrite\n");\r\nseq_printf(seq, "offset rpcs %% cum %% |");\r\nseq_printf(seq, " rpcs %% cum %%\n");\r\nread_tot = lprocfs_oh_sum(&cli->cl_read_offset_hist);\r\nwrite_tot = lprocfs_oh_sum(&cli->cl_write_offset_hist);\r\nread_cum = 0;\r\nwrite_cum = 0;\r\nfor (i = 0; i < OBD_HIST_MAX; i++) {\r\nunsigned long r = cli->cl_read_offset_hist.oh_buckets[i];\r\nunsigned long w = cli->cl_write_offset_hist.oh_buckets[i];\r\nread_cum += r;\r\nwrite_cum += w;\r\nseq_printf(seq, "%d:\t\t%10lu %3lu %3lu | %10lu %3lu %3lu\n",\r\n(i == 0) ? 0 : 1 << (i - 1),\r\nr, pct(r, read_tot), pct(read_cum, read_tot),\r\nw, pct(w, write_tot), pct(write_cum, write_tot));\r\nif (read_cum == read_tot && write_cum == write_tot)\r\nbreak;\r\n}\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nreturn 0;\r\n}\r\nstatic ssize_t osc_rpc_stats_seq_write(struct file *file, const char *buf,\r\nsize_t len, loff_t *off)\r\n{\r\nstruct seq_file *seq = file->private_data;\r\nstruct obd_device *dev = seq->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nlprocfs_oh_clear(&cli->cl_read_rpc_hist);\r\nlprocfs_oh_clear(&cli->cl_write_rpc_hist);\r\nlprocfs_oh_clear(&cli->cl_read_page_hist);\r\nlprocfs_oh_clear(&cli->cl_write_page_hist);\r\nlprocfs_oh_clear(&cli->cl_read_offset_hist);\r\nlprocfs_oh_clear(&cli->cl_write_offset_hist);\r\nreturn len;\r\n}\r\nstatic int osc_stats_seq_show(struct seq_file *seq, void *v)\r\n{\r\nstruct timeval now;\r\nstruct obd_device *dev = seq->private;\r\nstruct osc_stats *stats = &obd2osc_dev(dev)->od_stats;\r\ndo_gettimeofday(&now);\r\nseq_printf(seq, "snapshot_time: %lu.%lu (secs.usecs)\n",\r\nnow.tv_sec, (unsigned long)now.tv_usec);\r\nseq_printf(seq, "lockless_write_bytes\t\t"LPU64"\n",\r\nstats->os_lockless_writes);\r\nseq_printf(seq, "lockless_read_bytes\t\t"LPU64"\n",\r\nstats->os_lockless_reads);\r\nseq_printf(seq, "lockless_truncate\t\t"LPU64"\n",\r\nstats->os_lockless_truncates);\r\nreturn 0;\r\n}\r\nstatic ssize_t osc_stats_seq_write(struct file *file, const char *buf,\r\nsize_t len, loff_t *off)\r\n{\r\nstruct seq_file *seq = file->private_data;\r\nstruct obd_device *dev = seq->private;\r\nstruct osc_stats *stats = &obd2osc_dev(dev)->od_stats;\r\nmemset(stats, 0, sizeof(*stats));\r\nreturn len;\r\n}\r\nint lproc_osc_attach_seqstat(struct obd_device *dev)\r\n{\r\nint rc;\r\nrc = lprocfs_seq_create(dev->obd_proc_entry, "osc_stats", 0644,\r\n&osc_stats_fops, dev);\r\nif (rc == 0)\r\nrc = lprocfs_obd_seq_create(dev, "rpc_stats", 0644,\r\n&osc_rpc_stats_fops, dev);\r\nreturn rc;\r\n}\r\nvoid lprocfs_osc_init_vars(struct lprocfs_static_vars *lvars)\r\n{\r\nlvars->module_vars = lprocfs_osc_module_vars;\r\nlvars->obd_vars = lprocfs_osc_obd_vars;\r\n}

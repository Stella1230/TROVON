void kvmppc_init_timing_stats(struct kvm_vcpu *vcpu)\r\n{\r\nint i;\r\nmutex_lock(&vcpu->arch.exit_timing_lock);\r\nvcpu->arch.last_exit_type = 0xDEAD;\r\nfor (i = 0; i < __NUMBER_OF_KVM_EXIT_TYPES; i++) {\r\nvcpu->arch.timing_count_type[i] = 0;\r\nvcpu->arch.timing_max_duration[i] = 0;\r\nvcpu->arch.timing_min_duration[i] = 0xFFFFFFFF;\r\nvcpu->arch.timing_sum_duration[i] = 0;\r\nvcpu->arch.timing_sum_quad_duration[i] = 0;\r\n}\r\nvcpu->arch.timing_last_exit = 0;\r\nvcpu->arch.timing_exit.tv64 = 0;\r\nvcpu->arch.timing_last_enter.tv64 = 0;\r\nmutex_unlock(&vcpu->arch.exit_timing_lock);\r\n}\r\nstatic void add_exit_timing(struct kvm_vcpu *vcpu, u64 duration, int type)\r\n{\r\nu64 old;\r\nmutex_lock(&vcpu->arch.exit_timing_lock);\r\nvcpu->arch.timing_count_type[type]++;\r\nold = vcpu->arch.timing_sum_duration[type];\r\nvcpu->arch.timing_sum_duration[type] += duration;\r\nif (unlikely(old > vcpu->arch.timing_sum_duration[type])) {\r\nprintk(KERN_ERR"%s - wrap adding sum of durations"\r\n" old %lld new %lld type %d exit # of type %d\n",\r\n__func__, old, vcpu->arch.timing_sum_duration[type],\r\ntype, vcpu->arch.timing_count_type[type]);\r\n}\r\nold = vcpu->arch.timing_sum_quad_duration[type];\r\nvcpu->arch.timing_sum_quad_duration[type] += (duration*duration);\r\nif (unlikely(old > vcpu->arch.timing_sum_quad_duration[type])) {\r\nprintk(KERN_ERR"%s - wrap adding sum of squared durations"\r\n" old %lld new %lld type %d exit # of type %d\n",\r\n__func__, old,\r\nvcpu->arch.timing_sum_quad_duration[type],\r\ntype, vcpu->arch.timing_count_type[type]);\r\n}\r\nif (unlikely(duration < vcpu->arch.timing_min_duration[type]))\r\nvcpu->arch.timing_min_duration[type] = duration;\r\nif (unlikely(duration > vcpu->arch.timing_max_duration[type]))\r\nvcpu->arch.timing_max_duration[type] = duration;\r\nmutex_unlock(&vcpu->arch.exit_timing_lock);\r\n}\r\nvoid kvmppc_update_timing_stats(struct kvm_vcpu *vcpu)\r\n{\r\nu64 exit = vcpu->arch.timing_last_exit;\r\nu64 enter = vcpu->arch.timing_last_enter.tv64;\r\nvcpu->arch.timing_last_exit = vcpu->arch.timing_exit.tv64;\r\nif (unlikely(vcpu->arch.last_exit_type == 0xDEAD || exit == 0))\r\nreturn;\r\nadd_exit_timing(vcpu, (enter - exit), vcpu->arch.last_exit_type);\r\nadd_exit_timing(vcpu, (vcpu->arch.timing_last_exit - enter),\r\nTIMEINGUEST);\r\n}\r\nstatic int kvmppc_exit_timing_show(struct seq_file *m, void *private)\r\n{\r\nstruct kvm_vcpu *vcpu = m->private;\r\nint i;\r\nu64 min, max, sum, sum_quad;\r\nseq_printf(m, "%s", "type count min max sum sum_squared\n");\r\nfor (i = 0; i < __NUMBER_OF_KVM_EXIT_TYPES; i++) {\r\nmin = vcpu->arch.timing_min_duration[i];\r\ndo_div(min, tb_ticks_per_usec);\r\nmax = vcpu->arch.timing_max_duration[i];\r\ndo_div(max, tb_ticks_per_usec);\r\nsum = vcpu->arch.timing_sum_duration[i];\r\ndo_div(sum, tb_ticks_per_usec);\r\nsum_quad = vcpu->arch.timing_sum_quad_duration[i];\r\ndo_div(sum_quad, tb_ticks_per_usec);\r\nseq_printf(m, "%12s %10d %10lld %10lld %20lld %20lld\n",\r\nkvm_exit_names[i],\r\nvcpu->arch.timing_count_type[i],\r\nmin,\r\nmax,\r\nsum,\r\nsum_quad);\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t kvmppc_exit_timing_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nint err = -EINVAL;\r\nchar c;\r\nif (count > 1) {\r\ngoto done;\r\n}\r\nif (get_user(c, user_buf)) {\r\nerr = -EFAULT;\r\ngoto done;\r\n}\r\nif (c == 'c') {\r\nstruct seq_file *seqf = file->private_data;\r\nstruct kvm_vcpu *vcpu = seqf->private;\r\nmutex_lock(&seqf->lock);\r\nkvmppc_init_timing_stats(vcpu);\r\nmutex_unlock(&seqf->lock);\r\nerr = count;\r\n}\r\ndone:\r\nreturn err;\r\n}\r\nstatic int kvmppc_exit_timing_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, kvmppc_exit_timing_show, inode->i_private);\r\n}\r\nvoid kvmppc_create_vcpu_debugfs(struct kvm_vcpu *vcpu, unsigned int id)\r\n{\r\nstatic char dbg_fname[50];\r\nstruct dentry *debugfs_file;\r\nsnprintf(dbg_fname, sizeof(dbg_fname), "vm%u_vcpu%u_timing",\r\ncurrent->pid, id);\r\ndebugfs_file = debugfs_create_file(dbg_fname, 0666,\r\nkvm_debugfs_dir, vcpu,\r\n&kvmppc_exit_timing_fops);\r\nif (!debugfs_file) {\r\nprintk(KERN_ERR"%s: error creating debugfs file %s\n",\r\n__func__, dbg_fname);\r\nreturn;\r\n}\r\nvcpu->arch.debugfs_exit_timing = debugfs_file;\r\n}\r\nvoid kvmppc_remove_vcpu_debugfs(struct kvm_vcpu *vcpu)\r\n{\r\nif (vcpu->arch.debugfs_exit_timing) {\r\ndebugfs_remove(vcpu->arch.debugfs_exit_timing);\r\nvcpu->arch.debugfs_exit_timing = NULL;\r\n}\r\n}

void lockref_get(struct lockref *lockref)\r\n{\r\nCMPXCHG_LOOP(\r\nnew.count++;\r\n,\r\nreturn;\r\n);\r\nspin_lock(&lockref->lock);\r\nlockref->count++;\r\nspin_unlock(&lockref->lock);\r\n}\r\nint lockref_get_not_zero(struct lockref *lockref)\r\n{\r\nint retval;\r\nCMPXCHG_LOOP(\r\nnew.count++;\r\nif (!old.count)\r\nreturn 0;\r\n,\r\nreturn 1;\r\n);\r\nspin_lock(&lockref->lock);\r\nretval = 0;\r\nif (lockref->count) {\r\nlockref->count++;\r\nretval = 1;\r\n}\r\nspin_unlock(&lockref->lock);\r\nreturn retval;\r\n}\r\nint lockref_get_or_lock(struct lockref *lockref)\r\n{\r\nCMPXCHG_LOOP(\r\nnew.count++;\r\nif (!old.count)\r\nbreak;\r\n,\r\nreturn 1;\r\n);\r\nspin_lock(&lockref->lock);\r\nif (!lockref->count)\r\nreturn 0;\r\nlockref->count++;\r\nspin_unlock(&lockref->lock);\r\nreturn 1;\r\n}\r\nint lockref_put_or_lock(struct lockref *lockref)\r\n{\r\nCMPXCHG_LOOP(\r\nnew.count--;\r\nif (old.count <= 1)\r\nbreak;\r\n,\r\nreturn 1;\r\n);\r\nspin_lock(&lockref->lock);\r\nif (lockref->count <= 1)\r\nreturn 0;\r\nlockref->count--;\r\nspin_unlock(&lockref->lock);\r\nreturn 1;\r\n}\r\nvoid lockref_mark_dead(struct lockref *lockref)\r\n{\r\nassert_spin_locked(&lockref->lock);\r\nlockref->count = -128;\r\n}\r\nint lockref_get_not_dead(struct lockref *lockref)\r\n{\r\nint retval;\r\nCMPXCHG_LOOP(\r\nnew.count++;\r\nif ((int)old.count < 0)\r\nreturn 0;\r\n,\r\nreturn 1;\r\n);\r\nspin_lock(&lockref->lock);\r\nretval = 0;\r\nif ((int) lockref->count >= 0) {\r\nlockref->count++;\r\nretval = 1;\r\n}\r\nspin_unlock(&lockref->lock);\r\nreturn retval;\r\n}

static void tegra_fuse_enable_clk(void)\r\n{\r\nif (IS_ERR(fuse_clk))\r\nfuse_clk = clk_get_sys(NULL, "fuse");\r\nif (IS_ERR(fuse_clk))\r\nreturn;\r\nclk_prepare_enable(fuse_clk);\r\n}\r\nstatic void tegra_fuse_disable_clk(void)\r\n{\r\nif (IS_ERR(fuse_clk))\r\nreturn;\r\nclk_disable_unprepare(fuse_clk);\r\n}\r\nu32 tegra_fuse_readl(unsigned long offset)\r\n{\r\nreturn tegra_apb_readl(TEGRA_FUSE_BASE + offset);\r\n}\r\nbool tegra_spare_fuse(int bit)\r\n{\r\nbool ret;\r\ntegra_fuse_enable_clk();\r\nret = tegra_fuse_readl(tegra_fuse_spare_bit + bit * 4);\r\ntegra_fuse_disable_clk();\r\nreturn ret;\r\n}\r\nstatic enum tegra_revision tegra_get_revision(u32 id)\r\n{\r\nu32 minor_rev = (id >> 16) & 0xf;\r\nswitch (minor_rev) {\r\ncase 1:\r\nreturn TEGRA_REVISION_A01;\r\ncase 2:\r\nreturn TEGRA_REVISION_A02;\r\ncase 3:\r\nif (tegra_chip_id == TEGRA20 &&\r\n(tegra_spare_fuse(18) || tegra_spare_fuse(19)))\r\nreturn TEGRA_REVISION_A03p;\r\nelse\r\nreturn TEGRA_REVISION_A03;\r\ncase 4:\r\nreturn TEGRA_REVISION_A04;\r\ndefault:\r\nreturn TEGRA_REVISION_UNKNOWN;\r\n}\r\n}\r\nstatic void tegra_get_process_id(void)\r\n{\r\nu32 reg;\r\ntegra_fuse_enable_clk();\r\nreg = tegra_fuse_readl(tegra_fuse_spare_bit);\r\ntegra_cpu_process_id = (reg >> 6) & 3;\r\nreg = tegra_fuse_readl(tegra_fuse_spare_bit);\r\ntegra_core_process_id = (reg >> 12) & 3;\r\ntegra_fuse_disable_clk();\r\n}\r\nu32 tegra_read_chipid(void)\r\n{\r\nreturn readl_relaxed(IO_ADDRESS(TEGRA_APB_MISC_BASE) + 0x804);\r\n}\r\nstatic void __init tegra20_fuse_init_randomness(void)\r\n{\r\nu32 randomness[2];\r\nrandomness[0] = tegra_fuse_readl(FUSE_UID_LOW);\r\nrandomness[1] = tegra_fuse_readl(FUSE_UID_HIGH);\r\nadd_device_randomness(randomness, sizeof(randomness));\r\n}\r\nstatic void __init tegra30_fuse_init_randomness(void)\r\n{\r\nu32 randomness[7];\r\nrandomness[0] = tegra_fuse_readl(FUSE_VENDOR_CODE);\r\nrandomness[1] = tegra_fuse_readl(FUSE_FAB_CODE);\r\nrandomness[2] = tegra_fuse_readl(FUSE_LOT_CODE_0);\r\nrandomness[3] = tegra_fuse_readl(FUSE_LOT_CODE_1);\r\nrandomness[4] = tegra_fuse_readl(FUSE_WAFER_ID);\r\nrandomness[5] = tegra_fuse_readl(FUSE_X_COORDINATE);\r\nrandomness[6] = tegra_fuse_readl(FUSE_Y_COORDINATE);\r\nadd_device_randomness(randomness, sizeof(randomness));\r\n}\r\nvoid __init tegra_init_fuse(void)\r\n{\r\nu32 id;\r\nu32 randomness[5];\r\nu32 reg = readl(IO_ADDRESS(TEGRA_CLK_RESET_BASE + 0x48));\r\nreg |= 1 << 28;\r\nwritel(reg, IO_ADDRESS(TEGRA_CLK_RESET_BASE + 0x48));\r\nreg = readl(IO_ADDRESS(TEGRA_CLK_RESET_BASE + 0x14));\r\nreg |= 1 << 7;\r\nwritel(reg, IO_ADDRESS(TEGRA_CLK_RESET_BASE + 0x14));\r\nfuse_clk = ERR_PTR(-EINVAL);\r\nreg = tegra_fuse_readl(FUSE_SKU_INFO);\r\nrandomness[0] = reg;\r\ntegra_sku_id = reg & 0xFF;\r\nreg = tegra_apb_readl(TEGRA_APB_MISC_BASE + STRAP_OPT);\r\nrandomness[1] = reg;\r\ntegra_bct_strapping = (reg & RAM_ID_MASK) >> RAM_CODE_SHIFT;\r\nid = tegra_read_chipid();\r\nrandomness[2] = id;\r\ntegra_chip_id = (id >> 8) & 0xff;\r\nswitch (tegra_chip_id) {\r\ncase TEGRA20:\r\ntegra_fuse_spare_bit = TEGRA20_FUSE_SPARE_BIT;\r\ntegra_init_speedo_data = &tegra20_init_speedo_data;\r\nbreak;\r\ncase TEGRA30:\r\ntegra_fuse_spare_bit = TEGRA30_FUSE_SPARE_BIT;\r\ntegra_init_speedo_data = &tegra30_init_speedo_data;\r\nbreak;\r\ncase TEGRA114:\r\ntegra_init_speedo_data = &tegra114_init_speedo_data;\r\nbreak;\r\ndefault:\r\npr_warn("Tegra: unknown chip id %d\n", tegra_chip_id);\r\ntegra_fuse_spare_bit = TEGRA20_FUSE_SPARE_BIT;\r\ntegra_init_speedo_data = &tegra_get_process_id;\r\n}\r\ntegra_revision = tegra_get_revision(id);\r\ntegra_init_speedo_data();\r\nrandomness[3] = (tegra_cpu_process_id << 16) | tegra_core_process_id;\r\nrandomness[4] = (tegra_cpu_speedo_id << 16) | tegra_soc_speedo_id;\r\nadd_device_randomness(randomness, sizeof(randomness));\r\nswitch (tegra_chip_id) {\r\ncase TEGRA20:\r\ntegra20_fuse_init_randomness();\r\nbreak;\r\ncase TEGRA30:\r\ncase TEGRA114:\r\ndefault:\r\ntegra30_fuse_init_randomness();\r\nbreak;\r\n}\r\npr_info("Tegra Revision: %s SKU: %d CPU Process: %d Core Process: %d\n",\r\ntegra_revision_name[tegra_revision],\r\ntegra_sku_id, tegra_cpu_process_id,\r\ntegra_core_process_id);\r\n}

static inline int mbox_read_reg(size_t ofs)\r\n{\r\nreturn __raw_readw(mbox_base + ofs);\r\n}\r\nstatic inline void mbox_write_reg(u32 val, size_t ofs)\r\n{\r\n__raw_writew(val, mbox_base + ofs);\r\n}\r\nstatic mbox_msg_t omap1_mbox_fifo_read(struct omap_mbox *mbox)\r\n{\r\nstruct omap_mbox1_fifo *fifo =\r\n&((struct omap_mbox1_priv *)mbox->priv)->rx_fifo;\r\nmbox_msg_t msg;\r\nmsg = mbox_read_reg(fifo->data);\r\nmsg |= ((mbox_msg_t) mbox_read_reg(fifo->cmd)) << 16;\r\nreturn msg;\r\n}\r\nstatic void\r\nomap1_mbox_fifo_write(struct omap_mbox *mbox, mbox_msg_t msg)\r\n{\r\nstruct omap_mbox1_fifo *fifo =\r\n&((struct omap_mbox1_priv *)mbox->priv)->tx_fifo;\r\nmbox_write_reg(msg & 0xffff, fifo->data);\r\nmbox_write_reg(msg >> 16, fifo->cmd);\r\n}\r\nstatic int omap1_mbox_fifo_empty(struct omap_mbox *mbox)\r\n{\r\nreturn 0;\r\n}\r\nstatic int omap1_mbox_fifo_full(struct omap_mbox *mbox)\r\n{\r\nstruct omap_mbox1_fifo *fifo =\r\n&((struct omap_mbox1_priv *)mbox->priv)->rx_fifo;\r\nreturn mbox_read_reg(fifo->flag);\r\n}\r\nstatic void\r\nomap1_mbox_enable_irq(struct omap_mbox *mbox, omap_mbox_irq_t irq)\r\n{\r\nif (irq == IRQ_RX)\r\nenable_irq(mbox->irq);\r\n}\r\nstatic void\r\nomap1_mbox_disable_irq(struct omap_mbox *mbox, omap_mbox_irq_t irq)\r\n{\r\nif (irq == IRQ_RX)\r\ndisable_irq(mbox->irq);\r\n}\r\nstatic int\r\nomap1_mbox_is_irq(struct omap_mbox *mbox, omap_mbox_irq_t irq)\r\n{\r\nif (irq == IRQ_TX)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int omap1_mbox_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *mem;\r\nint ret;\r\nstruct omap_mbox **list;\r\nlist = omap1_mboxes;\r\nlist[0]->irq = platform_get_irq_byname(pdev, "dsp");\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!mem)\r\nreturn -ENOENT;\r\nmbox_base = ioremap(mem->start, resource_size(mem));\r\nif (!mbox_base)\r\nreturn -ENOMEM;\r\nret = omap_mbox_register(&pdev->dev, list);\r\nif (ret) {\r\niounmap(mbox_base);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int omap1_mbox_remove(struct platform_device *pdev)\r\n{\r\nomap_mbox_unregister();\r\niounmap(mbox_base);\r\nreturn 0;\r\n}\r\nstatic int __init omap1_mbox_init(void)\r\n{\r\nreturn platform_driver_register(&omap1_mbox_driver);\r\n}\r\nstatic void __exit omap1_mbox_exit(void)\r\n{\r\nplatform_driver_unregister(&omap1_mbox_driver);\r\n}

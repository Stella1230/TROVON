static struct phonet_net *phonet_pernet(struct net *net)\r\n{\r\nBUG_ON(!net);\r\nreturn net_generic(net, phonet_net_id);\r\n}\r\nstruct phonet_device_list *phonet_device_list(struct net *net)\r\n{\r\nstruct phonet_net *pnn = phonet_pernet(net);\r\nreturn &pnn->pndevs;\r\n}\r\nstatic struct phonet_device *__phonet_device_alloc(struct net_device *dev)\r\n{\r\nstruct phonet_device_list *pndevs = phonet_device_list(dev_net(dev));\r\nstruct phonet_device *pnd = kmalloc(sizeof(*pnd), GFP_ATOMIC);\r\nif (pnd == NULL)\r\nreturn NULL;\r\npnd->netdev = dev;\r\nbitmap_zero(pnd->addrs, 64);\r\nBUG_ON(!mutex_is_locked(&pndevs->lock));\r\nlist_add_rcu(&pnd->list, &pndevs->list);\r\nreturn pnd;\r\n}\r\nstatic struct phonet_device *__phonet_get(struct net_device *dev)\r\n{\r\nstruct phonet_device_list *pndevs = phonet_device_list(dev_net(dev));\r\nstruct phonet_device *pnd;\r\nBUG_ON(!mutex_is_locked(&pndevs->lock));\r\nlist_for_each_entry(pnd, &pndevs->list, list) {\r\nif (pnd->netdev == dev)\r\nreturn pnd;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct phonet_device *__phonet_get_rcu(struct net_device *dev)\r\n{\r\nstruct phonet_device_list *pndevs = phonet_device_list(dev_net(dev));\r\nstruct phonet_device *pnd;\r\nlist_for_each_entry_rcu(pnd, &pndevs->list, list) {\r\nif (pnd->netdev == dev)\r\nreturn pnd;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void phonet_device_destroy(struct net_device *dev)\r\n{\r\nstruct phonet_device_list *pndevs = phonet_device_list(dev_net(dev));\r\nstruct phonet_device *pnd;\r\nASSERT_RTNL();\r\nmutex_lock(&pndevs->lock);\r\npnd = __phonet_get(dev);\r\nif (pnd)\r\nlist_del_rcu(&pnd->list);\r\nmutex_unlock(&pndevs->lock);\r\nif (pnd) {\r\nu8 addr;\r\nfor_each_set_bit(addr, pnd->addrs, 64)\r\nphonet_address_notify(RTM_DELADDR, dev, addr);\r\nkfree(pnd);\r\n}\r\n}\r\nstruct net_device *phonet_device_get(struct net *net)\r\n{\r\nstruct phonet_device_list *pndevs = phonet_device_list(net);\r\nstruct phonet_device *pnd;\r\nstruct net_device *dev = NULL;\r\nrcu_read_lock();\r\nlist_for_each_entry_rcu(pnd, &pndevs->list, list) {\r\ndev = pnd->netdev;\r\nBUG_ON(!dev);\r\nif ((dev->reg_state == NETREG_REGISTERED) &&\r\n((pnd->netdev->flags & IFF_UP)) == IFF_UP)\r\nbreak;\r\ndev = NULL;\r\n}\r\nif (dev)\r\ndev_hold(dev);\r\nrcu_read_unlock();\r\nreturn dev;\r\n}\r\nint phonet_address_add(struct net_device *dev, u8 addr)\r\n{\r\nstruct phonet_device_list *pndevs = phonet_device_list(dev_net(dev));\r\nstruct phonet_device *pnd;\r\nint err = 0;\r\nmutex_lock(&pndevs->lock);\r\npnd = __phonet_get(dev);\r\nif (pnd == NULL)\r\npnd = __phonet_device_alloc(dev);\r\nif (unlikely(pnd == NULL))\r\nerr = -ENOMEM;\r\nelse if (test_and_set_bit(addr >> 2, pnd->addrs))\r\nerr = -EEXIST;\r\nmutex_unlock(&pndevs->lock);\r\nreturn err;\r\n}\r\nint phonet_address_del(struct net_device *dev, u8 addr)\r\n{\r\nstruct phonet_device_list *pndevs = phonet_device_list(dev_net(dev));\r\nstruct phonet_device *pnd;\r\nint err = 0;\r\nmutex_lock(&pndevs->lock);\r\npnd = __phonet_get(dev);\r\nif (!pnd || !test_and_clear_bit(addr >> 2, pnd->addrs)) {\r\nerr = -EADDRNOTAVAIL;\r\npnd = NULL;\r\n} else if (bitmap_empty(pnd->addrs, 64))\r\nlist_del_rcu(&pnd->list);\r\nelse\r\npnd = NULL;\r\nmutex_unlock(&pndevs->lock);\r\nif (pnd)\r\nkfree_rcu(pnd, rcu);\r\nreturn err;\r\n}\r\nu8 phonet_address_get(struct net_device *dev, u8 daddr)\r\n{\r\nstruct phonet_device *pnd;\r\nu8 saddr;\r\nrcu_read_lock();\r\npnd = __phonet_get_rcu(dev);\r\nif (pnd) {\r\nBUG_ON(bitmap_empty(pnd->addrs, 64));\r\nif (test_bit(daddr >> 2, pnd->addrs))\r\nsaddr = daddr;\r\nelse\r\nsaddr = find_first_bit(pnd->addrs, 64) << 2;\r\n} else\r\nsaddr = PN_NO_ADDR;\r\nrcu_read_unlock();\r\nif (saddr == PN_NO_ADDR) {\r\nstruct net_device *def_dev;\r\ndef_dev = phonet_device_get(dev_net(dev));\r\nif (def_dev) {\r\nif (def_dev != dev)\r\nsaddr = phonet_address_get(def_dev, daddr);\r\ndev_put(def_dev);\r\n}\r\n}\r\nreturn saddr;\r\n}\r\nint phonet_address_lookup(struct net *net, u8 addr)\r\n{\r\nstruct phonet_device_list *pndevs = phonet_device_list(net);\r\nstruct phonet_device *pnd;\r\nint err = -EADDRNOTAVAIL;\r\nrcu_read_lock();\r\nlist_for_each_entry_rcu(pnd, &pndevs->list, list) {\r\nif ((pnd->netdev->reg_state != NETREG_REGISTERED) ||\r\n((pnd->netdev->flags & IFF_UP)) != IFF_UP)\r\ncontinue;\r\nif (test_bit(addr >> 2, pnd->addrs)) {\r\nerr = 0;\r\ngoto found;\r\n}\r\n}\r\nfound:\r\nrcu_read_unlock();\r\nreturn err;\r\n}\r\nstatic int phonet_device_autoconf(struct net_device *dev)\r\n{\r\nstruct if_phonet_req req;\r\nint ret;\r\nif (!dev->netdev_ops->ndo_do_ioctl)\r\nreturn -EOPNOTSUPP;\r\nret = dev->netdev_ops->ndo_do_ioctl(dev, (struct ifreq *)&req,\r\nSIOCPNGAUTOCONF);\r\nif (ret < 0)\r\nreturn ret;\r\nASSERT_RTNL();\r\nret = phonet_address_add(dev, req.ifr_phonet_autoconf.device);\r\nif (ret)\r\nreturn ret;\r\nphonet_address_notify(RTM_NEWADDR, dev,\r\nreq.ifr_phonet_autoconf.device);\r\nreturn 0;\r\n}\r\nstatic void phonet_route_autodel(struct net_device *dev)\r\n{\r\nstruct phonet_net *pnn = phonet_pernet(dev_net(dev));\r\nunsigned int i;\r\nDECLARE_BITMAP(deleted, 64);\r\nbitmap_zero(deleted, 64);\r\nmutex_lock(&pnn->routes.lock);\r\nfor (i = 0; i < 64; i++)\r\nif (dev == pnn->routes.table[i]) {\r\nRCU_INIT_POINTER(pnn->routes.table[i], NULL);\r\nset_bit(i, deleted);\r\n}\r\nmutex_unlock(&pnn->routes.lock);\r\nif (bitmap_empty(deleted, 64))\r\nreturn;\r\nsynchronize_rcu();\r\nfor_each_set_bit(i, deleted, 64) {\r\nrtm_phonet_notify(RTM_DELROUTE, dev, i);\r\ndev_put(dev);\r\n}\r\n}\r\nstatic int phonet_device_notify(struct notifier_block *me, unsigned long what,\r\nvoid *ptr)\r\n{\r\nstruct net_device *dev = netdev_notifier_info_to_dev(ptr);\r\nswitch (what) {\r\ncase NETDEV_REGISTER:\r\nif (dev->type == ARPHRD_PHONET)\r\nphonet_device_autoconf(dev);\r\nbreak;\r\ncase NETDEV_UNREGISTER:\r\nphonet_device_destroy(dev);\r\nphonet_route_autodel(dev);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __net_init phonet_init_net(struct net *net)\r\n{\r\nstruct phonet_net *pnn = phonet_pernet(net);\r\nif (!proc_create("phonet", 0, net->proc_net, &pn_sock_seq_fops))\r\nreturn -ENOMEM;\r\nINIT_LIST_HEAD(&pnn->pndevs.list);\r\nmutex_init(&pnn->pndevs.lock);\r\nmutex_init(&pnn->routes.lock);\r\nreturn 0;\r\n}\r\nstatic void __net_exit phonet_exit_net(struct net *net)\r\n{\r\nremove_proc_entry("phonet", net->proc_net);\r\n}\r\nint __init phonet_device_init(void)\r\n{\r\nint err = register_pernet_subsys(&phonet_net_ops);\r\nif (err)\r\nreturn err;\r\nproc_create("pnresource", 0, init_net.proc_net, &pn_res_seq_fops);\r\nregister_netdevice_notifier(&phonet_device_notifier);\r\nerr = phonet_netlink_register();\r\nif (err)\r\nphonet_device_exit();\r\nreturn err;\r\n}\r\nvoid phonet_device_exit(void)\r\n{\r\nrtnl_unregister_all(PF_PHONET);\r\nunregister_netdevice_notifier(&phonet_device_notifier);\r\nunregister_pernet_subsys(&phonet_net_ops);\r\nremove_proc_entry("pnresource", init_net.proc_net);\r\n}\r\nint phonet_route_add(struct net_device *dev, u8 daddr)\r\n{\r\nstruct phonet_net *pnn = phonet_pernet(dev_net(dev));\r\nstruct phonet_routes *routes = &pnn->routes;\r\nint err = -EEXIST;\r\ndaddr = daddr >> 2;\r\nmutex_lock(&routes->lock);\r\nif (routes->table[daddr] == NULL) {\r\nrcu_assign_pointer(routes->table[daddr], dev);\r\ndev_hold(dev);\r\nerr = 0;\r\n}\r\nmutex_unlock(&routes->lock);\r\nreturn err;\r\n}\r\nint phonet_route_del(struct net_device *dev, u8 daddr)\r\n{\r\nstruct phonet_net *pnn = phonet_pernet(dev_net(dev));\r\nstruct phonet_routes *routes = &pnn->routes;\r\ndaddr = daddr >> 2;\r\nmutex_lock(&routes->lock);\r\nif (dev == routes->table[daddr])\r\nRCU_INIT_POINTER(routes->table[daddr], NULL);\r\nelse\r\ndev = NULL;\r\nmutex_unlock(&routes->lock);\r\nif (!dev)\r\nreturn -ENOENT;\r\nsynchronize_rcu();\r\ndev_put(dev);\r\nreturn 0;\r\n}\r\nstruct net_device *phonet_route_get_rcu(struct net *net, u8 daddr)\r\n{\r\nstruct phonet_net *pnn = phonet_pernet(net);\r\nstruct phonet_routes *routes = &pnn->routes;\r\nstruct net_device *dev;\r\ndaddr >>= 2;\r\ndev = rcu_dereference(routes->table[daddr]);\r\nreturn dev;\r\n}\r\nstruct net_device *phonet_route_output(struct net *net, u8 daddr)\r\n{\r\nstruct phonet_net *pnn = phonet_pernet(net);\r\nstruct phonet_routes *routes = &pnn->routes;\r\nstruct net_device *dev;\r\ndaddr >>= 2;\r\nrcu_read_lock();\r\ndev = rcu_dereference(routes->table[daddr]);\r\nif (dev)\r\ndev_hold(dev);\r\nrcu_read_unlock();\r\nif (!dev)\r\ndev = phonet_device_get(net);\r\nreturn dev;\r\n}

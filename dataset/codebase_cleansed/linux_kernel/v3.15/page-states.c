static int __init cmma(char *str)\r\n{\r\nchar *parm;\r\nparm = strstrip(str);\r\nif (strcmp(parm, "yes") == 0 || strcmp(parm, "on") == 0) {\r\ncmma_flag = 1;\r\nreturn 1;\r\n}\r\ncmma_flag = 0;\r\nif (strcmp(parm, "no") == 0 || strcmp(parm, "off") == 0)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nvoid __init cmma_init(void)\r\n{\r\nregister unsigned long tmp asm("0") = 0;\r\nregister int rc asm("1") = -EOPNOTSUPP;\r\nif (!cmma_flag)\r\nreturn;\r\nif (OLDMEM_BASE || ipl_info.type == IPL_TYPE_FCP_DUMP) {\r\ncmma_flag = 0;\r\nreturn;\r\n}\r\nasm volatile(\r\n" .insn rrf,0xb9ab0000,%1,%1,0,0\n"\r\n"0: la %0,0\n"\r\n"1:\n"\r\nEX_TABLE(0b,1b)\r\n: "+&d" (rc), "+&d" (tmp));\r\nif (rc)\r\ncmma_flag = 0;\r\n}\r\nstatic inline void set_page_unstable(struct page *page, int order)\r\n{\r\nint i, rc;\r\nfor (i = 0; i < (1 << order); i++)\r\nasm volatile(".insn rrf,0xb9ab0000,%0,%1,%2,0"\r\n: "=&d" (rc)\r\n: "a" (page_to_phys(page + i)),\r\n"i" (ESSA_SET_UNUSED));\r\n}\r\nvoid arch_free_page(struct page *page, int order)\r\n{\r\nif (!cmma_flag)\r\nreturn;\r\nset_page_unstable(page, order);\r\n}\r\nstatic inline void set_page_stable(struct page *page, int order)\r\n{\r\nint i, rc;\r\nfor (i = 0; i < (1 << order); i++)\r\nasm volatile(".insn rrf,0xb9ab0000,%0,%1,%2,0"\r\n: "=&d" (rc)\r\n: "a" (page_to_phys(page + i)),\r\n"i" (ESSA_SET_STABLE));\r\n}\r\nvoid arch_alloc_page(struct page *page, int order)\r\n{\r\nif (!cmma_flag)\r\nreturn;\r\nset_page_stable(page, order);\r\n}\r\nvoid arch_set_page_states(int make_stable)\r\n{\r\nunsigned long flags, order, t;\r\nstruct list_head *l;\r\nstruct page *page;\r\nstruct zone *zone;\r\nif (!cmma_flag)\r\nreturn;\r\nif (make_stable)\r\ndrain_local_pages(NULL);\r\nfor_each_populated_zone(zone) {\r\nspin_lock_irqsave(&zone->lock, flags);\r\nfor_each_migratetype_order(order, t) {\r\nlist_for_each(l, &zone->free_area[order].free_list[t]) {\r\npage = list_entry(l, struct page, lru);\r\nif (make_stable)\r\nset_page_stable(page, order);\r\nelse\r\nset_page_unstable(page, order);\r\n}\r\n}\r\nspin_unlock_irqrestore(&zone->lock, flags);\r\n}\r\n}

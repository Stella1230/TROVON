static int tw_check_bits(u32 status_reg_value)\r\n{\r\nif ((status_reg_value & TW_STATUS_EXPECTED_BITS) != TW_STATUS_EXPECTED_BITS) {\r\ndprintk(KERN_WARNING "3w-xxxx: tw_check_bits(): No expected bits (0x%x).\n", status_reg_value);\r\nreturn 1;\r\n}\r\nif ((status_reg_value & TW_STATUS_UNEXPECTED_BITS) != 0) {\r\ndprintk(KERN_WARNING "3w-xxxx: tw_check_bits(): Found unexpected bits (0x%x).\n", status_reg_value);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tw_decode_bits(TW_Device_Extension *tw_dev, u32 status_reg_value, int print_host)\r\n{\r\nchar host[16];\r\ndprintk(KERN_WARNING "3w-xxxx: tw_decode_bits()\n");\r\nif (print_host)\r\nsprintf(host, " scsi%d:", tw_dev->host->host_no);\r\nelse\r\nhost[0] = '\0';\r\nif (status_reg_value & TW_STATUS_PCI_PARITY_ERROR) {\r\nprintk(KERN_WARNING "3w-xxxx:%s PCI Parity Error: clearing.\n", host);\r\noutl(TW_CONTROL_CLEAR_PARITY_ERROR, TW_CONTROL_REG_ADDR(tw_dev));\r\n}\r\nif (status_reg_value & TW_STATUS_PCI_ABORT) {\r\nprintk(KERN_WARNING "3w-xxxx:%s PCI Abort: clearing.\n", host);\r\noutl(TW_CONTROL_CLEAR_PCI_ABORT, TW_CONTROL_REG_ADDR(tw_dev));\r\npci_write_config_word(tw_dev->tw_pci_dev, PCI_STATUS, TW_PCI_CLEAR_PCI_ABORT);\r\n}\r\nif (status_reg_value & TW_STATUS_QUEUE_ERROR) {\r\nprintk(KERN_WARNING "3w-xxxx:%s Controller Queue Error: clearing.\n", host);\r\noutl(TW_CONTROL_CLEAR_QUEUE_ERROR, TW_CONTROL_REG_ADDR(tw_dev));\r\n}\r\nif (status_reg_value & TW_STATUS_SBUF_WRITE_ERROR) {\r\nprintk(KERN_WARNING "3w-xxxx:%s SBUF Write Error: clearing.\n", host);\r\noutl(TW_CONTROL_CLEAR_SBUF_WRITE_ERROR, TW_CONTROL_REG_ADDR(tw_dev));\r\n}\r\nif (status_reg_value & TW_STATUS_MICROCONTROLLER_ERROR) {\r\nif (tw_dev->reset_print == 0) {\r\nprintk(KERN_WARNING "3w-xxxx:%s Microcontroller Error: clearing.\n", host);\r\ntw_dev->reset_print = 1;\r\n}\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tw_poll_status(TW_Device_Extension *tw_dev, u32 flag, int seconds)\r\n{\r\nu32 status_reg_value;\r\nunsigned long before;\r\nint retval = 1;\r\nstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\r\nbefore = jiffies;\r\nif (tw_check_bits(status_reg_value))\r\ntw_decode_bits(tw_dev, status_reg_value, 0);\r\nwhile ((status_reg_value & flag) != flag) {\r\nstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\r\nif (tw_check_bits(status_reg_value))\r\ntw_decode_bits(tw_dev, status_reg_value, 0);\r\nif (time_after(jiffies, before + HZ * seconds))\r\ngoto out;\r\nmsleep(50);\r\n}\r\nretval = 0;\r\nout:\r\nreturn retval;\r\n}\r\nstatic int tw_poll_status_gone(TW_Device_Extension *tw_dev, u32 flag, int seconds)\r\n{\r\nu32 status_reg_value;\r\nunsigned long before;\r\nint retval = 1;\r\nstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\r\nbefore = jiffies;\r\nif (tw_check_bits(status_reg_value))\r\ntw_decode_bits(tw_dev, status_reg_value, 0);\r\nwhile ((status_reg_value & flag) != 0) {\r\nstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\r\nif (tw_check_bits(status_reg_value))\r\ntw_decode_bits(tw_dev, status_reg_value, 0);\r\nif (time_after(jiffies, before + HZ * seconds))\r\ngoto out;\r\nmsleep(50);\r\n}\r\nretval = 0;\r\nout:\r\nreturn retval;\r\n}\r\nstatic int tw_post_command_packet(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\nu32 status_reg_value;\r\nunsigned long command_que_value;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_post_command_packet()\n");\r\ncommand_que_value = tw_dev->command_packet_physical_address[request_id];\r\nstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\r\nif (tw_check_bits(status_reg_value)) {\r\ndprintk(KERN_WARNING "3w-xxxx: tw_post_command_packet(): Unexpected bits.\n");\r\ntw_decode_bits(tw_dev, status_reg_value, 1);\r\n}\r\nif ((status_reg_value & TW_STATUS_COMMAND_QUEUE_FULL) == 0) {\r\noutl(command_que_value, TW_COMMAND_QUEUE_REG_ADDR(tw_dev));\r\ntw_dev->state[request_id] = TW_S_POSTED;\r\ntw_dev->posted_request_count++;\r\nif (tw_dev->posted_request_count > tw_dev->max_posted_request_count) {\r\ntw_dev->max_posted_request_count = tw_dev->posted_request_count;\r\n}\r\n} else {\r\nif (tw_dev->state[request_id] != TW_S_PENDING) {\r\ntw_dev->state[request_id] = TW_S_PENDING;\r\ntw_dev->pending_request_count++;\r\nif (tw_dev->pending_request_count > tw_dev->max_pending_request_count) {\r\ntw_dev->max_pending_request_count = tw_dev->pending_request_count;\r\n}\r\ntw_dev->pending_queue[tw_dev->pending_tail] = request_id;\r\nif (tw_dev->pending_tail == TW_Q_LENGTH-1) {\r\ntw_dev->pending_tail = TW_Q_START;\r\n} else {\r\ntw_dev->pending_tail = tw_dev->pending_tail + 1;\r\n}\r\n}\r\nTW_UNMASK_COMMAND_INTERRUPT(tw_dev);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tw_decode_sense(TW_Device_Extension *tw_dev, int request_id, int fill_sense)\r\n{\r\nint i;\r\nTW_Command *command;\r\ndprintk(KERN_WARNING "3w-xxxx: tw_decode_sense()\n");\r\ncommand = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\r\nprintk(KERN_WARNING "3w-xxxx: scsi%d: Command failed: status = 0x%x, flags = 0x%x, unit #%d.\n", tw_dev->host->host_no, command->status, command->flags, TW_UNIT_OUT(command->unit__hostid));\r\nif (fill_sense) {\r\nif ((command->status == 0xc7) || (command->status == 0xcb)) {\r\nfor (i = 0; i < ARRAY_SIZE(tw_sense_table); i++) {\r\nif (command->flags == tw_sense_table[i][0]) {\r\ntw_dev->srb[request_id]->sense_buffer[0] = (0x1 << 7 | 0x70);\r\ntw_dev->srb[request_id]->sense_buffer[2] = tw_sense_table[i][1];\r\ntw_dev->srb[request_id]->sense_buffer[7] = 0xa;\r\ntw_dev->srb[request_id]->sense_buffer[12] = tw_sense_table[i][2];\r\ntw_dev->srb[request_id]->sense_buffer[13] = tw_sense_table[i][3];\r\ntw_dev->srb[request_id]->result = (DID_OK << 16) | (CHECK_CONDITION << 1);\r\nreturn TW_ISR_DONT_RESULT;\r\n}\r\n}\r\n}\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tw_check_errors(TW_Device_Extension *tw_dev)\r\n{\r\nu32 status_reg_value;\r\nstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\r\nif (TW_STATUS_ERRORS(status_reg_value) || tw_check_bits(status_reg_value)) {\r\ntw_decode_bits(tw_dev, status_reg_value, 0);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void tw_empty_response_que(TW_Device_Extension *tw_dev)\r\n{\r\nu32 status_reg_value, response_que_value;\r\nstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\r\nwhile ((status_reg_value & TW_STATUS_RESPONSE_QUEUE_EMPTY) == 0) {\r\nresponse_que_value = inl(TW_RESPONSE_QUEUE_REG_ADDR(tw_dev));\r\nstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\r\n}\r\n}\r\nstatic void tw_state_request_finish(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\ntw_dev->free_queue[tw_dev->free_tail] = request_id;\r\ntw_dev->state[request_id] = TW_S_FINISHED;\r\ntw_dev->free_tail = (tw_dev->free_tail + 1) % TW_Q_LENGTH;\r\n}\r\nstatic void tw_state_request_start(TW_Device_Extension *tw_dev, int *request_id)\r\n{\r\n*request_id = tw_dev->free_queue[tw_dev->free_head];\r\ntw_dev->free_head = (tw_dev->free_head + 1) % TW_Q_LENGTH;\r\ntw_dev->state[*request_id] = TW_S_STARTED;\r\n}\r\nstatic ssize_t tw_show_stats(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nTW_Device_Extension *tw_dev = (TW_Device_Extension *)host->hostdata;\r\nunsigned long flags = 0;\r\nssize_t len;\r\nspin_lock_irqsave(tw_dev->host->host_lock, flags);\r\nlen = snprintf(buf, PAGE_SIZE, "3w-xxxx Driver version: %s\n"\r\n"Current commands posted: %4d\n"\r\n"Max commands posted: %4d\n"\r\n"Current pending commands: %4d\n"\r\n"Max pending commands: %4d\n"\r\n"Last sgl length: %4d\n"\r\n"Max sgl length: %4d\n"\r\n"Last sector count: %4d\n"\r\n"Max sector count: %4d\n"\r\n"SCSI Host Resets: %4d\n"\r\n"AEN's: %4d\n",\r\nTW_DRIVER_VERSION,\r\ntw_dev->posted_request_count,\r\ntw_dev->max_posted_request_count,\r\ntw_dev->pending_request_count,\r\ntw_dev->max_pending_request_count,\r\ntw_dev->sgl_entries,\r\ntw_dev->max_sgl_entries,\r\ntw_dev->sector_count,\r\ntw_dev->max_sector_count,\r\ntw_dev->num_resets,\r\ntw_dev->aen_count);\r\nspin_unlock_irqrestore(tw_dev->host->host_lock, flags);\r\nreturn len;\r\n}\r\nstatic int tw_change_queue_depth(struct scsi_device *sdev, int queue_depth,\r\nint reason)\r\n{\r\nif (reason != SCSI_QDEPTH_DEFAULT)\r\nreturn -EOPNOTSUPP;\r\nif (queue_depth > TW_Q_LENGTH-2)\r\nqueue_depth = TW_Q_LENGTH-2;\r\nscsi_adjust_queue_depth(sdev, MSG_ORDERED_TAG, queue_depth);\r\nreturn queue_depth;\r\n}\r\nstatic int tw_aen_read_queue(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\nTW_Command *command_packet;\r\nTW_Param *param;\r\nunsigned long command_que_value;\r\nu32 status_reg_value;\r\nunsigned long param_value = 0;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_aen_read_queue()\n");\r\nstatus_reg_value = inl(TW_STATUS_REG_ADDR(tw_dev));\r\nif (tw_check_bits(status_reg_value)) {\r\ndprintk(KERN_WARNING "3w-xxxx: tw_aen_read_queue(): Unexpected bits.\n");\r\ntw_decode_bits(tw_dev, status_reg_value, 1);\r\nreturn 1;\r\n}\r\nif (tw_dev->command_packet_virtual_address[request_id] == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_aen_read_queue(): Bad command packet virtual address.\n");\r\nreturn 1;\r\n}\r\ncommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\r\nmemset(command_packet, 0, sizeof(TW_Sector));\r\ncommand_packet->opcode__sgloffset = TW_OPSGL_IN(2, TW_OP_GET_PARAM);\r\ncommand_packet->size = 4;\r\ncommand_packet->request_id = request_id;\r\ncommand_packet->status = 0;\r\ncommand_packet->flags = 0;\r\ncommand_packet->byte6.parameter_count = 1;\r\ncommand_que_value = tw_dev->command_packet_physical_address[request_id];\r\nif (command_que_value == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_aen_read_queue(): Bad command packet physical address.\n");\r\nreturn 1;\r\n}\r\nif (tw_dev->alignment_virtual_address[request_id] == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_aen_read_queue(): Bad alignment virtual address.\n");\r\nreturn 1;\r\n}\r\nparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\r\nmemset(param, 0, sizeof(TW_Sector));\r\nparam->table_id = 0x401;\r\nparam->parameter_id = 2;\r\nparam->parameter_size_bytes = 2;\r\nparam_value = tw_dev->alignment_physical_address[request_id];\r\nif (param_value == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_aen_read_queue(): Bad alignment physical address.\n");\r\nreturn 1;\r\n}\r\ncommand_packet->byte8.param.sgl[0].address = param_value;\r\ncommand_packet->byte8.param.sgl[0].length = sizeof(TW_Sector);\r\nif ((status_reg_value & TW_STATUS_COMMAND_QUEUE_FULL) == 0) {\r\ndprintk(KERN_WARNING "3w-xxxx: tw_aen_read_queue(): Post succeeded.\n");\r\ntw_dev->srb[request_id] = NULL;\r\ntw_dev->state[request_id] = TW_S_POSTED;\r\noutl(command_que_value, TW_COMMAND_QUEUE_REG_ADDR(tw_dev));\r\n} else {\r\nprintk(KERN_WARNING "3w-xxxx: tw_aen_read_queue(): Post failed, will retry.\n");\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tw_aen_complete(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\nTW_Param *param;\r\nunsigned short aen;\r\nint error = 0, table_max = 0;\r\ndprintk(KERN_WARNING "3w-xxxx: tw_aen_complete()\n");\r\nif (tw_dev->alignment_virtual_address[request_id] == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_aen_complete(): Bad alignment virtual address.\n");\r\nreturn 1;\r\n}\r\nparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\r\naen = *(unsigned short *)(param->data);\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_aen_complete(): Queue'd code 0x%x\n", aen);\r\nif (aen == 0x0ff) {\r\nprintk(KERN_WARNING "3w-xxxx: scsi%d: AEN: INFO: AEN queue overflow.\n", tw_dev->host->host_no);\r\n} else {\r\ntable_max = ARRAY_SIZE(tw_aen_string);\r\nif ((aen & 0x0ff) < table_max) {\r\nif ((tw_aen_string[aen & 0xff][strlen(tw_aen_string[aen & 0xff])-1]) == '#') {\r\nprintk(KERN_WARNING "3w-xxxx: scsi%d: AEN: %s%d.\n", tw_dev->host->host_no, tw_aen_string[aen & 0xff], aen >> 8);\r\n} else {\r\nif (aen != 0x0)\r\nprintk(KERN_WARNING "3w-xxxx: scsi%d: AEN: %s.\n", tw_dev->host->host_no, tw_aen_string[aen & 0xff]);\r\n}\r\n} else {\r\nprintk(KERN_WARNING "3w-xxxx: scsi%d: Received AEN %d.\n", tw_dev->host->host_no, aen);\r\n}\r\n}\r\nif (aen != TW_AEN_QUEUE_EMPTY) {\r\ntw_dev->aen_count++;\r\ntw_dev->aen_queue[tw_dev->aen_tail] = aen;\r\nif (tw_dev->aen_tail == TW_Q_LENGTH - 1) {\r\ntw_dev->aen_tail = TW_Q_START;\r\n} else {\r\ntw_dev->aen_tail = tw_dev->aen_tail + 1;\r\n}\r\nif (tw_dev->aen_head == tw_dev->aen_tail) {\r\nif (tw_dev->aen_head == TW_Q_LENGTH - 1) {\r\ntw_dev->aen_head = TW_Q_START;\r\n} else {\r\ntw_dev->aen_head = tw_dev->aen_head + 1;\r\n}\r\n}\r\nerror = tw_aen_read_queue(tw_dev, request_id);\r\nif (error) {\r\nprintk(KERN_WARNING "3w-xxxx: scsi%d: Error completing AEN.\n", tw_dev->host->host_no);\r\ntw_dev->state[request_id] = TW_S_COMPLETED;\r\ntw_state_request_finish(tw_dev, request_id);\r\n}\r\n} else {\r\ntw_dev->state[request_id] = TW_S_COMPLETED;\r\ntw_state_request_finish(tw_dev, request_id);\r\n}\r\nreturn 0;\r\n}\r\nstatic int tw_aen_drain_queue(TW_Device_Extension *tw_dev)\r\n{\r\nTW_Command *command_packet;\r\nTW_Param *param;\r\nint request_id = 0;\r\nunsigned long command_que_value;\r\nunsigned long param_value;\r\nTW_Response_Queue response_queue;\r\nunsigned short aen;\r\nunsigned short aen_code;\r\nint finished = 0;\r\nint first_reset = 0;\r\nint queue = 0;\r\nint found = 0, table_max = 0;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_aen_drain_queue()\n");\r\nif (tw_poll_status(tw_dev, TW_STATUS_ATTENTION_INTERRUPT | TW_STATUS_MICROCONTROLLER_READY, 30)) {\r\ndprintk(KERN_WARNING "3w-xxxx: tw_aen_drain_queue(): No attention interrupt for card %d.\n", tw_device_extension_count);\r\nreturn 1;\r\n}\r\nTW_CLEAR_ATTENTION_INTERRUPT(tw_dev);\r\ntw_empty_response_que(tw_dev);\r\nif (tw_dev->command_packet_virtual_address[request_id] == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_aen_drain_queue(): Bad command packet virtual address.\n");\r\nreturn 1;\r\n}\r\ncommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\r\nmemset(command_packet, 0, sizeof(TW_Sector));\r\ncommand_packet->opcode__sgloffset = TW_OPSGL_IN(2, TW_OP_GET_PARAM);\r\ncommand_packet->size = 4;\r\ncommand_packet->request_id = request_id;\r\ncommand_packet->status = 0;\r\ncommand_packet->flags = 0;\r\ncommand_packet->byte6.parameter_count = 1;\r\ncommand_que_value = tw_dev->command_packet_physical_address[request_id];\r\nif (command_que_value == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_aen_drain_queue(): Bad command packet physical address.\n");\r\nreturn 1;\r\n}\r\nif (tw_dev->alignment_virtual_address[request_id] == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_aen_drain_queue(): Bad alignment virtual address.\n");\r\nreturn 1;\r\n}\r\nparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\r\nmemset(param, 0, sizeof(TW_Sector));\r\nparam->table_id = 0x401;\r\nparam->parameter_id = 2;\r\nparam->parameter_size_bytes = 2;\r\nparam_value = tw_dev->alignment_physical_address[request_id];\r\nif (param_value == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_aen_drain_queue(): Bad alignment physical address.\n");\r\nreturn 1;\r\n}\r\ncommand_packet->byte8.param.sgl[0].address = param_value;\r\ncommand_packet->byte8.param.sgl[0].length = sizeof(TW_Sector);\r\ndo {\r\noutl(command_que_value, TW_COMMAND_QUEUE_REG_ADDR(tw_dev));\r\nif (tw_poll_status_gone(tw_dev, TW_STATUS_RESPONSE_QUEUE_EMPTY, 30) == 0) {\r\nresponse_queue.value = inl(TW_RESPONSE_QUEUE_REG_ADDR(tw_dev));\r\nrequest_id = TW_RESID_OUT(response_queue.response_id);\r\nif (request_id != 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_aen_drain_queue(): Unexpected request id.\n");\r\nreturn 1;\r\n}\r\nif (command_packet->status != 0) {\r\nif (command_packet->flags != TW_AEN_TABLE_UNDEFINED) {\r\ntw_decode_sense(tw_dev, request_id, 0);\r\nreturn 1;\r\n} else {\r\nreturn 0;\r\n}\r\n}\r\naen = *(unsigned short *)(param->data);\r\naen_code = (aen & 0x0ff);\r\nqueue = 0;\r\nswitch (aen_code) {\r\ncase TW_AEN_QUEUE_EMPTY:\r\ndprintk(KERN_WARNING "3w-xxxx: AEN: %s.\n", tw_aen_string[aen & 0xff]);\r\nif (first_reset != 1) {\r\nreturn 1;\r\n} else {\r\nfinished = 1;\r\n}\r\nbreak;\r\ncase TW_AEN_SOFT_RESET:\r\nif (first_reset == 0) {\r\nfirst_reset = 1;\r\n} else {\r\nprintk(KERN_WARNING "3w-xxxx: AEN: %s.\n", tw_aen_string[aen & 0xff]);\r\ntw_dev->aen_count++;\r\nqueue = 1;\r\n}\r\nbreak;\r\ndefault:\r\nif (aen == 0x0ff) {\r\nprintk(KERN_WARNING "3w-xxxx: AEN: INFO: AEN queue overflow.\n");\r\n} else {\r\ntable_max = ARRAY_SIZE(tw_aen_string);\r\nif ((aen & 0x0ff) < table_max) {\r\nif ((tw_aen_string[aen & 0xff][strlen(tw_aen_string[aen & 0xff])-1]) == '#') {\r\nprintk(KERN_WARNING "3w-xxxx: AEN: %s%d.\n", tw_aen_string[aen & 0xff], aen >> 8);\r\n} else {\r\nprintk(KERN_WARNING "3w-xxxx: AEN: %s.\n", tw_aen_string[aen & 0xff]);\r\n}\r\n} else\r\nprintk(KERN_WARNING "3w-xxxx: Received AEN %d.\n", aen);\r\n}\r\ntw_dev->aen_count++;\r\nqueue = 1;\r\n}\r\nif (queue == 1) {\r\ntw_dev->aen_queue[tw_dev->aen_tail] = aen;\r\nif (tw_dev->aen_tail == TW_Q_LENGTH - 1) {\r\ntw_dev->aen_tail = TW_Q_START;\r\n} else {\r\ntw_dev->aen_tail = tw_dev->aen_tail + 1;\r\n}\r\nif (tw_dev->aen_head == tw_dev->aen_tail) {\r\nif (tw_dev->aen_head == TW_Q_LENGTH - 1) {\r\ntw_dev->aen_head = TW_Q_START;\r\n} else {\r\ntw_dev->aen_head = tw_dev->aen_head + 1;\r\n}\r\n}\r\n}\r\nfound = 1;\r\n}\r\nif (found == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_aen_drain_queue(): Response never received.\n");\r\nreturn 1;\r\n}\r\n} while (finished == 0);\r\nreturn 0;\r\n}\r\nstatic int tw_allocate_memory(TW_Device_Extension *tw_dev, int size, int which)\r\n{\r\nint i;\r\ndma_addr_t dma_handle;\r\nunsigned long *cpu_addr = NULL;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_allocate_memory()\n");\r\ncpu_addr = pci_alloc_consistent(tw_dev->tw_pci_dev, size*TW_Q_LENGTH, &dma_handle);\r\nif (cpu_addr == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: pci_alloc_consistent() failed.\n");\r\nreturn 1;\r\n}\r\nif ((unsigned long)cpu_addr % (tw_dev->tw_pci_dev->device == TW_DEVICE_ID ? TW_ALIGNMENT_6000 : TW_ALIGNMENT_7000)) {\r\nprintk(KERN_WARNING "3w-xxxx: Couldn't allocate correctly aligned memory.\n");\r\npci_free_consistent(tw_dev->tw_pci_dev, size*TW_Q_LENGTH, cpu_addr, dma_handle);\r\nreturn 1;\r\n}\r\nmemset(cpu_addr, 0, size*TW_Q_LENGTH);\r\nfor (i=0;i<TW_Q_LENGTH;i++) {\r\nswitch(which) {\r\ncase 0:\r\ntw_dev->command_packet_physical_address[i] = dma_handle+(i*size);\r\ntw_dev->command_packet_virtual_address[i] = (unsigned long *)((unsigned char *)cpu_addr + (i*size));\r\nbreak;\r\ncase 1:\r\ntw_dev->alignment_physical_address[i] = dma_handle+(i*size);\r\ntw_dev->alignment_virtual_address[i] = (unsigned long *)((unsigned char *)cpu_addr + (i*size));\r\nbreak;\r\ndefault:\r\nprintk(KERN_WARNING "3w-xxxx: tw_allocate_memory(): case slip in tw_allocate_memory()\n");\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic long tw_chrdev_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nint request_id;\r\ndma_addr_t dma_handle;\r\nunsigned short tw_aen_code;\r\nunsigned long flags;\r\nunsigned int data_buffer_length = 0;\r\nunsigned long data_buffer_length_adjusted = 0;\r\nstruct inode *inode = file_inode(file);\r\nunsigned long *cpu_addr;\r\nlong timeout;\r\nTW_New_Ioctl *tw_ioctl;\r\nTW_Passthru *passthru;\r\nTW_Device_Extension *tw_dev = tw_device_extension_list[iminor(inode)];\r\nint retval = -EFAULT;\r\nvoid __user *argp = (void __user *)arg;\r\ndprintk(KERN_WARNING "3w-xxxx: tw_chrdev_ioctl()\n");\r\nmutex_lock(&tw_mutex);\r\nif (mutex_lock_interruptible(&tw_dev->ioctl_lock)) {\r\nmutex_unlock(&tw_mutex);\r\nreturn -EINTR;\r\n}\r\nif (copy_from_user(&data_buffer_length, argp, sizeof(unsigned int)))\r\ngoto out;\r\nif (data_buffer_length > TW_MAX_IOCTL_SECTORS * 512) {\r\nretval = -EINVAL;\r\ngoto out;\r\n}\r\ndata_buffer_length_adjusted = (data_buffer_length + 511) & ~511;\r\ncpu_addr = dma_alloc_coherent(&tw_dev->tw_pci_dev->dev, data_buffer_length_adjusted+sizeof(TW_New_Ioctl) - 1, &dma_handle, GFP_KERNEL);\r\nif (cpu_addr == NULL) {\r\nretval = -ENOMEM;\r\ngoto out;\r\n}\r\ntw_ioctl = (TW_New_Ioctl *)cpu_addr;\r\nif (copy_from_user(tw_ioctl, argp, data_buffer_length + sizeof(TW_New_Ioctl) - 1))\r\ngoto out2;\r\npassthru = (TW_Passthru *)&tw_ioctl->firmware_command;\r\nswitch (cmd) {\r\ncase TW_OP_NOP:\r\ndprintk(KERN_WARNING "3w-xxxx: tw_chrdev_ioctl(): caught TW_OP_NOP.\n");\r\nbreak;\r\ncase TW_OP_AEN_LISTEN:\r\ndprintk(KERN_WARNING "3w-xxxx: tw_chrdev_ioctl(): caught TW_AEN_LISTEN.\n");\r\nmemset(tw_ioctl->data_buffer, 0, data_buffer_length);\r\nspin_lock_irqsave(tw_dev->host->host_lock, flags);\r\nif (tw_dev->aen_head == tw_dev->aen_tail) {\r\ntw_aen_code = TW_AEN_QUEUE_EMPTY;\r\n} else {\r\ntw_aen_code = tw_dev->aen_queue[tw_dev->aen_head];\r\nif (tw_dev->aen_head == TW_Q_LENGTH - 1) {\r\ntw_dev->aen_head = TW_Q_START;\r\n} else {\r\ntw_dev->aen_head = tw_dev->aen_head + 1;\r\n}\r\n}\r\nspin_unlock_irqrestore(tw_dev->host->host_lock, flags);\r\nmemcpy(tw_ioctl->data_buffer, &tw_aen_code, sizeof(tw_aen_code));\r\nbreak;\r\ncase TW_CMD_PACKET_WITH_DATA:\r\ndprintk(KERN_WARNING "3w-xxxx: tw_chrdev_ioctl(): caught TW_CMD_PACKET_WITH_DATA.\n");\r\nspin_lock_irqsave(tw_dev->host->host_lock, flags);\r\ntw_state_request_start(tw_dev, &request_id);\r\ntw_dev->srb[request_id] = NULL;\r\ntw_dev->chrdev_request_id = request_id;\r\ntw_ioctl->firmware_command.request_id = request_id;\r\nswitch (TW_SGL_OUT(tw_ioctl->firmware_command.opcode__sgloffset)) {\r\ncase 2:\r\ntw_ioctl->firmware_command.byte8.param.sgl[0].address = dma_handle + sizeof(TW_New_Ioctl) - 1;\r\ntw_ioctl->firmware_command.byte8.param.sgl[0].length = data_buffer_length_adjusted;\r\nbreak;\r\ncase 3:\r\ntw_ioctl->firmware_command.byte8.io.sgl[0].address = dma_handle + sizeof(TW_New_Ioctl) - 1;\r\ntw_ioctl->firmware_command.byte8.io.sgl[0].length = data_buffer_length_adjusted;\r\nbreak;\r\ncase 5:\r\npassthru->sg_list[0].address = dma_handle + sizeof(TW_New_Ioctl) - 1;\r\npassthru->sg_list[0].length = data_buffer_length_adjusted;\r\nbreak;\r\n}\r\nmemcpy(tw_dev->command_packet_virtual_address[request_id], &(tw_ioctl->firmware_command), sizeof(TW_Command));\r\ntw_post_command_packet(tw_dev, request_id);\r\nspin_unlock_irqrestore(tw_dev->host->host_lock, flags);\r\ntimeout = TW_IOCTL_CHRDEV_TIMEOUT*HZ;\r\ntimeout = wait_event_timeout(tw_dev->ioctl_wqueue, tw_dev->chrdev_request_id == TW_IOCTL_CHRDEV_FREE, timeout);\r\nif (tw_dev->chrdev_request_id != TW_IOCTL_CHRDEV_FREE) {\r\nprintk(KERN_WARNING "3w-xxxx: scsi%d: Character ioctl (0x%x) timed out, resetting card.\n", tw_dev->host->host_no, cmd);\r\nretval = -EIO;\r\nif (tw_reset_device_extension(tw_dev)) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_chrdev_ioctl(): Reset failed for card %d.\n", tw_dev->host->host_no);\r\n}\r\ngoto out2;\r\n}\r\nmemcpy(&(tw_ioctl->firmware_command), tw_dev->command_packet_virtual_address[request_id], sizeof(TW_Command));\r\nspin_lock_irqsave(tw_dev->host->host_lock, flags);\r\ntw_dev->posted_request_count--;\r\ntw_dev->state[request_id] = TW_S_COMPLETED;\r\ntw_state_request_finish(tw_dev, request_id);\r\nspin_unlock_irqrestore(tw_dev->host->host_lock, flags);\r\nbreak;\r\ndefault:\r\nretval = -ENOTTY;\r\ngoto out2;\r\n}\r\nif (copy_to_user(argp, tw_ioctl, sizeof(TW_New_Ioctl) + data_buffer_length - 1))\r\ngoto out2;\r\nretval = 0;\r\nout2:\r\ndma_free_coherent(&tw_dev->tw_pci_dev->dev, data_buffer_length_adjusted+sizeof(TW_New_Ioctl) - 1, cpu_addr, dma_handle);\r\nout:\r\nmutex_unlock(&tw_dev->ioctl_lock);\r\nmutex_unlock(&tw_mutex);\r\nreturn retval;\r\n}\r\nstatic int tw_chrdev_open(struct inode *inode, struct file *file)\r\n{\r\nunsigned int minor_number;\r\ndprintk(KERN_WARNING "3w-xxxx: tw_ioctl_open()\n");\r\nminor_number = iminor(inode);\r\nif (minor_number >= tw_device_extension_count)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic void tw_free_device_extension(TW_Device_Extension *tw_dev)\r\n{\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_free_device_extension()\n");\r\nif (tw_dev->command_packet_virtual_address[0])\r\npci_free_consistent(tw_dev->tw_pci_dev, sizeof(TW_Command)*TW_Q_LENGTH, tw_dev->command_packet_virtual_address[0], tw_dev->command_packet_physical_address[0]);\r\nif (tw_dev->alignment_virtual_address[0])\r\npci_free_consistent(tw_dev->tw_pci_dev, sizeof(TW_Sector)*TW_Q_LENGTH, tw_dev->alignment_virtual_address[0], tw_dev->alignment_physical_address[0]);\r\n}\r\nstatic int tw_initconnection(TW_Device_Extension *tw_dev, int message_credits)\r\n{\r\nunsigned long command_que_value;\r\nTW_Command *command_packet;\r\nTW_Response_Queue response_queue;\r\nint request_id = 0;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_initconnection()\n");\r\nif (tw_dev->command_packet_virtual_address[request_id] == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_initconnection(): Bad command packet virtual address.\n");\r\nreturn 1;\r\n}\r\ncommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\r\nmemset(command_packet, 0, sizeof(TW_Sector));\r\ncommand_packet->opcode__sgloffset = TW_OPSGL_IN(0, TW_OP_INIT_CONNECTION);\r\ncommand_packet->size = TW_INIT_COMMAND_PACKET_SIZE;\r\ncommand_packet->request_id = request_id;\r\ncommand_packet->status = 0x0;\r\ncommand_packet->flags = 0x0;\r\ncommand_packet->byte6.message_credits = message_credits;\r\ncommand_packet->byte8.init_connection.response_queue_pointer = 0x0;\r\ncommand_que_value = tw_dev->command_packet_physical_address[request_id];\r\nif (command_que_value == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_initconnection(): Bad command packet physical address.\n");\r\nreturn 1;\r\n}\r\noutl(command_que_value, TW_COMMAND_QUEUE_REG_ADDR(tw_dev));\r\nif (tw_poll_status_gone(tw_dev, TW_STATUS_RESPONSE_QUEUE_EMPTY, 30) == 0) {\r\nresponse_queue.value = inl(TW_RESPONSE_QUEUE_REG_ADDR(tw_dev));\r\nrequest_id = TW_RESID_OUT(response_queue.response_id);\r\nif (request_id != 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_initconnection(): Unexpected request id.\n");\r\nreturn 1;\r\n}\r\nif (command_packet->status != 0) {\r\ntw_decode_sense(tw_dev, request_id, 0);\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int tw_setfeature(TW_Device_Extension *tw_dev, int parm, int param_size,\r\nunsigned char *val)\r\n{\r\nTW_Param *param;\r\nTW_Command *command_packet;\r\nTW_Response_Queue response_queue;\r\nint request_id = 0;\r\nunsigned long command_que_value;\r\nunsigned long param_value;\r\nif (tw_dev->command_packet_virtual_address[request_id] == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_setfeature(): Bad command packet virtual address.\n");\r\nreturn 1;\r\n}\r\ncommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\r\nmemset(command_packet, 0, sizeof(TW_Sector));\r\nparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\r\ncommand_packet->opcode__sgloffset = TW_OPSGL_IN(2, TW_OP_SET_PARAM);\r\nparam->table_id = 0x404;\r\nparam->parameter_id = parm;\r\nparam->parameter_size_bytes = param_size;\r\nmemcpy(param->data, val, param_size);\r\nparam_value = tw_dev->alignment_physical_address[request_id];\r\nif (param_value == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_setfeature(): Bad alignment physical address.\n");\r\ntw_dev->state[request_id] = TW_S_COMPLETED;\r\ntw_state_request_finish(tw_dev, request_id);\r\ntw_dev->srb[request_id]->result = (DID_OK << 16);\r\ntw_dev->srb[request_id]->scsi_done(tw_dev->srb[request_id]);\r\n}\r\ncommand_packet->byte8.param.sgl[0].address = param_value;\r\ncommand_packet->byte8.param.sgl[0].length = sizeof(TW_Sector);\r\ncommand_packet->size = 4;\r\ncommand_packet->request_id = request_id;\r\ncommand_packet->byte6.parameter_count = 1;\r\ncommand_que_value = tw_dev->command_packet_physical_address[request_id];\r\nif (command_que_value == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_setfeature(): Bad command packet physical address.\n");\r\nreturn 1;\r\n}\r\noutl(command_que_value, TW_COMMAND_QUEUE_REG_ADDR(tw_dev));\r\nif (tw_poll_status_gone(tw_dev, TW_STATUS_RESPONSE_QUEUE_EMPTY, 30) == 0) {\r\nresponse_queue.value = inl(TW_RESPONSE_QUEUE_REG_ADDR(tw_dev));\r\nrequest_id = TW_RESID_OUT(response_queue.response_id);\r\nif (request_id != 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_setfeature(): Unexpected request id.\n");\r\nreturn 1;\r\n}\r\nif (command_packet->status != 0) {\r\ntw_decode_sense(tw_dev, request_id, 0);\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int tw_reset_sequence(TW_Device_Extension *tw_dev)\r\n{\r\nint error = 0;\r\nint tries = 0;\r\nunsigned char c = 1;\r\nwhile (tries < TW_MAX_RESET_TRIES) {\r\nTW_SOFT_RESET(tw_dev);\r\nerror = tw_aen_drain_queue(tw_dev);\r\nif (error) {\r\nprintk(KERN_WARNING "3w-xxxx: scsi%d: AEN drain failed, retrying.\n", tw_dev->host->host_no);\r\ntries++;\r\ncontinue;\r\n}\r\nif (tw_check_errors(tw_dev)) {\r\nprintk(KERN_WARNING "3w-xxxx: scsi%d: Controller errors found, retrying.\n", tw_dev->host->host_no);\r\ntries++;\r\ncontinue;\r\n}\r\nbreak;\r\n}\r\nif (tries >= TW_MAX_RESET_TRIES) {\r\nprintk(KERN_WARNING "3w-xxxx: scsi%d: Controller errors, card not responding, check all cabling.\n", tw_dev->host->host_no);\r\nreturn 1;\r\n}\r\nerror = tw_initconnection(tw_dev, TW_INIT_MESSAGE_CREDITS);\r\nif (error) {\r\nprintk(KERN_WARNING "3w-xxxx: scsi%d: Connection initialization failed.\n", tw_dev->host->host_no);\r\nreturn 1;\r\n}\r\nerror = tw_setfeature(tw_dev, 2, 1, &c);\r\nif (error) {\r\nprintk(KERN_WARNING "3w-xxxx: Unable to set features for card, probable old firmware or card.\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int tw_initialize_device_extension(TW_Device_Extension *tw_dev)\r\n{\r\nint i, error=0;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_initialize_device_extension()\n");\r\nerror = tw_allocate_memory(tw_dev, sizeof(TW_Command), 0);\r\nif (error) {\r\nprintk(KERN_WARNING "3w-xxxx: Command packet memory allocation failed.\n");\r\nreturn 1;\r\n}\r\nerror = tw_allocate_memory(tw_dev, sizeof(TW_Sector), 1);\r\nif (error) {\r\nprintk(KERN_WARNING "3w-xxxx: Generic memory allocation failed.\n");\r\nreturn 1;\r\n}\r\nfor (i=0;i<TW_Q_LENGTH;i++) {\r\ntw_dev->free_queue[i] = i;\r\ntw_dev->state[i] = TW_S_INITIAL;\r\n}\r\ntw_dev->pending_head = TW_Q_START;\r\ntw_dev->pending_tail = TW_Q_START;\r\ntw_dev->chrdev_request_id = TW_IOCTL_CHRDEV_FREE;\r\nmutex_init(&tw_dev->ioctl_lock);\r\ninit_waitqueue_head(&tw_dev->ioctl_wqueue);\r\nreturn 0;\r\n}\r\nstatic int tw_map_scsi_sg_data(struct pci_dev *pdev, struct scsi_cmnd *cmd)\r\n{\r\nint use_sg;\r\ndprintk(KERN_WARNING "3w-xxxx: tw_map_scsi_sg_data()\n");\r\nuse_sg = scsi_dma_map(cmd);\r\nif (use_sg < 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_map_scsi_sg_data(): pci_map_sg() failed.\n");\r\nreturn 0;\r\n}\r\ncmd->SCp.phase = TW_PHASE_SGLIST;\r\ncmd->SCp.have_data_in = use_sg;\r\nreturn use_sg;\r\n}\r\nstatic void tw_unmap_scsi_data(struct pci_dev *pdev, struct scsi_cmnd *cmd)\r\n{\r\ndprintk(KERN_WARNING "3w-xxxx: tw_unmap_scsi_data()\n");\r\nif (cmd->SCp.phase == TW_PHASE_SGLIST)\r\nscsi_dma_unmap(cmd);\r\n}\r\nstatic int tw_reset_device_extension(TW_Device_Extension *tw_dev)\r\n{\r\nint i = 0;\r\nstruct scsi_cmnd *srb;\r\nunsigned long flags = 0;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_reset_device_extension()\n");\r\nset_bit(TW_IN_RESET, &tw_dev->flags);\r\nTW_DISABLE_INTERRUPTS(tw_dev);\r\nTW_MASK_COMMAND_INTERRUPT(tw_dev);\r\nspin_lock_irqsave(tw_dev->host->host_lock, flags);\r\nfor (i=0;i<TW_Q_LENGTH;i++) {\r\nif ((tw_dev->state[i] != TW_S_FINISHED) &&\r\n(tw_dev->state[i] != TW_S_INITIAL) &&\r\n(tw_dev->state[i] != TW_S_COMPLETED)) {\r\nsrb = tw_dev->srb[i];\r\nif (srb != NULL) {\r\nsrb->result = (DID_RESET << 16);\r\ntw_dev->srb[i]->scsi_done(tw_dev->srb[i]);\r\ntw_unmap_scsi_data(tw_dev->tw_pci_dev, tw_dev->srb[i]);\r\n}\r\n}\r\n}\r\nfor (i=0;i<TW_Q_LENGTH;i++) {\r\ntw_dev->free_queue[i] = i;\r\ntw_dev->state[i] = TW_S_INITIAL;\r\n}\r\ntw_dev->free_head = TW_Q_START;\r\ntw_dev->free_tail = TW_Q_START;\r\ntw_dev->posted_request_count = 0;\r\ntw_dev->pending_request_count = 0;\r\ntw_dev->pending_head = TW_Q_START;\r\ntw_dev->pending_tail = TW_Q_START;\r\ntw_dev->reset_print = 0;\r\nspin_unlock_irqrestore(tw_dev->host->host_lock, flags);\r\nif (tw_reset_sequence(tw_dev)) {\r\nprintk(KERN_WARNING "3w-xxxx: scsi%d: Reset sequence failed.\n", tw_dev->host->host_no);\r\nreturn 1;\r\n}\r\nTW_ENABLE_AND_CLEAR_INTERRUPTS(tw_dev);\r\nclear_bit(TW_IN_RESET, &tw_dev->flags);\r\ntw_dev->chrdev_request_id = TW_IOCTL_CHRDEV_FREE;\r\nreturn 0;\r\n}\r\nstatic int tw_scsi_biosparam(struct scsi_device *sdev, struct block_device *bdev,\r\nsector_t capacity, int geom[])\r\n{\r\nint heads, sectors, cylinders;\r\nTW_Device_Extension *tw_dev;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsi_biosparam()\n");\r\ntw_dev = (TW_Device_Extension *)sdev->host->hostdata;\r\nheads = 64;\r\nsectors = 32;\r\ncylinders = sector_div(capacity, heads * sectors);\r\nif (capacity >= 0x200000) {\r\nheads = 255;\r\nsectors = 63;\r\ncylinders = sector_div(capacity, heads * sectors);\r\n}\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsi_biosparam(): heads = %d, sectors = %d, cylinders = %d\n", heads, sectors, cylinders);\r\ngeom[0] = heads;\r\ngeom[1] = sectors;\r\ngeom[2] = cylinders;\r\nreturn 0;\r\n}\r\nstatic int tw_scsi_eh_reset(struct scsi_cmnd *SCpnt)\r\n{\r\nTW_Device_Extension *tw_dev=NULL;\r\nint retval = FAILED;\r\ntw_dev = (TW_Device_Extension *)SCpnt->device->host->hostdata;\r\ntw_dev->num_resets++;\r\nsdev_printk(KERN_WARNING, SCpnt->device,\r\n"WARNING: Command (0x%x) timed out, resetting card.\n",\r\nSCpnt->cmnd[0]);\r\nmutex_lock(&tw_dev->ioctl_lock);\r\nif (tw_reset_device_extension(tw_dev)) {\r\nprintk(KERN_WARNING "3w-xxxx: scsi%d: Reset failed.\n", tw_dev->host->host_no);\r\ngoto out;\r\n}\r\nretval = SUCCESS;\r\nout:\r\nmutex_unlock(&tw_dev->ioctl_lock);\r\nreturn retval;\r\n}\r\nstatic int tw_scsiop_inquiry(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\nTW_Param *param;\r\nTW_Command *command_packet;\r\nunsigned long command_que_value;\r\nunsigned long param_value;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_inquiry()\n");\r\ncommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\r\nif (command_packet == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_inquiry(): Bad command packet virtual address.\n");\r\nreturn 1;\r\n}\r\nmemset(command_packet, 0, sizeof(TW_Sector));\r\ncommand_packet->opcode__sgloffset = TW_OPSGL_IN(2, TW_OP_GET_PARAM);\r\ncommand_packet->size = 4;\r\ncommand_packet->request_id = request_id;\r\ncommand_packet->status = 0;\r\ncommand_packet->flags = 0;\r\ncommand_packet->byte6.parameter_count = 1;\r\nif (tw_dev->alignment_virtual_address[request_id] == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_inquiry(): Bad alignment virtual address.\n");\r\nreturn 1;\r\n}\r\nparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\r\nmemset(param, 0, sizeof(TW_Sector));\r\nparam->table_id = 3;\r\nparam->parameter_id = 3;\r\nparam->parameter_size_bytes = TW_MAX_UNITS;\r\nparam_value = tw_dev->alignment_physical_address[request_id];\r\nif (param_value == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_inquiry(): Bad alignment physical address.\n");\r\nreturn 1;\r\n}\r\ncommand_packet->byte8.param.sgl[0].address = param_value;\r\ncommand_packet->byte8.param.sgl[0].length = sizeof(TW_Sector);\r\ncommand_que_value = tw_dev->command_packet_physical_address[request_id];\r\nif (command_que_value == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_inquiry(): Bad command packet physical address.\n");\r\nreturn 1;\r\n}\r\ntw_post_command_packet(tw_dev, request_id);\r\nreturn 0;\r\n}\r\nstatic void tw_transfer_internal(TW_Device_Extension *tw_dev, int request_id,\r\nvoid *data, unsigned int len)\r\n{\r\nscsi_sg_copy_from_buffer(tw_dev->srb[request_id], data, len);\r\n}\r\nstatic int tw_scsiop_inquiry_complete(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\nunsigned char *is_unit_present;\r\nunsigned char request_buffer[36];\r\nTW_Param *param;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_inquiry_complete()\n");\r\nmemset(request_buffer, 0, sizeof(request_buffer));\r\nrequest_buffer[0] = TYPE_DISK;\r\nrequest_buffer[1] = 0;\r\nrequest_buffer[2] = 0;\r\nrequest_buffer[4] = 31;\r\nmemcpy(&request_buffer[8], "3ware ", 8);\r\nsprintf(&request_buffer[16], "Logical Disk %-2d ", tw_dev->srb[request_id]->device->id);\r\nmemcpy(&request_buffer[32], TW_DRIVER_VERSION, 3);\r\ntw_transfer_internal(tw_dev, request_id, request_buffer,\r\nsizeof(request_buffer));\r\nparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\r\nif (param == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_inquiry_complete(): Bad alignment virtual address.\n");\r\nreturn 1;\r\n}\r\nis_unit_present = &(param->data[0]);\r\nif (is_unit_present[tw_dev->srb[request_id]->device->id] & TW_UNIT_ONLINE) {\r\ntw_dev->is_unit_present[tw_dev->srb[request_id]->device->id] = 1;\r\n} else {\r\ntw_dev->is_unit_present[tw_dev->srb[request_id]->device->id] = 0;\r\ntw_dev->srb[request_id]->result = (DID_BAD_TARGET << 16);\r\nreturn TW_ISR_DONT_RESULT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tw_scsiop_mode_sense(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\nTW_Param *param;\r\nTW_Command *command_packet;\r\nunsigned long command_que_value;\r\nunsigned long param_value;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_mode_sense()\n");\r\nif (tw_dev->srb[request_id]->cmnd[2] != 0x8) {\r\ntw_dev->state[request_id] = TW_S_COMPLETED;\r\ntw_state_request_finish(tw_dev, request_id);\r\ntw_dev->srb[request_id]->result = (DID_OK << 16);\r\ntw_dev->srb[request_id]->scsi_done(tw_dev->srb[request_id]);\r\nreturn 0;\r\n}\r\ncommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\r\nif (command_packet == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_mode_sense(): Bad command packet virtual address.\n");\r\nreturn 1;\r\n}\r\nmemset(command_packet, 0, sizeof(TW_Sector));\r\ncommand_packet->opcode__sgloffset = TW_OPSGL_IN(2, TW_OP_GET_PARAM);\r\ncommand_packet->size = 4;\r\ncommand_packet->request_id = request_id;\r\ncommand_packet->status = 0;\r\ncommand_packet->flags = 0;\r\ncommand_packet->byte6.parameter_count = 1;\r\nif (tw_dev->alignment_virtual_address[request_id] == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_mode_sense(): Bad alignment virtual address.\n");\r\nreturn 1;\r\n}\r\nparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\r\nmemset(param, 0, sizeof(TW_Sector));\r\nparam->table_id = TW_UNIT_INFORMATION_TABLE_BASE + tw_dev->srb[request_id]->device->id;\r\nparam->parameter_id = 7;\r\nparam->parameter_size_bytes = 1;\r\nparam_value = tw_dev->alignment_physical_address[request_id];\r\nif (param_value == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_mode_sense(): Bad alignment physical address.\n");\r\nreturn 1;\r\n}\r\ncommand_packet->byte8.param.sgl[0].address = param_value;\r\ncommand_packet->byte8.param.sgl[0].length = sizeof(TW_Sector);\r\ncommand_que_value = tw_dev->command_packet_physical_address[request_id];\r\nif (command_que_value == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_mode_sense(): Bad command packet physical address.\n");\r\nreturn 1;\r\n}\r\ntw_post_command_packet(tw_dev, request_id);\r\nreturn 0;\r\n}\r\nstatic int tw_scsiop_mode_sense_complete(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\nTW_Param *param;\r\nunsigned char *flags;\r\nunsigned char request_buffer[8];\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_mode_sense_complete()\n");\r\nparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\r\nif (param == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_mode_sense_complete(): Bad alignment virtual address.\n");\r\nreturn 1;\r\n}\r\nflags = (char *)&(param->data[0]);\r\nmemset(request_buffer, 0, sizeof(request_buffer));\r\nrequest_buffer[0] = 0xf;\r\nrequest_buffer[1] = 0;\r\nrequest_buffer[2] = 0x10;\r\nrequest_buffer[3] = 0;\r\nrequest_buffer[4] = 0x8;\r\nrequest_buffer[5] = 0xa;\r\nif (*flags & 0x1)\r\nrequest_buffer[6] = 0x5;\r\nelse\r\nrequest_buffer[6] = 0x1;\r\ntw_transfer_internal(tw_dev, request_id, request_buffer,\r\nsizeof(request_buffer));\r\nreturn 0;\r\n}\r\nstatic int tw_scsiop_read_capacity(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\nTW_Param *param;\r\nTW_Command *command_packet;\r\nunsigned long command_que_value;\r\nunsigned long param_value;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_read_capacity()\n");\r\ncommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\r\nif (command_packet == NULL) {\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_read_capacity(): Bad command packet virtual address.\n");\r\nreturn 1;\r\n}\r\nmemset(command_packet, 0, sizeof(TW_Sector));\r\ncommand_packet->opcode__sgloffset = TW_OPSGL_IN(2, TW_OP_GET_PARAM);\r\ncommand_packet->size = 4;\r\ncommand_packet->request_id = request_id;\r\ncommand_packet->unit__hostid = TW_UNITHOST_IN(0, tw_dev->srb[request_id]->device->id);\r\ncommand_packet->status = 0;\r\ncommand_packet->flags = 0;\r\ncommand_packet->byte6.block_count = 1;\r\nif (tw_dev->alignment_virtual_address[request_id] == NULL) {\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_read_capacity(): Bad alignment virtual address.\n");\r\nreturn 1;\r\n}\r\nparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\r\nmemset(param, 0, sizeof(TW_Sector));\r\nparam->table_id = TW_UNIT_INFORMATION_TABLE_BASE +\r\ntw_dev->srb[request_id]->device->id;\r\nparam->parameter_id = 4;\r\nparam->parameter_size_bytes = 4;\r\nparam_value = tw_dev->alignment_physical_address[request_id];\r\nif (param_value == 0) {\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_read_capacity(): Bad alignment physical address.\n");\r\nreturn 1;\r\n}\r\ncommand_packet->byte8.param.sgl[0].address = param_value;\r\ncommand_packet->byte8.param.sgl[0].length = sizeof(TW_Sector);\r\ncommand_que_value = tw_dev->command_packet_physical_address[request_id];\r\nif (command_que_value == 0) {\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_read_capacity(): Bad command packet physical address.\n");\r\nreturn 1;\r\n}\r\ntw_post_command_packet(tw_dev, request_id);\r\nreturn 0;\r\n}\r\nstatic int tw_scsiop_read_capacity_complete(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\nunsigned char *param_data;\r\nu32 capacity;\r\nchar buff[8];\r\nTW_Param *param;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_read_capacity_complete()\n");\r\nmemset(buff, 0, sizeof(buff));\r\nparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\r\nif (param == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_read_capacity_complete(): Bad alignment virtual address.\n");\r\nreturn 1;\r\n}\r\nparam_data = &(param->data[0]);\r\ncapacity = (param_data[3] << 24) | (param_data[2] << 16) |\r\n(param_data[1] << 8) | param_data[0];\r\ncapacity -= 1;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_read_capacity_complete(): Capacity = 0x%x.\n", capacity);\r\nbuff[0] = (capacity >> 24);\r\nbuff[1] = (capacity >> 16) & 0xff;\r\nbuff[2] = (capacity >> 8) & 0xff;\r\nbuff[3] = capacity & 0xff;\r\nbuff[4] = (TW_BLOCK_SIZE >> 24);\r\nbuff[5] = (TW_BLOCK_SIZE >> 16) & 0xff;\r\nbuff[6] = (TW_BLOCK_SIZE >> 8) & 0xff;\r\nbuff[7] = TW_BLOCK_SIZE & 0xff;\r\ntw_transfer_internal(tw_dev, request_id, buff, sizeof(buff));\r\nreturn 0;\r\n}\r\nstatic int tw_scsiop_read_write(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\nTW_Command *command_packet;\r\nunsigned long command_que_value;\r\nu32 lba = 0x0, num_sectors = 0x0;\r\nint i, use_sg;\r\nstruct scsi_cmnd *srb;\r\nstruct scatterlist *sglist, *sg;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_read_write()\n");\r\nsrb = tw_dev->srb[request_id];\r\nsglist = scsi_sglist(srb);\r\nif (!sglist) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_read_write(): Request buffer NULL.\n");\r\nreturn 1;\r\n}\r\ncommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\r\nif (command_packet == NULL) {\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_read_write(): Bad command packet virtual address.\n");\r\nreturn 1;\r\n}\r\nif (srb->cmnd[0] == READ_6 || srb->cmnd[0] == READ_10) {\r\ncommand_packet->opcode__sgloffset = TW_OPSGL_IN(3, TW_OP_READ);\r\n} else {\r\ncommand_packet->opcode__sgloffset = TW_OPSGL_IN(3, TW_OP_WRITE);\r\n}\r\ncommand_packet->size = 3;\r\ncommand_packet->request_id = request_id;\r\ncommand_packet->unit__hostid = TW_UNITHOST_IN(0, srb->device->id);\r\ncommand_packet->status = 0;\r\ncommand_packet->flags = 0;\r\nif (srb->cmnd[0] == WRITE_10) {\r\nif ((srb->cmnd[1] & 0x8) || (srb->cmnd[1] & 0x10))\r\ncommand_packet->flags = 1;\r\n}\r\nif (srb->cmnd[0] == READ_6 || srb->cmnd[0] == WRITE_6) {\r\nlba = ((u32)srb->cmnd[1] << 16) | ((u32)srb->cmnd[2] << 8) | (u32)srb->cmnd[3];\r\nnum_sectors = (u32)srb->cmnd[4];\r\n} else {\r\nlba = ((u32)srb->cmnd[2] << 24) | ((u32)srb->cmnd[3] << 16) | ((u32)srb->cmnd[4] << 8) | (u32)srb->cmnd[5];\r\nnum_sectors = (u32)srb->cmnd[8] | ((u32)srb->cmnd[7] << 8);\r\n}\r\ntw_dev->sector_count = num_sectors;\r\nif (tw_dev->sector_count > tw_dev->max_sector_count)\r\ntw_dev->max_sector_count = tw_dev->sector_count;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_read_write(): lba = 0x%x num_sectors = 0x%x\n", lba, num_sectors);\r\ncommand_packet->byte8.io.lba = lba;\r\ncommand_packet->byte6.block_count = num_sectors;\r\nuse_sg = tw_map_scsi_sg_data(tw_dev->tw_pci_dev, tw_dev->srb[request_id]);\r\nif (!use_sg)\r\nreturn 1;\r\nscsi_for_each_sg(tw_dev->srb[request_id], sg, use_sg, i) {\r\ncommand_packet->byte8.io.sgl[i].address = sg_dma_address(sg);\r\ncommand_packet->byte8.io.sgl[i].length = sg_dma_len(sg);\r\ncommand_packet->size+=2;\r\n}\r\ntw_dev->sgl_entries = scsi_sg_count(tw_dev->srb[request_id]);\r\nif (tw_dev->sgl_entries > tw_dev->max_sgl_entries)\r\ntw_dev->max_sgl_entries = tw_dev->sgl_entries;\r\ncommand_que_value = tw_dev->command_packet_physical_address[request_id];\r\nif (command_que_value == 0) {\r\ndprintk(KERN_WARNING "3w-xxxx: tw_scsiop_read_write(): Bad command packet physical address.\n");\r\nreturn 1;\r\n}\r\ntw_post_command_packet(tw_dev, request_id);\r\nreturn 0;\r\n}\r\nstatic int tw_scsiop_request_sense(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\nchar request_buffer[18];\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_request_sense()\n");\r\nmemset(request_buffer, 0, sizeof(request_buffer));\r\nrequest_buffer[0] = 0x70;\r\nrequest_buffer[7] = 10;\r\ntw_transfer_internal(tw_dev, request_id, request_buffer,\r\nsizeof(request_buffer));\r\ntw_dev->state[request_id] = TW_S_COMPLETED;\r\ntw_state_request_finish(tw_dev, request_id);\r\ntw_dev->srb[request_id]->result = (DID_ERROR << 16);\r\ntw_dev->srb[request_id]->scsi_done(tw_dev->srb[request_id]);\r\nreturn 0;\r\n}\r\nstatic int tw_scsiop_synchronize_cache(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\nTW_Command *command_packet;\r\nunsigned long command_que_value;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_synchronize_cache()\n");\r\ncommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\r\nif (command_packet == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_synchronize_cache(): Bad command packet virtual address.\n");\r\nreturn 1;\r\n}\r\nmemset(command_packet, 0, sizeof(TW_Sector));\r\ncommand_packet->opcode__sgloffset = TW_OPSGL_IN(0, TW_OP_FLUSH_CACHE);\r\ncommand_packet->size = 2;\r\ncommand_packet->request_id = request_id;\r\ncommand_packet->unit__hostid = TW_UNITHOST_IN(0, tw_dev->srb[request_id]->device->id);\r\ncommand_packet->status = 0;\r\ncommand_packet->flags = 0;\r\ncommand_packet->byte6.parameter_count = 1;\r\ncommand_que_value = tw_dev->command_packet_physical_address[request_id];\r\nif (command_que_value == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_synchronize_cache(): Bad command packet physical address.\n");\r\nreturn 1;\r\n}\r\ntw_post_command_packet(tw_dev, request_id);\r\nreturn 0;\r\n}\r\nstatic int tw_scsiop_test_unit_ready(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\nTW_Param *param;\r\nTW_Command *command_packet;\r\nunsigned long command_que_value;\r\nunsigned long param_value;\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsiop_test_unit_ready()\n");\r\ncommand_packet = (TW_Command *)tw_dev->command_packet_virtual_address[request_id];\r\nif (command_packet == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_test_unit_ready(): Bad command packet virtual address.\n");\r\nreturn 1;\r\n}\r\nmemset(command_packet, 0, sizeof(TW_Sector));\r\ncommand_packet->opcode__sgloffset = TW_OPSGL_IN(2, TW_OP_GET_PARAM);\r\ncommand_packet->size = 4;\r\ncommand_packet->request_id = request_id;\r\ncommand_packet->status = 0;\r\ncommand_packet->flags = 0;\r\ncommand_packet->byte6.parameter_count = 1;\r\nif (tw_dev->alignment_virtual_address[request_id] == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_test_unit_ready(): Bad alignment virtual address.\n");\r\nreturn 1;\r\n}\r\nparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\r\nmemset(param, 0, sizeof(TW_Sector));\r\nparam->table_id = 3;\r\nparam->parameter_id = 3;\r\nparam->parameter_size_bytes = TW_MAX_UNITS;\r\nparam_value = tw_dev->alignment_physical_address[request_id];\r\nif (param_value == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_test_unit_ready(): Bad alignment physical address.\n");\r\nreturn 1;\r\n}\r\ncommand_packet->byte8.param.sgl[0].address = param_value;\r\ncommand_packet->byte8.param.sgl[0].length = sizeof(TW_Sector);\r\ncommand_que_value = tw_dev->command_packet_physical_address[request_id];\r\nif (command_que_value == 0) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_test_unit_ready(): Bad command packet physical address.\n");\r\nreturn 1;\r\n}\r\ntw_post_command_packet(tw_dev, request_id);\r\nreturn 0;\r\n}\r\nstatic int tw_scsiop_test_unit_ready_complete(TW_Device_Extension *tw_dev, int request_id)\r\n{\r\nunsigned char *is_unit_present;\r\nTW_Param *param;\r\ndprintk(KERN_WARNING "3w-xxxx: tw_scsiop_test_unit_ready_complete()\n");\r\nparam = (TW_Param *)tw_dev->alignment_virtual_address[request_id];\r\nif (param == NULL) {\r\nprintk(KERN_WARNING "3w-xxxx: tw_scsiop_test_unit_ready_complete(): Bad alignment virtual address.\n");\r\nreturn 1;\r\n}\r\nis_unit_present = &(param->data[0]);\r\nif (is_unit_present[tw_dev->srb[request_id]->device->id] & TW_UNIT_ONLINE) {\r\ntw_dev->is_unit_present[tw_dev->srb[request_id]->device->id] = 1;\r\n} else {\r\ntw_dev->is_unit_present[tw_dev->srb[request_id]->device->id] = 0;\r\ntw_dev->srb[request_id]->result = (DID_BAD_TARGET << 16);\r\nreturn TW_ISR_DONT_RESULT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tw_scsi_queue_lck(struct scsi_cmnd *SCpnt, void (*done)(struct scsi_cmnd *))\r\n{\r\nunsigned char *command = SCpnt->cmnd;\r\nint request_id = 0;\r\nint retval = 1;\r\nTW_Device_Extension *tw_dev = (TW_Device_Extension *)SCpnt->device->host->hostdata;\r\nif (test_bit(TW_IN_RESET, &tw_dev->flags))\r\nreturn SCSI_MLQUEUE_HOST_BUSY;\r\nSCpnt->scsi_done = done;\r\ntw_state_request_start(tw_dev, &request_id);\r\ntw_dev->srb[request_id] = SCpnt;\r\nSCpnt->SCp.phase = TW_PHASE_INITIAL;\r\nswitch (*command) {\r\ncase READ_10:\r\ncase READ_6:\r\ncase WRITE_10:\r\ncase WRITE_6:\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsi_queue(): caught READ/WRITE.\n");\r\nretval = tw_scsiop_read_write(tw_dev, request_id);\r\nbreak;\r\ncase TEST_UNIT_READY:\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsi_queue(): caught TEST_UNIT_READY.\n");\r\nretval = tw_scsiop_test_unit_ready(tw_dev, request_id);\r\nbreak;\r\ncase INQUIRY:\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsi_queue(): caught INQUIRY.\n");\r\nretval = tw_scsiop_inquiry(tw_dev, request_id);\r\nbreak;\r\ncase READ_CAPACITY:\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsi_queue(): caught READ_CAPACITY.\n");\r\nretval = tw_scsiop_read_capacity(tw_dev, request_id);\r\nbreak;\r\ncase REQUEST_SENSE:\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsi_queue(): caught REQUEST_SENSE.\n");\r\nretval = tw_scsiop_request_sense(tw_dev, request_id);\r\nbreak;\r\ncase MODE_SENSE:\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsi_queue(): caught MODE_SENSE.\n");\r\nretval = tw_scsiop_mode_sense(tw_dev, request_id);\r\nbreak;\r\ncase SYNCHRONIZE_CACHE:\r\ndprintk(KERN_NOTICE "3w-xxxx: tw_scsi_queue(): caught SYNCHRONIZE_CACHE.\n");\r\nretval = tw_scsiop_synchronize_cache(tw_dev, request_id);\r\nbreak;\r\ncase TW_IOCTL:\r\nprintk(KERN_WARNING "3w-xxxx: SCSI_IOCTL_SEND_COMMAND deprecated, please update your 3ware tools.\n");\r\nbreak;\r\ndefault:\r\nprintk(KERN_NOTICE "3w-xxxx: scsi%d: Unknown scsi opcode: 0x%x\n", tw_dev->host->host_no, *command);\r\ntw_dev->state[request_id] = TW_S_COMPLETED;\r\ntw_state_request_finish(tw_dev, request_id);\r\nSCpnt->result = (DRIVER_SENSE << 24) | SAM_STAT_CHECK_CONDITION;\r\nscsi_build_sense_buffer(1, SCpnt->sense_buffer, ILLEGAL_REQUEST, 0x20, 0);\r\ndone(SCpnt);\r\nretval = 0;\r\n}\r\nif (retval) {\r\ntw_dev->state[request_id] = TW_S_COMPLETED;\r\ntw_state_request_finish(tw_dev, request_id);\r\nSCpnt->result = (DID_ERROR << 16);\r\ndone(SCpnt);\r\nretval = 0;\r\n}\r\nreturn retval;\r\n}\r\nvoid __tw_shutdown(TW_Device_Extension *tw_dev)\r\n{\r\nTW_DISABLE_INTERRUPTS(tw_dev);\r\nfree_irq(tw_dev->tw_pci_dev->irq, tw_dev);\r\nprintk(KERN_WARNING "3w-xxxx: Shutting down host %d.\n", tw_dev->host->host_no);\r\nif (tw_initconnection(tw_dev, 1)) {\r\nprintk(KERN_WARNING "3w-xxxx: Connection shutdown failed.\n");\r\n} else {\r\nprintk(KERN_WARNING "3w-xxxx: Shutdown complete.\n");\r\n}\r\nTW_ENABLE_AND_CLEAR_INTERRUPTS(tw_dev);\r\n}\r\nstatic void tw_shutdown(struct pci_dev *pdev)\r\n{\r\nstruct Scsi_Host *host = pci_get_drvdata(pdev);\r\nTW_Device_Extension *tw_dev = (TW_Device_Extension *)host->hostdata;\r\n__tw_shutdown(tw_dev);\r\n}\r\nstatic int tw_slave_configure(struct scsi_device *sdev)\r\n{\r\nblk_queue_rq_timeout(sdev->request_queue, 60 * HZ);\r\nreturn 0;\r\n}\r\nstatic int tw_probe(struct pci_dev *pdev, const struct pci_device_id *dev_id)\r\n{\r\nstruct Scsi_Host *host = NULL;\r\nTW_Device_Extension *tw_dev;\r\nint retval = -ENODEV;\r\nretval = pci_enable_device(pdev);\r\nif (retval) {\r\nprintk(KERN_WARNING "3w-xxxx: Failed to enable pci device.");\r\ngoto out_disable_device;\r\n}\r\npci_set_master(pdev);\r\nretval = pci_set_dma_mask(pdev, TW_DMA_MASK);\r\nif (retval) {\r\nprintk(KERN_WARNING "3w-xxxx: Failed to set dma mask.");\r\ngoto out_disable_device;\r\n}\r\nhost = scsi_host_alloc(&driver_template, sizeof(TW_Device_Extension));\r\nif (!host) {\r\nprintk(KERN_WARNING "3w-xxxx: Failed to allocate memory for device extension.");\r\nretval = -ENOMEM;\r\ngoto out_disable_device;\r\n}\r\ntw_dev = (TW_Device_Extension *)host->hostdata;\r\ntw_dev->host = host;\r\ntw_dev->tw_pci_dev = pdev;\r\nif (tw_initialize_device_extension(tw_dev)) {\r\nprintk(KERN_WARNING "3w-xxxx: Failed to initialize device extension.");\r\ngoto out_free_device_extension;\r\n}\r\nretval = pci_request_regions(pdev, "3w-xxxx");\r\nif (retval) {\r\nprintk(KERN_WARNING "3w-xxxx: Failed to get mem region.");\r\ngoto out_free_device_extension;\r\n}\r\ntw_dev->base_addr = pci_resource_start(pdev, 0);\r\nif (!tw_dev->base_addr) {\r\nprintk(KERN_WARNING "3w-xxxx: Failed to get io address.");\r\ngoto out_release_mem_region;\r\n}\r\nTW_DISABLE_INTERRUPTS(tw_dev);\r\nif (tw_reset_sequence(tw_dev))\r\ngoto out_release_mem_region;\r\nhost->max_id = TW_MAX_UNITS;\r\nhost->max_cmd_len = TW_MAX_CDB_LEN;\r\nhost->max_lun = 0;\r\nhost->max_channel = 0;\r\nretval = scsi_add_host(host, &pdev->dev);\r\nif (retval) {\r\nprintk(KERN_WARNING "3w-xxxx: scsi add host failed");\r\ngoto out_release_mem_region;\r\n}\r\npci_set_drvdata(pdev, host);\r\nprintk(KERN_WARNING "3w-xxxx: scsi%d: Found a 3ware Storage Controller at 0x%x, IRQ: %d.\n", host->host_no, tw_dev->base_addr, pdev->irq);\r\nretval = request_irq(pdev->irq, tw_interrupt, IRQF_SHARED, "3w-xxxx", tw_dev);\r\nif (retval) {\r\nprintk(KERN_WARNING "3w-xxxx: Error requesting IRQ.");\r\ngoto out_remove_host;\r\n}\r\ntw_device_extension_list[tw_device_extension_count] = tw_dev;\r\ntw_device_extension_count++;\r\nTW_ENABLE_AND_CLEAR_INTERRUPTS(tw_dev);\r\nscsi_scan_host(host);\r\nif (twe_major == -1) {\r\nif ((twe_major = register_chrdev (0, "twe", &tw_fops)) < 0)\r\nprintk(KERN_WARNING "3w-xxxx: Failed to register character device.");\r\n}\r\nreturn 0;\r\nout_remove_host:\r\nscsi_remove_host(host);\r\nout_release_mem_region:\r\npci_release_regions(pdev);\r\nout_free_device_extension:\r\ntw_free_device_extension(tw_dev);\r\nscsi_host_put(host);\r\nout_disable_device:\r\npci_disable_device(pdev);\r\nreturn retval;\r\n}\r\nstatic void tw_remove(struct pci_dev *pdev)\r\n{\r\nstruct Scsi_Host *host = pci_get_drvdata(pdev);\r\nTW_Device_Extension *tw_dev = (TW_Device_Extension *)host->hostdata;\r\nscsi_remove_host(tw_dev->host);\r\nif (twe_major >= 0) {\r\nunregister_chrdev(twe_major, "twe");\r\ntwe_major = -1;\r\n}\r\n__tw_shutdown(tw_dev);\r\npci_release_regions(pdev);\r\ntw_free_device_extension(tw_dev);\r\nscsi_host_put(tw_dev->host);\r\npci_disable_device(pdev);\r\ntw_device_extension_count--;\r\n}\r\nstatic int __init tw_init(void)\r\n{\r\nprintk(KERN_WARNING "3ware Storage Controller device driver for Linux v%s.\n", TW_DRIVER_VERSION);\r\nreturn pci_register_driver(&tw_driver);\r\n}\r\nstatic void __exit tw_exit(void)\r\n{\r\npci_unregister_driver(&tw_driver);\r\n}

void board_pcmcia_power(int power)\r\n{\r\nif (power) {\r\ntrizeps_conxs_bcr |= power;\r\ntrizeps_conxs_bcr |= ConXS_BCR_CF_RESET;\r\ntrizeps_conxs_bcr &= ~ConXS_BCR_CF_BUF_EN;\r\nBCR_writew(trizeps_conxs_bcr);\r\nudelay(2000);\r\ntrizeps_conxs_bcr &= ~ConXS_BCR_CF_RESET;\r\nBCR_writew(trizeps_conxs_bcr);\r\nudelay(2000);\r\n} else {\r\ntrizeps_conxs_bcr |= ConXS_BCR_CF_RESET;\r\nBCR_writew(trizeps_conxs_bcr);\r\nudelay(1000);\r\ntrizeps_conxs_bcr &= ~0xf;\r\nBCR_writew(trizeps_conxs_bcr);\r\n}\r\npr_debug("%s: o%s 0x%x\n", __func__, power ? "n" : "ff",\r\ntrizeps_conxs_bcr);\r\n}\r\nstatic void board_backlight_power(int on)\r\n{\r\nif (on)\r\ntrizeps_conxs_bcr |= ConXS_BCR_L_DISP;\r\nelse\r\ntrizeps_conxs_bcr &= ~ConXS_BCR_L_DISP;\r\npr_debug("%s: o%s 0x%x\n", __func__, on ? "n" : "ff",\r\ntrizeps_conxs_bcr);\r\nBCR_writew(trizeps_conxs_bcr);\r\n}\r\nstatic int trizeps4_mci_init(struct device *dev, irq_handler_t mci_detect_int,\r\nvoid *data)\r\n{\r\nint err;\r\nerr = request_irq(TRIZEPS4_MMC_IRQ, mci_detect_int,\r\nIRQF_TRIGGER_RISING, "MMC card detect", data);\r\nif (err) {\r\nprintk(KERN_ERR "trizeps4_mci_init: MMC/SD: can't request"\r\n"MMC card detect IRQ\n");\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void trizeps4_mci_exit(struct device *dev, void *data)\r\n{\r\nfree_irq(TRIZEPS4_MMC_IRQ, data);\r\n}\r\nstatic int trizeps4_irda_startup(struct device *dev)\r\n{\r\ntrizeps_conxs_ircr &= ~ConXS_IRCR_SD;\r\nIRCR_writew(trizeps_conxs_ircr);\r\nreturn 0;\r\n}\r\nstatic void trizeps4_irda_shutdown(struct device *dev)\r\n{\r\ntrizeps_conxs_ircr |= ConXS_IRCR_SD;\r\nIRCR_writew(trizeps_conxs_ircr);\r\n}\r\nstatic void trizeps4_irda_transceiver_mode(struct device *dev, int mode)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nif (mode & IR_SIRMODE)\r\ntrizeps_conxs_ircr &= ~ConXS_IRCR_MODE;\r\nelse if (mode & IR_FIRMODE)\r\ntrizeps_conxs_ircr |= ConXS_IRCR_MODE;\r\nif (mode & IR_OFF)\r\ntrizeps_conxs_ircr |= ConXS_IRCR_SD;\r\nelse\r\ntrizeps_conxs_ircr &= ~ConXS_IRCR_SD;\r\nIRCR_writew(trizeps_conxs_ircr);\r\nlocal_irq_restore(flags);\r\npxa2xx_transceiver_mode(dev, mode);\r\n}\r\nstatic void __init trizeps4_init(void)\r\n{\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(trizeps4_pin_config));\r\nif (machine_is_trizeps4wl()) {\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(trizeps4wl_pin_config));\r\nplatform_add_devices(trizeps4wl_devices,\r\nARRAY_SIZE(trizeps4wl_devices));\r\n} else {\r\nplatform_add_devices(trizeps4_devices,\r\nARRAY_SIZE(trizeps4_devices));\r\n}\r\npxa_set_ffuart_info(NULL);\r\npxa_set_btuart_info(NULL);\r\npxa_set_stuart_info(NULL);\r\nif (0)\r\npxa_set_fb_info(NULL, &sharp_lcd);\r\nelse\r\npxa_set_fb_info(NULL, &toshiba_lcd);\r\npxa_set_mci_info(&trizeps4_mci_platform_data);\r\n#ifndef STATUS_LEDS_ON_STUART_PINS\r\npxa_set_ficp_info(&trizeps4_ficp_platform_data);\r\n#endif\r\npxa_set_ohci_info(&trizeps4_ohci_platform_data);\r\npxa_set_ac97_info(NULL);\r\npxa_set_i2c_info(NULL);\r\ni2c_register_board_info(0, trizeps4_i2c_devices,\r\nARRAY_SIZE(trizeps4_i2c_devices));\r\ntrizeps_conxs_bcr = 0x00A0;\r\nBCR_writew(trizeps_conxs_bcr);\r\nboard_backlight_power(1);\r\n}\r\nstatic void __init trizeps4_map_io(void)\r\n{\r\npxa27x_map_io();\r\niotable_init(trizeps4_io_desc, ARRAY_SIZE(trizeps4_io_desc));\r\nif ((__raw_readl(MSC0) & 0x8) && (__raw_readl(BOOT_DEF) & 0x1)) {\r\n__machine_arch_type = MACH_TYPE_TRIZEPS4WL;\r\ntrizeps4_flash_data[0].width = 2;\r\n} else {\r\n__machine_arch_type = MACH_TYPE_TRIZEPS4;\r\ntrizeps4_flash_data[0].width = 4;\r\n}\r\n}

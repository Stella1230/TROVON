unsigned char SROMbyReadEmbedded(unsigned long dwIoBase, unsigned char byContntOffset)\r\n{\r\nunsigned short wDelay, wNoACK;\r\nunsigned char byWait;\r\nunsigned char byData;\r\nunsigned char byOrg;\r\nbyData = 0xFF;\r\nVNSvInPortB(dwIoBase + MAC_REG_I2MCFG, &byOrg);\r\nVNSvOutPortB(dwIoBase + MAC_REG_I2MCFG, (byOrg & (~I2MCFG_NORETRY)));\r\nfor (wNoACK = 0; wNoACK < W_MAX_I2CRETRY; wNoACK++) {\r\nVNSvOutPortB(dwIoBase + MAC_REG_I2MTGID, EEP_I2C_DEV_ID);\r\nVNSvOutPortB(dwIoBase + MAC_REG_I2MTGAD, byContntOffset);\r\nVNSvOutPortB(dwIoBase + MAC_REG_I2MCSR, I2MCSR_EEMR);\r\nfor (wDelay = 0; wDelay < W_MAX_TIMEOUT; wDelay++) {\r\nVNSvInPortB(dwIoBase + MAC_REG_I2MCSR, &byWait);\r\nif (byWait & (I2MCSR_DONE | I2MCSR_NACK))\r\nbreak;\r\nPCAvDelayByIO(CB_DELAY_LOOP_WAIT);\r\n}\r\nif ((wDelay < W_MAX_TIMEOUT) &&\r\n(!(byWait & I2MCSR_NACK))) {\r\nbreak;\r\n}\r\n}\r\nVNSvInPortB(dwIoBase + MAC_REG_I2MDIPT, &byData);\r\nVNSvOutPortB(dwIoBase + MAC_REG_I2MCFG, byOrg);\r\nreturn byData;\r\n}\r\nbool SROMbWriteEmbedded(unsigned long dwIoBase, unsigned char byContntOffset, unsigned char byData)\r\n{\r\nunsigned short wDelay, wNoACK;\r\nunsigned char byWait;\r\nunsigned char byOrg;\r\nVNSvInPortB(dwIoBase + MAC_REG_I2MCFG, &byOrg);\r\nVNSvOutPortB(dwIoBase + MAC_REG_I2MCFG, (byOrg & (~I2MCFG_NORETRY)));\r\nfor (wNoACK = 0; wNoACK < W_MAX_I2CRETRY; wNoACK++) {\r\nVNSvOutPortB(dwIoBase + MAC_REG_I2MTGID, EEP_I2C_DEV_ID);\r\nVNSvOutPortB(dwIoBase + MAC_REG_I2MTGAD, byContntOffset);\r\nVNSvOutPortB(dwIoBase + MAC_REG_I2MDOPT, byData);\r\nVNSvOutPortB(dwIoBase + MAC_REG_I2MCSR, I2MCSR_EEMW);\r\nfor (wDelay = 0; wDelay < W_MAX_TIMEOUT; wDelay++) {\r\nVNSvInPortB(dwIoBase + MAC_REG_I2MCSR, &byWait);\r\nif (byWait & (I2MCSR_DONE | I2MCSR_NACK))\r\nbreak;\r\nPCAvDelayByIO(CB_DELAY_LOOP_WAIT);\r\n}\r\nif ((wDelay < W_MAX_TIMEOUT) &&\r\n(!(byWait & I2MCSR_NACK))) {\r\nbreak;\r\n}\r\n}\r\nif (wNoACK == W_MAX_I2CRETRY) {\r\nVNSvOutPortB(dwIoBase + MAC_REG_I2MCFG, byOrg);\r\nreturn false;\r\n}\r\nVNSvOutPortB(dwIoBase + MAC_REG_I2MCFG, byOrg);\r\nreturn true;\r\n}\r\nvoid SROMvRegBitsOn(unsigned long dwIoBase, unsigned char byContntOffset, unsigned char byBits)\r\n{\r\nunsigned char byOrgData;\r\nbyOrgData = SROMbyReadEmbedded(dwIoBase, byContntOffset);\r\nSROMbWriteEmbedded(dwIoBase, byContntOffset, (unsigned char)(byOrgData | byBits));\r\n}\r\nvoid SROMvRegBitsOff(unsigned long dwIoBase, unsigned char byContntOffset, unsigned char byBits)\r\n{\r\nunsigned char byOrgData;\r\nbyOrgData = SROMbyReadEmbedded(dwIoBase, byContntOffset);\r\nSROMbWriteEmbedded(dwIoBase, byContntOffset, (unsigned char)(byOrgData & (~byBits)));\r\n}\r\nbool SROMbIsRegBitsOn(unsigned long dwIoBase, unsigned char byContntOffset, unsigned char byTestBits)\r\n{\r\nunsigned char byOrgData;\r\nbyOrgData = SROMbyReadEmbedded(dwIoBase, byContntOffset);\r\nreturn (byOrgData & byTestBits) == byTestBits;\r\n}\r\nbool SROMbIsRegBitsOff(unsigned long dwIoBase, unsigned char byContntOffset, unsigned char byTestBits)\r\n{\r\nunsigned char byOrgData;\r\nbyOrgData = SROMbyReadEmbedded(dwIoBase, byContntOffset);\r\nreturn !(byOrgData & byTestBits);\r\n}\r\nvoid SROMvReadAllContents(unsigned long dwIoBase, unsigned char *pbyEepromRegs)\r\n{\r\nint ii;\r\nfor (ii = 0; ii < EEP_MAX_CONTEXT_SIZE; ii++) {\r\n*pbyEepromRegs = SROMbyReadEmbedded(dwIoBase, (unsigned char)ii);\r\npbyEepromRegs++;\r\n}\r\n}\r\nvoid SROMvWriteAllContents(unsigned long dwIoBase, unsigned char *pbyEepromRegs)\r\n{\r\nint ii;\r\nfor (ii = 0; ii < EEP_MAX_CONTEXT_SIZE; ii++) {\r\nSROMbWriteEmbedded(dwIoBase, (unsigned char)ii, *pbyEepromRegs);\r\npbyEepromRegs++;\r\n}\r\n}\r\nvoid SROMvReadEtherAddress(unsigned long dwIoBase, unsigned char *pbyEtherAddress)\r\n{\r\nunsigned char ii;\r\nfor (ii = 0; ii < ETH_ALEN; ii++) {\r\n*pbyEtherAddress = SROMbyReadEmbedded(dwIoBase, ii);\r\npbyEtherAddress++;\r\n}\r\n}\r\nvoid SROMvWriteEtherAddress(unsigned long dwIoBase, unsigned char *pbyEtherAddress)\r\n{\r\nunsigned char ii;\r\nfor (ii = 0; ii < ETH_ALEN; ii++) {\r\nSROMbWriteEmbedded(dwIoBase, ii, *pbyEtherAddress);\r\npbyEtherAddress++;\r\n}\r\n}\r\nvoid SROMvReadSubSysVenId(unsigned long dwIoBase, unsigned long *pdwSubSysVenId)\r\n{\r\nunsigned char *pbyData;\r\npbyData = (unsigned char *)pdwSubSysVenId;\r\n*pbyData = SROMbyReadEmbedded(dwIoBase, 6);\r\n*(pbyData+1) = SROMbyReadEmbedded(dwIoBase, 7);\r\n*(pbyData+2) = SROMbyReadEmbedded(dwIoBase, 8);\r\n*(pbyData+3) = SROMbyReadEmbedded(dwIoBase, 9);\r\n}\r\nbool SROMbAutoLoad(unsigned long dwIoBase)\r\n{\r\nunsigned char byWait;\r\nint ii;\r\nunsigned char byOrg;\r\nVNSvInPortB(dwIoBase + MAC_REG_I2MCFG, &byOrg);\r\nVNSvOutPortB(dwIoBase + MAC_REG_I2MCFG, (byOrg | I2MCFG_NORETRY));\r\nMACvRegBitsOn(dwIoBase, MAC_REG_I2MCSR, I2MCSR_AUTOLD);\r\nfor (ii = 0; ii < EEP_MAX_CONTEXT_SIZE; ii++) {\r\nMACvTimer0MicroSDelay(dwIoBase, CB_EEPROM_READBYTE_WAIT);\r\nVNSvInPortB(dwIoBase + MAC_REG_I2MCSR, &byWait);\r\nif (!(byWait & I2MCSR_AUTOLD))\r\nbreak;\r\n}\r\nVNSvOutPortB(dwIoBase + MAC_REG_I2MCFG, byOrg);\r\nif (ii == EEP_MAX_CONTEXT_SIZE)\r\nreturn false;\r\nreturn true;\r\n}

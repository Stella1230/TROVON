const char *ath9k_hw_wow_event_to_string(u32 wow_event)\r\n{\r\nif (wow_event & AH_WOW_MAGIC_PATTERN_EN)\r\nreturn "Magic pattern";\r\nif (wow_event & AH_WOW_USER_PATTERN_EN)\r\nreturn "User pattern";\r\nif (wow_event & AH_WOW_LINK_CHANGE)\r\nreturn "Link change";\r\nif (wow_event & AH_WOW_BEACON_MISS)\r\nreturn "Beacon miss";\r\nreturn "unknown reason";\r\n}\r\nstatic void ath9k_hw_set_powermode_wow_sleep(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nREG_SET_BIT(ah, AR_STA_ID1, AR_STA_ID1_PWR_SAV);\r\nREG_WRITE(ah, AR_CR, AR_CR_RXD);\r\nif (!ath9k_hw_wait(ah, AR_CR, AR_CR_RXE, 0, AH_WAIT_TIMEOUT)) {\r\nath_err(common, "Failed to stop Rx DMA in 10ms AR_CR=0x%08x AR_DIAG_SW=0x%08x\n",\r\nREG_READ(ah, AR_CR), REG_READ(ah, AR_DIAG_SW));\r\nreturn;\r\n}\r\nREG_WRITE(ah, AR_RTC_FORCE_WAKE, AR_RTC_FORCE_WAKE_ON_INT);\r\n}\r\nstatic void ath9k_wow_create_keep_alive_pattern(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu8 sta_mac_addr[ETH_ALEN], ap_mac_addr[ETH_ALEN];\r\nu32 ctl[13] = {0};\r\nu32 data_word[KAL_NUM_DATA_WORDS];\r\nu8 i;\r\nu32 wow_ka_data_word0;\r\nmemcpy(sta_mac_addr, common->macaddr, ETH_ALEN);\r\nmemcpy(ap_mac_addr, common->curbssid, ETH_ALEN);\r\nctl[0] = (KAL_FRAME_LEN | (MAX_RATE_POWER << 16));\r\nctl[1] = 0;\r\nctl[3] = 0xb;\r\nctl[4] = 0;\r\nctl[7] = (ah->txchainmask) << 2;\r\nctl[2] = 0xf << 16;\r\nfor (i = 0; i < KAL_NUM_DESC_WORDS; i++)\r\nREG_WRITE(ah, (AR_WOW_KA_DESC_WORD2 + i * 4), ctl[i]);\r\nREG_WRITE(ah, (AR_WOW_KA_DESC_WORD2 + i * 4), ctl[i]);\r\ndata_word[0] = (KAL_FRAME_TYPE << 2) | (KAL_FRAME_SUB_TYPE << 4) |\r\n(KAL_TO_DS << 8) | (KAL_DURATION_ID << 16);\r\ndata_word[1] = (ap_mac_addr[3] << 24) | (ap_mac_addr[2] << 16) |\r\n(ap_mac_addr[1] << 8) | (ap_mac_addr[0]);\r\ndata_word[2] = (sta_mac_addr[1] << 24) | (sta_mac_addr[0] << 16) |\r\n(ap_mac_addr[5] << 8) | (ap_mac_addr[4]);\r\ndata_word[3] = (sta_mac_addr[5] << 24) | (sta_mac_addr[4] << 16) |\r\n(sta_mac_addr[3] << 8) | (sta_mac_addr[2]);\r\ndata_word[4] = (ap_mac_addr[3] << 24) | (ap_mac_addr[2] << 16) |\r\n(ap_mac_addr[1] << 8) | (ap_mac_addr[0]);\r\ndata_word[5] = (ap_mac_addr[5] << 8) | (ap_mac_addr[4]);\r\nif (AR_SREV_9462_20(ah)) {\r\nREG_WRITE(ah, (AR_WOW_KA_DESC_WORD2 + (12 * 4)), 0);\r\nwow_ka_data_word0 = AR_WOW_TXBUF(13);\r\n} else {\r\nwow_ka_data_word0 = AR_WOW_TXBUF(12);\r\n}\r\nfor (i = 0; i < KAL_NUM_DATA_WORDS; i++)\r\nREG_WRITE(ah, (wow_ka_data_word0 + i*4), data_word[i]);\r\n}\r\nvoid ath9k_hw_wow_apply_pattern(struct ath_hw *ah, u8 *user_pattern,\r\nu8 *user_mask, int pattern_count,\r\nint pattern_len)\r\n{\r\nint i;\r\nu32 pattern_val, mask_val;\r\nu32 set, clr;\r\nif (pattern_count >= MAX_NUM_PATTERN)\r\nreturn;\r\nREG_SET_BIT(ah, AR_WOW_PATTERN, BIT(pattern_count));\r\nfor (i = 0; i < MAX_PATTERN_SIZE; i += 4) {\r\nmemcpy(&pattern_val, user_pattern, 4);\r\nREG_WRITE(ah, (AR_WOW_TB_PATTERN(pattern_count) + i),\r\npattern_val);\r\nuser_pattern += 4;\r\n}\r\nfor (i = 0; i < MAX_PATTERN_MASK_SIZE; i += 4) {\r\nmemcpy(&mask_val, user_mask, 4);\r\nREG_WRITE(ah, (AR_WOW_TB_MASK(pattern_count) + i), mask_val);\r\nuser_mask += 4;\r\n}\r\nah->wow_event_mask |= BIT(pattern_count + AR_WOW_PAT_FOUND_SHIFT);\r\nif (pattern_count < 4) {\r\nset = (pattern_len & AR_WOW_LENGTH_MAX) <<\r\nAR_WOW_LEN1_SHIFT(pattern_count);\r\nclr = AR_WOW_LENGTH1_MASK(pattern_count);\r\nREG_RMW(ah, AR_WOW_LENGTH1, set, clr);\r\n} else {\r\nset = (pattern_len & AR_WOW_LENGTH_MAX) <<\r\nAR_WOW_LEN2_SHIFT(pattern_count);\r\nclr = AR_WOW_LENGTH2_MASK(pattern_count);\r\nREG_RMW(ah, AR_WOW_LENGTH2, set, clr);\r\n}\r\n}\r\nu32 ath9k_hw_wow_wakeup(struct ath_hw *ah)\r\n{\r\nu32 wow_status = 0;\r\nu32 val = 0, rval;\r\nrval = REG_READ(ah, AR_WOW_PATTERN);\r\nval = AR_WOW_STATUS(rval);\r\nval &= ah->wow_event_mask;\r\nif (val) {\r\nif (val & AR_WOW_MAGIC_PAT_FOUND)\r\nwow_status |= AH_WOW_MAGIC_PATTERN_EN;\r\nif (AR_WOW_PATTERN_FOUND(val))\r\nwow_status |= AH_WOW_USER_PATTERN_EN;\r\nif (val & AR_WOW_KEEP_ALIVE_FAIL)\r\nwow_status |= AH_WOW_LINK_CHANGE;\r\nif (val & AR_WOW_BEACON_FAIL)\r\nwow_status |= AH_WOW_BEACON_MISS;\r\n}\r\nREG_RMW(ah, AR_PCIE_PM_CTRL, AR_PMCTRL_WOW_PME_CLR,\r\nAR_PMCTRL_PWR_STATE_D1D3);\r\nREG_WRITE(ah, AR_WOW_PATTERN,\r\nAR_WOW_CLEAR_EVENTS(REG_READ(ah, AR_WOW_PATTERN)));\r\nREG_WRITE(ah, AR_RSSI_THR, INIT_RSSI_THR);\r\nif (ah->is_pciexpress)\r\nath9k_hw_configpcipowersave(ah, false);\r\nah->wow_event_mask = 0;\r\nreturn wow_status;\r\n}\r\nvoid ath9k_hw_wow_enable(struct ath_hw *ah, u32 pattern_enable)\r\n{\r\nu32 wow_event_mask;\r\nu32 set, clr;\r\nwow_event_mask = ah->wow_event_mask;\r\nif (ah->is_pciexpress) {\r\nset = AR_WA_RESET_EN | AR_WA_POR_SHORT;\r\nclr = AR_WA_UNTIE_RESET_EN | AR_WA_D3_L1_DISABLE;\r\nREG_RMW(ah, AR_WA, set, clr);\r\n}\r\nset = AR_PMCTRL_HOST_PME_EN | AR_PMCTRL_PWR_PM_CTRL_ENA |\r\nAR_PMCTRL_AUX_PWR_DET | AR_PMCTRL_WOW_PME_CLR;\r\nREG_SET_BIT(ah, AR_PCIE_PM_CTRL, set);\r\nclr = AR_PMCTRL_WOW_PME_CLR;\r\nREG_CLR_BIT(ah, AR_PCIE_PM_CTRL, clr);\r\nset = AR_WOW_BACK_OFF_SHIFT(AR_WOW_PAT_BACKOFF);\r\nREG_SET_BIT(ah, AR_WOW_PATTERN, set);\r\nset = AR_WOW_AIFS_CNT(AR_WOW_CNT_AIFS_CNT) |\r\nAR_WOW_SLOT_CNT(AR_WOW_CNT_SLOT_CNT) |\r\nAR_WOW_KEEP_ALIVE_CNT(AR_WOW_CNT_KA_CNT);\r\nREG_SET_BIT(ah, AR_WOW_COUNT, set);\r\nif (pattern_enable & AH_WOW_BEACON_MISS)\r\nset = AR_WOW_BEACON_TIMO;\r\nelse\r\nset = AR_WOW_BEACON_TIMO_MAX;\r\nREG_WRITE(ah, AR_WOW_BCN_TIMO, set);\r\nif (!pattern_enable)\r\nset = AR_WOW_KEEP_ALIVE_NEVER;\r\nelse\r\nset = KAL_TIMEOUT * 32;\r\nREG_WRITE(ah, AR_WOW_KEEP_ALIVE_TIMO, set);\r\nset = KAL_DELAY * 1000;\r\nREG_WRITE(ah, AR_WOW_KEEP_ALIVE_DELAY, set);\r\nath9k_wow_create_keep_alive_pattern(ah);\r\nset = 0;\r\nclr = AR_WOW_KEEP_ALIVE_AUTO_DIS;\r\nif (pattern_enable & AH_WOW_LINK_CHANGE)\r\nwow_event_mask |= AR_WOW_KEEP_ALIVE_FAIL;\r\nelse\r\nset = AR_WOW_KEEP_ALIVE_FAIL_DIS;\r\nset = AR_WOW_KEEP_ALIVE_FAIL_DIS;\r\nREG_RMW(ah, AR_WOW_KEEP_ALIVE, set, clr);\r\nREG_RMW_FIELD(ah, AR_RSSI_THR, AR_RSSI_THR_BM_THR,\r\nAR_WOW_BMISSTHRESHOLD);\r\nset = 0;\r\nclr = 0;\r\nif (pattern_enable & AH_WOW_BEACON_MISS) {\r\nset = AR_WOW_BEACON_FAIL_EN;\r\nwow_event_mask |= AR_WOW_BEACON_FAIL;\r\n} else {\r\nclr = AR_WOW_BEACON_FAIL_EN;\r\n}\r\nREG_RMW(ah, AR_WOW_BCN_EN, set, clr);\r\nset = 0;\r\nclr = 0;\r\nif (pattern_enable & AH_WOW_MAGIC_PATTERN_EN) {\r\nset = AR_WOW_MAGIC_EN;\r\nwow_event_mask |= AR_WOW_MAGIC_PAT_FOUND;\r\n} else {\r\nclr = AR_WOW_MAGIC_EN;\r\n}\r\nset |= AR_WOW_MAC_INTR_EN;\r\nREG_RMW(ah, AR_WOW_PATTERN, set, clr);\r\nREG_WRITE(ah, AR_WOW_PATTERN_MATCH_LT_256B,\r\nAR_WOW_PATTERN_SUPPORTED);\r\nclr = 0;\r\nset = AR_PMCTRL_PWR_STATE_D1D3 | AR_PMCTRL_HOST_PME_EN |\r\nAR_PMCTRL_PWR_PM_CTRL_ENA;\r\nclr = AR_PCIE_PM_CTRL_ENA;\r\nREG_RMW(ah, AR_PCIE_PM_CTRL, set, clr);\r\nclr = AR_PMCTRL_PWR_STATE_D1D3;\r\nREG_CLR_BIT(ah, AR_PCIE_PM_CTRL, clr);\r\nset = AR_PMCTRL_PWR_STATE_D1D3_REAL;\r\nREG_SET_BIT(ah, AR_PCIE_PM_CTRL, set);\r\nREG_CLR_BIT(ah, AR_STA_ID1, AR_STA_ID1_PRESERVE_SEQNUM);\r\nset = BIT(13);\r\nREG_SET_BIT(ah, AR_PCIE_PHY_REG3, set);\r\nclr = BIT(5);\r\nREG_CLR_BIT(ah, AR_PCU_MISC_MODE3, clr);\r\nath9k_hw_set_powermode_wow_sleep(ah);\r\nah->wow_event_mask = wow_event_mask;\r\n}

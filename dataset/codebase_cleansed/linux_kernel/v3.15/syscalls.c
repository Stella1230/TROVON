static inline unsigned long do_mmap2(unsigned long addr, size_t len,\r\nunsigned long prot, unsigned long flags,\r\nunsigned long fd, unsigned long off, int shift)\r\n{\r\nunsigned long ret = -EINVAL;\r\nif (!arch_validate_prot(prot))\r\ngoto out;\r\nif (shift) {\r\nif (off & ((1 << shift) - 1))\r\ngoto out;\r\noff >>= shift;\r\n}\r\nret = sys_mmap_pgoff(addr, len, prot, flags, fd, off);\r\nout:\r\nreturn ret;\r\n}\r\nunsigned long sys_mmap2(unsigned long addr, size_t len,\r\nunsigned long prot, unsigned long flags,\r\nunsigned long fd, unsigned long pgoff)\r\n{\r\nreturn do_mmap2(addr, len, prot, flags, fd, pgoff, PAGE_SHIFT-12);\r\n}\r\nunsigned long sys_mmap(unsigned long addr, size_t len,\r\nunsigned long prot, unsigned long flags,\r\nunsigned long fd, off_t offset)\r\n{\r\nreturn do_mmap2(addr, len, prot, flags, fd, offset, PAGE_SHIFT);\r\n}\r\nint\r\nppc_select(int n, fd_set __user *inp, fd_set __user *outp, fd_set __user *exp, struct timeval __user *tvp)\r\n{\r\nif ( (unsigned long)n >= 4096 )\r\n{\r\nunsigned long __user *buffer = (unsigned long __user *)n;\r\nif (!access_ok(VERIFY_READ, buffer, 5*sizeof(unsigned long))\r\n|| __get_user(n, buffer)\r\n|| __get_user(inp, ((fd_set __user * __user *)(buffer+1)))\r\n|| __get_user(outp, ((fd_set __user * __user *)(buffer+2)))\r\n|| __get_user(exp, ((fd_set __user * __user *)(buffer+3)))\r\n|| __get_user(tvp, ((struct timeval __user * __user *)(buffer+4))))\r\nreturn -EFAULT;\r\n}\r\nreturn sys_select(n, inp, outp, exp, tvp);\r\n}\r\nlong ppc64_personality(unsigned long personality)\r\n{\r\nlong ret;\r\nif (personality(current->personality) == PER_LINUX32\r\n&& personality(personality) == PER_LINUX)\r\npersonality = (personality & ~PER_MASK) | PER_LINUX32;\r\nret = sys_personality(personality);\r\nif (personality(ret) == PER_LINUX32)\r\nret = (ret & ~PER_MASK) | PER_LINUX;\r\nreturn ret;\r\n}\r\nlong ppc_fadvise64_64(int fd, int advice, u32 offset_high, u32 offset_low,\r\nu32 len_high, u32 len_low)\r\n{\r\nreturn sys_fadvise64(fd, (u64)offset_high << 32 | offset_low,\r\n(u64)len_high << 32 | len_low, advice);\r\n}\r\nvoid do_show_syscall(unsigned long r3, unsigned long r4, unsigned long r5,\r\nunsigned long r6, unsigned long r7, unsigned long r8,\r\nstruct pt_regs *regs)\r\n{\r\nprintk("syscall %ld(%lx, %lx, %lx, %lx, %lx, %lx) regs=%p current=%p"\r\n" cpu=%d\n", regs->gpr[0], r3, r4, r5, r6, r7, r8, regs,\r\ncurrent, smp_processor_id());\r\n}\r\nvoid do_show_syscall_exit(unsigned long r3)\r\n{\r\nprintk(" -> %lx, current=%p cpu=%d\n", r3, current, smp_processor_id());\r\n}

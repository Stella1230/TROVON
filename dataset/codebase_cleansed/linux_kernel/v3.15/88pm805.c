static int device_irq_init_805(struct pm80x_chip *chip)\r\n{\r\nstruct regmap *map = chip->regmap;\r\nunsigned long flags = IRQF_ONESHOT;\r\nint data, mask, ret = -EINVAL;\r\nif (!map || !chip->irq) {\r\ndev_err(chip->dev, "incorrect parameters\n");\r\nreturn -EINVAL;\r\n}\r\nmask =\r\nPM805_STATUS0_INT_CLEAR | PM805_STATUS0_INV_INT |\r\nPM800_STATUS0_INT_MASK;\r\ndata = PM805_STATUS0_INT_CLEAR;\r\nret = regmap_update_bits(map, PM805_INT_STATUS0, mask, data);\r\nmsleep(1);\r\nif (ret < 0)\r\ngoto out;\r\nret =\r\nregmap_add_irq_chip(chip->regmap, chip->irq, flags, -1,\r\nchip->regmap_irq_chip, &chip->irq_data);\r\nout:\r\nreturn ret;\r\n}\r\nstatic void device_irq_exit_805(struct pm80x_chip *chip)\r\n{\r\nregmap_del_irq_chip(chip->irq, chip->irq_data);\r\n}\r\nstatic int device_805_init(struct pm80x_chip *chip)\r\n{\r\nint ret = 0;\r\nstruct regmap *map = chip->regmap;\r\nif (!map) {\r\ndev_err(chip->dev, "regmap is invalid\n");\r\nreturn -EINVAL;\r\n}\r\nchip->regmap_irq_chip = &pm805_irq_chip;\r\nret = device_irq_init_805(chip);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "Failed to init pm805 irq!\n");\r\ngoto out_irq_init;\r\n}\r\nret = mfd_add_devices(chip->dev, 0, &codec_devs[0],\r\nARRAY_SIZE(codec_devs), &codec_resources[0], 0,\r\nNULL);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "Failed to add codec subdev\n");\r\ngoto out_codec;\r\n} else\r\ndev_info(chip->dev, "[%s]:Added mfd codec_devs\n", __func__);\r\nreturn 0;\r\nout_codec:\r\ndevice_irq_exit_805(chip);\r\nout_irq_init:\r\nreturn ret;\r\n}\r\nstatic int pm805_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nint ret = 0;\r\nstruct pm80x_chip *chip;\r\nstruct pm80x_platform_data *pdata = dev_get_platdata(&client->dev);\r\nret = pm80x_init(client);\r\nif (ret) {\r\ndev_err(&client->dev, "pm805_init fail!\n");\r\ngoto out_init;\r\n}\r\nchip = i2c_get_clientdata(client);\r\nret = device_805_init(chip);\r\nif (ret) {\r\ndev_err(chip->dev, "Failed to initialize 88pm805 devices\n");\r\ngoto err_805_init;\r\n}\r\nif (pdata && pdata->plat_config)\r\npdata->plat_config(chip, pdata);\r\nerr_805_init:\r\npm80x_deinit();\r\nout_init:\r\nreturn ret;\r\n}\r\nstatic int pm805_remove(struct i2c_client *client)\r\n{\r\nstruct pm80x_chip *chip = i2c_get_clientdata(client);\r\nmfd_remove_devices(chip->dev);\r\ndevice_irq_exit_805(chip);\r\npm80x_deinit();\r\nreturn 0;\r\n}\r\nstatic int __init pm805_i2c_init(void)\r\n{\r\nreturn i2c_add_driver(&pm805_driver);\r\n}\r\nstatic void __exit pm805_i2c_exit(void)\r\n{\r\ni2c_del_driver(&pm805_driver);\r\n}

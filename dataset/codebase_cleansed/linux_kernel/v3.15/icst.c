unsigned long icst_hz(const struct icst_params *p, struct icst_vco vco)\r\n{\r\nreturn p->ref * 2 * (vco.v + 8) / ((vco.r + 2) * p->s2div[vco.s]);\r\n}\r\nstruct icst_vco\r\nicst_hz_to_vco(const struct icst_params *p, unsigned long freq)\r\n{\r\nstruct icst_vco vco = { .s = 1, .v = p->vd_max, .r = p->rd_max };\r\nunsigned long f;\r\nunsigned int i = 0, rd, best = (unsigned int)-1;\r\ndo {\r\nf = freq * p->s2div[p->idx2s[i]];\r\nif (f > p->vco_min && f <= p->vco_max)\r\nbreak;\r\n} while (i < 8);\r\nif (i >= 8)\r\nreturn vco;\r\nvco.s = p->idx2s[i];\r\nfor (rd = p->rd_min; rd <= p->rd_max; rd++) {\r\nunsigned long fref_div, f_pll;\r\nunsigned int vd;\r\nint f_diff;\r\nfref_div = (2 * p->ref) / rd;\r\nvd = (f + fref_div / 2) / fref_div;\r\nif (vd < p->vd_min || vd > p->vd_max)\r\ncontinue;\r\nf_pll = fref_div * vd;\r\nf_diff = f_pll - f;\r\nif (f_diff < 0)\r\nf_diff = -f_diff;\r\nif ((unsigned)f_diff < best) {\r\nvco.v = vd - 8;\r\nvco.r = rd - 2;\r\nif (f_diff == 0)\r\nbreak;\r\nbest = f_diff;\r\n}\r\n}\r\nreturn vco;\r\n}

static void __msm_gpiomux_write(unsigned gpio, gpiomux_config_t val)\r\n{\r\nunsigned tlmm_config = (val & ~GPIOMUX_CTL_MASK) |\r\n((gpio & 0x3ff) << 4);\r\nunsigned tlmm_disable = 0;\r\nint rc;\r\nrc = msm_proc_comm(PCOM_RPC_GPIO_TLMM_CONFIG_EX,\r\n&tlmm_config, &tlmm_disable);\r\nif (rc)\r\npr_err("%s: unexpected proc_comm failure %d: %08x %08x\n",\r\n__func__, rc, tlmm_config, tlmm_disable);\r\n}\r\nint msm_gpiomux_write(unsigned gpio,\r\ngpiomux_config_t active,\r\ngpiomux_config_t suspended)\r\n{\r\nstruct msm_gpiomux_config *cfg = msm_gpiomux_configs + gpio;\r\nunsigned long irq_flags;\r\ngpiomux_config_t setting;\r\nif (gpio >= GPIOMUX_NGPIOS)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&gpiomux_lock, irq_flags);\r\nif (active & GPIOMUX_VALID)\r\ncfg->active = active;\r\nif (suspended & GPIOMUX_VALID)\r\ncfg->suspended = suspended;\r\nsetting = cfg->ref ? active : suspended;\r\nif (setting & GPIOMUX_VALID)\r\n__msm_gpiomux_write(gpio, setting);\r\nspin_unlock_irqrestore(&gpiomux_lock, irq_flags);\r\nreturn 0;\r\n}\r\nint msm_gpiomux_get(unsigned gpio)\r\n{\r\nstruct msm_gpiomux_config *cfg = msm_gpiomux_configs + gpio;\r\nunsigned long irq_flags;\r\nif (gpio >= GPIOMUX_NGPIOS)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&gpiomux_lock, irq_flags);\r\nif (cfg->ref++ == 0 && cfg->active & GPIOMUX_VALID)\r\n__msm_gpiomux_write(gpio, cfg->active);\r\nspin_unlock_irqrestore(&gpiomux_lock, irq_flags);\r\nreturn 0;\r\n}\r\nint msm_gpiomux_put(unsigned gpio)\r\n{\r\nstruct msm_gpiomux_config *cfg = msm_gpiomux_configs + gpio;\r\nunsigned long irq_flags;\r\nif (gpio >= GPIOMUX_NGPIOS)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&gpiomux_lock, irq_flags);\r\nBUG_ON(cfg->ref == 0);\r\nif (--cfg->ref == 0 && cfg->suspended & GPIOMUX_VALID)\r\n__msm_gpiomux_write(gpio, cfg->suspended);\r\nspin_unlock_irqrestore(&gpiomux_lock, irq_flags);\r\nreturn 0;\r\n}\r\nstatic int __init gpiomux_init(void)\r\n{\r\nunsigned n;\r\nfor (n = 0; n < GPIOMUX_NGPIOS; ++n) {\r\nmsm_gpiomux_configs[n].ref = 0;\r\nif (!(msm_gpiomux_configs[n].suspended & GPIOMUX_VALID))\r\ncontinue;\r\n__msm_gpiomux_write(n, msm_gpiomux_configs[n].suspended);\r\n}\r\nreturn 0;\r\n}

const char *get_system_type(void)\r\n{\r\nreturn "MIPS SEAD3";\r\n}\r\nstatic uint32_t get_memsize_from_cmdline(void)\r\n{\r\nint memsize = 0;\r\nchar *p = arcs_cmdline;\r\nchar *s = "memsize=";\r\np = strstr(p, s);\r\nif (p) {\r\np += strlen(s);\r\nmemsize = memparse(p, NULL);\r\n}\r\nreturn memsize;\r\n}\r\nstatic uint32_t get_memsize_from_env(void)\r\n{\r\nint memsize = 0;\r\nchar *p;\r\np = fw_getenv("memsize");\r\nif (p)\r\nmemsize = memparse(p, NULL);\r\nreturn memsize;\r\n}\r\nstatic uint32_t get_memsize(void)\r\n{\r\nuint32_t memsize;\r\nmemsize = get_memsize_from_cmdline();\r\nif (memsize)\r\nreturn memsize;\r\nreturn get_memsize_from_env();\r\n}\r\nstatic void __init parse_memsize_param(void)\r\n{\r\nint offset;\r\nconst uint64_t *prop_value;\r\nint prop_len;\r\nuint32_t memsize = get_memsize();\r\nif (!memsize)\r\nreturn;\r\noffset = fdt_path_offset(&__dtb_start, "/memory");\r\nif (offset > 0) {\r\nuint64_t new_value;\r\nprop_value = fdt_getprop(&__dtb_start, offset, "reg", &prop_len);\r\nnew_value = be64_to_cpu(*prop_value);\r\nnew_value = (new_value & ~0xffffffffllu) | memsize;\r\nfdt_setprop_inplace_u64(&__dtb_start, offset, "reg", new_value);\r\n}\r\n}\r\nvoid __init plat_mem_setup(void)\r\n{\r\nparse_memsize_param();\r\n__dt_setup_arch(&__dtb_start);\r\n}\r\nvoid __init device_tree_init(void)\r\n{\r\nif (!initial_boot_params)\r\nreturn;\r\nunflatten_and_copy_device_tree();\r\n}\r\nstatic int __init customize_machine(void)\r\n{\r\nof_platform_populate(NULL, of_default_bus_match_table, NULL, NULL);\r\nreturn 0;\r\n}

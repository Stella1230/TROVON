i40e_status i40e_add_sd_table_entry(struct i40e_hw *hw,\r\nstruct i40e_hmc_info *hmc_info,\r\nu32 sd_index,\r\nenum i40e_sd_entry_type type,\r\nu64 direct_mode_sz)\r\n{\r\nenum i40e_memory_type mem_type __attribute__((unused));\r\nstruct i40e_hmc_sd_entry *sd_entry;\r\nbool dma_mem_alloc_done = false;\r\nstruct i40e_dma_mem mem;\r\ni40e_status ret_code;\r\nu64 alloc_len;\r\nif (NULL == hmc_info->sd_table.sd_entry) {\r\nret_code = I40E_ERR_BAD_PTR;\r\nhw_dbg(hw, "i40e_add_sd_table_entry: bad sd_entry\n");\r\ngoto exit;\r\n}\r\nif (sd_index >= hmc_info->sd_table.sd_cnt) {\r\nret_code = I40E_ERR_INVALID_SD_INDEX;\r\nhw_dbg(hw, "i40e_add_sd_table_entry: bad sd_index\n");\r\ngoto exit;\r\n}\r\nsd_entry = &hmc_info->sd_table.sd_entry[sd_index];\r\nif (!sd_entry->valid) {\r\nif (I40E_SD_TYPE_PAGED == type) {\r\nmem_type = i40e_mem_pd;\r\nalloc_len = I40E_HMC_PAGED_BP_SIZE;\r\n} else {\r\nmem_type = i40e_mem_bp_jumbo;\r\nalloc_len = direct_mode_sz;\r\n}\r\nret_code = i40e_allocate_dma_mem(hw, &mem, mem_type, alloc_len,\r\nI40E_HMC_PD_BP_BUF_ALIGNMENT);\r\nif (ret_code)\r\ngoto exit;\r\ndma_mem_alloc_done = true;\r\nif (I40E_SD_TYPE_PAGED == type) {\r\nret_code = i40e_allocate_virt_mem(hw,\r\n&sd_entry->u.pd_table.pd_entry_virt_mem,\r\nsizeof(struct i40e_hmc_pd_entry) * 512);\r\nif (ret_code)\r\ngoto exit;\r\nsd_entry->u.pd_table.pd_entry =\r\n(struct i40e_hmc_pd_entry *)\r\nsd_entry->u.pd_table.pd_entry_virt_mem.va;\r\nsd_entry->u.pd_table.pd_page_addr = mem;\r\n} else {\r\nsd_entry->u.bp.addr = mem;\r\nsd_entry->u.bp.sd_pd_index = sd_index;\r\n}\r\nhmc_info->sd_table.sd_entry[sd_index].entry_type = type;\r\nI40E_INC_SD_REFCNT(&hmc_info->sd_table);\r\n}\r\nif (I40E_SD_TYPE_DIRECT == sd_entry->entry_type)\r\nI40E_INC_BP_REFCNT(&sd_entry->u.bp);\r\nexit:\r\nif (ret_code)\r\nif (dma_mem_alloc_done)\r\ni40e_free_dma_mem(hw, &mem);\r\nreturn ret_code;\r\n}\r\ni40e_status i40e_add_pd_table_entry(struct i40e_hw *hw,\r\nstruct i40e_hmc_info *hmc_info,\r\nu32 pd_index)\r\n{\r\ni40e_status ret_code = 0;\r\nstruct i40e_hmc_pd_table *pd_table;\r\nstruct i40e_hmc_pd_entry *pd_entry;\r\nstruct i40e_dma_mem mem;\r\nu32 sd_idx, rel_pd_idx;\r\nu64 *pd_addr;\r\nu64 page_desc;\r\nif (pd_index / I40E_HMC_PD_CNT_IN_SD >= hmc_info->sd_table.sd_cnt) {\r\nret_code = I40E_ERR_INVALID_PAGE_DESC_INDEX;\r\nhw_dbg(hw, "i40e_add_pd_table_entry: bad pd_index\n");\r\ngoto exit;\r\n}\r\nsd_idx = (pd_index / I40E_HMC_PD_CNT_IN_SD);\r\nif (I40E_SD_TYPE_PAGED !=\r\nhmc_info->sd_table.sd_entry[sd_idx].entry_type)\r\ngoto exit;\r\nrel_pd_idx = (pd_index % I40E_HMC_PD_CNT_IN_SD);\r\npd_table = &hmc_info->sd_table.sd_entry[sd_idx].u.pd_table;\r\npd_entry = &pd_table->pd_entry[rel_pd_idx];\r\nif (!pd_entry->valid) {\r\nret_code = i40e_allocate_dma_mem(hw, &mem, i40e_mem_bp,\r\nI40E_HMC_PAGED_BP_SIZE,\r\nI40E_HMC_PD_BP_BUF_ALIGNMENT);\r\nif (ret_code)\r\ngoto exit;\r\npd_entry->bp.addr = mem;\r\npd_entry->bp.sd_pd_index = pd_index;\r\npd_entry->bp.entry_type = I40E_SD_TYPE_PAGED;\r\npage_desc = mem.pa | 0x1;\r\npd_addr = (u64 *)pd_table->pd_page_addr.va;\r\npd_addr += rel_pd_idx;\r\nmemcpy(pd_addr, &page_desc, sizeof(u64));\r\npd_entry->sd_index = sd_idx;\r\npd_entry->valid = true;\r\nI40E_INC_PD_REFCNT(pd_table);\r\n}\r\nI40E_INC_BP_REFCNT(&pd_entry->bp);\r\nexit:\r\nreturn ret_code;\r\n}\r\ni40e_status i40e_remove_pd_bp(struct i40e_hw *hw,\r\nstruct i40e_hmc_info *hmc_info,\r\nu32 idx, bool is_pf)\r\n{\r\ni40e_status ret_code = 0;\r\nstruct i40e_hmc_pd_entry *pd_entry;\r\nstruct i40e_hmc_pd_table *pd_table;\r\nstruct i40e_hmc_sd_entry *sd_entry;\r\nu32 sd_idx, rel_pd_idx;\r\nu64 *pd_addr;\r\nsd_idx = idx / I40E_HMC_PD_CNT_IN_SD;\r\nrel_pd_idx = idx % I40E_HMC_PD_CNT_IN_SD;\r\nif (sd_idx >= hmc_info->sd_table.sd_cnt) {\r\nret_code = I40E_ERR_INVALID_PAGE_DESC_INDEX;\r\nhw_dbg(hw, "i40e_remove_pd_bp: bad idx\n");\r\ngoto exit;\r\n}\r\nsd_entry = &hmc_info->sd_table.sd_entry[sd_idx];\r\nif (I40E_SD_TYPE_PAGED != sd_entry->entry_type) {\r\nret_code = I40E_ERR_INVALID_SD_TYPE;\r\nhw_dbg(hw, "i40e_remove_pd_bp: wrong sd_entry type\n");\r\ngoto exit;\r\n}\r\npd_table = &hmc_info->sd_table.sd_entry[sd_idx].u.pd_table;\r\npd_entry = &pd_table->pd_entry[rel_pd_idx];\r\nI40E_DEC_BP_REFCNT(&pd_entry->bp);\r\nif (pd_entry->bp.ref_cnt)\r\ngoto exit;\r\npd_entry->valid = false;\r\nI40E_DEC_PD_REFCNT(pd_table);\r\npd_addr = (u64 *)pd_table->pd_page_addr.va;\r\npd_addr += rel_pd_idx;\r\nmemset(pd_addr, 0, sizeof(u64));\r\nif (is_pf)\r\nI40E_INVALIDATE_PF_HMC_PD(hw, sd_idx, idx);\r\nelse\r\nI40E_INVALIDATE_VF_HMC_PD(hw, sd_idx, idx, hmc_info->hmc_fn_id);\r\nret_code = i40e_free_dma_mem(hw, &(pd_entry->bp.addr));\r\nif (ret_code)\r\ngoto exit;\r\nif (!pd_table->ref_cnt)\r\ni40e_free_virt_mem(hw, &pd_table->pd_entry_virt_mem);\r\nexit:\r\nreturn ret_code;\r\n}\r\ni40e_status i40e_prep_remove_sd_bp(struct i40e_hmc_info *hmc_info,\r\nu32 idx)\r\n{\r\ni40e_status ret_code = 0;\r\nstruct i40e_hmc_sd_entry *sd_entry;\r\nsd_entry = &hmc_info->sd_table.sd_entry[idx];\r\nI40E_DEC_BP_REFCNT(&sd_entry->u.bp);\r\nif (sd_entry->u.bp.ref_cnt) {\r\nret_code = I40E_ERR_NOT_READY;\r\ngoto exit;\r\n}\r\nI40E_DEC_SD_REFCNT(&hmc_info->sd_table);\r\nsd_entry->valid = false;\r\nexit:\r\nreturn ret_code;\r\n}\r\ni40e_status i40e_remove_sd_bp_new(struct i40e_hw *hw,\r\nstruct i40e_hmc_info *hmc_info,\r\nu32 idx, bool is_pf)\r\n{\r\nstruct i40e_hmc_sd_entry *sd_entry;\r\ni40e_status ret_code = 0;\r\nsd_entry = &hmc_info->sd_table.sd_entry[idx];\r\nif (is_pf) {\r\nI40E_CLEAR_PF_SD_ENTRY(hw, idx, I40E_SD_TYPE_DIRECT);\r\n} else {\r\nret_code = I40E_NOT_SUPPORTED;\r\ngoto exit;\r\n}\r\nret_code = i40e_free_dma_mem(hw, &(sd_entry->u.bp.addr));\r\nif (ret_code)\r\ngoto exit;\r\nexit:\r\nreturn ret_code;\r\n}\r\ni40e_status i40e_prep_remove_pd_page(struct i40e_hmc_info *hmc_info,\r\nu32 idx)\r\n{\r\ni40e_status ret_code = 0;\r\nstruct i40e_hmc_sd_entry *sd_entry;\r\nsd_entry = &hmc_info->sd_table.sd_entry[idx];\r\nif (sd_entry->u.pd_table.ref_cnt) {\r\nret_code = I40E_ERR_NOT_READY;\r\ngoto exit;\r\n}\r\nsd_entry->valid = false;\r\nI40E_DEC_SD_REFCNT(&hmc_info->sd_table);\r\nexit:\r\nreturn ret_code;\r\n}\r\ni40e_status i40e_remove_pd_page_new(struct i40e_hw *hw,\r\nstruct i40e_hmc_info *hmc_info,\r\nu32 idx, bool is_pf)\r\n{\r\ni40e_status ret_code = 0;\r\nstruct i40e_hmc_sd_entry *sd_entry;\r\nsd_entry = &hmc_info->sd_table.sd_entry[idx];\r\nif (is_pf) {\r\nI40E_CLEAR_PF_SD_ENTRY(hw, idx, I40E_SD_TYPE_PAGED);\r\n} else {\r\nret_code = I40E_NOT_SUPPORTED;\r\ngoto exit;\r\n}\r\nret_code = i40e_free_dma_mem(hw, &(sd_entry->u.pd_table.pd_page_addr));\r\nif (ret_code)\r\ngoto exit;\r\nexit:\r\nreturn ret_code;\r\n}

static\r\nvoid\r\ns_vChangeAntenna(\r\nPSDevice pDevice\r\n)\r\n{\r\nif (pDevice->dwRxAntennaSel == 0) {\r\npDevice->dwRxAntennaSel = 1;\r\nif (pDevice->bTxRxAntInv == true)\r\nBBvSetRxAntennaMode(pDevice->PortOffset, ANT_A);\r\nelse\r\nBBvSetRxAntennaMode(pDevice->PortOffset, ANT_B);\r\n} else {\r\npDevice->dwRxAntennaSel = 0;\r\nif (pDevice->bTxRxAntInv == true)\r\nBBvSetRxAntennaMode(pDevice->PortOffset, ANT_B);\r\nelse\r\nBBvSetRxAntennaMode(pDevice->PortOffset, ANT_A);\r\n}\r\nif (pDevice->dwTxAntennaSel == 0) {\r\npDevice->dwTxAntennaSel = 1;\r\nBBvSetTxAntennaMode(pDevice->PortOffset, ANT_B);\r\n} else {\r\npDevice->dwTxAntennaSel = 0;\r\nBBvSetTxAntennaMode(pDevice->PortOffset, ANT_A);\r\n}\r\n}\r\nunsigned int\r\nBBuGetFrameTime(\r\nunsigned char byPreambleType,\r\nunsigned char byPktType,\r\nunsigned int cbFrameLength,\r\nunsigned short wRate\r\n)\r\n{\r\nunsigned int uFrameTime;\r\nunsigned int uPreamble;\r\nunsigned int uTmp;\r\nunsigned int uRateIdx = (unsigned int) wRate;\r\nunsigned int uRate = 0;\r\nif (uRateIdx > RATE_54M) {\r\nASSERT(0);\r\nreturn 0;\r\n}\r\nuRate = (unsigned int)awcFrameTime[uRateIdx];\r\nif (uRateIdx <= 3) {\r\nif (byPreambleType == 1) {\r\nuPreamble = 96;\r\n} else {\r\nuPreamble = 192;\r\n}\r\nuFrameTime = (cbFrameLength * 80) / uRate;\r\nuTmp = (uFrameTime * uRate) / 80;\r\nif (cbFrameLength != uTmp) {\r\nuFrameTime++;\r\n}\r\nreturn uPreamble + uFrameTime;\r\n} else {\r\nuFrameTime = (cbFrameLength * 8 + 22) / uRate;\r\nuTmp = ((uFrameTime * uRate) - 22) / 8;\r\nif (cbFrameLength != uTmp) {\r\nuFrameTime++;\r\n}\r\nuFrameTime = uFrameTime * 4;\r\nif (byPktType != PK_TYPE_11A) {\r\nuFrameTime += 6;\r\n}\r\nreturn 20 + uFrameTime;\r\n}\r\n}\r\nvoid\r\nBBvCalculateParameter(\r\nPSDevice pDevice,\r\nunsigned int cbFrameLength,\r\nunsigned short wRate,\r\nunsigned char byPacketType,\r\nunsigned short *pwPhyLen,\r\nunsigned char *pbyPhySrv,\r\nunsigned char *pbyPhySgn\r\n)\r\n{\r\nunsigned int cbBitCount;\r\nunsigned int cbUsCount = 0;\r\nunsigned int cbTmp;\r\nbool bExtBit;\r\nunsigned char byPreambleType = pDevice->byPreambleType;\r\nbool bCCK = pDevice->bCCK;\r\ncbBitCount = cbFrameLength * 8;\r\nbExtBit = false;\r\nswitch (wRate) {\r\ncase RATE_1M:\r\ncbUsCount = cbBitCount;\r\n*pbyPhySgn = 0x00;\r\nbreak;\r\ncase RATE_2M:\r\ncbUsCount = cbBitCount / 2;\r\nif (byPreambleType == 1)\r\n*pbyPhySgn = 0x09;\r\nelse\r\n*pbyPhySgn = 0x01;\r\nbreak;\r\ncase RATE_5M:\r\nif (!bCCK)\r\ncbBitCount++;\r\ncbUsCount = (cbBitCount * 10) / 55;\r\ncbTmp = (cbUsCount * 55) / 10;\r\nif (cbTmp != cbBitCount)\r\ncbUsCount++;\r\nif (byPreambleType == 1)\r\n*pbyPhySgn = 0x0a;\r\nelse\r\n*pbyPhySgn = 0x02;\r\nbreak;\r\ncase RATE_11M:\r\nif (!bCCK)\r\ncbBitCount++;\r\ncbUsCount = cbBitCount / 11;\r\ncbTmp = cbUsCount * 11;\r\nif (cbTmp != cbBitCount) {\r\ncbUsCount++;\r\nif ((cbBitCount - cbTmp) <= 3)\r\nbExtBit = true;\r\n}\r\nif (byPreambleType == 1)\r\n*pbyPhySgn = 0x0b;\r\nelse\r\n*pbyPhySgn = 0x03;\r\nbreak;\r\ncase RATE_6M:\r\nif (byPacketType == PK_TYPE_11A) {\r\n*pbyPhySgn = 0x9B;\r\n} else {\r\n*pbyPhySgn = 0x8B;\r\n}\r\nbreak;\r\ncase RATE_9M:\r\nif (byPacketType == PK_TYPE_11A) {\r\n*pbyPhySgn = 0x9F;\r\n} else {\r\n*pbyPhySgn = 0x8F;\r\n}\r\nbreak;\r\ncase RATE_12M:\r\nif (byPacketType == PK_TYPE_11A) {\r\n*pbyPhySgn = 0x9A;\r\n} else {\r\n*pbyPhySgn = 0x8A;\r\n}\r\nbreak;\r\ncase RATE_18M:\r\nif (byPacketType == PK_TYPE_11A) {\r\n*pbyPhySgn = 0x9E;\r\n} else {\r\n*pbyPhySgn = 0x8E;\r\n}\r\nbreak;\r\ncase RATE_24M:\r\nif (byPacketType == PK_TYPE_11A) {\r\n*pbyPhySgn = 0x99;\r\n} else {\r\n*pbyPhySgn = 0x89;\r\n}\r\nbreak;\r\ncase RATE_36M:\r\nif (byPacketType == PK_TYPE_11A) {\r\n*pbyPhySgn = 0x9D;\r\n} else {\r\n*pbyPhySgn = 0x8D;\r\n}\r\nbreak;\r\ncase RATE_48M:\r\nif (byPacketType == PK_TYPE_11A) {\r\n*pbyPhySgn = 0x98;\r\n} else {\r\n*pbyPhySgn = 0x88;\r\n}\r\nbreak;\r\ncase RATE_54M:\r\nif (byPacketType == PK_TYPE_11A) {\r\n*pbyPhySgn = 0x9C;\r\n} else {\r\n*pbyPhySgn = 0x8C;\r\n}\r\nbreak;\r\ndefault:\r\nif (byPacketType == PK_TYPE_11A) {\r\n*pbyPhySgn = 0x9C;\r\n} else {\r\n*pbyPhySgn = 0x8C;\r\n}\r\nbreak;\r\n}\r\nif (byPacketType == PK_TYPE_11B) {\r\n*pbyPhySrv = 0x00;\r\nif (bExtBit)\r\n*pbyPhySrv = *pbyPhySrv | 0x80;\r\n*pwPhyLen = (unsigned short)cbUsCount;\r\n} else {\r\n*pbyPhySrv = 0x00;\r\n*pwPhyLen = (unsigned short)cbFrameLength;\r\n}\r\n}\r\nbool BBbReadEmbedded(unsigned long dwIoBase, unsigned char byBBAddr, unsigned char *pbyData)\r\n{\r\nunsigned short ww;\r\nunsigned char byValue;\r\nVNSvOutPortB(dwIoBase + MAC_REG_BBREGADR, byBBAddr);\r\nMACvRegBitsOn(dwIoBase, MAC_REG_BBREGCTL, BBREGCTL_REGR);\r\nfor (ww = 0; ww < W_MAX_TIMEOUT; ww++) {\r\nVNSvInPortB(dwIoBase + MAC_REG_BBREGCTL, &byValue);\r\nif (byValue & BBREGCTL_DONE)\r\nbreak;\r\n}\r\nVNSvInPortB(dwIoBase + MAC_REG_BBREGDATA, pbyData);\r\nif (ww == W_MAX_TIMEOUT) {\r\nDBG_PORT80(0x30);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " DBG_PORT80(0x30)\n");\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nbool BBbWriteEmbedded(unsigned long dwIoBase, unsigned char byBBAddr, unsigned char byData)\r\n{\r\nunsigned short ww;\r\nunsigned char byValue;\r\nVNSvOutPortB(dwIoBase + MAC_REG_BBREGADR, byBBAddr);\r\nVNSvOutPortB(dwIoBase + MAC_REG_BBREGDATA, byData);\r\nMACvRegBitsOn(dwIoBase, MAC_REG_BBREGCTL, BBREGCTL_REGW);\r\nfor (ww = 0; ww < W_MAX_TIMEOUT; ww++) {\r\nVNSvInPortB(dwIoBase + MAC_REG_BBREGCTL, &byValue);\r\nif (byValue & BBREGCTL_DONE)\r\nbreak;\r\n}\r\nif (ww == W_MAX_TIMEOUT) {\r\nDBG_PORT80(0x31);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " DBG_PORT80(0x31)\n");\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nbool BBbIsRegBitsOn(unsigned long dwIoBase, unsigned char byBBAddr, unsigned char byTestBits)\r\n{\r\nunsigned char byOrgData;\r\nBBbReadEmbedded(dwIoBase, byBBAddr, &byOrgData);\r\nreturn (byOrgData & byTestBits) == byTestBits;\r\n}\r\nbool BBbIsRegBitsOff(unsigned long dwIoBase, unsigned char byBBAddr, unsigned char byTestBits)\r\n{\r\nunsigned char byOrgData;\r\nBBbReadEmbedded(dwIoBase, byBBAddr, &byOrgData);\r\nreturn (byOrgData & byTestBits) == 0;\r\n}\r\nbool BBbVT3253Init(PSDevice pDevice)\r\n{\r\nbool bResult = true;\r\nint ii;\r\nunsigned long dwIoBase = pDevice->PortOffset;\r\nunsigned char byRFType = pDevice->byRFType;\r\nunsigned char byLocalID = pDevice->byLocalID;\r\nif (byRFType == RF_RFMD2959) {\r\nif (byLocalID <= REV_ID_VT3253_A1) {\r\nfor (ii = 0; ii < CB_VT3253_INIT_FOR_RFMD; ii++) {\r\nbResult &= BBbWriteEmbedded(dwIoBase, byVT3253InitTab_RFMD[ii][0], byVT3253InitTab_RFMD[ii][1]);\r\n}\r\n} else {\r\nfor (ii = 0; ii < CB_VT3253B0_INIT_FOR_RFMD; ii++) {\r\nbResult &= BBbWriteEmbedded(dwIoBase, byVT3253B0_RFMD[ii][0], byVT3253B0_RFMD[ii][1]);\r\n}\r\nfor (ii = 0; ii < CB_VT3253B0_AGC_FOR_RFMD2959; ii++) {\r\nbResult &= BBbWriteEmbedded(dwIoBase, byVT3253B0_AGC4_RFMD2959[ii][0], byVT3253B0_AGC4_RFMD2959[ii][1]);\r\n}\r\nVNSvOutPortD(dwIoBase + MAC_REG_ITRTMSET, 0x23);\r\nMACvRegBitsOn(dwIoBase, MAC_REG_PAPEDELAY, BIT0);\r\n}\r\npDevice->abyBBVGA[0] = 0x18;\r\npDevice->abyBBVGA[1] = 0x0A;\r\npDevice->abyBBVGA[2] = 0x0;\r\npDevice->abyBBVGA[3] = 0x0;\r\npDevice->ldBmThreshold[0] = -70;\r\npDevice->ldBmThreshold[1] = -50;\r\npDevice->ldBmThreshold[2] = 0;\r\npDevice->ldBmThreshold[3] = 0;\r\n} else if ((byRFType == RF_AIROHA) || (byRFType == RF_AL2230S)) {\r\nfor (ii = 0; ii < CB_VT3253B0_INIT_FOR_AIROHA2230; ii++) {\r\nbResult &= BBbWriteEmbedded(dwIoBase, byVT3253B0_AIROHA2230[ii][0], byVT3253B0_AIROHA2230[ii][1]);\r\n}\r\nfor (ii = 0; ii < CB_VT3253B0_AGC; ii++) {\r\nbResult &= BBbWriteEmbedded(dwIoBase, byVT3253B0_AGC[ii][0], byVT3253B0_AGC[ii][1]);\r\n}\r\npDevice->abyBBVGA[0] = 0x1C;\r\npDevice->abyBBVGA[1] = 0x10;\r\npDevice->abyBBVGA[2] = 0x0;\r\npDevice->abyBBVGA[3] = 0x0;\r\npDevice->ldBmThreshold[0] = -70;\r\npDevice->ldBmThreshold[1] = -48;\r\npDevice->ldBmThreshold[2] = 0;\r\npDevice->ldBmThreshold[3] = 0;\r\n} else if (byRFType == RF_UW2451) {\r\nfor (ii = 0; ii < CB_VT3253B0_INIT_FOR_UW2451; ii++) {\r\nbResult &= BBbWriteEmbedded(dwIoBase, byVT3253B0_UW2451[ii][0], byVT3253B0_UW2451[ii][1]);\r\n}\r\nfor (ii = 0; ii < CB_VT3253B0_AGC; ii++) {\r\nbResult &= BBbWriteEmbedded(dwIoBase, byVT3253B0_AGC[ii][0], byVT3253B0_AGC[ii][1]);\r\n}\r\nVNSvOutPortB(dwIoBase + MAC_REG_ITRTMSET, 0x23);\r\nMACvRegBitsOn(dwIoBase, MAC_REG_PAPEDELAY, BIT0);\r\npDevice->abyBBVGA[0] = 0x14;\r\npDevice->abyBBVGA[1] = 0x0A;\r\npDevice->abyBBVGA[2] = 0x0;\r\npDevice->abyBBVGA[3] = 0x0;\r\npDevice->ldBmThreshold[0] = -60;\r\npDevice->ldBmThreshold[1] = -50;\r\npDevice->ldBmThreshold[2] = 0;\r\npDevice->ldBmThreshold[3] = 0;\r\n} else if (byRFType == RF_UW2452) {\r\nfor (ii = 0; ii < CB_VT3253B0_INIT_FOR_UW2451; ii++) {\r\nbResult &= BBbWriteEmbedded(dwIoBase, byVT3253B0_UW2451[ii][0], byVT3253B0_UW2451[ii][1]);\r\n}\r\nbResult &= BBbWriteEmbedded(dwIoBase, 0xd7, 0x06);\r\nbResult &= BBbWriteEmbedded(dwIoBase, 0x90, 0x20);\r\nbResult &= BBbWriteEmbedded(dwIoBase, 0x97, 0xeb);\r\nbResult &= BBbWriteEmbedded(dwIoBase, 0xa6, 0x00);\r\nbResult &= BBbWriteEmbedded(dwIoBase, 0xa8, 0x30);\r\nbResult &= BBbWriteEmbedded(dwIoBase, 0xb0, 0x58);\r\nfor (ii = 0; ii < CB_VT3253B0_AGC; ii++) {\r\nbResult &= BBbWriteEmbedded(dwIoBase, byVT3253B0_AGC[ii][0], byVT3253B0_AGC[ii][1]);\r\n}\r\npDevice->abyBBVGA[0] = 0x14;\r\npDevice->abyBBVGA[1] = 0x0A;\r\npDevice->abyBBVGA[2] = 0x0;\r\npDevice->abyBBVGA[3] = 0x0;\r\npDevice->ldBmThreshold[0] = -60;\r\npDevice->ldBmThreshold[1] = -50;\r\npDevice->ldBmThreshold[2] = 0;\r\npDevice->ldBmThreshold[3] = 0;\r\n} else if (byRFType == RF_VT3226) {\r\nfor (ii = 0; ii < CB_VT3253B0_INIT_FOR_AIROHA2230; ii++) {\r\nbResult &= BBbWriteEmbedded(dwIoBase, byVT3253B0_AIROHA2230[ii][0], byVT3253B0_AIROHA2230[ii][1]);\r\n}\r\nfor (ii = 0; ii < CB_VT3253B0_AGC; ii++) {\r\nbResult &= BBbWriteEmbedded(dwIoBase, byVT3253B0_AGC[ii][0], byVT3253B0_AGC[ii][1]);\r\n}\r\npDevice->abyBBVGA[0] = 0x1C;\r\npDevice->abyBBVGA[1] = 0x10;\r\npDevice->abyBBVGA[2] = 0x0;\r\npDevice->abyBBVGA[3] = 0x0;\r\npDevice->ldBmThreshold[0] = -70;\r\npDevice->ldBmThreshold[1] = -48;\r\npDevice->ldBmThreshold[2] = 0;\r\npDevice->ldBmThreshold[3] = 0;\r\nMACvSetRFLE_LatchBase(dwIoBase);\r\n} else if (byRFType == RF_AIROHA7230) {\r\nfor (ii = 0; ii < CB_VT3253B0_INIT_FOR_AIROHA2230; ii++) {\r\nbResult &= BBbWriteEmbedded(dwIoBase, byVT3253B0_AIROHA2230[ii][0], byVT3253B0_AIROHA2230[ii][1]);\r\n}\r\nbResult &= BBbWriteEmbedded(dwIoBase, 0xd7, 0x06);\r\nfor (ii = 0; ii < CB_VT3253B0_AGC; ii++) {\r\nbResult &= BBbWriteEmbedded(dwIoBase, byVT3253B0_AGC[ii][0], byVT3253B0_AGC[ii][1]);\r\n}\r\npDevice->abyBBVGA[0] = 0x1C;\r\npDevice->abyBBVGA[1] = 0x10;\r\npDevice->abyBBVGA[2] = 0x0;\r\npDevice->abyBBVGA[3] = 0x0;\r\npDevice->ldBmThreshold[0] = -70;\r\npDevice->ldBmThreshold[1] = -48;\r\npDevice->ldBmThreshold[2] = 0;\r\npDevice->ldBmThreshold[3] = 0;\r\n} else {\r\npDevice->bUpdateBBVGA = false;\r\npDevice->abyBBVGA[0] = 0x1C;\r\n}\r\nif (byLocalID > REV_ID_VT3253_A1) {\r\nBBbWriteEmbedded(dwIoBase, 0x04, 0x7F);\r\nBBbWriteEmbedded(dwIoBase, 0x0D, 0x01);\r\n}\r\nreturn bResult;\r\n}\r\nvoid BBvReadAllRegs(unsigned long dwIoBase, unsigned char *pbyBBRegs)\r\n{\r\nint ii;\r\nunsigned char byBase = 1;\r\nfor (ii = 0; ii < BB_MAX_CONTEXT_SIZE; ii++) {\r\nBBbReadEmbedded(dwIoBase, (unsigned char)(ii*byBase), pbyBBRegs);\r\npbyBBRegs += byBase;\r\n}\r\n}\r\nvoid BBvLoopbackOn(PSDevice pDevice)\r\n{\r\nunsigned char byData;\r\nunsigned long dwIoBase = pDevice->PortOffset;\r\nBBbReadEmbedded(dwIoBase, 0xC9, &pDevice->byBBCRc9);\r\nBBbWriteEmbedded(dwIoBase, 0xC9, 0);\r\nBBbReadEmbedded(dwIoBase, 0x4D, &pDevice->byBBCR4d);\r\nBBbWriteEmbedded(dwIoBase, 0x4D, 0x90);\r\nBBbReadEmbedded(dwIoBase, 0x88, &pDevice->byBBCR88);\r\nif (pDevice->uConnectionRate <= RATE_11M) {\r\nBBbReadEmbedded(dwIoBase, 0x21, &byData);\r\nBBbWriteEmbedded(dwIoBase, 0x21, (unsigned char)(byData | 0x01));\r\nBBbWriteEmbedded(dwIoBase, 0x9A, 0);\r\nBBbWriteEmbedded(dwIoBase, 0x88, 0x02);\r\n} else {\r\nBBbReadEmbedded(dwIoBase, 0x9A, &byData);\r\nBBbWriteEmbedded(dwIoBase, 0x9A, (unsigned char)(byData | 0x01));\r\nBBbWriteEmbedded(dwIoBase, 0x21, 0);\r\nBBbWriteEmbedded(dwIoBase, 0x88, 0x03);\r\n}\r\nBBbWriteEmbedded(dwIoBase, 0x0E, 0);\r\nBBbReadEmbedded(pDevice->PortOffset, 0x09, &pDevice->byBBCR09);\r\nBBbWriteEmbedded(pDevice->PortOffset, 0x09, (unsigned char)(pDevice->byBBCR09 & 0xDE));\r\n}\r\nvoid BBvLoopbackOff(PSDevice pDevice)\r\n{\r\nunsigned char byData;\r\nunsigned long dwIoBase = pDevice->PortOffset;\r\nBBbWriteEmbedded(dwIoBase, 0xC9, pDevice->byBBCRc9);\r\nBBbWriteEmbedded(dwIoBase, 0x88, pDevice->byBBCR88);\r\nBBbWriteEmbedded(dwIoBase, 0x09, pDevice->byBBCR09);\r\nBBbWriteEmbedded(dwIoBase, 0x4D, pDevice->byBBCR4d);\r\nif (pDevice->uConnectionRate <= RATE_11M) {\r\nBBbReadEmbedded(dwIoBase, 0x21, &byData);\r\nBBbWriteEmbedded(dwIoBase, 0x21, (unsigned char)(byData & 0xFE));\r\n} else {\r\nBBbReadEmbedded(dwIoBase, 0x9A, &byData);\r\nBBbWriteEmbedded(dwIoBase, 0x9A, (unsigned char)(byData & 0xFE));\r\n}\r\nBBbReadEmbedded(dwIoBase, 0x0E, &byData);\r\nBBbWriteEmbedded(dwIoBase, 0x0E, (unsigned char)(byData | 0x80));\r\n}\r\nvoid\r\nBBvSetShortSlotTime(PSDevice pDevice)\r\n{\r\nunsigned char byBBRxConf = 0;\r\nunsigned char byBBVGA = 0;\r\nBBbReadEmbedded(pDevice->PortOffset, 0x0A, &byBBRxConf);\r\nif (pDevice->bShortSlotTime) {\r\nbyBBRxConf &= 0xDF;\r\n} else {\r\nbyBBRxConf |= 0x20;\r\n}\r\nBBbReadEmbedded(pDevice->PortOffset, 0xE7, &byBBVGA);\r\nif (byBBVGA == pDevice->abyBBVGA[0]) {\r\nbyBBRxConf |= 0x20;\r\n}\r\nBBbWriteEmbedded(pDevice->PortOffset, 0x0A, byBBRxConf);\r\n}\r\nvoid BBvSetVGAGainOffset(PSDevice pDevice, unsigned char byData)\r\n{\r\nunsigned char byBBRxConf = 0;\r\nBBbWriteEmbedded(pDevice->PortOffset, 0xE7, byData);\r\nBBbReadEmbedded(pDevice->PortOffset, 0x0A, &byBBRxConf);\r\nif (byData == pDevice->abyBBVGA[0])\r\nbyBBRxConf |= 0x20;\r\nelse if (pDevice->bShortSlotTime)\r\nbyBBRxConf &= 0xDF;\r\nelse\r\nbyBBRxConf |= 0x20;\r\npDevice->byBBVGACurrent = byData;\r\nBBbWriteEmbedded(pDevice->PortOffset, 0x0A, byBBRxConf);\r\n}\r\nvoid\r\nBBvSoftwareReset(unsigned long dwIoBase)\r\n{\r\nBBbWriteEmbedded(dwIoBase, 0x50, 0x40);\r\nBBbWriteEmbedded(dwIoBase, 0x50, 0);\r\nBBbWriteEmbedded(dwIoBase, 0x9C, 0x01);\r\nBBbWriteEmbedded(dwIoBase, 0x9C, 0);\r\n}\r\nvoid\r\nBBvPowerSaveModeON(unsigned long dwIoBase)\r\n{\r\nunsigned char byOrgData;\r\nBBbReadEmbedded(dwIoBase, 0x0D, &byOrgData);\r\nbyOrgData |= BIT0;\r\nBBbWriteEmbedded(dwIoBase, 0x0D, byOrgData);\r\n}\r\nvoid\r\nBBvPowerSaveModeOFF(unsigned long dwIoBase)\r\n{\r\nunsigned char byOrgData;\r\nBBbReadEmbedded(dwIoBase, 0x0D, &byOrgData);\r\nbyOrgData &= ~(BIT0);\r\nBBbWriteEmbedded(dwIoBase, 0x0D, byOrgData);\r\n}\r\nvoid\r\nBBvSetTxAntennaMode(unsigned long dwIoBase, unsigned char byAntennaMode)\r\n{\r\nunsigned char byBBTxConf;\r\nBBbReadEmbedded(dwIoBase, 0x09, &byBBTxConf);\r\nif (byAntennaMode == ANT_DIVERSITY) {\r\nbyBBTxConf |= 0x02;\r\n} else if (byAntennaMode == ANT_A) {\r\nbyBBTxConf &= 0xF9;\r\n} else if (byAntennaMode == ANT_B) {\r\nbyBBTxConf &= 0xFD;\r\nbyBBTxConf |= 0x04;\r\n}\r\nBBbWriteEmbedded(dwIoBase, 0x09, byBBTxConf);\r\n}\r\nvoid\r\nBBvSetRxAntennaMode(unsigned long dwIoBase, unsigned char byAntennaMode)\r\n{\r\nunsigned char byBBRxConf;\r\nBBbReadEmbedded(dwIoBase, 0x0A, &byBBRxConf);\r\nif (byAntennaMode == ANT_DIVERSITY) {\r\nbyBBRxConf |= 0x01;\r\n} else if (byAntennaMode == ANT_A) {\r\nbyBBRxConf &= 0xFC;\r\n} else if (byAntennaMode == ANT_B) {\r\nbyBBRxConf &= 0xFE;\r\nbyBBRxConf |= 0x02;\r\n}\r\nBBbWriteEmbedded(dwIoBase, 0x0A, byBBRxConf);\r\n}\r\nvoid\r\nBBvSetDeepSleep(unsigned long dwIoBase, unsigned char byLocalID)\r\n{\r\nBBbWriteEmbedded(dwIoBase, 0x0C, 0x17);\r\nBBbWriteEmbedded(dwIoBase, 0x0D, 0xB9);\r\n}\r\nvoid\r\nBBvExitDeepSleep(unsigned long dwIoBase, unsigned char byLocalID)\r\n{\r\nBBbWriteEmbedded(dwIoBase, 0x0C, 0x00);\r\nBBbWriteEmbedded(dwIoBase, 0x0D, 0x01);\r\n}\r\nstatic\r\nunsigned long\r\ns_ulGetRatio(PSDevice pDevice)\r\n{\r\nunsigned long ulRatio = 0;\r\nunsigned long ulMaxPacket;\r\nunsigned long ulPacketNum;\r\nulMaxPacket = pDevice->uNumSQ3[RATE_54M];\r\nif (pDevice->uNumSQ3[RATE_54M] != 0) {\r\nulPacketNum = pDevice->uNumSQ3[RATE_54M];\r\nulRatio = (ulPacketNum * 1000 / pDevice->uDiversityCnt);\r\nulRatio += TOP_RATE_54M;\r\n}\r\nif (pDevice->uNumSQ3[RATE_48M] > ulMaxPacket) {\r\nulPacketNum = pDevice->uNumSQ3[RATE_54M] + pDevice->uNumSQ3[RATE_48M];\r\nulRatio = (ulPacketNum * 1000 / pDevice->uDiversityCnt);\r\nulRatio += TOP_RATE_48M;\r\nulMaxPacket = pDevice->uNumSQ3[RATE_48M];\r\n}\r\nif (pDevice->uNumSQ3[RATE_36M] > ulMaxPacket) {\r\nulPacketNum = pDevice->uNumSQ3[RATE_54M] + pDevice->uNumSQ3[RATE_48M] +\r\npDevice->uNumSQ3[RATE_36M];\r\nulRatio = (ulPacketNum * 1000 / pDevice->uDiversityCnt);\r\nulRatio += TOP_RATE_36M;\r\nulMaxPacket = pDevice->uNumSQ3[RATE_36M];\r\n}\r\nif (pDevice->uNumSQ3[RATE_24M] > ulMaxPacket) {\r\nulPacketNum = pDevice->uNumSQ3[RATE_54M] + pDevice->uNumSQ3[RATE_48M] +\r\npDevice->uNumSQ3[RATE_36M] + pDevice->uNumSQ3[RATE_24M];\r\nulRatio = (ulPacketNum * 1000 / pDevice->uDiversityCnt);\r\nulRatio += TOP_RATE_24M;\r\nulMaxPacket = pDevice->uNumSQ3[RATE_24M];\r\n}\r\nif (pDevice->uNumSQ3[RATE_18M] > ulMaxPacket) {\r\nulPacketNum = pDevice->uNumSQ3[RATE_54M] + pDevice->uNumSQ3[RATE_48M] +\r\npDevice->uNumSQ3[RATE_36M] + pDevice->uNumSQ3[RATE_24M] +\r\npDevice->uNumSQ3[RATE_18M];\r\nulRatio = (ulPacketNum * 1000 / pDevice->uDiversityCnt);\r\nulRatio += TOP_RATE_18M;\r\nulMaxPacket = pDevice->uNumSQ3[RATE_18M];\r\n}\r\nif (pDevice->uNumSQ3[RATE_12M] > ulMaxPacket) {\r\nulPacketNum = pDevice->uNumSQ3[RATE_54M] + pDevice->uNumSQ3[RATE_48M] +\r\npDevice->uNumSQ3[RATE_36M] + pDevice->uNumSQ3[RATE_24M] +\r\npDevice->uNumSQ3[RATE_18M] + pDevice->uNumSQ3[RATE_12M];\r\nulRatio = (ulPacketNum * 1000 / pDevice->uDiversityCnt);\r\nulRatio += TOP_RATE_12M;\r\nulMaxPacket = pDevice->uNumSQ3[RATE_12M];\r\n}\r\nif (pDevice->uNumSQ3[RATE_11M] > ulMaxPacket) {\r\nulPacketNum = pDevice->uDiversityCnt - pDevice->uNumSQ3[RATE_1M] -\r\npDevice->uNumSQ3[RATE_2M] - pDevice->uNumSQ3[RATE_5M] -\r\npDevice->uNumSQ3[RATE_6M] - pDevice->uNumSQ3[RATE_9M];\r\nulRatio = (ulPacketNum * 1000 / pDevice->uDiversityCnt);\r\nulRatio += TOP_RATE_11M;\r\nulMaxPacket = pDevice->uNumSQ3[RATE_11M];\r\n}\r\nif (pDevice->uNumSQ3[RATE_9M] > ulMaxPacket) {\r\nulPacketNum = pDevice->uDiversityCnt - pDevice->uNumSQ3[RATE_1M] -\r\npDevice->uNumSQ3[RATE_2M] - pDevice->uNumSQ3[RATE_5M] -\r\npDevice->uNumSQ3[RATE_6M];\r\nulRatio = (ulPacketNum * 1000 / pDevice->uDiversityCnt);\r\nulRatio += TOP_RATE_9M;\r\nulMaxPacket = pDevice->uNumSQ3[RATE_9M];\r\n}\r\nif (pDevice->uNumSQ3[RATE_6M] > ulMaxPacket) {\r\nulPacketNum = pDevice->uDiversityCnt - pDevice->uNumSQ3[RATE_1M] -\r\npDevice->uNumSQ3[RATE_2M] - pDevice->uNumSQ3[RATE_5M];\r\nulRatio = (ulPacketNum * 1000 / pDevice->uDiversityCnt);\r\nulRatio += TOP_RATE_6M;\r\nulMaxPacket = pDevice->uNumSQ3[RATE_6M];\r\n}\r\nif (pDevice->uNumSQ3[RATE_5M] > ulMaxPacket) {\r\nulPacketNum = pDevice->uDiversityCnt - pDevice->uNumSQ3[RATE_1M] -\r\npDevice->uNumSQ3[RATE_2M];\r\nulRatio = (ulPacketNum * 1000 / pDevice->uDiversityCnt);\r\nulRatio += TOP_RATE_55M;\r\nulMaxPacket = pDevice->uNumSQ3[RATE_5M];\r\n}\r\nif (pDevice->uNumSQ3[RATE_2M] > ulMaxPacket) {\r\nulPacketNum = pDevice->uDiversityCnt - pDevice->uNumSQ3[RATE_1M];\r\nulRatio = (ulPacketNum * 1000 / pDevice->uDiversityCnt);\r\nulRatio += TOP_RATE_2M;\r\nulMaxPacket = pDevice->uNumSQ3[RATE_2M];\r\n}\r\nif (pDevice->uNumSQ3[RATE_1M] > ulMaxPacket) {\r\nulPacketNum = pDevice->uDiversityCnt;\r\nulRatio = (ulPacketNum * 1000 / pDevice->uDiversityCnt);\r\nulRatio += TOP_RATE_1M;\r\n}\r\nreturn ulRatio;\r\n}\r\nvoid\r\nBBvClearAntDivSQ3Value(PSDevice pDevice)\r\n{\r\nunsigned int ii;\r\npDevice->uDiversityCnt = 0;\r\nfor (ii = 0; ii < MAX_RATE; ii++) {\r\npDevice->uNumSQ3[ii] = 0;\r\n}\r\n}\r\nvoid\r\nBBvAntennaDiversity(PSDevice pDevice, unsigned char byRxRate, unsigned char bySQ3)\r\n{\r\nif ((byRxRate >= MAX_RATE) || (pDevice->wAntDiversityMaxRate >= MAX_RATE)) {\r\nreturn;\r\n}\r\npDevice->uDiversityCnt++;\r\npDevice->uNumSQ3[byRxRate]++;\r\nif (pDevice->byAntennaState == 0) {\r\nif (pDevice->uDiversityCnt > pDevice->ulDiversityNValue) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "ulDiversityNValue=[%d],54M-[%d]\n",\r\n(int)pDevice->ulDiversityNValue, (int)pDevice->uNumSQ3[(int)pDevice->wAntDiversityMaxRate]);\r\nif (pDevice->uNumSQ3[pDevice->wAntDiversityMaxRate] < pDevice->uDiversityCnt/2) {\r\npDevice->ulRatio_State0 = s_ulGetRatio(pDevice);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "SQ3_State0, rate = [%08x]\n", (int)pDevice->ulRatio_State0);\r\nif (pDevice->byTMax == 0)\r\nreturn;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "1.[%08x], uNumSQ3[%d]=%d, %d\n",\r\n(int)pDevice->ulRatio_State0, (int)pDevice->wAntDiversityMaxRate,\r\n(int)pDevice->uNumSQ3[(int)pDevice->wAntDiversityMaxRate], (int)pDevice->uDiversityCnt);\r\ns_vChangeAntenna(pDevice);\r\npDevice->byAntennaState = 1;\r\ndel_timer(&pDevice->TimerSQ3Tmax3);\r\ndel_timer(&pDevice->TimerSQ3Tmax2);\r\npDevice->TimerSQ3Tmax1.expires = RUN_AT(pDevice->byTMax * HZ);\r\nadd_timer(&pDevice->TimerSQ3Tmax1);\r\n} else {\r\npDevice->TimerSQ3Tmax3.expires = RUN_AT(pDevice->byTMax3 * HZ);\r\nadd_timer(&pDevice->TimerSQ3Tmax3);\r\n}\r\nBBvClearAntDivSQ3Value(pDevice);\r\n}\r\n} else {\r\nif (pDevice->uDiversityCnt > pDevice->ulDiversityMValue) {\r\ndel_timer(&pDevice->TimerSQ3Tmax1);\r\npDevice->ulRatio_State1 = s_ulGetRatio(pDevice);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "RX:SQ3_State1, rate0 = %08x,rate1 = %08x\n",\r\n(int)pDevice->ulRatio_State0, (int)pDevice->ulRatio_State1);\r\nif (pDevice->ulRatio_State1 < pDevice->ulRatio_State0) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "2.[%08x][%08x], uNumSQ3[%d]=%d, %d\n",\r\n(int)pDevice->ulRatio_State0, (int)pDevice->ulRatio_State1,\r\n(int)pDevice->wAntDiversityMaxRate,\r\n(int)pDevice->uNumSQ3[(int)pDevice->wAntDiversityMaxRate], (int)pDevice->uDiversityCnt);\r\ns_vChangeAntenna(pDevice);\r\npDevice->TimerSQ3Tmax3.expires = RUN_AT(pDevice->byTMax3 * HZ);\r\npDevice->TimerSQ3Tmax2.expires = RUN_AT(pDevice->byTMax2 * HZ);\r\nadd_timer(&pDevice->TimerSQ3Tmax3);\r\nadd_timer(&pDevice->TimerSQ3Tmax2);\r\n}\r\npDevice->byAntennaState = 0;\r\nBBvClearAntDivSQ3Value(pDevice);\r\n}\r\n}\r\n}\r\nvoid\r\nTimerSQ3CallBack(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "TimerSQ3CallBack...");\r\nspin_lock_irq(&pDevice->lock);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "3.[%08x][%08x], %d\n", (int)pDevice->ulRatio_State0, (int)pDevice->ulRatio_State1, (int)pDevice->uDiversityCnt);\r\ns_vChangeAntenna(pDevice);\r\npDevice->byAntennaState = 0;\r\nBBvClearAntDivSQ3Value(pDevice);\r\npDevice->TimerSQ3Tmax3.expires = RUN_AT(pDevice->byTMax3 * HZ);\r\npDevice->TimerSQ3Tmax2.expires = RUN_AT(pDevice->byTMax2 * HZ);\r\nadd_timer(&pDevice->TimerSQ3Tmax3);\r\nadd_timer(&pDevice->TimerSQ3Tmax2);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn;\r\n}\r\nvoid\r\nTimerState1CallBack(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "TimerState1CallBack...");\r\nspin_lock_irq(&pDevice->lock);\r\nif (pDevice->uDiversityCnt < pDevice->ulDiversityMValue/100) {\r\ns_vChangeAntenna(pDevice);\r\npDevice->TimerSQ3Tmax3.expires = RUN_AT(pDevice->byTMax3 * HZ);\r\npDevice->TimerSQ3Tmax2.expires = RUN_AT(pDevice->byTMax2 * HZ);\r\nadd_timer(&pDevice->TimerSQ3Tmax3);\r\nadd_timer(&pDevice->TimerSQ3Tmax2);\r\n} else {\r\npDevice->ulRatio_State1 = s_ulGetRatio(pDevice);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "SQ3_State1, rate0 = %08x,rate1 = %08x\n",\r\n(int)pDevice->ulRatio_State0, (int)pDevice->ulRatio_State1);\r\nif (pDevice->ulRatio_State1 < pDevice->ulRatio_State0) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "2.[%08x][%08x], uNumSQ3[%d]=%d, %d\n",\r\n(int)pDevice->ulRatio_State0, (int)pDevice->ulRatio_State1,\r\n(int)pDevice->wAntDiversityMaxRate,\r\n(int)pDevice->uNumSQ3[(int)pDevice->wAntDiversityMaxRate], (int)pDevice->uDiversityCnt);\r\ns_vChangeAntenna(pDevice);\r\npDevice->TimerSQ3Tmax3.expires = RUN_AT(pDevice->byTMax3 * HZ);\r\npDevice->TimerSQ3Tmax2.expires = RUN_AT(pDevice->byTMax2 * HZ);\r\nadd_timer(&pDevice->TimerSQ3Tmax3);\r\nadd_timer(&pDevice->TimerSQ3Tmax2);\r\n}\r\n}\r\npDevice->byAntennaState = 0;\r\nBBvClearAntDivSQ3Value(pDevice);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn;\r\n}

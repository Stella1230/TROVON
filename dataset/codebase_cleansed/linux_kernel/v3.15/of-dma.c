static struct of_dma *of_dma_find_controller(struct of_phandle_args *dma_spec)\r\n{\r\nstruct of_dma *ofdma;\r\nlist_for_each_entry(ofdma, &of_dma_list, of_dma_controllers)\r\nif (ofdma->of_node == dma_spec->np)\r\nreturn ofdma;\r\npr_debug("%s: can't find DMA controller %s\n", __func__,\r\ndma_spec->np->full_name);\r\nreturn NULL;\r\n}\r\nvoid of_dma_controller_free(struct device_node *np)\r\n{\r\nstruct of_dma *ofdma;\r\nmutex_lock(&of_dma_lock);\r\nlist_for_each_entry(ofdma, &of_dma_list, of_dma_controllers)\r\nif (ofdma->of_node == np) {\r\nlist_del(&ofdma->of_dma_controllers);\r\nkfree(ofdma);\r\nbreak;\r\n}\r\nmutex_unlock(&of_dma_lock);\r\n}\r\nstatic int of_dma_match_channel(struct device_node *np, const char *name,\r\nint index, struct of_phandle_args *dma_spec)\r\n{\r\nconst char *s;\r\nif (of_property_read_string_index(np, "dma-names", index, &s))\r\nreturn -ENODEV;\r\nif (strcmp(name, s))\r\nreturn -ENODEV;\r\nif (of_parse_phandle_with_args(np, "dmas", "#dma-cells", index,\r\ndma_spec))\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstruct dma_chan *of_dma_request_slave_channel(struct device_node *np,\r\nconst char *name)\r\n{\r\nstruct of_phandle_args dma_spec;\r\nstruct of_dma *ofdma;\r\nstruct dma_chan *chan;\r\nint count, i;\r\nint ret_no_channel = -ENODEV;\r\nif (!np || !name) {\r\npr_err("%s: not enough information provided\n", __func__);\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\ncount = of_property_count_strings(np, "dma-names");\r\nif (count < 0) {\r\npr_err("%s: dma-names property of node '%s' missing or empty\n",\r\n__func__, np->full_name);\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\nfor (i = 0; i < count; i++) {\r\nif (of_dma_match_channel(np, name, i, &dma_spec))\r\ncontinue;\r\nmutex_lock(&of_dma_lock);\r\nofdma = of_dma_find_controller(&dma_spec);\r\nif (ofdma) {\r\nchan = ofdma->of_dma_xlate(&dma_spec, ofdma);\r\n} else {\r\nret_no_channel = -EPROBE_DEFER;\r\nchan = NULL;\r\n}\r\nmutex_unlock(&of_dma_lock);\r\nof_node_put(dma_spec.np);\r\nif (chan)\r\nreturn chan;\r\n}\r\nreturn ERR_PTR(ret_no_channel);\r\n}\r\nstruct dma_chan *of_dma_simple_xlate(struct of_phandle_args *dma_spec,\r\nstruct of_dma *ofdma)\r\n{\r\nint count = dma_spec->args_count;\r\nstruct of_dma_filter_info *info = ofdma->of_dma_data;\r\nif (!info || !info->filter_fn)\r\nreturn NULL;\r\nif (count != 1)\r\nreturn NULL;\r\nreturn dma_request_channel(info->dma_cap, info->filter_fn,\r\n&dma_spec->args[0]);\r\n}

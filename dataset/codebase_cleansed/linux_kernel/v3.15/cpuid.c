int get_cpu_info(unsigned int cpu, struct cpupower_cpu_info *cpu_info)\r\n{\r\nFILE *fp;\r\nchar value[64];\r\nunsigned int proc, x;\r\nunsigned int unknown = 0xffffff;\r\nunsigned int cpuid_level, ext_cpuid_level;\r\nint ret = -EINVAL;\r\ncpu_info->vendor = X86_VENDOR_UNKNOWN;\r\ncpu_info->family = unknown;\r\ncpu_info->model = unknown;\r\ncpu_info->stepping = unknown;\r\ncpu_info->caps = 0;\r\nfp = fopen("/proc/cpuinfo", "r");\r\nif (!fp)\r\nreturn -EIO;\r\nwhile (!feof(fp)) {\r\nif (!fgets(value, 64, fp))\r\ncontinue;\r\nvalue[63 - 1] = '\0';\r\nif (!strncmp(value, "processor\t: ", 12))\r\nsscanf(value, "processor\t: %u", &proc);\r\nif (proc != cpu)\r\ncontinue;\r\nif (!strncmp(value, "vendor_id", 9)) {\r\nfor (x = 1; x < X86_VENDOR_MAX; x++) {\r\nif (strstr(value, cpu_vendor_table[x]))\r\ncpu_info->vendor = x;\r\n}\r\n} else if (!strncmp(value, "cpu family\t: ", 13)) {\r\nsscanf(value, "cpu family\t: %u",\r\n&cpu_info->family);\r\n} else if (!strncmp(value, "model\t\t: ", 9)) {\r\nsscanf(value, "model\t\t: %u",\r\n&cpu_info->model);\r\n} else if (!strncmp(value, "stepping\t: ", 10)) {\r\nsscanf(value, "stepping\t: %u",\r\n&cpu_info->stepping);\r\nif (cpu_info->vendor == X86_VENDOR_UNKNOWN ||\r\ncpu_info->family == unknown ||\r\ncpu_info->model == unknown ||\r\ncpu_info->stepping == unknown) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nret = 0;\r\ngoto out;\r\n}\r\n}\r\nret = -ENODEV;\r\nout:\r\nfclose(fp);\r\nif (cpu_info->vendor != X86_VENDOR_AMD &&\r\ncpu_info->vendor != X86_VENDOR_INTEL)\r\nreturn ret;\r\ncpuid_level = cpuid_eax(0);\r\next_cpuid_level = cpuid_eax(0x80000000);\r\nif (ext_cpuid_level >= 0x80000007 &&\r\n(cpuid_edx(0x80000007) & (1 << 8)))\r\ncpu_info->caps |= CPUPOWER_CAP_INV_TSC;\r\nif (cpuid_level >= 6 && (cpuid_ecx(6) & 0x1))\r\ncpu_info->caps |= CPUPOWER_CAP_APERF;\r\nif (cpu_info->vendor == X86_VENDOR_AMD) {\r\nif (ext_cpuid_level >= 0x80000007 &&\r\n(cpuid_edx(0x80000007) & (1 << 9)))\r\ncpu_info->caps |= CPUPOWER_CAP_AMD_CBP;\r\n}\r\nif (cpu_info->vendor == X86_VENDOR_INTEL) {\r\nif (cpuid_level >= 6 &&\r\n(cpuid_eax(6) & (1 << 1)))\r\ncpu_info->caps |= CPUPOWER_CAP_INTEL_IDA;\r\n}\r\nif (cpu_info->vendor == X86_VENDOR_INTEL) {\r\nif (cpuid_level >= 6 && (cpuid_ecx(6) & (1 << 3)))\r\ncpu_info->caps |= CPUPOWER_CAP_PERF_BIAS;\r\nif (cpu_info->family == 6) {\r\nswitch (cpu_info->model) {\r\ncase 0x1A:\r\ncase 0x1E:\r\ncase 0x1F:\r\ncase 0x25:\r\ncase 0x2C:\r\ncpu_info->caps |= CPUPOWER_CAP_HAS_TURBO_RATIO;\r\ncase 0x2A:\r\ncase 0x2D:\r\ncase 0x3A:\r\ncase 0x3E:\r\ncpu_info->caps |= CPUPOWER_CAP_HAS_TURBO_RATIO;\r\ncpu_info->caps |= CPUPOWER_CAP_IS_SNB;\r\nbreak;\r\ncase 0x2E:\r\ncase 0x2F:\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn ret;\r\n}

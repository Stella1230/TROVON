static int qeth_card_hw_is_reachable(struct qeth_card *card)\r\n{\r\nreturn (card->state == CARD_STATE_SOFTSETUP) ||\r\n(card->state == CARD_STATE_UP);\r\n}\r\nstatic ssize_t qeth_bridge_port_role_state_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf,\r\nint show_state)\r\n{\r\nstruct qeth_card *card = dev_get_drvdata(dev);\r\nenum qeth_sbp_states state = QETH_SBP_STATE_INACTIVE;\r\nint rc = 0;\r\nchar *word;\r\nif (!card)\r\nreturn -EINVAL;\r\nmutex_lock(&card->conf_mutex);\r\nif (qeth_card_hw_is_reachable(card) &&\r\ncard->options.sbp.supported_funcs)\r\nrc = qeth_bridgeport_query_ports(card,\r\n&card->options.sbp.role, &state);\r\nif (!rc) {\r\nif (show_state)\r\nswitch (state) {\r\ncase QETH_SBP_STATE_INACTIVE:\r\nword = "inactive"; break;\r\ncase QETH_SBP_STATE_STANDBY:\r\nword = "standby"; break;\r\ncase QETH_SBP_STATE_ACTIVE:\r\nword = "active"; break;\r\ndefault:\r\nrc = -EIO;\r\n}\r\nelse\r\nswitch (card->options.sbp.role) {\r\ncase QETH_SBP_ROLE_NONE:\r\nword = "none"; break;\r\ncase QETH_SBP_ROLE_PRIMARY:\r\nword = "primary"; break;\r\ncase QETH_SBP_ROLE_SECONDARY:\r\nword = "secondary"; break;\r\ndefault:\r\nrc = -EIO;\r\n}\r\nif (rc)\r\nQETH_CARD_TEXT_(card, 2, "SBP%02x:%02x",\r\ncard->options.sbp.role, state);\r\nelse\r\nrc = sprintf(buf, "%s\n", word);\r\n}\r\nmutex_unlock(&card->conf_mutex);\r\nreturn rc;\r\n}\r\nstatic ssize_t qeth_bridge_port_role_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn qeth_bridge_port_role_state_show(dev, attr, buf, 0);\r\n}\r\nstatic ssize_t qeth_bridge_port_role_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct qeth_card *card = dev_get_drvdata(dev);\r\nint rc = 0;\r\nenum qeth_sbp_roles role;\r\nif (!card)\r\nreturn -EINVAL;\r\nif (sysfs_streq(buf, "primary"))\r\nrole = QETH_SBP_ROLE_PRIMARY;\r\nelse if (sysfs_streq(buf, "secondary"))\r\nrole = QETH_SBP_ROLE_SECONDARY;\r\nelse if (sysfs_streq(buf, "none"))\r\nrole = QETH_SBP_ROLE_NONE;\r\nelse\r\nreturn -EINVAL;\r\nmutex_lock(&card->conf_mutex);\r\nif (qeth_card_hw_is_reachable(card)) {\r\nrc = qeth_bridgeport_setrole(card, role);\r\nif (!rc)\r\ncard->options.sbp.role = role;\r\n} else\r\ncard->options.sbp.role = role;\r\nmutex_unlock(&card->conf_mutex);\r\nreturn rc ? rc : count;\r\n}\r\nstatic ssize_t qeth_bridge_port_state_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn qeth_bridge_port_role_state_show(dev, attr, buf, 1);\r\n}\r\nstatic ssize_t qeth_bridgeport_hostnotification_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct qeth_card *card = dev_get_drvdata(dev);\r\nint enabled;\r\nif (!card)\r\nreturn -EINVAL;\r\nmutex_lock(&card->conf_mutex);\r\nenabled = card->options.sbp.hostnotification;\r\nmutex_unlock(&card->conf_mutex);\r\nreturn sprintf(buf, "%d\n", enabled);\r\n}\r\nstatic ssize_t qeth_bridgeport_hostnotification_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct qeth_card *card = dev_get_drvdata(dev);\r\nint rc = 0;\r\nint enable;\r\nif (!card)\r\nreturn -EINVAL;\r\nif (sysfs_streq(buf, "0"))\r\nenable = 0;\r\nelse if (sysfs_streq(buf, "1"))\r\nenable = 1;\r\nelse\r\nreturn -EINVAL;\r\nmutex_lock(&card->conf_mutex);\r\nif (qeth_card_hw_is_reachable(card)) {\r\nrc = qeth_bridgeport_an_set(card, enable);\r\nif (!rc)\r\ncard->options.sbp.hostnotification = enable;\r\n} else\r\ncard->options.sbp.hostnotification = enable;\r\nmutex_unlock(&card->conf_mutex);\r\nreturn rc ? rc : count;\r\n}\r\nint qeth_l2_create_device_attributes(struct device *dev)\r\n{\r\nreturn sysfs_create_group(&dev->kobj, &qeth_l2_bridgeport_attr_group);\r\n}\r\nvoid qeth_l2_remove_device_attributes(struct device *dev)\r\n{\r\nsysfs_remove_group(&dev->kobj, &qeth_l2_bridgeport_attr_group);\r\n}\r\nvoid qeth_l2_setup_bridgeport_attrs(struct qeth_card *card)\r\n{\r\nint rc;\r\nif (!card)\r\nreturn;\r\nif (!card->options.sbp.supported_funcs)\r\nreturn;\r\nif (card->options.sbp.role != QETH_SBP_ROLE_NONE) {\r\nqeth_bridgeport_setrole(card, card->options.sbp.role);\r\nqeth_bridgeport_query_ports(card,\r\n&card->options.sbp.role, NULL);\r\n}\r\nif (card->options.sbp.hostnotification) {\r\nrc = qeth_bridgeport_an_set(card, 1);\r\nif (rc)\r\ncard->options.sbp.hostnotification = 0;\r\n} else\r\nqeth_bridgeport_an_set(card, 0);\r\n}

static struct ebt_ulog_net *ebt_ulog_pernet(struct net *net)\r\n{\r\nreturn net_generic(net, ebt_ulog_net_id);\r\n}\r\nstatic void ulog_send(struct ebt_ulog_net *ebt, unsigned int nlgroup)\r\n{\r\nebt_ulog_buff_t *ub = &ebt->ulog_buffers[nlgroup];\r\ndel_timer(&ub->timer);\r\nif (!ub->skb)\r\nreturn;\r\nif (ub->qlen > 1)\r\nub->lastnlh->nlmsg_type = NLMSG_DONE;\r\nNETLINK_CB(ub->skb).dst_group = nlgroup + 1;\r\nnetlink_broadcast(ebt->ebtulognl, ub->skb, 0, nlgroup + 1, GFP_ATOMIC);\r\nub->qlen = 0;\r\nub->skb = NULL;\r\n}\r\nstatic void ulog_timer(unsigned long data)\r\n{\r\nstruct ebt_ulog_net *ebt = container_of((void *)data,\r\nstruct ebt_ulog_net,\r\nnlgroup[*(unsigned int *)data]);\r\nebt_ulog_buff_t *ub = &ebt->ulog_buffers[*(unsigned int *)data];\r\nspin_lock_bh(&ub->lock);\r\nif (ub->skb)\r\nulog_send(ebt, *(unsigned int *)data);\r\nspin_unlock_bh(&ub->lock);\r\n}\r\nstatic struct sk_buff *ulog_alloc_skb(unsigned int size)\r\n{\r\nstruct sk_buff *skb;\r\nunsigned int n;\r\nn = max(size, nlbufsiz);\r\nskb = alloc_skb(n, GFP_ATOMIC | __GFP_NOWARN);\r\nif (!skb) {\r\nif (n > size) {\r\nskb = alloc_skb(size, GFP_ATOMIC);\r\nif (!skb)\r\npr_debug("cannot even allocate buffer of size %ub\n",\r\nsize);\r\n}\r\n}\r\nreturn skb;\r\n}\r\nstatic void ebt_ulog_packet(struct net *net, unsigned int hooknr,\r\nconst struct sk_buff *skb,\r\nconst struct net_device *in,\r\nconst struct net_device *out,\r\nconst struct ebt_ulog_info *uloginfo,\r\nconst char *prefix)\r\n{\r\nebt_ulog_packet_msg_t *pm;\r\nsize_t size, copy_len;\r\nstruct nlmsghdr *nlh;\r\nstruct ebt_ulog_net *ebt = ebt_ulog_pernet(net);\r\nunsigned int group = uloginfo->nlgroup;\r\nebt_ulog_buff_t *ub = &ebt->ulog_buffers[group];\r\nspinlock_t *lock = &ub->lock;\r\nktime_t kt;\r\nif ((uloginfo->cprange == 0) ||\r\n(uloginfo->cprange > skb->len + ETH_HLEN))\r\ncopy_len = skb->len + ETH_HLEN;\r\nelse\r\ncopy_len = uloginfo->cprange;\r\nsize = nlmsg_total_size(sizeof(*pm) + copy_len);\r\nif (size > nlbufsiz) {\r\npr_debug("Size %Zd needed, but nlbufsiz=%d\n", size, nlbufsiz);\r\nreturn;\r\n}\r\nspin_lock_bh(lock);\r\nif (!ub->skb) {\r\nif (!(ub->skb = ulog_alloc_skb(size)))\r\ngoto unlock;\r\n} else if (size > skb_tailroom(ub->skb)) {\r\nulog_send(ebt, group);\r\nif (!(ub->skb = ulog_alloc_skb(size)))\r\ngoto unlock;\r\n}\r\nnlh = nlmsg_put(ub->skb, 0, ub->qlen, 0,\r\nsize - NLMSG_ALIGN(sizeof(*nlh)), 0);\r\nif (!nlh) {\r\nkfree_skb(ub->skb);\r\nub->skb = NULL;\r\ngoto unlock;\r\n}\r\nub->qlen++;\r\npm = nlmsg_data(nlh);\r\nmemset(pm, 0, sizeof(*pm));\r\npm->version = EBT_ULOG_VERSION;\r\nkt = ktime_get_real();\r\npm->stamp = ktime_to_timeval(kt);\r\nif (ub->qlen == 1)\r\nub->skb->tstamp = kt;\r\npm->data_len = copy_len;\r\npm->mark = skb->mark;\r\npm->hook = hooknr;\r\nif (uloginfo->prefix != NULL)\r\nstrcpy(pm->prefix, uloginfo->prefix);\r\nif (in) {\r\nstrcpy(pm->physindev, in->name);\r\nif (br_port_exists(in))\r\nstrcpy(pm->indev, br_port_get_rcu(in)->br->dev->name);\r\nelse\r\nstrcpy(pm->indev, in->name);\r\n}\r\nif (out) {\r\nstrcpy(pm->physoutdev, out->name);\r\nstrcpy(pm->outdev, br_port_get_rcu(out)->br->dev->name);\r\n}\r\nif (skb_copy_bits(skb, -ETH_HLEN, pm->data, copy_len) < 0)\r\nBUG();\r\nif (ub->qlen > 1)\r\nub->lastnlh->nlmsg_flags |= NLM_F_MULTI;\r\nub->lastnlh = nlh;\r\nif (ub->qlen >= uloginfo->qthreshold)\r\nulog_send(ebt, group);\r\nelse if (!timer_pending(&ub->timer)) {\r\nub->timer.expires = jiffies + flushtimeout * HZ / 100;\r\nadd_timer(&ub->timer);\r\n}\r\nunlock:\r\nspin_unlock_bh(lock);\r\n}\r\nstatic void ebt_log_packet(struct net *net, u_int8_t pf, unsigned int hooknum,\r\nconst struct sk_buff *skb, const struct net_device *in,\r\nconst struct net_device *out, const struct nf_loginfo *li,\r\nconst char *prefix)\r\n{\r\nstruct ebt_ulog_info loginfo;\r\nif (!li || li->type != NF_LOG_TYPE_ULOG) {\r\nloginfo.nlgroup = EBT_ULOG_DEFAULT_NLGROUP;\r\nloginfo.cprange = 0;\r\nloginfo.qthreshold = EBT_ULOG_DEFAULT_QTHRESHOLD;\r\nloginfo.prefix[0] = '\0';\r\n} else {\r\nloginfo.nlgroup = li->u.ulog.group;\r\nloginfo.cprange = li->u.ulog.copy_len;\r\nloginfo.qthreshold = li->u.ulog.qthreshold;\r\nstrlcpy(loginfo.prefix, prefix, sizeof(loginfo.prefix));\r\n}\r\nebt_ulog_packet(net, hooknum, skb, in, out, &loginfo, prefix);\r\n}\r\nstatic unsigned int\r\nebt_ulog_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nstruct net *net = dev_net(par->in ? par->in : par->out);\r\nebt_ulog_packet(net, par->hooknum, skb, par->in, par->out,\r\npar->targinfo, NULL);\r\nreturn EBT_CONTINUE;\r\n}\r\nstatic int ebt_ulog_tg_check(const struct xt_tgchk_param *par)\r\n{\r\nstruct ebt_ulog_info *uloginfo = par->targinfo;\r\nif (!par->net->xt.ebt_ulog_warn_deprecated) {\r\npr_info("ebt_ulog is deprecated and it will be removed soon, "\r\n"use ebt_nflog instead\n");\r\npar->net->xt.ebt_ulog_warn_deprecated = true;\r\n}\r\nif (uloginfo->nlgroup > 31)\r\nreturn -EINVAL;\r\nuloginfo->prefix[EBT_ULOG_PREFIX_LEN - 1] = '\0';\r\nif (uloginfo->qthreshold > EBT_ULOG_MAX_QLEN)\r\nuloginfo->qthreshold = EBT_ULOG_MAX_QLEN;\r\nreturn 0;\r\n}\r\nstatic int __net_init ebt_ulog_net_init(struct net *net)\r\n{\r\nint i;\r\nstruct ebt_ulog_net *ebt = ebt_ulog_pernet(net);\r\nstruct netlink_kernel_cfg cfg = {\r\n.groups = EBT_ULOG_MAXNLGROUPS,\r\n};\r\nfor (i = 0; i < EBT_ULOG_MAXNLGROUPS; i++) {\r\nebt->nlgroup[i] = i;\r\nsetup_timer(&ebt->ulog_buffers[i].timer, ulog_timer,\r\n(unsigned long)&ebt->nlgroup[i]);\r\nspin_lock_init(&ebt->ulog_buffers[i].lock);\r\n}\r\nebt->ebtulognl = netlink_kernel_create(net, NETLINK_NFLOG, &cfg);\r\nif (!ebt->ebtulognl)\r\nreturn -ENOMEM;\r\nnf_log_set(net, NFPROTO_BRIDGE, &ebt_ulog_logger);\r\nreturn 0;\r\n}\r\nstatic void __net_exit ebt_ulog_net_fini(struct net *net)\r\n{\r\nint i;\r\nstruct ebt_ulog_net *ebt = ebt_ulog_pernet(net);\r\nnf_log_unset(net, &ebt_ulog_logger);\r\nfor (i = 0; i < EBT_ULOG_MAXNLGROUPS; i++) {\r\nebt_ulog_buff_t *ub = &ebt->ulog_buffers[i];\r\ndel_timer(&ub->timer);\r\nif (ub->skb) {\r\nkfree_skb(ub->skb);\r\nub->skb = NULL;\r\n}\r\n}\r\nnetlink_kernel_release(ebt->ebtulognl);\r\n}\r\nstatic int __init ebt_ulog_init(void)\r\n{\r\nint ret;\r\nif (nlbufsiz >= 128*1024) {\r\npr_warn("Netlink buffer has to be <= 128kB,"\r\n"please try a smaller nlbufsiz parameter.\n");\r\nreturn -EINVAL;\r\n}\r\nret = register_pernet_subsys(&ebt_ulog_net_ops);\r\nif (ret)\r\ngoto out_pernet;\r\nret = xt_register_target(&ebt_ulog_tg_reg);\r\nif (ret)\r\ngoto out_target;\r\nnf_log_register(NFPROTO_BRIDGE, &ebt_ulog_logger);\r\nreturn 0;\r\nout_target:\r\nunregister_pernet_subsys(&ebt_ulog_net_ops);\r\nout_pernet:\r\nreturn ret;\r\n}\r\nstatic void __exit ebt_ulog_fini(void)\r\n{\r\nnf_log_unregister(&ebt_ulog_logger);\r\nxt_unregister_target(&ebt_ulog_tg_reg);\r\nunregister_pernet_subsys(&ebt_ulog_net_ops);\r\n}

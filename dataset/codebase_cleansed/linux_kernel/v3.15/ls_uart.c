static void wd_stop(struct work_struct *unused)\r\n{\r\nconst char string[] = "AAAAFFFFJJJJ>>>>VVVV>>>>ZZZZVVVVKKKK";\r\nint i = 0, rescue = 8;\r\nint len = strlen(string);\r\nwhile (rescue--) {\r\nint j;\r\nchar lsr = in_8(avr_addr + UART_LSR);\r\nif (lsr & (UART_LSR_THRE | UART_LSR_TEMT)) {\r\nfor (j = 0; j < 16 && i < len; j++, i++)\r\nout_8(avr_addr + UART_TX, string[i]);\r\nif (i == len) {\r\nmsleep(7);\r\nprintk("linkstation: disarming the AVR watchdog: ");\r\nwhile (in_8(avr_addr + UART_LSR) & UART_LSR_DR)\r\nprintk("%c", in_8(avr_addr + UART_RX));\r\nbreak;\r\n}\r\n}\r\nmsleep(17);\r\n}\r\nprintk("\n");\r\n}\r\nvoid avr_uart_configure(void)\r\n{\r\nunsigned char cval = UART_LCR_WLEN8;\r\nunsigned int quot = AVR_QUOT(avr_clock);\r\nif (!avr_addr || !avr_clock)\r\nreturn;\r\nout_8(avr_addr + UART_LCR, cval);\r\nout_8(avr_addr + UART_MCR, 0);\r\nout_8(avr_addr + UART_IER, 0);\r\ncval |= UART_LCR_STOP | UART_LCR_PARITY | UART_LCR_EPAR;\r\nout_8(avr_addr + UART_LCR, cval);\r\nout_8(avr_addr + UART_LCR, cval | UART_LCR_DLAB);\r\nout_8(avr_addr + UART_DLL, quot & 0xff);\r\nout_8(avr_addr + UART_DLM, quot >> 8);\r\nout_8(avr_addr + UART_LCR, cval);\r\nout_8(avr_addr + UART_FCR, UART_FCR_ENABLE_FIFO);\r\n}\r\nvoid avr_uart_send(const char c)\r\n{\r\nif (!avr_addr || !avr_clock)\r\nreturn;\r\nout_8(avr_addr + UART_TX, c);\r\nout_8(avr_addr + UART_TX, c);\r\nout_8(avr_addr + UART_TX, c);\r\nout_8(avr_addr + UART_TX, c);\r\n}\r\nstatic void __init ls_uart_init(void)\r\n{\r\nlocal_irq_disable();\r\n#ifndef CONFIG_SERIAL_8250\r\nout_8(avr_addr + UART_FCR, UART_FCR_ENABLE_FIFO);\r\nout_8(avr_addr + UART_FCR, UART_FCR_ENABLE_FIFO |\r\nUART_FCR_CLEAR_RCVR | UART_FCR_CLEAR_XMIT);\r\nout_8(avr_addr + UART_FCR, 0);\r\nout_8(avr_addr + UART_IER, 0);\r\n(void) in_8(avr_addr + UART_LSR);\r\n(void) in_8(avr_addr + UART_RX);\r\n(void) in_8(avr_addr + UART_IIR);\r\n(void) in_8(avr_addr + UART_MSR);\r\n#endif\r\navr_uart_configure();\r\nlocal_irq_enable();\r\n}\r\nstatic int __init ls_uarts_init(void)\r\n{\r\nstruct device_node *avr;\r\nphys_addr_t phys_addr;\r\nint len;\r\navr = of_find_node_by_path("/soc10x/serial@80004500");\r\nif (!avr)\r\nreturn -EINVAL;\r\navr_clock = *(u32*)of_get_property(avr, "clock-frequency", &len);\r\nphys_addr = ((u32*)of_get_property(avr, "reg", &len))[0];\r\nif (!avr_clock || !phys_addr)\r\nreturn -EINVAL;\r\navr_addr = ioremap(phys_addr, 32);\r\nif (!avr_addr)\r\nreturn -EFAULT;\r\nls_uart_init();\r\nINIT_WORK(&wd_work, wd_stop);\r\nschedule_work(&wd_work);\r\nreturn 0;\r\n}

static ssize_t arcmsr_sysfs_iop_message_read(struct file *filp,\r\nstruct kobject *kobj,\r\nstruct bin_attribute *bin,\r\nchar *buf, loff_t off,\r\nsize_t count)\r\n{\r\nstruct device *dev = container_of(kobj,struct device,kobj);\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb = (struct AdapterControlBlock *) host->hostdata;\r\nuint8_t *pQbuffer,*ptmpQbuffer;\r\nint32_t allxfer_len = 0;\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EACCES;\r\nptmpQbuffer = (uint8_t *)buf;\r\nwhile ((acb->rqbuf_firstindex != acb->rqbuf_lastindex)\r\n&& (allxfer_len < 1031)) {\r\npQbuffer = &acb->rqbuffer[acb->rqbuf_firstindex];\r\nmemcpy(ptmpQbuffer, pQbuffer, 1);\r\nacb->rqbuf_firstindex++;\r\nacb->rqbuf_firstindex %= ARCMSR_MAX_QBUFFER;\r\nptmpQbuffer++;\r\nallxfer_len++;\r\n}\r\nif (acb->acb_flags & ACB_F_IOPDATA_OVERFLOW) {\r\nstruct QBUFFER __iomem *prbuffer;\r\nuint8_t __iomem *iop_data;\r\nint32_t iop_len;\r\nacb->acb_flags &= ~ACB_F_IOPDATA_OVERFLOW;\r\nprbuffer = arcmsr_get_iop_rqbuffer(acb);\r\niop_data = prbuffer->data;\r\niop_len = readl(&prbuffer->data_len);\r\nwhile (iop_len > 0) {\r\nacb->rqbuffer[acb->rqbuf_lastindex] = readb(iop_data);\r\nacb->rqbuf_lastindex++;\r\nacb->rqbuf_lastindex %= ARCMSR_MAX_QBUFFER;\r\niop_data++;\r\niop_len--;\r\n}\r\narcmsr_iop_message_read(acb);\r\n}\r\nreturn (allxfer_len);\r\n}\r\nstatic ssize_t arcmsr_sysfs_iop_message_write(struct file *filp,\r\nstruct kobject *kobj,\r\nstruct bin_attribute *bin,\r\nchar *buf, loff_t off,\r\nsize_t count)\r\n{\r\nstruct device *dev = container_of(kobj,struct device,kobj);\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb = (struct AdapterControlBlock *) host->hostdata;\r\nint32_t my_empty_len, user_len, wqbuf_firstindex, wqbuf_lastindex;\r\nuint8_t *pQbuffer, *ptmpuserbuffer;\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EACCES;\r\nif (count > 1032)\r\nreturn -EINVAL;\r\nptmpuserbuffer = (uint8_t *)buf;\r\nuser_len = (int32_t)count;\r\nwqbuf_lastindex = acb->wqbuf_lastindex;\r\nwqbuf_firstindex = acb->wqbuf_firstindex;\r\nif (wqbuf_lastindex != wqbuf_firstindex) {\r\narcmsr_post_ioctldata2iop(acb);\r\nreturn 0;\r\n} else {\r\nmy_empty_len = (wqbuf_firstindex-wqbuf_lastindex - 1)\r\n&(ARCMSR_MAX_QBUFFER - 1);\r\nif (my_empty_len >= user_len) {\r\nwhile (user_len > 0) {\r\npQbuffer =\r\n&acb->wqbuffer[acb->wqbuf_lastindex];\r\nmemcpy(pQbuffer, ptmpuserbuffer, 1);\r\nacb->wqbuf_lastindex++;\r\nacb->wqbuf_lastindex %= ARCMSR_MAX_QBUFFER;\r\nptmpuserbuffer++;\r\nuser_len--;\r\n}\r\nif (acb->acb_flags & ACB_F_MESSAGE_WQBUFFER_CLEARED) {\r\nacb->acb_flags &=\r\n~ACB_F_MESSAGE_WQBUFFER_CLEARED;\r\narcmsr_post_ioctldata2iop(acb);\r\n}\r\nreturn count;\r\n} else {\r\nreturn 0;\r\n}\r\n}\r\n}\r\nstatic ssize_t arcmsr_sysfs_iop_message_clear(struct file *filp,\r\nstruct kobject *kobj,\r\nstruct bin_attribute *bin,\r\nchar *buf, loff_t off,\r\nsize_t count)\r\n{\r\nstruct device *dev = container_of(kobj,struct device,kobj);\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb = (struct AdapterControlBlock *) host->hostdata;\r\nuint8_t *pQbuffer;\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EACCES;\r\nif (acb->acb_flags & ACB_F_IOPDATA_OVERFLOW) {\r\nacb->acb_flags &= ~ACB_F_IOPDATA_OVERFLOW;\r\narcmsr_iop_message_read(acb);\r\n}\r\nacb->acb_flags |=\r\n(ACB_F_MESSAGE_WQBUFFER_CLEARED\r\n| ACB_F_MESSAGE_RQBUFFER_CLEARED\r\n| ACB_F_MESSAGE_WQBUFFER_READED);\r\nacb->rqbuf_firstindex = 0;\r\nacb->rqbuf_lastindex = 0;\r\nacb->wqbuf_firstindex = 0;\r\nacb->wqbuf_lastindex = 0;\r\npQbuffer = acb->rqbuffer;\r\nmemset(pQbuffer, 0, sizeof (struct QBUFFER));\r\npQbuffer = acb->wqbuffer;\r\nmemset(pQbuffer, 0, sizeof (struct QBUFFER));\r\nreturn 1;\r\n}\r\nint arcmsr_alloc_sysfs_attr(struct AdapterControlBlock *acb)\r\n{\r\nstruct Scsi_Host *host = acb->host;\r\nint error;\r\nerror = sysfs_create_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_read_attr);\r\nif (error) {\r\nprintk(KERN_ERR "arcmsr: alloc sysfs mu_read failed\n");\r\ngoto error_bin_file_message_read;\r\n}\r\nerror = sysfs_create_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_write_attr);\r\nif (error) {\r\nprintk(KERN_ERR "arcmsr: alloc sysfs mu_write failed\n");\r\ngoto error_bin_file_message_write;\r\n}\r\nerror = sysfs_create_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_clear_attr);\r\nif (error) {\r\nprintk(KERN_ERR "arcmsr: alloc sysfs mu_clear failed\n");\r\ngoto error_bin_file_message_clear;\r\n}\r\nreturn 0;\r\nerror_bin_file_message_clear:\r\nsysfs_remove_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_write_attr);\r\nerror_bin_file_message_write:\r\nsysfs_remove_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_read_attr);\r\nerror_bin_file_message_read:\r\nreturn error;\r\n}\r\nvoid arcmsr_free_sysfs_attr(struct AdapterControlBlock *acb)\r\n{\r\nstruct Scsi_Host *host = acb->host;\r\nsysfs_remove_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_clear_attr);\r\nsysfs_remove_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_write_attr);\r\nsysfs_remove_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_read_attr);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_driver_version(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%s\n",\r\nARCMSR_DRIVER_VERSION);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_driver_posted_cmd(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%4d\n",\r\natomic_read(&acb->ccboutstandingcount));\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_driver_reset(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%4d\n",\r\nacb->num_resets);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_driver_abort(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%4d\n",\r\nacb->num_aborts);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_fw_model(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%s\n",\r\nacb->firm_model);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_fw_version(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%s\n",\r\nacb->firm_version);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_fw_request_len(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%4d\n",\r\nacb->firm_request_len);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_fw_numbers_queue(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%4d\n",\r\nacb->firm_numbers_queue);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_fw_sdram_size(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%4d\n",\r\nacb->firm_sdram_size);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_fw_hd_channels(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%4d\n",\r\nacb->firm_hd_channels);\r\n}

static void setup_retime_src(struct sti_dwmac *dwmac, u32 spd)\r\n{\r\nu32 src = 0, freq = 0;\r\nif (spd == SPEED_100) {\r\nif (dwmac->interface == PHY_INTERFACE_MODE_MII ||\r\ndwmac->interface == PHY_INTERFACE_MODE_GMII) {\r\nsrc = TX_RETIME_SRC_TXCLK;\r\n} else if (dwmac->interface == PHY_INTERFACE_MODE_RMII) {\r\nif (dwmac->ext_phyclk) {\r\nsrc = TX_RETIME_SRC_PHYCLK;\r\n} else {\r\nsrc = TX_RETIME_SRC_CLKGEN;\r\nfreq = 50000000;\r\n}\r\n} else if (IS_PHY_IF_MODE_RGMII(dwmac->interface)) {\r\nsrc = TX_RETIME_SRC_CLKGEN;\r\nfreq = 25000000;\r\n}\r\nif (src == TX_RETIME_SRC_CLKGEN && dwmac->clk)\r\nclk_set_rate(dwmac->clk, freq);\r\n} else if (spd == SPEED_1000) {\r\nif (dwmac->is_tx_retime_src_clk_125)\r\nsrc = TX_RETIME_SRC_CLK_125;\r\nelse\r\nsrc = TX_RETIME_SRC_TXCLK;\r\n}\r\nregmap_update_bits(dwmac->regmap, dwmac->reg,\r\nTX_RETIME_SRC_MASK, tx_retime_val[src]);\r\n}\r\nstatic void sti_dwmac_exit(struct platform_device *pdev, void *priv)\r\n{\r\nstruct sti_dwmac *dwmac = priv;\r\nif (dwmac->clk)\r\nclk_disable_unprepare(dwmac->clk);\r\n}\r\nstatic void sti_fix_mac_speed(void *priv, unsigned int spd)\r\n{\r\nstruct sti_dwmac *dwmac = priv;\r\nsetup_retime_src(dwmac, spd);\r\nreturn;\r\n}\r\nstatic int sti_dwmac_parse_data(struct sti_dwmac *dwmac,\r\nstruct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct regmap *regmap;\r\nint err;\r\nif (!np)\r\nreturn -EINVAL;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "sti-ethconf");\r\nif (!res)\r\nreturn -ENODATA;\r\nregmap = syscon_regmap_lookup_by_phandle(np, "st,syscon");\r\nif (IS_ERR(regmap))\r\nreturn PTR_ERR(regmap);\r\ndwmac->dev = dev;\r\ndwmac->interface = of_get_phy_mode(np);\r\ndwmac->regmap = regmap;\r\ndwmac->reg = res->start;\r\ndwmac->ext_phyclk = of_property_read_bool(np, "st,ext-phyclk");\r\ndwmac->is_tx_retime_src_clk_125 = false;\r\nif (IS_PHY_IF_MODE_GBIT(dwmac->interface)) {\r\nconst char *rs;\r\nerr = of_property_read_string(np, "st,tx-retime-src", &rs);\r\nif (err < 0) {\r\ndev_err(dev, "st,tx-retime-src not specified\n");\r\nreturn err;\r\n}\r\nif (!strcasecmp(rs, "clk_125"))\r\ndwmac->is_tx_retime_src_clk_125 = true;\r\n}\r\ndwmac->clk = devm_clk_get(dev, "sti-ethclk");\r\nif (IS_ERR(dwmac->clk))\r\ndwmac->clk = NULL;\r\nreturn 0;\r\n}\r\nstatic int sti_dwmac_init(struct platform_device *pdev, void *priv)\r\n{\r\nstruct sti_dwmac *dwmac = priv;\r\nstruct regmap *regmap = dwmac->regmap;\r\nint iface = dwmac->interface;\r\nu32 reg = dwmac->reg;\r\nu32 val, spd;\r\nif (dwmac->clk)\r\nclk_prepare_enable(dwmac->clk);\r\nregmap_update_bits(regmap, reg, MII_PHY_SEL_MASK, phy_intf_sels[iface]);\r\nval = (iface == PHY_INTERFACE_MODE_REVMII) ? 0 : ENMII;\r\nregmap_update_bits(regmap, reg, ENMII_MASK, val);\r\nif (IS_PHY_IF_MODE_GBIT(iface))\r\nspd = SPEED_1000;\r\nelse\r\nspd = SPEED_100;\r\nsetup_retime_src(dwmac, spd);\r\nreturn 0;\r\n}\r\nstatic void *sti_dwmac_setup(struct platform_device *pdev)\r\n{\r\nstruct sti_dwmac *dwmac;\r\nint ret;\r\ndwmac = devm_kzalloc(&pdev->dev, sizeof(*dwmac), GFP_KERNEL);\r\nif (!dwmac)\r\nreturn ERR_PTR(-ENOMEM);\r\nret = sti_dwmac_parse_data(dwmac, pdev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Unable to parse OF data\n");\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn dwmac;\r\n}

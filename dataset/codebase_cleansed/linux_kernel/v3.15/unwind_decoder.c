static unw_word\r\nunw_decode_uleb128 (unsigned char **dpp)\r\n{\r\nunsigned shift = 0;\r\nunw_word byte, result = 0;\r\nunsigned char *bp = *dpp;\r\nwhile (1)\r\n{\r\nbyte = *bp++;\r\nresult |= (byte & 0x7f) << shift;\r\nif ((byte & 0x80) == 0)\r\nbreak;\r\nshift += 7;\r\n}\r\n*dpp = bp;\r\nreturn result;\r\n}\r\nstatic unsigned char *\r\nunw_decode_x1 (unsigned char *dp, unsigned char code, void *arg)\r\n{\r\nunsigned char byte1, abreg;\r\nunw_word t, off;\r\nbyte1 = *dp++;\r\nt = unw_decode_uleb128 (&dp);\r\noff = unw_decode_uleb128 (&dp);\r\nabreg = (byte1 & 0x7f);\r\nif (byte1 & 0x80)\r\nUNW_DEC_SPILL_SPREL(X1, t, abreg, off, arg);\r\nelse\r\nUNW_DEC_SPILL_PSPREL(X1, t, abreg, off, arg);\r\nreturn dp;\r\n}\r\nstatic unsigned char *\r\nunw_decode_x2 (unsigned char *dp, unsigned char code, void *arg)\r\n{\r\nunsigned char byte1, byte2, abreg, x, ytreg;\r\nunw_word t;\r\nbyte1 = *dp++; byte2 = *dp++;\r\nt = unw_decode_uleb128 (&dp);\r\nabreg = (byte1 & 0x7f);\r\nytreg = byte2;\r\nx = (byte1 >> 7) & 1;\r\nif ((byte1 & 0x80) == 0 && ytreg == 0)\r\nUNW_DEC_RESTORE(X2, t, abreg, arg);\r\nelse\r\nUNW_DEC_SPILL_REG(X2, t, abreg, x, ytreg, arg);\r\nreturn dp;\r\n}\r\nstatic unsigned char *\r\nunw_decode_x3 (unsigned char *dp, unsigned char code, void *arg)\r\n{\r\nunsigned char byte1, byte2, abreg, qp;\r\nunw_word t, off;\r\nbyte1 = *dp++; byte2 = *dp++;\r\nt = unw_decode_uleb128 (&dp);\r\noff = unw_decode_uleb128 (&dp);\r\nqp = (byte1 & 0x3f);\r\nabreg = (byte2 & 0x7f);\r\nif (byte1 & 0x80)\r\nUNW_DEC_SPILL_SPREL_P(X3, qp, t, abreg, off, arg);\r\nelse\r\nUNW_DEC_SPILL_PSPREL_P(X3, qp, t, abreg, off, arg);\r\nreturn dp;\r\n}\r\nstatic unsigned char *\r\nunw_decode_x4 (unsigned char *dp, unsigned char code, void *arg)\r\n{\r\nunsigned char byte1, byte2, byte3, qp, abreg, x, ytreg;\r\nunw_word t;\r\nbyte1 = *dp++; byte2 = *dp++; byte3 = *dp++;\r\nt = unw_decode_uleb128 (&dp);\r\nqp = (byte1 & 0x3f);\r\nabreg = (byte2 & 0x7f);\r\nx = (byte2 >> 7) & 1;\r\nytreg = byte3;\r\nif ((byte2 & 0x80) == 0 && byte3 == 0)\r\nUNW_DEC_RESTORE_P(X4, qp, t, abreg, arg);\r\nelse\r\nUNW_DEC_SPILL_REG_P(X4, qp, t, abreg, x, ytreg, arg);\r\nreturn dp;\r\n}\r\nstatic unsigned char *\r\nunw_decode_r1 (unsigned char *dp, unsigned char code, void *arg)\r\n{\r\nint body = (code & 0x20) != 0;\r\nunw_word rlen;\r\nrlen = (code & 0x1f);\r\nUNW_DEC_PROLOGUE(R1, body, rlen, arg);\r\nreturn dp;\r\n}\r\nstatic unsigned char *\r\nunw_decode_r2 (unsigned char *dp, unsigned char code, void *arg)\r\n{\r\nunsigned char byte1, mask, grsave;\r\nunw_word rlen;\r\nbyte1 = *dp++;\r\nmask = ((code & 0x7) << 1) | ((byte1 >> 7) & 1);\r\ngrsave = (byte1 & 0x7f);\r\nrlen = unw_decode_uleb128 (&dp);\r\nUNW_DEC_PROLOGUE_GR(R2, rlen, mask, grsave, arg);\r\nreturn dp;\r\n}\r\nstatic unsigned char *\r\nunw_decode_r3 (unsigned char *dp, unsigned char code, void *arg)\r\n{\r\nunw_word rlen;\r\nrlen = unw_decode_uleb128 (&dp);\r\nUNW_DEC_PROLOGUE(R3, ((code & 0x3) == 1), rlen, arg);\r\nreturn dp;\r\n}\r\nstatic unsigned char *\r\nunw_decode_p1 (unsigned char *dp, unsigned char code, void *arg)\r\n{\r\nunsigned char brmask = (code & 0x1f);\r\nUNW_DEC_BR_MEM(P1, brmask, arg);\r\nreturn dp;\r\n}\r\nstatic unsigned char *\r\nunw_decode_p2_p5 (unsigned char *dp, unsigned char code, void *arg)\r\n{\r\nif ((code & 0x10) == 0)\r\n{\r\nunsigned char byte1 = *dp++;\r\nUNW_DEC_BR_GR(P2, ((code & 0xf) << 1) | ((byte1 >> 7) & 1),\r\n(byte1 & 0x7f), arg);\r\n}\r\nelse if ((code & 0x08) == 0)\r\n{\r\nunsigned char byte1 = *dp++, r, dst;\r\nr = ((code & 0x7) << 1) | ((byte1 >> 7) & 1);\r\ndst = (byte1 & 0x7f);\r\nswitch (r)\r\n{\r\ncase 0: UNW_DEC_REG_GR(P3, UNW_REG_PSP, dst, arg); break;\r\ncase 1: UNW_DEC_REG_GR(P3, UNW_REG_RP, dst, arg); break;\r\ncase 2: UNW_DEC_REG_GR(P3, UNW_REG_PFS, dst, arg); break;\r\ncase 3: UNW_DEC_REG_GR(P3, UNW_REG_PR, dst, arg); break;\r\ncase 4: UNW_DEC_REG_GR(P3, UNW_REG_UNAT, dst, arg); break;\r\ncase 5: UNW_DEC_REG_GR(P3, UNW_REG_LC, dst, arg); break;\r\ncase 6: UNW_DEC_RP_BR(P3, dst, arg); break;\r\ncase 7: UNW_DEC_REG_GR(P3, UNW_REG_RNAT, dst, arg); break;\r\ncase 8: UNW_DEC_REG_GR(P3, UNW_REG_BSP, dst, arg); break;\r\ncase 9: UNW_DEC_REG_GR(P3, UNW_REG_BSPSTORE, dst, arg); break;\r\ncase 10: UNW_DEC_REG_GR(P3, UNW_REG_FPSR, dst, arg); break;\r\ncase 11: UNW_DEC_PRIUNAT_GR(P3, dst, arg); break;\r\ndefault: UNW_DEC_BAD_CODE(r); break;\r\n}\r\n}\r\nelse if ((code & 0x7) == 0)\r\nUNW_DEC_SPILL_MASK(P4, dp, arg);\r\nelse if ((code & 0x7) == 1)\r\n{\r\nunw_word grmask, frmask, byte1, byte2, byte3;\r\nbyte1 = *dp++; byte2 = *dp++; byte3 = *dp++;\r\ngrmask = ((byte1 >> 4) & 0xf);\r\nfrmask = ((byte1 & 0xf) << 16) | (byte2 << 8) | byte3;\r\nUNW_DEC_FRGR_MEM(P5, grmask, frmask, arg);\r\n}\r\nelse\r\nUNW_DEC_BAD_CODE(code);\r\nreturn dp;\r\n}\r\nstatic unsigned char *\r\nunw_decode_p6 (unsigned char *dp, unsigned char code, void *arg)\r\n{\r\nint gregs = (code & 0x10) != 0;\r\nunsigned char mask = (code & 0x0f);\r\nif (gregs)\r\nUNW_DEC_GR_MEM(P6, mask, arg);\r\nelse\r\nUNW_DEC_FR_MEM(P6, mask, arg);\r\nreturn dp;\r\n}\r\nstatic unsigned char *\r\nunw_decode_p7_p10 (unsigned char *dp, unsigned char code, void *arg)\r\n{\r\nunsigned char r, byte1, byte2;\r\nunw_word t, size;\r\nif ((code & 0x10) == 0)\r\n{\r\nr = (code & 0xf);\r\nt = unw_decode_uleb128 (&dp);\r\nswitch (r)\r\n{\r\ncase 0:\r\nsize = unw_decode_uleb128 (&dp);\r\nUNW_DEC_MEM_STACK_F(P7, t, size, arg);\r\nbreak;\r\ncase 1: UNW_DEC_MEM_STACK_V(P7, t, arg); break;\r\ncase 2: UNW_DEC_SPILL_BASE(P7, t, arg); break;\r\ncase 3: UNW_DEC_REG_SPREL(P7, UNW_REG_PSP, t, arg); break;\r\ncase 4: UNW_DEC_REG_WHEN(P7, UNW_REG_RP, t, arg); break;\r\ncase 5: UNW_DEC_REG_PSPREL(P7, UNW_REG_RP, t, arg); break;\r\ncase 6: UNW_DEC_REG_WHEN(P7, UNW_REG_PFS, t, arg); break;\r\ncase 7: UNW_DEC_REG_PSPREL(P7, UNW_REG_PFS, t, arg); break;\r\ncase 8: UNW_DEC_REG_WHEN(P7, UNW_REG_PR, t, arg); break;\r\ncase 9: UNW_DEC_REG_PSPREL(P7, UNW_REG_PR, t, arg); break;\r\ncase 10: UNW_DEC_REG_WHEN(P7, UNW_REG_LC, t, arg); break;\r\ncase 11: UNW_DEC_REG_PSPREL(P7, UNW_REG_LC, t, arg); break;\r\ncase 12: UNW_DEC_REG_WHEN(P7, UNW_REG_UNAT, t, arg); break;\r\ncase 13: UNW_DEC_REG_PSPREL(P7, UNW_REG_UNAT, t, arg); break;\r\ncase 14: UNW_DEC_REG_WHEN(P7, UNW_REG_FPSR, t, arg); break;\r\ncase 15: UNW_DEC_REG_PSPREL(P7, UNW_REG_FPSR, t, arg); break;\r\ndefault: UNW_DEC_BAD_CODE(r); break;\r\n}\r\n}\r\nelse\r\n{\r\nswitch (code & 0xf)\r\n{\r\ncase 0x0:\r\n{\r\nr = *dp++;\r\nt = unw_decode_uleb128 (&dp);\r\nswitch (r)\r\n{\r\ncase 1: UNW_DEC_REG_SPREL(P8, UNW_REG_RP, t, arg); break;\r\ncase 2: UNW_DEC_REG_SPREL(P8, UNW_REG_PFS, t, arg); break;\r\ncase 3: UNW_DEC_REG_SPREL(P8, UNW_REG_PR, t, arg); break;\r\ncase 4: UNW_DEC_REG_SPREL(P8, UNW_REG_LC, t, arg); break;\r\ncase 5: UNW_DEC_REG_SPREL(P8, UNW_REG_UNAT, t, arg); break;\r\ncase 6: UNW_DEC_REG_SPREL(P8, UNW_REG_FPSR, t, arg); break;\r\ncase 7: UNW_DEC_REG_WHEN(P8, UNW_REG_BSP, t, arg); break;\r\ncase 8: UNW_DEC_REG_PSPREL(P8, UNW_REG_BSP, t, arg); break;\r\ncase 9: UNW_DEC_REG_SPREL(P8, UNW_REG_BSP, t, arg); break;\r\ncase 10: UNW_DEC_REG_WHEN(P8, UNW_REG_BSPSTORE, t, arg); break;\r\ncase 11: UNW_DEC_REG_PSPREL(P8, UNW_REG_BSPSTORE, t, arg); break;\r\ncase 12: UNW_DEC_REG_SPREL(P8, UNW_REG_BSPSTORE, t, arg); break;\r\ncase 13: UNW_DEC_REG_WHEN(P8, UNW_REG_RNAT, t, arg); break;\r\ncase 14: UNW_DEC_REG_PSPREL(P8, UNW_REG_RNAT, t, arg); break;\r\ncase 15: UNW_DEC_REG_SPREL(P8, UNW_REG_RNAT, t, arg); break;\r\ncase 16: UNW_DEC_PRIUNAT_WHEN_GR(P8, t, arg); break;\r\ncase 17: UNW_DEC_PRIUNAT_PSPREL(P8, t, arg); break;\r\ncase 18: UNW_DEC_PRIUNAT_SPREL(P8, t, arg); break;\r\ncase 19: UNW_DEC_PRIUNAT_WHEN_MEM(P8, t, arg); break;\r\ndefault: UNW_DEC_BAD_CODE(r); break;\r\n}\r\n}\r\nbreak;\r\ncase 0x1:\r\nbyte1 = *dp++; byte2 = *dp++;\r\nUNW_DEC_GR_GR(P9, (byte1 & 0xf), (byte2 & 0x7f), arg);\r\nbreak;\r\ncase 0xf:\r\nbyte1 = *dp++; byte2 = *dp++;\r\nUNW_DEC_ABI(P10, byte1, byte2, arg);\r\nbreak;\r\ncase 0x9:\r\nreturn unw_decode_x1 (dp, code, arg);\r\ncase 0xa:\r\nreturn unw_decode_x2 (dp, code, arg);\r\ncase 0xb:\r\nreturn unw_decode_x3 (dp, code, arg);\r\ncase 0xc:\r\nreturn unw_decode_x4 (dp, code, arg);\r\ndefault:\r\nUNW_DEC_BAD_CODE(code);\r\nbreak;\r\n}\r\n}\r\nreturn dp;\r\n}\r\nstatic unsigned char *\r\nunw_decode_b1 (unsigned char *dp, unsigned char code, void *arg)\r\n{\r\nunw_word label = (code & 0x1f);\r\nif ((code & 0x20) != 0)\r\nUNW_DEC_COPY_STATE(B1, label, arg);\r\nelse\r\nUNW_DEC_LABEL_STATE(B1, label, arg);\r\nreturn dp;\r\n}\r\nstatic unsigned char *\r\nunw_decode_b2 (unsigned char *dp, unsigned char code, void *arg)\r\n{\r\nunw_word t;\r\nt = unw_decode_uleb128 (&dp);\r\nUNW_DEC_EPILOGUE(B2, t, (code & 0x1f), arg);\r\nreturn dp;\r\n}\r\nstatic unsigned char *\r\nunw_decode_b3_x4 (unsigned char *dp, unsigned char code, void *arg)\r\n{\r\nunw_word t, ecount, label;\r\nif ((code & 0x10) == 0)\r\n{\r\nt = unw_decode_uleb128 (&dp);\r\necount = unw_decode_uleb128 (&dp);\r\nUNW_DEC_EPILOGUE(B3, t, ecount, arg);\r\n}\r\nelse if ((code & 0x07) == 0)\r\n{\r\nlabel = unw_decode_uleb128 (&dp);\r\nif ((code & 0x08) != 0)\r\nUNW_DEC_COPY_STATE(B4, label, arg);\r\nelse\r\nUNW_DEC_LABEL_STATE(B4, label, arg);\r\n}\r\nelse\r\nswitch (code & 0x7)\r\n{\r\ncase 1: return unw_decode_x1 (dp, code, arg);\r\ncase 2: return unw_decode_x2 (dp, code, arg);\r\ncase 3: return unw_decode_x3 (dp, code, arg);\r\ncase 4: return unw_decode_x4 (dp, code, arg);\r\ndefault: UNW_DEC_BAD_CODE(code); break;\r\n}\r\nreturn dp;\r\n}\r\nstatic inline unsigned char *\r\nunw_decode (unsigned char *dp, int inside_body, void *arg)\r\n{\r\nunw_decoder decoder;\r\nunsigned char code;\r\ncode = *dp++;\r\ndecoder = unw_decode_table[inside_body][code >> 5];\r\ndp = (*decoder) (dp, code, arg);\r\nreturn dp;\r\n}

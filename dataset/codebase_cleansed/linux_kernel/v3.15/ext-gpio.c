static void __iomem *gpio_chip_to_mmr(struct gpio_chip *chip)\r\n{\r\nswitch (chip->base) {\r\ndefault:\r\ncase GPIO_PC0: return (void __iomem *)PORTCIO;\r\ncase GPIO_PD0: return (void __iomem *)PORTDIO;\r\ncase GPIO_PE0: return (void __iomem *)PORTEIO;\r\n}\r\n}\r\nstatic int bf538_gpio_get_value(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nvoid __iomem *port = gpio_chip_to_mmr(chip);\r\nreturn !!(read_PORTIO(port) & (1u << gpio));\r\n}\r\nstatic void bf538_gpio_set_value(struct gpio_chip *chip, unsigned gpio, int value)\r\n{\r\nvoid __iomem *port = gpio_chip_to_mmr(chip);\r\nif (value)\r\nwrite_PORTIO_SET(port, (1u << gpio));\r\nelse\r\nwrite_PORTIO_CLEAR(port, (1u << gpio));\r\n}\r\nstatic int bf538_gpio_direction_input(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nvoid __iomem *port = gpio_chip_to_mmr(chip);\r\nwrite_PORTIO_DIR(port, read_PORTIO_DIR(port) & ~(1u << gpio));\r\nwrite_PORTIO_INEN(port, read_PORTIO_INEN(port) | (1u << gpio));\r\nreturn 0;\r\n}\r\nstatic int bf538_gpio_direction_output(struct gpio_chip *chip, unsigned gpio, int value)\r\n{\r\nvoid __iomem *port = gpio_chip_to_mmr(chip);\r\nwrite_PORTIO_INEN(port, read_PORTIO_INEN(port) & ~(1u << gpio));\r\nbf538_gpio_set_value(port, gpio, value);\r\nwrite_PORTIO_DIR(port, read_PORTIO_DIR(port) | (1u << gpio));\r\nreturn 0;\r\n}\r\nstatic int bf538_gpio_request(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nreturn bfin_special_gpio_request(chip->base + gpio, chip->label);\r\n}\r\nstatic void bf538_gpio_free(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nreturn bfin_special_gpio_free(chip->base + gpio);\r\n}\r\nstatic int __init bf538_extgpio_setup(void)\r\n{\r\nreturn gpiochip_add(&bf538_portc_chip) |\r\ngpiochip_add(&bf538_portd_chip) |\r\ngpiochip_add(&bf538_porte_chip);\r\n}\r\nvoid bfin_special_gpio_pm_hibernate_suspend(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(port_bases); ++i) {\r\ngpio_bank_saved[i].data = read_PORTIO(port_bases[i]);\r\ngpio_bank_saved[i].inen = read_PORTIO_INEN(port_bases[i]);\r\ngpio_bank_saved[i].dir = read_PORTIO_DIR(port_bases[i]);\r\n}\r\n}\r\nvoid bfin_special_gpio_pm_hibernate_restore(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(port_bases); ++i) {\r\nwrite_PORTIO_INEN(port_bases[i], gpio_bank_saved[i].inen);\r\nwrite_PORTIO_SET(port_bases[i],\r\ngpio_bank_saved[i].data & gpio_bank_saved[i].dir);\r\nwrite_PORTIO_DIR(port_bases[i], gpio_bank_saved[i].dir);\r\n}\r\n}

static int rx51_battery_read_adc(int channel)\r\n{\r\nstruct twl4030_madc_request req;\r\nreq.channels = channel;\r\nreq.do_avg = 1;\r\nreq.method = TWL4030_MADC_SW1;\r\nreq.func_cb = NULL;\r\nreq.type = TWL4030_MADC_WAIT;\r\nreq.raw = true;\r\nif (twl4030_madc_conversion(&req) <= 0)\r\nreturn -ENODATA;\r\nreturn req.rbuf[ffs(channel) - 1];\r\n}\r\nstatic int rx51_battery_read_voltage(struct rx51_device_info *di)\r\n{\r\nint voltage = rx51_battery_read_adc(TWL4030_MADC_VBAT);\r\nif (voltage < 0)\r\nreturn voltage;\r\nreturn 1000 * (10000 * voltage / 1705);\r\n}\r\nstatic int rx51_battery_read_temperature(struct rx51_device_info *di)\r\n{\r\nint min = 0;\r\nint max = ARRAY_SIZE(rx51_temp_table2) - 1;\r\nint raw = rx51_battery_read_adc(TWL4030_MADC_BTEMP_RX51);\r\nif (raw <= 0)\r\nreturn INT_MAX;\r\nif (raw >= (1 << 10))\r\nreturn INT_MIN;\r\nif (raw < ARRAY_SIZE(rx51_temp_table1))\r\nreturn rx51_temp_table1[raw] * 10;\r\nwhile (max - min > 1) {\r\nint mid = (max + min) / 2;\r\nif (rx51_temp_table2[mid] <= raw)\r\nmin = mid;\r\nelse if (rx51_temp_table2[mid] > raw)\r\nmax = mid;\r\nif (rx51_temp_table2[mid] == raw)\r\nbreak;\r\n}\r\nreturn (rx51_temp_table2_first - min) * 10;\r\n}\r\nstatic int rx51_battery_read_capacity(struct rx51_device_info *di)\r\n{\r\nint capacity = rx51_battery_read_adc(TWL4030_MADC_BCI_RX51);\r\nif (capacity < 0)\r\nreturn capacity;\r\nreturn 1280 * (1200 * capacity)/(1024 - capacity);\r\n}\r\nstatic int rx51_battery_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct rx51_device_info *di = container_of((psy),\r\nstruct rx51_device_info, bat);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN:\r\nval->intval = 4200000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = rx51_battery_read_voltage(di) ? 1 : 0;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nval->intval = rx51_battery_read_voltage(di);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP:\r\nval->intval = rx51_battery_read_temperature(di);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN:\r\nval->intval = rx51_battery_read_capacity(di);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (val->intval == INT_MAX || val->intval == INT_MIN)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int rx51_battery_probe(struct platform_device *pdev)\r\n{\r\nstruct rx51_device_info *di;\r\nint ret;\r\ndi = devm_kzalloc(&pdev->dev, sizeof(*di), GFP_KERNEL);\r\nif (!di)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, di);\r\ndi->bat.name = dev_name(&pdev->dev);\r\ndi->bat.type = POWER_SUPPLY_TYPE_BATTERY;\r\ndi->bat.properties = rx51_battery_props;\r\ndi->bat.num_properties = ARRAY_SIZE(rx51_battery_props);\r\ndi->bat.get_property = rx51_battery_get_property;\r\nret = power_supply_register(di->dev, &di->bat);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int rx51_battery_remove(struct platform_device *pdev)\r\n{\r\nstruct rx51_device_info *di = platform_get_drvdata(pdev);\r\npower_supply_unregister(&di->bat);\r\nreturn 0;\r\n}

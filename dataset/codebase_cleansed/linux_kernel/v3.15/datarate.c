void s_vResetCounter(PKnownNodeDB psNodeDBTable)\r\n{\r\nu8 ii;\r\nfor (ii = 0; ii <= MAX_RATE; ii++) {\r\npsNodeDBTable->uTxOk[ii] = 0;\r\npsNodeDBTable->uTxFail[ii] = 0;\r\n}\r\n}\r\nu16 RATEwGetRateIdx(u8 byRate)\r\n{\r\nu16 ii;\r\nbyRate = byRate & 0x7F;\r\nfor (ii = 0; ii < MAX_RATE; ii++) {\r\nif (acbyIERate[ii] == byRate)\r\nreturn ii;\r\n}\r\nreturn 0;\r\n}\r\nvoid RATEvParseMaxRate(struct vnt_private *pDevice,\r\nPWLAN_IE_SUPP_RATES pItemRates, PWLAN_IE_SUPP_RATES pItemExtRates,\r\nint bUpdateBasicRate, u16 *pwMaxBasicRate, u16 *pwMaxSuppRate,\r\nu16 *pwSuppRate, u8 *pbyTopCCKRate, u8 *pbyTopOFDMRate)\r\n{\r\nint ii;\r\nu8 byHighSuppRate = 0, byRate = 0;\r\nu16 wOldBasicRate = pDevice->wBasicRate;\r\nu32 uRateLen;\r\nif (pItemRates == NULL)\r\nreturn;\r\n*pwSuppRate = 0;\r\nuRateLen = pItemRates->len;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"ParseMaxRate Len: %d\n", uRateLen);\r\nif (pDevice->byBBType != BB_TYPE_11B) {\r\nif (uRateLen > WLAN_RATES_MAXLEN)\r\nuRateLen = WLAN_RATES_MAXLEN;\r\n} else {\r\nif (uRateLen > WLAN_RATES_MAXLEN_11B)\r\nuRateLen = WLAN_RATES_MAXLEN_11B;\r\n}\r\nfor (ii = 0; ii < uRateLen; ii++) {\r\nbyRate = (u8)(pItemRates->abyRates[ii]);\r\nif (WLAN_MGMT_IS_BASICRATE(byRate) &&\r\n(bUpdateBasicRate == true)) {\r\nCARDbAddBasicRate((void *)pDevice, RATEwGetRateIdx(byRate));\r\nDBG_PRT(MSG_LEVEL_DEBUG,\r\nKERN_INFO"ParseMaxRate AddBasicRate: %d\n",\r\nRATEwGetRateIdx(byRate));\r\n}\r\nbyRate = (u8)(pItemRates->abyRates[ii]&0x7F);\r\nif (byHighSuppRate == 0)\r\nbyHighSuppRate = byRate;\r\nif (byRate > byHighSuppRate)\r\nbyHighSuppRate = byRate;\r\n*pwSuppRate |= (1<<RATEwGetRateIdx(byRate));\r\n}\r\nif ((pItemExtRates != NULL) && (pItemExtRates->byElementID == WLAN_EID_EXTSUPP_RATES) &&\r\n(pDevice->byBBType != BB_TYPE_11B)) {\r\nunsigned int uExtRateLen = pItemExtRates->len;\r\nif (uExtRateLen > WLAN_RATES_MAXLEN)\r\nuExtRateLen = WLAN_RATES_MAXLEN;\r\nfor (ii = 0; ii < uExtRateLen; ii++) {\r\nbyRate = (u8)(pItemExtRates->abyRates[ii]);\r\nif (WLAN_MGMT_IS_BASICRATE(pItemExtRates->abyRates[ii])) {\r\nCARDbAddBasicRate((void *)pDevice, RATEwGetRateIdx(byRate));\r\nDBG_PRT(MSG_LEVEL_DEBUG,\r\nKERN_INFO"ParseMaxRate AddBasicRate: %d\n",\r\nRATEwGetRateIdx(byRate));\r\n}\r\nbyRate = (u8)(pItemExtRates->abyRates[ii]&0x7F);\r\nif (byHighSuppRate == 0)\r\nbyHighSuppRate = byRate;\r\nif (byRate > byHighSuppRate)\r\nbyHighSuppRate = byRate;\r\n*pwSuppRate |= (1<<RATEwGetRateIdx(byRate));\r\n}\r\n}\r\nif ((pDevice->byPacketType == PK_TYPE_11GB)\r\n&& CARDbIsOFDMinBasicRate((void *)pDevice)) {\r\npDevice->byPacketType = PK_TYPE_11GA;\r\n}\r\n*pbyTopCCKRate = pDevice->byTopCCKBasicRate;\r\n*pbyTopOFDMRate = pDevice->byTopOFDMBasicRate;\r\n*pwMaxSuppRate = RATEwGetRateIdx(byHighSuppRate);\r\nif ((pDevice->byPacketType == PK_TYPE_11B) || (pDevice->byPacketType == PK_TYPE_11GB))\r\n*pwMaxBasicRate = pDevice->byTopCCKBasicRate;\r\nelse\r\n*pwMaxBasicRate = pDevice->byTopOFDMBasicRate;\r\nif (wOldBasicRate != pDevice->wBasicRate)\r\nCARDvSetRSPINF((void *)pDevice, pDevice->byBBType);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"Exit ParseMaxRate\n");\r\n}\r\nvoid RATEvTxRateFallBack(struct vnt_private *pDevice,\r\nPKnownNodeDB psNodeDBTable)\r\n{\r\nstruct vnt_manager *pMgmt = &pDevice->vnt_mgmt;\r\nu16 wIdxDownRate = 0;\r\nint ii;\r\nint bAutoRate[MAX_RATE] = {true, true, true, true, false, false, true,\r\ntrue, true, true, true, true};\r\nu32 dwThroughputTbl[MAX_RATE] = {10, 20, 55, 110, 60, 90, 120, 180,\r\n240, 360, 480, 540};\r\nu32 dwThroughput = 0;\r\nu16 wIdxUpRate = 0;\r\nu32 dwTxDiff = 0;\r\nif (pMgmt->eScanState != WMAC_NO_SCANNING)\r\nreturn;\r\npsNodeDBTable->uTimeCount++;\r\nif (psNodeDBTable->uTxFail[MAX_RATE] > psNodeDBTable->uTxOk[MAX_RATE])\r\ndwTxDiff = psNodeDBTable->uTxFail[MAX_RATE] - psNodeDBTable->uTxOk[MAX_RATE];\r\nif ((psNodeDBTable->uTxOk[MAX_RATE] < AUTORATE_TXOK_CNT) &&\r\n(dwTxDiff < AUTORATE_TXFAIL_CNT) &&\r\n(psNodeDBTable->uTimeCount < AUTORATE_TIMEOUT)) {\r\nreturn;\r\n}\r\nif (psNodeDBTable->uTimeCount >= AUTORATE_TIMEOUT)\r\npsNodeDBTable->uTimeCount = 0;\r\nfor (ii = 0; ii < MAX_RATE; ii++) {\r\nif (psNodeDBTable->wSuppRate & (0x0001<<ii)) {\r\nif (bAutoRate[ii] == true)\r\nwIdxUpRate = (u16) ii;\r\n} else {\r\nbAutoRate[ii] = false;\r\n}\r\n}\r\nfor (ii = 0; ii <= psNodeDBTable->wTxDataRate; ii++) {\r\nif ((psNodeDBTable->uTxOk[ii] != 0) ||\r\n(psNodeDBTable->uTxFail[ii] != 0)) {\r\ndwThroughputTbl[ii] *= psNodeDBTable->uTxOk[ii];\r\nif (ii < RATE_11M)\r\npsNodeDBTable->uTxFail[ii] *= 4;\r\ndwThroughputTbl[ii] /= (psNodeDBTable->uTxOk[ii] + psNodeDBTable->uTxFail[ii]);\r\n}\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"Rate %d,Ok: %d, Fail:%d, Throughput:%d\n",\r\nii, (int)psNodeDBTable->uTxOk[ii], (int)psNodeDBTable->uTxFail[ii], (int)dwThroughputTbl[ii]);\r\n}\r\ndwThroughput = dwThroughputTbl[psNodeDBTable->wTxDataRate];\r\nwIdxDownRate = psNodeDBTable->wTxDataRate;\r\nfor (ii = psNodeDBTable->wTxDataRate; ii > 0;) {\r\nii--;\r\nif ((dwThroughputTbl[ii] > dwThroughput) &&\r\n(bAutoRate[ii] == true)) {\r\ndwThroughput = dwThroughputTbl[ii];\r\nwIdxDownRate = (u16) ii;\r\n}\r\n}\r\npsNodeDBTable->wTxDataRate = wIdxDownRate;\r\nif (psNodeDBTable->uTxOk[MAX_RATE]) {\r\nif (psNodeDBTable->uTxOk[MAX_RATE] >\r\n(psNodeDBTable->uTxFail[MAX_RATE] * 4)) {\r\npsNodeDBTable->wTxDataRate = wIdxUpRate;\r\n}\r\n} else {\r\nif (psNodeDBTable->uTxFail[MAX_RATE] == 0)\r\npsNodeDBTable->wTxDataRate = wIdxUpRate;\r\n}\r\nif (pDevice->byBBType == BB_TYPE_11A) {\r\nif (psNodeDBTable->wTxDataRate <= RATE_11M)\r\npsNodeDBTable->wTxDataRate = RATE_6M;\r\n}\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"uTxOk[MAX_RATE] %d, uTxFail[MAX_RATE]:%d\n", (int)psNodeDBTable->uTxOk[MAX_RATE], (int)psNodeDBTable->uTxFail[MAX_RATE]);\r\ns_vResetCounter(psNodeDBTable);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"Rate: %d, U:%d, D:%d\n", (int)psNodeDBTable->wTxDataRate, (int)wIdxUpRate, (int)wIdxDownRate);\r\nreturn;\r\n}\r\nu8 RATEuSetIE(PWLAN_IE_SUPP_RATES pSrcRates, PWLAN_IE_SUPP_RATES pDstRates,\r\nunsigned int uRateLen)\r\n{\r\nunsigned int ii, uu, uRateCnt = 0;\r\nif ((pSrcRates == NULL) || (pDstRates == NULL))\r\nreturn 0;\r\nif (pSrcRates->len == 0)\r\nreturn 0;\r\nfor (ii = 0; ii < uRateLen; ii++) {\r\nfor (uu = 0; uu < pSrcRates->len; uu++) {\r\nif ((pSrcRates->abyRates[uu] & 0x7F) == acbyIERate[ii]) {\r\npDstRates->abyRates[uRateCnt++] = pSrcRates->abyRates[uu];\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn (u8)uRateCnt;\r\n}

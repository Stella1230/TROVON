static int pcf8583_get_datetime(struct i2c_client *client, struct rtc_time *dt)\r\n{\r\nunsigned char buf[8], addr[1] = { 1 };\r\nstruct i2c_msg msgs[2] = {\r\n{\r\n.addr = client->addr,\r\n.flags = 0,\r\n.len = 1,\r\n.buf = addr,\r\n}, {\r\n.addr = client->addr,\r\n.flags = I2C_M_RD,\r\n.len = 6,\r\n.buf = buf,\r\n}\r\n};\r\nint ret;\r\nmemset(buf, 0, sizeof(buf));\r\nret = i2c_transfer(client->adapter, msgs, 2);\r\nif (ret == 2) {\r\ndt->tm_year = buf[4] >> 6;\r\ndt->tm_wday = buf[5] >> 5;\r\nbuf[4] &= 0x3f;\r\nbuf[5] &= 0x1f;\r\ndt->tm_sec = bcd2bin(buf[1]);\r\ndt->tm_min = bcd2bin(buf[2]);\r\ndt->tm_hour = bcd2bin(buf[3]);\r\ndt->tm_mday = bcd2bin(buf[4]);\r\ndt->tm_mon = bcd2bin(buf[5]) - 1;\r\n}\r\nreturn ret == 2 ? 0 : -EIO;\r\n}\r\nstatic int pcf8583_set_datetime(struct i2c_client *client, struct rtc_time *dt, int datetoo)\r\n{\r\nunsigned char buf[8];\r\nint ret, len = 6;\r\nbuf[0] = 0;\r\nbuf[1] = get_ctrl(client) | 0x80;\r\nbuf[2] = 0;\r\nbuf[3] = bin2bcd(dt->tm_sec);\r\nbuf[4] = bin2bcd(dt->tm_min);\r\nbuf[5] = bin2bcd(dt->tm_hour);\r\nif (datetoo) {\r\nlen = 8;\r\nbuf[6] = bin2bcd(dt->tm_mday) | (dt->tm_year << 6);\r\nbuf[7] = bin2bcd(dt->tm_mon + 1) | (dt->tm_wday << 5);\r\n}\r\nret = i2c_master_send(client, (char *)buf, len);\r\nif (ret != len)\r\nreturn -EIO;\r\nbuf[1] = get_ctrl(client);\r\nret = i2c_master_send(client, (char *)buf, 2);\r\nreturn ret == 2 ? 0 : -EIO;\r\n}\r\nstatic int pcf8583_get_ctrl(struct i2c_client *client, unsigned char *ctrl)\r\n{\r\n*ctrl = get_ctrl(client);\r\nreturn 0;\r\n}\r\nstatic int pcf8583_set_ctrl(struct i2c_client *client, unsigned char *ctrl)\r\n{\r\nunsigned char buf[2];\r\nbuf[0] = 0;\r\nbuf[1] = *ctrl;\r\nset_ctrl(client, *ctrl);\r\nreturn i2c_master_send(client, (char *)buf, 2);\r\n}\r\nstatic int pcf8583_read_mem(struct i2c_client *client, struct rtc_mem *mem)\r\n{\r\nunsigned char addr[1];\r\nstruct i2c_msg msgs[2] = {\r\n{\r\n.addr = client->addr,\r\n.flags = 0,\r\n.len = 1,\r\n.buf = addr,\r\n}, {\r\n.addr = client->addr,\r\n.flags = I2C_M_RD,\r\n.len = mem->nr,\r\n.buf = mem->data,\r\n}\r\n};\r\nif (mem->loc < 8)\r\nreturn -EINVAL;\r\naddr[0] = mem->loc;\r\nreturn i2c_transfer(client->adapter, msgs, 2) == 2 ? 0 : -EIO;\r\n}\r\nstatic int pcf8583_write_mem(struct i2c_client *client, struct rtc_mem *mem)\r\n{\r\nunsigned char buf[9];\r\nint ret;\r\nif (mem->loc < 8 || mem->nr > 8)\r\nreturn -EINVAL;\r\nbuf[0] = mem->loc;\r\nmemcpy(buf + 1, mem->data, mem->nr);\r\nret = i2c_master_send(client, buf, mem->nr + 1);\r\nreturn ret == mem->nr + 1 ? 0 : -EIO;\r\n}\r\nstatic int pcf8583_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nunsigned char ctrl, year[2];\r\nstruct rtc_mem mem = { CMOS_YEAR, sizeof(year), year };\r\nint real_year, year_offset, err;\r\npcf8583_get_ctrl(client, &ctrl);\r\nif (ctrl & (CTRL_STOP | CTRL_HOLD)) {\r\nunsigned char new_ctrl = ctrl & ~(CTRL_STOP | CTRL_HOLD);\r\ndev_warn(dev, "resetting control %02x -> %02x\n",\r\nctrl, new_ctrl);\r\nerr = pcf8583_set_ctrl(client, &new_ctrl);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nif (pcf8583_get_datetime(client, tm) ||\r\npcf8583_read_mem(client, &mem))\r\nreturn -EIO;\r\nreal_year = year[0];\r\nyear_offset = tm->tm_year - (real_year & 3);\r\nif (year_offset < 0)\r\nyear_offset += 4;\r\ntm->tm_year = (real_year + year_offset + year[1] * 100) - 1900;\r\nreturn 0;\r\n}\r\nstatic int pcf8583_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nunsigned char year[2], chk;\r\nstruct rtc_mem cmos_year = { CMOS_YEAR, sizeof(year), year };\r\nstruct rtc_mem cmos_check = { CMOS_CHECKSUM, 1, &chk };\r\nunsigned int proper_year = tm->tm_year + 1900;\r\nint ret;\r\nret = pcf8583_set_datetime(client, tm, 1);\r\nif (ret)\r\nreturn ret;\r\nret = pcf8583_read_mem(client, &cmos_check);\r\nif (ret)\r\nreturn ret;\r\nret = pcf8583_read_mem(client, &cmos_year);\r\nif (ret)\r\nreturn ret;\r\nchk -= year[1] + year[0];\r\nyear[1] = proper_year / 100;\r\nyear[0] = proper_year % 100;\r\nchk += year[1] + year[0];\r\nret = pcf8583_write_mem(client, &cmos_year);\r\nif (ret)\r\nreturn ret;\r\nret = pcf8583_write_mem(client, &cmos_check);\r\nreturn ret;\r\n}\r\nstatic int pcf8583_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct pcf8583 *pcf8583;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C))\r\nreturn -ENODEV;\r\npcf8583 = devm_kzalloc(&client->dev, sizeof(struct pcf8583),\r\nGFP_KERNEL);\r\nif (!pcf8583)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, pcf8583);\r\npcf8583->rtc = devm_rtc_device_register(&client->dev,\r\npcf8583_driver.driver.name,\r\n&pcf8583_rtc_ops, THIS_MODULE);\r\nreturn PTR_ERR_OR_ZERO(pcf8583->rtc);\r\n}

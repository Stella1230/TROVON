static int xilly_pci_direction(int direction)\r\n{\r\nswitch (direction) {\r\ncase DMA_TO_DEVICE:\r\nreturn PCI_DMA_TODEVICE;\r\ncase DMA_FROM_DEVICE:\r\nreturn PCI_DMA_FROMDEVICE;\r\ndefault:\r\nreturn PCI_DMA_BIDIRECTIONAL;\r\n}\r\n}\r\nstatic void xilly_dma_sync_single_for_cpu_pci(struct xilly_endpoint *ep,\r\ndma_addr_t dma_handle,\r\nsize_t size,\r\nint direction)\r\n{\r\npci_dma_sync_single_for_cpu(ep->pdev,\r\ndma_handle,\r\nsize,\r\nxilly_pci_direction(direction));\r\n}\r\nstatic void xilly_dma_sync_single_for_device_pci(struct xilly_endpoint *ep,\r\ndma_addr_t dma_handle,\r\nsize_t size,\r\nint direction)\r\n{\r\npci_dma_sync_single_for_device(ep->pdev,\r\ndma_handle,\r\nsize,\r\nxilly_pci_direction(direction));\r\n}\r\nstatic dma_addr_t xilly_map_single_pci(struct xilly_cleanup *mem,\r\nstruct xilly_endpoint *ep,\r\nvoid *ptr,\r\nsize_t size,\r\nint direction\r\n)\r\n{\r\ndma_addr_t addr = 0;\r\nstruct xilly_dma *this;\r\nint pci_direction;\r\nthis = kmalloc(sizeof(struct xilly_dma), GFP_KERNEL);\r\nif (!this)\r\nreturn 0;\r\npci_direction = xilly_pci_direction(direction);\r\naddr = pci_map_single(ep->pdev, ptr, size, pci_direction);\r\nthis->direction = pci_direction;\r\nif (pci_dma_mapping_error(ep->pdev, addr)) {\r\nkfree(this);\r\nreturn 0;\r\n}\r\nthis->dma_addr = addr;\r\nthis->pdev = ep->pdev;\r\nthis->size = size;\r\nlist_add_tail(&this->node, &mem->to_unmap);\r\nreturn addr;\r\n}\r\nstatic void xilly_unmap_single_pci(struct xilly_dma *entry)\r\n{\r\npci_unmap_single(entry->pdev,\r\nentry->dma_addr,\r\nentry->size,\r\nentry->direction);\r\n}\r\nstatic int xilly_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct xilly_endpoint *endpoint;\r\nint rc = 0;\r\nendpoint = xillybus_init_endpoint(pdev, &pdev->dev, &pci_hw);\r\nif (!endpoint)\r\nreturn -ENOMEM;\r\npci_set_drvdata(pdev, endpoint);\r\nrc = pci_enable_device(pdev);\r\npci_disable_link_state(pdev, PCIE_LINK_STATE_L0S);\r\nif (rc) {\r\ndev_err(endpoint->dev,\r\n"pci_enable_device() failed. Aborting.\n");\r\ngoto no_enable;\r\n}\r\nif (!(pci_resource_flags(pdev, 0) & IORESOURCE_MEM)) {\r\ndev_err(endpoint->dev,\r\n"Incorrect BAR configuration. Aborting.\n");\r\nrc = -ENODEV;\r\ngoto bad_bar;\r\n}\r\nrc = pci_request_regions(pdev, xillyname);\r\nif (rc) {\r\ndev_err(endpoint->dev,\r\n"pci_request_regions() failed. Aborting.\n");\r\ngoto failed_request_regions;\r\n}\r\nendpoint->registers = pci_iomap(pdev, 0, 128);\r\nif (!endpoint->registers) {\r\ndev_err(endpoint->dev, "Failed to map BAR 0. Aborting.\n");\r\nrc = -EIO;\r\ngoto failed_iomap0;\r\n}\r\npci_set_master(pdev);\r\nif (pci_enable_msi(pdev)) {\r\ndev_err(endpoint->dev,\r\n"Failed to enable MSI interrupts. Aborting.\n");\r\nrc = -ENODEV;\r\ngoto failed_enable_msi;\r\n}\r\nrc = request_irq(pdev->irq, xillybus_isr, 0, xillyname, endpoint);\r\nif (rc) {\r\ndev_err(endpoint->dev,\r\n"Failed to register MSI handler. Aborting.\n");\r\nrc = -ENODEV;\r\ngoto failed_register_msi;\r\n}\r\nif (!pci_set_dma_mask(pdev, DMA_BIT_MASK(32)))\r\nendpoint->dma_using_dac = 0;\r\nelse {\r\ndev_err(endpoint->dev, "Failed to set DMA mask. Aborting.\n");\r\nrc = -ENODEV;\r\ngoto failed_dmamask;\r\n}\r\nrc = xillybus_endpoint_discovery(endpoint);\r\nif (!rc)\r\nreturn 0;\r\nfailed_dmamask:\r\nfree_irq(pdev->irq, endpoint);\r\nfailed_register_msi:\r\npci_disable_msi(pdev);\r\nfailed_enable_msi:\r\npci_iounmap(pdev, endpoint->registers);\r\nfailed_iomap0:\r\npci_release_regions(pdev);\r\nfailed_request_regions:\r\nbad_bar:\r\npci_disable_device(pdev);\r\nno_enable:\r\nxillybus_do_cleanup(&endpoint->cleanup, endpoint);\r\nkfree(endpoint);\r\nreturn rc;\r\n}\r\nstatic void xilly_remove(struct pci_dev *pdev)\r\n{\r\nstruct xilly_endpoint *endpoint = pci_get_drvdata(pdev);\r\nxillybus_endpoint_remove(endpoint);\r\nfree_irq(pdev->irq, endpoint);\r\npci_disable_msi(pdev);\r\npci_iounmap(pdev, endpoint->registers);\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\nxillybus_do_cleanup(&endpoint->cleanup, endpoint);\r\nkfree(endpoint);\r\n}

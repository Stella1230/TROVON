static int nvidia_bl_get_level_brightness(struct nvidia_par *par,\r\nint level)\r\n{\r\nstruct fb_info *info = pci_get_drvdata(par->pci_dev);\r\nint nlevel;\r\nnlevel = MIN_LEVEL + info->bl_curve[level] * LEVEL_STEP;\r\nif (nlevel < 0)\r\nnlevel = 0;\r\nelse if (nlevel < MIN_LEVEL)\r\nnlevel = MIN_LEVEL;\r\nelse if (nlevel > MAX_LEVEL)\r\nnlevel = MAX_LEVEL;\r\nreturn nlevel;\r\n}\r\nstatic int nvidia_bl_update_status(struct backlight_device *bd)\r\n{\r\nstruct nvidia_par *par = bl_get_data(bd);\r\nu32 tmp_pcrt, tmp_pmc, fpcontrol;\r\nint level;\r\nif (!par->FlatPanel)\r\nreturn 0;\r\nif (bd->props.power != FB_BLANK_UNBLANK ||\r\nbd->props.fb_blank != FB_BLANK_UNBLANK)\r\nlevel = 0;\r\nelse\r\nlevel = bd->props.brightness;\r\ntmp_pmc = NV_RD32(par->PMC, 0x10F0) & 0x0000FFFF;\r\ntmp_pcrt = NV_RD32(par->PCRTC0, 0x081C) & 0xFFFFFFFC;\r\nfpcontrol = NV_RD32(par->PRAMDAC, 0x0848) & 0xCFFFFFCC;\r\nif (level > 0) {\r\ntmp_pcrt |= 0x1;\r\ntmp_pmc |= (1 << 31);\r\ntmp_pmc |= nvidia_bl_get_level_brightness(par, level) << 16;\r\nfpcontrol |= par->fpSyncs;\r\n} else\r\nfpcontrol |= 0x20000022;\r\nNV_WR32(par->PCRTC0, 0x081C, tmp_pcrt);\r\nNV_WR32(par->PMC, 0x10F0, tmp_pmc);\r\nNV_WR32(par->PRAMDAC, 0x848, fpcontrol);\r\nreturn 0;\r\n}\r\nstatic int nvidia_bl_get_brightness(struct backlight_device *bd)\r\n{\r\nreturn bd->props.brightness;\r\n}\r\nvoid nvidia_bl_init(struct nvidia_par *par)\r\n{\r\nstruct backlight_properties props;\r\nstruct fb_info *info = pci_get_drvdata(par->pci_dev);\r\nstruct backlight_device *bd;\r\nchar name[12];\r\nif (!par->FlatPanel)\r\nreturn;\r\n#ifdef CONFIG_PMAC_BACKLIGHT\r\nif (!machine_is(powermac) ||\r\n!pmac_has_backlight_type("mnca"))\r\nreturn;\r\n#endif\r\nsnprintf(name, sizeof(name), "nvidiabl%d", info->node);\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = FB_BACKLIGHT_LEVELS - 1;\r\nbd = backlight_device_register(name, info->dev, par, &nvidia_bl_ops,\r\n&props);\r\nif (IS_ERR(bd)) {\r\ninfo->bl_dev = NULL;\r\nprintk(KERN_WARNING "nvidia: Backlight registration failed\n");\r\ngoto error;\r\n}\r\ninfo->bl_dev = bd;\r\nfb_bl_default_curve(info, 0,\r\n0x158 * FB_BACKLIGHT_MAX / MAX_LEVEL,\r\n0x534 * FB_BACKLIGHT_MAX / MAX_LEVEL);\r\nbd->props.brightness = bd->props.max_brightness;\r\nbd->props.power = FB_BLANK_UNBLANK;\r\nbacklight_update_status(bd);\r\nprintk("nvidia: Backlight initialized (%s)\n", name);\r\nreturn;\r\nerror:\r\nreturn;\r\n}\r\nvoid nvidia_bl_exit(struct nvidia_par *par)\r\n{\r\nstruct fb_info *info = pci_get_drvdata(par->pci_dev);\r\nstruct backlight_device *bd = info->bl_dev;\r\nbacklight_device_unregister(bd);\r\nprintk("nvidia: Backlight unloaded\n");\r\n}

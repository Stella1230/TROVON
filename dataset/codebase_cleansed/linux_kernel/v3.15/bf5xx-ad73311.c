static int snd_ad73311_startup(void)\r\n{\r\npr_debug("%s enter\n", __func__);\r\ngpio_set_value(GPIO_SE, 1);\r\nreturn 0;\r\n}\r\nstatic int snd_ad73311_configure(void)\r\n{\r\nunsigned short ctrl_regs[6];\r\nunsigned short status = 0;\r\nint count = 0;\r\nctrl_regs[0] = AD_CONTROL | AD_WRITE | CTRL_REG_B | REGB_MCDIV(0) | \\r\nREGB_SCDIV(0) | REGB_DIRATE(0);\r\nctrl_regs[1] = AD_CONTROL | AD_WRITE | CTRL_REG_C | REGC_PUDEV | \\r\nREGC_PUADC | REGC_PUDAC | REGC_PUREF | REGC_REFUSE ;\r\nctrl_regs[2] = AD_CONTROL | AD_WRITE | CTRL_REG_D | REGD_OGS(2) | \\r\nREGD_IGS(2);\r\nctrl_regs[3] = AD_CONTROL | AD_WRITE | CTRL_REG_E | REGE_DA(0x1f);\r\nctrl_regs[4] = AD_CONTROL | AD_WRITE | CTRL_REG_F | REGF_SEEN ;\r\nctrl_regs[5] = AD_CONTROL | AD_WRITE | CTRL_REG_A | REGA_MODE_DATA;\r\nlocal_irq_disable();\r\nsnd_ad73311_startup();\r\nudelay(1);\r\nbfin_write_SPORT_TCR1(TFSR);\r\nbfin_write_SPORT_TCR2(0xF);\r\nSSYNC();\r\nfor (count = 0; count < 6; count++)\r\nbfin_write_SPORT_TX16(ctrl_regs[count]);\r\nSSYNC();\r\nbfin_write_SPORT_TCR1(bfin_read_SPORT_TCR1() | TSPEN);\r\nSSYNC();\r\nwhile (!(status & TUVF) && ++count < 10000) {\r\nudelay(1);\r\nstatus = bfin_read_SPORT_STAT();\r\nSSYNC();\r\n}\r\nbfin_write_SPORT_TCR1(bfin_read_SPORT_TCR1() & ~TSPEN);\r\nSSYNC();\r\nlocal_irq_enable();\r\nif (count >= 10000) {\r\nprintk(KERN_ERR "ad73311: failed to configure codec\n");\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bf5xx_probe(struct snd_soc_card *card)\r\n{\r\nint err;\r\nif (gpio_request(GPIO_SE, "AD73311_SE")) {\r\nprintk(KERN_ERR "%s: Failed ro request GPIO_%d\n", __func__, GPIO_SE);\r\nreturn -EBUSY;\r\n}\r\ngpio_direction_output(GPIO_SE, 0);\r\nerr = snd_ad73311_configure();\r\nif (err < 0)\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nstatic int __init bf5xx_ad73311_init(void)\r\n{\r\nint ret;\r\npr_debug("%s enter\n", __func__);\r\nbf5xx_ad73311_snd_device = platform_device_alloc("soc-audio", -1);\r\nif (!bf5xx_ad73311_snd_device)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(bf5xx_ad73311_snd_device, &bf5xx_ad73311);\r\nret = platform_device_add(bf5xx_ad73311_snd_device);\r\nif (ret)\r\nplatform_device_put(bf5xx_ad73311_snd_device);\r\nreturn ret;\r\n}\r\nstatic void __exit bf5xx_ad73311_exit(void)\r\n{\r\npr_debug("%s enter\n", __func__);\r\nplatform_device_unregister(bf5xx_ad73311_snd_device);\r\n}

static int scan_for_master(struct ubifs_info *c)\r\n{\r\nstruct ubifs_scan_leb *sleb;\r\nstruct ubifs_scan_node *snod;\r\nint lnum, offs = 0, nodes_cnt;\r\nlnum = UBIFS_MST_LNUM;\r\nsleb = ubifs_scan(c, lnum, 0, c->sbuf, 1);\r\nif (IS_ERR(sleb))\r\nreturn PTR_ERR(sleb);\r\nnodes_cnt = sleb->nodes_cnt;\r\nif (nodes_cnt > 0) {\r\nsnod = list_entry(sleb->nodes.prev, struct ubifs_scan_node,\r\nlist);\r\nif (snod->type != UBIFS_MST_NODE)\r\ngoto out_dump;\r\nmemcpy(c->mst_node, snod->node, snod->len);\r\noffs = snod->offs;\r\n}\r\nubifs_scan_destroy(sleb);\r\nlnum += 1;\r\nsleb = ubifs_scan(c, lnum, 0, c->sbuf, 1);\r\nif (IS_ERR(sleb))\r\nreturn PTR_ERR(sleb);\r\nif (sleb->nodes_cnt != nodes_cnt)\r\ngoto out;\r\nif (!sleb->nodes_cnt)\r\ngoto out;\r\nsnod = list_entry(sleb->nodes.prev, struct ubifs_scan_node, list);\r\nif (snod->type != UBIFS_MST_NODE)\r\ngoto out_dump;\r\nif (snod->offs != offs)\r\ngoto out;\r\nif (memcmp((void *)c->mst_node + UBIFS_CH_SZ,\r\n(void *)snod->node + UBIFS_CH_SZ,\r\nUBIFS_MST_NODE_SZ - UBIFS_CH_SZ))\r\ngoto out;\r\nc->mst_offs = offs;\r\nubifs_scan_destroy(sleb);\r\nreturn 0;\r\nout:\r\nubifs_scan_destroy(sleb);\r\nreturn -EUCLEAN;\r\nout_dump:\r\nubifs_err("unexpected node type %d master LEB %d:%d",\r\nsnod->type, lnum, snod->offs);\r\nubifs_scan_destroy(sleb);\r\nreturn -EINVAL;\r\n}\r\nstatic int validate_master(const struct ubifs_info *c)\r\n{\r\nlong long main_sz;\r\nint err;\r\nif (c->max_sqnum >= SQNUM_WATERMARK) {\r\nerr = 1;\r\ngoto out;\r\n}\r\nif (c->cmt_no >= c->max_sqnum) {\r\nerr = 2;\r\ngoto out;\r\n}\r\nif (c->highest_inum >= INUM_WATERMARK) {\r\nerr = 3;\r\ngoto out;\r\n}\r\nif (c->lhead_lnum < UBIFS_LOG_LNUM ||\r\nc->lhead_lnum >= UBIFS_LOG_LNUM + c->log_lebs ||\r\nc->lhead_offs < 0 || c->lhead_offs >= c->leb_size ||\r\nc->lhead_offs & (c->min_io_size - 1)) {\r\nerr = 4;\r\ngoto out;\r\n}\r\nif (c->zroot.lnum >= c->leb_cnt || c->zroot.lnum < c->main_first ||\r\nc->zroot.offs >= c->leb_size || c->zroot.offs & 7) {\r\nerr = 5;\r\ngoto out;\r\n}\r\nif (c->zroot.len < c->ranges[UBIFS_IDX_NODE].min_len ||\r\nc->zroot.len > c->ranges[UBIFS_IDX_NODE].max_len) {\r\nerr = 6;\r\ngoto out;\r\n}\r\nif (c->gc_lnum >= c->leb_cnt || c->gc_lnum < c->main_first) {\r\nerr = 7;\r\ngoto out;\r\n}\r\nif (c->ihead_lnum >= c->leb_cnt || c->ihead_lnum < c->main_first ||\r\nc->ihead_offs % c->min_io_size || c->ihead_offs < 0 ||\r\nc->ihead_offs > c->leb_size || c->ihead_offs & 7) {\r\nerr = 8;\r\ngoto out;\r\n}\r\nmain_sz = (long long)c->main_lebs * c->leb_size;\r\nif (c->bi.old_idx_sz & 7 || c->bi.old_idx_sz >= main_sz) {\r\nerr = 9;\r\ngoto out;\r\n}\r\nif (c->lpt_lnum < c->lpt_first || c->lpt_lnum > c->lpt_last ||\r\nc->lpt_offs < 0 || c->lpt_offs + c->nnode_sz > c->leb_size) {\r\nerr = 10;\r\ngoto out;\r\n}\r\nif (c->nhead_lnum < c->lpt_first || c->nhead_lnum > c->lpt_last ||\r\nc->nhead_offs < 0 || c->nhead_offs % c->min_io_size ||\r\nc->nhead_offs > c->leb_size) {\r\nerr = 11;\r\ngoto out;\r\n}\r\nif (c->ltab_lnum < c->lpt_first || c->ltab_lnum > c->lpt_last ||\r\nc->ltab_offs < 0 ||\r\nc->ltab_offs + c->ltab_sz > c->leb_size) {\r\nerr = 12;\r\ngoto out;\r\n}\r\nif (c->big_lpt && (c->lsave_lnum < c->lpt_first ||\r\nc->lsave_lnum > c->lpt_last || c->lsave_offs < 0 ||\r\nc->lsave_offs + c->lsave_sz > c->leb_size)) {\r\nerr = 13;\r\ngoto out;\r\n}\r\nif (c->lscan_lnum < c->main_first || c->lscan_lnum >= c->leb_cnt) {\r\nerr = 14;\r\ngoto out;\r\n}\r\nif (c->lst.empty_lebs < 0 || c->lst.empty_lebs > c->main_lebs - 2) {\r\nerr = 15;\r\ngoto out;\r\n}\r\nif (c->lst.idx_lebs < 0 || c->lst.idx_lebs > c->main_lebs - 1) {\r\nerr = 16;\r\ngoto out;\r\n}\r\nif (c->lst.total_free < 0 || c->lst.total_free > main_sz ||\r\nc->lst.total_free & 7) {\r\nerr = 17;\r\ngoto out;\r\n}\r\nif (c->lst.total_dirty < 0 || (c->lst.total_dirty & 7)) {\r\nerr = 18;\r\ngoto out;\r\n}\r\nif (c->lst.total_used < 0 || (c->lst.total_used & 7)) {\r\nerr = 19;\r\ngoto out;\r\n}\r\nif (c->lst.total_free + c->lst.total_dirty +\r\nc->lst.total_used > main_sz) {\r\nerr = 20;\r\ngoto out;\r\n}\r\nif (c->lst.total_dead + c->lst.total_dark +\r\nc->lst.total_used + c->bi.old_idx_sz > main_sz) {\r\nerr = 21;\r\ngoto out;\r\n}\r\nif (c->lst.total_dead < 0 ||\r\nc->lst.total_dead > c->lst.total_free + c->lst.total_dirty ||\r\nc->lst.total_dead & 7) {\r\nerr = 22;\r\ngoto out;\r\n}\r\nif (c->lst.total_dark < 0 ||\r\nc->lst.total_dark > c->lst.total_free + c->lst.total_dirty ||\r\nc->lst.total_dark & 7) {\r\nerr = 23;\r\ngoto out;\r\n}\r\nreturn 0;\r\nout:\r\nubifs_err("bad master node at offset %d error %d", c->mst_offs, err);\r\nubifs_dump_node(c, c->mst_node);\r\nreturn -EINVAL;\r\n}\r\nint ubifs_read_master(struct ubifs_info *c)\r\n{\r\nint err, old_leb_cnt;\r\nc->mst_node = kzalloc(c->mst_node_alsz, GFP_KERNEL);\r\nif (!c->mst_node)\r\nreturn -ENOMEM;\r\nerr = scan_for_master(c);\r\nif (err) {\r\nif (err == -EUCLEAN)\r\nerr = ubifs_recover_master_node(c);\r\nif (err)\r\nreturn err;\r\n}\r\nc->mst_node->flags &= cpu_to_le32(~UBIFS_MST_RCVRY);\r\nc->max_sqnum = le64_to_cpu(c->mst_node->ch.sqnum);\r\nc->highest_inum = le64_to_cpu(c->mst_node->highest_inum);\r\nc->cmt_no = le64_to_cpu(c->mst_node->cmt_no);\r\nc->zroot.lnum = le32_to_cpu(c->mst_node->root_lnum);\r\nc->zroot.offs = le32_to_cpu(c->mst_node->root_offs);\r\nc->zroot.len = le32_to_cpu(c->mst_node->root_len);\r\nc->lhead_lnum = le32_to_cpu(c->mst_node->log_lnum);\r\nc->gc_lnum = le32_to_cpu(c->mst_node->gc_lnum);\r\nc->ihead_lnum = le32_to_cpu(c->mst_node->ihead_lnum);\r\nc->ihead_offs = le32_to_cpu(c->mst_node->ihead_offs);\r\nc->bi.old_idx_sz = le64_to_cpu(c->mst_node->index_size);\r\nc->lpt_lnum = le32_to_cpu(c->mst_node->lpt_lnum);\r\nc->lpt_offs = le32_to_cpu(c->mst_node->lpt_offs);\r\nc->nhead_lnum = le32_to_cpu(c->mst_node->nhead_lnum);\r\nc->nhead_offs = le32_to_cpu(c->mst_node->nhead_offs);\r\nc->ltab_lnum = le32_to_cpu(c->mst_node->ltab_lnum);\r\nc->ltab_offs = le32_to_cpu(c->mst_node->ltab_offs);\r\nc->lsave_lnum = le32_to_cpu(c->mst_node->lsave_lnum);\r\nc->lsave_offs = le32_to_cpu(c->mst_node->lsave_offs);\r\nc->lscan_lnum = le32_to_cpu(c->mst_node->lscan_lnum);\r\nc->lst.empty_lebs = le32_to_cpu(c->mst_node->empty_lebs);\r\nc->lst.idx_lebs = le32_to_cpu(c->mst_node->idx_lebs);\r\nold_leb_cnt = le32_to_cpu(c->mst_node->leb_cnt);\r\nc->lst.total_free = le64_to_cpu(c->mst_node->total_free);\r\nc->lst.total_dirty = le64_to_cpu(c->mst_node->total_dirty);\r\nc->lst.total_used = le64_to_cpu(c->mst_node->total_used);\r\nc->lst.total_dead = le64_to_cpu(c->mst_node->total_dead);\r\nc->lst.total_dark = le64_to_cpu(c->mst_node->total_dark);\r\nc->calc_idx_sz = c->bi.old_idx_sz;\r\nif (c->mst_node->flags & cpu_to_le32(UBIFS_MST_NO_ORPHS))\r\nc->no_orphs = 1;\r\nif (old_leb_cnt != c->leb_cnt) {\r\nint growth = c->leb_cnt - old_leb_cnt;\r\nif (c->leb_cnt < old_leb_cnt ||\r\nc->leb_cnt < UBIFS_MIN_LEB_CNT) {\r\nubifs_err("bad leb_cnt on master node");\r\nubifs_dump_node(c, c->mst_node);\r\nreturn -EINVAL;\r\n}\r\ndbg_mnt("Auto resizing (master) from %d LEBs to %d LEBs",\r\nold_leb_cnt, c->leb_cnt);\r\nc->lst.empty_lebs += growth;\r\nc->lst.total_free += growth * (long long)c->leb_size;\r\nc->lst.total_dark += growth * (long long)c->dark_wm;\r\nc->mst_node->leb_cnt = cpu_to_le32(c->leb_cnt);\r\nc->mst_node->empty_lebs = cpu_to_le32(c->lst.empty_lebs);\r\nc->mst_node->total_free = cpu_to_le64(c->lst.total_free);\r\nc->mst_node->total_dark = cpu_to_le64(c->lst.total_dark);\r\n}\r\nerr = validate_master(c);\r\nif (err)\r\nreturn err;\r\nerr = dbg_old_index_check_init(c, &c->zroot);\r\nreturn err;\r\n}\r\nint ubifs_write_master(struct ubifs_info *c)\r\n{\r\nint err, lnum, offs, len;\r\nubifs_assert(!c->ro_media && !c->ro_mount);\r\nif (c->ro_error)\r\nreturn -EROFS;\r\nlnum = UBIFS_MST_LNUM;\r\noffs = c->mst_offs + c->mst_node_alsz;\r\nlen = UBIFS_MST_NODE_SZ;\r\nif (offs + UBIFS_MST_NODE_SZ > c->leb_size) {\r\nerr = ubifs_leb_unmap(c, lnum);\r\nif (err)\r\nreturn err;\r\noffs = 0;\r\n}\r\nc->mst_offs = offs;\r\nc->mst_node->highest_inum = cpu_to_le64(c->highest_inum);\r\nerr = ubifs_write_node(c, c->mst_node, len, lnum, offs);\r\nif (err)\r\nreturn err;\r\nlnum += 1;\r\nif (offs == 0) {\r\nerr = ubifs_leb_unmap(c, lnum);\r\nif (err)\r\nreturn err;\r\n}\r\nerr = ubifs_write_node(c, c->mst_node, len, lnum, offs);\r\nreturn err;\r\n}

static int max8997_haptic_set_duty_cycle(struct max8997_haptic *chip)\r\n{\r\nint ret = 0;\r\nif (chip->mode == MAX8997_EXTERNAL_MODE) {\r\nunsigned int duty = chip->pwm_period * chip->level / 100;\r\nret = pwm_config(chip->pwm, duty, chip->pwm_period);\r\n} else {\r\nint i;\r\nu8 duty_index = 0;\r\nfor (i = 0; i <= 64; i++) {\r\nif (chip->level <= i * 100 / 64) {\r\nduty_index = i;\r\nbreak;\r\n}\r\n}\r\nswitch (chip->internal_mode_pattern) {\r\ncase 0:\r\nmax8997_write_reg(chip->client,\r\nMAX8997_HAPTIC_REG_SIGPWMDC1, duty_index);\r\nbreak;\r\ncase 1:\r\nmax8997_write_reg(chip->client,\r\nMAX8997_HAPTIC_REG_SIGPWMDC2, duty_index);\r\nbreak;\r\ncase 2:\r\nmax8997_write_reg(chip->client,\r\nMAX8997_HAPTIC_REG_SIGPWMDC3, duty_index);\r\nbreak;\r\ncase 3:\r\nmax8997_write_reg(chip->client,\r\nMAX8997_HAPTIC_REG_SIGPWMDC4, duty_index);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic void max8997_haptic_configure(struct max8997_haptic *chip)\r\n{\r\nu8 value;\r\nvalue = chip->type << MAX8997_MOTOR_TYPE_SHIFT |\r\nchip->enabled << MAX8997_ENABLE_SHIFT |\r\nchip->mode << MAX8997_MODE_SHIFT | chip->pwm_divisor;\r\nmax8997_write_reg(chip->client, MAX8997_HAPTIC_REG_CONF2, value);\r\nif (chip->mode == MAX8997_INTERNAL_MODE && chip->enabled) {\r\nvalue = chip->internal_mode_pattern << MAX8997_CYCLE_SHIFT |\r\nchip->internal_mode_pattern << MAX8997_SIG_PERIOD_SHIFT |\r\nchip->internal_mode_pattern << MAX8997_SIG_DUTY_SHIFT |\r\nchip->internal_mode_pattern << MAX8997_PWM_DUTY_SHIFT;\r\nmax8997_write_reg(chip->client,\r\nMAX8997_HAPTIC_REG_DRVCONF, value);\r\nswitch (chip->internal_mode_pattern) {\r\ncase 0:\r\nvalue = chip->pattern_cycle << 4;\r\nmax8997_write_reg(chip->client,\r\nMAX8997_HAPTIC_REG_CYCLECONF1, value);\r\nvalue = chip->pattern_signal_period;\r\nmax8997_write_reg(chip->client,\r\nMAX8997_HAPTIC_REG_SIGCONF1, value);\r\nbreak;\r\ncase 1:\r\nvalue = chip->pattern_cycle;\r\nmax8997_write_reg(chip->client,\r\nMAX8997_HAPTIC_REG_CYCLECONF1, value);\r\nvalue = chip->pattern_signal_period;\r\nmax8997_write_reg(chip->client,\r\nMAX8997_HAPTIC_REG_SIGCONF2, value);\r\nbreak;\r\ncase 2:\r\nvalue = chip->pattern_cycle << 4;\r\nmax8997_write_reg(chip->client,\r\nMAX8997_HAPTIC_REG_CYCLECONF2, value);\r\nvalue = chip->pattern_signal_period;\r\nmax8997_write_reg(chip->client,\r\nMAX8997_HAPTIC_REG_SIGCONF3, value);\r\nbreak;\r\ncase 3:\r\nvalue = chip->pattern_cycle;\r\nmax8997_write_reg(chip->client,\r\nMAX8997_HAPTIC_REG_CYCLECONF2, value);\r\nvalue = chip->pattern_signal_period;\r\nmax8997_write_reg(chip->client,\r\nMAX8997_HAPTIC_REG_SIGCONF4, value);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void max8997_haptic_enable(struct max8997_haptic *chip)\r\n{\r\nint error;\r\nmutex_lock(&chip->mutex);\r\nerror = max8997_haptic_set_duty_cycle(chip);\r\nif (error) {\r\ndev_err(chip->dev, "set_pwm_cycle failed, error: %d\n", error);\r\ngoto out;\r\n}\r\nif (!chip->enabled) {\r\nchip->enabled = true;\r\nregulator_enable(chip->regulator);\r\nmax8997_haptic_configure(chip);\r\nif (chip->mode == MAX8997_EXTERNAL_MODE)\r\npwm_enable(chip->pwm);\r\n}\r\nout:\r\nmutex_unlock(&chip->mutex);\r\n}\r\nstatic void max8997_haptic_disable(struct max8997_haptic *chip)\r\n{\r\nmutex_lock(&chip->mutex);\r\nif (chip->enabled) {\r\nchip->enabled = false;\r\nmax8997_haptic_configure(chip);\r\nif (chip->mode == MAX8997_EXTERNAL_MODE)\r\npwm_disable(chip->pwm);\r\nregulator_disable(chip->regulator);\r\n}\r\nmutex_unlock(&chip->mutex);\r\n}\r\nstatic void max8997_haptic_play_effect_work(struct work_struct *work)\r\n{\r\nstruct max8997_haptic *chip =\r\ncontainer_of(work, struct max8997_haptic, work);\r\nif (chip->level)\r\nmax8997_haptic_enable(chip);\r\nelse\r\nmax8997_haptic_disable(chip);\r\n}\r\nstatic int max8997_haptic_play_effect(struct input_dev *dev, void *data,\r\nstruct ff_effect *effect)\r\n{\r\nstruct max8997_haptic *chip = input_get_drvdata(dev);\r\nchip->level = effect->u.rumble.strong_magnitude;\r\nif (!chip->level)\r\nchip->level = effect->u.rumble.weak_magnitude;\r\nschedule_work(&chip->work);\r\nreturn 0;\r\n}\r\nstatic void max8997_haptic_close(struct input_dev *dev)\r\n{\r\nstruct max8997_haptic *chip = input_get_drvdata(dev);\r\ncancel_work_sync(&chip->work);\r\nmax8997_haptic_disable(chip);\r\n}\r\nstatic int max8997_haptic_probe(struct platform_device *pdev)\r\n{\r\nstruct max8997_dev *iodev = dev_get_drvdata(pdev->dev.parent);\r\nconst struct max8997_platform_data *pdata =\r\ndev_get_platdata(iodev->dev);\r\nconst struct max8997_haptic_platform_data *haptic_pdata =\r\npdata->haptic_pdata;\r\nstruct max8997_haptic *chip;\r\nstruct input_dev *input_dev;\r\nint error;\r\nif (!haptic_pdata) {\r\ndev_err(&pdev->dev, "no haptic platform data\n");\r\nreturn -EINVAL;\r\n}\r\nchip = kzalloc(sizeof(struct max8997_haptic), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!chip || !input_dev) {\r\ndev_err(&pdev->dev, "unable to allocate memory\n");\r\nerror = -ENOMEM;\r\ngoto err_free_mem;\r\n}\r\nINIT_WORK(&chip->work, max8997_haptic_play_effect_work);\r\nmutex_init(&chip->mutex);\r\nchip->client = iodev->haptic;\r\nchip->dev = &pdev->dev;\r\nchip->input_dev = input_dev;\r\nchip->pwm_period = haptic_pdata->pwm_period;\r\nchip->type = haptic_pdata->type;\r\nchip->mode = haptic_pdata->mode;\r\nchip->pwm_divisor = haptic_pdata->pwm_divisor;\r\nswitch (chip->mode) {\r\ncase MAX8997_INTERNAL_MODE:\r\nchip->internal_mode_pattern =\r\nhaptic_pdata->internal_mode_pattern;\r\nchip->pattern_cycle = haptic_pdata->pattern_cycle;\r\nchip->pattern_signal_period =\r\nhaptic_pdata->pattern_signal_period;\r\nbreak;\r\ncase MAX8997_EXTERNAL_MODE:\r\nchip->pwm = pwm_request(haptic_pdata->pwm_channel_id,\r\n"max8997-haptic");\r\nif (IS_ERR(chip->pwm)) {\r\nerror = PTR_ERR(chip->pwm);\r\ndev_err(&pdev->dev,\r\n"unable to request PWM for haptic, error: %d\n",\r\nerror);\r\ngoto err_free_mem;\r\n}\r\nbreak;\r\ndefault:\r\ndev_err(&pdev->dev,\r\n"Invalid chip mode specified (%d)\n", chip->mode);\r\nerror = -EINVAL;\r\ngoto err_free_mem;\r\n}\r\nchip->regulator = regulator_get(&pdev->dev, "inmotor");\r\nif (IS_ERR(chip->regulator)) {\r\nerror = PTR_ERR(chip->regulator);\r\ndev_err(&pdev->dev,\r\n"unable to get regulator, error: %d\n",\r\nerror);\r\ngoto err_free_pwm;\r\n}\r\ninput_dev->name = "max8997-haptic";\r\ninput_dev->id.version = 1;\r\ninput_dev->dev.parent = &pdev->dev;\r\ninput_dev->close = max8997_haptic_close;\r\ninput_set_drvdata(input_dev, chip);\r\ninput_set_capability(input_dev, EV_FF, FF_RUMBLE);\r\nerror = input_ff_create_memless(input_dev, NULL,\r\nmax8997_haptic_play_effect);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"unable to create FF device, error: %d\n",\r\nerror);\r\ngoto err_put_regulator;\r\n}\r\nerror = input_register_device(input_dev);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"unable to register input device, error: %d\n",\r\nerror);\r\ngoto err_destroy_ff;\r\n}\r\nplatform_set_drvdata(pdev, chip);\r\nreturn 0;\r\nerr_destroy_ff:\r\ninput_ff_destroy(input_dev);\r\nerr_put_regulator:\r\nregulator_put(chip->regulator);\r\nerr_free_pwm:\r\nif (chip->mode == MAX8997_EXTERNAL_MODE)\r\npwm_free(chip->pwm);\r\nerr_free_mem:\r\ninput_free_device(input_dev);\r\nkfree(chip);\r\nreturn error;\r\n}\r\nstatic int max8997_haptic_remove(struct platform_device *pdev)\r\n{\r\nstruct max8997_haptic *chip = platform_get_drvdata(pdev);\r\ninput_unregister_device(chip->input_dev);\r\nregulator_put(chip->regulator);\r\nif (chip->mode == MAX8997_EXTERNAL_MODE)\r\npwm_free(chip->pwm);\r\nkfree(chip);\r\nreturn 0;\r\n}\r\nstatic int max8997_haptic_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct max8997_haptic *chip = platform_get_drvdata(pdev);\r\nmax8997_haptic_disable(chip);\r\nreturn 0;\r\n}

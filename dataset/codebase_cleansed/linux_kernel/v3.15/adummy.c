static ssize_t __set_signal(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct atm_dev *atm_dev = container_of(dev, struct atm_dev, class_dev);\r\nint signal;\r\nif (sscanf(buf, "%d", &signal) == 1) {\r\nif (signal < ATM_PHY_SIG_LOST || signal > ATM_PHY_SIG_FOUND)\r\nsignal = ATM_PHY_SIG_UNKNOWN;\r\natm_dev_signal_change(atm_dev, signal);\r\nreturn 1;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic ssize_t __show_signal(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct atm_dev *atm_dev = container_of(dev, struct atm_dev, class_dev);\r\nreturn sprintf(buf, "%d\n", atm_dev->signal);\r\n}\r\nstatic int __init\r\nadummy_start(struct atm_dev *dev)\r\n{\r\ndev->ci_range.vpi_bits = 4;\r\ndev->ci_range.vci_bits = 12;\r\nreturn 0;\r\n}\r\nstatic int\r\nadummy_open(struct atm_vcc *vcc)\r\n{\r\nshort vpi = vcc->vpi;\r\nint vci = vcc->vci;\r\nif (vci == ATM_VCI_UNSPEC || vpi == ATM_VPI_UNSPEC)\r\nreturn 0;\r\nset_bit(ATM_VF_ADDR, &vcc->flags);\r\nset_bit(ATM_VF_READY, &vcc->flags);\r\nreturn 0;\r\n}\r\nstatic void\r\nadummy_close(struct atm_vcc *vcc)\r\n{\r\nclear_bit(ATM_VF_READY, &vcc->flags);\r\nclear_bit(ATM_VF_ADDR, &vcc->flags);\r\n}\r\nstatic int\r\nadummy_send(struct atm_vcc *vcc, struct sk_buff *skb)\r\n{\r\nif (vcc->pop)\r\nvcc->pop(vcc, skb);\r\nelse\r\ndev_kfree_skb_any(skb);\r\natomic_inc(&vcc->stats->tx);\r\nreturn 0;\r\n}\r\nstatic int\r\nadummy_proc_read(struct atm_dev *dev, loff_t *pos, char *page)\r\n{\r\nint left = *pos;\r\nif (!left--)\r\nreturn sprintf(page, "version %s\n", DRV_VERSION);\r\nreturn 0;\r\n}\r\nstatic int __init adummy_init(void)\r\n{\r\nstruct atm_dev *atm_dev;\r\nstruct adummy_dev *adummy_dev;\r\nint err = 0;\r\nprintk(KERN_ERR "adummy: version %s\n", DRV_VERSION);\r\nadummy_dev = kzalloc(sizeof(struct adummy_dev),\r\nGFP_KERNEL);\r\nif (!adummy_dev) {\r\nprintk(KERN_ERR DEV_LABEL ": kzalloc() failed\n");\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\natm_dev = atm_dev_register(DEV_LABEL, NULL, &adummy_ops, -1, NULL);\r\nif (!atm_dev) {\r\nprintk(KERN_ERR DEV_LABEL ": atm_dev_register() failed\n");\r\nerr = -ENODEV;\r\ngoto out_kfree;\r\n}\r\nadummy_dev->atm_dev = atm_dev;\r\natm_dev->dev_data = adummy_dev;\r\nif (sysfs_create_group(&atm_dev->class_dev.kobj, &adummy_group_attrs))\r\ndev_err(&atm_dev->class_dev, "Could not register attrs for adummy\n");\r\nif (adummy_start(atm_dev)) {\r\nprintk(KERN_ERR DEV_LABEL ": adummy_start() failed\n");\r\nerr = -ENODEV;\r\ngoto out_unregister;\r\n}\r\nlist_add(&adummy_dev->entry, &adummy_devs);\r\nout:\r\nreturn err;\r\nout_unregister:\r\natm_dev_deregister(atm_dev);\r\nout_kfree:\r\nkfree(adummy_dev);\r\ngoto out;\r\n}\r\nstatic void __exit adummy_cleanup(void)\r\n{\r\nstruct adummy_dev *adummy_dev, *next;\r\nlist_for_each_entry_safe(adummy_dev, next, &adummy_devs, entry) {\r\natm_dev_deregister(adummy_dev->atm_dev);\r\nkfree(adummy_dev);\r\n}\r\n}

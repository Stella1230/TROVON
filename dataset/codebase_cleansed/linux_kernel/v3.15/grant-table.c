static int map_pte_fn(pte_t *pte, struct page *pmd_page,\r\nunsigned long addr, void *data)\r\n{\r\nunsigned long **frames = (unsigned long **)data;\r\nset_pte_at(&init_mm, addr, pte, mfn_pte((*frames)[0], PAGE_KERNEL));\r\n(*frames)++;\r\nreturn 0;\r\n}\r\nstatic int map_pte_fn_status(pte_t *pte, struct page *pmd_page,\r\nunsigned long addr, void *data)\r\n{\r\nuint64_t **frames = (uint64_t **)data;\r\nset_pte_at(&init_mm, addr, pte, mfn_pte((*frames)[0], PAGE_KERNEL));\r\n(*frames)++;\r\nreturn 0;\r\n}\r\nstatic int unmap_pte_fn(pte_t *pte, struct page *pmd_page,\r\nunsigned long addr, void *data)\r\n{\r\nset_pte_at(&init_mm, addr, pte, __pte(0));\r\nreturn 0;\r\n}\r\nint arch_gnttab_map_shared(unsigned long *frames, unsigned long nr_gframes,\r\nunsigned long max_nr_gframes,\r\nvoid **__shared)\r\n{\r\nint rc;\r\nvoid *shared = *__shared;\r\nif (shared == NULL) {\r\nstruct vm_struct *area =\r\nalloc_vm_area(PAGE_SIZE * max_nr_gframes, NULL);\r\nBUG_ON(area == NULL);\r\nshared = area->addr;\r\n*__shared = shared;\r\n}\r\nrc = apply_to_page_range(&init_mm, (unsigned long)shared,\r\nPAGE_SIZE * nr_gframes,\r\nmap_pte_fn, &frames);\r\nreturn rc;\r\n}\r\nint arch_gnttab_map_status(uint64_t *frames, unsigned long nr_gframes,\r\nunsigned long max_nr_gframes,\r\ngrant_status_t **__shared)\r\n{\r\nint rc;\r\ngrant_status_t *shared = *__shared;\r\nif (shared == NULL) {\r\nstruct vm_struct *area =\r\nalloc_vm_area(PAGE_SIZE * max_nr_gframes, NULL);\r\nBUG_ON(area == NULL);\r\nshared = area->addr;\r\n*__shared = shared;\r\n}\r\nrc = apply_to_page_range(&init_mm, (unsigned long)shared,\r\nPAGE_SIZE * nr_gframes,\r\nmap_pte_fn_status, &frames);\r\nreturn rc;\r\n}\r\nvoid arch_gnttab_unmap(void *shared, unsigned long nr_gframes)\r\n{\r\napply_to_page_range(&init_mm, (unsigned long)shared,\r\nPAGE_SIZE * nr_gframes, unmap_pte_fn, NULL);\r\n}\r\nstatic int __init xlated_setup_gnttab_pages(void)\r\n{\r\nstruct page **pages;\r\nxen_pfn_t *pfns;\r\nint rc;\r\nunsigned int i;\r\nunsigned long nr_grant_frames = gnttab_max_grant_frames();\r\nBUG_ON(nr_grant_frames == 0);\r\npages = kcalloc(nr_grant_frames, sizeof(pages[0]), GFP_KERNEL);\r\nif (!pages)\r\nreturn -ENOMEM;\r\npfns = kcalloc(nr_grant_frames, sizeof(pfns[0]), GFP_KERNEL);\r\nif (!pfns) {\r\nkfree(pages);\r\nreturn -ENOMEM;\r\n}\r\nrc = alloc_xenballooned_pages(nr_grant_frames, pages, 0 );\r\nif (rc) {\r\npr_warn("%s Couldn't balloon alloc %ld pfns rc:%d\n", __func__,\r\nnr_grant_frames, rc);\r\nkfree(pages);\r\nkfree(pfns);\r\nreturn rc;\r\n}\r\nfor (i = 0; i < nr_grant_frames; i++)\r\npfns[i] = page_to_pfn(pages[i]);\r\nrc = arch_gnttab_map_shared(pfns, nr_grant_frames, nr_grant_frames,\r\n&xen_auto_xlat_grant_frames.vaddr);\r\nif (rc) {\r\npr_warn("%s Couldn't map %ld pfns rc:%d\n", __func__,\r\nnr_grant_frames, rc);\r\nfree_xenballooned_pages(nr_grant_frames, pages);\r\nkfree(pages);\r\nkfree(pfns);\r\nreturn rc;\r\n}\r\nkfree(pages);\r\nxen_auto_xlat_grant_frames.pfn = pfns;\r\nxen_auto_xlat_grant_frames.count = nr_grant_frames;\r\nreturn 0;\r\n}\r\nstatic int __init xen_pvh_gnttab_setup(void)\r\n{\r\nif (!xen_pvh_domain())\r\nreturn -ENODEV;\r\nreturn xlated_setup_gnttab_pages();\r\n}

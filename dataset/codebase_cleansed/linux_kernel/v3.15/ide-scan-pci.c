int __ide_pci_register_driver(struct pci_driver *driver, struct module *module,\r\nconst char *mod_name)\r\n{\r\nif (!pre_init)\r\nreturn __pci_register_driver(driver, module, mod_name);\r\ndriver->driver.owner = module;\r\nlist_add_tail(&driver->node, &ide_pci_drivers);\r\nreturn 0;\r\n}\r\nstatic int __init ide_scan_pcidev(struct pci_dev *dev)\r\n{\r\nstruct list_head *l;\r\nstruct pci_driver *d;\r\nlist_for_each(l, &ide_pci_drivers) {\r\nd = list_entry(l, struct pci_driver, node);\r\nif (d->id_table) {\r\nconst struct pci_device_id *id =\r\npci_match_id(d->id_table, dev);\r\nif (id != NULL && d->probe(dev, id) >= 0) {\r\ndev->driver = d;\r\npci_dev_get(dev);\r\nreturn 1;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init ide_scan_pcibus(void)\r\n{\r\nstruct pci_dev *dev = NULL;\r\nstruct pci_driver *d;\r\nstruct list_head *l, *n;\r\npre_init = 0;\r\nfor_each_pci_dev(dev)\r\nide_scan_pcidev(dev);\r\nlist_for_each_safe(l, n, &ide_pci_drivers) {\r\nlist_del(l);\r\nd = list_entry(l, struct pci_driver, node);\r\nif (__pci_register_driver(d, d->driver.owner,\r\nd->driver.mod_name))\r\nprintk(KERN_ERR "%s: failed to register %s driver\n",\r\n__func__, d->driver.mod_name);\r\n}\r\nreturn 0;\r\n}

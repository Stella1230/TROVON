u64 perf_time_to_tsc(u64 ns, struct perf_tsc_conversion *tc)\r\n{\r\nu64 t, quot, rem;\r\nt = ns - tc->time_zero;\r\nquot = t / tc->time_mult;\r\nrem = t % tc->time_mult;\r\nreturn (quot << tc->time_shift) +\r\n(rem << tc->time_shift) / tc->time_mult;\r\n}\r\nu64 tsc_to_perf_time(u64 cyc, struct perf_tsc_conversion *tc)\r\n{\r\nu64 quot, rem;\r\nquot = cyc >> tc->time_shift;\r\nrem = cyc & ((1 << tc->time_shift) - 1);\r\nreturn tc->time_zero + quot * tc->time_mult +\r\n((rem * tc->time_mult) >> tc->time_shift);\r\n}\r\nint perf_read_tsc_conversion(const struct perf_event_mmap_page *pc,\r\nstruct perf_tsc_conversion *tc)\r\n{\r\nbool cap_user_time_zero;\r\nu32 seq;\r\nint i = 0;\r\nwhile (1) {\r\nseq = pc->lock;\r\nrmb();\r\ntc->time_mult = pc->time_mult;\r\ntc->time_shift = pc->time_shift;\r\ntc->time_zero = pc->time_zero;\r\ncap_user_time_zero = pc->cap_user_time_zero;\r\nrmb();\r\nif (pc->lock == seq && !(seq & 1))\r\nbreak;\r\nif (++i > 10000) {\r\npr_debug("failed to get perf_event_mmap_page lock\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (!cap_user_time_zero)\r\nreturn -EOPNOTSUPP;\r\nreturn 0;\r\n}

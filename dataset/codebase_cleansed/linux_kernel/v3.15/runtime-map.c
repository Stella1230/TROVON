static inline struct map_attribute *to_map_attr(struct attribute *attr)\r\n{\r\nreturn container_of(attr, struct map_attribute, attr);\r\n}\r\nstatic ssize_t type_show(struct efi_runtime_map_entry *entry, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "0x%x\n", entry->md.type);\r\n}\r\nstatic inline struct efi_runtime_map_entry *to_map_entry(struct kobject *kobj)\r\n{\r\nreturn container_of(kobj, struct efi_runtime_map_entry, kobj);\r\n}\r\nstatic ssize_t map_attr_show(struct kobject *kobj, struct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct efi_runtime_map_entry *entry = to_map_entry(kobj);\r\nstruct map_attribute *map_attr = to_map_attr(attr);\r\nreturn map_attr->show(entry, buf);\r\n}\r\nstatic void map_release(struct kobject *kobj)\r\n{\r\nstruct efi_runtime_map_entry *entry;\r\nentry = to_map_entry(kobj);\r\nkfree(entry);\r\n}\r\nstatic struct efi_runtime_map_entry *\r\nadd_sysfs_runtime_map_entry(struct kobject *kobj, int nr)\r\n{\r\nint ret;\r\nstruct efi_runtime_map_entry *entry;\r\nif (!map_kset) {\r\nmap_kset = kset_create_and_add("runtime-map", NULL, kobj);\r\nif (!map_kset)\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nentry = kzalloc(sizeof(*entry), GFP_KERNEL);\r\nif (!entry) {\r\nkset_unregister(map_kset);\r\nreturn entry;\r\n}\r\nmemcpy(&entry->md, efi_runtime_map + nr * efi_memdesc_size,\r\nsizeof(efi_memory_desc_t));\r\nkobject_init(&entry->kobj, &map_ktype);\r\nentry->kobj.kset = map_kset;\r\nret = kobject_add(&entry->kobj, NULL, "%d", nr);\r\nif (ret) {\r\nkobject_put(&entry->kobj);\r\nkset_unregister(map_kset);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn entry;\r\n}\r\nvoid efi_runtime_map_setup(void *map, int nr_entries, u32 desc_size)\r\n{\r\nefi_runtime_map = map;\r\nnr_efi_runtime_map = nr_entries;\r\nefi_memdesc_size = desc_size;\r\n}\r\nint __init efi_runtime_map_init(struct kobject *efi_kobj)\r\n{\r\nint i, j, ret = 0;\r\nstruct efi_runtime_map_entry *entry;\r\nif (!efi_runtime_map)\r\nreturn 0;\r\nmap_entries = kzalloc(nr_efi_runtime_map * sizeof(entry), GFP_KERNEL);\r\nif (!map_entries) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nfor (i = 0; i < nr_efi_runtime_map; i++) {\r\nentry = add_sysfs_runtime_map_entry(efi_kobj, i);\r\nif (IS_ERR(entry)) {\r\nret = PTR_ERR(entry);\r\ngoto out_add_entry;\r\n}\r\n*(map_entries + i) = entry;\r\n}\r\nreturn 0;\r\nout_add_entry:\r\nfor (j = i - 1; j > 0; j--) {\r\nentry = *(map_entries + j);\r\nkobject_put(&entry->kobj);\r\n}\r\nif (map_kset)\r\nkset_unregister(map_kset);\r\nout:\r\nreturn ret;\r\n}

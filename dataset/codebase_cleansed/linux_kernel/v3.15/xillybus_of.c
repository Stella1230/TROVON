static void xilly_dma_sync_single_for_cpu_of(struct xilly_endpoint *ep,\r\ndma_addr_t dma_handle,\r\nsize_t size,\r\nint direction)\r\n{\r\ndma_sync_single_for_cpu(ep->dev, dma_handle, size, direction);\r\n}\r\nstatic void xilly_dma_sync_single_for_device_of(struct xilly_endpoint *ep,\r\ndma_addr_t dma_handle,\r\nsize_t size,\r\nint direction)\r\n{\r\ndma_sync_single_for_device(ep->dev, dma_handle, size, direction);\r\n}\r\nstatic void xilly_dma_sync_single_nop(struct xilly_endpoint *ep,\r\ndma_addr_t dma_handle,\r\nsize_t size,\r\nint direction)\r\n{\r\n}\r\nstatic dma_addr_t xilly_map_single_of(struct xilly_cleanup *mem,\r\nstruct xilly_endpoint *ep,\r\nvoid *ptr,\r\nsize_t size,\r\nint direction\r\n)\r\n{\r\ndma_addr_t addr = 0;\r\nstruct xilly_dma *this;\r\nthis = kmalloc(sizeof(struct xilly_dma), GFP_KERNEL);\r\nif (!this)\r\nreturn 0;\r\naddr = dma_map_single(ep->dev, ptr, size, direction);\r\nthis->direction = direction;\r\nif (dma_mapping_error(ep->dev, addr)) {\r\nkfree(this);\r\nreturn 0;\r\n}\r\nthis->dma_addr = addr;\r\nthis->dev = ep->dev;\r\nthis->size = size;\r\nlist_add_tail(&this->node, &mem->to_unmap);\r\nreturn addr;\r\n}\r\nstatic void xilly_unmap_single_of(struct xilly_dma *entry)\r\n{\r\ndma_unmap_single(entry->dev,\r\nentry->dma_addr,\r\nentry->size,\r\nentry->direction);\r\n}\r\nstatic int xilly_drv_probe(struct platform_device *op)\r\n{\r\nstruct device *dev = &op->dev;\r\nstruct xilly_endpoint *endpoint;\r\nint rc = 0;\r\nint irq;\r\nstruct xilly_endpoint_hardware *ephw = &of_hw;\r\nif (of_property_read_bool(dev->of_node, "dma-coherent"))\r\nephw = &of_hw_coherent;\r\nendpoint = xillybus_init_endpoint(NULL, dev, ephw);\r\nif (!endpoint)\r\nreturn -ENOMEM;\r\ndev_set_drvdata(dev, endpoint);\r\nrc = of_address_to_resource(dev->of_node, 0, &endpoint->res);\r\nif (rc) {\r\ndev_warn(endpoint->dev,\r\n"Failed to obtain device tree resource\n");\r\ngoto failed_request_regions;\r\n}\r\nif (!request_mem_region(endpoint->res.start,\r\nresource_size(&endpoint->res), xillyname)) {\r\ndev_err(endpoint->dev,\r\n"request_mem_region failed. Aborting.\n");\r\nrc = -EBUSY;\r\ngoto failed_request_regions;\r\n}\r\nendpoint->registers = of_iomap(dev->of_node, 0);\r\nif (!endpoint->registers) {\r\ndev_err(endpoint->dev,\r\n"Failed to map I/O memory. Aborting.\n");\r\nrc = -EIO;\r\ngoto failed_iomap0;\r\n}\r\nirq = irq_of_parse_and_map(dev->of_node, 0);\r\nrc = request_irq(irq, xillybus_isr, 0, xillyname, endpoint);\r\nif (rc) {\r\ndev_err(endpoint->dev,\r\n"Failed to register IRQ handler. Aborting.\n");\r\nrc = -ENODEV;\r\ngoto failed_register_irq;\r\n}\r\nrc = xillybus_endpoint_discovery(endpoint);\r\nif (!rc)\r\nreturn 0;\r\nfree_irq(irq, endpoint);\r\nfailed_register_irq:\r\niounmap(endpoint->registers);\r\nfailed_iomap0:\r\nrelease_mem_region(endpoint->res.start,\r\nresource_size(&endpoint->res));\r\nfailed_request_regions:\r\nxillybus_do_cleanup(&endpoint->cleanup, endpoint);\r\nkfree(endpoint);\r\nreturn rc;\r\n}\r\nstatic int xilly_drv_remove(struct platform_device *op)\r\n{\r\nstruct device *dev = &op->dev;\r\nstruct xilly_endpoint *endpoint = dev_get_drvdata(dev);\r\nint irq = irq_of_parse_and_map(dev->of_node, 0);\r\nxillybus_endpoint_remove(endpoint);\r\nfree_irq(irq, endpoint);\r\niounmap(endpoint->registers);\r\nrelease_mem_region(endpoint->res.start,\r\nresource_size(&endpoint->res));\r\nxillybus_do_cleanup(&endpoint->cleanup, endpoint);\r\nkfree(endpoint);\r\nreturn 0;\r\n}

static void write_max2820(struct ieee80211_hw *dev, u8 addr, u32 data)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nu32 phy_config;\r\nphy_config = 0x90 + (data & 0xf);\r\nphy_config <<= 16;\r\nphy_config += addr;\r\nphy_config <<= 8;\r\nphy_config += (data >> 4) & 0xff;\r\nrtl818x_iowrite32(priv,\r\n(__le32 __iomem *) &priv->map->RFPinsOutput, phy_config);\r\nmsleep(1);\r\n}\r\nstatic void max2820_write_phy_antenna(struct ieee80211_hw *dev, short chan)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nu8 ant;\r\nant = MAXIM_ANTENNA;\r\nif (priv->rfparam & RF_PARAM_ANTBDEFAULT)\r\nant |= BB_ANTENNA_B;\r\nif (chan == 14)\r\nant |= BB_ANTATTEN_CHAN14;\r\nrtl8180_write_phy(dev, 0x10, ant);\r\n}\r\nstatic u8 max2820_rf_calc_rssi(u8 agc, u8 sq)\r\n{\r\nbool odd;\r\nodd = !!(agc & 1);\r\nagc >>= 1;\r\nif (odd)\r\nagc += 76;\r\nelse\r\nagc += 66;\r\nreturn 65 * agc / 100;\r\n}\r\nstatic void max2820_rf_set_channel(struct ieee80211_hw *dev,\r\nstruct ieee80211_conf *conf)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nint channel = conf ?\r\nieee80211_frequency_to_channel(conf->chandef.chan->center_freq) : 1;\r\nunsigned int chan_idx = channel - 1;\r\nu32 txpw = priv->channels[chan_idx].hw_value & 0xFF;\r\nu32 chan = max2820_chan[chan_idx];\r\nrtl8180_write_phy(dev, 3, txpw);\r\nmax2820_write_phy_antenna(dev, channel);\r\nwrite_max2820(dev, 3, chan);\r\n}\r\nstatic void max2820_rf_stop(struct ieee80211_hw *dev)\r\n{\r\nrtl8180_write_phy(dev, 3, 0x8);\r\nwrite_max2820(dev, 1, 0);\r\n}\r\nstatic void max2820_rf_init(struct ieee80211_hw *dev)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nwrite_max2820(dev, 0, 0x007);\r\nwrite_max2820(dev, 1, 0x01e);\r\nwrite_max2820(dev, 2, 0x001);\r\nmax2820_rf_set_channel(dev, NULL);\r\nwrite_max2820(dev, 4, 0x313);\r\nwrite_max2820(dev, 5, 0x00f);\r\nrtl8180_write_phy(dev, 0, 0x88);\r\nrtl8180_write_phy(dev, 3, 0x08);\r\nrtl8180_write_phy(dev, 4, 0xf8);\r\nrtl8180_write_phy(dev, 5, 0x90);\r\nrtl8180_write_phy(dev, 6, 0x1a);\r\nrtl8180_write_phy(dev, 7, 0x64);\r\nmax2820_write_phy_antenna(dev, 1);\r\nrtl8180_write_phy(dev, 0x11, 0x88);\r\nif (rtl818x_ioread8(priv, &priv->map->CONFIG2) &\r\nRTL818X_CONFIG2_ANTENNA_DIV)\r\nrtl8180_write_phy(dev, 0x12, 0xc7);\r\nelse\r\nrtl8180_write_phy(dev, 0x12, 0x47);\r\nrtl8180_write_phy(dev, 0x13, 0x9b);\r\nrtl8180_write_phy(dev, 0x19, 0x0);\r\nrtl8180_write_phy(dev, 0x1a, 0x9f);\r\nmax2820_rf_set_channel(dev, NULL);\r\n}

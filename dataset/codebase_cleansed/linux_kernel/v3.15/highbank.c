static void __init highbank_scu_map_io(void)\r\n{\r\nunsigned long base;\r\nasm("mrc p15, 4, %0, c15, c0, 0" : "=r" (base));\r\nscu_base_addr = ioremap(base, SZ_4K);\r\n}\r\nstatic void highbank_l2x0_disable(void)\r\n{\r\nouter_flush_all();\r\nhighbank_smc1(0x102, 0x0);\r\n}\r\nstatic void __init highbank_init_irq(void)\r\n{\r\nirqchip_init();\r\nif (of_find_compatible_node(NULL, NULL, "arm,cortex-a9"))\r\nhighbank_scu_map_io();\r\nif (IS_ENABLED(CONFIG_CACHE_L2X0) &&\r\nof_find_compatible_node(NULL, NULL, "arm,pl310-cache")) {\r\nhighbank_smc1(0x102, 0x1);\r\nl2x0_of_init(0, ~0UL);\r\nouter_cache.disable = highbank_l2x0_disable;\r\n}\r\n}\r\nstatic void highbank_power_off(void)\r\n{\r\nhighbank_set_pwr_shutdown();\r\nwhile (1)\r\ncpu_do_idle();\r\n}\r\nstatic int highbank_platform_notifier(struct notifier_block *nb,\r\nunsigned long event, void *__dev)\r\n{\r\nstruct resource *res;\r\nint reg = -1;\r\nu32 val;\r\nstruct device *dev = __dev;\r\nif (event != BUS_NOTIFY_ADD_DEVICE)\r\nreturn NOTIFY_DONE;\r\nif (of_device_is_compatible(dev->of_node, "calxeda,hb-ahci"))\r\nreg = 0xc;\r\nelse if (of_device_is_compatible(dev->of_node, "calxeda,hb-sdhci"))\r\nreg = 0x18;\r\nelse if (of_device_is_compatible(dev->of_node, "arm,pl330"))\r\nreg = 0x20;\r\nelse if (of_device_is_compatible(dev->of_node, "calxeda,hb-xgmac")) {\r\nres = platform_get_resource(to_platform_device(dev),\r\nIORESOURCE_MEM, 0);\r\nif (res) {\r\nif (res->start == 0xfff50000)\r\nreg = 0;\r\nelse if (res->start == 0xfff51000)\r\nreg = 4;\r\n}\r\n}\r\nif (reg < 0)\r\nreturn NOTIFY_DONE;\r\nif (of_property_read_bool(dev->of_node, "dma-coherent")) {\r\nval = readl(sregs_base + reg);\r\nwritel(val | 0xff01, sregs_base + reg);\r\nset_dma_ops(dev, &arm_coherent_dma_ops);\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int hb_keys_notifier(struct notifier_block *nb, unsigned long event, void *data)\r\n{\r\nu32 key = *(u32 *)data;\r\nif (event != 0x1000)\r\nreturn 0;\r\nif (key == KEY_POWER)\r\norderly_poweroff(false);\r\nelse if (key == 0xffff)\r\nctrl_alt_del();\r\nreturn 0;\r\n}\r\nstatic void __init highbank_init(void)\r\n{\r\nstruct device_node *np;\r\nnp = of_find_compatible_node(NULL, NULL, "calxeda,hb-sregs");\r\nsregs_base = of_iomap(np, 0);\r\nWARN_ON(!sregs_base);\r\npm_power_off = highbank_power_off;\r\nhighbank_pm_init();\r\nbus_register_notifier(&platform_bus_type, &highbank_platform_nb);\r\nbus_register_notifier(&amba_bustype, &highbank_amba_nb);\r\npl320_ipc_register_notifier(&hb_keys_nb);\r\nof_platform_populate(NULL, of_default_bus_match_table, NULL, NULL);\r\nif (psci_ops.cpu_suspend)\r\nplatform_device_register(&highbank_cpuidle_device);\r\n}

int setup_fault_attr(struct fault_attr *attr, char *str)\r\n{\r\nunsigned long probability;\r\nunsigned long interval;\r\nint times;\r\nint space;\r\nif (sscanf(str, "%lu,%lu,%d,%d",\r\n&interval, &probability, &space, &times) < 4) {\r\nprintk(KERN_WARNING\r\n"FAULT_INJECTION: failed to parse arguments\n");\r\nreturn 0;\r\n}\r\nattr->probability = probability;\r\nattr->interval = interval;\r\natomic_set(&attr->times, times);\r\natomic_set(&attr->space, space);\r\nreturn 1;\r\n}\r\nstatic void fail_dump(struct fault_attr *attr)\r\n{\r\nif (attr->verbose > 0)\r\nprintk(KERN_NOTICE "FAULT_INJECTION: forcing a failure\n");\r\nif (attr->verbose > 1)\r\ndump_stack();\r\n}\r\nstatic bool fail_task(struct fault_attr *attr, struct task_struct *task)\r\n{\r\nreturn !in_interrupt() && task->make_it_fail;\r\n}\r\nstatic bool fail_stacktrace(struct fault_attr *attr)\r\n{\r\nstruct stack_trace trace;\r\nint depth = attr->stacktrace_depth;\r\nunsigned long entries[MAX_STACK_TRACE_DEPTH];\r\nint n;\r\nbool found = (attr->require_start == 0 && attr->require_end == ULONG_MAX);\r\nif (depth == 0)\r\nreturn found;\r\ntrace.nr_entries = 0;\r\ntrace.entries = entries;\r\ntrace.max_entries = depth;\r\ntrace.skip = 1;\r\nsave_stack_trace(&trace);\r\nfor (n = 0; n < trace.nr_entries; n++) {\r\nif (attr->reject_start <= entries[n] &&\r\nentries[n] < attr->reject_end)\r\nreturn false;\r\nif (attr->require_start <= entries[n] &&\r\nentries[n] < attr->require_end)\r\nfound = true;\r\n}\r\nreturn found;\r\n}\r\nstatic inline bool fail_stacktrace(struct fault_attr *attr)\r\n{\r\nreturn true;\r\n}\r\nbool should_fail(struct fault_attr *attr, ssize_t size)\r\n{\r\nif (attr->probability == 0)\r\nreturn false;\r\nif (attr->task_filter && !fail_task(attr, current))\r\nreturn false;\r\nif (atomic_read(&attr->times) == 0)\r\nreturn false;\r\nif (atomic_read(&attr->space) > size) {\r\natomic_sub(size, &attr->space);\r\nreturn false;\r\n}\r\nif (attr->interval > 1) {\r\nattr->count++;\r\nif (attr->count % attr->interval)\r\nreturn false;\r\n}\r\nif (attr->probability <= prandom_u32() % 100)\r\nreturn false;\r\nif (!fail_stacktrace(attr))\r\nreturn false;\r\nfail_dump(attr);\r\nif (atomic_read(&attr->times) != -1)\r\natomic_dec_not_zero(&attr->times);\r\nreturn true;\r\n}\r\nstatic int debugfs_ul_set(void *data, u64 val)\r\n{\r\n*(unsigned long *)data = val;\r\nreturn 0;\r\n}\r\nstatic int debugfs_ul_get(void *data, u64 *val)\r\n{\r\n*val = *(unsigned long *)data;\r\nreturn 0;\r\n}\r\nstatic struct dentry *debugfs_create_ul(const char *name, umode_t mode,\r\nstruct dentry *parent, unsigned long *value)\r\n{\r\nreturn debugfs_create_file(name, mode, parent, value, &fops_ul);\r\n}\r\nstatic int debugfs_stacktrace_depth_set(void *data, u64 val)\r\n{\r\n*(unsigned long *)data =\r\nmin_t(unsigned long, val, MAX_STACK_TRACE_DEPTH);\r\nreturn 0;\r\n}\r\nstatic struct dentry *debugfs_create_stacktrace_depth(\r\nconst char *name, umode_t mode,\r\nstruct dentry *parent, unsigned long *value)\r\n{\r\nreturn debugfs_create_file(name, mode, parent, value,\r\n&fops_stacktrace_depth);\r\n}\r\nstruct dentry *fault_create_debugfs_attr(const char *name,\r\nstruct dentry *parent, struct fault_attr *attr)\r\n{\r\numode_t mode = S_IFREG | S_IRUSR | S_IWUSR;\r\nstruct dentry *dir;\r\ndir = debugfs_create_dir(name, parent);\r\nif (!dir)\r\nreturn ERR_PTR(-ENOMEM);\r\nif (!debugfs_create_ul("probability", mode, dir, &attr->probability))\r\ngoto fail;\r\nif (!debugfs_create_ul("interval", mode, dir, &attr->interval))\r\ngoto fail;\r\nif (!debugfs_create_atomic_t("times", mode, dir, &attr->times))\r\ngoto fail;\r\nif (!debugfs_create_atomic_t("space", mode, dir, &attr->space))\r\ngoto fail;\r\nif (!debugfs_create_ul("verbose", mode, dir, &attr->verbose))\r\ngoto fail;\r\nif (!debugfs_create_bool("task-filter", mode, dir, &attr->task_filter))\r\ngoto fail;\r\n#ifdef CONFIG_FAULT_INJECTION_STACKTRACE_FILTER\r\nif (!debugfs_create_stacktrace_depth("stacktrace-depth", mode, dir,\r\n&attr->stacktrace_depth))\r\ngoto fail;\r\nif (!debugfs_create_ul("require-start", mode, dir,\r\n&attr->require_start))\r\ngoto fail;\r\nif (!debugfs_create_ul("require-end", mode, dir, &attr->require_end))\r\ngoto fail;\r\nif (!debugfs_create_ul("reject-start", mode, dir, &attr->reject_start))\r\ngoto fail;\r\nif (!debugfs_create_ul("reject-end", mode, dir, &attr->reject_end))\r\ngoto fail;\r\n#endif\r\nreturn dir;\r\nfail:\r\ndebugfs_remove_recursive(dir);\r\nreturn ERR_PTR(-ENOMEM);\r\n}

static void rtc_wait_not_busy(void)\r\n{\r\nint count = 0;\r\nu8 status;\r\nfor (count = 0; count < 50; count++) {\r\nstatus = rtc_read(OMAP_RTC_STATUS_REG);\r\nif ((status & (u8)OMAP_RTC_STATUS_BUSY) == 0)\r\nbreak;\r\nudelay(1);\r\n}\r\n}\r\nstatic irqreturn_t rtc_irq(int irq, void *rtc)\r\n{\r\nunsigned long events = 0;\r\nu8 irq_data;\r\nirq_data = rtc_read(OMAP_RTC_STATUS_REG);\r\nif (irq_data & OMAP_RTC_STATUS_ALARM) {\r\nrtc_write(OMAP_RTC_STATUS_ALARM, OMAP_RTC_STATUS_REG);\r\nevents |= RTC_IRQF | RTC_AF;\r\n}\r\nif (irq_data & OMAP_RTC_STATUS_1S_EVENT)\r\nevents |= RTC_IRQF | RTC_UF;\r\nrtc_update_irq(rtc, 1, events);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int omap_rtc_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nu8 reg;\r\nlocal_irq_disable();\r\nrtc_wait_not_busy();\r\nreg = rtc_read(OMAP_RTC_INTERRUPTS_REG);\r\nif (enabled)\r\nreg |= OMAP_RTC_INTERRUPTS_IT_ALARM;\r\nelse\r\nreg &= ~OMAP_RTC_INTERRUPTS_IT_ALARM;\r\nrtc_wait_not_busy();\r\nrtc_write(reg, OMAP_RTC_INTERRUPTS_REG);\r\nlocal_irq_enable();\r\nreturn 0;\r\n}\r\nstatic int tm2bcd(struct rtc_time *tm)\r\n{\r\nif (rtc_valid_tm(tm) != 0)\r\nreturn -EINVAL;\r\ntm->tm_sec = bin2bcd(tm->tm_sec);\r\ntm->tm_min = bin2bcd(tm->tm_min);\r\ntm->tm_hour = bin2bcd(tm->tm_hour);\r\ntm->tm_mday = bin2bcd(tm->tm_mday);\r\ntm->tm_mon = bin2bcd(tm->tm_mon + 1);\r\nif (tm->tm_year < 100 || tm->tm_year > 199)\r\nreturn -EINVAL;\r\ntm->tm_year = bin2bcd(tm->tm_year - 100);\r\nreturn 0;\r\n}\r\nstatic void bcd2tm(struct rtc_time *tm)\r\n{\r\ntm->tm_sec = bcd2bin(tm->tm_sec);\r\ntm->tm_min = bcd2bin(tm->tm_min);\r\ntm->tm_hour = bcd2bin(tm->tm_hour);\r\ntm->tm_mday = bcd2bin(tm->tm_mday);\r\ntm->tm_mon = bcd2bin(tm->tm_mon) - 1;\r\ntm->tm_year = bcd2bin(tm->tm_year) + 100;\r\n}\r\nstatic int omap_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nlocal_irq_disable();\r\nrtc_wait_not_busy();\r\ntm->tm_sec = rtc_read(OMAP_RTC_SECONDS_REG);\r\ntm->tm_min = rtc_read(OMAP_RTC_MINUTES_REG);\r\ntm->tm_hour = rtc_read(OMAP_RTC_HOURS_REG);\r\ntm->tm_mday = rtc_read(OMAP_RTC_DAYS_REG);\r\ntm->tm_mon = rtc_read(OMAP_RTC_MONTHS_REG);\r\ntm->tm_year = rtc_read(OMAP_RTC_YEARS_REG);\r\nlocal_irq_enable();\r\nbcd2tm(tm);\r\nreturn 0;\r\n}\r\nstatic int omap_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nif (tm2bcd(tm) < 0)\r\nreturn -EINVAL;\r\nlocal_irq_disable();\r\nrtc_wait_not_busy();\r\nrtc_write(tm->tm_year, OMAP_RTC_YEARS_REG);\r\nrtc_write(tm->tm_mon, OMAP_RTC_MONTHS_REG);\r\nrtc_write(tm->tm_mday, OMAP_RTC_DAYS_REG);\r\nrtc_write(tm->tm_hour, OMAP_RTC_HOURS_REG);\r\nrtc_write(tm->tm_min, OMAP_RTC_MINUTES_REG);\r\nrtc_write(tm->tm_sec, OMAP_RTC_SECONDS_REG);\r\nlocal_irq_enable();\r\nreturn 0;\r\n}\r\nstatic int omap_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nlocal_irq_disable();\r\nrtc_wait_not_busy();\r\nalm->time.tm_sec = rtc_read(OMAP_RTC_ALARM_SECONDS_REG);\r\nalm->time.tm_min = rtc_read(OMAP_RTC_ALARM_MINUTES_REG);\r\nalm->time.tm_hour = rtc_read(OMAP_RTC_ALARM_HOURS_REG);\r\nalm->time.tm_mday = rtc_read(OMAP_RTC_ALARM_DAYS_REG);\r\nalm->time.tm_mon = rtc_read(OMAP_RTC_ALARM_MONTHS_REG);\r\nalm->time.tm_year = rtc_read(OMAP_RTC_ALARM_YEARS_REG);\r\nlocal_irq_enable();\r\nbcd2tm(&alm->time);\r\nalm->enabled = !!(rtc_read(OMAP_RTC_INTERRUPTS_REG)\r\n& OMAP_RTC_INTERRUPTS_IT_ALARM);\r\nreturn 0;\r\n}\r\nstatic int omap_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nu8 reg;\r\nif (tm2bcd(&alm->time) < 0)\r\nreturn -EINVAL;\r\nlocal_irq_disable();\r\nrtc_wait_not_busy();\r\nrtc_write(alm->time.tm_year, OMAP_RTC_ALARM_YEARS_REG);\r\nrtc_write(alm->time.tm_mon, OMAP_RTC_ALARM_MONTHS_REG);\r\nrtc_write(alm->time.tm_mday, OMAP_RTC_ALARM_DAYS_REG);\r\nrtc_write(alm->time.tm_hour, OMAP_RTC_ALARM_HOURS_REG);\r\nrtc_write(alm->time.tm_min, OMAP_RTC_ALARM_MINUTES_REG);\r\nrtc_write(alm->time.tm_sec, OMAP_RTC_ALARM_SECONDS_REG);\r\nreg = rtc_read(OMAP_RTC_INTERRUPTS_REG);\r\nif (alm->enabled)\r\nreg |= OMAP_RTC_INTERRUPTS_IT_ALARM;\r\nelse\r\nreg &= ~OMAP_RTC_INTERRUPTS_IT_ALARM;\r\nrtc_write(reg, OMAP_RTC_INTERRUPTS_REG);\r\nlocal_irq_enable();\r\nreturn 0;\r\n}\r\nstatic int __init omap_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct rtc_device *rtc;\r\nu8 reg, new_ctrl;\r\nconst struct platform_device_id *id_entry;\r\nconst struct of_device_id *of_id;\r\nof_id = of_match_device(omap_rtc_of_match, &pdev->dev);\r\nif (of_id)\r\npdev->id_entry = of_id->data;\r\nomap_rtc_timer = platform_get_irq(pdev, 0);\r\nif (omap_rtc_timer <= 0) {\r\npr_debug("%s: no update irq?\n", pdev->name);\r\nreturn -ENOENT;\r\n}\r\nomap_rtc_alarm = platform_get_irq(pdev, 1);\r\nif (omap_rtc_alarm <= 0) {\r\npr_debug("%s: no alarm irq?\n", pdev->name);\r\nreturn -ENOENT;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nrtc_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(rtc_base))\r\nreturn PTR_ERR(rtc_base);\r\npm_runtime_enable(&pdev->dev);\r\npm_runtime_get_sync(&pdev->dev);\r\nid_entry = platform_get_device_id(pdev);\r\nif (id_entry && (id_entry->driver_data & OMAP_RTC_HAS_KICKER)) {\r\nrtc_writel(KICK0_VALUE, OMAP_RTC_KICK0_REG);\r\nrtc_writel(KICK1_VALUE, OMAP_RTC_KICK1_REG);\r\n}\r\nrtc = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&omap_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc)) {\r\npr_debug("%s: can't register RTC device, err %ld\n",\r\npdev->name, PTR_ERR(rtc));\r\ngoto fail0;\r\n}\r\nplatform_set_drvdata(pdev, rtc);\r\nrtc_write(0, OMAP_RTC_INTERRUPTS_REG);\r\nreg = rtc_read(OMAP_RTC_STATUS_REG);\r\nif (reg & (u8) OMAP_RTC_STATUS_POWER_UP) {\r\npr_info("%s: RTC power up reset detected\n",\r\npdev->name);\r\nrtc_write(OMAP_RTC_STATUS_POWER_UP, OMAP_RTC_STATUS_REG);\r\n}\r\nif (reg & (u8) OMAP_RTC_STATUS_ALARM)\r\nrtc_write(OMAP_RTC_STATUS_ALARM, OMAP_RTC_STATUS_REG);\r\nif (devm_request_irq(&pdev->dev, omap_rtc_timer, rtc_irq, 0,\r\ndev_name(&rtc->dev), rtc)) {\r\npr_debug("%s: RTC timer interrupt IRQ%d already claimed\n",\r\npdev->name, omap_rtc_timer);\r\ngoto fail0;\r\n}\r\nif ((omap_rtc_timer != omap_rtc_alarm) &&\r\n(devm_request_irq(&pdev->dev, omap_rtc_alarm, rtc_irq, 0,\r\ndev_name(&rtc->dev), rtc))) {\r\npr_debug("%s: RTC alarm interrupt IRQ%d already claimed\n",\r\npdev->name, omap_rtc_alarm);\r\ngoto fail0;\r\n}\r\nreg = rtc_read(OMAP_RTC_CTRL_REG);\r\nif (reg & (u8) OMAP_RTC_CTRL_STOP)\r\npr_info("%s: already running\n", pdev->name);\r\nnew_ctrl = reg & (OMAP_RTC_CTRL_SPLIT|OMAP_RTC_CTRL_AUTO_COMP);\r\nnew_ctrl |= OMAP_RTC_CTRL_STOP;\r\ndevice_init_wakeup(&pdev->dev, true);\r\nif (new_ctrl & (u8) OMAP_RTC_CTRL_SPLIT)\r\npr_info("%s: split power mode\n", pdev->name);\r\nif (reg != new_ctrl)\r\nrtc_write(new_ctrl, OMAP_RTC_CTRL_REG);\r\nreturn 0;\r\nfail0:\r\nif (id_entry && (id_entry->driver_data & OMAP_RTC_HAS_KICKER))\r\nrtc_writel(0, OMAP_RTC_KICK0_REG);\r\npm_runtime_put_sync(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\nreturn -EIO;\r\n}\r\nstatic int __exit omap_rtc_remove(struct platform_device *pdev)\r\n{\r\nconst struct platform_device_id *id_entry =\r\nplatform_get_device_id(pdev);\r\ndevice_init_wakeup(&pdev->dev, 0);\r\nrtc_write(0, OMAP_RTC_INTERRUPTS_REG);\r\nif (id_entry && (id_entry->driver_data & OMAP_RTC_HAS_KICKER))\r\nrtc_writel(0, OMAP_RTC_KICK0_REG);\r\npm_runtime_put_sync(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\nreturn 0;\r\n}\r\nstatic int omap_rtc_suspend(struct device *dev)\r\n{\r\nu8 irqwake_stat;\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nconst struct platform_device_id *id_entry =\r\nplatform_get_device_id(pdev);\r\nirqstat = rtc_read(OMAP_RTC_INTERRUPTS_REG);\r\nif (device_may_wakeup(dev)) {\r\nenable_irq_wake(omap_rtc_alarm);\r\nif (id_entry->driver_data & OMAP_RTC_HAS_IRQWAKEEN) {\r\nirqwake_stat = rtc_read(OMAP_RTC_IRQWAKEEN);\r\nirqwake_stat |= OMAP_RTC_IRQWAKEEN_ALARM_WAKEEN;\r\nrtc_write(irqwake_stat, OMAP_RTC_IRQWAKEEN);\r\n}\r\n} else {\r\nrtc_write(0, OMAP_RTC_INTERRUPTS_REG);\r\n}\r\npm_runtime_put_sync(dev);\r\nreturn 0;\r\n}\r\nstatic int omap_rtc_resume(struct device *dev)\r\n{\r\nu8 irqwake_stat;\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nconst struct platform_device_id *id_entry =\r\nplatform_get_device_id(pdev);\r\npm_runtime_get_sync(dev);\r\nif (device_may_wakeup(dev)) {\r\ndisable_irq_wake(omap_rtc_alarm);\r\nif (id_entry->driver_data & OMAP_RTC_HAS_IRQWAKEEN) {\r\nirqwake_stat = rtc_read(OMAP_RTC_IRQWAKEEN);\r\nirqwake_stat &= ~OMAP_RTC_IRQWAKEEN_ALARM_WAKEEN;\r\nrtc_write(irqwake_stat, OMAP_RTC_IRQWAKEEN);\r\n}\r\n} else {\r\nrtc_write(irqstat, OMAP_RTC_INTERRUPTS_REG);\r\n}\r\nreturn 0;\r\n}\r\nstatic void omap_rtc_shutdown(struct platform_device *pdev)\r\n{\r\nrtc_write(0, OMAP_RTC_INTERRUPTS_REG);\r\n}

static bool clk_branch_in_hwcg_mode(const struct clk_branch *br)\r\n{\r\nu32 val;\r\nif (!br->hwcg_reg)\r\nreturn 0;\r\nregmap_read(br->clkr.regmap, br->hwcg_reg, &val);\r\nreturn !!(val & BIT(br->hwcg_bit));\r\n}\r\nstatic bool clk_branch_check_halt(const struct clk_branch *br, bool enabling)\r\n{\r\nbool invert = (br->halt_check == BRANCH_HALT_ENABLE);\r\nu32 val;\r\nregmap_read(br->clkr.regmap, br->halt_reg, &val);\r\nval &= BIT(br->halt_bit);\r\nif (invert)\r\nval = !val;\r\nreturn !!val == !enabling;\r\n}\r\nstatic bool clk_branch2_check_halt(const struct clk_branch *br, bool enabling)\r\n{\r\nu32 val;\r\nu32 mask;\r\nmask = BRANCH_NOC_FSM_STATUS_MASK << BRANCH_NOC_FSM_STATUS_SHIFT;\r\nmask |= BRANCH_CLK_OFF;\r\nregmap_read(br->clkr.regmap, br->halt_reg, &val);\r\nif (enabling) {\r\nval &= mask;\r\nreturn (val & BRANCH_CLK_OFF) == 0 ||\r\nval == BRANCH_NOC_FSM_STATUS_ON;\r\n} else {\r\nreturn val & BRANCH_CLK_OFF;\r\n}\r\n}\r\nstatic int clk_branch_wait(const struct clk_branch *br, bool enabling,\r\nbool (check_halt)(const struct clk_branch *, bool))\r\n{\r\nbool voted = br->halt_check & BRANCH_VOTED;\r\nconst char *name = __clk_get_name(br->clkr.hw.clk);\r\nif (clk_branch_in_hwcg_mode(br))\r\nreturn 0;\r\nif (br->halt_check == BRANCH_HALT_DELAY || (!enabling && voted)) {\r\nudelay(10);\r\n} else if (br->halt_check == BRANCH_HALT_ENABLE ||\r\nbr->halt_check == BRANCH_HALT ||\r\n(enabling && voted)) {\r\nint count = 200;\r\nwhile (count-- > 0) {\r\nif (check_halt(br, enabling))\r\nreturn 0;\r\nudelay(1);\r\n}\r\nWARN(1, "%s status stuck at 'o%s'", name,\r\nenabling ? "ff" : "n");\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}\r\nstatic int clk_branch_toggle(struct clk_hw *hw, bool en,\r\nbool (check_halt)(const struct clk_branch *, bool))\r\n{\r\nstruct clk_branch *br = to_clk_branch(hw);\r\nint ret;\r\nif (en) {\r\nret = clk_enable_regmap(hw);\r\nif (ret)\r\nreturn ret;\r\n} else {\r\nclk_disable_regmap(hw);\r\n}\r\nreturn clk_branch_wait(br, en, check_halt);\r\n}\r\nstatic int clk_branch_enable(struct clk_hw *hw)\r\n{\r\nreturn clk_branch_toggle(hw, true, clk_branch_check_halt);\r\n}\r\nstatic void clk_branch_disable(struct clk_hw *hw)\r\n{\r\nclk_branch_toggle(hw, false, clk_branch_check_halt);\r\n}\r\nstatic int clk_branch2_enable(struct clk_hw *hw)\r\n{\r\nreturn clk_branch_toggle(hw, true, clk_branch2_check_halt);\r\n}\r\nstatic void clk_branch2_disable(struct clk_hw *hw)\r\n{\r\nclk_branch_toggle(hw, false, clk_branch2_check_halt);\r\n}

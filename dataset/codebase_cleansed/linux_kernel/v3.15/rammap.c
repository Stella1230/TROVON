u32\r\nnvbios_rammapTe(struct nouveau_bios *bios, u8 *ver, u8 *hdr,\r\nu8 *cnt, u8 *len, u8 *snr, u8 *ssz)\r\n{\r\nstruct bit_entry bit_P;\r\nu16 rammap = 0x0000;\r\nif (!bit_entry(bios, 'P', &bit_P)) {\r\nif (bit_P.version == 2)\r\nrammap = nv_ro16(bios, bit_P.offset + 4);\r\nif (rammap) {\r\n*ver = nv_ro08(bios, rammap + 0);\r\nswitch (*ver) {\r\ncase 0x10:\r\ncase 0x11:\r\n*hdr = nv_ro08(bios, rammap + 1);\r\n*cnt = nv_ro08(bios, rammap + 5);\r\n*len = nv_ro08(bios, rammap + 2);\r\n*snr = nv_ro08(bios, rammap + 4);\r\n*ssz = nv_ro08(bios, rammap + 3);\r\nreturn rammap;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn 0x0000;\r\n}\r\nu32\r\nnvbios_rammapEe(struct nouveau_bios *bios, int idx,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len)\r\n{\r\nu8 snr, ssz;\r\nu16 rammap = nvbios_rammapTe(bios, ver, hdr, cnt, len, &snr, &ssz);\r\nif (rammap && idx < *cnt) {\r\nrammap = rammap + *hdr + (idx * (*len + (snr * ssz)));\r\n*hdr = *len;\r\n*cnt = snr;\r\n*len = ssz;\r\nreturn rammap;\r\n}\r\nreturn 0x0000;\r\n}\r\nu32\r\nnvbios_rammapEm(struct nouveau_bios *bios, u16 khz,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len)\r\n{\r\nint idx = 0;\r\nu32 data;\r\nwhile ((data = nvbios_rammapEe(bios, idx++, ver, hdr, cnt, len))) {\r\nif (khz >= nv_ro16(bios, data + 0x00) &&\r\nkhz <= nv_ro16(bios, data + 0x02))\r\nbreak;\r\n}\r\nreturn data;\r\n}\r\nu32\r\nnvbios_rammapEp(struct nouveau_bios *bios, u16 khz,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len,\r\nstruct nvbios_ramcfg *p)\r\n{\r\nu32 data = nvbios_rammapEm(bios, khz, ver, hdr, cnt, len);\r\nmemset(p, 0x00, sizeof(*p));\r\nswitch (!!data * *ver) {\r\ncase 0x11:\r\np->rammap_11_08_01 = (nv_ro08(bios, data + 0x08) & 0x01) >> 0;\r\np->rammap_11_08_0c = (nv_ro08(bios, data + 0x08) & 0x0c) >> 2;\r\np->rammap_11_08_10 = (nv_ro08(bios, data + 0x08) & 0x10) >> 4;\r\np->rammap_11_11_0c = (nv_ro08(bios, data + 0x11) & 0x0c) >> 2;\r\nbreak;\r\ndefault:\r\ndata = 0;\r\nbreak;\r\n}\r\nreturn data;\r\n}\r\nu32\r\nnvbios_rammapSe(struct nouveau_bios *bios, u32 data,\r\nu8 ever, u8 ehdr, u8 ecnt, u8 elen, int idx,\r\nu8 *ver, u8 *hdr)\r\n{\r\nif (idx < ecnt) {\r\ndata = data + ehdr + (idx * elen);\r\n*ver = ever;\r\n*hdr = elen;\r\nreturn data;\r\n}\r\nreturn 0;\r\n}\r\nu32\r\nnvbios_rammapSp(struct nouveau_bios *bios, u32 data,\r\nu8 ever, u8 ehdr, u8 ecnt, u8 elen, int idx,\r\nu8 *ver, u8 *hdr, struct nvbios_ramcfg *p)\r\n{\r\ndata = nvbios_rammapSe(bios, data, ever, ehdr, ecnt, elen, idx, ver, hdr);\r\nswitch (!!data * *ver) {\r\ncase 0x11:\r\np->ramcfg_11_01_01 = (nv_ro08(bios, data + 0x01) & 0x01) >> 0;\r\np->ramcfg_11_01_02 = (nv_ro08(bios, data + 0x01) & 0x02) >> 1;\r\np->ramcfg_11_01_04 = (nv_ro08(bios, data + 0x01) & 0x04) >> 2;\r\np->ramcfg_11_01_08 = (nv_ro08(bios, data + 0x01) & 0x08) >> 3;\r\np->ramcfg_11_01_10 = (nv_ro08(bios, data + 0x01) & 0x10) >> 4;\r\np->ramcfg_11_01_20 = (nv_ro08(bios, data + 0x01) & 0x20) >> 5;\r\np->ramcfg_11_01_40 = (nv_ro08(bios, data + 0x01) & 0x40) >> 6;\r\np->ramcfg_11_01_80 = (nv_ro08(bios, data + 0x01) & 0x80) >> 7;\r\np->ramcfg_11_02_03 = (nv_ro08(bios, data + 0x02) & 0x03) >> 0;\r\np->ramcfg_11_02_04 = (nv_ro08(bios, data + 0x02) & 0x04) >> 2;\r\np->ramcfg_11_02_08 = (nv_ro08(bios, data + 0x02) & 0x08) >> 3;\r\np->ramcfg_11_02_10 = (nv_ro08(bios, data + 0x02) & 0x10) >> 4;\r\np->ramcfg_11_02_40 = (nv_ro08(bios, data + 0x02) & 0x40) >> 6;\r\np->ramcfg_11_02_80 = (nv_ro08(bios, data + 0x02) & 0x80) >> 7;\r\np->ramcfg_11_03_0f = (nv_ro08(bios, data + 0x03) & 0x0f) >> 0;\r\np->ramcfg_11_03_30 = (nv_ro08(bios, data + 0x03) & 0x30) >> 4;\r\np->ramcfg_11_03_c0 = (nv_ro08(bios, data + 0x03) & 0xc0) >> 6;\r\np->ramcfg_11_03_f0 = (nv_ro08(bios, data + 0x03) & 0xf0) >> 4;\r\np->ramcfg_11_04 = (nv_ro08(bios, data + 0x04) & 0xff) >> 0;\r\np->ramcfg_11_06 = (nv_ro08(bios, data + 0x06) & 0xff) >> 0;\r\np->ramcfg_11_07_02 = (nv_ro08(bios, data + 0x07) & 0x02) >> 1;\r\np->ramcfg_11_07_04 = (nv_ro08(bios, data + 0x07) & 0x04) >> 2;\r\np->ramcfg_11_07_08 = (nv_ro08(bios, data + 0x07) & 0x08) >> 3;\r\np->ramcfg_11_07_10 = (nv_ro08(bios, data + 0x07) & 0x10) >> 4;\r\np->ramcfg_11_07_40 = (nv_ro08(bios, data + 0x07) & 0x40) >> 6;\r\np->ramcfg_11_07_80 = (nv_ro08(bios, data + 0x07) & 0x80) >> 7;\r\np->ramcfg_11_08_01 = (nv_ro08(bios, data + 0x08) & 0x01) >> 0;\r\np->ramcfg_11_08_02 = (nv_ro08(bios, data + 0x08) & 0x02) >> 1;\r\np->ramcfg_11_08_04 = (nv_ro08(bios, data + 0x08) & 0x04) >> 2;\r\np->ramcfg_11_08_08 = (nv_ro08(bios, data + 0x08) & 0x08) >> 3;\r\np->ramcfg_11_08_10 = (nv_ro08(bios, data + 0x08) & 0x10) >> 4;\r\np->ramcfg_11_08_20 = (nv_ro08(bios, data + 0x08) & 0x20) >> 5;\r\np->ramcfg_11_09 = (nv_ro08(bios, data + 0x09) & 0xff) >> 0;\r\nbreak;\r\ndefault:\r\ndata = 0;\r\nbreak;\r\n}\r\nreturn data;\r\n}

const char *get_system_type(void)\r\n{\r\nreturn "MTX-1";\r\n}\r\nvoid __init prom_init(void)\r\n{\r\nunsigned char *memsize_str;\r\nunsigned long memsize;\r\nprom_argc = fw_arg0;\r\nprom_argv = (char **)fw_arg1;\r\nprom_envp = (char **)fw_arg2;\r\nprom_init_cmdline();\r\nmemsize_str = prom_getenv("memsize");\r\nif (!memsize_str || kstrtoul(memsize_str, 0, &memsize))\r\nmemsize = 0x04000000;\r\nadd_memory_region(0, memsize, BOOT_MEM_RAM);\r\n}\r\nvoid prom_putchar(unsigned char c)\r\n{\r\nalchemy_uart_putchar(AU1000_UART0_PHYS_ADDR, c);\r\n}\r\nstatic void mtx1_reset(char *c)\r\n{\r\n__asm__ __volatile__("jr\t%0" : : "r"(0xbfc00000));\r\n}\r\nstatic void mtx1_power_off(void)\r\n{\r\nwhile (1)\r\nasm volatile (\r\n" .set mips32 \n"\r\n" wait \n"\r\n" .set mips0 \n");\r\n}\r\nvoid __init board_setup(void)\r\n{\r\n#if IS_ENABLED(CONFIG_USB_OHCI_HCD)\r\nalchemy_gpio_direction_output(204, 0);\r\n#endif\r\nau_writel(SYS_PF_NI2, SYS_PINFUNC);\r\nau_writel(~0, KSEG1ADDR(AU1000_SYS_PHYS_ADDR) + SYS_TRIOUTCLR);\r\nalchemy_gpio_direction_output(0, 0);\r\nalchemy_gpio_direction_output(3, 1);\r\nalchemy_gpio_direction_output(1, 1);\r\nalchemy_gpio_direction_output(5, 0);\r\nalchemy_gpio_direction_output(211, 1);\r\nalchemy_gpio_direction_output(212, 0);\r\npm_power_off = mtx1_power_off;\r\n_machine_halt = mtx1_power_off;\r\n_machine_restart = mtx1_reset;\r\nprintk(KERN_INFO "4G Systems MTX-1 Board\n");\r\n}\r\nstatic int mtx1_pci_idsel(unsigned int devsel, int assert)\r\n{\r\nudelay(1);\r\nif (assert && devsel != 0)\r\nalchemy_gpio_set_value(1, 0);\r\nelse\r\nalchemy_gpio_set_value(1, 1);\r\nudelay(1);\r\nreturn 1;\r\n}\r\nstatic int mtx1_map_pci_irq(const struct pci_dev *d, u8 slot, u8 pin)\r\n{\r\nreturn mtx1_irqtab[slot][pin];\r\n}\r\nstatic int __init mtx1_register_devices(void)\r\n{\r\nint rc;\r\nirq_set_irq_type(AU1500_GPIO204_INT, IRQ_TYPE_LEVEL_HIGH);\r\nirq_set_irq_type(AU1500_GPIO201_INT, IRQ_TYPE_LEVEL_LOW);\r\nirq_set_irq_type(AU1500_GPIO202_INT, IRQ_TYPE_LEVEL_LOW);\r\nirq_set_irq_type(AU1500_GPIO203_INT, IRQ_TYPE_LEVEL_LOW);\r\nirq_set_irq_type(AU1500_GPIO205_INT, IRQ_TYPE_LEVEL_LOW);\r\nau1xxx_override_eth_cfg(0, &mtx1_au1000_eth0_pdata);\r\nrc = gpio_request(mtx1_gpio_button[0].gpio,\r\nmtx1_gpio_button[0].desc);\r\nif (rc < 0) {\r\nprintk(KERN_INFO "mtx1: failed to request %d\n",\r\nmtx1_gpio_button[0].gpio);\r\ngoto out;\r\n}\r\ngpio_direction_input(mtx1_gpio_button[0].gpio);\r\nout:\r\nreturn platform_add_devices(mtx1_devs, ARRAY_SIZE(mtx1_devs));\r\n}

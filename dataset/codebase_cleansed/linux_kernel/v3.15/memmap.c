static inline struct firmware_map_entry *\r\nto_memmap_entry(struct kobject *kobj)\r\n{\r\nreturn container_of(kobj, struct firmware_map_entry, kobj);\r\n}\r\nstatic void __meminit release_firmware_map_entry(struct kobject *kobj)\r\n{\r\nstruct firmware_map_entry *entry = to_memmap_entry(kobj);\r\nif (PageReserved(virt_to_page(entry))) {\r\nspin_lock(&map_entries_bootmem_lock);\r\nlist_add(&entry->list, &map_entries_bootmem);\r\nspin_unlock(&map_entries_bootmem_lock);\r\nreturn;\r\n}\r\nkfree(entry);\r\n}\r\nstatic int firmware_map_add_entry(u64 start, u64 end,\r\nconst char *type,\r\nstruct firmware_map_entry *entry)\r\n{\r\nBUG_ON(start > end);\r\nentry->start = start;\r\nentry->end = end - 1;\r\nentry->type = type;\r\nINIT_LIST_HEAD(&entry->list);\r\nkobject_init(&entry->kobj, &memmap_ktype);\r\nspin_lock(&map_entries_lock);\r\nlist_add_tail(&entry->list, &map_entries);\r\nspin_unlock(&map_entries_lock);\r\nreturn 0;\r\n}\r\nstatic inline void firmware_map_remove_entry(struct firmware_map_entry *entry)\r\n{\r\nlist_del(&entry->list);\r\n}\r\nstatic int add_sysfs_fw_map_entry(struct firmware_map_entry *entry)\r\n{\r\nstatic int map_entries_nr;\r\nstatic struct kset *mmap_kset;\r\nif (!mmap_kset) {\r\nmmap_kset = kset_create_and_add("memmap", NULL, firmware_kobj);\r\nif (!mmap_kset)\r\nreturn -ENOMEM;\r\n}\r\nentry->kobj.kset = mmap_kset;\r\nif (kobject_add(&entry->kobj, NULL, "%d", map_entries_nr++))\r\nkobject_put(&entry->kobj);\r\nreturn 0;\r\n}\r\nstatic inline void remove_sysfs_fw_map_entry(struct firmware_map_entry *entry)\r\n{\r\nkobject_put(&entry->kobj);\r\n}\r\nstatic struct firmware_map_entry * __meminit\r\nfirmware_map_find_entry_in_list(u64 start, u64 end, const char *type,\r\nstruct list_head *list)\r\n{\r\nstruct firmware_map_entry *entry;\r\nlist_for_each_entry(entry, list, list)\r\nif ((entry->start == start) && (entry->end == end) &&\r\n(!strcmp(entry->type, type))) {\r\nreturn entry;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct firmware_map_entry * __meminit\r\nfirmware_map_find_entry(u64 start, u64 end, const char *type)\r\n{\r\nreturn firmware_map_find_entry_in_list(start, end, type, &map_entries);\r\n}\r\nstatic struct firmware_map_entry * __meminit\r\nfirmware_map_find_entry_bootmem(u64 start, u64 end, const char *type)\r\n{\r\nreturn firmware_map_find_entry_in_list(start, end, type,\r\n&map_entries_bootmem);\r\n}\r\nint __meminit firmware_map_add_hotplug(u64 start, u64 end, const char *type)\r\n{\r\nstruct firmware_map_entry *entry;\r\nentry = firmware_map_find_entry_bootmem(start, end, type);\r\nif (!entry) {\r\nentry = kzalloc(sizeof(struct firmware_map_entry), GFP_ATOMIC);\r\nif (!entry)\r\nreturn -ENOMEM;\r\n} else {\r\nspin_lock(&map_entries_bootmem_lock);\r\nlist_del(&entry->list);\r\nspin_unlock(&map_entries_bootmem_lock);\r\nmemset(entry, 0, sizeof(*entry));\r\n}\r\nfirmware_map_add_entry(start, end, type, entry);\r\nadd_sysfs_fw_map_entry(entry);\r\nreturn 0;\r\n}\r\nint __init firmware_map_add_early(u64 start, u64 end, const char *type)\r\n{\r\nstruct firmware_map_entry *entry;\r\nentry = memblock_virt_alloc(sizeof(struct firmware_map_entry), 0);\r\nif (WARN_ON(!entry))\r\nreturn -ENOMEM;\r\nreturn firmware_map_add_entry(start, end, type, entry);\r\n}\r\nint __meminit firmware_map_remove(u64 start, u64 end, const char *type)\r\n{\r\nstruct firmware_map_entry *entry;\r\nspin_lock(&map_entries_lock);\r\nentry = firmware_map_find_entry(start, end - 1, type);\r\nif (!entry) {\r\nspin_unlock(&map_entries_lock);\r\nreturn -EINVAL;\r\n}\r\nfirmware_map_remove_entry(entry);\r\nspin_unlock(&map_entries_lock);\r\nremove_sysfs_fw_map_entry(entry);\r\nreturn 0;\r\n}\r\nstatic ssize_t start_show(struct firmware_map_entry *entry, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "0x%llx\n",\r\n(unsigned long long)entry->start);\r\n}\r\nstatic ssize_t end_show(struct firmware_map_entry *entry, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "0x%llx\n",\r\n(unsigned long long)entry->end);\r\n}\r\nstatic ssize_t type_show(struct firmware_map_entry *entry, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n", entry->type);\r\n}\r\nstatic inline struct memmap_attribute *to_memmap_attr(struct attribute *attr)\r\n{\r\nreturn container_of(attr, struct memmap_attribute, attr);\r\n}\r\nstatic ssize_t memmap_attr_show(struct kobject *kobj,\r\nstruct attribute *attr, char *buf)\r\n{\r\nstruct firmware_map_entry *entry = to_memmap_entry(kobj);\r\nstruct memmap_attribute *memmap_attr = to_memmap_attr(attr);\r\nreturn memmap_attr->show(entry, buf);\r\n}\r\nstatic int __init firmware_memmap_init(void)\r\n{\r\nstruct firmware_map_entry *entry;\r\nlist_for_each_entry(entry, &map_entries, list)\r\nadd_sysfs_fw_map_entry(entry);\r\nreturn 0;\r\n}

static unsigned long gpt_calc_rate(struct clk_hw *hw, unsigned long prate,\r\nint index)\r\n{\r\nstruct clk_gpt *gpt = to_clk_gpt(hw);\r\nstruct gpt_rate_tbl *rtbl = gpt->rtbl;\r\nprate /= ((1 << (rtbl[index].nscale + 1)) * (rtbl[index].mscale + 1));\r\nreturn prate;\r\n}\r\nstatic long clk_gpt_round_rate(struct clk_hw *hw, unsigned long drate,\r\nunsigned long *prate)\r\n{\r\nstruct clk_gpt *gpt = to_clk_gpt(hw);\r\nint unused;\r\nreturn clk_round_rate_index(hw, drate, *prate, gpt_calc_rate,\r\ngpt->rtbl_cnt, &unused);\r\n}\r\nstatic unsigned long clk_gpt_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_gpt *gpt = to_clk_gpt(hw);\r\nunsigned long flags = 0;\r\nunsigned int div = 1, val;\r\nif (gpt->lock)\r\nspin_lock_irqsave(gpt->lock, flags);\r\nval = readl_relaxed(gpt->reg);\r\nif (gpt->lock)\r\nspin_unlock_irqrestore(gpt->lock, flags);\r\ndiv += val & GPT_MSCALE_MASK;\r\ndiv *= 1 << (((val >> GPT_NSCALE_SHIFT) & GPT_NSCALE_MASK) + 1);\r\nif (!div)\r\nreturn 0;\r\nreturn parent_rate / div;\r\n}\r\nstatic int clk_gpt_set_rate(struct clk_hw *hw, unsigned long drate,\r\nunsigned long prate)\r\n{\r\nstruct clk_gpt *gpt = to_clk_gpt(hw);\r\nstruct gpt_rate_tbl *rtbl = gpt->rtbl;\r\nunsigned long flags = 0, val;\r\nint i;\r\nclk_round_rate_index(hw, drate, prate, gpt_calc_rate, gpt->rtbl_cnt,\r\n&i);\r\nif (gpt->lock)\r\nspin_lock_irqsave(gpt->lock, flags);\r\nval = readl(gpt->reg) & ~GPT_MSCALE_MASK;\r\nval &= ~(GPT_NSCALE_MASK << GPT_NSCALE_SHIFT);\r\nval |= rtbl[i].mscale & GPT_MSCALE_MASK;\r\nval |= (rtbl[i].nscale & GPT_NSCALE_MASK) << GPT_NSCALE_SHIFT;\r\nwritel_relaxed(val, gpt->reg);\r\nif (gpt->lock)\r\nspin_unlock_irqrestore(gpt->lock, flags);\r\nreturn 0;\r\n}\r\nstruct clk *clk_register_gpt(const char *name, const char *parent_name, unsigned\r\nlong flags, void __iomem *reg, struct gpt_rate_tbl *rtbl, u8\r\nrtbl_cnt, spinlock_t *lock)\r\n{\r\nstruct clk_init_data init;\r\nstruct clk_gpt *gpt;\r\nstruct clk *clk;\r\nif (!name || !parent_name || !reg || !rtbl || !rtbl_cnt) {\r\npr_err("Invalid arguments passed");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\ngpt = kzalloc(sizeof(*gpt), GFP_KERNEL);\r\nif (!gpt) {\r\npr_err("could not allocate gpt clk\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\ngpt->reg = reg;\r\ngpt->rtbl = rtbl;\r\ngpt->rtbl_cnt = rtbl_cnt;\r\ngpt->lock = lock;\r\ngpt->hw.init = &init;\r\ninit.name = name;\r\ninit.ops = &clk_gpt_ops;\r\ninit.flags = flags;\r\ninit.parent_names = &parent_name;\r\ninit.num_parents = 1;\r\nclk = clk_register(NULL, &gpt->hw);\r\nif (!IS_ERR_OR_NULL(clk))\r\nreturn clk;\r\npr_err("clk register failed\n");\r\nkfree(gpt);\r\nreturn NULL;\r\n}

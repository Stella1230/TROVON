static void mmp_sspa_write_reg(struct ssp_device *sspa, u32 reg, u32 val)\r\n{\r\n__raw_writel(val, sspa->mmio_base + reg);\r\n}\r\nstatic u32 mmp_sspa_read_reg(struct ssp_device *sspa, u32 reg)\r\n{\r\nreturn __raw_readl(sspa->mmio_base + reg);\r\n}\r\nstatic void mmp_sspa_tx_enable(struct ssp_device *sspa)\r\n{\r\nunsigned int sspa_sp;\r\nsspa_sp = mmp_sspa_read_reg(sspa, SSPA_TXSP);\r\nsspa_sp |= SSPA_SP_S_EN;\r\nsspa_sp |= SSPA_SP_WEN;\r\nmmp_sspa_write_reg(sspa, SSPA_TXSP, sspa_sp);\r\n}\r\nstatic void mmp_sspa_tx_disable(struct ssp_device *sspa)\r\n{\r\nunsigned int sspa_sp;\r\nsspa_sp = mmp_sspa_read_reg(sspa, SSPA_TXSP);\r\nsspa_sp &= ~SSPA_SP_S_EN;\r\nsspa_sp |= SSPA_SP_WEN;\r\nmmp_sspa_write_reg(sspa, SSPA_TXSP, sspa_sp);\r\n}\r\nstatic void mmp_sspa_rx_enable(struct ssp_device *sspa)\r\n{\r\nunsigned int sspa_sp;\r\nsspa_sp = mmp_sspa_read_reg(sspa, SSPA_RXSP);\r\nsspa_sp |= SSPA_SP_S_EN;\r\nsspa_sp |= SSPA_SP_WEN;\r\nmmp_sspa_write_reg(sspa, SSPA_RXSP, sspa_sp);\r\n}\r\nstatic void mmp_sspa_rx_disable(struct ssp_device *sspa)\r\n{\r\nunsigned int sspa_sp;\r\nsspa_sp = mmp_sspa_read_reg(sspa, SSPA_RXSP);\r\nsspa_sp &= ~SSPA_SP_S_EN;\r\nsspa_sp |= SSPA_SP_WEN;\r\nmmp_sspa_write_reg(sspa, SSPA_RXSP, sspa_sp);\r\n}\r\nstatic int mmp_sspa_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct sspa_priv *priv = snd_soc_dai_get_drvdata(dai);\r\nclk_enable(priv->sysclk);\r\nclk_enable(priv->sspa->clk);\r\nreturn 0;\r\n}\r\nstatic void mmp_sspa_shutdown(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct sspa_priv *priv = snd_soc_dai_get_drvdata(dai);\r\nclk_disable(priv->sspa->clk);\r\nclk_disable(priv->sysclk);\r\nreturn;\r\n}\r\nstatic int mmp_sspa_set_dai_sysclk(struct snd_soc_dai *cpu_dai,\r\nint clk_id, unsigned int freq, int dir)\r\n{\r\nstruct sspa_priv *priv = snd_soc_dai_get_drvdata(cpu_dai);\r\nint ret = 0;\r\nswitch (clk_id) {\r\ncase MMP_SSPA_CLK_AUDIO:\r\nret = clk_set_rate(priv->audio_clk, freq);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase MMP_SSPA_CLK_PLL:\r\ncase MMP_SSPA_CLK_VCXO:\r\nreturn -EINVAL;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mmp_sspa_set_dai_pll(struct snd_soc_dai *cpu_dai, int pll_id,\r\nint source, unsigned int freq_in,\r\nunsigned int freq_out)\r\n{\r\nstruct sspa_priv *priv = snd_soc_dai_get_drvdata(cpu_dai);\r\nint ret = 0;\r\nswitch (pll_id) {\r\ncase MMP_SYSCLK:\r\nret = clk_set_rate(priv->sysclk, freq_out);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase MMP_SSPA_CLK:\r\nret = clk_set_rate(priv->sspa->clk, freq_out);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mmp_sspa_set_dai_fmt(struct snd_soc_dai *cpu_dai,\r\nunsigned int fmt)\r\n{\r\nstruct sspa_priv *sspa_priv = snd_soc_dai_get_drvdata(cpu_dai);\r\nstruct ssp_device *sspa = sspa_priv->sspa;\r\nu32 sspa_sp, sspa_ctrl;\r\nif (sspa_priv->dai_fmt == fmt)\r\nreturn 0;\r\nif ((mmp_sspa_read_reg(sspa, SSPA_TXSP) & SSPA_SP_S_EN) ||\r\n(mmp_sspa_read_reg(sspa, SSPA_RXSP) & SSPA_SP_S_EN)) {\r\ndev_err(&sspa->pdev->dev,\r\n"can't change hardware dai format: stream is in use\n");\r\nreturn -EINVAL;\r\n}\r\nsspa_sp = SSPA_SP_WEN | SSPA_SP_S_RST | SSPA_SP_FFLUSH;\r\nsspa_ctrl = 0;\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\nsspa_sp |= SSPA_SP_MSL;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\r\ncase SND_SOC_DAIFMT_NB_NF:\r\nsspa_sp |= SSPA_SP_FSP;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\nsspa_sp |= SSPA_TXSP_FPER(63);\r\nsspa_sp |= SSPA_SP_FWID(31);\r\nsspa_ctrl |= SSPA_CTL_XDATDLY(1);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nmmp_sspa_write_reg(sspa, SSPA_TXSP, sspa_sp);\r\nmmp_sspa_write_reg(sspa, SSPA_RXSP, sspa_sp);\r\nsspa_sp &= ~(SSPA_SP_S_RST | SSPA_SP_FFLUSH);\r\nmmp_sspa_write_reg(sspa, SSPA_TXSP, sspa_sp);\r\nmmp_sspa_write_reg(sspa, SSPA_RXSP, sspa_sp);\r\nsspa_sp &= ~SSPA_SP_MSL;\r\nmmp_sspa_write_reg(sspa, SSPA_TXSP, sspa_sp);\r\nmmp_sspa_write_reg(sspa, SSPA_TXCTL, sspa_ctrl);\r\nmmp_sspa_write_reg(sspa, SSPA_RXCTL, sspa_ctrl);\r\nsspa_priv->dai_fmt = fmt;\r\nreturn 0;\r\n}\r\nstatic int mmp_sspa_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nstruct sspa_priv *sspa_priv = snd_soc_dai_get_drvdata(dai);\r\nstruct ssp_device *sspa = sspa_priv->sspa;\r\nstruct snd_dmaengine_dai_dma_data *dma_params;\r\nu32 sspa_ctrl;\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nsspa_ctrl = mmp_sspa_read_reg(sspa, SSPA_TXCTL);\r\nelse\r\nsspa_ctrl = mmp_sspa_read_reg(sspa, SSPA_RXCTL);\r\nsspa_ctrl &= ~SSPA_CTL_XFRLEN1_MASK;\r\nsspa_ctrl |= SSPA_CTL_XFRLEN1(params_channels(params) - 1);\r\nsspa_ctrl &= ~SSPA_CTL_XWDLEN1_MASK;\r\nsspa_ctrl |= SSPA_CTL_XWDLEN1(SSPA_CTL_32_BITS);\r\nsspa_ctrl &= ~SSPA_CTL_XSSZ1_MASK;\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S8:\r\nsspa_ctrl |= SSPA_CTL_XSSZ1(SSPA_CTL_8_BITS);\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\nsspa_ctrl |= SSPA_CTL_XSSZ1(SSPA_CTL_16_BITS);\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S20_3LE:\r\nsspa_ctrl |= SSPA_CTL_XSSZ1(SSPA_CTL_20_BITS);\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S24_3LE:\r\nsspa_ctrl |= SSPA_CTL_XSSZ1(SSPA_CTL_24_BITS);\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S32_LE:\r\nsspa_ctrl |= SSPA_CTL_XSSZ1(SSPA_CTL_32_BITS);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nmmp_sspa_write_reg(sspa, SSPA_TXCTL, sspa_ctrl);\r\nmmp_sspa_write_reg(sspa, SSPA_TXFIFO_LL, 0x1);\r\n} else {\r\nmmp_sspa_write_reg(sspa, SSPA_RXCTL, sspa_ctrl);\r\nmmp_sspa_write_reg(sspa, SSPA_RXFIFO_UL, 0x0);\r\n}\r\ndma_params = &sspa_priv->dma_params[substream->stream];\r\ndma_params->addr = substream->stream == SNDRV_PCM_STREAM_PLAYBACK ?\r\n(sspa->phys_base + SSPA_TXD) :\r\n(sspa->phys_base + SSPA_RXD);\r\nsnd_soc_dai_set_dma_data(cpu_dai, substream, dma_params);\r\nreturn 0;\r\n}\r\nstatic int mmp_sspa_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct sspa_priv *sspa_priv = snd_soc_dai_get_drvdata(dai);\r\nstruct ssp_device *sspa = sspa_priv->sspa;\r\nint ret = 0;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nif (!sspa_priv->running_cnt)\r\nmmp_sspa_rx_enable(sspa);\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nmmp_sspa_tx_enable(sspa);\r\nsspa_priv->running_cnt++;\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nsspa_priv->running_cnt--;\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nmmp_sspa_tx_disable(sspa);\r\nif (!sspa_priv->running_cnt)\r\nmmp_sspa_rx_disable(sspa);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic int mmp_sspa_probe(struct snd_soc_dai *dai)\r\n{\r\nstruct sspa_priv *priv = dev_get_drvdata(dai->dev);\r\nsnd_soc_dai_set_drvdata(dai, priv);\r\nreturn 0;\r\n}\r\nstatic int asoc_mmp_sspa_probe(struct platform_device *pdev)\r\n{\r\nstruct sspa_priv *priv;\r\nstruct resource *res;\r\npriv = devm_kzalloc(&pdev->dev,\r\nsizeof(struct sspa_priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->sspa = devm_kzalloc(&pdev->dev,\r\nsizeof(struct ssp_device), GFP_KERNEL);\r\nif (priv->sspa == NULL)\r\nreturn -ENOMEM;\r\npriv->dma_params = devm_kzalloc(&pdev->dev,\r\n2 * sizeof(struct snd_dmaengine_dai_dma_data),\r\nGFP_KERNEL);\r\nif (priv->dma_params == NULL)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->sspa->mmio_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->sspa->mmio_base))\r\nreturn PTR_ERR(priv->sspa->mmio_base);\r\npriv->sspa->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(priv->sspa->clk))\r\nreturn PTR_ERR(priv->sspa->clk);\r\npriv->audio_clk = clk_get(NULL, "mmp-audio");\r\nif (IS_ERR(priv->audio_clk))\r\nreturn PTR_ERR(priv->audio_clk);\r\npriv->sysclk = clk_get(NULL, "mmp-sysclk");\r\nif (IS_ERR(priv->sysclk)) {\r\nclk_put(priv->audio_clk);\r\nreturn PTR_ERR(priv->sysclk);\r\n}\r\nclk_enable(priv->audio_clk);\r\npriv->dai_fmt = (unsigned int) -1;\r\nplatform_set_drvdata(pdev, priv);\r\nreturn devm_snd_soc_register_component(&pdev->dev, &mmp_sspa_component,\r\n&mmp_sspa_dai, 1);\r\n}\r\nstatic int asoc_mmp_sspa_remove(struct platform_device *pdev)\r\n{\r\nstruct sspa_priv *priv = platform_get_drvdata(pdev);\r\nclk_disable(priv->audio_clk);\r\nclk_put(priv->audio_clk);\r\nclk_put(priv->sysclk);\r\nreturn 0;\r\n}

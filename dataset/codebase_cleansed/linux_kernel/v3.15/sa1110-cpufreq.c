static inline u_int ns_to_cycles(u_int ns, u_int khz)\r\n{\r\nreturn (ns * khz + 999999) / 1000000;\r\n}\r\nstatic inline void set_mdcas(u_int *mdcas, int delayed, u_int rcd)\r\n{\r\nu_int shift;\r\nrcd = 2 * rcd - 1;\r\nshift = delayed + 1 + rcd;\r\nmdcas[0] = (1 << rcd) - 1;\r\nmdcas[0] |= 0x55555555 << shift;\r\nmdcas[1] = mdcas[2] = 0x55555555 << (shift & 1);\r\n}\r\nstatic void\r\nsdram_calculate_timing(struct sdram_info *sd, u_int cpu_khz,\r\nstruct sdram_params *sdram)\r\n{\r\nu_int mem_khz, sd_khz, trp, twr;\r\nmem_khz = cpu_khz / 2;\r\nsd_khz = mem_khz;\r\nif ((ns_to_cycles(sdram->tck, sd_khz) > 1) ||\r\n(CPU_REVISION < CPU_SA1110_B2 && sd_khz < 62000))\r\nsd_khz /= 2;\r\nsd->mdcnfg = MDCNFG & 0x007f007f;\r\ntwr = ns_to_cycles(sdram->twr, mem_khz);\r\ntrp = ns_to_cycles(sdram->trp, mem_khz) - 1;\r\nif (trp < 1)\r\ntrp = 1;\r\nsd->mdcnfg |= trp << 8;\r\nsd->mdcnfg |= trp << 24;\r\nsd->mdcnfg |= sdram->cas_latency << 12;\r\nsd->mdcnfg |= sdram->cas_latency << 28;\r\nsd->mdcnfg |= twr << 14;\r\nsd->mdcnfg |= twr << 30;\r\nsd->mdrefr = MDREFR & 0xffbffff0;\r\nsd->mdrefr |= 7;\r\nif (sd_khz != mem_khz)\r\nsd->mdrefr |= MDREFR_K1DB2;\r\nset_mdcas(sd->mdcas, sd_khz >= 62000,\r\nns_to_cycles(sdram->trcd, mem_khz));\r\n#ifdef DEBUG\r\nprintk(KERN_DEBUG "MDCNFG: %08x MDREFR: %08x MDCAS0: %08x MDCAS1: %08x MDCAS2: %08x\n",\r\nsd->mdcnfg, sd->mdrefr, sd->mdcas[0], sd->mdcas[1],\r\nsd->mdcas[2]);\r\n#endif\r\n}\r\nstatic inline void sdram_set_refresh(u_int dri)\r\n{\r\nMDREFR = (MDREFR & 0xffff000f) | (dri << 4);\r\n(void) MDREFR;\r\n}\r\nstatic void\r\nsdram_update_refresh(u_int cpu_khz, struct sdram_params *sdram)\r\n{\r\nu_int ns_row = (sdram->refresh * 1000) >> sdram->rows;\r\nu_int dri = ns_to_cycles(ns_row, cpu_khz / 2) / 32;\r\n#ifdef DEBUG\r\nmdelay(250);\r\nprintk(KERN_DEBUG "new dri value = %d\n", dri);\r\n#endif\r\nsdram_set_refresh(dri);\r\n}\r\nstatic int sa1110_target(struct cpufreq_policy *policy, unsigned int ppcr)\r\n{\r\nstruct sdram_params *sdram = &sdram_params;\r\nstruct sdram_info sd;\r\nunsigned long flags;\r\nunsigned int unused;\r\nsdram_calculate_timing(&sd, sa11x0_freq_table[ppcr].frequency, sdram);\r\n#if 0\r\nif (policy->max < 147500) {\r\nsd.mdrefr |= MDREFR_K1DB2;\r\nsd.mdcas[0] = 0xaaaaaa7f;\r\n} else {\r\nsd.mdrefr &= ~MDREFR_K1DB2;\r\nsd.mdcas[0] = 0xaaaaaa9f;\r\n}\r\nsd.mdcas[1] = 0xaaaaaaaa;\r\nsd.mdcas[2] = 0xaaaaaaaa;\r\n#endif\r\nsdram_set_refresh(2);\r\nif (!irqs_disabled())\r\nmsleep(20);\r\nelse\r\nmdelay(20);\r\nlocal_irq_save(flags);\r\nasm("mcr p15, 0, %0, c7, c10, 4" : : "r" (0));\r\nudelay(10);\r\n__asm__ __volatile__("\n\\r\nb 2f \n\\r\n.align 5 \n\\r\n1: str %3, [%1, #0] @ MDCNFG \n\\r\nstr %4, [%1, #28] @ MDREFR \n\\r\nstr %5, [%1, #4] @ MDCAS0 \n\\r\nstr %6, [%1, #8] @ MDCAS1 \n\\r\nstr %7, [%1, #12] @ MDCAS2 \n\\r\nstr %8, [%2, #0] @ PPCR \n\\r\nldr %0, [%1, #0] \n\\r\nb 3f \n\\r\n2: b 1b \n\\r\n3: nop \n\\r\nnop"\r\n: "=&r" (unused)\r\n: "r" (&MDCNFG), "r" (&PPCR), "0" (sd.mdcnfg),\r\n"r" (sd.mdrefr), "r" (sd.mdcas[0]),\r\n"r" (sd.mdcas[1]), "r" (sd.mdcas[2]), "r" (ppcr));\r\nlocal_irq_restore(flags);\r\nsdram_update_refresh(sa11x0_freq_table[ppcr].frequency, sdram);\r\nreturn 0;\r\n}\r\nstatic int __init sa1110_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nreturn cpufreq_generic_init(policy, sa11x0_freq_table, CPUFREQ_ETERNAL);\r\n}\r\nstatic struct sdram_params *sa1110_find_sdram(const char *name)\r\n{\r\nstruct sdram_params *sdram;\r\nfor (sdram = sdram_tbl; sdram < sdram_tbl + ARRAY_SIZE(sdram_tbl);\r\nsdram++)\r\nif (strcmp(name, sdram->name) == 0)\r\nreturn sdram;\r\nreturn NULL;\r\n}\r\nstatic int __init sa1110_clk_init(void)\r\n{\r\nstruct sdram_params *sdram;\r\nconst char *name = sdram_name;\r\nif (!cpu_is_sa1110())\r\nreturn -ENODEV;\r\nif (!name[0]) {\r\nif (machine_is_assabet())\r\nname = "TC59SM716-CL3";\r\nif (machine_is_pt_system3())\r\nname = "K4S641632D";\r\nif (machine_is_h3100())\r\nname = "KM416S4030CT";\r\nif (machine_is_jornada720())\r\nname = "K4S281632B-1H";\r\nif (machine_is_nanoengine())\r\nname = "MT48LC8M16A2TG-75";\r\n}\r\nsdram = sa1110_find_sdram(name);\r\nif (sdram) {\r\nprintk(KERN_DEBUG "SDRAM: tck: %d trcd: %d trp: %d"\r\n" twr: %d refresh: %d cas_latency: %d\n",\r\nsdram->tck, sdram->trcd, sdram->trp,\r\nsdram->twr, sdram->refresh, sdram->cas_latency);\r\nmemcpy(&sdram_params, sdram, sizeof(sdram_params));\r\nreturn cpufreq_register_driver(&sa1110_driver);\r\n}\r\nreturn 0;\r\n}

static inline struct target_type *__find_target_type(const char *name)\r\n{\r\nstruct target_type *tt;\r\nlist_for_each_entry(tt, &_targets, list)\r\nif (!strcmp(name, tt->name))\r\nreturn tt;\r\nreturn NULL;\r\n}\r\nstatic struct target_type *get_target_type(const char *name)\r\n{\r\nstruct target_type *tt;\r\ndown_read(&_lock);\r\ntt = __find_target_type(name);\r\nif (tt && !try_module_get(tt->module))\r\ntt = NULL;\r\nup_read(&_lock);\r\nreturn tt;\r\n}\r\nstatic void load_module(const char *name)\r\n{\r\nrequest_module("dm-%s", name);\r\n}\r\nstruct target_type *dm_get_target_type(const char *name)\r\n{\r\nstruct target_type *tt = get_target_type(name);\r\nif (!tt) {\r\nload_module(name);\r\ntt = get_target_type(name);\r\n}\r\nreturn tt;\r\n}\r\nvoid dm_put_target_type(struct target_type *tt)\r\n{\r\ndown_read(&_lock);\r\nmodule_put(tt->module);\r\nup_read(&_lock);\r\n}\r\nint dm_target_iterate(void (*iter_func)(struct target_type *tt,\r\nvoid *param), void *param)\r\n{\r\nstruct target_type *tt;\r\ndown_read(&_lock);\r\nlist_for_each_entry(tt, &_targets, list)\r\niter_func(tt, param);\r\nup_read(&_lock);\r\nreturn 0;\r\n}\r\nint dm_register_target(struct target_type *tt)\r\n{\r\nint rv = 0;\r\ndown_write(&_lock);\r\nif (__find_target_type(tt->name))\r\nrv = -EEXIST;\r\nelse\r\nlist_add(&tt->list, &_targets);\r\nup_write(&_lock);\r\nreturn rv;\r\n}\r\nvoid dm_unregister_target(struct target_type *tt)\r\n{\r\ndown_write(&_lock);\r\nif (!__find_target_type(tt->name)) {\r\nDMCRIT("Unregistering unrecognised target: %s", tt->name);\r\nBUG();\r\n}\r\nlist_del(&tt->list);\r\nup_write(&_lock);\r\n}\r\nstatic int io_err_ctr(struct dm_target *tt, unsigned int argc, char **args)\r\n{\r\ntt->num_discard_bios = 1;\r\nreturn 0;\r\n}\r\nstatic void io_err_dtr(struct dm_target *tt)\r\n{\r\n}\r\nstatic int io_err_map(struct dm_target *tt, struct bio *bio)\r\n{\r\nreturn -EIO;\r\n}\r\nstatic int io_err_map_rq(struct dm_target *ti, struct request *clone,\r\nunion map_info *map_context)\r\n{\r\nreturn -EIO;\r\n}\r\nint __init dm_target_init(void)\r\n{\r\nreturn dm_register_target(&error_target);\r\n}\r\nvoid dm_target_exit(void)\r\n{\r\ndm_unregister_target(&error_target);\r\n}

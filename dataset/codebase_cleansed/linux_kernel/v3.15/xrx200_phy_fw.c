static dma_addr_t xway_gphy_load(struct platform_device *pdev)\r\n{\r\nconst struct firmware *fw;\r\ndma_addr_t dev_addr = 0;\r\nconst char *fw_name;\r\nvoid *fw_addr;\r\nsize_t size;\r\nif (of_property_read_string(pdev->dev.of_node, "firmware", &fw_name)) {\r\ndev_err(&pdev->dev, "failed to load firmware filename\n");\r\nreturn 0;\r\n}\r\ndev_info(&pdev->dev, "requesting %s\n", fw_name);\r\nif (request_firmware(&fw, fw_name, &pdev->dev)) {\r\ndev_err(&pdev->dev, "failed to load firmware: %s\n", fw_name);\r\nreturn 0;\r\n}\r\nsize = fw->size + XRX200_GPHY_FW_ALIGN;\r\nfw_addr = dma_alloc_coherent(&pdev->dev, size, &dev_addr, GFP_KERNEL);\r\nif (fw_addr) {\r\nfw_addr = PTR_ALIGN(fw_addr, XRX200_GPHY_FW_ALIGN);\r\ndev_addr = ALIGN(dev_addr, XRX200_GPHY_FW_ALIGN);\r\nmemcpy(fw_addr, fw->data, fw->size);\r\n} else {\r\ndev_err(&pdev->dev, "failed to alloc firmware memory\n");\r\n}\r\nrelease_firmware(fw);\r\nreturn dev_addr;\r\n}\r\nstatic int xway_phy_fw_probe(struct platform_device *pdev)\r\n{\r\ndma_addr_t fw_addr;\r\nstruct property *pp;\r\nunsigned char *phyids;\r\nint i, ret = 0;\r\nfw_addr = xway_gphy_load(pdev);\r\nif (!fw_addr)\r\nreturn -EINVAL;\r\npp = of_find_property(pdev->dev.of_node, "phys", NULL);\r\nif (!pp)\r\nreturn -ENOENT;\r\nphyids = pp->value;\r\nfor (i = 0; i < pp->length && !ret; i++)\r\nret = xrx200_gphy_boot(&pdev->dev, phyids[i], fw_addr);\r\nif (!ret)\r\nmdelay(100);\r\nreturn ret;\r\n}

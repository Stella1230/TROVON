static void snd_gf1_default_interrupt_handler_midi_out(struct snd_gus_card * gus)\r\n{\r\nsnd_gf1_uart_cmd(gus, gus->gf1.uart_cmd &= ~0x20);\r\n}\r\nstatic void snd_gf1_default_interrupt_handler_midi_in(struct snd_gus_card * gus)\r\n{\r\nsnd_gf1_uart_cmd(gus, gus->gf1.uart_cmd &= ~0x80);\r\n}\r\nstatic void snd_gf1_default_interrupt_handler_timer1(struct snd_gus_card * gus)\r\n{\r\nsnd_gf1_i_write8(gus, SNDRV_GF1_GB_SOUND_BLASTER_CONTROL, gus->gf1.timer_enabled &= ~4);\r\n}\r\nstatic void snd_gf1_default_interrupt_handler_timer2(struct snd_gus_card * gus)\r\n{\r\nsnd_gf1_i_write8(gus, SNDRV_GF1_GB_SOUND_BLASTER_CONTROL, gus->gf1.timer_enabled &= ~8);\r\n}\r\nstatic void snd_gf1_default_interrupt_handler_wave_and_volume(struct snd_gus_card * gus, struct snd_gus_voice * voice)\r\n{\r\nsnd_gf1_i_ctrl_stop(gus, 0x00);\r\nsnd_gf1_i_ctrl_stop(gus, 0x0d);\r\n}\r\nstatic void snd_gf1_default_interrupt_handler_dma_write(struct snd_gus_card * gus)\r\n{\r\nsnd_gf1_i_write8(gus, 0x41, 0x00);\r\n}\r\nstatic void snd_gf1_default_interrupt_handler_dma_read(struct snd_gus_card * gus)\r\n{\r\nsnd_gf1_i_write8(gus, 0x49, 0x00);\r\n}\r\nvoid snd_gf1_set_default_handlers(struct snd_gus_card * gus, unsigned int what)\r\n{\r\nif (what & SNDRV_GF1_HANDLER_MIDI_OUT)\r\ngus->gf1.interrupt_handler_midi_out = snd_gf1_default_interrupt_handler_midi_out;\r\nif (what & SNDRV_GF1_HANDLER_MIDI_IN)\r\ngus->gf1.interrupt_handler_midi_in = snd_gf1_default_interrupt_handler_midi_in;\r\nif (what & SNDRV_GF1_HANDLER_TIMER1)\r\ngus->gf1.interrupt_handler_timer1 = snd_gf1_default_interrupt_handler_timer1;\r\nif (what & SNDRV_GF1_HANDLER_TIMER2)\r\ngus->gf1.interrupt_handler_timer2 = snd_gf1_default_interrupt_handler_timer2;\r\nif (what & SNDRV_GF1_HANDLER_VOICE) {\r\nstruct snd_gus_voice *voice;\r\nvoice = &gus->gf1.voices[what & 0xffff];\r\nvoice->handler_wave =\r\nvoice->handler_volume = snd_gf1_default_interrupt_handler_wave_and_volume;\r\nvoice->handler_effect = NULL;\r\nvoice->volume_change = NULL;\r\n}\r\nif (what & SNDRV_GF1_HANDLER_DMA_WRITE)\r\ngus->gf1.interrupt_handler_dma_write = snd_gf1_default_interrupt_handler_dma_write;\r\nif (what & SNDRV_GF1_HANDLER_DMA_READ)\r\ngus->gf1.interrupt_handler_dma_read = snd_gf1_default_interrupt_handler_dma_read;\r\n}\r\nstatic void snd_gf1_clear_regs(struct snd_gus_card * gus)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\ninb(GUSP(gus, IRQSTAT));\r\nsnd_gf1_write8(gus, 0x41, 0);\r\nsnd_gf1_write8(gus, 0x45, 0);\r\nsnd_gf1_write8(gus, 0x49, 0);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\n}\r\nstatic void snd_gf1_look_regs(struct snd_gus_card * gus)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\nsnd_gf1_look8(gus, 0x41);\r\nsnd_gf1_look8(gus, 0x49);\r\ninb(GUSP(gus, IRQSTAT));\r\nsnd_gf1_read8(gus, 0x0f);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\n}\r\nvoid snd_gf1_smart_stop_voice(struct snd_gus_card * gus, unsigned short voice)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\nsnd_gf1_select_voice(gus, voice);\r\n#if 0\r\nprintk(KERN_DEBUG " -%i- smart stop voice - volume = 0x%x\n", voice, snd_gf1_i_read16(gus, SNDRV_GF1_VW_VOLUME));\r\n#endif\r\nsnd_gf1_ctrl_stop(gus, SNDRV_GF1_VB_ADDRESS_CONTROL);\r\nsnd_gf1_ctrl_stop(gus, SNDRV_GF1_VB_VOLUME_CONTROL);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\n}\r\nvoid snd_gf1_stop_voice(struct snd_gus_card * gus, unsigned short voice)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\nsnd_gf1_select_voice(gus, voice);\r\n#if 0\r\nprintk(KERN_DEBUG " -%i- stop voice - volume = 0x%x\n", voice, snd_gf1_i_read16(gus, SNDRV_GF1_VW_VOLUME));\r\n#endif\r\nsnd_gf1_ctrl_stop(gus, SNDRV_GF1_VB_ADDRESS_CONTROL);\r\nsnd_gf1_ctrl_stop(gus, SNDRV_GF1_VB_VOLUME_CONTROL);\r\nif (gus->gf1.enh_mode)\r\nsnd_gf1_write8(gus, SNDRV_GF1_VB_ACCUMULATOR, 0);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\n#if 0\r\nsnd_gf1_lfo_shutdown(gus, voice, ULTRA_LFO_VIBRATO);\r\nsnd_gf1_lfo_shutdown(gus, voice, ULTRA_LFO_TREMOLO);\r\n#endif\r\n}\r\nstatic void snd_gf1_clear_voices(struct snd_gus_card * gus, unsigned short v_min,\r\nunsigned short v_max)\r\n{\r\nunsigned long flags;\r\nunsigned int daddr;\r\nunsigned short i, w_16;\r\ndaddr = gus->gf1.default_voice_address << 4;\r\nfor (i = v_min; i <= v_max; i++) {\r\n#if 0\r\nif (gus->gf1.syn_voices)\r\ngus->gf1.syn_voices[i].flags = ~VFLG_DYNAMIC;\r\n#endif\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\nsnd_gf1_select_voice(gus, i);\r\nsnd_gf1_ctrl_stop(gus, SNDRV_GF1_VB_ADDRESS_CONTROL);\r\nsnd_gf1_ctrl_stop(gus, SNDRV_GF1_VB_VOLUME_CONTROL);\r\nif (gus->gf1.enh_mode)\r\nsnd_gf1_write8(gus, SNDRV_GF1_VB_MODE, gus->gf1.memory ? 0x02 : 0x82);\r\nw_16 = snd_gf1_read8(gus, SNDRV_GF1_VB_ADDRESS_CONTROL) & 0x04;\r\nsnd_gf1_write16(gus, SNDRV_GF1_VW_FREQUENCY, 0x400);\r\nsnd_gf1_write_addr(gus, SNDRV_GF1_VA_START, daddr, w_16);\r\nsnd_gf1_write_addr(gus, SNDRV_GF1_VA_END, daddr, w_16);\r\nsnd_gf1_write8(gus, SNDRV_GF1_VB_VOLUME_START, 0);\r\nsnd_gf1_write8(gus, SNDRV_GF1_VB_VOLUME_END, 0);\r\nsnd_gf1_write8(gus, SNDRV_GF1_VB_VOLUME_RATE, 0);\r\nsnd_gf1_write16(gus, SNDRV_GF1_VW_VOLUME, 0);\r\nsnd_gf1_write_addr(gus, SNDRV_GF1_VA_CURRENT, daddr, w_16);\r\nsnd_gf1_write8(gus, SNDRV_GF1_VB_PAN, 7);\r\nif (gus->gf1.enh_mode) {\r\nsnd_gf1_write8(gus, SNDRV_GF1_VB_ACCUMULATOR, 0);\r\nsnd_gf1_write16(gus, SNDRV_GF1_VW_EFFECT_VOLUME, 0);\r\nsnd_gf1_write16(gus, SNDRV_GF1_VW_EFFECT_VOLUME_FINAL, 0);\r\n}\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\n#if 0\r\nsnd_gf1_lfo_shutdown(gus, i, ULTRA_LFO_VIBRATO);\r\nsnd_gf1_lfo_shutdown(gus, i, ULTRA_LFO_TREMOLO);\r\n#endif\r\n}\r\n}\r\nvoid snd_gf1_stop_voices(struct snd_gus_card * gus, unsigned short v_min, unsigned short v_max)\r\n{\r\nunsigned long flags;\r\nshort i, ramp_ok;\r\nunsigned short ramp_end;\r\nif (!in_interrupt()) {\r\nfor (i = v_min, ramp_ok = 0; i <= v_max; i++) {\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\nsnd_gf1_select_voice(gus, i);\r\nramp_end = snd_gf1_read16(gus, 9) >> 8;\r\nif (ramp_end > SNDRV_GF1_MIN_OFFSET) {\r\nramp_ok++;\r\nsnd_gf1_write8(gus, SNDRV_GF1_VB_VOLUME_RATE, 20);\r\nsnd_gf1_write8(gus, SNDRV_GF1_VB_VOLUME_START, SNDRV_GF1_MIN_OFFSET);\r\nsnd_gf1_write8(gus, SNDRV_GF1_VB_VOLUME_END, ramp_end);\r\nsnd_gf1_write8(gus, SNDRV_GF1_VB_VOLUME_CONTROL, 0x40);\r\nif (gus->gf1.enh_mode) {\r\nsnd_gf1_delay(gus);\r\nsnd_gf1_write8(gus, SNDRV_GF1_VB_VOLUME_CONTROL, 0x40);\r\n}\r\n}\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\n}\r\nmsleep_interruptible(50);\r\n}\r\nsnd_gf1_clear_voices(gus, v_min, v_max);\r\n}\r\nstatic void snd_gf1_alloc_voice_use(struct snd_gus_card * gus,\r\nstruct snd_gus_voice * pvoice,\r\nint type, int client, int port)\r\n{\r\npvoice->use = 1;\r\nswitch (type) {\r\ncase SNDRV_GF1_VOICE_TYPE_PCM:\r\ngus->gf1.pcm_alloc_voices++;\r\npvoice->pcm = 1;\r\nbreak;\r\ncase SNDRV_GF1_VOICE_TYPE_SYNTH:\r\npvoice->synth = 1;\r\npvoice->client = client;\r\npvoice->port = port;\r\nbreak;\r\ncase SNDRV_GF1_VOICE_TYPE_MIDI:\r\npvoice->midi = 1;\r\npvoice->client = client;\r\npvoice->port = port;\r\nbreak;\r\n}\r\n}\r\nstruct snd_gus_voice *snd_gf1_alloc_voice(struct snd_gus_card * gus, int type, int client, int port)\r\n{\r\nstruct snd_gus_voice *pvoice;\r\nunsigned long flags;\r\nint idx;\r\nspin_lock_irqsave(&gus->voice_alloc, flags);\r\nif (type == SNDRV_GF1_VOICE_TYPE_PCM) {\r\nif (gus->gf1.pcm_alloc_voices >= gus->gf1.pcm_channels) {\r\nspin_unlock_irqrestore(&gus->voice_alloc, flags);\r\nreturn NULL;\r\n}\r\n}\r\nfor (idx = 0; idx < 32; idx++) {\r\npvoice = &gus->gf1.voices[idx];\r\nif (!pvoice->use) {\r\nsnd_gf1_alloc_voice_use(gus, pvoice, type, client, port);\r\nspin_unlock_irqrestore(&gus->voice_alloc, flags);\r\nreturn pvoice;\r\n}\r\n}\r\nfor (idx = 0; idx < 32; idx++) {\r\npvoice = &gus->gf1.voices[idx];\r\nif (pvoice->midi && !pvoice->client) {\r\nsnd_gf1_clear_voices(gus, pvoice->number, pvoice->number);\r\nsnd_gf1_alloc_voice_use(gus, pvoice, type, client, port);\r\nspin_unlock_irqrestore(&gus->voice_alloc, flags);\r\nreturn pvoice;\r\n}\r\n}\r\nspin_unlock_irqrestore(&gus->voice_alloc, flags);\r\nreturn NULL;\r\n}\r\nvoid snd_gf1_free_voice(struct snd_gus_card * gus, struct snd_gus_voice *voice)\r\n{\r\nunsigned long flags;\r\nvoid (*private_free)(struct snd_gus_voice *voice);\r\nvoid *private_data;\r\nif (voice == NULL || !voice->use)\r\nreturn;\r\nsnd_gf1_set_default_handlers(gus, SNDRV_GF1_HANDLER_VOICE | voice->number);\r\nsnd_gf1_clear_voices(gus, voice->number, voice->number);\r\nspin_lock_irqsave(&gus->voice_alloc, flags);\r\nprivate_free = voice->private_free;\r\nprivate_data = voice->private_data;\r\nvoice->private_free = NULL;\r\nvoice->private_data = NULL;\r\nif (voice->pcm)\r\ngus->gf1.pcm_alloc_voices--;\r\nvoice->use = voice->pcm = 0;\r\nvoice->sample_ops = NULL;\r\nspin_unlock_irqrestore(&gus->voice_alloc, flags);\r\nif (private_free)\r\nprivate_free(voice);\r\n}\r\nint snd_gf1_start(struct snd_gus_card * gus)\r\n{\r\nunsigned long flags;\r\nunsigned int i;\r\nsnd_gf1_i_write8(gus, SNDRV_GF1_GB_RESET, 0);\r\nudelay(160);\r\nsnd_gf1_i_write8(gus, SNDRV_GF1_GB_RESET, 1);\r\nudelay(160);\r\nsnd_gf1_i_write8(gus, SNDRV_GF1_GB_JOYSTICK_DAC_LEVEL, gus->joystick_dac);\r\nsnd_gf1_set_default_handlers(gus, SNDRV_GF1_HANDLER_ALL);\r\nfor (i = 0; i < 32; i++) {\r\ngus->gf1.voices[i].number = i;\r\nsnd_gf1_set_default_handlers(gus, SNDRV_GF1_HANDLER_VOICE | i);\r\n}\r\nsnd_gf1_uart_cmd(gus, 0x03);\r\nif (gus->gf1.enh_mode) {\r\nsnd_gf1_i_write8(gus, SNDRV_GF1_GB_GLOBAL_MODE, snd_gf1_i_look8(gus, SNDRV_GF1_GB_GLOBAL_MODE) | 0x01);\r\nsnd_gf1_i_write8(gus, SNDRV_GF1_GB_MEMORY_CONTROL, 0x01);\r\n}\r\nsnd_gf1_clear_regs(gus);\r\nsnd_gf1_select_active_voices(gus);\r\nsnd_gf1_delay(gus);\r\ngus->gf1.default_voice_address = gus->gf1.memory > 0 ? 0 : 512 - 8;\r\nif (gus->gf1.enh_mode && gus->gf1.memory) {\r\ngus->gf1.hw_lfo = 1;\r\ngus->gf1.default_voice_address += 1024;\r\n} else {\r\ngus->gf1.sw_lfo = 1;\r\n}\r\n#if 0\r\nsnd_gf1_lfo_init(gus);\r\n#endif\r\nif (gus->gf1.memory > 0)\r\nfor (i = 0; i < 4; i++)\r\nsnd_gf1_poke(gus, gus->gf1.default_voice_address + i, 0);\r\nsnd_gf1_clear_regs(gus);\r\nsnd_gf1_clear_voices(gus, 0, 31);\r\nsnd_gf1_look_regs(gus);\r\nudelay(160);\r\nsnd_gf1_i_write8(gus, SNDRV_GF1_GB_RESET, 7);\r\nudelay(160);\r\nsnd_gf1_i_write8(gus, SNDRV_GF1_GB_RESET, 7);\r\nif (gus->gf1.enh_mode) {\r\nsnd_gf1_i_write8(gus, SNDRV_GF1_GB_GLOBAL_MODE, snd_gf1_i_look8(gus, SNDRV_GF1_GB_GLOBAL_MODE) | 0x01);\r\nsnd_gf1_i_write8(gus, SNDRV_GF1_GB_MEMORY_CONTROL, 0x01);\r\n}\r\nwhile ((snd_gf1_i_read8(gus, SNDRV_GF1_GB_VOICES_IRQ) & 0xc0) != 0xc0);\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\noutb(gus->gf1.active_voice = 0, GUSP(gus, GF1PAGE));\r\noutb(gus->mix_cntrl_reg, GUSP(gus, MIXCNTRLREG));\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\nsnd_gf1_timers_init(gus);\r\nsnd_gf1_look_regs(gus);\r\nsnd_gf1_mem_init(gus);\r\nsnd_gf1_mem_proc_init(gus);\r\n#ifdef CONFIG_SND_DEBUG\r\nsnd_gus_irq_profile_init(gus);\r\n#endif\r\n#if 0\r\nif (gus->pnp_flag) {\r\nif (gus->chip.playback_fifo_size > 0)\r\nsnd_gf1_i_write16(gus, SNDRV_GF1_GW_FIFO_RECORD_BASE_ADDR, gus->chip.playback_fifo_block->ptr >> 8);\r\nif (gus->chip.record_fifo_size > 0)\r\nsnd_gf1_i_write16(gus, SNDRV_GF1_GW_FIFO_PLAY_BASE_ADDR, gus->chip.record_fifo_block->ptr >> 8);\r\nsnd_gf1_i_write16(gus, SNDRV_GF1_GW_FIFO_SIZE, gus->chip.interwave_fifo_reg);\r\n}\r\n#endif\r\nreturn 0;\r\n}\r\nint snd_gf1_stop(struct snd_gus_card * gus)\r\n{\r\nsnd_gf1_i_write8(gus, SNDRV_GF1_GB_SOUND_BLASTER_CONTROL, 0);\r\nsnd_gf1_stop_voices(gus, 0, 31);\r\nsnd_gf1_i_write8(gus, SNDRV_GF1_GB_RESET, 1);\r\nsnd_gf1_timers_done(gus);\r\nsnd_gf1_mem_done(gus);\r\n#if 0\r\nsnd_gf1_lfo_done(gus);\r\n#endif\r\nreturn 0;\r\n}

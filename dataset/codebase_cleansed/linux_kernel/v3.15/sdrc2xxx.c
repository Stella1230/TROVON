static u32 omap2xxx_sdrc_get_slow_dll_ctrl(void)\r\n{\r\nreturn mem_timings.slow_dll_ctrl;\r\n}\r\nstatic u32 omap2xxx_sdrc_get_fast_dll_ctrl(void)\r\n{\r\nreturn mem_timings.fast_dll_ctrl;\r\n}\r\nstatic u32 omap2xxx_sdrc_get_type(void)\r\n{\r\nreturn mem_timings.m_type;\r\n}\r\nu32 omap2xxx_sdrc_dll_is_unlocked(void)\r\n{\r\nu32 dll_state = sdrc_read_reg(SDRC_DLLA_CTRL);\r\nif ((dll_state & (1 << 2)) == (1 << 2))\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nu32 omap2xxx_sdrc_reprogram(u32 level, u32 force)\r\n{\r\nu32 dll_ctrl, m_type;\r\nu32 prev = curr_perf_level;\r\nunsigned long flags;\r\nif ((curr_perf_level == level) && !force)\r\nreturn prev;\r\nif (level == CORE_CLK_SRC_DPLL)\r\ndll_ctrl = omap2xxx_sdrc_get_slow_dll_ctrl();\r\nelse if (level == CORE_CLK_SRC_DPLL_X2)\r\ndll_ctrl = omap2xxx_sdrc_get_fast_dll_ctrl();\r\nelse\r\nreturn prev;\r\nm_type = omap2xxx_sdrc_get_type();\r\nlocal_irq_save(flags);\r\nif (cpu_is_omap2420())\r\n__raw_writel(0xffff, OMAP2420_PRCM_VOLTSETUP);\r\nelse\r\n__raw_writel(0xffff, OMAP2430_PRCM_VOLTSETUP);\r\nomap2_sram_reprogram_sdrc(level, dll_ctrl, m_type);\r\ncurr_perf_level = level;\r\nlocal_irq_restore(flags);\r\nreturn prev;\r\n}\r\nvoid omap2xxx_sdrc_init_params(u32 force_lock_to_unlock_mode)\r\n{\r\nunsigned long dll_cnt;\r\nu32 fast_dll = 0;\r\nmem_timings.m_type = !((sdrc_read_reg(SDRC_MR_0) & 0x3) == 0x1);\r\nif (cpu_is_omap2422())\r\nmem_timings.base_cs = 1;\r\nelse\r\nmem_timings.base_cs = 0;\r\nif (mem_timings.m_type != M_DDR)\r\nreturn;\r\nif (((mem_timings.fast_dll_ctrl & (1 << 2)) == M_LOCK_CTRL))\r\nmem_timings.dll_mode = M_UNLOCK;\r\nelse\r\nmem_timings.dll_mode = M_LOCK;\r\nif (mem_timings.base_cs == 0) {\r\nfast_dll = sdrc_read_reg(SDRC_DLLA_CTRL);\r\ndll_cnt = sdrc_read_reg(SDRC_DLLA_STATUS) & 0xff00;\r\n} else {\r\nfast_dll = sdrc_read_reg(SDRC_DLLB_CTRL);\r\ndll_cnt = sdrc_read_reg(SDRC_DLLB_STATUS) & 0xff00;\r\n}\r\nif (force_lock_to_unlock_mode) {\r\nfast_dll &= ~0xff00;\r\nfast_dll |= dll_cnt;\r\n}\r\nmem_timings.fast_dll_ctrl = (fast_dll | (3 << 8));\r\nomap2_sram_ddr_init(&mem_timings.slow_dll_ctrl,\r\nmem_timings.fast_dll_ctrl,\r\nmem_timings.base_cs,\r\nforce_lock_to_unlock_mode);\r\nmem_timings.slow_dll_ctrl &= 0xff00;\r\nmem_timings.slow_dll_ctrl |=\r\n((mem_timings.fast_dll_ctrl & 0xF) | (1 << 2));\r\nmem_timings.slow_dll_ctrl |= ((1 << 1) | (3 << 8));\r\n}

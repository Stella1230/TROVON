static int pcap_user_init(void *data, void *dev)\r\n{\r\nstruct pcap_data *pri = data;\r\npcap_t *p;\r\nchar errors[PCAP_ERRBUF_SIZE];\r\np = pcap_open_live(pri->host_if, ETH_MAX_PACKET + ETH_HEADER_OTHER,\r\npri->promisc, 0, errors);\r\nif (p == NULL) {\r\nprintk(UM_KERN_ERR "pcap_user_init : pcap_open_live failed - "\r\n"'%s'\n", errors);\r\nreturn -EINVAL;\r\n}\r\npri->dev = dev;\r\npri->pcap = p;\r\nreturn 0;\r\n}\r\nstatic int pcap_open(void *data)\r\n{\r\nstruct pcap_data *pri = data;\r\n__u32 netmask;\r\nint err;\r\nif (pri->pcap == NULL)\r\nreturn -ENODEV;\r\nif (pri->filter != NULL) {\r\nerr = dev_netmask(pri->dev, &netmask);\r\nif (err < 0) {\r\nprintk(UM_KERN_ERR "pcap_open : dev_netmask failed\n");\r\nreturn -EIO;\r\n}\r\npri->compiled = uml_kmalloc(sizeof(struct bpf_program),\r\nUM_GFP_KERNEL);\r\nif (pri->compiled == NULL) {\r\nprintk(UM_KERN_ERR "pcap_open : kmalloc failed\n");\r\nreturn -ENOMEM;\r\n}\r\nerr = pcap_compile(pri->pcap,\r\n(struct bpf_program *) pri->compiled,\r\npri->filter, pri->optimize, netmask);\r\nif (err < 0) {\r\nprintk(UM_KERN_ERR "pcap_open : pcap_compile failed - "\r\n"'%s'\n", pcap_geterr(pri->pcap));\r\ngoto out;\r\n}\r\nerr = pcap_setfilter(pri->pcap, pri->compiled);\r\nif (err < 0) {\r\nprintk(UM_KERN_ERR "pcap_open : pcap_setfilter "\r\n"failed - '%s'\n", pcap_geterr(pri->pcap));\r\ngoto out;\r\n}\r\n}\r\nreturn PCAP_FD(pri->pcap);\r\nout:\r\nkfree(pri->compiled);\r\nreturn -EIO;\r\n}\r\nstatic void pcap_remove(void *data)\r\n{\r\nstruct pcap_data *pri = data;\r\nif (pri->compiled != NULL)\r\npcap_freecode(pri->compiled);\r\nif (pri->pcap != NULL)\r\npcap_close(pri->pcap);\r\n}\r\nstatic void handler(u_char *data, const struct pcap_pkthdr *header,\r\nconst u_char *packet)\r\n{\r\nint len;\r\nstruct pcap_handler_data *hdata = (struct pcap_handler_data *) data;\r\nlen = hdata->len < header->caplen ? hdata->len : header->caplen;\r\nmemcpy(hdata->buffer, packet, len);\r\nhdata->len = len;\r\n}\r\nint pcap_user_read(int fd, void *buffer, int len, struct pcap_data *pri)\r\n{\r\nstruct pcap_handler_data hdata = ((struct pcap_handler_data)\r\n{ .buffer = buffer,\r\n.len = len });\r\nint n;\r\nn = pcap_dispatch(pri->pcap, 1, handler, (u_char *) &hdata);\r\nif (n < 0) {\r\nprintk(UM_KERN_ERR "pcap_dispatch failed - %s\n",\r\npcap_geterr(pri->pcap));\r\nreturn -EIO;\r\n}\r\nelse if (n == 0)\r\nreturn 0;\r\nreturn hdata.len;\r\n}

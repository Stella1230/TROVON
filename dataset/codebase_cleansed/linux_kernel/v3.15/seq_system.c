static int setheader(struct snd_seq_event * ev, int client, int port)\r\n{\r\nif (announce_port < 0)\r\nreturn -ENODEV;\r\nmemset(ev, 0, sizeof(struct snd_seq_event));\r\nev->flags &= ~SNDRV_SEQ_EVENT_LENGTH_MASK;\r\nev->flags |= SNDRV_SEQ_EVENT_LENGTH_FIXED;\r\nev->source.client = sysclient;\r\nev->source.port = announce_port;\r\nev->dest.client = SNDRV_SEQ_ADDRESS_SUBSCRIBERS;\r\nev->data.addr.client = client;\r\nev->data.addr.port = port;\r\nreturn 0;\r\n}\r\nvoid snd_seq_system_broadcast(int client, int port, int type)\r\n{\r\nstruct snd_seq_event ev;\r\nif (setheader(&ev, client, port) < 0)\r\nreturn;\r\nev.type = type;\r\nsnd_seq_kernel_client_dispatch(sysclient, &ev, 0, 0);\r\n}\r\nint snd_seq_system_notify(int client, int port, struct snd_seq_event *ev)\r\n{\r\nev->flags = SNDRV_SEQ_EVENT_LENGTH_FIXED;\r\nev->source.client = sysclient;\r\nev->source.port = announce_port;\r\nev->dest.client = client;\r\nev->dest.port = port;\r\nreturn snd_seq_kernel_client_dispatch(sysclient, ev, 0, 0);\r\n}\r\nstatic int event_input_timer(struct snd_seq_event * ev, int direct, void *private_data, int atomic, int hop)\r\n{\r\nreturn snd_seq_control_queue(ev, atomic, hop);\r\n}\r\nint __init snd_seq_system_client_init(void)\r\n{\r\nstruct snd_seq_port_callback pcallbacks;\r\nstruct snd_seq_port_info *port;\r\nport = kzalloc(sizeof(*port), GFP_KERNEL);\r\nif (!port)\r\nreturn -ENOMEM;\r\nmemset(&pcallbacks, 0, sizeof(pcallbacks));\r\npcallbacks.owner = THIS_MODULE;\r\npcallbacks.event_input = event_input_timer;\r\nsysclient = snd_seq_create_kernel_client(NULL, 0, "System");\r\nstrcpy(port->name, "Timer");\r\nport->capability = SNDRV_SEQ_PORT_CAP_WRITE;\r\nport->capability |= SNDRV_SEQ_PORT_CAP_READ|SNDRV_SEQ_PORT_CAP_SUBS_READ;\r\nport->kernel = &pcallbacks;\r\nport->type = 0;\r\nport->flags = SNDRV_SEQ_PORT_FLG_GIVEN_PORT;\r\nport->addr.client = sysclient;\r\nport->addr.port = SNDRV_SEQ_PORT_SYSTEM_TIMER;\r\nsnd_seq_kernel_client_ctl(sysclient, SNDRV_SEQ_IOCTL_CREATE_PORT, port);\r\nstrcpy(port->name, "Announce");\r\nport->capability = SNDRV_SEQ_PORT_CAP_READ|SNDRV_SEQ_PORT_CAP_SUBS_READ;\r\nport->kernel = NULL;\r\nport->type = 0;\r\nport->flags = SNDRV_SEQ_PORT_FLG_GIVEN_PORT;\r\nport->addr.client = sysclient;\r\nport->addr.port = SNDRV_SEQ_PORT_SYSTEM_ANNOUNCE;\r\nsnd_seq_kernel_client_ctl(sysclient, SNDRV_SEQ_IOCTL_CREATE_PORT, port);\r\nannounce_port = port->addr.port;\r\nkfree(port);\r\nreturn 0;\r\n}\r\nvoid __exit snd_seq_system_client_done(void)\r\n{\r\nint oldsysclient = sysclient;\r\nif (oldsysclient >= 0) {\r\nsysclient = -1;\r\nannounce_port = -1;\r\nsnd_seq_delete_kernel_client(oldsysclient);\r\n}\r\n}

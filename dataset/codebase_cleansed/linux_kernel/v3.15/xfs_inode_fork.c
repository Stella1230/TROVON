void\r\nxfs_validate_extents(\r\nxfs_ifork_t *ifp,\r\nint nrecs,\r\nxfs_exntfmt_t fmt)\r\n{\r\nxfs_bmbt_irec_t irec;\r\nxfs_bmbt_rec_host_t rec;\r\nint i;\r\nfor (i = 0; i < nrecs; i++) {\r\nxfs_bmbt_rec_host_t *ep = xfs_iext_get_ext(ifp, i);\r\nrec.l0 = get_unaligned(&ep->l0);\r\nrec.l1 = get_unaligned(&ep->l1);\r\nxfs_bmbt_get_all(&rec, &irec);\r\nif (fmt == XFS_EXTFMT_NOSTATE)\r\nASSERT(irec.br_state == XFS_EXT_NORM);\r\n}\r\n}\r\nint\r\nxfs_iformat_fork(\r\nxfs_inode_t *ip,\r\nxfs_dinode_t *dip)\r\n{\r\nxfs_attr_shortform_t *atp;\r\nint size;\r\nint error = 0;\r\nxfs_fsize_t di_size;\r\nif (unlikely(be32_to_cpu(dip->di_nextents) +\r\nbe16_to_cpu(dip->di_anextents) >\r\nbe64_to_cpu(dip->di_nblocks))) {\r\nxfs_warn(ip->i_mount,\r\n"corrupt dinode %Lu, extent total = %d, nblocks = %Lu.",\r\n(unsigned long long)ip->i_ino,\r\n(int)(be32_to_cpu(dip->di_nextents) +\r\nbe16_to_cpu(dip->di_anextents)),\r\n(unsigned long long)\r\nbe64_to_cpu(dip->di_nblocks));\r\nXFS_CORRUPTION_ERROR("xfs_iformat(1)", XFS_ERRLEVEL_LOW,\r\nip->i_mount, dip);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\nif (unlikely(dip->di_forkoff > ip->i_mount->m_sb.sb_inodesize)) {\r\nxfs_warn(ip->i_mount, "corrupt dinode %Lu, forkoff = 0x%x.",\r\n(unsigned long long)ip->i_ino,\r\ndip->di_forkoff);\r\nXFS_CORRUPTION_ERROR("xfs_iformat(2)", XFS_ERRLEVEL_LOW,\r\nip->i_mount, dip);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\nif (unlikely((ip->i_d.di_flags & XFS_DIFLAG_REALTIME) &&\r\n!ip->i_mount->m_rtdev_targp)) {\r\nxfs_warn(ip->i_mount,\r\n"corrupt dinode %Lu, has realtime flag set.",\r\nip->i_ino);\r\nXFS_CORRUPTION_ERROR("xfs_iformat(realtime)",\r\nXFS_ERRLEVEL_LOW, ip->i_mount, dip);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\nswitch (ip->i_d.di_mode & S_IFMT) {\r\ncase S_IFIFO:\r\ncase S_IFCHR:\r\ncase S_IFBLK:\r\ncase S_IFSOCK:\r\nif (unlikely(dip->di_format != XFS_DINODE_FMT_DEV)) {\r\nXFS_CORRUPTION_ERROR("xfs_iformat(3)", XFS_ERRLEVEL_LOW,\r\nip->i_mount, dip);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\nip->i_d.di_size = 0;\r\nip->i_df.if_u2.if_rdev = xfs_dinode_get_rdev(dip);\r\nbreak;\r\ncase S_IFREG:\r\ncase S_IFLNK:\r\ncase S_IFDIR:\r\nswitch (dip->di_format) {\r\ncase XFS_DINODE_FMT_LOCAL:\r\nif (unlikely(S_ISREG(be16_to_cpu(dip->di_mode)))) {\r\nxfs_warn(ip->i_mount,\r\n"corrupt inode %Lu (local format for regular file).",\r\n(unsigned long long) ip->i_ino);\r\nXFS_CORRUPTION_ERROR("xfs_iformat(4)",\r\nXFS_ERRLEVEL_LOW,\r\nip->i_mount, dip);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\ndi_size = be64_to_cpu(dip->di_size);\r\nif (unlikely(di_size < 0 ||\r\ndi_size > XFS_DFORK_DSIZE(dip, ip->i_mount))) {\r\nxfs_warn(ip->i_mount,\r\n"corrupt inode %Lu (bad size %Ld for local inode).",\r\n(unsigned long long) ip->i_ino,\r\n(long long) di_size);\r\nXFS_CORRUPTION_ERROR("xfs_iformat(5)",\r\nXFS_ERRLEVEL_LOW,\r\nip->i_mount, dip);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\nsize = (int)di_size;\r\nerror = xfs_iformat_local(ip, dip, XFS_DATA_FORK, size);\r\nbreak;\r\ncase XFS_DINODE_FMT_EXTENTS:\r\nerror = xfs_iformat_extents(ip, dip, XFS_DATA_FORK);\r\nbreak;\r\ncase XFS_DINODE_FMT_BTREE:\r\nerror = xfs_iformat_btree(ip, dip, XFS_DATA_FORK);\r\nbreak;\r\ndefault:\r\nXFS_ERROR_REPORT("xfs_iformat(6)", XFS_ERRLEVEL_LOW,\r\nip->i_mount);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\nbreak;\r\ndefault:\r\nXFS_ERROR_REPORT("xfs_iformat(7)", XFS_ERRLEVEL_LOW, ip->i_mount);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\nif (error) {\r\nreturn error;\r\n}\r\nif (!XFS_DFORK_Q(dip))\r\nreturn 0;\r\nASSERT(ip->i_afp == NULL);\r\nip->i_afp = kmem_zone_zalloc(xfs_ifork_zone, KM_SLEEP | KM_NOFS);\r\nswitch (dip->di_aformat) {\r\ncase XFS_DINODE_FMT_LOCAL:\r\natp = (xfs_attr_shortform_t *)XFS_DFORK_APTR(dip);\r\nsize = be16_to_cpu(atp->hdr.totsize);\r\nif (unlikely(size < sizeof(struct xfs_attr_sf_hdr))) {\r\nxfs_warn(ip->i_mount,\r\n"corrupt inode %Lu (bad attr fork size %Ld).",\r\n(unsigned long long) ip->i_ino,\r\n(long long) size);\r\nXFS_CORRUPTION_ERROR("xfs_iformat(8)",\r\nXFS_ERRLEVEL_LOW,\r\nip->i_mount, dip);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\nerror = xfs_iformat_local(ip, dip, XFS_ATTR_FORK, size);\r\nbreak;\r\ncase XFS_DINODE_FMT_EXTENTS:\r\nerror = xfs_iformat_extents(ip, dip, XFS_ATTR_FORK);\r\nbreak;\r\ncase XFS_DINODE_FMT_BTREE:\r\nerror = xfs_iformat_btree(ip, dip, XFS_ATTR_FORK);\r\nbreak;\r\ndefault:\r\nerror = XFS_ERROR(EFSCORRUPTED);\r\nbreak;\r\n}\r\nif (error) {\r\nkmem_zone_free(xfs_ifork_zone, ip->i_afp);\r\nip->i_afp = NULL;\r\nxfs_idestroy_fork(ip, XFS_DATA_FORK);\r\n}\r\nreturn error;\r\n}\r\nSTATIC int\r\nxfs_iformat_local(\r\nxfs_inode_t *ip,\r\nxfs_dinode_t *dip,\r\nint whichfork,\r\nint size)\r\n{\r\nxfs_ifork_t *ifp;\r\nint real_size;\r\nif (unlikely(size > XFS_DFORK_SIZE(dip, ip->i_mount, whichfork))) {\r\nxfs_warn(ip->i_mount,\r\n"corrupt inode %Lu (bad size %d for local fork, size = %d).",\r\n(unsigned long long) ip->i_ino, size,\r\nXFS_DFORK_SIZE(dip, ip->i_mount, whichfork));\r\nXFS_CORRUPTION_ERROR("xfs_iformat_local", XFS_ERRLEVEL_LOW,\r\nip->i_mount, dip);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\nifp = XFS_IFORK_PTR(ip, whichfork);\r\nreal_size = 0;\r\nif (size == 0)\r\nifp->if_u1.if_data = NULL;\r\nelse if (size <= sizeof(ifp->if_u2.if_inline_data))\r\nifp->if_u1.if_data = ifp->if_u2.if_inline_data;\r\nelse {\r\nreal_size = roundup(size, 4);\r\nifp->if_u1.if_data = kmem_alloc(real_size, KM_SLEEP | KM_NOFS);\r\n}\r\nifp->if_bytes = size;\r\nifp->if_real_bytes = real_size;\r\nif (size)\r\nmemcpy(ifp->if_u1.if_data, XFS_DFORK_PTR(dip, whichfork), size);\r\nifp->if_flags &= ~XFS_IFEXTENTS;\r\nifp->if_flags |= XFS_IFINLINE;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_iformat_extents(\r\nxfs_inode_t *ip,\r\nxfs_dinode_t *dip,\r\nint whichfork)\r\n{\r\nxfs_bmbt_rec_t *dp;\r\nxfs_ifork_t *ifp;\r\nint nex;\r\nint size;\r\nint i;\r\nifp = XFS_IFORK_PTR(ip, whichfork);\r\nnex = XFS_DFORK_NEXTENTS(dip, whichfork);\r\nsize = nex * (uint)sizeof(xfs_bmbt_rec_t);\r\nif (unlikely(size < 0 || size > XFS_DFORK_SIZE(dip, ip->i_mount, whichfork))) {\r\nxfs_warn(ip->i_mount, "corrupt inode %Lu ((a)extents = %d).",\r\n(unsigned long long) ip->i_ino, nex);\r\nXFS_CORRUPTION_ERROR("xfs_iformat_extents(1)", XFS_ERRLEVEL_LOW,\r\nip->i_mount, dip);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\nifp->if_real_bytes = 0;\r\nif (nex == 0)\r\nifp->if_u1.if_extents = NULL;\r\nelse if (nex <= XFS_INLINE_EXTS)\r\nifp->if_u1.if_extents = ifp->if_u2.if_inline_ext;\r\nelse\r\nxfs_iext_add(ifp, 0, nex);\r\nifp->if_bytes = size;\r\nif (size) {\r\ndp = (xfs_bmbt_rec_t *) XFS_DFORK_PTR(dip, whichfork);\r\nxfs_validate_extents(ifp, nex, XFS_EXTFMT_INODE(ip));\r\nfor (i = 0; i < nex; i++, dp++) {\r\nxfs_bmbt_rec_host_t *ep = xfs_iext_get_ext(ifp, i);\r\nep->l0 = get_unaligned_be64(&dp->l0);\r\nep->l1 = get_unaligned_be64(&dp->l1);\r\n}\r\nXFS_BMAP_TRACE_EXLIST(ip, nex, whichfork);\r\nif (whichfork != XFS_DATA_FORK ||\r\nXFS_EXTFMT_INODE(ip) == XFS_EXTFMT_NOSTATE)\r\nif (unlikely(xfs_check_nostate_extents(\r\nifp, 0, nex))) {\r\nXFS_ERROR_REPORT("xfs_iformat_extents(2)",\r\nXFS_ERRLEVEL_LOW,\r\nip->i_mount);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\n}\r\nifp->if_flags |= XFS_IFEXTENTS;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_iformat_btree(\r\nxfs_inode_t *ip,\r\nxfs_dinode_t *dip,\r\nint whichfork)\r\n{\r\nstruct xfs_mount *mp = ip->i_mount;\r\nxfs_bmdr_block_t *dfp;\r\nxfs_ifork_t *ifp;\r\nint nrecs;\r\nint size;\r\nifp = XFS_IFORK_PTR(ip, whichfork);\r\ndfp = (xfs_bmdr_block_t *)XFS_DFORK_PTR(dip, whichfork);\r\nsize = XFS_BMAP_BROOT_SPACE(mp, dfp);\r\nnrecs = be16_to_cpu(dfp->bb_numrecs);\r\nif (unlikely(XFS_IFORK_NEXTENTS(ip, whichfork) <=\r\nXFS_IFORK_MAXEXT(ip, whichfork) ||\r\nXFS_BMDR_SPACE_CALC(nrecs) >\r\nXFS_DFORK_SIZE(dip, mp, whichfork) ||\r\nXFS_IFORK_NEXTENTS(ip, whichfork) > ip->i_d.di_nblocks)) {\r\nxfs_warn(mp, "corrupt inode %Lu (btree).",\r\n(unsigned long long) ip->i_ino);\r\nXFS_CORRUPTION_ERROR("xfs_iformat_btree", XFS_ERRLEVEL_LOW,\r\nmp, dip);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\nifp->if_broot_bytes = size;\r\nifp->if_broot = kmem_alloc(size, KM_SLEEP | KM_NOFS);\r\nASSERT(ifp->if_broot != NULL);\r\nxfs_bmdr_to_bmbt(ip, dfp, XFS_DFORK_SIZE(dip, ip->i_mount, whichfork),\r\nifp->if_broot, size);\r\nifp->if_flags &= ~XFS_IFEXTENTS;\r\nifp->if_flags |= XFS_IFBROOT;\r\nreturn 0;\r\n}\r\nint\r\nxfs_iread_extents(\r\nxfs_trans_t *tp,\r\nxfs_inode_t *ip,\r\nint whichfork)\r\n{\r\nint error;\r\nxfs_ifork_t *ifp;\r\nxfs_extnum_t nextents;\r\nASSERT(xfs_isilocked(ip, XFS_ILOCK_EXCL));\r\nif (unlikely(XFS_IFORK_FORMAT(ip, whichfork) != XFS_DINODE_FMT_BTREE)) {\r\nXFS_ERROR_REPORT("xfs_iread_extents", XFS_ERRLEVEL_LOW,\r\nip->i_mount);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\nnextents = XFS_IFORK_NEXTENTS(ip, whichfork);\r\nifp = XFS_IFORK_PTR(ip, whichfork);\r\nifp->if_bytes = ifp->if_real_bytes = 0;\r\nifp->if_flags |= XFS_IFEXTENTS;\r\nxfs_iext_add(ifp, 0, nextents);\r\nerror = xfs_bmap_read_extents(tp, ip, whichfork);\r\nif (error) {\r\nxfs_iext_destroy(ifp);\r\nifp->if_flags &= ~XFS_IFEXTENTS;\r\nreturn error;\r\n}\r\nxfs_validate_extents(ifp, nextents, XFS_EXTFMT_INODE(ip));\r\nreturn 0;\r\n}\r\nvoid\r\nxfs_iroot_realloc(\r\nxfs_inode_t *ip,\r\nint rec_diff,\r\nint whichfork)\r\n{\r\nstruct xfs_mount *mp = ip->i_mount;\r\nint cur_max;\r\nxfs_ifork_t *ifp;\r\nstruct xfs_btree_block *new_broot;\r\nint new_max;\r\nsize_t new_size;\r\nchar *np;\r\nchar *op;\r\nif (rec_diff == 0) {\r\nreturn;\r\n}\r\nifp = XFS_IFORK_PTR(ip, whichfork);\r\nif (rec_diff > 0) {\r\nif (ifp->if_broot_bytes == 0) {\r\nnew_size = XFS_BMAP_BROOT_SPACE_CALC(mp, rec_diff);\r\nifp->if_broot = kmem_alloc(new_size, KM_SLEEP | KM_NOFS);\r\nifp->if_broot_bytes = (int)new_size;\r\nreturn;\r\n}\r\ncur_max = xfs_bmbt_maxrecs(mp, ifp->if_broot_bytes, 0);\r\nnew_max = cur_max + rec_diff;\r\nnew_size = XFS_BMAP_BROOT_SPACE_CALC(mp, new_max);\r\nifp->if_broot = kmem_realloc(ifp->if_broot, new_size,\r\nXFS_BMAP_BROOT_SPACE_CALC(mp, cur_max),\r\nKM_SLEEP | KM_NOFS);\r\nop = (char *)XFS_BMAP_BROOT_PTR_ADDR(mp, ifp->if_broot, 1,\r\nifp->if_broot_bytes);\r\nnp = (char *)XFS_BMAP_BROOT_PTR_ADDR(mp, ifp->if_broot, 1,\r\n(int)new_size);\r\nifp->if_broot_bytes = (int)new_size;\r\nASSERT(XFS_BMAP_BMDR_SPACE(ifp->if_broot) <=\r\nXFS_IFORK_SIZE(ip, whichfork));\r\nmemmove(np, op, cur_max * (uint)sizeof(xfs_dfsbno_t));\r\nreturn;\r\n}\r\nASSERT((ifp->if_broot != NULL) && (ifp->if_broot_bytes > 0));\r\ncur_max = xfs_bmbt_maxrecs(mp, ifp->if_broot_bytes, 0);\r\nnew_max = cur_max + rec_diff;\r\nASSERT(new_max >= 0);\r\nif (new_max > 0)\r\nnew_size = XFS_BMAP_BROOT_SPACE_CALC(mp, new_max);\r\nelse\r\nnew_size = 0;\r\nif (new_size > 0) {\r\nnew_broot = kmem_alloc(new_size, KM_SLEEP | KM_NOFS);\r\nmemcpy(new_broot, ifp->if_broot,\r\nXFS_BMBT_BLOCK_LEN(ip->i_mount));\r\n} else {\r\nnew_broot = NULL;\r\nifp->if_flags &= ~XFS_IFBROOT;\r\n}\r\nif (new_max > 0) {\r\nop = (char *)XFS_BMBT_REC_ADDR(mp, ifp->if_broot, 1);\r\nnp = (char *)XFS_BMBT_REC_ADDR(mp, new_broot, 1);\r\nmemcpy(np, op, new_max * (uint)sizeof(xfs_bmbt_rec_t));\r\nop = (char *)XFS_BMAP_BROOT_PTR_ADDR(mp, ifp->if_broot, 1,\r\nifp->if_broot_bytes);\r\nnp = (char *)XFS_BMAP_BROOT_PTR_ADDR(mp, new_broot, 1,\r\n(int)new_size);\r\nmemcpy(np, op, new_max * (uint)sizeof(xfs_dfsbno_t));\r\n}\r\nkmem_free(ifp->if_broot);\r\nifp->if_broot = new_broot;\r\nifp->if_broot_bytes = (int)new_size;\r\nif (ifp->if_broot)\r\nASSERT(XFS_BMAP_BMDR_SPACE(ifp->if_broot) <=\r\nXFS_IFORK_SIZE(ip, whichfork));\r\nreturn;\r\n}\r\nvoid\r\nxfs_idata_realloc(\r\nxfs_inode_t *ip,\r\nint byte_diff,\r\nint whichfork)\r\n{\r\nxfs_ifork_t *ifp;\r\nint new_size;\r\nint real_size;\r\nif (byte_diff == 0) {\r\nreturn;\r\n}\r\nifp = XFS_IFORK_PTR(ip, whichfork);\r\nnew_size = (int)ifp->if_bytes + byte_diff;\r\nASSERT(new_size >= 0);\r\nif (new_size == 0) {\r\nif (ifp->if_u1.if_data != ifp->if_u2.if_inline_data) {\r\nkmem_free(ifp->if_u1.if_data);\r\n}\r\nifp->if_u1.if_data = NULL;\r\nreal_size = 0;\r\n} else if (new_size <= sizeof(ifp->if_u2.if_inline_data)) {\r\nif (ifp->if_u1.if_data == NULL) {\r\nifp->if_u1.if_data = ifp->if_u2.if_inline_data;\r\n} else if (ifp->if_u1.if_data != ifp->if_u2.if_inline_data) {\r\nASSERT(ifp->if_real_bytes != 0);\r\nmemcpy(ifp->if_u2.if_inline_data, ifp->if_u1.if_data,\r\nnew_size);\r\nkmem_free(ifp->if_u1.if_data);\r\nifp->if_u1.if_data = ifp->if_u2.if_inline_data;\r\n}\r\nreal_size = 0;\r\n} else {\r\nreal_size = roundup(new_size, 4);\r\nif (ifp->if_u1.if_data == NULL) {\r\nASSERT(ifp->if_real_bytes == 0);\r\nifp->if_u1.if_data = kmem_alloc(real_size,\r\nKM_SLEEP | KM_NOFS);\r\n} else if (ifp->if_u1.if_data != ifp->if_u2.if_inline_data) {\r\nif (ifp->if_real_bytes != real_size) {\r\nifp->if_u1.if_data =\r\nkmem_realloc(ifp->if_u1.if_data,\r\nreal_size,\r\nifp->if_real_bytes,\r\nKM_SLEEP | KM_NOFS);\r\n}\r\n} else {\r\nASSERT(ifp->if_real_bytes == 0);\r\nifp->if_u1.if_data = kmem_alloc(real_size,\r\nKM_SLEEP | KM_NOFS);\r\nmemcpy(ifp->if_u1.if_data, ifp->if_u2.if_inline_data,\r\nifp->if_bytes);\r\n}\r\n}\r\nifp->if_real_bytes = real_size;\r\nifp->if_bytes = new_size;\r\nASSERT(ifp->if_bytes <= XFS_IFORK_SIZE(ip, whichfork));\r\n}\r\nvoid\r\nxfs_idestroy_fork(\r\nxfs_inode_t *ip,\r\nint whichfork)\r\n{\r\nxfs_ifork_t *ifp;\r\nifp = XFS_IFORK_PTR(ip, whichfork);\r\nif (ifp->if_broot != NULL) {\r\nkmem_free(ifp->if_broot);\r\nifp->if_broot = NULL;\r\n}\r\nif (XFS_IFORK_FORMAT(ip, whichfork) == XFS_DINODE_FMT_LOCAL) {\r\nif ((ifp->if_u1.if_data != ifp->if_u2.if_inline_data) &&\r\n(ifp->if_u1.if_data != NULL)) {\r\nASSERT(ifp->if_real_bytes != 0);\r\nkmem_free(ifp->if_u1.if_data);\r\nifp->if_u1.if_data = NULL;\r\nifp->if_real_bytes = 0;\r\n}\r\n} else if ((ifp->if_flags & XFS_IFEXTENTS) &&\r\n((ifp->if_flags & XFS_IFEXTIREC) ||\r\n((ifp->if_u1.if_extents != NULL) &&\r\n(ifp->if_u1.if_extents != ifp->if_u2.if_inline_ext)))) {\r\nASSERT(ifp->if_real_bytes != 0);\r\nxfs_iext_destroy(ifp);\r\n}\r\nASSERT(ifp->if_u1.if_extents == NULL ||\r\nifp->if_u1.if_extents == ifp->if_u2.if_inline_ext);\r\nASSERT(ifp->if_real_bytes == 0);\r\nif (whichfork == XFS_ATTR_FORK) {\r\nkmem_zone_free(xfs_ifork_zone, ip->i_afp);\r\nip->i_afp = NULL;\r\n}\r\n}\r\nint\r\nxfs_iextents_copy(\r\nxfs_inode_t *ip,\r\nxfs_bmbt_rec_t *dp,\r\nint whichfork)\r\n{\r\nint copied;\r\nint i;\r\nxfs_ifork_t *ifp;\r\nint nrecs;\r\nxfs_fsblock_t start_block;\r\nifp = XFS_IFORK_PTR(ip, whichfork);\r\nASSERT(xfs_isilocked(ip, XFS_ILOCK_EXCL|XFS_ILOCK_SHARED));\r\nASSERT(ifp->if_bytes > 0);\r\nnrecs = ifp->if_bytes / (uint)sizeof(xfs_bmbt_rec_t);\r\nXFS_BMAP_TRACE_EXLIST(ip, nrecs, whichfork);\r\nASSERT(nrecs > 0);\r\ncopied = 0;\r\nfor (i = 0; i < nrecs; i++) {\r\nxfs_bmbt_rec_host_t *ep = xfs_iext_get_ext(ifp, i);\r\nstart_block = xfs_bmbt_get_startblock(ep);\r\nif (isnullstartblock(start_block)) {\r\ncontinue;\r\n}\r\nput_unaligned_be64(ep->l0, &dp->l0);\r\nput_unaligned_be64(ep->l1, &dp->l1);\r\ndp++;\r\ncopied++;\r\n}\r\nASSERT(copied != 0);\r\nxfs_validate_extents(ifp, copied, XFS_EXTFMT_INODE(ip));\r\nreturn (copied * (uint)sizeof(xfs_bmbt_rec_t));\r\n}\r\nvoid\r\nxfs_iflush_fork(\r\nxfs_inode_t *ip,\r\nxfs_dinode_t *dip,\r\nxfs_inode_log_item_t *iip,\r\nint whichfork,\r\nxfs_buf_t *bp)\r\n{\r\nchar *cp;\r\nxfs_ifork_t *ifp;\r\nxfs_mount_t *mp;\r\nstatic const short brootflag[2] =\r\n{ XFS_ILOG_DBROOT, XFS_ILOG_ABROOT };\r\nstatic const short dataflag[2] =\r\n{ XFS_ILOG_DDATA, XFS_ILOG_ADATA };\r\nstatic const short extflag[2] =\r\n{ XFS_ILOG_DEXT, XFS_ILOG_AEXT };\r\nif (!iip)\r\nreturn;\r\nifp = XFS_IFORK_PTR(ip, whichfork);\r\nif (!ifp) {\r\nASSERT(whichfork == XFS_ATTR_FORK);\r\nreturn;\r\n}\r\ncp = XFS_DFORK_PTR(dip, whichfork);\r\nmp = ip->i_mount;\r\nswitch (XFS_IFORK_FORMAT(ip, whichfork)) {\r\ncase XFS_DINODE_FMT_LOCAL:\r\nif ((iip->ili_fields & dataflag[whichfork]) &&\r\n(ifp->if_bytes > 0)) {\r\nASSERT(ifp->if_u1.if_data != NULL);\r\nASSERT(ifp->if_bytes <= XFS_IFORK_SIZE(ip, whichfork));\r\nmemcpy(cp, ifp->if_u1.if_data, ifp->if_bytes);\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_EXTENTS:\r\nASSERT((ifp->if_flags & XFS_IFEXTENTS) ||\r\n!(iip->ili_fields & extflag[whichfork]));\r\nif ((iip->ili_fields & extflag[whichfork]) &&\r\n(ifp->if_bytes > 0)) {\r\nASSERT(xfs_iext_get_ext(ifp, 0));\r\nASSERT(XFS_IFORK_NEXTENTS(ip, whichfork) > 0);\r\n(void)xfs_iextents_copy(ip, (xfs_bmbt_rec_t *)cp,\r\nwhichfork);\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_BTREE:\r\nif ((iip->ili_fields & brootflag[whichfork]) &&\r\n(ifp->if_broot_bytes > 0)) {\r\nASSERT(ifp->if_broot != NULL);\r\nASSERT(XFS_BMAP_BMDR_SPACE(ifp->if_broot) <=\r\nXFS_IFORK_SIZE(ip, whichfork));\r\nxfs_bmbt_to_bmdr(mp, ifp->if_broot, ifp->if_broot_bytes,\r\n(xfs_bmdr_block_t *)cp,\r\nXFS_DFORK_SIZE(dip, mp, whichfork));\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_DEV:\r\nif (iip->ili_fields & XFS_ILOG_DEV) {\r\nASSERT(whichfork == XFS_DATA_FORK);\r\nxfs_dinode_put_rdev(dip, ip->i_df.if_u2.if_rdev);\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_UUID:\r\nif (iip->ili_fields & XFS_ILOG_UUID) {\r\nASSERT(whichfork == XFS_DATA_FORK);\r\nmemcpy(XFS_DFORK_DPTR(dip),\r\n&ip->i_df.if_u2.if_uuid,\r\nsizeof(uuid_t));\r\n}\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\nbreak;\r\n}\r\n}\r\nxfs_bmbt_rec_host_t *\r\nxfs_iext_get_ext(\r\nxfs_ifork_t *ifp,\r\nxfs_extnum_t idx)\r\n{\r\nASSERT(idx >= 0);\r\nASSERT(idx < ifp->if_bytes / sizeof(xfs_bmbt_rec_t));\r\nif ((ifp->if_flags & XFS_IFEXTIREC) && (idx == 0)) {\r\nreturn ifp->if_u1.if_ext_irec->er_extbuf;\r\n} else if (ifp->if_flags & XFS_IFEXTIREC) {\r\nxfs_ext_irec_t *erp;\r\nint erp_idx = 0;\r\nxfs_extnum_t page_idx = idx;\r\nerp = xfs_iext_idx_to_irec(ifp, &page_idx, &erp_idx, 0);\r\nreturn &erp->er_extbuf[page_idx];\r\n} else if (ifp->if_bytes) {\r\nreturn &ifp->if_u1.if_extents[idx];\r\n} else {\r\nreturn NULL;\r\n}\r\n}\r\nvoid\r\nxfs_iext_insert(\r\nxfs_inode_t *ip,\r\nxfs_extnum_t idx,\r\nxfs_extnum_t count,\r\nxfs_bmbt_irec_t *new,\r\nint state)\r\n{\r\nxfs_ifork_t *ifp = (state & BMAP_ATTRFORK) ? ip->i_afp : &ip->i_df;\r\nxfs_extnum_t i;\r\ntrace_xfs_iext_insert(ip, idx, new, state, _RET_IP_);\r\nASSERT(ifp->if_flags & XFS_IFEXTENTS);\r\nxfs_iext_add(ifp, idx, count);\r\nfor (i = idx; i < idx + count; i++, new++)\r\nxfs_bmbt_set_all(xfs_iext_get_ext(ifp, i), new);\r\n}\r\nvoid\r\nxfs_iext_add(\r\nxfs_ifork_t *ifp,\r\nxfs_extnum_t idx,\r\nint ext_diff)\r\n{\r\nint byte_diff;\r\nint new_size;\r\nxfs_extnum_t nextents;\r\nnextents = ifp->if_bytes / (uint)sizeof(xfs_bmbt_rec_t);\r\nASSERT((idx >= 0) && (idx <= nextents));\r\nbyte_diff = ext_diff * sizeof(xfs_bmbt_rec_t);\r\nnew_size = ifp->if_bytes + byte_diff;\r\nif (nextents + ext_diff <= XFS_INLINE_EXTS) {\r\nif (idx < nextents) {\r\nmemmove(&ifp->if_u2.if_inline_ext[idx + ext_diff],\r\n&ifp->if_u2.if_inline_ext[idx],\r\n(nextents - idx) * sizeof(xfs_bmbt_rec_t));\r\nmemset(&ifp->if_u2.if_inline_ext[idx], 0, byte_diff);\r\n}\r\nifp->if_u1.if_extents = ifp->if_u2.if_inline_ext;\r\nifp->if_real_bytes = 0;\r\n}\r\nelse if (nextents + ext_diff <= XFS_LINEAR_EXTS) {\r\nxfs_iext_realloc_direct(ifp, new_size);\r\nif (idx < nextents) {\r\nmemmove(&ifp->if_u1.if_extents[idx + ext_diff],\r\n&ifp->if_u1.if_extents[idx],\r\n(nextents - idx) * sizeof(xfs_bmbt_rec_t));\r\nmemset(&ifp->if_u1.if_extents[idx], 0, byte_diff);\r\n}\r\n}\r\nelse {\r\nxfs_ext_irec_t *erp;\r\nint erp_idx = 0;\r\nint page_idx = idx;\r\nASSERT(nextents + ext_diff > XFS_LINEAR_EXTS);\r\nif (ifp->if_flags & XFS_IFEXTIREC) {\r\nerp = xfs_iext_idx_to_irec(ifp, &page_idx, &erp_idx, 1);\r\n} else {\r\nxfs_iext_irec_init(ifp);\r\nASSERT(ifp->if_flags & XFS_IFEXTIREC);\r\nerp = ifp->if_u1.if_ext_irec;\r\n}\r\nif (erp && erp->er_extcount + ext_diff <= XFS_LINEAR_EXTS) {\r\nif (page_idx < erp->er_extcount) {\r\nmemmove(&erp->er_extbuf[page_idx + ext_diff],\r\n&erp->er_extbuf[page_idx],\r\n(erp->er_extcount - page_idx) *\r\nsizeof(xfs_bmbt_rec_t));\r\nmemset(&erp->er_extbuf[page_idx], 0, byte_diff);\r\n}\r\nerp->er_extcount += ext_diff;\r\nxfs_iext_irec_update_extoffs(ifp, erp_idx + 1, ext_diff);\r\n}\r\nelse if (erp) {\r\nxfs_iext_add_indirect_multi(ifp,\r\nerp_idx, page_idx, ext_diff);\r\n}\r\nelse {\r\nuint count = ext_diff;\r\nwhile (count) {\r\nerp = xfs_iext_irec_new(ifp, erp_idx);\r\nerp->er_extcount = min(count, XFS_LINEAR_EXTS);\r\ncount -= erp->er_extcount;\r\nif (count)\r\nerp_idx++;\r\n}\r\n}\r\n}\r\nifp->if_bytes = new_size;\r\n}\r\nvoid\r\nxfs_iext_add_indirect_multi(\r\nxfs_ifork_t *ifp,\r\nint erp_idx,\r\nxfs_extnum_t idx,\r\nint count)\r\n{\r\nint byte_diff;\r\nxfs_ext_irec_t *erp;\r\nxfs_extnum_t ext_diff;\r\nxfs_extnum_t ext_cnt;\r\nxfs_extnum_t nex2;\r\nxfs_bmbt_rec_t *nex2_ep = NULL;\r\nint nlists;\r\nASSERT(ifp->if_flags & XFS_IFEXTIREC);\r\nerp = &ifp->if_u1.if_ext_irec[erp_idx];\r\nnex2 = erp->er_extcount - idx;\r\nnlists = ifp->if_real_bytes / XFS_IEXT_BUFSZ;\r\nif (nex2) {\r\nbyte_diff = nex2 * sizeof(xfs_bmbt_rec_t);\r\nnex2_ep = (xfs_bmbt_rec_t *) kmem_alloc(byte_diff, KM_NOFS);\r\nmemmove(nex2_ep, &erp->er_extbuf[idx], byte_diff);\r\nerp->er_extcount -= nex2;\r\nxfs_iext_irec_update_extoffs(ifp, erp_idx + 1, -nex2);\r\nmemset(&erp->er_extbuf[idx], 0, byte_diff);\r\n}\r\next_cnt = count;\r\next_diff = MIN(ext_cnt, (int)XFS_LINEAR_EXTS - erp->er_extcount);\r\nif (ext_diff) {\r\nerp->er_extcount += ext_diff;\r\nxfs_iext_irec_update_extoffs(ifp, erp_idx + 1, ext_diff);\r\next_cnt -= ext_diff;\r\n}\r\nwhile (ext_cnt) {\r\nerp_idx++;\r\nerp = xfs_iext_irec_new(ifp, erp_idx);\r\next_diff = MIN(ext_cnt, (int)XFS_LINEAR_EXTS);\r\nerp->er_extcount = ext_diff;\r\nxfs_iext_irec_update_extoffs(ifp, erp_idx + 1, ext_diff);\r\next_cnt -= ext_diff;\r\n}\r\nif (nex2) {\r\nxfs_extnum_t ext_avail;\r\nint i;\r\nbyte_diff = nex2 * sizeof(xfs_bmbt_rec_t);\r\next_avail = XFS_LINEAR_EXTS - erp->er_extcount;\r\ni = 0;\r\nif (nex2 <= ext_avail) {\r\ni = erp->er_extcount;\r\n}\r\nelse if ((erp_idx < nlists - 1) &&\r\n(nex2 <= (ext_avail = XFS_LINEAR_EXTS -\r\nifp->if_u1.if_ext_irec[erp_idx+1].er_extcount))) {\r\nerp_idx++;\r\nerp++;\r\nmemmove(&erp->er_extbuf[nex2], erp->er_extbuf,\r\nerp->er_extcount * sizeof(xfs_bmbt_rec_t));\r\n}\r\nelse {\r\nerp_idx++;\r\nerp = xfs_iext_irec_new(ifp, erp_idx);\r\n}\r\nmemmove(&erp->er_extbuf[i], nex2_ep, byte_diff);\r\nkmem_free(nex2_ep);\r\nerp->er_extcount += nex2;\r\nxfs_iext_irec_update_extoffs(ifp, erp_idx + 1, nex2);\r\n}\r\n}\r\nvoid\r\nxfs_iext_remove(\r\nxfs_inode_t *ip,\r\nxfs_extnum_t idx,\r\nint ext_diff,\r\nint state)\r\n{\r\nxfs_ifork_t *ifp = (state & BMAP_ATTRFORK) ? ip->i_afp : &ip->i_df;\r\nxfs_extnum_t nextents;\r\nint new_size;\r\ntrace_xfs_iext_remove(ip, idx, state, _RET_IP_);\r\nASSERT(ext_diff > 0);\r\nnextents = ifp->if_bytes / (uint)sizeof(xfs_bmbt_rec_t);\r\nnew_size = (nextents - ext_diff) * sizeof(xfs_bmbt_rec_t);\r\nif (new_size == 0) {\r\nxfs_iext_destroy(ifp);\r\n} else if (ifp->if_flags & XFS_IFEXTIREC) {\r\nxfs_iext_remove_indirect(ifp, idx, ext_diff);\r\n} else if (ifp->if_real_bytes) {\r\nxfs_iext_remove_direct(ifp, idx, ext_diff);\r\n} else {\r\nxfs_iext_remove_inline(ifp, idx, ext_diff);\r\n}\r\nifp->if_bytes = new_size;\r\n}\r\nvoid\r\nxfs_iext_remove_inline(\r\nxfs_ifork_t *ifp,\r\nxfs_extnum_t idx,\r\nint ext_diff)\r\n{\r\nint nextents;\r\nASSERT(!(ifp->if_flags & XFS_IFEXTIREC));\r\nASSERT(idx < XFS_INLINE_EXTS);\r\nnextents = ifp->if_bytes / (uint)sizeof(xfs_bmbt_rec_t);\r\nASSERT(((nextents - ext_diff) > 0) &&\r\n(nextents - ext_diff) < XFS_INLINE_EXTS);\r\nif (idx + ext_diff < nextents) {\r\nmemmove(&ifp->if_u2.if_inline_ext[idx],\r\n&ifp->if_u2.if_inline_ext[idx + ext_diff],\r\n(nextents - (idx + ext_diff)) *\r\nsizeof(xfs_bmbt_rec_t));\r\nmemset(&ifp->if_u2.if_inline_ext[nextents - ext_diff],\r\n0, ext_diff * sizeof(xfs_bmbt_rec_t));\r\n} else {\r\nmemset(&ifp->if_u2.if_inline_ext[idx], 0,\r\next_diff * sizeof(xfs_bmbt_rec_t));\r\n}\r\n}\r\nvoid\r\nxfs_iext_remove_direct(\r\nxfs_ifork_t *ifp,\r\nxfs_extnum_t idx,\r\nint ext_diff)\r\n{\r\nxfs_extnum_t nextents;\r\nint new_size;\r\nASSERT(!(ifp->if_flags & XFS_IFEXTIREC));\r\nnew_size = ifp->if_bytes -\r\n(ext_diff * sizeof(xfs_bmbt_rec_t));\r\nnextents = ifp->if_bytes / (uint)sizeof(xfs_bmbt_rec_t);\r\nif (new_size == 0) {\r\nxfs_iext_destroy(ifp);\r\nreturn;\r\n}\r\nif (idx + ext_diff < nextents) {\r\nmemmove(&ifp->if_u1.if_extents[idx],\r\n&ifp->if_u1.if_extents[idx + ext_diff],\r\n(nextents - (idx + ext_diff)) *\r\nsizeof(xfs_bmbt_rec_t));\r\n}\r\nmemset(&ifp->if_u1.if_extents[nextents - ext_diff],\r\n0, ext_diff * sizeof(xfs_bmbt_rec_t));\r\nxfs_iext_realloc_direct(ifp, new_size);\r\nifp->if_bytes = new_size;\r\n}\r\nvoid\r\nxfs_iext_remove_indirect(\r\nxfs_ifork_t *ifp,\r\nxfs_extnum_t idx,\r\nint count)\r\n{\r\nxfs_ext_irec_t *erp;\r\nint erp_idx = 0;\r\nxfs_extnum_t ext_cnt;\r\nxfs_extnum_t ext_diff;\r\nxfs_extnum_t nex1;\r\nxfs_extnum_t nex2;\r\nint page_idx = idx;\r\nASSERT(ifp->if_flags & XFS_IFEXTIREC);\r\nerp = xfs_iext_idx_to_irec(ifp, &page_idx, &erp_idx, 0);\r\nASSERT(erp != NULL);\r\nnex1 = page_idx;\r\next_cnt = count;\r\nwhile (ext_cnt) {\r\nnex2 = MAX((erp->er_extcount - (nex1 + ext_cnt)), 0);\r\next_diff = MIN(ext_cnt, (erp->er_extcount - nex1));\r\nif (ext_diff == erp->er_extcount) {\r\nxfs_iext_irec_remove(ifp, erp_idx);\r\next_cnt -= ext_diff;\r\nnex1 = 0;\r\nif (ext_cnt) {\r\nASSERT(erp_idx < ifp->if_real_bytes /\r\nXFS_IEXT_BUFSZ);\r\nerp = &ifp->if_u1.if_ext_irec[erp_idx];\r\nnex1 = 0;\r\ncontinue;\r\n} else {\r\nbreak;\r\n}\r\n}\r\nif (nex2) {\r\nmemmove(&erp->er_extbuf[nex1],\r\n&erp->er_extbuf[nex1 + ext_diff],\r\nnex2 * sizeof(xfs_bmbt_rec_t));\r\n}\r\nmemset(&erp->er_extbuf[nex1 + nex2], 0, (XFS_IEXT_BUFSZ -\r\n((nex1 + nex2) * sizeof(xfs_bmbt_rec_t))));\r\nerp->er_extcount -= ext_diff;\r\nxfs_iext_irec_update_extoffs(ifp, erp_idx + 1, -ext_diff);\r\next_cnt -= ext_diff;\r\nnex1 = 0;\r\nerp_idx++;\r\nerp++;\r\n}\r\nifp->if_bytes -= count * sizeof(xfs_bmbt_rec_t);\r\nxfs_iext_irec_compact(ifp);\r\n}\r\nvoid\r\nxfs_iext_realloc_direct(\r\nxfs_ifork_t *ifp,\r\nint new_size)\r\n{\r\nint rnew_size;\r\nrnew_size = new_size;\r\nASSERT(!(ifp->if_flags & XFS_IFEXTIREC) ||\r\n((new_size >= 0) && (new_size <= XFS_IEXT_BUFSZ) &&\r\n(new_size != ifp->if_real_bytes)));\r\nif (new_size == 0) {\r\nxfs_iext_destroy(ifp);\r\n}\r\nelse if (ifp->if_real_bytes) {\r\nif (new_size <= XFS_INLINE_EXTS * sizeof(xfs_bmbt_rec_t)) {\r\nxfs_iext_direct_to_inline(ifp, new_size /\r\n(uint)sizeof(xfs_bmbt_rec_t));\r\nifp->if_bytes = new_size;\r\nreturn;\r\n}\r\nif (!is_power_of_2(new_size)){\r\nrnew_size = roundup_pow_of_two(new_size);\r\n}\r\nif (rnew_size != ifp->if_real_bytes) {\r\nifp->if_u1.if_extents =\r\nkmem_realloc(ifp->if_u1.if_extents,\r\nrnew_size,\r\nifp->if_real_bytes, KM_NOFS);\r\n}\r\nif (rnew_size > ifp->if_real_bytes) {\r\nmemset(&ifp->if_u1.if_extents[ifp->if_bytes /\r\n(uint)sizeof(xfs_bmbt_rec_t)], 0,\r\nrnew_size - ifp->if_real_bytes);\r\n}\r\n}\r\nelse {\r\nif (!is_power_of_2(new_size)) {\r\nrnew_size = roundup_pow_of_two(new_size);\r\n}\r\nxfs_iext_inline_to_direct(ifp, rnew_size);\r\n}\r\nifp->if_real_bytes = rnew_size;\r\nifp->if_bytes = new_size;\r\n}\r\nvoid\r\nxfs_iext_direct_to_inline(\r\nxfs_ifork_t *ifp,\r\nxfs_extnum_t nextents)\r\n{\r\nASSERT(ifp->if_flags & XFS_IFEXTENTS);\r\nASSERT(nextents <= XFS_INLINE_EXTS);\r\nmemcpy(ifp->if_u2.if_inline_ext, ifp->if_u1.if_extents,\r\nnextents * sizeof(xfs_bmbt_rec_t));\r\nkmem_free(ifp->if_u1.if_extents);\r\nifp->if_u1.if_extents = ifp->if_u2.if_inline_ext;\r\nifp->if_real_bytes = 0;\r\n}\r\nvoid\r\nxfs_iext_inline_to_direct(\r\nxfs_ifork_t *ifp,\r\nint new_size)\r\n{\r\nifp->if_u1.if_extents = kmem_alloc(new_size, KM_NOFS);\r\nmemset(ifp->if_u1.if_extents, 0, new_size);\r\nif (ifp->if_bytes) {\r\nmemcpy(ifp->if_u1.if_extents, ifp->if_u2.if_inline_ext,\r\nifp->if_bytes);\r\nmemset(ifp->if_u2.if_inline_ext, 0, XFS_INLINE_EXTS *\r\nsizeof(xfs_bmbt_rec_t));\r\n}\r\nifp->if_real_bytes = new_size;\r\n}\r\nSTATIC void\r\nxfs_iext_realloc_indirect(\r\nxfs_ifork_t *ifp,\r\nint new_size)\r\n{\r\nint nlists;\r\nint size;\r\nASSERT(ifp->if_flags & XFS_IFEXTIREC);\r\nnlists = ifp->if_real_bytes / XFS_IEXT_BUFSZ;\r\nsize = nlists * sizeof(xfs_ext_irec_t);\r\nASSERT(ifp->if_real_bytes);\r\nASSERT((new_size >= 0) && (new_size != size));\r\nif (new_size == 0) {\r\nxfs_iext_destroy(ifp);\r\n} else {\r\nifp->if_u1.if_ext_irec = (xfs_ext_irec_t *)\r\nkmem_realloc(ifp->if_u1.if_ext_irec,\r\nnew_size, size, KM_NOFS);\r\n}\r\n}\r\nSTATIC void\r\nxfs_iext_indirect_to_direct(\r\nxfs_ifork_t *ifp)\r\n{\r\nxfs_bmbt_rec_host_t *ep;\r\nxfs_extnum_t nextents;\r\nint size;\r\nASSERT(ifp->if_flags & XFS_IFEXTIREC);\r\nnextents = ifp->if_bytes / (uint)sizeof(xfs_bmbt_rec_t);\r\nASSERT(nextents <= XFS_LINEAR_EXTS);\r\nsize = nextents * sizeof(xfs_bmbt_rec_t);\r\nxfs_iext_irec_compact_pages(ifp);\r\nASSERT(ifp->if_real_bytes == XFS_IEXT_BUFSZ);\r\nep = ifp->if_u1.if_ext_irec->er_extbuf;\r\nkmem_free(ifp->if_u1.if_ext_irec);\r\nifp->if_flags &= ~XFS_IFEXTIREC;\r\nifp->if_u1.if_extents = ep;\r\nifp->if_bytes = size;\r\nif (nextents < XFS_LINEAR_EXTS) {\r\nxfs_iext_realloc_direct(ifp, size);\r\n}\r\n}\r\nvoid\r\nxfs_iext_destroy(\r\nxfs_ifork_t *ifp)\r\n{\r\nif (ifp->if_flags & XFS_IFEXTIREC) {\r\nint erp_idx;\r\nint nlists;\r\nnlists = ifp->if_real_bytes / XFS_IEXT_BUFSZ;\r\nfor (erp_idx = nlists - 1; erp_idx >= 0 ; erp_idx--) {\r\nxfs_iext_irec_remove(ifp, erp_idx);\r\n}\r\nifp->if_flags &= ~XFS_IFEXTIREC;\r\n} else if (ifp->if_real_bytes) {\r\nkmem_free(ifp->if_u1.if_extents);\r\n} else if (ifp->if_bytes) {\r\nmemset(ifp->if_u2.if_inline_ext, 0, XFS_INLINE_EXTS *\r\nsizeof(xfs_bmbt_rec_t));\r\n}\r\nifp->if_u1.if_extents = NULL;\r\nifp->if_real_bytes = 0;\r\nifp->if_bytes = 0;\r\n}\r\nxfs_bmbt_rec_host_t *\r\nxfs_iext_bno_to_ext(\r\nxfs_ifork_t *ifp,\r\nxfs_fileoff_t bno,\r\nxfs_extnum_t *idxp)\r\n{\r\nxfs_bmbt_rec_host_t *base;\r\nxfs_filblks_t blockcount = 0;\r\nxfs_bmbt_rec_host_t *ep = NULL;\r\nxfs_ext_irec_t *erp = NULL;\r\nint high;\r\nxfs_extnum_t idx = 0;\r\nint low;\r\nxfs_extnum_t nextents;\r\nxfs_fileoff_t startoff = 0;\r\nnextents = ifp->if_bytes / (uint)sizeof(xfs_bmbt_rec_t);\r\nif (nextents == 0) {\r\n*idxp = 0;\r\nreturn NULL;\r\n}\r\nlow = 0;\r\nif (ifp->if_flags & XFS_IFEXTIREC) {\r\nint erp_idx = 0;\r\nerp = xfs_iext_bno_to_irec(ifp, bno, &erp_idx);\r\nbase = erp->er_extbuf;\r\nhigh = erp->er_extcount - 1;\r\n} else {\r\nbase = ifp->if_u1.if_extents;\r\nhigh = nextents - 1;\r\n}\r\nwhile (low <= high) {\r\nidx = (low + high) >> 1;\r\nep = base + idx;\r\nstartoff = xfs_bmbt_get_startoff(ep);\r\nblockcount = xfs_bmbt_get_blockcount(ep);\r\nif (bno < startoff) {\r\nhigh = idx - 1;\r\n} else if (bno >= startoff + blockcount) {\r\nlow = idx + 1;\r\n} else {\r\nif (ifp->if_flags & XFS_IFEXTIREC) {\r\nidx += erp->er_extoff;\r\n}\r\n*idxp = idx;\r\nreturn ep;\r\n}\r\n}\r\nif (ifp->if_flags & XFS_IFEXTIREC) {\r\nidx += erp->er_extoff;\r\n}\r\nif (bno >= startoff + blockcount) {\r\nif (++idx == nextents) {\r\nep = NULL;\r\n} else {\r\nep = xfs_iext_get_ext(ifp, idx);\r\n}\r\n}\r\n*idxp = idx;\r\nreturn ep;\r\n}\r\nxfs_ext_irec_t *\r\nxfs_iext_bno_to_irec(\r\nxfs_ifork_t *ifp,\r\nxfs_fileoff_t bno,\r\nint *erp_idxp)\r\n{\r\nxfs_ext_irec_t *erp = NULL;\r\nxfs_ext_irec_t *erp_next;\r\nint erp_idx;\r\nint nlists;\r\nint high;\r\nint low;\r\nASSERT(ifp->if_flags & XFS_IFEXTIREC);\r\nnlists = ifp->if_real_bytes / XFS_IEXT_BUFSZ;\r\nerp_idx = 0;\r\nlow = 0;\r\nhigh = nlists - 1;\r\nwhile (low <= high) {\r\nerp_idx = (low + high) >> 1;\r\nerp = &ifp->if_u1.if_ext_irec[erp_idx];\r\nerp_next = erp_idx < nlists - 1 ? erp + 1 : NULL;\r\nif (bno < xfs_bmbt_get_startoff(erp->er_extbuf)) {\r\nhigh = erp_idx - 1;\r\n} else if (erp_next && bno >=\r\nxfs_bmbt_get_startoff(erp_next->er_extbuf)) {\r\nlow = erp_idx + 1;\r\n} else {\r\nbreak;\r\n}\r\n}\r\n*erp_idxp = erp_idx;\r\nreturn erp;\r\n}\r\nxfs_ext_irec_t *\r\nxfs_iext_idx_to_irec(\r\nxfs_ifork_t *ifp,\r\nxfs_extnum_t *idxp,\r\nint *erp_idxp,\r\nint realloc)\r\n{\r\nxfs_ext_irec_t *prev;\r\nxfs_ext_irec_t *erp = NULL;\r\nint erp_idx;\r\nint nlists;\r\nint high;\r\nint low;\r\nxfs_extnum_t page_idx = *idxp;\r\nASSERT(ifp->if_flags & XFS_IFEXTIREC);\r\nASSERT(page_idx >= 0);\r\nASSERT(page_idx <= ifp->if_bytes / sizeof(xfs_bmbt_rec_t));\r\nASSERT(page_idx < ifp->if_bytes / sizeof(xfs_bmbt_rec_t) || realloc);\r\nnlists = ifp->if_real_bytes / XFS_IEXT_BUFSZ;\r\nerp_idx = 0;\r\nlow = 0;\r\nhigh = nlists - 1;\r\nwhile (low <= high) {\r\nerp_idx = (low + high) >> 1;\r\nerp = &ifp->if_u1.if_ext_irec[erp_idx];\r\nprev = erp_idx > 0 ? erp - 1 : NULL;\r\nif (page_idx < erp->er_extoff || (page_idx == erp->er_extoff &&\r\nrealloc && prev && prev->er_extcount < XFS_LINEAR_EXTS)) {\r\nhigh = erp_idx - 1;\r\n} else if (page_idx > erp->er_extoff + erp->er_extcount ||\r\n(page_idx == erp->er_extoff + erp->er_extcount &&\r\n!realloc)) {\r\nlow = erp_idx + 1;\r\n} else if (page_idx == erp->er_extoff + erp->er_extcount &&\r\nerp->er_extcount == XFS_LINEAR_EXTS) {\r\nASSERT(realloc);\r\npage_idx = 0;\r\nerp_idx++;\r\nerp = erp_idx < nlists ? erp + 1 : NULL;\r\nbreak;\r\n} else {\r\npage_idx -= erp->er_extoff;\r\nbreak;\r\n}\r\n}\r\n*idxp = page_idx;\r\n*erp_idxp = erp_idx;\r\nreturn(erp);\r\n}\r\nvoid\r\nxfs_iext_irec_init(\r\nxfs_ifork_t *ifp)\r\n{\r\nxfs_ext_irec_t *erp;\r\nxfs_extnum_t nextents;\r\nASSERT(!(ifp->if_flags & XFS_IFEXTIREC));\r\nnextents = ifp->if_bytes / (uint)sizeof(xfs_bmbt_rec_t);\r\nASSERT(nextents <= XFS_LINEAR_EXTS);\r\nerp = kmem_alloc(sizeof(xfs_ext_irec_t), KM_NOFS);\r\nif (nextents == 0) {\r\nifp->if_u1.if_extents = kmem_alloc(XFS_IEXT_BUFSZ, KM_NOFS);\r\n} else if (!ifp->if_real_bytes) {\r\nxfs_iext_inline_to_direct(ifp, XFS_IEXT_BUFSZ);\r\n} else if (ifp->if_real_bytes < XFS_IEXT_BUFSZ) {\r\nxfs_iext_realloc_direct(ifp, XFS_IEXT_BUFSZ);\r\n}\r\nerp->er_extbuf = ifp->if_u1.if_extents;\r\nerp->er_extcount = nextents;\r\nerp->er_extoff = 0;\r\nifp->if_flags |= XFS_IFEXTIREC;\r\nifp->if_real_bytes = XFS_IEXT_BUFSZ;\r\nifp->if_bytes = nextents * sizeof(xfs_bmbt_rec_t);\r\nifp->if_u1.if_ext_irec = erp;\r\nreturn;\r\n}\r\nxfs_ext_irec_t *\r\nxfs_iext_irec_new(\r\nxfs_ifork_t *ifp,\r\nint erp_idx)\r\n{\r\nxfs_ext_irec_t *erp;\r\nint i;\r\nint nlists;\r\nASSERT(ifp->if_flags & XFS_IFEXTIREC);\r\nnlists = ifp->if_real_bytes / XFS_IEXT_BUFSZ;\r\nxfs_iext_realloc_indirect(ifp, ++nlists *\r\nsizeof(xfs_ext_irec_t));\r\nerp = ifp->if_u1.if_ext_irec;\r\nfor (i = nlists - 1; i > erp_idx; i--) {\r\nmemmove(&erp[i], &erp[i-1], sizeof(xfs_ext_irec_t));\r\n}\r\nASSERT(i == erp_idx);\r\nerp = ifp->if_u1.if_ext_irec;\r\nerp[erp_idx].er_extbuf = kmem_alloc(XFS_IEXT_BUFSZ, KM_NOFS);\r\nifp->if_real_bytes = nlists * XFS_IEXT_BUFSZ;\r\nmemset(erp[erp_idx].er_extbuf, 0, XFS_IEXT_BUFSZ);\r\nerp[erp_idx].er_extcount = 0;\r\nerp[erp_idx].er_extoff = erp_idx > 0 ?\r\nerp[erp_idx-1].er_extoff + erp[erp_idx-1].er_extcount : 0;\r\nreturn (&erp[erp_idx]);\r\n}\r\nvoid\r\nxfs_iext_irec_remove(\r\nxfs_ifork_t *ifp,\r\nint erp_idx)\r\n{\r\nxfs_ext_irec_t *erp;\r\nint i;\r\nint nlists;\r\nASSERT(ifp->if_flags & XFS_IFEXTIREC);\r\nnlists = ifp->if_real_bytes / XFS_IEXT_BUFSZ;\r\nerp = &ifp->if_u1.if_ext_irec[erp_idx];\r\nif (erp->er_extbuf) {\r\nxfs_iext_irec_update_extoffs(ifp, erp_idx + 1,\r\n-erp->er_extcount);\r\nkmem_free(erp->er_extbuf);\r\n}\r\nerp = ifp->if_u1.if_ext_irec;\r\nfor (i = erp_idx; i < nlists - 1; i++) {\r\nmemmove(&erp[i], &erp[i+1], sizeof(xfs_ext_irec_t));\r\n}\r\nif (--nlists) {\r\nxfs_iext_realloc_indirect(ifp,\r\nnlists * sizeof(xfs_ext_irec_t));\r\n} else {\r\nkmem_free(ifp->if_u1.if_ext_irec);\r\n}\r\nifp->if_real_bytes = nlists * XFS_IEXT_BUFSZ;\r\n}\r\nvoid\r\nxfs_iext_irec_compact(\r\nxfs_ifork_t *ifp)\r\n{\r\nxfs_extnum_t nextents;\r\nint nlists;\r\nASSERT(ifp->if_flags & XFS_IFEXTIREC);\r\nnlists = ifp->if_real_bytes / XFS_IEXT_BUFSZ;\r\nnextents = ifp->if_bytes / (uint)sizeof(xfs_bmbt_rec_t);\r\nif (nextents == 0) {\r\nxfs_iext_destroy(ifp);\r\n} else if (nextents <= XFS_INLINE_EXTS) {\r\nxfs_iext_indirect_to_direct(ifp);\r\nxfs_iext_direct_to_inline(ifp, nextents);\r\n} else if (nextents <= XFS_LINEAR_EXTS) {\r\nxfs_iext_indirect_to_direct(ifp);\r\n} else if (nextents < (nlists * XFS_LINEAR_EXTS) >> 1) {\r\nxfs_iext_irec_compact_pages(ifp);\r\n}\r\n}\r\nvoid\r\nxfs_iext_irec_compact_pages(\r\nxfs_ifork_t *ifp)\r\n{\r\nxfs_ext_irec_t *erp, *erp_next;\r\nint erp_idx = 0;\r\nint nlists;\r\nASSERT(ifp->if_flags & XFS_IFEXTIREC);\r\nnlists = ifp->if_real_bytes / XFS_IEXT_BUFSZ;\r\nwhile (erp_idx < nlists - 1) {\r\nerp = &ifp->if_u1.if_ext_irec[erp_idx];\r\nerp_next = erp + 1;\r\nif (erp_next->er_extcount <=\r\n(XFS_LINEAR_EXTS - erp->er_extcount)) {\r\nmemcpy(&erp->er_extbuf[erp->er_extcount],\r\nerp_next->er_extbuf, erp_next->er_extcount *\r\nsizeof(xfs_bmbt_rec_t));\r\nerp->er_extcount += erp_next->er_extcount;\r\nkmem_free(erp_next->er_extbuf);\r\nerp_next->er_extbuf = NULL;\r\nxfs_iext_irec_remove(ifp, erp_idx + 1);\r\nnlists = ifp->if_real_bytes / XFS_IEXT_BUFSZ;\r\n} else {\r\nerp_idx++;\r\n}\r\n}\r\n}\r\nvoid\r\nxfs_iext_irec_update_extoffs(\r\nxfs_ifork_t *ifp,\r\nint erp_idx,\r\nint ext_diff)\r\n{\r\nint i;\r\nint nlists;\r\nASSERT(ifp->if_flags & XFS_IFEXTIREC);\r\nnlists = ifp->if_real_bytes / XFS_IEXT_BUFSZ;\r\nfor (i = erp_idx; i < nlists; i++) {\r\nifp->if_u1.if_ext_irec[i].er_extoff += ext_diff;\r\n}\r\n}

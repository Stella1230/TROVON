void __init cpm_load_patch(cpm8xx_t *cp)\r\n{\r\nvolatile uint *dp;\r\nvolatile cpm8xx_t *commproc;\r\n#if defined(CONFIG_I2C_SPI_UCODE_PATCH) || \\r\ndefined(CONFIG_I2C_SPI_SMC1_UCODE_PATCH)\r\nvolatile iic_t *iip;\r\nvolatile struct spi_pram *spp;\r\n#ifdef CONFIG_I2C_SPI_SMC1_UCODE_PATCH\r\nvolatile smc_uart_t *smp;\r\n#endif\r\n#endif\r\nint i;\r\ncommproc = cp;\r\n#ifdef CONFIG_USB_SOF_UCODE_PATCH\r\ncommproc->cp_rccr = 0;\r\ndp = (uint *)(commproc->cp_dpmem);\r\nfor (i=0; i<(sizeof(patch_2000)/4); i++)\r\n*dp++ = patch_2000[i];\r\ndp = (uint *)&(commproc->cp_dpmem[0x0f00]);\r\nfor (i=0; i<(sizeof(patch_2f00)/4); i++)\r\n*dp++ = patch_2f00[i];\r\ncommproc->cp_rccr = 0x0009;\r\nprintk("USB SOF microcode patch installed\n");\r\n#endif\r\n#if defined(CONFIG_I2C_SPI_UCODE_PATCH) || \\r\ndefined(CONFIG_I2C_SPI_SMC1_UCODE_PATCH)\r\ncommproc->cp_rccr = 0;\r\ndp = (uint *)(commproc->cp_dpmem);\r\nfor (i=0; i<(sizeof(patch_2000)/4); i++)\r\n*dp++ = patch_2000[i];\r\ndp = (uint *)&(commproc->cp_dpmem[0x0f00]);\r\nfor (i=0; i<(sizeof(patch_2f00)/4); i++)\r\n*dp++ = patch_2f00[i];\r\niip = (iic_t *)&commproc->cp_dparam[PROFF_IIC];\r\n# define RPBASE 0x0500\r\niip->iic_rpbase = RPBASE;\r\ni = (RPBASE + sizeof(iic_t) + 31) & ~31;\r\nspp = (struct spi_pram *)&commproc->cp_dparam[PROFF_SPI];\r\nspp->rpbase = i;\r\n# if defined(CONFIG_I2C_SPI_UCODE_PATCH)\r\ncommproc->cp_cpmcr1 = 0x802a;\r\ncommproc->cp_cpmcr2 = 0x8028;\r\ncommproc->cp_cpmcr3 = 0x802e;\r\ncommproc->cp_cpmcr4 = 0x802c;\r\ncommproc->cp_rccr = 1;\r\nprintk("I2C/SPI microcode patch installed.\n");\r\n# endif\r\n# if defined(CONFIG_I2C_SPI_SMC1_UCODE_PATCH)\r\ndp = (uint *)&(commproc->cp_dpmem[0x0e00]);\r\nfor (i=0; i<(sizeof(patch_2e00)/4); i++)\r\n*dp++ = patch_2e00[i];\r\ncommproc->cp_cpmcr1 = 0x8080;\r\ncommproc->cp_cpmcr2 = 0x808a;\r\ncommproc->cp_cpmcr3 = 0x8028;\r\ncommproc->cp_cpmcr4 = 0x802a;\r\ncommproc->cp_rccr = 3;\r\nsmp = (smc_uart_t *)&commproc->cp_dparam[PROFF_SMC1];\r\nsmp->smc_rpbase = 0x1FC0;\r\nprintk("I2C/SPI/SMC1 microcode patch installed.\n");\r\n# endif\r\n#endif\r\n}

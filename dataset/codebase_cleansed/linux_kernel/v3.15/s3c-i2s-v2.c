static inline struct s3c_i2sv2_info *to_info(struct snd_soc_dai *cpu_dai)\r\n{\r\nreturn snd_soc_dai_get_drvdata(cpu_dai);\r\n}\r\nstatic void dbg_showcon(const char *fn, u32 con)\r\n{\r\nprintk(KERN_DEBUG "%s: LRI=%d, TXFEMPT=%d, RXFEMPT=%d, TXFFULL=%d, RXFFULL=%d\n", fn,\r\nbit_set(con, S3C2412_IISCON_LRINDEX),\r\nbit_set(con, S3C2412_IISCON_TXFIFO_EMPTY),\r\nbit_set(con, S3C2412_IISCON_RXFIFO_EMPTY),\r\nbit_set(con, S3C2412_IISCON_TXFIFO_FULL),\r\nbit_set(con, S3C2412_IISCON_RXFIFO_FULL));\r\nprintk(KERN_DEBUG "%s: PAUSE: TXDMA=%d, RXDMA=%d, TXCH=%d, RXCH=%d\n",\r\nfn,\r\nbit_set(con, S3C2412_IISCON_TXDMA_PAUSE),\r\nbit_set(con, S3C2412_IISCON_RXDMA_PAUSE),\r\nbit_set(con, S3C2412_IISCON_TXCH_PAUSE),\r\nbit_set(con, S3C2412_IISCON_RXCH_PAUSE));\r\nprintk(KERN_DEBUG "%s: ACTIVE: TXDMA=%d, RXDMA=%d, IIS=%d\n", fn,\r\nbit_set(con, S3C2412_IISCON_TXDMA_ACTIVE),\r\nbit_set(con, S3C2412_IISCON_RXDMA_ACTIVE),\r\nbit_set(con, S3C2412_IISCON_IIS_ACTIVE));\r\n}\r\nstatic inline void dbg_showcon(const char *fn, u32 con)\r\n{\r\n}\r\nstatic void s3c2412_snd_txctrl(struct s3c_i2sv2_info *i2s, int on)\r\n{\r\nvoid __iomem *regs = i2s->regs;\r\nu32 fic, con, mod;\r\npr_debug("%s(%d)\n", __func__, on);\r\nfic = readl(regs + S3C2412_IISFIC);\r\ncon = readl(regs + S3C2412_IISCON);\r\nmod = readl(regs + S3C2412_IISMOD);\r\npr_debug("%s: IIS: CON=%x MOD=%x FIC=%x\n", __func__, con, mod, fic);\r\nif (on) {\r\ncon |= S3C2412_IISCON_TXDMA_ACTIVE | S3C2412_IISCON_IIS_ACTIVE;\r\ncon &= ~S3C2412_IISCON_TXDMA_PAUSE;\r\ncon &= ~S3C2412_IISCON_TXCH_PAUSE;\r\nswitch (mod & S3C2412_IISMOD_MODE_MASK) {\r\ncase S3C2412_IISMOD_MODE_TXONLY:\r\ncase S3C2412_IISMOD_MODE_TXRX:\r\nbreak;\r\ncase S3C2412_IISMOD_MODE_RXONLY:\r\nmod &= ~S3C2412_IISMOD_MODE_MASK;\r\nmod |= S3C2412_IISMOD_MODE_TXRX;\r\nbreak;\r\ndefault:\r\ndev_err(i2s->dev, "TXEN: Invalid MODE %x in IISMOD\n",\r\nmod & S3C2412_IISMOD_MODE_MASK);\r\nbreak;\r\n}\r\nwritel(con, regs + S3C2412_IISCON);\r\nwritel(mod, regs + S3C2412_IISMOD);\r\n} else {\r\ncon |= S3C2412_IISCON_TXDMA_PAUSE;\r\ncon |= S3C2412_IISCON_TXCH_PAUSE;\r\ncon &= ~S3C2412_IISCON_TXDMA_ACTIVE;\r\nswitch (mod & S3C2412_IISMOD_MODE_MASK) {\r\ncase S3C2412_IISMOD_MODE_TXRX:\r\nmod &= ~S3C2412_IISMOD_MODE_MASK;\r\nmod |= S3C2412_IISMOD_MODE_RXONLY;\r\nbreak;\r\ncase S3C2412_IISMOD_MODE_TXONLY:\r\nmod &= ~S3C2412_IISMOD_MODE_MASK;\r\ncon &= ~S3C2412_IISCON_IIS_ACTIVE;\r\nbreak;\r\ndefault:\r\ndev_err(i2s->dev, "TXDIS: Invalid MODE %x in IISMOD\n",\r\nmod & S3C2412_IISMOD_MODE_MASK);\r\nbreak;\r\n}\r\nwritel(mod, regs + S3C2412_IISMOD);\r\nwritel(con, regs + S3C2412_IISCON);\r\n}\r\nfic = readl(regs + S3C2412_IISFIC);\r\ndbg_showcon(__func__, con);\r\npr_debug("%s: IIS: CON=%x MOD=%x FIC=%x\n", __func__, con, mod, fic);\r\n}\r\nstatic void s3c2412_snd_rxctrl(struct s3c_i2sv2_info *i2s, int on)\r\n{\r\nvoid __iomem *regs = i2s->regs;\r\nu32 fic, con, mod;\r\npr_debug("%s(%d)\n", __func__, on);\r\nfic = readl(regs + S3C2412_IISFIC);\r\ncon = readl(regs + S3C2412_IISCON);\r\nmod = readl(regs + S3C2412_IISMOD);\r\npr_debug("%s: IIS: CON=%x MOD=%x FIC=%x\n", __func__, con, mod, fic);\r\nif (on) {\r\ncon |= S3C2412_IISCON_RXDMA_ACTIVE | S3C2412_IISCON_IIS_ACTIVE;\r\ncon &= ~S3C2412_IISCON_RXDMA_PAUSE;\r\ncon &= ~S3C2412_IISCON_RXCH_PAUSE;\r\nswitch (mod & S3C2412_IISMOD_MODE_MASK) {\r\ncase S3C2412_IISMOD_MODE_TXRX:\r\ncase S3C2412_IISMOD_MODE_RXONLY:\r\nbreak;\r\ncase S3C2412_IISMOD_MODE_TXONLY:\r\nmod &= ~S3C2412_IISMOD_MODE_MASK;\r\nmod |= S3C2412_IISMOD_MODE_TXRX;\r\nbreak;\r\ndefault:\r\ndev_err(i2s->dev, "RXEN: Invalid MODE %x in IISMOD\n",\r\nmod & S3C2412_IISMOD_MODE_MASK);\r\n}\r\nwritel(mod, regs + S3C2412_IISMOD);\r\nwritel(con, regs + S3C2412_IISCON);\r\n} else {\r\ncon &= ~S3C2412_IISCON_RXDMA_ACTIVE;\r\ncon |= S3C2412_IISCON_RXDMA_PAUSE;\r\ncon |= S3C2412_IISCON_RXCH_PAUSE;\r\nswitch (mod & S3C2412_IISMOD_MODE_MASK) {\r\ncase S3C2412_IISMOD_MODE_RXONLY:\r\ncon &= ~S3C2412_IISCON_IIS_ACTIVE;\r\nmod &= ~S3C2412_IISMOD_MODE_MASK;\r\nbreak;\r\ncase S3C2412_IISMOD_MODE_TXRX:\r\nmod &= ~S3C2412_IISMOD_MODE_MASK;\r\nmod |= S3C2412_IISMOD_MODE_TXONLY;\r\nbreak;\r\ndefault:\r\ndev_err(i2s->dev, "RXDIS: Invalid MODE %x in IISMOD\n",\r\nmod & S3C2412_IISMOD_MODE_MASK);\r\n}\r\nwritel(con, regs + S3C2412_IISCON);\r\nwritel(mod, regs + S3C2412_IISMOD);\r\n}\r\nfic = readl(regs + S3C2412_IISFIC);\r\npr_debug("%s: IIS: CON=%x MOD=%x FIC=%x\n", __func__, con, mod, fic);\r\n}\r\nstatic int s3c2412_snd_lrsync(struct s3c_i2sv2_info *i2s)\r\n{\r\nu32 iiscon;\r\nunsigned long loops = msecs_to_loops(5);\r\npr_debug("Entered %s\n", __func__);\r\nwhile (--loops) {\r\niiscon = readl(i2s->regs + S3C2412_IISCON);\r\nif (iiscon & S3C2412_IISCON_LRINDEX)\r\nbreak;\r\ncpu_relax();\r\n}\r\nif (!loops) {\r\nprintk(KERN_ERR "%s: timeout\n", __func__);\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int s3c2412_i2s_set_fmt(struct snd_soc_dai *cpu_dai,\r\nunsigned int fmt)\r\n{\r\nstruct s3c_i2sv2_info *i2s = to_info(cpu_dai);\r\nu32 iismod;\r\npr_debug("Entered %s\n", __func__);\r\niismod = readl(i2s->regs + S3C2412_IISMOD);\r\npr_debug("hw_params r: IISMOD: %x \n", iismod);\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\ni2s->master = 0;\r\niismod |= S3C2412_IISMOD_SLAVE;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\ni2s->master = 1;\r\niismod &= ~S3C2412_IISMOD_SLAVE;\r\nbreak;\r\ndefault:\r\npr_err("unknwon master/slave format\n");\r\nreturn -EINVAL;\r\n}\r\niismod &= ~S3C2412_IISMOD_SDF_MASK;\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_RIGHT_J:\r\niismod |= S3C2412_IISMOD_LR_RLOW;\r\niismod |= S3C2412_IISMOD_SDF_MSB;\r\nbreak;\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\niismod |= S3C2412_IISMOD_LR_RLOW;\r\niismod |= S3C2412_IISMOD_SDF_LSB;\r\nbreak;\r\ncase SND_SOC_DAIFMT_I2S:\r\niismod &= ~S3C2412_IISMOD_LR_RLOW;\r\niismod |= S3C2412_IISMOD_SDF_IIS;\r\nbreak;\r\ndefault:\r\npr_err("Unknown data format\n");\r\nreturn -EINVAL;\r\n}\r\nwritel(iismod, i2s->regs + S3C2412_IISMOD);\r\npr_debug("hw_params w: IISMOD: %x \n", iismod);\r\nreturn 0;\r\n}\r\nstatic int s3c_i2sv2_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct s3c_i2sv2_info *i2s = to_info(dai);\r\nstruct s3c_dma_params *dma_data;\r\nu32 iismod;\r\npr_debug("Entered %s\n", __func__);\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\ndma_data = i2s->dma_playback;\r\nelse\r\ndma_data = i2s->dma_capture;\r\nsnd_soc_dai_set_dma_data(dai, substream, dma_data);\r\niismod = readl(i2s->regs + S3C2412_IISMOD);\r\npr_debug("%s: r: IISMOD: %x\n", __func__, iismod);\r\niismod &= ~S3C64XX_IISMOD_BLC_MASK;\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S8:\r\niismod |= S3C64XX_IISMOD_BLC_8BIT;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S24_LE:\r\niismod |= S3C64XX_IISMOD_BLC_24BIT;\r\nbreak;\r\n}\r\nwritel(iismod, i2s->regs + S3C2412_IISMOD);\r\npr_debug("%s: w: IISMOD: %x\n", __func__, iismod);\r\nreturn 0;\r\n}\r\nstatic int s3c_i2sv2_set_sysclk(struct snd_soc_dai *cpu_dai,\r\nint clk_id, unsigned int freq, int dir)\r\n{\r\nstruct s3c_i2sv2_info *i2s = to_info(cpu_dai);\r\nu32 iismod = readl(i2s->regs + S3C2412_IISMOD);\r\npr_debug("Entered %s\n", __func__);\r\npr_debug("%s r: IISMOD: %x\n", __func__, iismod);\r\nswitch (clk_id) {\r\ncase S3C_I2SV2_CLKSRC_PCLK:\r\niismod &= ~S3C2412_IISMOD_IMS_SYSMUX;\r\nbreak;\r\ncase S3C_I2SV2_CLKSRC_AUDIOBUS:\r\niismod |= S3C2412_IISMOD_IMS_SYSMUX;\r\nbreak;\r\ncase S3C_I2SV2_CLKSRC_CDCLK:\r\nif (!(i2s->feature & S3C_FEATURE_CDCLKCON))\r\nreturn -EINVAL;\r\nswitch (dir) {\r\ncase SND_SOC_CLOCK_IN:\r\niismod |= S3C64XX_IISMOD_CDCLKCON;\r\nbreak;\r\ncase SND_SOC_CLOCK_OUT:\r\niismod &= ~S3C64XX_IISMOD_CDCLKCON;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nwritel(iismod, i2s->regs + S3C2412_IISMOD);\r\npr_debug("%s w: IISMOD: %x\n", __func__, iismod);\r\nreturn 0;\r\n}\r\nstatic int s3c2412_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct s3c_i2sv2_info *i2s = to_info(rtd->cpu_dai);\r\nint capture = (substream->stream == SNDRV_PCM_STREAM_CAPTURE);\r\nunsigned long irqs;\r\nint ret = 0;\r\nstruct s3c_dma_params *dma_data =\r\nsnd_soc_dai_get_dma_data(rtd->cpu_dai, substream);\r\npr_debug("Entered %s\n", __func__);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nwritel(capture ? S3C2412_IISFIC_RXFLUSH : S3C2412_IISFIC_TXFLUSH,\r\ni2s->regs + S3C2412_IISFIC);\r\nwritel(0x0, i2s->regs + S3C2412_IISFIC);\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nif (!i2s->master) {\r\nret = s3c2412_snd_lrsync(i2s);\r\nif (ret)\r\ngoto exit_err;\r\n}\r\nlocal_irq_save(irqs);\r\nif (capture)\r\ns3c2412_snd_rxctrl(i2s, 1);\r\nelse\r\ns3c2412_snd_txctrl(i2s, 1);\r\nlocal_irq_restore(irqs);\r\ns3c2410_dma_ctrl(dma_data->channel, S3C2410_DMAOP_STARTED);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nlocal_irq_save(irqs);\r\nif (capture)\r\ns3c2412_snd_rxctrl(i2s, 0);\r\nelse\r\ns3c2412_snd_txctrl(i2s, 0);\r\nlocal_irq_restore(irqs);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nexit_err:\r\nreturn ret;\r\n}\r\nstatic int s3c2412_i2s_set_clkdiv(struct snd_soc_dai *cpu_dai,\r\nint div_id, int div)\r\n{\r\nstruct s3c_i2sv2_info *i2s = to_info(cpu_dai);\r\nu32 reg;\r\npr_debug("%s(%p, %d, %d)\n", __func__, cpu_dai, div_id, div);\r\nswitch (div_id) {\r\ncase S3C_I2SV2_DIV_BCLK:\r\nswitch (div) {\r\ncase 16:\r\ndiv = S3C2412_IISMOD_BCLK_16FS;\r\nbreak;\r\ncase 32:\r\ndiv = S3C2412_IISMOD_BCLK_32FS;\r\nbreak;\r\ncase 24:\r\ndiv = S3C2412_IISMOD_BCLK_24FS;\r\nbreak;\r\ncase 48:\r\ndiv = S3C2412_IISMOD_BCLK_48FS;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreg = readl(i2s->regs + S3C2412_IISMOD);\r\nreg &= ~S3C2412_IISMOD_BCLK_MASK;\r\nwritel(reg | div, i2s->regs + S3C2412_IISMOD);\r\npr_debug("%s: MOD=%08x\n", __func__, readl(i2s->regs + S3C2412_IISMOD));\r\nbreak;\r\ncase S3C_I2SV2_DIV_RCLK:\r\nswitch (div) {\r\ncase 256:\r\ndiv = S3C2412_IISMOD_RCLK_256FS;\r\nbreak;\r\ncase 384:\r\ndiv = S3C2412_IISMOD_RCLK_384FS;\r\nbreak;\r\ncase 512:\r\ndiv = S3C2412_IISMOD_RCLK_512FS;\r\nbreak;\r\ncase 768:\r\ndiv = S3C2412_IISMOD_RCLK_768FS;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreg = readl(i2s->regs + S3C2412_IISMOD);\r\nreg &= ~S3C2412_IISMOD_RCLK_MASK;\r\nwritel(reg | div, i2s->regs + S3C2412_IISMOD);\r\npr_debug("%s: MOD=%08x\n", __func__, readl(i2s->regs + S3C2412_IISMOD));\r\nbreak;\r\ncase S3C_I2SV2_DIV_PRESCALER:\r\nif (div >= 0) {\r\nwritel((div << 8) | S3C2412_IISPSR_PSREN,\r\ni2s->regs + S3C2412_IISPSR);\r\n} else {\r\nwritel(0x0, i2s->regs + S3C2412_IISPSR);\r\n}\r\npr_debug("%s: PSR=%08x\n", __func__, readl(i2s->regs + S3C2412_IISPSR));\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic snd_pcm_sframes_t s3c2412_i2s_delay(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct s3c_i2sv2_info *i2s = to_info(dai);\r\nu32 reg = readl(i2s->regs + S3C2412_IISFIC);\r\nsnd_pcm_sframes_t delay;\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\ndelay = S3C2412_IISFIC_TXCOUNT(reg);\r\nelse\r\ndelay = S3C2412_IISFIC_RXCOUNT(reg);\r\nreturn delay;\r\n}\r\nstruct clk *s3c_i2sv2_get_clock(struct snd_soc_dai *cpu_dai)\r\n{\r\nstruct s3c_i2sv2_info *i2s = to_info(cpu_dai);\r\nu32 iismod = readl(i2s->regs + S3C2412_IISMOD);\r\nif (iismod & S3C2412_IISMOD_IMS_SYSMUX)\r\nreturn i2s->iis_cclk;\r\nelse\r\nreturn i2s->iis_pclk;\r\n}\r\nint s3c_i2sv2_iis_calc_rate(struct s3c_i2sv2_rate_calc *info,\r\nunsigned int *fstab,\r\nunsigned int rate, struct clk *clk)\r\n{\r\nunsigned long clkrate = clk_get_rate(clk);\r\nunsigned int div;\r\nunsigned int fsclk;\r\nunsigned int actual;\r\nunsigned int fs;\r\nunsigned int fsdiv;\r\nsigned int deviation = 0;\r\nunsigned int best_fs = 0;\r\nunsigned int best_div = 0;\r\nunsigned int best_rate = 0;\r\nunsigned int best_deviation = INT_MAX;\r\npr_debug("Input clock rate %ldHz\n", clkrate);\r\nif (fstab == NULL)\r\nfstab = iis_fs_tab;\r\nfor (fs = 0; fs < ARRAY_SIZE(iis_fs_tab); fs++) {\r\nfsdiv = iis_fs_tab[fs];\r\nfsclk = clkrate / fsdiv;\r\ndiv = fsclk / rate;\r\nif ((fsclk % rate) > (rate / 2))\r\ndiv++;\r\nif (div <= 1)\r\ncontinue;\r\nactual = clkrate / (fsdiv * div);\r\ndeviation = actual - rate;\r\nprintk(KERN_DEBUG "%ufs: div %u => result %u, deviation %d\n",\r\nfsdiv, div, actual, deviation);\r\ndeviation = abs(deviation);\r\nif (deviation < best_deviation) {\r\nbest_fs = fsdiv;\r\nbest_div = div;\r\nbest_rate = actual;\r\nbest_deviation = deviation;\r\n}\r\nif (deviation == 0)\r\nbreak;\r\n}\r\nprintk(KERN_DEBUG "best: fs=%u, div=%u, rate=%u\n",\r\nbest_fs, best_div, best_rate);\r\ninfo->fs_div = best_fs;\r\ninfo->clk_div = best_div;\r\nreturn 0;\r\n}\r\nint s3c_i2sv2_probe(struct snd_soc_dai *dai,\r\nstruct s3c_i2sv2_info *i2s,\r\nunsigned long base)\r\n{\r\nstruct device *dev = dai->dev;\r\nunsigned int iismod;\r\ni2s->dev = dev;\r\nsnd_soc_dai_set_drvdata(dai, i2s);\r\ni2s->regs = ioremap(base, 0x100);\r\nif (i2s->regs == NULL) {\r\ndev_err(dev, "cannot ioremap registers\n");\r\nreturn -ENXIO;\r\n}\r\ni2s->iis_pclk = clk_get(dev, "iis");\r\nif (IS_ERR(i2s->iis_pclk)) {\r\ndev_err(dev, "failed to get iis_clock\n");\r\niounmap(i2s->regs);\r\nreturn -ENOENT;\r\n}\r\nclk_enable(i2s->iis_pclk);\r\niismod = readl(i2s->regs + S3C2412_IISMOD);\r\niismod |= S3C2412_IISMOD_MODE_TXRX;\r\nwritel(iismod, i2s->regs + S3C2412_IISMOD);\r\ns3c2412_snd_txctrl(i2s, 0);\r\ns3c2412_snd_rxctrl(i2s, 0);\r\nreturn 0;\r\n}\r\nstatic int s3c2412_i2s_suspend(struct snd_soc_dai *dai)\r\n{\r\nstruct s3c_i2sv2_info *i2s = to_info(dai);\r\nu32 iismod;\r\nif (dai->active) {\r\ni2s->suspend_iismod = readl(i2s->regs + S3C2412_IISMOD);\r\ni2s->suspend_iiscon = readl(i2s->regs + S3C2412_IISCON);\r\ni2s->suspend_iispsr = readl(i2s->regs + S3C2412_IISPSR);\r\niismod = readl(i2s->regs + S3C2412_IISMOD);\r\nif (iismod & S3C2412_IISCON_RXDMA_ACTIVE)\r\npr_warning("%s: RXDMA active?\n", __func__);\r\nif (iismod & S3C2412_IISCON_TXDMA_ACTIVE)\r\npr_warning("%s: TXDMA active?\n", __func__);\r\nif (iismod & S3C2412_IISCON_IIS_ACTIVE)\r\npr_warning("%s: IIS active\n", __func__);\r\n}\r\nreturn 0;\r\n}\r\nstatic int s3c2412_i2s_resume(struct snd_soc_dai *dai)\r\n{\r\nstruct s3c_i2sv2_info *i2s = to_info(dai);\r\npr_info("dai_active %d, IISMOD %08x, IISCON %08x\n",\r\ndai->active, i2s->suspend_iismod, i2s->suspend_iiscon);\r\nif (dai->active) {\r\nwritel(i2s->suspend_iiscon, i2s->regs + S3C2412_IISCON);\r\nwritel(i2s->suspend_iismod, i2s->regs + S3C2412_IISMOD);\r\nwritel(i2s->suspend_iispsr, i2s->regs + S3C2412_IISPSR);\r\nwritel(S3C2412_IISFIC_RXFLUSH | S3C2412_IISFIC_TXFLUSH,\r\ni2s->regs + S3C2412_IISFIC);\r\nndelay(250);\r\nwritel(0x0, i2s->regs + S3C2412_IISFIC);\r\n}\r\nreturn 0;\r\n}\r\nint s3c_i2sv2_register_component(struct device *dev, int id,\r\nstruct snd_soc_component_driver *cmp_drv,\r\nstruct snd_soc_dai_driver *dai_drv)\r\n{\r\nstruct snd_soc_dai_ops *ops = dai_drv->ops;\r\nops->trigger = s3c2412_i2s_trigger;\r\nif (!ops->hw_params)\r\nops->hw_params = s3c_i2sv2_hw_params;\r\nops->set_fmt = s3c2412_i2s_set_fmt;\r\nops->set_clkdiv = s3c2412_i2s_set_clkdiv;\r\nops->set_sysclk = s3c_i2sv2_set_sysclk;\r\nif (!ops->delay)\r\nops->delay = s3c2412_i2s_delay;\r\ndai_drv->suspend = s3c2412_i2s_suspend;\r\ndai_drv->resume = s3c2412_i2s_resume;\r\nreturn snd_soc_register_component(dev, cmp_drv, dai_drv, 1);\r\n}

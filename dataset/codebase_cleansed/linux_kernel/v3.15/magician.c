static void toppoly_lcd_power(int on, struct fb_var_screeninfo *si)\r\n{\r\npr_debug("Toppoly LCD power\n");\r\nif (on) {\r\npr_debug("on\n");\r\ngpio_set_value(EGPIO_MAGICIAN_TOPPOLY_POWER, 1);\r\ngpio_set_value(GPIO106_MAGICIAN_LCD_POWER_3, 1);\r\nudelay(2000);\r\ngpio_set_value(EGPIO_MAGICIAN_LCD_POWER, 1);\r\nudelay(2000);\r\nudelay(2000);\r\ngpio_set_value(GPIO104_MAGICIAN_LCD_POWER_1, 1);\r\nudelay(2000);\r\ngpio_set_value(GPIO105_MAGICIAN_LCD_POWER_2, 1);\r\n} else {\r\npr_debug("off\n");\r\nmsleep(15);\r\ngpio_set_value(GPIO105_MAGICIAN_LCD_POWER_2, 0);\r\nudelay(500);\r\ngpio_set_value(GPIO104_MAGICIAN_LCD_POWER_1, 0);\r\nudelay(1000);\r\ngpio_set_value(GPIO106_MAGICIAN_LCD_POWER_3, 0);\r\ngpio_set_value(EGPIO_MAGICIAN_LCD_POWER, 0);\r\n}\r\n}\r\nstatic void samsung_lcd_power(int on, struct fb_var_screeninfo *si)\r\n{\r\npr_debug("Samsung LCD power\n");\r\nif (on) {\r\npr_debug("on\n");\r\nif (system_rev < 3)\r\ngpio_set_value(GPIO75_MAGICIAN_SAMSUNG_POWER, 1);\r\nelse\r\ngpio_set_value(EGPIO_MAGICIAN_LCD_POWER, 1);\r\nmdelay(10);\r\ngpio_set_value(GPIO106_MAGICIAN_LCD_POWER_3, 1);\r\nmdelay(10);\r\ngpio_set_value(GPIO104_MAGICIAN_LCD_POWER_1, 1);\r\nmdelay(30);\r\ngpio_set_value(GPIO105_MAGICIAN_LCD_POWER_2, 1);\r\nmdelay(10);\r\n} else {\r\npr_debug("off\n");\r\nmdelay(10);\r\ngpio_set_value(GPIO105_MAGICIAN_LCD_POWER_2, 0);\r\nmdelay(30);\r\ngpio_set_value(GPIO104_MAGICIAN_LCD_POWER_1, 0);\r\nmdelay(10);\r\ngpio_set_value(GPIO106_MAGICIAN_LCD_POWER_3, 0);\r\nmdelay(10);\r\nif (system_rev < 3)\r\ngpio_set_value(GPIO75_MAGICIAN_SAMSUNG_POWER, 0);\r\nelse\r\ngpio_set_value(EGPIO_MAGICIAN_LCD_POWER, 0);\r\n}\r\n}\r\nstatic int magician_backlight_init(struct device *dev)\r\n{\r\nreturn gpio_request_array(ARRAY_AND_SIZE(magician_bl_gpios));\r\n}\r\nstatic int magician_backlight_notify(struct device *dev, int brightness)\r\n{\r\ngpio_set_value(EGPIO_MAGICIAN_BL_POWER, brightness);\r\nif (brightness >= 200) {\r\ngpio_set_value(EGPIO_MAGICIAN_BL_POWER2, 1);\r\nreturn brightness - 72;\r\n} else {\r\ngpio_set_value(EGPIO_MAGICIAN_BL_POWER2, 0);\r\nreturn brightness;\r\n}\r\n}\r\nstatic void magician_backlight_exit(struct device *dev)\r\n{\r\ngpio_free_array(ARRAY_AND_SIZE(magician_bl_gpios));\r\n}\r\nstatic int power_supply_init(struct device *dev)\r\n{\r\nreturn gpio_request(EGPIO_MAGICIAN_CABLE_STATE_AC, "CABLE_STATE_AC");\r\n}\r\nstatic int magician_is_ac_online(void)\r\n{\r\nreturn gpio_get_value(EGPIO_MAGICIAN_CABLE_STATE_AC);\r\n}\r\nstatic void power_supply_exit(struct device *dev)\r\n{\r\ngpio_free(EGPIO_MAGICIAN_CABLE_STATE_AC);\r\n}\r\nstatic int magician_mci_init(struct device *dev,\r\nirq_handler_t detect_irq, void *data)\r\n{\r\nreturn request_irq(IRQ_MAGICIAN_SD, detect_irq, 0,\r\n"mmc card detect", data);\r\n}\r\nstatic void magician_mci_exit(struct device *dev, void *data)\r\n{\r\nfree_irq(IRQ_MAGICIAN_SD, data);\r\n}\r\nstatic void magician_set_vpp(struct platform_device *pdev, int vpp)\r\n{\r\ngpio_set_value(EGPIO_MAGICIAN_FLASH_VPP, vpp);\r\n}\r\nstatic void __init magician_init(void)\r\n{\r\nvoid __iomem *cpld;\r\nint lcd_select;\r\nint err;\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(magician_pin_config));\r\nerr = gpio_request_array(ARRAY_AND_SIZE(magician_global_gpios));\r\nif (err)\r\npr_err("magician: Failed to request GPIOs: %d\n", err);\r\npxa_set_ffuart_info(NULL);\r\npxa_set_btuart_info(NULL);\r\npxa_set_stuart_info(NULL);\r\nplatform_add_devices(ARRAY_AND_SIZE(devices));\r\npxa_set_ficp_info(&magician_ficp_info);\r\npxa27x_set_i2c_power_info(NULL);\r\npxa_set_i2c_info(&i2c_info);\r\npxa_set_mci_info(&magician_mci_info);\r\npxa_set_ohci_info(&magician_ohci_info);\r\ncpld = ioremap_nocache(PXA_CS3_PHYS, 0x1000);\r\nif (cpld) {\r\nu8 board_id = __raw_readb(cpld+0x14);\r\niounmap(cpld);\r\nsystem_rev = board_id & 0x7;\r\nlcd_select = board_id & 0x8;\r\npr_info("LCD type: %s\n", lcd_select ? "Samsung" : "Toppoly");\r\nif (lcd_select && (system_rev < 3))\r\ngpio_request_one(GPIO75_MAGICIAN_SAMSUNG_POWER,\r\nGPIOF_OUT_INIT_LOW, "SAMSUNG_POWER");\r\npxa_set_fb_info(NULL, lcd_select ? &samsung_info : &toppoly_info);\r\n} else\r\npr_err("LCD detection: CPLD mapping failed\n");\r\n}

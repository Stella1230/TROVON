static int hsr_newlink(struct net *src_net, struct net_device *dev,\r\nstruct nlattr *tb[], struct nlattr *data[])\r\n{\r\nstruct net_device *link[2];\r\nunsigned char multicast_spec;\r\nif (!data[IFLA_HSR_SLAVE1]) {\r\nnetdev_info(dev, "IFLA_HSR_SLAVE1 missing!\n");\r\nreturn -EINVAL;\r\n}\r\nlink[0] = __dev_get_by_index(src_net, nla_get_u32(data[IFLA_HSR_SLAVE1]));\r\nif (!data[IFLA_HSR_SLAVE2]) {\r\nnetdev_info(dev, "IFLA_HSR_SLAVE2 missing!\n");\r\nreturn -EINVAL;\r\n}\r\nlink[1] = __dev_get_by_index(src_net, nla_get_u32(data[IFLA_HSR_SLAVE2]));\r\nif (!link[0] || !link[1])\r\nreturn -ENODEV;\r\nif (link[0] == link[1])\r\nreturn -EINVAL;\r\nif (!data[IFLA_HSR_MULTICAST_SPEC])\r\nmulticast_spec = 0;\r\nelse\r\nmulticast_spec = nla_get_u8(data[IFLA_HSR_MULTICAST_SPEC]);\r\nreturn hsr_dev_finalize(dev, link, multicast_spec);\r\n}\r\nstatic int hsr_fill_info(struct sk_buff *skb, const struct net_device *dev)\r\n{\r\nstruct hsr_priv *hsr_priv;\r\nhsr_priv = netdev_priv(dev);\r\nif (hsr_priv->slave[0])\r\nif (nla_put_u32(skb, IFLA_HSR_SLAVE1, hsr_priv->slave[0]->ifindex))\r\ngoto nla_put_failure;\r\nif (hsr_priv->slave[1])\r\nif (nla_put_u32(skb, IFLA_HSR_SLAVE2, hsr_priv->slave[1]->ifindex))\r\ngoto nla_put_failure;\r\nif (nla_put(skb, IFLA_HSR_SUPERVISION_ADDR, ETH_ALEN,\r\nhsr_priv->sup_multicast_addr) ||\r\nnla_put_u16(skb, IFLA_HSR_SEQ_NR, hsr_priv->sequence_nr))\r\ngoto nla_put_failure;\r\nreturn 0;\r\nnla_put_failure:\r\nreturn -EMSGSIZE;\r\n}\r\nvoid hsr_nl_ringerror(struct hsr_priv *hsr_priv, unsigned char addr[ETH_ALEN],\r\nenum hsr_dev_idx dev_idx)\r\n{\r\nstruct sk_buff *skb;\r\nvoid *msg_head;\r\nint res;\r\nint ifindex;\r\nskb = genlmsg_new(NLMSG_GOODSIZE, GFP_ATOMIC);\r\nif (!skb)\r\ngoto fail;\r\nmsg_head = genlmsg_put(skb, 0, 0, &hsr_genl_family, 0, HSR_C_RING_ERROR);\r\nif (!msg_head)\r\ngoto nla_put_failure;\r\nres = nla_put(skb, HSR_A_NODE_ADDR, ETH_ALEN, addr);\r\nif (res < 0)\r\ngoto nla_put_failure;\r\nif (hsr_priv->slave[dev_idx])\r\nifindex = hsr_priv->slave[dev_idx]->ifindex;\r\nelse\r\nifindex = -1;\r\nres = nla_put_u32(skb, HSR_A_IFINDEX, ifindex);\r\nif (res < 0)\r\ngoto nla_put_failure;\r\ngenlmsg_end(skb, msg_head);\r\ngenlmsg_multicast(&hsr_genl_family, skb, 0, 0, GFP_ATOMIC);\r\nreturn;\r\nnla_put_failure:\r\nkfree_skb(skb);\r\nfail:\r\nnetdev_warn(hsr_priv->dev, "Could not send HSR ring error message\n");\r\n}\r\nvoid hsr_nl_nodedown(struct hsr_priv *hsr_priv, unsigned char addr[ETH_ALEN])\r\n{\r\nstruct sk_buff *skb;\r\nvoid *msg_head;\r\nint res;\r\nskb = genlmsg_new(NLMSG_GOODSIZE, GFP_ATOMIC);\r\nif (!skb)\r\ngoto fail;\r\nmsg_head = genlmsg_put(skb, 0, 0, &hsr_genl_family, 0, HSR_C_NODE_DOWN);\r\nif (!msg_head)\r\ngoto nla_put_failure;\r\nres = nla_put(skb, HSR_A_NODE_ADDR, ETH_ALEN, addr);\r\nif (res < 0)\r\ngoto nla_put_failure;\r\ngenlmsg_end(skb, msg_head);\r\ngenlmsg_multicast(&hsr_genl_family, skb, 0, 0, GFP_ATOMIC);\r\nreturn;\r\nnla_put_failure:\r\nkfree_skb(skb);\r\nfail:\r\nnetdev_warn(hsr_priv->dev, "Could not send HSR node down\n");\r\n}\r\nstatic int hsr_get_node_status(struct sk_buff *skb_in, struct genl_info *info)\r\n{\r\nstruct nlattr *na;\r\nstruct net_device *hsr_dev;\r\nstruct sk_buff *skb_out;\r\nvoid *msg_head;\r\nstruct hsr_priv *hsr_priv;\r\nunsigned char hsr_node_addr_b[ETH_ALEN];\r\nint hsr_node_if1_age;\r\nu16 hsr_node_if1_seq;\r\nint hsr_node_if2_age;\r\nu16 hsr_node_if2_seq;\r\nint addr_b_ifindex;\r\nint res;\r\nif (!info)\r\ngoto invalid;\r\nna = info->attrs[HSR_A_IFINDEX];\r\nif (!na)\r\ngoto invalid;\r\nna = info->attrs[HSR_A_NODE_ADDR];\r\nif (!na)\r\ngoto invalid;\r\nhsr_dev = __dev_get_by_index(genl_info_net(info),\r\nnla_get_u32(info->attrs[HSR_A_IFINDEX]));\r\nif (!hsr_dev)\r\ngoto invalid;\r\nif (!is_hsr_master(hsr_dev))\r\ngoto invalid;\r\nskb_out = genlmsg_new(NLMSG_GOODSIZE, GFP_KERNEL);\r\nif (!skb_out) {\r\nres = -ENOMEM;\r\ngoto fail;\r\n}\r\nmsg_head = genlmsg_put(skb_out, NETLINK_CB(skb_in).portid,\r\ninfo->snd_seq, &hsr_genl_family, 0,\r\nHSR_C_SET_NODE_STATUS);\r\nif (!msg_head) {\r\nres = -ENOMEM;\r\ngoto nla_put_failure;\r\n}\r\nres = nla_put_u32(skb_out, HSR_A_IFINDEX, hsr_dev->ifindex);\r\nif (res < 0)\r\ngoto nla_put_failure;\r\nhsr_priv = netdev_priv(hsr_dev);\r\nres = hsr_get_node_data(hsr_priv,\r\n(unsigned char *) nla_data(info->attrs[HSR_A_NODE_ADDR]),\r\nhsr_node_addr_b,\r\n&addr_b_ifindex,\r\n&hsr_node_if1_age,\r\n&hsr_node_if1_seq,\r\n&hsr_node_if2_age,\r\n&hsr_node_if2_seq);\r\nif (res < 0)\r\ngoto nla_put_failure;\r\nres = nla_put(skb_out, HSR_A_NODE_ADDR, ETH_ALEN,\r\nnla_data(info->attrs[HSR_A_NODE_ADDR]));\r\nif (res < 0)\r\ngoto nla_put_failure;\r\nif (addr_b_ifindex > -1) {\r\nres = nla_put(skb_out, HSR_A_NODE_ADDR_B, ETH_ALEN,\r\nhsr_node_addr_b);\r\nif (res < 0)\r\ngoto nla_put_failure;\r\nres = nla_put_u32(skb_out, HSR_A_ADDR_B_IFINDEX, addr_b_ifindex);\r\nif (res < 0)\r\ngoto nla_put_failure;\r\n}\r\nres = nla_put_u32(skb_out, HSR_A_IF1_AGE, hsr_node_if1_age);\r\nif (res < 0)\r\ngoto nla_put_failure;\r\nres = nla_put_u16(skb_out, HSR_A_IF1_SEQ, hsr_node_if1_seq);\r\nif (res < 0)\r\ngoto nla_put_failure;\r\nif (hsr_priv->slave[0])\r\nres = nla_put_u32(skb_out, HSR_A_IF1_IFINDEX,\r\nhsr_priv->slave[0]->ifindex);\r\nif (res < 0)\r\ngoto nla_put_failure;\r\nres = nla_put_u32(skb_out, HSR_A_IF2_AGE, hsr_node_if2_age);\r\nif (res < 0)\r\ngoto nla_put_failure;\r\nres = nla_put_u16(skb_out, HSR_A_IF2_SEQ, hsr_node_if2_seq);\r\nif (res < 0)\r\ngoto nla_put_failure;\r\nif (hsr_priv->slave[1])\r\nres = nla_put_u32(skb_out, HSR_A_IF2_IFINDEX,\r\nhsr_priv->slave[1]->ifindex);\r\ngenlmsg_end(skb_out, msg_head);\r\ngenlmsg_unicast(genl_info_net(info), skb_out, info->snd_portid);\r\nreturn 0;\r\ninvalid:\r\nnetlink_ack(skb_in, nlmsg_hdr(skb_in), -EINVAL);\r\nreturn 0;\r\nnla_put_failure:\r\nkfree_skb(skb_out);\r\nfail:\r\nreturn res;\r\n}\r\nstatic int hsr_get_node_list(struct sk_buff *skb_in, struct genl_info *info)\r\n{\r\nstruct nlattr *na;\r\nstruct net_device *hsr_dev;\r\nstruct sk_buff *skb_out;\r\nvoid *msg_head;\r\nstruct hsr_priv *hsr_priv;\r\nvoid *pos;\r\nunsigned char addr[ETH_ALEN];\r\nint res;\r\nif (!info)\r\ngoto invalid;\r\nna = info->attrs[HSR_A_IFINDEX];\r\nif (!na)\r\ngoto invalid;\r\nhsr_dev = __dev_get_by_index(genl_info_net(info),\r\nnla_get_u32(info->attrs[HSR_A_IFINDEX]));\r\nif (!hsr_dev)\r\ngoto invalid;\r\nif (!is_hsr_master(hsr_dev))\r\ngoto invalid;\r\nskb_out = genlmsg_new(NLMSG_GOODSIZE, GFP_KERNEL);\r\nif (!skb_out) {\r\nres = -ENOMEM;\r\ngoto fail;\r\n}\r\nmsg_head = genlmsg_put(skb_out, NETLINK_CB(skb_in).portid,\r\ninfo->snd_seq, &hsr_genl_family, 0,\r\nHSR_C_SET_NODE_LIST);\r\nif (!msg_head) {\r\nres = -ENOMEM;\r\ngoto nla_put_failure;\r\n}\r\nres = nla_put_u32(skb_out, HSR_A_IFINDEX, hsr_dev->ifindex);\r\nif (res < 0)\r\ngoto nla_put_failure;\r\nhsr_priv = netdev_priv(hsr_dev);\r\nrcu_read_lock();\r\npos = hsr_get_next_node(hsr_priv, NULL, addr);\r\nwhile (pos) {\r\nres = nla_put(skb_out, HSR_A_NODE_ADDR, ETH_ALEN, addr);\r\nif (res < 0) {\r\nrcu_read_unlock();\r\ngoto nla_put_failure;\r\n}\r\npos = hsr_get_next_node(hsr_priv, pos, addr);\r\n}\r\nrcu_read_unlock();\r\ngenlmsg_end(skb_out, msg_head);\r\ngenlmsg_unicast(genl_info_net(info), skb_out, info->snd_portid);\r\nreturn 0;\r\ninvalid:\r\nnetlink_ack(skb_in, nlmsg_hdr(skb_in), -EINVAL);\r\nreturn 0;\r\nnla_put_failure:\r\nkfree_skb(skb_out);\r\nfail:\r\nreturn res;\r\n}\r\nint __init hsr_netlink_init(void)\r\n{\r\nint rc;\r\nrc = rtnl_link_register(&hsr_link_ops);\r\nif (rc)\r\ngoto fail_rtnl_link_register;\r\nrc = genl_register_family_with_ops_groups(&hsr_genl_family, hsr_ops,\r\nhsr_mcgrps);\r\nif (rc)\r\ngoto fail_genl_register_family;\r\nreturn 0;\r\nfail_genl_register_family:\r\nrtnl_link_unregister(&hsr_link_ops);\r\nfail_rtnl_link_register:\r\nreturn rc;\r\n}\r\nvoid __exit hsr_netlink_exit(void)\r\n{\r\ngenl_unregister_family(&hsr_genl_family);\r\nrtnl_link_unregister(&hsr_link_ops);\r\n}

static bool toneport_has_led(short product)\r\n{\r\nreturn\r\n(product == LINE6_DEVID_GUITARPORT) ||\r\n(product == LINE6_DEVID_TONEPORT_GX);\r\n}\r\nstatic void toneport_update_led(struct device *dev)\r\n{\r\nstruct usb_interface *interface = to_usb_interface(dev);\r\nstruct usb_line6_toneport *tp = usb_get_intfdata(interface);\r\nstruct usb_line6 *line6;\r\nif (!tp)\r\nreturn;\r\nline6 = &tp->line6;\r\nif (line6)\r\ntoneport_send_cmd(line6->usbdev, (led_red << 8) | 0x0002,\r\nled_green);\r\n}\r\nstatic ssize_t toneport_set_led_red(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nint retval;\r\nretval = kstrtoint(buf, 10, &led_red);\r\nif (retval)\r\nreturn retval;\r\ntoneport_update_led(dev);\r\nreturn count;\r\n}\r\nstatic ssize_t toneport_set_led_green(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nint retval;\r\nretval = kstrtoint(buf, 10, &led_green);\r\nif (retval)\r\nreturn retval;\r\ntoneport_update_led(dev);\r\nreturn count;\r\n}\r\nstatic int toneport_send_cmd(struct usb_device *usbdev, int cmd1, int cmd2)\r\n{\r\nint ret;\r\nret = usb_control_msg(usbdev, usb_sndctrlpipe(usbdev, 0), 0x67,\r\nUSB_TYPE_VENDOR | USB_RECIP_DEVICE | USB_DIR_OUT,\r\ncmd1, cmd2, NULL, 0, LINE6_TIMEOUT * HZ);\r\nif (ret < 0) {\r\ndev_err(&usbdev->dev, "send failed (error %d)\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_toneport_monitor_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 1;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 256;\r\nreturn 0;\r\n}\r\nstatic int snd_toneport_monitor_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_line6_pcm *line6pcm = snd_kcontrol_chip(kcontrol);\r\nucontrol->value.integer.value[0] = line6pcm->volume_monitor;\r\nreturn 0;\r\n}\r\nstatic int snd_toneport_monitor_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_line6_pcm *line6pcm = snd_kcontrol_chip(kcontrol);\r\nif (ucontrol->value.integer.value[0] == line6pcm->volume_monitor)\r\nreturn 0;\r\nline6pcm->volume_monitor = ucontrol->value.integer.value[0];\r\nif (line6pcm->volume_monitor > 0)\r\nline6_pcm_acquire(line6pcm, LINE6_BITS_PCM_MONITOR);\r\nelse\r\nline6_pcm_release(line6pcm, LINE6_BITS_PCM_MONITOR);\r\nreturn 1;\r\n}\r\nstatic int snd_toneport_source_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nconst int size = ARRAY_SIZE(toneport_source_info);\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = size;\r\nif (uinfo->value.enumerated.item >= size)\r\nuinfo->value.enumerated.item = size - 1;\r\nstrcpy(uinfo->value.enumerated.name,\r\ntoneport_source_info[uinfo->value.enumerated.item].name);\r\nreturn 0;\r\n}\r\nstatic int snd_toneport_source_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_line6_pcm *line6pcm = snd_kcontrol_chip(kcontrol);\r\nstruct usb_line6_toneport *toneport =\r\n(struct usb_line6_toneport *)line6pcm->line6;\r\nucontrol->value.enumerated.item[0] = toneport->source;\r\nreturn 0;\r\n}\r\nstatic int snd_toneport_source_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_line6_pcm *line6pcm = snd_kcontrol_chip(kcontrol);\r\nstruct usb_line6_toneport *toneport =\r\n(struct usb_line6_toneport *)line6pcm->line6;\r\nunsigned int source;\r\nsource = ucontrol->value.enumerated.item[0];\r\nif (source >= ARRAY_SIZE(toneport_source_info))\r\nreturn -EINVAL;\r\nif (source == toneport->source)\r\nreturn 0;\r\ntoneport->source = source;\r\ntoneport_send_cmd(toneport->line6.usbdev,\r\ntoneport_source_info[source].code, 0x0000);\r\nreturn 1;\r\n}\r\nstatic void toneport_start_pcm(unsigned long arg)\r\n{\r\nstruct usb_line6_toneport *toneport = (struct usb_line6_toneport *)arg;\r\nstruct usb_line6 *line6 = &toneport->line6;\r\nline6_pcm_acquire(line6->line6pcm, LINE6_BITS_PCM_MONITOR);\r\n}\r\nstatic void toneport_destruct(struct usb_interface *interface)\r\n{\r\nstruct usb_line6_toneport *toneport = usb_get_intfdata(interface);\r\nif (toneport == NULL)\r\nreturn;\r\nline6_cleanup_audio(&toneport->line6);\r\n}\r\nstatic void toneport_setup(struct usb_line6_toneport *toneport)\r\n{\r\nint ticks;\r\nstruct usb_line6 *line6 = &toneport->line6;\r\nstruct usb_device *usbdev = line6->usbdev;\r\nu16 idProduct = le16_to_cpu(usbdev->descriptor.idProduct);\r\nticks = (int)get_seconds();\r\nline6_write_data(line6, 0x80c6, &ticks, 4);\r\ntoneport_send_cmd(usbdev, 0x0301, 0x0000);\r\nswitch (le16_to_cpu(usbdev->descriptor.idProduct)) {\r\ncase LINE6_DEVID_TONEPORT_UX1:\r\ncase LINE6_DEVID_TONEPORT_UX2:\r\ncase LINE6_DEVID_PODSTUDIO_UX1:\r\ncase LINE6_DEVID_PODSTUDIO_UX2:\r\ntoneport_send_cmd(usbdev,\r\ntoneport_source_info[toneport->source].code,\r\n0x0000);\r\n}\r\nif (toneport_has_led(idProduct))\r\ntoneport_update_led(&usbdev->dev);\r\n}\r\nstatic int toneport_try_init(struct usb_interface *interface,\r\nstruct usb_line6_toneport *toneport)\r\n{\r\nint err;\r\nstruct usb_line6 *line6 = &toneport->line6;\r\nstruct usb_device *usbdev = line6->usbdev;\r\nu16 idProduct = le16_to_cpu(usbdev->descriptor.idProduct);\r\nif ((interface == NULL) || (toneport == NULL))\r\nreturn -ENODEV;\r\nerr = line6_init_audio(line6);\r\nif (err < 0)\r\nreturn err;\r\nerr = line6_init_pcm(line6, &toneport_pcm_properties);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_ctl_add(line6->card,\r\nsnd_ctl_new1(&toneport_control_monitor,\r\nline6->line6pcm));\r\nif (err < 0)\r\nreturn err;\r\nswitch (le16_to_cpu(usbdev->descriptor.idProduct)) {\r\ncase LINE6_DEVID_TONEPORT_UX1:\r\ncase LINE6_DEVID_TONEPORT_UX2:\r\ncase LINE6_DEVID_PODSTUDIO_UX1:\r\ncase LINE6_DEVID_PODSTUDIO_UX2:\r\nerr =\r\nsnd_ctl_add(line6->card,\r\nsnd_ctl_new1(&toneport_control_source,\r\nline6->line6pcm));\r\nif (err < 0)\r\nreturn err;\r\n}\r\nerr = line6_register_audio(line6);\r\nif (err < 0)\r\nreturn err;\r\nline6_read_serial_number(line6, &toneport->serial_number);\r\nline6_read_data(line6, 0x80c2, &toneport->firmware_version, 1);\r\nif (toneport_has_led(idProduct)) {\r\nCHECK_RETURN(device_create_file\r\n(&interface->dev, &dev_attr_led_red));\r\nCHECK_RETURN(device_create_file\r\n(&interface->dev, &dev_attr_led_green));\r\n}\r\ntoneport_setup(toneport);\r\ninit_timer(&toneport->timer);\r\ntoneport->timer.expires = jiffies + TONEPORT_PCM_DELAY * HZ;\r\ntoneport->timer.function = toneport_start_pcm;\r\ntoneport->timer.data = (unsigned long)toneport;\r\nadd_timer(&toneport->timer);\r\nreturn 0;\r\n}\r\nint line6_toneport_init(struct usb_interface *interface,\r\nstruct usb_line6_toneport *toneport)\r\n{\r\nint err = toneport_try_init(interface, toneport);\r\nif (err < 0)\r\ntoneport_destruct(interface);\r\nreturn err;\r\n}\r\nvoid line6_toneport_reset_resume(struct usb_line6_toneport *toneport)\r\n{\r\ntoneport_setup(toneport);\r\n}\r\nvoid line6_toneport_disconnect(struct usb_interface *interface)\r\n{\r\nstruct usb_line6_toneport *toneport;\r\nu16 idProduct;\r\nif (interface == NULL)\r\nreturn;\r\ntoneport = usb_get_intfdata(interface);\r\ndel_timer_sync(&toneport->timer);\r\nidProduct = le16_to_cpu(toneport->line6.usbdev->descriptor.idProduct);\r\nif (toneport_has_led(idProduct)) {\r\ndevice_remove_file(&interface->dev, &dev_attr_led_red);\r\ndevice_remove_file(&interface->dev, &dev_attr_led_green);\r\n}\r\nif (toneport != NULL) {\r\nstruct snd_line6_pcm *line6pcm = toneport->line6.line6pcm;\r\nif (line6pcm != NULL) {\r\nline6_pcm_release(line6pcm, LINE6_BITS_PCM_MONITOR);\r\nline6_pcm_disconnect(line6pcm);\r\n}\r\n}\r\ntoneport_destruct(interface);\r\n}

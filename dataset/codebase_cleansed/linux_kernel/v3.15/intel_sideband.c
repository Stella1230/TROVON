static int vlv_sideband_rw(struct drm_i915_private *dev_priv, u32 devfn,\r\nu32 port, u32 opcode, u32 addr, u32 *val)\r\n{\r\nu32 cmd, be = 0xf, bar = 0;\r\nbool is_read = (opcode == PUNIT_OPCODE_REG_READ ||\r\nopcode == DPIO_OPCODE_REG_READ);\r\ncmd = (devfn << IOSF_DEVFN_SHIFT) | (opcode << IOSF_OPCODE_SHIFT) |\r\n(port << IOSF_PORT_SHIFT) | (be << IOSF_BYTE_ENABLES_SHIFT) |\r\n(bar << IOSF_BAR_SHIFT);\r\nWARN_ON(!mutex_is_locked(&dev_priv->dpio_lock));\r\nif (wait_for((I915_READ(VLV_IOSF_DOORBELL_REQ) & IOSF_SB_BUSY) == 0, 5)) {\r\nDRM_DEBUG_DRIVER("IOSF sideband idle wait (%s) timed out\n",\r\nis_read ? "read" : "write");\r\nreturn -EAGAIN;\r\n}\r\nI915_WRITE(VLV_IOSF_ADDR, addr);\r\nif (!is_read)\r\nI915_WRITE(VLV_IOSF_DATA, *val);\r\nI915_WRITE(VLV_IOSF_DOORBELL_REQ, cmd);\r\nif (wait_for((I915_READ(VLV_IOSF_DOORBELL_REQ) & IOSF_SB_BUSY) == 0, 5)) {\r\nDRM_DEBUG_DRIVER("IOSF sideband finish wait (%s) timed out\n",\r\nis_read ? "read" : "write");\r\nreturn -ETIMEDOUT;\r\n}\r\nif (is_read)\r\n*val = I915_READ(VLV_IOSF_DATA);\r\nI915_WRITE(VLV_IOSF_DATA, 0);\r\nreturn 0;\r\n}\r\nu32 vlv_punit_read(struct drm_i915_private *dev_priv, u8 addr)\r\n{\r\nu32 val = 0;\r\nWARN_ON(!mutex_is_locked(&dev_priv->rps.hw_lock));\r\nmutex_lock(&dev_priv->dpio_lock);\r\nvlv_sideband_rw(dev_priv, PCI_DEVFN(2, 0), IOSF_PORT_PUNIT,\r\nPUNIT_OPCODE_REG_READ, addr, &val);\r\nmutex_unlock(&dev_priv->dpio_lock);\r\nreturn val;\r\n}\r\nvoid vlv_punit_write(struct drm_i915_private *dev_priv, u8 addr, u32 val)\r\n{\r\nWARN_ON(!mutex_is_locked(&dev_priv->rps.hw_lock));\r\nmutex_lock(&dev_priv->dpio_lock);\r\nvlv_sideband_rw(dev_priv, PCI_DEVFN(2, 0), IOSF_PORT_PUNIT,\r\nPUNIT_OPCODE_REG_WRITE, addr, &val);\r\nmutex_unlock(&dev_priv->dpio_lock);\r\n}\r\nu32 vlv_bunit_read(struct drm_i915_private *dev_priv, u32 reg)\r\n{\r\nu32 val = 0;\r\nvlv_sideband_rw(dev_priv, PCI_DEVFN(2, 0), IOSF_PORT_BUNIT,\r\nPUNIT_OPCODE_REG_READ, reg, &val);\r\nreturn val;\r\n}\r\nvoid vlv_bunit_write(struct drm_i915_private *dev_priv, u32 reg, u32 val)\r\n{\r\nvlv_sideband_rw(dev_priv, PCI_DEVFN(2, 0), IOSF_PORT_BUNIT,\r\nPUNIT_OPCODE_REG_WRITE, reg, &val);\r\n}\r\nu32 vlv_nc_read(struct drm_i915_private *dev_priv, u8 addr)\r\n{\r\nu32 val = 0;\r\nWARN_ON(!mutex_is_locked(&dev_priv->rps.hw_lock));\r\nmutex_lock(&dev_priv->dpio_lock);\r\nvlv_sideband_rw(dev_priv, PCI_DEVFN(2, 0), IOSF_PORT_NC,\r\nPUNIT_OPCODE_REG_READ, addr, &val);\r\nmutex_unlock(&dev_priv->dpio_lock);\r\nreturn val;\r\n}\r\nu32 vlv_gpio_nc_read(struct drm_i915_private *dev_priv, u32 reg)\r\n{\r\nu32 val = 0;\r\nvlv_sideband_rw(dev_priv, PCI_DEVFN(2, 0), IOSF_PORT_GPIO_NC,\r\nPUNIT_OPCODE_REG_READ, reg, &val);\r\nreturn val;\r\n}\r\nvoid vlv_gpio_nc_write(struct drm_i915_private *dev_priv, u32 reg, u32 val)\r\n{\r\nvlv_sideband_rw(dev_priv, PCI_DEVFN(2, 0), IOSF_PORT_GPIO_NC,\r\nPUNIT_OPCODE_REG_WRITE, reg, &val);\r\n}\r\nu32 vlv_cck_read(struct drm_i915_private *dev_priv, u32 reg)\r\n{\r\nu32 val = 0;\r\nvlv_sideband_rw(dev_priv, PCI_DEVFN(2, 0), IOSF_PORT_CCK,\r\nPUNIT_OPCODE_REG_READ, reg, &val);\r\nreturn val;\r\n}\r\nvoid vlv_cck_write(struct drm_i915_private *dev_priv, u32 reg, u32 val)\r\n{\r\nvlv_sideband_rw(dev_priv, PCI_DEVFN(2, 0), IOSF_PORT_CCK,\r\nPUNIT_OPCODE_REG_WRITE, reg, &val);\r\n}\r\nu32 vlv_ccu_read(struct drm_i915_private *dev_priv, u32 reg)\r\n{\r\nu32 val = 0;\r\nvlv_sideband_rw(dev_priv, PCI_DEVFN(2, 0), IOSF_PORT_CCU,\r\nPUNIT_OPCODE_REG_READ, reg, &val);\r\nreturn val;\r\n}\r\nvoid vlv_ccu_write(struct drm_i915_private *dev_priv, u32 reg, u32 val)\r\n{\r\nvlv_sideband_rw(dev_priv, PCI_DEVFN(2, 0), IOSF_PORT_CCU,\r\nPUNIT_OPCODE_REG_WRITE, reg, &val);\r\n}\r\nu32 vlv_gps_core_read(struct drm_i915_private *dev_priv, u32 reg)\r\n{\r\nu32 val = 0;\r\nvlv_sideband_rw(dev_priv, PCI_DEVFN(2, 0), IOSF_PORT_GPS_CORE,\r\nPUNIT_OPCODE_REG_READ, reg, &val);\r\nreturn val;\r\n}\r\nvoid vlv_gps_core_write(struct drm_i915_private *dev_priv, u32 reg, u32 val)\r\n{\r\nvlv_sideband_rw(dev_priv, PCI_DEVFN(2, 0), IOSF_PORT_GPS_CORE,\r\nPUNIT_OPCODE_REG_WRITE, reg, &val);\r\n}\r\nu32 vlv_dpio_read(struct drm_i915_private *dev_priv, enum pipe pipe, int reg)\r\n{\r\nu32 val = 0;\r\nvlv_sideband_rw(dev_priv, DPIO_DEVFN, DPIO_PHY_IOSF_PORT(DPIO_PHY(pipe)),\r\nDPIO_OPCODE_REG_READ, reg, &val);\r\nreturn val;\r\n}\r\nvoid vlv_dpio_write(struct drm_i915_private *dev_priv, enum pipe pipe, int reg, u32 val)\r\n{\r\nvlv_sideband_rw(dev_priv, DPIO_DEVFN, DPIO_PHY_IOSF_PORT(DPIO_PHY(pipe)),\r\nDPIO_OPCODE_REG_WRITE, reg, &val);\r\n}\r\nu32 intel_sbi_read(struct drm_i915_private *dev_priv, u16 reg,\r\nenum intel_sbi_destination destination)\r\n{\r\nu32 value = 0;\r\nWARN_ON(!mutex_is_locked(&dev_priv->dpio_lock));\r\nif (wait_for((I915_READ(SBI_CTL_STAT) & SBI_BUSY) == 0,\r\n100)) {\r\nDRM_ERROR("timeout waiting for SBI to become ready\n");\r\nreturn 0;\r\n}\r\nI915_WRITE(SBI_ADDR, (reg << 16));\r\nif (destination == SBI_ICLK)\r\nvalue = SBI_CTL_DEST_ICLK | SBI_CTL_OP_CRRD;\r\nelse\r\nvalue = SBI_CTL_DEST_MPHY | SBI_CTL_OP_IORD;\r\nI915_WRITE(SBI_CTL_STAT, value | SBI_BUSY);\r\nif (wait_for((I915_READ(SBI_CTL_STAT) & (SBI_BUSY | SBI_RESPONSE_FAIL)) == 0,\r\n100)) {\r\nDRM_ERROR("timeout waiting for SBI to complete read transaction\n");\r\nreturn 0;\r\n}\r\nreturn I915_READ(SBI_DATA);\r\n}\r\nvoid intel_sbi_write(struct drm_i915_private *dev_priv, u16 reg, u32 value,\r\nenum intel_sbi_destination destination)\r\n{\r\nu32 tmp;\r\nWARN_ON(!mutex_is_locked(&dev_priv->dpio_lock));\r\nif (wait_for((I915_READ(SBI_CTL_STAT) & SBI_BUSY) == 0,\r\n100)) {\r\nDRM_ERROR("timeout waiting for SBI to become ready\n");\r\nreturn;\r\n}\r\nI915_WRITE(SBI_ADDR, (reg << 16));\r\nI915_WRITE(SBI_DATA, value);\r\nif (destination == SBI_ICLK)\r\ntmp = SBI_CTL_DEST_ICLK | SBI_CTL_OP_CRWR;\r\nelse\r\ntmp = SBI_CTL_DEST_MPHY | SBI_CTL_OP_IOWR;\r\nI915_WRITE(SBI_CTL_STAT, SBI_BUSY | tmp);\r\nif (wait_for((I915_READ(SBI_CTL_STAT) & (SBI_BUSY | SBI_RESPONSE_FAIL)) == 0,\r\n100)) {\r\nDRM_ERROR("timeout waiting for SBI to complete write transaction\n");\r\nreturn;\r\n}\r\n}\r\nu32 vlv_flisdsi_read(struct drm_i915_private *dev_priv, u32 reg)\r\n{\r\nu32 val = 0;\r\nvlv_sideband_rw(dev_priv, DPIO_DEVFN, IOSF_PORT_FLISDSI,\r\nDPIO_OPCODE_REG_READ, reg, &val);\r\nreturn val;\r\n}\r\nvoid vlv_flisdsi_write(struct drm_i915_private *dev_priv, u32 reg, u32 val)\r\n{\r\nvlv_sideband_rw(dev_priv, DPIO_DEVFN, IOSF_PORT_FLISDSI,\r\nDPIO_OPCODE_REG_WRITE, reg, &val);\r\n}

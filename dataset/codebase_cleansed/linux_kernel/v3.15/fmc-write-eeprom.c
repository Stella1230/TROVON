static int fwe_run_tlv(struct fmc_device *fmc, const struct firmware *fw,\r\nint write)\r\n{\r\nconst uint8_t *p = fw->data;\r\nint len = fw->size;\r\nuint16_t thislen, thisaddr;\r\nint err;\r\nwhile (len > 5) {\r\nthisaddr = get_unaligned_le16(p+1);\r\nthislen = get_unaligned_le16(p+3);\r\nif (p[0] != 'w' || thislen + 5 > len) {\r\ndev_err(&fmc->dev, "invalid tlv at offset %ti\n",\r\np - fw->data);\r\nreturn -EINVAL;\r\n}\r\nerr = 0;\r\nif (write) {\r\ndev_info(&fmc->dev, "write %i bytes at 0x%04x\n",\r\nthislen, thisaddr);\r\nerr = fmc->op->write_ee(fmc, thisaddr, p + 5, thislen);\r\n}\r\nif (err < 0) {\r\ndev_err(&fmc->dev, "write failure @0x%04x\n",\r\nthisaddr);\r\nreturn err;\r\n}\r\np += 5 + thislen;\r\nlen -= 5 + thislen;\r\n}\r\nif (write)\r\ndev_info(&fmc->dev, "write_eeprom: success\n");\r\nreturn 0;\r\n}\r\nstatic int fwe_run_bin(struct fmc_device *fmc, const struct firmware *fw)\r\n{\r\nint ret;\r\ndev_info(&fmc->dev, "programming %zi bytes\n", fw->size);\r\nret = fmc->op->write_ee(fmc, 0, (void *)fw->data, fw->size);\r\nif (ret < 0) {\r\ndev_info(&fmc->dev, "write_eeprom: error %i\n", ret);\r\nreturn ret;\r\n}\r\ndev_info(&fmc->dev, "write_eeprom: success\n");\r\nreturn 0;\r\n}\r\nstatic int fwe_run(struct fmc_device *fmc, const struct firmware *fw, char *s)\r\n{\r\nchar *last4 = s + strlen(s) - 4;\r\nint err;\r\nif (!strcmp(last4, ".bin"))\r\nreturn fwe_run_bin(fmc, fw);\r\nif (!strcmp(last4, ".tlv")) {\r\nerr = fwe_run_tlv(fmc, fw, 0);\r\nif (!err)\r\nerr = fwe_run_tlv(fmc, fw, 1);\r\nreturn err;\r\n}\r\ndev_err(&fmc->dev, "invalid file name \"%s\"\n", s);\r\nreturn -EINVAL;\r\n}\r\nstatic int fwe_probe(struct fmc_device *fmc)\r\n{\r\nint err, index = 0;\r\nconst struct firmware *fw;\r\nstruct device *dev = &fmc->dev;\r\nchar *s;\r\nif (!fwe_drv.busid_n) {\r\ndev_err(dev, "%s: no busid passed, refusing all cards\n",\r\nKBUILD_MODNAME);\r\nreturn -ENODEV;\r\n}\r\nif (fmc->op->validate)\r\nindex = fmc->op->validate(fmc, &fwe_drv);\r\nif (index < 0) {\r\npr_err("%s: refusing device \"%s\"\n", KBUILD_MODNAME,\r\ndev_name(dev));\r\nreturn -ENODEV;\r\n}\r\nif (index >= fwe_file_n) {\r\npr_err("%s: no filename for device index %i\n",\r\nKBUILD_MODNAME, index);\r\nreturn -ENODEV;\r\n}\r\ns = fwe_file[index];\r\nif (!s) {\r\npr_err("%s: no filename for \"%s\" not programming\n",\r\nKBUILD_MODNAME, dev_name(dev));\r\nreturn -ENOENT;\r\n}\r\nerr = request_firmware(&fw, s, dev);\r\nif (err < 0) {\r\ndev_err(&fmc->dev, "request firmware \"%s\": error %i\n",\r\ns, err);\r\nreturn err;\r\n}\r\nfwe_run(fmc, fw, s);\r\nrelease_firmware(fw);\r\nreturn 0;\r\n}\r\nstatic int fwe_remove(struct fmc_device *fmc)\r\n{\r\nreturn 0;\r\n}\r\nstatic int fwe_init(void)\r\n{\r\nint ret;\r\nret = fmc_driver_register(&fwe_drv);\r\nreturn ret;\r\n}\r\nstatic void fwe_exit(void)\r\n{\r\nfmc_driver_unregister(&fwe_drv);\r\n}

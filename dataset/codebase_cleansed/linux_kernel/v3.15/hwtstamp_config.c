static int\r\nlookup_value(const char **names, int size, const char *name)\r\n{\r\nint value;\r\nfor (value = 0; value < size; value++)\r\nif (names[value] && strcasecmp(names[value], name) == 0)\r\nreturn value;\r\nreturn -1;\r\n}\r\nstatic const char *\r\nlookup_name(const char **names, int size, int value)\r\n{\r\nreturn (value >= 0 && value < size) ? names[value] : NULL;\r\n}\r\nstatic void list_names(FILE *f, const char **names, int size)\r\n{\r\nint value;\r\nfor (value = 0; value < size; value++)\r\nif (names[value])\r\nfprintf(f, " %s\n", names[value]);\r\n}\r\nstatic void usage(void)\r\n{\r\nfputs("Usage: hwtstamp_config if_name [tx_type rx_filter]\n"\r\n"tx_type is any of (case-insensitive):\n",\r\nstderr);\r\nlist_names(stderr, tx_types, N_TX_TYPES);\r\nfputs("rx_filter is any of (case-insensitive):\n", stderr);\r\nlist_names(stderr, rx_filters, N_RX_FILTERS);\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nstruct ifreq ifr;\r\nstruct hwtstamp_config config;\r\nconst char *name;\r\nint sock;\r\nif ((argc != 2 && argc != 4) || (strlen(argv[1]) >= IFNAMSIZ)) {\r\nusage();\r\nreturn 2;\r\n}\r\nif (argc == 4) {\r\nconfig.flags = 0;\r\nconfig.tx_type = lookup_value(tx_types, N_TX_TYPES, argv[2]);\r\nconfig.rx_filter = lookup_value(rx_filters, N_RX_FILTERS, argv[3]);\r\nif (config.tx_type < 0 || config.rx_filter < 0) {\r\nusage();\r\nreturn 2;\r\n}\r\n}\r\nsock = socket(AF_INET, SOCK_DGRAM, 0);\r\nif (sock < 0) {\r\nperror("socket");\r\nreturn 1;\r\n}\r\nstrcpy(ifr.ifr_name, argv[1]);\r\nifr.ifr_data = (caddr_t)&config;\r\nif (ioctl(sock, (argc == 2) ? SIOCGHWTSTAMP : SIOCSHWTSTAMP, &ifr)) {\r\nperror("ioctl");\r\nreturn 1;\r\n}\r\nprintf("flags = %#x\n", config.flags);\r\nname = lookup_name(tx_types, N_TX_TYPES, config.tx_type);\r\nif (name)\r\nprintf("tx_type = %s\n", name);\r\nelse\r\nprintf("tx_type = %d\n", config.tx_type);\r\nname = lookup_name(rx_filters, N_RX_FILTERS, config.rx_filter);\r\nif (name)\r\nprintf("rx_filter = %s\n", name);\r\nelse\r\nprintf("rx_filter = %d\n", config.rx_filter);\r\nreturn 0;\r\n}

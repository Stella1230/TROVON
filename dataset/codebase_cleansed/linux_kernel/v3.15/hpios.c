void hpios_delay_micro_seconds(u32 num_micro_sec)\r\n{\r\nif ((usecs_to_jiffies(num_micro_sec) > 1) && !in_interrupt()) {\r\nschedule_timeout_uninterruptible(usecs_to_jiffies\r\n(num_micro_sec));\r\n} else if (num_micro_sec <= 2000)\r\nudelay(num_micro_sec);\r\nelse\r\nmdelay(num_micro_sec / 1000);\r\n}\r\nu16 hpios_locked_mem_alloc(struct consistent_dma_area *p_mem_area, u32 size,\r\nstruct pci_dev *pdev)\r\n{\r\np_mem_area->vaddr =\r\ndma_alloc_coherent(&pdev->dev, size, &p_mem_area->dma_handle,\r\nGFP_DMA32 | GFP_KERNEL);\r\nif (p_mem_area->vaddr) {\r\nHPI_DEBUG_LOG(DEBUG, "allocated %d bytes, dma 0x%x vma %p\n",\r\nsize, (unsigned int)p_mem_area->dma_handle,\r\np_mem_area->vaddr);\r\np_mem_area->pdev = &pdev->dev;\r\np_mem_area->size = size;\r\nreturn 0;\r\n} else {\r\nHPI_DEBUG_LOG(WARNING,\r\n"failed to allocate %d bytes locked memory\n", size);\r\np_mem_area->size = 0;\r\nreturn 1;\r\n}\r\n}\r\nu16 hpios_locked_mem_free(struct consistent_dma_area *p_mem_area)\r\n{\r\nif (p_mem_area->size) {\r\ndma_free_coherent(p_mem_area->pdev, p_mem_area->size,\r\np_mem_area->vaddr, p_mem_area->dma_handle);\r\nHPI_DEBUG_LOG(DEBUG, "freed %lu bytes, dma 0x%x vma %p\n",\r\n(unsigned long)p_mem_area->size,\r\n(unsigned int)p_mem_area->dma_handle,\r\np_mem_area->vaddr);\r\np_mem_area->size = 0;\r\nreturn 0;\r\n} else {\r\nreturn 1;\r\n}\r\n}

void *brcmf_nvram_strip(const struct firmware *nv, u32 *new_length)\r\n{\r\nu8 *nvram;\r\nu32 i;\r\nu32 len;\r\nu32 column;\r\nu8 val;\r\nbool comment;\r\nu32 token;\r\n__le32 token_le;\r\nnvram = kmalloc(nv->size + 1 + 3 + sizeof(token_le), GFP_KERNEL);\r\nif (!nvram)\r\nreturn NULL;\r\nlen = 0;\r\ncolumn = 0;\r\ncomment = false;\r\nfor (i = 0; i < nv->size; i++) {\r\nval = nv->data[i];\r\nif (val == 0)\r\nbreak;\r\nif (val == '\r')\r\ncontinue;\r\nif (comment && (val != '\n'))\r\ncontinue;\r\ncomment = false;\r\nif (val == '#') {\r\ncomment = true;\r\ncontinue;\r\n}\r\nif (val == '\n') {\r\nif (column == 0)\r\ncontinue;\r\nnvram[len] = 0;\r\nlen++;\r\ncolumn = 0;\r\ncontinue;\r\n}\r\nnvram[len] = val;\r\nlen++;\r\ncolumn++;\r\n}\r\ncolumn = len;\r\n*new_length = roundup(len + 1, 4);\r\nwhile (column != *new_length) {\r\nnvram[column] = 0;\r\ncolumn++;\r\n}\r\ntoken = *new_length / 4;\r\ntoken = (~token << 16) | (token & 0x0000FFFF);\r\ntoken_le = cpu_to_le32(token);\r\nmemcpy(&nvram[*new_length], &token_le, sizeof(token_le));\r\n*new_length += sizeof(token_le);\r\nreturn nvram;\r\n}\r\nvoid brcmf_nvram_free(void *nvram)\r\n{\r\nkfree(nvram);\r\n}

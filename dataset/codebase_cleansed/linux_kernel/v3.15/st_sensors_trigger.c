int st_sensors_allocate_trigger(struct iio_dev *indio_dev,\r\nconst struct iio_trigger_ops *trigger_ops)\r\n{\r\nint err;\r\nstruct st_sensor_data *sdata = iio_priv(indio_dev);\r\nsdata->trig = iio_trigger_alloc("%s-trigger", indio_dev->name);\r\nif (sdata->trig == NULL) {\r\nerr = -ENOMEM;\r\ndev_err(&indio_dev->dev, "failed to allocate iio trigger.\n");\r\ngoto iio_trigger_alloc_error;\r\n}\r\nerr = request_threaded_irq(sdata->get_irq_data_ready(indio_dev),\r\niio_trigger_generic_data_rdy_poll,\r\nNULL,\r\nIRQF_TRIGGER_RISING,\r\nsdata->trig->name,\r\nsdata->trig);\r\nif (err)\r\ngoto request_irq_error;\r\niio_trigger_set_drvdata(sdata->trig, indio_dev);\r\nsdata->trig->ops = trigger_ops;\r\nsdata->trig->dev.parent = sdata->dev;\r\nerr = iio_trigger_register(sdata->trig);\r\nif (err < 0) {\r\ndev_err(&indio_dev->dev, "failed to register iio trigger.\n");\r\ngoto iio_trigger_register_error;\r\n}\r\nindio_dev->trig = sdata->trig;\r\nreturn 0;\r\niio_trigger_register_error:\r\nfree_irq(sdata->get_irq_data_ready(indio_dev), sdata->trig);\r\nrequest_irq_error:\r\niio_trigger_free(sdata->trig);\r\niio_trigger_alloc_error:\r\nreturn err;\r\n}\r\nvoid st_sensors_deallocate_trigger(struct iio_dev *indio_dev)\r\n{\r\nstruct st_sensor_data *sdata = iio_priv(indio_dev);\r\niio_trigger_unregister(sdata->trig);\r\nfree_irq(sdata->get_irq_data_ready(indio_dev), sdata->trig);\r\niio_trigger_free(sdata->trig);\r\n}

static struct usb_function_instance *try_get_usb_function_instance(const char *name)\r\n{\r\nstruct usb_function_driver *fd;\r\nstruct usb_function_instance *fi;\r\nfi = ERR_PTR(-ENOENT);\r\nmutex_lock(&func_lock);\r\nlist_for_each_entry(fd, &func_list, list) {\r\nif (strcmp(name, fd->name))\r\ncontinue;\r\nif (!try_module_get(fd->mod)) {\r\nfi = ERR_PTR(-EBUSY);\r\nbreak;\r\n}\r\nfi = fd->alloc_inst();\r\nif (IS_ERR(fi))\r\nmodule_put(fd->mod);\r\nelse\r\nfi->fd = fd;\r\nbreak;\r\n}\r\nmutex_unlock(&func_lock);\r\nreturn fi;\r\n}\r\nstruct usb_function_instance *usb_get_function_instance(const char *name)\r\n{\r\nstruct usb_function_instance *fi;\r\nint ret;\r\nfi = try_get_usb_function_instance(name);\r\nif (!IS_ERR(fi))\r\nreturn fi;\r\nret = PTR_ERR(fi);\r\nif (ret != -ENOENT)\r\nreturn fi;\r\nret = request_module("usbfunc:%s", name);\r\nif (ret < 0)\r\nreturn ERR_PTR(ret);\r\nreturn try_get_usb_function_instance(name);\r\n}\r\nstruct usb_function *usb_get_function(struct usb_function_instance *fi)\r\n{\r\nstruct usb_function *f;\r\nf = fi->fd->alloc_func(fi);\r\nif (IS_ERR(f))\r\nreturn f;\r\nf->fi = fi;\r\nreturn f;\r\n}\r\nvoid usb_put_function_instance(struct usb_function_instance *fi)\r\n{\r\nstruct module *mod;\r\nif (!fi)\r\nreturn;\r\nmod = fi->fd->mod;\r\nfi->free_func_inst(fi);\r\nmodule_put(mod);\r\n}\r\nvoid usb_put_function(struct usb_function *f)\r\n{\r\nif (!f)\r\nreturn;\r\nf->free_func(f);\r\n}\r\nint usb_function_register(struct usb_function_driver *newf)\r\n{\r\nstruct usb_function_driver *fd;\r\nint ret;\r\nret = -EEXIST;\r\nmutex_lock(&func_lock);\r\nlist_for_each_entry(fd, &func_list, list) {\r\nif (!strcmp(fd->name, newf->name))\r\ngoto out;\r\n}\r\nret = 0;\r\nlist_add_tail(&newf->list, &func_list);\r\nout:\r\nmutex_unlock(&func_lock);\r\nreturn ret;\r\n}\r\nvoid usb_function_unregister(struct usb_function_driver *fd)\r\n{\r\nmutex_lock(&func_lock);\r\nlist_del(&fd->list);\r\nmutex_unlock(&func_lock);\r\n}

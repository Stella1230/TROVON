static unsigned int nf_route_table_hook(const struct nf_hook_ops *ops,\r\nstruct sk_buff *skb,\r\nconst struct net_device *in,\r\nconst struct net_device *out,\r\nint (*okfn)(struct sk_buff *))\r\n{\r\nunsigned int ret;\r\nstruct nft_pktinfo pkt;\r\nu32 mark;\r\n__be32 saddr, daddr;\r\nu_int8_t tos;\r\nconst struct iphdr *iph;\r\nif (skb->len < sizeof(struct iphdr) ||\r\nip_hdrlen(skb) < sizeof(struct iphdr))\r\nreturn NF_ACCEPT;\r\nnft_set_pktinfo_ipv4(&pkt, ops, skb, in, out);\r\nmark = skb->mark;\r\niph = ip_hdr(skb);\r\nsaddr = iph->saddr;\r\ndaddr = iph->daddr;\r\ntos = iph->tos;\r\nret = nft_do_chain(&pkt, ops);\r\nif (ret != NF_DROP && ret != NF_QUEUE) {\r\niph = ip_hdr(skb);\r\nif (iph->saddr != saddr ||\r\niph->daddr != daddr ||\r\nskb->mark != mark ||\r\niph->tos != tos)\r\nif (ip_route_me_harder(skb, RTN_UNSPEC))\r\nret = NF_DROP;\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init nft_chain_route_init(void)\r\n{\r\nreturn nft_register_chain_type(&nft_chain_route_ipv4);\r\n}\r\nstatic void __exit nft_chain_route_exit(void)\r\n{\r\nnft_unregister_chain_type(&nft_chain_route_ipv4);\r\n}

static int\r\ncfs_binheap_grow(cfs_binheap_t *h)\r\n{\r\ncfs_binheap_node_t ***frag1 = NULL;\r\ncfs_binheap_node_t **frag2;\r\nint hwm = h->cbh_hwm;\r\nLASSERT((h->cbh_hwm & CBH_MASK) == 0);\r\nif (hwm == 0) {\r\nCBH_ALLOC(h->cbh_elements1, h);\r\nif (h->cbh_elements1 == NULL)\r\nreturn -ENOMEM;\r\ngoto out;\r\n}\r\nhwm -= CBH_SIZE;\r\nif (hwm < CBH_SIZE * CBH_SIZE) {\r\nCBH_ALLOC(frag2, h);\r\nif (frag2 == NULL)\r\nreturn -ENOMEM;\r\nif (hwm == 0) {\r\nCBH_ALLOC(h->cbh_elements2, h);\r\nif (h->cbh_elements2 == NULL) {\r\nCBH_FREE(frag2);\r\nreturn -ENOMEM;\r\n}\r\n}\r\nh->cbh_elements2[hwm >> CBH_SHIFT] = frag2;\r\ngoto out;\r\n}\r\nhwm -= CBH_SIZE * CBH_SIZE;\r\n#if (CBH_SHIFT * 3 < 32)\r\nif (hwm >= CBH_SIZE * CBH_SIZE * CBH_SIZE) {\r\nreturn -ENOMEM;\r\n}\r\n#endif\r\nCBH_ALLOC(frag2, h);\r\nif (frag2 == NULL)\r\nreturn -ENOMEM;\r\nif (((hwm >> CBH_SHIFT) & CBH_MASK) == 0) {\r\nCBH_ALLOC(frag1, h);\r\nif (frag1 == NULL) {\r\nCBH_FREE(frag2);\r\nreturn -ENOMEM;\r\n}\r\n}\r\nif (hwm == 0) {\r\nCBH_ALLOC(h->cbh_elements3, h);\r\nif (h->cbh_elements3 == NULL) {\r\nCBH_FREE(frag2);\r\nCBH_FREE(frag1);\r\nreturn -ENOMEM;\r\n}\r\n}\r\nif (frag1 != NULL) {\r\nLASSERT(h->cbh_elements3[hwm >> (2 * CBH_SHIFT)] == NULL);\r\nh->cbh_elements3[hwm >> (2 * CBH_SHIFT)] = frag1;\r\n} else {\r\nfrag1 = h->cbh_elements3[hwm >> (2 * CBH_SHIFT)];\r\nLASSERT(frag1 != NULL);\r\n}\r\nfrag1[(hwm >> CBH_SHIFT) & CBH_MASK] = frag2;\r\nout:\r\nh->cbh_hwm += CBH_SIZE;\r\nreturn 0;\r\n}\r\ncfs_binheap_t *\r\ncfs_binheap_create(cfs_binheap_ops_t *ops, unsigned int flags,\r\nunsigned count, void *arg, struct cfs_cpt_table *cptab,\r\nint cptid)\r\n{\r\ncfs_binheap_t *h;\r\nLASSERT(ops != NULL);\r\nLASSERT(ops->hop_compare != NULL);\r\nLASSERT(cptab != NULL);\r\nLASSERT(cptid == CFS_CPT_ANY ||\r\n(cptid >= 0 && cptid < cptab->ctb_nparts));\r\nLIBCFS_CPT_ALLOC(h, cptab, cptid, sizeof(*h));\r\nif (h == NULL)\r\nreturn NULL;\r\nh->cbh_ops = ops;\r\nh->cbh_nelements = 0;\r\nh->cbh_hwm = 0;\r\nh->cbh_private = arg;\r\nh->cbh_flags = flags & (~CBH_FLAG_ATOMIC_GROW);\r\nh->cbh_cptab = cptab;\r\nh->cbh_cptid = cptid;\r\nwhile (h->cbh_hwm < count) {\r\nif (cfs_binheap_grow(h) != 0) {\r\ncfs_binheap_destroy(h);\r\nreturn NULL;\r\n}\r\n}\r\nh->cbh_flags |= flags & CBH_FLAG_ATOMIC_GROW;\r\nreturn h;\r\n}\r\nvoid\r\ncfs_binheap_destroy(cfs_binheap_t *h)\r\n{\r\nint idx0;\r\nint idx1;\r\nint n;\r\nLASSERT(h != NULL);\r\nn = h->cbh_hwm;\r\nif (n > 0) {\r\nCBH_FREE(h->cbh_elements1);\r\nn -= CBH_SIZE;\r\n}\r\nif (n > 0) {\r\nfor (idx0 = 0; idx0 < CBH_SIZE && n > 0; idx0++) {\r\nCBH_FREE(h->cbh_elements2[idx0]);\r\nn -= CBH_SIZE;\r\n}\r\nCBH_FREE(h->cbh_elements2);\r\n}\r\nif (n > 0) {\r\nfor (idx0 = 0; idx0 < CBH_SIZE && n > 0; idx0++) {\r\nfor (idx1 = 0; idx1 < CBH_SIZE && n > 0; idx1++) {\r\nCBH_FREE(h->cbh_elements3[idx0][idx1]);\r\nn -= CBH_SIZE;\r\n}\r\nCBH_FREE(h->cbh_elements3[idx0]);\r\n}\r\nCBH_FREE(h->cbh_elements3);\r\n}\r\nLIBCFS_FREE(h, sizeof(*h));\r\n}\r\nstatic cfs_binheap_node_t **\r\ncfs_binheap_pointer(cfs_binheap_t *h, unsigned int idx)\r\n{\r\nif (idx < CBH_SIZE)\r\nreturn &(h->cbh_elements1[idx]);\r\nidx -= CBH_SIZE;\r\nif (idx < CBH_SIZE * CBH_SIZE)\r\nreturn &(h->cbh_elements2[idx >> CBH_SHIFT][idx & CBH_MASK]);\r\nidx -= CBH_SIZE * CBH_SIZE;\r\nreturn &(h->cbh_elements3[idx >> (2 * CBH_SHIFT)]\\r\n[(idx >> CBH_SHIFT) & CBH_MASK]\\r\n[idx & CBH_MASK]);\r\n}\r\ncfs_binheap_node_t *\r\ncfs_binheap_find(cfs_binheap_t *h, unsigned int idx)\r\n{\r\nif (idx >= h->cbh_nelements)\r\nreturn NULL;\r\nreturn *cfs_binheap_pointer(h, idx);\r\n}\r\nstatic int\r\ncfs_binheap_bubble(cfs_binheap_t *h, cfs_binheap_node_t *e)\r\n{\r\nunsigned int cur_idx = e->chn_index;\r\ncfs_binheap_node_t **cur_ptr;\r\nunsigned int parent_idx;\r\ncfs_binheap_node_t **parent_ptr;\r\nint did_sth = 0;\r\ncur_ptr = cfs_binheap_pointer(h, cur_idx);\r\nLASSERT(*cur_ptr == e);\r\nwhile (cur_idx > 0) {\r\nparent_idx = (cur_idx - 1) >> 1;\r\nparent_ptr = cfs_binheap_pointer(h, parent_idx);\r\nLASSERT((*parent_ptr)->chn_index == parent_idx);\r\nif (h->cbh_ops->hop_compare(*parent_ptr, e))\r\nbreak;\r\n(*parent_ptr)->chn_index = cur_idx;\r\n*cur_ptr = *parent_ptr;\r\ncur_ptr = parent_ptr;\r\ncur_idx = parent_idx;\r\ndid_sth = 1;\r\n}\r\ne->chn_index = cur_idx;\r\n*cur_ptr = e;\r\nreturn did_sth;\r\n}\r\nstatic int\r\ncfs_binheap_sink(cfs_binheap_t *h, cfs_binheap_node_t *e)\r\n{\r\nunsigned int n = h->cbh_nelements;\r\nunsigned int child_idx;\r\ncfs_binheap_node_t **child_ptr;\r\ncfs_binheap_node_t *child;\r\nunsigned int child2_idx;\r\ncfs_binheap_node_t **child2_ptr;\r\ncfs_binheap_node_t *child2;\r\nunsigned int cur_idx;\r\ncfs_binheap_node_t **cur_ptr;\r\nint did_sth = 0;\r\ncur_idx = e->chn_index;\r\ncur_ptr = cfs_binheap_pointer(h, cur_idx);\r\nLASSERT(*cur_ptr == e);\r\nwhile (cur_idx < n) {\r\nchild_idx = (cur_idx << 1) + 1;\r\nif (child_idx >= n)\r\nbreak;\r\nchild_ptr = cfs_binheap_pointer(h, child_idx);\r\nchild = *child_ptr;\r\nchild2_idx = child_idx + 1;\r\nif (child2_idx < n) {\r\nchild2_ptr = cfs_binheap_pointer(h, child2_idx);\r\nchild2 = *child2_ptr;\r\nif (h->cbh_ops->hop_compare(child2, child)) {\r\nchild_idx = child2_idx;\r\nchild_ptr = child2_ptr;\r\nchild = child2;\r\n}\r\n}\r\nLASSERT(child->chn_index == child_idx);\r\nif (h->cbh_ops->hop_compare(e, child))\r\nbreak;\r\nchild->chn_index = cur_idx;\r\n*cur_ptr = child;\r\ncur_ptr = child_ptr;\r\ncur_idx = child_idx;\r\ndid_sth = 1;\r\n}\r\ne->chn_index = cur_idx;\r\n*cur_ptr = e;\r\nreturn did_sth;\r\n}\r\nint\r\ncfs_binheap_insert(cfs_binheap_t *h, cfs_binheap_node_t *e)\r\n{\r\ncfs_binheap_node_t **new_ptr;\r\nunsigned int new_idx = h->cbh_nelements;\r\nint rc;\r\nif (new_idx == h->cbh_hwm) {\r\nrc = cfs_binheap_grow(h);\r\nif (rc != 0)\r\nreturn rc;\r\n}\r\nif (h->cbh_ops->hop_enter) {\r\nrc = h->cbh_ops->hop_enter(h, e);\r\nif (rc != 0)\r\nreturn rc;\r\n}\r\ne->chn_index = new_idx;\r\nnew_ptr = cfs_binheap_pointer(h, new_idx);\r\nh->cbh_nelements++;\r\n*new_ptr = e;\r\ncfs_binheap_bubble(h, e);\r\nreturn 0;\r\n}\r\nvoid\r\ncfs_binheap_remove(cfs_binheap_t *h, cfs_binheap_node_t *e)\r\n{\r\nunsigned int n = h->cbh_nelements;\r\nunsigned int cur_idx = e->chn_index;\r\ncfs_binheap_node_t **cur_ptr;\r\ncfs_binheap_node_t *last;\r\nLASSERT(cur_idx != CBH_POISON);\r\nLASSERT(cur_idx < n);\r\ncur_ptr = cfs_binheap_pointer(h, cur_idx);\r\nLASSERT(*cur_ptr == e);\r\nn--;\r\nlast = *cfs_binheap_pointer(h, n);\r\nh->cbh_nelements = n;\r\nif (last == e)\r\nreturn;\r\nlast->chn_index = cur_idx;\r\n*cur_ptr = last;\r\nif (!cfs_binheap_bubble(h, *cur_ptr))\r\ncfs_binheap_sink(h, *cur_ptr);\r\ne->chn_index = CBH_POISON;\r\nif (h->cbh_ops->hop_exit)\r\nh->cbh_ops->hop_exit(h, e);\r\n}

unsigned int tkip_sbox(unsigned int index)\r\n{\r\nunsigned int index_low;\r\nunsigned int index_high;\r\nunsigned int left, right;\r\nindex_low = (index % 256);\r\nindex_high = ((index >> 8) % 256);\r\nleft = TKIP_Sbox_Lower[index_low] + (TKIP_Sbox_Upper[index_low] * 256);\r\nright = TKIP_Sbox_Upper[index_high] + (TKIP_Sbox_Lower[index_high] * 256);\r\nreturn left ^ right;\r\n}\r\nunsigned int rotr1(unsigned int a)\r\n{\r\nunsigned int b;\r\nif ((a & 0x01) == 0x01) {\r\nb = (a >> 1) | 0x8000;\r\n} else {\r\nb = (a >> 1) & 0x7fff;\r\n}\r\nb = b % 65536;\r\nreturn b;\r\n}\r\nvoid TKIPvMixKey(\r\nunsigned char *pbyTKey,\r\nunsigned char *pbyTA,\r\nunsigned short wTSC15_0,\r\nunsigned long dwTSC47_16,\r\nunsigned char *pbyRC4Key\r\n)\r\n{\r\nunsigned int p1k[5];\r\nunsigned int tsc0, tsc1, tsc2;\r\nunsigned int ppk0, ppk1, ppk2, ppk3, ppk4, ppk5;\r\nunsigned long int pnl, pnh;\r\nint i, j;\r\npnl = wTSC15_0;\r\npnh = dwTSC47_16;\r\ntsc0 = (unsigned int)((pnh >> 16) % 65536);\r\ntsc1 = (unsigned int)(pnh % 65536);\r\ntsc2 = (unsigned int)(pnl % 65536);\r\np1k[0] = tsc1;\r\np1k[1] = tsc0;\r\np1k[2] = (unsigned int)(pbyTA[0] + (pbyTA[1]*256));\r\np1k[3] = (unsigned int)(pbyTA[2] + (pbyTA[3]*256));\r\np1k[4] = (unsigned int)(pbyTA[4] + (pbyTA[5]*256));\r\nfor (i = 0; i < 8; i++) {\r\nj = 2 * (i & 1);\r\np1k[0] = (p1k[0] + tkip_sbox((p1k[4] ^ ((256*pbyTKey[1+j]) + pbyTKey[j])) % 65536)) % 65536;\r\np1k[1] = (p1k[1] + tkip_sbox((p1k[0] ^ ((256*pbyTKey[5+j]) + pbyTKey[4+j])) % 65536)) % 65536;\r\np1k[2] = (p1k[2] + tkip_sbox((p1k[1] ^ ((256*pbyTKey[9+j]) + pbyTKey[8+j])) % 65536)) % 65536;\r\np1k[3] = (p1k[3] + tkip_sbox((p1k[2] ^ ((256*pbyTKey[13+j]) + pbyTKey[12+j])) % 65536)) % 65536;\r\np1k[4] = (p1k[4] + tkip_sbox((p1k[3] ^ (((256*pbyTKey[1+j]) + pbyTKey[j]))) % 65536)) % 65536;\r\np1k[4] = (p1k[4] + i) % 65536;\r\n}\r\nppk0 = p1k[0];\r\nppk1 = p1k[1];\r\nppk2 = p1k[2];\r\nppk3 = p1k[3];\r\nppk4 = p1k[4];\r\nppk5 = (p1k[4] + tsc2) % 65536;\r\nppk0 = ppk0 + tkip_sbox((ppk5 ^ ((256*pbyTKey[1]) + pbyTKey[0])) % 65536);\r\nppk1 = ppk1 + tkip_sbox((ppk0 ^ ((256*pbyTKey[3]) + pbyTKey[2])) % 65536);\r\nppk2 = ppk2 + tkip_sbox((ppk1 ^ ((256*pbyTKey[5]) + pbyTKey[4])) % 65536);\r\nppk3 = ppk3 + tkip_sbox((ppk2 ^ ((256*pbyTKey[7]) + pbyTKey[6])) % 65536);\r\nppk4 = ppk4 + tkip_sbox((ppk3 ^ ((256*pbyTKey[9]) + pbyTKey[8])) % 65536);\r\nppk5 = ppk5 + tkip_sbox((ppk4 ^ ((256*pbyTKey[11]) + pbyTKey[10])) % 65536);\r\nppk0 = ppk0 + rotr1(ppk5 ^ ((256*pbyTKey[13]) + pbyTKey[12]));\r\nppk1 = ppk1 + rotr1(ppk0 ^ ((256*pbyTKey[15]) + pbyTKey[14]));\r\nppk2 = ppk2 + rotr1(ppk1);\r\nppk3 = ppk3 + rotr1(ppk2);\r\nppk4 = ppk4 + rotr1(ppk3);\r\nppk5 = ppk5 + rotr1(ppk4);\r\npbyRC4Key[0] = (tsc2 >> 8) % 256;\r\npbyRC4Key[1] = (((tsc2 >> 8) % 256) | 0x20) & 0x7f;\r\npbyRC4Key[2] = tsc2 % 256;\r\npbyRC4Key[3] = ((ppk5 ^ ((256*pbyTKey[1]) + pbyTKey[0])) >> 1) % 256;\r\npbyRC4Key[4] = ppk0 % 256;\r\npbyRC4Key[5] = (ppk0 >> 8) % 256;\r\npbyRC4Key[6] = ppk1 % 256;\r\npbyRC4Key[7] = (ppk1 >> 8) % 256;\r\npbyRC4Key[8] = ppk2 % 256;\r\npbyRC4Key[9] = (ppk2 >> 8) % 256;\r\npbyRC4Key[10] = ppk3 % 256;\r\npbyRC4Key[11] = (ppk3 >> 8) % 256;\r\npbyRC4Key[12] = ppk4 % 256;\r\npbyRC4Key[13] = (ppk4 >> 8) % 256;\r\npbyRC4Key[14] = ppk5 % 256;\r\npbyRC4Key[15] = (ppk5 >> 8) % 256;\r\n}

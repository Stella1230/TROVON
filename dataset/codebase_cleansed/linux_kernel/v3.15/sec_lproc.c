char *sec_flags2str(unsigned long flags, char *buf, int bufsize)\r\n{\r\nbuf[0] = '\0';\r\nif (flags & PTLRPC_SEC_FL_REVERSE)\r\nstrlcat(buf, "reverse,", bufsize);\r\nif (flags & PTLRPC_SEC_FL_ROOTONLY)\r\nstrlcat(buf, "rootonly,", bufsize);\r\nif (flags & PTLRPC_SEC_FL_UDESC)\r\nstrlcat(buf, "udesc,", bufsize);\r\nif (flags & PTLRPC_SEC_FL_BULK)\r\nstrlcat(buf, "bulk,", bufsize);\r\nif (buf[0] == '\0')\r\nstrlcat(buf, "-,", bufsize);\r\nreturn buf;\r\n}\r\nstatic int sptlrpc_info_lprocfs_seq_show(struct seq_file *seq, void *v)\r\n{\r\nstruct obd_device *dev = seq->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nstruct ptlrpc_sec *sec = NULL;\r\nchar str[32];\r\nLASSERT(strcmp(dev->obd_type->typ_name, LUSTRE_OSC_NAME) == 0 ||\r\nstrcmp(dev->obd_type->typ_name, LUSTRE_MDC_NAME) == 0 ||\r\nstrcmp(dev->obd_type->typ_name, LUSTRE_MGC_NAME) == 0);\r\nif (cli->cl_import)\r\nsec = sptlrpc_import_sec_ref(cli->cl_import);\r\nif (sec == NULL)\r\ngoto out;\r\nsec_flags2str(sec->ps_flvr.sf_flags, str, sizeof(str));\r\nseq_printf(seq, "rpc flavor: %s\n",\r\nsptlrpc_flavor2name_base(sec->ps_flvr.sf_rpc));\r\nseq_printf(seq, "bulk flavor: %s\n",\r\nsptlrpc_flavor2name_bulk(&sec->ps_flvr, str, sizeof(str)));\r\nseq_printf(seq, "flags: %s\n",\r\nsec_flags2str(sec->ps_flvr.sf_flags, str, sizeof(str)));\r\nseq_printf(seq, "id: %d\n", sec->ps_id);\r\nseq_printf(seq, "refcount: %d\n",\r\natomic_read(&sec->ps_refcount));\r\nseq_printf(seq, "nctx: %d\n", atomic_read(&sec->ps_nctx));\r\nseq_printf(seq, "gc internal %ld\n", sec->ps_gc_interval);\r\nseq_printf(seq, "gc next %ld\n",\r\nsec->ps_gc_interval ?\r\nsec->ps_gc_next - cfs_time_current_sec() : 0);\r\nsptlrpc_sec_put(sec);\r\nout:\r\nreturn 0;\r\n}\r\nstatic int sptlrpc_ctxs_lprocfs_seq_show(struct seq_file *seq, void *v)\r\n{\r\nstruct obd_device *dev = seq->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nstruct ptlrpc_sec *sec = NULL;\r\nLASSERT(strcmp(dev->obd_type->typ_name, LUSTRE_OSC_NAME) == 0 ||\r\nstrcmp(dev->obd_type->typ_name, LUSTRE_MDC_NAME) == 0 ||\r\nstrcmp(dev->obd_type->typ_name, LUSTRE_MGC_NAME) == 0);\r\nif (cli->cl_import)\r\nsec = sptlrpc_import_sec_ref(cli->cl_import);\r\nif (sec == NULL)\r\ngoto out;\r\nif (sec->ps_policy->sp_cops->display)\r\nsec->ps_policy->sp_cops->display(sec, seq);\r\nsptlrpc_sec_put(sec);\r\nout:\r\nreturn 0;\r\n}\r\nint sptlrpc_lprocfs_cliobd_attach(struct obd_device *dev)\r\n{\r\nint rc;\r\nif (strcmp(dev->obd_type->typ_name, LUSTRE_OSC_NAME) != 0 &&\r\nstrcmp(dev->obd_type->typ_name, LUSTRE_MDC_NAME) != 0 &&\r\nstrcmp(dev->obd_type->typ_name, LUSTRE_MGC_NAME) != 0) {\r\nCERROR("can't register lproc for obd type %s\n",\r\ndev->obd_type->typ_name);\r\nreturn -EINVAL;\r\n}\r\nrc = lprocfs_obd_seq_create(dev, "srpc_info", 0444,\r\n&sptlrpc_info_lprocfs_fops, dev);\r\nif (rc) {\r\nCERROR("create proc entry srpc_info for %s: %d\n",\r\ndev->obd_name, rc);\r\nreturn rc;\r\n}\r\nrc = lprocfs_obd_seq_create(dev, "srpc_contexts", 0444,\r\n&sptlrpc_ctxs_lprocfs_fops, dev);\r\nif (rc) {\r\nCERROR("create proc entry srpc_contexts for %s: %d\n",\r\ndev->obd_name, rc);\r\nreturn rc;\r\n}\r\nreturn 0;\r\n}\r\nint sptlrpc_lproc_init(void)\r\n{\r\nint rc;\r\nLASSERT(sptlrpc_proc_root == NULL);\r\nsptlrpc_proc_root = lprocfs_register("sptlrpc", proc_lustre_root,\r\nsptlrpc_lprocfs_vars, NULL);\r\nif (IS_ERR(sptlrpc_proc_root)) {\r\nrc = PTR_ERR(sptlrpc_proc_root);\r\nsptlrpc_proc_root = NULL;\r\nreturn rc;\r\n}\r\nreturn 0;\r\n}\r\nvoid sptlrpc_lproc_fini(void)\r\n{\r\nif (sptlrpc_proc_root) {\r\nlprocfs_remove(&sptlrpc_proc_root);\r\nsptlrpc_proc_root = NULL;\r\n}\r\n}

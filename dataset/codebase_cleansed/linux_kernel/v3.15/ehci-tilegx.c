static void tilegx_start_ehc(void)\r\n{\r\n}\r\nstatic void tilegx_stop_ehc(void)\r\n{\r\n}\r\nstatic int tilegx_ehci_setup(struct usb_hcd *hcd)\r\n{\r\nint ret = ehci_init(hcd);\r\nreturn ret;\r\n}\r\nstatic int ehci_hcd_tilegx_drv_probe(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd;\r\nstruct ehci_hcd *ehci;\r\nstruct tilegx_usb_platform_data *pdata = dev_get_platdata(&pdev->dev);\r\npte_t pte = { 0 };\r\nint my_cpu = smp_processor_id();\r\nint ret;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nif (gxio_usb_host_init(&pdata->usb_ctx, pdata->dev_index, 1) != 0)\r\nreturn -ENXIO;\r\nhcd = usb_create_hcd(&ehci_tilegx_hc_driver, &pdev->dev,\r\ndev_name(&pdev->dev));\r\nif (!hcd) {\r\nret = -ENOMEM;\r\ngoto err_hcd;\r\n}\r\nhcd->rsrc_start =\r\n(ulong) gxio_usb_host_get_reg_start(&pdata->usb_ctx);\r\nhcd->rsrc_len = gxio_usb_host_get_reg_len(&pdata->usb_ctx);\r\nhcd->regs = gxio_usb_host_get_reg_start(&pdata->usb_ctx);\r\ntilegx_start_ehc();\r\nehci = hcd_to_ehci(hcd);\r\nehci->caps = hcd->regs;\r\nehci->regs =\r\nhcd->regs + HC_LENGTH(ehci, readl(&ehci->caps->hc_capbase));\r\nehci->hcs_params = readl(&ehci->caps->hcs_params);\r\npdata->irq = create_irq();\r\nif (pdata->irq < 0) {\r\nret = -ENXIO;\r\ngoto err_no_irq;\r\n}\r\ntile_irq_activate(pdata->irq, TILE_IRQ_PERCPU);\r\nret = gxio_usb_host_cfg_interrupt(&pdata->usb_ctx,\r\ncpu_x(my_cpu), cpu_y(my_cpu),\r\nKERNEL_PL, pdata->irq);\r\nif (ret) {\r\nret = -ENXIO;\r\ngoto err_have_irq;\r\n}\r\npte = pte_set_home(pte, PAGE_HOME_HASH);\r\nret = gxio_usb_host_register_client_memory(&pdata->usb_ctx, pte, 0);\r\nif (ret) {\r\nret = -ENXIO;\r\ngoto err_have_irq;\r\n}\r\nret = usb_add_hcd(hcd, pdata->irq, IRQF_SHARED);\r\nif (ret == 0) {\r\nplatform_set_drvdata(pdev, hcd);\r\ndevice_wakeup_enable(hcd->self.controller);\r\nreturn ret;\r\n}\r\nerr_have_irq:\r\ndestroy_irq(pdata->irq);\r\nerr_no_irq:\r\ntilegx_stop_ehc();\r\nusb_put_hcd(hcd);\r\nerr_hcd:\r\ngxio_usb_host_destroy(&pdata->usb_ctx);\r\nreturn ret;\r\n}\r\nstatic int ehci_hcd_tilegx_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nstruct tilegx_usb_platform_data *pdata = dev_get_platdata(&pdev->dev);\r\nusb_remove_hcd(hcd);\r\nusb_put_hcd(hcd);\r\ntilegx_stop_ehc();\r\ngxio_usb_host_destroy(&pdata->usb_ctx);\r\ndestroy_irq(pdata->irq);\r\nreturn 0;\r\n}\r\nstatic void ehci_hcd_tilegx_drv_shutdown(struct platform_device *pdev)\r\n{\r\nusb_hcd_platform_shutdown(pdev);\r\nehci_hcd_tilegx_drv_remove(pdev);\r\n}

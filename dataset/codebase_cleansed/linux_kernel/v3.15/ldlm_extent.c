__u64 ldlm_extent_shift_kms(struct ldlm_lock *lock, __u64 old_kms)\r\n{\r\nstruct ldlm_resource *res = lock->l_resource;\r\nstruct list_head *tmp;\r\nstruct ldlm_lock *lck;\r\n__u64 kms = 0;\r\nlock->l_flags |= LDLM_FL_KMS_IGNORE;\r\nlist_for_each(tmp, &res->lr_granted) {\r\nlck = list_entry(tmp, struct ldlm_lock, l_res_link);\r\nif (lck->l_flags & LDLM_FL_KMS_IGNORE)\r\ncontinue;\r\nif (lck->l_policy_data.l_extent.end >= old_kms)\r\nreturn old_kms;\r\nif (lck->l_policy_data.l_extent.end + 1 > kms)\r\nkms = lck->l_policy_data.l_extent.end + 1;\r\n}\r\nLASSERTF(kms <= old_kms, "kms "LPU64" old_kms "LPU64"\n", kms, old_kms);\r\nreturn kms;\r\n}\r\nstruct ldlm_interval *ldlm_interval_alloc(struct ldlm_lock *lock)\r\n{\r\nstruct ldlm_interval *node;\r\nLASSERT(lock->l_resource->lr_type == LDLM_EXTENT);\r\nOBD_SLAB_ALLOC_PTR_GFP(node, ldlm_interval_slab, __GFP_IO);\r\nif (node == NULL)\r\nreturn NULL;\r\nINIT_LIST_HEAD(&node->li_group);\r\nldlm_interval_attach(node, lock);\r\nreturn node;\r\n}\r\nvoid ldlm_interval_free(struct ldlm_interval *node)\r\n{\r\nif (node) {\r\nLASSERT(list_empty(&node->li_group));\r\nLASSERT(!interval_is_intree(&node->li_node));\r\nOBD_SLAB_FREE(node, ldlm_interval_slab, sizeof(*node));\r\n}\r\n}\r\nvoid ldlm_interval_attach(struct ldlm_interval *n,\r\nstruct ldlm_lock *l)\r\n{\r\nLASSERT(l->l_tree_node == NULL);\r\nLASSERT(l->l_resource->lr_type == LDLM_EXTENT);\r\nlist_add_tail(&l->l_sl_policy, &n->li_group);\r\nl->l_tree_node = n;\r\n}\r\nstruct ldlm_interval *ldlm_interval_detach(struct ldlm_lock *l)\r\n{\r\nstruct ldlm_interval *n = l->l_tree_node;\r\nif (n == NULL)\r\nreturn NULL;\r\nLASSERT(!list_empty(&n->li_group));\r\nl->l_tree_node = NULL;\r\nlist_del_init(&l->l_sl_policy);\r\nreturn list_empty(&n->li_group) ? n : NULL;\r\n}\r\nstatic inline int lock_mode_to_index(ldlm_mode_t mode)\r\n{\r\nint index;\r\nLASSERT(mode != 0);\r\nLASSERT(IS_PO2(mode));\r\nfor (index = -1; mode; index++, mode >>= 1) ;\r\nLASSERT(index < LCK_MODE_NUM);\r\nreturn index;\r\n}\r\nvoid ldlm_extent_add_lock(struct ldlm_resource *res,\r\nstruct ldlm_lock *lock)\r\n{\r\nstruct interval_node *found, **root;\r\nstruct ldlm_interval *node;\r\nstruct ldlm_extent *extent;\r\nint idx;\r\nLASSERT(lock->l_granted_mode == lock->l_req_mode);\r\nnode = lock->l_tree_node;\r\nLASSERT(node != NULL);\r\nLASSERT(!interval_is_intree(&node->li_node));\r\nidx = lock_mode_to_index(lock->l_granted_mode);\r\nLASSERT(lock->l_granted_mode == 1 << idx);\r\nLASSERT(lock->l_granted_mode == res->lr_itree[idx].lit_mode);\r\nextent = &lock->l_policy_data.l_extent;\r\ninterval_set(&node->li_node, extent->start, extent->end);\r\nroot = &res->lr_itree[idx].lit_root;\r\nfound = interval_insert(&node->li_node, root);\r\nif (found) {\r\nstruct ldlm_interval *tmp = ldlm_interval_detach(lock);\r\nLASSERT(tmp != NULL);\r\nldlm_interval_free(tmp);\r\nldlm_interval_attach(to_ldlm_interval(found), lock);\r\n}\r\nres->lr_itree[idx].lit_size++;\r\nldlm_resource_add_lock(res, &res->lr_granted, lock);\r\n}\r\nvoid ldlm_extent_unlink_lock(struct ldlm_lock *lock)\r\n{\r\nstruct ldlm_resource *res = lock->l_resource;\r\nstruct ldlm_interval *node = lock->l_tree_node;\r\nstruct ldlm_interval_tree *tree;\r\nint idx;\r\nif (!node || !interval_is_intree(&node->li_node))\r\nreturn;\r\nidx = lock_mode_to_index(lock->l_granted_mode);\r\nLASSERT(lock->l_granted_mode == 1 << idx);\r\ntree = &res->lr_itree[idx];\r\nLASSERT(tree->lit_root != NULL);\r\ntree->lit_size--;\r\nnode = ldlm_interval_detach(lock);\r\nif (node) {\r\ninterval_erase(&node->li_node, &tree->lit_root);\r\nldlm_interval_free(node);\r\n}\r\n}\r\nvoid ldlm_extent_policy_wire_to_local(const ldlm_wire_policy_data_t *wpolicy,\r\nldlm_policy_data_t *lpolicy)\r\n{\r\nmemset(lpolicy, 0, sizeof(*lpolicy));\r\nlpolicy->l_extent.start = wpolicy->l_extent.start;\r\nlpolicy->l_extent.end = wpolicy->l_extent.end;\r\nlpolicy->l_extent.gid = wpolicy->l_extent.gid;\r\n}\r\nvoid ldlm_extent_policy_local_to_wire(const ldlm_policy_data_t *lpolicy,\r\nldlm_wire_policy_data_t *wpolicy)\r\n{\r\nmemset(wpolicy, 0, sizeof(*wpolicy));\r\nwpolicy->l_extent.start = lpolicy->l_extent.start;\r\nwpolicy->l_extent.end = lpolicy->l_extent.end;\r\nwpolicy->l_extent.gid = lpolicy->l_extent.gid;\r\n}

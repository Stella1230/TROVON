void gss_stat_oos_record_cli(int behind)\r\n{\r\natomic_inc(&gss_stat_oos.oos_cli_count);\r\nspin_lock(&gss_stat_oos.oos_lock);\r\nif (behind > gss_stat_oos.oos_cli_behind)\r\ngss_stat_oos.oos_cli_behind = behind;\r\nspin_unlock(&gss_stat_oos.oos_lock);\r\n}\r\nvoid gss_stat_oos_record_svc(int phase, int replay)\r\n{\r\nLASSERT(phase >= 0 && phase <= 2);\r\nif (replay)\r\natomic_inc(&gss_stat_oos.oos_svc_replay[phase]);\r\nelse\r\natomic_inc(&gss_stat_oos.oos_svc_pass[phase]);\r\n}\r\nstatic int gss_proc_oos_seq_show(struct seq_file *m, void *v)\r\n{\r\nreturn seq_printf(m,\r\n"seqwin: %u\n"\r\n"backwin: %u\n"\r\n"client fall behind seqwin\n"\r\n" occurrence: %d\n"\r\n" max seq behind: %d\n"\r\n"server replay detected:\n"\r\n" phase 0: %d\n"\r\n" phase 1: %d\n"\r\n" phase 2: %d\n"\r\n"server verify ok:\n"\r\n" phase 2: %d\n",\r\nGSS_SEQ_WIN_MAIN,\r\nGSS_SEQ_WIN_BACK,\r\natomic_read(&gss_stat_oos.oos_cli_count),\r\ngss_stat_oos.oos_cli_behind,\r\natomic_read(&gss_stat_oos.oos_svc_replay[0]),\r\natomic_read(&gss_stat_oos.oos_svc_replay[1]),\r\natomic_read(&gss_stat_oos.oos_svc_replay[2]),\r\natomic_read(&gss_stat_oos.oos_svc_pass[2]));\r\n}\r\nstatic int gss_proc_write_secinit(struct file *file, const char *buffer,\r\nsize_t count, off_t *off)\r\n{\r\nint rc;\r\nrc = gss_do_ctx_init_rpc((char *) buffer, count);\r\nif (rc) {\r\nLASSERT(rc < 0);\r\nreturn rc;\r\n}\r\nreturn count;\r\n}\r\nstatic int gss_lk_proc_dl_seq_show(struct seq_file *m, void *v)\r\n{\r\nreturn seq_printf(m, "%u\n", gss_lk_debug_level);\r\n}\r\nstatic int gss_lk_proc_dl_seq_write(struct file *file, const char *buffer,\r\nsize_t count, off_t *off)\r\n{\r\nint val, rc;\r\nrc = lprocfs_write_helper(buffer, count, &val);\r\nif (rc < 0)\r\nreturn rc;\r\nif (val < 0 || val > 4)\r\nreturn -ERANGE;\r\ngss_lk_debug_level = val;\r\nreturn count;\r\n}\r\nvoid gss_exit_lproc(void)\r\n{\r\nif (gss_proc_lk) {\r\nlprocfs_remove(&gss_proc_lk);\r\ngss_proc_lk = NULL;\r\n}\r\nif (gss_proc_root) {\r\nlprocfs_remove(&gss_proc_root);\r\ngss_proc_root = NULL;\r\n}\r\n}\r\nint gss_init_lproc(void)\r\n{\r\nint rc;\r\nspin_lock_init(&gss_stat_oos.oos_lock);\r\ngss_proc_root = lprocfs_register("gss", sptlrpc_proc_root,\r\ngss_lprocfs_vars, NULL);\r\nif (IS_ERR(gss_proc_root)) {\r\nrc = PTR_ERR(gss_proc_root);\r\ngss_proc_root = NULL;\r\nGOTO(err_out, rc);\r\n}\r\ngss_proc_lk = lprocfs_register("lgss_keyring", gss_proc_root,\r\ngss_lk_lprocfs_vars, NULL);\r\nif (IS_ERR(gss_proc_lk)) {\r\nrc = PTR_ERR(gss_proc_lk);\r\ngss_proc_lk = NULL;\r\nGOTO(err_out, rc);\r\n}\r\nreturn 0;\r\nerr_out:\r\nCERROR("failed to initialize gss lproc entries: %d\n", rc);\r\ngss_exit_lproc();\r\nreturn rc;\r\n}

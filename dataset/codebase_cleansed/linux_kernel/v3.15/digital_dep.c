static void digital_skb_push_dep_sod(struct nfc_digital_dev *ddev,\r\nstruct sk_buff *skb)\r\n{\r\nskb_push(skb, sizeof(u8));\r\nskb->data[0] = skb->len;\r\nif (ddev->curr_rf_tech == NFC_DIGITAL_RF_TECH_106A)\r\n*skb_push(skb, sizeof(u8)) = DIGITAL_NFC_DEP_NFCA_SOD_SB;\r\n}\r\nstatic int digital_skb_pull_dep_sod(struct nfc_digital_dev *ddev,\r\nstruct sk_buff *skb)\r\n{\r\nu8 size;\r\nif (skb->len < 2)\r\nreturn -EIO;\r\nif (ddev->curr_rf_tech == NFC_DIGITAL_RF_TECH_106A)\r\nskb_pull(skb, sizeof(u8));\r\nsize = skb->data[0];\r\nif (size != skb->len)\r\nreturn -EIO;\r\nskb_pull(skb, sizeof(u8));\r\nreturn 0;\r\n}\r\nstatic void digital_in_recv_atr_res(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nstruct nfc_target *target = arg;\r\nstruct digital_atr_res *atr_res;\r\nu8 gb_len;\r\nint rc;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nrc = ddev->skb_check_crc(resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.6");\r\ngoto exit;\r\n}\r\nrc = digital_skb_pull_dep_sod(ddev, resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.2");\r\ngoto exit;\r\n}\r\nif (resp->len < sizeof(struct digital_atr_res)) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\ngb_len = resp->len - sizeof(struct digital_atr_res);\r\natr_res = (struct digital_atr_res *)resp->data;\r\nrc = nfc_set_remote_general_bytes(ddev->nfc_dev, atr_res->gb, gb_len);\r\nif (rc)\r\ngoto exit;\r\nrc = nfc_dep_link_is_up(ddev->nfc_dev, target->idx, NFC_COMM_ACTIVE,\r\nNFC_RF_INITIATOR);\r\nddev->curr_nfc_dep_pni = 0;\r\nexit:\r\ndev_kfree_skb(resp);\r\nif (rc)\r\nddev->curr_protocol = 0;\r\n}\r\nint digital_in_send_atr_req(struct nfc_digital_dev *ddev,\r\nstruct nfc_target *target, __u8 comm_mode, __u8 *gb,\r\nsize_t gb_len)\r\n{\r\nstruct sk_buff *skb;\r\nstruct digital_atr_req *atr_req;\r\nuint size;\r\nsize = DIGITAL_ATR_REQ_MIN_SIZE + gb_len;\r\nif (size > DIGITAL_ATR_REQ_MAX_SIZE) {\r\nPROTOCOL_ERR("14.6.1.1");\r\nreturn -EINVAL;\r\n}\r\nskb = digital_skb_alloc(ddev, size);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_put(skb, sizeof(struct digital_atr_req));\r\natr_req = (struct digital_atr_req *)skb->data;\r\nmemset(atr_req, 0, sizeof(struct digital_atr_req));\r\natr_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\r\natr_req->cmd = DIGITAL_CMD_ATR_REQ;\r\nif (target->nfcid2_len)\r\nmemcpy(atr_req->nfcid3, target->nfcid2, NFC_NFCID2_MAXSIZE);\r\nelse\r\nget_random_bytes(atr_req->nfcid3, NFC_NFCID3_MAXSIZE);\r\natr_req->did = 0;\r\natr_req->bs = 0;\r\natr_req->br = 0;\r\natr_req->pp = DIGITAL_LR_BITS_PAYLOAD_SIZE_254B;\r\nif (gb_len) {\r\natr_req->pp |= DIGITAL_GB_BIT;\r\nmemcpy(skb_put(skb, gb_len), gb, gb_len);\r\n}\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\ndigital_in_send_cmd(ddev, skb, 500, digital_in_recv_atr_res, target);\r\nreturn 0;\r\n}\r\nstatic int digital_in_send_rtox(struct nfc_digital_dev *ddev,\r\nstruct digital_data_exch *data_exch, u8 rtox)\r\n{\r\nstruct digital_dep_req_res *dep_req;\r\nstruct sk_buff *skb;\r\nint rc;\r\nskb = digital_skb_alloc(ddev, 1);\r\nif (!skb)\r\nreturn -ENOMEM;\r\n*skb_put(skb, 1) = rtox;\r\nskb_push(skb, sizeof(struct digital_dep_req_res));\r\ndep_req = (struct digital_dep_req_res *)skb->data;\r\ndep_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\r\ndep_req->cmd = DIGITAL_CMD_DEP_REQ;\r\ndep_req->pfb = DIGITAL_NFC_DEP_PFB_SUPERVISOR_PDU |\r\nDIGITAL_NFC_DEP_PFB_TIMEOUT_BIT;\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nrc = digital_in_send_cmd(ddev, skb, 1500, digital_in_recv_dep_res,\r\ndata_exch);\r\nreturn rc;\r\n}\r\nstatic void digital_in_recv_dep_res(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nstruct digital_data_exch *data_exch = arg;\r\nstruct digital_dep_req_res *dep_res;\r\nu8 pfb;\r\nuint size;\r\nint rc;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nrc = ddev->skb_check_crc(resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.6");\r\ngoto error;\r\n}\r\nrc = digital_skb_pull_dep_sod(ddev, resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.2");\r\ngoto exit;\r\n}\r\ndep_res = (struct digital_dep_req_res *)resp->data;\r\nif (resp->len < sizeof(struct digital_dep_req_res) ||\r\ndep_res->dir != DIGITAL_NFC_DEP_FRAME_DIR_IN ||\r\ndep_res->cmd != DIGITAL_CMD_DEP_RES) {\r\nrc = -EIO;\r\ngoto error;\r\n}\r\npfb = dep_res->pfb;\r\nswitch (DIGITAL_NFC_DEP_PFB_TYPE(pfb)) {\r\ncase DIGITAL_NFC_DEP_PFB_I_PDU:\r\nif (DIGITAL_NFC_DEP_PFB_PNI(pfb) != ddev->curr_nfc_dep_pni) {\r\nPROTOCOL_ERR("14.12.3.3");\r\nrc = -EIO;\r\ngoto error;\r\n}\r\nddev->curr_nfc_dep_pni =\r\nDIGITAL_NFC_DEP_PFB_PNI(ddev->curr_nfc_dep_pni + 1);\r\nrc = 0;\r\nbreak;\r\ncase DIGITAL_NFC_DEP_PFB_ACK_NACK_PDU:\r\npr_err("Received a ACK/NACK PDU\n");\r\nrc = -EIO;\r\ngoto error;\r\ncase DIGITAL_NFC_DEP_PFB_SUPERVISOR_PDU:\r\nif (!DIGITAL_NFC_DEP_PFB_IS_TIMEOUT(pfb)) {\r\nrc = -EINVAL;\r\ngoto error;\r\n}\r\nrc = digital_in_send_rtox(ddev, data_exch, resp->data[3]);\r\nif (rc)\r\ngoto error;\r\nkfree_skb(resp);\r\nreturn;\r\n}\r\nif (DIGITAL_NFC_DEP_MI_BIT_SET(pfb)) {\r\npr_err("MI bit set. Chained PDU not supported\n");\r\nrc = -EIO;\r\ngoto error;\r\n}\r\nsize = sizeof(struct digital_dep_req_res);\r\nif (DIGITAL_NFC_DEP_DID_BIT_SET(pfb))\r\nsize++;\r\nif (size > resp->len) {\r\nrc = -EIO;\r\ngoto error;\r\n}\r\nskb_pull(resp, size);\r\nexit:\r\ndata_exch->cb(data_exch->cb_context, resp, rc);\r\nerror:\r\nkfree(data_exch);\r\nif (rc)\r\nkfree_skb(resp);\r\n}\r\nint digital_in_send_dep_req(struct nfc_digital_dev *ddev,\r\nstruct nfc_target *target, struct sk_buff *skb,\r\nstruct digital_data_exch *data_exch)\r\n{\r\nstruct digital_dep_req_res *dep_req;\r\nskb_push(skb, sizeof(struct digital_dep_req_res));\r\ndep_req = (struct digital_dep_req_res *)skb->data;\r\ndep_req->dir = DIGITAL_NFC_DEP_FRAME_DIR_OUT;\r\ndep_req->cmd = DIGITAL_CMD_DEP_REQ;\r\ndep_req->pfb = ddev->curr_nfc_dep_pni;\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nreturn digital_in_send_cmd(ddev, skb, 1500, digital_in_recv_dep_res,\r\ndata_exch);\r\n}\r\nstatic void digital_tg_set_rf_tech(struct nfc_digital_dev *ddev, u8 rf_tech)\r\n{\r\nddev->curr_rf_tech = rf_tech;\r\nddev->skb_add_crc = digital_skb_add_crc_none;\r\nddev->skb_check_crc = digital_skb_check_crc_none;\r\nif (DIGITAL_DRV_CAPS_TG_CRC(ddev))\r\nreturn;\r\nswitch (ddev->curr_rf_tech) {\r\ncase NFC_DIGITAL_RF_TECH_106A:\r\nddev->skb_add_crc = digital_skb_add_crc_a;\r\nddev->skb_check_crc = digital_skb_check_crc_a;\r\nbreak;\r\ncase NFC_DIGITAL_RF_TECH_212F:\r\ncase NFC_DIGITAL_RF_TECH_424F:\r\nddev->skb_add_crc = digital_skb_add_crc_f;\r\nddev->skb_check_crc = digital_skb_check_crc_f;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void digital_tg_recv_dep_req(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nint rc;\r\nstruct digital_dep_req_res *dep_req;\r\nsize_t size;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nrc = ddev->skb_check_crc(resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.6");\r\ngoto exit;\r\n}\r\nrc = digital_skb_pull_dep_sod(ddev, resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.2");\r\ngoto exit;\r\n}\r\nsize = sizeof(struct digital_dep_req_res);\r\ndep_req = (struct digital_dep_req_res *)resp->data;\r\nif (resp->len < size || dep_req->dir != DIGITAL_NFC_DEP_FRAME_DIR_OUT ||\r\ndep_req->cmd != DIGITAL_CMD_DEP_REQ) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nif (DIGITAL_NFC_DEP_DID_BIT_SET(dep_req->pfb))\r\nsize++;\r\nif (resp->len < size) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nswitch (DIGITAL_NFC_DEP_PFB_TYPE(dep_req->pfb)) {\r\ncase DIGITAL_NFC_DEP_PFB_I_PDU:\r\npr_debug("DIGITAL_NFC_DEP_PFB_I_PDU\n");\r\nddev->curr_nfc_dep_pni = DIGITAL_NFC_DEP_PFB_PNI(dep_req->pfb);\r\nbreak;\r\ncase DIGITAL_NFC_DEP_PFB_ACK_NACK_PDU:\r\npr_err("Received a ACK/NACK PDU\n");\r\nrc = -EINVAL;\r\ngoto exit;\r\nbreak;\r\ncase DIGITAL_NFC_DEP_PFB_SUPERVISOR_PDU:\r\npr_err("Received a SUPERVISOR PDU\n");\r\nrc = -EINVAL;\r\ngoto exit;\r\nbreak;\r\n}\r\nskb_pull(resp, size);\r\nrc = nfc_tm_data_received(ddev->nfc_dev, resp);\r\nexit:\r\nif (rc)\r\nkfree_skb(resp);\r\n}\r\nint digital_tg_send_dep_res(struct nfc_digital_dev *ddev, struct sk_buff *skb)\r\n{\r\nstruct digital_dep_req_res *dep_res;\r\nskb_push(skb, sizeof(struct digital_dep_req_res));\r\ndep_res = (struct digital_dep_req_res *)skb->data;\r\ndep_res->dir = DIGITAL_NFC_DEP_FRAME_DIR_IN;\r\ndep_res->cmd = DIGITAL_CMD_DEP_RES;\r\ndep_res->pfb = ddev->curr_nfc_dep_pni;\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nreturn digital_tg_send_cmd(ddev, skb, 1500, digital_tg_recv_dep_req,\r\nNULL);\r\n}\r\nstatic void digital_tg_send_psl_res_complete(struct nfc_digital_dev *ddev,\r\nvoid *arg, struct sk_buff *resp)\r\n{\r\nu8 rf_tech = (unsigned long)arg;\r\nif (IS_ERR(resp))\r\nreturn;\r\ndigital_tg_set_rf_tech(ddev, rf_tech);\r\ndigital_tg_configure_hw(ddev, NFC_DIGITAL_CONFIG_RF_TECH, rf_tech);\r\ndigital_tg_listen(ddev, 1500, digital_tg_recv_dep_req, NULL);\r\ndev_kfree_skb(resp);\r\n}\r\nstatic int digital_tg_send_psl_res(struct nfc_digital_dev *ddev, u8 did,\r\nu8 rf_tech)\r\n{\r\nstruct digital_psl_res *psl_res;\r\nstruct sk_buff *skb;\r\nint rc;\r\nskb = digital_skb_alloc(ddev, sizeof(struct digital_psl_res));\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_put(skb, sizeof(struct digital_psl_res));\r\npsl_res = (struct digital_psl_res *)skb->data;\r\npsl_res->dir = DIGITAL_NFC_DEP_FRAME_DIR_IN;\r\npsl_res->cmd = DIGITAL_CMD_PSL_RES;\r\npsl_res->did = did;\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nrc = digital_tg_send_cmd(ddev, skb, 0, digital_tg_send_psl_res_complete,\r\n(void *)(unsigned long)rf_tech);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic void digital_tg_recv_psl_req(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nint rc;\r\nstruct digital_psl_req *psl_req;\r\nu8 rf_tech;\r\nu8 dsi;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nrc = ddev->skb_check_crc(resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.6");\r\ngoto exit;\r\n}\r\nrc = digital_skb_pull_dep_sod(ddev, resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.2");\r\ngoto exit;\r\n}\r\npsl_req = (struct digital_psl_req *)resp->data;\r\nif (resp->len != sizeof(struct digital_psl_req) ||\r\npsl_req->dir != DIGITAL_NFC_DEP_FRAME_DIR_OUT ||\r\npsl_req->cmd != DIGITAL_CMD_PSL_REQ) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\ndsi = (psl_req->brs >> 3) & 0x07;\r\nswitch (dsi) {\r\ncase 0:\r\nrf_tech = NFC_DIGITAL_RF_TECH_106A;\r\nbreak;\r\ncase 1:\r\nrf_tech = NFC_DIGITAL_RF_TECH_212F;\r\nbreak;\r\ncase 2:\r\nrf_tech = NFC_DIGITAL_RF_TECH_424F;\r\nbreak;\r\ndefault:\r\npr_err("Unsupported dsi value %d\n", dsi);\r\ngoto exit;\r\n}\r\nrc = digital_tg_send_psl_res(ddev, psl_req->did, rf_tech);\r\nexit:\r\nkfree_skb(resp);\r\n}\r\nstatic void digital_tg_send_atr_res_complete(struct nfc_digital_dev *ddev,\r\nvoid *arg, struct sk_buff *resp)\r\n{\r\nint offset;\r\nif (IS_ERR(resp)) {\r\ndigital_poll_next_tech(ddev);\r\nreturn;\r\n}\r\noffset = 2;\r\nif (resp->data[0] == DIGITAL_NFC_DEP_NFCA_SOD_SB)\r\noffset++;\r\nif (resp->data[offset] == DIGITAL_CMD_PSL_REQ)\r\ndigital_tg_recv_psl_req(ddev, arg, resp);\r\nelse\r\ndigital_tg_recv_dep_req(ddev, arg, resp);\r\n}\r\nstatic int digital_tg_send_atr_res(struct nfc_digital_dev *ddev,\r\nstruct digital_atr_req *atr_req)\r\n{\r\nstruct digital_atr_res *atr_res;\r\nstruct sk_buff *skb;\r\nu8 *gb;\r\nsize_t gb_len;\r\nint rc;\r\ngb = nfc_get_local_general_bytes(ddev->nfc_dev, &gb_len);\r\nif (!gb)\r\ngb_len = 0;\r\nskb = digital_skb_alloc(ddev, sizeof(struct digital_atr_res) + gb_len);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_put(skb, sizeof(struct digital_atr_res));\r\natr_res = (struct digital_atr_res *)skb->data;\r\nmemset(atr_res, 0, sizeof(struct digital_atr_res));\r\natr_res->dir = DIGITAL_NFC_DEP_FRAME_DIR_IN;\r\natr_res->cmd = DIGITAL_CMD_ATR_RES;\r\nmemcpy(atr_res->nfcid3, atr_req->nfcid3, sizeof(atr_req->nfcid3));\r\natr_res->to = 8;\r\natr_res->pp = DIGITAL_LR_BITS_PAYLOAD_SIZE_254B;\r\nif (gb_len) {\r\nskb_put(skb, gb_len);\r\natr_res->pp |= DIGITAL_GB_BIT;\r\nmemcpy(atr_res->gb, gb, gb_len);\r\n}\r\ndigital_skb_push_dep_sod(ddev, skb);\r\nddev->skb_add_crc(skb);\r\nrc = digital_tg_send_cmd(ddev, skb, 999,\r\ndigital_tg_send_atr_res_complete, NULL);\r\nif (rc) {\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nreturn rc;\r\n}\r\nvoid digital_tg_recv_atr_req(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nint rc;\r\nstruct digital_atr_req *atr_req;\r\nsize_t gb_len, min_size;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nif (!resp->len) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nif (resp->data[0] == DIGITAL_NFC_DEP_NFCA_SOD_SB) {\r\nmin_size = DIGITAL_ATR_REQ_MIN_SIZE + 2;\r\ndigital_tg_set_rf_tech(ddev, NFC_DIGITAL_RF_TECH_106A);\r\n} else {\r\nmin_size = DIGITAL_ATR_REQ_MIN_SIZE + 1;\r\ndigital_tg_set_rf_tech(ddev, NFC_DIGITAL_RF_TECH_212F);\r\n}\r\nif (resp->len < min_size) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nddev->curr_protocol = NFC_PROTO_NFC_DEP_MASK;\r\nrc = ddev->skb_check_crc(resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.6");\r\ngoto exit;\r\n}\r\nrc = digital_skb_pull_dep_sod(ddev, resp);\r\nif (rc) {\r\nPROTOCOL_ERR("14.4.1.2");\r\ngoto exit;\r\n}\r\natr_req = (struct digital_atr_req *)resp->data;\r\nif (atr_req->dir != DIGITAL_NFC_DEP_FRAME_DIR_OUT ||\r\natr_req->cmd != DIGITAL_CMD_ATR_REQ) {\r\nrc = -EINVAL;\r\ngoto exit;\r\n}\r\nrc = digital_tg_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\r\nNFC_DIGITAL_FRAMING_NFC_DEP_ACTIVATED);\r\nif (rc)\r\ngoto exit;\r\nrc = digital_tg_send_atr_res(ddev, atr_req);\r\nif (rc)\r\ngoto exit;\r\ngb_len = resp->len - sizeof(struct digital_atr_req);\r\nrc = nfc_tm_activated(ddev->nfc_dev, NFC_PROTO_NFC_DEP_MASK,\r\nNFC_COMM_PASSIVE, atr_req->gb, gb_len);\r\nif (rc)\r\ngoto exit;\r\nddev->poll_tech_count = 0;\r\nrc = 0;\r\nexit:\r\nif (rc)\r\ndigital_poll_next_tech(ddev);\r\ndev_kfree_skb(resp);\r\n}

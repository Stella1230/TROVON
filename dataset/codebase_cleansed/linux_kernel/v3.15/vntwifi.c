void\r\nVNTWIFIvSetOPMode(\r\nvoid *pMgmtHandle,\r\nWMAC_CONFIG_MODE eOPMode\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject)pMgmtHandle;\r\npMgmt->eConfigMode = eOPMode;\r\n}\r\nvoid\r\nVNTWIFIvSetIBSSParameter(\r\nvoid *pMgmtHandle,\r\nunsigned short wBeaconPeriod,\r\nunsigned short wATIMWindow,\r\nunsigned int uChannel\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject)pMgmtHandle;\r\npMgmt->wIBSSBeaconPeriod = wBeaconPeriod;\r\npMgmt->wIBSSATIMWindow = wATIMWindow;\r\npMgmt->uIBSSChannel = uChannel;\r\n}\r\nPWLAN_IE_SSID\r\nVNTWIFIpGetCurrentSSID(\r\nvoid *pMgmtHandle\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject)pMgmtHandle;\r\nreturn (PWLAN_IE_SSID) pMgmt->abyCurrSSID;\r\n}\r\nunsigned int\r\nVNTWIFIpGetCurrentChannel(\r\nvoid *pMgmtHandle\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject)pMgmtHandle;\r\nif (pMgmtHandle != NULL) {\r\nreturn pMgmt->uCurrChannel;\r\n}\r\nreturn 0;\r\n}\r\nunsigned short\r\nVNTWIFIwGetAssocID(\r\nvoid *pMgmtHandle\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject)pMgmtHandle;\r\nreturn pMgmt->wCurrAID;\r\n}\r\nunsigned char\r\nVNTWIFIbyGetMaxSupportRate(\r\nPWLAN_IE_SUPP_RATES pSupportRateIEs,\r\nPWLAN_IE_SUPP_RATES pExtSupportRateIEs\r\n)\r\n{\r\nunsigned char byMaxSupportRate = RATE_1M;\r\nunsigned char bySupportRate = RATE_1M;\r\nunsigned int ii = 0;\r\nif (pSupportRateIEs) {\r\nfor (ii = 0; ii < pSupportRateIEs->len; ii++) {\r\nbySupportRate = DATARATEbyGetRateIdx(pSupportRateIEs->abyRates[ii]);\r\nif (bySupportRate > byMaxSupportRate) {\r\nbyMaxSupportRate = bySupportRate;\r\n}\r\n}\r\n}\r\nif (pExtSupportRateIEs) {\r\nfor (ii = 0; ii < pExtSupportRateIEs->len; ii++) {\r\nbySupportRate = DATARATEbyGetRateIdx(pExtSupportRateIEs->abyRates[ii]);\r\nif (bySupportRate > byMaxSupportRate) {\r\nbyMaxSupportRate = bySupportRate;\r\n}\r\n}\r\n}\r\nreturn byMaxSupportRate;\r\n}\r\nunsigned char\r\nVNTWIFIbyGetACKTxRate(\r\nunsigned char byRxDataRate,\r\nPWLAN_IE_SUPP_RATES pSupportRateIEs,\r\nPWLAN_IE_SUPP_RATES pExtSupportRateIEs\r\n)\r\n{\r\nunsigned char byMaxAckRate;\r\nunsigned char byBasicRate;\r\nunsigned int ii;\r\nif (byRxDataRate <= RATE_11M) {\r\nbyMaxAckRate = RATE_1M;\r\n} else {\r\nbyMaxAckRate = RATE_24M;\r\n}\r\nif (pSupportRateIEs) {\r\nfor (ii = 0; ii < pSupportRateIEs->len; ii++) {\r\nif (pSupportRateIEs->abyRates[ii] & 0x80) {\r\nbyBasicRate = DATARATEbyGetRateIdx(pSupportRateIEs->abyRates[ii]);\r\nif ((byBasicRate <= byRxDataRate) &&\r\n(byBasicRate > byMaxAckRate)) {\r\nbyMaxAckRate = byBasicRate;\r\n}\r\n}\r\n}\r\n}\r\nif (pExtSupportRateIEs) {\r\nfor (ii = 0; ii < pExtSupportRateIEs->len; ii++) {\r\nif (pExtSupportRateIEs->abyRates[ii] & 0x80) {\r\nbyBasicRate = DATARATEbyGetRateIdx(pExtSupportRateIEs->abyRates[ii]);\r\nif ((byBasicRate <= byRxDataRate) &&\r\n(byBasicRate > byMaxAckRate)) {\r\nbyMaxAckRate = byBasicRate;\r\n}\r\n}\r\n}\r\n}\r\nreturn byMaxAckRate;\r\n}\r\nvoid\r\nVNTWIFIvSetAuthenticationMode(\r\nvoid *pMgmtHandle,\r\nWMAC_AUTHENTICATION_MODE eAuthMode\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject)pMgmtHandle;\r\npMgmt->eAuthenMode = eAuthMode;\r\nif ((eAuthMode == WMAC_AUTH_SHAREKEY) ||\r\n(eAuthMode == WMAC_AUTH_AUTO)) {\r\npMgmt->bShareKeyAlgorithm = true;\r\n} else {\r\npMgmt->bShareKeyAlgorithm = false;\r\n}\r\n}\r\nvoid\r\nVNTWIFIvSetEncryptionMode(\r\nvoid *pMgmtHandle,\r\nWMAC_ENCRYPTION_MODE eEncryptionMode\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject)pMgmtHandle;\r\npMgmt->eEncryptionMode = eEncryptionMode;\r\nif ((eEncryptionMode == WMAC_ENCRYPTION_WEPEnabled) ||\r\n(eEncryptionMode == WMAC_ENCRYPTION_TKIPEnabled) ||\r\n(eEncryptionMode == WMAC_ENCRYPTION_AESEnabled)) {\r\npMgmt->bPrivacyInvoked = true;\r\n} else {\r\npMgmt->bPrivacyInvoked = false;\r\n}\r\n}\r\nbool\r\nVNTWIFIbConfigPhyMode(\r\nvoid *pMgmtHandle,\r\nCARD_PHY_TYPE ePhyType\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject)pMgmtHandle;\r\nif ((ePhyType != PHY_TYPE_AUTO) &&\r\n(ePhyType != pMgmt->eCurrentPHYMode)) {\r\nif (CARDbSetPhyParameter(pMgmt->pAdapter, ePhyType, 0, 0, NULL, NULL) == true) {\r\npMgmt->eCurrentPHYMode = ePhyType;\r\n} else {\r\nreturn false;\r\n}\r\n}\r\npMgmt->eConfigPHYMode = ePhyType;\r\nreturn true;\r\n}\r\nvoid\r\nVNTWIFIbGetConfigPhyMode(\r\nvoid *pMgmtHandle,\r\nvoid *pePhyType\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject)pMgmtHandle;\r\nif ((pMgmt != NULL) && (pePhyType != NULL)) {\r\n*(PCARD_PHY_TYPE)pePhyType = pMgmt->eConfigPHYMode;\r\n}\r\n}\r\nvoid\r\nVNTWIFIvQueryBSSList(void *pMgmtHandle, unsigned int *puBSSCount, void **pvFirstBSS)\r\n{\r\nunsigned int ii = 0;\r\nPSMgmtObject pMgmt = (PSMgmtObject)pMgmtHandle;\r\nPKnownBSS pBSS = NULL;\r\nunsigned int uCount = 0;\r\n*pvFirstBSS = NULL;\r\nfor (ii = 0; ii < MAX_BSS_NUM; ii++) {\r\npBSS = &(pMgmt->sBSSList[ii]);\r\nif (!pBSS->bActive) {\r\ncontinue;\r\n}\r\nif (*pvFirstBSS == NULL) {\r\n*pvFirstBSS = &(pMgmt->sBSSList[ii]);\r\n}\r\nuCount++;\r\n}\r\n*puBSSCount = uCount;\r\n}\r\nvoid\r\nVNTWIFIvGetNextBSS(\r\nvoid *pMgmtHandle,\r\nvoid *pvCurrentBSS,\r\nvoid **pvNextBSS\r\n)\r\n{\r\nPKnownBSS pBSS = (PKnownBSS) pvCurrentBSS;\r\nPSMgmtObject pMgmt = (PSMgmtObject)pMgmtHandle;\r\n*pvNextBSS = NULL;\r\nwhile (*pvNextBSS == NULL) {\r\npBSS++;\r\nif (pBSS > &(pMgmt->sBSSList[MAX_BSS_NUM])) {\r\nreturn;\r\n}\r\nif (pBSS->bActive == true) {\r\n*pvNextBSS = pBSS;\r\nreturn;\r\n}\r\n}\r\n}\r\nvoid\r\nVNTWIFIvUpdateNodeTxCounter(\r\nvoid *pMgmtHandle,\r\nunsigned char *pbyDestAddress,\r\nbool bTxOk,\r\nunsigned short wRate,\r\nunsigned char *pbyTxFailCount\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject)pMgmtHandle;\r\nunsigned int uNodeIndex = 0;\r\nunsigned int ii;\r\nif ((pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) ||\r\n(pMgmt->eCurrMode == WMAC_MODE_ESS_AP)) {\r\nif (BSSDBbIsSTAInNodeDB(pMgmt, pbyDestAddress, &uNodeIndex) == false) {\r\nreturn;\r\n}\r\n}\r\npMgmt->sNodeDBTable[uNodeIndex].uTxAttempts++;\r\nif (bTxOk) {\r\npMgmt->sNodeDBTable[uNodeIndex].uTxOk[MAX_RATE]++;\r\npMgmt->sNodeDBTable[uNodeIndex].uTxOk[wRate]++;\r\n} else {\r\npMgmt->sNodeDBTable[uNodeIndex].uTxFailures++;\r\n}\r\npMgmt->sNodeDBTable[uNodeIndex].uTxRetry += pbyTxFailCount[MAX_RATE];\r\nfor (ii = 0; ii < MAX_RATE; ii++) {\r\npMgmt->sNodeDBTable[uNodeIndex].uTxFail[ii] += pbyTxFailCount[ii];\r\n}\r\nreturn;\r\n}\r\nvoid\r\nVNTWIFIvGetTxRate(\r\nvoid *pMgmtHandle,\r\nunsigned char *pbyDestAddress,\r\nunsigned short *pwTxDataRate,\r\nunsigned char *pbyACKRate,\r\nunsigned char *pbyCCKBasicRate,\r\nunsigned char *pbyOFDMBasicRate\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject)pMgmtHandle;\r\nunsigned int uNodeIndex = 0;\r\nunsigned short wTxDataRate = RATE_1M;\r\nunsigned char byACKRate = RATE_1M;\r\nunsigned char byCCKBasicRate = RATE_1M;\r\nunsigned char byOFDMBasicRate = RATE_24M;\r\nPWLAN_IE_SUPP_RATES pSupportRateIEs = NULL;\r\nPWLAN_IE_SUPP_RATES pExtSupportRateIEs = NULL;\r\nif ((pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) ||\r\n(pMgmt->eCurrMode == WMAC_MODE_ESS_AP)) {\r\nif (BSSDBbIsSTAInNodeDB(pMgmt, pbyDestAddress, &uNodeIndex)) {\r\nwTxDataRate = (pMgmt->sNodeDBTable[uNodeIndex].wTxDataRate);\r\npSupportRateIEs = (PWLAN_IE_SUPP_RATES) (pMgmt->sNodeDBTable[uNodeIndex].abyCurrSuppRates);\r\npExtSupportRateIEs = (PWLAN_IE_SUPP_RATES) (pMgmt->sNodeDBTable[uNodeIndex].abyCurrExtSuppRates);\r\n} else {\r\nif (pMgmt->eCurrentPHYMode != PHY_TYPE_11A) {\r\nwTxDataRate = RATE_2M;\r\n} else {\r\nwTxDataRate = RATE_24M;\r\n}\r\npSupportRateIEs = (PWLAN_IE_SUPP_RATES) pMgmt->abyCurrSuppRates;\r\npExtSupportRateIEs = (PWLAN_IE_SUPP_RATES) pMgmt->abyCurrExtSuppRates;\r\n}\r\n} else {\r\nwTxDataRate = (pMgmt->sNodeDBTable[0].wTxDataRate);\r\n#ifdef PLICE_DEBUG\r\nprintk(KERN_DEBUG "GetTxRate:AP MAC is %pM,TxRate is %d\n",\r\npMgmt->sNodeDBTable[0].abyMACAddr, wTxDataRate);\r\n#endif\r\npSupportRateIEs = (PWLAN_IE_SUPP_RATES) pMgmt->abyCurrSuppRates;\r\npExtSupportRateIEs = (PWLAN_IE_SUPP_RATES) pMgmt->abyCurrExtSuppRates;\r\n}\r\nbyACKRate = VNTWIFIbyGetACKTxRate((unsigned char) wTxDataRate,\r\npSupportRateIEs,\r\npExtSupportRateIEs\r\n);\r\nif (byACKRate > (unsigned char) wTxDataRate) {\r\nbyACKRate = (unsigned char) wTxDataRate;\r\n}\r\nbyCCKBasicRate = VNTWIFIbyGetACKTxRate(RATE_11M,\r\npSupportRateIEs,\r\npExtSupportRateIEs\r\n);\r\nbyOFDMBasicRate = VNTWIFIbyGetACKTxRate(RATE_54M,\r\npSupportRateIEs,\r\npExtSupportRateIEs\r\n);\r\n*pwTxDataRate = wTxDataRate;\r\n*pbyACKRate = byACKRate;\r\n*pbyCCKBasicRate = byCCKBasicRate;\r\n*pbyOFDMBasicRate = byOFDMBasicRate;\r\nreturn;\r\n}\r\nunsigned char\r\nVNTWIFIbyGetKeyCypher(\r\nvoid *pMgmtHandle,\r\nbool bGroupKey\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject)pMgmtHandle;\r\nif (bGroupKey) {\r\nreturn pMgmt->byCSSGK;\r\n} else {\r\nreturn pMgmt->byCSSPK;\r\n}\r\n}\r\nbool\r\nVNTWIFIbSetPMKIDCache(\r\nvoid *pMgmtObject,\r\nunsigned long ulCount,\r\nvoid *pPMKIDInfo\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject) pMgmtObject;\r\nif (ulCount > MAX_PMKID_CACHE) {\r\nreturn false;\r\n}\r\npMgmt->gsPMKIDCache.BSSIDInfoCount = ulCount;\r\nmemcpy(pMgmt->gsPMKIDCache.BSSIDInfo, pPMKIDInfo, (ulCount*sizeof(PMKIDInfo)));\r\nreturn true;\r\n}\r\nunsigned short\r\nVNTWIFIwGetMaxSupportRate(\r\nvoid *pMgmtObject\r\n)\r\n{\r\nunsigned short wRate = RATE_54M;\r\nPSMgmtObject pMgmt = (PSMgmtObject) pMgmtObject;\r\nfor (wRate = RATE_54M; wRate > RATE_1M; wRate--) {\r\nif (pMgmt->sNodeDBTable[0].wSuppRate & (1<<wRate)) {\r\nreturn wRate;\r\n}\r\n}\r\nif (pMgmt->eCurrentPHYMode == PHY_TYPE_11A) {\r\nreturn RATE_6M;\r\n} else {\r\nreturn RATE_1M;\r\n}\r\n}\r\nvoid\r\nVNTWIFIvSet11h(\r\nvoid *pMgmtObject,\r\nbool b11hEnable\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject) pMgmtObject;\r\npMgmt->b11hEnable = b11hEnable;\r\n}\r\nbool\r\nVNTWIFIbMeasureReport(\r\nvoid *pMgmtObject,\r\nbool bEndOfReport,\r\nvoid *pvMeasureEID,\r\nunsigned char byReportMode,\r\nunsigned char byBasicMap,\r\nunsigned char byCCAFraction,\r\nunsigned char *pbyRPIs\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject) pMgmtObject;\r\nunsigned char *pbyCurrentEID = (unsigned char *)(pMgmt->pCurrMeasureEIDRep);\r\nif ((pvMeasureEID != NULL) &&\r\n(pMgmt->uLengthOfRepEIDs < (WLAN_A3FR_MAXLEN - sizeof(MEASEURE_REP) - sizeof(WLAN_80211HDR_A3) - 3))\r\n) {\r\npMgmt->pCurrMeasureEIDRep->byElementID = WLAN_EID_MEASURE_REP;\r\npMgmt->pCurrMeasureEIDRep->len = 3;\r\npMgmt->pCurrMeasureEIDRep->byToken = ((PWLAN_IE_MEASURE_REQ)pvMeasureEID)->byToken;\r\npMgmt->pCurrMeasureEIDRep->byMode = byReportMode;\r\npMgmt->pCurrMeasureEIDRep->byType = ((PWLAN_IE_MEASURE_REQ) pvMeasureEID)->byType;\r\nswitch (pMgmt->pCurrMeasureEIDRep->byType) {\r\ncase MEASURE_TYPE_BASIC:\r\npMgmt->pCurrMeasureEIDRep->len += sizeof(MEASEURE_REP_BASIC);\r\nmemcpy(&(pMgmt->pCurrMeasureEIDRep->sRep.sBasic),\r\n&(((PWLAN_IE_MEASURE_REQ) pvMeasureEID)->sReq),\r\nsizeof(MEASEURE_REQ));\r\npMgmt->pCurrMeasureEIDRep->sRep.sBasic.byMap = byBasicMap;\r\nbreak;\r\ncase MEASURE_TYPE_CCA:\r\npMgmt->pCurrMeasureEIDRep->len += sizeof(MEASEURE_REP_CCA);\r\nmemcpy(&(pMgmt->pCurrMeasureEIDRep->sRep.sCCA),\r\n&(((PWLAN_IE_MEASURE_REQ) pvMeasureEID)->sReq),\r\nsizeof(MEASEURE_REQ));\r\npMgmt->pCurrMeasureEIDRep->sRep.sCCA.byCCABusyFraction = byCCAFraction;\r\nbreak;\r\ncase MEASURE_TYPE_RPI:\r\npMgmt->pCurrMeasureEIDRep->len += sizeof(MEASEURE_REP_RPI);\r\nmemcpy(&(pMgmt->pCurrMeasureEIDRep->sRep.sRPI),\r\n&(((PWLAN_IE_MEASURE_REQ) pvMeasureEID)->sReq),\r\nsizeof(MEASEURE_REQ));\r\nmemcpy(pMgmt->pCurrMeasureEIDRep->sRep.sRPI.abyRPIdensity, pbyRPIs, 8);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\npbyCurrentEID += (2 + pMgmt->pCurrMeasureEIDRep->len);\r\npMgmt->uLengthOfRepEIDs += (2 + pMgmt->pCurrMeasureEIDRep->len);\r\npMgmt->pCurrMeasureEIDRep = (PWLAN_IE_MEASURE_REP) pbyCurrentEID;\r\n}\r\nif (bEndOfReport) {\r\nIEEE11hbMSRRepTx(pMgmt);\r\n}\r\nreturn true;\r\n}\r\nbool\r\nVNTWIFIbChannelSwitch(\r\nvoid *pMgmtObject,\r\nunsigned char byNewChannel\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject) pMgmtObject;\r\npMgmt->uCurrChannel = byNewChannel;\r\npMgmt->bSwitchChannel = false;\r\nreturn true;\r\n}

void usage()\r\n{\r\nprintf("Usage: tmon [OPTION...]\n");\r\nprintf(" -c, --control cooling device in control\n");\r\nprintf(" -d, --daemon run as daemon, no TUI\n");\r\nprintf(" -g, --debug debug message in syslog\n");\r\nprintf(" -h, --help show this help message\n");\r\nprintf(" -l, --log log data to /var/tmp/tmon.log\n");\r\nprintf(" -t, --time-interval sampling time interval, > 1 sec.\n");\r\nprintf(" -v, --version show version\n");\r\nprintf(" -z, --zone target thermal zone id\n");\r\nexit(0);\r\n}\r\nvoid version()\r\n{\r\nprintf("TMON version %s\n", VERSION);\r\nexit(EXIT_SUCCESS);\r\n}\r\nstatic void tmon_cleanup(void)\r\n{\r\nsyslog(LOG_INFO, "TMON exit cleanup\n");\r\nfflush(stdout);\r\nrefresh();\r\nif (tmon_log)\r\nfclose(tmon_log);\r\nif (event_tid) {\r\npthread_mutex_lock(&input_lock);\r\npthread_cancel(event_tid);\r\npthread_mutex_unlock(&input_lock);\r\npthread_mutex_destroy(&input_lock);\r\n}\r\ncloselog();\r\nset_ctrl_state(0);\r\nkeypad(stdscr, FALSE);\r\necho();\r\nnocbreak();\r\nclose_windows();\r\nendwin();\r\nfree_thermal_data();\r\nexit(1);\r\n}\r\nstatic void tmon_sig_handler(int sig)\r\n{\r\nsyslog(LOG_INFO, "TMON caught signal %d\n", sig);\r\nrefresh();\r\nswitch (sig) {\r\ncase SIGTERM:\r\nprintf("sigterm, exit and clean up\n");\r\nfflush(stdout);\r\nbreak;\r\ncase SIGKILL:\r\nprintf("sigkill, exit and clean up\n");\r\nfflush(stdout);\r\nbreak;\r\ncase SIGINT:\r\nprintf("ctrl-c, exit and clean up\n");\r\nfflush(stdout);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ntmon_exit = true;\r\n}\r\nstatic void start_syslog(void)\r\n{\r\nif (debug_on)\r\nsetlogmask(LOG_UPTO(LOG_DEBUG));\r\nelse\r\nsetlogmask(LOG_UPTO(LOG_ERR));\r\nopenlog("tmon.log", LOG_CONS | LOG_PID | LOG_NDELAY, LOG_LOCAL0);\r\nsyslog(LOG_NOTICE, "TMON started by User %d", getuid());\r\n}\r\nstatic void prepare_logging(void)\r\n{\r\nint i;\r\nif (!logging)\r\nreturn;\r\ntmon_log = fopen(TMON_LOG_FILE, "w+");\r\nif (!tmon_log) {\r\nsyslog(LOG_ERR, "failed to open log file %s\n", TMON_LOG_FILE);\r\nreturn;\r\n}\r\nfprintf(tmon_log, "#----------- THERMAL SYSTEM CONFIG -------------\n");\r\nfor (i = 0; i < ptdata.nr_tz_sensor; i++) {\r\nchar binding_str[33];\r\nint j;\r\nmemset(binding_str, 0, sizeof(binding_str));\r\nfor (j = 0; j < 32; j++)\r\nbinding_str[j] = (ptdata.tzi[i].cdev_binding & 1<<j) ?\r\n'1' : '0';\r\nfprintf(tmon_log, "#thermal zone %s%02d cdevs binding: %32s\n",\r\nptdata.tzi[i].type,\r\nptdata.tzi[i].instance,\r\nbinding_str);\r\nfor (j = 0; j < ptdata.tzi[i].nr_trip_pts; j++) {\r\nfprintf(tmon_log, "#\tTP%02d type:%s, temp:%lu\n", j,\r\ntrip_type_name[ptdata.tzi[i].tp[j].type],\r\nptdata.tzi[i].tp[j].temp);\r\n}\r\n}\r\nfor (i = 0; i < ptdata.nr_cooling_dev; i++)\r\nfprintf(tmon_log, "#cooling devices%02d: %s\n",\r\ni, ptdata.cdi[i].type);\r\nfprintf(tmon_log, "#---------- THERMAL DATA LOG STARTED -----------\n");\r\nfprintf(tmon_log, "Samples TargetTemp ");\r\nfor (i = 0; i < ptdata.nr_tz_sensor; i++) {\r\nfprintf(tmon_log, "%s%d ", ptdata.tzi[i].type,\r\nptdata.tzi[i].instance);\r\n}\r\nfor (i = 0; i < ptdata.nr_cooling_dev; i++)\r\nfprintf(tmon_log, "%s%d ", ptdata.cdi[i].type,\r\nptdata.cdi[i].instance);\r\nfprintf(tmon_log, "\n");\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nint err = 0;\r\nint id2 = 0, c;\r\ndouble yk = 0.0;\r\nint target_tz_index;\r\nif (geteuid() != 0) {\r\nprintf("TMON needs to be run as root\n");\r\nexit(EXIT_FAILURE);\r\n}\r\nwhile ((c = getopt_long(argc, argv, "c:dlht:vgz:", opts, &id2)) != -1) {\r\nswitch (c) {\r\ncase 'c':\r\nno_control = 0;\r\nstrncpy(ctrl_cdev, optarg, CDEV_NAME_SIZE);\r\nbreak;\r\ncase 'd':\r\nstart_daemon_mode();\r\nprintf("Run TMON in daemon mode\n");\r\nbreak;\r\ncase 't':\r\nticktime = strtod(optarg, NULL);\r\nif (ticktime < 1)\r\nticktime = 1;\r\nbreak;\r\ncase 'l':\r\nprintf("Logging data to /var/tmp/tmon.log\n");\r\nlogging = 1;\r\nbreak;\r\ncase 'h':\r\nusage();\r\nbreak;\r\ncase 'v':\r\nversion();\r\nbreak;\r\ncase 'g':\r\ndebug_on = 1;\r\nbreak;\r\ncase 'z':\r\ntarget_thermal_zone = strtod(optarg, NULL);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nif (pthread_mutex_init(&input_lock, NULL) != 0) {\r\nfprintf(stderr, "\n mutex init failed, exit\n");\r\nreturn 1;\r\n}\r\nstart_syslog();\r\nif (signal(SIGINT, tmon_sig_handler) == SIG_ERR)\r\nsyslog(LOG_DEBUG, "Cannot handle SIGINT\n");\r\nif (signal(SIGTERM, tmon_sig_handler) == SIG_ERR)\r\nsyslog(LOG_DEBUG, "Cannot handle SIGINT\n");\r\nif (probe_thermal_sysfs()) {\r\npthread_mutex_destroy(&input_lock);\r\ncloselog();\r\nreturn -1;\r\n}\r\ninitialize_curses();\r\nsetup_windows();\r\nsignal(SIGWINCH, resize_handler);\r\nshow_title_bar();\r\nshow_sensors_w();\r\nshow_cooling_device();\r\nupdate_thermal_data();\r\nshow_data_w();\r\nprepare_logging();\r\ninit_thermal_controller();\r\nnodelay(stdscr, TRUE);\r\nerr = pthread_create(&event_tid, NULL, &handle_tui_events, NULL);\r\nif (err != 0) {\r\nprintf("\ncan't create thread :[%s]", strerror(err));\r\ntmon_cleanup();\r\nexit(EXIT_FAILURE);\r\n}\r\ntarget_tz_index = zone_instance_to_index(target_thermal_zone);\r\nif (target_tz_index < 0) {\r\ntarget_thermal_zone = ptdata.tzi[0].instance;\r\nsyslog(LOG_ERR, "target zone is not found, default to %d\n",\r\ntarget_thermal_zone);\r\n}\r\nwhile (1) {\r\nsleep(ticktime);\r\nshow_title_bar();\r\nshow_sensors_w();\r\nupdate_thermal_data();\r\nif (!dialogue_on) {\r\nshow_data_w();\r\nshow_cooling_device();\r\n}\r\ncur_thermal_record++;\r\ntime_elapsed += ticktime;\r\ncontroller_handler(trec[0].temp[target_tz_index] / 1000,\r\n&yk);\r\ntrec[0].pid_out_pct = yk;\r\nif (!dialogue_on)\r\nshow_control_w();\r\nif (tmon_exit)\r\nbreak;\r\n}\r\ntmon_cleanup();\r\nreturn 0;\r\n}\r\nstatic void start_daemon_mode()\r\n{\r\ndaemon_mode = 1;\r\npid_t sid, pid = fork();\r\nif (pid < 0) {\r\nexit(EXIT_FAILURE);\r\n} else if (pid > 0)\r\nexit(EXIT_SUCCESS);\r\ndisable_tui();\r\numask(0);\r\nsid = setsid();\r\nif (sid < 0)\r\nexit(EXIT_FAILURE);\r\nif ((chdir("/")) < 0)\r\nexit(EXIT_FAILURE);\r\nsleep(10);\r\nclose(STDIN_FILENO);\r\nclose(STDOUT_FILENO);\r\nclose(STDERR_FILENO);\r\n}

static void rtlx_dispatch(void)\r\n{\r\nif (read_c0_cause() & read_c0_status() & C_SW0)\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + MIPS_CPU_RTLX_IRQ);\r\n}\r\nstatic irqreturn_t rtlx_interrupt(int irq, void *dev_id)\r\n{\r\nunsigned int vpeflags;\r\nunsigned long flags;\r\nint i;\r\nlocal_irq_save(flags);\r\nvpeflags = dvpe();\r\nset_c0_status(0x100 << MIPS_CPU_RTLX_IRQ);\r\nirq_enable_hazard();\r\nevpe(vpeflags);\r\nlocal_irq_restore(flags);\r\nfor (i = 0; i < RTLX_CHANNELS; i++) {\r\nwake_up(&channel_wqs[i].lx_queue);\r\nwake_up(&channel_wqs[i].rt_queue);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid _interrupt_sp(void)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\ndvpe();\r\nsettc(1);\r\nwrite_vpe_c0_cause(read_vpe_c0_cause() | C_SW0);\r\nevpe(EVPE_ENABLE);\r\nlocal_irq_restore(flags);\r\n}\r\nint __init rtlx_module_init(void)\r\n{\r\nstruct device *dev;\r\nint i, err;\r\nif (!cpu_has_mipsmt) {\r\npr_warn("VPE loader: not a MIPS MT capable processor\n");\r\nreturn -ENODEV;\r\n}\r\nif (aprp_cpu_index() == 0) {\r\npr_warn("No TCs reserved for AP/SP, not initializing RTLX.\n"\r\n"Pass maxtcs=<n> argument as kernel argument\n");\r\nreturn -ENODEV;\r\n}\r\nmajor = register_chrdev(0, RTLX_MODULE_NAME, &rtlx_fops);\r\nif (major < 0) {\r\npr_err("rtlx_module_init: unable to register device\n");\r\nreturn major;\r\n}\r\nfor (i = 0; i < RTLX_CHANNELS; i++) {\r\ninit_waitqueue_head(&channel_wqs[i].rt_queue);\r\ninit_waitqueue_head(&channel_wqs[i].lx_queue);\r\natomic_set(&channel_wqs[i].in_open, 0);\r\nmutex_init(&channel_wqs[i].mutex);\r\ndev = device_create(mt_class, NULL, MKDEV(major, i), NULL,\r\n"%s%d", RTLX_MODULE_NAME, i);\r\nif (IS_ERR(dev)) {\r\nerr = PTR_ERR(dev);\r\ngoto out_chrdev;\r\n}\r\n}\r\nrtlx_notify.start = rtlx_starting;\r\nrtlx_notify.stop = rtlx_stopping;\r\nvpe_notify(aprp_cpu_index(), &rtlx_notify);\r\nif (cpu_has_vint) {\r\naprp_hook = rtlx_dispatch;\r\n} else {\r\npr_err("APRP RTLX init on non-vectored-interrupt processor\n");\r\nerr = -ENODEV;\r\ngoto out_class;\r\n}\r\nrtlx_irq.dev_id = rtlx;\r\nerr = setup_irq(rtlx_irq_num, &rtlx_irq);\r\nif (err)\r\ngoto out_class;\r\nreturn 0;\r\nout_class:\r\nfor (i = 0; i < RTLX_CHANNELS; i++)\r\ndevice_destroy(mt_class, MKDEV(major, i));\r\nout_chrdev:\r\nunregister_chrdev(major, RTLX_MODULE_NAME);\r\nreturn err;\r\n}\r\nvoid __exit rtlx_module_exit(void)\r\n{\r\nint i;\r\nfor (i = 0; i < RTLX_CHANNELS; i++)\r\ndevice_destroy(mt_class, MKDEV(major, i));\r\nunregister_chrdev(major, RTLX_MODULE_NAME);\r\naprp_hook = NULL;\r\n}

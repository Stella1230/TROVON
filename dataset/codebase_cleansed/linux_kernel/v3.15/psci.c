static void kvm_psci_vcpu_off(struct kvm_vcpu *vcpu)\r\n{\r\nvcpu->arch.pause = true;\r\n}\r\nstatic unsigned long kvm_psci_vcpu_on(struct kvm_vcpu *source_vcpu)\r\n{\r\nstruct kvm *kvm = source_vcpu->kvm;\r\nstruct kvm_vcpu *vcpu = NULL, *tmp;\r\nwait_queue_head_t *wq;\r\nunsigned long cpu_id;\r\nunsigned long mpidr;\r\nphys_addr_t target_pc;\r\nint i;\r\ncpu_id = *vcpu_reg(source_vcpu, 1);\r\nif (vcpu_mode_is_32bit(source_vcpu))\r\ncpu_id &= ~((u32) 0);\r\nkvm_for_each_vcpu(i, tmp, kvm) {\r\nmpidr = kvm_vcpu_get_mpidr(tmp);\r\nif ((mpidr & MPIDR_HWID_BITMASK) == (cpu_id & MPIDR_HWID_BITMASK)) {\r\nvcpu = tmp;\r\nbreak;\r\n}\r\n}\r\nif (!vcpu || !vcpu->arch.pause)\r\nreturn KVM_PSCI_RET_INVAL;\r\ntarget_pc = *vcpu_reg(source_vcpu, 2);\r\nkvm_reset_vcpu(vcpu);\r\nif (vcpu_mode_is_32bit(vcpu) && (target_pc & 1)) {\r\ntarget_pc &= ~((phys_addr_t) 1);\r\nvcpu_set_thumb(vcpu);\r\n}\r\nif (kvm_vcpu_is_be(source_vcpu))\r\nkvm_vcpu_set_be(vcpu);\r\n*vcpu_pc(vcpu) = target_pc;\r\nvcpu->arch.pause = false;\r\nsmp_mb();\r\nwq = kvm_arch_vcpu_wq(vcpu);\r\nwake_up_interruptible(wq);\r\nreturn KVM_PSCI_RET_SUCCESS;\r\n}\r\nbool kvm_psci_call(struct kvm_vcpu *vcpu)\r\n{\r\nunsigned long psci_fn = *vcpu_reg(vcpu, 0) & ~((u32) 0);\r\nunsigned long val;\r\nswitch (psci_fn) {\r\ncase KVM_PSCI_FN_CPU_OFF:\r\nkvm_psci_vcpu_off(vcpu);\r\nval = KVM_PSCI_RET_SUCCESS;\r\nbreak;\r\ncase KVM_PSCI_FN_CPU_ON:\r\nval = kvm_psci_vcpu_on(vcpu);\r\nbreak;\r\ncase KVM_PSCI_FN_CPU_SUSPEND:\r\ncase KVM_PSCI_FN_MIGRATE:\r\nval = KVM_PSCI_RET_NI;\r\nbreak;\r\ndefault:\r\nreturn false;\r\n}\r\n*vcpu_reg(vcpu, 0) = val;\r\nreturn true;\r\n}

static const char *dio_getname(int id)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(names); i++)\r\nif (names[i].id == id)\r\nreturn names[i].name;\r\nreturn unknowndioname;\r\n}\r\nint __init dio_find(int deviceid)\r\n{\r\nint scode, id;\r\nu_char prid, secid, i;\r\nmm_segment_t fs;\r\nfor (scode = 0; scode < DIO_SCMAX; scode++) {\r\nvoid *va;\r\nunsigned long pa;\r\nif (DIO_SCINHOLE(scode))\r\ncontinue;\r\npa = dio_scodetophysaddr(scode);\r\nif (!pa)\r\ncontinue;\r\nif (scode < DIOII_SCBASE)\r\nva = (void *)(pa + DIO_VIRADDRBASE);\r\nelse\r\nva = ioremap(pa, PAGE_SIZE);\r\nfs = get_fs();\r\nset_fs(KERNEL_DS);\r\nif (get_user(i, (unsigned char *)va + DIO_IDOFF)) {\r\nset_fs(fs);\r\nif (scode >= DIOII_SCBASE)\r\niounmap(va);\r\ncontinue;\r\n}\r\nset_fs(fs);\r\nprid = DIO_ID(va);\r\nif (DIO_NEEDSSECID(prid)) {\r\nsecid = DIO_SECID(va);\r\nid = DIO_ENCODE_ID(prid, secid);\r\n} else\r\nid = prid;\r\nif (id == deviceid) {\r\nif (scode >= DIOII_SCBASE)\r\niounmap(va);\r\nreturn scode;\r\n}\r\n}\r\nreturn -1;\r\n}\r\nstatic int __init dio_init(void)\r\n{\r\nint scode;\r\nmm_segment_t fs;\r\nint i;\r\nstruct dio_dev *dev;\r\nint error;\r\nif (!MACH_IS_HP300)\r\nreturn 0;\r\nprintk(KERN_INFO "Scanning for DIO devices...\n");\r\nINIT_LIST_HEAD(&dio_bus.devices);\r\ndev_set_name(&dio_bus.dev, "dio");\r\nerror = device_register(&dio_bus.dev);\r\nif (error) {\r\npr_err("DIO: Error registering dio_bus\n");\r\nreturn error;\r\n}\r\ndio_bus.num_resources = (hp300_model == HP_320 ? 1 : 2);\r\nfor (i = 0; i < dio_bus.num_resources; i++)\r\nrequest_resource(&iomem_resource, &dio_bus.resources[i]);\r\nfor (scode = 0; scode < DIO_SCMAX; ++scode)\r\n{\r\nu_char prid, secid = 0;\r\nu_char *va;\r\nunsigned long pa;\r\nif (DIO_SCINHOLE(scode))\r\ncontinue;\r\npa = dio_scodetophysaddr(scode);\r\nif (!pa)\r\ncontinue;\r\nif (scode < DIOII_SCBASE)\r\nva = (void *)(pa + DIO_VIRADDRBASE);\r\nelse\r\nva = ioremap(pa, PAGE_SIZE);\r\nfs = get_fs();\r\nset_fs(KERNEL_DS);\r\nif (get_user(i, (unsigned char *)va + DIO_IDOFF)) {\r\nset_fs(fs);\r\nif (scode >= DIOII_SCBASE)\r\niounmap(va);\r\ncontinue;\r\n}\r\nset_fs(fs);\r\ndev = kzalloc(sizeof(struct dio_dev), GFP_KERNEL);\r\nif (!dev)\r\nreturn 0;\r\ndev->bus = &dio_bus;\r\ndev->dev.parent = &dio_bus.dev;\r\ndev->dev.bus = &dio_bus_type;\r\ndev->scode = scode;\r\ndev->resource.start = pa;\r\ndev->resource.end = pa + DIO_SIZE(scode, va);\r\ndev_set_name(&dev->dev, "%02x", scode);\r\nprid = DIO_ID(va);\r\nif (DIO_NEEDSSECID(prid)) {\r\nsecid = DIO_SECID(va);\r\ndev->id = DIO_ENCODE_ID(prid, secid);\r\n} else\r\ndev->id = prid;\r\ndev->ipl = DIO_IPL(va);\r\nstrcpy(dev->name,dio_getname(dev->id));\r\nprintk(KERN_INFO "select code %3d: ipl %d: ID %02X", dev->scode, dev->ipl, prid);\r\nif (DIO_NEEDSSECID(prid))\r\nprintk(":%02X", secid);\r\nprintk(": %s\n", dev->name);\r\nif (scode >= DIOII_SCBASE)\r\niounmap(va);\r\nerror = device_register(&dev->dev);\r\nif (error) {\r\npr_err("DIO: Error registering device %s\n",\r\ndev->name);\r\ncontinue;\r\n}\r\nerror = dio_create_sysfs_dev_files(dev);\r\nif (error)\r\ndev_err(&dev->dev, "Error creating sysfs files\n");\r\n}\r\nreturn 0;\r\n}\r\nunsigned long dio_scodetophysaddr(int scode)\r\n{\r\nif (scode >= DIOII_SCBASE) {\r\nreturn (DIOII_BASE + (scode - 132) * DIOII_DEVSIZE);\r\n} else if (scode > DIO_SCMAX || scode < 0)\r\nreturn 0;\r\nelse if (DIO_SCINHOLE(scode))\r\nreturn 0;\r\nreturn (DIO_BASE + scode * DIO_DEVSIZE);\r\n}

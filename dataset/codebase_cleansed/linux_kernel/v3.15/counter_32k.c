static u64 notrace omap_32k_read_sched_clock(void)\r\n{\r\nreturn sync32k_cnt_reg ? __raw_readl(sync32k_cnt_reg) : 0;\r\n}\r\nstatic void omap_read_persistent_clock(struct timespec *ts)\r\n{\r\nunsigned long long nsecs;\r\ncycles_t last_cycles;\r\nunsigned long flags;\r\nspin_lock_irqsave(&read_persistent_clock_lock, flags);\r\nlast_cycles = cycles;\r\ncycles = sync32k_cnt_reg ? __raw_readl(sync32k_cnt_reg) : 0;\r\nnsecs = clocksource_cyc2ns(cycles - last_cycles,\r\npersistent_mult, persistent_shift);\r\ntimespec_add_ns(&persistent_ts, nsecs);\r\n*ts = persistent_ts;\r\nspin_unlock_irqrestore(&read_persistent_clock_lock, flags);\r\n}\r\nint __init omap_init_clocksource_32k(void __iomem *vbase)\r\n{\r\nint ret;\r\nif (__raw_readl(vbase + OMAP2_32KSYNCNT_REV_OFF) &\r\nOMAP2_32KSYNCNT_REV_SCHEME)\r\nsync32k_cnt_reg = vbase + OMAP2_32KSYNCNT_CR_OFF_HIGH;\r\nelse\r\nsync32k_cnt_reg = vbase + OMAP2_32KSYNCNT_CR_OFF_LOW;\r\nclocks_calc_mult_shift(&persistent_mult, &persistent_shift,\r\n32768, NSEC_PER_SEC, 120000);\r\nret = clocksource_mmio_init(sync32k_cnt_reg, "32k_counter", 32768,\r\n250, 32, clocksource_mmio_readl_up);\r\nif (ret) {\r\npr_err("32k_counter: can't register clocksource\n");\r\nreturn ret;\r\n}\r\nsched_clock_register(omap_32k_read_sched_clock, 32, 32768);\r\nregister_persistent_clock(NULL, omap_read_persistent_clock);\r\npr_info("OMAP clocksource: 32k_counter at 32768 Hz\n");\r\nreturn 0;\r\n}

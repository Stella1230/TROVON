static int set_unload_heads_path(char *device)\r\n{\r\nif (strlen(device) <= 5 || strncmp(device, "/dev/", 5) != 0)\r\nreturn -EINVAL;\r\nstrncpy(device_path, device, sizeof(device_path) - 1);\r\nsnprintf(unload_heads_path, sizeof(unload_heads_path) - 1,\r\n"/sys/block/%s/device/unload_heads", device+5);\r\nreturn 0;\r\n}\r\nstatic int valid_disk(void)\r\n{\r\nint fd = open(unload_heads_path, O_RDONLY);\r\nif (fd < 0) {\r\nperror(unload_heads_path);\r\nreturn 0;\r\n}\r\nclose(fd);\r\nreturn 1;\r\n}\r\nstatic void write_int(char *path, int i)\r\n{\r\nchar buf[1024];\r\nint fd = open(path, O_RDWR);\r\nif (fd < 0) {\r\nperror("open");\r\nexit(1);\r\n}\r\nsprintf(buf, "%d", i);\r\nif (write(fd, buf, strlen(buf)) != strlen(buf)) {\r\nperror("write");\r\nexit(1);\r\n}\r\nclose(fd);\r\n}\r\nstatic void set_led(int on)\r\n{\r\nif (noled)\r\nreturn;\r\nwrite_int("/sys/class/leds/hp::hddprotect/brightness", on);\r\n}\r\nstatic void protect(int seconds)\r\n{\r\nconst char *str = (seconds == 0) ? "Unparked" : "Parked";\r\nwrite_int(unload_heads_path, seconds*1000);\r\nsyslog(LOG_INFO, "%s %s disk head\n", str, device_path);\r\n}\r\nstatic int on_ac(void)\r\n{\r\nreturn 1;\r\n}\r\nstatic int lid_open(void)\r\n{\r\nreturn 1;\r\n}\r\nstatic void ignore_me(int signum)\r\n{\r\nprotect(0);\r\nset_led(0);\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nint fd, ret;\r\nstruct stat st;\r\nstruct sched_param param;\r\nif (argc == 1)\r\nret = set_unload_heads_path("/dev/sda");\r\nelse if (argc == 2)\r\nret = set_unload_heads_path(argv[1]);\r\nelse\r\nret = -EINVAL;\r\nif (ret || !valid_disk()) {\r\nfprintf(stderr, "usage: %s <device> (default: /dev/sda)\n",\r\nargv[0]);\r\nexit(1);\r\n}\r\nfd = open("/dev/freefall", O_RDONLY);\r\nif (fd < 0) {\r\nperror("/dev/freefall");\r\nreturn EXIT_FAILURE;\r\n}\r\nif (stat("/sys/class/leds/hp::hddprotect/brightness", &st))\r\nnoled = 1;\r\nif (daemon(0, 0) != 0) {\r\nperror("daemon");\r\nreturn EXIT_FAILURE;\r\n}\r\nopenlog(app_name, LOG_CONS | LOG_PID | LOG_NDELAY, LOG_LOCAL1);\r\nparam.sched_priority = sched_get_priority_max(SCHED_FIFO);\r\nsched_setscheduler(0, SCHED_FIFO, &param);\r\nmlockall(MCL_CURRENT|MCL_FUTURE);\r\nsignal(SIGALRM, ignore_me);\r\nfor (;;) {\r\nunsigned char count;\r\nret = read(fd, &count, sizeof(count));\r\nalarm(0);\r\nif ((ret == -1) && (errno == EINTR)) {\r\ncontinue;\r\n}\r\nif (ret != sizeof(count)) {\r\nperror("read");\r\nbreak;\r\n}\r\nprotect(21);\r\nset_led(1);\r\nif (1 || on_ac() || lid_open())\r\nalarm(2);\r\nelse\r\nalarm(20);\r\n}\r\ncloselog();\r\nclose(fd);\r\nreturn EXIT_SUCCESS;\r\n}

static void s3c2412_print_timing(const char *pfx, struct s3c_iotimings *iot)\r\n{\r\nstruct s3c2412_iobank_timing *bt;\r\nunsigned int bank;\r\nfor (bank = 0; bank < MAX_BANKS; bank++) {\r\nbt = iot->bank[bank].io_2412;\r\nif (!bt)\r\ncontinue;\r\nprintk(KERN_DEBUG "%s: %d: idcy=%d.%d wstrd=%d.%d wstwr=%d,%d"\r\n"wstoen=%d.%d wstwen=%d.%d wstbrd=%d.%d\n", pfx, bank,\r\nprint_ns(bt->idcy),\r\nprint_ns(bt->wstrd),\r\nprint_ns(bt->wstwr),\r\nprint_ns(bt->wstoen),\r\nprint_ns(bt->wstwen),\r\nprint_ns(bt->wstbrd));\r\n}\r\n}\r\nstatic inline unsigned int to_div(unsigned int cyc_tns, unsigned int clk_tns)\r\n{\r\nreturn cyc_tns ? DIV_ROUND_UP(cyc_tns, clk_tns) : 0;\r\n}\r\nstatic unsigned int calc_timing(unsigned int hwtm, unsigned int clk_tns,\r\nunsigned int *err)\r\n{\r\nunsigned int ret = to_div(hwtm, clk_tns);\r\nif (ret > 0xf)\r\n*err = -EINVAL;\r\nreturn ret;\r\n}\r\nstatic int s3c2412_calc_bank(struct s3c_cpufreq_config *cfg,\r\nstruct s3c2412_iobank_timing *bt)\r\n{\r\nunsigned int hclk = cfg->freq.hclk_tns;\r\nint err = 0;\r\nbt->smbidcyr = calc_timing(bt->idcy, hclk, &err);\r\nbt->smbwstrd = calc_timing(bt->wstrd, hclk, &err);\r\nbt->smbwstwr = calc_timing(bt->wstwr, hclk, &err);\r\nbt->smbwstoen = calc_timing(bt->wstoen, hclk, &err);\r\nbt->smbwstwen = calc_timing(bt->wstwen, hclk, &err);\r\nbt->smbwstbrd = calc_timing(bt->wstbrd, hclk, &err);\r\nreturn err;\r\n}\r\nvoid s3c2412_iotiming_debugfs(struct seq_file *seq,\r\nstruct s3c_cpufreq_config *cfg,\r\nunion s3c_iobank *iob)\r\n{\r\nstruct s3c2412_iobank_timing *bt = iob->io_2412;\r\nseq_printf(seq,\r\n"\tRead: idcy=%d.%d wstrd=%d.%d wstwr=%d,%d"\r\n"wstoen=%d.%d wstwen=%d.%d wstbrd=%d.%d\n",\r\nprint_ns(bt->idcy),\r\nprint_ns(bt->wstrd),\r\nprint_ns(bt->wstwr),\r\nprint_ns(bt->wstoen),\r\nprint_ns(bt->wstwen),\r\nprint_ns(bt->wstbrd));\r\n}\r\nint s3c2412_iotiming_calc(struct s3c_cpufreq_config *cfg,\r\nstruct s3c_iotimings *iot)\r\n{\r\nstruct s3c2412_iobank_timing *bt;\r\nint bank;\r\nint ret;\r\nfor (bank = 0; bank < MAX_BANKS; bank++) {\r\nbt = iot->bank[bank].io_2412;\r\nif (!bt)\r\ncontinue;\r\nret = s3c2412_calc_bank(cfg, bt);\r\nif (ret) {\r\nprintk(KERN_ERR "%s: cannot calculate bank %d io\n",\r\n__func__, bank);\r\ngoto err;\r\n}\r\n}\r\nreturn 0;\r\nerr:\r\nreturn ret;\r\n}\r\nvoid s3c2412_iotiming_set(struct s3c_cpufreq_config *cfg,\r\nstruct s3c_iotimings *iot)\r\n{\r\nstruct s3c2412_iobank_timing *bt;\r\nvoid __iomem *regs;\r\nint bank;\r\nfor (bank = 0; bank < MAX_BANKS; bank++) {\r\nbt = iot->bank[bank].io_2412;\r\nif (!bt)\r\ncontinue;\r\nregs = S3C2412_SSMC_BANK(bank);\r\n__raw_writel(bt->smbidcyr, regs + SMBIDCYR);\r\n__raw_writel(bt->smbwstrd, regs + SMBWSTRDR);\r\n__raw_writel(bt->smbwstwr, regs + SMBWSTWRR);\r\n__raw_writel(bt->smbwstoen, regs + SMBWSTOENR);\r\n__raw_writel(bt->smbwstwen, regs + SMBWSTWENR);\r\n__raw_writel(bt->smbwstbrd, regs + SMBWSTBRDR);\r\n}\r\n}\r\nstatic inline unsigned int s3c2412_decode_timing(unsigned int clock, u32 reg)\r\n{\r\nreturn (reg & 0xf) * clock;\r\n}\r\nstatic void s3c2412_iotiming_getbank(struct s3c_cpufreq_config *cfg,\r\nstruct s3c2412_iobank_timing *bt,\r\nunsigned int bank)\r\n{\r\nunsigned long clk = cfg->freq.hclk_tns;\r\nvoid __iomem *regs = S3C2412_SSMC_BANK(bank);\r\nbt->idcy = s3c2412_decode_timing(clk, __raw_readl(regs + SMBIDCYR));\r\nbt->wstrd = s3c2412_decode_timing(clk, __raw_readl(regs + SMBWSTRDR));\r\nbt->wstoen = s3c2412_decode_timing(clk, __raw_readl(regs + SMBWSTOENR));\r\nbt->wstwen = s3c2412_decode_timing(clk, __raw_readl(regs + SMBWSTWENR));\r\nbt->wstbrd = s3c2412_decode_timing(clk, __raw_readl(regs + SMBWSTBRDR));\r\n}\r\nstatic inline bool bank_is_io(unsigned int bank, u32 bankcfg)\r\n{\r\nif (bank < 2)\r\nreturn true;\r\nreturn !(bankcfg & (1 << bank));\r\n}\r\nint s3c2412_iotiming_get(struct s3c_cpufreq_config *cfg,\r\nstruct s3c_iotimings *timings)\r\n{\r\nstruct s3c2412_iobank_timing *bt;\r\nu32 bankcfg = __raw_readl(S3C2412_EBI_BANKCFG);\r\nunsigned int bank;\r\nfor (bank = 0; bank < MAX_BANKS; bank++) {\r\nif (!bank_is_io(bank, bankcfg))\r\ncontinue;\r\nbt = kzalloc(sizeof(struct s3c2412_iobank_timing), GFP_KERNEL);\r\nif (!bt) {\r\nprintk(KERN_ERR "%s: no memory for bank\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\ntimings->bank[bank].io_2412 = bt;\r\ns3c2412_iotiming_getbank(cfg, bt, bank);\r\n}\r\ns3c2412_print_timing("get", timings);\r\nreturn 0;\r\n}\r\nvoid s3c2412_cpufreq_setrefresh(struct s3c_cpufreq_config *cfg)\r\n{\r\nstruct s3c_cpufreq_board *board = cfg->board;\r\nu32 refresh;\r\nWARN_ON(board == NULL);\r\nrefresh = (cfg->freq.hclk / 100) * (board->refresh / 10);\r\nrefresh = DIV_ROUND_UP(refresh, (1000 * 1000));\r\nrefresh &= ((1 << 16) - 1);\r\ns3c_freq_dbg("%s: refresh value %u\n", __func__, (unsigned int)refresh);\r\n__raw_writel(refresh, S3C2412_REFRESH);\r\n}

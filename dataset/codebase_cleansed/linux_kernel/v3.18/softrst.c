static int rockchip_softrst_assert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct rockchip_softrst *softrst = container_of(rcdev,\r\nstruct rockchip_softrst,\r\nrcdev);\r\nint bank = id / softrst->num_per_reg;\r\nint offset = id % softrst->num_per_reg;\r\nif (softrst->flags & ROCKCHIP_SOFTRST_HIWORD_MASK) {\r\nwritel(BIT(offset) | (BIT(offset) << 16),\r\nsoftrst->reg_base + (bank * 4));\r\n} else {\r\nunsigned long flags;\r\nu32 reg;\r\nspin_lock_irqsave(&softrst->lock, flags);\r\nreg = readl(softrst->reg_base + (bank * 4));\r\nwritel(reg | BIT(offset), softrst->reg_base + (bank * 4));\r\nspin_unlock_irqrestore(&softrst->lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic int rockchip_softrst_deassert(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct rockchip_softrst *softrst = container_of(rcdev,\r\nstruct rockchip_softrst,\r\nrcdev);\r\nint bank = id / softrst->num_per_reg;\r\nint offset = id % softrst->num_per_reg;\r\nif (softrst->flags & ROCKCHIP_SOFTRST_HIWORD_MASK) {\r\nwritel((BIT(offset) << 16), softrst->reg_base + (bank * 4));\r\n} else {\r\nunsigned long flags;\r\nu32 reg;\r\nspin_lock_irqsave(&softrst->lock, flags);\r\nreg = readl(softrst->reg_base + (bank * 4));\r\nwritel(reg & ~BIT(offset), softrst->reg_base + (bank * 4));\r\nspin_unlock_irqrestore(&softrst->lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nvoid __init rockchip_register_softrst(struct device_node *np,\r\nunsigned int num_regs,\r\nvoid __iomem *base, u8 flags)\r\n{\r\nstruct rockchip_softrst *softrst;\r\nint ret;\r\nsoftrst = kzalloc(sizeof(*softrst), GFP_KERNEL);\r\nif (!softrst)\r\nreturn;\r\nspin_lock_init(&softrst->lock);\r\nsoftrst->reg_base = base;\r\nsoftrst->flags = flags;\r\nsoftrst->num_regs = num_regs;\r\nsoftrst->num_per_reg = (flags & ROCKCHIP_SOFTRST_HIWORD_MASK) ? 16\r\n: 32;\r\nsoftrst->rcdev.owner = THIS_MODULE;\r\nsoftrst->rcdev.nr_resets = num_regs * softrst->num_per_reg;\r\nsoftrst->rcdev.ops = &rockchip_softrst_ops;\r\nsoftrst->rcdev.of_node = np;\r\nret = reset_controller_register(&softrst->rcdev);\r\nif (ret) {\r\npr_err("%s: could not register reset controller, %d\n",\r\n__func__, ret);\r\nkfree(softrst);\r\n}\r\n}

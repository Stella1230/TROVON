static int snd_atiixp_update_bits(struct atiixp_modem *chip, unsigned int reg,\r\nunsigned int mask, unsigned int value)\r\n{\r\nvoid __iomem *addr = chip->remap_addr + reg;\r\nunsigned int data, old_data;\r\nold_data = data = readl(addr);\r\ndata &= ~mask;\r\ndata |= value;\r\nif (old_data == data)\r\nreturn 0;\r\nwritel(data, addr);\r\nreturn 1;\r\n}\r\nstatic int atiixp_build_dma_packets(struct atiixp_modem *chip,\r\nstruct atiixp_dma *dma,\r\nstruct snd_pcm_substream *substream,\r\nunsigned int periods,\r\nunsigned int period_bytes)\r\n{\r\nunsigned int i;\r\nu32 addr, desc_addr;\r\nunsigned long flags;\r\nif (periods > ATI_MAX_DESCRIPTORS)\r\nreturn -ENOMEM;\r\nif (dma->desc_buf.area == NULL) {\r\nif (snd_dma_alloc_pages(SNDRV_DMA_TYPE_DEV, snd_dma_pci_data(chip->pci),\r\nATI_DESC_LIST_SIZE, &dma->desc_buf) < 0)\r\nreturn -ENOMEM;\r\ndma->period_bytes = dma->periods = 0;\r\n}\r\nif (dma->periods == periods && dma->period_bytes == period_bytes)\r\nreturn 0;\r\nspin_lock_irqsave(&chip->reg_lock, flags);\r\nwritel(0, chip->remap_addr + dma->ops->llp_offset);\r\ndma->ops->enable_dma(chip, 0);\r\ndma->ops->enable_dma(chip, 1);\r\nspin_unlock_irqrestore(&chip->reg_lock, flags);\r\naddr = (u32)substream->runtime->dma_addr;\r\ndesc_addr = (u32)dma->desc_buf.addr;\r\nfor (i = 0; i < periods; i++) {\r\nstruct atiixp_dma_desc *desc;\r\ndesc = &((struct atiixp_dma_desc *)dma->desc_buf.area)[i];\r\ndesc->addr = cpu_to_le32(addr);\r\ndesc->status = 0;\r\ndesc->size = period_bytes >> 2;\r\ndesc_addr += sizeof(struct atiixp_dma_desc);\r\nif (i == periods - 1)\r\ndesc->next = cpu_to_le32((u32)dma->desc_buf.addr);\r\nelse\r\ndesc->next = cpu_to_le32(desc_addr);\r\naddr += period_bytes;\r\n}\r\nwritel((u32)dma->desc_buf.addr | ATI_REG_LINKPTR_EN,\r\nchip->remap_addr + dma->ops->llp_offset);\r\ndma->period_bytes = period_bytes;\r\ndma->periods = periods;\r\nreturn 0;\r\n}\r\nstatic void atiixp_clear_dma_packets(struct atiixp_modem *chip,\r\nstruct atiixp_dma *dma,\r\nstruct snd_pcm_substream *substream)\r\n{\r\nif (dma->desc_buf.area) {\r\nwritel(0, chip->remap_addr + dma->ops->llp_offset);\r\nsnd_dma_free_pages(&dma->desc_buf);\r\ndma->desc_buf.area = NULL;\r\n}\r\n}\r\nstatic int snd_atiixp_acquire_codec(struct atiixp_modem *chip)\r\n{\r\nint timeout = 1000;\r\nwhile (atiixp_read(chip, PHYS_OUT_ADDR) & ATI_REG_PHYS_OUT_ADDR_EN) {\r\nif (! timeout--) {\r\ndev_warn(chip->card->dev, "codec acquire timeout\n");\r\nreturn -EBUSY;\r\n}\r\nudelay(1);\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned short snd_atiixp_codec_read(struct atiixp_modem *chip,\r\nunsigned short codec,\r\nunsigned short reg)\r\n{\r\nunsigned int data;\r\nint timeout;\r\nif (snd_atiixp_acquire_codec(chip) < 0)\r\nreturn 0xffff;\r\ndata = (reg << ATI_REG_PHYS_OUT_ADDR_SHIFT) |\r\nATI_REG_PHYS_OUT_ADDR_EN |\r\nATI_REG_PHYS_OUT_RW |\r\ncodec;\r\natiixp_write(chip, PHYS_OUT_ADDR, data);\r\nif (snd_atiixp_acquire_codec(chip) < 0)\r\nreturn 0xffff;\r\ntimeout = 1000;\r\ndo {\r\ndata = atiixp_read(chip, PHYS_IN_ADDR);\r\nif (data & ATI_REG_PHYS_IN_READ_FLAG)\r\nreturn data >> ATI_REG_PHYS_IN_DATA_SHIFT;\r\nudelay(1);\r\n} while (--timeout);\r\nif (reg < 0x7c)\r\ndev_warn(chip->card->dev, "codec read timeout (reg %x)\n", reg);\r\nreturn 0xffff;\r\n}\r\nstatic void snd_atiixp_codec_write(struct atiixp_modem *chip,\r\nunsigned short codec,\r\nunsigned short reg, unsigned short val)\r\n{\r\nunsigned int data;\r\nif (snd_atiixp_acquire_codec(chip) < 0)\r\nreturn;\r\ndata = ((unsigned int)val << ATI_REG_PHYS_OUT_DATA_SHIFT) |\r\n((unsigned int)reg << ATI_REG_PHYS_OUT_ADDR_SHIFT) |\r\nATI_REG_PHYS_OUT_ADDR_EN | codec;\r\natiixp_write(chip, PHYS_OUT_ADDR, data);\r\n}\r\nstatic unsigned short snd_atiixp_ac97_read(struct snd_ac97 *ac97,\r\nunsigned short reg)\r\n{\r\nstruct atiixp_modem *chip = ac97->private_data;\r\nreturn snd_atiixp_codec_read(chip, ac97->num, reg);\r\n}\r\nstatic void snd_atiixp_ac97_write(struct snd_ac97 *ac97, unsigned short reg,\r\nunsigned short val)\r\n{\r\nstruct atiixp_modem *chip = ac97->private_data;\r\nif (reg == AC97_GPIO_STATUS) {\r\natiixp_write(chip, MODEM_OUT_GPIO,\r\n(val << ATI_REG_MODEM_OUT_GPIO_DATA_SHIFT) | ATI_REG_MODEM_OUT_GPIO_EN);\r\nreturn;\r\n}\r\nsnd_atiixp_codec_write(chip, ac97->num, reg, val);\r\n}\r\nstatic int snd_atiixp_aclink_reset(struct atiixp_modem *chip)\r\n{\r\nint timeout;\r\nif (atiixp_update(chip, CMD, ATI_REG_CMD_POWERDOWN, 0))\r\nudelay(10);\r\natiixp_update(chip, CMD, ATI_REG_CMD_AC_SOFT_RESET, ATI_REG_CMD_AC_SOFT_RESET);\r\natiixp_read(chip, CMD);\r\nudelay(10);\r\natiixp_update(chip, CMD, ATI_REG_CMD_AC_SOFT_RESET, 0);\r\ntimeout = 10;\r\nwhile (! (atiixp_read(chip, CMD) & ATI_REG_CMD_ACLINK_ACTIVE)) {\r\natiixp_update(chip, CMD, ATI_REG_CMD_AC_SYNC|ATI_REG_CMD_AC_RESET,\r\nATI_REG_CMD_AC_SYNC);\r\natiixp_read(chip, CMD);\r\nmsleep(1);\r\natiixp_update(chip, CMD, ATI_REG_CMD_AC_RESET, ATI_REG_CMD_AC_RESET);\r\nif (!--timeout) {\r\ndev_err(chip->card->dev, "codec reset timeout\n");\r\nbreak;\r\n}\r\n}\r\natiixp_update(chip, CMD, ATI_REG_CMD_AC_SYNC|ATI_REG_CMD_AC_RESET,\r\nATI_REG_CMD_AC_SYNC|ATI_REG_CMD_AC_RESET);\r\nreturn 0;\r\n}\r\nstatic int snd_atiixp_aclink_down(struct atiixp_modem *chip)\r\n{\r\natiixp_update(chip, CMD,\r\nATI_REG_CMD_POWERDOWN | ATI_REG_CMD_AC_RESET,\r\nATI_REG_CMD_POWERDOWN);\r\nreturn 0;\r\n}\r\nstatic int snd_atiixp_codec_detect(struct atiixp_modem *chip)\r\n{\r\nint timeout;\r\nchip->codec_not_ready_bits = 0;\r\natiixp_write(chip, IER, CODEC_CHECK_BITS);\r\ntimeout = 50;\r\nwhile (timeout-- > 0) {\r\nmsleep(1);\r\nif (chip->codec_not_ready_bits)\r\nbreak;\r\n}\r\natiixp_write(chip, IER, 0);\r\nif ((chip->codec_not_ready_bits & ALL_CODEC_NOT_READY) == ALL_CODEC_NOT_READY) {\r\ndev_err(chip->card->dev, "no codec detected!\n");\r\nreturn -ENXIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_atiixp_chip_start(struct atiixp_modem *chip)\r\n{\r\nunsigned int reg;\r\nreg = atiixp_read(chip, CMD);\r\nreg |= ATI_REG_CMD_BURST_EN;\r\nif(!(reg & ATI_REG_CMD_MODEM_PRESENT))\r\nreg |= ATI_REG_CMD_MODEM_PRESENT;\r\natiixp_write(chip, CMD, reg);\r\natiixp_write(chip, ISR, 0xffffffff);\r\natiixp_write(chip, IER,\r\nATI_REG_IER_MODEM_STATUS_EN |\r\nATI_REG_IER_MODEM_IN_XRUN_EN |\r\nATI_REG_IER_MODEM_OUT1_XRUN_EN);\r\nreturn 0;\r\n}\r\nstatic int snd_atiixp_chip_stop(struct atiixp_modem *chip)\r\n{\r\natiixp_write(chip, ISR, atiixp_read(chip, ISR));\r\natiixp_write(chip, IER, 0);\r\nreturn 0;\r\n}\r\nstatic snd_pcm_uframes_t snd_atiixp_pcm_pointer(struct snd_pcm_substream *substream)\r\n{\r\nstruct atiixp_modem *chip = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct atiixp_dma *dma = runtime->private_data;\r\nunsigned int curptr;\r\nint timeout = 1000;\r\nwhile (timeout--) {\r\ncurptr = readl(chip->remap_addr + dma->ops->dt_cur);\r\nif (curptr < dma->buf_addr)\r\ncontinue;\r\ncurptr -= dma->buf_addr;\r\nif (curptr >= dma->buf_bytes)\r\ncontinue;\r\nreturn bytes_to_frames(runtime, curptr);\r\n}\r\ndev_dbg(chip->card->dev, "invalid DMA pointer read 0x%x (buf=%x)\n",\r\nreadl(chip->remap_addr + dma->ops->dt_cur), dma->buf_addr);\r\nreturn 0;\r\n}\r\nstatic void snd_atiixp_xrun_dma(struct atiixp_modem *chip,\r\nstruct atiixp_dma *dma)\r\n{\r\nif (! dma->substream || ! dma->running)\r\nreturn;\r\ndev_dbg(chip->card->dev, "XRUN detected (DMA %d)\n", dma->ops->type);\r\nsnd_pcm_stream_lock(dma->substream);\r\nsnd_pcm_stop(dma->substream, SNDRV_PCM_STATE_XRUN);\r\nsnd_pcm_stream_unlock(dma->substream);\r\n}\r\nstatic void snd_atiixp_update_dma(struct atiixp_modem *chip,\r\nstruct atiixp_dma *dma)\r\n{\r\nif (! dma->substream || ! dma->running)\r\nreturn;\r\nsnd_pcm_period_elapsed(dma->substream);\r\n}\r\nstatic void snd_atiixp_check_bus_busy(struct atiixp_modem *chip)\r\n{\r\nunsigned int bus_busy;\r\nif (atiixp_read(chip, CMD) & (ATI_REG_CMD_MODEM_SEND1_EN |\r\nATI_REG_CMD_MODEM_RECEIVE_EN))\r\nbus_busy = ATI_REG_IER_MODEM_SET_BUS_BUSY;\r\nelse\r\nbus_busy = 0;\r\natiixp_update(chip, IER, ATI_REG_IER_MODEM_SET_BUS_BUSY, bus_busy);\r\n}\r\nstatic int snd_atiixp_pcm_trigger(struct snd_pcm_substream *substream, int cmd)\r\n{\r\nstruct atiixp_modem *chip = snd_pcm_substream_chip(substream);\r\nstruct atiixp_dma *dma = substream->runtime->private_data;\r\nint err = 0;\r\nif (snd_BUG_ON(!dma->ops->enable_transfer ||\r\n!dma->ops->flush_dma))\r\nreturn -EINVAL;\r\nspin_lock(&chip->reg_lock);\r\nswitch(cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ndma->ops->enable_transfer(chip, 1);\r\ndma->running = 1;\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ndma->ops->enable_transfer(chip, 0);\r\ndma->running = 0;\r\nbreak;\r\ndefault:\r\nerr = -EINVAL;\r\nbreak;\r\n}\r\nif (! err) {\r\nsnd_atiixp_check_bus_busy(chip);\r\nif (cmd == SNDRV_PCM_TRIGGER_STOP) {\r\ndma->ops->flush_dma(chip);\r\nsnd_atiixp_check_bus_busy(chip);\r\n}\r\n}\r\nspin_unlock(&chip->reg_lock);\r\nreturn err;\r\n}\r\nstatic void atiixp_out_flush_dma(struct atiixp_modem *chip)\r\n{\r\natiixp_write(chip, MODEM_FIFO_FLUSH, ATI_REG_MODEM_FIFO_OUT1_FLUSH);\r\n}\r\nstatic void atiixp_out_enable_dma(struct atiixp_modem *chip, int on)\r\n{\r\nunsigned int data;\r\ndata = atiixp_read(chip, CMD);\r\nif (on) {\r\nif (data & ATI_REG_CMD_MODEM_OUT_DMA1_EN)\r\nreturn;\r\natiixp_out_flush_dma(chip);\r\ndata |= ATI_REG_CMD_MODEM_OUT_DMA1_EN;\r\n} else\r\ndata &= ~ATI_REG_CMD_MODEM_OUT_DMA1_EN;\r\natiixp_write(chip, CMD, data);\r\n}\r\nstatic void atiixp_out_enable_transfer(struct atiixp_modem *chip, int on)\r\n{\r\natiixp_update(chip, CMD, ATI_REG_CMD_MODEM_SEND1_EN,\r\non ? ATI_REG_CMD_MODEM_SEND1_EN : 0);\r\n}\r\nstatic void atiixp_in_enable_dma(struct atiixp_modem *chip, int on)\r\n{\r\natiixp_update(chip, CMD, ATI_REG_CMD_MODEM_IN_DMA_EN,\r\non ? ATI_REG_CMD_MODEM_IN_DMA_EN : 0);\r\n}\r\nstatic void atiixp_in_enable_transfer(struct atiixp_modem *chip, int on)\r\n{\r\nif (on) {\r\nunsigned int data = atiixp_read(chip, CMD);\r\nif (! (data & ATI_REG_CMD_MODEM_RECEIVE_EN)) {\r\ndata |= ATI_REG_CMD_MODEM_RECEIVE_EN;\r\natiixp_write(chip, CMD, data);\r\n}\r\n} else\r\natiixp_update(chip, CMD, ATI_REG_CMD_MODEM_RECEIVE_EN, 0);\r\n}\r\nstatic void atiixp_in_flush_dma(struct atiixp_modem *chip)\r\n{\r\natiixp_write(chip, MODEM_FIFO_FLUSH, ATI_REG_MODEM_FIFO_IN_FLUSH);\r\n}\r\nstatic int snd_atiixp_playback_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct atiixp_modem *chip = snd_pcm_substream_chip(substream);\r\nunsigned int data;\r\nspin_lock_irq(&chip->reg_lock);\r\ndata = atiixp_read(chip, MODEM_OUT_FIFO);\r\ndata &= ~ATI_REG_MODEM_OUT1_DMA_THRESHOLD_MASK;\r\ndata |= 0x04 << ATI_REG_MODEM_OUT1_DMA_THRESHOLD_SHIFT;\r\natiixp_write(chip, MODEM_OUT_FIFO, data);\r\nspin_unlock_irq(&chip->reg_lock);\r\nreturn 0;\r\n}\r\nstatic int snd_atiixp_capture_prepare(struct snd_pcm_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int snd_atiixp_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *hw_params)\r\n{\r\nstruct atiixp_modem *chip = snd_pcm_substream_chip(substream);\r\nstruct atiixp_dma *dma = substream->runtime->private_data;\r\nint err;\r\nint i;\r\nerr = snd_pcm_lib_malloc_pages(substream, params_buffer_bytes(hw_params));\r\nif (err < 0)\r\nreturn err;\r\ndma->buf_addr = substream->runtime->dma_addr;\r\ndma->buf_bytes = params_buffer_bytes(hw_params);\r\nerr = atiixp_build_dma_packets(chip, dma, substream,\r\nparams_periods(hw_params),\r\nparams_period_bytes(hw_params));\r\nif (err < 0)\r\nreturn err;\r\nfor (i = 0; i < NUM_ATI_CODECS; i++) {\r\nif (! chip->ac97[i])\r\ncontinue;\r\nsnd_ac97_write(chip->ac97[i], AC97_LINE1_RATE, params_rate(hw_params));\r\nsnd_ac97_write(chip->ac97[i], AC97_LINE1_LEVEL, 0);\r\n}\r\nreturn err;\r\n}\r\nstatic int snd_atiixp_pcm_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct atiixp_modem *chip = snd_pcm_substream_chip(substream);\r\nstruct atiixp_dma *dma = substream->runtime->private_data;\r\natiixp_clear_dma_packets(chip, dma, substream);\r\nsnd_pcm_lib_free_pages(substream);\r\nreturn 0;\r\n}\r\nstatic int snd_atiixp_pcm_open(struct snd_pcm_substream *substream,\r\nstruct atiixp_dma *dma, int pcm_type)\r\n{\r\nstruct atiixp_modem *chip = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nint err;\r\nstatic unsigned int rates[] = { 8000, 9600, 12000, 16000 };\r\nstatic struct snd_pcm_hw_constraint_list hw_constraints_rates = {\r\n.count = ARRAY_SIZE(rates),\r\n.list = rates,\r\n.mask = 0,\r\n};\r\nif (snd_BUG_ON(!dma->ops || !dma->ops->enable_dma))\r\nreturn -EINVAL;\r\nif (dma->opened)\r\nreturn -EBUSY;\r\ndma->substream = substream;\r\nruntime->hw = snd_atiixp_pcm_hw;\r\ndma->ac97_pcm_type = pcm_type;\r\nif ((err = snd_pcm_hw_constraint_list(runtime, 0,\r\nSNDRV_PCM_HW_PARAM_RATE,\r\n&hw_constraints_rates)) < 0)\r\nreturn err;\r\nif ((err = snd_pcm_hw_constraint_integer(runtime,\r\nSNDRV_PCM_HW_PARAM_PERIODS)) < 0)\r\nreturn err;\r\nruntime->private_data = dma;\r\nspin_lock_irq(&chip->reg_lock);\r\ndma->ops->enable_dma(chip, 1);\r\nspin_unlock_irq(&chip->reg_lock);\r\ndma->opened = 1;\r\nreturn 0;\r\n}\r\nstatic int snd_atiixp_pcm_close(struct snd_pcm_substream *substream,\r\nstruct atiixp_dma *dma)\r\n{\r\nstruct atiixp_modem *chip = snd_pcm_substream_chip(substream);\r\nif (snd_BUG_ON(!dma->ops || !dma->ops->enable_dma))\r\nreturn -EINVAL;\r\nspin_lock_irq(&chip->reg_lock);\r\ndma->ops->enable_dma(chip, 0);\r\nspin_unlock_irq(&chip->reg_lock);\r\ndma->substream = NULL;\r\ndma->opened = 0;\r\nreturn 0;\r\n}\r\nstatic int snd_atiixp_playback_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct atiixp_modem *chip = snd_pcm_substream_chip(substream);\r\nint err;\r\nmutex_lock(&chip->open_mutex);\r\nerr = snd_atiixp_pcm_open(substream, &chip->dmas[ATI_DMA_PLAYBACK], 0);\r\nmutex_unlock(&chip->open_mutex);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int snd_atiixp_playback_close(struct snd_pcm_substream *substream)\r\n{\r\nstruct atiixp_modem *chip = snd_pcm_substream_chip(substream);\r\nint err;\r\nmutex_lock(&chip->open_mutex);\r\nerr = snd_atiixp_pcm_close(substream, &chip->dmas[ATI_DMA_PLAYBACK]);\r\nmutex_unlock(&chip->open_mutex);\r\nreturn err;\r\n}\r\nstatic int snd_atiixp_capture_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct atiixp_modem *chip = snd_pcm_substream_chip(substream);\r\nreturn snd_atiixp_pcm_open(substream, &chip->dmas[ATI_DMA_CAPTURE], 1);\r\n}\r\nstatic int snd_atiixp_capture_close(struct snd_pcm_substream *substream)\r\n{\r\nstruct atiixp_modem *chip = snd_pcm_substream_chip(substream);\r\nreturn snd_atiixp_pcm_close(substream, &chip->dmas[ATI_DMA_CAPTURE]);\r\n}\r\nstatic int snd_atiixp_pcm_new(struct atiixp_modem *chip)\r\n{\r\nstruct snd_pcm *pcm;\r\nint err;\r\nchip->dmas[ATI_DMA_PLAYBACK].ops = &snd_atiixp_playback_dma_ops;\r\nchip->dmas[ATI_DMA_CAPTURE].ops = &snd_atiixp_capture_dma_ops;\r\nerr = snd_pcm_new(chip->card, "ATI IXP MC97", ATI_PCMDEV_ANALOG, 1, 1, &pcm);\r\nif (err < 0)\r\nreturn err;\r\nsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_PLAYBACK, &snd_atiixp_playback_ops);\r\nsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_CAPTURE, &snd_atiixp_capture_ops);\r\npcm->dev_class = SNDRV_PCM_CLASS_MODEM;\r\npcm->private_data = chip;\r\nstrcpy(pcm->name, "ATI IXP MC97");\r\nchip->pcmdevs[ATI_PCMDEV_ANALOG] = pcm;\r\nsnd_pcm_lib_preallocate_pages_for_all(pcm, SNDRV_DMA_TYPE_DEV,\r\nsnd_dma_pci_data(chip->pci),\r\n64*1024, 128*1024);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t snd_atiixp_interrupt(int irq, void *dev_id)\r\n{\r\nstruct atiixp_modem *chip = dev_id;\r\nunsigned int status;\r\nstatus = atiixp_read(chip, ISR);\r\nif (! status)\r\nreturn IRQ_NONE;\r\nif (status & ATI_REG_ISR_MODEM_OUT1_XRUN)\r\nsnd_atiixp_xrun_dma(chip, &chip->dmas[ATI_DMA_PLAYBACK]);\r\nelse if (status & ATI_REG_ISR_MODEM_OUT1_STATUS)\r\nsnd_atiixp_update_dma(chip, &chip->dmas[ATI_DMA_PLAYBACK]);\r\nif (status & ATI_REG_ISR_MODEM_IN_XRUN)\r\nsnd_atiixp_xrun_dma(chip, &chip->dmas[ATI_DMA_CAPTURE]);\r\nelse if (status & ATI_REG_ISR_MODEM_IN_STATUS)\r\nsnd_atiixp_update_dma(chip, &chip->dmas[ATI_DMA_CAPTURE]);\r\nif (status & CODEC_CHECK_BITS) {\r\nunsigned int detected;\r\ndetected = status & CODEC_CHECK_BITS;\r\nspin_lock(&chip->reg_lock);\r\nchip->codec_not_ready_bits |= detected;\r\natiixp_update(chip, IER, detected, 0);\r\nspin_unlock(&chip->reg_lock);\r\n}\r\natiixp_write(chip, ISR, status);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int snd_atiixp_mixer_new(struct atiixp_modem *chip, int clock)\r\n{\r\nstruct snd_ac97_bus *pbus;\r\nstruct snd_ac97_template ac97;\r\nint i, err;\r\nint codec_count;\r\nstatic struct snd_ac97_bus_ops ops = {\r\n.write = snd_atiixp_ac97_write,\r\n.read = snd_atiixp_ac97_read,\r\n};\r\nstatic unsigned int codec_skip[NUM_ATI_CODECS] = {\r\nATI_REG_ISR_CODEC0_NOT_READY,\r\nATI_REG_ISR_CODEC1_NOT_READY,\r\nATI_REG_ISR_CODEC2_NOT_READY,\r\n};\r\nif (snd_atiixp_codec_detect(chip) < 0)\r\nreturn -ENXIO;\r\nif ((err = snd_ac97_bus(chip->card, 0, &ops, chip, &pbus)) < 0)\r\nreturn err;\r\npbus->clock = clock;\r\nchip->ac97_bus = pbus;\r\ncodec_count = 0;\r\nfor (i = 0; i < NUM_ATI_CODECS; i++) {\r\nif (chip->codec_not_ready_bits & codec_skip[i])\r\ncontinue;\r\nmemset(&ac97, 0, sizeof(ac97));\r\nac97.private_data = chip;\r\nac97.pci = chip->pci;\r\nac97.num = i;\r\nac97.scaps = AC97_SCAP_SKIP_AUDIO | AC97_SCAP_POWER_SAVE;\r\nif ((err = snd_ac97_mixer(pbus, &ac97, &chip->ac97[i])) < 0) {\r\nchip->ac97[i] = NULL;\r\ndev_dbg(chip->card->dev,\r\n"codec %d not available for modem\n", i);\r\ncontinue;\r\n}\r\ncodec_count++;\r\n}\r\nif (! codec_count) {\r\ndev_err(chip->card->dev, "no codec available\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_atiixp_suspend(struct device *dev)\r\n{\r\nstruct pci_dev *pci = to_pci_dev(dev);\r\nstruct snd_card *card = dev_get_drvdata(dev);\r\nstruct atiixp_modem *chip = card->private_data;\r\nint i;\r\nsnd_power_change_state(card, SNDRV_CTL_POWER_D3hot);\r\nfor (i = 0; i < NUM_ATI_PCMDEVS; i++)\r\nsnd_pcm_suspend_all(chip->pcmdevs[i]);\r\nfor (i = 0; i < NUM_ATI_CODECS; i++)\r\nsnd_ac97_suspend(chip->ac97[i]);\r\nsnd_atiixp_aclink_down(chip);\r\nsnd_atiixp_chip_stop(chip);\r\npci_disable_device(pci);\r\npci_save_state(pci);\r\npci_set_power_state(pci, PCI_D3hot);\r\nreturn 0;\r\n}\r\nstatic int snd_atiixp_resume(struct device *dev)\r\n{\r\nstruct pci_dev *pci = to_pci_dev(dev);\r\nstruct snd_card *card = dev_get_drvdata(dev);\r\nstruct atiixp_modem *chip = card->private_data;\r\nint i;\r\npci_set_power_state(pci, PCI_D0);\r\npci_restore_state(pci);\r\nif (pci_enable_device(pci) < 0) {\r\ndev_err(dev, "pci_enable_device failed, disabling device\n");\r\nsnd_card_disconnect(card);\r\nreturn -EIO;\r\n}\r\npci_set_master(pci);\r\nsnd_atiixp_aclink_reset(chip);\r\nsnd_atiixp_chip_start(chip);\r\nfor (i = 0; i < NUM_ATI_CODECS; i++)\r\nsnd_ac97_resume(chip->ac97[i]);\r\nsnd_power_change_state(card, SNDRV_CTL_POWER_D0);\r\nreturn 0;\r\n}\r\nstatic void snd_atiixp_proc_read(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct atiixp_modem *chip = entry->private_data;\r\nint i;\r\nfor (i = 0; i < 256; i += 4)\r\nsnd_iprintf(buffer, "%02x: %08x\n", i, readl(chip->remap_addr + i));\r\n}\r\nstatic void snd_atiixp_proc_init(struct atiixp_modem *chip)\r\n{\r\nstruct snd_info_entry *entry;\r\nif (! snd_card_proc_new(chip->card, "atiixp-modem", &entry))\r\nsnd_info_set_text_ops(entry, chip, snd_atiixp_proc_read);\r\n}\r\nstatic int snd_atiixp_free(struct atiixp_modem *chip)\r\n{\r\nif (chip->irq < 0)\r\ngoto __hw_end;\r\nsnd_atiixp_chip_stop(chip);\r\n__hw_end:\r\nif (chip->irq >= 0)\r\nfree_irq(chip->irq, chip);\r\nif (chip->remap_addr)\r\niounmap(chip->remap_addr);\r\npci_release_regions(chip->pci);\r\npci_disable_device(chip->pci);\r\nkfree(chip);\r\nreturn 0;\r\n}\r\nstatic int snd_atiixp_dev_free(struct snd_device *device)\r\n{\r\nstruct atiixp_modem *chip = device->device_data;\r\nreturn snd_atiixp_free(chip);\r\n}\r\nstatic int snd_atiixp_create(struct snd_card *card,\r\nstruct pci_dev *pci,\r\nstruct atiixp_modem **r_chip)\r\n{\r\nstatic struct snd_device_ops ops = {\r\n.dev_free = snd_atiixp_dev_free,\r\n};\r\nstruct atiixp_modem *chip;\r\nint err;\r\nif ((err = pci_enable_device(pci)) < 0)\r\nreturn err;\r\nchip = kzalloc(sizeof(*chip), GFP_KERNEL);\r\nif (chip == NULL) {\r\npci_disable_device(pci);\r\nreturn -ENOMEM;\r\n}\r\nspin_lock_init(&chip->reg_lock);\r\nmutex_init(&chip->open_mutex);\r\nchip->card = card;\r\nchip->pci = pci;\r\nchip->irq = -1;\r\nif ((err = pci_request_regions(pci, "ATI IXP MC97")) < 0) {\r\nkfree(chip);\r\npci_disable_device(pci);\r\nreturn err;\r\n}\r\nchip->addr = pci_resource_start(pci, 0);\r\nchip->remap_addr = pci_ioremap_bar(pci, 0);\r\nif (chip->remap_addr == NULL) {\r\ndev_err(card->dev, "AC'97 space ioremap problem\n");\r\nsnd_atiixp_free(chip);\r\nreturn -EIO;\r\n}\r\nif (request_irq(pci->irq, snd_atiixp_interrupt, IRQF_SHARED,\r\nKBUILD_MODNAME, chip)) {\r\ndev_err(card->dev, "unable to grab IRQ %d\n", pci->irq);\r\nsnd_atiixp_free(chip);\r\nreturn -EBUSY;\r\n}\r\nchip->irq = pci->irq;\r\npci_set_master(pci);\r\nsynchronize_irq(chip->irq);\r\nif ((err = snd_device_new(card, SNDRV_DEV_LOWLEVEL, chip, &ops)) < 0) {\r\nsnd_atiixp_free(chip);\r\nreturn err;\r\n}\r\n*r_chip = chip;\r\nreturn 0;\r\n}\r\nstatic int snd_atiixp_probe(struct pci_dev *pci,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nstruct snd_card *card;\r\nstruct atiixp_modem *chip;\r\nint err;\r\nerr = snd_card_new(&pci->dev, index, id, THIS_MODULE, 0, &card);\r\nif (err < 0)\r\nreturn err;\r\nstrcpy(card->driver, "ATIIXP-MODEM");\r\nstrcpy(card->shortname, "ATI IXP Modem");\r\nif ((err = snd_atiixp_create(card, pci, &chip)) < 0)\r\ngoto __error;\r\ncard->private_data = chip;\r\nif ((err = snd_atiixp_aclink_reset(chip)) < 0)\r\ngoto __error;\r\nif ((err = snd_atiixp_mixer_new(chip, ac97_clock)) < 0)\r\ngoto __error;\r\nif ((err = snd_atiixp_pcm_new(chip)) < 0)\r\ngoto __error;\r\nsnd_atiixp_proc_init(chip);\r\nsnd_atiixp_chip_start(chip);\r\nsprintf(card->longname, "%s rev %x at 0x%lx, irq %i",\r\ncard->shortname, pci->revision, chip->addr, chip->irq);\r\nif ((err = snd_card_register(card)) < 0)\r\ngoto __error;\r\npci_set_drvdata(pci, card);\r\nreturn 0;\r\n__error:\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nstatic void snd_atiixp_remove(struct pci_dev *pci)\r\n{\r\nsnd_card_free(pci_get_drvdata(pci));\r\n}

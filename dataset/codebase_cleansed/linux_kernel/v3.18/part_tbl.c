int hfs_part_find(struct super_block *sb,\r\nsector_t *part_start, sector_t *part_size)\r\n{\r\nstruct buffer_head *bh;\r\n__be16 *data;\r\nint i, size, res;\r\nres = -ENOENT;\r\nbh = sb_bread512(sb, *part_start + HFS_PMAP_BLK, data);\r\nif (!bh)\r\nreturn -EIO;\r\nswitch (be16_to_cpu(*data)) {\r\ncase HFS_OLD_PMAP_MAGIC:\r\n{\r\nstruct old_pmap *pm;\r\nstruct old_pmap_entry *p;\r\npm = (struct old_pmap *)bh->b_data;\r\np = pm->pdEntry;\r\nsize = 42;\r\nfor (i = 0; i < size; p++, i++) {\r\nif (p->pdStart && p->pdSize &&\r\np->pdFSID == cpu_to_be32(0x54465331) &&\r\n(HFS_SB(sb)->part < 0 || HFS_SB(sb)->part == i)) {\r\n*part_start += be32_to_cpu(p->pdStart);\r\n*part_size = be32_to_cpu(p->pdSize);\r\nres = 0;\r\n}\r\n}\r\nbreak;\r\n}\r\ncase HFS_NEW_PMAP_MAGIC:\r\n{\r\nstruct new_pmap *pm;\r\npm = (struct new_pmap *)bh->b_data;\r\nsize = be32_to_cpu(pm->pmMapBlkCnt);\r\nfor (i = 0; i < size;) {\r\nif (!memcmp(pm->pmPartType,"Apple_HFS", 9) &&\r\n(HFS_SB(sb)->part < 0 || HFS_SB(sb)->part == i)) {\r\n*part_start += be32_to_cpu(pm->pmPyPartStart);\r\n*part_size = be32_to_cpu(pm->pmPartBlkCnt);\r\nres = 0;\r\nbreak;\r\n}\r\nbrelse(bh);\r\nbh = sb_bread512(sb, *part_start + HFS_PMAP_BLK + ++i, pm);\r\nif (!bh)\r\nreturn -EIO;\r\nif (pm->pmSig != cpu_to_be16(HFS_NEW_PMAP_MAGIC))\r\nbreak;\r\n}\r\nbreak;\r\n}\r\n}\r\nbrelse(bh);\r\nreturn res;\r\n}

static pci_ers_result_t adf_error_detected(struct pci_dev *pdev,\r\npci_channel_state_t state)\r\n{\r\nstruct adf_accel_dev *accel_dev = adf_devmgr_pci_to_accel_dev(pdev);\r\npr_info("QAT: Acceleration driver hardware error detected.\n");\r\nif (!accel_dev) {\r\npr_err("QAT: Can't find acceleration device\n");\r\nreturn PCI_ERS_RESULT_DISCONNECT;\r\n}\r\nif (state == pci_channel_io_perm_failure) {\r\npr_err("QAT: Can't recover from device error\n");\r\nreturn PCI_ERS_RESULT_DISCONNECT;\r\n}\r\nreturn PCI_ERS_RESULT_NEED_RESET;\r\n}\r\nstatic void adf_dev_restore(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct pci_dev *pdev = accel_to_pci_dev(accel_dev);\r\nstruct pci_dev *parent = pdev->bus->self;\r\nuint16_t ppdstat = 0, bridge_ctl = 0;\r\nint pending = 0;\r\npr_info("QAT: Reseting device qat_dev%d\n", accel_dev->accel_id);\r\npci_read_config_word(pdev, PPDSTAT_OFFSET, &ppdstat);\r\npending = ppdstat & PCI_EXP_DEVSTA_TRPND;\r\nif (pending) {\r\nint ctr = 0;\r\ndo {\r\nmsleep(100);\r\npci_read_config_word(pdev, PPDSTAT_OFFSET, &ppdstat);\r\npending = ppdstat & PCI_EXP_DEVSTA_TRPND;\r\n} while (pending && ctr++ < 10);\r\n}\r\nif (pending)\r\npr_info("QAT: Transaction still in progress. Proceeding\n");\r\npci_read_config_word(parent, PCI_BRIDGE_CONTROL, &bridge_ctl);\r\nbridge_ctl |= PCI_BRIDGE_CTL_BUS_RESET;\r\npci_write_config_word(parent, PCI_BRIDGE_CONTROL, bridge_ctl);\r\nmsleep(100);\r\nbridge_ctl &= ~PCI_BRIDGE_CTL_BUS_RESET;\r\npci_write_config_word(parent, PCI_BRIDGE_CONTROL, bridge_ctl);\r\nmsleep(100);\r\npci_restore_state(pdev);\r\npci_save_state(pdev);\r\n}\r\nstatic void adf_device_reset_worker(struct work_struct *work)\r\n{\r\nstruct adf_reset_dev_data *reset_data =\r\ncontainer_of(work, struct adf_reset_dev_data, reset_work);\r\nstruct adf_accel_dev *accel_dev = reset_data->accel_dev;\r\nadf_dev_restarting_notify(accel_dev);\r\nadf_dev_stop(accel_dev);\r\nadf_dev_restore(accel_dev);\r\nif (adf_dev_start(accel_dev)) {\r\ndev_err(&GET_DEV(accel_dev), "Restart device failed\n");\r\nkfree(reset_data);\r\nWARN(1, "QAT: device restart failed. Device is unusable\n");\r\nreturn;\r\n}\r\nadf_dev_restarted_notify(accel_dev);\r\nclear_bit(ADF_STATUS_RESTARTING, &accel_dev->status);\r\nif (reset_data->mode == ADF_DEV_RESET_SYNC)\r\ncomplete(&reset_data->compl);\r\nelse\r\nkfree(reset_data);\r\n}\r\nstatic int adf_dev_aer_schedule_reset(struct adf_accel_dev *accel_dev,\r\nenum adf_dev_reset_mode mode)\r\n{\r\nstruct adf_reset_dev_data *reset_data;\r\nif (adf_dev_started(accel_dev) &&\r\n!test_bit(ADF_STATUS_RESTARTING, &accel_dev->status))\r\nreturn 0;\r\nset_bit(ADF_STATUS_RESTARTING, &accel_dev->status);\r\nreset_data = kzalloc(sizeof(*reset_data), GFP_ATOMIC);\r\nif (!reset_data)\r\nreturn -ENOMEM;\r\nreset_data->accel_dev = accel_dev;\r\ninit_completion(&reset_data->compl);\r\nreset_data->mode = mode;\r\nINIT_WORK(&reset_data->reset_work, adf_device_reset_worker);\r\nqueue_work(device_reset_wq, &reset_data->reset_work);\r\nif (mode == ADF_DEV_RESET_SYNC) {\r\nint ret = 0;\r\nunsigned long wait_jiffies = msecs_to_jiffies(10000);\r\nunsigned long timeout = wait_for_completion_timeout(\r\n&reset_data->compl, wait_jiffies);\r\nif (!timeout) {\r\npr_err("QAT: Reset device timeout expired\n");\r\nret = -EFAULT;\r\n}\r\nkfree(reset_data);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic pci_ers_result_t adf_slot_reset(struct pci_dev *pdev)\r\n{\r\nstruct adf_accel_dev *accel_dev = adf_devmgr_pci_to_accel_dev(pdev);\r\nif (!accel_dev) {\r\npr_err("QAT: Can't find acceleration device\n");\r\nreturn PCI_ERS_RESULT_DISCONNECT;\r\n}\r\npci_cleanup_aer_uncorrect_error_status(pdev);\r\nif (adf_dev_aer_schedule_reset(accel_dev, ADF_DEV_RESET_SYNC))\r\nreturn PCI_ERS_RESULT_DISCONNECT;\r\nreturn PCI_ERS_RESULT_RECOVERED;\r\n}\r\nstatic void adf_resume(struct pci_dev *pdev)\r\n{\r\npr_info("QAT: Acceleration driver reset completed\n");\r\npr_info("QAT: Device is up and runnig\n");\r\n}\r\nint adf_enable_aer(struct adf_accel_dev *accel_dev, struct pci_driver *adf)\r\n{\r\nstruct pci_dev *pdev = accel_to_pci_dev(accel_dev);\r\nadf->err_handler = &adf_err_handler;\r\npci_enable_pcie_error_reporting(pdev);\r\nreturn 0;\r\n}\r\nvoid adf_disable_aer(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct pci_dev *pdev = accel_to_pci_dev(accel_dev);\r\npci_disable_pcie_error_reporting(pdev);\r\n}\r\nint adf_init_aer(void)\r\n{\r\ndevice_reset_wq = create_workqueue("qat_device_reset_wq");\r\nreturn (device_reset_wq == NULL) ? -EFAULT : 0;\r\n}\r\nvoid adf_exit_aer(void)\r\n{\r\nif (device_reset_wq)\r\ndestroy_workqueue(device_reset_wq);\r\ndevice_reset_wq = NULL;\r\n}

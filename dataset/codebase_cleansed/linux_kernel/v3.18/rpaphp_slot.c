static void rpaphp_release_slot(struct hotplug_slot *hotplug_slot)\r\n{\r\nstruct slot *slot = (struct slot *) hotplug_slot->private;\r\ndealloc_slot_struct(slot);\r\n}\r\nvoid dealloc_slot_struct(struct slot *slot)\r\n{\r\nkfree(slot->hotplug_slot->info);\r\nkfree(slot->name);\r\nkfree(slot->hotplug_slot);\r\nkfree(slot);\r\n}\r\nstruct slot *alloc_slot_struct(struct device_node *dn,\r\nint drc_index, char *drc_name, int power_domain)\r\n{\r\nstruct slot *slot;\r\nslot = kzalloc(sizeof(struct slot), GFP_KERNEL);\r\nif (!slot)\r\ngoto error_nomem;\r\nslot->hotplug_slot = kzalloc(sizeof(struct hotplug_slot), GFP_KERNEL);\r\nif (!slot->hotplug_slot)\r\ngoto error_slot;\r\nslot->hotplug_slot->info = kzalloc(sizeof(struct hotplug_slot_info),\r\nGFP_KERNEL);\r\nif (!slot->hotplug_slot->info)\r\ngoto error_hpslot;\r\nslot->name = kstrdup(drc_name, GFP_KERNEL);\r\nif (!slot->name)\r\ngoto error_info;\r\nslot->dn = dn;\r\nslot->index = drc_index;\r\nslot->power_domain = power_domain;\r\nslot->hotplug_slot->private = slot;\r\nslot->hotplug_slot->ops = &rpaphp_hotplug_slot_ops;\r\nslot->hotplug_slot->release = &rpaphp_release_slot;\r\nreturn (slot);\r\nerror_info:\r\nkfree(slot->hotplug_slot->info);\r\nerror_hpslot:\r\nkfree(slot->hotplug_slot);\r\nerror_slot:\r\nkfree(slot);\r\nerror_nomem:\r\nreturn NULL;\r\n}\r\nstatic int is_registered(struct slot *slot)\r\n{\r\nstruct slot *tmp_slot;\r\nlist_for_each_entry(tmp_slot, &rpaphp_slot_head, rpaphp_slot_list) {\r\nif (!strcmp(tmp_slot->name, slot->name))\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nint rpaphp_deregister_slot(struct slot *slot)\r\n{\r\nint retval = 0;\r\nstruct hotplug_slot *php_slot = slot->hotplug_slot;\r\ndbg("%s - Entry: deregistering slot=%s\n",\r\n__func__, slot->name);\r\nlist_del(&slot->rpaphp_slot_list);\r\nretval = pci_hp_deregister(php_slot);\r\nif (retval)\r\nerr("Problem unregistering a slot %s\n", slot->name);\r\ndbg("%s - Exit: rc[%d]\n", __func__, retval);\r\nreturn retval;\r\n}\r\nint rpaphp_register_slot(struct slot *slot)\r\n{\r\nstruct hotplug_slot *php_slot = slot->hotplug_slot;\r\nint retval;\r\nint slotno;\r\ndbg("%s registering slot:path[%s] index[%x], name[%s] pdomain[%x] type[%d]\n",\r\n__func__, slot->dn->full_name, slot->index, slot->name,\r\nslot->power_domain, slot->type);\r\nif (is_registered(slot)) {\r\nerr("rpaphp_register_slot: slot[%s] is already registered\n", slot->name);\r\nreturn -EAGAIN;\r\n}\r\nif (slot->dn->child)\r\nslotno = PCI_SLOT(PCI_DN(slot->dn->child)->devfn);\r\nelse\r\nslotno = -1;\r\nretval = pci_hp_register(php_slot, slot->bus, slotno, slot->name);\r\nif (retval) {\r\nerr("pci_hp_register failed with error %d\n", retval);\r\nreturn retval;\r\n}\r\nlist_add(&slot->rpaphp_slot_list, &rpaphp_slot_head);\r\ninfo("Slot [%s] registered\n", slot->name);\r\nreturn 0;\r\n}

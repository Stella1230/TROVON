int sgdma_initialize(struct altera_tse_private *priv)\r\n{\r\npriv->txctrlreg = SGDMA_CTRLREG_ILASTD |\r\nSGDMA_CTRLREG_INTEN;\r\npriv->rxctrlreg = SGDMA_CTRLREG_IDESCRIP |\r\nSGDMA_CTRLREG_INTEN |\r\nSGDMA_CTRLREG_ILASTD;\r\npriv->sgdmadesclen = sizeof(struct sgdma_descrip);\r\nINIT_LIST_HEAD(&priv->txlisthd);\r\nINIT_LIST_HEAD(&priv->rxlisthd);\r\npriv->rxdescphys = (dma_addr_t) 0;\r\npriv->txdescphys = (dma_addr_t) 0;\r\npriv->rxdescphys = dma_map_single(priv->device,\r\n(void __force *)priv->rx_dma_desc,\r\npriv->rxdescmem, DMA_BIDIRECTIONAL);\r\nif (dma_mapping_error(priv->device, priv->rxdescphys)) {\r\nsgdma_uninitialize(priv);\r\nnetdev_err(priv->dev, "error mapping rx descriptor memory\n");\r\nreturn -EINVAL;\r\n}\r\npriv->txdescphys = dma_map_single(priv->device,\r\n(void __force *)priv->tx_dma_desc,\r\npriv->txdescmem, DMA_TO_DEVICE);\r\nif (dma_mapping_error(priv->device, priv->txdescphys)) {\r\nsgdma_uninitialize(priv);\r\nnetdev_err(priv->dev, "error mapping tx descriptor memory\n");\r\nreturn -EINVAL;\r\n}\r\nmemset_io(priv->tx_dma_desc, 0, priv->txdescmem);\r\nmemset_io(priv->rx_dma_desc, 0, priv->rxdescmem);\r\ndma_sync_single_for_device(priv->device, priv->txdescphys,\r\npriv->txdescmem, DMA_TO_DEVICE);\r\ndma_sync_single_for_device(priv->device, priv->rxdescphys,\r\npriv->rxdescmem, DMA_TO_DEVICE);\r\nreturn 0;\r\n}\r\nvoid sgdma_uninitialize(struct altera_tse_private *priv)\r\n{\r\nif (priv->rxdescphys)\r\ndma_unmap_single(priv->device, priv->rxdescphys,\r\npriv->rxdescmem, DMA_BIDIRECTIONAL);\r\nif (priv->txdescphys)\r\ndma_unmap_single(priv->device, priv->txdescphys,\r\npriv->txdescmem, DMA_TO_DEVICE);\r\n}\r\nvoid sgdma_reset(struct altera_tse_private *priv)\r\n{\r\nmemset_io(priv->tx_dma_desc, 0, priv->txdescmem);\r\nmemset_io(priv->rx_dma_desc, 0, priv->rxdescmem);\r\ncsrwr32(SGDMA_CTRLREG_RESET, priv->tx_dma_csr, sgdma_csroffs(control));\r\ncsrwr32(0, priv->tx_dma_csr, sgdma_csroffs(control));\r\ncsrwr32(SGDMA_CTRLREG_RESET, priv->rx_dma_csr, sgdma_csroffs(control));\r\ncsrwr32(0, priv->rx_dma_csr, sgdma_csroffs(control));\r\n}\r\nvoid sgdma_enable_rxirq(struct altera_tse_private *priv)\r\n{\r\n}\r\nvoid sgdma_enable_txirq(struct altera_tse_private *priv)\r\n{\r\n}\r\nvoid sgdma_disable_rxirq(struct altera_tse_private *priv)\r\n{\r\n}\r\nvoid sgdma_disable_txirq(struct altera_tse_private *priv)\r\n{\r\n}\r\nvoid sgdma_clear_rxirq(struct altera_tse_private *priv)\r\n{\r\ntse_set_bit(priv->rx_dma_csr, sgdma_csroffs(control),\r\nSGDMA_CTRLREG_CLRINT);\r\n}\r\nvoid sgdma_clear_txirq(struct altera_tse_private *priv)\r\n{\r\ntse_set_bit(priv->tx_dma_csr, sgdma_csroffs(control),\r\nSGDMA_CTRLREG_CLRINT);\r\n}\r\nint sgdma_tx_buffer(struct altera_tse_private *priv, struct tse_buffer *buffer)\r\n{\r\nstruct sgdma_descrip __iomem *descbase =\r\n(struct sgdma_descrip __iomem *)priv->tx_dma_desc;\r\nstruct sgdma_descrip __iomem *cdesc = &descbase[0];\r\nstruct sgdma_descrip __iomem *ndesc = &descbase[1];\r\nif (sgdma_txbusy(priv))\r\nreturn 0;\r\nsgdma_setup_descrip(cdesc,\r\nndesc,\r\nsgdma_txphysaddr(priv, ndesc),\r\nbuffer->dma_addr,\r\n0,\r\nbuffer->len,\r\nSGDMA_CONTROL_EOP,\r\n0,\r\nSGDMA_CONTROL_WR_FIXED);\r\nsgdma_async_write(priv, cdesc);\r\nqueue_tx(priv, buffer);\r\nreturn 1;\r\n}\r\nu32 sgdma_tx_completions(struct altera_tse_private *priv)\r\n{\r\nu32 ready = 0;\r\nif (!sgdma_txbusy(priv) &&\r\n((csrrd8(priv->tx_dma_desc, sgdma_descroffs(control))\r\n& SGDMA_CONTROL_HW_OWNED) == 0) &&\r\n(dequeue_tx(priv))) {\r\nready = 1;\r\n}\r\nreturn ready;\r\n}\r\nvoid sgdma_start_rxdma(struct altera_tse_private *priv)\r\n{\r\nsgdma_async_read(priv);\r\n}\r\nvoid sgdma_add_rx_desc(struct altera_tse_private *priv,\r\nstruct tse_buffer *rxbuffer)\r\n{\r\nqueue_rx(priv, rxbuffer);\r\n}\r\nu32 sgdma_rx_status(struct altera_tse_private *priv)\r\n{\r\nstruct sgdma_descrip __iomem *base =\r\n(struct sgdma_descrip __iomem *)priv->rx_dma_desc;\r\nstruct sgdma_descrip __iomem *desc = NULL;\r\nstruct tse_buffer *rxbuffer = NULL;\r\nunsigned int rxstatus = 0;\r\nu32 sts = csrrd32(priv->rx_dma_csr, sgdma_csroffs(status));\r\ndesc = &base[0];\r\nif (sts & SGDMA_STSREG_EOP) {\r\nunsigned int pktlength = 0;\r\nunsigned int pktstatus = 0;\r\ndma_sync_single_for_cpu(priv->device,\r\npriv->rxdescphys,\r\npriv->sgdmadesclen,\r\nDMA_FROM_DEVICE);\r\npktlength = csrrd16(desc, sgdma_descroffs(bytes_xferred));\r\npktstatus = csrrd8(desc, sgdma_descroffs(status));\r\nrxstatus = pktstatus & ~SGDMA_STATUS_EOP;\r\nrxstatus = rxstatus << 16;\r\nrxstatus |= (pktlength & 0xffff);\r\nif (rxstatus) {\r\ncsrwr8(0, desc, sgdma_descroffs(status));\r\nrxbuffer = dequeue_rx(priv);\r\nif (rxbuffer == NULL)\r\nnetdev_info(priv->dev,\r\n"sgdma rx and rx queue empty!\n");\r\ncsrwr32(0, priv->rx_dma_csr, sgdma_csroffs(control));\r\ncsrwr32(0xf, priv->rx_dma_csr, sgdma_csroffs(status));\r\nsgdma_async_read(priv);\r\n} else {\r\nnetdev_err(priv->dev,\r\n"SGDMA RX Error Info: %x, %x, %x\n",\r\nsts, csrrd8(desc, sgdma_descroffs(status)),\r\nrxstatus);\r\n}\r\n} else if (sts == 0) {\r\nsgdma_async_read(priv);\r\n}\r\nreturn rxstatus;\r\n}\r\nstatic void sgdma_setup_descrip(struct sgdma_descrip __iomem *desc,\r\nstruct sgdma_descrip __iomem *ndesc,\r\ndma_addr_t ndesc_phys,\r\ndma_addr_t raddr,\r\ndma_addr_t waddr,\r\nu16 length,\r\nint generate_eop,\r\nint rfixed,\r\nint wfixed)\r\n{\r\nu32 ctrl = csrrd8(ndesc, sgdma_descroffs(control));\r\nctrl &= ~SGDMA_CONTROL_HW_OWNED;\r\ncsrwr8(ctrl, ndesc, sgdma_descroffs(control));\r\nctrl = SGDMA_CONTROL_HW_OWNED;\r\nctrl |= generate_eop;\r\nctrl |= rfixed;\r\nctrl |= wfixed;\r\ncsrwr32(lower_32_bits(raddr), desc, sgdma_descroffs(raddr));\r\ncsrwr32(lower_32_bits(waddr), desc, sgdma_descroffs(waddr));\r\ncsrwr32(0, desc, sgdma_descroffs(pad1));\r\ncsrwr32(0, desc, sgdma_descroffs(pad2));\r\ncsrwr32(lower_32_bits(ndesc_phys), desc, sgdma_descroffs(next));\r\ncsrwr8(ctrl, desc, sgdma_descroffs(control));\r\ncsrwr8(0, desc, sgdma_descroffs(status));\r\ncsrwr8(0, desc, sgdma_descroffs(wburst));\r\ncsrwr8(0, desc, sgdma_descroffs(rburst));\r\ncsrwr16(length, desc, sgdma_descroffs(bytes));\r\ncsrwr16(0, desc, sgdma_descroffs(bytes_xferred));\r\n}\r\nstatic int sgdma_async_read(struct altera_tse_private *priv)\r\n{\r\nstruct sgdma_descrip __iomem *descbase =\r\n(struct sgdma_descrip __iomem *)priv->rx_dma_desc;\r\nstruct sgdma_descrip __iomem *cdesc = &descbase[0];\r\nstruct sgdma_descrip __iomem *ndesc = &descbase[1];\r\nstruct tse_buffer *rxbuffer = NULL;\r\nif (!sgdma_rxbusy(priv)) {\r\nrxbuffer = queue_rx_peekhead(priv);\r\nif (rxbuffer == NULL) {\r\nnetdev_err(priv->dev, "no rx buffers available\n");\r\nreturn 0;\r\n}\r\nsgdma_setup_descrip(cdesc,\r\nndesc,\r\nsgdma_rxphysaddr(priv, ndesc),\r\n0,\r\nrxbuffer->dma_addr,\r\n0,\r\n0,\r\n0,\r\n0);\r\ndma_sync_single_for_device(priv->device,\r\npriv->rxdescphys,\r\npriv->sgdmadesclen,\r\nDMA_TO_DEVICE);\r\ncsrwr32(lower_32_bits(sgdma_rxphysaddr(priv, cdesc)),\r\npriv->rx_dma_csr,\r\nsgdma_csroffs(next_descrip));\r\ncsrwr32((priv->rxctrlreg | SGDMA_CTRLREG_START),\r\npriv->rx_dma_csr,\r\nsgdma_csroffs(control));\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sgdma_async_write(struct altera_tse_private *priv,\r\nstruct sgdma_descrip __iomem *desc)\r\n{\r\nif (sgdma_txbusy(priv))\r\nreturn 0;\r\ncsrwr32(0, priv->tx_dma_csr, sgdma_csroffs(control));\r\ncsrwr32(0x1f, priv->tx_dma_csr, sgdma_csroffs(status));\r\ndma_sync_single_for_device(priv->device, priv->txdescphys,\r\npriv->sgdmadesclen, DMA_TO_DEVICE);\r\ncsrwr32(lower_32_bits(sgdma_txphysaddr(priv, desc)),\r\npriv->tx_dma_csr,\r\nsgdma_csroffs(next_descrip));\r\ncsrwr32((priv->txctrlreg | SGDMA_CTRLREG_START),\r\npriv->tx_dma_csr,\r\nsgdma_csroffs(control));\r\nreturn 1;\r\n}\r\nstatic dma_addr_t\r\nsgdma_txphysaddr(struct altera_tse_private *priv,\r\nstruct sgdma_descrip __iomem *desc)\r\n{\r\ndma_addr_t paddr = priv->txdescmem_busaddr;\r\nuintptr_t offs = (uintptr_t)desc - (uintptr_t)priv->tx_dma_desc;\r\nreturn (dma_addr_t)((uintptr_t)paddr + offs);\r\n}\r\nstatic dma_addr_t\r\nsgdma_rxphysaddr(struct altera_tse_private *priv,\r\nstruct sgdma_descrip __iomem *desc)\r\n{\r\ndma_addr_t paddr = priv->rxdescmem_busaddr;\r\nuintptr_t offs = (uintptr_t)desc - (uintptr_t)priv->rx_dma_desc;\r\nreturn (dma_addr_t)((uintptr_t)paddr + offs);\r\n}\r\nstatic void\r\nqueue_tx(struct altera_tse_private *priv, struct tse_buffer *buffer)\r\n{\r\nlist_add_tail(&buffer->lh, &priv->txlisthd);\r\n}\r\nstatic void\r\nqueue_rx(struct altera_tse_private *priv, struct tse_buffer *buffer)\r\n{\r\nlist_add_tail(&buffer->lh, &priv->rxlisthd);\r\n}\r\nstatic struct tse_buffer *\r\ndequeue_tx(struct altera_tse_private *priv)\r\n{\r\nstruct tse_buffer *buffer = NULL;\r\nlist_remove_head(&priv->txlisthd, buffer, struct tse_buffer, lh);\r\nreturn buffer;\r\n}\r\nstatic struct tse_buffer *\r\ndequeue_rx(struct altera_tse_private *priv)\r\n{\r\nstruct tse_buffer *buffer = NULL;\r\nlist_remove_head(&priv->rxlisthd, buffer, struct tse_buffer, lh);\r\nreturn buffer;\r\n}\r\nstatic struct tse_buffer *\r\nqueue_rx_peekhead(struct altera_tse_private *priv)\r\n{\r\nstruct tse_buffer *buffer = NULL;\r\nlist_peek_head(&priv->rxlisthd, buffer, struct tse_buffer, lh);\r\nreturn buffer;\r\n}\r\nstatic int sgdma_rxbusy(struct altera_tse_private *priv)\r\n{\r\nreturn csrrd32(priv->rx_dma_csr, sgdma_csroffs(status))\r\n& SGDMA_STSREG_BUSY;\r\n}\r\nstatic int sgdma_txbusy(struct altera_tse_private *priv)\r\n{\r\nint delay = 0;\r\nwhile ((csrrd32(priv->tx_dma_csr, sgdma_csroffs(status))\r\n& SGDMA_STSREG_BUSY) && (delay++ < 100))\r\nudelay(1);\r\nif (csrrd32(priv->tx_dma_csr, sgdma_csroffs(status))\r\n& SGDMA_STSREG_BUSY) {\r\nnetdev_err(priv->dev, "timeout waiting for tx dma\n");\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}

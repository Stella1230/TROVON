static int regmap_spmi_base_read(void *context,\r\nconst void *reg, size_t reg_size,\r\nvoid *val, size_t val_size)\r\n{\r\nu8 addr = *(u8 *)reg;\r\nint err = 0;\r\nBUG_ON(reg_size != 1);\r\nwhile (val_size-- && !err)\r\nerr = spmi_register_read(context, addr++, val++);\r\nreturn err;\r\n}\r\nstatic int regmap_spmi_base_gather_write(void *context,\r\nconst void *reg, size_t reg_size,\r\nconst void *val, size_t val_size)\r\n{\r\nconst u8 *data = val;\r\nu8 addr = *(u8 *)reg;\r\nint err = 0;\r\nBUG_ON(reg_size != 1);\r\nif (addr == 0 && val_size) {\r\nerr = spmi_register_zero_write(context, *data);\r\nif (err)\r\ngoto err_out;\r\ndata++;\r\naddr++;\r\nval_size--;\r\n}\r\nwhile (val_size) {\r\nerr = spmi_register_write(context, addr, *data);\r\nif (err)\r\ngoto err_out;\r\ndata++;\r\naddr++;\r\nval_size--;\r\n}\r\nerr_out:\r\nreturn err;\r\n}\r\nstatic int regmap_spmi_base_write(void *context, const void *data,\r\nsize_t count)\r\n{\r\nBUG_ON(count < 1);\r\nreturn regmap_spmi_base_gather_write(context, data, 1, data + 1,\r\ncount - 1);\r\n}\r\nstruct regmap *regmap_init_spmi_base(struct spmi_device *sdev,\r\nconst struct regmap_config *config)\r\n{\r\nreturn regmap_init(&sdev->dev, &regmap_spmi_base, sdev, config);\r\n}\r\nstruct regmap *devm_regmap_init_spmi_base(struct spmi_device *sdev,\r\nconst struct regmap_config *config)\r\n{\r\nreturn devm_regmap_init(&sdev->dev, &regmap_spmi_base, sdev, config);\r\n}\r\nstatic int regmap_spmi_ext_read(void *context,\r\nconst void *reg, size_t reg_size,\r\nvoid *val, size_t val_size)\r\n{\r\nint err = 0;\r\nsize_t len;\r\nu16 addr;\r\nBUG_ON(reg_size != 2);\r\naddr = *(u16 *)reg;\r\nwhile (addr <= 0xFF && val_size) {\r\nlen = min_t(size_t, val_size, 16);\r\nerr = spmi_ext_register_read(context, addr, val, len);\r\nif (err)\r\ngoto err_out;\r\naddr += len;\r\nval += len;\r\nval_size -= len;\r\n}\r\nwhile (val_size) {\r\nlen = min_t(size_t, val_size, 8);\r\nerr = spmi_ext_register_readl(context, addr, val, val_size);\r\nif (err)\r\ngoto err_out;\r\naddr += len;\r\nval += len;\r\nval_size -= len;\r\n}\r\nerr_out:\r\nreturn err;\r\n}\r\nstatic int regmap_spmi_ext_gather_write(void *context,\r\nconst void *reg, size_t reg_size,\r\nconst void *val, size_t val_size)\r\n{\r\nint err = 0;\r\nsize_t len;\r\nu16 addr;\r\nBUG_ON(reg_size != 2);\r\naddr = *(u16 *)reg;\r\nwhile (addr <= 0xFF && val_size) {\r\nlen = min_t(size_t, val_size, 16);\r\nerr = spmi_ext_register_write(context, addr, val, len);\r\nif (err)\r\ngoto err_out;\r\naddr += len;\r\nval += len;\r\nval_size -= len;\r\n}\r\nwhile (val_size) {\r\nlen = min_t(size_t, val_size, 8);\r\nerr = spmi_ext_register_writel(context, addr, val, len);\r\nif (err)\r\ngoto err_out;\r\naddr += len;\r\nval += len;\r\nval_size -= len;\r\n}\r\nerr_out:\r\nreturn err;\r\n}\r\nstatic int regmap_spmi_ext_write(void *context, const void *data,\r\nsize_t count)\r\n{\r\nBUG_ON(count < 2);\r\nreturn regmap_spmi_ext_gather_write(context, data, 2, data + 2,\r\ncount - 2);\r\n}\r\nstruct regmap *regmap_init_spmi_ext(struct spmi_device *sdev,\r\nconst struct regmap_config *config)\r\n{\r\nreturn regmap_init(&sdev->dev, &regmap_spmi_ext, sdev, config);\r\n}\r\nstruct regmap *devm_regmap_init_spmi_ext(struct spmi_device *sdev,\r\nconst struct regmap_config *config)\r\n{\r\nreturn devm_regmap_init(&sdev->dev, &regmap_spmi_ext, sdev, config);\r\n}

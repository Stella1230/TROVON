static u8 tw_readbyte(struct solo_dev *solo_dev, int chip_id, u8 tw6x_off,\r\nu8 tw_off)\r\n{\r\nif (is_tw286x(solo_dev, chip_id))\r\nreturn solo_i2c_readbyte(solo_dev, SOLO_I2C_TW,\r\nTW_CHIP_OFFSET_ADDR(chip_id),\r\ntw6x_off);\r\nelse\r\nreturn solo_i2c_readbyte(solo_dev, SOLO_I2C_TW,\r\nTW_CHIP_OFFSET_ADDR(chip_id),\r\ntw_off);\r\n}\r\nstatic void tw_writebyte(struct solo_dev *solo_dev, int chip_id,\r\nu8 tw6x_off, u8 tw_off, u8 val)\r\n{\r\nif (is_tw286x(solo_dev, chip_id))\r\nsolo_i2c_writebyte(solo_dev, SOLO_I2C_TW,\r\nTW_CHIP_OFFSET_ADDR(chip_id),\r\ntw6x_off, val);\r\nelse\r\nsolo_i2c_writebyte(solo_dev, SOLO_I2C_TW,\r\nTW_CHIP_OFFSET_ADDR(chip_id),\r\ntw_off, val);\r\n}\r\nstatic void tw_write_and_verify(struct solo_dev *solo_dev, u8 addr, u8 off,\r\nu8 val)\r\n{\r\nint i;\r\nfor (i = 0; i < 5; i++) {\r\nu8 rval = solo_i2c_readbyte(solo_dev, SOLO_I2C_TW, addr, off);\r\nif (rval == val)\r\nreturn;\r\nsolo_i2c_writebyte(solo_dev, SOLO_I2C_TW, addr, off, val);\r\nmsleep_interruptible(1);\r\n}\r\n}\r\nstatic int tw2865_setup(struct solo_dev *solo_dev, u8 dev_addr)\r\n{\r\nu8 tbl_tw2865_common[256];\r\nint i;\r\nif (solo_dev->video_type == SOLO_VO_FMT_TYPE_PAL)\r\nmemcpy(tbl_tw2865_common, tbl_tw2865_pal_template,\r\nsizeof(tbl_tw2865_common));\r\nelse\r\nmemcpy(tbl_tw2865_common, tbl_tw2865_ntsc_template,\r\nsizeof(tbl_tw2865_common));\r\nif (solo_dev->nr_chans == 4) {\r\ntbl_tw2865_common[0xd2] = 0x01;\r\ntbl_tw2865_common[0xcf] = 0x00;\r\n} else if (solo_dev->nr_chans == 8) {\r\ntbl_tw2865_common[0xd2] = 0x02;\r\nif (dev_addr == TW_CHIP_OFFSET_ADDR(1))\r\ntbl_tw2865_common[0xcf] = 0x80;\r\n} else if (solo_dev->nr_chans == 16) {\r\ntbl_tw2865_common[0xd2] = 0x03;\r\nif (dev_addr == TW_CHIP_OFFSET_ADDR(1))\r\ntbl_tw2865_common[0xcf] = 0x83;\r\nelse if (dev_addr == TW_CHIP_OFFSET_ADDR(2))\r\ntbl_tw2865_common[0xcf] = 0x83;\r\nelse if (dev_addr == TW_CHIP_OFFSET_ADDR(3))\r\ntbl_tw2865_common[0xcf] = 0x80;\r\n}\r\nfor (i = 0; i < 0xff; i++) {\r\nswitch (i) {\r\ncase 0xb8 ... 0xc1:\r\ncase 0xc4 ... 0xc7:\r\ncase 0xfd:\r\ncontinue;\r\n}\r\nswitch (i & ~0x30) {\r\ncase 0x00:\r\ncase 0x0c ... 0x0d:\r\ncontinue;\r\n}\r\ntw_write_and_verify(solo_dev, dev_addr, i,\r\ntbl_tw2865_common[i]);\r\n}\r\nreturn 0;\r\n}\r\nstatic int tw2864_setup(struct solo_dev *solo_dev, u8 dev_addr)\r\n{\r\nu8 tbl_tw2864_common[256];\r\nint i;\r\nif (solo_dev->video_type == SOLO_VO_FMT_TYPE_PAL)\r\nmemcpy(tbl_tw2864_common, tbl_tw2864_pal_template,\r\nsizeof(tbl_tw2864_common));\r\nelse\r\nmemcpy(tbl_tw2864_common, tbl_tw2864_ntsc_template,\r\nsizeof(tbl_tw2864_common));\r\nif (solo_dev->tw2865 == 0) {\r\nif (solo_dev->nr_chans == 4) {\r\ntbl_tw2864_common[0xd2] = 0x01;\r\ntbl_tw2864_common[0xcf] = 0x00;\r\n} else if (solo_dev->nr_chans == 8) {\r\ntbl_tw2864_common[0xd2] = 0x02;\r\nif (dev_addr == TW_CHIP_OFFSET_ADDR(0))\r\ntbl_tw2864_common[0xcf] = 0x43;\r\nelse if (dev_addr == TW_CHIP_OFFSET_ADDR(1))\r\ntbl_tw2864_common[0xcf] = 0x40;\r\n} else if (solo_dev->nr_chans == 16) {\r\ntbl_tw2864_common[0xd2] = 0x03;\r\nif (dev_addr == TW_CHIP_OFFSET_ADDR(0))\r\ntbl_tw2864_common[0xcf] = 0x43;\r\nelse if (dev_addr == TW_CHIP_OFFSET_ADDR(1))\r\ntbl_tw2864_common[0xcf] = 0x43;\r\nelse if (dev_addr == TW_CHIP_OFFSET_ADDR(2))\r\ntbl_tw2864_common[0xcf] = 0x43;\r\nelse if (dev_addr == TW_CHIP_OFFSET_ADDR(3))\r\ntbl_tw2864_common[0xcf] = 0x40;\r\n}\r\n} else {\r\nfor (i = 0; i <= 4; i++)\r\ntbl_tw2864_common[0x08 | i << 4] = 0x12;\r\nif (solo_dev->nr_chans == 8) {\r\ntbl_tw2864_common[0xd2] = 0x02;\r\nif (dev_addr == TW_CHIP_OFFSET_ADDR(1))\r\ntbl_tw2864_common[0xcf] = 0x80;\r\n} else if (solo_dev->nr_chans == 16) {\r\ntbl_tw2864_common[0xd2] = 0x03;\r\nif (dev_addr == TW_CHIP_OFFSET_ADDR(1))\r\ntbl_tw2864_common[0xcf] = 0x83;\r\nelse if (dev_addr == TW_CHIP_OFFSET_ADDR(2))\r\ntbl_tw2864_common[0xcf] = 0x83;\r\nelse if (dev_addr == TW_CHIP_OFFSET_ADDR(3))\r\ntbl_tw2864_common[0xcf] = 0x80;\r\n}\r\n}\r\nfor (i = 0; i < 0xff; i++) {\r\nswitch (i) {\r\ncase 0xb8 ... 0xc1:\r\ncase 0xfd:\r\ncontinue;\r\n}\r\nswitch (i & ~0x30) {\r\ncase 0x00:\r\ncase 0x0c:\r\ncase 0x0d:\r\ncontinue;\r\n}\r\ntw_write_and_verify(solo_dev, dev_addr, i,\r\ntbl_tw2864_common[i]);\r\n}\r\nreturn 0;\r\n}\r\nstatic int tw2815_setup(struct solo_dev *solo_dev, u8 dev_addr)\r\n{\r\nu8 tbl_ntsc_tw2815_common[] = {\r\n0x00, 0xc8, 0x20, 0xd0, 0x06, 0xf0, 0x08, 0x80,\r\n0x80, 0x80, 0x80, 0x02, 0x06, 0x00, 0x11,\r\n};\r\nu8 tbl_pal_tw2815_common[] = {\r\n0x00, 0x88, 0x20, 0xd0, 0x05, 0x20, 0x28, 0x80,\r\n0x80, 0x80, 0x80, 0x82, 0x06, 0x00, 0x11,\r\n};\r\nu8 tbl_tw2815_sfr[] = {\r\n0x00, 0x00, 0x00, 0xc0, 0x45, 0xa0, 0xd0, 0x2f,\r\n0x64, 0x80, 0x80, 0x82, 0x82, 0x00, 0x00, 0x00,\r\n0x00, 0x0f, 0x05, 0x00, 0x00, 0x80, 0x06, 0x00,\r\n0x00, 0x00, 0x00, 0xff, 0x8f, 0x00, 0x00, 0x00,\r\n0x88, 0x88, 0xc0, 0x00, 0x20, 0x64, 0xa8, 0xec,\r\n0x31, 0x75, 0xb9, 0xfd, 0x00, 0x00, 0x88, 0x88,\r\n0x88, 0x11, 0x00, 0x88, 0x88, 0x00,\r\n};\r\nu8 *tbl_tw2815_common;\r\nint i;\r\nint ch;\r\ntbl_ntsc_tw2815_common[0x06] = 0;\r\ntbl_ntsc_tw2815_common[0x02] = DEFAULT_HDELAY_NTSC & 0xff;\r\ntbl_ntsc_tw2815_common[0x06] |= 0x03 & (DEFAULT_HDELAY_NTSC >> 8);\r\ntbl_ntsc_tw2815_common[0x03] = DEFAULT_HACTIVE_NTSC & 0xff;\r\ntbl_ntsc_tw2815_common[0x06] |=\r\n((0x03 & (DEFAULT_HACTIVE_NTSC >> 8)) << 2);\r\ntbl_ntsc_tw2815_common[0x04] = DEFAULT_VDELAY_NTSC & 0xff;\r\ntbl_ntsc_tw2815_common[0x06] |=\r\n((0x01 & (DEFAULT_VDELAY_NTSC >> 8)) << 4);\r\ntbl_ntsc_tw2815_common[0x05] = DEFAULT_VACTIVE_NTSC & 0xff;\r\ntbl_ntsc_tw2815_common[0x06] |=\r\n((0x01 & (DEFAULT_VACTIVE_NTSC >> 8)) << 5);\r\ntbl_pal_tw2815_common[0x06] = 0;\r\ntbl_pal_tw2815_common[0x02] = DEFAULT_HDELAY_PAL & 0xff;\r\ntbl_pal_tw2815_common[0x06] |= 0x03 & (DEFAULT_HDELAY_PAL >> 8);\r\ntbl_pal_tw2815_common[0x03] = DEFAULT_HACTIVE_PAL & 0xff;\r\ntbl_pal_tw2815_common[0x06] |=\r\n((0x03 & (DEFAULT_HACTIVE_PAL >> 8)) << 2);\r\ntbl_pal_tw2815_common[0x04] = DEFAULT_VDELAY_PAL & 0xff;\r\ntbl_pal_tw2815_common[0x06] |=\r\n((0x01 & (DEFAULT_VDELAY_PAL >> 8)) << 4);\r\ntbl_pal_tw2815_common[0x05] = DEFAULT_VACTIVE_PAL & 0xff;\r\ntbl_pal_tw2815_common[0x06] |=\r\n((0x01 & (DEFAULT_VACTIVE_PAL >> 8)) << 5);\r\ntbl_tw2815_common =\r\n(solo_dev->video_type == SOLO_VO_FMT_TYPE_NTSC) ?\r\ntbl_ntsc_tw2815_common : tbl_pal_tw2815_common;\r\ntbl_tw2815_common[0x0d] |= 0x04;\r\ntbl_tw2815_sfr[0x62 - 0x40] &= ~(3 << 6);\r\nif (solo_dev->nr_chans == 4) {\r\ntbl_tw2815_sfr[0x63 - 0x40] |= 1;\r\ntbl_tw2815_sfr[0x62 - 0x40] |= 3 << 6;\r\n} else if (solo_dev->nr_chans == 8) {\r\ntbl_tw2815_sfr[0x63 - 0x40] |= 2;\r\nif (dev_addr == TW_CHIP_OFFSET_ADDR(0))\r\ntbl_tw2815_sfr[0x62 - 0x40] |= 1 << 6;\r\nelse if (dev_addr == TW_CHIP_OFFSET_ADDR(1))\r\ntbl_tw2815_sfr[0x62 - 0x40] |= 2 << 6;\r\n} else if (solo_dev->nr_chans == 16) {\r\ntbl_tw2815_sfr[0x63 - 0x40] |= 3;\r\nif (dev_addr == TW_CHIP_OFFSET_ADDR(0))\r\ntbl_tw2815_sfr[0x62 - 0x40] |= 1 << 6;\r\nelse if (dev_addr == TW_CHIP_OFFSET_ADDR(1))\r\ntbl_tw2815_sfr[0x62 - 0x40] |= 0 << 6;\r\nelse if (dev_addr == TW_CHIP_OFFSET_ADDR(2))\r\ntbl_tw2815_sfr[0x62 - 0x40] |= 0 << 6;\r\nelse if (dev_addr == TW_CHIP_OFFSET_ADDR(3))\r\ntbl_tw2815_sfr[0x62 - 0x40] |= 2 << 6;\r\n}\r\ntbl_tw2815_sfr[0x62 - 0x40] |= 0 << 2;\r\ntbl_tw2815_sfr[0x6c - 0x40] |= 0 << 2;\r\ntbl_tw2815_sfr[0x6c - 0x40] |= 1 << 5;\r\ntbl_tw2815_sfr[0x5c - 0x40] |= 1 << 5;\r\ntbl_tw2815_sfr[0x70 - 0x40] |= 0xff;\r\ntbl_tw2815_sfr[0x71 - 0x40] |= 0x10;\r\ntbl_tw2815_sfr[0x6d - 0x40] |= 0x0f;\r\nfor (ch = 0; ch < 4; ch++) {\r\ntbl_tw2815_common[0x0d] &= ~3;\r\nswitch (ch) {\r\ncase 0:\r\ntbl_tw2815_common[0x0d] |= 0x21;\r\nbreak;\r\ncase 1:\r\ntbl_tw2815_common[0x0d] |= 0x20;\r\nbreak;\r\ncase 2:\r\ntbl_tw2815_common[0x0d] |= 0x23;\r\nbreak;\r\ncase 3:\r\ntbl_tw2815_common[0x0d] |= 0x22;\r\nbreak;\r\n}\r\nfor (i = 0; i < 0x0f; i++) {\r\nif (i == 0x00)\r\ncontinue;\r\nsolo_i2c_writebyte(solo_dev, SOLO_I2C_TW,\r\ndev_addr, (ch * 0x10) + i,\r\ntbl_tw2815_common[i]);\r\n}\r\n}\r\nfor (i = 0x40; i < 0x76; i++) {\r\nif (i == 0x40 || i == 0x59 || i == 0x5a ||\r\ni == 0x5d || i == 0x5e || i == 0x5f)\r\ncontinue;\r\nsolo_i2c_writebyte(solo_dev, SOLO_I2C_TW, dev_addr, i,\r\ntbl_tw2815_sfr[i - 0x40]);\r\n}\r\nreturn 0;\r\n}\r\nstatic void saa712x_write_regs(struct solo_dev *dev, const uint8_t *vals,\r\nint start, int n)\r\n{\r\nfor (; start < n; start++, vals++) {\r\nswitch (start) {\r\ncase 0x2e ... 0x37:\r\ncase 0x60:\r\ncase 0x7d:\r\ncontinue;\r\n}\r\nsolo_i2c_writebyte(dev, SOLO_I2C_SAA, 0x46, start, *vals);\r\n}\r\n}\r\nstatic void saa712x_setup(struct solo_dev *dev)\r\n{\r\nconst int reg_start = 0x26;\r\nconst uint8_t saa7128_regs_ntsc[] = {\r\n0x0d, 0x00,\r\n0x59, 0x1d, 0x75, 0x3f, 0x06, 0x3f,\r\n0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x1a, 0x1a, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x68, 0x10, 0x97, 0x4c, 0x18,\r\n0x9b, 0x93, 0x9f, 0xff, 0x7c, 0x34, 0x3f, 0x3f,\r\n0x3f, 0x83, 0x83, 0x80, 0x0d, 0x0f, 0xc3, 0x06,\r\n0x02, 0x80, 0x71, 0x77, 0xa7, 0x67, 0x66, 0x2e,\r\n0x7b, 0x11, 0x4f, 0x1f, 0x7c, 0xf0, 0x21, 0x77,\r\n0x41, 0x88, 0x41, 0x52, 0xed, 0x10, 0x10, 0x00,\r\n0x41, 0xc3, 0x00, 0x3e, 0xb8, 0x02, 0x00, 0x00,\r\n0x00, 0x00, FIRST_ACTIVE_LINE, LAST_ACTIVE_LINE & 0xff,\r\nSAA712x_reg7c, 0x00, 0xff, 0xff,\r\n}, saa7128_regs_pal[] = {\r\n0x0d, 0x00,\r\n0xe1, 0x1d, 0x75, 0x3f, 0x06, 0x3f,\r\n0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x1a, 0x1a, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x68, 0x10, 0x97, 0x4c, 0x18,\r\n0x9b, 0x93, 0x9f, 0xff, 0x7c, 0x34, 0x3f, 0x3f,\r\n0x3f, 0x83, 0x83, 0x80, 0x0d, 0x0f, 0xc3, 0x06,\r\n0x02, 0x80, 0x0f, 0x77, 0xa7, 0x67, 0x66, 0x2e,\r\n0x7b, 0x02, 0x35, 0xcb, 0x8a, 0x09, 0x2a, 0x77,\r\n0x41, 0x88, 0x41, 0x52, 0xf1, 0x10, 0x20, 0x00,\r\n0x41, 0xc3, 0x00, 0x3e, 0xb8, 0x02, 0x00, 0x00,\r\n0x00, 0x00, 0x12, 0x30,\r\nSAA712x_reg7c | 0x40, 0x00, 0xff, 0xff,\r\n};\r\nif (dev->video_type == SOLO_VO_FMT_TYPE_PAL)\r\nsaa712x_write_regs(dev, saa7128_regs_pal, reg_start,\r\nsizeof(saa7128_regs_pal));\r\nelse\r\nsaa712x_write_regs(dev, saa7128_regs_ntsc, reg_start,\r\nsizeof(saa7128_regs_ntsc));\r\n}\r\nint solo_tw28_init(struct solo_dev *solo_dev)\r\n{\r\nint i;\r\nu8 value;\r\nsolo_dev->tw28_cnt = 0;\r\nfor (i = 0; i < solo_dev->nr_chans / 4; i++) {\r\nvalue = solo_i2c_readbyte(solo_dev, SOLO_I2C_TW,\r\nTW_CHIP_OFFSET_ADDR(i), 0xFF);\r\nswitch (value >> 3) {\r\ncase 0x18:\r\nsolo_dev->tw2865 |= 1 << i;\r\nsolo_dev->tw28_cnt++;\r\nbreak;\r\ncase 0x0c:\r\nsolo_dev->tw2864 |= 1 << i;\r\nsolo_dev->tw28_cnt++;\r\nbreak;\r\ndefault:\r\nvalue = solo_i2c_readbyte(solo_dev, SOLO_I2C_TW,\r\nTW_CHIP_OFFSET_ADDR(i),\r\n0x59);\r\nif ((value >> 3) == 0x04) {\r\nsolo_dev->tw2815 |= 1 << i;\r\nsolo_dev->tw28_cnt++;\r\n}\r\n}\r\n}\r\nif (solo_dev->tw28_cnt != (solo_dev->nr_chans >> 2)) {\r\ndev_err(&solo_dev->pdev->dev,\r\n"Could not initialize any techwell chips\n");\r\nreturn -EINVAL;\r\n}\r\nsaa712x_setup(solo_dev);\r\nfor (i = 0; i < solo_dev->tw28_cnt; i++) {\r\nif ((solo_dev->tw2865 & (1 << i)))\r\ntw2865_setup(solo_dev, TW_CHIP_OFFSET_ADDR(i));\r\nelse if ((solo_dev->tw2864 & (1 << i)))\r\ntw2864_setup(solo_dev, TW_CHIP_OFFSET_ADDR(i));\r\nelse\r\ntw2815_setup(solo_dev, TW_CHIP_OFFSET_ADDR(i));\r\n}\r\nreturn 0;\r\n}\r\nint tw28_get_video_status(struct solo_dev *solo_dev, u8 ch)\r\n{\r\nu8 val, chip_num;\r\nchip_num = ch / 4;\r\nch %= 4;\r\nval = tw_readbyte(solo_dev, chip_num, TW286x_AV_STAT_ADDR,\r\nTW_AV_STAT_ADDR) & 0x0f;\r\nreturn val & (1 << ch) ? 1 : 0;\r\n}\r\nbool tw28_has_sharpness(struct solo_dev *solo_dev, u8 ch)\r\n{\r\nreturn is_tw286x(solo_dev, ch / 4);\r\n}\r\nint tw28_set_ctrl_val(struct solo_dev *solo_dev, u32 ctrl, u8 ch,\r\ns32 val)\r\n{\r\nchar sval;\r\nu8 chip_num;\r\nchip_num = ch / 4;\r\nch %= 4;\r\nif (val > 255 || val < 0)\r\nreturn -ERANGE;\r\nswitch (ctrl) {\r\ncase V4L2_CID_SHARPNESS:\r\nif (is_tw286x(solo_dev, chip_num)) {\r\nu8 v = solo_i2c_readbyte(solo_dev, SOLO_I2C_TW,\r\nTW_CHIP_OFFSET_ADDR(chip_num),\r\nTW286x_SHARPNESS(chip_num));\r\nv &= 0xf0;\r\nv |= val;\r\nsolo_i2c_writebyte(solo_dev, SOLO_I2C_TW,\r\nTW_CHIP_OFFSET_ADDR(chip_num),\r\nTW286x_SHARPNESS(chip_num), v);\r\n} else {\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase V4L2_CID_HUE:\r\nif (is_tw286x(solo_dev, chip_num))\r\nsval = val - 128;\r\nelse\r\nsval = (char)val;\r\ntw_writebyte(solo_dev, chip_num, TW286x_HUE_ADDR(ch),\r\nTW_HUE_ADDR(ch), sval);\r\nbreak;\r\ncase V4L2_CID_SATURATION:\r\nif (is_tw286x(solo_dev, chip_num)) {\r\nsolo_i2c_writebyte(solo_dev, SOLO_I2C_TW,\r\nTW_CHIP_OFFSET_ADDR(chip_num),\r\nTW286x_SATURATIONU_ADDR(ch), val);\r\n}\r\ntw_writebyte(solo_dev, chip_num, TW286x_SATURATIONV_ADDR(ch),\r\nTW_SATURATION_ADDR(ch), val);\r\nbreak;\r\ncase V4L2_CID_CONTRAST:\r\ntw_writebyte(solo_dev, chip_num, TW286x_CONTRAST_ADDR(ch),\r\nTW_CONTRAST_ADDR(ch), val);\r\nbreak;\r\ncase V4L2_CID_BRIGHTNESS:\r\nif (is_tw286x(solo_dev, chip_num))\r\nsval = val - 128;\r\nelse\r\nsval = (char)val;\r\ntw_writebyte(solo_dev, chip_num, TW286x_BRIGHTNESS_ADDR(ch),\r\nTW_BRIGHTNESS_ADDR(ch), sval);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint tw28_get_ctrl_val(struct solo_dev *solo_dev, u32 ctrl, u8 ch,\r\ns32 *val)\r\n{\r\nu8 rval, chip_num;\r\nchip_num = ch / 4;\r\nch %= 4;\r\nswitch (ctrl) {\r\ncase V4L2_CID_SHARPNESS:\r\nif (is_tw286x(solo_dev, chip_num)) {\r\nrval = solo_i2c_readbyte(solo_dev, SOLO_I2C_TW,\r\nTW_CHIP_OFFSET_ADDR(chip_num),\r\nTW286x_SHARPNESS(chip_num));\r\n*val = rval & 0x0f;\r\n} else\r\n*val = 0;\r\nbreak;\r\ncase V4L2_CID_HUE:\r\nrval = tw_readbyte(solo_dev, chip_num, TW286x_HUE_ADDR(ch),\r\nTW_HUE_ADDR(ch));\r\nif (is_tw286x(solo_dev, chip_num))\r\n*val = (s32)((char)rval) + 128;\r\nelse\r\n*val = rval;\r\nbreak;\r\ncase V4L2_CID_SATURATION:\r\n*val = tw_readbyte(solo_dev, chip_num,\r\nTW286x_SATURATIONU_ADDR(ch),\r\nTW_SATURATION_ADDR(ch));\r\nbreak;\r\ncase V4L2_CID_CONTRAST:\r\n*val = tw_readbyte(solo_dev, chip_num,\r\nTW286x_CONTRAST_ADDR(ch),\r\nTW_CONTRAST_ADDR(ch));\r\nbreak;\r\ncase V4L2_CID_BRIGHTNESS:\r\nrval = tw_readbyte(solo_dev, chip_num,\r\nTW286x_BRIGHTNESS_ADDR(ch),\r\nTW_BRIGHTNESS_ADDR(ch));\r\nif (is_tw286x(solo_dev, chip_num))\r\n*val = (s32)((char)rval) + 128;\r\nelse\r\n*val = rval;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nu8 tw28_get_audio_gain(struct solo_dev *solo_dev, u8 ch)\r\n{\r\nu8 val;\r\nu8 chip_num;\r\nchip_num = ch / 4;\r\nch %= 4;\r\nval = tw_readbyte(solo_dev, chip_num,\r\nTW286x_AUDIO_INPUT_GAIN_ADDR(ch),\r\nTW_AUDIO_INPUT_GAIN_ADDR(ch));\r\nreturn (ch % 2) ? (val >> 4) : (val & 0x0f);\r\n}\r\nvoid tw28_set_audio_gain(struct solo_dev *solo_dev, u8 ch, u8 val)\r\n{\r\nu8 old_val;\r\nu8 chip_num;\r\nchip_num = ch / 4;\r\nch %= 4;\r\nold_val = tw_readbyte(solo_dev, chip_num,\r\nTW286x_AUDIO_INPUT_GAIN_ADDR(ch),\r\nTW_AUDIO_INPUT_GAIN_ADDR(ch));\r\nval = (old_val & ((ch % 2) ? 0x0f : 0xf0)) |\r\n((ch % 2) ? (val << 4) : val);\r\ntw_writebyte(solo_dev, chip_num, TW286x_AUDIO_INPUT_GAIN_ADDR(ch),\r\nTW_AUDIO_INPUT_GAIN_ADDR(ch), val);\r\n}

void usbip_unbind_usage(void)\r\n{\r\nprintf("usage: %s", usbip_unbind_usage_string);\r\n}\r\nstatic int unbind_device(char *busid)\r\n{\r\nchar bus_type[] = "usb";\r\nint rc, ret = -1;\r\nchar unbind_attr_name[] = "unbind";\r\nchar unbind_attr_path[SYSFS_PATH_MAX];\r\nchar rebind_attr_name[] = "rebind";\r\nchar rebind_attr_path[SYSFS_PATH_MAX];\r\nstruct udev *udev;\r\nstruct udev_device *dev;\r\nconst char *driver;\r\nudev = udev_new();\r\ndev = udev_device_new_from_subsystem_sysname(udev, "usb", busid);\r\nif (!dev) {\r\nerr("device with the specified bus ID does not exist");\r\ngoto err_close_udev;\r\n}\r\ndriver = udev_device_get_driver(dev);\r\nif (!driver || strcmp(driver, "usbip-host")) {\r\nerr("device is not bound to usbip-host driver");\r\ngoto err_close_udev;\r\n}\r\nsnprintf(unbind_attr_path, sizeof(unbind_attr_path), "%s/%s/%s/%s/%s/%s",\r\nSYSFS_MNT_PATH, SYSFS_BUS_NAME, bus_type, SYSFS_DRIVERS_NAME,\r\nUSBIP_HOST_DRV_NAME, unbind_attr_name);\r\nrc = write_sysfs_attribute(unbind_attr_path, busid, strlen(busid));\r\nif (rc < 0) {\r\nerr("error unbinding device %s from driver", busid);\r\ngoto err_close_udev;\r\n}\r\nrc = modify_match_busid(busid, 0);\r\nif (rc < 0) {\r\nerr("unable to unbind device on %s", busid);\r\ngoto err_close_udev;\r\n}\r\nsnprintf(rebind_attr_path, sizeof(unbind_attr_path), "%s/%s/%s/%s/%s/%s",\r\nSYSFS_MNT_PATH, SYSFS_BUS_NAME, bus_type, SYSFS_DRIVERS_NAME,\r\nUSBIP_HOST_DRV_NAME, rebind_attr_name);\r\nrc = write_sysfs_attribute(rebind_attr_path, busid, strlen(busid));\r\nif (rc < 0) {\r\nerr("error rebinding");\r\ngoto err_close_udev;\r\n}\r\nret = 0;\r\ninfo("unbind device on busid %s: complete", busid);\r\nerr_close_udev:\r\nudev_device_unref(dev);\r\nudev_unref(udev);\r\nreturn ret;\r\n}\r\nint usbip_unbind(int argc, char *argv[])\r\n{\r\nstatic const struct option opts[] = {\r\n{ "busid", required_argument, NULL, 'b' },\r\n{ NULL, 0, NULL, 0 }\r\n};\r\nint opt;\r\nint ret = -1;\r\nfor (;;) {\r\nopt = getopt_long(argc, argv, "b:", opts, NULL);\r\nif (opt == -1)\r\nbreak;\r\nswitch (opt) {\r\ncase 'b':\r\nret = unbind_device(optarg);\r\ngoto out;\r\ndefault:\r\ngoto err_out;\r\n}\r\n}\r\nerr_out:\r\nusbip_unbind_usage();\r\nout:\r\nreturn ret;\r\n}

uint r8712_is_cckrates_included(u8 *rate)\r\n{\r\nu32 i = 0;\r\nwhile (rate[i] != 0) {\r\nif ((((rate[i]) & 0x7f) == 2) || (((rate[i]) & 0x7f) == 4) ||\r\n(((rate[i]) & 0x7f) == 11) || (((rate[i]) & 0x7f) == 22))\r\nreturn true;\r\ni++;\r\n}\r\nreturn false;\r\n}\r\nuint r8712_is_cckratesonly_included(u8 *rate)\r\n{\r\nu32 i = 0;\r\nwhile (rate[i] != 0) {\r\nif ((((rate[i]) & 0x7f) != 2) && (((rate[i]) & 0x7f) != 4) &&\r\n(((rate[i]) & 0x7f) != 11) && (((rate[i]) & 0x7f) != 22))\r\nreturn false;\r\ni++;\r\n}\r\nreturn true;\r\n}\r\nu8 *r8712_set_ie(u8 *pbuf, sint index, uint len, u8 *source, uint *frlen)\r\n{\r\n*pbuf = (u8)index;\r\n*(pbuf + 1) = (u8)len;\r\nif (len > 0)\r\nmemcpy((void *)(pbuf + 2), (void *)source, len);\r\n*frlen = *frlen + (len + 2);\r\nreturn pbuf + len + 2;\r\n}\r\nu8 *r8712_get_ie(u8 *pbuf, sint index, sint *len, sint limit)\r\n{\r\nsint tmp, i;\r\nu8 *p;\r\nif (limit < 1)\r\nreturn NULL;\r\np = pbuf;\r\ni = 0;\r\n*len = 0;\r\nwhile (1) {\r\nif (*p == index) {\r\n*len = *(p + 1);\r\nreturn p;\r\n} else {\r\ntmp = *(p + 1);\r\np += (tmp + 2);\r\ni += (tmp + 2);\r\n}\r\nif (i >= limit)\r\nbreak;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void set_supported_rate(u8 *SupportedRates, uint mode)\r\n{\r\nmemset(SupportedRates, 0, NDIS_802_11_LENGTH_RATES_EX);\r\nswitch (mode) {\r\ncase WIRELESS_11B:\r\nmemcpy(SupportedRates, WIFI_CCKRATES,\r\nIEEE80211_CCK_RATE_LEN);\r\nbreak;\r\ncase WIRELESS_11G:\r\ncase WIRELESS_11A:\r\nmemcpy(SupportedRates, WIFI_OFDMRATES,\r\nIEEE80211_NUM_OFDM_RATESLEN);\r\nbreak;\r\ncase WIRELESS_11BG:\r\nmemcpy(SupportedRates, WIFI_CCKRATES, IEEE80211_CCK_RATE_LEN);\r\nmemcpy(SupportedRates + IEEE80211_CCK_RATE_LEN, WIFI_OFDMRATES,\r\nIEEE80211_NUM_OFDM_RATESLEN);\r\nbreak;\r\n}\r\n}\r\nstatic uint r8712_get_rateset_len(u8 *rateset)\r\n{\r\nuint i = 0;\r\nwhile (1) {\r\nif ((rateset[i]) == 0)\r\nbreak;\r\nif (i > 12)\r\nbreak;\r\ni++;\r\n}\r\nreturn i;\r\n}\r\nint r8712_generate_ie(struct registry_priv *pregistrypriv)\r\n{\r\nint sz = 0, rateLen;\r\nstruct wlan_bssid_ex *pdev_network = &pregistrypriv->dev_network;\r\nu8 *ie = pdev_network->IEs;\r\nsz += 8;\r\nie += sz;\r\n*(u16 *)ie = cpu_to_le16((u16)pdev_network->Configuration.BeaconPeriod);\r\nsz += 2;\r\nie += 2;\r\n*(u16 *)ie = 0;\r\n*(u16 *)ie |= cpu_to_le16(cap_IBSS);\r\nif (pregistrypriv->preamble == PREAMBLE_SHORT)\r\n*(u16 *)ie |= cpu_to_le16(cap_ShortPremble);\r\nif (pdev_network->Privacy)\r\n*(u16 *)ie |= cpu_to_le16(cap_Privacy);\r\nsz += 2;\r\nie += 2;\r\nie = r8712_set_ie(ie, _SSID_IE_, pdev_network->Ssid.SsidLength,\r\npdev_network->Ssid.Ssid, &sz);\r\nset_supported_rate(pdev_network->SupportedRates,\r\npregistrypriv->wireless_mode);\r\nrateLen = r8712_get_rateset_len(pdev_network->SupportedRates);\r\nif (rateLen > 8) {\r\nie = r8712_set_ie(ie, _SUPPORTEDRATES_IE_, 8,\r\npdev_network->SupportedRates, &sz);\r\nie = r8712_set_ie(ie, _EXT_SUPPORTEDRATES_IE_, (rateLen - 8),\r\n(pdev_network->SupportedRates + 8), &sz);\r\n} else\r\nie = r8712_set_ie(ie, _SUPPORTEDRATES_IE_,\r\nrateLen, pdev_network->SupportedRates, &sz);\r\nie = r8712_set_ie(ie, _DSSET_IE_, 1,\r\n(u8 *)&(pdev_network->Configuration.DSConfig), &sz);\r\nie = r8712_set_ie(ie, _IBSS_PARA_IE_, 2,\r\n(u8 *)&(pdev_network->Configuration.ATIMWindow), &sz);\r\nreturn sz;\r\n}\r\nunsigned char *r8712_get_wpa_ie(unsigned char *pie, int *wpa_ie_len, int limit)\r\n{\r\nint len;\r\nu16 val16;\r\nunsigned char wpa_oui_type[] = {0x00, 0x50, 0xf2, 0x01};\r\nu8 *pbuf = pie;\r\nwhile (1) {\r\npbuf = r8712_get_ie(pbuf, _WPA_IE_ID_, &len, limit);\r\nif (pbuf) {\r\nif (memcmp((pbuf + 2), wpa_oui_type,\r\nsizeof(wpa_oui_type)))\r\ngoto check_next_ie;\r\nmemcpy((u8 *)&val16, (pbuf + 6), sizeof(val16));\r\nval16 = le16_to_cpu(val16);\r\nif (val16 != 0x0001)\r\ngoto check_next_ie;\r\n*wpa_ie_len = *(pbuf + 1);\r\nreturn pbuf;\r\n} else {\r\n*wpa_ie_len = 0;\r\nreturn NULL;\r\n}\r\ncheck_next_ie:\r\nlimit = limit - (pbuf - pie) - 2 - len;\r\nif (limit <= 0)\r\nbreak;\r\npbuf += (2 + len);\r\n}\r\n*wpa_ie_len = 0;\r\nreturn NULL;\r\n}\r\nunsigned char *r8712_get_wpa2_ie(unsigned char *pie, int *rsn_ie_len, int limit)\r\n{\r\nreturn r8712_get_ie(pie, _WPA2_IE_ID_, rsn_ie_len, limit);\r\n}\r\nstatic int r8712_get_wpa_cipher_suite(u8 *s)\r\n{\r\nif (!memcmp(s, (void *)WPA_CIPHER_SUITE_NONE, WPA_SELECTOR_LEN))\r\nreturn WPA_CIPHER_NONE;\r\nif (!memcmp(s, (void *)WPA_CIPHER_SUITE_WEP40, WPA_SELECTOR_LEN))\r\nreturn WPA_CIPHER_WEP40;\r\nif (!memcmp(s, (void *)WPA_CIPHER_SUITE_TKIP, WPA_SELECTOR_LEN))\r\nreturn WPA_CIPHER_TKIP;\r\nif (!memcmp(s, (void *)WPA_CIPHER_SUITE_CCMP, WPA_SELECTOR_LEN))\r\nreturn WPA_CIPHER_CCMP;\r\nif (!memcmp(s, (void *)WPA_CIPHER_SUITE_WEP104, WPA_SELECTOR_LEN))\r\nreturn WPA_CIPHER_WEP104;\r\nreturn 0;\r\n}\r\nstatic int r8712_get_wpa2_cipher_suite(u8 *s)\r\n{\r\nif (!memcmp(s, (void *)RSN_CIPHER_SUITE_NONE, RSN_SELECTOR_LEN))\r\nreturn WPA_CIPHER_NONE;\r\nif (!memcmp(s, (void *)RSN_CIPHER_SUITE_WEP40, RSN_SELECTOR_LEN))\r\nreturn WPA_CIPHER_WEP40;\r\nif (!memcmp(s, (void *)RSN_CIPHER_SUITE_TKIP, RSN_SELECTOR_LEN))\r\nreturn WPA_CIPHER_TKIP;\r\nif (!memcmp(s, (void *)RSN_CIPHER_SUITE_CCMP, RSN_SELECTOR_LEN))\r\nreturn WPA_CIPHER_CCMP;\r\nif (!memcmp(s, (void *)RSN_CIPHER_SUITE_WEP104, RSN_SELECTOR_LEN))\r\nreturn WPA_CIPHER_WEP104;\r\nreturn 0;\r\n}\r\nint r8712_parse_wpa_ie(u8 *wpa_ie, int wpa_ie_len, int *group_cipher,\r\nint *pairwise_cipher)\r\n{\r\nint i;\r\nint left, count;\r\nu8 *pos;\r\nif (wpa_ie_len <= 0) {\r\nreturn _FAIL;\r\n}\r\nif ((*wpa_ie != _WPA_IE_ID_) || (*(wpa_ie + 1) != (u8)(wpa_ie_len - 2))\r\n|| (memcmp(wpa_ie + 2, (void *)WPA_OUI_TYPE, WPA_SELECTOR_LEN)))\r\nreturn _FAIL;\r\npos = wpa_ie;\r\npos += 8;\r\nleft = wpa_ie_len - 8;\r\nif (left >= WPA_SELECTOR_LEN) {\r\n*group_cipher = r8712_get_wpa_cipher_suite(pos);\r\npos += WPA_SELECTOR_LEN;\r\nleft -= WPA_SELECTOR_LEN;\r\n} else if (left > 0)\r\nreturn _FAIL;\r\nif (left >= 2) {\r\ncount = le16_to_cpu(*(u16 *)pos);\r\npos += 2;\r\nleft -= 2;\r\nif (count == 0 || left < count * WPA_SELECTOR_LEN)\r\nreturn _FAIL;\r\nfor (i = 0; i < count; i++) {\r\n*pairwise_cipher |= r8712_get_wpa_cipher_suite(pos);\r\npos += WPA_SELECTOR_LEN;\r\nleft -= WPA_SELECTOR_LEN;\r\n}\r\n} else if (left == 1)\r\nreturn _FAIL;\r\nreturn _SUCCESS;\r\n}\r\nint r8712_parse_wpa2_ie(u8 *rsn_ie, int rsn_ie_len, int *group_cipher,\r\nint *pairwise_cipher)\r\n{\r\nint i;\r\nint left, count;\r\nu8 *pos;\r\nif (rsn_ie_len <= 0) {\r\nreturn _FAIL;\r\n}\r\nif ((*rsn_ie != _WPA2_IE_ID_) || (*(rsn_ie+1) != (u8)(rsn_ie_len - 2)))\r\nreturn _FAIL;\r\npos = rsn_ie;\r\npos += 4;\r\nleft = rsn_ie_len - 4;\r\nif (left >= RSN_SELECTOR_LEN) {\r\n*group_cipher = r8712_get_wpa2_cipher_suite(pos);\r\npos += RSN_SELECTOR_LEN;\r\nleft -= RSN_SELECTOR_LEN;\r\n} else if (left > 0)\r\nreturn _FAIL;\r\nif (left >= 2) {\r\ncount = le16_to_cpu(*(u16 *)pos);\r\npos += 2;\r\nleft -= 2;\r\nif (count == 0 || left < count * RSN_SELECTOR_LEN)\r\nreturn _FAIL;\r\nfor (i = 0; i < count; i++) {\r\n*pairwise_cipher |= r8712_get_wpa2_cipher_suite(pos);\r\npos += RSN_SELECTOR_LEN;\r\nleft -= RSN_SELECTOR_LEN;\r\n}\r\n} else if (left == 1)\r\nreturn _FAIL;\r\nreturn _SUCCESS;\r\n}\r\nint r8712_get_sec_ie(u8 *in_ie, uint in_len, u8 *rsn_ie, u16 *rsn_len,\r\nu8 *wpa_ie, u16 *wpa_len)\r\n{\r\nu8 authmode, sec_idx;\r\nu8 wpa_oui[4] = {0x0, 0x50, 0xf2, 0x01};\r\nuint cnt;\r\ncnt = (_TIMESTAMP_ + _BEACON_ITERVAL_ + _CAPABILITY_);\r\nsec_idx = 0;\r\nwhile (cnt < in_len) {\r\nauthmode = in_ie[cnt];\r\nif ((authmode == _WPA_IE_ID_) &&\r\n(!memcmp(&in_ie[cnt + 2], &wpa_oui[0], 4))) {\r\nmemcpy(wpa_ie, &in_ie[cnt], in_ie[cnt + 1] + 2);\r\n*wpa_len = in_ie[cnt+1]+2;\r\ncnt += in_ie[cnt + 1] + 2;\r\n} else {\r\nif (authmode == _WPA2_IE_ID_) {\r\nmemcpy(rsn_ie, &in_ie[cnt],\r\nin_ie[cnt + 1] + 2);\r\n*rsn_len = in_ie[cnt+1] + 2;\r\ncnt += in_ie[cnt+1] + 2;\r\n} else\r\ncnt += in_ie[cnt+1] + 2;\r\n}\r\n}\r\nreturn *rsn_len + *wpa_len;\r\n}\r\nint r8712_get_wps_ie(u8 *in_ie, uint in_len, u8 *wps_ie, uint *wps_ielen)\r\n{\r\nint match;\r\nuint cnt;\r\nu8 eid, wps_oui[4] = {0x0, 0x50, 0xf2, 0x04};\r\ncnt = 12;\r\nmatch = false;\r\nwhile (cnt < in_len) {\r\neid = in_ie[cnt];\r\nif ((eid == _WPA_IE_ID_) &&\r\n(!memcmp(&in_ie[cnt+2], wps_oui, 4))) {\r\nmemcpy(wps_ie, &in_ie[cnt], in_ie[cnt+1]+2);\r\n*wps_ielen = in_ie[cnt+1]+2;\r\ncnt += in_ie[cnt+1]+2;\r\nmatch = true;\r\nbreak;\r\n} else\r\ncnt += in_ie[cnt+1]+2;\r\n}\r\nreturn match;\r\n}

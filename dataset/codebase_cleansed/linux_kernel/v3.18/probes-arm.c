void __kprobes simulate_bbl(probes_opcode_t insn,\r\nstruct arch_probes_insn *asi, struct pt_regs *regs)\r\n{\r\nlong iaddr = (long) regs->ARM_pc - 4;\r\nint disp = branch_displacement(insn);\r\nif (insn & (1 << 24))\r\nregs->ARM_lr = iaddr + 4;\r\nregs->ARM_pc = iaddr + 8 + disp;\r\n}\r\nvoid __kprobes simulate_blx1(probes_opcode_t insn,\r\nstruct arch_probes_insn *asi, struct pt_regs *regs)\r\n{\r\nlong iaddr = (long) regs->ARM_pc - 4;\r\nint disp = branch_displacement(insn);\r\nregs->ARM_lr = iaddr + 4;\r\nregs->ARM_pc = iaddr + 8 + disp + ((insn >> 23) & 0x2);\r\nregs->ARM_cpsr |= PSR_T_BIT;\r\n}\r\nvoid __kprobes simulate_blx2bx(probes_opcode_t insn,\r\nstruct arch_probes_insn *asi, struct pt_regs *regs)\r\n{\r\nint rm = insn & 0xf;\r\nlong rmv = regs->uregs[rm];\r\nif (insn & (1 << 5))\r\nregs->ARM_lr = (long) regs->ARM_pc;\r\nregs->ARM_pc = rmv & ~0x1;\r\nregs->ARM_cpsr &= ~PSR_T_BIT;\r\nif (rmv & 0x1)\r\nregs->ARM_cpsr |= PSR_T_BIT;\r\n}\r\nvoid __kprobes simulate_mrs(probes_opcode_t insn,\r\nstruct arch_probes_insn *asi, struct pt_regs *regs)\r\n{\r\nint rd = (insn >> 12) & 0xf;\r\nunsigned long mask = 0xf8ff03df;\r\nregs->uregs[rd] = regs->ARM_cpsr & mask;\r\n}\r\nvoid __kprobes simulate_mov_ipsp(probes_opcode_t insn,\r\nstruct arch_probes_insn *asi, struct pt_regs *regs)\r\n{\r\nregs->uregs[12] = regs->uregs[13];\r\n}\r\nstatic void __kprobes arm_singlestep(probes_opcode_t insn,\r\nstruct arch_probes_insn *asi, struct pt_regs *regs)\r\n{\r\nregs->ARM_pc += 4;\r\nasi->insn_handler(insn, asi, regs);\r\n}\r\nenum probes_insn __kprobes\r\narm_probes_decode_insn(probes_opcode_t insn, struct arch_probes_insn *asi,\r\nbool emulate, const union decode_action *actions)\r\n{\r\nasi->insn_singlestep = arm_singlestep;\r\nasi->insn_check_cc = probes_condition_checks[insn>>28];\r\nreturn probes_decode_insn(insn, asi, probes_decode_arm_table, false,\r\nemulate, actions);\r\n}

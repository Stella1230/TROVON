static void dc_pad_callback(struct mapleq *mq)\r\n{\r\nunsigned short buttons;\r\nstruct maple_device *mapledev = mq->dev;\r\nstruct dc_pad *pad = maple_get_drvdata(mapledev);\r\nstruct input_dev *dev = pad->dev;\r\nunsigned char *res = mq->recvbuf->buf;\r\nbuttons = ~le16_to_cpup((__le16 *)(res + 8));\r\ninput_report_abs(dev, ABS_HAT0Y,\r\n(buttons & 0x0010 ? -1 : 0) + (buttons & 0x0020 ? 1 : 0));\r\ninput_report_abs(dev, ABS_HAT0X,\r\n(buttons & 0x0040 ? -1 : 0) + (buttons & 0x0080 ? 1 : 0));\r\ninput_report_abs(dev, ABS_HAT1Y,\r\n(buttons & 0x1000 ? -1 : 0) + (buttons & 0x2000 ? 1 : 0));\r\ninput_report_abs(dev, ABS_HAT1X,\r\n(buttons & 0x4000 ? -1 : 0) + (buttons & 0x8000 ? 1 : 0));\r\ninput_report_key(dev, BTN_C, buttons & 0x0001);\r\ninput_report_key(dev, BTN_B, buttons & 0x0002);\r\ninput_report_key(dev, BTN_A, buttons & 0x0004);\r\ninput_report_key(dev, BTN_START, buttons & 0x0008);\r\ninput_report_key(dev, BTN_Z, buttons & 0x0100);\r\ninput_report_key(dev, BTN_Y, buttons & 0x0200);\r\ninput_report_key(dev, BTN_X, buttons & 0x0400);\r\ninput_report_key(dev, BTN_SELECT, buttons & 0x0800);\r\ninput_report_abs(dev, ABS_GAS, res[10]);\r\ninput_report_abs(dev, ABS_BRAKE, res[11]);\r\ninput_report_abs(dev, ABS_X, res[12]);\r\ninput_report_abs(dev, ABS_Y, res[13]);\r\ninput_report_abs(dev, ABS_RX, res[14]);\r\ninput_report_abs(dev, ABS_RY, res[15]);\r\n}\r\nstatic int dc_pad_open(struct input_dev *dev)\r\n{\r\nstruct dc_pad *pad = dev_get_platdata(&dev->dev);\r\nmaple_getcond_callback(pad->mdev, dc_pad_callback, HZ/20,\r\nMAPLE_FUNC_CONTROLLER);\r\nreturn 0;\r\n}\r\nstatic void dc_pad_close(struct input_dev *dev)\r\n{\r\nstruct dc_pad *pad = dev_get_platdata(&dev->dev);\r\nmaple_getcond_callback(pad->mdev, dc_pad_callback, 0,\r\nMAPLE_FUNC_CONTROLLER);\r\n}\r\nstatic int probe_maple_controller(struct device *dev)\r\n{\r\nstatic const short btn_bit[32] = {\r\nBTN_C, BTN_B, BTN_A, BTN_START, -1, -1, -1, -1,\r\nBTN_Z, BTN_Y, BTN_X, BTN_SELECT, -1, -1, -1, -1,\r\n-1, -1, -1, -1, -1, -1, -1, -1,\r\n-1, -1, -1, -1, -1, -1, -1, -1,\r\n};\r\nstatic const short abs_bit[32] = {\r\n-1, -1, -1, -1, ABS_HAT0Y, ABS_HAT0Y, ABS_HAT0X, ABS_HAT0X,\r\n-1, -1, -1, -1, ABS_HAT1Y, ABS_HAT1Y, ABS_HAT1X, ABS_HAT1X,\r\nABS_GAS, ABS_BRAKE, ABS_X, ABS_Y, ABS_RX, ABS_RY, -1, -1,\r\n-1, -1, -1, -1, -1, -1, -1, -1,\r\n};\r\nstruct maple_device *mdev = to_maple_dev(dev);\r\nstruct maple_driver *mdrv = to_maple_driver(dev->driver);\r\nint i, error;\r\nstruct dc_pad *pad;\r\nstruct input_dev *idev;\r\nunsigned long data = be32_to_cpu(mdev->devinfo.function_data[0]);\r\npad = kzalloc(sizeof(struct dc_pad), GFP_KERNEL);\r\nidev = input_allocate_device();\r\nif (!pad || !idev) {\r\nerror = -ENOMEM;\r\ngoto fail;\r\n}\r\npad->dev = idev;\r\npad->mdev = mdev;\r\nidev->open = dc_pad_open;\r\nidev->close = dc_pad_close;\r\nfor (i = 0; i < 32; i++) {\r\nif (data & (1 << i)) {\r\nif (btn_bit[i] >= 0)\r\n__set_bit(btn_bit[i], idev->keybit);\r\nelse if (abs_bit[i] >= 0)\r\n__set_bit(abs_bit[i], idev->absbit);\r\n}\r\n}\r\nif (idev->keybit[BIT_WORD(BTN_JOYSTICK)])\r\nidev->evbit[0] |= BIT_MASK(EV_KEY);\r\nif (idev->absbit[0])\r\nidev->evbit[0] |= BIT_MASK(EV_ABS);\r\nfor (i = ABS_X; i <= ABS_BRAKE; i++)\r\ninput_set_abs_params(idev, i, 0, 255, 0, 0);\r\nfor (i = ABS_HAT0X; i <= ABS_HAT3Y; i++)\r\ninput_set_abs_params(idev, i, 1, -1, 0, 0);\r\nidev->dev.platform_data = pad;\r\nidev->dev.parent = &mdev->dev;\r\nidev->name = mdev->product_name;\r\nidev->id.bustype = BUS_HOST;\r\ninput_set_drvdata(idev, pad);\r\nerror = input_register_device(idev);\r\nif (error)\r\ngoto fail;\r\nmdev->driver = mdrv;\r\nmaple_set_drvdata(mdev, pad);\r\nreturn 0;\r\nfail:\r\ninput_free_device(idev);\r\nkfree(pad);\r\nmaple_set_drvdata(mdev, NULL);\r\nreturn error;\r\n}\r\nstatic int remove_maple_controller(struct device *dev)\r\n{\r\nstruct maple_device *mdev = to_maple_dev(dev);\r\nstruct dc_pad *pad = maple_get_drvdata(mdev);\r\nmdev->callback = NULL;\r\ninput_unregister_device(pad->dev);\r\nmaple_set_drvdata(mdev, NULL);\r\nkfree(pad);\r\nreturn 0;\r\n}\r\nstatic int __init dc_pad_init(void)\r\n{\r\nreturn maple_driver_register(&dc_pad_driver);\r\n}\r\nstatic void __exit dc_pad_exit(void)\r\n{\r\nmaple_driver_unregister(&dc_pad_driver);\r\n}

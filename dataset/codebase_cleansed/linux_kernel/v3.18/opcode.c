static bool opcode_is_prefix(uint8_t b)\r\n{\r\nreturn\r\nb == 0xf0 || b == 0xf2 || b == 0xf3\r\n|| b == 0x2e || b == 0x36 || b == 0x3e || b == 0x26\r\n|| b == 0x64 || b == 0x65\r\n|| b == 0x66\r\n|| b == 0x67;\r\n}\r\nstatic bool opcode_is_rex_prefix(uint8_t b)\r\n{\r\nreturn (b & 0xf0) == 0x40;\r\n}\r\nstatic bool opcode_is_rex_prefix(uint8_t b)\r\n{\r\nreturn false;\r\n}\r\nvoid kmemcheck_opcode_decode(const uint8_t *op, unsigned int *size)\r\n{\r\nint operand_size_override = 4;\r\nfor (; opcode_is_prefix(*op); ++op) {\r\nif (*op == 0x66)\r\noperand_size_override = 2;\r\n}\r\nif (opcode_is_rex_prefix(*op)) {\r\nuint8_t rex = *op;\r\n++op;\r\nif (rex & REX_W) {\r\nswitch (*op) {\r\ncase 0x63:\r\n*size = 4;\r\nreturn;\r\ncase 0x0f:\r\n++op;\r\nswitch (*op) {\r\ncase 0xb6:\r\ncase 0xbe:\r\n*size = 1;\r\nreturn;\r\ncase 0xb7:\r\ncase 0xbf:\r\n*size = 2;\r\nreturn;\r\n}\r\nbreak;\r\n}\r\n*size = 8;\r\nreturn;\r\n}\r\n}\r\nif (*op == 0x0f) {\r\n++op;\r\nif (*op == 0xb7 || *op == 0xbf)\r\noperand_size_override = 2;\r\n}\r\n*size = (*op & 1) ? operand_size_override : 1;\r\n}\r\nconst uint8_t *kmemcheck_opcode_get_primary(const uint8_t *op)\r\n{\r\nwhile (opcode_is_prefix(*op))\r\n++op;\r\nif (opcode_is_rex_prefix(*op))\r\n++op;\r\nreturn op;\r\n}

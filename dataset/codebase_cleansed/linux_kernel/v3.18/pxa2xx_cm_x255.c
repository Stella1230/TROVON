static int cmx255_pcmcia_hw_init(struct soc_pcmcia_socket *skt)\r\n{\r\nint ret = gpio_request(GPIO_PCMCIA_RESET, "PCCard reset");\r\nif (ret)\r\nreturn ret;\r\ngpio_direction_output(GPIO_PCMCIA_RESET, 0);\r\nif (skt->nr == 0) {\r\nskt->stat[SOC_STAT_CD].gpio = GPIO_PCMCIA_S0_CD_VALID;\r\nskt->stat[SOC_STAT_CD].name = "PCMCIA0 CD";\r\nskt->stat[SOC_STAT_RDY].gpio = GPIO_PCMCIA_S0_RDYINT;\r\nskt->stat[SOC_STAT_RDY].name = "PCMCIA0 RDY";\r\n} else {\r\nskt->stat[SOC_STAT_CD].gpio = GPIO_PCMCIA_S1_CD_VALID;\r\nskt->stat[SOC_STAT_CD].name = "PCMCIA1 CD";\r\nskt->stat[SOC_STAT_RDY].gpio = GPIO_PCMCIA_S1_RDYINT;\r\nskt->stat[SOC_STAT_RDY].name = "PCMCIA1 RDY";\r\n}\r\nreturn 0;\r\n}\r\nstatic void cmx255_pcmcia_shutdown(struct soc_pcmcia_socket *skt)\r\n{\r\ngpio_free(GPIO_PCMCIA_RESET);\r\n}\r\nstatic void cmx255_pcmcia_socket_state(struct soc_pcmcia_socket *skt,\r\nstruct pcmcia_state *state)\r\n{\r\nstate->vs_3v = 0;\r\nstate->vs_Xv = 0;\r\n}\r\nstatic int cmx255_pcmcia_configure_socket(struct soc_pcmcia_socket *skt,\r\nconst socket_state_t *state)\r\n{\r\nswitch (skt->nr) {\r\ncase 0:\r\nif (state->flags & SS_RESET) {\r\ngpio_set_value(GPIO_PCMCIA_SKTSEL, 0);\r\nudelay(1);\r\ngpio_set_value(GPIO_PCMCIA_RESET, 1);\r\nudelay(10);\r\ngpio_set_value(GPIO_PCMCIA_RESET, 0);\r\n}\r\nbreak;\r\ncase 1:\r\nif (state->flags & SS_RESET) {\r\ngpio_set_value(GPIO_PCMCIA_SKTSEL, 1);\r\nudelay(1);\r\ngpio_set_value(GPIO_PCMCIA_RESET, 1);\r\nudelay(10);\r\ngpio_set_value(GPIO_PCMCIA_RESET, 0);\r\n}\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nint __init cmx255_pcmcia_init(void)\r\n{\r\nint ret;\r\ncmx255_pcmcia_device = platform_device_alloc("pxa2xx-pcmcia", -1);\r\nif (!cmx255_pcmcia_device)\r\nreturn -ENOMEM;\r\nret = platform_device_add_data(cmx255_pcmcia_device, &cmx255_pcmcia_ops,\r\nsizeof(cmx255_pcmcia_ops));\r\nif (ret == 0) {\r\nprintk(KERN_INFO "Registering cm-x255 PCMCIA interface.\n");\r\nret = platform_device_add(cmx255_pcmcia_device);\r\n}\r\nif (ret)\r\nplatform_device_put(cmx255_pcmcia_device);\r\nreturn ret;\r\n}\r\nvoid __exit cmx255_pcmcia_exit(void)\r\n{\r\nplatform_device_unregister(cmx255_pcmcia_device);\r\n}

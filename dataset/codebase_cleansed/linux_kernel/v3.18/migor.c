static unsigned long siumckb_recalc(struct clk *clk)\r\n{\r\nreturn codec_freq;\r\n}\r\nstatic int migor_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nint ret;\r\nunsigned int rate = params_rate(params);\r\nret = snd_soc_dai_set_sysclk(codec_dai, WM8978_PLL, 13000000,\r\nSND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_clkdiv(codec_dai, WM8978_OPCLKRATE, rate * 512);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_fmt(codec_dai, SND_SOC_DAIFMT_NB_IF |\r\nSND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_CBS_CFS);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_fmt(rtd->cpu_dai, SND_SOC_DAIFMT_NB_IF |\r\nSND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_CBS_CFS);\r\nif (ret < 0)\r\nreturn ret;\r\ncodec_freq = rate * 512;\r\nclk_set_rate(&siumckb_clk, codec_freq);\r\ndev_dbg(codec_dai->dev, "%s: configure %luHz\n", __func__, codec_freq);\r\nret = snd_soc_dai_set_sysclk(rtd->cpu_dai, SIU_CLKB_EXT,\r\ncodec_freq / 2, SND_SOC_CLOCK_IN);\r\nif (!ret)\r\nuse_count++;\r\nreturn ret;\r\n}\r\nstatic int migor_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nif (use_count) {\r\nuse_count--;\r\nif (!use_count)\r\nsnd_soc_dai_set_sysclk(codec_dai, WM8978_PLL, 0,\r\nSND_SOC_CLOCK_IN);\r\n} else {\r\ndev_dbg(codec_dai->dev, "Unbalanced hw_free!\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init migor_init(void)\r\n{\r\nint ret;\r\nret = clk_register(&siumckb_clk);\r\nif (ret < 0)\r\nreturn ret;\r\nsiumckb_lookup = clkdev_alloc(&siumckb_clk, "siumckb_clk", NULL);\r\nif (!siumckb_lookup) {\r\nret = -ENOMEM;\r\ngoto eclkdevalloc;\r\n}\r\nclkdev_add(siumckb_lookup);\r\nmigor_snd_device = platform_device_alloc("soc-audio", 1);\r\nif (!migor_snd_device) {\r\nret = -ENOMEM;\r\ngoto epdevalloc;\r\n}\r\nplatform_set_drvdata(migor_snd_device, &snd_soc_migor);\r\nret = platform_device_add(migor_snd_device);\r\nif (ret)\r\ngoto epdevadd;\r\nreturn 0;\r\nepdevadd:\r\nplatform_device_put(migor_snd_device);\r\nepdevalloc:\r\nclkdev_drop(siumckb_lookup);\r\neclkdevalloc:\r\nclk_unregister(&siumckb_clk);\r\nreturn ret;\r\n}\r\nstatic void __exit migor_exit(void)\r\n{\r\nclkdev_drop(siumckb_lookup);\r\nclk_unregister(&siumckb_clk);\r\nplatform_device_unregister(migor_snd_device);\r\n}

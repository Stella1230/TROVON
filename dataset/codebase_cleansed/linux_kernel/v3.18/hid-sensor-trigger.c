int hid_sensor_power_state(struct hid_sensor_common *st, bool state)\r\n{\r\nint state_val;\r\nint report_val;\r\nif (state) {\r\nif (sensor_hub_device_open(st->hsdev))\r\nreturn -EIO;\r\natomic_inc(&st->data_ready);\r\nstate_val = hid_sensor_get_usage_index(st->hsdev,\r\nst->power_state.report_id,\r\nst->power_state.index,\r\nHID_USAGE_SENSOR_PROP_POWER_STATE_D0_FULL_POWER_ENUM);\r\nreport_val = hid_sensor_get_usage_index(st->hsdev,\r\nst->report_state.report_id,\r\nst->report_state.index,\r\nHID_USAGE_SENSOR_PROP_REPORTING_STATE_ALL_EVENTS_ENUM);\r\n} else {\r\nif (!atomic_dec_and_test(&st->data_ready))\r\nreturn 0;\r\nsensor_hub_device_close(st->hsdev);\r\nstate_val = hid_sensor_get_usage_index(st->hsdev,\r\nst->power_state.report_id,\r\nst->power_state.index,\r\nHID_USAGE_SENSOR_PROP_POWER_STATE_D4_POWER_OFF_ENUM);\r\nreport_val = hid_sensor_get_usage_index(st->hsdev,\r\nst->report_state.report_id,\r\nst->report_state.index,\r\nHID_USAGE_SENSOR_PROP_REPORTING_STATE_NO_EVENTS_ENUM);\r\n}\r\nif (state_val >= 0) {\r\nstate_val += st->power_state.logical_minimum;\r\nsensor_hub_set_feature(st->hsdev, st->power_state.report_id,\r\nst->power_state.index,\r\n(s32)state_val);\r\n}\r\nif (report_val >= 0) {\r\nreport_val += st->report_state.logical_minimum;\r\nsensor_hub_set_feature(st->hsdev, st->report_state.report_id,\r\nst->report_state.index,\r\n(s32)report_val);\r\n}\r\nsensor_hub_get_feature(st->hsdev, st->power_state.report_id,\r\nst->power_state.index,\r\n&state_val);\r\nreturn 0;\r\n}\r\nstatic int hid_sensor_data_rdy_trigger_set_state(struct iio_trigger *trig,\r\nbool state)\r\n{\r\nreturn hid_sensor_power_state(iio_trigger_get_drvdata(trig), state);\r\n}\r\nvoid hid_sensor_remove_trigger(struct hid_sensor_common *attrb)\r\n{\r\niio_trigger_unregister(attrb->trigger);\r\niio_trigger_free(attrb->trigger);\r\n}\r\nint hid_sensor_setup_trigger(struct iio_dev *indio_dev, const char *name,\r\nstruct hid_sensor_common *attrb)\r\n{\r\nint ret;\r\nstruct iio_trigger *trig;\r\ntrig = iio_trigger_alloc("%s-dev%d", name, indio_dev->id);\r\nif (trig == NULL) {\r\ndev_err(&indio_dev->dev, "Trigger Allocate Failed\n");\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\ntrig->dev.parent = indio_dev->dev.parent;\r\niio_trigger_set_drvdata(trig, attrb);\r\ntrig->ops = &hid_sensor_trigger_ops;\r\nret = iio_trigger_register(trig);\r\nif (ret) {\r\ndev_err(&indio_dev->dev, "Trigger Register Failed\n");\r\ngoto error_free_trig;\r\n}\r\nattrb->trigger = trig;\r\nindio_dev->trig = iio_trigger_get(trig);\r\nreturn ret;\r\nerror_free_trig:\r\niio_trigger_free(trig);\r\nerror_ret:\r\nreturn ret;\r\n}

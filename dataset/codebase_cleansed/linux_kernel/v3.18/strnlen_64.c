size_t strnlen(const char *s, size_t count)\r\n{\r\nconst uintptr_t s_int = (uintptr_t) s;\r\nconst uint64_t *p = (const uint64_t *)(s_int & -8);\r\nsize_t bytes_read = sizeof(*p) - (s_int & (sizeof(*p) - 1));\r\nsize_t len;\r\nuint64_t v, bits;\r\nif (count == 0)\r\nreturn 0;\r\nv = *p | MASK(s_int);\r\nwhile ((bits = __insn_v1cmpeqi(v, 0)) == 0) {\r\nif (bytes_read >= count) {\r\nreturn count;\r\n}\r\nv = *++p;\r\nbytes_read += sizeof(v);\r\n}\r\nlen = ((const char *) p) + (CFZ(bits) >> 3) - s;\r\nreturn (len < count ? len : count);\r\n}

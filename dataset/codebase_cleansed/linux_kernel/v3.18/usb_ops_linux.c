void rtl8723au_read_port_cancel(struct rtw_adapter *padapter)\r\n{\r\nstruct recv_buf *precvbuf;\r\nint i;\r\nprecvbuf = (struct recv_buf *)padapter->recvpriv.precv_buf;\r\nDBG_8723A("%s\n", __func__);\r\npadapter->bReadPortCancel = true;\r\nfor (i = 0; i < NR_RECVBUFF ; i++) {\r\nif (precvbuf->purb)\r\nusb_kill_urb(precvbuf->purb);\r\nprecvbuf++;\r\n}\r\nusb_kill_urb(padapter->recvpriv.int_in_urb);\r\n}\r\nstatic void usb_write_port23a_complete(struct urb *purb)\r\n{\r\nstruct xmit_buf *pxmitbuf = (struct xmit_buf *)purb->context;\r\nstruct rtw_adapter *padapter = pxmitbuf->padapter;\r\nstruct xmit_priv *pxmitpriv = &padapter->xmitpriv;\r\nstruct hal_data_8723a *phaldata;\r\nunsigned long irqL;\r\nswitch (pxmitbuf->flags) {\r\ncase VO_QUEUE_INX:\r\npxmitpriv->voq_cnt--;\r\nbreak;\r\ncase VI_QUEUE_INX:\r\npxmitpriv->viq_cnt--;\r\nbreak;\r\ncase BE_QUEUE_INX:\r\npxmitpriv->beq_cnt--;\r\nbreak;\r\ncase BK_QUEUE_INX:\r\npxmitpriv->bkq_cnt--;\r\nbreak;\r\ncase HIGH_QUEUE_INX:\r\n#ifdef CONFIG_8723AU_AP_MODE\r\nrtw_chk_hi_queue_cmd23a(padapter);\r\n#endif\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (padapter->bSurpriseRemoved || padapter->bDriverStopped ||\r\npadapter->bWritePortCancel) {\r\nRT_TRACE(_module_hci_ops_os_c_, _drv_err_,\r\n("usb_write_port23a_complete:bDriverStopped(%d) OR "\r\n"bSurpriseRemoved(%d)", padapter->bDriverStopped,\r\npadapter->bSurpriseRemoved));\r\nDBG_8723A("%s(): TX Warning! bDriverStopped(%d) OR "\r\n"bSurpriseRemoved(%d) bWritePortCancel(%d) "\r\n"pxmitbuf->ext_tag(%x)\n", __func__,\r\npadapter->bDriverStopped, padapter->bSurpriseRemoved,\r\npadapter->bReadPortCancel, pxmitbuf->ext_tag);\r\ngoto check_completion;\r\n}\r\nif (purb->status) {\r\nRT_TRACE(_module_hci_ops_os_c_, _drv_err_,\r\n("usb_write_port23a_complete : purb->status(%d) "\r\n"!= 0\n", purb->status));\r\nDBG_8723A("###=> urb_write_port_complete status(%d)\n",\r\npurb->status);\r\nif (purb->status == -EPIPE || purb->status == -EPROTO) {\r\n} else if (purb->status == -EINPROGRESS) {\r\nRT_TRACE(_module_hci_ops_os_c_, _drv_err_,\r\n("usb_write_port23a_complete: EINPROGESS\n"));\r\ngoto check_completion;\r\n} else if (purb->status == -ENOENT) {\r\nDBG_8723A("%s: -ENOENT\n", __func__);\r\ngoto check_completion;\r\n} else if (purb->status == -ECONNRESET) {\r\nDBG_8723A("%s: -ECONNRESET\n", __func__);\r\ngoto check_completion;\r\n} else if (purb->status == -ESHUTDOWN) {\r\nRT_TRACE(_module_hci_ops_os_c_, _drv_err_,\r\n("usb_write_port23a_complete: ESHUTDOWN\n"));\r\npadapter->bDriverStopped = true;\r\nRT_TRACE(_module_hci_ops_os_c_, _drv_err_,\r\n("usb_write_port23a_complete:bDriverStopped "\r\n"= true\n"));\r\ngoto check_completion;\r\n} else {\r\npadapter->bSurpriseRemoved = true;\r\nDBG_8723A("bSurpriseRemoved = true\n");\r\nRT_TRACE(_module_hci_ops_os_c_, _drv_err_,\r\n("usb_write_port23a_complete:bSurpriseRemoved "\r\n"= true\n"));\r\ngoto check_completion;\r\n}\r\n}\r\nphaldata = GET_HAL_DATA(padapter);\r\nphaldata->srestpriv.last_tx_complete_time = jiffies;\r\ncheck_completion:\r\nspin_lock_irqsave(&pxmitpriv->lock_sctx, irqL);\r\nrtw23a_sctx_done_err(&pxmitbuf->sctx,\r\npurb->status ? RTW_SCTX_DONE_WRITE_PORT_ERR :\r\nRTW_SCTX_DONE_SUCCESS);\r\nspin_unlock_irqrestore(&pxmitpriv->lock_sctx, irqL);\r\nrtw_free_xmitbuf23a(pxmitpriv, pxmitbuf);\r\ntasklet_hi_schedule(&pxmitpriv->xmit_tasklet);\r\n}\r\nint rtl8723au_write_port(struct rtw_adapter *padapter, u32 addr, u32 cnt,\r\nstruct xmit_buf *pxmitbuf)\r\n{\r\nstruct urb *purb = NULL;\r\nstruct dvobj_priv *pdvobj = adapter_to_dvobj(padapter);\r\nstruct xmit_priv *pxmitpriv = &padapter->xmitpriv;\r\nstruct xmit_frame *pxmitframe;\r\nstruct usb_device *pusbd = pdvobj->pusbdev;\r\nunsigned long irqL;\r\nunsigned int pipe, ep_num;\r\nint status;\r\nint ret = _FAIL;\r\nRT_TRACE(_module_hci_ops_os_c_, _drv_err_, ("+usb_write_port23a\n"));\r\nif (padapter->bDriverStopped || padapter->bSurpriseRemoved) {\r\nRT_TRACE(_module_hci_ops_os_c_, _drv_err_,\r\n("%s:(padapter->bDriverStopped || "\r\n"padapter->bSurpriseRemoved)!!!\n", __func__));\r\nrtw23a_sctx_done_err(&pxmitbuf->sctx, RTW_SCTX_DONE_TX_DENY);\r\ngoto exit;\r\n}\r\npxmitframe = (struct xmit_frame *)pxmitbuf->priv_data;\r\nspin_lock_irqsave(&pxmitpriv->lock, irqL);\r\nswitch (addr) {\r\ncase VO_QUEUE_INX:\r\npxmitpriv->voq_cnt++;\r\npxmitbuf->flags = VO_QUEUE_INX;\r\nbreak;\r\ncase VI_QUEUE_INX:\r\npxmitpriv->viq_cnt++;\r\npxmitbuf->flags = VI_QUEUE_INX;\r\nbreak;\r\ncase BE_QUEUE_INX:\r\npxmitpriv->beq_cnt++;\r\npxmitbuf->flags = BE_QUEUE_INX;\r\nbreak;\r\ncase BK_QUEUE_INX:\r\npxmitpriv->bkq_cnt++;\r\npxmitbuf->flags = BK_QUEUE_INX;\r\nbreak;\r\ncase HIGH_QUEUE_INX:\r\npxmitbuf->flags = HIGH_QUEUE_INX;\r\nbreak;\r\ndefault:\r\npxmitbuf->flags = MGT_QUEUE_INX;\r\nbreak;\r\n}\r\nspin_unlock_irqrestore(&pxmitpriv->lock, irqL);\r\npurb = pxmitbuf->pxmit_urb[0];\r\nep_num = pdvobj->Queue2Pipe[addr];\r\npipe = usb_sndbulkpipe(pusbd, ep_num);\r\nusb_fill_bulk_urb(purb, pusbd, pipe,\r\npxmitframe->buf_addr,\r\ncnt, usb_write_port23a_complete,\r\npxmitbuf);\r\nstatus = usb_submit_urb(purb, GFP_ATOMIC);\r\nif (!status) {\r\nstruct hal_data_8723a *phaldata = GET_HAL_DATA(padapter);\r\nphaldata->srestpriv.last_tx_time = jiffies;\r\n} else {\r\nrtw23a_sctx_done_err(&pxmitbuf->sctx,\r\nRTW_SCTX_DONE_WRITE_PORT_ERR);\r\nDBG_8723A("usb_write_port23a, status =%d\n", status);\r\nRT_TRACE(_module_hci_ops_os_c_, _drv_err_,\r\n("usb_write_port23a(): usb_submit_urb, status =%x\n",\r\nstatus));\r\nswitch (status) {\r\ncase -ENODEV:\r\npadapter->bDriverStopped = true;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ngoto exit;\r\n}\r\nret = _SUCCESS;\r\nRT_TRACE(_module_hci_ops_os_c_, _drv_err_, ("-usb_write_port23a\n"));\r\nexit:\r\nif (ret != _SUCCESS)\r\nrtw_free_xmitbuf23a(pxmitpriv, pxmitbuf);\r\nreturn ret;\r\n}\r\nvoid rtl8723au_write_port_cancel(struct rtw_adapter *padapter)\r\n{\r\nstruct xmit_buf *pxmitbuf;\r\nstruct list_head *plist;\r\nint j;\r\nDBG_8723A("%s\n", __func__);\r\npadapter->bWritePortCancel = true;\r\nlist_for_each(plist, &padapter->xmitpriv.xmitbuf_list) {\r\npxmitbuf = container_of(plist, struct xmit_buf, list2);\r\nfor (j = 0; j < 8; j++) {\r\nif (pxmitbuf->pxmit_urb[j])\r\nusb_kill_urb(pxmitbuf->pxmit_urb[j]);\r\n}\r\n}\r\nlist_for_each(plist, &padapter->xmitpriv.xmitextbuf_list) {\r\npxmitbuf = container_of(plist, struct xmit_buf, list2);\r\nfor (j = 0; j < 8; j++) {\r\nif (pxmitbuf->pxmit_urb[j])\r\nusb_kill_urb(pxmitbuf->pxmit_urb[j]);\r\n}\r\n}\r\n}

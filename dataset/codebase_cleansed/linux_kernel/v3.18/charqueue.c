CHARQUEUE *visor_charqueue_create(ulong nslots)\r\n{\r\nint alloc_size = sizeof(CHARQUEUE) + nslots + 1;\r\nCHARQUEUE *cq = kmalloc(alloc_size, GFP_KERNEL|__GFP_NORETRY);\r\nif (cq == NULL) {\r\nERRDRV("visor_charqueue_create allocation failed (alloc_size=%d)",\r\nalloc_size);\r\nreturn NULL;\r\n}\r\ncq->alloc_size = alloc_size;\r\ncq->nslots = nslots;\r\ncq->head = cq->tail = 0;\r\nspin_lock_init(&cq->lock);\r\nreturn cq;\r\n}\r\nvoid visor_charqueue_enqueue(CHARQUEUE *charqueue, unsigned char c)\r\n{\r\nint alloc_slots = charqueue->nslots+1;\r\nspin_lock(&charqueue->lock);\r\ncharqueue->head = (charqueue->head+1) % alloc_slots;\r\nif (charqueue->head == charqueue->tail)\r\ncharqueue->tail = (charqueue->tail+1) % alloc_slots;\r\ncharqueue->buf[charqueue->head] = c;\r\nspin_unlock(&charqueue->lock);\r\n}\r\nBOOL visor_charqueue_is_empty(CHARQUEUE *charqueue)\r\n{\r\nBOOL b;\r\nspin_lock(&charqueue->lock);\r\nb = IS_EMPTY(charqueue);\r\nspin_unlock(&charqueue->lock);\r\nreturn b;\r\n}\r\nstatic int charqueue_dequeue_1(CHARQUEUE *charqueue)\r\n{\r\nint alloc_slots = charqueue->nslots + 1;\r\nif (IS_EMPTY(charqueue))\r\nreturn -1;\r\ncharqueue->tail = (charqueue->tail+1) % alloc_slots;\r\nreturn charqueue->buf[charqueue->tail];\r\n}\r\nint charqueue_dequeue(CHARQUEUE *charqueue)\r\n{\r\nint rc;\r\nspin_lock(&charqueue->lock);\r\nrc = charqueue_dequeue_1(charqueue);\r\nspin_unlock(&charqueue->lock);\r\nreturn rc;\r\n}\r\nint visor_charqueue_dequeue_n(CHARQUEUE *charqueue, unsigned char *buf, int n)\r\n{\r\nint rc, counter = 0, c;\r\nspin_lock(&charqueue->lock);\r\nfor (;;) {\r\nif (n <= 0)\r\nbreak;\r\nc = charqueue_dequeue_1(charqueue);\r\nif (c < 0)\r\nbreak;\r\n*buf = (unsigned char)(c);\r\nbuf++;\r\nn--;\r\ncounter++;\r\n}\r\nrc = counter;\r\nspin_unlock(&charqueue->lock);\r\nreturn rc;\r\n}\r\nvoid visor_charqueue_destroy(CHARQUEUE *charqueue)\r\n{\r\nif (charqueue == NULL)\r\nreturn;\r\nkfree(charqueue);\r\n}

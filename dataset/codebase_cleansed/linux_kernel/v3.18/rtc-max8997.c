static void max8997_rtc_data_to_tm(u8 *data, struct rtc_time *tm,\r\nint rtc_24hr_mode)\r\n{\r\ntm->tm_sec = data[RTC_SEC] & 0x7f;\r\ntm->tm_min = data[RTC_MIN] & 0x7f;\r\nif (rtc_24hr_mode)\r\ntm->tm_hour = data[RTC_HOUR] & 0x1f;\r\nelse {\r\ntm->tm_hour = data[RTC_HOUR] & 0x0f;\r\nif (data[RTC_HOUR] & HOUR_PM_MASK)\r\ntm->tm_hour += 12;\r\n}\r\ntm->tm_wday = fls(data[RTC_WEEKDAY] & 0x7f) - 1;\r\ntm->tm_mday = data[RTC_DATE] & 0x1f;\r\ntm->tm_mon = (data[RTC_MONTH] & 0x0f) - 1;\r\ntm->tm_year = (data[RTC_YEAR] & 0x7f) + 100;\r\ntm->tm_yday = 0;\r\ntm->tm_isdst = 0;\r\n}\r\nstatic int max8997_rtc_tm_to_data(struct rtc_time *tm, u8 *data)\r\n{\r\ndata[RTC_SEC] = tm->tm_sec;\r\ndata[RTC_MIN] = tm->tm_min;\r\ndata[RTC_HOUR] = tm->tm_hour;\r\ndata[RTC_WEEKDAY] = 1 << tm->tm_wday;\r\ndata[RTC_DATE] = tm->tm_mday;\r\ndata[RTC_MONTH] = tm->tm_mon + 1;\r\ndata[RTC_YEAR] = tm->tm_year > 100 ? (tm->tm_year - 100) : 0;\r\nif (tm->tm_year < 100) {\r\npr_warn("%s: MAX8997 RTC cannot handle the year %d."\r\n"Assume it's 2000.\n", __func__, 1900 + tm->tm_year);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int max8997_rtc_set_update_reg(struct max8997_rtc_info *info)\r\n{\r\nint ret;\r\nret = max8997_write_reg(info->rtc, MAX8997_RTC_UPDATE1,\r\nRTC_UDR_MASK);\r\nif (ret < 0)\r\ndev_err(info->dev, "%s: fail to write update reg(%d)\n",\r\n__func__, ret);\r\nelse {\r\nmsleep(20);\r\n}\r\nreturn ret;\r\n}\r\nstatic int max8997_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct max8997_rtc_info *info = dev_get_drvdata(dev);\r\nu8 data[RTC_NR_TIME];\r\nint ret;\r\nmutex_lock(&info->lock);\r\nret = max8997_bulk_read(info->rtc, MAX8997_RTC_SEC, RTC_NR_TIME, data);\r\nmutex_unlock(&info->lock);\r\nif (ret < 0) {\r\ndev_err(info->dev, "%s: fail to read time reg(%d)\n", __func__,\r\nret);\r\nreturn ret;\r\n}\r\nmax8997_rtc_data_to_tm(data, tm, info->rtc_24hr_mode);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int max8997_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct max8997_rtc_info *info = dev_get_drvdata(dev);\r\nu8 data[RTC_NR_TIME];\r\nint ret;\r\nret = max8997_rtc_tm_to_data(tm, data);\r\nif (ret < 0)\r\nreturn ret;\r\nmutex_lock(&info->lock);\r\nret = max8997_bulk_write(info->rtc, MAX8997_RTC_SEC, RTC_NR_TIME, data);\r\nif (ret < 0) {\r\ndev_err(info->dev, "%s: fail to write time reg(%d)\n", __func__,\r\nret);\r\ngoto out;\r\n}\r\nret = max8997_rtc_set_update_reg(info);\r\nout:\r\nmutex_unlock(&info->lock);\r\nreturn ret;\r\n}\r\nstatic int max8997_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct max8997_rtc_info *info = dev_get_drvdata(dev);\r\nu8 data[RTC_NR_TIME];\r\nu8 val;\r\nint i, ret;\r\nmutex_lock(&info->lock);\r\nret = max8997_bulk_read(info->rtc, MAX8997_RTC_ALARM1_SEC, RTC_NR_TIME,\r\ndata);\r\nif (ret < 0) {\r\ndev_err(info->dev, "%s:%d fail to read alarm reg(%d)\n",\r\n__func__, __LINE__, ret);\r\ngoto out;\r\n}\r\nmax8997_rtc_data_to_tm(data, &alrm->time, info->rtc_24hr_mode);\r\nalrm->enabled = 0;\r\nfor (i = 0; i < RTC_NR_TIME; i++) {\r\nif (data[i] & ALARM_ENABLE_MASK) {\r\nalrm->enabled = 1;\r\nbreak;\r\n}\r\n}\r\nalrm->pending = 0;\r\nret = max8997_read_reg(info->max8997->i2c, MAX8997_REG_STATUS1, &val);\r\nif (ret < 0) {\r\ndev_err(info->dev, "%s:%d fail to read status1 reg(%d)\n",\r\n__func__, __LINE__, ret);\r\ngoto out;\r\n}\r\nif (val & (1 << 4))\r\nalrm->pending = 1;\r\nout:\r\nmutex_unlock(&info->lock);\r\nreturn 0;\r\n}\r\nstatic int max8997_rtc_stop_alarm(struct max8997_rtc_info *info)\r\n{\r\nu8 data[RTC_NR_TIME];\r\nint ret, i;\r\nif (!mutex_is_locked(&info->lock))\r\ndev_warn(info->dev, "%s: should have mutex locked\n", __func__);\r\nret = max8997_bulk_read(info->rtc, MAX8997_RTC_ALARM1_SEC, RTC_NR_TIME,\r\ndata);\r\nif (ret < 0) {\r\ndev_err(info->dev, "%s: fail to read alarm reg(%d)\n",\r\n__func__, ret);\r\ngoto out;\r\n}\r\nfor (i = 0; i < RTC_NR_TIME; i++)\r\ndata[i] &= ~ALARM_ENABLE_MASK;\r\nret = max8997_bulk_write(info->rtc, MAX8997_RTC_ALARM1_SEC, RTC_NR_TIME,\r\ndata);\r\nif (ret < 0) {\r\ndev_err(info->dev, "%s: fail to write alarm reg(%d)\n",\r\n__func__, ret);\r\ngoto out;\r\n}\r\nret = max8997_rtc_set_update_reg(info);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int max8997_rtc_start_alarm(struct max8997_rtc_info *info)\r\n{\r\nu8 data[RTC_NR_TIME];\r\nint ret;\r\nif (!mutex_is_locked(&info->lock))\r\ndev_warn(info->dev, "%s: should have mutex locked\n", __func__);\r\nret = max8997_bulk_read(info->rtc, MAX8997_RTC_ALARM1_SEC, RTC_NR_TIME,\r\ndata);\r\nif (ret < 0) {\r\ndev_err(info->dev, "%s: fail to read alarm reg(%d)\n",\r\n__func__, ret);\r\ngoto out;\r\n}\r\ndata[RTC_SEC] |= (1 << ALARM_ENABLE_SHIFT);\r\ndata[RTC_MIN] |= (1 << ALARM_ENABLE_SHIFT);\r\ndata[RTC_HOUR] |= (1 << ALARM_ENABLE_SHIFT);\r\ndata[RTC_WEEKDAY] &= ~ALARM_ENABLE_MASK;\r\nif (data[RTC_MONTH] & 0xf)\r\ndata[RTC_MONTH] |= (1 << ALARM_ENABLE_SHIFT);\r\nif (data[RTC_YEAR] & 0x7f)\r\ndata[RTC_YEAR] |= (1 << ALARM_ENABLE_SHIFT);\r\nif (data[RTC_DATE] & 0x1f)\r\ndata[RTC_DATE] |= (1 << ALARM_ENABLE_SHIFT);\r\nret = max8997_bulk_write(info->rtc, MAX8997_RTC_ALARM1_SEC, RTC_NR_TIME,\r\ndata);\r\nif (ret < 0) {\r\ndev_err(info->dev, "%s: fail to write alarm reg(%d)\n",\r\n__func__, ret);\r\ngoto out;\r\n}\r\nret = max8997_rtc_set_update_reg(info);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int max8997_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct max8997_rtc_info *info = dev_get_drvdata(dev);\r\nu8 data[RTC_NR_TIME];\r\nint ret;\r\nret = max8997_rtc_tm_to_data(&alrm->time, data);\r\nif (ret < 0)\r\nreturn ret;\r\ndev_info(info->dev, "%s: %d-%02d-%02d %02d:%02d:%02d\n", __func__,\r\ndata[RTC_YEAR] + 2000, data[RTC_MONTH], data[RTC_DATE],\r\ndata[RTC_HOUR], data[RTC_MIN], data[RTC_SEC]);\r\nmutex_lock(&info->lock);\r\nret = max8997_rtc_stop_alarm(info);\r\nif (ret < 0)\r\ngoto out;\r\nret = max8997_bulk_write(info->rtc, MAX8997_RTC_ALARM1_SEC, RTC_NR_TIME,\r\ndata);\r\nif (ret < 0) {\r\ndev_err(info->dev, "%s: fail to write alarm reg(%d)\n",\r\n__func__, ret);\r\ngoto out;\r\n}\r\nret = max8997_rtc_set_update_reg(info);\r\nif (ret < 0)\r\ngoto out;\r\nif (alrm->enabled)\r\nret = max8997_rtc_start_alarm(info);\r\nout:\r\nmutex_unlock(&info->lock);\r\nreturn ret;\r\n}\r\nstatic int max8997_rtc_alarm_irq_enable(struct device *dev,\r\nunsigned int enabled)\r\n{\r\nstruct max8997_rtc_info *info = dev_get_drvdata(dev);\r\nint ret;\r\nmutex_lock(&info->lock);\r\nif (enabled)\r\nret = max8997_rtc_start_alarm(info);\r\nelse\r\nret = max8997_rtc_stop_alarm(info);\r\nmutex_unlock(&info->lock);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t max8997_rtc_alarm_irq(int irq, void *data)\r\n{\r\nstruct max8997_rtc_info *info = data;\r\ndev_info(info->dev, "%s:irq(%d)\n", __func__, irq);\r\nrtc_update_irq(info->rtc_dev, 1, RTC_IRQF | RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void max8997_rtc_enable_wtsr(struct max8997_rtc_info *info, bool enable)\r\n{\r\nint ret;\r\nu8 val, mask;\r\nif (!wtsr_en)\r\nreturn;\r\nif (enable)\r\nval = (1 << WTSR_EN_SHIFT) | (3 << WTSRT_SHIFT);\r\nelse\r\nval = 0;\r\nmask = WTSR_EN_MASK | WTSRT_MASK;\r\ndev_info(info->dev, "%s: %s WTSR\n", __func__,\r\nenable ? "enable" : "disable");\r\nret = max8997_update_reg(info->rtc, MAX8997_RTC_WTSR_SMPL, val, mask);\r\nif (ret < 0) {\r\ndev_err(info->dev, "%s: fail to update WTSR reg(%d)\n",\r\n__func__, ret);\r\nreturn;\r\n}\r\nmax8997_rtc_set_update_reg(info);\r\n}\r\nstatic void max8997_rtc_enable_smpl(struct max8997_rtc_info *info, bool enable)\r\n{\r\nint ret;\r\nu8 val, mask;\r\nif (!smpl_en)\r\nreturn;\r\nif (enable)\r\nval = (1 << SMPL_EN_SHIFT) | (0 << SMPLT_SHIFT);\r\nelse\r\nval = 0;\r\nmask = SMPL_EN_MASK | SMPLT_MASK;\r\ndev_info(info->dev, "%s: %s SMPL\n", __func__,\r\nenable ? "enable" : "disable");\r\nret = max8997_update_reg(info->rtc, MAX8997_RTC_WTSR_SMPL, val, mask);\r\nif (ret < 0) {\r\ndev_err(info->dev, "%s: fail to update SMPL reg(%d)\n",\r\n__func__, ret);\r\nreturn;\r\n}\r\nmax8997_rtc_set_update_reg(info);\r\nval = 0;\r\nmax8997_read_reg(info->rtc, MAX8997_RTC_WTSR_SMPL, &val);\r\npr_info("%s: WTSR_SMPL(0x%02x)\n", __func__, val);\r\n}\r\nstatic int max8997_rtc_init_reg(struct max8997_rtc_info *info)\r\n{\r\nu8 data[2];\r\nint ret;\r\ndata[0] = (1 << BCD_EN_SHIFT) | (1 << MODEL24_SHIFT);\r\ndata[1] = (0 << BCD_EN_SHIFT) | (1 << MODEL24_SHIFT);\r\ninfo->rtc_24hr_mode = 1;\r\nret = max8997_bulk_write(info->rtc, MAX8997_RTC_CTRLMASK, 2, data);\r\nif (ret < 0) {\r\ndev_err(info->dev, "%s: fail to write controlm reg(%d)\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\nret = max8997_rtc_set_update_reg(info);\r\nreturn ret;\r\n}\r\nstatic int max8997_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct max8997_dev *max8997 = dev_get_drvdata(pdev->dev.parent);\r\nstruct max8997_rtc_info *info;\r\nint ret, virq;\r\ninfo = devm_kzalloc(&pdev->dev, sizeof(struct max8997_rtc_info),\r\nGFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\nmutex_init(&info->lock);\r\ninfo->dev = &pdev->dev;\r\ninfo->max8997 = max8997;\r\ninfo->rtc = max8997->rtc;\r\nplatform_set_drvdata(pdev, info);\r\nret = max8997_rtc_init_reg(info);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to initialize RTC reg:%d\n", ret);\r\nreturn ret;\r\n}\r\nmax8997_rtc_enable_wtsr(info, true);\r\nmax8997_rtc_enable_smpl(info, true);\r\ndevice_init_wakeup(&pdev->dev, 1);\r\ninfo->rtc_dev = devm_rtc_device_register(&pdev->dev, "max8997-rtc",\r\n&max8997_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(info->rtc_dev)) {\r\nret = PTR_ERR(info->rtc_dev);\r\ndev_err(&pdev->dev, "Failed to register RTC device: %d\n", ret);\r\nreturn ret;\r\n}\r\nvirq = irq_create_mapping(max8997->irq_domain, MAX8997_PMICIRQ_RTCA1);\r\nif (!virq) {\r\ndev_err(&pdev->dev, "Failed to create mapping alarm IRQ\n");\r\nret = -ENXIO;\r\ngoto err_out;\r\n}\r\ninfo->virq = virq;\r\nret = devm_request_threaded_irq(&pdev->dev, virq, NULL,\r\nmax8997_rtc_alarm_irq, 0,\r\n"rtc-alarm0", info);\r\nif (ret < 0)\r\ndev_err(&pdev->dev, "Failed to request alarm IRQ: %d: %d\n",\r\ninfo->virq, ret);\r\nerr_out:\r\nreturn ret;\r\n}\r\nstatic void max8997_rtc_shutdown(struct platform_device *pdev)\r\n{\r\nstruct max8997_rtc_info *info = platform_get_drvdata(pdev);\r\nmax8997_rtc_enable_wtsr(info, false);\r\nmax8997_rtc_enable_smpl(info, false);\r\n}

void *memset(void *s, int c, size_t n)\r\n{\r\nuint32_t *out32;\r\nint n32;\r\nuint32_t v16, v32;\r\nuint8_t *out8 = s;\r\nint to_align32;\r\n#define BYTE_CUTOFF 20\r\n#if BYTE_CUTOFF < 3\r\n#error "BYTE_CUTOFF is too small"\r\n#endif\r\nif (n < BYTE_CUTOFF) {\r\nif (n != 0) {\r\ndo {\r\n*out8 = c;\r\nout8++;\r\n} while (--n != 0);\r\n}\r\nreturn s;\r\n}\r\nwhile (((uintptr_t) out8 & 3) != 0) {\r\n*out8++ = c;\r\n--n;\r\n}\r\nwhile (n & 3)\r\nout8[--n] = c;\r\nout32 = (uint32_t *) out8;\r\nn32 = n >> 2;\r\nv16 = __insn_intlb(c, c);\r\nv32 = __insn_intlh(v16, v16);\r\n#define CACHE_LINE_SIZE_IN_WORDS (CHIP_L2_LINE_SIZE() / 4)\r\nto_align32 =\r\n(-((uintptr_t)out32 >> 2)) & (CACHE_LINE_SIZE_IN_WORDS - 1);\r\nif (to_align32 <= n32 - CACHE_LINE_SIZE_IN_WORDS) {\r\nint lines_left;\r\nn32 -= to_align32;\r\nfor (; to_align32 != 0; to_align32--) {\r\n*out32 = v32;\r\nout32++;\r\n}\r\nlines_left = (unsigned)n32 / CACHE_LINE_SIZE_IN_WORDS;\r\ndo {\r\nint x = ((lines_left < CHIP_MAX_OUTSTANDING_VICTIMS())\r\n? lines_left\r\n: CHIP_MAX_OUTSTANDING_VICTIMS());\r\nuint32_t *wh = out32;\r\nint i = x;\r\nint j;\r\nlines_left -= x;\r\ndo {\r\n__insn_wh64(wh);\r\nwh += CACHE_LINE_SIZE_IN_WORDS;\r\n} while (--i);\r\nfor (j = x * (CACHE_LINE_SIZE_IN_WORDS / 4);\r\nj != 0; j--) {\r\n*out32++ = v32;\r\n*out32++ = v32;\r\n*out32++ = v32;\r\n*out32++ = v32;\r\n}\r\n} while (lines_left != 0);\r\nn32 &= CACHE_LINE_SIZE_IN_WORDS - 1;\r\n}\r\nif (n32 != 0) {\r\ndo {\r\n*out32 = v32;\r\nout32++;\r\n} while (--n32 != 0);\r\n}\r\nreturn s;\r\n}

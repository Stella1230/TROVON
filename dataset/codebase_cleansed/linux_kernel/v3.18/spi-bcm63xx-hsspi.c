static void bcm63xx_hsspi_set_cs(struct bcm63xx_hsspi *bs, unsigned cs,\r\nbool active)\r\n{\r\nu32 reg;\r\nmutex_lock(&bs->bus_mutex);\r\nreg = __raw_readl(bs->regs + HSSPI_GLOBAL_CTRL_REG);\r\nreg &= ~BIT(cs);\r\nif (active == !(bs->cs_polarity & BIT(cs)))\r\nreg |= BIT(cs);\r\n__raw_writel(reg, bs->regs + HSSPI_GLOBAL_CTRL_REG);\r\nmutex_unlock(&bs->bus_mutex);\r\n}\r\nstatic void bcm63xx_hsspi_set_clk(struct bcm63xx_hsspi *bs,\r\nstruct spi_device *spi, int hz)\r\n{\r\nunsigned profile = spi->chip_select;\r\nu32 reg;\r\nreg = DIV_ROUND_UP(2048, DIV_ROUND_UP(bs->speed_hz, hz));\r\n__raw_writel(CLK_CTRL_ACCUM_RST_ON_LOOP | reg,\r\nbs->regs + HSSPI_PROFILE_CLK_CTRL_REG(profile));\r\nreg = __raw_readl(bs->regs + HSSPI_PROFILE_SIGNAL_CTRL_REG(profile));\r\nif (hz > HSSPI_MAX_SYNC_CLOCK)\r\nreg |= SIGNAL_CTRL_ASYNC_INPUT_PATH;\r\nelse\r\nreg &= ~SIGNAL_CTRL_ASYNC_INPUT_PATH;\r\n__raw_writel(reg, bs->regs + HSSPI_PROFILE_SIGNAL_CTRL_REG(profile));\r\nmutex_lock(&bs->bus_mutex);\r\nreg = __raw_readl(bs->regs + HSSPI_GLOBAL_CTRL_REG);\r\nreg &= ~GLOBAL_CTRL_CLK_POLARITY;\r\nif (spi->mode & SPI_CPOL)\r\nreg |= GLOBAL_CTRL_CLK_POLARITY;\r\n__raw_writel(reg, bs->regs + HSSPI_GLOBAL_CTRL_REG);\r\nmutex_unlock(&bs->bus_mutex);\r\n}\r\nstatic int bcm63xx_hsspi_do_txrx(struct spi_device *spi, struct spi_transfer *t)\r\n{\r\nstruct bcm63xx_hsspi *bs = spi_master_get_devdata(spi->master);\r\nunsigned chip_select = spi->chip_select;\r\nu16 opcode = 0;\r\nint pending = t->len;\r\nint step_size = HSSPI_BUFFER_LEN;\r\nconst u8 *tx = t->tx_buf;\r\nu8 *rx = t->rx_buf;\r\nbcm63xx_hsspi_set_clk(bs, spi, t->speed_hz);\r\nbcm63xx_hsspi_set_cs(bs, spi->chip_select, true);\r\nif (tx && rx)\r\nopcode = HSSPI_OP_READ_WRITE;\r\nelse if (tx)\r\nopcode = HSSPI_OP_WRITE;\r\nelse if (rx)\r\nopcode = HSSPI_OP_READ;\r\nif (opcode != HSSPI_OP_READ)\r\nstep_size -= HSSPI_OPCODE_LEN;\r\n__raw_writel(0 << MODE_CTRL_PREPENDBYTE_CNT_SHIFT |\r\n2 << MODE_CTRL_MULTIDATA_WR_STRT_SHIFT |\r\n2 << MODE_CTRL_MULTIDATA_RD_STRT_SHIFT | 0xff,\r\nbs->regs + HSSPI_PROFILE_MODE_CTRL_REG(chip_select));\r\nwhile (pending > 0) {\r\nint curr_step = min_t(int, step_size, pending);\r\nreinit_completion(&bs->done);\r\nif (tx) {\r\nmemcpy_toio(bs->fifo + HSSPI_OPCODE_LEN, tx, curr_step);\r\ntx += curr_step;\r\n}\r\n__raw_writew(opcode | curr_step, bs->fifo);\r\n__raw_writel(HSSPI_PINGx_CMD_DONE(0),\r\nbs->regs + HSSPI_INT_MASK_REG);\r\n__raw_writel(!chip_select << PINGPONG_CMD_SS_SHIFT |\r\nchip_select << PINGPONG_CMD_PROFILE_SHIFT |\r\nPINGPONG_COMMAND_START_NOW,\r\nbs->regs + HSSPI_PINGPONG_COMMAND_REG(0));\r\nif (wait_for_completion_timeout(&bs->done, HZ) == 0) {\r\ndev_err(&bs->pdev->dev, "transfer timed out!\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nif (rx) {\r\nmemcpy_fromio(rx, bs->fifo, curr_step);\r\nrx += curr_step;\r\n}\r\npending -= curr_step;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bcm63xx_hsspi_setup(struct spi_device *spi)\r\n{\r\nstruct bcm63xx_hsspi *bs = spi_master_get_devdata(spi->master);\r\nu32 reg;\r\nreg = __raw_readl(bs->regs +\r\nHSSPI_PROFILE_SIGNAL_CTRL_REG(spi->chip_select));\r\nreg &= ~(SIGNAL_CTRL_LAUNCH_RISING | SIGNAL_CTRL_LATCH_RISING);\r\nif (spi->mode & SPI_CPHA)\r\nreg |= SIGNAL_CTRL_LAUNCH_RISING;\r\nelse\r\nreg |= SIGNAL_CTRL_LATCH_RISING;\r\n__raw_writel(reg, bs->regs +\r\nHSSPI_PROFILE_SIGNAL_CTRL_REG(spi->chip_select));\r\nmutex_lock(&bs->bus_mutex);\r\nreg = __raw_readl(bs->regs + HSSPI_GLOBAL_CTRL_REG);\r\nif ((reg & GLOBAL_CTRL_CS_POLARITY_MASK) == bs->cs_polarity) {\r\nif (spi->mode & SPI_CS_HIGH)\r\nreg |= BIT(spi->chip_select);\r\nelse\r\nreg &= ~BIT(spi->chip_select);\r\n__raw_writel(reg, bs->regs + HSSPI_GLOBAL_CTRL_REG);\r\n}\r\nif (spi->mode & SPI_CS_HIGH)\r\nbs->cs_polarity |= BIT(spi->chip_select);\r\nelse\r\nbs->cs_polarity &= ~BIT(spi->chip_select);\r\nmutex_unlock(&bs->bus_mutex);\r\nreturn 0;\r\n}\r\nstatic int bcm63xx_hsspi_transfer_one(struct spi_master *master,\r\nstruct spi_message *msg)\r\n{\r\nstruct bcm63xx_hsspi *bs = spi_master_get_devdata(master);\r\nstruct spi_transfer *t;\r\nstruct spi_device *spi = msg->spi;\r\nint status = -EINVAL;\r\nint dummy_cs;\r\nu32 reg;\r\ndummy_cs = !spi->chip_select;\r\nbcm63xx_hsspi_set_cs(bs, dummy_cs, true);\r\nlist_for_each_entry(t, &msg->transfers, transfer_list) {\r\nstatus = bcm63xx_hsspi_do_txrx(spi, t);\r\nif (status)\r\nbreak;\r\nmsg->actual_length += t->len;\r\nif (t->delay_usecs)\r\nudelay(t->delay_usecs);\r\nif (t->cs_change)\r\nbcm63xx_hsspi_set_cs(bs, spi->chip_select, false);\r\n}\r\nmutex_lock(&bs->bus_mutex);\r\nreg = __raw_readl(bs->regs + HSSPI_GLOBAL_CTRL_REG);\r\nreg &= ~GLOBAL_CTRL_CS_POLARITY_MASK;\r\nreg |= bs->cs_polarity;\r\n__raw_writel(reg, bs->regs + HSSPI_GLOBAL_CTRL_REG);\r\nmutex_unlock(&bs->bus_mutex);\r\nmsg->status = status;\r\nspi_finalize_current_message(master);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t bcm63xx_hsspi_interrupt(int irq, void *dev_id)\r\n{\r\nstruct bcm63xx_hsspi *bs = (struct bcm63xx_hsspi *)dev_id;\r\nif (__raw_readl(bs->regs + HSSPI_INT_STATUS_MASKED_REG) == 0)\r\nreturn IRQ_NONE;\r\n__raw_writel(HSSPI_INT_CLEAR_ALL, bs->regs + HSSPI_INT_STATUS_REG);\r\n__raw_writel(0, bs->regs + HSSPI_INT_MASK_REG);\r\ncomplete(&bs->done);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int bcm63xx_hsspi_probe(struct platform_device *pdev)\r\n{\r\nstruct spi_master *master;\r\nstruct bcm63xx_hsspi *bs;\r\nstruct resource *res_mem;\r\nvoid __iomem *regs;\r\nstruct device *dev = &pdev->dev;\r\nstruct clk *clk;\r\nint irq, ret;\r\nu32 reg, rate;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(dev, "no irq\n");\r\nreturn -ENXIO;\r\n}\r\nres_mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nregs = devm_ioremap_resource(dev, res_mem);\r\nif (IS_ERR(regs))\r\nreturn PTR_ERR(regs);\r\nclk = devm_clk_get(dev, "hsspi");\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nrate = clk_get_rate(clk);\r\nif (!rate)\r\nreturn -EINVAL;\r\nret = clk_prepare_enable(clk);\r\nif (ret)\r\nreturn ret;\r\nmaster = spi_alloc_master(&pdev->dev, sizeof(*bs));\r\nif (!master) {\r\nret = -ENOMEM;\r\ngoto out_disable_clk;\r\n}\r\nbs = spi_master_get_devdata(master);\r\nbs->pdev = pdev;\r\nbs->clk = clk;\r\nbs->regs = regs;\r\nbs->speed_hz = rate;\r\nbs->fifo = (u8 __iomem *)(bs->regs + HSSPI_FIFO_REG(0));\r\nmutex_init(&bs->bus_mutex);\r\ninit_completion(&bs->done);\r\nmaster->bus_num = HSSPI_BUS_NUM;\r\nmaster->num_chipselect = 8;\r\nmaster->setup = bcm63xx_hsspi_setup;\r\nmaster->transfer_one_message = bcm63xx_hsspi_transfer_one;\r\nmaster->mode_bits = SPI_CPOL | SPI_CPHA | SPI_CS_HIGH;\r\nmaster->bits_per_word_mask = SPI_BPW_MASK(8);\r\nmaster->auto_runtime_pm = true;\r\nplatform_set_drvdata(pdev, master);\r\n__raw_writel(0, bs->regs + HSSPI_INT_MASK_REG);\r\n__raw_writel(HSSPI_INT_CLEAR_ALL, bs->regs + HSSPI_INT_STATUS_REG);\r\nreg = __raw_readl(bs->regs + HSSPI_GLOBAL_CTRL_REG);\r\nbs->cs_polarity = reg & GLOBAL_CTRL_CS_POLARITY_MASK;\r\n__raw_writel(reg | GLOBAL_CTRL_CLK_GATE_SSOFF,\r\nbs->regs + HSSPI_GLOBAL_CTRL_REG);\r\nret = devm_request_irq(dev, irq, bcm63xx_hsspi_interrupt, IRQF_SHARED,\r\npdev->name, bs);\r\nif (ret)\r\ngoto out_put_master;\r\nret = devm_spi_register_master(dev, master);\r\nif (ret)\r\ngoto out_put_master;\r\nreturn 0;\r\nout_put_master:\r\nspi_master_put(master);\r\nout_disable_clk:\r\nclk_disable_unprepare(clk);\r\nreturn ret;\r\n}\r\nstatic int bcm63xx_hsspi_remove(struct platform_device *pdev)\r\n{\r\nstruct spi_master *master = platform_get_drvdata(pdev);\r\nstruct bcm63xx_hsspi *bs = spi_master_get_devdata(master);\r\n__raw_writel(0, bs->regs + HSSPI_INT_MASK_REG);\r\nclk_disable_unprepare(bs->clk);\r\nreturn 0;\r\n}\r\nstatic int bcm63xx_hsspi_suspend(struct device *dev)\r\n{\r\nstruct spi_master *master = dev_get_drvdata(dev);\r\nstruct bcm63xx_hsspi *bs = spi_master_get_devdata(master);\r\nspi_master_suspend(master);\r\nclk_disable_unprepare(bs->clk);\r\nreturn 0;\r\n}\r\nstatic int bcm63xx_hsspi_resume(struct device *dev)\r\n{\r\nstruct spi_master *master = dev_get_drvdata(dev);\r\nstruct bcm63xx_hsspi *bs = spi_master_get_devdata(master);\r\nint ret;\r\nret = clk_prepare_enable(bs->clk);\r\nif (ret)\r\nreturn ret;\r\nspi_master_resume(master);\r\nreturn 0;\r\n}

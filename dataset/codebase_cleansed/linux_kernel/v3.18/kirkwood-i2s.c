static int kirkwood_i2s_set_fmt(struct snd_soc_dai *cpu_dai,\r\nunsigned int fmt)\r\n{\r\nstruct kirkwood_dma_data *priv = snd_soc_dai_get_drvdata(cpu_dai);\r\nunsigned long mask;\r\nunsigned long value;\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_RIGHT_J:\r\nmask = KIRKWOOD_I2S_CTL_RJ;\r\nbreak;\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\nmask = KIRKWOOD_I2S_CTL_LJ;\r\nbreak;\r\ncase SND_SOC_DAIFMT_I2S:\r\nmask = KIRKWOOD_I2S_CTL_I2S;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nvalue = readl(priv->io+KIRKWOOD_I2S_PLAYCTL);\r\nvalue &= ~KIRKWOOD_I2S_CTL_JUST_MASK;\r\nvalue |= mask;\r\nwritel(value, priv->io+KIRKWOOD_I2S_PLAYCTL);\r\nvalue = readl(priv->io+KIRKWOOD_I2S_RECCTL);\r\nvalue &= ~KIRKWOOD_I2S_CTL_JUST_MASK;\r\nvalue |= mask;\r\nwritel(value, priv->io+KIRKWOOD_I2S_RECCTL);\r\nreturn 0;\r\n}\r\nstatic inline void kirkwood_set_dco(void __iomem *io, unsigned long rate)\r\n{\r\nunsigned long value;\r\nvalue = KIRKWOOD_DCO_CTL_OFFSET_0;\r\nswitch (rate) {\r\ndefault:\r\ncase 44100:\r\nvalue |= KIRKWOOD_DCO_CTL_FREQ_11;\r\nbreak;\r\ncase 48000:\r\nvalue |= KIRKWOOD_DCO_CTL_FREQ_12;\r\nbreak;\r\ncase 96000:\r\nvalue |= KIRKWOOD_DCO_CTL_FREQ_24;\r\nbreak;\r\n}\r\nwritel(value, io + KIRKWOOD_DCO_CTL);\r\ndo {\r\ncpu_relax();\r\nvalue = readl(io + KIRKWOOD_DCO_SPCR_STATUS);\r\nvalue &= KIRKWOOD_DCO_SPCR_STATUS_DCO_LOCK;\r\n} while (value == 0);\r\n}\r\nstatic void kirkwood_set_rate(struct snd_soc_dai *dai,\r\nstruct kirkwood_dma_data *priv, unsigned long rate)\r\n{\r\nuint32_t clks_ctrl;\r\nif (IS_ERR(priv->extclk)) {\r\ndev_dbg(dai->dev, "%s: dco set rate = %lu\n",\r\n__func__, rate);\r\nkirkwood_set_dco(priv->io, rate);\r\nclks_ctrl = KIRKWOOD_MCLK_SOURCE_DCO;\r\n} else {\r\ndev_dbg(dai->dev, "%s: extclk set rate = %lu -> %lu\n",\r\n__func__, rate, 256 * rate);\r\nclk_set_rate(priv->extclk, 256 * rate);\r\nclks_ctrl = KIRKWOOD_MCLK_SOURCE_EXTCLK;\r\n}\r\nwritel(clks_ctrl, priv->io + KIRKWOOD_CLOCKS_CTRL);\r\n}\r\nstatic int kirkwood_i2s_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct kirkwood_dma_data *priv = snd_soc_dai_get_drvdata(dai);\r\nsnd_soc_dai_set_dma_data(dai, substream, priv);\r\nreturn 0;\r\n}\r\nstatic int kirkwood_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct kirkwood_dma_data *priv = snd_soc_dai_get_drvdata(dai);\r\nuint32_t ctl_play, ctl_rec;\r\nunsigned int i2s_reg;\r\nunsigned long i2s_value;\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\ni2s_reg = KIRKWOOD_I2S_PLAYCTL;\r\n} else {\r\ni2s_reg = KIRKWOOD_I2S_RECCTL;\r\n}\r\nkirkwood_set_rate(dai, priv, params_rate(params));\r\ni2s_value = readl(priv->io+i2s_reg);\r\ni2s_value &= ~KIRKWOOD_I2S_CTL_SIZE_MASK;\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\ni2s_value |= KIRKWOOD_I2S_CTL_SIZE_16;\r\nctl_play = KIRKWOOD_PLAYCTL_SIZE_16_C |\r\nKIRKWOOD_PLAYCTL_I2S_EN |\r\nKIRKWOOD_PLAYCTL_SPDIF_EN;\r\nctl_rec = KIRKWOOD_RECCTL_SIZE_16_C |\r\nKIRKWOOD_RECCTL_I2S_EN |\r\nKIRKWOOD_RECCTL_SPDIF_EN;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S24_LE:\r\ni2s_value |= KIRKWOOD_I2S_CTL_SIZE_24;\r\nctl_play = KIRKWOOD_PLAYCTL_SIZE_24 |\r\nKIRKWOOD_PLAYCTL_I2S_EN |\r\nKIRKWOOD_PLAYCTL_SPDIF_EN;\r\nctl_rec = KIRKWOOD_RECCTL_SIZE_24 |\r\nKIRKWOOD_RECCTL_I2S_EN |\r\nKIRKWOOD_RECCTL_SPDIF_EN;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S32_LE:\r\ni2s_value |= KIRKWOOD_I2S_CTL_SIZE_32;\r\nctl_play = KIRKWOOD_PLAYCTL_SIZE_32 |\r\nKIRKWOOD_PLAYCTL_I2S_EN;\r\nctl_rec = KIRKWOOD_RECCTL_SIZE_32 |\r\nKIRKWOOD_RECCTL_I2S_EN;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nif (params_channels(params) == 1)\r\nctl_play |= KIRKWOOD_PLAYCTL_MONO_BOTH;\r\nelse\r\nctl_play |= KIRKWOOD_PLAYCTL_MONO_OFF;\r\npriv->ctl_play &= ~(KIRKWOOD_PLAYCTL_MONO_MASK |\r\nKIRKWOOD_PLAYCTL_ENABLE_MASK |\r\nKIRKWOOD_PLAYCTL_SIZE_MASK);\r\npriv->ctl_play |= ctl_play;\r\n} else {\r\npriv->ctl_rec &= ~(KIRKWOOD_RECCTL_ENABLE_MASK |\r\nKIRKWOOD_RECCTL_SIZE_MASK);\r\npriv->ctl_rec |= ctl_rec;\r\n}\r\nwritel(i2s_value, priv->io+i2s_reg);\r\nreturn 0;\r\n}\r\nstatic unsigned kirkwood_i2s_play_mute(unsigned ctl)\r\n{\r\nif (!(ctl & KIRKWOOD_PLAYCTL_I2S_EN))\r\nctl |= KIRKWOOD_PLAYCTL_I2S_MUTE;\r\nif (!(ctl & KIRKWOOD_PLAYCTL_SPDIF_EN))\r\nctl |= KIRKWOOD_PLAYCTL_SPDIF_MUTE;\r\nreturn ctl;\r\n}\r\nstatic int kirkwood_i2s_play_trigger(struct snd_pcm_substream *substream,\r\nint cmd, struct snd_soc_dai *dai)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct kirkwood_dma_data *priv = snd_soc_dai_get_drvdata(dai);\r\nuint32_t ctl, value;\r\nctl = readl(priv->io + KIRKWOOD_PLAYCTL);\r\nif ((ctl & KIRKWOOD_PLAYCTL_ENABLE_MASK) == 0) {\r\nunsigned timeout = 5000;\r\ndo {\r\nvalue = ctl;\r\nctl = readl(priv->io + KIRKWOOD_PLAYCTL);\r\nif (!((ctl | value) & KIRKWOOD_PLAYCTL_PLAY_BUSY))\r\nbreak;\r\nudelay(1);\r\n} while (timeout--);\r\nif ((ctl | value) & KIRKWOOD_PLAYCTL_PLAY_BUSY)\r\ndev_notice(dai->dev, "timed out waiting for busy to deassert: %08x\n",\r\nctl);\r\n}\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nctl = priv->ctl_play;\r\nif (dai->id == 0)\r\nctl &= ~KIRKWOOD_PLAYCTL_SPDIF_EN;\r\nelse\r\nctl &= ~KIRKWOOD_PLAYCTL_I2S_EN;\r\nctl = kirkwood_i2s_play_mute(ctl);\r\nvalue = ctl & ~KIRKWOOD_PLAYCTL_ENABLE_MASK;\r\nwritel(value, priv->io + KIRKWOOD_PLAYCTL);\r\nif (!runtime->no_period_wakeup) {\r\nvalue = readl(priv->io + KIRKWOOD_INT_MASK);\r\nvalue |= KIRKWOOD_INT_CAUSE_PLAY_BYTES;\r\nwritel(value, priv->io + KIRKWOOD_INT_MASK);\r\n}\r\nwritel(ctl, priv->io + KIRKWOOD_PLAYCTL);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\nctl |= KIRKWOOD_PLAYCTL_PAUSE | KIRKWOOD_PLAYCTL_I2S_MUTE |\r\nKIRKWOOD_PLAYCTL_SPDIF_MUTE;\r\nwritel(ctl, priv->io + KIRKWOOD_PLAYCTL);\r\nvalue = readl(priv->io + KIRKWOOD_INT_MASK);\r\nvalue &= ~KIRKWOOD_INT_CAUSE_PLAY_BYTES;\r\nwritel(value, priv->io + KIRKWOOD_INT_MASK);\r\nctl &= ~KIRKWOOD_PLAYCTL_ENABLE_MASK;\r\nwritel(ctl, priv->io + KIRKWOOD_PLAYCTL);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\nctl |= KIRKWOOD_PLAYCTL_PAUSE | KIRKWOOD_PLAYCTL_I2S_MUTE |\r\nKIRKWOOD_PLAYCTL_SPDIF_MUTE;\r\nwritel(ctl, priv->io + KIRKWOOD_PLAYCTL);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nctl &= ~(KIRKWOOD_PLAYCTL_PAUSE | KIRKWOOD_PLAYCTL_I2S_MUTE |\r\nKIRKWOOD_PLAYCTL_SPDIF_MUTE);\r\nctl = kirkwood_i2s_play_mute(ctl);\r\nwritel(ctl, priv->io + KIRKWOOD_PLAYCTL);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int kirkwood_i2s_rec_trigger(struct snd_pcm_substream *substream,\r\nint cmd, struct snd_soc_dai *dai)\r\n{\r\nstruct kirkwood_dma_data *priv = snd_soc_dai_get_drvdata(dai);\r\nuint32_t ctl, value;\r\nvalue = readl(priv->io + KIRKWOOD_RECCTL);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nctl = priv->ctl_rec;\r\nif (dai->id == 0)\r\nctl &= ~KIRKWOOD_RECCTL_SPDIF_EN;\r\nelse\r\nctl &= ~KIRKWOOD_RECCTL_I2S_EN;\r\nvalue = ctl & ~KIRKWOOD_RECCTL_ENABLE_MASK;\r\nwritel(value, priv->io + KIRKWOOD_RECCTL);\r\nvalue = readl(priv->io + KIRKWOOD_INT_MASK);\r\nvalue |= KIRKWOOD_INT_CAUSE_REC_BYTES;\r\nwritel(value, priv->io + KIRKWOOD_INT_MASK);\r\nwritel(ctl, priv->io + KIRKWOOD_RECCTL);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\nvalue = readl(priv->io + KIRKWOOD_RECCTL);\r\nvalue |= KIRKWOOD_RECCTL_PAUSE | KIRKWOOD_RECCTL_MUTE;\r\nwritel(value, priv->io + KIRKWOOD_RECCTL);\r\nvalue = readl(priv->io + KIRKWOOD_INT_MASK);\r\nvalue &= ~KIRKWOOD_INT_CAUSE_REC_BYTES;\r\nwritel(value, priv->io + KIRKWOOD_INT_MASK);\r\nvalue = readl(priv->io + KIRKWOOD_RECCTL);\r\nvalue &= ~KIRKWOOD_RECCTL_ENABLE_MASK;\r\nwritel(value, priv->io + KIRKWOOD_RECCTL);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\nvalue = readl(priv->io + KIRKWOOD_RECCTL);\r\nvalue |= KIRKWOOD_RECCTL_PAUSE | KIRKWOOD_RECCTL_MUTE;\r\nwritel(value, priv->io + KIRKWOOD_RECCTL);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nvalue = readl(priv->io + KIRKWOOD_RECCTL);\r\nvalue &= ~(KIRKWOOD_RECCTL_PAUSE | KIRKWOOD_RECCTL_MUTE);\r\nwritel(value, priv->io + KIRKWOOD_RECCTL);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int kirkwood_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nreturn kirkwood_i2s_play_trigger(substream, cmd, dai);\r\nelse\r\nreturn kirkwood_i2s_rec_trigger(substream, cmd, dai);\r\nreturn 0;\r\n}\r\nstatic int kirkwood_i2s_init(struct kirkwood_dma_data *priv)\r\n{\r\nunsigned long value;\r\nunsigned int reg_data;\r\nwritel(0xffffffff, priv->io + KIRKWOOD_INT_CAUSE);\r\nwritel(0, priv->io + KIRKWOOD_INT_MASK);\r\nreg_data = readl(priv->io + 0x1200);\r\nreg_data &= (~(0x333FF8));\r\nreg_data |= 0x111D18;\r\nwritel(reg_data, priv->io + 0x1200);\r\nmsleep(500);\r\nreg_data = readl(priv->io + 0x1200);\r\nreg_data &= (~(0x333FF8));\r\nreg_data |= 0x111D18;\r\nwritel(reg_data, priv->io + 0x1200);\r\nvalue = readl(priv->io + KIRKWOOD_PLAYCTL);\r\nvalue &= ~KIRKWOOD_PLAYCTL_ENABLE_MASK;\r\nwritel(value, priv->io + KIRKWOOD_PLAYCTL);\r\nvalue = readl(priv->io + KIRKWOOD_RECCTL);\r\nvalue &= ~KIRKWOOD_RECCTL_ENABLE_MASK;\r\nwritel(value, priv->io + KIRKWOOD_RECCTL);\r\nreturn 0;\r\n}\r\nstatic int kirkwood_i2s_dev_probe(struct platform_device *pdev)\r\n{\r\nstruct kirkwood_asoc_platform_data *data = pdev->dev.platform_data;\r\nstruct snd_soc_dai_driver *soc_dai = kirkwood_i2s_dai;\r\nstruct kirkwood_dma_data *priv;\r\nstruct resource *mem;\r\nstruct device_node *np = pdev->dev.of_node;\r\nint err;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv) {\r\ndev_err(&pdev->dev, "allocation failed\n");\r\nreturn -ENOMEM;\r\n}\r\ndev_set_drvdata(&pdev->dev, priv);\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->io = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(priv->io))\r\nreturn PTR_ERR(priv->io);\r\npriv->irq = platform_get_irq(pdev, 0);\r\nif (priv->irq <= 0) {\r\ndev_err(&pdev->dev, "platform_get_irq failed\n");\r\nreturn -ENXIO;\r\n}\r\nif (np) {\r\npriv->burst = 128;\r\n} else if (data) {\r\npriv->burst = data->burst;\r\n} else {\r\ndev_err(&pdev->dev, "no DT nor platform data ?!\n");\r\nreturn -EINVAL;\r\n}\r\npriv->clk = devm_clk_get(&pdev->dev, np ? "internal" : NULL);\r\nif (IS_ERR(priv->clk)) {\r\ndev_err(&pdev->dev, "no clock\n");\r\nreturn PTR_ERR(priv->clk);\r\n}\r\nerr = clk_prepare_enable(priv->clk);\r\nif (err < 0)\r\nreturn err;\r\npriv->extclk = devm_clk_get(&pdev->dev, "extclk");\r\nif (IS_ERR(priv->extclk)) {\r\nif (PTR_ERR(priv->extclk) == -EPROBE_DEFER)\r\nreturn -EPROBE_DEFER;\r\n} else {\r\nif (priv->extclk == priv->clk) {\r\ndevm_clk_put(&pdev->dev, priv->extclk);\r\npriv->extclk = ERR_PTR(-EINVAL);\r\n} else {\r\ndev_info(&pdev->dev, "found external clock\n");\r\nclk_prepare_enable(priv->extclk);\r\nsoc_dai = kirkwood_i2s_dai_extclk;\r\n}\r\n}\r\npriv->ctl_play = KIRKWOOD_PLAYCTL_SIZE_24;\r\npriv->ctl_rec = KIRKWOOD_RECCTL_SIZE_24;\r\nif (priv->burst == 32) {\r\npriv->ctl_play |= KIRKWOOD_PLAYCTL_BURST_32;\r\npriv->ctl_rec |= KIRKWOOD_RECCTL_BURST_32;\r\n} else {\r\npriv->ctl_play |= KIRKWOOD_PLAYCTL_BURST_128;\r\npriv->ctl_rec |= KIRKWOOD_RECCTL_BURST_128;\r\n}\r\nerr = snd_soc_register_component(&pdev->dev, &kirkwood_i2s_component,\r\nsoc_dai, 2);\r\nif (err) {\r\ndev_err(&pdev->dev, "snd_soc_register_component failed\n");\r\ngoto err_component;\r\n}\r\nerr = snd_soc_register_platform(&pdev->dev, &kirkwood_soc_platform);\r\nif (err) {\r\ndev_err(&pdev->dev, "snd_soc_register_platform failed\n");\r\ngoto err_platform;\r\n}\r\nkirkwood_i2s_init(priv);\r\nreturn 0;\r\nerr_platform:\r\nsnd_soc_unregister_component(&pdev->dev);\r\nerr_component:\r\nif (!IS_ERR(priv->extclk))\r\nclk_disable_unprepare(priv->extclk);\r\nclk_disable_unprepare(priv->clk);\r\nreturn err;\r\n}\r\nstatic int kirkwood_i2s_dev_remove(struct platform_device *pdev)\r\n{\r\nstruct kirkwood_dma_data *priv = dev_get_drvdata(&pdev->dev);\r\nsnd_soc_unregister_platform(&pdev->dev);\r\nsnd_soc_unregister_component(&pdev->dev);\r\nif (!IS_ERR(priv->extclk))\r\nclk_disable_unprepare(priv->extclk);\r\nclk_disable_unprepare(priv->clk);\r\nreturn 0;\r\n}

static int savu_init_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct usb_device *usb_dev = interface_to_usbdev(intf);\r\nstruct roccat_common2_device *savu;\r\nint retval;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n!= USB_INTERFACE_PROTOCOL_MOUSE) {\r\nhid_set_drvdata(hdev, NULL);\r\nreturn 0;\r\n}\r\nsavu = kzalloc(sizeof(*savu), GFP_KERNEL);\r\nif (!savu) {\r\nhid_err(hdev, "can't alloc device descriptor\n");\r\nreturn -ENOMEM;\r\n}\r\nhid_set_drvdata(hdev, savu);\r\nretval = roccat_common2_device_init_struct(usb_dev, savu);\r\nif (retval) {\r\nhid_err(hdev, "couldn't init Savu device\n");\r\ngoto exit_free;\r\n}\r\nretval = roccat_connect(savu_class, hdev,\r\nsizeof(struct savu_roccat_report));\r\nif (retval < 0) {\r\nhid_err(hdev, "couldn't init char dev\n");\r\n} else {\r\nsavu->chrdev_minor = retval;\r\nsavu->roccat_claimed = 1;\r\n}\r\nreturn 0;\r\nexit_free:\r\nkfree(savu);\r\nreturn retval;\r\n}\r\nstatic void savu_remove_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct roccat_common2_device *savu;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n!= USB_INTERFACE_PROTOCOL_MOUSE)\r\nreturn;\r\nsavu = hid_get_drvdata(hdev);\r\nif (savu->roccat_claimed)\r\nroccat_disconnect(savu->chrdev_minor);\r\nkfree(savu);\r\n}\r\nstatic int savu_probe(struct hid_device *hdev,\r\nconst struct hid_device_id *id)\r\n{\r\nint retval;\r\nretval = hid_parse(hdev);\r\nif (retval) {\r\nhid_err(hdev, "parse failed\n");\r\ngoto exit;\r\n}\r\nretval = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\r\nif (retval) {\r\nhid_err(hdev, "hw start failed\n");\r\ngoto exit;\r\n}\r\nretval = savu_init_specials(hdev);\r\nif (retval) {\r\nhid_err(hdev, "couldn't install mouse\n");\r\ngoto exit_stop;\r\n}\r\nreturn 0;\r\nexit_stop:\r\nhid_hw_stop(hdev);\r\nexit:\r\nreturn retval;\r\n}\r\nstatic void savu_remove(struct hid_device *hdev)\r\n{\r\nsavu_remove_specials(hdev);\r\nhid_hw_stop(hdev);\r\n}\r\nstatic void savu_report_to_chrdev(struct roccat_common2_device const *savu,\r\nu8 const *data)\r\n{\r\nstruct savu_roccat_report roccat_report;\r\nstruct savu_mouse_report_special const *special_report;\r\nif (data[0] != SAVU_MOUSE_REPORT_NUMBER_SPECIAL)\r\nreturn;\r\nspecial_report = (struct savu_mouse_report_special const *)data;\r\nroccat_report.type = special_report->type;\r\nroccat_report.data[0] = special_report->data[0];\r\nroccat_report.data[1] = special_report->data[1];\r\nroccat_report_event(savu->chrdev_minor,\r\n(uint8_t const *)&roccat_report);\r\n}\r\nstatic int savu_raw_event(struct hid_device *hdev,\r\nstruct hid_report *report, u8 *data, int size)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct roccat_common2_device *savu = hid_get_drvdata(hdev);\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n!= USB_INTERFACE_PROTOCOL_MOUSE)\r\nreturn 0;\r\nif (savu == NULL)\r\nreturn 0;\r\nif (savu->roccat_claimed)\r\nsavu_report_to_chrdev(savu, data);\r\nreturn 0;\r\n}\r\nstatic int __init savu_init(void)\r\n{\r\nint retval;\r\nsavu_class = class_create(THIS_MODULE, "savu");\r\nif (IS_ERR(savu_class))\r\nreturn PTR_ERR(savu_class);\r\nsavu_class->dev_groups = savu_groups;\r\nretval = hid_register_driver(&savu_driver);\r\nif (retval)\r\nclass_destroy(savu_class);\r\nreturn retval;\r\n}\r\nstatic void __exit savu_exit(void)\r\n{\r\nhid_unregister_driver(&savu_driver);\r\nclass_destroy(savu_class);\r\n}

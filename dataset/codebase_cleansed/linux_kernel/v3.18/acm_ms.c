static int __init acm_ms_do_config(struct usb_configuration *c)\r\n{\r\nstruct fsg_opts *opts;\r\nint status;\r\nif (gadget_is_otg(c->cdev->gadget)) {\r\nc->descriptors = otg_desc;\r\nc->bmAttributes |= USB_CONFIG_ATT_WAKEUP;\r\n}\r\nopts = fsg_opts_from_func_inst(fi_msg);\r\nf_acm = usb_get_function(f_acm_inst);\r\nif (IS_ERR(f_acm))\r\nreturn PTR_ERR(f_acm);\r\nf_msg = usb_get_function(fi_msg);\r\nif (IS_ERR(f_msg)) {\r\nstatus = PTR_ERR(f_msg);\r\ngoto put_acm;\r\n}\r\nstatus = usb_add_function(c, f_acm);\r\nif (status < 0)\r\ngoto put_msg;\r\nstatus = fsg_common_run_thread(opts->common);\r\nif (status)\r\ngoto remove_acm;\r\nstatus = usb_add_function(c, f_msg);\r\nif (status)\r\ngoto remove_acm;\r\nreturn 0;\r\nremove_acm:\r\nusb_remove_function(c, f_acm);\r\nput_msg:\r\nusb_put_function(f_msg);\r\nput_acm:\r\nusb_put_function(f_acm);\r\nreturn status;\r\n}\r\nstatic int __init acm_ms_bind(struct usb_composite_dev *cdev)\r\n{\r\nstruct usb_gadget *gadget = cdev->gadget;\r\nstruct fsg_opts *opts;\r\nstruct fsg_config config;\r\nint status;\r\nf_acm_inst = usb_get_function_instance("acm");\r\nif (IS_ERR(f_acm_inst))\r\nreturn PTR_ERR(f_acm_inst);\r\nfi_msg = usb_get_function_instance("mass_storage");\r\nif (IS_ERR(fi_msg)) {\r\nstatus = PTR_ERR(fi_msg);\r\ngoto fail_get_msg;\r\n}\r\nfsg_config_from_params(&config, &fsg_mod_data, fsg_num_buffers);\r\nopts = fsg_opts_from_func_inst(fi_msg);\r\nopts->no_configfs = true;\r\nstatus = fsg_common_set_num_buffers(opts->common, fsg_num_buffers);\r\nif (status)\r\ngoto fail;\r\nstatus = fsg_common_set_nluns(opts->common, config.nluns);\r\nif (status)\r\ngoto fail_set_nluns;\r\nstatus = fsg_common_set_cdev(opts->common, cdev, config.can_stall);\r\nif (status)\r\ngoto fail_set_cdev;\r\nfsg_common_set_sysfs(opts->common, true);\r\nstatus = fsg_common_create_luns(opts->common, &config);\r\nif (status)\r\ngoto fail_set_cdev;\r\nfsg_common_set_inquiry_string(opts->common, config.vendor_name,\r\nconfig.product_name);\r\nstatus = usb_string_ids_tab(cdev, strings_dev);\r\nif (status < 0)\r\ngoto fail_string_ids;\r\ndevice_desc.iManufacturer = strings_dev[USB_GADGET_MANUFACTURER_IDX].id;\r\ndevice_desc.iProduct = strings_dev[USB_GADGET_PRODUCT_IDX].id;\r\nstatus = usb_add_config(cdev, &acm_ms_config_driver, acm_ms_do_config);\r\nif (status < 0)\r\ngoto fail_string_ids;\r\nusb_composite_overwrite_options(cdev, &coverwrite);\r\ndev_info(&gadget->dev, "%s, version: " DRIVER_VERSION "\n",\r\nDRIVER_DESC);\r\nreturn 0;\r\nfail_string_ids:\r\nfsg_common_remove_luns(opts->common);\r\nfail_set_cdev:\r\nfsg_common_free_luns(opts->common);\r\nfail_set_nluns:\r\nfsg_common_free_buffers(opts->common);\r\nfail:\r\nusb_put_function_instance(fi_msg);\r\nfail_get_msg:\r\nusb_put_function_instance(f_acm_inst);\r\nreturn status;\r\n}\r\nstatic int __exit acm_ms_unbind(struct usb_composite_dev *cdev)\r\n{\r\nusb_put_function(f_msg);\r\nusb_put_function_instance(fi_msg);\r\nusb_put_function(f_acm);\r\nusb_put_function_instance(f_acm_inst);\r\nreturn 0;\r\n}

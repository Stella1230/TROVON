static int hdmi_pll_enable(struct clk_hw *hw)\r\n{\r\nstruct hdmi_phy_8960 *phy_8960 = clk_to_phy(hw);\r\nstruct hdmi *hdmi = phy_8960->hdmi;\r\nint timeout_count, pll_lock_retry = 10;\r\nunsigned int val;\r\nDBG("");\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_PLL_LOCKDET_CFG2, 0x8d);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_PLL_LOCKDET_CFG0, 0x10);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_PLL_LOCKDET_CFG1, 0x1a);\r\nudelay(10);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_PLL_LOCKDET_CFG2, 0x0d);\r\nval = hdmi_read(hdmi, REG_HDMI_8960_PHY_REG12);\r\nval |= HDMI_8960_PHY_REG12_SW_RESET;\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG12, val);\r\nval &= ~HDMI_8960_PHY_REG12_SW_RESET;\r\nudelay(10);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG12, val);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG2, 0x3f);\r\nval = hdmi_read(hdmi, REG_HDMI_8960_PHY_REG12);\r\nval |= HDMI_8960_PHY_REG12_PWRDN_B;\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG12, val);\r\nmb();\r\nudelay(10);\r\nval = hdmi_read(hdmi, REG_HDMI_8960_PHY_PLL_PWRDN_B);\r\nval |= HDMI_8960_PHY_PLL_PWRDN_B_PLL_PWRDN_B;\r\nval &= ~HDMI_8960_PHY_PLL_PWRDN_B_PD_PLL;\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_PLL_PWRDN_B, val);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG2, 0x80);\r\ntimeout_count = 1000;\r\nwhile (--pll_lock_retry > 0) {\r\nval = hdmi_read(hdmi, REG_HDMI_8960_PHY_PLL_STATUS0);\r\nif (val & HDMI_8960_PHY_PLL_STATUS0_PLL_LOCK)\r\nbreak;\r\nudelay(1);\r\nif (--timeout_count > 0)\r\ncontinue;\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_PLL_LOCKDET_CFG2, 0x8d);\r\nudelay(10);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_PLL_LOCKDET_CFG2, 0x0d);\r\nudelay(350);\r\ntimeout_count = 1000;\r\n}\r\nreturn 0;\r\n}\r\nstatic void hdmi_pll_disable(struct clk_hw *hw)\r\n{\r\nstruct hdmi_phy_8960 *phy_8960 = clk_to_phy(hw);\r\nstruct hdmi *hdmi = phy_8960->hdmi;\r\nunsigned int val;\r\nDBG("");\r\nval = hdmi_read(hdmi, REG_HDMI_8960_PHY_REG12);\r\nval &= ~HDMI_8960_PHY_REG12_PWRDN_B;\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG12, val);\r\nval = hdmi_read(hdmi, REG_HDMI_8960_PHY_PLL_PWRDN_B);\r\nval |= HDMI_8960_PHY_REG12_SW_RESET;\r\nval &= ~HDMI_8960_PHY_REG12_PWRDN_B;\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_PLL_PWRDN_B, val);\r\nmb();\r\n}\r\nstatic const struct pll_rate *find_rate(unsigned long rate)\r\n{\r\nint i;\r\nfor (i = 1; i < ARRAY_SIZE(freqtbl); i++)\r\nif (rate > freqtbl[i].rate)\r\nreturn &freqtbl[i-1];\r\nreturn &freqtbl[i-1];\r\n}\r\nstatic unsigned long hdmi_pll_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct hdmi_phy_8960 *phy_8960 = clk_to_phy(hw);\r\nreturn phy_8960->pixclk;\r\n}\r\nstatic long hdmi_pll_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nconst struct pll_rate *pll_rate = find_rate(rate);\r\nreturn pll_rate->rate;\r\n}\r\nstatic int hdmi_pll_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct hdmi_phy_8960 *phy_8960 = clk_to_phy(hw);\r\nstruct hdmi *hdmi = phy_8960->hdmi;\r\nconst struct pll_rate *pll_rate = find_rate(rate);\r\nint i;\r\nDBG("rate=%lu", rate);\r\nfor (i = 0; pll_rate->conf[i].reg; i++)\r\nhdmi_write(hdmi, pll_rate->conf[i].reg, pll_rate->conf[i].val);\r\nphy_8960->pixclk = rate;\r\nreturn 0;\r\n}\r\nstatic void hdmi_phy_8960_destroy(struct hdmi_phy *phy)\r\n{\r\nstruct hdmi_phy_8960 *phy_8960 = to_hdmi_phy_8960(phy);\r\nkfree(phy_8960);\r\n}\r\nstatic void hdmi_phy_8960_reset(struct hdmi_phy *phy)\r\n{\r\nstruct hdmi_phy_8960 *phy_8960 = to_hdmi_phy_8960(phy);\r\nstruct hdmi *hdmi = phy_8960->hdmi;\r\nunsigned int val;\r\nval = hdmi_read(hdmi, REG_HDMI_PHY_CTRL);\r\nif (val & HDMI_PHY_CTRL_SW_RESET_LOW) {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval & ~HDMI_PHY_CTRL_SW_RESET);\r\n} else {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval | HDMI_PHY_CTRL_SW_RESET);\r\n}\r\nif (val & HDMI_PHY_CTRL_SW_RESET_PLL_LOW) {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval & ~HDMI_PHY_CTRL_SW_RESET_PLL);\r\n} else {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval | HDMI_PHY_CTRL_SW_RESET_PLL);\r\n}\r\nmsleep(100);\r\nif (val & HDMI_PHY_CTRL_SW_RESET_LOW) {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval | HDMI_PHY_CTRL_SW_RESET);\r\n} else {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval & ~HDMI_PHY_CTRL_SW_RESET);\r\n}\r\nif (val & HDMI_PHY_CTRL_SW_RESET_PLL_LOW) {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval | HDMI_PHY_CTRL_SW_RESET_PLL);\r\n} else {\r\nhdmi_write(hdmi, REG_HDMI_PHY_CTRL,\r\nval & ~HDMI_PHY_CTRL_SW_RESET_PLL);\r\n}\r\n}\r\nstatic void hdmi_phy_8960_powerup(struct hdmi_phy *phy,\r\nunsigned long int pixclock)\r\n{\r\nstruct hdmi_phy_8960 *phy_8960 = to_hdmi_phy_8960(phy);\r\nstruct hdmi *hdmi = phy_8960->hdmi;\r\nDBG("pixclock: %lu", pixclock);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG2, 0x00);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG0, 0x1b);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG1, 0xf2);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG4, 0x00);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG5, 0x00);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG6, 0x00);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG7, 0x00);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG8, 0x00);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG9, 0x00);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG10, 0x00);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG11, 0x00);\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG3, 0x20);\r\n}\r\nstatic void hdmi_phy_8960_powerdown(struct hdmi_phy *phy)\r\n{\r\nstruct hdmi_phy_8960 *phy_8960 = to_hdmi_phy_8960(phy);\r\nstruct hdmi *hdmi = phy_8960->hdmi;\r\nDBG("");\r\nhdmi_write(hdmi, REG_HDMI_8960_PHY_REG2, 0x7f);\r\n}\r\nstruct hdmi_phy *hdmi_phy_8960_init(struct hdmi *hdmi)\r\n{\r\nstruct hdmi_phy_8960 *phy_8960;\r\nstruct hdmi_phy *phy = NULL;\r\nint ret;\r\n#ifdef CONFIG_COMMON_CLK\r\nint i;\r\nfor (i = 0; i < (ARRAY_SIZE(freqtbl) - 1); i++)\r\nif (WARN_ON(freqtbl[i].rate < freqtbl[i+1].rate))\r\nreturn ERR_PTR(-EINVAL);\r\n#endif\r\nphy_8960 = kzalloc(sizeof(*phy_8960), GFP_KERNEL);\r\nif (!phy_8960) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\nphy = &phy_8960->base;\r\nphy->funcs = &hdmi_phy_8960_funcs;\r\nphy_8960->hdmi = hdmi;\r\n#ifdef CONFIG_COMMON_CLK\r\nphy_8960->pll_hw.init = &pll_init;\r\nphy_8960->pll = devm_clk_register(hdmi->dev->dev, &phy_8960->pll_hw);\r\nif (IS_ERR(phy_8960->pll)) {\r\nret = PTR_ERR(phy_8960->pll);\r\nphy_8960->pll = NULL;\r\ngoto fail;\r\n}\r\n#endif\r\nreturn phy;\r\nfail:\r\nif (phy)\r\nhdmi_phy_8960_destroy(phy);\r\nreturn ERR_PTR(ret);\r\n}

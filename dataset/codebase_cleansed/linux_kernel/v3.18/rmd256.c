static void rmd256_transform(u32 *state, const __le32 *in)\r\n{\r\nu32 aa, bb, cc, dd, aaa, bbb, ccc, ddd, tmp;\r\naa = state[0];\r\nbb = state[1];\r\ncc = state[2];\r\ndd = state[3];\r\naaa = state[4];\r\nbbb = state[5];\r\nccc = state[6];\r\nddd = state[7];\r\nROUND(aa, bb, cc, dd, F1, K1, in[0], 11);\r\nROUND(dd, aa, bb, cc, F1, K1, in[1], 14);\r\nROUND(cc, dd, aa, bb, F1, K1, in[2], 15);\r\nROUND(bb, cc, dd, aa, F1, K1, in[3], 12);\r\nROUND(aa, bb, cc, dd, F1, K1, in[4], 5);\r\nROUND(dd, aa, bb, cc, F1, K1, in[5], 8);\r\nROUND(cc, dd, aa, bb, F1, K1, in[6], 7);\r\nROUND(bb, cc, dd, aa, F1, K1, in[7], 9);\r\nROUND(aa, bb, cc, dd, F1, K1, in[8], 11);\r\nROUND(dd, aa, bb, cc, F1, K1, in[9], 13);\r\nROUND(cc, dd, aa, bb, F1, K1, in[10], 14);\r\nROUND(bb, cc, dd, aa, F1, K1, in[11], 15);\r\nROUND(aa, bb, cc, dd, F1, K1, in[12], 6);\r\nROUND(dd, aa, bb, cc, F1, K1, in[13], 7);\r\nROUND(cc, dd, aa, bb, F1, K1, in[14], 9);\r\nROUND(bb, cc, dd, aa, F1, K1, in[15], 8);\r\nROUND(aaa, bbb, ccc, ddd, F4, KK1, in[5], 8);\r\nROUND(ddd, aaa, bbb, ccc, F4, KK1, in[14], 9);\r\nROUND(ccc, ddd, aaa, bbb, F4, KK1, in[7], 9);\r\nROUND(bbb, ccc, ddd, aaa, F4, KK1, in[0], 11);\r\nROUND(aaa, bbb, ccc, ddd, F4, KK1, in[9], 13);\r\nROUND(ddd, aaa, bbb, ccc, F4, KK1, in[2], 15);\r\nROUND(ccc, ddd, aaa, bbb, F4, KK1, in[11], 15);\r\nROUND(bbb, ccc, ddd, aaa, F4, KK1, in[4], 5);\r\nROUND(aaa, bbb, ccc, ddd, F4, KK1, in[13], 7);\r\nROUND(ddd, aaa, bbb, ccc, F4, KK1, in[6], 7);\r\nROUND(ccc, ddd, aaa, bbb, F4, KK1, in[15], 8);\r\nROUND(bbb, ccc, ddd, aaa, F4, KK1, in[8], 11);\r\nROUND(aaa, bbb, ccc, ddd, F4, KK1, in[1], 14);\r\nROUND(ddd, aaa, bbb, ccc, F4, KK1, in[10], 14);\r\nROUND(ccc, ddd, aaa, bbb, F4, KK1, in[3], 12);\r\nROUND(bbb, ccc, ddd, aaa, F4, KK1, in[12], 6);\r\ntmp = aa; aa = aaa; aaa = tmp;\r\nROUND(aa, bb, cc, dd, F2, K2, in[7], 7);\r\nROUND(dd, aa, bb, cc, F2, K2, in[4], 6);\r\nROUND(cc, dd, aa, bb, F2, K2, in[13], 8);\r\nROUND(bb, cc, dd, aa, F2, K2, in[1], 13);\r\nROUND(aa, bb, cc, dd, F2, K2, in[10], 11);\r\nROUND(dd, aa, bb, cc, F2, K2, in[6], 9);\r\nROUND(cc, dd, aa, bb, F2, K2, in[15], 7);\r\nROUND(bb, cc, dd, aa, F2, K2, in[3], 15);\r\nROUND(aa, bb, cc, dd, F2, K2, in[12], 7);\r\nROUND(dd, aa, bb, cc, F2, K2, in[0], 12);\r\nROUND(cc, dd, aa, bb, F2, K2, in[9], 15);\r\nROUND(bb, cc, dd, aa, F2, K2, in[5], 9);\r\nROUND(aa, bb, cc, dd, F2, K2, in[2], 11);\r\nROUND(dd, aa, bb, cc, F2, K2, in[14], 7);\r\nROUND(cc, dd, aa, bb, F2, K2, in[11], 13);\r\nROUND(bb, cc, dd, aa, F2, K2, in[8], 12);\r\nROUND(aaa, bbb, ccc, ddd, F3, KK2, in[6], 9);\r\nROUND(ddd, aaa, bbb, ccc, F3, KK2, in[11], 13);\r\nROUND(ccc, ddd, aaa, bbb, F3, KK2, in[3], 15);\r\nROUND(bbb, ccc, ddd, aaa, F3, KK2, in[7], 7);\r\nROUND(aaa, bbb, ccc, ddd, F3, KK2, in[0], 12);\r\nROUND(ddd, aaa, bbb, ccc, F3, KK2, in[13], 8);\r\nROUND(ccc, ddd, aaa, bbb, F3, KK2, in[5], 9);\r\nROUND(bbb, ccc, ddd, aaa, F3, KK2, in[10], 11);\r\nROUND(aaa, bbb, ccc, ddd, F3, KK2, in[14], 7);\r\nROUND(ddd, aaa, bbb, ccc, F3, KK2, in[15], 7);\r\nROUND(ccc, ddd, aaa, bbb, F3, KK2, in[8], 12);\r\nROUND(bbb, ccc, ddd, aaa, F3, KK2, in[12], 7);\r\nROUND(aaa, bbb, ccc, ddd, F3, KK2, in[4], 6);\r\nROUND(ddd, aaa, bbb, ccc, F3, KK2, in[9], 15);\r\nROUND(ccc, ddd, aaa, bbb, F3, KK2, in[1], 13);\r\nROUND(bbb, ccc, ddd, aaa, F3, KK2, in[2], 11);\r\ntmp = bb; bb = bbb; bbb = tmp;\r\nROUND(aa, bb, cc, dd, F3, K3, in[3], 11);\r\nROUND(dd, aa, bb, cc, F3, K3, in[10], 13);\r\nROUND(cc, dd, aa, bb, F3, K3, in[14], 6);\r\nROUND(bb, cc, dd, aa, F3, K3, in[4], 7);\r\nROUND(aa, bb, cc, dd, F3, K3, in[9], 14);\r\nROUND(dd, aa, bb, cc, F3, K3, in[15], 9);\r\nROUND(cc, dd, aa, bb, F3, K3, in[8], 13);\r\nROUND(bb, cc, dd, aa, F3, K3, in[1], 15);\r\nROUND(aa, bb, cc, dd, F3, K3, in[2], 14);\r\nROUND(dd, aa, bb, cc, F3, K3, in[7], 8);\r\nROUND(cc, dd, aa, bb, F3, K3, in[0], 13);\r\nROUND(bb, cc, dd, aa, F3, K3, in[6], 6);\r\nROUND(aa, bb, cc, dd, F3, K3, in[13], 5);\r\nROUND(dd, aa, bb, cc, F3, K3, in[11], 12);\r\nROUND(cc, dd, aa, bb, F3, K3, in[5], 7);\r\nROUND(bb, cc, dd, aa, F3, K3, in[12], 5);\r\nROUND(aaa, bbb, ccc, ddd, F2, KK3, in[15], 9);\r\nROUND(ddd, aaa, bbb, ccc, F2, KK3, in[5], 7);\r\nROUND(ccc, ddd, aaa, bbb, F2, KK3, in[1], 15);\r\nROUND(bbb, ccc, ddd, aaa, F2, KK3, in[3], 11);\r\nROUND(aaa, bbb, ccc, ddd, F2, KK3, in[7], 8);\r\nROUND(ddd, aaa, bbb, ccc, F2, KK3, in[14], 6);\r\nROUND(ccc, ddd, aaa, bbb, F2, KK3, in[6], 6);\r\nROUND(bbb, ccc, ddd, aaa, F2, KK3, in[9], 14);\r\nROUND(aaa, bbb, ccc, ddd, F2, KK3, in[11], 12);\r\nROUND(ddd, aaa, bbb, ccc, F2, KK3, in[8], 13);\r\nROUND(ccc, ddd, aaa, bbb, F2, KK3, in[12], 5);\r\nROUND(bbb, ccc, ddd, aaa, F2, KK3, in[2], 14);\r\nROUND(aaa, bbb, ccc, ddd, F2, KK3, in[10], 13);\r\nROUND(ddd, aaa, bbb, ccc, F2, KK3, in[0], 13);\r\nROUND(ccc, ddd, aaa, bbb, F2, KK3, in[4], 7);\r\nROUND(bbb, ccc, ddd, aaa, F2, KK3, in[13], 5);\r\ntmp = cc; cc = ccc; ccc = tmp;\r\nROUND(aa, bb, cc, dd, F4, K4, in[1], 11);\r\nROUND(dd, aa, bb, cc, F4, K4, in[9], 12);\r\nROUND(cc, dd, aa, bb, F4, K4, in[11], 14);\r\nROUND(bb, cc, dd, aa, F4, K4, in[10], 15);\r\nROUND(aa, bb, cc, dd, F4, K4, in[0], 14);\r\nROUND(dd, aa, bb, cc, F4, K4, in[8], 15);\r\nROUND(cc, dd, aa, bb, F4, K4, in[12], 9);\r\nROUND(bb, cc, dd, aa, F4, K4, in[4], 8);\r\nROUND(aa, bb, cc, dd, F4, K4, in[13], 9);\r\nROUND(dd, aa, bb, cc, F4, K4, in[3], 14);\r\nROUND(cc, dd, aa, bb, F4, K4, in[7], 5);\r\nROUND(bb, cc, dd, aa, F4, K4, in[15], 6);\r\nROUND(aa, bb, cc, dd, F4, K4, in[14], 8);\r\nROUND(dd, aa, bb, cc, F4, K4, in[5], 6);\r\nROUND(cc, dd, aa, bb, F4, K4, in[6], 5);\r\nROUND(bb, cc, dd, aa, F4, K4, in[2], 12);\r\nROUND(aaa, bbb, ccc, ddd, F1, KK4, in[8], 15);\r\nROUND(ddd, aaa, bbb, ccc, F1, KK4, in[6], 5);\r\nROUND(ccc, ddd, aaa, bbb, F1, KK4, in[4], 8);\r\nROUND(bbb, ccc, ddd, aaa, F1, KK4, in[1], 11);\r\nROUND(aaa, bbb, ccc, ddd, F1, KK4, in[3], 14);\r\nROUND(ddd, aaa, bbb, ccc, F1, KK4, in[11], 14);\r\nROUND(ccc, ddd, aaa, bbb, F1, KK4, in[15], 6);\r\nROUND(bbb, ccc, ddd, aaa, F1, KK4, in[0], 14);\r\nROUND(aaa, bbb, ccc, ddd, F1, KK4, in[5], 6);\r\nROUND(ddd, aaa, bbb, ccc, F1, KK4, in[12], 9);\r\nROUND(ccc, ddd, aaa, bbb, F1, KK4, in[2], 12);\r\nROUND(bbb, ccc, ddd, aaa, F1, KK4, in[13], 9);\r\nROUND(aaa, bbb, ccc, ddd, F1, KK4, in[9], 12);\r\nROUND(ddd, aaa, bbb, ccc, F1, KK4, in[7], 5);\r\nROUND(ccc, ddd, aaa, bbb, F1, KK4, in[10], 15);\r\nROUND(bbb, ccc, ddd, aaa, F1, KK4, in[14], 8);\r\ntmp = dd; dd = ddd; ddd = tmp;\r\nstate[0] += aa;\r\nstate[1] += bb;\r\nstate[2] += cc;\r\nstate[3] += dd;\r\nstate[4] += aaa;\r\nstate[5] += bbb;\r\nstate[6] += ccc;\r\nstate[7] += ddd;\r\nreturn;\r\n}\r\nstatic int rmd256_init(struct shash_desc *desc)\r\n{\r\nstruct rmd256_ctx *rctx = shash_desc_ctx(desc);\r\nrctx->byte_count = 0;\r\nrctx->state[0] = RMD_H0;\r\nrctx->state[1] = RMD_H1;\r\nrctx->state[2] = RMD_H2;\r\nrctx->state[3] = RMD_H3;\r\nrctx->state[4] = RMD_H5;\r\nrctx->state[5] = RMD_H6;\r\nrctx->state[6] = RMD_H7;\r\nrctx->state[7] = RMD_H8;\r\nmemset(rctx->buffer, 0, sizeof(rctx->buffer));\r\nreturn 0;\r\n}\r\nstatic int rmd256_update(struct shash_desc *desc, const u8 *data,\r\nunsigned int len)\r\n{\r\nstruct rmd256_ctx *rctx = shash_desc_ctx(desc);\r\nconst u32 avail = sizeof(rctx->buffer) - (rctx->byte_count & 0x3f);\r\nrctx->byte_count += len;\r\nif (avail > len) {\r\nmemcpy((char *)rctx->buffer + (sizeof(rctx->buffer) - avail),\r\ndata, len);\r\ngoto out;\r\n}\r\nmemcpy((char *)rctx->buffer + (sizeof(rctx->buffer) - avail),\r\ndata, avail);\r\nrmd256_transform(rctx->state, rctx->buffer);\r\ndata += avail;\r\nlen -= avail;\r\nwhile (len >= sizeof(rctx->buffer)) {\r\nmemcpy(rctx->buffer, data, sizeof(rctx->buffer));\r\nrmd256_transform(rctx->state, rctx->buffer);\r\ndata += sizeof(rctx->buffer);\r\nlen -= sizeof(rctx->buffer);\r\n}\r\nmemcpy(rctx->buffer, data, len);\r\nout:\r\nreturn 0;\r\n}\r\nstatic int rmd256_final(struct shash_desc *desc, u8 *out)\r\n{\r\nstruct rmd256_ctx *rctx = shash_desc_ctx(desc);\r\nu32 i, index, padlen;\r\n__le64 bits;\r\n__le32 *dst = (__le32 *)out;\r\nstatic const u8 padding[64] = { 0x80, };\r\nbits = cpu_to_le64(rctx->byte_count << 3);\r\nindex = rctx->byte_count & 0x3f;\r\npadlen = (index < 56) ? (56 - index) : ((64+56) - index);\r\nrmd256_update(desc, padding, padlen);\r\nrmd256_update(desc, (const u8 *)&bits, sizeof(bits));\r\nfor (i = 0; i < 8; i++)\r\ndst[i] = cpu_to_le32p(&rctx->state[i]);\r\nmemset(rctx, 0, sizeof(*rctx));\r\nreturn 0;\r\n}\r\nstatic int __init rmd256_mod_init(void)\r\n{\r\nreturn crypto_register_shash(&alg);\r\n}\r\nstatic void __exit rmd256_mod_fini(void)\r\n{\r\ncrypto_unregister_shash(&alg);\r\n}

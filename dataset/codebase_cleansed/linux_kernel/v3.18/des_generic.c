unsigned long des_ekey(u32 *pe, const u8 *k)\r\n{\r\nunsigned long a, b, c, d, w;\r\nconst u32 *pt = pc2;\r\nd = k[4]; d &= 0x0e; d <<= 4; d |= k[0] & 0x1e; d = pc1[d];\r\nc = k[5]; c &= 0x0e; c <<= 4; c |= k[1] & 0x1e; c = pc1[c];\r\nb = k[6]; b &= 0x0e; b <<= 4; b |= k[2] & 0x1e; b = pc1[b];\r\na = k[7]; a &= 0x0e; a <<= 4; a |= k[3] & 0x1e; a = pc1[a];\r\npe[15 * 2 + 0] = DES_PC2(a, b, c, d); d = rs[d];\r\npe[14 * 2 + 0] = DES_PC2(d, a, b, c); c = rs[c]; b = rs[b];\r\npe[13 * 2 + 0] = DES_PC2(b, c, d, a); a = rs[a]; d = rs[d];\r\npe[12 * 2 + 0] = DES_PC2(d, a, b, c); c = rs[c]; b = rs[b];\r\npe[11 * 2 + 0] = DES_PC2(b, c, d, a); a = rs[a]; d = rs[d];\r\npe[10 * 2 + 0] = DES_PC2(d, a, b, c); c = rs[c]; b = rs[b];\r\npe[ 9 * 2 + 0] = DES_PC2(b, c, d, a); a = rs[a]; d = rs[d];\r\npe[ 8 * 2 + 0] = DES_PC2(d, a, b, c); c = rs[c];\r\npe[ 7 * 2 + 0] = DES_PC2(c, d, a, b); b = rs[b]; a = rs[a];\r\npe[ 6 * 2 + 0] = DES_PC2(a, b, c, d); d = rs[d]; c = rs[c];\r\npe[ 5 * 2 + 0] = DES_PC2(c, d, a, b); b = rs[b]; a = rs[a];\r\npe[ 4 * 2 + 0] = DES_PC2(a, b, c, d); d = rs[d]; c = rs[c];\r\npe[ 3 * 2 + 0] = DES_PC2(c, d, a, b); b = rs[b]; a = rs[a];\r\npe[ 2 * 2 + 0] = DES_PC2(a, b, c, d); d = rs[d]; c = rs[c];\r\npe[ 1 * 2 + 0] = DES_PC2(c, d, a, b); b = rs[b];\r\npe[ 0 * 2 + 0] = DES_PC2(b, c, d, a);\r\nw = (a ^ c) | (b ^ d) | (rs[a] ^ c) | (b ^ rs[d]);\r\npt += 512;\r\nd = k[0]; d &= 0xe0; d >>= 4; d |= k[4] & 0xf0; d = pc1[d + 1];\r\nc = k[1]; c &= 0xe0; c >>= 4; c |= k[5] & 0xf0; c = pc1[c + 1];\r\nb = k[2]; b &= 0xe0; b >>= 4; b |= k[6] & 0xf0; b = pc1[b + 1];\r\na = k[3]; a &= 0xe0; a >>= 4; a |= k[7] & 0xf0; a = pc1[a + 1];\r\nw |= (a ^ c) | (b ^ d) | (rs[a] ^ c) | (b ^ rs[d]);\r\npe[15 * 2 + 1] = DES_PC2(a, b, c, d); d = rs[d];\r\npe[14 * 2 + 1] = DES_PC2(d, a, b, c); c = rs[c]; b = rs[b];\r\npe[13 * 2 + 1] = DES_PC2(b, c, d, a); a = rs[a]; d = rs[d];\r\npe[12 * 2 + 1] = DES_PC2(d, a, b, c); c = rs[c]; b = rs[b];\r\npe[11 * 2 + 1] = DES_PC2(b, c, d, a); a = rs[a]; d = rs[d];\r\npe[10 * 2 + 1] = DES_PC2(d, a, b, c); c = rs[c]; b = rs[b];\r\npe[ 9 * 2 + 1] = DES_PC2(b, c, d, a); a = rs[a]; d = rs[d];\r\npe[ 8 * 2 + 1] = DES_PC2(d, a, b, c); c = rs[c];\r\npe[ 7 * 2 + 1] = DES_PC2(c, d, a, b); b = rs[b]; a = rs[a];\r\npe[ 6 * 2 + 1] = DES_PC2(a, b, c, d); d = rs[d]; c = rs[c];\r\npe[ 5 * 2 + 1] = DES_PC2(c, d, a, b); b = rs[b]; a = rs[a];\r\npe[ 4 * 2 + 1] = DES_PC2(a, b, c, d); d = rs[d]; c = rs[c];\r\npe[ 3 * 2 + 1] = DES_PC2(c, d, a, b); b = rs[b]; a = rs[a];\r\npe[ 2 * 2 + 1] = DES_PC2(a, b, c, d); d = rs[d]; c = rs[c];\r\npe[ 1 * 2 + 1] = DES_PC2(c, d, a, b); b = rs[b];\r\npe[ 0 * 2 + 1] = DES_PC2(b, c, d, a);\r\nfor (d = 0; d < 16; ++d) {\r\na = pe[2 * d];\r\nb = pe[2 * d + 1];\r\nc = a ^ b;\r\nc &= 0xffff0000;\r\na ^= c;\r\nb ^= c;\r\nROL(b, 18);\r\npe[2 * d] = a;\r\npe[2 * d + 1] = b;\r\n}\r\nreturn w;\r\n}\r\nstatic void dkey(u32 *pe, const u8 *k)\r\n{\r\nunsigned long a, b, c, d;\r\nconst u32 *pt = pc2;\r\nd = k[4]; d &= 0x0e; d <<= 4; d |= k[0] & 0x1e; d = pc1[d];\r\nc = k[5]; c &= 0x0e; c <<= 4; c |= k[1] & 0x1e; c = pc1[c];\r\nb = k[6]; b &= 0x0e; b <<= 4; b |= k[2] & 0x1e; b = pc1[b];\r\na = k[7]; a &= 0x0e; a <<= 4; a |= k[3] & 0x1e; a = pc1[a];\r\npe[ 0 * 2] = DES_PC2(a, b, c, d); d = rs[d];\r\npe[ 1 * 2] = DES_PC2(d, a, b, c); c = rs[c]; b = rs[b];\r\npe[ 2 * 2] = DES_PC2(b, c, d, a); a = rs[a]; d = rs[d];\r\npe[ 3 * 2] = DES_PC2(d, a, b, c); c = rs[c]; b = rs[b];\r\npe[ 4 * 2] = DES_PC2(b, c, d, a); a = rs[a]; d = rs[d];\r\npe[ 5 * 2] = DES_PC2(d, a, b, c); c = rs[c]; b = rs[b];\r\npe[ 6 * 2] = DES_PC2(b, c, d, a); a = rs[a]; d = rs[d];\r\npe[ 7 * 2] = DES_PC2(d, a, b, c); c = rs[c];\r\npe[ 8 * 2] = DES_PC2(c, d, a, b); b = rs[b]; a = rs[a];\r\npe[ 9 * 2] = DES_PC2(a, b, c, d); d = rs[d]; c = rs[c];\r\npe[10 * 2] = DES_PC2(c, d, a, b); b = rs[b]; a = rs[a];\r\npe[11 * 2] = DES_PC2(a, b, c, d); d = rs[d]; c = rs[c];\r\npe[12 * 2] = DES_PC2(c, d, a, b); b = rs[b]; a = rs[a];\r\npe[13 * 2] = DES_PC2(a, b, c, d); d = rs[d]; c = rs[c];\r\npe[14 * 2] = DES_PC2(c, d, a, b); b = rs[b];\r\npe[15 * 2] = DES_PC2(b, c, d, a);\r\npt += 512;\r\nd = k[0]; d &= 0xe0; d >>= 4; d |= k[4] & 0xf0; d = pc1[d + 1];\r\nc = k[1]; c &= 0xe0; c >>= 4; c |= k[5] & 0xf0; c = pc1[c + 1];\r\nb = k[2]; b &= 0xe0; b >>= 4; b |= k[6] & 0xf0; b = pc1[b + 1];\r\na = k[3]; a &= 0xe0; a >>= 4; a |= k[7] & 0xf0; a = pc1[a + 1];\r\npe[ 0 * 2 + 1] = DES_PC2(a, b, c, d); d = rs[d];\r\npe[ 1 * 2 + 1] = DES_PC2(d, a, b, c); c = rs[c]; b = rs[b];\r\npe[ 2 * 2 + 1] = DES_PC2(b, c, d, a); a = rs[a]; d = rs[d];\r\npe[ 3 * 2 + 1] = DES_PC2(d, a, b, c); c = rs[c]; b = rs[b];\r\npe[ 4 * 2 + 1] = DES_PC2(b, c, d, a); a = rs[a]; d = rs[d];\r\npe[ 5 * 2 + 1] = DES_PC2(d, a, b, c); c = rs[c]; b = rs[b];\r\npe[ 6 * 2 + 1] = DES_PC2(b, c, d, a); a = rs[a]; d = rs[d];\r\npe[ 7 * 2 + 1] = DES_PC2(d, a, b, c); c = rs[c];\r\npe[ 8 * 2 + 1] = DES_PC2(c, d, a, b); b = rs[b]; a = rs[a];\r\npe[ 9 * 2 + 1] = DES_PC2(a, b, c, d); d = rs[d]; c = rs[c];\r\npe[10 * 2 + 1] = DES_PC2(c, d, a, b); b = rs[b]; a = rs[a];\r\npe[11 * 2 + 1] = DES_PC2(a, b, c, d); d = rs[d]; c = rs[c];\r\npe[12 * 2 + 1] = DES_PC2(c, d, a, b); b = rs[b]; a = rs[a];\r\npe[13 * 2 + 1] = DES_PC2(a, b, c, d); d = rs[d]; c = rs[c];\r\npe[14 * 2 + 1] = DES_PC2(c, d, a, b); b = rs[b];\r\npe[15 * 2 + 1] = DES_PC2(b, c, d, a);\r\nfor (d = 0; d < 16; ++d) {\r\na = pe[2 * d];\r\nb = pe[2 * d + 1];\r\nc = a ^ b;\r\nc &= 0xffff0000;\r\na ^= c;\r\nb ^= c;\r\nROL(b, 18);\r\npe[2 * d] = a;\r\npe[2 * d + 1] = b;\r\n}\r\n}\r\nstatic int des_setkey(struct crypto_tfm *tfm, const u8 *key,\r\nunsigned int keylen)\r\n{\r\nstruct des_ctx *dctx = crypto_tfm_ctx(tfm);\r\nu32 *flags = &tfm->crt_flags;\r\nu32 tmp[DES_EXPKEY_WORDS];\r\nint ret;\r\nret = des_ekey(tmp, key);\r\nif (unlikely(ret == 0) && (*flags & CRYPTO_TFM_REQ_WEAK_KEY)) {\r\n*flags |= CRYPTO_TFM_RES_WEAK_KEY;\r\nreturn -EINVAL;\r\n}\r\nmemcpy(dctx->expkey, tmp, sizeof(dctx->expkey));\r\nreturn 0;\r\n}\r\nstatic void des_encrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\nstruct des_ctx *ctx = crypto_tfm_ctx(tfm);\r\nconst u32 *K = ctx->expkey;\r\nconst __le32 *s = (const __le32 *)src;\r\n__le32 *d = (__le32 *)dst;\r\nu32 L, R, A, B;\r\nint i;\r\nL = le32_to_cpu(s[0]);\r\nR = le32_to_cpu(s[1]);\r\nIP(L, R, A);\r\nfor (i = 0; i < 8; i++) {\r\nROUND(L, R, A, B, K, 2);\r\nROUND(R, L, A, B, K, 2);\r\n}\r\nFP(R, L, A);\r\nd[0] = cpu_to_le32(R);\r\nd[1] = cpu_to_le32(L);\r\n}\r\nstatic void des_decrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\nstruct des_ctx *ctx = crypto_tfm_ctx(tfm);\r\nconst u32 *K = ctx->expkey + DES_EXPKEY_WORDS - 2;\r\nconst __le32 *s = (const __le32 *)src;\r\n__le32 *d = (__le32 *)dst;\r\nu32 L, R, A, B;\r\nint i;\r\nL = le32_to_cpu(s[0]);\r\nR = le32_to_cpu(s[1]);\r\nIP(L, R, A);\r\nfor (i = 0; i < 8; i++) {\r\nROUND(L, R, A, B, K, -2);\r\nROUND(R, L, A, B, K, -2);\r\n}\r\nFP(R, L, A);\r\nd[0] = cpu_to_le32(R);\r\nd[1] = cpu_to_le32(L);\r\n}\r\nint __des3_ede_setkey(u32 *expkey, u32 *flags, const u8 *key,\r\nunsigned int keylen)\r\n{\r\nconst u32 *K = (const u32 *)key;\r\nif (unlikely(!((K[0] ^ K[2]) | (K[1] ^ K[3])) ||\r\n!((K[2] ^ K[4]) | (K[3] ^ K[5]))) &&\r\n(*flags & CRYPTO_TFM_REQ_WEAK_KEY)) {\r\n*flags |= CRYPTO_TFM_RES_WEAK_KEY;\r\nreturn -EINVAL;\r\n}\r\ndes_ekey(expkey, key); expkey += DES_EXPKEY_WORDS; key += DES_KEY_SIZE;\r\ndkey(expkey, key); expkey += DES_EXPKEY_WORDS; key += DES_KEY_SIZE;\r\ndes_ekey(expkey, key);\r\nreturn 0;\r\n}\r\nstatic int des3_ede_setkey(struct crypto_tfm *tfm, const u8 *key,\r\nunsigned int keylen)\r\n{\r\nstruct des3_ede_ctx *dctx = crypto_tfm_ctx(tfm);\r\nu32 *flags = &tfm->crt_flags;\r\nu32 *expkey = dctx->expkey;\r\nreturn __des3_ede_setkey(expkey, flags, key, keylen);\r\n}\r\nstatic void des3_ede_encrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\nstruct des3_ede_ctx *dctx = crypto_tfm_ctx(tfm);\r\nconst u32 *K = dctx->expkey;\r\nconst __le32 *s = (const __le32 *)src;\r\n__le32 *d = (__le32 *)dst;\r\nu32 L, R, A, B;\r\nint i;\r\nL = le32_to_cpu(s[0]);\r\nR = le32_to_cpu(s[1]);\r\nIP(L, R, A);\r\nfor (i = 0; i < 8; i++) {\r\nROUND(L, R, A, B, K, 2);\r\nROUND(R, L, A, B, K, 2);\r\n}\r\nfor (i = 0; i < 8; i++) {\r\nROUND(R, L, A, B, K, 2);\r\nROUND(L, R, A, B, K, 2);\r\n}\r\nfor (i = 0; i < 8; i++) {\r\nROUND(L, R, A, B, K, 2);\r\nROUND(R, L, A, B, K, 2);\r\n}\r\nFP(R, L, A);\r\nd[0] = cpu_to_le32(R);\r\nd[1] = cpu_to_le32(L);\r\n}\r\nstatic void des3_ede_decrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\nstruct des3_ede_ctx *dctx = crypto_tfm_ctx(tfm);\r\nconst u32 *K = dctx->expkey + DES3_EDE_EXPKEY_WORDS - 2;\r\nconst __le32 *s = (const __le32 *)src;\r\n__le32 *d = (__le32 *)dst;\r\nu32 L, R, A, B;\r\nint i;\r\nL = le32_to_cpu(s[0]);\r\nR = le32_to_cpu(s[1]);\r\nIP(L, R, A);\r\nfor (i = 0; i < 8; i++) {\r\nROUND(L, R, A, B, K, -2);\r\nROUND(R, L, A, B, K, -2);\r\n}\r\nfor (i = 0; i < 8; i++) {\r\nROUND(R, L, A, B, K, -2);\r\nROUND(L, R, A, B, K, -2);\r\n}\r\nfor (i = 0; i < 8; i++) {\r\nROUND(L, R, A, B, K, -2);\r\nROUND(R, L, A, B, K, -2);\r\n}\r\nFP(R, L, A);\r\nd[0] = cpu_to_le32(R);\r\nd[1] = cpu_to_le32(L);\r\n}\r\nstatic int __init des_generic_mod_init(void)\r\n{\r\nreturn crypto_register_algs(des_algs, ARRAY_SIZE(des_algs));\r\n}\r\nstatic void __exit des_generic_mod_fini(void)\r\n{\r\ncrypto_unregister_algs(des_algs, ARRAY_SIZE(des_algs));\r\n}

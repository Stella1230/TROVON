static unsigned bitbang_txrx_8(\r\nstruct spi_device *spi,\r\nu32 (*txrx_word)(struct spi_device *spi,\r\nunsigned nsecs,\r\nu32 word, u8 bits),\r\nunsigned ns,\r\nstruct spi_transfer *t\r\n) {\r\nunsigned bits = t->bits_per_word;\r\nunsigned count = t->len;\r\nconst u8 *tx = t->tx_buf;\r\nu8 *rx = t->rx_buf;\r\nwhile (likely(count > 0)) {\r\nu8 word = 0;\r\nif (tx)\r\nword = *tx++;\r\nword = txrx_word(spi, ns, word, bits);\r\nif (rx)\r\n*rx++ = word;\r\ncount -= 1;\r\n}\r\nreturn t->len - count;\r\n}\r\nstatic unsigned bitbang_txrx_16(\r\nstruct spi_device *spi,\r\nu32 (*txrx_word)(struct spi_device *spi,\r\nunsigned nsecs,\r\nu32 word, u8 bits),\r\nunsigned ns,\r\nstruct spi_transfer *t\r\n) {\r\nunsigned bits = t->bits_per_word;\r\nunsigned count = t->len;\r\nconst u16 *tx = t->tx_buf;\r\nu16 *rx = t->rx_buf;\r\nwhile (likely(count > 1)) {\r\nu16 word = 0;\r\nif (tx)\r\nword = *tx++;\r\nword = txrx_word(spi, ns, word, bits);\r\nif (rx)\r\n*rx++ = word;\r\ncount -= 2;\r\n}\r\nreturn t->len - count;\r\n}\r\nstatic unsigned bitbang_txrx_32(\r\nstruct spi_device *spi,\r\nu32 (*txrx_word)(struct spi_device *spi,\r\nunsigned nsecs,\r\nu32 word, u8 bits),\r\nunsigned ns,\r\nstruct spi_transfer *t\r\n) {\r\nunsigned bits = t->bits_per_word;\r\nunsigned count = t->len;\r\nconst u32 *tx = t->tx_buf;\r\nu32 *rx = t->rx_buf;\r\nwhile (likely(count > 3)) {\r\nu32 word = 0;\r\nif (tx)\r\nword = *tx++;\r\nword = txrx_word(spi, ns, word, bits);\r\nif (rx)\r\n*rx++ = word;\r\ncount -= 4;\r\n}\r\nreturn t->len - count;\r\n}\r\nint spi_bitbang_setup_transfer(struct spi_device *spi, struct spi_transfer *t)\r\n{\r\nstruct spi_bitbang_cs *cs = spi->controller_state;\r\nu8 bits_per_word;\r\nu32 hz;\r\nif (t) {\r\nbits_per_word = t->bits_per_word;\r\nhz = t->speed_hz;\r\n} else {\r\nbits_per_word = 0;\r\nhz = 0;\r\n}\r\nif (!bits_per_word)\r\nbits_per_word = spi->bits_per_word;\r\nif (bits_per_word <= 8)\r\ncs->txrx_bufs = bitbang_txrx_8;\r\nelse if (bits_per_word <= 16)\r\ncs->txrx_bufs = bitbang_txrx_16;\r\nelse if (bits_per_word <= 32)\r\ncs->txrx_bufs = bitbang_txrx_32;\r\nelse\r\nreturn -EINVAL;\r\nif (!hz)\r\nhz = spi->max_speed_hz;\r\nif (hz) {\r\ncs->nsecs = (1000000000/2) / hz;\r\nif (cs->nsecs > (MAX_UDELAY_MS * 1000 * 1000))\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint spi_bitbang_setup(struct spi_device *spi)\r\n{\r\nstruct spi_bitbang_cs *cs = spi->controller_state;\r\nstruct spi_bitbang *bitbang;\r\nint retval;\r\nunsigned long flags;\r\nbitbang = spi_master_get_devdata(spi->master);\r\nif (!cs) {\r\ncs = kzalloc(sizeof(*cs), GFP_KERNEL);\r\nif (!cs)\r\nreturn -ENOMEM;\r\nspi->controller_state = cs;\r\n}\r\ncs->txrx_word = bitbang->txrx_word[spi->mode & (SPI_CPOL|SPI_CPHA)];\r\nif (!cs->txrx_word)\r\nreturn -EINVAL;\r\nretval = bitbang->setup_transfer(spi, NULL);\r\nif (retval < 0)\r\nreturn retval;\r\ndev_dbg(&spi->dev, "%s, %u nsec/bit\n", __func__, 2 * cs->nsecs);\r\nspin_lock_irqsave(&bitbang->lock, flags);\r\nif (!bitbang->busy) {\r\nbitbang->chipselect(spi, BITBANG_CS_INACTIVE);\r\nndelay(cs->nsecs);\r\n}\r\nspin_unlock_irqrestore(&bitbang->lock, flags);\r\nreturn 0;\r\n}\r\nvoid spi_bitbang_cleanup(struct spi_device *spi)\r\n{\r\nkfree(spi->controller_state);\r\n}\r\nstatic int spi_bitbang_bufs(struct spi_device *spi, struct spi_transfer *t)\r\n{\r\nstruct spi_bitbang_cs *cs = spi->controller_state;\r\nunsigned nsecs = cs->nsecs;\r\nreturn cs->txrx_bufs(spi, cs->txrx_word, nsecs, t);\r\n}\r\nstatic int spi_bitbang_prepare_hardware(struct spi_master *spi)\r\n{\r\nstruct spi_bitbang *bitbang;\r\nunsigned long flags;\r\nbitbang = spi_master_get_devdata(spi);\r\nspin_lock_irqsave(&bitbang->lock, flags);\r\nbitbang->busy = 1;\r\nspin_unlock_irqrestore(&bitbang->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int spi_bitbang_transfer_one(struct spi_master *master,\r\nstruct spi_message *m)\r\n{\r\nstruct spi_bitbang *bitbang;\r\nunsigned nsecs;\r\nstruct spi_transfer *t = NULL;\r\nunsigned cs_change;\r\nint status;\r\nint do_setup = -1;\r\nstruct spi_device *spi = m->spi;\r\nbitbang = spi_master_get_devdata(master);\r\nnsecs = 100;\r\ncs_change = 1;\r\nstatus = 0;\r\nlist_for_each_entry(t, &m->transfers, transfer_list) {\r\nif (t->speed_hz || t->bits_per_word)\r\ndo_setup = 1;\r\nif (do_setup != 0) {\r\nstatus = bitbang->setup_transfer(spi, t);\r\nif (status < 0)\r\nbreak;\r\nif (do_setup == -1)\r\ndo_setup = 0;\r\n}\r\nif (cs_change) {\r\nbitbang->chipselect(spi, BITBANG_CS_ACTIVE);\r\nndelay(nsecs);\r\n}\r\ncs_change = t->cs_change;\r\nif (!t->tx_buf && !t->rx_buf && t->len) {\r\nstatus = -EINVAL;\r\nbreak;\r\n}\r\nif (t->len) {\r\nif (!m->is_dma_mapped)\r\nt->rx_dma = t->tx_dma = 0;\r\nstatus = bitbang->txrx_bufs(spi, t);\r\n}\r\nif (status > 0)\r\nm->actual_length += status;\r\nif (status != t->len) {\r\nif (status >= 0)\r\nstatus = -EREMOTEIO;\r\nbreak;\r\n}\r\nstatus = 0;\r\nif (t->delay_usecs)\r\nudelay(t->delay_usecs);\r\nif (cs_change &&\r\n!list_is_last(&t->transfer_list, &m->transfers)) {\r\nndelay(nsecs);\r\nbitbang->chipselect(spi, BITBANG_CS_INACTIVE);\r\nndelay(nsecs);\r\n}\r\n}\r\nm->status = status;\r\nif (!(status == 0 && cs_change)) {\r\nndelay(nsecs);\r\nbitbang->chipselect(spi, BITBANG_CS_INACTIVE);\r\nndelay(nsecs);\r\n}\r\nspi_finalize_current_message(master);\r\nreturn status;\r\n}\r\nstatic int spi_bitbang_unprepare_hardware(struct spi_master *spi)\r\n{\r\nstruct spi_bitbang *bitbang;\r\nunsigned long flags;\r\nbitbang = spi_master_get_devdata(spi);\r\nspin_lock_irqsave(&bitbang->lock, flags);\r\nbitbang->busy = 0;\r\nspin_unlock_irqrestore(&bitbang->lock, flags);\r\nreturn 0;\r\n}\r\nint spi_bitbang_start(struct spi_bitbang *bitbang)\r\n{\r\nstruct spi_master *master = bitbang->master;\r\nint ret;\r\nif (!master || !bitbang->chipselect)\r\nreturn -EINVAL;\r\nspin_lock_init(&bitbang->lock);\r\nif (!master->mode_bits)\r\nmaster->mode_bits = SPI_CPOL | SPI_CPHA | bitbang->flags;\r\nif (master->transfer || master->transfer_one_message)\r\nreturn -EINVAL;\r\nmaster->prepare_transfer_hardware = spi_bitbang_prepare_hardware;\r\nmaster->unprepare_transfer_hardware = spi_bitbang_unprepare_hardware;\r\nmaster->transfer_one_message = spi_bitbang_transfer_one;\r\nif (!bitbang->txrx_bufs) {\r\nbitbang->use_dma = 0;\r\nbitbang->txrx_bufs = spi_bitbang_bufs;\r\nif (!master->setup) {\r\nif (!bitbang->setup_transfer)\r\nbitbang->setup_transfer =\r\nspi_bitbang_setup_transfer;\r\nmaster->setup = spi_bitbang_setup;\r\nmaster->cleanup = spi_bitbang_cleanup;\r\n}\r\n}\r\nret = spi_register_master(spi_master_get(master));\r\nif (ret)\r\nspi_master_put(master);\r\nreturn 0;\r\n}\r\nvoid spi_bitbang_stop(struct spi_bitbang *bitbang)\r\n{\r\nspi_unregister_master(bitbang->master);\r\n}

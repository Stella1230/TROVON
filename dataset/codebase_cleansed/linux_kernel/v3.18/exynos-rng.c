static u32 exynos_rng_readl(struct exynos_rng *rng, u32 offset)\r\n{\r\nreturn __raw_readl(rng->mem + offset);\r\n}\r\nstatic void exynos_rng_writel(struct exynos_rng *rng, u32 val, u32 offset)\r\n{\r\n__raw_writel(val, rng->mem + offset);\r\n}\r\nstatic int exynos_init(struct hwrng *rng)\r\n{\r\nstruct exynos_rng *exynos_rng = container_of(rng,\r\nstruct exynos_rng, rng);\r\nint i;\r\nint ret = 0;\r\npm_runtime_get_sync(exynos_rng->dev);\r\nfor (i = 0 ; i < 5 ; i++)\r\nexynos_rng_writel(exynos_rng, jiffies,\r\nEXYNOS_PRNG_SEED_OFFSET + 4*i);\r\nif (!(exynos_rng_readl(exynos_rng, EXYNOS_PRNG_STATUS_OFFSET)\r\n& SEED_SETTING_DONE))\r\nret = -EIO;\r\npm_runtime_put_noidle(exynos_rng->dev);\r\nreturn ret;\r\n}\r\nstatic int exynos_read(struct hwrng *rng, void *buf,\r\nsize_t max, bool wait)\r\n{\r\nstruct exynos_rng *exynos_rng = container_of(rng,\r\nstruct exynos_rng, rng);\r\nu32 *data = buf;\r\npm_runtime_get_sync(exynos_rng->dev);\r\nexynos_rng_writel(exynos_rng, PRNG_START, 0);\r\nwhile (!(exynos_rng_readl(exynos_rng,\r\nEXYNOS_PRNG_STATUS_OFFSET) & PRNG_DONE))\r\ncpu_relax();\r\nexynos_rng_writel(exynos_rng, PRNG_DONE, EXYNOS_PRNG_STATUS_OFFSET);\r\n*data = exynos_rng_readl(exynos_rng, EXYNOS_PRNG_OUT1_OFFSET);\r\npm_runtime_mark_last_busy(exynos_rng->dev);\r\npm_runtime_autosuspend(exynos_rng->dev);\r\nreturn 4;\r\n}\r\nstatic int exynos_rng_probe(struct platform_device *pdev)\r\n{\r\nstruct exynos_rng *exynos_rng;\r\nstruct resource *res;\r\nexynos_rng = devm_kzalloc(&pdev->dev, sizeof(struct exynos_rng),\r\nGFP_KERNEL);\r\nif (!exynos_rng)\r\nreturn -ENOMEM;\r\nexynos_rng->dev = &pdev->dev;\r\nexynos_rng->rng.name = "exynos";\r\nexynos_rng->rng.init = exynos_init;\r\nexynos_rng->rng.read = exynos_read;\r\nexynos_rng->clk = devm_clk_get(&pdev->dev, "secss");\r\nif (IS_ERR(exynos_rng->clk)) {\r\ndev_err(&pdev->dev, "Couldn't get clock.\n");\r\nreturn -ENOENT;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nexynos_rng->mem = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(exynos_rng->mem))\r\nreturn PTR_ERR(exynos_rng->mem);\r\nplatform_set_drvdata(pdev, exynos_rng);\r\npm_runtime_set_autosuspend_delay(&pdev->dev, EXYNOS_AUTOSUSPEND_DELAY);\r\npm_runtime_use_autosuspend(&pdev->dev);\r\npm_runtime_enable(&pdev->dev);\r\nreturn hwrng_register(&exynos_rng->rng);\r\n}\r\nstatic int exynos_rng_remove(struct platform_device *pdev)\r\n{\r\nstruct exynos_rng *exynos_rng = platform_get_drvdata(pdev);\r\nhwrng_unregister(&exynos_rng->rng);\r\nreturn 0;\r\n}\r\nstatic int exynos_rng_runtime_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct exynos_rng *exynos_rng = platform_get_drvdata(pdev);\r\nclk_disable_unprepare(exynos_rng->clk);\r\nreturn 0;\r\n}\r\nstatic int exynos_rng_runtime_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct exynos_rng *exynos_rng = platform_get_drvdata(pdev);\r\nreturn clk_prepare_enable(exynos_rng->clk);\r\n}

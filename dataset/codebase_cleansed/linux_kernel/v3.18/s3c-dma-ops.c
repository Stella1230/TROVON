static void s3c_dma_cb(struct s3c2410_dma_chan *channel, void *param,\r\nint size, enum s3c2410_dma_buffresult res)\r\n{\r\nstruct cb_data *data = param;\r\ndata->fp(data->fp_param);\r\n}\r\nstatic unsigned s3c_dma_request(enum dma_ch dma_ch,\r\nstruct samsung_dma_req *param,\r\nstruct device *dev, char *ch_name)\r\n{\r\nstruct cb_data *data;\r\nif (s3c2410_dma_request(dma_ch, param->client, NULL) < 0) {\r\ns3c2410_dma_free(dma_ch, param->client);\r\nreturn 0;\r\n}\r\nif (param->cap == DMA_CYCLIC)\r\ns3c2410_dma_setflags(dma_ch, S3C2410_DMAF_CIRCULAR);\r\ndata = kzalloc(sizeof(struct cb_data), GFP_KERNEL);\r\ndata->ch = dma_ch;\r\nlist_add_tail(&data->node, &dma_list);\r\nreturn (unsigned)dma_ch;\r\n}\r\nstatic int s3c_dma_release(unsigned ch, void *param)\r\n{\r\nstruct cb_data *data;\r\nlist_for_each_entry(data, &dma_list, node)\r\nif (data->ch == ch)\r\nbreak;\r\nlist_del(&data->node);\r\ns3c2410_dma_free(ch, param);\r\nkfree(data);\r\nreturn 0;\r\n}\r\nstatic int s3c_dma_config(unsigned ch, struct samsung_dma_config *param)\r\n{\r\ns3c2410_dma_devconfig(ch, param->direction, param->fifo);\r\ns3c2410_dma_config(ch, param->width);\r\nreturn 0;\r\n}\r\nstatic int s3c_dma_prepare(unsigned ch, struct samsung_dma_prep *param)\r\n{\r\nstruct cb_data *data;\r\ndma_addr_t pos = param->buf;\r\ndma_addr_t end = param->buf + param->len;\r\nlist_for_each_entry(data, &dma_list, node)\r\nif (data->ch == ch)\r\nbreak;\r\nif (!data->fp) {\r\ns3c2410_dma_set_buffdone_fn(ch, s3c_dma_cb);\r\ndata->fp = param->fp;\r\ndata->fp_param = param->fp_param;\r\n}\r\nif (param->cap != DMA_CYCLIC) {\r\ns3c2410_dma_enqueue(ch, (void *)data, param->buf, param->len);\r\nreturn 0;\r\n}\r\nwhile (pos < end) {\r\ns3c2410_dma_enqueue(ch, (void *)data, pos, param->period);\r\npos += param->period;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int s3c_dma_trigger(unsigned ch)\r\n{\r\nreturn s3c2410_dma_ctrl(ch, S3C2410_DMAOP_START);\r\n}\r\nstatic inline int s3c_dma_started(unsigned ch)\r\n{\r\nreturn s3c2410_dma_ctrl(ch, S3C2410_DMAOP_STARTED);\r\n}\r\nstatic inline int s3c_dma_flush(unsigned ch)\r\n{\r\nreturn s3c2410_dma_ctrl(ch, S3C2410_DMAOP_FLUSH);\r\n}\r\nstatic inline int s3c_dma_stop(unsigned ch)\r\n{\r\nreturn s3c2410_dma_ctrl(ch, S3C2410_DMAOP_STOP);\r\n}\r\nvoid *s3c_dma_get_ops(void)\r\n{\r\nreturn &s3c_dma_ops;\r\n}

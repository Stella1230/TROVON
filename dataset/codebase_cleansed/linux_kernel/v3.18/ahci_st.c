static void st_ahci_configure_oob(void __iomem *mmio)\r\n{\r\nunsigned long old_val, new_val;\r\nnew_val = (0x02 << ST_AHCI_OOBR_CWMIN_SHIFT) |\r\n(0x04 << ST_AHCI_OOBR_CWMAX_SHIFT) |\r\n(0x08 << ST_AHCI_OOBR_CIMIN_SHIFT) |\r\n(0x0C << ST_AHCI_OOBR_CIMAX_SHIFT);\r\nold_val = readl(mmio + ST_AHCI_OOBR);\r\nwritel(old_val | ST_AHCI_OOBR_WE, mmio + ST_AHCI_OOBR);\r\nwritel(new_val | ST_AHCI_OOBR_WE, mmio + ST_AHCI_OOBR);\r\nwritel(new_val, mmio + ST_AHCI_OOBR);\r\n}\r\nstatic int st_ahci_deassert_resets(struct device *dev)\r\n{\r\nstruct st_ahci_drv_data *drv_data = dev_get_drvdata(dev);\r\nint err;\r\nif (drv_data->pwr) {\r\nerr = reset_control_deassert(drv_data->pwr);\r\nif (err) {\r\ndev_err(dev, "unable to bring out of pwrdwn\n");\r\nreturn err;\r\n}\r\n}\r\nst_ahci_configure_oob(drv_data->hpriv->mmio);\r\nif (drv_data->sw_rst) {\r\nerr = reset_control_deassert(drv_data->sw_rst);\r\nif (err) {\r\ndev_err(dev, "unable to bring out of sw-rst\n");\r\nreturn err;\r\n}\r\n}\r\nif (drv_data->pwr_rst) {\r\nerr = reset_control_deassert(drv_data->pwr_rst);\r\nif (err) {\r\ndev_err(dev, "unable to bring out of pwr-rst\n");\r\nreturn err;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void st_ahci_host_stop(struct ata_host *host)\r\n{\r\nstruct ahci_host_priv *hpriv = host->private_data;\r\nstruct device *dev = host->dev;\r\nstruct st_ahci_drv_data *drv_data = dev_get_drvdata(dev);\r\nint err;\r\nif (drv_data->pwr) {\r\nerr = reset_control_assert(drv_data->pwr);\r\nif (err)\r\ndev_err(dev, "unable to pwrdwn\n");\r\n}\r\nahci_platform_disable_resources(hpriv);\r\n}\r\nstatic int st_ahci_probe_resets(struct platform_device *pdev)\r\n{\r\nstruct st_ahci_drv_data *drv_data = platform_get_drvdata(pdev);\r\ndrv_data->pwr = devm_reset_control_get(&pdev->dev, "pwr-dwn");\r\nif (IS_ERR(drv_data->pwr)) {\r\ndev_info(&pdev->dev, "power reset control not defined\n");\r\ndrv_data->pwr = NULL;\r\n}\r\ndrv_data->sw_rst = devm_reset_control_get(&pdev->dev, "sw-rst");\r\nif (IS_ERR(drv_data->sw_rst)) {\r\ndev_info(&pdev->dev, "soft reset control not defined\n");\r\ndrv_data->sw_rst = NULL;\r\n}\r\ndrv_data->pwr_rst = devm_reset_control_get(&pdev->dev, "pwr-rst");\r\nif (IS_ERR(drv_data->pwr_rst)) {\r\ndev_dbg(&pdev->dev, "power soft reset control not defined\n");\r\ndrv_data->pwr_rst = NULL;\r\n}\r\nreturn st_ahci_deassert_resets(&pdev->dev);\r\n}\r\nstatic int st_ahci_probe(struct platform_device *pdev)\r\n{\r\nstruct st_ahci_drv_data *drv_data;\r\nstruct ahci_host_priv *hpriv;\r\nint err;\r\ndrv_data = devm_kzalloc(&pdev->dev, sizeof(*drv_data), GFP_KERNEL);\r\nif (!drv_data)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, drv_data);\r\nhpriv = ahci_platform_get_resources(pdev);\r\nif (IS_ERR(hpriv))\r\nreturn PTR_ERR(hpriv);\r\ndrv_data->hpriv = hpriv;\r\nerr = st_ahci_probe_resets(pdev);\r\nif (err)\r\nreturn err;\r\nerr = ahci_platform_enable_resources(hpriv);\r\nif (err)\r\nreturn err;\r\nerr = ahci_platform_init_host(pdev, hpriv, &st_ahci_port_info);\r\nif (err) {\r\nahci_platform_disable_resources(hpriv);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int st_ahci_suspend(struct device *dev)\r\n{\r\nstruct st_ahci_drv_data *drv_data = dev_get_drvdata(dev);\r\nstruct ahci_host_priv *hpriv = drv_data->hpriv;\r\nint err;\r\nerr = ahci_platform_suspend_host(dev);\r\nif (err)\r\nreturn err;\r\nif (drv_data->pwr) {\r\nerr = reset_control_assert(drv_data->pwr);\r\nif (err) {\r\ndev_err(dev, "unable to pwrdwn");\r\nreturn err;\r\n}\r\n}\r\nahci_platform_disable_resources(hpriv);\r\nreturn 0;\r\n}\r\nstatic int st_ahci_resume(struct device *dev)\r\n{\r\nstruct st_ahci_drv_data *drv_data = dev_get_drvdata(dev);\r\nstruct ahci_host_priv *hpriv = drv_data->hpriv;\r\nint err;\r\nerr = ahci_platform_enable_resources(hpriv);\r\nif (err)\r\nreturn err;\r\nerr = st_ahci_deassert_resets(dev);\r\nif (err) {\r\nahci_platform_disable_resources(hpriv);\r\nreturn err;\r\n}\r\nreturn ahci_platform_resume_host(dev);\r\n}

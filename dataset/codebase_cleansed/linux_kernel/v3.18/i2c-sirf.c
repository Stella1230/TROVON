static void i2c_sirfsoc_read_data(struct sirfsoc_i2c *siic)\r\n{\r\nu32 data = 0;\r\nint i;\r\nfor (i = 0; i < siic->read_cmd_len; i++) {\r\nif (!(i & 0x3))\r\ndata = readl(siic->base + SIRFSOC_I2C_DATA_BUF + i);\r\nsiic->buf[siic->finished_len++] =\r\n(u8)((data & SIRFSOC_I2C_DATA_MASK(i)) >>\r\nSIRFSOC_I2C_DATA_SHIFT(i));\r\n}\r\n}\r\nstatic void i2c_sirfsoc_queue_cmd(struct sirfsoc_i2c *siic)\r\n{\r\nu32 regval;\r\nint i = 0;\r\nif (siic->msg_read) {\r\nwhile (((siic->finished_len + i) < siic->msg_len)\r\n&& (siic->cmd_ptr < SIRFSOC_I2C_CMD_BUF_MAX)) {\r\nregval = SIRFSOC_I2C_READ | SIRFSOC_I2C_CMD_RP(0);\r\nif (((siic->finished_len + i) ==\r\n(siic->msg_len - 1)) && siic->last)\r\nregval |= SIRFSOC_I2C_STOP | SIRFSOC_I2C_NACK;\r\nwritel(regval,\r\nsiic->base + SIRFSOC_I2C_CMD(siic->cmd_ptr++));\r\ni++;\r\n}\r\nsiic->read_cmd_len = i;\r\n} else {\r\nwhile ((siic->cmd_ptr < SIRFSOC_I2C_CMD_BUF_MAX - 1)\r\n&& (siic->finished_len < siic->msg_len)) {\r\nregval = SIRFSOC_I2C_WRITE | SIRFSOC_I2C_CMD_RP(0);\r\nif ((siic->finished_len == (siic->msg_len - 1))\r\n&& siic->last)\r\nregval |= SIRFSOC_I2C_STOP;\r\nwritel(regval,\r\nsiic->base + SIRFSOC_I2C_CMD(siic->cmd_ptr++));\r\nwritel(siic->buf[siic->finished_len++],\r\nsiic->base + SIRFSOC_I2C_CMD(siic->cmd_ptr++));\r\n}\r\n}\r\nsiic->cmd_ptr = 0;\r\nwritel(SIRFSOC_I2C_START_CMD, siic->base + SIRFSOC_I2C_CMD_START);\r\n}\r\nstatic irqreturn_t i2c_sirfsoc_irq(int irq, void *dev_id)\r\n{\r\nstruct sirfsoc_i2c *siic = (struct sirfsoc_i2c *)dev_id;\r\nu32 i2c_stat = readl(siic->base + SIRFSOC_I2C_STATUS);\r\nif (i2c_stat & SIRFSOC_I2C_STAT_ERR) {\r\nsiic->err_status = SIRFSOC_I2C_ERR_NOACK;\r\nwritel(SIRFSOC_I2C_STAT_ERR, siic->base + SIRFSOC_I2C_STATUS);\r\nif (i2c_stat & SIRFSOC_I2C_STAT_NACK)\r\ndev_dbg(&siic->adapter.dev, "ACK not received\n");\r\nelse\r\ndev_err(&siic->adapter.dev, "I2C error\n");\r\nwritel(readl(siic->base + SIRFSOC_I2C_CTRL) | SIRFSOC_I2C_RESET,\r\nsiic->base + SIRFSOC_I2C_CTRL);\r\nwhile (readl(siic->base + SIRFSOC_I2C_CTRL) & SIRFSOC_I2C_RESET)\r\ncpu_relax();\r\ncomplete(&siic->done);\r\n} else if (i2c_stat & SIRFSOC_I2C_STAT_CMD_DONE) {\r\nif (siic->msg_read)\r\ni2c_sirfsoc_read_data(siic);\r\nif (siic->finished_len == siic->msg_len)\r\ncomplete(&siic->done);\r\nelse\r\ni2c_sirfsoc_queue_cmd(siic);\r\nwritel(SIRFSOC_I2C_STAT_CMD_DONE, siic->base + SIRFSOC_I2C_STATUS);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void i2c_sirfsoc_set_address(struct sirfsoc_i2c *siic,\r\nstruct i2c_msg *msg)\r\n{\r\nunsigned char addr;\r\nu32 regval = SIRFSOC_I2C_START | SIRFSOC_I2C_CMD_RP(0) | SIRFSOC_I2C_WRITE;\r\nif (siic->last && (msg->len == 0))\r\nregval |= SIRFSOC_I2C_STOP;\r\nwritel(regval, siic->base + SIRFSOC_I2C_CMD(siic->cmd_ptr++));\r\naddr = msg->addr << 1;\r\nif (msg->flags & I2C_M_RD)\r\naddr |= 1;\r\nif (msg->flags & I2C_M_REV_DIR_ADDR)\r\naddr ^= 1;\r\nwritel(addr, siic->base + SIRFSOC_I2C_CMD(siic->cmd_ptr++));\r\n}\r\nstatic int i2c_sirfsoc_xfer_msg(struct sirfsoc_i2c *siic, struct i2c_msg *msg)\r\n{\r\nu32 regval = readl(siic->base + SIRFSOC_I2C_CTRL);\r\nint timeout = msecs_to_jiffies((msg->len + 1) * 50);\r\ni2c_sirfsoc_set_address(siic, msg);\r\nwritel(regval | SIRFSOC_I2C_CMD_DONE_EN | SIRFSOC_I2C_ERR_INT_EN,\r\nsiic->base + SIRFSOC_I2C_CTRL);\r\ni2c_sirfsoc_queue_cmd(siic);\r\nif (wait_for_completion_timeout(&siic->done, timeout) == 0) {\r\nsiic->err_status = SIRFSOC_I2C_ERR_TIMEOUT;\r\ndev_err(&siic->adapter.dev, "Transfer timeout\n");\r\n}\r\nwritel(regval & ~(SIRFSOC_I2C_CMD_DONE_EN | SIRFSOC_I2C_ERR_INT_EN),\r\nsiic->base + SIRFSOC_I2C_CTRL);\r\nwritel(0, siic->base + SIRFSOC_I2C_CMD_START);\r\nif (siic->err_status == SIRFSOC_I2C_ERR_TIMEOUT) {\r\nwritel(readl(siic->base + SIRFSOC_I2C_CTRL) | SIRFSOC_I2C_RESET,\r\nsiic->base + SIRFSOC_I2C_CTRL);\r\nwhile (readl(siic->base + SIRFSOC_I2C_CTRL) & SIRFSOC_I2C_RESET)\r\ncpu_relax();\r\n}\r\nreturn siic->err_status ? -EAGAIN : 0;\r\n}\r\nstatic u32 i2c_sirfsoc_func(struct i2c_adapter *adap)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL;\r\n}\r\nstatic int i2c_sirfsoc_xfer(struct i2c_adapter *adap, struct i2c_msg *msgs,\r\nint num)\r\n{\r\nstruct sirfsoc_i2c *siic = adap->algo_data;\r\nint i, ret;\r\nclk_enable(siic->clk);\r\nfor (i = 0; i < num; i++) {\r\nsiic->buf = msgs[i].buf;\r\nsiic->msg_len = msgs[i].len;\r\nsiic->msg_read = !!(msgs[i].flags & I2C_M_RD);\r\nsiic->err_status = 0;\r\nsiic->cmd_ptr = 0;\r\nsiic->finished_len = 0;\r\nsiic->last = (i == (num - 1));\r\nret = i2c_sirfsoc_xfer_msg(siic, &msgs[i]);\r\nif (ret) {\r\nclk_disable(siic->clk);\r\nreturn ret;\r\n}\r\n}\r\nclk_disable(siic->clk);\r\nreturn num;\r\n}\r\nstatic int i2c_sirfsoc_probe(struct platform_device *pdev)\r\n{\r\nstruct sirfsoc_i2c *siic;\r\nstruct i2c_adapter *adap;\r\nstruct resource *mem_res;\r\nstruct clk *clk;\r\nint bitrate;\r\nint ctrl_speed;\r\nint irq;\r\nint err;\r\nu32 regval;\r\nclk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(clk)) {\r\nerr = PTR_ERR(clk);\r\ndev_err(&pdev->dev, "Clock get failed\n");\r\ngoto err_get_clk;\r\n}\r\nerr = clk_prepare(clk);\r\nif (err) {\r\ndev_err(&pdev->dev, "Clock prepare failed\n");\r\ngoto err_clk_prep;\r\n}\r\nerr = clk_enable(clk);\r\nif (err) {\r\ndev_err(&pdev->dev, "Clock enable failed\n");\r\ngoto err_clk_en;\r\n}\r\nctrl_speed = clk_get_rate(clk);\r\nsiic = devm_kzalloc(&pdev->dev, sizeof(*siic), GFP_KERNEL);\r\nif (!siic) {\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\nadap = &siic->adapter;\r\nadap->class = I2C_CLASS_DEPRECATED;\r\nmem_res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nsiic->base = devm_ioremap_resource(&pdev->dev, mem_res);\r\nif (IS_ERR(siic->base)) {\r\nerr = PTR_ERR(siic->base);\r\ngoto out;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\nerr = irq;\r\ngoto out;\r\n}\r\nerr = devm_request_irq(&pdev->dev, irq, i2c_sirfsoc_irq, 0,\r\ndev_name(&pdev->dev), siic);\r\nif (err)\r\ngoto out;\r\nadap->algo = &i2c_sirfsoc_algo;\r\nadap->algo_data = siic;\r\nadap->retries = 3;\r\nadap->dev.of_node = pdev->dev.of_node;\r\nadap->dev.parent = &pdev->dev;\r\nadap->nr = pdev->id;\r\nstrlcpy(adap->name, "sirfsoc-i2c", sizeof(adap->name));\r\nplatform_set_drvdata(pdev, adap);\r\ninit_completion(&siic->done);\r\nwritel(SIRFSOC_I2C_RESET, siic->base + SIRFSOC_I2C_CTRL);\r\nwhile (readl(siic->base + SIRFSOC_I2C_CTRL) & SIRFSOC_I2C_RESET)\r\ncpu_relax();\r\nwritel(SIRFSOC_I2C_CORE_EN | SIRFSOC_I2C_MASTER_MODE,\r\nsiic->base + SIRFSOC_I2C_CTRL);\r\nsiic->clk = clk;\r\nerr = of_property_read_u32(pdev->dev.of_node,\r\n"clock-frequency", &bitrate);\r\nif (err < 0)\r\nbitrate = SIRFSOC_I2C_DEFAULT_SPEED;\r\nif (bitrate < 100000)\r\nregval =\r\n(2 * ctrl_speed) / (bitrate * 11);\r\nelse\r\nregval = ctrl_speed / (bitrate * 5);\r\nwritel(regval, siic->base + SIRFSOC_I2C_CLK_CTRL);\r\nif (regval > 0xFF)\r\nwritel(0xFF, siic->base + SIRFSOC_I2C_SDA_DELAY);\r\nelse\r\nwritel(regval, siic->base + SIRFSOC_I2C_SDA_DELAY);\r\nerr = i2c_add_numbered_adapter(adap);\r\nif (err < 0) {\r\ndev_err(&pdev->dev, "Can't add new i2c adapter\n");\r\ngoto out;\r\n}\r\nclk_disable(clk);\r\ndev_info(&pdev->dev, " I2C adapter ready to operate\n");\r\nreturn 0;\r\nout:\r\nclk_disable(clk);\r\nerr_clk_en:\r\nclk_unprepare(clk);\r\nerr_clk_prep:\r\nclk_put(clk);\r\nerr_get_clk:\r\nreturn err;\r\n}\r\nstatic int i2c_sirfsoc_remove(struct platform_device *pdev)\r\n{\r\nstruct i2c_adapter *adapter = platform_get_drvdata(pdev);\r\nstruct sirfsoc_i2c *siic = adapter->algo_data;\r\nwritel(SIRFSOC_I2C_RESET, siic->base + SIRFSOC_I2C_CTRL);\r\ni2c_del_adapter(adapter);\r\nclk_unprepare(siic->clk);\r\nclk_put(siic->clk);\r\nreturn 0;\r\n}\r\nstatic int i2c_sirfsoc_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct i2c_adapter *adapter = platform_get_drvdata(pdev);\r\nstruct sirfsoc_i2c *siic = adapter->algo_data;\r\nclk_enable(siic->clk);\r\nsiic->sda_delay = readl(siic->base + SIRFSOC_I2C_SDA_DELAY);\r\nsiic->clk_div = readl(siic->base + SIRFSOC_I2C_CLK_CTRL);\r\nclk_disable(siic->clk);\r\nreturn 0;\r\n}\r\nstatic int i2c_sirfsoc_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct i2c_adapter *adapter = platform_get_drvdata(pdev);\r\nstruct sirfsoc_i2c *siic = adapter->algo_data;\r\nclk_enable(siic->clk);\r\nwritel(SIRFSOC_I2C_RESET, siic->base + SIRFSOC_I2C_CTRL);\r\nwhile (readl(siic->base + SIRFSOC_I2C_CTRL) & SIRFSOC_I2C_RESET)\r\ncpu_relax();\r\nwritel(SIRFSOC_I2C_CORE_EN | SIRFSOC_I2C_MASTER_MODE,\r\nsiic->base + SIRFSOC_I2C_CTRL);\r\nwritel(siic->clk_div, siic->base + SIRFSOC_I2C_CLK_CTRL);\r\nwritel(siic->sda_delay, siic->base + SIRFSOC_I2C_SDA_DELAY);\r\nclk_disable(siic->clk);\r\nreturn 0;\r\n}

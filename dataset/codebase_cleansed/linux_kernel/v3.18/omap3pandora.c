static int omap3pandora_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nint ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, 0, 26000000,\r\nSND_SOC_CLOCK_IN);\r\nif (ret < 0) {\r\npr_err(PREFIX "can't set codec system clock\n");\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_sysclk(cpu_dai, OMAP_MCBSP_SYSCLK_CLKS_EXT,\r\n256 * params_rate(params),\r\nSND_SOC_CLOCK_IN);\r\nif (ret < 0) {\r\npr_err(PREFIX "can't set cpu system clock\n");\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_clkdiv(cpu_dai, OMAP_MCBSP_CLKGDV, 8);\r\nif (ret < 0) {\r\npr_err(PREFIX "can't set SRG clock divider\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int omap3pandora_dac_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *k, int event)\r\n{\r\nint ret;\r\nif (SND_SOC_DAPM_EVENT_ON(event)) {\r\nret = regulator_enable(omap3pandora_dac_reg);\r\nif (ret) {\r\ndev_err(w->dapm->dev, "Failed to power DAC: %d\n", ret);\r\nreturn ret;\r\n}\r\nmdelay(1);\r\ngpio_set_value(OMAP3_PANDORA_DAC_POWER_GPIO, 1);\r\n} else {\r\ngpio_set_value(OMAP3_PANDORA_DAC_POWER_GPIO, 0);\r\nmdelay(1);\r\nregulator_disable(omap3pandora_dac_reg);\r\n}\r\nreturn 0;\r\n}\r\nstatic int omap3pandora_hp_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *k, int event)\r\n{\r\nif (SND_SOC_DAPM_EVENT_ON(event))\r\ngpio_set_value(OMAP3_PANDORA_AMP_POWER_GPIO, 1);\r\nelse\r\ngpio_set_value(OMAP3_PANDORA_AMP_POWER_GPIO, 0);\r\nreturn 0;\r\n}\r\nstatic int omap3pandora_out_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nsnd_soc_dapm_nc_pin(dapm, "EARPIECE");\r\nsnd_soc_dapm_nc_pin(dapm, "PREDRIVEL");\r\nsnd_soc_dapm_nc_pin(dapm, "PREDRIVER");\r\nsnd_soc_dapm_nc_pin(dapm, "HSOL");\r\nsnd_soc_dapm_nc_pin(dapm, "HSOR");\r\nsnd_soc_dapm_nc_pin(dapm, "CARKITL");\r\nsnd_soc_dapm_nc_pin(dapm, "CARKITR");\r\nsnd_soc_dapm_nc_pin(dapm, "HFL");\r\nsnd_soc_dapm_nc_pin(dapm, "HFR");\r\nsnd_soc_dapm_nc_pin(dapm, "VIBRA");\r\nreturn 0;\r\n}\r\nstatic int omap3pandora_in_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nsnd_soc_dapm_nc_pin(dapm, "HSMIC");\r\nsnd_soc_dapm_nc_pin(dapm, "CARKITMIC");\r\nsnd_soc_dapm_nc_pin(dapm, "DIGIMIC0");\r\nsnd_soc_dapm_nc_pin(dapm, "DIGIMIC1");\r\nreturn 0;\r\n}\r\nstatic int __init omap3pandora_soc_init(void)\r\n{\r\nint ret;\r\nif (!machine_is_omap3_pandora())\r\nreturn -ENODEV;\r\npr_info("OMAP3 Pandora SoC init\n");\r\nret = gpio_request(OMAP3_PANDORA_DAC_POWER_GPIO, "dac_power");\r\nif (ret) {\r\npr_err(PREFIX "Failed to get DAC power GPIO\n");\r\nreturn ret;\r\n}\r\nret = gpio_direction_output(OMAP3_PANDORA_DAC_POWER_GPIO, 0);\r\nif (ret) {\r\npr_err(PREFIX "Failed to set DAC power GPIO direction\n");\r\ngoto fail0;\r\n}\r\nret = gpio_request(OMAP3_PANDORA_AMP_POWER_GPIO, "amp_power");\r\nif (ret) {\r\npr_err(PREFIX "Failed to get amp power GPIO\n");\r\ngoto fail0;\r\n}\r\nret = gpio_direction_output(OMAP3_PANDORA_AMP_POWER_GPIO, 0);\r\nif (ret) {\r\npr_err(PREFIX "Failed to set amp power GPIO direction\n");\r\ngoto fail1;\r\n}\r\nomap3pandora_snd_device = platform_device_alloc("soc-audio", -1);\r\nif (omap3pandora_snd_device == NULL) {\r\npr_err(PREFIX "Platform device allocation failed\n");\r\nret = -ENOMEM;\r\ngoto fail1;\r\n}\r\nplatform_set_drvdata(omap3pandora_snd_device, &snd_soc_card_omap3pandora);\r\nret = platform_device_add(omap3pandora_snd_device);\r\nif (ret) {\r\npr_err(PREFIX "Unable to add platform device\n");\r\ngoto fail2;\r\n}\r\nomap3pandora_dac_reg = regulator_get(&omap3pandora_snd_device->dev, "vcc");\r\nif (IS_ERR(omap3pandora_dac_reg)) {\r\npr_err(PREFIX "Failed to get DAC regulator from %s: %ld\n",\r\ndev_name(&omap3pandora_snd_device->dev),\r\nPTR_ERR(omap3pandora_dac_reg));\r\nret = PTR_ERR(omap3pandora_dac_reg);\r\ngoto fail3;\r\n}\r\nreturn 0;\r\nfail3:\r\nplatform_device_del(omap3pandora_snd_device);\r\nfail2:\r\nplatform_device_put(omap3pandora_snd_device);\r\nfail1:\r\ngpio_free(OMAP3_PANDORA_AMP_POWER_GPIO);\r\nfail0:\r\ngpio_free(OMAP3_PANDORA_DAC_POWER_GPIO);\r\nreturn ret;\r\n}\r\nstatic void __exit omap3pandora_soc_exit(void)\r\n{\r\nregulator_put(omap3pandora_dac_reg);\r\nplatform_device_unregister(omap3pandora_snd_device);\r\ngpio_free(OMAP3_PANDORA_AMP_POWER_GPIO);\r\ngpio_free(OMAP3_PANDORA_DAC_POWER_GPIO);\r\n}

static int rsi_usb_card_write(struct rsi_hw *adapter,\r\nvoid *buf,\r\nu16 len,\r\nu8 endpoint)\r\n{\r\nstruct rsi_91x_usbdev *dev = (struct rsi_91x_usbdev *)adapter->rsi_dev;\r\nint status;\r\ns32 transfer;\r\nstatus = usb_bulk_msg(dev->usbdev,\r\nusb_sndbulkpipe(dev->usbdev,\r\ndev->bulkout_endpoint_addr[endpoint - 1]),\r\nbuf,\r\nlen,\r\n&transfer,\r\nHZ * 5);\r\nif (status < 0) {\r\nrsi_dbg(ERR_ZONE,\r\n"Card write failed with error code :%10d\n", status);\r\ndev->write_fail = 1;\r\n}\r\nreturn status;\r\n}\r\nstatic int rsi_write_multiple(struct rsi_hw *adapter,\r\nu8 endpoint,\r\nu8 *data,\r\nu32 count)\r\n{\r\nstruct rsi_91x_usbdev *dev = (struct rsi_91x_usbdev *)adapter->rsi_dev;\r\nu8 *seg = dev->tx_buffer;\r\nif (dev->write_fail)\r\nreturn 0;\r\nif (endpoint == MGMT_EP) {\r\nmemset(seg, 0, RSI_USB_TX_HEAD_ROOM);\r\nmemcpy(seg + RSI_USB_TX_HEAD_ROOM, data, count);\r\n} else {\r\nseg = ((u8 *)data - RSI_USB_TX_HEAD_ROOM);\r\n}\r\nreturn rsi_usb_card_write(adapter,\r\nseg,\r\ncount + RSI_USB_TX_HEAD_ROOM,\r\nendpoint);\r\n}\r\nstatic int rsi_find_bulk_in_and_out_endpoints(struct usb_interface *interface,\r\nstruct rsi_hw *adapter)\r\n{\r\nstruct rsi_91x_usbdev *dev = (struct rsi_91x_usbdev *)adapter->rsi_dev;\r\nstruct usb_host_interface *iface_desc;\r\nstruct usb_endpoint_descriptor *endpoint;\r\n__le16 buffer_size;\r\nint ii, bep_found = 0;\r\niface_desc = &(interface->altsetting[0]);\r\nfor (ii = 0; ii < iface_desc->desc.bNumEndpoints; ++ii) {\r\nendpoint = &(iface_desc->endpoint[ii].desc);\r\nif ((!(dev->bulkin_endpoint_addr)) &&\r\n(endpoint->bEndpointAddress & USB_DIR_IN) &&\r\n((endpoint->bmAttributes &\r\nUSB_ENDPOINT_XFERTYPE_MASK) ==\r\nUSB_ENDPOINT_XFER_BULK)) {\r\nbuffer_size = endpoint->wMaxPacketSize;\r\ndev->bulkin_size = buffer_size;\r\ndev->bulkin_endpoint_addr =\r\nendpoint->bEndpointAddress;\r\n}\r\nif (!dev->bulkout_endpoint_addr[bep_found] &&\r\n!(endpoint->bEndpointAddress & USB_DIR_IN) &&\r\n((endpoint->bmAttributes & USB_ENDPOINT_XFERTYPE_MASK) ==\r\nUSB_ENDPOINT_XFER_BULK)) {\r\ndev->bulkout_endpoint_addr[bep_found] =\r\nendpoint->bEndpointAddress;\r\nbuffer_size = endpoint->wMaxPacketSize;\r\ndev->bulkout_size[bep_found] = buffer_size;\r\nbep_found++;\r\n}\r\nif (bep_found >= MAX_BULK_EP)\r\nbreak;\r\n}\r\nif (!(dev->bulkin_endpoint_addr) &&\r\n(dev->bulkout_endpoint_addr[0]))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int rsi_usb_reg_read(struct usb_device *usbdev,\r\nu32 reg,\r\nu16 *value,\r\nu16 len)\r\n{\r\nu8 *buf;\r\nint status = -ENOMEM;\r\nbuf = kmalloc(0x04, GFP_KERNEL);\r\nif (!buf)\r\nreturn status;\r\nstatus = usb_control_msg(usbdev,\r\nusb_rcvctrlpipe(usbdev, 0),\r\nUSB_VENDOR_REGISTER_READ,\r\nUSB_TYPE_VENDOR,\r\n((reg & 0xffff0000) >> 16), (reg & 0xffff),\r\n(void *)buf,\r\nlen,\r\nHZ * 5);\r\n*value = (buf[0] | (buf[1] << 8));\r\nif (status < 0) {\r\nrsi_dbg(ERR_ZONE,\r\n"%s: Reg read failed with error code :%d\n",\r\n__func__, status);\r\n}\r\nkfree(buf);\r\nreturn status;\r\n}\r\nstatic int rsi_usb_reg_write(struct usb_device *usbdev,\r\nu32 reg,\r\nu16 value,\r\nu16 len)\r\n{\r\nu8 *usb_reg_buf;\r\nint status = -ENOMEM;\r\nusb_reg_buf = kmalloc(0x04, GFP_KERNEL);\r\nif (!usb_reg_buf)\r\nreturn status;\r\nusb_reg_buf[0] = (value & 0x00ff);\r\nusb_reg_buf[1] = (value & 0xff00) >> 8;\r\nusb_reg_buf[2] = 0x0;\r\nusb_reg_buf[3] = 0x0;\r\nstatus = usb_control_msg(usbdev,\r\nusb_sndctrlpipe(usbdev, 0),\r\nUSB_VENDOR_REGISTER_WRITE,\r\nUSB_TYPE_VENDOR,\r\n((reg & 0xffff0000) >> 16),\r\n(reg & 0xffff),\r\n(void *)usb_reg_buf,\r\nlen,\r\nHZ * 5);\r\nif (status < 0) {\r\nrsi_dbg(ERR_ZONE,\r\n"%s: Reg write failed with error code :%d\n",\r\n__func__, status);\r\n}\r\nkfree(usb_reg_buf);\r\nreturn status;\r\n}\r\nstatic void rsi_rx_done_handler(struct urb *urb)\r\n{\r\nstruct rsi_hw *adapter = urb->context;\r\nstruct rsi_91x_usbdev *dev = (struct rsi_91x_usbdev *)adapter->rsi_dev;\r\nif (urb->status)\r\nreturn;\r\nrsi_set_event(&dev->rx_thread.event);\r\n}\r\nstatic int rsi_rx_urb_submit(struct rsi_hw *adapter)\r\n{\r\nstruct rsi_91x_usbdev *dev = (struct rsi_91x_usbdev *)adapter->rsi_dev;\r\nstruct urb *urb = dev->rx_usb_urb[0];\r\nint status;\r\nusb_fill_bulk_urb(urb,\r\ndev->usbdev,\r\nusb_rcvbulkpipe(dev->usbdev,\r\ndev->bulkin_endpoint_addr),\r\nurb->transfer_buffer,\r\n3000,\r\nrsi_rx_done_handler,\r\nadapter);\r\nstatus = usb_submit_urb(urb, GFP_KERNEL);\r\nif (status)\r\nrsi_dbg(ERR_ZONE, "%s: Failed in urb submission\n", __func__);\r\nreturn status;\r\n}\r\nint rsi_usb_write_register_multiple(struct rsi_hw *adapter,\r\nu32 addr,\r\nu8 *data,\r\nu32 count)\r\n{\r\nstruct rsi_91x_usbdev *dev = (struct rsi_91x_usbdev *)adapter->rsi_dev;\r\nu8 *buf;\r\nu8 transfer;\r\nint status = 0;\r\nbuf = kzalloc(4096, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nwhile (count) {\r\ntransfer = (u8)(min_t(u32, count, 4096));\r\nmemcpy(buf, data, transfer);\r\nstatus = usb_control_msg(dev->usbdev,\r\nusb_sndctrlpipe(dev->usbdev, 0),\r\nUSB_VENDOR_REGISTER_WRITE,\r\nUSB_TYPE_VENDOR,\r\n((addr & 0xffff0000) >> 16),\r\n(addr & 0xffff),\r\n(void *)buf,\r\ntransfer,\r\nHZ * 5);\r\nif (status < 0) {\r\nrsi_dbg(ERR_ZONE,\r\n"Reg write failed with error code :%d\n",\r\nstatus);\r\n} else {\r\ncount -= transfer;\r\ndata += transfer;\r\naddr += transfer;\r\n}\r\n}\r\nkfree(buf);\r\nreturn 0;\r\n}\r\nstatic int rsi_usb_host_intf_write_pkt(struct rsi_hw *adapter,\r\nu8 *pkt,\r\nu32 len)\r\n{\r\nu32 queueno = ((pkt[1] >> 4) & 0xf);\r\nu8 endpoint;\r\nendpoint = ((queueno == RSI_WIFI_MGMT_Q) ? MGMT_EP : DATA_EP);\r\nreturn rsi_write_multiple(adapter,\r\nendpoint,\r\n(u8 *)pkt,\r\nlen);\r\n}\r\nstatic void rsi_deinit_usb_interface(struct rsi_hw *adapter)\r\n{\r\nstruct rsi_91x_usbdev *dev = (struct rsi_91x_usbdev *)adapter->rsi_dev;\r\nrsi_kill_thread(&dev->rx_thread);\r\nusb_free_urb(dev->rx_usb_urb[0]);\r\nkfree(adapter->priv->rx_data_pkt);\r\nkfree(dev->tx_buffer);\r\n}\r\nstatic int rsi_init_usb_interface(struct rsi_hw *adapter,\r\nstruct usb_interface *pfunction)\r\n{\r\nstruct rsi_91x_usbdev *rsi_dev;\r\nstruct rsi_common *common = adapter->priv;\r\nint status;\r\nrsi_dev = kzalloc(sizeof(*rsi_dev), GFP_KERNEL);\r\nif (!rsi_dev)\r\nreturn -ENOMEM;\r\nadapter->rsi_dev = rsi_dev;\r\nrsi_dev->usbdev = interface_to_usbdev(pfunction);\r\nif (rsi_find_bulk_in_and_out_endpoints(pfunction, adapter))\r\nreturn -EINVAL;\r\nadapter->device = &pfunction->dev;\r\nusb_set_intfdata(pfunction, adapter);\r\ncommon->rx_data_pkt = kmalloc(2048, GFP_KERNEL);\r\nif (!common->rx_data_pkt) {\r\nrsi_dbg(ERR_ZONE, "%s: Failed to allocate memory\n",\r\n__func__);\r\nreturn -ENOMEM;\r\n}\r\nrsi_dev->tx_buffer = kmalloc(2048, GFP_KERNEL);\r\nif (!rsi_dev->tx_buffer) {\r\nstatus = -ENOMEM;\r\ngoto fail_tx;\r\n}\r\nrsi_dev->rx_usb_urb[0] = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!rsi_dev->rx_usb_urb[0]) {\r\nstatus = -ENOMEM;\r\ngoto fail_rx;\r\n}\r\nrsi_dev->rx_usb_urb[0]->transfer_buffer = adapter->priv->rx_data_pkt;\r\nrsi_dev->tx_blk_size = 252;\r\nadapter->rx_urb_submit = rsi_rx_urb_submit;\r\nadapter->host_intf_write_pkt = rsi_usb_host_intf_write_pkt;\r\nadapter->check_hw_queue_status = rsi_usb_check_queue_status;\r\nadapter->determine_event_timeout = rsi_usb_event_timeout;\r\nrsi_init_event(&rsi_dev->rx_thread.event);\r\nstatus = rsi_create_kthread(common, &rsi_dev->rx_thread,\r\nrsi_usb_rx_thread, "RX-Thread");\r\nif (status) {\r\nrsi_dbg(ERR_ZONE, "%s: Unable to init rx thrd\n", __func__);\r\ngoto fail_thread;\r\n}\r\n#ifdef CONFIG_RSI_DEBUGFS\r\nadapter->num_debugfs_entries = (MAX_DEBUGFS_ENTRIES - 1);\r\n#endif\r\nrsi_dbg(INIT_ZONE, "%s: Enabled the interface\n", __func__);\r\nreturn 0;\r\nfail_thread:\r\nusb_free_urb(rsi_dev->rx_usb_urb[0]);\r\nfail_rx:\r\nkfree(rsi_dev->tx_buffer);\r\nfail_tx:\r\nkfree(common->rx_data_pkt);\r\nreturn status;\r\n}\r\nstatic int rsi_probe(struct usb_interface *pfunction,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct rsi_hw *adapter;\r\nstruct rsi_91x_usbdev *dev;\r\nu16 fw_status;\r\nint status;\r\nrsi_dbg(INIT_ZONE, "%s: Init function called\n", __func__);\r\nadapter = rsi_91x_init();\r\nif (!adapter) {\r\nrsi_dbg(ERR_ZONE, "%s: Failed to init os intf ops\n",\r\n__func__);\r\nreturn -ENOMEM;\r\n}\r\nstatus = rsi_init_usb_interface(adapter, pfunction);\r\nif (status) {\r\nrsi_dbg(ERR_ZONE, "%s: Failed to init usb interface\n",\r\n__func__);\r\ngoto err;\r\n}\r\nrsi_dbg(ERR_ZONE, "%s: Initialized os intf ops\n", __func__);\r\ndev = (struct rsi_91x_usbdev *)adapter->rsi_dev;\r\nstatus = rsi_usb_reg_read(dev->usbdev, FW_STATUS_REG, &fw_status, 2);\r\nif (status)\r\ngoto err1;\r\nelse\r\nfw_status &= 1;\r\nif (!fw_status) {\r\nstatus = rsi_usb_device_init(adapter->priv);\r\nif (status) {\r\nrsi_dbg(ERR_ZONE, "%s: Failed in device init\n",\r\n__func__);\r\ngoto err1;\r\n}\r\nstatus = rsi_usb_reg_write(dev->usbdev,\r\nUSB_INTERNAL_REG_1,\r\nRSI_USB_READY_MAGIC_NUM, 1);\r\nif (status)\r\ngoto err1;\r\nrsi_dbg(INIT_ZONE, "%s: Performed device init\n", __func__);\r\n}\r\nstatus = rsi_rx_urb_submit(adapter);\r\nif (status)\r\ngoto err1;\r\nreturn 0;\r\nerr1:\r\nrsi_deinit_usb_interface(adapter);\r\nerr:\r\nrsi_91x_deinit(adapter);\r\nrsi_dbg(ERR_ZONE, "%s: Failed in probe...Exiting\n", __func__);\r\nreturn status;\r\n}\r\nstatic void rsi_disconnect(struct usb_interface *pfunction)\r\n{\r\nstruct rsi_hw *adapter = usb_get_intfdata(pfunction);\r\nif (!adapter)\r\nreturn;\r\nrsi_mac80211_detach(adapter);\r\nrsi_deinit_usb_interface(adapter);\r\nrsi_91x_deinit(adapter);\r\nrsi_dbg(INFO_ZONE, "%s: Deinitialization completed\n", __func__);\r\n}\r\nstatic int rsi_suspend(struct usb_interface *intf, pm_message_t message)\r\n{\r\nreturn -ENOSYS;\r\n}\r\nstatic int rsi_resume(struct usb_interface *intf)\r\n{\r\nreturn -ENOSYS;\r\n}

static inline u32 sigma_action_len(struct sigma_action *sa)\r\n{\r\nreturn (sa->len_hi << 16) | le16_to_cpu(sa->len);\r\n}\r\nstatic size_t sigma_action_size(struct sigma_action *sa)\r\n{\r\nsize_t payload = 0;\r\nswitch (sa->instr) {\r\ncase SIGMA_ACTION_WRITEXBYTES:\r\ncase SIGMA_ACTION_WRITESINGLE:\r\ncase SIGMA_ACTION_WRITESAFELOAD:\r\npayload = sigma_action_len(sa);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\npayload = ALIGN(payload, 2);\r\nreturn payload + sizeof(struct sigma_action);\r\n}\r\nstatic int\r\nprocess_sigma_action(struct sigma_firmware *ssfw, struct sigma_action *sa)\r\n{\r\nsize_t len = sigma_action_len(sa);\r\nint ret;\r\npr_debug("%s: instr:%i addr:%#x len:%zu\n", __func__,\r\nsa->instr, sa->addr, len);\r\nswitch (sa->instr) {\r\ncase SIGMA_ACTION_WRITEXBYTES:\r\ncase SIGMA_ACTION_WRITESINGLE:\r\ncase SIGMA_ACTION_WRITESAFELOAD:\r\nret = ssfw->write(ssfw->control_data, sa, len);\r\nif (ret < 0)\r\nreturn -EINVAL;\r\nbreak;\r\ncase SIGMA_ACTION_DELAY:\r\nudelay(len);\r\nlen = 0;\r\nbreak;\r\ncase SIGMA_ACTION_END:\r\nreturn 0;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nprocess_sigma_actions(struct sigma_firmware *ssfw)\r\n{\r\nstruct sigma_action *sa;\r\nsize_t size;\r\nint ret;\r\nwhile (ssfw->pos + sizeof(*sa) <= ssfw->fw->size) {\r\nsa = (struct sigma_action *)(ssfw->fw->data + ssfw->pos);\r\nsize = sigma_action_size(sa);\r\nssfw->pos += size;\r\nif (ssfw->pos > ssfw->fw->size || size == 0)\r\nbreak;\r\nret = process_sigma_action(ssfw, sa);\r\npr_debug("%s: action returned %i\n", __func__, ret);\r\nif (ret <= 0)\r\nreturn ret;\r\n}\r\nif (ssfw->pos != ssfw->fw->size)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nint _process_sigma_firmware(struct device *dev,\r\nstruct sigma_firmware *ssfw, const char *name)\r\n{\r\nint ret;\r\nstruct sigma_firmware_header *ssfw_head;\r\nconst struct firmware *fw;\r\nu32 crc;\r\npr_debug("%s: loading firmware %s\n", __func__, name);\r\nret = request_firmware(&fw, name, dev);\r\nif (ret) {\r\npr_debug("%s: request_firmware() failed with %i\n", __func__, ret);\r\nreturn ret;\r\n}\r\nssfw->fw = fw;\r\nret = -EINVAL;\r\nif (fw->size < sizeof(*ssfw_head) || fw->size >= 0x4000000) {\r\ndev_err(dev, "Failed to load firmware: Invalid size\n");\r\ngoto done;\r\n}\r\nssfw_head = (void *)fw->data;\r\nif (memcmp(ssfw_head->magic, SIGMA_MAGIC, ARRAY_SIZE(ssfw_head->magic))) {\r\ndev_err(dev, "Failed to load firmware: Invalid magic\n");\r\ngoto done;\r\n}\r\ncrc = crc32(0, fw->data + sizeof(*ssfw_head),\r\nfw->size - sizeof(*ssfw_head));\r\npr_debug("%s: crc=%x\n", __func__, crc);\r\nif (crc != le32_to_cpu(ssfw_head->crc)) {\r\ndev_err(dev, "Failed to load firmware: Wrong crc checksum: expected %x got %x\n",\r\nle32_to_cpu(ssfw_head->crc), crc);\r\ngoto done;\r\n}\r\nssfw->pos = sizeof(*ssfw_head);\r\nret = process_sigma_actions(ssfw);\r\ndone:\r\nrelease_firmware(fw);\r\npr_debug("%s: loaded %s\n", __func__, name);\r\nreturn ret;\r\n}

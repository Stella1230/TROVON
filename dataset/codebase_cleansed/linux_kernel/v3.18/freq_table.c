int cpufreq_frequency_table_cpuinfo(struct cpufreq_policy *policy,\r\nstruct cpufreq_frequency_table *table)\r\n{\r\nstruct cpufreq_frequency_table *pos;\r\nunsigned int min_freq = ~0;\r\nunsigned int max_freq = 0;\r\nunsigned int freq;\r\ncpufreq_for_each_valid_entry(pos, table) {\r\nfreq = pos->frequency;\r\nif (!cpufreq_boost_enabled()\r\n&& (pos->flags & CPUFREQ_BOOST_FREQ))\r\ncontinue;\r\npr_debug("table entry %u: %u kHz\n", (int)(pos - table), freq);\r\nif (freq < min_freq)\r\nmin_freq = freq;\r\nif (freq > max_freq)\r\nmax_freq = freq;\r\n}\r\npolicy->min = policy->cpuinfo.min_freq = min_freq;\r\npolicy->max = policy->cpuinfo.max_freq = max_freq;\r\nif (policy->min == ~0)\r\nreturn -EINVAL;\r\nelse\r\nreturn 0;\r\n}\r\nint cpufreq_frequency_table_verify(struct cpufreq_policy *policy,\r\nstruct cpufreq_frequency_table *table)\r\n{\r\nstruct cpufreq_frequency_table *pos;\r\nunsigned int freq, next_larger = ~0;\r\nbool found = false;\r\npr_debug("request for verification of policy (%u - %u kHz) for cpu %u\n",\r\npolicy->min, policy->max, policy->cpu);\r\ncpufreq_verify_within_cpu_limits(policy);\r\ncpufreq_for_each_valid_entry(pos, table) {\r\nfreq = pos->frequency;\r\nif ((freq >= policy->min) && (freq <= policy->max)) {\r\nfound = true;\r\nbreak;\r\n}\r\nif ((next_larger > freq) && (freq > policy->max))\r\nnext_larger = freq;\r\n}\r\nif (!found) {\r\npolicy->max = next_larger;\r\ncpufreq_verify_within_cpu_limits(policy);\r\n}\r\npr_debug("verification lead to (%u - %u kHz) for cpu %u\n",\r\npolicy->min, policy->max, policy->cpu);\r\nreturn 0;\r\n}\r\nint cpufreq_generic_frequency_table_verify(struct cpufreq_policy *policy)\r\n{\r\nstruct cpufreq_frequency_table *table =\r\ncpufreq_frequency_get_table(policy->cpu);\r\nif (!table)\r\nreturn -ENODEV;\r\nreturn cpufreq_frequency_table_verify(policy, table);\r\n}\r\nint cpufreq_frequency_table_target(struct cpufreq_policy *policy,\r\nstruct cpufreq_frequency_table *table,\r\nunsigned int target_freq,\r\nunsigned int relation,\r\nunsigned int *index)\r\n{\r\nstruct cpufreq_frequency_table optimal = {\r\n.driver_data = ~0,\r\n.frequency = 0,\r\n};\r\nstruct cpufreq_frequency_table suboptimal = {\r\n.driver_data = ~0,\r\n.frequency = 0,\r\n};\r\nstruct cpufreq_frequency_table *pos;\r\nunsigned int freq, diff, i = 0;\r\npr_debug("request for target %u kHz (relation: %u) for cpu %u\n",\r\ntarget_freq, relation, policy->cpu);\r\nswitch (relation) {\r\ncase CPUFREQ_RELATION_H:\r\nsuboptimal.frequency = ~0;\r\nbreak;\r\ncase CPUFREQ_RELATION_L:\r\ncase CPUFREQ_RELATION_C:\r\noptimal.frequency = ~0;\r\nbreak;\r\n}\r\ncpufreq_for_each_valid_entry(pos, table) {\r\nfreq = pos->frequency;\r\ni = pos - table;\r\nif ((freq < policy->min) || (freq > policy->max))\r\ncontinue;\r\nif (freq == target_freq) {\r\noptimal.driver_data = i;\r\nbreak;\r\n}\r\nswitch (relation) {\r\ncase CPUFREQ_RELATION_H:\r\nif (freq < target_freq) {\r\nif (freq >= optimal.frequency) {\r\noptimal.frequency = freq;\r\noptimal.driver_data = i;\r\n}\r\n} else {\r\nif (freq <= suboptimal.frequency) {\r\nsuboptimal.frequency = freq;\r\nsuboptimal.driver_data = i;\r\n}\r\n}\r\nbreak;\r\ncase CPUFREQ_RELATION_L:\r\nif (freq > target_freq) {\r\nif (freq <= optimal.frequency) {\r\noptimal.frequency = freq;\r\noptimal.driver_data = i;\r\n}\r\n} else {\r\nif (freq >= suboptimal.frequency) {\r\nsuboptimal.frequency = freq;\r\nsuboptimal.driver_data = i;\r\n}\r\n}\r\nbreak;\r\ncase CPUFREQ_RELATION_C:\r\ndiff = abs(freq - target_freq);\r\nif (diff < optimal.frequency ||\r\n(diff == optimal.frequency &&\r\nfreq > table[optimal.driver_data].frequency)) {\r\noptimal.frequency = diff;\r\noptimal.driver_data = i;\r\n}\r\nbreak;\r\n}\r\n}\r\nif (optimal.driver_data > i) {\r\nif (suboptimal.driver_data > i)\r\nreturn -EINVAL;\r\n*index = suboptimal.driver_data;\r\n} else\r\n*index = optimal.driver_data;\r\npr_debug("target index is %u, freq is:%u kHz\n", *index,\r\ntable[*index].frequency);\r\nreturn 0;\r\n}\r\nint cpufreq_frequency_table_get_index(struct cpufreq_policy *policy,\r\nunsigned int freq)\r\n{\r\nstruct cpufreq_frequency_table *pos, *table;\r\ntable = cpufreq_frequency_get_table(policy->cpu);\r\nif (unlikely(!table)) {\r\npr_debug("%s: Unable to find frequency table\n", __func__);\r\nreturn -ENOENT;\r\n}\r\ncpufreq_for_each_valid_entry(pos, table)\r\nif (pos->frequency == freq)\r\nreturn pos - table;\r\nreturn -EINVAL;\r\n}\r\nstatic ssize_t show_available_freqs(struct cpufreq_policy *policy, char *buf,\r\nbool show_boost)\r\n{\r\nssize_t count = 0;\r\nstruct cpufreq_frequency_table *pos, *table = policy->freq_table;\r\nif (!table)\r\nreturn -ENODEV;\r\ncpufreq_for_each_valid_entry(pos, table) {\r\nif (show_boost ^ (pos->flags & CPUFREQ_BOOST_FREQ))\r\ncontinue;\r\ncount += sprintf(&buf[count], "%d ", pos->frequency);\r\n}\r\ncount += sprintf(&buf[count], "\n");\r\nreturn count;\r\n}\r\nstatic ssize_t scaling_available_frequencies_show(struct cpufreq_policy *policy,\r\nchar *buf)\r\n{\r\nreturn show_available_freqs(policy, buf, false);\r\n}\r\nstatic ssize_t scaling_boost_frequencies_show(struct cpufreq_policy *policy,\r\nchar *buf)\r\n{\r\nreturn show_available_freqs(policy, buf, true);\r\n}\r\nint cpufreq_table_validate_and_show(struct cpufreq_policy *policy,\r\nstruct cpufreq_frequency_table *table)\r\n{\r\nint ret = cpufreq_frequency_table_cpuinfo(policy, table);\r\nif (!ret)\r\npolicy->freq_table = table;\r\nreturn ret;\r\n}\r\nstruct cpufreq_frequency_table *cpufreq_frequency_get_table(unsigned int cpu)\r\n{\r\nstruct cpufreq_policy *policy = cpufreq_cpu_get_raw(cpu);\r\nreturn policy ? policy->freq_table : NULL;\r\n}

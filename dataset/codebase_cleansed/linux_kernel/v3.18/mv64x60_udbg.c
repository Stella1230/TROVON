static void mv64x60_udbg_putc(char c)\r\n{\r\nif (c == '\n')\r\nmv64x60_udbg_putc('\r');\r\nwhile(in_le32(mpsc_base + MPSC_0_CR2_OFFSET) & MPSC_CHR_2_TCS)\r\n;\r\nout_le32(mpsc_base + MPSC_0_CR1_OFFSET, c);\r\nout_le32(mpsc_base + MPSC_0_CR2_OFFSET, MPSC_CHR_2_TCS);\r\n}\r\nstatic int mv64x60_udbg_testc(void)\r\n{\r\nreturn (in_le32(mpsc_intr_cause) & MPSC_INTR_CAUSE_RCC) != 0;\r\n}\r\nstatic int mv64x60_udbg_getc(void)\r\n{\r\nint cause = 0;\r\nint c;\r\nwhile (!mv64x60_udbg_testc())\r\n;\r\nc = in_8(mpsc_base + MPSC_0_CHR_10_OFFSET + 2);\r\nout_8(mpsc_base + MPSC_0_CHR_10_OFFSET + 2, c);\r\nout_le32(mpsc_intr_cause, cause & ~MPSC_INTR_CAUSE_RCC);\r\nreturn c;\r\n}\r\nstatic int mv64x60_udbg_getc_poll(void)\r\n{\r\nif (!mv64x60_udbg_testc())\r\nreturn -1;\r\nreturn mv64x60_udbg_getc();\r\n}\r\nstatic void mv64x60_udbg_init(void)\r\n{\r\nstruct device_node *np, *mpscintr, *stdout = NULL;\r\nconst char *path;\r\nconst phandle *ph;\r\nstruct resource r[2];\r\nconst int *block_index;\r\nint intr_cause_offset;\r\nint err;\r\npath = of_get_property(of_chosen, "linux,stdout-path", NULL);\r\nif (!path)\r\nreturn;\r\nstdout = of_find_node_by_path(path);\r\nif (!stdout)\r\nreturn;\r\nfor_each_compatible_node(np, NULL, "marvell,mv64360-mpsc") {\r\nif (np == stdout)\r\nbreak;\r\n}\r\nof_node_put(stdout);\r\nif (!np)\r\nreturn;\r\nblock_index = of_get_property(np, "cell-index", NULL);\r\nif (!block_index)\r\ngoto error;\r\nswitch (*block_index) {\r\ncase 0:\r\nintr_cause_offset = MPSC_INTR_CAUSE_OFF_0;\r\nbreak;\r\ncase 1:\r\nintr_cause_offset = MPSC_INTR_CAUSE_OFF_1;\r\nbreak;\r\ndefault:\r\ngoto error;\r\n}\r\nerr = of_address_to_resource(np, 0, &r[0]);\r\nif (err)\r\ngoto error;\r\nph = of_get_property(np, "mpscintr", NULL);\r\nmpscintr = of_find_node_by_phandle(*ph);\r\nif (!mpscintr)\r\ngoto error;\r\nerr = of_address_to_resource(mpscintr, 0, &r[1]);\r\nof_node_put(mpscintr);\r\nif (err)\r\ngoto error;\r\nof_node_put(np);\r\nmpsc_base = ioremap(r[0].start, resource_size(&r[0]));\r\nif (!mpsc_base)\r\nreturn;\r\nmpsc_intr_cause = ioremap(r[1].start, resource_size(&r[1]));\r\nif (!mpsc_intr_cause) {\r\niounmap(mpsc_base);\r\nreturn;\r\n}\r\nmpsc_intr_cause += intr_cause_offset;\r\nudbg_putc = mv64x60_udbg_putc;\r\nudbg_getc = mv64x60_udbg_getc;\r\nudbg_getc_poll = mv64x60_udbg_getc_poll;\r\nreturn;\r\nerror:\r\nof_node_put(np);\r\n}\r\nvoid mv64x60_init_early(void)\r\n{\r\nmv64x60_udbg_init();\r\n}

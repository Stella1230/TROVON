static int bios_set_mode(struct mode_info *mi)\r\n{\r\nreturn set_bios_mode(mi->mode - VIDEO_FIRST_BIOS);\r\n}\r\nstatic int set_bios_mode(u8 mode)\r\n{\r\nstruct biosregs ireg, oreg;\r\nu8 new_mode;\r\ninitregs(&ireg);\r\nireg.al = mode;\r\nintcall(0x10, &ireg, NULL);\r\nireg.ah = 0x0f;\r\nintcall(0x10, &ireg, &oreg);\r\ndo_restore = 1;\r\nnew_mode = oreg.al & 0x7f;\r\nif (new_mode == mode)\r\nreturn 0;\r\n#ifndef _WAKEUP\r\nif (new_mode != boot_params.screen_info.orig_video_mode) {\r\nireg.ax = boot_params.screen_info.orig_video_mode;\r\nintcall(0x10, &ireg, NULL);\r\n}\r\n#endif\r\nreturn -1;\r\n}\r\nstatic int bios_probe(void)\r\n{\r\nu8 mode;\r\n#ifdef _WAKEUP\r\nu8 saved_mode = 0x03;\r\n#else\r\nu8 saved_mode = boot_params.screen_info.orig_video_mode;\r\n#endif\r\nu16 crtc;\r\nstruct mode_info *mi;\r\nint nmodes = 0;\r\nif (adapter != ADAPTER_EGA && adapter != ADAPTER_VGA)\r\nreturn 0;\r\nset_fs(0);\r\ncrtc = vga_crtc();\r\nvideo_bios.modes = GET_HEAP(struct mode_info, 0);\r\nfor (mode = 0x14; mode <= 0x7f; mode++) {\r\nif (!heap_free(sizeof(struct mode_info)))\r\nbreak;\r\nif (mode_defined(VIDEO_FIRST_BIOS+mode))\r\ncontinue;\r\nif (set_bios_mode(mode))\r\ncontinue;\r\nif (in_idx(0x3c0, 0x10) & 0x01)\r\ncontinue;\r\nif (in_idx(0x3ce, 0x06) & 0x01)\r\ncontinue;\r\nif (in_idx(crtc, 0x0f))\r\ncontinue;\r\nmi = GET_HEAP(struct mode_info, 1);\r\nmi->mode = VIDEO_FIRST_BIOS+mode;\r\nmi->depth = 0;\r\nmi->x = rdfs16(0x44a);\r\nmi->y = rdfs8(0x484)+1;\r\nnmodes++;\r\n}\r\nset_bios_mode(saved_mode);\r\nreturn nmodes;\r\n}

static inline int need_bs_quote(char c)\r\n{\r\nreturn (c == '\'' || c == '!');\r\n}\r\nstatic void sq_quote_buf(struct strbuf *dst, const char *src)\r\n{\r\nchar *to_free = NULL;\r\nif (dst->buf == src)\r\nto_free = strbuf_detach(dst, NULL);\r\nstrbuf_addch(dst, '\'');\r\nwhile (*src) {\r\nsize_t len = strcspn(src, "'!");\r\nstrbuf_add(dst, src, len);\r\nsrc += len;\r\nwhile (need_bs_quote(*src)) {\r\nstrbuf_addstr(dst, "'\\");\r\nstrbuf_addch(dst, *src++);\r\nstrbuf_addch(dst, '\'');\r\n}\r\n}\r\nstrbuf_addch(dst, '\'');\r\nfree(to_free);\r\n}\r\nvoid sq_quote_argv(struct strbuf *dst, const char** argv, size_t maxlen)\r\n{\r\nint i;\r\nstrbuf_grow(dst, 255);\r\nfor (i = 0; argv[i]; ++i) {\r\nstrbuf_addch(dst, ' ');\r\nsq_quote_buf(dst, argv[i]);\r\nif (maxlen && dst->len > maxlen)\r\ndie("Too many or long arguments");\r\n}\r\n}

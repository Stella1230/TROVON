static int nouveau_platform_power_up(struct nouveau_platform_gpu *gpu)\r\n{\r\nint err;\r\nerr = regulator_enable(gpu->vdd);\r\nif (err)\r\ngoto err_power;\r\nerr = clk_prepare_enable(gpu->clk);\r\nif (err)\r\ngoto err_clk;\r\nerr = clk_prepare_enable(gpu->clk_pwr);\r\nif (err)\r\ngoto err_clk_pwr;\r\nclk_set_rate(gpu->clk_pwr, 204000000);\r\nudelay(10);\r\nreset_control_assert(gpu->rst);\r\nudelay(10);\r\nerr = tegra_powergate_remove_clamping(TEGRA_POWERGATE_3D);\r\nif (err)\r\ngoto err_clamp;\r\nudelay(10);\r\nreset_control_deassert(gpu->rst);\r\nudelay(10);\r\nreturn 0;\r\nerr_clamp:\r\nclk_disable_unprepare(gpu->clk_pwr);\r\nerr_clk_pwr:\r\nclk_disable_unprepare(gpu->clk);\r\nerr_clk:\r\nregulator_disable(gpu->vdd);\r\nerr_power:\r\nreturn err;\r\n}\r\nstatic int nouveau_platform_power_down(struct nouveau_platform_gpu *gpu)\r\n{\r\nint err;\r\nreset_control_assert(gpu->rst);\r\nudelay(10);\r\nclk_disable_unprepare(gpu->clk_pwr);\r\nclk_disable_unprepare(gpu->clk);\r\nudelay(10);\r\nerr = regulator_disable(gpu->vdd);\r\nif (err)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int nouveau_platform_probe(struct platform_device *pdev)\r\n{\r\nstruct nouveau_platform_gpu *gpu;\r\nstruct nouveau_platform_device *device;\r\nstruct drm_device *drm;\r\nint err;\r\ngpu = devm_kzalloc(&pdev->dev, sizeof(*gpu), GFP_KERNEL);\r\nif (!gpu)\r\nreturn -ENOMEM;\r\ngpu->vdd = devm_regulator_get(&pdev->dev, "vdd");\r\nif (IS_ERR(gpu->vdd))\r\nreturn PTR_ERR(gpu->vdd);\r\ngpu->rst = devm_reset_control_get(&pdev->dev, "gpu");\r\nif (IS_ERR(gpu->rst))\r\nreturn PTR_ERR(gpu->rst);\r\ngpu->clk = devm_clk_get(&pdev->dev, "gpu");\r\nif (IS_ERR(gpu->clk))\r\nreturn PTR_ERR(gpu->clk);\r\ngpu->clk_pwr = devm_clk_get(&pdev->dev, "pwr");\r\nif (IS_ERR(gpu->clk_pwr))\r\nreturn PTR_ERR(gpu->clk_pwr);\r\nerr = nouveau_platform_power_up(gpu);\r\nif (err)\r\nreturn err;\r\ndrm = nouveau_platform_device_create(pdev, &device);\r\nif (IS_ERR(drm)) {\r\nerr = PTR_ERR(drm);\r\ngoto power_down;\r\n}\r\ndevice->gpu = gpu;\r\nerr = drm_dev_register(drm, 0);\r\nif (err < 0)\r\ngoto err_unref;\r\nreturn 0;\r\nerr_unref:\r\ndrm_dev_unref(drm);\r\nreturn 0;\r\npower_down:\r\nnouveau_platform_power_down(gpu);\r\nreturn err;\r\n}\r\nstatic int nouveau_platform_remove(struct platform_device *pdev)\r\n{\r\nstruct drm_device *drm_dev = platform_get_drvdata(pdev);\r\nstruct nouveau_drm *drm = nouveau_drm(drm_dev);\r\nstruct nouveau_device *device = nvkm_device(&drm->device);\r\nstruct nouveau_platform_gpu *gpu = nv_device_to_platform(device)->gpu;\r\nnouveau_drm_device_remove(drm_dev);\r\nreturn nouveau_platform_power_down(gpu);\r\n}

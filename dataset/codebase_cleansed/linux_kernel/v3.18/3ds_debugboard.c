static void mxc_expio_irq_handler(u32 irq, struct irq_desc *desc)\r\n{\r\nu32 imr_val;\r\nu32 int_valid;\r\nu32 expio_irq;\r\ndesc->irq_data.chip->irq_mask(&desc->irq_data);\r\nimr_val = __raw_readw(brd_io + INTR_MASK_REG);\r\nint_valid = __raw_readw(brd_io + INTR_STATUS_REG) & ~imr_val;\r\nexpio_irq = 0;\r\nfor (; int_valid != 0; int_valid >>= 1, expio_irq++) {\r\nif ((int_valid & 1) == 0)\r\ncontinue;\r\ngeneric_handle_irq(irq_find_mapping(domain, expio_irq));\r\n}\r\ndesc->irq_data.chip->irq_ack(&desc->irq_data);\r\ndesc->irq_data.chip->irq_unmask(&desc->irq_data);\r\n}\r\nstatic void expio_mask_irq(struct irq_data *d)\r\n{\r\nu16 reg;\r\nu32 expio = d->hwirq;\r\nreg = __raw_readw(brd_io + INTR_MASK_REG);\r\nreg |= (1 << expio);\r\n__raw_writew(reg, brd_io + INTR_MASK_REG);\r\n}\r\nstatic void expio_ack_irq(struct irq_data *d)\r\n{\r\nu32 expio = d->hwirq;\r\n__raw_writew(1 << expio, brd_io + INTR_RESET_REG);\r\n__raw_writew(0, brd_io + INTR_RESET_REG);\r\nexpio_mask_irq(d);\r\n}\r\nstatic void expio_unmask_irq(struct irq_data *d)\r\n{\r\nu16 reg;\r\nu32 expio = d->hwirq;\r\nreg = __raw_readw(brd_io + INTR_MASK_REG);\r\nreg &= ~(1 << expio);\r\n__raw_writew(reg, brd_io + INTR_MASK_REG);\r\n}\r\nint __init mxc_expio_init(u32 base, u32 intr_gpio)\r\n{\r\nu32 p_irq = gpio_to_irq(intr_gpio);\r\nint irq_base;\r\nint i;\r\nbrd_io = ioremap(BOARD_IO_ADDR(base), SZ_4K);\r\nif (brd_io == NULL)\r\nreturn -ENOMEM;\r\nif ((__raw_readw(brd_io + MAGIC_NUMBER1_REG) != 0xAAAA) ||\r\n(__raw_readw(brd_io + MAGIC_NUMBER2_REG) != 0x5555) ||\r\n(__raw_readw(brd_io + MAGIC_NUMBER3_REG) != 0xCAFE)) {\r\npr_info("3-Stack Debug board not detected\n");\r\niounmap(brd_io);\r\nbrd_io = NULL;\r\nreturn -ENODEV;\r\n}\r\npr_info("3-Stack Debug board detected, rev = 0x%04X\n",\r\nreadw(brd_io + CPLD_CODE_VER_REG));\r\ngpio_request(intr_gpio, "expio_pirq");\r\ngpio_direction_input(intr_gpio);\r\n__raw_writew(0, brd_io + INTR_MASK_REG);\r\n__raw_writew(0xFFFF, brd_io + INTR_RESET_REG);\r\n__raw_writew(0, brd_io + INTR_RESET_REG);\r\n__raw_writew(0x1F, brd_io + INTR_MASK_REG);\r\nirq_base = irq_alloc_descs(-1, 0, MXC_MAX_EXP_IO_LINES, numa_node_id());\r\nWARN_ON(irq_base < 0);\r\ndomain = irq_domain_add_legacy(NULL, MXC_MAX_EXP_IO_LINES, irq_base, 0,\r\n&irq_domain_simple_ops, NULL);\r\nWARN_ON(!domain);\r\nfor (i = irq_base; i < irq_base + MXC_MAX_EXP_IO_LINES; i++) {\r\nirq_set_chip_and_handler(i, &expio_irq_chip, handle_level_irq);\r\nset_irq_flags(i, IRQF_VALID);\r\n}\r\nirq_set_irq_type(p_irq, IRQF_TRIGGER_LOW);\r\nirq_set_chained_handler(p_irq, mxc_expio_irq_handler);\r\nregulator_register_fixed(0, dummy_supplies, ARRAY_SIZE(dummy_supplies));\r\nsmsc911x_resources[0].start = LAN9217_BASE_ADDR(base);\r\nsmsc911x_resources[0].end = LAN9217_BASE_ADDR(base) + 0x100 - 1;\r\nsmsc911x_resources[1].start = irq_find_mapping(domain, EXPIO_INT_ENET);\r\nsmsc911x_resources[1].end = irq_find_mapping(domain, EXPIO_INT_ENET);\r\nplatform_device_register(&smsc_lan9217_device);\r\nreturn 0;\r\n}

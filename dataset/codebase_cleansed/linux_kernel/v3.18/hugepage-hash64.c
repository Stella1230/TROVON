static void invalidate_old_hpte(unsigned long vsid, unsigned long addr,\r\npmd_t *pmdp, unsigned int psize, int ssize)\r\n{\r\nint i, max_hpte_count, valid;\r\nunsigned long s_addr;\r\nunsigned char *hpte_slot_array;\r\nunsigned long hidx, shift, vpn, hash, slot;\r\ns_addr = addr & HPAGE_PMD_MASK;\r\nhpte_slot_array = get_hpte_slot_array(pmdp);\r\nif (!hpte_slot_array)\r\nreturn;\r\nif (ppc_md.hugepage_invalidate)\r\nreturn ppc_md.hugepage_invalidate(vsid, s_addr, hpte_slot_array,\r\npsize, ssize);\r\nshift = mmu_psize_defs[psize].shift;\r\nmax_hpte_count = HPAGE_PMD_SIZE >> shift;\r\nfor (i = 0; i < max_hpte_count; i++) {\r\nvalid = hpte_valid(hpte_slot_array, i);\r\nif (!valid)\r\ncontinue;\r\nhidx = hpte_hash_index(hpte_slot_array, i);\r\naddr = s_addr + (i * (1ul << shift));\r\nvpn = hpt_vpn(addr, vsid, ssize);\r\nhash = hpt_hash(vpn, shift, ssize);\r\nif (hidx & _PTEIDX_SECONDARY)\r\nhash = ~hash;\r\nslot = (hash & htab_hash_mask) * HPTES_PER_GROUP;\r\nslot += hidx & _PTEIDX_GROUP_IX;\r\nppc_md.hpte_invalidate(slot, vpn, psize,\r\nMMU_PAGE_16M, ssize, 0);\r\n}\r\n}\r\nint __hash_page_thp(unsigned long ea, unsigned long access, unsigned long vsid,\r\npmd_t *pmdp, unsigned long trap, int local, int ssize,\r\nunsigned int psize)\r\n{\r\nunsigned int index, valid;\r\nunsigned char *hpte_slot_array;\r\nunsigned long rflags, pa, hidx;\r\nunsigned long old_pmd, new_pmd;\r\nint ret, lpsize = MMU_PAGE_16M;\r\nunsigned long vpn, hash, shift, slot;\r\ndo {\r\npmd_t pmd = ACCESS_ONCE(*pmdp);\r\nold_pmd = pmd_val(pmd);\r\nif (unlikely(old_pmd & _PAGE_BUSY))\r\nreturn 0;\r\nif (unlikely(old_pmd & _PAGE_SPLITTING))\r\nreturn 0;\r\nif (unlikely(access & ~old_pmd))\r\nreturn 1;\r\nnew_pmd = old_pmd | _PAGE_BUSY | _PAGE_ACCESSED;\r\nif (access & _PAGE_RW)\r\nnew_pmd |= _PAGE_DIRTY;\r\n} while (old_pmd != __cmpxchg_u64((unsigned long *)pmdp,\r\nold_pmd, new_pmd));\r\nrflags = new_pmd & _PAGE_USER;\r\nif ((new_pmd & _PAGE_USER) && !((new_pmd & _PAGE_RW) &&\r\n(new_pmd & _PAGE_DIRTY)))\r\nrflags |= 0x1;\r\nrflags |= ((new_pmd & _PAGE_EXEC) ? 0 : HPTE_R_N);\r\n#if 0\r\nif (!cpu_has_feature(CPU_FTR_COHERENT_ICACHE)) {\r\nrflags = hash_page_do_lazy_icache(rflags, __pte(old_pte), trap);\r\n}\r\n#endif\r\nshift = mmu_psize_defs[psize].shift;\r\nindex = (ea & ~HPAGE_PMD_MASK) >> shift;\r\nBUG_ON(index >= 4096);\r\nvpn = hpt_vpn(ea, vsid, ssize);\r\nhash = hpt_hash(vpn, shift, ssize);\r\nhpte_slot_array = get_hpte_slot_array(pmdp);\r\nif (psize == MMU_PAGE_4K) {\r\nif ((old_pmd & _PAGE_HASHPTE) && !(old_pmd & _PAGE_COMBO))\r\ninvalidate_old_hpte(vsid, ea, pmdp, MMU_PAGE_64K, ssize);\r\n}\r\nvalid = hpte_valid(hpte_slot_array, index);\r\nif (valid) {\r\nhidx = hpte_hash_index(hpte_slot_array, index);\r\nif (hidx & _PTEIDX_SECONDARY)\r\nhash = ~hash;\r\nslot = (hash & htab_hash_mask) * HPTES_PER_GROUP;\r\nslot += hidx & _PTEIDX_GROUP_IX;\r\nret = ppc_md.hpte_updatepp(slot, rflags, vpn,\r\npsize, lpsize, ssize, local);\r\nif (ret == -1) {\r\nvalid = 0;\r\nhpte_slot_array[index] = 0;\r\n}\r\n}\r\nif (!valid) {\r\nunsigned long hpte_group;\r\npa = pmd_pfn(__pmd(old_pmd)) << PAGE_SHIFT;\r\nnew_pmd |= _PAGE_HASHPTE;\r\nrflags |= (new_pmd & (_PAGE_WRITETHRU | _PAGE_NO_CACHE |\r\n_PAGE_GUARDED));\r\nrflags |= HPTE_R_M;\r\nrepeat:\r\nhpte_group = ((hash & htab_hash_mask) * HPTES_PER_GROUP) & ~0x7UL;\r\nslot = ppc_md.hpte_insert(hpte_group, vpn, pa, rflags, 0,\r\npsize, lpsize, ssize);\r\nif (unlikely(slot == -1)) {\r\nhpte_group = ((~hash & htab_hash_mask) *\r\nHPTES_PER_GROUP) & ~0x7UL;\r\nslot = ppc_md.hpte_insert(hpte_group, vpn, pa,\r\nrflags, HPTE_V_SECONDARY,\r\npsize, lpsize, ssize);\r\nif (slot == -1) {\r\nif (mftb() & 0x1)\r\nhpte_group = ((hash & htab_hash_mask) *\r\nHPTES_PER_GROUP) & ~0x7UL;\r\nppc_md.hpte_remove(hpte_group);\r\ngoto repeat;\r\n}\r\n}\r\nif (unlikely(slot == -2)) {\r\n*pmdp = __pmd(old_pmd);\r\nhash_failure_debug(ea, access, vsid, trap, ssize,\r\npsize, lpsize, old_pmd);\r\nreturn -1;\r\n}\r\nmark_hpte_slot_valid(hpte_slot_array, index, slot);\r\n}\r\nif (psize == MMU_PAGE_4K)\r\nnew_pmd |= _PAGE_COMBO;\r\nsmp_wmb();\r\n*pmdp = __pmd(new_pmd & ~_PAGE_BUSY);\r\nreturn 0;\r\n}

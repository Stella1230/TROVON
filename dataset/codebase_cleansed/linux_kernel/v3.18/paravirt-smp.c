static int __init set_numcpus(char *str)\r\n{\r\nint newval;\r\nif (get_option(&str, &newval)) {\r\nif (newval < 1 || newval >= NR_CPUS)\r\ngoto bad;\r\nnumcpus = newval;\r\nreturn 0;\r\n}\r\nbad:\r\nreturn -EINVAL;\r\n}\r\nstatic void paravirt_smp_setup(void)\r\n{\r\nint id;\r\nunsigned int cpunum = get_ebase_cpunum();\r\nif (WARN_ON(cpunum >= NR_CPUS))\r\nreturn;\r\nfor (id = 0; id < NR_CPUS; id++) {\r\nset_cpu_possible(id, id == 0);\r\nset_cpu_present(id, id == 0);\r\n}\r\n__cpu_number_map[cpunum] = 0;\r\n__cpu_logical_map[0] = cpunum;\r\nfor (id = 0; id < numcpus; id++) {\r\nset_cpu_possible(id, true);\r\nset_cpu_present(id, true);\r\n__cpu_number_map[id] = id;\r\n__cpu_logical_map[id] = id;\r\n}\r\n}\r\nstatic void paravirt_send_ipi_single(int cpu, unsigned int action)\r\n{\r\nirq_mbox_ipi(cpu, action);\r\n}\r\nstatic void paravirt_send_ipi_mask(const struct cpumask *mask, unsigned int action)\r\n{\r\nunsigned int cpu;\r\nfor_each_cpu_mask(cpu, *mask)\r\nparavirt_send_ipi_single(cpu, action);\r\n}\r\nstatic void paravirt_init_secondary(void)\r\n{\r\nunsigned int sr;\r\nsr = set_c0_status(ST0_BEV);\r\nwrite_c0_ebase((u32)ebase);\r\nsr |= STATUSF_IP2;\r\nwrite_c0_status(sr);\r\nirq_cpu_online();\r\n}\r\nstatic void paravirt_smp_finish(void)\r\n{\r\nwrite_c0_compare(read_c0_count() + mips_hpt_frequency / HZ);\r\nlocal_irq_enable();\r\n}\r\nstatic void paravirt_boot_secondary(int cpu, struct task_struct *idle)\r\n{\r\nparavirt_smp_gp[cpu] = (unsigned long)task_thread_info(idle);\r\nsmp_wmb();\r\nparavirt_smp_sp[cpu] = __KSTK_TOS(idle);\r\n}\r\nstatic irqreturn_t paravirt_reched_interrupt(int irq, void *dev_id)\r\n{\r\nscheduler_ipi();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t paravirt_function_interrupt(int irq, void *dev_id)\r\n{\r\nsmp_call_function_interrupt();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void paravirt_prepare_cpus(unsigned int max_cpus)\r\n{\r\nif (request_irq(MIPS_IRQ_MBOX0, paravirt_reched_interrupt,\r\nIRQF_PERCPU | IRQF_NO_THREAD, "Scheduler",\r\nparavirt_reched_interrupt)) {\r\npanic("Cannot request_irq for SchedulerIPI");\r\n}\r\nif (request_irq(MIPS_IRQ_MBOX1, paravirt_function_interrupt,\r\nIRQF_PERCPU | IRQF_NO_THREAD, "SMP-Call",\r\nparavirt_function_interrupt)) {\r\npanic("Cannot request_irq for SMP-Call");\r\n}\r\n}

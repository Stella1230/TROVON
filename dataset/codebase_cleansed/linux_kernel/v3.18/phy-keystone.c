static inline u32 keystone_usbphy_readl(void __iomem *base, u32 offset)\r\n{\r\nreturn readl(base + offset);\r\n}\r\nstatic inline void keystone_usbphy_writel(void __iomem *base,\r\nu32 offset, u32 value)\r\n{\r\nwritel(value, base + offset);\r\n}\r\nstatic int keystone_usbphy_init(struct usb_phy *phy)\r\n{\r\nstruct keystone_usbphy *k_phy = dev_get_drvdata(phy->dev);\r\nu32 val;\r\nval = keystone_usbphy_readl(k_phy->phy_ctrl, USB_PHY_CTL_CLOCK);\r\nkeystone_usbphy_writel(k_phy->phy_ctrl, USB_PHY_CTL_CLOCK,\r\nval | PHY_REF_SSP_EN);\r\nreturn 0;\r\n}\r\nstatic void keystone_usbphy_shutdown(struct usb_phy *phy)\r\n{\r\nstruct keystone_usbphy *k_phy = dev_get_drvdata(phy->dev);\r\nu32 val;\r\nval = keystone_usbphy_readl(k_phy->phy_ctrl, USB_PHY_CTL_CLOCK);\r\nkeystone_usbphy_writel(k_phy->phy_ctrl, USB_PHY_CTL_CLOCK,\r\nval &= ~PHY_REF_SSP_EN);\r\n}\r\nstatic int keystone_usbphy_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct keystone_usbphy *k_phy;\r\nstruct resource *res;\r\nint ret;\r\nk_phy = devm_kzalloc(dev, sizeof(*k_phy), GFP_KERNEL);\r\nif (!k_phy)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nk_phy->phy_ctrl = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(k_phy->phy_ctrl))\r\nreturn PTR_ERR(k_phy->phy_ctrl);\r\nret = usb_phy_gen_create_phy(dev, &k_phy->usb_phy_gen, NULL);\r\nif (ret)\r\nreturn ret;\r\nk_phy->usb_phy_gen.phy.init = keystone_usbphy_init;\r\nk_phy->usb_phy_gen.phy.shutdown = keystone_usbphy_shutdown;\r\nplatform_set_drvdata(pdev, k_phy);\r\nret = usb_add_phy_dev(&k_phy->usb_phy_gen.phy);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int keystone_usbphy_remove(struct platform_device *pdev)\r\n{\r\nstruct keystone_usbphy *k_phy = platform_get_drvdata(pdev);\r\nusb_remove_phy(&k_phy->usb_phy_gen.phy);\r\nreturn 0;\r\n}

static int handle_svc_hyp(struct kvm_vcpu *vcpu, struct kvm_run *run)\r\n{\r\nkvm_debug("SVC called from Hyp mode shouldn't go here\n");\r\nBUG();\r\nreturn -EINVAL;\r\n}\r\nstatic int handle_hvc(struct kvm_vcpu *vcpu, struct kvm_run *run)\r\n{\r\nint ret;\r\ntrace_kvm_hvc(*vcpu_pc(vcpu), *vcpu_reg(vcpu, 0),\r\nkvm_vcpu_hvc_get_imm(vcpu));\r\nret = kvm_psci_call(vcpu);\r\nif (ret < 0) {\r\nkvm_inject_undefined(vcpu);\r\nreturn 1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int handle_smc(struct kvm_vcpu *vcpu, struct kvm_run *run)\r\n{\r\nkvm_inject_undefined(vcpu);\r\nreturn 1;\r\n}\r\nstatic int handle_pabt_hyp(struct kvm_vcpu *vcpu, struct kvm_run *run)\r\n{\r\nkvm_err("Prefetch Abort taken from Hyp mode at %#08lx (HSR: %#08x)\n",\r\nkvm_vcpu_get_hfar(vcpu), kvm_vcpu_get_hsr(vcpu));\r\nreturn -EFAULT;\r\n}\r\nstatic int handle_dabt_hyp(struct kvm_vcpu *vcpu, struct kvm_run *run)\r\n{\r\nkvm_err("Data Abort taken from Hyp mode at %#08lx (HSR: %#08x)\n",\r\nkvm_vcpu_get_hfar(vcpu), kvm_vcpu_get_hsr(vcpu));\r\nreturn -EFAULT;\r\n}\r\nstatic int kvm_handle_wfx(struct kvm_vcpu *vcpu, struct kvm_run *run)\r\n{\r\ntrace_kvm_wfi(*vcpu_pc(vcpu));\r\nif (kvm_vcpu_get_hsr(vcpu) & HSR_WFI_IS_WFE)\r\nkvm_vcpu_on_spin(vcpu);\r\nelse\r\nkvm_vcpu_block(vcpu);\r\nkvm_skip_instr(vcpu, kvm_vcpu_trap_il_is32bit(vcpu));\r\nreturn 1;\r\n}\r\nstatic exit_handle_fn kvm_get_exit_handler(struct kvm_vcpu *vcpu)\r\n{\r\nu8 hsr_ec = kvm_vcpu_trap_get_class(vcpu);\r\nif (hsr_ec >= ARRAY_SIZE(arm_exit_handlers) ||\r\n!arm_exit_handlers[hsr_ec]) {\r\nkvm_err("Unknown exception class: hsr: %#08x\n",\r\n(unsigned int)kvm_vcpu_get_hsr(vcpu));\r\nBUG();\r\n}\r\nreturn arm_exit_handlers[hsr_ec];\r\n}\r\nint handle_exit(struct kvm_vcpu *vcpu, struct kvm_run *run,\r\nint exception_index)\r\n{\r\nexit_handle_fn exit_handler;\r\nswitch (exception_index) {\r\ncase ARM_EXCEPTION_IRQ:\r\nreturn 1;\r\ncase ARM_EXCEPTION_UNDEFINED:\r\nkvm_err("Undefined exception in Hyp mode at: %#08lx\n",\r\nkvm_vcpu_get_hyp_pc(vcpu));\r\nBUG();\r\npanic("KVM: Hypervisor undefined exception!\n");\r\ncase ARM_EXCEPTION_DATA_ABORT:\r\ncase ARM_EXCEPTION_PREF_ABORT:\r\ncase ARM_EXCEPTION_HVC:\r\nif (!kvm_condition_valid(vcpu)) {\r\nkvm_skip_instr(vcpu, kvm_vcpu_trap_il_is32bit(vcpu));\r\nreturn 1;\r\n}\r\nexit_handler = kvm_get_exit_handler(vcpu);\r\nreturn exit_handler(vcpu, run);\r\ndefault:\r\nkvm_pr_unimpl("Unsupported exception type: %d",\r\nexception_index);\r\nrun->exit_reason = KVM_EXIT_INTERNAL_ERROR;\r\nreturn 0;\r\n}\r\n}

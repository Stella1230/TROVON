int main(int argc, char **argv)\r\n{\r\nint efd = -1;\r\nint cfd = -1;\r\nint event_control = -1;\r\nchar event_control_path[PATH_MAX];\r\nchar line[LINE_MAX];\r\nint ret;\r\nif (argc != 3)\r\nerrx(1, "%s", USAGE_STR);\r\ncfd = open(argv[1], O_RDONLY);\r\nif (cfd == -1)\r\nerr(1, "Cannot open %s", argv[1]);\r\nret = snprintf(event_control_path, PATH_MAX, "%s/cgroup.event_control",\r\ndirname(argv[1]));\r\nif (ret >= PATH_MAX)\r\nerrx(1, "Path to cgroup.event_control is too long");\r\nevent_control = open(event_control_path, O_WRONLY);\r\nif (event_control == -1)\r\nerr(1, "Cannot open %s", event_control_path);\r\nefd = eventfd(0, 0);\r\nif (efd == -1)\r\nerr(1, "eventfd() failed");\r\nret = snprintf(line, LINE_MAX, "%d %d %s", efd, cfd, argv[2]);\r\nif (ret >= LINE_MAX)\r\nerrx(1, "Arguments string is too long");\r\nret = write(event_control, line, strlen(line) + 1);\r\nif (ret == -1)\r\nerr(1, "Cannot write to cgroup.event_control");\r\nwhile (1) {\r\nuint64_t result;\r\nret = read(efd, &result, sizeof(result));\r\nif (ret == -1) {\r\nif (errno == EINTR)\r\ncontinue;\r\nerr(1, "Cannot read from eventfd");\r\n}\r\nassert(ret == sizeof(result));\r\nret = access(event_control_path, W_OK);\r\nif ((ret == -1) && (errno == ENOENT)) {\r\nputs("The cgroup seems to have removed.");\r\nbreak;\r\n}\r\nif (ret == -1)\r\nerr(1, "cgroup.event_control is not accessible any more");\r\nprintf("%s %s: crossed\n", argv[1], argv[2]);\r\n}\r\nreturn 0;\r\n}

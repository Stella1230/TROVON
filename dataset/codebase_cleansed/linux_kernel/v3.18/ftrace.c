static unsigned long ftrace_nop_replace(struct dyn_ftrace *rec)\r\n{\r\nreturn rec->arch.old_mcount ? OLD_NOP : NOP;\r\n}\r\nstatic unsigned long adjust_address(struct dyn_ftrace *rec, unsigned long addr)\r\n{\r\nif (!rec->arch.old_mcount)\r\nreturn addr;\r\nif (addr == MCOUNT_ADDR)\r\naddr = OLD_MCOUNT_ADDR;\r\nelse if (addr == FTRACE_ADDR)\r\naddr = OLD_FTRACE_ADDR;\r\nreturn addr;\r\n}\r\nstatic unsigned long ftrace_nop_replace(struct dyn_ftrace *rec)\r\n{\r\nreturn NOP;\r\n}\r\nstatic unsigned long adjust_address(struct dyn_ftrace *rec, unsigned long addr)\r\n{\r\nreturn addr;\r\n}\r\nint ftrace_arch_code_modify_prepare(void)\r\n{\r\nset_all_modules_text_rw();\r\nreturn 0;\r\n}\r\nint ftrace_arch_code_modify_post_process(void)\r\n{\r\nset_all_modules_text_ro();\r\nreturn 0;\r\n}\r\nstatic unsigned long ftrace_call_replace(unsigned long pc, unsigned long addr)\r\n{\r\nreturn arm_gen_branch_link(pc, addr);\r\n}\r\nstatic int ftrace_modify_code(unsigned long pc, unsigned long old,\r\nunsigned long new, bool validate)\r\n{\r\nunsigned long replaced;\r\nif (IS_ENABLED(CONFIG_THUMB2_KERNEL)) {\r\nold = __opcode_to_mem_thumb32(old);\r\nnew = __opcode_to_mem_thumb32(new);\r\n} else {\r\nold = __opcode_to_mem_arm(old);\r\nnew = __opcode_to_mem_arm(new);\r\n}\r\nif (validate) {\r\nif (probe_kernel_read(&replaced, (void *)pc, MCOUNT_INSN_SIZE))\r\nreturn -EFAULT;\r\nif (replaced != old)\r\nreturn -EINVAL;\r\n}\r\nif (probe_kernel_write((void *)pc, &new, MCOUNT_INSN_SIZE))\r\nreturn -EPERM;\r\nflush_icache_range(pc, pc + MCOUNT_INSN_SIZE);\r\nreturn 0;\r\n}\r\nint ftrace_update_ftrace_func(ftrace_func_t func)\r\n{\r\nunsigned long pc;\r\nunsigned long new;\r\nint ret;\r\npc = (unsigned long)&ftrace_call;\r\nnew = ftrace_call_replace(pc, (unsigned long)func);\r\nret = ftrace_modify_code(pc, 0, new, false);\r\n#ifdef CONFIG_OLD_MCOUNT\r\nif (!ret) {\r\npc = (unsigned long)&ftrace_call_old;\r\nnew = ftrace_call_replace(pc, (unsigned long)func);\r\nret = ftrace_modify_code(pc, 0, new, false);\r\n}\r\n#endif\r\nreturn ret;\r\n}\r\nint ftrace_make_call(struct dyn_ftrace *rec, unsigned long addr)\r\n{\r\nunsigned long new, old;\r\nunsigned long ip = rec->ip;\r\nold = ftrace_nop_replace(rec);\r\nnew = ftrace_call_replace(ip, adjust_address(rec, addr));\r\nreturn ftrace_modify_code(rec->ip, old, new, true);\r\n}\r\nint ftrace_make_nop(struct module *mod,\r\nstruct dyn_ftrace *rec, unsigned long addr)\r\n{\r\nunsigned long ip = rec->ip;\r\nunsigned long old;\r\nunsigned long new;\r\nint ret;\r\nold = ftrace_call_replace(ip, adjust_address(rec, addr));\r\nnew = ftrace_nop_replace(rec);\r\nret = ftrace_modify_code(ip, old, new, true);\r\n#ifdef CONFIG_OLD_MCOUNT\r\nif (ret == -EINVAL && addr == MCOUNT_ADDR) {\r\nrec->arch.old_mcount = true;\r\nold = ftrace_call_replace(ip, adjust_address(rec, addr));\r\nnew = ftrace_nop_replace(rec);\r\nret = ftrace_modify_code(ip, old, new, true);\r\n}\r\n#endif\r\nreturn ret;\r\n}\r\nint __init ftrace_dyn_arch_init(void)\r\n{\r\nreturn 0;\r\n}\r\nvoid prepare_ftrace_return(unsigned long *parent, unsigned long self_addr,\r\nunsigned long frame_pointer)\r\n{\r\nunsigned long return_hooker = (unsigned long) &return_to_handler;\r\nstruct ftrace_graph_ent trace;\r\nunsigned long old;\r\nint err;\r\nif (unlikely(atomic_read(&current->tracing_graph_pause)))\r\nreturn;\r\nold = *parent;\r\n*parent = return_hooker;\r\ntrace.func = self_addr;\r\ntrace.depth = current->curr_ret_stack + 1;\r\nif (!ftrace_graph_entry(&trace)) {\r\n*parent = old;\r\nreturn;\r\n}\r\nerr = ftrace_push_return_trace(old, self_addr, &trace.depth,\r\nframe_pointer);\r\nif (err == -EBUSY) {\r\n*parent = old;\r\nreturn;\r\n}\r\n}\r\nstatic int __ftrace_modify_caller(unsigned long *callsite,\r\nvoid (*func) (void), bool enable)\r\n{\r\nunsigned long caller_fn = (unsigned long) func;\r\nunsigned long pc = (unsigned long) callsite;\r\nunsigned long branch = arm_gen_branch(pc, caller_fn);\r\nunsigned long nop = 0xe1a00000;\r\nunsigned long old = enable ? nop : branch;\r\nunsigned long new = enable ? branch : nop;\r\nreturn ftrace_modify_code(pc, old, new, true);\r\n}\r\nstatic int ftrace_modify_graph_caller(bool enable)\r\n{\r\nint ret;\r\nret = __ftrace_modify_caller(&ftrace_graph_call,\r\nftrace_graph_caller,\r\nenable);\r\n#ifdef CONFIG_OLD_MCOUNT\r\nif (!ret)\r\nret = __ftrace_modify_caller(&ftrace_graph_call_old,\r\nftrace_graph_caller_old,\r\nenable);\r\n#endif\r\nreturn ret;\r\n}\r\nint ftrace_enable_ftrace_graph_caller(void)\r\n{\r\nreturn ftrace_modify_graph_caller(true);\r\n}\r\nint ftrace_disable_ftrace_graph_caller(void)\r\n{\r\nreturn ftrace_modify_graph_caller(false);\r\n}

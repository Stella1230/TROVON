static void da9063_data_to_tm(u8 *data, struct rtc_time *tm)\r\n{\r\ntm->tm_sec = data[RTC_SEC] & DA9063_COUNT_SEC_MASK;\r\ntm->tm_min = data[RTC_MIN] & DA9063_COUNT_MIN_MASK;\r\ntm->tm_hour = data[RTC_HOUR] & DA9063_COUNT_HOUR_MASK;\r\ntm->tm_mday = data[RTC_DAY] & DA9063_COUNT_DAY_MASK;\r\ntm->tm_mon = MONTHS_FROM_DA9063(data[RTC_MONTH] &\r\nDA9063_COUNT_MONTH_MASK);\r\ntm->tm_year = YEARS_FROM_DA9063(data[RTC_YEAR] &\r\nDA9063_COUNT_YEAR_MASK);\r\n}\r\nstatic void da9063_tm_to_data(struct rtc_time *tm, u8 *data)\r\n{\r\ndata[RTC_SEC] &= ~DA9063_COUNT_SEC_MASK;\r\ndata[RTC_SEC] |= tm->tm_sec & DA9063_COUNT_SEC_MASK;\r\ndata[RTC_MIN] &= ~DA9063_COUNT_MIN_MASK;\r\ndata[RTC_MIN] |= tm->tm_min & DA9063_COUNT_MIN_MASK;\r\ndata[RTC_HOUR] &= ~DA9063_COUNT_HOUR_MASK;\r\ndata[RTC_HOUR] |= tm->tm_hour & DA9063_COUNT_HOUR_MASK;\r\ndata[RTC_DAY] &= ~DA9063_COUNT_DAY_MASK;\r\ndata[RTC_DAY] |= tm->tm_mday & DA9063_COUNT_DAY_MASK;\r\ndata[RTC_MONTH] &= ~DA9063_COUNT_MONTH_MASK;\r\ndata[RTC_MONTH] |= MONTHS_TO_DA9063(tm->tm_mon) &\r\nDA9063_COUNT_MONTH_MASK;\r\ndata[RTC_YEAR] &= ~DA9063_COUNT_YEAR_MASK;\r\ndata[RTC_YEAR] |= YEARS_TO_DA9063(tm->tm_year) &\r\nDA9063_COUNT_YEAR_MASK;\r\n}\r\nstatic int da9063_rtc_stop_alarm(struct device *dev)\r\n{\r\nstruct da9063_rtc *rtc = dev_get_drvdata(dev);\r\nreturn regmap_update_bits(rtc->hw->regmap, rtc->alarm_year,\r\nDA9063_ALARM_ON, 0);\r\n}\r\nstatic int da9063_rtc_start_alarm(struct device *dev)\r\n{\r\nstruct da9063_rtc *rtc = dev_get_drvdata(dev);\r\nreturn regmap_update_bits(rtc->hw->regmap, rtc->alarm_year,\r\nDA9063_ALARM_ON, DA9063_ALARM_ON);\r\n}\r\nstatic int da9063_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct da9063_rtc *rtc = dev_get_drvdata(dev);\r\nunsigned long tm_secs;\r\nunsigned long al_secs;\r\nu8 data[RTC_DATA_LEN];\r\nint ret;\r\nret = regmap_bulk_read(rtc->hw->regmap, DA9063_REG_COUNT_S,\r\ndata, RTC_DATA_LEN);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to read RTC time data: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (!(data[RTC_SEC] & DA9063_RTC_READ)) {\r\ndev_dbg(dev, "RTC not yet ready to be read by the host\n");\r\nreturn -EINVAL;\r\n}\r\nda9063_data_to_tm(data, tm);\r\nrtc_tm_to_time(tm, &tm_secs);\r\nrtc_tm_to_time(&rtc->alarm_time, &al_secs);\r\nif (rtc->rtc_sync == true && al_secs - tm_secs == 1)\r\nmemcpy(tm, &rtc->alarm_time, sizeof(struct rtc_time));\r\nelse\r\nrtc->rtc_sync = false;\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int da9063_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct da9063_rtc *rtc = dev_get_drvdata(dev);\r\nu8 data[RTC_DATA_LEN];\r\nint ret;\r\nda9063_tm_to_data(tm, data);\r\nret = regmap_bulk_write(rtc->hw->regmap, DA9063_REG_COUNT_S,\r\ndata, RTC_DATA_LEN);\r\nif (ret < 0)\r\ndev_err(dev, "Failed to set RTC time data: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int da9063_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct da9063_rtc *rtc = dev_get_drvdata(dev);\r\nu8 data[RTC_DATA_LEN];\r\nint ret;\r\nunsigned int val;\r\ndata[RTC_SEC] = 0;\r\nret = regmap_bulk_read(rtc->hw->regmap, rtc->alarm_start,\r\n&data[rtc->data_start], rtc->alarm_len);\r\nif (ret < 0)\r\nreturn ret;\r\nda9063_data_to_tm(data, &alrm->time);\r\nalrm->enabled = !!(data[RTC_YEAR] & DA9063_ALARM_ON);\r\nret = regmap_read(rtc->hw->regmap, DA9063_REG_EVENT_A, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nif (val & (DA9063_E_ALARM))\r\nalrm->pending = 1;\r\nelse\r\nalrm->pending = 0;\r\nreturn 0;\r\n}\r\nstatic int da9063_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct da9063_rtc *rtc = dev_get_drvdata(dev);\r\nu8 data[RTC_DATA_LEN];\r\nint ret;\r\nda9063_tm_to_data(&alrm->time, data);\r\nret = da9063_rtc_stop_alarm(dev);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to stop alarm: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_bulk_write(rtc->hw->regmap, rtc->alarm_start,\r\n&data[rtc->data_start], rtc->alarm_len);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to write alarm: %d\n", ret);\r\nreturn ret;\r\n}\r\nda9063_data_to_tm(data, &rtc->alarm_time);\r\nif (alrm->enabled) {\r\nret = da9063_rtc_start_alarm(dev);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to start alarm: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int da9063_rtc_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nif (enabled)\r\nreturn da9063_rtc_start_alarm(dev);\r\nelse\r\nreturn da9063_rtc_stop_alarm(dev);\r\n}\r\nstatic irqreturn_t da9063_alarm_event(int irq, void *data)\r\n{\r\nstruct da9063_rtc *rtc = data;\r\nregmap_update_bits(rtc->hw->regmap, rtc->alarm_year,\r\nDA9063_ALARM_ON, 0);\r\nrtc->rtc_sync = true;\r\nrtc_update_irq(rtc->rtc_dev, 1, RTC_IRQF | RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int da9063_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct da9063 *da9063 = dev_get_drvdata(pdev->dev.parent);\r\nstruct da9063_rtc *rtc;\r\nint irq_alarm;\r\nu8 data[RTC_DATA_LEN];\r\nint ret;\r\nret = regmap_update_bits(da9063->regmap, DA9063_REG_CONTROL_E,\r\nDA9063_RTC_EN, DA9063_RTC_EN);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to enable RTC\n");\r\ngoto err;\r\n}\r\nret = regmap_update_bits(da9063->regmap, DA9063_REG_EN_32K,\r\nDA9063_CRYSTAL, DA9063_CRYSTAL);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to run 32kHz oscillator\n");\r\ngoto err;\r\n}\r\nrtc = devm_kzalloc(&pdev->dev, sizeof(*rtc), GFP_KERNEL);\r\nif (!rtc)\r\nreturn -ENOMEM;\r\nif (da9063->variant_code == PMIC_DA9063_AD) {\r\nrtc->alarm_year = DA9063_AD_REG_ALARM_Y;\r\nrtc->alarm_start = DA9063_AD_REG_ALARM_MI;\r\nrtc->alarm_len = RTC_ALARM_DATA_LEN;\r\nrtc->data_start = RTC_MIN;\r\n} else {\r\nrtc->alarm_year = DA9063_BB_REG_ALARM_Y;\r\nrtc->alarm_start = DA9063_BB_REG_ALARM_S;\r\nrtc->alarm_len = RTC_DATA_LEN;\r\nrtc->data_start = RTC_SEC;\r\n}\r\nret = regmap_update_bits(da9063->regmap, rtc->alarm_start,\r\nDA9063_ALARM_STATUS_TICK | DA9063_ALARM_STATUS_ALARM,\r\n0);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to access RTC alarm register\n");\r\ngoto err;\r\n}\r\nret = regmap_update_bits(da9063->regmap, rtc->alarm_start,\r\nDA9063_ALARM_STATUS_ALARM,\r\nDA9063_ALARM_STATUS_ALARM);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to access RTC alarm register\n");\r\ngoto err;\r\n}\r\nret = regmap_update_bits(da9063->regmap, rtc->alarm_year,\r\nDA9063_TICK_ON, 0);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to disable TICKs\n");\r\ngoto err;\r\n}\r\ndata[RTC_SEC] = 0;\r\nret = regmap_bulk_read(da9063->regmap, rtc->alarm_start,\r\n&data[rtc->data_start], rtc->alarm_len);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to read initial alarm data: %d\n",\r\nret);\r\ngoto err;\r\n}\r\nplatform_set_drvdata(pdev, rtc);\r\nirq_alarm = platform_get_irq_byname(pdev, "ALARM");\r\nret = devm_request_threaded_irq(&pdev->dev, irq_alarm, NULL,\r\nda9063_alarm_event,\r\nIRQF_TRIGGER_LOW | IRQF_ONESHOT,\r\n"ALARM", rtc);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to request ALARM IRQ %d: %d\n",\r\nirq_alarm, ret);\r\ngoto err;\r\n}\r\nrtc->hw = da9063;\r\nrtc->rtc_dev = devm_rtc_device_register(&pdev->dev, DA9063_DRVNAME_RTC,\r\n&da9063_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc->rtc_dev))\r\nreturn PTR_ERR(rtc->rtc_dev);\r\nda9063_data_to_tm(data, &rtc->alarm_time);\r\nrtc->rtc_sync = false;\r\nerr:\r\nreturn ret;\r\n}

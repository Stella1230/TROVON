void *c2_mq_alloc(struct c2_mq *q)\r\n{\r\nBUG_ON(q->magic != C2_MQ_MAGIC);\r\nBUG_ON(q->type != C2_MQ_ADAPTER_TARGET);\r\nif (c2_mq_full(q)) {\r\nreturn NULL;\r\n} else {\r\n#ifdef DEBUG\r\nstruct c2wr_hdr *m =\r\n(struct c2wr_hdr *) (q->msg_pool.host + q->priv * q->msg_size);\r\n#ifdef CCMSGMAGIC\r\nBUG_ON(m->magic != be32_to_cpu(~CCWR_MAGIC));\r\nm->magic = cpu_to_be32(CCWR_MAGIC);\r\n#endif\r\nreturn m;\r\n#else\r\nreturn q->msg_pool.host + q->priv * q->msg_size;\r\n#endif\r\n}\r\n}\r\nvoid c2_mq_produce(struct c2_mq *q)\r\n{\r\nBUG_ON(q->magic != C2_MQ_MAGIC);\r\nBUG_ON(q->type != C2_MQ_ADAPTER_TARGET);\r\nif (!c2_mq_full(q)) {\r\nq->priv = (q->priv + 1) % q->q_size;\r\nq->hint_count++;\r\n__raw_writew((__force u16) cpu_to_be16(q->priv), &q->peer->shared);\r\n}\r\n}\r\nvoid *c2_mq_consume(struct c2_mq *q)\r\n{\r\nBUG_ON(q->magic != C2_MQ_MAGIC);\r\nBUG_ON(q->type != C2_MQ_HOST_TARGET);\r\nif (c2_mq_empty(q)) {\r\nreturn NULL;\r\n} else {\r\n#ifdef DEBUG\r\nstruct c2wr_hdr *m = (struct c2wr_hdr *)\r\n(q->msg_pool.host + q->priv * q->msg_size);\r\n#ifdef CCMSGMAGIC\r\nBUG_ON(m->magic != be32_to_cpu(CCWR_MAGIC));\r\n#endif\r\nreturn m;\r\n#else\r\nreturn q->msg_pool.host + q->priv * q->msg_size;\r\n#endif\r\n}\r\n}\r\nvoid c2_mq_free(struct c2_mq *q)\r\n{\r\nBUG_ON(q->magic != C2_MQ_MAGIC);\r\nBUG_ON(q->type != C2_MQ_HOST_TARGET);\r\nif (!c2_mq_empty(q)) {\r\n#ifdef CCMSGMAGIC\r\n{\r\nstruct c2wr_hdr __iomem *m = (struct c2wr_hdr __iomem *)\r\n(q->msg_pool.adapter + q->priv * q->msg_size);\r\n__raw_writel(cpu_to_be32(~CCWR_MAGIC), &m->magic);\r\n}\r\n#endif\r\nq->priv = (q->priv + 1) % q->q_size;\r\n__raw_writew((__force u16) cpu_to_be16(q->priv), &q->peer->shared);\r\n}\r\n}\r\nvoid c2_mq_lconsume(struct c2_mq *q, u32 wqe_count)\r\n{\r\nBUG_ON(q->magic != C2_MQ_MAGIC);\r\nBUG_ON(q->type != C2_MQ_ADAPTER_TARGET);\r\nwhile (wqe_count--) {\r\nBUG_ON(c2_mq_empty(q));\r\n*q->shared = cpu_to_be16((be16_to_cpu(*q->shared)+1) % q->q_size);\r\n}\r\n}\r\nvoid c2_mq_req_init(struct c2_mq *q, u32 index, u32 q_size, u32 msg_size,\r\nu8 __iomem *pool_start, u16 __iomem *peer, u32 type)\r\n{\r\nBUG_ON(!q->shared);\r\nq->index = index;\r\nq->q_size = q_size;\r\nq->msg_size = msg_size;\r\nq->msg_pool.adapter = pool_start;\r\nq->peer = (struct c2_mq_shared __iomem *) peer;\r\nq->magic = C2_MQ_MAGIC;\r\nq->type = type;\r\nq->priv = 0;\r\nq->hint_count = 0;\r\nreturn;\r\n}\r\nvoid c2_mq_rep_init(struct c2_mq *q, u32 index, u32 q_size, u32 msg_size,\r\nu8 *pool_start, u16 __iomem *peer, u32 type)\r\n{\r\nBUG_ON(!q->shared);\r\nq->index = index;\r\nq->q_size = q_size;\r\nq->msg_size = msg_size;\r\nq->msg_pool.host = pool_start;\r\nq->peer = (struct c2_mq_shared __iomem *) peer;\r\nq->magic = C2_MQ_MAGIC;\r\nq->type = type;\r\nq->priv = 0;\r\nq->hint_count = 0;\r\nreturn;\r\n}

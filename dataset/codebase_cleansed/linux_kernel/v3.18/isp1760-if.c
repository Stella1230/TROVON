static int of_isp1760_probe(struct platform_device *dev)\r\n{\r\nstruct isp1760 *drvdata;\r\nstruct device_node *dp = dev->dev.of_node;\r\nstruct resource *res;\r\nstruct resource memory;\r\nint virq;\r\nresource_size_t res_len;\r\nint ret;\r\nunsigned int devflags = 0;\r\nenum of_gpio_flags gpio_flags;\r\nu32 bus_width = 0;\r\ndrvdata = kzalloc(sizeof(*drvdata), GFP_KERNEL);\r\nif (!drvdata)\r\nreturn -ENOMEM;\r\nret = of_address_to_resource(dp, 0, &memory);\r\nif (ret) {\r\nret = -ENXIO;\r\ngoto free_data;\r\n}\r\nres_len = resource_size(&memory);\r\nres = request_mem_region(memory.start, res_len, dev_name(&dev->dev));\r\nif (!res) {\r\nret = -EBUSY;\r\ngoto free_data;\r\n}\r\nvirq = irq_of_parse_and_map(dp, 0);\r\nif (!virq) {\r\nret = -ENODEV;\r\ngoto release_reg;\r\n}\r\nif (of_device_is_compatible(dp, "nxp,usb-isp1761"))\r\ndevflags |= ISP1760_FLAG_ISP1761;\r\nof_property_read_u32(dp, "bus-width", &bus_width);\r\nif (bus_width == 16)\r\ndevflags |= ISP1760_FLAG_BUS_WIDTH_16;\r\nif (of_get_property(dp, "port1-otg", NULL) != NULL)\r\ndevflags |= ISP1760_FLAG_OTG_EN;\r\nif (of_get_property(dp, "analog-oc", NULL) != NULL)\r\ndevflags |= ISP1760_FLAG_ANALOG_OC;\r\nif (of_get_property(dp, "dack-polarity", NULL) != NULL)\r\ndevflags |= ISP1760_FLAG_DACK_POL_HIGH;\r\nif (of_get_property(dp, "dreq-polarity", NULL) != NULL)\r\ndevflags |= ISP1760_FLAG_DREQ_POL_HIGH;\r\ndrvdata->rst_gpio = of_get_gpio_flags(dp, 0, &gpio_flags);\r\nif (gpio_is_valid(drvdata->rst_gpio)) {\r\nret = gpio_request(drvdata->rst_gpio, dev_name(&dev->dev));\r\nif (!ret) {\r\nif (!(gpio_flags & OF_GPIO_ACTIVE_LOW)) {\r\ndevflags |= ISP1760_FLAG_RESET_ACTIVE_HIGH;\r\ngpio_direction_output(drvdata->rst_gpio, 0);\r\n} else {\r\ngpio_direction_output(drvdata->rst_gpio, 1);\r\n}\r\n} else {\r\ndrvdata->rst_gpio = ret;\r\n}\r\n}\r\ndrvdata->hcd = isp1760_register(memory.start, res_len, virq,\r\nIRQF_SHARED, drvdata->rst_gpio,\r\n&dev->dev, dev_name(&dev->dev),\r\ndevflags);\r\nif (IS_ERR(drvdata->hcd)) {\r\nret = PTR_ERR(drvdata->hcd);\r\ngoto free_gpio;\r\n}\r\nplatform_set_drvdata(dev, drvdata);\r\nreturn ret;\r\nfree_gpio:\r\nif (gpio_is_valid(drvdata->rst_gpio))\r\ngpio_free(drvdata->rst_gpio);\r\nrelease_reg:\r\nrelease_mem_region(memory.start, res_len);\r\nfree_data:\r\nkfree(drvdata);\r\nreturn ret;\r\n}\r\nstatic int of_isp1760_remove(struct platform_device *dev)\r\n{\r\nstruct isp1760 *drvdata = platform_get_drvdata(dev);\r\nusb_remove_hcd(drvdata->hcd);\r\niounmap(drvdata->hcd->regs);\r\nrelease_mem_region(drvdata->hcd->rsrc_start, drvdata->hcd->rsrc_len);\r\nusb_put_hcd(drvdata->hcd);\r\nif (gpio_is_valid(drvdata->rst_gpio))\r\ngpio_free(drvdata->rst_gpio);\r\nkfree(drvdata);\r\nreturn 0;\r\n}\r\nstatic int isp1761_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nu8 latency, limit;\r\n__u32 reg_data;\r\nint retry_count;\r\nstruct usb_hcd *hcd;\r\nunsigned int devflags = 0;\r\nint ret_status = 0;\r\nresource_size_t pci_mem_phy0;\r\nresource_size_t memlength;\r\nu8 __iomem *chip_addr;\r\nu8 __iomem *iobase;\r\nresource_size_t nxp_pci_io_base;\r\nresource_size_t iolength;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nif (pci_enable_device(dev) < 0)\r\nreturn -ENODEV;\r\nif (!dev->irq)\r\nreturn -ENODEV;\r\nnxp_pci_io_base = pci_resource_start(dev, 0);\r\niolength = pci_resource_len(dev, 0);\r\nif (!request_mem_region(nxp_pci_io_base, iolength, "ISP1761 IO MEM")) {\r\nprintk(KERN_ERR "request region #1\n");\r\nreturn -EBUSY;\r\n}\r\niobase = ioremap_nocache(nxp_pci_io_base, iolength);\r\nif (!iobase) {\r\nprintk(KERN_ERR "ioremap #1\n");\r\nret_status = -ENOMEM;\r\ngoto cleanup1;\r\n}\r\npci_mem_phy0 = pci_resource_start(dev, 3);\r\nmemlength = pci_resource_len(dev, 3);\r\nif (memlength < 0xffff) {\r\nprintk(KERN_ERR "memory length for this resource is wrong\n");\r\nret_status = -ENOMEM;\r\ngoto cleanup2;\r\n}\r\nif (!request_mem_region(pci_mem_phy0, memlength, "ISP-PCI")) {\r\nprintk(KERN_ERR "host controller already in use\n");\r\nret_status = -EBUSY;\r\ngoto cleanup2;\r\n}\r\nchip_addr = ioremap_nocache(pci_mem_phy0,memlength);\r\nif (!chip_addr) {\r\nprintk(KERN_ERR "Error ioremap failed\n");\r\nret_status = -ENOMEM;\r\ngoto cleanup3;\r\n}\r\npci_read_config_byte(dev, PCI_LATENCY_TIMER, &latency);\r\nif (latency) {\r\npci_read_config_byte(dev, PCI_MAX_LAT, &limit);\r\nif (limit && limit < latency)\r\npci_write_config_byte(dev, PCI_LATENCY_TIMER, limit);\r\n}\r\nretry_count = 20;\r\nreg_data = 0;\r\nwhile ((reg_data != 0xFACE) && retry_count) {\r\nwritel(0xface, chip_addr + HC_SCRATCH_REG);\r\nudelay(100);\r\nreg_data = readl(chip_addr + HC_SCRATCH_REG) & 0x0000ffff;\r\nretry_count--;\r\n}\r\niounmap(chip_addr);\r\nif (reg_data != 0xFACE) {\r\ndev_err(&dev->dev, "scratch register mismatch %x\n", reg_data);\r\nret_status = -ENOMEM;\r\ngoto cleanup3;\r\n}\r\npci_set_master(dev);\r\n#define PLX_INT_CSR_REG 0x68\r\nreg_data = readl(iobase + PLX_INT_CSR_REG);\r\nreg_data |= 0x900;\r\nwritel(reg_data, iobase + PLX_INT_CSR_REG);\r\ndev->dev.dma_mask = NULL;\r\nhcd = isp1760_register(pci_mem_phy0, memlength, dev->irq,\r\nIRQF_SHARED, -ENOENT, &dev->dev, dev_name(&dev->dev),\r\ndevflags);\r\nif (IS_ERR(hcd)) {\r\nret_status = -ENODEV;\r\ngoto cleanup3;\r\n}\r\niounmap(iobase);\r\nrelease_mem_region(nxp_pci_io_base, iolength);\r\npci_set_drvdata(dev, hcd);\r\nreturn 0;\r\ncleanup3:\r\nrelease_mem_region(pci_mem_phy0, memlength);\r\ncleanup2:\r\niounmap(iobase);\r\ncleanup1:\r\nrelease_mem_region(nxp_pci_io_base, iolength);\r\nreturn ret_status;\r\n}\r\nstatic void isp1761_pci_remove(struct pci_dev *dev)\r\n{\r\nstruct usb_hcd *hcd;\r\nhcd = pci_get_drvdata(dev);\r\nusb_remove_hcd(hcd);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\npci_disable_device(dev);\r\n}\r\nstatic void isp1761_pci_shutdown(struct pci_dev *dev)\r\n{\r\nprintk(KERN_ERR "ips1761_pci_shutdown\n");\r\n}\r\nstatic int isp1760_plat_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0;\r\nstruct usb_hcd *hcd;\r\nstruct resource *mem_res;\r\nstruct resource *irq_res;\r\nresource_size_t mem_size;\r\nstruct isp1760_platform_data *priv = dev_get_platdata(&pdev->dev);\r\nunsigned int devflags = 0;\r\nunsigned long irqflags = IRQF_SHARED;\r\nmem_res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!mem_res) {\r\npr_warning("isp1760: Memory resource not available\n");\r\nret = -ENODEV;\r\ngoto out;\r\n}\r\nmem_size = resource_size(mem_res);\r\nif (!request_mem_region(mem_res->start, mem_size, "isp1760")) {\r\npr_warning("isp1760: Cannot reserve the memory resource\n");\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\nirq_res = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (!irq_res) {\r\npr_warning("isp1760: IRQ resource not available\n");\r\nret = -ENODEV;\r\ngoto cleanup;\r\n}\r\nirqflags |= irq_res->flags & IRQF_TRIGGER_MASK;\r\nif (priv) {\r\nif (priv->is_isp1761)\r\ndevflags |= ISP1760_FLAG_ISP1761;\r\nif (priv->bus_width_16)\r\ndevflags |= ISP1760_FLAG_BUS_WIDTH_16;\r\nif (priv->port1_otg)\r\ndevflags |= ISP1760_FLAG_OTG_EN;\r\nif (priv->analog_oc)\r\ndevflags |= ISP1760_FLAG_ANALOG_OC;\r\nif (priv->dack_polarity_high)\r\ndevflags |= ISP1760_FLAG_DACK_POL_HIGH;\r\nif (priv->dreq_polarity_high)\r\ndevflags |= ISP1760_FLAG_DREQ_POL_HIGH;\r\n}\r\nhcd = isp1760_register(mem_res->start, mem_size, irq_res->start,\r\nirqflags, -ENOENT,\r\n&pdev->dev, dev_name(&pdev->dev), devflags);\r\nplatform_set_drvdata(pdev, hcd);\r\nif (IS_ERR(hcd)) {\r\npr_warning("isp1760: Failed to register the HCD device\n");\r\nret = -ENODEV;\r\ngoto cleanup;\r\n}\r\npr_info("ISP1760 USB device initialised\n");\r\nreturn ret;\r\ncleanup:\r\nrelease_mem_region(mem_res->start, mem_size);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int isp1760_plat_remove(struct platform_device *pdev)\r\n{\r\nstruct resource *mem_res;\r\nresource_size_t mem_size;\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_remove_hcd(hcd);\r\nmem_res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nmem_size = resource_size(mem_res);\r\nrelease_mem_region(mem_res->start, mem_size);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}\r\nstatic int __init isp1760_init(void)\r\n{\r\nint ret, any_ret = -ENODEV;\r\ninit_kmem_once();\r\nret = platform_driver_register(&isp1760_plat_driver);\r\nif (!ret)\r\nany_ret = 0;\r\n#if defined(CONFIG_OF) && defined(CONFIG_OF_IRQ)\r\nret = platform_driver_register(&isp1760_of_driver);\r\nif (!ret)\r\nany_ret = 0;\r\n#endif\r\n#ifdef CONFIG_PCI\r\nret = pci_register_driver(&isp1761_pci_driver);\r\nif (!ret)\r\nany_ret = 0;\r\n#endif\r\nif (any_ret)\r\ndeinit_kmem_cache();\r\nreturn any_ret;\r\n}\r\nstatic void __exit isp1760_exit(void)\r\n{\r\nplatform_driver_unregister(&isp1760_plat_driver);\r\n#if defined(CONFIG_OF) && defined(CONFIG_OF_IRQ)\r\nplatform_driver_unregister(&isp1760_of_driver);\r\n#endif\r\n#ifdef CONFIG_PCI\r\npci_unregister_driver(&isp1761_pci_driver);\r\n#endif\r\ndeinit_kmem_cache();\r\n}

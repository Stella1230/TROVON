static int unregister_from_lirc(struct igorplug *ir)\r\n{\r\nstruct lirc_driver *d;\r\nint devnum;\r\ndevnum = ir->devnum;\r\nd = ir->d;\r\nif (!d) {\r\ndev_err(&ir->usbdev->dev,\r\n"%s: called with NULL lirc driver struct!\n", __func__);\r\nreturn -EINVAL;\r\n}\r\ndev_dbg(&ir->usbdev->dev, "calling lirc_unregister_driver\n");\r\nlirc_unregister_driver(d->minor);\r\nreturn devnum;\r\n}\r\nstatic int set_use_inc(void *data)\r\n{\r\nstruct igorplug *ir = data;\r\nif (!ir) {\r\nprintk(DRIVER_NAME "[?]: set_use_inc called with no context\n");\r\nreturn -EIO;\r\n}\r\ndev_dbg(&ir->usbdev->dev, "set use inc\n");\r\nif (!ir->usbdev)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic void set_use_dec(void *data)\r\n{\r\nstruct igorplug *ir = data;\r\nif (!ir) {\r\nprintk(DRIVER_NAME "[?]: set_use_dec called with no context\n");\r\nreturn;\r\n}\r\ndev_dbg(&ir->usbdev->dev, "set use dec\n");\r\n}\r\nstatic void send_fragment(struct igorplug *ir, struct lirc_buffer *buf,\r\nint i, int max)\r\n{\r\nint code;\r\nwhile (i < max) {\r\ncode = (unsigned int)ir->buf_in[i] * 85 +\r\n(unsigned int)ir->buf_in[i] / 3;\r\nir->last_time.tv_usec += code;\r\nif (ir->in_space)\r\ncode |= PULSE_BIT;\r\nlirc_buffer_write(buf, (unsigned char *)&code);\r\nir->in_space ^= 1;\r\n++i;\r\n}\r\n}\r\nstatic int igorplugusb_remote_poll(void *data, struct lirc_buffer *buf)\r\n{\r\nint ret;\r\nstruct igorplug *ir = (struct igorplug *)data;\r\nif (!ir || !ir->usbdev)\r\nreturn -ENODEV;\r\nmemset(ir->buf_in, 0, ir->len_in);\r\nret = usb_control_msg(ir->usbdev, usb_rcvctrlpipe(ir->usbdev, 0),\r\nGET_INFRACODE, USB_TYPE_VENDOR | USB_DIR_IN,\r\n0, 0,\r\nir->buf_in, ir->len_in,\r\nHZ * USB_CTRL_GET_TIMEOUT);\r\nif (ret > 0) {\r\nint code, timediff;\r\nstruct timeval now;\r\nif (ret < DEVICE_HEADERLEN)\r\nreturn -ENODATA;\r\ndev_dbg(&ir->usbdev->dev, "Got %d bytes. Header: %*ph\n",\r\nret, 3, ir->buf_in);\r\ndo_gettimeofday(&now);\r\ntimediff = now.tv_sec - ir->last_time.tv_sec;\r\nif (timediff + 1 > PULSE_MASK / 1000000)\r\ntimediff = PULSE_MASK;\r\nelse {\r\ntimediff *= 1000000;\r\ntimediff += now.tv_usec - ir->last_time.tv_usec;\r\n}\r\nir->last_time.tv_sec = now.tv_sec;\r\nir->last_time.tv_usec = now.tv_usec;\r\ncode = timediff;\r\nlirc_buffer_write(buf, (unsigned char *)&code);\r\nir->in_space = 1;\r\nif (ir->buf_in[2] == 0)\r\nsend_fragment(ir, buf, DEVICE_HEADERLEN, ret);\r\nelse {\r\ndev_warn(&ir->usbdev->dev,\r\n"[%d]: Device buffer overrun.\n", ir->devnum);\r\nir->buf_in[2] %= ret - DEVICE_HEADERLEN;\r\nsend_fragment(ir, buf, DEVICE_HEADERLEN +\r\nir->buf_in[2] - (ir->buf_in[2] & 1), ret);\r\nsend_fragment(ir, buf, DEVICE_HEADERLEN,\r\nDEVICE_HEADERLEN + ir->buf_in[2]);\r\n}\r\nret = usb_control_msg(\r\nir->usbdev, usb_rcvctrlpipe(ir->usbdev, 0),\r\nSET_INFRABUFFER_EMPTY, USB_TYPE_VENDOR|USB_DIR_IN,\r\n0, 0,\r\nir->buf_in, ir->len_in,\r\nHZ * USB_CTRL_GET_TIMEOUT);\r\nif (ret < 0)\r\nprintk(DRIVER_NAME "[%d]: SET_INFRABUFFER_EMPTY: error %d\n",\r\nir->devnum, ret);\r\nreturn 0;\r\n} else if (ret < 0)\r\nprintk(DRIVER_NAME "[%d]: GET_INFRACODE: error %d\n",\r\nir->devnum, ret);\r\nreturn -ENODATA;\r\n}\r\nstatic int igorplugusb_remote_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_device *dev;\r\nstruct usb_host_interface *idesc = NULL;\r\nstruct usb_endpoint_descriptor *ep;\r\nstruct igorplug *ir = NULL;\r\nstruct lirc_driver *driver = NULL;\r\nint devnum, pipe, maxp;\r\nchar buf[63], name[128] = "";\r\nint ret;\r\ndev_dbg(&intf->dev, "%s: usb probe called.\n", __func__);\r\ndev = interface_to_usbdev(intf);\r\nidesc = intf->cur_altsetting;\r\nif (idesc->desc.bNumEndpoints != 1)\r\nreturn -ENODEV;\r\nep = &idesc->endpoint->desc;\r\nif (((ep->bEndpointAddress & USB_ENDPOINT_DIR_MASK)\r\n!= USB_DIR_IN)\r\n|| (ep->bmAttributes & USB_ENDPOINT_XFERTYPE_MASK)\r\n!= USB_ENDPOINT_XFER_CONTROL)\r\nreturn -ENODEV;\r\npipe = usb_rcvctrlpipe(dev, ep->bEndpointAddress);\r\ndevnum = dev->devnum;\r\nmaxp = usb_maxpacket(dev, pipe, usb_pipeout(pipe));\r\ndev_dbg(&intf->dev, "%s: bytes_in_key=%zu maxp=%d\n",\r\n__func__, CODE_LENGTH, maxp);\r\nir = devm_kzalloc(&intf->dev, sizeof(*ir), GFP_KERNEL);\r\nif (!ir)\r\nreturn -ENOMEM;\r\ndriver = devm_kzalloc(&intf->dev, sizeof(*driver), GFP_KERNEL);\r\nif (!driver)\r\nreturn -ENOMEM;\r\nir->buf_in = usb_alloc_coherent(dev, DEVICE_BUFLEN + DEVICE_HEADERLEN,\r\nGFP_ATOMIC, &ir->dma_in);\r\nif (!ir->buf_in)\r\nreturn -ENOMEM;\r\nstrcpy(driver->name, DRIVER_NAME " ");\r\ndriver->minor = -1;\r\ndriver->code_length = CODE_LENGTH * 8;\r\ndriver->features = LIRC_CAN_REC_MODE2;\r\ndriver->data = ir;\r\ndriver->chunk_size = CODE_LENGTH;\r\ndriver->buffer_size = DEVICE_BUFLEN + ADDITIONAL_LIRC_BYTES;\r\ndriver->set_use_inc = &set_use_inc;\r\ndriver->set_use_dec = &set_use_dec;\r\ndriver->sample_rate = sample_rate;\r\ndriver->add_to_buf = &igorplugusb_remote_poll;\r\ndriver->dev = &intf->dev;\r\ndriver->owner = THIS_MODULE;\r\nret = lirc_register_driver(driver);\r\nif (ret < 0) {\r\nusb_free_coherent(dev, DEVICE_BUFLEN + DEVICE_HEADERLEN,\r\nir->buf_in, ir->dma_in);\r\nreturn ret;\r\n}\r\ndriver->minor = ret;\r\nir->d = driver;\r\nir->devnum = devnum;\r\nir->usbdev = dev;\r\nir->len_in = DEVICE_BUFLEN + DEVICE_HEADERLEN;\r\nir->in_space = 1;\r\ndo_gettimeofday(&ir->last_time);\r\nif (dev->descriptor.iManufacturer\r\n&& usb_string(dev, dev->descriptor.iManufacturer,\r\nbuf, sizeof(buf)) > 0)\r\nstrlcpy(name, buf, sizeof(name));\r\nif (dev->descriptor.iProduct\r\n&& usb_string(dev, dev->descriptor.iProduct, buf, sizeof(buf)) > 0)\r\nsnprintf(name + strlen(name), sizeof(name) - strlen(name),\r\n" %s", buf);\r\nprintk(DRIVER_NAME "[%d]: %s on usb%d:%d\n", devnum, name,\r\ndev->bus->busnum, devnum);\r\nret = usb_control_msg(ir->usbdev, usb_rcvctrlpipe(ir->usbdev, 0),\r\nSET_INFRABUFFER_EMPTY, USB_TYPE_VENDOR|USB_DIR_IN,\r\n0, 0,\r\nir->buf_in, ir->len_in,\r\nHZ * USB_CTRL_GET_TIMEOUT);\r\nif (ret < 0)\r\nprintk(DRIVER_NAME "[%d]: SET_INFRABUFFER_EMPTY: error %d\n",\r\ndevnum, ret);\r\nusb_set_intfdata(intf, ir);\r\nreturn 0;\r\n}\r\nstatic void igorplugusb_remote_disconnect(struct usb_interface *intf)\r\n{\r\nstruct usb_device *usbdev = interface_to_usbdev(intf);\r\nstruct igorplug *ir = usb_get_intfdata(intf);\r\nstruct device *dev = &intf->dev;\r\nint devnum;\r\nusb_set_intfdata(intf, NULL);\r\nif (!ir || !ir->d)\r\nreturn;\r\nir->usbdev = NULL;\r\nusb_free_coherent(usbdev, ir->len_in, ir->buf_in, ir->dma_in);\r\ndevnum = unregister_from_lirc(ir);\r\ndev_info(dev, DRIVER_NAME "[%d]: %s done\n", devnum, __func__);\r\n}

int mthca_pd_alloc(struct mthca_dev *dev, int privileged, struct mthca_pd *pd)\r\n{\r\nint err = 0;\r\npd->privileged = privileged;\r\natomic_set(&pd->sqp_count, 0);\r\npd->pd_num = mthca_alloc(&dev->pd_table.alloc);\r\nif (pd->pd_num == -1)\r\nreturn -ENOMEM;\r\nif (privileged) {\r\nerr = mthca_mr_alloc_notrans(dev, pd->pd_num,\r\nMTHCA_MPT_FLAG_LOCAL_READ |\r\nMTHCA_MPT_FLAG_LOCAL_WRITE,\r\n&pd->ntmr);\r\nif (err)\r\nmthca_free(&dev->pd_table.alloc, pd->pd_num);\r\n}\r\nreturn err;\r\n}\r\nvoid mthca_pd_free(struct mthca_dev *dev, struct mthca_pd *pd)\r\n{\r\nif (pd->privileged)\r\nmthca_free_mr(dev, &pd->ntmr);\r\nmthca_free(&dev->pd_table.alloc, pd->pd_num);\r\n}\r\nint mthca_init_pd_table(struct mthca_dev *dev)\r\n{\r\nreturn mthca_alloc_init(&dev->pd_table.alloc,\r\ndev->limits.num_pds,\r\n(1 << 24) - 1,\r\ndev->limits.reserved_pds);\r\n}\r\nvoid mthca_cleanup_pd_table(struct mthca_dev *dev)\r\n{\r\nmthca_alloc_cleanup(&dev->pd_table.alloc);\r\n}

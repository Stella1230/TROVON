static inline int coda_fideq(struct CodaFid *fid1, struct CodaFid *fid2)\r\n{\r\nreturn memcmp(fid1, fid2, sizeof(*fid1)) == 0;\r\n}\r\nstatic void coda_fill_inode(struct inode *inode, struct coda_vattr *attr)\r\n{\r\ncoda_vattr_to_iattr(inode, attr);\r\nif (S_ISREG(inode->i_mode)) {\r\ninode->i_op = &coda_file_inode_operations;\r\ninode->i_fop = &coda_file_operations;\r\n} else if (S_ISDIR(inode->i_mode)) {\r\ninode->i_op = &coda_dir_inode_operations;\r\ninode->i_fop = &coda_dir_operations;\r\n} else if (S_ISLNK(inode->i_mode)) {\r\ninode->i_op = &coda_symlink_inode_operations;\r\ninode->i_data.a_ops = &coda_symlink_aops;\r\ninode->i_mapping = &inode->i_data;\r\n} else\r\ninit_special_inode(inode, inode->i_mode, huge_decode_dev(attr->va_rdev));\r\n}\r\nstatic int coda_test_inode(struct inode *inode, void *data)\r\n{\r\nstruct CodaFid *fid = (struct CodaFid *)data;\r\nstruct coda_inode_info *cii = ITOC(inode);\r\nreturn coda_fideq(&cii->c_fid, fid);\r\n}\r\nstatic int coda_set_inode(struct inode *inode, void *data)\r\n{\r\nstruct CodaFid *fid = (struct CodaFid *)data;\r\nstruct coda_inode_info *cii = ITOC(inode);\r\ncii->c_fid = *fid;\r\nreturn 0;\r\n}\r\nstruct inode * coda_iget(struct super_block * sb, struct CodaFid * fid,\r\nstruct coda_vattr * attr)\r\n{\r\nstruct inode *inode;\r\nstruct coda_inode_info *cii;\r\nunsigned long hash = coda_f2i(fid);\r\ninode = iget5_locked(sb, hash, coda_test_inode, coda_set_inode, fid);\r\nif (!inode)\r\nreturn ERR_PTR(-ENOMEM);\r\nif (inode->i_state & I_NEW) {\r\ncii = ITOC(inode);\r\ninode->i_ino = hash;\r\ncii->c_mapcount = 0;\r\nunlock_new_inode(inode);\r\n}\r\ncoda_fill_inode(inode, attr);\r\nreturn inode;\r\n}\r\nstruct inode *coda_cnode_make(struct CodaFid *fid, struct super_block *sb)\r\n{\r\nstruct coda_vattr attr;\r\nstruct inode *inode;\r\nint error;\r\nerror = venus_getattr(sb, fid, &attr);\r\nif (error)\r\nreturn ERR_PTR(error);\r\ninode = coda_iget(sb, fid, &attr);\r\nif (IS_ERR(inode))\r\npr_warn("%s: coda_iget failed\n", __func__);\r\nreturn inode;\r\n}\r\nvoid coda_replace_fid(struct inode *inode, struct CodaFid *oldfid,\r\nstruct CodaFid *newfid)\r\n{\r\nstruct coda_inode_info *cii = ITOC(inode);\r\nunsigned long hash = coda_f2i(newfid);\r\nBUG_ON(!coda_fideq(&cii->c_fid, oldfid));\r\nremove_inode_hash(inode);\r\ncii->c_fid = *newfid;\r\ninode->i_ino = hash;\r\n__insert_inode_hash(inode, hash);\r\n}\r\nstruct inode *coda_fid_to_inode(struct CodaFid *fid, struct super_block *sb)\r\n{\r\nstruct inode *inode;\r\nunsigned long hash = coda_f2i(fid);\r\nif ( !sb ) {\r\npr_warn("%s: no sb!\n", __func__);\r\nreturn NULL;\r\n}\r\ninode = ilookup5(sb, hash, coda_test_inode, fid);\r\nif ( !inode )\r\nreturn NULL;\r\nBUG_ON(inode->i_state & I_NEW);\r\nreturn inode;\r\n}\r\nstruct inode *coda_cnode_makectl(struct super_block *sb)\r\n{\r\nstruct inode *inode = new_inode(sb);\r\nif (inode) {\r\ninode->i_ino = CTL_INO;\r\ninode->i_op = &coda_ioctl_inode_operations;\r\ninode->i_fop = &coda_ioctl_operations;\r\ninode->i_mode = 0444;\r\nreturn inode;\r\n}\r\nreturn ERR_PTR(-ENOMEM);\r\n}

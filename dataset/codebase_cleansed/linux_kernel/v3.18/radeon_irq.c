void radeon_irq_set_state(struct drm_device *dev, u32 mask, int state)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nif (state)\r\ndev_priv->irq_enable_reg |= mask;\r\nelse\r\ndev_priv->irq_enable_reg &= ~mask;\r\nif (dev->irq_enabled)\r\nRADEON_WRITE(RADEON_GEN_INT_CNTL, dev_priv->irq_enable_reg);\r\n}\r\nstatic void r500_vbl_irq_set_state(struct drm_device *dev, u32 mask, int state)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nif (state)\r\ndev_priv->r500_disp_irq_reg |= mask;\r\nelse\r\ndev_priv->r500_disp_irq_reg &= ~mask;\r\nif (dev->irq_enabled)\r\nRADEON_WRITE(R500_DxMODE_INT_MASK, dev_priv->r500_disp_irq_reg);\r\n}\r\nint radeon_enable_vblank(struct drm_device *dev, int crtc)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RS600) {\r\nswitch (crtc) {\r\ncase 0:\r\nr500_vbl_irq_set_state(dev, R500_D1MODE_INT_MASK, 1);\r\nbreak;\r\ncase 1:\r\nr500_vbl_irq_set_state(dev, R500_D2MODE_INT_MASK, 1);\r\nbreak;\r\ndefault:\r\nDRM_ERROR("tried to enable vblank on non-existent crtc %d\n",\r\ncrtc);\r\nreturn -EINVAL;\r\n}\r\n} else {\r\nswitch (crtc) {\r\ncase 0:\r\nradeon_irq_set_state(dev, RADEON_CRTC_VBLANK_MASK, 1);\r\nbreak;\r\ncase 1:\r\nradeon_irq_set_state(dev, RADEON_CRTC2_VBLANK_MASK, 1);\r\nbreak;\r\ndefault:\r\nDRM_ERROR("tried to enable vblank on non-existent crtc %d\n",\r\ncrtc);\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid radeon_disable_vblank(struct drm_device *dev, int crtc)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RS600) {\r\nswitch (crtc) {\r\ncase 0:\r\nr500_vbl_irq_set_state(dev, R500_D1MODE_INT_MASK, 0);\r\nbreak;\r\ncase 1:\r\nr500_vbl_irq_set_state(dev, R500_D2MODE_INT_MASK, 0);\r\nbreak;\r\ndefault:\r\nDRM_ERROR("tried to enable vblank on non-existent crtc %d\n",\r\ncrtc);\r\nbreak;\r\n}\r\n} else {\r\nswitch (crtc) {\r\ncase 0:\r\nradeon_irq_set_state(dev, RADEON_CRTC_VBLANK_MASK, 0);\r\nbreak;\r\ncase 1:\r\nradeon_irq_set_state(dev, RADEON_CRTC2_VBLANK_MASK, 0);\r\nbreak;\r\ndefault:\r\nDRM_ERROR("tried to enable vblank on non-existent crtc %d\n",\r\ncrtc);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic u32 radeon_acknowledge_irqs(drm_radeon_private_t *dev_priv, u32 *r500_disp_int)\r\n{\r\nu32 irqs = RADEON_READ(RADEON_GEN_INT_STATUS);\r\nu32 irq_mask = RADEON_SW_INT_TEST;\r\n*r500_disp_int = 0;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RS600) {\r\nif (irqs & R500_DISPLAY_INT_STATUS) {\r\nu32 disp_irq;\r\ndisp_irq = RADEON_READ(R500_DISP_INTERRUPT_STATUS);\r\n*r500_disp_int = disp_irq;\r\nif (disp_irq & R500_D1_VBLANK_INTERRUPT)\r\nRADEON_WRITE(R500_D1MODE_VBLANK_STATUS, R500_VBLANK_ACK);\r\nif (disp_irq & R500_D2_VBLANK_INTERRUPT)\r\nRADEON_WRITE(R500_D2MODE_VBLANK_STATUS, R500_VBLANK_ACK);\r\n}\r\nirq_mask |= R500_DISPLAY_INT_STATUS;\r\n} else\r\nirq_mask |= RADEON_CRTC_VBLANK_STAT | RADEON_CRTC2_VBLANK_STAT;\r\nirqs &= irq_mask;\r\nif (irqs)\r\nRADEON_WRITE(RADEON_GEN_INT_STATUS, irqs);\r\nreturn irqs;\r\n}\r\nirqreturn_t radeon_driver_irq_handler(int irq, void *arg)\r\n{\r\nstruct drm_device *dev = (struct drm_device *) arg;\r\ndrm_radeon_private_t *dev_priv =\r\n(drm_radeon_private_t *) dev->dev_private;\r\nu32 stat;\r\nu32 r500_disp_int;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nreturn IRQ_NONE;\r\nstat = radeon_acknowledge_irqs(dev_priv, &r500_disp_int);\r\nif (!stat)\r\nreturn IRQ_NONE;\r\nstat &= dev_priv->irq_enable_reg;\r\nif (stat & RADEON_SW_INT_TEST)\r\nwake_up(&dev_priv->swi_queue);\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RS600) {\r\nif (r500_disp_int & R500_D1_VBLANK_INTERRUPT)\r\ndrm_handle_vblank(dev, 0);\r\nif (r500_disp_int & R500_D2_VBLANK_INTERRUPT)\r\ndrm_handle_vblank(dev, 1);\r\n} else {\r\nif (stat & RADEON_CRTC_VBLANK_STAT)\r\ndrm_handle_vblank(dev, 0);\r\nif (stat & RADEON_CRTC2_VBLANK_STAT)\r\ndrm_handle_vblank(dev, 1);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int radeon_emit_irq(struct drm_device * dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nunsigned int ret;\r\nRING_LOCALS;\r\natomic_inc(&dev_priv->swi_emitted);\r\nret = atomic_read(&dev_priv->swi_emitted);\r\nBEGIN_RING(4);\r\nOUT_RING_REG(RADEON_LAST_SWI_REG, ret);\r\nOUT_RING_REG(RADEON_GEN_INT_STATUS, RADEON_SW_INT_FIRE);\r\nADVANCE_RING();\r\nCOMMIT_RING();\r\nreturn ret;\r\n}\r\nstatic int radeon_wait_irq(struct drm_device * dev, int swi_nr)\r\n{\r\ndrm_radeon_private_t *dev_priv =\r\n(drm_radeon_private_t *) dev->dev_private;\r\nint ret = 0;\r\nif (RADEON_READ(RADEON_LAST_SWI_REG) >= swi_nr)\r\nreturn 0;\r\ndev_priv->stats.boxes |= RADEON_BOX_WAIT_IDLE;\r\nDRM_WAIT_ON(ret, dev_priv->swi_queue, 3 * HZ,\r\nRADEON_READ(RADEON_LAST_SWI_REG) >= swi_nr);\r\nreturn ret;\r\n}\r\nu32 radeon_get_vblank_counter(struct drm_device *dev, int crtc)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nif (!dev_priv) {\r\nDRM_ERROR("called with no initialization\n");\r\nreturn -EINVAL;\r\n}\r\nif (crtc < 0 || crtc > 1) {\r\nDRM_ERROR("Invalid crtc %d\n", crtc);\r\nreturn -EINVAL;\r\n}\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RS600) {\r\nif (crtc == 0)\r\nreturn RADEON_READ(R500_D1CRTC_FRAME_COUNT);\r\nelse\r\nreturn RADEON_READ(R500_D2CRTC_FRAME_COUNT);\r\n} else {\r\nif (crtc == 0)\r\nreturn RADEON_READ(RADEON_CRTC_CRNT_FRAME);\r\nelse\r\nreturn RADEON_READ(RADEON_CRTC2_CRNT_FRAME);\r\n}\r\n}\r\nint radeon_irq_emit(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\ndrm_radeon_irq_emit_t *emit = data;\r\nint result;\r\nif (!dev_priv) {\r\nDRM_ERROR("called with no initialization\n");\r\nreturn -EINVAL;\r\n}\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nreturn -EINVAL;\r\nLOCK_TEST_WITH_RETURN(dev, file_priv);\r\nresult = radeon_emit_irq(dev);\r\nif (copy_to_user(emit->irq_seq, &result, sizeof(int))) {\r\nDRM_ERROR("copy_to_user\n");\r\nreturn -EFAULT;\r\n}\r\nreturn 0;\r\n}\r\nint radeon_irq_wait(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\ndrm_radeon_irq_wait_t *irqwait = data;\r\nif (!dev_priv) {\r\nDRM_ERROR("called with no initialization\n");\r\nreturn -EINVAL;\r\n}\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nreturn -EINVAL;\r\nreturn radeon_wait_irq(dev, irqwait->irq_seq);\r\n}\r\nvoid radeon_driver_irq_preinstall(struct drm_device * dev)\r\n{\r\ndrm_radeon_private_t *dev_priv =\r\n(drm_radeon_private_t *) dev->dev_private;\r\nu32 dummy;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nreturn;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RS600)\r\nRADEON_WRITE(R500_DxMODE_INT_MASK, 0);\r\nRADEON_WRITE(RADEON_GEN_INT_CNTL, 0);\r\nradeon_acknowledge_irqs(dev_priv, &dummy);\r\n}\r\nint radeon_driver_irq_postinstall(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv =\r\n(drm_radeon_private_t *) dev->dev_private;\r\natomic_set(&dev_priv->swi_emitted, 0);\r\ninit_waitqueue_head(&dev_priv->swi_queue);\r\ndev->max_vblank_count = 0x001fffff;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nreturn 0;\r\nradeon_irq_set_state(dev, RADEON_SW_INT_ENABLE, 1);\r\nreturn 0;\r\n}\r\nvoid radeon_driver_irq_uninstall(struct drm_device * dev)\r\n{\r\ndrm_radeon_private_t *dev_priv =\r\n(drm_radeon_private_t *) dev->dev_private;\r\nif (!dev_priv)\r\nreturn;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nreturn;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RS600)\r\nRADEON_WRITE(R500_DxMODE_INT_MASK, 0);\r\nRADEON_WRITE(RADEON_GEN_INT_CNTL, 0);\r\n}\r\nint radeon_vblank_crtc_get(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = (drm_radeon_private_t *) dev->dev_private;\r\nreturn dev_priv->vblank_crtc;\r\n}\r\nint radeon_vblank_crtc_set(struct drm_device *dev, int64_t value)\r\n{\r\ndrm_radeon_private_t *dev_priv = (drm_radeon_private_t *) dev->dev_private;\r\nif (value & ~(DRM_RADEON_VBLANK_CRTC1 | DRM_RADEON_VBLANK_CRTC2)) {\r\nDRM_ERROR("called with invalid crtc 0x%x\n", (unsigned int)value);\r\nreturn -EINVAL;\r\n}\r\ndev_priv->vblank_crtc = (unsigned int)value;\r\nreturn 0;\r\n}

static int __init init_ts5500_map(void)\r\n{\r\nint rc = 0;\r\nts5500_map.virt = ioremap_nocache(ts5500_map.phys, ts5500_map.size);\r\nif (!ts5500_map.virt) {\r\nprintk(KERN_ERR "Failed to ioremap_nocache\n");\r\nrc = -EIO;\r\ngoto err2;\r\n}\r\nsimple_map_init(&ts5500_map);\r\nmymtd = do_map_probe("jedec_probe", &ts5500_map);\r\nif (!mymtd)\r\nmymtd = do_map_probe("map_rom", &ts5500_map);\r\nif (!mymtd) {\r\nrc = -ENXIO;\r\ngoto err1;\r\n}\r\nmymtd->owner = THIS_MODULE;\r\nmtd_device_register(mymtd, ts5500_partitions, NUM_PARTITIONS);\r\nreturn 0;\r\nerr1:\r\niounmap(ts5500_map.virt);\r\nerr2:\r\nreturn rc;\r\n}\r\nstatic void __exit cleanup_ts5500_map(void)\r\n{\r\nif (mymtd) {\r\nmtd_device_unregister(mymtd);\r\nmap_destroy(mymtd);\r\n}\r\nif (ts5500_map.virt) {\r\niounmap(ts5500_map.virt);\r\nts5500_map.virt = NULL;\r\n}\r\n}

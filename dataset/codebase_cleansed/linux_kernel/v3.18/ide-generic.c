static void ide_generic_check_pci_legacy_iobases(int *primary, int *secondary)\r\n{\r\n#ifdef CONFIG_PCI\r\nstruct pci_dev *p = NULL;\r\nu16 val;\r\nfor_each_pci_dev(p) {\r\nif (pci_resource_start(p, 0) == 0x1f0)\r\n*primary = 1;\r\nif (pci_resource_start(p, 2) == 0x170)\r\n*secondary = 1;\r\nif (p->vendor == PCI_VENDOR_ID_CYRIX &&\r\n(p->device == PCI_DEVICE_ID_CYRIX_5510 ||\r\np->device == PCI_DEVICE_ID_CYRIX_5520))\r\n*primary = *secondary = 1;\r\nif (p->vendor == PCI_VENDOR_ID_INTEL &&\r\np->device == PCI_DEVICE_ID_INTEL_82371MX) {\r\npci_read_config_word(p, 0x6C, &val);\r\nif (val & 0x8000) {\r\nif (val & 0x4000)\r\n*secondary = 1;\r\nelse\r\n*primary = 1;\r\n}\r\n}\r\n}\r\n#endif\r\n}\r\nstatic int __init ide_generic_init(void)\r\n{\r\nstruct ide_hw hw, *hws[] = { &hw };\r\nunsigned long io_addr;\r\nint i, rc = 0, primary = 0, secondary = 0;\r\nide_generic_check_pci_legacy_iobases(&primary, &secondary);\r\nif (!probe_mask) {\r\nprintk(KERN_INFO DRV_NAME ": please use \"probe_mask=0x3f\" "\r\n"module parameter for probing all legacy ISA IDE ports\n");\r\nif (primary == 0)\r\nprobe_mask |= 0x1;\r\nif (secondary == 0)\r\nprobe_mask |= 0x2;\r\n} else\r\nprintk(KERN_INFO DRV_NAME ": enforcing probing of I/O ports "\r\n"upon user request\n");\r\nfor (i = 0; i < ARRAY_SIZE(legacy_bases); i++) {\r\nio_addr = legacy_bases[i];\r\nif ((probe_mask & (1 << i)) && io_addr) {\r\nif (!request_region(io_addr, 8, DRV_NAME)) {\r\nprintk(KERN_ERR "%s: I/O resource 0x%lX-0x%lX "\r\n"not free.\n",\r\nDRV_NAME, io_addr, io_addr + 7);\r\nrc = -EBUSY;\r\ncontinue;\r\n}\r\nif (!request_region(io_addr + 0x206, 1, DRV_NAME)) {\r\nprintk(KERN_ERR "%s: I/O resource 0x%lX "\r\n"not free.\n",\r\nDRV_NAME, io_addr + 0x206);\r\nrelease_region(io_addr, 8);\r\nrc = -EBUSY;\r\ncontinue;\r\n}\r\nmemset(&hw, 0, sizeof(hw));\r\nide_std_init_ports(&hw, io_addr, io_addr + 0x206);\r\n#ifdef CONFIG_IA64\r\nhw.irq = isa_irq_to_vector(legacy_irqs[i]);\r\n#else\r\nhw.irq = legacy_irqs[i];\r\n#endif\r\nrc = ide_host_add(&ide_generic_port_info, hws, 1, NULL);\r\nif (rc) {\r\nrelease_region(io_addr + 0x206, 1);\r\nrelease_region(io_addr, 8);\r\n}\r\n}\r\n}\r\nreturn rc;\r\n}

static int pm8607_list_voltage(struct regulator_dev *rdev, unsigned index)\r\n{\r\nstruct pm8607_regulator_info *info = rdev_get_drvdata(rdev);\r\nint ret = -EINVAL;\r\nif (info->vol_table && (index < rdev->desc->n_voltages)) {\r\nret = info->vol_table[index];\r\nif (info->slope_double)\r\nret <<= 1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int pm8607_regulator_dt_init(struct platform_device *pdev,\r\nstruct pm8607_regulator_info *info,\r\nstruct regulator_config *config)\r\n{\r\nstruct device_node *nproot, *np;\r\nnproot = pdev->dev.parent->of_node;\r\nif (!nproot)\r\nreturn -ENODEV;\r\nnproot = of_get_child_by_name(nproot, "regulators");\r\nif (!nproot) {\r\ndev_err(&pdev->dev, "failed to find regulators node\n");\r\nreturn -ENODEV;\r\n}\r\nfor_each_child_of_node(nproot, np) {\r\nif (!of_node_cmp(np->name, info->desc.name)) {\r\nconfig->init_data =\r\nof_get_regulator_init_data(&pdev->dev, np);\r\nconfig->of_node = np;\r\nbreak;\r\n}\r\n}\r\nof_node_put(nproot);\r\nreturn 0;\r\n}\r\nstatic int pm8607_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct pm860x_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct pm8607_regulator_info *info = NULL;\r\nstruct regulator_init_data *pdata = dev_get_platdata(&pdev->dev);\r\nstruct regulator_config config = { };\r\nstruct resource *res;\r\nint i;\r\nres = platform_get_resource(pdev, IORESOURCE_REG, 0);\r\nif (res) {\r\nfor (i = 0; i < ARRAY_SIZE(pm8607_regulator_info); i++) {\r\ninfo = &pm8607_regulator_info[i];\r\nif (info->desc.vsel_reg == res->start)\r\nbreak;\r\n}\r\nif (i == ARRAY_SIZE(pm8607_regulator_info)) {\r\ndev_err(&pdev->dev, "Failed to find regulator %llu\n",\r\n(unsigned long long)res->start);\r\nreturn -EINVAL;\r\n}\r\n} else {\r\ninfo = &pm8606_regulator_info[0];\r\ni = -1;\r\n}\r\ninfo->i2c = (chip->id == CHIP_PM8607) ? chip->client : chip->companion;\r\ninfo->i2c_8606 = (chip->id == CHIP_PM8607) ? chip->companion :\r\nchip->client;\r\ninfo->chip = chip;\r\nif ((i == PM8607_ID_BUCK3) && info->chip->buck3_double)\r\ninfo->slope_double = 1;\r\nconfig.dev = &pdev->dev;\r\nconfig.driver_data = info;\r\nif (pm8607_regulator_dt_init(pdev, info, &config))\r\nif (pdata)\r\nconfig.init_data = pdata;\r\nif (chip->id == CHIP_PM8607)\r\nconfig.regmap = chip->regmap;\r\nelse\r\nconfig.regmap = chip->regmap_companion;\r\ninfo->regulator = devm_regulator_register(&pdev->dev, &info->desc,\r\n&config);\r\nif (IS_ERR(info->regulator)) {\r\ndev_err(&pdev->dev, "failed to register regulator %s\n",\r\ninfo->desc.name);\r\nreturn PTR_ERR(info->regulator);\r\n}\r\nplatform_set_drvdata(pdev, info);\r\nreturn 0;\r\n}\r\nstatic int __init pm8607_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&pm8607_regulator_driver);\r\n}\r\nstatic void __exit pm8607_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&pm8607_regulator_driver);\r\n}

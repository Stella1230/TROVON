static void add_child(struct func_stack *stack, const char *child, int pos)\r\n{\r\nint i;\r\nif (!child)\r\nreturn;\r\nif (pos < stack->size)\r\nfree(stack->stack[pos]);\r\nelse {\r\nchar **ptr;\r\nptr = realloc(stack->stack, sizeof(char *) *\r\n(stack->size + STK_BLK));\r\nif (!ptr) {\r\nwarning("could not allocate plugin memory\n");\r\nreturn;\r\n}\r\nstack->stack = ptr;\r\nfor (i = stack->size; i < stack->size + STK_BLK; i++)\r\nstack->stack[i] = NULL;\r\nstack->size += STK_BLK;\r\n}\r\nstack->stack[pos] = strdup(child);\r\n}\r\nstatic int add_and_get_index(const char *parent, const char *child, int cpu)\r\n{\r\nint i;\r\nif (cpu < 0)\r\nreturn 0;\r\nif (cpu > cpus) {\r\nstruct func_stack *ptr;\r\nptr = realloc(fstack, sizeof(*fstack) * (cpu + 1));\r\nif (!ptr) {\r\nwarning("could not allocate plugin memory\n");\r\nreturn 0;\r\n}\r\nfstack = ptr;\r\nfor (i = cpus + 1; i <= cpu; i++)\r\nmemset(&fstack[i], 0, sizeof(fstack[i]));\r\ncpus = cpu;\r\n}\r\nfor (i = 0; i < fstack[cpu].size && fstack[cpu].stack[i]; i++) {\r\nif (strcmp(parent, fstack[cpu].stack[i]) == 0) {\r\nadd_child(&fstack[cpu], child, i+1);\r\nreturn i;\r\n}\r\n}\r\nadd_child(&fstack[cpu], parent, 0);\r\nadd_child(&fstack[cpu], child, 1);\r\nreturn 0;\r\n}\r\nstatic int function_handler(struct trace_seq *s, struct pevent_record *record,\r\nstruct event_format *event, void *context)\r\n{\r\nstruct pevent *pevent = event->pevent;\r\nunsigned long long function;\r\nunsigned long long pfunction;\r\nconst char *func;\r\nconst char *parent;\r\nint index;\r\nif (pevent_get_field_val(s, event, "ip", record, &function, 1))\r\nreturn trace_seq_putc(s, '!');\r\nfunc = pevent_find_function(pevent, function);\r\nif (pevent_get_field_val(s, event, "parent_ip", record, &pfunction, 1))\r\nreturn trace_seq_putc(s, '!');\r\nparent = pevent_find_function(pevent, pfunction);\r\nif (parent && ftrace_indent->set)\r\nindex = add_and_get_index(parent, func, record->cpu);\r\ntrace_seq_printf(s, "%*s", index*3, "");\r\nif (func)\r\ntrace_seq_printf(s, "%s", func);\r\nelse\r\ntrace_seq_printf(s, "0x%llx", function);\r\nif (ftrace_parent->set) {\r\ntrace_seq_printf(s, " <-- ");\r\nif (parent)\r\ntrace_seq_printf(s, "%s", parent);\r\nelse\r\ntrace_seq_printf(s, "0x%llx", pfunction);\r\n}\r\nreturn 0;\r\n}\r\nint PEVENT_PLUGIN_LOADER(struct pevent *pevent)\r\n{\r\npevent_register_event_handler(pevent, -1, "ftrace", "function",\r\nfunction_handler, NULL);\r\ntraceevent_plugin_add_options("ftrace", plugin_options);\r\nreturn 0;\r\n}\r\nvoid PEVENT_PLUGIN_UNLOADER(struct pevent *pevent)\r\n{\r\nint i, x;\r\npevent_unregister_event_handler(pevent, -1, "ftrace", "function",\r\nfunction_handler, NULL);\r\nfor (i = 0; i <= cpus; i++) {\r\nfor (x = 0; x < fstack[i].size && fstack[i].stack[x]; x++)\r\nfree(fstack[i].stack[x]);\r\nfree(fstack[i].stack);\r\n}\r\ntraceevent_plugin_remove_options(plugin_options);\r\nfree(fstack);\r\nfstack = NULL;\r\ncpus = -1;\r\n}

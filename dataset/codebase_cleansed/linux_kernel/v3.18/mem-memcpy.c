static void init_cycle(void)\r\n{\r\ncycle_fd = sys_perf_event_open(&cycle_attr, getpid(), -1, -1,\r\nperf_event_open_cloexec_flag());\r\nif (cycle_fd < 0 && errno == ENOSYS)\r\ndie("No CONFIG_PERF_EVENTS=y kernel support configured?\n");\r\nelse\r\nBUG_ON(cycle_fd < 0);\r\n}\r\nstatic u64 get_cycle(void)\r\n{\r\nint ret;\r\nu64 clk;\r\nret = read(cycle_fd, &clk, sizeof(u64));\r\nBUG_ON(ret != sizeof(u64));\r\nreturn clk;\r\n}\r\nstatic double timeval2double(struct timeval *ts)\r\n{\r\nreturn (double)ts->tv_sec +\r\n(double)ts->tv_usec / (double)1000000;\r\n}\r\nstatic void alloc_mem(void **dst, void **src, size_t length)\r\n{\r\n*dst = zalloc(length);\r\nif (!*dst)\r\ndie("memory allocation failed - maybe length is too large?\n");\r\n*src = zalloc(length);\r\nif (!*src)\r\ndie("memory allocation failed - maybe length is too large?\n");\r\nmemset(*src, 0, length);\r\n}\r\nstatic u64 do_memcpy_cycle(memcpy_t fn, size_t len, bool prefault)\r\n{\r\nu64 cycle_start = 0ULL, cycle_end = 0ULL;\r\nvoid *src = NULL, *dst = NULL;\r\nint i;\r\nalloc_mem(&src, &dst, len);\r\nif (prefault)\r\nfn(dst, src, len);\r\ncycle_start = get_cycle();\r\nfor (i = 0; i < iterations; ++i)\r\nfn(dst, src, len);\r\ncycle_end = get_cycle();\r\nfree(src);\r\nfree(dst);\r\nreturn cycle_end - cycle_start;\r\n}\r\nstatic double do_memcpy_gettimeofday(memcpy_t fn, size_t len, bool prefault)\r\n{\r\nstruct timeval tv_start, tv_end, tv_diff;\r\nvoid *src = NULL, *dst = NULL;\r\nint i;\r\nalloc_mem(&src, &dst, len);\r\nif (prefault)\r\nfn(dst, src, len);\r\nBUG_ON(gettimeofday(&tv_start, NULL));\r\nfor (i = 0; i < iterations; ++i)\r\nfn(dst, src, len);\r\nBUG_ON(gettimeofday(&tv_end, NULL));\r\ntimersub(&tv_end, &tv_start, &tv_diff);\r\nfree(src);\r\nfree(dst);\r\nreturn (double)((double)len / timeval2double(&tv_diff));\r\n}\r\nint bench_mem_memcpy(int argc, const char **argv,\r\nconst char *prefix __maybe_unused)\r\n{\r\nint i;\r\nsize_t len;\r\ndouble result_bps[2];\r\nu64 result_cycle[2];\r\nargc = parse_options(argc, argv, options,\r\nbench_mem_memcpy_usage, 0);\r\nif (no_prefault && only_prefault) {\r\nfprintf(stderr, "Invalid options: -o and -n are mutually exclusive\n");\r\nreturn 1;\r\n}\r\nif (use_cycle)\r\ninit_cycle();\r\nlen = (size_t)perf_atoll((char *)length_str);\r\nresult_cycle[0] = result_cycle[1] = 0ULL;\r\nresult_bps[0] = result_bps[1] = 0.0;\r\nif ((s64)len <= 0) {\r\nfprintf(stderr, "Invalid length:%s\n", length_str);\r\nreturn 1;\r\n}\r\nif (only_prefault && no_prefault)\r\nonly_prefault = no_prefault = false;\r\nfor (i = 0; routines[i].name; i++) {\r\nif (!strcmp(routines[i].name, routine))\r\nbreak;\r\n}\r\nif (!routines[i].name) {\r\nprintf("Unknown routine:%s\n", routine);\r\nprintf("Available routines...\n");\r\nfor (i = 0; routines[i].name; i++) {\r\nprintf("\t%s ... %s\n",\r\nroutines[i].name, routines[i].desc);\r\n}\r\nreturn 1;\r\n}\r\nif (bench_format == BENCH_FORMAT_DEFAULT)\r\nprintf("# Copying %s Bytes ...\n\n", length_str);\r\nif (!only_prefault && !no_prefault) {\r\nif (use_cycle) {\r\nresult_cycle[0] =\r\ndo_memcpy_cycle(routines[i].fn, len, false);\r\nresult_cycle[1] =\r\ndo_memcpy_cycle(routines[i].fn, len, true);\r\n} else {\r\nresult_bps[0] =\r\ndo_memcpy_gettimeofday(routines[i].fn,\r\nlen, false);\r\nresult_bps[1] =\r\ndo_memcpy_gettimeofday(routines[i].fn,\r\nlen, true);\r\n}\r\n} else {\r\nif (use_cycle) {\r\nresult_cycle[pf] =\r\ndo_memcpy_cycle(routines[i].fn,\r\nlen, only_prefault);\r\n} else {\r\nresult_bps[pf] =\r\ndo_memcpy_gettimeofday(routines[i].fn,\r\nlen, only_prefault);\r\n}\r\n}\r\nswitch (bench_format) {\r\ncase BENCH_FORMAT_DEFAULT:\r\nif (!only_prefault && !no_prefault) {\r\nif (use_cycle) {\r\nprintf(" %14lf Cycle/Byte\n",\r\n(double)result_cycle[0]\r\n/ (double)len);\r\nprintf(" %14lf Cycle/Byte (with prefault)\n",\r\n(double)result_cycle[1]\r\n/ (double)len);\r\n} else {\r\nprint_bps(result_bps[0]);\r\nprintf("\n");\r\nprint_bps(result_bps[1]);\r\nprintf(" (with prefault)\n");\r\n}\r\n} else {\r\nif (use_cycle) {\r\nprintf(" %14lf Cycle/Byte",\r\n(double)result_cycle[pf]\r\n/ (double)len);\r\n} else\r\nprint_bps(result_bps[pf]);\r\nprintf("%s\n", only_prefault ? " (with prefault)" : "");\r\n}\r\nbreak;\r\ncase BENCH_FORMAT_SIMPLE:\r\nif (!only_prefault && !no_prefault) {\r\nif (use_cycle) {\r\nprintf("%lf %lf\n",\r\n(double)result_cycle[0] / (double)len,\r\n(double)result_cycle[1] / (double)len);\r\n} else {\r\nprintf("%lf %lf\n",\r\nresult_bps[0], result_bps[1]);\r\n}\r\n} else {\r\nif (use_cycle) {\r\nprintf("%lf\n", (double)result_cycle[pf]\r\n/ (double)len);\r\n} else\r\nprintf("%lf\n", result_bps[pf]);\r\n}\r\nbreak;\r\ndefault:\r\ndie("unknown format: %d\n", bench_format);\r\nbreak;\r\n}\r\nreturn 0;\r\n}

static int setkey_unaligned(struct crypto_tfm *tfm, const u8 *key,\r\nunsigned int keylen)\r\n{\r\nstruct cipher_alg *cia = &tfm->__crt_alg->cra_cipher;\r\nunsigned long alignmask = crypto_tfm_alg_alignmask(tfm);\r\nint ret;\r\nu8 *buffer, *alignbuffer;\r\nunsigned long absize;\r\nabsize = keylen + alignmask;\r\nbuffer = kmalloc(absize, GFP_ATOMIC);\r\nif (!buffer)\r\nreturn -ENOMEM;\r\nalignbuffer = (u8 *)ALIGN((unsigned long)buffer, alignmask + 1);\r\nmemcpy(alignbuffer, key, keylen);\r\nret = cia->cia_setkey(tfm, alignbuffer, keylen);\r\nmemset(alignbuffer, 0, keylen);\r\nkfree(buffer);\r\nreturn ret;\r\n}\r\nstatic int setkey(struct crypto_tfm *tfm, const u8 *key, unsigned int keylen)\r\n{\r\nstruct cipher_alg *cia = &tfm->__crt_alg->cra_cipher;\r\nunsigned long alignmask = crypto_tfm_alg_alignmask(tfm);\r\ntfm->crt_flags &= ~CRYPTO_TFM_RES_MASK;\r\nif (keylen < cia->cia_min_keysize || keylen > cia->cia_max_keysize) {\r\ntfm->crt_flags |= CRYPTO_TFM_RES_BAD_KEY_LEN;\r\nreturn -EINVAL;\r\n}\r\nif ((unsigned long)key & alignmask)\r\nreturn setkey_unaligned(tfm, key, keylen);\r\nreturn cia->cia_setkey(tfm, key, keylen);\r\n}\r\nstatic void cipher_crypt_unaligned(void (*fn)(struct crypto_tfm *, u8 *,\r\nconst u8 *),\r\nstruct crypto_tfm *tfm,\r\nu8 *dst, const u8 *src)\r\n{\r\nunsigned long alignmask = crypto_tfm_alg_alignmask(tfm);\r\nunsigned int size = crypto_tfm_alg_blocksize(tfm);\r\nu8 buffer[size + alignmask];\r\nu8 *tmp = (u8 *)ALIGN((unsigned long)buffer, alignmask + 1);\r\nmemcpy(tmp, src, size);\r\nfn(tfm, tmp, tmp);\r\nmemcpy(dst, tmp, size);\r\n}\r\nstatic void cipher_encrypt_unaligned(struct crypto_tfm *tfm,\r\nu8 *dst, const u8 *src)\r\n{\r\nunsigned long alignmask = crypto_tfm_alg_alignmask(tfm);\r\nstruct cipher_alg *cipher = &tfm->__crt_alg->cra_cipher;\r\nif (unlikely(((unsigned long)dst | (unsigned long)src) & alignmask)) {\r\ncipher_crypt_unaligned(cipher->cia_encrypt, tfm, dst, src);\r\nreturn;\r\n}\r\ncipher->cia_encrypt(tfm, dst, src);\r\n}\r\nstatic void cipher_decrypt_unaligned(struct crypto_tfm *tfm,\r\nu8 *dst, const u8 *src)\r\n{\r\nunsigned long alignmask = crypto_tfm_alg_alignmask(tfm);\r\nstruct cipher_alg *cipher = &tfm->__crt_alg->cra_cipher;\r\nif (unlikely(((unsigned long)dst | (unsigned long)src) & alignmask)) {\r\ncipher_crypt_unaligned(cipher->cia_decrypt, tfm, dst, src);\r\nreturn;\r\n}\r\ncipher->cia_decrypt(tfm, dst, src);\r\n}\r\nint crypto_init_cipher_ops(struct crypto_tfm *tfm)\r\n{\r\nstruct cipher_tfm *ops = &tfm->crt_cipher;\r\nstruct cipher_alg *cipher = &tfm->__crt_alg->cra_cipher;\r\nops->cit_setkey = setkey;\r\nops->cit_encrypt_one = crypto_tfm_alg_alignmask(tfm) ?\r\ncipher_encrypt_unaligned : cipher->cia_encrypt;\r\nops->cit_decrypt_one = crypto_tfm_alg_alignmask(tfm) ?\r\ncipher_decrypt_unaligned : cipher->cia_decrypt;\r\nreturn 0;\r\n}\r\nvoid crypto_exit_cipher_ops(struct crypto_tfm *tfm)\r\n{\r\n}

static void variax_activate_async(struct usb_line6_variax *variax, int a)\r\n{\r\nvariax->buffer_activate[VARIAX_OFFSET_ACTIVATE] = a;\r\nline6_send_raw_message_async(&variax->line6, variax->buffer_activate,\r\nsizeof(variax_activate));\r\n}\r\nstatic void variax_startup1(struct usb_line6_variax *variax)\r\n{\r\nCHECK_STARTUP_PROGRESS(variax->startup_progress, VARIAX_STARTUP_INIT);\r\nline6_start_timer(&variax->startup_timer1, VARIAX_STARTUP_DELAY1,\r\nvariax_startup2, (unsigned long)variax);\r\n}\r\nstatic void variax_startup2(unsigned long data)\r\n{\r\nstruct usb_line6_variax *variax = (struct usb_line6_variax *)data;\r\nstruct usb_line6 *line6 = &variax->line6;\r\nif (variax->startup_progress >= VARIAX_STARTUP_LAST)\r\nreturn;\r\nvariax->startup_progress = VARIAX_STARTUP_VERSIONREQ;\r\nline6_start_timer(&variax->startup_timer1, VARIAX_STARTUP_DELAY1,\r\nvariax_startup2, (unsigned long)variax);\r\nline6_version_request_async(line6);\r\n}\r\nstatic void variax_startup3(struct usb_line6_variax *variax)\r\n{\r\nCHECK_STARTUP_PROGRESS(variax->startup_progress, VARIAX_STARTUP_WAIT);\r\nline6_start_timer(&variax->startup_timer2, VARIAX_STARTUP_DELAY3,\r\nvariax_startup4, (unsigned long)variax);\r\n}\r\nstatic void variax_startup4(unsigned long data)\r\n{\r\nstruct usb_line6_variax *variax = (struct usb_line6_variax *)data;\r\nCHECK_STARTUP_PROGRESS(variax->startup_progress,\r\nVARIAX_STARTUP_ACTIVATE);\r\nvariax_activate_async(variax, 1);\r\nline6_start_timer(&variax->startup_timer2, VARIAX_STARTUP_DELAY4,\r\nvariax_startup5, (unsigned long)variax);\r\n}\r\nstatic void variax_startup5(unsigned long data)\r\n{\r\nstruct usb_line6_variax *variax = (struct usb_line6_variax *)data;\r\nCHECK_STARTUP_PROGRESS(variax->startup_progress,\r\nVARIAX_STARTUP_WORKQUEUE);\r\nschedule_work(&variax->startup_work);\r\n}\r\nstatic void variax_startup6(struct work_struct *work)\r\n{\r\nstruct usb_line6_variax *variax =\r\ncontainer_of(work, struct usb_line6_variax, startup_work);\r\nCHECK_STARTUP_PROGRESS(variax->startup_progress, VARIAX_STARTUP_SETUP);\r\nline6_register_audio(&variax->line6);\r\n}\r\nvoid line6_variax_process_message(struct usb_line6_variax *variax)\r\n{\r\nconst unsigned char *buf = variax->line6.buffer_message;\r\nswitch (buf[0]) {\r\ncase LINE6_RESET:\r\ndev_info(variax->line6.ifcdev, "VARIAX reset\n");\r\nbreak;\r\ncase LINE6_SYSEX_BEGIN:\r\nif (memcmp(buf + 1, variax_init_version + 1,\r\nsizeof(variax_init_version) - 1) == 0) {\r\nvariax_startup3(variax);\r\n} else if (memcmp(buf + 1, variax_init_done + 1,\r\nsizeof(variax_init_done) - 1) == 0) {\r\nvariax_startup4((unsigned long)variax);\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic void variax_destruct(struct usb_interface *interface)\r\n{\r\nstruct usb_line6_variax *variax = usb_get_intfdata(interface);\r\nif (variax == NULL)\r\nreturn;\r\nline6_cleanup_audio(&variax->line6);\r\ndel_timer(&variax->startup_timer1);\r\ndel_timer(&variax->startup_timer2);\r\ncancel_work_sync(&variax->startup_work);\r\nkfree(variax->buffer_activate);\r\n}\r\nstatic int variax_try_init(struct usb_interface *interface,\r\nstruct usb_line6_variax *variax)\r\n{\r\nint err;\r\ninit_timer(&variax->startup_timer1);\r\ninit_timer(&variax->startup_timer2);\r\nINIT_WORK(&variax->startup_work, variax_startup6);\r\nif ((interface == NULL) || (variax == NULL))\r\nreturn -ENODEV;\r\nvariax->buffer_activate = kmemdup(variax_activate,\r\nsizeof(variax_activate), GFP_KERNEL);\r\nif (variax->buffer_activate == NULL) {\r\ndev_err(&interface->dev, "Out of memory\n");\r\nreturn -ENOMEM;\r\n}\r\nerr = line6_init_audio(&variax->line6);\r\nif (err < 0)\r\nreturn err;\r\nerr = line6_init_midi(&variax->line6);\r\nif (err < 0)\r\nreturn err;\r\nvariax_startup1(variax);\r\nreturn 0;\r\n}\r\nint line6_variax_init(struct usb_interface *interface,\r\nstruct usb_line6_variax *variax)\r\n{\r\nint err = variax_try_init(interface, variax);\r\nif (err < 0)\r\nvariax_destruct(interface);\r\nreturn err;\r\n}\r\nvoid line6_variax_disconnect(struct usb_interface *interface)\r\n{\r\nif (interface == NULL)\r\nreturn;\r\nvariax_destruct(interface);\r\n}

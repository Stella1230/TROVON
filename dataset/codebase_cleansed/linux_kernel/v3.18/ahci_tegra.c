static int tegra_ahci_power_on(struct ahci_host_priv *hpriv)\r\n{\r\nstruct tegra_ahci_priv *tegra = hpriv->plat_data;\r\nint ret;\r\nret = regulator_bulk_enable(ARRAY_SIZE(tegra->supplies),\r\ntegra->supplies);\r\nif (ret)\r\nreturn ret;\r\nret = tegra_powergate_sequence_power_up(TEGRA_POWERGATE_SATA,\r\ntegra->sata_clk,\r\ntegra->sata_rst);\r\nif (ret)\r\ngoto disable_regulators;\r\nreset_control_assert(tegra->sata_oob_rst);\r\nreset_control_assert(tegra->sata_cold_rst);\r\nret = ahci_platform_enable_resources(hpriv);\r\nif (ret)\r\ngoto disable_power;\r\nreset_control_deassert(tegra->sata_cold_rst);\r\nreset_control_deassert(tegra->sata_oob_rst);\r\nreturn 0;\r\ndisable_power:\r\nclk_disable_unprepare(tegra->sata_clk);\r\ntegra_powergate_power_off(TEGRA_POWERGATE_SATA);\r\ndisable_regulators:\r\nregulator_bulk_disable(ARRAY_SIZE(tegra->supplies), tegra->supplies);\r\nreturn ret;\r\n}\r\nstatic void tegra_ahci_power_off(struct ahci_host_priv *hpriv)\r\n{\r\nstruct tegra_ahci_priv *tegra = hpriv->plat_data;\r\nahci_platform_disable_resources(hpriv);\r\nreset_control_assert(tegra->sata_rst);\r\nreset_control_assert(tegra->sata_oob_rst);\r\nreset_control_assert(tegra->sata_cold_rst);\r\nclk_disable_unprepare(tegra->sata_clk);\r\ntegra_powergate_power_off(TEGRA_POWERGATE_SATA);\r\nregulator_bulk_disable(ARRAY_SIZE(tegra->supplies), tegra->supplies);\r\n}\r\nstatic int tegra_ahci_controller_init(struct ahci_host_priv *hpriv)\r\n{\r\nstruct tegra_ahci_priv *tegra = hpriv->plat_data;\r\nint ret;\r\nunsigned int val;\r\nstruct sata_pad_calibration calib;\r\nret = tegra_ahci_power_on(hpriv);\r\nif (ret) {\r\ndev_err(&tegra->pdev->dev,\r\n"failed to power on AHCI controller: %d\n", ret);\r\nreturn ret;\r\n}\r\nval = readl(tegra->sata_regs + SATA_CONFIGURATION_0);\r\nval |= SATA_CONFIGURATION_EN_FPCI;\r\nwritel(val, tegra->sata_regs + SATA_CONFIGURATION_0);\r\nret = tegra_fuse_readl(FUSE_SATA_CALIB, &val);\r\nif (ret) {\r\ndev_err(&tegra->pdev->dev,\r\n"failed to read calibration fuse: %d\n", ret);\r\nreturn ret;\r\n}\r\ncalib = tegra124_pad_calibration[val & FUSE_SATA_CALIB_MASK];\r\nwritel(BIT(0), tegra->sata_regs + SCFG_OFFSET + T_SATA0_INDEX);\r\nval = readl(tegra->sata_regs +\r\nSCFG_OFFSET + T_SATA0_CHX_PHY_CTRL1_GEN1);\r\nval &= ~T_SATA0_CHX_PHY_CTRL1_GEN1_TX_AMP_MASK;\r\nval &= ~T_SATA0_CHX_PHY_CTRL1_GEN1_TX_PEAK_MASK;\r\nval |= calib.gen1_tx_amp <<\r\nT_SATA0_CHX_PHY_CTRL1_GEN1_TX_AMP_SHIFT;\r\nval |= calib.gen1_tx_peak <<\r\nT_SATA0_CHX_PHY_CTRL1_GEN1_TX_PEAK_SHIFT;\r\nwritel(val, tegra->sata_regs + SCFG_OFFSET +\r\nT_SATA0_CHX_PHY_CTRL1_GEN1);\r\nval = readl(tegra->sata_regs +\r\nSCFG_OFFSET + T_SATA0_CHX_PHY_CTRL1_GEN2);\r\nval &= ~T_SATA0_CHX_PHY_CTRL1_GEN2_TX_AMP_MASK;\r\nval &= ~T_SATA0_CHX_PHY_CTRL1_GEN2_TX_PEAK_MASK;\r\nval |= calib.gen2_tx_amp <<\r\nT_SATA0_CHX_PHY_CTRL1_GEN1_TX_AMP_SHIFT;\r\nval |= calib.gen2_tx_peak <<\r\nT_SATA0_CHX_PHY_CTRL1_GEN1_TX_PEAK_SHIFT;\r\nwritel(val, tegra->sata_regs + SCFG_OFFSET +\r\nT_SATA0_CHX_PHY_CTRL1_GEN2);\r\nwritel(T_SATA0_CHX_PHY_CTRL11_GEN2_RX_EQ,\r\ntegra->sata_regs + SCFG_OFFSET + T_SATA0_CHX_PHY_CTRL11);\r\nwritel(T_SATA0_CHX_PHY_CTRL2_CDR_CNTL_GEN1,\r\ntegra->sata_regs + SCFG_OFFSET + T_SATA0_CHX_PHY_CTRL2);\r\nwritel(0, tegra->sata_regs + SCFG_OFFSET + T_SATA0_INDEX);\r\nval = readl(tegra->sata_regs + SCFG_OFFSET + T_SATA0_CFG_SATA);\r\nval |= T_SATA0_CFG_SATA_BACKDOOR_PROG_IF_EN;\r\nwritel(val, tegra->sata_regs + SCFG_OFFSET + T_SATA0_CFG_SATA);\r\nwritel(0x01060100, tegra->sata_regs + SCFG_OFFSET + T_SATA0_BKDOOR_CC);\r\nval = readl(tegra->sata_regs + SCFG_OFFSET + T_SATA0_CFG_SATA);\r\nval &= ~T_SATA0_CFG_SATA_BACKDOOR_PROG_IF_EN;\r\nwritel(val, tegra->sata_regs + SCFG_OFFSET + T_SATA0_CFG_SATA);\r\nval = readl(tegra->sata_regs + SCFG_OFFSET + T_SATA0_CFG_1);\r\nval |= T_SATA0_CFG_1_IO_SPACE | T_SATA0_CFG_1_MEMORY_SPACE |\r\nT_SATA0_CFG_1_BUS_MASTER | T_SATA0_CFG_1_SERR;\r\nwritel(val, tegra->sata_regs + SCFG_OFFSET + T_SATA0_CFG_1);\r\nwritel(0x10000 << SATA_FPCI_BAR5_START_SHIFT,\r\ntegra->sata_regs + SATA_FPCI_BAR5);\r\nwritel(0x08000 << T_SATA0_CFG_9_BASE_ADDRESS_SHIFT,\r\ntegra->sata_regs + SCFG_OFFSET + T_SATA0_CFG_9);\r\nval = readl(tegra->sata_regs + SATA_INTR_MASK);\r\nval |= SATA_INTR_MASK_IP_INT_MASK;\r\nwritel(val, tegra->sata_regs + SATA_INTR_MASK);\r\nreturn 0;\r\n}\r\nstatic void tegra_ahci_controller_deinit(struct ahci_host_priv *hpriv)\r\n{\r\ntegra_ahci_power_off(hpriv);\r\n}\r\nstatic void tegra_ahci_host_stop(struct ata_host *host)\r\n{\r\nstruct ahci_host_priv *hpriv = host->private_data;\r\ntegra_ahci_controller_deinit(hpriv);\r\n}\r\nstatic int tegra_ahci_probe(struct platform_device *pdev)\r\n{\r\nstruct ahci_host_priv *hpriv;\r\nstruct tegra_ahci_priv *tegra;\r\nstruct resource *res;\r\nint ret;\r\nhpriv = ahci_platform_get_resources(pdev);\r\nif (IS_ERR(hpriv))\r\nreturn PTR_ERR(hpriv);\r\ntegra = devm_kzalloc(&pdev->dev, sizeof(*tegra), GFP_KERNEL);\r\nif (!tegra)\r\nreturn -ENOMEM;\r\nhpriv->plat_data = tegra;\r\ntegra->pdev = pdev;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\ntegra->sata_regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(tegra->sata_regs))\r\nreturn PTR_ERR(tegra->sata_regs);\r\ntegra->sata_rst = devm_reset_control_get(&pdev->dev, "sata");\r\nif (IS_ERR(tegra->sata_rst)) {\r\ndev_err(&pdev->dev, "Failed to get sata reset\n");\r\nreturn PTR_ERR(tegra->sata_rst);\r\n}\r\ntegra->sata_oob_rst = devm_reset_control_get(&pdev->dev, "sata-oob");\r\nif (IS_ERR(tegra->sata_oob_rst)) {\r\ndev_err(&pdev->dev, "Failed to get sata-oob reset\n");\r\nreturn PTR_ERR(tegra->sata_oob_rst);\r\n}\r\ntegra->sata_cold_rst = devm_reset_control_get(&pdev->dev, "sata-cold");\r\nif (IS_ERR(tegra->sata_cold_rst)) {\r\ndev_err(&pdev->dev, "Failed to get sata-cold reset\n");\r\nreturn PTR_ERR(tegra->sata_cold_rst);\r\n}\r\ntegra->sata_clk = devm_clk_get(&pdev->dev, "sata");\r\nif (IS_ERR(tegra->sata_clk)) {\r\ndev_err(&pdev->dev, "Failed to get sata clock\n");\r\nreturn PTR_ERR(tegra->sata_clk);\r\n}\r\ntegra->supplies[0].supply = "avdd";\r\ntegra->supplies[1].supply = "hvdd";\r\ntegra->supplies[2].supply = "vddio";\r\ntegra->supplies[3].supply = "target-5v";\r\ntegra->supplies[4].supply = "target-12v";\r\nret = devm_regulator_bulk_get(&pdev->dev, ARRAY_SIZE(tegra->supplies),\r\ntegra->supplies);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to get regulators\n");\r\nreturn ret;\r\n}\r\nret = tegra_ahci_controller_init(hpriv);\r\nif (ret)\r\nreturn ret;\r\nret = ahci_platform_init_host(pdev, hpriv, &ahci_tegra_port_info);\r\nif (ret)\r\ngoto deinit_controller;\r\nreturn 0;\r\ndeinit_controller:\r\ntegra_ahci_controller_deinit(hpriv);\r\nreturn ret;\r\n}

unsigned char vrtc_cmos_read(unsigned char reg)\r\n{\r\nunsigned char retval;\r\nif (reg > 0xd || !vrtc_virt_base)\r\nreturn 0xff;\r\nlock_cmos_prefix(reg);\r\nretval = __raw_readb(vrtc_virt_base + (reg << 2));\r\nlock_cmos_suffix(reg);\r\nreturn retval;\r\n}\r\nvoid vrtc_cmos_write(unsigned char val, unsigned char reg)\r\n{\r\nif (reg > 0xd || !vrtc_virt_base)\r\nreturn;\r\nlock_cmos_prefix(reg);\r\n__raw_writeb(val, vrtc_virt_base + (reg << 2));\r\nlock_cmos_suffix(reg);\r\n}\r\nvoid vrtc_get_time(struct timespec *now)\r\n{\r\nu8 sec, min, hour, mday, mon;\r\nunsigned long flags;\r\nu32 year;\r\nspin_lock_irqsave(&rtc_lock, flags);\r\nwhile ((vrtc_cmos_read(RTC_FREQ_SELECT) & RTC_UIP))\r\ncpu_relax();\r\nsec = vrtc_cmos_read(RTC_SECONDS);\r\nmin = vrtc_cmos_read(RTC_MINUTES);\r\nhour = vrtc_cmos_read(RTC_HOURS);\r\nmday = vrtc_cmos_read(RTC_DAY_OF_MONTH);\r\nmon = vrtc_cmos_read(RTC_MONTH);\r\nyear = vrtc_cmos_read(RTC_YEAR);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nyear += 1972;\r\npr_info("vRTC: sec: %d min: %d hour: %d day: %d "\r\n"mon: %d year: %d\n", sec, min, hour, mday, mon, year);\r\nnow->tv_sec = mktime(year, mon, mday, hour, min, sec);\r\nnow->tv_nsec = 0;\r\n}\r\nint vrtc_set_mmss(const struct timespec *now)\r\n{\r\nunsigned long flags;\r\nstruct rtc_time tm;\r\nint year;\r\nint retval = 0;\r\nrtc_time_to_tm(now->tv_sec, &tm);\r\nif (!rtc_valid_tm(&tm) && tm.tm_year >= 72) {\r\nyear = tm.tm_year - 72;\r\nspin_lock_irqsave(&rtc_lock, flags);\r\nvrtc_cmos_write(year, RTC_YEAR);\r\nvrtc_cmos_write(tm.tm_mon, RTC_MONTH);\r\nvrtc_cmos_write(tm.tm_mday, RTC_DAY_OF_MONTH);\r\nvrtc_cmos_write(tm.tm_hour, RTC_HOURS);\r\nvrtc_cmos_write(tm.tm_min, RTC_MINUTES);\r\nvrtc_cmos_write(tm.tm_sec, RTC_SECONDS);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\n} else {\r\npr_err("%s: Invalid vRTC value: write of %lx to vRTC failed\n",\r\n__FUNCTION__, now->tv_sec);\r\nretval = -EINVAL;\r\n}\r\nreturn retval;\r\n}\r\nvoid __init intel_mid_rtc_init(void)\r\n{\r\nunsigned long vrtc_paddr;\r\nsfi_table_parse(SFI_SIG_MRTC, NULL, NULL, sfi_parse_mrtc);\r\nvrtc_paddr = sfi_mrtc_array[0].phys_addr;\r\nif (!sfi_mrtc_num || !vrtc_paddr)\r\nreturn;\r\nvrtc_virt_base = (void __iomem *)set_fixmap_offset_nocache(FIX_LNW_VRTC,\r\nvrtc_paddr);\r\nx86_platform.get_wallclock = vrtc_get_time;\r\nx86_platform.set_wallclock = vrtc_set_mmss;\r\n}\r\nstatic int __init intel_mid_device_create(void)\r\n{\r\nif (!intel_mid_identify_cpu())\r\nreturn -ENODEV;\r\nif (!sfi_mrtc_num)\r\nreturn -ENODEV;\r\nvrtc_resources[0].start = sfi_mrtc_array[0].phys_addr;\r\nvrtc_resources[0].end = sfi_mrtc_array[0].phys_addr +\r\nMRST_VRTC_MAP_SZ;\r\nvrtc_resources[1].start = sfi_mrtc_array[0].irq;\r\nvrtc_resources[1].end = sfi_mrtc_array[0].irq;\r\nreturn platform_device_register(&vrtc_device);\r\n}

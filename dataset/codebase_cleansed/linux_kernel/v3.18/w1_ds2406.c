static ssize_t w1_f12_read_state(\r\nstruct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nu8 w1_buf[6]={W1_F12_FUNC_READ_STATUS, 7, 0, 0, 0, 0};\r\nstruct w1_slave *sl = kobj_to_w1_slave(kobj);\r\nu16 crc=0;\r\nint i;\r\nssize_t rtnval=1;\r\nif (off != 0)\r\nreturn 0;\r\nif (!buf)\r\nreturn -EINVAL;\r\nmutex_lock(&sl->master->bus_mutex);\r\nif (w1_reset_select_slave(sl)) {\r\nmutex_unlock(&sl->master->bus_mutex);\r\nreturn -EIO;\r\n}\r\nw1_write_block(sl->master, w1_buf, 3);\r\nw1_read_block(sl->master, w1_buf+3, 3);\r\nfor (i=0; i<6; i++)\r\ncrc=crc16_byte(crc, w1_buf[i]);\r\nif (crc==0xb001)\r\n*buf=((w1_buf[3]>>5)&3)|0x30;\r\nelse\r\nrtnval=-EIO;\r\nmutex_unlock(&sl->master->bus_mutex);\r\nreturn rtnval;\r\n}\r\nstatic ssize_t w1_f12_write_output(\r\nstruct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nstruct w1_slave *sl = kobj_to_w1_slave(kobj);\r\nu8 w1_buf[6]={W1_F12_FUNC_WRITE_STATUS, 7, 0, 0, 0, 0};\r\nu16 crc=0;\r\nint i;\r\nssize_t rtnval=1;\r\nif (count != 1 || off != 0)\r\nreturn -EFAULT;\r\nmutex_lock(&sl->master->bus_mutex);\r\nif (w1_reset_select_slave(sl)) {\r\nmutex_unlock(&sl->master->bus_mutex);\r\nreturn -EIO;\r\n}\r\nw1_buf[3] = (((*buf)&3)<<5)|0x1F;\r\nw1_write_block(sl->master, w1_buf, 4);\r\nw1_read_block(sl->master, w1_buf+4, 2);\r\nfor (i=0; i<6; i++)\r\ncrc=crc16_byte(crc, w1_buf[i]);\r\nif (crc==0xb001)\r\nw1_write_8(sl->master, 0xFF);\r\nelse\r\nrtnval=-EIO;\r\nmutex_unlock(&sl->master->bus_mutex);\r\nreturn rtnval;\r\n}\r\nstatic int w1_f12_add_slave(struct w1_slave *sl)\r\n{\r\nint err = 0;\r\nint i;\r\nfor (i = 0; i < NB_SYSFS_BIN_FILES && !err; ++i)\r\nerr = sysfs_create_bin_file(\r\n&sl->dev.kobj,\r\n&(w1_f12_sysfs_bin_files[i]));\r\nif (err)\r\nwhile (--i >= 0)\r\nsysfs_remove_bin_file(&sl->dev.kobj,\r\n&(w1_f12_sysfs_bin_files[i]));\r\nreturn err;\r\n}\r\nstatic void w1_f12_remove_slave(struct w1_slave *sl)\r\n{\r\nint i;\r\nfor (i = NB_SYSFS_BIN_FILES - 1; i >= 0; --i)\r\nsysfs_remove_bin_file(&sl->dev.kobj,\r\n&(w1_f12_sysfs_bin_files[i]));\r\n}\r\nstatic int __init w1_f12_init(void)\r\n{\r\nreturn w1_register_family(&w1_family_12);\r\n}\r\nstatic void __exit w1_f12_exit(void)\r\n{\r\nw1_unregister_family(&w1_family_12);\r\n}

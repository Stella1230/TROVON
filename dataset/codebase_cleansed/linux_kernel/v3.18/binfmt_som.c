static void create_som_tables(struct linux_binprm *bprm)\r\n{\r\nchar **argv, **envp;\r\nint argc = bprm->argc;\r\nint envc = bprm->envc;\r\nunsigned long p;\r\nunsigned long *sp;\r\nsp = (unsigned long *)((bprm->p + 3) & ~3);\r\nenvp = (char **) sp;\r\nsp += envc + 1;\r\nargv = (char **) sp;\r\nsp += argc + 1;\r\n__put_user((unsigned long) envp,++sp);\r\n__put_user((unsigned long) argv,++sp);\r\n__put_user(argc, ++sp);\r\nbprm->p = (unsigned long) sp;\r\np = current->mm->arg_start;\r\nwhile (argc-- > 0) {\r\n__put_user((char *)p,argv++);\r\np += strlen_user((char *)p);\r\n}\r\n__put_user(NULL, argv);\r\ncurrent->mm->arg_end = current->mm->env_start = p;\r\nwhile (envc-- > 0) {\r\n__put_user((char *)p,envp++);\r\np += strlen_user((char *)p);\r\n}\r\n__put_user(NULL, envp);\r\ncurrent->mm->env_end = p;\r\n}\r\nstatic int check_som_header(struct som_hdr *som_ex)\r\n{\r\nint *buf = (int *)som_ex;\r\nint i, ck;\r\nif (som_ex->system_id != SOM_SID_PARISC_1_0 &&\r\nsom_ex->system_id != SOM_SID_PARISC_1_1 &&\r\nsom_ex->system_id != SOM_SID_PARISC_2_0)\r\nreturn -ENOEXEC;\r\nif (som_ex->a_magic != SOM_EXEC_NONSHARE &&\r\nsom_ex->a_magic != SOM_EXEC_SHARE &&\r\nsom_ex->a_magic != SOM_EXEC_DEMAND)\r\nreturn -ENOEXEC;\r\nif (som_ex->version_id != SOM_ID_OLD &&\r\nsom_ex->version_id != SOM_ID_NEW)\r\nreturn -ENOEXEC;\r\nck = 0;\r\nfor (i=0; i<32; i++)\r\nck ^= buf[i];\r\nif (ck != 0)\r\nreturn -ENOEXEC;\r\nreturn 0;\r\n}\r\nstatic int map_som_binary(struct file *file,\r\nconst struct som_exec_auxhdr *hpuxhdr)\r\n{\r\nunsigned long code_start, code_size, data_start, data_size;\r\nunsigned long bss_start, som_brk;\r\nint retval;\r\nint prot = PROT_READ | PROT_EXEC;\r\nint flags = MAP_FIXED|MAP_PRIVATE|MAP_DENYWRITE|MAP_EXECUTABLE;\r\nmm_segment_t old_fs = get_fs();\r\nset_fs(get_ds());\r\ncode_start = SOM_PAGESTART(hpuxhdr->exec_tmem);\r\ncode_size = SOM_PAGEALIGN(hpuxhdr->exec_tsize);\r\ncurrent->mm->start_code = code_start;\r\ncurrent->mm->end_code = code_start + code_size;\r\nretval = vm_mmap(file, code_start, code_size, prot,\r\nflags, SOM_PAGESTART(hpuxhdr->exec_tfile));\r\nif (retval < 0 && retval > -1024)\r\ngoto out;\r\ndata_start = SOM_PAGESTART(hpuxhdr->exec_dmem);\r\ndata_size = SOM_PAGEALIGN(hpuxhdr->exec_dsize);\r\ncurrent->mm->start_data = data_start;\r\ncurrent->mm->end_data = bss_start = data_start + data_size;\r\nretval = vm_mmap(file, data_start, data_size,\r\nprot | PROT_WRITE, flags,\r\nSOM_PAGESTART(hpuxhdr->exec_dfile));\r\nif (retval < 0 && retval > -1024)\r\ngoto out;\r\nsom_brk = bss_start + SOM_PAGEALIGN(hpuxhdr->exec_bsize);\r\ncurrent->mm->start_brk = current->mm->brk = som_brk;\r\nretval = vm_mmap(NULL, bss_start, som_brk - bss_start,\r\nprot | PROT_WRITE, MAP_FIXED | MAP_PRIVATE, 0);\r\nif (retval > 0 || retval < -1024)\r\nretval = 0;\r\nout:\r\nset_fs(old_fs);\r\nreturn retval;\r\n}\r\nstatic int\r\nload_som_binary(struct linux_binprm * bprm)\r\n{\r\nint retval;\r\nunsigned int size;\r\nunsigned long som_entry;\r\nstruct som_hdr *som_ex;\r\nstruct som_exec_auxhdr *hpuxhdr;\r\nstruct pt_regs *regs = current_pt_regs();\r\nsom_ex = (struct som_hdr *) bprm->buf;\r\nretval = check_som_header(som_ex);\r\nif (retval != 0)\r\ngoto out;\r\nretval = -ENOMEM;\r\nsize = som_ex->aux_header_size;\r\nif (size > SOM_PAGESIZE)\r\ngoto out;\r\nhpuxhdr = kmalloc(size, GFP_KERNEL);\r\nif (!hpuxhdr)\r\ngoto out;\r\nretval = kernel_read(bprm->file, som_ex->aux_header_location,\r\n(char *) hpuxhdr, size);\r\nif (retval != size) {\r\nif (retval >= 0)\r\nretval = -EIO;\r\ngoto out_free;\r\n}\r\nretval = flush_old_exec(bprm);\r\nif (retval)\r\ngoto out_free;\r\ncurrent->personality = PER_HPUX;\r\nsetup_new_exec(bprm);\r\ncurrent->thread.task_size = 0xc0000000;\r\ncurrent->thread.map_base = 0x80000000;\r\nretval = map_som_binary(bprm->file, hpuxhdr);\r\nif (retval < 0)\r\ngoto out_free;\r\nsom_entry = hpuxhdr->exec_entry;\r\nkfree(hpuxhdr);\r\nset_binfmt(&som_format);\r\ninstall_exec_creds(bprm);\r\nsetup_arg_pages(bprm, STACK_TOP, EXSTACK_DEFAULT);\r\ncreate_som_tables(bprm);\r\ncurrent->mm->start_stack = bprm->p;\r\n#if 0\r\nprintk("(start_brk) %08lx\n" , (unsigned long) current->mm->start_brk);\r\nprintk("(end_code) %08lx\n" , (unsigned long) current->mm->end_code);\r\nprintk("(start_code) %08lx\n" , (unsigned long) current->mm->start_code);\r\nprintk("(end_data) %08lx\n" , (unsigned long) current->mm->end_data);\r\nprintk("(start_stack) %08lx\n" , (unsigned long) current->mm->start_stack);\r\nprintk("(brk) %08lx\n" , (unsigned long) current->mm->brk);\r\n#endif\r\nmap_hpux_gateway_page(current,current->mm);\r\nstart_thread_som(regs, som_entry, bprm->p);\r\nreturn 0;\r\nout_free:\r\nkfree(hpuxhdr);\r\nout:\r\nreturn retval;\r\n}\r\nstatic int load_som_library(struct file *f)\r\n{\r\nreturn -ENOEXEC;\r\n}\r\nstatic int __init init_som_binfmt(void)\r\n{\r\nregister_binfmt(&som_format);\r\nreturn 0;\r\n}\r\nstatic void __exit exit_som_binfmt(void)\r\n{\r\nunregister_binfmt(&som_format);\r\n}

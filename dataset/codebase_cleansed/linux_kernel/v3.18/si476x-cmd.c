static int si476x_core_parse_and_nag_about_error(struct si476x_core *core)\r\n{\r\nint err;\r\nchar *cause;\r\nu8 buffer[2];\r\nif (core->revision != SI476X_REVISION_A10) {\r\nerr = si476x_core_i2c_xfer(core, SI476X_I2C_RECV,\r\nbuffer, sizeof(buffer));\r\nif (err == sizeof(buffer)) {\r\nswitch (buffer[1]) {\r\ncase SI476X_ERR_BAD_COMMAND:\r\ncause = "Bad command";\r\nerr = -EINVAL;\r\nbreak;\r\ncase SI476X_ERR_BAD_ARG1:\r\ncause = "Bad argument #1";\r\nerr = -EINVAL;\r\nbreak;\r\ncase SI476X_ERR_BAD_ARG2:\r\ncause = "Bad argument #2";\r\nerr = -EINVAL;\r\nbreak;\r\ncase SI476X_ERR_BAD_ARG3:\r\ncause = "Bad argument #3";\r\nerr = -EINVAL;\r\nbreak;\r\ncase SI476X_ERR_BAD_ARG4:\r\ncause = "Bad argument #4";\r\nerr = -EINVAL;\r\nbreak;\r\ncase SI476X_ERR_BUSY:\r\ncause = "Chip is busy";\r\nerr = -EBUSY;\r\nbreak;\r\ncase SI476X_ERR_BAD_INTERNAL_MEMORY:\r\ncause = "Bad internal memory";\r\nerr = -EIO;\r\nbreak;\r\ncase SI476X_ERR_BAD_PATCH:\r\ncause = "Bad patch";\r\nerr = -EINVAL;\r\nbreak;\r\ncase SI476X_ERR_BAD_BOOT_MODE:\r\ncause = "Bad boot mode";\r\nerr = -EINVAL;\r\nbreak;\r\ncase SI476X_ERR_BAD_PROPERTY:\r\ncause = "Bad property";\r\nerr = -EINVAL;\r\nbreak;\r\ndefault:\r\ncause = "Unknown";\r\nerr = -EIO;\r\n}\r\ndev_err(&core->client->dev,\r\n"[Chip error status]: %s\n", cause);\r\n} else {\r\ndev_err(&core->client->dev,\r\n"Failed to fetch error code\n");\r\nerr = (err >= 0) ? -EIO : err;\r\n}\r\n} else {\r\nerr = -EIO;\r\n}\r\nreturn err;\r\n}\r\nstatic int si476x_core_send_command(struct si476x_core *core,\r\nconst u8 command,\r\nconst u8 args[],\r\nconst int argn,\r\nu8 resp[],\r\nconst int respn,\r\nconst int usecs)\r\n{\r\nstruct i2c_client *client = core->client;\r\nint err;\r\nu8 data[CMD_MAX_ARGS_COUNT + 1];\r\nif (argn > CMD_MAX_ARGS_COUNT) {\r\nerr = -ENOMEM;\r\ngoto exit;\r\n}\r\nif (!client->adapter) {\r\nerr = -ENODEV;\r\ngoto exit;\r\n}\r\ndata[0] = command;\r\nmemcpy(&data[1], args, argn);\r\ndev_dbg(&client->dev, "Command:\n %*ph\n", argn + 1, data);\r\nerr = si476x_core_i2c_xfer(core, SI476X_I2C_SEND,\r\n(char *) data, argn + 1);\r\nif (err != argn + 1) {\r\ndev_err(&core->client->dev,\r\n"Error while sending command 0x%02x\n",\r\ncommand);\r\nerr = (err >= 0) ? -EIO : err;\r\ngoto exit;\r\n}\r\natomic_set(&core->cts, 0);\r\nif (!wait_event_timeout(core->command,\r\natomic_read(&core->cts),\r\nusecs_to_jiffies(usecs) + 1))\r\ndev_warn(&core->client->dev,\r\n"(%s) [CMD 0x%02x] Answer timeout.\n",\r\n__func__, command);\r\nif (unlikely(!core->client->irq && command == CMD_POWER_UP)) {\r\nif (!wait_event_timeout(core->command,\r\natomic_read(&core->cts),\r\nusecs_to_jiffies(usecs) + 1))\r\ndev_warn(&core->client->dev,\r\n"(%s) Power up took too much time.\n",\r\n__func__);\r\n}\r\nerr = si476x_core_i2c_xfer(core, SI476X_I2C_RECV, resp, respn);\r\nif (err != respn) {\r\ndev_err(&core->client->dev,\r\n"Error while reading response for command 0x%02x\n",\r\ncommand);\r\nerr = (err >= 0) ? -EIO : err;\r\ngoto exit;\r\n}\r\ndev_dbg(&client->dev, "Response:\n %*ph\n", respn, resp);\r\nerr = 0;\r\nif (resp[0] & SI476X_ERR) {\r\ndev_err(&core->client->dev,\r\n"[CMD 0x%02x] Chip set error flag\n", command);\r\nerr = si476x_core_parse_and_nag_about_error(core);\r\ngoto exit;\r\n}\r\nif (!(resp[0] & SI476X_CTS))\r\nerr = -EBUSY;\r\nexit:\r\nreturn err;\r\n}\r\nstatic int si476x_cmd_clear_stc(struct si476x_core *core)\r\n{\r\nint err;\r\nstruct si476x_rsq_status_args args = {\r\n.primary = false,\r\n.rsqack = false,\r\n.attune = false,\r\n.cancel = false,\r\n.stcack = true,\r\n};\r\nswitch (core->power_up_parameters.func) {\r\ncase SI476X_FUNC_FM_RECEIVER:\r\nerr = si476x_core_cmd_fm_rsq_status(core, &args, NULL);\r\nbreak;\r\ncase SI476X_FUNC_AM_RECEIVER:\r\nerr = si476x_core_cmd_am_rsq_status(core, &args, NULL);\r\nbreak;\r\ndefault:\r\nerr = -EINVAL;\r\n}\r\nreturn err;\r\n}\r\nstatic int si476x_cmd_tune_seek_freq(struct si476x_core *core,\r\nuint8_t cmd,\r\nconst uint8_t args[], size_t argn,\r\nuint8_t *resp, size_t respn)\r\n{\r\nint err;\r\natomic_set(&core->stc, 0);\r\nerr = si476x_core_send_command(core, cmd, args, argn, resp, respn,\r\nSI476X_TIMEOUT_TUNE);\r\nif (!err) {\r\nwait_event_killable(core->tuning,\r\natomic_read(&core->stc));\r\nsi476x_cmd_clear_stc(core);\r\n}\r\nreturn err;\r\n}\r\nint si476x_core_cmd_func_info(struct si476x_core *core,\r\nstruct si476x_func_info *info)\r\n{\r\nint err;\r\nu8 resp[CMD_FUNC_INFO_NRESP];\r\nerr = si476x_core_send_command(core, CMD_FUNC_INFO,\r\nNULL, 0,\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\ninfo->firmware.major = resp[1];\r\ninfo->firmware.minor[0] = resp[2];\r\ninfo->firmware.minor[1] = resp[3];\r\ninfo->patch_id = ((u16) resp[4] << 8) | resp[5];\r\ninfo->func = resp[6];\r\nreturn err;\r\n}\r\nint si476x_core_cmd_set_property(struct si476x_core *core,\r\nu16 property, u16 value)\r\n{\r\nu8 resp[CMD_SET_PROPERTY_NRESP];\r\nconst u8 args[CMD_SET_PROPERTY_NARGS] = {\r\n0x00,\r\nmsb(property),\r\nlsb(property),\r\nmsb(value),\r\nlsb(value),\r\n};\r\nreturn si476x_core_send_command(core, CMD_SET_PROPERTY,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\n}\r\nint si476x_core_cmd_get_property(struct si476x_core *core, u16 property)\r\n{\r\nint err;\r\nu8 resp[CMD_GET_PROPERTY_NRESP];\r\nconst u8 args[CMD_GET_PROPERTY_NARGS] = {\r\n0x00,\r\nmsb(property),\r\nlsb(property),\r\n};\r\nerr = si476x_core_send_command(core, CMD_GET_PROPERTY,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\nif (err < 0)\r\nreturn err;\r\nelse\r\nreturn get_unaligned_be16(resp + 2);\r\n}\r\nint si476x_core_cmd_dig_audio_pin_cfg(struct si476x_core *core,\r\nenum si476x_dclk_config dclk,\r\nenum si476x_dfs_config dfs,\r\nenum si476x_dout_config dout,\r\nenum si476x_xout_config xout)\r\n{\r\nu8 resp[CMD_DIG_AUDIO_PIN_CFG_NRESP];\r\nconst u8 args[CMD_DIG_AUDIO_PIN_CFG_NARGS] = {\r\nPIN_CFG_BYTE(dclk),\r\nPIN_CFG_BYTE(dfs),\r\nPIN_CFG_BYTE(dout),\r\nPIN_CFG_BYTE(xout),\r\n};\r\nreturn si476x_core_send_command(core, CMD_DIG_AUDIO_PIN_CFG,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\n}\r\nint si476x_core_cmd_zif_pin_cfg(struct si476x_core *core,\r\nenum si476x_iqclk_config iqclk,\r\nenum si476x_iqfs_config iqfs,\r\nenum si476x_iout_config iout,\r\nenum si476x_qout_config qout)\r\n{\r\nu8 resp[CMD_ZIF_PIN_CFG_NRESP];\r\nconst u8 args[CMD_ZIF_PIN_CFG_NARGS] = {\r\nPIN_CFG_BYTE(iqclk),\r\nPIN_CFG_BYTE(iqfs),\r\nPIN_CFG_BYTE(iout),\r\nPIN_CFG_BYTE(qout),\r\n};\r\nreturn si476x_core_send_command(core, CMD_ZIF_PIN_CFG,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\n}\r\nint si476x_core_cmd_ic_link_gpo_ctl_pin_cfg(struct si476x_core *core,\r\nenum si476x_icin_config icin,\r\nenum si476x_icip_config icip,\r\nenum si476x_icon_config icon,\r\nenum si476x_icop_config icop)\r\n{\r\nu8 resp[CMD_IC_LINK_GPO_CTL_PIN_CFG_NRESP];\r\nconst u8 args[CMD_IC_LINK_GPO_CTL_PIN_CFG_NARGS] = {\r\nPIN_CFG_BYTE(icin),\r\nPIN_CFG_BYTE(icip),\r\nPIN_CFG_BYTE(icon),\r\nPIN_CFG_BYTE(icop),\r\n};\r\nreturn si476x_core_send_command(core, CMD_IC_LINK_GPO_CTL_PIN_CFG,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\n}\r\nint si476x_core_cmd_ana_audio_pin_cfg(struct si476x_core *core,\r\nenum si476x_lrout_config lrout)\r\n{\r\nu8 resp[CMD_ANA_AUDIO_PIN_CFG_NRESP];\r\nconst u8 args[CMD_ANA_AUDIO_PIN_CFG_NARGS] = {\r\nPIN_CFG_BYTE(lrout),\r\n};\r\nreturn si476x_core_send_command(core, CMD_ANA_AUDIO_PIN_CFG,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\n}\r\nstatic int si476x_core_cmd_intb_pin_cfg_a10(struct si476x_core *core,\r\nenum si476x_intb_config intb,\r\nenum si476x_a1_config a1)\r\n{\r\nu8 resp[CMD_INTB_PIN_CFG_A10_NRESP];\r\nconst u8 args[CMD_INTB_PIN_CFG_NARGS] = {\r\nPIN_CFG_BYTE(intb),\r\nPIN_CFG_BYTE(a1),\r\n};\r\nreturn si476x_core_send_command(core, CMD_INTB_PIN_CFG,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\n}\r\nstatic int si476x_core_cmd_intb_pin_cfg_a20(struct si476x_core *core,\r\nenum si476x_intb_config intb,\r\nenum si476x_a1_config a1)\r\n{\r\nu8 resp[CMD_INTB_PIN_CFG_A20_NRESP];\r\nconst u8 args[CMD_INTB_PIN_CFG_NARGS] = {\r\nPIN_CFG_BYTE(intb),\r\nPIN_CFG_BYTE(a1),\r\n};\r\nreturn si476x_core_send_command(core, CMD_INTB_PIN_CFG,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\n}\r\nint si476x_core_cmd_am_rsq_status(struct si476x_core *core,\r\nstruct si476x_rsq_status_args *rsqargs,\r\nstruct si476x_rsq_status_report *report)\r\n{\r\nint err;\r\nu8 resp[CMD_AM_RSQ_STATUS_NRESP];\r\nconst u8 args[CMD_AM_RSQ_STATUS_NARGS] = {\r\nrsqargs->rsqack << 3 | rsqargs->attune << 2 |\r\nrsqargs->cancel << 1 | rsqargs->stcack,\r\n};\r\nerr = si476x_core_send_command(core, CMD_AM_RSQ_STATUS,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\nif (!report)\r\nreturn err;\r\nreport->snrhint = 0x08 & resp[1];\r\nreport->snrlint = 0x04 & resp[1];\r\nreport->rssihint = 0x02 & resp[1];\r\nreport->rssilint = 0x01 & resp[1];\r\nreport->bltf = 0x80 & resp[2];\r\nreport->snr_ready = 0x20 & resp[2];\r\nreport->rssiready = 0x08 & resp[2];\r\nreport->afcrl = 0x02 & resp[2];\r\nreport->valid = 0x01 & resp[2];\r\nreport->readfreq = get_unaligned_be16(resp + 3);\r\nreport->freqoff = resp[5];\r\nreport->rssi = resp[6];\r\nreport->snr = resp[7];\r\nreport->lassi = resp[9];\r\nreport->hassi = resp[10];\r\nreport->mult = resp[11];\r\nreport->dev = resp[12];\r\nreturn err;\r\n}\r\nint si476x_core_cmd_fm_acf_status(struct si476x_core *core,\r\nstruct si476x_acf_status_report *report)\r\n{\r\nint err;\r\nu8 resp[CMD_FM_ACF_STATUS_NRESP];\r\nconst u8 args[CMD_FM_ACF_STATUS_NARGS] = {\r\n0x0,\r\n};\r\nif (!report)\r\nreturn -EINVAL;\r\nerr = si476x_core_send_command(core, CMD_FM_ACF_STATUS,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\nif (err < 0)\r\nreturn err;\r\nreport->blend_int = resp[1] & SI476X_ACF_BLEND_INT;\r\nreport->hblend_int = resp[1] & SI476X_ACF_HIBLEND_INT;\r\nreport->hicut_int = resp[1] & SI476X_ACF_HICUT_INT;\r\nreport->chbw_int = resp[1] & SI476X_ACF_CHBW_INT;\r\nreport->softmute_int = resp[1] & SI476X_ACF_SOFTMUTE_INT;\r\nreport->smute = resp[2] & SI476X_ACF_SMUTE;\r\nreport->smattn = resp[3] & SI476X_ACF_SMATTN;\r\nreport->chbw = resp[4];\r\nreport->hicut = resp[5];\r\nreport->hiblend = resp[6];\r\nreport->pilot = resp[7] & SI476X_ACF_PILOT;\r\nreport->stblend = resp[7] & SI476X_ACF_STBLEND;\r\nreturn err;\r\n}\r\nint si476x_core_cmd_am_acf_status(struct si476x_core *core,\r\nstruct si476x_acf_status_report *report)\r\n{\r\nint err;\r\nu8 resp[CMD_AM_ACF_STATUS_NRESP];\r\nconst u8 args[CMD_AM_ACF_STATUS_NARGS] = {\r\n0x0,\r\n};\r\nif (!report)\r\nreturn -EINVAL;\r\nerr = si476x_core_send_command(core, CMD_AM_ACF_STATUS,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\nif (err < 0)\r\nreturn err;\r\nreport->blend_int = resp[1] & SI476X_ACF_BLEND_INT;\r\nreport->hblend_int = resp[1] & SI476X_ACF_HIBLEND_INT;\r\nreport->hicut_int = resp[1] & SI476X_ACF_HICUT_INT;\r\nreport->chbw_int = resp[1] & SI476X_ACF_CHBW_INT;\r\nreport->softmute_int = resp[1] & SI476X_ACF_SOFTMUTE_INT;\r\nreport->smute = resp[2] & SI476X_ACF_SMUTE;\r\nreport->smattn = resp[3] & SI476X_ACF_SMATTN;\r\nreport->chbw = resp[4];\r\nreport->hicut = resp[5];\r\nreturn err;\r\n}\r\nint si476x_core_cmd_fm_seek_start(struct si476x_core *core,\r\nbool seekup, bool wrap)\r\n{\r\nu8 resp[CMD_FM_SEEK_START_NRESP];\r\nconst u8 args[CMD_FM_SEEK_START_NARGS] = {\r\nseekup << 3 | wrap << 2,\r\n};\r\nreturn si476x_cmd_tune_seek_freq(core, CMD_FM_SEEK_START,\r\nargs, sizeof(args),\r\nresp, sizeof(resp));\r\n}\r\nint si476x_core_cmd_fm_rds_status(struct si476x_core *core,\r\nbool status_only,\r\nbool mtfifo,\r\nbool intack,\r\nstruct si476x_rds_status_report *report)\r\n{\r\nint err;\r\nu8 resp[CMD_FM_RDS_STATUS_NRESP];\r\nconst u8 args[CMD_FM_RDS_STATUS_NARGS] = {\r\nstatus_only << 2 | mtfifo << 1 | intack,\r\n};\r\nerr = si476x_core_send_command(core, CMD_FM_RDS_STATUS,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\nif (err < 0 || report == NULL)\r\nreturn err;\r\nreport->rdstpptyint = 0x10 & resp[1];\r\nreport->rdspiint = 0x08 & resp[1];\r\nreport->rdssyncint = 0x02 & resp[1];\r\nreport->rdsfifoint = 0x01 & resp[1];\r\nreport->tpptyvalid = 0x10 & resp[2];\r\nreport->pivalid = 0x08 & resp[2];\r\nreport->rdssync = 0x02 & resp[2];\r\nreport->rdsfifolost = 0x01 & resp[2];\r\nreport->tp = 0x20 & resp[3];\r\nreport->pty = 0x1f & resp[3];\r\nreport->pi = get_unaligned_be16(resp + 4);\r\nreport->rdsfifoused = resp[6];\r\nreport->ble[V4L2_RDS_BLOCK_A] = 0xc0 & resp[7];\r\nreport->ble[V4L2_RDS_BLOCK_B] = 0x30 & resp[7];\r\nreport->ble[V4L2_RDS_BLOCK_C] = 0x0c & resp[7];\r\nreport->ble[V4L2_RDS_BLOCK_D] = 0x03 & resp[7];\r\nreport->rds[V4L2_RDS_BLOCK_A].block = V4L2_RDS_BLOCK_A;\r\nreport->rds[V4L2_RDS_BLOCK_A].msb = resp[8];\r\nreport->rds[V4L2_RDS_BLOCK_A].lsb = resp[9];\r\nreport->rds[V4L2_RDS_BLOCK_B].block = V4L2_RDS_BLOCK_B;\r\nreport->rds[V4L2_RDS_BLOCK_B].msb = resp[10];\r\nreport->rds[V4L2_RDS_BLOCK_B].lsb = resp[11];\r\nreport->rds[V4L2_RDS_BLOCK_C].block = V4L2_RDS_BLOCK_C;\r\nreport->rds[V4L2_RDS_BLOCK_C].msb = resp[12];\r\nreport->rds[V4L2_RDS_BLOCK_C].lsb = resp[13];\r\nreport->rds[V4L2_RDS_BLOCK_D].block = V4L2_RDS_BLOCK_D;\r\nreport->rds[V4L2_RDS_BLOCK_D].msb = resp[14];\r\nreport->rds[V4L2_RDS_BLOCK_D].lsb = resp[15];\r\nreturn err;\r\n}\r\nint si476x_core_cmd_fm_rds_blockcount(struct si476x_core *core,\r\nbool clear,\r\nstruct si476x_rds_blockcount_report *report)\r\n{\r\nint err;\r\nu8 resp[CMD_FM_RDS_BLOCKCOUNT_NRESP];\r\nconst u8 args[CMD_FM_RDS_BLOCKCOUNT_NARGS] = {\r\nclear,\r\n};\r\nif (!report)\r\nreturn -EINVAL;\r\nerr = si476x_core_send_command(core, CMD_FM_RDS_BLOCKCOUNT,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\nif (!err) {\r\nreport->expected = get_unaligned_be16(resp + 2);\r\nreport->received = get_unaligned_be16(resp + 4);\r\nreport->uncorrectable = get_unaligned_be16(resp + 6);\r\n}\r\nreturn err;\r\n}\r\nint si476x_core_cmd_fm_phase_diversity(struct si476x_core *core,\r\nenum si476x_phase_diversity_mode mode)\r\n{\r\nu8 resp[CMD_FM_PHASE_DIVERSITY_NRESP];\r\nconst u8 args[CMD_FM_PHASE_DIVERSITY_NARGS] = {\r\nmode & 0x07,\r\n};\r\nreturn si476x_core_send_command(core, CMD_FM_PHASE_DIVERSITY,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\n}\r\nint si476x_core_cmd_fm_phase_div_status(struct si476x_core *core)\r\n{\r\nint err;\r\nu8 resp[CMD_FM_PHASE_DIV_STATUS_NRESP];\r\nerr = si476x_core_send_command(core, CMD_FM_PHASE_DIV_STATUS,\r\nNULL, 0,\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\nreturn (err < 0) ? err : resp[1];\r\n}\r\nint si476x_core_cmd_am_seek_start(struct si476x_core *core,\r\nbool seekup, bool wrap)\r\n{\r\nu8 resp[CMD_AM_SEEK_START_NRESP];\r\nconst u8 args[CMD_AM_SEEK_START_NARGS] = {\r\nseekup << 3 | wrap << 2,\r\n};\r\nreturn si476x_cmd_tune_seek_freq(core, CMD_AM_SEEK_START,\r\nargs, sizeof(args),\r\nresp, sizeof(resp));\r\n}\r\nstatic int si476x_core_cmd_power_up_a10(struct si476x_core *core,\r\nstruct si476x_power_up_args *puargs)\r\n{\r\nu8 resp[CMD_POWER_UP_A10_NRESP];\r\nconst bool intsel = (core->pinmux.a1 == SI476X_A1_IRQ);\r\nconst bool ctsen = (core->client->irq != 0);\r\nconst u8 args[CMD_POWER_UP_A10_NARGS] = {\r\n0xF7,\r\n0x3F & puargs->xcload,\r\nctsen << 7 | intsel << 6 | 0x07,\r\npuargs->func << 4 | puargs->freq,\r\n0x11,\r\n};\r\nreturn si476x_core_send_command(core, CMD_POWER_UP,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_TIMEOUT_POWER_UP);\r\n}\r\nstatic int si476x_core_cmd_power_up_a20(struct si476x_core *core,\r\nstruct si476x_power_up_args *puargs)\r\n{\r\nu8 resp[CMD_POWER_UP_A20_NRESP];\r\nconst bool intsel = (core->pinmux.a1 == SI476X_A1_IRQ);\r\nconst bool ctsen = (core->client->irq != 0);\r\nconst u8 args[CMD_POWER_UP_A20_NARGS] = {\r\npuargs->ibias6x << 7 | puargs->xstart,\r\n0x3F & puargs->xcload,\r\nctsen << 7 | intsel << 6 | puargs->fastboot << 5 |\r\npuargs->xbiashc << 3 | puargs->xbias,\r\npuargs->func << 4 | puargs->freq,\r\n0x10 | puargs->xmode,\r\n};\r\nreturn si476x_core_send_command(core, CMD_POWER_UP,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_TIMEOUT_POWER_UP);\r\n}\r\nstatic int si476x_core_cmd_power_down_a10(struct si476x_core *core,\r\nstruct si476x_power_down_args *pdargs)\r\n{\r\nu8 resp[CMD_POWER_DOWN_A10_NRESP];\r\nreturn si476x_core_send_command(core, CMD_POWER_DOWN,\r\nNULL, 0,\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\n}\r\nstatic int si476x_core_cmd_power_down_a20(struct si476x_core *core,\r\nstruct si476x_power_down_args *pdargs)\r\n{\r\nu8 resp[CMD_POWER_DOWN_A20_NRESP];\r\nconst u8 args[CMD_POWER_DOWN_A20_NARGS] = {\r\npdargs->xosc,\r\n};\r\nreturn si476x_core_send_command(core, CMD_POWER_DOWN,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\n}\r\nstatic int si476x_core_cmd_am_tune_freq_a10(struct si476x_core *core,\r\nstruct si476x_tune_freq_args *tuneargs)\r\n{\r\nconst int am_freq = tuneargs->freq;\r\nu8 resp[CMD_AM_TUNE_FREQ_NRESP];\r\nconst u8 args[CMD_AM_TUNE_FREQ_NARGS] = {\r\n(tuneargs->hd << 6),\r\nmsb(am_freq),\r\nlsb(am_freq),\r\n};\r\nreturn si476x_cmd_tune_seek_freq(core, CMD_AM_TUNE_FREQ, args,\r\nsizeof(args),\r\nresp, sizeof(resp));\r\n}\r\nstatic int si476x_core_cmd_am_tune_freq_a20(struct si476x_core *core,\r\nstruct si476x_tune_freq_args *tuneargs)\r\n{\r\nconst int am_freq = tuneargs->freq;\r\nu8 resp[CMD_AM_TUNE_FREQ_NRESP];\r\nconst u8 args[CMD_AM_TUNE_FREQ_NARGS] = {\r\n(tuneargs->zifsr << 6) | (tuneargs->injside & 0x03),\r\nmsb(am_freq),\r\nlsb(am_freq),\r\n};\r\nreturn si476x_cmd_tune_seek_freq(core, CMD_AM_TUNE_FREQ,\r\nargs, sizeof(args),\r\nresp, sizeof(resp));\r\n}\r\nstatic int si476x_core_cmd_fm_rsq_status_a10(struct si476x_core *core,\r\nstruct si476x_rsq_status_args *rsqargs,\r\nstruct si476x_rsq_status_report *report)\r\n{\r\nint err;\r\nu8 resp[CMD_FM_RSQ_STATUS_A10_NRESP];\r\nconst u8 args[CMD_FM_RSQ_STATUS_A10_NARGS] = {\r\nrsqargs->rsqack << 3 | rsqargs->attune << 2 |\r\nrsqargs->cancel << 1 | rsqargs->stcack,\r\n};\r\nerr = si476x_core_send_command(core, CMD_FM_RSQ_STATUS,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\nif (err < 0 || report == NULL)\r\nreturn err;\r\nreport->multhint = 0x80 & resp[1];\r\nreport->multlint = 0x40 & resp[1];\r\nreport->snrhint = 0x08 & resp[1];\r\nreport->snrlint = 0x04 & resp[1];\r\nreport->rssihint = 0x02 & resp[1];\r\nreport->rssilint = 0x01 & resp[1];\r\nreport->bltf = 0x80 & resp[2];\r\nreport->snr_ready = 0x20 & resp[2];\r\nreport->rssiready = 0x08 & resp[2];\r\nreport->afcrl = 0x02 & resp[2];\r\nreport->valid = 0x01 & resp[2];\r\nreport->readfreq = get_unaligned_be16(resp + 3);\r\nreport->freqoff = resp[5];\r\nreport->rssi = resp[6];\r\nreport->snr = resp[7];\r\nreport->lassi = resp[9];\r\nreport->hassi = resp[10];\r\nreport->mult = resp[11];\r\nreport->dev = resp[12];\r\nreport->readantcap = get_unaligned_be16(resp + 13);\r\nreport->assi = resp[15];\r\nreport->usn = resp[16];\r\nreturn err;\r\n}\r\nstatic int si476x_core_cmd_fm_rsq_status_a20(struct si476x_core *core,\r\nstruct si476x_rsq_status_args *rsqargs,\r\nstruct si476x_rsq_status_report *report)\r\n{\r\nint err;\r\nu8 resp[CMD_FM_RSQ_STATUS_A10_NRESP];\r\nconst u8 args[CMD_FM_RSQ_STATUS_A30_NARGS] = {\r\nrsqargs->primary << 4 | rsqargs->rsqack << 3 |\r\nrsqargs->attune << 2 | rsqargs->cancel << 1 |\r\nrsqargs->stcack,\r\n};\r\nerr = si476x_core_send_command(core, CMD_FM_RSQ_STATUS,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\nif (err < 0 || report == NULL)\r\nreturn err;\r\nreport->multhint = 0x80 & resp[1];\r\nreport->multlint = 0x40 & resp[1];\r\nreport->snrhint = 0x08 & resp[1];\r\nreport->snrlint = 0x04 & resp[1];\r\nreport->rssihint = 0x02 & resp[1];\r\nreport->rssilint = 0x01 & resp[1];\r\nreport->bltf = 0x80 & resp[2];\r\nreport->snr_ready = 0x20 & resp[2];\r\nreport->rssiready = 0x08 & resp[2];\r\nreport->afcrl = 0x02 & resp[2];\r\nreport->valid = 0x01 & resp[2];\r\nreport->readfreq = get_unaligned_be16(resp + 3);\r\nreport->freqoff = resp[5];\r\nreport->rssi = resp[6];\r\nreport->snr = resp[7];\r\nreport->lassi = resp[9];\r\nreport->hassi = resp[10];\r\nreport->mult = resp[11];\r\nreport->dev = resp[12];\r\nreport->readantcap = get_unaligned_be16(resp + 13);\r\nreport->assi = resp[15];\r\nreport->usn = resp[16];\r\nreturn err;\r\n}\r\nstatic int si476x_core_cmd_fm_rsq_status_a30(struct si476x_core *core,\r\nstruct si476x_rsq_status_args *rsqargs,\r\nstruct si476x_rsq_status_report *report)\r\n{\r\nint err;\r\nu8 resp[CMD_FM_RSQ_STATUS_A30_NRESP];\r\nconst u8 args[CMD_FM_RSQ_STATUS_A30_NARGS] = {\r\nrsqargs->primary << 4 | rsqargs->rsqack << 3 |\r\nrsqargs->attune << 2 | rsqargs->cancel << 1 |\r\nrsqargs->stcack,\r\n};\r\nerr = si476x_core_send_command(core, CMD_FM_RSQ_STATUS,\r\nargs, ARRAY_SIZE(args),\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\nif (err < 0 || report == NULL)\r\nreturn err;\r\nreport->multhint = 0x80 & resp[1];\r\nreport->multlint = 0x40 & resp[1];\r\nreport->snrhint = 0x08 & resp[1];\r\nreport->snrlint = 0x04 & resp[1];\r\nreport->rssihint = 0x02 & resp[1];\r\nreport->rssilint = 0x01 & resp[1];\r\nreport->bltf = 0x80 & resp[2];\r\nreport->snr_ready = 0x20 & resp[2];\r\nreport->rssiready = 0x08 & resp[2];\r\nreport->injside = 0x04 & resp[2];\r\nreport->afcrl = 0x02 & resp[2];\r\nreport->valid = 0x01 & resp[2];\r\nreport->readfreq = get_unaligned_be16(resp + 3);\r\nreport->freqoff = resp[5];\r\nreport->rssi = resp[6];\r\nreport->snr = resp[7];\r\nreport->issi = resp[8];\r\nreport->lassi = resp[9];\r\nreport->hassi = resp[10];\r\nreport->mult = resp[11];\r\nreport->dev = resp[12];\r\nreport->readantcap = get_unaligned_be16(resp + 13);\r\nreport->assi = resp[15];\r\nreport->usn = resp[16];\r\nreport->pilotdev = resp[17];\r\nreport->rdsdev = resp[18];\r\nreport->assidev = resp[19];\r\nreport->strongdev = resp[20];\r\nreport->rdspi = get_unaligned_be16(resp + 21);\r\nreturn err;\r\n}\r\nstatic int si476x_core_cmd_fm_tune_freq_a10(struct si476x_core *core,\r\nstruct si476x_tune_freq_args *tuneargs)\r\n{\r\nu8 resp[CMD_FM_TUNE_FREQ_NRESP];\r\nconst u8 args[CMD_FM_TUNE_FREQ_A10_NARGS] = {\r\n(tuneargs->hd << 6) | (tuneargs->tunemode << 4)\r\n| (tuneargs->smoothmetrics << 2),\r\nmsb(tuneargs->freq),\r\nlsb(tuneargs->freq),\r\nmsb(tuneargs->antcap),\r\nlsb(tuneargs->antcap)\r\n};\r\nreturn si476x_cmd_tune_seek_freq(core, CMD_FM_TUNE_FREQ,\r\nargs, sizeof(args),\r\nresp, sizeof(resp));\r\n}\r\nstatic int si476x_core_cmd_fm_tune_freq_a20(struct si476x_core *core,\r\nstruct si476x_tune_freq_args *tuneargs)\r\n{\r\nu8 resp[CMD_FM_TUNE_FREQ_NRESP];\r\nconst u8 args[CMD_FM_TUNE_FREQ_A20_NARGS] = {\r\n(tuneargs->hd << 6) | (tuneargs->tunemode << 4)\r\n| (tuneargs->smoothmetrics << 2) | (tuneargs->injside),\r\nmsb(tuneargs->freq),\r\nlsb(tuneargs->freq),\r\n};\r\nreturn si476x_cmd_tune_seek_freq(core, CMD_FM_TUNE_FREQ,\r\nargs, sizeof(args),\r\nresp, sizeof(resp));\r\n}\r\nstatic int si476x_core_cmd_agc_status_a20(struct si476x_core *core,\r\nstruct si476x_agc_status_report *report)\r\n{\r\nint err;\r\nu8 resp[CMD_AGC_STATUS_NRESP_A20];\r\nif (!report)\r\nreturn -EINVAL;\r\nerr = si476x_core_send_command(core, CMD_AGC_STATUS,\r\nNULL, 0,\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\nif (err < 0)\r\nreturn err;\r\nreport->mxhi = resp[1] & SI476X_AGC_MXHI;\r\nreport->mxlo = resp[1] & SI476X_AGC_MXLO;\r\nreport->lnahi = resp[1] & SI476X_AGC_LNAHI;\r\nreport->lnalo = resp[1] & SI476X_AGC_LNALO;\r\nreport->fmagc1 = resp[2];\r\nreport->fmagc2 = resp[3];\r\nreport->pgagain = resp[4];\r\nreport->fmwblang = resp[5];\r\nreturn err;\r\n}\r\nstatic int si476x_core_cmd_agc_status_a10(struct si476x_core *core,\r\nstruct si476x_agc_status_report *report)\r\n{\r\nint err;\r\nu8 resp[CMD_AGC_STATUS_NRESP_A10];\r\nif (!report)\r\nreturn -EINVAL;\r\nerr = si476x_core_send_command(core, CMD_AGC_STATUS,\r\nNULL, 0,\r\nresp, ARRAY_SIZE(resp),\r\nSI476X_DEFAULT_TIMEOUT);\r\nif (err < 0)\r\nreturn err;\r\nreport->mxhi = resp[1] & SI476X_AGC_MXHI;\r\nreport->mxlo = resp[1] & SI476X_AGC_MXLO;\r\nreport->lnahi = resp[1] & SI476X_AGC_LNAHI;\r\nreport->lnalo = resp[1] & SI476X_AGC_LNALO;\r\nreturn err;\r\n}\r\nint si476x_core_cmd_power_up(struct si476x_core *core,\r\nstruct si476x_power_up_args *args)\r\n{\r\nBUG_ON(core->revision > SI476X_REVISION_A30 ||\r\ncore->revision == -1);\r\nreturn si476x_cmds_vtable[core->revision].power_up(core, args);\r\n}\r\nint si476x_core_cmd_power_down(struct si476x_core *core,\r\nstruct si476x_power_down_args *args)\r\n{\r\nBUG_ON(core->revision > SI476X_REVISION_A30 ||\r\ncore->revision == -1);\r\nreturn si476x_cmds_vtable[core->revision].power_down(core, args);\r\n}\r\nint si476x_core_cmd_fm_tune_freq(struct si476x_core *core,\r\nstruct si476x_tune_freq_args *args)\r\n{\r\nBUG_ON(core->revision > SI476X_REVISION_A30 ||\r\ncore->revision == -1);\r\nreturn si476x_cmds_vtable[core->revision].fm_tune_freq(core, args);\r\n}\r\nint si476x_core_cmd_am_tune_freq(struct si476x_core *core,\r\nstruct si476x_tune_freq_args *args)\r\n{\r\nBUG_ON(core->revision > SI476X_REVISION_A30 ||\r\ncore->revision == -1);\r\nreturn si476x_cmds_vtable[core->revision].am_tune_freq(core, args);\r\n}\r\nint si476x_core_cmd_fm_rsq_status(struct si476x_core *core,\r\nstruct si476x_rsq_status_args *args,\r\nstruct si476x_rsq_status_report *report)\r\n{\r\nBUG_ON(core->revision > SI476X_REVISION_A30 ||\r\ncore->revision == -1);\r\nreturn si476x_cmds_vtable[core->revision].fm_rsq_status(core, args,\r\nreport);\r\n}\r\nint si476x_core_cmd_agc_status(struct si476x_core *core,\r\nstruct si476x_agc_status_report *report)\r\n{\r\nBUG_ON(core->revision > SI476X_REVISION_A30 ||\r\ncore->revision == -1);\r\nreturn si476x_cmds_vtable[core->revision].agc_status(core, report);\r\n}\r\nint si476x_core_cmd_intb_pin_cfg(struct si476x_core *core,\r\nenum si476x_intb_config intb,\r\nenum si476x_a1_config a1)\r\n{\r\nBUG_ON(core->revision > SI476X_REVISION_A30 ||\r\ncore->revision == -1);\r\nreturn si476x_cmds_vtable[core->revision].intb_pin_cfg(core, intb, a1);\r\n}

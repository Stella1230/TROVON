void dql_completed(struct dql *dql, unsigned int count)\r\n{\r\nunsigned int inprogress, prev_inprogress, limit;\r\nunsigned int ovlimit, completed, num_queued;\r\nbool all_prev_completed;\r\nnum_queued = ACCESS_ONCE(dql->num_queued);\r\nBUG_ON(count > num_queued - dql->num_completed);\r\ncompleted = dql->num_completed + count;\r\nlimit = dql->limit;\r\novlimit = POSDIFF(num_queued - dql->num_completed, limit);\r\ninprogress = num_queued - completed;\r\nprev_inprogress = dql->prev_num_queued - dql->num_completed;\r\nall_prev_completed = AFTER_EQ(completed, dql->prev_num_queued);\r\nif ((ovlimit && !inprogress) ||\r\n(dql->prev_ovlimit && all_prev_completed)) {\r\nlimit += POSDIFF(completed, dql->prev_num_queued) +\r\ndql->prev_ovlimit;\r\ndql->slack_start_time = jiffies;\r\ndql->lowest_slack = UINT_MAX;\r\n} else if (inprogress && prev_inprogress && !all_prev_completed) {\r\nunsigned int slack, slack_last_objs;\r\nslack = POSDIFF(limit + dql->prev_ovlimit,\r\n2 * (completed - dql->num_completed));\r\nslack_last_objs = dql->prev_ovlimit ?\r\nPOSDIFF(dql->prev_last_obj_cnt, dql->prev_ovlimit) : 0;\r\nslack = max(slack, slack_last_objs);\r\nif (slack < dql->lowest_slack)\r\ndql->lowest_slack = slack;\r\nif (time_after(jiffies,\r\ndql->slack_start_time + dql->slack_hold_time)) {\r\nlimit = POSDIFF(limit, dql->lowest_slack);\r\ndql->slack_start_time = jiffies;\r\ndql->lowest_slack = UINT_MAX;\r\n}\r\n}\r\nlimit = clamp(limit, dql->min_limit, dql->max_limit);\r\nif (limit != dql->limit) {\r\ndql->limit = limit;\r\novlimit = 0;\r\n}\r\ndql->adj_limit = limit + completed;\r\ndql->prev_ovlimit = ovlimit;\r\ndql->prev_last_obj_cnt = dql->last_obj_cnt;\r\ndql->num_completed = completed;\r\ndql->prev_num_queued = num_queued;\r\n}\r\nvoid dql_reset(struct dql *dql)\r\n{\r\ndql->limit = 0;\r\ndql->num_queued = 0;\r\ndql->num_completed = 0;\r\ndql->last_obj_cnt = 0;\r\ndql->prev_num_queued = 0;\r\ndql->prev_last_obj_cnt = 0;\r\ndql->prev_ovlimit = 0;\r\ndql->lowest_slack = UINT_MAX;\r\ndql->slack_start_time = jiffies;\r\n}\r\nint dql_init(struct dql *dql, unsigned hold_time)\r\n{\r\ndql->max_limit = DQL_MAX_LIMIT;\r\ndql->min_limit = 0;\r\ndql->slack_hold_time = hold_time;\r\ndql_reset(dql);\r\nreturn 0;\r\n}

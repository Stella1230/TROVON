struct zfcp_adapter *zfcp_ccw_adapter_by_cdev(struct ccw_device *cdev)\r\n{\r\nstruct zfcp_adapter *adapter;\r\nunsigned long flags;\r\nspin_lock_irqsave(&zfcp_ccw_adapter_ref_lock, flags);\r\nadapter = dev_get_drvdata(&cdev->dev);\r\nif (adapter)\r\nkref_get(&adapter->ref);\r\nspin_unlock_irqrestore(&zfcp_ccw_adapter_ref_lock, flags);\r\nreturn adapter;\r\n}\r\nvoid zfcp_ccw_adapter_put(struct zfcp_adapter *adapter)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&zfcp_ccw_adapter_ref_lock, flags);\r\nkref_put(&adapter->ref, zfcp_adapter_release);\r\nspin_unlock_irqrestore(&zfcp_ccw_adapter_ref_lock, flags);\r\n}\r\nstatic int zfcp_ccw_activate(struct ccw_device *cdev, int clear, char *tag)\r\n{\r\nstruct zfcp_adapter *adapter = zfcp_ccw_adapter_by_cdev(cdev);\r\nif (!adapter)\r\nreturn 0;\r\nzfcp_erp_clear_adapter_status(adapter, clear);\r\nzfcp_erp_set_adapter_status(adapter, ZFCP_STATUS_COMMON_RUNNING);\r\nzfcp_erp_adapter_reopen(adapter, ZFCP_STATUS_COMMON_ERP_FAILED,\r\ntag);\r\nzfcp_erp_wait(adapter);\r\nflush_work(&adapter->scan_work);\r\nzfcp_ccw_adapter_put(adapter);\r\nreturn 0;\r\n}\r\nstatic int zfcp_ccw_probe(struct ccw_device *cdev)\r\n{\r\nreturn 0;\r\n}\r\nstatic void zfcp_ccw_remove(struct ccw_device *cdev)\r\n{\r\nstruct zfcp_adapter *adapter;\r\nstruct zfcp_port *port, *p;\r\nstruct zfcp_unit *unit, *u;\r\nLIST_HEAD(unit_remove_lh);\r\nLIST_HEAD(port_remove_lh);\r\nccw_device_set_offline(cdev);\r\nadapter = zfcp_ccw_adapter_by_cdev(cdev);\r\nif (!adapter)\r\nreturn;\r\nwrite_lock_irq(&adapter->port_list_lock);\r\nlist_for_each_entry_safe(port, p, &adapter->port_list, list) {\r\nwrite_lock(&port->unit_list_lock);\r\nlist_for_each_entry_safe(unit, u, &port->unit_list, list)\r\nlist_move(&unit->list, &unit_remove_lh);\r\nwrite_unlock(&port->unit_list_lock);\r\nlist_move(&port->list, &port_remove_lh);\r\n}\r\nwrite_unlock_irq(&adapter->port_list_lock);\r\nzfcp_ccw_adapter_put(adapter);\r\nlist_for_each_entry_safe(unit, u, &unit_remove_lh, list)\r\ndevice_unregister(&unit->dev);\r\nlist_for_each_entry_safe(port, p, &port_remove_lh, list)\r\ndevice_unregister(&port->dev);\r\nzfcp_adapter_unregister(adapter);\r\n}\r\nstatic int zfcp_ccw_set_online(struct ccw_device *cdev)\r\n{\r\nstruct zfcp_adapter *adapter = zfcp_ccw_adapter_by_cdev(cdev);\r\nif (!adapter) {\r\nadapter = zfcp_adapter_enqueue(cdev);\r\nif (IS_ERR(adapter)) {\r\ndev_err(&cdev->dev,\r\n"Setting up data structures for the "\r\n"FCP adapter failed\n");\r\nreturn PTR_ERR(adapter);\r\n}\r\nkref_get(&adapter->ref);\r\n}\r\nBUG_ON(!zfcp_reqlist_isempty(adapter->req_list));\r\nadapter->req_no = 0;\r\nzfcp_ccw_activate(cdev, 0, "ccsonl1");\r\nzfcp_fc_inverse_conditional_port_scan(adapter);\r\nflush_work(&adapter->scan_work);\r\nzfcp_ccw_adapter_put(adapter);\r\nreturn 0;\r\n}\r\nstatic int zfcp_ccw_offline_sync(struct ccw_device *cdev, int set, char *tag)\r\n{\r\nstruct zfcp_adapter *adapter = zfcp_ccw_adapter_by_cdev(cdev);\r\nif (!adapter)\r\nreturn 0;\r\nzfcp_erp_set_adapter_status(adapter, set);\r\nzfcp_erp_adapter_shutdown(adapter, 0, tag);\r\nzfcp_erp_wait(adapter);\r\nzfcp_ccw_adapter_put(adapter);\r\nreturn 0;\r\n}\r\nstatic int zfcp_ccw_set_offline(struct ccw_device *cdev)\r\n{\r\nreturn zfcp_ccw_offline_sync(cdev, 0, "ccsoff1");\r\n}\r\nstatic int zfcp_ccw_notify(struct ccw_device *cdev, int event)\r\n{\r\nstruct zfcp_adapter *adapter = zfcp_ccw_adapter_by_cdev(cdev);\r\nif (!adapter)\r\nreturn 1;\r\nswitch (event) {\r\ncase CIO_GONE:\r\nif (atomic_read(&adapter->status) &\r\nZFCP_STATUS_ADAPTER_SUSPENDED) {\r\nzfcp_dbf_hba_basic("ccnigo1", adapter);\r\nbreak;\r\n}\r\ndev_warn(&cdev->dev, "The FCP device has been detached\n");\r\nzfcp_erp_adapter_shutdown(adapter, 0, "ccnoti1");\r\nbreak;\r\ncase CIO_NO_PATH:\r\ndev_warn(&cdev->dev,\r\n"The CHPID for the FCP device is offline\n");\r\nzfcp_erp_adapter_shutdown(adapter, 0, "ccnoti2");\r\nbreak;\r\ncase CIO_OPER:\r\nif (atomic_read(&adapter->status) &\r\nZFCP_STATUS_ADAPTER_SUSPENDED) {\r\nzfcp_dbf_hba_basic("ccniop1", adapter);\r\nbreak;\r\n}\r\ndev_info(&cdev->dev, "The FCP device is operational again\n");\r\nzfcp_erp_set_adapter_status(adapter,\r\nZFCP_STATUS_COMMON_RUNNING);\r\nzfcp_erp_adapter_reopen(adapter, ZFCP_STATUS_COMMON_ERP_FAILED,\r\n"ccnoti4");\r\nbreak;\r\ncase CIO_BOXED:\r\ndev_warn(&cdev->dev, "The FCP device did not respond within "\r\n"the specified time\n");\r\nzfcp_erp_adapter_shutdown(adapter, 0, "ccnoti5");\r\nbreak;\r\n}\r\nzfcp_ccw_adapter_put(adapter);\r\nreturn 1;\r\n}\r\nstatic void zfcp_ccw_shutdown(struct ccw_device *cdev)\r\n{\r\nstruct zfcp_adapter *adapter = zfcp_ccw_adapter_by_cdev(cdev);\r\nif (!adapter)\r\nreturn;\r\nzfcp_erp_adapter_shutdown(adapter, 0, "ccshut1");\r\nzfcp_erp_wait(adapter);\r\nzfcp_erp_thread_kill(adapter);\r\nzfcp_ccw_adapter_put(adapter);\r\n}\r\nstatic int zfcp_ccw_suspend(struct ccw_device *cdev)\r\n{\r\nzfcp_ccw_offline_sync(cdev, ZFCP_STATUS_ADAPTER_SUSPENDED, "ccsusp1");\r\nreturn 0;\r\n}\r\nstatic int zfcp_ccw_thaw(struct ccw_device *cdev)\r\n{\r\nzfcp_ccw_activate(cdev, 0, "ccthaw1");\r\nreturn 0;\r\n}\r\nstatic int zfcp_ccw_resume(struct ccw_device *cdev)\r\n{\r\nzfcp_ccw_activate(cdev, ZFCP_STATUS_ADAPTER_SUSPENDED, "ccresu1");\r\nreturn 0;\r\n}

static int ps2_startstreaming(struct serio *ser_dev)\r\n{\r\nunsigned char buf[] = { NVEC_PS2, AUTO_RECEIVE_N, PACKET_SIZE };\r\nreturn nvec_write_async(ps2_dev.nvec, buf, sizeof(buf));\r\n}\r\nstatic void ps2_stopstreaming(struct serio *ser_dev)\r\n{\r\nunsigned char buf[] = { NVEC_PS2, CANCEL_AUTO_RECEIVE };\r\nnvec_write_async(ps2_dev.nvec, buf, sizeof(buf));\r\n}\r\nstatic int ps2_sendcommand(struct serio *ser_dev, unsigned char cmd)\r\n{\r\nunsigned char buf[] = { NVEC_PS2, SEND_COMMAND, ENABLE_MOUSE, 1 };\r\nbuf[2] = cmd & 0xff;\r\ndev_dbg(&ser_dev->dev, "Sending ps2 cmd %02x\n", cmd);\r\nreturn nvec_write_async(ps2_dev.nvec, buf, sizeof(buf));\r\n}\r\nstatic int nvec_ps2_notifier(struct notifier_block *nb,\r\nunsigned long event_type, void *data)\r\n{\r\nint i;\r\nunsigned char *msg = (unsigned char *)data;\r\nswitch (event_type) {\r\ncase NVEC_PS2_EVT:\r\nfor (i = 0; i < msg[1]; i++)\r\nserio_interrupt(ps2_dev.ser_dev, msg[2 + i], 0);\r\nNVEC_PHD("ps/2 mouse event: ", &msg[2], msg[1]);\r\nreturn NOTIFY_STOP;\r\ncase NVEC_PS2:\r\nif (msg[2] == 1) {\r\nfor (i = 0; i < (msg[1] - 2); i++)\r\nserio_interrupt(ps2_dev.ser_dev, msg[i + 4], 0);\r\nNVEC_PHD("ps/2 mouse reply: ", &msg[4], msg[1] - 2);\r\n}\r\nelse if (msg[1] != 2)\r\nNVEC_PHD("unhandled mouse event: ", msg, msg[1] + 2);\r\nreturn NOTIFY_STOP;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int nvec_mouse_probe(struct platform_device *pdev)\r\n{\r\nstruct nvec_chip *nvec = dev_get_drvdata(pdev->dev.parent);\r\nstruct serio *ser_dev;\r\nchar mouse_reset[] = { NVEC_PS2, SEND_COMMAND, PSMOUSE_RST, 3 };\r\nser_dev = devm_kzalloc(&pdev->dev, sizeof(struct serio), GFP_KERNEL);\r\nif (ser_dev == NULL)\r\nreturn -ENOMEM;\r\nser_dev->id.type = SERIO_PS_PSTHRU;\r\nser_dev->write = ps2_sendcommand;\r\nser_dev->start = ps2_startstreaming;\r\nser_dev->stop = ps2_stopstreaming;\r\nstrlcpy(ser_dev->name, "nvec mouse", sizeof(ser_dev->name));\r\nstrlcpy(ser_dev->phys, "nvec", sizeof(ser_dev->phys));\r\nps2_dev.ser_dev = ser_dev;\r\nps2_dev.notifier.notifier_call = nvec_ps2_notifier;\r\nps2_dev.nvec = nvec;\r\nnvec_register_notifier(nvec, &ps2_dev.notifier, 0);\r\nserio_register_port(ser_dev);\r\nnvec_write_async(nvec, mouse_reset, sizeof(mouse_reset));\r\nreturn 0;\r\n}\r\nstatic int nvec_mouse_remove(struct platform_device *pdev)\r\n{\r\nstruct nvec_chip *nvec = dev_get_drvdata(pdev->dev.parent);\r\nps2_sendcommand(ps2_dev.ser_dev, DISABLE_MOUSE);\r\nps2_stopstreaming(ps2_dev.ser_dev);\r\nnvec_unregister_notifier(nvec, &ps2_dev.notifier);\r\nserio_unregister_port(ps2_dev.ser_dev);\r\nreturn 0;\r\n}\r\nstatic int nvec_mouse_suspend(struct device *dev)\r\n{\r\nps2_sendcommand(ps2_dev.ser_dev, DISABLE_MOUSE);\r\nps2_stopstreaming(ps2_dev.ser_dev);\r\nreturn 0;\r\n}\r\nstatic int nvec_mouse_resume(struct device *dev)\r\n{\r\nps2_startstreaming(ps2_dev.ser_dev);\r\nps2_sendcommand(ps2_dev.ser_dev, ENABLE_MOUSE);\r\nreturn 0;\r\n}

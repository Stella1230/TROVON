static int cfag12864b_init(char *path)\r\n{\r\ncfag12864b_fd = open(path, O_RDWR);\r\nif (cfag12864b_fd == -1)\r\nreturn -1;\r\ncfag12864b_mem = mmap(0, CFAG12864B_SIZE, PROT_READ | PROT_WRITE,\r\nMAP_SHARED, cfag12864b_fd, 0);\r\nif (cfag12864b_mem == MAP_FAILED) {\r\nclose(cfag12864b_fd);\r\nreturn -2;\r\n}\r\nreturn 0;\r\n}\r\nstatic void cfag12864b_exit(void)\r\n{\r\nmunmap(cfag12864b_mem, CFAG12864B_SIZE);\r\nclose(cfag12864b_fd);\r\n}\r\nstatic void cfag12864b_set(unsigned char x, unsigned char y)\r\n{\r\nif (CFAG12864B_CHECK(x, y))\r\ncfag12864b_buffer[CFAG12864B_ADDRESS(x, y)] |=\r\nCFAG12864B_BIT(x % CFAG12864B_BPB);\r\n}\r\nstatic void cfag12864b_unset(unsigned char x, unsigned char y)\r\n{\r\nif (CFAG12864B_CHECK(x, y))\r\ncfag12864b_buffer[CFAG12864B_ADDRESS(x, y)] &=\r\n~CFAG12864B_BIT(x % CFAG12864B_BPB);\r\n}\r\nstatic unsigned char cfag12864b_isset(unsigned char x, unsigned char y)\r\n{\r\nif (CFAG12864B_CHECK(x, y))\r\nif (cfag12864b_buffer[CFAG12864B_ADDRESS(x, y)] &\r\nCFAG12864B_BIT(x % CFAG12864B_BPB))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void cfag12864b_not(unsigned char x, unsigned char y)\r\n{\r\nif (cfag12864b_isset(x, y))\r\ncfag12864b_unset(x, y);\r\nelse\r\ncfag12864b_set(x, y);\r\n}\r\nstatic void cfag12864b_fill(void)\r\n{\r\nunsigned short i;\r\nfor (i = 0; i < CFAG12864B_SIZE; i++)\r\ncfag12864b_buffer[i] = 0xFF;\r\n}\r\nstatic void cfag12864b_clear(void)\r\n{\r\nunsigned short i;\r\nfor (i = 0; i < CFAG12864B_SIZE; i++)\r\ncfag12864b_buffer[i] = 0;\r\n}\r\nstatic void cfag12864b_format(unsigned char * matrix)\r\n{\r\nunsigned char i, j, n;\r\nfor (i = 0; i < CFAG12864B_HEIGHT; i++)\r\nfor (j = 0; j < CFAG12864B_WIDTH / CFAG12864B_BPB; j++) {\r\ncfag12864b_buffer[i * CFAG12864B_WIDTH / CFAG12864B_BPB +\r\nj] = 0;\r\nfor (n = 0; n < CFAG12864B_BPB; n++)\r\nif (matrix[i * CFAG12864B_WIDTH +\r\nj * CFAG12864B_BPB + n])\r\ncfag12864b_buffer[i * CFAG12864B_WIDTH /\r\nCFAG12864B_BPB + j] |=\r\nCFAG12864B_BIT(n);\r\n}\r\n}\r\nstatic void cfag12864b_blit(void)\r\n{\r\nmemcpy(cfag12864b_mem, cfag12864b_buffer, CFAG12864B_SIZE);\r\n}\r\nstatic void example(unsigned char n)\r\n{\r\nunsigned short i, j;\r\nunsigned char matrix[CFAG12864B_WIDTH * CFAG12864B_HEIGHT];\r\nif (n > EXAMPLES)\r\nreturn;\r\nprintf("Example %i/%i - ", n, EXAMPLES);\r\nswitch (n) {\r\ncase 1:\r\nprintf("Draw points setting bits");\r\ncfag12864b_clear();\r\nfor (i = 0; i < CFAG12864B_WIDTH; i += 2)\r\nfor (j = 0; j < CFAG12864B_HEIGHT; j += 2)\r\ncfag12864b_set(i, j);\r\nbreak;\r\ncase 2:\r\nprintf("Clear the LCD");\r\ncfag12864b_clear();\r\nbreak;\r\ncase 3:\r\nprintf("Draw rows formatting a [128*64] matrix");\r\nmemset(matrix, 0, CFAG12864B_WIDTH * CFAG12864B_HEIGHT);\r\nfor (i = 0; i < CFAG12864B_WIDTH; i++)\r\nfor (j = 0; j < CFAG12864B_HEIGHT; j += 2)\r\nmatrix[j * CFAG12864B_WIDTH + i] = 1;\r\ncfag12864b_format(matrix);\r\nbreak;\r\ncase 4:\r\nprintf("Fill the lcd");\r\ncfag12864b_fill();\r\nbreak;\r\ncase 5:\r\nprintf("Draw columns unsetting bits");\r\nfor (i = 0; i < CFAG12864B_WIDTH; i += 2)\r\nfor (j = 0; j < CFAG12864B_HEIGHT; j++)\r\ncfag12864b_unset(i, j);\r\nbreak;\r\ncase 6:\r\nprintf("Do negative not-ing all bits");\r\nfor (i = 0; i < CFAG12864B_WIDTH; i++)\r\nfor (j = 0; j < CFAG12864B_HEIGHT; j ++)\r\ncfag12864b_not(i, j);\r\nbreak;\r\n}\r\nputs(" - [Press Enter]");\r\n}\r\nint main(int argc, char *argv[])\r\n{\r\nunsigned char n;\r\nif (argc != 2) {\r\nprintf(\r\n"Sintax: %s fbdev\n"\r\n"Usually: /dev/fb0, /dev/fb1...\n", argv[0]);\r\nreturn -1;\r\n}\r\nif (cfag12864b_init(argv[1])) {\r\nprintf("Can't init %s fbdev\n", argv[1]);\r\nreturn -2;\r\n}\r\nfor (n = 1; n <= EXAMPLES; n++) {\r\nexample(n);\r\ncfag12864b_blit();\r\nwhile (getchar() != '\n');\r\n}\r\ncfag12864b_exit();\r\nreturn 0;\r\n}

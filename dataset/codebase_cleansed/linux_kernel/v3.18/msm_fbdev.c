static int msm_fbdev_mmap(struct fb_info *info, struct vm_area_struct *vma)\r\n{\r\nstruct drm_fb_helper *helper = (struct drm_fb_helper *)info->par;\r\nstruct msm_fbdev *fbdev = to_msm_fbdev(helper);\r\nstruct drm_gem_object *drm_obj = fbdev->bo;\r\nstruct drm_device *dev = helper->dev;\r\nint ret = 0;\r\nif (drm_device_is_unplugged(dev))\r\nreturn -ENODEV;\r\nmutex_lock(&dev->struct_mutex);\r\nret = drm_gem_mmap_obj(drm_obj, drm_obj->size, vma);\r\nmutex_unlock(&dev->struct_mutex);\r\nif (ret) {\r\npr_err("%s:drm_gem_mmap_obj fail\n", __func__);\r\nreturn ret;\r\n}\r\nreturn msm_gem_mmap_obj(drm_obj, vma);\r\n}\r\nstatic int msm_fbdev_create(struct drm_fb_helper *helper,\r\nstruct drm_fb_helper_surface_size *sizes)\r\n{\r\nstruct msm_fbdev *fbdev = to_msm_fbdev(helper);\r\nstruct drm_device *dev = helper->dev;\r\nstruct drm_framebuffer *fb = NULL;\r\nstruct fb_info *fbi = NULL;\r\nstruct drm_mode_fb_cmd2 mode_cmd = {0};\r\nuint32_t paddr;\r\nint ret, size;\r\nsizes->surface_bpp = 32;\r\nsizes->surface_depth = 24;\r\nDBG("create fbdev: %dx%d@%d (%dx%d)", sizes->surface_width,\r\nsizes->surface_height, sizes->surface_bpp,\r\nsizes->fb_width, sizes->fb_height);\r\nmode_cmd.pixel_format = drm_mode_legacy_fb_format(sizes->surface_bpp,\r\nsizes->surface_depth);\r\nmode_cmd.width = sizes->surface_width;\r\nmode_cmd.height = sizes->surface_height;\r\nmode_cmd.pitches[0] = align_pitch(\r\nmode_cmd.width, sizes->surface_bpp);\r\nsize = mode_cmd.pitches[0] * mode_cmd.height;\r\nDBG("allocating %d bytes for fb %d", size, dev->primary->index);\r\nmutex_lock(&dev->struct_mutex);\r\nfbdev->bo = msm_gem_new(dev, size, MSM_BO_SCANOUT | MSM_BO_WC);\r\nmutex_unlock(&dev->struct_mutex);\r\nif (IS_ERR(fbdev->bo)) {\r\nret = PTR_ERR(fbdev->bo);\r\nfbdev->bo = NULL;\r\ndev_err(dev->dev, "failed to allocate buffer object: %d\n", ret);\r\ngoto fail;\r\n}\r\nfb = msm_framebuffer_init(dev, &mode_cmd, &fbdev->bo);\r\nif (IS_ERR(fb)) {\r\ndev_err(dev->dev, "failed to allocate fb\n");\r\ndrm_gem_object_unreference(fbdev->bo);\r\nret = PTR_ERR(fb);\r\ngoto fail;\r\n}\r\nmutex_lock(&dev->struct_mutex);\r\nret = msm_gem_get_iova_locked(fbdev->bo, 0, &paddr);\r\nif (ret) {\r\ndev_err(dev->dev, "failed to get buffer obj iova: %d\n", ret);\r\ngoto fail_unlock;\r\n}\r\nfbi = framebuffer_alloc(0, dev->dev);\r\nif (!fbi) {\r\ndev_err(dev->dev, "failed to allocate fb info\n");\r\nret = -ENOMEM;\r\ngoto fail_unlock;\r\n}\r\nDBG("fbi=%p, dev=%p", fbi, dev);\r\nfbdev->fb = fb;\r\nhelper->fb = fb;\r\nhelper->fbdev = fbi;\r\nfbi->par = helper;\r\nfbi->flags = FBINFO_DEFAULT;\r\nfbi->fbops = &msm_fb_ops;\r\nstrcpy(fbi->fix.id, "msm");\r\nret = fb_alloc_cmap(&fbi->cmap, 256, 0);\r\nif (ret) {\r\nret = -ENOMEM;\r\ngoto fail_unlock;\r\n}\r\ndrm_fb_helper_fill_fix(fbi, fb->pitches[0], fb->depth);\r\ndrm_fb_helper_fill_var(fbi, helper, sizes->fb_width, sizes->fb_height);\r\ndev->mode_config.fb_base = paddr;\r\nfbi->screen_base = msm_gem_vaddr_locked(fbdev->bo);\r\nfbi->screen_size = fbdev->bo->size;\r\nfbi->fix.smem_start = paddr;\r\nfbi->fix.smem_len = fbdev->bo->size;\r\nDBG("par=%p, %dx%d", fbi->par, fbi->var.xres, fbi->var.yres);\r\nDBG("allocated %dx%d fb", fbdev->fb->width, fbdev->fb->height);\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn 0;\r\nfail_unlock:\r\nmutex_unlock(&dev->struct_mutex);\r\nfail:\r\nif (ret) {\r\nif (fbi)\r\nframebuffer_release(fbi);\r\nif (fb) {\r\ndrm_framebuffer_unregister_private(fb);\r\ndrm_framebuffer_remove(fb);\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic void msm_crtc_fb_gamma_set(struct drm_crtc *crtc,\r\nu16 red, u16 green, u16 blue, int regno)\r\n{\r\nDBG("fbdev: set gamma");\r\n}\r\nstatic void msm_crtc_fb_gamma_get(struct drm_crtc *crtc,\r\nu16 *red, u16 *green, u16 *blue, int regno)\r\n{\r\nDBG("fbdev: get gamma");\r\n}\r\nstruct drm_fb_helper *msm_fbdev_init(struct drm_device *dev)\r\n{\r\nstruct msm_drm_private *priv = dev->dev_private;\r\nstruct msm_fbdev *fbdev = NULL;\r\nstruct drm_fb_helper *helper;\r\nint ret;\r\nfbdev = kzalloc(sizeof(*fbdev), GFP_KERNEL);\r\nif (!fbdev)\r\ngoto fail;\r\nhelper = &fbdev->base;\r\ndrm_fb_helper_prepare(dev, helper, &msm_fb_helper_funcs);\r\nret = drm_fb_helper_init(dev, helper,\r\npriv->num_crtcs, priv->num_connectors);\r\nif (ret) {\r\ndev_err(dev->dev, "could not init fbdev: ret=%d\n", ret);\r\ngoto fail;\r\n}\r\ndrm_fb_helper_single_add_all_connectors(helper);\r\ndrm_helper_disable_unused_functions(dev);\r\ndrm_fb_helper_initial_config(helper, 32);\r\npriv->fbdev = helper;\r\nreturn helper;\r\nfail:\r\nkfree(fbdev);\r\nreturn NULL;\r\n}\r\nvoid msm_fbdev_free(struct drm_device *dev)\r\n{\r\nstruct msm_drm_private *priv = dev->dev_private;\r\nstruct drm_fb_helper *helper = priv->fbdev;\r\nstruct msm_fbdev *fbdev;\r\nstruct fb_info *fbi;\r\nDBG();\r\nfbi = helper->fbdev;\r\nif (fbi) {\r\nunregister_framebuffer(fbi);\r\nframebuffer_release(fbi);\r\n}\r\ndrm_fb_helper_fini(helper);\r\nfbdev = to_msm_fbdev(priv->fbdev);\r\nif (fbdev->fb) {\r\ndrm_framebuffer_unregister_private(fbdev->fb);\r\ndrm_framebuffer_remove(fbdev->fb);\r\n}\r\nkfree(fbdev);\r\npriv->fbdev = NULL;\r\n}

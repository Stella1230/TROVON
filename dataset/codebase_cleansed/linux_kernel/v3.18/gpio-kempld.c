static void kempld_gpio_bitop(struct kempld_device_data *pld,\r\nu8 reg, u8 bit, u8 val)\r\n{\r\nu8 status;\r\nstatus = kempld_read8(pld, reg);\r\nif (val)\r\nstatus |= KEMPLD_GPIO_MASK(bit);\r\nelse\r\nstatus &= ~KEMPLD_GPIO_MASK(bit);\r\nkempld_write8(pld, reg, status);\r\n}\r\nstatic int kempld_gpio_get_bit(struct kempld_device_data *pld, u8 reg, u8 bit)\r\n{\r\nu8 status;\r\nkempld_get_mutex(pld);\r\nstatus = kempld_read8(pld, reg);\r\nkempld_release_mutex(pld);\r\nreturn !!(status & KEMPLD_GPIO_MASK(bit));\r\n}\r\nstatic int kempld_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct kempld_gpio_data *gpio\r\n= container_of(chip, struct kempld_gpio_data, chip);\r\nstruct kempld_device_data *pld = gpio->pld;\r\nreturn kempld_gpio_get_bit(pld, KEMPLD_GPIO_LVL_NUM(offset), offset);\r\n}\r\nstatic void kempld_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nstruct kempld_gpio_data *gpio\r\n= container_of(chip, struct kempld_gpio_data, chip);\r\nstruct kempld_device_data *pld = gpio->pld;\r\nkempld_get_mutex(pld);\r\nkempld_gpio_bitop(pld, KEMPLD_GPIO_LVL_NUM(offset), offset, value);\r\nkempld_release_mutex(pld);\r\n}\r\nstatic int kempld_gpio_direction_input(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct kempld_gpio_data *gpio\r\n= container_of(chip, struct kempld_gpio_data, chip);\r\nstruct kempld_device_data *pld = gpio->pld;\r\nkempld_get_mutex(pld);\r\nkempld_gpio_bitop(pld, KEMPLD_GPIO_DIR_NUM(offset), offset, 0);\r\nkempld_release_mutex(pld);\r\nreturn 0;\r\n}\r\nstatic int kempld_gpio_direction_output(struct gpio_chip *chip, unsigned offset,\r\nint value)\r\n{\r\nstruct kempld_gpio_data *gpio\r\n= container_of(chip, struct kempld_gpio_data, chip);\r\nstruct kempld_device_data *pld = gpio->pld;\r\nkempld_get_mutex(pld);\r\nkempld_gpio_bitop(pld, KEMPLD_GPIO_LVL_NUM(offset), offset, value);\r\nkempld_gpio_bitop(pld, KEMPLD_GPIO_DIR_NUM(offset), offset, 1);\r\nkempld_release_mutex(pld);\r\nreturn 0;\r\n}\r\nstatic int kempld_gpio_get_direction(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct kempld_gpio_data *gpio\r\n= container_of(chip, struct kempld_gpio_data, chip);\r\nstruct kempld_device_data *pld = gpio->pld;\r\nreturn kempld_gpio_get_bit(pld, KEMPLD_GPIO_DIR_NUM(offset), offset);\r\n}\r\nstatic int kempld_gpio_pincount(struct kempld_device_data *pld)\r\n{\r\nu16 evt, evt_back;\r\nkempld_get_mutex(pld);\r\nevt_back = kempld_read16(pld, KEMPLD_GPIO_EVT_LVL_EDGE);\r\nkempld_write16(pld, KEMPLD_GPIO_EVT_LVL_EDGE, 0x0000);\r\nevt = kempld_read16(pld, KEMPLD_GPIO_EVT_LVL_EDGE);\r\nkempld_write16(pld, KEMPLD_GPIO_EVT_LVL_EDGE, evt_back);\r\nkempld_release_mutex(pld);\r\nreturn evt ? __ffs(evt) : 16;\r\n}\r\nstatic int kempld_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct kempld_device_data *pld = dev_get_drvdata(dev->parent);\r\nstruct kempld_platform_data *pdata = dev_get_platdata(pld->dev);\r\nstruct kempld_gpio_data *gpio;\r\nstruct gpio_chip *chip;\r\nint ret;\r\nif (pld->info.spec_major < 2) {\r\ndev_err(dev,\r\n"Driver only supports GPIO devices compatible to PLD spec. rev. 2.0 or higher\n");\r\nreturn -ENODEV;\r\n}\r\ngpio = devm_kzalloc(dev, sizeof(*gpio), GFP_KERNEL);\r\nif (gpio == NULL)\r\nreturn -ENOMEM;\r\ngpio->pld = pld;\r\nplatform_set_drvdata(pdev, gpio);\r\nchip = &gpio->chip;\r\nchip->label = "gpio-kempld";\r\nchip->owner = THIS_MODULE;\r\nchip->dev = dev;\r\nchip->can_sleep = true;\r\nif (pdata && pdata->gpio_base)\r\nchip->base = pdata->gpio_base;\r\nelse\r\nchip->base = -1;\r\nchip->direction_input = kempld_gpio_direction_input;\r\nchip->direction_output = kempld_gpio_direction_output;\r\nchip->get_direction = kempld_gpio_get_direction;\r\nchip->get = kempld_gpio_get;\r\nchip->set = kempld_gpio_set;\r\nchip->ngpio = kempld_gpio_pincount(pld);\r\nif (chip->ngpio == 0) {\r\ndev_err(dev, "No GPIO pins detected\n");\r\nreturn -ENODEV;\r\n}\r\nret = gpiochip_add(chip);\r\nif (ret) {\r\ndev_err(dev, "Could not register GPIO chip\n");\r\nreturn ret;\r\n}\r\ndev_info(dev, "GPIO functionality initialized with %d pins\n",\r\nchip->ngpio);\r\nreturn 0;\r\n}\r\nstatic int kempld_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct kempld_gpio_data *gpio = platform_get_drvdata(pdev);\r\ngpiochip_remove(&gpio->chip);\r\nreturn 0;\r\n}

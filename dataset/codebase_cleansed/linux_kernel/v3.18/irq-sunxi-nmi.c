static inline void sunxi_sc_nmi_write(struct irq_chip_generic *gc, u32 off,\r\nu32 val)\r\n{\r\nirq_reg_writel(val, gc->reg_base + off);\r\n}\r\nstatic inline u32 sunxi_sc_nmi_read(struct irq_chip_generic *gc, u32 off)\r\n{\r\nreturn irq_reg_readl(gc->reg_base + off);\r\n}\r\nstatic void sunxi_sc_nmi_handle_irq(unsigned int irq, struct irq_desc *desc)\r\n{\r\nstruct irq_domain *domain = irq_desc_get_handler_data(desc);\r\nstruct irq_chip *chip = irq_get_chip(irq);\r\nunsigned int virq = irq_find_mapping(domain, 0);\r\nchained_irq_enter(chip, desc);\r\ngeneric_handle_irq(virq);\r\nchained_irq_exit(chip, desc);\r\n}\r\nstatic int sunxi_sc_nmi_set_type(struct irq_data *data, unsigned int flow_type)\r\n{\r\nstruct irq_chip_generic *gc = irq_data_get_irq_chip_data(data);\r\nstruct irq_chip_type *ct = gc->chip_types;\r\nu32 src_type_reg;\r\nu32 ctrl_off = ct->regs.type;\r\nunsigned int src_type;\r\nunsigned int i;\r\nirq_gc_lock(gc);\r\nswitch (flow_type & IRQF_TRIGGER_MASK) {\r\ncase IRQ_TYPE_EDGE_FALLING:\r\nsrc_type = SUNXI_SRC_TYPE_EDGE_FALLING;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_RISING:\r\nsrc_type = SUNXI_SRC_TYPE_EDGE_RISING;\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_HIGH:\r\nsrc_type = SUNXI_SRC_TYPE_LEVEL_HIGH;\r\nbreak;\r\ncase IRQ_TYPE_NONE:\r\ncase IRQ_TYPE_LEVEL_LOW:\r\nsrc_type = SUNXI_SRC_TYPE_LEVEL_LOW;\r\nbreak;\r\ndefault:\r\nirq_gc_unlock(gc);\r\npr_err("%s: Cannot assign multiple trigger modes to IRQ %d.\n",\r\n__func__, data->irq);\r\nreturn -EBADR;\r\n}\r\nirqd_set_trigger_type(data, flow_type);\r\nirq_setup_alt_chip(data, flow_type);\r\nfor (i = 0; i <= gc->num_ct; i++, ct++)\r\nif (ct->type & flow_type)\r\nctrl_off = ct->regs.type;\r\nsrc_type_reg = sunxi_sc_nmi_read(gc, ctrl_off);\r\nsrc_type_reg &= ~SUNXI_NMI_SRC_TYPE_MASK;\r\nsrc_type_reg |= src_type;\r\nsunxi_sc_nmi_write(gc, ctrl_off, src_type_reg);\r\nirq_gc_unlock(gc);\r\nreturn IRQ_SET_MASK_OK;\r\n}\r\nstatic int __init sunxi_sc_nmi_irq_init(struct device_node *node,\r\nstruct sunxi_sc_nmi_reg_offs *reg_offs)\r\n{\r\nstruct irq_domain *domain;\r\nstruct irq_chip_generic *gc;\r\nunsigned int irq;\r\nunsigned int clr = IRQ_NOREQUEST | IRQ_NOPROBE | IRQ_NOAUTOEN;\r\nint ret;\r\ndomain = irq_domain_add_linear(node, 1, &irq_generic_chip_ops, NULL);\r\nif (!domain) {\r\npr_err("%s: Could not register interrupt domain.\n", node->name);\r\nreturn -ENOMEM;\r\n}\r\nret = irq_alloc_domain_generic_chips(domain, 1, 2, node->name,\r\nhandle_fasteoi_irq, clr, 0,\r\nIRQ_GC_INIT_MASK_CACHE);\r\nif (ret) {\r\npr_err("%s: Could not allocate generic interrupt chip.\n",\r\nnode->name);\r\ngoto fail_irqd_remove;\r\n}\r\nirq = irq_of_parse_and_map(node, 0);\r\nif (irq <= 0) {\r\npr_err("%s: unable to parse irq\n", node->name);\r\nret = -EINVAL;\r\ngoto fail_irqd_remove;\r\n}\r\ngc = irq_get_domain_generic_chip(domain, 0);\r\ngc->reg_base = of_iomap(node, 0);\r\nif (!gc->reg_base) {\r\npr_err("%s: unable to map resource\n", node->name);\r\nret = -ENOMEM;\r\ngoto fail_irqd_remove;\r\n}\r\ngc->chip_types[0].type = IRQ_TYPE_LEVEL_MASK;\r\ngc->chip_types[0].chip.irq_mask = irq_gc_mask_clr_bit;\r\ngc->chip_types[0].chip.irq_unmask = irq_gc_mask_set_bit;\r\ngc->chip_types[0].chip.irq_eoi = irq_gc_ack_set_bit;\r\ngc->chip_types[0].chip.irq_set_type = sunxi_sc_nmi_set_type;\r\ngc->chip_types[0].chip.flags = IRQCHIP_EOI_THREADED | IRQCHIP_EOI_IF_HANDLED;\r\ngc->chip_types[0].regs.ack = reg_offs->pend;\r\ngc->chip_types[0].regs.mask = reg_offs->enable;\r\ngc->chip_types[0].regs.type = reg_offs->ctrl;\r\ngc->chip_types[1].type = IRQ_TYPE_EDGE_BOTH;\r\ngc->chip_types[1].chip.name = gc->chip_types[0].chip.name;\r\ngc->chip_types[1].chip.irq_ack = irq_gc_ack_set_bit;\r\ngc->chip_types[1].chip.irq_mask = irq_gc_mask_clr_bit;\r\ngc->chip_types[1].chip.irq_unmask = irq_gc_mask_set_bit;\r\ngc->chip_types[1].chip.irq_set_type = sunxi_sc_nmi_set_type;\r\ngc->chip_types[1].regs.ack = reg_offs->pend;\r\ngc->chip_types[1].regs.mask = reg_offs->enable;\r\ngc->chip_types[1].regs.type = reg_offs->ctrl;\r\ngc->chip_types[1].handler = handle_edge_irq;\r\nsunxi_sc_nmi_write(gc, reg_offs->enable, 0);\r\nsunxi_sc_nmi_write(gc, reg_offs->pend, 0x1);\r\nirq_set_handler_data(irq, domain);\r\nirq_set_chained_handler(irq, sunxi_sc_nmi_handle_irq);\r\nreturn 0;\r\nfail_irqd_remove:\r\nirq_domain_remove(domain);\r\nreturn ret;\r\n}\r\nstatic int __init sun6i_sc_nmi_irq_init(struct device_node *node,\r\nstruct device_node *parent)\r\n{\r\nreturn sunxi_sc_nmi_irq_init(node, &sun6i_reg_offs);\r\n}\r\nstatic int __init sun7i_sc_nmi_irq_init(struct device_node *node,\r\nstruct device_node *parent)\r\n{\r\nreturn sunxi_sc_nmi_irq_init(node, &sun7i_reg_offs);\r\n}

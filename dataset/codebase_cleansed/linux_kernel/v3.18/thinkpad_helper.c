static acpi_status acpi_check_cb(acpi_handle handle, u32 lvl, void *context,\r\nvoid **rv)\r\n{\r\nbool *found = context;\r\n*found = true;\r\nreturn AE_OK;\r\n}\r\nstatic bool is_thinkpad(struct hda_codec *codec)\r\n{\r\nbool found = false;\r\nif (codec->subsystem_id >> 16 != 0x17aa)\r\nreturn false;\r\nif (ACPI_SUCCESS(acpi_get_devices("LEN0068", acpi_check_cb, &found, NULL)) && found)\r\nreturn true;\r\nfound = false;\r\nreturn ACPI_SUCCESS(acpi_get_devices("IBM0068", acpi_check_cb, &found, NULL)) && found;\r\n}\r\nstatic void update_tpacpi_mute_led(void *private_data, int enabled)\r\n{\r\nif (old_vmaster_hook)\r\nold_vmaster_hook(private_data, enabled);\r\nif (led_set_func)\r\nled_set_func(TPACPI_LED_MUTE, !enabled);\r\n}\r\nstatic void update_tpacpi_micmute_led(struct hda_codec *codec,\r\nstruct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nif (!ucontrol || !led_set_func)\r\nreturn;\r\nif (strcmp("Capture Switch", ucontrol->id.name) == 0 && ucontrol->id.index == 0) {\r\nbool val = ucontrol->value.integer.value[0] || ucontrol->value.integer.value[1];\r\nled_set_func(TPACPI_LED_MICMUTE, !val);\r\n}\r\n}\r\nstatic void hda_fixup_thinkpad_acpi(struct hda_codec *codec,\r\nconst struct hda_fixup *fix, int action)\r\n{\r\nstruct hda_gen_spec *spec = codec->spec;\r\nbool removefunc = false;\r\nif (action == HDA_FIXUP_ACT_PROBE) {\r\nif (!is_thinkpad(codec))\r\nreturn;\r\nif (!led_set_func)\r\nled_set_func = symbol_request(tpacpi_led_set);\r\nif (!led_set_func) {\r\ncodec_warn(codec,\r\n"Failed to find thinkpad-acpi symbol tpacpi_led_set\n");\r\nreturn;\r\n}\r\nremovefunc = true;\r\nif (led_set_func(TPACPI_LED_MUTE, false) >= 0) {\r\nold_vmaster_hook = spec->vmaster_mute.hook;\r\nspec->vmaster_mute.hook = update_tpacpi_mute_led;\r\nremovefunc = false;\r\n}\r\nif (led_set_func(TPACPI_LED_MICMUTE, false) >= 0) {\r\nif (spec->num_adc_nids > 1)\r\ncodec_dbg(codec,\r\n"Skipping micmute LED control due to several ADCs");\r\nelse {\r\nspec->cap_sync_hook = update_tpacpi_micmute_led;\r\nremovefunc = false;\r\n}\r\n}\r\n}\r\nif (led_set_func && (action == HDA_FIXUP_ACT_FREE || removefunc)) {\r\nsymbol_put(tpacpi_led_set);\r\nled_set_func = NULL;\r\nold_vmaster_hook = NULL;\r\n}\r\n}\r\nstatic void hda_fixup_thinkpad_acpi(struct hda_codec *codec,\r\nconst struct hda_fixup *fix, int action)\r\n{\r\n}

void local_flush_tlb_one(unsigned long asid, unsigned long page)\r\n{\r\nunsigned long long match, pteh=0, lpage;\r\nunsigned long tlb;\r\nlpage = neff_sign_extend(page);\r\nmatch = (asid << PTEH_ASID_SHIFT) | PTEH_VALID;\r\nmatch |= lpage;\r\nfor_each_itlb_entry(tlb) {\r\nasm volatile ("getcfg %1, 0, %0"\r\n: "=r" (pteh)\r\n: "r" (tlb) );\r\nif (pteh == match) {\r\n__flush_tlb_slot(tlb);\r\nbreak;\r\n}\r\n}\r\nfor_each_dtlb_entry(tlb) {\r\nasm volatile ("getcfg %1, 0, %0"\r\n: "=r" (pteh)\r\n: "r" (tlb) );\r\nif (pteh == match) {\r\n__flush_tlb_slot(tlb);\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid local_flush_tlb_page(struct vm_area_struct *vma, unsigned long page)\r\n{\r\nunsigned long flags;\r\nif (vma->vm_mm) {\r\npage &= PAGE_MASK;\r\nlocal_irq_save(flags);\r\nlocal_flush_tlb_one(get_asid(), page);\r\nlocal_irq_restore(flags);\r\n}\r\n}\r\nvoid local_flush_tlb_range(struct vm_area_struct *vma, unsigned long start,\r\nunsigned long end)\r\n{\r\nunsigned long flags;\r\nunsigned long long match, pteh=0, pteh_epn, pteh_low;\r\nunsigned long tlb;\r\nunsigned int cpu = smp_processor_id();\r\nstruct mm_struct *mm;\r\nmm = vma->vm_mm;\r\nif (cpu_context(cpu, mm) == NO_CONTEXT)\r\nreturn;\r\nlocal_irq_save(flags);\r\nstart &= PAGE_MASK;\r\nend &= PAGE_MASK;\r\nmatch = (cpu_asid(cpu, mm) << PTEH_ASID_SHIFT) | PTEH_VALID;\r\nfor_each_itlb_entry(tlb) {\r\nasm volatile ("getcfg %1, 0, %0"\r\n: "=r" (pteh)\r\n: "r" (tlb) );\r\npteh_epn = pteh & PAGE_MASK;\r\npteh_low = pteh & ~PAGE_MASK;\r\nif (pteh_low == match && pteh_epn >= start && pteh_epn <= end)\r\n__flush_tlb_slot(tlb);\r\n}\r\nfor_each_dtlb_entry(tlb) {\r\nasm volatile ("getcfg %1, 0, %0"\r\n: "=r" (pteh)\r\n: "r" (tlb) );\r\npteh_epn = pteh & PAGE_MASK;\r\npteh_low = pteh & ~PAGE_MASK;\r\nif (pteh_low == match && pteh_epn >= start && pteh_epn <= end)\r\n__flush_tlb_slot(tlb);\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\nvoid local_flush_tlb_mm(struct mm_struct *mm)\r\n{\r\nunsigned long flags;\r\nunsigned int cpu = smp_processor_id();\r\nif (cpu_context(cpu, mm) == NO_CONTEXT)\r\nreturn;\r\nlocal_irq_save(flags);\r\ncpu_context(cpu, mm) = NO_CONTEXT;\r\nif (mm == current->mm)\r\nactivate_context(mm, cpu);\r\nlocal_irq_restore(flags);\r\n}\r\nvoid local_flush_tlb_all(void)\r\n{\r\nunsigned long flags, tlb;\r\nlocal_irq_save(flags);\r\nfor_each_itlb_entry(tlb)\r\n__flush_tlb_slot(tlb);\r\nfor_each_dtlb_entry(tlb)\r\n__flush_tlb_slot(tlb);\r\nlocal_irq_restore(flags);\r\n}\r\nvoid local_flush_tlb_kernel_range(unsigned long start, unsigned long end)\r\n{\r\nflush_tlb_all();\r\n}\r\nvoid __flush_tlb_global(void)\r\n{\r\nflush_tlb_all();\r\n}

void do_remaining_work(struct rtsx_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &(chip->sd_card);\r\n#ifdef XD_DELAY_WRITE\r\nstruct xd_info *xd_card = &(chip->xd_card);\r\n#endif\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nif (chip->card_ready & SD_CARD) {\r\nif (sd_card->seq_mode) {\r\nrtsx_set_stat(chip, RTSX_STAT_RUN);\r\nsd_card->cleanup_counter++;\r\n} else {\r\nsd_card->cleanup_counter = 0;\r\n}\r\n}\r\n#ifdef XD_DELAY_WRITE\r\nif (chip->card_ready & XD_CARD) {\r\nif (xd_card->delay_write.delay_write_flag) {\r\nrtsx_set_stat(chip, RTSX_STAT_RUN);\r\nxd_card->cleanup_counter++;\r\n} else {\r\nxd_card->cleanup_counter = 0;\r\n}\r\n}\r\n#endif\r\nif (chip->card_ready & MS_CARD) {\r\nif (CHK_MSPRO(ms_card)) {\r\nif (ms_card->seq_mode) {\r\nrtsx_set_stat(chip, RTSX_STAT_RUN);\r\nms_card->cleanup_counter++;\r\n} else {\r\nms_card->cleanup_counter = 0;\r\n}\r\n} else {\r\n#ifdef MS_DELAY_WRITE\r\nif (ms_card->delay_write.delay_write_flag) {\r\nrtsx_set_stat(chip, RTSX_STAT_RUN);\r\nms_card->cleanup_counter++;\r\n} else {\r\nms_card->cleanup_counter = 0;\r\n}\r\n#endif\r\n}\r\n}\r\nif (sd_card->cleanup_counter > POLLING_WAIT_CNT)\r\nsd_cleanup_work(chip);\r\nif (xd_card->cleanup_counter > POLLING_WAIT_CNT)\r\nxd_cleanup_work(chip);\r\nif (ms_card->cleanup_counter > POLLING_WAIT_CNT)\r\nms_cleanup_work(chip);\r\n}\r\nvoid try_to_switch_sdio_ctrl(struct rtsx_chip *chip)\r\n{\r\nu8 reg1 = 0, reg2 = 0;\r\nrtsx_read_register(chip, 0xFF34, &reg1);\r\nrtsx_read_register(chip, 0xFF38, &reg2);\r\ndev_dbg(rtsx_dev(chip), "reg 0xFF34: 0x%x, reg 0xFF38: 0x%x\n",\r\nreg1, reg2);\r\nif ((reg1 & 0xC0) && (reg2 & 0xC0)) {\r\nchip->sd_int = 1;\r\nrtsx_write_register(chip, SDIO_CTRL, 0xFF,\r\nSDIO_BUS_CTRL | SDIO_CD_CTRL);\r\nrtsx_write_register(chip, PWR_GATE_CTRL,\r\nLDO3318_PWR_MASK, LDO_ON);\r\n}\r\n}\r\nvoid dynamic_configure_sdio_aspm(struct rtsx_chip *chip)\r\n{\r\nu8 buf[12], reg;\r\nint i;\r\nfor (i = 0; i < 12; i++)\r\nrtsx_read_register(chip, 0xFF08 + i, &buf[i]);\r\nrtsx_read_register(chip, 0xFF25, &reg);\r\nif ((memcmp(buf, chip->sdio_raw_data, 12) != 0) || (reg & 0x03)) {\r\nchip->sdio_counter = 0;\r\nchip->sdio_idle = 0;\r\n} else {\r\nif (!chip->sdio_idle) {\r\nchip->sdio_counter++;\r\nif (chip->sdio_counter >= SDIO_IDLE_COUNT) {\r\nchip->sdio_counter = 0;\r\nchip->sdio_idle = 1;\r\n}\r\n}\r\n}\r\nmemcpy(chip->sdio_raw_data, buf, 12);\r\nif (chip->sdio_idle) {\r\nif (!chip->sdio_aspm) {\r\ndev_dbg(rtsx_dev(chip), "SDIO enter ASPM!\n");\r\nrtsx_write_register(chip, ASPM_FORCE_CTL, 0xFC,\r\n0x30 | (chip->aspm_level[1] << 2));\r\nchip->sdio_aspm = 1;\r\n}\r\n} else {\r\nif (chip->sdio_aspm) {\r\ndev_dbg(rtsx_dev(chip), "SDIO exit ASPM!\n");\r\nrtsx_write_register(chip, ASPM_FORCE_CTL, 0xFC, 0x30);\r\nchip->sdio_aspm = 0;\r\n}\r\n}\r\n}\r\nvoid do_reset_sd_card(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\ndev_dbg(rtsx_dev(chip), "%s: %d, card2lun = 0x%x\n", __func__,\r\nchip->sd_reset_counter, chip->card2lun[SD_CARD]);\r\nif (chip->card2lun[SD_CARD] >= MAX_ALLOWED_LUN_CNT) {\r\nclear_bit(SD_NR, &(chip->need_reset));\r\nchip->sd_reset_counter = 0;\r\nchip->sd_show_cnt = 0;\r\nreturn;\r\n}\r\nchip->rw_fail_cnt[chip->card2lun[SD_CARD]] = 0;\r\nrtsx_set_stat(chip, RTSX_STAT_RUN);\r\nrtsx_write_register(chip, SDIO_CTRL, 0xFF, 0);\r\nretval = reset_sd_card(chip);\r\nif (chip->need_release & SD_CARD)\r\nreturn;\r\nif (retval == STATUS_SUCCESS) {\r\nclear_bit(SD_NR, &(chip->need_reset));\r\nchip->sd_reset_counter = 0;\r\nchip->sd_show_cnt = 0;\r\nchip->card_ready |= SD_CARD;\r\nchip->card_fail &= ~SD_CARD;\r\nchip->rw_card[chip->card2lun[SD_CARD]] = sd_rw;\r\n} else {\r\nif (chip->sd_io || (chip->sd_reset_counter >= MAX_RESET_CNT)) {\r\nclear_bit(SD_NR, &(chip->need_reset));\r\nchip->sd_reset_counter = 0;\r\nchip->sd_show_cnt = 0;\r\n} else {\r\nchip->sd_reset_counter++;\r\n}\r\nchip->card_ready &= ~SD_CARD;\r\nchip->card_fail |= SD_CARD;\r\nchip->capacity[chip->card2lun[SD_CARD]] = 0;\r\nchip->rw_card[chip->card2lun[SD_CARD]] = NULL;\r\nrtsx_write_register(chip, CARD_OE, SD_OUTPUT_EN, 0);\r\nif (!chip->ft2_fast_mode)\r\ncard_power_off(chip, SD_CARD);\r\nif (chip->sd_io) {\r\nchip->sd_int = 0;\r\ntry_to_switch_sdio_ctrl(chip);\r\n} else {\r\ndisable_card_clock(chip, SD_CARD);\r\n}\r\n}\r\n}\r\nvoid do_reset_xd_card(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\ndev_dbg(rtsx_dev(chip), "%s: %d, card2lun = 0x%x\n", __func__,\r\nchip->xd_reset_counter, chip->card2lun[XD_CARD]);\r\nif (chip->card2lun[XD_CARD] >= MAX_ALLOWED_LUN_CNT) {\r\nclear_bit(XD_NR, &(chip->need_reset));\r\nchip->xd_reset_counter = 0;\r\nchip->xd_show_cnt = 0;\r\nreturn;\r\n}\r\nchip->rw_fail_cnt[chip->card2lun[XD_CARD]] = 0;\r\nrtsx_set_stat(chip, RTSX_STAT_RUN);\r\nrtsx_write_register(chip, SDIO_CTRL, 0xFF, 0);\r\nretval = reset_xd_card(chip);\r\nif (chip->need_release & XD_CARD)\r\nreturn;\r\nif (retval == STATUS_SUCCESS) {\r\nclear_bit(XD_NR, &(chip->need_reset));\r\nchip->xd_reset_counter = 0;\r\nchip->card_ready |= XD_CARD;\r\nchip->card_fail &= ~XD_CARD;\r\nchip->rw_card[chip->card2lun[XD_CARD]] = xd_rw;\r\n} else {\r\nif (chip->xd_reset_counter >= MAX_RESET_CNT) {\r\nclear_bit(XD_NR, &(chip->need_reset));\r\nchip->xd_reset_counter = 0;\r\nchip->xd_show_cnt = 0;\r\n} else {\r\nchip->xd_reset_counter++;\r\n}\r\nchip->card_ready &= ~XD_CARD;\r\nchip->card_fail |= XD_CARD;\r\nchip->capacity[chip->card2lun[XD_CARD]] = 0;\r\nchip->rw_card[chip->card2lun[XD_CARD]] = NULL;\r\nrtsx_write_register(chip, CARD_OE, XD_OUTPUT_EN, 0);\r\nif (!chip->ft2_fast_mode)\r\ncard_power_off(chip, XD_CARD);\r\ndisable_card_clock(chip, XD_CARD);\r\n}\r\n}\r\nvoid do_reset_ms_card(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\ndev_dbg(rtsx_dev(chip), "%s: %d, card2lun = 0x%x\n", __func__,\r\nchip->ms_reset_counter, chip->card2lun[MS_CARD]);\r\nif (chip->card2lun[MS_CARD] >= MAX_ALLOWED_LUN_CNT) {\r\nclear_bit(MS_NR, &(chip->need_reset));\r\nchip->ms_reset_counter = 0;\r\nchip->ms_show_cnt = 0;\r\nreturn;\r\n}\r\nchip->rw_fail_cnt[chip->card2lun[MS_CARD]] = 0;\r\nrtsx_set_stat(chip, RTSX_STAT_RUN);\r\nrtsx_write_register(chip, SDIO_CTRL, 0xFF, 0);\r\nretval = reset_ms_card(chip);\r\nif (chip->need_release & MS_CARD)\r\nreturn;\r\nif (retval == STATUS_SUCCESS) {\r\nclear_bit(MS_NR, &(chip->need_reset));\r\nchip->ms_reset_counter = 0;\r\nchip->card_ready |= MS_CARD;\r\nchip->card_fail &= ~MS_CARD;\r\nchip->rw_card[chip->card2lun[MS_CARD]] = ms_rw;\r\n} else {\r\nif (chip->ms_reset_counter >= MAX_RESET_CNT) {\r\nclear_bit(MS_NR, &(chip->need_reset));\r\nchip->ms_reset_counter = 0;\r\nchip->ms_show_cnt = 0;\r\n} else {\r\nchip->ms_reset_counter++;\r\n}\r\nchip->card_ready &= ~MS_CARD;\r\nchip->card_fail |= MS_CARD;\r\nchip->capacity[chip->card2lun[MS_CARD]] = 0;\r\nchip->rw_card[chip->card2lun[MS_CARD]] = NULL;\r\nrtsx_write_register(chip, CARD_OE, MS_OUTPUT_EN, 0);\r\nif (!chip->ft2_fast_mode)\r\ncard_power_off(chip, MS_CARD);\r\ndisable_card_clock(chip, MS_CARD);\r\n}\r\n}\r\nstatic void release_sdio(struct rtsx_chip *chip)\r\n{\r\nif (chip->sd_io) {\r\nrtsx_write_register(chip, CARD_STOP, SD_STOP | SD_CLR_ERR,\r\nSD_STOP | SD_CLR_ERR);\r\nif (chip->chip_insert_with_sdio) {\r\nchip->chip_insert_with_sdio = 0;\r\nif (CHECK_PID(chip, 0x5288))\r\nrtsx_write_register(chip, 0xFE5A, 0x08, 0x00);\r\nelse\r\nrtsx_write_register(chip, 0xFE70, 0x80, 0x00);\r\n}\r\nrtsx_write_register(chip, SDIO_CTRL, SDIO_CD_CTRL, 0);\r\nchip->sd_io = 0;\r\n}\r\n}\r\nvoid rtsx_power_off_card(struct rtsx_chip *chip)\r\n{\r\nif ((chip->card_ready & SD_CARD) || chip->sd_io) {\r\nsd_cleanup_work(chip);\r\nsd_power_off_card3v3(chip);\r\n}\r\nif (chip->card_ready & XD_CARD) {\r\nxd_cleanup_work(chip);\r\nxd_power_off_card3v3(chip);\r\n}\r\nif (chip->card_ready & MS_CARD) {\r\nms_cleanup_work(chip);\r\nms_power_off_card3v3(chip);\r\n}\r\n}\r\nvoid rtsx_release_cards(struct rtsx_chip *chip)\r\n{\r\nchip->int_reg = rtsx_readl(chip, RTSX_BIPR);\r\nif ((chip->card_ready & SD_CARD) || chip->sd_io) {\r\nif (chip->int_reg & SD_EXIST)\r\nsd_cleanup_work(chip);\r\nrelease_sd_card(chip);\r\n}\r\nif (chip->card_ready & XD_CARD) {\r\nif (chip->int_reg & XD_EXIST)\r\nxd_cleanup_work(chip);\r\nrelease_xd_card(chip);\r\n}\r\nif (chip->card_ready & MS_CARD) {\r\nif (chip->int_reg & MS_EXIST)\r\nms_cleanup_work(chip);\r\nrelease_ms_card(chip);\r\n}\r\n}\r\nvoid rtsx_reset_cards(struct rtsx_chip *chip)\r\n{\r\nif (!chip->need_reset)\r\nreturn;\r\nrtsx_set_stat(chip, RTSX_STAT_RUN);\r\nrtsx_force_power_on(chip, SSC_PDCTL | OC_PDCTL);\r\nrtsx_disable_aspm(chip);\r\nif ((chip->need_reset & SD_CARD) && chip->chip_insert_with_sdio)\r\nclear_bit(SD_NR, &(chip->need_reset));\r\nif (chip->need_reset & XD_CARD) {\r\nchip->card_exist |= XD_CARD;\r\nif (chip->xd_show_cnt >= MAX_SHOW_CNT)\r\ndo_reset_xd_card(chip);\r\nelse\r\nchip->xd_show_cnt++;\r\n}\r\nif (CHECK_PID(chip, 0x5288) && CHECK_BARO_PKG(chip, QFN)) {\r\nif (chip->card_exist & XD_CARD) {\r\nclear_bit(SD_NR, &(chip->need_reset));\r\nclear_bit(MS_NR, &(chip->need_reset));\r\n}\r\n}\r\nif (chip->need_reset & SD_CARD) {\r\nchip->card_exist |= SD_CARD;\r\nif (chip->sd_show_cnt >= MAX_SHOW_CNT) {\r\nrtsx_write_register(chip, RBCTL, RB_FLUSH, RB_FLUSH);\r\ndo_reset_sd_card(chip);\r\n} else {\r\nchip->sd_show_cnt++;\r\n}\r\n}\r\nif (chip->need_reset & MS_CARD) {\r\nchip->card_exist |= MS_CARD;\r\nif (chip->ms_show_cnt >= MAX_SHOW_CNT)\r\ndo_reset_ms_card(chip);\r\nelse\r\nchip->ms_show_cnt++;\r\n}\r\n}\r\nvoid rtsx_reinit_cards(struct rtsx_chip *chip, int reset_chip)\r\n{\r\nrtsx_set_stat(chip, RTSX_STAT_RUN);\r\nrtsx_force_power_on(chip, SSC_PDCTL | OC_PDCTL);\r\nif (reset_chip)\r\nrtsx_reset_chip(chip);\r\nchip->int_reg = rtsx_readl(chip, RTSX_BIPR);\r\nif ((chip->int_reg & SD_EXIST) && (chip->need_reinit & SD_CARD)) {\r\nrelease_sdio(chip);\r\nrelease_sd_card(chip);\r\nwait_timeout(100);\r\nchip->card_exist |= SD_CARD;\r\ndo_reset_sd_card(chip);\r\n}\r\nif ((chip->int_reg & XD_EXIST) && (chip->need_reinit & XD_CARD)) {\r\nrelease_xd_card(chip);\r\nwait_timeout(100);\r\nchip->card_exist |= XD_CARD;\r\ndo_reset_xd_card(chip);\r\n}\r\nif ((chip->int_reg & MS_EXIST) && (chip->need_reinit & MS_CARD)) {\r\nrelease_ms_card(chip);\r\nwait_timeout(100);\r\nchip->card_exist |= MS_CARD;\r\ndo_reset_ms_card(chip);\r\n}\r\nchip->need_reinit = 0;\r\n}\r\nvoid card_cd_debounce(struct rtsx_chip *chip, unsigned long *need_reset,\r\nunsigned long *need_release)\r\n{\r\nu8 release_map = 0, reset_map = 0;\r\nchip->int_reg = rtsx_readl(chip, RTSX_BIPR);\r\nif (chip->card_exist) {\r\nif (chip->card_exist & XD_CARD) {\r\nif (!(chip->int_reg & XD_EXIST))\r\nrelease_map |= XD_CARD;\r\n} else if (chip->card_exist & SD_CARD) {\r\nif (!(chip->int_reg & SD_EXIST))\r\nrelease_map |= SD_CARD;\r\n} else if (chip->card_exist & MS_CARD) {\r\nif (!(chip->int_reg & MS_EXIST))\r\nrelease_map |= MS_CARD;\r\n}\r\n} else {\r\nif (chip->int_reg & XD_EXIST)\r\nreset_map |= XD_CARD;\r\nelse if (chip->int_reg & SD_EXIST)\r\nreset_map |= SD_CARD;\r\nelse if (chip->int_reg & MS_EXIST)\r\nreset_map |= MS_CARD;\r\n}\r\nif (reset_map) {\r\nint xd_cnt = 0, sd_cnt = 0, ms_cnt = 0;\r\nint i;\r\nfor (i = 0; i < (DEBOUNCE_CNT); i++) {\r\nchip->int_reg = rtsx_readl(chip, RTSX_BIPR);\r\nif (chip->int_reg & XD_EXIST)\r\nxd_cnt++;\r\nelse\r\nxd_cnt = 0;\r\nif (chip->int_reg & SD_EXIST)\r\nsd_cnt++;\r\nelse\r\nsd_cnt = 0;\r\nif (chip->int_reg & MS_EXIST)\r\nms_cnt++;\r\nelse\r\nms_cnt = 0;\r\nwait_timeout(30);\r\n}\r\nreset_map = 0;\r\nif (!(chip->card_exist & XD_CARD) &&\r\n(xd_cnt > (DEBOUNCE_CNT-1)))\r\nreset_map |= XD_CARD;\r\nif (!(chip->card_exist & SD_CARD) &&\r\n(sd_cnt > (DEBOUNCE_CNT-1)))\r\nreset_map |= SD_CARD;\r\nif (!(chip->card_exist & MS_CARD) &&\r\n(ms_cnt > (DEBOUNCE_CNT-1)))\r\nreset_map |= MS_CARD;\r\n}\r\nif (CHECK_PID(chip, 0x5288) && CHECK_BARO_PKG(chip, QFN))\r\nrtsx_write_register(chip, HOST_SLEEP_STATE, 0xC0, 0x00);\r\nif (need_reset)\r\n*need_reset = reset_map;\r\nif (need_release)\r\n*need_release = release_map;\r\n}\r\nvoid rtsx_init_cards(struct rtsx_chip *chip)\r\n{\r\nif (RTSX_TST_DELINK(chip) && (rtsx_get_stat(chip) != RTSX_STAT_SS)) {\r\ndev_dbg(rtsx_dev(chip), "Reset chip in polling thread!\n");\r\nrtsx_reset_chip(chip);\r\nRTSX_CLR_DELINK(chip);\r\n}\r\n#ifdef DISABLE_CARD_INT\r\ncard_cd_debounce(chip, &(chip->need_reset), &(chip->need_release));\r\n#endif\r\nif (chip->need_release) {\r\nif (CHECK_PID(chip, 0x5288) && CHECK_BARO_PKG(chip, QFN)) {\r\nif (chip->int_reg & XD_EXIST) {\r\nclear_bit(SD_NR, &(chip->need_release));\r\nclear_bit(MS_NR, &(chip->need_release));\r\n}\r\n}\r\nif (!(chip->card_exist & SD_CARD) && !chip->sd_io)\r\nclear_bit(SD_NR, &(chip->need_release));\r\nif (!(chip->card_exist & XD_CARD))\r\nclear_bit(XD_NR, &(chip->need_release));\r\nif (!(chip->card_exist & MS_CARD))\r\nclear_bit(MS_NR, &(chip->need_release));\r\ndev_dbg(rtsx_dev(chip), "chip->need_release = 0x%x\n",\r\n(unsigned int)(chip->need_release));\r\n#ifdef SUPPORT_OCP\r\nif (chip->need_release) {\r\nif (chip->ocp_stat & (CARD_OC_NOW | CARD_OC_EVER))\r\nrtsx_write_register(chip, OCPCLR,\r\nCARD_OC_INT_CLR | CARD_OC_CLR,\r\nCARD_OC_INT_CLR | CARD_OC_CLR);\r\nchip->ocp_stat = 0;\r\n}\r\n#endif\r\nif (chip->need_release) {\r\nrtsx_set_stat(chip, RTSX_STAT_RUN);\r\nrtsx_force_power_on(chip, SSC_PDCTL | OC_PDCTL);\r\n}\r\nif (chip->need_release & SD_CARD) {\r\nclear_bit(SD_NR, &(chip->need_release));\r\nchip->card_exist &= ~SD_CARD;\r\nchip->card_ejected &= ~SD_CARD;\r\nchip->card_fail &= ~SD_CARD;\r\nCLR_BIT(chip->lun_mc, chip->card2lun[SD_CARD]);\r\nchip->rw_fail_cnt[chip->card2lun[SD_CARD]] = 0;\r\nrtsx_write_register(chip, RBCTL, RB_FLUSH, RB_FLUSH);\r\nrelease_sdio(chip);\r\nrelease_sd_card(chip);\r\n}\r\nif (chip->need_release & XD_CARD) {\r\nclear_bit(XD_NR, &(chip->need_release));\r\nchip->card_exist &= ~XD_CARD;\r\nchip->card_ejected &= ~XD_CARD;\r\nchip->card_fail &= ~XD_CARD;\r\nCLR_BIT(chip->lun_mc, chip->card2lun[XD_CARD]);\r\nchip->rw_fail_cnt[chip->card2lun[XD_CARD]] = 0;\r\nrelease_xd_card(chip);\r\nif (CHECK_PID(chip, 0x5288) &&\r\nCHECK_BARO_PKG(chip, QFN))\r\nrtsx_write_register(chip, HOST_SLEEP_STATE,\r\n0xC0, 0xC0);\r\n}\r\nif (chip->need_release & MS_CARD) {\r\nclear_bit(MS_NR, &(chip->need_release));\r\nchip->card_exist &= ~MS_CARD;\r\nchip->card_ejected &= ~MS_CARD;\r\nchip->card_fail &= ~MS_CARD;\r\nCLR_BIT(chip->lun_mc, chip->card2lun[MS_CARD]);\r\nchip->rw_fail_cnt[chip->card2lun[MS_CARD]] = 0;\r\nrelease_ms_card(chip);\r\n}\r\ndev_dbg(rtsx_dev(chip), "chip->card_exist = 0x%x\n",\r\nchip->card_exist);\r\nif (!chip->card_exist)\r\nturn_off_led(chip, LED_GPIO);\r\n}\r\nif (chip->need_reset) {\r\ndev_dbg(rtsx_dev(chip), "chip->need_reset = 0x%x\n",\r\n(unsigned int)(chip->need_reset));\r\nrtsx_reset_cards(chip);\r\n}\r\nif (chip->need_reinit) {\r\ndev_dbg(rtsx_dev(chip), "chip->need_reinit = 0x%x\n",\r\n(unsigned int)(chip->need_reinit));\r\nrtsx_reinit_cards(chip, 0);\r\n}\r\n}\r\nstatic inline u8 double_depth(u8 depth)\r\n{\r\nreturn (depth > 1) ? (depth - 1) : depth;\r\n}\r\nint switch_ssc_clock(struct rtsx_chip *chip, int clk)\r\n{\r\nint retval;\r\nu8 N = (u8)(clk - 2), min_N, max_N;\r\nu8 mcu_cnt, div, max_div, ssc_depth, ssc_depth_mask;\r\nint sd_vpclk_phase_reset = 0;\r\nif (chip->cur_clk == clk)\r\nreturn STATUS_SUCCESS;\r\nmin_N = 60;\r\nmax_N = 120;\r\nmax_div = CLK_DIV_4;\r\ndev_dbg(rtsx_dev(chip), "Switch SSC clock to %dMHz (cur_clk = %d)\n",\r\nclk, chip->cur_clk);\r\nif ((clk <= 2) || (N > max_N))\r\nTRACE_RET(chip, STATUS_FAIL);\r\nmcu_cnt = (u8)(125/clk + 3);\r\nif (mcu_cnt > 7)\r\nmcu_cnt = 7;\r\ndiv = CLK_DIV_1;\r\nwhile ((N < min_N) && (div < max_div)) {\r\nN = (N + 2) * 2 - 2;\r\ndiv++;\r\n}\r\ndev_dbg(rtsx_dev(chip), "N = %d, div = %d\n", N, div);\r\nif (chip->ssc_en) {\r\nssc_depth = 0x01;\r\nN -= 2;\r\n} else {\r\nssc_depth = 0;\r\n}\r\nssc_depth_mask = 0x03;\r\ndev_dbg(rtsx_dev(chip), "ssc_depth = %d\n", ssc_depth);\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CLK_CTL, CLK_LOW_FREQ, CLK_LOW_FREQ);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CLK_DIV, 0xFF, (div << 4) | mcu_cnt);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, SSC_CTL1, SSC_RSTB, 0);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, SSC_CTL2, ssc_depth_mask, ssc_depth);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, SSC_DIV_N_0, 0xFF, N);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, SSC_CTL1, SSC_RSTB, SSC_RSTB);\r\nif (sd_vpclk_phase_reset) {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, SD_VPCLK0_CTL,\r\nPHASE_NOT_RESET, 0);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, SD_VPCLK0_CTL,\r\nPHASE_NOT_RESET, PHASE_NOT_RESET);\r\n}\r\nretval = rtsx_send_cmd(chip, 0, WAIT_TIME);\r\nif (retval < 0)\r\nTRACE_RET(chip, STATUS_ERROR);\r\nudelay(10);\r\nRTSX_WRITE_REG(chip, CLK_CTL, CLK_LOW_FREQ, 0);\r\nchip->cur_clk = clk;\r\nreturn STATUS_SUCCESS;\r\n}\r\nint switch_normal_clock(struct rtsx_chip *chip, int clk)\r\n{\r\nu8 sel, div, mcu_cnt;\r\nint sd_vpclk_phase_reset = 0;\r\nif (chip->cur_clk == clk)\r\nreturn STATUS_SUCCESS;\r\nswitch (clk) {\r\ncase CLK_20:\r\ndev_dbg(rtsx_dev(chip), "Switch clock to 20MHz\n");\r\nsel = SSC_80;\r\ndiv = CLK_DIV_4;\r\nmcu_cnt = 7;\r\nbreak;\r\ncase CLK_30:\r\ndev_dbg(rtsx_dev(chip), "Switch clock to 30MHz\n");\r\nsel = SSC_120;\r\ndiv = CLK_DIV_4;\r\nmcu_cnt = 7;\r\nbreak;\r\ncase CLK_40:\r\ndev_dbg(rtsx_dev(chip), "Switch clock to 40MHz\n");\r\nsel = SSC_80;\r\ndiv = CLK_DIV_2;\r\nmcu_cnt = 7;\r\nbreak;\r\ncase CLK_50:\r\ndev_dbg(rtsx_dev(chip), "Switch clock to 50MHz\n");\r\nsel = SSC_100;\r\ndiv = CLK_DIV_2;\r\nmcu_cnt = 6;\r\nbreak;\r\ncase CLK_60:\r\ndev_dbg(rtsx_dev(chip), "Switch clock to 60MHz\n");\r\nsel = SSC_120;\r\ndiv = CLK_DIV_2;\r\nmcu_cnt = 6;\r\nbreak;\r\ncase CLK_80:\r\ndev_dbg(rtsx_dev(chip), "Switch clock to 80MHz\n");\r\nsel = SSC_80;\r\ndiv = CLK_DIV_1;\r\nmcu_cnt = 5;\r\nbreak;\r\ncase CLK_100:\r\ndev_dbg(rtsx_dev(chip), "Switch clock to 100MHz\n");\r\nsel = SSC_100;\r\ndiv = CLK_DIV_1;\r\nmcu_cnt = 5;\r\nbreak;\r\ncase CLK_120:\r\ndev_dbg(rtsx_dev(chip), "Switch clock to 120MHz\n");\r\nsel = SSC_120;\r\ndiv = CLK_DIV_1;\r\nmcu_cnt = 5;\r\nbreak;\r\ncase CLK_150:\r\ndev_dbg(rtsx_dev(chip), "Switch clock to 150MHz\n");\r\nsel = SSC_150;\r\ndiv = CLK_DIV_1;\r\nmcu_cnt = 4;\r\nbreak;\r\ncase CLK_200:\r\ndev_dbg(rtsx_dev(chip), "Switch clock to 200MHz\n");\r\nsel = SSC_200;\r\ndiv = CLK_DIV_1;\r\nmcu_cnt = 4;\r\nbreak;\r\ndefault:\r\ndev_dbg(rtsx_dev(chip), "Try to switch to an illegal clock (%d)\n",\r\nclk);\r\nTRACE_RET(chip, STATUS_FAIL);\r\n}\r\nRTSX_WRITE_REG(chip, CLK_CTL, 0xFF, CLK_LOW_FREQ);\r\nif (sd_vpclk_phase_reset) {\r\nRTSX_WRITE_REG(chip, SD_VPCLK0_CTL, PHASE_NOT_RESET, 0);\r\nRTSX_WRITE_REG(chip, SD_VPCLK1_CTL, PHASE_NOT_RESET, 0);\r\n}\r\nRTSX_WRITE_REG(chip, CLK_DIV, 0xFF, (div << 4) | mcu_cnt);\r\nRTSX_WRITE_REG(chip, CLK_SEL, 0xFF, sel);\r\nif (sd_vpclk_phase_reset) {\r\nudelay(200);\r\nRTSX_WRITE_REG(chip, SD_VPCLK0_CTL, PHASE_NOT_RESET,\r\nPHASE_NOT_RESET);\r\nRTSX_WRITE_REG(chip, SD_VPCLK1_CTL, PHASE_NOT_RESET,\r\nPHASE_NOT_RESET);\r\nudelay(200);\r\n}\r\nRTSX_WRITE_REG(chip, CLK_CTL, 0xFF, 0);\r\nchip->cur_clk = clk;\r\nreturn STATUS_SUCCESS;\r\n}\r\nvoid trans_dma_enable(enum dma_data_direction dir, struct rtsx_chip *chip,\r\nu32 byte_cnt, u8 pack_size)\r\n{\r\nif (pack_size > DMA_1024)\r\npack_size = DMA_512;\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, IRQSTAT0, DMA_DONE_INT, DMA_DONE_INT);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, DMATC3, 0xFF, (u8)(byte_cnt >> 24));\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, DMATC2, 0xFF, (u8)(byte_cnt >> 16));\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, DMATC1, 0xFF, (u8)(byte_cnt >> 8));\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, DMATC0, 0xFF, (u8)byte_cnt);\r\nif (dir == DMA_FROM_DEVICE) {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, DMACTL,\r\n0x03 | DMA_PACK_SIZE_MASK,\r\nDMA_DIR_FROM_CARD | DMA_EN | pack_size);\r\n} else {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, DMACTL,\r\n0x03 | DMA_PACK_SIZE_MASK,\r\nDMA_DIR_TO_CARD | DMA_EN | pack_size);\r\n}\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE, 0x01, RING_BUFFER);\r\n}\r\nint enable_card_clock(struct rtsx_chip *chip, u8 card)\r\n{\r\nu8 clk_en = 0;\r\nif (card & XD_CARD)\r\nclk_en |= XD_CLK_EN;\r\nif (card & SD_CARD)\r\nclk_en |= SD_CLK_EN;\r\nif (card & MS_CARD)\r\nclk_en |= MS_CLK_EN;\r\nRTSX_WRITE_REG(chip, CARD_CLK_EN, clk_en, clk_en);\r\nreturn STATUS_SUCCESS;\r\n}\r\nint disable_card_clock(struct rtsx_chip *chip, u8 card)\r\n{\r\nu8 clk_en = 0;\r\nif (card & XD_CARD)\r\nclk_en |= XD_CLK_EN;\r\nif (card & SD_CARD)\r\nclk_en |= SD_CLK_EN;\r\nif (card & MS_CARD)\r\nclk_en |= MS_CLK_EN;\r\nRTSX_WRITE_REG(chip, CARD_CLK_EN, clk_en, 0);\r\nreturn STATUS_SUCCESS;\r\n}\r\nint card_power_on(struct rtsx_chip *chip, u8 card)\r\n{\r\nint retval;\r\nu8 mask, val1, val2;\r\nif (CHECK_LUN_MODE(chip, SD_MS_2LUN) && (card == MS_CARD)) {\r\nmask = MS_POWER_MASK;\r\nval1 = MS_PARTIAL_POWER_ON;\r\nval2 = MS_POWER_ON;\r\n} else {\r\nmask = SD_POWER_MASK;\r\nval1 = SD_PARTIAL_POWER_ON;\r\nval2 = SD_POWER_ON;\r\n}\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PWR_CTL, mask, val1);\r\nretval = rtsx_send_cmd(chip, 0, 100);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, STATUS_FAIL);\r\nudelay(chip->pmos_pwr_on_interval);\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PWR_CTL, mask, val2);\r\nretval = rtsx_send_cmd(chip, 0, 100);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, STATUS_FAIL);\r\nreturn STATUS_SUCCESS;\r\n}\r\nint card_power_off(struct rtsx_chip *chip, u8 card)\r\n{\r\nu8 mask, val;\r\nif (CHECK_LUN_MODE(chip, SD_MS_2LUN) && (card == MS_CARD)) {\r\nmask = MS_POWER_MASK;\r\nval = MS_POWER_OFF;\r\n} else {\r\nmask = SD_POWER_MASK;\r\nval = SD_POWER_OFF;\r\n}\r\nRTSX_WRITE_REG(chip, CARD_PWR_CTL, mask, val);\r\nreturn STATUS_SUCCESS;\r\n}\r\nint card_rw(struct scsi_cmnd *srb, struct rtsx_chip *chip,\r\nu32 sec_addr, u16 sec_cnt)\r\n{\r\nint retval;\r\nunsigned int lun = SCSI_LUN(srb);\r\nint i;\r\nif (chip->rw_card[lun] == NULL)\r\nTRACE_RET(chip, STATUS_FAIL);\r\nfor (i = 0; i < 3; i++) {\r\nchip->rw_need_retry = 0;\r\nretval = chip->rw_card[lun](srb, chip, sec_addr, sec_cnt);\r\nif (retval != STATUS_SUCCESS) {\r\nif (rtsx_check_chip_exist(chip) != STATUS_SUCCESS) {\r\nrtsx_release_chip(chip);\r\nTRACE_RET(chip, STATUS_FAIL);\r\n}\r\nif (detect_card_cd(chip, chip->cur_card) !=\r\nSTATUS_SUCCESS)\r\nTRACE_RET(chip, STATUS_FAIL);\r\nif (!chip->rw_need_retry) {\r\ndev_dbg(rtsx_dev(chip), "RW fail, but no need to retry\n");\r\nbreak;\r\n}\r\n} else {\r\nchip->rw_need_retry = 0;\r\nbreak;\r\n}\r\ndev_dbg(rtsx_dev(chip), "Retry RW, (i = %d)\n", i);\r\n}\r\nreturn retval;\r\n}\r\nint card_share_mode(struct rtsx_chip *chip, int card)\r\n{\r\nu8 mask, value;\r\nif (CHECK_PID(chip, 0x5208)) {\r\nmask = CARD_SHARE_MASK;\r\nif (card == SD_CARD)\r\nvalue = CARD_SHARE_48_SD;\r\nelse if (card == MS_CARD)\r\nvalue = CARD_SHARE_48_MS;\r\nelse if (card == XD_CARD)\r\nvalue = CARD_SHARE_48_XD;\r\nelse\r\nTRACE_RET(chip, STATUS_FAIL);\r\n} else if (CHECK_PID(chip, 0x5288)) {\r\nmask = 0x03;\r\nif (card == SD_CARD)\r\nvalue = CARD_SHARE_BAROSSA_SD;\r\nelse if (card == MS_CARD)\r\nvalue = CARD_SHARE_BAROSSA_MS;\r\nelse if (card == XD_CARD)\r\nvalue = CARD_SHARE_BAROSSA_XD;\r\nelse\r\nTRACE_RET(chip, STATUS_FAIL);\r\n} else {\r\nTRACE_RET(chip, STATUS_FAIL);\r\n}\r\nRTSX_WRITE_REG(chip, CARD_SHARE_MODE, mask, value);\r\nreturn STATUS_SUCCESS;\r\n}\r\nint select_card(struct rtsx_chip *chip, int card)\r\n{\r\nint retval;\r\nif (chip->cur_card != card) {\r\nu8 mod;\r\nif (card == SD_CARD)\r\nmod = SD_MOD_SEL;\r\nelse if (card == MS_CARD)\r\nmod = MS_MOD_SEL;\r\nelse if (card == XD_CARD)\r\nmod = XD_MOD_SEL;\r\nelse if (card == SPI_CARD)\r\nmod = SPI_MOD_SEL;\r\nelse\r\nTRACE_RET(chip, STATUS_FAIL);\r\nRTSX_WRITE_REG(chip, CARD_SELECT, 0x07, mod);\r\nchip->cur_card = card;\r\nretval = card_share_mode(chip, card);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, STATUS_FAIL);\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nvoid toggle_gpio(struct rtsx_chip *chip, u8 gpio)\r\n{\r\nu8 temp_reg;\r\nrtsx_read_register(chip, CARD_GPIO, &temp_reg);\r\ntemp_reg ^= (0x01 << gpio);\r\nrtsx_write_register(chip, CARD_GPIO, 0xFF, temp_reg);\r\n}\r\nvoid turn_on_led(struct rtsx_chip *chip, u8 gpio)\r\n{\r\nif (CHECK_PID(chip, 0x5288))\r\nrtsx_write_register(chip, CARD_GPIO, (u8)(1 << gpio),\r\n(u8)(1 << gpio));\r\nelse\r\nrtsx_write_register(chip, CARD_GPIO, (u8)(1 << gpio), 0);\r\n}\r\nvoid turn_off_led(struct rtsx_chip *chip, u8 gpio)\r\n{\r\nif (CHECK_PID(chip, 0x5288))\r\nrtsx_write_register(chip, CARD_GPIO, (u8)(1 << gpio), 0);\r\nelse\r\nrtsx_write_register(chip, CARD_GPIO, (u8)(1 << gpio),\r\n(u8)(1 << gpio));\r\n}\r\nint detect_card_cd(struct rtsx_chip *chip, int card)\r\n{\r\nu32 card_cd, status;\r\nif (card == SD_CARD) {\r\ncard_cd = SD_EXIST;\r\n} else if (card == MS_CARD) {\r\ncard_cd = MS_EXIST;\r\n} else if (card == XD_CARD) {\r\ncard_cd = XD_EXIST;\r\n} else {\r\ndev_dbg(rtsx_dev(chip), "Wrong card type: 0x%x\n", card);\r\nTRACE_RET(chip, STATUS_FAIL);\r\n}\r\nstatus = rtsx_readl(chip, RTSX_BIPR);\r\nif (!(status & card_cd))\r\nTRACE_RET(chip, STATUS_FAIL);\r\nreturn STATUS_SUCCESS;\r\n}\r\nint check_card_exist(struct rtsx_chip *chip, unsigned int lun)\r\n{\r\nif (chip->card_exist & chip->lun2card[lun])\r\nreturn 1;\r\nreturn 0;\r\n}\r\nint check_card_ready(struct rtsx_chip *chip, unsigned int lun)\r\n{\r\nif (chip->card_ready & chip->lun2card[lun])\r\nreturn 1;\r\nreturn 0;\r\n}\r\nint check_card_wp(struct rtsx_chip *chip, unsigned int lun)\r\n{\r\nif (chip->card_wp & chip->lun2card[lun])\r\nreturn 1;\r\nreturn 0;\r\n}\r\nint check_card_fail(struct rtsx_chip *chip, unsigned int lun)\r\n{\r\nif (chip->card_fail & chip->lun2card[lun])\r\nreturn 1;\r\nreturn 0;\r\n}\r\nint check_card_ejected(struct rtsx_chip *chip, unsigned int lun)\r\n{\r\nif (chip->card_ejected & chip->lun2card[lun])\r\nreturn 1;\r\nreturn 0;\r\n}\r\nu8 get_lun_card(struct rtsx_chip *chip, unsigned int lun)\r\n{\r\nif ((chip->card_ready & chip->lun2card[lun]) == XD_CARD)\r\nreturn (u8)XD_CARD;\r\nelse if ((chip->card_ready & chip->lun2card[lun]) == SD_CARD)\r\nreturn (u8)SD_CARD;\r\nelse if ((chip->card_ready & chip->lun2card[lun]) == MS_CARD)\r\nreturn (u8)MS_CARD;\r\nreturn 0;\r\n}\r\nvoid eject_card(struct rtsx_chip *chip, unsigned int lun)\r\n{\r\ndo_remaining_work(chip);\r\nif ((chip->card_ready & chip->lun2card[lun]) == SD_CARD) {\r\nrelease_sd_card(chip);\r\nchip->card_ejected |= SD_CARD;\r\nchip->card_ready &= ~SD_CARD;\r\nchip->capacity[lun] = 0;\r\n} else if ((chip->card_ready & chip->lun2card[lun]) == XD_CARD) {\r\nrelease_xd_card(chip);\r\nchip->card_ejected |= XD_CARD;\r\nchip->card_ready &= ~XD_CARD;\r\nchip->capacity[lun] = 0;\r\n} else if ((chip->card_ready & chip->lun2card[lun]) == MS_CARD) {\r\nrelease_ms_card(chip);\r\nchip->card_ejected |= MS_CARD;\r\nchip->card_ready &= ~MS_CARD;\r\nchip->capacity[lun] = 0;\r\n}\r\n}

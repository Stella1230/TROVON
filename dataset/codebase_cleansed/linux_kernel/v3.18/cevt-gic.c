static int gic_next_event(unsigned long delta, struct clock_event_device *evt)\r\n{\r\nu64 cnt;\r\nint res;\r\ncnt = gic_read_count();\r\ncnt += (u64)delta;\r\ngic_write_cpu_compare(cnt, cpumask_first(evt->cpumask));\r\nres = ((int)(gic_read_count() - cnt) >= 0) ? -ETIME : 0;\r\nreturn res;\r\n}\r\nvoid gic_set_clock_mode(enum clock_event_mode mode,\r\nstruct clock_event_device *evt)\r\n{\r\n}\r\nirqreturn_t gic_compare_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *cd;\r\nint cpu = smp_processor_id();\r\ngic_write_compare(gic_read_compare());\r\ncd = &per_cpu(gic_clockevent_device, cpu);\r\ncd->event_handler(cd);\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid gic_event_handler(struct clock_event_device *dev)\r\n{\r\n}\r\nint gic_clockevent_init(void)\r\n{\r\nunsigned int cpu = smp_processor_id();\r\nstruct clock_event_device *cd;\r\nunsigned int irq;\r\nif (!cpu_has_counter || !gic_frequency)\r\nreturn -ENXIO;\r\nirq = MIPS_GIC_IRQ_BASE;\r\ncd = &per_cpu(gic_clockevent_device, cpu);\r\ncd->name = "MIPS GIC";\r\ncd->features = CLOCK_EVT_FEAT_ONESHOT |\r\nCLOCK_EVT_FEAT_C3STOP;\r\nclockevent_set_clock(cd, gic_frequency);\r\ncd->max_delta_ns = clockevent_delta2ns(0x7fffffff, cd);\r\ncd->min_delta_ns = clockevent_delta2ns(0x300, cd);\r\ncd->rating = 300;\r\ncd->irq = irq;\r\ncd->cpumask = cpumask_of(cpu);\r\ncd->set_next_event = gic_next_event;\r\ncd->set_mode = gic_set_clock_mode;\r\ncd->event_handler = gic_event_handler;\r\nclockevents_register_device(cd);\r\nGICWRITE(GIC_REG(VPE_LOCAL, GIC_VPE_COMPARE_MAP), 0x80000002);\r\nGICWRITE(GIC_REG(VPE_LOCAL, GIC_VPE_SMASK), GIC_VPE_SMASK_CMP_MSK);\r\nif (gic_timer_irq_installed)\r\nreturn 0;\r\ngic_timer_irq_installed = 1;\r\nsetup_irq(irq, &gic_compare_irqaction);\r\nirq_set_handler(irq, handle_percpu_irq);\r\nreturn 0;\r\n}

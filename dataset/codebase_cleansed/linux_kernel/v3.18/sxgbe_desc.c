static void sxgbe_init_tx_desc(struct sxgbe_tx_norm_desc *p)\r\n{\r\np->tdes23.tx_rd_des23.own_bit = 0;\r\n}\r\nstatic void sxgbe_tx_desc_enable_tse(struct sxgbe_tx_norm_desc *p, u8 is_tse,\r\nu32 total_hdr_len, u32 tcp_hdr_len,\r\nu32 tcp_payload_len)\r\n{\r\np->tdes23.tx_rd_des23.tse_bit = is_tse;\r\np->tdes23.tx_rd_des23.buf1_size = total_hdr_len;\r\np->tdes23.tx_rd_des23.tcp_hdr_len = tcp_hdr_len / 4;\r\np->tdes23.tx_rd_des23.tx_pkt_len.tcp_payload_len = tcp_payload_len;\r\n}\r\nstatic void sxgbe_prepare_tx_desc(struct sxgbe_tx_norm_desc *p, u8 is_fd,\r\nint buf1_len, int pkt_len, int cksum)\r\n{\r\np->tdes23.tx_rd_des23.first_desc = is_fd;\r\np->tdes23.tx_rd_des23.buf1_size = buf1_len;\r\np->tdes23.tx_rd_des23.tx_pkt_len.pkt_len.total_pkt_len = pkt_len;\r\nif (cksum)\r\np->tdes23.tx_rd_des23.cksum_ctl = cic_full;\r\n}\r\nstatic void sxgbe_tx_vlanctl_desc(struct sxgbe_tx_norm_desc *p, int vlan_ctl)\r\n{\r\np->tdes23.tx_rd_des23.vlan_tag_ctl = vlan_ctl;\r\n}\r\nstatic void sxgbe_set_tx_owner(struct sxgbe_tx_norm_desc *p)\r\n{\r\np->tdes23.tx_rd_des23.own_bit = 1;\r\n}\r\nstatic int sxgbe_get_tx_owner(struct sxgbe_tx_norm_desc *p)\r\n{\r\nreturn p->tdes23.tx_rd_des23.own_bit;\r\n}\r\nstatic void sxgbe_close_tx_desc(struct sxgbe_tx_norm_desc *p)\r\n{\r\np->tdes23.tx_rd_des23.last_desc = 1;\r\np->tdes23.tx_rd_des23.int_on_com = 1;\r\n}\r\nstatic void sxgbe_release_tx_desc(struct sxgbe_tx_norm_desc *p)\r\n{\r\nmemset(p, 0, sizeof(*p));\r\n}\r\nstatic void sxgbe_clear_tx_ic(struct sxgbe_tx_norm_desc *p)\r\n{\r\np->tdes23.tx_rd_des23.int_on_com = 0;\r\n}\r\nstatic int sxgbe_get_tx_ls(struct sxgbe_tx_norm_desc *p)\r\n{\r\nreturn p->tdes23.tx_rd_des23.last_desc;\r\n}\r\nstatic int sxgbe_get_tx_len(struct sxgbe_tx_norm_desc *p)\r\n{\r\nreturn p->tdes23.tx_rd_des23.buf1_size;\r\n}\r\nstatic void sxgbe_tx_enable_tstamp(struct sxgbe_tx_norm_desc *p)\r\n{\r\np->tdes23.tx_rd_des23.timestmp_enable = 1;\r\n}\r\nstatic int sxgbe_get_tx_timestamp_status(struct sxgbe_tx_norm_desc *p)\r\n{\r\nreturn p->tdes23.tx_rd_des23.timestmp_enable;\r\n}\r\nstatic void sxgbe_tx_ctxt_desc_set_ctxt(struct sxgbe_tx_ctxt_desc *p)\r\n{\r\np->ctxt_bit = 1;\r\n}\r\nstatic void sxgbe_tx_ctxt_desc_set_owner(struct sxgbe_tx_ctxt_desc *p)\r\n{\r\np->own_bit = 1;\r\n}\r\nstatic int sxgbe_tx_ctxt_desc_get_owner(struct sxgbe_tx_ctxt_desc *p)\r\n{\r\nreturn p->own_bit;\r\n}\r\nstatic void sxgbe_tx_ctxt_desc_set_mss(struct sxgbe_tx_ctxt_desc *p, u16 mss)\r\n{\r\np->maxseg_size = mss;\r\n}\r\nstatic int sxgbe_tx_ctxt_desc_get_mss(struct sxgbe_tx_ctxt_desc *p)\r\n{\r\nreturn p->maxseg_size;\r\n}\r\nstatic void sxgbe_tx_ctxt_desc_set_tcmssv(struct sxgbe_tx_ctxt_desc *p)\r\n{\r\np->tcmssv = 1;\r\n}\r\nstatic void sxgbe_tx_ctxt_desc_reset_ostc(struct sxgbe_tx_ctxt_desc *p)\r\n{\r\np->ostc = 0;\r\n}\r\nstatic void sxgbe_tx_ctxt_desc_set_ivlantag(struct sxgbe_tx_ctxt_desc *p,\r\nint is_ivlanvalid, int ivlan_tag,\r\nint ivlan_ctl)\r\n{\r\nif (is_ivlanvalid) {\r\np->ivlan_tag_valid = is_ivlanvalid;\r\np->ivlan_tag = ivlan_tag;\r\np->ivlan_tag_ctl = ivlan_ctl;\r\n}\r\n}\r\nstatic int sxgbe_tx_ctxt_desc_get_ivlantag(struct sxgbe_tx_ctxt_desc *p)\r\n{\r\nreturn p->ivlan_tag;\r\n}\r\nstatic void sxgbe_tx_ctxt_desc_set_vlantag(struct sxgbe_tx_ctxt_desc *p,\r\nint is_vlanvalid, int vlan_tag)\r\n{\r\nif (is_vlanvalid) {\r\np->vltag_valid = is_vlanvalid;\r\np->vlan_tag = vlan_tag;\r\n}\r\n}\r\nstatic int sxgbe_tx_ctxt_desc_get_vlantag(struct sxgbe_tx_ctxt_desc *p)\r\n{\r\nreturn p->vlan_tag;\r\n}\r\nstatic void sxgbe_tx_ctxt_desc_set_tstamp(struct sxgbe_tx_ctxt_desc *p,\r\nu8 ostc_enable, u64 tstamp)\r\n{\r\nif (ostc_enable) {\r\np->ostc = ostc_enable;\r\np->tstamp_lo = (u32) tstamp;\r\np->tstamp_hi = (u32) (tstamp>>32);\r\n}\r\n}\r\nstatic void sxgbe_tx_ctxt_desc_close(struct sxgbe_tx_ctxt_desc *p)\r\n{\r\np->own_bit = 1;\r\n}\r\nstatic int sxgbe_tx_ctxt_desc_get_cde(struct sxgbe_tx_ctxt_desc *p)\r\n{\r\nreturn p->ctxt_desc_err;\r\n}\r\nstatic void sxgbe_init_rx_desc(struct sxgbe_rx_norm_desc *p, int disable_rx_ic,\r\nint mode, int end)\r\n{\r\np->rdes23.rx_rd_des23.own_bit = 1;\r\nif (disable_rx_ic)\r\np->rdes23.rx_rd_des23.int_on_com = disable_rx_ic;\r\n}\r\nstatic int sxgbe_get_rx_owner(struct sxgbe_rx_norm_desc *p)\r\n{\r\nreturn p->rdes23.rx_rd_des23.own_bit;\r\n}\r\nstatic void sxgbe_set_rx_owner(struct sxgbe_rx_norm_desc *p)\r\n{\r\np->rdes23.rx_rd_des23.own_bit = 1;\r\n}\r\nstatic void sxgbe_set_rx_int_on_com(struct sxgbe_rx_norm_desc *p)\r\n{\r\np->rdes23.rx_rd_des23.int_on_com = 1;\r\n}\r\nstatic int sxgbe_get_rx_frame_len(struct sxgbe_rx_norm_desc *p)\r\n{\r\nreturn p->rdes23.rx_wb_des23.pkt_len;\r\n}\r\nstatic int sxgbe_get_rx_fd_status(struct sxgbe_rx_norm_desc *p)\r\n{\r\nreturn p->rdes23.rx_wb_des23.first_desc;\r\n}\r\nstatic int sxgbe_get_rx_ld_status(struct sxgbe_rx_norm_desc *p)\r\n{\r\nreturn p->rdes23.rx_wb_des23.last_desc;\r\n}\r\nstatic int sxgbe_rx_wbstatus(struct sxgbe_rx_norm_desc *p,\r\nstruct sxgbe_extra_stats *x, int *checksum)\r\n{\r\nint status = 0;\r\n*checksum = CHECKSUM_UNNECESSARY;\r\nif (p->rdes23.rx_wb_des23.err_summary) {\r\nswitch (p->rdes23.rx_wb_des23.err_l2_type) {\r\ncase RX_GMII_ERR:\r\nstatus = -EINVAL;\r\nx->rx_code_gmii_err++;\r\nbreak;\r\ncase RX_WATCHDOG_ERR:\r\nstatus = -EINVAL;\r\nx->rx_watchdog_err++;\r\nbreak;\r\ncase RX_CRC_ERR:\r\nstatus = -EINVAL;\r\nx->rx_crc_err++;\r\nbreak;\r\ncase RX_GAINT_ERR:\r\nstatus = -EINVAL;\r\nx->rx_gaint_pkt_err++;\r\nbreak;\r\ncase RX_IP_HDR_ERR:\r\n*checksum = CHECKSUM_NONE;\r\nx->ip_hdr_err++;\r\nbreak;\r\ncase RX_PAYLOAD_ERR:\r\n*checksum = CHECKSUM_NONE;\r\nx->ip_payload_err++;\r\nbreak;\r\ncase RX_OVERFLOW_ERR:\r\nstatus = -EINVAL;\r\nx->overflow_error++;\r\nbreak;\r\ndefault:\r\npr_err("Invalid Error type\n");\r\nbreak;\r\n}\r\n} else {\r\nswitch (p->rdes23.rx_wb_des23.err_l2_type) {\r\ncase RX_LEN_PKT:\r\nx->len_pkt++;\r\nbreak;\r\ncase RX_MACCTL_PKT:\r\nx->mac_ctl_pkt++;\r\nbreak;\r\ncase RX_DCBCTL_PKT:\r\nx->dcb_ctl_pkt++;\r\nbreak;\r\ncase RX_ARP_PKT:\r\nx->arp_pkt++;\r\nbreak;\r\ncase RX_OAM_PKT:\r\nx->oam_pkt++;\r\nbreak;\r\ncase RX_UNTAG_PKT:\r\nx->untag_okt++;\r\nbreak;\r\ncase RX_OTHER_PKT:\r\nx->other_pkt++;\r\nbreak;\r\ncase RX_SVLAN_PKT:\r\nx->svlan_tag_pkt++;\r\nbreak;\r\ncase RX_CVLAN_PKT:\r\nx->cvlan_tag_pkt++;\r\nbreak;\r\ncase RX_DVLAN_OCVLAN_ICVLAN_PKT:\r\nx->dvlan_ocvlan_icvlan_pkt++;\r\nbreak;\r\ncase RX_DVLAN_OSVLAN_ISVLAN_PKT:\r\nx->dvlan_osvlan_isvlan_pkt++;\r\nbreak;\r\ncase RX_DVLAN_OSVLAN_ICVLAN_PKT:\r\nx->dvlan_osvlan_icvlan_pkt++;\r\nbreak;\r\ncase RX_DVLAN_OCVLAN_ISVLAN_PKT:\r\nx->dvlan_ocvlan_icvlan_pkt++;\r\nbreak;\r\ndefault:\r\npr_err("Invalid L2 Packet type\n");\r\nbreak;\r\n}\r\n}\r\nswitch (p->rdes23.rx_wb_des23.layer34_pkt_type) {\r\ncase RX_NOT_IP_PKT:\r\nx->not_ip_pkt++;\r\nbreak;\r\ncase RX_IPV4_TCP_PKT:\r\nx->ip4_tcp_pkt++;\r\nbreak;\r\ncase RX_IPV4_UDP_PKT:\r\nx->ip4_udp_pkt++;\r\nbreak;\r\ncase RX_IPV4_ICMP_PKT:\r\nx->ip4_icmp_pkt++;\r\nbreak;\r\ncase RX_IPV4_UNKNOWN_PKT:\r\nx->ip4_unknown_pkt++;\r\nbreak;\r\ncase RX_IPV6_TCP_PKT:\r\nx->ip6_tcp_pkt++;\r\nbreak;\r\ncase RX_IPV6_UDP_PKT:\r\nx->ip6_udp_pkt++;\r\nbreak;\r\ncase RX_IPV6_ICMP_PKT:\r\nx->ip6_icmp_pkt++;\r\nbreak;\r\ncase RX_IPV6_UNKNOWN_PKT:\r\nx->ip6_unknown_pkt++;\r\nbreak;\r\ndefault:\r\npr_err("Invalid L3/L4 Packet type\n");\r\nbreak;\r\n}\r\nif (p->rdes23.rx_wb_des23.vlan_filter_match)\r\nx->vlan_filter_match++;\r\nif (p->rdes23.rx_wb_des23.sa_filter_fail) {\r\nstatus = -EINVAL;\r\nx->sa_filter_fail++;\r\n}\r\nif (p->rdes23.rx_wb_des23.da_filter_fail) {\r\nstatus = -EINVAL;\r\nx->da_filter_fail++;\r\n}\r\nif (p->rdes23.rx_wb_des23.hash_filter_pass)\r\nx->hash_filter_pass++;\r\nif (p->rdes23.rx_wb_des23.l3_filter_match)\r\nx->l3_filter_match++;\r\nif (p->rdes23.rx_wb_des23.l4_filter_match)\r\nx->l4_filter_match++;\r\nreturn status;\r\n}\r\nstatic int sxgbe_get_rx_ctxt_owner(struct sxgbe_rx_ctxt_desc *p)\r\n{\r\nreturn p->own_bit;\r\n}\r\nstatic void sxgbe_set_ctxt_rx_owner(struct sxgbe_rx_ctxt_desc *p)\r\n{\r\np->own_bit = 1;\r\n}\r\nstatic void sxgbe_rx_ctxt_wbstatus(struct sxgbe_rx_ctxt_desc *p,\r\nstruct sxgbe_extra_stats *x)\r\n{\r\nif (p->tstamp_dropped)\r\nx->timestamp_dropped++;\r\nif (p->ptp_msgtype == RX_NO_PTP)\r\nx->rx_msg_type_no_ptp++;\r\nelse if (p->ptp_msgtype == RX_PTP_SYNC)\r\nx->rx_ptp_type_sync++;\r\nelse if (p->ptp_msgtype == RX_PTP_FOLLOW_UP)\r\nx->rx_ptp_type_follow_up++;\r\nelse if (p->ptp_msgtype == RX_PTP_DELAY_REQ)\r\nx->rx_ptp_type_delay_req++;\r\nelse if (p->ptp_msgtype == RX_PTP_DELAY_RESP)\r\nx->rx_ptp_type_delay_resp++;\r\nelse if (p->ptp_msgtype == RX_PTP_PDELAY_REQ)\r\nx->rx_ptp_type_pdelay_req++;\r\nelse if (p->ptp_msgtype == RX_PTP_PDELAY_RESP)\r\nx->rx_ptp_type_pdelay_resp++;\r\nelse if (p->ptp_msgtype == RX_PTP_PDELAY_FOLLOW_UP)\r\nx->rx_ptp_type_pdelay_follow_up++;\r\nelse if (p->ptp_msgtype == RX_PTP_ANNOUNCE)\r\nx->rx_ptp_announce++;\r\nelse if (p->ptp_msgtype == RX_PTP_MGMT)\r\nx->rx_ptp_mgmt++;\r\nelse if (p->ptp_msgtype == RX_PTP_SIGNAL)\r\nx->rx_ptp_signal++;\r\nelse if (p->ptp_msgtype == RX_PTP_RESV_MSG)\r\nx->rx_ptp_resv_msg_type++;\r\n}\r\nstatic int sxgbe_get_rx_ctxt_tstamp_status(struct sxgbe_rx_ctxt_desc *p)\r\n{\r\nif ((p->tstamp_hi == 0xffffffff) && (p->tstamp_lo == 0xffffffff)) {\r\npr_err("Time stamp corrupted\n");\r\nreturn 0;\r\n}\r\nreturn p->tstamp_available;\r\n}\r\nstatic u64 sxgbe_get_rx_timestamp(struct sxgbe_rx_ctxt_desc *p)\r\n{\r\nu64 ns;\r\nns = p->tstamp_lo;\r\nns |= ((u64)p->tstamp_hi) << 32;\r\nreturn ns;\r\n}\r\nconst struct sxgbe_desc_ops *sxgbe_get_desc_ops(void)\r\n{\r\nreturn &desc_ops;\r\n}

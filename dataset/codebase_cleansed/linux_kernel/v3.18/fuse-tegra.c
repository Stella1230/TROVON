static u8 fuse_readb(const unsigned int offset)\r\n{\r\nu32 val;\r\nval = fuse_readl(round_down(offset, 4));\r\nval >>= (offset % 4) * 8;\r\nval &= 0xff;\r\nreturn val;\r\n}\r\nstatic ssize_t fuse_read(struct file *fd, struct kobject *kobj,\r\nstruct bin_attribute *attr, char *buf,\r\nloff_t pos, size_t size)\r\n{\r\nint i;\r\nif (pos < 0 || pos >= fuse_size)\r\nreturn 0;\r\nif (size > fuse_size - pos)\r\nsize = fuse_size - pos;\r\nfor (i = 0; i < size; i++)\r\nbuf[i] = fuse_readb(pos + i);\r\nreturn i;\r\n}\r\nstatic void tegra_enable_fuse_clk(void __iomem *base)\r\n{\r\nu32 reg;\r\nreg = readl_relaxed(base + 0x48);\r\nreg |= 1 << 28;\r\nwritel(reg, base + 0x48);\r\nreg = readl(base + 0x14);\r\nreg |= 1 << 7;\r\nwritel(reg, base + 0x14);\r\n}\r\nint tegra_fuse_readl(unsigned long offset, u32 *value)\r\n{\r\nif (!fuse_readl)\r\nreturn -EPROBE_DEFER;\r\n*value = fuse_readl(offset);\r\nreturn 0;\r\n}\r\nint tegra_fuse_create_sysfs(struct device *dev, int size,\r\nu32 (*readl)(const unsigned int offset))\r\n{\r\nif (fuse_size)\r\nreturn -ENODEV;\r\nfuse_bin_attr.size = size;\r\nfuse_bin_attr.read = fuse_read;\r\nfuse_size = size;\r\nfuse_readl = readl;\r\nreturn device_create_bin_file(dev, &fuse_bin_attr);\r\n}\r\nstatic int __init tegra_init_fuse(void)\r\n{\r\nstruct device_node *np;\r\nvoid __iomem *car_base;\r\nif (!soc_is_tegra())\r\nreturn 0;\r\ntegra_init_apbmisc();\r\nnp = of_find_matching_node(NULL, car_match);\r\ncar_base = of_iomap(np, 0);\r\nif (car_base) {\r\ntegra_enable_fuse_clk(car_base);\r\niounmap(car_base);\r\n} else {\r\npr_err("Could not enable fuse clk. ioremap tegra car failed.\n");\r\nreturn -ENXIO;\r\n}\r\nif (tegra_get_chip_id() == TEGRA20)\r\ntegra20_init_fuse_early();\r\nelse\r\ntegra30_init_fuse_early();\r\npr_info("Tegra Revision: %s SKU: %d CPU Process: %d Core Process: %d\n",\r\ntegra_revision_name[tegra_sku_info.revision],\r\ntegra_sku_info.sku_id, tegra_sku_info.cpu_process_id,\r\ntegra_sku_info.core_process_id);\r\npr_debug("Tegra CPU Speedo ID %d, Soc Speedo ID %d\n",\r\ntegra_sku_info.cpu_speedo_id, tegra_sku_info.soc_speedo_id);\r\nreturn 0;\r\n}

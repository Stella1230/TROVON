u64 mlx4_make_profile(struct mlx4_dev *dev,\r\nstruct mlx4_profile *request,\r\nstruct mlx4_dev_cap *dev_cap,\r\nstruct mlx4_init_hca_param *init_hca)\r\n{\r\nstruct mlx4_priv *priv = mlx4_priv(dev);\r\nstruct mlx4_resource {\r\nu64 size;\r\nu64 start;\r\nint type;\r\nu32 num;\r\nint log_num;\r\n};\r\nu64 total_size = 0;\r\nstruct mlx4_resource *profile;\r\nstruct mlx4_resource tmp;\r\nstruct sysinfo si;\r\nint i, j;\r\nprofile = kcalloc(MLX4_RES_NUM, sizeof(*profile), GFP_KERNEL);\r\nif (!profile)\r\nreturn -ENOMEM;\r\nsi_meminfo(&si);\r\nrequest->num_mtt =\r\nroundup_pow_of_two(max_t(unsigned, request->num_mtt,\r\nmin(1UL << (31 - log_mtts_per_seg),\r\nsi.totalram >> (log_mtts_per_seg - 1))));\r\nprofile[MLX4_RES_QP].size = dev_cap->qpc_entry_sz;\r\nprofile[MLX4_RES_RDMARC].size = dev_cap->rdmarc_entry_sz;\r\nprofile[MLX4_RES_ALTC].size = dev_cap->altc_entry_sz;\r\nprofile[MLX4_RES_AUXC].size = dev_cap->aux_entry_sz;\r\nprofile[MLX4_RES_SRQ].size = dev_cap->srq_entry_sz;\r\nprofile[MLX4_RES_CQ].size = dev_cap->cqc_entry_sz;\r\nprofile[MLX4_RES_EQ].size = dev_cap->eqc_entry_sz;\r\nprofile[MLX4_RES_DMPT].size = dev_cap->dmpt_entry_sz;\r\nprofile[MLX4_RES_CMPT].size = dev_cap->cmpt_entry_sz;\r\nprofile[MLX4_RES_MTT].size = dev_cap->mtt_entry_sz;\r\nprofile[MLX4_RES_MCG].size = mlx4_get_mgm_entry_size(dev);\r\nprofile[MLX4_RES_QP].num = request->num_qp;\r\nprofile[MLX4_RES_RDMARC].num = request->num_qp * request->rdmarc_per_qp;\r\nprofile[MLX4_RES_ALTC].num = request->num_qp;\r\nprofile[MLX4_RES_AUXC].num = request->num_qp;\r\nprofile[MLX4_RES_SRQ].num = request->num_srq;\r\nprofile[MLX4_RES_CQ].num = request->num_cq;\r\nprofile[MLX4_RES_EQ].num = mlx4_is_mfunc(dev) ?\r\ndev->phys_caps.num_phys_eqs :\r\nmin_t(unsigned, dev_cap->max_eqs, MAX_MSIX);\r\nprofile[MLX4_RES_DMPT].num = request->num_mpt;\r\nprofile[MLX4_RES_CMPT].num = MLX4_NUM_CMPTS;\r\nprofile[MLX4_RES_MTT].num = request->num_mtt * (1 << log_mtts_per_seg);\r\nprofile[MLX4_RES_MCG].num = request->num_mcg;\r\nfor (i = 0; i < MLX4_RES_NUM; ++i) {\r\nprofile[i].type = i;\r\nprofile[i].num = roundup_pow_of_two(profile[i].num);\r\nprofile[i].log_num = ilog2(profile[i].num);\r\nprofile[i].size *= profile[i].num;\r\nprofile[i].size = max(profile[i].size, (u64) PAGE_SIZE);\r\n}\r\nfor (i = MLX4_RES_NUM; i > 0; --i)\r\nfor (j = 1; j < i; ++j) {\r\nif (profile[j].size > profile[j - 1].size) {\r\ntmp = profile[j];\r\nprofile[j] = profile[j - 1];\r\nprofile[j - 1] = tmp;\r\n}\r\n}\r\nfor (i = 0; i < MLX4_RES_NUM; ++i) {\r\nif (profile[i].size) {\r\nprofile[i].start = total_size;\r\ntotal_size += profile[i].size;\r\n}\r\nif (total_size > dev_cap->max_icm_sz) {\r\nmlx4_err(dev, "Profile requires 0x%llx bytes; won't fit in 0x%llx bytes of context memory\n",\r\n(unsigned long long) total_size,\r\n(unsigned long long) dev_cap->max_icm_sz);\r\nkfree(profile);\r\nreturn -ENOMEM;\r\n}\r\nif (profile[i].size)\r\nmlx4_dbg(dev, " profile[%2d] (%6s): 2^%02d entries @ 0x%10llx, size 0x%10llx\n",\r\ni, res_name[profile[i].type],\r\nprofile[i].log_num,\r\n(unsigned long long) profile[i].start,\r\n(unsigned long long) profile[i].size);\r\n}\r\nmlx4_dbg(dev, "HCA context memory: reserving %d KB\n",\r\n(int) (total_size >> 10));\r\nfor (i = 0; i < MLX4_RES_NUM; ++i) {\r\nswitch (profile[i].type) {\r\ncase MLX4_RES_QP:\r\ndev->caps.num_qps = profile[i].num;\r\ninit_hca->qpc_base = profile[i].start;\r\ninit_hca->log_num_qps = profile[i].log_num;\r\nbreak;\r\ncase MLX4_RES_RDMARC:\r\nfor (priv->qp_table.rdmarc_shift = 0;\r\nrequest->num_qp << priv->qp_table.rdmarc_shift < profile[i].num;\r\n++priv->qp_table.rdmarc_shift)\r\n;\r\ndev->caps.max_qp_dest_rdma = 1 << priv->qp_table.rdmarc_shift;\r\npriv->qp_table.rdmarc_base = (u32) profile[i].start;\r\ninit_hca->rdmarc_base = profile[i].start;\r\ninit_hca->log_rd_per_qp = priv->qp_table.rdmarc_shift;\r\nbreak;\r\ncase MLX4_RES_ALTC:\r\ninit_hca->altc_base = profile[i].start;\r\nbreak;\r\ncase MLX4_RES_AUXC:\r\ninit_hca->auxc_base = profile[i].start;\r\nbreak;\r\ncase MLX4_RES_SRQ:\r\ndev->caps.num_srqs = profile[i].num;\r\ninit_hca->srqc_base = profile[i].start;\r\ninit_hca->log_num_srqs = profile[i].log_num;\r\nbreak;\r\ncase MLX4_RES_CQ:\r\ndev->caps.num_cqs = profile[i].num;\r\ninit_hca->cqc_base = profile[i].start;\r\ninit_hca->log_num_cqs = profile[i].log_num;\r\nbreak;\r\ncase MLX4_RES_EQ:\r\ndev->caps.num_eqs = roundup_pow_of_two(min_t(unsigned, dev_cap->max_eqs,\r\nMAX_MSIX));\r\ninit_hca->eqc_base = profile[i].start;\r\ninit_hca->log_num_eqs = ilog2(dev->caps.num_eqs);\r\nbreak;\r\ncase MLX4_RES_DMPT:\r\ndev->caps.num_mpts = profile[i].num;\r\npriv->mr_table.mpt_base = profile[i].start;\r\ninit_hca->dmpt_base = profile[i].start;\r\ninit_hca->log_mpt_sz = profile[i].log_num;\r\nbreak;\r\ncase MLX4_RES_CMPT:\r\ninit_hca->cmpt_base = profile[i].start;\r\nbreak;\r\ncase MLX4_RES_MTT:\r\ndev->caps.num_mtts = profile[i].num;\r\npriv->mr_table.mtt_base = profile[i].start;\r\ninit_hca->mtt_base = profile[i].start;\r\nbreak;\r\ncase MLX4_RES_MCG:\r\ninit_hca->mc_base = profile[i].start;\r\ninit_hca->log_mc_entry_sz =\r\nilog2(mlx4_get_mgm_entry_size(dev));\r\ninit_hca->log_mc_table_sz = profile[i].log_num;\r\nif (dev->caps.steering_mode ==\r\nMLX4_STEERING_MODE_DEVICE_MANAGED) {\r\ndev->caps.num_mgms = profile[i].num;\r\n} else {\r\ninit_hca->log_mc_hash_sz =\r\nprofile[i].log_num - 1;\r\ndev->caps.num_mgms = profile[i].num >> 1;\r\ndev->caps.num_amgms = profile[i].num >> 1;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\ndev->caps.num_pds = MLX4_NUM_PDS;\r\nkfree(profile);\r\nreturn total_size;\r\n}

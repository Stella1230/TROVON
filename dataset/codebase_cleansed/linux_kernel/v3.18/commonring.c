void brcmf_commonring_register_cb(struct brcmf_commonring *commonring,\r\nint (*cr_ring_bell)(void *ctx),\r\nint (*cr_update_rptr)(void *ctx),\r\nint (*cr_update_wptr)(void *ctx),\r\nint (*cr_write_rptr)(void *ctx),\r\nint (*cr_write_wptr)(void *ctx), void *ctx)\r\n{\r\ncommonring->cr_ring_bell = cr_ring_bell;\r\ncommonring->cr_update_rptr = cr_update_rptr;\r\ncommonring->cr_update_wptr = cr_update_wptr;\r\ncommonring->cr_write_rptr = cr_write_rptr;\r\ncommonring->cr_write_wptr = cr_write_wptr;\r\ncommonring->cr_ctx = ctx;\r\n}\r\nvoid brcmf_commonring_config(struct brcmf_commonring *commonring, u16 depth,\r\nu16 item_len, void *buf_addr)\r\n{\r\ncommonring->depth = depth;\r\ncommonring->item_len = item_len;\r\ncommonring->buf_addr = buf_addr;\r\nif (!commonring->inited) {\r\nspin_lock_init(&commonring->lock);\r\ncommonring->inited = true;\r\n}\r\ncommonring->r_ptr = 0;\r\nif (commonring->cr_write_rptr)\r\ncommonring->cr_write_rptr(commonring->cr_ctx);\r\ncommonring->w_ptr = 0;\r\nif (commonring->cr_write_wptr)\r\ncommonring->cr_write_wptr(commonring->cr_ctx);\r\ncommonring->f_ptr = 0;\r\n}\r\nvoid brcmf_commonring_lock(struct brcmf_commonring *commonring)\r\n__acquires(&commonring->lock\r\nvoid brcmf_commonring_unlock(struct brcmf_commonring *commonring)\r\n__releases(&commonring->lock\r\nbool brcmf_commonring_write_available(struct brcmf_commonring *commonring)\r\n{\r\nu16 available;\r\nbool retry = true;\r\nagain:\r\nif (commonring->r_ptr <= commonring->w_ptr)\r\navailable = commonring->depth - commonring->w_ptr +\r\ncommonring->r_ptr;\r\nelse\r\navailable = commonring->r_ptr - commonring->w_ptr;\r\nif (available > 1) {\r\nif (!commonring->was_full)\r\nreturn true;\r\nif (available > commonring->depth / 8) {\r\ncommonring->was_full = false;\r\nreturn true;\r\n}\r\nif (retry) {\r\nif (commonring->cr_update_rptr)\r\ncommonring->cr_update_rptr(commonring->cr_ctx);\r\nretry = false;\r\ngoto again;\r\n}\r\nreturn false;\r\n}\r\nif (retry) {\r\nif (commonring->cr_update_rptr)\r\ncommonring->cr_update_rptr(commonring->cr_ctx);\r\nretry = false;\r\ngoto again;\r\n}\r\ncommonring->was_full = true;\r\nreturn false;\r\n}\r\nvoid *brcmf_commonring_reserve_for_write(struct brcmf_commonring *commonring)\r\n{\r\nvoid *ret_ptr;\r\nu16 available;\r\nbool retry = true;\r\nagain:\r\nif (commonring->r_ptr <= commonring->w_ptr)\r\navailable = commonring->depth - commonring->w_ptr +\r\ncommonring->r_ptr;\r\nelse\r\navailable = commonring->r_ptr - commonring->w_ptr;\r\nif (available > 1) {\r\nret_ptr = commonring->buf_addr +\r\n(commonring->w_ptr * commonring->item_len);\r\ncommonring->w_ptr++;\r\nif (commonring->w_ptr == commonring->depth)\r\ncommonring->w_ptr = 0;\r\nreturn ret_ptr;\r\n}\r\nif (retry) {\r\nif (commonring->cr_update_rptr)\r\ncommonring->cr_update_rptr(commonring->cr_ctx);\r\nretry = false;\r\ngoto again;\r\n}\r\ncommonring->was_full = true;\r\nreturn NULL;\r\n}\r\nvoid *\r\nbrcmf_commonring_reserve_for_write_multiple(struct brcmf_commonring *commonring,\r\nu16 n_items, u16 *alloced)\r\n{\r\nvoid *ret_ptr;\r\nu16 available;\r\nbool retry = true;\r\nagain:\r\nif (commonring->r_ptr <= commonring->w_ptr)\r\navailable = commonring->depth - commonring->w_ptr +\r\ncommonring->r_ptr;\r\nelse\r\navailable = commonring->r_ptr - commonring->w_ptr;\r\nif (available > 1) {\r\nret_ptr = commonring->buf_addr +\r\n(commonring->w_ptr * commonring->item_len);\r\n*alloced = min_t(u16, n_items, available - 1);\r\nif (*alloced + commonring->w_ptr > commonring->depth)\r\n*alloced = commonring->depth - commonring->w_ptr;\r\ncommonring->w_ptr += *alloced;\r\nif (commonring->w_ptr == commonring->depth)\r\ncommonring->w_ptr = 0;\r\nreturn ret_ptr;\r\n}\r\nif (retry) {\r\nif (commonring->cr_update_rptr)\r\ncommonring->cr_update_rptr(commonring->cr_ctx);\r\nretry = false;\r\ngoto again;\r\n}\r\ncommonring->was_full = true;\r\nreturn NULL;\r\n}\r\nint brcmf_commonring_write_complete(struct brcmf_commonring *commonring)\r\n{\r\nvoid *address;\r\naddress = commonring->buf_addr;\r\naddress += (commonring->f_ptr * commonring->item_len);\r\nif (commonring->f_ptr > commonring->w_ptr) {\r\nbrcmf_dma_flush(address,\r\n(commonring->depth - commonring->f_ptr) *\r\ncommonring->item_len);\r\naddress = commonring->buf_addr;\r\ncommonring->f_ptr = 0;\r\n}\r\nbrcmf_dma_flush(address, (commonring->w_ptr - commonring->f_ptr) *\r\ncommonring->item_len);\r\ncommonring->f_ptr = commonring->w_ptr;\r\nif (commonring->cr_write_wptr)\r\ncommonring->cr_write_wptr(commonring->cr_ctx);\r\nif (commonring->cr_ring_bell)\r\nreturn commonring->cr_ring_bell(commonring->cr_ctx);\r\nreturn -EIO;\r\n}\r\nvoid brcmf_commonring_write_cancel(struct brcmf_commonring *commonring,\r\nu16 n_items)\r\n{\r\nif (commonring->w_ptr == 0)\r\ncommonring->w_ptr = commonring->depth - n_items;\r\nelse\r\ncommonring->w_ptr -= n_items;\r\n}\r\nvoid *brcmf_commonring_get_read_ptr(struct brcmf_commonring *commonring,\r\nu16 *n_items)\r\n{\r\nvoid *ret_addr;\r\nif (commonring->cr_update_wptr)\r\ncommonring->cr_update_wptr(commonring->cr_ctx);\r\n*n_items = (commonring->w_ptr >= commonring->r_ptr) ?\r\n(commonring->w_ptr - commonring->r_ptr) :\r\n(commonring->depth - commonring->r_ptr);\r\nif (*n_items == 0)\r\nreturn NULL;\r\nret_addr = commonring->buf_addr +\r\n(commonring->r_ptr * commonring->item_len);\r\ncommonring->r_ptr += *n_items;\r\nif (commonring->r_ptr == commonring->depth)\r\ncommonring->r_ptr = 0;\r\nbrcmf_dma_invalidate_cache(ret_addr, *n_ items * commonring->item_len);\r\nreturn ret_addr;\r\n}\r\nint brcmf_commonring_read_complete(struct brcmf_commonring *commonring)\r\n{\r\nif (commonring->cr_write_rptr)\r\nreturn commonring->cr_write_rptr(commonring->cr_ctx);\r\nreturn -EIO;\r\n}

void\r\nxfs_dir_startup(void)\r\n{\r\nxfs_dir_hash_dot = xfs_da_hashname((unsigned char *)".", 1);\r\nxfs_dir_hash_dotdot = xfs_da_hashname((unsigned char *)"..", 2);\r\n}\r\nstatic bool\r\nxfs_dir3_block_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_dir3_blk_hdr *hdr3 = bp->b_addr;\r\nif (xfs_sb_version_hascrc(&mp->m_sb)) {\r\nif (hdr3->magic != cpu_to_be32(XFS_DIR3_BLOCK_MAGIC))\r\nreturn false;\r\nif (!uuid_equal(&hdr3->uuid, &mp->m_sb.sb_uuid))\r\nreturn false;\r\nif (be64_to_cpu(hdr3->blkno) != bp->b_bn)\r\nreturn false;\r\n} else {\r\nif (hdr3->magic != cpu_to_be32(XFS_DIR2_BLOCK_MAGIC))\r\nreturn false;\r\n}\r\nif (__xfs_dir3_data_check(NULL, bp))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic void\r\nxfs_dir3_block_read_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nif (xfs_sb_version_hascrc(&mp->m_sb) &&\r\n!xfs_buf_verify_cksum(bp, XFS_DIR3_DATA_CRC_OFF))\r\nxfs_buf_ioerror(bp, -EFSBADCRC);\r\nelse if (!xfs_dir3_block_verify(bp))\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nif (bp->b_error)\r\nxfs_verifier_error(bp);\r\n}\r\nstatic void\r\nxfs_dir3_block_write_verify(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_buf_log_item *bip = bp->b_fspriv;\r\nstruct xfs_dir3_blk_hdr *hdr3 = bp->b_addr;\r\nif (!xfs_dir3_block_verify(bp)) {\r\nxfs_buf_ioerror(bp, -EFSCORRUPTED);\r\nxfs_verifier_error(bp);\r\nreturn;\r\n}\r\nif (!xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn;\r\nif (bip)\r\nhdr3->lsn = cpu_to_be64(bip->bli_item.li_lsn);\r\nxfs_buf_update_cksum(bp, XFS_DIR3_DATA_CRC_OFF);\r\n}\r\nint\r\nxfs_dir3_block_read(\r\nstruct xfs_trans *tp,\r\nstruct xfs_inode *dp,\r\nstruct xfs_buf **bpp)\r\n{\r\nstruct xfs_mount *mp = dp->i_mount;\r\nint err;\r\nerr = xfs_da_read_buf(tp, dp, mp->m_dir_geo->datablk, -1, bpp,\r\nXFS_DATA_FORK, &xfs_dir3_block_buf_ops);\r\nif (!err && tp)\r\nxfs_trans_buf_set_type(tp, *bpp, XFS_BLFT_DIR_BLOCK_BUF);\r\nreturn err;\r\n}\r\nstatic void\r\nxfs_dir3_block_init(\r\nstruct xfs_mount *mp,\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp,\r\nstruct xfs_inode *dp)\r\n{\r\nstruct xfs_dir3_blk_hdr *hdr3 = bp->b_addr;\r\nbp->b_ops = &xfs_dir3_block_buf_ops;\r\nxfs_trans_buf_set_type(tp, bp, XFS_BLFT_DIR_BLOCK_BUF);\r\nif (xfs_sb_version_hascrc(&mp->m_sb)) {\r\nmemset(hdr3, 0, sizeof(*hdr3));\r\nhdr3->magic = cpu_to_be32(XFS_DIR3_BLOCK_MAGIC);\r\nhdr3->blkno = cpu_to_be64(bp->b_bn);\r\nhdr3->owner = cpu_to_be64(dp->i_ino);\r\nuuid_copy(&hdr3->uuid, &mp->m_sb.sb_uuid);\r\nreturn;\r\n}\r\nhdr3->magic = cpu_to_be32(XFS_DIR2_BLOCK_MAGIC);\r\n}\r\nstatic void\r\nxfs_dir2_block_need_space(\r\nstruct xfs_inode *dp,\r\nstruct xfs_dir2_data_hdr *hdr,\r\nstruct xfs_dir2_block_tail *btp,\r\nstruct xfs_dir2_leaf_entry *blp,\r\n__be16 **tagpp,\r\nstruct xfs_dir2_data_unused **dupp,\r\nstruct xfs_dir2_data_unused **enddupp,\r\nint *compact,\r\nint len)\r\n{\r\nstruct xfs_dir2_data_free *bf;\r\n__be16 *tagp = NULL;\r\nstruct xfs_dir2_data_unused *dup = NULL;\r\nstruct xfs_dir2_data_unused *enddup = NULL;\r\n*compact = 0;\r\nbf = dp->d_ops->data_bestfree_p(hdr);\r\nif (btp->stale) {\r\nif (be16_to_cpu(bf[0].length) >= len) {\r\ndup = (xfs_dir2_data_unused_t *)\r\n((char *)hdr + be16_to_cpu(bf[0].offset));\r\ngoto out;\r\n}\r\n*compact = 1;\r\ntagp = (__be16 *)blp - 1;\r\ndup = (xfs_dir2_data_unused_t *)((char *)hdr + be16_to_cpu(*tagp));\r\nif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\r\nif (be16_to_cpu(dup->length) + (be32_to_cpu(btp->stale) - 1) *\r\n(uint)sizeof(*blp) < len)\r\ndup = NULL;\r\n} else if ((be32_to_cpu(btp->stale) - 1) * (uint)sizeof(*blp) < len)\r\ndup = NULL;\r\nelse\r\ndup = (xfs_dir2_data_unused_t *)blp;\r\ngoto out;\r\n}\r\ntagp = (__be16 *)blp - 1;\r\nenddup = (xfs_dir2_data_unused_t *)((char *)hdr + be16_to_cpu(*tagp));\r\nif (be16_to_cpu(enddup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\r\ndup = (xfs_dir2_data_unused_t *)\r\n((char *)hdr + be16_to_cpu(bf[0].offset));\r\nif (dup != enddup) {\r\nif (be16_to_cpu(dup->length) < len)\r\ndup = NULL;\r\ngoto out;\r\n}\r\nif (be16_to_cpu(dup->length) < len + (uint)sizeof(*blp)) {\r\nif (be16_to_cpu(bf[1].length) >= len)\r\ndup = (xfs_dir2_data_unused_t *)\r\n((char *)hdr + be16_to_cpu(bf[1].offset));\r\nelse\r\ndup = NULL;\r\n}\r\n}\r\nout:\r\n*tagpp = tagp;\r\n*dupp = dup;\r\n*enddupp = enddup;\r\n}\r\nstatic void\r\nxfs_dir2_block_compact(\r\nstruct xfs_da_args *args,\r\nstruct xfs_buf *bp,\r\nstruct xfs_dir2_data_hdr *hdr,\r\nstruct xfs_dir2_block_tail *btp,\r\nstruct xfs_dir2_leaf_entry *blp,\r\nint *needlog,\r\nint *lfloghigh,\r\nint *lfloglow)\r\n{\r\nint fromidx;\r\nint toidx;\r\nint needscan = 0;\r\nint highstale;\r\nfromidx = toidx = be32_to_cpu(btp->count) - 1;\r\nhighstale = *lfloghigh = -1;\r\nfor (; fromidx >= 0; fromidx--) {\r\nif (blp[fromidx].address == cpu_to_be32(XFS_DIR2_NULL_DATAPTR)) {\r\nif (highstale == -1)\r\nhighstale = toidx;\r\nelse {\r\nif (*lfloghigh == -1)\r\n*lfloghigh = toidx;\r\ncontinue;\r\n}\r\n}\r\nif (fromidx < toidx)\r\nblp[toidx] = blp[fromidx];\r\ntoidx--;\r\n}\r\n*lfloglow = toidx + 1 - (be32_to_cpu(btp->stale) - 1);\r\n*lfloghigh -= be32_to_cpu(btp->stale) - 1;\r\nbe32_add_cpu(&btp->count, -(be32_to_cpu(btp->stale) - 1));\r\nxfs_dir2_data_make_free(args, bp,\r\n(xfs_dir2_data_aoff_t)((char *)blp - (char *)hdr),\r\n(xfs_dir2_data_aoff_t)((be32_to_cpu(btp->stale) - 1) * sizeof(*blp)),\r\nneedlog, &needscan);\r\nbtp->stale = cpu_to_be32(1);\r\nif (needscan)\r\nxfs_dir2_data_freescan(args->dp, hdr, needlog);\r\n}\r\nint\r\nxfs_dir2_block_addname(\r\nxfs_da_args_t *args)\r\n{\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_leaf_entry_t *blp;\r\nstruct xfs_buf *bp;\r\nxfs_dir2_block_tail_t *btp;\r\nint compact;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nxfs_dir2_data_unused_t *dup;\r\nint error;\r\nxfs_dir2_data_unused_t *enddup=NULL;\r\nxfs_dahash_t hash;\r\nint high;\r\nint highstale;\r\nint lfloghigh=0;\r\nint lfloglow=0;\r\nint len;\r\nint low;\r\nint lowstale;\r\nint mid=0;\r\nxfs_mount_t *mp;\r\nint needlog;\r\nint needscan;\r\n__be16 *tagp;\r\nxfs_trans_t *tp;\r\ntrace_xfs_dir2_block_addname(args);\r\ndp = args->dp;\r\ntp = args->trans;\r\nmp = dp->i_mount;\r\nerror = xfs_dir3_block_read(tp, dp, &bp);\r\nif (error)\r\nreturn error;\r\nlen = dp->d_ops->data_entsize(args->namelen);\r\nhdr = bp->b_addr;\r\nbtp = xfs_dir2_block_tail_p(args->geo, hdr);\r\nblp = xfs_dir2_block_leaf_p(btp);\r\nxfs_dir2_block_need_space(dp, hdr, btp, blp, &tagp, &dup,\r\n&enddup, &compact, len);\r\nif (args->op_flags & XFS_DA_OP_JUSTCHECK) {\r\nxfs_trans_brelse(tp, bp);\r\nif (!dup)\r\nreturn -ENOSPC;\r\nreturn 0;\r\n}\r\nif (!dup) {\r\nif (args->total == 0)\r\nreturn -ENOSPC;\r\nerror = xfs_dir2_block_to_leaf(args, bp);\r\nif (error)\r\nreturn error;\r\nreturn xfs_dir2_leaf_addname(args);\r\n}\r\nneedlog = needscan = 0;\r\nif (compact) {\r\nxfs_dir2_block_compact(args, bp, hdr, btp, blp, &needlog,\r\n&lfloghigh, &lfloglow);\r\nblp = xfs_dir2_block_leaf_p(btp);\r\n} else if (btp->stale) {\r\nlfloglow = be32_to_cpu(btp->count);\r\nlfloghigh = -1;\r\n}\r\nfor (low = 0, high = be32_to_cpu(btp->count) - 1; low <= high; ) {\r\nmid = (low + high) >> 1;\r\nif ((hash = be32_to_cpu(blp[mid].hashval)) == args->hashval)\r\nbreak;\r\nif (hash < args->hashval)\r\nlow = mid + 1;\r\nelse\r\nhigh = mid - 1;\r\n}\r\nwhile (mid >= 0 && be32_to_cpu(blp[mid].hashval) >= args->hashval) {\r\nmid--;\r\n}\r\nif (!btp->stale) {\r\nxfs_dir2_data_use_free(args, bp, enddup,\r\n(xfs_dir2_data_aoff_t)\r\n((char *)enddup - (char *)hdr + be16_to_cpu(enddup->length) -\r\nsizeof(*blp)),\r\n(xfs_dir2_data_aoff_t)sizeof(*blp),\r\n&needlog, &needscan);\r\nbe32_add_cpu(&btp->count, 1);\r\nif (needscan) {\r\nxfs_dir2_data_freescan(dp, hdr, &needlog);\r\nneedscan = 0;\r\n}\r\nblp--;\r\nmid++;\r\nif (mid)\r\nmemmove(blp, &blp[1], mid * sizeof(*blp));\r\nlfloglow = 0;\r\nlfloghigh = mid;\r\n}\r\nelse {\r\nfor (lowstale = mid;\r\nlowstale >= 0 &&\r\nblp[lowstale].address !=\r\ncpu_to_be32(XFS_DIR2_NULL_DATAPTR);\r\nlowstale--)\r\ncontinue;\r\nfor (highstale = mid + 1;\r\nhighstale < be32_to_cpu(btp->count) &&\r\nblp[highstale].address !=\r\ncpu_to_be32(XFS_DIR2_NULL_DATAPTR) &&\r\n(lowstale < 0 || mid - lowstale > highstale - mid);\r\nhighstale++)\r\ncontinue;\r\nif (lowstale >= 0 &&\r\n(highstale == be32_to_cpu(btp->count) ||\r\nmid - lowstale <= highstale - mid)) {\r\nif (mid - lowstale)\r\nmemmove(&blp[lowstale], &blp[lowstale + 1],\r\n(mid - lowstale) * sizeof(*blp));\r\nlfloglow = MIN(lowstale, lfloglow);\r\nlfloghigh = MAX(mid, lfloghigh);\r\n}\r\nelse {\r\nASSERT(highstale < be32_to_cpu(btp->count));\r\nmid++;\r\nif (highstale - mid)\r\nmemmove(&blp[mid + 1], &blp[mid],\r\n(highstale - mid) * sizeof(*blp));\r\nlfloglow = MIN(mid, lfloglow);\r\nlfloghigh = MAX(highstale, lfloghigh);\r\n}\r\nbe32_add_cpu(&btp->stale, -1);\r\n}\r\ndep = (xfs_dir2_data_entry_t *)dup;\r\nblp[mid].hashval = cpu_to_be32(args->hashval);\r\nblp[mid].address = cpu_to_be32(xfs_dir2_byte_to_dataptr(\r\n(char *)dep - (char *)hdr));\r\nxfs_dir2_block_log_leaf(tp, bp, lfloglow, lfloghigh);\r\nxfs_dir2_data_use_free(args, bp, dup,\r\n(xfs_dir2_data_aoff_t)((char *)dup - (char *)hdr),\r\n(xfs_dir2_data_aoff_t)len, &needlog, &needscan);\r\ndep->inumber = cpu_to_be64(args->inumber);\r\ndep->namelen = args->namelen;\r\nmemcpy(dep->name, args->name, args->namelen);\r\ndp->d_ops->data_put_ftype(dep, args->filetype);\r\ntagp = dp->d_ops->data_entry_tag_p(dep);\r\n*tagp = cpu_to_be16((char *)dep - (char *)hdr);\r\nif (needscan)\r\nxfs_dir2_data_freescan(dp, hdr, &needlog);\r\nif (needlog)\r\nxfs_dir2_data_log_header(args, bp);\r\nxfs_dir2_block_log_tail(tp, bp);\r\nxfs_dir2_data_log_entry(args, bp, dep);\r\nxfs_dir3_data_check(dp, bp);\r\nreturn 0;\r\n}\r\nstatic void\r\nxfs_dir2_block_log_leaf(\r\nxfs_trans_t *tp,\r\nstruct xfs_buf *bp,\r\nint first,\r\nint last)\r\n{\r\nxfs_dir2_data_hdr_t *hdr = bp->b_addr;\r\nxfs_dir2_leaf_entry_t *blp;\r\nxfs_dir2_block_tail_t *btp;\r\nbtp = xfs_dir2_block_tail_p(tp->t_mountp->m_dir_geo, hdr);\r\nblp = xfs_dir2_block_leaf_p(btp);\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)&blp[first] - (char *)hdr),\r\n(uint)((char *)&blp[last + 1] - (char *)hdr - 1));\r\n}\r\nstatic void\r\nxfs_dir2_block_log_tail(\r\nxfs_trans_t *tp,\r\nstruct xfs_buf *bp)\r\n{\r\nxfs_dir2_data_hdr_t *hdr = bp->b_addr;\r\nxfs_dir2_block_tail_t *btp;\r\nbtp = xfs_dir2_block_tail_p(tp->t_mountp->m_dir_geo, hdr);\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)btp - (char *)hdr),\r\n(uint)((char *)(btp + 1) - (char *)hdr - 1));\r\n}\r\nint\r\nxfs_dir2_block_lookup(\r\nxfs_da_args_t *args)\r\n{\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_leaf_entry_t *blp;\r\nstruct xfs_buf *bp;\r\nxfs_dir2_block_tail_t *btp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nint ent;\r\nint error;\r\nxfs_mount_t *mp;\r\ntrace_xfs_dir2_block_lookup(args);\r\nif ((error = xfs_dir2_block_lookup_int(args, &bp, &ent)))\r\nreturn error;\r\ndp = args->dp;\r\nmp = dp->i_mount;\r\nhdr = bp->b_addr;\r\nxfs_dir3_data_check(dp, bp);\r\nbtp = xfs_dir2_block_tail_p(args->geo, hdr);\r\nblp = xfs_dir2_block_leaf_p(btp);\r\ndep = (xfs_dir2_data_entry_t *)((char *)hdr +\r\nxfs_dir2_dataptr_to_off(args->geo,\r\nbe32_to_cpu(blp[ent].address)));\r\nargs->inumber = be64_to_cpu(dep->inumber);\r\nargs->filetype = dp->d_ops->data_get_ftype(dep);\r\nerror = xfs_dir_cilookup_result(args, dep->name, dep->namelen);\r\nxfs_trans_brelse(args->trans, bp);\r\nreturn error;\r\n}\r\nstatic int\r\nxfs_dir2_block_lookup_int(\r\nxfs_da_args_t *args,\r\nstruct xfs_buf **bpp,\r\nint *entno)\r\n{\r\nxfs_dir2_dataptr_t addr;\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_leaf_entry_t *blp;\r\nstruct xfs_buf *bp;\r\nxfs_dir2_block_tail_t *btp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nint error;\r\nxfs_dahash_t hash;\r\nint high;\r\nint low;\r\nint mid;\r\nxfs_mount_t *mp;\r\nxfs_trans_t *tp;\r\nenum xfs_dacmp cmp;\r\ndp = args->dp;\r\ntp = args->trans;\r\nmp = dp->i_mount;\r\nerror = xfs_dir3_block_read(tp, dp, &bp);\r\nif (error)\r\nreturn error;\r\nhdr = bp->b_addr;\r\nxfs_dir3_data_check(dp, bp);\r\nbtp = xfs_dir2_block_tail_p(args->geo, hdr);\r\nblp = xfs_dir2_block_leaf_p(btp);\r\nfor (low = 0, high = be32_to_cpu(btp->count) - 1; ; ) {\r\nASSERT(low <= high);\r\nmid = (low + high) >> 1;\r\nif ((hash = be32_to_cpu(blp[mid].hashval)) == args->hashval)\r\nbreak;\r\nif (hash < args->hashval)\r\nlow = mid + 1;\r\nelse\r\nhigh = mid - 1;\r\nif (low > high) {\r\nASSERT(args->op_flags & XFS_DA_OP_OKNOENT);\r\nxfs_trans_brelse(tp, bp);\r\nreturn -ENOENT;\r\n}\r\n}\r\nwhile (mid > 0 && be32_to_cpu(blp[mid - 1].hashval) == args->hashval) {\r\nmid--;\r\n}\r\ndo {\r\nif ((addr = be32_to_cpu(blp[mid].address)) == XFS_DIR2_NULL_DATAPTR)\r\ncontinue;\r\ndep = (xfs_dir2_data_entry_t *)\r\n((char *)hdr + xfs_dir2_dataptr_to_off(args->geo, addr));\r\ncmp = mp->m_dirnameops->compname(args, dep->name, dep->namelen);\r\nif (cmp != XFS_CMP_DIFFERENT && cmp != args->cmpresult) {\r\nargs->cmpresult = cmp;\r\n*bpp = bp;\r\n*entno = mid;\r\nif (cmp == XFS_CMP_EXACT)\r\nreturn 0;\r\n}\r\n} while (++mid < be32_to_cpu(btp->count) &&\r\nbe32_to_cpu(blp[mid].hashval) == hash);\r\nASSERT(args->op_flags & XFS_DA_OP_OKNOENT);\r\nif (args->cmpresult == XFS_CMP_CASE)\r\nreturn 0;\r\nxfs_trans_brelse(tp, bp);\r\nreturn -ENOENT;\r\n}\r\nint\r\nxfs_dir2_block_removename(\r\nxfs_da_args_t *args)\r\n{\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_leaf_entry_t *blp;\r\nstruct xfs_buf *bp;\r\nxfs_dir2_block_tail_t *btp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nint ent;\r\nint error;\r\nxfs_mount_t *mp;\r\nint needlog;\r\nint needscan;\r\nxfs_dir2_sf_hdr_t sfh;\r\nint size;\r\nxfs_trans_t *tp;\r\ntrace_xfs_dir2_block_removename(args);\r\nif ((error = xfs_dir2_block_lookup_int(args, &bp, &ent))) {\r\nreturn error;\r\n}\r\ndp = args->dp;\r\ntp = args->trans;\r\nmp = dp->i_mount;\r\nhdr = bp->b_addr;\r\nbtp = xfs_dir2_block_tail_p(args->geo, hdr);\r\nblp = xfs_dir2_block_leaf_p(btp);\r\ndep = (xfs_dir2_data_entry_t *)((char *)hdr +\r\nxfs_dir2_dataptr_to_off(args->geo,\r\nbe32_to_cpu(blp[ent].address)));\r\nneedlog = needscan = 0;\r\nxfs_dir2_data_make_free(args, bp,\r\n(xfs_dir2_data_aoff_t)((char *)dep - (char *)hdr),\r\ndp->d_ops->data_entsize(dep->namelen), &needlog, &needscan);\r\nbe32_add_cpu(&btp->stale, 1);\r\nxfs_dir2_block_log_tail(tp, bp);\r\nblp[ent].address = cpu_to_be32(XFS_DIR2_NULL_DATAPTR);\r\nxfs_dir2_block_log_leaf(tp, bp, ent, ent);\r\nif (needscan)\r\nxfs_dir2_data_freescan(dp, hdr, &needlog);\r\nif (needlog)\r\nxfs_dir2_data_log_header(args, bp);\r\nxfs_dir3_data_check(dp, bp);\r\nsize = xfs_dir2_block_sfsize(dp, hdr, &sfh);\r\nif (size > XFS_IFORK_DSIZE(dp))\r\nreturn 0;\r\nreturn xfs_dir2_block_to_sf(args, bp, size, &sfh);\r\n}\r\nint\r\nxfs_dir2_block_replace(\r\nxfs_da_args_t *args)\r\n{\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_leaf_entry_t *blp;\r\nstruct xfs_buf *bp;\r\nxfs_dir2_block_tail_t *btp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nint ent;\r\nint error;\r\nxfs_mount_t *mp;\r\ntrace_xfs_dir2_block_replace(args);\r\nif ((error = xfs_dir2_block_lookup_int(args, &bp, &ent))) {\r\nreturn error;\r\n}\r\ndp = args->dp;\r\nmp = dp->i_mount;\r\nhdr = bp->b_addr;\r\nbtp = xfs_dir2_block_tail_p(args->geo, hdr);\r\nblp = xfs_dir2_block_leaf_p(btp);\r\ndep = (xfs_dir2_data_entry_t *)((char *)hdr +\r\nxfs_dir2_dataptr_to_off(args->geo,\r\nbe32_to_cpu(blp[ent].address)));\r\nASSERT(be64_to_cpu(dep->inumber) != args->inumber);\r\ndep->inumber = cpu_to_be64(args->inumber);\r\ndp->d_ops->data_put_ftype(dep, args->filetype);\r\nxfs_dir2_data_log_entry(args, bp, dep);\r\nxfs_dir3_data_check(dp, bp);\r\nreturn 0;\r\n}\r\nstatic int\r\nxfs_dir2_block_sort(\r\nconst void *a,\r\nconst void *b)\r\n{\r\nconst xfs_dir2_leaf_entry_t *la;\r\nconst xfs_dir2_leaf_entry_t *lb;\r\nla = a;\r\nlb = b;\r\nreturn be32_to_cpu(la->hashval) < be32_to_cpu(lb->hashval) ? -1 :\r\n(be32_to_cpu(la->hashval) > be32_to_cpu(lb->hashval) ? 1 : 0);\r\n}\r\nint\r\nxfs_dir2_leaf_to_block(\r\nxfs_da_args_t *args,\r\nstruct xfs_buf *lbp,\r\nstruct xfs_buf *dbp)\r\n{\r\n__be16 *bestsp;\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_block_tail_t *btp;\r\nxfs_inode_t *dp;\r\nxfs_dir2_data_unused_t *dup;\r\nint error;\r\nint from;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_entry_t *lep;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nxfs_mount_t *mp;\r\nint needlog;\r\nint needscan;\r\nxfs_dir2_sf_hdr_t sfh;\r\nint size;\r\n__be16 *tagp;\r\nint to;\r\nxfs_trans_t *tp;\r\nstruct xfs_dir2_leaf_entry *ents;\r\nstruct xfs_dir3_icleaf_hdr leafhdr;\r\ntrace_xfs_dir2_leaf_to_block(args);\r\ndp = args->dp;\r\ntp = args->trans;\r\nmp = dp->i_mount;\r\nleaf = lbp->b_addr;\r\ndp->d_ops->leaf_hdr_from_disk(&leafhdr, leaf);\r\nents = dp->d_ops->leaf_ents_p(leaf);\r\nltp = xfs_dir2_leaf_tail_p(args->geo, leaf);\r\nASSERT(leafhdr.magic == XFS_DIR2_LEAF1_MAGIC ||\r\nleafhdr.magic == XFS_DIR3_LEAF1_MAGIC);\r\nwhile (dp->i_d.di_size > args->geo->blksize) {\r\nint hdrsz;\r\nhdrsz = dp->d_ops->data_entry_offset;\r\nbestsp = xfs_dir2_leaf_bests_p(ltp);\r\nif (be16_to_cpu(bestsp[be32_to_cpu(ltp->bestcount) - 1]) ==\r\nargs->geo->blksize - hdrsz) {\r\nif ((error =\r\nxfs_dir2_leaf_trim_data(args, lbp,\r\n(xfs_dir2_db_t)(be32_to_cpu(ltp->bestcount) - 1))))\r\nreturn error;\r\n} else\r\nreturn 0;\r\n}\r\nif (!dbp) {\r\nerror = xfs_dir3_data_read(tp, dp, args->geo->datablk, -1, &dbp);\r\nif (error)\r\nreturn error;\r\n}\r\nhdr = dbp->b_addr;\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_DATA_MAGIC));\r\nsize = (uint)sizeof(xfs_dir2_block_tail_t) +\r\n(uint)sizeof(*lep) * (leafhdr.count - leafhdr.stale);\r\ntagp = (__be16 *)((char *)hdr + args->geo->blksize) - 1;\r\ndup = (xfs_dir2_data_unused_t *)((char *)hdr + be16_to_cpu(*tagp));\r\nif (be16_to_cpu(dup->freetag) != XFS_DIR2_DATA_FREE_TAG ||\r\nbe16_to_cpu(dup->length) < size)\r\nreturn 0;\r\nxfs_dir3_block_init(mp, tp, dbp, dp);\r\nneedlog = 1;\r\nneedscan = 0;\r\nxfs_dir2_data_use_free(args, dbp, dup, args->geo->blksize - size, size,\r\n&needlog, &needscan);\r\nbtp = xfs_dir2_block_tail_p(args->geo, hdr);\r\nbtp->count = cpu_to_be32(leafhdr.count - leafhdr.stale);\r\nbtp->stale = 0;\r\nxfs_dir2_block_log_tail(tp, dbp);\r\nlep = xfs_dir2_block_leaf_p(btp);\r\nfor (from = to = 0; from < leafhdr.count; from++) {\r\nif (ents[from].address == cpu_to_be32(XFS_DIR2_NULL_DATAPTR))\r\ncontinue;\r\nlep[to++] = ents[from];\r\n}\r\nASSERT(to == be32_to_cpu(btp->count));\r\nxfs_dir2_block_log_leaf(tp, dbp, 0, be32_to_cpu(btp->count) - 1);\r\nif (needscan)\r\nxfs_dir2_data_freescan(dp, hdr, &needlog);\r\nif (needlog)\r\nxfs_dir2_data_log_header(args, dbp);\r\nerror = xfs_da_shrink_inode(args, args->geo->leafblk, lbp);\r\nif (error)\r\nreturn error;\r\nsize = xfs_dir2_block_sfsize(dp, hdr, &sfh);\r\nif (size > XFS_IFORK_DSIZE(dp))\r\nreturn 0;\r\nreturn xfs_dir2_block_to_sf(args, dbp, size, &sfh);\r\n}\r\nint\r\nxfs_dir2_sf_to_block(\r\nxfs_da_args_t *args)\r\n{\r\nxfs_dir2_db_t blkno;\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_leaf_entry_t *blp;\r\nstruct xfs_buf *bp;\r\nxfs_dir2_block_tail_t *btp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nint dummy;\r\nxfs_dir2_data_unused_t *dup;\r\nint endoffset;\r\nint error;\r\nint i;\r\nxfs_mount_t *mp;\r\nint needlog;\r\nint needscan;\r\nint newoffset;\r\nint offset;\r\nxfs_dir2_sf_entry_t *sfep;\r\nxfs_dir2_sf_hdr_t *oldsfp;\r\nxfs_dir2_sf_hdr_t *sfp;\r\n__be16 *tagp;\r\nxfs_trans_t *tp;\r\nstruct xfs_name name;\r\nstruct xfs_ifork *ifp;\r\ntrace_xfs_dir2_sf_to_block(args);\r\ndp = args->dp;\r\ntp = args->trans;\r\nmp = dp->i_mount;\r\nifp = XFS_IFORK_PTR(dp, XFS_DATA_FORK);\r\nASSERT(ifp->if_flags & XFS_IFINLINE);\r\nif (dp->i_d.di_size < offsetof(xfs_dir2_sf_hdr_t, parent)) {\r\nASSERT(XFS_FORCED_SHUTDOWN(mp));\r\nreturn -EIO;\r\n}\r\noldsfp = (xfs_dir2_sf_hdr_t *)ifp->if_u1.if_data;\r\nASSERT(ifp->if_bytes == dp->i_d.di_size);\r\nASSERT(ifp->if_u1.if_data != NULL);\r\nASSERT(dp->i_d.di_size >= xfs_dir2_sf_hdr_size(oldsfp->i8count));\r\nASSERT(dp->i_d.di_nextents == 0);\r\nsfp = kmem_alloc(ifp->if_bytes, KM_SLEEP);\r\nmemcpy(sfp, oldsfp, ifp->if_bytes);\r\nxfs_idata_realloc(dp, -ifp->if_bytes, XFS_DATA_FORK);\r\nxfs_bmap_local_to_extents_empty(dp, XFS_DATA_FORK);\r\ndp->i_d.di_size = 0;\r\nerror = xfs_dir2_grow_inode(args, XFS_DIR2_DATA_SPACE, &blkno);\r\nif (error) {\r\nkmem_free(sfp);\r\nreturn error;\r\n}\r\nerror = xfs_dir3_data_init(args, blkno, &bp);\r\nif (error) {\r\nkmem_free(sfp);\r\nreturn error;\r\n}\r\nxfs_dir3_block_init(mp, tp, bp, dp);\r\nhdr = bp->b_addr;\r\ni = (uint)sizeof(*btp) +\r\n(sfp->count + 2) * (uint)sizeof(xfs_dir2_leaf_entry_t);\r\ndup = dp->d_ops->data_unused_p(hdr);\r\nneedlog = needscan = 0;\r\nxfs_dir2_data_use_free(args, bp, dup, args->geo->blksize - i,\r\ni, &needlog, &needscan);\r\nASSERT(needscan == 0);\r\nbtp = xfs_dir2_block_tail_p(args->geo, hdr);\r\nbtp->count = cpu_to_be32(sfp->count + 2);\r\nbtp->stale = 0;\r\nblp = xfs_dir2_block_leaf_p(btp);\r\nendoffset = (uint)((char *)blp - (char *)hdr);\r\nxfs_dir2_data_use_free(args, bp, dup,\r\n(xfs_dir2_data_aoff_t)((char *)dup - (char *)hdr),\r\nbe16_to_cpu(dup->length), &needlog, &needscan);\r\ndep = dp->d_ops->data_dot_entry_p(hdr);\r\ndep->inumber = cpu_to_be64(dp->i_ino);\r\ndep->namelen = 1;\r\ndep->name[0] = '.';\r\ndp->d_ops->data_put_ftype(dep, XFS_DIR3_FT_DIR);\r\ntagp = dp->d_ops->data_entry_tag_p(dep);\r\n*tagp = cpu_to_be16((char *)dep - (char *)hdr);\r\nxfs_dir2_data_log_entry(args, bp, dep);\r\nblp[0].hashval = cpu_to_be32(xfs_dir_hash_dot);\r\nblp[0].address = cpu_to_be32(xfs_dir2_byte_to_dataptr(\r\n(char *)dep - (char *)hdr));\r\ndep = dp->d_ops->data_dotdot_entry_p(hdr);\r\ndep->inumber = cpu_to_be64(dp->d_ops->sf_get_parent_ino(sfp));\r\ndep->namelen = 2;\r\ndep->name[0] = dep->name[1] = '.';\r\ndp->d_ops->data_put_ftype(dep, XFS_DIR3_FT_DIR);\r\ntagp = dp->d_ops->data_entry_tag_p(dep);\r\n*tagp = cpu_to_be16((char *)dep - (char *)hdr);\r\nxfs_dir2_data_log_entry(args, bp, dep);\r\nblp[1].hashval = cpu_to_be32(xfs_dir_hash_dotdot);\r\nblp[1].address = cpu_to_be32(xfs_dir2_byte_to_dataptr(\r\n(char *)dep - (char *)hdr));\r\noffset = dp->d_ops->data_first_offset;\r\ni = 0;\r\nif (!sfp->count)\r\nsfep = NULL;\r\nelse\r\nsfep = xfs_dir2_sf_firstentry(sfp);\r\nwhile (offset < endoffset) {\r\nif (sfep == NULL)\r\nnewoffset = endoffset;\r\nelse\r\nnewoffset = xfs_dir2_sf_get_offset(sfep);\r\nif (offset < newoffset) {\r\ndup = (xfs_dir2_data_unused_t *)((char *)hdr + offset);\r\ndup->freetag = cpu_to_be16(XFS_DIR2_DATA_FREE_TAG);\r\ndup->length = cpu_to_be16(newoffset - offset);\r\n*xfs_dir2_data_unused_tag_p(dup) = cpu_to_be16(\r\n((char *)dup - (char *)hdr));\r\nxfs_dir2_data_log_unused(args, bp, dup);\r\nxfs_dir2_data_freeinsert(hdr,\r\ndp->d_ops->data_bestfree_p(hdr),\r\ndup, &dummy);\r\noffset += be16_to_cpu(dup->length);\r\ncontinue;\r\n}\r\ndep = (xfs_dir2_data_entry_t *)((char *)hdr + newoffset);\r\ndep->inumber = cpu_to_be64(dp->d_ops->sf_get_ino(sfp, sfep));\r\ndep->namelen = sfep->namelen;\r\ndp->d_ops->data_put_ftype(dep, dp->d_ops->sf_get_ftype(sfep));\r\nmemcpy(dep->name, sfep->name, dep->namelen);\r\ntagp = dp->d_ops->data_entry_tag_p(dep);\r\n*tagp = cpu_to_be16((char *)dep - (char *)hdr);\r\nxfs_dir2_data_log_entry(args, bp, dep);\r\nname.name = sfep->name;\r\nname.len = sfep->namelen;\r\nblp[2 + i].hashval = cpu_to_be32(mp->m_dirnameops->\r\nhashname(&name));\r\nblp[2 + i].address = cpu_to_be32(xfs_dir2_byte_to_dataptr(\r\n(char *)dep - (char *)hdr));\r\noffset = (int)((char *)(tagp + 1) - (char *)hdr);\r\nif (++i == sfp->count)\r\nsfep = NULL;\r\nelse\r\nsfep = dp->d_ops->sf_nextentry(sfp, sfep);\r\n}\r\nkmem_free(sfp);\r\nxfs_sort(blp, be32_to_cpu(btp->count), sizeof(*blp), xfs_dir2_block_sort);\r\nASSERT(needscan == 0);\r\nxfs_dir2_block_log_leaf(tp, bp, 0, be32_to_cpu(btp->count) - 1);\r\nxfs_dir2_block_log_tail(tp, bp);\r\nxfs_dir3_data_check(dp, bp);\r\nreturn 0;\r\n}

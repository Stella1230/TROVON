int hfs_find_init(struct hfs_btree *tree, struct hfs_find_data *fd)\r\n{\r\nvoid *ptr;\r\nfd->tree = tree;\r\nfd->bnode = NULL;\r\nptr = kmalloc(tree->max_key_len * 2 + 4, GFP_KERNEL);\r\nif (!ptr)\r\nreturn -ENOMEM;\r\nfd->search_key = ptr;\r\nfd->key = ptr + tree->max_key_len + 2;\r\nhfs_dbg(BNODE_REFS, "find_init: %d (%p)\n",\r\ntree->cnid, __builtin_return_address(0));\r\nmutex_lock(&tree->tree_lock);\r\nreturn 0;\r\n}\r\nvoid hfs_find_exit(struct hfs_find_data *fd)\r\n{\r\nhfs_bnode_put(fd->bnode);\r\nkfree(fd->search_key);\r\nhfs_dbg(BNODE_REFS, "find_exit: %d (%p)\n",\r\nfd->tree->cnid, __builtin_return_address(0));\r\nmutex_unlock(&fd->tree->tree_lock);\r\nfd->tree = NULL;\r\n}\r\nint __hfs_brec_find(struct hfs_bnode *bnode, struct hfs_find_data *fd)\r\n{\r\nint cmpval;\r\nu16 off, len, keylen;\r\nint rec;\r\nint b, e;\r\nint res;\r\nb = 0;\r\ne = bnode->num_recs - 1;\r\nres = -ENOENT;\r\ndo {\r\nrec = (e + b) / 2;\r\nlen = hfs_brec_lenoff(bnode, rec, &off);\r\nkeylen = hfs_brec_keylen(bnode, rec);\r\nif (keylen == 0) {\r\nres = -EINVAL;\r\ngoto fail;\r\n}\r\nhfs_bnode_read(bnode, fd->key, off, keylen);\r\ncmpval = bnode->tree->keycmp(fd->key, fd->search_key);\r\nif (!cmpval) {\r\ne = rec;\r\nres = 0;\r\ngoto done;\r\n}\r\nif (cmpval < 0)\r\nb = rec + 1;\r\nelse\r\ne = rec - 1;\r\n} while (b <= e);\r\nif (rec != e && e >= 0) {\r\nlen = hfs_brec_lenoff(bnode, e, &off);\r\nkeylen = hfs_brec_keylen(bnode, e);\r\nif (keylen == 0) {\r\nres = -EINVAL;\r\ngoto fail;\r\n}\r\nhfs_bnode_read(bnode, fd->key, off, keylen);\r\n}\r\ndone:\r\nfd->record = e;\r\nfd->keyoffset = off;\r\nfd->keylength = keylen;\r\nfd->entryoffset = off + keylen;\r\nfd->entrylength = len - keylen;\r\nfail:\r\nreturn res;\r\n}\r\nint hfs_brec_find(struct hfs_find_data *fd)\r\n{\r\nstruct hfs_btree *tree;\r\nstruct hfs_bnode *bnode;\r\nu32 nidx, parent;\r\n__be32 data;\r\nint height, res;\r\ntree = fd->tree;\r\nif (fd->bnode)\r\nhfs_bnode_put(fd->bnode);\r\nfd->bnode = NULL;\r\nnidx = tree->root;\r\nif (!nidx)\r\nreturn -ENOENT;\r\nheight = tree->depth;\r\nres = 0;\r\nparent = 0;\r\nfor (;;) {\r\nbnode = hfs_bnode_find(tree, nidx);\r\nif (IS_ERR(bnode)) {\r\nres = PTR_ERR(bnode);\r\nbnode = NULL;\r\nbreak;\r\n}\r\nif (bnode->height != height)\r\ngoto invalid;\r\nif (bnode->type != (--height ? HFS_NODE_INDEX : HFS_NODE_LEAF))\r\ngoto invalid;\r\nbnode->parent = parent;\r\nres = __hfs_brec_find(bnode, fd);\r\nif (!height)\r\nbreak;\r\nif (fd->record < 0)\r\ngoto release;\r\nparent = nidx;\r\nhfs_bnode_read(bnode, &data, fd->entryoffset, 4);\r\nnidx = be32_to_cpu(data);\r\nhfs_bnode_put(bnode);\r\n}\r\nfd->bnode = bnode;\r\nreturn res;\r\ninvalid:\r\npr_err("inconsistency in B*Tree (%d,%d,%d,%u,%u)\n",\r\nheight, bnode->height, bnode->type, nidx, parent);\r\nres = -EIO;\r\nrelease:\r\nhfs_bnode_put(bnode);\r\nreturn res;\r\n}\r\nint hfs_brec_read(struct hfs_find_data *fd, void *rec, int rec_len)\r\n{\r\nint res;\r\nres = hfs_brec_find(fd);\r\nif (res)\r\nreturn res;\r\nif (fd->entrylength > rec_len)\r\nreturn -EINVAL;\r\nhfs_bnode_read(fd->bnode, rec, fd->entryoffset, fd->entrylength);\r\nreturn 0;\r\n}\r\nint hfs_brec_goto(struct hfs_find_data *fd, int cnt)\r\n{\r\nstruct hfs_btree *tree;\r\nstruct hfs_bnode *bnode;\r\nint idx, res = 0;\r\nu16 off, len, keylen;\r\nbnode = fd->bnode;\r\ntree = bnode->tree;\r\nif (cnt < 0) {\r\ncnt = -cnt;\r\nwhile (cnt > fd->record) {\r\ncnt -= fd->record + 1;\r\nfd->record = bnode->num_recs - 1;\r\nidx = bnode->prev;\r\nif (!idx) {\r\nres = -ENOENT;\r\ngoto out;\r\n}\r\nhfs_bnode_put(bnode);\r\nbnode = hfs_bnode_find(tree, idx);\r\nif (IS_ERR(bnode)) {\r\nres = PTR_ERR(bnode);\r\nbnode = NULL;\r\ngoto out;\r\n}\r\n}\r\nfd->record -= cnt;\r\n} else {\r\nwhile (cnt >= bnode->num_recs - fd->record) {\r\ncnt -= bnode->num_recs - fd->record;\r\nfd->record = 0;\r\nidx = bnode->next;\r\nif (!idx) {\r\nres = -ENOENT;\r\ngoto out;\r\n}\r\nhfs_bnode_put(bnode);\r\nbnode = hfs_bnode_find(tree, idx);\r\nif (IS_ERR(bnode)) {\r\nres = PTR_ERR(bnode);\r\nbnode = NULL;\r\ngoto out;\r\n}\r\n}\r\nfd->record += cnt;\r\n}\r\nlen = hfs_brec_lenoff(bnode, fd->record, &off);\r\nkeylen = hfs_brec_keylen(bnode, fd->record);\r\nif (keylen == 0) {\r\nres = -EINVAL;\r\ngoto out;\r\n}\r\nfd->keyoffset = off;\r\nfd->keylength = keylen;\r\nfd->entryoffset = off + keylen;\r\nfd->entrylength = len - keylen;\r\nhfs_bnode_read(bnode, fd->key, off, keylen);\r\nout:\r\nfd->bnode = bnode;\r\nreturn res;\r\n}

void ibmasm_init_reverse_heartbeat(struct service_processor *sp, struct reverse_heartbeat *rhb)\r\n{\r\ninit_waitqueue_head(&rhb->wait);\r\nrhb->stopped = 0;\r\n}\r\nint ibmasm_start_reverse_heartbeat(struct service_processor *sp, struct reverse_heartbeat *rhb)\r\n{\r\nstruct command *cmd;\r\nint times_failed = 0;\r\nint result = 1;\r\ncmd = ibmasm_new_command(sp, sizeof rhb_dot_cmd);\r\nif (!cmd)\r\nreturn -ENOMEM;\r\nwhile (times_failed < 3) {\r\nmemcpy(cmd->buffer, (void *)&rhb_dot_cmd, sizeof rhb_dot_cmd);\r\ncmd->status = IBMASM_CMD_PENDING;\r\nibmasm_exec_command(sp, cmd);\r\nibmasm_wait_for_response(cmd, IBMASM_CMD_TIMEOUT_NORMAL);\r\nif (cmd->status != IBMASM_CMD_COMPLETE)\r\ntimes_failed++;\r\nwait_event_interruptible_timeout(rhb->wait,\r\nrhb->stopped,\r\nREVERSE_HEARTBEAT_TIMEOUT * HZ);\r\nif (signal_pending(current) || rhb->stopped) {\r\nresult = -EINTR;\r\nbreak;\r\n}\r\n}\r\ncommand_put(cmd);\r\nrhb->stopped = 0;\r\nreturn result;\r\n}\r\nvoid ibmasm_stop_reverse_heartbeat(struct reverse_heartbeat *rhb)\r\n{\r\nrhb->stopped = 1;\r\nwake_up_interruptible(&rhb->wait);\r\n}

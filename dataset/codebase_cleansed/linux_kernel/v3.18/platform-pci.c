static unsigned long alloc_xen_mmio(unsigned long len)\r\n{\r\nunsigned long addr;\r\naddr = platform_mmio + platform_mmio_alloc;\r\nplatform_mmio_alloc += len;\r\nBUG_ON(platform_mmio_alloc > platform_mmiolen);\r\nreturn addr;\r\n}\r\nstatic uint64_t get_callback_via(struct pci_dev *pdev)\r\n{\r\nu8 pin;\r\nint irq;\r\nirq = pdev->irq;\r\nif (irq < 16)\r\nreturn irq;\r\npin = pdev->pin;\r\nreturn ((uint64_t)0x01 << 56) |\r\n((uint64_t)pci_domain_nr(pdev->bus) << 32) |\r\n((uint64_t)pdev->bus->number << 16) |\r\n((uint64_t)(pdev->devfn & 0xff) << 8) |\r\n((uint64_t)(pin - 1) & 3);\r\n}\r\nstatic irqreturn_t do_hvm_evtchn_intr(int irq, void *dev_id)\r\n{\r\nxen_hvm_evtchn_do_upcall();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int xen_allocate_irq(struct pci_dev *pdev)\r\n{\r\nreturn request_irq(pdev->irq, do_hvm_evtchn_intr,\r\nIRQF_NOBALANCING | IRQF_TRIGGER_RISING,\r\n"xen-platform-pci", pdev);\r\n}\r\nstatic int platform_pci_resume(struct pci_dev *pdev)\r\n{\r\nint err;\r\nif (xen_have_vector_callback)\r\nreturn 0;\r\nerr = xen_set_callback_via(callback_via);\r\nif (err) {\r\ndev_err(&pdev->dev, "platform_pci_resume failure!\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int platform_pci_init(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nint i, ret;\r\nlong ioaddr;\r\nlong mmio_addr, mmio_len;\r\nunsigned int max_nr_gframes;\r\nunsigned long grant_frames;\r\nif (!xen_domain())\r\nreturn -ENODEV;\r\ni = pci_enable_device(pdev);\r\nif (i)\r\nreturn i;\r\nioaddr = pci_resource_start(pdev, 0);\r\nmmio_addr = pci_resource_start(pdev, 1);\r\nmmio_len = pci_resource_len(pdev, 1);\r\nif (mmio_addr == 0 || ioaddr == 0) {\r\ndev_err(&pdev->dev, "no resources found\n");\r\nret = -ENOENT;\r\ngoto pci_out;\r\n}\r\nret = pci_request_region(pdev, 1, DRV_NAME);\r\nif (ret < 0)\r\ngoto pci_out;\r\nret = pci_request_region(pdev, 0, DRV_NAME);\r\nif (ret < 0)\r\ngoto mem_out;\r\nplatform_mmio = mmio_addr;\r\nplatform_mmiolen = mmio_len;\r\nif (!xen_have_vector_callback) {\r\nret = xen_allocate_irq(pdev);\r\nif (ret) {\r\ndev_warn(&pdev->dev, "request_irq failed err=%d\n", ret);\r\ngoto out;\r\n}\r\ncallback_via = get_callback_via(pdev);\r\nret = xen_set_callback_via(callback_via);\r\nif (ret) {\r\ndev_warn(&pdev->dev, "Unable to set the evtchn callback "\r\n"err=%d\n", ret);\r\ngoto out;\r\n}\r\n}\r\nmax_nr_gframes = gnttab_max_grant_frames();\r\ngrant_frames = alloc_xen_mmio(PAGE_SIZE * max_nr_gframes);\r\nret = gnttab_setup_auto_xlat_frames(grant_frames);\r\nif (ret)\r\ngoto out;\r\nret = gnttab_init();\r\nif (ret)\r\ngoto grant_out;\r\nxenbus_probe(NULL);\r\nreturn 0;\r\ngrant_out:\r\ngnttab_free_auto_xlat_frames();\r\nout:\r\npci_release_region(pdev, 0);\r\nmem_out:\r\npci_release_region(pdev, 1);\r\npci_out:\r\npci_disable_device(pdev);\r\nreturn ret;\r\n}\r\nstatic int __init platform_pci_module_init(void)\r\n{\r\nreturn pci_register_driver(&platform_driver);\r\n}

static irqreturn_t macepci_error(int irq, void *dev)\r\n{\r\nchar s;\r\nunsigned int flags = mace->pci.error;\r\nunsigned int addr = mace->pci.error_addr;\r\nif (flags & MACEPCI_ERROR_MEMORY_ADDR)\r\ns = 'M';\r\nelse if (flags & MACEPCI_ERROR_CONFIG_ADDR)\r\ns = 'C';\r\nelse\r\ns = 'X';\r\nif (flags & MACEPCI_ERROR_MASTER_ABORT) {\r\nprintk("MACEPCI: Master abort at 0x%08x (%c)\n", addr, s);\r\nflags &= ~MACEPCI_ERROR_MASTER_ABORT;\r\n}\r\nif (flags & MACEPCI_ERROR_TARGET_ABORT) {\r\nprintk("MACEPCI: Target abort at 0x%08x (%c)\n", addr, s);\r\nflags &= ~MACEPCI_ERROR_TARGET_ABORT;\r\n}\r\nif (flags & MACEPCI_ERROR_DATA_PARITY_ERR) {\r\nprintk("MACEPCI: Data parity error at 0x%08x (%c)\n", addr, s);\r\nflags &= ~MACEPCI_ERROR_DATA_PARITY_ERR;\r\n}\r\nif (flags & MACEPCI_ERROR_RETRY_ERR) {\r\nprintk("MACEPCI: Retry error at 0x%08x (%c)\n", addr, s);\r\nflags &= ~MACEPCI_ERROR_RETRY_ERR;\r\n}\r\nif (flags & MACEPCI_ERROR_ILLEGAL_CMD) {\r\nprintk("MACEPCI: Illegal command at 0x%08x (%c)\n", addr, s);\r\nflags &= ~MACEPCI_ERROR_ILLEGAL_CMD;\r\n}\r\nif (flags & MACEPCI_ERROR_SYSTEM_ERR) {\r\nprintk("MACEPCI: System error at 0x%08x (%c)\n", addr, s);\r\nflags &= ~MACEPCI_ERROR_SYSTEM_ERR;\r\n}\r\nif (flags & MACEPCI_ERROR_PARITY_ERR) {\r\nprintk("MACEPCI: Parity error at 0x%08x (%c)\n", addr, s);\r\nflags &= ~MACEPCI_ERROR_PARITY_ERR;\r\n}\r\nif (flags & MACEPCI_ERROR_OVERRUN) {\r\nprintk("MACEPCI: Overrun error at 0x%08x (%c)\n", addr, s);\r\nflags &= ~MACEPCI_ERROR_OVERRUN;\r\n}\r\nif (flags & MACEPCI_ERROR_SIG_TABORT) {\r\nprintk("MACEPCI: Signaled target abort (clearing)\n");\r\nflags &= ~MACEPCI_ERROR_SIG_TABORT;\r\n}\r\nif (flags & MACEPCI_ERROR_INTERRUPT_TEST) {\r\nprintk("MACEPCI: Interrupt test triggered (clearing)\n");\r\nflags &= ~MACEPCI_ERROR_INTERRUPT_TEST;\r\n}\r\nmace->pci.error = flags;\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init mace_init(void)\r\n{\r\nPCIBIOS_MIN_IO = 0x1000;\r\nmace->pci.error_addr = 0;\r\nmace->pci.error = 0;\r\nmace->pci.control = 0xff008500;\r\nprintk("MACE PCI rev %d\n", mace->pci.rev);\r\nBUG_ON(request_irq(MACE_PCI_BRIDGE_IRQ, macepci_error, 0,\r\n"MACE PCI error", NULL));\r\niomem_resource.end = mace_pci_mem_resource.end;\r\nioport_resource = mace_pci_io_resource;\r\nregister_pci_controller(&mace_pci_controller);\r\nreturn 0;\r\n}

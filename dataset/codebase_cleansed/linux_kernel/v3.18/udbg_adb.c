static inline void udbg_adb_poll(void)\r\n{\r\n#ifdef CONFIG_ADB_PMU\r\nif (input_type == input_adb_pmu)\r\npmu_poll_adb();\r\n#endif\r\n#ifdef CONFIG_ADB_CUDA\r\nif (input_type == input_adb_cuda)\r\ncuda_poll();\r\n#endif\r\n}\r\nstatic int udbg_adb_local_getc(void)\r\n{\r\nint k, t, on;\r\nxmon_wants_key = 1;\r\nfor (;;) {\r\nxmon_adb_keycode = -1;\r\nt = 0;\r\non = 0;\r\nk = -1;\r\ndo {\r\nif (--t < 0) {\r\non = 1 - on;\r\nbtext_drawchar(on? 0xdb: 0x20);\r\nbtext_drawchar('\b');\r\nt = 200000;\r\n}\r\nudbg_adb_poll();\r\nif (udbg_adb_old_getc_poll)\r\nk = udbg_adb_old_getc_poll();\r\n} while (k == -1 && xmon_adb_keycode == -1);\r\nif (on)\r\nbtext_drawstring(" \b");\r\nif (k != -1)\r\nreturn k;\r\nk = xmon_adb_keycode;\r\nif ((k & 0x7f) == 0x38 || (k & 0x7f) == 0x7b) {\r\nxmon_adb_shiftstate = (k & 0x80) == 0;\r\ncontinue;\r\n}\r\nif (k >= 0x80)\r\ncontinue;\r\nk = (xmon_adb_shiftstate? xmon_shift_keytab: xmon_keytab)[k];\r\nif (k != 0)\r\nbreak;\r\n}\r\nxmon_wants_key = 0;\r\nreturn k;\r\n}\r\nstatic int udbg_adb_getc(void)\r\n{\r\n#ifdef CONFIG_BOOTX_TEXT\r\nif (udbg_adb_use_btext && input_type != input_adb_none)\r\nreturn udbg_adb_local_getc();\r\n#endif\r\nif (udbg_adb_old_getc)\r\nreturn udbg_adb_old_getc();\r\nreturn -1;\r\n}\r\nstatic int udbg_adb_getc_poll(void)\r\n{\r\nudbg_adb_poll();\r\nif (udbg_adb_old_getc_poll)\r\nreturn udbg_adb_old_getc_poll();\r\nreturn -1;\r\n}\r\nstatic void udbg_adb_putc(char c)\r\n{\r\n#ifdef CONFIG_BOOTX_TEXT\r\nif (udbg_adb_use_btext)\r\nbtext_drawchar(c);\r\n#endif\r\nif (udbg_adb_old_putc)\r\nreturn udbg_adb_old_putc(c);\r\n}\r\nvoid __init udbg_adb_init_early(void)\r\n{\r\n#ifdef CONFIG_BOOTX_TEXT\r\nif (btext_find_display(1) == 0) {\r\nudbg_adb_use_btext = 1;\r\nudbg_putc = udbg_adb_putc;\r\n}\r\n#endif\r\n}\r\nint __init udbg_adb_init(int force_btext)\r\n{\r\nstruct device_node *np;\r\nudbg_adb_old_putc = udbg_putc;\r\nudbg_adb_old_getc = udbg_getc;\r\nudbg_adb_old_getc_poll = udbg_getc_poll;\r\nif (udbg_adb_old_putc == udbg_adb_putc)\r\nudbg_adb_old_putc = NULL;\r\n#ifdef CONFIG_BOOTX_TEXT\r\nif (udbg_adb_old_putc == btext_drawchar)\r\nudbg_adb_old_putc = NULL;\r\n#endif\r\nudbg_putc = udbg_adb_putc;\r\nudbg_getc = udbg_adb_getc;\r\nudbg_getc_poll = udbg_adb_getc_poll;\r\n#ifdef CONFIG_BOOTX_TEXT\r\nif (btext_find_display(force_btext) == 0)\r\nudbg_adb_use_btext = 1;\r\n#endif\r\nfor_each_node_by_name(np, "keyboard") {\r\nstruct device_node *parent = of_get_parent(np);\r\nint found = (parent && strcmp(parent->type, "adb") == 0);\r\nof_node_put(parent);\r\nif (found)\r\nbreak;\r\n}\r\nif (np == NULL)\r\nreturn -ENODEV;\r\nof_node_put(np);\r\n#ifdef CONFIG_ADB_PMU\r\nif (find_via_pmu())\r\ninput_type = input_adb_pmu;\r\n#endif\r\n#ifdef CONFIG_ADB_CUDA\r\nif (find_via_cuda())\r\ninput_type = input_adb_cuda;\r\n#endif\r\nif (input_type == input_adb_none)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}

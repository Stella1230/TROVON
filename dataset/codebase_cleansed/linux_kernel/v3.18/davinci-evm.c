static int evm_startup(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_card *soc_card = rtd->card;\r\nstruct snd_soc_card_drvdata_davinci *drvdata =\r\nsnd_soc_card_get_drvdata(soc_card);\r\nif (drvdata->mclk)\r\nreturn clk_prepare_enable(drvdata->mclk);\r\nreturn 0;\r\n}\r\nstatic void evm_shutdown(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_card *soc_card = rtd->card;\r\nstruct snd_soc_card_drvdata_davinci *drvdata =\r\nsnd_soc_card_get_drvdata(soc_card);\r\nif (drvdata->mclk)\r\nclk_disable_unprepare(drvdata->mclk);\r\n}\r\nstatic int evm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nstruct snd_soc_card *soc_card = rtd->card;\r\nint ret = 0;\r\nunsigned sysclk = ((struct snd_soc_card_drvdata_davinci *)\r\nsnd_soc_card_get_drvdata(soc_card))->sysclk;\r\nret = snd_soc_dai_set_sysclk(codec_dai, 0, sysclk, SND_SOC_CLOCK_OUT);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(cpu_dai, 0, sysclk, SND_SOC_CLOCK_OUT);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int evm_aic3x_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_card *card = rtd->card;\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct device_node *np = card->dev->of_node;\r\nint ret;\r\nsnd_soc_dapm_new_controls(&card->dapm, aic3x_dapm_widgets,\r\nARRAY_SIZE(aic3x_dapm_widgets));\r\nif (np) {\r\nret = snd_soc_of_parse_audio_routing(card, "ti,audio-routing");\r\nif (ret)\r\nreturn ret;\r\n} else {\r\nsnd_soc_dapm_add_routes(&card->dapm, audio_map,\r\nARRAY_SIZE(audio_map));\r\n}\r\nsnd_soc_dapm_nc_pin(&codec->dapm, "MONO_LOUT");\r\nsnd_soc_dapm_nc_pin(&codec->dapm, "HPLCOM");\r\nsnd_soc_dapm_nc_pin(&codec->dapm, "HPRCOM");\r\nreturn 0;\r\n}\r\nstatic int davinci_evm_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nconst struct of_device_id *match =\r\nof_match_device(of_match_ptr(davinci_evm_dt_ids), &pdev->dev);\r\nstruct snd_soc_dai_link *dai = (struct snd_soc_dai_link *) match->data;\r\nstruct snd_soc_card_drvdata_davinci *drvdata = NULL;\r\nstruct clk *mclk;\r\nint ret = 0;\r\nevm_soc_card.dai_link = dai;\r\ndai->codec_of_node = of_parse_phandle(np, "ti,audio-codec", 0);\r\nif (!dai->codec_of_node)\r\nreturn -EINVAL;\r\ndai->cpu_of_node = of_parse_phandle(np, "ti,mcasp-controller", 0);\r\nif (!dai->cpu_of_node)\r\nreturn -EINVAL;\r\ndai->platform_of_node = dai->cpu_of_node;\r\nevm_soc_card.dev = &pdev->dev;\r\nret = snd_soc_of_parse_card_name(&evm_soc_card, "ti,model");\r\nif (ret)\r\nreturn ret;\r\nmclk = devm_clk_get(&pdev->dev, "mclk");\r\nif (PTR_ERR(mclk) == -EPROBE_DEFER) {\r\nreturn -EPROBE_DEFER;\r\n} else if (IS_ERR(mclk)) {\r\ndev_dbg(&pdev->dev, "mclk not found.\n");\r\nmclk = NULL;\r\n}\r\ndrvdata = devm_kzalloc(&pdev->dev, sizeof(*drvdata), GFP_KERNEL);\r\nif (!drvdata)\r\nreturn -ENOMEM;\r\ndrvdata->mclk = mclk;\r\nret = of_property_read_u32(np, "ti,codec-clock-rate", &drvdata->sysclk);\r\nif (ret < 0) {\r\nif (!drvdata->mclk) {\r\ndev_err(&pdev->dev,\r\n"No clock or clock rate defined.\n");\r\nreturn -EINVAL;\r\n}\r\ndrvdata->sysclk = clk_get_rate(drvdata->mclk);\r\n} else if (drvdata->mclk) {\r\nunsigned int requestd_rate = drvdata->sysclk;\r\nclk_set_rate(drvdata->mclk, drvdata->sysclk);\r\ndrvdata->sysclk = clk_get_rate(drvdata->mclk);\r\nif (drvdata->sysclk != requestd_rate)\r\ndev_warn(&pdev->dev,\r\n"Could not get requested rate %u using %u.\n",\r\nrequestd_rate, drvdata->sysclk);\r\n}\r\nsnd_soc_card_set_drvdata(&evm_soc_card, drvdata);\r\nret = devm_snd_soc_register_card(&pdev->dev, &evm_soc_card);\r\nif (ret)\r\ndev_err(&pdev->dev, "snd_soc_register_card failed (%d)\n", ret);\r\nreturn ret;\r\n}\r\nstatic int davinci_evm_remove(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = platform_get_drvdata(pdev);\r\nsnd_soc_unregister_card(card);\r\nreturn 0;\r\n}\r\nstatic int __init evm_init(void)\r\n{\r\nstruct snd_soc_card *evm_snd_dev_data;\r\nint index;\r\nint ret;\r\n#if defined(CONFIG_OF)\r\nif (of_have_populated_dt())\r\nreturn platform_driver_register(&davinci_evm_driver);\r\n#endif\r\nif (machine_is_davinci_evm()) {\r\nevm_snd_dev_data = &dm6446_snd_soc_card_evm;\r\nindex = 0;\r\n} else if (machine_is_davinci_dm355_evm()) {\r\nevm_snd_dev_data = &dm355_snd_soc_card_evm;\r\nindex = 1;\r\n} else if (machine_is_davinci_dm365_evm()) {\r\nevm_snd_dev_data = &dm365_snd_soc_card_evm;\r\nindex = 0;\r\n} else if (machine_is_davinci_dm6467_evm()) {\r\nevm_snd_dev_data = &dm6467_snd_soc_card_evm;\r\nindex = 0;\r\n} else if (machine_is_davinci_da830_evm()) {\r\nevm_snd_dev_data = &da830_snd_soc_card;\r\nindex = 1;\r\n} else if (machine_is_davinci_da850_evm()) {\r\nevm_snd_dev_data = &da850_snd_soc_card;\r\nindex = 0;\r\n} else\r\nreturn -EINVAL;\r\nevm_snd_device = platform_device_alloc("soc-audio", index);\r\nif (!evm_snd_device)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(evm_snd_device, evm_snd_dev_data);\r\nret = platform_device_add(evm_snd_device);\r\nif (ret)\r\nplatform_device_put(evm_snd_device);\r\nreturn ret;\r\n}\r\nstatic void __exit evm_exit(void)\r\n{\r\n#if defined(CONFIG_OF)\r\nif (of_have_populated_dt()) {\r\nplatform_driver_unregister(&davinci_evm_driver);\r\nreturn;\r\n}\r\n#endif\r\nplatform_device_unregister(evm_snd_device);\r\n}

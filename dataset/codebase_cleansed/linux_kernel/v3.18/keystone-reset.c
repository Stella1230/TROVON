static inline int rsctrl_enable_rspll_write(void)\r\n{\r\nreturn regmap_update_bits(pllctrl_regs, rspll_offset + RSCTRL_RG,\r\nRSCTRL_KEY_MASK, RSCTRL_KEY);\r\n}\r\nstatic void rsctrl_restart(enum reboot_mode mode, const char *cmd)\r\n{\r\nrsctrl_enable_rspll_write();\r\nregmap_update_bits(pllctrl_regs, rspll_offset + RSCTRL_RG,\r\nRSCTRL_RESET_MASK, 0);\r\n}\r\nstatic int rsctrl_probe(struct platform_device *pdev)\r\n{\r\nint i;\r\nint ret;\r\nu32 val;\r\nunsigned int rg;\r\nu32 rsmux_offset;\r\nstruct regmap *devctrl_regs;\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nif (!np)\r\nreturn -ENODEV;\r\npllctrl_regs = syscon_regmap_lookup_by_phandle(np, "ti,syscon-pll");\r\nif (IS_ERR(pllctrl_regs))\r\nreturn PTR_ERR(pllctrl_regs);\r\ndevctrl_regs = syscon_regmap_lookup_by_phandle(np, "ti,syscon-dev");\r\nif (IS_ERR(devctrl_regs))\r\nreturn PTR_ERR(devctrl_regs);\r\nret = of_property_read_u32_index(np, "ti,syscon-pll", 1, &rspll_offset);\r\nif (ret) {\r\ndev_err(dev, "couldn't read the reset pll offset!\n");\r\nreturn -EINVAL;\r\n}\r\nret = of_property_read_u32_index(np, "ti,syscon-dev", 1, &rsmux_offset);\r\nif (ret) {\r\ndev_err(dev, "couldn't read the rsmux offset!\n");\r\nreturn -EINVAL;\r\n}\r\nval = of_property_read_bool(np, "ti,soft-reset");\r\nval = val ? RSCFG_RSTYPE_SOFT : RSCFG_RSTYPE_HARD;\r\nret = rsctrl_enable_rspll_write();\r\nif (ret)\r\nreturn ret;\r\nret = regmap_write(pllctrl_regs, rspll_offset + RSCFG_RG, val);\r\nif (ret)\r\nreturn ret;\r\narm_pm_restart = rsctrl_restart;\r\nret = regmap_write(pllctrl_regs, rspll_offset + RSISO_RG, 0);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < WDT_MUX_NUMBER; i++) {\r\nret = of_property_read_u32_index(np, "ti,wdt-list", i, &val);\r\nif (ret == -EOVERFLOW && !i) {\r\ndev_err(dev, "ti,wdt-list property has to contain at"\r\n"least one entry\n");\r\nreturn -EINVAL;\r\n} else if (ret) {\r\nbreak;\r\n}\r\nif (val >= WDT_MUX_NUMBER) {\r\ndev_err(dev, "ti,wdt-list property can contain"\r\n"only numbers < 4\n");\r\nreturn -EINVAL;\r\n}\r\nrg = rsmux_offset + val * 4;\r\nret = regmap_update_bits(devctrl_regs, rg, RSMUX_OMODE_MASK,\r\nRSMUX_OMODE_RESET_ON |\r\nRSMUX_LOCK_SET);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

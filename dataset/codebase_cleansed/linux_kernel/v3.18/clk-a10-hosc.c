static void __init sun4i_osc_clk_setup(struct device_node *node)\r\n{\r\nstruct clk *clk;\r\nstruct clk_fixed_rate *fixed;\r\nstruct clk_gate *gate;\r\nconst char *clk_name = node->name;\r\nu32 rate;\r\nif (of_property_read_u32(node, "clock-frequency", &rate))\r\nreturn;\r\nfixed = kzalloc(sizeof(struct clk_fixed_rate), GFP_KERNEL);\r\nif (!fixed)\r\nreturn;\r\ngate = kzalloc(sizeof(struct clk_gate), GFP_KERNEL);\r\nif (!gate)\r\ngoto err_free_fixed;\r\nof_property_read_string(node, "clock-output-names", &clk_name);\r\ngate->reg = of_iomap(node, 0);\r\ngate->bit_idx = SUNXI_OSC24M_GATE;\r\ngate->lock = &hosc_lock;\r\nfixed->fixed_rate = rate;\r\nclk = clk_register_composite(NULL, clk_name,\r\nNULL, 0,\r\nNULL, NULL,\r\n&fixed->hw, &clk_fixed_rate_ops,\r\n&gate->hw, &clk_gate_ops,\r\nCLK_IS_ROOT);\r\nif (IS_ERR(clk))\r\ngoto err_free_gate;\r\nof_clk_add_provider(node, of_clk_src_simple_get, clk);\r\nclk_register_clkdev(clk, clk_name, NULL);\r\nreturn;\r\nerr_free_gate:\r\nkfree(gate);\r\nerr_free_fixed:\r\nkfree(fixed);\r\n}

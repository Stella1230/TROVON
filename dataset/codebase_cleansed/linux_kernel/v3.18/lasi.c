static void lasi_choose_irq(struct parisc_device *dev, void *ctrl)\r\n{\r\nint irq;\r\nswitch (dev->id.sversion) {\r\ncase 0x74: irq = 7; break;\r\ncase 0x7B: irq = 13; break;\r\ncase 0x81: irq = 14; break;\r\ncase 0x82: irq = 9; break;\r\ncase 0x83: irq = 20; break;\r\ncase 0x84: irq = 26; break;\r\ncase 0x87: irq = 18; break;\r\ncase 0x8A: irq = 8; break;\r\ncase 0x8C: irq = 5; break;\r\ncase 0x8D: irq = (dev->hw_path == 13) ? 16 : 17; break;\r\ndefault: return;\r\n}\r\ngsc_asic_assign_irq(ctrl, irq, &dev->irq);\r\n}\r\nstatic void __init\r\nlasi_init_irq(struct gsc_asic *this_lasi)\r\n{\r\nunsigned long lasi_base = this_lasi->hpa;\r\ngsc_writel(0x00000000, lasi_base+OFFSET_IMR);\r\ngsc_readl(lasi_base+OFFSET_IRR);\r\nif(pdc_add_valid(lasi_base+0x4004) == PDC_OK)\r\ngsc_writel(0xFFFFFFFF, lasi_base+0x4004);\r\ngsc_writel(0xFFFFFFFF, lasi_base+0x7000);\r\ngsc_writel(0xFFFFFFFF, lasi_base+0x8000);\r\ngsc_writel(0xFFFFFFFF, lasi_base+0xA000);\r\n}\r\nstatic void __init lasi_led_init(unsigned long lasi_hpa)\r\n{\r\nunsigned long datareg;\r\nswitch (CPU_HVERSION) {\r\ncase 0x600:\r\ncase 0x601:\r\ncase 0x602:\r\ncase 0x603:\r\ncase 0x604:\r\ncase 0x605:\r\ndatareg = lasi_hpa + 0x0000C000;\r\ngsc_writeb(0, datareg);\r\nreturn;\r\ncase 0x60A:\r\ncase 0x60B:\r\ncase 0x60C:\r\ncase 0x60D:\r\ncase 0x60E:\r\ndatareg = lasi_hpa - 0x00020000;\r\nbreak;\r\ndefault:\r\ndatareg = lasi_hpa + 0x0000C000;\r\nbreak;\r\n}\r\nregister_led_driver(DISPLAY_MODEL_LASI, LED_CMD_REG_NONE, datareg);\r\n}\r\nstatic void lasi_power_off(void)\r\n{\r\nunsigned long datareg;\r\ndatareg = lasi_power_off_hpa + 0x0000C000;\r\ngsc_writel(0x02, datareg);\r\n}\r\nstatic int __init lasi_init_chip(struct parisc_device *dev)\r\n{\r\nextern void (*chassis_power_off)(void);\r\nstruct gsc_asic *lasi;\r\nstruct gsc_irq gsc_irq;\r\nint ret;\r\nlasi = kzalloc(sizeof(*lasi), GFP_KERNEL);\r\nif (!lasi)\r\nreturn -ENOMEM;\r\nlasi->name = "Lasi";\r\nlasi->hpa = dev->hpa.start;\r\nlasi->version = gsc_readl(lasi->hpa + LASI_VER) & 0xf;\r\nprintk(KERN_INFO "%s version %d at 0x%lx found.\n",\r\nlasi->name, lasi->version, lasi->hpa);\r\nlasi_led_init(lasi->hpa);\r\nlasi_init_irq(lasi);\r\ndev->irq = gsc_alloc_irq(&gsc_irq);\r\nif (dev->irq < 0) {\r\nprintk(KERN_ERR "%s(): cannot get GSC irq\n",\r\n__func__);\r\nkfree(lasi);\r\nreturn -EBUSY;\r\n}\r\nlasi->eim = ((u32) gsc_irq.txn_addr) | gsc_irq.txn_data;\r\nret = request_irq(gsc_irq.irq, gsc_asic_intr, 0, "lasi", lasi);\r\nif (ret < 0) {\r\nkfree(lasi);\r\nreturn ret;\r\n}\r\ngsc_writel(lasi->eim, lasi->hpa + OFFSET_IAR);\r\nret = gsc_common_setup(dev, lasi);\r\nif (ret) {\r\nkfree(lasi);\r\nreturn ret;\r\n}\r\ngsc_fixup_irqs(dev, lasi, lasi_choose_irq);\r\nlasi_power_off_hpa = lasi->hpa;\r\nchassis_power_off = lasi_power_off;\r\nreturn ret;\r\n}

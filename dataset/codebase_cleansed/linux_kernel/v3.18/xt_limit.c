static bool\r\nlimit_mt(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_rateinfo *r = par->matchinfo;\r\nstruct xt_limit_priv *priv = r->master;\r\nunsigned long now = jiffies;\r\nspin_lock_bh(&limit_lock);\r\npriv->credit += (now - xchg(&priv->prev, now)) * CREDITS_PER_JIFFY;\r\nif (priv->credit > r->credit_cap)\r\npriv->credit = r->credit_cap;\r\nif (priv->credit >= r->cost) {\r\npriv->credit -= r->cost;\r\nspin_unlock_bh(&limit_lock);\r\nreturn true;\r\n}\r\nspin_unlock_bh(&limit_lock);\r\nreturn false;\r\n}\r\nstatic u32 user2credits(u32 user)\r\n{\r\nif (user > 0xFFFFFFFF / (HZ*CREDITS_PER_JIFFY))\r\nreturn (user / XT_LIMIT_SCALE) * HZ * CREDITS_PER_JIFFY;\r\nreturn (user * HZ * CREDITS_PER_JIFFY) / XT_LIMIT_SCALE;\r\n}\r\nstatic int limit_mt_check(const struct xt_mtchk_param *par)\r\n{\r\nstruct xt_rateinfo *r = par->matchinfo;\r\nstruct xt_limit_priv *priv;\r\nif (r->burst == 0\r\n|| user2credits(r->avg * r->burst) < user2credits(r->avg)) {\r\npr_info("Overflow, try lower: %u/%u\n",\r\nr->avg, r->burst);\r\nreturn -ERANGE;\r\n}\r\npriv = kmalloc(sizeof(*priv), GFP_KERNEL);\r\nif (priv == NULL)\r\nreturn -ENOMEM;\r\nr->master = priv;\r\npriv->prev = jiffies;\r\npriv->credit = user2credits(r->avg * r->burst);\r\nif (r->cost == 0) {\r\nr->credit_cap = priv->credit;\r\nr->cost = user2credits(r->avg);\r\n}\r\nreturn 0;\r\n}\r\nstatic void limit_mt_destroy(const struct xt_mtdtor_param *par)\r\n{\r\nconst struct xt_rateinfo *info = par->matchinfo;\r\nkfree(info->master);\r\n}\r\nstatic void limit_mt_compat_from_user(void *dst, const void *src)\r\n{\r\nconst struct compat_xt_rateinfo *cm = src;\r\nstruct xt_rateinfo m = {\r\n.avg = cm->avg,\r\n.burst = cm->burst,\r\n.prev = cm->prev | (unsigned long)cm->master << 32,\r\n.credit = cm->credit,\r\n.credit_cap = cm->credit_cap,\r\n.cost = cm->cost,\r\n};\r\nmemcpy(dst, &m, sizeof(m));\r\n}\r\nstatic int limit_mt_compat_to_user(void __user *dst, const void *src)\r\n{\r\nconst struct xt_rateinfo *m = src;\r\nstruct compat_xt_rateinfo cm = {\r\n.avg = m->avg,\r\n.burst = m->burst,\r\n.prev = m->prev,\r\n.credit = m->credit,\r\n.credit_cap = m->credit_cap,\r\n.cost = m->cost,\r\n.master = m->prev >> 32,\r\n};\r\nreturn copy_to_user(dst, &cm, sizeof(cm)) ? -EFAULT : 0;\r\n}\r\nstatic int __init limit_mt_init(void)\r\n{\r\nreturn xt_register_match(&limit_mt_reg);\r\n}\r\nstatic void __exit limit_mt_exit(void)\r\n{\r\nxt_unregister_match(&limit_mt_reg);\r\n}

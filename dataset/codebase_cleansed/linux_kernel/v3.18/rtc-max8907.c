static irqreturn_t max8907_irq_handler(int irq, void *data)\r\n{\r\nstruct max8907_rtc *rtc = data;\r\nregmap_write(rtc->regmap, MAX8907_REG_ALARM0_CNTL, 0);\r\nrtc_update_irq(rtc->rtc_dev, 1, RTC_IRQF | RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void regs_to_tm(u8 *regs, struct rtc_time *tm)\r\n{\r\ntm->tm_year = bcd2bin(regs[RTC_YEAR2]) * 100 +\r\nbcd2bin(regs[RTC_YEAR1]) - 1900;\r\ntm->tm_mon = bcd2bin(regs[RTC_MONTH] & 0x1f) - 1;\r\ntm->tm_mday = bcd2bin(regs[RTC_DATE] & 0x3f);\r\ntm->tm_wday = (regs[RTC_WEEKDAY] & 0x07);\r\nif (regs[RTC_HOUR] & HOUR_12) {\r\ntm->tm_hour = bcd2bin(regs[RTC_HOUR] & 0x01f);\r\nif (tm->tm_hour == 12)\r\ntm->tm_hour = 0;\r\nif (regs[RTC_HOUR] & HOUR_AM_PM)\r\ntm->tm_hour += 12;\r\n} else {\r\ntm->tm_hour = bcd2bin(regs[RTC_HOUR] & 0x03f);\r\n}\r\ntm->tm_min = bcd2bin(regs[RTC_MIN] & 0x7f);\r\ntm->tm_sec = bcd2bin(regs[RTC_SEC] & 0x7f);\r\n}\r\nstatic void tm_to_regs(struct rtc_time *tm, u8 *regs)\r\n{\r\nu8 high, low;\r\nhigh = (tm->tm_year + 1900) / 100;\r\nlow = tm->tm_year % 100;\r\nregs[RTC_YEAR2] = bin2bcd(high);\r\nregs[RTC_YEAR1] = bin2bcd(low);\r\nregs[RTC_MONTH] = bin2bcd(tm->tm_mon + 1);\r\nregs[RTC_DATE] = bin2bcd(tm->tm_mday);\r\nregs[RTC_WEEKDAY] = tm->tm_wday;\r\nregs[RTC_HOUR] = bin2bcd(tm->tm_hour);\r\nregs[RTC_MIN] = bin2bcd(tm->tm_min);\r\nregs[RTC_SEC] = bin2bcd(tm->tm_sec);\r\n}\r\nstatic int max8907_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct max8907_rtc *rtc = dev_get_drvdata(dev);\r\nu8 regs[TIME_NUM];\r\nint ret;\r\nret = regmap_bulk_read(rtc->regmap, MAX8907_REG_RTC_SEC, regs,\r\nTIME_NUM);\r\nif (ret < 0)\r\nreturn ret;\r\nregs_to_tm(regs, tm);\r\nreturn 0;\r\n}\r\nstatic int max8907_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct max8907_rtc *rtc = dev_get_drvdata(dev);\r\nu8 regs[TIME_NUM];\r\ntm_to_regs(tm, regs);\r\nreturn regmap_bulk_write(rtc->regmap, MAX8907_REG_RTC_SEC, regs,\r\nTIME_NUM);\r\n}\r\nstatic int max8907_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct max8907_rtc *rtc = dev_get_drvdata(dev);\r\nu8 regs[TIME_NUM];\r\nunsigned int val;\r\nint ret;\r\nret = regmap_bulk_read(rtc->regmap, MAX8907_REG_ALARM0_SEC, regs,\r\nTIME_NUM);\r\nif (ret < 0)\r\nreturn ret;\r\nregs_to_tm(regs, &alrm->time);\r\nret = regmap_read(rtc->regmap, MAX8907_REG_ALARM0_CNTL, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nalrm->enabled = !!(val & 0x7f);\r\nreturn 0;\r\n}\r\nstatic int max8907_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct max8907_rtc *rtc = dev_get_drvdata(dev);\r\nu8 regs[TIME_NUM];\r\nint ret;\r\ntm_to_regs(&alrm->time, regs);\r\nret = regmap_write(rtc->regmap, MAX8907_REG_ALARM0_CNTL, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_bulk_write(rtc->regmap, MAX8907_REG_ALARM0_SEC, regs,\r\nTIME_NUM);\r\nif (ret < 0)\r\nreturn ret;\r\nif (alrm->enabled)\r\nret = regmap_write(rtc->regmap, MAX8907_REG_ALARM0_CNTL, 0x77);\r\nreturn ret;\r\n}\r\nstatic int max8907_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct max8907 *max8907 = dev_get_drvdata(pdev->dev.parent);\r\nstruct max8907_rtc *rtc;\r\nint ret;\r\nrtc = devm_kzalloc(&pdev->dev, sizeof(*rtc), GFP_KERNEL);\r\nif (!rtc)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, rtc);\r\nrtc->max8907 = max8907;\r\nrtc->regmap = max8907->regmap_rtc;\r\nrtc->rtc_dev = devm_rtc_device_register(&pdev->dev, "max8907-rtc",\r\n&max8907_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc->rtc_dev)) {\r\nret = PTR_ERR(rtc->rtc_dev);\r\ndev_err(&pdev->dev, "Failed to register RTC device: %d\n", ret);\r\nreturn ret;\r\n}\r\nrtc->irq = regmap_irq_get_virq(max8907->irqc_rtc,\r\nMAX8907_IRQ_RTC_ALARM0);\r\nif (rtc->irq < 0)\r\nreturn rtc->irq;\r\nret = devm_request_threaded_irq(&pdev->dev, rtc->irq, NULL,\r\nmax8907_irq_handler,\r\nIRQF_ONESHOT, "max8907-alarm0", rtc);\r\nif (ret < 0)\r\ndev_err(&pdev->dev, "Failed to request IRQ%d: %d\n",\r\nrtc->irq, ret);\r\nreturn ret;\r\n}

static int\r\nixgb_get_settings(struct net_device *netdev, struct ethtool_cmd *ecmd)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\necmd->supported = (SUPPORTED_10000baseT_Full | SUPPORTED_FIBRE);\r\necmd->advertising = (ADVERTISED_10000baseT_Full | ADVERTISED_FIBRE);\r\necmd->port = PORT_FIBRE;\r\necmd->transceiver = XCVR_EXTERNAL;\r\nif (netif_carrier_ok(adapter->netdev)) {\r\nethtool_cmd_speed_set(ecmd, SPEED_10000);\r\necmd->duplex = DUPLEX_FULL;\r\n} else {\r\nethtool_cmd_speed_set(ecmd, SPEED_UNKNOWN);\r\necmd->duplex = DUPLEX_UNKNOWN;\r\n}\r\necmd->autoneg = AUTONEG_DISABLE;\r\nreturn 0;\r\n}\r\nvoid ixgb_set_speed_duplex(struct net_device *netdev)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\nadapter->link_speed = 10000;\r\nadapter->link_duplex = FULL_DUPLEX;\r\nnetif_carrier_on(netdev);\r\nnetif_wake_queue(netdev);\r\n}\r\nstatic int\r\nixgb_set_settings(struct net_device *netdev, struct ethtool_cmd *ecmd)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\nu32 speed = ethtool_cmd_speed(ecmd);\r\nif (ecmd->autoneg == AUTONEG_ENABLE ||\r\n(speed + ecmd->duplex != SPEED_10000 + DUPLEX_FULL))\r\nreturn -EINVAL;\r\nif (netif_running(adapter->netdev)) {\r\nixgb_down(adapter, true);\r\nixgb_reset(adapter);\r\nixgb_up(adapter);\r\nixgb_set_speed_duplex(netdev);\r\n} else\r\nixgb_reset(adapter);\r\nreturn 0;\r\n}\r\nstatic void\r\nixgb_get_pauseparam(struct net_device *netdev,\r\nstruct ethtool_pauseparam *pause)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\nstruct ixgb_hw *hw = &adapter->hw;\r\npause->autoneg = AUTONEG_DISABLE;\r\nif (hw->fc.type == ixgb_fc_rx_pause)\r\npause->rx_pause = 1;\r\nelse if (hw->fc.type == ixgb_fc_tx_pause)\r\npause->tx_pause = 1;\r\nelse if (hw->fc.type == ixgb_fc_full) {\r\npause->rx_pause = 1;\r\npause->tx_pause = 1;\r\n}\r\n}\r\nstatic int\r\nixgb_set_pauseparam(struct net_device *netdev,\r\nstruct ethtool_pauseparam *pause)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\nstruct ixgb_hw *hw = &adapter->hw;\r\nif (pause->autoneg == AUTONEG_ENABLE)\r\nreturn -EINVAL;\r\nif (pause->rx_pause && pause->tx_pause)\r\nhw->fc.type = ixgb_fc_full;\r\nelse if (pause->rx_pause && !pause->tx_pause)\r\nhw->fc.type = ixgb_fc_rx_pause;\r\nelse if (!pause->rx_pause && pause->tx_pause)\r\nhw->fc.type = ixgb_fc_tx_pause;\r\nelse if (!pause->rx_pause && !pause->tx_pause)\r\nhw->fc.type = ixgb_fc_none;\r\nif (netif_running(adapter->netdev)) {\r\nixgb_down(adapter, true);\r\nixgb_up(adapter);\r\nixgb_set_speed_duplex(netdev);\r\n} else\r\nixgb_reset(adapter);\r\nreturn 0;\r\n}\r\nstatic u32\r\nixgb_get_msglevel(struct net_device *netdev)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\nreturn adapter->msg_enable;\r\n}\r\nstatic void\r\nixgb_set_msglevel(struct net_device *netdev, u32 data)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\nadapter->msg_enable = data;\r\n}\r\nstatic int\r\nixgb_get_regs_len(struct net_device *netdev)\r\n{\r\n#define IXGB_REG_DUMP_LEN 136*sizeof(u32)\r\nreturn IXGB_REG_DUMP_LEN;\r\n}\r\nstatic void\r\nixgb_get_regs(struct net_device *netdev,\r\nstruct ethtool_regs *regs, void *p)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\nstruct ixgb_hw *hw = &adapter->hw;\r\nu32 *reg = p;\r\nu32 *reg_start = reg;\r\nu8 i;\r\nregs->version = (1<<24) | hw->revision_id << 16 | hw->device_id;\r\n*reg++ = IXGB_READ_REG(hw, CTRL0);\r\n*reg++ = IXGB_READ_REG(hw, CTRL1);\r\n*reg++ = IXGB_READ_REG(hw, STATUS);\r\n*reg++ = IXGB_READ_REG(hw, EECD);\r\n*reg++ = IXGB_READ_REG(hw, MFS);\r\n*reg++ = IXGB_READ_REG(hw, ICR);\r\n*reg++ = IXGB_READ_REG(hw, ICS);\r\n*reg++ = IXGB_READ_REG(hw, IMS);\r\n*reg++ = IXGB_READ_REG(hw, IMC);\r\n*reg++ = IXGB_READ_REG(hw, RCTL);\r\n*reg++ = IXGB_READ_REG(hw, FCRTL);\r\n*reg++ = IXGB_READ_REG(hw, FCRTH);\r\n*reg++ = IXGB_READ_REG(hw, RDBAL);\r\n*reg++ = IXGB_READ_REG(hw, RDBAH);\r\n*reg++ = IXGB_READ_REG(hw, RDLEN);\r\n*reg++ = IXGB_READ_REG(hw, RDH);\r\n*reg++ = IXGB_READ_REG(hw, RDT);\r\n*reg++ = IXGB_READ_REG(hw, RDTR);\r\n*reg++ = IXGB_READ_REG(hw, RXDCTL);\r\n*reg++ = IXGB_READ_REG(hw, RAIDC);\r\n*reg++ = IXGB_READ_REG(hw, RXCSUM);\r\nfor (i = 0; i < IXGB_ALL_RAR_ENTRIES; i++) {\r\n*reg++ = IXGB_READ_REG_ARRAY(hw, RAL, (i << 1));\r\n*reg++ = IXGB_READ_REG_ARRAY(hw, RAH, (i << 1));\r\n}\r\n*reg++ = IXGB_READ_REG(hw, TCTL);\r\n*reg++ = IXGB_READ_REG(hw, TDBAL);\r\n*reg++ = IXGB_READ_REG(hw, TDBAH);\r\n*reg++ = IXGB_READ_REG(hw, TDLEN);\r\n*reg++ = IXGB_READ_REG(hw, TDH);\r\n*reg++ = IXGB_READ_REG(hw, TDT);\r\n*reg++ = IXGB_READ_REG(hw, TIDV);\r\n*reg++ = IXGB_READ_REG(hw, TXDCTL);\r\n*reg++ = IXGB_READ_REG(hw, TSPMT);\r\n*reg++ = IXGB_READ_REG(hw, PAP);\r\n*reg++ = IXGB_READ_REG(hw, PCSC1);\r\n*reg++ = IXGB_READ_REG(hw, PCSC2);\r\n*reg++ = IXGB_READ_REG(hw, PCSS1);\r\n*reg++ = IXGB_READ_REG(hw, PCSS2);\r\n*reg++ = IXGB_READ_REG(hw, XPCSS);\r\n*reg++ = IXGB_READ_REG(hw, UCCR);\r\n*reg++ = IXGB_READ_REG(hw, XPCSTC);\r\n*reg++ = IXGB_READ_REG(hw, MACA);\r\n*reg++ = IXGB_READ_REG(hw, APAE);\r\n*reg++ = IXGB_READ_REG(hw, ARD);\r\n*reg++ = IXGB_READ_REG(hw, AIS);\r\n*reg++ = IXGB_READ_REG(hw, MSCA);\r\n*reg++ = IXGB_READ_REG(hw, MSRWD);\r\n*reg++ = IXGB_GET_STAT(adapter, tprl);\r\n*reg++ = IXGB_GET_STAT(adapter, tprh);\r\n*reg++ = IXGB_GET_STAT(adapter, gprcl);\r\n*reg++ = IXGB_GET_STAT(adapter, gprch);\r\n*reg++ = IXGB_GET_STAT(adapter, bprcl);\r\n*reg++ = IXGB_GET_STAT(adapter, bprch);\r\n*reg++ = IXGB_GET_STAT(adapter, mprcl);\r\n*reg++ = IXGB_GET_STAT(adapter, mprch);\r\n*reg++ = IXGB_GET_STAT(adapter, uprcl);\r\n*reg++ = IXGB_GET_STAT(adapter, uprch);\r\n*reg++ = IXGB_GET_STAT(adapter, vprcl);\r\n*reg++ = IXGB_GET_STAT(adapter, vprch);\r\n*reg++ = IXGB_GET_STAT(adapter, jprcl);\r\n*reg++ = IXGB_GET_STAT(adapter, jprch);\r\n*reg++ = IXGB_GET_STAT(adapter, gorcl);\r\n*reg++ = IXGB_GET_STAT(adapter, gorch);\r\n*reg++ = IXGB_GET_STAT(adapter, torl);\r\n*reg++ = IXGB_GET_STAT(adapter, torh);\r\n*reg++ = IXGB_GET_STAT(adapter, rnbc);\r\n*reg++ = IXGB_GET_STAT(adapter, ruc);\r\n*reg++ = IXGB_GET_STAT(adapter, roc);\r\n*reg++ = IXGB_GET_STAT(adapter, rlec);\r\n*reg++ = IXGB_GET_STAT(adapter, crcerrs);\r\n*reg++ = IXGB_GET_STAT(adapter, icbc);\r\n*reg++ = IXGB_GET_STAT(adapter, ecbc);\r\n*reg++ = IXGB_GET_STAT(adapter, mpc);\r\n*reg++ = IXGB_GET_STAT(adapter, tptl);\r\n*reg++ = IXGB_GET_STAT(adapter, tpth);\r\n*reg++ = IXGB_GET_STAT(adapter, gptcl);\r\n*reg++ = IXGB_GET_STAT(adapter, gptch);\r\n*reg++ = IXGB_GET_STAT(adapter, bptcl);\r\n*reg++ = IXGB_GET_STAT(adapter, bptch);\r\n*reg++ = IXGB_GET_STAT(adapter, mptcl);\r\n*reg++ = IXGB_GET_STAT(adapter, mptch);\r\n*reg++ = IXGB_GET_STAT(adapter, uptcl);\r\n*reg++ = IXGB_GET_STAT(adapter, uptch);\r\n*reg++ = IXGB_GET_STAT(adapter, vptcl);\r\n*reg++ = IXGB_GET_STAT(adapter, vptch);\r\n*reg++ = IXGB_GET_STAT(adapter, jptcl);\r\n*reg++ = IXGB_GET_STAT(adapter, jptch);\r\n*reg++ = IXGB_GET_STAT(adapter, gotcl);\r\n*reg++ = IXGB_GET_STAT(adapter, gotch);\r\n*reg++ = IXGB_GET_STAT(adapter, totl);\r\n*reg++ = IXGB_GET_STAT(adapter, toth);\r\n*reg++ = IXGB_GET_STAT(adapter, dc);\r\n*reg++ = IXGB_GET_STAT(adapter, plt64c);\r\n*reg++ = IXGB_GET_STAT(adapter, tsctc);\r\n*reg++ = IXGB_GET_STAT(adapter, tsctfc);\r\n*reg++ = IXGB_GET_STAT(adapter, ibic);\r\n*reg++ = IXGB_GET_STAT(adapter, rfc);\r\n*reg++ = IXGB_GET_STAT(adapter, lfc);\r\n*reg++ = IXGB_GET_STAT(adapter, pfrc);\r\n*reg++ = IXGB_GET_STAT(adapter, pftc);\r\n*reg++ = IXGB_GET_STAT(adapter, mcfrc);\r\n*reg++ = IXGB_GET_STAT(adapter, mcftc);\r\n*reg++ = IXGB_GET_STAT(adapter, xonrxc);\r\n*reg++ = IXGB_GET_STAT(adapter, xontxc);\r\n*reg++ = IXGB_GET_STAT(adapter, xoffrxc);\r\n*reg++ = IXGB_GET_STAT(adapter, xofftxc);\r\n*reg++ = IXGB_GET_STAT(adapter, rjc);\r\nregs->len = (reg - reg_start) * sizeof(u32);\r\n}\r\nstatic int\r\nixgb_get_eeprom_len(struct net_device *netdev)\r\n{\r\nreturn IXGB_EEPROM_SIZE << 1;\r\n}\r\nstatic int\r\nixgb_get_eeprom(struct net_device *netdev,\r\nstruct ethtool_eeprom *eeprom, u8 *bytes)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\nstruct ixgb_hw *hw = &adapter->hw;\r\n__le16 *eeprom_buff;\r\nint i, max_len, first_word, last_word;\r\nint ret_val = 0;\r\nif (eeprom->len == 0) {\r\nret_val = -EINVAL;\r\ngoto geeprom_error;\r\n}\r\neeprom->magic = hw->vendor_id | (hw->device_id << 16);\r\nmax_len = ixgb_get_eeprom_len(netdev);\r\nif (eeprom->offset > eeprom->offset + eeprom->len) {\r\nret_val = -EINVAL;\r\ngoto geeprom_error;\r\n}\r\nif ((eeprom->offset + eeprom->len) > max_len)\r\neeprom->len = (max_len - eeprom->offset);\r\nfirst_word = eeprom->offset >> 1;\r\nlast_word = (eeprom->offset + eeprom->len - 1) >> 1;\r\neeprom_buff = kmalloc(sizeof(__le16) *\r\n(last_word - first_word + 1), GFP_KERNEL);\r\nif (!eeprom_buff)\r\nreturn -ENOMEM;\r\nfor (i = 0; i <= (last_word - first_word); i++)\r\neeprom_buff[i] = ixgb_get_eeprom_word(hw, (first_word + i));\r\nmemcpy(bytes, (u8 *)eeprom_buff + (eeprom->offset & 1), eeprom->len);\r\nkfree(eeprom_buff);\r\ngeeprom_error:\r\nreturn ret_val;\r\n}\r\nstatic int\r\nixgb_set_eeprom(struct net_device *netdev,\r\nstruct ethtool_eeprom *eeprom, u8 *bytes)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\nstruct ixgb_hw *hw = &adapter->hw;\r\nu16 *eeprom_buff;\r\nvoid *ptr;\r\nint max_len, first_word, last_word;\r\nu16 i;\r\nif (eeprom->len == 0)\r\nreturn -EINVAL;\r\nif (eeprom->magic != (hw->vendor_id | (hw->device_id << 16)))\r\nreturn -EFAULT;\r\nmax_len = ixgb_get_eeprom_len(netdev);\r\nif (eeprom->offset > eeprom->offset + eeprom->len)\r\nreturn -EINVAL;\r\nif ((eeprom->offset + eeprom->len) > max_len)\r\neeprom->len = (max_len - eeprom->offset);\r\nfirst_word = eeprom->offset >> 1;\r\nlast_word = (eeprom->offset + eeprom->len - 1) >> 1;\r\neeprom_buff = kmalloc(max_len, GFP_KERNEL);\r\nif (!eeprom_buff)\r\nreturn -ENOMEM;\r\nptr = (void *)eeprom_buff;\r\nif (eeprom->offset & 1) {\r\neeprom_buff[0] = ixgb_read_eeprom(hw, first_word);\r\nptr++;\r\n}\r\nif ((eeprom->offset + eeprom->len) & 1) {\r\neeprom_buff[last_word - first_word]\r\n= ixgb_read_eeprom(hw, last_word);\r\n}\r\nmemcpy(ptr, bytes, eeprom->len);\r\nfor (i = 0; i <= (last_word - first_word); i++)\r\nixgb_write_eeprom(hw, first_word + i, eeprom_buff[i]);\r\nif (first_word <= EEPROM_CHECKSUM_REG)\r\nixgb_update_eeprom_checksum(hw);\r\nkfree(eeprom_buff);\r\nreturn 0;\r\n}\r\nstatic void\r\nixgb_get_drvinfo(struct net_device *netdev,\r\nstruct ethtool_drvinfo *drvinfo)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\nstrlcpy(drvinfo->driver, ixgb_driver_name,\r\nsizeof(drvinfo->driver));\r\nstrlcpy(drvinfo->version, ixgb_driver_version,\r\nsizeof(drvinfo->version));\r\nstrlcpy(drvinfo->bus_info, pci_name(adapter->pdev),\r\nsizeof(drvinfo->bus_info));\r\ndrvinfo->n_stats = IXGB_STATS_LEN;\r\ndrvinfo->regdump_len = ixgb_get_regs_len(netdev);\r\ndrvinfo->eedump_len = ixgb_get_eeprom_len(netdev);\r\n}\r\nstatic void\r\nixgb_get_ringparam(struct net_device *netdev,\r\nstruct ethtool_ringparam *ring)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\nstruct ixgb_desc_ring *txdr = &adapter->tx_ring;\r\nstruct ixgb_desc_ring *rxdr = &adapter->rx_ring;\r\nring->rx_max_pending = MAX_RXD;\r\nring->tx_max_pending = MAX_TXD;\r\nring->rx_pending = rxdr->count;\r\nring->tx_pending = txdr->count;\r\n}\r\nstatic int\r\nixgb_set_ringparam(struct net_device *netdev,\r\nstruct ethtool_ringparam *ring)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\nstruct ixgb_desc_ring *txdr = &adapter->tx_ring;\r\nstruct ixgb_desc_ring *rxdr = &adapter->rx_ring;\r\nstruct ixgb_desc_ring tx_old, tx_new, rx_old, rx_new;\r\nint err;\r\ntx_old = adapter->tx_ring;\r\nrx_old = adapter->rx_ring;\r\nif ((ring->rx_mini_pending) || (ring->rx_jumbo_pending))\r\nreturn -EINVAL;\r\nif (netif_running(adapter->netdev))\r\nixgb_down(adapter, true);\r\nrxdr->count = max(ring->rx_pending,(u32)MIN_RXD);\r\nrxdr->count = min(rxdr->count,(u32)MAX_RXD);\r\nrxdr->count = ALIGN(rxdr->count, IXGB_REQ_RX_DESCRIPTOR_MULTIPLE);\r\ntxdr->count = max(ring->tx_pending,(u32)MIN_TXD);\r\ntxdr->count = min(txdr->count,(u32)MAX_TXD);\r\ntxdr->count = ALIGN(txdr->count, IXGB_REQ_TX_DESCRIPTOR_MULTIPLE);\r\nif (netif_running(adapter->netdev)) {\r\nif ((err = ixgb_setup_rx_resources(adapter)))\r\ngoto err_setup_rx;\r\nif ((err = ixgb_setup_tx_resources(adapter)))\r\ngoto err_setup_tx;\r\nrx_new = adapter->rx_ring;\r\ntx_new = adapter->tx_ring;\r\nadapter->rx_ring = rx_old;\r\nadapter->tx_ring = tx_old;\r\nixgb_free_rx_resources(adapter);\r\nixgb_free_tx_resources(adapter);\r\nadapter->rx_ring = rx_new;\r\nadapter->tx_ring = tx_new;\r\nif ((err = ixgb_up(adapter)))\r\nreturn err;\r\nixgb_set_speed_duplex(netdev);\r\n}\r\nreturn 0;\r\nerr_setup_tx:\r\nixgb_free_rx_resources(adapter);\r\nerr_setup_rx:\r\nadapter->rx_ring = rx_old;\r\nadapter->tx_ring = tx_old;\r\nixgb_up(adapter);\r\nreturn err;\r\n}\r\nstatic int\r\nixgb_set_phys_id(struct net_device *netdev, enum ethtool_phys_id_state state)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\nswitch (state) {\r\ncase ETHTOOL_ID_ACTIVE:\r\nreturn 2;\r\ncase ETHTOOL_ID_ON:\r\nixgb_led_on(&adapter->hw);\r\nbreak;\r\ncase ETHTOOL_ID_OFF:\r\ncase ETHTOOL_ID_INACTIVE:\r\nixgb_led_off(&adapter->hw);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nixgb_get_sset_count(struct net_device *netdev, int sset)\r\n{\r\nswitch (sset) {\r\ncase ETH_SS_STATS:\r\nreturn IXGB_STATS_LEN;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\n}\r\nstatic void\r\nixgb_get_ethtool_stats(struct net_device *netdev,\r\nstruct ethtool_stats *stats, u64 *data)\r\n{\r\nstruct ixgb_adapter *adapter = netdev_priv(netdev);\r\nint i;\r\nchar *p = NULL;\r\nixgb_update_stats(adapter);\r\nfor (i = 0; i < IXGB_STATS_LEN; i++) {\r\nswitch (ixgb_gstrings_stats[i].type) {\r\ncase NETDEV_STATS:\r\np = (char *) netdev +\r\nixgb_gstrings_stats[i].stat_offset;\r\nbreak;\r\ncase IXGB_STATS:\r\np = (char *) adapter +\r\nixgb_gstrings_stats[i].stat_offset;\r\nbreak;\r\n}\r\ndata[i] = (ixgb_gstrings_stats[i].sizeof_stat ==\r\nsizeof(u64)) ? *(u64 *)p : *(u32 *)p;\r\n}\r\n}\r\nstatic void\r\nixgb_get_strings(struct net_device *netdev, u32 stringset, u8 *data)\r\n{\r\nint i;\r\nswitch(stringset) {\r\ncase ETH_SS_STATS:\r\nfor (i = 0; i < IXGB_STATS_LEN; i++) {\r\nmemcpy(data + i * ETH_GSTRING_LEN,\r\nixgb_gstrings_stats[i].stat_string,\r\nETH_GSTRING_LEN);\r\n}\r\nbreak;\r\n}\r\n}\r\nvoid ixgb_set_ethtool_ops(struct net_device *netdev)\r\n{\r\nnetdev->ethtool_ops = &ixgb_ethtool_ops;\r\n}

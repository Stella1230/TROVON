static int __sync_filesystem(struct super_block *sb, int wait)\r\n{\r\nif (wait)\r\nsync_inodes_sb(sb);\r\nelse\r\nwriteback_inodes_sb(sb, WB_REASON_SYNC);\r\nif (sb->s_op->sync_fs)\r\nsb->s_op->sync_fs(sb, wait);\r\nreturn __sync_blockdev(sb->s_bdev, wait);\r\n}\r\nint sync_filesystem(struct super_block *sb)\r\n{\r\nint ret;\r\nWARN_ON(!rwsem_is_locked(&sb->s_umount));\r\nif (sb->s_flags & MS_RDONLY)\r\nreturn 0;\r\nret = __sync_filesystem(sb, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn __sync_filesystem(sb, 1);\r\n}\r\nstatic void sync_inodes_one_sb(struct super_block *sb, void *arg)\r\n{\r\nif (!(sb->s_flags & MS_RDONLY))\r\nsync_inodes_sb(sb);\r\n}\r\nstatic void sync_fs_one_sb(struct super_block *sb, void *arg)\r\n{\r\nif (!(sb->s_flags & MS_RDONLY) && sb->s_op->sync_fs)\r\nsb->s_op->sync_fs(sb, *(int *)arg);\r\n}\r\nstatic void fdatawrite_one_bdev(struct block_device *bdev, void *arg)\r\n{\r\nfilemap_fdatawrite(bdev->bd_inode->i_mapping);\r\n}\r\nstatic void fdatawait_one_bdev(struct block_device *bdev, void *arg)\r\n{\r\nfilemap_fdatawait(bdev->bd_inode->i_mapping);\r\n}\r\nstatic void do_sync_work(struct work_struct *work)\r\n{\r\nint nowait = 0;\r\niterate_supers(sync_inodes_one_sb, &nowait);\r\niterate_supers(sync_fs_one_sb, &nowait);\r\niterate_bdevs(fdatawrite_one_bdev, NULL);\r\niterate_supers(sync_inodes_one_sb, &nowait);\r\niterate_supers(sync_fs_one_sb, &nowait);\r\niterate_bdevs(fdatawrite_one_bdev, NULL);\r\nprintk("Emergency Sync complete\n");\r\nkfree(work);\r\n}\r\nvoid emergency_sync(void)\r\n{\r\nstruct work_struct *work;\r\nwork = kmalloc(sizeof(*work), GFP_ATOMIC);\r\nif (work) {\r\nINIT_WORK(work, do_sync_work);\r\nschedule_work(work);\r\n}\r\n}\r\nint vfs_fsync_range(struct file *file, loff_t start, loff_t end, int datasync)\r\n{\r\nif (!file->f_op->fsync)\r\nreturn -EINVAL;\r\nreturn file->f_op->fsync(file, start, end, datasync);\r\n}\r\nint vfs_fsync(struct file *file, int datasync)\r\n{\r\nreturn vfs_fsync_range(file, 0, LLONG_MAX, datasync);\r\n}\r\nstatic int do_fsync(unsigned int fd, int datasync)\r\n{\r\nstruct fd f = fdget(fd);\r\nint ret = -EBADF;\r\nif (f.file) {\r\nret = vfs_fsync(f.file, datasync);\r\nfdput(f);\r\n}\r\nreturn ret;\r\n}

static int smc91c96_gpmc_retime(void)\r\n{\r\nstruct gpmc_timings t;\r\nstruct gpmc_device_timings dev_t;\r\nconst int t3 = 10;\r\nconst int t4_r = 20;\r\nconst int t4_w = 5;\r\nconst int t5 = 25;\r\nconst int t6 = 15;\r\nconst int t7 = 5;\r\nconst int t8 = 5;\r\nconst int t20 = 185;\r\nif (gpmc_cfg->flags & GPMC_MUX_ADD_DATA)\r\nreturn 0;\r\nmemset(&dev_t, 0, sizeof(dev_t));\r\ndev_t.t_oeasu = t3 * 1000;\r\ndev_t.t_oe = t5 * 1000;\r\ndev_t.t_cez_r = t4_r * 1000;\r\ndev_t.t_oez = t6 * 1000;\r\ndev_t.t_rd_cycle = (t20 - t3) * 1000;\r\ndev_t.t_weasu = t3 * 1000;\r\ndev_t.t_wpl = t7 * 1000;\r\ndev_t.t_wph = t8 * 1000;\r\ndev_t.t_cez_w = t4_w * 1000;\r\ndev_t.t_wr_cycle = (t20 - t3) * 1000;\r\ngpmc_calc_timings(&t, &smc91x_settings, &dev_t);\r\nreturn gpmc_cs_set_timings(gpmc_cfg->cs, &t);\r\n}\r\nvoid __init gpmc_smc91x_init(struct omap_smc91x_platform_data *board_data)\r\n{\r\nunsigned long cs_mem_base;\r\nint ret;\r\ngpmc_cfg = board_data;\r\nif (gpmc_cfg->flags & GPMC_TIMINGS_SMC91C96)\r\ngpmc_cfg->retime = smc91c96_gpmc_retime;\r\nif (gpmc_cs_request(gpmc_cfg->cs, SZ_16M, &cs_mem_base) < 0) {\r\nprintk(KERN_ERR "Failed to request GPMC mem for smc91x\n");\r\nreturn;\r\n}\r\ngpmc_smc91x_resources[0].start = cs_mem_base + 0x300;\r\ngpmc_smc91x_resources[0].end = cs_mem_base + 0x30f;\r\ngpmc_smc91x_resources[1].flags |= (gpmc_cfg->flags & IRQF_TRIGGER_MASK);\r\nif (gpmc_cfg->flags & GPMC_MUX_ADD_DATA)\r\nsmc91x_settings.mux_add_data = GPMC_MUX_AD;\r\nif (gpmc_cfg->flags & GPMC_READ_MON)\r\nsmc91x_settings.wait_on_read = true;\r\nif (gpmc_cfg->flags & GPMC_WRITE_MON)\r\nsmc91x_settings.wait_on_write = true;\r\nif (gpmc_cfg->wait_pin)\r\nsmc91x_settings.wait_pin = gpmc_cfg->wait_pin;\r\nret = gpmc_cs_program_settings(gpmc_cfg->cs, &smc91x_settings);\r\nif (ret < 0)\r\ngoto free1;\r\nif (gpmc_cfg->retime) {\r\nret = gpmc_cfg->retime();\r\nif (ret != 0)\r\ngoto free1;\r\n}\r\nif (gpio_request_one(gpmc_cfg->gpio_irq, GPIOF_IN, "SMC91X irq") < 0)\r\ngoto free1;\r\ngpmc_smc91x_resources[1].start = gpio_to_irq(gpmc_cfg->gpio_irq);\r\nif (gpmc_cfg->gpio_pwrdwn) {\r\nret = gpio_request_one(gpmc_cfg->gpio_pwrdwn,\r\nGPIOF_OUT_INIT_LOW, "SMC91X powerdown");\r\nif (ret)\r\ngoto free2;\r\n}\r\nif (gpmc_cfg->gpio_reset) {\r\nret = gpio_request_one(gpmc_cfg->gpio_reset,\r\nGPIOF_OUT_INIT_LOW, "SMC91X reset");\r\nif (ret)\r\ngoto free3;\r\ngpio_set_value(gpmc_cfg->gpio_reset, 1);\r\nmsleep(100);\r\ngpio_set_value(gpmc_cfg->gpio_reset, 0);\r\n}\r\nif (platform_device_register(&gpmc_smc91x_device) < 0) {\r\nprintk(KERN_ERR "Unable to register smc91x device\n");\r\ngpio_free(gpmc_cfg->gpio_reset);\r\ngoto free3;\r\n}\r\nreturn;\r\nfree3:\r\nif (gpmc_cfg->gpio_pwrdwn)\r\ngpio_free(gpmc_cfg->gpio_pwrdwn);\r\nfree2:\r\ngpio_free(gpmc_cfg->gpio_irq);\r\nfree1:\r\ngpmc_cs_free(gpmc_cfg->cs);\r\nprintk(KERN_ERR "Could not initialize smc91x\n");\r\n}

static void cbe_power_save(void)\r\n{\r\nunsigned long ctrl, thread_switch_control;\r\nif (!prep_irq_for_idle())\r\nreturn;\r\nctrl = mfspr(SPRN_CTRLF);\r\nthread_switch_control = mfspr(SPRN_TSC_CELL);\r\nthread_switch_control |= TSC_CELL_EE_ENABLE | TSC_CELL_EE_BOOST;\r\nswitch (ctrl & CTRL_CT) {\r\ncase CTRL_CT0:\r\nthread_switch_control |= TSC_CELL_DEC_ENABLE_0;\r\nbreak;\r\ncase CTRL_CT1:\r\nthread_switch_control |= TSC_CELL_DEC_ENABLE_1;\r\nbreak;\r\ndefault:\r\nprintk(KERN_WARNING "%s: unknown configuration\n",\r\n__func__);\r\nbreak;\r\n}\r\nmtspr(SPRN_TSC_CELL, thread_switch_control);\r\nHMT_low();\r\nctrl &= ~(CTRL_RUNLATCH | CTRL_TE);\r\nmtspr(SPRN_CTRLT, ctrl);\r\n__hard_irq_enable();\r\n}\r\nstatic int cbe_system_reset_exception(struct pt_regs *regs)\r\n{\r\nswitch (regs->msr & SRR1_WAKEMASK) {\r\ncase SRR1_WAKEEE:\r\ndo_IRQ(regs);\r\nbreak;\r\ncase SRR1_WAKEDEC:\r\ntimer_interrupt(regs);\r\nbreak;\r\ncase SRR1_WAKEMT:\r\nreturn cbe_sysreset_hack();\r\n#ifdef CONFIG_CBE_RAS\r\ncase SRR1_WAKESYSERR:\r\ncbe_system_error_exception(regs);\r\nbreak;\r\ncase SRR1_WAKETHERM:\r\ncbe_thermal_exception(regs);\r\nbreak;\r\n#endif\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nvoid __init cbe_pervasive_init(void)\r\n{\r\nint cpu;\r\nif (!cpu_has_feature(CPU_FTR_PAUSE_ZERO))\r\nreturn;\r\nfor_each_possible_cpu(cpu) {\r\nstruct cbe_pmd_regs __iomem *regs = cbe_get_cpu_pmd_regs(cpu);\r\nif (!regs)\r\ncontinue;\r\nout_be64(&regs->pmcr, in_be64(&regs->pmcr) |\r\nCBE_PMD_PAUSE_ZERO_CONTROL);\r\n}\r\nppc_md.power_save = cbe_power_save;\r\nppc_md.system_reset_exception = cbe_system_reset_exception;\r\n}

static struct mdp5_kms *get_kms(struct drm_plane *plane)\r\n{\r\nstruct msm_drm_private *priv = plane->dev->dev_private;\r\nreturn to_mdp5_kms(to_mdp_kms(priv->kms));\r\n}\r\nstatic int mdp5_plane_update(struct drm_plane *plane,\r\nstruct drm_crtc *crtc, struct drm_framebuffer *fb,\r\nint crtc_x, int crtc_y,\r\nunsigned int crtc_w, unsigned int crtc_h,\r\nuint32_t src_x, uint32_t src_y,\r\nuint32_t src_w, uint32_t src_h)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nmdp5_plane->enabled = true;\r\nif (plane->fb)\r\ndrm_framebuffer_unreference(plane->fb);\r\ndrm_framebuffer_reference(fb);\r\nreturn mdp5_plane_mode_set(plane, crtc, fb,\r\ncrtc_x, crtc_y, crtc_w, crtc_h,\r\nsrc_x, src_y, src_w, src_h);\r\n}\r\nstatic int mdp5_plane_disable(struct drm_plane *plane)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nstruct mdp5_kms *mdp5_kms = get_kms(plane);\r\nenum mdp5_pipe pipe = mdp5_plane->pipe;\r\nint i;\r\nDBG("%s: disable", mdp5_plane->name);\r\nfor (i = 0; i < pipe2nclients(pipe); i++)\r\nmdp5_smp_request(mdp5_kms, pipe2client(pipe, i), 0);\r\nif (plane->crtc)\r\nmdp5_crtc_detach(plane->crtc, plane);\r\nreturn 0;\r\n}\r\nstatic void mdp5_plane_destroy(struct drm_plane *plane)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nstruct msm_drm_private *priv = plane->dev->dev_private;\r\nif (priv->kms)\r\nmdp5_plane_disable(plane);\r\ndrm_plane_cleanup(plane);\r\nkfree(mdp5_plane);\r\n}\r\nvoid mdp5_plane_install_properties(struct drm_plane *plane,\r\nstruct drm_mode_object *obj)\r\n{\r\n}\r\nint mdp5_plane_set_property(struct drm_plane *plane,\r\nstruct drm_property *property, uint64_t val)\r\n{\r\nreturn -EINVAL;\r\n}\r\nvoid mdp5_plane_set_scanout(struct drm_plane *plane,\r\nstruct drm_framebuffer *fb)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nstruct mdp5_kms *mdp5_kms = get_kms(plane);\r\nenum mdp5_pipe pipe = mdp5_plane->pipe;\r\nuint32_t nplanes = drm_format_num_planes(fb->pixel_format);\r\nuint32_t iova[4];\r\nint i;\r\nfor (i = 0; i < nplanes; i++) {\r\nstruct drm_gem_object *bo = msm_framebuffer_bo(fb, i);\r\nmsm_gem_get_iova(bo, mdp5_kms->id, &iova[i]);\r\n}\r\nfor (; i < 4; i++)\r\niova[i] = 0;\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_STRIDE_A(pipe),\r\nMDP5_PIPE_SRC_STRIDE_A_P0(fb->pitches[0]) |\r\nMDP5_PIPE_SRC_STRIDE_A_P1(fb->pitches[1]));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_STRIDE_B(pipe),\r\nMDP5_PIPE_SRC_STRIDE_B_P2(fb->pitches[2]) |\r\nMDP5_PIPE_SRC_STRIDE_B_P3(fb->pitches[3]));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC0_ADDR(pipe), iova[0]);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC1_ADDR(pipe), iova[1]);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC2_ADDR(pipe), iova[2]);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC3_ADDR(pipe), iova[3]);\r\nplane->fb = fb;\r\n}\r\nstatic int request_smp_blocks(struct drm_plane *plane, uint32_t format,\r\nuint32_t nplanes, uint32_t width)\r\n{\r\nstruct drm_device *dev = plane->dev;\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nstruct mdp5_kms *mdp5_kms = get_kms(plane);\r\nenum mdp5_pipe pipe = mdp5_plane->pipe;\r\nint i, hsub, nlines, nblks, ret;\r\nhsub = drm_format_horz_chroma_subsampling(format);\r\nnlines = 2;\r\nfor (i = 0, nblks = 0; i < nplanes; i++) {\r\nint n, fetch_stride, cpp;\r\ncpp = drm_format_plane_cpp(format, i);\r\nfetch_stride = width * cpp / (i ? hsub : 1);\r\nn = DIV_ROUND_UP(fetch_stride * nlines, SMP_BLK_SIZE);\r\nif (mdp5_kms->rev == 0)\r\nn = roundup_pow_of_two(n);\r\nDBG("%s[%d]: request %d SMP blocks", mdp5_plane->name, i, n);\r\nret = mdp5_smp_request(mdp5_kms, pipe2client(pipe, i), n);\r\nif (ret) {\r\ndev_err(dev->dev, "Could not allocate %d SMP blocks: %d\n",\r\nn, ret);\r\nreturn ret;\r\n}\r\nnblks += n;\r\n}\r\nreturn nblks;\r\n}\r\nstatic void set_fifo_thresholds(struct drm_plane *plane, int nblks)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nstruct mdp5_kms *mdp5_kms = get_kms(plane);\r\nenum mdp5_pipe pipe = mdp5_plane->pipe;\r\nuint32_t val;\r\nval = (nblks * SMP_ENTRIES_PER_BLK) / 4;\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_REQPRIO_FIFO_WM_0(pipe), val * 1);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_REQPRIO_FIFO_WM_1(pipe), val * 2);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_REQPRIO_FIFO_WM_2(pipe), val * 3);\r\n}\r\nint mdp5_plane_mode_set(struct drm_plane *plane,\r\nstruct drm_crtc *crtc, struct drm_framebuffer *fb,\r\nint crtc_x, int crtc_y,\r\nunsigned int crtc_w, unsigned int crtc_h,\r\nuint32_t src_x, uint32_t src_y,\r\nuint32_t src_w, uint32_t src_h)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nstruct mdp5_kms *mdp5_kms = get_kms(plane);\r\nenum mdp5_pipe pipe = mdp5_plane->pipe;\r\nconst struct mdp_format *format;\r\nuint32_t nplanes, config = 0;\r\nuint32_t phasex_step = 0, phasey_step = 0;\r\nuint32_t hdecm = 0, vdecm = 0;\r\nint i, nblks;\r\nnplanes = drm_format_num_planes(fb->pixel_format);\r\nif (WARN_ON(nplanes > pipe2nclients(pipe)))\r\nreturn -EINVAL;\r\nsrc_x = src_x >> 16;\r\nsrc_y = src_y >> 16;\r\nsrc_w = src_w >> 16;\r\nsrc_h = src_h >> 16;\r\nDBG("%s: FB[%u] %u,%u,%u,%u -> CRTC[%u] %d,%d,%u,%u", mdp5_plane->name,\r\nfb->base.id, src_x, src_y, src_w, src_h,\r\ncrtc->base.id, crtc_x, crtc_y, crtc_w, crtc_h);\r\nnblks = request_smp_blocks(plane, fb->pixel_format, nplanes, src_w);\r\nif (nblks < 0)\r\nreturn nblks;\r\nfor (i = 0; i < pipe2nclients(pipe); i++)\r\nmdp5_smp_configure(mdp5_kms, pipe2client(pipe, i));\r\nif (src_w != crtc_w) {\r\nconfig |= MDP5_PIPE_SCALE_CONFIG_SCALEX_EN;\r\n}\r\nif (src_h != crtc_h) {\r\nconfig |= MDP5_PIPE_SCALE_CONFIG_SCALEY_EN;\r\n}\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_IMG_SIZE(pipe),\r\nMDP5_PIPE_SRC_IMG_SIZE_WIDTH(src_w) |\r\nMDP5_PIPE_SRC_IMG_SIZE_HEIGHT(src_h));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_SIZE(pipe),\r\nMDP5_PIPE_SRC_SIZE_WIDTH(src_w) |\r\nMDP5_PIPE_SRC_SIZE_HEIGHT(src_h));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_XY(pipe),\r\nMDP5_PIPE_SRC_XY_X(src_x) |\r\nMDP5_PIPE_SRC_XY_Y(src_y));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_OUT_SIZE(pipe),\r\nMDP5_PIPE_OUT_SIZE_WIDTH(crtc_w) |\r\nMDP5_PIPE_OUT_SIZE_HEIGHT(crtc_h));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_OUT_XY(pipe),\r\nMDP5_PIPE_OUT_XY_X(crtc_x) |\r\nMDP5_PIPE_OUT_XY_Y(crtc_y));\r\nmdp5_plane_set_scanout(plane, fb);\r\nformat = to_mdp_format(msm_framebuffer_format(fb));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_FORMAT(pipe),\r\nMDP5_PIPE_SRC_FORMAT_A_BPC(format->bpc_a) |\r\nMDP5_PIPE_SRC_FORMAT_R_BPC(format->bpc_r) |\r\nMDP5_PIPE_SRC_FORMAT_G_BPC(format->bpc_g) |\r\nMDP5_PIPE_SRC_FORMAT_B_BPC(format->bpc_b) |\r\nCOND(format->alpha_enable, MDP5_PIPE_SRC_FORMAT_ALPHA_ENABLE) |\r\nMDP5_PIPE_SRC_FORMAT_CPP(format->cpp - 1) |\r\nMDP5_PIPE_SRC_FORMAT_UNPACK_COUNT(format->unpack_count - 1) |\r\nCOND(format->unpack_tight, MDP5_PIPE_SRC_FORMAT_UNPACK_TIGHT) |\r\nMDP5_PIPE_SRC_FORMAT_NUM_PLANES(nplanes - 1) |\r\nMDP5_PIPE_SRC_FORMAT_CHROMA_SAMP(CHROMA_RGB));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_UNPACK(pipe),\r\nMDP5_PIPE_SRC_UNPACK_ELEM0(format->unpack[0]) |\r\nMDP5_PIPE_SRC_UNPACK_ELEM1(format->unpack[1]) |\r\nMDP5_PIPE_SRC_UNPACK_ELEM2(format->unpack[2]) |\r\nMDP5_PIPE_SRC_UNPACK_ELEM3(format->unpack[3]));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_OP_MODE(pipe),\r\nMDP5_PIPE_SRC_OP_MODE_BWC(BWC_LOSSLESS));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SRC_ADDR_SW_STATUS(pipe), 0);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SCALE_PHASE_STEP_X(pipe), phasex_step);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SCALE_PHASE_STEP_Y(pipe), phasey_step);\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_DECIMATION(pipe),\r\nMDP5_PIPE_DECIMATION_VERT(vdecm) |\r\nMDP5_PIPE_DECIMATION_HORZ(hdecm));\r\nmdp5_write(mdp5_kms, REG_MDP5_PIPE_SCALE_CONFIG(pipe),\r\nMDP5_PIPE_SCALE_CONFIG_SCALEX_MIN_FILTER(SCALE_FILTER_NEAREST) |\r\nMDP5_PIPE_SCALE_CONFIG_SCALEY_MIN_FILTER(SCALE_FILTER_NEAREST) |\r\nMDP5_PIPE_SCALE_CONFIG_SCALEX_CR_FILTER(SCALE_FILTER_NEAREST) |\r\nMDP5_PIPE_SCALE_CONFIG_SCALEY_CR_FILTER(SCALE_FILTER_NEAREST) |\r\nMDP5_PIPE_SCALE_CONFIG_SCALEX_MAX_FILTER(SCALE_FILTER_NEAREST) |\r\nMDP5_PIPE_SCALE_CONFIG_SCALEY_MAX_FILTER(SCALE_FILTER_NEAREST));\r\nset_fifo_thresholds(plane, nblks);\r\nmdp5_crtc_attach(crtc, plane);\r\nreturn 0;\r\n}\r\nvoid mdp5_plane_complete_flip(struct drm_plane *plane)\r\n{\r\nstruct mdp5_kms *mdp5_kms = get_kms(plane);\r\nenum mdp5_pipe pipe = to_mdp5_plane(plane)->pipe;\r\nint i;\r\nfor (i = 0; i < pipe2nclients(pipe); i++)\r\nmdp5_smp_commit(mdp5_kms, pipe2client(pipe, i));\r\n}\r\nenum mdp5_pipe mdp5_plane_pipe(struct drm_plane *plane)\r\n{\r\nstruct mdp5_plane *mdp5_plane = to_mdp5_plane(plane);\r\nreturn mdp5_plane->pipe;\r\n}\r\nstruct drm_plane *mdp5_plane_init(struct drm_device *dev,\r\nenum mdp5_pipe pipe, bool private_plane)\r\n{\r\nstruct drm_plane *plane = NULL;\r\nstruct mdp5_plane *mdp5_plane;\r\nint ret;\r\nenum drm_plane_type type;\r\nmdp5_plane = kzalloc(sizeof(*mdp5_plane), GFP_KERNEL);\r\nif (!mdp5_plane) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\nplane = &mdp5_plane->base;\r\nmdp5_plane->pipe = pipe;\r\nmdp5_plane->name = pipe2name(pipe);\r\nmdp5_plane->nformats = mdp5_get_formats(pipe, mdp5_plane->formats,\r\nARRAY_SIZE(mdp5_plane->formats));\r\ntype = private_plane ? DRM_PLANE_TYPE_PRIMARY : DRM_PLANE_TYPE_OVERLAY;\r\ndrm_universal_plane_init(dev, plane, 0xff, &mdp5_plane_funcs,\r\nmdp5_plane->formats, mdp5_plane->nformats,\r\ntype);\r\nmdp5_plane_install_properties(plane, &plane->base);\r\nreturn plane;\r\nfail:\r\nif (plane)\r\nmdp5_plane_destroy(plane);\r\nreturn ERR_PTR(ret);\r\n}

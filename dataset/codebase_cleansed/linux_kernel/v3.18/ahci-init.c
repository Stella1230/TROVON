static void sata_clear_glue_reg(uint64_t regbase, uint32_t off, uint32_t bit)\r\n{\r\nuint32_t reg_val;\r\nreg_val = nlm_read_sata_reg(regbase, off);\r\nnlm_write_sata_reg(regbase, off, (reg_val & ~bit));\r\n}\r\nstatic void sata_set_glue_reg(uint64_t regbase, uint32_t off, uint32_t bit)\r\n{\r\nuint32_t reg_val;\r\nreg_val = nlm_read_sata_reg(regbase, off);\r\nnlm_write_sata_reg(regbase, off, (reg_val | bit));\r\n}\r\nstatic void nlm_sata_firmware_init(int node)\r\n{\r\nuint32_t reg_val;\r\nuint64_t regbase;\r\nint i;\r\npr_info("XLP AHCI Initialization started.\n");\r\nregbase = nlm_get_sata_regbase(node);\r\nsata_clear_glue_reg(regbase, SATA_CTL, SATA_RST_N);\r\nsata_clear_glue_reg(regbase, SATA_CTL,\r\n(PHY3_RESET_N | PHY2_RESET_N\r\n| PHY1_RESET_N | PHY0_RESET_N));\r\nsata_set_glue_reg(regbase, SATA_CTL, SATA_RST_N);\r\nsata_set_glue_reg(regbase, SATA_CTL,\r\n(PHY3_RESET_N | PHY2_RESET_N\r\n| PHY1_RESET_N | PHY0_RESET_N));\r\npr_debug("Waiting for PHYs to come up.\n");\r\ni = 0;\r\ndo {\r\nreg_val = nlm_read_sata_reg(regbase, SATA_STATUS);\r\ni++;\r\n} while (((reg_val & 0xF0) != 0xF0) && (i < 10000));\r\nfor (i = 0; i < 4; i++) {\r\nif (reg_val & (P0_PHY_READY << i))\r\npr_info("PHY%d is up.\n", i);\r\nelse\r\npr_info("PHY%d is down.\n", i);\r\n}\r\npr_info("XLP AHCI init done.\n");\r\n}\r\nstatic int __init nlm_ahci_init(void)\r\n{\r\nint node = 0;\r\nint chip = read_c0_prid() & PRID_REV_MASK;\r\nif (chip == PRID_IMP_NETLOGIC_XLP3XX)\r\nnlm_sata_firmware_init(node);\r\nreturn 0;\r\n}\r\nstatic void nlm_sata_intr_ack(struct irq_data *data)\r\n{\r\nuint32_t val = 0;\r\nuint64_t regbase;\r\nregbase = nlm_get_sata_regbase(nlm_nodeid());\r\nval = nlm_read_sata_reg(regbase, SATA_INT);\r\nsata_set_glue_reg(regbase, SATA_INT, val);\r\n}\r\nstatic void nlm_sata_fixup_bar(struct pci_dev *dev)\r\n{\r\ndev->resource[5] = dev->resource[0];\r\nmemset(&dev->resource[0], 0, sizeof(dev->resource[0]));\r\n}\r\nstatic void nlm_sata_fixup_final(struct pci_dev *dev)\r\n{\r\nuint32_t val;\r\nuint64_t regbase;\r\nint node = 0;\r\nregbase = nlm_get_sata_regbase(node);\r\nval = nlm_read_sata_reg(regbase, SATA_INT);\r\nsata_set_glue_reg(regbase, SATA_INT, val);\r\nsata_set_glue_reg(regbase, SATA_INT_MASK, 0x1);\r\ndev->irq = PIC_SATA_IRQ;\r\nnlm_set_pic_extra_ack(node, PIC_SATA_IRQ, nlm_sata_intr_ack);\r\n}

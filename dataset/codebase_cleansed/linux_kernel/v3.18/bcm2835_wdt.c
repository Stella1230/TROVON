static int bcm2835_wdt_start(struct watchdog_device *wdog)\r\n{\r\nstruct bcm2835_wdt *wdt = watchdog_get_drvdata(wdog);\r\nuint32_t cur;\r\nunsigned long flags;\r\nspin_lock_irqsave(&wdt->lock, flags);\r\nwritel_relaxed(PM_PASSWORD | (SECS_TO_WDOG_TICKS(wdog->timeout) &\r\nPM_WDOG_TIME_SET), wdt->base + PM_WDOG);\r\ncur = readl_relaxed(wdt->base + PM_RSTC);\r\nwritel_relaxed(PM_PASSWORD | (cur & PM_RSTC_WRCFG_CLR) |\r\nPM_RSTC_WRCFG_FULL_RESET, wdt->base + PM_RSTC);\r\nspin_unlock_irqrestore(&wdt->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int bcm2835_wdt_stop(struct watchdog_device *wdog)\r\n{\r\nstruct bcm2835_wdt *wdt = watchdog_get_drvdata(wdog);\r\nwritel_relaxed(PM_PASSWORD | PM_RSTC_RESET, wdt->base + PM_RSTC);\r\ndev_info(wdog->dev, "Watchdog timer stopped");\r\nreturn 0;\r\n}\r\nstatic int bcm2835_wdt_set_timeout(struct watchdog_device *wdog, unsigned int t)\r\n{\r\nwdog->timeout = t;\r\nreturn 0;\r\n}\r\nstatic unsigned int bcm2835_wdt_get_timeleft(struct watchdog_device *wdog)\r\n{\r\nstruct bcm2835_wdt *wdt = watchdog_get_drvdata(wdog);\r\nuint32_t ret = readl_relaxed(wdt->base + PM_WDOG);\r\nreturn WDOG_TICKS_TO_SECS(ret & PM_WDOG_TIME_SET);\r\n}\r\nstatic int bcm2835_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct bcm2835_wdt *wdt;\r\nint err;\r\nwdt = devm_kzalloc(dev, sizeof(struct bcm2835_wdt), GFP_KERNEL);\r\nif (!wdt)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, wdt);\r\nspin_lock_init(&wdt->lock);\r\nwdt->base = of_iomap(np, 0);\r\nif (!wdt->base) {\r\ndev_err(dev, "Failed to remap watchdog regs");\r\nreturn -ENODEV;\r\n}\r\nwatchdog_set_drvdata(&bcm2835_wdt_wdd, wdt);\r\nwatchdog_init_timeout(&bcm2835_wdt_wdd, heartbeat, dev);\r\nwatchdog_set_nowayout(&bcm2835_wdt_wdd, nowayout);\r\nerr = watchdog_register_device(&bcm2835_wdt_wdd);\r\nif (err) {\r\ndev_err(dev, "Failed to register watchdog device");\r\niounmap(wdt->base);\r\nreturn err;\r\n}\r\ndev_info(dev, "Broadcom BCM2835 watchdog timer");\r\nreturn 0;\r\n}\r\nstatic int bcm2835_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct bcm2835_wdt *wdt = platform_get_drvdata(pdev);\r\nwatchdog_unregister_device(&bcm2835_wdt_wdd);\r\niounmap(wdt->base);\r\nreturn 0;\r\n}\r\nstatic void bcm2835_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nbcm2835_wdt_stop(&bcm2835_wdt_wdd);\r\n}

int mdp5_smp_request(struct mdp5_kms *mdp5_kms,\r\nenum mdp5_client_id cid, int nblks)\r\n{\r\nstruct mdp5_client_smp_state *ps = &mdp5_kms->smp_client_state[cid];\r\nint i, ret, avail, cur_nblks, cnt = mdp5_kms->smp_blk_cnt;\r\nunsigned long flags;\r\nspin_lock_irqsave(&smp_lock, flags);\r\navail = cnt - bitmap_weight(mdp5_kms->smp_state, cnt);\r\nif (nblks > avail) {\r\nret = -ENOSPC;\r\ngoto fail;\r\n}\r\ncur_nblks = bitmap_weight(ps->pending, cnt);\r\nif (nblks > cur_nblks) {\r\nfor (i = cur_nblks; i < nblks; i++) {\r\nint blk = find_first_zero_bit(mdp5_kms->smp_state, cnt);\r\nset_bit(blk, ps->pending);\r\nset_bit(blk, mdp5_kms->smp_state);\r\n}\r\n} else {\r\nfor (i = cur_nblks; i > nblks; i--) {\r\nint blk = find_first_bit(ps->pending, cnt);\r\nclear_bit(blk, ps->pending);\r\n}\r\n}\r\nfail:\r\nspin_unlock_irqrestore(&smp_lock, flags);\r\nreturn 0;\r\n}\r\nstatic void update_smp_state(struct mdp5_kms *mdp5_kms,\r\nenum mdp5_client_id cid, mdp5_smp_state_t *assigned)\r\n{\r\nint cnt = mdp5_kms->smp_blk_cnt;\r\nuint32_t blk, val;\r\nfor_each_set_bit(blk, *assigned, cnt) {\r\nint idx = blk / 3;\r\nint fld = blk % 3;\r\nval = mdp5_read(mdp5_kms, REG_MDP5_SMP_ALLOC_W_REG(idx));\r\nswitch (fld) {\r\ncase 0:\r\nval &= ~MDP5_SMP_ALLOC_W_REG_CLIENT0__MASK;\r\nval |= MDP5_SMP_ALLOC_W_REG_CLIENT0(cid);\r\nbreak;\r\ncase 1:\r\nval &= ~MDP5_SMP_ALLOC_W_REG_CLIENT1__MASK;\r\nval |= MDP5_SMP_ALLOC_W_REG_CLIENT1(cid);\r\nbreak;\r\ncase 2:\r\nval &= ~MDP5_SMP_ALLOC_W_REG_CLIENT2__MASK;\r\nval |= MDP5_SMP_ALLOC_W_REG_CLIENT2(cid);\r\nbreak;\r\n}\r\nmdp5_write(mdp5_kms, REG_MDP5_SMP_ALLOC_W_REG(idx), val);\r\nmdp5_write(mdp5_kms, REG_MDP5_SMP_ALLOC_R_REG(idx), val);\r\n}\r\n}\r\nvoid mdp5_smp_configure(struct mdp5_kms *mdp5_kms, enum mdp5_client_id cid)\r\n{\r\nstruct mdp5_client_smp_state *ps = &mdp5_kms->smp_client_state[cid];\r\nint cnt = mdp5_kms->smp_blk_cnt;\r\nmdp5_smp_state_t assigned;\r\nbitmap_or(assigned, ps->inuse, ps->pending, cnt);\r\nupdate_smp_state(mdp5_kms, cid, &assigned);\r\n}\r\nvoid mdp5_smp_commit(struct mdp5_kms *mdp5_kms, enum mdp5_client_id cid)\r\n{\r\nstruct mdp5_client_smp_state *ps = &mdp5_kms->smp_client_state[cid];\r\nint cnt = mdp5_kms->smp_blk_cnt;\r\nmdp5_smp_state_t released;\r\nif (bitmap_andnot(released, ps->inuse, ps->pending, cnt)) {\r\nunsigned long flags;\r\nspin_lock_irqsave(&smp_lock, flags);\r\nbitmap_andnot(mdp5_kms->smp_state, mdp5_kms->smp_state,\r\nreleased, cnt);\r\nspin_unlock_irqrestore(&smp_lock, flags);\r\nupdate_smp_state(mdp5_kms, CID_UNUSED, &released);\r\n}\r\nbitmap_copy(ps->inuse, ps->pending, cnt);\r\n}

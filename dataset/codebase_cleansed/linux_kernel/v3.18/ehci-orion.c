static void orion_usb_phy_v1_setup(struct usb_hcd *hcd)\r\n{\r\nwrl(USB_CAUSE, 0);\r\nwrl(USB_MASK, 0);\r\nwrl(USB_CMD, rdl(USB_CMD) | 0x2);\r\nwhile (rdl(USB_CMD) & 0x2);\r\nwrl(USB_IPG, (rdl(USB_IPG) & ~0x7f00) | 0xc00);\r\nwrl(USB_PHY_PWR_CTRL, (rdl(USB_PHY_PWR_CTRL) & ~0xc0)| 0x40);\r\nwrl(USB_PHY_TX_CTRL, (rdl(USB_PHY_TX_CTRL) & ~0x78) | 0x202040);\r\nwrl(USB_PHY_RX_CTRL, (rdl(USB_PHY_RX_CTRL) & ~0xc2003f0) | 0xc0000010);\r\nwrl(USB_PHY_IVREF_CTRL, (rdl(USB_PHY_IVREF_CTRL) & ~0x80003 ) | 0x32);\r\nwrl(USB_PHY_TST_GRP_CTRL, rdl(USB_PHY_TST_GRP_CTRL) & ~0x8000);\r\nwrl(USB_CMD, rdl(USB_CMD) & ~0x1);\r\nwrl(USB_CMD, rdl(USB_CMD) | 0x2);\r\nwhile (rdl(USB_CMD) & 0x2);\r\nwrl(USB_MODE, 0x13);\r\n}\r\nstatic void\r\nehci_orion_conf_mbus_windows(struct usb_hcd *hcd,\r\nconst struct mbus_dram_target_info *dram)\r\n{\r\nint i;\r\nfor (i = 0; i < 4; i++) {\r\nwrl(USB_WINDOW_CTRL(i), 0);\r\nwrl(USB_WINDOW_BASE(i), 0);\r\n}\r\nfor (i = 0; i < dram->num_cs; i++) {\r\nconst struct mbus_dram_window *cs = dram->cs + i;\r\nwrl(USB_WINDOW_CTRL(i), ((cs->size - 1) & 0xffff0000) |\r\n(cs->mbus_attr << 8) |\r\n(dram->mbus_dram_target_id << 4) | 1);\r\nwrl(USB_WINDOW_BASE(i), cs->base);\r\n}\r\n}\r\nstatic int ehci_orion_drv_probe(struct platform_device *pdev)\r\n{\r\nstruct orion_ehci_data *pd = dev_get_platdata(&pdev->dev);\r\nconst struct mbus_dram_target_info *dram;\r\nstruct resource *res;\r\nstruct usb_hcd *hcd;\r\nstruct ehci_hcd *ehci;\r\nvoid __iomem *regs;\r\nint irq, err;\r\nenum orion_ehci_phy_ver phy_version;\r\nstruct orion_ehci_hcd *priv;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\npr_debug("Initializing Orion-SoC USB Host Controller\n");\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq <= 0) {\r\ndev_err(&pdev->dev,\r\n"Found HC with no IRQ. Check %s setup!\n",\r\ndev_name(&pdev->dev));\r\nerr = -ENODEV;\r\ngoto err;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev,\r\n"Found HC with no register addr. Check %s setup!\n",\r\ndev_name(&pdev->dev));\r\nerr = -ENODEV;\r\ngoto err;\r\n}\r\nerr = dma_coerce_mask_and_coherent(&pdev->dev, DMA_BIT_MASK(32));\r\nif (err)\r\ngoto err;\r\nregs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(regs)) {\r\nerr = PTR_ERR(regs);\r\ngoto err;\r\n}\r\nhcd = usb_create_hcd(&ehci_orion_hc_driver,\r\n&pdev->dev, dev_name(&pdev->dev));\r\nif (!hcd) {\r\nerr = -ENOMEM;\r\ngoto err;\r\n}\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nhcd->regs = regs;\r\nehci = hcd_to_ehci(hcd);\r\nehci->caps = hcd->regs + 0x100;\r\nhcd->has_tt = 1;\r\npriv = hcd_to_orion_priv(hcd);\r\npriv->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (!IS_ERR(priv->clk))\r\nclk_prepare_enable(priv->clk);\r\npriv->phy = devm_phy_optional_get(&pdev->dev, "usb");\r\nif (IS_ERR(priv->phy)) {\r\nerr = PTR_ERR(priv->phy);\r\ngoto err_phy_get;\r\n} else {\r\nerr = phy_init(priv->phy);\r\nif (err)\r\ngoto err_phy_init;\r\nerr = phy_power_on(priv->phy);\r\nif (err)\r\ngoto err_phy_power_on;\r\n}\r\ndram = mv_mbus_dram_info();\r\nif (dram)\r\nehci_orion_conf_mbus_windows(hcd, dram);\r\nif (pdev->dev.of_node)\r\nphy_version = EHCI_PHY_NA;\r\nelse\r\nphy_version = pd->phy_version;\r\nswitch (phy_version) {\r\ncase EHCI_PHY_NA:\r\nbreak;\r\ncase EHCI_PHY_ORION:\r\norion_usb_phy_v1_setup(hcd);\r\nbreak;\r\ncase EHCI_PHY_DD:\r\ncase EHCI_PHY_KW:\r\ndefault:\r\ndev_warn(&pdev->dev, "USB phy version isn't supported.\n");\r\n}\r\nerr = usb_add_hcd(hcd, irq, IRQF_SHARED);\r\nif (err)\r\ngoto err_add_hcd;\r\ndevice_wakeup_enable(hcd->self.controller);\r\nreturn 0;\r\nerr_add_hcd:\r\nif (!IS_ERR(priv->phy))\r\nphy_power_off(priv->phy);\r\nerr_phy_power_on:\r\nif (!IS_ERR(priv->phy))\r\nphy_exit(priv->phy);\r\nerr_phy_init:\r\nerr_phy_get:\r\nif (!IS_ERR(priv->clk))\r\nclk_disable_unprepare(priv->clk);\r\nusb_put_hcd(hcd);\r\nerr:\r\ndev_err(&pdev->dev, "init %s fail, %d\n",\r\ndev_name(&pdev->dev), err);\r\nreturn err;\r\n}\r\nstatic int ehci_orion_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nstruct orion_ehci_hcd *priv = hcd_to_orion_priv(hcd);\r\nusb_remove_hcd(hcd);\r\nif (!IS_ERR(priv->phy)) {\r\nphy_power_off(priv->phy);\r\nphy_exit(priv->phy);\r\n}\r\nif (!IS_ERR(priv->clk))\r\nclk_disable_unprepare(priv->clk);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}\r\nstatic int __init ehci_orion_init(void)\r\n{\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\npr_info("%s: " DRIVER_DESC "\n", hcd_name);\r\nehci_init_driver(&ehci_orion_hc_driver, &orion_overrides);\r\nreturn platform_driver_register(&ehci_orion_driver);\r\n}\r\nstatic void __exit ehci_orion_cleanup(void)\r\n{\r\nplatform_driver_unregister(&ehci_orion_driver);\r\n}

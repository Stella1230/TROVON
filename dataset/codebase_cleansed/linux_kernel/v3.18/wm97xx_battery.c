static unsigned long wm97xx_read_bat(struct power_supply *bat_ps)\r\n{\r\nstruct wm97xx_pdata *wmdata = bat_ps->dev->parent->platform_data;\r\nstruct wm97xx_batt_pdata *pdata = wmdata->batt_pdata;\r\nreturn wm97xx_read_aux_adc(dev_get_drvdata(bat_ps->dev->parent),\r\npdata->batt_aux) * pdata->batt_mult /\r\npdata->batt_div;\r\n}\r\nstatic unsigned long wm97xx_read_temp(struct power_supply *bat_ps)\r\n{\r\nstruct wm97xx_pdata *wmdata = bat_ps->dev->parent->platform_data;\r\nstruct wm97xx_batt_pdata *pdata = wmdata->batt_pdata;\r\nreturn wm97xx_read_aux_adc(dev_get_drvdata(bat_ps->dev->parent),\r\npdata->temp_aux) * pdata->temp_mult /\r\npdata->temp_div;\r\n}\r\nstatic int wm97xx_bat_get_property(struct power_supply *bat_ps,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct wm97xx_pdata *wmdata = bat_ps->dev->parent->platform_data;\r\nstruct wm97xx_batt_pdata *pdata = wmdata->batt_pdata;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nval->intval = bat_status;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nval->intval = pdata->batt_tech;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nif (pdata->batt_aux >= 0)\r\nval->intval = wm97xx_read_bat(bat_ps);\r\nelse\r\nreturn -EINVAL;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP:\r\nif (pdata->temp_aux >= 0)\r\nval->intval = wm97xx_read_temp(bat_ps);\r\nelse\r\nreturn -EINVAL;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MAX:\r\nif (pdata->max_voltage >= 0)\r\nval->intval = pdata->max_voltage;\r\nelse\r\nreturn -EINVAL;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MIN:\r\nif (pdata->min_voltage >= 0)\r\nval->intval = pdata->min_voltage;\r\nelse\r\nreturn -EINVAL;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = 1;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void wm97xx_bat_external_power_changed(struct power_supply *bat_ps)\r\n{\r\nschedule_work(&bat_work);\r\n}\r\nstatic void wm97xx_bat_update(struct power_supply *bat_ps)\r\n{\r\nint old_status = bat_status;\r\nstruct wm97xx_pdata *wmdata = bat_ps->dev->parent->platform_data;\r\nstruct wm97xx_batt_pdata *pdata = wmdata->batt_pdata;\r\nmutex_lock(&work_lock);\r\nbat_status = (pdata->charge_gpio >= 0) ?\r\n(gpio_get_value(pdata->charge_gpio) ?\r\nPOWER_SUPPLY_STATUS_DISCHARGING :\r\nPOWER_SUPPLY_STATUS_CHARGING) :\r\nPOWER_SUPPLY_STATUS_UNKNOWN;\r\nif (old_status != bat_status) {\r\npr_debug("%s: %i -> %i\n", bat_ps->name, old_status,\r\nbat_status);\r\npower_supply_changed(bat_ps);\r\n}\r\nmutex_unlock(&work_lock);\r\n}\r\nstatic void wm97xx_bat_work(struct work_struct *work)\r\n{\r\nwm97xx_bat_update(&bat_ps);\r\n}\r\nstatic irqreturn_t wm97xx_chrg_irq(int irq, void *data)\r\n{\r\nschedule_work(&bat_work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int wm97xx_bat_suspend(struct device *dev)\r\n{\r\nflush_work(&bat_work);\r\nreturn 0;\r\n}\r\nstatic int wm97xx_bat_resume(struct device *dev)\r\n{\r\nschedule_work(&bat_work);\r\nreturn 0;\r\n}\r\nstatic int wm97xx_bat_probe(struct platform_device *dev)\r\n{\r\nint ret = 0;\r\nint props = 1;\r\nint i = 0;\r\nstruct wm97xx_pdata *wmdata = dev->dev.platform_data;\r\nstruct wm97xx_batt_pdata *pdata;\r\nif (!wmdata) {\r\ndev_err(&dev->dev, "No platform data supplied\n");\r\nreturn -EINVAL;\r\n}\r\npdata = wmdata->batt_pdata;\r\nif (dev->id != -1)\r\nreturn -EINVAL;\r\nif (!pdata) {\r\ndev_err(&dev->dev, "No platform_data supplied\n");\r\nreturn -EINVAL;\r\n}\r\nif (gpio_is_valid(pdata->charge_gpio)) {\r\nret = gpio_request(pdata->charge_gpio, "BATT CHRG");\r\nif (ret)\r\ngoto err;\r\nret = gpio_direction_input(pdata->charge_gpio);\r\nif (ret)\r\ngoto err2;\r\nret = request_irq(gpio_to_irq(pdata->charge_gpio),\r\nwm97xx_chrg_irq, 0,\r\n"AC Detect", dev);\r\nif (ret)\r\ngoto err2;\r\nprops++;\r\n}\r\nif (pdata->batt_tech >= 0)\r\nprops++;\r\nif (pdata->temp_aux >= 0)\r\nprops++;\r\nif (pdata->batt_aux >= 0)\r\nprops++;\r\nif (pdata->max_voltage >= 0)\r\nprops++;\r\nif (pdata->min_voltage >= 0)\r\nprops++;\r\nprop = kzalloc(props * sizeof(*prop), GFP_KERNEL);\r\nif (!prop) {\r\nret = -ENOMEM;\r\ngoto err3;\r\n}\r\nprop[i++] = POWER_SUPPLY_PROP_PRESENT;\r\nif (pdata->charge_gpio >= 0)\r\nprop[i++] = POWER_SUPPLY_PROP_STATUS;\r\nif (pdata->batt_tech >= 0)\r\nprop[i++] = POWER_SUPPLY_PROP_TECHNOLOGY;\r\nif (pdata->temp_aux >= 0)\r\nprop[i++] = POWER_SUPPLY_PROP_TEMP;\r\nif (pdata->batt_aux >= 0)\r\nprop[i++] = POWER_SUPPLY_PROP_VOLTAGE_NOW;\r\nif (pdata->max_voltage >= 0)\r\nprop[i++] = POWER_SUPPLY_PROP_VOLTAGE_MAX;\r\nif (pdata->min_voltage >= 0)\r\nprop[i++] = POWER_SUPPLY_PROP_VOLTAGE_MIN;\r\nINIT_WORK(&bat_work, wm97xx_bat_work);\r\nif (!pdata->batt_name) {\r\ndev_info(&dev->dev, "Please consider setting proper battery "\r\n"name in platform definition file, falling "\r\n"back to name \"wm97xx-batt\"\n");\r\nbat_ps.name = "wm97xx-batt";\r\n} else\r\nbat_ps.name = pdata->batt_name;\r\nbat_ps.properties = prop;\r\nbat_ps.num_properties = props;\r\nret = power_supply_register(&dev->dev, &bat_ps);\r\nif (!ret)\r\nschedule_work(&bat_work);\r\nelse\r\ngoto err4;\r\nreturn 0;\r\nerr4:\r\nkfree(prop);\r\nerr3:\r\nif (gpio_is_valid(pdata->charge_gpio))\r\nfree_irq(gpio_to_irq(pdata->charge_gpio), dev);\r\nerr2:\r\nif (gpio_is_valid(pdata->charge_gpio))\r\ngpio_free(pdata->charge_gpio);\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int wm97xx_bat_remove(struct platform_device *dev)\r\n{\r\nstruct wm97xx_pdata *wmdata = dev->dev.platform_data;\r\nstruct wm97xx_batt_pdata *pdata = wmdata->batt_pdata;\r\nif (pdata && gpio_is_valid(pdata->charge_gpio)) {\r\nfree_irq(gpio_to_irq(pdata->charge_gpio), dev);\r\ngpio_free(pdata->charge_gpio);\r\n}\r\ncancel_work_sync(&bat_work);\r\npower_supply_unregister(&bat_ps);\r\nkfree(prop);\r\nreturn 0;\r\n}

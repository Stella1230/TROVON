u32 b43_lcntab_read(struct b43_wldev *dev, u32 offset)\r\n{\r\nu32 type, value;\r\ntype = offset & B43_LCNTAB_TYPEMASK;\r\noffset &= ~B43_LCNTAB_TYPEMASK;\r\nB43_WARN_ON(offset > 0xFFFF);\r\nswitch (type) {\r\ncase B43_LCNTAB_8BIT:\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_ADDR, offset);\r\nvalue = b43_phy_read(dev, B43_PHY_LCN_TABLE_DATALO) & 0xFF;\r\nbreak;\r\ncase B43_LCNTAB_16BIT:\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_ADDR, offset);\r\nvalue = b43_phy_read(dev, B43_PHY_LCN_TABLE_DATALO);\r\nbreak;\r\ncase B43_LCNTAB_32BIT:\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_ADDR, offset);\r\nvalue = b43_phy_read(dev, B43_PHY_LCN_TABLE_DATALO);\r\nvalue |= (b43_phy_read(dev, B43_PHY_LCN_TABLE_DATAHI) << 16);\r\nbreak;\r\ndefault:\r\nB43_WARN_ON(1);\r\nvalue = 0;\r\n}\r\nreturn value;\r\n}\r\nvoid b43_lcntab_read_bulk(struct b43_wldev *dev, u32 offset,\r\nunsigned int nr_elements, void *_data)\r\n{\r\nu32 type;\r\nu8 *data = _data;\r\nunsigned int i;\r\ntype = offset & B43_LCNTAB_TYPEMASK;\r\noffset &= ~B43_LCNTAB_TYPEMASK;\r\nB43_WARN_ON(offset > 0xFFFF);\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_ADDR, offset);\r\nfor (i = 0; i < nr_elements; i++) {\r\nswitch (type) {\r\ncase B43_LCNTAB_8BIT:\r\n*data = b43_phy_read(dev,\r\nB43_PHY_LCN_TABLE_DATALO) & 0xFF;\r\ndata++;\r\nbreak;\r\ncase B43_LCNTAB_16BIT:\r\n*((u16 *)data) = b43_phy_read(dev,\r\nB43_PHY_LCN_TABLE_DATALO);\r\ndata += 2;\r\nbreak;\r\ncase B43_LCNTAB_32BIT:\r\n*((u32 *)data) = b43_phy_read(dev,\r\nB43_PHY_LCN_TABLE_DATALO);\r\n*((u32 *)data) |= (b43_phy_read(dev,\r\nB43_PHY_LCN_TABLE_DATAHI) << 16);\r\ndata += 4;\r\nbreak;\r\ndefault:\r\nB43_WARN_ON(1);\r\n}\r\n}\r\n}\r\nvoid b43_lcntab_write(struct b43_wldev *dev, u32 offset, u32 value)\r\n{\r\nu32 type;\r\ntype = offset & B43_LCNTAB_TYPEMASK;\r\noffset &= 0xFFFF;\r\nswitch (type) {\r\ncase B43_LCNTAB_8BIT:\r\nB43_WARN_ON(value & ~0xFF);\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_ADDR, offset);\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_DATALO, value);\r\nbreak;\r\ncase B43_LCNTAB_16BIT:\r\nB43_WARN_ON(value & ~0xFFFF);\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_ADDR, offset);\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_DATALO, value);\r\nbreak;\r\ncase B43_LCNTAB_32BIT:\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_ADDR, offset);\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_DATAHI, value >> 16);\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_DATALO, value & 0xFFFF);\r\nbreak;\r\ndefault:\r\nB43_WARN_ON(1);\r\n}\r\nreturn;\r\n}\r\nvoid b43_lcntab_write_bulk(struct b43_wldev *dev, u32 offset,\r\nunsigned int nr_elements, const void *_data)\r\n{\r\nu32 type, value;\r\nconst u8 *data = _data;\r\nunsigned int i;\r\ntype = offset & B43_LCNTAB_TYPEMASK;\r\noffset &= ~B43_LCNTAB_TYPEMASK;\r\nB43_WARN_ON(offset > 0xFFFF);\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_ADDR, offset);\r\nfor (i = 0; i < nr_elements; i++) {\r\nswitch (type) {\r\ncase B43_LCNTAB_8BIT:\r\nvalue = *data;\r\ndata++;\r\nB43_WARN_ON(value & ~0xFF);\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_DATALO, value);\r\nbreak;\r\ncase B43_LCNTAB_16BIT:\r\nvalue = *((u16 *)data);\r\ndata += 2;\r\nB43_WARN_ON(value & ~0xFFFF);\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_DATALO, value);\r\nbreak;\r\ncase B43_LCNTAB_32BIT:\r\nvalue = *((u32 *)data);\r\ndata += 4;\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_DATAHI,\r\nvalue >> 16);\r\nb43_phy_write(dev, B43_PHY_LCN_TABLE_DATALO,\r\nvalue & 0xFFFF);\r\nbreak;\r\ndefault:\r\nB43_WARN_ON(1);\r\n}\r\n}\r\n}\r\nstatic void b43_phy_lcn_upload_static_tables(struct b43_wldev *dev)\r\n{\r\nlcntab_upload(dev, B43_LCNTAB16(0x02, 0), b43_lcntab_0x02);\r\nlcntab_upload(dev, B43_LCNTAB16(0x01, 0), b43_lcntab_0x01);\r\nlcntab_upload(dev, B43_LCNTAB32(0x0b, 0), b43_lcntab_0x0b);\r\nlcntab_upload(dev, B43_LCNTAB32(0x0c, 0), b43_lcntab_0x0c);\r\nlcntab_upload(dev, B43_LCNTAB32(0x0d, 0), b43_lcntab_0x0d);\r\nlcntab_upload(dev, B43_LCNTAB16(0x0e, 0), b43_lcntab_0x0e);\r\nlcntab_upload(dev, B43_LCNTAB16(0x0f, 0), b43_lcntab_0x0f);\r\nlcntab_upload(dev, B43_LCNTAB16(0x10, 0), b43_lcntab_0x10);\r\nlcntab_upload(dev, B43_LCNTAB16(0x11, 0), b43_lcntab_0x11);\r\nlcntab_upload(dev, B43_LCNTAB32(0x12, 0), b43_lcntab_0x12);\r\nlcntab_upload(dev, B43_LCNTAB16(0x14, 0), b43_lcntab_0x14);\r\nlcntab_upload(dev, B43_LCNTAB16(0x17, 0), b43_lcntab_0x17);\r\nlcntab_upload(dev, B43_LCNTAB16(0x00, 0), b43_lcntab_0x00);\r\nlcntab_upload(dev, B43_LCNTAB32(0x18, 0), b43_lcntab_0x18);\r\n}\r\nstatic void b43_phy_lcn_load_tx_gain_tab(struct b43_wldev *dev,\r\nconst struct b43_lcntab_tx_gain_tbl_entry *gain_table)\r\n{\r\nu32 i;\r\nu32 val;\r\nu16 pa_gain = 0x70;\r\nif (dev->dev->bus_sprom->boardflags_lo & B43_BFL_FEM)\r\npa_gain = 0x10;\r\nfor (i = 0; i < B43_LCNTAB_TX_GAIN_SIZE; i++) {\r\nval = ((pa_gain << 24) |\r\n(gain_table[i].pad << 16) |\r\n(gain_table[i].pga << 8) |\r\ngain_table[i].gm);\r\nb43_lcntab_write(dev, B43_LCNTAB32(0x7, 0xc0 + i), val);\r\nval = b43_lcntab_read(dev, B43_LCNTAB32(0x7, 0x140 + i));\r\nval &= 0x000fffff;\r\nval |= ((gain_table[i].dac << 28) |\r\n(gain_table[i].bb_mult << 20));\r\nb43_lcntab_write(dev, B43_LCNTAB32(0x7, 0x140 + i), val);\r\n}\r\n}\r\nstatic void b43_phy_lcn_load_rfpower(struct b43_wldev *dev)\r\n{\r\nu32 bbmult, rfgain;\r\nu8 i;\r\nfor (i = 0; i < 128; i++) {\r\nbbmult = b43_lcntab_read(dev, B43_LCNTAB32(0x7, 0x140 + i));\r\nbbmult >>= 20;\r\nrfgain = b43_lcntab_read(dev, B43_LCNTAB32(0x7, 0xc0 + i));\r\n}\r\n}\r\nstatic void b43_phy_lcn_rewrite_rfpower_table(struct b43_wldev *dev)\r\n{\r\nint i;\r\nu32 tmp;\r\nfor (i = 0; i < 128; i++) {\r\ntmp = b43_lcntab_read(dev, B43_LCNTAB32(0x7, 0x240 + i));\r\nb43_lcntab_write(dev, B43_LCNTAB32(0x7, 0x240 + i), tmp);\r\n}\r\n}\r\nstatic void b43_phy_lcn_clean_papd_comp_table(struct b43_wldev *dev)\r\n{\r\nu8 i;\r\nfor (i = 0; i < 0x80; i++)\r\nb43_lcntab_write(dev, B43_LCNTAB32(0x18, i), 0x80000);\r\n}\r\nvoid b43_phy_lcn_tables_init(struct b43_wldev *dev)\r\n{\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nb43_phy_lcn_upload_static_tables(dev);\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {\r\nif (sprom->boardflags_lo & B43_BFL_FEM)\r\nb43_phy_lcn_load_tx_gain_tab(dev,\r\nb43_lcntab_tx_gain_tbl_2ghz_ext_pa_rev0);\r\nelse\r\nb43err(dev->wl,\r\n"TX gain table unknown for this card\n");\r\n}\r\nif (sprom->boardflags_lo & B43_BFL_FEM &&\r\n!(sprom->boardflags_hi & B43_BFH_FEM_BT))\r\nb43_lcntab_write_bulk(dev, B43_LCNTAB16(0xf, 0),\r\nARRAY_SIZE(b43_lcntab_sw_ctl_4313_epa_rev0),\r\nb43_lcntab_sw_ctl_4313_epa_rev0);\r\nelse\r\nb43err(dev->wl, "SW ctl table is unknown for this card\n");\r\nb43_phy_lcn_load_rfpower(dev);\r\nb43_phy_lcn_rewrite_rfpower_table(dev);\r\nb43_phy_lcn_clean_papd_comp_table(dev);\r\n}

void __init at91_add_device_usbh(struct at91_usbh_data *data)\r\n{\r\nint i;\r\nif (!data)\r\nreturn;\r\nfor (i = 0; i < data->ports; i++) {\r\nif (gpio_is_valid(data->overcurrent_pin[i]))\r\nat91_set_gpio_input(data->overcurrent_pin[i], 1);\r\n}\r\nusbh_data = *data;\r\nplatform_device_register(&at91rm9200_usbh_device);\r\n}\r\nvoid __init at91_add_device_usbh(struct at91_usbh_data *data) {}\r\nvoid __init at91_add_device_udc(struct at91_udc_data *data)\r\n{\r\nif (!data)\r\nreturn;\r\nif (gpio_is_valid(data->vbus_pin)) {\r\nat91_set_gpio_input(data->vbus_pin, 0);\r\nat91_set_deglitch(data->vbus_pin, 1);\r\n}\r\nif (gpio_is_valid(data->pullup_pin))\r\nat91_set_gpio_output(data->pullup_pin, 0);\r\nudc_data = *data;\r\nplatform_device_register(&at91rm9200_udc_device);\r\n}\r\nvoid __init at91_add_device_udc(struct at91_udc_data *data) {}\r\nvoid __init at91_add_device_eth(struct macb_platform_data *data)\r\n{\r\nif (!data)\r\nreturn;\r\nif (gpio_is_valid(data->phy_irq_pin)) {\r\nat91_set_gpio_input(data->phy_irq_pin, 0);\r\nat91_set_deglitch(data->phy_irq_pin, 1);\r\n}\r\nat91_set_A_periph(AT91_PIN_PA16, 0);\r\nat91_set_A_periph(AT91_PIN_PA15, 0);\r\nat91_set_A_periph(AT91_PIN_PA14, 0);\r\nat91_set_A_periph(AT91_PIN_PA13, 0);\r\nat91_set_A_periph(AT91_PIN_PA12, 0);\r\nat91_set_A_periph(AT91_PIN_PA11, 0);\r\nat91_set_A_periph(AT91_PIN_PA10, 0);\r\nat91_set_A_periph(AT91_PIN_PA9, 0);\r\nat91_set_A_periph(AT91_PIN_PA8, 0);\r\nat91_set_A_periph(AT91_PIN_PA7, 0);\r\nif (!data->is_rmii) {\r\nat91_set_B_periph(AT91_PIN_PB19, 0);\r\nat91_set_B_periph(AT91_PIN_PB18, 0);\r\nat91_set_B_periph(AT91_PIN_PB17, 0);\r\nat91_set_B_periph(AT91_PIN_PB16, 0);\r\nat91_set_B_periph(AT91_PIN_PB15, 0);\r\nat91_set_B_periph(AT91_PIN_PB14, 0);\r\nat91_set_B_periph(AT91_PIN_PB13, 0);\r\nat91_set_B_periph(AT91_PIN_PB12, 0);\r\n}\r\neth_data = *data;\r\nplatform_device_register(&at91rm9200_eth_device);\r\n}\r\nvoid __init at91_add_device_eth(struct macb_platform_data *data) {}\r\nvoid __init at91_add_device_cf(struct at91_cf_data *data)\r\n{\r\nunsigned int csa;\r\nif (!data)\r\nreturn;\r\ndata->chipselect = 4;\r\ncsa = at91_ramc_read(0, AT91_EBI_CSA);\r\nat91_ramc_write(0, AT91_EBI_CSA, csa | AT91_EBI_CS4A_SMC_COMPACTFLASH);\r\nat91_ramc_write(0, AT91_SMC_CSR(4),\r\nAT91_SMC_ACSS_STD\r\n| AT91_SMC_DBW_16\r\n| AT91_SMC_BAT\r\n| AT91_SMC_WSEN\r\n| AT91_SMC_NWS_(32)\r\n| AT91_SMC_RWSETUP_(6)\r\n| AT91_SMC_RWHOLD_(4)\r\n);\r\nif (gpio_is_valid(data->irq_pin)) {\r\nat91_set_gpio_input(data->irq_pin, 1);\r\nat91_set_deglitch(data->irq_pin, 1);\r\n}\r\nat91_set_gpio_input(data->det_pin, 1);\r\nat91_set_deglitch(data->det_pin, 1);\r\nif (gpio_is_valid(data->vcc_pin))\r\nat91_set_gpio_output(data->vcc_pin, 0);\r\nat91_set_gpio_output(data->rst_pin, 0);\r\nat91_set_A_periph(AT91_PIN_PC9, 0);\r\nat91_set_A_periph(AT91_PIN_PC10, 0);\r\nat91_set_A_periph(AT91_PIN_PC11, 0);\r\nat91_set_A_periph(AT91_PIN_PC12, 0);\r\nat91_set_A_periph(AT91_PIN_PC6, 1);\r\ncf_data = *data;\r\nplatform_device_register(&at91rm9200_cf_device);\r\n}\r\nvoid __init at91_add_device_cf(struct at91_cf_data *data) {}\r\nvoid __init at91_add_device_mci(short mmc_id, struct mci_platform_data *data)\r\n{\r\nunsigned int i;\r\nunsigned int slot_count = 0;\r\nif (!data)\r\nreturn;\r\nfor (i = 0; i < ATMCI_MAX_NR_SLOTS; i++) {\r\nif (!data->slot[i].bus_width)\r\ncontinue;\r\nif (gpio_is_valid(data->slot[i].detect_pin)) {\r\nat91_set_gpio_input(data->slot[i].detect_pin, 1);\r\nat91_set_deglitch(data->slot[i].detect_pin, 1);\r\n}\r\nif (gpio_is_valid(data->slot[i].wp_pin))\r\nat91_set_gpio_input(data->slot[i].wp_pin, 1);\r\nswitch (i) {\r\ncase 0:\r\nat91_set_A_periph(AT91_PIN_PA28, 1);\r\nat91_set_A_periph(AT91_PIN_PA29, 1);\r\nif (data->slot[i].bus_width == 4) {\r\nat91_set_B_periph(AT91_PIN_PB3, 1);\r\nat91_set_B_periph(AT91_PIN_PB4, 1);\r\nat91_set_B_periph(AT91_PIN_PB5, 1);\r\n}\r\nslot_count++;\r\nbreak;\r\ncase 1:\r\nat91_set_B_periph(AT91_PIN_PA8, 1);\r\nat91_set_B_periph(AT91_PIN_PA9, 1);\r\nif (data->slot[i].bus_width == 4) {\r\nat91_set_B_periph(AT91_PIN_PA10, 1);\r\nat91_set_B_periph(AT91_PIN_PA11, 1);\r\nat91_set_B_periph(AT91_PIN_PA12, 1);\r\n}\r\nslot_count++;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR\r\n"AT91: SD/MMC slot %d not available\n", i);\r\nbreak;\r\n}\r\nif (slot_count) {\r\nat91_set_A_periph(AT91_PIN_PA27, 0);\r\nmmc_data = *data;\r\nplatform_device_register(&at91rm9200_mmc_device);\r\n}\r\n}\r\n}\r\nvoid __init at91_add_device_mci(short mmc_id, struct mci_platform_data *data) {}\r\nvoid __init at91_add_device_nand(struct atmel_nand_data *data)\r\n{\r\nunsigned int csa;\r\nif (!data)\r\nreturn;\r\ncsa = at91_ramc_read(0, AT91_EBI_CSA);\r\nat91_ramc_write(0, AT91_EBI_CSA, csa | AT91_EBI_CS3A_SMC_SMARTMEDIA);\r\nat91_ramc_write(0, AT91_SMC_CSR(3), AT91_SMC_ACSS_STD | AT91_SMC_DBW_8 | AT91_SMC_WSEN\r\n| AT91_SMC_NWS_(5)\r\n| AT91_SMC_TDF_(1)\r\n| AT91_SMC_RWSETUP_(0)\r\n| AT91_SMC_RWHOLD_(1)\r\n);\r\nif (gpio_is_valid(data->enable_pin))\r\nat91_set_gpio_output(data->enable_pin, 1);\r\nif (gpio_is_valid(data->rdy_pin))\r\nat91_set_gpio_input(data->rdy_pin, 1);\r\nif (gpio_is_valid(data->det_pin))\r\nat91_set_gpio_input(data->det_pin, 1);\r\nat91_set_A_periph(AT91_PIN_PC1, 0);\r\nat91_set_A_periph(AT91_PIN_PC3, 0);\r\nnand_data = *data;\r\nplatform_device_register(&at91rm9200_nand_device);\r\n}\r\nvoid __init at91_add_device_nand(struct atmel_nand_data *data) {}\r\nvoid __init at91_add_device_i2c(struct i2c_board_info *devices, int nr_devices)\r\n{\r\nat91_set_GPIO_periph(AT91_PIN_PA25, 1);\r\nat91_set_multi_drive(AT91_PIN_PA25, 1);\r\nat91_set_GPIO_periph(AT91_PIN_PA26, 1);\r\nat91_set_multi_drive(AT91_PIN_PA26, 1);\r\ni2c_register_board_info(0, devices, nr_devices);\r\nplatform_device_register(&at91rm9200_twi_device);\r\n}\r\nvoid __init at91_add_device_i2c(struct i2c_board_info *devices, int nr_devices)\r\n{\r\nat91_set_A_periph(AT91_PIN_PA25, 0);\r\nat91_set_multi_drive(AT91_PIN_PA25, 1);\r\nat91_set_A_periph(AT91_PIN_PA26, 0);\r\nat91_set_multi_drive(AT91_PIN_PA26, 1);\r\ni2c_register_board_info(0, devices, nr_devices);\r\nplatform_device_register(&at91rm9200_twi_device);\r\n}\r\nvoid __init at91_add_device_i2c(struct i2c_board_info *devices, int nr_devices) {}\r\nvoid __init at91_add_device_spi(struct spi_board_info *devices, int nr_devices)\r\n{\r\nint i;\r\nunsigned long cs_pin;\r\nat91_set_A_periph(AT91_PIN_PA0, 0);\r\nat91_set_A_periph(AT91_PIN_PA1, 0);\r\nat91_set_A_periph(AT91_PIN_PA2, 0);\r\nfor (i = 0; i < nr_devices; i++) {\r\nif (devices[i].controller_data)\r\ncs_pin = (unsigned long) devices[i].controller_data;\r\nelse\r\ncs_pin = spi_standard_cs[devices[i].chip_select];\r\nif (devices[i].chip_select == 0)\r\nat91_set_A_periph(cs_pin, 0);\r\nelse\r\nat91_set_gpio_output(cs_pin, 1);\r\ndevices[i].controller_data = (void *) cs_pin;\r\n}\r\nspi_register_board_info(devices, nr_devices);\r\nplatform_device_register(&at91rm9200_spi_device);\r\n}\r\nvoid __init at91_add_device_spi(struct spi_board_info *devices, int nr_devices) {}\r\nstatic void __init at91_add_device_tc(void)\r\n{\r\nplatform_device_register(&at91rm9200_tcb0_device);\r\nplatform_device_register(&at91rm9200_tcb1_device);\r\n}\r\nstatic void __init at91_add_device_tc(void) { }\r\nstatic void __init at91_add_device_rtc(void)\r\n{\r\nplatform_device_register(&at91rm9200_rtc_device);\r\n}\r\nstatic void __init at91_add_device_rtc(void) {}\r\nstatic void __init at91_add_device_watchdog(void)\r\n{\r\nplatform_device_register(&at91rm9200_wdt_device);\r\n}\r\nstatic void __init at91_add_device_watchdog(void) {}\r\nstatic inline void configure_ssc0_pins(unsigned pins)\r\n{\r\nif (pins & ATMEL_SSC_TF)\r\nat91_set_A_periph(AT91_PIN_PB0, 1);\r\nif (pins & ATMEL_SSC_TK)\r\nat91_set_A_periph(AT91_PIN_PB1, 1);\r\nif (pins & ATMEL_SSC_TD)\r\nat91_set_A_periph(AT91_PIN_PB2, 1);\r\nif (pins & ATMEL_SSC_RD)\r\nat91_set_A_periph(AT91_PIN_PB3, 1);\r\nif (pins & ATMEL_SSC_RK)\r\nat91_set_A_periph(AT91_PIN_PB4, 1);\r\nif (pins & ATMEL_SSC_RF)\r\nat91_set_A_periph(AT91_PIN_PB5, 1);\r\n}\r\nstatic inline void configure_ssc1_pins(unsigned pins)\r\n{\r\nif (pins & ATMEL_SSC_TF)\r\nat91_set_A_periph(AT91_PIN_PB6, 1);\r\nif (pins & ATMEL_SSC_TK)\r\nat91_set_A_periph(AT91_PIN_PB7, 1);\r\nif (pins & ATMEL_SSC_TD)\r\nat91_set_A_periph(AT91_PIN_PB8, 1);\r\nif (pins & ATMEL_SSC_RD)\r\nat91_set_A_periph(AT91_PIN_PB9, 1);\r\nif (pins & ATMEL_SSC_RK)\r\nat91_set_A_periph(AT91_PIN_PB10, 1);\r\nif (pins & ATMEL_SSC_RF)\r\nat91_set_A_periph(AT91_PIN_PB11, 1);\r\n}\r\nstatic inline void configure_ssc2_pins(unsigned pins)\r\n{\r\nif (pins & ATMEL_SSC_TF)\r\nat91_set_A_periph(AT91_PIN_PB12, 1);\r\nif (pins & ATMEL_SSC_TK)\r\nat91_set_A_periph(AT91_PIN_PB13, 1);\r\nif (pins & ATMEL_SSC_TD)\r\nat91_set_A_periph(AT91_PIN_PB14, 1);\r\nif (pins & ATMEL_SSC_RD)\r\nat91_set_A_periph(AT91_PIN_PB15, 1);\r\nif (pins & ATMEL_SSC_RK)\r\nat91_set_A_periph(AT91_PIN_PB16, 1);\r\nif (pins & ATMEL_SSC_RF)\r\nat91_set_A_periph(AT91_PIN_PB17, 1);\r\n}\r\nvoid __init at91_add_device_ssc(unsigned id, unsigned pins)\r\n{\r\nstruct platform_device *pdev;\r\nswitch (id) {\r\ncase AT91RM9200_ID_SSC0:\r\npdev = &at91rm9200_ssc0_device;\r\nconfigure_ssc0_pins(pins);\r\nbreak;\r\ncase AT91RM9200_ID_SSC1:\r\npdev = &at91rm9200_ssc1_device;\r\nconfigure_ssc1_pins(pins);\r\nbreak;\r\ncase AT91RM9200_ID_SSC2:\r\npdev = &at91rm9200_ssc2_device;\r\nconfigure_ssc2_pins(pins);\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nplatform_device_register(pdev);\r\n}\r\nvoid __init at91_add_device_ssc(unsigned id, unsigned pins) {}\r\nstatic inline void configure_dbgu_pins(void)\r\n{\r\nat91_set_A_periph(AT91_PIN_PA30, 0);\r\nat91_set_A_periph(AT91_PIN_PA31, 1);\r\n}\r\nstatic inline void configure_usart0_pins(unsigned pins)\r\n{\r\nat91_set_A_periph(AT91_PIN_PA17, 1);\r\nat91_set_A_periph(AT91_PIN_PA18, 0);\r\nif (pins & ATMEL_UART_CTS)\r\nat91_set_A_periph(AT91_PIN_PA20, 0);\r\nif (pins & ATMEL_UART_RTS) {\r\ngpiod_add_lookup_table(&uart0_gpios_table);\r\n}\r\n}\r\nstatic inline void configure_usart1_pins(unsigned pins)\r\n{\r\nat91_set_A_periph(AT91_PIN_PB20, 1);\r\nat91_set_A_periph(AT91_PIN_PB21, 0);\r\nif (pins & ATMEL_UART_RI)\r\nat91_set_A_periph(AT91_PIN_PB18, 0);\r\nif (pins & ATMEL_UART_DTR)\r\nat91_set_A_periph(AT91_PIN_PB19, 0);\r\nif (pins & ATMEL_UART_DCD)\r\nat91_set_A_periph(AT91_PIN_PB23, 0);\r\nif (pins & ATMEL_UART_CTS)\r\nat91_set_A_periph(AT91_PIN_PB24, 0);\r\nif (pins & ATMEL_UART_DSR)\r\nat91_set_A_periph(AT91_PIN_PB25, 0);\r\nif (pins & ATMEL_UART_RTS)\r\nat91_set_A_periph(AT91_PIN_PB26, 0);\r\n}\r\nstatic inline void configure_usart2_pins(unsigned pins)\r\n{\r\nat91_set_A_periph(AT91_PIN_PA22, 0);\r\nat91_set_A_periph(AT91_PIN_PA23, 1);\r\nif (pins & ATMEL_UART_CTS)\r\nat91_set_B_periph(AT91_PIN_PA30, 0);\r\nif (pins & ATMEL_UART_RTS)\r\nat91_set_B_periph(AT91_PIN_PA31, 0);\r\n}\r\nstatic inline void configure_usart3_pins(unsigned pins)\r\n{\r\nat91_set_B_periph(AT91_PIN_PA5, 1);\r\nat91_set_B_periph(AT91_PIN_PA6, 0);\r\nif (pins & ATMEL_UART_CTS)\r\nat91_set_B_periph(AT91_PIN_PB1, 0);\r\nif (pins & ATMEL_UART_RTS)\r\nat91_set_B_periph(AT91_PIN_PB0, 0);\r\n}\r\nvoid __init at91_register_uart(unsigned id, unsigned portnr, unsigned pins)\r\n{\r\nstruct platform_device *pdev;\r\nstruct atmel_uart_data *pdata;\r\nswitch (id) {\r\ncase 0:\r\npdev = &at91rm9200_dbgu_device;\r\nconfigure_dbgu_pins();\r\nbreak;\r\ncase AT91RM9200_ID_US0:\r\npdev = &at91rm9200_uart0_device;\r\nconfigure_usart0_pins(pins);\r\nbreak;\r\ncase AT91RM9200_ID_US1:\r\npdev = &at91rm9200_uart1_device;\r\nconfigure_usart1_pins(pins);\r\nbreak;\r\ncase AT91RM9200_ID_US2:\r\npdev = &at91rm9200_uart2_device;\r\nconfigure_usart2_pins(pins);\r\nbreak;\r\ncase AT91RM9200_ID_US3:\r\npdev = &at91rm9200_uart3_device;\r\nconfigure_usart3_pins(pins);\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\npdata = pdev->dev.platform_data;\r\npdata->num = portnr;\r\nif (portnr < ATMEL_MAX_UART)\r\nat91_uarts[portnr] = pdev;\r\n}\r\nvoid __init at91_add_device_serial(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ATMEL_MAX_UART; i++) {\r\nif (at91_uarts[i])\r\nplatform_device_register(at91_uarts[i]);\r\n}\r\n}\r\nvoid __init at91_register_uart(unsigned id, unsigned portnr, unsigned pins) {}\r\nvoid __init at91_add_device_serial(void) {}\r\nstatic int __init at91_add_standard_devices(void)\r\n{\r\nat91_add_device_rtc();\r\nat91_add_device_watchdog();\r\nat91_add_device_tc();\r\nreturn 0;\r\n}

int atl1c_check_eeprom_exist(struct atl1c_hw *hw)\r\n{\r\nu32 data;\r\nAT_READ_REG(hw, REG_TWSI_DEBUG, &data);\r\nif (data & TWSI_DEBUG_DEV_EXIST)\r\nreturn 1;\r\nAT_READ_REG(hw, REG_MASTER_CTRL, &data);\r\nif (data & MASTER_CTRL_OTP_SEL)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nvoid atl1c_hw_set_mac_addr(struct atl1c_hw *hw, u8 *mac_addr)\r\n{\r\nu32 value;\r\nvalue = mac_addr[2] << 24 |\r\nmac_addr[3] << 16 |\r\nmac_addr[4] << 8 |\r\nmac_addr[5];\r\nAT_WRITE_REG_ARRAY(hw, REG_MAC_STA_ADDR, 0, value);\r\nvalue = mac_addr[0] << 8 |\r\nmac_addr[1];\r\nAT_WRITE_REG_ARRAY(hw, REG_MAC_STA_ADDR, 1, value);\r\n}\r\nstatic bool atl1c_read_current_addr(struct atl1c_hw *hw, u8 *eth_addr)\r\n{\r\nu32 addr[2];\r\nAT_READ_REG(hw, REG_MAC_STA_ADDR, &addr[0]);\r\nAT_READ_REG(hw, REG_MAC_STA_ADDR + 4, &addr[1]);\r\n*(u32 *) &eth_addr[2] = htonl(addr[0]);\r\n*(u16 *) &eth_addr[0] = htons((u16)addr[1]);\r\nreturn is_valid_ether_addr(eth_addr);\r\n}\r\nstatic int atl1c_get_permanent_address(struct atl1c_hw *hw)\r\n{\r\nu32 i;\r\nu32 otp_ctrl_data;\r\nu32 twsi_ctrl_data;\r\nu16 phy_data;\r\nbool raise_vol = false;\r\nif (atl1c_read_current_addr(hw, hw->perm_mac_addr))\r\nreturn 0;\r\nAT_READ_REG(hw, REG_OTP_CTRL, &otp_ctrl_data);\r\nif (atl1c_check_eeprom_exist(hw)) {\r\nif (hw->nic_type == athr_l1c || hw->nic_type == athr_l2c) {\r\nif (!(otp_ctrl_data & OTP_CTRL_CLK_EN)) {\r\notp_ctrl_data |= OTP_CTRL_CLK_EN;\r\nAT_WRITE_REG(hw, REG_OTP_CTRL, otp_ctrl_data);\r\nAT_WRITE_FLUSH(hw);\r\nmsleep(1);\r\n}\r\n}\r\nif (hw->nic_type == athr_l2c_b || hw->nic_type == athr_l2c_b2) {\r\natl1c_read_phy_dbg(hw, MIIDBG_ANACTRL, &phy_data);\r\nphy_data &= ~ANACTRL_HB_EN;\r\natl1c_write_phy_dbg(hw, MIIDBG_ANACTRL, phy_data);\r\natl1c_read_phy_dbg(hw, MIIDBG_VOLT_CTRL, &phy_data);\r\nphy_data |= VOLT_CTRL_SWLOWEST;\r\natl1c_write_phy_dbg(hw, MIIDBG_VOLT_CTRL, phy_data);\r\nudelay(20);\r\nraise_vol = true;\r\n}\r\nAT_READ_REG(hw, REG_TWSI_CTRL, &twsi_ctrl_data);\r\ntwsi_ctrl_data |= TWSI_CTRL_SW_LDSTART;\r\nAT_WRITE_REG(hw, REG_TWSI_CTRL, twsi_ctrl_data);\r\nfor (i = 0; i < AT_TWSI_EEPROM_TIMEOUT; i++) {\r\nmsleep(10);\r\nAT_READ_REG(hw, REG_TWSI_CTRL, &twsi_ctrl_data);\r\nif ((twsi_ctrl_data & TWSI_CTRL_SW_LDSTART) == 0)\r\nbreak;\r\n}\r\nif (i >= AT_TWSI_EEPROM_TIMEOUT)\r\nreturn -1;\r\n}\r\nif ((hw->nic_type == athr_l1c || hw->nic_type == athr_l2c)) {\r\notp_ctrl_data &= ~OTP_CTRL_CLK_EN;\r\nAT_WRITE_REG(hw, REG_OTP_CTRL, otp_ctrl_data);\r\nmsleep(1);\r\n}\r\nif (raise_vol) {\r\natl1c_read_phy_dbg(hw, MIIDBG_ANACTRL, &phy_data);\r\nphy_data |= ANACTRL_HB_EN;\r\natl1c_write_phy_dbg(hw, MIIDBG_ANACTRL, phy_data);\r\natl1c_read_phy_dbg(hw, MIIDBG_VOLT_CTRL, &phy_data);\r\nphy_data &= ~VOLT_CTRL_SWLOWEST;\r\natl1c_write_phy_dbg(hw, MIIDBG_VOLT_CTRL, phy_data);\r\nudelay(20);\r\n}\r\nif (atl1c_read_current_addr(hw, hw->perm_mac_addr))\r\nreturn 0;\r\nreturn -1;\r\n}\r\nbool atl1c_read_eeprom(struct atl1c_hw *hw, u32 offset, u32 *p_value)\r\n{\r\nint i;\r\nbool ret = false;\r\nu32 otp_ctrl_data;\r\nu32 control;\r\nu32 data;\r\nif (offset & 3)\r\nreturn ret;\r\nAT_READ_REG(hw, REG_OTP_CTRL, &otp_ctrl_data);\r\nif (!(otp_ctrl_data & OTP_CTRL_CLK_EN))\r\nAT_WRITE_REG(hw, REG_OTP_CTRL,\r\n(otp_ctrl_data | OTP_CTRL_CLK_EN));\r\nAT_WRITE_REG(hw, REG_EEPROM_DATA_LO, 0);\r\ncontrol = (offset & EEPROM_CTRL_ADDR_MASK) << EEPROM_CTRL_ADDR_SHIFT;\r\nAT_WRITE_REG(hw, REG_EEPROM_CTRL, control);\r\nfor (i = 0; i < 10; i++) {\r\nudelay(100);\r\nAT_READ_REG(hw, REG_EEPROM_CTRL, &control);\r\nif (control & EEPROM_CTRL_RW)\r\nbreak;\r\n}\r\nif (control & EEPROM_CTRL_RW) {\r\nAT_READ_REG(hw, REG_EEPROM_CTRL, &data);\r\nAT_READ_REG(hw, REG_EEPROM_DATA_LO, p_value);\r\ndata = data & 0xFFFF;\r\n*p_value = swab32((data << 16) | (*p_value >> 16));\r\nret = true;\r\n}\r\nif (!(otp_ctrl_data & OTP_CTRL_CLK_EN))\r\nAT_WRITE_REG(hw, REG_OTP_CTRL, otp_ctrl_data);\r\nreturn ret;\r\n}\r\nint atl1c_read_mac_addr(struct atl1c_hw *hw)\r\n{\r\nint err = 0;\r\nerr = atl1c_get_permanent_address(hw);\r\nif (err)\r\neth_random_addr(hw->perm_mac_addr);\r\nmemcpy(hw->mac_addr, hw->perm_mac_addr, sizeof(hw->perm_mac_addr));\r\nreturn err;\r\n}\r\nu32 atl1c_hash_mc_addr(struct atl1c_hw *hw, u8 *mc_addr)\r\n{\r\nu32 crc32;\r\nu32 value = 0;\r\nint i;\r\ncrc32 = ether_crc_le(6, mc_addr);\r\nfor (i = 0; i < 32; i++)\r\nvalue |= (((crc32 >> i) & 1) << (31 - i));\r\nreturn value;\r\n}\r\nvoid atl1c_hash_set(struct atl1c_hw *hw, u32 hash_value)\r\n{\r\nu32 hash_bit, hash_reg;\r\nu32 mta;\r\nhash_reg = (hash_value >> 31) & 0x1;\r\nhash_bit = (hash_value >> 26) & 0x1F;\r\nmta = AT_READ_REG_ARRAY(hw, REG_RX_HASH_TABLE, hash_reg);\r\nmta |= (1 << hash_bit);\r\nAT_WRITE_REG_ARRAY(hw, REG_RX_HASH_TABLE, hash_reg, mta);\r\n}\r\nbool atl1c_wait_mdio_idle(struct atl1c_hw *hw)\r\n{\r\nu32 val;\r\nint i;\r\nfor (i = 0; i < MDIO_MAX_AC_TO; i++) {\r\nAT_READ_REG(hw, REG_MDIO_CTRL, &val);\r\nif (!(val & (MDIO_CTRL_BUSY | MDIO_CTRL_START)))\r\nbreak;\r\nudelay(10);\r\n}\r\nreturn i != MDIO_MAX_AC_TO;\r\n}\r\nvoid atl1c_stop_phy_polling(struct atl1c_hw *hw)\r\n{\r\nif (!(hw->ctrl_flags & ATL1C_FPGA_VERSION))\r\nreturn;\r\nAT_WRITE_REG(hw, REG_MDIO_CTRL, 0);\r\natl1c_wait_mdio_idle(hw);\r\n}\r\nvoid atl1c_start_phy_polling(struct atl1c_hw *hw, u16 clk_sel)\r\n{\r\nu32 val;\r\nif (!(hw->ctrl_flags & ATL1C_FPGA_VERSION))\r\nreturn;\r\nval = MDIO_CTRL_SPRES_PRMBL |\r\nFIELDX(MDIO_CTRL_CLK_SEL, clk_sel) |\r\nFIELDX(MDIO_CTRL_REG, 1) |\r\nMDIO_CTRL_START |\r\nMDIO_CTRL_OP_READ;\r\nAT_WRITE_REG(hw, REG_MDIO_CTRL, val);\r\natl1c_wait_mdio_idle(hw);\r\nval |= MDIO_CTRL_AP_EN;\r\nval &= ~MDIO_CTRL_START;\r\nAT_WRITE_REG(hw, REG_MDIO_CTRL, val);\r\nudelay(30);\r\n}\r\nint atl1c_read_phy_core(struct atl1c_hw *hw, bool ext, u8 dev,\r\nu16 reg, u16 *phy_data)\r\n{\r\nu32 val;\r\nu16 clk_sel = MDIO_CTRL_CLK_25_4;\r\natl1c_stop_phy_polling(hw);\r\n*phy_data = 0;\r\nif ((hw->nic_type == athr_l2c_b2 || hw->nic_type == athr_l1d_2) &&\r\nhw->hibernate)\r\nclk_sel = MDIO_CTRL_CLK_25_128;\r\nif (ext) {\r\nval = FIELDX(MDIO_EXTN_DEVAD, dev) | FIELDX(MDIO_EXTN_REG, reg);\r\nAT_WRITE_REG(hw, REG_MDIO_EXTN, val);\r\nval = MDIO_CTRL_SPRES_PRMBL |\r\nFIELDX(MDIO_CTRL_CLK_SEL, clk_sel) |\r\nMDIO_CTRL_START |\r\nMDIO_CTRL_MODE_EXT |\r\nMDIO_CTRL_OP_READ;\r\n} else {\r\nval = MDIO_CTRL_SPRES_PRMBL |\r\nFIELDX(MDIO_CTRL_CLK_SEL, clk_sel) |\r\nFIELDX(MDIO_CTRL_REG, reg) |\r\nMDIO_CTRL_START |\r\nMDIO_CTRL_OP_READ;\r\n}\r\nAT_WRITE_REG(hw, REG_MDIO_CTRL, val);\r\nif (!atl1c_wait_mdio_idle(hw))\r\nreturn -1;\r\nAT_READ_REG(hw, REG_MDIO_CTRL, &val);\r\n*phy_data = (u16)FIELD_GETX(val, MDIO_CTRL_DATA);\r\natl1c_start_phy_polling(hw, clk_sel);\r\nreturn 0;\r\n}\r\nint atl1c_write_phy_core(struct atl1c_hw *hw, bool ext, u8 dev,\r\nu16 reg, u16 phy_data)\r\n{\r\nu32 val;\r\nu16 clk_sel = MDIO_CTRL_CLK_25_4;\r\natl1c_stop_phy_polling(hw);\r\nif ((hw->nic_type == athr_l2c_b2 || hw->nic_type == athr_l1d_2) &&\r\nhw->hibernate)\r\nclk_sel = MDIO_CTRL_CLK_25_128;\r\nif (ext) {\r\nval = FIELDX(MDIO_EXTN_DEVAD, dev) | FIELDX(MDIO_EXTN_REG, reg);\r\nAT_WRITE_REG(hw, REG_MDIO_EXTN, val);\r\nval = MDIO_CTRL_SPRES_PRMBL |\r\nFIELDX(MDIO_CTRL_CLK_SEL, clk_sel) |\r\nFIELDX(MDIO_CTRL_DATA, phy_data) |\r\nMDIO_CTRL_START |\r\nMDIO_CTRL_MODE_EXT;\r\n} else {\r\nval = MDIO_CTRL_SPRES_PRMBL |\r\nFIELDX(MDIO_CTRL_CLK_SEL, clk_sel) |\r\nFIELDX(MDIO_CTRL_DATA, phy_data) |\r\nFIELDX(MDIO_CTRL_REG, reg) |\r\nMDIO_CTRL_START;\r\n}\r\nAT_WRITE_REG(hw, REG_MDIO_CTRL, val);\r\nif (!atl1c_wait_mdio_idle(hw))\r\nreturn -1;\r\natl1c_start_phy_polling(hw, clk_sel);\r\nreturn 0;\r\n}\r\nint atl1c_read_phy_reg(struct atl1c_hw *hw, u16 reg_addr, u16 *phy_data)\r\n{\r\nreturn atl1c_read_phy_core(hw, false, 0, reg_addr, phy_data);\r\n}\r\nint atl1c_write_phy_reg(struct atl1c_hw *hw, u32 reg_addr, u16 phy_data)\r\n{\r\nreturn atl1c_write_phy_core(hw, false, 0, reg_addr, phy_data);\r\n}\r\nint atl1c_read_phy_ext(struct atl1c_hw *hw, u8 dev_addr,\r\nu16 reg_addr, u16 *phy_data)\r\n{\r\nreturn atl1c_read_phy_core(hw, true, dev_addr, reg_addr, phy_data);\r\n}\r\nint atl1c_write_phy_ext(struct atl1c_hw *hw, u8 dev_addr,\r\nu16 reg_addr, u16 phy_data)\r\n{\r\nreturn atl1c_write_phy_core(hw, true, dev_addr, reg_addr, phy_data);\r\n}\r\nint atl1c_read_phy_dbg(struct atl1c_hw *hw, u16 reg_addr, u16 *phy_data)\r\n{\r\nint err;\r\nerr = atl1c_write_phy_reg(hw, MII_DBG_ADDR, reg_addr);\r\nif (unlikely(err))\r\nreturn err;\r\nelse\r\nerr = atl1c_read_phy_reg(hw, MII_DBG_DATA, phy_data);\r\nreturn err;\r\n}\r\nint atl1c_write_phy_dbg(struct atl1c_hw *hw, u16 reg_addr, u16 phy_data)\r\n{\r\nint err;\r\nerr = atl1c_write_phy_reg(hw, MII_DBG_ADDR, reg_addr);\r\nif (unlikely(err))\r\nreturn err;\r\nelse\r\nerr = atl1c_write_phy_reg(hw, MII_DBG_DATA, phy_data);\r\nreturn err;\r\n}\r\nstatic int atl1c_phy_setup_adv(struct atl1c_hw *hw)\r\n{\r\nu16 mii_adv_data = ADVERTISE_DEFAULT_CAP & ~ADVERTISE_ALL;\r\nu16 mii_giga_ctrl_data = GIGA_CR_1000T_DEFAULT_CAP &\r\n~GIGA_CR_1000T_SPEED_MASK;\r\nif (hw->autoneg_advertised & ADVERTISED_10baseT_Half)\r\nmii_adv_data |= ADVERTISE_10HALF;\r\nif (hw->autoneg_advertised & ADVERTISED_10baseT_Full)\r\nmii_adv_data |= ADVERTISE_10FULL;\r\nif (hw->autoneg_advertised & ADVERTISED_100baseT_Half)\r\nmii_adv_data |= ADVERTISE_100HALF;\r\nif (hw->autoneg_advertised & ADVERTISED_100baseT_Full)\r\nmii_adv_data |= ADVERTISE_100FULL;\r\nif (hw->autoneg_advertised & ADVERTISED_Autoneg)\r\nmii_adv_data |= ADVERTISE_10HALF | ADVERTISE_10FULL |\r\nADVERTISE_100HALF | ADVERTISE_100FULL;\r\nif (hw->link_cap_flags & ATL1C_LINK_CAP_1000M) {\r\nif (hw->autoneg_advertised & ADVERTISED_1000baseT_Half)\r\nmii_giga_ctrl_data |= ADVERTISE_1000HALF;\r\nif (hw->autoneg_advertised & ADVERTISED_1000baseT_Full)\r\nmii_giga_ctrl_data |= ADVERTISE_1000FULL;\r\nif (hw->autoneg_advertised & ADVERTISED_Autoneg)\r\nmii_giga_ctrl_data |= ADVERTISE_1000HALF |\r\nADVERTISE_1000FULL;\r\n}\r\nif (atl1c_write_phy_reg(hw, MII_ADVERTISE, mii_adv_data) != 0 ||\r\natl1c_write_phy_reg(hw, MII_CTRL1000, mii_giga_ctrl_data) != 0)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nvoid atl1c_phy_disable(struct atl1c_hw *hw)\r\n{\r\natl1c_power_saving(hw, 0);\r\n}\r\nint atl1c_phy_reset(struct atl1c_hw *hw)\r\n{\r\nstruct atl1c_adapter *adapter = hw->adapter;\r\nstruct pci_dev *pdev = adapter->pdev;\r\nu16 phy_data;\r\nu32 phy_ctrl_data, lpi_ctrl;\r\nint err;\r\nAT_READ_REG(hw, REG_GPHY_CTRL, &phy_ctrl_data);\r\nphy_ctrl_data &= ~(GPHY_CTRL_EXT_RESET | GPHY_CTRL_PHY_IDDQ |\r\nGPHY_CTRL_GATE_25M_EN | GPHY_CTRL_PWDOWN_HW | GPHY_CTRL_CLS);\r\nphy_ctrl_data |= GPHY_CTRL_SEL_ANA_RST;\r\nif (!(hw->ctrl_flags & ATL1C_HIB_DISABLE))\r\nphy_ctrl_data |= (GPHY_CTRL_HIB_EN | GPHY_CTRL_HIB_PULSE);\r\nelse\r\nphy_ctrl_data &= ~(GPHY_CTRL_HIB_EN | GPHY_CTRL_HIB_PULSE);\r\nAT_WRITE_REG(hw, REG_GPHY_CTRL, phy_ctrl_data);\r\nAT_WRITE_FLUSH(hw);\r\nudelay(10);\r\nAT_WRITE_REG(hw, REG_GPHY_CTRL, phy_ctrl_data | GPHY_CTRL_EXT_RESET);\r\nAT_WRITE_FLUSH(hw);\r\nudelay(10 * GPHY_CTRL_EXT_RST_TO);\r\nif (hw->nic_type == athr_l2c_b) {\r\natl1c_read_phy_dbg(hw, MIIDBG_CFGLPSPD, &phy_data);\r\natl1c_write_phy_dbg(hw, MIIDBG_CFGLPSPD,\r\nphy_data & ~CFGLPSPD_RSTCNT_CLK125SW);\r\n}\r\nif (hw->nic_type == athr_l2c_b || hw->nic_type == athr_l2c_b2) {\r\natl1c_read_phy_dbg(hw, MIIDBG_CABLE1TH_DET, &phy_data);\r\nphy_data |= CABLE1TH_DET_EN;\r\natl1c_write_phy_dbg(hw, MIIDBG_CABLE1TH_DET, phy_data);\r\n}\r\nif (!(hw->ctrl_flags & ATL1C_HIB_DISABLE)) {\r\nif (hw->nic_type == athr_l2c_b || hw->nic_type == athr_l2c_b2) {\r\natl1c_read_phy_dbg(hw, MIIDBG_VOLT_CTRL, &phy_data);\r\nphy_data &= ~VOLT_CTRL_SWLOWEST;\r\natl1c_write_phy_dbg(hw, MIIDBG_VOLT_CTRL, phy_data);\r\n}\r\nphy_data =\r\nhw->nic_type == athr_l1d || hw->nic_type == athr_l1d_2 ?\r\nL1D_LEGCYPS_DEF : L1C_LEGCYPS_DEF;\r\natl1c_write_phy_dbg(hw, MIIDBG_LEGCYPS, phy_data);\r\natl1c_write_phy_dbg(hw, MIIDBG_SYSMODCTRL,\r\nSYSMODCTRL_IECHOADJ_DEF);\r\n} else {\r\natl1c_read_phy_dbg(hw, MIIDBG_LEGCYPS, &phy_data);\r\natl1c_write_phy_dbg(hw, MIIDBG_LEGCYPS,\r\nphy_data & ~LEGCYPS_EN);\r\natl1c_read_phy_dbg(hw, MIIDBG_HIBNEG, &phy_data);\r\natl1c_write_phy_dbg(hw, MIIDBG_HIBNEG,\r\nphy_data & HIBNEG_PSHIB_EN);\r\n}\r\nif (hw->nic_type == athr_l1d || hw->nic_type == athr_l1d_2 ||\r\nhw->nic_type == athr_l2c_b2) {\r\nAT_READ_REG(hw, REG_LPI_CTRL, &lpi_ctrl);\r\nAT_WRITE_REG(hw, REG_LPI_CTRL, lpi_ctrl & ~LPI_CTRL_EN);\r\natl1c_write_phy_ext(hw, MIIEXT_ANEG, MIIEXT_LOCAL_EEEADV, 0);\r\natl1c_write_phy_ext(hw, MIIEXT_PCS, MIIEXT_CLDCTRL3,\r\nL2CB_CLDCTRL3);\r\n}\r\natl1c_write_phy_dbg(hw, MIIDBG_ANACTRL, ANACTRL_DEF);\r\natl1c_write_phy_dbg(hw, MIIDBG_SRDSYSMOD, SRDSYSMOD_DEF);\r\natl1c_write_phy_dbg(hw, MIIDBG_TST10BTCFG, TST10BTCFG_DEF);\r\natl1c_write_phy_dbg(hw, MIIDBG_TST100BTCFG,\r\nTST100BTCFG_DEF | TST100BTCFG_LITCH_EN);\r\nphy_data = IER_LINK_UP | IER_LINK_DOWN;\r\nerr = atl1c_write_phy_reg(hw, MII_IER, phy_data);\r\nif (err) {\r\nif (netif_msg_hw(adapter))\r\ndev_err(&pdev->dev,\r\n"Error enable PHY linkChange Interrupt\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nint atl1c_phy_init(struct atl1c_hw *hw)\r\n{\r\nstruct atl1c_adapter *adapter = hw->adapter;\r\nstruct pci_dev *pdev = adapter->pdev;\r\nint ret_val;\r\nu16 mii_bmcr_data = BMCR_RESET;\r\nif ((atl1c_read_phy_reg(hw, MII_PHYSID1, &hw->phy_id1) != 0) ||\r\n(atl1c_read_phy_reg(hw, MII_PHYSID2, &hw->phy_id2) != 0)) {\r\ndev_err(&pdev->dev, "Error get phy ID\n");\r\nreturn -1;\r\n}\r\nswitch (hw->media_type) {\r\ncase MEDIA_TYPE_AUTO_SENSOR:\r\nret_val = atl1c_phy_setup_adv(hw);\r\nif (ret_val) {\r\nif (netif_msg_link(adapter))\r\ndev_err(&pdev->dev,\r\n"Error Setting up Auto-Negotiation\n");\r\nreturn ret_val;\r\n}\r\nmii_bmcr_data |= BMCR_ANENABLE | BMCR_ANRESTART;\r\nbreak;\r\ncase MEDIA_TYPE_100M_FULL:\r\nmii_bmcr_data |= BMCR_SPEED100 | BMCR_FULLDPLX;\r\nbreak;\r\ncase MEDIA_TYPE_100M_HALF:\r\nmii_bmcr_data |= BMCR_SPEED100;\r\nbreak;\r\ncase MEDIA_TYPE_10M_FULL:\r\nmii_bmcr_data |= BMCR_FULLDPLX;\r\nbreak;\r\ncase MEDIA_TYPE_10M_HALF:\r\nbreak;\r\ndefault:\r\nif (netif_msg_link(adapter))\r\ndev_err(&pdev->dev, "Wrong Media type %d\n",\r\nhw->media_type);\r\nreturn -1;\r\n}\r\nret_val = atl1c_write_phy_reg(hw, MII_BMCR, mii_bmcr_data);\r\nif (ret_val)\r\nreturn ret_val;\r\nhw->phy_configured = true;\r\nreturn 0;\r\n}\r\nint atl1c_get_speed_and_duplex(struct atl1c_hw *hw, u16 *speed, u16 *duplex)\r\n{\r\nint err;\r\nu16 phy_data;\r\nerr = atl1c_read_phy_reg(hw, MII_GIGA_PSSR, &phy_data);\r\nif (err)\r\nreturn err;\r\nif (!(phy_data & GIGA_PSSR_SPD_DPLX_RESOLVED))\r\nreturn -1;\r\nswitch (phy_data & GIGA_PSSR_SPEED) {\r\ncase GIGA_PSSR_1000MBS:\r\n*speed = SPEED_1000;\r\nbreak;\r\ncase GIGA_PSSR_100MBS:\r\n*speed = SPEED_100;\r\nbreak;\r\ncase GIGA_PSSR_10MBS:\r\n*speed = SPEED_10;\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nif (phy_data & GIGA_PSSR_DPLX)\r\n*duplex = FULL_DUPLEX;\r\nelse\r\n*duplex = HALF_DUPLEX;\r\nreturn 0;\r\n}\r\nint atl1c_phy_to_ps_link(struct atl1c_hw *hw)\r\n{\r\nstruct atl1c_adapter *adapter = hw->adapter;\r\nstruct pci_dev *pdev = adapter->pdev;\r\nint ret = 0;\r\nu16 autoneg_advertised = ADVERTISED_10baseT_Half;\r\nu16 save_autoneg_advertised;\r\nu16 phy_data;\r\nu16 mii_lpa_data;\r\nu16 speed = SPEED_0;\r\nu16 duplex = FULL_DUPLEX;\r\nint i;\r\natl1c_read_phy_reg(hw, MII_BMSR, &phy_data);\r\natl1c_read_phy_reg(hw, MII_BMSR, &phy_data);\r\nif (phy_data & BMSR_LSTATUS) {\r\natl1c_read_phy_reg(hw, MII_LPA, &mii_lpa_data);\r\nif (mii_lpa_data & LPA_10FULL)\r\nautoneg_advertised = ADVERTISED_10baseT_Full;\r\nelse if (mii_lpa_data & LPA_10HALF)\r\nautoneg_advertised = ADVERTISED_10baseT_Half;\r\nelse if (mii_lpa_data & LPA_100HALF)\r\nautoneg_advertised = ADVERTISED_100baseT_Half;\r\nelse if (mii_lpa_data & LPA_100FULL)\r\nautoneg_advertised = ADVERTISED_100baseT_Full;\r\nsave_autoneg_advertised = hw->autoneg_advertised;\r\nhw->phy_configured = false;\r\nhw->autoneg_advertised = autoneg_advertised;\r\nif (atl1c_restart_autoneg(hw) != 0) {\r\ndev_dbg(&pdev->dev, "phy autoneg failed\n");\r\nret = -1;\r\n}\r\nhw->autoneg_advertised = save_autoneg_advertised;\r\nif (mii_lpa_data) {\r\nfor (i = 0; i < AT_SUSPEND_LINK_TIMEOUT; i++) {\r\nmdelay(100);\r\natl1c_read_phy_reg(hw, MII_BMSR, &phy_data);\r\natl1c_read_phy_reg(hw, MII_BMSR, &phy_data);\r\nif (phy_data & BMSR_LSTATUS) {\r\nif (atl1c_get_speed_and_duplex(hw, &speed,\r\n&duplex) != 0)\r\ndev_dbg(&pdev->dev,\r\n"get speed and duplex failed\n");\r\nbreak;\r\n}\r\n}\r\n}\r\n} else {\r\nspeed = SPEED_10;\r\nduplex = HALF_DUPLEX;\r\n}\r\nadapter->link_speed = speed;\r\nadapter->link_duplex = duplex;\r\nreturn ret;\r\n}\r\nint atl1c_restart_autoneg(struct atl1c_hw *hw)\r\n{\r\nint err = 0;\r\nu16 mii_bmcr_data = BMCR_RESET;\r\nerr = atl1c_phy_setup_adv(hw);\r\nif (err)\r\nreturn err;\r\nmii_bmcr_data |= BMCR_ANENABLE | BMCR_ANRESTART;\r\nreturn atl1c_write_phy_reg(hw, MII_BMCR, mii_bmcr_data);\r\n}\r\nint atl1c_power_saving(struct atl1c_hw *hw, u32 wufc)\r\n{\r\nstruct atl1c_adapter *adapter = hw->adapter;\r\nstruct pci_dev *pdev = adapter->pdev;\r\nu32 master_ctrl, mac_ctrl, phy_ctrl;\r\nu32 wol_ctrl, speed;\r\nu16 phy_data;\r\nwol_ctrl = 0;\r\nspeed = adapter->link_speed == SPEED_1000 ?\r\nMAC_CTRL_SPEED_1000 : MAC_CTRL_SPEED_10_100;\r\nAT_READ_REG(hw, REG_MASTER_CTRL, &master_ctrl);\r\nAT_READ_REG(hw, REG_MAC_CTRL, &mac_ctrl);\r\nAT_READ_REG(hw, REG_GPHY_CTRL, &phy_ctrl);\r\nmaster_ctrl &= ~MASTER_CTRL_CLK_SEL_DIS;\r\nmac_ctrl = FIELD_SETX(mac_ctrl, MAC_CTRL_SPEED, speed);\r\nmac_ctrl &= ~(MAC_CTRL_DUPLX | MAC_CTRL_RX_EN | MAC_CTRL_TX_EN);\r\nif (adapter->link_duplex == FULL_DUPLEX)\r\nmac_ctrl |= MAC_CTRL_DUPLX;\r\nphy_ctrl &= ~(GPHY_CTRL_EXT_RESET | GPHY_CTRL_CLS);\r\nphy_ctrl |= GPHY_CTRL_SEL_ANA_RST | GPHY_CTRL_HIB_PULSE |\r\nGPHY_CTRL_HIB_EN;\r\nif (!wufc) {\r\nmaster_ctrl |= MASTER_CTRL_CLK_SEL_DIS;\r\nphy_ctrl |= GPHY_CTRL_PHY_IDDQ | GPHY_CTRL_PWDOWN_HW;\r\nAT_WRITE_REG(hw, REG_MASTER_CTRL, master_ctrl);\r\nAT_WRITE_REG(hw, REG_MAC_CTRL, mac_ctrl);\r\nAT_WRITE_REG(hw, REG_GPHY_CTRL, phy_ctrl);\r\nAT_WRITE_REG(hw, REG_WOL_CTRL, 0);\r\nhw->phy_configured = false;\r\nreturn 0;\r\n}\r\nphy_ctrl |= GPHY_CTRL_EXT_RESET;\r\nif (wufc & AT_WUFC_MAG) {\r\nmac_ctrl |= MAC_CTRL_RX_EN | MAC_CTRL_BC_EN;\r\nwol_ctrl |= WOL_MAGIC_EN | WOL_MAGIC_PME_EN;\r\nif (hw->nic_type == athr_l2c_b && hw->revision_id == L2CB_V11)\r\nwol_ctrl |= WOL_PATTERN_EN | WOL_PATTERN_PME_EN;\r\n}\r\nif (wufc & AT_WUFC_LNKC) {\r\nwol_ctrl |= WOL_LINK_CHG_EN | WOL_LINK_CHG_PME_EN;\r\nif (atl1c_write_phy_reg(hw, MII_IER, IER_LINK_UP) != 0) {\r\ndev_dbg(&pdev->dev, "%s: write phy MII_IER failed.\n",\r\natl1c_driver_name);\r\n}\r\n}\r\natl1c_read_phy_reg(hw, MII_ISR, &phy_data);\r\ndev_dbg(&pdev->dev, "%s: suspend MAC=%x,MASTER=%x,PHY=0x%x,WOL=%x\n",\r\natl1c_driver_name, mac_ctrl, master_ctrl, phy_ctrl, wol_ctrl);\r\nAT_WRITE_REG(hw, REG_MASTER_CTRL, master_ctrl);\r\nAT_WRITE_REG(hw, REG_MAC_CTRL, mac_ctrl);\r\nAT_WRITE_REG(hw, REG_GPHY_CTRL, phy_ctrl);\r\nAT_WRITE_REG(hw, REG_WOL_CTRL, wol_ctrl);\r\nreturn 0;\r\n}\r\nvoid atl1c_post_phy_linkchg(struct atl1c_hw *hw, u16 link_speed)\r\n{\r\nu16 phy_val;\r\nbool adj_thresh = false;\r\nif (hw->nic_type == athr_l2c_b || hw->nic_type == athr_l2c_b2 ||\r\nhw->nic_type == athr_l1d || hw->nic_type == athr_l1d_2)\r\nadj_thresh = true;\r\nif (link_speed != SPEED_0) {\r\nif (hw->nic_type == athr_l1d_2) {\r\natl1c_read_phy_ext(hw, MIIEXT_PCS, MIIEXT_CLDCTRL6,\r\n&phy_val);\r\nphy_val = FIELD_GETX(phy_val, CLDCTRL6_CAB_LEN);\r\nphy_val = phy_val > CLDCTRL6_CAB_LEN_SHORT ?\r\nAZ_ANADECT_LONG : AZ_ANADECT_DEF;\r\natl1c_write_phy_dbg(hw, MIIDBG_AZ_ANADECT, phy_val);\r\n}\r\nif (adj_thresh && link_speed == SPEED_100 && hw->msi_lnkpatch) {\r\natl1c_write_phy_dbg(hw, MIIDBG_MSE16DB, L1D_MSE16DB_UP);\r\natl1c_write_phy_dbg(hw, MIIDBG_SYSMODCTRL,\r\nL1D_SYSMODCTRL_IECHOADJ_DEF);\r\n}\r\n} else {\r\nif (adj_thresh && hw->msi_lnkpatch) {\r\natl1c_write_phy_dbg(hw, MIIDBG_SYSMODCTRL,\r\nSYSMODCTRL_IECHOADJ_DEF);\r\natl1c_write_phy_dbg(hw, MIIDBG_MSE16DB,\r\nL1D_MSE16DB_DOWN);\r\n}\r\n}\r\n}

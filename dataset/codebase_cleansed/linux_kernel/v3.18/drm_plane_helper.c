static int get_connectors_for_crtc(struct drm_crtc *crtc,\r\nstruct drm_connector **connector_list,\r\nint num_connectors)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct drm_connector *connector;\r\nint count = 0;\r\nWARN_ON(!drm_modeset_is_locked(&dev->mode_config.connection_mutex));\r\nlist_for_each_entry(connector, &dev->mode_config.connector_list, head)\r\nif (connector->encoder && connector->encoder->crtc == crtc) {\r\nif (connector_list != NULL && count < num_connectors)\r\n*(connector_list++) = connector;\r\ncount++;\r\n}\r\nreturn count;\r\n}\r\nint drm_plane_helper_check_update(struct drm_plane *plane,\r\nstruct drm_crtc *crtc,\r\nstruct drm_framebuffer *fb,\r\nstruct drm_rect *src,\r\nstruct drm_rect *dest,\r\nconst struct drm_rect *clip,\r\nint min_scale,\r\nint max_scale,\r\nbool can_position,\r\nbool can_update_disabled,\r\nbool *visible)\r\n{\r\nint hscale, vscale;\r\nif (!crtc->enabled && !can_update_disabled) {\r\nDRM_DEBUG_KMS("Cannot update plane of a disabled CRTC.\n");\r\nreturn -EINVAL;\r\n}\r\nhscale = drm_rect_calc_hscale(src, dest, min_scale, max_scale);\r\nvscale = drm_rect_calc_vscale(src, dest, min_scale, max_scale);\r\nif (hscale < 0 || vscale < 0) {\r\nDRM_DEBUG_KMS("Invalid scaling of plane\n");\r\nreturn -ERANGE;\r\n}\r\n*visible = drm_rect_clip_scaled(src, dest, clip, hscale, vscale);\r\nif (!*visible)\r\nreturn 0;\r\nif (!can_position && !drm_rect_equals(dest, clip)) {\r\nDRM_DEBUG_KMS("Plane must cover entire CRTC\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint drm_primary_helper_update(struct drm_plane *plane, struct drm_crtc *crtc,\r\nstruct drm_framebuffer *fb,\r\nint crtc_x, int crtc_y,\r\nunsigned int crtc_w, unsigned int crtc_h,\r\nuint32_t src_x, uint32_t src_y,\r\nuint32_t src_w, uint32_t src_h)\r\n{\r\nstruct drm_mode_set set = {\r\n.crtc = crtc,\r\n.fb = fb,\r\n.mode = &crtc->mode,\r\n.x = src_x >> 16,\r\n.y = src_y >> 16,\r\n};\r\nstruct drm_rect src = {\r\n.x1 = src_x,\r\n.y1 = src_y,\r\n.x2 = src_x + src_w,\r\n.y2 = src_y + src_h,\r\n};\r\nstruct drm_rect dest = {\r\n.x1 = crtc_x,\r\n.y1 = crtc_y,\r\n.x2 = crtc_x + crtc_w,\r\n.y2 = crtc_y + crtc_h,\r\n};\r\nconst struct drm_rect clip = {\r\n.x2 = crtc->mode.hdisplay,\r\n.y2 = crtc->mode.vdisplay,\r\n};\r\nstruct drm_connector **connector_list;\r\nint num_connectors, ret;\r\nbool visible;\r\nret = drm_plane_helper_check_update(plane, crtc, fb,\r\n&src, &dest, &clip,\r\nDRM_PLANE_HELPER_NO_SCALING,\r\nDRM_PLANE_HELPER_NO_SCALING,\r\nfalse, false, &visible);\r\nif (ret)\r\nreturn ret;\r\nif (!visible)\r\nreturn plane->funcs->disable_plane(plane);\r\nnum_connectors = get_connectors_for_crtc(crtc, NULL, 0);\r\nBUG_ON(num_connectors == 0);\r\nconnector_list = kzalloc(num_connectors * sizeof(*connector_list),\r\nGFP_KERNEL);\r\nif (!connector_list)\r\nreturn -ENOMEM;\r\nget_connectors_for_crtc(crtc, connector_list, num_connectors);\r\nset.connectors = connector_list;\r\nset.num_connectors = num_connectors;\r\nret = crtc->funcs->set_config(&set);\r\nkfree(connector_list);\r\nreturn ret;\r\n}\r\nint drm_primary_helper_disable(struct drm_plane *plane)\r\n{\r\nreturn -EINVAL;\r\n}\r\nvoid drm_primary_helper_destroy(struct drm_plane *plane)\r\n{\r\ndrm_plane_cleanup(plane);\r\nkfree(plane);\r\n}\r\nstruct drm_plane *drm_primary_helper_create_plane(struct drm_device *dev,\r\nconst uint32_t *formats,\r\nint num_formats)\r\n{\r\nstruct drm_plane *primary;\r\nint ret;\r\nprimary = kzalloc(sizeof(*primary), GFP_KERNEL);\r\nif (primary == NULL) {\r\nDRM_DEBUG_KMS("Failed to allocate primary plane\n");\r\nreturn NULL;\r\n}\r\nif (formats == NULL) {\r\nformats = safe_modeset_formats;\r\nnum_formats = ARRAY_SIZE(safe_modeset_formats);\r\n}\r\nret = drm_universal_plane_init(dev, primary, 0,\r\n&drm_primary_helper_funcs,\r\nformats, num_formats,\r\nDRM_PLANE_TYPE_PRIMARY);\r\nif (ret) {\r\nkfree(primary);\r\nprimary = NULL;\r\n}\r\nreturn primary;\r\n}\r\nint drm_crtc_init(struct drm_device *dev, struct drm_crtc *crtc,\r\nconst struct drm_crtc_funcs *funcs)\r\n{\r\nstruct drm_plane *primary;\r\nprimary = drm_primary_helper_create_plane(dev, NULL, 0);\r\nreturn drm_crtc_init_with_planes(dev, crtc, primary, NULL, funcs);\r\n}

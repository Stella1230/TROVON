static void vexpress_reset_do(struct device *dev, const char *what)\r\n{\r\nint err = -ENOENT;\r\nstruct regmap *reg = dev_get_drvdata(dev);\r\nif (reg) {\r\nerr = regmap_write(reg, 0, 0);\r\nif (!err)\r\nmdelay(1000);\r\n}\r\ndev_emerg(dev, "Unable to %s (%d)\n", what, err);\r\n}\r\nstatic void vexpress_power_off(void)\r\n{\r\nvexpress_reset_do(vexpress_power_off_device, "power off");\r\n}\r\nstatic void vexpress_restart(enum reboot_mode reboot_mode, const char *cmd)\r\n{\r\nvexpress_reset_do(vexpress_restart_device, "restart");\r\n}\r\nstatic ssize_t vexpress_reset_active_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", vexpress_restart_device == dev);\r\n}\r\nstatic ssize_t vexpress_reset_active_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nlong value;\r\nint err = kstrtol(buf, 0, &value);\r\nif (!err && value)\r\nvexpress_restart_device = dev;\r\nreturn err ? err : count;\r\n}\r\nstatic int vexpress_reset_probe(struct platform_device *pdev)\r\n{\r\nenum vexpress_reset_func func;\r\nconst struct of_device_id *match =\r\nof_match_device(vexpress_reset_of_match, &pdev->dev);\r\nstruct regmap *regmap;\r\nif (match)\r\nfunc = (enum vexpress_reset_func)match->data;\r\nelse\r\nfunc = pdev->id_entry->driver_data;\r\nregmap = devm_regmap_init_vexpress_config(&pdev->dev);\r\nif (IS_ERR(regmap))\r\nreturn PTR_ERR(regmap);\r\ndev_set_drvdata(&pdev->dev, regmap);\r\nswitch (func) {\r\ncase FUNC_SHUTDOWN:\r\nvexpress_power_off_device = &pdev->dev;\r\npm_power_off = vexpress_power_off;\r\nbreak;\r\ncase FUNC_RESET:\r\nif (!vexpress_restart_device)\r\nvexpress_restart_device = &pdev->dev;\r\narm_pm_restart = vexpress_restart;\r\ndevice_create_file(&pdev->dev, &dev_attr_active);\r\nbreak;\r\ncase FUNC_REBOOT:\r\nvexpress_restart_device = &pdev->dev;\r\narm_pm_restart = vexpress_restart;\r\ndevice_create_file(&pdev->dev, &dev_attr_active);\r\nbreak;\r\n};\r\nreturn 0;\r\n}\r\nstatic int __init vexpress_reset_init(void)\r\n{\r\nreturn platform_driver_register(&vexpress_reset_driver);\r\n}

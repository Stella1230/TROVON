bool __pure glob_match(char const *pat, char const *str)\r\n{\r\nchar const *back_pat = NULL, *back_str = back_str;\r\nfor (;;) {\r\nunsigned char c = *str++;\r\nunsigned char d = *pat++;\r\nswitch (d) {\r\ncase '?':\r\nif (c == '\0')\r\nreturn false;\r\nbreak;\r\ncase '*':\r\nif (*pat == '\0')\r\nreturn true;\r\nback_pat = pat;\r\nback_str = --str;\r\nbreak;\r\ncase '[': {\r\nbool match = false, inverted = (*pat == '!');\r\nchar const *class = pat + inverted;\r\nunsigned char a = *class++;\r\ndo {\r\nunsigned char b = a;\r\nif (a == '\0')\r\ngoto literal;\r\nif (class[0] == '-' && class[1] != ']') {\r\nb = class[1];\r\nif (b == '\0')\r\ngoto literal;\r\nclass += 2;\r\n}\r\nmatch |= (a <= c && c <= b);\r\n} while ((a = *class++) != ']');\r\nif (match == inverted)\r\ngoto backtrack;\r\npat = class;\r\n}\r\nbreak;\r\ncase '\\':\r\nd = *pat++;\r\ndefault:\r\nliteral:\r\nif (c == d) {\r\nif (d == '\0')\r\nreturn true;\r\nbreak;\r\n}\r\nbacktrack:\r\nif (c == '\0' || !back_pat)\r\nreturn false;\r\npat = back_pat;\r\nstr = ++back_str;\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic bool __pure __init test(char const *pat, char const *str, bool expected)\r\n{\r\nbool match = glob_match(pat, str);\r\nbool success = match == expected;\r\nstatic char const msg_error[] __initconst =\r\nKERN_ERR "glob: \"%s\" vs. \"%s\": %s *** ERROR ***\n";\r\nstatic char const msg_ok[] __initconst =\r\nKERN_DEBUG "glob: \"%s\" vs. \"%s\": %s OK\n";\r\nstatic char const mismatch[] __initconst = "mismatch";\r\nchar const *message;\r\nif (!success)\r\nmessage = msg_error;\r\nelse if (verbose)\r\nmessage = msg_ok;\r\nelse\r\nreturn success;\r\nprintk(message, pat, str, mismatch + 3*match);\r\nreturn success;\r\n}\r\nstatic int __init glob_init(void)\r\n{\r\nunsigned successes = 0;\r\nunsigned n = 0;\r\nchar const *p = glob_tests;\r\nstatic char const message[] __initconst =\r\nKERN_INFO "glob: %u self-tests passed, %u failed\n";\r\nwhile (*p) {\r\nbool expected = *p++ & 1;\r\nchar const *pat = p;\r\np += strlen(p) + 1;\r\nsuccesses += test(pat, p, expected);\r\np += strlen(p) + 1;\r\nn++;\r\n}\r\nn -= successes;\r\nprintk(message, successes, n);\r\nreturn n ? -ECANCELED : 0;\r\n}\r\nstatic void __exit glob_fini(void) { }

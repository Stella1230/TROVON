static void *nlm_dma_alloc_coherent(struct device *dev, size_t size,\r\ndma_addr_t *dma_handle, gfp_t gfp, struct dma_attrs *attrs)\r\n{\r\nvoid *ret;\r\nif (dma_alloc_from_coherent(dev, size, dma_handle, &ret))\r\nreturn ret;\r\ngfp &= ~(__GFP_DMA | __GFP_DMA32 | __GFP_HIGHMEM);\r\n#ifdef CONFIG_ZONE_DMA32\r\nif (dev->coherent_dma_mask <= DMA_BIT_MASK(32))\r\ngfp |= __GFP_DMA32;\r\n#endif\r\ngfp |= __GFP_NORETRY;\r\nreturn swiotlb_alloc_coherent(dev, size, dma_handle, gfp);\r\n}\r\nstatic void nlm_dma_free_coherent(struct device *dev, size_t size,\r\nvoid *vaddr, dma_addr_t dma_handle, struct dma_attrs *attrs)\r\n{\r\nint order = get_order(size);\r\nif (dma_release_from_coherent(dev, order, vaddr))\r\nreturn;\r\nswiotlb_free_coherent(dev, size, vaddr, dma_handle);\r\n}\r\nvoid __init plat_swiotlb_setup(void)\r\n{\r\nsize_t swiotlbsize;\r\nunsigned long swiotlb_nslabs;\r\nswiotlbsize = 1 << 20;\r\nswiotlb_nslabs = swiotlbsize >> IO_TLB_SHIFT;\r\nswiotlb_nslabs = ALIGN(swiotlb_nslabs, IO_TLB_SEGSIZE);\r\nswiotlbsize = swiotlb_nslabs << IO_TLB_SHIFT;\r\nnlm_swiotlb = alloc_bootmem_low_pages(swiotlbsize);\r\nswiotlb_init_with_tbl(nlm_swiotlb, swiotlb_nslabs, 1);\r\n}

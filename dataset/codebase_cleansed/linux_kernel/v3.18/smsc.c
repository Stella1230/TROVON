static int smsc_phy_config_intr(struct phy_device *phydev)\r\n{\r\nint rc = phy_write (phydev, MII_LAN83C185_IM,\r\n((PHY_INTERRUPT_ENABLED == phydev->interrupts)\r\n? MII_LAN83C185_ISF_INT_PHYLIB_EVENTS\r\n: 0));\r\nreturn rc < 0 ? rc : 0;\r\n}\r\nstatic int smsc_phy_ack_interrupt(struct phy_device *phydev)\r\n{\r\nint rc = phy_read (phydev, MII_LAN83C185_ISF);\r\nreturn rc < 0 ? rc : 0;\r\n}\r\nstatic int smsc_phy_config_init(struct phy_device *phydev)\r\n{\r\nint rc = phy_read(phydev, MII_LAN83C185_CTRL_STATUS);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = phy_write(phydev, MII_LAN83C185_CTRL_STATUS,\r\nrc | MII_LAN83C185_EDPWRDOWN);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn smsc_phy_ack_interrupt(phydev);\r\n}\r\nstatic int smsc_phy_reset(struct phy_device *phydev)\r\n{\r\nint rc = phy_read(phydev, MII_LAN83C185_SPECIAL_MODES);\r\nif (rc < 0)\r\nreturn rc;\r\nif ((rc & MII_LAN83C185_MODE_MASK) == MII_LAN83C185_MODE_POWERDOWN) {\r\nint timeout = 50000;\r\nrc |= MII_LAN83C185_MODE_ALL;\r\nphy_write(phydev, MII_LAN83C185_SPECIAL_MODES, rc);\r\nphy_write(phydev, MII_BMCR, BMCR_RESET);\r\ndo {\r\nudelay(10);\r\nif (timeout-- == 0)\r\nreturn -1;\r\nrc = phy_read(phydev, MII_BMCR);\r\n} while (rc & BMCR_RESET);\r\n}\r\nreturn 0;\r\n}\r\nstatic int lan911x_config_init(struct phy_device *phydev)\r\n{\r\nreturn smsc_phy_ack_interrupt(phydev);\r\n}\r\nstatic int lan87xx_read_status(struct phy_device *phydev)\r\n{\r\nint err = genphy_read_status(phydev);\r\nif (!phydev->link) {\r\nint rc = phy_read(phydev, MII_LAN83C185_CTRL_STATUS);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = phy_write(phydev, MII_LAN83C185_CTRL_STATUS,\r\nrc & ~MII_LAN83C185_EDPWRDOWN);\r\nif (rc < 0)\r\nreturn rc;\r\nmsleep(64);\r\nrc = phy_read(phydev, MII_LAN83C185_CTRL_STATUS);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = phy_write(phydev, MII_LAN83C185_CTRL_STATUS,\r\nrc | MII_LAN83C185_EDPWRDOWN);\r\nif (rc < 0)\r\nreturn rc;\r\n}\r\nreturn err;\r\n}\r\nstatic int __init smsc_init(void)\r\n{\r\nreturn phy_drivers_register(smsc_phy_driver,\r\nARRAY_SIZE(smsc_phy_driver));\r\n}\r\nstatic void __exit smsc_exit(void)\r\n{\r\nphy_drivers_unregister(smsc_phy_driver, ARRAY_SIZE(smsc_phy_driver));\r\n}

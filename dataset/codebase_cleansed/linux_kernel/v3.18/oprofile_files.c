static ssize_t timeout_read(struct file *file, char __user *buf,\r\nsize_t count, loff_t *offset)\r\n{\r\nreturn oprofilefs_ulong_to_user(jiffies_to_msecs(oprofile_time_slice),\r\nbuf, count, offset);\r\n}\r\nstatic ssize_t timeout_write(struct file *file, char const __user *buf,\r\nsize_t count, loff_t *offset)\r\n{\r\nunsigned long val;\r\nint retval;\r\nif (*offset)\r\nreturn -EINVAL;\r\nretval = oprofilefs_ulong_from_user(&val, buf, count);\r\nif (retval <= 0)\r\nreturn retval;\r\nretval = oprofile_set_timeout(val);\r\nif (retval)\r\nreturn retval;\r\nreturn count;\r\n}\r\nstatic ssize_t depth_read(struct file *file, char __user *buf, size_t count, loff_t *offset)\r\n{\r\nreturn oprofilefs_ulong_to_user(oprofile_backtrace_depth, buf, count,\r\noffset);\r\n}\r\nstatic ssize_t depth_write(struct file *file, char const __user *buf, size_t count, loff_t *offset)\r\n{\r\nunsigned long val;\r\nint retval;\r\nif (*offset)\r\nreturn -EINVAL;\r\nif (!oprofile_ops.backtrace)\r\nreturn -EINVAL;\r\nretval = oprofilefs_ulong_from_user(&val, buf, count);\r\nif (retval <= 0)\r\nreturn retval;\r\nretval = oprofile_set_ulong(&oprofile_backtrace_depth, val);\r\nif (retval)\r\nreturn retval;\r\nreturn count;\r\n}\r\nstatic ssize_t pointer_size_read(struct file *file, char __user *buf, size_t count, loff_t *offset)\r\n{\r\nreturn oprofilefs_ulong_to_user(sizeof(void *), buf, count, offset);\r\n}\r\nstatic ssize_t cpu_type_read(struct file *file, char __user *buf, size_t count, loff_t *offset)\r\n{\r\nreturn oprofilefs_str_to_user(oprofile_ops.cpu_type, buf, count, offset);\r\n}\r\nstatic ssize_t enable_read(struct file *file, char __user *buf, size_t count, loff_t *offset)\r\n{\r\nreturn oprofilefs_ulong_to_user(oprofile_started, buf, count, offset);\r\n}\r\nstatic ssize_t enable_write(struct file *file, char const __user *buf, size_t count, loff_t *offset)\r\n{\r\nunsigned long val;\r\nint retval;\r\nif (*offset)\r\nreturn -EINVAL;\r\nretval = oprofilefs_ulong_from_user(&val, buf, count);\r\nif (retval <= 0)\r\nreturn retval;\r\nretval = 0;\r\nif (val)\r\nretval = oprofile_start();\r\nelse\r\noprofile_stop();\r\nif (retval)\r\nreturn retval;\r\nreturn count;\r\n}\r\nstatic ssize_t dump_write(struct file *file, char const __user *buf, size_t count, loff_t *offset)\r\n{\r\nwake_up_buffer_waiter();\r\nreturn count;\r\n}\r\nvoid oprofile_create_files(struct dentry *root)\r\n{\r\noprofile_buffer_size = BUFFER_SIZE_DEFAULT;\r\noprofile_cpu_buffer_size = CPU_BUFFER_SIZE_DEFAULT;\r\noprofile_buffer_watershed = BUFFER_WATERSHED_DEFAULT;\r\noprofile_time_slice = msecs_to_jiffies(TIME_SLICE_DEFAULT);\r\noprofilefs_create_file(root, "enable", &enable_fops);\r\noprofilefs_create_file_perm(root, "dump", &dump_fops, 0666);\r\noprofilefs_create_file(root, "buffer", &event_buffer_fops);\r\noprofilefs_create_ulong(root, "buffer_size", &oprofile_buffer_size);\r\noprofilefs_create_ulong(root, "buffer_watershed", &oprofile_buffer_watershed);\r\noprofilefs_create_ulong(root, "cpu_buffer_size", &oprofile_cpu_buffer_size);\r\noprofilefs_create_file(root, "cpu_type", &cpu_type_fops);\r\noprofilefs_create_file(root, "backtrace_depth", &depth_fops);\r\noprofilefs_create_file(root, "pointer_size", &pointer_size_fops);\r\n#ifdef CONFIG_OPROFILE_EVENT_MULTIPLEX\r\noprofilefs_create_file(root, "time_slice", &timeout_fops);\r\n#endif\r\noprofile_create_stats_files(root);\r\nif (oprofile_ops.create_files)\r\noprofile_ops.create_files(root);\r\n}

static int hippi_header(struct sk_buff *skb, struct net_device *dev,\r\nunsigned short type,\r\nconst void *daddr, const void *saddr, unsigned int len)\r\n{\r\nstruct hippi_hdr *hip = (struct hippi_hdr *)skb_push(skb, HIPPI_HLEN);\r\nstruct hippi_cb *hcb = (struct hippi_cb *) skb->cb;\r\nif (!len){\r\nlen = skb->len - HIPPI_HLEN;\r\nprintk("hippi_header(): length not supplied\n");\r\n}\r\nhip->fp.fixed = htonl(0x04800018);\r\nhip->fp.d2_size = htonl(len + 8);\r\nhip->le.fc = 0;\r\nhip->le.double_wide = 0;\r\nhip->le.message_type = 0;\r\nhip->le.dest_addr_type = 2;\r\nhip->le.src_addr_type = 2;\r\nmemcpy(hip->le.src_switch_addr, dev->dev_addr + 3, 3);\r\nmemset(&hip->le.reserved, 0, 16);\r\nhip->snap.dsap = HIPPI_EXTENDED_SAP;\r\nhip->snap.ssap = HIPPI_EXTENDED_SAP;\r\nhip->snap.ctrl = HIPPI_UI_CMD;\r\nhip->snap.oui[0] = 0x00;\r\nhip->snap.oui[1] = 0x00;\r\nhip->snap.oui[2] = 0x00;\r\nhip->snap.ethertype = htons(type);\r\nif (daddr)\r\n{\r\nmemcpy(hip->le.dest_switch_addr, daddr + 3, 3);\r\nmemcpy(&hcb->ifield, daddr + 2, 4);\r\nreturn HIPPI_HLEN;\r\n}\r\nhcb->ifield = 0;\r\nreturn -((int)HIPPI_HLEN);\r\n}\r\nstatic int hippi_rebuild_header(struct sk_buff *skb)\r\n{\r\nstruct hippi_hdr *hip = (struct hippi_hdr *)skb->data;\r\nif(hip->snap.ethertype != htons(ETH_P_IP))\r\n{\r\nprintk(KERN_DEBUG "%s: unable to resolve type %X addresses.\n",skb->dev->name,ntohs(hip->snap.ethertype));\r\nreturn 0;\r\n}\r\nreturn arp_find(hip->le.daddr, skb);\r\n}\r\n__be16 hippi_type_trans(struct sk_buff *skb, struct net_device *dev)\r\n{\r\nstruct hippi_hdr *hip;\r\nskb->dev = dev;\r\nskb_reset_mac_header(skb);\r\nhip = (struct hippi_hdr *)skb_mac_header(skb);\r\nskb_pull(skb, HIPPI_HLEN);\r\nreturn hip->snap.ethertype;\r\n}\r\nint hippi_change_mtu(struct net_device *dev, int new_mtu)\r\n{\r\nif ((new_mtu < 68) || (new_mtu > 65280))\r\nreturn -EINVAL;\r\ndev->mtu = new_mtu;\r\nreturn 0;\r\n}\r\nint hippi_mac_addr(struct net_device *dev, void *p)\r\n{\r\nstruct sockaddr *addr = p;\r\nif (netif_running(dev))\r\nreturn -EBUSY;\r\nmemcpy(dev->dev_addr, addr->sa_data, dev->addr_len);\r\nreturn 0;\r\n}\r\nint hippi_neigh_setup_dev(struct net_device *dev, struct neigh_parms *p)\r\n{\r\nNEIGH_VAR_INIT(p, MCAST_PROBES, 0);\r\nif (p->tbl->family != AF_INET6)\r\nNEIGH_VAR_INIT(p, UCAST_PROBES, 0);\r\nreturn 0;\r\n}\r\nstatic void hippi_setup(struct net_device *dev)\r\n{\r\ndev->header_ops = &hippi_header_ops;\r\ndev->type = ARPHRD_HIPPI;\r\ndev->hard_header_len = HIPPI_HLEN;\r\ndev->mtu = 65280;\r\ndev->addr_len = HIPPI_ALEN;\r\ndev->tx_queue_len = 25 ;\r\nmemset(dev->broadcast, 0xFF, HIPPI_ALEN);\r\ndev->flags = 0;\r\n}\r\nstruct net_device *alloc_hippi_dev(int sizeof_priv)\r\n{\r\nreturn alloc_netdev(sizeof_priv, "hip%d", NET_NAME_UNKNOWN,\r\nhippi_setup);\r\n}

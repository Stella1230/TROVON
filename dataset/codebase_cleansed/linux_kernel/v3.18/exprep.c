static u32\r\nacpi_ex_generate_access(u32 field_bit_offset,\r\nu32 field_bit_length, u32 region_length)\r\n{\r\nu32 field_byte_length;\r\nu32 field_byte_offset;\r\nu32 field_byte_end_offset;\r\nu32 access_byte_width;\r\nu32 field_start_offset;\r\nu32 field_end_offset;\r\nu32 minimum_access_width = 0xFFFFFFFF;\r\nu32 minimum_accesses = 0xFFFFFFFF;\r\nu32 accesses;\r\nACPI_FUNCTION_TRACE(ex_generate_access);\r\nfield_byte_offset = ACPI_DIV_8(ACPI_ROUND_DOWN(field_bit_offset, 8));\r\nfield_byte_end_offset = ACPI_DIV_8(ACPI_ROUND_UP(field_bit_length +\r\nfield_bit_offset, 8));\r\nfield_byte_length = field_byte_end_offset - field_byte_offset;\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"Bit length %u, Bit offset %u\n",\r\nfield_bit_length, field_bit_offset));\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"Byte Length %u, Byte Offset %u, End Offset %u\n",\r\nfield_byte_length, field_byte_offset,\r\nfield_byte_end_offset));\r\nfor (access_byte_width = 1; access_byte_width <= 8;\r\naccess_byte_width <<= 1) {\r\nif (ACPI_ROUND_UP(field_byte_end_offset, access_byte_width) <=\r\nregion_length) {\r\nfield_start_offset =\r\nACPI_ROUND_DOWN(field_byte_offset,\r\naccess_byte_width) /\r\naccess_byte_width;\r\nfield_end_offset =\r\nACPI_ROUND_UP((field_byte_length +\r\nfield_byte_offset),\r\naccess_byte_width) /\r\naccess_byte_width;\r\naccesses = field_end_offset - field_start_offset;\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"AccessWidth %u end is within region\n",\r\naccess_byte_width));\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"Field Start %u, Field End %u -- requires %u accesses\n",\r\nfield_start_offset, field_end_offset,\r\naccesses));\r\nif (accesses <= 1) {\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"Entire field can be accessed with one operation of size %u\n",\r\naccess_byte_width));\r\nreturn_VALUE(access_byte_width);\r\n}\r\nif (accesses < minimum_accesses) {\r\nminimum_accesses = accesses;\r\nminimum_access_width = access_byte_width;\r\n}\r\n} else {\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"AccessWidth %u end is NOT within region\n",\r\naccess_byte_width));\r\nif (access_byte_width == 1) {\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"Field goes beyond end-of-region!\n"));\r\nreturn_VALUE(0);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"Backing off to previous optimal access width of %u\n",\r\nminimum_access_width));\r\nreturn_VALUE(minimum_access_width);\r\n}\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"Cannot access field in one operation, using width 8\n"));\r\nreturn_VALUE(8);\r\n}\r\nstatic u32\r\nacpi_ex_decode_field_access(union acpi_operand_object *obj_desc,\r\nu8 field_flags, u32 * return_byte_alignment)\r\n{\r\nu32 access;\r\nu32 byte_alignment;\r\nu32 bit_length;\r\nACPI_FUNCTION_TRACE(ex_decode_field_access);\r\naccess = (field_flags & AML_FIELD_ACCESS_TYPE_MASK);\r\nswitch (access) {\r\ncase AML_FIELD_ACCESS_ANY:\r\n#ifdef ACPI_UNDER_DEVELOPMENT\r\nbyte_alignment =\r\nacpi_ex_generate_access(obj_desc->common_field.\r\nstart_field_bit_offset,\r\nobj_desc->common_field.bit_length,\r\n0xFFFFFFFF\r\n);\r\nbit_length = byte_alignment * 8;\r\n#endif\r\nbyte_alignment = 1;\r\nbit_length = 8;\r\nbreak;\r\ncase AML_FIELD_ACCESS_BYTE:\r\ncase AML_FIELD_ACCESS_BUFFER:\r\nbyte_alignment = 1;\r\nbit_length = 8;\r\nbreak;\r\ncase AML_FIELD_ACCESS_WORD:\r\nbyte_alignment = 2;\r\nbit_length = 16;\r\nbreak;\r\ncase AML_FIELD_ACCESS_DWORD:\r\nbyte_alignment = 4;\r\nbit_length = 32;\r\nbreak;\r\ncase AML_FIELD_ACCESS_QWORD:\r\nbyte_alignment = 8;\r\nbit_length = 64;\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO, "Unknown field access type 0x%X", access));\r\nreturn_UINT32(0);\r\n}\r\nif (obj_desc->common.type == ACPI_TYPE_BUFFER_FIELD) {\r\nbyte_alignment = 1;\r\n}\r\n*return_byte_alignment = byte_alignment;\r\nreturn_UINT32(bit_length);\r\n}\r\nacpi_status\r\nacpi_ex_prep_common_field_object(union acpi_operand_object *obj_desc,\r\nu8 field_flags,\r\nu8 field_attribute,\r\nu32 field_bit_position, u32 field_bit_length)\r\n{\r\nu32 access_bit_width;\r\nu32 byte_alignment;\r\nu32 nearest_byte_address;\r\nACPI_FUNCTION_TRACE(ex_prep_common_field_object);\r\nobj_desc->common_field.field_flags = field_flags;\r\nobj_desc->common_field.attribute = field_attribute;\r\nobj_desc->common_field.bit_length = field_bit_length;\r\naccess_bit_width = acpi_ex_decode_field_access(obj_desc, field_flags,\r\n&byte_alignment);\r\nif (!access_bit_width) {\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_VALUE);\r\n}\r\nobj_desc->common_field.access_byte_width = (u8)\r\nACPI_DIV_8(access_bit_width);\r\nnearest_byte_address =\r\nACPI_ROUND_BITS_DOWN_TO_BYTES(field_bit_position);\r\nobj_desc->common_field.base_byte_offset = (u32)\r\nACPI_ROUND_DOWN(nearest_byte_address, byte_alignment);\r\nobj_desc->common_field.start_field_bit_offset = (u8)\r\n(field_bit_position -\r\nACPI_MUL_8(obj_desc->common_field.base_byte_offset));\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status acpi_ex_prep_field_value(struct acpi_create_field_info *info)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_operand_object *second_desc = NULL;\r\nacpi_status status;\r\nu32 access_byte_width;\r\nu32 type;\r\nACPI_FUNCTION_TRACE(ex_prep_field_value);\r\nif (info->field_type != ACPI_TYPE_LOCAL_INDEX_FIELD) {\r\nif (!info->region_node) {\r\nACPI_ERROR((AE_INFO, "Null RegionNode"));\r\nreturn_ACPI_STATUS(AE_AML_NO_OPERAND);\r\n}\r\ntype = acpi_ns_get_type(info->region_node);\r\nif (type != ACPI_TYPE_REGION) {\r\nACPI_ERROR((AE_INFO,\r\n"Needed Region, found type 0x%X (%s)", type,\r\nacpi_ut_get_type_name(type)));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\n}\r\nobj_desc = acpi_ut_create_internal_object(info->field_type);\r\nif (!obj_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nobj_desc->common_field.node = info->field_node;\r\nstatus = acpi_ex_prep_common_field_object(obj_desc,\r\ninfo->field_flags,\r\ninfo->attribute,\r\ninfo->field_bit_position,\r\ninfo->field_bit_length);\r\nif (ACPI_FAILURE(status)) {\r\nacpi_ut_delete_object_desc(obj_desc);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nswitch (info->field_type) {\r\ncase ACPI_TYPE_LOCAL_REGION_FIELD:\r\nobj_desc->field.region_obj =\r\nacpi_ns_get_attached_object(info->region_node);\r\nobj_desc->field.access_length = info->access_length;\r\nif (info->connection_node) {\r\nsecond_desc = info->connection_node->object;\r\nif (!(second_desc->common.flags & AOPOBJ_DATA_VALID)) {\r\nstatus =\r\nacpi_ds_get_buffer_arguments(second_desc);\r\nif (ACPI_FAILURE(status)) {\r\nacpi_ut_delete_object_desc(obj_desc);\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nobj_desc->field.resource_buffer =\r\nsecond_desc->buffer.pointer;\r\nobj_desc->field.resource_length =\r\n(u16)second_desc->buffer.length;\r\n} else if (info->resource_buffer) {\r\nobj_desc->field.resource_buffer = info->resource_buffer;\r\nobj_desc->field.resource_length = info->resource_length;\r\n}\r\nobj_desc->field.pin_number_index = info->pin_number_index;\r\nif ((obj_desc->field.region_obj->region.space_id ==\r\nACPI_ADR_SPACE_EC)\r\n&& (obj_desc->common_field.bit_length > 8)) {\r\naccess_byte_width =\r\nACPI_ROUND_BITS_UP_TO_BYTES(obj_desc->common_field.\r\nbit_length);\r\nif (access_byte_width < 256) {\r\nobj_desc->common_field.access_byte_width =\r\n(u8)access_byte_width;\r\n}\r\n}\r\nacpi_ut_add_reference(obj_desc->field.region_obj);\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"RegionField: BitOff %X, Off %X, Gran %X, Region %p\n",\r\nobj_desc->field.start_field_bit_offset,\r\nobj_desc->field.base_byte_offset,\r\nobj_desc->field.access_byte_width,\r\nobj_desc->field.region_obj));\r\nbreak;\r\ncase ACPI_TYPE_LOCAL_BANK_FIELD:\r\nobj_desc->bank_field.value = info->bank_value;\r\nobj_desc->bank_field.region_obj =\r\nacpi_ns_get_attached_object(info->region_node);\r\nobj_desc->bank_field.bank_obj =\r\nacpi_ns_get_attached_object(info->register_node);\r\nacpi_ut_add_reference(obj_desc->bank_field.region_obj);\r\nacpi_ut_add_reference(obj_desc->bank_field.bank_obj);\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"Bank Field: BitOff %X, Off %X, Gran %X, Region %p, BankReg %p\n",\r\nobj_desc->bank_field.start_field_bit_offset,\r\nobj_desc->bank_field.base_byte_offset,\r\nobj_desc->field.access_byte_width,\r\nobj_desc->bank_field.region_obj,\r\nobj_desc->bank_field.bank_obj));\r\nsecond_desc = obj_desc->common.next_object;\r\nsecond_desc->extra.aml_start =\r\nACPI_CAST_PTR(union acpi_parse_object,\r\ninfo->data_register_node)->named.data;\r\nsecond_desc->extra.aml_length =\r\nACPI_CAST_PTR(union acpi_parse_object,\r\ninfo->data_register_node)->named.length;\r\nbreak;\r\ncase ACPI_TYPE_LOCAL_INDEX_FIELD:\r\nobj_desc->index_field.index_obj =\r\nacpi_ns_get_attached_object(info->register_node);\r\nobj_desc->index_field.data_obj =\r\nacpi_ns_get_attached_object(info->data_register_node);\r\nif (!obj_desc->index_field.data_obj\r\n|| !obj_desc->index_field.index_obj) {\r\nACPI_ERROR((AE_INFO,\r\n"Null Index Object during field prep"));\r\nacpi_ut_delete_object_desc(obj_desc);\r\nreturn_ACPI_STATUS(AE_AML_INTERNAL);\r\n}\r\nacpi_ut_add_reference(obj_desc->index_field.data_obj);\r\nacpi_ut_add_reference(obj_desc->index_field.index_obj);\r\nobj_desc->index_field.value =\r\n(u32) ACPI_ROUND_DOWN(ACPI_DIV_8(info->field_bit_position),\r\nobj_desc->index_field.\r\naccess_byte_width);\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"IndexField: BitOff %X, Off %X, Value %X, Gran %X, Index %p, Data %p\n",\r\nobj_desc->index_field.start_field_bit_offset,\r\nobj_desc->index_field.base_byte_offset,\r\nobj_desc->index_field.value,\r\nobj_desc->field.access_byte_width,\r\nobj_desc->index_field.index_obj,\r\nobj_desc->index_field.data_obj));\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nstatus = acpi_ns_attach_object(info->field_node, obj_desc,\r\nacpi_ns_get_type(info->field_node));\r\nACPI_DEBUG_PRINT((ACPI_DB_BFIELD,\r\n"Set NamedObj %p [%4.4s], ObjDesc %p\n",\r\ninfo->field_node,\r\nacpi_ut_get_node_name(info->field_node), obj_desc));\r\nacpi_ut_remove_reference(obj_desc);\r\nreturn_ACPI_STATUS(status);\r\n}

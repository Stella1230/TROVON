const char *sti_layer_to_str(struct sti_layer *layer)\r\n{\r\nswitch (layer->desc) {\r\ncase STI_GDP_0:\r\nreturn "GDP0";\r\ncase STI_GDP_1:\r\nreturn "GDP1";\r\ncase STI_GDP_2:\r\nreturn "GDP2";\r\ncase STI_GDP_3:\r\nreturn "GDP3";\r\ncase STI_VID_0:\r\nreturn "VID0";\r\ncase STI_VID_1:\r\nreturn "VID1";\r\ncase STI_CURSOR:\r\nreturn "CURSOR";\r\ndefault:\r\nreturn "<UNKNOWN LAYER>";\r\n}\r\n}\r\nstruct sti_layer *sti_layer_create(struct device *dev, int desc,\r\nvoid __iomem *baseaddr)\r\n{\r\nstruct sti_layer *layer = NULL;\r\nswitch (desc & STI_LAYER_TYPE_MASK) {\r\ncase STI_GDP:\r\nlayer = sti_gdp_create(dev, desc);\r\nbreak;\r\ncase STI_VID:\r\nlayer = sti_vid_create(dev);\r\nbreak;\r\n}\r\nif (!layer) {\r\nDRM_ERROR("Failed to create layer\n");\r\nreturn NULL;\r\n}\r\nlayer->desc = desc;\r\nlayer->dev = dev;\r\nlayer->regs = baseaddr;\r\nlayer->ops->init(layer);\r\nDRM_DEBUG_DRIVER("%s created\n", sti_layer_to_str(layer));\r\nreturn layer;\r\n}\r\nint sti_layer_prepare(struct sti_layer *layer, struct drm_framebuffer *fb,\r\nstruct drm_display_mode *mode, int mixer_id,\r\nint dest_x, int dest_y, int dest_w, int dest_h,\r\nint src_x, int src_y, int src_w, int src_h)\r\n{\r\nint ret;\r\nunsigned int i;\r\nstruct drm_gem_cma_object *cma_obj;\r\nif (!layer || !fb || !mode) {\r\nDRM_ERROR("Null fb, layer or mode\n");\r\nreturn 1;\r\n}\r\ncma_obj = drm_fb_cma_get_gem_obj(fb, 0);\r\nif (!cma_obj) {\r\nDRM_ERROR("Can't get CMA GEM object for fb\n");\r\nreturn 1;\r\n}\r\nlayer->fb = fb;\r\nlayer->mode = mode;\r\nlayer->mixer_id = mixer_id;\r\nlayer->dst_x = dest_x;\r\nlayer->dst_y = dest_y;\r\nlayer->dst_w = clamp_val(dest_w, 0, mode->crtc_hdisplay - dest_x);\r\nlayer->dst_h = clamp_val(dest_h, 0, mode->crtc_vdisplay - dest_y);\r\nlayer->src_x = src_x;\r\nlayer->src_y = src_y;\r\nlayer->src_w = src_w;\r\nlayer->src_h = src_h;\r\nlayer->format = fb->pixel_format;\r\nlayer->paddr = cma_obj->paddr;\r\nfor (i = 0; i < 4; i++) {\r\nlayer->pitches[i] = fb->pitches[i];\r\nlayer->offsets[i] = fb->offsets[i];\r\n}\r\nDRM_DEBUG_DRIVER("%s is associated with mixer_id %d\n",\r\nsti_layer_to_str(layer),\r\nlayer->mixer_id);\r\nDRM_DEBUG_DRIVER("%s dst=(%dx%d)@(%d,%d) - src=(%dx%d)@(%d,%d)\n",\r\nsti_layer_to_str(layer),\r\nlayer->dst_w, layer->dst_h, layer->dst_x, layer->dst_y,\r\nlayer->src_w, layer->src_h, layer->src_x,\r\nlayer->src_y);\r\nDRM_DEBUG_DRIVER("drm FB:%d format:%.4s phys@:0x%lx\n", fb->base.id,\r\n(char *)&layer->format, (unsigned long)layer->paddr);\r\nif (!layer->ops->prepare)\r\ngoto err_no_prepare;\r\nret = layer->ops->prepare(layer, !layer->enabled);\r\nif (!ret)\r\nlayer->enabled = true;\r\nreturn ret;\r\nerr_no_prepare:\r\nDRM_ERROR("Cannot prepare\n");\r\nreturn 1;\r\n}\r\nint sti_layer_commit(struct sti_layer *layer)\r\n{\r\nif (!layer)\r\nreturn 1;\r\nif (!layer->ops->commit)\r\ngoto err_no_commit;\r\nreturn layer->ops->commit(layer);\r\nerr_no_commit:\r\nDRM_ERROR("Cannot commit\n");\r\nreturn 1;\r\n}\r\nint sti_layer_disable(struct sti_layer *layer)\r\n{\r\nint ret;\r\nDRM_DEBUG_DRIVER("%s\n", sti_layer_to_str(layer));\r\nif (!layer)\r\nreturn 1;\r\nif (!layer->enabled)\r\nreturn 0;\r\nif (!layer->ops->disable)\r\ngoto err_no_disable;\r\nret = layer->ops->disable(layer);\r\nif (!ret)\r\nlayer->enabled = false;\r\nelse\r\nDRM_ERROR("Disable failed\n");\r\nreturn ret;\r\nerr_no_disable:\r\nDRM_ERROR("Cannot disable\n");\r\nreturn 1;\r\n}\r\nconst uint32_t *sti_layer_get_formats(struct sti_layer *layer)\r\n{\r\nif (!layer)\r\nreturn NULL;\r\nif (!layer->ops->get_formats)\r\nreturn NULL;\r\nreturn layer->ops->get_formats(layer);\r\n}\r\nunsigned int sti_layer_get_nb_formats(struct sti_layer *layer)\r\n{\r\nif (!layer)\r\nreturn 0;\r\nif (!layer->ops->get_nb_formats)\r\nreturn 0;\r\nreturn layer->ops->get_nb_formats(layer);\r\n}

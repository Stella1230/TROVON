void llc_pdu_set_cmd_rsp(struct sk_buff *skb, u8 pdu_type)\r\n{\r\nllc_pdu_un_hdr(skb)->ssap |= pdu_type;\r\n}\r\nvoid llc_pdu_set_pf_bit(struct sk_buff *skb, u8 bit_value)\r\n{\r\nu8 pdu_type;\r\nstruct llc_pdu_sn *pdu;\r\nllc_pdu_decode_pdu_type(skb, &pdu_type);\r\npdu = llc_pdu_sn_hdr(skb);\r\nswitch (pdu_type) {\r\ncase LLC_PDU_TYPE_I:\r\ncase LLC_PDU_TYPE_S:\r\npdu->ctrl_2 = (pdu->ctrl_2 & 0xFE) | bit_value;\r\nbreak;\r\ncase LLC_PDU_TYPE_U:\r\npdu->ctrl_1 |= (pdu->ctrl_1 & 0xEF) | (bit_value << 4);\r\nbreak;\r\n}\r\n}\r\nvoid llc_pdu_decode_pf_bit(struct sk_buff *skb, u8 *pf_bit)\r\n{\r\nu8 pdu_type;\r\nstruct llc_pdu_sn *pdu;\r\nllc_pdu_decode_pdu_type(skb, &pdu_type);\r\npdu = llc_pdu_sn_hdr(skb);\r\nswitch (pdu_type) {\r\ncase LLC_PDU_TYPE_I:\r\ncase LLC_PDU_TYPE_S:\r\n*pf_bit = pdu->ctrl_2 & LLC_S_PF_BIT_MASK;\r\nbreak;\r\ncase LLC_PDU_TYPE_U:\r\n*pf_bit = (pdu->ctrl_1 & LLC_U_PF_BIT_MASK) >> 4;\r\nbreak;\r\n}\r\n}\r\nvoid llc_pdu_init_as_disc_cmd(struct sk_buff *skb, u8 p_bit)\r\n{\r\nstruct llc_pdu_un *pdu = llc_pdu_un_hdr(skb);\r\npdu->ctrl_1 = LLC_PDU_TYPE_U;\r\npdu->ctrl_1 |= LLC_2_PDU_CMD_DISC;\r\npdu->ctrl_1 |= ((p_bit & 1) << 4) & LLC_U_PF_BIT_MASK;\r\n}\r\nvoid llc_pdu_init_as_i_cmd(struct sk_buff *skb, u8 p_bit, u8 ns, u8 nr)\r\n{\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\npdu->ctrl_1 = LLC_PDU_TYPE_I;\r\npdu->ctrl_2 = 0;\r\npdu->ctrl_2 |= (p_bit & LLC_I_PF_BIT_MASK);\r\npdu->ctrl_1 |= (ns << 1) & 0xFE;\r\npdu->ctrl_2 |= (nr << 1) & 0xFE;\r\n}\r\nvoid llc_pdu_init_as_rej_cmd(struct sk_buff *skb, u8 p_bit, u8 nr)\r\n{\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\npdu->ctrl_1 = LLC_PDU_TYPE_S;\r\npdu->ctrl_1 |= LLC_2_PDU_CMD_REJ;\r\npdu->ctrl_2 = 0;\r\npdu->ctrl_2 |= p_bit & LLC_S_PF_BIT_MASK;\r\npdu->ctrl_1 &= 0x0F;\r\npdu->ctrl_2 |= (nr << 1) & 0xFE;\r\n}\r\nvoid llc_pdu_init_as_rnr_cmd(struct sk_buff *skb, u8 p_bit, u8 nr)\r\n{\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\npdu->ctrl_1 = LLC_PDU_TYPE_S;\r\npdu->ctrl_1 |= LLC_2_PDU_CMD_RNR;\r\npdu->ctrl_2 = 0;\r\npdu->ctrl_2 |= p_bit & LLC_S_PF_BIT_MASK;\r\npdu->ctrl_1 &= 0x0F;\r\npdu->ctrl_2 |= (nr << 1) & 0xFE;\r\n}\r\nvoid llc_pdu_init_as_rr_cmd(struct sk_buff *skb, u8 p_bit, u8 nr)\r\n{\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\npdu->ctrl_1 = LLC_PDU_TYPE_S;\r\npdu->ctrl_1 |= LLC_2_PDU_CMD_RR;\r\npdu->ctrl_2 = p_bit & LLC_S_PF_BIT_MASK;\r\npdu->ctrl_1 &= 0x0F;\r\npdu->ctrl_2 |= (nr << 1) & 0xFE;\r\n}\r\nvoid llc_pdu_init_as_sabme_cmd(struct sk_buff *skb, u8 p_bit)\r\n{\r\nstruct llc_pdu_un *pdu = llc_pdu_un_hdr(skb);\r\npdu->ctrl_1 = LLC_PDU_TYPE_U;\r\npdu->ctrl_1 |= LLC_2_PDU_CMD_SABME;\r\npdu->ctrl_1 |= ((p_bit & 1) << 4) & LLC_U_PF_BIT_MASK;\r\n}\r\nvoid llc_pdu_init_as_dm_rsp(struct sk_buff *skb, u8 f_bit)\r\n{\r\nstruct llc_pdu_un *pdu = llc_pdu_un_hdr(skb);\r\npdu->ctrl_1 = LLC_PDU_TYPE_U;\r\npdu->ctrl_1 |= LLC_2_PDU_RSP_DM;\r\npdu->ctrl_1 |= ((f_bit & 1) << 4) & LLC_U_PF_BIT_MASK;\r\n}\r\nvoid llc_pdu_init_as_frmr_rsp(struct sk_buff *skb, struct llc_pdu_sn *prev_pdu,\r\nu8 f_bit, u8 vs, u8 vr, u8 vzyxw)\r\n{\r\nstruct llc_frmr_info *frmr_info;\r\nu8 prev_pf = 0;\r\nu8 *ctrl;\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\npdu->ctrl_1 = LLC_PDU_TYPE_U;\r\npdu->ctrl_1 |= LLC_2_PDU_RSP_FRMR;\r\npdu->ctrl_1 |= ((f_bit & 1) << 4) & LLC_U_PF_BIT_MASK;\r\nfrmr_info = (struct llc_frmr_info *)&pdu->ctrl_2;\r\nctrl = (u8 *)&prev_pdu->ctrl_1;\r\nFRMR_INFO_SET_REJ_CNTRL(frmr_info,ctrl);\r\nFRMR_INFO_SET_Vs(frmr_info, vs);\r\nFRMR_INFO_SET_Vr(frmr_info, vr);\r\nprev_pf = llc_pdu_get_pf_bit(prev_pdu);\r\nFRMR_INFO_SET_C_R_BIT(frmr_info, prev_pf);\r\nFRMR_INFO_SET_INVALID_PDU_CTRL_IND(frmr_info, vzyxw);\r\nFRMR_INFO_SET_INVALID_PDU_INFO_IND(frmr_info, vzyxw);\r\nFRMR_INFO_SET_PDU_INFO_2LONG_IND(frmr_info, vzyxw);\r\nFRMR_INFO_SET_PDU_INVALID_Nr_IND(frmr_info, vzyxw);\r\nFRMR_INFO_SET_PDU_INVALID_Ns_IND(frmr_info, vzyxw);\r\nskb_put(skb, sizeof(struct llc_frmr_info));\r\n}\r\nvoid llc_pdu_init_as_rr_rsp(struct sk_buff *skb, u8 f_bit, u8 nr)\r\n{\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\npdu->ctrl_1 = LLC_PDU_TYPE_S;\r\npdu->ctrl_1 |= LLC_2_PDU_RSP_RR;\r\npdu->ctrl_2 = 0;\r\npdu->ctrl_2 |= f_bit & LLC_S_PF_BIT_MASK;\r\npdu->ctrl_1 &= 0x0F;\r\npdu->ctrl_2 |= (nr << 1) & 0xFE;\r\n}\r\nvoid llc_pdu_init_as_rej_rsp(struct sk_buff *skb, u8 f_bit, u8 nr)\r\n{\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\npdu->ctrl_1 = LLC_PDU_TYPE_S;\r\npdu->ctrl_1 |= LLC_2_PDU_RSP_REJ;\r\npdu->ctrl_2 = 0;\r\npdu->ctrl_2 |= f_bit & LLC_S_PF_BIT_MASK;\r\npdu->ctrl_1 &= 0x0F;\r\npdu->ctrl_2 |= (nr << 1) & 0xFE;\r\n}\r\nvoid llc_pdu_init_as_rnr_rsp(struct sk_buff *skb, u8 f_bit, u8 nr)\r\n{\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\npdu->ctrl_1 = LLC_PDU_TYPE_S;\r\npdu->ctrl_1 |= LLC_2_PDU_RSP_RNR;\r\npdu->ctrl_2 = 0;\r\npdu->ctrl_2 |= f_bit & LLC_S_PF_BIT_MASK;\r\npdu->ctrl_1 &= 0x0F;\r\npdu->ctrl_2 |= (nr << 1) & 0xFE;\r\n}\r\nvoid llc_pdu_init_as_ua_rsp(struct sk_buff *skb, u8 f_bit)\r\n{\r\nstruct llc_pdu_un *pdu = llc_pdu_un_hdr(skb);\r\npdu->ctrl_1 = LLC_PDU_TYPE_U;\r\npdu->ctrl_1 |= LLC_2_PDU_RSP_UA;\r\npdu->ctrl_1 |= ((f_bit & 1) << 4) & LLC_U_PF_BIT_MASK;\r\n}\r\nstatic void llc_pdu_decode_pdu_type(struct sk_buff *skb, u8 *type)\r\n{\r\nstruct llc_pdu_un *pdu = llc_pdu_un_hdr(skb);\r\nif (pdu->ctrl_1 & 1) {\r\nif ((pdu->ctrl_1 & LLC_PDU_TYPE_U) == LLC_PDU_TYPE_U)\r\n*type = LLC_PDU_TYPE_U;\r\nelse\r\n*type = LLC_PDU_TYPE_S;\r\n} else\r\n*type = LLC_PDU_TYPE_I;\r\n}\r\nstatic u8 llc_pdu_get_pf_bit(struct llc_pdu_sn *pdu)\r\n{\r\nu8 pdu_type;\r\nu8 pf_bit = 0;\r\nif (pdu->ctrl_1 & 1) {\r\nif ((pdu->ctrl_1 & LLC_PDU_TYPE_U) == LLC_PDU_TYPE_U)\r\npdu_type = LLC_PDU_TYPE_U;\r\nelse\r\npdu_type = LLC_PDU_TYPE_S;\r\n} else\r\npdu_type = LLC_PDU_TYPE_I;\r\nswitch (pdu_type) {\r\ncase LLC_PDU_TYPE_I:\r\ncase LLC_PDU_TYPE_S:\r\npf_bit = pdu->ctrl_2 & LLC_S_PF_BIT_MASK;\r\nbreak;\r\ncase LLC_PDU_TYPE_U:\r\npf_bit = (pdu->ctrl_1 & LLC_U_PF_BIT_MASK) >> 4;\r\nbreak;\r\n}\r\nreturn pf_bit;\r\n}

static void avr32_perf_counter_reset(void)\r\n{\r\nsysreg_write(PCCR, (SYSREG_BIT(PCCR_R)\r\n| SYSREG_BIT(PCCR_C)\r\n| SYSREG_BIT(FC)\r\n| SYSREG_BIT(F0)\r\n| SYSREG_BIT(F1)));\r\n}\r\nstatic irqreturn_t avr32_perf_counter_interrupt(int irq, void *dev_id)\r\n{\r\nstruct avr32_perf_counter *ctr = dev_id;\r\nstruct pt_regs *regs;\r\nu32 pccr;\r\nif (likely(!(intc_get_pending(AVR32_PERFCTR_IRQ_GROUP)\r\n& (1 << AVR32_PERFCTR_IRQ_LINE))))\r\nreturn IRQ_NONE;\r\nregs = get_irq_regs();\r\npccr = sysreg_read(PCCR);\r\nsysreg_write(PCCR, pccr);\r\nif (ctr->enabled && (pccr & ctr->flag_mask)) {\r\nsysreg_write(PCCNT, -ctr->count);\r\noprofile_add_sample(regs, PCCNT);\r\n}\r\nctr++;\r\nif (ctr->enabled && (pccr & ctr->flag_mask)) {\r\nsysreg_write(PCNT0, -ctr->count);\r\noprofile_add_sample(regs, PCNT0);\r\n}\r\nctr++;\r\nif (ctr->enabled && (pccr & ctr->flag_mask)) {\r\nsysreg_write(PCNT1, -ctr->count);\r\noprofile_add_sample(regs, PCNT1);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int avr32_perf_counter_create_files(struct dentry *root)\r\n{\r\nstruct dentry *dir;\r\nunsigned int i;\r\nchar filename[4];\r\nfor (i = 0; i < NR_counter; i++) {\r\nsnprintf(filename, sizeof(filename), "%u", i);\r\ndir = oprofilefs_mkdir(root, filename);\r\noprofilefs_create_ulong(dir, "enabled",\r\n&counter[i].enabled);\r\noprofilefs_create_ulong(dir, "event",\r\n&counter[i].event);\r\noprofilefs_create_ulong(dir, "count",\r\n&counter[i].count);\r\noprofilefs_create_ulong(dir, "kernel",\r\n&counter[i].kernel);\r\noprofilefs_create_ulong(dir, "user",\r\n&counter[i].user);\r\noprofilefs_create_ulong(dir, "unit_mask",\r\n&counter[i].unit_mask);\r\n}\r\nreturn 0;\r\n}\r\nstatic int avr32_perf_counter_setup(void)\r\n{\r\nstruct avr32_perf_counter *ctr;\r\nu32 pccr;\r\nint ret;\r\nint i;\r\npr_debug("avr32_perf_counter_setup\n");\r\nif (sysreg_read(PCCR) & SYSREG_BIT(PCCR_E)) {\r\nprintk(KERN_ERR\r\n"oprofile: setup: perf counter already enabled\n");\r\nreturn -EBUSY;\r\n}\r\nret = request_irq(AVR32_PERFCTR_IRQ_GROUP,\r\navr32_perf_counter_interrupt, IRQF_SHARED,\r\n"oprofile", counter);\r\nif (ret)\r\nreturn ret;\r\navr32_perf_counter_reset();\r\npccr = 0;\r\nfor (i = PCCNT; i < NR_counter; i++) {\r\nctr = &counter[i];\r\nif (!ctr->enabled)\r\ncontinue;\r\npr_debug("enabling counter %d...\n", i);\r\npccr |= ctr->ie_mask;\r\nswitch (i) {\r\ncase PCCNT:\r\nsysreg_write(PCCNT, -ctr->count);\r\nbreak;\r\ncase PCNT0:\r\npccr |= SYSREG_BF(CONF0, ctr->event);\r\nsysreg_write(PCNT0, -ctr->count);\r\nbreak;\r\ncase PCNT1:\r\npccr |= SYSREG_BF(CONF1, ctr->event);\r\nsysreg_write(PCNT1, -ctr->count);\r\nbreak;\r\n}\r\n}\r\npr_debug("oprofile: writing 0x%x to PCCR...\n", pccr);\r\nsysreg_write(PCCR, pccr);\r\nreturn 0;\r\n}\r\nstatic void avr32_perf_counter_shutdown(void)\r\n{\r\npr_debug("avr32_perf_counter_shutdown\n");\r\navr32_perf_counter_reset();\r\nfree_irq(AVR32_PERFCTR_IRQ_GROUP, counter);\r\n}\r\nstatic int avr32_perf_counter_start(void)\r\n{\r\npr_debug("avr32_perf_counter_start\n");\r\nsysreg_write(PCCR, sysreg_read(PCCR) | SYSREG_BIT(PCCR_E));\r\nreturn 0;\r\n}\r\nstatic void avr32_perf_counter_stop(void)\r\n{\r\npr_debug("avr32_perf_counter_stop\n");\r\nsysreg_write(PCCR, sysreg_read(PCCR) & ~SYSREG_BIT(PCCR_E));\r\n}\r\nint __init oprofile_arch_init(struct oprofile_operations *ops)\r\n{\r\nif (!(current_cpu_data.features & AVR32_FEATURE_PCTR))\r\nreturn -ENODEV;\r\nmemcpy(ops, &avr32_perf_counter_ops,\r\nsizeof(struct oprofile_operations));\r\nops->backtrace = avr32_backtrace;\r\nprintk(KERN_INFO "oprofile: using AVR32 performance monitoring.\n");\r\nreturn 0;\r\n}\r\nvoid oprofile_arch_exit(void)\r\n{\r\n}

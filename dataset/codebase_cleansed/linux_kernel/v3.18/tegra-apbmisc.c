u32 tegra_read_chipid(void)\r\n{\r\nreturn readl_relaxed(apbmisc_base + 4);\r\n}\r\nu8 tegra_get_chip_id(void)\r\n{\r\nif (!apbmisc_base) {\r\nWARN(1, "Tegra Chip ID not yet available\n");\r\nreturn 0;\r\n}\r\nreturn (tegra_read_chipid() >> 8) & 0xff;\r\n}\r\nu32 tegra_read_straps(void)\r\n{\r\nif (strapping_base)\r\nreturn readl_relaxed(strapping_base);\r\nelse\r\nreturn 0;\r\n}\r\nvoid __init tegra_init_revision(void)\r\n{\r\nu32 id, chip_id, minor_rev;\r\nint rev;\r\nid = tegra_read_chipid();\r\nchip_id = (id >> 8) & 0xff;\r\nminor_rev = (id >> 16) & 0xf;\r\nswitch (minor_rev) {\r\ncase 1:\r\nrev = TEGRA_REVISION_A01;\r\nbreak;\r\ncase 2:\r\nrev = TEGRA_REVISION_A02;\r\nbreak;\r\ncase 3:\r\nif (chip_id == TEGRA20 && (tegra20_spare_fuse_early(18) ||\r\ntegra20_spare_fuse_early(19)))\r\nrev = TEGRA_REVISION_A03p;\r\nelse\r\nrev = TEGRA_REVISION_A03;\r\nbreak;\r\ncase 4:\r\nrev = TEGRA_REVISION_A04;\r\nbreak;\r\ndefault:\r\nrev = TEGRA_REVISION_UNKNOWN;\r\n}\r\ntegra_sku_info.revision = rev;\r\nif (chip_id == TEGRA20)\r\ntegra_sku_info.sku_id = tegra20_fuse_early(FUSE_SKU_INFO);\r\nelse\r\ntegra_sku_info.sku_id = tegra30_fuse_readl(FUSE_SKU_INFO);\r\n}\r\nvoid __init tegra_init_apbmisc(void)\r\n{\r\nstruct device_node *np;\r\nnp = of_find_matching_node(NULL, apbmisc_match);\r\napbmisc_base = of_iomap(np, 0);\r\nif (!apbmisc_base) {\r\npr_warn("ioremap tegra apbmisc failed. using %08x instead\n",\r\nAPBMISC_BASE);\r\napbmisc_base = ioremap(APBMISC_BASE, APBMISC_SIZE);\r\n}\r\nstrapping_base = of_iomap(np, 1);\r\nif (!strapping_base)\r\npr_err("ioremap tegra strapping_base failed\n");\r\n}

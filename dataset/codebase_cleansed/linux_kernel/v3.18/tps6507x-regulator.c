static inline int tps6507x_pmic_read(struct tps6507x_pmic *tps, u8 reg)\r\n{\r\nu8 val;\r\nint err;\r\nerr = tps->mfd->read_dev(tps->mfd, reg, 1, &val);\r\nif (err)\r\nreturn err;\r\nreturn val;\r\n}\r\nstatic inline int tps6507x_pmic_write(struct tps6507x_pmic *tps, u8 reg, u8 val)\r\n{\r\nreturn tps->mfd->write_dev(tps->mfd, reg, 1, &val);\r\n}\r\nstatic int tps6507x_pmic_set_bits(struct tps6507x_pmic *tps, u8 reg, u8 mask)\r\n{\r\nint err, data;\r\nmutex_lock(&tps->io_lock);\r\ndata = tps6507x_pmic_read(tps, reg);\r\nif (data < 0) {\r\ndev_err(tps->mfd->dev, "Read from reg 0x%x failed\n", reg);\r\nerr = data;\r\ngoto out;\r\n}\r\ndata |= mask;\r\nerr = tps6507x_pmic_write(tps, reg, data);\r\nif (err)\r\ndev_err(tps->mfd->dev, "Write for reg 0x%x failed\n", reg);\r\nout:\r\nmutex_unlock(&tps->io_lock);\r\nreturn err;\r\n}\r\nstatic int tps6507x_pmic_clear_bits(struct tps6507x_pmic *tps, u8 reg, u8 mask)\r\n{\r\nint err, data;\r\nmutex_lock(&tps->io_lock);\r\ndata = tps6507x_pmic_read(tps, reg);\r\nif (data < 0) {\r\ndev_err(tps->mfd->dev, "Read from reg 0x%x failed\n", reg);\r\nerr = data;\r\ngoto out;\r\n}\r\ndata &= ~mask;\r\nerr = tps6507x_pmic_write(tps, reg, data);\r\nif (err)\r\ndev_err(tps->mfd->dev, "Write for reg 0x%x failed\n", reg);\r\nout:\r\nmutex_unlock(&tps->io_lock);\r\nreturn err;\r\n}\r\nstatic int tps6507x_pmic_reg_read(struct tps6507x_pmic *tps, u8 reg)\r\n{\r\nint data;\r\nmutex_lock(&tps->io_lock);\r\ndata = tps6507x_pmic_read(tps, reg);\r\nif (data < 0)\r\ndev_err(tps->mfd->dev, "Read from reg 0x%x failed\n", reg);\r\nmutex_unlock(&tps->io_lock);\r\nreturn data;\r\n}\r\nstatic int tps6507x_pmic_reg_write(struct tps6507x_pmic *tps, u8 reg, u8 val)\r\n{\r\nint err;\r\nmutex_lock(&tps->io_lock);\r\nerr = tps6507x_pmic_write(tps, reg, val);\r\nif (err < 0)\r\ndev_err(tps->mfd->dev, "Write for reg 0x%x failed\n", reg);\r\nmutex_unlock(&tps->io_lock);\r\nreturn err;\r\n}\r\nstatic int tps6507x_pmic_is_enabled(struct regulator_dev *dev)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint data, rid = rdev_get_id(dev);\r\nu8 shift;\r\nif (rid < TPS6507X_DCDC_1 || rid > TPS6507X_LDO_2)\r\nreturn -EINVAL;\r\nshift = TPS6507X_MAX_REG_ID - rid;\r\ndata = tps6507x_pmic_reg_read(tps, TPS6507X_REG_CON_CTRL1);\r\nif (data < 0)\r\nreturn data;\r\nelse\r\nreturn (data & 1<<shift) ? 1 : 0;\r\n}\r\nstatic int tps6507x_pmic_enable(struct regulator_dev *dev)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint rid = rdev_get_id(dev);\r\nu8 shift;\r\nif (rid < TPS6507X_DCDC_1 || rid > TPS6507X_LDO_2)\r\nreturn -EINVAL;\r\nshift = TPS6507X_MAX_REG_ID - rid;\r\nreturn tps6507x_pmic_set_bits(tps, TPS6507X_REG_CON_CTRL1, 1 << shift);\r\n}\r\nstatic int tps6507x_pmic_disable(struct regulator_dev *dev)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint rid = rdev_get_id(dev);\r\nu8 shift;\r\nif (rid < TPS6507X_DCDC_1 || rid > TPS6507X_LDO_2)\r\nreturn -EINVAL;\r\nshift = TPS6507X_MAX_REG_ID - rid;\r\nreturn tps6507x_pmic_clear_bits(tps, TPS6507X_REG_CON_CTRL1,\r\n1 << shift);\r\n}\r\nstatic int tps6507x_pmic_get_voltage_sel(struct regulator_dev *dev)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint data, rid = rdev_get_id(dev);\r\nu8 reg, mask;\r\nswitch (rid) {\r\ncase TPS6507X_DCDC_1:\r\nreg = TPS6507X_REG_DEFDCDC1;\r\nmask = TPS6507X_DEFDCDCX_DCDC_MASK;\r\nbreak;\r\ncase TPS6507X_DCDC_2:\r\nif (tps->info[rid]->defdcdc_default)\r\nreg = TPS6507X_REG_DEFDCDC2_HIGH;\r\nelse\r\nreg = TPS6507X_REG_DEFDCDC2_LOW;\r\nmask = TPS6507X_DEFDCDCX_DCDC_MASK;\r\nbreak;\r\ncase TPS6507X_DCDC_3:\r\nif (tps->info[rid]->defdcdc_default)\r\nreg = TPS6507X_REG_DEFDCDC3_HIGH;\r\nelse\r\nreg = TPS6507X_REG_DEFDCDC3_LOW;\r\nmask = TPS6507X_DEFDCDCX_DCDC_MASK;\r\nbreak;\r\ncase TPS6507X_LDO_1:\r\nreg = TPS6507X_REG_LDO_CTRL1;\r\nmask = TPS6507X_REG_LDO_CTRL1_LDO1_MASK;\r\nbreak;\r\ncase TPS6507X_LDO_2:\r\nreg = TPS6507X_REG_DEFLDO2;\r\nmask = TPS6507X_REG_DEFLDO2_LDO2_MASK;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndata = tps6507x_pmic_reg_read(tps, reg);\r\nif (data < 0)\r\nreturn data;\r\ndata &= mask;\r\nreturn data;\r\n}\r\nstatic int tps6507x_pmic_set_voltage_sel(struct regulator_dev *dev,\r\nunsigned selector)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint data, rid = rdev_get_id(dev);\r\nu8 reg, mask;\r\nswitch (rid) {\r\ncase TPS6507X_DCDC_1:\r\nreg = TPS6507X_REG_DEFDCDC1;\r\nmask = TPS6507X_DEFDCDCX_DCDC_MASK;\r\nbreak;\r\ncase TPS6507X_DCDC_2:\r\nif (tps->info[rid]->defdcdc_default)\r\nreg = TPS6507X_REG_DEFDCDC2_HIGH;\r\nelse\r\nreg = TPS6507X_REG_DEFDCDC2_LOW;\r\nmask = TPS6507X_DEFDCDCX_DCDC_MASK;\r\nbreak;\r\ncase TPS6507X_DCDC_3:\r\nif (tps->info[rid]->defdcdc_default)\r\nreg = TPS6507X_REG_DEFDCDC3_HIGH;\r\nelse\r\nreg = TPS6507X_REG_DEFDCDC3_LOW;\r\nmask = TPS6507X_DEFDCDCX_DCDC_MASK;\r\nbreak;\r\ncase TPS6507X_LDO_1:\r\nreg = TPS6507X_REG_LDO_CTRL1;\r\nmask = TPS6507X_REG_LDO_CTRL1_LDO1_MASK;\r\nbreak;\r\ncase TPS6507X_LDO_2:\r\nreg = TPS6507X_REG_DEFLDO2;\r\nmask = TPS6507X_REG_DEFLDO2_LDO2_MASK;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndata = tps6507x_pmic_reg_read(tps, reg);\r\nif (data < 0)\r\nreturn data;\r\ndata &= ~mask;\r\ndata |= selector;\r\nreturn tps6507x_pmic_reg_write(tps, reg, data);\r\n}\r\nstatic struct tps6507x_board *tps6507x_parse_dt_reg_data(\r\nstruct platform_device *pdev,\r\nstruct of_regulator_match **tps6507x_reg_matches)\r\n{\r\nstruct tps6507x_board *tps_board;\r\nstruct device_node *np = pdev->dev.parent->of_node;\r\nstruct device_node *regulators;\r\nstruct of_regulator_match *matches;\r\nstatic struct regulator_init_data *reg_data;\r\nint idx = 0, count, ret;\r\ntps_board = devm_kzalloc(&pdev->dev, sizeof(*tps_board),\r\nGFP_KERNEL);\r\nif (!tps_board)\r\nreturn NULL;\r\nregulators = of_get_child_by_name(np, "regulators");\r\nif (!regulators) {\r\ndev_err(&pdev->dev, "regulator node not found\n");\r\nreturn NULL;\r\n}\r\ncount = ARRAY_SIZE(tps6507x_matches);\r\nmatches = tps6507x_matches;\r\nret = of_regulator_match(&pdev->dev, regulators, matches, count);\r\nof_node_put(regulators);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Error parsing regulator init data: %d\n",\r\nret);\r\nreturn NULL;\r\n}\r\n*tps6507x_reg_matches = matches;\r\nreg_data = devm_kzalloc(&pdev->dev, (sizeof(struct regulator_init_data)\r\n* TPS6507X_NUM_REGULATOR), GFP_KERNEL);\r\nif (!reg_data)\r\nreturn NULL;\r\ntps_board->tps6507x_pmic_init_data = reg_data;\r\nfor (idx = 0; idx < count; idx++) {\r\nif (!matches[idx].init_data || !matches[idx].of_node)\r\ncontinue;\r\nmemcpy(&reg_data[idx], matches[idx].init_data,\r\nsizeof(struct regulator_init_data));\r\n}\r\nreturn tps_board;\r\n}\r\nstatic int tps6507x_pmic_probe(struct platform_device *pdev)\r\n{\r\nstruct tps6507x_dev *tps6507x_dev = dev_get_drvdata(pdev->dev.parent);\r\nstruct tps_info *info = &tps6507x_pmic_regs[0];\r\nstruct regulator_config config = { };\r\nstruct regulator_init_data *init_data;\r\nstruct regulator_dev *rdev;\r\nstruct tps6507x_pmic *tps;\r\nstruct tps6507x_board *tps_board;\r\nstruct of_regulator_match *tps6507x_reg_matches = NULL;\r\nint i;\r\nint error;\r\nunsigned int prop;\r\ntps_board = dev_get_platdata(tps6507x_dev->dev);\r\nif (IS_ENABLED(CONFIG_OF) && !tps_board &&\r\ntps6507x_dev->dev->of_node)\r\ntps_board = tps6507x_parse_dt_reg_data(pdev,\r\n&tps6507x_reg_matches);\r\nif (!tps_board)\r\nreturn -EINVAL;\r\ninit_data = tps_board->tps6507x_pmic_init_data;\r\nif (!init_data)\r\nreturn -EINVAL;\r\ntps = devm_kzalloc(&pdev->dev, sizeof(*tps), GFP_KERNEL);\r\nif (!tps)\r\nreturn -ENOMEM;\r\nmutex_init(&tps->io_lock);\r\ntps->mfd = tps6507x_dev;\r\nfor (i = 0; i < TPS6507X_NUM_REGULATOR; i++, info++, init_data++) {\r\ntps->info[i] = info;\r\nif (init_data->driver_data) {\r\nstruct tps6507x_reg_platform_data *data =\r\ninit_data->driver_data;\r\ntps->info[i]->defdcdc_default = data->defdcdc_default;\r\n}\r\ntps->desc[i].name = info->name;\r\ntps->desc[i].id = i;\r\ntps->desc[i].n_voltages = info->table_len;\r\ntps->desc[i].volt_table = info->table;\r\ntps->desc[i].ops = &tps6507x_pmic_ops;\r\ntps->desc[i].type = REGULATOR_VOLTAGE;\r\ntps->desc[i].owner = THIS_MODULE;\r\nconfig.dev = tps6507x_dev->dev;\r\nconfig.init_data = init_data;\r\nconfig.driver_data = tps;\r\nif (tps6507x_reg_matches) {\r\nerror = of_property_read_u32(\r\ntps6507x_reg_matches[i].of_node,\r\n"ti,defdcdc_default", &prop);\r\nif (!error)\r\ntps->info[i]->defdcdc_default = prop;\r\nconfig.of_node = tps6507x_reg_matches[i].of_node;\r\n}\r\nrdev = devm_regulator_register(&pdev->dev, &tps->desc[i],\r\n&config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(tps6507x_dev->dev,\r\n"failed to register %s regulator\n",\r\npdev->name);\r\nreturn PTR_ERR(rdev);\r\n}\r\ntps->rdev[i] = rdev;\r\n}\r\ntps6507x_dev->pmic = tps;\r\nplatform_set_drvdata(pdev, tps6507x_dev);\r\nreturn 0;\r\n}\r\nstatic int __init tps6507x_pmic_init(void)\r\n{\r\nreturn platform_driver_register(&tps6507x_pmic_driver);\r\n}\r\nstatic void __exit tps6507x_pmic_cleanup(void)\r\n{\r\nplatform_driver_unregister(&tps6507x_pmic_driver);\r\n}

int mic_open(struct inode *inode, struct file *f)\r\n{\r\nstruct mic_vdev *mvdev;\r\nstruct mic_device *mdev = container_of(inode->i_cdev,\r\nstruct mic_device, cdev);\r\nmvdev = kzalloc(sizeof(*mvdev), GFP_KERNEL);\r\nif (!mvdev)\r\nreturn -ENOMEM;\r\ninit_waitqueue_head(&mvdev->waitq);\r\nINIT_LIST_HEAD(&mvdev->list);\r\nmvdev->mdev = mdev;\r\nmvdev->virtio_id = -1;\r\nf->private_data = mvdev;\r\nreturn 0;\r\n}\r\nint mic_release(struct inode *inode, struct file *f)\r\n{\r\nstruct mic_vdev *mvdev = (struct mic_vdev *)f->private_data;\r\nif (-1 != mvdev->virtio_id)\r\nmic_virtio_del_device(mvdev);\r\nf->private_data = NULL;\r\nkfree(mvdev);\r\nreturn 0;\r\n}\r\nlong mic_ioctl(struct file *f, unsigned int cmd, unsigned long arg)\r\n{\r\nstruct mic_vdev *mvdev = (struct mic_vdev *)f->private_data;\r\nvoid __user *argp = (void __user *)arg;\r\nint ret;\r\nswitch (cmd) {\r\ncase MIC_VIRTIO_ADD_DEVICE:\r\n{\r\nret = mic_virtio_add_device(mvdev, argp);\r\nif (ret < 0) {\r\ndev_err(mic_dev(mvdev),\r\n"%s %d errno ret %d\n",\r\n__func__, __LINE__, ret);\r\nreturn ret;\r\n}\r\nbreak;\r\n}\r\ncase MIC_VIRTIO_COPY_DESC:\r\n{\r\nstruct mic_copy_desc copy;\r\nret = mic_vdev_inited(mvdev);\r\nif (ret)\r\nreturn ret;\r\nif (copy_from_user(&copy, argp, sizeof(copy)))\r\nreturn -EFAULT;\r\ndev_dbg(mic_dev(mvdev),\r\n"%s %d === iovcnt 0x%x vr_idx 0x%x update_used %d\n",\r\n__func__, __LINE__, copy.iovcnt, copy.vr_idx,\r\ncopy.update_used);\r\nret = mic_virtio_copy_desc(mvdev, &copy);\r\nif (ret < 0) {\r\ndev_err(mic_dev(mvdev),\r\n"%s %d errno ret %d\n",\r\n__func__, __LINE__, ret);\r\nreturn ret;\r\n}\r\nif (copy_to_user(\r\n&((struct mic_copy_desc __user *)argp)->out_len,\r\n&copy.out_len, sizeof(copy.out_len))) {\r\ndev_err(mic_dev(mvdev), "%s %d errno ret %d\n",\r\n__func__, __LINE__, -EFAULT);\r\nreturn -EFAULT;\r\n}\r\nbreak;\r\n}\r\ncase MIC_VIRTIO_CONFIG_CHANGE:\r\n{\r\nret = mic_vdev_inited(mvdev);\r\nif (ret)\r\nreturn ret;\r\nret = mic_virtio_config_change(mvdev, argp);\r\nif (ret < 0) {\r\ndev_err(mic_dev(mvdev),\r\n"%s %d errno ret %d\n",\r\n__func__, __LINE__, ret);\r\nreturn ret;\r\n}\r\nbreak;\r\n}\r\ndefault:\r\nreturn -ENOIOCTLCMD;\r\n};\r\nreturn 0;\r\n}\r\nunsigned int mic_poll(struct file *f, poll_table *wait)\r\n{\r\nstruct mic_vdev *mvdev = (struct mic_vdev *)f->private_data;\r\nint mask = 0;\r\npoll_wait(f, &mvdev->waitq, wait);\r\nif (mic_vdev_inited(mvdev)) {\r\nmask = POLLERR;\r\n} else if (mvdev->poll_wake) {\r\nmvdev->poll_wake = 0;\r\nmask = POLLIN | POLLOUT;\r\n}\r\nreturn mask;\r\n}\r\nstatic inline int\r\nmic_query_offset(struct mic_vdev *mvdev, unsigned long offset,\r\nunsigned long *size, unsigned long *pa)\r\n{\r\nstruct mic_device *mdev = mvdev->mdev;\r\nunsigned long start = MIC_DP_SIZE;\r\nint i;\r\nif (!offset) {\r\n*pa = virt_to_phys(mdev->dp);\r\n*size = MIC_DP_SIZE;\r\nreturn 0;\r\n}\r\nfor (i = 0; i < mvdev->dd->num_vq; i++) {\r\nstruct mic_vringh *mvr = &mvdev->mvr[i];\r\nif (offset == start) {\r\n*pa = virt_to_phys(mvr->vring.va);\r\n*size = mvr->vring.len;\r\nreturn 0;\r\n}\r\nstart += mvr->vring.len;\r\n}\r\nreturn -1;\r\n}\r\nint\r\nmic_mmap(struct file *f, struct vm_area_struct *vma)\r\n{\r\nstruct mic_vdev *mvdev = (struct mic_vdev *)f->private_data;\r\nunsigned long offset = vma->vm_pgoff << PAGE_SHIFT;\r\nunsigned long pa, size = vma->vm_end - vma->vm_start, size_rem = size;\r\nint i, err;\r\nerr = mic_vdev_inited(mvdev);\r\nif (err)\r\nreturn err;\r\nif (vma->vm_flags & VM_WRITE)\r\nreturn -EACCES;\r\nwhile (size_rem) {\r\ni = mic_query_offset(mvdev, offset, &size, &pa);\r\nif (i < 0)\r\nreturn -EINVAL;\r\nerr = remap_pfn_range(vma, vma->vm_start + offset,\r\npa >> PAGE_SHIFT, size, vma->vm_page_prot);\r\nif (err)\r\nreturn err;\r\ndev_dbg(mic_dev(mvdev),\r\n"%s %d type %d size 0x%lx off 0x%lx pa 0x%lx vma 0x%lx\n",\r\n__func__, __LINE__, mvdev->virtio_id, size, offset,\r\npa, vma->vm_start + offset);\r\nsize_rem -= size;\r\noffset += size;\r\n}\r\nreturn 0;\r\n}

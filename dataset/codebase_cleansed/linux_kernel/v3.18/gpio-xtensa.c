static inline unsigned long enable_cp(unsigned long *cpenable)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nRSR_CPENABLE(*cpenable);\r\nWSR_CPENABLE(*cpenable | BIT(XCHAL_CP_ID_XTIOP));\r\nreturn flags;\r\n}\r\nstatic inline void disable_cp(unsigned long flags, unsigned long cpenable)\r\n{\r\nWSR_CPENABLE(cpenable);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic inline unsigned long enable_cp(unsigned long *cpenable)\r\n{\r\n*cpenable = 0;\r\nreturn 0;\r\n}\r\nstatic inline void disable_cp(unsigned long flags, unsigned long cpenable)\r\n{\r\n}\r\nstatic int xtensa_impwire_get_direction(struct gpio_chip *gc, unsigned offset)\r\n{\r\nreturn 1;\r\n}\r\nstatic int xtensa_impwire_get_value(struct gpio_chip *gc, unsigned offset)\r\n{\r\nunsigned long flags, saved_cpenable;\r\nu32 impwire;\r\nflags = enable_cp(&saved_cpenable);\r\n__asm__ __volatile__("read_impwire %0" : "=a" (impwire));\r\ndisable_cp(flags, saved_cpenable);\r\nreturn !!(impwire & BIT(offset));\r\n}\r\nstatic void xtensa_impwire_set_value(struct gpio_chip *gc, unsigned offset,\r\nint value)\r\n{\r\nBUG();\r\n}\r\nstatic int xtensa_expstate_get_direction(struct gpio_chip *gc, unsigned offset)\r\n{\r\nreturn 0;\r\n}\r\nstatic int xtensa_expstate_get_value(struct gpio_chip *gc, unsigned offset)\r\n{\r\nunsigned long flags, saved_cpenable;\r\nu32 expstate;\r\nflags = enable_cp(&saved_cpenable);\r\n__asm__ __volatile__("rur.expstate %0" : "=a" (expstate));\r\ndisable_cp(flags, saved_cpenable);\r\nreturn !!(expstate & BIT(offset));\r\n}\r\nstatic void xtensa_expstate_set_value(struct gpio_chip *gc, unsigned offset,\r\nint value)\r\n{\r\nunsigned long flags, saved_cpenable;\r\nu32 mask = BIT(offset);\r\nu32 val = value ? BIT(offset) : 0;\r\nflags = enable_cp(&saved_cpenable);\r\n__asm__ __volatile__("wrmsk_expstate %0, %1"\r\n:: "a" (val), "a" (mask));\r\ndisable_cp(flags, saved_cpenable);\r\n}\r\nstatic int xtensa_gpio_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nret = gpiochip_add(&impwire_chip);\r\nif (ret)\r\nreturn ret;\r\nreturn gpiochip_add(&expstate_chip);\r\n}\r\nstatic int __init xtensa_gpio_init(void)\r\n{\r\nstruct platform_device *pdev;\r\npdev = platform_device_register_simple("xtensa-gpio", 0, NULL, 0);\r\nif (IS_ERR(pdev))\r\nreturn PTR_ERR(pdev);\r\nreturn platform_driver_register(&xtensa_gpio_driver);\r\n}

phys_t __mips_cm_phys_base(void)\r\n{\r\nu32 config3 = read_c0_config3();\r\nu32 cmgcr;\r\nif (!(config3 & MIPS_CONF3_CMGCR))\r\nreturn 0;\r\ncmgcr = read_c0_cmgcrbase();\r\nreturn (cmgcr & MIPS_CMGCRF_BASE) << (36 - 32);\r\n}\r\nphys_t __mips_cm_l2sync_phys_base(void)\r\n{\r\nu32 base_reg;\r\nbase_reg = read_gcr_l2_only_sync_base();\r\nif (base_reg & CM_GCR_L2_ONLY_SYNC_BASE_SYNCEN_MSK)\r\nreturn base_reg & CM_GCR_L2_ONLY_SYNC_BASE_SYNCBASE_MSK;\r\nreturn mips_cm_phys_base() + MIPS_CM_GCR_SIZE;\r\n}\r\nstatic void mips_cm_probe_l2sync(void)\r\n{\r\nunsigned major_rev;\r\nphys_t addr;\r\nmajor_rev = (read_gcr_rev() & CM_GCR_REV_MAJOR_MSK) >>\r\nCM_GCR_REV_MAJOR_SHF;\r\nif (major_rev < 6)\r\nreturn;\r\naddr = mips_cm_l2sync_phys_base();\r\nBUG_ON((addr & CM_GCR_L2_ONLY_SYNC_BASE_SYNCBASE_MSK) != addr);\r\nif (!addr)\r\nreturn;\r\nwrite_gcr_l2_only_sync_base(addr | CM_GCR_L2_ONLY_SYNC_BASE_SYNCEN_MSK);\r\nmips_cm_l2sync_base = ioremap_nocache(addr, MIPS_CM_L2SYNC_SIZE);\r\n}\r\nint mips_cm_probe(void)\r\n{\r\nphys_t addr;\r\nu32 base_reg;\r\naddr = mips_cm_phys_base();\r\nBUG_ON((addr & CM_GCR_BASE_GCRBASE_MSK) != addr);\r\nif (!addr)\r\nreturn -ENODEV;\r\nmips_cm_base = ioremap_nocache(addr, MIPS_CM_GCR_SIZE);\r\nif (!mips_cm_base)\r\nreturn -ENXIO;\r\nbase_reg = read_gcr_base();\r\nif ((base_reg & CM_GCR_BASE_GCRBASE_MSK) != addr) {\r\npr_err("GCRs appear to have been moved (expected them at 0x%08lx)!\n",\r\n(unsigned long)addr);\r\nmips_cm_base = NULL;\r\nreturn -ENODEV;\r\n}\r\nbase_reg &= ~CM_GCR_BASE_CMDEFTGT_MSK;\r\nbase_reg |= CM_GCR_BASE_CMDEFTGT_MEM;\r\nwrite_gcr_base(base_reg);\r\nwrite_gcr_reg0_base(CM_GCR_REGn_BASE_BASEADDR_MSK);\r\nwrite_gcr_reg0_mask(CM_GCR_REGn_MASK_ADDRMASK_MSK);\r\nwrite_gcr_reg1_base(CM_GCR_REGn_BASE_BASEADDR_MSK);\r\nwrite_gcr_reg1_mask(CM_GCR_REGn_MASK_ADDRMASK_MSK);\r\nwrite_gcr_reg2_base(CM_GCR_REGn_BASE_BASEADDR_MSK);\r\nwrite_gcr_reg2_mask(CM_GCR_REGn_MASK_ADDRMASK_MSK);\r\nwrite_gcr_reg3_base(CM_GCR_REGn_BASE_BASEADDR_MSK);\r\nwrite_gcr_reg3_mask(CM_GCR_REGn_MASK_ADDRMASK_MSK);\r\nmips_cm_probe_l2sync();\r\nreturn 0;\r\n}

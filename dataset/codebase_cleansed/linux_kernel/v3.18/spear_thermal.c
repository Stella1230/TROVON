static inline int thermal_get_temp(struct thermal_zone_device *thermal,\r\nunsigned long *temp)\r\n{\r\nstruct spear_thermal_dev *stdev = thermal->devdata;\r\n*temp = (readl_relaxed(stdev->thermal_base) & 0x7F) * MD_FACTOR;\r\nreturn 0;\r\n}\r\nstatic int spear_thermal_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct thermal_zone_device *spear_thermal = platform_get_drvdata(pdev);\r\nstruct spear_thermal_dev *stdev = spear_thermal->devdata;\r\nunsigned int actual_mask = 0;\r\nactual_mask = readl_relaxed(stdev->thermal_base);\r\nwritel_relaxed(actual_mask & ~stdev->flags, stdev->thermal_base);\r\nclk_disable(stdev->clk);\r\ndev_info(dev, "Suspended.\n");\r\nreturn 0;\r\n}\r\nstatic int spear_thermal_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct thermal_zone_device *spear_thermal = platform_get_drvdata(pdev);\r\nstruct spear_thermal_dev *stdev = spear_thermal->devdata;\r\nunsigned int actual_mask = 0;\r\nint ret = 0;\r\nret = clk_enable(stdev->clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Can't enable clock\n");\r\nreturn ret;\r\n}\r\nactual_mask = readl_relaxed(stdev->thermal_base);\r\nwritel_relaxed(actual_mask | stdev->flags, stdev->thermal_base);\r\ndev_info(dev, "Resumed.\n");\r\nreturn 0;\r\n}\r\nstatic int spear_thermal_probe(struct platform_device *pdev)\r\n{\r\nstruct thermal_zone_device *spear_thermal = NULL;\r\nstruct spear_thermal_dev *stdev;\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct resource *res;\r\nint ret = 0, val;\r\nif (!np || !of_property_read_u32(np, "st,thermal-flags", &val)) {\r\ndev_err(&pdev->dev, "Failed: DT Pdata not passed\n");\r\nreturn -EINVAL;\r\n}\r\nstdev = devm_kzalloc(&pdev->dev, sizeof(*stdev), GFP_KERNEL);\r\nif (!stdev)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nstdev->thermal_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(stdev->thermal_base))\r\nreturn PTR_ERR(stdev->thermal_base);\r\nstdev->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(stdev->clk)) {\r\ndev_err(&pdev->dev, "Can't get clock\n");\r\nreturn PTR_ERR(stdev->clk);\r\n}\r\nret = clk_enable(stdev->clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Can't enable clock\n");\r\nreturn ret;\r\n}\r\nstdev->flags = val;\r\nwritel_relaxed(stdev->flags, stdev->thermal_base);\r\nspear_thermal = thermal_zone_device_register("spear_thermal", 0, 0,\r\nstdev, &ops, NULL, 0, 0);\r\nif (IS_ERR(spear_thermal)) {\r\ndev_err(&pdev->dev, "thermal zone device is NULL\n");\r\nret = PTR_ERR(spear_thermal);\r\ngoto disable_clk;\r\n}\r\nplatform_set_drvdata(pdev, spear_thermal);\r\ndev_info(&spear_thermal->device, "Thermal Sensor Loaded at: 0x%p.\n",\r\nstdev->thermal_base);\r\nreturn 0;\r\ndisable_clk:\r\nclk_disable(stdev->clk);\r\nreturn ret;\r\n}\r\nstatic int spear_thermal_exit(struct platform_device *pdev)\r\n{\r\nunsigned int actual_mask = 0;\r\nstruct thermal_zone_device *spear_thermal = platform_get_drvdata(pdev);\r\nstruct spear_thermal_dev *stdev = spear_thermal->devdata;\r\nthermal_zone_device_unregister(spear_thermal);\r\nactual_mask = readl_relaxed(stdev->thermal_base);\r\nwritel_relaxed(actual_mask & ~stdev->flags, stdev->thermal_base);\r\nclk_disable(stdev->clk);\r\nreturn 0;\r\n}

static void dm_CheckPbcGPIO(struct rtw_adapter *padapter)\r\n{\r\nu8 tmp1byte;\r\nu8 bPbcPressed = false;\r\nif (!padapter->registrypriv.hw_wps_pbc)\r\nreturn;\r\ntmp1byte = rtl8723au_read8(padapter, GPIO_IO_SEL);\r\ntmp1byte |= (HAL_8192C_HW_GPIO_WPS_BIT);\r\nrtl8723au_write8(padapter, GPIO_IO_SEL, tmp1byte);\r\ntmp1byte &= ~(HAL_8192C_HW_GPIO_WPS_BIT);\r\nrtl8723au_write8(padapter, GPIO_IN, tmp1byte);\r\ntmp1byte = rtl8723au_read8(padapter, GPIO_IO_SEL);\r\ntmp1byte &= ~(HAL_8192C_HW_GPIO_WPS_BIT);\r\nrtl8723au_write8(padapter, GPIO_IO_SEL, tmp1byte);\r\ntmp1byte = rtl8723au_read8(padapter, GPIO_IN);\r\nif (tmp1byte == 0xff)\r\nreturn;\r\nif (tmp1byte&HAL_8192C_HW_GPIO_WPS_BIT)\r\nbPbcPressed = true;\r\nif (bPbcPressed) {\r\nDBG_8723A("CheckPbcGPIO - PBC is pressed\n");\r\nif (padapter->pid[0] == 0) {\r\nreturn;\r\n}\r\nkill_pid(find_vpid(padapter->pid[0]), SIGUSR1, 1);\r\n}\r\n}\r\nvoid rtl8723a_init_dm_priv(struct rtw_adapter *Adapter)\r\n{\r\nstruct hal_data_8723a *pHalData = GET_HAL_DATA(Adapter);\r\nstruct dm_priv *pdmpriv = &pHalData->dmpriv;\r\nstruct dm_odm_t *pDM_Odm = &pHalData->odmpriv;\r\nu8 cut_ver, fab_ver;\r\nmemset(pdmpriv, 0, sizeof(struct dm_priv));\r\nmemset(pDM_Odm, 0, sizeof(*pDM_Odm));\r\npDM_Odm->Adapter = Adapter;\r\nODM_CmnInfoInit23a(pDM_Odm, ODM_CMNINFO_PLATFORM, 0x04);\r\nODM_CmnInfoInit23a(pDM_Odm, ODM_CMNINFO_INTERFACE, RTW_USB);\r\nODM_CmnInfoInit23a(pDM_Odm, ODM_CMNINFO_IC_TYPE, ODM_RTL8723A);\r\nif (IS_8723A_A_CUT(pHalData->VersionID)) {\r\nfab_ver = ODM_UMC;\r\ncut_ver = ODM_CUT_A;\r\n} else if (IS_8723A_B_CUT(pHalData->VersionID)) {\r\nfab_ver = ODM_UMC;\r\ncut_ver = ODM_CUT_B;\r\n} else {\r\nfab_ver = ODM_TSMC;\r\ncut_ver = ODM_CUT_A;\r\n}\r\nODM_CmnInfoInit23a(pDM_Odm, ODM_CMNINFO_FAB_VER, fab_ver);\r\nODM_CmnInfoInit23a(pDM_Odm, ODM_CMNINFO_CUT_VER, cut_ver);\r\nODM_CmnInfoInit23a(pDM_Odm, ODM_CMNINFO_MP_TEST_CHIP, IS_NORMAL_CHIP(pHalData->VersionID));\r\nODM_CmnInfoInit23a(pDM_Odm, ODM_CMNINFO_BOARD_TYPE, pHalData->BoardType);\r\nif (pHalData->BoardType == BOARD_USB_High_PA) {\r\nODM_CmnInfoInit23a(pDM_Odm, ODM_CMNINFO_EXT_LNA, true);\r\nODM_CmnInfoInit23a(pDM_Odm, ODM_CMNINFO_EXT_PA, true);\r\n}\r\nODM_CmnInfoInit23a(pDM_Odm, ODM_CMNINFO_PATCH_ID, pHalData->CustomerID);\r\nODM_CmnInfoInit23a(pDM_Odm, ODM_CMNINFO_BWIFI_TEST, Adapter->registrypriv.wifi_spec);\r\nif (pHalData->rf_type == RF_1T1R)\r\nODM_CmnInfoUpdate23a(pDM_Odm, ODM_CMNINFO_RF_TYPE, ODM_1T1R);\r\nelse if (pHalData->rf_type == RF_2T2R)\r\nODM_CmnInfoUpdate23a(pDM_Odm, ODM_CMNINFO_RF_TYPE, ODM_2T2R);\r\nelse if (pHalData->rf_type == RF_1T2R)\r\nODM_CmnInfoUpdate23a(pDM_Odm, ODM_CMNINFO_RF_TYPE, ODM_1T2R);\r\n}\r\nstatic void Update_ODM_ComInfo_8723a(struct rtw_adapter *Adapter)\r\n{\r\nstruct hal_data_8723a *pHalData = GET_HAL_DATA(Adapter);\r\nstruct dm_odm_t *pDM_Odm = &pHalData->odmpriv;\r\nstruct dm_priv *pdmpriv = &pHalData->dmpriv;\r\nint i;\r\npdmpriv->InitODMFlag = ODM_BB_DIG |\r\nODM_BB_RA_MASK |\r\nODM_BB_DYNAMIC_TXPWR |\r\nODM_BB_FA_CNT |\r\nODM_BB_RSSI_MONITOR |\r\nODM_BB_CCK_PD |\r\nODM_BB_PWR_SAVE |\r\nODM_MAC_EDCA_TURBO |\r\nODM_RF_TX_PWR_TRACK |\r\nODM_RF_CALIBRATION;\r\nrtl8723a_odm_support_ability_set(Adapter, DYNAMIC_ALL_FUNC_ENABLE);\r\nfor (i = 0; i < NUM_STA; i++)\r\nODM_CmnInfoPtrArrayHook23a(pDM_Odm, ODM_CMNINFO_STA_STATUS, i, NULL);\r\n}\r\nvoid rtl8723a_InitHalDm(struct rtw_adapter *Adapter)\r\n{\r\nstruct hal_data_8723a *pHalData = GET_HAL_DATA(Adapter);\r\nstruct dm_priv *pdmpriv = &pHalData->dmpriv;\r\nstruct dm_odm_t *pDM_Odm = &pHalData->odmpriv;\r\nu8 i;\r\nUpdate_ODM_ComInfo_8723a(Adapter);\r\nODM23a_DMInit(pDM_Odm);\r\nfor (i = 0; i < 32; i++)\r\npdmpriv->INIDATA_RATE[i] = rtl8723au_read8(Adapter, REG_INIDATA_RATE_SEL+i) & 0x3f;\r\n}\r\nvoid\r\nrtl8723a_HalDmWatchDog(\r\nstruct rtw_adapter *Adapter\r\n)\r\n{\r\nbool bFwCurrentInPSMode = false;\r\nbool bFwPSAwake = true;\r\nu8 bLinked = false;\r\nu8 hw_init_completed = false;\r\nstruct hal_data_8723a *pHalData = GET_HAL_DATA(Adapter);\r\nstruct dm_priv *pdmpriv = &pHalData->dmpriv;\r\nhw_init_completed = Adapter->hw_init_completed;\r\nif (hw_init_completed == false)\r\ngoto skip_dm;\r\nbFwCurrentInPSMode = Adapter->pwrctrlpriv.bFwCurrentInPSMode;\r\nbFwPSAwake = rtl8723a_get_fwlps_rf_on(Adapter);\r\nif (!bFwCurrentInPSMode && bFwPSAwake) {\r\nif (check_fwstate(&Adapter->mlmepriv, WIFI_STATION_STATE)) {\r\npdmpriv->INIDATA_RATE[0] = rtl8723au_read8(Adapter, REG_INIDATA_RATE_SEL) & 0x3f;\r\n} else {\r\nu8 i;\r\nfor (i = 1 ; i < (Adapter->stapriv.asoc_sta_count + 1); i++)\r\npdmpriv->INIDATA_RATE[i] = rtl8723au_read8(Adapter, (REG_INIDATA_RATE_SEL+i)) & 0x3f;\r\n}\r\n}\r\nif (rtw_linked_check(Adapter))\r\nbLinked = true;\r\nODM_CmnInfoUpdate23a(&pHalData->odmpriv, ODM_CMNINFO_LINK, bLinked);\r\nODM_DMWatchdog23a(Adapter);\r\nskip_dm:\r\ndm_CheckPbcGPIO(Adapter);\r\n}

static inline struct wm831x_gpio *to_wm831x_gpio(struct gpio_chip *chip)\r\n{\r\nreturn container_of(chip, struct wm831x_gpio, gpio_chip);\r\n}\r\nstatic int wm831x_gpio_direction_in(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct wm831x_gpio *wm831x_gpio = to_wm831x_gpio(chip);\r\nstruct wm831x *wm831x = wm831x_gpio->wm831x;\r\nint val = WM831X_GPN_DIR;\r\nif (wm831x->has_gpio_ena)\r\nval |= WM831X_GPN_TRI;\r\nreturn wm831x_set_bits(wm831x, WM831X_GPIO1_CONTROL + offset,\r\nWM831X_GPN_DIR | WM831X_GPN_TRI |\r\nWM831X_GPN_FN_MASK, val);\r\n}\r\nstatic int wm831x_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct wm831x_gpio *wm831x_gpio = to_wm831x_gpio(chip);\r\nstruct wm831x *wm831x = wm831x_gpio->wm831x;\r\nint ret;\r\nret = wm831x_reg_read(wm831x, WM831X_GPIO_LEVEL);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret & 1 << offset)\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic void wm831x_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nstruct wm831x_gpio *wm831x_gpio = to_wm831x_gpio(chip);\r\nstruct wm831x *wm831x = wm831x_gpio->wm831x;\r\nwm831x_set_bits(wm831x, WM831X_GPIO_LEVEL, 1 << offset,\r\nvalue << offset);\r\n}\r\nstatic int wm831x_gpio_direction_out(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nstruct wm831x_gpio *wm831x_gpio = to_wm831x_gpio(chip);\r\nstruct wm831x *wm831x = wm831x_gpio->wm831x;\r\nint val = 0;\r\nint ret;\r\nif (wm831x->has_gpio_ena)\r\nval |= WM831X_GPN_TRI;\r\nret = wm831x_set_bits(wm831x, WM831X_GPIO1_CONTROL + offset,\r\nWM831X_GPN_DIR | WM831X_GPN_TRI |\r\nWM831X_GPN_FN_MASK, val);\r\nif (ret < 0)\r\nreturn ret;\r\nwm831x_gpio_set(chip, offset, value);\r\nreturn 0;\r\n}\r\nstatic int wm831x_gpio_to_irq(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct wm831x_gpio *wm831x_gpio = to_wm831x_gpio(chip);\r\nstruct wm831x *wm831x = wm831x_gpio->wm831x;\r\nreturn irq_create_mapping(wm831x->irq_domain,\r\nWM831X_IRQ_GPIO_1 + offset);\r\n}\r\nstatic int wm831x_gpio_set_debounce(struct gpio_chip *chip, unsigned offset,\r\nunsigned debounce)\r\n{\r\nstruct wm831x_gpio *wm831x_gpio = to_wm831x_gpio(chip);\r\nstruct wm831x *wm831x = wm831x_gpio->wm831x;\r\nint reg = WM831X_GPIO1_CONTROL + offset;\r\nint ret, fn;\r\nret = wm831x_reg_read(wm831x, reg);\r\nif (ret < 0)\r\nreturn ret;\r\nswitch (ret & WM831X_GPN_FN_MASK) {\r\ncase 0:\r\ncase 1:\r\nbreak;\r\ndefault:\r\nreturn -EBUSY;\r\n}\r\nif (debounce >= 32 && debounce <= 64)\r\nfn = 0;\r\nelse if (debounce >= 4000 && debounce <= 8000)\r\nfn = 1;\r\nelse\r\nreturn -EINVAL;\r\nreturn wm831x_set_bits(wm831x, reg, WM831X_GPN_FN_MASK, fn);\r\n}\r\nstatic void wm831x_gpio_dbg_show(struct seq_file *s, struct gpio_chip *chip)\r\n{\r\nstruct wm831x_gpio *wm831x_gpio = to_wm831x_gpio(chip);\r\nstruct wm831x *wm831x = wm831x_gpio->wm831x;\r\nint i, tristated;\r\nfor (i = 0; i < chip->ngpio; i++) {\r\nint gpio = i + chip->base;\r\nint reg;\r\nconst char *label, *pull, *powerdomain;\r\nlabel = gpiochip_is_requested(chip, i);\r\nif (!label)\r\nlabel = "Unrequested";\r\nseq_printf(s, " gpio-%-3d (%-20.20s) ", gpio, label);\r\nreg = wm831x_reg_read(wm831x, WM831X_GPIO1_CONTROL + i);\r\nif (reg < 0) {\r\ndev_err(wm831x->dev,\r\n"GPIO control %d read failed: %d\n",\r\ngpio, reg);\r\nseq_printf(s, "\n");\r\ncontinue;\r\n}\r\nswitch (reg & WM831X_GPN_PULL_MASK) {\r\ncase WM831X_GPIO_PULL_NONE:\r\npull = "nopull";\r\nbreak;\r\ncase WM831X_GPIO_PULL_DOWN:\r\npull = "pulldown";\r\nbreak;\r\ncase WM831X_GPIO_PULL_UP:\r\npull = "pullup";\r\nbreak;\r\ndefault:\r\npull = "INVALID PULL";\r\nbreak;\r\n}\r\nswitch (i + 1) {\r\ncase 1 ... 3:\r\ncase 7 ... 9:\r\nif (reg & WM831X_GPN_PWR_DOM)\r\npowerdomain = "VPMIC";\r\nelse\r\npowerdomain = "DBVDD";\r\nbreak;\r\ncase 4 ... 6:\r\ncase 10 ... 12:\r\nif (reg & WM831X_GPN_PWR_DOM)\r\npowerdomain = "SYSVDD";\r\nelse\r\npowerdomain = "DBVDD";\r\nbreak;\r\ncase 13 ... 16:\r\npowerdomain = "TPVDD";\r\nbreak;\r\ndefault:\r\nBUG();\r\nbreak;\r\n}\r\ntristated = reg & WM831X_GPN_TRI;\r\nif (wm831x->has_gpio_ena)\r\ntristated = !tristated;\r\nseq_printf(s, " %s %s %s %s%s\n"\r\n" %s%s (0x%4x)\n",\r\nreg & WM831X_GPN_DIR ? "in" : "out",\r\nwm831x_gpio_get(chip, i) ? "high" : "low",\r\npull,\r\npowerdomain,\r\nreg & WM831X_GPN_POL ? "" : " inverted",\r\nreg & WM831X_GPN_OD ? "open-drain" : "CMOS",\r\ntristated ? " tristated" : "",\r\nreg);\r\n}\r\n}\r\nstatic int wm831x_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct wm831x *wm831x = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm831x_pdata *pdata = dev_get_platdata(wm831x->dev);\r\nstruct wm831x_gpio *wm831x_gpio;\r\nint ret;\r\nwm831x_gpio = devm_kzalloc(&pdev->dev, sizeof(*wm831x_gpio),\r\nGFP_KERNEL);\r\nif (wm831x_gpio == NULL)\r\nreturn -ENOMEM;\r\nwm831x_gpio->wm831x = wm831x;\r\nwm831x_gpio->gpio_chip = template_chip;\r\nwm831x_gpio->gpio_chip.ngpio = wm831x->num_gpio;\r\nwm831x_gpio->gpio_chip.dev = &pdev->dev;\r\nif (pdata && pdata->gpio_base)\r\nwm831x_gpio->gpio_chip.base = pdata->gpio_base;\r\nelse\r\nwm831x_gpio->gpio_chip.base = -1;\r\nret = gpiochip_add(&wm831x_gpio->gpio_chip);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Could not register gpiochip, %d\n", ret);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, wm831x_gpio);\r\nreturn ret;\r\n}\r\nstatic int wm831x_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct wm831x_gpio *wm831x_gpio = platform_get_drvdata(pdev);\r\ngpiochip_remove(&wm831x_gpio->gpio_chip);\r\nreturn 0;\r\n}\r\nstatic int __init wm831x_gpio_init(void)\r\n{\r\nreturn platform_driver_register(&wm831x_gpio_driver);\r\n}\r\nstatic void __exit wm831x_gpio_exit(void)\r\n{\r\nplatform_driver_unregister(&wm831x_gpio_driver);\r\n}

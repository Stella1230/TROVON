void BlinkTimerCallback(void *data)\r\n{\r\nstruct LED_871x *pLed = (struct LED_871x *)data;\r\nstruct adapter *padapter = pLed->padapter;\r\nif ((padapter->bSurpriseRemoved) || (padapter->bDriverStopped))\r\nreturn;\r\nschedule_work(&(pLed->BlinkWorkItem));\r\n}\r\nvoid BlinkWorkItemCallback(struct work_struct *work)\r\n{\r\nstruct LED_871x *pLed = container_of(work, struct LED_871x, BlinkWorkItem);\r\nBlinkHandler(pLed);\r\n}\r\nvoid ResetLedStatus(struct LED_871x *pLed)\r\n{\r\npLed->CurrLedState = RTW_LED_OFF;\r\npLed->bLedOn = false;\r\npLed->bLedBlinkInProgress = false;\r\npLed->bLedWPSBlinkInProgress = false;\r\npLed->BlinkTimes = 0;\r\npLed->BlinkingLedState = LED_UNKNOWN;\r\npLed->bLedNoLinkBlinkInProgress = false;\r\npLed->bLedLinkBlinkInProgress = false;\r\npLed->bLedStartToLinkBlinkInProgress = false;\r\npLed->bLedScanBlinkInProgress = false;\r\n}\r\nvoid InitLed871x(struct adapter *padapter, struct LED_871x *pLed)\r\n{\r\npLed->padapter = padapter;\r\nResetLedStatus(pLed);\r\n_init_timer(&(pLed->BlinkTimer), padapter->pnetdev, BlinkTimerCallback, pLed);\r\nINIT_WORK(&(pLed->BlinkWorkItem), BlinkWorkItemCallback);\r\n}\r\nvoid DeInitLed871x(struct LED_871x *pLed)\r\n{\r\ncancel_work_sync(&(pLed->BlinkWorkItem));\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\nResetLedStatus(pLed);\r\n}\r\nstatic void SwLedBlink1(struct LED_871x *pLed)\r\n{\r\nstruct adapter *padapter = pLed->padapter;\r\nstruct mlme_priv *pmlmepriv = &(padapter->mlmepriv);\r\nu8 bStopBlinking = false;\r\nif (pLed->BlinkingLedState == RTW_LED_ON) {\r\nSwLedOn(padapter, pLed);\r\nRT_TRACE(_module_rtl8712_led_c_, _drv_info_, ("Blinktimes (%d): turn on\n", pLed->BlinkTimes));\r\n} else {\r\nSwLedOff(padapter, pLed);\r\nRT_TRACE(_module_rtl8712_led_c_, _drv_info_, ("Blinktimes (%d): turn off\n", pLed->BlinkTimes));\r\n}\r\nif (padapter->pwrctrlpriv.rf_pwrstate != rf_on) {\r\nSwLedOff(padapter, pLed);\r\nResetLedStatus(pLed);\r\nreturn;\r\n}\r\nswitch (pLed->CurrLedState) {\r\ncase LED_BLINK_SLOWLY:\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_NO_LINK_INTERVAL_ALPHA);\r\nbreak;\r\ncase LED_BLINK_NORMAL:\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_LINK_INTERVAL_ALPHA);\r\nbreak;\r\ncase LED_BLINK_SCAN:\r\npLed->BlinkTimes--;\r\nif (pLed->BlinkTimes == 0)\r\nbStopBlinking = true;\r\nif (bStopBlinking) {\r\nif (check_fwstate(pmlmepriv, _FW_LINKED)) {\r\npLed->bLedLinkBlinkInProgress = true;\r\npLed->CurrLedState = LED_BLINK_NORMAL;\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_LINK_INTERVAL_ALPHA);\r\nRT_TRACE(_module_rtl8712_led_c_, _drv_info_, ("CurrLedState %d\n", pLed->CurrLedState));\r\n} else if (!check_fwstate(pmlmepriv, _FW_LINKED)) {\r\npLed->bLedNoLinkBlinkInProgress = true;\r\npLed->CurrLedState = LED_BLINK_SLOWLY;\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_NO_LINK_INTERVAL_ALPHA);\r\nRT_TRACE(_module_rtl8712_led_c_, _drv_info_, ("CurrLedState %d\n", pLed->CurrLedState));\r\n}\r\npLed->bLedScanBlinkInProgress = false;\r\n} else {\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_SCAN_INTERVAL_ALPHA);\r\n}\r\nbreak;\r\ncase LED_BLINK_TXRX:\r\npLed->BlinkTimes--;\r\nif (pLed->BlinkTimes == 0)\r\nbStopBlinking = true;\r\nif (bStopBlinking) {\r\nif (check_fwstate(pmlmepriv, _FW_LINKED)) {\r\npLed->bLedLinkBlinkInProgress = true;\r\npLed->CurrLedState = LED_BLINK_NORMAL;\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_LINK_INTERVAL_ALPHA);\r\nRT_TRACE(_module_rtl8712_led_c_, _drv_info_, ("CurrLedState %d\n", pLed->CurrLedState));\r\n} else if (!check_fwstate(pmlmepriv, _FW_LINKED)) {\r\npLed->bLedNoLinkBlinkInProgress = true;\r\npLed->CurrLedState = LED_BLINK_SLOWLY;\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_NO_LINK_INTERVAL_ALPHA);\r\nRT_TRACE(_module_rtl8712_led_c_, _drv_info_, ("CurrLedState %d\n", pLed->CurrLedState));\r\n}\r\npLed->BlinkTimes = 0;\r\npLed->bLedBlinkInProgress = false;\r\n} else {\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_FASTER_INTERVAL_ALPHA);\r\n}\r\nbreak;\r\ncase LED_BLINK_WPS:\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_SCAN_INTERVAL_ALPHA);\r\nbreak;\r\ncase LED_BLINK_WPS_STOP:\r\nif (pLed->BlinkingLedState == RTW_LED_ON)\r\nbStopBlinking = false;\r\nelse\r\nbStopBlinking = true;\r\nif (bStopBlinking) {\r\npLed->bLedLinkBlinkInProgress = true;\r\npLed->CurrLedState = LED_BLINK_NORMAL;\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_LINK_INTERVAL_ALPHA);\r\nRT_TRACE(_module_rtl8712_led_c_, _drv_info_, ("CurrLedState %d\n", pLed->CurrLedState));\r\npLed->bLedWPSBlinkInProgress = false;\r\n} else {\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_WPS_SUCESS_INTERVAL_ALPHA);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void SwLedControlMode1(struct adapter *padapter, enum LED_CTL_MODE LedAction)\r\n{\r\nstruct led_priv *ledpriv = &(padapter->ledpriv);\r\nstruct LED_871x *pLed = &(ledpriv->SwLed0);\r\nstruct mlme_priv *pmlmepriv = &(padapter->mlmepriv);\r\nswitch (LedAction) {\r\ncase LED_CTL_POWER_ON:\r\ncase LED_CTL_START_TO_LINK:\r\ncase LED_CTL_NO_LINK:\r\nif (!pLed->bLedNoLinkBlinkInProgress) {\r\nif (pLed->CurrLedState == LED_BLINK_SCAN || IS_LED_WPS_BLINKING(pLed))\r\nreturn;\r\nif (pLed->bLedLinkBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedLinkBlinkInProgress = false;\r\n}\r\nif (pLed->bLedBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedBlinkInProgress = false;\r\n}\r\npLed->bLedNoLinkBlinkInProgress = true;\r\npLed->CurrLedState = LED_BLINK_SLOWLY;\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_NO_LINK_INTERVAL_ALPHA);\r\n}\r\nbreak;\r\ncase LED_CTL_LINK:\r\nif (!pLed->bLedLinkBlinkInProgress) {\r\nif (pLed->CurrLedState == LED_BLINK_SCAN || IS_LED_WPS_BLINKING(pLed))\r\nreturn;\r\nif (pLed->bLedNoLinkBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedNoLinkBlinkInProgress = false;\r\n}\r\nif (pLed->bLedBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedBlinkInProgress = false;\r\n}\r\npLed->bLedLinkBlinkInProgress = true;\r\npLed->CurrLedState = LED_BLINK_NORMAL;\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_LINK_INTERVAL_ALPHA);\r\n}\r\nbreak;\r\ncase LED_CTL_SITE_SURVEY:\r\nif ((pmlmepriv->LinkDetectInfo.bBusyTraffic) && (check_fwstate(pmlmepriv, _FW_LINKED))) {\r\n;\r\n} else if (!pLed->bLedScanBlinkInProgress) {\r\nif (IS_LED_WPS_BLINKING(pLed))\r\nreturn;\r\nif (pLed->bLedNoLinkBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedNoLinkBlinkInProgress = false;\r\n}\r\nif (pLed->bLedLinkBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedLinkBlinkInProgress = false;\r\n}\r\nif (pLed->bLedBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedBlinkInProgress = false;\r\n}\r\npLed->bLedScanBlinkInProgress = true;\r\npLed->CurrLedState = LED_BLINK_SCAN;\r\npLed->BlinkTimes = 24;\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_SCAN_INTERVAL_ALPHA);\r\n}\r\nbreak;\r\ncase LED_CTL_TX:\r\ncase LED_CTL_RX:\r\nif (!pLed->bLedBlinkInProgress) {\r\nif (pLed->CurrLedState == LED_BLINK_SCAN || IS_LED_WPS_BLINKING(pLed))\r\nreturn;\r\nif (pLed->bLedNoLinkBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedNoLinkBlinkInProgress = false;\r\n}\r\nif (pLed->bLedLinkBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedLinkBlinkInProgress = false;\r\n}\r\npLed->bLedBlinkInProgress = true;\r\npLed->CurrLedState = LED_BLINK_TXRX;\r\npLed->BlinkTimes = 2;\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_FASTER_INTERVAL_ALPHA);\r\n}\r\nbreak;\r\ncase LED_CTL_START_WPS:\r\ncase LED_CTL_START_WPS_BOTTON:\r\nif (!pLed->bLedWPSBlinkInProgress) {\r\nif (pLed->bLedNoLinkBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedNoLinkBlinkInProgress = false;\r\n}\r\nif (pLed->bLedLinkBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedLinkBlinkInProgress = false;\r\n}\r\nif (pLed->bLedBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedBlinkInProgress = false;\r\n}\r\nif (pLed->bLedScanBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedScanBlinkInProgress = false;\r\n}\r\npLed->bLedWPSBlinkInProgress = true;\r\npLed->CurrLedState = LED_BLINK_WPS;\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_SCAN_INTERVAL_ALPHA);\r\n}\r\nbreak;\r\ncase LED_CTL_STOP_WPS:\r\nif (pLed->bLedNoLinkBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedNoLinkBlinkInProgress = false;\r\n}\r\nif (pLed->bLedLinkBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedLinkBlinkInProgress = false;\r\n}\r\nif (pLed->bLedBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedBlinkInProgress = false;\r\n}\r\nif (pLed->bLedScanBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedScanBlinkInProgress = false;\r\n}\r\nif (pLed->bLedWPSBlinkInProgress)\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\nelse\r\npLed->bLedWPSBlinkInProgress = true;\r\npLed->CurrLedState = LED_BLINK_WPS_STOP;\r\nif (pLed->bLedOn) {\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_WPS_SUCESS_INTERVAL_ALPHA);\r\n} else {\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), 0);\r\n}\r\nbreak;\r\ncase LED_CTL_STOP_WPS_FAIL:\r\nif (pLed->bLedWPSBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedWPSBlinkInProgress = false;\r\n}\r\npLed->bLedNoLinkBlinkInProgress = true;\r\npLed->CurrLedState = LED_BLINK_SLOWLY;\r\nif (pLed->bLedOn)\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nelse\r\npLed->BlinkingLedState = RTW_LED_ON;\r\n_set_timer(&(pLed->BlinkTimer), LED_BLINK_NO_LINK_INTERVAL_ALPHA);\r\nbreak;\r\ncase LED_CTL_POWER_OFF:\r\npLed->CurrLedState = RTW_LED_OFF;\r\npLed->BlinkingLedState = RTW_LED_OFF;\r\nif (pLed->bLedNoLinkBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedNoLinkBlinkInProgress = false;\r\n}\r\nif (pLed->bLedLinkBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedLinkBlinkInProgress = false;\r\n}\r\nif (pLed->bLedBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedBlinkInProgress = false;\r\n}\r\nif (pLed->bLedWPSBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedWPSBlinkInProgress = false;\r\n}\r\nif (pLed->bLedScanBlinkInProgress) {\r\ndel_timer_sync(&(pLed->BlinkTimer));\r\npLed->bLedScanBlinkInProgress = false;\r\n}\r\nSwLedOff(padapter, pLed);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nRT_TRACE(_module_rtl8712_led_c_, _drv_info_, ("Led %d\n", pLed->CurrLedState));\r\n}\r\nvoid BlinkHandler(struct LED_871x *pLed)\r\n{\r\nstruct adapter *padapter = pLed->padapter;\r\nif ((padapter->bSurpriseRemoved) || (padapter->bDriverStopped))\r\nreturn;\r\nSwLedBlink1(pLed);\r\n}\r\nvoid LedControl8188eu(struct adapter *padapter, enum LED_CTL_MODE LedAction)\r\n{\r\nstruct led_priv *ledpriv = &(padapter->ledpriv);\r\nif ((padapter->bSurpriseRemoved) || (padapter->bDriverStopped) ||\r\n(!padapter->hw_init_completed))\r\nreturn;\r\nif (!ledpriv->bRegUseLed)\r\nreturn;\r\nif ((padapter->pwrctrlpriv.rf_pwrstate != rf_on &&\r\npadapter->pwrctrlpriv.rfoff_reason > RF_CHANGE_BY_PS) &&\r\n(LedAction == LED_CTL_TX || LedAction == LED_CTL_RX ||\r\nLedAction == LED_CTL_SITE_SURVEY ||\r\nLedAction == LED_CTL_LINK ||\r\nLedAction == LED_CTL_NO_LINK ||\r\nLedAction == LED_CTL_POWER_ON))\r\nreturn;\r\nSwLedControlMode1(padapter, LedAction);\r\n}

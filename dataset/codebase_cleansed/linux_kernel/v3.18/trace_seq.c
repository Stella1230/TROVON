int trace_print_seq(struct seq_file *m, struct trace_seq *s)\r\n{\r\nunsigned int len = TRACE_SEQ_BUF_USED(s);\r\nint ret;\r\nret = seq_write(m, s->buffer, len);\r\nif (!ret)\r\ntrace_seq_init(s);\r\nreturn ret;\r\n}\r\nint trace_seq_printf(struct trace_seq *s, const char *fmt, ...)\r\n{\r\nunsigned int len = TRACE_SEQ_BUF_LEFT(s);\r\nva_list ap;\r\nint ret;\r\nif (s->full || !len)\r\nreturn 0;\r\nva_start(ap, fmt);\r\nret = vsnprintf(s->buffer + s->len, len, fmt, ap);\r\nva_end(ap);\r\nif (ret >= len) {\r\ns->full = 1;\r\nreturn 0;\r\n}\r\ns->len += ret;\r\nreturn 1;\r\n}\r\nint trace_seq_bitmask(struct trace_seq *s, const unsigned long *maskp,\r\nint nmaskbits)\r\n{\r\nunsigned int len = TRACE_SEQ_BUF_LEFT(s);\r\nint ret;\r\nif (s->full || !len)\r\nreturn 0;\r\nret = bitmap_scnprintf(s->buffer, len, maskp, nmaskbits);\r\ns->len += ret;\r\nreturn 1;\r\n}\r\nint trace_seq_vprintf(struct trace_seq *s, const char *fmt, va_list args)\r\n{\r\nunsigned int len = TRACE_SEQ_BUF_LEFT(s);\r\nint ret;\r\nif (s->full || !len)\r\nreturn 0;\r\nret = vsnprintf(s->buffer + s->len, len, fmt, args);\r\nif (ret >= len) {\r\ns->full = 1;\r\nreturn 0;\r\n}\r\ns->len += ret;\r\nreturn len;\r\n}\r\nint trace_seq_bprintf(struct trace_seq *s, const char *fmt, const u32 *binary)\r\n{\r\nunsigned int len = TRACE_SEQ_BUF_LEFT(s);\r\nint ret;\r\nif (s->full || !len)\r\nreturn 0;\r\nret = bstr_printf(s->buffer + s->len, len, fmt, binary);\r\nif (ret >= len) {\r\ns->full = 1;\r\nreturn 0;\r\n}\r\ns->len += ret;\r\nreturn len;\r\n}\r\nint trace_seq_puts(struct trace_seq *s, const char *str)\r\n{\r\nunsigned int len = strlen(str);\r\nif (s->full)\r\nreturn 0;\r\nif (len > TRACE_SEQ_BUF_LEFT(s)) {\r\ns->full = 1;\r\nreturn 0;\r\n}\r\nmemcpy(s->buffer + s->len, str, len);\r\ns->len += len;\r\nreturn len;\r\n}\r\nint trace_seq_putc(struct trace_seq *s, unsigned char c)\r\n{\r\nif (s->full)\r\nreturn 0;\r\nif (TRACE_SEQ_BUF_LEFT(s) < 1) {\r\ns->full = 1;\r\nreturn 0;\r\n}\r\ns->buffer[s->len++] = c;\r\nreturn 1;\r\n}\r\nint trace_seq_putmem(struct trace_seq *s, const void *mem, unsigned int len)\r\n{\r\nif (s->full)\r\nreturn 0;\r\nif (len > TRACE_SEQ_BUF_LEFT(s)) {\r\ns->full = 1;\r\nreturn 0;\r\n}\r\nmemcpy(s->buffer + s->len, mem, len);\r\ns->len += len;\r\nreturn len;\r\n}\r\nint trace_seq_path(struct trace_seq *s, const struct path *path)\r\n{\r\nunsigned char *p;\r\nif (s->full)\r\nreturn 0;\r\nif (TRACE_SEQ_BUF_LEFT(s) < 1) {\r\ns->full = 1;\r\nreturn 0;\r\n}\r\np = d_path(path, s->buffer + s->len, PAGE_SIZE - s->len);\r\nif (!IS_ERR(p)) {\r\np = mangle_path(s->buffer + s->len, p, "\n");\r\nif (p) {\r\ns->len = p - s->buffer;\r\nreturn 1;\r\n}\r\n} else {\r\ns->buffer[s->len++] = '?';\r\nreturn 1;\r\n}\r\ns->full = 1;\r\nreturn 0;\r\n}\r\nint trace_seq_to_user(struct trace_seq *s, char __user *ubuf, int cnt)\r\n{\r\nint len;\r\nint ret;\r\nif (!cnt)\r\nreturn 0;\r\nif (s->len <= s->readpos)\r\nreturn -EBUSY;\r\nlen = s->len - s->readpos;\r\nif (cnt > len)\r\ncnt = len;\r\nret = copy_to_user(ubuf, s->buffer + s->readpos, cnt);\r\nif (ret == cnt)\r\nreturn -EFAULT;\r\ncnt -= ret;\r\ns->readpos += cnt;\r\nreturn cnt;\r\n}

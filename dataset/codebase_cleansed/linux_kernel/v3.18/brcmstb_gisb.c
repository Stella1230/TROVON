static ssize_t gisb_arb_get_timeout(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct brcmstb_gisb_arb_device *gdev = platform_get_drvdata(pdev);\r\nu32 timeout;\r\nmutex_lock(&gdev->lock);\r\ntimeout = ioread32(gdev->base + ARB_TIMER);\r\nmutex_unlock(&gdev->lock);\r\nreturn sprintf(buf, "%d", timeout);\r\n}\r\nstatic ssize_t gisb_arb_set_timeout(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct brcmstb_gisb_arb_device *gdev = platform_get_drvdata(pdev);\r\nint val, ret;\r\nret = kstrtoint(buf, 10, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nif (val == 0 || val >= 0xffffffff)\r\nreturn -EINVAL;\r\nmutex_lock(&gdev->lock);\r\niowrite32(val, gdev->base + ARB_TIMER);\r\nmutex_unlock(&gdev->lock);\r\nreturn count;\r\n}\r\nstatic const char *\r\nbrcmstb_gisb_master_to_str(struct brcmstb_gisb_arb_device *gdev,\r\nu32 masters)\r\n{\r\nu32 mask = gdev->valid_mask & masters;\r\nif (hweight_long(mask) != 1)\r\nreturn NULL;\r\nreturn gdev->master_names[ffs(mask) - 1];\r\n}\r\nstatic int brcmstb_gisb_arb_decode_addr(struct brcmstb_gisb_arb_device *gdev,\r\nconst char *reason)\r\n{\r\nu32 cap_status;\r\nunsigned long arb_addr;\r\nu32 master;\r\nconst char *m_name;\r\nchar m_fmt[11];\r\ncap_status = ioread32(gdev->base + ARB_ERR_CAP_STATUS);\r\nif (!(cap_status & ARB_ERR_CAP_STATUS_VALID))\r\nreturn 1;\r\narb_addr = ioread32(gdev->base + ARB_ERR_CAP_ADDR) & 0xffffffff;\r\n#if (IS_ENABLED(CONFIG_PHYS_ADDR_T_64BIT))\r\narb_addr |= (u64)ioread32(gdev->base + ARB_ERR_CAP_HI_ADDR) << 32;\r\n#endif\r\nmaster = ioread32(gdev->base + ARB_ERR_CAP_MASTER);\r\nm_name = brcmstb_gisb_master_to_str(gdev, master);\r\nif (!m_name) {\r\nsnprintf(m_fmt, sizeof(m_fmt), "0x%08x", master);\r\nm_name = m_fmt;\r\n}\r\npr_crit("%s: %s at 0x%lx [%c %s], core: %s\n",\r\n__func__, reason, arb_addr,\r\ncap_status & ARB_ERR_CAP_STATUS_WRITE ? 'W' : 'R',\r\ncap_status & ARB_ERR_CAP_STATUS_TIMEOUT ? "timeout" : "",\r\nm_name);\r\niowrite32(ARB_ERR_CAP_CLEAR, gdev->base + ARB_ERR_CAP_CLR);\r\nreturn 0;\r\n}\r\nstatic int brcmstb_bus_error_handler(unsigned long addr, unsigned int fsr,\r\nstruct pt_regs *regs)\r\n{\r\nint ret = 0;\r\nstruct brcmstb_gisb_arb_device *gdev;\r\nlist_for_each_entry(gdev, &brcmstb_gisb_arb_device_list, next)\r\nret |= brcmstb_gisb_arb_decode_addr(gdev, "bus error");\r\nif (fsr & (1 << 10))\r\nregs->ARM_pc += 4;\r\nreturn ret;\r\n}\r\nvoid __init brcmstb_hook_fault_code(void)\r\n{\r\nhook_fault_code(22, brcmstb_bus_error_handler, SIGBUS, 0,\r\n"imprecise external abort");\r\n}\r\nstatic irqreturn_t brcmstb_gisb_timeout_handler(int irq, void *dev_id)\r\n{\r\nbrcmstb_gisb_arb_decode_addr(dev_id, "timeout");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t brcmstb_gisb_tea_handler(int irq, void *dev_id)\r\n{\r\nbrcmstb_gisb_arb_decode_addr(dev_id, "target abort");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int brcmstb_gisb_arb_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *dn = pdev->dev.of_node;\r\nstruct brcmstb_gisb_arb_device *gdev;\r\nstruct resource *r;\r\nint err, timeout_irq, tea_irq;\r\nunsigned int num_masters, j = 0;\r\nint i, first, last;\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ntimeout_irq = platform_get_irq(pdev, 0);\r\ntea_irq = platform_get_irq(pdev, 1);\r\ngdev = devm_kzalloc(&pdev->dev, sizeof(*gdev), GFP_KERNEL);\r\nif (!gdev)\r\nreturn -ENOMEM;\r\nmutex_init(&gdev->lock);\r\nINIT_LIST_HEAD(&gdev->next);\r\ngdev->base = devm_ioremap_resource(&pdev->dev, r);\r\nif (IS_ERR(gdev->base))\r\nreturn PTR_ERR(gdev->base);\r\nerr = devm_request_irq(&pdev->dev, timeout_irq,\r\nbrcmstb_gisb_timeout_handler, 0, pdev->name,\r\ngdev);\r\nif (err < 0)\r\nreturn err;\r\nerr = devm_request_irq(&pdev->dev, tea_irq,\r\nbrcmstb_gisb_tea_handler, 0, pdev->name,\r\ngdev);\r\nif (err < 0)\r\nreturn err;\r\nif (of_property_read_u32(dn, "brcm,gisb-arb-master-mask",\r\n&gdev->valid_mask))\r\ngdev->valid_mask = 0xffffffff;\r\nnum_masters = of_property_count_strings(dn,\r\n"brcm,gisb-arb-master-names");\r\nif (hweight_long(gdev->valid_mask) == num_masters) {\r\nfirst = ffs(gdev->valid_mask) - 1;\r\nlast = fls(gdev->valid_mask) - 1;\r\nfor (i = first; i < last; i++) {\r\nif (!(gdev->valid_mask & BIT(i)))\r\ncontinue;\r\nof_property_read_string_index(dn,\r\n"brcm,gisb-arb-master-names", j,\r\n&gdev->master_names[i]);\r\nj++;\r\n}\r\n}\r\nerr = sysfs_create_group(&pdev->dev.kobj, &gisb_arb_sysfs_attr_group);\r\nif (err)\r\nreturn err;\r\nplatform_set_drvdata(pdev, gdev);\r\nlist_add_tail(&gdev->next, &brcmstb_gisb_arb_device_list);\r\ndev_info(&pdev->dev, "registered mem: %p, irqs: %d, %d\n",\r\ngdev->base, timeout_irq, tea_irq);\r\nreturn 0;\r\n}\r\nstatic int __init brcm_gisb_driver_init(void)\r\n{\r\nreturn platform_driver_register(&brcmstb_gisb_arb_driver);\r\n}

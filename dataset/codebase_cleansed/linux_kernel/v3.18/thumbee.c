static inline unsigned long teehbr_read(void)\r\n{\r\nunsigned long v;\r\nasm("mrc p14, 6, %0, c1, c0, 0\n" : "=r" (v));\r\nreturn v;\r\n}\r\nstatic inline void teehbr_write(unsigned long v)\r\n{\r\nasm("mcr p14, 6, %0, c1, c0, 0\n" : : "r" (v));\r\n}\r\nstatic int thumbee_notifier(struct notifier_block *self, unsigned long cmd, void *t)\r\n{\r\nstruct thread_info *thread = t;\r\nswitch (cmd) {\r\ncase THREAD_NOTIFY_FLUSH:\r\nteehbr_write(0);\r\nbreak;\r\ncase THREAD_NOTIFY_SWITCH:\r\ncurrent_thread_info()->thumbee_state = teehbr_read();\r\nteehbr_write(thread->thumbee_state);\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init thumbee_init(void)\r\n{\r\nunsigned long pfr0;\r\nunsigned int cpu_arch = cpu_architecture();\r\nif (cpu_arch < CPU_ARCH_ARMv7)\r\nreturn 0;\r\npfr0 = read_cpuid_ext(CPUID_EXT_PFR0);\r\nif ((pfr0 & 0x0000f000) != 0x00001000)\r\nreturn 0;\r\nprintk(KERN_INFO "ThumbEE CPU extension supported.\n");\r\nelf_hwcap |= HWCAP_THUMBEE;\r\nthread_register_notifier(&thumbee_notifier_block);\r\nreturn 0;\r\n}

static int axi_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct axi_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nunsigned int mask, val;\r\nif (substream->stream == SNDRV_PCM_STREAM_CAPTURE)\r\nmask = AXI_I2S_CTRL_RX_EN;\r\nelse\r\nmask = AXI_I2S_CTRL_TX_EN;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nval = mask;\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nval = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nregmap_update_bits(i2s->regmap, AXI_I2S_REG_CTRL, mask, val);\r\nreturn 0;\r\n}\r\nstatic int axi_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\r\n{\r\nstruct axi_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nunsigned int bclk_div, word_size;\r\nunsigned int bclk_rate;\r\nbclk_rate = params_rate(params) * AXI_I2S_BITS_PER_FRAME;\r\nword_size = AXI_I2S_BITS_PER_FRAME / 2 - 1;\r\nbclk_div = DIV_ROUND_UP(clk_get_rate(i2s->clk_ref), bclk_rate) / 2 - 1;\r\nregmap_write(i2s->regmap, AXI_I2S_REG_CLK_CTRL, (word_size << 16) |\r\nbclk_div);\r\nreturn 0;\r\n}\r\nstatic int axi_i2s_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct axi_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nuint32_t mask;\r\nint ret;\r\nif (substream->stream == SNDRV_PCM_STREAM_CAPTURE)\r\nmask = AXI_I2S_RESET_RX_FIFO;\r\nelse\r\nmask = AXI_I2S_RESET_TX_FIFO;\r\nregmap_write(i2s->regmap, AXI_I2S_REG_RESET, mask);\r\nret = snd_pcm_hw_constraint_ratnums(substream->runtime, 0,\r\nSNDRV_PCM_HW_PARAM_RATE,\r\n&i2s->rate_constraints);\r\nif (ret)\r\nreturn ret;\r\nreturn clk_prepare_enable(i2s->clk_ref);\r\n}\r\nstatic void axi_i2s_shutdown(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct axi_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nclk_disable_unprepare(i2s->clk_ref);\r\n}\r\nstatic int axi_i2s_dai_probe(struct snd_soc_dai *dai)\r\n{\r\nstruct axi_i2s *i2s = snd_soc_dai_get_drvdata(dai);\r\nsnd_soc_dai_init_dma_data(dai, &i2s->playback_dma_data,\r\n&i2s->capture_dma_data);\r\nreturn 0;\r\n}\r\nstatic int axi_i2s_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct axi_i2s *i2s;\r\nvoid __iomem *base;\r\nint ret;\r\ni2s = devm_kzalloc(&pdev->dev, sizeof(*i2s), GFP_KERNEL);\r\nif (!i2s)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, i2s);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\ni2s->regmap = devm_regmap_init_mmio(&pdev->dev, base,\r\n&axi_i2s_regmap_config);\r\nif (IS_ERR(i2s->regmap))\r\nreturn PTR_ERR(i2s->regmap);\r\ni2s->clk = devm_clk_get(&pdev->dev, "axi");\r\nif (IS_ERR(i2s->clk))\r\nreturn PTR_ERR(i2s->clk);\r\ni2s->clk_ref = devm_clk_get(&pdev->dev, "ref");\r\nif (IS_ERR(i2s->clk_ref))\r\nreturn PTR_ERR(i2s->clk_ref);\r\nret = clk_prepare_enable(i2s->clk);\r\nif (ret)\r\nreturn ret;\r\ni2s->playback_dma_data.addr = res->start + AXI_I2S_REG_TX_FIFO;\r\ni2s->playback_dma_data.addr_width = 4;\r\ni2s->playback_dma_data.maxburst = 1;\r\ni2s->capture_dma_data.addr = res->start + AXI_I2S_REG_RX_FIFO;\r\ni2s->capture_dma_data.addr_width = 4;\r\ni2s->capture_dma_data.maxburst = 1;\r\ni2s->ratnum.num = clk_get_rate(i2s->clk_ref) / 2 / AXI_I2S_BITS_PER_FRAME;\r\ni2s->ratnum.den_step = 1;\r\ni2s->ratnum.den_min = 1;\r\ni2s->ratnum.den_max = 64;\r\ni2s->rate_constraints.rats = &i2s->ratnum;\r\ni2s->rate_constraints.nrats = 1;\r\nregmap_write(i2s->regmap, AXI_I2S_REG_RESET, AXI_I2S_RESET_GLOBAL);\r\nret = devm_snd_soc_register_component(&pdev->dev, &axi_i2s_component,\r\n&axi_i2s_dai, 1);\r\nif (ret)\r\ngoto err_clk_disable;\r\nret = devm_snd_dmaengine_pcm_register(&pdev->dev, NULL, 0);\r\nif (ret)\r\ngoto err_clk_disable;\r\nerr_clk_disable:\r\nclk_disable_unprepare(i2s->clk);\r\nreturn ret;\r\n}\r\nstatic int axi_i2s_dev_remove(struct platform_device *pdev)\r\n{\r\nstruct axi_i2s *i2s = platform_get_drvdata(pdev);\r\nclk_disable_unprepare(i2s->clk);\r\nreturn 0;\r\n}

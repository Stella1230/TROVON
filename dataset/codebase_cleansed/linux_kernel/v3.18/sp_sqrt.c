union ieee754sp ieee754sp_sqrt(union ieee754sp x)\r\n{\r\nint ix, s, q, m, t, i;\r\nunsigned int r;\r\nCOMPXSP;\r\nEXPLODEXSP;\r\nieee754_clearcx();\r\nFLUSHXSP;\r\nswitch (xc) {\r\ncase IEEE754_CLASS_QNAN:\r\nreturn ieee754sp_nanxcpt(x);\r\ncase IEEE754_CLASS_SNAN:\r\nieee754_setcx(IEEE754_INVALID_OPERATION);\r\nreturn ieee754sp_nanxcpt(ieee754sp_indef());\r\ncase IEEE754_CLASS_ZERO:\r\nreturn x;\r\ncase IEEE754_CLASS_INF:\r\nif (xs) {\r\nieee754_setcx(IEEE754_INVALID_OPERATION);\r\nreturn ieee754sp_nanxcpt(ieee754sp_indef());\r\n}\r\nreturn x;\r\ncase IEEE754_CLASS_DNORM:\r\ncase IEEE754_CLASS_NORM:\r\nif (xs) {\r\nieee754_setcx(IEEE754_INVALID_OPERATION);\r\nreturn ieee754sp_nanxcpt(ieee754sp_indef());\r\n}\r\nbreak;\r\n}\r\nix = x.bits;\r\nm = (ix >> 23);\r\nif (m == 0) {\r\nfor (i = 0; (ix & 0x00800000) == 0; i++)\r\nix <<= 1;\r\nm -= i - 1;\r\n}\r\nm -= 127;\r\nix = (ix & 0x007fffff) | 0x00800000;\r\nif (m & 1)\r\nix += ix;\r\nm >>= 1;\r\nix += ix;\r\nq = s = 0;\r\nr = 0x01000000;\r\nwhile (r != 0) {\r\nt = s + r;\r\nif (t <= ix) {\r\ns = t + r;\r\nix -= t;\r\nq += r;\r\n}\r\nix += ix;\r\nr >>= 1;\r\n}\r\nif (ix != 0) {\r\nieee754_setcx(IEEE754_INEXACT);\r\nswitch (ieee754_csr.rm) {\r\ncase FPU_CSR_RU:\r\nq += 2;\r\nbreak;\r\ncase FPU_CSR_RN:\r\nq += (q & 1);\r\nbreak;\r\n}\r\n}\r\nix = (q >> 1) + 0x3f000000;\r\nix += (m << 23);\r\nx.bits = ix;\r\nreturn x;\r\n}

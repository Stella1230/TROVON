static void ohci_octeon_hw_start(void)\r\n{\r\nunion cvmx_uctlx_ohci_ctl ohci_ctl;\r\nocteon2_usb_clocks_start();\r\nohci_ctl.u64 = cvmx_read_csr(CVMX_UCTLX_OHCI_CTL(0));\r\nohci_ctl.s.l2c_addr_msb = 0;\r\nohci_ctl.s.l2c_buff_emod = 1;\r\nohci_ctl.s.l2c_desc_emod = 1;\r\ncvmx_write_csr(CVMX_UCTLX_OHCI_CTL(0), ohci_ctl.u64);\r\n}\r\nstatic void ohci_octeon_hw_stop(void)\r\n{\r\nocteon2_usb_clocks_stop();\r\n}\r\nstatic int ohci_octeon_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint ret;\r\nret = ohci_init(ohci);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ohci_run(ohci);\r\nif (ret < 0) {\r\nohci_err(ohci, "can't start %s", hcd->self.bus_name);\r\nohci_stop(hcd);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ohci_octeon_drv_probe(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd;\r\nstruct ohci_hcd *ohci;\r\nvoid *reg_base;\r\nstruct resource *res_mem;\r\nint irq;\r\nint ret;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "No irq assigned\n");\r\nreturn -ENODEV;\r\n}\r\nres_mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (res_mem == NULL) {\r\ndev_err(&pdev->dev, "No register space assigned\n");\r\nreturn -ENODEV;\r\n}\r\nret = dma_coerce_mask_and_coherent(&pdev->dev, DMA_BIT_MASK(32));\r\nif (ret)\r\nreturn ret;\r\nhcd = usb_create_hcd(&ohci_octeon_hc_driver, &pdev->dev, "octeon");\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nhcd->rsrc_start = res_mem->start;\r\nhcd->rsrc_len = resource_size(res_mem);\r\nreg_base = devm_ioremap_resource(&pdev->dev, res_mem);\r\nif (IS_ERR(reg_base)) {\r\nret = PTR_ERR(reg_base);\r\ngoto err1;\r\n}\r\nohci_octeon_hw_start();\r\nhcd->regs = reg_base;\r\nohci = hcd_to_ohci(hcd);\r\n#ifdef __BIG_ENDIAN\r\nohci->flags |= OHCI_QUIRK_BE_MMIO;\r\n#endif\r\nohci_hcd_init(ohci);\r\nret = usb_add_hcd(hcd, irq, IRQF_SHARED);\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "failed to add hcd with err %d\n", ret);\r\ngoto err2;\r\n}\r\ndevice_wakeup_enable(hcd->self.controller);\r\nplatform_set_drvdata(pdev, hcd);\r\nreturn 0;\r\nerr2:\r\nohci_octeon_hw_stop();\r\nerr1:\r\nusb_put_hcd(hcd);\r\nreturn ret;\r\n}\r\nstatic int ohci_octeon_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_remove_hcd(hcd);\r\nohci_octeon_hw_stop();\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}

static void palmas_usb_wakeup(struct palmas *palmas, int enable)\r\n{\r\nif (enable)\r\npalmas_write(palmas, PALMAS_USB_OTG_BASE, PALMAS_USB_WAKEUP,\r\nPALMAS_USB_WAKEUP_ID_WK_UP_COMP);\r\nelse\r\npalmas_write(palmas, PALMAS_USB_OTG_BASE, PALMAS_USB_WAKEUP, 0);\r\n}\r\nstatic irqreturn_t palmas_vbus_irq_handler(int irq, void *_palmas_usb)\r\n{\r\nstruct palmas_usb *palmas_usb = _palmas_usb;\r\nunsigned int vbus_line_state;\r\npalmas_read(palmas_usb->palmas, PALMAS_INTERRUPT_BASE,\r\nPALMAS_INT3_LINE_STATE, &vbus_line_state);\r\nif (vbus_line_state & PALMAS_INT3_LINE_STATE_VBUS) {\r\nif (palmas_usb->linkstat != PALMAS_USB_STATE_VBUS) {\r\npalmas_usb->linkstat = PALMAS_USB_STATE_VBUS;\r\nextcon_set_cable_state(palmas_usb->edev, "USB", true);\r\ndev_info(palmas_usb->dev, "USB cable is attached\n");\r\n} else {\r\ndev_dbg(palmas_usb->dev,\r\n"Spurious connect event detected\n");\r\n}\r\n} else if (!(vbus_line_state & PALMAS_INT3_LINE_STATE_VBUS)) {\r\nif (palmas_usb->linkstat == PALMAS_USB_STATE_VBUS) {\r\npalmas_usb->linkstat = PALMAS_USB_STATE_DISCONNECT;\r\nextcon_set_cable_state(palmas_usb->edev, "USB", false);\r\ndev_info(palmas_usb->dev, "USB cable is detached\n");\r\n} else {\r\ndev_dbg(palmas_usb->dev,\r\n"Spurious disconnect event detected\n");\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t palmas_id_irq_handler(int irq, void *_palmas_usb)\r\n{\r\nunsigned int set, id_src;\r\nstruct palmas_usb *palmas_usb = _palmas_usb;\r\npalmas_read(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\r\nPALMAS_USB_ID_INT_LATCH_SET, &set);\r\npalmas_read(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\r\nPALMAS_USB_ID_INT_SRC, &id_src);\r\nif ((set & PALMAS_USB_ID_INT_SRC_ID_GND) &&\r\n(id_src & PALMAS_USB_ID_INT_SRC_ID_GND)) {\r\npalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\r\nPALMAS_USB_ID_INT_LATCH_CLR,\r\nPALMAS_USB_ID_INT_EN_HI_CLR_ID_GND);\r\npalmas_usb->linkstat = PALMAS_USB_STATE_ID;\r\nextcon_set_cable_state(palmas_usb->edev, "USB-HOST", true);\r\ndev_info(palmas_usb->dev, "USB-HOST cable is attached\n");\r\n} else if ((set & PALMAS_USB_ID_INT_SRC_ID_FLOAT) &&\r\n(id_src & PALMAS_USB_ID_INT_SRC_ID_FLOAT)) {\r\npalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\r\nPALMAS_USB_ID_INT_LATCH_CLR,\r\nPALMAS_USB_ID_INT_EN_HI_CLR_ID_FLOAT);\r\npalmas_usb->linkstat = PALMAS_USB_STATE_DISCONNECT;\r\nextcon_set_cable_state(palmas_usb->edev, "USB-HOST", false);\r\ndev_info(palmas_usb->dev, "USB-HOST cable is detached\n");\r\n} else if ((palmas_usb->linkstat == PALMAS_USB_STATE_ID) &&\r\n(!(set & PALMAS_USB_ID_INT_SRC_ID_GND))) {\r\npalmas_usb->linkstat = PALMAS_USB_STATE_DISCONNECT;\r\nextcon_set_cable_state(palmas_usb->edev, "USB-HOST", false);\r\ndev_info(palmas_usb->dev, "USB-HOST cable is detached\n");\r\n} else if ((palmas_usb->linkstat == PALMAS_USB_STATE_DISCONNECT) &&\r\n(id_src & PALMAS_USB_ID_INT_SRC_ID_GND)) {\r\npalmas_usb->linkstat = PALMAS_USB_STATE_ID;\r\nextcon_set_cable_state(palmas_usb->edev, "USB-HOST", true);\r\ndev_info(palmas_usb->dev, " USB-HOST cable is attached\n");\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void palmas_enable_irq(struct palmas_usb *palmas_usb)\r\n{\r\npalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\r\nPALMAS_USB_VBUS_CTRL_SET,\r\nPALMAS_USB_VBUS_CTRL_SET_VBUS_ACT_COMP);\r\npalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\r\nPALMAS_USB_ID_CTRL_SET, PALMAS_USB_ID_CTRL_SET_ID_ACT_COMP);\r\npalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\r\nPALMAS_USB_ID_INT_EN_HI_SET,\r\nPALMAS_USB_ID_INT_EN_HI_SET_ID_GND |\r\nPALMAS_USB_ID_INT_EN_HI_SET_ID_FLOAT);\r\nif (palmas_usb->enable_vbus_detection)\r\npalmas_vbus_irq_handler(palmas_usb->vbus_irq, palmas_usb);\r\nif (palmas_usb->enable_id_detection) {\r\nmsleep(30);\r\npalmas_id_irq_handler(palmas_usb->id_irq, palmas_usb);\r\n}\r\n}\r\nstatic int palmas_usb_probe(struct platform_device *pdev)\r\n{\r\nstruct palmas *palmas = dev_get_drvdata(pdev->dev.parent);\r\nstruct palmas_usb_platform_data *pdata = dev_get_platdata(&pdev->dev);\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct palmas_usb *palmas_usb;\r\nint status;\r\npalmas_usb = devm_kzalloc(&pdev->dev, sizeof(*palmas_usb), GFP_KERNEL);\r\nif (!palmas_usb)\r\nreturn -ENOMEM;\r\nif (node && !pdata) {\r\npalmas_usb->wakeup = of_property_read_bool(node, "ti,wakeup");\r\npalmas_usb->enable_id_detection = of_property_read_bool(node,\r\n"ti,enable-id-detection");\r\npalmas_usb->enable_vbus_detection = of_property_read_bool(node,\r\n"ti,enable-vbus-detection");\r\n} else {\r\npalmas_usb->wakeup = true;\r\npalmas_usb->enable_id_detection = true;\r\npalmas_usb->enable_vbus_detection = true;\r\nif (pdata)\r\npalmas_usb->wakeup = pdata->wakeup;\r\n}\r\npalmas->usb = palmas_usb;\r\npalmas_usb->palmas = palmas;\r\npalmas_usb->dev = &pdev->dev;\r\npalmas_usb->id_otg_irq = regmap_irq_get_virq(palmas->irq_data,\r\nPALMAS_ID_OTG_IRQ);\r\npalmas_usb->id_irq = regmap_irq_get_virq(palmas->irq_data,\r\nPALMAS_ID_IRQ);\r\npalmas_usb->vbus_otg_irq = regmap_irq_get_virq(palmas->irq_data,\r\nPALMAS_VBUS_OTG_IRQ);\r\npalmas_usb->vbus_irq = regmap_irq_get_virq(palmas->irq_data,\r\nPALMAS_VBUS_IRQ);\r\npalmas_usb_wakeup(palmas, palmas_usb->wakeup);\r\nplatform_set_drvdata(pdev, palmas_usb);\r\npalmas_usb->edev = devm_extcon_dev_allocate(&pdev->dev,\r\npalmas_extcon_cable);\r\nif (IS_ERR(palmas_usb->edev)) {\r\ndev_err(&pdev->dev, "failed to allocate extcon device\n");\r\nreturn -ENOMEM;\r\n}\r\npalmas_usb->edev->name = kstrdup(node->name, GFP_KERNEL);\r\npalmas_usb->edev->mutually_exclusive = mutually_exclusive;\r\nstatus = devm_extcon_dev_register(&pdev->dev, palmas_usb->edev);\r\nif (status) {\r\ndev_err(&pdev->dev, "failed to register extcon device\n");\r\nkfree(palmas_usb->edev->name);\r\nreturn status;\r\n}\r\nif (palmas_usb->enable_id_detection) {\r\nstatus = devm_request_threaded_irq(palmas_usb->dev,\r\npalmas_usb->id_irq,\r\nNULL, palmas_id_irq_handler,\r\nIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING |\r\nIRQF_ONESHOT | IRQF_EARLY_RESUME,\r\n"palmas_usb_id", palmas_usb);\r\nif (status < 0) {\r\ndev_err(&pdev->dev, "can't get IRQ %d, err %d\n",\r\npalmas_usb->id_irq, status);\r\nkfree(palmas_usb->edev->name);\r\nreturn status;\r\n}\r\n}\r\nif (palmas_usb->enable_vbus_detection) {\r\nstatus = devm_request_threaded_irq(palmas_usb->dev,\r\npalmas_usb->vbus_irq, NULL,\r\npalmas_vbus_irq_handler,\r\nIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING |\r\nIRQF_ONESHOT | IRQF_EARLY_RESUME,\r\n"palmas_usb_vbus", palmas_usb);\r\nif (status < 0) {\r\ndev_err(&pdev->dev, "can't get IRQ %d, err %d\n",\r\npalmas_usb->vbus_irq, status);\r\nkfree(palmas_usb->edev->name);\r\nreturn status;\r\n}\r\n}\r\npalmas_enable_irq(palmas_usb);\r\ndevice_set_wakeup_capable(&pdev->dev, true);\r\nreturn 0;\r\n}\r\nstatic int palmas_usb_remove(struct platform_device *pdev)\r\n{\r\nstruct palmas_usb *palmas_usb = platform_get_drvdata(pdev);\r\nkfree(palmas_usb->edev->name);\r\nreturn 0;\r\n}\r\nstatic int palmas_usb_suspend(struct device *dev)\r\n{\r\nstruct palmas_usb *palmas_usb = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev)) {\r\nif (palmas_usb->enable_vbus_detection)\r\nenable_irq_wake(palmas_usb->vbus_irq);\r\nif (palmas_usb->enable_id_detection)\r\nenable_irq_wake(palmas_usb->id_irq);\r\n}\r\nreturn 0;\r\n}\r\nstatic int palmas_usb_resume(struct device *dev)\r\n{\r\nstruct palmas_usb *palmas_usb = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev)) {\r\nif (palmas_usb->enable_vbus_detection)\r\ndisable_irq_wake(palmas_usb->vbus_irq);\r\nif (palmas_usb->enable_id_detection)\r\ndisable_irq_wake(palmas_usb->id_irq);\r\n}\r\nreturn 0;\r\n}

static void ninja32_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstatic u16 pio_timing[5] = {\r\n0xd6, 0x85, 0x44, 0x33, 0x13\r\n};\r\niowrite8(pio_timing[adev->pio_mode - XFER_PIO_0],\r\nap->ioaddr.bmdma_addr + 0x1f);\r\nap->private_data = adev;\r\n}\r\nstatic void ninja32_dev_select(struct ata_port *ap, unsigned int device)\r\n{\r\nstruct ata_device *adev = &ap->link.device[device];\r\nif (ap->private_data != adev) {\r\niowrite8(0xd6, ap->ioaddr.bmdma_addr + 0x1f);\r\nata_sff_dev_select(ap, device);\r\nninja32_set_piomode(ap, adev);\r\n}\r\n}\r\nstatic void ninja32_program(void __iomem *base)\r\n{\r\niowrite8(0x05, base + 0x01);\r\niowrite8(0xBE, base + 0x02);\r\niowrite8(0x01, base + 0x03);\r\niowrite8(0x20, base + 0x04);\r\niowrite8(0x8f, base + 0x05);\r\niowrite8(0xa4, base + 0x1c);\r\niowrite8(0x83, base + 0x1d);\r\n}\r\nstatic int ninja32_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstruct ata_host *host;\r\nstruct ata_port *ap;\r\nvoid __iomem *base;\r\nint rc;\r\nhost = ata_host_alloc(&dev->dev, 1);\r\nif (!host)\r\nreturn -ENOMEM;\r\nap = host->ports[0];\r\nrc = pcim_enable_device(dev);\r\nif (rc)\r\nreturn rc;\r\nrc = pcim_iomap_regions(dev, 1 << 0, DRV_NAME);\r\nif (rc == -EBUSY)\r\npcim_pin_device(dev);\r\nif (rc)\r\nreturn rc;\r\nhost->iomap = pcim_iomap_table(dev);\r\nrc = pci_set_dma_mask(dev, ATA_DMA_MASK);\r\nif (rc)\r\nreturn rc;\r\nrc = pci_set_consistent_dma_mask(dev, ATA_DMA_MASK);\r\nif (rc)\r\nreturn rc;\r\npci_set_master(dev);\r\nbase = host->iomap[0];\r\nif (!base)\r\nreturn -ENOMEM;\r\nap->ops = &ninja32_port_ops;\r\nap->pio_mask = ATA_PIO4;\r\nap->flags |= ATA_FLAG_SLAVE_POSS;\r\nap->ioaddr.cmd_addr = base + 0x10;\r\nap->ioaddr.ctl_addr = base + 0x1E;\r\nap->ioaddr.altstatus_addr = base + 0x1E;\r\nap->ioaddr.bmdma_addr = base;\r\nata_sff_std_ports(&ap->ioaddr);\r\nap->pflags = ATA_PFLAG_PIO32 | ATA_PFLAG_PIO32CHANGE;\r\nninja32_program(base);\r\nreturn ata_host_activate(host, dev->irq, ata_bmdma_interrupt,\r\nIRQF_SHARED, &ninja32_sht);\r\n}\r\nstatic int ninja32_reinit_one(struct pci_dev *pdev)\r\n{\r\nstruct ata_host *host = pci_get_drvdata(pdev);\r\nint rc;\r\nrc = ata_pci_device_do_resume(pdev);\r\nif (rc)\r\nreturn rc;\r\nninja32_program(host->iomap[0]);\r\nata_host_resume(host);\r\nreturn 0;\r\n}

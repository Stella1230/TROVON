void *snd_lookup_oss_minor_data(unsigned int minor, int type)\r\n{\r\nstruct snd_minor *mreg;\r\nvoid *private_data;\r\nif (minor >= ARRAY_SIZE(snd_oss_minors))\r\nreturn NULL;\r\nmutex_lock(&sound_oss_mutex);\r\nmreg = snd_oss_minors[minor];\r\nif (mreg && mreg->type == type) {\r\nprivate_data = mreg->private_data;\r\nif (private_data && mreg->card_ptr)\r\nget_device(&mreg->card_ptr->card_dev);\r\n} else\r\nprivate_data = NULL;\r\nmutex_unlock(&sound_oss_mutex);\r\nreturn private_data;\r\n}\r\nstatic int snd_oss_kernel_minor(int type, struct snd_card *card, int dev)\r\n{\r\nint minor;\r\nswitch (type) {\r\ncase SNDRV_OSS_DEVICE_TYPE_MIXER:\r\nif (snd_BUG_ON(!card || dev < 0 || dev > 1))\r\nreturn -EINVAL;\r\nminor = SNDRV_MINOR_OSS(card->number, (dev ? SNDRV_MINOR_OSS_MIXER1 : SNDRV_MINOR_OSS_MIXER));\r\nbreak;\r\ncase SNDRV_OSS_DEVICE_TYPE_SEQUENCER:\r\nminor = SNDRV_MINOR_OSS_SEQUENCER;\r\nbreak;\r\ncase SNDRV_OSS_DEVICE_TYPE_MUSIC:\r\nminor = SNDRV_MINOR_OSS_MUSIC;\r\nbreak;\r\ncase SNDRV_OSS_DEVICE_TYPE_PCM:\r\nif (snd_BUG_ON(!card || dev < 0 || dev > 1))\r\nreturn -EINVAL;\r\nminor = SNDRV_MINOR_OSS(card->number, (dev ? SNDRV_MINOR_OSS_PCM1 : SNDRV_MINOR_OSS_PCM));\r\nbreak;\r\ncase SNDRV_OSS_DEVICE_TYPE_MIDI:\r\nif (snd_BUG_ON(!card || dev < 0 || dev > 1))\r\nreturn -EINVAL;\r\nminor = SNDRV_MINOR_OSS(card->number, (dev ? SNDRV_MINOR_OSS_MIDI1 : SNDRV_MINOR_OSS_MIDI));\r\nbreak;\r\ncase SNDRV_OSS_DEVICE_TYPE_DMFM:\r\nminor = SNDRV_MINOR_OSS(card->number, SNDRV_MINOR_OSS_DMFM);\r\nbreak;\r\ncase SNDRV_OSS_DEVICE_TYPE_SNDSTAT:\r\nminor = SNDRV_MINOR_OSS_SNDSTAT;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (minor < 0 || minor >= SNDRV_OSS_MINORS)\r\nreturn -EINVAL;\r\nreturn minor;\r\n}\r\nint snd_register_oss_device(int type, struct snd_card *card, int dev,\r\nconst struct file_operations *f_ops, void *private_data)\r\n{\r\nint minor = snd_oss_kernel_minor(type, card, dev);\r\nint minor_unit;\r\nstruct snd_minor *preg;\r\nint cidx = SNDRV_MINOR_OSS_CARD(minor);\r\nint track2 = -1;\r\nint register1 = -1, register2 = -1;\r\nstruct device *carddev = snd_card_get_device_link(card);\r\nif (card && card->number >= SNDRV_MINOR_OSS_DEVICES)\r\nreturn 0;\r\nif (minor < 0)\r\nreturn minor;\r\npreg = kmalloc(sizeof(struct snd_minor), GFP_KERNEL);\r\nif (preg == NULL)\r\nreturn -ENOMEM;\r\npreg->type = type;\r\npreg->card = card ? card->number : -1;\r\npreg->device = dev;\r\npreg->f_ops = f_ops;\r\npreg->private_data = private_data;\r\npreg->card_ptr = card;\r\nmutex_lock(&sound_oss_mutex);\r\nsnd_oss_minors[minor] = preg;\r\nminor_unit = SNDRV_MINOR_OSS_DEVICE(minor);\r\nswitch (minor_unit) {\r\ncase SNDRV_MINOR_OSS_PCM:\r\ntrack2 = SNDRV_MINOR_OSS(cidx, SNDRV_MINOR_OSS_AUDIO);\r\nbreak;\r\ncase SNDRV_MINOR_OSS_MIDI:\r\ntrack2 = SNDRV_MINOR_OSS(cidx, SNDRV_MINOR_OSS_DMMIDI);\r\nbreak;\r\ncase SNDRV_MINOR_OSS_MIDI1:\r\ntrack2 = SNDRV_MINOR_OSS(cidx, SNDRV_MINOR_OSS_DMMIDI1);\r\nbreak;\r\n}\r\nregister1 = register_sound_special_device(f_ops, minor, carddev);\r\nif (register1 != minor)\r\ngoto __end;\r\nif (track2 >= 0) {\r\nregister2 = register_sound_special_device(f_ops, track2,\r\ncarddev);\r\nif (register2 != track2)\r\ngoto __end;\r\nsnd_oss_minors[track2] = preg;\r\n}\r\nmutex_unlock(&sound_oss_mutex);\r\nreturn 0;\r\n__end:\r\nif (register2 >= 0)\r\nunregister_sound_special(register2);\r\nif (register1 >= 0)\r\nunregister_sound_special(register1);\r\nsnd_oss_minors[minor] = NULL;\r\nmutex_unlock(&sound_oss_mutex);\r\nkfree(preg);\r\nreturn -EBUSY;\r\n}\r\nint snd_unregister_oss_device(int type, struct snd_card *card, int dev)\r\n{\r\nint minor = snd_oss_kernel_minor(type, card, dev);\r\nint cidx = SNDRV_MINOR_OSS_CARD(minor);\r\nint track2 = -1;\r\nstruct snd_minor *mptr;\r\nif (card && card->number >= SNDRV_MINOR_OSS_DEVICES)\r\nreturn 0;\r\nif (minor < 0)\r\nreturn minor;\r\nmutex_lock(&sound_oss_mutex);\r\nmptr = snd_oss_minors[minor];\r\nif (mptr == NULL) {\r\nmutex_unlock(&sound_oss_mutex);\r\nreturn -ENOENT;\r\n}\r\nunregister_sound_special(minor);\r\nswitch (SNDRV_MINOR_OSS_DEVICE(minor)) {\r\ncase SNDRV_MINOR_OSS_PCM:\r\ntrack2 = SNDRV_MINOR_OSS(cidx, SNDRV_MINOR_OSS_AUDIO);\r\nbreak;\r\ncase SNDRV_MINOR_OSS_MIDI:\r\ntrack2 = SNDRV_MINOR_OSS(cidx, SNDRV_MINOR_OSS_DMMIDI);\r\nbreak;\r\ncase SNDRV_MINOR_OSS_MIDI1:\r\ntrack2 = SNDRV_MINOR_OSS(cidx, SNDRV_MINOR_OSS_DMMIDI1);\r\nbreak;\r\n}\r\nif (track2 >= 0) {\r\nunregister_sound_special(track2);\r\nsnd_oss_minors[track2] = NULL;\r\n}\r\nsnd_oss_minors[minor] = NULL;\r\nmutex_unlock(&sound_oss_mutex);\r\nkfree(mptr);\r\nreturn 0;\r\n}\r\nstatic const char *snd_oss_device_type_name(int type)\r\n{\r\nswitch (type) {\r\ncase SNDRV_OSS_DEVICE_TYPE_MIXER:\r\nreturn "mixer";\r\ncase SNDRV_OSS_DEVICE_TYPE_SEQUENCER:\r\ncase SNDRV_OSS_DEVICE_TYPE_MUSIC:\r\nreturn "sequencer";\r\ncase SNDRV_OSS_DEVICE_TYPE_PCM:\r\nreturn "digital audio";\r\ncase SNDRV_OSS_DEVICE_TYPE_MIDI:\r\nreturn "raw midi";\r\ncase SNDRV_OSS_DEVICE_TYPE_DMFM:\r\nreturn "hardware dependent";\r\ndefault:\r\nreturn "?";\r\n}\r\n}\r\nstatic void snd_minor_info_oss_read(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nint minor;\r\nstruct snd_minor *mptr;\r\nmutex_lock(&sound_oss_mutex);\r\nfor (minor = 0; minor < SNDRV_OSS_MINORS; ++minor) {\r\nif (!(mptr = snd_oss_minors[minor]))\r\ncontinue;\r\nif (mptr->card >= 0)\r\nsnd_iprintf(buffer, "%3i: [%i-%2i]: %s\n", minor,\r\nmptr->card, mptr->device,\r\nsnd_oss_device_type_name(mptr->type));\r\nelse\r\nsnd_iprintf(buffer, "%3i: : %s\n", minor,\r\nsnd_oss_device_type_name(mptr->type));\r\n}\r\nmutex_unlock(&sound_oss_mutex);\r\n}\r\nint __init snd_minor_info_oss_init(void)\r\n{\r\nstruct snd_info_entry *entry;\r\nentry = snd_info_create_module_entry(THIS_MODULE, "devices", snd_oss_root);\r\nif (entry) {\r\nentry->c.text.read = snd_minor_info_oss_read;\r\nif (snd_info_register(entry) < 0) {\r\nsnd_info_free_entry(entry);\r\nentry = NULL;\r\n}\r\n}\r\nsnd_minor_info_oss_entry = entry;\r\nreturn 0;\r\n}\r\nint __exit snd_minor_info_oss_done(void)\r\n{\r\nsnd_info_free_entry(snd_minor_info_oss_entry);\r\nreturn 0;\r\n}

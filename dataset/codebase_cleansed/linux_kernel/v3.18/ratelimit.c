int ___ratelimit(struct ratelimit_state *rs, const char *func)\r\n{\r\nunsigned long flags;\r\nint ret;\r\nif (!rs->interval)\r\nreturn 1;\r\nif (!raw_spin_trylock_irqsave(&rs->lock, flags))\r\nreturn 0;\r\nif (!rs->begin)\r\nrs->begin = jiffies;\r\nif (time_is_before_jiffies(rs->begin + rs->interval)) {\r\nif (rs->missed)\r\nprintk(KERN_WARNING "%s: %d callbacks suppressed\n",\r\nfunc, rs->missed);\r\nrs->begin = 0;\r\nrs->printed = 0;\r\nrs->missed = 0;\r\n}\r\nif (rs->burst && rs->burst > rs->printed) {\r\nrs->printed++;\r\nret = 1;\r\n} else {\r\nrs->missed++;\r\nret = 0;\r\n}\r\nraw_spin_unlock_irqrestore(&rs->lock, flags);\r\nreturn ret;\r\n}

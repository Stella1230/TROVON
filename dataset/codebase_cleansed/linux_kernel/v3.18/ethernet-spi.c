static irqreturn_t cvm_oct_spi_rml_interrupt(int cpl, void *dev_id)\r\n{\r\nirqreturn_t return_status = IRQ_NONE;\r\nunion cvmx_npi_rsl_int_blocks rsl_int_blocks;\r\nrsl_int_blocks.u64 = cvmx_read_csr(CVMX_NPI_RSL_INT_BLOCKS);\r\nif (rsl_int_blocks.s.spx1) {\r\nunion cvmx_spxx_int_reg spx_int_reg;\r\nunion cvmx_stxx_int_reg stx_int_reg;\r\nspx_int_reg.u64 = cvmx_read_csr(CVMX_SPXX_INT_REG(1));\r\ncvmx_write_csr(CVMX_SPXX_INT_REG(1), spx_int_reg.u64);\r\nif (!need_retrain[1]) {\r\nspx_int_reg.u64 &= cvmx_read_csr(CVMX_SPXX_INT_MSK(1));\r\nif (spx_int_reg.s.spf)\r\npr_err("SPI1: SRX Spi4 interface down\n");\r\nif (spx_int_reg.s.calerr)\r\npr_err("SPI1: SRX Spi4 Calendar table parity error\n");\r\nif (spx_int_reg.s.syncerr)\r\npr_err("SPI1: SRX Consecutive Spi4 DIP4 errors have exceeded SPX_ERR_CTL[ERRCNT]\n");\r\nif (spx_int_reg.s.diperr)\r\npr_err("SPI1: SRX Spi4 DIP4 error\n");\r\nif (spx_int_reg.s.tpaovr)\r\npr_err("SPI1: SRX Selected port has hit TPA overflow\n");\r\nif (spx_int_reg.s.rsverr)\r\npr_err("SPI1: SRX Spi4 reserved control word detected\n");\r\nif (spx_int_reg.s.drwnng)\r\npr_err("SPI1: SRX Spi4 receive FIFO drowning/overflow\n");\r\nif (spx_int_reg.s.clserr)\r\npr_err("SPI1: SRX Spi4 packet closed on non-16B alignment without EOP\n");\r\nif (spx_int_reg.s.spiovr)\r\npr_err("SPI1: SRX Spi4 async FIFO overflow\n");\r\nif (spx_int_reg.s.abnorm)\r\npr_err("SPI1: SRX Abnormal packet termination (ERR bit)\n");\r\nif (spx_int_reg.s.prtnxa)\r\npr_err("SPI1: SRX Port out of range\n");\r\n}\r\nstx_int_reg.u64 = cvmx_read_csr(CVMX_STXX_INT_REG(1));\r\ncvmx_write_csr(CVMX_STXX_INT_REG(1), stx_int_reg.u64);\r\nif (!need_retrain[1]) {\r\nstx_int_reg.u64 &= cvmx_read_csr(CVMX_STXX_INT_MSK(1));\r\nif (stx_int_reg.s.syncerr)\r\npr_err("SPI1: STX Interface encountered a fatal error\n");\r\nif (stx_int_reg.s.frmerr)\r\npr_err("SPI1: STX FRMCNT has exceeded STX_DIP_CNT[MAXFRM]\n");\r\nif (stx_int_reg.s.unxfrm)\r\npr_err("SPI1: STX Unexpected framing sequence\n");\r\nif (stx_int_reg.s.nosync)\r\npr_err("SPI1: STX ERRCNT has exceeded STX_DIP_CNT[MAXDIP]\n");\r\nif (stx_int_reg.s.diperr)\r\npr_err("SPI1: STX DIP2 error on the Spi4 Status channel\n");\r\nif (stx_int_reg.s.datovr)\r\npr_err("SPI1: STX Spi4 FIFO overflow error\n");\r\nif (stx_int_reg.s.ovrbst)\r\npr_err("SPI1: STX Transmit packet burst too big\n");\r\nif (stx_int_reg.s.calpar1)\r\npr_err("SPI1: STX Calendar Table Parity Error Bank1\n");\r\nif (stx_int_reg.s.calpar0)\r\npr_err("SPI1: STX Calendar Table Parity Error Bank0\n");\r\n}\r\ncvmx_write_csr(CVMX_SPXX_INT_MSK(1), 0);\r\ncvmx_write_csr(CVMX_STXX_INT_MSK(1), 0);\r\nneed_retrain[1] = 1;\r\nreturn_status = IRQ_HANDLED;\r\n}\r\nif (rsl_int_blocks.s.spx0) {\r\nunion cvmx_spxx_int_reg spx_int_reg;\r\nunion cvmx_stxx_int_reg stx_int_reg;\r\nspx_int_reg.u64 = cvmx_read_csr(CVMX_SPXX_INT_REG(0));\r\ncvmx_write_csr(CVMX_SPXX_INT_REG(0), spx_int_reg.u64);\r\nif (!need_retrain[0]) {\r\nspx_int_reg.u64 &= cvmx_read_csr(CVMX_SPXX_INT_MSK(0));\r\nif (spx_int_reg.s.spf)\r\npr_err("SPI0: SRX Spi4 interface down\n");\r\nif (spx_int_reg.s.calerr)\r\npr_err("SPI0: SRX Spi4 Calendar table parity error\n");\r\nif (spx_int_reg.s.syncerr)\r\npr_err("SPI0: SRX Consecutive Spi4 DIP4 errors have exceeded SPX_ERR_CTL[ERRCNT]\n");\r\nif (spx_int_reg.s.diperr)\r\npr_err("SPI0: SRX Spi4 DIP4 error\n");\r\nif (spx_int_reg.s.tpaovr)\r\npr_err("SPI0: SRX Selected port has hit TPA overflow\n");\r\nif (spx_int_reg.s.rsverr)\r\npr_err("SPI0: SRX Spi4 reserved control word detected\n");\r\nif (spx_int_reg.s.drwnng)\r\npr_err("SPI0: SRX Spi4 receive FIFO drowning/overflow\n");\r\nif (spx_int_reg.s.clserr)\r\npr_err("SPI0: SRX Spi4 packet closed on non-16B alignment without EOP\n");\r\nif (spx_int_reg.s.spiovr)\r\npr_err("SPI0: SRX Spi4 async FIFO overflow\n");\r\nif (spx_int_reg.s.abnorm)\r\npr_err("SPI0: SRX Abnormal packet termination (ERR bit)\n");\r\nif (spx_int_reg.s.prtnxa)\r\npr_err("SPI0: SRX Port out of range\n");\r\n}\r\nstx_int_reg.u64 = cvmx_read_csr(CVMX_STXX_INT_REG(0));\r\ncvmx_write_csr(CVMX_STXX_INT_REG(0), stx_int_reg.u64);\r\nif (!need_retrain[0]) {\r\nstx_int_reg.u64 &= cvmx_read_csr(CVMX_STXX_INT_MSK(0));\r\nif (stx_int_reg.s.syncerr)\r\npr_err("SPI0: STX Interface encountered a fatal error\n");\r\nif (stx_int_reg.s.frmerr)\r\npr_err("SPI0: STX FRMCNT has exceeded STX_DIP_CNT[MAXFRM]\n");\r\nif (stx_int_reg.s.unxfrm)\r\npr_err("SPI0: STX Unexpected framing sequence\n");\r\nif (stx_int_reg.s.nosync)\r\npr_err("SPI0: STX ERRCNT has exceeded STX_DIP_CNT[MAXDIP]\n");\r\nif (stx_int_reg.s.diperr)\r\npr_err("SPI0: STX DIP2 error on the Spi4 Status channel\n");\r\nif (stx_int_reg.s.datovr)\r\npr_err("SPI0: STX Spi4 FIFO overflow error\n");\r\nif (stx_int_reg.s.ovrbst)\r\npr_err("SPI0: STX Transmit packet burst too big\n");\r\nif (stx_int_reg.s.calpar1)\r\npr_err("SPI0: STX Calendar Table Parity Error Bank1\n");\r\nif (stx_int_reg.s.calpar0)\r\npr_err("SPI0: STX Calendar Table Parity Error Bank0\n");\r\n}\r\ncvmx_write_csr(CVMX_SPXX_INT_MSK(0), 0);\r\ncvmx_write_csr(CVMX_STXX_INT_MSK(0), 0);\r\nneed_retrain[0] = 1;\r\nreturn_status = IRQ_HANDLED;\r\n}\r\nreturn return_status;\r\n}\r\nstatic void cvm_oct_spi_enable_error_reporting(int interface)\r\n{\r\nunion cvmx_spxx_int_msk spxx_int_msk;\r\nunion cvmx_stxx_int_msk stxx_int_msk;\r\nspxx_int_msk.u64 = cvmx_read_csr(CVMX_SPXX_INT_MSK(interface));\r\nspxx_int_msk.s.calerr = 1;\r\nspxx_int_msk.s.syncerr = 1;\r\nspxx_int_msk.s.diperr = 1;\r\nspxx_int_msk.s.tpaovr = 1;\r\nspxx_int_msk.s.rsverr = 1;\r\nspxx_int_msk.s.drwnng = 1;\r\nspxx_int_msk.s.clserr = 1;\r\nspxx_int_msk.s.spiovr = 1;\r\nspxx_int_msk.s.abnorm = 1;\r\nspxx_int_msk.s.prtnxa = 1;\r\ncvmx_write_csr(CVMX_SPXX_INT_MSK(interface), spxx_int_msk.u64);\r\nstxx_int_msk.u64 = cvmx_read_csr(CVMX_STXX_INT_MSK(interface));\r\nstxx_int_msk.s.frmerr = 1;\r\nstxx_int_msk.s.unxfrm = 1;\r\nstxx_int_msk.s.nosync = 1;\r\nstxx_int_msk.s.diperr = 1;\r\nstxx_int_msk.s.datovr = 1;\r\nstxx_int_msk.s.ovrbst = 1;\r\nstxx_int_msk.s.calpar1 = 1;\r\nstxx_int_msk.s.calpar0 = 1;\r\ncvmx_write_csr(CVMX_STXX_INT_MSK(interface), stxx_int_msk.u64);\r\n}\r\nstatic void cvm_oct_spi_poll(struct net_device *dev)\r\n{\r\nstatic int spi4000_port;\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nint interface;\r\nfor (interface = 0; interface < 2; interface++) {\r\nif ((priv->port == interface * 16) && need_retrain[interface]) {\r\nif (cvmx_spi_restart_interface\r\n(interface, CVMX_SPI_MODE_DUPLEX, 10) == 0) {\r\nneed_retrain[interface] = 0;\r\ncvm_oct_spi_enable_error_reporting(interface);\r\n}\r\n}\r\nif (priv->port == spi4000_port) {\r\ncvmx_spi4000_check_speed(interface, priv->port);\r\nspi4000_port--;\r\nif (spi4000_port < 0)\r\nspi4000_port = 10;\r\n}\r\n}\r\n}\r\nint cvm_oct_spi_init(struct net_device *dev)\r\n{\r\nint r;\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nif (number_spi_ports == 0) {\r\nr = request_irq(OCTEON_IRQ_RML, cvm_oct_spi_rml_interrupt,\r\nIRQF_SHARED, "SPI", &number_spi_ports);\r\nif (r)\r\nreturn r;\r\n}\r\nnumber_spi_ports++;\r\nif ((priv->port == 0) || (priv->port == 16)) {\r\ncvm_oct_spi_enable_error_reporting(INTERFACE(priv->port));\r\npriv->poll = cvm_oct_spi_poll;\r\n}\r\ncvm_oct_common_init(dev);\r\nreturn 0;\r\n}\r\nvoid cvm_oct_spi_uninit(struct net_device *dev)\r\n{\r\nint interface;\r\ncvm_oct_common_uninit(dev);\r\nnumber_spi_ports--;\r\nif (number_spi_ports == 0) {\r\nfor (interface = 0; interface < 2; interface++) {\r\ncvmx_write_csr(CVMX_SPXX_INT_MSK(interface), 0);\r\ncvmx_write_csr(CVMX_STXX_INT_MSK(interface), 0);\r\n}\r\nfree_irq(OCTEON_IRQ_RML, &number_spi_ports);\r\n}\r\n}

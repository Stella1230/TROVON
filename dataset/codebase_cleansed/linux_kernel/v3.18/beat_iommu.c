static int __init find_dma_window(u64 *io_space_id, u64 *ioid,\r\nu64 *base, u64 *size, u64 *io_page_size)\r\n{\r\nstruct device_node *dn;\r\nconst unsigned long *dma_window;\r\nfor_each_node_by_type(dn, "ioif") {\r\ndma_window = of_get_property(dn, "toshiba,dma-window", NULL);\r\nif (dma_window) {\r\n*io_space_id = (dma_window[0] >> 32) & 0xffffffffUL;\r\n*ioid = dma_window[0] & 0x7ffUL;\r\n*base = dma_window[1];\r\n*size = dma_window[2];\r\n*io_page_size = 1 << dma_window[3];\r\nof_node_put(dn);\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void __init celleb_init_direct_mapping(void)\r\n{\r\nu64 lpar_addr, io_addr;\r\nu64 io_space_id, ioid, dma_base, dma_size, io_page_size;\r\nif (!find_dma_window(&io_space_id, &ioid, &dma_base, &dma_size,\r\n&io_page_size)) {\r\npr_info("No dma window found !\n");\r\nreturn;\r\n}\r\nfor (lpar_addr = 0; lpar_addr < dma_size; lpar_addr += io_page_size) {\r\nio_addr = lpar_addr + dma_base;\r\n(void)beat_put_iopte(io_space_id, io_addr, lpar_addr,\r\nioid, DMA_FLAGS);\r\n}\r\ncelleb_dma_direct_offset = dma_base;\r\n}\r\nstatic void celleb_dma_dev_setup(struct device *dev)\r\n{\r\nset_dma_ops(dev, &dma_direct_ops);\r\nset_dma_offset(dev, celleb_dma_direct_offset);\r\n}\r\nstatic void celleb_pci_dma_dev_setup(struct pci_dev *pdev)\r\n{\r\ncelleb_dma_dev_setup(&pdev->dev);\r\n}\r\nstatic int celleb_of_bus_notify(struct notifier_block *nb,\r\nunsigned long action, void *data)\r\n{\r\nstruct device *dev = data;\r\nif (action != BUS_NOTIFY_ADD_DEVICE)\r\nreturn 0;\r\ncelleb_dma_dev_setup(dev);\r\nreturn 0;\r\n}\r\nstatic int __init celleb_init_iommu(void)\r\n{\r\ncelleb_init_direct_mapping();\r\nppc_md.pci_dma_dev_setup = celleb_pci_dma_dev_setup;\r\nbus_register_notifier(&platform_bus_type, &celleb_of_bus_notifier);\r\nreturn 0;\r\n}

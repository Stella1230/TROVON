static int __init hangcheck_parse_tick(char *str)\r\n{\r\nint par;\r\nif (get_option(&str,&par))\r\nhangcheck_tick = par;\r\nreturn 1;\r\n}\r\nstatic int __init hangcheck_parse_margin(char *str)\r\n{\r\nint par;\r\nif (get_option(&str,&par))\r\nhangcheck_margin = par;\r\nreturn 1;\r\n}\r\nstatic int __init hangcheck_parse_reboot(char *str)\r\n{\r\nint par;\r\nif (get_option(&str,&par))\r\nhangcheck_reboot = par;\r\nreturn 1;\r\n}\r\nstatic int __init hangcheck_parse_dump_tasks(char *str)\r\n{\r\nint par;\r\nif (get_option(&str,&par))\r\nhangcheck_dump_tasks = par;\r\nreturn 1;\r\n}\r\nstatic void hangcheck_fire(unsigned long data)\r\n{\r\nunsigned long long cur_tsc, tsc_diff;\r\ncur_tsc = ktime_get_ns();\r\nif (cur_tsc > hangcheck_tsc)\r\ntsc_diff = cur_tsc - hangcheck_tsc;\r\nelse\r\ntsc_diff = (cur_tsc + (~0ULL - hangcheck_tsc));\r\nif (tsc_diff > hangcheck_tsc_margin) {\r\nif (hangcheck_dump_tasks) {\r\nprintk(KERN_CRIT "Hangcheck: Task state:\n");\r\n#ifdef CONFIG_MAGIC_SYSRQ\r\nhandle_sysrq('t');\r\n#endif\r\n}\r\nif (hangcheck_reboot) {\r\nprintk(KERN_CRIT "Hangcheck: hangcheck is restarting the machine.\n");\r\nemergency_restart();\r\n} else {\r\nprintk(KERN_CRIT "Hangcheck: hangcheck value past margin!\n");\r\n}\r\n}\r\n#if 0\r\nprintk("Hangcheck: called %Ld ns since last time (%Ld ns overshoot)\n",\r\ntsc_diff, tsc_diff - hangcheck_tick*TIMER_FREQ);\r\n#endif\r\nmod_timer(&hangcheck_ticktock, jiffies + (hangcheck_tick*HZ));\r\nhangcheck_tsc = ktime_get_ns();\r\n}\r\nstatic int __init hangcheck_init(void)\r\n{\r\nprintk("Hangcheck: starting hangcheck timer %s (tick is %d seconds, margin is %d seconds).\n",\r\nVERSION_STR, hangcheck_tick, hangcheck_margin);\r\nhangcheck_tsc_margin =\r\n(unsigned long long)(hangcheck_margin + hangcheck_tick);\r\nhangcheck_tsc_margin *= (unsigned long long)TIMER_FREQ;\r\nhangcheck_tsc = ktime_get_ns();\r\nmod_timer(&hangcheck_ticktock, jiffies + (hangcheck_tick*HZ));\r\nreturn 0;\r\n}\r\nstatic void __exit hangcheck_exit(void)\r\n{\r\ndel_timer_sync(&hangcheck_ticktock);\r\nprintk("Hangcheck: Stopped hangcheck timer.\n");\r\n}

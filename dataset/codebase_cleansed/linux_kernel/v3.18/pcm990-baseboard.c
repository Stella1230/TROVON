static u8 pcm990_cpld_readb(unsigned int reg)\r\n{\r\nreturn readb(pcm990_cpld_base + reg);\r\n}\r\nstatic void pcm990_cpld_writeb(u8 value, unsigned int reg)\r\n{\r\nwriteb(value, pcm990_cpld_base + reg);\r\n}\r\nstatic void pcm990_lcd_power(int on, struct fb_var_screeninfo *var)\r\n{\r\nif (on) {\r\npcm990_cpld_writeb(PCM990_CTRL_LCDPWR + PCM990_CTRL_LCDON,\r\nPCM990_CTRL_REG3);\r\n} else {\r\npcm990_cpld_writeb(0, PCM990_CTRL_REG3);\r\n}\r\n}\r\nstatic void pcm990_mask_ack_irq(struct irq_data *d)\r\n{\r\nint pcm990_irq = (d->irq - PCM027_IRQ(0));\r\npcm990_irq_enabled &= ~(1 << pcm990_irq);\r\npcm990_cpld_writeb(pcm990_irq_enabled, PCM990_CTRL_INTMSKENA);\r\n}\r\nstatic void pcm990_unmask_irq(struct irq_data *d)\r\n{\r\nint pcm990_irq = (d->irq - PCM027_IRQ(0));\r\nu8 val;\r\npcm990_irq_enabled |= (1 << pcm990_irq);\r\nval = pcm990_cpld_readb(PCM990_CTRL_INTSETCLR);\r\nval |= 1 << pcm990_irq;\r\npcm990_cpld_writeb(val, PCM990_CTRL_INTSETCLR);\r\npcm990_cpld_writeb(pcm990_irq_enabled, PCM990_CTRL_INTMSKENA);\r\n}\r\nstatic void pcm990_irq_handler(unsigned int irq, struct irq_desc *desc)\r\n{\r\nunsigned long pending;\r\npending = ~pcm990_cpld_readb(PCM990_CTRL_INTSETCLR);\r\npending &= pcm990_irq_enabled;\r\ndo {\r\ndesc->irq_data.chip->irq_ack(&desc->irq_data);\r\nif (likely(pending)) {\r\nirq = PCM027_IRQ(0) + __ffs(pending);\r\ngeneric_handle_irq(irq);\r\n}\r\npending = ~pcm990_cpld_readb(PCM990_CTRL_INTSETCLR);\r\npending &= pcm990_irq_enabled;\r\n} while (pending);\r\n}\r\nstatic void __init pcm990_init_irq(void)\r\n{\r\nint irq;\r\nfor (irq = PCM027_IRQ(0); irq <= PCM027_IRQ(3); irq++) {\r\nirq_set_chip_and_handler(irq, &pcm990_irq_chip,\r\nhandle_level_irq);\r\nset_irq_flags(irq, IRQF_VALID | IRQF_PROBE);\r\n}\r\npcm990_cpld_writeb(0x0, PCM990_CTRL_INTMSKENA);\r\npcm990_cpld_writeb(0xff, PCM990_CTRL_INTSETCLR);\r\nirq_set_chained_handler(PCM990_CTRL_INT_IRQ, pcm990_irq_handler);\r\nirq_set_irq_type(PCM990_CTRL_INT_IRQ, PCM990_CTRL_INT_IRQ_EDGE);\r\n}\r\nstatic int pcm990_mci_init(struct device *dev, irq_handler_t mci_detect_int,\r\nvoid *data)\r\n{\r\nint err;\r\nerr = request_irq(PCM027_MMCDET_IRQ, mci_detect_int, 0,\r\n"MMC card detect", data);\r\nif (err)\r\nprintk(KERN_ERR "pcm990_mci_init: MMC/SD: can't request MMC "\r\n"card detect IRQ\n");\r\nreturn err;\r\n}\r\nstatic int pcm990_mci_setpower(struct device *dev, unsigned int vdd)\r\n{\r\nstruct pxamci_platform_data *p_d = dev->platform_data;\r\nu8 val;\r\nval = pcm990_cpld_readb(PCM990_CTRL_REG5);\r\nif ((1 << vdd) & p_d->ocr_mask)\r\nval |= PCM990_CTRL_MMC2PWR;\r\nelse\r\nval &= ~PCM990_CTRL_MMC2PWR;\r\npcm990_cpld_writeb(PCM990_CTRL_MMC2PWR, PCM990_CTRL_REG5);\r\nreturn 0;\r\n}\r\nstatic void pcm990_mci_exit(struct device *dev, void *data)\r\n{\r\nfree_irq(PCM027_MMCDET_IRQ, data);\r\n}\r\nstatic int pcm990_camera_set_bus_param(struct soc_camera_link *link,\r\nunsigned long flags)\r\n{\r\nif (gpio_bus_switch < 0) {\r\nif (flags == SOCAM_DATAWIDTH_10)\r\nreturn 0;\r\nelse\r\nreturn -EINVAL;\r\n}\r\nif (flags & SOCAM_DATAWIDTH_8)\r\ngpio_set_value_cansleep(gpio_bus_switch, 1);\r\nelse\r\ngpio_set_value_cansleep(gpio_bus_switch, 0);\r\nreturn 0;\r\n}\r\nstatic unsigned long pcm990_camera_query_bus_param(struct soc_camera_link *link)\r\n{\r\nint ret;\r\nif (gpio_bus_switch < 0) {\r\nret = gpio_request(PXA_NR_BUILTIN_GPIO, "camera");\r\nif (!ret) {\r\ngpio_bus_switch = PXA_NR_BUILTIN_GPIO;\r\ngpio_direction_output(gpio_bus_switch, 0);\r\n}\r\n}\r\nif (gpio_bus_switch >= 0)\r\nreturn SOCAM_DATAWIDTH_8 | SOCAM_DATAWIDTH_10;\r\nelse\r\nreturn SOCAM_DATAWIDTH_10;\r\n}\r\nstatic void pcm990_camera_free_bus(struct soc_camera_link *link)\r\n{\r\nif (gpio_bus_switch < 0)\r\nreturn;\r\ngpio_free(gpio_bus_switch);\r\ngpio_bus_switch = -EINVAL;\r\n}\r\nvoid __init pcm990_baseboard_init(void)\r\n{\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(pcm990_pin_config));\r\npcm990_cpld_base = ioremap(PCM990_CTRL_PHYS, PCM990_CTRL_SIZE);\r\nif (!pcm990_cpld_base) {\r\npr_err("pcm990: failed to ioremap cpld\n");\r\nreturn;\r\n}\r\npcm990_init_irq();\r\n#ifndef CONFIG_PCM990_DISPLAY_NONE\r\npxa_set_fb_info(NULL, &pcm990_fbinfo);\r\n#endif\r\nplatform_device_register(&pcm990_backlight_device);\r\npxa_set_mci_info(&pcm990_mci_platform_data);\r\npxa_set_ohci_info(&pcm990_ohci_platform_data);\r\npxa_set_i2c_info(NULL);\r\npxa_set_ac97_info(NULL);\r\n#if defined(CONFIG_VIDEO_PXA27x) || defined(CONFIG_VIDEO_PXA27x_MODULE)\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(pcm990_camera_pin_config));\r\npxa_set_camera_info(&pcm990_pxacamera_platform_data);\r\ni2c_register_board_info(0, ARRAY_AND_SIZE(pcm990_i2c_devices));\r\nplatform_device_register(&pcm990_camera[0]);\r\nplatform_device_register(&pcm990_camera[1]);\r\n#endif\r\nprintk(KERN_INFO "PCM-990 Evaluation baseboard initialized\n");\r\n}

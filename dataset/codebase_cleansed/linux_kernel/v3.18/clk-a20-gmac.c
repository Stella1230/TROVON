static void __init sun7i_a20_gmac_clk_setup(struct device_node *node)\r\n{\r\nstruct clk *clk;\r\nstruct clk_mux *mux;\r\nstruct clk_gate *gate;\r\nconst char *clk_name = node->name;\r\nconst char *parents[SUN7I_A20_GMAC_PARENTS];\r\nvoid __iomem *reg;\r\nif (of_property_read_string(node, "clock-output-names", &clk_name))\r\nreturn;\r\nmux = kzalloc(sizeof(struct clk_mux), GFP_KERNEL);\r\nif (!mux)\r\nreturn;\r\ngate = kzalloc(sizeof(struct clk_gate), GFP_KERNEL);\r\nif (!gate)\r\ngoto free_mux;\r\nparents[0] = of_clk_get_parent_name(node, 0);\r\nparents[1] = of_clk_get_parent_name(node, 1);\r\nif (!parents[0] || !parents[1])\r\ngoto free_gate;\r\nreg = of_iomap(node, 0);\r\nif (!reg)\r\ngoto free_gate;\r\ngate->reg = reg;\r\ngate->bit_idx = SUN7I_A20_GMAC_GPIT;\r\ngate->lock = &gmac_lock;\r\nmux->reg = reg;\r\nmux->mask = SUN7I_A20_GMAC_MASK;\r\nmux->flags = CLK_MUX_INDEX_BIT;\r\nmux->lock = &gmac_lock;\r\nclk = clk_register_composite(NULL, clk_name,\r\nparents, SUN7I_A20_GMAC_PARENTS,\r\n&mux->hw, &clk_mux_ops,\r\nNULL, NULL,\r\n&gate->hw, &clk_gate_ops,\r\n0);\r\nif (IS_ERR(clk))\r\ngoto iounmap_reg;\r\nof_clk_add_provider(node, of_clk_src_simple_get, clk);\r\nclk_register_clkdev(clk, clk_name, NULL);\r\nreturn;\r\niounmap_reg:\r\niounmap(reg);\r\nfree_gate:\r\nkfree(gate);\r\nfree_mux:\r\nkfree(mux);\r\n}

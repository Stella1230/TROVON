static int lp8727_read_bytes(struct lp8727_chg *pchg, u8 reg, u8 *data, u8 len)\r\n{\r\ns32 ret;\r\nmutex_lock(&pchg->xfer_lock);\r\nret = i2c_smbus_read_i2c_block_data(pchg->client, reg, len, data);\r\nmutex_unlock(&pchg->xfer_lock);\r\nreturn (ret != len) ? -EIO : 0;\r\n}\r\nstatic inline int lp8727_read_byte(struct lp8727_chg *pchg, u8 reg, u8 *data)\r\n{\r\nreturn lp8727_read_bytes(pchg, reg, data, 1);\r\n}\r\nstatic int lp8727_write_byte(struct lp8727_chg *pchg, u8 reg, u8 data)\r\n{\r\nint ret;\r\nmutex_lock(&pchg->xfer_lock);\r\nret = i2c_smbus_write_byte_data(pchg->client, reg, data);\r\nmutex_unlock(&pchg->xfer_lock);\r\nreturn ret;\r\n}\r\nstatic bool lp8727_is_charger_attached(const char *name, int id)\r\n{\r\nif (!strcmp(name, "ac"))\r\nreturn id == LP8727_ID_TA || id == LP8727_ID_DEDICATED_CHG;\r\nelse if (!strcmp(name, "usb"))\r\nreturn id == LP8727_ID_USB_CHG;\r\nreturn id >= LP8727_ID_TA && id <= LP8727_ID_USB_CHG;\r\n}\r\nstatic int lp8727_init_device(struct lp8727_chg *pchg)\r\n{\r\nu8 val;\r\nint ret;\r\nu8 intstat[LP8788_NUM_INTREGS];\r\nret = lp8727_read_bytes(pchg, LP8727_INT1, intstat, LP8788_NUM_INTREGS);\r\nif (ret)\r\nreturn ret;\r\nval = LP8727_ID200_EN | LP8727_ADC_EN | LP8727_CP_EN;\r\nret = lp8727_write_byte(pchg, LP8727_CTRL1, val);\r\nif (ret)\r\nreturn ret;\r\nval = LP8727_INT_EN | LP8727_CHGDET_EN;\r\nreturn lp8727_write_byte(pchg, LP8727_CTRL2, val);\r\n}\r\nstatic int lp8727_is_dedicated_charger(struct lp8727_chg *pchg)\r\n{\r\nu8 val;\r\nlp8727_read_byte(pchg, LP8727_STATUS1, &val);\r\nreturn val & LP8727_DCPORT;\r\n}\r\nstatic int lp8727_is_usb_charger(struct lp8727_chg *pchg)\r\n{\r\nu8 val;\r\nlp8727_read_byte(pchg, LP8727_STATUS1, &val);\r\nreturn val & LP8727_CHPORT;\r\n}\r\nstatic inline void lp8727_ctrl_switch(struct lp8727_chg *pchg, u8 sw)\r\n{\r\nlp8727_write_byte(pchg, LP8727_SWCTRL, sw);\r\n}\r\nstatic void lp8727_id_detection(struct lp8727_chg *pchg, u8 id, int vbusin)\r\n{\r\nstruct lp8727_platform_data *pdata = pchg->pdata;\r\nu8 devid = LP8727_ID_NONE;\r\nu8 swctrl = LP8727_SW_DM1_HiZ | LP8727_SW_DP2_HiZ;\r\nswitch (id) {\r\ncase 0x5:\r\ndevid = LP8727_ID_TA;\r\npchg->chg_param = pdata ? pdata->ac : NULL;\r\nbreak;\r\ncase 0xB:\r\nif (lp8727_is_dedicated_charger(pchg)) {\r\npchg->chg_param = pdata ? pdata->ac : NULL;\r\ndevid = LP8727_ID_DEDICATED_CHG;\r\n} else if (lp8727_is_usb_charger(pchg)) {\r\npchg->chg_param = pdata ? pdata->usb : NULL;\r\ndevid = LP8727_ID_USB_CHG;\r\nswctrl = LP8727_SW_DM1_DM | LP8727_SW_DP2_DP;\r\n} else if (vbusin) {\r\ndevid = LP8727_ID_USB_DS;\r\nswctrl = LP8727_SW_DM1_DM | LP8727_SW_DP2_DP;\r\n}\r\nbreak;\r\ndefault:\r\ndevid = LP8727_ID_NONE;\r\npchg->chg_param = NULL;\r\nbreak;\r\n}\r\npchg->devid = devid;\r\nlp8727_ctrl_switch(pchg, swctrl);\r\n}\r\nstatic void lp8727_enable_chgdet(struct lp8727_chg *pchg)\r\n{\r\nu8 val;\r\nlp8727_read_byte(pchg, LP8727_CTRL2, &val);\r\nval |= LP8727_CHGDET_EN;\r\nlp8727_write_byte(pchg, LP8727_CTRL2, val);\r\n}\r\nstatic void lp8727_delayed_func(struct work_struct *_work)\r\n{\r\nstruct lp8727_chg *pchg = container_of(_work, struct lp8727_chg,\r\nwork.work);\r\nu8 intstat[LP8788_NUM_INTREGS];\r\nu8 idno;\r\nu8 vbus;\r\nif (lp8727_read_bytes(pchg, LP8727_INT1, intstat, LP8788_NUM_INTREGS)) {\r\ndev_err(pchg->dev, "can not read INT registers\n");\r\nreturn;\r\n}\r\nidno = intstat[0] & LP8727_IDNO;\r\nvbus = intstat[0] & LP8727_VBUS;\r\nlp8727_id_detection(pchg, idno, vbus);\r\nlp8727_enable_chgdet(pchg);\r\npower_supply_changed(&pchg->psy->ac);\r\npower_supply_changed(&pchg->psy->usb);\r\npower_supply_changed(&pchg->psy->batt);\r\n}\r\nstatic irqreturn_t lp8727_isr_func(int irq, void *ptr)\r\n{\r\nstruct lp8727_chg *pchg = ptr;\r\nschedule_delayed_work(&pchg->work, pchg->debounce_jiffies);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int lp8727_setup_irq(struct lp8727_chg *pchg)\r\n{\r\nint ret;\r\nint irq = pchg->client->irq;\r\nunsigned delay_msec = pchg->pdata ? pchg->pdata->debounce_msec :\r\nDEFAULT_DEBOUNCE_MSEC;\r\nINIT_DELAYED_WORK(&pchg->work, lp8727_delayed_func);\r\nif (irq <= 0) {\r\ndev_warn(pchg->dev, "invalid irq number: %d\n", irq);\r\nreturn 0;\r\n}\r\nret = request_threaded_irq(irq, NULL, lp8727_isr_func,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\n"lp8727_irq", pchg);\r\nif (ret)\r\nreturn ret;\r\npchg->irq = irq;\r\npchg->debounce_jiffies = msecs_to_jiffies(delay_msec);\r\nreturn 0;\r\n}\r\nstatic void lp8727_release_irq(struct lp8727_chg *pchg)\r\n{\r\ncancel_delayed_work_sync(&pchg->work);\r\nif (pchg->irq)\r\nfree_irq(pchg->irq, pchg);\r\n}\r\nstatic int lp8727_charger_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct lp8727_chg *pchg = dev_get_drvdata(psy->dev->parent);\r\nif (psp != POWER_SUPPLY_PROP_ONLINE)\r\nreturn -EINVAL;\r\nval->intval = lp8727_is_charger_attached(psy->name, pchg->devid);\r\nreturn 0;\r\n}\r\nstatic bool lp8727_is_high_temperature(enum lp8727_die_temp temp)\r\n{\r\nswitch (temp) {\r\ncase LP8788_TEMP_95C:\r\ncase LP8788_TEMP_115C:\r\ncase LP8788_TEMP_135C:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic int lp8727_battery_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct lp8727_chg *pchg = dev_get_drvdata(psy->dev->parent);\r\nstruct lp8727_platform_data *pdata = pchg->pdata;\r\nenum lp8727_die_temp temp;\r\nu8 read;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nif (!lp8727_is_charger_attached(psy->name, pchg->devid)) {\r\nval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\r\nreturn 0;\r\n}\r\nlp8727_read_byte(pchg, LP8727_STATUS1, &read);\r\nval->intval = (read & LP8727_CHGSTAT) == LP8727_STAT_EOC ?\r\nPOWER_SUPPLY_STATUS_FULL :\r\nPOWER_SUPPLY_STATUS_CHARGING;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nlp8727_read_byte(pchg, LP8727_STATUS2, &read);\r\ntemp = (read & LP8727_TEMP_STAT) >> LP8727_TEMP_SHIFT;\r\nval->intval = lp8727_is_high_temperature(temp) ?\r\nPOWER_SUPPLY_HEALTH_OVERHEAT :\r\nPOWER_SUPPLY_HEALTH_GOOD;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nif (!pdata)\r\nreturn -EINVAL;\r\nif (pdata->get_batt_present)\r\nval->intval = pdata->get_batt_present();\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nif (!pdata)\r\nreturn -EINVAL;\r\nif (pdata->get_batt_level)\r\nval->intval = pdata->get_batt_level();\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CAPACITY:\r\nif (!pdata)\r\nreturn -EINVAL;\r\nif (pdata->get_batt_capacity)\r\nval->intval = pdata->get_batt_capacity();\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP:\r\nif (!pdata)\r\nreturn -EINVAL;\r\nif (pdata->get_batt_temp)\r\nval->intval = pdata->get_batt_temp();\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic void lp8727_charger_changed(struct power_supply *psy)\r\n{\r\nstruct lp8727_chg *pchg = dev_get_drvdata(psy->dev->parent);\r\nu8 eoc_level;\r\nu8 ichg;\r\nu8 val;\r\nif (!lp8727_is_charger_attached(psy->name, pchg->devid))\r\nreturn;\r\nif (pchg->chg_param) {\r\neoc_level = pchg->chg_param->eoc_level;\r\nichg = pchg->chg_param->ichg;\r\nval = (ichg << LP8727_ICHG_SHIFT) | eoc_level;\r\nlp8727_write_byte(pchg, LP8727_CHGCTRL2, val);\r\n}\r\n}\r\nstatic int lp8727_register_psy(struct lp8727_chg *pchg)\r\n{\r\nstruct lp8727_psy *psy;\r\npsy = devm_kzalloc(pchg->dev, sizeof(*psy), GFP_KERNEL);\r\nif (!psy)\r\nreturn -ENOMEM;\r\npchg->psy = psy;\r\npsy->ac.name = "ac";\r\npsy->ac.type = POWER_SUPPLY_TYPE_MAINS;\r\npsy->ac.properties = lp8727_charger_prop;\r\npsy->ac.num_properties = ARRAY_SIZE(lp8727_charger_prop);\r\npsy->ac.get_property = lp8727_charger_get_property;\r\npsy->ac.supplied_to = battery_supplied_to;\r\npsy->ac.num_supplicants = ARRAY_SIZE(battery_supplied_to);\r\nif (power_supply_register(pchg->dev, &psy->ac))\r\ngoto err_psy_ac;\r\npsy->usb.name = "usb";\r\npsy->usb.type = POWER_SUPPLY_TYPE_USB;\r\npsy->usb.properties = lp8727_charger_prop;\r\npsy->usb.num_properties = ARRAY_SIZE(lp8727_charger_prop);\r\npsy->usb.get_property = lp8727_charger_get_property;\r\npsy->usb.supplied_to = battery_supplied_to;\r\npsy->usb.num_supplicants = ARRAY_SIZE(battery_supplied_to);\r\nif (power_supply_register(pchg->dev, &psy->usb))\r\ngoto err_psy_usb;\r\npsy->batt.name = "main_batt";\r\npsy->batt.type = POWER_SUPPLY_TYPE_BATTERY;\r\npsy->batt.properties = lp8727_battery_prop;\r\npsy->batt.num_properties = ARRAY_SIZE(lp8727_battery_prop);\r\npsy->batt.get_property = lp8727_battery_get_property;\r\npsy->batt.external_power_changed = lp8727_charger_changed;\r\nif (power_supply_register(pchg->dev, &psy->batt))\r\ngoto err_psy_batt;\r\nreturn 0;\r\nerr_psy_batt:\r\npower_supply_unregister(&psy->usb);\r\nerr_psy_usb:\r\npower_supply_unregister(&psy->ac);\r\nerr_psy_ac:\r\nreturn -EPERM;\r\n}\r\nstatic void lp8727_unregister_psy(struct lp8727_chg *pchg)\r\n{\r\nstruct lp8727_psy *psy = pchg->psy;\r\nif (!psy)\r\nreturn;\r\npower_supply_unregister(&psy->ac);\r\npower_supply_unregister(&psy->usb);\r\npower_supply_unregister(&psy->batt);\r\n}\r\nstatic struct lp8727_chg_param\r\n*lp8727_parse_charge_pdata(struct device *dev, struct device_node *np)\r\n{\r\nstruct lp8727_chg_param *param;\r\nparam = devm_kzalloc(dev, sizeof(*param), GFP_KERNEL);\r\nif (!param)\r\ngoto out;\r\nof_property_read_u8(np, "eoc-level", (u8 *)&param->eoc_level);\r\nof_property_read_u8(np, "charging-current", (u8 *)&param->ichg);\r\nout:\r\nreturn param;\r\n}\r\nstatic int lp8727_parse_dt(struct device *dev)\r\n{\r\nstruct device_node *np = dev->of_node;\r\nstruct device_node *child;\r\nstruct lp8727_platform_data *pdata;\r\nconst char *type;\r\nif (of_get_child_count(np) == 0)\r\ngoto out;\r\npdata = devm_kzalloc(dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\nof_property_read_u32(np, "debounce-ms", &pdata->debounce_msec);\r\nfor_each_child_of_node(np, child) {\r\nof_property_read_string(child, "charger-type", &type);\r\nif (!strcmp(type, "ac"))\r\npdata->ac = lp8727_parse_charge_pdata(dev, child);\r\nif (!strcmp(type, "usb"))\r\npdata->usb = lp8727_parse_charge_pdata(dev, child);\r\n}\r\ndev->platform_data = pdata;\r\nout:\r\nreturn 0;\r\n}\r\nstatic int lp8727_parse_dt(struct device *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int lp8727_probe(struct i2c_client *cl, const struct i2c_device_id *id)\r\n{\r\nstruct lp8727_chg *pchg;\r\nint ret;\r\nif (!i2c_check_functionality(cl->adapter, I2C_FUNC_SMBUS_I2C_BLOCK))\r\nreturn -EIO;\r\nif (cl->dev.of_node) {\r\nret = lp8727_parse_dt(&cl->dev);\r\nif (ret)\r\nreturn ret;\r\n}\r\npchg = devm_kzalloc(&cl->dev, sizeof(*pchg), GFP_KERNEL);\r\nif (!pchg)\r\nreturn -ENOMEM;\r\npchg->client = cl;\r\npchg->dev = &cl->dev;\r\npchg->pdata = cl->dev.platform_data;\r\ni2c_set_clientdata(cl, pchg);\r\nmutex_init(&pchg->xfer_lock);\r\nret = lp8727_init_device(pchg);\r\nif (ret) {\r\ndev_err(pchg->dev, "i2c communication err: %d", ret);\r\nreturn ret;\r\n}\r\nret = lp8727_register_psy(pchg);\r\nif (ret) {\r\ndev_err(pchg->dev, "power supplies register err: %d", ret);\r\nreturn ret;\r\n}\r\nret = lp8727_setup_irq(pchg);\r\nif (ret) {\r\ndev_err(pchg->dev, "irq handler err: %d", ret);\r\nlp8727_unregister_psy(pchg);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lp8727_remove(struct i2c_client *cl)\r\n{\r\nstruct lp8727_chg *pchg = i2c_get_clientdata(cl);\r\nlp8727_release_irq(pchg);\r\nlp8727_unregister_psy(pchg);\r\nreturn 0;\r\n}

void __gxio_dma_queue_init(__gxio_dma_queue_t *dma_queue,\r\nvoid *post_region_addr, unsigned int num_entries)\r\n{\r\nint64_t credits = (num_entries < 65536) ? num_entries : 65535;\r\nmemset(dma_queue, 0, sizeof(*dma_queue));\r\ndma_queue->post_region_addr = post_region_addr;\r\ndma_queue->hw_complete_count = 0;\r\ndma_queue->credits_and_next_index = credits << DMA_QUEUE_CREDIT_SHIFT;\r\n}\r\nvoid __gxio_dma_queue_update_credits(__gxio_dma_queue_t *dma_queue)\r\n{\r\n__gxio_ring_t val;\r\nuint64_t count;\r\nuint64_t delta;\r\nuint64_t new_count;\r\nuint64_t orig_hw_complete_count =\r\ncmpxchg(&dma_queue->hw_complete_count,\r\n-1, -1);\r\nwait_for_value(orig_hw_complete_count);\r\nval.word = __gxio_mmio_read(dma_queue->post_region_addr);\r\ncount = val.count;\r\ndelta = (count - orig_hw_complete_count) & 0xffff;\r\nif (delta == 0)\r\nreturn;\r\nnew_count = orig_hw_complete_count + delta;\r\nif (cmpxchg(&dma_queue->hw_complete_count,\r\norig_hw_complete_count,\r\nnew_count) != orig_hw_complete_count)\r\nreturn;\r\n__insn_fetchadd(&dma_queue->credits_and_next_index,\r\n(delta << DMA_QUEUE_CREDIT_SHIFT));\r\n}\r\nint64_t __gxio_dma_queue_wait_for_credits(__gxio_dma_queue_t *dma_queue,\r\nint64_t modifier)\r\n{\r\nint backoff = 16;\r\nint64_t old;\r\ndo {\r\nint i;\r\nfor (i = backoff; i > 0; i--)\r\n__insn_mfspr(SPR_PASS);\r\n__gxio_dma_queue_update_credits(dma_queue);\r\nold = __insn_fetchaddgez(&dma_queue->credits_and_next_index,\r\nmodifier);\r\nif (backoff < 256)\r\nbackoff *= 2;\r\n} while (old + modifier < 0);\r\nreturn old;\r\n}\r\nint64_t __gxio_dma_queue_reserve_aux(__gxio_dma_queue_t *dma_queue,\r\nunsigned int num, int wait)\r\n{\r\nreturn __gxio_dma_queue_reserve(dma_queue, num, wait != 0, true);\r\n}\r\nint __gxio_dma_queue_is_complete(__gxio_dma_queue_t *dma_queue,\r\nint64_t completion_slot, int update)\r\n{\r\nif (update) {\r\nif (ACCESS_ONCE(dma_queue->hw_complete_count) >\r\ncompletion_slot)\r\nreturn 1;\r\n__gxio_dma_queue_update_credits(dma_queue);\r\n}\r\nreturn ACCESS_ONCE(dma_queue->hw_complete_count) > completion_slot;\r\n}

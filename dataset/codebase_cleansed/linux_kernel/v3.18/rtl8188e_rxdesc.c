static void process_rssi(struct adapter *padapter, struct recv_frame *prframe)\r\n{\r\nstruct rx_pkt_attrib *pattrib = &prframe->attrib;\r\nstruct signal_stat *signal_stat = &padapter->recvpriv.signal_strength_data;\r\nif (signal_stat->update_req) {\r\nsignal_stat->total_num = 0;\r\nsignal_stat->total_val = 0;\r\nsignal_stat->update_req = 0;\r\n}\r\nsignal_stat->total_num++;\r\nsignal_stat->total_val += pattrib->phy_info.SignalStrength;\r\nsignal_stat->avg_val = signal_stat->total_val / signal_stat->total_num;\r\n}\r\nstatic void process_link_qual(struct adapter *padapter,\r\nstruct recv_frame *prframe)\r\n{\r\nstruct rx_pkt_attrib *pattrib;\r\nstruct signal_stat *signal_stat;\r\nif (prframe == NULL || padapter == NULL)\r\nreturn;\r\npattrib = &prframe->attrib;\r\nsignal_stat = &padapter->recvpriv.signal_qual_data;\r\nif (signal_stat->update_req) {\r\nsignal_stat->total_num = 0;\r\nsignal_stat->total_val = 0;\r\nsignal_stat->update_req = 0;\r\n}\r\nsignal_stat->total_num++;\r\nsignal_stat->total_val += pattrib->phy_info.SignalQuality;\r\nsignal_stat->avg_val = signal_stat->total_val / signal_stat->total_num;\r\n}\r\nvoid rtl8188e_process_phy_info(struct adapter *padapter, void *prframe)\r\n{\r\nstruct recv_frame *precvframe = (struct recv_frame *)prframe;\r\nprocess_rssi(padapter, precvframe);\r\nprocess_link_qual(padapter, precvframe);\r\n}\r\nvoid update_recvframe_attrib_88e(struct recv_frame *precvframe,\r\nstruct recv_stat *prxstat)\r\n{\r\nstruct rx_pkt_attrib *pattrib;\r\nstruct recv_stat report;\r\nreport.rxdw0 = prxstat->rxdw0;\r\nreport.rxdw1 = prxstat->rxdw1;\r\nreport.rxdw2 = prxstat->rxdw2;\r\nreport.rxdw3 = prxstat->rxdw3;\r\nreport.rxdw4 = prxstat->rxdw4;\r\nreport.rxdw5 = prxstat->rxdw5;\r\npattrib = &precvframe->attrib;\r\nmemset(pattrib, 0, sizeof(struct rx_pkt_attrib));\r\npattrib->crc_err = (u8)((le32_to_cpu(report.rxdw0) >> 14) & 0x1);\r\npattrib->pkt_rpt_type = (u8)((le32_to_cpu(report.rxdw3) >> 14) & 0x3);\r\nif (pattrib->pkt_rpt_type == NORMAL_RX) {\r\npattrib->pkt_len = (u16)(le32_to_cpu(report.rxdw0) & 0x00003fff);\r\npattrib->drvinfo_sz = (u8)((le32_to_cpu(report.rxdw0) >> 16) & 0xf) * 8;\r\npattrib->physt = (u8)((le32_to_cpu(report.rxdw0) >> 26) & 0x1);\r\npattrib->bdecrypted = (le32_to_cpu(report.rxdw0) & BIT(27)) ? 0 : 1;\r\npattrib->encrypt = (u8)((le32_to_cpu(report.rxdw0) >> 20) & 0x7);\r\npattrib->qos = (u8)((le32_to_cpu(report.rxdw0) >> 23) & 0x1);\r\npattrib->priority = (u8)((le32_to_cpu(report.rxdw1) >> 8) & 0xf);\r\npattrib->amsdu = (u8)((le32_to_cpu(report.rxdw1) >> 13) & 0x1);\r\npattrib->seq_num = (u16)(le32_to_cpu(report.rxdw2) & 0x00000fff);\r\npattrib->frag_num = (u8)((le32_to_cpu(report.rxdw2) >> 12) & 0xf);\r\npattrib->mfrag = (u8)((le32_to_cpu(report.rxdw1) >> 27) & 0x1);\r\npattrib->mdata = (u8)((le32_to_cpu(report.rxdw1) >> 26) & 0x1);\r\npattrib->mcs_rate = (u8)(le32_to_cpu(report.rxdw3) & 0x3f);\r\npattrib->rxht = (u8)((le32_to_cpu(report.rxdw3) >> 6) & 0x1);\r\npattrib->icv_err = (u8)((le32_to_cpu(report.rxdw0) >> 15) & 0x1);\r\npattrib->shift_sz = (u8)((le32_to_cpu(report.rxdw0) >> 24) & 0x3);\r\n} else if (pattrib->pkt_rpt_type == TX_REPORT1) {\r\npattrib->pkt_len = TX_RPT1_PKT_LEN;\r\npattrib->drvinfo_sz = 0;\r\n} else if (pattrib->pkt_rpt_type == TX_REPORT2) {\r\npattrib->pkt_len = (u16)(le32_to_cpu(report.rxdw0) & 0x3FF);\r\npattrib->drvinfo_sz = 0;\r\npattrib->MacIDValidEntry[0] = le32_to_cpu(report.rxdw4);\r\npattrib->MacIDValidEntry[1] = le32_to_cpu(report.rxdw5);\r\n} else if (pattrib->pkt_rpt_type == HIS_REPORT) {\r\npattrib->pkt_len = (u16)(le32_to_cpu(report.rxdw0) & 0x00003fff);\r\n}\r\n}\r\nvoid update_recvframe_phyinfo_88e(struct recv_frame *precvframe,\r\nstruct phy_stat *pphy_status)\r\n{\r\nstruct adapter *padapter = precvframe->adapter;\r\nstruct rx_pkt_attrib *pattrib = &precvframe->attrib;\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(padapter);\r\nstruct odm_phy_status_info *pPHYInfo = (struct odm_phy_status_info *)(&pattrib->phy_info);\r\nu8 *wlanhdr;\r\nstruct odm_per_pkt_info pkt_info;\r\nu8 *sa = NULL;\r\nstruct sta_priv *pstapriv;\r\nstruct sta_info *psta;\r\npkt_info.bPacketMatchBSSID = false;\r\npkt_info.bPacketToSelf = false;\r\npkt_info.bPacketBeacon = false;\r\nwlanhdr = precvframe->rx_data;\r\npkt_info.bPacketMatchBSSID = ((!IsFrameTypeCtrl(wlanhdr)) &&\r\n!pattrib->icv_err && !pattrib->crc_err &&\r\n!memcmp(get_hdr_bssid(wlanhdr),\r\nget_bssid(&padapter->mlmepriv), ETH_ALEN));\r\npkt_info.bPacketToSelf = pkt_info.bPacketMatchBSSID &&\r\n(!memcmp(get_da(wlanhdr),\r\nmyid(&padapter->eeprompriv), ETH_ALEN));\r\npkt_info.bPacketBeacon = pkt_info.bPacketMatchBSSID &&\r\n(GetFrameSubType(wlanhdr) == WIFI_BEACON);\r\nif (pkt_info.bPacketBeacon) {\r\nif (check_fwstate(&padapter->mlmepriv, WIFI_STATION_STATE))\r\nsa = padapter->mlmepriv.cur_network.network.MacAddress;\r\n} else {\r\nsa = get_sa(wlanhdr);\r\n}\r\npstapriv = &padapter->stapriv;\r\npkt_info.StationID = 0xFF;\r\npsta = rtw_get_stainfo(pstapriv, sa);\r\nif (psta)\r\npkt_info.StationID = psta->mac_id;\r\npkt_info.Rate = pattrib->mcs_rate;\r\nODM_PhyStatusQuery(&pHalData->odmpriv, pPHYInfo, (u8 *)pphy_status, &(pkt_info));\r\nprecvframe->psta = NULL;\r\nif (pkt_info.bPacketMatchBSSID &&\r\n(check_fwstate(&padapter->mlmepriv, WIFI_AP_STATE))) {\r\nif (psta) {\r\nprecvframe->psta = psta;\r\nrtl8188e_process_phy_info(padapter, precvframe);\r\n}\r\n} else if (pkt_info.bPacketToSelf || pkt_info.bPacketBeacon) {\r\nif (check_fwstate(&padapter->mlmepriv, WIFI_ADHOC_STATE|WIFI_ADHOC_MASTER_STATE)) {\r\nif (psta)\r\nprecvframe->psta = psta;\r\n}\r\nrtl8188e_process_phy_info(padapter, precvframe);\r\n}\r\n}

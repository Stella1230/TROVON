static int da9052_rtc_enable_alarm(struct da9052_rtc *rtc, bool enable)\r\n{\r\nint ret;\r\nif (enable) {\r\nret = da9052_reg_update(rtc->da9052, DA9052_ALARM_Y_REG,\r\nDA9052_ALARM_Y_ALARM_ON|DA9052_ALARM_Y_TICK_ON,\r\nDA9052_ALARM_Y_ALARM_ON);\r\nif (ret != 0)\r\nrtc_err(rtc, "Failed to enable ALM: %d\n", ret);\r\n} else {\r\nret = da9052_reg_update(rtc->da9052, DA9052_ALARM_Y_REG,\r\nDA9052_ALARM_Y_ALARM_ON|DA9052_ALARM_Y_TICK_ON, 0);\r\nif (ret != 0)\r\nrtc_err(rtc, "Write error: %d\n", ret);\r\n}\r\nreturn ret;\r\n}\r\nstatic irqreturn_t da9052_rtc_irq(int irq, void *data)\r\n{\r\nstruct da9052_rtc *rtc = data;\r\nrtc_update_irq(rtc->rtc, 1, RTC_IRQF | RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int da9052_read_alarm(struct da9052_rtc *rtc, struct rtc_time *rtc_tm)\r\n{\r\nint ret;\r\nuint8_t v[5];\r\nret = da9052_group_read(rtc->da9052, DA9052_ALARM_MI_REG, 5, v);\r\nif (ret != 0) {\r\nrtc_err(rtc, "Failed to group read ALM: %d\n", ret);\r\nreturn ret;\r\n}\r\nrtc_tm->tm_year = (v[4] & DA9052_RTC_YEAR) + 100;\r\nrtc_tm->tm_mon = (v[3] & DA9052_RTC_MONTH) - 1;\r\nrtc_tm->tm_mday = v[2] & DA9052_RTC_DAY;\r\nrtc_tm->tm_hour = v[1] & DA9052_RTC_HOUR;\r\nrtc_tm->tm_min = v[0] & DA9052_RTC_MIN;\r\nret = rtc_valid_tm(rtc_tm);\r\nreturn ret;\r\n}\r\nstatic int da9052_set_alarm(struct da9052_rtc *rtc, struct rtc_time *rtc_tm)\r\n{\r\nstruct da9052 *da9052 = rtc->da9052;\r\nunsigned long alm_time;\r\nint ret;\r\nuint8_t v[3];\r\nret = rtc_tm_to_time(rtc_tm, &alm_time);\r\nif (ret != 0)\r\nreturn ret;\r\nif (rtc_tm->tm_sec > 0) {\r\nalm_time += 60 - rtc_tm->tm_sec;\r\nrtc_time_to_tm(alm_time, rtc_tm);\r\n}\r\nBUG_ON(rtc_tm->tm_sec);\r\nrtc_tm->tm_year -= 100;\r\nrtc_tm->tm_mon += 1;\r\nret = da9052_reg_update(da9052, DA9052_ALARM_MI_REG,\r\nDA9052_RTC_MIN, rtc_tm->tm_min);\r\nif (ret != 0) {\r\nrtc_err(rtc, "Failed to write ALRM MIN: %d\n", ret);\r\nreturn ret;\r\n}\r\nv[0] = rtc_tm->tm_hour;\r\nv[1] = rtc_tm->tm_mday;\r\nv[2] = rtc_tm->tm_mon;\r\nret = da9052_group_write(da9052, DA9052_ALARM_H_REG, 3, v);\r\nif (ret < 0)\r\nreturn ret;\r\nret = da9052_reg_update(da9052, DA9052_ALARM_Y_REG,\r\nDA9052_RTC_YEAR, rtc_tm->tm_year);\r\nif (ret != 0)\r\nrtc_err(rtc, "Failed to write ALRM YEAR: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int da9052_rtc_get_alarm_status(struct da9052_rtc *rtc)\r\n{\r\nint ret;\r\nret = da9052_reg_read(rtc->da9052, DA9052_ALARM_Y_REG);\r\nif (ret < 0) {\r\nrtc_err(rtc, "Failed to read ALM: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn !!(ret&DA9052_ALARM_Y_ALARM_ON);\r\n}\r\nstatic int da9052_rtc_read_time(struct device *dev, struct rtc_time *rtc_tm)\r\n{\r\nstruct da9052_rtc *rtc = dev_get_drvdata(dev);\r\nuint8_t v[6];\r\nint ret;\r\nret = da9052_group_read(rtc->da9052, DA9052_COUNT_S_REG, 6, v);\r\nif (ret < 0) {\r\nrtc_err(rtc, "Failed to read RTC time : %d\n", ret);\r\nreturn ret;\r\n}\r\nrtc_tm->tm_year = (v[5] & DA9052_RTC_YEAR) + 100;\r\nrtc_tm->tm_mon = (v[4] & DA9052_RTC_MONTH) - 1;\r\nrtc_tm->tm_mday = v[3] & DA9052_RTC_DAY;\r\nrtc_tm->tm_hour = v[2] & DA9052_RTC_HOUR;\r\nrtc_tm->tm_min = v[1] & DA9052_RTC_MIN;\r\nrtc_tm->tm_sec = v[0] & DA9052_RTC_SEC;\r\nret = rtc_valid_tm(rtc_tm);\r\nreturn ret;\r\n}\r\nstatic int da9052_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct da9052_rtc *rtc;\r\nuint8_t v[6];\r\nint ret;\r\nrtc = dev_get_drvdata(dev);\r\nv[0] = tm->tm_sec;\r\nv[1] = tm->tm_min;\r\nv[2] = tm->tm_hour;\r\nv[3] = tm->tm_mday;\r\nv[4] = tm->tm_mon + 1;\r\nv[5] = tm->tm_year - 100;\r\nret = da9052_group_write(rtc->da9052, DA9052_COUNT_S_REG, 6, v);\r\nif (ret < 0)\r\nrtc_err(rtc, "failed to set RTC time: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int da9052_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nint ret;\r\nstruct rtc_time *tm = &alrm->time;\r\nstruct da9052_rtc *rtc = dev_get_drvdata(dev);\r\nret = da9052_read_alarm(rtc, tm);\r\nif (ret < 0) {\r\nrtc_err(rtc, "failed to read RTC alarm: %d\n", ret);\r\nreturn ret;\r\n}\r\nalrm->enabled = da9052_rtc_get_alarm_status(rtc);\r\nreturn 0;\r\n}\r\nstatic int da9052_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nint ret;\r\nstruct rtc_time *tm = &alrm->time;\r\nstruct da9052_rtc *rtc = dev_get_drvdata(dev);\r\nret = da9052_rtc_enable_alarm(rtc, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = da9052_set_alarm(rtc, tm);\r\nif (ret < 0)\r\nreturn ret;\r\nret = da9052_rtc_enable_alarm(rtc, 1);\r\nreturn ret;\r\n}\r\nstatic int da9052_rtc_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct da9052_rtc *rtc = dev_get_drvdata(dev);\r\nreturn da9052_rtc_enable_alarm(rtc, enabled);\r\n}\r\nstatic int da9052_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct da9052_rtc *rtc;\r\nint ret;\r\nrtc = devm_kzalloc(&pdev->dev, sizeof(struct da9052_rtc), GFP_KERNEL);\r\nif (!rtc)\r\nreturn -ENOMEM;\r\nrtc->da9052 = dev_get_drvdata(pdev->dev.parent);\r\nplatform_set_drvdata(pdev, rtc);\r\nret = da9052_reg_write(rtc->da9052, DA9052_BBAT_CONT_REG, 0xFE);\r\nif (ret < 0) {\r\nrtc_err(rtc,\r\n"Failed to setup RTC battery charging: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = da9052_reg_update(rtc->da9052, DA9052_ALARM_Y_REG,\r\nDA9052_ALARM_Y_TICK_ON, 0);\r\nif (ret != 0)\r\nrtc_err(rtc, "Failed to disable TICKS: %d\n", ret);\r\nret = da9052_request_irq(rtc->da9052, DA9052_IRQ_ALARM, "ALM",\r\nda9052_rtc_irq, rtc);\r\nif (ret != 0) {\r\nrtc_err(rtc, "irq registration failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nrtc->rtc = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&da9052_rtc_ops, THIS_MODULE);\r\nreturn PTR_ERR_OR_ZERO(rtc->rtc);\r\n}

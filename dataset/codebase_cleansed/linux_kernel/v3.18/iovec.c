int memcpy_fromiovec(unsigned char *kdata, struct iovec *iov, int len)\r\n{\r\nwhile (len > 0) {\r\nif (iov->iov_len) {\r\nint copy = min_t(unsigned int, len, iov->iov_len);\r\nif (copy_from_user(kdata, iov->iov_base, copy))\r\nreturn -EFAULT;\r\nlen -= copy;\r\nkdata += copy;\r\niov->iov_base += copy;\r\niov->iov_len -= copy;\r\n}\r\niov++;\r\n}\r\nreturn 0;\r\n}\r\nint memcpy_toiovec(struct iovec *iov, unsigned char *kdata, int len)\r\n{\r\nwhile (len > 0) {\r\nif (iov->iov_len) {\r\nint copy = min_t(unsigned int, iov->iov_len, len);\r\nif (copy_to_user(iov->iov_base, kdata, copy))\r\nreturn -EFAULT;\r\nkdata += copy;\r\nlen -= copy;\r\niov->iov_len -= copy;\r\niov->iov_base += copy;\r\n}\r\niov++;\r\n}\r\nreturn 0;\r\n}\r\nint memcpy_toiovecend(const struct iovec *iov, unsigned char *kdata,\r\nint offset, int len)\r\n{\r\nint copy;\r\nfor (; len > 0; ++iov) {\r\nif (unlikely(offset >= iov->iov_len)) {\r\noffset -= iov->iov_len;\r\ncontinue;\r\n}\r\ncopy = min_t(unsigned int, iov->iov_len - offset, len);\r\nif (copy_to_user(iov->iov_base + offset, kdata, copy))\r\nreturn -EFAULT;\r\noffset = 0;\r\nkdata += copy;\r\nlen -= copy;\r\n}\r\nreturn 0;\r\n}\r\nint memcpy_fromiovecend(unsigned char *kdata, const struct iovec *iov,\r\nint offset, int len)\r\n{\r\nif (len == 0)\r\nreturn 0;\r\nwhile (offset >= iov->iov_len) {\r\noffset -= iov->iov_len;\r\niov++;\r\n}\r\nwhile (len > 0) {\r\nu8 __user *base = iov->iov_base + offset;\r\nint copy = min_t(unsigned int, len, iov->iov_len - offset);\r\noffset = 0;\r\nif (copy_from_user(kdata, base, copy))\r\nreturn -EFAULT;\r\nlen -= copy;\r\nkdata += copy;\r\niov++;\r\n}\r\nreturn 0;\r\n}

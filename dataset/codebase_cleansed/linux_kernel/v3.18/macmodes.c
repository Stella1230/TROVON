int mac_vmode_to_var(int vmode, int cmode, struct fb_var_screeninfo *var)\r\n{\r\nconst struct fb_videomode *mode = NULL;\r\nconst struct mode_map *map;\r\nfor (map = mac_modes; map->vmode != -1; map++)\r\nif (map->vmode == vmode) {\r\nmode = map->mode;\r\nbreak;\r\n}\r\nif (!mode)\r\nreturn -EINVAL;\r\nmemset(var, 0, sizeof(struct fb_var_screeninfo));\r\nswitch (cmode) {\r\ncase CMODE_8:\r\nvar->bits_per_pixel = 8;\r\nvar->red.offset = 0;\r\nvar->red.length = 8;\r\nvar->green.offset = 0;\r\nvar->green.length = 8;\r\nvar->blue.offset = 0;\r\nvar->blue.length = 8;\r\nbreak;\r\ncase CMODE_16:\r\nvar->bits_per_pixel = 16;\r\nvar->red.offset = 10;\r\nvar->red.length = 5;\r\nvar->green.offset = 5;\r\nvar->green.length = 5;\r\nvar->blue.offset = 0;\r\nvar->blue.length = 5;\r\nbreak;\r\ncase CMODE_32:\r\nvar->bits_per_pixel = 32;\r\nvar->red.offset = 16;\r\nvar->red.length = 8;\r\nvar->green.offset = 8;\r\nvar->green.length = 8;\r\nvar->blue.offset = 0;\r\nvar->blue.length = 8;\r\nvar->transp.offset = 24;\r\nvar->transp.length = 8;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nvar->xres = mode->xres;\r\nvar->yres = mode->yres;\r\nvar->xres_virtual = mode->xres;\r\nvar->yres_virtual = mode->yres;\r\nvar->height = -1;\r\nvar->width = -1;\r\nvar->pixclock = mode->pixclock;\r\nvar->left_margin = mode->left_margin;\r\nvar->right_margin = mode->right_margin;\r\nvar->upper_margin = mode->upper_margin;\r\nvar->lower_margin = mode->lower_margin;\r\nvar->hsync_len = mode->hsync_len;\r\nvar->vsync_len = mode->vsync_len;\r\nvar->sync = mode->sync;\r\nvar->vmode = mode->vmode;\r\nreturn 0;\r\n}\r\nint mac_var_to_vmode(const struct fb_var_screeninfo *var, int *vmode,\r\nint *cmode)\r\n{\r\nconst struct mode_map *map;\r\nif (var->bits_per_pixel <= 8)\r\n*cmode = CMODE_8;\r\nelse if (var->bits_per_pixel <= 16)\r\n*cmode = CMODE_16;\r\nelse if (var->bits_per_pixel <= 32)\r\n*cmode = CMODE_32;\r\nelse\r\nreturn -EINVAL;\r\nfor (map = mac_modes; map->vmode != -1; map++) {\r\nconst struct fb_videomode *mode = map->mode;\r\nif (var->xres > mode->xres || var->yres > mode->yres)\r\ncontinue;\r\nif (var->xres_virtual > mode->xres || var->yres_virtual > mode->yres)\r\ncontinue;\r\nif (var->pixclock > mode->pixclock)\r\ncontinue;\r\nif ((var->vmode & FB_VMODE_MASK) != mode->vmode)\r\ncontinue;\r\n*vmode = map->vmode;\r\nmap++;\r\nwhile (map->vmode != -1) {\r\nconst struct fb_videomode *clk_mode = map->mode;\r\nif (mode->xres != clk_mode->xres || mode->yres != clk_mode->yres)\r\nbreak;\r\nif (var->pixclock > mode->pixclock)\r\nbreak;\r\nif (mode->vmode != clk_mode->vmode)\r\ncontinue;\r\n*vmode = map->vmode;\r\nmap++;\r\n}\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nint mac_map_monitor_sense(int sense)\r\n{\r\nconst struct monitor_map *map;\r\nfor (map = mac_monitors; map->sense != -1; map++)\r\nif (map->sense == sense)\r\nbreak;\r\nreturn map->vmode;\r\n}\r\nint mac_find_mode(struct fb_var_screeninfo *var, struct fb_info *info,\r\nconst char *mode_option, unsigned int default_bpp)\r\n{\r\nconst struct fb_videomode *db = NULL;\r\nunsigned int dbsize = 0;\r\nif (mode_option && !strncmp(mode_option, "mac", 3)) {\r\nmode_option += 3;\r\ndb = mac_modedb;\r\ndbsize = ARRAY_SIZE(mac_modedb);\r\n}\r\nreturn fb_find_mode(var, info, mode_option, db, dbsize,\r\n&mac_modedb[DEFAULT_MODEDB_INDEX], default_bpp);\r\n}

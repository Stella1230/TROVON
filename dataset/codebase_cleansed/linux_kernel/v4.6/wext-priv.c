int iw_handler_get_private(struct net_device * dev,\r\nstruct iw_request_info * info,\r\nunion iwreq_data * wrqu,\r\nchar * extra)\r\n{\r\nif ((dev->wireless_handlers->num_private_args == 0) ||\r\n(dev->wireless_handlers->private_args == NULL))\r\nreturn -EOPNOTSUPP;\r\nif (wrqu->data.length < dev->wireless_handlers->num_private_args) {\r\nwrqu->data.length = dev->wireless_handlers->num_private_args;\r\nreturn -E2BIG;\r\n}\r\nwrqu->data.length = dev->wireless_handlers->num_private_args;\r\nmemcpy(extra, dev->wireless_handlers->private_args,\r\nsizeof(struct iw_priv_args) * wrqu->data.length);\r\nreturn 0;\r\n}\r\nstatic int get_priv_size(__u16 args)\r\n{\r\nint num = args & IW_PRIV_SIZE_MASK;\r\nint type = (args & IW_PRIV_TYPE_MASK) >> 12;\r\nreturn num * iw_priv_type_size[type];\r\n}\r\nstatic int adjust_priv_size(__u16 args, struct iw_point *iwp)\r\n{\r\nint num = iwp->length;\r\nint max = args & IW_PRIV_SIZE_MASK;\r\nint type = (args & IW_PRIV_TYPE_MASK) >> 12;\r\nif (max < num)\r\nnum = max;\r\nreturn num * iw_priv_type_size[type];\r\n}\r\nstatic int get_priv_descr_and_size(struct net_device *dev, unsigned int cmd,\r\nconst struct iw_priv_args **descrp)\r\n{\r\nconst struct iw_priv_args *descr;\r\nint i, extra_size;\r\ndescr = NULL;\r\nfor (i = 0; i < dev->wireless_handlers->num_private_args; i++) {\r\nif (cmd == dev->wireless_handlers->private_args[i].cmd) {\r\ndescr = &dev->wireless_handlers->private_args[i];\r\nbreak;\r\n}\r\n}\r\nextra_size = 0;\r\nif (descr) {\r\nif (IW_IS_SET(cmd)) {\r\nint offset = 0;\r\nif (descr->name[0] == '\0')\r\noffset = sizeof(__u32);\r\nextra_size = get_priv_size(descr->set_args);\r\nif ((descr->set_args & IW_PRIV_SIZE_FIXED) &&\r\n((extra_size + offset) <= IFNAMSIZ))\r\nextra_size = 0;\r\n} else {\r\nextra_size = get_priv_size(descr->get_args);\r\nif ((descr->get_args & IW_PRIV_SIZE_FIXED) &&\r\n(extra_size <= IFNAMSIZ))\r\nextra_size = 0;\r\n}\r\n}\r\n*descrp = descr;\r\nreturn extra_size;\r\n}\r\nstatic int ioctl_private_iw_point(struct iw_point *iwp, unsigned int cmd,\r\nconst struct iw_priv_args *descr,\r\niw_handler handler, struct net_device *dev,\r\nstruct iw_request_info *info, int extra_size)\r\n{\r\nchar *extra;\r\nint err;\r\nif (IW_IS_SET(cmd)) {\r\nif (!iwp->pointer && iwp->length != 0)\r\nreturn -EFAULT;\r\nif (iwp->length > (descr->set_args & IW_PRIV_SIZE_MASK))\r\nreturn -E2BIG;\r\n} else if (!iwp->pointer)\r\nreturn -EFAULT;\r\nextra = kzalloc(extra_size, GFP_KERNEL);\r\nif (!extra)\r\nreturn -ENOMEM;\r\nif (IW_IS_SET(cmd) && (iwp->length != 0)) {\r\nif (copy_from_user(extra, iwp->pointer, extra_size)) {\r\nerr = -EFAULT;\r\ngoto out;\r\n}\r\n}\r\nerr = handler(dev, info, (union iwreq_data *) iwp, extra);\r\nif (!err && IW_IS_GET(cmd)) {\r\nif (!(descr->get_args & IW_PRIV_SIZE_FIXED))\r\nextra_size = adjust_priv_size(descr->get_args, iwp);\r\nif (copy_to_user(iwp->pointer, extra, extra_size))\r\nerr = -EFAULT;\r\n}\r\nout:\r\nkfree(extra);\r\nreturn err;\r\n}\r\nint ioctl_private_call(struct net_device *dev, struct iwreq *iwr,\r\nunsigned int cmd, struct iw_request_info *info,\r\niw_handler handler)\r\n{\r\nint extra_size = 0, ret = -EINVAL;\r\nconst struct iw_priv_args *descr;\r\nextra_size = get_priv_descr_and_size(dev, cmd, &descr);\r\nif (extra_size == 0) {\r\nret = handler(dev, info, &(iwr->u), (char *) &(iwr->u));\r\n} else {\r\nret = ioctl_private_iw_point(&iwr->u.data, cmd, descr,\r\nhandler, dev, info, extra_size);\r\n}\r\nif (ret == -EIWCOMMIT)\r\nret = call_commit_handler(dev);\r\nreturn ret;\r\n}\r\nint compat_private_call(struct net_device *dev, struct iwreq *iwr,\r\nunsigned int cmd, struct iw_request_info *info,\r\niw_handler handler)\r\n{\r\nconst struct iw_priv_args *descr;\r\nint ret, extra_size;\r\nextra_size = get_priv_descr_and_size(dev, cmd, &descr);\r\nif (extra_size == 0) {\r\nret = handler(dev, info, &(iwr->u), (char *) &(iwr->u));\r\n} else {\r\nstruct compat_iw_point *iwp_compat;\r\nstruct iw_point iwp;\r\niwp_compat = (struct compat_iw_point *) &iwr->u.data;\r\niwp.pointer = compat_ptr(iwp_compat->pointer);\r\niwp.length = iwp_compat->length;\r\niwp.flags = iwp_compat->flags;\r\nret = ioctl_private_iw_point(&iwp, cmd, descr,\r\nhandler, dev, info, extra_size);\r\niwp_compat->pointer = ptr_to_compat(iwp.pointer);\r\niwp_compat->length = iwp.length;\r\niwp_compat->flags = iwp.flags;\r\n}\r\nif (ret == -EIWCOMMIT)\r\nret = call_commit_handler(dev);\r\nreturn ret;\r\n}

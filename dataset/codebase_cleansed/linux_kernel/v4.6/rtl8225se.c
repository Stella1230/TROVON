static void rtl8187se_three_wire_io(struct ieee80211_hw *dev, u8 *data,\r\nu8 len, bool write)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nint i;\r\nu8 tmp;\r\ndo {\r\nfor (i = 0; i < 5; i++) {\r\ntmp = rtl818x_ioread8(priv, SW_3W_CMD1);\r\nif (!(tmp & 0x3))\r\nbreak;\r\nudelay(10);\r\n}\r\nif (i == 5)\r\nwiphy_err(dev->wiphy, PFX\r\n"CmdReg: 0x%x RE/WE bits aren't clear\n", tmp);\r\ntmp = rtl818x_ioread8(priv, &priv->map->rf_sw_config) | 0x02;\r\nrtl818x_iowrite8(priv, &priv->map->rf_sw_config, tmp);\r\ntmp = rtl818x_ioread8(priv, REG_ADDR1(0x84)) & 0xF7;\r\nrtl818x_iowrite8(priv, REG_ADDR1(0x84), tmp);\r\nif (write) {\r\nif (len == 16) {\r\nrtl818x_iowrite16(priv, SW_3W_DB0,\r\n*(u16 *)data);\r\n} else if (len == 64) {\r\nrtl818x_iowrite32(priv, SW_3W_DB0_4,\r\n*((u32 *)data));\r\nrtl818x_iowrite32(priv, SW_3W_DB1_4,\r\n*((u32 *)(data + 4)));\r\n} else\r\nwiphy_err(dev->wiphy, PFX\r\n"Unimplemented length\n");\r\n} else {\r\nrtl818x_iowrite16(priv, SW_3W_DB0, *(u16 *)data);\r\n}\r\nif (write)\r\ntmp = 2;\r\nelse\r\ntmp = 1;\r\nrtl818x_iowrite8(priv, SW_3W_CMD1, tmp);\r\nfor (i = 0; i < 5; i++) {\r\ntmp = rtl818x_ioread8(priv, SW_3W_CMD1);\r\nif (!(tmp & 0x3))\r\nbreak;\r\nudelay(10);\r\n}\r\nrtl818x_iowrite8(priv, SW_3W_CMD1, 0);\r\nif (!write) {\r\n*((u16 *)data) = rtl818x_ioread16(priv, SI_DATA_REG);\r\n*((u16 *)data) &= 0x0FFF;\r\n}\r\n} while (0);\r\n}\r\nstatic u32 rtl8187se_rf_readreg(struct ieee80211_hw *dev, u8 addr)\r\n{\r\nu32 dataread = addr & 0x0F;\r\nrtl8187se_three_wire_io(dev, (u8 *)&dataread, 16, 0);\r\nreturn dataread;\r\n}\r\nstatic void rtl8187se_rf_writereg(struct ieee80211_hw *dev, u8 addr, u32 data)\r\n{\r\nu32 outdata = (data << 4) | (u32)(addr & 0x0F);\r\nrtl8187se_three_wire_io(dev, (u8 *)&outdata, 16, 1);\r\n}\r\nstatic void rtl8225se_write_zebra_agc(struct ieee80211_hw *dev)\r\n{\r\nint i;\r\nfor (i = 0; i < 128; i++) {\r\nrtl8225se_write_phy_ofdm(dev, 0xF, ZEBRA_AGC[i]);\r\nrtl8225se_write_phy_ofdm(dev, 0xE, i+0x80);\r\nrtl8225se_write_phy_ofdm(dev, 0xE, 0);\r\n}\r\n}\r\nstatic void rtl8187se_write_ofdm_config(struct ieee80211_hw *dev)\r\n{\r\nint i;\r\nfor (i = 0; i < 60; i++)\r\nrtl8225se_write_phy_ofdm(dev, i, OFDM_CONFIG[i]);\r\n}\r\nstatic void rtl8225sez2_rf_set_tx_power(struct ieee80211_hw *dev, int channel)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nu8 cck_power, ofdm_power;\r\ncck_power = priv->channels[channel - 1].hw_value & 0xFF;\r\nif (cck_power > 35)\r\ncck_power = 35;\r\nrtl818x_iowrite8(priv, &priv->map->TX_GAIN_CCK,\r\ncck_ofdm_gain_settings[cck_power]);\r\nusleep_range(1000, 5000);\r\nofdm_power = priv->channels[channel - 1].hw_value >> 8;\r\nif (ofdm_power > 35)\r\nofdm_power = 35;\r\nrtl818x_iowrite8(priv, &priv->map->TX_GAIN_OFDM,\r\ncck_ofdm_gain_settings[ofdm_power]);\r\nif (ofdm_power < 12) {\r\nrtl8225se_write_phy_ofdm(dev, 7, 0x5C);\r\nrtl8225se_write_phy_ofdm(dev, 9, 0x5C);\r\n}\r\nif (ofdm_power < 18) {\r\nrtl8225se_write_phy_ofdm(dev, 7, 0x54);\r\nrtl8225se_write_phy_ofdm(dev, 9, 0x54);\r\n} else {\r\nrtl8225se_write_phy_ofdm(dev, 7, 0x50);\r\nrtl8225se_write_phy_ofdm(dev, 9, 0x50);\r\n}\r\nusleep_range(1000, 5000);\r\n}\r\nstatic void rtl8187se_write_rf_gain(struct ieee80211_hw *dev)\r\n{\r\nint i;\r\nfor (i = 0; i <= 36; i++) {\r\nrtl8187se_rf_writereg(dev, 0x01, i); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x02, RF_GAIN_TABLE[i]); mdelay(1);\r\n}\r\n}\r\nstatic void rtl8187se_write_initial_gain(struct ieee80211_hw *dev,\r\nint init_gain)\r\n{\r\nswitch (init_gain) {\r\ndefault:\r\nrtl8225se_write_phy_ofdm(dev, 0x17, 0x26); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x24, 0x86); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x05, 0xFA); mdelay(1);\r\nbreak;\r\ncase 2:\r\nrtl8225se_write_phy_ofdm(dev, 0x17, 0x36); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x24, 0x86); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x05, 0xFA); mdelay(1);\r\nbreak;\r\ncase 3:\r\nrtl8225se_write_phy_ofdm(dev, 0x17, 0x36); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x24, 0x86); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x05, 0xFB); mdelay(1);\r\nbreak;\r\ncase 4:\r\nrtl8225se_write_phy_ofdm(dev, 0x17, 0x46); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x24, 0x86); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x05, 0xFB); mdelay(1);\r\nbreak;\r\ncase 5:\r\nrtl8225se_write_phy_ofdm(dev, 0x17, 0x46); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x24, 0x96); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x05, 0xFB); mdelay(1);\r\nbreak;\r\ncase 6:\r\nrtl8225se_write_phy_ofdm(dev, 0x17, 0x56); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x24, 0x96); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x05, 0xFC); mdelay(1);\r\nbreak;\r\ncase 7:\r\nrtl8225se_write_phy_ofdm(dev, 0x17, 0x56); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x24, 0xA6); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x05, 0xFC); mdelay(1);\r\nbreak;\r\ncase 8:\r\nrtl8225se_write_phy_ofdm(dev, 0x17, 0x66); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x24, 0xB6); mdelay(1);\r\nrtl8225se_write_phy_ofdm(dev, 0x05, 0xFC); mdelay(1);\r\nbreak;\r\n}\r\n}\r\nvoid rtl8225se_rf_init(struct ieee80211_hw *dev)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nu32 rf23, rf24;\r\nu8 d_cut = 0;\r\nu8 tmp;\r\nrtl8187se_rf_writereg(dev, 0x00, 0x013F); mdelay(1);\r\nrf23 = rtl8187se_rf_readreg(dev, 0x08); mdelay(1);\r\nrf24 = rtl8187se_rf_readreg(dev, 0x09); mdelay(1);\r\nif (rf23 == 0x0818 && rf24 == 0x070C)\r\nd_cut = 1;\r\nwiphy_info(dev->wiphy, "RTL8225-SE version %s\n",\r\nd_cut ? "D" : "not-D");\r\nrtl8187se_rf_writereg(dev, 0x00, 0x009F); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x01, 0x06E0); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x02, 0x004D); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x03, 0x07F1); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x04, 0x0975); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x05, 0x0C72); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x06, 0x0AE6); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x07, 0x00CA); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x08, 0x0E1C); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x09, 0x02F0); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x0A, 0x09D0); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x0B, 0x01BA); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x0C, 0x0640); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x0D, 0x08DF); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x0E, 0x0020); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x0F, 0x0990); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x00, 0x013F); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x03, 0x0806); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x04, 0x03A7); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x05, 0x059B); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x06, 0x0081); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x07, 0x01A0); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x0A, 0x0001); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x0B, 0x0418); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x0C, 0x0FBE); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x0D, 0x0008); mdelay(1);\r\nif (d_cut)\r\nrtl8187se_rf_writereg(dev, 0x0E, 0x0807);\r\nelse\r\nrtl8187se_rf_writereg(dev, 0x0E, 0x0806);\r\nmdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x0F, 0x0ACC); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x00, 0x01D7); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x03, 0x0E00); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x04, 0x0E50); mdelay(1);\r\nrtl8187se_write_rf_gain(dev);\r\nrtl8187se_rf_writereg(dev, 0x05, 0x0203); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x06, 0x0200); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x00, 0x0137); mdelay(11);\r\nrtl8187se_rf_writereg(dev, 0x0D, 0x0008); mdelay(11);\r\nrtl8187se_rf_writereg(dev, 0x00, 0x0037); mdelay(11);\r\nrtl8187se_rf_writereg(dev, 0x04, 0x0160); mdelay(11);\r\nrtl8187se_rf_writereg(dev, 0x07, 0x0080); mdelay(11);\r\nrtl8187se_rf_writereg(dev, 0x02, 0x088D); mdelay(221);\r\nrtl8187se_rf_writereg(dev, 0x00, 0x0137); mdelay(11);\r\nrtl8187se_rf_writereg(dev, 0x07, 0x0000); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x07, 0x0180); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x07, 0x0220); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x07, 0x03E0); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x06, 0x00C1); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x0A, 0x0001); mdelay(1);\r\nif (priv->xtal_cal) {\r\ntmp = (priv->xtal_in << 4) | (priv->xtal_out << 1) |\r\n(1 << 11) | (1 << 9);\r\nrtl8187se_rf_writereg(dev, 0x0F, tmp);\r\nwiphy_info(dev->wiphy, "Xtal cal\n");\r\nmdelay(1);\r\n} else {\r\nwiphy_info(dev->wiphy, "NO Xtal cal\n");\r\nrtl8187se_rf_writereg(dev, 0x0F, 0x0ACC);\r\nmdelay(1);\r\n}\r\nrtl8187se_rf_writereg(dev, 0x00, 0x00BF); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x0D, 0x08DF); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x02, 0x004D); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x04, 0x0975); mdelay(31);\r\nrtl8187se_rf_writereg(dev, 0x00, 0x0197); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x05, 0x05AB); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x00, 0x009F); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x01, 0x0000); mdelay(1);\r\nrtl8187se_rf_writereg(dev, 0x02, 0x0000); mdelay(1);\r\nrtl818x_iowrite8(priv, REG_ADDR1(0x024E),\r\nrtl818x_ioread8(priv, REG_ADDR1(0x24E)) & 0x9F);\r\nrtl8225se_write_phy_cck(dev, 0x00, 0xC8);\r\nrtl8225se_write_phy_cck(dev, 0x06, 0x1C);\r\nrtl8225se_write_phy_cck(dev, 0x10, 0x78);\r\nrtl8225se_write_phy_cck(dev, 0x2E, 0xD0);\r\nrtl8225se_write_phy_cck(dev, 0x2F, 0x06);\r\nrtl8225se_write_phy_cck(dev, 0x01, 0x46);\r\nrtl818x_iowrite8(priv, &priv->map->TX_GAIN_CCK, 0x10);\r\nrtl818x_iowrite8(priv, &priv->map->TX_GAIN_OFDM, 0x1B);\r\nrtl818x_iowrite8(priv, &priv->map->TX_ANTENNA, 0x03);\r\nrtl8225se_write_phy_ofdm(dev, 0x00, 0x12);\r\nrtl8225se_write_zebra_agc(dev);\r\nrtl8225se_write_phy_ofdm(dev, 0x10, 0x00);\r\nrtl8187se_write_ofdm_config(dev);\r\nrtl8187se_rf_writereg(dev, 0x00, 0x009F); udelay(500);\r\nrtl8187se_rf_writereg(dev, 0x04, 0x0972); udelay(500);\r\nrtl8187se_rf_writereg(dev, 0x00, 0x009F); udelay(500);\r\nrtl8187se_rf_writereg(dev, 0x04, 0x0972); udelay(500);\r\nrtl8225se_write_phy_ofdm(dev, 0x10, 0x40);\r\nrtl8225se_write_phy_ofdm(dev, 0x12, 0x40);\r\nrtl8187se_write_initial_gain(dev, 4);\r\n}\r\nvoid rtl8225se_rf_stop(struct ieee80211_hw *dev)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nrtl8225se_write_phy_ofdm(dev, 0x10, 0x00);\r\nrtl8225se_write_phy_ofdm(dev, 0x12, 0x00);\r\nrtl8187se_rf_writereg(dev, 0x04, 0x0000);\r\nrtl8187se_rf_writereg(dev, 0x00, 0x0000);\r\nusleep_range(1000, 5000);\r\nrtl8180_set_anaparam(priv, RTL8225SE_ANAPARAM_OFF);\r\nrtl8180_set_anaparam2(priv, RTL8225SE_ANAPARAM2_OFF);\r\n}\r\nvoid rtl8225se_rf_set_channel(struct ieee80211_hw *dev,\r\nstruct ieee80211_conf *conf)\r\n{\r\nint chan =\r\nieee80211_frequency_to_channel(conf->chandef.chan->center_freq);\r\nrtl8225sez2_rf_set_tx_power(dev, chan);\r\nrtl8187se_rf_writereg(dev, 0x7, rtl8225se_chan[chan - 1]);\r\nif ((rtl8187se_rf_readreg(dev, 0x7) & 0x0F80) !=\r\nrtl8225se_chan[chan - 1])\r\nrtl8187se_rf_writereg(dev, 0x7, rtl8225se_chan[chan - 1]);\r\nusleep_range(10000, 20000);\r\n}\r\nconst struct rtl818x_rf_ops *rtl8187se_detect_rf(struct ieee80211_hw *dev)\r\n{\r\nreturn &rtl8225se_ops;\r\n}

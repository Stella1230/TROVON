static ssize_t show_power(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nu32 val, tdp_limit, running_avg_range;\r\ns32 running_avg_capture;\r\nu64 curr_pwr_watts;\r\nstruct fam15h_power_data *data = dev_get_drvdata(dev);\r\nstruct pci_dev *f4 = data->pdev;\r\npci_bus_read_config_dword(f4->bus, PCI_DEVFN(PCI_SLOT(f4->devfn), 5),\r\nREG_TDP_RUNNING_AVERAGE, &val);\r\nif (boot_cpu_data.x86 == 0x15 && boot_cpu_data.x86_model >= 0x60) {\r\nrunning_avg_capture = val >> 4;\r\nrunning_avg_capture = sign_extend32(running_avg_capture, 27);\r\n} else {\r\nrunning_avg_capture = (val >> 4) & 0x3fffff;\r\nrunning_avg_capture = sign_extend32(running_avg_capture, 21);\r\n}\r\nrunning_avg_range = (val & 0xf) + 1;\r\npci_bus_read_config_dword(f4->bus, PCI_DEVFN(PCI_SLOT(f4->devfn), 5),\r\nREG_TDP_LIMIT3, &val);\r\nif (boot_cpu_data.x86 == 0x15 && boot_cpu_data.x86_model >= 0x60)\r\ntdp_limit = val >> 16;\r\nelse\r\ntdp_limit = (val >> 16) & 0x1fff;\r\ncurr_pwr_watts = ((u64)(tdp_limit +\r\ndata->base_tdp)) << running_avg_range;\r\ncurr_pwr_watts -= running_avg_capture;\r\ncurr_pwr_watts *= data->tdp_to_watts;\r\ncurr_pwr_watts = (curr_pwr_watts * 15625) >> (10 + running_avg_range);\r\nreturn sprintf(buf, "%u\n", (unsigned int) curr_pwr_watts);\r\n}\r\nstatic ssize_t show_power_crit(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct fam15h_power_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%u\n", data->processor_pwr_watts);\r\n}\r\nstatic int fam15h_power_init_attrs(struct pci_dev *pdev,\r\nstruct fam15h_power_data *data)\r\n{\r\nint n = FAM15H_MIN_NUM_ATTRS;\r\nstruct attribute **fam15h_power_attrs;\r\nstruct cpuinfo_x86 *c = &boot_cpu_data;\r\nif (c->x86 == 0x15 &&\r\n(c->x86_model <= 0xf ||\r\n(c->x86_model >= 0x60 && c->x86_model <= 0x7f)))\r\nn += 1;\r\nfam15h_power_attrs = devm_kcalloc(&pdev->dev, n,\r\nsizeof(*fam15h_power_attrs),\r\nGFP_KERNEL);\r\nif (!fam15h_power_attrs)\r\nreturn -ENOMEM;\r\nn = 0;\r\nfam15h_power_attrs[n++] = &dev_attr_power1_crit.attr;\r\nif (c->x86 == 0x15 &&\r\n(c->x86_model <= 0xf ||\r\n(c->x86_model >= 0x60 && c->x86_model <= 0x7f)))\r\nfam15h_power_attrs[n++] = &dev_attr_power1_input.attr;\r\ndata->group.attrs = fam15h_power_attrs;\r\nreturn 0;\r\n}\r\nstatic bool should_load_on_this_node(struct pci_dev *f4)\r\n{\r\nu32 val;\r\npci_bus_read_config_dword(f4->bus, PCI_DEVFN(PCI_SLOT(f4->devfn), 3),\r\nREG_NORTHBRIDGE_CAP, &val);\r\nif ((val & BIT(29)) && ((val >> 30) & 3))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic void tweak_runavg_range(struct pci_dev *pdev)\r\n{\r\nu32 val;\r\nif (!pci_match_id(affected_device, pdev))\r\nreturn;\r\npci_bus_read_config_dword(pdev->bus,\r\nPCI_DEVFN(PCI_SLOT(pdev->devfn), 5),\r\nREG_TDP_RUNNING_AVERAGE, &val);\r\nif ((val & 0xf) != 0xe)\r\nreturn;\r\nval &= ~0xf;\r\nval |= 0x9;\r\npci_bus_write_config_dword(pdev->bus,\r\nPCI_DEVFN(PCI_SLOT(pdev->devfn), 5),\r\nREG_TDP_RUNNING_AVERAGE, val);\r\n}\r\nstatic int fam15h_power_resume(struct pci_dev *pdev)\r\n{\r\ntweak_runavg_range(pdev);\r\nreturn 0;\r\n}\r\nstatic int fam15h_power_init_data(struct pci_dev *f4,\r\nstruct fam15h_power_data *data)\r\n{\r\nu32 val, eax, ebx, ecx, edx;\r\nu64 tmp;\r\nint ret;\r\npci_read_config_dword(f4, REG_PROCESSOR_TDP, &val);\r\ndata->base_tdp = val >> 16;\r\ntmp = val & 0xffff;\r\npci_bus_read_config_dword(f4->bus, PCI_DEVFN(PCI_SLOT(f4->devfn), 5),\r\nREG_TDP_LIMIT3, &val);\r\ndata->tdp_to_watts = ((val & 0x3ff) << 6) | ((val >> 10) & 0x3f);\r\ntmp *= data->tdp_to_watts;\r\nif ((tmp >> 16) >= 256)\r\ndev_warn(&f4->dev,\r\n"Bogus value for ProcessorPwrWatts (processor_pwr_watts>=%u)\n",\r\n(unsigned int) (tmp >> 16));\r\ndata->processor_pwr_watts = (tmp * 15625) >> 10;\r\nret = fam15h_power_init_attrs(f4, data);\r\nif (ret)\r\nreturn ret;\r\ncpuid(0x80000007, &eax, &ebx, &ecx, &edx);\r\nif (!(edx & BIT(12)))\r\nreturn 0;\r\ndata->cpu_pwr_sample_ratio = ecx;\r\nif (rdmsrl_safe(MSR_F15H_CU_MAX_PWR_ACCUMULATOR, &tmp)) {\r\npr_err("Failed to read max compute unit power accumulator MSR\n");\r\nreturn -ENODEV;\r\n}\r\ndata->max_cu_acc_power = tmp;\r\nreturn 0;\r\n}\r\nstatic int fam15h_power_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nstruct fam15h_power_data *data;\r\nstruct device *dev = &pdev->dev;\r\nstruct device *hwmon_dev;\r\nint ret;\r\ntweak_runavg_range(pdev);\r\nif (!should_load_on_this_node(pdev))\r\nreturn -ENODEV;\r\ndata = devm_kzalloc(dev, sizeof(struct fam15h_power_data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nret = fam15h_power_init_data(pdev, data);\r\nif (ret)\r\nreturn ret;\r\ndata->pdev = pdev;\r\ndata->groups[0] = &data->group;\r\nhwmon_dev = devm_hwmon_device_register_with_groups(dev, "fam15h_power",\r\ndata,\r\n&data->groups[0]);\r\nreturn PTR_ERR_OR_ZERO(hwmon_dev);\r\n}

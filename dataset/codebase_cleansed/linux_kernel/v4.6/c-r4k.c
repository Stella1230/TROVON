static inline void r4k_on_each_cpu(void (*func) (void *info), void *info)\r\n{\r\npreempt_disable();\r\nif (!mips_cm_present())\r\nsmp_call_function_many(&cpu_foreign_map, func, info, 1);\r\nfunc(info);\r\npreempt_enable();\r\n}\r\nstatic void cache_noop(void) {}\r\nstatic inline void r4k_blast_dcache_page_dc32(unsigned long addr)\r\n{\r\nR4600_HIT_CACHEOP_WAR_IMPL;\r\nblast_dcache32_page(addr);\r\n}\r\nstatic inline void r4k_blast_dcache_page_dc64(unsigned long addr)\r\n{\r\nblast_dcache64_page(addr);\r\n}\r\nstatic inline void r4k_blast_dcache_page_dc128(unsigned long addr)\r\n{\r\nblast_dcache128_page(addr);\r\n}\r\nstatic void r4k_blast_dcache_page_setup(void)\r\n{\r\nunsigned long dc_lsize = cpu_dcache_line_size();\r\nswitch (dc_lsize) {\r\ncase 0:\r\nr4k_blast_dcache_page = (void *)cache_noop;\r\nbreak;\r\ncase 16:\r\nr4k_blast_dcache_page = blast_dcache16_page;\r\nbreak;\r\ncase 32:\r\nr4k_blast_dcache_page = r4k_blast_dcache_page_dc32;\r\nbreak;\r\ncase 64:\r\nr4k_blast_dcache_page = r4k_blast_dcache_page_dc64;\r\nbreak;\r\ncase 128:\r\nr4k_blast_dcache_page = r4k_blast_dcache_page_dc128;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void r4k_blast_dcache_user_page_setup(void)\r\n{\r\nunsigned long dc_lsize = cpu_dcache_line_size();\r\nif (dc_lsize == 0)\r\nr4k_blast_dcache_user_page = (void *)cache_noop;\r\nelse if (dc_lsize == 16)\r\nr4k_blast_dcache_user_page = blast_dcache16_user_page;\r\nelse if (dc_lsize == 32)\r\nr4k_blast_dcache_user_page = blast_dcache32_user_page;\r\nelse if (dc_lsize == 64)\r\nr4k_blast_dcache_user_page = blast_dcache64_user_page;\r\n}\r\nstatic void r4k_blast_dcache_page_indexed_setup(void)\r\n{\r\nunsigned long dc_lsize = cpu_dcache_line_size();\r\nif (dc_lsize == 0)\r\nr4k_blast_dcache_page_indexed = (void *)cache_noop;\r\nelse if (dc_lsize == 16)\r\nr4k_blast_dcache_page_indexed = blast_dcache16_page_indexed;\r\nelse if (dc_lsize == 32)\r\nr4k_blast_dcache_page_indexed = blast_dcache32_page_indexed;\r\nelse if (dc_lsize == 64)\r\nr4k_blast_dcache_page_indexed = blast_dcache64_page_indexed;\r\nelse if (dc_lsize == 128)\r\nr4k_blast_dcache_page_indexed = blast_dcache128_page_indexed;\r\n}\r\nstatic void r4k_blast_dcache_setup(void)\r\n{\r\nunsigned long dc_lsize = cpu_dcache_line_size();\r\nif (dc_lsize == 0)\r\nr4k_blast_dcache = (void *)cache_noop;\r\nelse if (dc_lsize == 16)\r\nr4k_blast_dcache = blast_dcache16;\r\nelse if (dc_lsize == 32)\r\nr4k_blast_dcache = blast_dcache32;\r\nelse if (dc_lsize == 64)\r\nr4k_blast_dcache = blast_dcache64;\r\nelse if (dc_lsize == 128)\r\nr4k_blast_dcache = blast_dcache128;\r\n}\r\nstatic inline void blast_r4600_v1_icache32(void)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nblast_icache32();\r\nlocal_irq_restore(flags);\r\n}\r\nstatic inline void tx49_blast_icache32(void)\r\n{\r\nunsigned long start = INDEX_BASE;\r\nunsigned long end = start + current_cpu_data.icache.waysize;\r\nunsigned long ws_inc = 1UL << current_cpu_data.icache.waybit;\r\nunsigned long ws_end = current_cpu_data.icache.ways <<\r\ncurrent_cpu_data.icache.waybit;\r\nunsigned long ws, addr;\r\nCACHE32_UNROLL32_ALIGN2;\r\nfor (ws = 0; ws < ws_end; ws += ws_inc)\r\nfor (addr = start + 0x400; addr < end; addr += 0x400 * 2)\r\ncache32_unroll32(addr|ws, Index_Invalidate_I);\r\nCACHE32_UNROLL32_ALIGN;\r\nfor (ws = 0; ws < ws_end; ws += ws_inc)\r\nfor (addr = start; addr < end; addr += 0x400 * 2)\r\ncache32_unroll32(addr|ws, Index_Invalidate_I);\r\n}\r\nstatic inline void blast_icache32_r4600_v1_page_indexed(unsigned long page)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nblast_icache32_page_indexed(page);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic inline void tx49_blast_icache32_page_indexed(unsigned long page)\r\n{\r\nunsigned long indexmask = current_cpu_data.icache.waysize - 1;\r\nunsigned long start = INDEX_BASE + (page & indexmask);\r\nunsigned long end = start + PAGE_SIZE;\r\nunsigned long ws_inc = 1UL << current_cpu_data.icache.waybit;\r\nunsigned long ws_end = current_cpu_data.icache.ways <<\r\ncurrent_cpu_data.icache.waybit;\r\nunsigned long ws, addr;\r\nCACHE32_UNROLL32_ALIGN2;\r\nfor (ws = 0; ws < ws_end; ws += ws_inc)\r\nfor (addr = start + 0x400; addr < end; addr += 0x400 * 2)\r\ncache32_unroll32(addr|ws, Index_Invalidate_I);\r\nCACHE32_UNROLL32_ALIGN;\r\nfor (ws = 0; ws < ws_end; ws += ws_inc)\r\nfor (addr = start; addr < end; addr += 0x400 * 2)\r\ncache32_unroll32(addr|ws, Index_Invalidate_I);\r\n}\r\nstatic void r4k_blast_icache_page_setup(void)\r\n{\r\nunsigned long ic_lsize = cpu_icache_line_size();\r\nif (ic_lsize == 0)\r\nr4k_blast_icache_page = (void *)cache_noop;\r\nelse if (ic_lsize == 16)\r\nr4k_blast_icache_page = blast_icache16_page;\r\nelse if (ic_lsize == 32 && current_cpu_type() == CPU_LOONGSON2)\r\nr4k_blast_icache_page = loongson2_blast_icache32_page;\r\nelse if (ic_lsize == 32)\r\nr4k_blast_icache_page = blast_icache32_page;\r\nelse if (ic_lsize == 64)\r\nr4k_blast_icache_page = blast_icache64_page;\r\nelse if (ic_lsize == 128)\r\nr4k_blast_icache_page = blast_icache128_page;\r\n}\r\nstatic void r4k_blast_icache_user_page_setup(void)\r\n{\r\nunsigned long ic_lsize = cpu_icache_line_size();\r\nif (ic_lsize == 0)\r\nr4k_blast_icache_user_page = (void *)cache_noop;\r\nelse if (ic_lsize == 16)\r\nr4k_blast_icache_user_page = blast_icache16_user_page;\r\nelse if (ic_lsize == 32)\r\nr4k_blast_icache_user_page = blast_icache32_user_page;\r\nelse if (ic_lsize == 64)\r\nr4k_blast_icache_user_page = blast_icache64_user_page;\r\n}\r\nstatic void r4k_blast_icache_page_indexed_setup(void)\r\n{\r\nunsigned long ic_lsize = cpu_icache_line_size();\r\nif (ic_lsize == 0)\r\nr4k_blast_icache_page_indexed = (void *)cache_noop;\r\nelse if (ic_lsize == 16)\r\nr4k_blast_icache_page_indexed = blast_icache16_page_indexed;\r\nelse if (ic_lsize == 32) {\r\nif (R4600_V1_INDEX_ICACHEOP_WAR && cpu_is_r4600_v1_x())\r\nr4k_blast_icache_page_indexed =\r\nblast_icache32_r4600_v1_page_indexed;\r\nelse if (TX49XX_ICACHE_INDEX_INV_WAR)\r\nr4k_blast_icache_page_indexed =\r\ntx49_blast_icache32_page_indexed;\r\nelse if (current_cpu_type() == CPU_LOONGSON2)\r\nr4k_blast_icache_page_indexed =\r\nloongson2_blast_icache32_page_indexed;\r\nelse\r\nr4k_blast_icache_page_indexed =\r\nblast_icache32_page_indexed;\r\n} else if (ic_lsize == 64)\r\nr4k_blast_icache_page_indexed = blast_icache64_page_indexed;\r\n}\r\nstatic void r4k_blast_icache_setup(void)\r\n{\r\nunsigned long ic_lsize = cpu_icache_line_size();\r\nif (ic_lsize == 0)\r\nr4k_blast_icache = (void *)cache_noop;\r\nelse if (ic_lsize == 16)\r\nr4k_blast_icache = blast_icache16;\r\nelse if (ic_lsize == 32) {\r\nif (R4600_V1_INDEX_ICACHEOP_WAR && cpu_is_r4600_v1_x())\r\nr4k_blast_icache = blast_r4600_v1_icache32;\r\nelse if (TX49XX_ICACHE_INDEX_INV_WAR)\r\nr4k_blast_icache = tx49_blast_icache32;\r\nelse if (current_cpu_type() == CPU_LOONGSON2)\r\nr4k_blast_icache = loongson2_blast_icache32;\r\nelse\r\nr4k_blast_icache = blast_icache32;\r\n} else if (ic_lsize == 64)\r\nr4k_blast_icache = blast_icache64;\r\nelse if (ic_lsize == 128)\r\nr4k_blast_icache = blast_icache128;\r\n}\r\nstatic void r4k_blast_scache_page_setup(void)\r\n{\r\nunsigned long sc_lsize = cpu_scache_line_size();\r\nif (scache_size == 0)\r\nr4k_blast_scache_page = (void *)cache_noop;\r\nelse if (sc_lsize == 16)\r\nr4k_blast_scache_page = blast_scache16_page;\r\nelse if (sc_lsize == 32)\r\nr4k_blast_scache_page = blast_scache32_page;\r\nelse if (sc_lsize == 64)\r\nr4k_blast_scache_page = blast_scache64_page;\r\nelse if (sc_lsize == 128)\r\nr4k_blast_scache_page = blast_scache128_page;\r\n}\r\nstatic void r4k_blast_scache_page_indexed_setup(void)\r\n{\r\nunsigned long sc_lsize = cpu_scache_line_size();\r\nif (scache_size == 0)\r\nr4k_blast_scache_page_indexed = (void *)cache_noop;\r\nelse if (sc_lsize == 16)\r\nr4k_blast_scache_page_indexed = blast_scache16_page_indexed;\r\nelse if (sc_lsize == 32)\r\nr4k_blast_scache_page_indexed = blast_scache32_page_indexed;\r\nelse if (sc_lsize == 64)\r\nr4k_blast_scache_page_indexed = blast_scache64_page_indexed;\r\nelse if (sc_lsize == 128)\r\nr4k_blast_scache_page_indexed = blast_scache128_page_indexed;\r\n}\r\nstatic void r4k_blast_scache_setup(void)\r\n{\r\nunsigned long sc_lsize = cpu_scache_line_size();\r\nif (scache_size == 0)\r\nr4k_blast_scache = (void *)cache_noop;\r\nelse if (sc_lsize == 16)\r\nr4k_blast_scache = blast_scache16;\r\nelse if (sc_lsize == 32)\r\nr4k_blast_scache = blast_scache32;\r\nelse if (sc_lsize == 64)\r\nr4k_blast_scache = blast_scache64;\r\nelse if (sc_lsize == 128)\r\nr4k_blast_scache = blast_scache128;\r\n}\r\nstatic inline void local_r4k___flush_cache_all(void * args)\r\n{\r\nswitch (current_cpu_type()) {\r\ncase CPU_LOONGSON2:\r\ncase CPU_LOONGSON3:\r\ncase CPU_R4000SC:\r\ncase CPU_R4000MC:\r\ncase CPU_R4400SC:\r\ncase CPU_R4400MC:\r\ncase CPU_R10000:\r\ncase CPU_R12000:\r\ncase CPU_R14000:\r\ncase CPU_R16000:\r\nr4k_blast_scache();\r\nbreak;\r\ndefault:\r\nr4k_blast_dcache();\r\nr4k_blast_icache();\r\nbreak;\r\n}\r\n}\r\nstatic void r4k___flush_cache_all(void)\r\n{\r\nr4k_on_each_cpu(local_r4k___flush_cache_all, NULL);\r\n}\r\nstatic inline int has_valid_asid(const struct mm_struct *mm)\r\n{\r\n#ifdef CONFIG_MIPS_MT_SMP\r\nint i;\r\nfor_each_online_cpu(i)\r\nif (cpu_context(i, mm))\r\nreturn 1;\r\nreturn 0;\r\n#else\r\nreturn cpu_context(smp_processor_id(), mm);\r\n#endif\r\n}\r\nstatic void r4k__flush_cache_vmap(void)\r\n{\r\nr4k_blast_dcache();\r\n}\r\nstatic void r4k__flush_cache_vunmap(void)\r\n{\r\nr4k_blast_dcache();\r\n}\r\nstatic inline void local_r4k_flush_cache_range(void * args)\r\n{\r\nstruct vm_area_struct *vma = args;\r\nint exec = vma->vm_flags & VM_EXEC;\r\nif (!(has_valid_asid(vma->vm_mm)))\r\nreturn;\r\nr4k_blast_dcache();\r\nif (exec)\r\nr4k_blast_icache();\r\n}\r\nstatic void r4k_flush_cache_range(struct vm_area_struct *vma,\r\nunsigned long start, unsigned long end)\r\n{\r\nint exec = vma->vm_flags & VM_EXEC;\r\nif (cpu_has_dc_aliases || (exec && !cpu_has_ic_fills_f_dc))\r\nr4k_on_each_cpu(local_r4k_flush_cache_range, vma);\r\n}\r\nstatic inline void local_r4k_flush_cache_mm(void * args)\r\n{\r\nstruct mm_struct *mm = args;\r\nif (!has_valid_asid(mm))\r\nreturn;\r\nif (current_cpu_type() == CPU_R4000SC ||\r\ncurrent_cpu_type() == CPU_R4000MC ||\r\ncurrent_cpu_type() == CPU_R4400SC ||\r\ncurrent_cpu_type() == CPU_R4400MC) {\r\nr4k_blast_scache();\r\nreturn;\r\n}\r\nr4k_blast_dcache();\r\n}\r\nstatic void r4k_flush_cache_mm(struct mm_struct *mm)\r\n{\r\nif (!cpu_has_dc_aliases)\r\nreturn;\r\nr4k_on_each_cpu(local_r4k_flush_cache_mm, mm);\r\n}\r\nstatic inline void local_r4k_flush_cache_page(void *args)\r\n{\r\nstruct flush_cache_page_args *fcp_args = args;\r\nstruct vm_area_struct *vma = fcp_args->vma;\r\nunsigned long addr = fcp_args->addr;\r\nstruct page *page = pfn_to_page(fcp_args->pfn);\r\nint exec = vma->vm_flags & VM_EXEC;\r\nstruct mm_struct *mm = vma->vm_mm;\r\nint map_coherent = 0;\r\npgd_t *pgdp;\r\npud_t *pudp;\r\npmd_t *pmdp;\r\npte_t *ptep;\r\nvoid *vaddr;\r\nif (!has_valid_asid(mm))\r\nreturn;\r\naddr &= PAGE_MASK;\r\npgdp = pgd_offset(mm, addr);\r\npudp = pud_offset(pgdp, addr);\r\npmdp = pmd_offset(pudp, addr);\r\nptep = pte_offset(pmdp, addr);\r\nif (!(pte_present(*ptep)))\r\nreturn;\r\nif ((mm == current->active_mm) && (pte_val(*ptep) & _PAGE_VALID))\r\nvaddr = NULL;\r\nelse {\r\nmap_coherent = (cpu_has_dc_aliases &&\r\npage_mapcount(page) &&\r\n!Page_dcache_dirty(page));\r\nif (map_coherent)\r\nvaddr = kmap_coherent(page, addr);\r\nelse\r\nvaddr = kmap_atomic(page);\r\naddr = (unsigned long)vaddr;\r\n}\r\nif (cpu_has_dc_aliases || (exec && !cpu_has_ic_fills_f_dc)) {\r\nvaddr ? r4k_blast_dcache_page(addr) :\r\nr4k_blast_dcache_user_page(addr);\r\nif (exec && !cpu_icache_snoops_remote_store)\r\nr4k_blast_scache_page(addr);\r\n}\r\nif (exec) {\r\nif (vaddr && cpu_has_vtag_icache && mm == current->active_mm) {\r\nint cpu = smp_processor_id();\r\nif (cpu_context(cpu, mm) != 0)\r\ndrop_mmu_context(mm, cpu);\r\n} else\r\nvaddr ? r4k_blast_icache_page(addr) :\r\nr4k_blast_icache_user_page(addr);\r\n}\r\nif (vaddr) {\r\nif (map_coherent)\r\nkunmap_coherent();\r\nelse\r\nkunmap_atomic(vaddr);\r\n}\r\n}\r\nstatic void r4k_flush_cache_page(struct vm_area_struct *vma,\r\nunsigned long addr, unsigned long pfn)\r\n{\r\nstruct flush_cache_page_args args;\r\nargs.vma = vma;\r\nargs.addr = addr;\r\nargs.pfn = pfn;\r\nr4k_on_each_cpu(local_r4k_flush_cache_page, &args);\r\n}\r\nstatic inline void local_r4k_flush_data_cache_page(void * addr)\r\n{\r\nr4k_blast_dcache_page((unsigned long) addr);\r\n}\r\nstatic void r4k_flush_data_cache_page(unsigned long addr)\r\n{\r\nif (in_atomic())\r\nlocal_r4k_flush_data_cache_page((void *)addr);\r\nelse\r\nr4k_on_each_cpu(local_r4k_flush_data_cache_page, (void *) addr);\r\n}\r\nstatic inline void local_r4k_flush_icache_range(unsigned long start, unsigned long end)\r\n{\r\nif (!cpu_has_ic_fills_f_dc) {\r\nif (end - start >= dcache_size) {\r\nr4k_blast_dcache();\r\n} else {\r\nR4600_HIT_CACHEOP_WAR_IMPL;\r\nprotected_blast_dcache_range(start, end);\r\n}\r\n}\r\nif (end - start > icache_size)\r\nr4k_blast_icache();\r\nelse {\r\nswitch (boot_cpu_type()) {\r\ncase CPU_LOONGSON2:\r\nprotected_loongson2_blast_icache_range(start, end);\r\nbreak;\r\ndefault:\r\nprotected_blast_icache_range(start, end);\r\nbreak;\r\n}\r\n}\r\n#ifdef CONFIG_EVA\r\nbc_wback_inv(start, (end - start));\r\n__sync();\r\n#endif\r\n}\r\nstatic inline void local_r4k_flush_icache_range_ipi(void *args)\r\n{\r\nstruct flush_icache_range_args *fir_args = args;\r\nunsigned long start = fir_args->start;\r\nunsigned long end = fir_args->end;\r\nlocal_r4k_flush_icache_range(start, end);\r\n}\r\nstatic void r4k_flush_icache_range(unsigned long start, unsigned long end)\r\n{\r\nstruct flush_icache_range_args args;\r\nargs.start = start;\r\nargs.end = end;\r\nr4k_on_each_cpu(local_r4k_flush_icache_range_ipi, &args);\r\ninstruction_hazard();\r\n}\r\nstatic void r4k_dma_cache_wback_inv(unsigned long addr, unsigned long size)\r\n{\r\nBUG_ON(size == 0);\r\npreempt_disable();\r\nif (cpu_has_inclusive_pcaches) {\r\nif (size >= scache_size)\r\nr4k_blast_scache();\r\nelse\r\nblast_scache_range(addr, addr + size);\r\npreempt_enable();\r\n__sync();\r\nreturn;\r\n}\r\nif (cpu_has_safe_index_cacheops && size >= dcache_size) {\r\nr4k_blast_dcache();\r\n} else {\r\nR4600_HIT_CACHEOP_WAR_IMPL;\r\nblast_dcache_range(addr, addr + size);\r\n}\r\npreempt_enable();\r\nbc_wback_inv(addr, size);\r\n__sync();\r\n}\r\nstatic void r4k_dma_cache_inv(unsigned long addr, unsigned long size)\r\n{\r\nBUG_ON(size == 0);\r\npreempt_disable();\r\nif (cpu_has_inclusive_pcaches) {\r\nif (size >= scache_size)\r\nr4k_blast_scache();\r\nelse {\r\nblast_inv_scache_range(addr, addr + size);\r\n}\r\npreempt_enable();\r\n__sync();\r\nreturn;\r\n}\r\nif (cpu_has_safe_index_cacheops && size >= dcache_size) {\r\nr4k_blast_dcache();\r\n} else {\r\nR4600_HIT_CACHEOP_WAR_IMPL;\r\nblast_inv_dcache_range(addr, addr + size);\r\n}\r\npreempt_enable();\r\nbc_inv(addr, size);\r\n__sync();\r\n}\r\nstatic void local_r4k_flush_cache_sigtramp(void * arg)\r\n{\r\nunsigned long ic_lsize = cpu_icache_line_size();\r\nunsigned long dc_lsize = cpu_dcache_line_size();\r\nunsigned long sc_lsize = cpu_scache_line_size();\r\nunsigned long addr = (unsigned long) arg;\r\nR4600_HIT_CACHEOP_WAR_IMPL;\r\nif (dc_lsize)\r\nprotected_writeback_dcache_line(addr & ~(dc_lsize - 1));\r\nif (!cpu_icache_snoops_remote_store && scache_size)\r\nprotected_writeback_scache_line(addr & ~(sc_lsize - 1));\r\nif (ic_lsize)\r\nprotected_flush_icache_line(addr & ~(ic_lsize - 1));\r\nif (MIPS4K_ICACHE_REFILL_WAR) {\r\n__asm__ __volatile__ (\r\n".set push\n\t"\r\n".set noat\n\t"\r\n".set "MIPS_ISA_LEVEL"\n\t"\r\n#ifdef CONFIG_32BIT\r\n"la $at,1f\n\t"\r\n#endif\r\n#ifdef CONFIG_64BIT\r\n"dla $at,1f\n\t"\r\n#endif\r\n"cache %0,($at)\n\t"\r\n"nop; nop; nop\n"\r\n"1:\n\t"\r\n".set pop"\r\n:\r\n: "i" (Hit_Invalidate_I));\r\n}\r\nif (MIPS_CACHE_SYNC_WAR)\r\n__asm__ __volatile__ ("sync");\r\n}\r\nstatic void r4k_flush_cache_sigtramp(unsigned long addr)\r\n{\r\nr4k_on_each_cpu(local_r4k_flush_cache_sigtramp, (void *) addr);\r\n}\r\nstatic void r4k_flush_icache_all(void)\r\n{\r\nif (cpu_has_vtag_icache)\r\nr4k_blast_icache();\r\n}\r\nstatic inline void local_r4k_flush_kernel_vmap_range(void *args)\r\n{\r\nstruct flush_kernel_vmap_range_args *vmra = args;\r\nunsigned long vaddr = vmra->vaddr;\r\nint size = vmra->size;\r\nif (cpu_has_safe_index_cacheops && size >= dcache_size)\r\nr4k_blast_dcache();\r\nelse {\r\nR4600_HIT_CACHEOP_WAR_IMPL;\r\nblast_dcache_range(vaddr, vaddr + size);\r\n}\r\n}\r\nstatic void r4k_flush_kernel_vmap_range(unsigned long vaddr, int size)\r\n{\r\nstruct flush_kernel_vmap_range_args args;\r\nargs.vaddr = (unsigned long) vaddr;\r\nargs.size = size;\r\nr4k_on_each_cpu(local_r4k_flush_kernel_vmap_range, &args);\r\n}\r\nstatic inline void rm7k_erratum31(void)\r\n{\r\nconst unsigned long ic_lsize = 32;\r\nunsigned long addr;\r\nwrite_c0_taglo(0);\r\nwrite_c0_taghi(0);\r\nfor (addr = INDEX_BASE; addr <= INDEX_BASE + 4096; addr += ic_lsize) {\r\n__asm__ __volatile__ (\r\n".set push\n\t"\r\n".set noreorder\n\t"\r\n".set mips3\n\t"\r\n"cache\t%1, 0(%0)\n\t"\r\n"cache\t%1, 0x1000(%0)\n\t"\r\n"cache\t%1, 0x2000(%0)\n\t"\r\n"cache\t%1, 0x3000(%0)\n\t"\r\n"cache\t%2, 0(%0)\n\t"\r\n"cache\t%2, 0x1000(%0)\n\t"\r\n"cache\t%2, 0x2000(%0)\n\t"\r\n"cache\t%2, 0x3000(%0)\n\t"\r\n"cache\t%1, 0(%0)\n\t"\r\n"cache\t%1, 0x1000(%0)\n\t"\r\n"cache\t%1, 0x2000(%0)\n\t"\r\n"cache\t%1, 0x3000(%0)\n\t"\r\n".set pop\n"\r\n:\r\n: "r" (addr), "i" (Index_Store_Tag_I), "i" (Fill));\r\n}\r\n}\r\nstatic inline int alias_74k_erratum(struct cpuinfo_mips *c)\r\n{\r\nunsigned int imp = c->processor_id & PRID_IMP_MASK;\r\nunsigned int rev = c->processor_id & PRID_REV_MASK;\r\nint present = 0;\r\nswitch (imp) {\r\ncase PRID_IMP_74K:\r\nif (rev <= PRID_REV_ENCODE_332(2, 4, 0))\r\npresent = 1;\r\nif (rev == PRID_REV_ENCODE_332(2, 4, 0))\r\nwrite_c0_config6(read_c0_config6() | MIPS_CONF6_SYND);\r\nbreak;\r\ncase PRID_IMP_1074K:\r\nif (rev <= PRID_REV_ENCODE_332(1, 1, 0)) {\r\npresent = 1;\r\nwrite_c0_config6(read_c0_config6() | MIPS_CONF6_SYND);\r\n}\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\nreturn present;\r\n}\r\nstatic void b5k_instruction_hazard(void)\r\n{\r\n__sync();\r\n__sync();\r\n__asm__ __volatile__(\r\n" nop; nop; nop; nop; nop; nop; nop; nop\n"\r\n" nop; nop; nop; nop; nop; nop; nop; nop\n"\r\n" nop; nop; nop; nop; nop; nop; nop; nop\n"\r\n" nop; nop; nop; nop; nop; nop; nop; nop\n"\r\n: : : "memory");\r\n}\r\nstatic void probe_pcache(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nunsigned int config = read_c0_config();\r\nunsigned int prid = read_c0_prid();\r\nint has_74k_erratum = 0;\r\nunsigned long config1;\r\nunsigned int lsize;\r\nswitch (current_cpu_type()) {\r\ncase CPU_R4600:\r\ncase CPU_R4700:\r\ncase CPU_R5000:\r\ncase CPU_NEVADA:\r\nicache_size = 1 << (12 + ((config & CONF_IC) >> 9));\r\nc->icache.linesz = 16 << ((config & CONF_IB) >> 5);\r\nc->icache.ways = 2;\r\nc->icache.waybit = __ffs(icache_size/2);\r\ndcache_size = 1 << (12 + ((config & CONF_DC) >> 6));\r\nc->dcache.linesz = 16 << ((config & CONF_DB) >> 4);\r\nc->dcache.ways = 2;\r\nc->dcache.waybit= __ffs(dcache_size/2);\r\nc->options |= MIPS_CPU_CACHE_CDEX_P;\r\nbreak;\r\ncase CPU_R5432:\r\ncase CPU_R5500:\r\nicache_size = 1 << (12 + ((config & CONF_IC) >> 9));\r\nc->icache.linesz = 16 << ((config & CONF_IB) >> 5);\r\nc->icache.ways = 2;\r\nc->icache.waybit= 0;\r\ndcache_size = 1 << (12 + ((config & CONF_DC) >> 6));\r\nc->dcache.linesz = 16 << ((config & CONF_DB) >> 4);\r\nc->dcache.ways = 2;\r\nc->dcache.waybit = 0;\r\nc->options |= MIPS_CPU_CACHE_CDEX_P | MIPS_CPU_PREFETCH;\r\nbreak;\r\ncase CPU_TX49XX:\r\nicache_size = 1 << (12 + ((config & CONF_IC) >> 9));\r\nc->icache.linesz = 16 << ((config & CONF_IB) >> 5);\r\nc->icache.ways = 4;\r\nc->icache.waybit= 0;\r\ndcache_size = 1 << (12 + ((config & CONF_DC) >> 6));\r\nc->dcache.linesz = 16 << ((config & CONF_DB) >> 4);\r\nc->dcache.ways = 4;\r\nc->dcache.waybit = 0;\r\nc->options |= MIPS_CPU_CACHE_CDEX_P;\r\nc->options |= MIPS_CPU_PREFETCH;\r\nbreak;\r\ncase CPU_R4000PC:\r\ncase CPU_R4000SC:\r\ncase CPU_R4000MC:\r\ncase CPU_R4400PC:\r\ncase CPU_R4400SC:\r\ncase CPU_R4400MC:\r\ncase CPU_R4300:\r\nicache_size = 1 << (12 + ((config & CONF_IC) >> 9));\r\nc->icache.linesz = 16 << ((config & CONF_IB) >> 5);\r\nc->icache.ways = 1;\r\nc->icache.waybit = 0;\r\ndcache_size = 1 << (12 + ((config & CONF_DC) >> 6));\r\nc->dcache.linesz = 16 << ((config & CONF_DB) >> 4);\r\nc->dcache.ways = 1;\r\nc->dcache.waybit = 0;\r\nc->options |= MIPS_CPU_CACHE_CDEX_P;\r\nbreak;\r\ncase CPU_R10000:\r\ncase CPU_R12000:\r\ncase CPU_R14000:\r\ncase CPU_R16000:\r\nicache_size = 1 << (12 + ((config & R10K_CONF_IC) >> 29));\r\nc->icache.linesz = 64;\r\nc->icache.ways = 2;\r\nc->icache.waybit = 0;\r\ndcache_size = 1 << (12 + ((config & R10K_CONF_DC) >> 26));\r\nc->dcache.linesz = 32;\r\nc->dcache.ways = 2;\r\nc->dcache.waybit = 0;\r\nc->options |= MIPS_CPU_PREFETCH;\r\nbreak;\r\ncase CPU_VR4133:\r\nwrite_c0_config(config & ~VR41_CONF_P4K);\r\ncase CPU_VR4131:\r\nif (c->processor_id == 0x0c80U || c->processor_id == 0x0c81U ||\r\nc->processor_id == 0x0c82U) {\r\nconfig |= 0x00400000U;\r\nif (c->processor_id == 0x0c80U)\r\nconfig |= VR41_CONF_BP;\r\nwrite_c0_config(config);\r\n} else\r\nc->options |= MIPS_CPU_CACHE_CDEX_P;\r\nicache_size = 1 << (10 + ((config & CONF_IC) >> 9));\r\nc->icache.linesz = 16 << ((config & CONF_IB) >> 5);\r\nc->icache.ways = 2;\r\nc->icache.waybit = __ffs(icache_size/2);\r\ndcache_size = 1 << (10 + ((config & CONF_DC) >> 6));\r\nc->dcache.linesz = 16 << ((config & CONF_DB) >> 4);\r\nc->dcache.ways = 2;\r\nc->dcache.waybit = __ffs(dcache_size/2);\r\nbreak;\r\ncase CPU_VR41XX:\r\ncase CPU_VR4111:\r\ncase CPU_VR4121:\r\ncase CPU_VR4122:\r\ncase CPU_VR4181:\r\ncase CPU_VR4181A:\r\nicache_size = 1 << (10 + ((config & CONF_IC) >> 9));\r\nc->icache.linesz = 16 << ((config & CONF_IB) >> 5);\r\nc->icache.ways = 1;\r\nc->icache.waybit = 0;\r\ndcache_size = 1 << (10 + ((config & CONF_DC) >> 6));\r\nc->dcache.linesz = 16 << ((config & CONF_DB) >> 4);\r\nc->dcache.ways = 1;\r\nc->dcache.waybit = 0;\r\nc->options |= MIPS_CPU_CACHE_CDEX_P;\r\nbreak;\r\ncase CPU_RM7000:\r\nrm7k_erratum31();\r\nicache_size = 1 << (12 + ((config & CONF_IC) >> 9));\r\nc->icache.linesz = 16 << ((config & CONF_IB) >> 5);\r\nc->icache.ways = 4;\r\nc->icache.waybit = __ffs(icache_size / c->icache.ways);\r\ndcache_size = 1 << (12 + ((config & CONF_DC) >> 6));\r\nc->dcache.linesz = 16 << ((config & CONF_DB) >> 4);\r\nc->dcache.ways = 4;\r\nc->dcache.waybit = __ffs(dcache_size / c->dcache.ways);\r\nc->options |= MIPS_CPU_CACHE_CDEX_P;\r\nc->options |= MIPS_CPU_PREFETCH;\r\nbreak;\r\ncase CPU_LOONGSON2:\r\nicache_size = 1 << (12 + ((config & CONF_IC) >> 9));\r\nc->icache.linesz = 16 << ((config & CONF_IB) >> 5);\r\nif (prid & 0x3)\r\nc->icache.ways = 4;\r\nelse\r\nc->icache.ways = 2;\r\nc->icache.waybit = 0;\r\ndcache_size = 1 << (12 + ((config & CONF_DC) >> 6));\r\nc->dcache.linesz = 16 << ((config & CONF_DB) >> 4);\r\nif (prid & 0x3)\r\nc->dcache.ways = 4;\r\nelse\r\nc->dcache.ways = 2;\r\nc->dcache.waybit = 0;\r\nbreak;\r\ncase CPU_LOONGSON3:\r\nconfig1 = read_c0_config1();\r\nlsize = (config1 >> 19) & 7;\r\nif (lsize)\r\nc->icache.linesz = 2 << lsize;\r\nelse\r\nc->icache.linesz = 0;\r\nc->icache.sets = 64 << ((config1 >> 22) & 7);\r\nc->icache.ways = 1 + ((config1 >> 16) & 7);\r\nicache_size = c->icache.sets *\r\nc->icache.ways *\r\nc->icache.linesz;\r\nc->icache.waybit = 0;\r\nlsize = (config1 >> 10) & 7;\r\nif (lsize)\r\nc->dcache.linesz = 2 << lsize;\r\nelse\r\nc->dcache.linesz = 0;\r\nc->dcache.sets = 64 << ((config1 >> 13) & 7);\r\nc->dcache.ways = 1 + ((config1 >> 7) & 7);\r\ndcache_size = c->dcache.sets *\r\nc->dcache.ways *\r\nc->dcache.linesz;\r\nc->dcache.waybit = 0;\r\nbreak;\r\ncase CPU_CAVIUM_OCTEON3:\r\nc->icache.linesz = 128;\r\nc->icache.sets = 16;\r\nc->icache.ways = 8;\r\nc->icache.flags |= MIPS_CACHE_VTAG;\r\nicache_size = c->icache.sets * c->icache.ways * c->icache.linesz;\r\nc->dcache.linesz = 128;\r\nc->dcache.ways = 8;\r\nc->dcache.sets = 8;\r\ndcache_size = c->dcache.sets * c->dcache.ways * c->dcache.linesz;\r\nc->options |= MIPS_CPU_PREFETCH;\r\nbreak;\r\ndefault:\r\nif (!(config & MIPS_CONF_M))\r\npanic("Don't know how to probe P-caches on this cpu.");\r\nconfig1 = read_c0_config1();\r\nlsize = (config1 >> 19) & 7;\r\nif (lsize == 7)\r\npanic("Invalid icache line size");\r\nc->icache.linesz = lsize ? 2 << lsize : 0;\r\nc->icache.sets = 32 << (((config1 >> 22) + 1) & 7);\r\nc->icache.ways = 1 + ((config1 >> 16) & 7);\r\nicache_size = c->icache.sets *\r\nc->icache.ways *\r\nc->icache.linesz;\r\nc->icache.waybit = __ffs(icache_size/c->icache.ways);\r\nif (config & 0x8)\r\nc->icache.flags |= MIPS_CACHE_VTAG;\r\nc->dcache.flags = 0;\r\nlsize = (config1 >> 10) & 7;\r\nif (lsize == 7)\r\npanic("Invalid dcache line size");\r\nc->dcache.linesz = lsize ? 2 << lsize : 0;\r\nc->dcache.sets = 32 << (((config1 >> 13) + 1) & 7);\r\nc->dcache.ways = 1 + ((config1 >> 7) & 7);\r\ndcache_size = c->dcache.sets *\r\nc->dcache.ways *\r\nc->dcache.linesz;\r\nc->dcache.waybit = __ffs(dcache_size/c->dcache.ways);\r\nc->options |= MIPS_CPU_PREFETCH;\r\nbreak;\r\n}\r\nif ((prid & PRID_IMP_MASK) == PRID_IMP_R4000 &&\r\n(prid & PRID_REV_MASK) < PRID_REV_R4400 &&\r\n!(config & CONF_SC) && c->icache.linesz != 16 &&\r\nPAGE_SIZE <= 0x8000)\r\npanic("Improper R4000SC processor configuration detected");\r\nc->icache.waysize = icache_size / c->icache.ways;\r\nc->dcache.waysize = dcache_size / c->dcache.ways;\r\nc->icache.sets = c->icache.linesz ?\r\nicache_size / (c->icache.linesz * c->icache.ways) : 0;\r\nc->dcache.sets = c->dcache.linesz ?\r\ndcache_size / (c->dcache.linesz * c->dcache.ways) : 0;\r\nswitch (current_cpu_type()) {\r\ncase CPU_20KC:\r\ncase CPU_25KF:\r\ncase CPU_SB1:\r\ncase CPU_SB1A:\r\ncase CPU_XLR:\r\nc->dcache.flags |= MIPS_CACHE_PINDEX;\r\nbreak;\r\ncase CPU_R10000:\r\ncase CPU_R12000:\r\ncase CPU_R14000:\r\ncase CPU_R16000:\r\nbreak;\r\ncase CPU_74K:\r\ncase CPU_1074K:\r\nhas_74k_erratum = alias_74k_erratum(c);\r\ncase CPU_M14KC:\r\ncase CPU_M14KEC:\r\ncase CPU_24K:\r\ncase CPU_34K:\r\ncase CPU_1004K:\r\ncase CPU_INTERAPTIV:\r\ncase CPU_P5600:\r\ncase CPU_PROAPTIV:\r\ncase CPU_M5150:\r\ncase CPU_QEMU_GENERIC:\r\ncase CPU_I6400:\r\nif (!(read_c0_config7() & MIPS_CONF7_IAR) &&\r\n(c->icache.waysize > PAGE_SIZE))\r\nc->icache.flags |= MIPS_CACHE_ALIASES;\r\nif (!has_74k_erratum && (read_c0_config7() & MIPS_CONF7_AR)) {\r\nc->dcache.flags |= MIPS_CACHE_PINDEX;\r\nbreak;\r\n}\r\ndefault:\r\nif (has_74k_erratum || c->dcache.waysize > PAGE_SIZE)\r\nc->dcache.flags |= MIPS_CACHE_ALIASES;\r\n}\r\nswitch (current_cpu_type()) {\r\ncase CPU_20KC:\r\nc->icache.flags |= MIPS_CACHE_VTAG;\r\nbreak;\r\ncase CPU_ALCHEMY:\r\nc->icache.flags |= MIPS_CACHE_IC_F_DC;\r\nbreak;\r\ncase CPU_LOONGSON2:\r\nc->icache.ways = 1;\r\n}\r\nprintk("Primary instruction cache %ldkB, %s, %s, linesize %d bytes.\n",\r\nicache_size >> 10,\r\nc->icache.flags & MIPS_CACHE_VTAG ? "VIVT" : "VIPT",\r\nway_string[c->icache.ways], c->icache.linesz);\r\nprintk("Primary data cache %ldkB, %s, %s, %s, linesize %d bytes\n",\r\ndcache_size >> 10, way_string[c->dcache.ways],\r\n(c->dcache.flags & MIPS_CACHE_PINDEX) ? "PIPT" : "VIPT",\r\n(c->dcache.flags & MIPS_CACHE_ALIASES) ?\r\n"cache aliases" : "no aliases",\r\nc->dcache.linesz);\r\n}\r\nstatic int probe_scache(void)\r\n{\r\nunsigned long flags, addr, begin, end, pow2;\r\nunsigned int config = read_c0_config();\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nif (config & CONF_SC)\r\nreturn 0;\r\nbegin = (unsigned long) &_stext;\r\nbegin &= ~((4 * 1024 * 1024) - 1);\r\nend = begin + (4 * 1024 * 1024);\r\nlocal_irq_save(flags);\r\npow2 = (64 * 1024);\r\nfor (addr = begin; addr < end; addr = (begin + pow2)) {\r\nunsigned long *p = (unsigned long *) addr;\r\n__asm__ __volatile__("nop" : : "r" (*p));\r\npow2 <<= 1;\r\n}\r\nwrite_c0_taglo(0);\r\nwrite_c0_taghi(0);\r\n__asm__ __volatile__("nop; nop; nop; nop;");\r\ncache_op(Index_Store_Tag_I, begin);\r\ncache_op(Index_Store_Tag_D, begin);\r\ncache_op(Index_Store_Tag_SD, begin);\r\npow2 = (128 * 1024);\r\nfor (addr = begin + (128 * 1024); addr < end; addr = begin + pow2) {\r\ncache_op(Index_Load_Tag_SD, addr);\r\n__asm__ __volatile__("nop; nop; nop; nop;");\r\nif (!read_c0_taglo())\r\nbreak;\r\npow2 <<= 1;\r\n}\r\nlocal_irq_restore(flags);\r\naddr -= begin;\r\nscache_size = addr;\r\nc->scache.linesz = 16 << ((config & R4K_CONF_SB) >> 22);\r\nc->scache.ways = 1;\r\nc->scache.waybit = 0;\r\nreturn 1;\r\n}\r\nstatic void __init loongson2_sc_init(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nscache_size = 512*1024;\r\nc->scache.linesz = 32;\r\nc->scache.ways = 4;\r\nc->scache.waybit = 0;\r\nc->scache.waysize = scache_size / (c->scache.ways);\r\nc->scache.sets = scache_size / (c->scache.linesz * c->scache.ways);\r\npr_info("Unified secondary cache %ldkB %s, linesize %d bytes.\n",\r\nscache_size >> 10, way_string[c->scache.ways], c->scache.linesz);\r\nc->options |= MIPS_CPU_INCLUSIVE_CACHES;\r\n}\r\nstatic void __init loongson3_sc_init(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nunsigned int config2, lsize;\r\nconfig2 = read_c0_config2();\r\nlsize = (config2 >> 4) & 15;\r\nif (lsize)\r\nc->scache.linesz = 2 << lsize;\r\nelse\r\nc->scache.linesz = 0;\r\nc->scache.sets = 64 << ((config2 >> 8) & 15);\r\nc->scache.ways = 1 + (config2 & 15);\r\nscache_size = c->scache.sets *\r\nc->scache.ways *\r\nc->scache.linesz;\r\nscache_size *= 4;\r\nc->scache.waybit = 0;\r\npr_info("Unified secondary cache %ldkB %s, linesize %d bytes.\n",\r\nscache_size >> 10, way_string[c->scache.ways], c->scache.linesz);\r\nif (scache_size)\r\nc->options |= MIPS_CPU_INCLUSIVE_CACHES;\r\nreturn;\r\n}\r\nstatic void setup_scache(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nunsigned int config = read_c0_config();\r\nint sc_present = 0;\r\nswitch (current_cpu_type()) {\r\ncase CPU_R4000SC:\r\ncase CPU_R4000MC:\r\ncase CPU_R4400SC:\r\ncase CPU_R4400MC:\r\nsc_present = run_uncached(probe_scache);\r\nif (sc_present)\r\nc->options |= MIPS_CPU_CACHE_CDEX_S;\r\nbreak;\r\ncase CPU_R10000:\r\ncase CPU_R12000:\r\ncase CPU_R14000:\r\ncase CPU_R16000:\r\nscache_size = 0x80000 << ((config & R10K_CONF_SS) >> 16);\r\nc->scache.linesz = 64 << ((config >> 13) & 1);\r\nc->scache.ways = 2;\r\nc->scache.waybit= 0;\r\nsc_present = 1;\r\nbreak;\r\ncase CPU_R5000:\r\ncase CPU_NEVADA:\r\n#ifdef CONFIG_R5000_CPU_SCACHE\r\nr5k_sc_init();\r\n#endif\r\nreturn;\r\ncase CPU_RM7000:\r\n#ifdef CONFIG_RM7000_CPU_SCACHE\r\nrm7k_sc_init();\r\n#endif\r\nreturn;\r\ncase CPU_LOONGSON2:\r\nloongson2_sc_init();\r\nreturn;\r\ncase CPU_LOONGSON3:\r\nloongson3_sc_init();\r\nreturn;\r\ncase CPU_CAVIUM_OCTEON3:\r\ncase CPU_XLP:\r\nreturn;\r\ndefault:\r\nif (c->isa_level & (MIPS_CPU_ISA_M32R1 | MIPS_CPU_ISA_M32R2 |\r\nMIPS_CPU_ISA_M32R6 | MIPS_CPU_ISA_M64R1 |\r\nMIPS_CPU_ISA_M64R2 | MIPS_CPU_ISA_M64R6)) {\r\n#ifdef CONFIG_MIPS_CPU_SCACHE\r\nif (mips_sc_init ()) {\r\nscache_size = c->scache.ways * c->scache.sets * c->scache.linesz;\r\nprintk("MIPS secondary cache %ldkB, %s, linesize %d bytes.\n",\r\nscache_size >> 10,\r\nway_string[c->scache.ways], c->scache.linesz);\r\n}\r\n#else\r\nif (!(c->scache.flags & MIPS_CACHE_NOT_PRESENT))\r\npanic("Dunno how to handle MIPS32 / MIPS64 second level cache");\r\n#endif\r\nreturn;\r\n}\r\nsc_present = 0;\r\n}\r\nif (!sc_present)\r\nreturn;\r\nc->scache.waysize = scache_size / c->scache.ways;\r\nc->scache.sets = scache_size / (c->scache.linesz * c->scache.ways);\r\nprintk("Unified secondary cache %ldkB %s, linesize %d bytes.\n",\r\nscache_size >> 10, way_string[c->scache.ways], c->scache.linesz);\r\nc->options |= MIPS_CPU_INCLUSIVE_CACHES;\r\n}\r\nvoid au1x00_fixup_config_od(void)\r\n{\r\nswitch (read_c0_prid()) {\r\ncase 0x00030100:\r\ncase 0x00030201:\r\ncase 0x00030202:\r\ncase 0x01030200:\r\ncase 0x02030200:\r\ncase 0x02030201:\r\ncase 0x02030202:\r\nset_c0_config(1 << 19);\r\nbreak;\r\n}\r\n}\r\nstatic void nxp_pr4450_fixup_config(void)\r\n{\r\nunsigned long config0;\r\nconfig0 = read_c0_config();\r\nconfig0 &= ~(0x7 | (7 << 25) | (7 << 28));\r\nconfig0 |= (((_page_cachable_default >> _CACHE_SHIFT) << 0) |\r\n((_page_cachable_default >> _CACHE_SHIFT) << 25) |\r\n((_page_cachable_default >> _CACHE_SHIFT) << 28));\r\nwrite_c0_config(config0);\r\nNXP_BARRIER();\r\n}\r\nstatic int __init cca_setup(char *str)\r\n{\r\nget_option(&str, &cca);\r\nreturn 0;\r\n}\r\nstatic void coherency_setup(void)\r\n{\r\nif (cca < 0 || cca > 7)\r\ncca = read_c0_config() & CONF_CM_CMASK;\r\n_page_cachable_default = cca << _CACHE_SHIFT;\r\npr_debug("Using cache attribute %d\n", cca);\r\nchange_c0_config(CONF_CM_CMASK, cca);\r\nswitch (current_cpu_type()) {\r\ncase CPU_R4000PC:\r\ncase CPU_R4000SC:\r\ncase CPU_R4000MC:\r\ncase CPU_R4400PC:\r\ncase CPU_R4400SC:\r\ncase CPU_R4400MC:\r\nclear_c0_config(CONF_CU);\r\nbreak;\r\ncase CPU_ALCHEMY:\r\nau1x00_fixup_config_od();\r\nbreak;\r\ncase PRID_IMP_PR4450:\r\nnxp_pr4450_fixup_config();\r\nbreak;\r\n}\r\n}\r\nstatic void r4k_cache_error_setup(void)\r\n{\r\nextern char __weak except_vec2_generic;\r\nextern char __weak except_vec2_sb1;\r\nswitch (current_cpu_type()) {\r\ncase CPU_SB1:\r\ncase CPU_SB1A:\r\nset_uncached_handler(0x100, &except_vec2_sb1, 0x80);\r\nbreak;\r\ndefault:\r\nset_uncached_handler(0x100, &except_vec2_generic, 0x80);\r\nbreak;\r\n}\r\n}\r\nvoid r4k_cache_init(void)\r\n{\r\nextern void build_clear_page(void);\r\nextern void build_copy_page(void);\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nprobe_pcache();\r\nsetup_scache();\r\nr4k_blast_dcache_page_setup();\r\nr4k_blast_dcache_page_indexed_setup();\r\nr4k_blast_dcache_setup();\r\nr4k_blast_icache_page_setup();\r\nr4k_blast_icache_page_indexed_setup();\r\nr4k_blast_icache_setup();\r\nr4k_blast_scache_page_setup();\r\nr4k_blast_scache_page_indexed_setup();\r\nr4k_blast_scache_setup();\r\n#ifdef CONFIG_EVA\r\nr4k_blast_dcache_user_page_setup();\r\nr4k_blast_icache_user_page_setup();\r\n#endif\r\nif (c->dcache.linesz)\r\nshm_align_mask = max_t( unsigned long,\r\nc->dcache.sets * c->dcache.linesz - 1,\r\nPAGE_SIZE - 1);\r\nelse\r\nshm_align_mask = PAGE_SIZE-1;\r\n__flush_cache_vmap = r4k__flush_cache_vmap;\r\n__flush_cache_vunmap = r4k__flush_cache_vunmap;\r\nflush_cache_all = cache_noop;\r\n__flush_cache_all = r4k___flush_cache_all;\r\nflush_cache_mm = r4k_flush_cache_mm;\r\nflush_cache_page = r4k_flush_cache_page;\r\nflush_cache_range = r4k_flush_cache_range;\r\n__flush_kernel_vmap_range = r4k_flush_kernel_vmap_range;\r\nflush_cache_sigtramp = r4k_flush_cache_sigtramp;\r\nflush_icache_all = r4k_flush_icache_all;\r\nlocal_flush_data_cache_page = local_r4k_flush_data_cache_page;\r\nflush_data_cache_page = r4k_flush_data_cache_page;\r\nflush_icache_range = r4k_flush_icache_range;\r\nlocal_flush_icache_range = local_r4k_flush_icache_range;\r\n#if defined(CONFIG_DMA_NONCOHERENT) || defined(CONFIG_DMA_MAYBE_COHERENT)\r\nif (coherentio) {\r\n_dma_cache_wback_inv = (void *)cache_noop;\r\n_dma_cache_wback = (void *)cache_noop;\r\n_dma_cache_inv = (void *)cache_noop;\r\n} else {\r\n_dma_cache_wback_inv = r4k_dma_cache_wback_inv;\r\n_dma_cache_wback = r4k_dma_cache_wback_inv;\r\n_dma_cache_inv = r4k_dma_cache_inv;\r\n}\r\n#endif\r\nbuild_clear_page();\r\nbuild_copy_page();\r\nlocal_r4k___flush_cache_all(NULL);\r\ncoherency_setup();\r\nboard_cache_error_setup = r4k_cache_error_setup;\r\nswitch (current_cpu_type()) {\r\ncase CPU_BMIPS4350:\r\ncase CPU_BMIPS4380:\r\nflush_data_cache_page = r4k_blast_dcache_page;\r\nbreak;\r\ncase CPU_BMIPS5000:\r\nif (c->scache.flags & MIPS_CACHE_NOT_PRESENT)\r\nbreak;\r\nflush_cache_page = (void *)b5k_instruction_hazard;\r\nflush_cache_range = (void *)b5k_instruction_hazard;\r\nflush_cache_sigtramp = (void *)b5k_instruction_hazard;\r\nlocal_flush_data_cache_page = (void *)b5k_instruction_hazard;\r\nflush_data_cache_page = (void *)b5k_instruction_hazard;\r\nflush_icache_range = (void *)b5k_instruction_hazard;\r\nlocal_flush_icache_range = (void *)b5k_instruction_hazard;\r\ncurrent_cpu_data.dcache.flags &= ~MIPS_CACHE_ALIASES;\r\ncurrent_cpu_data.options |= MIPS_CPU_INCLUSIVE_CACHES;\r\nbreak;\r\n}\r\n}\r\nstatic int r4k_cache_pm_notifier(struct notifier_block *self, unsigned long cmd,\r\nvoid *v)\r\n{\r\nswitch (cmd) {\r\ncase CPU_PM_ENTER_FAILED:\r\ncase CPU_PM_EXIT:\r\ncoherency_setup();\r\nbreak;\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nint __init r4k_cache_init_pm(void)\r\n{\r\nreturn cpu_pm_register_notifier(&r4k_cache_pm_notifier_block);\r\n}

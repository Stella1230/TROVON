static int temac_mdio_read(struct mii_bus *bus, int phy_id, int reg)\r\n{\r\nstruct temac_local *lp = bus->priv;\r\nu32 rc;\r\nmutex_lock(&lp->indirect_mutex);\r\ntemac_iow(lp, XTE_LSW0_OFFSET, (phy_id << 5) | reg);\r\nrc = temac_indirect_in32(lp, XTE_MIIMAI_OFFSET);\r\nmutex_unlock(&lp->indirect_mutex);\r\ndev_dbg(lp->dev, "temac_mdio_read(phy_id=%i, reg=%x) == %x\n",\r\nphy_id, reg, rc);\r\nreturn rc;\r\n}\r\nstatic int temac_mdio_write(struct mii_bus *bus, int phy_id, int reg, u16 val)\r\n{\r\nstruct temac_local *lp = bus->priv;\r\ndev_dbg(lp->dev, "temac_mdio_write(phy_id=%i, reg=%x, val=%x)\n",\r\nphy_id, reg, val);\r\nmutex_lock(&lp->indirect_mutex);\r\ntemac_indirect_out32(lp, XTE_MGTDR_OFFSET, val);\r\ntemac_indirect_out32(lp, XTE_MIIMAI_OFFSET, (phy_id << 5) | reg);\r\nmutex_unlock(&lp->indirect_mutex);\r\nreturn 0;\r\n}\r\nint temac_mdio_setup(struct temac_local *lp, struct device_node *np)\r\n{\r\nstruct mii_bus *bus;\r\nu32 bus_hz;\r\nint clk_div;\r\nint rc;\r\nstruct resource res;\r\nclk_div = 0x3f;\r\nif (of_property_read_u32(np, "clock-frequency", &bus_hz) == 0) {\r\nclk_div = bus_hz / (2500 * 1000 * 2) - 1;\r\nif (clk_div < 1)\r\nclk_div = 1;\r\nif (clk_div > 0x3f)\r\nclk_div = 0x3f;\r\n}\r\nmutex_lock(&lp->indirect_mutex);\r\ntemac_indirect_out32(lp, XTE_MC_OFFSET, 1 << 6 | clk_div);\r\nmutex_unlock(&lp->indirect_mutex);\r\nbus = mdiobus_alloc();\r\nif (!bus)\r\nreturn -ENOMEM;\r\nof_address_to_resource(np, 0, &res);\r\nsnprintf(bus->id, MII_BUS_ID_SIZE, "%.8llx",\r\n(unsigned long long)res.start);\r\nbus->priv = lp;\r\nbus->name = "Xilinx TEMAC MDIO";\r\nbus->read = temac_mdio_read;\r\nbus->write = temac_mdio_write;\r\nbus->parent = lp->dev;\r\nlp->mii_bus = bus;\r\nrc = of_mdiobus_register(bus, np);\r\nif (rc)\r\ngoto err_register;\r\nmutex_lock(&lp->indirect_mutex);\r\ndev_dbg(lp->dev, "MDIO bus registered; MC:%x\n",\r\ntemac_indirect_in32(lp, XTE_MC_OFFSET));\r\nmutex_unlock(&lp->indirect_mutex);\r\nreturn 0;\r\nerr_register:\r\nmdiobus_free(bus);\r\nreturn rc;\r\n}\r\nvoid temac_mdio_teardown(struct temac_local *lp)\r\n{\r\nmdiobus_unregister(lp->mii_bus);\r\nmdiobus_free(lp->mii_bus);\r\nlp->mii_bus = NULL;\r\n}

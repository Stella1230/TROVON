static int spear1340_miphy_sata_init(struct spear1340_miphy_priv *priv)\r\n{\r\nregmap_update_bits(priv->misc, SPEAR1340_PCIE_SATA_CFG,\r\nSPEAR1340_PCIE_SATA_CFG_MASK,\r\nSPEAR1340_SATA_CFG_VAL);\r\nregmap_update_bits(priv->misc, SPEAR1340_PCIE_MIPHY_CFG,\r\nSPEAR1340_PCIE_MIPHY_CFG_MASK,\r\nSPEAR1340_PCIE_SATA_MIPHY_CFG_SATA_25M_CRYSTAL_CLK);\r\nregmap_update_bits(priv->misc, SPEAR1340_PCM_CFG,\r\nSPEAR1340_PCM_CFG_SATA_POWER_EN,\r\nSPEAR1340_PCM_CFG_SATA_POWER_EN);\r\nmsleep(20);\r\nregmap_update_bits(priv->misc, SPEAR1340_PERIP1_SW_RST,\r\nSPEAR1340_PERIP1_SW_RSATA, 0);\r\nmsleep(20);\r\nreturn 0;\r\n}\r\nstatic int spear1340_miphy_sata_exit(struct spear1340_miphy_priv *priv)\r\n{\r\nregmap_update_bits(priv->misc, SPEAR1340_PCIE_SATA_CFG,\r\nSPEAR1340_PCIE_SATA_CFG_MASK, 0);\r\nregmap_update_bits(priv->misc, SPEAR1340_PCIE_MIPHY_CFG,\r\nSPEAR1340_PCIE_MIPHY_CFG_MASK, 0);\r\nregmap_update_bits(priv->misc, SPEAR1340_PERIP1_SW_RST,\r\nSPEAR1340_PERIP1_SW_RSATA,\r\nSPEAR1340_PERIP1_SW_RSATA);\r\nmsleep(20);\r\nregmap_update_bits(priv->misc, SPEAR1340_PCM_CFG,\r\nSPEAR1340_PCM_CFG_SATA_POWER_EN, 0);\r\nmsleep(20);\r\nreturn 0;\r\n}\r\nstatic int spear1340_miphy_pcie_init(struct spear1340_miphy_priv *priv)\r\n{\r\nregmap_update_bits(priv->misc, SPEAR1340_PCIE_MIPHY_CFG,\r\nSPEAR1340_PCIE_MIPHY_CFG_MASK,\r\nSPEAR1340_PCIE_SATA_MIPHY_CFG_PCIE);\r\nregmap_update_bits(priv->misc, SPEAR1340_PCIE_SATA_CFG,\r\nSPEAR1340_PCIE_SATA_CFG_MASK,\r\nSPEAR1340_PCIE_CFG_VAL);\r\nreturn 0;\r\n}\r\nstatic int spear1340_miphy_pcie_exit(struct spear1340_miphy_priv *priv)\r\n{\r\nregmap_update_bits(priv->misc, SPEAR1340_PCIE_MIPHY_CFG,\r\nSPEAR1340_PCIE_MIPHY_CFG_MASK, 0);\r\nregmap_update_bits(priv->misc, SPEAR1340_PCIE_SATA_CFG,\r\nSPEAR1340_PCIE_SATA_CFG_MASK, 0);\r\nreturn 0;\r\n}\r\nstatic int spear1340_miphy_init(struct phy *phy)\r\n{\r\nstruct spear1340_miphy_priv *priv = phy_get_drvdata(phy);\r\nint ret = 0;\r\nif (priv->mode == SATA)\r\nret = spear1340_miphy_sata_init(priv);\r\nelse if (priv->mode == PCIE)\r\nret = spear1340_miphy_pcie_init(priv);\r\nreturn ret;\r\n}\r\nstatic int spear1340_miphy_exit(struct phy *phy)\r\n{\r\nstruct spear1340_miphy_priv *priv = phy_get_drvdata(phy);\r\nint ret = 0;\r\nif (priv->mode == SATA)\r\nret = spear1340_miphy_sata_exit(priv);\r\nelse if (priv->mode == PCIE)\r\nret = spear1340_miphy_pcie_exit(priv);\r\nreturn ret;\r\n}\r\nstatic int spear1340_miphy_suspend(struct device *dev)\r\n{\r\nstruct spear1340_miphy_priv *priv = dev_get_drvdata(dev);\r\nint ret = 0;\r\nif (priv->mode == SATA)\r\nret = spear1340_miphy_sata_exit(priv);\r\nreturn ret;\r\n}\r\nstatic int spear1340_miphy_resume(struct device *dev)\r\n{\r\nstruct spear1340_miphy_priv *priv = dev_get_drvdata(dev);\r\nint ret = 0;\r\nif (priv->mode == SATA)\r\nret = spear1340_miphy_sata_init(priv);\r\nreturn ret;\r\n}\r\nstatic struct phy *spear1340_miphy_xlate(struct device *dev,\r\nstruct of_phandle_args *args)\r\n{\r\nstruct spear1340_miphy_priv *priv = dev_get_drvdata(dev);\r\nif (args->args_count < 1) {\r\ndev_err(dev, "DT did not pass correct no of args\n");\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\npriv->mode = args->args[0];\r\nif (priv->mode != SATA && priv->mode != PCIE) {\r\ndev_err(dev, "DT did not pass correct phy mode\n");\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\nreturn priv->phy;\r\n}\r\nstatic int spear1340_miphy_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct spear1340_miphy_priv *priv;\r\nstruct phy_provider *phy_provider;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->misc =\r\nsyscon_regmap_lookup_by_phandle(dev->of_node, "misc");\r\nif (IS_ERR(priv->misc)) {\r\ndev_err(dev, "failed to find misc regmap\n");\r\nreturn PTR_ERR(priv->misc);\r\n}\r\npriv->phy = devm_phy_create(dev, NULL, &spear1340_miphy_ops);\r\nif (IS_ERR(priv->phy)) {\r\ndev_err(dev, "failed to create SATA PCIe PHY\n");\r\nreturn PTR_ERR(priv->phy);\r\n}\r\ndev_set_drvdata(dev, priv);\r\nphy_set_drvdata(priv->phy, priv);\r\nphy_provider =\r\ndevm_of_phy_provider_register(dev, spear1340_miphy_xlate);\r\nif (IS_ERR(phy_provider)) {\r\ndev_err(dev, "failed to register phy provider\n");\r\nreturn PTR_ERR(phy_provider);\r\n}\r\nreturn 0;\r\n}

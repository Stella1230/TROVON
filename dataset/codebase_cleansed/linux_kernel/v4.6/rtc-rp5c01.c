static inline unsigned int rp5c01_read(struct rp5c01_priv *priv,\r\nunsigned int reg)\r\n{\r\nreturn __raw_readl(&priv->regs[reg]) & 0xf;\r\n}\r\nstatic inline void rp5c01_write(struct rp5c01_priv *priv, unsigned int val,\r\nunsigned int reg)\r\n{\r\n__raw_writel(val, &priv->regs[reg]);\r\n}\r\nstatic void rp5c01_lock(struct rp5c01_priv *priv)\r\n{\r\nrp5c01_write(priv, RP5C01_MODE_MODE00, RP5C01_MODE);\r\n}\r\nstatic void rp5c01_unlock(struct rp5c01_priv *priv)\r\n{\r\nrp5c01_write(priv, RP5C01_MODE_TIMER_EN | RP5C01_MODE_MODE01,\r\nRP5C01_MODE);\r\n}\r\nstatic int rp5c01_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct rp5c01_priv *priv = dev_get_drvdata(dev);\r\nspin_lock_irq(&priv->lock);\r\nrp5c01_lock(priv);\r\ntm->tm_sec = rp5c01_read(priv, RP5C01_10_SECOND) * 10 +\r\nrp5c01_read(priv, RP5C01_1_SECOND);\r\ntm->tm_min = rp5c01_read(priv, RP5C01_10_MINUTE) * 10 +\r\nrp5c01_read(priv, RP5C01_1_MINUTE);\r\ntm->tm_hour = rp5c01_read(priv, RP5C01_10_HOUR) * 10 +\r\nrp5c01_read(priv, RP5C01_1_HOUR);\r\ntm->tm_mday = rp5c01_read(priv, RP5C01_10_DAY) * 10 +\r\nrp5c01_read(priv, RP5C01_1_DAY);\r\ntm->tm_wday = rp5c01_read(priv, RP5C01_DAY_OF_WEEK);\r\ntm->tm_mon = rp5c01_read(priv, RP5C01_10_MONTH) * 10 +\r\nrp5c01_read(priv, RP5C01_1_MONTH) - 1;\r\ntm->tm_year = rp5c01_read(priv, RP5C01_10_YEAR) * 10 +\r\nrp5c01_read(priv, RP5C01_1_YEAR);\r\nif (tm->tm_year <= 69)\r\ntm->tm_year += 100;\r\nrp5c01_unlock(priv);\r\nspin_unlock_irq(&priv->lock);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int rp5c01_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct rp5c01_priv *priv = dev_get_drvdata(dev);\r\nspin_lock_irq(&priv->lock);\r\nrp5c01_lock(priv);\r\nrp5c01_write(priv, tm->tm_sec / 10, RP5C01_10_SECOND);\r\nrp5c01_write(priv, tm->tm_sec % 10, RP5C01_1_SECOND);\r\nrp5c01_write(priv, tm->tm_min / 10, RP5C01_10_MINUTE);\r\nrp5c01_write(priv, tm->tm_min % 10, RP5C01_1_MINUTE);\r\nrp5c01_write(priv, tm->tm_hour / 10, RP5C01_10_HOUR);\r\nrp5c01_write(priv, tm->tm_hour % 10, RP5C01_1_HOUR);\r\nrp5c01_write(priv, tm->tm_mday / 10, RP5C01_10_DAY);\r\nrp5c01_write(priv, tm->tm_mday % 10, RP5C01_1_DAY);\r\nif (tm->tm_wday != -1)\r\nrp5c01_write(priv, tm->tm_wday, RP5C01_DAY_OF_WEEK);\r\nrp5c01_write(priv, (tm->tm_mon + 1) / 10, RP5C01_10_MONTH);\r\nrp5c01_write(priv, (tm->tm_mon + 1) % 10, RP5C01_1_MONTH);\r\nif (tm->tm_year >= 100)\r\ntm->tm_year -= 100;\r\nrp5c01_write(priv, tm->tm_year / 10, RP5C01_10_YEAR);\r\nrp5c01_write(priv, tm->tm_year % 10, RP5C01_1_YEAR);\r\nrp5c01_unlock(priv);\r\nspin_unlock_irq(&priv->lock);\r\nreturn 0;\r\n}\r\nstatic ssize_t rp5c01_nvram_read(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t pos, size_t size)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct rp5c01_priv *priv = dev_get_drvdata(dev);\r\nssize_t count;\r\nspin_lock_irq(&priv->lock);\r\nfor (count = 0; count < size; count++) {\r\nu8 data;\r\nrp5c01_write(priv,\r\nRP5C01_MODE_TIMER_EN | RP5C01_MODE_RAM_BLOCK10,\r\nRP5C01_MODE);\r\ndata = rp5c01_read(priv, pos) << 4;\r\nrp5c01_write(priv,\r\nRP5C01_MODE_TIMER_EN | RP5C01_MODE_RAM_BLOCK11,\r\nRP5C01_MODE);\r\ndata |= rp5c01_read(priv, pos++);\r\nrp5c01_write(priv, RP5C01_MODE_TIMER_EN | RP5C01_MODE_MODE01,\r\nRP5C01_MODE);\r\n*buf++ = data;\r\n}\r\nspin_unlock_irq(&priv->lock);\r\nreturn count;\r\n}\r\nstatic ssize_t rp5c01_nvram_write(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t pos, size_t size)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct rp5c01_priv *priv = dev_get_drvdata(dev);\r\nssize_t count;\r\nspin_lock_irq(&priv->lock);\r\nfor (count = 0; count < size; count++) {\r\nu8 data = *buf++;\r\nrp5c01_write(priv,\r\nRP5C01_MODE_TIMER_EN | RP5C01_MODE_RAM_BLOCK10,\r\nRP5C01_MODE);\r\nrp5c01_write(priv, data >> 4, pos);\r\nrp5c01_write(priv,\r\nRP5C01_MODE_TIMER_EN | RP5C01_MODE_RAM_BLOCK11,\r\nRP5C01_MODE);\r\nrp5c01_write(priv, data & 0xf, pos++);\r\nrp5c01_write(priv, RP5C01_MODE_TIMER_EN | RP5C01_MODE_MODE01,\r\nRP5C01_MODE);\r\n}\r\nspin_unlock_irq(&priv->lock);\r\nreturn count;\r\n}\r\nstatic int __init rp5c01_rtc_probe(struct platform_device *dev)\r\n{\r\nstruct resource *res;\r\nstruct rp5c01_priv *priv;\r\nstruct rtc_device *rtc;\r\nint error;\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\npriv = devm_kzalloc(&dev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->regs = devm_ioremap(&dev->dev, res->start, resource_size(res));\r\nif (!priv->regs)\r\nreturn -ENOMEM;\r\nsysfs_bin_attr_init(&priv->nvram_attr);\r\npriv->nvram_attr.attr.name = "nvram";\r\npriv->nvram_attr.attr.mode = S_IRUGO | S_IWUSR;\r\npriv->nvram_attr.read = rp5c01_nvram_read;\r\npriv->nvram_attr.write = rp5c01_nvram_write;\r\npriv->nvram_attr.size = RP5C01_MODE;\r\nspin_lock_init(&priv->lock);\r\nplatform_set_drvdata(dev, priv);\r\nrtc = devm_rtc_device_register(&dev->dev, "rtc-rp5c01", &rp5c01_rtc_ops,\r\nTHIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\npriv->rtc = rtc;\r\nerror = sysfs_create_bin_file(&dev->dev.kobj, &priv->nvram_attr);\r\nif (error)\r\nreturn error;\r\nreturn 0;\r\n}\r\nstatic int __exit rp5c01_rtc_remove(struct platform_device *dev)\r\n{\r\nstruct rp5c01_priv *priv = platform_get_drvdata(dev);\r\nsysfs_remove_bin_file(&dev->dev.kobj, &priv->nvram_attr);\r\nreturn 0;\r\n}

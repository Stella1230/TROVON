size_t memweight(const void *ptr, size_t bytes)\r\n{\r\nsize_t ret = 0;\r\nsize_t longs;\r\nconst unsigned char *bitmap = ptr;\r\nfor (; bytes > 0 && ((unsigned long)bitmap) % sizeof(long);\r\nbytes--, bitmap++)\r\nret += hweight8(*bitmap);\r\nlongs = bytes / sizeof(long);\r\nif (longs) {\r\nBUG_ON(longs >= INT_MAX / BITS_PER_LONG);\r\nret += bitmap_weight((unsigned long *)bitmap,\r\nlongs * BITS_PER_LONG);\r\nbytes -= longs * sizeof(long);\r\nbitmap += longs * sizeof(long);\r\n}\r\nfor (; bytes > 0; bytes--, bitmap++)\r\nret += hweight8(*bitmap);\r\nreturn ret;\r\n}

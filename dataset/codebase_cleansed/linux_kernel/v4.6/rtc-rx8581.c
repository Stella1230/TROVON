static int rx8581_read_block_data(const struct i2c_client *client, u8 command,\r\nu8 length, u8 *values)\r\n{\r\ns32 i, data;\r\nfor (i = 0; i < length; i++) {\r\ndata = i2c_smbus_read_byte_data(client, command + i);\r\nif (data < 0)\r\nreturn data;\r\nvalues[i] = data;\r\n}\r\nreturn i;\r\n}\r\nstatic int rx8581_write_block_data(const struct i2c_client *client, u8 command,\r\nu8 length, const u8 *values)\r\n{\r\ns32 i, ret;\r\nfor (i = 0; i < length; i++) {\r\nret = i2c_smbus_write_byte_data(client, command + i,\r\nvalues[i]);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn length;\r\n}\r\nstatic int rx8581_get_datetime(struct i2c_client *client, struct rtc_time *tm)\r\n{\r\nunsigned char date[7];\r\nint data, err;\r\nstruct rx8581 *rx8581 = i2c_get_clientdata(client);\r\ndata = i2c_smbus_read_byte_data(client, RX8581_REG_FLAG);\r\nif (data < 0) {\r\ndev_err(&client->dev, "Unable to read device flags\n");\r\nreturn -EIO;\r\n}\r\ndo {\r\nif (data & RX8581_FLAG_UF) {\r\nerr = i2c_smbus_write_byte_data(client,\r\nRX8581_REG_FLAG, (data & ~RX8581_FLAG_UF));\r\nif (err != 0) {\r\ndev_err(&client->dev, "Unable to write device flags\n");\r\nreturn -EIO;\r\n}\r\n}\r\nerr = rx8581->read_block_data(client, RX8581_REG_SC,\r\n7, date);\r\nif (err < 0) {\r\ndev_err(&client->dev, "Unable to read date\n");\r\nreturn -EIO;\r\n}\r\ndata = i2c_smbus_read_byte_data(client, RX8581_REG_FLAG);\r\nif (data < 0) {\r\ndev_err(&client->dev, "Unable to read device flags\n");\r\nreturn -EIO;\r\n}\r\n} while (data & RX8581_FLAG_UF);\r\nif (data & RX8581_FLAG_VLF)\r\ndev_info(&client->dev,\r\n"low voltage detected, date/time is not reliable.\n");\r\ndev_dbg(&client->dev,\r\n"%s: raw data is sec=%02x, min=%02x, hr=%02x, "\r\n"wday=%02x, mday=%02x, mon=%02x, year=%02x\n",\r\n__func__,\r\ndate[0], date[1], date[2], date[3], date[4], date[5], date[6]);\r\ntm->tm_sec = bcd2bin(date[RX8581_REG_SC] & 0x7F);\r\ntm->tm_min = bcd2bin(date[RX8581_REG_MN] & 0x7F);\r\ntm->tm_hour = bcd2bin(date[RX8581_REG_HR] & 0x3F);\r\ntm->tm_wday = ilog2(date[RX8581_REG_DW] & 0x7F);\r\ntm->tm_mday = bcd2bin(date[RX8581_REG_DM] & 0x3F);\r\ntm->tm_mon = bcd2bin(date[RX8581_REG_MO] & 0x1F) - 1;\r\ntm->tm_year = bcd2bin(date[RX8581_REG_YR]);\r\nif (tm->tm_year < 70)\r\ntm->tm_year += 100;\r\ndev_dbg(&client->dev, "%s: tm is secs=%d, mins=%d, hours=%d, "\r\n"mday=%d, mon=%d, year=%d, wday=%d\n",\r\n__func__,\r\ntm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year, tm->tm_wday);\r\nerr = rtc_valid_tm(tm);\r\nif (err < 0)\r\ndev_err(&client->dev, "retrieved date/time is not valid.\n");\r\nreturn err;\r\n}\r\nstatic int rx8581_set_datetime(struct i2c_client *client, struct rtc_time *tm)\r\n{\r\nint data, err;\r\nunsigned char buf[7];\r\nstruct rx8581 *rx8581 = i2c_get_clientdata(client);\r\ndev_dbg(&client->dev, "%s: secs=%d, mins=%d, hours=%d, "\r\n"mday=%d, mon=%d, year=%d, wday=%d\n",\r\n__func__,\r\ntm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year, tm->tm_wday);\r\nbuf[RX8581_REG_SC] = bin2bcd(tm->tm_sec);\r\nbuf[RX8581_REG_MN] = bin2bcd(tm->tm_min);\r\nbuf[RX8581_REG_HR] = bin2bcd(tm->tm_hour);\r\nbuf[RX8581_REG_DM] = bin2bcd(tm->tm_mday);\r\nbuf[RX8581_REG_MO] = bin2bcd(tm->tm_mon + 1);\r\nbuf[RX8581_REG_YR] = bin2bcd(tm->tm_year % 100);\r\nbuf[RX8581_REG_DW] = (0x1 << tm->tm_wday);\r\ndata = i2c_smbus_read_byte_data(client, RX8581_REG_CTRL);\r\nif (data < 0) {\r\ndev_err(&client->dev, "Unable to read control register\n");\r\nreturn -EIO;\r\n}\r\nerr = i2c_smbus_write_byte_data(client, RX8581_REG_CTRL,\r\n(data | RX8581_CTRL_STOP));\r\nif (err < 0) {\r\ndev_err(&client->dev, "Unable to write control register\n");\r\nreturn -EIO;\r\n}\r\nerr = rx8581->write_block_data(client, RX8581_REG_SC, 7, buf);\r\nif (err < 0) {\r\ndev_err(&client->dev, "Unable to write to date registers\n");\r\nreturn -EIO;\r\n}\r\ndata = i2c_smbus_read_byte_data(client, RX8581_REG_FLAG);\r\nif (data < 0) {\r\ndev_err(&client->dev, "Unable to read flag register\n");\r\nreturn -EIO;\r\n}\r\nerr = i2c_smbus_write_byte_data(client, RX8581_REG_FLAG,\r\n(data & ~(RX8581_FLAG_VLF)));\r\nif (err != 0) {\r\ndev_err(&client->dev, "Unable to write flag register\n");\r\nreturn -EIO;\r\n}\r\ndata = i2c_smbus_read_byte_data(client, RX8581_REG_CTRL);\r\nif (data < 0) {\r\ndev_err(&client->dev, "Unable to read control register\n");\r\nreturn -EIO;\r\n}\r\nerr = i2c_smbus_write_byte_data(client, RX8581_REG_CTRL,\r\n(data & ~(RX8581_CTRL_STOP)));\r\nif (err != 0) {\r\ndev_err(&client->dev, "Unable to write control register\n");\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rx8581_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nreturn rx8581_get_datetime(to_i2c_client(dev), tm);\r\n}\r\nstatic int rx8581_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nreturn rx8581_set_datetime(to_i2c_client(dev), tm);\r\n}\r\nstatic int rx8581_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct rx8581 *rx8581;\r\ndev_dbg(&client->dev, "%s\n", __func__);\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_BYTE_DATA)\r\n&& !i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_I2C_BLOCK))\r\nreturn -EIO;\r\nrx8581 = devm_kzalloc(&client->dev, sizeof(struct rx8581), GFP_KERNEL);\r\nif (!rx8581)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, rx8581);\r\nrx8581->client = client;\r\nif (i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_I2C_BLOCK)) {\r\nrx8581->read_block_data = i2c_smbus_read_i2c_block_data;\r\nrx8581->write_block_data = i2c_smbus_write_i2c_block_data;\r\n} else {\r\nrx8581->read_block_data = rx8581_read_block_data;\r\nrx8581->write_block_data = rx8581_write_block_data;\r\n}\r\ndev_info(&client->dev, "chip found, driver version " DRV_VERSION "\n");\r\nrx8581->rtc = devm_rtc_device_register(&client->dev,\r\nrx8581_driver.driver.name, &rx8581_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rx8581->rtc)) {\r\ndev_err(&client->dev,\r\n"unable to register the class device\n");\r\nreturn PTR_ERR(rx8581->rtc);\r\n}\r\nreturn 0;\r\n}

static int max77693_get_charger_state(struct regmap *regmap, int *val)\r\n{\r\nint ret;\r\nunsigned int data;\r\nret = regmap_read(regmap, MAX77693_CHG_REG_CHG_DETAILS_01, &data);\r\nif (ret < 0)\r\nreturn ret;\r\ndata &= CHG_DETAILS_01_CHG_MASK;\r\ndata >>= CHG_DETAILS_01_CHG_SHIFT;\r\nswitch (data) {\r\ncase MAX77693_CHARGING_PREQUALIFICATION:\r\ncase MAX77693_CHARGING_FAST_CONST_CURRENT:\r\ncase MAX77693_CHARGING_FAST_CONST_VOLTAGE:\r\ncase MAX77693_CHARGING_TOP_OFF:\r\ncase MAX77693_CHARGING_HIGH_TEMP:\r\n*val = POWER_SUPPLY_STATUS_CHARGING;\r\nbreak;\r\ncase MAX77693_CHARGING_DONE:\r\n*val = POWER_SUPPLY_STATUS_FULL;\r\nbreak;\r\ncase MAX77693_CHARGING_TIMER_EXPIRED:\r\ncase MAX77693_CHARGING_THERMISTOR_SUSPEND:\r\n*val = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\nbreak;\r\ncase MAX77693_CHARGING_OFF:\r\ncase MAX77693_CHARGING_OVER_TEMP:\r\ncase MAX77693_CHARGING_WATCHDOG_EXPIRED:\r\n*val = POWER_SUPPLY_STATUS_DISCHARGING;\r\nbreak;\r\ncase MAX77693_CHARGING_RESERVED:\r\ndefault:\r\n*val = POWER_SUPPLY_STATUS_UNKNOWN;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77693_get_charge_type(struct regmap *regmap, int *val)\r\n{\r\nint ret;\r\nunsigned int data;\r\nret = regmap_read(regmap, MAX77693_CHG_REG_CHG_DETAILS_01, &data);\r\nif (ret < 0)\r\nreturn ret;\r\ndata &= CHG_DETAILS_01_CHG_MASK;\r\ndata >>= CHG_DETAILS_01_CHG_SHIFT;\r\nswitch (data) {\r\ncase MAX77693_CHARGING_PREQUALIFICATION:\r\ncase MAX77693_CHARGING_TOP_OFF:\r\n*val = POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\r\nbreak;\r\ncase MAX77693_CHARGING_FAST_CONST_CURRENT:\r\ncase MAX77693_CHARGING_FAST_CONST_VOLTAGE:\r\ncase MAX77693_CHARGING_HIGH_TEMP:\r\n*val = POWER_SUPPLY_CHARGE_TYPE_FAST;\r\nbreak;\r\ncase MAX77693_CHARGING_DONE:\r\ncase MAX77693_CHARGING_TIMER_EXPIRED:\r\ncase MAX77693_CHARGING_THERMISTOR_SUSPEND:\r\ncase MAX77693_CHARGING_OFF:\r\ncase MAX77693_CHARGING_OVER_TEMP:\r\ncase MAX77693_CHARGING_WATCHDOG_EXPIRED:\r\n*val = POWER_SUPPLY_CHARGE_TYPE_NONE;\r\nbreak;\r\ncase MAX77693_CHARGING_RESERVED:\r\ndefault:\r\n*val = POWER_SUPPLY_CHARGE_TYPE_UNKNOWN;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77693_get_battery_health(struct regmap *regmap, int *val)\r\n{\r\nint ret;\r\nunsigned int data;\r\nret = regmap_read(regmap, MAX77693_CHG_REG_CHG_DETAILS_01, &data);\r\nif (ret < 0)\r\nreturn ret;\r\ndata &= CHG_DETAILS_01_BAT_MASK;\r\ndata >>= CHG_DETAILS_01_BAT_SHIFT;\r\nswitch (data) {\r\ncase MAX77693_BATTERY_NOBAT:\r\n*val = POWER_SUPPLY_HEALTH_DEAD;\r\nbreak;\r\ncase MAX77693_BATTERY_PREQUALIFICATION:\r\ncase MAX77693_BATTERY_GOOD:\r\ncase MAX77693_BATTERY_LOWVOLTAGE:\r\n*val = POWER_SUPPLY_HEALTH_GOOD;\r\nbreak;\r\ncase MAX77693_BATTERY_TIMER_EXPIRED:\r\n*val = POWER_SUPPLY_HEALTH_SAFETY_TIMER_EXPIRE;\r\nbreak;\r\ncase MAX77693_BATTERY_OVERVOLTAGE:\r\n*val = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\r\nbreak;\r\ncase MAX77693_BATTERY_OVERCURRENT:\r\n*val = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\r\nbreak;\r\ncase MAX77693_BATTERY_RESERVED:\r\ndefault:\r\n*val = POWER_SUPPLY_HEALTH_UNKNOWN;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77693_get_present(struct regmap *regmap, int *val)\r\n{\r\nunsigned int data;\r\nint ret;\r\nret = regmap_read(regmap, MAX77693_CHG_REG_CHG_INT_OK, &data);\r\nif (ret < 0)\r\nreturn ret;\r\n*val = (data & CHG_INT_OK_DETBAT_MASK) ? 0 : 1;\r\nreturn 0;\r\n}\r\nstatic int max77693_get_online(struct regmap *regmap, int *val)\r\n{\r\nunsigned int data;\r\nint ret;\r\nret = regmap_read(regmap, MAX77693_CHG_REG_CHG_INT_OK, &data);\r\nif (ret < 0)\r\nreturn ret;\r\n*val = (data & CHG_INT_OK_CHGIN_MASK) ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic int max77693_charger_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct max77693_charger *chg = power_supply_get_drvdata(psy);\r\nstruct regmap *regmap = chg->max77693->regmap;\r\nint ret = 0;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nret = max77693_get_charger_state(regmap, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_TYPE:\r\nret = max77693_get_charge_type(regmap, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nret = max77693_get_battery_health(regmap, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nret = max77693_get_present(regmap, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nret = max77693_get_online(regmap, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MODEL_NAME:\r\nval->strval = max77693_charger_model;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MANUFACTURER:\r\nval->strval = max77693_charger_manufacturer;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic ssize_t device_attr_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count,\r\nint (*fn)(struct max77693_charger *, unsigned long))\r\n{\r\nstruct max77693_charger *chg = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint ret;\r\nret = kstrtoul(buf, 10, &val);\r\nif (ret)\r\nreturn ret;\r\nret = fn(chg, val);\r\nif (ret)\r\nreturn ret;\r\nreturn count;\r\n}\r\nstatic ssize_t fast_charge_timer_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct max77693_charger *chg = dev_get_drvdata(dev);\r\nunsigned int data, val;\r\nint ret;\r\nret = regmap_read(chg->max77693->regmap, MAX77693_CHG_REG_CHG_CNFG_01,\r\n&data);\r\nif (ret < 0)\r\nreturn ret;\r\ndata &= CHG_CNFG_01_FCHGTIME_MASK;\r\ndata >>= CHG_CNFG_01_FCHGTIME_SHIFT;\r\nswitch (data) {\r\ncase 0x1 ... 0x7:\r\nval = 4 + (data - 1) * 2;\r\nbreak;\r\ncase 0x0:\r\ndefault:\r\nval = 0;\r\nbreak;\r\n}\r\nreturn scnprintf(buf, PAGE_SIZE, "%u\n", val);\r\n}\r\nstatic int max77693_set_fast_charge_timer(struct max77693_charger *chg,\r\nunsigned long hours)\r\n{\r\nunsigned int data;\r\nswitch (hours) {\r\ncase 4 ... 16:\r\ndata = (hours - 4) / 2 + 1;\r\nbreak;\r\ncase 0:\r\ndata = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndata <<= CHG_CNFG_01_FCHGTIME_SHIFT;\r\nreturn regmap_update_bits(chg->max77693->regmap,\r\nMAX77693_CHG_REG_CHG_CNFG_01,\r\nCHG_CNFG_01_FCHGTIME_MASK, data);\r\n}\r\nstatic ssize_t fast_charge_timer_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nreturn device_attr_store(dev, attr, buf, count,\r\nmax77693_set_fast_charge_timer);\r\n}\r\nstatic ssize_t top_off_threshold_current_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct max77693_charger *chg = dev_get_drvdata(dev);\r\nunsigned int data, val;\r\nint ret;\r\nret = regmap_read(chg->max77693->regmap, MAX77693_CHG_REG_CHG_CNFG_03,\r\n&data);\r\nif (ret < 0)\r\nreturn ret;\r\ndata &= CHG_CNFG_03_TOITH_MASK;\r\ndata >>= CHG_CNFG_03_TOITH_SHIFT;\r\nif (data <= 0x04)\r\nval = 100000 + data * 25000;\r\nelse\r\nval = data * 50000;\r\nreturn scnprintf(buf, PAGE_SIZE, "%u\n", val);\r\n}\r\nstatic int max77693_set_top_off_threshold_current(struct max77693_charger *chg,\r\nunsigned long uamp)\r\n{\r\nunsigned int data;\r\nif (uamp < 100000 || uamp > 350000)\r\nreturn -EINVAL;\r\nif (uamp <= 200000)\r\ndata = (uamp - 100000) / 25000;\r\nelse\r\ndata = uamp / 50000;\r\ndata <<= CHG_CNFG_03_TOITH_SHIFT;\r\nreturn regmap_update_bits(chg->max77693->regmap,\r\nMAX77693_CHG_REG_CHG_CNFG_03,\r\nCHG_CNFG_03_TOITH_MASK, data);\r\n}\r\nstatic ssize_t top_off_threshold_current_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nreturn device_attr_store(dev, attr, buf, count,\r\nmax77693_set_top_off_threshold_current);\r\n}\r\nstatic ssize_t top_off_timer_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct max77693_charger *chg = dev_get_drvdata(dev);\r\nunsigned int data, val;\r\nint ret;\r\nret = regmap_read(chg->max77693->regmap, MAX77693_CHG_REG_CHG_CNFG_03,\r\n&data);\r\nif (ret < 0)\r\nreturn ret;\r\ndata &= CHG_CNFG_03_TOTIME_MASK;\r\ndata >>= CHG_CNFG_03_TOTIME_SHIFT;\r\nval = data * 10;\r\nreturn scnprintf(buf, PAGE_SIZE, "%u\n", val);\r\n}\r\nstatic int max77693_set_top_off_timer(struct max77693_charger *chg,\r\nunsigned long minutes)\r\n{\r\nunsigned int data;\r\nif (minutes > 70)\r\nreturn -EINVAL;\r\ndata = minutes / 10;\r\ndata <<= CHG_CNFG_03_TOTIME_SHIFT;\r\nreturn regmap_update_bits(chg->max77693->regmap,\r\nMAX77693_CHG_REG_CHG_CNFG_03,\r\nCHG_CNFG_03_TOTIME_MASK, data);\r\n}\r\nstatic ssize_t top_off_timer_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nreturn device_attr_store(dev, attr, buf, count,\r\nmax77693_set_top_off_timer);\r\n}\r\nstatic int max77693_set_constant_volt(struct max77693_charger *chg,\r\nunsigned int uvolt)\r\n{\r\nunsigned int data;\r\nif (uvolt >= 3650000 && uvolt < 4340000)\r\ndata = (uvolt - 3650000) / 25000;\r\nelse if (uvolt >= 4340000 && uvolt < 4350000)\r\ndata = 0x1c;\r\nelse if (uvolt >= 4350000 && uvolt <= 4400000)\r\ndata = 0x1d + (uvolt - 4350000) / 25000;\r\nelse {\r\ndev_err(chg->dev, "Wrong value for charging constant voltage\n");\r\nreturn -EINVAL;\r\n}\r\ndata <<= CHG_CNFG_04_CHGCVPRM_SHIFT;\r\ndev_dbg(chg->dev, "Charging constant voltage: %u (0x%x)\n", uvolt,\r\ndata);\r\nreturn regmap_update_bits(chg->max77693->regmap,\r\nMAX77693_CHG_REG_CHG_CNFG_04,\r\nCHG_CNFG_04_CHGCVPRM_MASK, data);\r\n}\r\nstatic int max77693_set_min_system_volt(struct max77693_charger *chg,\r\nunsigned int uvolt)\r\n{\r\nunsigned int data;\r\nif (uvolt < 3000000 || uvolt > 3700000) {\r\ndev_err(chg->dev, "Wrong value for minimum system regulation voltage\n");\r\nreturn -EINVAL;\r\n}\r\ndata = (uvolt - 3000000) / 100000;\r\ndata <<= CHG_CNFG_04_MINVSYS_SHIFT;\r\ndev_dbg(chg->dev, "Minimum system regulation voltage: %u (0x%x)\n",\r\nuvolt, data);\r\nreturn regmap_update_bits(chg->max77693->regmap,\r\nMAX77693_CHG_REG_CHG_CNFG_04,\r\nCHG_CNFG_04_MINVSYS_MASK, data);\r\n}\r\nstatic int max77693_set_thermal_regulation_temp(struct max77693_charger *chg,\r\nunsigned int cels)\r\n{\r\nunsigned int data;\r\nswitch (cels) {\r\ncase 70:\r\ncase 85:\r\ncase 100:\r\ncase 115:\r\ndata = (cels - 70) / 15;\r\nbreak;\r\ndefault:\r\ndev_err(chg->dev, "Wrong value for thermal regulation loop temperature\n");\r\nreturn -EINVAL;\r\n}\r\ndata <<= CHG_CNFG_07_REGTEMP_SHIFT;\r\ndev_dbg(chg->dev, "Thermal regulation loop temperature: %u (0x%x)\n",\r\ncels, data);\r\nreturn regmap_update_bits(chg->max77693->regmap,\r\nMAX77693_CHG_REG_CHG_CNFG_07,\r\nCHG_CNFG_07_REGTEMP_MASK, data);\r\n}\r\nstatic int max77693_set_batttery_overcurrent(struct max77693_charger *chg,\r\nunsigned int uamp)\r\n{\r\nunsigned int data;\r\nif (uamp && (uamp < 2000000 || uamp > 3500000)) {\r\ndev_err(chg->dev, "Wrong value for battery overcurrent\n");\r\nreturn -EINVAL;\r\n}\r\nif (uamp)\r\ndata = ((uamp - 2000000) / 250000) + 1;\r\nelse\r\ndata = 0;\r\ndata <<= CHG_CNFG_12_B2SOVRC_SHIFT;\r\ndev_dbg(chg->dev, "Battery overcurrent: %u (0x%x)\n", uamp, data);\r\nreturn regmap_update_bits(chg->max77693->regmap,\r\nMAX77693_CHG_REG_CHG_CNFG_12,\r\nCHG_CNFG_12_B2SOVRC_MASK, data);\r\n}\r\nstatic int max77693_set_charge_input_threshold_volt(struct max77693_charger *chg,\r\nunsigned int uvolt)\r\n{\r\nunsigned int data;\r\nswitch (uvolt) {\r\ncase 4300000:\r\ndata = 0x0;\r\nbreak;\r\ncase 4700000:\r\ncase 4800000:\r\ncase 4900000:\r\ndata = (uvolt - 4700000) / 100000;\r\ndefault:\r\ndev_err(chg->dev, "Wrong value for charge input voltage regulation threshold\n");\r\nreturn -EINVAL;\r\n}\r\ndata <<= CHG_CNFG_12_VCHGINREG_SHIFT;\r\ndev_dbg(chg->dev, "Charge input voltage regulation threshold: %u (0x%x)\n",\r\nuvolt, data);\r\nreturn regmap_update_bits(chg->max77693->regmap,\r\nMAX77693_CHG_REG_CHG_CNFG_12,\r\nCHG_CNFG_12_VCHGINREG_MASK, data);\r\n}\r\nstatic int max77693_reg_init(struct max77693_charger *chg)\r\n{\r\nint ret;\r\nunsigned int data;\r\ndata = (0x3 << CHG_CNFG_06_CHGPROT_SHIFT);\r\nret = regmap_update_bits(chg->max77693->regmap,\r\nMAX77693_CHG_REG_CHG_CNFG_06,\r\nCHG_CNFG_06_CHGPROT_MASK, data);\r\nif (ret) {\r\ndev_err(chg->dev, "Error unlocking registers: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = max77693_set_fast_charge_timer(chg, DEFAULT_FAST_CHARGE_TIMER);\r\nif (ret)\r\nreturn ret;\r\nret = max77693_set_top_off_threshold_current(chg,\r\nDEFAULT_TOP_OFF_THRESHOLD_CURRENT);\r\nif (ret)\r\nreturn ret;\r\nret = max77693_set_top_off_timer(chg, DEFAULT_TOP_OFF_TIMER);\r\nif (ret)\r\nreturn ret;\r\nret = max77693_set_constant_volt(chg, chg->constant_volt);\r\nif (ret)\r\nreturn ret;\r\nret = max77693_set_min_system_volt(chg, chg->min_system_volt);\r\nif (ret)\r\nreturn ret;\r\nret = max77693_set_thermal_regulation_temp(chg,\r\nchg->thermal_regulation_temp);\r\nif (ret)\r\nreturn ret;\r\nret = max77693_set_batttery_overcurrent(chg, chg->batttery_overcurrent);\r\nif (ret)\r\nreturn ret;\r\nreturn max77693_set_charge_input_threshold_volt(chg,\r\nchg->charge_input_threshold_volt);\r\n}\r\nstatic int max77693_dt_init(struct device *dev, struct max77693_charger *chg)\r\n{\r\nstruct device_node *np = dev->of_node;\r\nif (!np) {\r\ndev_err(dev, "no charger OF node\n");\r\nreturn -EINVAL;\r\n}\r\nif (of_property_read_u32(np, "maxim,constant-microvolt",\r\n&chg->constant_volt))\r\nchg->constant_volt = DEFAULT_CONSTANT_VOLT;\r\nif (of_property_read_u32(np, "maxim,min-system-microvolt",\r\n&chg->min_system_volt))\r\nchg->min_system_volt = DEFAULT_MIN_SYSTEM_VOLT;\r\nif (of_property_read_u32(np, "maxim,thermal-regulation-celsius",\r\n&chg->thermal_regulation_temp))\r\nchg->thermal_regulation_temp = DEFAULT_THERMAL_REGULATION_TEMP;\r\nif (of_property_read_u32(np, "maxim,battery-overcurrent-microamp",\r\n&chg->batttery_overcurrent))\r\nchg->batttery_overcurrent = DEFAULT_BATTERY_OVERCURRENT;\r\nif (of_property_read_u32(np, "maxim,charge-input-threshold-microvolt",\r\n&chg->charge_input_threshold_volt))\r\nchg->charge_input_threshold_volt =\r\nDEFAULT_CHARGER_INPUT_THRESHOLD_VOLT;\r\nreturn 0;\r\n}\r\nstatic int max77693_dt_init(struct device *dev, struct max77693_charger *chg)\r\n{\r\nreturn 0;\r\n}\r\nstatic int max77693_charger_probe(struct platform_device *pdev)\r\n{\r\nstruct max77693_charger *chg;\r\nstruct power_supply_config psy_cfg = {};\r\nstruct max77693_dev *max77693 = dev_get_drvdata(pdev->dev.parent);\r\nint ret;\r\nchg = devm_kzalloc(&pdev->dev, sizeof(*chg), GFP_KERNEL);\r\nif (!chg)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, chg);\r\nchg->dev = &pdev->dev;\r\nchg->max77693 = max77693;\r\nret = max77693_dt_init(&pdev->dev, chg);\r\nif (ret)\r\nreturn ret;\r\nret = max77693_reg_init(chg);\r\nif (ret)\r\nreturn ret;\r\npsy_cfg.drv_data = chg;\r\nret = device_create_file(&pdev->dev, &dev_attr_fast_charge_timer);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed: create fast charge timer sysfs entry\n");\r\ngoto err;\r\n}\r\nret = device_create_file(&pdev->dev,\r\n&dev_attr_top_off_threshold_current);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed: create top off current sysfs entry\n");\r\ngoto err;\r\n}\r\nret = device_create_file(&pdev->dev, &dev_attr_top_off_timer);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed: create top off timer sysfs entry\n");\r\ngoto err;\r\n}\r\nchg->charger = power_supply_register(&pdev->dev,\r\n&max77693_charger_desc,\r\n&psy_cfg);\r\nif (IS_ERR(chg->charger)) {\r\ndev_err(&pdev->dev, "failed: power supply register\n");\r\nret = PTR_ERR(chg->charger);\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\ndevice_remove_file(&pdev->dev, &dev_attr_top_off_timer);\r\ndevice_remove_file(&pdev->dev, &dev_attr_top_off_threshold_current);\r\ndevice_remove_file(&pdev->dev, &dev_attr_fast_charge_timer);\r\nreturn ret;\r\n}\r\nstatic int max77693_charger_remove(struct platform_device *pdev)\r\n{\r\nstruct max77693_charger *chg = platform_get_drvdata(pdev);\r\ndevice_remove_file(&pdev->dev, &dev_attr_top_off_timer);\r\ndevice_remove_file(&pdev->dev, &dev_attr_top_off_threshold_current);\r\ndevice_remove_file(&pdev->dev, &dev_attr_fast_charge_timer);\r\npower_supply_unregister(chg->charger);\r\nreturn 0;\r\n}

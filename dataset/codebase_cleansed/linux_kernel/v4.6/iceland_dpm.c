static int iceland_dpm_early_init(void *handle)\r\n{\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\niceland_dpm_set_funcs(adev);\r\nreturn 0;\r\n}\r\nstatic int iceland_dpm_init_microcode(struct amdgpu_device *adev)\r\n{\r\nchar fw_name[30] = "amdgpu/topaz_smc.bin";\r\nint err;\r\nerr = request_firmware(&adev->pm.fw, fw_name, adev->dev);\r\nif (err)\r\ngoto out;\r\nerr = amdgpu_ucode_validate(adev->pm.fw);\r\nout:\r\nif (err) {\r\nDRM_ERROR("Failed to load firmware \"%s\"", fw_name);\r\nrelease_firmware(adev->pm.fw);\r\nadev->pm.fw = NULL;\r\n}\r\nreturn err;\r\n}\r\nstatic int iceland_dpm_sw_init(void *handle)\r\n{\r\nint ret;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nret = iceland_dpm_init_microcode(adev);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int iceland_dpm_sw_fini(void *handle)\r\n{\r\nreturn 0;\r\n}\r\nstatic int iceland_dpm_hw_init(void *handle)\r\n{\r\nint ret;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nmutex_lock(&adev->pm.mutex);\r\nret = iceland_smu_init(adev);\r\nif (ret) {\r\nDRM_ERROR("SMU initialization failed\n");\r\ngoto fail;\r\n}\r\nret = iceland_smu_start(adev);\r\nif (ret) {\r\nDRM_ERROR("SMU start failed\n");\r\ngoto fail;\r\n}\r\nmutex_unlock(&adev->pm.mutex);\r\nreturn 0;\r\nfail:\r\nadev->firmware.smu_load = false;\r\nmutex_unlock(&adev->pm.mutex);\r\nreturn -EINVAL;\r\n}\r\nstatic int iceland_dpm_hw_fini(void *handle)\r\n{\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nmutex_lock(&adev->pm.mutex);\r\niceland_smu_fini(adev);\r\nmutex_unlock(&adev->pm.mutex);\r\nreturn 0;\r\n}\r\nstatic int iceland_dpm_suspend(void *handle)\r\n{\r\nreturn 0;\r\n}\r\nstatic int iceland_dpm_resume(void *handle)\r\n{\r\nint ret;\r\nstruct amdgpu_device *adev = (struct amdgpu_device *)handle;\r\nmutex_lock(&adev->pm.mutex);\r\nret = iceland_smu_start(adev);\r\nif (ret) {\r\nDRM_ERROR("SMU start failed\n");\r\ngoto fail;\r\n}\r\nfail:\r\nmutex_unlock(&adev->pm.mutex);\r\nreturn ret;\r\n}\r\nstatic int iceland_dpm_set_clockgating_state(void *handle,\r\nenum amd_clockgating_state state)\r\n{\r\nreturn 0;\r\n}\r\nstatic int iceland_dpm_set_powergating_state(void *handle,\r\nenum amd_powergating_state state)\r\n{\r\nreturn 0;\r\n}\r\nstatic void iceland_dpm_set_funcs(struct amdgpu_device *adev)\r\n{\r\nif (NULL == adev->pm.funcs)\r\nadev->pm.funcs = &iceland_dpm_funcs;\r\n}

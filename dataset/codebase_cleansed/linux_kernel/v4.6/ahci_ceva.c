static void ahci_ceva_setup(struct ahci_host_priv *hpriv)\r\n{\r\nvoid __iomem *mmio = hpriv->mmio;\r\nstruct ceva_ahci_priv *cevapriv = hpriv->plat_data;\r\nu32 tmp;\r\nint i;\r\ntmp = PAXIC_ADBW_BW64 | PAXIC_MAWIDD | PAXIC_MARIDD | PAXIC_OTL;\r\nwritel(tmp, mmio + AHCI_VEND_PAXIC);\r\ntmp = readl(mmio + HOST_CTL);\r\ntmp |= HOST_AHCI_EN;\r\nwritel(tmp, mmio + HOST_CTL);\r\nfor (i = 0; i < NR_PORTS; i++) {\r\ntmp = PCFG_TPSS_VAL | PCFG_TPRS_VAL | (PCFG_PAD_VAL + i);\r\nwritel(tmp, mmio + AHCI_VEND_PCFG);\r\ntmp = PPCFG_TTA | PPCFG_PSS_EN | PPCFG_ESDF_EN;\r\nwritel(tmp, mmio + AHCI_VEND_PPCFG);\r\ntmp = PP2C_CIBGMN | PP2C_CIBGMX | PP2C_CIBGN | PP2C_CINMP;\r\nwritel(tmp, mmio + AHCI_VEND_PP2C);\r\ntmp = PP3C_CWBGMN | PP3C_CWBGMX | PP3C_CWBGN | PP3C_CWNMP;\r\nwritel(tmp, mmio + AHCI_VEND_PP3C);\r\ntmp = PP4C_BMX | PP4C_BNM | PP4C_SFD | PP4C_PTST;\r\nwritel(tmp, mmio + AHCI_VEND_PP4C);\r\ntmp = PP5C_RIT | PP5C_RCT;\r\nwritel(tmp, mmio + AHCI_VEND_PP5C);\r\ntmp = PTC_RX_WM_VAL | PTC_RSVD;\r\nwritel(tmp, mmio + AHCI_VEND_PTC);\r\ntmp = PORT_SCTL_SPD_GEN2 | PORT_SCTL_IPM;\r\nif (cevapriv->flags & CEVA_FLAG_BROKEN_GEN2)\r\ntmp = PORT_SCTL_SPD_GEN1 | PORT_SCTL_IPM;\r\nwritel(tmp, mmio + PORT_SCR_CTL + PORT_BASE + PORT_OFFSET * i);\r\n}\r\n}\r\nstatic int ceva_ahci_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct device *dev = &pdev->dev;\r\nstruct ahci_host_priv *hpriv;\r\nstruct ceva_ahci_priv *cevapriv;\r\nint rc;\r\ncevapriv = devm_kzalloc(dev, sizeof(*cevapriv), GFP_KERNEL);\r\nif (!cevapriv)\r\nreturn -ENOMEM;\r\ncevapriv->ahci_pdev = pdev;\r\nhpriv = ahci_platform_get_resources(pdev);\r\nif (IS_ERR(hpriv))\r\nreturn PTR_ERR(hpriv);\r\nrc = ahci_platform_enable_resources(hpriv);\r\nif (rc)\r\nreturn rc;\r\nif (of_property_read_bool(np, "ceva,broken-gen2"))\r\ncevapriv->flags = CEVA_FLAG_BROKEN_GEN2;\r\nhpriv->plat_data = cevapriv;\r\nahci_ceva_setup(hpriv);\r\nrc = ahci_platform_init_host(pdev, hpriv, &ahci_ceva_port_info,\r\n&ahci_platform_sht);\r\nif (rc)\r\ngoto disable_resources;\r\nreturn 0;\r\ndisable_resources:\r\nahci_platform_disable_resources(hpriv);\r\nreturn rc;\r\n}\r\nstatic int __maybe_unused ceva_ahci_suspend(struct device *dev)\r\n{\r\nreturn ahci_platform_suspend_host(dev);\r\n}\r\nstatic int __maybe_unused ceva_ahci_resume(struct device *dev)\r\n{\r\nreturn ahci_platform_resume_host(dev);\r\n}

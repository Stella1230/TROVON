static void __init amikbd_init_console_keymaps(void)\r\n{\r\nunsigned short temp_map[NR_KEYS];\r\nint i, j;\r\nfor (i = 0; i < MAX_NR_KEYMAPS; i++) {\r\nif (!key_maps[i])\r\ncontinue;\r\nmemset(temp_map, 0, sizeof(temp_map));\r\nfor (j = 0; j < 0x78; j++) {\r\nif (!amikbd_keycode[j])\r\ncontinue;\r\ntemp_map[j] = key_maps[i][amikbd_keycode[j]];\r\n}\r\nfor (j = 0; j < NR_KEYS; j++) {\r\nif (!temp_map[j])\r\ntemp_map[j] = 0xf200;\r\n}\r\nmemcpy(key_maps[i], temp_map, sizeof(temp_map));\r\n}\r\n}\r\nstatic inline void amikbd_init_console_keymaps(void) {}\r\nstatic irqreturn_t amikbd_interrupt(int irq, void *data)\r\n{\r\nstruct input_dev *dev = data;\r\nunsigned char scancode, down;\r\nscancode = ~ciaa.sdr;\r\nciaa.cra |= 0x40;\r\nudelay(85);\r\nciaa.cra &= ~0x40;\r\ndown = !(scancode & 1);\r\nscancode >>= 1;\r\nif (scancode < 0x78) {\r\nif (scancode == 98) {\r\ninput_report_key(dev, scancode, 1);\r\ninput_report_key(dev, scancode, 0);\r\n} else {\r\ninput_report_key(dev, scancode, down);\r\n}\r\ninput_sync(dev);\r\n} else\r\nprintk(amikbd_messages[scancode - 0x78]);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init amikbd_probe(struct platform_device *pdev)\r\n{\r\nstruct input_dev *dev;\r\nint i, err;\r\ndev = input_allocate_device();\r\nif (!dev) {\r\ndev_err(&pdev->dev, "Not enough memory for input device\n");\r\nreturn -ENOMEM;\r\n}\r\ndev->name = pdev->name;\r\ndev->phys = "amikbd/input0";\r\ndev->id.bustype = BUS_AMIGA;\r\ndev->id.vendor = 0x0001;\r\ndev->id.product = 0x0001;\r\ndev->id.version = 0x0100;\r\ndev->dev.parent = &pdev->dev;\r\ndev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REP);\r\nfor (i = 0; i < 0x78; i++)\r\nset_bit(i, dev->keybit);\r\namikbd_init_console_keymaps();\r\nciaa.cra &= ~0x41;\r\nerr = request_irq(IRQ_AMIGA_CIAA_SP, amikbd_interrupt, 0, "amikbd",\r\ndev);\r\nif (err)\r\ngoto fail2;\r\nerr = input_register_device(dev);\r\nif (err)\r\ngoto fail3;\r\nplatform_set_drvdata(pdev, dev);\r\nreturn 0;\r\nfail3: free_irq(IRQ_AMIGA_CIAA_SP, dev);\r\nfail2: input_free_device(dev);\r\nreturn err;\r\n}\r\nstatic int __exit amikbd_remove(struct platform_device *pdev)\r\n{\r\nstruct input_dev *dev = platform_get_drvdata(pdev);\r\nfree_irq(IRQ_AMIGA_CIAA_SP, dev);\r\ninput_unregister_device(dev);\r\nreturn 0;\r\n}

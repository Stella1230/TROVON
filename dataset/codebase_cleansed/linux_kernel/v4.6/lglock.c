void lg_lock_init(struct lglock *lg, char *name)\r\n{\r\nLOCKDEP_INIT_MAP(&lg->lock_dep_map, name, &lg->lock_key, 0);\r\n}\r\nvoid lg_local_lock(struct lglock *lg)\r\n{\r\narch_spinlock_t *lock;\r\npreempt_disable();\r\nlock_acquire_shared(&lg->lock_dep_map, 0, 0, NULL, _RET_IP_);\r\nlock = this_cpu_ptr(lg->lock);\r\narch_spin_lock(lock);\r\n}\r\nvoid lg_local_unlock(struct lglock *lg)\r\n{\r\narch_spinlock_t *lock;\r\nlock_release(&lg->lock_dep_map, 1, _RET_IP_);\r\nlock = this_cpu_ptr(lg->lock);\r\narch_spin_unlock(lock);\r\npreempt_enable();\r\n}\r\nvoid lg_local_lock_cpu(struct lglock *lg, int cpu)\r\n{\r\narch_spinlock_t *lock;\r\npreempt_disable();\r\nlock_acquire_shared(&lg->lock_dep_map, 0, 0, NULL, _RET_IP_);\r\nlock = per_cpu_ptr(lg->lock, cpu);\r\narch_spin_lock(lock);\r\n}\r\nvoid lg_local_unlock_cpu(struct lglock *lg, int cpu)\r\n{\r\narch_spinlock_t *lock;\r\nlock_release(&lg->lock_dep_map, 1, _RET_IP_);\r\nlock = per_cpu_ptr(lg->lock, cpu);\r\narch_spin_unlock(lock);\r\npreempt_enable();\r\n}\r\nvoid lg_double_lock(struct lglock *lg, int cpu1, int cpu2)\r\n{\r\nBUG_ON(cpu1 == cpu2);\r\nif (cpu2 < cpu1)\r\nswap(cpu1, cpu2);\r\npreempt_disable();\r\nlock_acquire_shared(&lg->lock_dep_map, 0, 0, NULL, _RET_IP_);\r\narch_spin_lock(per_cpu_ptr(lg->lock, cpu1));\r\narch_spin_lock(per_cpu_ptr(lg->lock, cpu2));\r\n}\r\nvoid lg_double_unlock(struct lglock *lg, int cpu1, int cpu2)\r\n{\r\nlock_release(&lg->lock_dep_map, 1, _RET_IP_);\r\narch_spin_unlock(per_cpu_ptr(lg->lock, cpu1));\r\narch_spin_unlock(per_cpu_ptr(lg->lock, cpu2));\r\npreempt_enable();\r\n}\r\nvoid lg_global_lock(struct lglock *lg)\r\n{\r\nint i;\r\npreempt_disable();\r\nlock_acquire_exclusive(&lg->lock_dep_map, 0, 0, NULL, _RET_IP_);\r\nfor_each_possible_cpu(i) {\r\narch_spinlock_t *lock;\r\nlock = per_cpu_ptr(lg->lock, i);\r\narch_spin_lock(lock);\r\n}\r\n}\r\nvoid lg_global_unlock(struct lglock *lg)\r\n{\r\nint i;\r\nlock_release(&lg->lock_dep_map, 1, _RET_IP_);\r\nfor_each_possible_cpu(i) {\r\narch_spinlock_t *lock;\r\nlock = per_cpu_ptr(lg->lock, i);\r\narch_spin_unlock(lock);\r\n}\r\npreempt_enable();\r\n}

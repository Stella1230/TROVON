static inline u64 mic_system_page_mask(struct mic_device *mdev)\r\n{\r\nreturn (1ULL << mdev->smpt->info.page_shift) - 1ULL;\r\n}\r\nstatic inline u8 mic_sys_addr_to_smpt(struct mic_device *mdev, dma_addr_t pa)\r\n{\r\nreturn (pa - mdev->smpt->info.base) >> mdev->smpt->info.page_shift;\r\n}\r\nstatic inline u64 mic_smpt_to_pa(struct mic_device *mdev, u8 index)\r\n{\r\nreturn mdev->smpt->info.base + (index * mdev->smpt->info.page_size);\r\n}\r\nstatic inline u64 mic_smpt_offset(struct mic_device *mdev, dma_addr_t pa)\r\n{\r\nreturn pa & mic_system_page_mask(mdev);\r\n}\r\nstatic inline u64 mic_smpt_align_low(struct mic_device *mdev, dma_addr_t pa)\r\n{\r\nreturn ALIGN(pa - mic_system_page_mask(mdev),\r\nmdev->smpt->info.page_size);\r\n}\r\nstatic inline u64 mic_smpt_align_high(struct mic_device *mdev, dma_addr_t pa)\r\n{\r\nreturn ALIGN(pa, mdev->smpt->info.page_size);\r\n}\r\nstatic inline u64 mic_max_system_memory(struct mic_device *mdev)\r\n{\r\nreturn mdev->smpt->info.num_reg * mdev->smpt->info.page_size;\r\n}\r\nstatic inline u64 mic_max_system_addr(struct mic_device *mdev)\r\n{\r\nreturn mdev->smpt->info.base + mic_max_system_memory(mdev) - 1ULL;\r\n}\r\nstatic inline bool\r\nmic_is_system_addr(struct mic_device *mdev, dma_addr_t pa)\r\n{\r\nreturn pa >= mdev->smpt->info.base && pa <= mic_max_system_addr(mdev);\r\n}\r\nstatic void mic_add_smpt_entry(int spt, s64 *ref, u64 addr,\r\nint entries, struct mic_device *mdev)\r\n{\r\nstruct mic_smpt_info *smpt_info = mdev->smpt;\r\nint i;\r\nfor (i = spt; i < spt + entries; i++,\r\naddr += smpt_info->info.page_size) {\r\nif (!smpt_info->entry[i].ref_count &&\r\n(smpt_info->entry[i].dma_addr != addr)) {\r\nmdev->smpt_ops->set(mdev, addr, i);\r\nsmpt_info->entry[i].dma_addr = addr;\r\n}\r\nsmpt_info->entry[i].ref_count += ref[i - spt];\r\n}\r\n}\r\nstatic dma_addr_t mic_smpt_op(struct mic_device *mdev, u64 dma_addr,\r\nint entries, s64 *ref, size_t size)\r\n{\r\nint spt;\r\nint ae = 0;\r\nint i;\r\nunsigned long flags;\r\ndma_addr_t mic_addr = 0;\r\ndma_addr_t addr = dma_addr;\r\nstruct mic_smpt_info *smpt_info = mdev->smpt;\r\nspin_lock_irqsave(&smpt_info->smpt_lock, flags);\r\nfor (i = 0; i < smpt_info->info.num_reg; i++) {\r\nif (smpt_info->entry[i].dma_addr == addr) {\r\nae++;\r\naddr += smpt_info->info.page_size;\r\n} else if (ae)\r\ngoto not_found;\r\nif (ae == entries)\r\ngoto found;\r\n}\r\nfor (ae = 0, i = 0; i < smpt_info->info.num_reg; i++) {\r\nae = (smpt_info->entry[i].ref_count == 0) ? ae + 1 : 0;\r\nif (ae == entries)\r\ngoto found;\r\n}\r\nnot_found:\r\nspin_unlock_irqrestore(&smpt_info->smpt_lock, flags);\r\nreturn mic_addr;\r\nfound:\r\nspt = i - entries + 1;\r\nmic_addr = mic_smpt_to_pa(mdev, spt);\r\nmic_add_smpt_entry(spt, ref, dma_addr, entries, mdev);\r\nsmpt_info->map_count++;\r\nsmpt_info->ref_count += (s64)size;\r\nspin_unlock_irqrestore(&smpt_info->smpt_lock, flags);\r\nreturn mic_addr;\r\n}\r\nstatic int mic_get_smpt_ref_count(struct mic_device *mdev, dma_addr_t dma_addr,\r\nsize_t size, s64 *ref, u64 *smpt_start)\r\n{\r\nu64 start = dma_addr;\r\nu64 end = dma_addr + size;\r\nint i = 0;\r\nwhile (start < end) {\r\nref[i++] = min(mic_smpt_align_high(mdev, start + 1),\r\nend) - start;\r\nstart = mic_smpt_align_high(mdev, start + 1);\r\n}\r\nif (smpt_start)\r\n*smpt_start = mic_smpt_align_low(mdev, dma_addr);\r\nreturn i;\r\n}\r\ndma_addr_t mic_to_dma_addr(struct mic_device *mdev, dma_addr_t mic_addr)\r\n{\r\nstruct mic_smpt_info *smpt_info = mdev->smpt;\r\nint spt;\r\ndma_addr_t dma_addr;\r\nif (!mic_is_system_addr(mdev, mic_addr)) {\r\ndev_err(&mdev->pdev->dev,\r\n"mic_addr is invalid. mic_addr = 0x%llx\n", mic_addr);\r\nreturn -EINVAL;\r\n}\r\nspt = mic_sys_addr_to_smpt(mdev, mic_addr);\r\ndma_addr = smpt_info->entry[spt].dma_addr +\r\nmic_smpt_offset(mdev, mic_addr);\r\nreturn dma_addr;\r\n}\r\ndma_addr_t mic_map(struct mic_device *mdev, dma_addr_t dma_addr, size_t size)\r\n{\r\ndma_addr_t mic_addr = 0;\r\nint num_entries;\r\ns64 *ref;\r\nu64 smpt_start;\r\nif (!size || size > mic_max_system_memory(mdev))\r\nreturn mic_addr;\r\nref = kmalloc_array(mdev->smpt->info.num_reg, sizeof(s64), GFP_ATOMIC);\r\nif (!ref)\r\nreturn mic_addr;\r\nnum_entries = mic_get_smpt_ref_count(mdev, dma_addr, size,\r\nref, &smpt_start);\r\nmic_addr = mic_smpt_op(mdev, smpt_start, num_entries, ref, size);\r\nkfree(ref);\r\nif (!mic_addr && MIC_FAMILY_X100 == mdev->family) {\r\ndev_err(&mdev->pdev->dev,\r\n"mic_map failed dma_addr 0x%llx size 0x%lx\n",\r\ndma_addr, size);\r\nreturn mic_addr;\r\n} else {\r\nreturn mic_addr + mic_smpt_offset(mdev, dma_addr);\r\n}\r\n}\r\nvoid mic_unmap(struct mic_device *mdev, dma_addr_t mic_addr, size_t size)\r\n{\r\nstruct mic_smpt_info *smpt_info = mdev->smpt;\r\ns64 *ref;\r\nint num_smpt;\r\nint spt;\r\nint i;\r\nunsigned long flags;\r\nif (!size)\r\nreturn;\r\nif (!mic_is_system_addr(mdev, mic_addr)) {\r\ndev_err(&mdev->pdev->dev,\r\n"invalid address: 0x%llx\n", mic_addr);\r\nreturn;\r\n}\r\nspt = mic_sys_addr_to_smpt(mdev, mic_addr);\r\nref = kmalloc_array(mdev->smpt->info.num_reg, sizeof(s64), GFP_ATOMIC);\r\nif (!ref)\r\nreturn;\r\nnum_smpt = mic_get_smpt_ref_count(mdev, mic_addr, size, ref, NULL);\r\nspin_lock_irqsave(&smpt_info->smpt_lock, flags);\r\nsmpt_info->unmap_count++;\r\nsmpt_info->ref_count -= (s64)size;\r\nfor (i = spt; i < spt + num_smpt; i++) {\r\nsmpt_info->entry[i].ref_count -= ref[i - spt];\r\nif (smpt_info->entry[i].ref_count < 0)\r\ndev_warn(&mdev->pdev->dev,\r\n"ref count for entry %d is negative\n", i);\r\n}\r\nspin_unlock_irqrestore(&smpt_info->smpt_lock, flags);\r\nkfree(ref);\r\n}\r\ndma_addr_t mic_map_single(struct mic_device *mdev, void *va, size_t size)\r\n{\r\ndma_addr_t mic_addr = 0;\r\nstruct pci_dev *pdev = mdev->pdev;\r\ndma_addr_t dma_addr =\r\npci_map_single(pdev, va, size, PCI_DMA_BIDIRECTIONAL);\r\nif (!pci_dma_mapping_error(pdev, dma_addr)) {\r\nmic_addr = mic_map(mdev, dma_addr, size);\r\nif (!mic_addr) {\r\ndev_err(&mdev->pdev->dev,\r\n"mic_map failed dma_addr 0x%llx size 0x%lx\n",\r\ndma_addr, size);\r\npci_unmap_single(pdev, dma_addr,\r\nsize, PCI_DMA_BIDIRECTIONAL);\r\n}\r\n}\r\nreturn mic_addr;\r\n}\r\nvoid\r\nmic_unmap_single(struct mic_device *mdev, dma_addr_t mic_addr, size_t size)\r\n{\r\nstruct pci_dev *pdev = mdev->pdev;\r\ndma_addr_t dma_addr = mic_to_dma_addr(mdev, mic_addr);\r\nmic_unmap(mdev, mic_addr, size);\r\npci_unmap_single(pdev, dma_addr, size, PCI_DMA_BIDIRECTIONAL);\r\n}\r\nint mic_smpt_init(struct mic_device *mdev)\r\n{\r\nint i, err = 0;\r\ndma_addr_t dma_addr;\r\nstruct mic_smpt_info *smpt_info;\r\nmdev->smpt = kmalloc(sizeof(*mdev->smpt), GFP_KERNEL);\r\nif (!mdev->smpt)\r\nreturn -ENOMEM;\r\nsmpt_info = mdev->smpt;\r\nmdev->smpt_ops->init(mdev);\r\nsmpt_info->entry = kmalloc_array(smpt_info->info.num_reg,\r\nsizeof(*smpt_info->entry), GFP_KERNEL);\r\nif (!smpt_info->entry) {\r\nerr = -ENOMEM;\r\ngoto free_smpt;\r\n}\r\nspin_lock_init(&smpt_info->smpt_lock);\r\nfor (i = 0; i < smpt_info->info.num_reg; i++) {\r\ndma_addr = i * smpt_info->info.page_size;\r\nsmpt_info->entry[i].dma_addr = dma_addr;\r\nsmpt_info->entry[i].ref_count = 0;\r\nmdev->smpt_ops->set(mdev, dma_addr, i);\r\n}\r\nsmpt_info->ref_count = 0;\r\nsmpt_info->map_count = 0;\r\nsmpt_info->unmap_count = 0;\r\nreturn 0;\r\nfree_smpt:\r\nkfree(smpt_info);\r\nreturn err;\r\n}\r\nvoid mic_smpt_uninit(struct mic_device *mdev)\r\n{\r\nstruct mic_smpt_info *smpt_info = mdev->smpt;\r\nint i;\r\ndev_dbg(&mdev->pdev->dev,\r\n"nodeid %d SMPT ref count %lld map %lld unmap %lld\n",\r\nmdev->id, smpt_info->ref_count,\r\nsmpt_info->map_count, smpt_info->unmap_count);\r\nfor (i = 0; i < smpt_info->info.num_reg; i++) {\r\ndev_dbg(&mdev->pdev->dev,\r\n"SMPT entry[%d] dma_addr = 0x%llx ref_count = %lld\n",\r\ni, smpt_info->entry[i].dma_addr,\r\nsmpt_info->entry[i].ref_count);\r\nif (smpt_info->entry[i].ref_count)\r\ndev_warn(&mdev->pdev->dev,\r\n"ref count for entry %d is not zero\n", i);\r\n}\r\nkfree(smpt_info->entry);\r\nkfree(smpt_info);\r\n}\r\nvoid mic_smpt_restore(struct mic_device *mdev)\r\n{\r\nint i;\r\ndma_addr_t dma_addr;\r\nfor (i = 0; i < mdev->smpt->info.num_reg; i++) {\r\ndma_addr = mdev->smpt->entry[i].dma_addr;\r\nmdev->smpt_ops->set(mdev, dma_addr, i);\r\n}\r\n}

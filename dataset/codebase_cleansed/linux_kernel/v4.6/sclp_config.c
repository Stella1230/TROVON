static void sclp_cpu_capability_notify(struct work_struct *work)\r\n{\r\nint cpu;\r\nstruct device *dev;\r\ns390_adjust_jiffies();\r\npr_info("CPU capability may have changed\n");\r\nget_online_cpus();\r\nfor_each_online_cpu(cpu) {\r\ndev = get_cpu_device(cpu);\r\nkobject_uevent(&dev->kobj, KOBJ_CHANGE);\r\n}\r\nput_online_cpus();\r\n}\r\nstatic void __ref sclp_cpu_change_notify(struct work_struct *work)\r\n{\r\nsmp_rescan_cpus();\r\n}\r\nstatic void sclp_conf_receiver_fn(struct evbuf_header *evbuf)\r\n{\r\nstruct conf_mgm_data *cdata;\r\ncdata = (struct conf_mgm_data *)(evbuf + 1);\r\nswitch (cdata->ev_qualifier) {\r\ncase EV_QUAL_CPU_CHANGE:\r\nschedule_work(&sclp_cpu_change_work);\r\nbreak;\r\ncase EV_QUAL_CAP_CHANGE:\r\nschedule_work(&sclp_cpu_capability_work);\r\nbreak;\r\n}\r\n}\r\nstatic int sclp_ofb_send_req(char *ev_data, size_t len)\r\n{\r\nstatic DEFINE_MUTEX(send_mutex);\r\nstruct sclp_ofb_sccb *sccb;\r\nint rc, response;\r\nif (len > OFB_DATA_MAX)\r\nreturn -EINVAL;\r\nsccb = (struct sclp_ofb_sccb *) get_zeroed_page(GFP_KERNEL | GFP_DMA);\r\nif (!sccb)\r\nreturn -ENOMEM;\r\nsccb->header.length = sizeof(struct sclp_ofb_sccb);\r\nsccb->ofb_evbuf.header.length = sizeof(struct sclp_ofb_evbuf);\r\nsccb->ofb_evbuf.header.type = EVTYP_CONFMGMDATA;\r\nsccb->ofb_evbuf.cm_data.ev_qualifier = EV_QUAL_OPEN4BUSINESS;\r\nmemcpy(sccb->ofb_evbuf.ev_data, ev_data, len);\r\nif (!(sclp_conf_register.sclp_receive_mask & EVTYP_CONFMGMDATA_MASK))\r\npr_warn("SCLP receiver did not register to receive "\r\n"Configuration Management Data Events.\n");\r\nmutex_lock(&send_mutex);\r\nrc = sclp_sync_request(SCLP_CMDW_WRITE_EVENT_DATA, sccb);\r\nmutex_unlock(&send_mutex);\r\nif (rc)\r\ngoto out;\r\nresponse = sccb->header.response_code;\r\nif (response != 0x0020) {\r\npr_err("Open for Business request failed with response code "\r\n"0x%04x\n", response);\r\nrc = -EIO;\r\n}\r\nout:\r\nfree_page((unsigned long)sccb);\r\nreturn rc;\r\n}\r\nstatic ssize_t sysfs_ofb_data_write(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nint rc;\r\nrc = sclp_ofb_send_req(buf, count);\r\nreturn rc ?: count;\r\n}\r\nstatic int __init sclp_ofb_setup(void)\r\n{\r\n#ifdef CONFIG_SCLP_OFB\r\nstruct kset *ofb_kset;\r\nint rc;\r\nofb_kset = kset_create_and_add("ofb", NULL, firmware_kobj);\r\nif (!ofb_kset)\r\nreturn -ENOMEM;\r\nrc = sysfs_create_bin_file(&ofb_kset->kobj, &ofb_bin_attr);\r\nif (rc) {\r\nkset_unregister(ofb_kset);\r\nreturn rc;\r\n}\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int __init sclp_conf_init(void)\r\n{\r\nint rc;\r\nINIT_WORK(&sclp_cpu_capability_work, sclp_cpu_capability_notify);\r\nINIT_WORK(&sclp_cpu_change_work, sclp_cpu_change_notify);\r\nrc = sclp_register(&sclp_conf_register);\r\nif (rc)\r\nreturn rc;\r\nreturn sclp_ofb_setup();\r\n}

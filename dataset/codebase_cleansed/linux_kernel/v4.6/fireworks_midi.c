static int midi_capture_open(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_efw *efw = substream->rmidi->private_data;\r\nint err;\r\nerr = snd_efw_stream_lock_try(efw);\r\nif (err < 0)\r\ngoto end;\r\nmutex_lock(&efw->mutex);\r\nefw->capture_substreams++;\r\nerr = snd_efw_stream_start_duplex(efw, 0);\r\nmutex_unlock(&efw->mutex);\r\nif (err < 0)\r\nsnd_efw_stream_lock_release(efw);\r\nend:\r\nreturn err;\r\n}\r\nstatic int midi_playback_open(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_efw *efw = substream->rmidi->private_data;\r\nint err;\r\nerr = snd_efw_stream_lock_try(efw);\r\nif (err < 0)\r\ngoto end;\r\nmutex_lock(&efw->mutex);\r\nefw->playback_substreams++;\r\nerr = snd_efw_stream_start_duplex(efw, 0);\r\nmutex_unlock(&efw->mutex);\r\nif (err < 0)\r\nsnd_efw_stream_lock_release(efw);\r\nend:\r\nreturn err;\r\n}\r\nstatic int midi_capture_close(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_efw *efw = substream->rmidi->private_data;\r\nmutex_lock(&efw->mutex);\r\nefw->capture_substreams--;\r\nsnd_efw_stream_stop_duplex(efw);\r\nmutex_unlock(&efw->mutex);\r\nsnd_efw_stream_lock_release(efw);\r\nreturn 0;\r\n}\r\nstatic int midi_playback_close(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_efw *efw = substream->rmidi->private_data;\r\nmutex_lock(&efw->mutex);\r\nefw->playback_substreams--;\r\nsnd_efw_stream_stop_duplex(efw);\r\nmutex_unlock(&efw->mutex);\r\nsnd_efw_stream_lock_release(efw);\r\nreturn 0;\r\n}\r\nstatic void midi_capture_trigger(struct snd_rawmidi_substream *substrm, int up)\r\n{\r\nstruct snd_efw *efw = substrm->rmidi->private_data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&efw->lock, flags);\r\nif (up)\r\namdtp_am824_midi_trigger(&efw->tx_stream,\r\nsubstrm->number, substrm);\r\nelse\r\namdtp_am824_midi_trigger(&efw->tx_stream,\r\nsubstrm->number, NULL);\r\nspin_unlock_irqrestore(&efw->lock, flags);\r\n}\r\nstatic void midi_playback_trigger(struct snd_rawmidi_substream *substrm, int up)\r\n{\r\nstruct snd_efw *efw = substrm->rmidi->private_data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&efw->lock, flags);\r\nif (up)\r\namdtp_am824_midi_trigger(&efw->rx_stream,\r\nsubstrm->number, substrm);\r\nelse\r\namdtp_am824_midi_trigger(&efw->rx_stream,\r\nsubstrm->number, NULL);\r\nspin_unlock_irqrestore(&efw->lock, flags);\r\n}\r\nstatic void set_midi_substream_names(struct snd_efw *efw,\r\nstruct snd_rawmidi_str *str)\r\n{\r\nstruct snd_rawmidi_substream *subs;\r\nlist_for_each_entry(subs, &str->substreams, list) {\r\nsnprintf(subs->name, sizeof(subs->name),\r\n"%s MIDI %d", efw->card->shortname, subs->number + 1);\r\n}\r\n}\r\nint snd_efw_create_midi_devices(struct snd_efw *efw)\r\n{\r\nstruct snd_rawmidi *rmidi;\r\nstruct snd_rawmidi_str *str;\r\nint err;\r\nerr = snd_rawmidi_new(efw->card, efw->card->driver, 0,\r\nefw->midi_out_ports, efw->midi_in_ports,\r\n&rmidi);\r\nif (err < 0)\r\nreturn err;\r\nsnprintf(rmidi->name, sizeof(rmidi->name),\r\n"%s MIDI", efw->card->shortname);\r\nrmidi->private_data = efw;\r\nif (efw->midi_in_ports > 0) {\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_INPUT;\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT,\r\n&midi_capture_ops);\r\nstr = &rmidi->streams[SNDRV_RAWMIDI_STREAM_INPUT];\r\nset_midi_substream_names(efw, str);\r\n}\r\nif (efw->midi_out_ports > 0) {\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_OUTPUT;\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT,\r\n&midi_playback_ops);\r\nstr = &rmidi->streams[SNDRV_RAWMIDI_STREAM_OUTPUT];\r\nset_midi_substream_names(efw, str);\r\n}\r\nif ((efw->midi_out_ports > 0) && (efw->midi_in_ports > 0))\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_DUPLEX;\r\nreturn 0;\r\n}

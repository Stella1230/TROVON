static inline void set_dst_mac(struct __sk_buff *skb, char *mac)\r\n{\r\nbpf_skb_store_bytes(skb, 0, mac, ETH_ALEN, 1);\r\n}\r\nstatic inline void set_ip_tos(struct __sk_buff *skb, __u8 new_tos)\r\n{\r\n__u8 old_tos = load_byte(skb, TOS_OFF);\r\nbpf_l3_csum_replace(skb, IP_CSUM_OFF, htons(old_tos), htons(new_tos), 2);\r\nbpf_skb_store_bytes(skb, TOS_OFF, &new_tos, sizeof(new_tos), 0);\r\n}\r\nstatic inline void set_tcp_ip_src(struct __sk_buff *skb, __u32 new_ip)\r\n{\r\n__u32 old_ip = _htonl(load_word(skb, IP_SRC_OFF));\r\nbpf_l4_csum_replace(skb, TCP_CSUM_OFF, old_ip, new_ip, IS_PSEUDO | sizeof(new_ip));\r\nbpf_l3_csum_replace(skb, IP_CSUM_OFF, old_ip, new_ip, sizeof(new_ip));\r\nbpf_skb_store_bytes(skb, IP_SRC_OFF, &new_ip, sizeof(new_ip), 0);\r\n}\r\nstatic inline void set_tcp_dest_port(struct __sk_buff *skb, __u16 new_port)\r\n{\r\n__u16 old_port = htons(load_half(skb, TCP_DPORT_OFF));\r\nbpf_l4_csum_replace(skb, TCP_CSUM_OFF, old_port, new_port, sizeof(new_port));\r\nbpf_skb_store_bytes(skb, TCP_DPORT_OFF, &new_port, sizeof(new_port), 0);\r\n}\r\nint bpf_prog1(struct __sk_buff *skb)\r\n{\r\n__u8 proto = load_byte(skb, ETH_HLEN + offsetof(struct iphdr, protocol));\r\nlong *value;\r\nif (proto == IPPROTO_TCP) {\r\nset_ip_tos(skb, 8);\r\nset_tcp_ip_src(skb, 0xA010101);\r\nset_tcp_dest_port(skb, 5001);\r\n}\r\nreturn 0;\r\n}\r\nint _redirect_xmit(struct __sk_buff *skb)\r\n{\r\nreturn bpf_redirect(skb->ifindex + 1, 0);\r\n}\r\nint _redirect_recv(struct __sk_buff *skb)\r\n{\r\nreturn bpf_redirect(skb->ifindex + 1, 1);\r\n}\r\nint _clone_redirect_xmit(struct __sk_buff *skb)\r\n{\r\nbpf_clone_redirect(skb, skb->ifindex + 1, 0);\r\nreturn TC_ACT_SHOT;\r\n}\r\nint _clone_redirect_recv(struct __sk_buff *skb)\r\n{\r\nbpf_clone_redirect(skb, skb->ifindex + 1, 1);\r\nreturn TC_ACT_SHOT;\r\n}

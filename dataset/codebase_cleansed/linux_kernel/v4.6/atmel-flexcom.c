static int atmel_flexcom_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct clk *clk;\r\nstruct resource *res;\r\nvoid __iomem *base;\r\nu32 opmode;\r\nint err;\r\nerr = of_property_read_u32(np, "atmel,flexcom-mode", &opmode);\r\nif (err)\r\nreturn err;\r\nif (opmode < ATMEL_FLEXCOM_MODE_USART ||\r\nopmode > ATMEL_FLEXCOM_MODE_TWI)\r\nreturn -EINVAL;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\nclk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nerr = clk_prepare_enable(clk);\r\nif (err)\r\nreturn err;\r\nwritel(FLEX_MR_OPMODE(opmode), base + FLEX_MR);\r\nclk_disable_unprepare(clk);\r\nreturn of_platform_populate(np, NULL, NULL, &pdev->dev);\r\n}

static int vbi_out_queue_setup(struct vb2_queue *vq,\r\nunsigned *nbuffers, unsigned *nplanes,\r\nunsigned sizes[], void *alloc_ctxs[])\r\n{\r\nstruct vivid_dev *dev = vb2_get_drv_priv(vq);\r\nbool is_60hz = dev->std_out & V4L2_STD_525_60;\r\nunsigned size = vq->type == V4L2_BUF_TYPE_SLICED_VBI_OUTPUT ?\r\n36 * sizeof(struct v4l2_sliced_vbi_data) :\r\n1440 * 2 * (is_60hz ? 12 : 18);\r\nif (!vivid_is_svid_out(dev))\r\nreturn -EINVAL;\r\nsizes[0] = size;\r\nif (vq->num_buffers + *nbuffers < 2)\r\n*nbuffers = 2 - vq->num_buffers;\r\n*nplanes = 1;\r\nreturn 0;\r\n}\r\nstatic int vbi_out_buf_prepare(struct vb2_buffer *vb)\r\n{\r\nstruct vivid_dev *dev = vb2_get_drv_priv(vb->vb2_queue);\r\nbool is_60hz = dev->std_out & V4L2_STD_525_60;\r\nunsigned size = vb->vb2_queue->type == V4L2_BUF_TYPE_SLICED_VBI_OUTPUT ?\r\n36 * sizeof(struct v4l2_sliced_vbi_data) :\r\n1440 * 2 * (is_60hz ? 12 : 18);\r\ndprintk(dev, 1, "%s\n", __func__);\r\nif (dev->buf_prepare_error) {\r\ndev->buf_prepare_error = false;\r\nreturn -EINVAL;\r\n}\r\nif (vb2_plane_size(vb, 0) < size) {\r\ndprintk(dev, 1, "%s data will not fit into plane (%lu < %u)\n",\r\n__func__, vb2_plane_size(vb, 0), size);\r\nreturn -EINVAL;\r\n}\r\nvb2_set_plane_payload(vb, 0, size);\r\nreturn 0;\r\n}\r\nstatic void vbi_out_buf_queue(struct vb2_buffer *vb)\r\n{\r\nstruct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb);\r\nstruct vivid_dev *dev = vb2_get_drv_priv(vb->vb2_queue);\r\nstruct vivid_buffer *buf = container_of(vbuf, struct vivid_buffer, vb);\r\ndprintk(dev, 1, "%s\n", __func__);\r\nspin_lock(&dev->slock);\r\nlist_add_tail(&buf->list, &dev->vbi_out_active);\r\nspin_unlock(&dev->slock);\r\n}\r\nstatic int vbi_out_start_streaming(struct vb2_queue *vq, unsigned count)\r\n{\r\nstruct vivid_dev *dev = vb2_get_drv_priv(vq);\r\nint err;\r\ndprintk(dev, 1, "%s\n", __func__);\r\ndev->vbi_out_seq_count = 0;\r\nif (dev->start_streaming_error) {\r\ndev->start_streaming_error = false;\r\nerr = -EINVAL;\r\n} else {\r\nerr = vivid_start_generating_vid_out(dev, &dev->vbi_out_streaming);\r\n}\r\nif (err) {\r\nstruct vivid_buffer *buf, *tmp;\r\nlist_for_each_entry_safe(buf, tmp, &dev->vbi_out_active, list) {\r\nlist_del(&buf->list);\r\nvb2_buffer_done(&buf->vb.vb2_buf,\r\nVB2_BUF_STATE_QUEUED);\r\n}\r\n}\r\nreturn err;\r\n}\r\nstatic void vbi_out_stop_streaming(struct vb2_queue *vq)\r\n{\r\nstruct vivid_dev *dev = vb2_get_drv_priv(vq);\r\ndprintk(dev, 1, "%s\n", __func__);\r\nvivid_stop_generating_vid_out(dev, &dev->vbi_out_streaming);\r\ndev->vbi_out_have_wss = false;\r\ndev->vbi_out_have_cc[0] = false;\r\ndev->vbi_out_have_cc[1] = false;\r\n}\r\nint vidioc_g_fmt_vbi_out(struct file *file, void *priv,\r\nstruct v4l2_format *f)\r\n{\r\nstruct vivid_dev *dev = video_drvdata(file);\r\nstruct v4l2_vbi_format *vbi = &f->fmt.vbi;\r\nbool is_60hz = dev->std_out & V4L2_STD_525_60;\r\nif (!vivid_is_svid_out(dev) || !dev->has_raw_vbi_out)\r\nreturn -EINVAL;\r\nvbi->sampling_rate = 25000000;\r\nvbi->offset = 24;\r\nvbi->samples_per_line = 1440;\r\nvbi->sample_format = V4L2_PIX_FMT_GREY;\r\nvbi->start[0] = is_60hz ? V4L2_VBI_ITU_525_F1_START + 9 : V4L2_VBI_ITU_625_F1_START + 5;\r\nvbi->start[1] = is_60hz ? V4L2_VBI_ITU_525_F2_START + 9 : V4L2_VBI_ITU_625_F2_START + 5;\r\nvbi->count[0] = vbi->count[1] = is_60hz ? 12 : 18;\r\nvbi->flags = dev->vbi_cap_interlaced ? V4L2_VBI_INTERLACED : 0;\r\nvbi->reserved[0] = 0;\r\nvbi->reserved[1] = 0;\r\nreturn 0;\r\n}\r\nint vidioc_s_fmt_vbi_out(struct file *file, void *priv,\r\nstruct v4l2_format *f)\r\n{\r\nstruct vivid_dev *dev = video_drvdata(file);\r\nint ret = vidioc_g_fmt_vbi_out(file, priv, f);\r\nif (ret)\r\nreturn ret;\r\nif (vb2_is_busy(&dev->vb_vbi_out_q))\r\nreturn -EBUSY;\r\ndev->stream_sliced_vbi_out = false;\r\ndev->vbi_out_dev.queue->type = V4L2_BUF_TYPE_VBI_OUTPUT;\r\nreturn 0;\r\n}\r\nint vidioc_g_fmt_sliced_vbi_out(struct file *file, void *fh, struct v4l2_format *fmt)\r\n{\r\nstruct vivid_dev *dev = video_drvdata(file);\r\nstruct v4l2_sliced_vbi_format *vbi = &fmt->fmt.sliced;\r\nif (!vivid_is_svid_out(dev) || !dev->has_sliced_vbi_out)\r\nreturn -EINVAL;\r\nvivid_fill_service_lines(vbi, dev->service_set_out);\r\nreturn 0;\r\n}\r\nint vidioc_try_fmt_sliced_vbi_out(struct file *file, void *fh, struct v4l2_format *fmt)\r\n{\r\nstruct vivid_dev *dev = video_drvdata(file);\r\nstruct v4l2_sliced_vbi_format *vbi = &fmt->fmt.sliced;\r\nbool is_60hz = dev->std_out & V4L2_STD_525_60;\r\nu32 service_set = vbi->service_set;\r\nif (!vivid_is_svid_out(dev) || !dev->has_sliced_vbi_out)\r\nreturn -EINVAL;\r\nservice_set &= is_60hz ? V4L2_SLICED_CAPTION_525 :\r\nV4L2_SLICED_WSS_625 | V4L2_SLICED_TELETEXT_B;\r\nvivid_fill_service_lines(vbi, service_set);\r\nreturn 0;\r\n}\r\nint vidioc_s_fmt_sliced_vbi_out(struct file *file, void *fh,\r\nstruct v4l2_format *fmt)\r\n{\r\nstruct vivid_dev *dev = video_drvdata(file);\r\nstruct v4l2_sliced_vbi_format *vbi = &fmt->fmt.sliced;\r\nint ret = vidioc_try_fmt_sliced_vbi_out(file, fh, fmt);\r\nif (ret)\r\nreturn ret;\r\nif (vb2_is_busy(&dev->vb_vbi_out_q))\r\nreturn -EBUSY;\r\ndev->service_set_out = vbi->service_set;\r\ndev->stream_sliced_vbi_out = true;\r\ndev->vbi_out_dev.queue->type = V4L2_BUF_TYPE_SLICED_VBI_OUTPUT;\r\nreturn 0;\r\n}\r\nvoid vivid_sliced_vbi_out_process(struct vivid_dev *dev,\r\nstruct vivid_buffer *buf)\r\n{\r\nstruct v4l2_sliced_vbi_data *vbi =\r\nvb2_plane_vaddr(&buf->vb.vb2_buf, 0);\r\nunsigned elems =\r\nvb2_get_plane_payload(&buf->vb.vb2_buf, 0) / sizeof(*vbi);\r\ndev->vbi_out_have_cc[0] = false;\r\ndev->vbi_out_have_cc[1] = false;\r\ndev->vbi_out_have_wss = false;\r\nwhile (elems--) {\r\nswitch (vbi->id) {\r\ncase V4L2_SLICED_CAPTION_525:\r\nif ((dev->std_out & V4L2_STD_525_60) && vbi->line == 21) {\r\ndev->vbi_out_have_cc[!!vbi->field] = true;\r\ndev->vbi_out_cc[!!vbi->field][0] = vbi->data[0];\r\ndev->vbi_out_cc[!!vbi->field][1] = vbi->data[1];\r\n}\r\nbreak;\r\ncase V4L2_SLICED_WSS_625:\r\nif ((dev->std_out & V4L2_STD_625_50) &&\r\nvbi->field == 0 && vbi->line == 23) {\r\ndev->vbi_out_have_wss = true;\r\ndev->vbi_out_wss[0] = vbi->data[0];\r\ndev->vbi_out_wss[1] = vbi->data[1];\r\n}\r\nbreak;\r\n}\r\nvbi++;\r\n}\r\n}

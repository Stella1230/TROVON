static void micro_key_receive(void *data, int len, unsigned char *msg)\r\n{\r\nstruct ipaq_micro_keys *keys = data;\r\nint key, down;\r\ndown = 0x80 & msg[0];\r\nkey = 0x7f & msg[0];\r\nif (key < ARRAY_SIZE(micro_keycodes)) {\r\ninput_report_key(keys->input, keys->codes[key], down);\r\ninput_sync(keys->input);\r\n}\r\n}\r\nstatic void micro_key_start(struct ipaq_micro_keys *keys)\r\n{\r\nspin_lock(&keys->micro->lock);\r\nkeys->micro->key = micro_key_receive;\r\nkeys->micro->key_data = keys;\r\nspin_unlock(&keys->micro->lock);\r\n}\r\nstatic void micro_key_stop(struct ipaq_micro_keys *keys)\r\n{\r\nspin_lock(&keys->micro->lock);\r\nkeys->micro->key = NULL;\r\nkeys->micro->key_data = NULL;\r\nspin_unlock(&keys->micro->lock);\r\n}\r\nstatic int micro_key_open(struct input_dev *input)\r\n{\r\nstruct ipaq_micro_keys *keys = input_get_drvdata(input);\r\nmicro_key_start(keys);\r\nreturn 0;\r\n}\r\nstatic void micro_key_close(struct input_dev *input)\r\n{\r\nstruct ipaq_micro_keys *keys = input_get_drvdata(input);\r\nmicro_key_stop(keys);\r\n}\r\nstatic int micro_key_probe(struct platform_device *pdev)\r\n{\r\nstruct ipaq_micro_keys *keys;\r\nint error;\r\nint i;\r\nkeys = devm_kzalloc(&pdev->dev, sizeof(*keys), GFP_KERNEL);\r\nif (!keys)\r\nreturn -ENOMEM;\r\nkeys->micro = dev_get_drvdata(pdev->dev.parent);\r\nkeys->input = devm_input_allocate_device(&pdev->dev);\r\nif (!keys->input)\r\nreturn -ENOMEM;\r\nkeys->input->keycodesize = sizeof(micro_keycodes[0]);\r\nkeys->input->keycodemax = ARRAY_SIZE(micro_keycodes);\r\nkeys->codes = devm_kmemdup(&pdev->dev, micro_keycodes,\r\nkeys->input->keycodesize * keys->input->keycodemax,\r\nGFP_KERNEL);\r\nkeys->input->keycode = keys->codes;\r\n__set_bit(EV_KEY, keys->input->evbit);\r\nfor (i = 0; i < ARRAY_SIZE(micro_keycodes); i++)\r\n__set_bit(micro_keycodes[i], keys->input->keybit);\r\nkeys->input->name = "h3600 micro keys";\r\nkeys->input->open = micro_key_open;\r\nkeys->input->close = micro_key_close;\r\ninput_set_drvdata(keys->input, keys);\r\nerror = input_register_device(keys->input);\r\nif (error)\r\nreturn error;\r\nplatform_set_drvdata(pdev, keys);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused micro_key_suspend(struct device *dev)\r\n{\r\nstruct ipaq_micro_keys *keys = dev_get_drvdata(dev);\r\nmicro_key_stop(keys);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused micro_key_resume(struct device *dev)\r\n{\r\nstruct ipaq_micro_keys *keys = dev_get_drvdata(dev);\r\nstruct input_dev *input = keys->input;\r\nmutex_lock(&input->mutex);\r\nif (input->users)\r\nmicro_key_start(keys);\r\nmutex_unlock(&input->mutex);\r\nreturn 0;\r\n}

static int\r\nieee802154_hdr_push_addr(u8 *buf, const struct ieee802154_addr *addr,\r\nbool omit_pan)\r\n{\r\nint pos = 0;\r\nif (addr->mode == IEEE802154_ADDR_NONE)\r\nreturn 0;\r\nif (!omit_pan) {\r\nmemcpy(buf + pos, &addr->pan_id, 2);\r\npos += 2;\r\n}\r\nswitch (addr->mode) {\r\ncase IEEE802154_ADDR_SHORT:\r\nmemcpy(buf + pos, &addr->short_addr, 2);\r\npos += 2;\r\nbreak;\r\ncase IEEE802154_ADDR_LONG:\r\nmemcpy(buf + pos, &addr->extended_addr, IEEE802154_ADDR_LEN);\r\npos += IEEE802154_ADDR_LEN;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn pos;\r\n}\r\nstatic int\r\nieee802154_hdr_push_sechdr(u8 *buf, const struct ieee802154_sechdr *hdr)\r\n{\r\nint pos = 5;\r\nmemcpy(buf, hdr, 1);\r\nmemcpy(buf + 1, &hdr->frame_counter, 4);\r\nswitch (hdr->key_id_mode) {\r\ncase IEEE802154_SCF_KEY_IMPLICIT:\r\nreturn pos;\r\ncase IEEE802154_SCF_KEY_INDEX:\r\nbreak;\r\ncase IEEE802154_SCF_KEY_SHORT_INDEX:\r\nmemcpy(buf + pos, &hdr->short_src, 4);\r\npos += 4;\r\nbreak;\r\ncase IEEE802154_SCF_KEY_HW_INDEX:\r\nmemcpy(buf + pos, &hdr->extended_src, IEEE802154_ADDR_LEN);\r\npos += IEEE802154_ADDR_LEN;\r\nbreak;\r\n}\r\nbuf[pos++] = hdr->key_id;\r\nreturn pos;\r\n}\r\nint\r\nieee802154_hdr_push(struct sk_buff *skb, struct ieee802154_hdr *hdr)\r\n{\r\nu8 buf[IEEE802154_MAX_HEADER_LEN];\r\nint pos = 2;\r\nint rc;\r\nstruct ieee802154_hdr_fc *fc = &hdr->fc;\r\nbuf[pos++] = hdr->seq;\r\nfc->dest_addr_mode = hdr->dest.mode;\r\nrc = ieee802154_hdr_push_addr(buf + pos, &hdr->dest, false);\r\nif (rc < 0)\r\nreturn -EINVAL;\r\npos += rc;\r\nfc->source_addr_mode = hdr->source.mode;\r\nif (hdr->source.pan_id == hdr->dest.pan_id &&\r\nhdr->dest.mode != IEEE802154_ADDR_NONE)\r\nfc->intra_pan = true;\r\nrc = ieee802154_hdr_push_addr(buf + pos, &hdr->source, fc->intra_pan);\r\nif (rc < 0)\r\nreturn -EINVAL;\r\npos += rc;\r\nif (fc->security_enabled) {\r\nfc->version = 1;\r\nrc = ieee802154_hdr_push_sechdr(buf + pos, &hdr->sec);\r\nif (rc < 0)\r\nreturn -EINVAL;\r\npos += rc;\r\n}\r\nmemcpy(buf, fc, 2);\r\nmemcpy(skb_push(skb, pos), buf, pos);\r\nreturn pos;\r\n}\r\nstatic int\r\nieee802154_hdr_get_addr(const u8 *buf, int mode, bool omit_pan,\r\nstruct ieee802154_addr *addr)\r\n{\r\nint pos = 0;\r\naddr->mode = mode;\r\nif (mode == IEEE802154_ADDR_NONE)\r\nreturn 0;\r\nif (!omit_pan) {\r\nmemcpy(&addr->pan_id, buf + pos, 2);\r\npos += 2;\r\n}\r\nif (mode == IEEE802154_ADDR_SHORT) {\r\nmemcpy(&addr->short_addr, buf + pos, 2);\r\nreturn pos + 2;\r\n} else {\r\nmemcpy(&addr->extended_addr, buf + pos, IEEE802154_ADDR_LEN);\r\nreturn pos + IEEE802154_ADDR_LEN;\r\n}\r\n}\r\nstatic int ieee802154_hdr_addr_len(int mode, bool omit_pan)\r\n{\r\nint pan_len = omit_pan ? 0 : 2;\r\nswitch (mode) {\r\ncase IEEE802154_ADDR_NONE: return 0;\r\ncase IEEE802154_ADDR_SHORT: return 2 + pan_len;\r\ncase IEEE802154_ADDR_LONG: return IEEE802154_ADDR_LEN + pan_len;\r\ndefault: return -EINVAL;\r\n}\r\n}\r\nstatic int\r\nieee802154_hdr_get_sechdr(const u8 *buf, struct ieee802154_sechdr *hdr)\r\n{\r\nint pos = 5;\r\nmemcpy(hdr, buf, 1);\r\nmemcpy(&hdr->frame_counter, buf + 1, 4);\r\nswitch (hdr->key_id_mode) {\r\ncase IEEE802154_SCF_KEY_IMPLICIT:\r\nreturn pos;\r\ncase IEEE802154_SCF_KEY_INDEX:\r\nbreak;\r\ncase IEEE802154_SCF_KEY_SHORT_INDEX:\r\nmemcpy(&hdr->short_src, buf + pos, 4);\r\npos += 4;\r\nbreak;\r\ncase IEEE802154_SCF_KEY_HW_INDEX:\r\nmemcpy(&hdr->extended_src, buf + pos, IEEE802154_ADDR_LEN);\r\npos += IEEE802154_ADDR_LEN;\r\nbreak;\r\n}\r\nhdr->key_id = buf[pos++];\r\nreturn pos;\r\n}\r\nstatic int ieee802154_hdr_sechdr_len(u8 sc)\r\n{\r\nreturn ieee802154_sechdr_lengths[IEEE802154_SCF_KEY_ID_MODE(sc)];\r\n}\r\nstatic int ieee802154_hdr_minlen(const struct ieee802154_hdr *hdr)\r\n{\r\nint dlen, slen;\r\ndlen = ieee802154_hdr_addr_len(hdr->fc.dest_addr_mode, false);\r\nslen = ieee802154_hdr_addr_len(hdr->fc.source_addr_mode,\r\nhdr->fc.intra_pan);\r\nif (slen < 0 || dlen < 0)\r\nreturn -EINVAL;\r\nreturn 3 + dlen + slen + hdr->fc.security_enabled;\r\n}\r\nstatic int\r\nieee802154_hdr_get_addrs(const u8 *buf, struct ieee802154_hdr *hdr)\r\n{\r\nint pos = 0;\r\npos += ieee802154_hdr_get_addr(buf + pos, hdr->fc.dest_addr_mode,\r\nfalse, &hdr->dest);\r\npos += ieee802154_hdr_get_addr(buf + pos, hdr->fc.source_addr_mode,\r\nhdr->fc.intra_pan, &hdr->source);\r\nif (hdr->fc.intra_pan)\r\nhdr->source.pan_id = hdr->dest.pan_id;\r\nreturn pos;\r\n}\r\nint\r\nieee802154_hdr_pull(struct sk_buff *skb, struct ieee802154_hdr *hdr)\r\n{\r\nint pos = 3, rc;\r\nif (!pskb_may_pull(skb, 3))\r\nreturn -EINVAL;\r\nmemcpy(hdr, skb->data, 3);\r\nrc = ieee802154_hdr_minlen(hdr);\r\nif (rc < 0 || !pskb_may_pull(skb, rc))\r\nreturn -EINVAL;\r\npos += ieee802154_hdr_get_addrs(skb->data + pos, hdr);\r\nif (hdr->fc.security_enabled) {\r\nint want = pos + ieee802154_hdr_sechdr_len(skb->data[pos]);\r\nif (!pskb_may_pull(skb, want))\r\nreturn -EINVAL;\r\npos += ieee802154_hdr_get_sechdr(skb->data + pos, &hdr->sec);\r\n}\r\nskb_pull(skb, pos);\r\nreturn pos;\r\n}\r\nint\r\nieee802154_hdr_peek_addrs(const struct sk_buff *skb, struct ieee802154_hdr *hdr)\r\n{\r\nconst u8 *buf = skb_mac_header(skb);\r\nint pos = 3, rc;\r\nif (buf + 3 > skb_tail_pointer(skb))\r\nreturn -EINVAL;\r\nmemcpy(hdr, buf, 3);\r\nrc = ieee802154_hdr_minlen(hdr);\r\nif (rc < 0 || buf + rc > skb_tail_pointer(skb))\r\nreturn -EINVAL;\r\npos += ieee802154_hdr_get_addrs(buf + pos, hdr);\r\nreturn pos;\r\n}\r\nint\r\nieee802154_hdr_peek(const struct sk_buff *skb, struct ieee802154_hdr *hdr)\r\n{\r\nconst u8 *buf = skb_mac_header(skb);\r\nint pos;\r\npos = ieee802154_hdr_peek_addrs(skb, hdr);\r\nif (pos < 0)\r\nreturn -EINVAL;\r\nif (hdr->fc.security_enabled) {\r\nu8 key_id_mode = IEEE802154_SCF_KEY_ID_MODE(*(buf + pos));\r\nint want = pos + ieee802154_sechdr_lengths[key_id_mode];\r\nif (buf + want > skb_tail_pointer(skb))\r\nreturn -EINVAL;\r\npos += ieee802154_hdr_get_sechdr(buf + pos, &hdr->sec);\r\n}\r\nreturn pos;\r\n}\r\nint ieee802154_max_payload(const struct ieee802154_hdr *hdr)\r\n{\r\nint hlen = ieee802154_hdr_minlen(hdr);\r\nif (hdr->fc.security_enabled) {\r\nhlen += ieee802154_sechdr_lengths[hdr->sec.key_id_mode] - 1;\r\nhlen += ieee802154_sechdr_authtag_len(&hdr->sec);\r\n}\r\nreturn IEEE802154_MTU - hlen - IEEE802154_MFR_SIZE;\r\n}

static inline int\r\nwf_mpu_status (snd_wavefront_midi_t *midi)\r\n{\r\nreturn inb (midi->mpu_status_port);\r\n}\r\nstatic inline int\r\ninput_avail (snd_wavefront_midi_t *midi)\r\n{\r\nreturn !(wf_mpu_status(midi) & INPUT_AVAIL);\r\n}\r\nstatic inline int\r\noutput_ready (snd_wavefront_midi_t *midi)\r\n{\r\nreturn !(wf_mpu_status(midi) & OUTPUT_READY);\r\n}\r\nstatic inline int\r\nread_data (snd_wavefront_midi_t *midi)\r\n{\r\nreturn inb (midi->mpu_data_port);\r\n}\r\nstatic inline void\r\nwrite_data (snd_wavefront_midi_t *midi, unsigned char byte)\r\n{\r\noutb (byte, midi->mpu_data_port);\r\n}\r\nstatic snd_wavefront_midi_t *\r\nget_wavefront_midi (struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_card *card;\r\nsnd_wavefront_card_t *acard;\r\nif (substream == NULL || substream->rmidi == NULL)\r\nreturn NULL;\r\ncard = substream->rmidi->card;\r\nif (card == NULL)\r\nreturn NULL;\r\nif (card->private_data == NULL)\r\nreturn NULL;\r\nacard = card->private_data;\r\nreturn &acard->wavefront.midi;\r\n}\r\nstatic void snd_wavefront_midi_output_write(snd_wavefront_card_t *card)\r\n{\r\nsnd_wavefront_midi_t *midi = &card->wavefront.midi;\r\nsnd_wavefront_mpu_id mpu;\r\nunsigned long flags;\r\nunsigned char midi_byte;\r\nint max = 256, mask = 1;\r\nint timeout;\r\nif (midi->substream_output[midi->output_mpu] == NULL) {\r\ngoto __second;\r\n}\r\nwhile (max > 0) {\r\nfor (timeout = 30000; timeout > 0; timeout--) {\r\nif (output_ready (midi))\r\nbreak;\r\n}\r\nspin_lock_irqsave (&midi->virtual, flags);\r\nif ((midi->mode[midi->output_mpu] & MPU401_MODE_OUTPUT) == 0) {\r\nspin_unlock_irqrestore (&midi->virtual, flags);\r\ngoto __second;\r\n}\r\nif (output_ready (midi)) {\r\nif (snd_rawmidi_transmit(midi->substream_output[midi->output_mpu], &midi_byte, 1) == 1) {\r\nif (!midi->isvirtual ||\r\n(midi_byte != WF_INTERNAL_SWITCH &&\r\nmidi_byte != WF_EXTERNAL_SWITCH))\r\nwrite_data(midi, midi_byte);\r\nmax--;\r\n} else {\r\nif (midi->istimer) {\r\nif (--midi->istimer <= 0)\r\ndel_timer(&midi->timer);\r\n}\r\nmidi->mode[midi->output_mpu] &= ~MPU401_MODE_OUTPUT_TRIGGER;\r\nspin_unlock_irqrestore (&midi->virtual, flags);\r\ngoto __second;\r\n}\r\n} else {\r\nspin_unlock_irqrestore (&midi->virtual, flags);\r\nreturn;\r\n}\r\nspin_unlock_irqrestore (&midi->virtual, flags);\r\n}\r\n__second:\r\nif (midi->substream_output[!midi->output_mpu] == NULL) {\r\nreturn;\r\n}\r\nwhile (max > 0) {\r\nfor (timeout = 30000; timeout > 0; timeout--) {\r\nif (output_ready (midi))\r\nbreak;\r\n}\r\nspin_lock_irqsave (&midi->virtual, flags);\r\nif (!midi->isvirtual)\r\nmask = 0;\r\nmpu = midi->output_mpu ^ mask;\r\nmask = 0;\r\nif ((midi->mode[mpu] & MPU401_MODE_OUTPUT) == 0) {\r\nspin_unlock_irqrestore (&midi->virtual, flags);\r\nreturn;\r\n}\r\nif (snd_rawmidi_transmit_empty(midi->substream_output[mpu]))\r\ngoto __timer;\r\nif (output_ready (midi)) {\r\nif (mpu != midi->output_mpu) {\r\nwrite_data(midi, mpu == internal_mpu ?\r\nWF_INTERNAL_SWITCH :\r\nWF_EXTERNAL_SWITCH);\r\nmidi->output_mpu = mpu;\r\n} else if (snd_rawmidi_transmit(midi->substream_output[mpu], &midi_byte, 1) == 1) {\r\nif (!midi->isvirtual ||\r\n(midi_byte != WF_INTERNAL_SWITCH &&\r\nmidi_byte != WF_EXTERNAL_SWITCH))\r\nwrite_data(midi, midi_byte);\r\nmax--;\r\n} else {\r\n__timer:\r\nif (midi->istimer) {\r\nif (--midi->istimer <= 0)\r\ndel_timer(&midi->timer);\r\n}\r\nmidi->mode[mpu] &= ~MPU401_MODE_OUTPUT_TRIGGER;\r\nspin_unlock_irqrestore (&midi->virtual, flags);\r\nreturn;\r\n}\r\n} else {\r\nspin_unlock_irqrestore (&midi->virtual, flags);\r\nreturn;\r\n}\r\nspin_unlock_irqrestore (&midi->virtual, flags);\r\n}\r\n}\r\nstatic int snd_wavefront_midi_input_open(struct snd_rawmidi_substream *substream)\r\n{\r\nunsigned long flags;\r\nsnd_wavefront_midi_t *midi;\r\nsnd_wavefront_mpu_id mpu;\r\nif (snd_BUG_ON(!substream || !substream->rmidi))\r\nreturn -ENXIO;\r\nif (snd_BUG_ON(!substream->rmidi->private_data))\r\nreturn -ENXIO;\r\nmpu = *((snd_wavefront_mpu_id *) substream->rmidi->private_data);\r\nif ((midi = get_wavefront_midi (substream)) == NULL)\r\nreturn -EIO;\r\nspin_lock_irqsave (&midi->open, flags);\r\nmidi->mode[mpu] |= MPU401_MODE_INPUT;\r\nmidi->substream_input[mpu] = substream;\r\nspin_unlock_irqrestore (&midi->open, flags);\r\nreturn 0;\r\n}\r\nstatic int snd_wavefront_midi_output_open(struct snd_rawmidi_substream *substream)\r\n{\r\nunsigned long flags;\r\nsnd_wavefront_midi_t *midi;\r\nsnd_wavefront_mpu_id mpu;\r\nif (snd_BUG_ON(!substream || !substream->rmidi))\r\nreturn -ENXIO;\r\nif (snd_BUG_ON(!substream->rmidi->private_data))\r\nreturn -ENXIO;\r\nmpu = *((snd_wavefront_mpu_id *) substream->rmidi->private_data);\r\nif ((midi = get_wavefront_midi (substream)) == NULL)\r\nreturn -EIO;\r\nspin_lock_irqsave (&midi->open, flags);\r\nmidi->mode[mpu] |= MPU401_MODE_OUTPUT;\r\nmidi->substream_output[mpu] = substream;\r\nspin_unlock_irqrestore (&midi->open, flags);\r\nreturn 0;\r\n}\r\nstatic int snd_wavefront_midi_input_close(struct snd_rawmidi_substream *substream)\r\n{\r\nunsigned long flags;\r\nsnd_wavefront_midi_t *midi;\r\nsnd_wavefront_mpu_id mpu;\r\nif (snd_BUG_ON(!substream || !substream->rmidi))\r\nreturn -ENXIO;\r\nif (snd_BUG_ON(!substream->rmidi->private_data))\r\nreturn -ENXIO;\r\nmpu = *((snd_wavefront_mpu_id *) substream->rmidi->private_data);\r\nif ((midi = get_wavefront_midi (substream)) == NULL)\r\nreturn -EIO;\r\nspin_lock_irqsave (&midi->open, flags);\r\nmidi->mode[mpu] &= ~MPU401_MODE_INPUT;\r\nspin_unlock_irqrestore (&midi->open, flags);\r\nreturn 0;\r\n}\r\nstatic int snd_wavefront_midi_output_close(struct snd_rawmidi_substream *substream)\r\n{\r\nunsigned long flags;\r\nsnd_wavefront_midi_t *midi;\r\nsnd_wavefront_mpu_id mpu;\r\nif (snd_BUG_ON(!substream || !substream->rmidi))\r\nreturn -ENXIO;\r\nif (snd_BUG_ON(!substream->rmidi->private_data))\r\nreturn -ENXIO;\r\nmpu = *((snd_wavefront_mpu_id *) substream->rmidi->private_data);\r\nif ((midi = get_wavefront_midi (substream)) == NULL)\r\nreturn -EIO;\r\nspin_lock_irqsave (&midi->open, flags);\r\nmidi->mode[mpu] &= ~MPU401_MODE_OUTPUT;\r\nspin_unlock_irqrestore (&midi->open, flags);\r\nreturn 0;\r\n}\r\nstatic void snd_wavefront_midi_input_trigger(struct snd_rawmidi_substream *substream, int up)\r\n{\r\nunsigned long flags;\r\nsnd_wavefront_midi_t *midi;\r\nsnd_wavefront_mpu_id mpu;\r\nif (substream == NULL || substream->rmidi == NULL)\r\nreturn;\r\nif (substream->rmidi->private_data == NULL)\r\nreturn;\r\nmpu = *((snd_wavefront_mpu_id *) substream->rmidi->private_data);\r\nif ((midi = get_wavefront_midi (substream)) == NULL) {\r\nreturn;\r\n}\r\nspin_lock_irqsave (&midi->virtual, flags);\r\nif (up) {\r\nmidi->mode[mpu] |= MPU401_MODE_INPUT_TRIGGER;\r\n} else {\r\nmidi->mode[mpu] &= ~MPU401_MODE_INPUT_TRIGGER;\r\n}\r\nspin_unlock_irqrestore (&midi->virtual, flags);\r\n}\r\nstatic void snd_wavefront_midi_output_timer(unsigned long data)\r\n{\r\nsnd_wavefront_card_t *card = (snd_wavefront_card_t *)data;\r\nsnd_wavefront_midi_t *midi = &card->wavefront.midi;\r\nunsigned long flags;\r\nspin_lock_irqsave (&midi->virtual, flags);\r\nmod_timer(&midi->timer, 1 + jiffies);\r\nspin_unlock_irqrestore (&midi->virtual, flags);\r\nsnd_wavefront_midi_output_write(card);\r\n}\r\nstatic void snd_wavefront_midi_output_trigger(struct snd_rawmidi_substream *substream, int up)\r\n{\r\nunsigned long flags;\r\nsnd_wavefront_midi_t *midi;\r\nsnd_wavefront_mpu_id mpu;\r\nif (substream == NULL || substream->rmidi == NULL)\r\nreturn;\r\nif (substream->rmidi->private_data == NULL)\r\nreturn;\r\nmpu = *((snd_wavefront_mpu_id *) substream->rmidi->private_data);\r\nif ((midi = get_wavefront_midi (substream)) == NULL) {\r\nreturn;\r\n}\r\nspin_lock_irqsave (&midi->virtual, flags);\r\nif (up) {\r\nif ((midi->mode[mpu] & MPU401_MODE_OUTPUT_TRIGGER) == 0) {\r\nif (!midi->istimer) {\r\nsetup_timer(&midi->timer,\r\nsnd_wavefront_midi_output_timer,\r\n(unsigned long) substream->rmidi->card->private_data);\r\nmod_timer(&midi->timer, 1 + jiffies);\r\n}\r\nmidi->istimer++;\r\nmidi->mode[mpu] |= MPU401_MODE_OUTPUT_TRIGGER;\r\n}\r\n} else {\r\nmidi->mode[mpu] &= ~MPU401_MODE_OUTPUT_TRIGGER;\r\n}\r\nspin_unlock_irqrestore (&midi->virtual, flags);\r\nif (up)\r\nsnd_wavefront_midi_output_write((snd_wavefront_card_t *)substream->rmidi->card->private_data);\r\n}\r\nvoid\r\nsnd_wavefront_midi_interrupt (snd_wavefront_card_t *card)\r\n{\r\nunsigned long flags;\r\nsnd_wavefront_midi_t *midi;\r\nstatic struct snd_rawmidi_substream *substream = NULL;\r\nstatic int mpu = external_mpu;\r\nint max = 128;\r\nunsigned char byte;\r\nmidi = &card->wavefront.midi;\r\nif (!input_avail (midi)) {\r\nsnd_wavefront_midi_output_write(card);\r\nreturn;\r\n}\r\nspin_lock_irqsave (&midi->virtual, flags);\r\nwhile (--max) {\r\nif (input_avail (midi)) {\r\nbyte = read_data (midi);\r\nif (midi->isvirtual) {\r\nif (byte == WF_EXTERNAL_SWITCH) {\r\nsubstream = midi->substream_input[external_mpu];\r\nmpu = external_mpu;\r\n} else if (byte == WF_INTERNAL_SWITCH) {\r\nsubstream = midi->substream_output[internal_mpu];\r\nmpu = internal_mpu;\r\n}\r\n} else {\r\nsubstream = midi->substream_input[internal_mpu];\r\nmpu = internal_mpu;\r\n}\r\nif (substream == NULL) {\r\ncontinue;\r\n}\r\nif (midi->mode[mpu] & MPU401_MODE_INPUT_TRIGGER) {\r\nsnd_rawmidi_receive(substream, &byte, 1);\r\n}\r\n} else {\r\nbreak;\r\n}\r\n}\r\nspin_unlock_irqrestore (&midi->virtual, flags);\r\nsnd_wavefront_midi_output_write(card);\r\n}\r\nvoid\r\nsnd_wavefront_midi_enable_virtual (snd_wavefront_card_t *card)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave (&card->wavefront.midi.virtual, flags);\r\ncard->wavefront.midi.isvirtual = 1;\r\ncard->wavefront.midi.output_mpu = internal_mpu;\r\ncard->wavefront.midi.input_mpu = internal_mpu;\r\nspin_unlock_irqrestore (&card->wavefront.midi.virtual, flags);\r\n}\r\nvoid\r\nsnd_wavefront_midi_disable_virtual (snd_wavefront_card_t *card)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave (&card->wavefront.midi.virtual, flags);\r\ncard->wavefront.midi.isvirtual = 0;\r\nspin_unlock_irqrestore (&card->wavefront.midi.virtual, flags);\r\n}\r\nint\r\nsnd_wavefront_midi_start (snd_wavefront_card_t *card)\r\n{\r\nint ok, i;\r\nunsigned char rbuf[4], wbuf[4];\r\nsnd_wavefront_t *dev;\r\nsnd_wavefront_midi_t *midi;\r\ndev = &card->wavefront;\r\nmidi = &dev->midi;\r\nfor (i = 0; i < 30000 && !output_ready (midi); i++);\r\nif (!output_ready (midi)) {\r\nsnd_printk ("MIDI interface not ready for command\n");\r\nreturn -1;\r\n}\r\ndev->interrupts_are_midi = 1;\r\noutb (UART_MODE_ON, midi->mpu_command_port);\r\nfor (ok = 0, i = 50000; i > 0 && !ok; i--) {\r\nif (input_avail (midi)) {\r\nif (read_data (midi) == MPU_ACK) {\r\nok = 1;\r\nbreak;\r\n}\r\n}\r\n}\r\nif (!ok) {\r\nsnd_printk ("cannot set UART mode for MIDI interface");\r\ndev->interrupts_are_midi = 0;\r\nreturn -1;\r\n}\r\nif (snd_wavefront_cmd (dev, WFC_MISYNTH_ON, rbuf, wbuf)) {\r\nsnd_printk ("can't enable MIDI-IN-2-synth routing.\n");\r\n}\r\nif (snd_wavefront_cmd (dev, WFC_VMIDI_OFF, rbuf, wbuf)) {\r\nsnd_printk ("virtual MIDI mode not disabled\n");\r\nreturn 0;\r\n}\r\nsnd_wavefront_midi_enable_virtual (card);\r\nif (snd_wavefront_cmd (dev, WFC_VMIDI_ON, rbuf, wbuf)) {\r\nsnd_printk ("cannot enable virtual MIDI mode.\n");\r\nsnd_wavefront_midi_disable_virtual (card);\r\n}\r\nreturn 0;\r\n}

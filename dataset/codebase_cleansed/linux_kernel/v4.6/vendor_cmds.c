static int st_nci_factory_mode(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nstruct st_nci_info *info = nci_get_drvdata(ndev);\r\nif (data_len != 1)\r\nreturn -EINVAL;\r\npr_debug("factory mode: %x\n", ((u8 *)data)[0]);\r\nswitch (((u8 *)data)[0]) {\r\ncase ST_NCI_FACTORY_MODE_ON:\r\ntest_and_set_bit(ST_NCI_FACTORY_MODE, &info->flags);\r\nbreak;\r\ncase ST_NCI_FACTORY_MODE_OFF:\r\nclear_bit(ST_NCI_FACTORY_MODE, &info->flags);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int st_nci_hci_clear_all_pipes(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nreturn nci_hci_clear_all_pipes(ndev);\r\n}\r\nstatic int st_nci_hci_dm_put_data(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nreturn nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\r\nST_NCI_HCI_DM_PUTDATA, data,\r\ndata_len, NULL);\r\n}\r\nstatic int st_nci_hci_dm_update_aid(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nreturn nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\r\nST_NCI_HCI_DM_UPDATE_AID, data, data_len, NULL);\r\n}\r\nstatic int st_nci_hci_dm_get_info(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nint r;\r\nstruct sk_buff *msg, *skb;\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nr = nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE, ST_NCI_HCI_DM_GETINFO,\r\ndata, data_len, &skb);\r\nif (r)\r\ngoto exit;\r\nmsg = nfc_vendor_cmd_alloc_reply_skb(dev, ST_NCI_VENDOR_OUI,\r\nHCI_DM_GET_INFO, skb->len);\r\nif (!msg) {\r\nr = -ENOMEM;\r\ngoto free_skb;\r\n}\r\nif (nla_put(msg, NFC_ATTR_VENDOR_DATA, skb->len, skb->data)) {\r\nkfree_skb(msg);\r\nr = -ENOBUFS;\r\ngoto free_skb;\r\n}\r\nr = nfc_vendor_cmd_reply(msg);\r\nfree_skb:\r\nkfree_skb(skb);\r\nexit:\r\nreturn r;\r\n}\r\nstatic int st_nci_hci_dm_get_data(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nint r;\r\nstruct sk_buff *msg, *skb;\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nr = nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE, ST_NCI_HCI_DM_GETDATA,\r\ndata, data_len, &skb);\r\nif (r)\r\ngoto exit;\r\nmsg = nfc_vendor_cmd_alloc_reply_skb(dev, ST_NCI_VENDOR_OUI,\r\nHCI_DM_GET_DATA, skb->len);\r\nif (!msg) {\r\nr = -ENOMEM;\r\ngoto free_skb;\r\n}\r\nif (nla_put(msg, NFC_ATTR_VENDOR_DATA, skb->len, skb->data)) {\r\nkfree_skb(msg);\r\nr = -ENOBUFS;\r\ngoto free_skb;\r\n}\r\nr = nfc_vendor_cmd_reply(msg);\r\nfree_skb:\r\nkfree_skb(skb);\r\nexit:\r\nreturn r;\r\n}\r\nstatic int st_nci_hci_dm_fwupd_start(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nint r;\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\ndev->fw_download_in_progress = true;\r\nr = nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\r\nST_NCI_HCI_DM_FWUPD_START, data, data_len, NULL);\r\nif (r)\r\ndev->fw_download_in_progress = false;\r\nreturn r;\r\n}\r\nstatic int st_nci_hci_dm_fwupd_end(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nreturn nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\r\nST_NCI_HCI_DM_FWUPD_STOP, data, data_len, NULL);\r\n}\r\nstatic int st_nci_hci_dm_direct_load(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nif (dev->fw_download_in_progress) {\r\ndev->fw_download_in_progress = false;\r\nreturn nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\r\nST_NCI_HCI_DM_LOAD, data, data_len, NULL);\r\n}\r\nreturn -EPROTO;\r\n}\r\nstatic int st_nci_hci_dm_reset(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nnci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\r\nST_NCI_HCI_DM_RESET, data, data_len, NULL);\r\nmsleep(200);\r\nreturn 0;\r\n}\r\nstatic int st_nci_hci_get_param(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nint r;\r\nstruct sk_buff *msg, *skb;\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nstruct get_param_data *param = (struct get_param_data *)data;\r\nif (data_len < sizeof(struct get_param_data))\r\nreturn -EPROTO;\r\nr = nci_hci_get_param(ndev, param->gate, param->data, &skb);\r\nif (r)\r\ngoto exit;\r\nmsg = nfc_vendor_cmd_alloc_reply_skb(dev, ST_NCI_VENDOR_OUI,\r\nHCI_GET_PARAM, skb->len);\r\nif (!msg) {\r\nr = -ENOMEM;\r\ngoto free_skb;\r\n}\r\nif (nla_put(msg, NFC_ATTR_VENDOR_DATA, skb->len, skb->data)) {\r\nkfree_skb(msg);\r\nr = -ENOBUFS;\r\ngoto free_skb;\r\n}\r\nr = nfc_vendor_cmd_reply(msg);\r\nfree_skb:\r\nkfree_skb(skb);\r\nexit:\r\nreturn r;\r\n}\r\nstatic int st_nci_hci_dm_field_generator(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nreturn nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\r\nST_NCI_HCI_DM_FIELD_GENERATOR, data, data_len, NULL);\r\n}\r\nstatic int st_nci_hci_dm_vdc_measurement_value(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nint r;\r\nstruct sk_buff *msg, *skb;\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nif (data_len != 4)\r\nreturn -EPROTO;\r\nr = nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\r\nST_NCI_HCI_DM_VDC_MEASUREMENT_VALUE,\r\ndata, data_len, &skb);\r\nif (r)\r\ngoto exit;\r\nmsg = nfc_vendor_cmd_alloc_reply_skb(dev, ST_NCI_VENDOR_OUI,\r\nHCI_DM_VDC_MEASUREMENT_VALUE, skb->len);\r\nif (!msg) {\r\nr = -ENOMEM;\r\ngoto free_skb;\r\n}\r\nif (nla_put(msg, NFC_ATTR_VENDOR_DATA, skb->len, skb->data)) {\r\nkfree_skb(msg);\r\nr = -ENOBUFS;\r\ngoto free_skb;\r\n}\r\nr = nfc_vendor_cmd_reply(msg);\r\nfree_skb:\r\nkfree_skb(skb);\r\nexit:\r\nreturn r;\r\n}\r\nstatic int st_nci_hci_dm_vdc_value_comparison(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nint r;\r\nstruct sk_buff *msg, *skb;\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nif (data_len != 2)\r\nreturn -EPROTO;\r\nr = nci_hci_send_cmd(ndev, ST_NCI_DEVICE_MGNT_GATE,\r\nST_NCI_HCI_DM_VDC_VALUE_COMPARISON,\r\ndata, data_len, &skb);\r\nif (r)\r\ngoto exit;\r\nmsg = nfc_vendor_cmd_alloc_reply_skb(dev, ST_NCI_VENDOR_OUI,\r\nHCI_DM_VDC_VALUE_COMPARISON, skb->len);\r\nif (!msg) {\r\nr = -ENOMEM;\r\ngoto free_skb;\r\n}\r\nif (nla_put(msg, NFC_ATTR_VENDOR_DATA, skb->len, skb->data)) {\r\nkfree_skb(msg);\r\nr = -ENOBUFS;\r\ngoto free_skb;\r\n}\r\nr = nfc_vendor_cmd_reply(msg);\r\nfree_skb:\r\nkfree_skb(skb);\r\nexit:\r\nreturn r;\r\n}\r\nvoid st_nci_hci_loopback_event_received(struct nci_dev *ndev, u8 event,\r\nstruct sk_buff *skb)\r\n{\r\nstruct st_nci_info *info = nci_get_drvdata(ndev);\r\nswitch (event) {\r\ncase ST_NCI_EVT_POST_DATA:\r\ninfo->vendor_info.rx_skb = skb;\r\nbreak;\r\ndefault:\r\nnfc_err(&ndev->nfc_dev->dev, "Unexpected event on loopback gate\n");\r\n}\r\ncomplete(&info->vendor_info.req_completion);\r\n}\r\nstatic int st_nci_hci_loopback(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nint r;\r\nstruct sk_buff *msg;\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nstruct st_nci_info *info = nci_get_drvdata(ndev);\r\nif (data_len <= 0)\r\nreturn -EPROTO;\r\nreinit_completion(&info->vendor_info.req_completion);\r\ninfo->vendor_info.rx_skb = NULL;\r\nr = nci_hci_send_event(ndev, NCI_HCI_LOOPBACK_GATE,\r\nST_NCI_EVT_POST_DATA, data, data_len);\r\nif (r != data_len) {\r\nr = -EPROTO;\r\ngoto exit;\r\n}\r\nwait_for_completion_interruptible(&info->vendor_info.req_completion);\r\nif (!info->vendor_info.rx_skb ||\r\ninfo->vendor_info.rx_skb->len != data_len) {\r\nr = -EPROTO;\r\ngoto exit;\r\n}\r\nmsg = nfc_vendor_cmd_alloc_reply_skb(ndev->nfc_dev,\r\nST_NCI_VENDOR_OUI,\r\nHCI_LOOPBACK,\r\ninfo->vendor_info.rx_skb->len);\r\nif (!msg) {\r\nr = -ENOMEM;\r\ngoto free_skb;\r\n}\r\nif (nla_put(msg, NFC_ATTR_VENDOR_DATA, info->vendor_info.rx_skb->len,\r\ninfo->vendor_info.rx_skb->data)) {\r\nkfree_skb(msg);\r\nr = -ENOBUFS;\r\ngoto free_skb;\r\n}\r\nr = nfc_vendor_cmd_reply(msg);\r\nfree_skb:\r\nkfree_skb(info->vendor_info.rx_skb);\r\nexit:\r\nreturn r;\r\n}\r\nstatic int st_nci_manufacturer_specific(struct nfc_dev *dev, void *data,\r\nsize_t data_len)\r\n{\r\nstruct sk_buff *msg;\r\nstruct nci_dev *ndev = nfc_get_drvdata(dev);\r\nmsg = nfc_vendor_cmd_alloc_reply_skb(dev, ST_NCI_VENDOR_OUI,\r\nMANUFACTURER_SPECIFIC,\r\nsizeof(ndev->manufact_specific_info));\r\nif (!msg)\r\nreturn -ENOMEM;\r\nif (nla_put(msg, NFC_ATTR_VENDOR_DATA, sizeof(ndev->manufact_specific_info),\r\n&ndev->manufact_specific_info)) {\r\nkfree_skb(msg);\r\nreturn -ENOBUFS;\r\n}\r\nreturn nfc_vendor_cmd_reply(msg);\r\n}\r\nint st_nci_vendor_cmds_init(struct nci_dev *ndev)\r\n{\r\nstruct st_nci_info *info = nci_get_drvdata(ndev);\r\ninit_completion(&info->vendor_info.req_completion);\r\nreturn nfc_set_vendor_cmds(ndev->nfc_dev, st_nci_vendor_cmds,\r\nsizeof(st_nci_vendor_cmds));\r\n}

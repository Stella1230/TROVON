static int as3722_check_device_id(struct as3722 *as3722)\r\n{\r\nu32 val;\r\nint ret;\r\nret = as3722_read(as3722, AS3722_ASIC_ID1_REG, &val);\r\nif (ret < 0) {\r\ndev_err(as3722->dev, "ASIC_ID1 read failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (val != AS3722_DEVICE_ID) {\r\ndev_err(as3722->dev, "Device is not AS3722, ID is 0x%x\n", val);\r\nreturn -ENODEV;\r\n}\r\nret = as3722_read(as3722, AS3722_ASIC_ID2_REG, &val);\r\nif (ret < 0) {\r\ndev_err(as3722->dev, "ASIC_ID2 read failed: %d\n", ret);\r\nreturn ret;\r\n}\r\ndev_info(as3722->dev, "AS3722 with revision 0x%x found\n", val);\r\nreturn 0;\r\n}\r\nstatic int as3722_configure_pullups(struct as3722 *as3722)\r\n{\r\nint ret;\r\nu32 val = 0;\r\nif (as3722->en_intern_int_pullup)\r\nval |= AS3722_INT_PULL_UP;\r\nif (as3722->en_intern_i2c_pullup)\r\nval |= AS3722_I2C_PULL_UP;\r\nret = as3722_update_bits(as3722, AS3722_IOVOLTAGE_REG,\r\nAS3722_INT_PULL_UP | AS3722_I2C_PULL_UP, val);\r\nif (ret < 0)\r\ndev_err(as3722->dev, "IOVOLTAGE_REG update failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int as3722_i2c_of_probe(struct i2c_client *i2c,\r\nstruct as3722 *as3722)\r\n{\r\nstruct device_node *np = i2c->dev.of_node;\r\nstruct irq_data *irq_data;\r\nif (!np) {\r\ndev_err(&i2c->dev, "Device Tree not found\n");\r\nreturn -EINVAL;\r\n}\r\nirq_data = irq_get_irq_data(i2c->irq);\r\nif (!irq_data) {\r\ndev_err(&i2c->dev, "Invalid IRQ: %d\n", i2c->irq);\r\nreturn -EINVAL;\r\n}\r\nas3722->en_intern_int_pullup = of_property_read_bool(np,\r\n"ams,enable-internal-int-pullup");\r\nas3722->en_intern_i2c_pullup = of_property_read_bool(np,\r\n"ams,enable-internal-i2c-pullup");\r\nas3722->irq_flags = irqd_get_trigger_type(irq_data);\r\ndev_dbg(&i2c->dev, "IRQ flags are 0x%08lx\n", as3722->irq_flags);\r\nreturn 0;\r\n}\r\nstatic int as3722_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct as3722 *as3722;\r\nunsigned long irq_flags;\r\nint ret;\r\nas3722 = devm_kzalloc(&i2c->dev, sizeof(struct as3722), GFP_KERNEL);\r\nif (!as3722)\r\nreturn -ENOMEM;\r\nas3722->dev = &i2c->dev;\r\nas3722->chip_irq = i2c->irq;\r\ni2c_set_clientdata(i2c, as3722);\r\nret = as3722_i2c_of_probe(i2c, as3722);\r\nif (ret < 0)\r\nreturn ret;\r\nas3722->regmap = devm_regmap_init_i2c(i2c, &as3722_regmap_config);\r\nif (IS_ERR(as3722->regmap)) {\r\nret = PTR_ERR(as3722->regmap);\r\ndev_err(&i2c->dev, "regmap init failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = as3722_check_device_id(as3722);\r\nif (ret < 0)\r\nreturn ret;\r\nirq_flags = as3722->irq_flags | IRQF_ONESHOT;\r\nret = regmap_add_irq_chip(as3722->regmap, as3722->chip_irq,\r\nirq_flags, -1, &as3722_irq_chip,\r\n&as3722->irq_data);\r\nif (ret < 0) {\r\ndev_err(as3722->dev, "Failed to add regmap irq: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = as3722_configure_pullups(as3722);\r\nif (ret < 0)\r\ngoto scrub;\r\nret = mfd_add_devices(&i2c->dev, -1, as3722_devs,\r\nARRAY_SIZE(as3722_devs), NULL, 0,\r\nregmap_irq_get_domain(as3722->irq_data));\r\nif (ret) {\r\ndev_err(as3722->dev, "Failed to add MFD devices: %d\n", ret);\r\ngoto scrub;\r\n}\r\ndevice_init_wakeup(as3722->dev, true);\r\ndev_dbg(as3722->dev, "AS3722 core driver initialized successfully\n");\r\nreturn 0;\r\nscrub:\r\nregmap_del_irq_chip(as3722->chip_irq, as3722->irq_data);\r\nreturn ret;\r\n}\r\nstatic int as3722_i2c_remove(struct i2c_client *i2c)\r\n{\r\nstruct as3722 *as3722 = i2c_get_clientdata(i2c);\r\nmfd_remove_devices(as3722->dev);\r\nregmap_del_irq_chip(as3722->chip_irq, as3722->irq_data);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused as3722_i2c_suspend(struct device *dev)\r\n{\r\nstruct as3722 *as3722 = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(as3722->chip_irq);\r\ndisable_irq(as3722->chip_irq);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused as3722_i2c_resume(struct device *dev)\r\n{\r\nstruct as3722 *as3722 = dev_get_drvdata(dev);\r\nenable_irq(as3722->chip_irq);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(as3722->chip_irq);\r\nreturn 0;\r\n}

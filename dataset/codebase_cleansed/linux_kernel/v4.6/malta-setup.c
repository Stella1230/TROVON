const char *get_system_type(void)\r\n{\r\nreturn "MIPS Malta";\r\n}\r\nstatic void __init fd_activate(void)\r\n{\r\nSMSC_WRITE(SMSC_CONFIG_ENTER, SMSC_CONFIG_REG);\r\nSMSC_WRITE(SMSC_CONFIG_DEVNUM, SMSC_CONFIG_REG);\r\nSMSC_WRITE(SMSC_CONFIG_DEVNUM_FLOPPY, SMSC_DATA_REG);\r\nSMSC_WRITE(SMSC_CONFIG_ACTIVATE, SMSC_CONFIG_REG);\r\nSMSC_WRITE(SMSC_CONFIG_ACTIVATE_ENABLE, SMSC_DATA_REG);\r\nSMSC_WRITE(SMSC_CONFIG_EXIT, SMSC_CONFIG_REG);\r\n}\r\nstatic int __init plat_enable_iocoherency(void)\r\n{\r\nint supported = 0;\r\nif (mips_revision_sconid == MIPS_REVISION_SCON_BONITO) {\r\nif (BONITO_PCICACHECTRL & BONITO_PCICACHECTRL_CPUCOH_PRES) {\r\nBONITO_PCICACHECTRL |= BONITO_PCICACHECTRL_CPUCOH_EN;\r\npr_info("Enabled Bonito CPU coherency\n");\r\nsupported = 1;\r\n}\r\nif (strstr(fw_getcmdline(), "iobcuncached")) {\r\nBONITO_PCICACHECTRL &= ~BONITO_PCICACHECTRL_IOBCCOH_EN;\r\nBONITO_PCIMEMBASECFG = BONITO_PCIMEMBASECFG &\r\n~(BONITO_PCIMEMBASECFG_MEMBASE0_CACHED |\r\nBONITO_PCIMEMBASECFG_MEMBASE1_CACHED);\r\npr_info("Disabled Bonito IOBC coherency\n");\r\n} else {\r\nBONITO_PCICACHECTRL |= BONITO_PCICACHECTRL_IOBCCOH_EN;\r\nBONITO_PCIMEMBASECFG |=\r\n(BONITO_PCIMEMBASECFG_MEMBASE0_CACHED |\r\nBONITO_PCIMEMBASECFG_MEMBASE1_CACHED);\r\npr_info("Enabled Bonito IOBC coherency\n");\r\n}\r\n} else if (mips_cm_numiocu() != 0) {\r\npr_info("CMP IOCU detected\n");\r\nif ((*(unsigned int *)0xbf403000 & 0x81) != 0x81) {\r\npr_crit("IOCU OPERATION DISABLED BY SWITCH - DEFAULTING TO SW IO COHERENCY\n");\r\nreturn 0;\r\n}\r\nsupported = 1;\r\n}\r\nhw_coherentio = supported;\r\nreturn supported;\r\n}\r\nstatic void __init plat_setup_iocoherency(void)\r\n{\r\n#ifdef CONFIG_DMA_NONCOHERENT\r\nif (plat_enable_iocoherency()) {\r\nif (coherentio == 0)\r\npr_info("Hardware DMA cache coherency disabled\n");\r\nelse\r\npr_info("Hardware DMA cache coherency enabled\n");\r\n} else {\r\nif (coherentio == 1)\r\npr_info("Hardware DMA cache coherency unsupported, but enabled from command line!\n");\r\nelse\r\npr_info("Software DMA cache coherency enabled\n");\r\n}\r\n#else\r\nif (!plat_enable_iocoherency())\r\npanic("Hardware DMA cache coherency not supported!");\r\n#endif\r\n}\r\nstatic void __init pci_clock_check(void)\r\n{\r\nunsigned int __iomem *jmpr_p =\r\n(unsigned int *) ioremap(MALTA_JMPRS_REG, sizeof(unsigned int));\r\nint jmpr = (__raw_readl(jmpr_p) >> 2) & 0x07;\r\nstatic const int pciclocks[] __initconst = {\r\n33, 20, 25, 30, 12, 16, 37, 10\r\n};\r\nint pciclock = pciclocks[jmpr];\r\nchar *optptr, *argptr = fw_getcmdline();\r\noptptr = strstr(argptr, "pci_clock=");\r\nif (optptr && (optptr == argptr || optptr[-1] == ' '))\r\nreturn;\r\nif (pciclock != 33) {\r\npr_warn("WARNING: PCI clock is %dMHz, setting pci_clock\n",\r\npciclock);\r\nargptr += strlen(argptr);\r\nsprintf(argptr, " pci_clock=%d", pciclock);\r\nif (pciclock < 20 || pciclock > 66)\r\npr_warn("WARNING: IDE timing calculations will be "\r\n"incorrect\n");\r\n}\r\n}\r\nstatic void __init screen_info_setup(void)\r\n{\r\nscreen_info = (struct screen_info) {\r\n.orig_x = 0,\r\n.orig_y = 25,\r\n.ext_mem_k = 0,\r\n.orig_video_page = 0,\r\n.orig_video_mode = 0,\r\n.orig_video_cols = 80,\r\n.unused2 = 0,\r\n.orig_video_ega_bx = 0,\r\n.unused3 = 0,\r\n.orig_video_lines = 25,\r\n.orig_video_isVGA = VIDEO_TYPE_VGAC,\r\n.orig_video_points = 16\r\n};\r\n}\r\nstatic void __init bonito_quirks_setup(void)\r\n{\r\nchar *argptr;\r\nargptr = fw_getcmdline();\r\nif (strstr(argptr, "debug")) {\r\nBONITO_BONGENCFG |= BONITO_BONGENCFG_DEBUGMODE;\r\npr_info("Enabled Bonito debug mode\n");\r\n} else\r\nBONITO_BONGENCFG &= ~BONITO_BONGENCFG_DEBUGMODE;\r\n#ifdef CONFIG_DMA_COHERENT\r\nif (BONITO_PCICACHECTRL & BONITO_PCICACHECTRL_CPUCOH_PRES) {\r\nBONITO_PCICACHECTRL |= BONITO_PCICACHECTRL_CPUCOH_EN;\r\npr_info("Enabled Bonito CPU coherency\n");\r\nargptr = fw_getcmdline();\r\nif (strstr(argptr, "iobcuncached")) {\r\nBONITO_PCICACHECTRL &= ~BONITO_PCICACHECTRL_IOBCCOH_EN;\r\nBONITO_PCIMEMBASECFG = BONITO_PCIMEMBASECFG &\r\n~(BONITO_PCIMEMBASECFG_MEMBASE0_CACHED |\r\nBONITO_PCIMEMBASECFG_MEMBASE1_CACHED);\r\npr_info("Disabled Bonito IOBC coherency\n");\r\n} else {\r\nBONITO_PCICACHECTRL |= BONITO_PCICACHECTRL_IOBCCOH_EN;\r\nBONITO_PCIMEMBASECFG |=\r\n(BONITO_PCIMEMBASECFG_MEMBASE0_CACHED |\r\nBONITO_PCIMEMBASECFG_MEMBASE1_CACHED);\r\npr_info("Enabled Bonito IOBC coherency\n");\r\n}\r\n} else\r\npanic("Hardware DMA cache coherency not supported");\r\n#endif\r\n}\r\nvoid __init plat_mem_setup(void)\r\n{\r\nunsigned int i;\r\nvoid *fdt = __dtb_start;\r\nfdt = malta_dt_shim(fdt);\r\n__dt_setup_arch(fdt);\r\nif (config_enabled(CONFIG_EVA))\r\npr_info("Enhanced Virtual Addressing (EVA) activated\n");\r\nmips_pcibios_init();\r\nfor (i = 0; i < ARRAY_SIZE(standard_io_resources); i++)\r\nrequest_resource(&ioport_resource, standard_io_resources+i);\r\nenable_dma(4);\r\n#ifdef CONFIG_DMA_COHERENT\r\nif (mips_revision_sconid != MIPS_REVISION_SCON_BONITO)\r\npanic("Hardware DMA cache coherency not supported");\r\n#endif\r\nif (mips_revision_sconid == MIPS_REVISION_SCON_BONITO)\r\nbonito_quirks_setup();\r\nplat_setup_iocoherency();\r\npci_clock_check();\r\n#ifdef CONFIG_BLK_DEV_FD\r\nfd_activate();\r\n#endif\r\n#if defined(CONFIG_VT) && defined(CONFIG_VGA_CONSOLE)\r\nscreen_info_setup();\r\n#endif\r\nboard_be_init = malta_be_init;\r\nboard_be_handler = malta_be_handler;\r\n}

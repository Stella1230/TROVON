int bcm_phy_write_exp(struct phy_device *phydev, u16 reg, u16 val)\r\n{\r\nint rc;\r\nrc = phy_write(phydev, MII_BCM54XX_EXP_SEL, reg);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn phy_write(phydev, MII_BCM54XX_EXP_DATA, val);\r\n}\r\nint bcm_phy_read_exp(struct phy_device *phydev, u16 reg)\r\n{\r\nint val;\r\nval = phy_write(phydev, MII_BCM54XX_EXP_SEL, reg);\r\nif (val < 0)\r\nreturn val;\r\nval = phy_read(phydev, MII_BCM54XX_EXP_DATA);\r\nphy_write(phydev, MII_BCM54XX_EXP_SEL, 0);\r\nreturn val;\r\n}\r\nint bcm_phy_write_misc(struct phy_device *phydev,\r\nu16 reg, u16 chl, u16 val)\r\n{\r\nint rc;\r\nint tmp;\r\nrc = phy_write(phydev, MII_BCM54XX_AUX_CTL,\r\nMII_BCM54XX_AUXCTL_SHDWSEL_MISC);\r\nif (rc < 0)\r\nreturn rc;\r\ntmp = phy_read(phydev, MII_BCM54XX_AUX_CTL);\r\ntmp |= MII_BCM54XX_AUXCTL_ACTL_SMDSP_ENA;\r\nrc = phy_write(phydev, MII_BCM54XX_AUX_CTL, tmp);\r\nif (rc < 0)\r\nreturn rc;\r\ntmp = (chl * MII_BCM_CHANNEL_WIDTH) | reg;\r\nrc = bcm_phy_write_exp(phydev, tmp, val);\r\nreturn rc;\r\n}\r\nint bcm_phy_read_misc(struct phy_device *phydev,\r\nu16 reg, u16 chl)\r\n{\r\nint rc;\r\nint tmp;\r\nrc = phy_write(phydev, MII_BCM54XX_AUX_CTL,\r\nMII_BCM54XX_AUXCTL_SHDWSEL_MISC);\r\nif (rc < 0)\r\nreturn rc;\r\ntmp = phy_read(phydev, MII_BCM54XX_AUX_CTL);\r\ntmp |= MII_BCM54XX_AUXCTL_ACTL_SMDSP_ENA;\r\nrc = phy_write(phydev, MII_BCM54XX_AUX_CTL, tmp);\r\nif (rc < 0)\r\nreturn rc;\r\ntmp = (chl * MII_BCM_CHANNEL_WIDTH) | reg;\r\nrc = bcm_phy_read_exp(phydev, tmp);\r\nreturn rc;\r\n}\r\nint bcm_phy_ack_intr(struct phy_device *phydev)\r\n{\r\nint reg;\r\nreg = phy_read(phydev, MII_BCM54XX_ISR);\r\nif (reg < 0)\r\nreturn reg;\r\nreturn 0;\r\n}\r\nint bcm_phy_config_intr(struct phy_device *phydev)\r\n{\r\nint reg;\r\nreg = phy_read(phydev, MII_BCM54XX_ECR);\r\nif (reg < 0)\r\nreturn reg;\r\nif (phydev->interrupts == PHY_INTERRUPT_ENABLED)\r\nreg &= ~MII_BCM54XX_ECR_IM;\r\nelse\r\nreg |= MII_BCM54XX_ECR_IM;\r\nreturn phy_write(phydev, MII_BCM54XX_ECR, reg);\r\n}\r\nint bcm_phy_read_shadow(struct phy_device *phydev, u16 shadow)\r\n{\r\nphy_write(phydev, MII_BCM54XX_SHD, MII_BCM54XX_SHD_VAL(shadow));\r\nreturn MII_BCM54XX_SHD_DATA(phy_read(phydev, MII_BCM54XX_SHD));\r\n}\r\nint bcm_phy_write_shadow(struct phy_device *phydev, u16 shadow,\r\nu16 val)\r\n{\r\nreturn phy_write(phydev, MII_BCM54XX_SHD,\r\nMII_BCM54XX_SHD_WRITE |\r\nMII_BCM54XX_SHD_VAL(shadow) |\r\nMII_BCM54XX_SHD_DATA(val));\r\n}\r\nint bcm_phy_enable_apd(struct phy_device *phydev, bool dll_pwr_down)\r\n{\r\nint val;\r\nif (dll_pwr_down) {\r\nval = bcm_phy_read_shadow(phydev, BCM54XX_SHD_SCR3);\r\nif (val < 0)\r\nreturn val;\r\nval |= BCM54XX_SHD_SCR3_DLLAPD_DIS;\r\nbcm_phy_write_shadow(phydev, BCM54XX_SHD_SCR3, val);\r\n}\r\nval = bcm_phy_read_shadow(phydev, BCM54XX_SHD_APD);\r\nif (val < 0)\r\nreturn val;\r\nval &= BCM_APD_CLR_MASK;\r\nif (phydev->autoneg == AUTONEG_ENABLE)\r\nval |= BCM54XX_SHD_APD_EN;\r\nelse\r\nval |= BCM_NO_ANEG_APD_EN;\r\nval |= BCM_APD_SINGLELP_EN;\r\nreturn bcm_phy_write_shadow(phydev, BCM54XX_SHD_APD, val);\r\n}\r\nint bcm_phy_enable_eee(struct phy_device *phydev)\r\n{\r\nint val;\r\nval = phy_read_mmd_indirect(phydev, BRCM_CL45VEN_EEE_CONTROL,\r\nMDIO_MMD_AN);\r\nif (val < 0)\r\nreturn val;\r\nval |= LPI_FEATURE_EN | LPI_FEATURE_EN_DIG1000X;\r\nphy_write_mmd_indirect(phydev, BRCM_CL45VEN_EEE_CONTROL,\r\nMDIO_MMD_AN, (u32)val);\r\nval = phy_read_mmd_indirect(phydev, BCM_CL45VEN_EEE_ADV,\r\nMDIO_MMD_AN);\r\nif (val < 0)\r\nreturn val;\r\nval |= (MDIO_AN_EEE_ADV_100TX | MDIO_AN_EEE_ADV_1000T);\r\nphy_write_mmd_indirect(phydev, BCM_CL45VEN_EEE_ADV,\r\nMDIO_MMD_AN, (u32)val);\r\nreturn 0;\r\n}

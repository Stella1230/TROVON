static void set_fan_speeds(struct bbc_fan_control *fp)\r\n{\r\nif (fp->cpu_fan_speed < FAN_SPEED_MIN)\r\nfp->cpu_fan_speed = FAN_SPEED_MIN;\r\nif (fp->cpu_fan_speed > FAN_SPEED_MAX)\r\nfp->cpu_fan_speed = FAN_SPEED_MAX;\r\nif (fp->system_fan_speed < FAN_SPEED_MIN)\r\nfp->system_fan_speed = FAN_SPEED_MIN;\r\nif (fp->system_fan_speed > FAN_SPEED_MAX)\r\nfp->system_fan_speed = FAN_SPEED_MAX;\r\n#ifdef ENVCTRL_TRACE\r\nprintk("fan%d: Changed fan speed to cpu(%02x) sys(%02x)\n",\r\nfp->index,\r\nfp->cpu_fan_speed, fp->system_fan_speed);\r\n#endif\r\nbbc_i2c_writeb(fp->client, fp->cpu_fan_speed, CPU_FAN_REG);\r\nbbc_i2c_writeb(fp->client, fp->system_fan_speed, SYS_FAN_REG);\r\nbbc_i2c_writeb(fp->client,\r\n(fp->psupply_fan_on ?\r\nPSUPPLY_FAN_ON : PSUPPLY_FAN_OFF),\r\nPSUPPLY_FAN_REG);\r\n}\r\nstatic void get_current_temps(struct bbc_cpu_temperature *tp)\r\n{\r\ntp->prev_amb_temp = tp->curr_amb_temp;\r\nbbc_i2c_readb(tp->client,\r\n(unsigned char *) &tp->curr_amb_temp,\r\nMAX1617_AMB_TEMP);\r\ntp->prev_cpu_temp = tp->curr_cpu_temp;\r\nbbc_i2c_readb(tp->client,\r\n(unsigned char *) &tp->curr_cpu_temp,\r\nMAX1617_CPU_TEMP);\r\n#ifdef ENVCTRL_TRACE\r\nprintk("temp%d: cpu(%d C) amb(%d C)\n",\r\ntp->index,\r\n(int) tp->curr_cpu_temp, (int) tp->curr_amb_temp);\r\n#endif\r\n}\r\nstatic void do_envctrl_shutdown(struct bbc_cpu_temperature *tp)\r\n{\r\nstatic int shutting_down = 0;\r\nchar *type = "???";\r\ns8 val = -1;\r\nif (shutting_down != 0)\r\nreturn;\r\nif (tp->curr_amb_temp >= amb_temp_limits[tp->index].high_shutdown ||\r\ntp->curr_amb_temp < amb_temp_limits[tp->index].low_shutdown) {\r\ntype = "ambient";\r\nval = tp->curr_amb_temp;\r\n} else if (tp->curr_cpu_temp >= cpu_temp_limits[tp->index].high_shutdown ||\r\ntp->curr_cpu_temp < cpu_temp_limits[tp->index].low_shutdown) {\r\ntype = "CPU";\r\nval = tp->curr_cpu_temp;\r\n}\r\nprintk(KERN_CRIT "temp%d: Outside of safe %s "\r\n"operating temperature, %d C.\n",\r\ntp->index, type, val);\r\nprintk(KERN_CRIT "kenvctrld: Shutting down the system now.\n");\r\nshutting_down = 1;\r\norderly_poweroff(true);\r\n}\r\nstatic void analyze_ambient_temp(struct bbc_cpu_temperature *tp, unsigned long *last_warn, int tick)\r\n{\r\nint ret = 0;\r\nif (time_after(jiffies, (*last_warn + WARN_INTERVAL))) {\r\nif (tp->curr_amb_temp >=\r\namb_temp_limits[tp->index].high_warn) {\r\nprintk(KERN_WARNING "temp%d: "\r\n"Above safe ambient operating temperature, %d C.\n",\r\ntp->index, (int) tp->curr_amb_temp);\r\nret = 1;\r\n} else if (tp->curr_amb_temp <\r\namb_temp_limits[tp->index].low_warn) {\r\nprintk(KERN_WARNING "temp%d: "\r\n"Below safe ambient operating temperature, %d C.\n",\r\ntp->index, (int) tp->curr_amb_temp);\r\nret = 1;\r\n}\r\nif (ret)\r\n*last_warn = jiffies;\r\n} else if (tp->curr_amb_temp >= amb_temp_limits[tp->index].high_warn ||\r\ntp->curr_amb_temp < amb_temp_limits[tp->index].low_warn)\r\nret = 1;\r\nif (tp->curr_amb_temp >= amb_temp_limits[tp->index].high_shutdown ||\r\ntp->curr_amb_temp < amb_temp_limits[tp->index].low_shutdown) {\r\ndo_envctrl_shutdown(tp);\r\nret = 1;\r\n}\r\nif (ret) {\r\ntp->fan_todo[FAN_AMBIENT] = FAN_FULLBLAST;\r\n} else if ((tick & (8 - 1)) == 0) {\r\ns8 amb_goal_hi = amb_temp_limits[tp->index].high_warn - 10;\r\ns8 amb_goal_lo;\r\namb_goal_lo = amb_goal_hi - 3;\r\nif (tp->avg_amb_temp < amb_goal_hi) {\r\nif (tp->avg_amb_temp >= amb_goal_lo)\r\ntp->fan_todo[FAN_AMBIENT] = FAN_SAME;\r\nelse\r\ntp->fan_todo[FAN_AMBIENT] = FAN_SLOWER;\r\n} else {\r\ntp->fan_todo[FAN_AMBIENT] = FAN_FASTER;\r\n}\r\n} else {\r\ntp->fan_todo[FAN_AMBIENT] = FAN_SAME;\r\n}\r\n}\r\nstatic void analyze_cpu_temp(struct bbc_cpu_temperature *tp, unsigned long *last_warn, int tick)\r\n{\r\nint ret = 0;\r\nif (time_after(jiffies, (*last_warn + WARN_INTERVAL))) {\r\nif (tp->curr_cpu_temp >=\r\ncpu_temp_limits[tp->index].high_warn) {\r\nprintk(KERN_WARNING "temp%d: "\r\n"Above safe CPU operating temperature, %d C.\n",\r\ntp->index, (int) tp->curr_cpu_temp);\r\nret = 1;\r\n} else if (tp->curr_cpu_temp <\r\ncpu_temp_limits[tp->index].low_warn) {\r\nprintk(KERN_WARNING "temp%d: "\r\n"Below safe CPU operating temperature, %d C.\n",\r\ntp->index, (int) tp->curr_cpu_temp);\r\nret = 1;\r\n}\r\nif (ret)\r\n*last_warn = jiffies;\r\n} else if (tp->curr_cpu_temp >= cpu_temp_limits[tp->index].high_warn ||\r\ntp->curr_cpu_temp < cpu_temp_limits[tp->index].low_warn)\r\nret = 1;\r\nif (tp->curr_cpu_temp >= cpu_temp_limits[tp->index].high_shutdown ||\r\ntp->curr_cpu_temp < cpu_temp_limits[tp->index].low_shutdown) {\r\ndo_envctrl_shutdown(tp);\r\nret = 1;\r\n}\r\nif (ret) {\r\ntp->fan_todo[FAN_CPU] = FAN_FULLBLAST;\r\n} else if ((tick & (8 - 1)) == 0) {\r\ns8 cpu_goal_hi = cpu_temp_limits[tp->index].high_warn - 10;\r\ns8 cpu_goal_lo;\r\ncpu_goal_lo = cpu_goal_hi - 3;\r\nif (tp->avg_cpu_temp < cpu_goal_hi) {\r\nif (tp->avg_cpu_temp >= cpu_goal_lo)\r\ntp->fan_todo[FAN_CPU] = FAN_SAME;\r\nelse\r\ntp->fan_todo[FAN_CPU] = FAN_SLOWER;\r\n} else {\r\ntp->fan_todo[FAN_CPU] = FAN_FASTER;\r\n}\r\n} else {\r\ntp->fan_todo[FAN_CPU] = FAN_SAME;\r\n}\r\n}\r\nstatic void analyze_temps(struct bbc_cpu_temperature *tp, unsigned long *last_warn)\r\n{\r\ntp->avg_amb_temp = (s8)((int)((int)tp->avg_amb_temp + (int)tp->curr_amb_temp) / 2);\r\ntp->avg_cpu_temp = (s8)((int)((int)tp->avg_cpu_temp + (int)tp->curr_cpu_temp) / 2);\r\nanalyze_ambient_temp(tp, last_warn, tp->sample_tick);\r\nanalyze_cpu_temp(tp, last_warn, tp->sample_tick);\r\ntp->sample_tick++;\r\n}\r\nstatic enum fan_action prioritize_fan_action(int which_fan)\r\n{\r\nstruct bbc_cpu_temperature *tp;\r\nenum fan_action decision = FAN_STATE_MAX;\r\nlist_for_each_entry(tp, &all_temps, glob_list) {\r\nif (tp->fan_todo[which_fan] == FAN_FULLBLAST) {\r\ndecision = FAN_FULLBLAST;\r\nbreak;\r\n}\r\nif (tp->fan_todo[which_fan] == FAN_SAME &&\r\ndecision != FAN_FASTER)\r\ndecision = FAN_SAME;\r\nelse if (tp->fan_todo[which_fan] == FAN_FASTER)\r\ndecision = FAN_FASTER;\r\nelse if (decision != FAN_FASTER &&\r\ndecision != FAN_SAME &&\r\ntp->fan_todo[which_fan] == FAN_SLOWER)\r\ndecision = FAN_SLOWER;\r\n}\r\nif (decision == FAN_STATE_MAX)\r\ndecision = FAN_SAME;\r\nreturn decision;\r\n}\r\nstatic int maybe_new_ambient_fan_speed(struct bbc_fan_control *fp)\r\n{\r\nenum fan_action decision = prioritize_fan_action(FAN_AMBIENT);\r\nint ret;\r\nif (decision == FAN_SAME)\r\nreturn 0;\r\nret = 1;\r\nif (decision == FAN_FULLBLAST) {\r\nif (fp->system_fan_speed >= FAN_SPEED_MAX)\r\nret = 0;\r\nelse\r\nfp->system_fan_speed = FAN_SPEED_MAX;\r\n} else {\r\nif (decision == FAN_FASTER) {\r\nif (fp->system_fan_speed >= FAN_SPEED_MAX)\r\nret = 0;\r\nelse\r\nfp->system_fan_speed += 2;\r\n} else {\r\nint orig_speed = fp->system_fan_speed;\r\nif (orig_speed <= FAN_SPEED_MIN ||\r\norig_speed <= (fp->cpu_fan_speed - 3))\r\nret = 0;\r\nelse\r\nfp->system_fan_speed -= 1;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int maybe_new_cpu_fan_speed(struct bbc_fan_control *fp)\r\n{\r\nenum fan_action decision = prioritize_fan_action(FAN_CPU);\r\nint ret;\r\nif (decision == FAN_SAME)\r\nreturn 0;\r\nret = 1;\r\nif (decision == FAN_FULLBLAST) {\r\nif (fp->cpu_fan_speed >= FAN_SPEED_MAX)\r\nret = 0;\r\nelse\r\nfp->cpu_fan_speed = FAN_SPEED_MAX;\r\n} else {\r\nif (decision == FAN_FASTER) {\r\nif (fp->cpu_fan_speed >= FAN_SPEED_MAX)\r\nret = 0;\r\nelse {\r\nfp->cpu_fan_speed += 2;\r\nif (fp->system_fan_speed <\r\n(fp->cpu_fan_speed - 3))\r\nfp->system_fan_speed =\r\nfp->cpu_fan_speed - 3;\r\n}\r\n} else {\r\nif (fp->cpu_fan_speed <= FAN_SPEED_MIN)\r\nret = 0;\r\nelse\r\nfp->cpu_fan_speed -= 1;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic void maybe_new_fan_speeds(struct bbc_fan_control *fp)\r\n{\r\nint new;\r\nnew = maybe_new_ambient_fan_speed(fp);\r\nnew |= maybe_new_cpu_fan_speed(fp);\r\nif (new)\r\nset_fan_speeds(fp);\r\n}\r\nstatic void fans_full_blast(void)\r\n{\r\nstruct bbc_fan_control *fp;\r\nlist_for_each_entry(fp, &all_fans, glob_list) {\r\nfp->cpu_fan_speed = FAN_SPEED_MAX;\r\nfp->system_fan_speed = FAN_SPEED_MAX;\r\nfp->psupply_fan_on = 1;\r\nset_fan_speeds(fp);\r\n}\r\n}\r\nstatic int kenvctrld(void *__unused)\r\n{\r\nprintk(KERN_INFO "bbc_envctrl: kenvctrld starting...\n");\r\nlast_warning_jiffies = jiffies - WARN_INTERVAL;\r\nfor (;;) {\r\nstruct bbc_cpu_temperature *tp;\r\nstruct bbc_fan_control *fp;\r\nmsleep_interruptible(POLL_INTERVAL);\r\nif (kthread_should_stop())\r\nbreak;\r\nlist_for_each_entry(tp, &all_temps, glob_list) {\r\nget_current_temps(tp);\r\nanalyze_temps(tp, &last_warning_jiffies);\r\n}\r\nlist_for_each_entry(fp, &all_fans, glob_list)\r\nmaybe_new_fan_speeds(fp);\r\n}\r\nprintk(KERN_INFO "bbc_envctrl: kenvctrld exiting...\n");\r\nfans_full_blast();\r\nreturn 0;\r\n}\r\nstatic void attach_one_temp(struct bbc_i2c_bus *bp, struct platform_device *op,\r\nint temp_idx)\r\n{\r\nstruct bbc_cpu_temperature *tp;\r\ntp = kzalloc(sizeof(*tp), GFP_KERNEL);\r\nif (!tp)\r\nreturn;\r\nINIT_LIST_HEAD(&tp->bp_list);\r\nINIT_LIST_HEAD(&tp->glob_list);\r\ntp->client = bbc_i2c_attach(bp, op);\r\nif (!tp->client) {\r\nkfree(tp);\r\nreturn;\r\n}\r\ntp->index = temp_idx;\r\nlist_add(&tp->glob_list, &all_temps);\r\nlist_add(&tp->bp_list, &bp->temps);\r\nbbc_i2c_writeb(tp->client, 0x00, MAX1617_WR_CFG_BYTE);\r\nbbc_i2c_writeb(tp->client, 0x02, MAX1617_WR_CVRATE_BYTE);\r\nbbc_i2c_writeb(tp->client, amb_temp_limits[tp->index].high_pwroff,\r\nMAX1617_WR_AMB_HIGHLIM);\r\nbbc_i2c_writeb(tp->client, amb_temp_limits[tp->index].low_pwroff,\r\nMAX1617_WR_AMB_LOWLIM);\r\nbbc_i2c_writeb(tp->client, cpu_temp_limits[tp->index].high_pwroff,\r\nMAX1617_WR_CPU_HIGHLIM);\r\nbbc_i2c_writeb(tp->client, cpu_temp_limits[tp->index].low_pwroff,\r\nMAX1617_WR_CPU_LOWLIM);\r\nget_current_temps(tp);\r\ntp->prev_cpu_temp = tp->avg_cpu_temp = tp->curr_cpu_temp;\r\ntp->prev_amb_temp = tp->avg_amb_temp = tp->curr_amb_temp;\r\ntp->fan_todo[FAN_AMBIENT] = FAN_SAME;\r\ntp->fan_todo[FAN_CPU] = FAN_SAME;\r\n}\r\nstatic void attach_one_fan(struct bbc_i2c_bus *bp, struct platform_device *op,\r\nint fan_idx)\r\n{\r\nstruct bbc_fan_control *fp;\r\nfp = kzalloc(sizeof(*fp), GFP_KERNEL);\r\nif (!fp)\r\nreturn;\r\nINIT_LIST_HEAD(&fp->bp_list);\r\nINIT_LIST_HEAD(&fp->glob_list);\r\nfp->client = bbc_i2c_attach(bp, op);\r\nif (!fp->client) {\r\nkfree(fp);\r\nreturn;\r\n}\r\nfp->index = fan_idx;\r\nlist_add(&fp->glob_list, &all_fans);\r\nlist_add(&fp->bp_list, &bp->fans);\r\nfp->psupply_fan_on = 1;\r\nfp->cpu_fan_speed = (FAN_SPEED_MAX - FAN_SPEED_MIN) / 2;\r\nfp->cpu_fan_speed += FAN_SPEED_MIN;\r\nfp->system_fan_speed = (FAN_SPEED_MAX - FAN_SPEED_MIN) / 2;\r\nfp->system_fan_speed += FAN_SPEED_MIN;\r\nset_fan_speeds(fp);\r\n}\r\nstatic void destroy_one_temp(struct bbc_cpu_temperature *tp)\r\n{\r\nbbc_i2c_detach(tp->client);\r\nkfree(tp);\r\n}\r\nstatic void destroy_all_temps(struct bbc_i2c_bus *bp)\r\n{\r\nstruct bbc_cpu_temperature *tp, *tpos;\r\nlist_for_each_entry_safe(tp, tpos, &bp->temps, bp_list) {\r\nlist_del(&tp->bp_list);\r\nlist_del(&tp->glob_list);\r\ndestroy_one_temp(tp);\r\n}\r\n}\r\nstatic void destroy_one_fan(struct bbc_fan_control *fp)\r\n{\r\nbbc_i2c_detach(fp->client);\r\nkfree(fp);\r\n}\r\nstatic void destroy_all_fans(struct bbc_i2c_bus *bp)\r\n{\r\nstruct bbc_fan_control *fp, *fpos;\r\nlist_for_each_entry_safe(fp, fpos, &bp->fans, bp_list) {\r\nlist_del(&fp->bp_list);\r\nlist_del(&fp->glob_list);\r\ndestroy_one_fan(fp);\r\n}\r\n}\r\nint bbc_envctrl_init(struct bbc_i2c_bus *bp)\r\n{\r\nstruct platform_device *op;\r\nint temp_index = 0;\r\nint fan_index = 0;\r\nint devidx = 0;\r\nwhile ((op = bbc_i2c_getdev(bp, devidx++)) != NULL) {\r\nif (!strcmp(op->dev.of_node->name, "temperature"))\r\nattach_one_temp(bp, op, temp_index++);\r\nif (!strcmp(op->dev.of_node->name, "fan-control"))\r\nattach_one_fan(bp, op, fan_index++);\r\n}\r\nif (temp_index != 0 && fan_index != 0) {\r\nkenvctrld_task = kthread_run(kenvctrld, NULL, "kenvctrld");\r\nif (IS_ERR(kenvctrld_task)) {\r\nint err = PTR_ERR(kenvctrld_task);\r\nkenvctrld_task = NULL;\r\ndestroy_all_temps(bp);\r\ndestroy_all_fans(bp);\r\nreturn err;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid bbc_envctrl_cleanup(struct bbc_i2c_bus *bp)\r\n{\r\nif (kenvctrld_task)\r\nkthread_stop(kenvctrld_task);\r\ndestroy_all_temps(bp);\r\ndestroy_all_fans(bp);\r\n}

static int moxart_shutdown(struct clock_event_device *evt)\r\n{\r\nwritel(TIMER1_DISABLE, base + TIMER_CR);\r\nreturn 0;\r\n}\r\nstatic int moxart_set_oneshot(struct clock_event_device *evt)\r\n{\r\nwritel(TIMER1_DISABLE, base + TIMER_CR);\r\nwritel(~0, base + TIMER1_BASE + REG_LOAD);\r\nreturn 0;\r\n}\r\nstatic int moxart_set_periodic(struct clock_event_device *evt)\r\n{\r\nwritel(clock_count_per_tick, base + TIMER1_BASE + REG_LOAD);\r\nwritel(TIMER1_ENABLE, base + TIMER_CR);\r\nreturn 0;\r\n}\r\nstatic int moxart_clkevt_next_event(unsigned long cycles,\r\nstruct clock_event_device *unused)\r\n{\r\nu32 u;\r\nwritel(TIMER1_DISABLE, base + TIMER_CR);\r\nu = readl(base + TIMER1_BASE + REG_COUNT) - cycles;\r\nwritel(u, base + TIMER1_BASE + REG_MATCH1);\r\nwritel(TIMER1_ENABLE, base + TIMER_CR);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t moxart_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = dev_id;\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __init moxart_timer_init(struct device_node *node)\r\n{\r\nint ret, irq;\r\nunsigned long pclk;\r\nstruct clk *clk;\r\nbase = of_iomap(node, 0);\r\nif (!base)\r\npanic("%s: of_iomap failed\n", node->full_name);\r\nirq = irq_of_parse_and_map(node, 0);\r\nif (irq <= 0)\r\npanic("%s: irq_of_parse_and_map failed\n", node->full_name);\r\nret = setup_irq(irq, &moxart_timer_irq);\r\nif (ret)\r\npanic("%s: setup_irq failed\n", node->full_name);\r\nclk = of_clk_get(node, 0);\r\nif (IS_ERR(clk))\r\npanic("%s: of_clk_get failed\n", node->full_name);\r\npclk = clk_get_rate(clk);\r\nif (clocksource_mmio_init(base + TIMER2_BASE + REG_COUNT,\r\n"moxart_timer", pclk, 200, 32,\r\nclocksource_mmio_readl_down))\r\npanic("%s: clocksource_mmio_init failed\n", node->full_name);\r\nclock_count_per_tick = DIV_ROUND_CLOSEST(pclk, HZ);\r\nwritel(~0, base + TIMER2_BASE + REG_LOAD);\r\nwritel(TIMEREG_CR_2_ENABLE, base + TIMER_CR);\r\nmoxart_clockevent.cpumask = cpumask_of(0);\r\nmoxart_clockevent.irq = irq;\r\nclockevents_config_and_register(&moxart_clockevent, pclk,\r\n0x4, 0xfffffffe);\r\n}

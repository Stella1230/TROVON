s32 igb_check_reset_block(struct e1000_hw *hw)\r\n{\r\nu32 manc;\r\nmanc = rd32(E1000_MANC);\r\nreturn (manc & E1000_MANC_BLK_PHY_RST_ON_IDE) ? E1000_BLK_PHY_RESET : 0;\r\n}\r\ns32 igb_get_phy_id(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val = 0;\r\nu16 phy_id;\r\nret_val = phy->ops.read_reg(hw, PHY_ID1, &phy_id);\r\nif (ret_val)\r\ngoto out;\r\nphy->id = (u32)(phy_id << 16);\r\nudelay(20);\r\nret_val = phy->ops.read_reg(hw, PHY_ID2, &phy_id);\r\nif (ret_val)\r\ngoto out;\r\nphy->id |= (u32)(phy_id & PHY_REVISION_MASK);\r\nphy->revision = (u32)(phy_id & ~PHY_REVISION_MASK);\r\nout:\r\nreturn ret_val;\r\n}\r\nstatic s32 igb_phy_reset_dsp(struct e1000_hw *hw)\r\n{\r\ns32 ret_val = 0;\r\nif (!(hw->phy.ops.write_reg))\r\ngoto out;\r\nret_val = hw->phy.ops.write_reg(hw, M88E1000_PHY_GEN_CONTROL, 0xC1);\r\nif (ret_val)\r\ngoto out;\r\nret_val = hw->phy.ops.write_reg(hw, M88E1000_PHY_GEN_CONTROL, 0);\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_read_phy_reg_mdic(struct e1000_hw *hw, u32 offset, u16 *data)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\nu32 i, mdic = 0;\r\ns32 ret_val = 0;\r\nif (offset > MAX_PHY_REG_ADDRESS) {\r\nhw_dbg("PHY Address %d is out of range\n", offset);\r\nret_val = -E1000_ERR_PARAM;\r\ngoto out;\r\n}\r\nmdic = ((offset << E1000_MDIC_REG_SHIFT) |\r\n(phy->addr << E1000_MDIC_PHY_SHIFT) |\r\n(E1000_MDIC_OP_READ));\r\nwr32(E1000_MDIC, mdic);\r\nfor (i = 0; i < (E1000_GEN_POLL_TIMEOUT * 3); i++) {\r\nudelay(50);\r\nmdic = rd32(E1000_MDIC);\r\nif (mdic & E1000_MDIC_READY)\r\nbreak;\r\n}\r\nif (!(mdic & E1000_MDIC_READY)) {\r\nhw_dbg("MDI Read did not complete\n");\r\nret_val = -E1000_ERR_PHY;\r\ngoto out;\r\n}\r\nif (mdic & E1000_MDIC_ERROR) {\r\nhw_dbg("MDI Error\n");\r\nret_val = -E1000_ERR_PHY;\r\ngoto out;\r\n}\r\n*data = (u16) mdic;\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_write_phy_reg_mdic(struct e1000_hw *hw, u32 offset, u16 data)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\nu32 i, mdic = 0;\r\ns32 ret_val = 0;\r\nif (offset > MAX_PHY_REG_ADDRESS) {\r\nhw_dbg("PHY Address %d is out of range\n", offset);\r\nret_val = -E1000_ERR_PARAM;\r\ngoto out;\r\n}\r\nmdic = (((u32)data) |\r\n(offset << E1000_MDIC_REG_SHIFT) |\r\n(phy->addr << E1000_MDIC_PHY_SHIFT) |\r\n(E1000_MDIC_OP_WRITE));\r\nwr32(E1000_MDIC, mdic);\r\nfor (i = 0; i < (E1000_GEN_POLL_TIMEOUT * 3); i++) {\r\nudelay(50);\r\nmdic = rd32(E1000_MDIC);\r\nif (mdic & E1000_MDIC_READY)\r\nbreak;\r\n}\r\nif (!(mdic & E1000_MDIC_READY)) {\r\nhw_dbg("MDI Write did not complete\n");\r\nret_val = -E1000_ERR_PHY;\r\ngoto out;\r\n}\r\nif (mdic & E1000_MDIC_ERROR) {\r\nhw_dbg("MDI Error\n");\r\nret_val = -E1000_ERR_PHY;\r\ngoto out;\r\n}\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_read_phy_reg_i2c(struct e1000_hw *hw, u32 offset, u16 *data)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\nu32 i, i2ccmd = 0;\r\ni2ccmd = ((offset << E1000_I2CCMD_REG_ADDR_SHIFT) |\r\n(phy->addr << E1000_I2CCMD_PHY_ADDR_SHIFT) |\r\n(E1000_I2CCMD_OPCODE_READ));\r\nwr32(E1000_I2CCMD, i2ccmd);\r\nfor (i = 0; i < E1000_I2CCMD_PHY_TIMEOUT; i++) {\r\nudelay(50);\r\ni2ccmd = rd32(E1000_I2CCMD);\r\nif (i2ccmd & E1000_I2CCMD_READY)\r\nbreak;\r\n}\r\nif (!(i2ccmd & E1000_I2CCMD_READY)) {\r\nhw_dbg("I2CCMD Read did not complete\n");\r\nreturn -E1000_ERR_PHY;\r\n}\r\nif (i2ccmd & E1000_I2CCMD_ERROR) {\r\nhw_dbg("I2CCMD Error bit set\n");\r\nreturn -E1000_ERR_PHY;\r\n}\r\n*data = ((i2ccmd >> 8) & 0x00FF) | ((i2ccmd << 8) & 0xFF00);\r\nreturn 0;\r\n}\r\ns32 igb_write_phy_reg_i2c(struct e1000_hw *hw, u32 offset, u16 data)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\nu32 i, i2ccmd = 0;\r\nu16 phy_data_swapped;\r\nif ((hw->phy.addr == 0) || (hw->phy.addr > 7)) {\r\nhw_dbg("PHY I2C Address %d is out of range.\n",\r\nhw->phy.addr);\r\nreturn -E1000_ERR_CONFIG;\r\n}\r\nphy_data_swapped = ((data >> 8) & 0x00FF) | ((data << 8) & 0xFF00);\r\ni2ccmd = ((offset << E1000_I2CCMD_REG_ADDR_SHIFT) |\r\n(phy->addr << E1000_I2CCMD_PHY_ADDR_SHIFT) |\r\nE1000_I2CCMD_OPCODE_WRITE |\r\nphy_data_swapped);\r\nwr32(E1000_I2CCMD, i2ccmd);\r\nfor (i = 0; i < E1000_I2CCMD_PHY_TIMEOUT; i++) {\r\nudelay(50);\r\ni2ccmd = rd32(E1000_I2CCMD);\r\nif (i2ccmd & E1000_I2CCMD_READY)\r\nbreak;\r\n}\r\nif (!(i2ccmd & E1000_I2CCMD_READY)) {\r\nhw_dbg("I2CCMD Write did not complete\n");\r\nreturn -E1000_ERR_PHY;\r\n}\r\nif (i2ccmd & E1000_I2CCMD_ERROR) {\r\nhw_dbg("I2CCMD Error bit set\n");\r\nreturn -E1000_ERR_PHY;\r\n}\r\nreturn 0;\r\n}\r\ns32 igb_read_sfp_data_byte(struct e1000_hw *hw, u16 offset, u8 *data)\r\n{\r\nu32 i = 0;\r\nu32 i2ccmd = 0;\r\nu32 data_local = 0;\r\nif (offset > E1000_I2CCMD_SFP_DIAG_ADDR(255)) {\r\nhw_dbg("I2CCMD command address exceeds upper limit\n");\r\nreturn -E1000_ERR_PHY;\r\n}\r\ni2ccmd = ((offset << E1000_I2CCMD_REG_ADDR_SHIFT) |\r\nE1000_I2CCMD_OPCODE_READ);\r\nwr32(E1000_I2CCMD, i2ccmd);\r\nfor (i = 0; i < E1000_I2CCMD_PHY_TIMEOUT; i++) {\r\nudelay(50);\r\ndata_local = rd32(E1000_I2CCMD);\r\nif (data_local & E1000_I2CCMD_READY)\r\nbreak;\r\n}\r\nif (!(data_local & E1000_I2CCMD_READY)) {\r\nhw_dbg("I2CCMD Read did not complete\n");\r\nreturn -E1000_ERR_PHY;\r\n}\r\nif (data_local & E1000_I2CCMD_ERROR) {\r\nhw_dbg("I2CCMD Error bit set\n");\r\nreturn -E1000_ERR_PHY;\r\n}\r\n*data = (u8) data_local & 0xFF;\r\nreturn 0;\r\n}\r\ns32 igb_read_phy_reg_igp(struct e1000_hw *hw, u32 offset, u16 *data)\r\n{\r\ns32 ret_val = 0;\r\nif (!(hw->phy.ops.acquire))\r\ngoto out;\r\nret_val = hw->phy.ops.acquire(hw);\r\nif (ret_val)\r\ngoto out;\r\nif (offset > MAX_PHY_MULTI_PAGE_REG) {\r\nret_val = igb_write_phy_reg_mdic(hw,\r\nIGP01E1000_PHY_PAGE_SELECT,\r\n(u16)offset);\r\nif (ret_val) {\r\nhw->phy.ops.release(hw);\r\ngoto out;\r\n}\r\n}\r\nret_val = igb_read_phy_reg_mdic(hw, MAX_PHY_REG_ADDRESS & offset,\r\ndata);\r\nhw->phy.ops.release(hw);\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_write_phy_reg_igp(struct e1000_hw *hw, u32 offset, u16 data)\r\n{\r\ns32 ret_val = 0;\r\nif (!(hw->phy.ops.acquire))\r\ngoto out;\r\nret_val = hw->phy.ops.acquire(hw);\r\nif (ret_val)\r\ngoto out;\r\nif (offset > MAX_PHY_MULTI_PAGE_REG) {\r\nret_val = igb_write_phy_reg_mdic(hw,\r\nIGP01E1000_PHY_PAGE_SELECT,\r\n(u16)offset);\r\nif (ret_val) {\r\nhw->phy.ops.release(hw);\r\ngoto out;\r\n}\r\n}\r\nret_val = igb_write_phy_reg_mdic(hw, MAX_PHY_REG_ADDRESS & offset,\r\ndata);\r\nhw->phy.ops.release(hw);\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_copper_link_setup_82580(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 phy_data;\r\nif (phy->reset_disable) {\r\nret_val = 0;\r\ngoto out;\r\n}\r\nif (phy->type == e1000_phy_82580) {\r\nret_val = hw->phy.ops.reset(hw);\r\nif (ret_val) {\r\nhw_dbg("Error resetting the PHY.\n");\r\ngoto out;\r\n}\r\n}\r\nret_val = phy->ops.read_reg(hw, I82580_CFG_REG, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy_data |= I82580_CFG_ASSERT_CRS_ON_TX;\r\nphy_data |= I82580_CFG_ENABLE_DOWNSHIFT;\r\nret_val = phy->ops.write_reg(hw, I82580_CFG_REG, phy_data);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, I82580_PHY_CTRL_2, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy_data &= ~I82580_PHY_CTRL2_MDIX_CFG_MASK;\r\nswitch (hw->phy.mdix) {\r\ncase 1:\r\nbreak;\r\ncase 2:\r\nphy_data |= I82580_PHY_CTRL2_MANUAL_MDIX;\r\nbreak;\r\ncase 0:\r\ndefault:\r\nphy_data |= I82580_PHY_CTRL2_AUTO_MDI_MDIX;\r\nbreak;\r\n}\r\nret_val = hw->phy.ops.write_reg(hw, I82580_PHY_CTRL_2, phy_data);\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_copper_link_setup_m88(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 phy_data;\r\nif (phy->reset_disable) {\r\nret_val = 0;\r\ngoto out;\r\n}\r\nret_val = phy->ops.read_reg(hw, M88E1000_PHY_SPEC_CTRL, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy_data |= M88E1000_PSCR_ASSERT_CRS_ON_TX;\r\nphy_data &= ~M88E1000_PSCR_AUTO_X_MODE;\r\nswitch (phy->mdix) {\r\ncase 1:\r\nphy_data |= M88E1000_PSCR_MDI_MANUAL_MODE;\r\nbreak;\r\ncase 2:\r\nphy_data |= M88E1000_PSCR_MDIX_MANUAL_MODE;\r\nbreak;\r\ncase 3:\r\nphy_data |= M88E1000_PSCR_AUTO_X_1000T;\r\nbreak;\r\ncase 0:\r\ndefault:\r\nphy_data |= M88E1000_PSCR_AUTO_X_MODE;\r\nbreak;\r\n}\r\nphy_data &= ~M88E1000_PSCR_POLARITY_REVERSAL;\r\nif (phy->disable_polarity_correction == 1)\r\nphy_data |= M88E1000_PSCR_POLARITY_REVERSAL;\r\nret_val = phy->ops.write_reg(hw, M88E1000_PHY_SPEC_CTRL, phy_data);\r\nif (ret_val)\r\ngoto out;\r\nif (phy->revision < E1000_REVISION_4) {\r\nret_val = phy->ops.read_reg(hw, M88E1000_EXT_PHY_SPEC_CTRL,\r\n&phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy_data |= M88E1000_EPSCR_TX_CLK_25;\r\nif ((phy->revision == E1000_REVISION_2) &&\r\n(phy->id == M88E1111_I_PHY_ID)) {\r\nphy_data &= ~M88EC018_EPSCR_DOWNSHIFT_COUNTER_MASK;\r\nphy_data |= M88EC018_EPSCR_DOWNSHIFT_COUNTER_5X;\r\n} else {\r\nphy_data &= ~(M88E1000_EPSCR_MASTER_DOWNSHIFT_MASK |\r\nM88E1000_EPSCR_SLAVE_DOWNSHIFT_MASK);\r\nphy_data |= (M88E1000_EPSCR_MASTER_DOWNSHIFT_1X |\r\nM88E1000_EPSCR_SLAVE_DOWNSHIFT_1X);\r\n}\r\nret_val = phy->ops.write_reg(hw, M88E1000_EXT_PHY_SPEC_CTRL,\r\nphy_data);\r\nif (ret_val)\r\ngoto out;\r\n}\r\nret_val = igb_phy_sw_reset(hw);\r\nif (ret_val) {\r\nhw_dbg("Error committing the PHY changes\n");\r\ngoto out;\r\n}\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_copper_link_setup_m88_gen2(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 phy_data;\r\nif (phy->reset_disable)\r\nreturn 0;\r\nret_val = phy->ops.read_reg(hw, M88E1000_PHY_SPEC_CTRL, &phy_data);\r\nif (ret_val)\r\nreturn ret_val;\r\nphy_data &= ~M88E1000_PSCR_AUTO_X_MODE;\r\nswitch (phy->mdix) {\r\ncase 1:\r\nphy_data |= M88E1000_PSCR_MDI_MANUAL_MODE;\r\nbreak;\r\ncase 2:\r\nphy_data |= M88E1000_PSCR_MDIX_MANUAL_MODE;\r\nbreak;\r\ncase 3:\r\nif (phy->id != M88E1112_E_PHY_ID) {\r\nphy_data |= M88E1000_PSCR_AUTO_X_1000T;\r\nbreak;\r\n}\r\ncase 0:\r\ndefault:\r\nphy_data |= M88E1000_PSCR_AUTO_X_MODE;\r\nbreak;\r\n}\r\nphy_data &= ~M88E1000_PSCR_POLARITY_REVERSAL;\r\nif (phy->disable_polarity_correction == 1)\r\nphy_data |= M88E1000_PSCR_POLARITY_REVERSAL;\r\nif (phy->id == M88E1543_E_PHY_ID) {\r\nphy_data &= ~I347AT4_PSCR_DOWNSHIFT_ENABLE;\r\nret_val =\r\nphy->ops.write_reg(hw, M88E1000_PHY_SPEC_CTRL, phy_data);\r\nif (ret_val)\r\nreturn ret_val;\r\nret_val = igb_phy_sw_reset(hw);\r\nif (ret_val) {\r\nhw_dbg("Error committing the PHY changes\n");\r\nreturn ret_val;\r\n}\r\n}\r\nphy_data &= ~I347AT4_PSCR_DOWNSHIFT_MASK;\r\nphy_data |= I347AT4_PSCR_DOWNSHIFT_6X;\r\nphy_data |= I347AT4_PSCR_DOWNSHIFT_ENABLE;\r\nret_val = phy->ops.write_reg(hw, M88E1000_PHY_SPEC_CTRL, phy_data);\r\nif (ret_val)\r\nreturn ret_val;\r\nret_val = igb_phy_sw_reset(hw);\r\nif (ret_val) {\r\nhw_dbg("Error committing the PHY changes\n");\r\nreturn ret_val;\r\n}\r\nret_val = igb_set_master_slave_mode(hw);\r\nif (ret_val)\r\nreturn ret_val;\r\nreturn 0;\r\n}\r\ns32 igb_copper_link_setup_igp(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 data;\r\nif (phy->reset_disable) {\r\nret_val = 0;\r\ngoto out;\r\n}\r\nret_val = phy->ops.reset(hw);\r\nif (ret_val) {\r\nhw_dbg("Error resetting the PHY.\n");\r\ngoto out;\r\n}\r\nmsleep(100);\r\nif (phy->type == e1000_phy_igp) {\r\nif (phy->ops.set_d3_lplu_state)\r\nret_val = phy->ops.set_d3_lplu_state(hw, false);\r\nif (ret_val) {\r\nhw_dbg("Error Disabling LPLU D3\n");\r\ngoto out;\r\n}\r\n}\r\nret_val = phy->ops.set_d0_lplu_state(hw, false);\r\nif (ret_val) {\r\nhw_dbg("Error Disabling LPLU D0\n");\r\ngoto out;\r\n}\r\nret_val = phy->ops.read_reg(hw, IGP01E1000_PHY_PORT_CTRL, &data);\r\nif (ret_val)\r\ngoto out;\r\ndata &= ~IGP01E1000_PSCR_AUTO_MDIX;\r\nswitch (phy->mdix) {\r\ncase 1:\r\ndata &= ~IGP01E1000_PSCR_FORCE_MDI_MDIX;\r\nbreak;\r\ncase 2:\r\ndata |= IGP01E1000_PSCR_FORCE_MDI_MDIX;\r\nbreak;\r\ncase 0:\r\ndefault:\r\ndata |= IGP01E1000_PSCR_AUTO_MDIX;\r\nbreak;\r\n}\r\nret_val = phy->ops.write_reg(hw, IGP01E1000_PHY_PORT_CTRL, data);\r\nif (ret_val)\r\ngoto out;\r\nif (hw->mac.autoneg) {\r\nif (phy->autoneg_advertised == ADVERTISE_1000_FULL) {\r\nret_val = phy->ops.read_reg(hw,\r\nIGP01E1000_PHY_PORT_CONFIG,\r\n&data);\r\nif (ret_val)\r\ngoto out;\r\ndata &= ~IGP01E1000_PSCFR_SMART_SPEED;\r\nret_val = phy->ops.write_reg(hw,\r\nIGP01E1000_PHY_PORT_CONFIG,\r\ndata);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, PHY_1000T_CTRL, &data);\r\nif (ret_val)\r\ngoto out;\r\ndata &= ~CR_1000T_MS_ENABLE;\r\nret_val = phy->ops.write_reg(hw, PHY_1000T_CTRL, data);\r\nif (ret_val)\r\ngoto out;\r\n}\r\nret_val = phy->ops.read_reg(hw, PHY_1000T_CTRL, &data);\r\nif (ret_val)\r\ngoto out;\r\nphy->original_ms_type = (data & CR_1000T_MS_ENABLE) ?\r\n((data & CR_1000T_MS_VALUE) ?\r\ne1000_ms_force_master :\r\ne1000_ms_force_slave) :\r\ne1000_ms_auto;\r\nswitch (phy->ms_type) {\r\ncase e1000_ms_force_master:\r\ndata |= (CR_1000T_MS_ENABLE | CR_1000T_MS_VALUE);\r\nbreak;\r\ncase e1000_ms_force_slave:\r\ndata |= CR_1000T_MS_ENABLE;\r\ndata &= ~(CR_1000T_MS_VALUE);\r\nbreak;\r\ncase e1000_ms_auto:\r\ndata &= ~CR_1000T_MS_ENABLE;\r\ndefault:\r\nbreak;\r\n}\r\nret_val = phy->ops.write_reg(hw, PHY_1000T_CTRL, data);\r\nif (ret_val)\r\ngoto out;\r\n}\r\nout:\r\nreturn ret_val;\r\n}\r\nstatic s32 igb_copper_link_autoneg(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 phy_ctrl;\r\nphy->autoneg_advertised &= phy->autoneg_mask;\r\nif (phy->autoneg_advertised == 0)\r\nphy->autoneg_advertised = phy->autoneg_mask;\r\nhw_dbg("Reconfiguring auto-neg advertisement params\n");\r\nret_val = igb_phy_setup_autoneg(hw);\r\nif (ret_val) {\r\nhw_dbg("Error Setting up Auto-Negotiation\n");\r\ngoto out;\r\n}\r\nhw_dbg("Restarting Auto-Neg\n");\r\nret_val = phy->ops.read_reg(hw, PHY_CONTROL, &phy_ctrl);\r\nif (ret_val)\r\ngoto out;\r\nphy_ctrl |= (MII_CR_AUTO_NEG_EN | MII_CR_RESTART_AUTO_NEG);\r\nret_val = phy->ops.write_reg(hw, PHY_CONTROL, phy_ctrl);\r\nif (ret_val)\r\ngoto out;\r\nif (phy->autoneg_wait_to_complete) {\r\nret_val = igb_wait_autoneg(hw);\r\nif (ret_val) {\r\nhw_dbg("Error while waiting for autoneg to complete\n");\r\ngoto out;\r\n}\r\n}\r\nhw->mac.get_link_status = true;\r\nout:\r\nreturn ret_val;\r\n}\r\nstatic s32 igb_phy_setup_autoneg(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 mii_autoneg_adv_reg;\r\nu16 mii_1000t_ctrl_reg = 0;\r\nphy->autoneg_advertised &= phy->autoneg_mask;\r\nret_val = phy->ops.read_reg(hw, PHY_AUTONEG_ADV, &mii_autoneg_adv_reg);\r\nif (ret_val)\r\ngoto out;\r\nif (phy->autoneg_mask & ADVERTISE_1000_FULL) {\r\nret_val = phy->ops.read_reg(hw, PHY_1000T_CTRL,\r\n&mii_1000t_ctrl_reg);\r\nif (ret_val)\r\ngoto out;\r\n}\r\nmii_autoneg_adv_reg &= ~(NWAY_AR_100TX_FD_CAPS |\r\nNWAY_AR_100TX_HD_CAPS |\r\nNWAY_AR_10T_FD_CAPS |\r\nNWAY_AR_10T_HD_CAPS);\r\nmii_1000t_ctrl_reg &= ~(CR_1000T_HD_CAPS | CR_1000T_FD_CAPS);\r\nhw_dbg("autoneg_advertised %x\n", phy->autoneg_advertised);\r\nif (phy->autoneg_advertised & ADVERTISE_10_HALF) {\r\nhw_dbg("Advertise 10mb Half duplex\n");\r\nmii_autoneg_adv_reg |= NWAY_AR_10T_HD_CAPS;\r\n}\r\nif (phy->autoneg_advertised & ADVERTISE_10_FULL) {\r\nhw_dbg("Advertise 10mb Full duplex\n");\r\nmii_autoneg_adv_reg |= NWAY_AR_10T_FD_CAPS;\r\n}\r\nif (phy->autoneg_advertised & ADVERTISE_100_HALF) {\r\nhw_dbg("Advertise 100mb Half duplex\n");\r\nmii_autoneg_adv_reg |= NWAY_AR_100TX_HD_CAPS;\r\n}\r\nif (phy->autoneg_advertised & ADVERTISE_100_FULL) {\r\nhw_dbg("Advertise 100mb Full duplex\n");\r\nmii_autoneg_adv_reg |= NWAY_AR_100TX_FD_CAPS;\r\n}\r\nif (phy->autoneg_advertised & ADVERTISE_1000_HALF)\r\nhw_dbg("Advertise 1000mb Half duplex request denied!\n");\r\nif (phy->autoneg_advertised & ADVERTISE_1000_FULL) {\r\nhw_dbg("Advertise 1000mb Full duplex\n");\r\nmii_1000t_ctrl_reg |= CR_1000T_FD_CAPS;\r\n}\r\nswitch (hw->fc.current_mode) {\r\ncase e1000_fc_none:\r\nmii_autoneg_adv_reg &= ~(NWAY_AR_ASM_DIR | NWAY_AR_PAUSE);\r\nbreak;\r\ncase e1000_fc_rx_pause:\r\nmii_autoneg_adv_reg |= (NWAY_AR_ASM_DIR | NWAY_AR_PAUSE);\r\nbreak;\r\ncase e1000_fc_tx_pause:\r\nmii_autoneg_adv_reg |= NWAY_AR_ASM_DIR;\r\nmii_autoneg_adv_reg &= ~NWAY_AR_PAUSE;\r\nbreak;\r\ncase e1000_fc_full:\r\nmii_autoneg_adv_reg |= (NWAY_AR_ASM_DIR | NWAY_AR_PAUSE);\r\nbreak;\r\ndefault:\r\nhw_dbg("Flow control param set incorrectly\n");\r\nret_val = -E1000_ERR_CONFIG;\r\ngoto out;\r\n}\r\nret_val = phy->ops.write_reg(hw, PHY_AUTONEG_ADV, mii_autoneg_adv_reg);\r\nif (ret_val)\r\ngoto out;\r\nhw_dbg("Auto-Neg Advertising %x\n", mii_autoneg_adv_reg);\r\nif (phy->autoneg_mask & ADVERTISE_1000_FULL) {\r\nret_val = phy->ops.write_reg(hw,\r\nPHY_1000T_CTRL,\r\nmii_1000t_ctrl_reg);\r\nif (ret_val)\r\ngoto out;\r\n}\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_setup_copper_link(struct e1000_hw *hw)\r\n{\r\ns32 ret_val;\r\nbool link;\r\nif (hw->mac.autoneg) {\r\nret_val = igb_copper_link_autoneg(hw);\r\nif (ret_val)\r\ngoto out;\r\n} else {\r\nhw_dbg("Forcing Speed and Duplex\n");\r\nret_val = hw->phy.ops.force_speed_duplex(hw);\r\nif (ret_val) {\r\nhw_dbg("Error Forcing Speed and Duplex\n");\r\ngoto out;\r\n}\r\n}\r\nret_val = igb_phy_has_link(hw, COPPER_LINK_UP_LIMIT, 10, &link);\r\nif (ret_val)\r\ngoto out;\r\nif (link) {\r\nhw_dbg("Valid link established!!!\n");\r\nigb_config_collision_dist(hw);\r\nret_val = igb_config_fc_after_link_up(hw);\r\n} else {\r\nhw_dbg("Unable to establish link!!!\n");\r\n}\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_phy_force_speed_duplex_igp(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 phy_data;\r\nbool link;\r\nret_val = phy->ops.read_reg(hw, PHY_CONTROL, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nigb_phy_force_speed_duplex_setup(hw, &phy_data);\r\nret_val = phy->ops.write_reg(hw, PHY_CONTROL, phy_data);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, IGP01E1000_PHY_PORT_CTRL, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy_data &= ~IGP01E1000_PSCR_AUTO_MDIX;\r\nphy_data &= ~IGP01E1000_PSCR_FORCE_MDI_MDIX;\r\nret_val = phy->ops.write_reg(hw, IGP01E1000_PHY_PORT_CTRL, phy_data);\r\nif (ret_val)\r\ngoto out;\r\nhw_dbg("IGP PSCR: %X\n", phy_data);\r\nudelay(1);\r\nif (phy->autoneg_wait_to_complete) {\r\nhw_dbg("Waiting for forced speed/duplex link on IGP phy.\n");\r\nret_val = igb_phy_has_link(hw, PHY_FORCE_LIMIT, 10000, &link);\r\nif (ret_val)\r\ngoto out;\r\nif (!link)\r\nhw_dbg("Link taking longer than expected.\n");\r\nret_val = igb_phy_has_link(hw, PHY_FORCE_LIMIT, 10000, &link);\r\nif (ret_val)\r\ngoto out;\r\n}\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_phy_force_speed_duplex_m88(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 phy_data;\r\nbool link;\r\nif (phy->type != e1000_phy_i210) {\r\nret_val = phy->ops.read_reg(hw, M88E1000_PHY_SPEC_CTRL,\r\n&phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy_data &= ~M88E1000_PSCR_AUTO_X_MODE;\r\nret_val = phy->ops.write_reg(hw, M88E1000_PHY_SPEC_CTRL,\r\nphy_data);\r\nif (ret_val)\r\ngoto out;\r\nhw_dbg("M88E1000 PSCR: %X\n", phy_data);\r\n}\r\nret_val = phy->ops.read_reg(hw, PHY_CONTROL, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nigb_phy_force_speed_duplex_setup(hw, &phy_data);\r\nret_val = phy->ops.write_reg(hw, PHY_CONTROL, phy_data);\r\nif (ret_val)\r\ngoto out;\r\nret_val = igb_phy_sw_reset(hw);\r\nif (ret_val)\r\ngoto out;\r\nif (phy->autoneg_wait_to_complete) {\r\nhw_dbg("Waiting for forced speed/duplex link on M88 phy.\n");\r\nret_val = igb_phy_has_link(hw, PHY_FORCE_LIMIT, 100000, &link);\r\nif (ret_val)\r\ngoto out;\r\nif (!link) {\r\nbool reset_dsp = true;\r\nswitch (hw->phy.id) {\r\ncase I347AT4_E_PHY_ID:\r\ncase M88E1112_E_PHY_ID:\r\ncase M88E1543_E_PHY_ID:\r\ncase M88E1512_E_PHY_ID:\r\ncase I210_I_PHY_ID:\r\nreset_dsp = false;\r\nbreak;\r\ndefault:\r\nif (hw->phy.type != e1000_phy_m88)\r\nreset_dsp = false;\r\nbreak;\r\n}\r\nif (!reset_dsp) {\r\nhw_dbg("Link taking longer than expected.\n");\r\n} else {\r\nret_val = phy->ops.write_reg(hw,\r\nM88E1000_PHY_PAGE_SELECT,\r\n0x001d);\r\nif (ret_val)\r\ngoto out;\r\nret_val = igb_phy_reset_dsp(hw);\r\nif (ret_val)\r\ngoto out;\r\n}\r\n}\r\nret_val = igb_phy_has_link(hw, PHY_FORCE_LIMIT,\r\n100000, &link);\r\nif (ret_val)\r\ngoto out;\r\n}\r\nif (hw->phy.type != e1000_phy_m88 ||\r\nhw->phy.id == I347AT4_E_PHY_ID ||\r\nhw->phy.id == M88E1112_E_PHY_ID ||\r\nhw->phy.id == M88E1543_E_PHY_ID ||\r\nhw->phy.id == M88E1512_E_PHY_ID ||\r\nhw->phy.id == I210_I_PHY_ID)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, M88E1000_EXT_PHY_SPEC_CTRL, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy_data |= M88E1000_EPSCR_TX_CLK_25;\r\nret_val = phy->ops.write_reg(hw, M88E1000_EXT_PHY_SPEC_CTRL, phy_data);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, M88E1000_PHY_SPEC_CTRL, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy_data |= M88E1000_PSCR_ASSERT_CRS_ON_TX;\r\nret_val = phy->ops.write_reg(hw, M88E1000_PHY_SPEC_CTRL, phy_data);\r\nout:\r\nreturn ret_val;\r\n}\r\nstatic void igb_phy_force_speed_duplex_setup(struct e1000_hw *hw,\r\nu16 *phy_ctrl)\r\n{\r\nstruct e1000_mac_info *mac = &hw->mac;\r\nu32 ctrl;\r\nhw->fc.current_mode = e1000_fc_none;\r\nctrl = rd32(E1000_CTRL);\r\nctrl |= (E1000_CTRL_FRCSPD | E1000_CTRL_FRCDPX);\r\nctrl &= ~E1000_CTRL_SPD_SEL;\r\nctrl &= ~E1000_CTRL_ASDE;\r\n*phy_ctrl &= ~MII_CR_AUTO_NEG_EN;\r\nif (mac->forced_speed_duplex & E1000_ALL_HALF_DUPLEX) {\r\nctrl &= ~E1000_CTRL_FD;\r\n*phy_ctrl &= ~MII_CR_FULL_DUPLEX;\r\nhw_dbg("Half Duplex\n");\r\n} else {\r\nctrl |= E1000_CTRL_FD;\r\n*phy_ctrl |= MII_CR_FULL_DUPLEX;\r\nhw_dbg("Full Duplex\n");\r\n}\r\nif (mac->forced_speed_duplex & E1000_ALL_100_SPEED) {\r\nctrl |= E1000_CTRL_SPD_100;\r\n*phy_ctrl |= MII_CR_SPEED_100;\r\n*phy_ctrl &= ~(MII_CR_SPEED_1000 | MII_CR_SPEED_10);\r\nhw_dbg("Forcing 100mb\n");\r\n} else {\r\nctrl &= ~(E1000_CTRL_SPD_1000 | E1000_CTRL_SPD_100);\r\n*phy_ctrl |= MII_CR_SPEED_10;\r\n*phy_ctrl &= ~(MII_CR_SPEED_1000 | MII_CR_SPEED_100);\r\nhw_dbg("Forcing 10mb\n");\r\n}\r\nigb_config_collision_dist(hw);\r\nwr32(E1000_CTRL, ctrl);\r\n}\r\ns32 igb_set_d3_lplu_state(struct e1000_hw *hw, bool active)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val = 0;\r\nu16 data;\r\nif (!(hw->phy.ops.read_reg))\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, IGP02E1000_PHY_POWER_MGMT, &data);\r\nif (ret_val)\r\ngoto out;\r\nif (!active) {\r\ndata &= ~IGP02E1000_PM_D3_LPLU;\r\nret_val = phy->ops.write_reg(hw, IGP02E1000_PHY_POWER_MGMT,\r\ndata);\r\nif (ret_val)\r\ngoto out;\r\nif (phy->smart_speed == e1000_smart_speed_on) {\r\nret_val = phy->ops.read_reg(hw,\r\nIGP01E1000_PHY_PORT_CONFIG,\r\n&data);\r\nif (ret_val)\r\ngoto out;\r\ndata |= IGP01E1000_PSCFR_SMART_SPEED;\r\nret_val = phy->ops.write_reg(hw,\r\nIGP01E1000_PHY_PORT_CONFIG,\r\ndata);\r\nif (ret_val)\r\ngoto out;\r\n} else if (phy->smart_speed == e1000_smart_speed_off) {\r\nret_val = phy->ops.read_reg(hw,\r\nIGP01E1000_PHY_PORT_CONFIG,\r\n&data);\r\nif (ret_val)\r\ngoto out;\r\ndata &= ~IGP01E1000_PSCFR_SMART_SPEED;\r\nret_val = phy->ops.write_reg(hw,\r\nIGP01E1000_PHY_PORT_CONFIG,\r\ndata);\r\nif (ret_val)\r\ngoto out;\r\n}\r\n} else if ((phy->autoneg_advertised == E1000_ALL_SPEED_DUPLEX) ||\r\n(phy->autoneg_advertised == E1000_ALL_NOT_GIG) ||\r\n(phy->autoneg_advertised == E1000_ALL_10_SPEED)) {\r\ndata |= IGP02E1000_PM_D3_LPLU;\r\nret_val = phy->ops.write_reg(hw, IGP02E1000_PHY_POWER_MGMT,\r\ndata);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, IGP01E1000_PHY_PORT_CONFIG,\r\n&data);\r\nif (ret_val)\r\ngoto out;\r\ndata &= ~IGP01E1000_PSCFR_SMART_SPEED;\r\nret_val = phy->ops.write_reg(hw, IGP01E1000_PHY_PORT_CONFIG,\r\ndata);\r\n}\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_check_downshift(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 phy_data, offset, mask;\r\nswitch (phy->type) {\r\ncase e1000_phy_i210:\r\ncase e1000_phy_m88:\r\ncase e1000_phy_gg82563:\r\noffset = M88E1000_PHY_SPEC_STATUS;\r\nmask = M88E1000_PSSR_DOWNSHIFT;\r\nbreak;\r\ncase e1000_phy_igp_2:\r\ncase e1000_phy_igp:\r\ncase e1000_phy_igp_3:\r\noffset = IGP01E1000_PHY_LINK_HEALTH;\r\nmask = IGP01E1000_PLHR_SS_DOWNGRADE;\r\nbreak;\r\ndefault:\r\nphy->speed_downgraded = false;\r\nret_val = 0;\r\ngoto out;\r\n}\r\nret_val = phy->ops.read_reg(hw, offset, &phy_data);\r\nif (!ret_val)\r\nphy->speed_downgraded = (phy_data & mask) ? true : false;\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_check_polarity_m88(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 data;\r\nret_val = phy->ops.read_reg(hw, M88E1000_PHY_SPEC_STATUS, &data);\r\nif (!ret_val)\r\nphy->cable_polarity = (data & M88E1000_PSSR_REV_POLARITY)\r\n? e1000_rev_polarity_reversed\r\n: e1000_rev_polarity_normal;\r\nreturn ret_val;\r\n}\r\nstatic s32 igb_check_polarity_igp(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 data, offset, mask;\r\nret_val = phy->ops.read_reg(hw, IGP01E1000_PHY_PORT_STATUS, &data);\r\nif (ret_val)\r\ngoto out;\r\nif ((data & IGP01E1000_PSSR_SPEED_MASK) ==\r\nIGP01E1000_PSSR_SPEED_1000MBPS) {\r\noffset = IGP01E1000_PHY_PCS_INIT_REG;\r\nmask = IGP01E1000_PHY_POLARITY_MASK;\r\n} else {\r\noffset = IGP01E1000_PHY_PORT_STATUS;\r\nmask = IGP01E1000_PSSR_POLARITY_REVERSED;\r\n}\r\nret_val = phy->ops.read_reg(hw, offset, &data);\r\nif (!ret_val)\r\nphy->cable_polarity = (data & mask)\r\n? e1000_rev_polarity_reversed\r\n: e1000_rev_polarity_normal;\r\nout:\r\nreturn ret_val;\r\n}\r\nstatic s32 igb_wait_autoneg(struct e1000_hw *hw)\r\n{\r\ns32 ret_val = 0;\r\nu16 i, phy_status;\r\nfor (i = PHY_AUTO_NEG_LIMIT; i > 0; i--) {\r\nret_val = hw->phy.ops.read_reg(hw, PHY_STATUS, &phy_status);\r\nif (ret_val)\r\nbreak;\r\nret_val = hw->phy.ops.read_reg(hw, PHY_STATUS, &phy_status);\r\nif (ret_val)\r\nbreak;\r\nif (phy_status & MII_SR_AUTONEG_COMPLETE)\r\nbreak;\r\nmsleep(100);\r\n}\r\nreturn ret_val;\r\n}\r\ns32 igb_phy_has_link(struct e1000_hw *hw, u32 iterations,\r\nu32 usec_interval, bool *success)\r\n{\r\ns32 ret_val = 0;\r\nu16 i, phy_status;\r\nfor (i = 0; i < iterations; i++) {\r\nret_val = hw->phy.ops.read_reg(hw, PHY_STATUS, &phy_status);\r\nif (ret_val && usec_interval > 0) {\r\nif (usec_interval >= 1000)\r\nmdelay(usec_interval/1000);\r\nelse\r\nudelay(usec_interval);\r\n}\r\nret_val = hw->phy.ops.read_reg(hw, PHY_STATUS, &phy_status);\r\nif (ret_val)\r\nbreak;\r\nif (phy_status & MII_SR_LINK_STATUS)\r\nbreak;\r\nif (usec_interval >= 1000)\r\nmdelay(usec_interval/1000);\r\nelse\r\nudelay(usec_interval);\r\n}\r\n*success = (i < iterations) ? true : false;\r\nreturn ret_val;\r\n}\r\ns32 igb_get_cable_length_m88(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 phy_data, index;\r\nret_val = phy->ops.read_reg(hw, M88E1000_PHY_SPEC_STATUS, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nindex = (phy_data & M88E1000_PSSR_CABLE_LENGTH) >>\r\nM88E1000_PSSR_CABLE_LENGTH_SHIFT;\r\nif (index >= ARRAY_SIZE(e1000_m88_cable_length_table) - 1) {\r\nret_val = -E1000_ERR_PHY;\r\ngoto out;\r\n}\r\nphy->min_cable_length = e1000_m88_cable_length_table[index];\r\nphy->max_cable_length = e1000_m88_cable_length_table[index + 1];\r\nphy->cable_length = (phy->min_cable_length + phy->max_cable_length) / 2;\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_get_cable_length_m88_gen2(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 phy_data, phy_data2, index, default_page, is_cm;\r\nint len_tot = 0;\r\nu16 len_min;\r\nu16 len_max;\r\nswitch (hw->phy.id) {\r\ncase M88E1543_E_PHY_ID:\r\ncase M88E1512_E_PHY_ID:\r\ncase I347AT4_E_PHY_ID:\r\ncase I210_I_PHY_ID:\r\nret_val = phy->ops.read_reg(hw, I347AT4_PAGE_SELECT,\r\n&default_page);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, I347AT4_PAGE_SELECT, 0x07);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, I347AT4_PCDC, &phy_data2);\r\nif (ret_val)\r\ngoto out;\r\nis_cm = !(phy_data2 & I347AT4_PCDC_CABLE_LENGTH_UNIT);\r\nret_val = phy->ops.read_reg(hw, I347AT4_PCDL0, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy->pair_length[0] = phy_data / (is_cm ? 100 : 1);\r\nlen_tot = phy->pair_length[0];\r\nlen_min = phy->pair_length[0];\r\nlen_max = phy->pair_length[0];\r\nret_val = phy->ops.read_reg(hw, I347AT4_PCDL1, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy->pair_length[1] = phy_data / (is_cm ? 100 : 1);\r\nlen_tot += phy->pair_length[1];\r\nlen_min = min(len_min, phy->pair_length[1]);\r\nlen_max = max(len_max, phy->pair_length[1]);\r\nret_val = phy->ops.read_reg(hw, I347AT4_PCDL2, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy->pair_length[2] = phy_data / (is_cm ? 100 : 1);\r\nlen_tot += phy->pair_length[2];\r\nlen_min = min(len_min, phy->pair_length[2]);\r\nlen_max = max(len_max, phy->pair_length[2]);\r\nret_val = phy->ops.read_reg(hw, I347AT4_PCDL3, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy->pair_length[3] = phy_data / (is_cm ? 100 : 1);\r\nlen_tot += phy->pair_length[3];\r\nlen_min = min(len_min, phy->pair_length[3]);\r\nlen_max = max(len_max, phy->pair_length[3]);\r\nphy->min_cable_length = len_min;\r\nphy->max_cable_length = len_max;\r\nphy->cable_length = len_tot / 4;\r\nret_val = phy->ops.write_reg(hw, I347AT4_PAGE_SELECT,\r\ndefault_page);\r\nif (ret_val)\r\ngoto out;\r\nbreak;\r\ncase M88E1112_E_PHY_ID:\r\nret_val = phy->ops.read_reg(hw, I347AT4_PAGE_SELECT,\r\n&default_page);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, I347AT4_PAGE_SELECT, 0x05);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, M88E1112_VCT_DSP_DISTANCE,\r\n&phy_data);\r\nif (ret_val)\r\ngoto out;\r\nindex = (phy_data & M88E1000_PSSR_CABLE_LENGTH) >>\r\nM88E1000_PSSR_CABLE_LENGTH_SHIFT;\r\nif (index >= ARRAY_SIZE(e1000_m88_cable_length_table) - 1) {\r\nret_val = -E1000_ERR_PHY;\r\ngoto out;\r\n}\r\nphy->min_cable_length = e1000_m88_cable_length_table[index];\r\nphy->max_cable_length = e1000_m88_cable_length_table[index + 1];\r\nphy->cable_length = (phy->min_cable_length +\r\nphy->max_cable_length) / 2;\r\nret_val = phy->ops.write_reg(hw, I347AT4_PAGE_SELECT,\r\ndefault_page);\r\nif (ret_val)\r\ngoto out;\r\nbreak;\r\ndefault:\r\nret_val = -E1000_ERR_PHY;\r\ngoto out;\r\n}\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_get_cable_length_igp_2(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val = 0;\r\nu16 phy_data, i, agc_value = 0;\r\nu16 cur_agc_index, max_agc_index = 0;\r\nu16 min_agc_index = ARRAY_SIZE(e1000_igp_2_cable_length_table) - 1;\r\nstatic const u16 agc_reg_array[IGP02E1000_PHY_CHANNEL_NUM] = {\r\nIGP02E1000_PHY_AGC_A,\r\nIGP02E1000_PHY_AGC_B,\r\nIGP02E1000_PHY_AGC_C,\r\nIGP02E1000_PHY_AGC_D\r\n};\r\nfor (i = 0; i < IGP02E1000_PHY_CHANNEL_NUM; i++) {\r\nret_val = phy->ops.read_reg(hw, agc_reg_array[i], &phy_data);\r\nif (ret_val)\r\ngoto out;\r\ncur_agc_index = (phy_data >> IGP02E1000_AGC_LENGTH_SHIFT) &\r\nIGP02E1000_AGC_LENGTH_MASK;\r\nif ((cur_agc_index >= ARRAY_SIZE(e1000_igp_2_cable_length_table)) ||\r\n(cur_agc_index == 0)) {\r\nret_val = -E1000_ERR_PHY;\r\ngoto out;\r\n}\r\nif (e1000_igp_2_cable_length_table[min_agc_index] >\r\ne1000_igp_2_cable_length_table[cur_agc_index])\r\nmin_agc_index = cur_agc_index;\r\nif (e1000_igp_2_cable_length_table[max_agc_index] <\r\ne1000_igp_2_cable_length_table[cur_agc_index])\r\nmax_agc_index = cur_agc_index;\r\nagc_value += e1000_igp_2_cable_length_table[cur_agc_index];\r\n}\r\nagc_value -= (e1000_igp_2_cable_length_table[min_agc_index] +\r\ne1000_igp_2_cable_length_table[max_agc_index]);\r\nagc_value /= (IGP02E1000_PHY_CHANNEL_NUM - 2);\r\nphy->min_cable_length = ((agc_value - IGP02E1000_AGC_RANGE) > 0) ?\r\n(agc_value - IGP02E1000_AGC_RANGE) : 0;\r\nphy->max_cable_length = agc_value + IGP02E1000_AGC_RANGE;\r\nphy->cable_length = (phy->min_cable_length + phy->max_cable_length) / 2;\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_get_phy_info_m88(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 phy_data;\r\nbool link;\r\nif (phy->media_type != e1000_media_type_copper) {\r\nhw_dbg("Phy info is only valid for copper media\n");\r\nret_val = -E1000_ERR_CONFIG;\r\ngoto out;\r\n}\r\nret_val = igb_phy_has_link(hw, 1, 0, &link);\r\nif (ret_val)\r\ngoto out;\r\nif (!link) {\r\nhw_dbg("Phy info is only valid if link is up\n");\r\nret_val = -E1000_ERR_CONFIG;\r\ngoto out;\r\n}\r\nret_val = phy->ops.read_reg(hw, M88E1000_PHY_SPEC_CTRL, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy->polarity_correction = (phy_data & M88E1000_PSCR_POLARITY_REVERSAL)\r\n? true : false;\r\nret_val = igb_check_polarity_m88(hw);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, M88E1000_PHY_SPEC_STATUS, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy->is_mdix = (phy_data & M88E1000_PSSR_MDIX) ? true : false;\r\nif ((phy_data & M88E1000_PSSR_SPEED) == M88E1000_PSSR_1000MBS) {\r\nret_val = phy->ops.get_cable_length(hw);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, PHY_1000T_STATUS, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy->local_rx = (phy_data & SR_1000T_LOCAL_RX_STATUS)\r\n? e1000_1000t_rx_status_ok\r\n: e1000_1000t_rx_status_not_ok;\r\nphy->remote_rx = (phy_data & SR_1000T_REMOTE_RX_STATUS)\r\n? e1000_1000t_rx_status_ok\r\n: e1000_1000t_rx_status_not_ok;\r\n} else {\r\nphy->cable_length = E1000_CABLE_LENGTH_UNDEFINED;\r\nphy->local_rx = e1000_1000t_rx_status_undefined;\r\nphy->remote_rx = e1000_1000t_rx_status_undefined;\r\n}\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_get_phy_info_igp(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 data;\r\nbool link;\r\nret_val = igb_phy_has_link(hw, 1, 0, &link);\r\nif (ret_val)\r\ngoto out;\r\nif (!link) {\r\nhw_dbg("Phy info is only valid if link is up\n");\r\nret_val = -E1000_ERR_CONFIG;\r\ngoto out;\r\n}\r\nphy->polarity_correction = true;\r\nret_val = igb_check_polarity_igp(hw);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, IGP01E1000_PHY_PORT_STATUS, &data);\r\nif (ret_val)\r\ngoto out;\r\nphy->is_mdix = (data & IGP01E1000_PSSR_MDIX) ? true : false;\r\nif ((data & IGP01E1000_PSSR_SPEED_MASK) ==\r\nIGP01E1000_PSSR_SPEED_1000MBPS) {\r\nret_val = phy->ops.get_cable_length(hw);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, PHY_1000T_STATUS, &data);\r\nif (ret_val)\r\ngoto out;\r\nphy->local_rx = (data & SR_1000T_LOCAL_RX_STATUS)\r\n? e1000_1000t_rx_status_ok\r\n: e1000_1000t_rx_status_not_ok;\r\nphy->remote_rx = (data & SR_1000T_REMOTE_RX_STATUS)\r\n? e1000_1000t_rx_status_ok\r\n: e1000_1000t_rx_status_not_ok;\r\n} else {\r\nphy->cable_length = E1000_CABLE_LENGTH_UNDEFINED;\r\nphy->local_rx = e1000_1000t_rx_status_undefined;\r\nphy->remote_rx = e1000_1000t_rx_status_undefined;\r\n}\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_phy_sw_reset(struct e1000_hw *hw)\r\n{\r\ns32 ret_val = 0;\r\nu16 phy_ctrl;\r\nif (!(hw->phy.ops.read_reg))\r\ngoto out;\r\nret_val = hw->phy.ops.read_reg(hw, PHY_CONTROL, &phy_ctrl);\r\nif (ret_val)\r\ngoto out;\r\nphy_ctrl |= MII_CR_RESET;\r\nret_val = hw->phy.ops.write_reg(hw, PHY_CONTROL, phy_ctrl);\r\nif (ret_val)\r\ngoto out;\r\nudelay(1);\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_phy_hw_reset(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu32 ctrl;\r\nret_val = igb_check_reset_block(hw);\r\nif (ret_val) {\r\nret_val = 0;\r\ngoto out;\r\n}\r\nret_val = phy->ops.acquire(hw);\r\nif (ret_val)\r\ngoto out;\r\nctrl = rd32(E1000_CTRL);\r\nwr32(E1000_CTRL, ctrl | E1000_CTRL_PHY_RST);\r\nwrfl();\r\nudelay(phy->reset_delay_us);\r\nwr32(E1000_CTRL, ctrl);\r\nwrfl();\r\nudelay(150);\r\nphy->ops.release(hw);\r\nret_val = phy->ops.get_cfg_done(hw);\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_phy_init_script_igp3(struct e1000_hw *hw)\r\n{\r\nhw_dbg("Running IGP 3 PHY init script\n");\r\nhw->phy.ops.write_reg(hw, 0x2F5B, 0x9018);\r\nhw->phy.ops.write_reg(hw, 0x2F52, 0x0000);\r\nhw->phy.ops.write_reg(hw, 0x2FB1, 0x8B24);\r\nhw->phy.ops.write_reg(hw, 0x2FB2, 0xF8F0);\r\nhw->phy.ops.write_reg(hw, 0x2010, 0x10B0);\r\nhw->phy.ops.write_reg(hw, 0x2011, 0x0000);\r\nhw->phy.ops.write_reg(hw, 0x20DD, 0x249A);\r\nhw->phy.ops.write_reg(hw, 0x20DE, 0x00D3);\r\nhw->phy.ops.write_reg(hw, 0x28B4, 0x04CE);\r\nhw->phy.ops.write_reg(hw, 0x2F70, 0x29E4);\r\nhw->phy.ops.write_reg(hw, 0x0000, 0x0140);\r\nhw->phy.ops.write_reg(hw, 0x1F30, 0x1606);\r\nhw->phy.ops.write_reg(hw, 0x1F31, 0xB814);\r\nhw->phy.ops.write_reg(hw, 0x1F35, 0x002A);\r\nhw->phy.ops.write_reg(hw, 0x1F3E, 0x0067);\r\nhw->phy.ops.write_reg(hw, 0x1F54, 0x0065);\r\nhw->phy.ops.write_reg(hw, 0x1F55, 0x002A);\r\nhw->phy.ops.write_reg(hw, 0x1F56, 0x002A);\r\nhw->phy.ops.write_reg(hw, 0x1F72, 0x3FB0);\r\nhw->phy.ops.write_reg(hw, 0x1F76, 0xC0FF);\r\nhw->phy.ops.write_reg(hw, 0x1F77, 0x1DEC);\r\nhw->phy.ops.write_reg(hw, 0x1F78, 0xF9EF);\r\nhw->phy.ops.write_reg(hw, 0x1F79, 0x0210);\r\nhw->phy.ops.write_reg(hw, 0x1895, 0x0003);\r\nhw->phy.ops.write_reg(hw, 0x1796, 0x0008);\r\nhw->phy.ops.write_reg(hw, 0x1798, 0xD008);\r\nhw->phy.ops.write_reg(hw, 0x1898, 0xD918);\r\nhw->phy.ops.write_reg(hw, 0x187A, 0x0800);\r\nhw->phy.ops.write_reg(hw, 0x0019, 0x008D);\r\nhw->phy.ops.write_reg(hw, 0x001B, 0x2080);\r\nhw->phy.ops.write_reg(hw, 0x0014, 0x0045);\r\nhw->phy.ops.write_reg(hw, 0x0000, 0x1340);\r\nreturn 0;\r\n}\r\ns32 igb_initialize_M88E1512_phy(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val = 0;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1543_PAGE_ADDR, 0x00FF);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_2, 0x214B);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_1, 0x2144);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_2, 0x0C28);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_1, 0x2146);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_2, 0xB233);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_1, 0x214D);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_2, 0xCC0C);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_1, 0x2159);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1543_PAGE_ADDR, 0x00FB);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_3, 0x000D);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1543_PAGE_ADDR, 0x12);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_MODE, 0x8001);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1543_PAGE_ADDR, 0);\r\nif (ret_val)\r\ngoto out;\r\nret_val = igb_phy_sw_reset(hw);\r\nif (ret_val) {\r\nhw_dbg("Error committing the PHY changes\n");\r\nreturn ret_val;\r\n}\r\nusleep_range(1000, 2000);\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_initialize_M88E1543_phy(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val = 0;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1543_PAGE_ADDR, 0x00FF);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_2, 0x214B);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_1, 0x2144);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_2, 0x0C28);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_1, 0x2146);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_2, 0xB233);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_1, 0x214D);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_2, 0xDC0C);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_1, 0x2159);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1543_PAGE_ADDR, 0x00FB);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_CFG_REG_3, 0x0C0D);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1543_PAGE_ADDR, 0x12);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1512_MODE, 0x8001);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1543_PAGE_ADDR, 0x1);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1543_FIBER_CTRL, 0x9140);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.write_reg(hw, E1000_M88E1543_PAGE_ADDR, 0);\r\nif (ret_val)\r\ngoto out;\r\nret_val = igb_phy_sw_reset(hw);\r\nif (ret_val) {\r\nhw_dbg("Error committing the PHY changes\n");\r\nreturn ret_val;\r\n}\r\nusleep_range(1000, 2000);\r\nout:\r\nreturn ret_val;\r\n}\r\nvoid igb_power_up_phy_copper(struct e1000_hw *hw)\r\n{\r\nu16 mii_reg = 0;\r\nhw->phy.ops.read_reg(hw, PHY_CONTROL, &mii_reg);\r\nmii_reg &= ~MII_CR_POWER_DOWN;\r\nhw->phy.ops.write_reg(hw, PHY_CONTROL, mii_reg);\r\n}\r\nvoid igb_power_down_phy_copper(struct e1000_hw *hw)\r\n{\r\nu16 mii_reg = 0;\r\nhw->phy.ops.read_reg(hw, PHY_CONTROL, &mii_reg);\r\nmii_reg |= MII_CR_POWER_DOWN;\r\nhw->phy.ops.write_reg(hw, PHY_CONTROL, mii_reg);\r\nusleep_range(1000, 2000);\r\n}\r\nstatic s32 igb_check_polarity_82580(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 data;\r\nret_val = phy->ops.read_reg(hw, I82580_PHY_STATUS_2, &data);\r\nif (!ret_val)\r\nphy->cable_polarity = (data & I82580_PHY_STATUS2_REV_POLARITY)\r\n? e1000_rev_polarity_reversed\r\n: e1000_rev_polarity_normal;\r\nreturn ret_val;\r\n}\r\ns32 igb_phy_force_speed_duplex_82580(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 phy_data;\r\nbool link;\r\nret_val = phy->ops.read_reg(hw, PHY_CONTROL, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nigb_phy_force_speed_duplex_setup(hw, &phy_data);\r\nret_val = phy->ops.write_reg(hw, PHY_CONTROL, phy_data);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, I82580_PHY_CTRL_2, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nphy_data &= ~I82580_PHY_CTRL2_MDIX_CFG_MASK;\r\nret_val = phy->ops.write_reg(hw, I82580_PHY_CTRL_2, phy_data);\r\nif (ret_val)\r\ngoto out;\r\nhw_dbg("I82580_PHY_CTRL_2: %X\n", phy_data);\r\nudelay(1);\r\nif (phy->autoneg_wait_to_complete) {\r\nhw_dbg("Waiting for forced speed/duplex link on 82580 phy\n");\r\nret_val = igb_phy_has_link(hw, PHY_FORCE_LIMIT, 100000, &link);\r\nif (ret_val)\r\ngoto out;\r\nif (!link)\r\nhw_dbg("Link taking longer than expected.\n");\r\nret_val = igb_phy_has_link(hw, PHY_FORCE_LIMIT, 100000, &link);\r\nif (ret_val)\r\ngoto out;\r\n}\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_get_phy_info_82580(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 data;\r\nbool link;\r\nret_val = igb_phy_has_link(hw, 1, 0, &link);\r\nif (ret_val)\r\ngoto out;\r\nif (!link) {\r\nhw_dbg("Phy info is only valid if link is up\n");\r\nret_val = -E1000_ERR_CONFIG;\r\ngoto out;\r\n}\r\nphy->polarity_correction = true;\r\nret_val = igb_check_polarity_82580(hw);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, I82580_PHY_STATUS_2, &data);\r\nif (ret_val)\r\ngoto out;\r\nphy->is_mdix = (data & I82580_PHY_STATUS2_MDIX) ? true : false;\r\nif ((data & I82580_PHY_STATUS2_SPEED_MASK) ==\r\nI82580_PHY_STATUS2_SPEED_1000MBPS) {\r\nret_val = hw->phy.ops.get_cable_length(hw);\r\nif (ret_val)\r\ngoto out;\r\nret_val = phy->ops.read_reg(hw, PHY_1000T_STATUS, &data);\r\nif (ret_val)\r\ngoto out;\r\nphy->local_rx = (data & SR_1000T_LOCAL_RX_STATUS)\r\n? e1000_1000t_rx_status_ok\r\n: e1000_1000t_rx_status_not_ok;\r\nphy->remote_rx = (data & SR_1000T_REMOTE_RX_STATUS)\r\n? e1000_1000t_rx_status_ok\r\n: e1000_1000t_rx_status_not_ok;\r\n} else {\r\nphy->cable_length = E1000_CABLE_LENGTH_UNDEFINED;\r\nphy->local_rx = e1000_1000t_rx_status_undefined;\r\nphy->remote_rx = e1000_1000t_rx_status_undefined;\r\n}\r\nout:\r\nreturn ret_val;\r\n}\r\ns32 igb_get_cable_length_82580(struct e1000_hw *hw)\r\n{\r\nstruct e1000_phy_info *phy = &hw->phy;\r\ns32 ret_val;\r\nu16 phy_data, length;\r\nret_val = phy->ops.read_reg(hw, I82580_PHY_DIAG_STATUS, &phy_data);\r\nif (ret_val)\r\ngoto out;\r\nlength = (phy_data & I82580_DSTATUS_CABLE_LENGTH) >>\r\nI82580_DSTATUS_CABLE_LENGTH_SHIFT;\r\nif (length == E1000_CABLE_LENGTH_UNDEFINED)\r\nret_val = -E1000_ERR_PHY;\r\nphy->cable_length = length;\r\nout:\r\nreturn ret_val;\r\n}\r\nstatic s32 igb_set_master_slave_mode(struct e1000_hw *hw)\r\n{\r\ns32 ret_val;\r\nu16 phy_data;\r\nret_val = hw->phy.ops.read_reg(hw, PHY_1000T_CTRL, &phy_data);\r\nif (ret_val)\r\nreturn ret_val;\r\nhw->phy.original_ms_type = (phy_data & CR_1000T_MS_ENABLE) ?\r\n((phy_data & CR_1000T_MS_VALUE) ?\r\ne1000_ms_force_master :\r\ne1000_ms_force_slave) : e1000_ms_auto;\r\nswitch (hw->phy.ms_type) {\r\ncase e1000_ms_force_master:\r\nphy_data |= (CR_1000T_MS_ENABLE | CR_1000T_MS_VALUE);\r\nbreak;\r\ncase e1000_ms_force_slave:\r\nphy_data |= CR_1000T_MS_ENABLE;\r\nphy_data &= ~(CR_1000T_MS_VALUE);\r\nbreak;\r\ncase e1000_ms_auto:\r\nphy_data &= ~CR_1000T_MS_ENABLE;\r\ndefault:\r\nbreak;\r\n}\r\nreturn hw->phy.ops.write_reg(hw, PHY_1000T_CTRL, phy_data);\r\n}

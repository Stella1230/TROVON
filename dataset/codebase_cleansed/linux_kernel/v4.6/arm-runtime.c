static bool __init efi_virtmap_init(void)\r\n{\r\nefi_memory_desc_t *md;\r\nefi_mm.pgd = pgd_alloc(&efi_mm);\r\ninit_new_context(NULL, &efi_mm);\r\nfor_each_efi_memory_desc(&memmap, md) {\r\nphys_addr_t phys = md->phys_addr;\r\nint ret;\r\nif (!(md->attribute & EFI_MEMORY_RUNTIME))\r\ncontinue;\r\nif (md->virt_addr == 0)\r\nreturn false;\r\nret = efi_create_mapping(&efi_mm, md);\r\nif (!ret) {\r\npr_info(" EFI remap %pa => %p\n",\r\n&phys, (void *)(unsigned long)md->virt_addr);\r\n} else {\r\npr_warn(" EFI remap %pa: failed to create mapping (%d)\n",\r\n&phys, ret);\r\nreturn false;\r\n}\r\n}\r\nreturn true;\r\n}\r\nstatic int __init arm_enable_runtime_services(void)\r\n{\r\nu64 mapsize;\r\nif (!efi_enabled(EFI_BOOT)) {\r\npr_info("EFI services will not be available.\n");\r\nreturn 0;\r\n}\r\nif (efi_runtime_disabled()) {\r\npr_info("EFI runtime services will be disabled.\n");\r\nreturn 0;\r\n}\r\npr_info("Remapping and enabling EFI services.\n");\r\nmapsize = memmap.map_end - memmap.map;\r\nmemmap.map = (__force void *)ioremap_cache(memmap.phys_map,\r\nmapsize);\r\nif (!memmap.map) {\r\npr_err("Failed to remap EFI memory map\n");\r\nreturn -ENOMEM;\r\n}\r\nmemmap.map_end = memmap.map + mapsize;\r\nefi.memmap = &memmap;\r\nefi.systab = (__force void *)ioremap_cache(efi_system_table,\r\nsizeof(efi_system_table_t));\r\nif (!efi.systab) {\r\npr_err("Failed to remap EFI System Table\n");\r\nreturn -ENOMEM;\r\n}\r\nset_bit(EFI_SYSTEM_TABLES, &efi.flags);\r\nif (!efi_virtmap_init()) {\r\npr_err("No UEFI virtual mapping was installed -- runtime services will not be available\n");\r\nreturn -ENOMEM;\r\n}\r\nefi_native_runtime_setup();\r\nset_bit(EFI_RUNTIME_SERVICES, &efi.flags);\r\nefi.runtime_version = efi.systab->hdr.revision;\r\nreturn 0;\r\n}\r\nvoid efi_virtmap_load(void)\r\n{\r\npreempt_disable();\r\nefi_set_pgd(&efi_mm);\r\n}\r\nvoid efi_virtmap_unload(void)\r\n{\r\nefi_set_pgd(current->active_mm);\r\npreempt_enable();\r\n}

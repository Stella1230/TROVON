static int apci3501_config_insn_timer(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci3501_private *devpriv = dev->private;\r\nunsigned int ctrl;\r\nif (data[0] != ADDIDATA_WATCHDOG &&\r\ndata[0] != ADDIDATA_TIMER)\r\nreturn -EINVAL;\r\ndevpriv->tsk_Current = current;\r\ndevpriv->timer_mode = data[0];\r\nif (devpriv->timer_mode == ADDIDATA_WATCHDOG) {\r\nctrl = 0;\r\n} else {\r\nctrl = inl(devpriv->tcw + ADDI_TCW_CTRL_REG);\r\nctrl &= ~(ADDI_TCW_CTRL_GATE | ADDI_TCW_CTRL_TRIG |\r\nADDI_TCW_CTRL_ENA);\r\n}\r\noutl(ctrl, devpriv->tcw + ADDI_TCW_CTRL_REG);\r\nctrl = (data[1] == 1) ? ADDI_TCW_CTRL_IRQ_ENA : 0;\r\noutl(ctrl, devpriv->tcw + ADDI_TCW_CTRL_REG);\r\noutl(data[2], devpriv->tcw + ADDI_TCW_TIMEBASE_REG);\r\noutl(data[3], devpriv->tcw + ADDI_TCW_RELOAD_REG);\r\nctrl = inl(devpriv->tcw + ADDI_TCW_CTRL_REG);\r\nif (devpriv->timer_mode == ADDIDATA_WATCHDOG) {\r\nctrl |= ~(ADDI_TCW_CTRL_CNT_UP | ADDI_TCW_CTRL_EXT_CLK_MASK |\r\nADDI_TCW_CTRL_MODE_MASK | ADDI_TCW_CTRL_GATE |\r\nADDI_TCW_CTRL_TRIG | ADDI_TCW_CTRL_TIMER_ENA |\r\nADDI_TCW_CTRL_RESET_ENA | ADDI_TCW_CTRL_WARN_ENA |\r\nADDI_TCW_CTRL_IRQ_ENA | ADDI_TCW_CTRL_ENA);\r\n} else {\r\nctrl &= ~(ADDI_TCW_CTRL_CNTR_ENA | ADDI_TCW_CTRL_MODE_MASK |\r\nADDI_TCW_CTRL_GATE | ADDI_TCW_CTRL_TRIG |\r\nADDI_TCW_CTRL_TIMER_ENA | ADDI_TCW_CTRL_RESET_ENA |\r\nADDI_TCW_CTRL_WARN_ENA | ADDI_TCW_CTRL_ENA);\r\nctrl |= ADDI_TCW_CTRL_MODE(2) | ADDI_TCW_CTRL_TIMER_ENA;\r\n}\r\noutl(ctrl, devpriv->tcw + ADDI_TCW_CTRL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci3501_write_insn_timer(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci3501_private *devpriv = dev->private;\r\nunsigned int ctrl;\r\nif (devpriv->timer_mode == ADDIDATA_WATCHDOG ||\r\ndevpriv->timer_mode == ADDIDATA_TIMER) {\r\nctrl = inl(devpriv->tcw + ADDI_TCW_CTRL_REG);\r\nctrl &= ~(ADDI_TCW_CTRL_GATE | ADDI_TCW_CTRL_TRIG);\r\nif (data[1] == 1) {\r\nctrl |= ADDI_TCW_CTRL_ENA;\r\n} else if (data[1] == 0) {\r\nif (devpriv->timer_mode == ADDIDATA_WATCHDOG)\r\nctrl = 0;\r\nelse\r\nctrl &= ~ADDI_TCW_CTRL_ENA;\r\n} else if (data[1] == 2) {\r\nctrl |= ADDI_TCW_CTRL_TRIG;\r\n}\r\noutl(ctrl, devpriv->tcw + ADDI_TCW_CTRL_REG);\r\n}\r\ninl(devpriv->tcw + ADDI_TCW_STATUS_REG);\r\nreturn insn->n;\r\n}\r\nstatic int apci3501_read_insn_timer(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct apci3501_private *devpriv = dev->private;\r\nif (devpriv->timer_mode != ADDIDATA_TIMER &&\r\ndevpriv->timer_mode != ADDIDATA_WATCHDOG)\r\nreturn -EINVAL;\r\ndata[0] = inl(devpriv->tcw + ADDI_TCW_STATUS_REG) &\r\nADDI_TCW_STATUS_OVERFLOW;\r\ndata[1] = inl(devpriv->tcw + ADDI_TCW_VAL_REG);\r\nreturn insn->n;\r\n}

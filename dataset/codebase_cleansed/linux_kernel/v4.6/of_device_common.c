unsigned int irq_of_parse_and_map(struct device_node *node, int index)\r\n{\r\nstruct platform_device *op = of_find_device_by_node(node);\r\nif (!op || index >= op->archdata.num_irqs)\r\nreturn 0;\r\nreturn op->archdata.irqs[index];\r\n}\r\nint of_address_to_resource(struct device_node *node, int index,\r\nstruct resource *r)\r\n{\r\nstruct platform_device *op = of_find_device_by_node(node);\r\nif (!op || index >= op->num_resources)\r\nreturn -EINVAL;\r\nmemcpy(r, &op->archdata.resource[index], sizeof(*r));\r\nreturn 0;\r\n}\r\nvoid __iomem *of_iomap(struct device_node *node, int index)\r\n{\r\nstruct platform_device *op = of_find_device_by_node(node);\r\nstruct resource *r;\r\nif (!op || index >= op->num_resources)\r\nreturn NULL;\r\nr = &op->archdata.resource[index];\r\nreturn of_ioremap(r, 0, resource_size(r), (char *) r->name);\r\n}\r\nvoid of_propagate_archdata(struct platform_device *bus)\r\n{\r\nstruct dev_archdata *bus_sd = &bus->dev.archdata;\r\nstruct device_node *bus_dp = bus->dev.of_node;\r\nstruct device_node *dp;\r\nfor (dp = bus_dp->child; dp; dp = dp->sibling) {\r\nstruct platform_device *op = of_find_device_by_node(dp);\r\nop->dev.archdata.iommu = bus_sd->iommu;\r\nop->dev.archdata.stc = bus_sd->stc;\r\nop->dev.archdata.host_controller = bus_sd->host_controller;\r\nop->dev.archdata.numa_node = bus_sd->numa_node;\r\nif (dp->child)\r\nof_propagate_archdata(op);\r\n}\r\n}\r\nstatic void get_cells(struct device_node *dp, int *addrc, int *sizec)\r\n{\r\nif (addrc)\r\n*addrc = of_n_addr_cells(dp);\r\nif (sizec)\r\n*sizec = of_n_size_cells(dp);\r\n}\r\nvoid of_bus_default_count_cells(struct device_node *dev, int *addrc, int *sizec)\r\n{\r\nget_cells(dev, addrc, sizec);\r\n}\r\nint of_out_of_range(const u32 *addr, const u32 *base,\r\nconst u32 *size, int na, int ns)\r\n{\r\nu64 a = of_read_addr(addr, na);\r\nu64 b = of_read_addr(base, na);\r\nif (a < b)\r\nreturn 1;\r\nb += of_read_addr(size, ns);\r\nif (a >= b)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nint of_bus_default_map(u32 *addr, const u32 *range, int na, int ns, int pna)\r\n{\r\nu32 result[OF_MAX_ADDR_CELLS];\r\nint i;\r\nif (ns > 2) {\r\nprintk("of_device: Cannot handle size cells (%d) > 2.", ns);\r\nreturn -EINVAL;\r\n}\r\nif (of_out_of_range(addr, range, range + na + pna, na, ns))\r\nreturn -EINVAL;\r\nmemcpy(result, range + na, pna * 4);\r\nfor (i = 0; i < na; i++)\r\nresult[pna - 1 - i] +=\r\n(addr[na - 1 - i] -\r\nrange[na - 1 - i]);\r\nmemcpy(addr, result, pna * 4);\r\nreturn 0;\r\n}\r\nunsigned long of_bus_default_get_flags(const u32 *addr, unsigned long flags)\r\n{\r\nif (flags)\r\nreturn flags;\r\nreturn IORESOURCE_MEM;\r\n}\r\nint of_bus_sbus_match(struct device_node *np)\r\n{\r\nstruct device_node *dp = np;\r\nwhile (dp) {\r\nif (!strcmp(dp->name, "sbus") ||\r\n!strcmp(dp->name, "sbi"))\r\nreturn 1;\r\nif (of_find_property(dp, "ranges", NULL) != NULL)\r\nbreak;\r\ndp = dp->parent;\r\n}\r\nreturn 0;\r\n}\r\nvoid of_bus_sbus_count_cells(struct device_node *child, int *addrc, int *sizec)\r\n{\r\nif (addrc)\r\n*addrc = 2;\r\nif (sizec)\r\n*sizec = 1;\r\n}

static int aq100x_reset(struct cphy *phy, int wait)\r\n{\r\nint err = t3_phy_reset(phy, MDIO_MMD_VEND1, 3000);\r\nif (err)\r\nCH_WARN(phy->adapter, "PHY%d: reset failed (0x%x).\n",\r\nphy->mdio.prtad, err);\r\nreturn err;\r\n}\r\nstatic int aq100x_intr_enable(struct cphy *phy)\r\n{\r\nint err = t3_mdio_write(phy, MDIO_MMD_PMAPMD, AQ_IMASK_PMA, IMASK_PMA);\r\nif (err)\r\nreturn err;\r\nerr = t3_mdio_write(phy, MDIO_MMD_VEND1, AQ_IMASK_GLOBAL, IMASK_GLOBAL);\r\nreturn err;\r\n}\r\nstatic int aq100x_intr_disable(struct cphy *phy)\r\n{\r\nreturn t3_mdio_write(phy, MDIO_MMD_VEND1, AQ_IMASK_GLOBAL, 0);\r\n}\r\nstatic int aq100x_intr_clear(struct cphy *phy)\r\n{\r\nunsigned int v;\r\nt3_mdio_read(phy, MDIO_MMD_VEND1, AQ_IFLAG_GLOBAL, &v);\r\nt3_mdio_read(phy, MDIO_MMD_PMAPMD, MDIO_STAT1, &v);\r\nreturn 0;\r\n}\r\nstatic int aq100x_intr_handler(struct cphy *phy)\r\n{\r\nint err;\r\nunsigned int cause, v;\r\nerr = t3_mdio_read(phy, MDIO_MMD_VEND1, AQ_IFLAG_GLOBAL, &cause);\r\nif (err)\r\nreturn err;\r\nt3_mdio_read(phy, MDIO_MMD_PMAPMD, MDIO_STAT1, &v);\r\nreturn cphy_cause_link_change;\r\n}\r\nstatic int aq100x_power_down(struct cphy *phy, int off)\r\n{\r\nreturn mdio_set_flag(&phy->mdio, phy->mdio.prtad,\r\nMDIO_MMD_PMAPMD, MDIO_CTRL1,\r\nMDIO_CTRL1_LPOWER, off);\r\n}\r\nstatic int aq100x_autoneg_enable(struct cphy *phy)\r\n{\r\nint err;\r\nerr = aq100x_power_down(phy, 0);\r\nif (!err)\r\nerr = mdio_set_flag(&phy->mdio, phy->mdio.prtad,\r\nMDIO_MMD_AN, MDIO_CTRL1,\r\nBMCR_ANENABLE | BMCR_ANRESTART, 1);\r\nreturn err;\r\n}\r\nstatic int aq100x_autoneg_restart(struct cphy *phy)\r\n{\r\nint err;\r\nerr = aq100x_power_down(phy, 0);\r\nif (!err)\r\nerr = mdio_set_flag(&phy->mdio, phy->mdio.prtad,\r\nMDIO_MMD_AN, MDIO_CTRL1,\r\nBMCR_ANENABLE | BMCR_ANRESTART, 1);\r\nreturn err;\r\n}\r\nstatic int aq100x_advertise(struct cphy *phy, unsigned int advertise_map)\r\n{\r\nunsigned int adv;\r\nint err;\r\nadv = 0;\r\nif (advertise_map & ADVERTISED_10000baseT_Full)\r\nadv |= ADV_10G_FULL;\r\nerr = t3_mdio_change_bits(phy, MDIO_MMD_AN, MDIO_AN_10GBT_CTRL,\r\nADV_10G_FULL, adv);\r\nif (err)\r\nreturn err;\r\nadv = 0;\r\nif (advertise_map & ADVERTISED_1000baseT_Full)\r\nadv |= ADV_1G_FULL;\r\nif (advertise_map & ADVERTISED_1000baseT_Half)\r\nadv |= ADV_1G_HALF;\r\nerr = t3_mdio_change_bits(phy, MDIO_MMD_AN, AQ_1G_CTRL,\r\nADV_1G_FULL | ADV_1G_HALF, adv);\r\nif (err)\r\nreturn err;\r\nadv = 0;\r\nif (advertise_map & ADVERTISED_100baseT_Half)\r\nadv |= ADVERTISE_100HALF;\r\nif (advertise_map & ADVERTISED_100baseT_Full)\r\nadv |= ADVERTISE_100FULL;\r\nif (advertise_map & ADVERTISED_Pause)\r\nadv |= ADVERTISE_PAUSE_CAP;\r\nif (advertise_map & ADVERTISED_Asym_Pause)\r\nadv |= ADVERTISE_PAUSE_ASYM;\r\nerr = t3_mdio_change_bits(phy, MDIO_MMD_AN, MDIO_AN_ADVERTISE,\r\n0xfe0, adv);\r\nreturn err;\r\n}\r\nstatic int aq100x_set_loopback(struct cphy *phy, int mmd, int dir, int enable)\r\n{\r\nreturn mdio_set_flag(&phy->mdio, phy->mdio.prtad,\r\nMDIO_MMD_PMAPMD, MDIO_CTRL1,\r\nBMCR_LOOPBACK, enable);\r\n}\r\nstatic int aq100x_set_speed_duplex(struct cphy *phy, int speed, int duplex)\r\n{\r\nreturn -1;\r\n}\r\nstatic int aq100x_get_link_status(struct cphy *phy, int *link_ok,\r\nint *speed, int *duplex, int *fc)\r\n{\r\nint err;\r\nunsigned int v;\r\nif (link_ok) {\r\nerr = t3_mdio_read(phy, MDIO_MMD_PMAPMD, AQ_LINK_STAT, &v);\r\nif (err)\r\nreturn err;\r\n*link_ok = v & 1;\r\nif (!*link_ok)\r\nreturn 0;\r\n}\r\nerr = t3_mdio_read(phy, MDIO_MMD_AN, AQ_ANEG_STAT, &v);\r\nif (err)\r\nreturn err;\r\nif (speed) {\r\nswitch (v & 0x6) {\r\ncase 0x6:\r\n*speed = SPEED_10000;\r\nbreak;\r\ncase 0x4:\r\n*speed = SPEED_1000;\r\nbreak;\r\ncase 0x2:\r\n*speed = SPEED_100;\r\nbreak;\r\ncase 0x0:\r\n*speed = SPEED_10;\r\nbreak;\r\n}\r\n}\r\nif (duplex)\r\n*duplex = v & 1 ? DUPLEX_FULL : DUPLEX_HALF;\r\nreturn 0;\r\n}\r\nint t3_aq100x_phy_prep(struct cphy *phy, struct adapter *adapter, int phy_addr,\r\nconst struct mdio_ops *mdio_ops)\r\n{\r\nunsigned int v, v2, gpio, wait;\r\nint err;\r\ncphy_init(phy, adapter, phy_addr, &aq100x_ops, mdio_ops,\r\nSUPPORTED_1000baseT_Full | SUPPORTED_10000baseT_Full |\r\nSUPPORTED_TP | SUPPORTED_Autoneg | SUPPORTED_AUI,\r\n"1000/10GBASE-T");\r\ngpio = phy_addr ? F_GPIO10_OUT_VAL : F_GPIO6_OUT_VAL;\r\nt3_set_reg_field(adapter, A_T3DBG_GPIO_EN, gpio, 0);\r\nmsleep(1);\r\nt3_set_reg_field(adapter, A_T3DBG_GPIO_EN, gpio, gpio);\r\nmsleep(1000);\r\nwait = 500;\r\ndo {\r\nerr = t3_mdio_read(phy, MDIO_MMD_VEND1, MDIO_CTRL1, &v);\r\nif (err || v == 0xffff) {\r\nCH_WARN(adapter, "PHY%d: reset failed (0x%x, 0x%x).\n",\r\nphy_addr, err, v);\r\ngoto done;\r\n}\r\nv &= AQ_RESET;\r\nif (v)\r\nmsleep(10);\r\n} while (v && --wait);\r\nif (v) {\r\nCH_WARN(adapter, "PHY%d: reset timed out (0x%x).\n",\r\nphy_addr, v);\r\ngoto done;\r\n}\r\nwait = (500 - wait) * 10 + 1000;\r\nif (wait > 3000)\r\nCH_WARN(adapter, "PHY%d: reset took %ums\n", phy_addr, wait);\r\nt3_mdio_read(phy, MDIO_MMD_VEND1, AQ_FW_VERSION, &v);\r\nif (v != 101)\r\nCH_WARN(adapter, "PHY%d: unsupported firmware %d\n",\r\nphy_addr, v);\r\nerr = t3_mdio_read(phy, MDIO_MMD_VEND1, MDIO_CTRL1, &v);\r\nif (err)\r\nreturn err;\r\nif (v & AQ_LOWPOWER) {\r\nerr = t3_mdio_change_bits(phy, MDIO_MMD_VEND1, MDIO_CTRL1,\r\nAQ_LOWPOWER, 0);\r\nif (err)\r\nreturn err;\r\nmsleep(10);\r\n} else\r\nCH_WARN(adapter, "PHY%d does not start in low power mode.\n",\r\nphy_addr);\r\nv = v2 = 0;\r\nt3_mdio_read(phy, MDIO_MMD_PHYXS, AQ_XAUI_RX_CFG, &v);\r\nt3_mdio_read(phy, MDIO_MMD_PHYXS, AQ_XAUI_TX_CFG, &v2);\r\nif (v != 0x1b || v2 != 0x1b)\r\nCH_WARN(adapter,\r\n"PHY%d: incorrect XAUI settings (0x%x, 0x%x).\n",\r\nphy_addr, v, v2);\r\ndone:\r\nreturn err;\r\n}

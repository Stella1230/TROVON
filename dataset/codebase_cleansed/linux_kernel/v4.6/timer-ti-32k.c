static inline struct ti_32k *to_ti_32k(struct clocksource *cs)\r\n{\r\nreturn container_of(cs, struct ti_32k, cs);\r\n}\r\nstatic cycle_t ti_32k_read_cycles(struct clocksource *cs)\r\n{\r\nstruct ti_32k *ti = to_ti_32k(cs);\r\nreturn (cycle_t)readl_relaxed(ti->counter);\r\n}\r\nstatic u64 notrace omap_32k_read_sched_clock(void)\r\n{\r\nreturn ti_32k_read_cycles(&ti_32k_timer.cs);\r\n}\r\nstatic void __init ti_32k_timer_init(struct device_node *np)\r\n{\r\nint ret;\r\nti_32k_timer.base = of_iomap(np, 0);\r\nif (!ti_32k_timer.base) {\r\npr_err("Can't ioremap 32k timer base\n");\r\nreturn;\r\n}\r\nti_32k_timer.counter = ti_32k_timer.base;\r\nif (readl_relaxed(ti_32k_timer.base + OMAP2_32KSYNCNT_REV_OFF) &\r\nOMAP2_32KSYNCNT_REV_SCHEME)\r\nti_32k_timer.counter += OMAP2_32KSYNCNT_CR_OFF_HIGH;\r\nelse\r\nti_32k_timer.counter += OMAP2_32KSYNCNT_CR_OFF_LOW;\r\nret = clocksource_register_hz(&ti_32k_timer.cs, 32768);\r\nif (ret) {\r\npr_err("32k_counter: can't register clocksource\n");\r\nreturn;\r\n}\r\nsched_clock_register(omap_32k_read_sched_clock, 32, 32768);\r\npr_info("OMAP clocksource: 32k_counter at 32768 Hz\n");\r\n}

static int wm831x_backup_read_voltage(struct wm831x *wm831x,\r\nenum wm831x_auxadc src,\r\nunion power_supply_propval *val)\r\n{\r\nint ret;\r\nret = wm831x_auxadc_read_uv(wm831x, src);\r\nif (ret >= 0)\r\nval->intval = ret;\r\nreturn ret;\r\n}\r\nstatic void wm831x_config_backup(struct wm831x *wm831x)\r\n{\r\nstruct wm831x_pdata *wm831x_pdata = wm831x->dev->platform_data;\r\nstruct wm831x_backup_pdata *pdata;\r\nint ret, reg;\r\nif (!wm831x_pdata || !wm831x_pdata->backup) {\r\ndev_warn(wm831x->dev,\r\n"No backup battery charger configuration\n");\r\nreturn;\r\n}\r\npdata = wm831x_pdata->backup;\r\nreg = 0;\r\nif (pdata->charger_enable)\r\nreg |= WM831X_BKUP_CHG_ENA | WM831X_BKUP_BATT_DET_ENA;\r\nif (pdata->no_constant_voltage)\r\nreg |= WM831X_BKUP_CHG_MODE;\r\nswitch (pdata->vlim) {\r\ncase 2500:\r\nbreak;\r\ncase 3100:\r\nreg |= WM831X_BKUP_CHG_VLIM;\r\nbreak;\r\ndefault:\r\ndev_err(wm831x->dev, "Invalid backup voltage limit %dmV\n",\r\npdata->vlim);\r\n}\r\nswitch (pdata->ilim) {\r\ncase 100:\r\nbreak;\r\ncase 200:\r\nreg |= 1;\r\nbreak;\r\ncase 300:\r\nreg |= 2;\r\nbreak;\r\ncase 400:\r\nreg |= 3;\r\nbreak;\r\ndefault:\r\ndev_err(wm831x->dev, "Invalid backup current limit %duA\n",\r\npdata->ilim);\r\n}\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret != 0) {\r\ndev_err(wm831x->dev, "Failed to unlock registers: %d\n", ret);\r\nreturn;\r\n}\r\nret = wm831x_set_bits(wm831x, WM831X_BACKUP_CHARGER_CONTROL,\r\nWM831X_BKUP_CHG_ENA_MASK |\r\nWM831X_BKUP_CHG_MODE_MASK |\r\nWM831X_BKUP_BATT_DET_ENA_MASK |\r\nWM831X_BKUP_CHG_VLIM_MASK |\r\nWM831X_BKUP_CHG_ILIM_MASK,\r\nreg);\r\nif (ret != 0)\r\ndev_err(wm831x->dev,\r\n"Failed to set backup charger config: %d\n", ret);\r\nwm831x_reg_lock(wm831x);\r\n}\r\nstatic int wm831x_backup_get_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct wm831x_backup *devdata = dev_get_drvdata(psy->dev.parent);\r\nstruct wm831x *wm831x = devdata->wm831x;\r\nint ret = 0;\r\nret = wm831x_reg_read(wm831x, WM831X_BACKUP_CHARGER_CONTROL);\r\nif (ret < 0)\r\nreturn ret;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nif (ret & WM831X_BKUP_CHG_STS)\r\nval->intval = POWER_SUPPLY_STATUS_CHARGING;\r\nelse\r\nval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nret = wm831x_backup_read_voltage(wm831x, WM831X_AUX_BKUP_BATT,\r\nval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nif (ret & WM831X_BKUP_CHG_STS)\r\nval->intval = 1;\r\nelse\r\nval->intval = 0;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int wm831x_backup_probe(struct platform_device *pdev)\r\n{\r\nstruct wm831x *wm831x = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm831x_pdata *wm831x_pdata = wm831x->dev->platform_data;\r\nstruct wm831x_backup *devdata;\r\ndevdata = devm_kzalloc(&pdev->dev, sizeof(struct wm831x_backup),\r\nGFP_KERNEL);\r\nif (devdata == NULL)\r\nreturn -ENOMEM;\r\ndevdata->wm831x = wm831x;\r\nplatform_set_drvdata(pdev, devdata);\r\nwm831x_config_backup(wm831x);\r\nif (wm831x_pdata && wm831x_pdata->wm831x_num)\r\nsnprintf(devdata->name, sizeof(devdata->name),\r\n"wm831x-backup.%d", wm831x_pdata->wm831x_num);\r\nelse\r\nsnprintf(devdata->name, sizeof(devdata->name),\r\n"wm831x-backup");\r\ndevdata->backup_desc.name = devdata->name;\r\ndevdata->backup_desc.type = POWER_SUPPLY_TYPE_BATTERY;\r\ndevdata->backup_desc.properties = wm831x_backup_props;\r\ndevdata->backup_desc.num_properties = ARRAY_SIZE(wm831x_backup_props);\r\ndevdata->backup_desc.get_property = wm831x_backup_get_prop;\r\ndevdata->backup = power_supply_register(&pdev->dev,\r\n&devdata->backup_desc, NULL);\r\nreturn PTR_ERR_OR_ZERO(devdata->backup);\r\n}\r\nstatic int wm831x_backup_remove(struct platform_device *pdev)\r\n{\r\nstruct wm831x_backup *devdata = platform_get_drvdata(pdev);\r\npower_supply_unregister(devdata->backup);\r\nreturn 0;\r\n}

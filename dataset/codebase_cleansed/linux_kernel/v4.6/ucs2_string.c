unsigned long\r\nucs2_strnlen(const ucs2_char_t *s, size_t maxlength)\r\n{\r\nunsigned long length = 0;\r\nwhile (*s++ != 0 && length < maxlength)\r\nlength++;\r\nreturn length;\r\n}\r\nunsigned long\r\nucs2_strlen(const ucs2_char_t *s)\r\n{\r\nreturn ucs2_strnlen(s, ~0UL);\r\n}\r\nunsigned long\r\nucs2_strsize(const ucs2_char_t *data, unsigned long maxlength)\r\n{\r\nreturn ucs2_strnlen(data, maxlength/sizeof(ucs2_char_t)) * sizeof(ucs2_char_t);\r\n}\r\nint\r\nucs2_strncmp(const ucs2_char_t *a, const ucs2_char_t *b, size_t len)\r\n{\r\nwhile (1) {\r\nif (len == 0)\r\nreturn 0;\r\nif (*a < *b)\r\nreturn -1;\r\nif (*a > *b)\r\nreturn 1;\r\nif (*a == 0)\r\nreturn 0;\r\na++;\r\nb++;\r\nlen--;\r\n}\r\n}\r\nunsigned long\r\nucs2_utf8size(const ucs2_char_t *src)\r\n{\r\nunsigned long i;\r\nunsigned long j = 0;\r\nfor (i = 0; i < ucs2_strlen(src); i++) {\r\nu16 c = src[i];\r\nif (c >= 0x800)\r\nj += 3;\r\nelse if (c >= 0x80)\r\nj += 2;\r\nelse\r\nj += 1;\r\n}\r\nreturn j;\r\n}\r\nunsigned long\r\nucs2_as_utf8(u8 *dest, const ucs2_char_t *src, unsigned long maxlength)\r\n{\r\nunsigned int i;\r\nunsigned long j = 0;\r\nunsigned long limit = ucs2_strnlen(src, maxlength);\r\nfor (i = 0; maxlength && i < limit; i++) {\r\nu16 c = src[i];\r\nif (c >= 0x800) {\r\nif (maxlength < 3)\r\nbreak;\r\nmaxlength -= 3;\r\ndest[j++] = 0xe0 | (c & 0xf000) >> 12;\r\ndest[j++] = 0x80 | (c & 0x0fc0) >> 6;\r\ndest[j++] = 0x80 | (c & 0x003f);\r\n} else if (c >= 0x80) {\r\nif (maxlength < 2)\r\nbreak;\r\nmaxlength -= 2;\r\ndest[j++] = 0xc0 | (c & 0x7c0) >> 6;\r\ndest[j++] = 0x80 | (c & 0x03f);\r\n} else {\r\nmaxlength -= 1;\r\ndest[j++] = c & 0x7f;\r\n}\r\n}\r\nif (maxlength)\r\ndest[j] = '\0';\r\nreturn j;\r\n}

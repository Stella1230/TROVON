void doorbell_setup_this_cpu(void)\r\n{\r\nunsigned long tag = mfspr(SPRN_DOORBELL_CPUTAG) & PPC_DBELL_TAG_MASK;\r\nsmp_muxed_ipi_set_data(smp_processor_id(), tag);\r\n}\r\nvoid doorbell_cause_ipi(int cpu, unsigned long data)\r\n{\r\nmb();\r\nppc_msgsnd(PPC_DBELL_MSGTYPE, 0, data);\r\n}\r\nvoid doorbell_exception(struct pt_regs *regs)\r\n{\r\nstruct pt_regs *old_regs = set_irq_regs(regs);\r\nirq_enter();\r\nmay_hard_irq_enable();\r\nkvmppc_set_host_ipi(smp_processor_id(), 0);\r\n__this_cpu_inc(irq_stat.doorbell_irqs);\r\nsmp_ipi_demux();\r\nirq_exit();\r\nset_irq_regs(old_regs);\r\n}\r\nvoid doorbell_exception(struct pt_regs *regs)\r\n{\r\nprintk(KERN_WARNING "Received doorbell on non-smp system\n");\r\n}

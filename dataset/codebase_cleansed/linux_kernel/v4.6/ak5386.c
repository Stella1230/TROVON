static int ak5386_soc_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct ak5386_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nreturn regulator_bulk_enable(ARRAY_SIZE(priv->supplies), priv->supplies);\r\n}\r\nstatic int ak5386_soc_remove(struct snd_soc_codec *codec)\r\n{\r\nstruct ak5386_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nregulator_bulk_disable(ARRAY_SIZE(priv->supplies), priv->supplies);\r\nreturn 0;\r\n}\r\nstatic int ak5386_soc_suspend(struct snd_soc_codec *codec)\r\n{\r\nstruct ak5386_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nregulator_bulk_disable(ARRAY_SIZE(priv->supplies), priv->supplies);\r\nreturn 0;\r\n}\r\nstatic int ak5386_soc_resume(struct snd_soc_codec *codec)\r\n{\r\nstruct ak5386_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nreturn regulator_bulk_enable(ARRAY_SIZE(priv->supplies), priv->supplies);\r\n}\r\nstatic int ak5386_set_dai_fmt(struct snd_soc_dai *codec_dai,\r\nunsigned int format)\r\n{\r\nstruct snd_soc_codec *codec = codec_dai->codec;\r\nformat &= SND_SOC_DAIFMT_FORMAT_MASK;\r\nif (format != SND_SOC_DAIFMT_LEFT_J &&\r\nformat != SND_SOC_DAIFMT_I2S) {\r\ndev_err(codec->dev, "Invalid DAI format\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ak5386_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct ak5386_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nif (gpio_is_valid(priv->reset_gpio))\r\ngpio_set_value(priv->reset_gpio, 1);\r\nreturn 0;\r\n}\r\nstatic int ak5386_hw_free(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct ak5386_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nif (gpio_is_valid(priv->reset_gpio))\r\ngpio_set_value(priv->reset_gpio, 0);\r\nreturn 0;\r\n}\r\nstatic int ak5386_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct ak5386_priv *priv;\r\nint ret, i;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->reset_gpio = -EINVAL;\r\ndev_set_drvdata(dev, priv);\r\nfor (i = 0; i < ARRAY_SIZE(supply_names); i++)\r\npriv->supplies[i].supply = supply_names[i];\r\nret = devm_regulator_bulk_get(dev, ARRAY_SIZE(priv->supplies),\r\npriv->supplies);\r\nif (ret < 0)\r\nreturn ret;\r\nif (of_match_device(of_match_ptr(ak5386_dt_ids), dev))\r\npriv->reset_gpio = of_get_named_gpio(dev->of_node,\r\n"reset-gpio", 0);\r\nif (gpio_is_valid(priv->reset_gpio))\r\nif (devm_gpio_request_one(dev, priv->reset_gpio,\r\nGPIOF_OUT_INIT_LOW,\r\n"AK5386 Reset"))\r\npriv->reset_gpio = -EINVAL;\r\nreturn snd_soc_register_codec(dev, &soc_codec_ak5386,\r\n&ak5386_dai, 1);\r\n}\r\nstatic int ak5386_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_codec(&pdev->dev);\r\nreturn 0;\r\n}

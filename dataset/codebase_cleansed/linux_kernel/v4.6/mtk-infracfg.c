int mtk_infracfg_set_bus_protection(struct regmap *infracfg, u32 mask)\r\n{\r\nunsigned long expired;\r\nu32 val;\r\nint ret;\r\nregmap_update_bits(infracfg, INFRA_TOPAXI_PROTECTEN, mask, mask);\r\nexpired = jiffies + HZ;\r\nwhile (1) {\r\nret = regmap_read(infracfg, INFRA_TOPAXI_PROTECTSTA1, &val);\r\nif (ret)\r\nreturn ret;\r\nif ((val & mask) == mask)\r\nbreak;\r\ncpu_relax();\r\nif (time_after(jiffies, expired))\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nint mtk_infracfg_clear_bus_protection(struct regmap *infracfg, u32 mask)\r\n{\r\nunsigned long expired;\r\nint ret;\r\nregmap_update_bits(infracfg, INFRA_TOPAXI_PROTECTEN, mask, 0);\r\nexpired = jiffies + HZ;\r\nwhile (1) {\r\nu32 val;\r\nret = regmap_read(infracfg, INFRA_TOPAXI_PROTECTSTA1, &val);\r\nif (ret)\r\nreturn ret;\r\nif (!(val & mask))\r\nbreak;\r\ncpu_relax();\r\nif (time_after(jiffies, expired))\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}

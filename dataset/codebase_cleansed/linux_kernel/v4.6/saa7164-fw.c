static int saa7164_dl_wait_ack(struct saa7164_dev *dev, u32 reg)\r\n{\r\nu32 timeout = SAA_DEVICE_TIMEOUT;\r\nwhile ((saa7164_readl(reg) & 0x01) == 0) {\r\ntimeout -= 10;\r\nif (timeout == 0) {\r\nprintk(KERN_ERR "%s() timeout (no d/l ack)\n",\r\n__func__);\r\nreturn -EBUSY;\r\n}\r\nmsleep(100);\r\n}\r\nreturn 0;\r\n}\r\nstatic int saa7164_dl_wait_clr(struct saa7164_dev *dev, u32 reg)\r\n{\r\nu32 timeout = SAA_DEVICE_TIMEOUT;\r\nwhile (saa7164_readl(reg) & 0x01) {\r\ntimeout -= 10;\r\nif (timeout == 0) {\r\nprintk(KERN_ERR "%s() timeout (no d/l clr)\n",\r\n__func__);\r\nreturn -EBUSY;\r\n}\r\nmsleep(100);\r\n}\r\nreturn 0;\r\n}\r\nstatic int saa7164_downloadimage(struct saa7164_dev *dev, u8 *src, u32 srcsize,\r\nu32 dlflags, u8 __iomem *dst, u32 dstsize)\r\n{\r\nu32 reg, timeout, offset;\r\nu8 *srcbuf = NULL;\r\nint ret;\r\nu32 dlflag = dlflags;\r\nu32 dlflag_ack = dlflag + 4;\r\nu32 drflag = dlflag_ack + 4;\r\nu32 drflag_ack = drflag + 4;\r\nu32 bleflag = drflag_ack + 4;\r\ndprintk(DBGLVL_FW,\r\n"%s(image=%p, size=%d, flags=0x%x, dst=%p, dstsize=0x%x)\n",\r\n__func__, src, srcsize, dlflags, dst, dstsize);\r\nif ((src == NULL) || (dst == NULL)) {\r\nret = -EIO;\r\ngoto out;\r\n}\r\nsrcbuf = kzalloc(4 * 1048576, GFP_KERNEL);\r\nif (NULL == srcbuf) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nif (srcsize > (4*1048576)) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nmemcpy(srcbuf, src, srcsize);\r\ndprintk(DBGLVL_FW, "%s() dlflag = 0x%x\n", __func__, dlflag);\r\ndprintk(DBGLVL_FW, "%s() dlflag_ack = 0x%x\n", __func__, dlflag_ack);\r\ndprintk(DBGLVL_FW, "%s() drflag = 0x%x\n", __func__, drflag);\r\ndprintk(DBGLVL_FW, "%s() drflag_ack = 0x%x\n", __func__, drflag_ack);\r\ndprintk(DBGLVL_FW, "%s() bleflag = 0x%x\n", __func__, bleflag);\r\nreg = saa7164_readl(dlflag);\r\ndprintk(DBGLVL_FW, "%s() dlflag (0x%x)= 0x%x\n", __func__, dlflag, reg);\r\nif (reg == 1)\r\ndprintk(DBGLVL_FW,\r\n"%s() Download flag already set, please reboot\n",\r\n__func__);\r\nsaa7164_writel(dlflag, 1);\r\nret = saa7164_dl_wait_ack(dev, dlflag_ack);\r\nif (ret < 0)\r\ngoto out;\r\nsaa7164_writel(dlflag, 0);\r\nret = saa7164_dl_wait_clr(dev, dlflag_ack);\r\nif (ret < 0)\r\ngoto out;\r\nfor (offset = 0; srcsize > dstsize;\r\nsrcsize -= dstsize, offset += dstsize) {\r\ndprintk(DBGLVL_FW, "%s() memcpy %d\n", __func__, dstsize);\r\nmemcpy_toio(dst, srcbuf + offset, dstsize);\r\nsaa7164_writel(drflag, 1);\r\nret = saa7164_dl_wait_ack(dev, drflag_ack);\r\nif (ret < 0)\r\ngoto out;\r\nsaa7164_writel(drflag, 0);\r\nret = saa7164_dl_wait_clr(dev, drflag_ack);\r\nif (ret < 0)\r\ngoto out;\r\n}\r\ndprintk(DBGLVL_FW, "%s() memcpy(l) %d\n", __func__, dstsize);\r\nmemcpy_toio(dst, srcbuf+offset, srcsize);\r\nsaa7164_writel(drflag, 1);\r\nret = saa7164_dl_wait_ack(dev, drflag_ack);\r\nif (ret < 0)\r\ngoto out;\r\nsaa7164_writel(drflag, 0);\r\ntimeout = 0;\r\nwhile (saa7164_readl(bleflag) != SAA_DEVICE_IMAGE_BOOTING) {\r\nif (saa7164_readl(bleflag) & SAA_DEVICE_IMAGE_CORRUPT) {\r\nprintk(KERN_ERR "%s() image corrupt\n", __func__);\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\nif (saa7164_readl(bleflag) & SAA_DEVICE_MEMORY_CORRUPT) {\r\nprintk(KERN_ERR "%s() device memory corrupt\n",\r\n__func__);\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\nmsleep(10);\r\nif (timeout++ > 60)\r\nbreak;\r\n}\r\nprintk(KERN_INFO "%s() Image downloaded, booting...\n", __func__);\r\nret = saa7164_dl_wait_clr(dev, drflag_ack);\r\nif (ret < 0)\r\ngoto out;\r\nprintk(KERN_INFO "%s() Image booted successfully.\n", __func__);\r\nret = 0;\r\nout:\r\nkfree(srcbuf);\r\nreturn ret;\r\n}\r\nint saa7164_downloadfirmware(struct saa7164_dev *dev)\r\n{\r\nu32 tmp, filesize, version, err_flags, first_timeout, fwlength;\r\nu32 second_timeout, updatebootloader = 1, bootloadersize = 0;\r\nconst struct firmware *fw = NULL;\r\nstruct fw_header *hdr, *boothdr = NULL, *fwhdr;\r\nu32 bootloaderversion = 0, fwloadersize;\r\nu8 *bootloaderoffset = NULL, *fwloaderoffset;\r\nchar *fwname;\r\nint ret;\r\ndprintk(DBGLVL_FW, "%s()\n", __func__);\r\nif (saa7164_boards[dev->board].chiprev == SAA7164_CHIP_REV2) {\r\nfwname = SAA7164_REV2_FIRMWARE;\r\nfwlength = SAA7164_REV2_FIRMWARE_SIZE;\r\n} else {\r\nfwname = SAA7164_REV3_FIRMWARE;\r\nfwlength = SAA7164_REV3_FIRMWARE_SIZE;\r\n}\r\nversion = saa7164_getcurrentfirmwareversion(dev);\r\nif (version == 0x00) {\r\nsecond_timeout = 100;\r\nfirst_timeout = 100;\r\nerr_flags = saa7164_readl(SAA_BOOTLOADERERROR_FLAGS);\r\ndprintk(DBGLVL_FW, "%s() err_flags = %x\n",\r\n__func__, err_flags);\r\nwhile (err_flags != SAA_DEVICE_IMAGE_BOOTING) {\r\ndprintk(DBGLVL_FW, "%s() err_flags = %x\n",\r\n__func__, err_flags);\r\nmsleep(10);\r\nif (err_flags & SAA_DEVICE_IMAGE_CORRUPT) {\r\nprintk(KERN_ERR "%s() firmware corrupt\n",\r\n__func__);\r\nbreak;\r\n}\r\nif (err_flags & SAA_DEVICE_MEMORY_CORRUPT) {\r\nprintk(KERN_ERR "%s() device memory corrupt\n",\r\n__func__);\r\nbreak;\r\n}\r\nif (err_flags & SAA_DEVICE_NO_IMAGE) {\r\nprintk(KERN_ERR "%s() no first image\n",\r\n__func__);\r\nbreak;\r\n}\r\nif (err_flags & SAA_DEVICE_IMAGE_SEARCHING) {\r\nfirst_timeout -= 10;\r\nif (first_timeout == 0) {\r\nprintk(KERN_ERR\r\n"%s() no first image\n",\r\n__func__);\r\nbreak;\r\n}\r\n} else if (err_flags & SAA_DEVICE_IMAGE_LOADING) {\r\nsecond_timeout -= 10;\r\nif (second_timeout == 0) {\r\nprintk(KERN_ERR\r\n"%s() FW load time exceeded\n",\r\n__func__);\r\nbreak;\r\n}\r\n} else {\r\nsecond_timeout -= 10;\r\nif (second_timeout == 0) {\r\nprintk(KERN_ERR\r\n"%s() Unknown bootloader flags 0x%x\n",\r\n__func__, err_flags);\r\nbreak;\r\n}\r\n}\r\nerr_flags = saa7164_readl(SAA_BOOTLOADERERROR_FLAGS);\r\n}\r\nif (err_flags == SAA_DEVICE_IMAGE_BOOTING) {\r\ndprintk(DBGLVL_FW, "%s() Loader 1 has loaded.\n",\r\n__func__);\r\nfirst_timeout = SAA_DEVICE_TIMEOUT;\r\nsecond_timeout = 60 * SAA_DEVICE_TIMEOUT;\r\nsecond_timeout = 100;\r\nerr_flags = saa7164_readl(SAA_SECONDSTAGEERROR_FLAGS);\r\ndprintk(DBGLVL_FW, "%s() err_flags2 = %x\n",\r\n__func__, err_flags);\r\nwhile (err_flags != SAA_DEVICE_IMAGE_BOOTING) {\r\ndprintk(DBGLVL_FW, "%s() err_flags2 = %x\n",\r\n__func__, err_flags);\r\nmsleep(10);\r\nif (err_flags & SAA_DEVICE_IMAGE_CORRUPT) {\r\nprintk(KERN_ERR\r\n"%s() firmware corrupt\n",\r\n__func__);\r\nbreak;\r\n}\r\nif (err_flags & SAA_DEVICE_MEMORY_CORRUPT) {\r\nprintk(KERN_ERR\r\n"%s() device memory corrupt\n",\r\n__func__);\r\nbreak;\r\n}\r\nif (err_flags & SAA_DEVICE_NO_IMAGE) {\r\nprintk(KERN_ERR "%s() no first image\n",\r\n__func__);\r\nbreak;\r\n}\r\nif (err_flags & SAA_DEVICE_IMAGE_SEARCHING) {\r\nfirst_timeout -= 10;\r\nif (first_timeout == 0) {\r\nprintk(KERN_ERR\r\n"%s() no second image\n",\r\n__func__);\r\nbreak;\r\n}\r\n} else if (err_flags &\r\nSAA_DEVICE_IMAGE_LOADING) {\r\nsecond_timeout -= 10;\r\nif (second_timeout == 0) {\r\nprintk(KERN_ERR\r\n"%s() FW load time exceeded\n",\r\n__func__);\r\nbreak;\r\n}\r\n} else {\r\nsecond_timeout -= 10;\r\nif (second_timeout == 0) {\r\nprintk(KERN_ERR\r\n"%s() Unknown bootloader flags 0x%x\n",\r\n__func__, err_flags);\r\nbreak;\r\n}\r\n}\r\nerr_flags =\r\nsaa7164_readl(SAA_SECONDSTAGEERROR_FLAGS);\r\n}\r\ndprintk(DBGLVL_FW, "%s() Loader flags 1:0x%x 2:0x%x.\n",\r\n__func__,\r\nsaa7164_readl(SAA_BOOTLOADERERROR_FLAGS),\r\nsaa7164_readl(SAA_SECONDSTAGEERROR_FLAGS));\r\n}\r\nif ((saa7164_readl(SAA_BOOTLOADERERROR_FLAGS) ==\r\nSAA_DEVICE_IMAGE_BOOTING) &&\r\n(saa7164_readl(SAA_SECONDSTAGEERROR_FLAGS) ==\r\nSAA_DEVICE_IMAGE_BOOTING)) {\r\ndprintk(DBGLVL_FW, "%s() Loader 2 has loaded.\n",\r\n__func__);\r\nfirst_timeout = SAA_DEVICE_TIMEOUT;\r\nwhile (first_timeout) {\r\nmsleep(10);\r\nversion =\r\nsaa7164_getcurrentfirmwareversion(dev);\r\nif (version) {\r\ndprintk(DBGLVL_FW,\r\n"%s() All f/w loaded successfully\n",\r\n__func__);\r\nbreak;\r\n} else {\r\nfirst_timeout -= 10;\r\nif (first_timeout == 0) {\r\nprintk(KERN_ERR\r\n"%s() FW did not boot\n",\r\n__func__);\r\nbreak;\r\n}\r\n}\r\n}\r\n}\r\nversion = saa7164_getcurrentfirmwareversion(dev);\r\n}\r\nif ((saa7164_readl(SAA_BOOTLOADERERROR_FLAGS) ==\r\nSAA_DEVICE_IMAGE_BOOTING) &&\r\n(saa7164_readl(SAA_SECONDSTAGEERROR_FLAGS) ==\r\nSAA_DEVICE_IMAGE_BOOTING) && (version == 0)) {\r\nprintk(KERN_ERR\r\n"%s() The firmware hung, probably bad firmware\n",\r\n__func__);\r\nsaa7164_writel(SAA_DEVICE_DEADLOCK_DETECTED_OFFSET,\r\nSAA_DEVICE_DEADLOCK_DETECTED);\r\nsaa7164_getfirmwarestatus(dev);\r\nreturn -ENOMEM;\r\n}\r\ndprintk(DBGLVL_FW, "Device has Firmware Version %d.%d.%d.%d\n",\r\n(version & 0x0000fc00) >> 10,\r\n(version & 0x000003e0) >> 5,\r\n(version & 0x0000001f),\r\n(version & 0xffff0000) >> 16);\r\nif (version == 0) {\r\nprintk(KERN_INFO "%s() Waiting for firmware upload (%s)\n",\r\n__func__, fwname);\r\nret = request_firmware(&fw, fwname, &dev->pci->dev);\r\nif (ret) {\r\nprintk(KERN_ERR "%s() Upload failed. "\r\n"(file not found?)\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\nprintk(KERN_INFO "%s() firmware read %Zu bytes.\n",\r\n__func__, fw->size);\r\nif (fw->size != fwlength) {\r\nprintk(KERN_ERR "xc5000: firmware incorrect size\n");\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nprintk(KERN_INFO "%s() firmware loaded.\n", __func__);\r\nhdr = (struct fw_header *)fw->data;\r\nprintk(KERN_INFO "Firmware file header part 1:\n");\r\nprintk(KERN_INFO " .FirmwareSize = 0x%x\n", hdr->firmwaresize);\r\nprintk(KERN_INFO " .BSLSize = 0x%x\n", hdr->bslsize);\r\nprintk(KERN_INFO " .Reserved = 0x%x\n", hdr->reserved);\r\nprintk(KERN_INFO " .Version = 0x%x\n", hdr->version);\r\nif ((hdr->firmwaresize == 0) && (hdr->bslsize == 0))\r\nfilesize = hdr->reserved * 16;\r\nelse\r\nfilesize = (hdr->firmwaresize + hdr->bslsize) *\r\n16 + sizeof(struct fw_header);\r\nprintk(KERN_INFO "%s() SecBootLoader.FileSize = %d\n",\r\n__func__, filesize);\r\nif ((hdr->firmwaresize == 0) && (hdr->bslsize == 0)) {\r\nboothdr = (struct fw_header *)(fw->data +\r\nsizeof(struct fw_header));\r\nbootloaderversion =\r\nsaa7164_readl(SAA_DEVICE_2ND_VERSION);\r\ndprintk(DBGLVL_FW, "Onboard BootLoader:\n");\r\ndprintk(DBGLVL_FW, "->Flag 0x%x\n",\r\nsaa7164_readl(SAA_BOOTLOADERERROR_FLAGS));\r\ndprintk(DBGLVL_FW, "->Ack 0x%x\n",\r\nsaa7164_readl(SAA_DATAREADY_FLAG_ACK));\r\ndprintk(DBGLVL_FW, "->FW Version 0x%x\n", version);\r\ndprintk(DBGLVL_FW, "->Loader Version 0x%x\n",\r\nbootloaderversion);\r\nif ((saa7164_readl(SAA_BOOTLOADERERROR_FLAGS) ==\r\n0x03) && (saa7164_readl(SAA_DATAREADY_FLAG_ACK)\r\n== 0x00) && (version == 0x00)) {\r\ndprintk(DBGLVL_FW, "BootLoader version in "\r\n"rom %d.%d.%d.%d\n",\r\n(bootloaderversion & 0x0000fc00) >> 10,\r\n(bootloaderversion & 0x000003e0) >> 5,\r\n(bootloaderversion & 0x0000001f),\r\n(bootloaderversion & 0xffff0000) >> 16\r\n);\r\ndprintk(DBGLVL_FW, "BootLoader version "\r\n"in file %d.%d.%d.%d\n",\r\n(boothdr->version & 0x0000fc00) >> 10,\r\n(boothdr->version & 0x000003e0) >> 5,\r\n(boothdr->version & 0x0000001f),\r\n(boothdr->version & 0xffff0000) >> 16\r\n);\r\nif (bootloaderversion == boothdr->version)\r\nupdatebootloader = 0;\r\n}\r\ntmp = (boothdr->firmwaresize + boothdr->bslsize) * 16 +\r\n(sizeof(struct fw_header) +\r\nsizeof(struct fw_header));\r\nfwhdr = (struct fw_header *)(fw->data+tmp);\r\n} else {\r\nfwhdr = hdr;\r\n}\r\ndprintk(DBGLVL_FW, "Firmware version in file %d.%d.%d.%d\n",\r\n(fwhdr->version & 0x0000fc00) >> 10,\r\n(fwhdr->version & 0x000003e0) >> 5,\r\n(fwhdr->version & 0x0000001f),\r\n(fwhdr->version & 0xffff0000) >> 16\r\n);\r\nif (version == fwhdr->version) {\r\nret = 0;\r\ngoto out;\r\n}\r\nif ((hdr->firmwaresize == 0) && (hdr->bslsize == 0)) {\r\nif (updatebootloader) {\r\nbootloadersize = (boothdr->firmwaresize +\r\nboothdr->bslsize) * 16 +\r\nsizeof(struct fw_header);\r\nbootloaderoffset = (u8 *)(fw->data +\r\nsizeof(struct fw_header));\r\ndprintk(DBGLVL_FW, "bootloader d/l starts.\n");\r\nprintk(KERN_INFO "%s() FirmwareSize = 0x%x\n",\r\n__func__, boothdr->firmwaresize);\r\nprintk(KERN_INFO "%s() BSLSize = 0x%x\n",\r\n__func__, boothdr->bslsize);\r\nprintk(KERN_INFO "%s() Reserved = 0x%x\n",\r\n__func__, boothdr->reserved);\r\nprintk(KERN_INFO "%s() Version = 0x%x\n",\r\n__func__, boothdr->version);\r\nret = saa7164_downloadimage(\r\ndev,\r\nbootloaderoffset,\r\nbootloadersize,\r\nSAA_DOWNLOAD_FLAGS,\r\ndev->bmmio + SAA_DEVICE_DOWNLOAD_OFFSET,\r\nSAA_DEVICE_BUFFERBLOCKSIZE);\r\nif (ret < 0) {\r\nprintk(KERN_ERR\r\n"bootloader d/l has failed\n");\r\ngoto out;\r\n}\r\ndprintk(DBGLVL_FW,\r\n"bootloader download complete.\n");\r\n}\r\nprintk(KERN_ERR "starting firmware download(2)\n");\r\nbootloadersize = (boothdr->firmwaresize +\r\nboothdr->bslsize) * 16 +\r\nsizeof(struct fw_header);\r\nbootloaderoffset =\r\n(u8 *)(fw->data + sizeof(struct fw_header));\r\nfwloaderoffset = bootloaderoffset + bootloadersize;\r\nfwloadersize = (fwhdr->firmwaresize + fwhdr->bslsize) *\r\n16 + sizeof(struct fw_header);\r\nret = saa7164_downloadimage(\r\ndev,\r\nfwloaderoffset,\r\nfwloadersize,\r\nSAA_DEVICE_2ND_DOWNLOADFLAG_OFFSET,\r\ndev->bmmio + SAA_DEVICE_2ND_DOWNLOAD_OFFSET,\r\nSAA_DEVICE_2ND_BUFFERBLOCKSIZE);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "firmware download failed\n");\r\ngoto out;\r\n}\r\nprintk(KERN_ERR "firmware download complete.\n");\r\n} else {\r\nprintk(KERN_ERR "starting firmware download(3)\n");\r\nret = saa7164_downloadimage(\r\ndev,\r\n(u8 *)fw->data,\r\nfw->size,\r\nSAA_DOWNLOAD_FLAGS,\r\ndev->bmmio + SAA_DEVICE_DOWNLOAD_OFFSET,\r\nSAA_DEVICE_BUFFERBLOCKSIZE);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "firmware download failed\n");\r\ngoto out;\r\n}\r\nprintk(KERN_ERR "firmware download complete.\n");\r\n}\r\n}\r\ndev->firmwareloaded = 1;\r\nret = 0;\r\nout:\r\nrelease_firmware(fw);\r\nreturn ret;\r\n}

void vivid_radio_rds_init(struct vivid_dev *dev)\r\n{\r\nstruct vivid_rds_gen *rds = &dev->rds_gen;\r\nbool alt = dev->radio_rx_rds_use_alternates;\r\nif (dev->radio_rds_loop && !dev->radio_tx_rds_controls)\r\nreturn;\r\nif (dev->radio_rds_loop) {\r\nv4l2_ctrl_lock(dev->radio_tx_rds_pi);\r\nrds->picode = dev->radio_tx_rds_pi->cur.val;\r\nrds->pty = dev->radio_tx_rds_pty->cur.val;\r\nrds->mono_stereo = dev->radio_tx_rds_mono_stereo->cur.val;\r\nrds->art_head = dev->radio_tx_rds_art_head->cur.val;\r\nrds->compressed = dev->radio_tx_rds_compressed->cur.val;\r\nrds->dyn_pty = dev->radio_tx_rds_dyn_pty->cur.val;\r\nrds->ta = dev->radio_tx_rds_ta->cur.val;\r\nrds->tp = dev->radio_tx_rds_tp->cur.val;\r\nrds->ms = dev->radio_tx_rds_ms->cur.val;\r\nstrlcpy(rds->psname,\r\ndev->radio_tx_rds_psname->p_cur.p_char,\r\nsizeof(rds->psname));\r\nstrlcpy(rds->radiotext,\r\ndev->radio_tx_rds_radiotext->p_cur.p_char + alt * 64,\r\nsizeof(rds->radiotext));\r\nv4l2_ctrl_unlock(dev->radio_tx_rds_pi);\r\n} else {\r\nvivid_rds_gen_fill(rds, dev->radio_rx_freq, alt);\r\n}\r\nif (dev->radio_rx_rds_controls) {\r\nv4l2_ctrl_s_ctrl(dev->radio_rx_rds_pty, rds->pty);\r\nv4l2_ctrl_s_ctrl(dev->radio_rx_rds_ta, rds->ta);\r\nv4l2_ctrl_s_ctrl(dev->radio_rx_rds_tp, rds->tp);\r\nv4l2_ctrl_s_ctrl(dev->radio_rx_rds_ms, rds->ms);\r\nv4l2_ctrl_s_ctrl_string(dev->radio_rx_rds_psname, rds->psname);\r\nv4l2_ctrl_s_ctrl_string(dev->radio_rx_rds_radiotext, rds->radiotext);\r\nif (!dev->radio_rds_loop)\r\ndev->radio_rx_rds_use_alternates = !dev->radio_rx_rds_use_alternates;\r\n}\r\nvivid_rds_generate(rds);\r\n}\r\nstatic void vivid_radio_calc_sig_qual(struct vivid_dev *dev)\r\n{\r\nint mod = 16000;\r\nint delta = 800;\r\nint sig_qual, sig_qual_tx = mod;\r\nif (dev->radio_rx_freq <= AM_FREQ_RANGE_HIGH) {\r\nmod /= 10;\r\ndelta /= 10;\r\n}\r\nsig_qual = (dev->radio_rx_freq + delta) % mod - delta;\r\nif (dev->has_radio_tx)\r\nsig_qual_tx = dev->radio_rx_freq - dev->radio_tx_freq;\r\nif (abs(sig_qual_tx) <= abs(sig_qual)) {\r\nsig_qual = sig_qual_tx;\r\nif (!dev->radio_rds_loop && !dev->radio_tx_rds_controls)\r\nmemset(dev->rds_gen.data, 0,\r\nsizeof(dev->rds_gen.data));\r\ndev->radio_rds_loop = dev->radio_rx_freq >= FM_FREQ_RANGE_LOW;\r\n} else {\r\ndev->radio_rds_loop = false;\r\n}\r\nif (dev->radio_rx_freq <= AM_FREQ_RANGE_HIGH)\r\nsig_qual *= 10;\r\ndev->radio_rx_sig_qual = sig_qual;\r\n}\r\nint vivid_radio_g_frequency(struct file *file, const unsigned *pfreq, struct v4l2_frequency *vf)\r\n{\r\nif (vf->tuner != 0)\r\nreturn -EINVAL;\r\nvf->frequency = *pfreq;\r\nreturn 0;\r\n}\r\nint vivid_radio_s_frequency(struct file *file, unsigned *pfreq, const struct v4l2_frequency *vf)\r\n{\r\nstruct vivid_dev *dev = video_drvdata(file);\r\nunsigned freq;\r\nunsigned band;\r\nif (vf->tuner != 0)\r\nreturn -EINVAL;\r\nif (vf->frequency >= (FM_FREQ_RANGE_LOW + SW_FREQ_RANGE_HIGH) / 2)\r\nband = BAND_FM;\r\nelse if (vf->frequency <= (AM_FREQ_RANGE_HIGH + SW_FREQ_RANGE_LOW) / 2)\r\nband = BAND_AM;\r\nelse\r\nband = BAND_SW;\r\nfreq = clamp_t(u32, vf->frequency, vivid_radio_bands[band].rangelow,\r\nvivid_radio_bands[band].rangehigh);\r\n*pfreq = freq;\r\nvivid_radio_calc_sig_qual(dev);\r\nvivid_radio_rds_init(dev);\r\nreturn 0;\r\n}

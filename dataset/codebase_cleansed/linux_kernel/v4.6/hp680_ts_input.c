static void do_softint(struct work_struct *work)\r\n{\r\nint absx = 0, absy = 0;\r\nu8 scpdr;\r\nint touched = 0;\r\nif (__raw_readb(PHDR) & PHDR_TS_PEN_DOWN) {\r\nscpdr = __raw_readb(SCPDR);\r\nscpdr |= SCPDR_TS_SCAN_ENABLE;\r\nscpdr &= ~SCPDR_TS_SCAN_Y;\r\n__raw_writeb(scpdr, SCPDR);\r\nudelay(30);\r\nabsy = adc_single(ADC_CHANNEL_TS_Y);\r\nscpdr = __raw_readb(SCPDR);\r\nscpdr |= SCPDR_TS_SCAN_Y;\r\nscpdr &= ~SCPDR_TS_SCAN_X;\r\n__raw_writeb(scpdr, SCPDR);\r\nudelay(30);\r\nabsx = adc_single(ADC_CHANNEL_TS_X);\r\nscpdr = __raw_readb(SCPDR);\r\nscpdr |= SCPDR_TS_SCAN_X;\r\nscpdr &= ~SCPDR_TS_SCAN_ENABLE;\r\n__raw_writeb(scpdr, SCPDR);\r\nudelay(100);\r\ntouched = __raw_readb(PHDR) & PHDR_TS_PEN_DOWN;\r\n}\r\nif (touched) {\r\ninput_report_key(hp680_ts_dev, BTN_TOUCH, 1);\r\ninput_report_abs(hp680_ts_dev, ABS_X, absx);\r\ninput_report_abs(hp680_ts_dev, ABS_Y, absy);\r\n} else {\r\ninput_report_key(hp680_ts_dev, BTN_TOUCH, 0);\r\n}\r\ninput_sync(hp680_ts_dev);\r\nenable_irq(HP680_TS_IRQ);\r\n}\r\nstatic irqreturn_t hp680_ts_interrupt(int irq, void *dev)\r\n{\r\ndisable_irq_nosync(irq);\r\nschedule_delayed_work(&work, HZ / 20);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init hp680_ts_init(void)\r\n{\r\nint err;\r\nhp680_ts_dev = input_allocate_device();\r\nif (!hp680_ts_dev)\r\nreturn -ENOMEM;\r\nhp680_ts_dev->evbit[0] = BIT_MASK(EV_ABS) | BIT_MASK(EV_KEY);\r\nhp680_ts_dev->keybit[BIT_WORD(BTN_TOUCH)] = BIT_MASK(BTN_TOUCH);\r\ninput_set_abs_params(hp680_ts_dev, ABS_X,\r\nHP680_TS_ABS_X_MIN, HP680_TS_ABS_X_MAX, 0, 0);\r\ninput_set_abs_params(hp680_ts_dev, ABS_Y,\r\nHP680_TS_ABS_Y_MIN, HP680_TS_ABS_Y_MAX, 0, 0);\r\nhp680_ts_dev->name = "HP Jornada touchscreen";\r\nhp680_ts_dev->phys = "hp680_ts/input0";\r\nif (request_irq(HP680_TS_IRQ, hp680_ts_interrupt,\r\n0, MODNAME, NULL) < 0) {\r\nprintk(KERN_ERR "hp680_touchscreen.c: Can't allocate irq %d\n",\r\nHP680_TS_IRQ);\r\nerr = -EBUSY;\r\ngoto fail1;\r\n}\r\nerr = input_register_device(hp680_ts_dev);\r\nif (err)\r\ngoto fail2;\r\nreturn 0;\r\nfail2: free_irq(HP680_TS_IRQ, NULL);\r\ncancel_delayed_work_sync(&work);\r\nfail1: input_free_device(hp680_ts_dev);\r\nreturn err;\r\n}\r\nstatic void __exit hp680_ts_exit(void)\r\n{\r\nfree_irq(HP680_TS_IRQ, NULL);\r\ncancel_delayed_work_sync(&work);\r\ninput_unregister_device(hp680_ts_dev);\r\n}

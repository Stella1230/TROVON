int mvebu_get_soc_id(u32 *dev, u32 *rev)\r\n{\r\nif (is_id_valid) {\r\n*dev = soc_dev_id;\r\n*rev = soc_rev;\r\nreturn 0;\r\n} else\r\nreturn -ENODEV;\r\n}\r\nstatic int __init get_soc_id_by_pci(void)\r\n{\r\nstruct device_node *np;\r\nint ret = 0;\r\nvoid __iomem *pci_base;\r\nstruct clk *clk;\r\nstruct device_node *child;\r\nnp = of_find_matching_node(NULL, mvebu_pcie_of_match_table);\r\nif (!np)\r\nreturn ret;\r\nchild = of_get_next_child(np, NULL);\r\nif (child == NULL) {\r\npr_err("cannot get pci node\n");\r\nret = -ENOMEM;\r\ngoto clk_err;\r\n}\r\nclk = of_clk_get_by_name(child, NULL);\r\nif (IS_ERR(clk)) {\r\npr_err("cannot get clock\n");\r\nret = -ENOMEM;\r\ngoto clk_err;\r\n}\r\nret = clk_prepare_enable(clk);\r\nif (ret) {\r\npr_err("cannot enable clock\n");\r\ngoto clk_err;\r\n}\r\npci_base = of_iomap(child, 0);\r\nif (pci_base == NULL) {\r\npr_err("cannot map registers\n");\r\nret = -ENOMEM;\r\ngoto res_ioremap;\r\n}\r\nsoc_dev_id = readl(pci_base + PCIE_DEV_ID_OFF) >> 16;\r\nsoc_rev = readl(pci_base + PCIE_DEV_REV_OFF) & SOC_REV_MASK;\r\nis_id_valid = true;\r\npr_info("MVEBU SoC ID=0x%X, Rev=0x%X\n", soc_dev_id, soc_rev);\r\niounmap(pci_base);\r\nres_ioremap:\r\nif (!of_device_is_available(child) || !IS_ENABLED(CONFIG_PCI_MVEBU)) {\r\nclk_disable_unprepare(clk);\r\nclk_put(clk);\r\n}\r\nclk_err:\r\nof_node_put(child);\r\nof_node_put(np);\r\nreturn ret;\r\n}\r\nstatic int __init mvebu_soc_id_init(void)\r\n{\r\nif (!mvebu_system_controller_get_soc_id(&soc_dev_id, &soc_rev)) {\r\nis_id_valid = true;\r\npr_info("MVEBU SoC ID=0x%X, Rev=0x%X\n", soc_dev_id, soc_rev);\r\nreturn 0;\r\n}\r\nreturn get_soc_id_by_pci();\r\n}\r\nstatic int __init mvebu_soc_device(void)\r\n{\r\nstruct soc_device_attribute *soc_dev_attr;\r\nstruct soc_device *soc_dev;\r\nif (!is_id_valid)\r\nreturn 0;\r\nsoc_dev_attr = kzalloc(sizeof(*soc_dev_attr), GFP_KERNEL);\r\nif (!soc_dev_attr)\r\nreturn -ENOMEM;\r\nsoc_dev_attr->family = kasprintf(GFP_KERNEL, "Marvell");\r\nsoc_dev_attr->revision = kasprintf(GFP_KERNEL, "%X", soc_rev);\r\nsoc_dev_attr->soc_id = kasprintf(GFP_KERNEL, "%X", soc_dev_id);\r\nsoc_dev = soc_device_register(soc_dev_attr);\r\nif (IS_ERR(soc_dev)) {\r\nkfree(soc_dev_attr->family);\r\nkfree(soc_dev_attr->revision);\r\nkfree(soc_dev_attr->soc_id);\r\nkfree(soc_dev_attr);\r\n}\r\nreturn 0;\r\n}

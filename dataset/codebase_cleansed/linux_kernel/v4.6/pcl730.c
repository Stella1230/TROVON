static int pcl730_do_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned long reg = (unsigned long)s->private;\r\nunsigned int mask;\r\nmask = comedi_dio_update_state(s, data);\r\nif (mask) {\r\nif (mask & 0x00ff)\r\noutb(s->state & 0xff, dev->iobase + reg);\r\nif ((mask & 0xff00) && (s->n_chan > 8))\r\noutb((s->state >> 8) & 0xff, dev->iobase + reg + 1);\r\nif ((mask & 0xff0000) && (s->n_chan > 16))\r\noutb((s->state >> 16) & 0xff, dev->iobase + reg + 2);\r\nif ((mask & 0xff000000) && (s->n_chan > 24))\r\noutb((s->state >> 24) & 0xff, dev->iobase + reg + 3);\r\n}\r\ndata[1] = s->state;\r\nreturn insn->n;\r\n}\r\nstatic unsigned int pcl730_get_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nunsigned long reg = (unsigned long)s->private;\r\nunsigned int val;\r\nval = inb(dev->iobase + reg);\r\nif (s->n_chan > 8)\r\nval |= (inb(dev->iobase + reg + 1) << 8);\r\nif (s->n_chan > 16)\r\nval |= (inb(dev->iobase + reg + 2) << 16);\r\nif (s->n_chan > 24)\r\nval |= (inb(dev->iobase + reg + 3) << 24);\r\nreturn val;\r\n}\r\nstatic int pcl730_di_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\ndata[1] = pcl730_get_bits(dev, s);\r\nreturn insn->n;\r\n}\r\nstatic int pcl730_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nconst struct pcl730_board *board = dev->board_ptr;\r\nstruct comedi_subdevice *s;\r\nint subdev;\r\nint ret;\r\nret = comedi_request_region(dev, it->options[0], board->io_range);\r\nif (ret)\r\nreturn ret;\r\nret = comedi_alloc_subdevices(dev, board->n_subdevs);\r\nif (ret)\r\nreturn ret;\r\nsubdev = 0;\r\nif (board->n_iso_out_chan) {\r\ns = &dev->subdevices[subdev++];\r\ns->type = COMEDI_SUBD_DO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = board->n_iso_out_chan;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = pcl730_do_insn_bits;\r\ns->private = (void *)0;\r\nif (board->has_readback)\r\ns->state = pcl730_get_bits(dev, s);\r\n}\r\nif (board->n_iso_in_chan) {\r\ns = &dev->subdevices[subdev++];\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan = board->n_iso_in_chan;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = pcl730_di_insn_bits;\r\ns->private = board->is_ir104 ? (void *)4 :\r\nboard->is_acl7225b ? (void *)2 :\r\nboard->is_pcl725 ? (void *)1 : (void *)0;\r\n}\r\nif (board->has_ttl_io) {\r\ns = &dev->subdevices[subdev++];\r\ns->type = COMEDI_SUBD_DO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = board->n_ttl_chan;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = pcl730_do_insn_bits;\r\ns->private = (void *)2;\r\ns = &dev->subdevices[subdev++];\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan = board->n_ttl_chan;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = pcl730_di_insn_bits;\r\ns->private = (void *)2;\r\n}\r\nreturn 0;\r\n}

u32\r\nnvbios_M0209Te(struct nvkm_bios *bios,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len, u8 *snr, u8 *ssz)\r\n{\r\nstruct bit_entry bit_M;\r\nu32 data = 0x00000000;\r\nif (!bit_entry(bios, 'M', &bit_M)) {\r\nif (bit_M.version == 2 && bit_M.length > 0x0c)\r\ndata = nvbios_rd32(bios, bit_M.offset + 0x09);\r\nif (data) {\r\n*ver = nvbios_rd08(bios, data + 0x00);\r\nswitch (*ver) {\r\ncase 0x10:\r\n*hdr = nvbios_rd08(bios, data + 0x01);\r\n*len = nvbios_rd08(bios, data + 0x02);\r\n*ssz = nvbios_rd08(bios, data + 0x03);\r\n*snr = 1;\r\n*cnt = nvbios_rd08(bios, data + 0x04);\r\nreturn data;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn 0x00000000;\r\n}\r\nu32\r\nnvbios_M0209Ee(struct nvkm_bios *bios, int idx,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len)\r\n{\r\nu8 snr, ssz;\r\nu32 data = nvbios_M0209Te(bios, ver, hdr, cnt, len, &snr, &ssz);\r\nif (data && idx < *cnt) {\r\ndata = data + *hdr + idx * (*len + (snr * ssz));\r\n*hdr = *len;\r\n*cnt = snr;\r\n*len = ssz;\r\nreturn data;\r\n}\r\nreturn 0x00000000;\r\n}\r\nu32\r\nnvbios_M0209Ep(struct nvkm_bios *bios, int idx,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len, struct nvbios_M0209E *info)\r\n{\r\nu32 data = nvbios_M0209Ee(bios, idx, ver, hdr, cnt, len);\r\nmemset(info, 0x00, sizeof(*info));\r\nswitch (!!data * *ver) {\r\ncase 0x10:\r\ninfo->v00_40 = (nvbios_rd08(bios, data + 0x00) & 0x40) >> 6;\r\ninfo->bits = nvbios_rd08(bios, data + 0x00) & 0x3f;\r\ninfo->modulo = nvbios_rd08(bios, data + 0x01);\r\ninfo->v02_40 = (nvbios_rd08(bios, data + 0x02) & 0x40) >> 6;\r\ninfo->v02_07 = nvbios_rd08(bios, data + 0x02) & 0x07;\r\ninfo->v03 = nvbios_rd08(bios, data + 0x03);\r\nreturn data;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0x00000000;\r\n}\r\nu32\r\nnvbios_M0209Se(struct nvkm_bios *bios, int ent, int idx, u8 *ver, u8 *hdr)\r\n{\r\nu8 cnt, len;\r\nu32 data = nvbios_M0209Ee(bios, ent, ver, hdr, &cnt, &len);\r\nif (data && idx < cnt) {\r\ndata = data + *hdr + idx * len;\r\n*hdr = len;\r\nreturn data;\r\n}\r\nreturn 0x00000000;\r\n}\r\nu32\r\nnvbios_M0209Sp(struct nvkm_bios *bios, int ent, int idx, u8 *ver, u8 *hdr,\r\nstruct nvbios_M0209S *info)\r\n{\r\nstruct nvbios_M0209E M0209E;\r\nu8 cnt, len;\r\nu32 data = nvbios_M0209Ep(bios, ent, ver, hdr, &cnt, &len, &M0209E);\r\nif (data) {\r\nu32 i, data = nvbios_M0209Se(bios, ent, idx, ver, hdr);\r\nmemset(info, 0x00, sizeof(*info));\r\nswitch (!!data * *ver) {\r\ncase 0x10:\r\nfor (i = 0; i < ARRAY_SIZE(info->data); i++) {\r\nu32 bits = (i % M0209E.modulo) * M0209E.bits;\r\nu32 mask = (1ULL << M0209E.bits) - 1;\r\nu16 off = bits / 8;\r\nu8 mod = bits % 8;\r\ninfo->data[i] = nvbios_rd32(bios, data + off);\r\ninfo->data[i] = info->data[i] >> mod;\r\ninfo->data[i] = info->data[i] & mask;\r\n}\r\nreturn data;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nreturn 0x00000000;\r\n}

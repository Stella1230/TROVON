static void cosm_update_mic_status(struct cosm_device *cdev)\r\n{\r\nif (cdev->shutdown_status_int != MIC_NOP) {\r\ncosm_set_shutdown_status(cdev, cdev->shutdown_status_int);\r\ncdev->shutdown_status_int = MIC_NOP;\r\n}\r\n}\r\nstatic void cosm_shutdown_status_int(struct cosm_device *cdev,\r\nenum mic_status shutdown_status)\r\n{\r\nswitch (shutdown_status) {\r\ncase MIC_HALTED:\r\ncase MIC_POWER_OFF:\r\ncase MIC_RESTART:\r\ncase MIC_CRASHED:\r\nbreak;\r\ndefault:\r\ndev_err(&cdev->dev, "%s %d Unexpected shutdown_status %d\n",\r\n__func__, __LINE__, shutdown_status);\r\nreturn;\r\n};\r\ncdev->shutdown_status_int = shutdown_status;\r\ncdev->heartbeat_watchdog_enable = false;\r\nif (cdev->state != MIC_SHUTTING_DOWN)\r\ncosm_set_state(cdev, MIC_SHUTTING_DOWN);\r\n}\r\nstatic void cosm_scif_recv(struct cosm_device *cdev)\r\n{\r\nstruct cosm_msg msg;\r\nint rc;\r\nwhile (1) {\r\nrc = scif_recv(cdev->epd, &msg, sizeof(msg), 0);\r\nif (!rc) {\r\nbreak;\r\n} else if (rc < 0) {\r\ndev_dbg(&cdev->dev, "%s: %d rc %d\n",\r\n__func__, __LINE__, rc);\r\nbreak;\r\n}\r\ndev_dbg(&cdev->dev, "%s: %d rc %d id 0x%llx\n",\r\n__func__, __LINE__, rc, msg.id);\r\nswitch (msg.id) {\r\ncase COSM_MSG_SHUTDOWN_STATUS:\r\ncosm_shutdown_status_int(cdev, msg.shutdown_status);\r\nbreak;\r\ncase COSM_MSG_HEARTBEAT:\r\nbreak;\r\ndefault:\r\ndev_err(&cdev->dev, "%s: %d unknown msg.id %lld\n",\r\n__func__, __LINE__, msg.id);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void cosm_set_crashed(struct cosm_device *cdev)\r\n{\r\ndev_err(&cdev->dev, "node alive timeout\n");\r\ncosm_shutdown_status_int(cdev, MIC_CRASHED);\r\ncosm_update_mic_status(cdev);\r\n}\r\nstatic void cosm_send_time(struct cosm_device *cdev)\r\n{\r\nstruct cosm_msg msg = { .id = COSM_MSG_SYNC_TIME };\r\nint rc;\r\ngetnstimeofday64(&msg.timespec);\r\nrc = scif_send(cdev->epd, &msg, sizeof(msg), SCIF_SEND_BLOCK);\r\nif (rc < 0)\r\ndev_err(&cdev->dev, "%s %d scif_send failed rc %d\n",\r\n__func__, __LINE__, rc);\r\n}\r\nstatic void cosm_scif_close(struct cosm_device *cdev)\r\n{\r\ncosm_update_mic_status(cdev);\r\nscif_close(cdev->epd);\r\ncdev->epd = NULL;\r\ndev_dbg(&cdev->dev, "%s %d\n", __func__, __LINE__);\r\n}\r\nstatic int cosm_set_online(struct cosm_device *cdev)\r\n{\r\nint rc = 0;\r\nif (MIC_BOOTING == cdev->state || MIC_ONLINE == cdev->state) {\r\ncdev->heartbeat_watchdog_enable = cdev->sysfs_heartbeat_enable;\r\ncdev->epd = cdev->newepd;\r\nif (cdev->state == MIC_BOOTING)\r\ncosm_set_state(cdev, MIC_ONLINE);\r\ncosm_send_time(cdev);\r\ndev_dbg(&cdev->dev, "%s %d\n", __func__, __LINE__);\r\n} else {\r\ndev_warn(&cdev->dev, "%s %d not going online in state: %s\n",\r\n__func__, __LINE__, cosm_state_string[cdev->state]);\r\nrc = -EINVAL;\r\n}\r\nput_device(&cdev->dev);\r\nreturn rc;\r\n}\r\nvoid cosm_scif_work(struct work_struct *work)\r\n{\r\nstruct cosm_device *cdev = container_of(work, struct cosm_device,\r\nscif_work);\r\nstruct scif_pollepd pollepd;\r\nint rc;\r\nmutex_lock(&cdev->cosm_mutex);\r\nif (cosm_set_online(cdev))\r\ngoto exit;\r\nwhile (1) {\r\npollepd.epd = cdev->epd;\r\npollepd.events = POLLIN;\r\nmutex_unlock(&cdev->cosm_mutex);\r\nrc = scif_poll(&pollepd, 1, COSM_HEARTBEAT_TIMEOUT_MSEC);\r\nmutex_lock(&cdev->cosm_mutex);\r\nif (rc < 0) {\r\ndev_err(&cdev->dev, "%s %d scif_poll rc %d\n",\r\n__func__, __LINE__, rc);\r\ncontinue;\r\n}\r\nif (pollepd.revents & POLLIN)\r\ncosm_scif_recv(cdev);\r\nif (pollepd.revents & POLLHUP) {\r\ncosm_scif_close(cdev);\r\nbreak;\r\n}\r\nif (!rc && cdev->heartbeat_watchdog_enable)\r\ncosm_set_crashed(cdev);\r\n}\r\nexit:\r\ndev_dbg(&cdev->dev, "%s %d exiting\n", __func__, __LINE__);\r\nmutex_unlock(&cdev->cosm_mutex);\r\n}\r\nstatic int cosm_scif_server(void *unused)\r\n{\r\nstruct cosm_device *cdev;\r\nscif_epd_t newepd;\r\nstruct scif_port_id port_id;\r\nint rc;\r\nallow_signal(SIGKILL);\r\nwhile (!kthread_should_stop()) {\r\nrc = scif_accept(listen_epd, &port_id, &newepd,\r\nSCIF_ACCEPT_SYNC);\r\nif (rc < 0) {\r\nif (-ERESTARTSYS != rc)\r\npr_err("%s %d rc %d\n", __func__, __LINE__, rc);\r\ncontinue;\r\n}\r\ncdev = cosm_find_cdev_by_id(port_id.node - 1);\r\nif (!cdev)\r\ncontinue;\r\ncdev->newepd = newepd;\r\nschedule_work(&cdev->scif_work);\r\n}\r\npr_debug("%s %d Server thread stopped\n", __func__, __LINE__);\r\nreturn 0;\r\n}\r\nstatic int cosm_scif_listen(void)\r\n{\r\nint rc;\r\nlisten_epd = scif_open();\r\nif (!listen_epd) {\r\npr_err("%s %d scif_open failed\n", __func__, __LINE__);\r\nreturn -ENOMEM;\r\n}\r\nrc = scif_bind(listen_epd, SCIF_COSM_LISTEN_PORT);\r\nif (rc < 0) {\r\npr_err("%s %d scif_bind failed rc %d\n",\r\n__func__, __LINE__, rc);\r\ngoto err;\r\n}\r\nrc = scif_listen(listen_epd, COSM_SCIF_BACKLOG);\r\nif (rc < 0) {\r\npr_err("%s %d scif_listen rc %d\n", __func__, __LINE__, rc);\r\ngoto err;\r\n}\r\npr_debug("%s %d listen_epd set up\n", __func__, __LINE__);\r\nreturn 0;\r\nerr:\r\nscif_close(listen_epd);\r\nlisten_epd = NULL;\r\nreturn rc;\r\n}\r\nstatic void cosm_scif_listen_exit(void)\r\n{\r\npr_debug("%s %d closing listen_epd\n", __func__, __LINE__);\r\nif (listen_epd) {\r\nscif_close(listen_epd);\r\nlisten_epd = NULL;\r\n}\r\n}\r\nint cosm_scif_init(void)\r\n{\r\nint rc = cosm_scif_listen();\r\nif (rc) {\r\npr_err("%s %d cosm_scif_listen rc %d\n",\r\n__func__, __LINE__, rc);\r\ngoto err;\r\n}\r\nserver_thread = kthread_run(cosm_scif_server, NULL, "cosm_server");\r\nif (IS_ERR(server_thread)) {\r\nrc = PTR_ERR(server_thread);\r\npr_err("%s %d kthread_run rc %d\n", __func__, __LINE__, rc);\r\ngoto listen_exit;\r\n}\r\nreturn 0;\r\nlisten_exit:\r\ncosm_scif_listen_exit();\r\nerr:\r\nreturn rc;\r\n}\r\nvoid cosm_scif_exit(void)\r\n{\r\nint rc;\r\nif (!IS_ERR_OR_NULL(server_thread)) {\r\nrc = send_sig(SIGKILL, server_thread, 0);\r\nif (rc) {\r\npr_err("%s %d send_sig rc %d\n",\r\n__func__, __LINE__, rc);\r\nreturn;\r\n}\r\nkthread_stop(server_thread);\r\n}\r\ncosm_scif_listen_exit();\r\n}

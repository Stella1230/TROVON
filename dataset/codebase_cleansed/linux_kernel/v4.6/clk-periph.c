static unsigned long clk_periclk_recalc_rate(struct clk_hw *hwclk,\r\nunsigned long parent_rate)\r\n{\r\nstruct socfpga_periph_clk *socfpgaclk = to_socfpga_periph_clk(hwclk);\r\nu32 div, val;\r\nif (socfpgaclk->fixed_div) {\r\ndiv = socfpgaclk->fixed_div;\r\n} else {\r\nif (socfpgaclk->div_reg) {\r\nval = readl(socfpgaclk->div_reg) >> socfpgaclk->shift;\r\nval &= GENMASK(socfpgaclk->width - 1, 0);\r\nparent_rate /= (val + 1);\r\n}\r\ndiv = ((readl(socfpgaclk->hw.reg) & 0x1ff) + 1);\r\n}\r\nreturn parent_rate / div;\r\n}\r\nstatic u8 clk_periclk_get_parent(struct clk_hw *hwclk)\r\n{\r\nu32 clk_src;\r\nclk_src = readl(clk_mgr_base_addr + CLKMGR_DBCTRL);\r\nreturn clk_src & 0x1;\r\n}\r\nstatic __init void __socfpga_periph_init(struct device_node *node,\r\nconst struct clk_ops *ops)\r\n{\r\nu32 reg;\r\nstruct clk *clk;\r\nstruct socfpga_periph_clk *periph_clk;\r\nconst char *clk_name = node->name;\r\nconst char *parent_name[SOCFPGA_MAX_PARENTS];\r\nstruct clk_init_data init;\r\nint rc;\r\nu32 fixed_div;\r\nu32 div_reg[3];\r\nof_property_read_u32(node, "reg", &reg);\r\nperiph_clk = kzalloc(sizeof(*periph_clk), GFP_KERNEL);\r\nif (WARN_ON(!periph_clk))\r\nreturn;\r\nperiph_clk->hw.reg = clk_mgr_base_addr + reg;\r\nrc = of_property_read_u32_array(node, "div-reg", div_reg, 3);\r\nif (!rc) {\r\nperiph_clk->div_reg = clk_mgr_base_addr + div_reg[0];\r\nperiph_clk->shift = div_reg[1];\r\nperiph_clk->width = div_reg[2];\r\n} else {\r\nperiph_clk->div_reg = NULL;\r\n}\r\nrc = of_property_read_u32(node, "fixed-divider", &fixed_div);\r\nif (rc)\r\nperiph_clk->fixed_div = 0;\r\nelse\r\nperiph_clk->fixed_div = fixed_div;\r\nof_property_read_string(node, "clock-output-names", &clk_name);\r\ninit.name = clk_name;\r\ninit.ops = ops;\r\ninit.flags = 0;\r\ninit.num_parents = of_clk_parent_fill(node, parent_name,\r\nSOCFPGA_MAX_PARENTS);\r\ninit.parent_names = parent_name;\r\nperiph_clk->hw.hw.init = &init;\r\nclk = clk_register(NULL, &periph_clk->hw.hw);\r\nif (WARN_ON(IS_ERR(clk))) {\r\nkfree(periph_clk);\r\nreturn;\r\n}\r\nrc = of_clk_add_provider(node, of_clk_src_simple_get, clk);\r\n}\r\nvoid __init socfpga_periph_init(struct device_node *node)\r\n{\r\n__socfpga_periph_init(node, &periclk_ops);\r\n}

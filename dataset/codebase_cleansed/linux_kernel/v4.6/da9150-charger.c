static inline int da9150_charger_supply_online(struct da9150_charger *charger,\r\nstruct power_supply *psy,\r\nunion power_supply_propval *val)\r\n{\r\nval->intval = (psy == charger->supply_online) ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic int da9150_charger_vbus_voltage_now(struct da9150_charger *charger,\r\nunion power_supply_propval *val)\r\n{\r\nint v_val, ret;\r\nret = iio_read_channel_processed(charger->vbus_chan, &v_val);\r\nif (ret < 0)\r\nreturn ret;\r\nval->intval = v_val * 1000;\r\nreturn 0;\r\n}\r\nstatic int da9150_charger_ibus_current_avg(struct da9150_charger *charger,\r\nunion power_supply_propval *val)\r\n{\r\nint i_val, ret;\r\nret = iio_read_channel_processed(charger->ibus_chan, &i_val);\r\nif (ret < 0)\r\nreturn ret;\r\nval->intval = i_val * 1000;\r\nreturn 0;\r\n}\r\nstatic int da9150_charger_tjunc_temp(struct da9150_charger *charger,\r\nunion power_supply_propval *val)\r\n{\r\nint t_val, ret;\r\nret = iio_read_channel_processed(charger->tjunc_chan, &t_val);\r\nif (ret < 0)\r\nreturn ret;\r\nval->intval = t_val / 100;\r\nreturn 0;\r\n}\r\nstatic int da9150_charger_get_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct da9150_charger *charger = dev_get_drvdata(psy->dev.parent);\r\nint ret;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nret = da9150_charger_supply_online(charger, psy, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nret = da9150_charger_vbus_voltage_now(charger, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_AVG:\r\nret = da9150_charger_ibus_current_avg(charger, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP:\r\nret = da9150_charger_tjunc_temp(charger, val);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int da9150_charger_battery_status(struct da9150_charger *charger,\r\nunion power_supply_propval *val)\r\n{\r\nu8 reg;\r\nreg = da9150_reg_read(charger->da9150, DA9150_STATUS_H);\r\nif (((reg & DA9150_VBUS_STAT_MASK) == DA9150_VBUS_STAT_OFF) ||\r\n((reg & DA9150_VBUS_STAT_MASK) == DA9150_VBUS_STAT_WAIT)) {\r\nval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\r\nreturn 0;\r\n}\r\nreg = da9150_reg_read(charger->da9150, DA9150_STATUS_J);\r\nswitch (reg & DA9150_CHG_STAT_MASK) {\r\ncase DA9150_CHG_STAT_ACT:\r\ncase DA9150_CHG_STAT_PRE:\r\ncase DA9150_CHG_STAT_CC:\r\ncase DA9150_CHG_STAT_CV:\r\nval->intval = POWER_SUPPLY_STATUS_CHARGING;\r\nbreak;\r\ncase DA9150_CHG_STAT_OFF:\r\ncase DA9150_CHG_STAT_SUSP:\r\ncase DA9150_CHG_STAT_TEMP:\r\ncase DA9150_CHG_STAT_TIME:\r\ncase DA9150_CHG_STAT_BAT:\r\nval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\nbreak;\r\ncase DA9150_CHG_STAT_FULL:\r\nval->intval = POWER_SUPPLY_STATUS_FULL;\r\nbreak;\r\ndefault:\r\nval->intval = POWER_SUPPLY_STATUS_UNKNOWN;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int da9150_charger_battery_health(struct da9150_charger *charger,\r\nunion power_supply_propval *val)\r\n{\r\nu8 reg;\r\nreg = da9150_reg_read(charger->da9150, DA9150_STATUS_J);\r\nswitch (reg & DA9150_CHG_TEMP_MASK) {\r\ncase DA9150_CHG_TEMP_UNDER:\r\nval->intval = POWER_SUPPLY_HEALTH_COLD;\r\nreturn 0;\r\ncase DA9150_CHG_TEMP_OVER:\r\nval->intval = POWER_SUPPLY_HEALTH_OVERHEAT;\r\nreturn 0;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (reg & DA9150_CHG_STAT_MASK) {\r\ncase DA9150_CHG_STAT_ACT:\r\ncase DA9150_CHG_STAT_PRE:\r\nval->intval = POWER_SUPPLY_HEALTH_DEAD;\r\nbreak;\r\ncase DA9150_CHG_STAT_TIME:\r\nval->intval = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\r\nbreak;\r\ndefault:\r\nval->intval = POWER_SUPPLY_HEALTH_GOOD;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int da9150_charger_battery_present(struct da9150_charger *charger,\r\nunion power_supply_propval *val)\r\n{\r\nu8 reg;\r\nreg = da9150_reg_read(charger->da9150, DA9150_STATUS_J);\r\nif ((reg & DA9150_CHG_STAT_MASK) == DA9150_CHG_STAT_BAT)\r\nval->intval = 0;\r\nelse\r\nval->intval = 1;\r\nreturn 0;\r\n}\r\nstatic int da9150_charger_battery_charge_type(struct da9150_charger *charger,\r\nunion power_supply_propval *val)\r\n{\r\nu8 reg;\r\nreg = da9150_reg_read(charger->da9150, DA9150_STATUS_J);\r\nswitch (reg & DA9150_CHG_STAT_MASK) {\r\ncase DA9150_CHG_STAT_CC:\r\nval->intval = POWER_SUPPLY_CHARGE_TYPE_FAST;\r\nbreak;\r\ncase DA9150_CHG_STAT_ACT:\r\ncase DA9150_CHG_STAT_PRE:\r\ncase DA9150_CHG_STAT_CV:\r\nval->intval = POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\r\nbreak;\r\ndefault:\r\nval->intval = POWER_SUPPLY_CHARGE_TYPE_NONE;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int da9150_charger_battery_voltage_min(struct da9150_charger *charger,\r\nunion power_supply_propval *val)\r\n{\r\nu8 reg;\r\nreg = da9150_reg_read(charger->da9150, DA9150_PPR_CHGCTRL_C);\r\nval->intval = ((reg & DA9150_CHG_VFAULT_MASK) * 50000) + 2500000;\r\nreturn 0;\r\n}\r\nstatic int da9150_charger_battery_voltage_now(struct da9150_charger *charger,\r\nunion power_supply_propval *val)\r\n{\r\nint v_val, ret;\r\nret = iio_read_channel_processed(charger->vbat_chan, &v_val);\r\nif (ret < 0)\r\nreturn ret;\r\nval->intval = v_val * 1000;\r\nreturn 0;\r\n}\r\nstatic int da9150_charger_battery_current_max(struct da9150_charger *charger,\r\nunion power_supply_propval *val)\r\n{\r\nint reg;\r\nreg = da9150_reg_read(charger->da9150, DA9150_PPR_CHGCTRL_D);\r\nval->intval = reg * 25000;\r\nreturn 0;\r\n}\r\nstatic int da9150_charger_battery_voltage_max(struct da9150_charger *charger,\r\nunion power_supply_propval *val)\r\n{\r\nu8 reg;\r\nreg = da9150_reg_read(charger->da9150, DA9150_PPR_CHGCTRL_B);\r\nval->intval = ((reg & DA9150_CHG_VBAT_MASK) * 25000) + 3650000;\r\nreturn 0;\r\n}\r\nstatic int da9150_charger_battery_get_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct da9150_charger *charger = dev_get_drvdata(psy->dev.parent);\r\nint ret;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nret = da9150_charger_battery_status(charger, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nret = da9150_charger_supply_online(charger, psy, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nret = da9150_charger_battery_health(charger, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nret = da9150_charger_battery_present(charger, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_TYPE:\r\nret = da9150_charger_battery_charge_type(charger, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN:\r\nret = da9150_charger_battery_voltage_min(charger, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nret = da9150_charger_battery_voltage_now(charger, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX:\r\nret = da9150_charger_battery_current_max(charger, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE_MAX:\r\nret = da9150_charger_battery_voltage_max(charger, val);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic irqreturn_t da9150_charger_chg_irq(int irq, void *data)\r\n{\r\nstruct da9150_charger *charger = data;\r\npower_supply_changed(charger->battery);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t da9150_charger_tjunc_irq(int irq, void *data)\r\n{\r\nstruct da9150_charger *charger = data;\r\ndev_crit(charger->dev, "TJunc over temperature!!!\n");\r\npower_supply_changed(charger->usb);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t da9150_charger_vfault_irq(int irq, void *data)\r\n{\r\nstruct da9150_charger *charger = data;\r\ndev_crit(charger->dev, "VSYS under voltage!!!\n");\r\npower_supply_changed(charger->usb);\r\npower_supply_changed(charger->battery);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t da9150_charger_vbus_irq(int irq, void *data)\r\n{\r\nstruct da9150_charger *charger = data;\r\nu8 reg;\r\nreg = da9150_reg_read(charger->da9150, DA9150_STATUS_H);\r\nswitch (reg & DA9150_VBUS_STAT_MASK) {\r\ncase DA9150_VBUS_STAT_OFF:\r\ncase DA9150_VBUS_STAT_WAIT:\r\ncharger->supply_online = charger->battery;\r\nbreak;\r\ncase DA9150_VBUS_STAT_CHG:\r\ncharger->supply_online = charger->usb;\r\nbreak;\r\ndefault:\r\ndev_warn(charger->dev, "Unknown VBUS state - reg = 0x%x\n",\r\nreg);\r\ncharger->supply_online = NULL;\r\nbreak;\r\n}\r\npower_supply_changed(charger->usb);\r\npower_supply_changed(charger->battery);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void da9150_charger_otg_work(struct work_struct *data)\r\n{\r\nstruct da9150_charger *charger =\r\ncontainer_of(data, struct da9150_charger, otg_work);\r\nswitch (charger->usb_event) {\r\ncase USB_EVENT_ID:\r\nda9150_set_bits(charger->da9150, DA9150_PPR_BKCTRL_A,\r\nDA9150_VBUS_MODE_MASK, DA9150_VBUS_MODE_OTG);\r\nbreak;\r\ncase USB_EVENT_NONE:\r\npower_supply_changed(charger->usb);\r\npower_supply_changed(charger->battery);\r\nda9150_set_bits(charger->da9150, DA9150_PPR_BKCTRL_A,\r\nDA9150_VBUS_MODE_MASK, DA9150_VBUS_MODE_CHG);\r\nbreak;\r\n}\r\n}\r\nstatic int da9150_charger_otg_ncb(struct notifier_block *nb, unsigned long val,\r\nvoid *priv)\r\n{\r\nstruct da9150_charger *charger =\r\ncontainer_of(nb, struct da9150_charger, otg_nb);\r\ndev_dbg(charger->dev, "DA9150 OTG notify %lu\n", val);\r\ncharger->usb_event = val;\r\nschedule_work(&charger->otg_work);\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int da9150_charger_register_irq(struct platform_device *pdev,\r\nirq_handler_t handler,\r\nconst char *irq_name)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct da9150_charger *charger = platform_get_drvdata(pdev);\r\nint irq, ret;\r\nirq = platform_get_irq_byname(pdev, irq_name);\r\nif (irq < 0) {\r\ndev_err(dev, "Failed to get IRQ CHG_STATUS: %d\n", irq);\r\nreturn irq;\r\n}\r\nret = request_threaded_irq(irq, NULL, handler, IRQF_ONESHOT, irq_name,\r\ncharger);\r\nif (ret)\r\ndev_err(dev, "Failed to request IRQ %d: %d\n", irq, ret);\r\nreturn ret;\r\n}\r\nstatic void da9150_charger_unregister_irq(struct platform_device *pdev,\r\nconst char *irq_name)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct da9150_charger *charger = platform_get_drvdata(pdev);\r\nint irq;\r\nirq = platform_get_irq_byname(pdev, irq_name);\r\nif (irq < 0) {\r\ndev_err(dev, "Failed to get IRQ CHG_STATUS: %d\n", irq);\r\nreturn;\r\n}\r\nfree_irq(irq, charger);\r\n}\r\nstatic int da9150_charger_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct da9150 *da9150 = dev_get_drvdata(dev->parent);\r\nstruct da9150_charger *charger;\r\nu8 reg;\r\nint ret;\r\ncharger = devm_kzalloc(dev, sizeof(struct da9150_charger), GFP_KERNEL);\r\nif (!charger)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, charger);\r\ncharger->da9150 = da9150;\r\ncharger->dev = dev;\r\ncharger->ibus_chan = iio_channel_get(dev, "CHAN_IBUS");\r\nif (IS_ERR(charger->ibus_chan)) {\r\nret = PTR_ERR(charger->ibus_chan);\r\ngoto ibus_chan_fail;\r\n}\r\ncharger->vbus_chan = iio_channel_get(dev, "CHAN_VBUS");\r\nif (IS_ERR(charger->vbus_chan)) {\r\nret = PTR_ERR(charger->vbus_chan);\r\ngoto vbus_chan_fail;\r\n}\r\ncharger->tjunc_chan = iio_channel_get(dev, "CHAN_TJUNC");\r\nif (IS_ERR(charger->tjunc_chan)) {\r\nret = PTR_ERR(charger->tjunc_chan);\r\ngoto tjunc_chan_fail;\r\n}\r\ncharger->vbat_chan = iio_channel_get(dev, "CHAN_VBAT");\r\nif (IS_ERR(charger->vbat_chan)) {\r\nret = PTR_ERR(charger->vbat_chan);\r\ngoto vbat_chan_fail;\r\n}\r\ncharger->usb = power_supply_register(dev, &usb_desc, NULL);\r\nif (IS_ERR(charger->usb)) {\r\nret = PTR_ERR(charger->usb);\r\ngoto usb_fail;\r\n}\r\ncharger->battery = power_supply_register(dev, &battery_desc, NULL);\r\nif (IS_ERR(charger->battery)) {\r\nret = PTR_ERR(charger->battery);\r\ngoto battery_fail;\r\n}\r\nreg = da9150_reg_read(da9150, DA9150_STATUS_H);\r\nswitch (reg & DA9150_VBUS_STAT_MASK) {\r\ncase DA9150_VBUS_STAT_OFF:\r\ncase DA9150_VBUS_STAT_WAIT:\r\ncharger->supply_online = charger->battery;\r\nbreak;\r\ncase DA9150_VBUS_STAT_CHG:\r\ncharger->supply_online = charger->usb;\r\nbreak;\r\ndefault:\r\ndev_warn(dev, "Unknown VBUS state - reg = 0x%x\n", reg);\r\ncharger->supply_online = NULL;\r\nbreak;\r\n}\r\ncharger->usb_phy = devm_usb_get_phy(dev, USB_PHY_TYPE_USB2);\r\nif (!IS_ERR_OR_NULL(charger->usb_phy)) {\r\nINIT_WORK(&charger->otg_work, da9150_charger_otg_work);\r\ncharger->otg_nb.notifier_call = da9150_charger_otg_ncb;\r\nusb_register_notifier(charger->usb_phy, &charger->otg_nb);\r\n}\r\nret = da9150_charger_register_irq(pdev, da9150_charger_chg_irq,\r\n"CHG_STATUS");\r\nif (ret < 0)\r\ngoto chg_irq_fail;\r\nret = da9150_charger_register_irq(pdev, da9150_charger_tjunc_irq,\r\n"CHG_TJUNC");\r\nif (ret < 0)\r\ngoto tjunc_irq_fail;\r\nret = da9150_charger_register_irq(pdev, da9150_charger_vfault_irq,\r\n"CHG_VFAULT");\r\nif (ret < 0)\r\ngoto vfault_irq_fail;\r\nret = da9150_charger_register_irq(pdev, da9150_charger_vbus_irq,\r\n"CHG_VBUS");\r\nif (ret < 0)\r\ngoto vbus_irq_fail;\r\nreturn 0;\r\nvbus_irq_fail:\r\nda9150_charger_unregister_irq(pdev, "CHG_VFAULT");\r\nvfault_irq_fail:\r\nda9150_charger_unregister_irq(pdev, "CHG_TJUNC");\r\ntjunc_irq_fail:\r\nda9150_charger_unregister_irq(pdev, "CHG_STATUS");\r\nchg_irq_fail:\r\nif (!IS_ERR_OR_NULL(charger->usb_phy))\r\nusb_unregister_notifier(charger->usb_phy, &charger->otg_nb);\r\nbattery_fail:\r\npower_supply_unregister(charger->usb);\r\nusb_fail:\r\niio_channel_release(charger->vbat_chan);\r\nvbat_chan_fail:\r\niio_channel_release(charger->tjunc_chan);\r\ntjunc_chan_fail:\r\niio_channel_release(charger->vbus_chan);\r\nvbus_chan_fail:\r\niio_channel_release(charger->ibus_chan);\r\nibus_chan_fail:\r\nreturn ret;\r\n}\r\nstatic int da9150_charger_remove(struct platform_device *pdev)\r\n{\r\nstruct da9150_charger *charger = platform_get_drvdata(pdev);\r\nint irq;\r\nirq = platform_get_irq_byname(pdev, "CHG_VBUS");\r\nfree_irq(irq, charger);\r\nirq = platform_get_irq_byname(pdev, "CHG_VFAULT");\r\nfree_irq(irq, charger);\r\nirq = platform_get_irq_byname(pdev, "CHG_TJUNC");\r\nfree_irq(irq, charger);\r\nirq = platform_get_irq_byname(pdev, "CHG_STATUS");\r\nfree_irq(irq, charger);\r\nif (!IS_ERR_OR_NULL(charger->usb_phy))\r\nusb_unregister_notifier(charger->usb_phy, &charger->otg_nb);\r\npower_supply_unregister(charger->battery);\r\npower_supply_unregister(charger->usb);\r\niio_channel_release(charger->ibus_chan);\r\niio_channel_release(charger->vbus_chan);\r\niio_channel_release(charger->tjunc_chan);\r\niio_channel_release(charger->vbat_chan);\r\nreturn 0;\r\n}

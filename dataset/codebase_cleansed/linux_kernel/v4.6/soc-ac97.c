static void soc_ac97_device_release(struct device *dev)\r\n{\r\nkfree(to_ac97_t(dev));\r\n}\r\nstatic inline struct snd_soc_codec *gpio_to_codec(struct gpio_chip *chip)\r\n{\r\nstruct snd_ac97_gpio_priv *gpio_priv =\r\ncontainer_of(chip, struct snd_ac97_gpio_priv, gpio_chip);\r\nreturn gpio_priv->codec;\r\n}\r\nstatic int snd_soc_ac97_gpio_request(struct gpio_chip *chip, unsigned offset)\r\n{\r\nif (offset >= AC97_NUM_GPIOS)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int snd_soc_ac97_gpio_direction_in(struct gpio_chip *chip,\r\nunsigned offset)\r\n{\r\nstruct snd_soc_codec *codec = gpio_to_codec(chip);\r\ndev_dbg(codec->dev, "set gpio %d to output\n", offset);\r\nreturn snd_soc_update_bits(codec, AC97_GPIO_CFG,\r\n1 << offset, 1 << offset);\r\n}\r\nstatic int snd_soc_ac97_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct snd_soc_codec *codec = gpio_to_codec(chip);\r\nint ret;\r\nret = snd_soc_read(codec, AC97_GPIO_STATUS);\r\ndev_dbg(codec->dev, "get gpio %d : %d\n", offset,\r\nret < 0 ? ret : ret & (1 << offset));\r\nreturn ret < 0 ? ret : !!(ret & (1 << offset));\r\n}\r\nstatic void snd_soc_ac97_gpio_set(struct gpio_chip *chip, unsigned offset,\r\nint value)\r\n{\r\nstruct snd_ac97_gpio_priv *gpio_priv =\r\ncontainer_of(chip, struct snd_ac97_gpio_priv, gpio_chip);\r\nstruct snd_soc_codec *codec = gpio_to_codec(chip);\r\ngpio_priv->gpios_set &= ~(1 << offset);\r\ngpio_priv->gpios_set |= (!!value) << offset;\r\nsnd_soc_write(codec, AC97_GPIO_STATUS, gpio_priv->gpios_set);\r\ndev_dbg(codec->dev, "set gpio %d to %d\n", offset, !!value);\r\n}\r\nstatic int snd_soc_ac97_gpio_direction_out(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nstruct snd_soc_codec *codec = gpio_to_codec(chip);\r\ndev_dbg(codec->dev, "set gpio %d to output\n", offset);\r\nsnd_soc_ac97_gpio_set(chip, offset, value);\r\nreturn snd_soc_update_bits(codec, AC97_GPIO_CFG, 1 << offset, 0);\r\n}\r\nstatic int snd_soc_ac97_init_gpio(struct snd_ac97 *ac97,\r\nstruct snd_soc_codec *codec)\r\n{\r\nstruct snd_ac97_gpio_priv *gpio_priv;\r\nint ret;\r\ngpio_priv = devm_kzalloc(codec->dev, sizeof(*gpio_priv), GFP_KERNEL);\r\nif (!gpio_priv)\r\nreturn -ENOMEM;\r\nac97->gpio_priv = gpio_priv;\r\ngpio_priv->codec = codec;\r\ngpio_priv->gpio_chip = snd_soc_ac97_gpio_chip;\r\ngpio_priv->gpio_chip.ngpio = AC97_NUM_GPIOS;\r\ngpio_priv->gpio_chip.parent = codec->dev;\r\ngpio_priv->gpio_chip.base = -1;\r\nret = gpiochip_add(&gpio_priv->gpio_chip);\r\nif (ret != 0)\r\ndev_err(codec->dev, "Failed to add GPIOs: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void snd_soc_ac97_free_gpio(struct snd_ac97 *ac97)\r\n{\r\ngpiochip_remove(&ac97->gpio_priv->gpio_chip);\r\n}\r\nstatic int snd_soc_ac97_init_gpio(struct snd_ac97 *ac97,\r\nstruct snd_soc_codec *codec)\r\n{\r\nreturn 0;\r\n}\r\nstatic void snd_soc_ac97_free_gpio(struct snd_ac97 *ac97)\r\n{\r\n}\r\nstruct snd_ac97 *snd_soc_alloc_ac97_codec(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_ac97 *ac97;\r\nac97 = kzalloc(sizeof(struct snd_ac97), GFP_KERNEL);\r\nif (ac97 == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nac97->bus = &soc_ac97_bus;\r\nac97->num = 0;\r\nac97->dev.bus = &ac97_bus_type;\r\nac97->dev.parent = codec->component.card->dev;\r\nac97->dev.release = soc_ac97_device_release;\r\ndev_set_name(&ac97->dev, "%d-%d:%s",\r\ncodec->component.card->snd_card->number, 0,\r\ncodec->component.name);\r\ndevice_initialize(&ac97->dev);\r\nreturn ac97;\r\n}\r\nstruct snd_ac97 *snd_soc_new_ac97_codec(struct snd_soc_codec *codec,\r\nunsigned int id, unsigned int id_mask)\r\n{\r\nstruct snd_ac97 *ac97;\r\nint ret;\r\nac97 = snd_soc_alloc_ac97_codec(codec);\r\nif (IS_ERR(ac97))\r\nreturn ac97;\r\nif (id) {\r\nret = snd_ac97_reset(ac97, false, id, id_mask);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to reset AC97 device: %d\n",\r\nret);\r\ngoto err_put_device;\r\n}\r\n}\r\nret = device_add(&ac97->dev);\r\nif (ret)\r\ngoto err_put_device;\r\nret = snd_soc_ac97_init_gpio(ac97, codec);\r\nif (ret)\r\ngoto err_put_device;\r\nreturn ac97;\r\nerr_put_device:\r\nput_device(&ac97->dev);\r\nreturn ERR_PTR(ret);\r\n}\r\nvoid snd_soc_free_ac97_codec(struct snd_ac97 *ac97)\r\n{\r\nsnd_soc_ac97_free_gpio(ac97);\r\ndevice_del(&ac97->dev);\r\nac97->bus = NULL;\r\nput_device(&ac97->dev);\r\n}\r\nstatic void snd_soc_ac97_warm_reset(struct snd_ac97 *ac97)\r\n{\r\nstruct pinctrl *pctl = snd_ac97_rst_cfg.pctl;\r\npinctrl_select_state(pctl, snd_ac97_rst_cfg.pstate_warm_reset);\r\ngpio_direction_output(snd_ac97_rst_cfg.gpio_sync, 1);\r\nudelay(10);\r\ngpio_direction_output(snd_ac97_rst_cfg.gpio_sync, 0);\r\npinctrl_select_state(pctl, snd_ac97_rst_cfg.pstate_run);\r\nmsleep(2);\r\n}\r\nstatic void snd_soc_ac97_reset(struct snd_ac97 *ac97)\r\n{\r\nstruct pinctrl *pctl = snd_ac97_rst_cfg.pctl;\r\npinctrl_select_state(pctl, snd_ac97_rst_cfg.pstate_reset);\r\ngpio_direction_output(snd_ac97_rst_cfg.gpio_sync, 0);\r\ngpio_direction_output(snd_ac97_rst_cfg.gpio_sdata, 0);\r\ngpio_direction_output(snd_ac97_rst_cfg.gpio_reset, 0);\r\nudelay(10);\r\ngpio_direction_output(snd_ac97_rst_cfg.gpio_reset, 1);\r\npinctrl_select_state(pctl, snd_ac97_rst_cfg.pstate_run);\r\nmsleep(2);\r\n}\r\nstatic int snd_soc_ac97_parse_pinctl(struct device *dev,\r\nstruct snd_ac97_reset_cfg *cfg)\r\n{\r\nstruct pinctrl *p;\r\nstruct pinctrl_state *state;\r\nint gpio;\r\nint ret;\r\np = devm_pinctrl_get(dev);\r\nif (IS_ERR(p)) {\r\ndev_err(dev, "Failed to get pinctrl\n");\r\nreturn PTR_ERR(p);\r\n}\r\ncfg->pctl = p;\r\nstate = pinctrl_lookup_state(p, "ac97-reset");\r\nif (IS_ERR(state)) {\r\ndev_err(dev, "Can't find pinctrl state ac97-reset\n");\r\nreturn PTR_ERR(state);\r\n}\r\ncfg->pstate_reset = state;\r\nstate = pinctrl_lookup_state(p, "ac97-warm-reset");\r\nif (IS_ERR(state)) {\r\ndev_err(dev, "Can't find pinctrl state ac97-warm-reset\n");\r\nreturn PTR_ERR(state);\r\n}\r\ncfg->pstate_warm_reset = state;\r\nstate = pinctrl_lookup_state(p, "ac97-running");\r\nif (IS_ERR(state)) {\r\ndev_err(dev, "Can't find pinctrl state ac97-running\n");\r\nreturn PTR_ERR(state);\r\n}\r\ncfg->pstate_run = state;\r\ngpio = of_get_named_gpio(dev->of_node, "ac97-gpios", 0);\r\nif (gpio < 0) {\r\ndev_err(dev, "Can't find ac97-sync gpio\n");\r\nreturn gpio;\r\n}\r\nret = devm_gpio_request(dev, gpio, "AC97 link sync");\r\nif (ret) {\r\ndev_err(dev, "Failed requesting ac97-sync gpio\n");\r\nreturn ret;\r\n}\r\ncfg->gpio_sync = gpio;\r\ngpio = of_get_named_gpio(dev->of_node, "ac97-gpios", 1);\r\nif (gpio < 0) {\r\ndev_err(dev, "Can't find ac97-sdata gpio %d\n", gpio);\r\nreturn gpio;\r\n}\r\nret = devm_gpio_request(dev, gpio, "AC97 link sdata");\r\nif (ret) {\r\ndev_err(dev, "Failed requesting ac97-sdata gpio\n");\r\nreturn ret;\r\n}\r\ncfg->gpio_sdata = gpio;\r\ngpio = of_get_named_gpio(dev->of_node, "ac97-gpios", 2);\r\nif (gpio < 0) {\r\ndev_err(dev, "Can't find ac97-reset gpio\n");\r\nreturn gpio;\r\n}\r\nret = devm_gpio_request(dev, gpio, "AC97 link reset");\r\nif (ret) {\r\ndev_err(dev, "Failed requesting ac97-reset gpio\n");\r\nreturn ret;\r\n}\r\ncfg->gpio_reset = gpio;\r\nreturn 0;\r\n}\r\nint snd_soc_set_ac97_ops(struct snd_ac97_bus_ops *ops)\r\n{\r\nif (ops == soc_ac97_ops)\r\nreturn 0;\r\nif (soc_ac97_ops && ops)\r\nreturn -EBUSY;\r\nsoc_ac97_ops = ops;\r\nsoc_ac97_bus.ops = ops;\r\nreturn 0;\r\n}\r\nint snd_soc_set_ac97_ops_of_reset(struct snd_ac97_bus_ops *ops,\r\nstruct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct snd_ac97_reset_cfg cfg;\r\nint ret;\r\nret = snd_soc_ac97_parse_pinctl(dev, &cfg);\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_set_ac97_ops(ops);\r\nif (ret)\r\nreturn ret;\r\nops->warm_reset = snd_soc_ac97_warm_reset;\r\nops->reset = snd_soc_ac97_reset;\r\nsnd_ac97_rst_cfg = cfg;\r\nreturn 0;\r\n}

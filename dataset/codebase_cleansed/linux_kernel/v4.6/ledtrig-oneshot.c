static ssize_t led_shot(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct oneshot_trig_data *oneshot_data = led_cdev->trigger_data;\r\nled_blink_set_oneshot(led_cdev,\r\n&led_cdev->blink_delay_on, &led_cdev->blink_delay_off,\r\noneshot_data->invert);\r\nreturn size;\r\n}\r\nstatic ssize_t led_invert_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct oneshot_trig_data *oneshot_data = led_cdev->trigger_data;\r\nreturn sprintf(buf, "%u\n", oneshot_data->invert);\r\n}\r\nstatic ssize_t led_invert_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct oneshot_trig_data *oneshot_data = led_cdev->trigger_data;\r\nunsigned long state;\r\nint ret;\r\nret = kstrtoul(buf, 0, &state);\r\nif (ret)\r\nreturn ret;\r\noneshot_data->invert = !!state;\r\nif (oneshot_data->invert)\r\nled_set_brightness_nosleep(led_cdev, LED_FULL);\r\nelse\r\nled_set_brightness_nosleep(led_cdev, LED_OFF);\r\nreturn size;\r\n}\r\nstatic ssize_t led_delay_on_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%lu\n", led_cdev->blink_delay_on);\r\n}\r\nstatic ssize_t led_delay_on_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nunsigned long state;\r\nint ret;\r\nret = kstrtoul(buf, 0, &state);\r\nif (ret)\r\nreturn ret;\r\nled_cdev->blink_delay_on = state;\r\nreturn size;\r\n}\r\nstatic ssize_t led_delay_off_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%lu\n", led_cdev->blink_delay_off);\r\n}\r\nstatic ssize_t led_delay_off_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nunsigned long state;\r\nint ret;\r\nret = kstrtoul(buf, 0, &state);\r\nif (ret)\r\nreturn ret;\r\nled_cdev->blink_delay_off = state;\r\nreturn size;\r\n}\r\nstatic void oneshot_trig_activate(struct led_classdev *led_cdev)\r\n{\r\nstruct oneshot_trig_data *oneshot_data;\r\nint rc;\r\noneshot_data = kzalloc(sizeof(*oneshot_data), GFP_KERNEL);\r\nif (!oneshot_data)\r\nreturn;\r\nled_cdev->trigger_data = oneshot_data;\r\nrc = device_create_file(led_cdev->dev, &dev_attr_delay_on);\r\nif (rc)\r\ngoto err_out_trig_data;\r\nrc = device_create_file(led_cdev->dev, &dev_attr_delay_off);\r\nif (rc)\r\ngoto err_out_delayon;\r\nrc = device_create_file(led_cdev->dev, &dev_attr_invert);\r\nif (rc)\r\ngoto err_out_delayoff;\r\nrc = device_create_file(led_cdev->dev, &dev_attr_shot);\r\nif (rc)\r\ngoto err_out_invert;\r\nled_cdev->blink_delay_on = DEFAULT_DELAY;\r\nled_cdev->blink_delay_off = DEFAULT_DELAY;\r\nled_cdev->activated = true;\r\nreturn;\r\nerr_out_invert:\r\ndevice_remove_file(led_cdev->dev, &dev_attr_invert);\r\nerr_out_delayoff:\r\ndevice_remove_file(led_cdev->dev, &dev_attr_delay_off);\r\nerr_out_delayon:\r\ndevice_remove_file(led_cdev->dev, &dev_attr_delay_on);\r\nerr_out_trig_data:\r\nkfree(led_cdev->trigger_data);\r\n}\r\nstatic void oneshot_trig_deactivate(struct led_classdev *led_cdev)\r\n{\r\nstruct oneshot_trig_data *oneshot_data = led_cdev->trigger_data;\r\nif (led_cdev->activated) {\r\ndevice_remove_file(led_cdev->dev, &dev_attr_delay_on);\r\ndevice_remove_file(led_cdev->dev, &dev_attr_delay_off);\r\ndevice_remove_file(led_cdev->dev, &dev_attr_invert);\r\ndevice_remove_file(led_cdev->dev, &dev_attr_shot);\r\nkfree(oneshot_data);\r\nled_cdev->activated = false;\r\n}\r\nled_set_brightness(led_cdev, LED_OFF);\r\n}\r\nstatic int __init oneshot_trig_init(void)\r\n{\r\nreturn led_trigger_register(&oneshot_led_trigger);\r\n}\r\nstatic void __exit oneshot_trig_exit(void)\r\n{\r\nled_trigger_unregister(&oneshot_led_trigger);\r\n}

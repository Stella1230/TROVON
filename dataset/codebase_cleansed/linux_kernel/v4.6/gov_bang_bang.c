static void thermal_zone_trip_update(struct thermal_zone_device *tz, int trip)\r\n{\r\nint trip_temp, trip_hyst;\r\nstruct thermal_instance *instance;\r\ntz->ops->get_trip_temp(tz, trip, &trip_temp);\r\ntz->ops->get_trip_hyst(tz, trip, &trip_hyst);\r\ndev_dbg(&tz->device, "Trip%d[temp=%d]:temp=%d:hyst=%d\n",\r\ntrip, trip_temp, tz->temperature,\r\ntrip_hyst);\r\nmutex_lock(&tz->lock);\r\nlist_for_each_entry(instance, &tz->thermal_instances, tz_node) {\r\nif (instance->trip != trip)\r\ncontinue;\r\nif (instance->target == THERMAL_NO_TARGET)\r\ninstance->target = 0;\r\nif (instance->target != 0 && instance->target != 1) {\r\npr_warn("Thermal instance %s controlled by bang-bang has unexpected state: %ld\n",\r\ninstance->name, instance->target);\r\ninstance->target = 1;\r\n}\r\nif (instance->target == 0 && tz->temperature >= trip_temp)\r\ninstance->target = 1;\r\nelse if (instance->target == 1 &&\r\ntz->temperature < trip_temp - trip_hyst)\r\ninstance->target = 0;\r\ndev_dbg(&instance->cdev->device, "target=%d\n",\r\n(int)instance->target);\r\ninstance->cdev->updated = false;\r\n}\r\nmutex_unlock(&tz->lock);\r\n}\r\nstatic int bang_bang_control(struct thermal_zone_device *tz, int trip)\r\n{\r\nstruct thermal_instance *instance;\r\nthermal_zone_trip_update(tz, trip);\r\nmutex_lock(&tz->lock);\r\nlist_for_each_entry(instance, &tz->thermal_instances, tz_node)\r\nthermal_cdev_update(instance->cdev);\r\nmutex_unlock(&tz->lock);\r\nreturn 0;\r\n}\r\nint thermal_gov_bang_bang_register(void)\r\n{\r\nreturn thermal_register_governor(&thermal_gov_bang_bang);\r\n}\r\nvoid thermal_gov_bang_bang_unregister(void)\r\n{\r\nthermal_unregister_governor(&thermal_gov_bang_bang);\r\n}

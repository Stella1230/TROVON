static void\r\n_warpdrive_disable_ddio(struct MPT3SAS_ADAPTER *ioc)\r\n{\r\nMpi2RaidVolPage1_t vol_pg1;\r\nMpi2ConfigReply_t mpi_reply;\r\nstruct _raid_device *raid_device;\r\nu16 handle;\r\nu16 ioc_status;\r\nunsigned long flags;\r\nhandle = 0xFFFF;\r\nwhile (!(mpt3sas_config_get_raid_volume_pg1(ioc, &mpi_reply,\r\n&vol_pg1, MPI2_RAID_VOLUME_PGAD_FORM_GET_NEXT_HANDLE, handle))) {\r\nioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\r\nMPI2_IOCSTATUS_MASK;\r\nif (ioc_status == MPI2_IOCSTATUS_CONFIG_INVALID_PAGE)\r\nbreak;\r\nhandle = le16_to_cpu(vol_pg1.DevHandle);\r\nspin_lock_irqsave(&ioc->raid_device_lock, flags);\r\nraid_device = mpt3sas_raid_device_find_by_handle(ioc, handle);\r\nif (raid_device)\r\nraid_device->direct_io_enabled = 0;\r\nspin_unlock_irqrestore(&ioc->raid_device_lock, flags);\r\n}\r\nreturn;\r\n}\r\nu8\r\nmpt3sas_get_num_volumes(struct MPT3SAS_ADAPTER *ioc)\r\n{\r\nMpi2RaidVolPage1_t vol_pg1;\r\nMpi2ConfigReply_t mpi_reply;\r\nu16 handle;\r\nu8 vol_cnt = 0;\r\nu16 ioc_status;\r\nhandle = 0xFFFF;\r\nwhile (!(mpt3sas_config_get_raid_volume_pg1(ioc, &mpi_reply,\r\n&vol_pg1, MPI2_RAID_VOLUME_PGAD_FORM_GET_NEXT_HANDLE, handle))) {\r\nioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\r\nMPI2_IOCSTATUS_MASK;\r\nif (ioc_status == MPI2_IOCSTATUS_CONFIG_INVALID_PAGE)\r\nbreak;\r\nvol_cnt++;\r\nhandle = le16_to_cpu(vol_pg1.DevHandle);\r\n}\r\nreturn vol_cnt;\r\n}\r\nvoid\r\nmpt3sas_init_warpdrive_properties(struct MPT3SAS_ADAPTER *ioc,\r\nstruct _raid_device *raid_device)\r\n{\r\nMpi2RaidVolPage0_t *vol_pg0;\r\nMpi2RaidPhysDiskPage0_t pd_pg0;\r\nMpi2ConfigReply_t mpi_reply;\r\nu16 sz;\r\nu8 num_pds, count;\r\nunsigned long stripe_sz, block_sz;\r\nu8 stripe_exp, block_exp;\r\nu64 dev_max_lba;\r\nif (!ioc->is_warpdrive)\r\nreturn;\r\nif (ioc->mfg_pg10_hide_flag == MFG_PAGE10_EXPOSE_ALL_DISKS) {\r\npr_info(MPT3SAS_FMT "WarpDrive : Direct IO is disabled "\r\n"globally as drives are exposed\n", ioc->name);\r\nreturn;\r\n}\r\nif (mpt3sas_get_num_volumes(ioc) > 1) {\r\n_warpdrive_disable_ddio(ioc);\r\npr_info(MPT3SAS_FMT "WarpDrive : Direct IO is disabled "\r\n"globally as number of drives > 1\n", ioc->name);\r\nreturn;\r\n}\r\nif ((mpt3sas_config_get_number_pds(ioc, raid_device->handle,\r\n&num_pds)) || !num_pds) {\r\npr_info(MPT3SAS_FMT "WarpDrive : Direct IO is disabled "\r\n"Failure in computing number of drives\n", ioc->name);\r\nreturn;\r\n}\r\nsz = offsetof(Mpi2RaidVolPage0_t, PhysDisk) + (num_pds *\r\nsizeof(Mpi2RaidVol0PhysDisk_t));\r\nvol_pg0 = kzalloc(sz, GFP_KERNEL);\r\nif (!vol_pg0) {\r\npr_info(MPT3SAS_FMT "WarpDrive : Direct IO is disabled "\r\n"Memory allocation failure for RVPG0\n", ioc->name);\r\nreturn;\r\n}\r\nif ((mpt3sas_config_get_raid_volume_pg0(ioc, &mpi_reply, vol_pg0,\r\nMPI2_RAID_VOLUME_PGAD_FORM_HANDLE, raid_device->handle, sz))) {\r\npr_info(MPT3SAS_FMT "WarpDrive : Direct IO is disabled "\r\n"Failure in retrieving RVPG0\n", ioc->name);\r\nkfree(vol_pg0);\r\nreturn;\r\n}\r\nif (num_pds > MPT_MAX_WARPDRIVE_PDS) {\r\npr_warn(MPT3SAS_FMT "WarpDrive : Direct IO is disabled "\r\n"for the drive with handle(0x%04x): num_mem=%d, "\r\n"max_mem_allowed=%d\n", ioc->name, raid_device->handle,\r\nnum_pds, MPT_MAX_WARPDRIVE_PDS);\r\nkfree(vol_pg0);\r\nreturn;\r\n}\r\nfor (count = 0; count < num_pds; count++) {\r\nif (mpt3sas_config_get_phys_disk_pg0(ioc, &mpi_reply,\r\n&pd_pg0, MPI2_PHYSDISK_PGAD_FORM_PHYSDISKNUM,\r\nvol_pg0->PhysDisk[count].PhysDiskNum) ||\r\npd_pg0.DevHandle == MPT3SAS_INVALID_DEVICE_HANDLE) {\r\npr_info(MPT3SAS_FMT "WarpDrive : Direct IO is "\r\n"disabled for the drive with handle(0x%04x) member"\r\n"handle retrieval failed for member number=%d\n",\r\nioc->name, raid_device->handle,\r\nvol_pg0->PhysDisk[count].PhysDiskNum);\r\ngoto out_error;\r\n}\r\ndev_max_lba = le64_to_cpu(pd_pg0.DeviceMaxLBA);\r\nif (dev_max_lba >> 32) {\r\npr_info(MPT3SAS_FMT "WarpDrive : Direct IO is "\r\n"disabled for the drive with handle(0x%04x) member"\r\n" handle (0x%04x) unsupported max lba 0x%016llx\n",\r\nioc->name, raid_device->handle,\r\nle16_to_cpu(pd_pg0.DevHandle),\r\n(unsigned long long)dev_max_lba);\r\ngoto out_error;\r\n}\r\nraid_device->pd_handle[count] = le16_to_cpu(pd_pg0.DevHandle);\r\n}\r\nif (raid_device->volume_type != MPI2_RAID_VOL_TYPE_RAID0) {\r\npr_info(MPT3SAS_FMT "WarpDrive : Direct IO is disabled "\r\n"for the drive with handle(0x%04x): type=%d, "\r\n"s_sz=%uK, blk_size=%u\n", ioc->name,\r\nraid_device->handle, raid_device->volume_type,\r\n(le32_to_cpu(vol_pg0->StripeSize) *\r\nle16_to_cpu(vol_pg0->BlockSize)) / 1024,\r\nle16_to_cpu(vol_pg0->BlockSize));\r\ngoto out_error;\r\n}\r\nstripe_sz = le32_to_cpu(vol_pg0->StripeSize);\r\nstripe_exp = find_first_bit(&stripe_sz, 32);\r\nif (stripe_exp == 32) {\r\npr_info(MPT3SAS_FMT "WarpDrive : Direct IO is disabled "\r\n"for the drive with handle(0x%04x) invalid stripe sz %uK\n",\r\nioc->name, raid_device->handle,\r\n(le32_to_cpu(vol_pg0->StripeSize) *\r\nle16_to_cpu(vol_pg0->BlockSize)) / 1024);\r\ngoto out_error;\r\n}\r\nraid_device->stripe_exponent = stripe_exp;\r\nblock_sz = le16_to_cpu(vol_pg0->BlockSize);\r\nblock_exp = find_first_bit(&block_sz, 16);\r\nif (block_exp == 16) {\r\npr_info(MPT3SAS_FMT "WarpDrive : Direct IO is disabled "\r\n"for the drive with handle(0x%04x) invalid block sz %u\n",\r\nioc->name, raid_device->handle,\r\nle16_to_cpu(vol_pg0->BlockSize));\r\ngoto out_error;\r\n}\r\nraid_device->block_exponent = block_exp;\r\nraid_device->direct_io_enabled = 1;\r\npr_info(MPT3SAS_FMT "WarpDrive : Direct IO is Enabled for the drive"\r\n" with handle(0x%04x)\n", ioc->name, raid_device->handle);\r\nraid_device->max_lba = le64_to_cpu(vol_pg0->MaxLBA);\r\nraid_device->stripe_sz = le32_to_cpu(vol_pg0->StripeSize);\r\nraid_device->block_sz = le16_to_cpu(vol_pg0->BlockSize);\r\nkfree(vol_pg0);\r\nreturn;\r\nout_error:\r\nraid_device->direct_io_enabled = 0;\r\nfor (count = 0; count < num_pds; count++)\r\nraid_device->pd_handle[count] = 0;\r\nkfree(vol_pg0);\r\nreturn;\r\n}\r\ninline u8\r\nmpt3sas_scsi_direct_io_get(struct MPT3SAS_ADAPTER *ioc, u16 smid)\r\n{\r\nreturn ioc->scsi_lookup[smid - 1].direct_io;\r\n}\r\ninline void\r\nmpt3sas_scsi_direct_io_set(struct MPT3SAS_ADAPTER *ioc, u16 smid, u8 direct_io)\r\n{\r\nioc->scsi_lookup[smid - 1].direct_io = direct_io;\r\n}\r\nvoid\r\nmpt3sas_setup_direct_io(struct MPT3SAS_ADAPTER *ioc, struct scsi_cmnd *scmd,\r\nstruct _raid_device *raid_device, Mpi2SCSIIORequest_t *mpi_request,\r\nu16 smid)\r\n{\r\nsector_t v_lba, p_lba, stripe_off, column, io_size;\r\nu32 stripe_sz, stripe_exp;\r\nu8 num_pds, cmd = scmd->cmnd[0];\r\nif (cmd != READ_10 && cmd != WRITE_10 &&\r\ncmd != READ_16 && cmd != WRITE_16)\r\nreturn;\r\nif (cmd == READ_10 || cmd == WRITE_10)\r\nv_lba = get_unaligned_be32(&mpi_request->CDB.CDB32[2]);\r\nelse\r\nv_lba = get_unaligned_be64(&mpi_request->CDB.CDB32[2]);\r\nio_size = scsi_bufflen(scmd) >> raid_device->block_exponent;\r\nif (v_lba + io_size - 1 > raid_device->max_lba)\r\nreturn;\r\nstripe_sz = raid_device->stripe_sz;\r\nstripe_exp = raid_device->stripe_exponent;\r\nstripe_off = v_lba & (stripe_sz - 1);\r\nif (stripe_off + io_size > stripe_sz)\r\nreturn;\r\nnum_pds = raid_device->num_pds;\r\np_lba = v_lba >> stripe_exp;\r\ncolumn = sector_div(p_lba, num_pds);\r\np_lba = (p_lba << stripe_exp) + stripe_off;\r\nmpi_request->DevHandle = cpu_to_le16(raid_device->pd_handle[column]);\r\nif (cmd == READ_10 || cmd == WRITE_10)\r\nput_unaligned_be32(lower_32_bits(p_lba),\r\n&mpi_request->CDB.CDB32[2]);\r\nelse\r\nput_unaligned_be64(p_lba, &mpi_request->CDB.CDB32[2]);\r\nmpt3sas_scsi_direct_io_set(ioc, smid, 1);\r\n}

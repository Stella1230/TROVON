static inline char macscsi_read(struct Scsi_Host *instance, int reg)\r\n{\r\nreturn in_8(instance->base + (reg << 4));\r\n}\r\nstatic inline void macscsi_write(struct Scsi_Host *instance, int reg, int value)\r\n{\r\nout_8(instance->base + (reg << 4), value);\r\n}\r\nstatic int __init mac_scsi_setup(char *str)\r\n{\r\nint ints[8];\r\n(void)get_options(str, ARRAY_SIZE(ints), ints);\r\nif (ints[0] < 1) {\r\npr_err("Usage: mac5380=<can_queue>[,<cmd_per_lun>[,<sg_tablesize>[,<hostid>[,<use_tags>[,<use_pdma>[,<toshiba_delay>]]]]]]\n");\r\nreturn 0;\r\n}\r\nif (ints[0] >= 1)\r\nsetup_can_queue = ints[1];\r\nif (ints[0] >= 2)\r\nsetup_cmd_per_lun = ints[2];\r\nif (ints[0] >= 3)\r\nsetup_sg_tablesize = ints[3];\r\nif (ints[0] >= 4)\r\nsetup_hostid = ints[4];\r\nif (ints[0] >= 5)\r\nsetup_use_tagged_queuing = ints[5];\r\nif (ints[0] >= 6)\r\nsetup_use_pdma = ints[6];\r\nif (ints[0] >= 7)\r\nsetup_toshiba_delay = ints[7];\r\nreturn 1;\r\n}\r\nstatic int macscsi_pread(struct Scsi_Host *instance,\r\nunsigned char *dst, int len)\r\n{\r\nstruct NCR5380_hostdata *hostdata = shost_priv(instance);\r\nunsigned char *d;\r\nunsigned char *s;\r\ns = hostdata->pdma_base + (INPUT_DATA_REG << 4);\r\nd = dst;\r\nwhile (!(NCR5380_read(BUS_AND_STATUS_REG) & BASR_DRQ) &&\r\n!(NCR5380_read(STATUS_REG) & SR_REQ))\r\n;\r\nif (!(NCR5380_read(BUS_AND_STATUS_REG) & BASR_DRQ) &&\r\n(NCR5380_read(BUS_AND_STATUS_REG) & BASR_PHASE_MATCH)) {\r\npr_err("Error in macscsi_pread\n");\r\nreturn -1;\r\n}\r\nCP_IO_TO_MEM(s, d, len);\r\nif (len != 0) {\r\npr_notice("Bus error in macscsi_pread\n");\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int macscsi_pwrite(struct Scsi_Host *instance,\r\nunsigned char *src, int len)\r\n{\r\nstruct NCR5380_hostdata *hostdata = shost_priv(instance);\r\nunsigned char *s;\r\nunsigned char *d;\r\ns = src;\r\nd = hostdata->pdma_base + (OUTPUT_DATA_REG << 4);\r\nwhile (!(NCR5380_read(BUS_AND_STATUS_REG) & BASR_DRQ) &&\r\n(!(NCR5380_read(STATUS_REG) & SR_REQ) ||\r\n(NCR5380_read(BUS_AND_STATUS_REG) & BASR_PHASE_MATCH)))\r\n;\r\nif (!(NCR5380_read(BUS_AND_STATUS_REG) & BASR_DRQ)) {\r\npr_err("Error in macscsi_pwrite\n");\r\nreturn -1;\r\n}\r\nCP_MEM_TO_IO(s, d, len);\r\nif (len != 0) {\r\npr_notice("Bus error in macscsi_pwrite\n");\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init mac_scsi_probe(struct platform_device *pdev)\r\n{\r\nstruct Scsi_Host *instance;\r\nint error;\r\nint host_flags = 0;\r\nstruct resource *irq, *pio_mem, *pdma_mem = NULL;\r\npio_mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!pio_mem)\r\nreturn -ENODEV;\r\n#ifdef PSEUDO_DMA\r\npdma_mem = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\n#endif\r\nirq = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (!hwreg_present((unsigned char *)pio_mem->start +\r\n(STATUS_REG << 4))) {\r\npr_info(PFX "no device detected at %pap\n", &pio_mem->start);\r\nreturn -ENODEV;\r\n}\r\nif (setup_can_queue > 0)\r\nmac_scsi_template.can_queue = setup_can_queue;\r\nif (setup_cmd_per_lun > 0)\r\nmac_scsi_template.cmd_per_lun = setup_cmd_per_lun;\r\nif (setup_sg_tablesize >= 0)\r\nmac_scsi_template.sg_tablesize = setup_sg_tablesize;\r\nif (setup_hostid >= 0)\r\nmac_scsi_template.this_id = setup_hostid & 7;\r\nif (setup_use_pdma < 0)\r\nsetup_use_pdma = 0;\r\ninstance = scsi_host_alloc(&mac_scsi_template,\r\nsizeof(struct NCR5380_hostdata));\r\nif (!instance)\r\nreturn -ENOMEM;\r\ninstance->base = pio_mem->start;\r\nif (irq)\r\ninstance->irq = irq->start;\r\nelse\r\ninstance->irq = NO_IRQ;\r\nif (pdma_mem && setup_use_pdma) {\r\nstruct NCR5380_hostdata *hostdata = shost_priv(instance);\r\nhostdata->pdma_base = (unsigned char *)pdma_mem->start;\r\n} else\r\nhost_flags |= FLAG_NO_PSEUDO_DMA;\r\n#ifdef SUPPORT_TAGS\r\nhost_flags |= setup_use_tagged_queuing > 0 ? FLAG_TAGGED_QUEUING : 0;\r\n#endif\r\nhost_flags |= setup_toshiba_delay > 0 ? FLAG_TOSHIBA_DELAY : 0;\r\nerror = NCR5380_init(instance, host_flags);\r\nif (error)\r\ngoto fail_init;\r\nif (instance->irq != NO_IRQ) {\r\nerror = request_irq(instance->irq, macscsi_intr, IRQF_SHARED,\r\n"NCR5380", instance);\r\nif (error)\r\ngoto fail_irq;\r\n}\r\nNCR5380_maybe_reset_bus(instance);\r\nerror = scsi_add_host(instance, NULL);\r\nif (error)\r\ngoto fail_host;\r\nplatform_set_drvdata(pdev, instance);\r\nscsi_scan_host(instance);\r\nreturn 0;\r\nfail_host:\r\nif (instance->irq != NO_IRQ)\r\nfree_irq(instance->irq, instance);\r\nfail_irq:\r\nNCR5380_exit(instance);\r\nfail_init:\r\nscsi_host_put(instance);\r\nreturn error;\r\n}\r\nstatic int __exit mac_scsi_remove(struct platform_device *pdev)\r\n{\r\nstruct Scsi_Host *instance = platform_get_drvdata(pdev);\r\nscsi_remove_host(instance);\r\nif (instance->irq != NO_IRQ)\r\nfree_irq(instance->irq, instance);\r\nNCR5380_exit(instance);\r\nscsi_host_put(instance);\r\nreturn 0;\r\n}

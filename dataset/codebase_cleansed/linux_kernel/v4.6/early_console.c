static int __init configure_uart_pins(int port)\r\n{\r\nswitch (port) {\r\ncase 1:\r\npic32_pps_input(IN_FUNC_U2RX, IN_RPB0);\r\npic32_pps_output(OUT_FUNC_U2TX, OUT_RPG9);\r\nbreak;\r\ncase 5:\r\npic32_pps_input(IN_FUNC_U6RX, IN_RPD0);\r\npic32_pps_output(OUT_FUNC_U6TX, OUT_RPB8);\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __init configure_uart(char port, int baud)\r\n{\r\nu32 pbclk;\r\npbclk = pic32_get_pbclk(2);\r\n__raw_writel(0, uart_base + U_MODE(port));\r\n__raw_writel(((pbclk / baud) / 16) - 1, uart_base + U_BRG(port));\r\n__raw_writel(UART_ENABLE, uart_base + U_MODE(port));\r\n__raw_writel(UART_ENABLE_TX | UART_ENABLE_RX,\r\nuart_base + PIC32_SET(U_STA(port)));\r\n}\r\nstatic void __init setup_early_console(char port, int baud)\r\n{\r\nif (configure_uart_pins(port))\r\nreturn;\r\nconsole_port = port;\r\nconfigure_uart(console_port, baud);\r\n}\r\nstatic char * __init pic32_getcmdline(void)\r\n{\r\n#ifdef CONFIG_CMDLINE_OVERRIDE\r\nreturn CONFIG_CMDLINE;\r\n#else\r\nreturn fw_getcmdline();\r\n#endif\r\n}\r\nstatic int __init get_port_from_cmdline(char *arch_cmdline)\r\n{\r\nchar *s;\r\nint port = -1;\r\nif (!arch_cmdline || *arch_cmdline == '\0')\r\ngoto _out;\r\ns = strstr(arch_cmdline, "earlyprintk=");\r\nif (s) {\r\ns = strstr(s, "ttyS");\r\nif (s)\r\ns += 4;\r\nelse\r\ngoto _out;\r\nport = (*s) - '0';\r\n}\r\n_out:\r\nreturn port;\r\n}\r\nstatic int __init get_baud_from_cmdline(char *arch_cmdline)\r\n{\r\nchar *s;\r\nint baud = -1;\r\nif (!arch_cmdline || *arch_cmdline == '\0')\r\ngoto _out;\r\ns = strstr(arch_cmdline, "earlyprintk=");\r\nif (s) {\r\ns = strstr(s, "ttyS");\r\nif (s)\r\ns += 6;\r\nelse\r\ngoto _out;\r\nbaud = 0;\r\nwhile (*s >= '0' && *s <= '9')\r\nbaud = baud * 10 + *s++ - '0';\r\n}\r\n_out:\r\nreturn baud;\r\n}\r\nvoid __init fw_init_early_console(char port)\r\n{\r\nchar *arch_cmdline = pic32_getcmdline();\r\nint baud = -1;\r\nuart_base = ioremap_nocache(PIC32_BASE_UART, 0xc00);\r\nbaud = get_baud_from_cmdline(arch_cmdline);\r\nif (port == -1)\r\nport = get_port_from_cmdline(arch_cmdline);\r\nif (port == -1)\r\nport = EARLY_CONSOLE_PORT;\r\nif (baud == -1)\r\nbaud = EARLY_CONSOLE_BAUDRATE;\r\nsetup_early_console(port, baud);\r\n}\r\nint prom_putchar(char c)\r\n{\r\nif (console_port >= 0) {\r\nwhile (__raw_readl(\r\nuart_base + U_STA(console_port)) & UART_TX_FULL)\r\n;\r\n__raw_writel(c, uart_base + U_TXR(console_port));\r\n}\r\nreturn 1;\r\n}

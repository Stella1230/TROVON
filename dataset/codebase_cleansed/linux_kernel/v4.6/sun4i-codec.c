static void sun4i_codec_start_playback(struct sun4i_codec *scodec)\r\n{\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_FIFOC,\r\nBIT(SUN4I_CODEC_DAC_FIFOC_FIFO_FLUSH),\r\nBIT(SUN4I_CODEC_DAC_FIFOC_FIFO_FLUSH));\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_FIFOC,\r\nBIT(SUN4I_CODEC_DAC_FIFOC_DAC_DRQ_EN),\r\nBIT(SUN4I_CODEC_DAC_FIFOC_DAC_DRQ_EN));\r\n}\r\nstatic void sun4i_codec_stop_playback(struct sun4i_codec *scodec)\r\n{\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_FIFOC,\r\nBIT(SUN4I_CODEC_DAC_FIFOC_DAC_DRQ_EN),\r\n0);\r\n}\r\nstatic void sun4i_codec_start_capture(struct sun4i_codec *scodec)\r\n{\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_ADC_FIFOC,\r\nBIT(SUN4I_CODEC_ADC_FIFOC_ADC_DRQ_EN),\r\nBIT(SUN4I_CODEC_ADC_FIFOC_ADC_DRQ_EN));\r\n}\r\nstatic void sun4i_codec_stop_capture(struct sun4i_codec *scodec)\r\n{\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_ADC_FIFOC,\r\nBIT(SUN4I_CODEC_ADC_FIFOC_ADC_DRQ_EN), 0);\r\n}\r\nstatic int sun4i_codec_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct sun4i_codec *scodec = snd_soc_card_get_drvdata(rtd->card);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nsun4i_codec_start_playback(scodec);\r\nelse\r\nsun4i_codec_start_capture(scodec);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nsun4i_codec_stop_playback(scodec);\r\nelse\r\nsun4i_codec_stop_capture(scodec);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sun4i_codec_prepare_capture(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct sun4i_codec *scodec = snd_soc_card_get_drvdata(rtd->card);\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_ADC_FIFOC,\r\nBIT(SUN4I_CODEC_ADC_FIFOC_FIFO_FLUSH),\r\nBIT(SUN4I_CODEC_ADC_FIFOC_FIFO_FLUSH));\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_ADC_FIFOC,\r\n0xf << SUN4I_CODEC_ADC_FIFOC_RX_TRIG_LEVEL,\r\n0x7 << SUN4I_CODEC_ADC_FIFOC_RX_TRIG_LEVEL);\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_ADC_ACTL,\r\n0x3 << 25,\r\n0x1 << 25);\r\nif (of_device_is_compatible(scodec->dev->of_node,\r\n"allwinner,sun7i-a20-codec"))\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_TUNE,\r\n0x3 << 8,\r\n0x1 << 8);\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_ADC_FIFOC,\r\nBIT(SUN4I_CODEC_ADC_FIFOC_RX_FIFO_MODE),\r\nBIT(SUN4I_CODEC_ADC_FIFOC_RX_FIFO_MODE));\r\nreturn 0;\r\n}\r\nstatic int sun4i_codec_prepare_playback(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct sun4i_codec *scodec = snd_soc_card_get_drvdata(rtd->card);\r\nu32 val;\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_FIFOC,\r\nBIT(SUN4I_CODEC_DAC_FIFOC_FIFO_FLUSH),\r\nBIT(SUN4I_CODEC_DAC_FIFOC_FIFO_FLUSH));\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_FIFOC,\r\n0x3f << SUN4I_CODEC_DAC_FIFOC_TX_TRIG_LEVEL,\r\n0xf << SUN4I_CODEC_DAC_FIFOC_TX_TRIG_LEVEL);\r\nif (substream->runtime->rate > 32000)\r\nval = 0;\r\nelse\r\nval = BIT(SUN4I_CODEC_DAC_FIFOC_FIR_VERSION);\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_FIFOC,\r\nBIT(SUN4I_CODEC_DAC_FIFOC_FIR_VERSION),\r\nval);\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_FIFOC,\r\nBIT(SUN4I_CODEC_DAC_FIFOC_SEND_LASAT),\r\n0);\r\nreturn 0;\r\n}\r\nstatic int sun4i_codec_prepare(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nreturn sun4i_codec_prepare_playback(substream, dai);\r\nreturn sun4i_codec_prepare_capture(substream, dai);\r\n}\r\nstatic unsigned long sun4i_codec_get_mod_freq(struct snd_pcm_hw_params *params)\r\n{\r\nunsigned int rate = params_rate(params);\r\nswitch (rate) {\r\ncase 176400:\r\ncase 88200:\r\ncase 44100:\r\ncase 33075:\r\ncase 22050:\r\ncase 14700:\r\ncase 11025:\r\ncase 7350:\r\nreturn 22579200;\r\ncase 192000:\r\ncase 96000:\r\ncase 48000:\r\ncase 32000:\r\ncase 24000:\r\ncase 16000:\r\ncase 12000:\r\ncase 8000:\r\nreturn 24576000;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic int sun4i_codec_get_hw_rate(struct snd_pcm_hw_params *params)\r\n{\r\nunsigned int rate = params_rate(params);\r\nswitch (rate) {\r\ncase 192000:\r\ncase 176400:\r\nreturn 6;\r\ncase 96000:\r\ncase 88200:\r\nreturn 7;\r\ncase 48000:\r\ncase 44100:\r\nreturn 0;\r\ncase 32000:\r\ncase 33075:\r\nreturn 1;\r\ncase 24000:\r\ncase 22050:\r\nreturn 2;\r\ncase 16000:\r\ncase 14700:\r\nreturn 3;\r\ncase 12000:\r\ncase 11025:\r\nreturn 4;\r\ncase 8000:\r\ncase 7350:\r\nreturn 5;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int sun4i_codec_hw_params_capture(struct sun4i_codec *scodec,\r\nstruct snd_pcm_hw_params *params,\r\nunsigned int hwrate)\r\n{\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_ADC_FIFOC,\r\n7 << SUN4I_CODEC_ADC_FIFOC_ADC_FS,\r\nhwrate << SUN4I_CODEC_ADC_FIFOC_ADC_FS);\r\nif (params_channels(params) == 1)\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_ADC_FIFOC,\r\nBIT(SUN4I_CODEC_ADC_FIFOC_MONO_EN),\r\nBIT(SUN4I_CODEC_ADC_FIFOC_MONO_EN));\r\nelse\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_ADC_FIFOC,\r\nBIT(SUN4I_CODEC_ADC_FIFOC_MONO_EN), 0);\r\nreturn 0;\r\n}\r\nstatic int sun4i_codec_hw_params_playback(struct sun4i_codec *scodec,\r\nstruct snd_pcm_hw_params *params,\r\nunsigned int hwrate)\r\n{\r\nu32 val;\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_FIFOC,\r\n7 << SUN4I_CODEC_DAC_FIFOC_DAC_FS,\r\nhwrate << SUN4I_CODEC_DAC_FIFOC_DAC_FS);\r\nif (params_channels(params) == 1)\r\nval = BIT(SUN4I_CODEC_DAC_FIFOC_MONO_EN);\r\nelse\r\nval = 0;\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_FIFOC,\r\nBIT(SUN4I_CODEC_DAC_FIFOC_MONO_EN),\r\nval);\r\nif (hw_param_interval(params, SNDRV_PCM_HW_PARAM_SAMPLE_BITS)->min == 32) {\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_FIFOC,\r\nBIT(SUN4I_CODEC_DAC_FIFOC_TX_SAMPLE_BITS),\r\nBIT(SUN4I_CODEC_DAC_FIFOC_TX_SAMPLE_BITS));\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_FIFOC,\r\nBIT(SUN4I_CODEC_DAC_FIFOC_TX_FIFO_MODE),\r\n0);\r\nscodec->playback_dma_data.addr_width = DMA_SLAVE_BUSWIDTH_4_BYTES;\r\n} else {\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_FIFOC,\r\nBIT(SUN4I_CODEC_DAC_FIFOC_TX_SAMPLE_BITS),\r\n0);\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_FIFOC,\r\nBIT(SUN4I_CODEC_DAC_FIFOC_TX_FIFO_MODE),\r\nBIT(SUN4I_CODEC_DAC_FIFOC_TX_FIFO_MODE));\r\nscodec->playback_dma_data.addr_width = DMA_SLAVE_BUSWIDTH_2_BYTES;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sun4i_codec_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct sun4i_codec *scodec = snd_soc_card_get_drvdata(rtd->card);\r\nunsigned long clk_freq;\r\nint ret, hwrate;\r\nclk_freq = sun4i_codec_get_mod_freq(params);\r\nif (!clk_freq)\r\nreturn -EINVAL;\r\nret = clk_set_rate(scodec->clk_module, clk_freq);\r\nif (ret)\r\nreturn ret;\r\nhwrate = sun4i_codec_get_hw_rate(params);\r\nif (hwrate < 0)\r\nreturn hwrate;\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nreturn sun4i_codec_hw_params_playback(scodec, params,\r\nhwrate);\r\nreturn sun4i_codec_hw_params_capture(scodec, params,\r\nhwrate);\r\n}\r\nstatic int sun4i_codec_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct sun4i_codec *scodec = snd_soc_card_get_drvdata(rtd->card);\r\nregmap_update_bits(scodec->regmap, SUN4I_CODEC_DAC_FIFOC,\r\n3 << SUN4I_CODEC_DAC_FIFOC_DRQ_CLR_CNT,\r\n3 << SUN4I_CODEC_DAC_FIFOC_DRQ_CLR_CNT);\r\nreturn clk_prepare_enable(scodec->clk_module);\r\n}\r\nstatic void sun4i_codec_shutdown(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct sun4i_codec *scodec = snd_soc_card_get_drvdata(rtd->card);\r\nclk_disable_unprepare(scodec->clk_module);\r\n}\r\nstatic int sun4i_codec_dai_probe(struct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_card *card = snd_soc_dai_get_drvdata(dai);\r\nstruct sun4i_codec *scodec = snd_soc_card_get_drvdata(card);\r\nsnd_soc_dai_init_dma_data(dai, &scodec->playback_dma_data,\r\n&scodec->capture_dma_data);\r\nreturn 0;\r\n}\r\nstatic struct snd_soc_dai_link *sun4i_codec_create_link(struct device *dev,\r\nint *num_links)\r\n{\r\nstruct snd_soc_dai_link *link = devm_kzalloc(dev, sizeof(*link),\r\nGFP_KERNEL);\r\nif (!link)\r\nreturn NULL;\r\nlink->name = "cdc";\r\nlink->stream_name = "CDC PCM";\r\nlink->codec_dai_name = "Codec";\r\nlink->cpu_dai_name = dev_name(dev);\r\nlink->codec_name = dev_name(dev);\r\nlink->platform_name = dev_name(dev);\r\nlink->dai_fmt = SND_SOC_DAIFMT_I2S;\r\n*num_links = 1;\r\nreturn link;\r\n}\r\nstatic int sun4i_codec_spk_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *k, int event)\r\n{\r\nstruct sun4i_codec *scodec = snd_soc_card_get_drvdata(w->dapm->card);\r\nif (scodec->gpio_pa)\r\ngpiod_set_value_cansleep(scodec->gpio_pa,\r\n!!SND_SOC_DAPM_EVENT_ON(event));\r\nreturn 0;\r\n}\r\nstatic struct snd_soc_card *sun4i_codec_create_card(struct device *dev)\r\n{\r\nstruct snd_soc_card *card;\r\ncard = devm_kzalloc(dev, sizeof(*card), GFP_KERNEL);\r\nif (!card)\r\nreturn NULL;\r\ncard->dai_link = sun4i_codec_create_link(dev, &card->num_links);\r\nif (!card->dai_link)\r\nreturn NULL;\r\ncard->dev = dev;\r\ncard->name = "sun4i-codec";\r\ncard->dapm_widgets = sun4i_codec_card_dapm_widgets;\r\ncard->num_dapm_widgets = ARRAY_SIZE(sun4i_codec_card_dapm_widgets);\r\ncard->dapm_routes = sun4i_codec_card_dapm_routes;\r\ncard->num_dapm_routes = ARRAY_SIZE(sun4i_codec_card_dapm_routes);\r\nreturn card;\r\n}\r\nstatic int sun4i_codec_probe(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card;\r\nstruct sun4i_codec *scodec;\r\nstruct resource *res;\r\nvoid __iomem *base;\r\nint ret;\r\nscodec = devm_kzalloc(&pdev->dev, sizeof(*scodec), GFP_KERNEL);\r\nif (!scodec)\r\nreturn -ENOMEM;\r\nscodec->dev = &pdev->dev;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(base)) {\r\ndev_err(&pdev->dev, "Failed to map the registers\n");\r\nreturn PTR_ERR(base);\r\n}\r\nscodec->regmap = devm_regmap_init_mmio(&pdev->dev, base,\r\n&sun4i_codec_regmap_config);\r\nif (IS_ERR(scodec->regmap)) {\r\ndev_err(&pdev->dev, "Failed to create our regmap\n");\r\nreturn PTR_ERR(scodec->regmap);\r\n}\r\nscodec->clk_apb = devm_clk_get(&pdev->dev, "apb");\r\nif (IS_ERR(scodec->clk_apb)) {\r\ndev_err(&pdev->dev, "Failed to get the APB clock\n");\r\nreturn PTR_ERR(scodec->clk_apb);\r\n}\r\nscodec->clk_module = devm_clk_get(&pdev->dev, "codec");\r\nif (IS_ERR(scodec->clk_module)) {\r\ndev_err(&pdev->dev, "Failed to get the module clock\n");\r\nreturn PTR_ERR(scodec->clk_module);\r\n}\r\nif (clk_prepare_enable(scodec->clk_apb)) {\r\ndev_err(&pdev->dev, "Failed to enable the APB clock\n");\r\nreturn -EINVAL;\r\n}\r\nscodec->gpio_pa = devm_gpiod_get_optional(&pdev->dev, "allwinner,pa",\r\nGPIOD_OUT_LOW);\r\nif (IS_ERR(scodec->gpio_pa)) {\r\nret = PTR_ERR(scodec->gpio_pa);\r\nif (ret != -EPROBE_DEFER)\r\ndev_err(&pdev->dev, "Failed to get pa gpio: %d\n", ret);\r\nreturn ret;\r\n}\r\nscodec->playback_dma_data.addr = res->start + SUN4I_CODEC_DAC_TXDATA;\r\nscodec->playback_dma_data.maxburst = 4;\r\nscodec->playback_dma_data.addr_width = DMA_SLAVE_BUSWIDTH_2_BYTES;\r\nscodec->capture_dma_data.addr = res->start + SUN4I_CODEC_ADC_RXDATA;\r\nscodec->capture_dma_data.maxburst = 4;\r\nscodec->capture_dma_data.addr_width = DMA_SLAVE_BUSWIDTH_2_BYTES;\r\nret = snd_soc_register_codec(&pdev->dev, &sun4i_codec_codec,\r\n&sun4i_codec_dai, 1);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to register our codec\n");\r\ngoto err_clk_disable;\r\n}\r\nret = devm_snd_soc_register_component(&pdev->dev,\r\n&sun4i_codec_component,\r\n&dummy_cpu_dai, 1);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to register our DAI\n");\r\ngoto err_unregister_codec;\r\n}\r\nret = devm_snd_dmaengine_pcm_register(&pdev->dev, NULL, 0);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to register against DMAEngine\n");\r\ngoto err_unregister_codec;\r\n}\r\ncard = sun4i_codec_create_card(&pdev->dev);\r\nif (!card) {\r\ndev_err(&pdev->dev, "Failed to create our card\n");\r\ngoto err_unregister_codec;\r\n}\r\nplatform_set_drvdata(pdev, card);\r\nsnd_soc_card_set_drvdata(card, scodec);\r\nret = snd_soc_register_card(card);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to register our card\n");\r\ngoto err_unregister_codec;\r\n}\r\nreturn 0;\r\nerr_unregister_codec:\r\nsnd_soc_unregister_codec(&pdev->dev);\r\nerr_clk_disable:\r\nclk_disable_unprepare(scodec->clk_apb);\r\nreturn ret;\r\n}\r\nstatic int sun4i_codec_remove(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = platform_get_drvdata(pdev);\r\nstruct sun4i_codec *scodec = snd_soc_card_get_drvdata(card);\r\nsnd_soc_unregister_card(card);\r\nsnd_soc_unregister_codec(&pdev->dev);\r\nclk_disable_unprepare(scodec->clk_apb);\r\nreturn 0;\r\n}

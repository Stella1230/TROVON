static void egalax_process_data(struct egalax *egalax)\r\n{\r\nstruct input_dev *dev = egalax->input;\r\nu8 *data = egalax->data;\r\nu16 x, y;\r\nu8 shift;\r\nu8 mask;\r\nshift = 3 - ((data[0] & EGALAX_FORMAT_RESOLUTION_MASK) >> 1);\r\nmask = 0xff >> (shift + 1);\r\nx = (((u16)(data[1] & mask) << 7) | (data[2] & 0x7f)) << shift;\r\ny = (((u16)(data[3] & mask) << 7) | (data[4] & 0x7f)) << shift;\r\ninput_report_key(dev, BTN_TOUCH, data[0] & EGALAX_FORMAT_TOUCH_BIT);\r\ninput_report_abs(dev, ABS_X, x);\r\ninput_report_abs(dev, ABS_Y, y);\r\ninput_sync(dev);\r\n}\r\nstatic irqreturn_t egalax_interrupt(struct serio *serio,\r\nunsigned char data, unsigned int flags)\r\n{\r\nstruct egalax *egalax = serio_get_drvdata(serio);\r\nint pkt_len;\r\negalax->data[egalax->idx++] = data;\r\nif (likely(egalax->data[0] & EGALAX_FORMAT_START_BIT)) {\r\npkt_len = egalax->data[0] & EGALAX_FORMAT_PRESSURE_BIT ? 6 : 5;\r\nif (pkt_len == egalax->idx) {\r\negalax_process_data(egalax);\r\negalax->idx = 0;\r\n}\r\n} else {\r\ndev_dbg(&serio->dev, "unknown/unsynchronized data: %x\n",\r\negalax->data[0]);\r\negalax->idx = 0;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int egalax_connect(struct serio *serio, struct serio_driver *drv)\r\n{\r\nstruct egalax *egalax;\r\nstruct input_dev *input_dev;\r\nint error;\r\negalax = kzalloc(sizeof(struct egalax), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!egalax || !input_dev) {\r\nerror = -ENOMEM;\r\ngoto err_free_mem;\r\n}\r\negalax->serio = serio;\r\negalax->input = input_dev;\r\nsnprintf(egalax->phys, sizeof(egalax->phys),\r\n"%s/input0", serio->phys);\r\ninput_dev->name = "EETI eGalaxTouch Serial TouchScreen";\r\ninput_dev->phys = egalax->phys;\r\ninput_dev->id.bustype = BUS_RS232;\r\ninput_dev->id.vendor = SERIO_EGALAX;\r\ninput_dev->id.product = 0;\r\ninput_dev->id.version = 0x0001;\r\ninput_dev->dev.parent = &serio->dev;\r\ninput_set_capability(input_dev, EV_KEY, BTN_TOUCH);\r\ninput_set_abs_params(input_dev, ABS_X,\r\nEGALAX_MIN_XC, EGALAX_MAX_XC, 0, 0);\r\ninput_set_abs_params(input_dev, ABS_Y,\r\nEGALAX_MIN_YC, EGALAX_MAX_YC, 0, 0);\r\nserio_set_drvdata(serio, egalax);\r\nerror = serio_open(serio, drv);\r\nif (error)\r\ngoto err_reset_drvdata;\r\nerror = input_register_device(input_dev);\r\nif (error)\r\ngoto err_close_serio;\r\nreturn 0;\r\nerr_close_serio:\r\nserio_close(serio);\r\nerr_reset_drvdata:\r\nserio_set_drvdata(serio, NULL);\r\nerr_free_mem:\r\ninput_free_device(input_dev);\r\nkfree(egalax);\r\nreturn error;\r\n}\r\nstatic void egalax_disconnect(struct serio *serio)\r\n{\r\nstruct egalax *egalax = serio_get_drvdata(serio);\r\nserio_close(serio);\r\nserio_set_drvdata(serio, NULL);\r\ninput_unregister_device(egalax->input);\r\nkfree(egalax);\r\n}

static void netlink_rcv_cb(struct sk_buff *skb)\r\n{\r\nstruct nlmsghdr *nlh;\r\nstruct net_device *dev;\r\nu32 mlen;\r\nvoid *msg;\r\nint ifindex;\r\nif (!rcv_cb) {\r\npr_err("nl cb - unregistered\n");\r\nreturn;\r\n}\r\nif (skb->len < NLMSG_HDRLEN) {\r\npr_err("nl cb - invalid skb length\n");\r\nreturn;\r\n}\r\nnlh = (struct nlmsghdr *)skb->data;\r\nif (skb->len < nlh->nlmsg_len || nlh->nlmsg_len > ND_MAX_MSG_LEN) {\r\npr_err("nl cb - invalid length (%d,%d)\n",\r\nskb->len, nlh->nlmsg_len);\r\nreturn;\r\n}\r\nmemcpy(&ifindex, ND_NLMSG_IFIDX(nlh), ND_IFINDEX_LEN);\r\nmsg = ND_NLMSG_DATA(nlh);\r\nmlen = ND_NLMSG_R_LEN(nlh);\r\ndev = dev_get_by_index(&init_net, ifindex);\r\nif (dev) {\r\nrcv_cb(dev, nlh->nlmsg_type, msg, mlen);\r\ndev_put(dev);\r\n} else {\r\npr_err("nl cb - dev (%d) not found\n", ifindex);\r\n}\r\n}\r\nstatic void netlink_rcv(struct sk_buff *skb)\r\n{\r\nmutex_lock(&netlink_mutex);\r\nnetlink_rcv_cb(skb);\r\nmutex_unlock(&netlink_mutex);\r\n}\r\nstruct sock *netlink_init(int unit,\r\nvoid (*cb)(struct net_device *dev, u16 type, void *msg, int len))\r\n{\r\nstruct sock *sock;\r\nstruct netlink_kernel_cfg cfg = {\r\n.input = netlink_rcv,\r\n};\r\n#if !defined(DEFINE_MUTEX)\r\ninit_MUTEX(&netlink_mutex);\r\n#endif\r\nsock = netlink_kernel_create(&init_net, unit, &cfg);\r\nif (sock)\r\nrcv_cb = cb;\r\nreturn sock;\r\n}\r\nint netlink_send(struct sock *sock, int group, u16 type, void *msg, int len)\r\n{\r\nstatic u32 seq;\r\nstruct sk_buff *skb = NULL;\r\nstruct nlmsghdr *nlh;\r\nint ret = 0;\r\nif (group > ND_MAX_GROUP)\r\nreturn -EINVAL;\r\nif (!netlink_has_listeners(sock, group + 1))\r\nreturn -ESRCH;\r\nskb = alloc_skb(NLMSG_SPACE(len), GFP_ATOMIC);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nseq++;\r\nnlh = nlmsg_put(skb, 0, seq, type, len, 0);\r\nmemcpy(NLMSG_DATA(nlh), msg, len);\r\nNETLINK_CB(skb).portid = 0;\r\nNETLINK_CB(skb).dst_group = 0;\r\nret = netlink_broadcast(sock, skb, 0, group + 1, GFP_ATOMIC);\r\nif (!ret)\r\nreturn len;\r\nif (ret != -ESRCH)\r\npr_err("nl broadcast g=%d, t=%d, l=%d, r=%d\n",\r\ngroup, type, len, ret);\r\nelse if (netlink_has_listeners(sock, group + 1))\r\nreturn -EAGAIN;\r\nreturn ret;\r\n}

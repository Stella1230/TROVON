int __init tx4939_report_pciclk(void)\r\n{\r\nint pciclk = 0;\r\npr_info("PCIC --%s PCICLK:",\r\n(__raw_readq(&tx4939_ccfgptr->ccfg) & TX4939_CCFG_PCI66) ?\r\n" PCI66" : "");\r\nif (__raw_readq(&tx4939_ccfgptr->pcfg) & TX4939_PCFG_PCICLKEN_ALL) {\r\npciclk = txx9_master_clock * 20 / 6;\r\nif (!(__raw_readq(&tx4939_ccfgptr->ccfg) & TX4939_CCFG_PCI66))\r\npciclk /= 2;\r\nprintk(KERN_CONT "Internal(%u.%uMHz)",\r\n(pciclk + 50000) / 1000000,\r\n((pciclk + 50000) / 100000) % 10);\r\n} else {\r\nprintk(KERN_CONT "External");\r\npciclk = -1;\r\n}\r\nprintk(KERN_CONT "\n");\r\nreturn pciclk;\r\n}\r\nvoid __init tx4939_report_pci1clk(void)\r\n{\r\nunsigned int pciclk = txx9_master_clock * 20 / 6;\r\npr_info("PCIC1 -- PCICLK:%u.%uMHz\n",\r\n(pciclk + 50000) / 1000000,\r\n((pciclk + 50000) / 100000) % 10);\r\n}\r\nint __init tx4939_pcic1_map_irq(const struct pci_dev *dev, u8 slot)\r\n{\r\nif (get_tx4927_pcicptr(dev->bus->sysdata) == tx4939_pcic1ptr) {\r\nswitch (slot) {\r\ncase TX4927_PCIC_IDSEL_AD_TO_SLOT(31):\r\nif (__raw_readq(&tx4939_ccfgptr->pcfg) &\r\nTX4939_PCFG_ET0MODE)\r\nreturn TXX9_IRQ_BASE + TX4939_IR_ETH(0);\r\nbreak;\r\ncase TX4927_PCIC_IDSEL_AD_TO_SLOT(30):\r\nif (__raw_readq(&tx4939_ccfgptr->pcfg) &\r\nTX4939_PCFG_ET1MODE)\r\nreturn TXX9_IRQ_BASE + TX4939_IR_ETH(1);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nreturn -1;\r\n}\r\nint __init tx4939_pci_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nint irq = tx4939_pcic1_map_irq(dev, slot);\r\nif (irq >= 0)\r\nreturn irq;\r\nirq = pin;\r\nirq--;\r\nirq = (irq + 33 - slot) % 4;\r\nirq++;\r\nswitch (irq) {\r\ncase 1:\r\nirq = TXX9_IRQ_BASE + TX4939_IR_INTA;\r\nbreak;\r\ncase 2:\r\nirq = TXX9_IRQ_BASE + TX4939_IR_INTB;\r\nbreak;\r\ncase 3:\r\nirq = TXX9_IRQ_BASE + TX4939_IR_INTC;\r\nbreak;\r\ncase 4:\r\nirq = TXX9_IRQ_BASE + TX4939_IR_INTD;\r\nbreak;\r\n}\r\nreturn irq;\r\n}\r\nvoid __init tx4939_setup_pcierr_irq(void)\r\n{\r\nif (request_irq(TXX9_IRQ_BASE + TX4939_IR_PCIERR,\r\ntx4927_pcierr_interrupt,\r\n0, "PCI error",\r\n(void *)TX4939_PCIC_REG))\r\npr_warn("Failed to request irq for PCIERR\n");\r\n}

static struct rb_node *intlist__node_new(struct rblist *rblist __maybe_unused,\r\nconst void *entry)\r\n{\r\nint i = (int)((long)entry);\r\nstruct rb_node *rc = NULL;\r\nstruct int_node *node = malloc(sizeof(*node));\r\nif (node != NULL) {\r\nnode->i = i;\r\nnode->priv = NULL;\r\nrc = &node->rb_node;\r\n}\r\nreturn rc;\r\n}\r\nstatic void int_node__delete(struct int_node *ilist)\r\n{\r\nfree(ilist);\r\n}\r\nstatic void intlist__node_delete(struct rblist *rblist __maybe_unused,\r\nstruct rb_node *rb_node)\r\n{\r\nstruct int_node *node = container_of(rb_node, struct int_node, rb_node);\r\nint_node__delete(node);\r\n}\r\nstatic int intlist__node_cmp(struct rb_node *rb_node, const void *entry)\r\n{\r\nint i = (int)((long)entry);\r\nstruct int_node *node = container_of(rb_node, struct int_node, rb_node);\r\nreturn node->i - i;\r\n}\r\nint intlist__add(struct intlist *ilist, int i)\r\n{\r\nreturn rblist__add_node(&ilist->rblist, (void *)((long)i));\r\n}\r\nvoid intlist__remove(struct intlist *ilist, struct int_node *node)\r\n{\r\nrblist__remove_node(&ilist->rblist, &node->rb_node);\r\n}\r\nstatic struct int_node *__intlist__findnew(struct intlist *ilist,\r\nint i, bool create)\r\n{\r\nstruct int_node *node = NULL;\r\nstruct rb_node *rb_node;\r\nif (ilist == NULL)\r\nreturn NULL;\r\nif (create)\r\nrb_node = rblist__findnew(&ilist->rblist, (void *)((long)i));\r\nelse\r\nrb_node = rblist__find(&ilist->rblist, (void *)((long)i));\r\nif (rb_node)\r\nnode = container_of(rb_node, struct int_node, rb_node);\r\nreturn node;\r\n}\r\nstruct int_node *intlist__find(struct intlist *ilist, int i)\r\n{\r\nreturn __intlist__findnew(ilist, i, false);\r\n}\r\nstruct int_node *intlist__findnew(struct intlist *ilist, int i)\r\n{\r\nreturn __intlist__findnew(ilist, i, true);\r\n}\r\nstatic int intlist__parse_list(struct intlist *ilist, const char *s)\r\n{\r\nchar *sep;\r\nint err;\r\ndo {\r\nlong value = strtol(s, &sep, 10);\r\nerr = -EINVAL;\r\nif (*sep != ',' && *sep != '\0')\r\nbreak;\r\nerr = intlist__add(ilist, value);\r\nif (err)\r\nbreak;\r\ns = sep + 1;\r\n} while (*sep != '\0');\r\nreturn err;\r\n}\r\nstruct intlist *intlist__new(const char *slist)\r\n{\r\nstruct intlist *ilist = malloc(sizeof(*ilist));\r\nif (ilist != NULL) {\r\nrblist__init(&ilist->rblist);\r\nilist->rblist.node_cmp = intlist__node_cmp;\r\nilist->rblist.node_new = intlist__node_new;\r\nilist->rblist.node_delete = intlist__node_delete;\r\nif (slist && intlist__parse_list(ilist, slist))\r\ngoto out_delete;\r\n}\r\nreturn ilist;\r\nout_delete:\r\nintlist__delete(ilist);\r\nreturn NULL;\r\n}\r\nvoid intlist__delete(struct intlist *ilist)\r\n{\r\nif (ilist != NULL)\r\nrblist__delete(&ilist->rblist);\r\n}\r\nstruct int_node *intlist__entry(const struct intlist *ilist, unsigned int idx)\r\n{\r\nstruct int_node *node = NULL;\r\nstruct rb_node *rb_node;\r\nrb_node = rblist__entry(&ilist->rblist, idx);\r\nif (rb_node)\r\nnode = container_of(rb_node, struct int_node, rb_node);\r\nreturn node;\r\n}

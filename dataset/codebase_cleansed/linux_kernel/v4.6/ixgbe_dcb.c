static s32 ixgbe_ieee_credits(__u8 *bw, __u16 *refill,\r\n__u16 *max, int max_frame)\r\n{\r\nint min_percent = 100;\r\nint min_credit, multiplier;\r\nint i;\r\nmin_credit = ((max_frame / 2) + DCB_CREDIT_QUANTUM - 1) /\r\nDCB_CREDIT_QUANTUM;\r\nfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\r\nif (bw[i] < min_percent && bw[i])\r\nmin_percent = bw[i];\r\n}\r\nmultiplier = (min_credit / min_percent) + 1;\r\nfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\r\nint val = min(bw[i] * multiplier, MAX_CREDIT_REFILL);\r\nif (val < min_credit)\r\nval = min_credit;\r\nrefill[i] = val;\r\nmax[i] = bw[i] ? (bw[i] * MAX_CREDIT)/100 : min_credit;\r\n}\r\nreturn 0;\r\n}\r\ns32 ixgbe_dcb_calculate_tc_credits(struct ixgbe_hw *hw,\r\nstruct ixgbe_dcb_config *dcb_config,\r\nint max_frame, u8 direction)\r\n{\r\nstruct tc_bw_alloc *p;\r\nint min_credit;\r\nint min_multiplier;\r\nint min_percent = 100;\r\nu32 credit_refill = 0;\r\nu32 credit_max = 0;\r\nu16 link_percentage = 0;\r\nu8 bw_percent = 0;\r\nu8 i;\r\nif (!dcb_config)\r\nreturn DCB_ERR_CONFIG;\r\nmin_credit = ((max_frame / 2) + DCB_CREDIT_QUANTUM - 1) /\r\nDCB_CREDIT_QUANTUM;\r\nfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\r\np = &dcb_config->tc_config[i].path[direction];\r\nbw_percent = dcb_config->bw_percentage[direction][p->bwg_id];\r\nlink_percentage = p->bwg_percent;\r\nlink_percentage = (link_percentage * bw_percent) / 100;\r\nif (link_percentage && link_percentage < min_percent)\r\nmin_percent = link_percentage;\r\n}\r\nmin_multiplier = (min_credit / min_percent) + 1;\r\nfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\r\np = &dcb_config->tc_config[i].path[direction];\r\nbw_percent = dcb_config->bw_percentage[direction][p->bwg_id];\r\nlink_percentage = p->bwg_percent;\r\nlink_percentage = (link_percentage * bw_percent) / 100;\r\nif (p->bwg_percent > 0 && link_percentage == 0)\r\nlink_percentage = 1;\r\np->link_percent = (u8)link_percentage;\r\ncredit_refill = min(link_percentage * min_multiplier,\r\nMAX_CREDIT_REFILL);\r\nif (credit_refill < min_credit)\r\ncredit_refill = min_credit;\r\np->data_credits_refill = (u16)credit_refill;\r\ncredit_max = (link_percentage * MAX_CREDIT) / 100;\r\nif (credit_max < min_credit)\r\ncredit_max = min_credit;\r\nif (direction == DCB_TX_CONFIG) {\r\nif ((hw->mac.type == ixgbe_mac_82598EB) &&\r\ncredit_max &&\r\n(credit_max < MINIMUM_CREDIT_FOR_TSO))\r\ncredit_max = MINIMUM_CREDIT_FOR_TSO;\r\ndcb_config->tc_config[i].desc_credits_max =\r\n(u16)credit_max;\r\n}\r\np->data_credits_max = (u16)credit_max;\r\n}\r\nreturn 0;\r\n}\r\nvoid ixgbe_dcb_unpack_pfc(struct ixgbe_dcb_config *cfg, u8 *pfc_en)\r\n{\r\nstruct tc_configuration *tc_config = &cfg->tc_config[0];\r\nint tc;\r\nfor (*pfc_en = 0, tc = 0; tc < MAX_TRAFFIC_CLASS; tc++) {\r\nif (tc_config[tc].dcb_pfc != pfc_disabled)\r\n*pfc_en |= 1 << tc;\r\n}\r\n}\r\nvoid ixgbe_dcb_unpack_refill(struct ixgbe_dcb_config *cfg, int direction,\r\nu16 *refill)\r\n{\r\nstruct tc_configuration *tc_config = &cfg->tc_config[0];\r\nint tc;\r\nfor (tc = 0; tc < MAX_TRAFFIC_CLASS; tc++)\r\nrefill[tc] = tc_config[tc].path[direction].data_credits_refill;\r\n}\r\nvoid ixgbe_dcb_unpack_max(struct ixgbe_dcb_config *cfg, u16 *max)\r\n{\r\nstruct tc_configuration *tc_config = &cfg->tc_config[0];\r\nint tc;\r\nfor (tc = 0; tc < MAX_TRAFFIC_CLASS; tc++)\r\nmax[tc] = tc_config[tc].desc_credits_max;\r\n}\r\nvoid ixgbe_dcb_unpack_bwgid(struct ixgbe_dcb_config *cfg, int direction,\r\nu8 *bwgid)\r\n{\r\nstruct tc_configuration *tc_config = &cfg->tc_config[0];\r\nint tc;\r\nfor (tc = 0; tc < MAX_TRAFFIC_CLASS; tc++)\r\nbwgid[tc] = tc_config[tc].path[direction].bwg_id;\r\n}\r\nvoid ixgbe_dcb_unpack_prio(struct ixgbe_dcb_config *cfg, int direction,\r\nu8 *ptype)\r\n{\r\nstruct tc_configuration *tc_config = &cfg->tc_config[0];\r\nint tc;\r\nfor (tc = 0; tc < MAX_TRAFFIC_CLASS; tc++)\r\nptype[tc] = tc_config[tc].path[direction].prio_type;\r\n}\r\nu8 ixgbe_dcb_get_tc_from_up(struct ixgbe_dcb_config *cfg, int direction, u8 up)\r\n{\r\nstruct tc_configuration *tc_config = &cfg->tc_config[0];\r\nu8 prio_mask = 1 << up;\r\nu8 tc = cfg->num_tcs.pg_tcs;\r\nif (!tc)\r\nreturn 0;\r\nfor (tc--; tc; tc--) {\r\nif (prio_mask & tc_config[tc].path[direction].up_to_tc_bitmap)\r\nbreak;\r\n}\r\nreturn tc;\r\n}\r\nvoid ixgbe_dcb_unpack_map(struct ixgbe_dcb_config *cfg, int direction, u8 *map)\r\n{\r\nu8 up;\r\nfor (up = 0; up < MAX_USER_PRIORITY; up++)\r\nmap[up] = ixgbe_dcb_get_tc_from_up(cfg, direction, up);\r\n}\r\ns32 ixgbe_dcb_hw_config(struct ixgbe_hw *hw,\r\nstruct ixgbe_dcb_config *dcb_config)\r\n{\r\nu8 pfc_en;\r\nu8 ptype[MAX_TRAFFIC_CLASS];\r\nu8 bwgid[MAX_TRAFFIC_CLASS];\r\nu8 prio_tc[MAX_TRAFFIC_CLASS];\r\nu16 refill[MAX_TRAFFIC_CLASS];\r\nu16 max[MAX_TRAFFIC_CLASS];\r\nixgbe_dcb_unpack_pfc(dcb_config, &pfc_en);\r\nixgbe_dcb_unpack_refill(dcb_config, DCB_TX_CONFIG, refill);\r\nixgbe_dcb_unpack_max(dcb_config, max);\r\nixgbe_dcb_unpack_bwgid(dcb_config, DCB_TX_CONFIG, bwgid);\r\nixgbe_dcb_unpack_prio(dcb_config, DCB_TX_CONFIG, ptype);\r\nixgbe_dcb_unpack_map(dcb_config, DCB_TX_CONFIG, prio_tc);\r\nswitch (hw->mac.type) {\r\ncase ixgbe_mac_82598EB:\r\nreturn ixgbe_dcb_hw_config_82598(hw, pfc_en, refill, max,\r\nbwgid, ptype);\r\ncase ixgbe_mac_82599EB:\r\ncase ixgbe_mac_X540:\r\ncase ixgbe_mac_X550:\r\ncase ixgbe_mac_X550EM_x:\r\nreturn ixgbe_dcb_hw_config_82599(hw, pfc_en, refill, max,\r\nbwgid, ptype, prio_tc);\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\ns32 ixgbe_dcb_hw_pfc_config(struct ixgbe_hw *hw, u8 pfc_en, u8 *prio_tc)\r\n{\r\nswitch (hw->mac.type) {\r\ncase ixgbe_mac_82598EB:\r\nreturn ixgbe_dcb_config_pfc_82598(hw, pfc_en);\r\ncase ixgbe_mac_82599EB:\r\ncase ixgbe_mac_X540:\r\ncase ixgbe_mac_X550:\r\ncase ixgbe_mac_X550EM_x:\r\nreturn ixgbe_dcb_config_pfc_82599(hw, pfc_en, prio_tc);\r\ndefault:\r\nbreak;\r\n}\r\nreturn -EINVAL;\r\n}\r\ns32 ixgbe_dcb_hw_ets(struct ixgbe_hw *hw, struct ieee_ets *ets, int max_frame)\r\n{\r\n__u16 refill[IEEE_8021QAZ_MAX_TCS], max[IEEE_8021QAZ_MAX_TCS];\r\n__u8 prio_type[IEEE_8021QAZ_MAX_TCS];\r\nint i;\r\n__u8 bwg_id[IEEE_8021QAZ_MAX_TCS] = {0, 1, 2, 3, 4, 5, 6, 7};\r\nfor (i = 0; i < IEEE_8021QAZ_MAX_TCS; i++) {\r\nswitch (ets->tc_tsa[i]) {\r\ncase IEEE_8021QAZ_TSA_STRICT:\r\nprio_type[i] = 2;\r\nbreak;\r\ncase IEEE_8021QAZ_TSA_ETS:\r\nprio_type[i] = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nixgbe_ieee_credits(ets->tc_tx_bw, refill, max, max_frame);\r\nreturn ixgbe_dcb_hw_ets_config(hw, refill, max,\r\nbwg_id, prio_type, ets->prio_tc);\r\n}\r\ns32 ixgbe_dcb_hw_ets_config(struct ixgbe_hw *hw,\r\nu16 *refill, u16 *max, u8 *bwg_id,\r\nu8 *prio_type, u8 *prio_tc)\r\n{\r\nswitch (hw->mac.type) {\r\ncase ixgbe_mac_82598EB:\r\nixgbe_dcb_config_rx_arbiter_82598(hw, refill, max,\r\nprio_type);\r\nixgbe_dcb_config_tx_desc_arbiter_82598(hw, refill, max,\r\nbwg_id, prio_type);\r\nixgbe_dcb_config_tx_data_arbiter_82598(hw, refill, max,\r\nbwg_id, prio_type);\r\nbreak;\r\ncase ixgbe_mac_82599EB:\r\ncase ixgbe_mac_X540:\r\ncase ixgbe_mac_X550:\r\ncase ixgbe_mac_X550EM_x:\r\nixgbe_dcb_config_rx_arbiter_82599(hw, refill, max,\r\nbwg_id, prio_type, prio_tc);\r\nixgbe_dcb_config_tx_desc_arbiter_82599(hw, refill, max,\r\nbwg_id, prio_type);\r\nixgbe_dcb_config_tx_data_arbiter_82599(hw, refill, max, bwg_id,\r\nprio_type, prio_tc);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ixgbe_dcb_read_rtrup2tc_82599(struct ixgbe_hw *hw, u8 *map)\r\n{\r\nu32 reg, i;\r\nreg = IXGBE_READ_REG(hw, IXGBE_RTRUP2TC);\r\nfor (i = 0; i < MAX_USER_PRIORITY; i++)\r\nmap[i] = IXGBE_RTRUP2TC_UP_MASK &\r\n(reg >> (i * IXGBE_RTRUP2TC_UP_SHIFT));\r\n}\r\nvoid ixgbe_dcb_read_rtrup2tc(struct ixgbe_hw *hw, u8 *map)\r\n{\r\nswitch (hw->mac.type) {\r\ncase ixgbe_mac_82599EB:\r\ncase ixgbe_mac_X540:\r\ncase ixgbe_mac_X550:\r\ncase ixgbe_mac_X550EM_x:\r\nixgbe_dcb_read_rtrup2tc_82599(hw, map);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}

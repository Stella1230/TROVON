static int isp1761_pci_init(struct pci_dev *dev)\r\n{\r\nresource_size_t mem_start;\r\nresource_size_t mem_length;\r\nu8 __iomem *iobase;\r\nu8 latency, limit;\r\nint retry_count;\r\nu32 reg_data;\r\nmem_start = pci_resource_start(dev, 3);\r\nmem_length = pci_resource_len(dev, 3);\r\nif (mem_length < 0xffff) {\r\nprintk(KERN_ERR "memory length for this resource is wrong\n");\r\nreturn -ENOMEM;\r\n}\r\nif (!request_mem_region(mem_start, mem_length, "ISP-PCI")) {\r\nprintk(KERN_ERR "host controller already in use\n");\r\nreturn -EBUSY;\r\n}\r\niobase = ioremap_nocache(mem_start, mem_length);\r\nif (!iobase) {\r\nprintk(KERN_ERR "Error ioremap failed\n");\r\nrelease_mem_region(mem_start, mem_length);\r\nreturn -ENOMEM;\r\n}\r\npci_read_config_byte(dev, PCI_LATENCY_TIMER, &latency);\r\nif (latency) {\r\npci_read_config_byte(dev, PCI_MAX_LAT, &limit);\r\nif (limit && limit < latency)\r\npci_write_config_byte(dev, PCI_LATENCY_TIMER, limit);\r\n}\r\nretry_count = 20;\r\nreg_data = 0;\r\nwhile ((reg_data != 0xFACE) && retry_count) {\r\nwritel(0xface, iobase + HC_SCRATCH_REG);\r\nudelay(100);\r\nreg_data = readl(iobase + HC_SCRATCH_REG) & 0x0000ffff;\r\nretry_count--;\r\n}\r\niounmap(iobase);\r\nrelease_mem_region(mem_start, mem_length);\r\nif (reg_data != 0xFACE) {\r\ndev_err(&dev->dev, "scratch register mismatch %x\n", reg_data);\r\nreturn -ENOMEM;\r\n}\r\nmem_start = pci_resource_start(dev, 0);\r\nmem_length = pci_resource_len(dev, 0);\r\nif (!request_mem_region(mem_start, mem_length, "ISP1761 IO MEM")) {\r\nprintk(KERN_ERR "request region #1\n");\r\nreturn -EBUSY;\r\n}\r\niobase = ioremap_nocache(mem_start, mem_length);\r\nif (!iobase) {\r\nprintk(KERN_ERR "ioremap #1\n");\r\nrelease_mem_region(mem_start, mem_length);\r\nreturn -ENOMEM;\r\n}\r\n#define PLX_INT_CSR_REG 0x68\r\nreg_data = readl(iobase + PLX_INT_CSR_REG);\r\nreg_data |= 0x900;\r\nwritel(reg_data, iobase + PLX_INT_CSR_REG);\r\niounmap(iobase);\r\nrelease_mem_region(mem_start, mem_length);\r\nreturn 0;\r\n}\r\nstatic int isp1761_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nunsigned int devflags = 0;\r\nint ret;\r\nif (!dev->irq)\r\nreturn -ENODEV;\r\nif (pci_enable_device(dev) < 0)\r\nreturn -ENODEV;\r\nret = isp1761_pci_init(dev);\r\nif (ret < 0)\r\ngoto error;\r\npci_set_master(dev);\r\ndev->dev.dma_mask = NULL;\r\nret = isp1760_register(&dev->resource[3], dev->irq, 0, &dev->dev,\r\ndevflags);\r\nif (ret < 0)\r\ngoto error;\r\nreturn 0;\r\nerror:\r\npci_disable_device(dev);\r\nreturn ret;\r\n}\r\nstatic void isp1761_pci_remove(struct pci_dev *dev)\r\n{\r\nisp1760_unregister(&dev->dev);\r\npci_disable_device(dev);\r\n}\r\nstatic void isp1761_pci_shutdown(struct pci_dev *dev)\r\n{\r\nprintk(KERN_ERR "ips1761_pci_shutdown\n");\r\n}\r\nstatic int isp1760_plat_probe(struct platform_device *pdev)\r\n{\r\nunsigned long irqflags;\r\nunsigned int devflags = 0;\r\nstruct resource *mem_res;\r\nstruct resource *irq_res;\r\nint ret;\r\nmem_res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nirq_res = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (!irq_res) {\r\npr_warning("isp1760: IRQ resource not available\n");\r\nreturn -ENODEV;\r\n}\r\nirqflags = irq_res->flags & IRQF_TRIGGER_MASK;\r\nif (IS_ENABLED(CONFIG_OF) && pdev->dev.of_node) {\r\nstruct device_node *dp = pdev->dev.of_node;\r\nu32 bus_width = 0;\r\nif (of_device_is_compatible(dp, "nxp,usb-isp1761"))\r\ndevflags |= ISP1760_FLAG_ISP1761;\r\nof_property_read_u32(dp, "bus-width", &bus_width);\r\nif (bus_width == 16)\r\ndevflags |= ISP1760_FLAG_BUS_WIDTH_16;\r\nif (of_property_read_bool(dp, "port1-otg"))\r\ndevflags |= ISP1760_FLAG_OTG_EN;\r\nif (of_property_read_bool(dp, "analog-oc"))\r\ndevflags |= ISP1760_FLAG_ANALOG_OC;\r\nif (of_property_read_bool(dp, "dack-polarity"))\r\ndevflags |= ISP1760_FLAG_DACK_POL_HIGH;\r\nif (of_property_read_bool(dp, "dreq-polarity"))\r\ndevflags |= ISP1760_FLAG_DREQ_POL_HIGH;\r\n} else if (dev_get_platdata(&pdev->dev)) {\r\nstruct isp1760_platform_data *pdata =\r\ndev_get_platdata(&pdev->dev);\r\nif (pdata->is_isp1761)\r\ndevflags |= ISP1760_FLAG_ISP1761;\r\nif (pdata->bus_width_16)\r\ndevflags |= ISP1760_FLAG_BUS_WIDTH_16;\r\nif (pdata->port1_otg)\r\ndevflags |= ISP1760_FLAG_OTG_EN;\r\nif (pdata->analog_oc)\r\ndevflags |= ISP1760_FLAG_ANALOG_OC;\r\nif (pdata->dack_polarity_high)\r\ndevflags |= ISP1760_FLAG_DACK_POL_HIGH;\r\nif (pdata->dreq_polarity_high)\r\ndevflags |= ISP1760_FLAG_DREQ_POL_HIGH;\r\n}\r\nret = isp1760_register(mem_res, irq_res->start, irqflags, &pdev->dev,\r\ndevflags);\r\nif (ret < 0)\r\nreturn ret;\r\npr_info("ISP1760 USB device initialised\n");\r\nreturn 0;\r\n}\r\nstatic int isp1760_plat_remove(struct platform_device *pdev)\r\n{\r\nisp1760_unregister(&pdev->dev);\r\nreturn 0;\r\n}\r\nstatic int __init isp1760_init(void)\r\n{\r\nint ret, any_ret = -ENODEV;\r\nisp1760_init_kmem_once();\r\nret = platform_driver_register(&isp1760_plat_driver);\r\nif (!ret)\r\nany_ret = 0;\r\n#ifdef CONFIG_PCI\r\nret = pci_register_driver(&isp1761_pci_driver);\r\nif (!ret)\r\nany_ret = 0;\r\n#endif\r\nif (any_ret)\r\nisp1760_deinit_kmem_cache();\r\nreturn any_ret;\r\n}\r\nstatic void __exit isp1760_exit(void)\r\n{\r\nplatform_driver_unregister(&isp1760_plat_driver);\r\n#ifdef CONFIG_PCI\r\npci_unregister_driver(&isp1761_pci_driver);\r\n#endif\r\nisp1760_deinit_kmem_cache();\r\n}

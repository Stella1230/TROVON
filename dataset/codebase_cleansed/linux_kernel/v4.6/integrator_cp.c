static void __init intcp_map_io(void)\r\n{\r\niotable_init(intcp_io_desc, ARRAY_SIZE(intcp_io_desc));\r\n}\r\nstatic int intcp_flash_init(struct platform_device *dev)\r\n{\r\nu32 val;\r\nval = readl(intcp_con_base + INTCP_FLASHPROG);\r\nval |= CINTEGRATOR_FLASHPROG_FLWREN;\r\nwritel(val, intcp_con_base + INTCP_FLASHPROG);\r\nreturn 0;\r\n}\r\nstatic void intcp_flash_exit(struct platform_device *dev)\r\n{\r\nu32 val;\r\nval = readl(intcp_con_base + INTCP_FLASHPROG);\r\nval &= ~(CINTEGRATOR_FLASHPROG_FLVPPEN|CINTEGRATOR_FLASHPROG_FLWREN);\r\nwritel(val, intcp_con_base + INTCP_FLASHPROG);\r\n}\r\nstatic void intcp_flash_set_vpp(struct platform_device *pdev, int on)\r\n{\r\nu32 val;\r\nval = readl(intcp_con_base + INTCP_FLASHPROG);\r\nif (on)\r\nval |= CINTEGRATOR_FLASHPROG_FLVPPEN;\r\nelse\r\nval &= ~CINTEGRATOR_FLASHPROG_FLVPPEN;\r\nwritel(val, intcp_con_base + INTCP_FLASHPROG);\r\n}\r\nstatic unsigned int mmc_status(struct device *dev)\r\n{\r\nunsigned int status = readl(__io_address(0xca000000 + 4));\r\nwritel(8, intcp_con_base + 8);\r\nreturn status & 8;\r\n}\r\nstatic void cp_clcd_enable(struct clcd_fb *fb)\r\n{\r\nstruct fb_var_screeninfo *var = &fb->fb.var;\r\nu32 val = CM_CTRL_STATIC1 | CM_CTRL_STATIC2\r\n| CM_CTRL_LCDEN0 | CM_CTRL_LCDEN1;\r\nif (var->bits_per_pixel <= 8 ||\r\n(var->bits_per_pixel == 16 && var->green.length == 5))\r\nval |= CM_CTRL_LCDMUXSEL_VGA555_TFT555;\r\nelse if (fb->fb.var.bits_per_pixel <= 16)\r\nval |= CM_CTRL_LCDMUXSEL_VGA565_TFT555;\r\nelse\r\nval = 0;\r\ncm_control(CM_CTRL_LCDMUXSEL_MASK|\r\nCM_CTRL_LCDEN0|\r\nCM_CTRL_LCDEN1|\r\nCM_CTRL_STATIC1|\r\nCM_CTRL_STATIC2|\r\nCM_CTRL_STATIC|\r\nCM_CTRL_n24BITEN, val);\r\n}\r\nstatic int cp_clcd_setup(struct clcd_fb *fb)\r\n{\r\nfb->panel = versatile_clcd_get_panel("VGA");\r\nif (!fb->panel)\r\nreturn -EINVAL;\r\nreturn versatile_clcd_setup_dma(fb, SZ_1M);\r\n}\r\nstatic u64 notrace intcp_read_sched_clock(void)\r\n{\r\nreturn readl(REFCOUNTER);\r\n}\r\nstatic void __init intcp_init_early(void)\r\n{\r\nsched_clock_register(intcp_read_sched_clock, 32, 24000000);\r\n}\r\nstatic void __init intcp_init_irq_of(void)\r\n{\r\ncm_init();\r\nirqchip_init();\r\n}\r\nstatic void __init intcp_init_of(void)\r\n{\r\nstruct device_node *cpcon;\r\ncpcon = of_find_matching_node(NULL, intcp_syscon_match);\r\nif (!cpcon)\r\nreturn;\r\nintcp_con_base = of_iomap(cpcon, 0);\r\nif (!intcp_con_base)\r\nreturn;\r\nof_platform_populate(NULL, of_default_bus_match_table,\r\nintcp_auxdata_lookup, NULL);\r\n}

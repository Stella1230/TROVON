void cpm_line_cr_cmd(struct uart_cpm_port *port, int cmd)\r\n{\r\ncpm_command(port->command, cmd);\r\n}\r\nvoid __iomem *cpm_uart_map_pram(struct uart_cpm_port *port,\r\nstruct device_node *np)\r\n{\r\nreturn of_iomap(np, 1);\r\n}\r\nvoid cpm_uart_unmap_pram(struct uart_cpm_port *port, void __iomem *pram)\r\n{\r\niounmap(pram);\r\n}\r\nint cpm_uart_allocbuf(struct uart_cpm_port *pinfo, unsigned int is_con)\r\n{\r\nint dpmemsz, memsz;\r\nu8 *dp_mem;\r\nunsigned long dp_offset;\r\nu8 *mem_addr;\r\ndma_addr_t dma_addr = 0;\r\npr_debug("CPM uart[%d]:allocbuf\n", pinfo->port.line);\r\ndpmemsz = sizeof(cbd_t) * (pinfo->rx_nrfifos + pinfo->tx_nrfifos);\r\ndp_offset = cpm_dpalloc(dpmemsz, 8);\r\nif (IS_ERR_VALUE(dp_offset)) {\r\nprintk(KERN_ERR\r\n"cpm_uart_cpm1.c: could not allocate buffer descriptors\n");\r\nreturn -ENOMEM;\r\n}\r\ndp_mem = cpm_dpram_addr(dp_offset);\r\nmemsz = L1_CACHE_ALIGN(pinfo->rx_nrfifos * pinfo->rx_fifosize) +\r\nL1_CACHE_ALIGN(pinfo->tx_nrfifos * pinfo->tx_fifosize);\r\nif (is_con) {\r\nmem_addr = (u8 *) cpm_dpram_addr(cpm_dpalloc(memsz, 8));\r\ndma_addr = (u32)cpm_dpram_phys(mem_addr);\r\n} else\r\nmem_addr = dma_alloc_coherent(pinfo->port.dev, memsz, &dma_addr,\r\nGFP_KERNEL);\r\nif (mem_addr == NULL) {\r\ncpm_dpfree(dp_offset);\r\nprintk(KERN_ERR\r\n"cpm_uart_cpm1.c: could not allocate coherent memory\n");\r\nreturn -ENOMEM;\r\n}\r\npinfo->dp_addr = dp_offset;\r\npinfo->mem_addr = mem_addr;\r\npinfo->dma_addr = dma_addr;\r\npinfo->mem_size = memsz;\r\npinfo->rx_buf = mem_addr;\r\npinfo->tx_buf = pinfo->rx_buf + L1_CACHE_ALIGN(pinfo->rx_nrfifos\r\n* pinfo->rx_fifosize);\r\npinfo->rx_bd_base = (cbd_t __iomem __force *)dp_mem;\r\npinfo->tx_bd_base = pinfo->rx_bd_base + pinfo->rx_nrfifos;\r\nreturn 0;\r\n}\r\nvoid cpm_uart_freebuf(struct uart_cpm_port *pinfo)\r\n{\r\ndma_free_coherent(pinfo->port.dev, L1_CACHE_ALIGN(pinfo->rx_nrfifos *\r\npinfo->rx_fifosize) +\r\nL1_CACHE_ALIGN(pinfo->tx_nrfifos *\r\npinfo->tx_fifosize), pinfo->mem_addr,\r\npinfo->dma_addr);\r\ncpm_dpfree(pinfo->dp_addr);\r\n}

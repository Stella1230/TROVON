static u32 fb_cvt_hperiod(struct fb_cvt_data *cvt)\r\n{\r\nu32 num = 1000000000/cvt->f_refresh;\r\nu32 den;\r\nif (cvt->flags & FB_CVT_FLAG_REDUCED_BLANK) {\r\nnum -= FB_CVT_RB_MIN_VBLANK * 1000;\r\nden = 2 * (cvt->yres/cvt->interlace + 2 * cvt->v_margin);\r\n} else {\r\nnum -= FB_CVT_MIN_VSYNC_BP * 1000;\r\nden = 2 * (cvt->yres/cvt->interlace + cvt->v_margin * 2\r\n+ FB_CVT_MIN_VPORCH + cvt->interlace/2);\r\n}\r\nreturn 2 * (num/den);\r\n}\r\nstatic u32 fb_cvt_ideal_duty_cycle(struct fb_cvt_data *cvt)\r\n{\r\nu32 c_prime = (FB_CVT_GTF_C - FB_CVT_GTF_J) *\r\n(FB_CVT_GTF_K) + 256 * FB_CVT_GTF_J;\r\nu32 m_prime = (FB_CVT_GTF_K * FB_CVT_GTF_M);\r\nu32 h_period_est = cvt->hperiod;\r\nreturn (1000 * c_prime - ((m_prime * h_period_est)/1000))/256;\r\n}\r\nstatic u32 fb_cvt_hblank(struct fb_cvt_data *cvt)\r\n{\r\nu32 hblank = 0;\r\nif (cvt->flags & FB_CVT_FLAG_REDUCED_BLANK)\r\nhblank = FB_CVT_RB_HBLANK;\r\nelse {\r\nu32 ideal_duty_cycle = fb_cvt_ideal_duty_cycle(cvt);\r\nu32 active_pixels = cvt->active_pixels;\r\nif (ideal_duty_cycle < 20000)\r\nhblank = (active_pixels * 20000)/\r\n(100000 - 20000);\r\nelse {\r\nhblank = (active_pixels * ideal_duty_cycle)/\r\n(100000 - ideal_duty_cycle);\r\n}\r\n}\r\nhblank &= ~((2 * FB_CVT_CELLSIZE) - 1);\r\nreturn hblank;\r\n}\r\nstatic u32 fb_cvt_hsync(struct fb_cvt_data *cvt)\r\n{\r\nu32 hsync;\r\nif (cvt->flags & FB_CVT_FLAG_REDUCED_BLANK)\r\nhsync = 32;\r\nelse\r\nhsync = (FB_CVT_CELLSIZE * cvt->htotal)/100;\r\nhsync &= ~(FB_CVT_CELLSIZE - 1);\r\nreturn hsync;\r\n}\r\nstatic u32 fb_cvt_vbi_lines(struct fb_cvt_data *cvt)\r\n{\r\nu32 vbi_lines, min_vbi_lines, act_vbi_lines;\r\nif (cvt->flags & FB_CVT_FLAG_REDUCED_BLANK) {\r\nvbi_lines = (1000 * FB_CVT_RB_MIN_VBLANK)/cvt->hperiod + 1;\r\nmin_vbi_lines = FB_CVT_RB_V_FPORCH + cvt->vsync +\r\nFB_CVT_MIN_BPORCH;\r\n} else {\r\nvbi_lines = (FB_CVT_MIN_VSYNC_BP * 1000)/cvt->hperiod + 1 +\r\nFB_CVT_MIN_VPORCH;\r\nmin_vbi_lines = cvt->vsync + FB_CVT_MIN_BPORCH +\r\nFB_CVT_MIN_VPORCH;\r\n}\r\nif (vbi_lines < min_vbi_lines)\r\nact_vbi_lines = min_vbi_lines;\r\nelse\r\nact_vbi_lines = vbi_lines;\r\nreturn act_vbi_lines;\r\n}\r\nstatic u32 fb_cvt_vtotal(struct fb_cvt_data *cvt)\r\n{\r\nu32 vtotal = cvt->yres/cvt->interlace;\r\nvtotal += 2 * cvt->v_margin + cvt->interlace/2 + fb_cvt_vbi_lines(cvt);\r\nvtotal |= cvt->interlace/2;\r\nreturn vtotal;\r\n}\r\nstatic u32 fb_cvt_pixclock(struct fb_cvt_data *cvt)\r\n{\r\nu32 pixclock;\r\nif (cvt->flags & FB_CVT_FLAG_REDUCED_BLANK)\r\npixclock = (cvt->f_refresh * cvt->vtotal * cvt->htotal)/1000;\r\nelse\r\npixclock = (cvt->htotal * 1000000)/cvt->hperiod;\r\npixclock /= 250;\r\npixclock *= 250;\r\npixclock *= 1000;\r\nreturn pixclock;\r\n}\r\nstatic u32 fb_cvt_aspect_ratio(struct fb_cvt_data *cvt)\r\n{\r\nu32 xres = cvt->xres;\r\nu32 yres = cvt->yres;\r\nu32 aspect = -1;\r\nif (xres == (yres * 4)/3 && !((yres * 4) % 3))\r\naspect = 0;\r\nelse if (xres == (yres * 16)/9 && !((yres * 16) % 9))\r\naspect = 1;\r\nelse if (xres == (yres * 16)/10 && !((yres * 16) % 10))\r\naspect = 2;\r\nelse if (xres == (yres * 5)/4 && !((yres * 5) % 4))\r\naspect = 3;\r\nelse if (xres == (yres * 15)/9 && !((yres * 15) % 9))\r\naspect = 4;\r\nelse {\r\nprintk(KERN_INFO "fbcvt: Aspect ratio not CVT "\r\n"standard\n");\r\naspect = 7;\r\ncvt->status = 1;\r\n}\r\nreturn aspect;\r\n}\r\nstatic void fb_cvt_print_name(struct fb_cvt_data *cvt)\r\n{\r\nu32 pixcount, pixcount_mod;\r\nint cnt = 255, offset = 0, read = 0;\r\nu8 *buf = kzalloc(256, GFP_KERNEL);\r\nif (!buf)\r\nreturn;\r\npixcount = (cvt->xres * (cvt->yres/cvt->interlace))/1000000;\r\npixcount_mod = (cvt->xres * (cvt->yres/cvt->interlace)) % 1000000;\r\npixcount_mod /= 1000;\r\nread = snprintf(buf+offset, cnt, "fbcvt: %dx%d@%d: CVT Name - ",\r\ncvt->xres, cvt->yres, cvt->refresh);\r\noffset += read;\r\ncnt -= read;\r\nif (cvt->status)\r\nsnprintf(buf+offset, cnt, "Not a CVT standard - %d.%03d Mega "\r\n"Pixel Image\n", pixcount, pixcount_mod);\r\nelse {\r\nif (pixcount) {\r\nread = snprintf(buf+offset, cnt, "%d", pixcount);\r\ncnt -= read;\r\noffset += read;\r\n}\r\nread = snprintf(buf+offset, cnt, ".%03dM", pixcount_mod);\r\ncnt -= read;\r\noffset += read;\r\nif (cvt->aspect_ratio == 0)\r\nread = snprintf(buf+offset, cnt, "3");\r\nelse if (cvt->aspect_ratio == 3)\r\nread = snprintf(buf+offset, cnt, "4");\r\nelse if (cvt->aspect_ratio == 1 || cvt->aspect_ratio == 4)\r\nread = snprintf(buf+offset, cnt, "9");\r\nelse if (cvt->aspect_ratio == 2)\r\nread = snprintf(buf+offset, cnt, "A");\r\nelse\r\nread = 0;\r\ncnt -= read;\r\noffset += read;\r\nif (cvt->flags & FB_CVT_FLAG_REDUCED_BLANK) {\r\nread = snprintf(buf+offset, cnt, "-R");\r\ncnt -= read;\r\noffset += read;\r\n}\r\n}\r\nprintk(KERN_INFO "%s\n", buf);\r\nkfree(buf);\r\n}\r\nstatic void fb_cvt_convert_to_mode(struct fb_cvt_data *cvt,\r\nstruct fb_videomode *mode)\r\n{\r\nmode->refresh = cvt->f_refresh;\r\nmode->pixclock = KHZ2PICOS(cvt->pixclock/1000);\r\nmode->left_margin = cvt->h_back_porch;\r\nmode->right_margin = cvt->h_front_porch;\r\nmode->hsync_len = cvt->hsync;\r\nmode->upper_margin = cvt->v_back_porch;\r\nmode->lower_margin = cvt->v_front_porch;\r\nmode->vsync_len = cvt->vsync;\r\nmode->sync &= ~(FB_SYNC_HOR_HIGH_ACT | FB_SYNC_VERT_HIGH_ACT);\r\nif (cvt->flags & FB_CVT_FLAG_REDUCED_BLANK)\r\nmode->sync |= FB_SYNC_HOR_HIGH_ACT;\r\nelse\r\nmode->sync |= FB_SYNC_VERT_HIGH_ACT;\r\n}\r\nint fb_find_mode_cvt(struct fb_videomode *mode, int margins, int rb)\r\n{\r\nstruct fb_cvt_data cvt;\r\nmemset(&cvt, 0, sizeof(cvt));\r\nif (margins)\r\ncvt.flags |= FB_CVT_FLAG_MARGINS;\r\nif (rb)\r\ncvt.flags |= FB_CVT_FLAG_REDUCED_BLANK;\r\nif (mode->vmode & FB_VMODE_INTERLACED)\r\ncvt.flags |= FB_CVT_FLAG_INTERLACED;\r\ncvt.xres = mode->xres;\r\ncvt.yres = mode->yres;\r\ncvt.refresh = mode->refresh;\r\ncvt.f_refresh = cvt.refresh;\r\ncvt.interlace = 1;\r\nif (!cvt.xres || !cvt.yres || !cvt.refresh) {\r\nprintk(KERN_INFO "fbcvt: Invalid input parameters\n");\r\nreturn 1;\r\n}\r\nif (!(cvt.refresh == 50 || cvt.refresh == 60 || cvt.refresh == 70 ||\r\ncvt.refresh == 85)) {\r\nprintk(KERN_INFO "fbcvt: Refresh rate not CVT "\r\n"standard\n");\r\ncvt.status = 1;\r\n}\r\ncvt.xres &= ~(FB_CVT_CELLSIZE - 1);\r\nif (cvt.flags & FB_CVT_FLAG_INTERLACED) {\r\ncvt.interlace = 2;\r\ncvt.f_refresh *= 2;\r\n}\r\nif (cvt.flags & FB_CVT_FLAG_REDUCED_BLANK) {\r\nif (cvt.refresh != 60) {\r\nprintk(KERN_INFO "fbcvt: 60Hz refresh rate "\r\n"advised for reduced blanking\n");\r\ncvt.status = 1;\r\n}\r\n}\r\nif (cvt.flags & FB_CVT_FLAG_MARGINS) {\r\ncvt.h_margin = (cvt.xres * 18)/1000;\r\ncvt.h_margin &= ~(FB_CVT_CELLSIZE - 1);\r\ncvt.v_margin = ((cvt.yres/cvt.interlace)* 18)/1000;\r\n}\r\ncvt.aspect_ratio = fb_cvt_aspect_ratio(&cvt);\r\ncvt.active_pixels = cvt.xres + 2 * cvt.h_margin;\r\ncvt.hperiod = fb_cvt_hperiod(&cvt);\r\ncvt.vsync = fb_cvt_vbi_tab[cvt.aspect_ratio];\r\ncvt.vtotal = fb_cvt_vtotal(&cvt);\r\ncvt.hblank = fb_cvt_hblank(&cvt);\r\ncvt.htotal = cvt.active_pixels + cvt.hblank;\r\ncvt.hsync = fb_cvt_hsync(&cvt);\r\ncvt.pixclock = fb_cvt_pixclock(&cvt);\r\ncvt.hfreq = cvt.pixclock/cvt.htotal;\r\ncvt.h_back_porch = cvt.hblank/2 + cvt.h_margin;\r\ncvt.h_front_porch = cvt.hblank - cvt.hsync - cvt.h_back_porch +\r\n2 * cvt.h_margin;\r\ncvt.v_front_porch = 3 + cvt.v_margin;\r\ncvt.v_back_porch = cvt.vtotal - cvt.yres/cvt.interlace -\r\ncvt.v_front_porch - cvt.vsync;\r\nfb_cvt_print_name(&cvt);\r\nfb_cvt_convert_to_mode(&cvt, mode);\r\nreturn 0;\r\n}

static int cpu_pm_notify(enum cpu_pm_event event, int nr_to_call, int *nr_calls)\r\n{\r\nint ret;\r\nret = __raw_notifier_call_chain(&cpu_pm_notifier_chain, event, NULL,\r\nnr_to_call, nr_calls);\r\nreturn notifier_to_errno(ret);\r\n}\r\nint cpu_pm_register_notifier(struct notifier_block *nb)\r\n{\r\nunsigned long flags;\r\nint ret;\r\nwrite_lock_irqsave(&cpu_pm_notifier_lock, flags);\r\nret = raw_notifier_chain_register(&cpu_pm_notifier_chain, nb);\r\nwrite_unlock_irqrestore(&cpu_pm_notifier_lock, flags);\r\nreturn ret;\r\n}\r\nint cpu_pm_unregister_notifier(struct notifier_block *nb)\r\n{\r\nunsigned long flags;\r\nint ret;\r\nwrite_lock_irqsave(&cpu_pm_notifier_lock, flags);\r\nret = raw_notifier_chain_unregister(&cpu_pm_notifier_chain, nb);\r\nwrite_unlock_irqrestore(&cpu_pm_notifier_lock, flags);\r\nreturn ret;\r\n}\r\nint cpu_pm_enter(void)\r\n{\r\nint nr_calls;\r\nint ret = 0;\r\nread_lock(&cpu_pm_notifier_lock);\r\nret = cpu_pm_notify(CPU_PM_ENTER, -1, &nr_calls);\r\nif (ret)\r\ncpu_pm_notify(CPU_PM_ENTER_FAILED, nr_calls - 1, NULL);\r\nread_unlock(&cpu_pm_notifier_lock);\r\nreturn ret;\r\n}\r\nint cpu_pm_exit(void)\r\n{\r\nint ret;\r\nread_lock(&cpu_pm_notifier_lock);\r\nret = cpu_pm_notify(CPU_PM_EXIT, -1, NULL);\r\nread_unlock(&cpu_pm_notifier_lock);\r\nreturn ret;\r\n}\r\nint cpu_cluster_pm_enter(void)\r\n{\r\nint nr_calls;\r\nint ret = 0;\r\nread_lock(&cpu_pm_notifier_lock);\r\nret = cpu_pm_notify(CPU_CLUSTER_PM_ENTER, -1, &nr_calls);\r\nif (ret)\r\ncpu_pm_notify(CPU_CLUSTER_PM_ENTER_FAILED, nr_calls - 1, NULL);\r\nread_unlock(&cpu_pm_notifier_lock);\r\nreturn ret;\r\n}\r\nint cpu_cluster_pm_exit(void)\r\n{\r\nint ret;\r\nread_lock(&cpu_pm_notifier_lock);\r\nret = cpu_pm_notify(CPU_CLUSTER_PM_EXIT, -1, NULL);\r\nread_unlock(&cpu_pm_notifier_lock);\r\nreturn ret;\r\n}\r\nstatic int cpu_pm_suspend(void)\r\n{\r\nint ret;\r\nret = cpu_pm_enter();\r\nif (ret)\r\nreturn ret;\r\nret = cpu_cluster_pm_enter();\r\nreturn ret;\r\n}\r\nstatic void cpu_pm_resume(void)\r\n{\r\ncpu_cluster_pm_exit();\r\ncpu_pm_exit();\r\n}\r\nstatic int cpu_pm_init(void)\r\n{\r\nregister_syscore_ops(&cpu_pm_syscore_ops);\r\nreturn 0;\r\n}

const char *intel_pt_pkt_name(enum intel_pt_pkt_type type)\r\n{\r\nreturn packet_name[type];\r\n}\r\nstatic int intel_pt_get_long_tnt(const unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nuint64_t payload;\r\nint count;\r\nif (len < 8)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\npayload = le64_to_cpu(*(uint64_t *)buf);\r\nfor (count = 47; count; count--) {\r\nif (payload & BIT63)\r\nbreak;\r\npayload <<= 1;\r\n}\r\npacket->type = INTEL_PT_TNT;\r\npacket->count = count;\r\npacket->payload = payload << 1;\r\nreturn 8;\r\n}\r\nstatic int intel_pt_get_pip(const unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nuint64_t payload = 0;\r\nif (len < 8)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\npacket->type = INTEL_PT_PIP;\r\nmemcpy_le64(&payload, buf + 2, 6);\r\npacket->payload = payload >> 1;\r\nif (payload & 1)\r\npacket->payload |= NR_FLAG;\r\nreturn 8;\r\n}\r\nstatic int intel_pt_get_tracestop(struct intel_pt_pkt *packet)\r\n{\r\npacket->type = INTEL_PT_TRACESTOP;\r\nreturn 2;\r\n}\r\nstatic int intel_pt_get_cbr(const unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nif (len < 4)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\npacket->type = INTEL_PT_CBR;\r\npacket->payload = buf[2];\r\nreturn 4;\r\n}\r\nstatic int intel_pt_get_vmcs(const unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nunsigned int count = (52 - 5) >> 3;\r\nif (count < 1 || count > 7)\r\nreturn INTEL_PT_BAD_PACKET;\r\nif (len < count + 2)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\npacket->type = INTEL_PT_VMCS;\r\npacket->count = count;\r\nmemcpy_le64(&packet->payload, buf + 2, count);\r\nreturn count + 2;\r\n}\r\nstatic int intel_pt_get_ovf(struct intel_pt_pkt *packet)\r\n{\r\npacket->type = INTEL_PT_OVF;\r\nreturn 2;\r\n}\r\nstatic int intel_pt_get_psb(const unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nint i;\r\nif (len < 16)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\nfor (i = 2; i < 16; i += 2) {\r\nif (buf[i] != 2 || buf[i + 1] != 0x82)\r\nreturn INTEL_PT_BAD_PACKET;\r\n}\r\npacket->type = INTEL_PT_PSB;\r\nreturn 16;\r\n}\r\nstatic int intel_pt_get_psbend(struct intel_pt_pkt *packet)\r\n{\r\npacket->type = INTEL_PT_PSBEND;\r\nreturn 2;\r\n}\r\nstatic int intel_pt_get_tma(const unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nif (len < 7)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\npacket->type = INTEL_PT_TMA;\r\npacket->payload = buf[2] | (buf[3] << 8);\r\npacket->count = buf[5] | ((buf[6] & BIT(0)) << 8);\r\nreturn 7;\r\n}\r\nstatic int intel_pt_get_pad(struct intel_pt_pkt *packet)\r\n{\r\npacket->type = INTEL_PT_PAD;\r\nreturn 1;\r\n}\r\nstatic int intel_pt_get_mnt(const unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nif (len < 11)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\npacket->type = INTEL_PT_MNT;\r\nmemcpy_le64(&packet->payload, buf + 3, 8);\r\nreturn 11\r\n;\r\n}\r\nstatic int intel_pt_get_3byte(const unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nif (len < 3)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\nswitch (buf[2]) {\r\ncase 0x88:\r\nreturn intel_pt_get_mnt(buf, len, packet);\r\ndefault:\r\nreturn INTEL_PT_BAD_PACKET;\r\n}\r\n}\r\nstatic int intel_pt_get_ext(const unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nif (len < 2)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\nswitch (buf[1]) {\r\ncase 0xa3:\r\nreturn intel_pt_get_long_tnt(buf, len, packet);\r\ncase 0x43:\r\nreturn intel_pt_get_pip(buf, len, packet);\r\ncase 0x83:\r\nreturn intel_pt_get_tracestop(packet);\r\ncase 0x03:\r\nreturn intel_pt_get_cbr(buf, len, packet);\r\ncase 0xc8:\r\nreturn intel_pt_get_vmcs(buf, len, packet);\r\ncase 0xf3:\r\nreturn intel_pt_get_ovf(packet);\r\ncase 0x82:\r\nreturn intel_pt_get_psb(buf, len, packet);\r\ncase 0x23:\r\nreturn intel_pt_get_psbend(packet);\r\ncase 0x73:\r\nreturn intel_pt_get_tma(buf, len, packet);\r\ncase 0xC3:\r\nreturn intel_pt_get_3byte(buf, len, packet);\r\ndefault:\r\nreturn INTEL_PT_BAD_PACKET;\r\n}\r\n}\r\nstatic int intel_pt_get_short_tnt(unsigned int byte,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nint count;\r\nfor (count = 6; count; count--) {\r\nif (byte & BIT(7))\r\nbreak;\r\nbyte <<= 1;\r\n}\r\npacket->type = INTEL_PT_TNT;\r\npacket->count = count;\r\npacket->payload = (uint64_t)byte << 57;\r\nreturn 1;\r\n}\r\nstatic int intel_pt_get_cyc(unsigned int byte, const unsigned char *buf,\r\nsize_t len, struct intel_pt_pkt *packet)\r\n{\r\nunsigned int offs = 1, shift;\r\nuint64_t payload = byte >> 3;\r\nbyte >>= 2;\r\nlen -= 1;\r\nfor (shift = 5; byte & 1; shift += 7) {\r\nif (offs > 9)\r\nreturn INTEL_PT_BAD_PACKET;\r\nif (len < offs)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\nbyte = buf[offs++];\r\npayload |= (byte >> 1) << shift;\r\n}\r\npacket->type = INTEL_PT_CYC;\r\npacket->payload = payload;\r\nreturn offs;\r\n}\r\nstatic int intel_pt_get_ip(enum intel_pt_pkt_type type, unsigned int byte,\r\nconst unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nswitch (byte >> 5) {\r\ncase 0:\r\npacket->count = 0;\r\nbreak;\r\ncase 1:\r\nif (len < 3)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\npacket->count = 2;\r\npacket->payload = le16_to_cpu(*(uint16_t *)(buf + 1));\r\nbreak;\r\ncase 2:\r\nif (len < 5)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\npacket->count = 4;\r\npacket->payload = le32_to_cpu(*(uint32_t *)(buf + 1));\r\nbreak;\r\ncase 3:\r\ncase 6:\r\nif (len < 7)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\npacket->count = 6;\r\nmemcpy_le64(&packet->payload, buf + 1, 6);\r\nbreak;\r\ndefault:\r\nreturn INTEL_PT_BAD_PACKET;\r\n}\r\npacket->type = type;\r\nreturn packet->count + 1;\r\n}\r\nstatic int intel_pt_get_mode(const unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nif (len < 2)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\nswitch (buf[1] >> 5) {\r\ncase 0:\r\npacket->type = INTEL_PT_MODE_EXEC;\r\nswitch (buf[1] & 3) {\r\ncase 0:\r\npacket->payload = 16;\r\nbreak;\r\ncase 1:\r\npacket->payload = 64;\r\nbreak;\r\ncase 2:\r\npacket->payload = 32;\r\nbreak;\r\ndefault:\r\nreturn INTEL_PT_BAD_PACKET;\r\n}\r\nbreak;\r\ncase 1:\r\npacket->type = INTEL_PT_MODE_TSX;\r\nif ((buf[1] & 3) == 3)\r\nreturn INTEL_PT_BAD_PACKET;\r\npacket->payload = buf[1] & 3;\r\nbreak;\r\ndefault:\r\nreturn INTEL_PT_BAD_PACKET;\r\n}\r\nreturn 2;\r\n}\r\nstatic int intel_pt_get_tsc(const unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nif (len < 8)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\npacket->type = INTEL_PT_TSC;\r\nmemcpy_le64(&packet->payload, buf + 1, 7);\r\nreturn 8;\r\n}\r\nstatic int intel_pt_get_mtc(const unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nif (len < 2)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\npacket->type = INTEL_PT_MTC;\r\npacket->payload = buf[1];\r\nreturn 2;\r\n}\r\nstatic int intel_pt_do_get_packet(const unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nunsigned int byte;\r\nmemset(packet, 0, sizeof(struct intel_pt_pkt));\r\nif (!len)\r\nreturn INTEL_PT_NEED_MORE_BYTES;\r\nbyte = buf[0];\r\nif (!(byte & BIT(0))) {\r\nif (byte == 0)\r\nreturn intel_pt_get_pad(packet);\r\nif (byte == 2)\r\nreturn intel_pt_get_ext(buf, len, packet);\r\nreturn intel_pt_get_short_tnt(byte, packet);\r\n}\r\nif ((byte & 2))\r\nreturn intel_pt_get_cyc(byte, buf, len, packet);\r\nswitch (byte & 0x1f) {\r\ncase 0x0D:\r\nreturn intel_pt_get_ip(INTEL_PT_TIP, byte, buf, len, packet);\r\ncase 0x11:\r\nreturn intel_pt_get_ip(INTEL_PT_TIP_PGE, byte, buf, len,\r\npacket);\r\ncase 0x01:\r\nreturn intel_pt_get_ip(INTEL_PT_TIP_PGD, byte, buf, len,\r\npacket);\r\ncase 0x1D:\r\nreturn intel_pt_get_ip(INTEL_PT_FUP, byte, buf, len, packet);\r\ncase 0x19:\r\nswitch (byte) {\r\ncase 0x99:\r\nreturn intel_pt_get_mode(buf, len, packet);\r\ncase 0x19:\r\nreturn intel_pt_get_tsc(buf, len, packet);\r\ncase 0x59:\r\nreturn intel_pt_get_mtc(buf, len, packet);\r\ndefault:\r\nreturn INTEL_PT_BAD_PACKET;\r\n}\r\ndefault:\r\nreturn INTEL_PT_BAD_PACKET;\r\n}\r\n}\r\nint intel_pt_get_packet(const unsigned char *buf, size_t len,\r\nstruct intel_pt_pkt *packet)\r\n{\r\nint ret;\r\nret = intel_pt_do_get_packet(buf, len, packet);\r\nif (ret > 0) {\r\nwhile (ret < 8 && len > (size_t)ret && !buf[ret])\r\nret += 1;\r\n}\r\nreturn ret;\r\n}\r\nint intel_pt_pkt_desc(const struct intel_pt_pkt *packet, char *buf,\r\nsize_t buf_len)\r\n{\r\nint ret, i, nr;\r\nunsigned long long payload = packet->payload;\r\nconst char *name = intel_pt_pkt_name(packet->type);\r\nswitch (packet->type) {\r\ncase INTEL_PT_BAD:\r\ncase INTEL_PT_PAD:\r\ncase INTEL_PT_PSB:\r\ncase INTEL_PT_PSBEND:\r\ncase INTEL_PT_TRACESTOP:\r\ncase INTEL_PT_OVF:\r\nreturn snprintf(buf, buf_len, "%s", name);\r\ncase INTEL_PT_TNT: {\r\nsize_t blen = buf_len;\r\nret = snprintf(buf, blen, "%s ", name);\r\nif (ret < 0)\r\nreturn ret;\r\nbuf += ret;\r\nblen -= ret;\r\nfor (i = 0; i < packet->count; i++) {\r\nif (payload & BIT63)\r\nret = snprintf(buf, blen, "T");\r\nelse\r\nret = snprintf(buf, blen, "N");\r\nif (ret < 0)\r\nreturn ret;\r\nbuf += ret;\r\nblen -= ret;\r\npayload <<= 1;\r\n}\r\nret = snprintf(buf, blen, " (%d)", packet->count);\r\nif (ret < 0)\r\nreturn ret;\r\nblen -= ret;\r\nreturn buf_len - blen;\r\n}\r\ncase INTEL_PT_TIP_PGD:\r\ncase INTEL_PT_TIP_PGE:\r\ncase INTEL_PT_TIP:\r\ncase INTEL_PT_FUP:\r\nif (!(packet->count))\r\nreturn snprintf(buf, buf_len, "%s no ip", name);\r\ncase INTEL_PT_CYC:\r\ncase INTEL_PT_VMCS:\r\ncase INTEL_PT_MTC:\r\ncase INTEL_PT_MNT:\r\ncase INTEL_PT_CBR:\r\ncase INTEL_PT_TSC:\r\nreturn snprintf(buf, buf_len, "%s 0x%llx", name, payload);\r\ncase INTEL_PT_TMA:\r\nreturn snprintf(buf, buf_len, "%s CTC 0x%x FC 0x%x", name,\r\n(unsigned)payload, packet->count);\r\ncase INTEL_PT_MODE_EXEC:\r\nreturn snprintf(buf, buf_len, "%s %lld", name, payload);\r\ncase INTEL_PT_MODE_TSX:\r\nreturn snprintf(buf, buf_len, "%s TXAbort:%u InTX:%u",\r\nname, (unsigned)(payload >> 1) & 1,\r\n(unsigned)payload & 1);\r\ncase INTEL_PT_PIP:\r\nnr = packet->payload & NR_FLAG ? 1 : 0;\r\npayload &= ~NR_FLAG;\r\nret = snprintf(buf, buf_len, "%s 0x%llx (NR=%d)",\r\nname, payload, nr);\r\nreturn ret;\r\ndefault:\r\nbreak;\r\n}\r\nreturn snprintf(buf, buf_len, "%s 0x%llx (%d)",\r\nname, payload, packet->count);\r\n}

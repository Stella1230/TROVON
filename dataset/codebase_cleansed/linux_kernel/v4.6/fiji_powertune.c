void fiji_initialize_power_tune_defaults(struct pp_hwmgr *hwmgr)\r\n{\r\nstruct fiji_hwmgr *fiji_hwmgr = (struct fiji_hwmgr *)(hwmgr->backend);\r\nstruct phm_ppt_v1_information *table_info =\r\n(struct phm_ppt_v1_information *)(hwmgr->pptable);\r\nuint32_t tmp = 0;\r\nif(table_info &&\r\ntable_info->cac_dtp_table->usPowerTuneDataSetID <= POWERTUNE_DEFAULT_SET_MAX &&\r\ntable_info->cac_dtp_table->usPowerTuneDataSetID)\r\nfiji_hwmgr->power_tune_defaults =\r\n&fiji_power_tune_data_set_array\r\n[table_info->cac_dtp_table->usPowerTuneDataSetID - 1];\r\nelse\r\nfiji_hwmgr->power_tune_defaults = &fiji_power_tune_data_set_array[0];\r\nphm_cap_unset(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_PowerContainment);\r\nphm_cap_unset(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_CAC);\r\nphm_cap_unset(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_SQRamping);\r\nphm_cap_unset(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_DBRamping);\r\nphm_cap_unset(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_TDRamping);\r\nphm_cap_unset(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_TCPRamping);\r\nfiji_hwmgr->dte_tj_offset = tmp;\r\nif (!tmp) {\r\nphm_cap_set(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_PowerContainment);\r\nphm_cap_set(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_CAC);\r\nfiji_hwmgr->fast_watermark_threshold = 100;\r\ntmp = 1;\r\nfiji_hwmgr->enable_dte_feature = tmp ? false : true;\r\nfiji_hwmgr->enable_tdc_limit_feature = tmp ? true : false;\r\nfiji_hwmgr->enable_pkg_pwr_tracking_feature = tmp ? true : false;\r\n}\r\n}\r\nstatic uint16_t scale_fan_gain_settings(uint16_t raw_setting)\r\n{\r\nuint32_t tmp;\r\ntmp = raw_setting * 4096 / 100;\r\nreturn (uint16_t)tmp;\r\n}\r\nstatic void get_scl_sda_value(uint8_t line, uint8_t *scl, uint8_t* sda)\r\n{\r\nswitch (line) {\r\ncase Fiji_I2CLineID_DDC1 :\r\n*scl = Fiji_I2C_DDC1CLK;\r\n*sda = Fiji_I2C_DDC1DATA;\r\nbreak;\r\ncase Fiji_I2CLineID_DDC2 :\r\n*scl = Fiji_I2C_DDC2CLK;\r\n*sda = Fiji_I2C_DDC2DATA;\r\nbreak;\r\ncase Fiji_I2CLineID_DDC3 :\r\n*scl = Fiji_I2C_DDC3CLK;\r\n*sda = Fiji_I2C_DDC3DATA;\r\nbreak;\r\ncase Fiji_I2CLineID_DDC4 :\r\n*scl = Fiji_I2C_DDC4CLK;\r\n*sda = Fiji_I2C_DDC4DATA;\r\nbreak;\r\ncase Fiji_I2CLineID_DDC5 :\r\n*scl = Fiji_I2C_DDC5CLK;\r\n*sda = Fiji_I2C_DDC5DATA;\r\nbreak;\r\ncase Fiji_I2CLineID_DDC6 :\r\n*scl = Fiji_I2C_DDC6CLK;\r\n*sda = Fiji_I2C_DDC6DATA;\r\nbreak;\r\ncase Fiji_I2CLineID_SCLSDA :\r\n*scl = Fiji_I2C_SCL;\r\n*sda = Fiji_I2C_SDA;\r\nbreak;\r\ncase Fiji_I2CLineID_DDCVGA :\r\n*scl = Fiji_I2C_DDCVGACLK;\r\n*sda = Fiji_I2C_DDCVGADATA;\r\nbreak;\r\ndefault:\r\n*scl = 0;\r\n*sda = 0;\r\nbreak;\r\n}\r\n}\r\nint fiji_populate_bapm_parameters_in_dpm_table(struct pp_hwmgr *hwmgr)\r\n{\r\nstruct fiji_hwmgr *data = (struct fiji_hwmgr *)(hwmgr->backend);\r\nstruct fiji_pt_defaults *defaults = data->power_tune_defaults;\r\nSMU73_Discrete_DpmTable *dpm_table = &(data->smc_state_table);\r\nstruct phm_ppt_v1_information *table_info =\r\n(struct phm_ppt_v1_information *)(hwmgr->pptable);\r\nstruct phm_cac_tdp_table *cac_dtp_table = table_info->cac_dtp_table;\r\nstruct pp_advance_fan_control_parameters *fan_table=\r\n&hwmgr->thermal_controller.advanceFanControlParameters;\r\nuint8_t uc_scl, uc_sda;\r\ndpm_table->DefaultTdp = PP_HOST_TO_SMC_US(\r\n(uint16_t)(cac_dtp_table->usTDP * 128));\r\ndpm_table->TargetTdp = PP_HOST_TO_SMC_US(\r\n(uint16_t)(cac_dtp_table->usTDP * 128));\r\nPP_ASSERT_WITH_CODE(cac_dtp_table->usTargetOperatingTemp <= 255,\r\n"Target Operating Temp is out of Range!",);\r\ndpm_table->GpuTjMax = (uint8_t)(cac_dtp_table->usTargetOperatingTemp);\r\ndpm_table->GpuTjHyst = 8;\r\ndpm_table->DTEAmbientTempBase = defaults->DTEAmbientTempBase;\r\ndpm_table->TemperatureLimitEdge = PP_HOST_TO_SMC_US(\r\ncac_dtp_table->usTargetOperatingTemp * 256);\r\ndpm_table->TemperatureLimitHotspot = PP_HOST_TO_SMC_US(\r\ncac_dtp_table->usTemperatureLimitHotspot * 256);\r\ndpm_table->TemperatureLimitLiquid1 = PP_HOST_TO_SMC_US(\r\ncac_dtp_table->usTemperatureLimitLiquid1 * 256);\r\ndpm_table->TemperatureLimitLiquid2 = PP_HOST_TO_SMC_US(\r\ncac_dtp_table->usTemperatureLimitLiquid2 * 256);\r\ndpm_table->TemperatureLimitVrVddc = PP_HOST_TO_SMC_US(\r\ncac_dtp_table->usTemperatureLimitVrVddc * 256);\r\ndpm_table->TemperatureLimitVrMvdd = PP_HOST_TO_SMC_US(\r\ncac_dtp_table->usTemperatureLimitVrMvdd * 256);\r\ndpm_table->TemperatureLimitPlx = PP_HOST_TO_SMC_US(\r\ncac_dtp_table->usTemperatureLimitPlx * 256);\r\ndpm_table->FanGainEdge = PP_HOST_TO_SMC_US(\r\nscale_fan_gain_settings(fan_table->usFanGainEdge));\r\ndpm_table->FanGainHotspot = PP_HOST_TO_SMC_US(\r\nscale_fan_gain_settings(fan_table->usFanGainHotspot));\r\ndpm_table->FanGainLiquid = PP_HOST_TO_SMC_US(\r\nscale_fan_gain_settings(fan_table->usFanGainLiquid));\r\ndpm_table->FanGainVrVddc = PP_HOST_TO_SMC_US(\r\nscale_fan_gain_settings(fan_table->usFanGainVrVddc));\r\ndpm_table->FanGainVrMvdd = PP_HOST_TO_SMC_US(\r\nscale_fan_gain_settings(fan_table->usFanGainVrMvdd));\r\ndpm_table->FanGainPlx = PP_HOST_TO_SMC_US(\r\nscale_fan_gain_settings(fan_table->usFanGainPlx));\r\ndpm_table->FanGainHbm = PP_HOST_TO_SMC_US(\r\nscale_fan_gain_settings(fan_table->usFanGainHbm));\r\ndpm_table->Liquid1_I2C_address = cac_dtp_table->ucLiquid1_I2C_address;\r\ndpm_table->Liquid2_I2C_address = cac_dtp_table->ucLiquid2_I2C_address;\r\ndpm_table->Vr_I2C_address = cac_dtp_table->ucVr_I2C_address;\r\ndpm_table->Plx_I2C_address = cac_dtp_table->ucPlx_I2C_address;\r\nget_scl_sda_value(cac_dtp_table->ucLiquid_I2C_Line, &uc_scl, &uc_sda);\r\ndpm_table->Liquid_I2C_LineSCL = uc_scl;\r\ndpm_table->Liquid_I2C_LineSDA = uc_sda;\r\nget_scl_sda_value(cac_dtp_table->ucVr_I2C_Line, &uc_scl, &uc_sda);\r\ndpm_table->Vr_I2C_LineSCL = uc_scl;\r\ndpm_table->Vr_I2C_LineSDA = uc_sda;\r\nget_scl_sda_value(cac_dtp_table->ucPlx_I2C_Line, &uc_scl, &uc_sda);\r\ndpm_table->Plx_I2C_LineSCL = uc_scl;\r\ndpm_table->Plx_I2C_LineSDA = uc_sda;\r\nreturn 0;\r\n}\r\nstatic int fiji_populate_svi_load_line(struct pp_hwmgr *hwmgr)\r\n{\r\nstruct fiji_hwmgr *data = (struct fiji_hwmgr *)(hwmgr->backend);\r\nstruct fiji_pt_defaults *defaults = data->power_tune_defaults;\r\ndata->power_tune_table.SviLoadLineEn = defaults->SviLoadLineEn;\r\ndata->power_tune_table.SviLoadLineVddC = defaults->SviLoadLineVddC;\r\ndata->power_tune_table.SviLoadLineTrimVddC = 3;\r\ndata->power_tune_table.SviLoadLineOffsetVddC = 0;\r\nreturn 0;\r\n}\r\nstatic int fiji_populate_tdc_limit(struct pp_hwmgr *hwmgr)\r\n{\r\nuint16_t tdc_limit;\r\nstruct fiji_hwmgr *data = (struct fiji_hwmgr *)(hwmgr->backend);\r\nstruct phm_ppt_v1_information *table_info =\r\n(struct phm_ppt_v1_information *)(hwmgr->pptable);\r\nstruct fiji_pt_defaults *defaults = data->power_tune_defaults;\r\ntdc_limit = (uint16_t)(table_info->cac_dtp_table->usTDC * 128);\r\ndata->power_tune_table.TDC_VDDC_PkgLimit =\r\nCONVERT_FROM_HOST_TO_SMC_US(tdc_limit);\r\ndata->power_tune_table.TDC_VDDC_ThrottleReleaseLimitPerc =\r\ndefaults->TDC_VDDC_ThrottleReleaseLimitPerc;\r\ndata->power_tune_table.TDC_MAWt = defaults->TDC_MAWt;\r\nreturn 0;\r\n}\r\nstatic int fiji_populate_dw8(struct pp_hwmgr *hwmgr, uint32_t fuse_table_offset)\r\n{\r\nstruct fiji_hwmgr *data = (struct fiji_hwmgr *)(hwmgr->backend);\r\nstruct fiji_pt_defaults *defaults = data->power_tune_defaults;\r\nuint32_t temp;\r\nif (fiji_read_smc_sram_dword(hwmgr->smumgr,\r\nfuse_table_offset +\r\noffsetof(SMU73_Discrete_PmFuses, TdcWaterfallCtl),\r\n(uint32_t *)&temp, data->sram_end))\r\nPP_ASSERT_WITH_CODE(false,\r\n"Attempt to read PmFuses.DW6 (SviLoadLineEn) from SMC Failed!",\r\nreturn -EINVAL);\r\nelse {\r\ndata->power_tune_table.TdcWaterfallCtl = defaults->TdcWaterfallCtl;\r\ndata->power_tune_table.LPMLTemperatureMin =\r\n(uint8_t)((temp >> 16) & 0xff);\r\ndata->power_tune_table.LPMLTemperatureMax =\r\n(uint8_t)((temp >> 8) & 0xff);\r\ndata->power_tune_table.Reserved = (uint8_t)(temp & 0xff);\r\n}\r\nreturn 0;\r\n}\r\nstatic int fiji_populate_temperature_scaler(struct pp_hwmgr *hwmgr)\r\n{\r\nint i;\r\nstruct fiji_hwmgr *data = (struct fiji_hwmgr *)(hwmgr->backend);\r\nfor (i = 0; i < 16; i++)\r\ndata->power_tune_table.LPMLTemperatureScaler[i] = 0;\r\nreturn 0;\r\n}\r\nstatic int fiji_populate_fuzzy_fan(struct pp_hwmgr *hwmgr)\r\n{\r\nstruct fiji_hwmgr *data = (struct fiji_hwmgr *)(hwmgr->backend);\r\nif( (hwmgr->thermal_controller.advanceFanControlParameters.\r\nusFanOutputSensitivity & (1 << 15)) ||\r\n0 == hwmgr->thermal_controller.advanceFanControlParameters.\r\nusFanOutputSensitivity )\r\nhwmgr->thermal_controller.advanceFanControlParameters.\r\nusFanOutputSensitivity = hwmgr->thermal_controller.\r\nadvanceFanControlParameters.usDefaultFanOutputSensitivity;\r\ndata->power_tune_table.FuzzyFan_PwmSetDelta =\r\nPP_HOST_TO_SMC_US(hwmgr->thermal_controller.\r\nadvanceFanControlParameters.usFanOutputSensitivity);\r\nreturn 0;\r\n}\r\nstatic int fiji_populate_gnb_lpml(struct pp_hwmgr *hwmgr)\r\n{\r\nint i;\r\nstruct fiji_hwmgr *data = (struct fiji_hwmgr *)(hwmgr->backend);\r\nfor (i = 0; i < 16; i++)\r\ndata->power_tune_table.GnbLPML[i] = 0;\r\nreturn 0;\r\n}\r\nstatic int fiji_min_max_vgnb_lpml_id_from_bapm_vddc(struct pp_hwmgr *hwmgr)\r\n{\r\nreturn 0;\r\n}\r\nstatic int fiji_populate_bapm_vddc_base_leakage_sidd(struct pp_hwmgr *hwmgr)\r\n{\r\nstruct fiji_hwmgr *data = (struct fiji_hwmgr *)(hwmgr->backend);\r\nstruct phm_ppt_v1_information *table_info =\r\n(struct phm_ppt_v1_information *)(hwmgr->pptable);\r\nuint16_t HiSidd = data->power_tune_table.BapmVddCBaseLeakageHiSidd;\r\nuint16_t LoSidd = data->power_tune_table.BapmVddCBaseLeakageLoSidd;\r\nstruct phm_cac_tdp_table *cac_table = table_info->cac_dtp_table;\r\nHiSidd = (uint16_t)(cac_table->usHighCACLeakage / 100 * 256);\r\nLoSidd = (uint16_t)(cac_table->usLowCACLeakage / 100 * 256);\r\ndata->power_tune_table.BapmVddCBaseLeakageHiSidd =\r\nCONVERT_FROM_HOST_TO_SMC_US(HiSidd);\r\ndata->power_tune_table.BapmVddCBaseLeakageLoSidd =\r\nCONVERT_FROM_HOST_TO_SMC_US(LoSidd);\r\nreturn 0;\r\n}\r\nint fiji_populate_pm_fuses(struct pp_hwmgr *hwmgr)\r\n{\r\nstruct fiji_hwmgr *data = (struct fiji_hwmgr *)(hwmgr->backend);\r\nuint32_t pm_fuse_table_offset;\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_PowerContainment)) {\r\nif (fiji_read_smc_sram_dword(hwmgr->smumgr,\r\nSMU7_FIRMWARE_HEADER_LOCATION +\r\noffsetof(SMU73_Firmware_Header, PmFuseTable),\r\n&pm_fuse_table_offset, data->sram_end))\r\nPP_ASSERT_WITH_CODE(false,\r\n"Attempt to get pm_fuse_table_offset Failed!",\r\nreturn -EINVAL);\r\nif (fiji_populate_svi_load_line(hwmgr))\r\nPP_ASSERT_WITH_CODE(false,\r\n"Attempt to populate SviLoadLine Failed!",\r\nreturn -EINVAL);\r\nif (fiji_populate_tdc_limit(hwmgr))\r\nPP_ASSERT_WITH_CODE(false,\r\n"Attempt to populate TDCLimit Failed!", return -EINVAL);\r\nif (fiji_populate_dw8(hwmgr, pm_fuse_table_offset))\r\nPP_ASSERT_WITH_CODE(false,\r\n"Attempt to populate TdcWaterfallCtl, "\r\n"LPMLTemperature Min and Max Failed!",\r\nreturn -EINVAL);\r\nif (0 != fiji_populate_temperature_scaler(hwmgr))\r\nPP_ASSERT_WITH_CODE(false,\r\n"Attempt to populate LPMLTemperatureScaler Failed!",\r\nreturn -EINVAL);\r\nif(fiji_populate_fuzzy_fan(hwmgr))\r\nPP_ASSERT_WITH_CODE(false,\r\n"Attempt to populate Fuzzy Fan Control parameters Failed!",\r\nreturn -EINVAL);\r\nif (fiji_populate_gnb_lpml(hwmgr))\r\nPP_ASSERT_WITH_CODE(false,\r\n"Attempt to populate GnbLPML Failed!",\r\nreturn -EINVAL);\r\nif (fiji_min_max_vgnb_lpml_id_from_bapm_vddc(hwmgr))\r\nPP_ASSERT_WITH_CODE(false,\r\n"Attempt to populate GnbLPML Min and Max Vid Failed!",\r\nreturn -EINVAL);\r\nif (fiji_populate_bapm_vddc_base_leakage_sidd(hwmgr))\r\nPP_ASSERT_WITH_CODE(false,\r\n"Attempt to populate BapmVddCBaseLeakage Hi and Lo "\r\n"Sidd Failed!", return -EINVAL);\r\nif (fiji_copy_bytes_to_smc(hwmgr->smumgr, pm_fuse_table_offset,\r\n(uint8_t *)&data->power_tune_table,\r\nsizeof(struct SMU73_Discrete_PmFuses), data->sram_end))\r\nPP_ASSERT_WITH_CODE(false,\r\n"Attempt to download PmFuseTable Failed!",\r\nreturn -EINVAL);\r\n}\r\nreturn 0;\r\n}\r\nint fiji_enable_smc_cac(struct pp_hwmgr *hwmgr)\r\n{\r\nstruct fiji_hwmgr *data = (struct fiji_hwmgr *)(hwmgr->backend);\r\nint result = 0;\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_CAC)) {\r\nint smc_result;\r\nsmc_result = smum_send_msg_to_smc(hwmgr->smumgr,\r\n(uint16_t)(PPSMC_MSG_EnableCac));\r\nPP_ASSERT_WITH_CODE((0 == smc_result),\r\n"Failed to enable CAC in SMC.", result = -1);\r\ndata->cac_enabled = (0 == smc_result) ? true : false;\r\n}\r\nreturn result;\r\n}\r\nint fiji_set_power_limit(struct pp_hwmgr *hwmgr, uint32_t n)\r\n{\r\nstruct fiji_hwmgr *data = (struct fiji_hwmgr *)(hwmgr->backend);\r\nif(data->power_containment_features &\r\nPOWERCONTAINMENT_FEATURE_PkgPwrLimit)\r\nreturn smum_send_msg_to_smc_with_parameter(hwmgr->smumgr,\r\nPPSMC_MSG_PkgPwrSetLimit, n);\r\nreturn 0;\r\n}\r\nstatic int fiji_set_overdriver_target_tdp(struct pp_hwmgr *pHwMgr, uint32_t target_tdp)\r\n{\r\nreturn smum_send_msg_to_smc_with_parameter(pHwMgr->smumgr,\r\nPPSMC_MSG_OverDriveSetTargetTdp, target_tdp);\r\n}\r\nint fiji_enable_power_containment(struct pp_hwmgr *hwmgr)\r\n{\r\nstruct fiji_hwmgr *data = (struct fiji_hwmgr *)(hwmgr->backend);\r\nstruct phm_ppt_v1_information *table_info =\r\n(struct phm_ppt_v1_information *)(hwmgr->pptable);\r\nint smc_result;\r\nint result = 0;\r\ndata->power_containment_features = 0;\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_PowerContainment)) {\r\nif (data->enable_dte_feature) {\r\nsmc_result = smum_send_msg_to_smc(hwmgr->smumgr,\r\n(uint16_t)(PPSMC_MSG_EnableDTE));\r\nPP_ASSERT_WITH_CODE((0 == smc_result),\r\n"Failed to enable DTE in SMC.", result = -1;);\r\nif (0 == smc_result)\r\ndata->power_containment_features |= POWERCONTAINMENT_FEATURE_DTE;\r\n}\r\nif (data->enable_tdc_limit_feature) {\r\nsmc_result = smum_send_msg_to_smc(hwmgr->smumgr,\r\n(uint16_t)(PPSMC_MSG_TDCLimitEnable));\r\nPP_ASSERT_WITH_CODE((0 == smc_result),\r\n"Failed to enable TDCLimit in SMC.", result = -1;);\r\nif (0 == smc_result)\r\ndata->power_containment_features |=\r\nPOWERCONTAINMENT_FEATURE_TDCLimit;\r\n}\r\nif (data->enable_pkg_pwr_tracking_feature) {\r\nsmc_result = smum_send_msg_to_smc(hwmgr->smumgr,\r\n(uint16_t)(PPSMC_MSG_PkgPwrLimitEnable));\r\nPP_ASSERT_WITH_CODE((0 == smc_result),\r\n"Failed to enable PkgPwrTracking in SMC.", result = -1;);\r\nif (0 == smc_result) {\r\nstruct phm_cac_tdp_table *cac_table =\r\ntable_info->cac_dtp_table;\r\nuint32_t default_limit =\r\n(uint32_t)(cac_table->usMaximumPowerDeliveryLimit * 256);\r\ndata->power_containment_features |=\r\nPOWERCONTAINMENT_FEATURE_PkgPwrLimit;\r\nif (fiji_set_power_limit(hwmgr, default_limit))\r\nprintk(KERN_ERR "Failed to set Default Power Limit in SMC!");\r\n}\r\n}\r\n}\r\nreturn result;\r\n}\r\nint fiji_power_control_set_level(struct pp_hwmgr *hwmgr)\r\n{\r\nstruct phm_ppt_v1_information *table_info =\r\n(struct phm_ppt_v1_information *)(hwmgr->pptable);\r\nstruct phm_cac_tdp_table *cac_table = table_info->cac_dtp_table;\r\nint adjust_percent, target_tdp;\r\nint result = 0;\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps,\r\nPHM_PlatformCaps_PowerContainment)) {\r\nadjust_percent = hwmgr->platform_descriptor.TDPAdjustmentPolarity ?\r\nhwmgr->platform_descriptor.TDPAdjustment :\r\n(-1 * hwmgr->platform_descriptor.TDPAdjustment);\r\ntarget_tdp = ((100 + adjust_percent) * (int)(cac_table->usTDP * 256)) / 100;\r\nresult = fiji_set_overdriver_target_tdp(hwmgr, (uint32_t)target_tdp);\r\n}\r\nreturn result;\r\n}

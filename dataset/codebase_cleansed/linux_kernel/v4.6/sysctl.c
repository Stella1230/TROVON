int proc_dolasatstring(struct ctl_table *table, int write,\r\nvoid *buffer, size_t *lenp, loff_t *ppos)\r\n{\r\nint r;\r\nr = proc_dostring(table, write, buffer, lenp, ppos);\r\nif ((!write) || r)\r\nreturn r;\r\nlasat_write_eeprom_info();\r\nreturn 0;\r\n}\r\nint proc_dolasatrtc(struct ctl_table *table, int write,\r\nvoid *buffer, size_t *lenp, loff_t *ppos)\r\n{\r\nstruct timespec64 ts;\r\nint r;\r\nif (!write) {\r\nread_persistent_clock64(&ts);\r\nrtctmp = ts.tv_sec;\r\nif (rtctmp < 0)\r\nrtctmp = 0;\r\n}\r\nr = proc_dointvec(table, write, buffer, lenp, ppos);\r\nif (r)\r\nreturn r;\r\nif (write)\r\nrtc_mips_set_mmss(rtctmp);\r\nreturn 0;\r\n}\r\nint proc_lasat_ip(struct ctl_table *table, int write,\r\nvoid *buffer, size_t *lenp, loff_t *ppos)\r\n{\r\nunsigned int ip;\r\nchar *p, c;\r\nint len;\r\nchar ipbuf[32];\r\nif (!table->data || !table->maxlen || !*lenp ||\r\n(*ppos && !write)) {\r\n*lenp = 0;\r\nreturn 0;\r\n}\r\nif (write) {\r\nlen = 0;\r\np = buffer;\r\nwhile (len < *lenp) {\r\nif (get_user(c, p++))\r\nreturn -EFAULT;\r\nif (c == 0 || c == '\n')\r\nbreak;\r\nlen++;\r\n}\r\nif (len >= sizeof(ipbuf)-1)\r\nlen = sizeof(ipbuf) - 1;\r\nif (copy_from_user(ipbuf, buffer, len))\r\nreturn -EFAULT;\r\nipbuf[len] = 0;\r\n*ppos += *lenp;\r\nip = in_aton(ipbuf);\r\n*(unsigned int *)(table->data) = ip;\r\nlasat_write_eeprom_info();\r\n} else {\r\nip = *(unsigned int *)(table->data);\r\nsprintf(ipbuf, "%d.%d.%d.%d",\r\n(ip) & 0xff,\r\n(ip >> 8) & 0xff,\r\n(ip >> 16) & 0xff,\r\n(ip >> 24) & 0xff);\r\nlen = strlen(ipbuf);\r\nif (len > *lenp)\r\nlen = *lenp;\r\nif (len)\r\nif (copy_to_user(buffer, ipbuf, len))\r\nreturn -EFAULT;\r\nif (len < *lenp) {\r\nif (put_user('\n', ((char *) buffer) + len))\r\nreturn -EFAULT;\r\nlen++;\r\n}\r\n*lenp = len;\r\n*ppos += len;\r\n}\r\nreturn 0;\r\n}\r\nint proc_lasat_prid(struct ctl_table *table, int write,\r\nvoid *buffer, size_t *lenp, loff_t *ppos)\r\n{\r\nint r;\r\nr = proc_dointvec(table, write, buffer, lenp, ppos);\r\nif (r < 0)\r\nreturn r;\r\nif (write) {\r\nlasat_board_info.li_eeprom_info.prid =\r\nlasat_board_info.li_prid;\r\nlasat_write_eeprom_info();\r\nlasat_init_board_info();\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init lasat_register_sysctl(void)\r\n{\r\nstruct ctl_table_header *lasat_table_header;\r\nlasat_table_header =\r\nregister_sysctl_table(lasat_root_table);\r\nif (!lasat_table_header) {\r\nprintk(KERN_ERR "Unable to register LASAT sysctl\n");\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}

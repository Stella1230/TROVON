static void acpi_video_parse_cmdline(void)\r\n{\r\nif (!strcmp("vendor", acpi_video_backlight_string))\r\nacpi_backlight_cmdline = acpi_backlight_vendor;\r\nif (!strcmp("video", acpi_video_backlight_string))\r\nacpi_backlight_cmdline = acpi_backlight_video;\r\nif (!strcmp("native", acpi_video_backlight_string))\r\nacpi_backlight_cmdline = acpi_backlight_native;\r\nif (!strcmp("none", acpi_video_backlight_string))\r\nacpi_backlight_cmdline = acpi_backlight_none;\r\n}\r\nstatic acpi_status\r\nfind_video(acpi_handle handle, u32 lvl, void *context, void **rv)\r\n{\r\nlong *cap = context;\r\nstruct pci_dev *dev;\r\nstruct acpi_device *acpi_dev;\r\nstatic const struct acpi_device_id video_ids[] = {\r\n{ACPI_VIDEO_HID, 0},\r\n{"", 0},\r\n};\r\nif (acpi_bus_get_device(handle, &acpi_dev))\r\nreturn AE_OK;\r\nif (!acpi_match_device_ids(acpi_dev, video_ids)) {\r\ndev = acpi_get_pci_dev(handle);\r\nif (!dev)\r\nreturn AE_OK;\r\npci_dev_put(dev);\r\n*cap |= acpi_is_video_device(handle);\r\n}\r\nreturn AE_OK;\r\n}\r\nstatic int video_detect_force_vendor(const struct dmi_system_id *d)\r\n{\r\nacpi_backlight_dmi = acpi_backlight_vendor;\r\nreturn 0;\r\n}\r\nstatic int video_detect_force_video(const struct dmi_system_id *d)\r\n{\r\nacpi_backlight_dmi = acpi_backlight_video;\r\nreturn 0;\r\n}\r\nstatic int video_detect_force_native(const struct dmi_system_id *d)\r\n{\r\nacpi_backlight_dmi = acpi_backlight_native;\r\nreturn 0;\r\n}\r\nstatic void acpi_video_backlight_notify_work(struct work_struct *work)\r\n{\r\nif (acpi_video_get_backlight_type() != acpi_backlight_video)\r\nacpi_video_unregister_backlight();\r\n}\r\nstatic int acpi_video_backlight_notify(struct notifier_block *nb,\r\nunsigned long val, void *bd)\r\n{\r\nstruct backlight_device *backlight = bd;\r\nif (backlight->props.type == BACKLIGHT_RAW &&\r\nval == BACKLIGHT_REGISTERED)\r\nschedule_work(&backlight_notify_work);\r\nreturn NOTIFY_OK;\r\n}\r\nenum acpi_backlight_type acpi_video_get_backlight_type(void)\r\n{\r\nstatic DEFINE_MUTEX(init_mutex);\r\nstatic bool init_done;\r\nstatic long video_caps;\r\nmutex_lock(&init_mutex);\r\nif (!init_done) {\r\nacpi_video_parse_cmdline();\r\ndmi_check_system(video_detect_dmi_table);\r\nacpi_walk_namespace(ACPI_TYPE_DEVICE, ACPI_ROOT_OBJECT,\r\nACPI_UINT32_MAX, find_video, NULL,\r\n&video_caps, NULL);\r\nINIT_WORK(&backlight_notify_work,\r\nacpi_video_backlight_notify_work);\r\nbacklight_nb.notifier_call = acpi_video_backlight_notify;\r\nbacklight_nb.priority = 0;\r\nif (backlight_register_notifier(&backlight_nb) == 0)\r\nbacklight_notifier_registered = true;\r\ninit_done = true;\r\n}\r\nmutex_unlock(&init_mutex);\r\nif (acpi_backlight_cmdline != acpi_backlight_undef)\r\nreturn acpi_backlight_cmdline;\r\nif (acpi_backlight_dmi != acpi_backlight_undef)\r\nreturn acpi_backlight_dmi;\r\nif (!(video_caps & ACPI_VIDEO_BACKLIGHT))\r\nreturn acpi_backlight_vendor;\r\nif (acpi_osi_is_win8() && backlight_device_registered(BACKLIGHT_RAW))\r\nreturn acpi_backlight_native;\r\nreturn acpi_backlight_video;\r\n}\r\nvoid acpi_video_set_dmi_backlight_type(enum acpi_backlight_type type)\r\n{\r\nacpi_backlight_dmi = type;\r\nif (acpi_video_get_backlight_type() != acpi_backlight_video)\r\nacpi_video_unregister_backlight();\r\n}\r\nvoid __exit acpi_video_detect_exit(void)\r\n{\r\nif (backlight_notifier_registered)\r\nbacklight_unregister_notifier(&backlight_nb);\r\n}

static irq_hw_number_t platform_msi_calc_hwirq(struct msi_desc *desc)\r\n{\r\nu32 devid;\r\ndevid = desc->platform.msi_priv_data->devid;\r\nreturn (devid << (32 - DEV_ID_SHIFT)) | desc->platform.msi_index;\r\n}\r\nstatic void platform_msi_set_desc(msi_alloc_info_t *arg, struct msi_desc *desc)\r\n{\r\narg->desc = desc;\r\narg->hwirq = platform_msi_calc_hwirq(desc);\r\n}\r\nstatic int platform_msi_init(struct irq_domain *domain,\r\nstruct msi_domain_info *info,\r\nunsigned int virq, irq_hw_number_t hwirq,\r\nmsi_alloc_info_t *arg)\r\n{\r\nreturn irq_domain_set_hwirq_and_chip(domain, virq, hwirq,\r\ninfo->chip, info->chip_data);\r\n}\r\nstatic void platform_msi_update_dom_ops(struct msi_domain_info *info)\r\n{\r\nstruct msi_domain_ops *ops = info->ops;\r\nBUG_ON(!ops);\r\nif (ops->msi_init == NULL)\r\nops->msi_init = platform_msi_init;\r\nif (ops->set_desc == NULL)\r\nops->set_desc = platform_msi_set_desc;\r\n}\r\nstatic void platform_msi_write_msg(struct irq_data *data, struct msi_msg *msg)\r\n{\r\nstruct msi_desc *desc = irq_data_get_msi_desc(data);\r\nstruct platform_msi_priv_data *priv_data;\r\npriv_data = desc->platform.msi_priv_data;\r\npriv_data->write_msg(desc, msg);\r\n}\r\nstatic void platform_msi_update_chip_ops(struct msi_domain_info *info)\r\n{\r\nstruct irq_chip *chip = info->chip;\r\nBUG_ON(!chip);\r\nif (!chip->irq_mask)\r\nchip->irq_mask = irq_chip_mask_parent;\r\nif (!chip->irq_unmask)\r\nchip->irq_unmask = irq_chip_unmask_parent;\r\nif (!chip->irq_eoi)\r\nchip->irq_eoi = irq_chip_eoi_parent;\r\nif (!chip->irq_set_affinity)\r\nchip->irq_set_affinity = msi_domain_set_affinity;\r\nif (!chip->irq_write_msi_msg)\r\nchip->irq_write_msi_msg = platform_msi_write_msg;\r\n}\r\nstatic void platform_msi_free_descs(struct device *dev, int base, int nvec)\r\n{\r\nstruct msi_desc *desc, *tmp;\r\nlist_for_each_entry_safe(desc, tmp, dev_to_msi_list(dev), list) {\r\nif (desc->platform.msi_index >= base &&\r\ndesc->platform.msi_index < (base + nvec)) {\r\nlist_del(&desc->list);\r\nfree_msi_entry(desc);\r\n}\r\n}\r\n}\r\nstatic int platform_msi_alloc_descs_with_irq(struct device *dev, int virq,\r\nint nvec,\r\nstruct platform_msi_priv_data *data)\r\n{\r\nstruct msi_desc *desc;\r\nint i, base = 0;\r\nif (!list_empty(dev_to_msi_list(dev))) {\r\ndesc = list_last_entry(dev_to_msi_list(dev),\r\nstruct msi_desc, list);\r\nbase = desc->platform.msi_index + 1;\r\n}\r\nfor (i = 0; i < nvec; i++) {\r\ndesc = alloc_msi_entry(dev);\r\nif (!desc)\r\nbreak;\r\ndesc->platform.msi_priv_data = data;\r\ndesc->platform.msi_index = base + i;\r\ndesc->nvec_used = 1;\r\ndesc->irq = virq ? virq + i : 0;\r\nlist_add_tail(&desc->list, dev_to_msi_list(dev));\r\n}\r\nif (i != nvec) {\r\nplatform_msi_free_descs(dev, base, nvec);\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nstatic int platform_msi_alloc_descs(struct device *dev, int nvec,\r\nstruct platform_msi_priv_data *data)\r\n{\r\nreturn platform_msi_alloc_descs_with_irq(dev, 0, nvec, data);\r\n}\r\nstruct irq_domain *platform_msi_create_irq_domain(struct fwnode_handle *fwnode,\r\nstruct msi_domain_info *info,\r\nstruct irq_domain *parent)\r\n{\r\nstruct irq_domain *domain;\r\nif (info->flags & MSI_FLAG_USE_DEF_DOM_OPS)\r\nplatform_msi_update_dom_ops(info);\r\nif (info->flags & MSI_FLAG_USE_DEF_CHIP_OPS)\r\nplatform_msi_update_chip_ops(info);\r\ndomain = msi_create_irq_domain(fwnode, info, parent);\r\nif (domain)\r\ndomain->bus_token = DOMAIN_BUS_PLATFORM_MSI;\r\nreturn domain;\r\n}\r\nstatic struct platform_msi_priv_data *\r\nplatform_msi_alloc_priv_data(struct device *dev, unsigned int nvec,\r\nirq_write_msi_msg_t write_msi_msg)\r\n{\r\nstruct platform_msi_priv_data *datap;\r\nif (!dev->msi_domain || !write_msi_msg || !nvec || nvec > MAX_DEV_MSIS)\r\nreturn ERR_PTR(-EINVAL);\r\nif (dev->msi_domain->bus_token != DOMAIN_BUS_PLATFORM_MSI) {\r\ndev_err(dev, "Incompatible msi_domain, giving up\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nif (!list_empty(dev_to_msi_list(dev)))\r\nreturn ERR_PTR(-EBUSY);\r\ndatap = kzalloc(sizeof(*datap), GFP_KERNEL);\r\nif (!datap)\r\nreturn ERR_PTR(-ENOMEM);\r\ndatap->devid = ida_simple_get(&platform_msi_devid_ida,\r\n0, 1 << DEV_ID_SHIFT, GFP_KERNEL);\r\nif (datap->devid < 0) {\r\nint err = datap->devid;\r\nkfree(datap);\r\nreturn ERR_PTR(err);\r\n}\r\ndatap->write_msg = write_msi_msg;\r\ndatap->dev = dev;\r\nreturn datap;\r\n}\r\nstatic void platform_msi_free_priv_data(struct platform_msi_priv_data *data)\r\n{\r\nida_simple_remove(&platform_msi_devid_ida, data->devid);\r\nkfree(data);\r\n}\r\nint platform_msi_domain_alloc_irqs(struct device *dev, unsigned int nvec,\r\nirq_write_msi_msg_t write_msi_msg)\r\n{\r\nstruct platform_msi_priv_data *priv_data;\r\nint err;\r\npriv_data = platform_msi_alloc_priv_data(dev, nvec, write_msi_msg);\r\nif (IS_ERR(priv_data))\r\nreturn PTR_ERR(priv_data);\r\nerr = platform_msi_alloc_descs(dev, nvec, priv_data);\r\nif (err)\r\ngoto out_free_priv_data;\r\nerr = msi_domain_alloc_irqs(dev->msi_domain, dev, nvec);\r\nif (err)\r\ngoto out_free_desc;\r\nreturn 0;\r\nout_free_desc:\r\nplatform_msi_free_descs(dev, 0, nvec);\r\nout_free_priv_data:\r\nplatform_msi_free_priv_data(priv_data);\r\nreturn err;\r\n}\r\nvoid platform_msi_domain_free_irqs(struct device *dev)\r\n{\r\nif (!list_empty(dev_to_msi_list(dev))) {\r\nstruct msi_desc *desc;\r\ndesc = first_msi_entry(dev);\r\nplatform_msi_free_priv_data(desc->platform.msi_priv_data);\r\n}\r\nmsi_domain_free_irqs(dev->msi_domain, dev);\r\nplatform_msi_free_descs(dev, 0, MAX_DEV_MSIS);\r\n}\r\nvoid *platform_msi_get_host_data(struct irq_domain *domain)\r\n{\r\nstruct platform_msi_priv_data *data = domain->host_data;\r\nreturn data->host_data;\r\n}\r\nstruct irq_domain *\r\nplatform_msi_create_device_domain(struct device *dev,\r\nunsigned int nvec,\r\nirq_write_msi_msg_t write_msi_msg,\r\nconst struct irq_domain_ops *ops,\r\nvoid *host_data)\r\n{\r\nstruct platform_msi_priv_data *data;\r\nstruct irq_domain *domain;\r\nint err;\r\ndata = platform_msi_alloc_priv_data(dev, nvec, write_msi_msg);\r\nif (IS_ERR(data))\r\nreturn NULL;\r\ndata->host_data = host_data;\r\ndomain = irq_domain_create_hierarchy(dev->msi_domain, 0, nvec,\r\nof_node_to_fwnode(dev->of_node),\r\nops, data);\r\nif (!domain)\r\ngoto free_priv;\r\nerr = msi_domain_prepare_irqs(domain->parent, dev, nvec, &data->arg);\r\nif (err)\r\ngoto free_domain;\r\nreturn domain;\r\nfree_domain:\r\nirq_domain_remove(domain);\r\nfree_priv:\r\nplatform_msi_free_priv_data(data);\r\nreturn NULL;\r\n}\r\nvoid platform_msi_domain_free(struct irq_domain *domain, unsigned int virq,\r\nunsigned int nvec)\r\n{\r\nstruct platform_msi_priv_data *data = domain->host_data;\r\nstruct msi_desc *desc;\r\nfor_each_msi_entry(desc, data->dev) {\r\nif (WARN_ON(!desc->irq || desc->nvec_used != 1))\r\nreturn;\r\nif (!(desc->irq >= virq && desc->irq < (virq + nvec)))\r\ncontinue;\r\nirq_domain_free_irqs_common(domain, desc->irq, 1);\r\n}\r\n}\r\nint platform_msi_domain_alloc(struct irq_domain *domain, unsigned int virq,\r\nunsigned int nr_irqs)\r\n{\r\nstruct platform_msi_priv_data *data = domain->host_data;\r\nint err;\r\nerr = platform_msi_alloc_descs_with_irq(data->dev, virq, nr_irqs, data);\r\nif (err)\r\nreturn err;\r\nerr = msi_domain_populate_irqs(domain->parent, data->dev,\r\nvirq, nr_irqs, &data->arg);\r\nif (err)\r\nplatform_msi_domain_free(domain, virq, nr_irqs);\r\nreturn err;\r\n}

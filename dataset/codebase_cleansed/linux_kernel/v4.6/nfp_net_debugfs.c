static int nfp_net_debugfs_rx_q_read(struct seq_file *file, void *data)\r\n{\r\nstruct nfp_net_rx_ring *rx_ring = file->private;\r\nint fl_rd_p, fl_wr_p, rx_rd_p, rx_wr_p, rxd_cnt;\r\nstruct nfp_net_rx_desc *rxd;\r\nstruct sk_buff *skb;\r\nstruct nfp_net *nn;\r\nint i;\r\nrtnl_lock();\r\nif (!rx_ring->r_vec || !rx_ring->r_vec->nfp_net)\r\ngoto out;\r\nnn = rx_ring->r_vec->nfp_net;\r\nif (!netif_running(nn->netdev))\r\ngoto out;\r\nrxd_cnt = rx_ring->cnt;\r\nfl_rd_p = nfp_qcp_rd_ptr_read(rx_ring->qcp_fl);\r\nfl_wr_p = nfp_qcp_wr_ptr_read(rx_ring->qcp_fl);\r\nrx_rd_p = nfp_qcp_rd_ptr_read(rx_ring->qcp_rx);\r\nrx_wr_p = nfp_qcp_wr_ptr_read(rx_ring->qcp_rx);\r\nseq_printf(file, "RX[%02d]: H_RD=%d H_WR=%d FL_RD=%d FL_WR=%d RX_RD=%d RX_WR=%d\n",\r\nrx_ring->idx, rx_ring->rd_p, rx_ring->wr_p,\r\nfl_rd_p, fl_wr_p, rx_rd_p, rx_wr_p);\r\nfor (i = 0; i < rxd_cnt; i++) {\r\nrxd = &rx_ring->rxds[i];\r\nseq_printf(file, "%04d: 0x%08x 0x%08x", i,\r\nrxd->vals[0], rxd->vals[1]);\r\nskb = READ_ONCE(rx_ring->rxbufs[i].skb);\r\nif (skb)\r\nseq_printf(file, " skb->head=%p skb->data=%p",\r\nskb->head, skb->data);\r\nif (rx_ring->rxbufs[i].dma_addr)\r\nseq_printf(file, " dma_addr=%pad",\r\n&rx_ring->rxbufs[i].dma_addr);\r\nif (i == rx_ring->rd_p % rxd_cnt)\r\nseq_puts(file, " H_RD ");\r\nif (i == rx_ring->wr_p % rxd_cnt)\r\nseq_puts(file, " H_WR ");\r\nif (i == fl_rd_p % rxd_cnt)\r\nseq_puts(file, " FL_RD");\r\nif (i == fl_wr_p % rxd_cnt)\r\nseq_puts(file, " FL_WR");\r\nif (i == rx_rd_p % rxd_cnt)\r\nseq_puts(file, " RX_RD");\r\nif (i == rx_wr_p % rxd_cnt)\r\nseq_puts(file, " RX_WR");\r\nseq_putc(file, '\n');\r\n}\r\nout:\r\nrtnl_unlock();\r\nreturn 0;\r\n}\r\nstatic int nfp_net_debugfs_rx_q_open(struct inode *inode, struct file *f)\r\n{\r\nreturn single_open(f, nfp_net_debugfs_rx_q_read, inode->i_private);\r\n}\r\nstatic int nfp_net_debugfs_tx_q_read(struct seq_file *file, void *data)\r\n{\r\nstruct nfp_net_tx_ring *tx_ring = file->private;\r\nstruct nfp_net_tx_desc *txd;\r\nint d_rd_p, d_wr_p, txd_cnt;\r\nstruct sk_buff *skb;\r\nstruct nfp_net *nn;\r\nint i;\r\nrtnl_lock();\r\nif (!tx_ring->r_vec || !tx_ring->r_vec->nfp_net)\r\ngoto out;\r\nnn = tx_ring->r_vec->nfp_net;\r\nif (!netif_running(nn->netdev))\r\ngoto out;\r\ntxd_cnt = tx_ring->cnt;\r\nd_rd_p = nfp_qcp_rd_ptr_read(tx_ring->qcp_q);\r\nd_wr_p = nfp_qcp_wr_ptr_read(tx_ring->qcp_q);\r\nseq_printf(file, "TX[%02d]: H_RD=%d H_WR=%d D_RD=%d D_WR=%d\n",\r\ntx_ring->idx, tx_ring->rd_p, tx_ring->wr_p, d_rd_p, d_wr_p);\r\nfor (i = 0; i < txd_cnt; i++) {\r\ntxd = &tx_ring->txds[i];\r\nseq_printf(file, "%04d: 0x%08x 0x%08x 0x%08x 0x%08x", i,\r\ntxd->vals[0], txd->vals[1],\r\ntxd->vals[2], txd->vals[3]);\r\nskb = READ_ONCE(tx_ring->txbufs[i].skb);\r\nif (skb)\r\nseq_printf(file, " skb->head=%p skb->data=%p",\r\nskb->head, skb->data);\r\nif (tx_ring->txbufs[i].dma_addr)\r\nseq_printf(file, " dma_addr=%pad",\r\n&tx_ring->txbufs[i].dma_addr);\r\nif (i == tx_ring->rd_p % txd_cnt)\r\nseq_puts(file, " H_RD");\r\nif (i == tx_ring->wr_p % txd_cnt)\r\nseq_puts(file, " H_WR");\r\nif (i == d_rd_p % txd_cnt)\r\nseq_puts(file, " D_RD");\r\nif (i == d_wr_p % txd_cnt)\r\nseq_puts(file, " D_WR");\r\nseq_putc(file, '\n');\r\n}\r\nout:\r\nrtnl_unlock();\r\nreturn 0;\r\n}\r\nstatic int nfp_net_debugfs_tx_q_open(struct inode *inode, struct file *f)\r\n{\r\nreturn single_open(f, nfp_net_debugfs_tx_q_read, inode->i_private);\r\n}\r\nvoid nfp_net_debugfs_adapter_add(struct nfp_net *nn)\r\n{\r\nstatic struct dentry *queues, *tx, *rx;\r\nchar int_name[16];\r\nint i;\r\nif (IS_ERR_OR_NULL(nfp_dir))\r\nreturn;\r\nnn->debugfs_dir = debugfs_create_dir(pci_name(nn->pdev), nfp_dir);\r\nif (IS_ERR_OR_NULL(nn->debugfs_dir))\r\nreturn;\r\nqueues = debugfs_create_dir("queue", nn->debugfs_dir);\r\nif (IS_ERR_OR_NULL(nn->debugfs_dir))\r\nreturn;\r\nrx = debugfs_create_dir("rx", queues);\r\ntx = debugfs_create_dir("tx", queues);\r\nif (IS_ERR_OR_NULL(rx) || IS_ERR_OR_NULL(tx))\r\nreturn;\r\nfor (i = 0; i < nn->num_rx_rings; i++) {\r\nsprintf(int_name, "%d", i);\r\ndebugfs_create_file(int_name, S_IRUSR, rx,\r\n&nn->rx_rings[i], &nfp_rx_q_fops);\r\n}\r\nfor (i = 0; i < nn->num_tx_rings; i++) {\r\nsprintf(int_name, "%d", i);\r\ndebugfs_create_file(int_name, S_IRUSR, tx,\r\n&nn->tx_rings[i], &nfp_tx_q_fops);\r\n}\r\n}\r\nvoid nfp_net_debugfs_adapter_del(struct nfp_net *nn)\r\n{\r\ndebugfs_remove_recursive(nn->debugfs_dir);\r\nnn->debugfs_dir = NULL;\r\n}\r\nvoid nfp_net_debugfs_create(void)\r\n{\r\nnfp_dir = debugfs_create_dir("nfp_net", NULL);\r\n}\r\nvoid nfp_net_debugfs_destroy(void)\r\n{\r\ndebugfs_remove_recursive(nfp_dir);\r\nnfp_dir = NULL;\r\n}

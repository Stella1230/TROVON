int amdgpu_align_pitch(struct amdgpu_device *adev, int width, int bpp, bool tiled)\r\n{\r\nint aligned = width;\r\nint pitch_mask = 0;\r\nswitch (bpp / 8) {\r\ncase 1:\r\npitch_mask = 255;\r\nbreak;\r\ncase 2:\r\npitch_mask = 127;\r\nbreak;\r\ncase 3:\r\ncase 4:\r\npitch_mask = 63;\r\nbreak;\r\n}\r\naligned += pitch_mask;\r\naligned &= ~pitch_mask;\r\nreturn aligned;\r\n}\r\nstatic void amdgpufb_destroy_pinned_object(struct drm_gem_object *gobj)\r\n{\r\nstruct amdgpu_bo *rbo = gem_to_amdgpu_bo(gobj);\r\nint ret;\r\nret = amdgpu_bo_reserve(rbo, false);\r\nif (likely(ret == 0)) {\r\namdgpu_bo_kunmap(rbo);\r\namdgpu_bo_unpin(rbo);\r\namdgpu_bo_unreserve(rbo);\r\n}\r\ndrm_gem_object_unreference_unlocked(gobj);\r\n}\r\nstatic int amdgpufb_create_pinned_object(struct amdgpu_fbdev *rfbdev,\r\nstruct drm_mode_fb_cmd2 *mode_cmd,\r\nstruct drm_gem_object **gobj_p)\r\n{\r\nstruct amdgpu_device *adev = rfbdev->adev;\r\nstruct drm_gem_object *gobj = NULL;\r\nstruct amdgpu_bo *rbo = NULL;\r\nbool fb_tiled = false;\r\nu32 tiling_flags = 0;\r\nint ret;\r\nint aligned_size, size;\r\nint height = mode_cmd->height;\r\nu32 bpp, depth;\r\ndrm_fb_get_bpp_depth(mode_cmd->pixel_format, &depth, &bpp);\r\nmode_cmd->pitches[0] = amdgpu_align_pitch(adev, mode_cmd->width, bpp,\r\nfb_tiled) * ((bpp + 1) / 8);\r\nheight = ALIGN(mode_cmd->height, 8);\r\nsize = mode_cmd->pitches[0] * height;\r\naligned_size = ALIGN(size, PAGE_SIZE);\r\nret = amdgpu_gem_object_create(adev, aligned_size, 0,\r\nAMDGPU_GEM_DOMAIN_VRAM,\r\nAMDGPU_GEM_CREATE_CPU_ACCESS_REQUIRED,\r\ntrue, &gobj);\r\nif (ret) {\r\nprintk(KERN_ERR "failed to allocate framebuffer (%d)\n",\r\naligned_size);\r\nreturn -ENOMEM;\r\n}\r\nrbo = gem_to_amdgpu_bo(gobj);\r\nif (fb_tiled)\r\ntiling_flags = AMDGPU_TILING_SET(ARRAY_MODE, GRPH_ARRAY_2D_TILED_THIN1);\r\nret = amdgpu_bo_reserve(rbo, false);\r\nif (unlikely(ret != 0))\r\ngoto out_unref;\r\nif (tiling_flags) {\r\nret = amdgpu_bo_set_tiling_flags(rbo,\r\ntiling_flags);\r\nif (ret)\r\ndev_err(adev->dev, "FB failed to set tiling flags\n");\r\n}\r\nret = amdgpu_bo_pin_restricted(rbo, AMDGPU_GEM_DOMAIN_VRAM, 0, 0, NULL);\r\nif (ret) {\r\namdgpu_bo_unreserve(rbo);\r\ngoto out_unref;\r\n}\r\nret = amdgpu_bo_kmap(rbo, NULL);\r\namdgpu_bo_unreserve(rbo);\r\nif (ret) {\r\ngoto out_unref;\r\n}\r\n*gobj_p = gobj;\r\nreturn 0;\r\nout_unref:\r\namdgpufb_destroy_pinned_object(gobj);\r\n*gobj_p = NULL;\r\nreturn ret;\r\n}\r\nstatic int amdgpufb_create(struct drm_fb_helper *helper,\r\nstruct drm_fb_helper_surface_size *sizes)\r\n{\r\nstruct amdgpu_fbdev *rfbdev = (struct amdgpu_fbdev *)helper;\r\nstruct amdgpu_device *adev = rfbdev->adev;\r\nstruct fb_info *info;\r\nstruct drm_framebuffer *fb = NULL;\r\nstruct drm_mode_fb_cmd2 mode_cmd;\r\nstruct drm_gem_object *gobj = NULL;\r\nstruct amdgpu_bo *rbo = NULL;\r\nint ret;\r\nunsigned long tmp;\r\nmode_cmd.width = sizes->surface_width;\r\nmode_cmd.height = sizes->surface_height;\r\nif (sizes->surface_bpp == 24)\r\nsizes->surface_bpp = 32;\r\nmode_cmd.pixel_format = drm_mode_legacy_fb_format(sizes->surface_bpp,\r\nsizes->surface_depth);\r\nret = amdgpufb_create_pinned_object(rfbdev, &mode_cmd, &gobj);\r\nif (ret) {\r\nDRM_ERROR("failed to create fbcon object %d\n", ret);\r\nreturn ret;\r\n}\r\nrbo = gem_to_amdgpu_bo(gobj);\r\ninfo = drm_fb_helper_alloc_fbi(helper);\r\nif (IS_ERR(info)) {\r\nret = PTR_ERR(info);\r\ngoto out_unref;\r\n}\r\ninfo->par = rfbdev;\r\ninfo->skip_vt_switch = true;\r\nret = amdgpu_framebuffer_init(adev->ddev, &rfbdev->rfb, &mode_cmd, gobj);\r\nif (ret) {\r\nDRM_ERROR("failed to initialize framebuffer %d\n", ret);\r\ngoto out_destroy_fbi;\r\n}\r\nfb = &rfbdev->rfb.base;\r\nrfbdev->helper.fb = fb;\r\nmemset_io(rbo->kptr, 0x0, amdgpu_bo_size(rbo));\r\nstrcpy(info->fix.id, "amdgpudrmfb");\r\ndrm_fb_helper_fill_fix(info, fb->pitches[0], fb->depth);\r\ninfo->flags = FBINFO_DEFAULT | FBINFO_CAN_FORCE_OUTPUT;\r\ninfo->fbops = &amdgpufb_ops;\r\ntmp = amdgpu_bo_gpu_offset(rbo) - adev->mc.vram_start;\r\ninfo->fix.smem_start = adev->mc.aper_base + tmp;\r\ninfo->fix.smem_len = amdgpu_bo_size(rbo);\r\ninfo->screen_base = rbo->kptr;\r\ninfo->screen_size = amdgpu_bo_size(rbo);\r\ndrm_fb_helper_fill_var(info, &rfbdev->helper, sizes->fb_width, sizes->fb_height);\r\ninfo->apertures->ranges[0].base = adev->ddev->mode_config.fb_base;\r\ninfo->apertures->ranges[0].size = adev->mc.aper_size;\r\nif (info->screen_base == NULL) {\r\nret = -ENOSPC;\r\ngoto out_destroy_fbi;\r\n}\r\nDRM_INFO("fb mappable at 0x%lX\n", info->fix.smem_start);\r\nDRM_INFO("vram apper at 0x%lX\n", (unsigned long)adev->mc.aper_base);\r\nDRM_INFO("size %lu\n", (unsigned long)amdgpu_bo_size(rbo));\r\nDRM_INFO("fb depth is %d\n", fb->depth);\r\nDRM_INFO(" pitch is %d\n", fb->pitches[0]);\r\nvga_switcheroo_client_fb_set(adev->ddev->pdev, info);\r\nreturn 0;\r\nout_destroy_fbi:\r\ndrm_fb_helper_release_fbi(helper);\r\nout_unref:\r\nif (rbo) {\r\n}\r\nif (fb && ret) {\r\ndrm_gem_object_unreference_unlocked(gobj);\r\ndrm_framebuffer_unregister_private(fb);\r\ndrm_framebuffer_cleanup(fb);\r\nkfree(fb);\r\n}\r\nreturn ret;\r\n}\r\nvoid amdgpu_fb_output_poll_changed(struct amdgpu_device *adev)\r\n{\r\nif (adev->mode_info.rfbdev)\r\ndrm_fb_helper_hotplug_event(&adev->mode_info.rfbdev->helper);\r\n}\r\nstatic int amdgpu_fbdev_destroy(struct drm_device *dev, struct amdgpu_fbdev *rfbdev)\r\n{\r\nstruct amdgpu_framebuffer *rfb = &rfbdev->rfb;\r\ndrm_fb_helper_unregister_fbi(&rfbdev->helper);\r\ndrm_fb_helper_release_fbi(&rfbdev->helper);\r\nif (rfb->obj) {\r\namdgpufb_destroy_pinned_object(rfb->obj);\r\nrfb->obj = NULL;\r\n}\r\ndrm_fb_helper_fini(&rfbdev->helper);\r\ndrm_framebuffer_unregister_private(&rfb->base);\r\ndrm_framebuffer_cleanup(&rfb->base);\r\nreturn 0;\r\n}\r\nstatic void amdgpu_crtc_fb_gamma_set(struct drm_crtc *crtc, u16 red, u16 green,\r\nu16 blue, int regno)\r\n{\r\nstruct amdgpu_crtc *amdgpu_crtc = to_amdgpu_crtc(crtc);\r\namdgpu_crtc->lut_r[regno] = red >> 6;\r\namdgpu_crtc->lut_g[regno] = green >> 6;\r\namdgpu_crtc->lut_b[regno] = blue >> 6;\r\n}\r\nstatic void amdgpu_crtc_fb_gamma_get(struct drm_crtc *crtc, u16 *red, u16 *green,\r\nu16 *blue, int regno)\r\n{\r\nstruct amdgpu_crtc *amdgpu_crtc = to_amdgpu_crtc(crtc);\r\n*red = amdgpu_crtc->lut_r[regno] << 6;\r\n*green = amdgpu_crtc->lut_g[regno] << 6;\r\n*blue = amdgpu_crtc->lut_b[regno] << 6;\r\n}\r\nint amdgpu_fbdev_init(struct amdgpu_device *adev)\r\n{\r\nstruct amdgpu_fbdev *rfbdev;\r\nint bpp_sel = 32;\r\nint ret;\r\nif (!adev->mode_info.mode_config_initialized)\r\nreturn 0;\r\nif (list_empty(&adev->ddev->mode_config.connector_list))\r\nreturn 0;\r\nif (adev->mc.real_vram_size <= (32*1024*1024))\r\nbpp_sel = 8;\r\nrfbdev = kzalloc(sizeof(struct amdgpu_fbdev), GFP_KERNEL);\r\nif (!rfbdev)\r\nreturn -ENOMEM;\r\nrfbdev->adev = adev;\r\nadev->mode_info.rfbdev = rfbdev;\r\ndrm_fb_helper_prepare(adev->ddev, &rfbdev->helper,\r\n&amdgpu_fb_helper_funcs);\r\nret = drm_fb_helper_init(adev->ddev, &rfbdev->helper,\r\nadev->mode_info.num_crtc,\r\nAMDGPUFB_CONN_LIMIT);\r\nif (ret) {\r\nkfree(rfbdev);\r\nreturn ret;\r\n}\r\ndrm_fb_helper_single_add_all_connectors(&rfbdev->helper);\r\ndrm_helper_disable_unused_functions(adev->ddev);\r\ndrm_fb_helper_initial_config(&rfbdev->helper, bpp_sel);\r\nreturn 0;\r\n}\r\nvoid amdgpu_fbdev_fini(struct amdgpu_device *adev)\r\n{\r\nif (!adev->mode_info.rfbdev)\r\nreturn;\r\namdgpu_fbdev_destroy(adev->ddev, adev->mode_info.rfbdev);\r\nkfree(adev->mode_info.rfbdev);\r\nadev->mode_info.rfbdev = NULL;\r\n}\r\nvoid amdgpu_fbdev_set_suspend(struct amdgpu_device *adev, int state)\r\n{\r\nif (adev->mode_info.rfbdev)\r\ndrm_fb_helper_set_suspend(&adev->mode_info.rfbdev->helper,\r\nstate);\r\n}\r\nint amdgpu_fbdev_total_size(struct amdgpu_device *adev)\r\n{\r\nstruct amdgpu_bo *robj;\r\nint size = 0;\r\nif (!adev->mode_info.rfbdev)\r\nreturn 0;\r\nrobj = gem_to_amdgpu_bo(adev->mode_info.rfbdev->rfb.obj);\r\nsize += amdgpu_bo_size(robj);\r\nreturn size;\r\n}\r\nbool amdgpu_fbdev_robj_is_fb(struct amdgpu_device *adev, struct amdgpu_bo *robj)\r\n{\r\nif (!adev->mode_info.rfbdev)\r\nreturn false;\r\nif (robj == gem_to_amdgpu_bo(adev->mode_info.rfbdev->rfb.obj))\r\nreturn true;\r\nreturn false;\r\n}\r\nvoid amdgpu_fbdev_restore_mode(struct amdgpu_device *adev)\r\n{\r\nstruct amdgpu_fbdev *afbdev = adev->mode_info.rfbdev;\r\nstruct drm_fb_helper *fb_helper;\r\nint ret;\r\nif (!afbdev)\r\nreturn;\r\nfb_helper = &afbdev->helper;\r\nret = drm_fb_helper_restore_fbdev_mode_unlocked(fb_helper);\r\nif (ret)\r\nDRM_DEBUG("failed to restore crtc mode\n");\r\n}

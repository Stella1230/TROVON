struct mpc8xxx_spi_probe_info *to_of_pinfo(struct fsl_spi_platform_data *pdata)\r\n{\r\nreturn container_of(pdata, struct mpc8xxx_spi_probe_info, pdata);\r\n}\r\nconst char *mpc8xxx_spi_strmode(unsigned int flags)\r\n{\r\nif (flags & SPI_QE_CPU_MODE) {\r\nreturn "QE CPU";\r\n} else if (flags & SPI_CPM_MODE) {\r\nif (flags & SPI_QE)\r\nreturn "QE";\r\nelse if (flags & SPI_CPM2)\r\nreturn "CPM2";\r\nelse\r\nreturn "CPM1";\r\n}\r\nreturn "CPU";\r\n}\r\nvoid mpc8xxx_spi_probe(struct device *dev, struct resource *mem,\r\nunsigned int irq)\r\n{\r\nstruct fsl_spi_platform_data *pdata = dev_get_platdata(dev);\r\nstruct spi_master *master;\r\nstruct mpc8xxx_spi *mpc8xxx_spi;\r\nmaster = dev_get_drvdata(dev);\r\nmaster->mode_bits = SPI_CPOL | SPI_CPHA | SPI_CS_HIGH\r\n| SPI_LSB_FIRST | SPI_LOOP;\r\nmaster->dev.of_node = dev->of_node;\r\nmpc8xxx_spi = spi_master_get_devdata(master);\r\nmpc8xxx_spi->dev = dev;\r\nmpc8xxx_spi->get_rx = mpc8xxx_spi_rx_buf_u8;\r\nmpc8xxx_spi->get_tx = mpc8xxx_spi_tx_buf_u8;\r\nmpc8xxx_spi->flags = pdata->flags;\r\nmpc8xxx_spi->spibrg = pdata->sysclk;\r\nmpc8xxx_spi->irq = irq;\r\nmpc8xxx_spi->rx_shift = 0;\r\nmpc8xxx_spi->tx_shift = 0;\r\nmaster->bus_num = pdata->bus_num;\r\nmaster->num_chipselect = pdata->max_chipselect;\r\ninit_completion(&mpc8xxx_spi->done);\r\n}\r\nint of_mpc8xxx_spi_probe(struct platform_device *ofdev)\r\n{\r\nstruct device *dev = &ofdev->dev;\r\nstruct device_node *np = ofdev->dev.of_node;\r\nstruct mpc8xxx_spi_probe_info *pinfo;\r\nstruct fsl_spi_platform_data *pdata;\r\nconst void *prop;\r\nint ret = -ENOMEM;\r\npinfo = devm_kzalloc(&ofdev->dev, sizeof(*pinfo), GFP_KERNEL);\r\nif (!pinfo)\r\nreturn ret;\r\npdata = &pinfo->pdata;\r\ndev->platform_data = pdata;\r\npdata->bus_num = -1;\r\n#ifdef CONFIG_FSL_SOC\r\npdata->sysclk = get_brgfreq();\r\nif (pdata->sysclk == -1) {\r\npdata->sysclk = fsl_get_sys_freq();\r\nif (pdata->sysclk == -1)\r\nreturn -ENODEV;\r\n}\r\n#else\r\nret = of_property_read_u32(np, "clock-frequency", &pdata->sysclk);\r\nif (ret)\r\nreturn ret;\r\n#endif\r\nprop = of_get_property(np, "mode", NULL);\r\nif (prop && !strcmp(prop, "cpu-qe"))\r\npdata->flags = SPI_QE_CPU_MODE;\r\nelse if (prop && !strcmp(prop, "qe"))\r\npdata->flags = SPI_CPM_MODE | SPI_QE;\r\nelse if (of_device_is_compatible(np, "fsl,cpm2-spi"))\r\npdata->flags = SPI_CPM_MODE | SPI_CPM2;\r\nelse if (of_device_is_compatible(np, "fsl,cpm1-spi"))\r\npdata->flags = SPI_CPM_MODE | SPI_CPM1;\r\nreturn 0;\r\n}

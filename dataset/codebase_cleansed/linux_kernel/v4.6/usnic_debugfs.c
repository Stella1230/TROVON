static ssize_t usnic_debugfs_buildinfo_read(struct file *f, char __user *data,\r\nsize_t count, loff_t *ppos)\r\n{\r\nchar buf[500];\r\nint res;\r\nif (*ppos > 0)\r\nreturn 0;\r\nres = scnprintf(buf, sizeof(buf),\r\n"version: %s\n"\r\n"build date: %s\n",\r\nDRV_VERSION, DRV_RELDATE);\r\nreturn simple_read_from_buffer(data, count, ppos, buf, res);\r\n}\r\nstatic ssize_t flowinfo_read(struct file *f, char __user *data,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct usnic_ib_qp_grp_flow *qp_flow;\r\nint n;\r\nint left;\r\nchar *ptr;\r\nchar buf[512];\r\nqp_flow = f->private_data;\r\nptr = buf;\r\nleft = count;\r\nif (*ppos > 0)\r\nreturn 0;\r\nspin_lock(&qp_flow->qp_grp->lock);\r\nn = scnprintf(ptr, left,\r\n"QP Grp ID: %d Transport: %s ",\r\nqp_flow->qp_grp->grp_id,\r\nusnic_transport_to_str(qp_flow->trans_type));\r\nUPDATE_PTR_LEFT(n, ptr, left);\r\nif (qp_flow->trans_type == USNIC_TRANSPORT_ROCE_CUSTOM) {\r\nn = scnprintf(ptr, left, "Port_Num:%hu\n",\r\nqp_flow->usnic_roce.port_num);\r\nUPDATE_PTR_LEFT(n, ptr, left);\r\n} else if (qp_flow->trans_type == USNIC_TRANSPORT_IPV4_UDP) {\r\nn = usnic_transport_sock_to_str(ptr, left,\r\nqp_flow->udp.sock);\r\nUPDATE_PTR_LEFT(n, ptr, left);\r\nn = scnprintf(ptr, left, "\n");\r\nUPDATE_PTR_LEFT(n, ptr, left);\r\n}\r\nspin_unlock(&qp_flow->qp_grp->lock);\r\nreturn simple_read_from_buffer(data, count, ppos, buf, ptr - buf);\r\n}\r\nvoid usnic_debugfs_init(void)\r\n{\r\ndebugfs_root = debugfs_create_dir(DRV_NAME, NULL);\r\nif (IS_ERR(debugfs_root)) {\r\nusnic_err("Failed to create debugfs root dir, check if debugfs is enabled in kernel configuration\n");\r\ngoto out_clear_root;\r\n}\r\nflows_dentry = debugfs_create_dir("flows", debugfs_root);\r\nif (IS_ERR_OR_NULL(flows_dentry)) {\r\nusnic_err("Failed to create debugfs flow dir with err %ld\n",\r\nPTR_ERR(flows_dentry));\r\ngoto out_free_root;\r\n}\r\ndebugfs_create_file("build-info", S_IRUGO, debugfs_root,\r\nNULL, &usnic_debugfs_buildinfo_ops);\r\nreturn;\r\nout_free_root:\r\ndebugfs_remove_recursive(debugfs_root);\r\nout_clear_root:\r\ndebugfs_root = NULL;\r\n}\r\nvoid usnic_debugfs_exit(void)\r\n{\r\nif (!debugfs_root)\r\nreturn;\r\ndebugfs_remove_recursive(debugfs_root);\r\ndebugfs_root = NULL;\r\n}\r\nvoid usnic_debugfs_flow_add(struct usnic_ib_qp_grp_flow *qp_flow)\r\n{\r\nif (IS_ERR_OR_NULL(flows_dentry))\r\nreturn;\r\nscnprintf(qp_flow->dentry_name, sizeof(qp_flow->dentry_name),\r\n"%u", qp_flow->flow->flow_id);\r\nqp_flow->dbgfs_dentry = debugfs_create_file(qp_flow->dentry_name,\r\nS_IRUGO,\r\nflows_dentry,\r\nqp_flow,\r\n&flowinfo_ops);\r\nif (IS_ERR_OR_NULL(qp_flow->dbgfs_dentry)) {\r\nusnic_err("Failed to create dbg fs entry for flow %u with error %ld\n",\r\nqp_flow->flow->flow_id,\r\nPTR_ERR(qp_flow->dbgfs_dentry));\r\n}\r\n}\r\nvoid usnic_debugfs_flow_remove(struct usnic_ib_qp_grp_flow *qp_flow)\r\n{\r\nif (!IS_ERR_OR_NULL(qp_flow->dbgfs_dentry))\r\ndebugfs_remove(qp_flow->dbgfs_dentry);\r\n}

static void\r\n_mpt3sas_raise_sigio(struct MPT3SAS_ADAPTER *ioc,\r\nstruct SL_WH_TRIGGERS_EVENT_DATA_T *event_data)\r\n{\r\nMpi2EventNotificationReply_t *mpi_reply;\r\nu16 sz, event_data_sz;\r\nunsigned long flags;\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT "%s: enter\n",\r\nioc->name, __func__));\r\nsz = offsetof(Mpi2EventNotificationReply_t, EventData) +\r\nsizeof(struct SL_WH_TRIGGERS_EVENT_DATA_T) + 4;\r\nmpi_reply = kzalloc(sz, GFP_KERNEL);\r\nif (!mpi_reply)\r\ngoto out;\r\nmpi_reply->Event = cpu_to_le16(MPI3_EVENT_DIAGNOSTIC_TRIGGER_FIRED);\r\nevent_data_sz = (sizeof(struct SL_WH_TRIGGERS_EVENT_DATA_T) + 4) / 4;\r\nmpi_reply->EventDataLength = cpu_to_le16(event_data_sz);\r\nmemcpy(&mpi_reply->EventData, event_data,\r\nsizeof(struct SL_WH_TRIGGERS_EVENT_DATA_T));\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT\r\n"%s: add to driver event log\n",\r\nioc->name, __func__));\r\nmpt3sas_ctl_add_to_event_log(ioc, mpi_reply);\r\nkfree(mpi_reply);\r\nout:\r\nspin_lock_irqsave(&ioc->diag_trigger_lock, flags);\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT\r\n"%s: clearing diag_trigger_active flag\n",\r\nioc->name, __func__));\r\nioc->diag_trigger_active = 0;\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT "%s: exit\n", ioc->name,\r\n__func__));\r\n}\r\nvoid\r\nmpt3sas_process_trigger_data(struct MPT3SAS_ADAPTER *ioc,\r\nstruct SL_WH_TRIGGERS_EVENT_DATA_T *event_data)\r\n{\r\nu8 issue_reset = 0;\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT "%s: enter\n",\r\nioc->name, __func__));\r\nif ((ioc->diag_buffer_status[MPI2_DIAG_BUF_TYPE_TRACE] &\r\nMPT3_DIAG_BUFFER_IS_RELEASED) == 0) {\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT\r\n"%s: release trace diag buffer\n", ioc->name, __func__));\r\nmpt3sas_send_diag_release(ioc, MPI2_DIAG_BUF_TYPE_TRACE,\r\n&issue_reset);\r\n}\r\n_mpt3sas_raise_sigio(ioc, event_data);\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT "%s: exit\n", ioc->name,\r\n__func__));\r\n}\r\nvoid\r\nmpt3sas_trigger_master(struct MPT3SAS_ADAPTER *ioc, u32 trigger_bitmask)\r\n{\r\nstruct SL_WH_TRIGGERS_EVENT_DATA_T event_data;\r\nunsigned long flags;\r\nu8 found_match = 0;\r\nspin_lock_irqsave(&ioc->diag_trigger_lock, flags);\r\nif (trigger_bitmask & MASTER_TRIGGER_FW_FAULT ||\r\ntrigger_bitmask & MASTER_TRIGGER_ADAPTER_RESET)\r\ngoto by_pass_checks;\r\nif ((ioc->diag_buffer_status[MPI2_DIAG_BUF_TYPE_TRACE] &\r\nMPT3_DIAG_BUFFER_IS_REGISTERED) == 0) {\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\nreturn;\r\n}\r\nif (ioc->diag_buffer_status[MPI2_DIAG_BUF_TYPE_TRACE] &\r\nMPT3_DIAG_BUFFER_IS_RELEASED) {\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\nreturn;\r\n}\r\nby_pass_checks:\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT\r\n"%s: enter - trigger_bitmask = 0x%08x\n",\r\nioc->name, __func__, trigger_bitmask));\r\nif (ioc->diag_trigger_active) {\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\ngoto out;\r\n}\r\nif (ioc->diag_trigger_master.MasterData & trigger_bitmask) {\r\nfound_match = 1;\r\nioc->diag_trigger_active = 1;\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT\r\n"%s: setting diag_trigger_active flag\n",\r\nioc->name, __func__));\r\n}\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\nif (!found_match)\r\ngoto out;\r\nmemset(&event_data, 0, sizeof(struct SL_WH_TRIGGERS_EVENT_DATA_T));\r\nevent_data.trigger_type = MPT3SAS_TRIGGER_MASTER;\r\nevent_data.u.master.MasterData = trigger_bitmask;\r\nif (trigger_bitmask & MASTER_TRIGGER_FW_FAULT ||\r\ntrigger_bitmask & MASTER_TRIGGER_ADAPTER_RESET)\r\n_mpt3sas_raise_sigio(ioc, &event_data);\r\nelse\r\nmpt3sas_send_trigger_data_event(ioc, &event_data);\r\nout:\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT "%s: exit\n", ioc->name,\r\n__func__));\r\n}\r\nvoid\r\nmpt3sas_trigger_event(struct MPT3SAS_ADAPTER *ioc, u16 event,\r\nu16 log_entry_qualifier)\r\n{\r\nstruct SL_WH_TRIGGERS_EVENT_DATA_T event_data;\r\nstruct SL_WH_EVENT_TRIGGER_T *event_trigger;\r\nint i;\r\nunsigned long flags;\r\nu8 found_match;\r\nspin_lock_irqsave(&ioc->diag_trigger_lock, flags);\r\nif ((ioc->diag_buffer_status[MPI2_DIAG_BUF_TYPE_TRACE] &\r\nMPT3_DIAG_BUFFER_IS_REGISTERED) == 0) {\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\nreturn;\r\n}\r\nif (ioc->diag_buffer_status[MPI2_DIAG_BUF_TYPE_TRACE] &\r\nMPT3_DIAG_BUFFER_IS_RELEASED) {\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\nreturn;\r\n}\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT\r\n"%s: enter - event = 0x%04x, log_entry_qualifier = 0x%04x\n",\r\nioc->name, __func__, event, log_entry_qualifier));\r\nif (ioc->diag_trigger_active) {\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\ngoto out;\r\n}\r\nevent_trigger = ioc->diag_trigger_event.EventTriggerEntry;\r\nfor (i = 0 , found_match = 0; i < ioc->diag_trigger_event.ValidEntries\r\n&& !found_match; i++, event_trigger++) {\r\nif (event_trigger->EventValue != event)\r\ncontinue;\r\nif (event == MPI2_EVENT_LOG_ENTRY_ADDED) {\r\nif (event_trigger->LogEntryQualifier ==\r\nlog_entry_qualifier)\r\nfound_match = 1;\r\ncontinue;\r\n}\r\nfound_match = 1;\r\nioc->diag_trigger_active = 1;\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT\r\n"%s: setting diag_trigger_active flag\n",\r\nioc->name, __func__));\r\n}\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\nif (!found_match)\r\ngoto out;\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT\r\n"%s: setting diag_trigger_active flag\n",\r\nioc->name, __func__));\r\nmemset(&event_data, 0, sizeof(struct SL_WH_TRIGGERS_EVENT_DATA_T));\r\nevent_data.trigger_type = MPT3SAS_TRIGGER_EVENT;\r\nevent_data.u.event.EventValue = event;\r\nevent_data.u.event.LogEntryQualifier = log_entry_qualifier;\r\nmpt3sas_send_trigger_data_event(ioc, &event_data);\r\nout:\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT "%s: exit\n", ioc->name,\r\n__func__));\r\n}\r\nvoid\r\nmpt3sas_trigger_scsi(struct MPT3SAS_ADAPTER *ioc, u8 sense_key, u8 asc,\r\nu8 ascq)\r\n{\r\nstruct SL_WH_TRIGGERS_EVENT_DATA_T event_data;\r\nstruct SL_WH_SCSI_TRIGGER_T *scsi_trigger;\r\nint i;\r\nunsigned long flags;\r\nu8 found_match;\r\nspin_lock_irqsave(&ioc->diag_trigger_lock, flags);\r\nif ((ioc->diag_buffer_status[MPI2_DIAG_BUF_TYPE_TRACE] &\r\nMPT3_DIAG_BUFFER_IS_REGISTERED) == 0) {\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\nreturn;\r\n}\r\nif (ioc->diag_buffer_status[MPI2_DIAG_BUF_TYPE_TRACE] &\r\nMPT3_DIAG_BUFFER_IS_RELEASED) {\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\nreturn;\r\n}\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT\r\n"%s: enter - sense_key = 0x%02x, asc = 0x%02x, ascq = 0x%02x\n",\r\nioc->name, __func__, sense_key, asc, ascq));\r\nif (ioc->diag_trigger_active) {\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\ngoto out;\r\n}\r\nscsi_trigger = ioc->diag_trigger_scsi.SCSITriggerEntry;\r\nfor (i = 0 , found_match = 0; i < ioc->diag_trigger_scsi.ValidEntries\r\n&& !found_match; i++, scsi_trigger++) {\r\nif (scsi_trigger->SenseKey != sense_key)\r\ncontinue;\r\nif (!(scsi_trigger->ASC == 0xFF || scsi_trigger->ASC == asc))\r\ncontinue;\r\nif (!(scsi_trigger->ASCQ == 0xFF || scsi_trigger->ASCQ == ascq))\r\ncontinue;\r\nfound_match = 1;\r\nioc->diag_trigger_active = 1;\r\n}\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\nif (!found_match)\r\ngoto out;\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT\r\n"%s: setting diag_trigger_active flag\n",\r\nioc->name, __func__));\r\nmemset(&event_data, 0, sizeof(struct SL_WH_TRIGGERS_EVENT_DATA_T));\r\nevent_data.trigger_type = MPT3SAS_TRIGGER_SCSI;\r\nevent_data.u.scsi.SenseKey = sense_key;\r\nevent_data.u.scsi.ASC = asc;\r\nevent_data.u.scsi.ASCQ = ascq;\r\nmpt3sas_send_trigger_data_event(ioc, &event_data);\r\nout:\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT "%s: exit\n", ioc->name,\r\n__func__));\r\n}\r\nvoid\r\nmpt3sas_trigger_mpi(struct MPT3SAS_ADAPTER *ioc, u16 ioc_status, u32 loginfo)\r\n{\r\nstruct SL_WH_TRIGGERS_EVENT_DATA_T event_data;\r\nstruct SL_WH_MPI_TRIGGER_T *mpi_trigger;\r\nint i;\r\nunsigned long flags;\r\nu8 found_match;\r\nspin_lock_irqsave(&ioc->diag_trigger_lock, flags);\r\nif ((ioc->diag_buffer_status[MPI2_DIAG_BUF_TYPE_TRACE] &\r\nMPT3_DIAG_BUFFER_IS_REGISTERED) == 0) {\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\nreturn;\r\n}\r\nif (ioc->diag_buffer_status[MPI2_DIAG_BUF_TYPE_TRACE] &\r\nMPT3_DIAG_BUFFER_IS_RELEASED) {\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\nreturn;\r\n}\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT\r\n"%s: enter - ioc_status = 0x%04x, loginfo = 0x%08x\n",\r\nioc->name, __func__, ioc_status, loginfo));\r\nif (ioc->diag_trigger_active) {\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\ngoto out;\r\n}\r\nmpi_trigger = ioc->diag_trigger_mpi.MPITriggerEntry;\r\nfor (i = 0 , found_match = 0; i < ioc->diag_trigger_mpi.ValidEntries\r\n&& !found_match; i++, mpi_trigger++) {\r\nif (mpi_trigger->IOCStatus != ioc_status)\r\ncontinue;\r\nif (!(mpi_trigger->IocLogInfo == 0xFFFFFFFF ||\r\nmpi_trigger->IocLogInfo == loginfo))\r\ncontinue;\r\nfound_match = 1;\r\nioc->diag_trigger_active = 1;\r\n}\r\nspin_unlock_irqrestore(&ioc->diag_trigger_lock, flags);\r\nif (!found_match)\r\ngoto out;\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT\r\n"%s: setting diag_trigger_active flag\n",\r\nioc->name, __func__));\r\nmemset(&event_data, 0, sizeof(struct SL_WH_TRIGGERS_EVENT_DATA_T));\r\nevent_data.trigger_type = MPT3SAS_TRIGGER_MPI;\r\nevent_data.u.mpi.IOCStatus = ioc_status;\r\nevent_data.u.mpi.IocLogInfo = loginfo;\r\nmpt3sas_send_trigger_data_event(ioc, &event_data);\r\nout:\r\ndTriggerDiagPrintk(ioc, pr_info(MPT3SAS_FMT "%s: exit\n", ioc->name,\r\n__func__));\r\n}

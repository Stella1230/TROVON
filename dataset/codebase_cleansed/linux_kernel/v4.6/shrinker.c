static int shrink_tnc(struct ubifs_info *c, int nr, int age, int *contention)\r\n{\r\nint total_freed = 0;\r\nstruct ubifs_znode *znode, *zprev;\r\nint time = get_seconds();\r\nubifs_assert(mutex_is_locked(&c->umount_mutex));\r\nubifs_assert(mutex_is_locked(&c->tnc_mutex));\r\nif (!c->zroot.znode || atomic_long_read(&c->clean_zn_cnt) == 0)\r\nreturn 0;\r\nzprev = NULL;\r\nznode = ubifs_tnc_levelorder_next(c->zroot.znode, NULL);\r\nwhile (znode && total_freed < nr &&\r\natomic_long_read(&c->clean_zn_cnt) > 0) {\r\nint freed;\r\nif (znode->cnext) {\r\n*contention = 1;\r\n} else if (!ubifs_zn_dirty(znode) &&\r\nabs(time - znode->time) >= age) {\r\nif (znode->parent)\r\nznode->parent->zbranch[znode->iip].znode = NULL;\r\nelse\r\nc->zroot.znode = NULL;\r\nfreed = ubifs_destroy_tnc_subtree(znode);\r\natomic_long_sub(freed, &ubifs_clean_zn_cnt);\r\natomic_long_sub(freed, &c->clean_zn_cnt);\r\ntotal_freed += freed;\r\nznode = zprev;\r\n}\r\nif (unlikely(!c->zroot.znode))\r\nbreak;\r\nzprev = znode;\r\nznode = ubifs_tnc_levelorder_next(c->zroot.znode, znode);\r\ncond_resched();\r\n}\r\nreturn total_freed;\r\n}\r\nstatic int shrink_tnc_trees(int nr, int age, int *contention)\r\n{\r\nstruct ubifs_info *c;\r\nstruct list_head *p;\r\nunsigned int run_no;\r\nint freed = 0;\r\nspin_lock(&ubifs_infos_lock);\r\ndo {\r\nrun_no = ++shrinker_run_no;\r\n} while (run_no == 0);\r\np = ubifs_infos.next;\r\nwhile (p != &ubifs_infos) {\r\nc = list_entry(p, struct ubifs_info, infos_list);\r\nif (c->shrinker_run_no == run_no)\r\nbreak;\r\nif (!mutex_trylock(&c->umount_mutex)) {\r\n*contention = 1;\r\np = p->next;\r\ncontinue;\r\n}\r\nif (!mutex_trylock(&c->tnc_mutex)) {\r\nmutex_unlock(&c->umount_mutex);\r\n*contention = 1;\r\np = p->next;\r\ncontinue;\r\n}\r\nspin_unlock(&ubifs_infos_lock);\r\nc->shrinker_run_no = run_no;\r\nfreed += shrink_tnc(c, nr, age, contention);\r\nmutex_unlock(&c->tnc_mutex);\r\nspin_lock(&ubifs_infos_lock);\r\np = p->next;\r\nlist_move_tail(&c->infos_list, &ubifs_infos);\r\nmutex_unlock(&c->umount_mutex);\r\nif (freed >= nr)\r\nbreak;\r\n}\r\nspin_unlock(&ubifs_infos_lock);\r\nreturn freed;\r\n}\r\nstatic int kick_a_thread(void)\r\n{\r\nint i;\r\nstruct ubifs_info *c;\r\nspin_lock(&ubifs_infos_lock);\r\nfor (i = 0; i < 2; i++) {\r\nlist_for_each_entry(c, &ubifs_infos, infos_list) {\r\nlong dirty_zn_cnt;\r\nif (!mutex_trylock(&c->umount_mutex)) {\r\nspin_unlock(&ubifs_infos_lock);\r\nreturn -1;\r\n}\r\ndirty_zn_cnt = atomic_long_read(&c->dirty_zn_cnt);\r\nif (!dirty_zn_cnt || c->cmt_state == COMMIT_BROKEN ||\r\nc->ro_mount || c->ro_error) {\r\nmutex_unlock(&c->umount_mutex);\r\ncontinue;\r\n}\r\nif (c->cmt_state != COMMIT_RESTING) {\r\nspin_unlock(&ubifs_infos_lock);\r\nmutex_unlock(&c->umount_mutex);\r\nreturn -1;\r\n}\r\nif (i == 1) {\r\nlist_move_tail(&c->infos_list, &ubifs_infos);\r\nspin_unlock(&ubifs_infos_lock);\r\nubifs_request_bg_commit(c);\r\nmutex_unlock(&c->umount_mutex);\r\nreturn -1;\r\n}\r\nmutex_unlock(&c->umount_mutex);\r\n}\r\n}\r\nspin_unlock(&ubifs_infos_lock);\r\nreturn 0;\r\n}\r\nunsigned long ubifs_shrink_count(struct shrinker *shrink,\r\nstruct shrink_control *sc)\r\n{\r\nlong clean_zn_cnt = atomic_long_read(&ubifs_clean_zn_cnt);\r\nreturn clean_zn_cnt >= 0 ? clean_zn_cnt : 1;\r\n}\r\nunsigned long ubifs_shrink_scan(struct shrinker *shrink,\r\nstruct shrink_control *sc)\r\n{\r\nunsigned long nr = sc->nr_to_scan;\r\nint contention = 0;\r\nunsigned long freed;\r\nlong clean_zn_cnt = atomic_long_read(&ubifs_clean_zn_cnt);\r\nif (!clean_zn_cnt) {\r\ndbg_tnc("no clean znodes, kick a thread");\r\nreturn kick_a_thread();\r\n}\r\nfreed = shrink_tnc_trees(nr, OLD_ZNODE_AGE, &contention);\r\nif (freed >= nr)\r\ngoto out;\r\ndbg_tnc("not enough old znodes, try to free young ones");\r\nfreed += shrink_tnc_trees(nr - freed, YOUNG_ZNODE_AGE, &contention);\r\nif (freed >= nr)\r\ngoto out;\r\ndbg_tnc("not enough young znodes, free all");\r\nfreed += shrink_tnc_trees(nr - freed, 0, &contention);\r\nif (!freed && contention) {\r\ndbg_tnc("freed nothing, but contention");\r\nreturn SHRINK_STOP;\r\n}\r\nout:\r\ndbg_tnc("%lu znodes were freed, requested %lu", freed, nr);\r\nreturn freed;\r\n}

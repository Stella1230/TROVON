static char *ch7xxx_get_id(uint8_t vid)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ch7xxx_ids); i++) {\r\nif (ch7xxx_ids[i].vid == vid)\r\nreturn ch7xxx_ids[i].name;\r\n}\r\nreturn NULL;\r\n}\r\nstatic char *ch7xxx_get_did(uint8_t did)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ch7xxx_dids); i++) {\r\nif (ch7xxx_dids[i].did == did)\r\nreturn ch7xxx_dids[i].name;\r\n}\r\nreturn NULL;\r\n}\r\nstatic bool ch7xxx_readb(struct intel_dvo_device *dvo, int addr, uint8_t *ch)\r\n{\r\nstruct ch7xxx_priv *ch7xxx = dvo->dev_priv;\r\nstruct i2c_adapter *adapter = dvo->i2c_bus;\r\nu8 out_buf[2];\r\nu8 in_buf[2];\r\nstruct i2c_msg msgs[] = {\r\n{\r\n.addr = dvo->slave_addr,\r\n.flags = 0,\r\n.len = 1,\r\n.buf = out_buf,\r\n},\r\n{\r\n.addr = dvo->slave_addr,\r\n.flags = I2C_M_RD,\r\n.len = 1,\r\n.buf = in_buf,\r\n}\r\n};\r\nout_buf[0] = addr;\r\nout_buf[1] = 0;\r\nif (i2c_transfer(adapter, msgs, 2) == 2) {\r\n*ch = in_buf[0];\r\nreturn true;\r\n}\r\nif (!ch7xxx->quiet) {\r\nDRM_DEBUG_KMS("Unable to read register 0x%02x from %s:%02x.\n",\r\naddr, adapter->name, dvo->slave_addr);\r\n}\r\nreturn false;\r\n}\r\nstatic bool ch7xxx_writeb(struct intel_dvo_device *dvo, int addr, uint8_t ch)\r\n{\r\nstruct ch7xxx_priv *ch7xxx = dvo->dev_priv;\r\nstruct i2c_adapter *adapter = dvo->i2c_bus;\r\nuint8_t out_buf[2];\r\nstruct i2c_msg msg = {\r\n.addr = dvo->slave_addr,\r\n.flags = 0,\r\n.len = 2,\r\n.buf = out_buf,\r\n};\r\nout_buf[0] = addr;\r\nout_buf[1] = ch;\r\nif (i2c_transfer(adapter, &msg, 1) == 1)\r\nreturn true;\r\nif (!ch7xxx->quiet) {\r\nDRM_DEBUG_KMS("Unable to write register 0x%02x to %s:%d.\n",\r\naddr, adapter->name, dvo->slave_addr);\r\n}\r\nreturn false;\r\n}\r\nstatic bool ch7xxx_init(struct intel_dvo_device *dvo,\r\nstruct i2c_adapter *adapter)\r\n{\r\nstruct ch7xxx_priv *ch7xxx;\r\nuint8_t vendor, device;\r\nchar *name, *devid;\r\nch7xxx = kzalloc(sizeof(struct ch7xxx_priv), GFP_KERNEL);\r\nif (ch7xxx == NULL)\r\nreturn false;\r\ndvo->i2c_bus = adapter;\r\ndvo->dev_priv = ch7xxx;\r\nch7xxx->quiet = true;\r\nif (!ch7xxx_readb(dvo, CH7xxx_REG_VID, &vendor))\r\ngoto out;\r\nname = ch7xxx_get_id(vendor);\r\nif (!name) {\r\nDRM_DEBUG_KMS("ch7xxx not detected; got 0x%02x from %s "\r\n"slave %d.\n",\r\nvendor, adapter->name, dvo->slave_addr);\r\ngoto out;\r\n}\r\nif (!ch7xxx_readb(dvo, CH7xxx_REG_DID, &device))\r\ngoto out;\r\ndevid = ch7xxx_get_did(device);\r\nif (!devid) {\r\nDRM_DEBUG_KMS("ch7xxx not detected; got 0x%02x from %s "\r\n"slave %d.\n",\r\nvendor, adapter->name, dvo->slave_addr);\r\ngoto out;\r\n}\r\nch7xxx->quiet = false;\r\nDRM_DEBUG_KMS("Detected %s chipset, vendor/device ID 0x%02x/0x%02x\n",\r\nname, vendor, device);\r\nreturn true;\r\nout:\r\nkfree(ch7xxx);\r\nreturn false;\r\n}\r\nstatic enum drm_connector_status ch7xxx_detect(struct intel_dvo_device *dvo)\r\n{\r\nuint8_t cdet, orig_pm, pm;\r\nch7xxx_readb(dvo, CH7xxx_PM, &orig_pm);\r\npm = orig_pm;\r\npm &= ~CH7xxx_PM_FPD;\r\npm |= CH7xxx_PM_DVIL | CH7xxx_PM_DVIP;\r\nch7xxx_writeb(dvo, CH7xxx_PM, pm);\r\nch7xxx_readb(dvo, CH7xxx_CONNECTION_DETECT, &cdet);\r\nch7xxx_writeb(dvo, CH7xxx_PM, orig_pm);\r\nif (cdet & CH7xxx_CDET_DVI)\r\nreturn connector_status_connected;\r\nreturn connector_status_disconnected;\r\n}\r\nstatic enum drm_mode_status ch7xxx_mode_valid(struct intel_dvo_device *dvo,\r\nstruct drm_display_mode *mode)\r\n{\r\nif (mode->clock > 165000)\r\nreturn MODE_CLOCK_HIGH;\r\nreturn MODE_OK;\r\n}\r\nstatic void ch7xxx_mode_set(struct intel_dvo_device *dvo,\r\nconst struct drm_display_mode *mode,\r\nconst struct drm_display_mode *adjusted_mode)\r\n{\r\nuint8_t tvco, tpcp, tpd, tlpf, idf;\r\nif (mode->clock <= 65000) {\r\ntvco = 0x23;\r\ntpcp = 0x08;\r\ntpd = 0x16;\r\ntlpf = 0x60;\r\n} else {\r\ntvco = 0x2d;\r\ntpcp = 0x06;\r\ntpd = 0x26;\r\ntlpf = 0xa0;\r\n}\r\nch7xxx_writeb(dvo, CH7xxx_TCTL, 0x00);\r\nch7xxx_writeb(dvo, CH7xxx_TVCO, tvco);\r\nch7xxx_writeb(dvo, CH7xxx_TPCP, tpcp);\r\nch7xxx_writeb(dvo, CH7xxx_TPD, tpd);\r\nch7xxx_writeb(dvo, CH7xxx_TPVT, 0x30);\r\nch7xxx_writeb(dvo, CH7xxx_TLPF, tlpf);\r\nch7xxx_writeb(dvo, CH7xxx_TCT, 0x00);\r\nch7xxx_readb(dvo, CH7xxx_IDF, &idf);\r\nidf &= ~(CH7xxx_IDF_HSP | CH7xxx_IDF_VSP);\r\nif (mode->flags & DRM_MODE_FLAG_PHSYNC)\r\nidf |= CH7xxx_IDF_HSP;\r\nif (mode->flags & DRM_MODE_FLAG_PVSYNC)\r\nidf |= CH7xxx_IDF_VSP;\r\nch7xxx_writeb(dvo, CH7xxx_IDF, idf);\r\n}\r\nstatic void ch7xxx_dpms(struct intel_dvo_device *dvo, bool enable)\r\n{\r\nif (enable)\r\nch7xxx_writeb(dvo, CH7xxx_PM, CH7xxx_PM_DVIL | CH7xxx_PM_DVIP);\r\nelse\r\nch7xxx_writeb(dvo, CH7xxx_PM, CH7xxx_PM_FPD);\r\n}\r\nstatic bool ch7xxx_get_hw_state(struct intel_dvo_device *dvo)\r\n{\r\nu8 val;\r\nch7xxx_readb(dvo, CH7xxx_PM, &val);\r\nif (val & (CH7xxx_PM_DVIL | CH7xxx_PM_DVIP))\r\nreturn true;\r\nelse\r\nreturn false;\r\n}\r\nstatic void ch7xxx_dump_regs(struct intel_dvo_device *dvo)\r\n{\r\nint i;\r\nfor (i = 0; i < CH7xxx_NUM_REGS; i++) {\r\nuint8_t val;\r\nif ((i % 8) == 0)\r\nDRM_DEBUG_KMS("\n %02X: ", i);\r\nch7xxx_readb(dvo, i, &val);\r\nDRM_DEBUG_KMS("%02X ", val);\r\n}\r\n}\r\nstatic void ch7xxx_destroy(struct intel_dvo_device *dvo)\r\n{\r\nstruct ch7xxx_priv *ch7xxx = dvo->dev_priv;\r\nif (ch7xxx) {\r\nkfree(ch7xxx);\r\ndvo->dev_priv = NULL;\r\n}\r\n}

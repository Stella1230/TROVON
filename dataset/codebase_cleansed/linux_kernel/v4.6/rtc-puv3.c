static irqreturn_t puv3_rtc_alarmirq(int irq, void *id)\r\n{\r\nstruct rtc_device *rdev = id;\r\nwritel(readl(RTC_RTSR) | RTC_RTSR_AL, RTC_RTSR);\r\nrtc_update_irq(rdev, 1, RTC_AF | RTC_IRQF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t puv3_rtc_tickirq(int irq, void *id)\r\n{\r\nstruct rtc_device *rdev = id;\r\nwritel(readl(RTC_RTSR) | RTC_RTSR_HZ, RTC_RTSR);\r\nrtc_update_irq(rdev, 1, RTC_PF | RTC_IRQF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void puv3_rtc_setaie(struct device *dev, int to)\r\n{\r\nunsigned int tmp;\r\ndev_dbg(dev, "%s: aie=%d\n", __func__, to);\r\ntmp = readl(RTC_RTSR) & ~RTC_RTSR_ALE;\r\nif (to)\r\ntmp |= RTC_RTSR_ALE;\r\nwritel(tmp, RTC_RTSR);\r\n}\r\nstatic int puv3_rtc_setpie(struct device *dev, int enabled)\r\n{\r\nunsigned int tmp;\r\ndev_dbg(dev, "%s: pie=%d\n", __func__, enabled);\r\nspin_lock_irq(&puv3_rtc_pie_lock);\r\ntmp = readl(RTC_RTSR) & ~RTC_RTSR_HZE;\r\nif (enabled)\r\ntmp |= RTC_RTSR_HZE;\r\nwritel(tmp, RTC_RTSR);\r\nspin_unlock_irq(&puv3_rtc_pie_lock);\r\nreturn 0;\r\n}\r\nstatic int puv3_rtc_gettime(struct device *dev, struct rtc_time *rtc_tm)\r\n{\r\nrtc_time_to_tm(readl(RTC_RCNR), rtc_tm);\r\ndev_dbg(dev, "read time %02x.%02x.%02x %02x/%02x/%02x\n",\r\nrtc_tm->tm_year, rtc_tm->tm_mon, rtc_tm->tm_mday,\r\nrtc_tm->tm_hour, rtc_tm->tm_min, rtc_tm->tm_sec);\r\nreturn 0;\r\n}\r\nstatic int puv3_rtc_settime(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned long rtc_count = 0;\r\ndev_dbg(dev, "set time %02d.%02d.%02d %02d/%02d/%02d\n",\r\ntm->tm_year, tm->tm_mon, tm->tm_mday,\r\ntm->tm_hour, tm->tm_min, tm->tm_sec);\r\nrtc_tm_to_time(tm, &rtc_count);\r\nwritel(rtc_count, RTC_RCNR);\r\nreturn 0;\r\n}\r\nstatic int puv3_rtc_getalarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct rtc_time *alm_tm = &alrm->time;\r\nrtc_time_to_tm(readl(RTC_RTAR), alm_tm);\r\nalrm->enabled = readl(RTC_RTSR) & RTC_RTSR_ALE;\r\ndev_dbg(dev, "read alarm %02x %02x.%02x.%02x %02x/%02x/%02x\n",\r\nalrm->enabled,\r\nalm_tm->tm_year, alm_tm->tm_mon, alm_tm->tm_mday,\r\nalm_tm->tm_hour, alm_tm->tm_min, alm_tm->tm_sec);\r\nreturn 0;\r\n}\r\nstatic int puv3_rtc_setalarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct rtc_time *tm = &alrm->time;\r\nunsigned long rtcalarm_count = 0;\r\ndev_dbg(dev, "puv3_rtc_setalarm: %d, %02x/%02x/%02x %02x.%02x.%02x\n",\r\nalrm->enabled,\r\ntm->tm_mday & 0xff, tm->tm_mon & 0xff, tm->tm_year & 0xff,\r\ntm->tm_hour & 0xff, tm->tm_min & 0xff, tm->tm_sec);\r\nrtc_tm_to_time(tm, &rtcalarm_count);\r\nwritel(rtcalarm_count, RTC_RTAR);\r\npuv3_rtc_setaie(dev, alrm->enabled);\r\nif (alrm->enabled)\r\nenable_irq_wake(puv3_rtc_alarmno);\r\nelse\r\ndisable_irq_wake(puv3_rtc_alarmno);\r\nreturn 0;\r\n}\r\nstatic int puv3_rtc_proc(struct device *dev, struct seq_file *seq)\r\n{\r\nseq_printf(seq, "periodic_IRQ\t: %s\n",\r\n(readl(RTC_RTSR) & RTC_RTSR_HZE) ? "yes" : "no");\r\nreturn 0;\r\n}\r\nstatic int puv3_rtc_open(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_device *rtc_dev = platform_get_drvdata(pdev);\r\nint ret;\r\nret = request_irq(puv3_rtc_alarmno, puv3_rtc_alarmirq,\r\n0, "pkunity-rtc alarm", rtc_dev);\r\nif (ret) {\r\ndev_err(dev, "IRQ%d error %d\n", puv3_rtc_alarmno, ret);\r\nreturn ret;\r\n}\r\nret = request_irq(puv3_rtc_tickno, puv3_rtc_tickirq,\r\n0, "pkunity-rtc tick", rtc_dev);\r\nif (ret) {\r\ndev_err(dev, "IRQ%d error %d\n", puv3_rtc_tickno, ret);\r\ngoto tick_err;\r\n}\r\nreturn ret;\r\ntick_err:\r\nfree_irq(puv3_rtc_alarmno, rtc_dev);\r\nreturn ret;\r\n}\r\nstatic void puv3_rtc_release(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_device *rtc_dev = platform_get_drvdata(pdev);\r\npuv3_rtc_setpie(dev, 0);\r\nfree_irq(puv3_rtc_alarmno, rtc_dev);\r\nfree_irq(puv3_rtc_tickno, rtc_dev);\r\n}\r\nstatic void puv3_rtc_enable(struct device *dev, int en)\r\n{\r\nif (!en) {\r\nwritel(readl(RTC_RTSR) & ~RTC_RTSR_HZE, RTC_RTSR);\r\n} else {\r\nif ((readl(RTC_RTSR) & RTC_RTSR_HZE) == 0) {\r\ndev_info(dev, "rtc disabled, re-enabling\n");\r\nwritel(readl(RTC_RTSR) | RTC_RTSR_HZE, RTC_RTSR);\r\n}\r\n}\r\n}\r\nstatic int puv3_rtc_remove(struct platform_device *dev)\r\n{\r\nstruct rtc_device *rtc = platform_get_drvdata(dev);\r\nrtc_device_unregister(rtc);\r\npuv3_rtc_setpie(&dev->dev, 0);\r\npuv3_rtc_setaie(&dev->dev, 0);\r\nrelease_resource(puv3_rtc_mem);\r\nkfree(puv3_rtc_mem);\r\nreturn 0;\r\n}\r\nstatic int puv3_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc;\r\nstruct resource *res;\r\nint ret;\r\ndev_dbg(&pdev->dev, "%s: probe=%p\n", __func__, pdev);\r\npuv3_rtc_tickno = platform_get_irq(pdev, 1);\r\nif (puv3_rtc_tickno < 0) {\r\ndev_err(&pdev->dev, "no irq for rtc tick\n");\r\nreturn -ENOENT;\r\n}\r\npuv3_rtc_alarmno = platform_get_irq(pdev, 0);\r\nif (puv3_rtc_alarmno < 0) {\r\ndev_err(&pdev->dev, "no irq for alarm\n");\r\nreturn -ENOENT;\r\n}\r\ndev_dbg(&pdev->dev, "PKUnity_rtc: tick irq %d, alarm irq %d\n",\r\npuv3_rtc_tickno, puv3_rtc_alarmno);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (res == NULL) {\r\ndev_err(&pdev->dev, "failed to get memory region resource\n");\r\nreturn -ENOENT;\r\n}\r\npuv3_rtc_mem = request_mem_region(res->start, resource_size(res),\r\npdev->name);\r\nif (puv3_rtc_mem == NULL) {\r\ndev_err(&pdev->dev, "failed to reserve memory region\n");\r\nret = -ENOENT;\r\ngoto err_nores;\r\n}\r\npuv3_rtc_enable(&pdev->dev, 1);\r\nrtc = rtc_device_register("pkunity", &pdev->dev, &puv3_rtcops,\r\nTHIS_MODULE);\r\nif (IS_ERR(rtc)) {\r\ndev_err(&pdev->dev, "cannot attach rtc\n");\r\nret = PTR_ERR(rtc);\r\ngoto err_nortc;\r\n}\r\nif (!device_can_wakeup(&pdev->dev))\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nplatform_set_drvdata(pdev, rtc);\r\nreturn 0;\r\nerr_nortc:\r\npuv3_rtc_enable(&pdev->dev, 0);\r\nrelease_resource(puv3_rtc_mem);\r\nerr_nores:\r\nreturn ret;\r\n}\r\nstatic int puv3_rtc_suspend(struct device *dev)\r\n{\r\nticnt_save = readl(RTC_RTAR);\r\npuv3_rtc_enable(dev, 0);\r\nreturn 0;\r\n}\r\nstatic int puv3_rtc_resume(struct device *dev)\r\n{\r\npuv3_rtc_enable(dev, 1);\r\nwritel(ticnt_save, RTC_RTAR);\r\nreturn 0;\r\n}

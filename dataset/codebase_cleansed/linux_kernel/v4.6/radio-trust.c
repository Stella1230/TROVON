static struct radio_isa_card *trust_alloc(void)\r\n{\r\nstruct trust *tr = kzalloc(sizeof(*tr), GFP_KERNEL);\r\nreturn tr ? &tr->isa : NULL;\r\n}\r\nstatic void write_i2c(struct trust *tr, int n, ...)\r\n{\r\nunsigned char val, mask;\r\nva_list args;\r\nva_start(args, n);\r\nTR_SET_SDA;\r\nTR_SET_SCL;\r\nTR_DELAY;\r\nTR_CLR_SDA;\r\nTR_CLR_SCL;\r\nTR_DELAY;\r\nfor (; n; n--) {\r\nval = va_arg(args, unsigned);\r\nfor (mask = 0x80; mask; mask >>= 1) {\r\nif (val & mask)\r\nTR_SET_SDA;\r\nelse\r\nTR_CLR_SDA;\r\nTR_SET_SCL;\r\nTR_DELAY;\r\nTR_CLR_SCL;\r\nTR_DELAY;\r\n}\r\nTR_SET_SDA;\r\nTR_SET_SCL;\r\nTR_DELAY;\r\nTR_CLR_SCL;\r\nTR_DELAY;\r\n}\r\nTR_CLR_SDA;\r\nTR_DELAY;\r\nTR_SET_SCL;\r\nTR_DELAY;\r\nTR_SET_SDA;\r\nTR_DELAY;\r\nva_end(args);\r\n}\r\nstatic int trust_s_mute_volume(struct radio_isa_card *isa, bool mute, int vol)\r\n{\r\nstruct trust *tr = container_of(isa, struct trust, isa);\r\ntr->ioval = (tr->ioval & 0xf7) | (mute << 3);\r\noutb(tr->ioval, isa->io);\r\nwrite_i2c(tr, 2, TDA7318_ADDR, vol ^ 0x1f);\r\nreturn 0;\r\n}\r\nstatic int trust_s_stereo(struct radio_isa_card *isa, bool stereo)\r\n{\r\nstruct trust *tr = container_of(isa, struct trust, isa);\r\ntr->ioval = (tr->ioval & 0xfb) | (!stereo << 2);\r\noutb(tr->ioval, isa->io);\r\nreturn 0;\r\n}\r\nstatic u32 trust_g_signal(struct radio_isa_card *isa)\r\n{\r\nint i, v;\r\nfor (i = 0, v = 0; i < 100; i++)\r\nv |= inb(isa->io);\r\nreturn (v & 1) ? 0 : 0xffff;\r\n}\r\nstatic int trust_s_frequency(struct radio_isa_card *isa, u32 freq)\r\n{\r\nstruct trust *tr = container_of(isa, struct trust, isa);\r\nfreq /= 160;\r\nfreq += 1070;\r\nwrite_i2c(tr, 5, TSA6060T_ADDR, (freq << 1) | 1,\r\nfreq >> 7, 0x60 | ((freq >> 15) & 1), 0);\r\nreturn 0;\r\n}\r\nstatic int trust_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct radio_isa_card *isa =\r\ncontainer_of(ctrl->handler, struct radio_isa_card, hdl);\r\nstruct trust *tr = container_of(isa, struct trust, isa);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_BASS:\r\nwrite_i2c(tr, 2, TDA7318_ADDR, 0x60 | basstreble2chip[ctrl->val]);\r\nreturn 0;\r\ncase V4L2_CID_AUDIO_TREBLE:\r\nwrite_i2c(tr, 2, TDA7318_ADDR, 0x70 | basstreble2chip[ctrl->val]);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int trust_initialize(struct radio_isa_card *isa)\r\n{\r\nstruct trust *tr = container_of(isa, struct trust, isa);\r\ntr->ioval = 0xf;\r\nwrite_i2c(tr, 2, TDA7318_ADDR, 0x80);\r\nwrite_i2c(tr, 2, TDA7318_ADDR, 0xa0);\r\nwrite_i2c(tr, 2, TDA7318_ADDR, 0xc0);\r\nwrite_i2c(tr, 2, TDA7318_ADDR, 0xe0);\r\nwrite_i2c(tr, 2, TDA7318_ADDR, 0x40);\r\nv4l2_ctrl_new_std(&isa->hdl, &trust_ctrl_ops,\r\nV4L2_CID_AUDIO_BASS, 0, 15, 1, 8);\r\nv4l2_ctrl_new_std(&isa->hdl, &trust_ctrl_ops,\r\nV4L2_CID_AUDIO_TREBLE, 0, 15, 1, 8);\r\nreturn isa->hdl.error;\r\n}\r\nstatic int __init trust_init(void)\r\n{\r\nreturn isa_register_driver(&trust_driver.driver, TRUST_MAX);\r\n}\r\nstatic void __exit trust_exit(void)\r\n{\r\nisa_unregister_driver(&trust_driver.driver);\r\n}

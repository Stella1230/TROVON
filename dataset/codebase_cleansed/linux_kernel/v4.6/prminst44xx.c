void omap_prm_base_init(void)\r\n{\r\n_prm_bases[OMAP4430_PRM_PARTITION] = prm_base;\r\n_prm_bases[OMAP4430_PRCM_MPU_PARTITION] = prcm_mpu_base;\r\n}\r\ns32 omap4_prmst_get_prm_dev_inst(void)\r\n{\r\nreturn prm_dev_inst;\r\n}\r\nvoid omap4_prminst_set_prm_dev_inst(s32 dev_inst)\r\n{\r\nprm_dev_inst = dev_inst;\r\n}\r\nu32 omap4_prminst_read_inst_reg(u8 part, s16 inst, u16 idx)\r\n{\r\nBUG_ON(part >= OMAP4_MAX_PRCM_PARTITIONS ||\r\npart == OMAP4430_INVALID_PRCM_PARTITION ||\r\n!_prm_bases[part]);\r\nreturn readl_relaxed(_prm_bases[part] + inst + idx);\r\n}\r\nvoid omap4_prminst_write_inst_reg(u32 val, u8 part, s16 inst, u16 idx)\r\n{\r\nBUG_ON(part >= OMAP4_MAX_PRCM_PARTITIONS ||\r\npart == OMAP4430_INVALID_PRCM_PARTITION ||\r\n!_prm_bases[part]);\r\nwritel_relaxed(val, _prm_bases[part] + inst + idx);\r\n}\r\nu32 omap4_prminst_rmw_inst_reg_bits(u32 mask, u32 bits, u8 part, s16 inst,\r\nu16 idx)\r\n{\r\nu32 v;\r\nv = omap4_prminst_read_inst_reg(part, inst, idx);\r\nv &= ~mask;\r\nv |= bits;\r\nomap4_prminst_write_inst_reg(v, part, inst, idx);\r\nreturn v;\r\n}\r\nint omap4_prminst_is_hardreset_asserted(u8 shift, u8 part, s16 inst,\r\nu16 rstctrl_offs)\r\n{\r\nu32 v;\r\nv = omap4_prminst_read_inst_reg(part, inst, rstctrl_offs);\r\nv &= 1 << shift;\r\nv >>= shift;\r\nreturn v;\r\n}\r\nint omap4_prminst_assert_hardreset(u8 shift, u8 part, s16 inst,\r\nu16 rstctrl_offs)\r\n{\r\nu32 mask = 1 << shift;\r\nomap4_prminst_rmw_inst_reg_bits(mask, mask, part, inst, rstctrl_offs);\r\nreturn 0;\r\n}\r\nint omap4_prminst_deassert_hardreset(u8 shift, u8 st_shift, u8 part, s16 inst,\r\nu16 rstctrl_offs, u16 rstst_offs)\r\n{\r\nint c;\r\nu32 mask = 1 << shift;\r\nu32 st_mask = 1 << st_shift;\r\nif (omap4_prminst_is_hardreset_asserted(shift, part, inst,\r\nrstctrl_offs) == 0)\r\nreturn -EEXIST;\r\nomap4_prminst_rmw_inst_reg_bits(0xffffffff, st_mask, part, inst,\r\nrstst_offs);\r\nomap4_prminst_rmw_inst_reg_bits(mask, 0, part, inst, rstctrl_offs);\r\nomap_test_timeout(omap4_prminst_is_hardreset_asserted(st_shift, part,\r\ninst, rstst_offs),\r\nMAX_MODULE_HARDRESET_WAIT, c);\r\nreturn (c == MAX_MODULE_HARDRESET_WAIT) ? -EBUSY : 0;\r\n}\r\nvoid omap4_prminst_global_warm_sw_reset(void)\r\n{\r\nu32 v;\r\ns32 inst = omap4_prmst_get_prm_dev_inst();\r\nif (inst == PRM_INSTANCE_UNKNOWN)\r\nreturn;\r\nv = omap4_prminst_read_inst_reg(OMAP4430_PRM_PARTITION, inst,\r\nOMAP4_PRM_RSTCTRL_OFFSET);\r\nv |= OMAP4430_RST_GLOBAL_WARM_SW_MASK;\r\nomap4_prminst_write_inst_reg(v, OMAP4430_PRM_PARTITION,\r\ninst, OMAP4_PRM_RSTCTRL_OFFSET);\r\nv = omap4_prminst_read_inst_reg(OMAP4430_PRM_PARTITION,\r\ninst, OMAP4_PRM_RSTCTRL_OFFSET);\r\n}

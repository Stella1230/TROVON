static ssize_t routes_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct rio_dev *rdev = to_rio_dev(dev);\r\nchar *str = buf;\r\nint i;\r\nfor (i = 0; i < RIO_MAX_ROUTE_ENTRIES(rdev->net->hport->sys_size);\r\ni++) {\r\nif (rdev->rswitch->route_table[i] == RIO_INVALID_ROUTE)\r\ncontinue;\r\nstr +=\r\nsprintf(str, "%04x %02x\n", i,\r\nrdev->rswitch->route_table[i]);\r\n}\r\nreturn (str - buf);\r\n}\r\nstatic ssize_t lprev_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct rio_dev *rdev = to_rio_dev(dev);\r\nreturn sprintf(buf, "%s\n",\r\n(rdev->prev) ? rio_name(rdev->prev) : "root");\r\n}\r\nstatic ssize_t lnext_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct rio_dev *rdev = to_rio_dev(dev);\r\nchar *str = buf;\r\nint i;\r\nif (rdev->pef & RIO_PEF_SWITCH) {\r\nfor (i = 0; i < RIO_GET_TOTAL_PORTS(rdev->swpinfo); i++) {\r\nif (rdev->rswitch->nextdev[i])\r\nstr += sprintf(str, "%s\n",\r\nrio_name(rdev->rswitch->nextdev[i]));\r\nelse\r\nstr += sprintf(str, "null\n");\r\n}\r\n}\r\nreturn str - buf;\r\n}\r\nstatic ssize_t modalias_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct rio_dev *rdev = to_rio_dev(dev);\r\nreturn sprintf(buf, "rapidio:v%04Xd%04Xav%04Xad%04X\n",\r\nrdev->vid, rdev->did, rdev->asm_vid, rdev->asm_did);\r\n}\r\nstatic ssize_t\r\nrio_read_config(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nstruct rio_dev *dev = to_rio_dev(kobj_to_dev(kobj));\r\nunsigned int size = 0x100;\r\nloff_t init_off = off;\r\nu8 *data = (u8 *) buf;\r\nif (capable(CAP_SYS_ADMIN))\r\nsize = RIO_MAINT_SPACE_SZ;\r\nif (off >= size)\r\nreturn 0;\r\nif (off + count > size) {\r\nsize -= off;\r\ncount = size;\r\n} else {\r\nsize = count;\r\n}\r\nif ((off & 1) && size) {\r\nu8 val;\r\nrio_read_config_8(dev, off, &val);\r\ndata[off - init_off] = val;\r\noff++;\r\nsize--;\r\n}\r\nif ((off & 3) && size > 2) {\r\nu16 val;\r\nrio_read_config_16(dev, off, &val);\r\ndata[off - init_off] = (val >> 8) & 0xff;\r\ndata[off - init_off + 1] = val & 0xff;\r\noff += 2;\r\nsize -= 2;\r\n}\r\nwhile (size > 3) {\r\nu32 val;\r\nrio_read_config_32(dev, off, &val);\r\ndata[off - init_off] = (val >> 24) & 0xff;\r\ndata[off - init_off + 1] = (val >> 16) & 0xff;\r\ndata[off - init_off + 2] = (val >> 8) & 0xff;\r\ndata[off - init_off + 3] = val & 0xff;\r\noff += 4;\r\nsize -= 4;\r\n}\r\nif (size >= 2) {\r\nu16 val;\r\nrio_read_config_16(dev, off, &val);\r\ndata[off - init_off] = (val >> 8) & 0xff;\r\ndata[off - init_off + 1] = val & 0xff;\r\noff += 2;\r\nsize -= 2;\r\n}\r\nif (size > 0) {\r\nu8 val;\r\nrio_read_config_8(dev, off, &val);\r\ndata[off - init_off] = val;\r\noff++;\r\n--size;\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nrio_write_config(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nstruct rio_dev *dev = to_rio_dev(kobj_to_dev(kobj));\r\nunsigned int size = count;\r\nloff_t init_off = off;\r\nu8 *data = (u8 *) buf;\r\nif (off >= RIO_MAINT_SPACE_SZ)\r\nreturn 0;\r\nif (off + count > RIO_MAINT_SPACE_SZ) {\r\nsize = RIO_MAINT_SPACE_SZ - off;\r\ncount = size;\r\n}\r\nif ((off & 1) && size) {\r\nrio_write_config_8(dev, off, data[off - init_off]);\r\noff++;\r\nsize--;\r\n}\r\nif ((off & 3) && (size > 2)) {\r\nu16 val = data[off - init_off + 1];\r\nval |= (u16) data[off - init_off] << 8;\r\nrio_write_config_16(dev, off, val);\r\noff += 2;\r\nsize -= 2;\r\n}\r\nwhile (size > 3) {\r\nu32 val = data[off - init_off + 3];\r\nval |= (u32) data[off - init_off + 2] << 8;\r\nval |= (u32) data[off - init_off + 1] << 16;\r\nval |= (u32) data[off - init_off] << 24;\r\nrio_write_config_32(dev, off, val);\r\noff += 4;\r\nsize -= 4;\r\n}\r\nif (size >= 2) {\r\nu16 val = data[off - init_off + 1];\r\nval |= (u16) data[off - init_off] << 8;\r\nrio_write_config_16(dev, off, val);\r\noff += 2;\r\nsize -= 2;\r\n}\r\nif (size) {\r\nrio_write_config_8(dev, off, data[off - init_off]);\r\noff++;\r\n--size;\r\n}\r\nreturn count;\r\n}\r\nint rio_create_sysfs_dev_files(struct rio_dev *rdev)\r\n{\r\nint err = 0;\r\nerr = device_create_bin_file(&rdev->dev, &rio_config_attr);\r\nif (!err && (rdev->pef & RIO_PEF_SWITCH)) {\r\nerr |= device_create_file(&rdev->dev, &dev_attr_routes);\r\nerr |= device_create_file(&rdev->dev, &dev_attr_lnext);\r\nerr |= device_create_file(&rdev->dev, &dev_attr_hopcount);\r\n}\r\nif (err)\r\npr_warning("RIO: Failed to create attribute file(s) for %s\n",\r\nrio_name(rdev));\r\nreturn err;\r\n}\r\nvoid rio_remove_sysfs_dev_files(struct rio_dev *rdev)\r\n{\r\ndevice_remove_bin_file(&rdev->dev, &rio_config_attr);\r\nif (rdev->pef & RIO_PEF_SWITCH) {\r\ndevice_remove_file(&rdev->dev, &dev_attr_routes);\r\ndevice_remove_file(&rdev->dev, &dev_attr_lnext);\r\ndevice_remove_file(&rdev->dev, &dev_attr_hopcount);\r\n}\r\n}\r\nstatic ssize_t bus_scan_store(struct bus_type *bus, const char *buf,\r\nsize_t count)\r\n{\r\nlong val;\r\nint rc;\r\nif (kstrtol(buf, 0, &val) < 0)\r\nreturn -EINVAL;\r\nif (val == RIO_MPORT_ANY) {\r\nrc = rio_init_mports();\r\ngoto exit;\r\n}\r\nif (val < 0 || val >= RIO_MAX_MPORTS)\r\nreturn -EINVAL;\r\nrc = rio_mport_scan((int)val);\r\nexit:\r\nif (!rc)\r\nrc = count;\r\nreturn rc;\r\n}\r\nstatic ssize_t\r\nport_destid_show(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct rio_mport *mport = to_rio_mport(dev);\r\nif (mport)\r\nreturn sprintf(buf, "0x%04x\n", mport->host_deviceid);\r\nelse\r\nreturn -ENODEV;\r\n}\r\nstatic ssize_t sys_size_show(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct rio_mport *mport = to_rio_mport(dev);\r\nif (mport)\r\nreturn sprintf(buf, "%u\n", mport->sys_size);\r\nelse\r\nreturn -ENODEV;\r\n}

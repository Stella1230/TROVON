static inline int get_cvb_voltage(int speedo, int s_scale,\r\nconst struct cvb_coefficients *cvb)\r\n{\r\nint mv;\r\nmv = DIV_ROUND_CLOSEST(cvb->c2 * speedo, s_scale);\r\nmv = DIV_ROUND_CLOSEST((mv + cvb->c1) * speedo, s_scale) + cvb->c0;\r\nreturn mv;\r\n}\r\nstatic int round_cvb_voltage(int mv, int v_scale,\r\nconst struct rail_alignment *align)\r\n{\r\nint uv;\r\nint step = (align->step_uv ? : 1000) * v_scale;\r\nint offset = align->offset_uv * v_scale;\r\nuv = max(mv * 1000, offset) - offset;\r\nuv = DIV_ROUND_UP(uv, step) * align->step_uv + align->offset_uv;\r\nreturn uv / 1000;\r\n}\r\nstatic int round_voltage(int mv, const struct rail_alignment *align, int up)\r\n{\r\nif (align->step_uv) {\r\nint uv;\r\nuv = max(mv * 1000, align->offset_uv) - align->offset_uv;\r\nuv = (uv + (up ? align->step_uv - 1 : 0)) / align->step_uv;\r\nreturn (uv * align->step_uv + align->offset_uv) / 1000;\r\n}\r\nreturn mv;\r\n}\r\nstatic int build_opp_table(const struct cvb_table *d,\r\nint speedo_value,\r\nunsigned long max_freq,\r\nstruct device *opp_dev)\r\n{\r\nint i, ret, dfll_mv, min_mv, max_mv;\r\nconst struct cvb_table_freq_entry *table = NULL;\r\nconst struct rail_alignment *align = &d->alignment;\r\nmin_mv = round_voltage(d->min_millivolts, align, UP);\r\nmax_mv = round_voltage(d->max_millivolts, align, DOWN);\r\nfor (i = 0; i < MAX_DVFS_FREQS; i++) {\r\ntable = &d->cvb_table[i];\r\nif (!table->freq || (table->freq > max_freq))\r\nbreak;\r\ndfll_mv = get_cvb_voltage(\r\nspeedo_value, d->speedo_scale, &table->coefficients);\r\ndfll_mv = round_cvb_voltage(dfll_mv, d->voltage_scale, align);\r\ndfll_mv = clamp(dfll_mv, min_mv, max_mv);\r\nret = dev_pm_opp_add(opp_dev, table->freq, dfll_mv * 1000);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nconst struct cvb_table *tegra_cvb_build_opp_table(\r\nconst struct cvb_table *cvb_tables,\r\nsize_t sz, int process_id,\r\nint speedo_id, int speedo_value,\r\nunsigned long max_rate,\r\nstruct device *opp_dev)\r\n{\r\nint i, ret;\r\nfor (i = 0; i < sz; i++) {\r\nconst struct cvb_table *d = &cvb_tables[i];\r\nif (d->speedo_id != -1 && d->speedo_id != speedo_id)\r\ncontinue;\r\nif (d->process_id != -1 && d->process_id != process_id)\r\ncontinue;\r\nret = build_opp_table(d, speedo_value, max_rate, opp_dev);\r\nreturn ret ? ERR_PTR(ret) : d;\r\n}\r\nreturn ERR_PTR(-EINVAL);\r\n}

static cycle_t notrace clksrc_dbx500_prcmu_read(struct clocksource *cs)\r\n{\r\nvoid __iomem *base = clksrc_dbx500_timer_base;\r\nu32 count, count2;\r\ndo {\r\ncount = readl_relaxed(base + PRCMU_TIMER_DOWNCOUNT);\r\ncount2 = readl_relaxed(base + PRCMU_TIMER_DOWNCOUNT);\r\n} while (count2 != count);\r\nreturn ~count;\r\n}\r\nstatic u64 notrace dbx500_prcmu_sched_clock_read(void)\r\n{\r\nif (unlikely(!clksrc_dbx500_timer_base))\r\nreturn 0;\r\nreturn clksrc_dbx500_prcmu_read(&clocksource_dbx500_prcmu);\r\n}\r\nstatic void __init clksrc_dbx500_prcmu_init(struct device_node *node)\r\n{\r\nclksrc_dbx500_timer_base = of_iomap(node, 0);\r\nif (readl(clksrc_dbx500_timer_base + PRCMU_TIMER_MODE) !=\r\nTIMER_MODE_CONTINOUS) {\r\nwritel(TIMER_MODE_CONTINOUS,\r\nclksrc_dbx500_timer_base + PRCMU_TIMER_MODE);\r\nwritel(TIMER_DOWNCOUNT_VAL,\r\nclksrc_dbx500_timer_base + PRCMU_TIMER_REF);\r\n}\r\n#ifdef CONFIG_CLKSRC_DBX500_PRCMU_SCHED_CLOCK\r\nsched_clock_register(dbx500_prcmu_sched_clock_read, 32, RATE_32K);\r\n#endif\r\nclocksource_register_hz(&clocksource_dbx500_prcmu, RATE_32K);\r\n}

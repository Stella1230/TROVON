int kvm_irq_map_gsi(struct kvm *kvm,\r\nstruct kvm_kernel_irq_routing_entry *entries, int gsi)\r\n{\r\nstruct kvm_irq_routing_table *irq_rt;\r\nstruct kvm_kernel_irq_routing_entry *e;\r\nint n = 0;\r\nirq_rt = srcu_dereference_check(kvm->irq_routing, &kvm->irq_srcu,\r\nlockdep_is_held(&kvm->irq_lock));\r\nif (gsi < irq_rt->nr_rt_entries) {\r\nhlist_for_each_entry(e, &irq_rt->map[gsi], link) {\r\nentries[n] = *e;\r\n++n;\r\n}\r\n}\r\nreturn n;\r\n}\r\nint kvm_irq_map_chip_pin(struct kvm *kvm, unsigned irqchip, unsigned pin)\r\n{\r\nstruct kvm_irq_routing_table *irq_rt;\r\nirq_rt = srcu_dereference(kvm->irq_routing, &kvm->irq_srcu);\r\nreturn irq_rt->chip[irqchip][pin];\r\n}\r\nint kvm_send_userspace_msi(struct kvm *kvm, struct kvm_msi *msi)\r\n{\r\nstruct kvm_kernel_irq_routing_entry route;\r\nif (!irqchip_in_kernel(kvm) || msi->flags != 0)\r\nreturn -EINVAL;\r\nroute.msi.address_lo = msi->address_lo;\r\nroute.msi.address_hi = msi->address_hi;\r\nroute.msi.data = msi->data;\r\nreturn kvm_set_msi(&route, kvm, KVM_USERSPACE_IRQ_SOURCE_ID, 1, false);\r\n}\r\nint kvm_set_irq(struct kvm *kvm, int irq_source_id, u32 irq, int level,\r\nbool line_status)\r\n{\r\nstruct kvm_kernel_irq_routing_entry irq_set[KVM_NR_IRQCHIPS];\r\nint ret = -1, i, idx;\r\ntrace_kvm_set_irq(irq, level, irq_source_id);\r\nidx = srcu_read_lock(&kvm->irq_srcu);\r\ni = kvm_irq_map_gsi(kvm, irq_set, irq);\r\nsrcu_read_unlock(&kvm->irq_srcu, idx);\r\nwhile (i--) {\r\nint r;\r\nr = irq_set[i].set(&irq_set[i], kvm, irq_source_id, level,\r\nline_status);\r\nif (r < 0)\r\ncontinue;\r\nret = r + ((ret < 0) ? 0 : ret);\r\n}\r\nreturn ret;\r\n}\r\nstatic void free_irq_routing_table(struct kvm_irq_routing_table *rt)\r\n{\r\nint i;\r\nif (!rt)\r\nreturn;\r\nfor (i = 0; i < rt->nr_rt_entries; ++i) {\r\nstruct kvm_kernel_irq_routing_entry *e;\r\nstruct hlist_node *n;\r\nhlist_for_each_entry_safe(e, n, &rt->map[i], link) {\r\nhlist_del(&e->link);\r\nkfree(e);\r\n}\r\n}\r\nkfree(rt);\r\n}\r\nvoid kvm_free_irq_routing(struct kvm *kvm)\r\n{\r\nstruct kvm_irq_routing_table *rt = rcu_access_pointer(kvm->irq_routing);\r\nfree_irq_routing_table(rt);\r\n}\r\nstatic int setup_routing_entry(struct kvm_irq_routing_table *rt,\r\nstruct kvm_kernel_irq_routing_entry *e,\r\nconst struct kvm_irq_routing_entry *ue)\r\n{\r\nint r = -EINVAL;\r\nstruct kvm_kernel_irq_routing_entry *ei;\r\nhlist_for_each_entry(ei, &rt->map[ue->gsi], link)\r\nif (ei->type != KVM_IRQ_ROUTING_IRQCHIP ||\r\nue->type != KVM_IRQ_ROUTING_IRQCHIP ||\r\nue->u.irqchip.irqchip == ei->irqchip.irqchip)\r\nreturn r;\r\ne->gsi = ue->gsi;\r\ne->type = ue->type;\r\nr = kvm_set_routing_entry(e, ue);\r\nif (r)\r\ngoto out;\r\nif (e->type == KVM_IRQ_ROUTING_IRQCHIP)\r\nrt->chip[e->irqchip.irqchip][e->irqchip.pin] = e->gsi;\r\nhlist_add_head(&e->link, &rt->map[e->gsi]);\r\nr = 0;\r\nout:\r\nreturn r;\r\n}\r\nint kvm_set_irq_routing(struct kvm *kvm,\r\nconst struct kvm_irq_routing_entry *ue,\r\nunsigned nr,\r\nunsigned flags)\r\n{\r\nstruct kvm_irq_routing_table *new, *old;\r\nu32 i, j, nr_rt_entries = 0;\r\nint r;\r\nfor (i = 0; i < nr; ++i) {\r\nif (ue[i].gsi >= KVM_MAX_IRQ_ROUTES)\r\nreturn -EINVAL;\r\nnr_rt_entries = max(nr_rt_entries, ue[i].gsi);\r\n}\r\nnr_rt_entries += 1;\r\nnew = kzalloc(sizeof(*new) + (nr_rt_entries * sizeof(struct hlist_head)),\r\nGFP_KERNEL);\r\nif (!new)\r\nreturn -ENOMEM;\r\nnew->nr_rt_entries = nr_rt_entries;\r\nfor (i = 0; i < KVM_NR_IRQCHIPS; i++)\r\nfor (j = 0; j < KVM_IRQCHIP_NUM_PINS; j++)\r\nnew->chip[i][j] = -1;\r\nfor (i = 0; i < nr; ++i) {\r\nstruct kvm_kernel_irq_routing_entry *e;\r\nr = -ENOMEM;\r\ne = kzalloc(sizeof(*e), GFP_KERNEL);\r\nif (!e)\r\ngoto out;\r\nr = -EINVAL;\r\nif (ue->flags) {\r\nkfree(e);\r\ngoto out;\r\n}\r\nr = setup_routing_entry(new, e, ue);\r\nif (r) {\r\nkfree(e);\r\ngoto out;\r\n}\r\n++ue;\r\n}\r\nmutex_lock(&kvm->irq_lock);\r\nold = kvm->irq_routing;\r\nrcu_assign_pointer(kvm->irq_routing, new);\r\nkvm_irq_routing_update(kvm);\r\nkvm_arch_irq_routing_update(kvm);\r\nmutex_unlock(&kvm->irq_lock);\r\nkvm_arch_post_irq_routing_update(kvm);\r\nsynchronize_srcu_expedited(&kvm->irq_srcu);\r\nnew = old;\r\nr = 0;\r\nout:\r\nfree_irq_routing_table(new);\r\nreturn r;\r\n}

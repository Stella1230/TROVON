static int wil_is_pmc_allocated(struct pmc_ctx *pmc)\r\n{\r\nreturn !!pmc->pring_va;\r\n}\r\nvoid wil_pmc_init(struct wil6210_priv *wil)\r\n{\r\nmemset(&wil->pmc, 0, sizeof(struct pmc_ctx));\r\nmutex_init(&wil->pmc.lock);\r\n}\r\nvoid wil_pmc_alloc(struct wil6210_priv *wil,\r\nint num_descriptors,\r\nint descriptor_size)\r\n{\r\nu32 i;\r\nstruct pmc_ctx *pmc = &wil->pmc;\r\nstruct device *dev = wil_to_dev(wil);\r\nstruct wmi_pmc_cmd pmc_cmd = {0};\r\nmutex_lock(&pmc->lock);\r\nif (wil_is_pmc_allocated(pmc)) {\r\nwil_err(wil, "%s: ERROR pmc is already allocated\n", __func__);\r\ngoto no_release_err;\r\n}\r\npmc->num_descriptors = num_descriptors;\r\npmc->descriptor_size = descriptor_size;\r\nwil_dbg_misc(wil, "%s: %d descriptors x %d bytes each\n",\r\n__func__, num_descriptors, descriptor_size);\r\npmc->descriptors = kcalloc(num_descriptors,\r\nsizeof(struct desc_alloc_info),\r\nGFP_KERNEL);\r\nif (!pmc->descriptors) {\r\nwil_err(wil, "%s: ERROR allocating pmc skb list\n", __func__);\r\ngoto no_release_err;\r\n}\r\nwil_dbg_misc(wil,\r\n"%s: allocated descriptors info list %p\n",\r\n__func__, pmc->descriptors);\r\npmc->pring_va = dma_alloc_coherent(dev,\r\nsizeof(struct vring_tx_desc) * num_descriptors,\r\n&pmc->pring_pa,\r\nGFP_KERNEL);\r\nwil_dbg_misc(wil,\r\n"%s: allocated pring %p => %pad. %zd x %d = total %zd bytes\n",\r\n__func__,\r\npmc->pring_va, &pmc->pring_pa,\r\nsizeof(struct vring_tx_desc),\r\nnum_descriptors,\r\nsizeof(struct vring_tx_desc) * num_descriptors);\r\nif (!pmc->pring_va) {\r\nwil_err(wil, "%s: ERROR allocating pmc pring\n", __func__);\r\ngoto release_pmc_skb_list;\r\n}\r\nfor (i = 0; i < num_descriptors; i++) {\r\nstruct vring_tx_desc *_d = &pmc->pring_va[i];\r\nstruct vring_tx_desc dd = {}, *d = &dd;\r\nint j = 0;\r\npmc->descriptors[i].va = dma_alloc_coherent(dev,\r\ndescriptor_size,\r\n&pmc->descriptors[i].pa,\r\nGFP_KERNEL);\r\nif (unlikely(!pmc->descriptors[i].va)) {\r\nwil_err(wil,\r\n"%s: ERROR allocating pmc descriptor %d",\r\n__func__, i);\r\ngoto release_pmc_skbs;\r\n}\r\nfor (j = 0; j < descriptor_size / sizeof(u32); j++) {\r\nu32 *p = (u32 *)pmc->descriptors[i].va + j;\r\n*p = PCM_DATA_INVALID_DW_VAL | j;\r\n}\r\nd->dma.addr.addr_low =\r\ncpu_to_le32(lower_32_bits(pmc->descriptors[i].pa));\r\nd->dma.addr.addr_high =\r\ncpu_to_le16((u16)upper_32_bits(pmc->descriptors[i].pa));\r\nd->dma.status = 0;\r\nd->dma.length = cpu_to_le16(descriptor_size);\r\nd->dma.d0 = BIT(9) | RX_DMA_D0_CMD_DMA_IT;\r\n*_d = *d;\r\n}\r\nwil_dbg_misc(wil, "%s: allocated successfully\n", __func__);\r\npmc_cmd.op = WMI_PMC_ALLOCATE;\r\npmc_cmd.ring_size = cpu_to_le16(pmc->num_descriptors);\r\npmc_cmd.mem_base = cpu_to_le64(pmc->pring_pa);\r\nwil_dbg_misc(wil, "%s: send WMI_PMC_CMD with ALLOCATE op\n", __func__);\r\npmc->last_cmd_status = wmi_send(wil,\r\nWMI_PMC_CMDID,\r\n&pmc_cmd,\r\nsizeof(pmc_cmd));\r\nif (pmc->last_cmd_status) {\r\nwil_err(wil,\r\n"%s: WMI_PMC_CMD with ALLOCATE op failed with status %d",\r\n__func__, pmc->last_cmd_status);\r\ngoto release_pmc_skbs;\r\n}\r\nmutex_unlock(&pmc->lock);\r\nreturn;\r\nrelease_pmc_skbs:\r\nwil_err(wil, "%s: exit on error: Releasing skbs...\n", __func__);\r\nfor (i = 0; pmc->descriptors[i].va && i < num_descriptors; i++) {\r\ndma_free_coherent(dev,\r\ndescriptor_size,\r\npmc->descriptors[i].va,\r\npmc->descriptors[i].pa);\r\npmc->descriptors[i].va = NULL;\r\n}\r\nwil_err(wil, "%s: exit on error: Releasing pring...\n", __func__);\r\ndma_free_coherent(dev,\r\nsizeof(struct vring_tx_desc) * num_descriptors,\r\npmc->pring_va,\r\npmc->pring_pa);\r\npmc->pring_va = NULL;\r\nrelease_pmc_skb_list:\r\nwil_err(wil, "%s: exit on error: Releasing descriptors info list...\n",\r\n__func__);\r\nkfree(pmc->descriptors);\r\npmc->descriptors = NULL;\r\nno_release_err:\r\npmc->last_cmd_status = -ENOMEM;\r\nmutex_unlock(&pmc->lock);\r\n}\r\nvoid wil_pmc_free(struct wil6210_priv *wil, int send_pmc_cmd)\r\n{\r\nstruct pmc_ctx *pmc = &wil->pmc;\r\nstruct device *dev = wil_to_dev(wil);\r\nstruct wmi_pmc_cmd pmc_cmd = {0};\r\nmutex_lock(&pmc->lock);\r\npmc->last_cmd_status = 0;\r\nif (!wil_is_pmc_allocated(pmc)) {\r\nwil_dbg_misc(wil, "%s: Error, can't free - not allocated\n",\r\n__func__);\r\npmc->last_cmd_status = -EPERM;\r\nmutex_unlock(&pmc->lock);\r\nreturn;\r\n}\r\nif (send_pmc_cmd) {\r\nwil_dbg_misc(wil, "%s: send WMI_PMC_CMD with RELEASE op\n",\r\n__func__);\r\npmc_cmd.op = WMI_PMC_RELEASE;\r\npmc->last_cmd_status =\r\nwmi_send(wil, WMI_PMC_CMDID, &pmc_cmd,\r\nsizeof(pmc_cmd));\r\nif (pmc->last_cmd_status) {\r\nwil_err(wil,\r\n"%s WMI_PMC_CMD with RELEASE op failed, status %d",\r\n__func__, pmc->last_cmd_status);\r\n}\r\n}\r\nif (pmc->pring_va) {\r\nsize_t buf_size = sizeof(struct vring_tx_desc) *\r\npmc->num_descriptors;\r\nwil_dbg_misc(wil, "%s: free pring va %p\n",\r\n__func__, pmc->pring_va);\r\ndma_free_coherent(dev, buf_size, pmc->pring_va, pmc->pring_pa);\r\npmc->pring_va = NULL;\r\n} else {\r\npmc->last_cmd_status = -ENOENT;\r\n}\r\nif (pmc->descriptors) {\r\nint i;\r\nfor (i = 0;\r\npmc->descriptors[i].va && i < pmc->num_descriptors; i++) {\r\ndma_free_coherent(dev,\r\npmc->descriptor_size,\r\npmc->descriptors[i].va,\r\npmc->descriptors[i].pa);\r\npmc->descriptors[i].va = NULL;\r\n}\r\nwil_dbg_misc(wil, "%s: free descriptor info %d/%d\n",\r\n__func__, i, pmc->num_descriptors);\r\nwil_dbg_misc(wil,\r\n"%s: free pmc descriptors info list %p\n",\r\n__func__, pmc->descriptors);\r\nkfree(pmc->descriptors);\r\npmc->descriptors = NULL;\r\n} else {\r\npmc->last_cmd_status = -ENOENT;\r\n}\r\nmutex_unlock(&pmc->lock);\r\n}\r\nint wil_pmc_last_cmd_status(struct wil6210_priv *wil)\r\n{\r\nwil_dbg_misc(wil, "%s: status %d\n", __func__,\r\nwil->pmc.last_cmd_status);\r\nreturn wil->pmc.last_cmd_status;\r\n}\r\nssize_t wil_pmc_read(struct file *filp, char __user *buf, size_t count,\r\nloff_t *f_pos)\r\n{\r\nstruct wil6210_priv *wil = filp->private_data;\r\nstruct pmc_ctx *pmc = &wil->pmc;\r\nsize_t retval = 0;\r\nunsigned long long idx;\r\nloff_t offset;\r\nsize_t pmc_size = pmc->descriptor_size * pmc->num_descriptors;\r\nmutex_lock(&pmc->lock);\r\nif (!wil_is_pmc_allocated(pmc)) {\r\nwil_err(wil, "%s: error, pmc is not allocated!\n", __func__);\r\npmc->last_cmd_status = -EPERM;\r\nmutex_unlock(&pmc->lock);\r\nreturn -EPERM;\r\n}\r\nwil_dbg_misc(wil,\r\n"%s: size %u, pos %lld\n",\r\n__func__, (unsigned)count, *f_pos);\r\npmc->last_cmd_status = 0;\r\nidx = *f_pos;\r\ndo_div(idx, pmc->descriptor_size);\r\noffset = *f_pos - (idx * pmc->descriptor_size);\r\nif (*f_pos >= pmc_size) {\r\nwil_dbg_misc(wil, "%s: reached end of pmc buf: %lld >= %u\n",\r\n__func__, *f_pos, (unsigned)pmc_size);\r\npmc->last_cmd_status = -ERANGE;\r\ngoto out;\r\n}\r\nwil_dbg_misc(wil,\r\n"%s: read from pos %lld (descriptor %llu, offset %llu) %zu bytes\n",\r\n__func__, *f_pos, idx, offset, count);\r\nretval = simple_read_from_buffer(buf,\r\ncount,\r\n&offset,\r\npmc->descriptors[idx].va,\r\npmc->descriptor_size);\r\n*f_pos += retval;\r\nout:\r\nmutex_unlock(&pmc->lock);\r\nreturn retval;\r\n}\r\nloff_t wil_pmc_llseek(struct file *filp, loff_t off, int whence)\r\n{\r\nloff_t newpos;\r\nstruct wil6210_priv *wil = filp->private_data;\r\nstruct pmc_ctx *pmc = &wil->pmc;\r\nsize_t pmc_size = pmc->descriptor_size * pmc->num_descriptors;\r\nswitch (whence) {\r\ncase 0:\r\nnewpos = off;\r\nbreak;\r\ncase 1:\r\nnewpos = filp->f_pos + off;\r\nbreak;\r\ncase 2:\r\nnewpos = pmc_size;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (newpos < 0)\r\nreturn -EINVAL;\r\nif (newpos > pmc_size)\r\nnewpos = pmc_size;\r\nfilp->f_pos = newpos;\r\nreturn newpos;\r\n}

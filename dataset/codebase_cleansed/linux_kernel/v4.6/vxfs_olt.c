static inline void\r\nvxfs_get_fshead(struct vxfs_oltfshead *fshp, struct vxfs_sb_info *infp)\r\n{\r\nBUG_ON(infp->vsi_fshino);\r\ninfp->vsi_fshino = fshp->olt_fsino[0];\r\n}\r\nstatic inline void\r\nvxfs_get_ilist(struct vxfs_oltilist *ilistp, struct vxfs_sb_info *infp)\r\n{\r\nBUG_ON(infp->vsi_iext);\r\ninfp->vsi_iext = ilistp->olt_iext[0];\r\n}\r\nstatic inline u_long\r\nvxfs_oblock(struct super_block *sbp, daddr_t block, u_long bsize)\r\n{\r\nBUG_ON(sbp->s_blocksize % bsize);\r\nreturn (block * (sbp->s_blocksize / bsize));\r\n}\r\nint\r\nvxfs_read_olt(struct super_block *sbp, u_long bsize)\r\n{\r\nstruct vxfs_sb_info *infp = VXFS_SBI(sbp);\r\nstruct buffer_head *bp;\r\nstruct vxfs_olt *op;\r\nchar *oaddr, *eaddr;\r\nbp = sb_bread(sbp, vxfs_oblock(sbp, infp->vsi_oltext, bsize));\r\nif (!bp || !bp->b_data)\r\ngoto fail;\r\nop = (struct vxfs_olt *)bp->b_data;\r\nif (op->olt_magic != VXFS_OLT_MAGIC) {\r\nprintk(KERN_NOTICE "vxfs: ivalid olt magic number\n");\r\ngoto fail;\r\n}\r\nif (infp->vsi_oltsize > 1) {\r\nprintk(KERN_NOTICE "vxfs: oltsize > 1 detected.\n");\r\nprintk(KERN_NOTICE "vxfs: please notify hch@infradead.org\n");\r\ngoto fail;\r\n}\r\noaddr = bp->b_data + op->olt_size;\r\neaddr = bp->b_data + (infp->vsi_oltsize * sbp->s_blocksize);\r\nwhile (oaddr < eaddr) {\r\nstruct vxfs_oltcommon *ocp =\r\n(struct vxfs_oltcommon *)oaddr;\r\nswitch (ocp->olt_type) {\r\ncase VXFS_OLT_FSHEAD:\r\nvxfs_get_fshead((struct vxfs_oltfshead *)oaddr, infp);\r\nbreak;\r\ncase VXFS_OLT_ILIST:\r\nvxfs_get_ilist((struct vxfs_oltilist *)oaddr, infp);\r\nbreak;\r\n}\r\noaddr += ocp->olt_size;\r\n}\r\nbrelse(bp);\r\nreturn 0;\r\nfail:\r\nbrelse(bp);\r\nreturn -EINVAL;\r\n}

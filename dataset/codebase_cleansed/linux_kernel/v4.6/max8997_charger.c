static int max8997_battery_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct charger_data *charger = power_supply_get_drvdata(psy);\r\nstruct i2c_client *i2c = charger->iodev->i2c;\r\nint ret;\r\nu8 reg;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nval->intval = 0;\r\nret = max8997_read_reg(i2c, MAX8997_REG_STATUS4, &reg);\r\nif (ret)\r\nreturn ret;\r\nif ((reg & (1 << 0)) == 0x1)\r\nval->intval = POWER_SUPPLY_STATUS_FULL;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = 0;\r\nret = max8997_read_reg(i2c, MAX8997_REG_STATUS4, &reg);\r\nif (ret)\r\nreturn ret;\r\nif ((reg & (1 << 2)) == 0x0)\r\nval->intval = 1;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = 0;\r\nret = max8997_read_reg(i2c, MAX8997_REG_STATUS4, &reg);\r\nif (ret)\r\nreturn ret;\r\nif (reg & (1 << 1))\r\nval->intval = 1;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8997_battery_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0;\r\nstruct charger_data *charger;\r\nstruct max8997_dev *iodev = dev_get_drvdata(pdev->dev.parent);\r\nstruct max8997_platform_data *pdata = dev_get_platdata(iodev->dev);\r\nstruct power_supply_config psy_cfg = {};\r\nif (!pdata)\r\nreturn -EINVAL;\r\nif (pdata->eoc_mA) {\r\nint val = (pdata->eoc_mA - 50) / 10;\r\nif (val < 0)\r\nval = 0;\r\nif (val > 0xf)\r\nval = 0xf;\r\nret = max8997_update_reg(iodev->i2c,\r\nMAX8997_REG_MBCCTRL5, val, 0xf);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Cannot use i2c bus.\n");\r\nreturn ret;\r\n}\r\n}\r\nswitch (pdata->timeout) {\r\ncase 5:\r\nret = max8997_update_reg(iodev->i2c, MAX8997_REG_MBCCTRL1,\r\n0x2 << 4, 0x7 << 4);\r\nbreak;\r\ncase 6:\r\nret = max8997_update_reg(iodev->i2c, MAX8997_REG_MBCCTRL1,\r\n0x3 << 4, 0x7 << 4);\r\nbreak;\r\ncase 7:\r\nret = max8997_update_reg(iodev->i2c, MAX8997_REG_MBCCTRL1,\r\n0x4 << 4, 0x7 << 4);\r\nbreak;\r\ncase 0:\r\nret = max8997_update_reg(iodev->i2c, MAX8997_REG_MBCCTRL1,\r\n0x7 << 4, 0x7 << 4);\r\nbreak;\r\ndefault:\r\ndev_err(&pdev->dev, "incorrect timeout value (%d)\n",\r\npdata->timeout);\r\nreturn -EINVAL;\r\n}\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Cannot use i2c bus.\n");\r\nreturn ret;\r\n}\r\ncharger = devm_kzalloc(&pdev->dev, sizeof(struct charger_data),\r\nGFP_KERNEL);\r\nif (charger == NULL) {\r\ndev_err(&pdev->dev, "Cannot allocate memory.\n");\r\nreturn -ENOMEM;\r\n}\r\nplatform_set_drvdata(pdev, charger);\r\ncharger->dev = &pdev->dev;\r\ncharger->iodev = iodev;\r\npsy_cfg.drv_data = charger;\r\ncharger->battery = power_supply_register(&pdev->dev,\r\n&max8997_battery_desc,\r\n&psy_cfg);\r\nif (IS_ERR(charger->battery)) {\r\ndev_err(&pdev->dev, "failed: power supply register\n");\r\nreturn PTR_ERR(charger->battery);\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8997_battery_remove(struct platform_device *pdev)\r\n{\r\nstruct charger_data *charger = platform_get_drvdata(pdev);\r\npower_supply_unregister(charger->battery);\r\nreturn 0;\r\n}\r\nstatic int __init max8997_battery_init(void)\r\n{\r\nreturn platform_driver_register(&max8997_battery_driver);\r\n}\r\nstatic void __exit max8997_battery_cleanup(void)\r\n{\r\nplatform_driver_unregister(&max8997_battery_driver);\r\n}

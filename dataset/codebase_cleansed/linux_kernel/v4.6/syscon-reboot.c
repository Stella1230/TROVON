static int syscon_restart_handle(struct notifier_block *this,\r\nunsigned long mode, void *cmd)\r\n{\r\nstruct syscon_reboot_context *ctx =\r\ncontainer_of(this, struct syscon_reboot_context,\r\nrestart_handler);\r\nregmap_write(ctx->map, ctx->offset, ctx->mask);\r\nmdelay(1000);\r\npr_emerg("Unable to restart system\n");\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int syscon_reboot_probe(struct platform_device *pdev)\r\n{\r\nstruct syscon_reboot_context *ctx;\r\nstruct device *dev = &pdev->dev;\r\nint err;\r\nctx = devm_kzalloc(&pdev->dev, sizeof(*ctx), GFP_KERNEL);\r\nif (!ctx)\r\nreturn -ENOMEM;\r\nctx->map = syscon_regmap_lookup_by_phandle(dev->of_node, "regmap");\r\nif (IS_ERR(ctx->map))\r\nreturn PTR_ERR(ctx->map);\r\nif (of_property_read_u32(pdev->dev.of_node, "offset", &ctx->offset))\r\nreturn -EINVAL;\r\nif (of_property_read_u32(pdev->dev.of_node, "mask", &ctx->mask))\r\nreturn -EINVAL;\r\nctx->restart_handler.notifier_call = syscon_restart_handle;\r\nctx->restart_handler.priority = 192;\r\nerr = register_restart_handler(&ctx->restart_handler);\r\nif (err)\r\ndev_err(dev, "can't register restart notifier (err=%d)\n", err);\r\nreturn err;\r\n}

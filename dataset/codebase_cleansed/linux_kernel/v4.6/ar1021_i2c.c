static irqreturn_t ar1021_i2c_irq(int irq, void *dev_id)\r\n{\r\nstruct ar1021_i2c *ar1021 = dev_id;\r\nstruct input_dev *input = ar1021->input;\r\nu8 *data = ar1021->data;\r\nunsigned int x, y, button;\r\nint retval;\r\nretval = i2c_master_recv(ar1021->client,\r\nar1021->data, sizeof(ar1021->data));\r\nif (retval != sizeof(ar1021->data))\r\ngoto out;\r\nif ((data[0] & 0x80) == 0)\r\ngoto out;\r\nbutton = data[0] & BIT(0);\r\nx = ((data[2] & 0x1f) << 7) | (data[1] & 0x7f);\r\ny = ((data[4] & 0x1f) << 7) | (data[3] & 0x7f);\r\ninput_report_abs(input, ABS_X, x);\r\ninput_report_abs(input, ABS_Y, y);\r\ninput_report_key(input, BTN_TOUCH, button);\r\ninput_sync(input);\r\nout:\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ar1021_i2c_open(struct input_dev *dev)\r\n{\r\nstruct ar1021_i2c *ar1021 = input_get_drvdata(dev);\r\nstruct i2c_client *client = ar1021->client;\r\nenable_irq(client->irq);\r\nreturn 0;\r\n}\r\nstatic void ar1021_i2c_close(struct input_dev *dev)\r\n{\r\nstruct ar1021_i2c *ar1021 = input_get_drvdata(dev);\r\nstruct i2c_client *client = ar1021->client;\r\ndisable_irq(client->irq);\r\n}\r\nstatic int ar1021_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct ar1021_i2c *ar1021;\r\nstruct input_dev *input;\r\nint error;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C)) {\r\ndev_err(&client->dev, "i2c_check_functionality error\n");\r\nreturn -ENXIO;\r\n}\r\nar1021 = devm_kzalloc(&client->dev, sizeof(*ar1021), GFP_KERNEL);\r\nif (!ar1021)\r\nreturn -ENOMEM;\r\ninput = devm_input_allocate_device(&client->dev);\r\nif (!input)\r\nreturn -ENOMEM;\r\nar1021->client = client;\r\nar1021->input = input;\r\ninput->name = "ar1021 I2C Touchscreen";\r\ninput->id.bustype = BUS_I2C;\r\ninput->dev.parent = &client->dev;\r\ninput->open = ar1021_i2c_open;\r\ninput->close = ar1021_i2c_close;\r\ninput_set_capability(input, EV_KEY, BTN_TOUCH);\r\ninput_set_abs_params(input, ABS_X, 0, AR1021_MAX_X, 0, 0);\r\ninput_set_abs_params(input, ABS_Y, 0, AR1021_MAX_Y, 0, 0);\r\ninput_set_drvdata(input, ar1021);\r\nerror = devm_request_threaded_irq(&client->dev, client->irq,\r\nNULL, ar1021_i2c_irq,\r\nIRQF_TRIGGER_RISING | IRQF_ONESHOT,\r\n"ar1021_i2c", ar1021);\r\nif (error) {\r\ndev_err(&client->dev,\r\n"Failed to enable IRQ, error: %d\n", error);\r\nreturn error;\r\n}\r\ndisable_irq(client->irq);\r\nerror = input_register_device(ar1021->input);\r\nif (error) {\r\ndev_err(&client->dev,\r\n"Failed to register input device, error: %d\n", error);\r\nreturn error;\r\n}\r\ni2c_set_clientdata(client, ar1021);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused ar1021_i2c_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\ndisable_irq(client->irq);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused ar1021_i2c_resume(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nenable_irq(client->irq);\r\nreturn 0;\r\n}

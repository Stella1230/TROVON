static inline long do_strncpy_from_user(char *dst, const char __user *src, long count, unsigned long max)\r\n{\r\nconst struct word_at_a_time constants = WORD_AT_A_TIME_CONSTANTS;\r\nlong res = 0;\r\nif (max > count)\r\nmax = count;\r\nif (IS_UNALIGNED(src, dst))\r\ngoto byte_at_a_time;\r\nwhile (max >= sizeof(unsigned long)) {\r\nunsigned long c, data;\r\nif (unlikely(unsafe_get_user(c,(unsigned long __user *)(src+res))))\r\nbreak;\r\n*(unsigned long *)(dst+res) = c;\r\nif (has_zero(c, &data, &constants)) {\r\ndata = prep_zero_mask(c, data, &constants);\r\ndata = create_zero_mask(data);\r\nreturn res + find_zero(data);\r\n}\r\nres += sizeof(unsigned long);\r\nmax -= sizeof(unsigned long);\r\n}\r\nbyte_at_a_time:\r\nwhile (max) {\r\nchar c;\r\nif (unlikely(unsafe_get_user(c,src+res)))\r\nreturn -EFAULT;\r\ndst[res] = c;\r\nif (!c)\r\nreturn res;\r\nres++;\r\nmax--;\r\n}\r\nif (res >= count)\r\nreturn res;\r\nreturn -EFAULT;\r\n}\r\nlong strncpy_from_user(char *dst, const char __user *src, long count)\r\n{\r\nunsigned long max_addr, src_addr;\r\nif (unlikely(count <= 0))\r\nreturn 0;\r\nmax_addr = user_addr_max();\r\nsrc_addr = (unsigned long)src;\r\nif (likely(src_addr < max_addr)) {\r\nunsigned long max = max_addr - src_addr;\r\nlong retval;\r\nuser_access_begin();\r\nretval = do_strncpy_from_user(dst, src, count, max);\r\nuser_access_end();\r\nreturn retval;\r\n}\r\nreturn -EFAULT;\r\n}

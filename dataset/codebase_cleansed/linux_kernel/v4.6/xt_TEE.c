static unsigned int\r\ntee_tg4(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct xt_tee_tginfo *info = par->targinfo;\r\nint oif = info->priv ? info->priv->oif : 0;\r\nnf_dup_ipv4(par->net, skb, par->hooknum, &info->gw.in, oif);\r\nreturn XT_CONTINUE;\r\n}\r\nstatic unsigned int\r\ntee_tg6(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct xt_tee_tginfo *info = par->targinfo;\r\nint oif = info->priv ? info->priv->oif : 0;\r\nnf_dup_ipv6(par->net, skb, par->hooknum, &info->gw.in6, oif);\r\nreturn XT_CONTINUE;\r\n}\r\nstatic int tee_netdev_event(struct notifier_block *this, unsigned long event,\r\nvoid *ptr)\r\n{\r\nstruct net_device *dev = netdev_notifier_info_to_dev(ptr);\r\nstruct xt_tee_priv *priv;\r\npriv = container_of(this, struct xt_tee_priv, notifier);\r\nswitch (event) {\r\ncase NETDEV_REGISTER:\r\nif (!strcmp(dev->name, priv->tginfo->oif))\r\npriv->oif = dev->ifindex;\r\nbreak;\r\ncase NETDEV_UNREGISTER:\r\nif (dev->ifindex == priv->oif)\r\npriv->oif = -1;\r\nbreak;\r\ncase NETDEV_CHANGENAME:\r\nif (!strcmp(dev->name, priv->tginfo->oif))\r\npriv->oif = dev->ifindex;\r\nelse if (dev->ifindex == priv->oif)\r\npriv->oif = -1;\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int tee_tg_check(const struct xt_tgchk_param *par)\r\n{\r\nstruct xt_tee_tginfo *info = par->targinfo;\r\nstruct xt_tee_priv *priv;\r\nif (memcmp(&info->gw, &tee_zero_address,\r\nsizeof(tee_zero_address)) == 0)\r\nreturn -EINVAL;\r\nif (info->oif[0]) {\r\nif (info->oif[sizeof(info->oif)-1] != '\0')\r\nreturn -EINVAL;\r\npriv = kzalloc(sizeof(*priv), GFP_KERNEL);\r\nif (priv == NULL)\r\nreturn -ENOMEM;\r\npriv->tginfo = info;\r\npriv->oif = -1;\r\npriv->notifier.notifier_call = tee_netdev_event;\r\ninfo->priv = priv;\r\nregister_netdevice_notifier(&priv->notifier);\r\n} else\r\ninfo->priv = NULL;\r\nstatic_key_slow_inc(&xt_tee_enabled);\r\nreturn 0;\r\n}\r\nstatic void tee_tg_destroy(const struct xt_tgdtor_param *par)\r\n{\r\nstruct xt_tee_tginfo *info = par->targinfo;\r\nif (info->priv) {\r\nunregister_netdevice_notifier(&info->priv->notifier);\r\nkfree(info->priv);\r\n}\r\nstatic_key_slow_dec(&xt_tee_enabled);\r\n}\r\nstatic int __init tee_tg_init(void)\r\n{\r\nreturn xt_register_targets(tee_tg_reg, ARRAY_SIZE(tee_tg_reg));\r\n}\r\nstatic void __exit tee_tg_exit(void)\r\n{\r\nxt_unregister_targets(tee_tg_reg, ARRAY_SIZE(tee_tg_reg));\r\n}

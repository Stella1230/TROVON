static inline void local_delay(unsigned long ms)\r\n{\r\nif (no_schedule)\r\nmdelay(ms);\r\nelse\r\nmsleep(ms);\r\n}\r\nstatic inline void debug_calc_bogomips(void)\r\n{\r\nunsigned long save_lpj = loops_per_jiffy;\r\ncalibrate_delay();\r\nloops_per_jiffy = save_lpj;\r\n}\r\nstatic int cpu_750fx_cpu_speed(int low_speed)\r\n{\r\nu32 hid2;\r\nif (low_speed == 0) {\r\npmac_call_feature(PMAC_FTR_WRITE_GPIO, NULL, voltage_gpio, 0x05);\r\nlocal_delay(10);\r\nif (has_cpu_l2lve) {\r\nhid2 = mfspr(SPRN_HID2);\r\nhid2 &= ~0x2000;\r\nmtspr(SPRN_HID2, hid2);\r\n}\r\n}\r\n#ifdef CONFIG_6xx\r\nlow_choose_750fx_pll(low_speed);\r\n#endif\r\nif (low_speed == 1) {\r\nif (has_cpu_l2lve) {\r\nhid2 = mfspr(SPRN_HID2);\r\nhid2 |= 0x2000;\r\nmtspr(SPRN_HID2, hid2);\r\n}\r\npmac_call_feature(PMAC_FTR_WRITE_GPIO, NULL, voltage_gpio, 0x04);\r\nlocal_delay(10);\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned int cpu_750fx_get_cpu_speed(void)\r\n{\r\nif (mfspr(SPRN_HID1) & HID1_PS)\r\nreturn low_freq;\r\nelse\r\nreturn hi_freq;\r\n}\r\nstatic int dfs_set_cpu_speed(int low_speed)\r\n{\r\nif (low_speed == 0) {\r\npmac_call_feature(PMAC_FTR_WRITE_GPIO, NULL, voltage_gpio, 0x05);\r\nlocal_delay(1);\r\n}\r\n#ifdef CONFIG_6xx\r\nlow_choose_7447a_dfs(low_speed);\r\n#endif\r\nudelay(100);\r\nif (low_speed == 1) {\r\npmac_call_feature(PMAC_FTR_WRITE_GPIO, NULL, voltage_gpio, 0x04);\r\nlocal_delay(1);\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned int dfs_get_cpu_speed(void)\r\n{\r\nif (mfspr(SPRN_HID1) & HID1_DFS)\r\nreturn low_freq;\r\nelse\r\nreturn hi_freq;\r\n}\r\nstatic int gpios_set_cpu_speed(int low_speed)\r\n{\r\nint gpio, timeout = 0;\r\nif (low_speed == 0) {\r\npmac_call_feature(PMAC_FTR_WRITE_GPIO, NULL, voltage_gpio, 0x05);\r\nlocal_delay(10);\r\n}\r\ngpio = pmac_call_feature(PMAC_FTR_READ_GPIO, NULL, frequency_gpio, 0);\r\nif (low_speed == ((gpio & 0x01) == 0))\r\ngoto skip;\r\npmac_call_feature(PMAC_FTR_WRITE_GPIO, NULL, frequency_gpio,\r\nlow_speed ? 0x04 : 0x05);\r\nudelay(200);\r\ndo {\r\nif (++timeout > 100)\r\nbreak;\r\nlocal_delay(1);\r\ngpio = pmac_call_feature(PMAC_FTR_READ_GPIO, NULL, slew_done_gpio, 0);\r\n} while((gpio & 0x02) == 0);\r\nskip:\r\nif (low_speed == 1) {\r\npmac_call_feature(PMAC_FTR_WRITE_GPIO, NULL, voltage_gpio, 0x04);\r\nlocal_delay(10);\r\n}\r\n#ifdef DEBUG_FREQ\r\ndebug_calc_bogomips();\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int pmu_set_cpu_speed(int low_speed)\r\n{\r\nstruct adb_request req;\r\nunsigned long save_l2cr;\r\nunsigned long save_l3cr;\r\nunsigned int pic_prio;\r\nunsigned long flags;\r\npreempt_disable();\r\n#ifdef DEBUG_FREQ\r\nprintk(KERN_DEBUG "HID1, before: %x\n", mfspr(SPRN_HID1));\r\n#endif\r\npmu_suspend();\r\npic_prio = mpic_cpu_get_priority();\r\nmpic_cpu_set_priority(0xf);\r\nasm volatile("mtdec %0" : : "r" (0x7fffffff));\r\nmb();\r\nasm volatile("mtdec %0" : : "r" (0x7fffffff));\r\nlocal_irq_save(flags);\r\nenable_kernel_fp();\r\n#ifdef CONFIG_ALTIVEC\r\nif (cpu_has_feature(CPU_FTR_ALTIVEC))\r\nenable_kernel_altivec();\r\n#endif\r\nsave_l3cr = _get_L3CR();\r\nsave_l2cr = _get_L2CR();\r\npmu_request(&req, NULL, 6, PMU_CPU_SPEED, 'W', 'O', 'O', 'F', low_speed);\r\nwhile (!req.complete)\r\npmu_poll();\r\npmac_call_feature(PMAC_FTR_SLEEP_STATE,NULL,1,1);\r\nlow_sleep_handler();\r\npmac_call_feature(PMAC_FTR_SLEEP_STATE,NULL,1,0);\r\nif (save_l2cr != 0xffffffff && (save_l2cr & L2CR_L2E) != 0)\r\n_set_L2CR(save_l2cr);\r\nif (save_l3cr != 0xffffffff && (save_l3cr & L3CR_L3E) != 0)\r\n_set_L3CR(save_l3cr);\r\nswitch_mmu_context(NULL, current->active_mm);\r\n#ifdef DEBUG_FREQ\r\nprintk(KERN_DEBUG "HID1, after: %x\n", mfspr(SPRN_HID1));\r\n#endif\r\npmu_unlock();\r\nset_dec(1);\r\nmpic_cpu_set_priority(pic_prio);\r\nlocal_irq_restore(flags);\r\n#ifdef DEBUG_FREQ\r\ndebug_calc_bogomips();\r\n#endif\r\npmu_resume();\r\npreempt_enable();\r\nreturn 0;\r\n}\r\nstatic int do_set_cpu_speed(struct cpufreq_policy *policy, int speed_mode)\r\n{\r\nunsigned long l3cr;\r\nstatic unsigned long prev_l3cr;\r\nif (speed_mode == CPUFREQ_LOW &&\r\ncpu_has_feature(CPU_FTR_L3CR)) {\r\nl3cr = _get_L3CR();\r\nif (l3cr & L3CR_L3E) {\r\nprev_l3cr = l3cr;\r\n_set_L3CR(0);\r\n}\r\n}\r\nset_speed_proc(speed_mode == CPUFREQ_LOW);\r\nif (speed_mode == CPUFREQ_HIGH &&\r\ncpu_has_feature(CPU_FTR_L3CR)) {\r\nl3cr = _get_L3CR();\r\nif ((prev_l3cr & L3CR_L3E) && l3cr != prev_l3cr)\r\n_set_L3CR(prev_l3cr);\r\n}\r\ncur_freq = (speed_mode == CPUFREQ_HIGH) ? hi_freq : low_freq;\r\nreturn 0;\r\n}\r\nstatic unsigned int pmac_cpufreq_get_speed(unsigned int cpu)\r\n{\r\nreturn cur_freq;\r\n}\r\nstatic int pmac_cpufreq_target( struct cpufreq_policy *policy,\r\nunsigned int index)\r\n{\r\nint rc;\r\nrc = do_set_cpu_speed(policy, index);\r\nppc_proc_freq = cur_freq * 1000ul;\r\nreturn rc;\r\n}\r\nstatic int pmac_cpufreq_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nreturn cpufreq_generic_init(policy, pmac_cpu_freqs, transition_latency);\r\n}\r\nstatic u32 read_gpio(struct device_node *np)\r\n{\r\nconst u32 *reg = of_get_property(np, "reg", NULL);\r\nu32 offset;\r\nif (reg == NULL)\r\nreturn 0;\r\noffset = *reg;\r\nif (offset < KEYLARGO_GPIO_LEVELS0)\r\noffset += KEYLARGO_GPIO_LEVELS0;\r\nreturn offset;\r\n}\r\nstatic int pmac_cpufreq_suspend(struct cpufreq_policy *policy)\r\n{\r\nno_schedule = 1;\r\nsleep_freq = cur_freq;\r\nif (cur_freq == low_freq && !is_pmu_based)\r\ndo_set_cpu_speed(policy, CPUFREQ_HIGH);\r\nreturn 0;\r\n}\r\nstatic int pmac_cpufreq_resume(struct cpufreq_policy *policy)\r\n{\r\nif (get_speed_proc)\r\ncur_freq = get_speed_proc();\r\nelse\r\ncur_freq = 0;\r\ndo_set_cpu_speed(policy, sleep_freq == low_freq ?\r\nCPUFREQ_LOW : CPUFREQ_HIGH);\r\nppc_proc_freq = cur_freq * 1000ul;\r\nno_schedule = 0;\r\nreturn 0;\r\n}\r\nstatic int pmac_cpufreq_init_MacRISC3(struct device_node *cpunode)\r\n{\r\nstruct device_node *volt_gpio_np = of_find_node_by_name(NULL,\r\n"voltage-gpio");\r\nstruct device_node *freq_gpio_np = of_find_node_by_name(NULL,\r\n"frequency-gpio");\r\nstruct device_node *slew_done_gpio_np = of_find_node_by_name(NULL,\r\n"slewing-done");\r\nconst u32 *value;\r\nif (volt_gpio_np)\r\nvoltage_gpio = read_gpio(volt_gpio_np);\r\nif (freq_gpio_np)\r\nfrequency_gpio = read_gpio(freq_gpio_np);\r\nif (slew_done_gpio_np)\r\nslew_done_gpio = read_gpio(slew_done_gpio_np);\r\nif (frequency_gpio && slew_done_gpio) {\r\nint lenp, rc;\r\nconst u32 *freqs, *ratio;\r\nfreqs = of_get_property(cpunode, "bus-frequencies", &lenp);\r\nlenp /= sizeof(u32);\r\nif (freqs == NULL || lenp != 2) {\r\nprintk(KERN_ERR "cpufreq: bus-frequencies incorrect or missing\n");\r\nreturn 1;\r\n}\r\nratio = of_get_property(cpunode, "processor-to-bus-ratio*2",\r\nNULL);\r\nif (ratio == NULL) {\r\nprintk(KERN_ERR "cpufreq: processor-to-bus-ratio*2 missing\n");\r\nreturn 1;\r\n}\r\nlow_freq = min(freqs[0], freqs[1]);\r\nhi_freq = max(freqs[0], freqs[1]);\r\nif (low_freq < 98000000)\r\nlow_freq = 101000000;\r\nlow_freq = (low_freq * (*ratio)) / 2000;\r\nhi_freq = (hi_freq * (*ratio)) / 2000;\r\nrc = pmac_call_feature(PMAC_FTR_READ_GPIO, NULL, frequency_gpio, 0);\r\ncur_freq = (rc & 0x01) ? hi_freq : low_freq;\r\nset_speed_proc = gpios_set_cpu_speed;\r\nreturn 1;\r\n}\r\nvalue = of_get_property(cpunode, "min-clock-frequency", NULL);\r\nif (!value)\r\nreturn 1;\r\nlow_freq = (*value) / 1000;\r\nif (low_freq < 100000)\r\nlow_freq *= 10;\r\nvalue = of_get_property(cpunode, "max-clock-frequency", NULL);\r\nif (!value)\r\nreturn 1;\r\nhi_freq = (*value) / 1000;\r\nset_speed_proc = pmu_set_cpu_speed;\r\nis_pmu_based = 1;\r\nreturn 0;\r\n}\r\nstatic int pmac_cpufreq_init_7447A(struct device_node *cpunode)\r\n{\r\nstruct device_node *volt_gpio_np;\r\nif (of_get_property(cpunode, "dynamic-power-step", NULL) == NULL)\r\nreturn 1;\r\nvolt_gpio_np = of_find_node_by_name(NULL, "cpu-vcore-select");\r\nif (volt_gpio_np)\r\nvoltage_gpio = read_gpio(volt_gpio_np);\r\nif (!voltage_gpio){\r\nprintk(KERN_ERR "cpufreq: missing cpu-vcore-select gpio\n");\r\nreturn 1;\r\n}\r\nhi_freq = cur_freq;\r\nlow_freq = cur_freq/2;\r\ncur_freq = dfs_get_cpu_speed();\r\nset_speed_proc = dfs_set_cpu_speed;\r\nget_speed_proc = dfs_get_cpu_speed;\r\nreturn 0;\r\n}\r\nstatic int pmac_cpufreq_init_750FX(struct device_node *cpunode)\r\n{\r\nstruct device_node *volt_gpio_np;\r\nu32 pvr;\r\nconst u32 *value;\r\nif (of_get_property(cpunode, "dynamic-power-step", NULL) == NULL)\r\nreturn 1;\r\nhi_freq = cur_freq;\r\nvalue = of_get_property(cpunode, "reduced-clock-frequency", NULL);\r\nif (!value)\r\nreturn 1;\r\nlow_freq = (*value) / 1000;\r\nvolt_gpio_np = of_find_node_by_name(NULL, "cpu-vcore-select");\r\nif (volt_gpio_np)\r\nvoltage_gpio = read_gpio(volt_gpio_np);\r\npvr = mfspr(SPRN_PVR);\r\nhas_cpu_l2lve = !((pvr & 0xf00) == 0x100);\r\nset_speed_proc = cpu_750fx_cpu_speed;\r\nget_speed_proc = cpu_750fx_get_cpu_speed;\r\ncur_freq = cpu_750fx_get_cpu_speed();\r\nreturn 0;\r\n}\r\nstatic int __init pmac_cpufreq_setup(void)\r\n{\r\nstruct device_node *cpunode;\r\nconst u32 *value;\r\nif (strstr(boot_command_line, "nocpufreq"))\r\nreturn 0;\r\ncpunode = of_cpu_device_node_get(0);\r\nif (!cpunode)\r\ngoto out;\r\nvalue = of_get_property(cpunode, "clock-frequency", NULL);\r\nif (!value)\r\ngoto out;\r\ncur_freq = (*value) / 1000;\r\ntransition_latency = CPUFREQ_ETERNAL;\r\nif (of_machine_is_compatible("MacRISC3") &&\r\nof_get_property(cpunode, "dynamic-power-step", NULL) &&\r\nPVR_VER(mfspr(SPRN_PVR)) == 0x8003) {\r\npmac_cpufreq_init_7447A(cpunode);\r\ntransition_latency = 8000000;\r\n} else if (of_machine_is_compatible("PowerBook3,4") ||\r\nof_machine_is_compatible("PowerBook3,5") ||\r\nof_machine_is_compatible("MacRISC3")) {\r\npmac_cpufreq_init_MacRISC3(cpunode);\r\n} else if (of_machine_is_compatible("PowerBook4,1")) {\r\nhi_freq = cur_freq;\r\nlow_freq = 400000;\r\nset_speed_proc = pmu_set_cpu_speed;\r\nis_pmu_based = 1;\r\n}\r\nelse if (of_machine_is_compatible("PowerBook3,3") && cur_freq == 550000) {\r\nhi_freq = cur_freq;\r\nlow_freq = 500000;\r\nset_speed_proc = pmu_set_cpu_speed;\r\nis_pmu_based = 1;\r\n}\r\nelse if (of_machine_is_compatible("PowerBook3,2")) {\r\nif (cur_freq < 350000 || cur_freq > 550000)\r\ngoto out;\r\nhi_freq = cur_freq;\r\nlow_freq = 300000;\r\nset_speed_proc = pmu_set_cpu_speed;\r\nis_pmu_based = 1;\r\n}\r\nelse if (PVR_VER(mfspr(SPRN_PVR)) == 0x7000)\r\npmac_cpufreq_init_750FX(cpunode);\r\nout:\r\nof_node_put(cpunode);\r\nif (set_speed_proc == NULL)\r\nreturn -ENODEV;\r\npmac_cpu_freqs[CPUFREQ_LOW].frequency = low_freq;\r\npmac_cpu_freqs[CPUFREQ_HIGH].frequency = hi_freq;\r\nppc_proc_freq = cur_freq * 1000ul;\r\nprintk(KERN_INFO "Registering PowerMac CPU frequency driver\n");\r\nprintk(KERN_INFO "Low: %d Mhz, High: %d Mhz, Boot: %d Mhz\n",\r\nlow_freq/1000, hi_freq/1000, cur_freq/1000);\r\nreturn cpufreq_register_driver(&pmac_cpufreq_driver);\r\n}

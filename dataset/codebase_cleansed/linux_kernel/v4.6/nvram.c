static ssize_t pSeries_nvram_read(char *buf, size_t count, loff_t *index)\r\n{\r\nunsigned int i;\r\nunsigned long len;\r\nint done;\r\nunsigned long flags;\r\nchar *p = buf;\r\nif (nvram_size == 0 || nvram_fetch == RTAS_UNKNOWN_SERVICE)\r\nreturn -ENODEV;\r\nif (*index >= nvram_size)\r\nreturn 0;\r\ni = *index;\r\nif (i + count > nvram_size)\r\ncount = nvram_size - i;\r\nspin_lock_irqsave(&nvram_lock, flags);\r\nfor (; count != 0; count -= len) {\r\nlen = count;\r\nif (len > NVRW_CNT)\r\nlen = NVRW_CNT;\r\nif ((rtas_call(nvram_fetch, 3, 2, &done, i, __pa(nvram_buf),\r\nlen) != 0) || len != done) {\r\nspin_unlock_irqrestore(&nvram_lock, flags);\r\nreturn -EIO;\r\n}\r\nmemcpy(p, nvram_buf, len);\r\np += len;\r\ni += len;\r\n}\r\nspin_unlock_irqrestore(&nvram_lock, flags);\r\n*index = i;\r\nreturn p - buf;\r\n}\r\nstatic ssize_t pSeries_nvram_write(char *buf, size_t count, loff_t *index)\r\n{\r\nunsigned int i;\r\nunsigned long len;\r\nint done;\r\nunsigned long flags;\r\nconst char *p = buf;\r\nif (nvram_size == 0 || nvram_store == RTAS_UNKNOWN_SERVICE)\r\nreturn -ENODEV;\r\nif (*index >= nvram_size)\r\nreturn 0;\r\ni = *index;\r\nif (i + count > nvram_size)\r\ncount = nvram_size - i;\r\nspin_lock_irqsave(&nvram_lock, flags);\r\nfor (; count != 0; count -= len) {\r\nlen = count;\r\nif (len > NVRW_CNT)\r\nlen = NVRW_CNT;\r\nmemcpy(nvram_buf, p, len);\r\nif ((rtas_call(nvram_store, 3, 2, &done, i, __pa(nvram_buf),\r\nlen) != 0) || len != done) {\r\nspin_unlock_irqrestore(&nvram_lock, flags);\r\nreturn -EIO;\r\n}\r\np += len;\r\ni += len;\r\n}\r\nspin_unlock_irqrestore(&nvram_lock, flags);\r\n*index = i;\r\nreturn p - buf;\r\n}\r\nstatic ssize_t pSeries_nvram_get_size(void)\r\n{\r\nreturn nvram_size ? nvram_size : -ENODEV;\r\n}\r\nint nvram_write_error_log(char * buff, int length,\r\nunsigned int err_type, unsigned int error_log_cnt)\r\n{\r\nint rc = nvram_write_os_partition(&rtas_log_partition, buff, length,\r\nerr_type, error_log_cnt);\r\nif (!rc) {\r\nlast_unread_rtas_event = ktime_get_real_seconds();\r\n#ifdef CONFIG_PSTORE\r\nlast_rtas_event = ktime_get_real_seconds();\r\n#endif\r\n}\r\nreturn rc;\r\n}\r\nint nvram_read_error_log(char *buff, int length,\r\nunsigned int *err_type, unsigned int *error_log_cnt)\r\n{\r\nreturn nvram_read_partition(&rtas_log_partition, buff, length,\r\nerr_type, error_log_cnt);\r\n}\r\nint nvram_clear_error_log(void)\r\n{\r\nloff_t tmp_index;\r\nint clear_word = ERR_FLAG_ALREADY_LOGGED;\r\nint rc;\r\nif (rtas_log_partition.index == -1)\r\nreturn -1;\r\ntmp_index = rtas_log_partition.index;\r\nrc = ppc_md.nvram_write((char *)&clear_word, sizeof(int), &tmp_index);\r\nif (rc <= 0) {\r\nprintk(KERN_ERR "nvram_clear_error_log: Failed nvram_write (%d)\n", rc);\r\nreturn rc;\r\n}\r\nlast_unread_rtas_event = 0;\r\nreturn 0;\r\n}\r\nint clobbering_unread_rtas_event(void)\r\n{\r\nreturn (oops_log_partition.index == rtas_log_partition.index\r\n&& last_unread_rtas_event\r\n&& ktime_get_real_seconds() - last_unread_rtas_event <=\r\nNVRAM_RTAS_READ_TIMEOUT);\r\n}\r\nstatic int __init pseries_nvram_init_log_partitions(void)\r\n{\r\nint rc;\r\nnvram_scan_partitions();\r\nrc = nvram_init_os_partition(&rtas_log_partition);\r\nnvram_init_oops_partition(rc == 0);\r\nreturn 0;\r\n}\r\nint __init pSeries_nvram_init(void)\r\n{\r\nstruct device_node *nvram;\r\nconst __be32 *nbytes_p;\r\nunsigned int proplen;\r\nnvram = of_find_node_by_type(NULL, "nvram");\r\nif (nvram == NULL)\r\nreturn -ENODEV;\r\nnbytes_p = of_get_property(nvram, "#bytes", &proplen);\r\nif (nbytes_p == NULL || proplen != sizeof(unsigned int)) {\r\nof_node_put(nvram);\r\nreturn -EIO;\r\n}\r\nnvram_size = be32_to_cpup(nbytes_p);\r\nnvram_fetch = rtas_token("nvram-fetch");\r\nnvram_store = rtas_token("nvram-store");\r\nprintk(KERN_INFO "PPC64 nvram contains %d bytes\n", nvram_size);\r\nof_node_put(nvram);\r\nppc_md.nvram_read = pSeries_nvram_read;\r\nppc_md.nvram_write = pSeries_nvram_write;\r\nppc_md.nvram_size = pSeries_nvram_get_size;\r\nreturn 0;\r\n}

static int __gen_74x164_write_config(struct gen_74x164_chip *chip)\r\n{\r\nstruct spi_transfer xfer = {\r\n.tx_buf = chip->buffer,\r\n.len = chip->registers,\r\n};\r\nreturn spi_sync_transfer(to_spi_device(chip->gpio_chip.parent),\r\n&xfer, 1);\r\n}\r\nstatic int gen_74x164_get_value(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct gen_74x164_chip *chip = gpiochip_get_data(gc);\r\nu8 bank = chip->registers - 1 - offset / 8;\r\nu8 pin = offset % 8;\r\nint ret;\r\nmutex_lock(&chip->lock);\r\nret = (chip->buffer[bank] >> pin) & 0x1;\r\nmutex_unlock(&chip->lock);\r\nreturn ret;\r\n}\r\nstatic void gen_74x164_set_value(struct gpio_chip *gc,\r\nunsigned offset, int val)\r\n{\r\nstruct gen_74x164_chip *chip = gpiochip_get_data(gc);\r\nu8 bank = chip->registers - 1 - offset / 8;\r\nu8 pin = offset % 8;\r\nmutex_lock(&chip->lock);\r\nif (val)\r\nchip->buffer[bank] |= (1 << pin);\r\nelse\r\nchip->buffer[bank] &= ~(1 << pin);\r\n__gen_74x164_write_config(chip);\r\nmutex_unlock(&chip->lock);\r\n}\r\nstatic int gen_74x164_direction_output(struct gpio_chip *gc,\r\nunsigned offset, int val)\r\n{\r\ngen_74x164_set_value(gc, offset, val);\r\nreturn 0;\r\n}\r\nstatic int gen_74x164_probe(struct spi_device *spi)\r\n{\r\nstruct gen_74x164_chip *chip;\r\nu32 nregs;\r\nint ret;\r\nspi->bits_per_word = 8;\r\nret = spi_setup(spi);\r\nif (ret < 0)\r\nreturn ret;\r\nif (of_property_read_u32(spi->dev.of_node, "registers-number",\r\n&nregs)) {\r\ndev_err(&spi->dev,\r\n"Missing registers-number property in the DT.\n");\r\nreturn -EINVAL;\r\n}\r\nchip = devm_kzalloc(&spi->dev, sizeof(*chip) + nregs, GFP_KERNEL);\r\nif (!chip)\r\nreturn -ENOMEM;\r\nspi_set_drvdata(spi, chip);\r\nchip->gpio_chip.label = spi->modalias;\r\nchip->gpio_chip.direction_output = gen_74x164_direction_output;\r\nchip->gpio_chip.get = gen_74x164_get_value;\r\nchip->gpio_chip.set = gen_74x164_set_value;\r\nchip->gpio_chip.base = -1;\r\nchip->registers = nregs;\r\nchip->gpio_chip.ngpio = GEN_74X164_NUMBER_GPIOS * chip->registers;\r\nchip->gpio_chip.can_sleep = true;\r\nchip->gpio_chip.parent = &spi->dev;\r\nchip->gpio_chip.owner = THIS_MODULE;\r\nmutex_init(&chip->lock);\r\nret = __gen_74x164_write_config(chip);\r\nif (ret) {\r\ndev_err(&spi->dev, "Failed writing: %d\n", ret);\r\ngoto exit_destroy;\r\n}\r\nret = gpiochip_add_data(&chip->gpio_chip, chip);\r\nif (!ret)\r\nreturn 0;\r\nexit_destroy:\r\nmutex_destroy(&chip->lock);\r\nreturn ret;\r\n}\r\nstatic int gen_74x164_remove(struct spi_device *spi)\r\n{\r\nstruct gen_74x164_chip *chip = spi_get_drvdata(spi);\r\ngpiochip_remove(&chip->gpio_chip);\r\nmutex_destroy(&chip->lock);\r\nreturn 0;\r\n}

int mips_dsemul(struct pt_regs *regs, mips_instruction ir, unsigned long cpc)\r\n{\r\nint isa16 = get_isa16_mode(regs->cp0_epc);\r\nmips_instruction break_math;\r\nstruct emuframe __user *fr;\r\nint err;\r\nif (ir == 0)\r\nreturn -1;\r\nif (isa16) {\r\nunion mips_instruction insn = { .word = ir };\r\nif ((ir >> 16) == MM_NOP16)\r\nreturn -1;\r\nif (insn.mm_a_format.opcode == mm_addiupc_op) {\r\nunsigned int rs;\r\ns32 v;\r\nrs = (((insn.mm_a_format.rs + 0x1e) & 0xf) + 2);\r\nv = regs->cp0_epc & ~3;\r\nv += insn.mm_a_format.simmediate << 2;\r\nregs->regs[rs] = (long)v;\r\nreturn -1;\r\n}\r\n}\r\npr_debug("dsemul %lx %lx\n", regs->cp0_epc, cpc);\r\nbreak_math = BREAK_MATH(isa16);\r\nfr = (struct emuframe __user *)\r\n((regs->regs[29] - sizeof(struct emuframe)) & ~0x7);\r\nif (unlikely(!access_ok(VERIFY_WRITE, fr, sizeof(struct emuframe))))\r\nreturn SIGBUS;\r\nif (isa16) {\r\nerr = __put_user(ir >> 16,\r\n(u16 __user *)(&fr->emul));\r\nerr |= __put_user(ir & 0xffff,\r\n(u16 __user *)((long)(&fr->emul) + 2));\r\nerr |= __put_user(break_math >> 16,\r\n(u16 __user *)(&fr->badinst));\r\nerr |= __put_user(break_math & 0xffff,\r\n(u16 __user *)((long)(&fr->badinst) + 2));\r\n} else {\r\nerr = __put_user(ir, &fr->emul);\r\nerr |= __put_user(break_math, &fr->badinst);\r\n}\r\nerr |= __put_user((mips_instruction)BD_COOKIE, &fr->cookie);\r\nerr |= __put_user(cpc, &fr->epc);\r\nif (unlikely(err)) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\nreturn SIGBUS;\r\n}\r\nregs->cp0_epc = (unsigned long)&fr->emul | isa16;\r\nflush_cache_sigtramp((unsigned long)&fr->emul);\r\nreturn 0;\r\n}\r\nint do_dsemulret(struct pt_regs *xcp)\r\n{\r\nint isa16 = get_isa16_mode(xcp->cp0_epc);\r\nstruct emuframe __user *fr;\r\nunsigned long epc;\r\nu32 insn, cookie;\r\nint err = 0;\r\nu16 instr[2];\r\nfr = (struct emuframe __user *)\r\n(msk_isa16_mode(xcp->cp0_epc) - sizeof(mips_instruction));\r\nif (!access_ok(VERIFY_READ, fr, sizeof(struct emuframe)))\r\nreturn 0;\r\nif (isa16) {\r\nerr = __get_user(instr[0],\r\n(u16 __user *)(&fr->badinst));\r\nerr |= __get_user(instr[1],\r\n(u16 __user *)((long)(&fr->badinst) + 2));\r\ninsn = (instr[0] << 16) | instr[1];\r\n} else {\r\nerr = __get_user(insn, &fr->badinst);\r\n}\r\nerr |= __get_user(cookie, &fr->cookie);\r\nif (unlikely(err ||\r\ninsn != BREAK_MATH(isa16) || cookie != BD_COOKIE)) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\nreturn 0;\r\n}\r\npr_debug("dsemulret\n");\r\nif (__get_user(epc, &fr->epc)) {\r\nforce_sig(SIGBUS, current);\r\nreturn 0;\r\n}\r\nxcp->cp0_epc = epc;\r\nMIPS_FPU_EMU_INC_STATS(ds_emul);\r\nreturn 1;\r\n}

static int wf_lm75_get(struct wf_sensor *sr, s32 *value)\r\n{\r\nstruct wf_lm75_sensor *lm = wf_to_lm75(sr);\r\ns32 data;\r\nif (lm->i2c == NULL)\r\nreturn -ENODEV;\r\nif (!lm->inited) {\r\nu8 cfg_new, cfg = (u8)i2c_smbus_read_byte_data(lm->i2c, 1);\r\nDBG("wf_lm75: Initializing %s, cfg was: %02x\n",\r\nsr->name, cfg);\r\ncfg_new = cfg & ~0x01;\r\ni2c_smbus_write_byte_data(lm->i2c, 1, cfg_new);\r\nlm->inited = 1;\r\nmsleep(200);\r\n}\r\ndata = (s32)le16_to_cpu(i2c_smbus_read_word_data(lm->i2c, 0));\r\ndata <<= 8;\r\n*value = data;\r\nreturn 0;\r\n}\r\nstatic void wf_lm75_release(struct wf_sensor *sr)\r\n{\r\nstruct wf_lm75_sensor *lm = wf_to_lm75(sr);\r\nkfree(lm);\r\n}\r\nstatic int wf_lm75_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct wf_lm75_sensor *lm;\r\nint rc, ds1775 = id->driver_data;\r\nconst char *name, *loc;\r\nDBG("wf_lm75: creating %s device at address 0x%02x\n",\r\nds1775 ? "ds1775" : "lm75", client->addr);\r\nloc = of_get_property(client->dev.of_node, "hwsensor-location", NULL);\r\nif (!loc) {\r\ndev_warn(&client->dev, "Missing hwsensor-location property!\n");\r\nreturn -ENXIO;\r\n}\r\nif (!strcmp(loc, "Hard drive") || !strcmp(loc, "DRIVE BAY"))\r\nname = "hd-temp";\r\nelse if (!strcmp(loc, "Incoming Air Temp"))\r\nname = "incoming-air-temp";\r\nelse if (!strcmp(loc, "ODD Temp"))\r\nname = "optical-drive-temp";\r\nelse if (!strcmp(loc, "HD Temp"))\r\nname = "hard-drive-temp";\r\nelse if (!strcmp(loc, "PCI SLOTS"))\r\nname = "slots-temp";\r\nelse if (!strcmp(loc, "CPU A INLET"))\r\nname = "cpu-inlet-temp-0";\r\nelse if (!strcmp(loc, "CPU B INLET"))\r\nname = "cpu-inlet-temp-1";\r\nelse\r\nreturn -ENXIO;\r\nlm = kzalloc(sizeof(struct wf_lm75_sensor), GFP_KERNEL);\r\nif (lm == NULL)\r\nreturn -ENODEV;\r\nlm->inited = 0;\r\nlm->ds1775 = ds1775;\r\nlm->i2c = client;\r\nlm->sens.name = name;\r\nlm->sens.ops = &wf_lm75_ops;\r\ni2c_set_clientdata(client, lm);\r\nrc = wf_register_sensor(&lm->sens);\r\nif (rc)\r\nkfree(lm);\r\nreturn rc;\r\n}\r\nstatic int wf_lm75_remove(struct i2c_client *client)\r\n{\r\nstruct wf_lm75_sensor *lm = i2c_get_clientdata(client);\r\nDBG("wf_lm75: i2c detatch called for %s\n", lm->sens.name);\r\nlm->i2c = NULL;\r\nwf_unregister_sensor(&lm->sens);\r\nreturn 0;\r\n}

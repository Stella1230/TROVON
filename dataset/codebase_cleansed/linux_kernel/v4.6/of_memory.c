const struct lpddr2_min_tck *of_get_min_tck(struct device_node *np,\r\nstruct device *dev)\r\n{\r\nint ret = 0;\r\nstruct lpddr2_min_tck *min;\r\nmin = devm_kzalloc(dev, sizeof(*min), GFP_KERNEL);\r\nif (!min)\r\ngoto default_min_tck;\r\nret |= of_property_read_u32(np, "tRPab-min-tck", &min->tRPab);\r\nret |= of_property_read_u32(np, "tRCD-min-tck", &min->tRCD);\r\nret |= of_property_read_u32(np, "tWR-min-tck", &min->tWR);\r\nret |= of_property_read_u32(np, "tRASmin-min-tck", &min->tRASmin);\r\nret |= of_property_read_u32(np, "tRRD-min-tck", &min->tRRD);\r\nret |= of_property_read_u32(np, "tWTR-min-tck", &min->tWTR);\r\nret |= of_property_read_u32(np, "tXP-min-tck", &min->tXP);\r\nret |= of_property_read_u32(np, "tRTP-min-tck", &min->tRTP);\r\nret |= of_property_read_u32(np, "tCKE-min-tck", &min->tCKE);\r\nret |= of_property_read_u32(np, "tCKESR-min-tck", &min->tCKESR);\r\nret |= of_property_read_u32(np, "tFAW-min-tck", &min->tFAW);\r\nif (ret) {\r\ndevm_kfree(dev, min);\r\ngoto default_min_tck;\r\n}\r\nreturn min;\r\ndefault_min_tck:\r\ndev_warn(dev, "%s: using default min-tck values\n", __func__);\r\nreturn &lpddr2_jedec_min_tck;\r\n}\r\nstatic int of_do_get_timings(struct device_node *np,\r\nstruct lpddr2_timings *tim)\r\n{\r\nint ret;\r\nret = of_property_read_u32(np, "max-freq", &tim->max_freq);\r\nret |= of_property_read_u32(np, "min-freq", &tim->min_freq);\r\nret |= of_property_read_u32(np, "tRPab", &tim->tRPab);\r\nret |= of_property_read_u32(np, "tRCD", &tim->tRCD);\r\nret |= of_property_read_u32(np, "tWR", &tim->tWR);\r\nret |= of_property_read_u32(np, "tRAS-min", &tim->tRAS_min);\r\nret |= of_property_read_u32(np, "tRRD", &tim->tRRD);\r\nret |= of_property_read_u32(np, "tWTR", &tim->tWTR);\r\nret |= of_property_read_u32(np, "tXP", &tim->tXP);\r\nret |= of_property_read_u32(np, "tRTP", &tim->tRTP);\r\nret |= of_property_read_u32(np, "tCKESR", &tim->tCKESR);\r\nret |= of_property_read_u32(np, "tDQSCK-max", &tim->tDQSCK_max);\r\nret |= of_property_read_u32(np, "tFAW", &tim->tFAW);\r\nret |= of_property_read_u32(np, "tZQCS", &tim->tZQCS);\r\nret |= of_property_read_u32(np, "tZQCL", &tim->tZQCL);\r\nret |= of_property_read_u32(np, "tZQinit", &tim->tZQinit);\r\nret |= of_property_read_u32(np, "tRAS-max-ns", &tim->tRAS_max_ns);\r\nret |= of_property_read_u32(np, "tDQSCK-max-derated",\r\n&tim->tDQSCK_max_derated);\r\nreturn ret;\r\n}\r\nconst struct lpddr2_timings *of_get_ddr_timings(struct device_node *np_ddr,\r\nstruct device *dev, u32 device_type, u32 *nr_frequencies)\r\n{\r\nstruct lpddr2_timings *timings = NULL;\r\nu32 arr_sz = 0, i = 0;\r\nstruct device_node *np_tim;\r\nchar *tim_compat;\r\nswitch (device_type) {\r\ncase DDR_TYPE_LPDDR2_S2:\r\ncase DDR_TYPE_LPDDR2_S4:\r\ntim_compat = "jedec,lpddr2-timings";\r\nbreak;\r\ndefault:\r\ndev_warn(dev, "%s: un-supported memory type\n", __func__);\r\n}\r\nfor_each_child_of_node(np_ddr, np_tim)\r\nif (of_device_is_compatible(np_tim, tim_compat))\r\narr_sz++;\r\nif (arr_sz)\r\ntimings = devm_kzalloc(dev, sizeof(*timings) * arr_sz,\r\nGFP_KERNEL);\r\nif (!timings)\r\ngoto default_timings;\r\nfor_each_child_of_node(np_ddr, np_tim) {\r\nif (of_device_is_compatible(np_tim, tim_compat)) {\r\nif (of_do_get_timings(np_tim, &timings[i])) {\r\ndevm_kfree(dev, timings);\r\ngoto default_timings;\r\n}\r\ni++;\r\n}\r\n}\r\n*nr_frequencies = arr_sz;\r\nreturn timings;\r\ndefault_timings:\r\ndev_warn(dev, "%s: using default timings\n", __func__);\r\n*nr_frequencies = ARRAY_SIZE(lpddr2_jedec_timings);\r\nreturn lpddr2_jedec_timings;\r\n}

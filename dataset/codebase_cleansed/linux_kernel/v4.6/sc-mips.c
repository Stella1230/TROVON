static void mips_sc_wback_inv(unsigned long addr, unsigned long size)\r\n{\r\nblast_scache_range(addr, addr + size);\r\n}\r\nstatic void mips_sc_inv(unsigned long addr, unsigned long size)\r\n{\r\nunsigned long lsize = cpu_scache_line_size();\r\nunsigned long almask = ~(lsize - 1);\r\ncache_op(Hit_Writeback_Inv_SD, addr & almask);\r\ncache_op(Hit_Writeback_Inv_SD, (addr + size - 1) & almask);\r\nblast_inv_scache_range(addr, addr + size);\r\n}\r\nstatic void mips_sc_enable(void)\r\n{\r\n}\r\nstatic void mips_sc_disable(void)\r\n{\r\n}\r\nstatic void mips_sc_prefetch_enable(void)\r\n{\r\nunsigned long pftctl;\r\nif (mips_cm_revision() < CM_REV_CM2_5)\r\nreturn;\r\npftctl = read_gcr_l2_pft_control();\r\nif (pftctl & CM_GCR_L2_PFT_CONTROL_NPFT_MSK) {\r\npftctl &= ~CM_GCR_L2_PFT_CONTROL_PAGEMASK_MSK;\r\npftctl |= PAGE_MASK & CM_GCR_L2_PFT_CONTROL_PAGEMASK_MSK;\r\npftctl |= CM_GCR_L2_PFT_CONTROL_PFTEN_MSK;\r\nwrite_gcr_l2_pft_control(pftctl);\r\npftctl = read_gcr_l2_pft_control_b();\r\npftctl |= CM_GCR_L2_PFT_CONTROL_B_PORTID_MSK;\r\npftctl |= CM_GCR_L2_PFT_CONTROL_B_CEN_MSK;\r\nwrite_gcr_l2_pft_control_b(pftctl);\r\n}\r\n}\r\nstatic void mips_sc_prefetch_disable(void)\r\n{\r\nunsigned long pftctl;\r\nif (mips_cm_revision() < CM_REV_CM2_5)\r\nreturn;\r\npftctl = read_gcr_l2_pft_control();\r\npftctl &= ~CM_GCR_L2_PFT_CONTROL_PFTEN_MSK;\r\nwrite_gcr_l2_pft_control(pftctl);\r\npftctl = read_gcr_l2_pft_control_b();\r\npftctl &= ~CM_GCR_L2_PFT_CONTROL_B_PORTID_MSK;\r\npftctl &= ~CM_GCR_L2_PFT_CONTROL_B_CEN_MSK;\r\nwrite_gcr_l2_pft_control_b(pftctl);\r\n}\r\nstatic bool mips_sc_prefetch_is_enabled(void)\r\n{\r\nunsigned long pftctl;\r\nif (mips_cm_revision() < CM_REV_CM2_5)\r\nreturn false;\r\npftctl = read_gcr_l2_pft_control();\r\nif (!(pftctl & CM_GCR_L2_PFT_CONTROL_NPFT_MSK))\r\nreturn false;\r\nreturn !!(pftctl & CM_GCR_L2_PFT_CONTROL_PFTEN_MSK);\r\n}\r\nstatic inline int mips_sc_is_activated(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config2 = read_c0_config2();\r\nunsigned int tmp;\r\nswitch (current_cpu_type()) {\r\ncase CPU_34K:\r\ncase CPU_74K:\r\ncase CPU_1004K:\r\ncase CPU_1074K:\r\ncase CPU_INTERAPTIV:\r\ncase CPU_PROAPTIV:\r\ncase CPU_P5600:\r\ncase CPU_BMIPS5000:\r\ncase CPU_QEMU_GENERIC:\r\nif (config2 & (1 << 12))\r\nreturn 0;\r\n}\r\ntmp = (config2 >> 4) & 0x0f;\r\nif (0 < tmp && tmp <= 7)\r\nc->scache.linesz = 2 << tmp;\r\nelse\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int __init mips_sc_probe_cm3(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nunsigned long cfg = read_gcr_l2_config();\r\nunsigned long sets, line_sz, assoc;\r\nif (cfg & CM_GCR_L2_CONFIG_BYPASS_MSK)\r\nreturn 0;\r\nsets = cfg & CM_GCR_L2_CONFIG_SET_SIZE_MSK;\r\nsets >>= CM_GCR_L2_CONFIG_SET_SIZE_SHF;\r\nif (sets)\r\nc->scache.sets = 64 << sets;\r\nline_sz = cfg & CM_GCR_L2_CONFIG_LINE_SIZE_MSK;\r\nline_sz >>= CM_GCR_L2_CONFIG_LINE_SIZE_SHF;\r\nif (line_sz)\r\nc->scache.linesz = 2 << line_sz;\r\nassoc = cfg & CM_GCR_L2_CONFIG_ASSOC_MSK;\r\nassoc >>= CM_GCR_L2_CONFIG_ASSOC_SHF;\r\nc->scache.ways = assoc + 1;\r\nc->scache.waysize = c->scache.sets * c->scache.linesz;\r\nc->scache.waybit = __ffs(c->scache.waysize);\r\nif (c->scache.linesz) {\r\nc->scache.flags &= ~MIPS_CACHE_NOT_PRESENT;\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int __init mips_sc_probe(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nunsigned int config1, config2;\r\nunsigned int tmp;\r\nc->scache.flags |= MIPS_CACHE_NOT_PRESENT;\r\nif (mips_cm_revision() >= CM_REV_CM3)\r\nreturn mips_sc_probe_cm3();\r\nif (!(c->isa_level & (MIPS_CPU_ISA_M32R1 | MIPS_CPU_ISA_M32R2 |\r\nMIPS_CPU_ISA_M32R6 | MIPS_CPU_ISA_M64R1 |\r\nMIPS_CPU_ISA_M64R2 | MIPS_CPU_ISA_M64R6)))\r\nreturn 0;\r\nconfig1 = read_c0_config1();\r\nif (!(config1 & MIPS_CONF_M))\r\nreturn 0;\r\nconfig2 = read_c0_config2();\r\nif (!mips_sc_is_activated(c))\r\nreturn 0;\r\ntmp = (config2 >> 8) & 0x0f;\r\nif (tmp <= 7)\r\nc->scache.sets = 64 << tmp;\r\nelse\r\nreturn 0;\r\ntmp = (config2 >> 0) & 0x0f;\r\nif (tmp <= 7)\r\nc->scache.ways = tmp + 1;\r\nelse\r\nreturn 0;\r\nc->scache.waysize = c->scache.sets * c->scache.linesz;\r\nc->scache.waybit = __ffs(c->scache.waysize);\r\nc->scache.flags &= ~MIPS_CACHE_NOT_PRESENT;\r\nreturn 1;\r\n}\r\nint mips_sc_init(void)\r\n{\r\nint found = mips_sc_probe();\r\nif (found) {\r\nmips_sc_enable();\r\nmips_sc_prefetch_enable();\r\nbcops = &mips_sc_ops;\r\n}\r\nreturn found;\r\n}

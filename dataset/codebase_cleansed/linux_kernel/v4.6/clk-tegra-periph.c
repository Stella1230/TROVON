static void __init periph_clk_init(void __iomem *clk_base,\r\nstruct tegra_clk *tegra_clks)\r\n{\r\nint i;\r\nstruct clk *clk;\r\nstruct clk **dt_clk;\r\nfor (i = 0; i < ARRAY_SIZE(periph_clks); i++) {\r\nstruct tegra_clk_periph_regs *bank;\r\nstruct tegra_periph_init_data *data;\r\ndata = periph_clks + i;\r\ndt_clk = tegra_lookup_dt_id(data->clk_id, tegra_clks);\r\nif (!dt_clk)\r\ncontinue;\r\nbank = get_reg_bank(data->periph.gate.clk_num);\r\nif (!bank)\r\ncontinue;\r\ndata->periph.gate.regs = bank;\r\nclk = tegra_clk_register_periph(data->name,\r\ndata->p.parent_names, data->num_parents,\r\n&data->periph, clk_base, data->offset,\r\ndata->flags);\r\n*dt_clk = clk;\r\n}\r\n}\r\nstatic void __init gate_clk_init(void __iomem *clk_base,\r\nstruct tegra_clk *tegra_clks)\r\n{\r\nint i;\r\nstruct clk *clk;\r\nstruct clk **dt_clk;\r\nfor (i = 0; i < ARRAY_SIZE(gate_clks); i++) {\r\nstruct tegra_periph_init_data *data;\r\ndata = gate_clks + i;\r\ndt_clk = tegra_lookup_dt_id(data->clk_id, tegra_clks);\r\nif (!dt_clk)\r\ncontinue;\r\nclk = tegra_clk_register_periph_gate(data->name,\r\ndata->p.parent_name, data->periph.gate.flags,\r\nclk_base, data->flags,\r\ndata->periph.gate.clk_num,\r\nperiph_clk_enb_refcnt);\r\n*dt_clk = clk;\r\n}\r\n}\r\nstatic void __init div_clk_init(void __iomem *clk_base,\r\nstruct tegra_clk *tegra_clks)\r\n{\r\nint i;\r\nstruct clk *clk;\r\nstruct clk **dt_clk;\r\nfor (i = 0; i < ARRAY_SIZE(div_clks); i++) {\r\nstruct tegra_periph_init_data *data;\r\ndata = div_clks + i;\r\ndt_clk = tegra_lookup_dt_id(data->clk_id, tegra_clks);\r\nif (!dt_clk)\r\ncontinue;\r\nclk = tegra_clk_register_divider(data->name,\r\ndata->p.parent_name, clk_base + data->offset,\r\ndata->flags, data->periph.divider.flags,\r\ndata->periph.divider.shift,\r\ndata->periph.divider.width,\r\ndata->periph.divider.frac_width,\r\ndata->periph.divider.lock);\r\n*dt_clk = clk;\r\n}\r\n}\r\nstatic void __init init_pllp(void __iomem *clk_base, void __iomem *pmc_base,\r\nstruct tegra_clk *tegra_clks,\r\nstruct tegra_clk_pll_params *pll_params)\r\n{\r\nstruct clk *clk;\r\nstruct clk **dt_clk;\r\nint i;\r\ndt_clk = tegra_lookup_dt_id(tegra_clk_pll_p, tegra_clks);\r\nif (dt_clk) {\r\nclk = tegra_clk_register_pll("pll_p", "pll_ref", clk_base,\r\npmc_base, 0, pll_params, NULL);\r\nclk_register_clkdev(clk, "pll_p", NULL);\r\n*dt_clk = clk;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(pllp_out_clks); i++) {\r\nstruct pll_out_data *data;\r\ndata = pllp_out_clks + i;\r\ndt_clk = tegra_lookup_dt_id(data->clk_id, tegra_clks);\r\nif (!dt_clk)\r\ncontinue;\r\nclk = tegra_clk_register_divider(data->div_name, "pll_p",\r\nclk_base + data->offset, 0, data->div_flags,\r\ndata->div_shift, 8, 1, data->lock);\r\nclk = tegra_clk_register_pll_out(data->pll_out_name,\r\ndata->div_name, clk_base + data->offset,\r\ndata->rst_shift + 1, data->rst_shift,\r\nCLK_IGNORE_UNUSED | CLK_SET_RATE_PARENT, 0,\r\ndata->lock);\r\n*dt_clk = clk;\r\n}\r\ndt_clk = tegra_lookup_dt_id(tegra_clk_pll_p_out_cpu,\r\ntegra_clks);\r\nif (dt_clk) {\r\nclk = tegra_clk_register_divider("pll_p_out4_div",\r\n"pll_p_out_cpu", clk_base + PLLP_OUTB, 0, 0, 24,\r\n8, 1, &PLLP_OUTB_lock);\r\ndt_clk = tegra_lookup_dt_id(tegra_clk_pll_p_out4_cpu, tegra_clks);\r\nif (dt_clk) {\r\nclk = tegra_clk_register_pll_out("pll_p_out4",\r\n"pll_p_out4_div", clk_base + PLLP_OUTB,\r\n17, 16, CLK_IGNORE_UNUSED |\r\nCLK_SET_RATE_PARENT, 0,\r\n&PLLP_OUTB_lock);\r\n*dt_clk = clk;\r\n}\r\n}\r\ndt_clk = tegra_lookup_dt_id(tegra_clk_pll_p_out_hsio, tegra_clks);\r\nif (dt_clk) {\r\nclk = clk_register_gate(NULL, "pll_p_out_hsio", "pll_p",\r\nCLK_SET_RATE_PARENT | CLK_IGNORE_UNUSED,\r\nclk_base + PLLP_MISC1, 29, 0, NULL);\r\n*dt_clk = clk;\r\n}\r\ndt_clk = tegra_lookup_dt_id(tegra_clk_pll_p_out_xusb, tegra_clks);\r\nif (dt_clk) {\r\nclk = clk_register_gate(NULL, "pll_p_out_xusb",\r\n"pll_p_out_hsio", CLK_SET_RATE_PARENT |\r\nCLK_IGNORE_UNUSED, clk_base + PLLP_MISC1, 28, 0,\r\nNULL);\r\nclk_register_clkdev(clk, "pll_p_out_xusb", NULL);\r\n*dt_clk = clk;\r\n}\r\n}\r\nvoid __init tegra_periph_clk_init(void __iomem *clk_base,\r\nvoid __iomem *pmc_base, struct tegra_clk *tegra_clks,\r\nstruct tegra_clk_pll_params *pll_params)\r\n{\r\ninit_pllp(clk_base, pmc_base, tegra_clks, pll_params);\r\nperiph_clk_init(clk_base, tegra_clks);\r\ngate_clk_init(clk_base, tegra_clks);\r\ndiv_clk_init(clk_base, tegra_clks);\r\n}

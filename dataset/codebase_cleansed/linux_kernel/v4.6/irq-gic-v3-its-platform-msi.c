static int its_pmsi_prepare(struct irq_domain *domain, struct device *dev,\r\nint nvec, msi_alloc_info_t *info)\r\n{\r\nstruct msi_domain_info *msi_info;\r\nu32 dev_id;\r\nint ret, index = 0;\r\nmsi_info = msi_get_domain_info(domain->parent);\r\ndo {\r\nstruct of_phandle_args args;\r\nret = of_parse_phandle_with_args(dev->of_node,\r\n"msi-parent", "#msi-cells",\r\nindex, &args);\r\nif (args.np == irq_domain_get_of_node(domain)) {\r\nif (WARN_ON(args.args_count != 1))\r\nreturn -EINVAL;\r\ndev_id = args.args[0];\r\nbreak;\r\n}\r\n} while (!ret);\r\nif (ret)\r\nreturn ret;\r\ninfo->scratchpad[0].ul = dev_id;\r\nreturn msi_info->ops->msi_prepare(domain->parent,\r\ndev, nvec, info);\r\n}\r\nstatic int __init its_pmsi_init(void)\r\n{\r\nstruct device_node *np;\r\nstruct irq_domain *parent;\r\nfor (np = of_find_matching_node(NULL, its_device_id); np;\r\nnp = of_find_matching_node(np, its_device_id)) {\r\nif (!of_property_read_bool(np, "msi-controller"))\r\ncontinue;\r\nparent = irq_find_matching_host(np, DOMAIN_BUS_NEXUS);\r\nif (!parent || !msi_get_domain_info(parent)) {\r\npr_err("%s: unable to locate ITS domain\n",\r\nnp->full_name);\r\ncontinue;\r\n}\r\nif (!platform_msi_create_irq_domain(of_node_to_fwnode(np),\r\n&its_pmsi_domain_info,\r\nparent)) {\r\npr_err("%s: unable to create platform domain\n",\r\nnp->full_name);\r\ncontinue;\r\n}\r\npr_info("Platform MSI: %s domain created\n", np->full_name);\r\n}\r\nreturn 0;\r\n}

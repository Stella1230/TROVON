static void tcp_diag_get_info(struct sock *sk, struct inet_diag_msg *r,\r\nvoid *_info)\r\n{\r\nstruct tcp_info *info = _info;\r\nif (sk_state_load(sk) == TCP_LISTEN) {\r\nr->idiag_rqueue = sk->sk_ack_backlog;\r\nr->idiag_wqueue = sk->sk_max_ack_backlog;\r\n} else if (sk->sk_type == SOCK_STREAM) {\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nr->idiag_rqueue = max_t(int, tp->rcv_nxt - tp->copied_seq, 0);\r\nr->idiag_wqueue = tp->write_seq - tp->snd_una;\r\n}\r\nif (info)\r\ntcp_get_info(sk, info);\r\n}\r\nstatic void tcp_diag_dump(struct sk_buff *skb, struct netlink_callback *cb,\r\nconst struct inet_diag_req_v2 *r, struct nlattr *bc)\r\n{\r\ninet_diag_dump_icsk(&tcp_hashinfo, skb, cb, r, bc);\r\n}\r\nstatic int tcp_diag_dump_one(struct sk_buff *in_skb, const struct nlmsghdr *nlh,\r\nconst struct inet_diag_req_v2 *req)\r\n{\r\nreturn inet_diag_dump_one_icsk(&tcp_hashinfo, in_skb, nlh, req);\r\n}\r\nstatic int tcp_diag_destroy(struct sk_buff *in_skb,\r\nconst struct inet_diag_req_v2 *req)\r\n{\r\nstruct net *net = sock_net(in_skb->sk);\r\nstruct sock *sk = inet_diag_find_one_icsk(net, &tcp_hashinfo, req);\r\nif (IS_ERR(sk))\r\nreturn PTR_ERR(sk);\r\nreturn sock_diag_destroy(sk, ECONNABORTED);\r\n}\r\nstatic int __init tcp_diag_init(void)\r\n{\r\nreturn inet_diag_register(&tcp_diag_handler);\r\n}\r\nstatic void __exit tcp_diag_exit(void)\r\n{\r\ninet_diag_unregister(&tcp_diag_handler);\r\n}

static int ali15x3_setup(struct pci_dev *ALI15X3_dev)\r\n{\r\nu16 a;\r\nunsigned char temp;\r\npci_read_config_byte(ALI15X3_dev, SMBATPC, &temp);\r\nif (temp & ALI15X3_LOCK) {\r\ntemp &= ~ALI15X3_LOCK;\r\npci_write_config_byte(ALI15X3_dev, SMBATPC, temp);\r\n}\r\npci_read_config_word(ALI15X3_dev, SMBBA, &ali15x3_smba);\r\nali15x3_smba &= (0xffff & ~(ALI15X3_SMB_IOSIZE - 1));\r\nif (ali15x3_smba == 0 && force_addr == 0) {\r\ndev_err(&ALI15X3_dev->dev, "ALI15X3_smb region uninitialized "\r\n"- upgrade BIOS or use force_addr=0xaddr\n");\r\nreturn -ENODEV;\r\n}\r\nif(force_addr)\r\nali15x3_smba = force_addr & ~(ALI15X3_SMB_IOSIZE - 1);\r\nif (acpi_check_region(ali15x3_smba, ALI15X3_SMB_IOSIZE,\r\nali15x3_driver.name))\r\nreturn -EBUSY;\r\nif (!request_region(ali15x3_smba, ALI15X3_SMB_IOSIZE,\r\nali15x3_driver.name)) {\r\ndev_err(&ALI15X3_dev->dev,\r\n"ALI15X3_smb region 0x%x already in use!\n",\r\nali15x3_smba);\r\nreturn -ENODEV;\r\n}\r\nif(force_addr) {\r\ndev_info(&ALI15X3_dev->dev, "forcing ISA address 0x%04X\n",\r\nali15x3_smba);\r\nif (PCIBIOS_SUCCESSFUL != pci_write_config_word(ALI15X3_dev,\r\nSMBBA,\r\nali15x3_smba))\r\ngoto error;\r\nif (PCIBIOS_SUCCESSFUL != pci_read_config_word(ALI15X3_dev,\r\nSMBBA, &a))\r\ngoto error;\r\nif ((a & ~(ALI15X3_SMB_IOSIZE - 1)) != ali15x3_smba) {\r\ndev_err(&ALI15X3_dev->dev,\r\n"force address failed - not supported?\n");\r\ngoto error;\r\n}\r\n}\r\npci_read_config_byte(ALI15X3_dev, SMBCOM, &temp);\r\nif ((temp & 1) == 0) {\r\ndev_info(&ALI15X3_dev->dev, "enabling SMBus device\n");\r\npci_write_config_byte(ALI15X3_dev, SMBCOM, temp | 0x01);\r\n}\r\npci_read_config_byte(ALI15X3_dev, SMBHSTCFG, &temp);\r\nif ((temp & 1) == 0) {\r\ndev_info(&ALI15X3_dev->dev, "enabling SMBus controller\n");\r\npci_write_config_byte(ALI15X3_dev, SMBHSTCFG, temp | 0x01);\r\n}\r\npci_write_config_byte(ALI15X3_dev, SMBCLK, 0x20);\r\npci_read_config_byte(ALI15X3_dev, SMBREV, &temp);\r\ndev_dbg(&ALI15X3_dev->dev, "SMBREV = 0x%X\n", temp);\r\ndev_dbg(&ALI15X3_dev->dev, "iALI15X3_smba = 0x%X\n", ali15x3_smba);\r\nreturn 0;\r\nerror:\r\nrelease_region(ali15x3_smba, ALI15X3_SMB_IOSIZE);\r\nreturn -ENODEV;\r\n}\r\nstatic int ali15x3_transaction(struct i2c_adapter *adap)\r\n{\r\nint temp;\r\nint result = 0;\r\nint timeout = 0;\r\ndev_dbg(&adap->dev, "Transaction (pre): STS=%02x, CNT=%02x, CMD=%02x, "\r\n"ADD=%02x, DAT0=%02x, DAT1=%02x\n", inb_p(SMBHSTSTS),\r\ninb_p(SMBHSTCNT), inb_p(SMBHSTCMD), inb_p(SMBHSTADD),\r\ninb_p(SMBHSTDAT0), inb_p(SMBHSTDAT1));\r\ntemp = inb_p(SMBHSTSTS);\r\nif (temp & ALI15X3_STS_BUSY) {\r\ndev_info(&adap->dev, "Resetting entire SMB Bus to "\r\n"clear busy condition (%02x)\n", temp);\r\noutb_p(ALI15X3_T_OUT, SMBHSTCNT);\r\ntemp = inb_p(SMBHSTSTS);\r\n}\r\nif (temp & (ALI15X3_STS_ERR | ALI15X3_STS_BUSY)) {\r\noutb_p(0xFF, SMBHSTSTS);\r\nif ((temp = inb_p(SMBHSTSTS)) &\r\n(ALI15X3_STS_ERR | ALI15X3_STS_BUSY)) {\r\ndev_err(&adap->dev, "SMBus reset failed! (0x%02x) - "\r\n"controller or device on bus is probably hung\n",\r\ntemp);\r\nreturn -EBUSY;\r\n}\r\n} else {\r\nif (temp & ALI15X3_STS_DONE) {\r\noutb_p(temp, SMBHSTSTS);\r\n}\r\n}\r\noutb_p(0xFF, SMBHSTSTART);\r\ntimeout = 0;\r\ndo {\r\nmsleep(1);\r\ntemp = inb_p(SMBHSTSTS);\r\n} while ((!(temp & (ALI15X3_STS_ERR | ALI15X3_STS_DONE)))\r\n&& (timeout++ < MAX_TIMEOUT));\r\nif (timeout > MAX_TIMEOUT) {\r\nresult = -ETIMEDOUT;\r\ndev_err(&adap->dev, "SMBus Timeout!\n");\r\n}\r\nif (temp & ALI15X3_STS_TERM) {\r\nresult = -EIO;\r\ndev_dbg(&adap->dev, "Error: Failed bus transaction\n");\r\n}\r\nif (temp & ALI15X3_STS_COLL) {\r\nresult = -ENXIO;\r\ndev_dbg(&adap->dev,\r\n"Error: no response or bus collision ADD=%02x\n",\r\ninb_p(SMBHSTADD));\r\n}\r\nif (temp & ALI15X3_STS_DEV) {\r\nresult = -EIO;\r\ndev_err(&adap->dev, "Error: device error\n");\r\n}\r\ndev_dbg(&adap->dev, "Transaction (post): STS=%02x, CNT=%02x, CMD=%02x, "\r\n"ADD=%02x, DAT0=%02x, DAT1=%02x\n", inb_p(SMBHSTSTS),\r\ninb_p(SMBHSTCNT), inb_p(SMBHSTCMD), inb_p(SMBHSTADD),\r\ninb_p(SMBHSTDAT0), inb_p(SMBHSTDAT1));\r\nreturn result;\r\n}\r\nstatic s32 ali15x3_access(struct i2c_adapter * adap, u16 addr,\r\nunsigned short flags, char read_write, u8 command,\r\nint size, union i2c_smbus_data * data)\r\n{\r\nint i, len;\r\nint temp;\r\nint timeout;\r\noutb_p(0xFF, SMBHSTSTS);\r\ntemp = inb_p(SMBHSTSTS);\r\nfor (timeout = 0;\r\n(timeout < MAX_TIMEOUT) && !(temp & ALI15X3_STS_IDLE);\r\ntimeout++) {\r\nmsleep(1);\r\ntemp = inb_p(SMBHSTSTS);\r\n}\r\nif (timeout >= MAX_TIMEOUT) {\r\ndev_err(&adap->dev, "Idle wait Timeout! STS=0x%02x\n", temp);\r\n}\r\nswitch (size) {\r\ncase I2C_SMBUS_QUICK:\r\noutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMBHSTADD);\r\nsize = ALI15X3_QUICK;\r\nbreak;\r\ncase I2C_SMBUS_BYTE:\r\noutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMBHSTADD);\r\nif (read_write == I2C_SMBUS_WRITE)\r\noutb_p(command, SMBHSTCMD);\r\nsize = ALI15X3_BYTE;\r\nbreak;\r\ncase I2C_SMBUS_BYTE_DATA:\r\noutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMBHSTADD);\r\noutb_p(command, SMBHSTCMD);\r\nif (read_write == I2C_SMBUS_WRITE)\r\noutb_p(data->byte, SMBHSTDAT0);\r\nsize = ALI15X3_BYTE_DATA;\r\nbreak;\r\ncase I2C_SMBUS_WORD_DATA:\r\noutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMBHSTADD);\r\noutb_p(command, SMBHSTCMD);\r\nif (read_write == I2C_SMBUS_WRITE) {\r\noutb_p(data->word & 0xff, SMBHSTDAT0);\r\noutb_p((data->word & 0xff00) >> 8, SMBHSTDAT1);\r\n}\r\nsize = ALI15X3_WORD_DATA;\r\nbreak;\r\ncase I2C_SMBUS_BLOCK_DATA:\r\noutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\r\nSMBHSTADD);\r\noutb_p(command, SMBHSTCMD);\r\nif (read_write == I2C_SMBUS_WRITE) {\r\nlen = data->block[0];\r\nif (len < 0) {\r\nlen = 0;\r\ndata->block[0] = len;\r\n}\r\nif (len > 32) {\r\nlen = 32;\r\ndata->block[0] = len;\r\n}\r\noutb_p(len, SMBHSTDAT0);\r\noutb_p(inb_p(SMBHSTCNT) | ALI15X3_BLOCK_CLR, SMBHSTCNT);\r\nfor (i = 1; i <= len; i++)\r\noutb_p(data->block[i], SMBBLKDAT);\r\n}\r\nsize = ALI15X3_BLOCK_DATA;\r\nbreak;\r\ndefault:\r\ndev_warn(&adap->dev, "Unsupported transaction %d\n", size);\r\nreturn -EOPNOTSUPP;\r\n}\r\noutb_p(size, SMBHSTCNT);\r\ntemp = ali15x3_transaction(adap);\r\nif (temp)\r\nreturn temp;\r\nif ((read_write == I2C_SMBUS_WRITE) || (size == ALI15X3_QUICK))\r\nreturn 0;\r\nswitch (size) {\r\ncase ALI15X3_BYTE:\r\ndata->byte = inb_p(SMBHSTDAT0);\r\nbreak;\r\ncase ALI15X3_BYTE_DATA:\r\ndata->byte = inb_p(SMBHSTDAT0);\r\nbreak;\r\ncase ALI15X3_WORD_DATA:\r\ndata->word = inb_p(SMBHSTDAT0) + (inb_p(SMBHSTDAT1) << 8);\r\nbreak;\r\ncase ALI15X3_BLOCK_DATA:\r\nlen = inb_p(SMBHSTDAT0);\r\nif (len > 32)\r\nlen = 32;\r\ndata->block[0] = len;\r\noutb_p(inb_p(SMBHSTCNT) | ALI15X3_BLOCK_CLR, SMBHSTCNT);\r\nfor (i = 1; i <= data->block[0]; i++) {\r\ndata->block[i] = inb_p(SMBBLKDAT);\r\ndev_dbg(&adap->dev, "Blk: len=%d, i=%d, data=%02x\n",\r\nlen, i, data->block[i]);\r\n}\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic u32 ali15x3_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_SMBUS_QUICK | I2C_FUNC_SMBUS_BYTE |\r\nI2C_FUNC_SMBUS_BYTE_DATA | I2C_FUNC_SMBUS_WORD_DATA |\r\nI2C_FUNC_SMBUS_BLOCK_DATA;\r\n}\r\nstatic int ali15x3_probe(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nif (ali15x3_setup(dev)) {\r\ndev_err(&dev->dev,\r\n"ALI15X3 not detected, module not inserted.\n");\r\nreturn -ENODEV;\r\n}\r\nali15x3_adapter.dev.parent = &dev->dev;\r\nsnprintf(ali15x3_adapter.name, sizeof(ali15x3_adapter.name),\r\n"SMBus ALI15X3 adapter at %04x", ali15x3_smba);\r\nreturn i2c_add_adapter(&ali15x3_adapter);\r\n}\r\nstatic void ali15x3_remove(struct pci_dev *dev)\r\n{\r\ni2c_del_adapter(&ali15x3_adapter);\r\nrelease_region(ali15x3_smba, ALI15X3_SMB_IOSIZE);\r\n}

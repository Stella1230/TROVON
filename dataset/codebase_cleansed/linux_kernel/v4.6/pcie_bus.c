static\r\nvoid wil_set_capabilities(struct wil6210_priv *wil)\r\n{\r\nu32 rev_id = wil_r(wil, RGF_USER_JTAG_DEV_ID);\r\nbitmap_zero(wil->hw_capabilities, hw_capability_last);\r\nswitch (rev_id) {\r\ncase JTAG_DEV_ID_SPARROW_B0:\r\nwil->hw_name = "Sparrow B0";\r\nwil->hw_version = HW_VER_SPARROW_B0;\r\nbreak;\r\ndefault:\r\nwil_err(wil, "Unknown board hardware 0x%08x\n", rev_id);\r\nwil->hw_name = "Unknown";\r\nwil->hw_version = HW_VER_UNKNOWN;\r\n}\r\nwil_info(wil, "Board hardware is %s\n", wil->hw_name);\r\n}\r\nvoid wil_disable_irq(struct wil6210_priv *wil)\r\n{\r\ndisable_irq(wil->pdev->irq);\r\n}\r\nvoid wil_enable_irq(struct wil6210_priv *wil)\r\n{\r\nenable_irq(wil->pdev->irq);\r\n}\r\nstatic int wil_if_pcie_enable(struct wil6210_priv *wil)\r\n{\r\nstruct pci_dev *pdev = wil->pdev;\r\nint rc;\r\nint msi_only = pdev->msi_enabled;\r\nbool _use_msi = use_msi;\r\nwil_dbg_misc(wil, "%s()\n", __func__);\r\npdev->msi_enabled = 0;\r\npci_set_master(pdev);\r\nwil_dbg_misc(wil, "Setup %s interrupt\n", use_msi ? "MSI" : "INTx");\r\nif (use_msi && pci_enable_msi(pdev)) {\r\nwil_err(wil, "pci_enable_msi failed, use INTx\n");\r\n_use_msi = false;\r\n}\r\nif (!_use_msi && msi_only) {\r\nwil_err(wil, "Interrupt pin not routed, unable to use INTx\n");\r\nrc = -ENODEV;\r\ngoto stop_master;\r\n}\r\nrc = wil6210_init_irq(wil, pdev->irq, _use_msi);\r\nif (rc)\r\ngoto stop_master;\r\nmutex_lock(&wil->mutex);\r\nrc = wil_reset(wil, false);\r\nmutex_unlock(&wil->mutex);\r\nif (rc)\r\ngoto release_irq;\r\nreturn 0;\r\nrelease_irq:\r\nwil6210_fini_irq(wil, pdev->irq);\r\npci_disable_msi(pdev);\r\nstop_master:\r\npci_clear_master(pdev);\r\nreturn rc;\r\n}\r\nstatic int wil_if_pcie_disable(struct wil6210_priv *wil)\r\n{\r\nstruct pci_dev *pdev = wil->pdev;\r\nwil_dbg_misc(wil, "%s()\n", __func__);\r\npci_clear_master(pdev);\r\nwil6210_fini_irq(wil, pdev->irq);\r\npci_disable_msi(pdev);\r\nreturn 0;\r\n}\r\nstatic int wil_platform_rop_ramdump(void *wil_handle, void *buf, uint32_t size)\r\n{\r\nstruct wil6210_priv *wil = wil_handle;\r\nif (!wil)\r\nreturn -EINVAL;\r\nreturn wil_fw_copy_crash_dump(wil, buf, size);\r\n}\r\nstatic int wil_platform_rop_fw_recovery(void *wil_handle)\r\n{\r\nstruct wil6210_priv *wil = wil_handle;\r\nif (!wil)\r\nreturn -EINVAL;\r\nwil_fw_error_recovery(wil);\r\nreturn 0;\r\n}\r\nstatic int wil_pcie_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstruct wil6210_priv *wil;\r\nstruct device *dev = &pdev->dev;\r\nint rc;\r\nconst struct wil_platform_rops rops = {\r\n.ramdump = wil_platform_rop_ramdump,\r\n.fw_recovery = wil_platform_rop_fw_recovery,\r\n};\r\ndev_info(&pdev->dev, WIL_NAME\r\n" device found [%04x:%04x] (rev %x)\n",\r\n(int)pdev->vendor, (int)pdev->device, (int)pdev->revision);\r\nif (pci_resource_len(pdev, 0) != WIL6210_MEM_SIZE) {\r\ndev_err(&pdev->dev, "Not " WIL_NAME "? "\r\n"BAR0 size is %lu while expecting %lu\n",\r\n(ulong)pci_resource_len(pdev, 0), WIL6210_MEM_SIZE);\r\nreturn -ENODEV;\r\n}\r\nwil = wil_if_alloc(dev);\r\nif (IS_ERR(wil)) {\r\nrc = (int)PTR_ERR(wil);\r\ndev_err(dev, "wil_if_alloc failed: %d\n", rc);\r\nreturn rc;\r\n}\r\nwil->pdev = pdev;\r\npci_set_drvdata(pdev, wil);\r\nwil->platform_handle =\r\nwil_platform_init(&pdev->dev, &wil->platform_ops, &rops, wil);\r\nif (!wil->platform_handle) {\r\nrc = -ENODEV;\r\nwil_err(wil, "wil_platform_init failed\n");\r\ngoto if_free;\r\n}\r\nrc = pci_enable_device(pdev);\r\nif (rc) {\r\nwil_err(wil,\r\n"pci_enable_device failed, retry with MSI only\n");\r\npdev->msi_enabled = 1;\r\nrc = pci_enable_device(pdev);\r\n}\r\nif (rc) {\r\nwil_err(wil,\r\n"pci_enable_device failed, even with MSI only\n");\r\ngoto err_plat;\r\n}\r\nrc = pci_request_region(pdev, 0, WIL_NAME);\r\nif (rc) {\r\nwil_err(wil, "pci_request_region failed\n");\r\ngoto err_disable_pdev;\r\n}\r\nwil->csr = pci_ioremap_bar(pdev, 0);\r\nif (!wil->csr) {\r\nwil_err(wil, "pci_ioremap_bar failed\n");\r\nrc = -ENODEV;\r\ngoto err_release_reg;\r\n}\r\nwil_info(wil, "CSR at %pR -> 0x%p\n", &pdev->resource[0], wil->csr);\r\nwil_set_capabilities(wil);\r\nwil6210_clear_irq(wil);\r\nrc = wil_if_pcie_enable(wil);\r\nif (rc) {\r\nwil_err(wil, "Enable device failed\n");\r\ngoto err_iounmap;\r\n}\r\nrc = wil_if_add(wil);\r\nif (rc) {\r\nwil_err(wil, "wil_if_add failed: %d\n", rc);\r\ngoto bus_disable;\r\n}\r\nwil6210_debugfs_init(wil);\r\nreturn 0;\r\nbus_disable:\r\nwil_if_pcie_disable(wil);\r\nerr_iounmap:\r\npci_iounmap(pdev, wil->csr);\r\nerr_release_reg:\r\npci_release_region(pdev, 0);\r\nerr_disable_pdev:\r\npci_disable_device(pdev);\r\nerr_plat:\r\nif (wil->platform_ops.uninit)\r\nwil->platform_ops.uninit(wil->platform_handle);\r\nif_free:\r\nwil_if_free(wil);\r\nreturn rc;\r\n}\r\nstatic void wil_pcie_remove(struct pci_dev *pdev)\r\n{\r\nstruct wil6210_priv *wil = pci_get_drvdata(pdev);\r\nvoid __iomem *csr = wil->csr;\r\nwil_dbg_misc(wil, "%s()\n", __func__);\r\nwil6210_debugfs_remove(wil);\r\nwil_if_remove(wil);\r\nwil_if_pcie_disable(wil);\r\npci_iounmap(pdev, csr);\r\npci_release_region(pdev, 0);\r\npci_disable_device(pdev);\r\nif (wil->platform_ops.uninit)\r\nwil->platform_ops.uninit(wil->platform_handle);\r\nwil_if_free(wil);\r\n}\r\nstatic int wil6210_suspend(struct device *dev, bool is_runtime)\r\n{\r\nint rc = 0;\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct wil6210_priv *wil = pci_get_drvdata(pdev);\r\nwil_dbg_pm(wil, "%s(%s)\n", __func__,\r\nis_runtime ? "runtime" : "system");\r\nrc = wil_can_suspend(wil, is_runtime);\r\nif (rc)\r\ngoto out;\r\nrc = wil_suspend(wil, is_runtime);\r\nif (rc)\r\ngoto out;\r\npci_clear_master(pdev);\r\nout:\r\nreturn rc;\r\n}\r\nstatic int wil6210_resume(struct device *dev, bool is_runtime)\r\n{\r\nint rc = 0;\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct wil6210_priv *wil = pci_get_drvdata(pdev);\r\nwil_dbg_pm(wil, "%s(%s)\n", __func__,\r\nis_runtime ? "runtime" : "system");\r\npci_set_master(pdev);\r\nrc = wil_resume(wil, is_runtime);\r\nif (rc)\r\npci_clear_master(pdev);\r\nreturn rc;\r\n}\r\nstatic int wil6210_pm_suspend(struct device *dev)\r\n{\r\nreturn wil6210_suspend(dev, false);\r\n}\r\nstatic int wil6210_pm_resume(struct device *dev)\r\n{\r\nreturn wil6210_resume(dev, false);\r\n}\r\nstatic int __init wil6210_driver_init(void)\r\n{\r\nint rc;\r\nrc = wil_platform_modinit();\r\nif (rc)\r\nreturn rc;\r\nrc = pci_register_driver(&wil6210_driver);\r\nif (rc)\r\nwil_platform_modexit();\r\nreturn rc;\r\n}\r\nstatic void __exit wil6210_driver_exit(void)\r\n{\r\npci_unregister_driver(&wil6210_driver);\r\nwil_platform_modexit();\r\n}

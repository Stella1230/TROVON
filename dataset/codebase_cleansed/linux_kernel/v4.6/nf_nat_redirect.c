unsigned int\r\nnf_nat_redirect_ipv4(struct sk_buff *skb,\r\nconst struct nf_nat_ipv4_multi_range_compat *mr,\r\nunsigned int hooknum)\r\n{\r\nstruct nf_conn *ct;\r\nenum ip_conntrack_info ctinfo;\r\n__be32 newdst;\r\nstruct nf_nat_range newrange;\r\nNF_CT_ASSERT(hooknum == NF_INET_PRE_ROUTING ||\r\nhooknum == NF_INET_LOCAL_OUT);\r\nct = nf_ct_get(skb, &ctinfo);\r\nNF_CT_ASSERT(ct && (ctinfo == IP_CT_NEW || ctinfo == IP_CT_RELATED));\r\nif (hooknum == NF_INET_LOCAL_OUT) {\r\nnewdst = htonl(0x7F000001);\r\n} else {\r\nstruct in_device *indev;\r\nstruct in_ifaddr *ifa;\r\nnewdst = 0;\r\nrcu_read_lock();\r\nindev = __in_dev_get_rcu(skb->dev);\r\nif (indev && indev->ifa_list) {\r\nifa = indev->ifa_list;\r\nnewdst = ifa->ifa_local;\r\n}\r\nrcu_read_unlock();\r\nif (!newdst)\r\nreturn NF_DROP;\r\n}\r\nmemset(&newrange.min_addr, 0, sizeof(newrange.min_addr));\r\nmemset(&newrange.max_addr, 0, sizeof(newrange.max_addr));\r\nnewrange.flags = mr->range[0].flags | NF_NAT_RANGE_MAP_IPS;\r\nnewrange.min_addr.ip = newdst;\r\nnewrange.max_addr.ip = newdst;\r\nnewrange.min_proto = mr->range[0].min;\r\nnewrange.max_proto = mr->range[0].max;\r\nreturn nf_nat_setup_info(ct, &newrange, NF_NAT_MANIP_DST);\r\n}\r\nunsigned int\r\nnf_nat_redirect_ipv6(struct sk_buff *skb, const struct nf_nat_range *range,\r\nunsigned int hooknum)\r\n{\r\nstruct nf_nat_range newrange;\r\nstruct in6_addr newdst;\r\nenum ip_conntrack_info ctinfo;\r\nstruct nf_conn *ct;\r\nct = nf_ct_get(skb, &ctinfo);\r\nif (hooknum == NF_INET_LOCAL_OUT) {\r\nnewdst = loopback_addr;\r\n} else {\r\nstruct inet6_dev *idev;\r\nstruct inet6_ifaddr *ifa;\r\nbool addr = false;\r\nrcu_read_lock();\r\nidev = __in6_dev_get(skb->dev);\r\nif (idev != NULL) {\r\nlist_for_each_entry(ifa, &idev->addr_list, if_list) {\r\nnewdst = ifa->addr;\r\naddr = true;\r\nbreak;\r\n}\r\n}\r\nrcu_read_unlock();\r\nif (!addr)\r\nreturn NF_DROP;\r\n}\r\nnewrange.flags = range->flags | NF_NAT_RANGE_MAP_IPS;\r\nnewrange.min_addr.in6 = newdst;\r\nnewrange.max_addr.in6 = newdst;\r\nnewrange.min_proto = range->min_proto;\r\nnewrange.max_proto = range->max_proto;\r\nreturn nf_nat_setup_info(ct, &newrange, NF_NAT_MANIP_DST);\r\n}

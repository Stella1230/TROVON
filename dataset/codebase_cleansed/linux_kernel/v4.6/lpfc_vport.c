inline void lpfc_vport_set_state(struct lpfc_vport *vport,\r\nenum fc_vport_state new_state)\r\n{\r\nstruct fc_vport *fc_vport = vport->fc_vport;\r\nif (fc_vport) {\r\nif (new_state != FC_VPORT_INITIALIZING)\r\nfc_vport->vport_last_state = fc_vport->vport_state;\r\nfc_vport->vport_state = new_state;\r\n}\r\nswitch (new_state) {\r\ncase FC_VPORT_NO_FABRIC_SUPP:\r\ncase FC_VPORT_NO_FABRIC_RSCS:\r\ncase FC_VPORT_FABRIC_LOGOUT:\r\ncase FC_VPORT_FABRIC_REJ_WWN:\r\ncase FC_VPORT_FAILED:\r\nvport->port_state = LPFC_VPORT_FAILED;\r\nbreak;\r\ncase FC_VPORT_LINKDOWN:\r\nvport->port_state = LPFC_VPORT_UNKNOWN;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nint\r\nlpfc_alloc_vpi(struct lpfc_hba *phba)\r\n{\r\nunsigned long vpi;\r\nspin_lock_irq(&phba->hbalock);\r\nvpi = find_next_zero_bit(phba->vpi_bmask, (phba->max_vpi + 1), 1);\r\nif (vpi > phba->max_vpi)\r\nvpi = 0;\r\nelse\r\nset_bit(vpi, phba->vpi_bmask);\r\nif (phba->sli_rev == LPFC_SLI_REV4)\r\nphba->sli4_hba.max_cfg_param.vpi_used++;\r\nspin_unlock_irq(&phba->hbalock);\r\nreturn vpi;\r\n}\r\nstatic void\r\nlpfc_free_vpi(struct lpfc_hba *phba, int vpi)\r\n{\r\nif (vpi == 0)\r\nreturn;\r\nspin_lock_irq(&phba->hbalock);\r\nclear_bit(vpi, phba->vpi_bmask);\r\nif (phba->sli_rev == LPFC_SLI_REV4)\r\nphba->sli4_hba.max_cfg_param.vpi_used--;\r\nspin_unlock_irq(&phba->hbalock);\r\n}\r\nstatic int\r\nlpfc_vport_sparm(struct lpfc_hba *phba, struct lpfc_vport *vport)\r\n{\r\nLPFC_MBOXQ_t *pmb;\r\nMAILBOX_t *mb;\r\nstruct lpfc_dmabuf *mp;\r\nint rc;\r\npmb = mempool_alloc(phba->mbox_mem_pool, GFP_KERNEL);\r\nif (!pmb) {\r\nreturn -ENOMEM;\r\n}\r\nmb = &pmb->u.mb;\r\nrc = lpfc_read_sparam(phba, pmb, vport->vpi);\r\nif (rc) {\r\nmempool_free(pmb, phba->mbox_mem_pool);\r\nreturn -ENOMEM;\r\n}\r\nmp = (struct lpfc_dmabuf *) pmb->context1;\r\npmb->context1 = NULL;\r\npmb->vport = vport;\r\nrc = lpfc_sli_issue_mbox_wait(phba, pmb, phba->fc_ratov * 2);\r\nif (rc != MBX_SUCCESS) {\r\nif (signal_pending(current)) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT | LOG_VPORT,\r\n"1830 Signal aborted mbxCmd x%x\n",\r\nmb->mbxCommand);\r\nlpfc_mbuf_free(phba, mp->virt, mp->phys);\r\nkfree(mp);\r\nif (rc != MBX_TIMEOUT)\r\nmempool_free(pmb, phba->mbox_mem_pool);\r\nreturn -EINTR;\r\n} else {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT | LOG_VPORT,\r\n"1818 VPort failed init, mbxCmd x%x "\r\n"READ_SPARM mbxStatus x%x, rc = x%x\n",\r\nmb->mbxCommand, mb->mbxStatus, rc);\r\nlpfc_mbuf_free(phba, mp->virt, mp->phys);\r\nkfree(mp);\r\nif (rc != MBX_TIMEOUT)\r\nmempool_free(pmb, phba->mbox_mem_pool);\r\nreturn -EIO;\r\n}\r\n}\r\nmemcpy(&vport->fc_sparam, mp->virt, sizeof (struct serv_parm));\r\nmemcpy(&vport->fc_nodename, &vport->fc_sparam.nodeName,\r\nsizeof (struct lpfc_name));\r\nmemcpy(&vport->fc_portname, &vport->fc_sparam.portName,\r\nsizeof (struct lpfc_name));\r\nlpfc_mbuf_free(phba, mp->virt, mp->phys);\r\nkfree(mp);\r\nmempool_free(pmb, phba->mbox_mem_pool);\r\nreturn 0;\r\n}\r\nstatic int\r\nlpfc_valid_wwn_format(struct lpfc_hba *phba, struct lpfc_name *wwn,\r\nconst char *name_type)\r\n{\r\nif (!((wwn->u.wwn[0] >> 4) == 1 &&\r\n((wwn->u.wwn[0] & 0xf) != 0 || (wwn->u.wwn[1] & 0xf) != 0)))\r\nreturn 1;\r\nlpfc_printf_log(phba, KERN_ERR, LOG_VPORT,\r\n"1822 Invalid %s: %02x:%02x:%02x:%02x:"\r\n"%02x:%02x:%02x:%02x\n",\r\nname_type,\r\nwwn->u.wwn[0], wwn->u.wwn[1],\r\nwwn->u.wwn[2], wwn->u.wwn[3],\r\nwwn->u.wwn[4], wwn->u.wwn[5],\r\nwwn->u.wwn[6], wwn->u.wwn[7]);\r\nreturn 0;\r\n}\r\nstatic int\r\nlpfc_unique_wwpn(struct lpfc_hba *phba, struct lpfc_vport *new_vport)\r\n{\r\nstruct lpfc_vport *vport;\r\nunsigned long flags;\r\nspin_lock_irqsave(&phba->hbalock, flags);\r\nlist_for_each_entry(vport, &phba->port_list, listentry) {\r\nif (vport == new_vport)\r\ncontinue;\r\nif (memcmp(&vport->fc_sparam.portName,\r\n&new_vport->fc_sparam.portName,\r\nsizeof(struct lpfc_name)) == 0) {\r\nspin_unlock_irqrestore(&phba->hbalock, flags);\r\nreturn 0;\r\n}\r\n}\r\nspin_unlock_irqrestore(&phba->hbalock, flags);\r\nreturn 1;\r\n}\r\nstatic void lpfc_discovery_wait(struct lpfc_vport *vport)\r\n{\r\nstruct lpfc_hba *phba = vport->phba;\r\nuint32_t wait_flags = 0;\r\nunsigned long wait_time_max;\r\nunsigned long start_time;\r\nwait_flags = FC_RSCN_MODE | FC_RSCN_DISCOVERY | FC_NLP_MORE |\r\nFC_RSCN_DEFERRED | FC_NDISC_ACTIVE | FC_DISC_TMO;\r\nwait_time_max = msecs_to_jiffies(((phba->fc_ratov * 3) + 3) * 1000);\r\nwait_time_max += jiffies;\r\nstart_time = jiffies;\r\nwhile (time_before(jiffies, wait_time_max)) {\r\nif ((vport->num_disc_nodes > 0) ||\r\n(vport->fc_flag & wait_flags) ||\r\n((vport->port_state > LPFC_VPORT_FAILED) &&\r\n(vport->port_state < LPFC_VPORT_READY))) {\r\nlpfc_printf_vlog(vport, KERN_INFO, LOG_VPORT,\r\n"1833 Vport discovery quiesce Wait:"\r\n" state x%x fc_flags x%x"\r\n" num_nodes x%x, waiting 1000 msecs"\r\n" total wait msecs x%x\n",\r\nvport->port_state, vport->fc_flag,\r\nvport->num_disc_nodes,\r\njiffies_to_msecs(jiffies - start_time));\r\nmsleep(1000);\r\n} else {\r\nlpfc_printf_vlog(vport, KERN_INFO, LOG_VPORT,\r\n"1834 Vport discovery quiesced:"\r\n" state x%x fc_flags x%x"\r\n" wait msecs x%x\n",\r\nvport->port_state, vport->fc_flag,\r\njiffies_to_msecs(jiffies\r\n- start_time));\r\nbreak;\r\n}\r\n}\r\nif (time_after(jiffies, wait_time_max))\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_VPORT,\r\n"1835 Vport discovery quiesce failed:"\r\n" state x%x fc_flags x%x wait msecs x%x\n",\r\nvport->port_state, vport->fc_flag,\r\njiffies_to_msecs(jiffies - start_time));\r\n}\r\nint\r\nlpfc_vport_create(struct fc_vport *fc_vport, bool disable)\r\n{\r\nstruct lpfc_nodelist *ndlp;\r\nstruct Scsi_Host *shost = fc_vport->shost;\r\nstruct lpfc_vport *pport = (struct lpfc_vport *) shost->hostdata;\r\nstruct lpfc_hba *phba = pport->phba;\r\nstruct lpfc_vport *vport = NULL;\r\nint instance;\r\nint vpi;\r\nint rc = VPORT_ERROR;\r\nint status;\r\nif ((phba->sli_rev < 3) || !(phba->cfg_enable_npiv)) {\r\nlpfc_printf_log(phba, KERN_ERR, LOG_VPORT,\r\n"1808 Create VPORT failed: "\r\n"NPIV is not enabled: SLImode:%d\n",\r\nphba->sli_rev);\r\nrc = VPORT_INVAL;\r\ngoto error_out;\r\n}\r\nvpi = lpfc_alloc_vpi(phba);\r\nif (vpi == 0) {\r\nlpfc_printf_log(phba, KERN_ERR, LOG_VPORT,\r\n"1809 Create VPORT failed: "\r\n"Max VPORTs (%d) exceeded\n",\r\nphba->max_vpi);\r\nrc = VPORT_NORESOURCES;\r\ngoto error_out;\r\n}\r\nif ((instance = lpfc_get_instance()) < 0) {\r\nlpfc_printf_log(phba, KERN_ERR, LOG_VPORT,\r\n"1810 Create VPORT failed: Cannot get "\r\n"instance number\n");\r\nlpfc_free_vpi(phba, vpi);\r\nrc = VPORT_NORESOURCES;\r\ngoto error_out;\r\n}\r\nvport = lpfc_create_port(phba, instance, &fc_vport->dev);\r\nif (!vport) {\r\nlpfc_printf_log(phba, KERN_ERR, LOG_VPORT,\r\n"1811 Create VPORT failed: vpi x%x\n", vpi);\r\nlpfc_free_vpi(phba, vpi);\r\nrc = VPORT_NORESOURCES;\r\ngoto error_out;\r\n}\r\nvport->vpi = vpi;\r\nlpfc_debugfs_initialize(vport);\r\nif ((status = lpfc_vport_sparm(phba, vport))) {\r\nif (status == -EINTR) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_VPORT,\r\n"1831 Create VPORT Interrupted.\n");\r\nrc = VPORT_ERROR;\r\n} else {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_VPORT,\r\n"1813 Create VPORT failed. "\r\n"Cannot get sparam\n");\r\nrc = VPORT_NORESOURCES;\r\n}\r\nlpfc_free_vpi(phba, vpi);\r\ndestroy_port(vport);\r\ngoto error_out;\r\n}\r\nu64_to_wwn(fc_vport->node_name, vport->fc_nodename.u.wwn);\r\nu64_to_wwn(fc_vport->port_name, vport->fc_portname.u.wwn);\r\nmemcpy(&vport->fc_sparam.portName, vport->fc_portname.u.wwn, 8);\r\nmemcpy(&vport->fc_sparam.nodeName, vport->fc_nodename.u.wwn, 8);\r\nif (!lpfc_valid_wwn_format(phba, &vport->fc_sparam.nodeName, "WWNN") ||\r\n!lpfc_valid_wwn_format(phba, &vport->fc_sparam.portName, "WWPN")) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_VPORT,\r\n"1821 Create VPORT failed. "\r\n"Invalid WWN format\n");\r\nlpfc_free_vpi(phba, vpi);\r\ndestroy_port(vport);\r\nrc = VPORT_INVAL;\r\ngoto error_out;\r\n}\r\nif (!lpfc_unique_wwpn(phba, vport)) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_VPORT,\r\n"1823 Create VPORT failed. "\r\n"Duplicate WWN on HBA\n");\r\nlpfc_free_vpi(phba, vpi);\r\ndestroy_port(vport);\r\nrc = VPORT_INVAL;\r\ngoto error_out;\r\n}\r\nlpfc_alloc_sysfs_attr(vport);\r\nvport->cfg_lun_queue_depth = phba->pport->cfg_lun_queue_depth;\r\n*(struct lpfc_vport **)fc_vport->dd_data = vport;\r\nvport->fc_vport = fc_vport;\r\nvport->load_flag |= FC_ALLOW_FDMI;\r\nif (phba->cfg_fdmi_on > LPFC_FDMI_NO_SUPPORT) {\r\nvport->fdmi_hba_mask = phba->pport->fdmi_hba_mask;\r\nvport->fdmi_port_mask = phba->pport->fdmi_port_mask;\r\n}\r\nif ((phba->sli_rev == LPFC_SLI_REV4) &&\r\n(pport->fc_flag & FC_VFI_REGISTERED)) {\r\nrc = lpfc_sli4_init_vpi(vport);\r\nif (rc) {\r\nlpfc_printf_log(phba, KERN_ERR, LOG_VPORT,\r\n"1838 Failed to INIT_VPI on vpi %d "\r\n"status %d\n", vpi, rc);\r\nrc = VPORT_NORESOURCES;\r\nlpfc_free_vpi(phba, vpi);\r\ngoto error_out;\r\n}\r\n} else if (phba->sli_rev == LPFC_SLI_REV4) {\r\nvport->fc_flag |= FC_VPORT_NEEDS_INIT_VPI;\r\nlpfc_vport_set_state(vport, FC_VPORT_LINKDOWN);\r\nrc = VPORT_OK;\r\ngoto out;\r\n}\r\nif ((phba->link_state < LPFC_LINK_UP) ||\r\n(pport->port_state < LPFC_FABRIC_CFG_LINK) ||\r\n(phba->fc_topology == LPFC_TOPOLOGY_LOOP)) {\r\nlpfc_vport_set_state(vport, FC_VPORT_LINKDOWN);\r\nrc = VPORT_OK;\r\ngoto out;\r\n}\r\nif (disable) {\r\nlpfc_vport_set_state(vport, FC_VPORT_DISABLED);\r\nrc = VPORT_OK;\r\ngoto out;\r\n}\r\nndlp = lpfc_findnode_did(phba->pport, Fabric_DID);\r\nif (ndlp && NLP_CHK_NODE_ACT(ndlp) &&\r\nndlp->nlp_state == NLP_STE_UNMAPPED_NODE) {\r\nif (phba->link_flag & LS_NPIV_FAB_SUPPORTED) {\r\nlpfc_set_disctmo(vport);\r\nlpfc_initial_fdisc(vport);\r\n} else {\r\nlpfc_vport_set_state(vport, FC_VPORT_NO_FABRIC_SUPP);\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_ELS,\r\n"0262 No NPIV Fabric support\n");\r\n}\r\n} else {\r\nlpfc_vport_set_state(vport, FC_VPORT_FAILED);\r\n}\r\nrc = VPORT_OK;\r\nout:\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_VPORT,\r\n"1825 Vport Created.\n");\r\nlpfc_host_attrib_init(lpfc_shost_from_vport(vport));\r\nerror_out:\r\nreturn rc;\r\n}\r\nstatic int\r\ndisable_vport(struct fc_vport *fc_vport)\r\n{\r\nstruct lpfc_vport *vport = *(struct lpfc_vport **)fc_vport->dd_data;\r\nstruct lpfc_hba *phba = vport->phba;\r\nstruct lpfc_nodelist *ndlp = NULL, *next_ndlp = NULL;\r\nlong timeout;\r\nstruct Scsi_Host *shost = lpfc_shost_from_vport(vport);\r\nndlp = lpfc_findnode_did(vport, Fabric_DID);\r\nif (ndlp && NLP_CHK_NODE_ACT(ndlp)\r\n&& phba->link_state >= LPFC_LINK_UP) {\r\nvport->unreg_vpi_cmpl = VPORT_INVAL;\r\ntimeout = msecs_to_jiffies(phba->fc_ratov * 2000);\r\nif (!lpfc_issue_els_npiv_logo(vport, ndlp))\r\nwhile (vport->unreg_vpi_cmpl == VPORT_INVAL && timeout)\r\ntimeout = schedule_timeout(timeout);\r\n}\r\nlpfc_sli_host_down(vport);\r\nlist_for_each_entry_safe(ndlp, next_ndlp, &vport->fc_nodes, nlp_listp) {\r\nif (!NLP_CHK_NODE_ACT(ndlp))\r\ncontinue;\r\nif (ndlp->nlp_state == NLP_STE_UNUSED_NODE)\r\ncontinue;\r\nlpfc_disc_state_machine(vport, ndlp, NULL,\r\nNLP_EVT_DEVICE_RECOVERY);\r\n}\r\nlpfc_cleanup_rpis(vport, 1);\r\nlpfc_stop_vport_timers(vport);\r\nlpfc_unreg_all_rpis(vport);\r\nlpfc_unreg_default_rpis(vport);\r\nlpfc_mbx_unreg_vpi(vport);\r\nspin_lock_irq(shost->host_lock);\r\nvport->fc_flag |= FC_VPORT_NEEDS_INIT_VPI;\r\nspin_unlock_irq(shost->host_lock);\r\nlpfc_vport_set_state(vport, FC_VPORT_DISABLED);\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_VPORT,\r\n"1826 Vport Disabled.\n");\r\nreturn VPORT_OK;\r\n}\r\nstatic int\r\nenable_vport(struct fc_vport *fc_vport)\r\n{\r\nstruct lpfc_vport *vport = *(struct lpfc_vport **)fc_vport->dd_data;\r\nstruct lpfc_hba *phba = vport->phba;\r\nstruct lpfc_nodelist *ndlp = NULL;\r\nstruct Scsi_Host *shost = lpfc_shost_from_vport(vport);\r\nif ((phba->link_state < LPFC_LINK_UP) ||\r\n(phba->fc_topology == LPFC_TOPOLOGY_LOOP)) {\r\nlpfc_vport_set_state(vport, FC_VPORT_LINKDOWN);\r\nreturn VPORT_OK;\r\n}\r\nspin_lock_irq(shost->host_lock);\r\nvport->load_flag |= FC_LOADING;\r\nvport->fc_flag |= FC_VPORT_NEEDS_REG_VPI;\r\nspin_unlock_irq(shost->host_lock);\r\nndlp = lpfc_findnode_did(phba->pport, Fabric_DID);\r\nif (ndlp && NLP_CHK_NODE_ACT(ndlp)\r\n&& ndlp->nlp_state == NLP_STE_UNMAPPED_NODE) {\r\nif (phba->link_flag & LS_NPIV_FAB_SUPPORTED) {\r\nlpfc_set_disctmo(vport);\r\nlpfc_initial_fdisc(vport);\r\n} else {\r\nlpfc_vport_set_state(vport, FC_VPORT_NO_FABRIC_SUPP);\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_ELS,\r\n"0264 No NPIV Fabric support\n");\r\n}\r\n} else {\r\nlpfc_vport_set_state(vport, FC_VPORT_FAILED);\r\n}\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_VPORT,\r\n"1827 Vport Enabled.\n");\r\nreturn VPORT_OK;\r\n}\r\nint\r\nlpfc_vport_disable(struct fc_vport *fc_vport, bool disable)\r\n{\r\nif (disable)\r\nreturn disable_vport(fc_vport);\r\nelse\r\nreturn enable_vport(fc_vport);\r\n}\r\nint\r\nlpfc_vport_delete(struct fc_vport *fc_vport)\r\n{\r\nstruct lpfc_nodelist *ndlp = NULL;\r\nstruct lpfc_vport *vport = *(struct lpfc_vport **)fc_vport->dd_data;\r\nstruct Scsi_Host *shost = lpfc_shost_from_vport(vport);\r\nstruct lpfc_hba *phba = vport->phba;\r\nlong timeout;\r\nbool ns_ndlp_referenced = false;\r\nif (vport->port_type == LPFC_PHYSICAL_PORT) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_VPORT,\r\n"1812 vport_delete failed: Cannot delete "\r\n"physical host\n");\r\nreturn VPORT_ERROR;\r\n}\r\nif ((vport->vport_flag & STATIC_VPORT) &&\r\n!(phba->pport->load_flag & FC_UNLOADING)) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_VPORT,\r\n"1837 vport_delete failed: Cannot delete "\r\n"static vport.\n");\r\nreturn VPORT_ERROR;\r\n}\r\nspin_lock_irq(&phba->hbalock);\r\nvport->load_flag |= FC_UNLOADING;\r\nspin_unlock_irq(&phba->hbalock);\r\nif (!(phba->pport->load_flag & FC_UNLOADING)) {\r\nint check_count = 0;\r\nwhile (check_count < ((phba->fc_ratov * 3) + 3) &&\r\nvport->port_state > LPFC_VPORT_FAILED &&\r\nvport->port_state < LPFC_VPORT_READY) {\r\ncheck_count++;\r\nmsleep(1000);\r\n}\r\nif (vport->port_state > LPFC_VPORT_FAILED &&\r\nvport->port_state < LPFC_VPORT_READY)\r\nreturn -EAGAIN;\r\n}\r\nif (!scsi_host_get(shost))\r\nreturn VPORT_INVAL;\r\nif (!scsi_host_get(shost)) {\r\nscsi_host_put(shost);\r\nreturn VPORT_INVAL;\r\n}\r\nlpfc_free_sysfs_attr(vport);\r\nlpfc_debugfs_terminate(vport);\r\nndlp = lpfc_findnode_did(vport, NameServer_DID);\r\nif (ndlp && NLP_CHK_NODE_ACT(ndlp)) {\r\nlpfc_nlp_get(ndlp);\r\nns_ndlp_referenced = true;\r\n}\r\nfc_remove_host(shost);\r\nscsi_remove_host(shost);\r\nndlp = lpfc_findnode_did(phba->pport, Fabric_DID);\r\nif (phba->pport->load_flag & FC_UNLOADING) {\r\nif (ndlp && NLP_CHK_NODE_ACT(ndlp) &&\r\nndlp->nlp_state == NLP_STE_UNMAPPED_NODE &&\r\nphba->link_state >= LPFC_LINK_UP) {\r\nndlp = lpfc_findnode_did(vport, Fabric_DID);\r\nif (!ndlp)\r\ngoto skip_logo;\r\nelse if (!NLP_CHK_NODE_ACT(ndlp)) {\r\nndlp = lpfc_enable_node(vport, ndlp,\r\nNLP_STE_UNUSED_NODE);\r\nif (!ndlp)\r\ngoto skip_logo;\r\n}\r\nlpfc_dequeue_node(vport, ndlp);\r\nspin_lock_irq(&phba->ndlp_lock);\r\nNLP_SET_FREE_REQ(ndlp);\r\nspin_unlock_irq(&phba->ndlp_lock);\r\nlpfc_nlp_put(ndlp);\r\n}\r\ngoto skip_logo;\r\n}\r\nif (ndlp && NLP_CHK_NODE_ACT(ndlp) &&\r\nndlp->nlp_state == NLP_STE_UNMAPPED_NODE &&\r\nphba->link_state >= LPFC_LINK_UP &&\r\nphba->fc_topology != LPFC_TOPOLOGY_LOOP) {\r\nif (vport->cfg_enable_da_id) {\r\ntimeout = msecs_to_jiffies(phba->fc_ratov * 2000);\r\nif (!lpfc_ns_cmd(vport, SLI_CTNS_DA_ID, 0, 0))\r\nwhile (vport->ct_flags && timeout)\r\ntimeout = schedule_timeout(timeout);\r\nelse\r\nlpfc_printf_log(vport->phba, KERN_WARNING,\r\nLOG_VPORT,\r\n"1829 CT command failed to "\r\n"delete objects on fabric\n");\r\n}\r\nndlp = lpfc_findnode_did(vport, Fabric_DID);\r\nif (!ndlp) {\r\nndlp = mempool_alloc(phba->nlp_mem_pool, GFP_KERNEL);\r\nif (!ndlp)\r\ngoto skip_logo;\r\nlpfc_nlp_init(vport, ndlp, Fabric_DID);\r\nNLP_SET_FREE_REQ(ndlp);\r\n} else {\r\nif (!NLP_CHK_NODE_ACT(ndlp)) {\r\nndlp = lpfc_enable_node(vport, ndlp,\r\nNLP_STE_UNUSED_NODE);\r\nif (!ndlp)\r\ngoto skip_logo;\r\n}\r\nlpfc_dequeue_node(vport, ndlp);\r\nspin_lock_irq(&phba->ndlp_lock);\r\nif (!NLP_CHK_FREE_REQ(ndlp))\r\nNLP_SET_FREE_REQ(ndlp);\r\nelse {\r\nspin_unlock_irq(&phba->ndlp_lock);\r\ngoto skip_logo;\r\n}\r\nspin_unlock_irq(&phba->ndlp_lock);\r\n}\r\nif (!(vport->vpi_state & LPFC_VPI_REGISTERED)) {\r\nlpfc_nlp_put(ndlp);\r\ngoto skip_logo;\r\n}\r\nvport->unreg_vpi_cmpl = VPORT_INVAL;\r\ntimeout = msecs_to_jiffies(phba->fc_ratov * 2000);\r\nif (!lpfc_issue_els_npiv_logo(vport, ndlp))\r\nwhile (vport->unreg_vpi_cmpl == VPORT_INVAL && timeout)\r\ntimeout = schedule_timeout(timeout);\r\n}\r\nif (!(phba->pport->load_flag & FC_UNLOADING))\r\nlpfc_discovery_wait(vport);\r\nskip_logo:\r\nif (ns_ndlp_referenced) {\r\nndlp = lpfc_findnode_did(vport, NameServer_DID);\r\nlpfc_nlp_put(ndlp);\r\n}\r\nlpfc_cleanup(vport);\r\nlpfc_sli_host_down(vport);\r\nlpfc_stop_vport_timers(vport);\r\nif (!(phba->pport->load_flag & FC_UNLOADING)) {\r\nlpfc_unreg_all_rpis(vport);\r\nlpfc_unreg_default_rpis(vport);\r\nif (!(vport->vpi_state & LPFC_VPI_REGISTERED) ||\r\nlpfc_mbx_unreg_vpi(vport))\r\nscsi_host_put(shost);\r\n} else\r\nscsi_host_put(shost);\r\nlpfc_free_vpi(phba, vport->vpi);\r\nvport->work_port_events = 0;\r\nspin_lock_irq(&phba->hbalock);\r\nlist_del_init(&vport->listentry);\r\nspin_unlock_irq(&phba->hbalock);\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_VPORT,\r\n"1828 Vport Deleted.\n");\r\nscsi_host_put(shost);\r\nreturn VPORT_OK;\r\n}\r\nstruct lpfc_vport **\r\nlpfc_create_vport_work_array(struct lpfc_hba *phba)\r\n{\r\nstruct lpfc_vport *port_iterator;\r\nstruct lpfc_vport **vports;\r\nint index = 0;\r\nvports = kzalloc((phba->max_vports + 1) * sizeof(struct lpfc_vport *),\r\nGFP_KERNEL);\r\nif (vports == NULL)\r\nreturn NULL;\r\nspin_lock_irq(&phba->hbalock);\r\nlist_for_each_entry(port_iterator, &phba->port_list, listentry) {\r\nif (port_iterator->load_flag & FC_UNLOADING)\r\ncontinue;\r\nif (!scsi_host_get(lpfc_shost_from_vport(port_iterator))) {\r\nlpfc_printf_vlog(port_iterator, KERN_ERR, LOG_VPORT,\r\n"1801 Create vport work array FAILED: "\r\n"cannot do scsi_host_get\n");\r\ncontinue;\r\n}\r\nvports[index++] = port_iterator;\r\n}\r\nspin_unlock_irq(&phba->hbalock);\r\nreturn vports;\r\n}\r\nvoid\r\nlpfc_destroy_vport_work_array(struct lpfc_hba *phba, struct lpfc_vport **vports)\r\n{\r\nint i;\r\nif (vports == NULL)\r\nreturn;\r\nfor (i = 0; i <= phba->max_vports && vports[i] != NULL; i++)\r\nscsi_host_put(lpfc_shost_from_vport(vports[i]));\r\nkfree(vports);\r\n}\r\nvoid\r\nlpfc_vport_reset_stat_data(struct lpfc_vport *vport)\r\n{\r\nstruct lpfc_nodelist *ndlp = NULL, *next_ndlp = NULL;\r\nlist_for_each_entry_safe(ndlp, next_ndlp, &vport->fc_nodes, nlp_listp) {\r\nif (!NLP_CHK_NODE_ACT(ndlp))\r\ncontinue;\r\nif (ndlp->lat_data)\r\nmemset(ndlp->lat_data, 0, LPFC_MAX_BUCKET_COUNT *\r\nsizeof(struct lpfc_scsicmd_bkt));\r\n}\r\n}\r\nvoid\r\nlpfc_alloc_bucket(struct lpfc_vport *vport)\r\n{\r\nstruct lpfc_nodelist *ndlp = NULL, *next_ndlp = NULL;\r\nlist_for_each_entry_safe(ndlp, next_ndlp, &vport->fc_nodes, nlp_listp) {\r\nif (!NLP_CHK_NODE_ACT(ndlp))\r\ncontinue;\r\nkfree(ndlp->lat_data);\r\nndlp->lat_data = NULL;\r\nif (ndlp->nlp_state == NLP_STE_MAPPED_NODE) {\r\nndlp->lat_data = kcalloc(LPFC_MAX_BUCKET_COUNT,\r\nsizeof(struct lpfc_scsicmd_bkt),\r\nGFP_ATOMIC);\r\nif (!ndlp->lat_data)\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_NODE,\r\n"0287 lpfc_alloc_bucket failed to "\r\n"allocate statistical data buffer DID "\r\n"0x%x\n", ndlp->nlp_DID);\r\n}\r\n}\r\n}\r\nvoid\r\nlpfc_free_bucket(struct lpfc_vport *vport)\r\n{\r\nstruct lpfc_nodelist *ndlp = NULL, *next_ndlp = NULL;\r\nlist_for_each_entry_safe(ndlp, next_ndlp, &vport->fc_nodes, nlp_listp) {\r\nif (!NLP_CHK_NODE_ACT(ndlp))\r\ncontinue;\r\nkfree(ndlp->lat_data);\r\nndlp->lat_data = NULL;\r\n}\r\n}

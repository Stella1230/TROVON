static unsigned int __i8254_read(struct comedi_8254 *i8254, unsigned int reg)\r\n{\r\nunsigned int reg_offset = (reg * i8254->iosize) << i8254->regshift;\r\nunsigned int val;\r\nswitch (i8254->iosize) {\r\ndefault:\r\ncase I8254_IO8:\r\nif (i8254->mmio)\r\nval = readb(i8254->mmio + reg_offset);\r\nelse\r\nval = inb(i8254->iobase + reg_offset);\r\nbreak;\r\ncase I8254_IO16:\r\nif (i8254->mmio)\r\nval = readw(i8254->mmio + reg_offset);\r\nelse\r\nval = inw(i8254->iobase + reg_offset);\r\nbreak;\r\ncase I8254_IO32:\r\nif (i8254->mmio)\r\nval = readl(i8254->mmio + reg_offset);\r\nelse\r\nval = inl(i8254->iobase + reg_offset);\r\nbreak;\r\n}\r\nreturn val & 0xff;\r\n}\r\nstatic void __i8254_write(struct comedi_8254 *i8254,\r\nunsigned int val, unsigned int reg)\r\n{\r\nunsigned int reg_offset = (reg * i8254->iosize) << i8254->regshift;\r\nswitch (i8254->iosize) {\r\ndefault:\r\ncase I8254_IO8:\r\nif (i8254->mmio)\r\nwriteb(val, i8254->mmio + reg_offset);\r\nelse\r\noutb(val, i8254->iobase + reg_offset);\r\nbreak;\r\ncase I8254_IO16:\r\nif (i8254->mmio)\r\nwritew(val, i8254->mmio + reg_offset);\r\nelse\r\noutw(val, i8254->iobase + reg_offset);\r\nbreak;\r\ncase I8254_IO32:\r\nif (i8254->mmio)\r\nwritel(val, i8254->mmio + reg_offset);\r\nelse\r\noutl(val, i8254->iobase + reg_offset);\r\nbreak;\r\n}\r\n}\r\nunsigned int comedi_8254_status(struct comedi_8254 *i8254, unsigned int counter)\r\n{\r\nunsigned int cmd;\r\nif (counter > 2)\r\nreturn 0;\r\ncmd = I8254_CTRL_READBACK_STATUS | I8254_CTRL_READBACK_SEL_CTR(counter);\r\n__i8254_write(i8254, cmd, I8254_CTRL_REG);\r\nreturn __i8254_read(i8254, counter);\r\n}\r\nunsigned int comedi_8254_read(struct comedi_8254 *i8254, unsigned int counter)\r\n{\r\nunsigned int val;\r\nif (counter > 2)\r\nreturn 0;\r\n__i8254_write(i8254, I8254_CTRL_SEL_CTR(counter) | I8254_CTRL_LATCH,\r\nI8254_CTRL_REG);\r\nval = __i8254_read(i8254, counter);\r\nval |= (__i8254_read(i8254, counter) << 8);\r\nreturn val;\r\n}\r\nvoid comedi_8254_write(struct comedi_8254 *i8254,\r\nunsigned int counter, unsigned int val)\r\n{\r\nunsigned int byte;\r\nif (counter > 2)\r\nreturn;\r\nif (val > 0xffff)\r\nreturn;\r\nbyte = val & 0xff;\r\n__i8254_write(i8254, byte, counter);\r\nbyte = (val >> 8) & 0xff;\r\n__i8254_write(i8254, byte, counter);\r\n}\r\nint comedi_8254_set_mode(struct comedi_8254 *i8254, unsigned int counter,\r\nunsigned int mode)\r\n{\r\nunsigned int byte;\r\nif (counter > 2)\r\nreturn -EINVAL;\r\nif (mode > (I8254_MODE5 | I8254_BCD))\r\nreturn -EINVAL;\r\nbyte = I8254_CTRL_SEL_CTR(counter) |\r\nI8254_CTRL_LSB_MSB |\r\nmode;\r\n__i8254_write(i8254, byte, I8254_CTRL_REG);\r\nreturn 0;\r\n}\r\nint comedi_8254_load(struct comedi_8254 *i8254, unsigned int counter,\r\nunsigned int val, unsigned int mode)\r\n{\r\nif (counter > 2)\r\nreturn -EINVAL;\r\nif (val > 0xffff)\r\nreturn -EINVAL;\r\nif (mode > (I8254_MODE5 | I8254_BCD))\r\nreturn -EINVAL;\r\ncomedi_8254_set_mode(i8254, counter, mode);\r\ncomedi_8254_write(i8254, counter, val);\r\nreturn 0;\r\n}\r\nvoid comedi_8254_pacer_enable(struct comedi_8254 *i8254,\r\nunsigned int counter1,\r\nunsigned int counter2,\r\nbool enable)\r\n{\r\nunsigned int mode;\r\nif (counter1 > 2 || counter2 > 2 || counter1 == counter2)\r\nreturn;\r\nif (enable)\r\nmode = I8254_MODE2 | I8254_BINARY;\r\nelse\r\nmode = I8254_MODE0 | I8254_BINARY;\r\ncomedi_8254_set_mode(i8254, counter1, mode);\r\ncomedi_8254_set_mode(i8254, counter2, mode);\r\nif (enable) {\r\ncomedi_8254_write(i8254, counter2, i8254->divisor2);\r\ncomedi_8254_write(i8254, counter1, i8254->divisor1);\r\n}\r\n}\r\nvoid comedi_8254_update_divisors(struct comedi_8254 *i8254)\r\n{\r\ni8254->divisor = i8254->next_div & 0xffff;\r\ni8254->divisor1 = i8254->next_div1 & 0xffff;\r\ni8254->divisor2 = i8254->next_div2 & 0xffff;\r\n}\r\nvoid comedi_8254_cascade_ns_to_timer(struct comedi_8254 *i8254,\r\nunsigned int *nanosec,\r\nunsigned int flags)\r\n{\r\nunsigned int d1 = i8254->next_div1 ? i8254->next_div1 : I8254_MAX_COUNT;\r\nunsigned int d2 = i8254->next_div2 ? i8254->next_div2 : I8254_MAX_COUNT;\r\nunsigned int div = d1 * d2;\r\nunsigned int ns_lub = 0xffffffff;\r\nunsigned int ns_glb = 0;\r\nunsigned int d1_lub = 0;\r\nunsigned int d1_glb = 0;\r\nunsigned int d2_lub = 0;\r\nunsigned int d2_glb = 0;\r\nunsigned int start;\r\nunsigned int ns;\r\nunsigned int ns_low;\r\nunsigned int ns_high;\r\nif (div * i8254->osc_base == *nanosec &&\r\nd1 > 1 && d1 <= I8254_MAX_COUNT &&\r\nd2 > 1 && d2 <= I8254_MAX_COUNT &&\r\ndiv > d1 && div > d2 &&\r\ndiv * i8254->osc_base > div &&\r\ndiv * i8254->osc_base > i8254->osc_base)\r\nreturn;\r\ndiv = *nanosec / i8254->osc_base;\r\nd2 = I8254_MAX_COUNT;\r\nstart = div / d2;\r\nif (start < 2)\r\nstart = 2;\r\nfor (d1 = start; d1 <= div / d1 + 1 && d1 <= I8254_MAX_COUNT; d1++) {\r\nfor (d2 = div / d1;\r\nd1 * d2 <= div + d1 + 1 && d2 <= I8254_MAX_COUNT; d2++) {\r\nns = i8254->osc_base * d1 * d2;\r\nif (ns <= *nanosec && ns > ns_glb) {\r\nns_glb = ns;\r\nd1_glb = d1;\r\nd2_glb = d2;\r\n}\r\nif (ns >= *nanosec && ns < ns_lub) {\r\nns_lub = ns;\r\nd1_lub = d1;\r\nd2_lub = d2;\r\n}\r\n}\r\n}\r\nswitch (flags & CMDF_ROUND_MASK) {\r\ncase CMDF_ROUND_NEAREST:\r\ndefault:\r\nns_high = d1_lub * d2_lub * i8254->osc_base;\r\nns_low = d1_glb * d2_glb * i8254->osc_base;\r\nif (ns_high - *nanosec < *nanosec - ns_low) {\r\nd1 = d1_lub;\r\nd2 = d2_lub;\r\n} else {\r\nd1 = d1_glb;\r\nd2 = d2_glb;\r\n}\r\nbreak;\r\ncase CMDF_ROUND_UP:\r\nd1 = d1_lub;\r\nd2 = d2_lub;\r\nbreak;\r\ncase CMDF_ROUND_DOWN:\r\nd1 = d1_glb;\r\nd2 = d2_glb;\r\nbreak;\r\n}\r\n*nanosec = d1 * d2 * i8254->osc_base;\r\ni8254->next_div1 = d1;\r\ni8254->next_div2 = d2;\r\n}\r\nvoid comedi_8254_ns_to_timer(struct comedi_8254 *i8254,\r\nunsigned int *nanosec, unsigned int flags)\r\n{\r\nunsigned int divisor;\r\nswitch (flags & CMDF_ROUND_MASK) {\r\ndefault:\r\ncase CMDF_ROUND_NEAREST:\r\ndivisor = DIV_ROUND_CLOSEST(*nanosec, i8254->osc_base);\r\nbreak;\r\ncase CMDF_ROUND_UP:\r\ndivisor = DIV_ROUND_UP(*nanosec, i8254->osc_base);\r\nbreak;\r\ncase CMDF_ROUND_DOWN:\r\ndivisor = *nanosec / i8254->osc_base;\r\nbreak;\r\n}\r\nif (divisor < 2)\r\ndivisor = 2;\r\nif (divisor > I8254_MAX_COUNT)\r\ndivisor = I8254_MAX_COUNT;\r\n*nanosec = divisor * i8254->osc_base;\r\ni8254->next_div = divisor;\r\n}\r\nvoid comedi_8254_set_busy(struct comedi_8254 *i8254,\r\nunsigned int counter, bool busy)\r\n{\r\nif (counter < 3)\r\ni8254->busy[counter] = busy;\r\n}\r\nstatic int comedi_8254_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct comedi_8254 *i8254 = s->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nint i;\r\nif (i8254->busy[chan])\r\nreturn -EBUSY;\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = comedi_8254_read(i8254, chan);\r\nreturn insn->n;\r\n}\r\nstatic int comedi_8254_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct comedi_8254 *i8254 = s->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nif (i8254->busy[chan])\r\nreturn -EBUSY;\r\nif (insn->n)\r\ncomedi_8254_write(i8254, chan, data[insn->n - 1]);\r\nreturn insn->n;\r\n}\r\nstatic int comedi_8254_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct comedi_8254 *i8254 = s->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nint ret;\r\nif (i8254->busy[chan])\r\nreturn -EBUSY;\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_RESET:\r\nret = comedi_8254_set_mode(i8254, chan,\r\nI8254_MODE0 | I8254_BINARY);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase INSN_CONFIG_SET_COUNTER_MODE:\r\nret = comedi_8254_set_mode(i8254, chan, data[1]);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase INSN_CONFIG_8254_READ_STATUS:\r\ndata[1] = comedi_8254_status(i8254, chan);\r\nbreak;\r\ndefault:\r\nif (i8254->insn_config)\r\nreturn i8254->insn_config(dev, s, insn, data);\r\nreturn -EINVAL;\r\n}\r\nreturn insn->n;\r\n}\r\nvoid comedi_8254_subdevice_init(struct comedi_subdevice *s,\r\nstruct comedi_8254 *i8254)\r\n{\r\ns->type = COMEDI_SUBD_COUNTER;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 3;\r\ns->maxdata = 0xffff;\r\ns->range_table = &range_unknown;\r\ns->insn_read = comedi_8254_insn_read;\r\ns->insn_write = comedi_8254_insn_write;\r\ns->insn_config = comedi_8254_insn_config;\r\ns->private = i8254;\r\n}\r\nstatic struct comedi_8254 *__i8254_init(unsigned long iobase,\r\nvoid __iomem *mmio,\r\nunsigned int osc_base,\r\nunsigned int iosize,\r\nunsigned int regshift)\r\n{\r\nstruct comedi_8254 *i8254;\r\nint i;\r\nif (!(iosize == I8254_IO8 || iosize == I8254_IO16 ||\r\niosize == I8254_IO32))\r\nreturn NULL;\r\ni8254 = kzalloc(sizeof(*i8254), GFP_KERNEL);\r\nif (!i8254)\r\nreturn NULL;\r\ni8254->iobase = iobase;\r\ni8254->mmio = mmio;\r\ni8254->iosize = iosize;\r\ni8254->regshift = regshift;\r\ni8254->osc_base = osc_base ? osc_base : I8254_OSC_BASE_10MHZ;\r\nfor (i = 0; i < 3; i++)\r\ncomedi_8254_set_mode(i8254, i, I8254_MODE0 | I8254_BINARY);\r\nreturn i8254;\r\n}\r\nstruct comedi_8254 *comedi_8254_init(unsigned long iobase,\r\nunsigned int osc_base,\r\nunsigned int iosize,\r\nunsigned int regshift)\r\n{\r\nreturn __i8254_init(iobase, NULL, osc_base, iosize, regshift);\r\n}\r\nstruct comedi_8254 *comedi_8254_mm_init(void __iomem *mmio,\r\nunsigned int osc_base,\r\nunsigned int iosize,\r\nunsigned int regshift)\r\n{\r\nreturn __i8254_init(0, mmio, osc_base, iosize, regshift);\r\n}\r\nstatic int __init comedi_8254_module_init(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit comedi_8254_module_exit(void)\r\n{\r\n}

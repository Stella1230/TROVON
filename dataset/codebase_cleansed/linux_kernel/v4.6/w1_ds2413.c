static ssize_t state_read(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr, char *buf, loff_t off,\r\nsize_t count)\r\n{\r\nstruct w1_slave *sl = kobj_to_w1_slave(kobj);\r\ndev_dbg(&sl->dev,\r\n"Reading %s kobj: %p, off: %0#10x, count: %zu, buff addr: %p",\r\nbin_attr->attr.name, kobj, (unsigned int)off, count, buf);\r\nif (off != 0)\r\nreturn 0;\r\nif (!buf)\r\nreturn -EINVAL;\r\nmutex_lock(&sl->master->bus_mutex);\r\ndev_dbg(&sl->dev, "mutex locked");\r\nif (w1_reset_select_slave(sl)) {\r\nmutex_unlock(&sl->master->bus_mutex);\r\nreturn -EIO;\r\n}\r\nw1_write_8(sl->master, W1_F3A_FUNC_PIO_ACCESS_READ);\r\n*buf = w1_read_8(sl->master);\r\nmutex_unlock(&sl->master->bus_mutex);\r\ndev_dbg(&sl->dev, "mutex unlocked");\r\nif ((*buf & 0x0F) != ((~*buf >> 4) & 0x0F))\r\nreturn -EIO;\r\nelse\r\nreturn 1;\r\n}\r\nstatic ssize_t output_write(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr, char *buf,\r\nloff_t off, size_t count)\r\n{\r\nstruct w1_slave *sl = kobj_to_w1_slave(kobj);\r\nu8 w1_buf[3];\r\nunsigned int retries = W1_F3A_RETRIES;\r\nif (count != 1 || off != 0)\r\nreturn -EFAULT;\r\ndev_dbg(&sl->dev, "locking mutex for write_output");\r\nmutex_lock(&sl->master->bus_mutex);\r\ndev_dbg(&sl->dev, "mutex locked");\r\nif (w1_reset_select_slave(sl))\r\ngoto error;\r\n*buf = *buf | 0xFC;\r\nwhile (retries--) {\r\nw1_buf[0] = W1_F3A_FUNC_PIO_ACCESS_WRITE;\r\nw1_buf[1] = *buf;\r\nw1_buf[2] = ~(*buf);\r\nw1_write_block(sl->master, w1_buf, 3);\r\nif (w1_read_8(sl->master) == W1_F3A_SUCCESS_CONFIRM_BYTE) {\r\nmutex_unlock(&sl->master->bus_mutex);\r\ndev_dbg(&sl->dev, "mutex unlocked, retries:%d", retries);\r\nreturn 1;\r\n}\r\nif (w1_reset_resume_command(sl->master))\r\ngoto error;\r\n}\r\nerror:\r\nmutex_unlock(&sl->master->bus_mutex);\r\ndev_dbg(&sl->dev, "mutex unlocked in error, retries:%d", retries);\r\nreturn -EIO;\r\n}\r\nstatic int __init w1_f3a_init(void)\r\n{\r\nreturn w1_register_family(&w1_family_3a);\r\n}\r\nstatic void __exit w1_f3a_exit(void)\r\n{\r\nw1_unregister_family(&w1_family_3a);\r\n}

static bool u32_match_it(const struct xt_u32 *data,\r\nconst struct sk_buff *skb)\r\n{\r\nconst struct xt_u32_test *ct;\r\nunsigned int testind;\r\nunsigned int nnums;\r\nunsigned int nvals;\r\nunsigned int i;\r\n__be32 n;\r\nu_int32_t pos;\r\nu_int32_t val;\r\nu_int32_t at;\r\nfor (testind = 0; testind < data->ntests; ++testind) {\r\nct = &data->tests[testind];\r\nat = 0;\r\npos = ct->location[0].number;\r\nif (skb->len < 4 || pos > skb->len - 4)\r\nreturn false;\r\nif (skb_copy_bits(skb, pos, &n, sizeof(n)) < 0)\r\nBUG();\r\nval = ntohl(n);\r\nnnums = ct->nnums;\r\nfor (i = 1; i < nnums; ++i) {\r\nu_int32_t number = ct->location[i].number;\r\nswitch (ct->location[i].nextop) {\r\ncase XT_U32_AND:\r\nval &= number;\r\nbreak;\r\ncase XT_U32_LEFTSH:\r\nval <<= number;\r\nbreak;\r\ncase XT_U32_RIGHTSH:\r\nval >>= number;\r\nbreak;\r\ncase XT_U32_AT:\r\nif (at + val < at)\r\nreturn false;\r\nat += val;\r\npos = number;\r\nif (at + 4 < at || skb->len < at + 4 ||\r\npos > skb->len - at - 4)\r\nreturn false;\r\nif (skb_copy_bits(skb, at + pos, &n,\r\nsizeof(n)) < 0)\r\nBUG();\r\nval = ntohl(n);\r\nbreak;\r\n}\r\n}\r\nnvals = ct->nvalues;\r\nfor (i = 0; i < nvals; ++i)\r\nif (ct->value[i].min <= val && val <= ct->value[i].max)\r\nbreak;\r\nif (i >= ct->nvalues)\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic bool u32_mt(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_u32 *data = par->matchinfo;\r\nbool ret;\r\nret = u32_match_it(data, skb);\r\nreturn ret ^ data->invert;\r\n}\r\nstatic int __init u32_mt_init(void)\r\n{\r\nreturn xt_register_match(&xt_u32_mt_reg);\r\n}\r\nstatic void __exit u32_mt_exit(void)\r\n{\r\nxt_unregister_match(&xt_u32_mt_reg);\r\n}

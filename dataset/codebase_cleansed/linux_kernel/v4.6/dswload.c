acpi_status\r\nacpi_ds_init_callbacks(struct acpi_walk_state *walk_state, u32 pass_number)\r\n{\r\nswitch (pass_number) {\r\ncase 0:\r\nwalk_state->parse_flags = ACPI_PARSE_LOAD_PASS1 |\r\nACPI_PARSE_DELETE_TREE | ACPI_PARSE_DISASSEMBLE;\r\nwalk_state->descending_callback = NULL;\r\nwalk_state->ascending_callback = NULL;\r\nbreak;\r\ncase 1:\r\nwalk_state->parse_flags = ACPI_PARSE_LOAD_PASS1 |\r\nACPI_PARSE_DELETE_TREE;\r\nwalk_state->descending_callback = acpi_ds_load1_begin_op;\r\nwalk_state->ascending_callback = acpi_ds_load1_end_op;\r\nbreak;\r\ncase 2:\r\nwalk_state->parse_flags = ACPI_PARSE_LOAD_PASS1 |\r\nACPI_PARSE_DELETE_TREE;\r\nwalk_state->descending_callback = acpi_ds_load2_begin_op;\r\nwalk_state->ascending_callback = acpi_ds_load2_end_op;\r\nbreak;\r\ncase 3:\r\n#ifndef ACPI_NO_METHOD_EXECUTION\r\nwalk_state->parse_flags |= ACPI_PARSE_EXECUTE |\r\nACPI_PARSE_DELETE_TREE;\r\nwalk_state->descending_callback = acpi_ds_exec_begin_op;\r\nwalk_state->ascending_callback = acpi_ds_exec_end_op;\r\n#endif\r\nbreak;\r\ndefault:\r\nreturn (AE_BAD_PARAMETER);\r\n}\r\nreturn (AE_OK);\r\n}\r\nacpi_status\r\nacpi_ds_load1_begin_op(struct acpi_walk_state * walk_state,\r\nunion acpi_parse_object ** out_op)\r\n{\r\nunion acpi_parse_object *op;\r\nstruct acpi_namespace_node *node;\r\nacpi_status status;\r\nacpi_object_type object_type;\r\nchar *path;\r\nu32 flags;\r\nACPI_FUNCTION_TRACE(ds_load1_begin_op);\r\nop = walk_state->op;\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH, "Op=%p State=%p\n", op,\r\nwalk_state));\r\nif (op) {\r\nif (!(walk_state->op_info->flags & AML_NAMED)) {\r\n*out_op = op;\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nif (op->common.node) {\r\n*out_op = op;\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\n}\r\npath = acpi_ps_get_next_namestring(&walk_state->parser_state);\r\nobject_type = walk_state->op_info->object_type;\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"State=%p Op=%p [%s]\n", walk_state, op,\r\nacpi_ut_get_type_name(object_type)));\r\nswitch (walk_state->opcode) {\r\ncase AML_SCOPE_OP:\r\nstatus =\r\nacpi_ns_lookup(walk_state->scope_info, path, object_type,\r\nACPI_IMODE_EXECUTE, ACPI_NS_SEARCH_PARENT,\r\nwalk_state, &(node));\r\n#ifdef ACPI_ASL_COMPILER\r\nif (status == AE_NOT_FOUND) {\r\nacpi_dm_add_op_to_external_list(op, path,\r\nACPI_TYPE_DEVICE, 0, 0);\r\nstatus =\r\nacpi_ns_lookup(walk_state->scope_info, path,\r\nobject_type, ACPI_IMODE_LOAD_PASS1,\r\nACPI_NS_SEARCH_PARENT, walk_state,\r\n&node);\r\n}\r\n#endif\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR_NAMESPACE(path, status);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nswitch (node->type) {\r\ncase ACPI_TYPE_ANY:\r\ncase ACPI_TYPE_LOCAL_SCOPE:\r\ncase ACPI_TYPE_DEVICE:\r\ncase ACPI_TYPE_POWER:\r\ncase ACPI_TYPE_PROCESSOR:\r\ncase ACPI_TYPE_THERMAL:\r\nbreak;\r\ncase ACPI_TYPE_INTEGER:\r\ncase ACPI_TYPE_STRING:\r\ncase ACPI_TYPE_BUFFER:\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"Type override - [%4.4s] had invalid type (%s) "\r\n"for Scope operator, changed to type ANY\n",\r\nacpi_ut_get_node_name(node),\r\nacpi_ut_get_type_name(node->type)));\r\nnode->type = ACPI_TYPE_ANY;\r\nwalk_state->scope_info->common.value = ACPI_TYPE_ANY;\r\nbreak;\r\ncase ACPI_TYPE_METHOD:\r\nif ((node == acpi_gbl_root_node) &&\r\n(walk_state->\r\nparse_flags & ACPI_PARSE_MODULE_LEVEL)) {\r\nbreak;\r\n}\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Invalid type (%s) for target of "\r\n"Scope operator [%4.4s] (Cannot override)",\r\nacpi_ut_get_type_name(node->type),\r\nacpi_ut_get_node_name(node)));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nbreak;\r\ndefault:\r\nif (walk_state->deferred_node) {\r\nnode = walk_state->deferred_node;\r\nstatus = AE_OK;\r\nbreak;\r\n}\r\nif (walk_state->method_node) {\r\nnode = NULL;\r\nstatus = AE_OK;\r\nbreak;\r\n}\r\nflags = ACPI_NS_NO_UPSEARCH;\r\nif ((walk_state->opcode != AML_SCOPE_OP) &&\r\n(!(walk_state->parse_flags & ACPI_PARSE_DEFERRED_OP))) {\r\nif (walk_state->namespace_override) {\r\nflags |= ACPI_NS_OVERRIDE_IF_FOUND;\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"[%s] Override allowed\n",\r\nacpi_ut_get_type_name\r\n(object_type)));\r\n} else {\r\nflags |= ACPI_NS_ERROR_IF_FOUND;\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"[%s] Cannot already exist\n",\r\nacpi_ut_get_type_name\r\n(object_type)));\r\n}\r\n} else {\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"[%s] Both Find or Create allowed\n",\r\nacpi_ut_get_type_name(object_type)));\r\n}\r\nstatus =\r\nacpi_ns_lookup(walk_state->scope_info, path, object_type,\r\nACPI_IMODE_LOAD_PASS1, flags, walk_state,\r\n&node);\r\nif (ACPI_FAILURE(status)) {\r\nif (status == AE_ALREADY_EXISTS) {\r\nif (node->flags & ANOBJ_IS_EXTERNAL) {\r\nnode->flags &= ~ANOBJ_IS_EXTERNAL;\r\nnode->type = (u8) object_type;\r\nif (acpi_ns_opens_scope(object_type)) {\r\nstatus =\r\nacpi_ds_scope_stack_push\r\n(node, object_type,\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS\r\n(status);\r\n}\r\n}\r\nstatus = AE_OK;\r\n}\r\n}\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR_NAMESPACE(path, status);\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nbreak;\r\n}\r\nif (!op) {\r\nop = acpi_ps_alloc_op(walk_state->opcode, walk_state->aml);\r\nif (!op) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\n}\r\n#if (defined (ACPI_NO_METHOD_EXECUTION) || defined (ACPI_CONSTANT_EVAL_ONLY))\r\nop->named.path = ACPI_CAST_PTR(u8, path);\r\n#endif\r\nif (node) {\r\nop->common.node = node;\r\nop->named.name = node->name.integer;\r\n}\r\nacpi_ps_append_arg(acpi_ps_get_parent_scope(&walk_state->parser_state),\r\nop);\r\n*out_op = op;\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status acpi_ds_load1_end_op(struct acpi_walk_state *walk_state)\r\n{\r\nunion acpi_parse_object *op;\r\nacpi_object_type object_type;\r\nacpi_status status = AE_OK;\r\nACPI_FUNCTION_TRACE(ds_load1_end_op);\r\nop = walk_state->op;\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH, "Op=%p State=%p\n", op,\r\nwalk_state));\r\nif (!(walk_state->op_info->flags & (AML_NAMED | AML_FIELD))) {\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nobject_type = walk_state->op_info->object_type;\r\n#ifndef ACPI_NO_METHOD_EXECUTION\r\nif (walk_state->op_info->flags & AML_FIELD) {\r\nif (!walk_state->method_node) {\r\nif (walk_state->opcode == AML_FIELD_OP ||\r\nwalk_state->opcode == AML_BANK_FIELD_OP ||\r\nwalk_state->opcode == AML_INDEX_FIELD_OP) {\r\nstatus =\r\nacpi_ds_init_field_objects(op, walk_state);\r\n}\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif (!walk_state->method_node) {\r\nif (op->common.aml_opcode == AML_REGION_OP) {\r\nstatus =\r\nacpi_ex_create_region(op->named.data,\r\nop->named.length,\r\n(acpi_adr_space_type)\r\n((op->common.value.arg)->\r\ncommon.value.integer),\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n} else if (op->common.aml_opcode == AML_DATA_REGION_OP) {\r\nstatus =\r\nacpi_ex_create_region(op->named.data,\r\nop->named.length,\r\nACPI_ADR_SPACE_DATA_TABLE,\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\n}\r\n#endif\r\nif (op->common.aml_opcode == AML_NAME_OP) {\r\nif (op->common.value.arg) {\r\nobject_type = (acpi_ps_get_opcode_info((op->common.\r\nvalue.arg)->\r\ncommon.\r\naml_opcode))->\r\nobject_type;\r\nif (op->common.node) {\r\nop->common.node->type = (u8) object_type;\r\n}\r\n}\r\n}\r\nif (!walk_state->method_node) {\r\nif (op->common.aml_opcode == AML_METHOD_OP) {\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"LOADING-Method: State=%p Op=%p NamedObj=%p\n",\r\nwalk_state, op, op->named.node));\r\nif (!acpi_ns_get_attached_object(op->named.node)) {\r\nwalk_state->operands[0] =\r\nACPI_CAST_PTR(void, op->named.node);\r\nwalk_state->num_operands = 1;\r\nstatus =\r\nacpi_ds_create_operands(walk_state,\r\nop->common.value.\r\narg);\r\nif (ACPI_SUCCESS(status)) {\r\nstatus =\r\nacpi_ex_create_method(op->named.\r\ndata,\r\nop->named.\r\nlength,\r\nwalk_state);\r\n}\r\nwalk_state->operands[0] = NULL;\r\nwalk_state->num_operands = 0;\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\n}\r\n}\r\nif (!walk_state->method_node && acpi_ns_opens_scope(object_type)) {\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"(%s): Popping scope for Op %p\n",\r\nacpi_ut_get_type_name(object_type), op));\r\nstatus = acpi_ds_scope_stack_pop(walk_state);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}

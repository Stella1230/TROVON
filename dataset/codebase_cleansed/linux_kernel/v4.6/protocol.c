void usb_stor_pad12_command(struct scsi_cmnd *srb, struct us_data *us)\r\n{\r\nfor (; srb->cmd_len < 12; srb->cmd_len++)\r\nsrb->cmnd[srb->cmd_len] = 0;\r\nusb_stor_invoke_transport(srb, us);\r\n}\r\nvoid usb_stor_ufi_command(struct scsi_cmnd *srb, struct us_data *us)\r\n{\r\nfor (; srb->cmd_len < 12; srb->cmd_len++)\r\nsrb->cmnd[srb->cmd_len] = 0;\r\nsrb->cmd_len = 12;\r\nswitch (srb->cmnd[0]) {\r\ncase INQUIRY:\r\nsrb->cmnd[4] = 36;\r\nbreak;\r\ncase MODE_SENSE_10:\r\nsrb->cmnd[7] = 0;\r\nsrb->cmnd[8] = 8;\r\nbreak;\r\ncase REQUEST_SENSE:\r\nsrb->cmnd[4] = 18;\r\nbreak;\r\n}\r\nusb_stor_invoke_transport(srb, us);\r\n}\r\nvoid usb_stor_transparent_scsi_command(struct scsi_cmnd *srb,\r\nstruct us_data *us)\r\n{\r\nusb_stor_invoke_transport(srb, us);\r\n}\r\nunsigned int usb_stor_access_xfer_buf(unsigned char *buffer,\r\nunsigned int buflen, struct scsi_cmnd *srb, struct scatterlist **sgptr,\r\nunsigned int *offset, enum xfer_buf_dir dir)\r\n{\r\nunsigned int cnt = 0;\r\nstruct scatterlist *sg = *sgptr;\r\nstruct sg_mapping_iter miter;\r\nunsigned int nents = scsi_sg_count(srb);\r\nif (sg)\r\nnents = sg_nents(sg);\r\nelse\r\nsg = scsi_sglist(srb);\r\nsg_miter_start(&miter, sg, nents, dir == FROM_XFER_BUF ?\r\nSG_MITER_FROM_SG: SG_MITER_TO_SG);\r\nif (!sg_miter_skip(&miter, *offset))\r\nreturn cnt;\r\nwhile (sg_miter_next(&miter) && cnt < buflen) {\r\nunsigned int len = min_t(unsigned int, miter.length,\r\nbuflen - cnt);\r\nif (dir == FROM_XFER_BUF)\r\nmemcpy(buffer + cnt, miter.addr, len);\r\nelse\r\nmemcpy(miter.addr, buffer + cnt, len);\r\nif (*offset + len < miter.piter.sg->length) {\r\n*offset += len;\r\n*sgptr = miter.piter.sg;\r\n} else {\r\n*offset = 0;\r\n*sgptr = sg_next(miter.piter.sg);\r\n}\r\ncnt += len;\r\n}\r\nsg_miter_stop(&miter);\r\nreturn cnt;\r\n}\r\nvoid usb_stor_set_xfer_buf(unsigned char *buffer,\r\nunsigned int buflen, struct scsi_cmnd *srb)\r\n{\r\nunsigned int offset = 0;\r\nstruct scatterlist *sg = NULL;\r\nbuflen = min(buflen, scsi_bufflen(srb));\r\nbuflen = usb_stor_access_xfer_buf(buffer, buflen, srb, &sg, &offset,\r\nTO_XFER_BUF);\r\nif (buflen < scsi_bufflen(srb))\r\nscsi_set_resid(srb, scsi_bufflen(srb) - buflen);\r\n}

int\r\nparse_branch_stack(const struct option *opt, const char *str, int unset)\r\n{\r\n#define ONLY_PLM \\r\n(PERF_SAMPLE_BRANCH_USER |\\r\nPERF_SAMPLE_BRANCH_KERNEL |\\r\nPERF_SAMPLE_BRANCH_HV)\r\nuint64_t *mode = (uint64_t *)opt->value;\r\nconst struct branch_mode *br;\r\nchar *s, *os = NULL, *p;\r\nint ret = -1;\r\nif (unset)\r\nreturn 0;\r\nif (*mode)\r\nreturn -1;\r\nif (str) {\r\ns = os = strdup(str);\r\nif (!s)\r\nreturn -1;\r\nfor (;;) {\r\np = strchr(s, ',');\r\nif (p)\r\n*p = '\0';\r\nfor (br = branch_modes; br->name; br++) {\r\nif (!strcasecmp(s, br->name))\r\nbreak;\r\n}\r\nif (!br->name) {\r\nui__warning("unknown branch filter %s,"\r\n" check man page\n", s);\r\ngoto error;\r\n}\r\n*mode |= br->mode;\r\nif (!p)\r\nbreak;\r\ns = p + 1;\r\n}\r\n}\r\nret = 0;\r\nif ((*mode & ~ONLY_PLM) == 0) {\r\n*mode = PERF_SAMPLE_BRANCH_ANY;\r\n}\r\nerror:\r\nfree(os);\r\nreturn ret;\r\n}

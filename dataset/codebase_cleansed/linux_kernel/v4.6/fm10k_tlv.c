s32 fm10k_tlv_msg_init(u32 *msg, u16 msg_id)\r\n{\r\nif (!msg)\r\nreturn FM10K_ERR_PARAM;\r\n*msg = (FM10K_TLV_FLAGS_MSG << FM10K_TLV_FLAGS_SHIFT) | msg_id;\r\nreturn 0;\r\n}\r\nstatic s32 fm10k_tlv_attr_put_null_string(u32 *msg, u16 attr_id,\r\nconst unsigned char *string)\r\n{\r\nu32 attr_data = 0, len = 0;\r\nu32 *attr;\r\nif (!string || !msg)\r\nreturn FM10K_ERR_PARAM;\r\nattr = &msg[FM10K_TLV_DWORD_LEN(*msg)];\r\ndo {\r\nif (len && !(len % 4)) {\r\nattr[len / 4] = attr_data;\r\nattr_data = 0;\r\n}\r\nattr_data |= (u32)(*string) << (8 * (len % 4));\r\nlen++;\r\n} while (*(string++));\r\nattr[(len + 3) / 4] = attr_data;\r\nlen <<= FM10K_TLV_LEN_SHIFT;\r\nattr[0] = len | attr_id;\r\nlen += FM10K_TLV_HDR_LEN << FM10K_TLV_LEN_SHIFT;\r\n*msg += FM10K_TLV_LEN_ALIGN(len);\r\nreturn 0;\r\n}\r\nstatic s32 fm10k_tlv_attr_get_null_string(u32 *attr, unsigned char *string)\r\n{\r\nu32 len;\r\nif (!string || !attr)\r\nreturn FM10K_ERR_PARAM;\r\nlen = *attr >> FM10K_TLV_LEN_SHIFT;\r\nattr++;\r\nwhile (len--)\r\nstring[len] = (u8)(attr[len / 4] >> (8 * (len % 4)));\r\nreturn 0;\r\n}\r\ns32 fm10k_tlv_attr_put_mac_vlan(u32 *msg, u16 attr_id,\r\nconst u8 *mac_addr, u16 vlan)\r\n{\r\nu32 len = ETH_ALEN << FM10K_TLV_LEN_SHIFT;\r\nu32 *attr;\r\nif (!msg || !mac_addr)\r\nreturn FM10K_ERR_PARAM;\r\nattr = &msg[FM10K_TLV_DWORD_LEN(*msg)];\r\nattr[0] = len | attr_id;\r\nattr[1] = le32_to_cpu(*(const __le32 *)&mac_addr[0]);\r\nattr[2] = le16_to_cpu(*(const __le16 *)&mac_addr[4]);\r\nattr[2] |= (u32)vlan << 16;\r\nlen += FM10K_TLV_HDR_LEN << FM10K_TLV_LEN_SHIFT;\r\n*msg += FM10K_TLV_LEN_ALIGN(len);\r\nreturn 0;\r\n}\r\ns32 fm10k_tlv_attr_get_mac_vlan(u32 *attr, u8 *mac_addr, u16 *vlan)\r\n{\r\nif (!mac_addr || !attr)\r\nreturn FM10K_ERR_PARAM;\r\n*(__le32 *)&mac_addr[0] = cpu_to_le32(attr[1]);\r\n*(__le16 *)&mac_addr[4] = cpu_to_le16((u16)(attr[2]));\r\n*vlan = (u16)(attr[2] >> 16);\r\nreturn 0;\r\n}\r\ns32 fm10k_tlv_attr_put_bool(u32 *msg, u16 attr_id)\r\n{\r\nif (!msg)\r\nreturn FM10K_ERR_PARAM;\r\nmsg[FM10K_TLV_DWORD_LEN(*msg)] = attr_id;\r\n*msg += FM10K_TLV_HDR_LEN << FM10K_TLV_LEN_SHIFT;\r\nreturn 0;\r\n}\r\ns32 fm10k_tlv_attr_put_value(u32 *msg, u16 attr_id, s64 value, u32 len)\r\n{\r\nu32 *attr;\r\nif (!msg || !len || len > 8 || (len & (len - 1)))\r\nreturn FM10K_ERR_PARAM;\r\nattr = &msg[FM10K_TLV_DWORD_LEN(*msg)];\r\nif (len < 4) {\r\nattr[1] = (u32)value & ((0x1ul << (8 * len)) - 1);\r\n} else {\r\nattr[1] = (u32)value;\r\nif (len > 4)\r\nattr[2] = (u32)(value >> 32);\r\n}\r\nlen <<= FM10K_TLV_LEN_SHIFT;\r\nattr[0] = len | attr_id;\r\nlen += FM10K_TLV_HDR_LEN << FM10K_TLV_LEN_SHIFT;\r\n*msg += FM10K_TLV_LEN_ALIGN(len);\r\nreturn 0;\r\n}\r\ns32 fm10k_tlv_attr_get_value(u32 *attr, void *value, u32 len)\r\n{\r\nif (!attr || !value)\r\nreturn FM10K_ERR_PARAM;\r\nif ((*attr >> FM10K_TLV_LEN_SHIFT) != len)\r\nreturn FM10K_ERR_PARAM;\r\nif (len == 8)\r\n*(u64 *)value = ((u64)attr[2] << 32) | attr[1];\r\nelse if (len == 4)\r\n*(u32 *)value = attr[1];\r\nelse if (len == 2)\r\n*(u16 *)value = (u16)attr[1];\r\nelse\r\n*(u8 *)value = (u8)attr[1];\r\nreturn 0;\r\n}\r\ns32 fm10k_tlv_attr_put_le_struct(u32 *msg, u16 attr_id,\r\nconst void *le_struct, u32 len)\r\n{\r\nconst __le32 *le32_ptr = (const __le32 *)le_struct;\r\nu32 *attr;\r\nu32 i;\r\nif (!msg || !len || (len % 4))\r\nreturn FM10K_ERR_PARAM;\r\nattr = &msg[FM10K_TLV_DWORD_LEN(*msg)];\r\nfor (i = 0; i < (len / 4); i++)\r\nattr[i + 1] = le32_to_cpu(le32_ptr[i]);\r\nlen <<= FM10K_TLV_LEN_SHIFT;\r\nattr[0] = len | attr_id;\r\nlen += FM10K_TLV_HDR_LEN << FM10K_TLV_LEN_SHIFT;\r\n*msg += FM10K_TLV_LEN_ALIGN(len);\r\nreturn 0;\r\n}\r\ns32 fm10k_tlv_attr_get_le_struct(u32 *attr, void *le_struct, u32 len)\r\n{\r\n__le32 *le32_ptr = (__le32 *)le_struct;\r\nu32 i;\r\nif (!le_struct || !attr)\r\nreturn FM10K_ERR_PARAM;\r\nif ((*attr >> FM10K_TLV_LEN_SHIFT) != len)\r\nreturn FM10K_ERR_PARAM;\r\nattr++;\r\nfor (i = 0; len; i++, len -= 4)\r\nle32_ptr[i] = cpu_to_le32(attr[i]);\r\nreturn 0;\r\n}\r\nstatic u32 *fm10k_tlv_attr_nest_start(u32 *msg, u16 attr_id)\r\n{\r\nu32 *attr;\r\nif (!msg)\r\nreturn NULL;\r\nattr = &msg[FM10K_TLV_DWORD_LEN(*msg)];\r\nattr[0] = attr_id;\r\nreturn attr;\r\n}\r\nstatic s32 fm10k_tlv_attr_nest_stop(u32 *msg)\r\n{\r\nu32 *attr;\r\nu32 len;\r\nif (!msg)\r\nreturn FM10K_ERR_PARAM;\r\nattr = &msg[FM10K_TLV_DWORD_LEN(*msg)];\r\nlen = (attr[0] >> FM10K_TLV_LEN_SHIFT) << FM10K_TLV_LEN_SHIFT;\r\nif (len) {\r\nlen += FM10K_TLV_HDR_LEN << FM10K_TLV_LEN_SHIFT;\r\n*msg += len;\r\n}\r\nreturn 0;\r\n}\r\nstatic s32 fm10k_tlv_attr_validate(u32 *attr,\r\nconst struct fm10k_tlv_attr *tlv_attr)\r\n{\r\nu32 attr_id = *attr & FM10K_TLV_ID_MASK;\r\nu16 len = *attr >> FM10K_TLV_LEN_SHIFT;\r\nif (*attr & (FM10K_TLV_FLAGS_MSG << FM10K_TLV_FLAGS_SHIFT))\r\nreturn FM10K_ERR_PARAM;\r\nwhile (tlv_attr->id < attr_id)\r\ntlv_attr++;\r\nif (tlv_attr->id != attr_id)\r\nreturn FM10K_NOT_IMPLEMENTED;\r\nattr++;\r\nswitch (tlv_attr->type) {\r\ncase FM10K_TLV_NULL_STRING:\r\nif (!len ||\r\n(attr[(len - 1) / 4] & (0xFF << (8 * ((len - 1) % 4)))))\r\nreturn FM10K_ERR_PARAM;\r\nif (len > tlv_attr->len)\r\nreturn FM10K_ERR_PARAM;\r\nbreak;\r\ncase FM10K_TLV_MAC_ADDR:\r\nif (len != ETH_ALEN)\r\nreturn FM10K_ERR_PARAM;\r\nbreak;\r\ncase FM10K_TLV_BOOL:\r\nif (len)\r\nreturn FM10K_ERR_PARAM;\r\nbreak;\r\ncase FM10K_TLV_UNSIGNED:\r\ncase FM10K_TLV_SIGNED:\r\nif (len != tlv_attr->len)\r\nreturn FM10K_ERR_PARAM;\r\nbreak;\r\ncase FM10K_TLV_LE_STRUCT:\r\nif ((len % 4) || len != tlv_attr->len)\r\nreturn FM10K_ERR_PARAM;\r\nbreak;\r\ncase FM10K_TLV_NESTED:\r\nif (len % 4)\r\nreturn FM10K_ERR_PARAM;\r\nbreak;\r\ndefault:\r\nreturn FM10K_ERR_PARAM;\r\n}\r\nreturn 0;\r\n}\r\nstatic s32 fm10k_tlv_attr_parse(u32 *attr, u32 **results,\r\nconst struct fm10k_tlv_attr *tlv_attr)\r\n{\r\nu32 i, attr_id, offset = 0;\r\ns32 err = 0;\r\nu16 len;\r\nif (!attr || !results)\r\nreturn FM10K_ERR_PARAM;\r\nfor (i = 0; i < FM10K_TLV_RESULTS_MAX; i++)\r\nresults[i] = NULL;\r\nlen = *attr >> FM10K_TLV_LEN_SHIFT;\r\nif (!len)\r\nreturn 0;\r\nif (!tlv_attr) {\r\nresults[0] = attr;\r\nreturn 0;\r\n}\r\nattr++;\r\nwhile (offset < len) {\r\nattr_id = *attr & FM10K_TLV_ID_MASK;\r\nif (attr_id < FM10K_TLV_RESULTS_MAX)\r\nerr = fm10k_tlv_attr_validate(attr, tlv_attr);\r\nelse\r\nerr = FM10K_NOT_IMPLEMENTED;\r\nif (err < 0)\r\nreturn err;\r\nif (!err)\r\nresults[attr_id] = attr;\r\noffset += FM10K_TLV_DWORD_LEN(*attr) * 4;\r\nattr = &attr[FM10K_TLV_DWORD_LEN(*attr)];\r\n}\r\nif (offset != len)\r\nreturn FM10K_ERR_PARAM;\r\nreturn 0;\r\n}\r\ns32 fm10k_tlv_msg_parse(struct fm10k_hw *hw, u32 *msg,\r\nstruct fm10k_mbx_info *mbx,\r\nconst struct fm10k_msg_data *data)\r\n{\r\nu32 *results[FM10K_TLV_RESULTS_MAX];\r\nu32 msg_id;\r\ns32 err;\r\nif (!msg || !data)\r\nreturn FM10K_ERR_PARAM;\r\nif (!(*msg & (FM10K_TLV_FLAGS_MSG << FM10K_TLV_FLAGS_SHIFT)))\r\nreturn FM10K_ERR_PARAM;\r\nmsg_id = *msg & FM10K_TLV_ID_MASK;\r\nwhile (data->id < msg_id)\r\ndata++;\r\nif (data->id != msg_id) {\r\nwhile (data->id != FM10K_TLV_ERROR)\r\ndata++;\r\n}\r\nerr = fm10k_tlv_attr_parse(msg, results, data->attr);\r\nif (err < 0)\r\nreturn err;\r\nreturn data->func(hw, results, mbx);\r\n}\r\ns32 fm10k_tlv_msg_error(struct fm10k_hw *hw, u32 **results,\r\nstruct fm10k_mbx_info *mbx)\r\n{\r\nreturn FM10K_NOT_IMPLEMENTED;\r\n}\r\nstatic void fm10k_tlv_msg_test_generate_data(u32 *msg, u32 attr_flags)\r\n{\r\nif (attr_flags & (1 << FM10K_TEST_MSG_STRING))\r\nfm10k_tlv_attr_put_null_string(msg, FM10K_TEST_MSG_STRING,\r\ntest_str);\r\nif (attr_flags & (1 << FM10K_TEST_MSG_MAC_ADDR))\r\nfm10k_tlv_attr_put_mac_vlan(msg, FM10K_TEST_MSG_MAC_ADDR,\r\ntest_mac, test_vlan);\r\nif (attr_flags & (1 << FM10K_TEST_MSG_U8))\r\nfm10k_tlv_attr_put_u8(msg, FM10K_TEST_MSG_U8, test_u8);\r\nif (attr_flags & (1 << FM10K_TEST_MSG_U16))\r\nfm10k_tlv_attr_put_u16(msg, FM10K_TEST_MSG_U16, test_u16);\r\nif (attr_flags & (1 << FM10K_TEST_MSG_U32))\r\nfm10k_tlv_attr_put_u32(msg, FM10K_TEST_MSG_U32, test_u32);\r\nif (attr_flags & (1 << FM10K_TEST_MSG_U64))\r\nfm10k_tlv_attr_put_u64(msg, FM10K_TEST_MSG_U64, test_u64);\r\nif (attr_flags & (1 << FM10K_TEST_MSG_S8))\r\nfm10k_tlv_attr_put_s8(msg, FM10K_TEST_MSG_S8, test_s8);\r\nif (attr_flags & (1 << FM10K_TEST_MSG_S16))\r\nfm10k_tlv_attr_put_s16(msg, FM10K_TEST_MSG_S16, test_s16);\r\nif (attr_flags & (1 << FM10K_TEST_MSG_S32))\r\nfm10k_tlv_attr_put_s32(msg, FM10K_TEST_MSG_S32, test_s32);\r\nif (attr_flags & (1 << FM10K_TEST_MSG_S64))\r\nfm10k_tlv_attr_put_s64(msg, FM10K_TEST_MSG_S64, test_s64);\r\nif (attr_flags & (1 << FM10K_TEST_MSG_LE_STRUCT))\r\nfm10k_tlv_attr_put_le_struct(msg, FM10K_TEST_MSG_LE_STRUCT,\r\ntest_le, 8);\r\n}\r\nvoid fm10k_tlv_msg_test_create(u32 *msg, u32 attr_flags)\r\n{\r\nu32 *nest = NULL;\r\nfm10k_tlv_msg_init(msg, FM10K_TLV_MSG_ID_TEST);\r\nfm10k_tlv_msg_test_generate_data(msg, attr_flags);\r\nattr_flags >>= FM10K_TEST_MSG_NESTED;\r\nif (attr_flags) {\r\nnest = fm10k_tlv_attr_nest_start(msg, FM10K_TEST_MSG_NESTED);\r\nfm10k_tlv_msg_test_generate_data(nest, attr_flags);\r\nfm10k_tlv_attr_nest_stop(msg);\r\n}\r\n}\r\ns32 fm10k_tlv_msg_test(struct fm10k_hw *hw, u32 **results,\r\nstruct fm10k_mbx_info *mbx)\r\n{\r\nu32 *nest_results[FM10K_TLV_RESULTS_MAX];\r\nunsigned char result_str[80];\r\nunsigned char result_mac[ETH_ALEN];\r\ns32 err = 0;\r\n__le32 result_le[2];\r\nu16 result_vlan;\r\nu64 result_u64;\r\nu32 result_u32;\r\nu16 result_u16;\r\nu8 result_u8;\r\ns64 result_s64;\r\ns32 result_s32;\r\ns16 result_s16;\r\ns8 result_s8;\r\nu32 reply[3];\r\nif (!!results[FM10K_TEST_MSG_RESULT])\r\nreturn fm10k_tlv_attr_get_s32(results[FM10K_TEST_MSG_RESULT],\r\n&mbx->test_result);\r\nparse_nested:\r\nif (!!results[FM10K_TEST_MSG_STRING]) {\r\nerr = fm10k_tlv_attr_get_null_string(\r\nresults[FM10K_TEST_MSG_STRING],\r\nresult_str);\r\nif (!err && memcmp(test_str, result_str, sizeof(test_str)))\r\nerr = FM10K_ERR_INVALID_VALUE;\r\nif (err)\r\ngoto report_result;\r\n}\r\nif (!!results[FM10K_TEST_MSG_MAC_ADDR]) {\r\nerr = fm10k_tlv_attr_get_mac_vlan(\r\nresults[FM10K_TEST_MSG_MAC_ADDR],\r\nresult_mac, &result_vlan);\r\nif (!err && !ether_addr_equal(test_mac, result_mac))\r\nerr = FM10K_ERR_INVALID_VALUE;\r\nif (!err && test_vlan != result_vlan)\r\nerr = FM10K_ERR_INVALID_VALUE;\r\nif (err)\r\ngoto report_result;\r\n}\r\nif (!!results[FM10K_TEST_MSG_U8]) {\r\nerr = fm10k_tlv_attr_get_u8(results[FM10K_TEST_MSG_U8],\r\n&result_u8);\r\nif (!err && test_u8 != result_u8)\r\nerr = FM10K_ERR_INVALID_VALUE;\r\nif (err)\r\ngoto report_result;\r\n}\r\nif (!!results[FM10K_TEST_MSG_U16]) {\r\nerr = fm10k_tlv_attr_get_u16(results[FM10K_TEST_MSG_U16],\r\n&result_u16);\r\nif (!err && test_u16 != result_u16)\r\nerr = FM10K_ERR_INVALID_VALUE;\r\nif (err)\r\ngoto report_result;\r\n}\r\nif (!!results[FM10K_TEST_MSG_U32]) {\r\nerr = fm10k_tlv_attr_get_u32(results[FM10K_TEST_MSG_U32],\r\n&result_u32);\r\nif (!err && test_u32 != result_u32)\r\nerr = FM10K_ERR_INVALID_VALUE;\r\nif (err)\r\ngoto report_result;\r\n}\r\nif (!!results[FM10K_TEST_MSG_U64]) {\r\nerr = fm10k_tlv_attr_get_u64(results[FM10K_TEST_MSG_U64],\r\n&result_u64);\r\nif (!err && test_u64 != result_u64)\r\nerr = FM10K_ERR_INVALID_VALUE;\r\nif (err)\r\ngoto report_result;\r\n}\r\nif (!!results[FM10K_TEST_MSG_S8]) {\r\nerr = fm10k_tlv_attr_get_s8(results[FM10K_TEST_MSG_S8],\r\n&result_s8);\r\nif (!err && test_s8 != result_s8)\r\nerr = FM10K_ERR_INVALID_VALUE;\r\nif (err)\r\ngoto report_result;\r\n}\r\nif (!!results[FM10K_TEST_MSG_S16]) {\r\nerr = fm10k_tlv_attr_get_s16(results[FM10K_TEST_MSG_S16],\r\n&result_s16);\r\nif (!err && test_s16 != result_s16)\r\nerr = FM10K_ERR_INVALID_VALUE;\r\nif (err)\r\ngoto report_result;\r\n}\r\nif (!!results[FM10K_TEST_MSG_S32]) {\r\nerr = fm10k_tlv_attr_get_s32(results[FM10K_TEST_MSG_S32],\r\n&result_s32);\r\nif (!err && test_s32 != result_s32)\r\nerr = FM10K_ERR_INVALID_VALUE;\r\nif (err)\r\ngoto report_result;\r\n}\r\nif (!!results[FM10K_TEST_MSG_S64]) {\r\nerr = fm10k_tlv_attr_get_s64(results[FM10K_TEST_MSG_S64],\r\n&result_s64);\r\nif (!err && test_s64 != result_s64)\r\nerr = FM10K_ERR_INVALID_VALUE;\r\nif (err)\r\ngoto report_result;\r\n}\r\nif (!!results[FM10K_TEST_MSG_LE_STRUCT]) {\r\nerr = fm10k_tlv_attr_get_le_struct(\r\nresults[FM10K_TEST_MSG_LE_STRUCT],\r\nresult_le,\r\nsizeof(result_le));\r\nif (!err && memcmp(test_le, result_le, sizeof(test_le)))\r\nerr = FM10K_ERR_INVALID_VALUE;\r\nif (err)\r\ngoto report_result;\r\n}\r\nif (!!results[FM10K_TEST_MSG_NESTED]) {\r\nmemset(nest_results, 0, sizeof(nest_results));\r\nerr = fm10k_tlv_attr_parse(results[FM10K_TEST_MSG_NESTED],\r\nnest_results,\r\nfm10k_tlv_msg_test_attr);\r\nif (err)\r\ngoto report_result;\r\nresults = nest_results;\r\ngoto parse_nested;\r\n}\r\nreport_result:\r\nfm10k_tlv_msg_init(reply, FM10K_TLV_MSG_ID_TEST);\r\nfm10k_tlv_attr_put_s32(reply, FM10K_TEST_MSG_RESULT, err);\r\nreturn mbx->ops.enqueue_tx(hw, mbx, reply);\r\n}

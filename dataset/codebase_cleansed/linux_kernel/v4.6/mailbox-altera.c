static struct altera_mbox *mbox_chan_to_altera_mbox(struct mbox_chan *chan)\r\n{\r\nif (!chan || !chan->con_priv)\r\nreturn NULL;\r\nreturn (struct altera_mbox *)chan->con_priv;\r\n}\r\nstatic inline int altera_mbox_full(struct altera_mbox *mbox)\r\n{\r\nu32 status;\r\nstatus = readl_relaxed(mbox->mbox_base + MAILBOX_STS_REG);\r\nreturn MBOX_FULL(status);\r\n}\r\nstatic inline int altera_mbox_pending(struct altera_mbox *mbox)\r\n{\r\nu32 status;\r\nstatus = readl_relaxed(mbox->mbox_base + MAILBOX_STS_REG);\r\nreturn MBOX_PENDING(status);\r\n}\r\nstatic void altera_mbox_rx_intmask(struct altera_mbox *mbox, bool enable)\r\n{\r\nu32 mask;\r\nmask = readl_relaxed(mbox->mbox_base + MAILBOX_INTMASK_REG);\r\nif (enable)\r\nmask |= INT_PENDING_MSK;\r\nelse\r\nmask &= ~INT_PENDING_MSK;\r\nwritel_relaxed(mask, mbox->mbox_base + MAILBOX_INTMASK_REG);\r\n}\r\nstatic void altera_mbox_tx_intmask(struct altera_mbox *mbox, bool enable)\r\n{\r\nu32 mask;\r\nmask = readl_relaxed(mbox->mbox_base + MAILBOX_INTMASK_REG);\r\nif (enable)\r\nmask |= INT_SPACE_MSK;\r\nelse\r\nmask &= ~INT_SPACE_MSK;\r\nwritel_relaxed(mask, mbox->mbox_base + MAILBOX_INTMASK_REG);\r\n}\r\nstatic bool altera_mbox_is_sender(struct altera_mbox *mbox)\r\n{\r\nu32 reg;\r\n#define MBOX_MAGIC 0xA5A5AA55\r\nwritel_relaxed(MBOX_MAGIC, mbox->mbox_base + MAILBOX_PTR_REG);\r\nreg = readl_relaxed(mbox->mbox_base + MAILBOX_PTR_REG);\r\nif (reg == MBOX_MAGIC) {\r\nwritel_relaxed(0, mbox->mbox_base + MAILBOX_PTR_REG);\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic void altera_mbox_rx_data(struct mbox_chan *chan)\r\n{\r\nstruct altera_mbox *mbox = mbox_chan_to_altera_mbox(chan);\r\nu32 data[2];\r\nif (altera_mbox_pending(mbox)) {\r\ndata[MBOX_PTR] =\r\nreadl_relaxed(mbox->mbox_base + MAILBOX_PTR_REG);\r\ndata[MBOX_CMD] =\r\nreadl_relaxed(mbox->mbox_base + MAILBOX_CMD_REG);\r\nmbox_chan_received_data(chan, (void *)data);\r\n}\r\n}\r\nstatic void altera_mbox_poll_rx(unsigned long data)\r\n{\r\nstruct mbox_chan *chan = (struct mbox_chan *)data;\r\nstruct altera_mbox *mbox = mbox_chan_to_altera_mbox(chan);\r\naltera_mbox_rx_data(chan);\r\nmod_timer(&mbox->rxpoll_timer,\r\njiffies + msecs_to_jiffies(MBOX_POLLING_MS));\r\n}\r\nstatic irqreturn_t altera_mbox_tx_interrupt(int irq, void *p)\r\n{\r\nstruct mbox_chan *chan = (struct mbox_chan *)p;\r\nstruct altera_mbox *mbox = mbox_chan_to_altera_mbox(chan);\r\naltera_mbox_tx_intmask(mbox, false);\r\nmbox_chan_txdone(chan, 0);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t altera_mbox_rx_interrupt(int irq, void *p)\r\n{\r\nstruct mbox_chan *chan = (struct mbox_chan *)p;\r\naltera_mbox_rx_data(chan);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int altera_mbox_startup_sender(struct mbox_chan *chan)\r\n{\r\nint ret;\r\nstruct altera_mbox *mbox = mbox_chan_to_altera_mbox(chan);\r\nif (mbox->intr_mode) {\r\nret = request_irq(mbox->irq, altera_mbox_tx_interrupt, 0,\r\nDRIVER_NAME, chan);\r\nif (unlikely(ret)) {\r\ndev_err(mbox->dev,\r\n"failed to register mailbox interrupt:%d\n",\r\nret);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int altera_mbox_startup_receiver(struct mbox_chan *chan)\r\n{\r\nint ret;\r\nstruct altera_mbox *mbox = mbox_chan_to_altera_mbox(chan);\r\nif (mbox->intr_mode) {\r\nret = request_irq(mbox->irq, altera_mbox_rx_interrupt, 0,\r\nDRIVER_NAME, chan);\r\nif (unlikely(ret)) {\r\nmbox->intr_mode = false;\r\ngoto polling;\r\n}\r\naltera_mbox_rx_intmask(mbox, true);\r\nreturn 0;\r\n}\r\npolling:\r\nsetup_timer(&mbox->rxpoll_timer, altera_mbox_poll_rx,\r\n(unsigned long)chan);\r\nmod_timer(&mbox->rxpoll_timer,\r\njiffies + msecs_to_jiffies(MBOX_POLLING_MS));\r\nreturn 0;\r\n}\r\nstatic int altera_mbox_send_data(struct mbox_chan *chan, void *data)\r\n{\r\nstruct altera_mbox *mbox = mbox_chan_to_altera_mbox(chan);\r\nu32 *udata = (u32 *)data;\r\nif (!mbox || !data)\r\nreturn -EINVAL;\r\nif (!mbox->is_sender) {\r\ndev_warn(mbox->dev,\r\n"failed to send. This is receiver mailbox.\n");\r\nreturn -EINVAL;\r\n}\r\nif (altera_mbox_full(mbox))\r\nreturn -EBUSY;\r\nif (mbox->intr_mode)\r\naltera_mbox_tx_intmask(mbox, true);\r\nwritel_relaxed(udata[MBOX_PTR], mbox->mbox_base + MAILBOX_PTR_REG);\r\nwritel_relaxed(udata[MBOX_CMD], mbox->mbox_base + MAILBOX_CMD_REG);\r\nreturn 0;\r\n}\r\nstatic bool altera_mbox_last_tx_done(struct mbox_chan *chan)\r\n{\r\nstruct altera_mbox *mbox = mbox_chan_to_altera_mbox(chan);\r\nreturn altera_mbox_full(mbox) ? false : true;\r\n}\r\nstatic bool altera_mbox_peek_data(struct mbox_chan *chan)\r\n{\r\nstruct altera_mbox *mbox = mbox_chan_to_altera_mbox(chan);\r\nreturn altera_mbox_pending(mbox) ? true : false;\r\n}\r\nstatic int altera_mbox_startup(struct mbox_chan *chan)\r\n{\r\nstruct altera_mbox *mbox = mbox_chan_to_altera_mbox(chan);\r\nint ret = 0;\r\nif (!mbox)\r\nreturn -EINVAL;\r\nif (mbox->is_sender)\r\nret = altera_mbox_startup_sender(chan);\r\nelse\r\nret = altera_mbox_startup_receiver(chan);\r\nreturn ret;\r\n}\r\nstatic void altera_mbox_shutdown(struct mbox_chan *chan)\r\n{\r\nstruct altera_mbox *mbox = mbox_chan_to_altera_mbox(chan);\r\nif (mbox->intr_mode) {\r\nwritel_relaxed(~0, mbox->mbox_base + MAILBOX_INTMASK_REG);\r\nfree_irq(mbox->irq, chan);\r\n} else if (!mbox->is_sender) {\r\ndel_timer_sync(&mbox->rxpoll_timer);\r\n}\r\n}\r\nstatic int altera_mbox_probe(struct platform_device *pdev)\r\n{\r\nstruct altera_mbox *mbox;\r\nstruct resource *regs;\r\nstruct mbox_chan *chans;\r\nint ret;\r\nmbox = devm_kzalloc(&pdev->dev, sizeof(*mbox),\r\nGFP_KERNEL);\r\nif (!mbox)\r\nreturn -ENOMEM;\r\nchans = devm_kzalloc(&pdev->dev, sizeof(*chans), GFP_KERNEL);\r\nif (!chans)\r\nreturn -ENOMEM;\r\nregs = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nmbox->mbox_base = devm_ioremap_resource(&pdev->dev, regs);\r\nif (IS_ERR(mbox->mbox_base))\r\nreturn PTR_ERR(mbox->mbox_base);\r\nmbox->is_sender = altera_mbox_is_sender(mbox);\r\nmbox->irq = platform_get_irq(pdev, 0);\r\nif (mbox->irq >= 0)\r\nmbox->intr_mode = true;\r\nmbox->dev = &pdev->dev;\r\nchans[0].con_priv = mbox;\r\nmbox->controller.dev = mbox->dev;\r\nmbox->controller.num_chans = 1;\r\nmbox->controller.chans = chans;\r\nmbox->controller.ops = &altera_mbox_ops;\r\nif (mbox->is_sender) {\r\nif (mbox->intr_mode) {\r\nmbox->controller.txdone_irq = true;\r\n} else {\r\nmbox->controller.txdone_poll = true;\r\nmbox->controller.txpoll_period = MBOX_POLLING_MS;\r\n}\r\n}\r\nret = mbox_controller_register(&mbox->controller);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Register mailbox failed\n");\r\ngoto err;\r\n}\r\nplatform_set_drvdata(pdev, mbox);\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int altera_mbox_remove(struct platform_device *pdev)\r\n{\r\nstruct altera_mbox *mbox = platform_get_drvdata(pdev);\r\nif (!mbox)\r\nreturn -EINVAL;\r\nmbox_controller_unregister(&mbox->controller);\r\nreturn 0;\r\n}

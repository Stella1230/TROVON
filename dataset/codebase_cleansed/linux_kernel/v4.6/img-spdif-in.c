static inline void img_spdif_in_writel(struct img_spdif_in *spdif,\r\nu32 val, u32 reg)\r\n{\r\nwritel(val, spdif->base + reg);\r\n}\r\nstatic inline u32 img_spdif_in_readl(struct img_spdif_in *spdif, u32 reg)\r\n{\r\nreturn readl(spdif->base + reg);\r\n}\r\nstatic inline void img_spdif_in_aclkgen_writel(struct img_spdif_in *spdif,\r\nu32 index)\r\n{\r\nimg_spdif_in_writel(spdif, spdif->aclkgen_regs[index],\r\nIMG_SPDIF_IN_ACLKGEN_START + (index * 0x4));\r\n}\r\nstatic int img_spdif_in_check_max_rate(struct img_spdif_in *spdif,\r\nunsigned int sample_rate, unsigned long *actual_freq)\r\n{\r\nunsigned long min_freq, freq_t;\r\nmin_freq = sample_rate * 2 * 32 * 24;\r\nfreq_t = clk_get_rate(spdif->clk_sys);\r\nif (freq_t < min_freq)\r\nreturn -EINVAL;\r\n*actual_freq = freq_t;\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_do_clkgen_calc(unsigned int rate, unsigned int *pnom,\r\nunsigned int *phld, unsigned long clk_rate)\r\n{\r\nunsigned int ori, nom, hld;\r\nif (!rate)\r\nreturn -EINVAL;\r\nori = clk_rate / (rate * 64);\r\nif (!ori)\r\nreturn -EINVAL;\r\nnom = (4096 / ori) + 1;\r\ndo\r\nhld = 4096 - (--nom * (ori - 1));\r\nwhile (hld < 120);\r\n*pnom = nom;\r\n*phld = hld;\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_do_clkgen_single(struct img_spdif_in *spdif,\r\nunsigned int rate)\r\n{\r\nunsigned int nom, hld;\r\nunsigned long flags, clk_rate;\r\nint ret = 0;\r\nu32 reg;\r\nret = img_spdif_in_check_max_rate(spdif, rate, &clk_rate);\r\nif (ret)\r\nreturn ret;\r\nret = img_spdif_in_do_clkgen_calc(rate, &nom, &hld, clk_rate);\r\nif (ret)\r\nreturn ret;\r\nreg = (nom << IMG_SPDIF_IN_CLKGEN_NOM_SHIFT) &\r\nIMG_SPDIF_IN_CLKGEN_NOM_MASK;\r\nreg |= (hld << IMG_SPDIF_IN_CLKGEN_HLD_SHIFT) &\r\nIMG_SPDIF_IN_CLKGEN_HLD_MASK;\r\nspin_lock_irqsave(&spdif->lock, flags);\r\nif (spdif->active) {\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn -EBUSY;\r\n}\r\nimg_spdif_in_writel(spdif, reg, IMG_SPDIF_IN_CLKGEN);\r\nspdif->single_freq = rate;\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_do_clkgen_multi(struct img_spdif_in *spdif,\r\nunsigned int multi_freqs[])\r\n{\r\nunsigned int nom, hld, rate, max_rate = 0;\r\nunsigned long flags, clk_rate;\r\nint i, ret = 0;\r\nu32 reg, trk_reg, temp_regs[IMG_SPDIF_IN_NUM_ACLKGEN];\r\nfor (i = 0; i < IMG_SPDIF_IN_NUM_ACLKGEN; i++)\r\nif (multi_freqs[i] > max_rate)\r\nmax_rate = multi_freqs[i];\r\nret = img_spdif_in_check_max_rate(spdif, max_rate, &clk_rate);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < IMG_SPDIF_IN_NUM_ACLKGEN; i++) {\r\nrate = multi_freqs[i];\r\nret = img_spdif_in_do_clkgen_calc(rate, &nom, &hld, clk_rate);\r\nif (ret)\r\nreturn ret;\r\nreg = (nom << IMG_SPDIF_IN_ACLKGEN_NOM_SHIFT) &\r\nIMG_SPDIF_IN_ACLKGEN_NOM_MASK;\r\nreg |= (hld << IMG_SPDIF_IN_ACLKGEN_HLD_SHIFT) &\r\nIMG_SPDIF_IN_ACLKGEN_HLD_MASK;\r\ntemp_regs[i] = reg;\r\n}\r\nspin_lock_irqsave(&spdif->lock, flags);\r\nif (spdif->active) {\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn -EBUSY;\r\n}\r\ntrk_reg = spdif->trk << IMG_SPDIF_IN_ACLKGEN_TRK_SHIFT;\r\nfor (i = 0; i < IMG_SPDIF_IN_NUM_ACLKGEN; i++) {\r\nspdif->aclkgen_regs[i] = temp_regs[i] | trk_reg;\r\nimg_spdif_in_aclkgen_writel(spdif, i);\r\n}\r\nspdif->multi_freq = true;\r\nspdif->multi_freqs[0] = multi_freqs[0];\r\nspdif->multi_freqs[1] = multi_freqs[1];\r\nspdif->multi_freqs[2] = multi_freqs[2];\r\nspdif->multi_freqs[3] = multi_freqs[3];\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_iec958_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_IEC958;\r\nuinfo->count = 1;\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_get_status_mask(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nucontrol->value.iec958.status[0] = 0xff;\r\nucontrol->value.iec958.status[1] = 0xff;\r\nucontrol->value.iec958.status[2] = 0xff;\r\nucontrol->value.iec958.status[3] = 0xff;\r\nucontrol->value.iec958.status[4] = 0xff;\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_get_status(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_dai *cpu_dai = snd_kcontrol_chip(kcontrol);\r\nstruct img_spdif_in *spdif = snd_soc_dai_get_drvdata(cpu_dai);\r\nu32 reg;\r\nreg = img_spdif_in_readl(spdif, IMG_SPDIF_IN_CSL);\r\nucontrol->value.iec958.status[0] = reg & 0xff;\r\nucontrol->value.iec958.status[1] = (reg >> 8) & 0xff;\r\nucontrol->value.iec958.status[2] = (reg >> 16) & 0xff;\r\nucontrol->value.iec958.status[3] = (reg >> 24) & 0xff;\r\nreg = img_spdif_in_readl(spdif, IMG_SPDIF_IN_CSH);\r\nucontrol->value.iec958.status[4] = (reg & IMG_SPDIF_IN_CSH_MASK)\r\n>> IMG_SPDIF_IN_CSH_SHIFT;\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_info_multi_freq(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = IMG_SPDIF_IN_NUM_ACLKGEN;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = LONG_MAX;\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_get_multi_freq(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_dai *cpu_dai = snd_kcontrol_chip(kcontrol);\r\nstruct img_spdif_in *spdif = snd_soc_dai_get_drvdata(cpu_dai);\r\nunsigned long flags;\r\nspin_lock_irqsave(&spdif->lock, flags);\r\nif (spdif->multi_freq) {\r\nucontrol->value.integer.value[0] = spdif->multi_freqs[0];\r\nucontrol->value.integer.value[1] = spdif->multi_freqs[1];\r\nucontrol->value.integer.value[2] = spdif->multi_freqs[2];\r\nucontrol->value.integer.value[3] = spdif->multi_freqs[3];\r\n} else {\r\nucontrol->value.integer.value[0] = 0;\r\nucontrol->value.integer.value[1] = 0;\r\nucontrol->value.integer.value[2] = 0;\r\nucontrol->value.integer.value[3] = 0;\r\n}\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_set_multi_freq(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_dai *cpu_dai = snd_kcontrol_chip(kcontrol);\r\nstruct img_spdif_in *spdif = snd_soc_dai_get_drvdata(cpu_dai);\r\nunsigned int multi_freqs[IMG_SPDIF_IN_NUM_ACLKGEN];\r\nbool multi_freq;\r\nunsigned long flags;\r\nif ((ucontrol->value.integer.value[0] == 0) &&\r\n(ucontrol->value.integer.value[1] == 0) &&\r\n(ucontrol->value.integer.value[2] == 0) &&\r\n(ucontrol->value.integer.value[3] == 0)) {\r\nmulti_freq = false;\r\n} else {\r\nmulti_freqs[0] = ucontrol->value.integer.value[0];\r\nmulti_freqs[1] = ucontrol->value.integer.value[1];\r\nmulti_freqs[2] = ucontrol->value.integer.value[2];\r\nmulti_freqs[3] = ucontrol->value.integer.value[3];\r\nmulti_freq = true;\r\n}\r\nif (multi_freq)\r\nreturn img_spdif_in_do_clkgen_multi(spdif, multi_freqs);\r\nspin_lock_irqsave(&spdif->lock, flags);\r\nif (spdif->active) {\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn -EBUSY;\r\n}\r\nspdif->multi_freq = false;\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_info_lock_freq(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 1;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = LONG_MAX;\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_get_lock_freq(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *uc)\r\n{\r\nstruct snd_soc_dai *cpu_dai = snd_kcontrol_chip(kcontrol);\r\nstruct img_spdif_in *spdif = snd_soc_dai_get_drvdata(cpu_dai);\r\nu32 reg;\r\nint i;\r\nunsigned long flags;\r\nspin_lock_irqsave(&spdif->lock, flags);\r\nreg = img_spdif_in_readl(spdif, IMG_SPDIF_IN_STATUS);\r\nif (reg & IMG_SPDIF_IN_STATUS_LOCK_MASK) {\r\nif (spdif->multi_freq) {\r\ni = ((reg & IMG_SPDIF_IN_STATUS_SAM_MASK) >>\r\nIMG_SPDIF_IN_STATUS_SAM_SHIFT) - 1;\r\nuc->value.integer.value[0] = spdif->multi_freqs[i];\r\n} else {\r\nuc->value.integer.value[0] = spdif->single_freq;\r\n}\r\n} else {\r\nuc->value.integer.value[0] = 0;\r\n}\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_info_trk(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 1;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 255;\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_get_trk(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_dai *cpu_dai = snd_kcontrol_chip(kcontrol);\r\nstruct img_spdif_in *spdif = snd_soc_dai_get_drvdata(cpu_dai);\r\nucontrol->value.integer.value[0] = spdif->trk;\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_set_trk(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_dai *cpu_dai = snd_kcontrol_chip(kcontrol);\r\nstruct img_spdif_in *spdif = snd_soc_dai_get_drvdata(cpu_dai);\r\nunsigned long flags;\r\nint i;\r\nu32 reg;\r\nspin_lock_irqsave(&spdif->lock, flags);\r\nif (spdif->active) {\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn -EBUSY;\r\n}\r\nspdif->trk = ucontrol->value.integer.value[0];\r\nreg = img_spdif_in_readl(spdif, IMG_SPDIF_IN_CTL);\r\nreg &= ~IMG_SPDIF_IN_CTL_TRK_MASK;\r\nreg |= spdif->trk << IMG_SPDIF_IN_CTL_TRK_SHIFT;\r\nimg_spdif_in_writel(spdif, reg, IMG_SPDIF_IN_CTL);\r\nfor (i = 0; i < IMG_SPDIF_IN_NUM_ACLKGEN; i++) {\r\nspdif->aclkgen_regs[i] = (spdif->aclkgen_regs[i] &\r\n~IMG_SPDIF_IN_ACLKGEN_TRK_MASK) |\r\n(spdif->trk << IMG_SPDIF_IN_ACLKGEN_TRK_SHIFT);\r\nimg_spdif_in_aclkgen_writel(spdif, i);\r\n}\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_info_lock(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 1;\r\nuinfo->value.integer.min = -128;\r\nuinfo->value.integer.max = 127;\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_get_lock_acquire(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_dai *cpu_dai = snd_kcontrol_chip(kcontrol);\r\nstruct img_spdif_in *spdif = snd_soc_dai_get_drvdata(cpu_dai);\r\nucontrol->value.integer.value[0] = spdif->lock_acquire;\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_set_lock_acquire(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_dai *cpu_dai = snd_kcontrol_chip(kcontrol);\r\nstruct img_spdif_in *spdif = snd_soc_dai_get_drvdata(cpu_dai);\r\nunsigned long flags;\r\nu32 reg;\r\nspin_lock_irqsave(&spdif->lock, flags);\r\nif (spdif->active) {\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn -EBUSY;\r\n}\r\nspdif->lock_acquire = ucontrol->value.integer.value[0];\r\nreg = img_spdif_in_readl(spdif, IMG_SPDIF_IN_CTL);\r\nreg &= ~IMG_SPDIF_IN_CTL_LOCKHI_MASK;\r\nreg |= (spdif->lock_acquire << IMG_SPDIF_IN_CTL_LOCKHI_SHIFT) &\r\nIMG_SPDIF_IN_CTL_LOCKHI_MASK;\r\nimg_spdif_in_writel(spdif, reg, IMG_SPDIF_IN_CTL);\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_get_lock_release(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_dai *cpu_dai = snd_kcontrol_chip(kcontrol);\r\nstruct img_spdif_in *spdif = snd_soc_dai_get_drvdata(cpu_dai);\r\nucontrol->value.integer.value[0] = spdif->lock_release;\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_set_lock_release(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_dai *cpu_dai = snd_kcontrol_chip(kcontrol);\r\nstruct img_spdif_in *spdif = snd_soc_dai_get_drvdata(cpu_dai);\r\nunsigned long flags;\r\nu32 reg;\r\nspin_lock_irqsave(&spdif->lock, flags);\r\nif (spdif->active) {\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn -EBUSY;\r\n}\r\nspdif->lock_release = ucontrol->value.integer.value[0];\r\nreg = img_spdif_in_readl(spdif, IMG_SPDIF_IN_CTL);\r\nreg &= ~IMG_SPDIF_IN_CTL_LOCKLO_MASK;\r\nreg |= (spdif->lock_release << IMG_SPDIF_IN_CTL_LOCKLO_SHIFT) &\r\nIMG_SPDIF_IN_CTL_LOCKLO_MASK;\r\nimg_spdif_in_writel(spdif, reg, IMG_SPDIF_IN_CTL);\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nunsigned long flags;\r\nstruct img_spdif_in *spdif = snd_soc_dai_get_drvdata(dai);\r\nint ret = 0;\r\nu32 reg;\r\nspin_lock_irqsave(&spdif->lock, flags);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nreg = img_spdif_in_readl(spdif, IMG_SPDIF_IN_CTL);\r\nif (spdif->multi_freq)\r\nreg &= ~IMG_SPDIF_IN_CTL_SRD_MASK;\r\nelse\r\nreg |= (1UL << IMG_SPDIF_IN_CTL_SRD_SHIFT);\r\nreg |= IMG_SPDIF_IN_CTL_SRT_MASK;\r\nimg_spdif_in_writel(spdif, reg, IMG_SPDIF_IN_CTL);\r\nspdif->active = true;\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nreg = img_spdif_in_readl(spdif, IMG_SPDIF_IN_CTL);\r\nreg &= ~IMG_SPDIF_IN_CTL_SRT_MASK;\r\nimg_spdif_in_writel(spdif, reg, IMG_SPDIF_IN_CTL);\r\nspdif->active = false;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nspin_unlock_irqrestore(&spdif->lock, flags);\r\nreturn ret;\r\n}\r\nstatic int img_spdif_in_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\r\n{\r\nstruct img_spdif_in *spdif = snd_soc_dai_get_drvdata(dai);\r\nunsigned int rate, channels;\r\nsnd_pcm_format_t format;\r\nrate = params_rate(params);\r\nchannels = params_channels(params);\r\nformat = params_format(params);\r\nif (format != SNDRV_PCM_FORMAT_S32_LE)\r\nreturn -EINVAL;\r\nif (channels != 2)\r\nreturn -EINVAL;\r\nreturn img_spdif_in_do_clkgen_single(spdif, rate);\r\n}\r\nstatic int img_spdif_in_dai_probe(struct snd_soc_dai *dai)\r\n{\r\nstruct img_spdif_in *spdif = snd_soc_dai_get_drvdata(dai);\r\nsnd_soc_dai_init_dma_data(dai, NULL, &spdif->dma_data);\r\nsnd_soc_add_dai_controls(dai, img_spdif_in_controls,\r\nARRAY_SIZE(img_spdif_in_controls));\r\nreturn 0;\r\n}\r\nstatic int img_spdif_in_probe(struct platform_device *pdev)\r\n{\r\nstruct img_spdif_in *spdif;\r\nstruct resource *res;\r\nvoid __iomem *base;\r\nint ret;\r\nstruct reset_control *rst;\r\nu32 reg;\r\nstruct device *dev = &pdev->dev;\r\nspdif = devm_kzalloc(&pdev->dev, sizeof(*spdif), GFP_KERNEL);\r\nif (!spdif)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, spdif);\r\nspdif->dev = &pdev->dev;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\nspdif->base = base;\r\nspdif->clk_sys = devm_clk_get(dev, "sys");\r\nif (IS_ERR(spdif->clk_sys)) {\r\nif (PTR_ERR(spdif->clk_sys) != -EPROBE_DEFER)\r\ndev_err(dev, "Failed to acquire clock 'sys'\n");\r\nreturn PTR_ERR(spdif->clk_sys);\r\n}\r\nret = clk_prepare_enable(spdif->clk_sys);\r\nif (ret)\r\nreturn ret;\r\nrst = devm_reset_control_get(&pdev->dev, "rst");\r\nif (IS_ERR(rst)) {\r\nif (PTR_ERR(rst) == -EPROBE_DEFER) {\r\nret = -EPROBE_DEFER;\r\ngoto err_clk_disable;\r\n}\r\ndev_dbg(dev, "No top level reset found\n");\r\nimg_spdif_in_writel(spdif, IMG_SPDIF_IN_SOFT_RESET_MASK,\r\nIMG_SPDIF_IN_SOFT_RESET);\r\nimg_spdif_in_writel(spdif, 0, IMG_SPDIF_IN_SOFT_RESET);\r\n} else {\r\nreset_control_assert(rst);\r\nreset_control_deassert(rst);\r\n}\r\nspin_lock_init(&spdif->lock);\r\nspdif->dma_data.addr = res->start + IMG_SPDIF_IN_RX_FIFO_OFFSET;\r\nspdif->dma_data.addr_width = 4;\r\nspdif->dma_data.maxburst = 4;\r\nspdif->trk = 0x80;\r\nspdif->lock_acquire = 4;\r\nspdif->lock_release = -128;\r\nreg = (spdif->lock_acquire << IMG_SPDIF_IN_CTL_LOCKHI_SHIFT) &\r\nIMG_SPDIF_IN_CTL_LOCKHI_MASK;\r\nreg |= (spdif->lock_release << IMG_SPDIF_IN_CTL_LOCKLO_SHIFT) &\r\nIMG_SPDIF_IN_CTL_LOCKLO_MASK;\r\nreg |= (spdif->trk << IMG_SPDIF_IN_CTL_TRK_SHIFT) &\r\nIMG_SPDIF_IN_CTL_TRK_MASK;\r\nimg_spdif_in_writel(spdif, reg, IMG_SPDIF_IN_CTL);\r\nret = devm_snd_soc_register_component(&pdev->dev,\r\n&img_spdif_in_component, &img_spdif_in_dai, 1);\r\nif (ret)\r\ngoto err_clk_disable;\r\nret = devm_snd_dmaengine_pcm_register(&pdev->dev, NULL, 0);\r\nif (ret)\r\ngoto err_clk_disable;\r\nreturn 0;\r\nerr_clk_disable:\r\nclk_disable_unprepare(spdif->clk_sys);\r\nreturn ret;\r\n}\r\nstatic int img_spdif_in_dev_remove(struct platform_device *pdev)\r\n{\r\nstruct img_spdif_in *spdif = platform_get_drvdata(pdev);\r\nclk_disable_unprepare(spdif->clk_sys);\r\nreturn 0;\r\n}

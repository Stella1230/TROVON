void iwl_mvm_tof_init(struct iwl_mvm *mvm)\r\n{\r\nstruct iwl_mvm_tof_data *tof_data = &mvm->tof_data;\r\nif (!fw_has_capa(&mvm->fw->ucode_capa, IWL_UCODE_TLV_CAPA_TOF_SUPPORT))\r\nreturn;\r\nmemset(tof_data, 0, sizeof(*tof_data));\r\ntof_data->tof_cfg.sub_grp_cmd_id = cpu_to_le32(TOF_CONFIG_CMD);\r\n#ifdef CONFIG_IWLWIFI_DEBUGFS\r\nif (IWL_MVM_TOF_IS_RESPONDER) {\r\ntof_data->responder_cfg.sub_grp_cmd_id =\r\ncpu_to_le32(TOF_RESPONDER_CONFIG_CMD);\r\ntof_data->responder_cfg.sta_id = IWL_MVM_STATION_COUNT;\r\n}\r\n#endif\r\ntof_data->range_req.sub_grp_cmd_id = cpu_to_le32(TOF_RANGE_REQ_CMD);\r\ntof_data->range_req.req_timeout = 1;\r\ntof_data->range_req.initiator = 1;\r\ntof_data->range_req.report_policy = 3;\r\ntof_data->range_req_ext.sub_grp_cmd_id =\r\ncpu_to_le32(TOF_RANGE_REQ_EXT_CMD);\r\nmvm->tof_data.active_range_request = IWL_MVM_TOF_RANGE_REQ_MAX_ID;\r\n}\r\nvoid iwl_mvm_tof_clean(struct iwl_mvm *mvm)\r\n{\r\nstruct iwl_mvm_tof_data *tof_data = &mvm->tof_data;\r\nif (!fw_has_capa(&mvm->fw->ucode_capa, IWL_UCODE_TLV_CAPA_TOF_SUPPORT))\r\nreturn;\r\nmemset(tof_data, 0, sizeof(*tof_data));\r\nmvm->tof_data.active_range_request = IWL_MVM_TOF_RANGE_REQ_MAX_ID;\r\n}\r\nstatic void iwl_tof_iterator(void *_data, u8 *mac,\r\nstruct ieee80211_vif *vif)\r\n{\r\nbool *enabled = _data;\r\nif (ieee80211_vif_type_p2p(vif) != NL80211_IFTYPE_STATION)\r\n*enabled = false;\r\n}\r\nint iwl_mvm_tof_config_cmd(struct iwl_mvm *mvm)\r\n{\r\nstruct iwl_tof_config_cmd *cmd = &mvm->tof_data.tof_cfg;\r\nbool enabled;\r\nlockdep_assert_held(&mvm->mutex);\r\nif (!fw_has_capa(&mvm->fw->ucode_capa, IWL_UCODE_TLV_CAPA_TOF_SUPPORT))\r\nreturn -EINVAL;\r\nieee80211_iterate_active_interfaces_atomic(mvm->hw,\r\nIEEE80211_IFACE_ITER_NORMAL,\r\niwl_tof_iterator, &enabled);\r\nif (!enabled) {\r\nIWL_DEBUG_INFO(mvm, "ToF is not supported (non bss vif)\n");\r\nreturn -EINVAL;\r\n}\r\nmvm->tof_data.active_range_request = IWL_MVM_TOF_RANGE_REQ_MAX_ID;\r\nreturn iwl_mvm_send_cmd_pdu(mvm, iwl_cmd_id(TOF_CMD,\r\nIWL_ALWAYS_LONG_GROUP, 0),\r\n0, sizeof(*cmd), cmd);\r\n}\r\nint iwl_mvm_tof_range_abort_cmd(struct iwl_mvm *mvm, u8 id)\r\n{\r\nstruct iwl_tof_range_abort_cmd cmd = {\r\n.sub_grp_cmd_id = cpu_to_le32(TOF_RANGE_ABORT_CMD),\r\n.request_id = id,\r\n};\r\nlockdep_assert_held(&mvm->mutex);\r\nif (!fw_has_capa(&mvm->fw->ucode_capa, IWL_UCODE_TLV_CAPA_TOF_SUPPORT))\r\nreturn -EINVAL;\r\nif (id != mvm->tof_data.active_range_request) {\r\nIWL_ERR(mvm, "Invalid range request id %d (active %d)\n",\r\nid, mvm->tof_data.active_range_request);\r\nreturn -EINVAL;\r\n}\r\nmvm->tof_data.active_range_request = IWL_MVM_TOF_RANGE_REQ_MAX_ID;\r\nreturn iwl_mvm_send_cmd_pdu(mvm, iwl_cmd_id(TOF_CMD,\r\nIWL_ALWAYS_LONG_GROUP, 0),\r\n0, sizeof(cmd), &cmd);\r\n}\r\nint iwl_mvm_tof_responder_cmd(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif)\r\n{\r\nstruct iwl_tof_responder_config_cmd *cmd = &mvm->tof_data.responder_cfg;\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nlockdep_assert_held(&mvm->mutex);\r\nif (!fw_has_capa(&mvm->fw->ucode_capa, IWL_UCODE_TLV_CAPA_TOF_SUPPORT))\r\nreturn -EINVAL;\r\nif (vif->p2p || vif->type != NL80211_IFTYPE_AP ||\r\n!mvmvif->ap_ibss_active) {\r\nIWL_ERR(mvm, "Cannot start responder, not in AP mode\n");\r\nreturn -EIO;\r\n}\r\ncmd->sta_id = mvmvif->bcast_sta.sta_id;\r\nmemcpy(cmd->bssid, vif->addr, ETH_ALEN);\r\nreturn iwl_mvm_send_cmd_pdu(mvm, iwl_cmd_id(TOF_CMD,\r\nIWL_ALWAYS_LONG_GROUP, 0),\r\n0, sizeof(*cmd), cmd);\r\n}\r\nint iwl_mvm_tof_range_request_cmd(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif)\r\n{\r\nstruct iwl_host_cmd cmd = {\r\n.id = iwl_cmd_id(TOF_CMD, IWL_ALWAYS_LONG_GROUP, 0),\r\n.len = { sizeof(mvm->tof_data.range_req), },\r\n.dataflags = { IWL_HCMD_DFL_NOCOPY, },\r\n};\r\nlockdep_assert_held(&mvm->mutex);\r\nif (!fw_has_capa(&mvm->fw->ucode_capa, IWL_UCODE_TLV_CAPA_TOF_SUPPORT))\r\nreturn -EINVAL;\r\nif (ieee80211_vif_type_p2p(vif) != NL80211_IFTYPE_STATION) {\r\nIWL_ERR(mvm, "Cannot send range request, not STA mode\n");\r\nreturn -EIO;\r\n}\r\nif (mvm->tof_data.active_range_request !=\r\nIWL_MVM_TOF_RANGE_REQ_MAX_ID) {\r\nIWL_ERR(mvm, "Cannot send range req, already active req %d\n",\r\nmvm->tof_data.active_range_request);\r\nreturn -EIO;\r\n}\r\nmvm->tof_data.active_range_request = mvm->tof_data.range_req.request_id;\r\ncmd.data[0] = &mvm->tof_data.range_req;\r\nreturn iwl_mvm_send_cmd(mvm, &cmd);\r\n}\r\nint iwl_mvm_tof_range_request_ext_cmd(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif)\r\n{\r\nlockdep_assert_held(&mvm->mutex);\r\nif (!fw_has_capa(&mvm->fw->ucode_capa, IWL_UCODE_TLV_CAPA_TOF_SUPPORT))\r\nreturn -EINVAL;\r\nif (ieee80211_vif_type_p2p(vif) != NL80211_IFTYPE_STATION) {\r\nIWL_ERR(mvm, "Cannot send ext range req, not in STA mode\n");\r\nreturn -EIO;\r\n}\r\nreturn iwl_mvm_send_cmd_pdu(mvm, iwl_cmd_id(TOF_CMD,\r\nIWL_ALWAYS_LONG_GROUP, 0),\r\n0, sizeof(mvm->tof_data.range_req_ext),\r\n&mvm->tof_data.range_req_ext);\r\n}\r\nstatic int iwl_mvm_tof_range_resp(struct iwl_mvm *mvm, void *data)\r\n{\r\nstruct iwl_tof_range_rsp_ntfy *resp = (void *)data;\r\nif (resp->request_id != mvm->tof_data.active_range_request) {\r\nIWL_ERR(mvm, "Request id mismatch, got %d, active %d\n",\r\nresp->request_id, mvm->tof_data.active_range_request);\r\nreturn -EIO;\r\n}\r\nmemcpy(&mvm->tof_data.range_resp, resp,\r\nsizeof(struct iwl_tof_range_rsp_ntfy));\r\nmvm->tof_data.active_range_request = IWL_MVM_TOF_RANGE_REQ_MAX_ID;\r\nreturn 0;\r\n}\r\nstatic int iwl_mvm_tof_mcsi_notif(struct iwl_mvm *mvm, void *data)\r\n{\r\nstruct iwl_tof_mcsi_notif *resp = (struct iwl_tof_mcsi_notif *)data;\r\nIWL_DEBUG_INFO(mvm, "MCSI notification, token %d\n", resp->token);\r\nreturn 0;\r\n}\r\nstatic int iwl_mvm_tof_nb_report_notif(struct iwl_mvm *mvm, void *data)\r\n{\r\nstruct iwl_tof_neighbor_report *report =\r\n(struct iwl_tof_neighbor_report *)data;\r\nIWL_DEBUG_INFO(mvm, "NB report, bssid %pM, token %d, status 0x%x\n",\r\nreport->bssid, report->request_token, report->status);\r\nreturn 0;\r\n}\r\nvoid iwl_mvm_tof_resp_handler(struct iwl_mvm *mvm,\r\nstruct iwl_rx_cmd_buffer *rxb)\r\n{\r\nstruct iwl_rx_packet *pkt = rxb_addr(rxb);\r\nstruct iwl_tof_gen_resp_cmd *resp = (void *)pkt->data;\r\nlockdep_assert_held(&mvm->mutex);\r\nswitch (le32_to_cpu(resp->sub_grp_cmd_id)) {\r\ncase TOF_RANGE_RESPONSE_NOTIF:\r\niwl_mvm_tof_range_resp(mvm, resp->data);\r\nbreak;\r\ncase TOF_MCSI_DEBUG_NOTIF:\r\niwl_mvm_tof_mcsi_notif(mvm, resp->data);\r\nbreak;\r\ncase TOF_NEIGHBOR_REPORT_RSP_NOTIF:\r\niwl_mvm_tof_nb_report_notif(mvm, resp->data);\r\nbreak;\r\ndefault:\r\nIWL_ERR(mvm, "Unknown sub-group command 0x%x\n",\r\nresp->sub_grp_cmd_id);\r\nbreak;\r\n}\r\n}

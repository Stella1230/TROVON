static int\r\npalmz71_get_pendown_state(void)\r\n{\r\nreturn !gpio_get_value(PALMZ71_PENIRQ_GPIO);\r\n}\r\nstatic irqreturn_t\r\npalmz71_powercable(int irq, void *dev_id)\r\n{\r\nif (gpio_get_value(PALMZ71_USBDETECT_GPIO)) {\r\nprintk(KERN_INFO "PM: Power cable connected\n");\r\nirq_set_irq_type(gpio_to_irq(PALMZ71_USBDETECT_GPIO),\r\nIRQ_TYPE_EDGE_FALLING);\r\n} else {\r\nprintk(KERN_INFO "PM: Power cable disconnected\n");\r\nirq_set_irq_type(gpio_to_irq(PALMZ71_USBDETECT_GPIO),\r\nIRQ_TYPE_EDGE_RISING);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __init\r\nomap_mpu_wdt_mode(int mode)\r\n{\r\nif (mode)\r\nomap_writew(0x8000, OMAP_WDT_TIMER_MODE);\r\nelse {\r\nomap_writew(0x00f5, OMAP_WDT_TIMER_MODE);\r\nomap_writew(0x00a0, OMAP_WDT_TIMER_MODE);\r\n}\r\n}\r\nstatic void __init\r\npalmz71_gpio_setup(int early)\r\n{\r\nif (early) {\r\ngpio_direction_output(1, 1);\r\n} else {\r\nif (gpio_request(PALMZ71_MMC_WP_GPIO, "MMC WP") < 0) {\r\nprintk(KERN_ERR "Could not reserve WP GPIO!\n");\r\nreturn;\r\n}\r\ngpio_direction_input(PALMZ71_MMC_WP_GPIO);\r\nif (gpio_request(PALMZ71_USBDETECT_GPIO, "USB detect") < 0) {\r\nprintk(KERN_ERR\r\n"Could not reserve cable signal GPIO!\n");\r\nreturn;\r\n}\r\ngpio_direction_input(PALMZ71_USBDETECT_GPIO);\r\nif (request_irq(gpio_to_irq(PALMZ71_USBDETECT_GPIO),\r\npalmz71_powercable, 0, "palmz71-cable", NULL))\r\nprintk(KERN_ERR\r\n"IRQ request for power cable failed!\n");\r\npalmz71_powercable(gpio_to_irq(PALMZ71_USBDETECT_GPIO), NULL);\r\n}\r\n}\r\nstatic void __init\r\nomap_palmz71_init(void)\r\n{\r\nomap_cfg_reg(UART1_TX);\r\nomap_cfg_reg(UART1_RTS);\r\nomap_cfg_reg(UART2_TX);\r\nomap_cfg_reg(UART2_RTS);\r\nomap_cfg_reg(UART3_TX);\r\nomap_cfg_reg(UART3_RX);\r\npalmz71_gpio_setup(1);\r\nomap_mpu_wdt_mode(0);\r\nplatform_add_devices(devices, ARRAY_SIZE(devices));\r\npalmz71_boardinfo[0].irq = gpio_to_irq(PALMZ71_PENIRQ_GPIO);\r\nspi_register_board_info(palmz71_boardinfo,\r\nARRAY_SIZE(palmz71_boardinfo));\r\nomap1_usb_init(&palmz71_usb_config);\r\nomap_serial_init();\r\nomap_register_i2c_bus(1, 100, NULL, 0);\r\npalmz71_gpio_setup(0);\r\nomapfb_set_lcd_config(&palmz71_lcd_config);\r\n}

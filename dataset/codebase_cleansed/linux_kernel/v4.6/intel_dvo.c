static struct intel_dvo *enc_to_dvo(struct intel_encoder *encoder)\r\n{\r\nreturn container_of(encoder, struct intel_dvo, base);\r\n}\r\nstatic struct intel_dvo *intel_attached_dvo(struct drm_connector *connector)\r\n{\r\nreturn enc_to_dvo(intel_attached_encoder(connector));\r\n}\r\nstatic bool intel_dvo_connector_get_hw_state(struct intel_connector *connector)\r\n{\r\nstruct drm_device *dev = connector->base.dev;\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nstruct intel_dvo *intel_dvo = intel_attached_dvo(&connector->base);\r\nu32 tmp;\r\ntmp = I915_READ(intel_dvo->dev.dvo_reg);\r\nif (!(tmp & DVO_ENABLE))\r\nreturn false;\r\nreturn intel_dvo->dev.dev_ops->get_hw_state(&intel_dvo->dev);\r\n}\r\nstatic bool intel_dvo_get_hw_state(struct intel_encoder *encoder,\r\nenum pipe *pipe)\r\n{\r\nstruct drm_device *dev = encoder->base.dev;\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nstruct intel_dvo *intel_dvo = enc_to_dvo(encoder);\r\nu32 tmp;\r\ntmp = I915_READ(intel_dvo->dev.dvo_reg);\r\nif (!(tmp & DVO_ENABLE))\r\nreturn false;\r\n*pipe = PORT_TO_PIPE(tmp);\r\nreturn true;\r\n}\r\nstatic void intel_dvo_get_config(struct intel_encoder *encoder,\r\nstruct intel_crtc_state *pipe_config)\r\n{\r\nstruct drm_i915_private *dev_priv = encoder->base.dev->dev_private;\r\nstruct intel_dvo *intel_dvo = enc_to_dvo(encoder);\r\nu32 tmp, flags = 0;\r\ntmp = I915_READ(intel_dvo->dev.dvo_reg);\r\nif (tmp & DVO_HSYNC_ACTIVE_HIGH)\r\nflags |= DRM_MODE_FLAG_PHSYNC;\r\nelse\r\nflags |= DRM_MODE_FLAG_NHSYNC;\r\nif (tmp & DVO_VSYNC_ACTIVE_HIGH)\r\nflags |= DRM_MODE_FLAG_PVSYNC;\r\nelse\r\nflags |= DRM_MODE_FLAG_NVSYNC;\r\npipe_config->base.adjusted_mode.flags |= flags;\r\npipe_config->base.adjusted_mode.crtc_clock = pipe_config->port_clock;\r\n}\r\nstatic void intel_disable_dvo(struct intel_encoder *encoder)\r\n{\r\nstruct drm_i915_private *dev_priv = encoder->base.dev->dev_private;\r\nstruct intel_dvo *intel_dvo = enc_to_dvo(encoder);\r\ni915_reg_t dvo_reg = intel_dvo->dev.dvo_reg;\r\nu32 temp = I915_READ(dvo_reg);\r\nintel_dvo->dev.dev_ops->dpms(&intel_dvo->dev, false);\r\nI915_WRITE(dvo_reg, temp & ~DVO_ENABLE);\r\nI915_READ(dvo_reg);\r\n}\r\nstatic void intel_enable_dvo(struct intel_encoder *encoder)\r\n{\r\nstruct drm_i915_private *dev_priv = encoder->base.dev->dev_private;\r\nstruct intel_dvo *intel_dvo = enc_to_dvo(encoder);\r\nstruct intel_crtc *crtc = to_intel_crtc(encoder->base.crtc);\r\ni915_reg_t dvo_reg = intel_dvo->dev.dvo_reg;\r\nu32 temp = I915_READ(dvo_reg);\r\nintel_dvo->dev.dev_ops->mode_set(&intel_dvo->dev,\r\n&crtc->config->base.mode,\r\n&crtc->config->base.adjusted_mode);\r\nI915_WRITE(dvo_reg, temp | DVO_ENABLE);\r\nI915_READ(dvo_reg);\r\nintel_dvo->dev.dev_ops->dpms(&intel_dvo->dev, true);\r\n}\r\nstatic enum drm_mode_status\r\nintel_dvo_mode_valid(struct drm_connector *connector,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct intel_dvo *intel_dvo = intel_attached_dvo(connector);\r\nconst struct drm_display_mode *fixed_mode =\r\nto_intel_connector(connector)->panel.fixed_mode;\r\nint max_dotclk = to_i915(connector->dev)->max_dotclk_freq;\r\nint target_clock = mode->clock;\r\nif (mode->flags & DRM_MODE_FLAG_DBLSCAN)\r\nreturn MODE_NO_DBLESCAN;\r\nif (fixed_mode) {\r\nif (mode->hdisplay > fixed_mode->hdisplay)\r\nreturn MODE_PANEL;\r\nif (mode->vdisplay > fixed_mode->vdisplay)\r\nreturn MODE_PANEL;\r\ntarget_clock = fixed_mode->clock;\r\n}\r\nif (target_clock > max_dotclk)\r\nreturn MODE_CLOCK_HIGH;\r\nreturn intel_dvo->dev.dev_ops->mode_valid(&intel_dvo->dev, mode);\r\n}\r\nstatic bool intel_dvo_compute_config(struct intel_encoder *encoder,\r\nstruct intel_crtc_state *pipe_config)\r\n{\r\nstruct intel_dvo *intel_dvo = enc_to_dvo(encoder);\r\nconst struct drm_display_mode *fixed_mode =\r\nintel_dvo->attached_connector->panel.fixed_mode;\r\nstruct drm_display_mode *adjusted_mode = &pipe_config->base.adjusted_mode;\r\nif (fixed_mode)\r\nintel_fixed_panel_mode(fixed_mode, adjusted_mode);\r\nreturn true;\r\n}\r\nstatic void intel_dvo_pre_enable(struct intel_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->base.dev;\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nstruct intel_crtc *crtc = to_intel_crtc(encoder->base.crtc);\r\nconst struct drm_display_mode *adjusted_mode = &crtc->config->base.adjusted_mode;\r\nstruct intel_dvo *intel_dvo = enc_to_dvo(encoder);\r\nint pipe = crtc->pipe;\r\nu32 dvo_val;\r\ni915_reg_t dvo_reg = intel_dvo->dev.dvo_reg;\r\ni915_reg_t dvo_srcdim_reg = intel_dvo->dev.dvo_srcdim_reg;\r\ndvo_val = I915_READ(dvo_reg) &\r\n(DVO_PRESERVE_MASK | DVO_DATA_ORDER_GBRG);\r\ndvo_val |= DVO_DATA_ORDER_FP | DVO_BORDER_ENABLE |\r\nDVO_BLANK_ACTIVE_HIGH;\r\nif (pipe == 1)\r\ndvo_val |= DVO_PIPE_B_SELECT;\r\ndvo_val |= DVO_PIPE_STALL;\r\nif (adjusted_mode->flags & DRM_MODE_FLAG_PHSYNC)\r\ndvo_val |= DVO_HSYNC_ACTIVE_HIGH;\r\nif (adjusted_mode->flags & DRM_MODE_FLAG_PVSYNC)\r\ndvo_val |= DVO_VSYNC_ACTIVE_HIGH;\r\nI915_WRITE(dvo_srcdim_reg,\r\n(adjusted_mode->crtc_hdisplay << DVO_SRCDIM_HORIZONTAL_SHIFT) |\r\n(adjusted_mode->crtc_vdisplay << DVO_SRCDIM_VERTICAL_SHIFT));\r\nI915_WRITE(dvo_reg, dvo_val);\r\n}\r\nstatic enum drm_connector_status\r\nintel_dvo_detect(struct drm_connector *connector, bool force)\r\n{\r\nstruct intel_dvo *intel_dvo = intel_attached_dvo(connector);\r\nDRM_DEBUG_KMS("[CONNECTOR:%d:%s]\n",\r\nconnector->base.id, connector->name);\r\nreturn intel_dvo->dev.dev_ops->detect(&intel_dvo->dev);\r\n}\r\nstatic int intel_dvo_get_modes(struct drm_connector *connector)\r\n{\r\nstruct drm_i915_private *dev_priv = connector->dev->dev_private;\r\nconst struct drm_display_mode *fixed_mode =\r\nto_intel_connector(connector)->panel.fixed_mode;\r\nintel_ddc_get_modes(connector,\r\nintel_gmbus_get_adapter(dev_priv, GMBUS_PIN_DPC));\r\nif (!list_empty(&connector->probed_modes))\r\nreturn 1;\r\nif (fixed_mode) {\r\nstruct drm_display_mode *mode;\r\nmode = drm_mode_duplicate(connector->dev, fixed_mode);\r\nif (mode) {\r\ndrm_mode_probed_add(connector, mode);\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void intel_dvo_destroy(struct drm_connector *connector)\r\n{\r\ndrm_connector_cleanup(connector);\r\nintel_panel_fini(&to_intel_connector(connector)->panel);\r\nkfree(connector);\r\n}\r\nstatic void intel_dvo_enc_destroy(struct drm_encoder *encoder)\r\n{\r\nstruct intel_dvo *intel_dvo = enc_to_dvo(to_intel_encoder(encoder));\r\nif (intel_dvo->dev.dev_ops->destroy)\r\nintel_dvo->dev.dev_ops->destroy(&intel_dvo->dev);\r\nintel_encoder_destroy(encoder);\r\n}\r\nstatic struct drm_display_mode *\r\nintel_dvo_get_current_mode(struct drm_connector *connector)\r\n{\r\nstruct drm_device *dev = connector->dev;\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nstruct intel_dvo *intel_dvo = intel_attached_dvo(connector);\r\nuint32_t dvo_val = I915_READ(intel_dvo->dev.dvo_reg);\r\nstruct drm_display_mode *mode = NULL;\r\nif (dvo_val & DVO_ENABLE) {\r\nstruct drm_crtc *crtc;\r\nint pipe = (dvo_val & DVO_PIPE_B_SELECT) ? 1 : 0;\r\ncrtc = intel_get_crtc_for_pipe(dev, pipe);\r\nif (crtc) {\r\nmode = intel_crtc_mode_get(dev, crtc);\r\nif (mode) {\r\nmode->type |= DRM_MODE_TYPE_PREFERRED;\r\nif (dvo_val & DVO_HSYNC_ACTIVE_HIGH)\r\nmode->flags |= DRM_MODE_FLAG_PHSYNC;\r\nif (dvo_val & DVO_VSYNC_ACTIVE_HIGH)\r\nmode->flags |= DRM_MODE_FLAG_PVSYNC;\r\n}\r\n}\r\n}\r\nreturn mode;\r\n}\r\nvoid intel_dvo_init(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nstruct intel_encoder *intel_encoder;\r\nstruct intel_dvo *intel_dvo;\r\nstruct intel_connector *intel_connector;\r\nint i;\r\nint encoder_type = DRM_MODE_ENCODER_NONE;\r\nintel_dvo = kzalloc(sizeof(*intel_dvo), GFP_KERNEL);\r\nif (!intel_dvo)\r\nreturn;\r\nintel_connector = intel_connector_alloc();\r\nif (!intel_connector) {\r\nkfree(intel_dvo);\r\nreturn;\r\n}\r\nintel_dvo->attached_connector = intel_connector;\r\nintel_encoder = &intel_dvo->base;\r\ndrm_encoder_init(dev, &intel_encoder->base,\r\n&intel_dvo_enc_funcs, encoder_type, NULL);\r\nintel_encoder->disable = intel_disable_dvo;\r\nintel_encoder->enable = intel_enable_dvo;\r\nintel_encoder->get_hw_state = intel_dvo_get_hw_state;\r\nintel_encoder->get_config = intel_dvo_get_config;\r\nintel_encoder->compute_config = intel_dvo_compute_config;\r\nintel_encoder->pre_enable = intel_dvo_pre_enable;\r\nintel_connector->get_hw_state = intel_dvo_connector_get_hw_state;\r\nintel_connector->unregister = intel_connector_unregister;\r\nfor (i = 0; i < ARRAY_SIZE(intel_dvo_devices); i++) {\r\nstruct drm_connector *connector = &intel_connector->base;\r\nconst struct intel_dvo_device *dvo = &intel_dvo_devices[i];\r\nstruct i2c_adapter *i2c;\r\nint gpio;\r\nbool dvoinit;\r\nenum pipe pipe;\r\nuint32_t dpll[I915_MAX_PIPES];\r\nif (intel_gmbus_is_valid_pin(dev_priv, dvo->gpio))\r\ngpio = dvo->gpio;\r\nelse if (dvo->type == INTEL_DVO_CHIP_LVDS)\r\ngpio = GMBUS_PIN_SSC;\r\nelse\r\ngpio = GMBUS_PIN_DPB;\r\ni2c = intel_gmbus_get_adapter(dev_priv, gpio);\r\nintel_dvo->dev = *dvo;\r\nintel_gmbus_force_bit(i2c, true);\r\nfor_each_pipe(dev_priv, pipe) {\r\ndpll[pipe] = I915_READ(DPLL(pipe));\r\nI915_WRITE(DPLL(pipe), dpll[pipe] | DPLL_DVO_2X_MODE);\r\n}\r\ndvoinit = dvo->dev_ops->init(&intel_dvo->dev, i2c);\r\nfor_each_pipe(dev_priv, pipe) {\r\nI915_WRITE(DPLL(pipe), dpll[pipe]);\r\n}\r\nintel_gmbus_force_bit(i2c, false);\r\nif (!dvoinit)\r\ncontinue;\r\nintel_encoder->type = INTEL_OUTPUT_DVO;\r\nintel_encoder->crtc_mask = (1 << 0) | (1 << 1);\r\nswitch (dvo->type) {\r\ncase INTEL_DVO_CHIP_TMDS:\r\nintel_encoder->cloneable = (1 << INTEL_OUTPUT_ANALOG) |\r\n(1 << INTEL_OUTPUT_DVO);\r\ndrm_connector_init(dev, connector,\r\n&intel_dvo_connector_funcs,\r\nDRM_MODE_CONNECTOR_DVII);\r\nencoder_type = DRM_MODE_ENCODER_TMDS;\r\nbreak;\r\ncase INTEL_DVO_CHIP_LVDS:\r\nintel_encoder->cloneable = 0;\r\ndrm_connector_init(dev, connector,\r\n&intel_dvo_connector_funcs,\r\nDRM_MODE_CONNECTOR_LVDS);\r\nencoder_type = DRM_MODE_ENCODER_LVDS;\r\nbreak;\r\n}\r\ndrm_connector_helper_add(connector,\r\n&intel_dvo_connector_helper_funcs);\r\nconnector->display_info.subpixel_order = SubPixelHorizontalRGB;\r\nconnector->interlace_allowed = false;\r\nconnector->doublescan_allowed = false;\r\nintel_connector_attach_encoder(intel_connector, intel_encoder);\r\nif (dvo->type == INTEL_DVO_CHIP_LVDS) {\r\nintel_panel_init(&intel_connector->panel,\r\nintel_dvo_get_current_mode(connector),\r\nNULL);\r\nintel_dvo->panel_wants_dither = true;\r\n}\r\ndrm_connector_register(connector);\r\nreturn;\r\n}\r\ndrm_encoder_cleanup(&intel_encoder->base);\r\nkfree(intel_dvo);\r\nkfree(intel_connector);\r\n}

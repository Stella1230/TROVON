static void irq_remapping_disable_io_apic(void)\r\n{\r\nif (cpu_has_apic || apic_from_smp_config())\r\ndisconnect_bsp_APIC(0);\r\n}\r\nstatic void __init irq_remapping_modify_x86_ops(void)\r\n{\r\nx86_io_apic_ops.disable = irq_remapping_disable_io_apic;\r\n}\r\nstatic __init int setup_nointremap(char *str)\r\n{\r\ndisable_irq_remap = 1;\r\nreturn 0;\r\n}\r\nstatic __init int setup_irqremap(char *str)\r\n{\r\nif (!str)\r\nreturn -EINVAL;\r\nwhile (*str) {\r\nif (!strncmp(str, "on", 2)) {\r\ndisable_irq_remap = 0;\r\ndisable_irq_post = 0;\r\n} else if (!strncmp(str, "off", 3)) {\r\ndisable_irq_remap = 1;\r\ndisable_irq_post = 1;\r\n} else if (!strncmp(str, "nosid", 5))\r\ndisable_sourceid_checking = 1;\r\nelse if (!strncmp(str, "no_x2apic_optout", 16))\r\nno_x2apic_optout = 1;\r\nelse if (!strncmp(str, "nopost", 6))\r\ndisable_irq_post = 1;\r\nstr += strcspn(str, ",");\r\nwhile (*str == ',')\r\nstr++;\r\n}\r\nreturn 0;\r\n}\r\nvoid set_irq_remapping_broken(void)\r\n{\r\nirq_remap_broken = 1;\r\n}\r\nbool irq_remapping_cap(enum irq_remap_cap cap)\r\n{\r\nif (!remap_ops || disable_irq_post)\r\nreturn false;\r\nreturn (remap_ops->capability & (1 << cap));\r\n}\r\nint __init irq_remapping_prepare(void)\r\n{\r\nif (disable_irq_remap)\r\nreturn -ENOSYS;\r\nif (intel_irq_remap_ops.prepare() == 0)\r\nremap_ops = &intel_irq_remap_ops;\r\nelse if (IS_ENABLED(CONFIG_AMD_IOMMU) &&\r\namd_iommu_irq_ops.prepare() == 0)\r\nremap_ops = &amd_iommu_irq_ops;\r\nelse\r\nreturn -ENOSYS;\r\nreturn 0;\r\n}\r\nint __init irq_remapping_enable(void)\r\n{\r\nint ret;\r\nif (!remap_ops->enable)\r\nreturn -ENODEV;\r\nret = remap_ops->enable();\r\nif (irq_remapping_enabled)\r\nirq_remapping_modify_x86_ops();\r\nreturn ret;\r\n}\r\nvoid irq_remapping_disable(void)\r\n{\r\nif (irq_remapping_enabled && remap_ops->disable)\r\nremap_ops->disable();\r\n}\r\nint irq_remapping_reenable(int mode)\r\n{\r\nif (irq_remapping_enabled && remap_ops->reenable)\r\nreturn remap_ops->reenable(mode);\r\nreturn 0;\r\n}\r\nint __init irq_remap_enable_fault_handling(void)\r\n{\r\nif (!irq_remapping_enabled)\r\nreturn 0;\r\nif (!remap_ops->enable_faulting)\r\nreturn -ENODEV;\r\nreturn remap_ops->enable_faulting();\r\n}\r\nvoid panic_if_irq_remap(const char *msg)\r\n{\r\nif (irq_remapping_enabled)\r\npanic(msg);\r\n}\r\nvoid ir_ack_apic_edge(struct irq_data *data)\r\n{\r\nack_APIC_irq();\r\n}\r\nstruct irq_domain *\r\nirq_remapping_get_ir_irq_domain(struct irq_alloc_info *info)\r\n{\r\nif (!remap_ops || !remap_ops->get_ir_irq_domain)\r\nreturn NULL;\r\nreturn remap_ops->get_ir_irq_domain(info);\r\n}\r\nstruct irq_domain *\r\nirq_remapping_get_irq_domain(struct irq_alloc_info *info)\r\n{\r\nif (!remap_ops || !remap_ops->get_irq_domain)\r\nreturn NULL;\r\nreturn remap_ops->get_irq_domain(info);\r\n}

bool drm_rect_intersect(struct drm_rect *r1, const struct drm_rect *r2)\r\n{\r\nr1->x1 = max(r1->x1, r2->x1);\r\nr1->y1 = max(r1->y1, r2->y1);\r\nr1->x2 = min(r1->x2, r2->x2);\r\nr1->y2 = min(r1->y2, r2->y2);\r\nreturn drm_rect_visible(r1);\r\n}\r\nbool drm_rect_clip_scaled(struct drm_rect *src, struct drm_rect *dst,\r\nconst struct drm_rect *clip,\r\nint hscale, int vscale)\r\n{\r\nint diff;\r\ndiff = clip->x1 - dst->x1;\r\nif (diff > 0) {\r\nint64_t tmp = src->x1 + (int64_t) diff * hscale;\r\nsrc->x1 = clamp_t(int64_t, tmp, INT_MIN, INT_MAX);\r\n}\r\ndiff = clip->y1 - dst->y1;\r\nif (diff > 0) {\r\nint64_t tmp = src->y1 + (int64_t) diff * vscale;\r\nsrc->y1 = clamp_t(int64_t, tmp, INT_MIN, INT_MAX);\r\n}\r\ndiff = dst->x2 - clip->x2;\r\nif (diff > 0) {\r\nint64_t tmp = src->x2 - (int64_t) diff * hscale;\r\nsrc->x2 = clamp_t(int64_t, tmp, INT_MIN, INT_MAX);\r\n}\r\ndiff = dst->y2 - clip->y2;\r\nif (diff > 0) {\r\nint64_t tmp = src->y2 - (int64_t) diff * vscale;\r\nsrc->y2 = clamp_t(int64_t, tmp, INT_MIN, INT_MAX);\r\n}\r\nreturn drm_rect_intersect(dst, clip);\r\n}\r\nstatic int drm_calc_scale(int src, int dst)\r\n{\r\nint scale = 0;\r\nif (src < 0 || dst < 0)\r\nreturn -EINVAL;\r\nif (dst == 0)\r\nreturn 0;\r\nscale = src / dst;\r\nreturn scale;\r\n}\r\nint drm_rect_calc_hscale(const struct drm_rect *src,\r\nconst struct drm_rect *dst,\r\nint min_hscale, int max_hscale)\r\n{\r\nint src_w = drm_rect_width(src);\r\nint dst_w = drm_rect_width(dst);\r\nint hscale = drm_calc_scale(src_w, dst_w);\r\nif (hscale < 0 || dst_w == 0)\r\nreturn hscale;\r\nif (hscale < min_hscale || hscale > max_hscale)\r\nreturn -ERANGE;\r\nreturn hscale;\r\n}\r\nint drm_rect_calc_vscale(const struct drm_rect *src,\r\nconst struct drm_rect *dst,\r\nint min_vscale, int max_vscale)\r\n{\r\nint src_h = drm_rect_height(src);\r\nint dst_h = drm_rect_height(dst);\r\nint vscale = drm_calc_scale(src_h, dst_h);\r\nif (vscale < 0 || dst_h == 0)\r\nreturn vscale;\r\nif (vscale < min_vscale || vscale > max_vscale)\r\nreturn -ERANGE;\r\nreturn vscale;\r\n}\r\nint drm_rect_calc_hscale_relaxed(struct drm_rect *src,\r\nstruct drm_rect *dst,\r\nint min_hscale, int max_hscale)\r\n{\r\nint src_w = drm_rect_width(src);\r\nint dst_w = drm_rect_width(dst);\r\nint hscale = drm_calc_scale(src_w, dst_w);\r\nif (hscale < 0 || dst_w == 0)\r\nreturn hscale;\r\nif (hscale < min_hscale) {\r\nint max_dst_w = src_w / min_hscale;\r\ndrm_rect_adjust_size(dst, max_dst_w - dst_w, 0);\r\nreturn min_hscale;\r\n}\r\nif (hscale > max_hscale) {\r\nint max_src_w = dst_w * max_hscale;\r\ndrm_rect_adjust_size(src, max_src_w - src_w, 0);\r\nreturn max_hscale;\r\n}\r\nreturn hscale;\r\n}\r\nint drm_rect_calc_vscale_relaxed(struct drm_rect *src,\r\nstruct drm_rect *dst,\r\nint min_vscale, int max_vscale)\r\n{\r\nint src_h = drm_rect_height(src);\r\nint dst_h = drm_rect_height(dst);\r\nint vscale = drm_calc_scale(src_h, dst_h);\r\nif (vscale < 0 || dst_h == 0)\r\nreturn vscale;\r\nif (vscale < min_vscale) {\r\nint max_dst_h = src_h / min_vscale;\r\ndrm_rect_adjust_size(dst, 0, max_dst_h - dst_h);\r\nreturn min_vscale;\r\n}\r\nif (vscale > max_vscale) {\r\nint max_src_h = dst_h * max_vscale;\r\ndrm_rect_adjust_size(src, 0, max_src_h - src_h);\r\nreturn max_vscale;\r\n}\r\nreturn vscale;\r\n}\r\nvoid drm_rect_debug_print(const char *prefix, const struct drm_rect *r, bool fixed_point)\r\n{\r\nint w = drm_rect_width(r);\r\nint h = drm_rect_height(r);\r\nif (fixed_point)\r\nDRM_DEBUG_KMS("%s%d.%06ux%d.%06u%+d.%06u%+d.%06u\n", prefix,\r\nw >> 16, ((w & 0xffff) * 15625) >> 10,\r\nh >> 16, ((h & 0xffff) * 15625) >> 10,\r\nr->x1 >> 16, ((r->x1 & 0xffff) * 15625) >> 10,\r\nr->y1 >> 16, ((r->y1 & 0xffff) * 15625) >> 10);\r\nelse\r\nDRM_DEBUG_KMS("%s%dx%d%+d%+d\n", prefix, w, h, r->x1, r->y1);\r\n}\r\nvoid drm_rect_rotate(struct drm_rect *r,\r\nint width, int height,\r\nunsigned int rotation)\r\n{\r\nstruct drm_rect tmp;\r\nif (rotation & (BIT(DRM_REFLECT_X) | BIT(DRM_REFLECT_Y))) {\r\ntmp = *r;\r\nif (rotation & BIT(DRM_REFLECT_X)) {\r\nr->x1 = width - tmp.x2;\r\nr->x2 = width - tmp.x1;\r\n}\r\nif (rotation & BIT(DRM_REFLECT_Y)) {\r\nr->y1 = height - tmp.y2;\r\nr->y2 = height - tmp.y1;\r\n}\r\n}\r\nswitch (rotation & DRM_ROTATE_MASK) {\r\ncase BIT(DRM_ROTATE_0):\r\nbreak;\r\ncase BIT(DRM_ROTATE_90):\r\ntmp = *r;\r\nr->x1 = tmp.y1;\r\nr->x2 = tmp.y2;\r\nr->y1 = width - tmp.x2;\r\nr->y2 = width - tmp.x1;\r\nbreak;\r\ncase BIT(DRM_ROTATE_180):\r\ntmp = *r;\r\nr->x1 = width - tmp.x2;\r\nr->x2 = width - tmp.x1;\r\nr->y1 = height - tmp.y2;\r\nr->y2 = height - tmp.y1;\r\nbreak;\r\ncase BIT(DRM_ROTATE_270):\r\ntmp = *r;\r\nr->x1 = height - tmp.y2;\r\nr->x2 = height - tmp.y1;\r\nr->y1 = tmp.x1;\r\nr->y2 = tmp.x2;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nvoid drm_rect_rotate_inv(struct drm_rect *r,\r\nint width, int height,\r\nunsigned int rotation)\r\n{\r\nstruct drm_rect tmp;\r\nswitch (rotation & DRM_ROTATE_MASK) {\r\ncase BIT(DRM_ROTATE_0):\r\nbreak;\r\ncase BIT(DRM_ROTATE_90):\r\ntmp = *r;\r\nr->x1 = width - tmp.y2;\r\nr->x2 = width - tmp.y1;\r\nr->y1 = tmp.x1;\r\nr->y2 = tmp.x2;\r\nbreak;\r\ncase BIT(DRM_ROTATE_180):\r\ntmp = *r;\r\nr->x1 = width - tmp.x2;\r\nr->x2 = width - tmp.x1;\r\nr->y1 = height - tmp.y2;\r\nr->y2 = height - tmp.y1;\r\nbreak;\r\ncase BIT(DRM_ROTATE_270):\r\ntmp = *r;\r\nr->x1 = tmp.y1;\r\nr->x2 = tmp.y2;\r\nr->y1 = height - tmp.x2;\r\nr->y2 = height - tmp.x1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (rotation & (BIT(DRM_REFLECT_X) | BIT(DRM_REFLECT_Y))) {\r\ntmp = *r;\r\nif (rotation & BIT(DRM_REFLECT_X)) {\r\nr->x1 = width - tmp.x2;\r\nr->x2 = width - tmp.x1;\r\n}\r\nif (rotation & BIT(DRM_REFLECT_Y)) {\r\nr->y1 = height - tmp.y2;\r\nr->y2 = height - tmp.y1;\r\n}\r\n}\r\n}

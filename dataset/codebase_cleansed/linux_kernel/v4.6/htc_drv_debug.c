static ssize_t read_file_tgt_int_stats(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nstruct ath9k_htc_target_int_stats cmd_rsp;\r\nchar buf[512];\r\nunsigned int len = 0;\r\nint ret = 0;\r\nmemset(&cmd_rsp, 0, sizeof(cmd_rsp));\r\nath9k_htc_ps_wakeup(priv);\r\nWMI_CMD(WMI_INT_STATS_CMDID);\r\nif (ret) {\r\nath9k_htc_ps_restore(priv);\r\nreturn -EINVAL;\r\n}\r\nath9k_htc_ps_restore(priv);\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "RX",\r\nbe32_to_cpu(cmd_rsp.rx));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "RXORN",\r\nbe32_to_cpu(cmd_rsp.rxorn));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "RXEOL",\r\nbe32_to_cpu(cmd_rsp.rxeol));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "TXURN",\r\nbe32_to_cpu(cmd_rsp.txurn));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "TXTO",\r\nbe32_to_cpu(cmd_rsp.txto));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "CST",\r\nbe32_to_cpu(cmd_rsp.cst));\r\nif (len > sizeof(buf))\r\nlen = sizeof(buf);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t read_file_tgt_tx_stats(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nstruct ath9k_htc_target_tx_stats cmd_rsp;\r\nchar buf[512];\r\nunsigned int len = 0;\r\nint ret = 0;\r\nmemset(&cmd_rsp, 0, sizeof(cmd_rsp));\r\nath9k_htc_ps_wakeup(priv);\r\nWMI_CMD(WMI_TX_STATS_CMDID);\r\nif (ret) {\r\nath9k_htc_ps_restore(priv);\r\nreturn -EINVAL;\r\n}\r\nath9k_htc_ps_restore(priv);\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "Xretries",\r\nbe32_to_cpu(cmd_rsp.xretries));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "FifoErr",\r\nbe32_to_cpu(cmd_rsp.fifoerr));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "Filtered",\r\nbe32_to_cpu(cmd_rsp.filtered));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "TimerExp",\r\nbe32_to_cpu(cmd_rsp.timer_exp));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "ShortRetries",\r\nbe32_to_cpu(cmd_rsp.shortretries));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "LongRetries",\r\nbe32_to_cpu(cmd_rsp.longretries));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "QueueNull",\r\nbe32_to_cpu(cmd_rsp.qnull));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "EncapFail",\r\nbe32_to_cpu(cmd_rsp.encap_fail));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "NoBuf",\r\nbe32_to_cpu(cmd_rsp.nobuf));\r\nif (len > sizeof(buf))\r\nlen = sizeof(buf);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t read_file_tgt_rx_stats(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nstruct ath9k_htc_target_rx_stats cmd_rsp;\r\nchar buf[512];\r\nunsigned int len = 0;\r\nint ret = 0;\r\nmemset(&cmd_rsp, 0, sizeof(cmd_rsp));\r\nath9k_htc_ps_wakeup(priv);\r\nWMI_CMD(WMI_RX_STATS_CMDID);\r\nif (ret) {\r\nath9k_htc_ps_restore(priv);\r\nreturn -EINVAL;\r\n}\r\nath9k_htc_ps_restore(priv);\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "NoBuf",\r\nbe32_to_cpu(cmd_rsp.nobuf));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "HostSend",\r\nbe32_to_cpu(cmd_rsp.host_send));\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "HostDone",\r\nbe32_to_cpu(cmd_rsp.host_done));\r\nif (len > sizeof(buf))\r\nlen = sizeof(buf);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t read_file_xmit(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nchar buf[512];\r\nunsigned int len = 0;\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "Buffers queued",\r\npriv->debug.tx_stats.buf_queued);\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "Buffers completed",\r\npriv->debug.tx_stats.buf_completed);\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "SKBs queued",\r\npriv->debug.tx_stats.skb_queued);\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "SKBs success",\r\npriv->debug.tx_stats.skb_success);\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "SKBs failed",\r\npriv->debug.tx_stats.skb_failed);\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "CAB queued",\r\npriv->debug.tx_stats.cab_queued);\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "BE queued",\r\npriv->debug.tx_stats.queue_stats[IEEE80211_AC_BE]);\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "BK queued",\r\npriv->debug.tx_stats.queue_stats[IEEE80211_AC_BK]);\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "VI queued",\r\npriv->debug.tx_stats.queue_stats[IEEE80211_AC_VI]);\r\nlen += scnprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "VO queued",\r\npriv->debug.tx_stats.queue_stats[IEEE80211_AC_VO]);\r\nif (len > sizeof(buf))\r\nlen = sizeof(buf);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nvoid ath9k_htc_err_stat_rx(struct ath9k_htc_priv *priv,\r\nstruct ath_rx_status *rs)\r\n{\r\nath9k_cmn_debug_stat_rx(&priv->debug.rx_stats, rs);\r\n}\r\nstatic ssize_t read_file_skb_rx(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nchar *buf;\r\nunsigned int len = 0, size = 1500;\r\nssize_t retval = 0;\r\nbuf = kzalloc(size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nlen += scnprintf(buf + len, size - len,\r\n"%20s : %10u\n", "SKBs allocated",\r\npriv->debug.skbrx_stats.skb_allocated);\r\nlen += scnprintf(buf + len, size - len,\r\n"%20s : %10u\n", "SKBs completed",\r\npriv->debug.skbrx_stats.skb_completed);\r\nlen += scnprintf(buf + len, size - len,\r\n"%20s : %10u\n", "SKBs Dropped",\r\npriv->debug.skbrx_stats.skb_dropped);\r\nif (len > size)\r\nlen = size;\r\nretval = simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\nkfree(buf);\r\nreturn retval;\r\n}\r\nstatic ssize_t read_file_slot(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nchar buf[512];\r\nunsigned int len;\r\nspin_lock_bh(&priv->tx.tx_lock);\r\nlen = scnprintf(buf, sizeof(buf),\r\n"TX slot bitmap : %*pb\n"\r\n"Used slots : %d\n",\r\nMAX_TX_BUF_NUM, priv->tx.tx_slot,\r\nbitmap_weight(priv->tx.tx_slot, MAX_TX_BUF_NUM));\r\nspin_unlock_bh(&priv->tx.tx_lock);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t read_file_queue(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nchar buf[512];\r\nunsigned int len = 0;\r\nlen += scnprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Mgmt endpoint", skb_queue_len(&priv->tx.mgmt_ep_queue));\r\nlen += scnprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Cab endpoint", skb_queue_len(&priv->tx.cab_ep_queue));\r\nlen += scnprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Data BE endpoint", skb_queue_len(&priv->tx.data_be_queue));\r\nlen += scnprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Data BK endpoint", skb_queue_len(&priv->tx.data_bk_queue));\r\nlen += scnprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Data VI endpoint", skb_queue_len(&priv->tx.data_vi_queue));\r\nlen += scnprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Data VO endpoint", skb_queue_len(&priv->tx.data_vo_queue));\r\nlen += scnprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Failed queue", skb_queue_len(&priv->tx.tx_failed));\r\nspin_lock_bh(&priv->tx.tx_lock);\r\nlen += scnprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Queued count", priv->tx.queued_cnt);\r\nspin_unlock_bh(&priv->tx.tx_lock);\r\nif (len > sizeof(buf))\r\nlen = sizeof(buf);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t read_file_debug(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nstruct ath_common *common = ath9k_hw_common(priv->ah);\r\nchar buf[32];\r\nunsigned int len;\r\nlen = sprintf(buf, "0x%08x\n", common->debug_mask);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t write_file_debug(struct file *file, const char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nstruct ath_common *common = ath9k_hw_common(priv->ah);\r\nunsigned long mask;\r\nchar buf[32];\r\nssize_t len;\r\nlen = min(count, sizeof(buf) - 1);\r\nif (copy_from_user(buf, user_buf, len))\r\nreturn -EFAULT;\r\nbuf[len] = '\0';\r\nif (kstrtoul(buf, 0, &mask))\r\nreturn -EINVAL;\r\ncommon->debug_mask = mask;\r\nreturn count;\r\n}\r\nvoid ath9k_htc_get_et_strings(struct ieee80211_hw *hw,\r\nstruct ieee80211_vif *vif,\r\nu32 sset, u8 *data)\r\n{\r\nif (sset == ETH_SS_STATS)\r\nmemcpy(data, *ath9k_htc_gstrings_stats,\r\nsizeof(ath9k_htc_gstrings_stats));\r\n}\r\nint ath9k_htc_get_et_sset_count(struct ieee80211_hw *hw,\r\nstruct ieee80211_vif *vif, int sset)\r\n{\r\nif (sset == ETH_SS_STATS)\r\nreturn ATH9K_HTC_SSTATS_LEN;\r\nreturn 0;\r\n}\r\nvoid ath9k_htc_get_et_stats(struct ieee80211_hw *hw,\r\nstruct ieee80211_vif *vif,\r\nstruct ethtool_stats *stats, u64 *data)\r\n{\r\nstruct ath9k_htc_priv *priv = hw->priv;\r\nint i = 0;\r\ndata[i++] = SKBTXBASE.skb_success;\r\ndata[i++] = SKBTXBASE.skb_success_bytes;\r\ndata[i++] = SKBRXBASE.skb_completed;\r\ndata[i++] = SKBRXBASE.skb_completed_bytes;\r\nASTXQ(queue_stats);\r\ndata[i++] = SRXBASE.crc_err;\r\ndata[i++] = SRXBASE.decrypt_crc_err;\r\ndata[i++] = SRXBASE.phy_err;\r\ndata[i++] = SRXBASE.mic_err;\r\ndata[i++] = SRXBASE.pre_delim_crc_err;\r\ndata[i++] = SRXBASE.post_delim_crc_err;\r\ndata[i++] = SRXBASE.decrypt_busy_err;\r\ndata[i++] = SRXBASE.phy_err_stats[ATH9K_PHYERR_RADAR];\r\ndata[i++] = SRXBASE.phy_err_stats[ATH9K_PHYERR_OFDM_TIMING];\r\ndata[i++] = SRXBASE.phy_err_stats[ATH9K_PHYERR_CCK_TIMING];\r\nWARN_ON(i != ATH9K_HTC_SSTATS_LEN);\r\n}\r\nvoid ath9k_htc_deinit_debug(struct ath9k_htc_priv *priv)\r\n{\r\nath9k_cmn_spectral_deinit_debug(&priv->spec_priv);\r\n}\r\nint ath9k_htc_init_debug(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nstruct ath9k_htc_priv *priv = (struct ath9k_htc_priv *) common->priv;\r\npriv->debug.debugfs_phy = debugfs_create_dir(KBUILD_MODNAME,\r\npriv->hw->wiphy->debugfsdir);\r\nif (!priv->debug.debugfs_phy)\r\nreturn -ENOMEM;\r\nath9k_cmn_spectral_init_debug(&priv->spec_priv, priv->debug.debugfs_phy);\r\ndebugfs_create_file("tgt_int_stats", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_tgt_int_stats);\r\ndebugfs_create_file("tgt_tx_stats", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_tgt_tx_stats);\r\ndebugfs_create_file("tgt_rx_stats", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_tgt_rx_stats);\r\ndebugfs_create_file("xmit", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_xmit);\r\ndebugfs_create_file("skb_rx", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_skb_rx);\r\nath9k_cmn_debug_recv(priv->debug.debugfs_phy, &priv->debug.rx_stats);\r\nath9k_cmn_debug_phy_err(priv->debug.debugfs_phy, &priv->debug.rx_stats);\r\ndebugfs_create_file("slot", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_slot);\r\ndebugfs_create_file("queue", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_queue);\r\ndebugfs_create_file("debug", S_IRUSR | S_IWUSR, priv->debug.debugfs_phy,\r\npriv, &fops_debug);\r\nath9k_cmn_debug_base_eeprom(priv->debug.debugfs_phy, priv->ah);\r\nath9k_cmn_debug_modal_eeprom(priv->debug.debugfs_phy, priv->ah);\r\nreturn 0;\r\n}

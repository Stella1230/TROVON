int vphn_unpack_associativity(const long *packed, __be32 *unpacked)\r\n{\r\n__be64 be_packed[VPHN_REGISTER_COUNT];\r\nint i, nr_assoc_doms = 0;\r\nconst __be16 *field = (const __be16 *) be_packed;\r\nu16 last = 0;\r\nbool is_32bit = false;\r\n#define VPHN_FIELD_UNUSED (0xffff)\r\n#define VPHN_FIELD_MSB (0x8000)\r\n#define VPHN_FIELD_MASK (~VPHN_FIELD_MSB)\r\nfor (i = 0; i < VPHN_REGISTER_COUNT; i++)\r\nbe_packed[i] = cpu_to_be64(packed[i]);\r\nfor (i = 1; i < VPHN_ASSOC_BUFSIZE; i++) {\r\nu16 new = be16_to_cpup(field++);\r\nif (is_32bit) {\r\nunpacked[++nr_assoc_doms] =\r\ncpu_to_be32(last << 16 | new);\r\nis_32bit = false;\r\n} else if (new == VPHN_FIELD_UNUSED)\r\nbreak;\r\nelse if (new & VPHN_FIELD_MSB) {\r\nunpacked[++nr_assoc_doms] =\r\ncpu_to_be32(new & VPHN_FIELD_MASK);\r\n} else {\r\nlast = new;\r\nis_32bit = true;\r\n}\r\n}\r\nunpacked[0] = cpu_to_be32(nr_assoc_doms);\r\nreturn nr_assoc_doms;\r\n}

static inline struct xfrm6_protocol __rcu **proto_handlers(u8 protocol)\r\n{\r\nswitch (protocol) {\r\ncase IPPROTO_ESP:\r\nreturn &esp6_handlers;\r\ncase IPPROTO_AH:\r\nreturn &ah6_handlers;\r\ncase IPPROTO_COMP:\r\nreturn &ipcomp6_handlers;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int xfrm6_esp_rcv(struct sk_buff *skb)\r\n{\r\nint ret;\r\nstruct xfrm6_protocol *handler;\r\nXFRM_TUNNEL_SKB_CB(skb)->tunnel.ip6 = NULL;\r\nfor_each_protocol_rcu(esp6_handlers, handler)\r\nif ((ret = handler->handler(skb)) != -EINVAL)\r\nreturn ret;\r\nicmpv6_send(skb, ICMPV6_DEST_UNREACH, ICMPV6_PORT_UNREACH, 0);\r\nkfree_skb(skb);\r\nreturn 0;\r\n}\r\nstatic void xfrm6_esp_err(struct sk_buff *skb, struct inet6_skb_parm *opt,\r\nu8 type, u8 code, int offset, __be32 info)\r\n{\r\nstruct xfrm6_protocol *handler;\r\nfor_each_protocol_rcu(esp6_handlers, handler)\r\nif (!handler->err_handler(skb, opt, type, code, offset, info))\r\nbreak;\r\n}\r\nstatic int xfrm6_ah_rcv(struct sk_buff *skb)\r\n{\r\nint ret;\r\nstruct xfrm6_protocol *handler;\r\nXFRM_TUNNEL_SKB_CB(skb)->tunnel.ip6 = NULL;\r\nfor_each_protocol_rcu(ah6_handlers, handler)\r\nif ((ret = handler->handler(skb)) != -EINVAL)\r\nreturn ret;\r\nicmpv6_send(skb, ICMPV6_DEST_UNREACH, ICMPV6_PORT_UNREACH, 0);\r\nkfree_skb(skb);\r\nreturn 0;\r\n}\r\nstatic void xfrm6_ah_err(struct sk_buff *skb, struct inet6_skb_parm *opt,\r\nu8 type, u8 code, int offset, __be32 info)\r\n{\r\nstruct xfrm6_protocol *handler;\r\nfor_each_protocol_rcu(ah6_handlers, handler)\r\nif (!handler->err_handler(skb, opt, type, code, offset, info))\r\nbreak;\r\n}\r\nstatic int xfrm6_ipcomp_rcv(struct sk_buff *skb)\r\n{\r\nint ret;\r\nstruct xfrm6_protocol *handler;\r\nXFRM_TUNNEL_SKB_CB(skb)->tunnel.ip6 = NULL;\r\nfor_each_protocol_rcu(ipcomp6_handlers, handler)\r\nif ((ret = handler->handler(skb)) != -EINVAL)\r\nreturn ret;\r\nicmpv6_send(skb, ICMPV6_DEST_UNREACH, ICMPV6_PORT_UNREACH, 0);\r\nkfree_skb(skb);\r\nreturn 0;\r\n}\r\nstatic void xfrm6_ipcomp_err(struct sk_buff *skb, struct inet6_skb_parm *opt,\r\nu8 type, u8 code, int offset, __be32 info)\r\n{\r\nstruct xfrm6_protocol *handler;\r\nfor_each_protocol_rcu(ipcomp6_handlers, handler)\r\nif (!handler->err_handler(skb, opt, type, code, offset, info))\r\nbreak;\r\n}\r\nstatic inline const struct inet6_protocol *netproto(unsigned char protocol)\r\n{\r\nswitch (protocol) {\r\ncase IPPROTO_ESP:\r\nreturn &esp6_protocol;\r\ncase IPPROTO_AH:\r\nreturn &ah6_protocol;\r\ncase IPPROTO_COMP:\r\nreturn &ipcomp6_protocol;\r\n}\r\nreturn NULL;\r\n}\r\nint xfrm6_protocol_register(struct xfrm6_protocol *handler,\r\nunsigned char protocol)\r\n{\r\nstruct xfrm6_protocol __rcu **pprev;\r\nstruct xfrm6_protocol *t;\r\nbool add_netproto = false;\r\nint ret = -EEXIST;\r\nint priority = handler->priority;\r\nif (!proto_handlers(protocol) || !netproto(protocol))\r\nreturn -EINVAL;\r\nmutex_lock(&xfrm6_protocol_mutex);\r\nif (!rcu_dereference_protected(*proto_handlers(protocol),\r\nlockdep_is_held(&xfrm6_protocol_mutex)))\r\nadd_netproto = true;\r\nfor (pprev = proto_handlers(protocol);\r\n(t = rcu_dereference_protected(*pprev,\r\nlockdep_is_held(&xfrm6_protocol_mutex))) != NULL;\r\npprev = &t->next) {\r\nif (t->priority < priority)\r\nbreak;\r\nif (t->priority == priority)\r\ngoto err;\r\n}\r\nhandler->next = *pprev;\r\nrcu_assign_pointer(*pprev, handler);\r\nret = 0;\r\nerr:\r\nmutex_unlock(&xfrm6_protocol_mutex);\r\nif (add_netproto) {\r\nif (inet6_add_protocol(netproto(protocol), protocol)) {\r\npr_err("%s: can't add protocol\n", __func__);\r\nret = -EAGAIN;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nint xfrm6_protocol_deregister(struct xfrm6_protocol *handler,\r\nunsigned char protocol)\r\n{\r\nstruct xfrm6_protocol __rcu **pprev;\r\nstruct xfrm6_protocol *t;\r\nint ret = -ENOENT;\r\nif (!proto_handlers(protocol) || !netproto(protocol))\r\nreturn -EINVAL;\r\nmutex_lock(&xfrm6_protocol_mutex);\r\nfor (pprev = proto_handlers(protocol);\r\n(t = rcu_dereference_protected(*pprev,\r\nlockdep_is_held(&xfrm6_protocol_mutex))) != NULL;\r\npprev = &t->next) {\r\nif (t == handler) {\r\n*pprev = handler->next;\r\nret = 0;\r\nbreak;\r\n}\r\n}\r\nif (!rcu_dereference_protected(*proto_handlers(protocol),\r\nlockdep_is_held(&xfrm6_protocol_mutex))) {\r\nif (inet6_del_protocol(netproto(protocol), protocol) < 0) {\r\npr_err("%s: can't remove protocol\n", __func__);\r\nret = -EAGAIN;\r\n}\r\n}\r\nmutex_unlock(&xfrm6_protocol_mutex);\r\nsynchronize_net();\r\nreturn ret;\r\n}\r\nint __init xfrm6_protocol_init(void)\r\n{\r\nreturn xfrm_input_register_afinfo(&xfrm6_input_afinfo);\r\n}\r\nvoid xfrm6_protocol_fini(void)\r\n{\r\nxfrm_input_unregister_afinfo(&xfrm6_input_afinfo);\r\n}

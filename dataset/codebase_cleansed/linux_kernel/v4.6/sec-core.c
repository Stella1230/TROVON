static bool s2mpa01_volatile(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase S2MPA01_REG_INT1M:\r\ncase S2MPA01_REG_INT2M:\r\ncase S2MPA01_REG_INT3M:\r\nreturn false;\r\ndefault:\r\nreturn true;\r\n}\r\n}\r\nstatic bool s2mps11_volatile(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase S2MPS11_REG_INT1M:\r\ncase S2MPS11_REG_INT2M:\r\ncase S2MPS11_REG_INT3M:\r\nreturn false;\r\ndefault:\r\nreturn true;\r\n}\r\n}\r\nstatic bool s2mpu02_volatile(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase S2MPU02_REG_INT1M:\r\ncase S2MPU02_REG_INT2M:\r\ncase S2MPU02_REG_INT3M:\r\nreturn false;\r\ndefault:\r\nreturn true;\r\n}\r\n}\r\nstatic bool s5m8763_volatile(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase S5M8763_REG_IRQM1:\r\ncase S5M8763_REG_IRQM2:\r\ncase S5M8763_REG_IRQM3:\r\ncase S5M8763_REG_IRQM4:\r\nreturn false;\r\ndefault:\r\nreturn true;\r\n}\r\n}\r\nstatic void sec_pmic_dump_rev(struct sec_pmic_dev *sec_pmic)\r\n{\r\nunsigned int val;\r\nif (!regmap_read(sec_pmic->regmap_pmic, S2MPS11_REG_ID, &val))\r\ndev_dbg(sec_pmic->dev, "Revision: 0x%x\n", val);\r\n}\r\nstatic void sec_pmic_configure(struct sec_pmic_dev *sec_pmic)\r\n{\r\nint err;\r\nif (sec_pmic->device_type != S2MPS13X)\r\nreturn;\r\nif (sec_pmic->pdata->disable_wrstbi) {\r\nerr = regmap_update_bits(sec_pmic->regmap_pmic,\r\nS2MPS13_REG_WRSTBI,\r\nS2MPS13_REG_WRSTBI_MASK, 0x0);\r\nif (err)\r\ndev_warn(sec_pmic->dev,\r\n"Cannot initialize WRSTBI config: %d\n",\r\nerr);\r\n}\r\n}\r\nstatic struct sec_platform_data *sec_pmic_i2c_parse_dt_pdata(\r\nstruct device *dev)\r\n{\r\nstruct sec_platform_data *pd;\r\npd = devm_kzalloc(dev, sizeof(*pd), GFP_KERNEL);\r\nif (!pd)\r\nreturn ERR_PTR(-ENOMEM);\r\npd->manual_poweroff = of_property_read_bool(dev->of_node,\r\n"samsung,s2mps11-acokb-ground");\r\npd->disable_wrstbi = of_property_read_bool(dev->of_node,\r\n"samsung,s2mps11-wrstbi-ground");\r\nreturn pd;\r\n}\r\nstatic struct sec_platform_data *sec_pmic_i2c_parse_dt_pdata(\r\nstruct device *dev)\r\n{\r\nreturn NULL;\r\n}\r\nstatic inline unsigned long sec_i2c_get_driver_data(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\n#ifdef CONFIG_OF\r\nif (i2c->dev.of_node) {\r\nconst struct of_device_id *match;\r\nmatch = of_match_node(sec_dt_match, i2c->dev.of_node);\r\nreturn (unsigned long)match->data;\r\n}\r\n#endif\r\nreturn id->driver_data;\r\n}\r\nstatic int sec_pmic_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct sec_platform_data *pdata = dev_get_platdata(&i2c->dev);\r\nconst struct regmap_config *regmap;\r\nconst struct mfd_cell *sec_devs;\r\nstruct sec_pmic_dev *sec_pmic;\r\nunsigned long device_type;\r\nint ret, num_sec_devs;\r\nsec_pmic = devm_kzalloc(&i2c->dev, sizeof(struct sec_pmic_dev),\r\nGFP_KERNEL);\r\nif (sec_pmic == NULL)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(i2c, sec_pmic);\r\nsec_pmic->dev = &i2c->dev;\r\nsec_pmic->i2c = i2c;\r\nsec_pmic->irq = i2c->irq;\r\ndevice_type = sec_i2c_get_driver_data(i2c, id);\r\nif (sec_pmic->dev->of_node) {\r\npdata = sec_pmic_i2c_parse_dt_pdata(sec_pmic->dev);\r\nif (IS_ERR(pdata)) {\r\nret = PTR_ERR(pdata);\r\nreturn ret;\r\n}\r\npdata->device_type = device_type;\r\n}\r\nif (pdata) {\r\nsec_pmic->device_type = pdata->device_type;\r\nsec_pmic->irq_base = pdata->irq_base;\r\nsec_pmic->wakeup = pdata->wakeup;\r\nsec_pmic->pdata = pdata;\r\n}\r\nswitch (sec_pmic->device_type) {\r\ncase S2MPA01:\r\nregmap = &s2mpa01_regmap_config;\r\nbreak;\r\ncase S2MPS11X:\r\nregmap = &s2mps11_regmap_config;\r\nbreak;\r\ncase S2MPS13X:\r\nregmap = &s2mps13_regmap_config;\r\nbreak;\r\ncase S2MPS14X:\r\nregmap = &s2mps14_regmap_config;\r\nbreak;\r\ncase S2MPS15X:\r\nregmap = &s2mps15_regmap_config;\r\nbreak;\r\ncase S5M8763X:\r\nregmap = &s5m8763_regmap_config;\r\nbreak;\r\ncase S5M8767X:\r\nregmap = &s5m8767_regmap_config;\r\nbreak;\r\ncase S2MPU02:\r\nregmap = &s2mpu02_regmap_config;\r\nbreak;\r\ndefault:\r\nregmap = &sec_regmap_config;\r\nbreak;\r\n}\r\nsec_pmic->regmap_pmic = devm_regmap_init_i2c(i2c, regmap);\r\nif (IS_ERR(sec_pmic->regmap_pmic)) {\r\nret = PTR_ERR(sec_pmic->regmap_pmic);\r\ndev_err(&i2c->dev, "Failed to allocate register map: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nif (pdata && pdata->cfg_pmic_irq)\r\npdata->cfg_pmic_irq();\r\nsec_irq_init(sec_pmic);\r\npm_runtime_set_active(sec_pmic->dev);\r\nswitch (sec_pmic->device_type) {\r\ncase S5M8751X:\r\nsec_devs = s5m8751_devs;\r\nnum_sec_devs = ARRAY_SIZE(s5m8751_devs);\r\nbreak;\r\ncase S5M8763X:\r\nsec_devs = s5m8763_devs;\r\nnum_sec_devs = ARRAY_SIZE(s5m8763_devs);\r\nbreak;\r\ncase S5M8767X:\r\nsec_devs = s5m8767_devs;\r\nnum_sec_devs = ARRAY_SIZE(s5m8767_devs);\r\nbreak;\r\ncase S2MPA01:\r\nsec_devs = s2mpa01_devs;\r\nnum_sec_devs = ARRAY_SIZE(s2mpa01_devs);\r\nbreak;\r\ncase S2MPS11X:\r\nsec_devs = s2mps11_devs;\r\nnum_sec_devs = ARRAY_SIZE(s2mps11_devs);\r\nbreak;\r\ncase S2MPS13X:\r\nsec_devs = s2mps13_devs;\r\nnum_sec_devs = ARRAY_SIZE(s2mps13_devs);\r\nbreak;\r\ncase S2MPS14X:\r\nsec_devs = s2mps14_devs;\r\nnum_sec_devs = ARRAY_SIZE(s2mps14_devs);\r\nbreak;\r\ncase S2MPS15X:\r\nsec_devs = s2mps15_devs;\r\nnum_sec_devs = ARRAY_SIZE(s2mps15_devs);\r\nbreak;\r\ncase S2MPU02:\r\nsec_devs = s2mpu02_devs;\r\nnum_sec_devs = ARRAY_SIZE(s2mpu02_devs);\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\nret = mfd_add_devices(sec_pmic->dev, -1, sec_devs, num_sec_devs, NULL,\r\n0, NULL);\r\nif (ret)\r\ngoto err_mfd;\r\ndevice_init_wakeup(sec_pmic->dev, sec_pmic->wakeup);\r\nsec_pmic_configure(sec_pmic);\r\nsec_pmic_dump_rev(sec_pmic);\r\nreturn ret;\r\nerr_mfd:\r\nsec_irq_exit(sec_pmic);\r\nreturn ret;\r\n}\r\nstatic int sec_pmic_remove(struct i2c_client *i2c)\r\n{\r\nstruct sec_pmic_dev *sec_pmic = i2c_get_clientdata(i2c);\r\nmfd_remove_devices(sec_pmic->dev);\r\nsec_irq_exit(sec_pmic);\r\nreturn 0;\r\n}\r\nstatic void sec_pmic_shutdown(struct i2c_client *i2c)\r\n{\r\nstruct sec_pmic_dev *sec_pmic = i2c_get_clientdata(i2c);\r\nunsigned int reg, mask;\r\nif (!sec_pmic->pdata->manual_poweroff)\r\nreturn;\r\nswitch (sec_pmic->device_type) {\r\ncase S2MPS11X:\r\nreg = S2MPS11_REG_CTRL1;\r\nmask = S2MPS11_CTRL1_PWRHOLD_MASK;\r\nbreak;\r\ndefault:\r\ndev_warn(sec_pmic->dev,\r\n"Unsupported device %lu for manual power off\n",\r\nsec_pmic->device_type);\r\nreturn;\r\n}\r\nregmap_update_bits(sec_pmic->regmap_pmic, reg, mask, 0);\r\n}\r\nstatic int sec_pmic_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct sec_pmic_dev *sec_pmic = i2c_get_clientdata(i2c);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(sec_pmic->irq);\r\ndisable_irq(sec_pmic->irq);\r\nreturn 0;\r\n}\r\nstatic int sec_pmic_resume(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct sec_pmic_dev *sec_pmic = i2c_get_clientdata(i2c);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(sec_pmic->irq);\r\nenable_irq(sec_pmic->irq);\r\nreturn 0;\r\n}\r\nstatic int __init sec_pmic_init(void)\r\n{\r\nreturn i2c_add_driver(&sec_pmic_driver);\r\n}\r\nstatic void __exit sec_pmic_exit(void)\r\n{\r\ni2c_del_driver(&sec_pmic_driver);\r\n}

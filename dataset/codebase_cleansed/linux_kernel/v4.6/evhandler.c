acpi_status acpi_ev_install_region_handlers(void)\r\n{\r\nacpi_status status;\r\nu32 i;\r\nACPI_FUNCTION_TRACE(ev_install_region_handlers);\r\nstatus = acpi_ut_acquire_mutex(ACPI_MTX_NAMESPACE);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nfor (i = 0; i < ACPI_NUM_DEFAULT_SPACES; i++) {\r\nstatus = acpi_ev_install_space_handler(acpi_gbl_root_node,\r\nacpi_gbl_default_address_spaces\r\n[i],\r\nACPI_DEFAULT_HANDLER,\r\nNULL, NULL);\r\nswitch (status) {\r\ncase AE_OK:\r\ncase AE_SAME_HANDLER:\r\ncase AE_ALREADY_EXISTS:\r\nstatus = AE_OK;\r\nbreak;\r\ndefault:\r\ngoto unlock_and_exit;\r\n}\r\n}\r\nunlock_and_exit:\r\n(void)acpi_ut_release_mutex(ACPI_MTX_NAMESPACE);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nu8\r\nacpi_ev_has_default_handler(struct acpi_namespace_node *node,\r\nacpi_adr_space_type space_id)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_operand_object *handler_obj;\r\nobj_desc = acpi_ns_get_attached_object(node);\r\nif (obj_desc) {\r\nhandler_obj = obj_desc->common_notify.handler;\r\nwhile (handler_obj) {\r\nif (handler_obj->address_space.space_id == space_id) {\r\nif (handler_obj->address_space.handler_flags &\r\nACPI_ADDR_HANDLER_DEFAULT_INSTALLED) {\r\nreturn (TRUE);\r\n}\r\n}\r\nhandler_obj = handler_obj->address_space.next;\r\n}\r\n}\r\nreturn (FALSE);\r\n}\r\nstatic acpi_status\r\nacpi_ev_install_handler(acpi_handle obj_handle,\r\nu32 level, void *context, void **return_value)\r\n{\r\nunion acpi_operand_object *handler_obj;\r\nunion acpi_operand_object *next_handler_obj;\r\nunion acpi_operand_object *obj_desc;\r\nstruct acpi_namespace_node *node;\r\nacpi_status status;\r\nACPI_FUNCTION_NAME(ev_install_handler);\r\nhandler_obj = (union acpi_operand_object *)context;\r\nif (!handler_obj) {\r\nreturn (AE_OK);\r\n}\r\nnode = acpi_ns_validate_handle(obj_handle);\r\nif (!node) {\r\nreturn (AE_BAD_PARAMETER);\r\n}\r\nif ((node->type != ACPI_TYPE_DEVICE) &&\r\n(node->type != ACPI_TYPE_REGION) && (node != acpi_gbl_root_node)) {\r\nreturn (AE_OK);\r\n}\r\nobj_desc = acpi_ns_get_attached_object(node);\r\nif (!obj_desc) {\r\nreturn (AE_OK);\r\n}\r\nif (obj_desc->common.type == ACPI_TYPE_DEVICE) {\r\nnext_handler_obj =\r\nacpi_ev_find_region_handler(handler_obj->address_space.\r\nspace_id,\r\nobj_desc->common_notify.\r\nhandler);\r\nif (next_handler_obj) {\r\nACPI_DEBUG_PRINT((ACPI_DB_OPREGION,\r\n"Found handler for region [%s] in device %p(%p) handler %p\n",\r\nacpi_ut_get_region_name(handler_obj->\r\naddress_space.\r\nspace_id),\r\nobj_desc, next_handler_obj,\r\nhandler_obj));\r\nreturn (AE_CTRL_DEPTH);\r\n}\r\nreturn (AE_OK);\r\n}\r\nif (obj_desc->region.space_id != handler_obj->address_space.space_id) {\r\nreturn (AE_OK);\r\n}\r\nacpi_ev_detach_region(obj_desc, FALSE);\r\nstatus = acpi_ev_attach_region(handler_obj, obj_desc, FALSE);\r\nreturn (status);\r\n}\r\nunion acpi_operand_object *acpi_ev_find_region_handler(acpi_adr_space_type\r\nspace_id,\r\nunion acpi_operand_object\r\n*handler_obj)\r\n{\r\nwhile (handler_obj) {\r\nif (handler_obj->address_space.space_id == space_id) {\r\nreturn (handler_obj);\r\n}\r\nhandler_obj = handler_obj->address_space.next;\r\n}\r\nreturn (NULL);\r\n}\r\nacpi_status\r\nacpi_ev_install_space_handler(struct acpi_namespace_node * node,\r\nacpi_adr_space_type space_id,\r\nacpi_adr_space_handler handler,\r\nacpi_adr_space_setup setup, void *context)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_operand_object *handler_obj;\r\nacpi_status status = AE_OK;\r\nacpi_object_type type;\r\nu8 flags = 0;\r\nACPI_FUNCTION_TRACE(ev_install_space_handler);\r\nif ((node->type != ACPI_TYPE_DEVICE) &&\r\n(node->type != ACPI_TYPE_PROCESSOR) &&\r\n(node->type != ACPI_TYPE_THERMAL) && (node != acpi_gbl_root_node)) {\r\nstatus = AE_BAD_PARAMETER;\r\ngoto unlock_and_exit;\r\n}\r\nif (handler == ACPI_DEFAULT_HANDLER) {\r\nflags = ACPI_ADDR_HANDLER_DEFAULT_INSTALLED;\r\nswitch (space_id) {\r\ncase ACPI_ADR_SPACE_SYSTEM_MEMORY:\r\nhandler = acpi_ex_system_memory_space_handler;\r\nsetup = acpi_ev_system_memory_region_setup;\r\nbreak;\r\ncase ACPI_ADR_SPACE_SYSTEM_IO:\r\nhandler = acpi_ex_system_io_space_handler;\r\nsetup = acpi_ev_io_space_region_setup;\r\nbreak;\r\ncase ACPI_ADR_SPACE_PCI_CONFIG:\r\nhandler = acpi_ex_pci_config_space_handler;\r\nsetup = acpi_ev_pci_config_region_setup;\r\nbreak;\r\ncase ACPI_ADR_SPACE_CMOS:\r\nhandler = acpi_ex_cmos_space_handler;\r\nsetup = acpi_ev_cmos_region_setup;\r\nbreak;\r\ncase ACPI_ADR_SPACE_PCI_BAR_TARGET:\r\nhandler = acpi_ex_pci_bar_space_handler;\r\nsetup = acpi_ev_pci_bar_region_setup;\r\nbreak;\r\ncase ACPI_ADR_SPACE_DATA_TABLE:\r\nhandler = acpi_ex_data_table_space_handler;\r\nsetup = NULL;\r\nbreak;\r\ndefault:\r\nstatus = AE_BAD_PARAMETER;\r\ngoto unlock_and_exit;\r\n}\r\n}\r\nif (!setup) {\r\nsetup = acpi_ev_default_region_setup;\r\n}\r\nobj_desc = acpi_ns_get_attached_object(node);\r\nif (obj_desc) {\r\nhandler_obj = acpi_ev_find_region_handler(space_id,\r\nobj_desc->\r\ncommon_notify.\r\nhandler);\r\nif (handler_obj) {\r\nif (handler_obj->address_space.handler == handler) {\r\nstatus = AE_SAME_HANDLER;\r\ngoto unlock_and_exit;\r\n} else {\r\nstatus = AE_ALREADY_EXISTS;\r\n}\r\ngoto unlock_and_exit;\r\n}\r\n} else {\r\nACPI_DEBUG_PRINT((ACPI_DB_OPREGION,\r\n"Creating object on Device %p while installing handler\n",\r\nnode));\r\nif (node->type == ACPI_TYPE_ANY) {\r\ntype = ACPI_TYPE_DEVICE;\r\n} else {\r\ntype = node->type;\r\n}\r\nobj_desc = acpi_ut_create_internal_object(type);\r\nif (!obj_desc) {\r\nstatus = AE_NO_MEMORY;\r\ngoto unlock_and_exit;\r\n}\r\nobj_desc->common.type = (u8)type;\r\nstatus = acpi_ns_attach_object(node, obj_desc, type);\r\nacpi_ut_remove_reference(obj_desc);\r\nif (ACPI_FAILURE(status)) {\r\ngoto unlock_and_exit;\r\n}\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_OPREGION,\r\n"Installing address handler for region %s(%X) "\r\n"on Device %4.4s %p(%p)\n",\r\nacpi_ut_get_region_name(space_id), space_id,\r\nacpi_ut_get_node_name(node), node, obj_desc));\r\nhandler_obj =\r\nacpi_ut_create_internal_object(ACPI_TYPE_LOCAL_ADDRESS_HANDLER);\r\nif (!handler_obj) {\r\nstatus = AE_NO_MEMORY;\r\ngoto unlock_and_exit;\r\n}\r\nhandler_obj->address_space.space_id = (u8)space_id;\r\nhandler_obj->address_space.handler_flags = flags;\r\nhandler_obj->address_space.region_list = NULL;\r\nhandler_obj->address_space.node = node;\r\nhandler_obj->address_space.handler = handler;\r\nhandler_obj->address_space.context = context;\r\nhandler_obj->address_space.setup = setup;\r\nhandler_obj->address_space.next = obj_desc->common_notify.handler;\r\nobj_desc->common_notify.handler = handler_obj;\r\nstatus = acpi_ns_walk_namespace(ACPI_TYPE_ANY, node,\r\nACPI_UINT32_MAX, ACPI_NS_WALK_UNLOCK,\r\nacpi_ev_install_handler, NULL,\r\nhandler_obj, NULL);\r\nunlock_and_exit:\r\nreturn_ACPI_STATUS(status);\r\n}

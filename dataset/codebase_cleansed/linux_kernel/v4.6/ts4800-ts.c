static void ts4800_ts_open(struct input_polled_dev *dev)\r\n{\r\nstruct ts4800_ts *ts = dev->private;\r\nint ret;\r\nts->pendown = false;\r\nts->debounce = DEBOUNCE_COUNT;\r\nret = regmap_update_bits(ts->regmap, ts->reg, ts->bit, ts->bit);\r\nif (ret)\r\ndev_warn(ts->dev, "Failed to enable touchscreen\n");\r\n}\r\nstatic void ts4800_ts_close(struct input_polled_dev *dev)\r\n{\r\nstruct ts4800_ts *ts = dev->private;\r\nint ret;\r\nret = regmap_update_bits(ts->regmap, ts->reg, ts->bit, 0);\r\nif (ret)\r\ndev_warn(ts->dev, "Failed to disable touchscreen\n");\r\n}\r\nstatic void ts4800_ts_poll(struct input_polled_dev *dev)\r\n{\r\nstruct input_dev *input_dev = dev->input;\r\nstruct ts4800_ts *ts = dev->private;\r\nu16 last_x = readw(ts->base + X_OFFSET);\r\nu16 last_y = readw(ts->base + Y_OFFSET);\r\nbool pendown = last_x & PENDOWN_MASK;\r\nif (pendown) {\r\nif (ts->debounce) {\r\nts->debounce--;\r\nreturn;\r\n}\r\nif (!ts->pendown) {\r\ninput_report_key(input_dev, BTN_TOUCH, 1);\r\nts->pendown = true;\r\n}\r\nlast_x = ((~last_x) >> 4) & MAX_12BIT;\r\nlast_y = ((~last_y) >> 4) & MAX_12BIT;\r\ninput_report_abs(input_dev, ABS_X, last_x);\r\ninput_report_abs(input_dev, ABS_Y, last_y);\r\ninput_sync(input_dev);\r\n} else if (ts->pendown) {\r\nts->pendown = false;\r\nts->debounce = DEBOUNCE_COUNT;\r\ninput_report_key(input_dev, BTN_TOUCH, 0);\r\ninput_sync(input_dev);\r\n}\r\n}\r\nstatic int ts4800_parse_dt(struct platform_device *pdev,\r\nstruct ts4800_ts *ts)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct device_node *syscon_np;\r\nu32 reg, bit;\r\nint error;\r\nsyscon_np = of_parse_phandle(np, "syscon", 0);\r\nif (!syscon_np) {\r\ndev_err(dev, "no syscon property\n");\r\nreturn -ENODEV;\r\n}\r\nerror = of_property_read_u32_index(np, "syscon", 1, &reg);\r\nif (error < 0) {\r\ndev_err(dev, "no offset in syscon\n");\r\nreturn error;\r\n}\r\nts->reg = reg;\r\nerror = of_property_read_u32_index(np, "syscon", 2, &bit);\r\nif (error < 0) {\r\ndev_err(dev, "no bit in syscon\n");\r\nreturn error;\r\n}\r\nts->bit = BIT(bit);\r\nts->regmap = syscon_node_to_regmap(syscon_np);\r\nif (IS_ERR(ts->regmap)) {\r\ndev_err(dev, "cannot get parent's regmap\n");\r\nreturn PTR_ERR(ts->regmap);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ts4800_ts_probe(struct platform_device *pdev)\r\n{\r\nstruct input_polled_dev *poll_dev;\r\nstruct ts4800_ts *ts;\r\nstruct resource *res;\r\nint error;\r\nts = devm_kzalloc(&pdev->dev, sizeof(*ts), GFP_KERNEL);\r\nif (!ts)\r\nreturn -ENOMEM;\r\nerror = ts4800_parse_dt(pdev, ts);\r\nif (error)\r\nreturn error;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nts->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(ts->base))\r\nreturn PTR_ERR(ts->base);\r\npoll_dev = devm_input_allocate_polled_device(&pdev->dev);\r\nif (!poll_dev)\r\nreturn -ENOMEM;\r\nsnprintf(ts->phys, sizeof(ts->phys), "%s/input0", dev_name(&pdev->dev));\r\nts->poll_dev = poll_dev;\r\nts->dev = &pdev->dev;\r\npoll_dev->private = ts;\r\npoll_dev->poll_interval = POLL_INTERVAL;\r\npoll_dev->open = ts4800_ts_open;\r\npoll_dev->close = ts4800_ts_close;\r\npoll_dev->poll = ts4800_ts_poll;\r\npoll_dev->input->name = "TS-4800 Touchscreen";\r\npoll_dev->input->phys = ts->phys;\r\ninput_set_capability(poll_dev->input, EV_KEY, BTN_TOUCH);\r\ninput_set_abs_params(poll_dev->input, ABS_X, 0, MAX_12BIT, 0, 0);\r\ninput_set_abs_params(poll_dev->input, ABS_Y, 0, MAX_12BIT, 0, 0);\r\nerror = input_register_polled_device(poll_dev);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"Unabled to register polled input device (%d)\n",\r\nerror);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}

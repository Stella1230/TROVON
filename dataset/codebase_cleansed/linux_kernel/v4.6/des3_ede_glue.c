static inline void des3_ede_enc_blk(struct des3_ede_x86_ctx *ctx, u8 *dst,\r\nconst u8 *src)\r\n{\r\nu32 *enc_ctx = ctx->enc_expkey;\r\ndes3_ede_x86_64_crypt_blk(enc_ctx, dst, src);\r\n}\r\nstatic inline void des3_ede_dec_blk(struct des3_ede_x86_ctx *ctx, u8 *dst,\r\nconst u8 *src)\r\n{\r\nu32 *dec_ctx = ctx->dec_expkey;\r\ndes3_ede_x86_64_crypt_blk(dec_ctx, dst, src);\r\n}\r\nstatic inline void des3_ede_enc_blk_3way(struct des3_ede_x86_ctx *ctx, u8 *dst,\r\nconst u8 *src)\r\n{\r\nu32 *enc_ctx = ctx->enc_expkey;\r\ndes3_ede_x86_64_crypt_blk_3way(enc_ctx, dst, src);\r\n}\r\nstatic inline void des3_ede_dec_blk_3way(struct des3_ede_x86_ctx *ctx, u8 *dst,\r\nconst u8 *src)\r\n{\r\nu32 *dec_ctx = ctx->dec_expkey;\r\ndes3_ede_x86_64_crypt_blk_3way(dec_ctx, dst, src);\r\n}\r\nstatic void des3_ede_x86_encrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\ndes3_ede_enc_blk(crypto_tfm_ctx(tfm), dst, src);\r\n}\r\nstatic void des3_ede_x86_decrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\ndes3_ede_dec_blk(crypto_tfm_ctx(tfm), dst, src);\r\n}\r\nstatic int ecb_crypt(struct blkcipher_desc *desc, struct blkcipher_walk *walk,\r\nconst u32 *expkey)\r\n{\r\nunsigned int bsize = DES3_EDE_BLOCK_SIZE;\r\nunsigned int nbytes;\r\nint err;\r\nerr = blkcipher_walk_virt(desc, walk);\r\nwhile ((nbytes = walk->nbytes)) {\r\nu8 *wsrc = walk->src.virt.addr;\r\nu8 *wdst = walk->dst.virt.addr;\r\nif (nbytes >= bsize * 3) {\r\ndo {\r\ndes3_ede_x86_64_crypt_blk_3way(expkey, wdst,\r\nwsrc);\r\nwsrc += bsize * 3;\r\nwdst += bsize * 3;\r\nnbytes -= bsize * 3;\r\n} while (nbytes >= bsize * 3);\r\nif (nbytes < bsize)\r\ngoto done;\r\n}\r\ndo {\r\ndes3_ede_x86_64_crypt_blk(expkey, wdst, wsrc);\r\nwsrc += bsize;\r\nwdst += bsize;\r\nnbytes -= bsize;\r\n} while (nbytes >= bsize);\r\ndone:\r\nerr = blkcipher_walk_done(desc, walk, nbytes);\r\n}\r\nreturn err;\r\n}\r\nstatic int ecb_encrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct des3_ede_x86_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ecb_crypt(desc, &walk, ctx->enc_expkey);\r\n}\r\nstatic int ecb_decrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct des3_ede_x86_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ecb_crypt(desc, &walk, ctx->dec_expkey);\r\n}\r\nstatic unsigned int __cbc_encrypt(struct blkcipher_desc *desc,\r\nstruct blkcipher_walk *walk)\r\n{\r\nstruct des3_ede_x86_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nunsigned int bsize = DES3_EDE_BLOCK_SIZE;\r\nunsigned int nbytes = walk->nbytes;\r\nu64 *src = (u64 *)walk->src.virt.addr;\r\nu64 *dst = (u64 *)walk->dst.virt.addr;\r\nu64 *iv = (u64 *)walk->iv;\r\ndo {\r\n*dst = *src ^ *iv;\r\ndes3_ede_enc_blk(ctx, (u8 *)dst, (u8 *)dst);\r\niv = dst;\r\nsrc += 1;\r\ndst += 1;\r\nnbytes -= bsize;\r\n} while (nbytes >= bsize);\r\n*(u64 *)walk->iv = *iv;\r\nreturn nbytes;\r\n}\r\nstatic int cbc_encrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nint err;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nerr = blkcipher_walk_virt(desc, &walk);\r\nwhile ((nbytes = walk.nbytes)) {\r\nnbytes = __cbc_encrypt(desc, &walk);\r\nerr = blkcipher_walk_done(desc, &walk, nbytes);\r\n}\r\nreturn err;\r\n}\r\nstatic unsigned int __cbc_decrypt(struct blkcipher_desc *desc,\r\nstruct blkcipher_walk *walk)\r\n{\r\nstruct des3_ede_x86_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nunsigned int bsize = DES3_EDE_BLOCK_SIZE;\r\nunsigned int nbytes = walk->nbytes;\r\nu64 *src = (u64 *)walk->src.virt.addr;\r\nu64 *dst = (u64 *)walk->dst.virt.addr;\r\nu64 ivs[3 - 1];\r\nu64 last_iv;\r\nsrc += nbytes / bsize - 1;\r\ndst += nbytes / bsize - 1;\r\nlast_iv = *src;\r\nif (nbytes >= bsize * 3) {\r\ndo {\r\nnbytes -= bsize * 3 - bsize;\r\nsrc -= 3 - 1;\r\ndst -= 3 - 1;\r\nivs[0] = src[0];\r\nivs[1] = src[1];\r\ndes3_ede_dec_blk_3way(ctx, (u8 *)dst, (u8 *)src);\r\ndst[1] ^= ivs[0];\r\ndst[2] ^= ivs[1];\r\nnbytes -= bsize;\r\nif (nbytes < bsize)\r\ngoto done;\r\n*dst ^= *(src - 1);\r\nsrc -= 1;\r\ndst -= 1;\r\n} while (nbytes >= bsize * 3);\r\n}\r\nfor (;;) {\r\ndes3_ede_dec_blk(ctx, (u8 *)dst, (u8 *)src);\r\nnbytes -= bsize;\r\nif (nbytes < bsize)\r\nbreak;\r\n*dst ^= *(src - 1);\r\nsrc -= 1;\r\ndst -= 1;\r\n}\r\ndone:\r\n*dst ^= *(u64 *)walk->iv;\r\n*(u64 *)walk->iv = last_iv;\r\nreturn nbytes;\r\n}\r\nstatic int cbc_decrypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nint err;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nerr = blkcipher_walk_virt(desc, &walk);\r\nwhile ((nbytes = walk.nbytes)) {\r\nnbytes = __cbc_decrypt(desc, &walk);\r\nerr = blkcipher_walk_done(desc, &walk, nbytes);\r\n}\r\nreturn err;\r\n}\r\nstatic void ctr_crypt_final(struct des3_ede_x86_ctx *ctx,\r\nstruct blkcipher_walk *walk)\r\n{\r\nu8 *ctrblk = walk->iv;\r\nu8 keystream[DES3_EDE_BLOCK_SIZE];\r\nu8 *src = walk->src.virt.addr;\r\nu8 *dst = walk->dst.virt.addr;\r\nunsigned int nbytes = walk->nbytes;\r\ndes3_ede_enc_blk(ctx, keystream, ctrblk);\r\ncrypto_xor(keystream, src, nbytes);\r\nmemcpy(dst, keystream, nbytes);\r\ncrypto_inc(ctrblk, DES3_EDE_BLOCK_SIZE);\r\n}\r\nstatic unsigned int __ctr_crypt(struct blkcipher_desc *desc,\r\nstruct blkcipher_walk *walk)\r\n{\r\nstruct des3_ede_x86_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nunsigned int bsize = DES3_EDE_BLOCK_SIZE;\r\nunsigned int nbytes = walk->nbytes;\r\n__be64 *src = (__be64 *)walk->src.virt.addr;\r\n__be64 *dst = (__be64 *)walk->dst.virt.addr;\r\nu64 ctrblk = be64_to_cpu(*(__be64 *)walk->iv);\r\n__be64 ctrblocks[3];\r\nif (nbytes >= bsize * 3) {\r\ndo {\r\nctrblocks[0] = cpu_to_be64(ctrblk++);\r\nctrblocks[1] = cpu_to_be64(ctrblk++);\r\nctrblocks[2] = cpu_to_be64(ctrblk++);\r\ndes3_ede_enc_blk_3way(ctx, (u8 *)ctrblocks,\r\n(u8 *)ctrblocks);\r\ndst[0] = src[0] ^ ctrblocks[0];\r\ndst[1] = src[1] ^ ctrblocks[1];\r\ndst[2] = src[2] ^ ctrblocks[2];\r\nsrc += 3;\r\ndst += 3;\r\n} while ((nbytes -= bsize * 3) >= bsize * 3);\r\nif (nbytes < bsize)\r\ngoto done;\r\n}\r\ndo {\r\nctrblocks[0] = cpu_to_be64(ctrblk++);\r\ndes3_ede_enc_blk(ctx, (u8 *)ctrblocks, (u8 *)ctrblocks);\r\ndst[0] = src[0] ^ ctrblocks[0];\r\nsrc += 1;\r\ndst += 1;\r\n} while ((nbytes -= bsize) >= bsize);\r\ndone:\r\n*(__be64 *)walk->iv = cpu_to_be64(ctrblk);\r\nreturn nbytes;\r\n}\r\nstatic int ctr_crypt(struct blkcipher_desc *desc, struct scatterlist *dst,\r\nstruct scatterlist *src, unsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nint err;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nerr = blkcipher_walk_virt_block(desc, &walk, DES3_EDE_BLOCK_SIZE);\r\nwhile ((nbytes = walk.nbytes) >= DES3_EDE_BLOCK_SIZE) {\r\nnbytes = __ctr_crypt(desc, &walk);\r\nerr = blkcipher_walk_done(desc, &walk, nbytes);\r\n}\r\nif (walk.nbytes) {\r\nctr_crypt_final(crypto_blkcipher_ctx(desc->tfm), &walk);\r\nerr = blkcipher_walk_done(desc, &walk, 0);\r\n}\r\nreturn err;\r\n}\r\nstatic int des3_ede_x86_setkey(struct crypto_tfm *tfm, const u8 *key,\r\nunsigned int keylen)\r\n{\r\nstruct des3_ede_x86_ctx *ctx = crypto_tfm_ctx(tfm);\r\nu32 i, j, tmp;\r\nint err;\r\nerr = __des3_ede_setkey(ctx->enc_expkey, &tfm->crt_flags, key, keylen);\r\nif (err < 0)\r\nreturn err;\r\nj = DES3_EDE_EXPKEY_WORDS - 2;\r\nfor (i = 0; i < DES3_EDE_EXPKEY_WORDS; i += 2, j -= 2) {\r\ntmp = ror32(ctx->enc_expkey[i + 1], 4);\r\nctx->enc_expkey[i + 1] = tmp;\r\nctx->dec_expkey[j + 0] = ctx->enc_expkey[i + 0];\r\nctx->dec_expkey[j + 1] = tmp;\r\n}\r\nreturn 0;\r\n}\r\nstatic bool is_blacklisted_cpu(void)\r\n{\r\nif (boot_cpu_data.x86_vendor != X86_VENDOR_INTEL)\r\nreturn false;\r\nif (boot_cpu_data.x86 == 0x0f) {\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic int __init des3_ede_x86_init(void)\r\n{\r\nif (!force && is_blacklisted_cpu()) {\r\npr_info("des3_ede-x86_64: performance on this CPU would be suboptimal: disabling des3_ede-x86_64.\n");\r\nreturn -ENODEV;\r\n}\r\nreturn crypto_register_algs(des3_ede_algs, ARRAY_SIZE(des3_ede_algs));\r\n}\r\nstatic void __exit des3_ede_x86_fini(void)\r\n{\r\ncrypto_unregister_algs(des3_ede_algs, ARRAY_SIZE(des3_ede_algs));\r\n}

static inline u16 get_order_of_qentries(u16 queue_entries)\r\n{\r\nu8 ld = 1;\r\nwhile (((1U << ld) - 1) < queue_entries)\r\nld++;\r\nreturn ld - 1;\r\n}\r\nstatic long ehea_plpar_hcall_norets(unsigned long opcode,\r\nunsigned long arg1,\r\nunsigned long arg2,\r\nunsigned long arg3,\r\nunsigned long arg4,\r\nunsigned long arg5,\r\nunsigned long arg6,\r\nunsigned long arg7)\r\n{\r\nlong ret;\r\nint i, sleep_msecs;\r\nfor (i = 0; i < 5; i++) {\r\nret = plpar_hcall_norets(opcode, arg1, arg2, arg3, arg4,\r\narg5, arg6, arg7);\r\nif (H_IS_LONG_BUSY(ret)) {\r\nsleep_msecs = get_longbusy_msecs(ret);\r\nmsleep_interruptible(sleep_msecs);\r\ncontinue;\r\n}\r\nif (ret < H_SUCCESS)\r\npr_err("opcode=%lx ret=%lx"\r\n" arg1=%lx arg2=%lx arg3=%lx arg4=%lx"\r\n" arg5=%lx arg6=%lx arg7=%lx\n",\r\nopcode, ret,\r\narg1, arg2, arg3, arg4, arg5, arg6, arg7);\r\nreturn ret;\r\n}\r\nreturn H_BUSY;\r\n}\r\nstatic long ehea_plpar_hcall9(unsigned long opcode,\r\nunsigned long *outs,\r\nunsigned long arg1,\r\nunsigned long arg2,\r\nunsigned long arg3,\r\nunsigned long arg4,\r\nunsigned long arg5,\r\nunsigned long arg6,\r\nunsigned long arg7,\r\nunsigned long arg8,\r\nunsigned long arg9)\r\n{\r\nlong ret;\r\nint i, sleep_msecs;\r\nu8 cb_cat;\r\nfor (i = 0; i < 5; i++) {\r\nret = plpar_hcall9(opcode, outs,\r\narg1, arg2, arg3, arg4, arg5,\r\narg6, arg7, arg8, arg9);\r\nif (H_IS_LONG_BUSY(ret)) {\r\nsleep_msecs = get_longbusy_msecs(ret);\r\nmsleep_interruptible(sleep_msecs);\r\ncontinue;\r\n}\r\ncb_cat = EHEA_BMASK_GET(H_MEHEAPORT_CAT, arg2);\r\nif ((ret < H_SUCCESS) && !(((ret == H_AUTHORITY)\r\n&& (opcode == H_MODIFY_HEA_PORT))\r\n&& (((cb_cat == H_PORT_CB4) && ((arg3 == H_PORT_CB4_JUMBO)\r\n|| (arg3 == H_PORT_CB4_SPEED))) || ((cb_cat == H_PORT_CB7)\r\n&& (arg3 == H_PORT_CB7_DUCQPN)))))\r\npr_err("opcode=%lx ret=%lx"\r\n" arg1=%lx arg2=%lx arg3=%lx arg4=%lx"\r\n" arg5=%lx arg6=%lx arg7=%lx arg8=%lx"\r\n" arg9=%lx"\r\n" out1=%lx out2=%lx out3=%lx out4=%lx"\r\n" out5=%lx out6=%lx out7=%lx out8=%lx"\r\n" out9=%lx\n",\r\nopcode, ret,\r\narg1, arg2, arg3, arg4, arg5,\r\narg6, arg7, arg8, arg9,\r\nouts[0], outs[1], outs[2], outs[3], outs[4],\r\nouts[5], outs[6], outs[7], outs[8]);\r\nreturn ret;\r\n}\r\nreturn H_BUSY;\r\n}\r\nu64 ehea_h_query_ehea_qp(const u64 adapter_handle, const u8 qp_category,\r\nconst u64 qp_handle, const u64 sel_mask, void *cb_addr)\r\n{\r\nreturn ehea_plpar_hcall_norets(H_QUERY_HEA_QP,\r\nadapter_handle,\r\nqp_category,\r\nqp_handle,\r\nsel_mask,\r\n__pa(cb_addr),\r\n0, 0);\r\n}\r\nu64 ehea_h_alloc_resource_qp(const u64 adapter_handle,\r\nstruct ehea_qp_init_attr *init_attr, const u32 pd,\r\nu64 *qp_handle, struct h_epas *h_epas)\r\n{\r\nu64 hret;\r\nunsigned long outs[PLPAR_HCALL9_BUFSIZE];\r\nu64 allocate_controls =\r\nEHEA_BMASK_SET(H_ALL_RES_QP_EQPO, init_attr->low_lat_rq1 ? 1 : 0)\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_QPP, 0)\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_RQR, 6)\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_EQEG, 0)\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_LL_QP, init_attr->low_lat_rq1)\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_DMA128, 0)\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_HSM, 0)\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_SIGT, init_attr->signalingtype)\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_RES_TYP, H_ALL_RES_TYPE_QP);\r\nu64 r9_reg = EHEA_BMASK_SET(H_ALL_RES_QP_PD, pd)\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_TOKEN, init_attr->qp_token);\r\nu64 max_r10_reg =\r\nEHEA_BMASK_SET(H_ALL_RES_QP_MAX_SWQE,\r\nget_order_of_qentries(init_attr->max_nr_send_wqes))\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_MAX_R1WQE,\r\nget_order_of_qentries(init_attr->max_nr_rwqes_rq1))\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_MAX_R2WQE,\r\nget_order_of_qentries(init_attr->max_nr_rwqes_rq2))\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_MAX_R3WQE,\r\nget_order_of_qentries(init_attr->max_nr_rwqes_rq3))\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_MAX_SSGE, init_attr->wqe_size_enc_sq)\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_MAX_R1SGE,\r\ninit_attr->wqe_size_enc_rq1)\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_MAX_R2SGE,\r\ninit_attr->wqe_size_enc_rq2)\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_MAX_R3SGE,\r\ninit_attr->wqe_size_enc_rq3);\r\nu64 r11_in =\r\nEHEA_BMASK_SET(H_ALL_RES_QP_SWQE_IDL, init_attr->swqe_imm_data_len)\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_PORT_NUM, init_attr->port_nr);\r\nu64 threshold =\r\nEHEA_BMASK_SET(H_ALL_RES_QP_TH_RQ2, init_attr->rq2_threshold)\r\n| EHEA_BMASK_SET(H_ALL_RES_QP_TH_RQ3, init_attr->rq3_threshold);\r\nhret = ehea_plpar_hcall9(H_ALLOC_HEA_RESOURCE,\r\nouts,\r\nadapter_handle,\r\nallocate_controls,\r\ninit_attr->send_cq_handle,\r\ninit_attr->recv_cq_handle,\r\ninit_attr->aff_eq_handle,\r\nr9_reg,\r\nmax_r10_reg,\r\nr11_in,\r\nthreshold);\r\n*qp_handle = outs[0];\r\ninit_attr->qp_nr = (u32)outs[1];\r\ninit_attr->act_nr_send_wqes =\r\n(u16)EHEA_BMASK_GET(H_ALL_RES_QP_ACT_SWQE, outs[2]);\r\ninit_attr->act_nr_rwqes_rq1 =\r\n(u16)EHEA_BMASK_GET(H_ALL_RES_QP_ACT_R1WQE, outs[2]);\r\ninit_attr->act_nr_rwqes_rq2 =\r\n(u16)EHEA_BMASK_GET(H_ALL_RES_QP_ACT_R2WQE, outs[2]);\r\ninit_attr->act_nr_rwqes_rq3 =\r\n(u16)EHEA_BMASK_GET(H_ALL_RES_QP_ACT_R3WQE, outs[2]);\r\ninit_attr->act_wqe_size_enc_sq = init_attr->wqe_size_enc_sq;\r\ninit_attr->act_wqe_size_enc_rq1 = init_attr->wqe_size_enc_rq1;\r\ninit_attr->act_wqe_size_enc_rq2 = init_attr->wqe_size_enc_rq2;\r\ninit_attr->act_wqe_size_enc_rq3 = init_attr->wqe_size_enc_rq3;\r\ninit_attr->nr_sq_pages =\r\n(u32)EHEA_BMASK_GET(H_ALL_RES_QP_SIZE_SQ, outs[4]);\r\ninit_attr->nr_rq1_pages =\r\n(u32)EHEA_BMASK_GET(H_ALL_RES_QP_SIZE_RQ1, outs[4]);\r\ninit_attr->nr_rq2_pages =\r\n(u32)EHEA_BMASK_GET(H_ALL_RES_QP_SIZE_RQ2, outs[5]);\r\ninit_attr->nr_rq3_pages =\r\n(u32)EHEA_BMASK_GET(H_ALL_RES_QP_SIZE_RQ3, outs[5]);\r\ninit_attr->liobn_sq =\r\n(u32)EHEA_BMASK_GET(H_ALL_RES_QP_LIOBN_SQ, outs[7]);\r\ninit_attr->liobn_rq1 =\r\n(u32)EHEA_BMASK_GET(H_ALL_RES_QP_LIOBN_RQ1, outs[7]);\r\ninit_attr->liobn_rq2 =\r\n(u32)EHEA_BMASK_GET(H_ALL_RES_QP_LIOBN_RQ2, outs[8]);\r\ninit_attr->liobn_rq3 =\r\n(u32)EHEA_BMASK_GET(H_ALL_RES_QP_LIOBN_RQ3, outs[8]);\r\nif (!hret)\r\nhcp_epas_ctor(h_epas, outs[6], outs[6]);\r\nreturn hret;\r\n}\r\nu64 ehea_h_alloc_resource_cq(const u64 adapter_handle,\r\nstruct ehea_cq_attr *cq_attr,\r\nu64 *cq_handle, struct h_epas *epas)\r\n{\r\nu64 hret;\r\nunsigned long outs[PLPAR_HCALL9_BUFSIZE];\r\nhret = ehea_plpar_hcall9(H_ALLOC_HEA_RESOURCE,\r\nouts,\r\nadapter_handle,\r\nH_ALL_RES_TYPE_CQ,\r\ncq_attr->eq_handle,\r\ncq_attr->cq_token,\r\ncq_attr->max_nr_of_cqes,\r\n0, 0, 0, 0);\r\n*cq_handle = outs[0];\r\ncq_attr->act_nr_of_cqes = outs[3];\r\ncq_attr->nr_pages = outs[4];\r\nif (!hret)\r\nhcp_epas_ctor(epas, outs[5], outs[6]);\r\nreturn hret;\r\n}\r\nu64 ehea_h_alloc_resource_eq(const u64 adapter_handle,\r\nstruct ehea_eq_attr *eq_attr, u64 *eq_handle)\r\n{\r\nu64 hret, allocate_controls;\r\nunsigned long outs[PLPAR_HCALL9_BUFSIZE];\r\nallocate_controls =\r\nEHEA_BMASK_SET(H_ALL_RES_EQ_RES_TYPE, H_ALL_RES_TYPE_EQ)\r\n| EHEA_BMASK_SET(H_ALL_RES_EQ_NEQ, eq_attr->type ? 1 : 0)\r\n| EHEA_BMASK_SET(H_ALL_RES_EQ_INH_EQE_GEN, !eq_attr->eqe_gen)\r\n| EHEA_BMASK_SET(H_ALL_RES_EQ_NON_NEQ_ISN, 1);\r\nhret = ehea_plpar_hcall9(H_ALLOC_HEA_RESOURCE,\r\nouts,\r\nadapter_handle,\r\nallocate_controls,\r\neq_attr->max_nr_of_eqes,\r\n0, 0, 0, 0, 0, 0);\r\n*eq_handle = outs[0];\r\neq_attr->act_nr_of_eqes = outs[3];\r\neq_attr->nr_pages = outs[4];\r\neq_attr->ist1 = outs[5];\r\neq_attr->ist2 = outs[6];\r\neq_attr->ist3 = outs[7];\r\neq_attr->ist4 = outs[8];\r\nreturn hret;\r\n}\r\nu64 ehea_h_modify_ehea_qp(const u64 adapter_handle, const u8 cat,\r\nconst u64 qp_handle, const u64 sel_mask,\r\nvoid *cb_addr, u64 *inv_attr_id, u64 *proc_mask,\r\nu16 *out_swr, u16 *out_rwr)\r\n{\r\nu64 hret;\r\nunsigned long outs[PLPAR_HCALL9_BUFSIZE];\r\nhret = ehea_plpar_hcall9(H_MODIFY_HEA_QP,\r\nouts,\r\nadapter_handle,\r\n(u64) cat,\r\nqp_handle,\r\nsel_mask,\r\n__pa(cb_addr),\r\n0, 0, 0, 0);\r\n*inv_attr_id = outs[0];\r\n*out_swr = outs[3];\r\n*out_rwr = outs[4];\r\n*proc_mask = outs[5];\r\nreturn hret;\r\n}\r\nu64 ehea_h_register_rpage(const u64 adapter_handle, const u8 pagesize,\r\nconst u8 queue_type, const u64 resource_handle,\r\nconst u64 log_pageaddr, u64 count)\r\n{\r\nu64 reg_control;\r\nreg_control = EHEA_BMASK_SET(H_REG_RPAGE_PAGE_SIZE, pagesize)\r\n| EHEA_BMASK_SET(H_REG_RPAGE_QT, queue_type);\r\nreturn ehea_plpar_hcall_norets(H_REGISTER_HEA_RPAGES,\r\nadapter_handle,\r\nreg_control,\r\nresource_handle,\r\nlog_pageaddr,\r\ncount,\r\n0, 0);\r\n}\r\nu64 ehea_h_register_smr(const u64 adapter_handle, const u64 orig_mr_handle,\r\nconst u64 vaddr_in, const u32 access_ctrl, const u32 pd,\r\nstruct ehea_mr *mr)\r\n{\r\nu64 hret;\r\nunsigned long outs[PLPAR_HCALL9_BUFSIZE];\r\nhret = ehea_plpar_hcall9(H_REGISTER_SMR,\r\nouts,\r\nadapter_handle ,\r\norig_mr_handle,\r\nvaddr_in,\r\n(((u64)access_ctrl) << 32ULL),\r\npd,\r\n0, 0, 0, 0);\r\nmr->handle = outs[0];\r\nmr->lkey = (u32)outs[2];\r\nreturn hret;\r\n}\r\nu64 ehea_h_disable_and_get_hea(const u64 adapter_handle, const u64 qp_handle)\r\n{\r\nunsigned long outs[PLPAR_HCALL9_BUFSIZE];\r\nreturn ehea_plpar_hcall9(H_DISABLE_AND_GET_HEA,\r\nouts,\r\nadapter_handle,\r\nH_DISABLE_GET_EHEA_WQE_P,\r\nqp_handle,\r\n0, 0, 0, 0, 0, 0);\r\n}\r\nu64 ehea_h_free_resource(const u64 adapter_handle, const u64 res_handle,\r\nu64 force_bit)\r\n{\r\nreturn ehea_plpar_hcall_norets(H_FREE_RESOURCE,\r\nadapter_handle,\r\nres_handle,\r\nforce_bit,\r\n0, 0, 0, 0);\r\n}\r\nu64 ehea_h_alloc_resource_mr(const u64 adapter_handle, const u64 vaddr,\r\nconst u64 length, const u32 access_ctrl,\r\nconst u32 pd, u64 *mr_handle, u32 *lkey)\r\n{\r\nu64 hret;\r\nunsigned long outs[PLPAR_HCALL9_BUFSIZE];\r\nhret = ehea_plpar_hcall9(H_ALLOC_HEA_RESOURCE,\r\nouts,\r\nadapter_handle,\r\n5,\r\nvaddr,\r\nlength,\r\n(((u64) access_ctrl) << 32ULL),\r\npd,\r\n0, 0, 0);\r\n*mr_handle = outs[0];\r\n*lkey = (u32)outs[2];\r\nreturn hret;\r\n}\r\nu64 ehea_h_register_rpage_mr(const u64 adapter_handle, const u64 mr_handle,\r\nconst u8 pagesize, const u8 queue_type,\r\nconst u64 log_pageaddr, const u64 count)\r\n{\r\nif ((count > 1) && (log_pageaddr & ~PAGE_MASK)) {\r\npr_err("not on pageboundary\n");\r\nreturn H_PARAMETER;\r\n}\r\nreturn ehea_h_register_rpage(adapter_handle, pagesize,\r\nqueue_type, mr_handle,\r\nlog_pageaddr, count);\r\n}\r\nu64 ehea_h_query_ehea(const u64 adapter_handle, void *cb_addr)\r\n{\r\nu64 hret, cb_logaddr;\r\ncb_logaddr = __pa(cb_addr);\r\nhret = ehea_plpar_hcall_norets(H_QUERY_HEA,\r\nadapter_handle,\r\ncb_logaddr,\r\n0, 0, 0, 0, 0);\r\n#ifdef DEBUG\r\nehea_dump(cb_addr, sizeof(struct hcp_query_ehea), "hcp_query_ehea");\r\n#endif\r\nreturn hret;\r\n}\r\nu64 ehea_h_query_ehea_port(const u64 adapter_handle, const u16 port_num,\r\nconst u8 cb_cat, const u64 select_mask,\r\nvoid *cb_addr)\r\n{\r\nu64 port_info;\r\nu64 cb_logaddr = __pa(cb_addr);\r\nu64 arr_index = 0;\r\nport_info = EHEA_BMASK_SET(H_MEHEAPORT_CAT, cb_cat)\r\n| EHEA_BMASK_SET(H_MEHEAPORT_PN, port_num);\r\nreturn ehea_plpar_hcall_norets(H_QUERY_HEA_PORT,\r\nadapter_handle,\r\nport_info,\r\nselect_mask,\r\narr_index,\r\ncb_logaddr,\r\n0, 0);\r\n}\r\nu64 ehea_h_modify_ehea_port(const u64 adapter_handle, const u16 port_num,\r\nconst u8 cb_cat, const u64 select_mask,\r\nvoid *cb_addr)\r\n{\r\nunsigned long outs[PLPAR_HCALL9_BUFSIZE];\r\nu64 port_info;\r\nu64 arr_index = 0;\r\nu64 cb_logaddr = __pa(cb_addr);\r\nport_info = EHEA_BMASK_SET(H_MEHEAPORT_CAT, cb_cat)\r\n| EHEA_BMASK_SET(H_MEHEAPORT_PN, port_num);\r\n#ifdef DEBUG\r\nehea_dump(cb_addr, sizeof(struct hcp_ehea_port_cb0), "Before HCALL");\r\n#endif\r\nreturn ehea_plpar_hcall9(H_MODIFY_HEA_PORT,\r\nouts,\r\nadapter_handle,\r\nport_info,\r\nselect_mask,\r\narr_index,\r\ncb_logaddr,\r\n0, 0, 0, 0);\r\n}\r\nu64 ehea_h_reg_dereg_bcmc(const u64 adapter_handle, const u16 port_num,\r\nconst u8 reg_type, const u64 mc_mac_addr,\r\nconst u16 vlan_id, const u32 hcall_id)\r\n{\r\nu64 r5_port_num, r6_reg_type, r7_mc_mac_addr, r8_vlan_id;\r\nu64 mac_addr = mc_mac_addr >> 16;\r\nr5_port_num = EHEA_BMASK_SET(H_REGBCMC_PN, port_num);\r\nr6_reg_type = EHEA_BMASK_SET(H_REGBCMC_REGTYPE, reg_type);\r\nr7_mc_mac_addr = EHEA_BMASK_SET(H_REGBCMC_MACADDR, mac_addr);\r\nr8_vlan_id = EHEA_BMASK_SET(H_REGBCMC_VLANID, vlan_id);\r\nreturn ehea_plpar_hcall_norets(hcall_id,\r\nadapter_handle,\r\nr5_port_num,\r\nr6_reg_type,\r\nr7_mc_mac_addr,\r\nr8_vlan_id,\r\n0, 0);\r\n}\r\nu64 ehea_h_reset_events(const u64 adapter_handle, const u64 neq_handle,\r\nconst u64 event_mask)\r\n{\r\nreturn ehea_plpar_hcall_norets(H_RESET_EVENTS,\r\nadapter_handle,\r\nneq_handle,\r\nevent_mask,\r\n0, 0, 0, 0);\r\n}\r\nu64 ehea_h_error_data(const u64 adapter_handle, const u64 ressource_handle,\r\nvoid *rblock)\r\n{\r\nreturn ehea_plpar_hcall_norets(H_ERROR_DATA,\r\nadapter_handle,\r\nressource_handle,\r\n__pa(rblock),\r\n0, 0, 0, 0);\r\n}

static void symbol_int_callback(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nstruct symbol_private *priv = usb_get_serial_port_data(port);\r\nunsigned char *data = urb->transfer_buffer;\r\nint status = urb->status;\r\nint result;\r\nint data_length;\r\nswitch (status) {\r\ncase 0:\r\nbreak;\r\ncase -ECONNRESET:\r\ncase -ENOENT:\r\ncase -ESHUTDOWN:\r\ndev_dbg(&port->dev, "%s - urb shutting down with status: %d\n",\r\n__func__, status);\r\nreturn;\r\ndefault:\r\ndev_dbg(&port->dev, "%s - nonzero urb status received: %d\n",\r\n__func__, status);\r\ngoto exit;\r\n}\r\nusb_serial_debug_data(&port->dev, __func__, urb->actual_length, data);\r\nif (urb->actual_length > 1) {\r\ndata_length = data[0];\r\nif (data_length > (urb->actual_length - 1))\r\ndata_length = urb->actual_length - 1;\r\ntty_insert_flip_string(&port->port, &data[1], data_length);\r\ntty_flip_buffer_push(&port->port);\r\n} else {\r\ndev_dbg(&port->dev, "%s - short packet\n", __func__);\r\n}\r\nexit:\r\nspin_lock(&priv->lock);\r\nif (!priv->throttled) {\r\nresult = usb_submit_urb(port->interrupt_in_urb, GFP_ATOMIC);\r\nif (result)\r\ndev_err(&port->dev,\r\n"%s - failed resubmitting read urb, error %d\n",\r\n__func__, result);\r\n} else\r\npriv->actually_throttled = true;\r\nspin_unlock(&priv->lock);\r\n}\r\nstatic int symbol_open(struct tty_struct *tty, struct usb_serial_port *port)\r\n{\r\nstruct symbol_private *priv = usb_get_serial_port_data(port);\r\nunsigned long flags;\r\nint result = 0;\r\nspin_lock_irqsave(&priv->lock, flags);\r\npriv->throttled = false;\r\npriv->actually_throttled = false;\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nresult = usb_submit_urb(port->interrupt_in_urb, GFP_KERNEL);\r\nif (result)\r\ndev_err(&port->dev,\r\n"%s - failed resubmitting read urb, error %d\n",\r\n__func__, result);\r\nreturn result;\r\n}\r\nstatic void symbol_close(struct usb_serial_port *port)\r\n{\r\nusb_kill_urb(port->interrupt_in_urb);\r\n}\r\nstatic void symbol_throttle(struct tty_struct *tty)\r\n{\r\nstruct usb_serial_port *port = tty->driver_data;\r\nstruct symbol_private *priv = usb_get_serial_port_data(port);\r\nspin_lock_irq(&priv->lock);\r\npriv->throttled = true;\r\nspin_unlock_irq(&priv->lock);\r\n}\r\nstatic void symbol_unthrottle(struct tty_struct *tty)\r\n{\r\nstruct usb_serial_port *port = tty->driver_data;\r\nstruct symbol_private *priv = usb_get_serial_port_data(port);\r\nint result;\r\nbool was_throttled;\r\nspin_lock_irq(&priv->lock);\r\npriv->throttled = false;\r\nwas_throttled = priv->actually_throttled;\r\npriv->actually_throttled = false;\r\nspin_unlock_irq(&priv->lock);\r\nif (was_throttled) {\r\nresult = usb_submit_urb(port->interrupt_in_urb, GFP_KERNEL);\r\nif (result)\r\ndev_err(&port->dev,\r\n"%s - failed submitting read urb, error %d\n",\r\n__func__, result);\r\n}\r\n}\r\nstatic int symbol_startup(struct usb_serial *serial)\r\n{\r\nif (!serial->num_interrupt_in) {\r\ndev_err(&serial->dev->dev, "no interrupt-in endpoint\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int symbol_port_probe(struct usb_serial_port *port)\r\n{\r\nstruct symbol_private *priv;\r\npriv = kzalloc(sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nspin_lock_init(&priv->lock);\r\nusb_set_serial_port_data(port, priv);\r\nreturn 0;\r\n}\r\nstatic int symbol_port_remove(struct usb_serial_port *port)\r\n{\r\nstruct symbol_private *priv = usb_get_serial_port_data(port);\r\nkfree(priv);\r\nreturn 0;\r\n}

static void fcrypt_encrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\nconst struct fcrypt_ctx *ctx = crypto_tfm_ctx(tfm);\r\nstruct {\r\n__be32 l, r;\r\n} X;\r\nmemcpy(&X, src, sizeof(X));\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0x0]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0x1]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0x2]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0x3]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0x4]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0x5]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0x6]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0x7]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0x8]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0x9]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0xa]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0xb]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0xc]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0xd]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0xe]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0xf]);\r\nmemcpy(dst, &X, sizeof(X));\r\n}\r\nstatic void fcrypt_decrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\nconst struct fcrypt_ctx *ctx = crypto_tfm_ctx(tfm);\r\nstruct {\r\n__be32 l, r;\r\n} X;\r\nmemcpy(&X, src, sizeof(X));\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0xf]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0xe]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0xd]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0xc]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0xb]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0xa]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0x9]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0x8]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0x7]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0x6]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0x5]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0x4]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0x3]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0x2]);\r\nF_ENCRYPT(X.l, X.r, ctx->sched[0x1]);\r\nF_ENCRYPT(X.r, X.l, ctx->sched[0x0]);\r\nmemcpy(dst, &X, sizeof(X));\r\n}\r\nstatic int fcrypt_setkey(struct crypto_tfm *tfm, const u8 *key, unsigned int keylen)\r\n{\r\nstruct fcrypt_ctx *ctx = crypto_tfm_ctx(tfm);\r\n#if BITS_PER_LONG == 64\r\nu64 k;\r\nk = (*key++) >> 1;\r\nk <<= 7;\r\nk |= (*key++) >> 1;\r\nk <<= 7;\r\nk |= (*key++) >> 1;\r\nk <<= 7;\r\nk |= (*key++) >> 1;\r\nk <<= 7;\r\nk |= (*key++) >> 1;\r\nk <<= 7;\r\nk |= (*key++) >> 1;\r\nk <<= 7;\r\nk |= (*key++) >> 1;\r\nk <<= 7;\r\nk |= (*key) >> 1;\r\nctx->sched[0x0] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0x1] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0x2] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0x3] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0x4] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0x5] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0x6] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0x7] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0x8] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0x9] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0xa] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0xb] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0xc] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0xd] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0xe] = cpu_to_be32(k); ror56_64(k, 11);\r\nctx->sched[0xf] = cpu_to_be32(k);\r\nreturn 0;\r\n#else\r\nu32 hi, lo;\r\nlo = (*key++) >> 1;\r\nlo <<= 7;\r\nlo |= (*key++) >> 1;\r\nlo <<= 7;\r\nlo |= (*key++) >> 1;\r\nlo <<= 7;\r\nlo |= (*key++) >> 1;\r\nhi = lo >> 4;\r\nlo &= 0xf;\r\nlo <<= 7;\r\nlo |= (*key++) >> 1;\r\nlo <<= 7;\r\nlo |= (*key++) >> 1;\r\nlo <<= 7;\r\nlo |= (*key++) >> 1;\r\nlo <<= 7;\r\nlo |= (*key) >> 1;\r\nctx->sched[0x0] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0x1] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0x2] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0x3] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0x4] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0x5] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0x6] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0x7] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0x8] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0x9] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0xa] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0xb] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0xc] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0xd] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0xe] = cpu_to_be32(lo); ror56(hi, lo, 11);\r\nctx->sched[0xf] = cpu_to_be32(lo);\r\nreturn 0;\r\n#endif\r\n}\r\nstatic int __init fcrypt_mod_init(void)\r\n{\r\nreturn crypto_register_alg(&fcrypt_alg);\r\n}\r\nstatic void __exit fcrypt_mod_fini(void)\r\n{\r\ncrypto_unregister_alg(&fcrypt_alg);\r\n}

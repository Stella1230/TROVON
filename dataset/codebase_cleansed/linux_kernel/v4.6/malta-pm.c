int mips_pm_suspend(unsigned state)\r\n{\r\nint spec_devid;\r\nu16 sts;\r\nif (!pm_pci_bus || !pm_io_offset)\r\nreturn -ENODEV;\r\nwhile (1) {\r\nsts = inw(pm_io_offset + PIIX4_FUNC3IO_PMSTS);\r\nif (!(sts & PIIX4_FUNC3IO_PMSTS_PWRBTN_STS))\r\nbreak;\r\noutw(sts, pm_io_offset + PIIX4_FUNC3IO_PMSTS);\r\n}\r\noutw(state | PIIX4_FUNC3IO_PMCNTRL_SUS_EN,\r\npm_io_offset + PIIX4_FUNC3IO_PMCNTRL);\r\nmdelay(10);\r\nspec_devid = PCI_DEVID(0, PCI_DEVFN(0x1f, 0x7));\r\npci_bus_write_config_dword(pm_pci_bus, spec_devid, 0,\r\nPIIX4_SUSPEND_MAGIC);\r\nmdelay(1000);\r\nreturn 0;\r\n}\r\nstatic int __init malta_pm_setup(void)\r\n{\r\nstruct pci_dev *dev;\r\nint res, io_region = PCI_BRIDGE_RESOURCES;\r\npm_pci_bus = pci_find_next_bus(NULL);\r\nif (!pm_pci_bus) {\r\npr_warn("malta-pm: failed to find reference to PCI bus\n");\r\nreturn -ENODEV;\r\n}\r\ndev = pci_get_subsys(PCI_VENDOR_ID_INTEL,\r\nPCI_DEVICE_ID_INTEL_82371AB_3, PCI_ANY_ID,\r\nPCI_ANY_ID, NULL);\r\nif (!dev) {\r\npr_warn("malta-pm: failed to find PIIX4 PM\n");\r\nreturn -ENODEV;\r\n}\r\nres = pci_request_region(dev, io_region, "PIIX4 PM IO registers");\r\nif (res) {\r\npr_warn("malta-pm: failed to request PM IO registers (%d)\n",\r\nres);\r\npci_dev_put(dev);\r\nreturn -ENODEV;\r\n}\r\npm_io_offset = pci_resource_start(dev, io_region);\r\npci_dev_put(dev);\r\nreturn 0;\r\n}

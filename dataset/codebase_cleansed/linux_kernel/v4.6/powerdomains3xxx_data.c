static int ti81xx_pwrdm_set_next_pwrst(struct powerdomain *pwrdm, u8 pwrst)\r\n{\r\nomap2_prm_rmw_mod_reg_bits(OMAP_POWERSTATE_MASK,\r\n(pwrst << OMAP_POWERSTATE_SHIFT),\r\npwrdm->prcm_offs, TI81XX_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic int ti81xx_pwrdm_read_next_pwrst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nTI81XX_PM_PWSTCTRL,\r\nOMAP_POWERSTATE_MASK);\r\n}\r\nstatic int ti81xx_pwrdm_read_pwrst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\n(pwrdm->prcm_offs == TI814X_PRM_GFX_MOD) ? TI81XX_RM_RSTCTRL :\r\nTI81XX_PM_PWSTST,\r\nOMAP_POWERSTATEST_MASK);\r\n}\r\nstatic int ti81xx_pwrdm_read_logic_pwrst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\n(pwrdm->prcm_offs == TI814X_PRM_GFX_MOD) ? TI81XX_RM_RSTCTRL :\r\nTI81XX_PM_PWSTST,\r\nOMAP3430_LOGICSTATEST_MASK);\r\n}\r\nstatic int ti81xx_pwrdm_wait_transition(struct powerdomain *pwrdm)\r\n{\r\nu32 c = 0;\r\nwhile ((omap2_prm_read_mod_reg(pwrdm->prcm_offs,\r\n(pwrdm->prcm_offs == TI814X_PRM_GFX_MOD) ? TI81XX_RM_RSTCTRL :\r\nTI81XX_PM_PWSTST) &\r\nOMAP_INTRANSITION_MASK) &&\r\n(c++ < PWRDM_TRANSITION_BAILOUT))\r\nudelay(1);\r\nif (c > PWRDM_TRANSITION_BAILOUT) {\r\npr_err("powerdomain: %s timeout waiting for transition\n",\r\npwrdm->name);\r\nreturn -EAGAIN;\r\n}\r\npr_debug("powerdomain: completed transition in %d loops\n", c);\r\nreturn 0;\r\n}\r\nvoid __init omap3xxx_powerdomains_init(void)\r\n{\r\nunsigned int rev;\r\nif (!cpu_is_omap34xx() && !cpu_is_ti81xx())\r\nreturn;\r\nif (!cpu_is_ti81xx())\r\npwrdm_register_platform_funcs(&omap3_pwrdm_operations);\r\nrev = omap_rev();\r\nif (rev == AM35XX_REV_ES1_0 || rev == AM35XX_REV_ES1_1) {\r\npwrdm_register_pwrdms(powerdomains_am35x);\r\n} else if (rev == TI8148_REV_ES1_0 || rev == TI8148_REV_ES2_0 ||\r\nrev == TI8148_REV_ES2_1) {\r\npwrdm_register_platform_funcs(&ti81xx_pwrdm_operations);\r\npwrdm_register_pwrdms(powerdomains_ti814x);\r\n} else if (rev == TI8168_REV_ES1_0 || rev == TI8168_REV_ES1_1\r\n|| rev == TI8168_REV_ES2_0 || rev == TI8168_REV_ES2_1) {\r\npwrdm_register_platform_funcs(&ti81xx_pwrdm_operations);\r\npwrdm_register_pwrdms(powerdomains_ti816x);\r\n} else {\r\npwrdm_register_pwrdms(powerdomains_omap3430_common);\r\nswitch (rev) {\r\ncase OMAP3430_REV_ES1_0:\r\npwrdm_register_pwrdms(powerdomains_omap3430es1);\r\nbreak;\r\ncase OMAP3430_REV_ES2_0:\r\ncase OMAP3430_REV_ES2_1:\r\ncase OMAP3430_REV_ES3_0:\r\ncase OMAP3630_REV_ES1_0:\r\npwrdm_register_pwrdms(powerdomains_omap3430es2_es3_0);\r\nbreak;\r\ncase OMAP3430_REV_ES3_1:\r\ncase OMAP3430_REV_ES3_1_2:\r\ncase OMAP3630_REV_ES1_1:\r\ncase OMAP3630_REV_ES1_2:\r\npwrdm_register_pwrdms(powerdomains_omap3430es3_1plus);\r\nbreak;\r\ndefault:\r\nWARN(1, "OMAP3 powerdomain init: unknown chip type\n");\r\n}\r\n}\r\npwrdm_complete_init();\r\n}

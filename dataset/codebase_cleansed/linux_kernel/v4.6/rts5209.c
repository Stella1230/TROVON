static u8 rts5209_get_ic_version(struct rtsx_pcr *pcr)\r\n{\r\nu8 val;\r\nval = rtsx_pci_readb(pcr, 0x1C);\r\nreturn val & 0x0F;\r\n}\r\nstatic void rts5209_fetch_vendor_settings(struct rtsx_pcr *pcr)\r\n{\r\nu32 reg;\r\nrtsx_pci_read_config_dword(pcr, PCR_SETTING_REG1, &reg);\r\npcr_dbg(pcr, "Cfg 0x%x: 0x%x\n", PCR_SETTING_REG1, reg);\r\nif (rts5209_vendor_setting1_valid(reg)) {\r\nif (rts5209_reg_check_ms_pmos(reg))\r\npcr->flags |= PCR_MS_PMOS;\r\npcr->aspm_en = rts5209_reg_to_aspm(reg);\r\n}\r\nrtsx_pci_read_config_dword(pcr, PCR_SETTING_REG2, &reg);\r\npcr_dbg(pcr, "Cfg 0x%x: 0x%x\n", PCR_SETTING_REG2, reg);\r\nif (rts5209_vendor_setting2_valid(reg)) {\r\npcr->sd30_drive_sel_1v8 =\r\nrts5209_reg_to_sd30_drive_sel_1v8(reg);\r\npcr->sd30_drive_sel_3v3 =\r\nrts5209_reg_to_sd30_drive_sel_3v3(reg);\r\npcr->card_drive_sel = rts5209_reg_to_card_drive_sel(reg);\r\n}\r\n}\r\nstatic void rts5209_force_power_down(struct rtsx_pcr *pcr, u8 pm_state)\r\n{\r\nrtsx_pci_write_register(pcr, FPDCTL, 0x07, 0x07);\r\n}\r\nstatic int rts5209_extra_init_hw(struct rtsx_pcr *pcr)\r\n{\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_GPIO, 0xFF, 0x03);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, ASPM_FORCE_CTL, 0x3F, 0);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PETXCFG, 0x08, 0x08);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_GPIO_DIR, 0xFF, 0x03);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_DRIVE_SEL,\r\n0xFF, pcr->sd30_drive_sel_3v3);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nstatic int rts5209_optimize_phy(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_phy_register(pcr, 0x00, 0xB966);\r\n}\r\nstatic int rts5209_turn_on_led(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, CARD_GPIO, 0x01, 0x00);\r\n}\r\nstatic int rts5209_turn_off_led(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, CARD_GPIO, 0x01, 0x01);\r\n}\r\nstatic int rts5209_enable_auto_blink(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, CARD_AUTO_BLINK, 0xFF, 0x0D);\r\n}\r\nstatic int rts5209_disable_auto_blink(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, CARD_AUTO_BLINK, 0x08, 0x00);\r\n}\r\nstatic int rts5209_card_power_on(struct rtsx_pcr *pcr, int card)\r\n{\r\nint err;\r\nu8 pwr_mask, partial_pwr_on, pwr_on;\r\npwr_mask = SD_POWER_MASK;\r\npartial_pwr_on = SD_PARTIAL_POWER_ON;\r\npwr_on = SD_POWER_ON;\r\nif ((pcr->flags & PCR_MS_PMOS) && (card == RTSX_MS_CARD)) {\r\npwr_mask = MS_POWER_MASK;\r\npartial_pwr_on = MS_PARTIAL_POWER_ON;\r\npwr_on = MS_POWER_ON;\r\n}\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\r\npwr_mask, partial_pwr_on);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\r\nLDO3318_PWR_MASK, 0x04);\r\nerr = rtsx_pci_send_cmd(pcr, 100);\r\nif (err < 0)\r\nreturn err;\r\nudelay(150);\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL, pwr_mask, pwr_on);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\r\nLDO3318_PWR_MASK, 0x00);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nstatic int rts5209_card_power_off(struct rtsx_pcr *pcr, int card)\r\n{\r\nu8 pwr_mask, pwr_off;\r\npwr_mask = SD_POWER_MASK;\r\npwr_off = SD_POWER_OFF;\r\nif ((pcr->flags & PCR_MS_PMOS) && (card == RTSX_MS_CARD)) {\r\npwr_mask = MS_POWER_MASK;\r\npwr_off = MS_POWER_OFF;\r\n}\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\r\npwr_mask | PMOS_STRG_MASK, pwr_off | PMOS_STRG_400mA);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\r\nLDO3318_PWR_MASK, 0x06);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nstatic int rts5209_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\r\n{\r\nint err;\r\nif (voltage == OUTPUT_3V3) {\r\nerr = rtsx_pci_write_register(pcr,\r\nSD30_DRIVE_SEL, 0x07, pcr->sd30_drive_sel_3v3);\r\nif (err < 0)\r\nreturn err;\r\nerr = rtsx_pci_write_phy_register(pcr, 0x08, 0x4FC0 | 0x24);\r\nif (err < 0)\r\nreturn err;\r\n} else if (voltage == OUTPUT_1V8) {\r\nerr = rtsx_pci_write_register(pcr,\r\nSD30_DRIVE_SEL, 0x07, pcr->sd30_drive_sel_1v8);\r\nif (err < 0)\r\nreturn err;\r\nerr = rtsx_pci_write_phy_register(pcr, 0x08, 0x4C40 | 0x24);\r\nif (err < 0)\r\nreturn err;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nvoid rts5209_init_params(struct rtsx_pcr *pcr)\r\n{\r\npcr->extra_caps = EXTRA_CAPS_SD_SDR50 |\r\nEXTRA_CAPS_SD_SDR104 | EXTRA_CAPS_MMC_8BIT;\r\npcr->num_slots = 2;\r\npcr->ops = &rts5209_pcr_ops;\r\npcr->flags = 0;\r\npcr->card_drive_sel = RTS5209_CARD_DRIVE_DEFAULT;\r\npcr->sd30_drive_sel_1v8 = DRIVER_TYPE_B;\r\npcr->sd30_drive_sel_3v3 = DRIVER_TYPE_D;\r\npcr->aspm_en = ASPM_L1_EN;\r\npcr->tx_initial_phase = SET_CLOCK_PHASE(27, 27, 16);\r\npcr->rx_initial_phase = SET_CLOCK_PHASE(24, 6, 5);\r\npcr->ic_version = rts5209_get_ic_version(pcr);\r\npcr->sd_pull_ctl_enable_tbl = rts5209_sd_pull_ctl_enable_tbl;\r\npcr->sd_pull_ctl_disable_tbl = rts5209_sd_pull_ctl_disable_tbl;\r\npcr->ms_pull_ctl_enable_tbl = rts5209_ms_pull_ctl_enable_tbl;\r\npcr->ms_pull_ctl_disable_tbl = rts5209_ms_pull_ctl_disable_tbl;\r\n}

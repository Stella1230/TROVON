void jfs_set_inode_flags(struct inode *inode)\r\n{\r\nunsigned int flags = JFS_IP(inode)->mode2;\r\nunsigned int new_fl = 0;\r\nif (flags & JFS_IMMUTABLE_FL)\r\nnew_fl |= S_IMMUTABLE;\r\nif (flags & JFS_APPEND_FL)\r\nnew_fl |= S_APPEND;\r\nif (flags & JFS_NOATIME_FL)\r\nnew_fl |= S_NOATIME;\r\nif (flags & JFS_DIRSYNC_FL)\r\nnew_fl |= S_DIRSYNC;\r\nif (flags & JFS_SYNC_FL)\r\nnew_fl |= S_SYNC;\r\ninode_set_flags(inode, new_fl, S_IMMUTABLE | S_APPEND | S_NOATIME |\r\nS_DIRSYNC | S_SYNC);\r\n}\r\nvoid jfs_get_inode_flags(struct jfs_inode_info *jfs_ip)\r\n{\r\nunsigned int flags = jfs_ip->vfs_inode.i_flags;\r\njfs_ip->mode2 &= ~(JFS_IMMUTABLE_FL | JFS_APPEND_FL | JFS_NOATIME_FL |\r\nJFS_DIRSYNC_FL | JFS_SYNC_FL);\r\nif (flags & S_IMMUTABLE)\r\njfs_ip->mode2 |= JFS_IMMUTABLE_FL;\r\nif (flags & S_APPEND)\r\njfs_ip->mode2 |= JFS_APPEND_FL;\r\nif (flags & S_NOATIME)\r\njfs_ip->mode2 |= JFS_NOATIME_FL;\r\nif (flags & S_DIRSYNC)\r\njfs_ip->mode2 |= JFS_DIRSYNC_FL;\r\nif (flags & S_SYNC)\r\njfs_ip->mode2 |= JFS_SYNC_FL;\r\n}\r\nstruct inode *ialloc(struct inode *parent, umode_t mode)\r\n{\r\nstruct super_block *sb = parent->i_sb;\r\nstruct inode *inode;\r\nstruct jfs_inode_info *jfs_inode;\r\nint rc;\r\ninode = new_inode(sb);\r\nif (!inode) {\r\njfs_warn("ialloc: new_inode returned NULL!");\r\nrc = -ENOMEM;\r\ngoto fail;\r\n}\r\njfs_inode = JFS_IP(inode);\r\nrc = diAlloc(parent, S_ISDIR(mode), inode);\r\nif (rc) {\r\njfs_warn("ialloc: diAlloc returned %d!", rc);\r\nif (rc == -EIO)\r\nmake_bad_inode(inode);\r\ngoto fail_put;\r\n}\r\nif (insert_inode_locked(inode) < 0) {\r\nrc = -EINVAL;\r\ngoto fail_put;\r\n}\r\ninode_init_owner(inode, parent, mode);\r\njfs_inode->saved_uid = inode->i_uid;\r\njfs_inode->saved_gid = inode->i_gid;\r\nrc = dquot_initialize(inode);\r\nif (rc)\r\ngoto fail_drop;\r\nrc = dquot_alloc_inode(inode);\r\nif (rc)\r\ngoto fail_drop;\r\njfs_inode->mode2 = JFS_IP(parent)->mode2 & JFS_FL_INHERIT;\r\nif (S_ISDIR(mode)) {\r\njfs_inode->mode2 |= IDIRECTORY;\r\njfs_inode->mode2 &= ~JFS_DIRSYNC_FL;\r\n}\r\nelse {\r\njfs_inode->mode2 |= INLINEEA | ISPARSE;\r\nif (S_ISLNK(mode))\r\njfs_inode->mode2 &= ~(JFS_IMMUTABLE_FL|JFS_APPEND_FL);\r\n}\r\njfs_inode->mode2 |= inode->i_mode;\r\ninode->i_blocks = 0;\r\ninode->i_mtime = inode->i_atime = inode->i_ctime = CURRENT_TIME;\r\njfs_inode->otime = inode->i_ctime.tv_sec;\r\ninode->i_generation = JFS_SBI(sb)->gengen++;\r\njfs_inode->cflag = 0;\r\nmemset(&jfs_inode->acl, 0, sizeof(dxd_t));\r\nmemset(&jfs_inode->ea, 0, sizeof(dxd_t));\r\njfs_inode->next_index = 0;\r\njfs_inode->acltype = 0;\r\njfs_inode->btorder = 0;\r\njfs_inode->btindex = 0;\r\njfs_inode->bxflag = 0;\r\njfs_inode->blid = 0;\r\njfs_inode->atlhead = 0;\r\njfs_inode->atltail = 0;\r\njfs_inode->xtlid = 0;\r\njfs_set_inode_flags(inode);\r\njfs_info("ialloc returns inode = 0x%p\n", inode);\r\nreturn inode;\r\nfail_drop:\r\ndquot_drop(inode);\r\ninode->i_flags |= S_NOQUOTA;\r\nclear_nlink(inode);\r\nunlock_new_inode(inode);\r\nfail_put:\r\niput(inode);\r\nfail:\r\nreturn ERR_PTR(rc);\r\n}

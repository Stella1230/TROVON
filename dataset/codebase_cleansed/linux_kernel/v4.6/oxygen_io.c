u8 oxygen_read8(struct oxygen *chip, unsigned int reg)\r\n{\r\nreturn inb(chip->addr + reg);\r\n}\r\nu16 oxygen_read16(struct oxygen *chip, unsigned int reg)\r\n{\r\nreturn inw(chip->addr + reg);\r\n}\r\nu32 oxygen_read32(struct oxygen *chip, unsigned int reg)\r\n{\r\nreturn inl(chip->addr + reg);\r\n}\r\nvoid oxygen_write8(struct oxygen *chip, unsigned int reg, u8 value)\r\n{\r\noutb(value, chip->addr + reg);\r\nchip->saved_registers._8[reg] = value;\r\n}\r\nvoid oxygen_write16(struct oxygen *chip, unsigned int reg, u16 value)\r\n{\r\noutw(value, chip->addr + reg);\r\nchip->saved_registers._16[reg / 2] = cpu_to_le16(value);\r\n}\r\nvoid oxygen_write32(struct oxygen *chip, unsigned int reg, u32 value)\r\n{\r\noutl(value, chip->addr + reg);\r\nchip->saved_registers._32[reg / 4] = cpu_to_le32(value);\r\n}\r\nvoid oxygen_write8_masked(struct oxygen *chip, unsigned int reg,\r\nu8 value, u8 mask)\r\n{\r\nu8 tmp = inb(chip->addr + reg);\r\ntmp &= ~mask;\r\ntmp |= value & mask;\r\noutb(tmp, chip->addr + reg);\r\nchip->saved_registers._8[reg] = tmp;\r\n}\r\nvoid oxygen_write16_masked(struct oxygen *chip, unsigned int reg,\r\nu16 value, u16 mask)\r\n{\r\nu16 tmp = inw(chip->addr + reg);\r\ntmp &= ~mask;\r\ntmp |= value & mask;\r\noutw(tmp, chip->addr + reg);\r\nchip->saved_registers._16[reg / 2] = cpu_to_le16(tmp);\r\n}\r\nvoid oxygen_write32_masked(struct oxygen *chip, unsigned int reg,\r\nu32 value, u32 mask)\r\n{\r\nu32 tmp = inl(chip->addr + reg);\r\ntmp &= ~mask;\r\ntmp |= value & mask;\r\noutl(tmp, chip->addr + reg);\r\nchip->saved_registers._32[reg / 4] = cpu_to_le32(tmp);\r\n}\r\nstatic int oxygen_ac97_wait(struct oxygen *chip, unsigned int mask)\r\n{\r\nu8 status = 0;\r\nwait_event_timeout(chip->ac97_waitqueue,\r\n({ status |= oxygen_read8(chip, OXYGEN_AC97_INTERRUPT_STATUS);\r\nstatus & mask; }),\r\nmsecs_to_jiffies(1) + 1);\r\nstatus |= oxygen_read8(chip, OXYGEN_AC97_INTERRUPT_STATUS);\r\nreturn status & mask ? 0 : -EIO;\r\n}\r\nvoid oxygen_write_ac97(struct oxygen *chip, unsigned int codec,\r\nunsigned int index, u16 data)\r\n{\r\nunsigned int count, succeeded;\r\nu32 reg;\r\nreg = data;\r\nreg |= index << OXYGEN_AC97_REG_ADDR_SHIFT;\r\nreg |= OXYGEN_AC97_REG_DIR_WRITE;\r\nreg |= codec << OXYGEN_AC97_REG_CODEC_SHIFT;\r\nsucceeded = 0;\r\nfor (count = 5; count > 0; --count) {\r\nudelay(5);\r\noxygen_write32(chip, OXYGEN_AC97_REGS, reg);\r\nif (oxygen_ac97_wait(chip, OXYGEN_AC97_INT_WRITE_DONE) >= 0 &&\r\n++succeeded >= 2) {\r\nchip->saved_ac97_registers[codec][index / 2] = data;\r\nreturn;\r\n}\r\n}\r\ndev_err(chip->card->dev, "AC'97 write timeout\n");\r\n}\r\nu16 oxygen_read_ac97(struct oxygen *chip, unsigned int codec,\r\nunsigned int index)\r\n{\r\nunsigned int count;\r\nunsigned int last_read = UINT_MAX;\r\nu32 reg;\r\nreg = index << OXYGEN_AC97_REG_ADDR_SHIFT;\r\nreg |= OXYGEN_AC97_REG_DIR_READ;\r\nreg |= codec << OXYGEN_AC97_REG_CODEC_SHIFT;\r\nfor (count = 5; count > 0; --count) {\r\nudelay(5);\r\noxygen_write32(chip, OXYGEN_AC97_REGS, reg);\r\nudelay(10);\r\nif (oxygen_ac97_wait(chip, OXYGEN_AC97_INT_READ_DONE) >= 0) {\r\nu16 value = oxygen_read16(chip, OXYGEN_AC97_REGS);\r\nif (value == last_read)\r\nreturn value;\r\nlast_read = value;\r\nreg ^= 0xffff;\r\n}\r\n}\r\ndev_err(chip->card->dev, "AC'97 read timeout on codec %u\n", codec);\r\nreturn 0;\r\n}\r\nvoid oxygen_write_ac97_masked(struct oxygen *chip, unsigned int codec,\r\nunsigned int index, u16 data, u16 mask)\r\n{\r\nu16 value = oxygen_read_ac97(chip, codec, index);\r\nvalue &= ~mask;\r\nvalue |= data & mask;\r\noxygen_write_ac97(chip, codec, index, value);\r\n}\r\nstatic int oxygen_wait_spi(struct oxygen *chip)\r\n{\r\nunsigned int count;\r\nfor (count = 50; count > 0; count--) {\r\nudelay(4);\r\nif ((oxygen_read8(chip, OXYGEN_SPI_CONTROL) &\r\nOXYGEN_SPI_BUSY) == 0)\r\nreturn 0;\r\n}\r\ndev_err(chip->card->dev, "oxygen: SPI wait timeout\n");\r\nreturn -EIO;\r\n}\r\nint oxygen_write_spi(struct oxygen *chip, u8 control, unsigned int data)\r\n{\r\noxygen_write8(chip, OXYGEN_SPI_DATA1, data);\r\noxygen_write8(chip, OXYGEN_SPI_DATA2, data >> 8);\r\nif (control & OXYGEN_SPI_DATA_LENGTH_3)\r\noxygen_write8(chip, OXYGEN_SPI_DATA3, data >> 16);\r\noxygen_write8(chip, OXYGEN_SPI_CONTROL, control);\r\nreturn oxygen_wait_spi(chip);\r\n}\r\nvoid oxygen_write_i2c(struct oxygen *chip, u8 device, u8 map, u8 data)\r\n{\r\nmsleep(1);\r\noxygen_write8(chip, OXYGEN_2WIRE_MAP, map);\r\noxygen_write8(chip, OXYGEN_2WIRE_DATA, data);\r\noxygen_write8(chip, OXYGEN_2WIRE_CONTROL,\r\ndevice | OXYGEN_2WIRE_DIR_WRITE);\r\n}\r\nstatic void _write_uart(struct oxygen *chip, unsigned int port, u8 data)\r\n{\r\nif (oxygen_read8(chip, OXYGEN_MPU401 + 1) & MPU401_TX_FULL)\r\nmsleep(1);\r\noxygen_write8(chip, OXYGEN_MPU401 + port, data);\r\n}\r\nvoid oxygen_reset_uart(struct oxygen *chip)\r\n{\r\n_write_uart(chip, 1, MPU401_RESET);\r\nmsleep(1);\r\n_write_uart(chip, 1, MPU401_ENTER_UART);\r\n}\r\nvoid oxygen_write_uart(struct oxygen *chip, u8 data)\r\n{\r\n_write_uart(chip, 0, data);\r\n}\r\nu16 oxygen_read_eeprom(struct oxygen *chip, unsigned int index)\r\n{\r\nunsigned int timeout;\r\noxygen_write8(chip, OXYGEN_EEPROM_CONTROL,\r\nindex | OXYGEN_EEPROM_DIR_READ);\r\nfor (timeout = 0; timeout < 100; ++timeout) {\r\nudelay(1);\r\nif (!(oxygen_read8(chip, OXYGEN_EEPROM_STATUS)\r\n& OXYGEN_EEPROM_BUSY))\r\nbreak;\r\n}\r\nreturn oxygen_read16(chip, OXYGEN_EEPROM_DATA);\r\n}\r\nvoid oxygen_write_eeprom(struct oxygen *chip, unsigned int index, u16 value)\r\n{\r\nunsigned int timeout;\r\noxygen_write16(chip, OXYGEN_EEPROM_DATA, value);\r\noxygen_write8(chip, OXYGEN_EEPROM_CONTROL,\r\nindex | OXYGEN_EEPROM_DIR_WRITE);\r\nfor (timeout = 0; timeout < 10; ++timeout) {\r\nmsleep(1);\r\nif (!(oxygen_read8(chip, OXYGEN_EEPROM_STATUS)\r\n& OXYGEN_EEPROM_BUSY))\r\nreturn;\r\n}\r\ndev_err(chip->card->dev, "EEPROM write timeout\n");\r\n}

static struct ssd1307fb_array *ssd1307fb_alloc_array(u32 len, u8 type)\r\n{\r\nstruct ssd1307fb_array *array;\r\narray = kzalloc(sizeof(struct ssd1307fb_array) + len, GFP_KERNEL);\r\nif (!array)\r\nreturn NULL;\r\narray->type = type;\r\nreturn array;\r\n}\r\nstatic int ssd1307fb_write_array(struct i2c_client *client,\r\nstruct ssd1307fb_array *array, u32 len)\r\n{\r\nint ret;\r\nlen += sizeof(struct ssd1307fb_array);\r\nret = i2c_master_send(client, (u8 *)array, len);\r\nif (ret != len) {\r\ndev_err(&client->dev, "Couldn't send I2C command.\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int ssd1307fb_write_cmd(struct i2c_client *client, u8 cmd)\r\n{\r\nstruct ssd1307fb_array *array;\r\nint ret;\r\narray = ssd1307fb_alloc_array(1, SSD1307FB_COMMAND);\r\nif (!array)\r\nreturn -ENOMEM;\r\narray->data[0] = cmd;\r\nret = ssd1307fb_write_array(client, array, 1);\r\nkfree(array);\r\nreturn ret;\r\n}\r\nstatic void ssd1307fb_update_display(struct ssd1307fb_par *par)\r\n{\r\nstruct ssd1307fb_array *array;\r\nu8 *vmem = par->info->screen_base;\r\nint i, j, k;\r\narray = ssd1307fb_alloc_array(par->width * par->height / 8,\r\nSSD1307FB_DATA);\r\nif (!array)\r\nreturn;\r\nfor (i = 0; i < (par->height / 8); i++) {\r\nfor (j = 0; j < par->width; j++) {\r\nu32 array_idx = i * par->width + j;\r\narray->data[array_idx] = 0;\r\nfor (k = 0; k < 8; k++) {\r\nu32 page_length = par->width * i;\r\nu32 index = page_length + (par->width * k + j) / 8;\r\nu8 byte = *(vmem + index);\r\nu8 bit = byte & (1 << (j % 8));\r\nbit = bit >> (j % 8);\r\narray->data[array_idx] |= bit << k;\r\n}\r\n}\r\n}\r\nssd1307fb_write_array(par->client, array, par->width * par->height / 8);\r\nkfree(array);\r\n}\r\nstatic ssize_t ssd1307fb_write(struct fb_info *info, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ssd1307fb_par *par = info->par;\r\nunsigned long total_size;\r\nunsigned long p = *ppos;\r\nu8 __iomem *dst;\r\ntotal_size = info->fix.smem_len;\r\nif (p > total_size)\r\nreturn -EINVAL;\r\nif (count + p > total_size)\r\ncount = total_size - p;\r\nif (!count)\r\nreturn -EINVAL;\r\ndst = (void __force *) (info->screen_base + p);\r\nif (copy_from_user(dst, buf, count))\r\nreturn -EFAULT;\r\nssd1307fb_update_display(par);\r\n*ppos += count;\r\nreturn count;\r\n}\r\nstatic int ssd1307fb_blank(int blank_mode, struct fb_info *info)\r\n{\r\nstruct ssd1307fb_par *par = info->par;\r\nif (blank_mode != FB_BLANK_UNBLANK)\r\nreturn ssd1307fb_write_cmd(par->client, SSD1307FB_DISPLAY_OFF);\r\nelse\r\nreturn ssd1307fb_write_cmd(par->client, SSD1307FB_DISPLAY_ON);\r\n}\r\nstatic void ssd1307fb_fillrect(struct fb_info *info, const struct fb_fillrect *rect)\r\n{\r\nstruct ssd1307fb_par *par = info->par;\r\nsys_fillrect(info, rect);\r\nssd1307fb_update_display(par);\r\n}\r\nstatic void ssd1307fb_copyarea(struct fb_info *info, const struct fb_copyarea *area)\r\n{\r\nstruct ssd1307fb_par *par = info->par;\r\nsys_copyarea(info, area);\r\nssd1307fb_update_display(par);\r\n}\r\nstatic void ssd1307fb_imageblit(struct fb_info *info, const struct fb_image *image)\r\n{\r\nstruct ssd1307fb_par *par = info->par;\r\nsys_imageblit(info, image);\r\nssd1307fb_update_display(par);\r\n}\r\nstatic void ssd1307fb_deferred_io(struct fb_info *info,\r\nstruct list_head *pagelist)\r\n{\r\nssd1307fb_update_display(info->par);\r\n}\r\nstatic int ssd1307fb_init(struct ssd1307fb_par *par)\r\n{\r\nint ret;\r\nu32 precharge, dclk, com_invdir, compins;\r\nif (par->device_info->need_pwm) {\r\npar->pwm = pwm_get(&par->client->dev, NULL);\r\nif (IS_ERR(par->pwm)) {\r\ndev_err(&par->client->dev, "Could not get PWM from device tree!\n");\r\nreturn PTR_ERR(par->pwm);\r\n}\r\npar->pwm_period = pwm_get_period(par->pwm);\r\npwm_config(par->pwm, par->pwm_period / 2, par->pwm_period);\r\npwm_enable(par->pwm);\r\ndev_dbg(&par->client->dev, "Using PWM%d with a %dns period.\n",\r\npar->pwm->pwm, par->pwm_period);\r\n};\r\nret = ssd1307fb_write_cmd(par->client, SSD1307FB_CONTRAST);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, par->contrast);\r\nif (ret < 0)\r\nreturn ret;\r\nif (par->seg_remap) {\r\nret = ssd1307fb_write_cmd(par->client, SSD1307FB_SEG_REMAP_ON);\r\nif (ret < 0)\r\nreturn ret;\r\n};\r\ncom_invdir = 0xc0 | (par->com_invdir & 0x1) << 3;\r\nret = ssd1307fb_write_cmd(par->client, com_invdir);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, SSD1307FB_SET_MULTIPLEX_RATIO);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, par->height - 1);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, SSD1307FB_SET_DISPLAY_OFFSET);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, par->com_offset);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, SSD1307FB_SET_CLOCK_FREQ);\r\nif (ret < 0)\r\nreturn ret;\r\ndclk = ((par->dclk_div - 1) & 0xf) | (par->dclk_frq & 0xf) << 4;\r\nret = ssd1307fb_write_cmd(par->client, dclk);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, SSD1307FB_SET_PRECHARGE_PERIOD);\r\nif (ret < 0)\r\nreturn ret;\r\nprecharge = (par->prechargep1 & 0xf) | (par->prechargep2 & 0xf) << 4;\r\nret = ssd1307fb_write_cmd(par->client, precharge);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, SSD1307FB_SET_COM_PINS_CONFIG);\r\nif (ret < 0)\r\nreturn ret;\r\ncompins = 0x02 | !(par->com_seq & 0x1) << 4\r\n| (par->com_lrremap & 0x1) << 5;\r\nret = ssd1307fb_write_cmd(par->client, compins);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, SSD1307FB_SET_VCOMH);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, par->vcomh);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, SSD1307FB_CHARGE_PUMP);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client,\r\n(par->device_info->need_chargepump & 0x1 << 2) & 0x14);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, SSD1307FB_SET_ADDRESS_MODE);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client,\r\nSSD1307FB_SET_ADDRESS_MODE_HORIZONTAL);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, SSD1307FB_SET_COL_RANGE);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, par->width - 1);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, SSD1307FB_SET_PAGE_RANGE);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client,\r\npar->page_offset + (par->height / 8) - 1);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, SSD1307FB_DISPLAY_ON);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int ssd1307fb_update_bl(struct backlight_device *bdev)\r\n{\r\nstruct ssd1307fb_par *par = bl_get_data(bdev);\r\nint ret;\r\nint brightness = bdev->props.brightness;\r\npar->contrast = brightness;\r\nret = ssd1307fb_write_cmd(par->client, SSD1307FB_CONTRAST);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ssd1307fb_write_cmd(par->client, par->contrast);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int ssd1307fb_get_brightness(struct backlight_device *bdev)\r\n{\r\nstruct ssd1307fb_par *par = bl_get_data(bdev);\r\nreturn par->contrast;\r\n}\r\nstatic int ssd1307fb_check_fb(struct backlight_device *bdev,\r\nstruct fb_info *info)\r\n{\r\nreturn (info->bl_dev == bdev);\r\n}\r\nstatic int ssd1307fb_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct backlight_device *bl;\r\nchar bl_name[12];\r\nstruct fb_info *info;\r\nstruct device_node *node = client->dev.of_node;\r\nstruct fb_deferred_io *ssd1307fb_defio;\r\nu32 vmem_size;\r\nstruct ssd1307fb_par *par;\r\nu8 *vmem;\r\nint ret;\r\nif (!node) {\r\ndev_err(&client->dev, "No device tree data found!\n");\r\nreturn -EINVAL;\r\n}\r\ninfo = framebuffer_alloc(sizeof(struct ssd1307fb_par), &client->dev);\r\nif (!info) {\r\ndev_err(&client->dev, "Couldn't allocate framebuffer.\n");\r\nreturn -ENOMEM;\r\n}\r\npar = info->par;\r\npar->info = info;\r\npar->client = client;\r\npar->device_info = (struct ssd1307fb_deviceinfo *)of_match_device(\r\nssd1307fb_of_match, &client->dev)->data;\r\npar->reset = of_get_named_gpio(client->dev.of_node,\r\n"reset-gpios", 0);\r\nif (!gpio_is_valid(par->reset)) {\r\nret = -EINVAL;\r\ngoto fb_alloc_error;\r\n}\r\nif (of_property_read_u32(node, "solomon,width", &par->width))\r\npar->width = 96;\r\nif (of_property_read_u32(node, "solomon,height", &par->height))\r\npar->height = 16;\r\nif (of_property_read_u32(node, "solomon,page-offset", &par->page_offset))\r\npar->page_offset = 1;\r\nif (of_property_read_u32(node, "solomon,com-offset", &par->com_offset))\r\npar->com_offset = 0;\r\nif (of_property_read_u32(node, "solomon,prechargep1", &par->prechargep1))\r\npar->prechargep1 = 2;\r\nif (of_property_read_u32(node, "solomon,prechargep2", &par->prechargep2))\r\npar->prechargep2 = 2;\r\npar->seg_remap = !of_property_read_bool(node, "solomon,segment-no-remap");\r\npar->com_seq = of_property_read_bool(node, "solomon,com-seq");\r\npar->com_lrremap = of_property_read_bool(node, "solomon,com-lrremap");\r\npar->com_invdir = of_property_read_bool(node, "solomon,com-invdir");\r\npar->contrast = 127;\r\npar->vcomh = par->device_info->default_vcomh;\r\npar->dclk_div = par->device_info->default_dclk_div;\r\npar->dclk_frq = par->device_info->default_dclk_frq;\r\nvmem_size = par->width * par->height / 8;\r\nvmem = (void *)__get_free_pages(GFP_KERNEL | __GFP_ZERO,\r\nget_order(vmem_size));\r\nif (!vmem) {\r\ndev_err(&client->dev, "Couldn't allocate graphical memory.\n");\r\nret = -ENOMEM;\r\ngoto fb_alloc_error;\r\n}\r\nssd1307fb_defio = devm_kzalloc(&client->dev, sizeof(struct fb_deferred_io), GFP_KERNEL);\r\nif (!ssd1307fb_defio) {\r\ndev_err(&client->dev, "Couldn't allocate deferred io.\n");\r\nret = -ENOMEM;\r\ngoto fb_alloc_error;\r\n}\r\nssd1307fb_defio->delay = HZ / refreshrate;\r\nssd1307fb_defio->deferred_io = ssd1307fb_deferred_io;\r\ninfo->fbops = &ssd1307fb_ops;\r\ninfo->fix = ssd1307fb_fix;\r\ninfo->fix.line_length = par->width / 8;\r\ninfo->fbdefio = ssd1307fb_defio;\r\ninfo->var = ssd1307fb_var;\r\ninfo->var.xres = par->width;\r\ninfo->var.xres_virtual = par->width;\r\ninfo->var.yres = par->height;\r\ninfo->var.yres_virtual = par->height;\r\ninfo->var.red.length = 1;\r\ninfo->var.red.offset = 0;\r\ninfo->var.green.length = 1;\r\ninfo->var.green.offset = 0;\r\ninfo->var.blue.length = 1;\r\ninfo->var.blue.offset = 0;\r\ninfo->screen_base = (u8 __force __iomem *)vmem;\r\ninfo->fix.smem_start = __pa(vmem);\r\ninfo->fix.smem_len = vmem_size;\r\nfb_deferred_io_init(info);\r\nret = devm_gpio_request_one(&client->dev, par->reset,\r\nGPIOF_OUT_INIT_HIGH,\r\n"oled-reset");\r\nif (ret) {\r\ndev_err(&client->dev,\r\n"failed to request gpio %d: %d\n",\r\npar->reset, ret);\r\ngoto reset_oled_error;\r\n}\r\ni2c_set_clientdata(client, info);\r\ngpio_set_value(par->reset, 0);\r\nudelay(4);\r\ngpio_set_value(par->reset, 1);\r\nudelay(4);\r\nret = ssd1307fb_init(par);\r\nif (ret)\r\ngoto reset_oled_error;\r\nret = register_framebuffer(info);\r\nif (ret) {\r\ndev_err(&client->dev, "Couldn't register the framebuffer\n");\r\ngoto panel_init_error;\r\n}\r\nsnprintf(bl_name, sizeof(bl_name), "ssd1307fb%d", info->node);\r\nbl = backlight_device_register(bl_name, &client->dev, par,\r\n&ssd1307fb_bl_ops, NULL);\r\nif (IS_ERR(bl)) {\r\nret = PTR_ERR(bl);\r\ndev_err(&client->dev, "unable to register backlight device: %d\n",\r\nret);\r\ngoto bl_init_error;\r\n}\r\nbl->props.brightness = par->contrast;\r\nbl->props.max_brightness = MAX_CONTRAST;\r\ninfo->bl_dev = bl;\r\ndev_info(&client->dev, "fb%d: %s framebuffer device registered, using %d bytes of video memory\n", info->node, info->fix.id, vmem_size);\r\nreturn 0;\r\nbl_init_error:\r\nunregister_framebuffer(info);\r\npanel_init_error:\r\nif (par->device_info->need_pwm) {\r\npwm_disable(par->pwm);\r\npwm_put(par->pwm);\r\n};\r\nreset_oled_error:\r\nfb_deferred_io_cleanup(info);\r\nfb_alloc_error:\r\nframebuffer_release(info);\r\nreturn ret;\r\n}\r\nstatic int ssd1307fb_remove(struct i2c_client *client)\r\n{\r\nstruct fb_info *info = i2c_get_clientdata(client);\r\nstruct ssd1307fb_par *par = info->par;\r\nssd1307fb_write_cmd(par->client, SSD1307FB_DISPLAY_OFF);\r\nbacklight_device_unregister(info->bl_dev);\r\nunregister_framebuffer(info);\r\nif (par->device_info->need_pwm) {\r\npwm_disable(par->pwm);\r\npwm_put(par->pwm);\r\n};\r\nfb_deferred_io_cleanup(info);\r\n__free_pages(__va(info->fix.smem_start), get_order(info->fix.smem_len));\r\nframebuffer_release(info);\r\nreturn 0;\r\n}

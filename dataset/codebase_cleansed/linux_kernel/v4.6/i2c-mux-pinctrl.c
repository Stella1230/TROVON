static int i2c_mux_pinctrl_select(struct i2c_adapter *adap, void *data,\r\nu32 chan)\r\n{\r\nstruct i2c_mux_pinctrl *mux = data;\r\nreturn pinctrl_select_state(mux->pinctrl, mux->states[chan]);\r\n}\r\nstatic int i2c_mux_pinctrl_deselect(struct i2c_adapter *adap, void *data,\r\nu32 chan)\r\n{\r\nstruct i2c_mux_pinctrl *mux = data;\r\nreturn pinctrl_select_state(mux->pinctrl, mux->state_idle);\r\n}\r\nstatic int i2c_mux_pinctrl_parse_dt(struct i2c_mux_pinctrl *mux,\r\nstruct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nint num_names, i, ret;\r\nstruct device_node *adapter_np;\r\nstruct i2c_adapter *adapter;\r\nif (!np)\r\nreturn 0;\r\nmux->pdata = devm_kzalloc(&pdev->dev, sizeof(*mux->pdata), GFP_KERNEL);\r\nif (!mux->pdata) {\r\ndev_err(mux->dev,\r\n"Cannot allocate i2c_mux_pinctrl_platform_data\n");\r\nreturn -ENOMEM;\r\n}\r\nnum_names = of_property_count_strings(np, "pinctrl-names");\r\nif (num_names < 0) {\r\ndev_err(mux->dev, "Cannot parse pinctrl-names: %d\n",\r\nnum_names);\r\nreturn num_names;\r\n}\r\nmux->pdata->pinctrl_states = devm_kzalloc(&pdev->dev,\r\nsizeof(*mux->pdata->pinctrl_states) * num_names,\r\nGFP_KERNEL);\r\nif (!mux->pdata->pinctrl_states) {\r\ndev_err(mux->dev, "Cannot allocate pinctrl_states\n");\r\nreturn -ENOMEM;\r\n}\r\nfor (i = 0; i < num_names; i++) {\r\nret = of_property_read_string_index(np, "pinctrl-names", i,\r\n&mux->pdata->pinctrl_states[mux->pdata->bus_count]);\r\nif (ret < 0) {\r\ndev_err(mux->dev, "Cannot parse pinctrl-names: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nif (!strcmp(mux->pdata->pinctrl_states[mux->pdata->bus_count],\r\n"idle")) {\r\nif (i != num_names - 1) {\r\ndev_err(mux->dev, "idle state must be last\n");\r\nreturn -EINVAL;\r\n}\r\nmux->pdata->pinctrl_state_idle = "idle";\r\n} else {\r\nmux->pdata->bus_count++;\r\n}\r\n}\r\nadapter_np = of_parse_phandle(np, "i2c-parent", 0);\r\nif (!adapter_np) {\r\ndev_err(mux->dev, "Cannot parse i2c-parent\n");\r\nreturn -ENODEV;\r\n}\r\nadapter = of_find_i2c_adapter_by_node(adapter_np);\r\nof_node_put(adapter_np);\r\nif (!adapter) {\r\ndev_err(mux->dev, "Cannot find parent bus\n");\r\nreturn -EPROBE_DEFER;\r\n}\r\nmux->pdata->parent_bus_num = i2c_adapter_id(adapter);\r\nput_device(&adapter->dev);\r\nreturn 0;\r\n}\r\nstatic inline int i2c_mux_pinctrl_parse_dt(struct i2c_mux_pinctrl *mux,\r\nstruct platform_device *pdev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int i2c_mux_pinctrl_probe(struct platform_device *pdev)\r\n{\r\nstruct i2c_mux_pinctrl *mux;\r\nint (*deselect)(struct i2c_adapter *, void *, u32);\r\nint i, ret;\r\nmux = devm_kzalloc(&pdev->dev, sizeof(*mux), GFP_KERNEL);\r\nif (!mux) {\r\ndev_err(&pdev->dev, "Cannot allocate i2c_mux_pinctrl\n");\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\nplatform_set_drvdata(pdev, mux);\r\nmux->dev = &pdev->dev;\r\nmux->pdata = dev_get_platdata(&pdev->dev);\r\nif (!mux->pdata) {\r\nret = i2c_mux_pinctrl_parse_dt(mux, pdev);\r\nif (ret < 0)\r\ngoto err;\r\n}\r\nif (!mux->pdata) {\r\ndev_err(&pdev->dev, "Missing platform data\n");\r\nret = -ENODEV;\r\ngoto err;\r\n}\r\nmux->states = devm_kzalloc(&pdev->dev,\r\nsizeof(*mux->states) * mux->pdata->bus_count,\r\nGFP_KERNEL);\r\nif (!mux->states) {\r\ndev_err(&pdev->dev, "Cannot allocate states\n");\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\nmux->busses = devm_kzalloc(&pdev->dev,\r\nsizeof(*mux->busses) * mux->pdata->bus_count,\r\nGFP_KERNEL);\r\nif (!mux->busses) {\r\ndev_err(&pdev->dev, "Cannot allocate busses\n");\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\nmux->pinctrl = devm_pinctrl_get(&pdev->dev);\r\nif (IS_ERR(mux->pinctrl)) {\r\nret = PTR_ERR(mux->pinctrl);\r\ndev_err(&pdev->dev, "Cannot get pinctrl: %d\n", ret);\r\ngoto err;\r\n}\r\nfor (i = 0; i < mux->pdata->bus_count; i++) {\r\nmux->states[i] = pinctrl_lookup_state(mux->pinctrl,\r\nmux->pdata->pinctrl_states[i]);\r\nif (IS_ERR(mux->states[i])) {\r\nret = PTR_ERR(mux->states[i]);\r\ndev_err(&pdev->dev,\r\n"Cannot look up pinctrl state %s: %d\n",\r\nmux->pdata->pinctrl_states[i], ret);\r\ngoto err;\r\n}\r\n}\r\nif (mux->pdata->pinctrl_state_idle) {\r\nmux->state_idle = pinctrl_lookup_state(mux->pinctrl,\r\nmux->pdata->pinctrl_state_idle);\r\nif (IS_ERR(mux->state_idle)) {\r\nret = PTR_ERR(mux->state_idle);\r\ndev_err(&pdev->dev,\r\n"Cannot look up pinctrl state %s: %d\n",\r\nmux->pdata->pinctrl_state_idle, ret);\r\ngoto err;\r\n}\r\ndeselect = i2c_mux_pinctrl_deselect;\r\n} else {\r\ndeselect = NULL;\r\n}\r\nmux->parent = i2c_get_adapter(mux->pdata->parent_bus_num);\r\nif (!mux->parent) {\r\ndev_err(&pdev->dev, "Parent adapter (%d) not found\n",\r\nmux->pdata->parent_bus_num);\r\nret = -EPROBE_DEFER;\r\ngoto err;\r\n}\r\nfor (i = 0; i < mux->pdata->bus_count; i++) {\r\nu32 bus = mux->pdata->base_bus_num ?\r\n(mux->pdata->base_bus_num + i) : 0;\r\nmux->busses[i] = i2c_add_mux_adapter(mux->parent, &pdev->dev,\r\nmux, bus, i, 0,\r\ni2c_mux_pinctrl_select,\r\ndeselect);\r\nif (!mux->busses[i]) {\r\nret = -ENODEV;\r\ndev_err(&pdev->dev, "Failed to add adapter %d\n", i);\r\ngoto err_del_adapter;\r\n}\r\n}\r\nreturn 0;\r\nerr_del_adapter:\r\nfor (; i > 0; i--)\r\ni2c_del_mux_adapter(mux->busses[i - 1]);\r\ni2c_put_adapter(mux->parent);\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int i2c_mux_pinctrl_remove(struct platform_device *pdev)\r\n{\r\nstruct i2c_mux_pinctrl *mux = platform_get_drvdata(pdev);\r\nint i;\r\nfor (i = 0; i < mux->pdata->bus_count; i++)\r\ni2c_del_mux_adapter(mux->busses[i]);\r\ni2c_put_adapter(mux->parent);\r\nreturn 0;\r\n}

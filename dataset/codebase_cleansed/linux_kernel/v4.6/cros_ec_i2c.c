static inline struct cros_ec_device *to_ec_dev(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nreturn i2c_get_clientdata(client);\r\n}\r\nstatic int cros_ec_pkt_xfer_i2c(struct cros_ec_device *ec_dev,\r\nstruct cros_ec_command *msg)\r\n{\r\nstruct i2c_client *client = ec_dev->priv;\r\nint ret = -ENOMEM;\r\nint i;\r\nint packet_len;\r\nu8 *out_buf = NULL;\r\nu8 *in_buf = NULL;\r\nu8 sum;\r\nstruct i2c_msg i2c_msg[2];\r\nstruct ec_host_response *ec_response;\r\nstruct ec_host_request_i2c *ec_request_i2c;\r\nstruct ec_host_response_i2c *ec_response_i2c;\r\nint request_header_size = sizeof(struct ec_host_request_i2c);\r\nint response_header_size = sizeof(struct ec_host_response_i2c);\r\ni2c_msg[0].addr = client->addr;\r\ni2c_msg[0].flags = 0;\r\ni2c_msg[1].addr = client->addr;\r\ni2c_msg[1].flags = I2C_M_RD;\r\npacket_len = msg->insize + response_header_size;\r\nBUG_ON(packet_len > ec_dev->din_size);\r\nin_buf = ec_dev->din;\r\ni2c_msg[1].len = packet_len;\r\ni2c_msg[1].buf = (char *) in_buf;\r\npacket_len = msg->outsize + request_header_size;\r\nBUG_ON(packet_len > ec_dev->dout_size);\r\nout_buf = ec_dev->dout;\r\ni2c_msg[0].len = packet_len;\r\ni2c_msg[0].buf = (char *) out_buf;\r\nec_request_i2c = (struct ec_host_request_i2c *) out_buf;\r\nec_request_i2c->command_protocol = EC_COMMAND_PROTOCOL_3;\r\nec_dev->dout++;\r\nret = cros_ec_prepare_tx(ec_dev, msg);\r\nec_dev->dout--;\r\nret = i2c_transfer(client->adapter, i2c_msg, 2);\r\nif (ret < 0) {\r\ndev_dbg(ec_dev->dev, "i2c transfer failed: %d\n", ret);\r\ngoto done;\r\n} else if (ret != 2) {\r\ndev_err(ec_dev->dev, "failed to get response: %d\n", ret);\r\nret = -EIO;\r\ngoto done;\r\n}\r\nec_response_i2c = (struct ec_host_response_i2c *) in_buf;\r\nmsg->result = ec_response_i2c->result;\r\nec_response = &ec_response_i2c->ec_response;\r\nswitch (msg->result) {\r\ncase EC_RES_SUCCESS:\r\nbreak;\r\ncase EC_RES_IN_PROGRESS:\r\nret = -EAGAIN;\r\ndev_dbg(ec_dev->dev, "command 0x%02x in progress\n",\r\nmsg->command);\r\ngoto done;\r\ndefault:\r\ndev_dbg(ec_dev->dev, "command 0x%02x returned %d\n",\r\nmsg->command, msg->result);\r\nif (ec_response_i2c->result == EC_RES_INVALID_COMMAND &&\r\nec_response_i2c->packet_length == 0) {\r\nret = -EPROTONOSUPPORT;\r\ngoto done;\r\n}\r\n}\r\nif (ec_response_i2c->packet_length < sizeof(struct ec_host_response)) {\r\ndev_err(ec_dev->dev,\r\n"response of %u bytes too short; not a full header\n",\r\nec_response_i2c->packet_length);\r\nret = -EBADMSG;\r\ngoto done;\r\n}\r\nif (msg->insize < ec_response->data_len) {\r\ndev_err(ec_dev->dev,\r\n"response data size is too large: expected %u, got %u\n",\r\nmsg->insize,\r\nec_response->data_len);\r\nret = -EMSGSIZE;\r\ngoto done;\r\n}\r\nsum = 0;\r\nfor (i = 0; i < sizeof(struct ec_host_response); i++)\r\nsum += ((u8 *)ec_response)[i];\r\nmemcpy(msg->data,\r\nin_buf + response_header_size,\r\nec_response->data_len);\r\nfor (i = 0; i < ec_response->data_len; i++)\r\nsum += msg->data[i];\r\nif (sum) {\r\ndev_err(ec_dev->dev, "bad packet checksum\n");\r\nret = -EBADMSG;\r\ngoto done;\r\n}\r\nret = ec_response->data_len;\r\ndone:\r\nif (msg->command == EC_CMD_REBOOT_EC)\r\nmsleep(EC_REBOOT_DELAY_MS);\r\nreturn ret;\r\n}\r\nstatic int cros_ec_cmd_xfer_i2c(struct cros_ec_device *ec_dev,\r\nstruct cros_ec_command *msg)\r\n{\r\nstruct i2c_client *client = ec_dev->priv;\r\nint ret = -ENOMEM;\r\nint i;\r\nint len;\r\nint packet_len;\r\nu8 *out_buf = NULL;\r\nu8 *in_buf = NULL;\r\nu8 sum;\r\nstruct i2c_msg i2c_msg[2];\r\ni2c_msg[0].addr = client->addr;\r\ni2c_msg[0].flags = 0;\r\ni2c_msg[1].addr = client->addr;\r\ni2c_msg[1].flags = I2C_M_RD;\r\npacket_len = msg->insize + 3;\r\nin_buf = kzalloc(packet_len, GFP_KERNEL);\r\nif (!in_buf)\r\ngoto done;\r\ni2c_msg[1].len = packet_len;\r\ni2c_msg[1].buf = (char *)in_buf;\r\npacket_len = msg->outsize + 4;\r\nout_buf = kzalloc(packet_len, GFP_KERNEL);\r\nif (!out_buf)\r\ngoto done;\r\ni2c_msg[0].len = packet_len;\r\ni2c_msg[0].buf = (char *)out_buf;\r\nout_buf[0] = EC_CMD_VERSION0 + msg->version;\r\nout_buf[1] = msg->command;\r\nout_buf[2] = msg->outsize;\r\nsum = out_buf[0] + out_buf[1] + out_buf[2];\r\nfor (i = 0; i < msg->outsize; i++) {\r\nout_buf[3 + i] = msg->data[i];\r\nsum += out_buf[3 + i];\r\n}\r\nout_buf[3 + msg->outsize] = sum;\r\nret = i2c_transfer(client->adapter, i2c_msg, 2);\r\nif (ret < 0) {\r\ndev_err(ec_dev->dev, "i2c transfer failed: %d\n", ret);\r\ngoto done;\r\n} else if (ret != 2) {\r\ndev_err(ec_dev->dev, "failed to get response: %d\n", ret);\r\nret = -EIO;\r\ngoto done;\r\n}\r\nmsg->result = i2c_msg[1].buf[0];\r\nret = cros_ec_check_result(ec_dev, msg);\r\nif (ret)\r\ngoto done;\r\nlen = in_buf[1];\r\nif (len > msg->insize) {\r\ndev_err(ec_dev->dev, "packet too long (%d bytes, expected %d)",\r\nlen, msg->insize);\r\nret = -ENOSPC;\r\ngoto done;\r\n}\r\nsum = in_buf[0] + in_buf[1];\r\nfor (i = 0; i < len; i++) {\r\nmsg->data[i] = in_buf[2 + i];\r\nsum += in_buf[2 + i];\r\n}\r\ndev_dbg(ec_dev->dev, "packet: %*ph, sum = %02x\n",\r\ni2c_msg[1].len, in_buf, sum);\r\nif (sum != in_buf[2 + len]) {\r\ndev_err(ec_dev->dev, "bad packet checksum\n");\r\nret = -EBADMSG;\r\ngoto done;\r\n}\r\nret = len;\r\ndone:\r\nkfree(in_buf);\r\nkfree(out_buf);\r\nif (msg->command == EC_CMD_REBOOT_EC)\r\nmsleep(EC_REBOOT_DELAY_MS);\r\nreturn ret;\r\n}\r\nstatic int cros_ec_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *dev_id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct cros_ec_device *ec_dev = NULL;\r\nint err;\r\nec_dev = devm_kzalloc(dev, sizeof(*ec_dev), GFP_KERNEL);\r\nif (!ec_dev)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, ec_dev);\r\nec_dev->dev = dev;\r\nec_dev->priv = client;\r\nec_dev->irq = client->irq;\r\nec_dev->cmd_xfer = cros_ec_cmd_xfer_i2c;\r\nec_dev->pkt_xfer = cros_ec_pkt_xfer_i2c;\r\nec_dev->phys_name = client->adapter->name;\r\nec_dev->din_size = sizeof(struct ec_host_response_i2c) +\r\nsizeof(struct ec_response_get_protocol_info);\r\nec_dev->dout_size = sizeof(struct ec_host_request_i2c);\r\nerr = cros_ec_register(ec_dev);\r\nif (err) {\r\ndev_err(dev, "cannot register EC\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cros_ec_i2c_remove(struct i2c_client *client)\r\n{\r\nstruct cros_ec_device *ec_dev = i2c_get_clientdata(client);\r\ncros_ec_remove(ec_dev);\r\nreturn 0;\r\n}\r\nstatic int cros_ec_i2c_suspend(struct device *dev)\r\n{\r\nstruct cros_ec_device *ec_dev = to_ec_dev(dev);\r\nreturn cros_ec_suspend(ec_dev);\r\n}\r\nstatic int cros_ec_i2c_resume(struct device *dev)\r\n{\r\nstruct cros_ec_device *ec_dev = to_ec_dev(dev);\r\nreturn cros_ec_resume(ec_dev);\r\n}

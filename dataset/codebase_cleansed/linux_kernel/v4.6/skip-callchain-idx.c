static int check_return_reg(int ra_regno, Dwarf_Frame *frame)\r\n{\r\nDwarf_Op ops_mem[2];\r\nDwarf_Op dummy;\r\nDwarf_Op *ops = &dummy;\r\nsize_t nops;\r\nint result;\r\nresult = dwarf_frame_register(frame, ra_regno, ops_mem, &ops, &nops);\r\nif (result < 0) {\r\npr_debug("dwarf_frame_register() %s\n", dwarf_errmsg(-1));\r\nreturn -1;\r\n}\r\nif (nops != 0 || ops != NULL)\r\nreturn 0;\r\nresult = dwarf_frame_cfa(frame, &ops, &nops);\r\nif (result < 0) {\r\npr_debug("dwarf_frame_cfa() returns %d, %s\n", result,\r\ndwarf_errmsg(-1));\r\nreturn -1;\r\n}\r\nif (nops == 1 && ops[0].atom == DW_OP_bregx && ops[0].number == 1 &&\r\nops[0].number2 == 0)\r\nreturn 1;\r\nreturn 2;\r\n}\r\nstatic Dwarf_Frame *get_eh_frame(Dwfl_Module *mod, Dwarf_Addr pc)\r\n{\r\nint result;\r\nDwarf_Addr bias;\r\nDwarf_CFI *cfi;\r\nDwarf_Frame *frame;\r\ncfi = dwfl_module_eh_cfi(mod, &bias);\r\nif (!cfi) {\r\npr_debug("%s(): no CFI - %s\n", __func__, dwfl_errmsg(-1));\r\nreturn NULL;\r\n}\r\nresult = dwarf_cfi_addrframe(cfi, pc-bias, &frame);\r\nif (result) {\r\npr_debug("%s(): %s\n", __func__, dwfl_errmsg(-1));\r\nreturn NULL;\r\n}\r\nreturn frame;\r\n}\r\nstatic Dwarf_Frame *get_dwarf_frame(Dwfl_Module *mod, Dwarf_Addr pc)\r\n{\r\nDwarf_CFI *cfi;\r\nDwarf_Addr bias;\r\nDwarf_Frame *frame;\r\nint result;\r\ncfi = dwfl_module_dwarf_cfi(mod, &bias);\r\nif (!cfi) {\r\npr_debug("%s(): no CFI - %s\n", __func__, dwfl_errmsg(-1));\r\nreturn NULL;\r\n}\r\nresult = dwarf_cfi_addrframe(cfi, pc-bias, &frame);\r\nif (result) {\r\npr_debug("%s(): %s\n", __func__, dwfl_errmsg(-1));\r\nreturn NULL;\r\n}\r\nreturn frame;\r\n}\r\nstatic int check_return_addr(struct dso *dso, u64 map_start, Dwarf_Addr pc)\r\n{\r\nint rc = -1;\r\nDwfl *dwfl;\r\nDwfl_Module *mod;\r\nDwarf_Frame *frame;\r\nint ra_regno;\r\nDwarf_Addr start = pc;\r\nDwarf_Addr end = pc;\r\nbool signalp;\r\nconst char *exec_file = dso->long_name;\r\ndwfl = dso->dwfl;\r\nif (!dwfl) {\r\ndwfl = dwfl_begin(&offline_callbacks);\r\nif (!dwfl) {\r\npr_debug("dwfl_begin() failed: %s\n", dwarf_errmsg(-1));\r\nreturn -1;\r\n}\r\nmod = dwfl_report_elf(dwfl, exec_file, exec_file, -1,\r\nmap_start, false);\r\nif (!mod) {\r\npr_debug("dwfl_report_elf() failed %s\n",\r\ndwarf_errmsg(-1));\r\ndwfl_end(dwfl);\r\ngoto out;\r\n}\r\ndso->dwfl = dwfl;\r\n}\r\nmod = dwfl_addrmodule(dwfl, pc);\r\nif (!mod) {\r\npr_debug("dwfl_addrmodule() failed, %s\n", dwarf_errmsg(-1));\r\ngoto out;\r\n}\r\nframe = get_eh_frame(mod, pc);\r\nif (!frame) {\r\nframe = get_dwarf_frame(mod, pc);\r\nif (!frame)\r\ngoto out;\r\n}\r\nra_regno = dwarf_frame_info(frame, &start, &end, &signalp);\r\nif (ra_regno < 0) {\r\npr_debug("Return address register unavailable: %s\n",\r\ndwarf_errmsg(-1));\r\ngoto out;\r\n}\r\nrc = check_return_reg(ra_regno, frame);\r\nout:\r\nreturn rc;\r\n}\r\nint arch_skip_callchain_idx(struct thread *thread, struct ip_callchain *chain)\r\n{\r\nstruct addr_location al;\r\nstruct dso *dso = NULL;\r\nint rc;\r\nu64 ip;\r\nu64 skip_slot = -1;\r\nif (chain->nr < 3)\r\nreturn skip_slot;\r\nip = chain->ips[2];\r\nthread__find_addr_location(thread, PERF_RECORD_MISC_USER,\r\nMAP__FUNCTION, ip, &al);\r\nif (al.map)\r\ndso = al.map->dso;\r\nif (!dso) {\r\npr_debug("%" PRIx64 " dso is NULL\n", ip);\r\nreturn skip_slot;\r\n}\r\nrc = check_return_addr(dso, al.map->start, ip);\r\npr_debug("[DSO %s, sym %s, ip 0x%" PRIx64 "] rc %d\n",\r\ndso->long_name, al.sym->name, ip, rc);\r\nif (rc == 0) {\r\nskip_slot = 2;\r\n} else if (rc == 2) {\r\nskip_slot = 3;\r\n}\r\nreturn skip_slot;\r\n}

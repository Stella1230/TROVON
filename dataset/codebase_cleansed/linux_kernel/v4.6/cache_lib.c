int nfs_cache_upcall(struct cache_detail *cd, char *entry_name)\r\n{\r\nstatic char *envp[] = { "HOME=/",\r\n"TERM=linux",\r\n"PATH=/sbin:/usr/sbin:/bin:/usr/bin",\r\nNULL\r\n};\r\nchar *argv[] = {\r\nnfs_cache_getent_prog,\r\ncd->name,\r\nentry_name,\r\nNULL\r\n};\r\nint ret = -EACCES;\r\nif (nfs_cache_getent_prog[0] == '\0')\r\ngoto out;\r\nret = call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC);\r\nif (ret == -ENOENT || ret == -EACCES)\r\nnfs_cache_getent_prog[0] = '\0';\r\nout:\r\nreturn ret > 0 ? 0 : ret;\r\n}\r\nvoid nfs_cache_defer_req_put(struct nfs_cache_defer_req *dreq)\r\n{\r\nif (atomic_dec_and_test(&dreq->count))\r\nkfree(dreq);\r\n}\r\nstatic void nfs_dns_cache_revisit(struct cache_deferred_req *d, int toomany)\r\n{\r\nstruct nfs_cache_defer_req *dreq;\r\ndreq = container_of(d, struct nfs_cache_defer_req, deferred_req);\r\ncomplete_all(&dreq->completion);\r\nnfs_cache_defer_req_put(dreq);\r\n}\r\nstatic struct cache_deferred_req *nfs_dns_cache_defer(struct cache_req *req)\r\n{\r\nstruct nfs_cache_defer_req *dreq;\r\ndreq = container_of(req, struct nfs_cache_defer_req, req);\r\ndreq->deferred_req.revisit = nfs_dns_cache_revisit;\r\natomic_inc(&dreq->count);\r\nreturn &dreq->deferred_req;\r\n}\r\nstruct nfs_cache_defer_req *nfs_cache_defer_req_alloc(void)\r\n{\r\nstruct nfs_cache_defer_req *dreq;\r\ndreq = kzalloc(sizeof(*dreq), GFP_KERNEL);\r\nif (dreq) {\r\ninit_completion(&dreq->completion);\r\natomic_set(&dreq->count, 1);\r\ndreq->req.defer = nfs_dns_cache_defer;\r\n}\r\nreturn dreq;\r\n}\r\nint nfs_cache_wait_for_upcall(struct nfs_cache_defer_req *dreq)\r\n{\r\nif (wait_for_completion_timeout(&dreq->completion,\r\nnfs_cache_getent_timeout * HZ) == 0)\r\nreturn -ETIMEDOUT;\r\nreturn 0;\r\n}\r\nint nfs_cache_register_sb(struct super_block *sb, struct cache_detail *cd)\r\n{\r\nint ret;\r\nstruct dentry *dir;\r\ndir = rpc_d_lookup_sb(sb, "cache");\r\nret = sunrpc_cache_register_pipefs(dir, cd->name, 0600, cd);\r\ndput(dir);\r\nreturn ret;\r\n}\r\nint nfs_cache_register_net(struct net *net, struct cache_detail *cd)\r\n{\r\nstruct super_block *pipefs_sb;\r\nint ret = 0;\r\nsunrpc_init_cache_detail(cd);\r\npipefs_sb = rpc_get_sb_net(net);\r\nif (pipefs_sb) {\r\nret = nfs_cache_register_sb(pipefs_sb, cd);\r\nrpc_put_sb_net(net);\r\nif (ret)\r\nsunrpc_destroy_cache_detail(cd);\r\n}\r\nreturn ret;\r\n}\r\nvoid nfs_cache_unregister_sb(struct super_block *sb, struct cache_detail *cd)\r\n{\r\nif (cd->u.pipefs.dir)\r\nsunrpc_cache_unregister_pipefs(cd);\r\n}\r\nvoid nfs_cache_unregister_net(struct net *net, struct cache_detail *cd)\r\n{\r\nstruct super_block *pipefs_sb;\r\npipefs_sb = rpc_get_sb_net(net);\r\nif (pipefs_sb) {\r\nnfs_cache_unregister_sb(pipefs_sb, cd);\r\nrpc_put_sb_net(net);\r\n}\r\nsunrpc_destroy_cache_detail(cd);\r\n}

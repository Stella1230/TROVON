static int\r\nbvme6000_probe(struct platform_device *dev)\r\n{\r\nstruct Scsi_Host *host;\r\nstruct NCR_700_Host_Parameters *hostdata;\r\nif (!MACH_IS_BVME6000)\r\ngoto out;\r\nhostdata = kzalloc(sizeof(struct NCR_700_Host_Parameters), GFP_KERNEL);\r\nif (!hostdata) {\r\nprintk(KERN_ERR "bvme6000-scsi: "\r\n"Failed to allocate host data\n");\r\ngoto out;\r\n}\r\nhostdata->base = (void __iomem *)BVME_NCR53C710_BASE;\r\nhostdata->clock = 40;\r\nhostdata->chip710 = 1;\r\nhostdata->dmode_extra = DMODE_FC2;\r\nhostdata->dcntl_extra = EA_710;\r\nhostdata->ctest7_extra = CTEST7_TT1;\r\nhost = NCR_700_detect(&bvme6000_scsi_driver_template, hostdata,\r\n&dev->dev);\r\nif (!host) {\r\nprintk(KERN_ERR "bvme6000-scsi: No host detected; "\r\n"board configuration problem?\n");\r\ngoto out_free;\r\n}\r\nhost->base = BVME_NCR53C710_BASE;\r\nhost->this_id = 7;\r\nhost->irq = BVME_IRQ_SCSI;\r\nif (request_irq(BVME_IRQ_SCSI, NCR_700_intr, 0, "bvme6000-scsi",\r\nhost)) {\r\nprintk(KERN_ERR "bvme6000-scsi: request_irq failed\n");\r\ngoto out_put_host;\r\n}\r\nplatform_set_drvdata(dev, host);\r\nscsi_scan_host(host);\r\nreturn 0;\r\nout_put_host:\r\nscsi_host_put(host);\r\nout_free:\r\nkfree(hostdata);\r\nout:\r\nreturn -ENODEV;\r\n}\r\nstatic int\r\nbvme6000_device_remove(struct platform_device *dev)\r\n{\r\nstruct Scsi_Host *host = platform_get_drvdata(dev);\r\nstruct NCR_700_Host_Parameters *hostdata = shost_priv(host);\r\nscsi_remove_host(host);\r\nNCR_700_release(host);\r\nkfree(hostdata);\r\nfree_irq(host->irq, host);\r\nreturn 0;\r\n}\r\nstatic int __init bvme6000_scsi_init(void)\r\n{\r\nint err;\r\nerr = platform_driver_register(&bvme6000_scsi_driver);\r\nif (err)\r\nreturn err;\r\nbvme6000_scsi_device = platform_device_register_simple("bvme6000-scsi",\r\n-1, NULL, 0);\r\nif (IS_ERR(bvme6000_scsi_device)) {\r\nplatform_driver_unregister(&bvme6000_scsi_driver);\r\nreturn PTR_ERR(bvme6000_scsi_device);\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit bvme6000_scsi_exit(void)\r\n{\r\nplatform_device_unregister(bvme6000_scsi_device);\r\nplatform_driver_unregister(&bvme6000_scsi_driver);\r\n}

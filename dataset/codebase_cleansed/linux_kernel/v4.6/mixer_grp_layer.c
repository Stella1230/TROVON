static void mxr_graph_layer_release(struct mxr_layer *layer)\r\n{\r\nmxr_base_layer_unregister(layer);\r\nmxr_base_layer_release(layer);\r\n}\r\nstatic void mxr_graph_buffer_set(struct mxr_layer *layer,\r\nstruct mxr_buffer *buf)\r\n{\r\ndma_addr_t addr = 0;\r\nif (buf)\r\naddr = vb2_dma_contig_plane_dma_addr(&buf->vb.vb2_buf, 0);\r\nmxr_reg_graph_buffer(layer->mdev, layer->idx, addr);\r\n}\r\nstatic void mxr_graph_stream_set(struct mxr_layer *layer, int en)\r\n{\r\nmxr_reg_graph_layer_stream(layer->mdev, layer->idx, en);\r\n}\r\nstatic void mxr_graph_format_set(struct mxr_layer *layer)\r\n{\r\nmxr_reg_graph_format(layer->mdev, layer->idx,\r\nlayer->fmt, &layer->geo);\r\n}\r\nstatic inline unsigned int closest(unsigned int x, unsigned int a,\r\nunsigned int b, unsigned long flags)\r\n{\r\nunsigned int mid = (a + b) / 2;\r\nflags &= V4L2_SEL_FLAG_LE | V4L2_SEL_FLAG_GE;\r\nif (x <= a)\r\nreturn a;\r\nif (x >= b)\r\nreturn b;\r\nif (flags == V4L2_SEL_FLAG_LE)\r\nreturn a;\r\nif (flags == V4L2_SEL_FLAG_GE)\r\nreturn b;\r\nif (x <= mid)\r\nreturn a;\r\nreturn b;\r\n}\r\nstatic inline unsigned int do_center(unsigned int center,\r\nunsigned int size, unsigned int upper, unsigned int flags)\r\n{\r\nunsigned int lower;\r\nif (flags & MXR_NO_OFFSET)\r\nreturn 0;\r\nlower = center - min(center, size / 2);\r\nreturn min(lower, upper - size);\r\n}\r\nstatic void mxr_graph_fix_geometry(struct mxr_layer *layer,\r\nenum mxr_geometry_stage stage, unsigned long flags)\r\n{\r\nstruct mxr_geometry *geo = &layer->geo;\r\nstruct mxr_crop *src = &geo->src;\r\nstruct mxr_crop *dst = &geo->dst;\r\nunsigned int x_center, y_center;\r\nswitch (stage) {\r\ncase MXR_GEOMETRY_SINK:\r\nflags = 0;\r\ncase MXR_GEOMETRY_COMPOSE:\r\nx_center = dst->x_offset + dst->width / 2;\r\ny_center = dst->y_offset + dst->height / 2;\r\nif (flags & V4L2_SEL_FLAG_LE) {\r\ndst->width = round_down(dst->width, 2);\r\ndst->height = round_down(dst->height, 2);\r\n} else {\r\ndst->width = round_up(dst->width, 2);\r\ndst->height = round_up(dst->height, 2);\r\n}\r\ndst->width = min(dst->width, dst->full_width);\r\ndst->height = min(dst->height, dst->full_height);\r\ndst->width = min(dst->width, 2 * src->full_width);\r\ndst->height = min(dst->height, 2 * src->full_height);\r\ndst->x_offset = do_center(x_center, dst->width,\r\ndst->full_width, flags);\r\ndst->y_offset = do_center(y_center, dst->height,\r\ndst->full_height, flags);\r\nflags = 0;\r\ncase MXR_GEOMETRY_CROP:\r\nx_center = src->x_offset + src->width / 2;\r\ny_center = src->y_offset + src->height / 2;\r\nif (src->full_width < dst->width)\r\nsrc->width = dst->width / 2;\r\nelse\r\nsrc->width = closest(src->width, dst->width / 2,\r\ndst->width, flags);\r\nif (src->width == dst->width)\r\ngeo->x_ratio = 0;\r\nelse\r\ngeo->x_ratio = 1;\r\nif (src->full_height < dst->height)\r\nsrc->height = dst->height / 2;\r\nelse\r\nsrc->height = closest(src->height, dst->height / 2,\r\ndst->height, flags);\r\nif (src->height == dst->height)\r\ngeo->y_ratio = 0;\r\nelse\r\ngeo->y_ratio = 1;\r\nsrc->x_offset = do_center(x_center, src->width,\r\nsrc->full_width, flags);\r\nsrc->y_offset = do_center(y_center, src->height,\r\nsrc->full_height, flags);\r\nflags = 0;\r\ncase MXR_GEOMETRY_SOURCE:\r\nsrc->full_width = clamp_val(src->full_width,\r\nsrc->width + src->x_offset, 32767);\r\nsrc->full_height = clamp_val(src->full_height,\r\nsrc->height + src->y_offset, 2047);\r\n}\r\n}\r\nstruct mxr_layer *mxr_graph_layer_create(struct mxr_device *mdev, int idx)\r\n{\r\nstruct mxr_layer *layer;\r\nint ret;\r\nstruct mxr_layer_ops ops = {\r\n.release = mxr_graph_layer_release,\r\n.buffer_set = mxr_graph_buffer_set,\r\n.stream_set = mxr_graph_stream_set,\r\n.format_set = mxr_graph_format_set,\r\n.fix_geometry = mxr_graph_fix_geometry,\r\n};\r\nchar name[32];\r\nsprintf(name, "graph%d", idx);\r\nlayer = mxr_base_layer_create(mdev, idx, name, &ops);\r\nif (layer == NULL) {\r\nmxr_err(mdev, "failed to initialize layer(%d) base\n", idx);\r\ngoto fail;\r\n}\r\nlayer->fmt_array = mxr_graph_format;\r\nlayer->fmt_array_size = ARRAY_SIZE(mxr_graph_format);\r\nret = mxr_base_layer_register(layer);\r\nif (ret)\r\ngoto fail_layer;\r\nreturn layer;\r\nfail_layer:\r\nmxr_base_layer_release(layer);\r\nfail:\r\nreturn NULL;\r\n}

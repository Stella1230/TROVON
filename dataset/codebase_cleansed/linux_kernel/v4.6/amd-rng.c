static int amd_rng_data_present(struct hwrng *rng, int wait)\r\n{\r\nu32 pmbase = (u32)rng->priv;\r\nint data, i;\r\nfor (i = 0; i < 20; i++) {\r\ndata = !!(inl(pmbase + 0xF4) & 1);\r\nif (data || !wait)\r\nbreak;\r\nudelay(10);\r\n}\r\nreturn data;\r\n}\r\nstatic int amd_rng_data_read(struct hwrng *rng, u32 *data)\r\n{\r\nu32 pmbase = (u32)rng->priv;\r\n*data = inl(pmbase + 0xF0);\r\nreturn 4;\r\n}\r\nstatic int amd_rng_init(struct hwrng *rng)\r\n{\r\nu8 rnen;\r\npci_read_config_byte(amd_pdev, 0x40, &rnen);\r\nrnen |= (1 << 7);\r\npci_write_config_byte(amd_pdev, 0x40, rnen);\r\npci_read_config_byte(amd_pdev, 0x41, &rnen);\r\nrnen |= (1 << 7);\r\npci_write_config_byte(amd_pdev, 0x41, rnen);\r\nreturn 0;\r\n}\r\nstatic void amd_rng_cleanup(struct hwrng *rng)\r\n{\r\nu8 rnen;\r\npci_read_config_byte(amd_pdev, 0x40, &rnen);\r\nrnen &= ~(1 << 7);\r\npci_write_config_byte(amd_pdev, 0x40, rnen);\r\n}\r\nstatic int __init mod_init(void)\r\n{\r\nint err = -ENODEV;\r\nstruct pci_dev *pdev = NULL;\r\nconst struct pci_device_id *ent;\r\nu32 pmbase;\r\nfor_each_pci_dev(pdev) {\r\nent = pci_match_id(pci_tbl, pdev);\r\nif (ent)\r\ngoto found;\r\n}\r\ngoto out;\r\nfound:\r\nerr = pci_read_config_dword(pdev, 0x58, &pmbase);\r\nif (err)\r\ngoto out;\r\nerr = -EIO;\r\npmbase &= 0x0000FF00;\r\nif (pmbase == 0)\r\ngoto out;\r\nif (!request_region(pmbase + 0xF0, 8, "AMD HWRNG")) {\r\ndev_err(&pdev->dev, "AMD HWRNG region 0x%x already in use!\n",\r\npmbase + 0xF0);\r\nerr = -EBUSY;\r\ngoto out;\r\n}\r\namd_rng.priv = (unsigned long)pmbase;\r\namd_pdev = pdev;\r\npr_info("AMD768 RNG detected\n");\r\nerr = hwrng_register(&amd_rng);\r\nif (err) {\r\npr_err(PFX "RNG registering failed (%d)\n",\r\nerr);\r\nrelease_region(pmbase + 0xF0, 8);\r\ngoto out;\r\n}\r\nout:\r\nreturn err;\r\n}\r\nstatic void __exit mod_exit(void)\r\n{\r\nu32 pmbase = (unsigned long)amd_rng.priv;\r\nrelease_region(pmbase + 0xF0, 8);\r\nhwrng_unregister(&amd_rng);\r\n}

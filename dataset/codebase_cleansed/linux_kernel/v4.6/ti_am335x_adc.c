static unsigned int tiadc_readl(struct tiadc_device *adc, unsigned int reg)\r\n{\r\nreturn readl(adc->mfd_tscadc->tscadc_base + reg);\r\n}\r\nstatic void tiadc_writel(struct tiadc_device *adc, unsigned int reg,\r\nunsigned int val)\r\n{\r\nwritel(val, adc->mfd_tscadc->tscadc_base + reg);\r\n}\r\nstatic u32 get_adc_step_mask(struct tiadc_device *adc_dev)\r\n{\r\nu32 step_en;\r\nstep_en = ((1 << adc_dev->channels) - 1);\r\nstep_en <<= TOTAL_STEPS - adc_dev->channels + 1;\r\nreturn step_en;\r\n}\r\nstatic u32 get_adc_chan_step_mask(struct tiadc_device *adc_dev,\r\nstruct iio_chan_spec const *chan)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(adc_dev->channel_step); i++) {\r\nif (chan->channel == adc_dev->channel_line[i]) {\r\nu32 step;\r\nstep = adc_dev->channel_step[i];\r\nreturn 1 << (step + 1);\r\n}\r\n}\r\nWARN_ON(1);\r\nreturn 0;\r\n}\r\nstatic u32 get_adc_step_bit(struct tiadc_device *adc_dev, int chan)\r\n{\r\nreturn 1 << adc_dev->channel_step[chan];\r\n}\r\nstatic void tiadc_step_config(struct iio_dev *indio_dev)\r\n{\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nstruct device *dev = adc_dev->mfd_tscadc->dev;\r\nunsigned int stepconfig;\r\nint i, steps = 0;\r\nfor (i = 0; i < adc_dev->channels; i++) {\r\nint chan;\r\nchan = adc_dev->channel_line[i];\r\nif (adc_dev->step_avg[i] > STEPCONFIG_AVG_16) {\r\ndev_warn(dev, "chan %d step_avg truncating to %d\n",\r\nchan, STEPCONFIG_AVG_16);\r\nadc_dev->step_avg[i] = STEPCONFIG_AVG_16;\r\n}\r\nif (adc_dev->step_avg[i])\r\nstepconfig =\r\nSTEPCONFIG_AVG(ffs(adc_dev->step_avg[i]) - 1) |\r\nSTEPCONFIG_FIFO1;\r\nelse\r\nstepconfig = STEPCONFIG_FIFO1;\r\nif (iio_buffer_enabled(indio_dev))\r\nstepconfig |= STEPCONFIG_MODE_SWCNT;\r\ntiadc_writel(adc_dev, REG_STEPCONFIG(steps),\r\nstepconfig | STEPCONFIG_INP(chan));\r\nif (adc_dev->open_delay[i] > STEPDELAY_OPEN_MASK) {\r\ndev_warn(dev, "chan %d open delay truncating to 0x3FFFF\n",\r\nchan);\r\nadc_dev->open_delay[i] = STEPDELAY_OPEN_MASK;\r\n}\r\nif (adc_dev->sample_delay[i] > 0xFF) {\r\ndev_warn(dev, "chan %d sample delay truncating to 0xFF\n",\r\nchan);\r\nadc_dev->sample_delay[i] = 0xFF;\r\n}\r\ntiadc_writel(adc_dev, REG_STEPDELAY(steps),\r\nSTEPDELAY_OPEN(adc_dev->open_delay[i]) |\r\nSTEPDELAY_SAMPLE(adc_dev->sample_delay[i]));\r\nadc_dev->channel_step[i] = steps;\r\nsteps++;\r\n}\r\n}\r\nstatic irqreturn_t tiadc_irq_h(int irq, void *private)\r\n{\r\nstruct iio_dev *indio_dev = private;\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nunsigned int status, config;\r\nstatus = tiadc_readl(adc_dev, REG_IRQSTATUS);\r\nif (status & IRQENB_FIFO1OVRRUN) {\r\nconfig = tiadc_readl(adc_dev, REG_CTRL);\r\nconfig &= ~(CNTRLREG_TSCSSENB);\r\ntiadc_writel(adc_dev, REG_CTRL, config);\r\ntiadc_writel(adc_dev, REG_IRQSTATUS, IRQENB_FIFO1OVRRUN\r\n| IRQENB_FIFO1UNDRFLW | IRQENB_FIFO1THRES);\r\ntiadc_writel(adc_dev, REG_CTRL, (config | CNTRLREG_TSCSSENB));\r\nreturn IRQ_HANDLED;\r\n} else if (status & IRQENB_FIFO1THRES) {\r\ntiadc_writel(adc_dev, REG_IRQCLR, IRQENB_FIFO1THRES);\r\nreturn IRQ_WAKE_THREAD;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic irqreturn_t tiadc_worker_h(int irq, void *private)\r\n{\r\nstruct iio_dev *indio_dev = private;\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nint i, k, fifo1count, read;\r\nu16 *data = adc_dev->data;\r\nfifo1count = tiadc_readl(adc_dev, REG_FIFO1CNT);\r\nfor (k = 0; k < fifo1count; k = k + i) {\r\nfor (i = 0; i < (indio_dev->scan_bytes)/2; i++) {\r\nread = tiadc_readl(adc_dev, REG_FIFO1);\r\ndata[i] = read & FIFOREAD_DATA_MASK;\r\n}\r\niio_push_to_buffers(indio_dev, (u8 *) data);\r\n}\r\ntiadc_writel(adc_dev, REG_IRQSTATUS, IRQENB_FIFO1THRES);\r\ntiadc_writel(adc_dev, REG_IRQENABLE, IRQENB_FIFO1THRES);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int tiadc_buffer_preenable(struct iio_dev *indio_dev)\r\n{\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nint i, fifo1count, read;\r\ntiadc_writel(adc_dev, REG_IRQCLR, (IRQENB_FIFO1THRES |\r\nIRQENB_FIFO1OVRRUN |\r\nIRQENB_FIFO1UNDRFLW));\r\nfifo1count = tiadc_readl(adc_dev, REG_FIFO1CNT);\r\nfor (i = 0; i < fifo1count; i++)\r\nread = tiadc_readl(adc_dev, REG_FIFO1);\r\nreturn 0;\r\n}\r\nstatic int tiadc_buffer_postenable(struct iio_dev *indio_dev)\r\n{\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nunsigned int enb = 0;\r\nu8 bit;\r\ntiadc_step_config(indio_dev);\r\nfor_each_set_bit(bit, indio_dev->active_scan_mask, adc_dev->channels)\r\nenb |= (get_adc_step_bit(adc_dev, bit) << 1);\r\nadc_dev->buffer_en_ch_steps = enb;\r\nam335x_tsc_se_set_cache(adc_dev->mfd_tscadc, enb);\r\ntiadc_writel(adc_dev, REG_IRQSTATUS, IRQENB_FIFO1THRES\r\n| IRQENB_FIFO1OVRRUN | IRQENB_FIFO1UNDRFLW);\r\ntiadc_writel(adc_dev, REG_IRQENABLE, IRQENB_FIFO1THRES\r\n| IRQENB_FIFO1OVRRUN);\r\nreturn 0;\r\n}\r\nstatic int tiadc_buffer_predisable(struct iio_dev *indio_dev)\r\n{\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nint fifo1count, i, read;\r\ntiadc_writel(adc_dev, REG_IRQCLR, (IRQENB_FIFO1THRES |\r\nIRQENB_FIFO1OVRRUN | IRQENB_FIFO1UNDRFLW));\r\nam335x_tsc_se_clr(adc_dev->mfd_tscadc, adc_dev->buffer_en_ch_steps);\r\nadc_dev->buffer_en_ch_steps = 0;\r\nfifo1count = tiadc_readl(adc_dev, REG_FIFO1CNT);\r\nfor (i = 0; i < fifo1count; i++)\r\nread = tiadc_readl(adc_dev, REG_FIFO1);\r\nreturn 0;\r\n}\r\nstatic int tiadc_buffer_postdisable(struct iio_dev *indio_dev)\r\n{\r\ntiadc_step_config(indio_dev);\r\nreturn 0;\r\n}\r\nstatic int tiadc_iio_buffered_hardware_setup(struct iio_dev *indio_dev,\r\nirqreturn_t (*pollfunc_bh)(int irq, void *p),\r\nirqreturn_t (*pollfunc_th)(int irq, void *p),\r\nint irq,\r\nunsigned long flags,\r\nconst struct iio_buffer_setup_ops *setup_ops)\r\n{\r\nstruct iio_buffer *buffer;\r\nint ret;\r\nbuffer = iio_kfifo_allocate();\r\nif (!buffer)\r\nreturn -ENOMEM;\r\niio_device_attach_buffer(indio_dev, buffer);\r\nret = request_threaded_irq(irq, pollfunc_th, pollfunc_bh,\r\nflags, indio_dev->name, indio_dev);\r\nif (ret)\r\ngoto error_kfifo_free;\r\nindio_dev->setup_ops = setup_ops;\r\nindio_dev->modes |= INDIO_BUFFER_SOFTWARE;\r\nreturn 0;\r\nerror_kfifo_free:\r\niio_kfifo_free(indio_dev->buffer);\r\nreturn ret;\r\n}\r\nstatic void tiadc_iio_buffered_hardware_remove(struct iio_dev *indio_dev)\r\n{\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nfree_irq(adc_dev->mfd_tscadc->irq, indio_dev);\r\niio_kfifo_free(indio_dev->buffer);\r\n}\r\nstatic int tiadc_channel_init(struct iio_dev *indio_dev, int channels)\r\n{\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nstruct iio_chan_spec *chan_array;\r\nstruct iio_chan_spec *chan;\r\nint i;\r\nindio_dev->num_channels = channels;\r\nchan_array = kcalloc(channels,\r\nsizeof(struct iio_chan_spec), GFP_KERNEL);\r\nif (chan_array == NULL)\r\nreturn -ENOMEM;\r\nchan = chan_array;\r\nfor (i = 0; i < channels; i++, chan++) {\r\nchan->type = IIO_VOLTAGE;\r\nchan->indexed = 1;\r\nchan->channel = adc_dev->channel_line[i];\r\nchan->info_mask_separate = BIT(IIO_CHAN_INFO_RAW);\r\nchan->datasheet_name = chan_name_ain[chan->channel];\r\nchan->scan_index = i;\r\nchan->scan_type.sign = 'u';\r\nchan->scan_type.realbits = 12;\r\nchan->scan_type.storagebits = 16;\r\n}\r\nindio_dev->channels = chan_array;\r\nreturn 0;\r\n}\r\nstatic void tiadc_channels_remove(struct iio_dev *indio_dev)\r\n{\r\nkfree(indio_dev->channels);\r\n}\r\nstatic int tiadc_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val, int *val2, long mask)\r\n{\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nint i, map_val;\r\nunsigned int fifo1count, read, stepid;\r\nbool found = false;\r\nu32 step_en;\r\nunsigned long timeout;\r\nif (iio_buffer_enabled(indio_dev))\r\nreturn -EBUSY;\r\nstep_en = get_adc_chan_step_mask(adc_dev, chan);\r\nif (!step_en)\r\nreturn -EINVAL;\r\nfifo1count = tiadc_readl(adc_dev, REG_FIFO1CNT);\r\nwhile (fifo1count--)\r\ntiadc_readl(adc_dev, REG_FIFO1);\r\nam335x_tsc_se_set_once(adc_dev->mfd_tscadc, step_en);\r\ntimeout = jiffies + usecs_to_jiffies\r\n(IDLE_TIMEOUT * adc_dev->channels);\r\nwhile (1) {\r\nfifo1count = tiadc_readl(adc_dev, REG_FIFO1CNT);\r\nif (fifo1count)\r\nbreak;\r\nif (time_after(jiffies, timeout)) {\r\nam335x_tsc_se_adc_done(adc_dev->mfd_tscadc);\r\nreturn -EAGAIN;\r\n}\r\n}\r\nmap_val = adc_dev->channel_step[chan->scan_index];\r\nfor (i = 0; i < fifo1count; i++) {\r\nread = tiadc_readl(adc_dev, REG_FIFO1);\r\nstepid = read & FIFOREAD_CHNLID_MASK;\r\nstepid = stepid >> 0x10;\r\nif (stepid == map_val) {\r\nread = read & FIFOREAD_DATA_MASK;\r\nfound = true;\r\n*val = (u16) read;\r\n}\r\n}\r\nam335x_tsc_se_adc_done(adc_dev->mfd_tscadc);\r\nif (found == false)\r\nreturn -EBUSY;\r\nreturn IIO_VAL_INT;\r\n}\r\nstatic int tiadc_parse_dt(struct platform_device *pdev,\r\nstruct tiadc_device *adc_dev)\r\n{\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct property *prop;\r\nconst __be32 *cur;\r\nint channels = 0;\r\nu32 val;\r\nof_property_for_each_u32(node, "ti,adc-channels", prop, cur, val) {\r\nadc_dev->channel_line[channels] = val;\r\nadc_dev->open_delay[channels] = STEPCONFIG_OPENDLY;\r\nadc_dev->sample_delay[channels] = STEPCONFIG_SAMPLEDLY;\r\nadc_dev->step_avg[channels] = 16;\r\nchannels++;\r\n}\r\nof_property_read_u32_array(node, "ti,chan-step-avg",\r\nadc_dev->step_avg, channels);\r\nof_property_read_u32_array(node, "ti,chan-step-opendelay",\r\nadc_dev->open_delay, channels);\r\nof_property_read_u32_array(node, "ti,chan-step-sampledelay",\r\nadc_dev->sample_delay, channels);\r\nadc_dev->channels = channels;\r\nreturn 0;\r\n}\r\nstatic int tiadc_probe(struct platform_device *pdev)\r\n{\r\nstruct iio_dev *indio_dev;\r\nstruct tiadc_device *adc_dev;\r\nstruct device_node *node = pdev->dev.of_node;\r\nint err;\r\nif (!node) {\r\ndev_err(&pdev->dev, "Could not find valid DT data.\n");\r\nreturn -EINVAL;\r\n}\r\nindio_dev = devm_iio_device_alloc(&pdev->dev,\r\nsizeof(struct tiadc_device));\r\nif (indio_dev == NULL) {\r\ndev_err(&pdev->dev, "failed to allocate iio device\n");\r\nreturn -ENOMEM;\r\n}\r\nadc_dev = iio_priv(indio_dev);\r\nadc_dev->mfd_tscadc = ti_tscadc_dev_get(pdev);\r\ntiadc_parse_dt(pdev, adc_dev);\r\nindio_dev->dev.parent = &pdev->dev;\r\nindio_dev->name = dev_name(&pdev->dev);\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->info = &tiadc_info;\r\ntiadc_step_config(indio_dev);\r\ntiadc_writel(adc_dev, REG_FIFO1THR, FIFO1_THRESHOLD);\r\nerr = tiadc_channel_init(indio_dev, adc_dev->channels);\r\nif (err < 0)\r\nreturn err;\r\nerr = tiadc_iio_buffered_hardware_setup(indio_dev,\r\n&tiadc_worker_h,\r\n&tiadc_irq_h,\r\nadc_dev->mfd_tscadc->irq,\r\nIRQF_SHARED,\r\n&tiadc_buffer_setup_ops);\r\nif (err)\r\ngoto err_free_channels;\r\nerr = iio_device_register(indio_dev);\r\nif (err)\r\ngoto err_buffer_unregister;\r\nplatform_set_drvdata(pdev, indio_dev);\r\nreturn 0;\r\nerr_buffer_unregister:\r\ntiadc_iio_buffered_hardware_remove(indio_dev);\r\nerr_free_channels:\r\ntiadc_channels_remove(indio_dev);\r\nreturn err;\r\n}\r\nstatic int tiadc_remove(struct platform_device *pdev)\r\n{\r\nstruct iio_dev *indio_dev = platform_get_drvdata(pdev);\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nu32 step_en;\r\niio_device_unregister(indio_dev);\r\ntiadc_iio_buffered_hardware_remove(indio_dev);\r\ntiadc_channels_remove(indio_dev);\r\nstep_en = get_adc_step_mask(adc_dev);\r\nam335x_tsc_se_clr(adc_dev->mfd_tscadc, step_en);\r\nreturn 0;\r\n}\r\nstatic int tiadc_suspend(struct device *dev)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nstruct ti_tscadc_dev *tscadc_dev;\r\nunsigned int idle;\r\ntscadc_dev = ti_tscadc_dev_get(to_platform_device(dev));\r\nif (!device_may_wakeup(tscadc_dev->dev)) {\r\nidle = tiadc_readl(adc_dev, REG_CTRL);\r\nidle &= ~(CNTRLREG_TSCSSENB);\r\ntiadc_writel(adc_dev, REG_CTRL, (idle |\r\nCNTRLREG_POWERDOWN));\r\n}\r\nreturn 0;\r\n}\r\nstatic int tiadc_resume(struct device *dev)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nunsigned int restore;\r\nrestore = tiadc_readl(adc_dev, REG_CTRL);\r\nrestore &= ~(CNTRLREG_POWERDOWN);\r\ntiadc_writel(adc_dev, REG_CTRL, restore);\r\ntiadc_step_config(indio_dev);\r\nam335x_tsc_se_set_cache(adc_dev->mfd_tscadc,\r\nadc_dev->buffer_en_ch_steps);\r\nreturn 0;\r\n}

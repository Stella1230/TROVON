static void __init make_pll(int idx, const char *parent, void __iomem *base)\r\n{\r\nchar name[8];\r\nu32 val, mul, div;\r\nsprintf(name, "pll%d", idx);\r\nval = readl_relaxed(base + idx*8);\r\nmul = PLL_N(val) + 1;\r\ndiv = (PLL_M(val) + 1) << PLL_K(val);\r\nclk_register_fixed_factor(NULL, name, parent, 0, mul, div);\r\n}\r\nstatic int __init get_div(void __iomem *base)\r\n{\r\nu8 sysclk_tab[16] = { 2, 4, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4 };\r\nint idx = DIV_INDEX(readl_relaxed(base + LEGACY_DIV));\r\nreturn sysclk_tab[idx];\r\n}\r\nstatic void __init tango4_clkgen_setup(struct device_node *np)\r\n{\r\nint div, ret;\r\nvoid __iomem *base = of_iomap(np, 0);\r\nconst char *parent = of_clk_get_parent_name(np, 0);\r\nif (!base)\r\npanic("%s: invalid address\n", np->full_name);\r\nmake_pll(0, parent, base);\r\nmake_pll(1, parent, base);\r\nout[0] = clk_register_divider(NULL, "cpuclk", "pll0", 0,\r\nbase + CPUCLK_CTRL, 8, 8, CLK_DIVIDER_ONE_BASED, NULL);\r\ndiv = readl_relaxed(base + SYSCLK_CTRL) & BIT(23) ? get_div(base) : 4;\r\nout[1] = clk_register_fixed_factor(NULL, "sysclk", "pll1", 0, 1, div);\r\nret = of_clk_add_provider(np, of_clk_src_onecell_get, &clk_data);\r\nif (IS_ERR(out[0]) || IS_ERR(out[1]) || ret < 0)\r\npanic("%s: clk registration failed\n", np->full_name);\r\n}

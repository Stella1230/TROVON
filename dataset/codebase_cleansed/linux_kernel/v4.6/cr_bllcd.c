static int cr_backlight_set_intensity(struct backlight_device *bd)\r\n{\r\nint intensity = bd->props.brightness;\r\nu32 addr = gpio_bar + CRVML_PANEL_PORT;\r\nu32 cur = inl(addr);\r\nif (bd->props.power == FB_BLANK_UNBLANK)\r\nintensity = FB_BLANK_UNBLANK;\r\nif (bd->props.fb_blank == FB_BLANK_UNBLANK)\r\nintensity = FB_BLANK_UNBLANK;\r\nif (bd->props.power == FB_BLANK_POWERDOWN)\r\nintensity = FB_BLANK_POWERDOWN;\r\nif (bd->props.fb_blank == FB_BLANK_POWERDOWN)\r\nintensity = FB_BLANK_POWERDOWN;\r\nif (intensity == FB_BLANK_UNBLANK) {\r\ncur &= ~CRVML_BACKLIGHT_OFF;\r\noutl(cur, addr);\r\n} else if (intensity == FB_BLANK_POWERDOWN) {\r\ncur |= CRVML_BACKLIGHT_OFF;\r\noutl(cur, addr);\r\n}\r\nreturn 0;\r\n}\r\nstatic int cr_backlight_get_intensity(struct backlight_device *bd)\r\n{\r\nu32 addr = gpio_bar + CRVML_PANEL_PORT;\r\nu32 cur = inl(addr);\r\nu8 intensity;\r\nif (cur & CRVML_BACKLIGHT_OFF)\r\nintensity = FB_BLANK_POWERDOWN;\r\nelse\r\nintensity = FB_BLANK_UNBLANK;\r\nreturn intensity;\r\n}\r\nstatic void cr_panel_on(void)\r\n{\r\nu32 addr = gpio_bar + CRVML_PANEL_PORT;\r\nu32 cur = inl(addr);\r\nif (!(cur & CRVML_PANEL_ON)) {\r\nif (cur & 0x00000001) {\r\ncur &= ~CRVML_LVDS_ON;\r\noutl(cur, addr);\r\n}\r\nschedule_timeout(HZ / 10);\r\ncur |= CRVML_PANEL_ON;\r\noutl(cur, addr);\r\n}\r\nif (!(cur & CRVML_LVDS_ON)) {\r\nschedule_timeout(HZ / 10);\r\noutl(cur | CRVML_LVDS_ON, addr);\r\n}\r\n}\r\nstatic void cr_panel_off(void)\r\n{\r\nu32 addr = gpio_bar + CRVML_PANEL_PORT;\r\nu32 cur = inl(addr);\r\nif (cur & CRVML_LVDS_ON) {\r\ncur &= ~CRVML_LVDS_ON;\r\noutl(cur, addr);\r\n}\r\nif (cur & CRVML_PANEL_ON) {\r\nschedule_timeout(HZ / 10);\r\noutl(cur & ~CRVML_PANEL_ON, addr);\r\n}\r\n}\r\nstatic int cr_lcd_set_power(struct lcd_device *ld, int power)\r\n{\r\nif (power == FB_BLANK_UNBLANK)\r\ncr_panel_on();\r\nif (power == FB_BLANK_POWERDOWN)\r\ncr_panel_off();\r\nreturn 0;\r\n}\r\nstatic int cr_backlight_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_properties props;\r\nstruct backlight_device *bdp;\r\nstruct lcd_device *ldp;\r\nstruct cr_panel *crp;\r\nu8 dev_en;\r\nlpc_dev = pci_get_device(PCI_VENDOR_ID_INTEL,\r\nCRVML_DEVICE_LPC, NULL);\r\nif (!lpc_dev) {\r\npr_err("INTEL CARILLO RANCH LPC not found.\n");\r\nreturn -ENODEV;\r\n}\r\npci_read_config_byte(lpc_dev, CRVML_REG_GPIOEN, &dev_en);\r\nif (!(dev_en & CRVML_GPIOEN_BIT)) {\r\npr_err("Carillo Ranch GPIO device was not enabled.\n");\r\npci_dev_put(lpc_dev);\r\nreturn -ENODEV;\r\n}\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nbdp = devm_backlight_device_register(&pdev->dev, "cr-backlight",\r\n&pdev->dev, NULL, &cr_backlight_ops,\r\n&props);\r\nif (IS_ERR(bdp)) {\r\npci_dev_put(lpc_dev);\r\nreturn PTR_ERR(bdp);\r\n}\r\nldp = devm_lcd_device_register(&pdev->dev, "cr-lcd", &pdev->dev, NULL,\r\n&cr_lcd_ops);\r\nif (IS_ERR(ldp)) {\r\npci_dev_put(lpc_dev);\r\nreturn PTR_ERR(ldp);\r\n}\r\npci_read_config_dword(lpc_dev, CRVML_REG_GPIOBAR,\r\n&gpio_bar);\r\ngpio_bar &= ~0x3F;\r\ncrp = devm_kzalloc(&pdev->dev, sizeof(*crp), GFP_KERNEL);\r\nif (!crp) {\r\npci_dev_put(lpc_dev);\r\nreturn -ENOMEM;\r\n}\r\ncrp->cr_backlight_device = bdp;\r\ncrp->cr_lcd_device = ldp;\r\ncrp->cr_backlight_device->props.power = FB_BLANK_UNBLANK;\r\ncrp->cr_backlight_device->props.brightness = 0;\r\ncr_backlight_set_intensity(crp->cr_backlight_device);\r\ncr_lcd_set_power(crp->cr_lcd_device, FB_BLANK_UNBLANK);\r\nplatform_set_drvdata(pdev, crp);\r\nreturn 0;\r\n}\r\nstatic int cr_backlight_remove(struct platform_device *pdev)\r\n{\r\nstruct cr_panel *crp = platform_get_drvdata(pdev);\r\ncrp->cr_backlight_device->props.power = FB_BLANK_POWERDOWN;\r\ncrp->cr_backlight_device->props.brightness = 0;\r\ncrp->cr_backlight_device->props.max_brightness = 0;\r\ncr_backlight_set_intensity(crp->cr_backlight_device);\r\ncr_lcd_set_power(crp->cr_lcd_device, FB_BLANK_POWERDOWN);\r\npci_dev_put(lpc_dev);\r\nreturn 0;\r\n}\r\nstatic int __init cr_backlight_init(void)\r\n{\r\nint ret = platform_driver_register(&cr_backlight_driver);\r\nif (ret)\r\nreturn ret;\r\ncrp = platform_device_register_simple("cr_backlight", -1, NULL, 0);\r\nif (IS_ERR(crp)) {\r\nplatform_driver_unregister(&cr_backlight_driver);\r\nreturn PTR_ERR(crp);\r\n}\r\npr_info("Carillo Ranch Backlight Driver Initialized.\n");\r\nreturn 0;\r\n}\r\nstatic void __exit cr_backlight_exit(void)\r\n{\r\nplatform_device_unregister(crp);\r\nplatform_driver_unregister(&cr_backlight_driver);\r\n}

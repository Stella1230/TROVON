static int vbi_queue_setup(struct vb2_queue *vq,\r\nunsigned int *nbuffers, unsigned int *nplanes,\r\nunsigned int sizes[], void *alloc_ctxs[])\r\n{\r\nstruct au0828_dev *dev = vb2_get_drv_priv(vq);\r\nunsigned long size = dev->vbi_width * dev->vbi_height * 2;\r\nif (*nplanes)\r\nreturn sizes[0] < size ? -EINVAL : 0;\r\n*nplanes = 1;\r\nsizes[0] = size;\r\nreturn 0;\r\n}\r\nstatic int vbi_buffer_prepare(struct vb2_buffer *vb)\r\n{\r\nstruct au0828_dev *dev = vb2_get_drv_priv(vb->vb2_queue);\r\nunsigned long size;\r\nsize = dev->vbi_width * dev->vbi_height * 2;\r\nif (vb2_plane_size(vb, 0) < size) {\r\npr_err("%s data will not fit into plane (%lu < %lu)\n",\r\n__func__, vb2_plane_size(vb, 0), size);\r\nreturn -EINVAL;\r\n}\r\nvb2_set_plane_payload(vb, 0, size);\r\nreturn 0;\r\n}\r\nstatic void\r\nvbi_buffer_queue(struct vb2_buffer *vb)\r\n{\r\nstruct au0828_dev *dev = vb2_get_drv_priv(vb->vb2_queue);\r\nstruct vb2_v4l2_buffer *vbuf = to_vb2_v4l2_buffer(vb);\r\nstruct au0828_buffer *buf =\r\ncontainer_of(vbuf, struct au0828_buffer, vb);\r\nstruct au0828_dmaqueue *vbiq = &dev->vbiq;\r\nunsigned long flags = 0;\r\nbuf->mem = vb2_plane_vaddr(vb, 0);\r\nbuf->length = vb2_plane_size(vb, 0);\r\nspin_lock_irqsave(&dev->slock, flags);\r\nlist_add_tail(&buf->list, &vbiq->active);\r\nspin_unlock_irqrestore(&dev->slock, flags);\r\n}

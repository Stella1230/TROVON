static void sub22 (char b, char c)\r\n{\r\nint i;\r\nfor(i = 0; i < 3; ++i) {\r\ninb(0x3f6);\r\noutb_p(b,0xb0);\r\ninb(0x3f6);\r\noutb_p(c,0xb4);\r\ninb(0x3f6);\r\nif(inb(0xb4) == c) {\r\noutb_p(7,0xb0);\r\ninb(0x3f6);\r\nreturn;\r\n}\r\n}\r\n}\r\nstatic void dtc2278_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nunsigned long flags;\r\nif (drive->pio_mode >= XFER_PIO_3) {\r\nspin_lock_irqsave(&dtc2278_lock, flags);\r\nsub22(1,0xc3);\r\nsub22(0,0xa0);\r\nspin_unlock_irqrestore(&dtc2278_lock, flags);\r\n} else {\r\n}\r\n}\r\nstatic int __init dtc2278_probe(void)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\noutb_p(4,0xb0);\r\ninb(0x3f6);\r\noutb_p(0x20,0xb4);\r\ninb(0x3f6);\r\n#ifdef ALWAYS_SET_DTC2278_PIO_MODE\r\nsub22(1,0xc3);\r\nsub22(0,0xa0);\r\n#endif\r\nlocal_irq_restore(flags);\r\nreturn ide_legacy_device_add(&dtc2278_port_info, 0);\r\n}\r\nstatic int __init dtc2278_init(void)\r\n{\r\nif (probe_dtc2278 == 0)\r\nreturn -ENODEV;\r\nif (dtc2278_probe()) {\r\nprintk(KERN_ERR "dtc2278: ide interfaces already in use!\n");\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}

static void lms283gf05_reset(unsigned long gpio, bool inverted)\r\n{\r\ngpio_set_value(gpio, !inverted);\r\nmdelay(100);\r\ngpio_set_value(gpio, inverted);\r\nmdelay(20);\r\ngpio_set_value(gpio, !inverted);\r\nmdelay(20);\r\n}\r\nstatic void lms283gf05_toggle(struct spi_device *spi,\r\nconst struct lms283gf05_seq *seq, int sz)\r\n{\r\nchar buf[3];\r\nint i;\r\nfor (i = 0; i < sz; i++) {\r\nbuf[0] = 0x74;\r\nbuf[1] = 0x00;\r\nbuf[2] = seq[i].reg;\r\nspi_write(spi, buf, 3);\r\nbuf[0] = 0x76;\r\nbuf[1] = seq[i].value >> 8;\r\nbuf[2] = seq[i].value & 0xff;\r\nspi_write(spi, buf, 3);\r\nmdelay(seq[i].delay);\r\n}\r\n}\r\nstatic int lms283gf05_power_set(struct lcd_device *ld, int power)\r\n{\r\nstruct lms283gf05_state *st = lcd_get_data(ld);\r\nstruct spi_device *spi = st->spi;\r\nstruct lms283gf05_pdata *pdata = dev_get_platdata(&spi->dev);\r\nif (power <= FB_BLANK_NORMAL) {\r\nif (pdata)\r\nlms283gf05_reset(pdata->reset_gpio,\r\npdata->reset_inverted);\r\nlms283gf05_toggle(spi, disp_initseq, ARRAY_SIZE(disp_initseq));\r\n} else {\r\nlms283gf05_toggle(spi, disp_pdwnseq, ARRAY_SIZE(disp_pdwnseq));\r\nif (pdata)\r\ngpio_set_value(pdata->reset_gpio,\r\npdata->reset_inverted);\r\n}\r\nreturn 0;\r\n}\r\nstatic int lms283gf05_probe(struct spi_device *spi)\r\n{\r\nstruct lms283gf05_state *st;\r\nstruct lms283gf05_pdata *pdata = dev_get_platdata(&spi->dev);\r\nstruct lcd_device *ld;\r\nint ret = 0;\r\nif (pdata != NULL) {\r\nret = devm_gpio_request_one(&spi->dev, pdata->reset_gpio,\r\nGPIOF_DIR_OUT | (!pdata->reset_inverted ?\r\nGPIOF_INIT_HIGH : GPIOF_INIT_LOW),\r\n"LMS285GF05 RESET");\r\nif (ret)\r\nreturn ret;\r\n}\r\nst = devm_kzalloc(&spi->dev, sizeof(struct lms283gf05_state),\r\nGFP_KERNEL);\r\nif (st == NULL)\r\nreturn -ENOMEM;\r\nld = devm_lcd_device_register(&spi->dev, "lms283gf05", &spi->dev, st,\r\n&lms_ops);\r\nif (IS_ERR(ld))\r\nreturn PTR_ERR(ld);\r\nst->spi = spi;\r\nst->ld = ld;\r\nspi_set_drvdata(spi, st);\r\nif (pdata)\r\nlms283gf05_reset(pdata->reset_gpio, pdata->reset_inverted);\r\nlms283gf05_toggle(spi, disp_initseq, ARRAY_SIZE(disp_initseq));\r\nreturn 0;\r\n}

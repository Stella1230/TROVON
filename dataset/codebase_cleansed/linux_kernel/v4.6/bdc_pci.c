static int bdc_setup_msi(struct pci_dev *pci)\r\n{\r\nint ret;\r\nret = pci_enable_msi(pci);\r\nif (ret) {\r\npr_err("failed to allocate MSI entry\n");\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic int bdc_pci_probe(struct pci_dev *pci, const struct pci_device_id *id)\r\n{\r\nstruct resource res[2];\r\nstruct platform_device *bdc;\r\nstruct bdc_pci *glue;\r\nint ret = -ENOMEM;\r\nglue = devm_kzalloc(&pci->dev, sizeof(*glue), GFP_KERNEL);\r\nif (!glue)\r\nreturn -ENOMEM;\r\nglue->dev = &pci->dev;\r\nret = pci_enable_device(pci);\r\nif (ret) {\r\ndev_err(&pci->dev, "failed to enable pci device\n");\r\nreturn -ENODEV;\r\n}\r\npci_set_master(pci);\r\nbdc = platform_device_alloc(BRCM_BDC_NAME, PLATFORM_DEVID_AUTO);\r\nif (!bdc)\r\nreturn -ENOMEM;\r\nmemset(res, 0x00, sizeof(struct resource) * ARRAY_SIZE(res));\r\nbdc_setup_msi(pci);\r\nres[0].start = pci_resource_start(pci, 0);\r\nres[0].end = pci_resource_end(pci, 0);\r\nres[0].name = BRCM_BDC_NAME;\r\nres[0].flags = IORESOURCE_MEM;\r\nres[1].start = pci->irq;\r\nres[1].name = BRCM_BDC_NAME;\r\nres[1].flags = IORESOURCE_IRQ;\r\nret = platform_device_add_resources(bdc, res, ARRAY_SIZE(res));\r\nif (ret) {\r\ndev_err(&pci->dev,\r\n"couldn't add resources to bdc device\n");\r\nreturn ret;\r\n}\r\npci_set_drvdata(pci, glue);\r\ndma_set_coherent_mask(&bdc->dev, pci->dev.coherent_dma_mask);\r\nbdc->dev.dma_mask = pci->dev.dma_mask;\r\nbdc->dev.dma_parms = pci->dev.dma_parms;\r\nbdc->dev.parent = &pci->dev;\r\nglue->bdc = bdc;\r\nret = platform_device_add(bdc);\r\nif (ret) {\r\ndev_err(&pci->dev, "failed to register bdc device\n");\r\nplatform_device_put(bdc);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void bdc_pci_remove(struct pci_dev *pci)\r\n{\r\nstruct bdc_pci *glue = pci_get_drvdata(pci);\r\nplatform_device_unregister(glue->bdc);\r\npci_disable_msi(pci);\r\n}

static int __init amiga_a4000t_scsi_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nphys_addr_t scsi_addr;\r\nstruct NCR_700_Host_Parameters *hostdata;\r\nstruct Scsi_Host *host;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\nif (!request_mem_region(res->start, resource_size(res),\r\n"A4000T builtin SCSI"))\r\nreturn -EBUSY;\r\nhostdata = kzalloc(sizeof(struct NCR_700_Host_Parameters),\r\nGFP_KERNEL);\r\nif (!hostdata) {\r\ndev_err(&pdev->dev, "Failed to allocate host data\n");\r\ngoto out_release;\r\n}\r\nscsi_addr = res->start + A4000T_SCSI_OFFSET;\r\nhostdata->base = ZTWO_VADDR(scsi_addr);\r\nhostdata->clock = 50;\r\nhostdata->chip710 = 1;\r\nhostdata->dmode_extra = DMODE_FC2;\r\nhostdata->dcntl_extra = EA_710;\r\nhost = NCR_700_detect(&a4000t_scsi_driver_template, hostdata,\r\n&pdev->dev);\r\nif (!host) {\r\ndev_err(&pdev->dev,\r\n"No host detected; board configuration problem?\n");\r\ngoto out_free;\r\n}\r\nhost->this_id = 7;\r\nhost->base = scsi_addr;\r\nhost->irq = IRQ_AMIGA_PORTS;\r\nif (request_irq(host->irq, NCR_700_intr, IRQF_SHARED, "a4000t-scsi",\r\nhost)) {\r\ndev_err(&pdev->dev, "request_irq failed\n");\r\ngoto out_put_host;\r\n}\r\nplatform_set_drvdata(pdev, host);\r\nscsi_scan_host(host);\r\nreturn 0;\r\nout_put_host:\r\nscsi_host_put(host);\r\nout_free:\r\nkfree(hostdata);\r\nout_release:\r\nrelease_mem_region(res->start, resource_size(res));\r\nreturn -ENODEV;\r\n}\r\nstatic int __exit amiga_a4000t_scsi_remove(struct platform_device *pdev)\r\n{\r\nstruct Scsi_Host *host = platform_get_drvdata(pdev);\r\nstruct NCR_700_Host_Parameters *hostdata = shost_priv(host);\r\nstruct resource *res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nscsi_remove_host(host);\r\nNCR_700_release(host);\r\nkfree(hostdata);\r\nfree_irq(host->irq, host);\r\nrelease_mem_region(res->start, resource_size(res));\r\nreturn 0;\r\n}

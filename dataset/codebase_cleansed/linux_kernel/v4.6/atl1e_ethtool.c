static int atl1e_get_settings(struct net_device *netdev,\r\nstruct ethtool_cmd *ecmd)\r\n{\r\nstruct atl1e_adapter *adapter = netdev_priv(netdev);\r\nstruct atl1e_hw *hw = &adapter->hw;\r\necmd->supported = (SUPPORTED_10baseT_Half |\r\nSUPPORTED_10baseT_Full |\r\nSUPPORTED_100baseT_Half |\r\nSUPPORTED_100baseT_Full |\r\nSUPPORTED_Autoneg |\r\nSUPPORTED_TP);\r\nif (hw->nic_type == athr_l1e)\r\necmd->supported |= SUPPORTED_1000baseT_Full;\r\necmd->advertising = ADVERTISED_TP;\r\necmd->advertising |= ADVERTISED_Autoneg;\r\necmd->advertising |= hw->autoneg_advertised;\r\necmd->port = PORT_TP;\r\necmd->phy_address = 0;\r\necmd->transceiver = XCVR_INTERNAL;\r\nif (adapter->link_speed != SPEED_0) {\r\nethtool_cmd_speed_set(ecmd, adapter->link_speed);\r\nif (adapter->link_duplex == FULL_DUPLEX)\r\necmd->duplex = DUPLEX_FULL;\r\nelse\r\necmd->duplex = DUPLEX_HALF;\r\n} else {\r\nethtool_cmd_speed_set(ecmd, SPEED_UNKNOWN);\r\necmd->duplex = DUPLEX_UNKNOWN;\r\n}\r\necmd->autoneg = AUTONEG_ENABLE;\r\nreturn 0;\r\n}\r\nstatic int atl1e_set_settings(struct net_device *netdev,\r\nstruct ethtool_cmd *ecmd)\r\n{\r\nstruct atl1e_adapter *adapter = netdev_priv(netdev);\r\nstruct atl1e_hw *hw = &adapter->hw;\r\nwhile (test_and_set_bit(__AT_RESETTING, &adapter->flags))\r\nmsleep(1);\r\nif (ecmd->autoneg == AUTONEG_ENABLE) {\r\nu16 adv4, adv9;\r\nif ((ecmd->advertising&ADVERTISE_1000_FULL)) {\r\nif (hw->nic_type == athr_l1e) {\r\nhw->autoneg_advertised =\r\necmd->advertising & AT_ADV_MASK;\r\n} else {\r\nclear_bit(__AT_RESETTING, &adapter->flags);\r\nreturn -EINVAL;\r\n}\r\n} else if (ecmd->advertising&ADVERTISE_1000_HALF) {\r\nclear_bit(__AT_RESETTING, &adapter->flags);\r\nreturn -EINVAL;\r\n} else {\r\nhw->autoneg_advertised =\r\necmd->advertising & AT_ADV_MASK;\r\n}\r\necmd->advertising = hw->autoneg_advertised |\r\nADVERTISED_TP | ADVERTISED_Autoneg;\r\nadv4 = hw->mii_autoneg_adv_reg & ~ADVERTISE_ALL;\r\nadv9 = hw->mii_1000t_ctrl_reg & ~MII_AT001_CR_1000T_SPEED_MASK;\r\nif (hw->autoneg_advertised & ADVERTISE_10_HALF)\r\nadv4 |= ADVERTISE_10HALF;\r\nif (hw->autoneg_advertised & ADVERTISE_10_FULL)\r\nadv4 |= ADVERTISE_10FULL;\r\nif (hw->autoneg_advertised & ADVERTISE_100_HALF)\r\nadv4 |= ADVERTISE_100HALF;\r\nif (hw->autoneg_advertised & ADVERTISE_100_FULL)\r\nadv4 |= ADVERTISE_100FULL;\r\nif (hw->autoneg_advertised & ADVERTISE_1000_FULL)\r\nadv9 |= ADVERTISE_1000FULL;\r\nif (adv4 != hw->mii_autoneg_adv_reg ||\r\nadv9 != hw->mii_1000t_ctrl_reg) {\r\nhw->mii_autoneg_adv_reg = adv4;\r\nhw->mii_1000t_ctrl_reg = adv9;\r\nhw->re_autoneg = true;\r\n}\r\n} else {\r\nclear_bit(__AT_RESETTING, &adapter->flags);\r\nreturn -EINVAL;\r\n}\r\nif (netif_running(adapter->netdev)) {\r\natl1e_down(adapter);\r\natl1e_up(adapter);\r\n} else\r\natl1e_reset_hw(&adapter->hw);\r\nclear_bit(__AT_RESETTING, &adapter->flags);\r\nreturn 0;\r\n}\r\nstatic u32 atl1e_get_msglevel(struct net_device *netdev)\r\n{\r\n#ifdef DBG\r\nreturn 1;\r\n#else\r\nreturn 0;\r\n#endif\r\n}\r\nstatic int atl1e_get_regs_len(struct net_device *netdev)\r\n{\r\nreturn AT_REGS_LEN * sizeof(u32);\r\n}\r\nstatic void atl1e_get_regs(struct net_device *netdev,\r\nstruct ethtool_regs *regs, void *p)\r\n{\r\nstruct atl1e_adapter *adapter = netdev_priv(netdev);\r\nstruct atl1e_hw *hw = &adapter->hw;\r\nu32 *regs_buff = p;\r\nu16 phy_data;\r\nmemset(p, 0, AT_REGS_LEN * sizeof(u32));\r\nregs->version = (1 << 24) | (hw->revision_id << 16) | hw->device_id;\r\nregs_buff[0] = AT_READ_REG(hw, REG_VPD_CAP);\r\nregs_buff[1] = AT_READ_REG(hw, REG_SPI_FLASH_CTRL);\r\nregs_buff[2] = AT_READ_REG(hw, REG_SPI_FLASH_CONFIG);\r\nregs_buff[3] = AT_READ_REG(hw, REG_TWSI_CTRL);\r\nregs_buff[4] = AT_READ_REG(hw, REG_PCIE_DEV_MISC_CTRL);\r\nregs_buff[5] = AT_READ_REG(hw, REG_MASTER_CTRL);\r\nregs_buff[6] = AT_READ_REG(hw, REG_MANUAL_TIMER_INIT);\r\nregs_buff[7] = AT_READ_REG(hw, REG_IRQ_MODU_TIMER_INIT);\r\nregs_buff[8] = AT_READ_REG(hw, REG_GPHY_CTRL);\r\nregs_buff[9] = AT_READ_REG(hw, REG_CMBDISDMA_TIMER);\r\nregs_buff[10] = AT_READ_REG(hw, REG_IDLE_STATUS);\r\nregs_buff[11] = AT_READ_REG(hw, REG_MDIO_CTRL);\r\nregs_buff[12] = AT_READ_REG(hw, REG_SERDES_LOCK);\r\nregs_buff[13] = AT_READ_REG(hw, REG_MAC_CTRL);\r\nregs_buff[14] = AT_READ_REG(hw, REG_MAC_IPG_IFG);\r\nregs_buff[15] = AT_READ_REG(hw, REG_MAC_STA_ADDR);\r\nregs_buff[16] = AT_READ_REG(hw, REG_MAC_STA_ADDR+4);\r\nregs_buff[17] = AT_READ_REG(hw, REG_RX_HASH_TABLE);\r\nregs_buff[18] = AT_READ_REG(hw, REG_RX_HASH_TABLE+4);\r\nregs_buff[19] = AT_READ_REG(hw, REG_MAC_HALF_DUPLX_CTRL);\r\nregs_buff[20] = AT_READ_REG(hw, REG_MTU);\r\nregs_buff[21] = AT_READ_REG(hw, REG_WOL_CTRL);\r\nregs_buff[22] = AT_READ_REG(hw, REG_SRAM_TRD_ADDR);\r\nregs_buff[23] = AT_READ_REG(hw, REG_SRAM_TRD_LEN);\r\nregs_buff[24] = AT_READ_REG(hw, REG_SRAM_RXF_ADDR);\r\nregs_buff[25] = AT_READ_REG(hw, REG_SRAM_RXF_LEN);\r\nregs_buff[26] = AT_READ_REG(hw, REG_SRAM_TXF_ADDR);\r\nregs_buff[27] = AT_READ_REG(hw, REG_SRAM_TXF_LEN);\r\nregs_buff[28] = AT_READ_REG(hw, REG_SRAM_TCPH_ADDR);\r\nregs_buff[29] = AT_READ_REG(hw, REG_SRAM_PKTH_ADDR);\r\natl1e_read_phy_reg(hw, MII_BMCR, &phy_data);\r\nregs_buff[73] = (u32)phy_data;\r\natl1e_read_phy_reg(hw, MII_BMSR, &phy_data);\r\nregs_buff[74] = (u32)phy_data;\r\n}\r\nstatic int atl1e_get_eeprom_len(struct net_device *netdev)\r\n{\r\nstruct atl1e_adapter *adapter = netdev_priv(netdev);\r\nif (!atl1e_check_eeprom_exist(&adapter->hw))\r\nreturn AT_EEPROM_LEN;\r\nelse\r\nreturn 0;\r\n}\r\nstatic int atl1e_get_eeprom(struct net_device *netdev,\r\nstruct ethtool_eeprom *eeprom, u8 *bytes)\r\n{\r\nstruct atl1e_adapter *adapter = netdev_priv(netdev);\r\nstruct atl1e_hw *hw = &adapter->hw;\r\nu32 *eeprom_buff;\r\nint first_dword, last_dword;\r\nint ret_val = 0;\r\nint i;\r\nif (eeprom->len == 0)\r\nreturn -EINVAL;\r\nif (atl1e_check_eeprom_exist(hw))\r\nreturn -EINVAL;\r\neeprom->magic = hw->vendor_id | (hw->device_id << 16);\r\nfirst_dword = eeprom->offset >> 2;\r\nlast_dword = (eeprom->offset + eeprom->len - 1) >> 2;\r\neeprom_buff = kmalloc(sizeof(u32) *\r\n(last_dword - first_dword + 1), GFP_KERNEL);\r\nif (eeprom_buff == NULL)\r\nreturn -ENOMEM;\r\nfor (i = first_dword; i < last_dword; i++) {\r\nif (!atl1e_read_eeprom(hw, i * 4, &(eeprom_buff[i-first_dword]))) {\r\nkfree(eeprom_buff);\r\nreturn -EIO;\r\n}\r\n}\r\nmemcpy(bytes, (u8 *)eeprom_buff + (eeprom->offset & 3),\r\neeprom->len);\r\nkfree(eeprom_buff);\r\nreturn ret_val;\r\n}\r\nstatic int atl1e_set_eeprom(struct net_device *netdev,\r\nstruct ethtool_eeprom *eeprom, u8 *bytes)\r\n{\r\nstruct atl1e_adapter *adapter = netdev_priv(netdev);\r\nstruct atl1e_hw *hw = &adapter->hw;\r\nu32 *eeprom_buff;\r\nu32 *ptr;\r\nint first_dword, last_dword;\r\nint ret_val = 0;\r\nint i;\r\nif (eeprom->len == 0)\r\nreturn -EOPNOTSUPP;\r\nif (eeprom->magic != (hw->vendor_id | (hw->device_id << 16)))\r\nreturn -EINVAL;\r\nfirst_dword = eeprom->offset >> 2;\r\nlast_dword = (eeprom->offset + eeprom->len - 1) >> 2;\r\neeprom_buff = kmalloc(AT_EEPROM_LEN, GFP_KERNEL);\r\nif (eeprom_buff == NULL)\r\nreturn -ENOMEM;\r\nptr = eeprom_buff;\r\nif (eeprom->offset & 3) {\r\nif (!atl1e_read_eeprom(hw, first_dword * 4, &(eeprom_buff[0]))) {\r\nret_val = -EIO;\r\ngoto out;\r\n}\r\nptr++;\r\n}\r\nif (((eeprom->offset + eeprom->len) & 3)) {\r\nif (!atl1e_read_eeprom(hw, last_dword * 4,\r\n&(eeprom_buff[last_dword - first_dword]))) {\r\nret_val = -EIO;\r\ngoto out;\r\n}\r\n}\r\nmemcpy(ptr, bytes, eeprom->len);\r\nfor (i = 0; i < last_dword - first_dword + 1; i++) {\r\nif (!atl1e_write_eeprom(hw, ((first_dword + i) * 4),\r\neeprom_buff[i])) {\r\nret_val = -EIO;\r\ngoto out;\r\n}\r\n}\r\nout:\r\nkfree(eeprom_buff);\r\nreturn ret_val;\r\n}\r\nstatic void atl1e_get_drvinfo(struct net_device *netdev,\r\nstruct ethtool_drvinfo *drvinfo)\r\n{\r\nstruct atl1e_adapter *adapter = netdev_priv(netdev);\r\nstrlcpy(drvinfo->driver, atl1e_driver_name, sizeof(drvinfo->driver));\r\nstrlcpy(drvinfo->version, atl1e_driver_version,\r\nsizeof(drvinfo->version));\r\nstrlcpy(drvinfo->fw_version, "L1e", sizeof(drvinfo->fw_version));\r\nstrlcpy(drvinfo->bus_info, pci_name(adapter->pdev),\r\nsizeof(drvinfo->bus_info));\r\n}\r\nstatic void atl1e_get_wol(struct net_device *netdev,\r\nstruct ethtool_wolinfo *wol)\r\n{\r\nstruct atl1e_adapter *adapter = netdev_priv(netdev);\r\nwol->supported = WAKE_MAGIC | WAKE_PHY;\r\nwol->wolopts = 0;\r\nif (adapter->wol & AT_WUFC_EX)\r\nwol->wolopts |= WAKE_UCAST;\r\nif (adapter->wol & AT_WUFC_MC)\r\nwol->wolopts |= WAKE_MCAST;\r\nif (adapter->wol & AT_WUFC_BC)\r\nwol->wolopts |= WAKE_BCAST;\r\nif (adapter->wol & AT_WUFC_MAG)\r\nwol->wolopts |= WAKE_MAGIC;\r\nif (adapter->wol & AT_WUFC_LNKC)\r\nwol->wolopts |= WAKE_PHY;\r\n}\r\nstatic int atl1e_set_wol(struct net_device *netdev, struct ethtool_wolinfo *wol)\r\n{\r\nstruct atl1e_adapter *adapter = netdev_priv(netdev);\r\nif (wol->wolopts & (WAKE_ARP | WAKE_MAGICSECURE |\r\nWAKE_UCAST | WAKE_MCAST | WAKE_BCAST))\r\nreturn -EOPNOTSUPP;\r\nadapter->wol = 0;\r\nif (wol->wolopts & WAKE_MAGIC)\r\nadapter->wol |= AT_WUFC_MAG;\r\nif (wol->wolopts & WAKE_PHY)\r\nadapter->wol |= AT_WUFC_LNKC;\r\ndevice_set_wakeup_enable(&adapter->pdev->dev, adapter->wol);\r\nreturn 0;\r\n}\r\nstatic int atl1e_nway_reset(struct net_device *netdev)\r\n{\r\nstruct atl1e_adapter *adapter = netdev_priv(netdev);\r\nif (netif_running(netdev))\r\natl1e_reinit_locked(adapter);\r\nreturn 0;\r\n}\r\nvoid atl1e_set_ethtool_ops(struct net_device *netdev)\r\n{\r\nnetdev->ethtool_ops = &atl1e_ethtool_ops;\r\n}

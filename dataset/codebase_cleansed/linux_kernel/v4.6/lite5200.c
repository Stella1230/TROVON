static void __init\r\nlite5200_fix_clock_config(void)\r\n{\r\nstruct device_node *np;\r\nstruct mpc52xx_cdm __iomem *cdm;\r\nnp = of_find_matching_node(NULL, mpc5200_cdm_ids);\r\ncdm = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!cdm) {\r\nprintk(KERN_ERR "%s() failed; expect abnormal behaviour\n",\r\n__func__);\r\nreturn;\r\n}\r\nout_8(&cdm->ext_48mhz_en, 0x00);\r\nout_8(&cdm->fd_enable, 0x01);\r\nif (in_be32(&cdm->rstcfg) & 0x40)\r\nout_be16(&cdm->fd_counters, 0x0001);\r\nelse\r\nout_be16(&cdm->fd_counters, 0x5555);\r\niounmap(cdm);\r\n}\r\nstatic void __init\r\nlite5200_fix_port_config(void)\r\n{\r\nstruct device_node *np;\r\nstruct mpc52xx_gpio __iomem *gpio;\r\nu32 port_config;\r\nnp = of_find_matching_node(NULL, mpc5200_gpio_ids);\r\ngpio = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!gpio) {\r\nprintk(KERN_ERR "%s() failed. expect abnormal behavior\n",\r\n__func__);\r\nreturn;\r\n}\r\nport_config = in_be32(&gpio->port_config);\r\nport_config &= ~0x00800000;\r\nport_config &= ~0x00007000;\r\nport_config |= 0x00001000;\r\nport_config &= ~0x03000000;\r\nport_config |= 0x01000000;\r\npr_debug("port_config: old:%x new:%x\n",\r\nin_be32(&gpio->port_config), port_config);\r\nout_be32(&gpio->port_config, port_config);\r\niounmap(gpio);\r\n}\r\nstatic void lite5200_suspend_prepare(void __iomem *mbar)\r\n{\r\nu8 pin = 1;\r\nu8 level = 0;\r\nmpc52xx_set_wakeup_gpio(pin, level);\r\nout_be32(mbar + 0x1048, in_be32(mbar + 0x1048) & ~0x300);\r\nout_be32(mbar + 0x1050, 0x00000001);\r\n}\r\nstatic void lite5200_resume_finish(void __iomem *mbar)\r\n{\r\nout_be32(mbar + 0x1050, 0x00010000);\r\n}\r\nstatic void __init lite5200_setup_arch(void)\r\n{\r\nif (ppc_md.progress)\r\nppc_md.progress("lite5200_setup_arch()", 0);\r\nmpc52xx_map_common_devices();\r\nmpc5200_setup_xlb_arbiter();\r\nlite5200_fix_clock_config();\r\nlite5200_fix_port_config();\r\n#ifdef CONFIG_PM\r\nmpc52xx_suspend.board_suspend_prepare = lite5200_suspend_prepare;\r\nmpc52xx_suspend.board_resume_finish = lite5200_resume_finish;\r\nlite5200_pm_init();\r\n#endif\r\nmpc52xx_setup_pci();\r\n}\r\nstatic int __init lite5200_probe(void)\r\n{\r\nreturn of_flat_dt_match(of_get_flat_dt_root(), board);\r\n}

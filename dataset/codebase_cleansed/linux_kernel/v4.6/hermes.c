static int hermes_issue_cmd(struct hermes *hw, u16 cmd, u16 param0,\r\nu16 param1, u16 param2)\r\n{\r\nint k = CMD_BUSY_TIMEOUT;\r\nu16 reg;\r\nreg = hermes_read_regn(hw, CMD);\r\nwhile ((reg & HERMES_CMD_BUSY) && k) {\r\nk--;\r\nudelay(1);\r\nreg = hermes_read_regn(hw, CMD);\r\n}\r\nif (reg & HERMES_CMD_BUSY)\r\nreturn -EBUSY;\r\nhermes_write_regn(hw, PARAM2, param2);\r\nhermes_write_regn(hw, PARAM1, param1);\r\nhermes_write_regn(hw, PARAM0, param0);\r\nhermes_write_regn(hw, CMD, cmd);\r\nreturn 0;\r\n}\r\nstatic int hermes_doicmd_wait(struct hermes *hw, u16 cmd,\r\nu16 parm0, u16 parm1, u16 parm2,\r\nstruct hermes_response *resp)\r\n{\r\nint err = 0;\r\nint k;\r\nu16 status, reg;\r\nerr = hermes_issue_cmd(hw, cmd, parm0, parm1, parm2);\r\nif (err)\r\nreturn err;\r\nreg = hermes_read_regn(hw, EVSTAT);\r\nk = CMD_INIT_TIMEOUT;\r\nwhile ((!(reg & HERMES_EV_CMD)) && k) {\r\nk--;\r\nudelay(10);\r\nreg = hermes_read_regn(hw, EVSTAT);\r\n}\r\nhermes_write_regn(hw, SWSUPPORT0, HERMES_MAGIC);\r\nif (!hermes_present(hw)) {\r\nDEBUG(0, "hermes @ 0x%x: Card removed during reset.\n",\r\nhw->iobase);\r\nerr = -ENODEV;\r\ngoto out;\r\n}\r\nif (!(reg & HERMES_EV_CMD)) {\r\nprintk(KERN_ERR "hermes @ %p: "\r\n"Timeout waiting for card to reset (reg=0x%04x)!\n",\r\nhw->iobase, reg);\r\nerr = -ETIMEDOUT;\r\ngoto out;\r\n}\r\nstatus = hermes_read_regn(hw, STATUS);\r\nif (resp) {\r\nresp->status = status;\r\nresp->resp0 = hermes_read_regn(hw, RESP0);\r\nresp->resp1 = hermes_read_regn(hw, RESP1);\r\nresp->resp2 = hermes_read_regn(hw, RESP2);\r\n}\r\nhermes_write_regn(hw, EVACK, HERMES_EV_CMD);\r\nif (status & HERMES_STATUS_RESULT)\r\nerr = -EIO;\r\nout:\r\nreturn err;\r\n}\r\nvoid hermes_struct_init(struct hermes *hw, void __iomem *address,\r\nint reg_spacing)\r\n{\r\nhw->iobase = address;\r\nhw->reg_spacing = reg_spacing;\r\nhw->inten = 0x0;\r\nhw->eeprom_pda = false;\r\nhw->ops = &hermes_ops_local;\r\n}\r\nstatic int hermes_init(struct hermes *hw)\r\n{\r\nu16 reg;\r\nint err = 0;\r\nint k;\r\nhw->inten = 0x0;\r\nhermes_write_regn(hw, INTEN, 0);\r\nhermes_write_regn(hw, EVACK, 0xffff);\r\nk = CMD_BUSY_TIMEOUT;\r\nreg = hermes_read_regn(hw, CMD);\r\nwhile (k && (reg & HERMES_CMD_BUSY)) {\r\nif (reg == 0xffff)\r\nreturn -ENODEV;\r\nk--;\r\nudelay(1);\r\nreg = hermes_read_regn(hw, CMD);\r\n}\r\nreg = hermes_read_regn(hw, EVSTAT);\r\nhermes_write_regn(hw, EVACK, reg);\r\nerr = hermes_doicmd_wait(hw, HERMES_CMD_INIT, 0, 0, 0, NULL);\r\nreturn err;\r\n}\r\nstatic int hermes_docmd_wait(struct hermes *hw, u16 cmd, u16 parm0,\r\nstruct hermes_response *resp)\r\n{\r\nint err;\r\nint k;\r\nu16 reg;\r\nu16 status;\r\nerr = hermes_issue_cmd(hw, cmd, parm0, 0, 0);\r\nif (err) {\r\nif (!hermes_present(hw)) {\r\nif (net_ratelimit())\r\nprintk(KERN_WARNING "hermes @ %p: "\r\n"Card removed while issuing command "\r\n"0x%04x.\n", hw->iobase, cmd);\r\nerr = -ENODEV;\r\n} else\r\nif (net_ratelimit())\r\nprintk(KERN_ERR "hermes @ %p: "\r\n"Error %d issuing command 0x%04x.\n",\r\nhw->iobase, err, cmd);\r\ngoto out;\r\n}\r\nreg = hermes_read_regn(hw, EVSTAT);\r\nk = CMD_COMPL_TIMEOUT;\r\nwhile ((!(reg & HERMES_EV_CMD)) && k) {\r\nk--;\r\nudelay(10);\r\nreg = hermes_read_regn(hw, EVSTAT);\r\n}\r\nif (!hermes_present(hw)) {\r\nprintk(KERN_WARNING "hermes @ %p: Card removed "\r\n"while waiting for command 0x%04x completion.\n",\r\nhw->iobase, cmd);\r\nerr = -ENODEV;\r\ngoto out;\r\n}\r\nif (!(reg & HERMES_EV_CMD)) {\r\nprintk(KERN_ERR "hermes @ %p: Timeout waiting for "\r\n"command 0x%04x completion.\n", hw->iobase, cmd);\r\nerr = -ETIMEDOUT;\r\ngoto out;\r\n}\r\nstatus = hermes_read_regn(hw, STATUS);\r\nif (resp) {\r\nresp->status = status;\r\nresp->resp0 = hermes_read_regn(hw, RESP0);\r\nresp->resp1 = hermes_read_regn(hw, RESP1);\r\nresp->resp2 = hermes_read_regn(hw, RESP2);\r\n}\r\nhermes_write_regn(hw, EVACK, HERMES_EV_CMD);\r\nif (status & HERMES_STATUS_RESULT)\r\nerr = -EIO;\r\nout:\r\nreturn err;\r\n}\r\nstatic int hermes_allocate(struct hermes *hw, u16 size, u16 *fid)\r\n{\r\nint err = 0;\r\nint k;\r\nu16 reg;\r\nif ((size < HERMES_ALLOC_LEN_MIN) || (size > HERMES_ALLOC_LEN_MAX))\r\nreturn -EINVAL;\r\nerr = hermes_docmd_wait(hw, HERMES_CMD_ALLOC, size, NULL);\r\nif (err)\r\nreturn err;\r\nreg = hermes_read_regn(hw, EVSTAT);\r\nk = ALLOC_COMPL_TIMEOUT;\r\nwhile ((!(reg & HERMES_EV_ALLOC)) && k) {\r\nk--;\r\nudelay(10);\r\nreg = hermes_read_regn(hw, EVSTAT);\r\n}\r\nif (!hermes_present(hw)) {\r\nprintk(KERN_WARNING "hermes @ %p: "\r\n"Card removed waiting for frame allocation.\n",\r\nhw->iobase);\r\nreturn -ENODEV;\r\n}\r\nif (!(reg & HERMES_EV_ALLOC)) {\r\nprintk(KERN_ERR "hermes @ %p: "\r\n"Timeout waiting for frame allocation\n",\r\nhw->iobase);\r\nreturn -ETIMEDOUT;\r\n}\r\n*fid = hermes_read_regn(hw, ALLOCFID);\r\nhermes_write_regn(hw, EVACK, HERMES_EV_ALLOC);\r\nreturn 0;\r\n}\r\nstatic int hermes_bap_seek(struct hermes *hw, int bap, u16 id, u16 offset)\r\n{\r\nint sreg = bap ? HERMES_SELECT1 : HERMES_SELECT0;\r\nint oreg = bap ? HERMES_OFFSET1 : HERMES_OFFSET0;\r\nint k;\r\nu16 reg;\r\nif ((offset > HERMES_BAP_OFFSET_MAX) || (offset % 2))\r\nreturn -EINVAL;\r\nk = HERMES_BAP_BUSY_TIMEOUT;\r\nreg = hermes_read_reg(hw, oreg);\r\nwhile ((reg & HERMES_OFFSET_BUSY) && k) {\r\nk--;\r\nudelay(1);\r\nreg = hermes_read_reg(hw, oreg);\r\n}\r\nif (reg & HERMES_OFFSET_BUSY)\r\nreturn -ETIMEDOUT;\r\nhermes_write_reg(hw, sreg, id);\r\nhermes_write_reg(hw, oreg, offset);\r\nk = HERMES_BAP_BUSY_TIMEOUT;\r\nreg = hermes_read_reg(hw, oreg);\r\nwhile ((reg & (HERMES_OFFSET_BUSY | HERMES_OFFSET_ERR)) && k) {\r\nk--;\r\nudelay(1);\r\nreg = hermes_read_reg(hw, oreg);\r\n}\r\nif (reg != offset) {\r\nprintk(KERN_ERR "hermes @ %p: BAP%d offset %s: "\r\n"reg=0x%x id=0x%x offset=0x%x\n", hw->iobase, bap,\r\n(reg & HERMES_OFFSET_BUSY) ? "timeout" : "error",\r\nreg, id, offset);\r\nif (reg & HERMES_OFFSET_BUSY)\r\nreturn -ETIMEDOUT;\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hermes_bap_pread(struct hermes *hw, int bap, void *buf, int len,\r\nu16 id, u16 offset)\r\n{\r\nint dreg = bap ? HERMES_DATA1 : HERMES_DATA0;\r\nint err = 0;\r\nif ((len < 0) || (len % 2))\r\nreturn -EINVAL;\r\nerr = hermes_bap_seek(hw, bap, id, offset);\r\nif (err)\r\ngoto out;\r\nhermes_read_words(hw, dreg, buf, len / 2);\r\nout:\r\nreturn err;\r\n}\r\nstatic int hermes_bap_pwrite(struct hermes *hw, int bap, const void *buf,\r\nint len, u16 id, u16 offset)\r\n{\r\nint dreg = bap ? HERMES_DATA1 : HERMES_DATA0;\r\nint err = 0;\r\nif (len < 0)\r\nreturn -EINVAL;\r\nerr = hermes_bap_seek(hw, bap, id, offset);\r\nif (err)\r\ngoto out;\r\nhermes_write_bytes(hw, dreg, buf, len);\r\nout:\r\nreturn err;\r\n}\r\nstatic int hermes_read_ltv(struct hermes *hw, int bap, u16 rid,\r\nunsigned bufsize, u16 *length, void *buf)\r\n{\r\nint err = 0;\r\nint dreg = bap ? HERMES_DATA1 : HERMES_DATA0;\r\nu16 rlength, rtype;\r\nunsigned nwords;\r\nif (bufsize % 2)\r\nreturn -EINVAL;\r\nerr = hermes_docmd_wait(hw, HERMES_CMD_ACCESS, rid, NULL);\r\nif (err)\r\nreturn err;\r\nerr = hermes_bap_seek(hw, bap, rid, 0);\r\nif (err)\r\nreturn err;\r\nrlength = hermes_read_reg(hw, dreg);\r\nif (!rlength)\r\nreturn -ENODATA;\r\nrtype = hermes_read_reg(hw, dreg);\r\nif (length)\r\n*length = rlength;\r\nif (rtype != rid)\r\nprintk(KERN_WARNING "hermes @ %p: %s(): "\r\n"rid (0x%04x) does not match type (0x%04x)\n",\r\nhw->iobase, __func__, rid, rtype);\r\nif (HERMES_RECLEN_TO_BYTES(rlength) > bufsize)\r\nprintk(KERN_WARNING "hermes @ %p: "\r\n"Truncating LTV record from %d to %d bytes. "\r\n"(rid=0x%04x, len=0x%04x)\n", hw->iobase,\r\nHERMES_RECLEN_TO_BYTES(rlength), bufsize, rid, rlength);\r\nnwords = min((unsigned)rlength - 1, bufsize / 2);\r\nhermes_read_words(hw, dreg, buf, nwords);\r\nreturn 0;\r\n}\r\nstatic int hermes_write_ltv(struct hermes *hw, int bap, u16 rid,\r\nu16 length, const void *value)\r\n{\r\nint dreg = bap ? HERMES_DATA1 : HERMES_DATA0;\r\nint err = 0;\r\nunsigned count;\r\nif (length == 0)\r\nreturn -EINVAL;\r\nerr = hermes_bap_seek(hw, bap, rid, 0);\r\nif (err)\r\nreturn err;\r\nhermes_write_reg(hw, dreg, length);\r\nhermes_write_reg(hw, dreg, rid);\r\ncount = length - 1;\r\nhermes_write_bytes(hw, dreg, value, count << 1);\r\nerr = hermes_docmd_wait(hw, HERMES_CMD_ACCESS | HERMES_CMD_WRITE,\r\nrid, NULL);\r\nreturn err;\r\n}\r\nstatic inline void\r\nhermes_aux_setaddr(struct hermes *hw, u32 addr)\r\n{\r\nhermes_write_reg(hw, HERMES_AUXPAGE, (u16) (addr >> 7));\r\nhermes_write_reg(hw, HERMES_AUXOFFSET, (u16) (addr & 0x7F));\r\n}\r\nstatic inline int\r\nhermes_aux_control(struct hermes *hw, int enabled)\r\n{\r\nint desired_state = enabled ? HERMES_AUX_ENABLED : HERMES_AUX_DISABLED;\r\nint action = enabled ? HERMES_AUX_ENABLE : HERMES_AUX_DISABLE;\r\nint i;\r\nif (hermes_read_reg(hw, HERMES_CONTROL) == desired_state)\r\nreturn 0;\r\nhermes_write_reg(hw, HERMES_PARAM0, HERMES_AUX_PW0);\r\nhermes_write_reg(hw, HERMES_PARAM1, HERMES_AUX_PW1);\r\nhermes_write_reg(hw, HERMES_PARAM2, HERMES_AUX_PW2);\r\nhermes_write_reg(hw, HERMES_CONTROL, action);\r\nfor (i = 0; i < 20; i++) {\r\nudelay(10);\r\nif (hermes_read_reg(hw, HERMES_CONTROL) ==\r\ndesired_state)\r\nreturn 0;\r\n}\r\nreturn -EBUSY;\r\n}\r\nstatic int hermesi_program_init(struct hermes *hw, u32 offset)\r\n{\r\nint err;\r\nhermes_write_regn(hw, EVACK, 0xFFFF);\r\nerr = hw->ops->init_cmd_wait(hw,\r\n0x0100 | HERMES_CMD_INIT,\r\n0, 0, 0, NULL);\r\nif (err)\r\nreturn err;\r\nerr = hw->ops->init_cmd_wait(hw,\r\n0x0000 | HERMES_CMD_INIT,\r\n0, 0, 0, NULL);\r\nif (err)\r\nreturn err;\r\nerr = hermes_aux_control(hw, 1);\r\npr_debug("AUX enable returned %d\n", err);\r\nif (err)\r\nreturn err;\r\npr_debug("Enabling volatile, EP 0x%08x\n", offset);\r\nerr = hw->ops->init_cmd_wait(hw,\r\nHERMES_PROGRAM_ENABLE_VOLATILE,\r\noffset & 0xFFFFu,\r\noffset >> 16,\r\n0,\r\nNULL);\r\npr_debug("PROGRAM_ENABLE returned %d\n", err);\r\nreturn err;\r\n}\r\nstatic int hermesi_program_end(struct hermes *hw)\r\n{\r\nstruct hermes_response resp;\r\nint rc = 0;\r\nint err;\r\nrc = hw->ops->cmd_wait(hw, HERMES_PROGRAM_DISABLE, 0, &resp);\r\npr_debug("PROGRAM_DISABLE returned %d, "\r\n"r0 0x%04x, r1 0x%04x, r2 0x%04x\n",\r\nrc, resp.resp0, resp.resp1, resp.resp2);\r\nif ((rc == 0) &&\r\n((resp.status & HERMES_STATUS_CMDCODE) != HERMES_CMD_DOWNLD))\r\nrc = -EIO;\r\nerr = hermes_aux_control(hw, 0);\r\npr_debug("AUX disable returned %d\n", err);\r\nhermes_write_regn(hw, EVACK, 0xFFFF);\r\n(void) hw->ops->init_cmd_wait(hw, 0x0000 | HERMES_CMD_INIT,\r\n0, 0, 0, NULL);\r\nreturn rc ? rc : err;\r\n}\r\nstatic int hermes_program_bytes(struct hermes *hw, const char *data,\r\nu32 addr, u32 len)\r\n{\r\nhermes_aux_setaddr(hw, addr);\r\nhermes_write_bytes(hw, HERMES_AUXDATA, data, len);\r\nreturn 0;\r\n}\r\nstatic int hermes_read_pda(struct hermes *hw, __le16 *pda, u32 pda_addr,\r\nu16 pda_len)\r\n{\r\nint ret;\r\nu16 pda_size;\r\nu16 data_len = pda_len;\r\n__le16 *data = pda;\r\nif (hw->eeprom_pda) {\r\nret = hw->ops->cmd_wait(hw, HERMES_CMD_READMIF, 0, NULL);\r\nif (ret)\r\nreturn ret;\r\n} else {\r\npda[0] = cpu_to_le16(pda_len - 2);\r\npda[1] = cpu_to_le16(0x0800);\r\ndata_len = pda_len - 4;\r\ndata = pda + 2;\r\n}\r\nret = hermes_aux_control(hw, 1);\r\npr_debug("AUX enable returned %d\n", ret);\r\nif (ret)\r\nreturn ret;\r\nhermes_aux_setaddr(hw, pda_addr);\r\nhermes_read_words(hw, HERMES_AUXDATA, data, data_len / 2);\r\nret = hermes_aux_control(hw, 0);\r\npr_debug("AUX disable returned %d\n", ret);\r\npda_size = le16_to_cpu(pda[0]);\r\npr_debug("Actual PDA length %d, Max allowed %d\n",\r\npda_size, pda_len);\r\nif (pda_size > pda_len)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic void hermes_lock_irqsave(spinlock_t *lock,\r\nunsigned long *flags) __acquires(lock)\r\n{\r\nspin_lock_irqsave(lock, *flags);\r\n}\r\nstatic void hermes_unlock_irqrestore(spinlock_t *lock,\r\nunsigned long *flags) __releases(lock)\r\n{\r\nspin_unlock_irqrestore(lock, *flags);\r\n}\r\nstatic void hermes_lock_irq(spinlock_t *lock) __acquires(lock)\r\n{\r\nspin_lock_irq(lock);\r\n}\r\nstatic void hermes_unlock_irq(spinlock_t *lock) __releases(lock)\r\n{\r\nspin_unlock_irq(lock);\r\n}

static int get_optical_iface_mode(struct snd_dg00x *dg00x,\r\nenum snd_dg00x_optical_mode *mode)\r\n{\r\n__be32 data;\r\nint err;\r\nerr = snd_fw_transaction(dg00x->unit, TCODE_READ_QUADLET_REQUEST,\r\nDG00X_ADDR_BASE + DG00X_OFFSET_OPT_IFACE_MODE,\r\n&data, sizeof(data), 0);\r\nif (err >= 0)\r\n*mode = be32_to_cpu(data) & 0x01;\r\nreturn err;\r\n}\r\nstatic void proc_read_clock(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buf)\r\n{\r\nstatic const char *const source_name[] = {\r\n[SND_DG00X_CLOCK_INTERNAL] = "internal",\r\n[SND_DG00X_CLOCK_SPDIF] = "s/pdif",\r\n[SND_DG00X_CLOCK_ADAT] = "adat",\r\n[SND_DG00X_CLOCK_WORD] = "word clock",\r\n};\r\nstatic const char *const optical_name[] = {\r\n[SND_DG00X_OPT_IFACE_MODE_ADAT] = "adat",\r\n[SND_DG00X_OPT_IFACE_MODE_SPDIF] = "s/pdif",\r\n};\r\nstruct snd_dg00x *dg00x = entry->private_data;\r\nenum snd_dg00x_optical_mode mode;\r\nunsigned int rate;\r\nenum snd_dg00x_clock clock;\r\nbool detect;\r\nif (get_optical_iface_mode(dg00x, &mode) < 0)\r\nreturn;\r\nif (snd_dg00x_stream_get_local_rate(dg00x, &rate) < 0)\r\nreturn;\r\nif (snd_dg00x_stream_get_clock(dg00x, &clock) < 0)\r\nreturn;\r\nsnd_iprintf(buf, "Optical mode: %s\n", optical_name[mode]);\r\nsnd_iprintf(buf, "Sampling Rate: %d\n", rate);\r\nsnd_iprintf(buf, "Clock Source: %s\n", source_name[clock]);\r\nif (clock == SND_DG00X_CLOCK_INTERNAL)\r\nreturn;\r\nif (snd_dg00x_stream_check_external_clock(dg00x, &detect) < 0)\r\nreturn;\r\nsnd_iprintf(buf, "External source: %s\n", detect ? "detected" : "not");\r\nif (!detect)\r\nreturn;\r\nif (snd_dg00x_stream_get_external_rate(dg00x, &rate) >= 0)\r\nsnd_iprintf(buf, "External sampling rate: %d\n", rate);\r\n}\r\nvoid snd_dg00x_proc_init(struct snd_dg00x *dg00x)\r\n{\r\nstruct snd_info_entry *root, *entry;\r\nroot = snd_info_create_card_entry(dg00x->card, "firewire",\r\ndg00x->card->proc_root);\r\nif (root == NULL)\r\nreturn;\r\nroot->mode = S_IFDIR | S_IRUGO | S_IXUGO;\r\nif (snd_info_register(root) < 0) {\r\nsnd_info_free_entry(root);\r\nreturn;\r\n}\r\nentry = snd_info_create_card_entry(dg00x->card, "clock", root);\r\nif (entry == NULL) {\r\nsnd_info_free_entry(root);\r\nreturn;\r\n}\r\nsnd_info_set_text_ops(entry, dg00x, proc_read_clock);\r\nif (snd_info_register(entry) < 0) {\r\nsnd_info_free_entry(entry);\r\nsnd_info_free_entry(root);\r\n}\r\n}

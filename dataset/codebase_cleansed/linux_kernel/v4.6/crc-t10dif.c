__u16 crc_t10dif_update(__u16 crc, const unsigned char *buffer, size_t len)\r\n{\r\nstruct {\r\nstruct shash_desc shash;\r\nchar ctx[2];\r\n} desc;\r\nint err;\r\nif (static_key_false(&crct10dif_fallback))\r\nreturn crc_t10dif_generic(crc, buffer, len);\r\ndesc.shash.tfm = crct10dif_tfm;\r\ndesc.shash.flags = 0;\r\n*(__u16 *)desc.ctx = crc;\r\nerr = crypto_shash_update(&desc.shash, buffer, len);\r\nBUG_ON(err);\r\nreturn *(__u16 *)desc.ctx;\r\n}\r\n__u16 crc_t10dif(const unsigned char *buffer, size_t len)\r\n{\r\nreturn crc_t10dif_update(0, buffer, len);\r\n}\r\nstatic int __init crc_t10dif_mod_init(void)\r\n{\r\ncrct10dif_tfm = crypto_alloc_shash("crct10dif", 0, 0);\r\nif (IS_ERR(crct10dif_tfm)) {\r\nstatic_key_slow_inc(&crct10dif_fallback);\r\ncrct10dif_tfm = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit crc_t10dif_mod_fini(void)\r\n{\r\ncrypto_free_shash(crct10dif_tfm);\r\n}

static void nft_counter_eval(const struct nft_expr *expr,\r\nstruct nft_regs *regs,\r\nconst struct nft_pktinfo *pkt)\r\n{\r\nstruct nft_counter_percpu_priv *priv = nft_expr_priv(expr);\r\nstruct nft_counter_percpu *this_cpu;\r\nlocal_bh_disable();\r\nthis_cpu = this_cpu_ptr(priv->counter);\r\nu64_stats_update_begin(&this_cpu->syncp);\r\nthis_cpu->counter.bytes += pkt->skb->len;\r\nthis_cpu->counter.packets++;\r\nu64_stats_update_end(&this_cpu->syncp);\r\nlocal_bh_enable();\r\n}\r\nstatic void nft_counter_fetch(const struct nft_counter_percpu __percpu *counter,\r\nstruct nft_counter *total)\r\n{\r\nconst struct nft_counter_percpu *cpu_stats;\r\nu64 bytes, packets;\r\nunsigned int seq;\r\nint cpu;\r\nmemset(total, 0, sizeof(*total));\r\nfor_each_possible_cpu(cpu) {\r\ncpu_stats = per_cpu_ptr(counter, cpu);\r\ndo {\r\nseq = u64_stats_fetch_begin_irq(&cpu_stats->syncp);\r\nbytes = cpu_stats->counter.bytes;\r\npackets = cpu_stats->counter.packets;\r\n} while (u64_stats_fetch_retry_irq(&cpu_stats->syncp, seq));\r\ntotal->packets += packets;\r\ntotal->bytes += bytes;\r\n}\r\n}\r\nstatic int nft_counter_dump(struct sk_buff *skb, const struct nft_expr *expr)\r\n{\r\nstruct nft_counter_percpu_priv *priv = nft_expr_priv(expr);\r\nstruct nft_counter total;\r\nnft_counter_fetch(priv->counter, &total);\r\nif (nla_put_be64(skb, NFTA_COUNTER_BYTES, cpu_to_be64(total.bytes)) ||\r\nnla_put_be64(skb, NFTA_COUNTER_PACKETS, cpu_to_be64(total.packets)))\r\ngoto nla_put_failure;\r\nreturn 0;\r\nnla_put_failure:\r\nreturn -1;\r\n}\r\nstatic int nft_counter_init(const struct nft_ctx *ctx,\r\nconst struct nft_expr *expr,\r\nconst struct nlattr * const tb[])\r\n{\r\nstruct nft_counter_percpu_priv *priv = nft_expr_priv(expr);\r\nstruct nft_counter_percpu __percpu *cpu_stats;\r\nstruct nft_counter_percpu *this_cpu;\r\ncpu_stats = netdev_alloc_pcpu_stats(struct nft_counter_percpu);\r\nif (cpu_stats == NULL)\r\nreturn -ENOMEM;\r\npreempt_disable();\r\nthis_cpu = this_cpu_ptr(cpu_stats);\r\nif (tb[NFTA_COUNTER_PACKETS]) {\r\nthis_cpu->counter.packets =\r\nbe64_to_cpu(nla_get_be64(tb[NFTA_COUNTER_PACKETS]));\r\n}\r\nif (tb[NFTA_COUNTER_BYTES]) {\r\nthis_cpu->counter.bytes =\r\nbe64_to_cpu(nla_get_be64(tb[NFTA_COUNTER_BYTES]));\r\n}\r\npreempt_enable();\r\npriv->counter = cpu_stats;\r\nreturn 0;\r\n}\r\nstatic void nft_counter_destroy(const struct nft_ctx *ctx,\r\nconst struct nft_expr *expr)\r\n{\r\nstruct nft_counter_percpu_priv *priv = nft_expr_priv(expr);\r\nfree_percpu(priv->counter);\r\n}\r\nstatic int nft_counter_clone(struct nft_expr *dst, const struct nft_expr *src)\r\n{\r\nstruct nft_counter_percpu_priv *priv = nft_expr_priv(src);\r\nstruct nft_counter_percpu_priv *priv_clone = nft_expr_priv(dst);\r\nstruct nft_counter_percpu __percpu *cpu_stats;\r\nstruct nft_counter_percpu *this_cpu;\r\nstruct nft_counter total;\r\nnft_counter_fetch(priv->counter, &total);\r\ncpu_stats = __netdev_alloc_pcpu_stats(struct nft_counter_percpu,\r\nGFP_ATOMIC);\r\nif (cpu_stats == NULL)\r\nreturn -ENOMEM;\r\npreempt_disable();\r\nthis_cpu = this_cpu_ptr(cpu_stats);\r\nthis_cpu->counter.packets = total.packets;\r\nthis_cpu->counter.bytes = total.bytes;\r\npreempt_enable();\r\npriv_clone->counter = cpu_stats;\r\nreturn 0;\r\n}\r\nstatic int __init nft_counter_module_init(void)\r\n{\r\nreturn nft_register_expr(&nft_counter_type);\r\n}\r\nstatic void __exit nft_counter_module_exit(void)\r\n{\r\nnft_unregister_expr(&nft_counter_type);\r\n}

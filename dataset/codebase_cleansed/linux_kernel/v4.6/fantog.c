static void\r\nnvkm_fantog_update(struct nvkm_fantog *fan, int percent)\r\n{\r\nstruct nvkm_therm *therm = fan->base.parent;\r\nstruct nvkm_device *device = therm->subdev.device;\r\nstruct nvkm_timer *tmr = device->timer;\r\nstruct nvkm_gpio *gpio = device->gpio;\r\nunsigned long flags;\r\nint duty;\r\nspin_lock_irqsave(&fan->lock, flags);\r\nif (percent < 0)\r\npercent = fan->percent;\r\nfan->percent = percent;\r\nduty = !nvkm_gpio_get(gpio, 0, DCB_GPIO_FAN, 0xff);\r\nnvkm_gpio_set(gpio, 0, DCB_GPIO_FAN, 0xff, duty);\r\nif (list_empty(&fan->alarm.head) && percent != (duty * 100)) {\r\nu64 next_change = (percent * fan->period_us) / 100;\r\nif (!duty)\r\nnext_change = fan->period_us - next_change;\r\nnvkm_timer_alarm(tmr, next_change * 1000, &fan->alarm);\r\n}\r\nspin_unlock_irqrestore(&fan->lock, flags);\r\n}\r\nstatic void\r\nnvkm_fantog_alarm(struct nvkm_alarm *alarm)\r\n{\r\nstruct nvkm_fantog *fan =\r\ncontainer_of(alarm, struct nvkm_fantog, alarm);\r\nnvkm_fantog_update(fan, -1);\r\n}\r\nstatic int\r\nnvkm_fantog_get(struct nvkm_therm *therm)\r\n{\r\nstruct nvkm_fantog *fan = (void *)therm->fan;\r\nreturn fan->percent;\r\n}\r\nstatic int\r\nnvkm_fantog_set(struct nvkm_therm *therm, int percent)\r\n{\r\nstruct nvkm_fantog *fan = (void *)therm->fan;\r\nif (therm->func->pwm_ctrl)\r\ntherm->func->pwm_ctrl(therm, fan->func.line, false);\r\nnvkm_fantog_update(fan, percent);\r\nreturn 0;\r\n}\r\nint\r\nnvkm_fantog_create(struct nvkm_therm *therm, struct dcb_gpio_func *func)\r\n{\r\nstruct nvkm_fantog *fan;\r\nint ret;\r\nif (therm->func->pwm_ctrl) {\r\nret = therm->func->pwm_ctrl(therm, func->line, false);\r\nif (ret)\r\nreturn ret;\r\n}\r\nfan = kzalloc(sizeof(*fan), GFP_KERNEL);\r\ntherm->fan = &fan->base;\r\nif (!fan)\r\nreturn -ENOMEM;\r\nfan->base.type = "toggle";\r\nfan->base.get = nvkm_fantog_get;\r\nfan->base.set = nvkm_fantog_set;\r\nnvkm_alarm_init(&fan->alarm, nvkm_fantog_alarm);\r\nfan->period_us = 100000;\r\nfan->percent = 100;\r\nfan->func = *func;\r\nspin_lock_init(&fan->lock);\r\nreturn 0;\r\n}

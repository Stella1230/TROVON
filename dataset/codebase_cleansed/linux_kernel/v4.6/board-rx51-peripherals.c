static int lis302_setup(void)\r\n{\r\nint err;\r\nint irq1 = LIS302_IRQ1_GPIO;\r\nint irq2 = LIS302_IRQ2_GPIO;\r\nerr = gpio_request(irq1, "lis3lv02dl_irq1");\r\nif (err) {\r\nprintk(KERN_ERR "lis3lv02dl: gpio request failed\n");\r\ngoto out;\r\n}\r\nerr = gpio_request(irq2, "lis3lv02dl_irq2");\r\nif (err) {\r\ngpio_free(irq1);\r\nprintk(KERN_ERR "lis3lv02dl: gpio request failed\n");\r\ngoto out;\r\n}\r\ngpio_direction_input(irq1);\r\ngpio_direction_input(irq2);\r\nout:\r\nreturn err;\r\n}\r\nstatic int lis302_release(void)\r\n{\r\ngpio_free(LIS302_IRQ1_GPIO);\r\ngpio_free(LIS302_IRQ2_GPIO);\r\nreturn 0;\r\n}\r\nstatic void rx51_charger_set_power(bool on)\r\n{\r\ngpio_set_value(RX51_USB_TRANSCEIVER_RST_GPIO, on);\r\n}\r\nstatic void __init rx51_charger_init(void)\r\n{\r\nWARN_ON(gpio_request_one(RX51_USB_TRANSCEIVER_RST_GPIO,\r\nGPIOF_OUT_INIT_HIGH, "isp1704_reset"));\r\nplatform_device_register(&rx51_battery_device);\r\nplatform_device_register(&rx51_charger_device);\r\n}\r\nstatic void __init rx51_add_gpio_keys(void)\r\n{\r\nplatform_device_register(&rx51_gpio_keys_device);\r\n}\r\nstatic void __init rx51_add_gpio_keys(void)\r\n{\r\n}\r\nstatic void rx51_mmc2_remux(struct device *dev, int power_on)\r\n{\r\nif (power_on)\r\nomap_mux_write_array(partition, rx51_mmc2_on_mux);\r\nelse\r\nomap_mux_write_array(partition, rx51_mmc2_off_mux);\r\n}\r\nstatic __init void rx51_gpio_init(void)\r\n{\r\ngpiod_add_lookup_table(&rx51_fmtx_gpios_table);\r\n}\r\nstatic int rx51_twlgpio_setup(struct device *dev, unsigned gpio, unsigned n)\r\n{\r\ngpio_request_one(gpio + 6, GPIOF_OUT_INIT_LOW, "backlight_pwm");\r\ngpio_request_one(gpio + 7, GPIOF_OUT_INIT_LOW, "speaker_en");\r\nreturn 0;\r\n}\r\nstatic int __init rx51_i2c_init(void)\r\n{\r\n#if IS_ENABLED(CONFIG_I2C_SI4713) && IS_ENABLED(CONFIG_PLATFORM_SI4713)\r\nint err;\r\n#endif\r\nif ((system_rev >= SYSTEM_REV_S_USES_VAUX3 && system_rev < 0x100) ||\r\nsystem_rev >= SYSTEM_REV_B_USES_VAUX3) {\r\nrx51_twldata.vaux3 = &rx51_vaux3_mmc;\r\nrx51_vmmc2.num_consumer_supplies--;\r\n} else {\r\nrx51_twldata.vaux3 = &rx51_vaux3_cam;\r\n}\r\nrx51_twldata.vmmc2 = &rx51_vmmc2;\r\nomap3_pmic_get_config(&rx51_twldata,\r\nTWL_COMMON_PDATA_USB | TWL_COMMON_PDATA_MADC,\r\nTWL_COMMON_REGULATOR_VDAC);\r\nrx51_twldata.vdac->constraints.apply_uV = true;\r\nrx51_twldata.vdac->constraints.name = "VDAC";\r\nomap_pmic_init(1, 2200, "twl5030", 7 + OMAP_INTC_START, &rx51_twldata);\r\n#if IS_ENABLED(CONFIG_I2C_SI4713) && IS_ENABLED(CONFIG_PLATFORM_SI4713)\r\nerr = gpio_request_one(RX51_FMTX_IRQ, GPIOF_DIR_IN, "si4713 irq");\r\nif (err) {\r\nprintk(KERN_ERR "Cannot request si4713 irq gpio. %d\n", err);\r\nreturn err;\r\n}\r\nrx51_peripherals_i2c_board_info_2[0].irq = gpio_to_irq(RX51_FMTX_IRQ);\r\n#endif\r\nomap_register_i2c_bus(2, 100, rx51_peripherals_i2c_board_info_2,\r\nARRAY_SIZE(rx51_peripherals_i2c_board_info_2));\r\n#if defined(CONFIG_SENSORS_LIS3_I2C) || defined(CONFIG_SENSORS_LIS3_I2C_MODULE)\r\nrx51_lis3lv02d_data.irq2 = gpio_to_irq(LIS302_IRQ2_GPIO);\r\nrx51_peripherals_i2c_board_info_3[0].irq = gpio_to_irq(LIS302_IRQ1_GPIO);\r\n#endif\r\nomap_register_i2c_bus(3, 400, rx51_peripherals_i2c_board_info_3,\r\nARRAY_SIZE(rx51_peripherals_i2c_board_info_3));\r\nreturn 0;\r\n}\r\nstatic void __init rx51_init_wl1251(void)\r\n{\r\nint irq, ret;\r\nret = gpio_request_array(rx51_wl1251_gpios,\r\nARRAY_SIZE(rx51_wl1251_gpios));\r\nif (ret < 0)\r\ngoto error;\r\nirq = gpio_to_irq(RX51_WL1251_IRQ_GPIO);\r\nif (irq < 0)\r\ngoto err_irq;\r\nwl1251_pdata.power_gpio = RX51_WL1251_POWER_GPIO;\r\nrx51_peripherals_spi_board_info[RX51_SPI_WL1251].irq = irq;\r\nreturn;\r\nerr_irq:\r\ngpio_free(RX51_WL1251_IRQ_GPIO);\r\nerror:\r\nprintk(KERN_ERR "wl1251 board initialisation failed\n");\r\nwl1251_pdata.power_gpio = -1;\r\n}\r\nstatic void rx51_tsc2005_set_reset(bool enable)\r\n{\r\ngpio_set_value(RX51_TSC2005_RESET_GPIO, enable);\r\n}\r\nstatic void __init rx51_init_tsc2005(void)\r\n{\r\nint r;\r\nomap_mux_init_gpio(RX51_TSC2005_RESET_GPIO, OMAP_PIN_OUTPUT);\r\nomap_mux_init_gpio(RX51_TSC2005_IRQ_GPIO, OMAP_PIN_INPUT_PULLUP);\r\nr = gpio_request_array(rx51_tsc2005_gpios,\r\nARRAY_SIZE(rx51_tsc2005_gpios));\r\nif (r < 0) {\r\nprintk(KERN_ERR "tsc2005 board initialization failed\n");\r\ntsc2005_pdata.esd_timeout_ms = 0;\r\nreturn;\r\n}\r\ntsc2005_pdata.set_reset = rx51_tsc2005_set_reset;\r\nrx51_peripherals_spi_board_info[RX51_SPI_TSC2005].irq =\r\ngpio_to_irq(RX51_TSC2005_IRQ_GPIO);\r\n}\r\nstatic void __init rx51_init_lirc(void)\r\n{\r\nplatform_device_register(&rx51_lirc_device);\r\n}\r\nstatic void __init rx51_init_lirc(void)\r\n{\r\n}\r\nstatic void __init rx51_init_twl4030_hwmon(void)\r\n{\r\nplatform_device_register(&madc_hwmon);\r\n}\r\nstatic void __init rx51_init_omap3_rom_rng(void)\r\n{\r\nif (omap_type() == OMAP2_DEVICE_TYPE_SEC) {\r\npr_info("RX-51: Registering OMAP3 HWRNG device\n");\r\nplatform_device_register(&omap3_rom_rng_device);\r\n}\r\n}\r\nvoid __init rx51_peripherals_init(void)\r\n{\r\nrx51_gpio_init();\r\nrx51_i2c_init();\r\nregulator_has_full_constraints();\r\ngpmc_onenand_init(board_onenand_data);\r\nrx51_add_gpio_keys();\r\nrx51_init_wl1251();\r\nrx51_init_tsc2005();\r\nrx51_init_lirc();\r\nspi_register_board_info(rx51_peripherals_spi_board_info,\r\nARRAY_SIZE(rx51_peripherals_spi_board_info));\r\npartition = omap_mux_get("core");\r\nif (partition)\r\nomap_hsmmc_init(mmc);\r\nrx51_charger_init();\r\nrx51_init_twl4030_hwmon();\r\nrx51_init_omap3_rom_rng();\r\n}

static void __init console_config(void)\r\n{\r\nchar console_string[40];\r\nint baud = 0;\r\nchar parity = '\0', bits = '\0', flow = '\0';\r\nchar *s;\r\nif ((strstr(fw_getcmdline(), "console=")) == NULL) {\r\ns = fw_getenv("modetty0");\r\nif (s) {\r\nwhile (*s >= '0' && *s <= '9')\r\nbaud = baud*10 + *s++ - '0';\r\nif (*s == ',')\r\ns++;\r\nif (*s)\r\nparity = *s++;\r\nif (*s == ',')\r\ns++;\r\nif (*s)\r\nbits = *s++;\r\nif (*s == ',')\r\ns++;\r\nif (*s == 'h')\r\nflow = 'r';\r\n}\r\nif (baud == 0)\r\nbaud = 38400;\r\nif (parity != 'n' && parity != 'o' && parity != 'e')\r\nparity = 'n';\r\nif (bits != '7' && bits != '8')\r\nbits = '8';\r\nif (flow == '\0')\r\nflow = 'r';\r\nsprintf(console_string, " console=ttyS0,%d%c%c%c", baud,\r\nparity, bits, flow);\r\nstrcat(fw_getcmdline(), console_string);\r\n}\r\n}\r\nstatic void __init mips_nmi_setup(void)\r\n{\r\nvoid *base;\r\nbase = cpu_has_veic ?\r\n(void *)(CAC_BASE + 0xa80) :\r\n(void *)(CAC_BASE + 0x380);\r\n#ifdef CONFIG_CPU_MICROMIPS\r\nmemcpy(base, (&except_vec_nmi - 1), 0x80);\r\nif (!cpu_has_veic) {\r\nvoid *base2 = (void *)(CAC_BASE + 0xa80);\r\n*((unsigned int *)base2) = 0x3c1a8000;\r\n*((unsigned int *)base2 + 1) = 0x375a0381;\r\n*((unsigned int *)base2 + 2) = 0x03400008;\r\n*((unsigned int *)base2 + 3) = 0x00000000;\r\nflush_icache_range((unsigned long)base2,\r\n(unsigned long)base2 + 0x10);\r\n}\r\n#else\r\nmemcpy(base, &except_vec_nmi, 0x80);\r\n#endif\r\nflush_icache_range((unsigned long)base, (unsigned long)base + 0x80);\r\n}\r\nstatic void __init mips_ejtag_setup(void)\r\n{\r\nvoid *base;\r\nbase = cpu_has_veic ?\r\n(void *)(CAC_BASE + 0xa00) :\r\n(void *)(CAC_BASE + 0x300);\r\n#ifdef CONFIG_CPU_MICROMIPS\r\nmemcpy(base, (&except_vec_ejtag_debug - 1), 0x80);\r\nif (!cpu_has_veic) {\r\nvoid *base2 = (void *)(CAC_BASE + 0xa00);\r\n*((unsigned int *)base2) = 0x3c1a8000;\r\n*((unsigned int *)base2 + 1) = 0x375a0301;\r\n*((unsigned int *)base2 + 2) = 0x03400008;\r\n*((unsigned int *)base2 + 3) = 0x00000000;\r\nflush_icache_range((unsigned long)base2,\r\n(unsigned long)base2 + 0x10);\r\n}\r\n#else\r\nmemcpy(base, &except_vec_ejtag_debug, 0x80);\r\n#endif\r\nflush_icache_range((unsigned long)base, (unsigned long)base + 0x80);\r\n}\r\nvoid __init prom_init(void)\r\n{\r\nboard_nmi_handler_setup = mips_nmi_setup;\r\nboard_ejtag_handler_setup = mips_ejtag_setup;\r\nfw_init_cmdline();\r\n#ifdef CONFIG_EARLY_PRINTK\r\nif ((strstr(fw_getcmdline(), "console=ttyS0")) != NULL)\r\nfw_init_early_console(0);\r\nelse if ((strstr(fw_getcmdline(), "console=ttyS1")) != NULL)\r\nfw_init_early_console(1);\r\n#endif\r\n#ifdef CONFIG_SERIAL_8250_CONSOLE\r\nif ((strstr(fw_getcmdline(), "console=")) == NULL)\r\nstrcat(fw_getcmdline(), " console=ttyS0,38400n8r");\r\nconsole_config();\r\n#endif\r\n}\r\nvoid __init prom_free_prom_memory(void)\r\n{\r\n}

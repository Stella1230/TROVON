static int tda1002x_cu1216_tuner_set(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct mantis_pci *mantis = fe->dvb->priv;\r\nstruct i2c_adapter *adapter = &mantis->adapter;\r\nu8 buf[6];\r\nstruct i2c_msg msg = {.addr = 0x60, .flags = 0, .buf = buf, .len = sizeof(buf)};\r\nint i;\r\n#define CU1216_IF 36125000\r\n#define TUNER_MUL 62500\r\nu32 div = (p->frequency + CU1216_IF + TUNER_MUL / 2) / TUNER_MUL;\r\nbuf[0] = (div >> 8) & 0x7f;\r\nbuf[1] = div & 0xff;\r\nbuf[2] = 0xce;\r\nbuf[3] = (p->frequency < 150000000 ? 0x01 :\r\np->frequency < 445000000 ? 0x02 : 0x04);\r\nbuf[4] = 0xde;\r\nbuf[5] = 0x20;\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nif (i2c_transfer(adapter, &msg, 1) != 1)\r\nreturn -EIO;\r\nmsg.flags = I2C_M_RD;\r\nmsg.len = 1;\r\nfor (i = 0; i < 20; i++) {\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nif (i2c_transfer(adapter, &msg, 1) == 1 && (buf[0] & 0x40))\r\nbreak;\r\nmsleep(10);\r\n}\r\nmsg.flags = 0;\r\nmsg.len = 2;\r\nmsg.buf = &buf[2];\r\nbuf[2] &= ~0x40;\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nif (i2c_transfer(adapter, &msg, 1) != 1)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic u8 read_pwm(struct mantis_pci *mantis)\r\n{\r\nstruct i2c_adapter *adapter = &mantis->adapter;\r\nu8 b = 0xff;\r\nu8 pwm;\r\nstruct i2c_msg msg[] = {\r\n{.addr = 0x50, .flags = 0, .buf = &b, .len = 1},\r\n{.addr = 0x50, .flags = I2C_M_RD, .buf = &pwm, .len = 1}\r\n};\r\nif ((i2c_transfer(adapter, msg, 2) != 2)\r\n|| (pwm == 0xff))\r\npwm = 0x48;\r\nreturn pwm;\r\n}\r\nstatic int vp2040_frontend_init(struct mantis_pci *mantis, struct dvb_frontend *fe)\r\n{\r\nstruct i2c_adapter *adapter = &mantis->adapter;\r\nint err = 0;\r\nerr = mantis_frontend_power(mantis, POWER_ON);\r\nif (err == 0) {\r\nmantis_frontend_soft_reset(mantis);\r\nmsleep(250);\r\ndprintk(MANTIS_ERROR, 1, "Probing for CU1216 (DVB-C)");\r\nfe = dvb_attach(tda10021_attach, &vp2040_tda1002x_cu1216_config,\r\nadapter,\r\nread_pwm(mantis));\r\nif (fe) {\r\ndprintk(MANTIS_ERROR, 1,\r\n"found Philips CU1216 DVB-C frontend (TDA10021) @ 0x%02x",\r\nvp2040_tda1002x_cu1216_config.demod_address);\r\n} else {\r\nfe = dvb_attach(tda10023_attach, &vp2040_tda10023_cu1216_config,\r\nadapter,\r\nread_pwm(mantis));\r\nif (fe) {\r\ndprintk(MANTIS_ERROR, 1,\r\n"found Philips CU1216 DVB-C frontend (TDA10023) @ 0x%02x",\r\nvp2040_tda1002x_cu1216_config.demod_address);\r\n}\r\n}\r\nif (fe) {\r\nfe->ops.tuner_ops.set_params = tda1002x_cu1216_tuner_set;\r\ndprintk(MANTIS_ERROR, 1, "Mantis DVB-C Philips CU1216 frontend attach success");\r\n} else {\r\nreturn -1;\r\n}\r\n} else {\r\ndprintk(MANTIS_ERROR, 1, "Frontend on <%s> POWER ON failed! <%d>",\r\nadapter->name,\r\nerr);\r\nreturn -EIO;\r\n}\r\nmantis->fe = fe;\r\ndprintk(MANTIS_DEBUG, 1, "Done!");\r\nreturn 0;\r\n}

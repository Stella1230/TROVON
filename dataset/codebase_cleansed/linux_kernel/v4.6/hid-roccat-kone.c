static void kone_profile_activated(struct kone_device *kone, uint new_profile)\r\n{\r\nkone->actual_profile = new_profile;\r\nkone->actual_dpi = kone->profiles[new_profile - 1].startup_dpi;\r\n}\r\nstatic void kone_profile_report(struct kone_device *kone, uint new_profile)\r\n{\r\nstruct kone_roccat_report roccat_report;\r\nroccat_report.event = kone_mouse_event_switch_profile;\r\nroccat_report.value = new_profile;\r\nroccat_report.key = 0;\r\nroccat_report_event(kone->chrdev_minor, (uint8_t *)&roccat_report);\r\n}\r\nstatic int kone_receive(struct usb_device *usb_dev, uint usb_command,\r\nvoid *data, uint size)\r\n{\r\nchar *buf;\r\nint len;\r\nbuf = kmalloc(size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nlen = usb_control_msg(usb_dev, usb_rcvctrlpipe(usb_dev, 0),\r\nHID_REQ_GET_REPORT,\r\nUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_IN,\r\nusb_command, 0, buf, size, USB_CTRL_SET_TIMEOUT);\r\nmemcpy(data, buf, size);\r\nkfree(buf);\r\nreturn ((len < 0) ? len : ((len != size) ? -EIO : 0));\r\n}\r\nstatic int kone_send(struct usb_device *usb_dev, uint usb_command,\r\nvoid const *data, uint size)\r\n{\r\nchar *buf;\r\nint len;\r\nbuf = kmemdup(data, size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nlen = usb_control_msg(usb_dev, usb_sndctrlpipe(usb_dev, 0),\r\nHID_REQ_SET_REPORT,\r\nUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_OUT,\r\nusb_command, 0, buf, size, USB_CTRL_SET_TIMEOUT);\r\nkfree(buf);\r\nreturn ((len < 0) ? len : ((len != size) ? -EIO : 0));\r\n}\r\nstatic void kone_set_settings_checksum(struct kone_settings *settings)\r\n{\r\nuint16_t checksum = 0;\r\nunsigned char *address = (unsigned char *)settings;\r\nint i;\r\nfor (i = 0; i < sizeof(struct kone_settings) - 2; ++i, ++address)\r\nchecksum += *address;\r\nsettings->checksum = cpu_to_le16(checksum);\r\n}\r\nstatic int kone_check_write(struct usb_device *usb_dev)\r\n{\r\nint retval;\r\nuint8_t data;\r\ndo {\r\nmsleep(80);\r\nretval = kone_receive(usb_dev,\r\nkone_command_confirm_write, &data, 1);\r\nif (retval)\r\nreturn retval;\r\n} while (data == 3);\r\nif (data == 1)\r\nreturn 0;\r\ndev_err(&usb_dev->dev, "got retval %d when checking write\n", data);\r\nreturn -EIO;\r\n}\r\nstatic int kone_get_settings(struct usb_device *usb_dev,\r\nstruct kone_settings *buf)\r\n{\r\nreturn kone_receive(usb_dev, kone_command_settings, buf,\r\nsizeof(struct kone_settings));\r\n}\r\nstatic int kone_set_settings(struct usb_device *usb_dev,\r\nstruct kone_settings const *settings)\r\n{\r\nint retval;\r\nretval = kone_send(usb_dev, kone_command_settings,\r\nsettings, sizeof(struct kone_settings));\r\nif (retval)\r\nreturn retval;\r\nreturn kone_check_write(usb_dev);\r\n}\r\nstatic int kone_get_profile(struct usb_device *usb_dev,\r\nstruct kone_profile *buf, int number)\r\n{\r\nint len;\r\nif (number < 1 || number > 5)\r\nreturn -EINVAL;\r\nlen = usb_control_msg(usb_dev, usb_rcvctrlpipe(usb_dev, 0),\r\nUSB_REQ_CLEAR_FEATURE,\r\nUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_IN,\r\nkone_command_profile, number, buf,\r\nsizeof(struct kone_profile), USB_CTRL_SET_TIMEOUT);\r\nif (len != sizeof(struct kone_profile))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int kone_set_profile(struct usb_device *usb_dev,\r\nstruct kone_profile const *profile, int number)\r\n{\r\nint len;\r\nif (number < 1 || number > 5)\r\nreturn -EINVAL;\r\nlen = usb_control_msg(usb_dev, usb_sndctrlpipe(usb_dev, 0),\r\nUSB_REQ_SET_CONFIGURATION,\r\nUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_OUT,\r\nkone_command_profile, number, (void *)profile,\r\nsizeof(struct kone_profile),\r\nUSB_CTRL_SET_TIMEOUT);\r\nif (len != sizeof(struct kone_profile))\r\nreturn len;\r\nif (kone_check_write(usb_dev))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int kone_get_weight(struct usb_device *usb_dev, int *result)\r\n{\r\nint retval;\r\nuint8_t data;\r\nretval = kone_receive(usb_dev, kone_command_weight, &data, 1);\r\nif (retval)\r\nreturn retval;\r\n*result = (int)data;\r\nreturn 0;\r\n}\r\nstatic int kone_get_firmware_version(struct usb_device *usb_dev, int *result)\r\n{\r\nint retval;\r\nuint16_t data;\r\nretval = kone_receive(usb_dev, kone_command_firmware_version,\r\n&data, 2);\r\nif (retval)\r\nreturn retval;\r\n*result = le16_to_cpu(data);\r\nreturn 0;\r\n}\r\nstatic ssize_t kone_sysfs_read_settings(struct file *fp, struct kobject *kobj,\r\nstruct bin_attribute *attr, char *buf,\r\nloff_t off, size_t count) {\r\nstruct device *dev = kobj_to_dev(kobj)->parent->parent;\r\nstruct kone_device *kone = hid_get_drvdata(dev_get_drvdata(dev));\r\nif (off >= sizeof(struct kone_settings))\r\nreturn 0;\r\nif (off + count > sizeof(struct kone_settings))\r\ncount = sizeof(struct kone_settings) - off;\r\nmutex_lock(&kone->kone_lock);\r\nmemcpy(buf, ((char const *)&kone->settings) + off, count);\r\nmutex_unlock(&kone->kone_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t kone_sysfs_write_settings(struct file *fp, struct kobject *kobj,\r\nstruct bin_attribute *attr, char *buf,\r\nloff_t off, size_t count) {\r\nstruct device *dev = kobj_to_dev(kobj)->parent->parent;\r\nstruct kone_device *kone = hid_get_drvdata(dev_get_drvdata(dev));\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nint retval = 0, difference, old_profile;\r\nif (off != 0 || count != sizeof(struct kone_settings))\r\nreturn -EINVAL;\r\nmutex_lock(&kone->kone_lock);\r\ndifference = memcmp(buf, &kone->settings, sizeof(struct kone_settings));\r\nif (difference) {\r\nretval = kone_set_settings(usb_dev,\r\n(struct kone_settings const *)buf);\r\nif (retval) {\r\nmutex_unlock(&kone->kone_lock);\r\nreturn retval;\r\n}\r\nold_profile = kone->settings.startup_profile;\r\nmemcpy(&kone->settings, buf, sizeof(struct kone_settings));\r\nkone_profile_activated(kone, kone->settings.startup_profile);\r\nif (kone->settings.startup_profile != old_profile)\r\nkone_profile_report(kone, kone->settings.startup_profile);\r\n}\r\nmutex_unlock(&kone->kone_lock);\r\nreturn sizeof(struct kone_settings);\r\n}\r\nstatic ssize_t kone_sysfs_read_profilex(struct file *fp,\r\nstruct kobject *kobj, struct bin_attribute *attr,\r\nchar *buf, loff_t off, size_t count) {\r\nstruct device *dev = kobj_to_dev(kobj)->parent->parent;\r\nstruct kone_device *kone = hid_get_drvdata(dev_get_drvdata(dev));\r\nif (off >= sizeof(struct kone_profile))\r\nreturn 0;\r\nif (off + count > sizeof(struct kone_profile))\r\ncount = sizeof(struct kone_profile) - off;\r\nmutex_lock(&kone->kone_lock);\r\nmemcpy(buf, ((char const *)&kone->profiles[*(uint *)(attr->private)]) + off, count);\r\nmutex_unlock(&kone->kone_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t kone_sysfs_write_profilex(struct file *fp,\r\nstruct kobject *kobj, struct bin_attribute *attr,\r\nchar *buf, loff_t off, size_t count) {\r\nstruct device *dev = kobj_to_dev(kobj)->parent->parent;\r\nstruct kone_device *kone = hid_get_drvdata(dev_get_drvdata(dev));\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nstruct kone_profile *profile;\r\nint retval = 0, difference;\r\nif (off != 0 || count != sizeof(struct kone_profile))\r\nreturn -EINVAL;\r\nprofile = &kone->profiles[*(uint *)(attr->private)];\r\nmutex_lock(&kone->kone_lock);\r\ndifference = memcmp(buf, profile, sizeof(struct kone_profile));\r\nif (difference) {\r\nretval = kone_set_profile(usb_dev,\r\n(struct kone_profile const *)buf,\r\n*(uint *)(attr->private) + 1);\r\nif (!retval)\r\nmemcpy(profile, buf, sizeof(struct kone_profile));\r\n}\r\nmutex_unlock(&kone->kone_lock);\r\nif (retval)\r\nreturn retval;\r\nreturn sizeof(struct kone_profile);\r\n}\r\nstatic ssize_t kone_sysfs_show_actual_profile(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct kone_device *kone =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", kone->actual_profile);\r\n}\r\nstatic ssize_t kone_sysfs_show_actual_dpi(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct kone_device *kone =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", kone->actual_dpi);\r\n}\r\nstatic ssize_t kone_sysfs_show_weight(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct kone_device *kone;\r\nstruct usb_device *usb_dev;\r\nint weight = 0;\r\nint retval;\r\ndev = dev->parent->parent;\r\nkone = hid_get_drvdata(dev_get_drvdata(dev));\r\nusb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nmutex_lock(&kone->kone_lock);\r\nretval = kone_get_weight(usb_dev, &weight);\r\nmutex_unlock(&kone->kone_lock);\r\nif (retval)\r\nreturn retval;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", weight);\r\n}\r\nstatic ssize_t kone_sysfs_show_firmware_version(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct kone_device *kone =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", kone->firmware_version);\r\n}\r\nstatic ssize_t kone_sysfs_show_tcu(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct kone_device *kone =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", kone->settings.tcu);\r\n}\r\nstatic int kone_tcu_command(struct usb_device *usb_dev, int number)\r\n{\r\nunsigned char value;\r\nvalue = number;\r\nreturn kone_send(usb_dev, kone_command_calibrate, &value, 1);\r\n}\r\nstatic ssize_t kone_sysfs_set_tcu(struct device *dev,\r\nstruct device_attribute *attr, char const *buf, size_t size)\r\n{\r\nstruct kone_device *kone;\r\nstruct usb_device *usb_dev;\r\nint retval;\r\nunsigned long state;\r\ndev = dev->parent->parent;\r\nkone = hid_get_drvdata(dev_get_drvdata(dev));\r\nusb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nretval = kstrtoul(buf, 10, &state);\r\nif (retval)\r\nreturn retval;\r\nif (state != 0 && state != 1)\r\nreturn -EINVAL;\r\nmutex_lock(&kone->kone_lock);\r\nif (state == 1) {\r\nretval = kone_tcu_command(usb_dev, 1);\r\nif (retval)\r\ngoto exit_unlock;\r\nretval = kone_tcu_command(usb_dev, 2);\r\nif (retval)\r\ngoto exit_unlock;\r\nssleep(5);\r\nretval = kone_tcu_command(usb_dev, 3);\r\nif (retval)\r\ngoto exit_unlock;\r\nretval = kone_tcu_command(usb_dev, 0);\r\nif (retval)\r\ngoto exit_unlock;\r\nretval = kone_tcu_command(usb_dev, 4);\r\nif (retval)\r\ngoto exit_unlock;\r\nssleep(1);\r\n}\r\nretval = kone_get_settings(usb_dev, &kone->settings);\r\nif (retval)\r\ngoto exit_no_settings;\r\nif (kone->settings.tcu != state) {\r\nkone->settings.tcu = state;\r\nkone_set_settings_checksum(&kone->settings);\r\nretval = kone_set_settings(usb_dev, &kone->settings);\r\nif (retval) {\r\ndev_err(&usb_dev->dev, "couldn't set tcu state\n");\r\nretval = kone_get_settings(usb_dev, &kone->settings);\r\nif (retval)\r\ngoto exit_no_settings;\r\ngoto exit_unlock;\r\n}\r\nkone_profile_activated(kone, kone->settings.startup_profile);\r\n}\r\nretval = size;\r\nexit_no_settings:\r\ndev_err(&usb_dev->dev, "couldn't read settings\n");\r\nexit_unlock:\r\nmutex_unlock(&kone->kone_lock);\r\nreturn retval;\r\n}\r\nstatic ssize_t kone_sysfs_show_startup_profile(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct kone_device *kone =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", kone->settings.startup_profile);\r\n}\r\nstatic ssize_t kone_sysfs_set_startup_profile(struct device *dev,\r\nstruct device_attribute *attr, char const *buf, size_t size)\r\n{\r\nstruct kone_device *kone;\r\nstruct usb_device *usb_dev;\r\nint retval;\r\nunsigned long new_startup_profile;\r\ndev = dev->parent->parent;\r\nkone = hid_get_drvdata(dev_get_drvdata(dev));\r\nusb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nretval = kstrtoul(buf, 10, &new_startup_profile);\r\nif (retval)\r\nreturn retval;\r\nif (new_startup_profile < 1 || new_startup_profile > 5)\r\nreturn -EINVAL;\r\nmutex_lock(&kone->kone_lock);\r\nkone->settings.startup_profile = new_startup_profile;\r\nkone_set_settings_checksum(&kone->settings);\r\nretval = kone_set_settings(usb_dev, &kone->settings);\r\nif (retval) {\r\nmutex_unlock(&kone->kone_lock);\r\nreturn retval;\r\n}\r\nkone_profile_activated(kone, new_startup_profile);\r\nkone_profile_report(kone, new_startup_profile);\r\nmutex_unlock(&kone->kone_lock);\r\nreturn size;\r\n}\r\nstatic int kone_init_kone_device_struct(struct usb_device *usb_dev,\r\nstruct kone_device *kone)\r\n{\r\nuint i;\r\nint retval;\r\nmutex_init(&kone->kone_lock);\r\nfor (i = 0; i < 5; ++i) {\r\nretval = kone_get_profile(usb_dev, &kone->profiles[i], i + 1);\r\nif (retval)\r\nreturn retval;\r\n}\r\nretval = kone_get_settings(usb_dev, &kone->settings);\r\nif (retval)\r\nreturn retval;\r\nretval = kone_get_firmware_version(usb_dev, &kone->firmware_version);\r\nif (retval)\r\nreturn retval;\r\nkone_profile_activated(kone, kone->settings.startup_profile);\r\nreturn 0;\r\n}\r\nstatic int kone_init_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct usb_device *usb_dev = interface_to_usbdev(intf);\r\nstruct kone_device *kone;\r\nint retval;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n== USB_INTERFACE_PROTOCOL_MOUSE) {\r\nkone = kzalloc(sizeof(*kone), GFP_KERNEL);\r\nif (!kone)\r\nreturn -ENOMEM;\r\nhid_set_drvdata(hdev, kone);\r\nretval = kone_init_kone_device_struct(usb_dev, kone);\r\nif (retval) {\r\nhid_err(hdev, "couldn't init struct kone_device\n");\r\ngoto exit_free;\r\n}\r\nretval = roccat_connect(kone_class, hdev,\r\nsizeof(struct kone_roccat_report));\r\nif (retval < 0) {\r\nhid_err(hdev, "couldn't init char dev\n");\r\n} else {\r\nkone->roccat_claimed = 1;\r\nkone->chrdev_minor = retval;\r\n}\r\n} else {\r\nhid_set_drvdata(hdev, NULL);\r\n}\r\nreturn 0;\r\nexit_free:\r\nkfree(kone);\r\nreturn retval;\r\n}\r\nstatic void kone_remove_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct kone_device *kone;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n== USB_INTERFACE_PROTOCOL_MOUSE) {\r\nkone = hid_get_drvdata(hdev);\r\nif (kone->roccat_claimed)\r\nroccat_disconnect(kone->chrdev_minor);\r\nkfree(hid_get_drvdata(hdev));\r\n}\r\n}\r\nstatic int kone_probe(struct hid_device *hdev, const struct hid_device_id *id)\r\n{\r\nint retval;\r\nretval = hid_parse(hdev);\r\nif (retval) {\r\nhid_err(hdev, "parse failed\n");\r\ngoto exit;\r\n}\r\nretval = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\r\nif (retval) {\r\nhid_err(hdev, "hw start failed\n");\r\ngoto exit;\r\n}\r\nretval = kone_init_specials(hdev);\r\nif (retval) {\r\nhid_err(hdev, "couldn't install mouse\n");\r\ngoto exit_stop;\r\n}\r\nreturn 0;\r\nexit_stop:\r\nhid_hw_stop(hdev);\r\nexit:\r\nreturn retval;\r\n}\r\nstatic void kone_remove(struct hid_device *hdev)\r\n{\r\nkone_remove_specials(hdev);\r\nhid_hw_stop(hdev);\r\n}\r\nstatic void kone_keep_values_up_to_date(struct kone_device *kone,\r\nstruct kone_mouse_event const *event)\r\n{\r\nswitch (event->event) {\r\ncase kone_mouse_event_switch_profile:\r\nkone->actual_dpi = kone->profiles[event->value - 1].\r\nstartup_dpi;\r\ncase kone_mouse_event_osd_profile:\r\nkone->actual_profile = event->value;\r\nbreak;\r\ncase kone_mouse_event_switch_dpi:\r\ncase kone_mouse_event_osd_dpi:\r\nkone->actual_dpi = event->value;\r\nbreak;\r\n}\r\n}\r\nstatic void kone_report_to_chrdev(struct kone_device const *kone,\r\nstruct kone_mouse_event const *event)\r\n{\r\nstruct kone_roccat_report roccat_report;\r\nswitch (event->event) {\r\ncase kone_mouse_event_switch_profile:\r\ncase kone_mouse_event_switch_dpi:\r\ncase kone_mouse_event_osd_profile:\r\ncase kone_mouse_event_osd_dpi:\r\nroccat_report.event = event->event;\r\nroccat_report.value = event->value;\r\nroccat_report.key = 0;\r\nroccat_report_event(kone->chrdev_minor,\r\n(uint8_t *)&roccat_report);\r\nbreak;\r\ncase kone_mouse_event_call_overlong_macro:\r\ncase kone_mouse_event_multimedia:\r\nif (event->value == kone_keystroke_action_press) {\r\nroccat_report.event = event->event;\r\nroccat_report.value = kone->actual_profile;\r\nroccat_report.key = event->macro_key;\r\nroccat_report_event(kone->chrdev_minor,\r\n(uint8_t *)&roccat_report);\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic int kone_raw_event(struct hid_device *hdev, struct hid_report *report,\r\nu8 *data, int size)\r\n{\r\nstruct kone_device *kone = hid_get_drvdata(hdev);\r\nstruct kone_mouse_event *event = (struct kone_mouse_event *)data;\r\nif (size != sizeof(struct kone_mouse_event))\r\nreturn 0;\r\nif (kone == NULL)\r\nreturn 0;\r\nif (memcmp(&kone->last_mouse_event.tilt, &event->tilt, 5))\r\nmemcpy(&kone->last_mouse_event, event,\r\nsizeof(struct kone_mouse_event));\r\nelse\r\nmemset(&event->tilt, 0, 5);\r\nkone_keep_values_up_to_date(kone, event);\r\nif (kone->roccat_claimed)\r\nkone_report_to_chrdev(kone, event);\r\nreturn 0;\r\n}\r\nstatic int __init kone_init(void)\r\n{\r\nint retval;\r\nkone_class = class_create(THIS_MODULE, "kone");\r\nif (IS_ERR(kone_class))\r\nreturn PTR_ERR(kone_class);\r\nkone_class->dev_groups = kone_groups;\r\nretval = hid_register_driver(&kone_driver);\r\nif (retval)\r\nclass_destroy(kone_class);\r\nreturn retval;\r\n}\r\nstatic void __exit kone_exit(void)\r\n{\r\nhid_unregister_driver(&kone_driver);\r\nclass_destroy(kone_class);\r\n}

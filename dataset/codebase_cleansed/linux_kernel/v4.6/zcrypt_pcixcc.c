static int zcrypt_pcixcc_mcl(struct ap_device *ap_dev)\r\n{\r\nstatic unsigned char msg[] = {\r\n0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x58,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x43,0x41,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x50,0x4B,0x00,0x00,\r\n0x00,0x00,0x01,0xC4,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x07,0x24,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0xDC,0x02,0x00,0x00,0x00,0x54,0x32,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE8,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x24,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,\r\n0x00,0x00,0x00,0x00,0x50,0x4B,0x00,0x0A,\r\n0x4D,0x52,0x50,0x20,0x20,0x20,0x20,0x20,\r\n0x00,0x42,0x00,0x01,0x02,0x03,0x04,0x05,\r\n0x06,0x07,0x08,0x09,0x0A,0x0B,0x0C,0x0D,\r\n0x0E,0x0F,0x00,0x11,0x22,0x33,0x44,0x55,\r\n0x66,0x77,0x88,0x99,0xAA,0xBB,0xCC,0xDD,\r\n0xEE,0xFF,0xFF,0xEE,0xDD,0xCC,0xBB,0xAA,\r\n0x99,0x88,0x77,0x66,0x55,0x44,0x33,0x22,\r\n0x11,0x00,0x01,0x23,0x45,0x67,0x89,0xAB,\r\n0xCD,0xEF,0xFE,0xDC,0xBA,0x98,0x76,0x54,\r\n0x32,0x10,0x00,0x9A,0x00,0x98,0x00,0x00,\r\n0x1E,0x00,0x00,0x94,0x00,0x00,0x00,0x00,\r\n0x04,0x00,0x00,0x8C,0x00,0x00,0x00,0x40,\r\n0x02,0x00,0x00,0x40,0xBA,0xE8,0x23,0x3C,\r\n0x75,0xF3,0x91,0x61,0xD6,0x73,0x39,0xCF,\r\n0x7B,0x6D,0x8E,0x61,0x97,0x63,0x9E,0xD9,\r\n0x60,0x55,0xD6,0xC7,0xEF,0xF8,0x1E,0x63,\r\n0x95,0x17,0xCC,0x28,0x45,0x60,0x11,0xC5,\r\n0xC4,0x4E,0x66,0xC6,0xE6,0xC3,0xDE,0x8A,\r\n0x19,0x30,0xCF,0x0E,0xD7,0xAA,0xDB,0x01,\r\n0xD8,0x00,0xBB,0x8F,0x39,0x9F,0x64,0x28,\r\n0xF5,0x7A,0x77,0x49,0xCC,0x6B,0xA3,0x91,\r\n0x97,0x70,0xE7,0x60,0x1E,0x39,0xE1,0xE5,\r\n0x33,0xE1,0x15,0x63,0x69,0x08,0x80,0x4C,\r\n0x67,0xC4,0x41,0x8F,0x48,0xDF,0x26,0x98,\r\n0xF1,0xD5,0x8D,0x88,0xD9,0x6A,0xA4,0x96,\r\n0xC5,0x84,0xD9,0x30,0x49,0x67,0x7D,0x19,\r\n0xB1,0xB3,0x45,0x4D,0xB2,0x53,0x9A,0x47,\r\n0x3C,0x7C,0x55,0xBF,0xCC,0x85,0x00,0x36,\r\n0xF1,0x3D,0x93,0x53\r\n};\r\nunsigned long long psmid;\r\nstruct CPRBX *cprbx;\r\nchar *reply;\r\nint rc, i;\r\nreply = (void *) get_zeroed_page(GFP_KERNEL);\r\nif (!reply)\r\nreturn -ENOMEM;\r\nrc = ap_send(ap_dev->qid, 0x0102030405060708ULL, msg, sizeof(msg));\r\nif (rc)\r\ngoto out_free;\r\nfor (i = 0; i < 6; i++) {\r\nmsleep(300);\r\nrc = ap_recv(ap_dev->qid, &psmid, reply, 4096);\r\nif (rc == 0 && psmid == 0x0102030405060708ULL)\r\nbreak;\r\n}\r\nif (i >= 6) {\r\nrc = -ENODEV;\r\ngoto out_free;\r\n}\r\ncprbx = (struct CPRBX *) (reply + 48);\r\nif (cprbx->ccp_rtcode == 8 && cprbx->ccp_rscode == 33)\r\nrc = ZCRYPT_PCIXCC_MCL2;\r\nelse\r\nrc = ZCRYPT_PCIXCC_MCL3;\r\nout_free:\r\nfree_page((unsigned long) reply);\r\nreturn rc;\r\n}\r\nstatic int zcrypt_pcixcc_rng_supported(struct ap_device *ap_dev)\r\n{\r\nstruct ap_message ap_msg;\r\nunsigned long long psmid;\r\nstruct {\r\nstruct type86_hdr hdr;\r\nstruct type86_fmt2_ext fmt2;\r\nstruct CPRBX cprbx;\r\n} __attribute__((packed)) *reply;\r\nint rc, i;\r\nap_init_message(&ap_msg);\r\nap_msg.message = (void *) get_zeroed_page(GFP_KERNEL);\r\nif (!ap_msg.message)\r\nreturn -ENOMEM;\r\nrng_type6CPRB_msgX(ap_dev, &ap_msg, 4);\r\nrc = ap_send(ap_dev->qid, 0x0102030405060708ULL, ap_msg.message,\r\nap_msg.length);\r\nif (rc)\r\ngoto out_free;\r\nfor (i = 0; i < 2 * HZ; i++) {\r\nmsleep(1000 / HZ);\r\nrc = ap_recv(ap_dev->qid, &psmid, ap_msg.message, 4096);\r\nif (rc == 0 && psmid == 0x0102030405060708ULL)\r\nbreak;\r\n}\r\nif (i >= 2 * HZ) {\r\nrc = -ENODEV;\r\ngoto out_free;\r\n}\r\nreply = ap_msg.message;\r\nif (reply->cprbx.ccp_rtcode == 0 && reply->cprbx.ccp_rscode == 0)\r\nrc = 1;\r\nelse\r\nrc = 0;\r\nout_free:\r\nfree_page((unsigned long) ap_msg.message);\r\nreturn rc;\r\n}\r\nstatic int zcrypt_pcixcc_probe(struct ap_device *ap_dev)\r\n{\r\nstruct zcrypt_device *zdev;\r\nint rc = 0;\r\nzdev = zcrypt_device_alloc(PCIXCC_MAX_XCRB_MESSAGE_SIZE);\r\nif (!zdev)\r\nreturn -ENOMEM;\r\nzdev->ap_dev = ap_dev;\r\nzdev->online = 1;\r\nswitch (ap_dev->device_type) {\r\ncase AP_DEVICE_TYPE_PCIXCC:\r\nrc = zcrypt_pcixcc_mcl(ap_dev);\r\nif (rc < 0) {\r\nzcrypt_device_free(zdev);\r\nreturn rc;\r\n}\r\nzdev->user_space_type = rc;\r\nif (rc == ZCRYPT_PCIXCC_MCL2) {\r\nzdev->type_string = "PCIXCC_MCL2";\r\nzdev->speed_rating = PCIXCC_MCL2_SPEED_RATING;\r\nzdev->min_mod_size = PCIXCC_MIN_MOD_SIZE_OLD;\r\nzdev->max_mod_size = PCIXCC_MAX_MOD_SIZE;\r\nzdev->max_exp_bit_length = PCIXCC_MAX_MOD_SIZE;\r\n} else {\r\nzdev->type_string = "PCIXCC_MCL3";\r\nzdev->speed_rating = PCIXCC_MCL3_SPEED_RATING;\r\nzdev->min_mod_size = PCIXCC_MIN_MOD_SIZE;\r\nzdev->max_mod_size = PCIXCC_MAX_MOD_SIZE;\r\nzdev->max_exp_bit_length = PCIXCC_MAX_MOD_SIZE;\r\n}\r\nbreak;\r\ncase AP_DEVICE_TYPE_CEX2C:\r\nzdev->user_space_type = ZCRYPT_CEX2C;\r\nzdev->type_string = "CEX2C";\r\nzdev->speed_rating = CEX2C_SPEED_RATING;\r\nzdev->min_mod_size = PCIXCC_MIN_MOD_SIZE;\r\nzdev->max_mod_size = PCIXCC_MAX_MOD_SIZE;\r\nzdev->max_exp_bit_length = PCIXCC_MAX_MOD_SIZE;\r\nbreak;\r\ncase AP_DEVICE_TYPE_CEX3C:\r\nzdev->user_space_type = ZCRYPT_CEX3C;\r\nzdev->type_string = "CEX3C";\r\nzdev->speed_rating = CEX3C_SPEED_RATING;\r\nzdev->min_mod_size = CEX3C_MIN_MOD_SIZE;\r\nzdev->max_mod_size = CEX3C_MAX_MOD_SIZE;\r\nzdev->max_exp_bit_length = CEX3C_MAX_MOD_SIZE;\r\nbreak;\r\ndefault:\r\ngoto out_free;\r\n}\r\nrc = zcrypt_pcixcc_rng_supported(ap_dev);\r\nif (rc < 0) {\r\nzcrypt_device_free(zdev);\r\nreturn rc;\r\n}\r\nif (rc)\r\nzdev->ops = zcrypt_msgtype_request(MSGTYPE06_NAME,\r\nMSGTYPE06_VARIANT_DEFAULT);\r\nelse\r\nzdev->ops = zcrypt_msgtype_request(MSGTYPE06_NAME,\r\nMSGTYPE06_VARIANT_NORNG);\r\nap_dev->reply = &zdev->reply;\r\nap_dev->private = zdev;\r\nrc = zcrypt_device_register(zdev);\r\nif (rc)\r\ngoto out_free;\r\nreturn 0;\r\nout_free:\r\nap_dev->private = NULL;\r\nzcrypt_msgtype_release(zdev->ops);\r\nzcrypt_device_free(zdev);\r\nreturn rc;\r\n}\r\nstatic void zcrypt_pcixcc_remove(struct ap_device *ap_dev)\r\n{\r\nstruct zcrypt_device *zdev = ap_dev->private;\r\nstruct zcrypt_ops *zops = zdev->ops;\r\nzcrypt_device_unregister(zdev);\r\nzcrypt_msgtype_release(zops);\r\n}\r\nint __init zcrypt_pcixcc_init(void)\r\n{\r\nreturn ap_driver_register(&zcrypt_pcixcc_driver, THIS_MODULE, "pcixcc");\r\n}\r\nvoid zcrypt_pcixcc_exit(void)\r\n{\r\nap_driver_unregister(&zcrypt_pcixcc_driver);\r\n}

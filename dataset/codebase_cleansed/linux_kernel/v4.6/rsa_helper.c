int rsa_get_n(void *context, size_t hdrlen, unsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct rsa_key *key = context;\r\nkey->n = mpi_read_raw_data(value, vlen);\r\nif (!key->n)\r\nreturn -ENOMEM;\r\nif (fips_enabled && (mpi_get_size(key->n) != 256 &&\r\nmpi_get_size(key->n) != 384)) {\r\npr_err("RSA: key size not allowed in FIPS mode\n");\r\nmpi_free(key->n);\r\nkey->n = NULL;\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint rsa_get_e(void *context, size_t hdrlen, unsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct rsa_key *key = context;\r\nkey->e = mpi_read_raw_data(value, vlen);\r\nif (!key->e)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nint rsa_get_d(void *context, size_t hdrlen, unsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct rsa_key *key = context;\r\nkey->d = mpi_read_raw_data(value, vlen);\r\nif (!key->d)\r\nreturn -ENOMEM;\r\nif (fips_enabled && (mpi_get_size(key->d) != 256 &&\r\nmpi_get_size(key->d) != 384)) {\r\npr_err("RSA: key size not allowed in FIPS mode\n");\r\nmpi_free(key->d);\r\nkey->d = NULL;\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void free_mpis(struct rsa_key *key)\r\n{\r\nmpi_free(key->n);\r\nmpi_free(key->e);\r\nmpi_free(key->d);\r\nkey->n = NULL;\r\nkey->e = NULL;\r\nkey->d = NULL;\r\n}\r\nvoid rsa_free_key(struct rsa_key *key)\r\n{\r\nfree_mpis(key);\r\n}\r\nint rsa_parse_pub_key(struct rsa_key *rsa_key, const void *key,\r\nunsigned int key_len)\r\n{\r\nint ret;\r\nfree_mpis(rsa_key);\r\nret = asn1_ber_decoder(&rsapubkey_decoder, rsa_key, key, key_len);\r\nif (ret < 0)\r\ngoto error;\r\nreturn 0;\r\nerror:\r\nfree_mpis(rsa_key);\r\nreturn ret;\r\n}\r\nint rsa_parse_priv_key(struct rsa_key *rsa_key, const void *key,\r\nunsigned int key_len)\r\n{\r\nint ret;\r\nfree_mpis(rsa_key);\r\nret = asn1_ber_decoder(&rsaprivkey_decoder, rsa_key, key, key_len);\r\nif (ret < 0)\r\ngoto error;\r\nreturn 0;\r\nerror:\r\nfree_mpis(rsa_key);\r\nreturn ret;\r\n}

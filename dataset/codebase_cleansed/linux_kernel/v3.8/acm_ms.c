static int __init acm_ms_do_config(struct usb_configuration *c)\r\n{\r\nint status;\r\nif (gadget_is_otg(c->cdev->gadget)) {\r\nc->descriptors = otg_desc;\r\nc->bmAttributes |= USB_CONFIG_ATT_WAKEUP;\r\n}\r\nstatus = acm_bind_config(c, 0);\r\nif (status < 0)\r\nreturn status;\r\nstatus = fsg_bind_config(c->cdev, c, &fsg_common);\r\nif (status < 0)\r\nreturn status;\r\nreturn 0;\r\n}\r\nstatic int __init acm_ms_bind(struct usb_composite_dev *cdev)\r\n{\r\nstruct usb_gadget *gadget = cdev->gadget;\r\nint status;\r\nvoid *retp;\r\nstatus = gserial_setup(cdev->gadget, 1);\r\nif (status < 0)\r\nreturn status;\r\nretp = fsg_common_from_params(&fsg_common, cdev, &fsg_mod_data);\r\nif (IS_ERR(retp)) {\r\nstatus = PTR_ERR(retp);\r\ngoto fail0;\r\n}\r\nstatus = usb_string_ids_tab(cdev, strings_dev);\r\nif (status < 0)\r\ngoto fail1;\r\ndevice_desc.iManufacturer = strings_dev[USB_GADGET_MANUFACTURER_IDX].id;\r\ndevice_desc.iProduct = strings_dev[USB_GADGET_PRODUCT_IDX].id;\r\nstatus = usb_add_config(cdev, &acm_ms_config_driver, acm_ms_do_config);\r\nif (status < 0)\r\ngoto fail1;\r\nusb_composite_overwrite_options(cdev, &coverwrite);\r\ndev_info(&gadget->dev, "%s, version: " DRIVER_VERSION "\n",\r\nDRIVER_DESC);\r\nfsg_common_put(&fsg_common);\r\nreturn 0;\r\nfail1:\r\nfsg_common_put(&fsg_common);\r\nfail0:\r\ngserial_cleanup();\r\nreturn status;\r\n}\r\nstatic int __exit acm_ms_unbind(struct usb_composite_dev *cdev)\r\n{\r\ngserial_cleanup();\r\nreturn 0;\r\n}\r\nstatic int __init init(void)\r\n{\r\nreturn usb_composite_probe(&acm_ms_driver);\r\n}\r\nstatic void __exit cleanup(void)\r\n{\r\nusb_composite_unregister(&acm_ms_driver);\r\n}

static void dev_remove(struct net *net, dev_t dev)\r\n{\r\nstruct bl_pipe_msg bl_pipe_msg;\r\nstruct rpc_pipe_msg *msg = &bl_pipe_msg.msg;\r\nstruct bl_dev_msg bl_umount_request;\r\nstruct bl_msg_hdr bl_msg = {\r\n.type = BL_DEVICE_UMOUNT,\r\n.totallen = sizeof(bl_umount_request),\r\n};\r\nuint8_t *dataptr;\r\nDECLARE_WAITQUEUE(wq, current);\r\nstruct nfs_net *nn = net_generic(net, nfs_net_id);\r\ndprintk("Entering %s\n", __func__);\r\nbl_pipe_msg.bl_wq = &nn->bl_wq;\r\nmemset(msg, 0, sizeof(*msg));\r\nmsg->data = kzalloc(1 + sizeof(bl_umount_request), GFP_NOFS);\r\nif (!msg->data)\r\ngoto out;\r\nmemset(&bl_umount_request, 0, sizeof(bl_umount_request));\r\nbl_umount_request.major = MAJOR(dev);\r\nbl_umount_request.minor = MINOR(dev);\r\nmemcpy(msg->data, &bl_msg, sizeof(bl_msg));\r\ndataptr = (uint8_t *) msg->data;\r\nmemcpy(&dataptr[sizeof(bl_msg)], &bl_umount_request, sizeof(bl_umount_request));\r\nmsg->len = sizeof(bl_msg) + bl_msg.totallen;\r\nadd_wait_queue(&nn->bl_wq, &wq);\r\nif (rpc_queue_upcall(nn->bl_device_pipe, msg) < 0) {\r\nremove_wait_queue(&nn->bl_wq, &wq);\r\ngoto out;\r\n}\r\nset_current_state(TASK_UNINTERRUPTIBLE);\r\nschedule();\r\n__set_current_state(TASK_RUNNING);\r\nremove_wait_queue(&nn->bl_wq, &wq);\r\nout:\r\nkfree(msg->data);\r\n}\r\nstatic void nfs4_blk_metadev_release(struct pnfs_block_dev *bdev)\r\n{\r\nint rv;\r\ndprintk("%s Releasing\n", __func__);\r\nrv = nfs4_blkdev_put(bdev->bm_mdev);\r\nif (rv)\r\nprintk(KERN_ERR "NFS: %s nfs4_blkdev_put returns %d\n",\r\n__func__, rv);\r\ndev_remove(bdev->net, bdev->bm_mdev->bd_dev);\r\n}\r\nvoid bl_free_block_dev(struct pnfs_block_dev *bdev)\r\n{\r\nif (bdev) {\r\nif (bdev->bm_mdev) {\r\ndprintk("%s Removing DM device: %d:%d\n",\r\n__func__,\r\nMAJOR(bdev->bm_mdev->bd_dev),\r\nMINOR(bdev->bm_mdev->bd_dev));\r\nnfs4_blk_metadev_release(bdev);\r\n}\r\nkfree(bdev);\r\n}\r\n}

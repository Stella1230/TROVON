static inline void irda_usb_dump_class_desc(struct usb_serial *serial,\r\nstruct usb_irda_cs_descriptor *desc)\r\n{\r\nstruct device *dev = &serial->dev->dev;\r\ndev_dbg(dev, "bLength=%x\n", desc->bLength);\r\ndev_dbg(dev, "bDescriptorType=%x\n", desc->bDescriptorType);\r\ndev_dbg(dev, "bcdSpecRevision=%x\n", __le16_to_cpu(desc->bcdSpecRevision));\r\ndev_dbg(dev, "bmDataSize=%x\n", desc->bmDataSize);\r\ndev_dbg(dev, "bmWindowSize=%x\n", desc->bmWindowSize);\r\ndev_dbg(dev, "bmMinTurnaroundTime=%d\n", desc->bmMinTurnaroundTime);\r\ndev_dbg(dev, "wBaudRate=%x\n", __le16_to_cpu(desc->wBaudRate));\r\ndev_dbg(dev, "bmAdditionalBOFs=%x\n", desc->bmAdditionalBOFs);\r\ndev_dbg(dev, "bIrdaRateSniff=%x\n", desc->bIrdaRateSniff);\r\ndev_dbg(dev, "bMaxUnicastList=%x\n", desc->bMaxUnicastList);\r\n}\r\nstatic struct usb_irda_cs_descriptor *\r\nirda_usb_find_class_desc(struct usb_serial *serial, unsigned int ifnum)\r\n{\r\nstruct usb_device *dev = serial->dev;\r\nstruct usb_irda_cs_descriptor *desc;\r\nint ret;\r\ndesc = kzalloc(sizeof(*desc), GFP_KERNEL);\r\nif (!desc)\r\nreturn NULL;\r\nret = usb_control_msg(dev, usb_rcvctrlpipe(dev, 0),\r\nUSB_REQ_CS_IRDA_GET_CLASS_DESC,\r\nUSB_DIR_IN | USB_TYPE_CLASS | USB_RECIP_INTERFACE,\r\n0, ifnum, desc, sizeof(*desc), 1000);\r\ndev_dbg(&serial->dev->dev, "%s - ret=%d\n", __func__, ret);\r\nif (ret < sizeof(*desc)) {\r\ndev_dbg(&serial->dev->dev,\r\n"%s - class descriptor read %s (%d)\n", __func__,\r\n(ret < 0) ? "failed" : "too short", ret);\r\ngoto error;\r\n}\r\nif (desc->bDescriptorType != USB_DT_CS_IRDA) {\r\ndev_dbg(&serial->dev->dev, "%s - bad class descriptor type\n",\r\n__func__);\r\ngoto error;\r\n}\r\nirda_usb_dump_class_desc(serial, desc);\r\nreturn desc;\r\nerror:\r\nkfree(desc);\r\nreturn NULL;\r\n}\r\nstatic u8 ir_xbof_change(u8 xbof)\r\n{\r\nu8 result;\r\nswitch (xbof) {\r\ncase 48:\r\nresult = 0x10;\r\nbreak;\r\ncase 28:\r\ncase 24:\r\nresult = 0x20;\r\nbreak;\r\ndefault:\r\ncase 12:\r\nresult = 0x30;\r\nbreak;\r\ncase 5:\r\ncase 6:\r\nresult = 0x40;\r\nbreak;\r\ncase 3:\r\nresult = 0x50;\r\nbreak;\r\ncase 2:\r\nresult = 0x60;\r\nbreak;\r\ncase 1:\r\nresult = 0x70;\r\nbreak;\r\ncase 0:\r\nresult = 0x80;\r\nbreak;\r\n}\r\nreturn(result);\r\n}\r\nstatic int ir_startup(struct usb_serial *serial)\r\n{\r\nstruct usb_irda_cs_descriptor *irda_desc;\r\nirda_desc = irda_usb_find_class_desc(serial, 0);\r\nif (!irda_desc) {\r\ndev_err(&serial->dev->dev,\r\n"IRDA class descriptor not found, device not bound\n");\r\nreturn -ENODEV;\r\n}\r\ndev_dbg(&serial->dev->dev,\r\n"%s - Baud rates supported:%s%s%s%s%s%s%s%s%s\n",\r\n__func__,\r\n(irda_desc->wBaudRate & USB_IRDA_BR_2400) ? " 2400" : "",\r\n(irda_desc->wBaudRate & USB_IRDA_BR_9600) ? " 9600" : "",\r\n(irda_desc->wBaudRate & USB_IRDA_BR_19200) ? " 19200" : "",\r\n(irda_desc->wBaudRate & USB_IRDA_BR_38400) ? " 38400" : "",\r\n(irda_desc->wBaudRate & USB_IRDA_BR_57600) ? " 57600" : "",\r\n(irda_desc->wBaudRate & USB_IRDA_BR_115200) ? " 115200" : "",\r\n(irda_desc->wBaudRate & USB_IRDA_BR_576000) ? " 576000" : "",\r\n(irda_desc->wBaudRate & USB_IRDA_BR_1152000) ? " 1152000" : "",\r\n(irda_desc->wBaudRate & USB_IRDA_BR_4000000) ? " 4000000" : "");\r\nswitch (irda_desc->bmAdditionalBOFs) {\r\ncase USB_IRDA_AB_48:\r\nir_add_bof = 48;\r\nbreak;\r\ncase USB_IRDA_AB_24:\r\nir_add_bof = 24;\r\nbreak;\r\ncase USB_IRDA_AB_12:\r\nir_add_bof = 12;\r\nbreak;\r\ncase USB_IRDA_AB_6:\r\nir_add_bof = 6;\r\nbreak;\r\ncase USB_IRDA_AB_3:\r\nir_add_bof = 3;\r\nbreak;\r\ncase USB_IRDA_AB_2:\r\nir_add_bof = 2;\r\nbreak;\r\ncase USB_IRDA_AB_1:\r\nir_add_bof = 1;\r\nbreak;\r\ncase USB_IRDA_AB_0:\r\nir_add_bof = 0;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nkfree(irda_desc);\r\nreturn 0;\r\n}\r\nstatic int ir_open(struct tty_struct *tty, struct usb_serial_port *port)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(port->write_urbs); ++i)\r\nport->write_urbs[i]->transfer_flags = URB_ZERO_PACKET;\r\nreturn usb_serial_generic_open(tty, port);\r\n}\r\nstatic int ir_prepare_write_buffer(struct usb_serial_port *port,\r\nvoid *dest, size_t size)\r\n{\r\nunsigned char *buf = dest;\r\nint count;\r\n*buf = ir_xbof | ir_baud;\r\ncount = kfifo_out_locked(&port->write_fifo, buf + 1, size - 1,\r\n&port->lock);\r\nreturn count + 1;\r\n}\r\nstatic void ir_process_read_urb(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nunsigned char *data = urb->transfer_buffer;\r\nstruct tty_struct *tty;\r\nif (!urb->actual_length)\r\nreturn;\r\nif (*data & 0x0f)\r\nir_baud = *data & 0x0f;\r\nif (urb->actual_length == 1)\r\nreturn;\r\ntty = tty_port_tty_get(&port->port);\r\nif (!tty)\r\nreturn;\r\ntty_insert_flip_string(tty, data + 1, urb->actual_length - 1);\r\ntty_flip_buffer_push(tty);\r\ntty_kref_put(tty);\r\n}\r\nstatic void ir_set_termios_callback(struct urb *urb)\r\n{\r\nkfree(urb->transfer_buffer);\r\nif (urb->status)\r\ndev_dbg(&urb->dev->dev, "%s - non-zero urb status: %d\n",\r\n__func__, urb->status);\r\n}\r\nstatic void ir_set_termios(struct tty_struct *tty,\r\nstruct usb_serial_port *port, struct ktermios *old_termios)\r\n{\r\nstruct urb *urb;\r\nunsigned char *transfer_buffer;\r\nint result;\r\nspeed_t baud;\r\nint ir_baud;\r\nbaud = tty_get_baud_rate(tty);\r\nswitch (baud) {\r\ncase 2400:\r\nir_baud = USB_IRDA_BR_2400;\r\nbreak;\r\ncase 9600:\r\nir_baud = USB_IRDA_BR_9600;\r\nbreak;\r\ncase 19200:\r\nir_baud = USB_IRDA_BR_19200;\r\nbreak;\r\ncase 38400:\r\nir_baud = USB_IRDA_BR_38400;\r\nbreak;\r\ncase 57600:\r\nir_baud = USB_IRDA_BR_57600;\r\nbreak;\r\ncase 115200:\r\nir_baud = USB_IRDA_BR_115200;\r\nbreak;\r\ncase 576000:\r\nir_baud = USB_IRDA_BR_576000;\r\nbreak;\r\ncase 1152000:\r\nir_baud = USB_IRDA_BR_1152000;\r\nbreak;\r\ncase 4000000:\r\nir_baud = USB_IRDA_BR_4000000;\r\nbreak;\r\ndefault:\r\nir_baud = USB_IRDA_BR_9600;\r\nbaud = 9600;\r\n}\r\nif (xbof == -1)\r\nir_xbof = ir_xbof_change(ir_add_bof);\r\nelse\r\nir_xbof = ir_xbof_change(xbof) ;\r\ntty_termios_copy_hw(&tty->termios, old_termios);\r\ntty_encode_baud_rate(tty, baud, baud);\r\nurb = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!urb) {\r\ndev_err(&port->dev, "%s - no more urbs\n", __func__);\r\nreturn;\r\n}\r\ntransfer_buffer = kmalloc(1, GFP_KERNEL);\r\nif (!transfer_buffer) {\r\ndev_err(&port->dev, "%s - out of memory\n", __func__);\r\ngoto err_buf;\r\n}\r\n*transfer_buffer = ir_xbof | ir_baud;\r\nusb_fill_bulk_urb(\r\nurb,\r\nport->serial->dev,\r\nusb_sndbulkpipe(port->serial->dev,\r\nport->bulk_out_endpointAddress),\r\ntransfer_buffer,\r\n1,\r\nir_set_termios_callback,\r\nport);\r\nurb->transfer_flags = URB_ZERO_PACKET;\r\nresult = usb_submit_urb(urb, GFP_KERNEL);\r\nif (result) {\r\ndev_err(&port->dev, "%s - failed to submit urb: %d\n",\r\n__func__, result);\r\ngoto err_subm;\r\n}\r\nusb_free_urb(urb);\r\nreturn;\r\nerr_subm:\r\nkfree(transfer_buffer);\r\nerr_buf:\r\nusb_free_urb(urb);\r\n}\r\nstatic int __init ir_init(void)\r\n{\r\nif (buffer_size) {\r\nir_device.bulk_in_size = buffer_size;\r\nir_device.bulk_out_size = buffer_size;\r\n}\r\nreturn usb_serial_register_drivers(serial_drivers, KBUILD_MODNAME, ir_id_table);\r\n}\r\nstatic void __exit ir_exit(void)\r\n{\r\nusb_serial_deregister_drivers(serial_drivers);\r\n}

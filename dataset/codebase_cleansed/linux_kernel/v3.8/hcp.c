int nfc_hci_hcp_message_tx(struct nfc_hci_dev *hdev, u8 pipe,\r\nu8 type, u8 instruction,\r\nconst u8 *payload, size_t payload_len,\r\ndata_exchange_cb_t cb, void *cb_context,\r\nunsigned long completion_delay)\r\n{\r\nstruct nfc_dev *ndev = hdev->ndev;\r\nstruct hci_msg *cmd;\r\nconst u8 *ptr = payload;\r\nint hci_len, err;\r\nbool firstfrag = true;\r\ncmd = kzalloc(sizeof(struct hci_msg), GFP_KERNEL);\r\nif (cmd == NULL)\r\nreturn -ENOMEM;\r\nINIT_LIST_HEAD(&cmd->msg_l);\r\nskb_queue_head_init(&cmd->msg_frags);\r\ncmd->wait_response = (type == NFC_HCI_HCP_COMMAND) ? true : false;\r\ncmd->cb = cb;\r\ncmd->cb_context = cb_context;\r\ncmd->completion_delay = completion_delay;\r\nhci_len = payload_len + 1;\r\nwhile (hci_len > 0) {\r\nstruct sk_buff *skb;\r\nint skb_len, data_link_len;\r\nstruct hcp_packet *packet;\r\nif (NFC_HCI_HCP_PACKET_HEADER_LEN + hci_len <=\r\nhdev->max_data_link_payload)\r\ndata_link_len = hci_len;\r\nelse\r\ndata_link_len = hdev->max_data_link_payload -\r\nNFC_HCI_HCP_PACKET_HEADER_LEN;\r\nskb_len = ndev->tx_headroom + NFC_HCI_HCP_PACKET_HEADER_LEN +\r\ndata_link_len + ndev->tx_tailroom;\r\nhci_len -= data_link_len;\r\nskb = alloc_skb(skb_len, GFP_KERNEL);\r\nif (skb == NULL) {\r\nerr = -ENOMEM;\r\ngoto out_skb_err;\r\n}\r\nskb_reserve(skb, ndev->tx_headroom);\r\nskb_put(skb, NFC_HCI_HCP_PACKET_HEADER_LEN + data_link_len);\r\npacket = (struct hcp_packet *)skb->data;\r\npacket->header = pipe;\r\nif (firstfrag) {\r\nfirstfrag = false;\r\npacket->message.header = HCP_HEADER(type, instruction);\r\nif (ptr) {\r\nmemcpy(packet->message.data, ptr,\r\ndata_link_len - 1);\r\nptr += data_link_len - 1;\r\n}\r\n} else {\r\nmemcpy(&packet->message, ptr, data_link_len);\r\nptr += data_link_len;\r\n}\r\nif (hci_len == 0)\r\npacket->header |= ~NFC_HCI_FRAGMENT;\r\nskb_queue_tail(&cmd->msg_frags, skb);\r\n}\r\nmutex_lock(&hdev->msg_tx_mutex);\r\nlist_add_tail(&cmd->msg_l, &hdev->msg_tx_queue);\r\nmutex_unlock(&hdev->msg_tx_mutex);\r\nschedule_work(&hdev->msg_tx_work);\r\nreturn 0;\r\nout_skb_err:\r\nskb_queue_purge(&cmd->msg_frags);\r\nkfree(cmd);\r\nreturn err;\r\n}\r\nu8 nfc_hci_pipe2gate(struct nfc_hci_dev *hdev, u8 pipe)\r\n{\r\nint gate;\r\nfor (gate = 0; gate < NFC_HCI_MAX_GATES; gate++)\r\nif (hdev->gate2pipe[gate] == pipe)\r\nreturn gate;\r\nreturn 0xff;\r\n}\r\nvoid nfc_hci_hcp_message_rx(struct nfc_hci_dev *hdev, u8 pipe, u8 type,\r\nu8 instruction, struct sk_buff *skb)\r\n{\r\nswitch (type) {\r\ncase NFC_HCI_HCP_RESPONSE:\r\nnfc_hci_resp_received(hdev, instruction, skb);\r\nbreak;\r\ncase NFC_HCI_HCP_COMMAND:\r\nnfc_hci_cmd_received(hdev, pipe, instruction, skb);\r\nbreak;\r\ncase NFC_HCI_HCP_EVENT:\r\nnfc_hci_event_received(hdev, pipe, instruction, skb);\r\nbreak;\r\ndefault:\r\npr_err("UNKNOWN MSG Type %d, instruction=%d\n",\r\ntype, instruction);\r\nkfree_skb(skb);\r\nbreak;\r\n}\r\n}

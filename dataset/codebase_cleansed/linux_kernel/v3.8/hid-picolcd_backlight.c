static int picolcd_get_brightness(struct backlight_device *bdev)\r\n{\r\nstruct picolcd_data *data = bl_get_data(bdev);\r\nreturn data->lcd_brightness;\r\n}\r\nstatic int picolcd_set_brightness(struct backlight_device *bdev)\r\n{\r\nstruct picolcd_data *data = bl_get_data(bdev);\r\nstruct hid_report *report = picolcd_out_report(REPORT_BRIGHTNESS, data->hdev);\r\nunsigned long flags;\r\nif (!report || report->maxfield != 1 || report->field[0]->report_count != 1)\r\nreturn -ENODEV;\r\ndata->lcd_brightness = bdev->props.brightness & 0x0ff;\r\ndata->lcd_power = bdev->props.power;\r\nspin_lock_irqsave(&data->lock, flags);\r\nhid_set_field(report->field[0], 0, data->lcd_power == FB_BLANK_UNBLANK ? data->lcd_brightness : 0);\r\nif (!(data->status & PICOLCD_FAILED))\r\nusbhid_submit_report(data->hdev, report, USB_DIR_OUT);\r\nspin_unlock_irqrestore(&data->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int picolcd_check_bl_fb(struct backlight_device *bdev, struct fb_info *fb)\r\n{\r\nreturn fb && fb == picolcd_fbinfo((struct picolcd_data *)bl_get_data(bdev));\r\n}\r\nint picolcd_init_backlight(struct picolcd_data *data, struct hid_report *report)\r\n{\r\nstruct device *dev = &data->hdev->dev;\r\nstruct backlight_device *bdev;\r\nstruct backlight_properties props;\r\nif (!report)\r\nreturn -ENODEV;\r\nif (report->maxfield != 1 || report->field[0]->report_count != 1 ||\r\nreport->field[0]->report_size != 8) {\r\ndev_err(dev, "unsupported BRIGHTNESS report");\r\nreturn -EINVAL;\r\n}\r\nmemset(&props, 0, sizeof(props));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = 0xff;\r\nbdev = backlight_device_register(dev_name(dev), dev, data,\r\n&picolcd_blops, &props);\r\nif (IS_ERR(bdev)) {\r\ndev_err(dev, "failed to register backlight\n");\r\nreturn PTR_ERR(bdev);\r\n}\r\nbdev->props.brightness = 0xff;\r\ndata->lcd_brightness = 0xff;\r\ndata->backlight = bdev;\r\npicolcd_set_brightness(bdev);\r\nreturn 0;\r\n}\r\nvoid picolcd_exit_backlight(struct picolcd_data *data)\r\n{\r\nstruct backlight_device *bdev = data->backlight;\r\ndata->backlight = NULL;\r\nif (bdev)\r\nbacklight_device_unregister(bdev);\r\n}\r\nint picolcd_resume_backlight(struct picolcd_data *data)\r\n{\r\nif (!data->backlight)\r\nreturn 0;\r\nreturn picolcd_set_brightness(data->backlight);\r\n}\r\nvoid picolcd_suspend_backlight(struct picolcd_data *data)\r\n{\r\nint bl_power = data->lcd_power;\r\nif (!data->backlight)\r\nreturn;\r\ndata->backlight->props.power = FB_BLANK_POWERDOWN;\r\npicolcd_set_brightness(data->backlight);\r\ndata->lcd_power = data->backlight->props.power = bl_power;\r\n}

static int snd_seq_oss_synth_info_user(struct seq_oss_devinfo *dp, void __user *arg)\r\n{\r\nstruct synth_info info;\r\nif (copy_from_user(&info, arg, sizeof(info)))\r\nreturn -EFAULT;\r\nif (snd_seq_oss_synth_make_info(dp, info.device, &info) < 0)\r\nreturn -EINVAL;\r\nif (copy_to_user(arg, &info, sizeof(info)))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nstatic int snd_seq_oss_midi_info_user(struct seq_oss_devinfo *dp, void __user *arg)\r\n{\r\nstruct midi_info info;\r\nif (copy_from_user(&info, arg, sizeof(info)))\r\nreturn -EFAULT;\r\nif (snd_seq_oss_midi_make_info(dp, info.device, &info) < 0)\r\nreturn -EINVAL;\r\nif (copy_to_user(arg, &info, sizeof(info)))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nstatic int snd_seq_oss_oob_user(struct seq_oss_devinfo *dp, void __user *arg)\r\n{\r\nunsigned char ev[8];\r\nstruct snd_seq_event tmpev;\r\nif (copy_from_user(ev, arg, 8))\r\nreturn -EFAULT;\r\nmemset(&tmpev, 0, sizeof(tmpev));\r\nsnd_seq_oss_fill_addr(dp, &tmpev, dp->addr.port, dp->addr.client);\r\ntmpev.time.tick = 0;\r\nif (! snd_seq_oss_process_event(dp, (union evrec *)ev, &tmpev)) {\r\nsnd_seq_oss_dispatch(dp, &tmpev, 0, 0);\r\n}\r\nreturn 0;\r\n}\r\nint\r\nsnd_seq_oss_ioctl(struct seq_oss_devinfo *dp, unsigned int cmd, unsigned long carg)\r\n{\r\nint dev, val;\r\nvoid __user *arg = (void __user *)carg;\r\nint __user *p = arg;\r\nswitch (cmd) {\r\ncase SNDCTL_TMR_TIMEBASE:\r\ncase SNDCTL_TMR_TEMPO:\r\ncase SNDCTL_TMR_START:\r\ncase SNDCTL_TMR_STOP:\r\ncase SNDCTL_TMR_CONTINUE:\r\ncase SNDCTL_TMR_METRONOME:\r\ncase SNDCTL_TMR_SOURCE:\r\ncase SNDCTL_TMR_SELECT:\r\ncase SNDCTL_SEQ_CTRLRATE:\r\nreturn snd_seq_oss_timer_ioctl(dp->timer, cmd, arg);\r\ncase SNDCTL_SEQ_PANIC:\r\ndebug_printk(("panic\n"));\r\nsnd_seq_oss_reset(dp);\r\nreturn -EINVAL;\r\ncase SNDCTL_SEQ_SYNC:\r\ndebug_printk(("sync\n"));\r\nif (! is_write_mode(dp->file_mode) || dp->writeq == NULL)\r\nreturn 0;\r\nwhile (snd_seq_oss_writeq_sync(dp->writeq))\r\n;\r\nif (signal_pending(current))\r\nreturn -ERESTARTSYS;\r\nreturn 0;\r\ncase SNDCTL_SEQ_RESET:\r\ndebug_printk(("reset\n"));\r\nsnd_seq_oss_reset(dp);\r\nreturn 0;\r\ncase SNDCTL_SEQ_TESTMIDI:\r\ndebug_printk(("test midi\n"));\r\nif (get_user(dev, p))\r\nreturn -EFAULT;\r\nreturn snd_seq_oss_midi_open(dp, dev, dp->file_mode);\r\ncase SNDCTL_SEQ_GETINCOUNT:\r\ndebug_printk(("get in count\n"));\r\nif (dp->readq == NULL || ! is_read_mode(dp->file_mode))\r\nreturn 0;\r\nreturn put_user(dp->readq->qlen, p) ? -EFAULT : 0;\r\ncase SNDCTL_SEQ_GETOUTCOUNT:\r\ndebug_printk(("get out count\n"));\r\nif (! is_write_mode(dp->file_mode) || dp->writeq == NULL)\r\nreturn 0;\r\nreturn put_user(snd_seq_oss_writeq_get_free_size(dp->writeq), p) ? -EFAULT : 0;\r\ncase SNDCTL_SEQ_GETTIME:\r\ndebug_printk(("get time\n"));\r\nreturn put_user(snd_seq_oss_timer_cur_tick(dp->timer), p) ? -EFAULT : 0;\r\ncase SNDCTL_SEQ_RESETSAMPLES:\r\ndebug_printk(("reset samples\n"));\r\nif (get_user(dev, p))\r\nreturn -EFAULT;\r\nreturn snd_seq_oss_synth_ioctl(dp, dev, cmd, carg);\r\ncase SNDCTL_SEQ_NRSYNTHS:\r\ndebug_printk(("nr synths\n"));\r\nreturn put_user(dp->max_synthdev, p) ? -EFAULT : 0;\r\ncase SNDCTL_SEQ_NRMIDIS:\r\ndebug_printk(("nr midis\n"));\r\nreturn put_user(dp->max_mididev, p) ? -EFAULT : 0;\r\ncase SNDCTL_SYNTH_MEMAVL:\r\ndebug_printk(("mem avail\n"));\r\nif (get_user(dev, p))\r\nreturn -EFAULT;\r\nval = snd_seq_oss_synth_ioctl(dp, dev, cmd, carg);\r\nreturn put_user(val, p) ? -EFAULT : 0;\r\ncase SNDCTL_FM_4OP_ENABLE:\r\ndebug_printk(("4op\n"));\r\nif (get_user(dev, p))\r\nreturn -EFAULT;\r\nsnd_seq_oss_synth_ioctl(dp, dev, cmd, carg);\r\nreturn 0;\r\ncase SNDCTL_SYNTH_INFO:\r\ncase SNDCTL_SYNTH_ID:\r\ndebug_printk(("synth info\n"));\r\nreturn snd_seq_oss_synth_info_user(dp, arg);\r\ncase SNDCTL_SEQ_OUTOFBAND:\r\ndebug_printk(("out of band\n"));\r\nreturn snd_seq_oss_oob_user(dp, arg);\r\ncase SNDCTL_MIDI_INFO:\r\ndebug_printk(("midi info\n"));\r\nreturn snd_seq_oss_midi_info_user(dp, arg);\r\ncase SNDCTL_SEQ_THRESHOLD:\r\ndebug_printk(("threshold\n"));\r\nif (! is_write_mode(dp->file_mode))\r\nreturn 0;\r\nif (get_user(val, p))\r\nreturn -EFAULT;\r\nif (val < 1)\r\nval = 1;\r\nif (val >= dp->writeq->maxlen)\r\nval = dp->writeq->maxlen - 1;\r\nsnd_seq_oss_writeq_set_output(dp->writeq, val);\r\nreturn 0;\r\ncase SNDCTL_MIDI_PRETIME:\r\ndebug_printk(("pretime\n"));\r\nif (dp->readq == NULL || !is_read_mode(dp->file_mode))\r\nreturn 0;\r\nif (get_user(val, p))\r\nreturn -EFAULT;\r\nif (val <= 0)\r\nval = -1;\r\nelse\r\nval = (HZ * val) / 10;\r\ndp->readq->pre_event_timeout = val;\r\nreturn put_user(val, p) ? -EFAULT : 0;\r\ndefault:\r\ndebug_printk(("others\n"));\r\nif (! is_write_mode(dp->file_mode))\r\nreturn -EIO;\r\nreturn snd_seq_oss_synth_ioctl(dp, 0, cmd, carg);\r\n}\r\nreturn 0;\r\n}

static int stv_sndctrl(struct gspca_dev *gspca_dev, int set, u8 req, u16 val,\r\nint size)\r\n{\r\nint ret = -1;\r\nu8 req_type = 0;\r\nunsigned int pipe = 0;\r\nswitch (set) {\r\ncase 0:\r\nreq_type = USB_DIR_IN | USB_TYPE_VENDOR | USB_RECIP_ENDPOINT;\r\npipe = usb_rcvctrlpipe(gspca_dev->dev, 0);\r\nbreak;\r\ncase 1:\r\nreq_type = USB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_ENDPOINT;\r\npipe = usb_sndctrlpipe(gspca_dev->dev, 0);\r\nbreak;\r\ncase 2:\r\nreq_type = USB_DIR_IN | USB_RECIP_DEVICE;\r\npipe = usb_rcvctrlpipe(gspca_dev->dev, 0);\r\nbreak;\r\ncase 3:\r\nreq_type = USB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE;\r\npipe = usb_sndctrlpipe(gspca_dev->dev, 0);\r\nbreak;\r\n}\r\nret = usb_control_msg(gspca_dev->dev, pipe,\r\nreq, req_type,\r\nval, 0, gspca_dev->usb_buf, size, 500);\r\nif ((ret < 0) && (req != 0x0a))\r\npr_err("usb_control_msg error %i, request = 0x%x, error = %i\n",\r\nset, req, ret);\r\nreturn ret;\r\n}\r\nstatic int stv0680_handle_error(struct gspca_dev *gspca_dev, int ret)\r\n{\r\nstv_sndctrl(gspca_dev, 0, 0x80, 0, 0x02);\r\nPDEBUG(D_ERR, "last error: %i, command = 0x%x",\r\ngspca_dev->usb_buf[0], gspca_dev->usb_buf[1]);\r\nreturn ret;\r\n}\r\nstatic int stv0680_get_video_mode(struct gspca_dev *gspca_dev)\r\n{\r\nmemset(gspca_dev->usb_buf, 0, 8);\r\ngspca_dev->usb_buf[0] = 0x0f;\r\nif (stv_sndctrl(gspca_dev, 0, 0x87, 0, 0x08) != 0x08) {\r\nPDEBUG(D_ERR, "Get_Camera_Mode failed");\r\nreturn stv0680_handle_error(gspca_dev, -EIO);\r\n}\r\nreturn gspca_dev->usb_buf[0];\r\n}\r\nstatic int stv0680_set_video_mode(struct gspca_dev *gspca_dev, u8 mode)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nif (sd->current_mode == mode)\r\nreturn 0;\r\nmemset(gspca_dev->usb_buf, 0, 8);\r\ngspca_dev->usb_buf[0] = mode;\r\nif (stv_sndctrl(gspca_dev, 3, 0x07, 0x0100, 0x08) != 0x08) {\r\nPDEBUG(D_ERR, "Set_Camera_Mode failed");\r\nreturn stv0680_handle_error(gspca_dev, -EIO);\r\n}\r\nif (stv0680_get_video_mode(gspca_dev) != mode) {\r\nPDEBUG(D_ERR, "Error setting camera video mode!");\r\nreturn -EIO;\r\n}\r\nsd->current_mode = mode;\r\nreturn 0;\r\n}\r\nstatic int sd_config(struct gspca_dev *gspca_dev,\r\nconst struct usb_device_id *id)\r\n{\r\nint ret;\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nstruct cam *cam = &gspca_dev->cam;\r\nmsleep(1000);\r\nif (stv_sndctrl(gspca_dev, 0, 0x88, 0x5678, 0x02) != 0x02 ||\r\ngspca_dev->usb_buf[0] != 0x56 || gspca_dev->usb_buf[1] != 0x78) {\r\nPDEBUG(D_ERR, "STV(e): camera ping failed!!");\r\nreturn stv0680_handle_error(gspca_dev, -ENODEV);\r\n}\r\nif (stv_sndctrl(gspca_dev, 2, 0x06, 0x0200, 0x09) != 0x09)\r\nreturn stv0680_handle_error(gspca_dev, -ENODEV);\r\nif (stv_sndctrl(gspca_dev, 2, 0x06, 0x0200, 0x22) != 0x22 ||\r\ngspca_dev->usb_buf[7] != 0xa0 || gspca_dev->usb_buf[8] != 0x23) {\r\nPDEBUG(D_ERR, "Could not get descriptor 0200.");\r\nreturn stv0680_handle_error(gspca_dev, -ENODEV);\r\n}\r\nif (stv_sndctrl(gspca_dev, 0, 0x8a, 0, 0x02) != 0x02)\r\nreturn stv0680_handle_error(gspca_dev, -ENODEV);\r\nif (stv_sndctrl(gspca_dev, 0, 0x8b, 0, 0x24) != 0x24)\r\nreturn stv0680_handle_error(gspca_dev, -ENODEV);\r\nif (stv_sndctrl(gspca_dev, 0, 0x85, 0, 0x10) != 0x10)\r\nreturn stv0680_handle_error(gspca_dev, -ENODEV);\r\nif (!(gspca_dev->usb_buf[7] & 0x09)) {\r\nPDEBUG(D_ERR, "Camera supports neither CIF nor QVGA mode");\r\nreturn -ENODEV;\r\n}\r\nif (gspca_dev->usb_buf[7] & 0x01)\r\nPDEBUG(D_PROBE, "Camera supports CIF mode");\r\nif (gspca_dev->usb_buf[7] & 0x02)\r\nPDEBUG(D_PROBE, "Camera supports VGA mode");\r\nif (gspca_dev->usb_buf[7] & 0x04)\r\nPDEBUG(D_PROBE, "Camera supports QCIF mode");\r\nif (gspca_dev->usb_buf[7] & 0x08)\r\nPDEBUG(D_PROBE, "Camera supports QVGA mode");\r\nif (gspca_dev->usb_buf[7] & 0x01)\r\nsd->video_mode = 0x00;\r\nelse\r\nsd->video_mode = 0x03;\r\nPDEBUG(D_PROBE, "Firmware rev is %i.%i",\r\ngspca_dev->usb_buf[0], gspca_dev->usb_buf[1]);\r\nPDEBUG(D_PROBE, "ASIC rev is %i.%i",\r\ngspca_dev->usb_buf[2], gspca_dev->usb_buf[3]);\r\nPDEBUG(D_PROBE, "Sensor ID is %i",\r\n(gspca_dev->usb_buf[4]*16) + (gspca_dev->usb_buf[5]>>4));\r\nret = stv0680_get_video_mode(gspca_dev);\r\nif (ret < 0)\r\nreturn ret;\r\nsd->current_mode = sd->orig_mode = ret;\r\nret = stv0680_set_video_mode(gspca_dev, sd->video_mode);\r\nif (ret < 0)\r\nreturn ret;\r\nif (stv_sndctrl(gspca_dev, 0, 0x8f, 0, 0x10) != 0x10)\r\nreturn stv0680_handle_error(gspca_dev, -EIO);\r\ncam->bulk = 1;\r\ncam->bulk_nurbs = 1;\r\ncam->bulk_size = (gspca_dev->usb_buf[0] << 24) |\r\n(gspca_dev->usb_buf[1] << 16) |\r\n(gspca_dev->usb_buf[2] << 8) |\r\n(gspca_dev->usb_buf[3]);\r\nsd->mode.width = (gspca_dev->usb_buf[4] << 8) |\r\n(gspca_dev->usb_buf[5]);\r\nsd->mode.height = (gspca_dev->usb_buf[6] << 8) |\r\n(gspca_dev->usb_buf[7]);\r\nsd->mode.pixelformat = V4L2_PIX_FMT_STV0680;\r\nsd->mode.field = V4L2_FIELD_NONE;\r\nsd->mode.bytesperline = sd->mode.width;\r\nsd->mode.sizeimage = cam->bulk_size;\r\nsd->mode.colorspace = V4L2_COLORSPACE_SRGB;\r\ncam->cam_mode = &sd->mode;\r\ncam->nmodes = 1;\r\nret = stv0680_set_video_mode(gspca_dev, sd->orig_mode);\r\nif (ret < 0)\r\nreturn ret;\r\nif (stv_sndctrl(gspca_dev, 2, 0x06, 0x0100, 0x12) != 0x12 ||\r\ngspca_dev->usb_buf[8] != 0x53 || gspca_dev->usb_buf[9] != 0x05) {\r\npr_err("Could not get descriptor 0100\n");\r\nreturn stv0680_handle_error(gspca_dev, -EIO);\r\n}\r\nreturn 0;\r\n}\r\nstatic int sd_init(struct gspca_dev *gspca_dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int sd_start(struct gspca_dev *gspca_dev)\r\n{\r\nint ret;\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nret = stv0680_set_video_mode(gspca_dev, sd->video_mode);\r\nif (ret < 0)\r\nreturn ret;\r\nif (stv_sndctrl(gspca_dev, 0, 0x85, 0, 0x10) != 0x10)\r\nreturn stv0680_handle_error(gspca_dev, -EIO);\r\nif (stv_sndctrl(gspca_dev, 1, 0x09, sd->video_mode << 8, 0x0) != 0x0)\r\nreturn stv0680_handle_error(gspca_dev, -EIO);\r\nreturn 0;\r\n}\r\nstatic void sd_stopN(struct gspca_dev *gspca_dev)\r\n{\r\nif (stv_sndctrl(gspca_dev, 1, 0x04, 0x0000, 0x0) != 0x0)\r\nstv0680_handle_error(gspca_dev, -EIO);\r\n}\r\nstatic void sd_stop0(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nif (!sd->gspca_dev.present)\r\nreturn;\r\nstv0680_set_video_mode(gspca_dev, sd->orig_mode);\r\n}\r\nstatic void sd_pkt_scan(struct gspca_dev *gspca_dev,\r\nu8 *data,\r\nint len)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nif (len != sd->mode.sizeimage) {\r\ngspca_dev->last_packet_type = DISCARD_PACKET;\r\nreturn;\r\n}\r\ngspca_frame_add(gspca_dev, LAST_PACKET, NULL, 0);\r\ngspca_frame_add(gspca_dev, FIRST_PACKET, data, len);\r\n}\r\nstatic int sd_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nreturn gspca_dev_probe(intf, id, &sd_desc, sizeof(struct sd),\r\nTHIS_MODULE);\r\n}

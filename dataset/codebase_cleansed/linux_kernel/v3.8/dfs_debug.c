static ssize_t read_file_dfs(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath_softc *sc = file->private_data;\r\nstruct ath9k_hw_version *hw_ver = &sc->sc_ah->hw_version;\r\nchar *buf;\r\nunsigned int len = 0, size = 8000;\r\nssize_t retval = 0;\r\nbuf = kzalloc(size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nlen += snprintf(buf + len, size - len, "DFS support for "\r\n"macVersion = 0x%x, macRev = 0x%x: %s\n",\r\nhw_ver->macVersion, hw_ver->macRev,\r\n(sc->sc_ah->caps.hw_caps & ATH9K_HW_CAP_DFS) ?\r\n"enabled" : "disabled");\r\nlen += snprintf(buf + len, size - len, "Pulse detector statistics:\n");\r\nATH9K_DFS_STAT("pulse events reported ", pulses_total);\r\nATH9K_DFS_STAT("invalid pulse events ", pulses_no_dfs);\r\nATH9K_DFS_STAT("DFS pulses detected ", pulses_detected);\r\nATH9K_DFS_STAT("Datalen discards ", datalen_discards);\r\nATH9K_DFS_STAT("RSSI discards ", rssi_discards);\r\nATH9K_DFS_STAT("BW info discards ", bwinfo_discards);\r\nATH9K_DFS_STAT("Primary channel pulses ", pri_phy_errors);\r\nATH9K_DFS_STAT("Secondary channel pulses", ext_phy_errors);\r\nATH9K_DFS_STAT("Dual channel pulses ", dc_phy_errors);\r\nlen += snprintf(buf + len, size - len, "Radar detector statistics "\r\n"(current DFS region: %d)\n", sc->dfs_detector->region);\r\nATH9K_DFS_STAT("Pulse events processed ", pulses_processed);\r\nATH9K_DFS_STAT("Radars detected ", radar_detected);\r\nlen += snprintf(buf + len, size - len, "Global Pool statistics:\n");\r\nATH9K_DFS_POOL_STAT("Pool references ", pool_reference);\r\nATH9K_DFS_POOL_STAT("Pulses allocated ", pulse_allocated);\r\nATH9K_DFS_POOL_STAT("Pulses alloc error ", pulse_alloc_error);\r\nATH9K_DFS_POOL_STAT("Pulses in use ", pulse_used);\r\nATH9K_DFS_POOL_STAT("Seqs. allocated ", pseq_allocated);\r\nATH9K_DFS_POOL_STAT("Seqs. alloc error ", pseq_alloc_error);\r\nATH9K_DFS_POOL_STAT("Seqs. in use ", pseq_used);\r\nif (len > size)\r\nlen = size;\r\nretval = simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\nkfree(buf);\r\nreturn retval;\r\n}\r\nstatic ssize_t write_file_dfs(struct file *file, const char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath_softc *sc = file->private_data;\r\nunsigned long val;\r\nchar buf[32];\r\nssize_t len;\r\nlen = min(count, sizeof(buf) - 1);\r\nif (copy_from_user(buf, user_buf, len))\r\nreturn -EFAULT;\r\nbuf[len] = '\0';\r\nif (strict_strtoul(buf, 0, &val))\r\nreturn -EINVAL;\r\nif (val == DFS_STATS_RESET_MAGIC)\r\nmemset(&sc->debug.stats.dfs_stats, 0,\r\nsizeof(sc->debug.stats.dfs_stats));\r\nreturn count;\r\n}\r\nvoid ath9k_dfs_init_debug(struct ath_softc *sc)\r\n{\r\ndebugfs_create_file("dfs_stats", S_IRUSR,\r\nsc->debug.debugfs_phy, sc, &fops_dfs_stats);\r\n}

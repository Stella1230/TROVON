static int firmware_map_add_entry(u64 start, u64 end,\r\nconst char *type,\r\nstruct firmware_map_entry *entry)\r\n{\r\nBUG_ON(start > end);\r\nentry->start = start;\r\nentry->end = end - 1;\r\nentry->type = type;\r\nINIT_LIST_HEAD(&entry->list);\r\nkobject_init(&entry->kobj, &memmap_ktype);\r\nlist_add_tail(&entry->list, &map_entries);\r\nreturn 0;\r\n}\r\nstatic int add_sysfs_fw_map_entry(struct firmware_map_entry *entry)\r\n{\r\nstatic int map_entries_nr;\r\nstatic struct kset *mmap_kset;\r\nif (!mmap_kset) {\r\nmmap_kset = kset_create_and_add("memmap", NULL, firmware_kobj);\r\nif (!mmap_kset)\r\nreturn -ENOMEM;\r\n}\r\nentry->kobj.kset = mmap_kset;\r\nif (kobject_add(&entry->kobj, NULL, "%d", map_entries_nr++))\r\nkobject_put(&entry->kobj);\r\nreturn 0;\r\n}\r\nint __meminit firmware_map_add_hotplug(u64 start, u64 end, const char *type)\r\n{\r\nstruct firmware_map_entry *entry;\r\nentry = kzalloc(sizeof(struct firmware_map_entry), GFP_ATOMIC);\r\nif (!entry)\r\nreturn -ENOMEM;\r\nfirmware_map_add_entry(start, end, type, entry);\r\nadd_sysfs_fw_map_entry(entry);\r\nreturn 0;\r\n}\r\nint __init firmware_map_add_early(u64 start, u64 end, const char *type)\r\n{\r\nstruct firmware_map_entry *entry;\r\nentry = alloc_bootmem(sizeof(struct firmware_map_entry));\r\nif (WARN_ON(!entry))\r\nreturn -ENOMEM;\r\nreturn firmware_map_add_entry(start, end, type, entry);\r\n}\r\nstatic ssize_t start_show(struct firmware_map_entry *entry, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "0x%llx\n",\r\n(unsigned long long)entry->start);\r\n}\r\nstatic ssize_t end_show(struct firmware_map_entry *entry, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "0x%llx\n",\r\n(unsigned long long)entry->end);\r\n}\r\nstatic ssize_t type_show(struct firmware_map_entry *entry, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n", entry->type);\r\n}\r\nstatic ssize_t memmap_attr_show(struct kobject *kobj,\r\nstruct attribute *attr, char *buf)\r\n{\r\nstruct firmware_map_entry *entry = to_memmap_entry(kobj);\r\nstruct memmap_attribute *memmap_attr = to_memmap_attr(attr);\r\nreturn memmap_attr->show(entry, buf);\r\n}\r\nstatic int __init firmware_memmap_init(void)\r\n{\r\nstruct firmware_map_entry *entry;\r\nlist_for_each_entry(entry, &map_entries, list)\r\nadd_sysfs_fw_map_entry(entry);\r\nreturn 0;\r\n}

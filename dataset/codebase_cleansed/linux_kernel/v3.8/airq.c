static int register_airq(struct airq_t *airq, u8 isc)\r\n{\r\nint i;\r\nfor (i = 0; i < NR_AIRQS; i++)\r\nif (!cmpxchg(&airqs[isc][i], NULL, airq))\r\nreturn i;\r\nreturn -ENOMEM;\r\n}\r\nvoid *s390_register_adapter_interrupt(adapter_int_handler_t handler,\r\nvoid *drv_data, u8 isc)\r\n{\r\nstruct airq_t *airq;\r\nchar dbf_txt[16];\r\nint ret;\r\nif (isc > MAX_ISC)\r\nreturn ERR_PTR(-EINVAL);\r\nairq = kmalloc(sizeof(struct airq_t), GFP_KERNEL);\r\nif (!airq) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nairq->handler = handler;\r\nairq->drv_data = drv_data;\r\nret = register_airq(airq, isc);\r\nout:\r\nsnprintf(dbf_txt, sizeof(dbf_txt), "rairq:%d", ret);\r\nCIO_TRACE_EVENT(4, dbf_txt);\r\nif (ret < 0) {\r\nkfree(airq);\r\nreturn ERR_PTR(ret);\r\n} else\r\nreturn &indicators[isc].byte[ret];\r\n}\r\nvoid s390_unregister_adapter_interrupt(void *ind, u8 isc)\r\n{\r\nstruct airq_t *airq;\r\nchar dbf_txt[16];\r\nint i;\r\ni = (int) ((addr_t) ind) - ((addr_t) &indicators[isc].byte[0]);\r\nsnprintf(dbf_txt, sizeof(dbf_txt), "urairq:%d", i);\r\nCIO_TRACE_EVENT(4, dbf_txt);\r\nindicators[isc].byte[i] = 0;\r\nairq = xchg(&airqs[isc][i], NULL);\r\nsynchronize_sched();\r\nkfree(airq);\r\n}\r\nvoid do_adapter_IO(u8 isc)\r\n{\r\nint w;\r\nint i;\r\nunsigned long word;\r\nstruct airq_t *airq;\r\nfor (w = 0; w < NR_AIRQ_WORDS; w++) {\r\nword = indicators[isc].word[w];\r\ni = w * NR_AIRQS_PER_WORD;\r\nwhile (word) {\r\nif (word & INDICATOR_MASK) {\r\nairq = airqs[isc][i];\r\nbarrier();\r\nif (likely(airq))\r\nairq->handler(&indicators[isc].byte[i],\r\nairq->drv_data);\r\nelse\r\nindicators[isc].byte[i] = 0;\r\n}\r\nword <<= 8;\r\ni++;\r\n}\r\n}\r\n}

static int masquerade_tg_check(const struct xt_tgchk_param *par)\r\n{\r\nconst struct nf_nat_ipv4_multi_range_compat *mr = par->targinfo;\r\nif (mr->range[0].flags & NF_NAT_RANGE_MAP_IPS) {\r\npr_debug("bad MAP_IPS.\n");\r\nreturn -EINVAL;\r\n}\r\nif (mr->rangesize != 1) {\r\npr_debug("bad rangesize %u\n", mr->rangesize);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned int\r\nmasquerade_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nstruct nf_conn *ct;\r\nstruct nf_conn_nat *nat;\r\nenum ip_conntrack_info ctinfo;\r\nstruct nf_nat_range newrange;\r\nconst struct nf_nat_ipv4_multi_range_compat *mr;\r\nconst struct rtable *rt;\r\n__be32 newsrc, nh;\r\nNF_CT_ASSERT(par->hooknum == NF_INET_POST_ROUTING);\r\nct = nf_ct_get(skb, &ctinfo);\r\nnat = nfct_nat(ct);\r\nNF_CT_ASSERT(ct && (ctinfo == IP_CT_NEW || ctinfo == IP_CT_RELATED ||\r\nctinfo == IP_CT_RELATED_REPLY));\r\nif (ct->tuplehash[IP_CT_DIR_ORIGINAL].tuple.src.u3.ip == 0)\r\nreturn NF_ACCEPT;\r\nmr = par->targinfo;\r\nrt = skb_rtable(skb);\r\nnh = rt_nexthop(rt, ip_hdr(skb)->daddr);\r\nnewsrc = inet_select_addr(par->out, nh, RT_SCOPE_UNIVERSE);\r\nif (!newsrc) {\r\npr_info("%s ate my IP address\n", par->out->name);\r\nreturn NF_DROP;\r\n}\r\nnat->masq_index = par->out->ifindex;\r\nmemset(&newrange.min_addr, 0, sizeof(newrange.min_addr));\r\nmemset(&newrange.max_addr, 0, sizeof(newrange.max_addr));\r\nnewrange.flags = mr->range[0].flags | NF_NAT_RANGE_MAP_IPS;\r\nnewrange.min_addr.ip = newsrc;\r\nnewrange.max_addr.ip = newsrc;\r\nnewrange.min_proto = mr->range[0].min;\r\nnewrange.max_proto = mr->range[0].max;\r\nreturn nf_nat_setup_info(ct, &newrange, NF_NAT_MANIP_SRC);\r\n}\r\nstatic int\r\ndevice_cmp(struct nf_conn *i, void *ifindex)\r\n{\r\nconst struct nf_conn_nat *nat = nfct_nat(i);\r\nif (!nat)\r\nreturn 0;\r\nif (nf_ct_l3num(i) != NFPROTO_IPV4)\r\nreturn 0;\r\nreturn nat->masq_index == (int)(long)ifindex;\r\n}\r\nstatic int masq_device_event(struct notifier_block *this,\r\nunsigned long event,\r\nvoid *ptr)\r\n{\r\nconst struct net_device *dev = ptr;\r\nstruct net *net = dev_net(dev);\r\nif (event == NETDEV_DOWN) {\r\nNF_CT_ASSERT(dev->ifindex != 0);\r\nnf_ct_iterate_cleanup(net, device_cmp,\r\n(void *)(long)dev->ifindex);\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int masq_inet_event(struct notifier_block *this,\r\nunsigned long event,\r\nvoid *ptr)\r\n{\r\nstruct net_device *dev = ((struct in_ifaddr *)ptr)->ifa_dev->dev;\r\nreturn masq_device_event(this, event, dev);\r\n}\r\nstatic int __init masquerade_tg_init(void)\r\n{\r\nint ret;\r\nret = xt_register_target(&masquerade_tg_reg);\r\nif (ret == 0) {\r\nregister_netdevice_notifier(&masq_dev_notifier);\r\nregister_inetaddr_notifier(&masq_inet_notifier);\r\n}\r\nreturn ret;\r\n}\r\nstatic void __exit masquerade_tg_exit(void)\r\n{\r\nxt_unregister_target(&masquerade_tg_reg);\r\nunregister_netdevice_notifier(&masq_dev_notifier);\r\nunregister_inetaddr_notifier(&masq_inet_notifier);\r\n}

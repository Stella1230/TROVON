static struct sk_buff *dnrmg_build_message(struct sk_buff *rt_skb, int *errp)\r\n{\r\nstruct sk_buff *skb = NULL;\r\nsize_t size;\r\nsk_buff_data_t old_tail;\r\nstruct nlmsghdr *nlh;\r\nunsigned char *ptr;\r\nstruct nf_dn_rtmsg *rtm;\r\nsize = NLMSG_SPACE(rt_skb->len);\r\nsize += NLMSG_ALIGN(sizeof(struct nf_dn_rtmsg));\r\nskb = alloc_skb(size, GFP_ATOMIC);\r\nif (!skb) {\r\n*errp = -ENOMEM;\r\nreturn NULL;\r\n}\r\nold_tail = skb->tail;\r\nnlh = nlmsg_put(skb, 0, 0, 0, size - sizeof(*nlh), 0);\r\nif (!nlh) {\r\nkfree_skb(skb);\r\n*errp = -ENOMEM;\r\nreturn NULL;\r\n}\r\nrtm = (struct nf_dn_rtmsg *)NLMSG_DATA(nlh);\r\nrtm->nfdn_ifindex = rt_skb->dev->ifindex;\r\nptr = NFDN_RTMSG(rtm);\r\nskb_copy_from_linear_data(rt_skb, ptr, rt_skb->len);\r\nnlh->nlmsg_len = skb->tail - old_tail;\r\nreturn skb;\r\n}\r\nstatic void dnrmg_send_peer(struct sk_buff *skb)\r\n{\r\nstruct sk_buff *skb2;\r\nint status = 0;\r\nint group = 0;\r\nunsigned char flags = *skb->data;\r\nswitch (flags & DN_RT_CNTL_MSK) {\r\ncase DN_RT_PKT_L1RT:\r\ngroup = DNRNG_NLGRP_L1;\r\nbreak;\r\ncase DN_RT_PKT_L2RT:\r\ngroup = DNRNG_NLGRP_L2;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nskb2 = dnrmg_build_message(skb, &status);\r\nif (skb2 == NULL)\r\nreturn;\r\nNETLINK_CB(skb2).dst_group = group;\r\nnetlink_broadcast(dnrmg, skb2, 0, group, GFP_ATOMIC);\r\n}\r\nstatic unsigned int dnrmg_hook(unsigned int hook,\r\nstruct sk_buff *skb,\r\nconst struct net_device *in,\r\nconst struct net_device *out,\r\nint (*okfn)(struct sk_buff *))\r\n{\r\ndnrmg_send_peer(skb);\r\nreturn NF_ACCEPT;\r\n}\r\nstatic inline void dnrmg_receive_user_skb(struct sk_buff *skb)\r\n{\r\nstruct nlmsghdr *nlh = nlmsg_hdr(skb);\r\nif (nlh->nlmsg_len < sizeof(*nlh) || skb->len < nlh->nlmsg_len)\r\nreturn;\r\nif (!capable(CAP_NET_ADMIN))\r\nRCV_SKB_FAIL(-EPERM);\r\nRCV_SKB_FAIL(-EINVAL);\r\n}\r\nstatic int __init dn_rtmsg_init(void)\r\n{\r\nint rv = 0;\r\nstruct netlink_kernel_cfg cfg = {\r\n.groups = DNRNG_NLGRP_MAX,\r\n.input = dnrmg_receive_user_skb,\r\n};\r\ndnrmg = netlink_kernel_create(&init_net, NETLINK_DNRTMSG, &cfg);\r\nif (dnrmg == NULL) {\r\nprintk(KERN_ERR "dn_rtmsg: Cannot create netlink socket");\r\nreturn -ENOMEM;\r\n}\r\nrv = nf_register_hook(&dnrmg_ops);\r\nif (rv) {\r\nnetlink_kernel_release(dnrmg);\r\n}\r\nreturn rv;\r\n}\r\nstatic void __exit dn_rtmsg_fini(void)\r\n{\r\nnf_unregister_hook(&dnrmg_ops);\r\nnetlink_kernel_release(dnrmg);\r\n}

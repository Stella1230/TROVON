void nsc_gpio_dump(struct nsc_gpio_ops *amp, unsigned index)\r\n{\r\nu32 config = amp->gpio_config(index, ~0, 0);\r\ndev_info(amp->dev, "io%02u: 0x%04x %s %s %s %s %s %s %s\tio:%d/%d\n",\r\nindex, config,\r\n(config & 1) ? "OE" : "TS",\r\n(config & 2) ? "PP" : "OD",\r\n(config & 4) ? "PUE" : "PUD",\r\n(config & 8) ? "LOCKED" : "",\r\n(config & 16) ? "LEVEL" : "EDGE",\r\n(config & 32) ? "HI" : "LO",\r\n(config & 64) ? "DEBOUNCE" : "",\r\namp->gpio_get(index), amp->gpio_current(index));\r\n}\r\nssize_t nsc_gpio_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nunsigned m = iminor(file->f_path.dentry->d_inode);\r\nstruct nsc_gpio_ops *amp = file->private_data;\r\nstruct device *dev = amp->dev;\r\nsize_t i;\r\nint err = 0;\r\nfor (i = 0; i < len; ++i) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nswitch (c) {\r\ncase '0':\r\namp->gpio_set(m, 0);\r\nbreak;\r\ncase '1':\r\namp->gpio_set(m, 1);\r\nbreak;\r\ncase 'O':\r\ndev_dbg(dev, "GPIO%d output enabled\n", m);\r\namp->gpio_config(m, ~1, 1);\r\nbreak;\r\ncase 'o':\r\ndev_dbg(dev, "GPIO%d output disabled\n", m);\r\namp->gpio_config(m, ~1, 0);\r\nbreak;\r\ncase 'T':\r\ndev_dbg(dev, "GPIO%d output is push pull\n", m);\r\namp->gpio_config(m, ~2, 2);\r\nbreak;\r\ncase 't':\r\ndev_dbg(dev, "GPIO%d output is open drain\n", m);\r\namp->gpio_config(m, ~2, 0);\r\nbreak;\r\ncase 'P':\r\ndev_dbg(dev, "GPIO%d pull up enabled\n", m);\r\namp->gpio_config(m, ~4, 4);\r\nbreak;\r\ncase 'p':\r\ndev_dbg(dev, "GPIO%d pull up disabled\n", m);\r\namp->gpio_config(m, ~4, 0);\r\nbreak;\r\ncase 'v':\r\namp->gpio_dump(amp, m);\r\nbreak;\r\ncase '\n':\r\nbreak;\r\ndefault:\r\ndev_err(dev, "io%2d bad setting: chr<0x%2x>\n",\r\nm, (int)c);\r\nerr++;\r\n}\r\n}\r\nif (err)\r\nreturn -EINVAL;\r\nreturn len;\r\n}\r\nssize_t nsc_gpio_read(struct file *file, char __user * buf,\r\nsize_t len, loff_t * ppos)\r\n{\r\nunsigned m = iminor(file->f_path.dentry->d_inode);\r\nint value;\r\nstruct nsc_gpio_ops *amp = file->private_data;\r\nvalue = amp->gpio_get(m);\r\nif (put_user(value ? '1' : '0', buf))\r\nreturn -EFAULT;\r\nreturn 1;\r\n}\r\nstatic int __init nsc_gpio_init(void)\r\n{\r\nprintk(KERN_DEBUG NAME " initializing\n");\r\nreturn 0;\r\n}\r\nstatic void __exit nsc_gpio_cleanup(void)\r\n{\r\nprintk(KERN_DEBUG NAME " cleanup\n");\r\n}

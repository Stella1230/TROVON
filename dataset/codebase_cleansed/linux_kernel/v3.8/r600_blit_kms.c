static void\r\nset_render_target(struct radeon_device *rdev, int format,\r\nint w, int h, u64 gpu_addr)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nu32 cb_color_info;\r\nint pitch, slice;\r\nh = ALIGN(h, 8);\r\nif (h < 8)\r\nh = 8;\r\ncb_color_info = CB_FORMAT(format) |\r\nCB_SOURCE_FORMAT(CB_SF_EXPORT_NORM) |\r\nCB_ARRAY_MODE(ARRAY_1D_TILED_THIN1);\r\npitch = (w / 8) - 1;\r\nslice = ((w * h) / 64) - 1;\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 1));\r\nradeon_ring_write(ring, (CB_COLOR0_BASE - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, gpu_addr >> 8);\r\nif (rdev->family > CHIP_R600 && rdev->family < CHIP_RV770) {\r\nradeon_ring_write(ring, PACKET3(PACKET3_SURFACE_BASE_UPDATE, 0));\r\nradeon_ring_write(ring, 2 << 0);\r\n}\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 1));\r\nradeon_ring_write(ring, (CB_COLOR0_SIZE - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, (pitch << 0) | (slice << 10));\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 1));\r\nradeon_ring_write(ring, (CB_COLOR0_VIEW - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 1));\r\nradeon_ring_write(ring, (CB_COLOR0_INFO - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, cb_color_info);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 1));\r\nradeon_ring_write(ring, (CB_COLOR0_TILE - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 1));\r\nradeon_ring_write(ring, (CB_COLOR0_FRAG - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 1));\r\nradeon_ring_write(ring, (CB_COLOR0_MASK - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, 0);\r\n}\r\nstatic void\r\ncp_set_surface_sync(struct radeon_device *rdev,\r\nu32 sync_type, u32 size,\r\nu64 mc_addr)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nu32 cp_coher_size;\r\nif (size == 0xffffffff)\r\ncp_coher_size = 0xffffffff;\r\nelse\r\ncp_coher_size = ((size + 255) >> 8);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SURFACE_SYNC, 3));\r\nradeon_ring_write(ring, sync_type);\r\nradeon_ring_write(ring, cp_coher_size);\r\nradeon_ring_write(ring, mc_addr >> 8);\r\nradeon_ring_write(ring, 10);\r\n}\r\nstatic void\r\nset_shaders(struct radeon_device *rdev)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nu64 gpu_addr;\r\nu32 sq_pgm_resources;\r\nsq_pgm_resources = (1 << 0);\r\ngpu_addr = rdev->r600_blit.shader_gpu_addr + rdev->r600_blit.vs_offset;\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 1));\r\nradeon_ring_write(ring, (SQ_PGM_START_VS - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, gpu_addr >> 8);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 1));\r\nradeon_ring_write(ring, (SQ_PGM_RESOURCES_VS - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, sq_pgm_resources);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 1));\r\nradeon_ring_write(ring, (SQ_PGM_CF_OFFSET_VS - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, 0);\r\ngpu_addr = rdev->r600_blit.shader_gpu_addr + rdev->r600_blit.ps_offset;\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 1));\r\nradeon_ring_write(ring, (SQ_PGM_START_PS - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, gpu_addr >> 8);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 1));\r\nradeon_ring_write(ring, (SQ_PGM_RESOURCES_PS - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, sq_pgm_resources | (1 << 28));\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 1));\r\nradeon_ring_write(ring, (SQ_PGM_EXPORTS_PS - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, 2);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 1));\r\nradeon_ring_write(ring, (SQ_PGM_CF_OFFSET_PS - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, 0);\r\ngpu_addr = rdev->r600_blit.shader_gpu_addr + rdev->r600_blit.vs_offset;\r\ncp_set_surface_sync(rdev, PACKET3_SH_ACTION_ENA, 512, gpu_addr);\r\n}\r\nstatic void\r\nset_vtx_resource(struct radeon_device *rdev, u64 gpu_addr)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nu32 sq_vtx_constant_word2;\r\nsq_vtx_constant_word2 = SQ_VTXC_BASE_ADDR_HI(upper_32_bits(gpu_addr) & 0xff) |\r\nSQ_VTXC_STRIDE(16);\r\n#ifdef __BIG_ENDIAN\r\nsq_vtx_constant_word2 |= SQ_VTXC_ENDIAN_SWAP(SQ_ENDIAN_8IN32);\r\n#endif\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_RESOURCE, 7));\r\nradeon_ring_write(ring, 0x460);\r\nradeon_ring_write(ring, gpu_addr & 0xffffffff);\r\nradeon_ring_write(ring, 48 - 1);\r\nradeon_ring_write(ring, sq_vtx_constant_word2);\r\nradeon_ring_write(ring, 1 << 0);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, SQ_TEX_VTX_VALID_BUFFER << 30);\r\nif ((rdev->family == CHIP_RV610) ||\r\n(rdev->family == CHIP_RV620) ||\r\n(rdev->family == CHIP_RS780) ||\r\n(rdev->family == CHIP_RS880) ||\r\n(rdev->family == CHIP_RV710))\r\ncp_set_surface_sync(rdev,\r\nPACKET3_TC_ACTION_ENA, 48, gpu_addr);\r\nelse\r\ncp_set_surface_sync(rdev,\r\nPACKET3_VC_ACTION_ENA, 48, gpu_addr);\r\n}\r\nstatic void\r\nset_tex_resource(struct radeon_device *rdev,\r\nint format, int w, int h, int pitch,\r\nu64 gpu_addr, u32 size)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nuint32_t sq_tex_resource_word0, sq_tex_resource_word1, sq_tex_resource_word4;\r\nif (h < 1)\r\nh = 1;\r\nsq_tex_resource_word0 = S_038000_DIM(V_038000_SQ_TEX_DIM_2D) |\r\nS_038000_TILE_MODE(V_038000_ARRAY_1D_TILED_THIN1);\r\nsq_tex_resource_word0 |= S_038000_PITCH((pitch >> 3) - 1) |\r\nS_038000_TEX_WIDTH(w - 1);\r\nsq_tex_resource_word1 = S_038004_DATA_FORMAT(format);\r\nsq_tex_resource_word1 |= S_038004_TEX_HEIGHT(h - 1);\r\nsq_tex_resource_word4 = S_038010_REQUEST_SIZE(1) |\r\nS_038010_DST_SEL_X(SQ_SEL_X) |\r\nS_038010_DST_SEL_Y(SQ_SEL_Y) |\r\nS_038010_DST_SEL_Z(SQ_SEL_Z) |\r\nS_038010_DST_SEL_W(SQ_SEL_W);\r\ncp_set_surface_sync(rdev,\r\nPACKET3_TC_ACTION_ENA, size, gpu_addr);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_RESOURCE, 7));\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, sq_tex_resource_word0);\r\nradeon_ring_write(ring, sq_tex_resource_word1);\r\nradeon_ring_write(ring, gpu_addr >> 8);\r\nradeon_ring_write(ring, gpu_addr >> 8);\r\nradeon_ring_write(ring, sq_tex_resource_word4);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, SQ_TEX_VTX_VALID_TEXTURE << 30);\r\n}\r\nstatic void\r\nset_scissors(struct radeon_device *rdev, int x1, int y1,\r\nint x2, int y2)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 2));\r\nradeon_ring_write(ring, (PA_SC_SCREEN_SCISSOR_TL - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, (x1 << 0) | (y1 << 16));\r\nradeon_ring_write(ring, (x2 << 0) | (y2 << 16));\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 2));\r\nradeon_ring_write(ring, (PA_SC_GENERIC_SCISSOR_TL - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, (x1 << 0) | (y1 << 16) | (1 << 31));\r\nradeon_ring_write(ring, (x2 << 0) | (y2 << 16));\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 2));\r\nradeon_ring_write(ring, (PA_SC_WINDOW_SCISSOR_TL - PACKET3_SET_CONTEXT_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, (x1 << 0) | (y1 << 16) | (1 << 31));\r\nradeon_ring_write(ring, (x2 << 0) | (y2 << 16));\r\n}\r\nstatic void\r\ndraw_auto(struct radeon_device *rdev)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONFIG_REG, 1));\r\nradeon_ring_write(ring, (VGT_PRIMITIVE_TYPE - PACKET3_SET_CONFIG_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, DI_PT_RECTLIST);\r\nradeon_ring_write(ring, PACKET3(PACKET3_INDEX_TYPE, 0));\r\nradeon_ring_write(ring,\r\n#ifdef __BIG_ENDIAN\r\n(2 << 2) |\r\n#endif\r\nDI_INDEX_SIZE_16_BIT);\r\nradeon_ring_write(ring, PACKET3(PACKET3_NUM_INSTANCES, 0));\r\nradeon_ring_write(ring, 1);\r\nradeon_ring_write(ring, PACKET3(PACKET3_DRAW_INDEX_AUTO, 1));\r\nradeon_ring_write(ring, 3);\r\nradeon_ring_write(ring, DI_SRC_SEL_AUTO_INDEX);\r\n}\r\nstatic void\r\nset_default_state(struct radeon_device *rdev)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nu32 sq_config, sq_gpr_resource_mgmt_1, sq_gpr_resource_mgmt_2;\r\nu32 sq_thread_resource_mgmt, sq_stack_resource_mgmt_1, sq_stack_resource_mgmt_2;\r\nint num_ps_gprs, num_vs_gprs, num_temp_gprs, num_gs_gprs, num_es_gprs;\r\nint num_ps_threads, num_vs_threads, num_gs_threads, num_es_threads;\r\nint num_ps_stack_entries, num_vs_stack_entries, num_gs_stack_entries, num_es_stack_entries;\r\nu64 gpu_addr;\r\nint dwords;\r\nswitch (rdev->family) {\r\ncase CHIP_R600:\r\nnum_ps_gprs = 192;\r\nnum_vs_gprs = 56;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 0;\r\nnum_es_gprs = 0;\r\nnum_ps_threads = 136;\r\nnum_vs_threads = 48;\r\nnum_gs_threads = 4;\r\nnum_es_threads = 4;\r\nnum_ps_stack_entries = 128;\r\nnum_vs_stack_entries = 128;\r\nnum_gs_stack_entries = 0;\r\nnum_es_stack_entries = 0;\r\nbreak;\r\ncase CHIP_RV630:\r\ncase CHIP_RV635:\r\nnum_ps_gprs = 84;\r\nnum_vs_gprs = 36;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 0;\r\nnum_es_gprs = 0;\r\nnum_ps_threads = 144;\r\nnum_vs_threads = 40;\r\nnum_gs_threads = 4;\r\nnum_es_threads = 4;\r\nnum_ps_stack_entries = 40;\r\nnum_vs_stack_entries = 40;\r\nnum_gs_stack_entries = 32;\r\nnum_es_stack_entries = 16;\r\nbreak;\r\ncase CHIP_RV610:\r\ncase CHIP_RV620:\r\ncase CHIP_RS780:\r\ncase CHIP_RS880:\r\ndefault:\r\nnum_ps_gprs = 84;\r\nnum_vs_gprs = 36;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 0;\r\nnum_es_gprs = 0;\r\nnum_ps_threads = 136;\r\nnum_vs_threads = 48;\r\nnum_gs_threads = 4;\r\nnum_es_threads = 4;\r\nnum_ps_stack_entries = 40;\r\nnum_vs_stack_entries = 40;\r\nnum_gs_stack_entries = 32;\r\nnum_es_stack_entries = 16;\r\nbreak;\r\ncase CHIP_RV670:\r\nnum_ps_gprs = 144;\r\nnum_vs_gprs = 40;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 0;\r\nnum_es_gprs = 0;\r\nnum_ps_threads = 136;\r\nnum_vs_threads = 48;\r\nnum_gs_threads = 4;\r\nnum_es_threads = 4;\r\nnum_ps_stack_entries = 40;\r\nnum_vs_stack_entries = 40;\r\nnum_gs_stack_entries = 32;\r\nnum_es_stack_entries = 16;\r\nbreak;\r\ncase CHIP_RV770:\r\nnum_ps_gprs = 192;\r\nnum_vs_gprs = 56;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 0;\r\nnum_es_gprs = 0;\r\nnum_ps_threads = 188;\r\nnum_vs_threads = 60;\r\nnum_gs_threads = 0;\r\nnum_es_threads = 0;\r\nnum_ps_stack_entries = 256;\r\nnum_vs_stack_entries = 256;\r\nnum_gs_stack_entries = 0;\r\nnum_es_stack_entries = 0;\r\nbreak;\r\ncase CHIP_RV730:\r\ncase CHIP_RV740:\r\nnum_ps_gprs = 84;\r\nnum_vs_gprs = 36;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 0;\r\nnum_es_gprs = 0;\r\nnum_ps_threads = 188;\r\nnum_vs_threads = 60;\r\nnum_gs_threads = 0;\r\nnum_es_threads = 0;\r\nnum_ps_stack_entries = 128;\r\nnum_vs_stack_entries = 128;\r\nnum_gs_stack_entries = 0;\r\nnum_es_stack_entries = 0;\r\nbreak;\r\ncase CHIP_RV710:\r\nnum_ps_gprs = 192;\r\nnum_vs_gprs = 56;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 0;\r\nnum_es_gprs = 0;\r\nnum_ps_threads = 144;\r\nnum_vs_threads = 48;\r\nnum_gs_threads = 0;\r\nnum_es_threads = 0;\r\nnum_ps_stack_entries = 128;\r\nnum_vs_stack_entries = 128;\r\nnum_gs_stack_entries = 0;\r\nnum_es_stack_entries = 0;\r\nbreak;\r\n}\r\nif ((rdev->family == CHIP_RV610) ||\r\n(rdev->family == CHIP_RV620) ||\r\n(rdev->family == CHIP_RS780) ||\r\n(rdev->family == CHIP_RS880) ||\r\n(rdev->family == CHIP_RV710))\r\nsq_config = 0;\r\nelse\r\nsq_config = VC_ENABLE;\r\nsq_config |= (DX9_CONSTS |\r\nALU_INST_PREFER_VECTOR |\r\nPS_PRIO(0) |\r\nVS_PRIO(1) |\r\nGS_PRIO(2) |\r\nES_PRIO(3));\r\nsq_gpr_resource_mgmt_1 = (NUM_PS_GPRS(num_ps_gprs) |\r\nNUM_VS_GPRS(num_vs_gprs) |\r\nNUM_CLAUSE_TEMP_GPRS(num_temp_gprs));\r\nsq_gpr_resource_mgmt_2 = (NUM_GS_GPRS(num_gs_gprs) |\r\nNUM_ES_GPRS(num_es_gprs));\r\nsq_thread_resource_mgmt = (NUM_PS_THREADS(num_ps_threads) |\r\nNUM_VS_THREADS(num_vs_threads) |\r\nNUM_GS_THREADS(num_gs_threads) |\r\nNUM_ES_THREADS(num_es_threads));\r\nsq_stack_resource_mgmt_1 = (NUM_PS_STACK_ENTRIES(num_ps_stack_entries) |\r\nNUM_VS_STACK_ENTRIES(num_vs_stack_entries));\r\nsq_stack_resource_mgmt_2 = (NUM_GS_STACK_ENTRIES(num_gs_stack_entries) |\r\nNUM_ES_STACK_ENTRIES(num_es_stack_entries));\r\ndwords = ALIGN(rdev->r600_blit.state_len, 0x10);\r\ngpu_addr = rdev->r600_blit.shader_gpu_addr + rdev->r600_blit.state_offset;\r\nradeon_ring_write(ring, PACKET3(PACKET3_INDIRECT_BUFFER, 2));\r\nradeon_ring_write(ring,\r\n#ifdef __BIG_ENDIAN\r\n(2 << 0) |\r\n#endif\r\n(gpu_addr & 0xFFFFFFFC));\r\nradeon_ring_write(ring, upper_32_bits(gpu_addr) & 0xFF);\r\nradeon_ring_write(ring, dwords);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONFIG_REG, 6));\r\nradeon_ring_write(ring, (SQ_CONFIG - PACKET3_SET_CONFIG_REG_OFFSET) >> 2);\r\nradeon_ring_write(ring, sq_config);\r\nradeon_ring_write(ring, sq_gpr_resource_mgmt_1);\r\nradeon_ring_write(ring, sq_gpr_resource_mgmt_2);\r\nradeon_ring_write(ring, sq_thread_resource_mgmt);\r\nradeon_ring_write(ring, sq_stack_resource_mgmt_1);\r\nradeon_ring_write(ring, sq_stack_resource_mgmt_2);\r\n}\r\nint r600_blit_init(struct radeon_device *rdev)\r\n{\r\nu32 obj_size;\r\nint i, r, dwords;\r\nvoid *ptr;\r\nu32 packet2s[16];\r\nint num_packet2s = 0;\r\nrdev->r600_blit.primitives.set_render_target = set_render_target;\r\nrdev->r600_blit.primitives.cp_set_surface_sync = cp_set_surface_sync;\r\nrdev->r600_blit.primitives.set_shaders = set_shaders;\r\nrdev->r600_blit.primitives.set_vtx_resource = set_vtx_resource;\r\nrdev->r600_blit.primitives.set_tex_resource = set_tex_resource;\r\nrdev->r600_blit.primitives.set_scissors = set_scissors;\r\nrdev->r600_blit.primitives.draw_auto = draw_auto;\r\nrdev->r600_blit.primitives.set_default_state = set_default_state;\r\nrdev->r600_blit.ring_size_common = 8;\r\nrdev->r600_blit.ring_size_common += 40;\r\nrdev->r600_blit.ring_size_common += 5;\r\nrdev->r600_blit.ring_size_common += 16;\r\nrdev->r600_blit.ring_size_per_loop = 76;\r\nif (rdev->family > CHIP_R600 && rdev->family < CHIP_RV770)\r\nrdev->r600_blit.ring_size_per_loop += 2;\r\nrdev->r600_blit.max_dim = 8192;\r\nrdev->r600_blit.state_offset = 0;\r\nif (rdev->family >= CHIP_RV770)\r\nrdev->r600_blit.state_len = r7xx_default_size;\r\nelse\r\nrdev->r600_blit.state_len = r6xx_default_size;\r\ndwords = rdev->r600_blit.state_len;\r\nwhile (dwords & 0xf) {\r\npacket2s[num_packet2s++] = cpu_to_le32(PACKET2(0));\r\ndwords++;\r\n}\r\nobj_size = dwords * 4;\r\nobj_size = ALIGN(obj_size, 256);\r\nrdev->r600_blit.vs_offset = obj_size;\r\nobj_size += r6xx_vs_size * 4;\r\nobj_size = ALIGN(obj_size, 256);\r\nrdev->r600_blit.ps_offset = obj_size;\r\nobj_size += r6xx_ps_size * 4;\r\nobj_size = ALIGN(obj_size, 256);\r\nif (rdev->r600_blit.shader_obj == NULL) {\r\nr = radeon_bo_create(rdev, obj_size, PAGE_SIZE, true,\r\nRADEON_GEM_DOMAIN_VRAM,\r\nNULL, &rdev->r600_blit.shader_obj);\r\nif (r) {\r\nDRM_ERROR("r600 failed to allocate shader\n");\r\nreturn r;\r\n}\r\nr = radeon_bo_reserve(rdev->r600_blit.shader_obj, false);\r\nif (unlikely(r != 0))\r\nreturn r;\r\nr = radeon_bo_pin(rdev->r600_blit.shader_obj, RADEON_GEM_DOMAIN_VRAM,\r\n&rdev->r600_blit.shader_gpu_addr);\r\nradeon_bo_unreserve(rdev->r600_blit.shader_obj);\r\nif (r) {\r\ndev_err(rdev->dev, "(%d) pin blit object failed\n", r);\r\nreturn r;\r\n}\r\n}\r\nDRM_DEBUG("r6xx blit allocated bo %08x vs %08x ps %08x\n",\r\nobj_size,\r\nrdev->r600_blit.vs_offset, rdev->r600_blit.ps_offset);\r\nr = radeon_bo_reserve(rdev->r600_blit.shader_obj, false);\r\nif (unlikely(r != 0))\r\nreturn r;\r\nr = radeon_bo_kmap(rdev->r600_blit.shader_obj, &ptr);\r\nif (r) {\r\nDRM_ERROR("failed to map blit object %d\n", r);\r\nreturn r;\r\n}\r\nif (rdev->family >= CHIP_RV770)\r\nmemcpy_toio(ptr + rdev->r600_blit.state_offset,\r\nr7xx_default_state, rdev->r600_blit.state_len * 4);\r\nelse\r\nmemcpy_toio(ptr + rdev->r600_blit.state_offset,\r\nr6xx_default_state, rdev->r600_blit.state_len * 4);\r\nif (num_packet2s)\r\nmemcpy_toio(ptr + rdev->r600_blit.state_offset + (rdev->r600_blit.state_len * 4),\r\npacket2s, num_packet2s * 4);\r\nfor (i = 0; i < r6xx_vs_size; i++)\r\n*(u32 *)((unsigned long)ptr + rdev->r600_blit.vs_offset + i * 4) = cpu_to_le32(r6xx_vs[i]);\r\nfor (i = 0; i < r6xx_ps_size; i++)\r\n*(u32 *)((unsigned long)ptr + rdev->r600_blit.ps_offset + i * 4) = cpu_to_le32(r6xx_ps[i]);\r\nradeon_bo_kunmap(rdev->r600_blit.shader_obj);\r\nradeon_bo_unreserve(rdev->r600_blit.shader_obj);\r\nradeon_ttm_set_active_vram_size(rdev, rdev->mc.real_vram_size);\r\nreturn 0;\r\n}\r\nvoid r600_blit_fini(struct radeon_device *rdev)\r\n{\r\nint r;\r\nradeon_ttm_set_active_vram_size(rdev, rdev->mc.visible_vram_size);\r\nif (rdev->r600_blit.shader_obj == NULL)\r\nreturn;\r\nr = radeon_bo_reserve(rdev->r600_blit.shader_obj, false);\r\nif (!r) {\r\nradeon_bo_unpin(rdev->r600_blit.shader_obj);\r\nradeon_bo_unreserve(rdev->r600_blit.shader_obj);\r\n}\r\nradeon_bo_unref(&rdev->r600_blit.shader_obj);\r\n}\r\nstatic unsigned r600_blit_create_rect(unsigned num_gpu_pages,\r\nint *width, int *height, int max_dim)\r\n{\r\nunsigned max_pages;\r\nunsigned pages = num_gpu_pages;\r\nint w, h;\r\nif (num_gpu_pages == 0) {\r\nh = 0;\r\nw = 0;\r\npages = 0;\r\nWARN_ON(1);\r\n} else {\r\nint rect_order = 2;\r\nh = RECT_UNIT_H;\r\nwhile (num_gpu_pages / rect_order) {\r\nh *= 2;\r\nrect_order *= 4;\r\nif (h >= max_dim) {\r\nh = max_dim;\r\nbreak;\r\n}\r\n}\r\nmax_pages = (max_dim * h) / (RECT_UNIT_W * RECT_UNIT_H);\r\nif (pages > max_pages)\r\npages = max_pages;\r\nw = (pages * RECT_UNIT_W * RECT_UNIT_H) / h;\r\nw = (w / RECT_UNIT_W) * RECT_UNIT_W;\r\npages = (w * h) / (RECT_UNIT_W * RECT_UNIT_H);\r\nBUG_ON(pages == 0);\r\n}\r\nDRM_DEBUG("blit_rectangle: h=%d, w=%d, pages=%d\n", h, w, pages);\r\nif (height)\r\n*height = h;\r\nif (width)\r\n*width = w;\r\nreturn pages;\r\n}\r\nint r600_blit_prepare_copy(struct radeon_device *rdev, unsigned num_gpu_pages,\r\nstruct radeon_fence **fence, struct radeon_sa_bo **vb,\r\nstruct radeon_semaphore **sem)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nint r;\r\nint ring_size;\r\nint num_loops = 0;\r\nint dwords_per_loop = rdev->r600_blit.ring_size_per_loop;\r\nwhile (num_gpu_pages) {\r\nnum_gpu_pages -=\r\nr600_blit_create_rect(num_gpu_pages, NULL, NULL,\r\nrdev->r600_blit.max_dim);\r\nnum_loops++;\r\n}\r\nr = radeon_sa_bo_new(rdev, &rdev->ring_tmp_bo, vb,\r\n(num_loops*48)+256, 256, true);\r\nif (r) {\r\nreturn r;\r\n}\r\nr = radeon_semaphore_create(rdev, sem);\r\nif (r) {\r\nradeon_sa_bo_free(rdev, vb, NULL);\r\nreturn r;\r\n}\r\nring_size = num_loops * dwords_per_loop;\r\nring_size += rdev->r600_blit.ring_size_common;\r\nr = radeon_ring_lock(rdev, ring, ring_size);\r\nif (r) {\r\nradeon_sa_bo_free(rdev, vb, NULL);\r\nradeon_semaphore_free(rdev, sem, NULL);\r\nreturn r;\r\n}\r\nif (radeon_fence_need_sync(*fence, RADEON_RING_TYPE_GFX_INDEX)) {\r\nradeon_semaphore_sync_rings(rdev, *sem, (*fence)->ring,\r\nRADEON_RING_TYPE_GFX_INDEX);\r\nradeon_fence_note_sync(*fence, RADEON_RING_TYPE_GFX_INDEX);\r\n} else {\r\nradeon_semaphore_free(rdev, sem, NULL);\r\n}\r\nrdev->r600_blit.primitives.set_default_state(rdev);\r\nrdev->r600_blit.primitives.set_shaders(rdev);\r\nreturn 0;\r\n}\r\nvoid r600_blit_done_copy(struct radeon_device *rdev, struct radeon_fence **fence,\r\nstruct radeon_sa_bo *vb, struct radeon_semaphore *sem)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nint r;\r\nr = radeon_fence_emit(rdev, fence, RADEON_RING_TYPE_GFX_INDEX);\r\nif (r) {\r\nradeon_ring_unlock_undo(rdev, ring);\r\nreturn;\r\n}\r\nradeon_ring_unlock_commit(rdev, ring);\r\nradeon_sa_bo_free(rdev, &vb, *fence);\r\nradeon_semaphore_free(rdev, &sem, *fence);\r\n}\r\nvoid r600_kms_blit_copy(struct radeon_device *rdev,\r\nu64 src_gpu_addr, u64 dst_gpu_addr,\r\nunsigned num_gpu_pages,\r\nstruct radeon_sa_bo *vb)\r\n{\r\nu64 vb_gpu_addr;\r\nu32 *vb_cpu_addr;\r\nDRM_DEBUG("emitting copy %16llx %16llx %d\n",\r\nsrc_gpu_addr, dst_gpu_addr, num_gpu_pages);\r\nvb_cpu_addr = (u32 *)radeon_sa_bo_cpu_addr(vb);\r\nvb_gpu_addr = radeon_sa_bo_gpu_addr(vb);\r\nwhile (num_gpu_pages) {\r\nint w, h;\r\nunsigned size_in_bytes;\r\nunsigned pages_per_loop =\r\nr600_blit_create_rect(num_gpu_pages, &w, &h,\r\nrdev->r600_blit.max_dim);\r\nsize_in_bytes = pages_per_loop * RADEON_GPU_PAGE_SIZE;\r\nDRM_DEBUG("rectangle w=%d h=%d\n", w, h);\r\nvb_cpu_addr[0] = 0;\r\nvb_cpu_addr[1] = 0;\r\nvb_cpu_addr[2] = 0;\r\nvb_cpu_addr[3] = 0;\r\nvb_cpu_addr[4] = 0;\r\nvb_cpu_addr[5] = int2float(h);\r\nvb_cpu_addr[6] = 0;\r\nvb_cpu_addr[7] = int2float(h);\r\nvb_cpu_addr[8] = int2float(w);\r\nvb_cpu_addr[9] = int2float(h);\r\nvb_cpu_addr[10] = int2float(w);\r\nvb_cpu_addr[11] = int2float(h);\r\nrdev->r600_blit.primitives.set_tex_resource(rdev, FMT_8_8_8_8,\r\nw, h, w, src_gpu_addr, size_in_bytes);\r\nrdev->r600_blit.primitives.set_render_target(rdev, COLOR_8_8_8_8,\r\nw, h, dst_gpu_addr);\r\nrdev->r600_blit.primitives.set_scissors(rdev, 0, 0, w, h);\r\nrdev->r600_blit.primitives.set_vtx_resource(rdev, vb_gpu_addr);\r\nrdev->r600_blit.primitives.draw_auto(rdev);\r\nrdev->r600_blit.primitives.cp_set_surface_sync(rdev,\r\nPACKET3_CB_ACTION_ENA | PACKET3_CB0_DEST_BASE_ENA,\r\nsize_in_bytes, dst_gpu_addr);\r\nvb_cpu_addr += 12;\r\nvb_gpu_addr += 4*12;\r\nsrc_gpu_addr += size_in_bytes;\r\ndst_gpu_addr += size_in_bytes;\r\nnum_gpu_pages -= pages_per_loop;\r\n}\r\n}

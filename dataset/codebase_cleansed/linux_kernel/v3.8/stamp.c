void sl811_port_power(struct device *dev, int is_on)\r\n{\r\ngpio_request(CONFIG_USB_SL811_BFIN_GPIO_VBUS, "usb:SL811_VBUS");\r\ngpio_direction_output(CONFIG_USB_SL811_BFIN_GPIO_VBUS, is_on);\r\n}\r\nstatic void bfin_plat_nand_cmd_ctrl(struct mtd_info *mtd, int cmd, unsigned int ctrl)\r\n{\r\nstruct nand_chip *this = mtd->priv;\r\nif (cmd == NAND_CMD_NONE)\r\nreturn;\r\nif (ctrl & NAND_CLE)\r\nwriteb(cmd, this->IO_ADDR_W + (1 << BFIN_NAND_PLAT_CLE));\r\nelse\r\nwriteb(cmd, this->IO_ADDR_W + (1 << BFIN_NAND_PLAT_ALE));\r\n}\r\nstatic int bfin_plat_nand_dev_ready(struct mtd_info *mtd)\r\n{\r\nreturn gpio_get_value(BFIN_NAND_PLAT_READY);\r\n}\r\nstatic void bfin_plat_nand_init(void)\r\n{\r\ngpio_request(BFIN_NAND_PLAT_READY, "bfin_nand_plat");\r\n}\r\nstatic void bfin_plat_nand_init(void) {}\r\nstatic int bfin_mmc_spi_init(struct device *dev,\r\nirqreturn_t (*detect_int)(int, void *), void *data)\r\n{\r\nreturn request_irq(MMC_SPI_CARD_DETECT_INT, detect_int,\r\nIRQF_TRIGGER_FALLING, "mmc-spi-detect", data);\r\n}\r\nstatic void bfin_mmc_spi_exit(struct device *dev, void *data)\r\n{\r\nfree_irq(MMC_SPI_CARD_DETECT_INT, data);\r\n}\r\nstatic inline void adf702x_mac_init(void)\r\n{\r\neth_random_addr(adf7021_platform_data.mac_addr);\r\n}\r\nstatic inline void adf702x_mac_init(void) {}\r\nstatic int ads7873_get_pendown_state(void)\r\n{\r\nreturn gpio_get_value(GPIO_PF6);\r\n}\r\nstatic int __init net2272_init(void)\r\n{\r\n#if defined(CONFIG_USB_NET2272) || defined(CONFIG_USB_NET2272_MODULE)\r\nint ret;\r\nret = gpio_request(GPIO_PF6, "net2272");\r\nif (ret)\r\nreturn ret;\r\ngpio_direction_output(GPIO_PF6, 0);\r\nmdelay(2);\r\ngpio_set_value(GPIO_PF6, 1);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int __init stamp_init(void)\r\n{\r\nprintk(KERN_INFO "%s(): registering device resources\n", __func__);\r\nbfin_plat_nand_init();\r\nadf702x_mac_init();\r\nplatform_add_devices(stamp_devices, ARRAY_SIZE(stamp_devices));\r\ni2c_register_board_info(0, bfin_i2c_board_info,\r\nARRAY_SIZE(bfin_i2c_board_info));\r\nspi_register_board_info(bfin_spi_board_info, ARRAY_SIZE(bfin_spi_board_info));\r\nif (net2272_init())\r\npr_warning("unable to configure net2272; it probably won't work\n");\r\nreturn 0;\r\n}\r\nvoid __init native_machine_early_platform_add_devices(void)\r\n{\r\nprintk(KERN_INFO "register early platform devices\n");\r\nearly_platform_add_devices(stamp_early_devices,\r\nARRAY_SIZE(stamp_early_devices));\r\n}\r\nvoid native_machine_restart(char *cmd)\r\n{\r\nif ((bfin_read_SYSCR() & 0x7) == 0x3)\r\nbfin_reset_boot_spi_cs(P_DEFAULT_BOOT_SPI_CS);\r\n}\r\nint bfin_get_ether_addr(char *addr)\r\n{\r\n*(u32 *)(&(addr[0])) = bfin_read32(FLASH_MAC);\r\n*(u16 *)(&(addr[4])) = bfin_read16(FLASH_MAC + 4);\r\nreturn 0;\r\n}

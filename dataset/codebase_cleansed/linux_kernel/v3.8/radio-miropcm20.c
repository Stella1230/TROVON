static int pcm20_mute(struct pcm20 *dev, unsigned char mute)\r\n{\r\ndev->muted = mute;\r\nreturn snd_aci_cmd(dev->aci, ACI_SET_TUNERMUTE, mute, -1);\r\n}\r\nstatic int pcm20_stereo(struct pcm20 *dev, unsigned char stereo)\r\n{\r\nreturn snd_aci_cmd(dev->aci, ACI_SET_TUNERMONO, !stereo, -1);\r\n}\r\nstatic int pcm20_setfreq(struct pcm20 *dev, unsigned long freq)\r\n{\r\nunsigned char freql;\r\nunsigned char freqh;\r\nstruct snd_miro_aci *aci = dev->aci;\r\ndev->freq = freq;\r\nfreq /= 160;\r\nif (!(aci->aci_version == 0x07 || aci->aci_version >= 0xb0))\r\nfreq /= 10;\r\nfreql = freq & 0xff;\r\nfreqh = freq >> 8;\r\npcm20_stereo(dev, !mono);\r\nreturn snd_aci_cmd(aci, ACI_WRITE_TUNE, freql, freqh);\r\n}\r\nstatic int vidioc_querycap(struct file *file, void *priv,\r\nstruct v4l2_capability *v)\r\n{\r\nstrlcpy(v->driver, "Miro PCM20", sizeof(v->driver));\r\nstrlcpy(v->card, "Miro PCM20", sizeof(v->card));\r\nstrlcpy(v->bus_info, "ISA", sizeof(v->bus_info));\r\nv->version = 0x1;\r\nv->capabilities = V4L2_CAP_TUNER | V4L2_CAP_RADIO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nif (v->index)\r\nreturn -EINVAL;\r\nstrlcpy(v->name, "FM", sizeof(v->name));\r\nv->type = V4L2_TUNER_RADIO;\r\nv->rangelow = 87*16000;\r\nv->rangehigh = 108*16000;\r\nv->signal = 0xffff;\r\nv->rxsubchans = V4L2_TUNER_SUB_MONO | V4L2_TUNER_SUB_STEREO;\r\nv->capability = V4L2_TUNER_CAP_LOW;\r\nv->audmode = V4L2_TUNER_MODE_MONO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nreturn v->index ? -EINVAL : 0;\r\n}\r\nstatic int vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct pcm20 *dev = video_drvdata(file);\r\nif (f->tuner != 0)\r\nreturn -EINVAL;\r\nf->type = V4L2_TUNER_RADIO;\r\nf->frequency = dev->freq;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct pcm20 *dev = video_drvdata(file);\r\nif (f->tuner != 0 || f->type != V4L2_TUNER_RADIO)\r\nreturn -EINVAL;\r\ndev->freq = f->frequency;\r\npcm20_setfreq(dev, f->frequency);\r\nreturn 0;\r\n}\r\nstatic int vidioc_queryctrl(struct file *file, void *priv,\r\nstruct v4l2_queryctrl *qc)\r\n{\r\nswitch (qc->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nreturn v4l2_ctrl_query_fill(qc, 0, 1, 1, 1);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_g_ctrl(struct file *file, void *priv,\r\nstruct v4l2_control *ctrl)\r\n{\r\nstruct pcm20 *dev = video_drvdata(file);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nctrl->value = dev->muted;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_ctrl(struct file *file, void *priv,\r\nstruct v4l2_control *ctrl)\r\n{\r\nstruct pcm20 *dev = video_drvdata(file);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\npcm20_mute(dev, ctrl->value);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_input(struct file *filp, void *priv, unsigned int *i)\r\n{\r\n*i = 0;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_input(struct file *filp, void *priv, unsigned int i)\r\n{\r\nreturn i ? -EINVAL : 0;\r\n}\r\nstatic int vidioc_g_audio(struct file *file, void *priv,\r\nstruct v4l2_audio *a)\r\n{\r\na->index = 0;\r\nstrlcpy(a->name, "Radio", sizeof(a->name));\r\na->capability = V4L2_AUDCAP_STEREO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_audio(struct file *file, void *priv,\r\nconst struct v4l2_audio *a)\r\n{\r\nreturn a->index ? -EINVAL : 0;\r\n}\r\nstatic int __init pcm20_init(void)\r\n{\r\nstruct pcm20 *dev = &pcm20_card;\r\nstruct v4l2_device *v4l2_dev = &dev->v4l2_dev;\r\nint res;\r\ndev->aci = snd_aci_get_aci();\r\nif (dev->aci == NULL) {\r\nv4l2_err(v4l2_dev,\r\n"you must load the snd-miro driver first!\n");\r\nreturn -ENODEV;\r\n}\r\nstrlcpy(v4l2_dev->name, "miropcm20", sizeof(v4l2_dev->name));\r\nmutex_init(&dev->lock);\r\nres = v4l2_device_register(NULL, v4l2_dev);\r\nif (res < 0) {\r\nv4l2_err(v4l2_dev, "could not register v4l2_device\n");\r\nreturn -EINVAL;\r\n}\r\nstrlcpy(dev->vdev.name, v4l2_dev->name, sizeof(dev->vdev.name));\r\ndev->vdev.v4l2_dev = v4l2_dev;\r\ndev->vdev.fops = &pcm20_fops;\r\ndev->vdev.ioctl_ops = &pcm20_ioctl_ops;\r\ndev->vdev.release = video_device_release_empty;\r\ndev->vdev.lock = &dev->lock;\r\nvideo_set_drvdata(&dev->vdev, dev);\r\nif (video_register_device(&dev->vdev, VFL_TYPE_RADIO, radio_nr) < 0)\r\ngoto fail;\r\nv4l2_info(v4l2_dev, "Mirosound PCM20 Radio tuner\n");\r\nreturn 0;\r\nfail:\r\nv4l2_device_unregister(v4l2_dev);\r\nreturn -EINVAL;\r\n}\r\nstatic void __exit pcm20_cleanup(void)\r\n{\r\nstruct pcm20 *dev = &pcm20_card;\r\nvideo_unregister_device(&dev->vdev);\r\nv4l2_device_unregister(&dev->v4l2_dev);\r\n}

static int __init pdc_chassis_setup(char *str)\r\n{\r\nget_option(&str, &pdc_chassis_enabled);\r\nreturn 1;\r\n}\r\nstatic int pdc_chassis_panic_event(struct notifier_block *this,\r\nunsigned long event, void *ptr)\r\n{\r\npdc_chassis_send_status(PDC_CHASSIS_DIRECT_PANIC);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int pdc_chassis_reboot_event(struct notifier_block *this,\r\nunsigned long event, void *ptr)\r\n{\r\npdc_chassis_send_status(PDC_CHASSIS_DIRECT_SHUTDOWN);\r\nreturn NOTIFY_DONE;\r\n}\r\nvoid __init parisc_pdc_chassis_init(void)\r\n{\r\n#ifdef CONFIG_PDC_CHASSIS\r\nif (likely(pdc_chassis_enabled)) {\r\nDPRINTK(KERN_DEBUG "%s: parisc_pdc_chassis_init()\n", __FILE__);\r\nprintk(KERN_INFO "Enabling %s chassis codes support v%s\n",\r\nis_pdc_pat() ? "PDC_PAT" : "regular",\r\nPDC_CHASSIS_VER);\r\natomic_notifier_chain_register(&panic_notifier_list,\r\n&pdc_chassis_panic_block);\r\nregister_reboot_notifier(&pdc_chassis_reboot_block);\r\n}\r\n#endif\r\n}\r\nint pdc_chassis_send_status(int message)\r\n{\r\nint retval = 0;\r\n#ifdef CONFIG_PDC_CHASSIS\r\nif (likely(pdc_chassis_enabled)) {\r\nDPRINTK(KERN_DEBUG "%s: pdc_chassis_send_status(%d)\n", __FILE__, message);\r\n#ifdef CONFIG_64BIT\r\nif (is_pdc_pat()) {\r\nswitch(message) {\r\ncase PDC_CHASSIS_DIRECT_BSTART:\r\nretval = pdc_pat_chassis_send_log(PDC_CHASSIS_PMSG_BSTART, PDC_CHASSIS_LSTATE_RUN_NORMAL);\r\nbreak;\r\ncase PDC_CHASSIS_DIRECT_BCOMPLETE:\r\nretval = pdc_pat_chassis_send_log(PDC_CHASSIS_PMSG_BCOMPLETE, PDC_CHASSIS_LSTATE_RUN_NORMAL);\r\nbreak;\r\ncase PDC_CHASSIS_DIRECT_SHUTDOWN:\r\nretval = pdc_pat_chassis_send_log(PDC_CHASSIS_PMSG_SHUTDOWN, PDC_CHASSIS_LSTATE_NONOS);\r\nbreak;\r\ncase PDC_CHASSIS_DIRECT_PANIC:\r\nretval = pdc_pat_chassis_send_log(PDC_CHASSIS_PMSG_PANIC, PDC_CHASSIS_LSTATE_RUN_CRASHREC);\r\nbreak;\r\ncase PDC_CHASSIS_DIRECT_LPMC:\r\nretval = pdc_pat_chassis_send_log(PDC_CHASSIS_PMSG_LPMC, PDC_CHASSIS_LSTATE_RUN_SYSINT);\r\nbreak;\r\ncase PDC_CHASSIS_DIRECT_HPMC:\r\nretval = pdc_pat_chassis_send_log(PDC_CHASSIS_PMSG_HPMC, PDC_CHASSIS_LSTATE_RUN_NCRIT);\r\nbreak;\r\ndefault:\r\nretval = -1;\r\n}\r\n} else retval = -1;\r\n#else\r\nif (1) {\r\nswitch (message) {\r\ncase PDC_CHASSIS_DIRECT_BSTART:\r\nretval = pdc_chassis_disp(PDC_CHASSIS_DISP_DATA(OSTAT_INIT));\r\nbreak;\r\ncase PDC_CHASSIS_DIRECT_BCOMPLETE:\r\nretval = pdc_chassis_disp(PDC_CHASSIS_DISP_DATA(OSTAT_RUN));\r\nbreak;\r\ncase PDC_CHASSIS_DIRECT_SHUTDOWN:\r\nretval = pdc_chassis_disp(PDC_CHASSIS_DISP_DATA(OSTAT_SHUT));\r\nbreak;\r\ncase PDC_CHASSIS_DIRECT_HPMC:\r\ncase PDC_CHASSIS_DIRECT_PANIC:\r\nretval = pdc_chassis_disp(PDC_CHASSIS_DISP_DATA(OSTAT_FLT));\r\nbreak;\r\ncase PDC_CHASSIS_DIRECT_LPMC:\r\nretval = pdc_chassis_disp(PDC_CHASSIS_DISP_DATA(OSTAT_WARN));\r\nbreak;\r\ndefault:\r\nretval = -1;\r\n}\r\n} else retval = -1;\r\n#endif\r\n}\r\n#endif\r\nreturn retval;\r\n}\r\nstatic int pdc_chassis_warn_pread(char *page, char **start, off_t off,\r\nint count, int *eof, void *data)\r\n{\r\nchar *out = page;\r\nint len, ret;\r\nunsigned long warn;\r\nu32 warnreg;\r\nret = pdc_chassis_warn(&warn);\r\nif (ret != PDC_OK)\r\nreturn -EIO;\r\nwarnreg = (warn & 0xFFFFFFFF);\r\nif ((warnreg >> 24) & 0xFF)\r\nout += sprintf(out, "Chassis component failure! (eg fan or PSU): 0x%.2x\n", ((warnreg >> 24) & 0xFF));\r\nout += sprintf(out, "Battery: %s\n", (warnreg & 0x04) ? "Low!" : "OK");\r\nout += sprintf(out, "Temp low: %s\n", (warnreg & 0x02) ? "Exceeded!" : "OK");\r\nout += sprintf(out, "Temp mid: %s\n", (warnreg & 0x01) ? "Exceeded!" : "OK");\r\nlen = out - page - off;\r\nif (len < count) {\r\n*eof = 1;\r\nif (len <= 0) return 0;\r\n} else {\r\nlen = count;\r\n}\r\n*start = page + off;\r\nreturn len;\r\n}\r\nstatic int __init pdc_chassis_create_procfs(void)\r\n{\r\nunsigned long test;\r\nint ret;\r\nret = pdc_chassis_warn(&test);\r\nif ((ret == PDC_BAD_PROC) || (ret == PDC_BAD_OPTION)) {\r\nprintk(KERN_INFO "Chassis warnings not supported.\n");\r\nreturn 0;\r\n}\r\nprintk(KERN_INFO "Enabling PDC chassis warnings support v%s\n",\r\nPDC_CHASSIS_VER);\r\ncreate_proc_read_entry("chassis", 0400, NULL, pdc_chassis_warn_pread,\r\nNULL);\r\nreturn 0;\r\n}

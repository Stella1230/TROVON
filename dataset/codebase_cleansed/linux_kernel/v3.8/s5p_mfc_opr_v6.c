int s5p_mfc_alloc_dec_temp_buffers_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nreturn 0;\r\n}\r\nvoid s5p_mfc_release_dec_desc_buffer_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\n}\r\nint s5p_mfc_get_dec_status_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn -1;\r\n}\r\nint s5p_mfc_alloc_codec_buffers_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nunsigned int mb_width, mb_height;\r\nmb_width = MB_WIDTH(ctx->img_width);\r\nmb_height = MB_HEIGHT(ctx->img_height);\r\nif (ctx->type == MFCINST_DECODER) {\r\nmfc_debug(2, "Luma size:%d Chroma size:%d MV size:%d\n",\r\nctx->luma_size, ctx->chroma_size, ctx->mv_size);\r\nmfc_debug(2, "Totals bufs: %d\n", ctx->total_dpb_count);\r\n} else if (ctx->type == MFCINST_ENCODER) {\r\nctx->tmv_buffer_size = S5P_FIMV_NUM_TMV_BUFFERS_V6 *\r\nALIGN(S5P_FIMV_TMV_BUFFER_SIZE_V6(mb_width, mb_height),\r\nS5P_FIMV_TMV_BUFFER_ALIGN_V6);\r\nctx->luma_dpb_size = ALIGN((mb_width * mb_height) *\r\nS5P_FIMV_LUMA_MB_TO_PIXEL_V6,\r\nS5P_FIMV_LUMA_DPB_BUFFER_ALIGN_V6);\r\nctx->chroma_dpb_size = ALIGN((mb_width * mb_height) *\r\nS5P_FIMV_CHROMA_MB_TO_PIXEL_V6,\r\nS5P_FIMV_CHROMA_DPB_BUFFER_ALIGN_V6);\r\nctx->me_buffer_size = ALIGN(S5P_FIMV_ME_BUFFER_SIZE_V6(\r\nctx->img_width, ctx->img_height,\r\nmb_width, mb_height),\r\nS5P_FIMV_ME_BUFFER_ALIGN_V6);\r\nmfc_debug(2, "recon luma size: %d chroma size: %d\n",\r\nctx->luma_dpb_size, ctx->chroma_dpb_size);\r\n} else {\r\nreturn -EINVAL;\r\n}\r\nswitch (ctx->codec_mode) {\r\ncase S5P_MFC_CODEC_H264_DEC:\r\ncase S5P_MFC_CODEC_H264_MVC_DEC:\r\nctx->scratch_buf_size =\r\nS5P_FIMV_SCRATCH_BUF_SIZE_H264_DEC_V6(\r\nmb_width,\r\nmb_height);\r\nctx->scratch_buf_size = ALIGN(ctx->scratch_buf_size,\r\nS5P_FIMV_SCRATCH_BUFFER_ALIGN_V6);\r\nctx->bank1_size =\r\nctx->scratch_buf_size +\r\n(ctx->mv_count * ctx->mv_size);\r\nbreak;\r\ncase S5P_MFC_CODEC_MPEG4_DEC:\r\nctx->scratch_buf_size =\r\nS5P_FIMV_SCRATCH_BUF_SIZE_MPEG4_DEC_V6(\r\nmb_width,\r\nmb_height);\r\nctx->scratch_buf_size = ALIGN(ctx->scratch_buf_size,\r\nS5P_FIMV_SCRATCH_BUFFER_ALIGN_V6);\r\nctx->bank1_size = ctx->scratch_buf_size;\r\nbreak;\r\ncase S5P_MFC_CODEC_VC1RCV_DEC:\r\ncase S5P_MFC_CODEC_VC1_DEC:\r\nctx->scratch_buf_size =\r\nS5P_FIMV_SCRATCH_BUF_SIZE_VC1_DEC_V6(\r\nmb_width,\r\nmb_height);\r\nctx->scratch_buf_size = ALIGN(ctx->scratch_buf_size,\r\nS5P_FIMV_SCRATCH_BUFFER_ALIGN_V6);\r\nctx->bank1_size = ctx->scratch_buf_size;\r\nbreak;\r\ncase S5P_MFC_CODEC_MPEG2_DEC:\r\nctx->bank1_size = 0;\r\nctx->bank2_size = 0;\r\nbreak;\r\ncase S5P_MFC_CODEC_H263_DEC:\r\nctx->scratch_buf_size =\r\nS5P_FIMV_SCRATCH_BUF_SIZE_H263_DEC_V6(\r\nmb_width,\r\nmb_height);\r\nctx->scratch_buf_size = ALIGN(ctx->scratch_buf_size,\r\nS5P_FIMV_SCRATCH_BUFFER_ALIGN_V6);\r\nctx->bank1_size = ctx->scratch_buf_size;\r\nbreak;\r\ncase S5P_MFC_CODEC_VP8_DEC:\r\nctx->scratch_buf_size =\r\nS5P_FIMV_SCRATCH_BUF_SIZE_VP8_DEC_V6(\r\nmb_width,\r\nmb_height);\r\nctx->scratch_buf_size = ALIGN(ctx->scratch_buf_size,\r\nS5P_FIMV_SCRATCH_BUFFER_ALIGN_V6);\r\nctx->bank1_size = ctx->scratch_buf_size;\r\nbreak;\r\ncase S5P_MFC_CODEC_H264_ENC:\r\nctx->scratch_buf_size =\r\nS5P_FIMV_SCRATCH_BUF_SIZE_H264_ENC_V6(\r\nmb_width,\r\nmb_height);\r\nctx->scratch_buf_size = ALIGN(ctx->scratch_buf_size,\r\nS5P_FIMV_SCRATCH_BUFFER_ALIGN_V6);\r\nctx->bank1_size =\r\nctx->scratch_buf_size + ctx->tmv_buffer_size +\r\n(ctx->dpb_count * (ctx->luma_dpb_size +\r\nctx->chroma_dpb_size + ctx->me_buffer_size));\r\nctx->bank2_size = 0;\r\nbreak;\r\ncase S5P_MFC_CODEC_MPEG4_ENC:\r\ncase S5P_MFC_CODEC_H263_ENC:\r\nctx->scratch_buf_size =\r\nS5P_FIMV_SCRATCH_BUF_SIZE_MPEG4_ENC_V6(\r\nmb_width,\r\nmb_height);\r\nctx->scratch_buf_size = ALIGN(ctx->scratch_buf_size,\r\nS5P_FIMV_SCRATCH_BUFFER_ALIGN_V6);\r\nctx->bank1_size =\r\nctx->scratch_buf_size + ctx->tmv_buffer_size +\r\n(ctx->dpb_count * (ctx->luma_dpb_size +\r\nctx->chroma_dpb_size + ctx->me_buffer_size));\r\nctx->bank2_size = 0;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (ctx->bank1_size > 0) {\r\nctx->bank1_buf = vb2_dma_contig_memops.alloc(\r\ndev->alloc_ctx[MFC_BANK1_ALLOC_CTX], ctx->bank1_size);\r\nif (IS_ERR(ctx->bank1_buf)) {\r\nctx->bank1_buf = 0;\r\npr_err("Buf alloc for decoding failed (port A)\n");\r\nreturn -ENOMEM;\r\n}\r\nctx->bank1_phys = s5p_mfc_mem_cookie(\r\ndev->alloc_ctx[MFC_BANK1_ALLOC_CTX], ctx->bank1_buf);\r\nBUG_ON(ctx->bank1_phys & ((1 << MFC_BANK1_ALIGN_ORDER) - 1));\r\n}\r\nreturn 0;\r\n}\r\nvoid s5p_mfc_release_codec_buffers_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nif (ctx->bank1_buf) {\r\nvb2_dma_contig_memops.put(ctx->bank1_buf);\r\nctx->bank1_buf = 0;\r\nctx->bank1_phys = 0;\r\nctx->bank1_size = 0;\r\n}\r\n}\r\nint s5p_mfc_alloc_instance_buffer_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nstruct s5p_mfc_buf_size_v6 *buf_size = dev->variant->buf_size->priv;\r\nmfc_debug_enter();\r\nswitch (ctx->codec_mode) {\r\ncase S5P_MFC_CODEC_H264_DEC:\r\ncase S5P_MFC_CODEC_H264_MVC_DEC:\r\nctx->ctx.size = buf_size->h264_dec_ctx;\r\nbreak;\r\ncase S5P_MFC_CODEC_MPEG4_DEC:\r\ncase S5P_MFC_CODEC_H263_DEC:\r\ncase S5P_MFC_CODEC_VC1RCV_DEC:\r\ncase S5P_MFC_CODEC_VC1_DEC:\r\ncase S5P_MFC_CODEC_MPEG2_DEC:\r\ncase S5P_MFC_CODEC_VP8_DEC:\r\nctx->ctx.size = buf_size->other_dec_ctx;\r\nbreak;\r\ncase S5P_MFC_CODEC_H264_ENC:\r\nctx->ctx.size = buf_size->h264_enc_ctx;\r\nbreak;\r\ncase S5P_MFC_CODEC_MPEG4_ENC:\r\ncase S5P_MFC_CODEC_H263_ENC:\r\nctx->ctx.size = buf_size->other_enc_ctx;\r\nbreak;\r\ndefault:\r\nctx->ctx.size = 0;\r\nmfc_err("Codec type(%d) should be checked!\n", ctx->codec_mode);\r\nbreak;\r\n}\r\nctx->ctx.alloc = vb2_dma_contig_memops.alloc(\r\ndev->alloc_ctx[MFC_BANK1_ALLOC_CTX], ctx->ctx.size);\r\nif (IS_ERR(ctx->ctx.alloc)) {\r\nmfc_err("Allocating context buffer failed.\n");\r\nreturn PTR_ERR(ctx->ctx.alloc);\r\n}\r\nctx->ctx.dma = s5p_mfc_mem_cookie(\r\ndev->alloc_ctx[MFC_BANK1_ALLOC_CTX], ctx->ctx.alloc);\r\nctx->ctx.virt = vb2_dma_contig_memops.vaddr(ctx->ctx.alloc);\r\nif (!ctx->ctx.virt) {\r\nvb2_dma_contig_memops.put(ctx->ctx.alloc);\r\nctx->ctx.alloc = NULL;\r\nctx->ctx.dma = 0;\r\nctx->ctx.virt = NULL;\r\nmfc_err("Remapping context buffer failed.\n");\r\nreturn -ENOMEM;\r\n}\r\nmemset(ctx->ctx.virt, 0, ctx->ctx.size);\r\nwmb();\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nvoid s5p_mfc_release_instance_buffer_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nmfc_debug_enter();\r\nif (ctx->ctx.alloc) {\r\nvb2_dma_contig_memops.put(ctx->ctx.alloc);\r\nctx->ctx.alloc = NULL;\r\nctx->ctx.dma = 0;\r\nctx->ctx.virt = NULL;\r\n}\r\nmfc_debug_leave();\r\n}\r\nint s5p_mfc_alloc_dev_context_buffer_v6(struct s5p_mfc_dev *dev)\r\n{\r\nstruct s5p_mfc_buf_size_v6 *buf_size = dev->variant->buf_size->priv;\r\nmfc_debug_enter();\r\ndev->ctx_buf.alloc = vb2_dma_contig_memops.alloc(\r\ndev->alloc_ctx[MFC_BANK1_ALLOC_CTX], buf_size->dev_ctx);\r\nif (IS_ERR(dev->ctx_buf.alloc)) {\r\nmfc_err("Allocating DESC buffer failed.\n");\r\nreturn PTR_ERR(dev->ctx_buf.alloc);\r\n}\r\ndev->ctx_buf.dma = s5p_mfc_mem_cookie(\r\ndev->alloc_ctx[MFC_BANK1_ALLOC_CTX],\r\ndev->ctx_buf.alloc);\r\ndev->ctx_buf.virt = vb2_dma_contig_memops.vaddr(dev->ctx_buf.alloc);\r\nif (!dev->ctx_buf.virt) {\r\nvb2_dma_contig_memops.put(dev->ctx_buf.alloc);\r\ndev->ctx_buf.alloc = NULL;\r\ndev->ctx_buf.dma = 0;\r\nmfc_err("Remapping DESC buffer failed.\n");\r\nreturn -ENOMEM;\r\n}\r\nmemset(dev->ctx_buf.virt, 0, buf_size->dev_ctx);\r\nwmb();\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nvoid s5p_mfc_release_dev_context_buffer_v6(struct s5p_mfc_dev *dev)\r\n{\r\nif (dev->ctx_buf.alloc) {\r\nvb2_dma_contig_memops.put(dev->ctx_buf.alloc);\r\ndev->ctx_buf.alloc = NULL;\r\ndev->ctx_buf.dma = 0;\r\ndev->ctx_buf.virt = NULL;\r\n}\r\n}\r\nstatic int calc_plane(int width, int height)\r\n{\r\nint mbX, mbY;\r\nmbX = DIV_ROUND_UP(width, S5P_FIMV_NUM_PIXELS_IN_MB_ROW_V6);\r\nmbY = DIV_ROUND_UP(height, S5P_FIMV_NUM_PIXELS_IN_MB_COL_V6);\r\nif (width * height < S5P_FIMV_MAX_FRAME_SIZE_V6)\r\nmbY = (mbY + 1) / 2 * 2;\r\nreturn (mbX * S5P_FIMV_NUM_PIXELS_IN_MB_COL_V6) *\r\n(mbY * S5P_FIMV_NUM_PIXELS_IN_MB_ROW_V6);\r\n}\r\nvoid s5p_mfc_dec_calc_dpb_size_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nctx->buf_width = ALIGN(ctx->img_width, S5P_FIMV_NV12MT_HALIGN_V6);\r\nctx->buf_height = ALIGN(ctx->img_height, S5P_FIMV_NV12MT_VALIGN_V6);\r\nmfc_debug(2, "SEQ Done: Movie dimensions %dx%d,\n"\r\n"buffer dimensions: %dx%d\n", ctx->img_width,\r\nctx->img_height, ctx->buf_width, ctx->buf_height);\r\nctx->luma_size = calc_plane(ctx->img_width, ctx->img_height);\r\nctx->chroma_size = calc_plane(ctx->img_width, (ctx->img_height >> 1));\r\nif (ctx->codec_mode == S5P_MFC_CODEC_H264_DEC ||\r\nctx->codec_mode == S5P_MFC_CODEC_H264_MVC_DEC) {\r\nctx->mv_size = S5P_MFC_DEC_MV_SIZE_V6(ctx->img_width,\r\nctx->img_height);\r\nctx->mv_size = ALIGN(ctx->mv_size, 16);\r\n} else {\r\nctx->mv_size = 0;\r\n}\r\n}\r\nvoid s5p_mfc_enc_calc_src_size_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nunsigned int mb_width, mb_height;\r\nmb_width = MB_WIDTH(ctx->img_width);\r\nmb_height = MB_HEIGHT(ctx->img_height);\r\nctx->buf_width = ALIGN(ctx->img_width, S5P_FIMV_NV12M_HALIGN_V6);\r\nctx->luma_size = ALIGN((mb_width * mb_height) * 256, 256);\r\nctx->chroma_size = ALIGN((mb_width * mb_height) * 128, 256);\r\n}\r\nint s5p_mfc_set_dec_stream_buffer_v6(struct s5p_mfc_ctx *ctx, int buf_addr,\r\nunsigned int start_num_byte, unsigned int strm_size)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nstruct s5p_mfc_buf_size *buf_size = dev->variant->buf_size;\r\nmfc_debug_enter();\r\nmfc_debug(2, "inst_no: %d, buf_addr: 0x%08x,\n"\r\n"buf_size: 0x%08x (%d)\n",\r\nctx->inst_no, buf_addr, strm_size, strm_size);\r\nWRITEL(strm_size, S5P_FIMV_D_STREAM_DATA_SIZE_V6);\r\nWRITEL(buf_addr, S5P_FIMV_D_CPB_BUFFER_ADDR_V6);\r\nWRITEL(buf_size->cpb, S5P_FIMV_D_CPB_BUFFER_SIZE_V6);\r\nWRITEL(start_num_byte, S5P_FIMV_D_CPB_BUFFER_OFFSET_V6);\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nint s5p_mfc_set_dec_frame_buffer_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nunsigned int frame_size, i;\r\nunsigned int frame_size_ch, frame_size_mv;\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nsize_t buf_addr1;\r\nint buf_size1;\r\nint align_gap;\r\nbuf_addr1 = ctx->bank1_phys;\r\nbuf_size1 = ctx->bank1_size;\r\nmfc_debug(2, "Buf1: %p (%d)\n", (void *)buf_addr1, buf_size1);\r\nmfc_debug(2, "Total DPB COUNT: %d\n", ctx->total_dpb_count);\r\nmfc_debug(2, "Setting display delay to %d\n", ctx->display_delay);\r\nWRITEL(ctx->total_dpb_count, S5P_FIMV_D_NUM_DPB_V6);\r\nWRITEL(ctx->luma_size, S5P_FIMV_D_LUMA_DPB_SIZE_V6);\r\nWRITEL(ctx->chroma_size, S5P_FIMV_D_CHROMA_DPB_SIZE_V6);\r\nWRITEL(buf_addr1, S5P_FIMV_D_SCRATCH_BUFFER_ADDR_V6);\r\nWRITEL(ctx->scratch_buf_size, S5P_FIMV_D_SCRATCH_BUFFER_SIZE_V6);\r\nbuf_addr1 += ctx->scratch_buf_size;\r\nbuf_size1 -= ctx->scratch_buf_size;\r\nif (ctx->codec_mode == S5P_FIMV_CODEC_H264_DEC ||\r\nctx->codec_mode == S5P_FIMV_CODEC_H264_MVC_DEC){\r\nWRITEL(ctx->mv_size, S5P_FIMV_D_MV_BUFFER_SIZE_V6);\r\nWRITEL(ctx->mv_count, S5P_FIMV_D_NUM_MV_V6);\r\n}\r\nframe_size = ctx->luma_size;\r\nframe_size_ch = ctx->chroma_size;\r\nframe_size_mv = ctx->mv_size;\r\nmfc_debug(2, "Frame size: %d ch: %d mv: %d\n",\r\nframe_size, frame_size_ch, frame_size_mv);\r\nfor (i = 0; i < ctx->total_dpb_count; i++) {\r\nmfc_debug(2, "Luma %d: %x\n", i,\r\nctx->dst_bufs[i].cookie.raw.luma);\r\nWRITEL(ctx->dst_bufs[i].cookie.raw.luma,\r\nS5P_FIMV_D_LUMA_DPB_V6 + i * 4);\r\nmfc_debug(2, "\tChroma %d: %x\n", i,\r\nctx->dst_bufs[i].cookie.raw.chroma);\r\nWRITEL(ctx->dst_bufs[i].cookie.raw.chroma,\r\nS5P_FIMV_D_CHROMA_DPB_V6 + i * 4);\r\n}\r\nif (ctx->codec_mode == S5P_MFC_CODEC_H264_DEC ||\r\nctx->codec_mode == S5P_MFC_CODEC_H264_MVC_DEC) {\r\nfor (i = 0; i < ctx->mv_count; i++) {\r\nalign_gap = buf_addr1;\r\nbuf_addr1 = ALIGN(buf_addr1, 16);\r\nalign_gap = buf_addr1 - align_gap;\r\nbuf_size1 -= align_gap;\r\nmfc_debug(2, "\tBuf1: %x, size: %d\n",\r\nbuf_addr1, buf_size1);\r\nWRITEL(buf_addr1, S5P_FIMV_D_MV_BUFFER_V6 + i * 4);\r\nbuf_addr1 += frame_size_mv;\r\nbuf_size1 -= frame_size_mv;\r\n}\r\n}\r\nmfc_debug(2, "Buf1: %u, buf_size1: %d (frames %d)\n",\r\nbuf_addr1, buf_size1, ctx->total_dpb_count);\r\nif (buf_size1 < 0) {\r\nmfc_debug(2, "Not enough memory has been allocated.\n");\r\nreturn -ENOMEM;\r\n}\r\nWRITEL(ctx->inst_no, S5P_FIMV_INSTANCE_ID_V6);\r\ns5p_mfc_hw_call(dev->mfc_cmds, cmd_host2risc, dev,\r\nS5P_FIMV_CH_INIT_BUFS_V6, NULL);\r\nmfc_debug(2, "After setting buffers.\n");\r\nreturn 0;\r\n}\r\nint s5p_mfc_set_enc_stream_buffer_v6(struct s5p_mfc_ctx *ctx,\r\nunsigned long addr, unsigned int size)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nWRITEL(addr, S5P_FIMV_E_STREAM_BUFFER_ADDR_V6);\r\nWRITEL(size, S5P_FIMV_E_STREAM_BUFFER_SIZE_V6);\r\nmfc_debug(2, "stream buf addr: 0x%08lx, size: 0x%d",\r\naddr, size);\r\nreturn 0;\r\n}\r\nvoid s5p_mfc_set_enc_frame_buffer_v6(struct s5p_mfc_ctx *ctx,\r\nunsigned long y_addr, unsigned long c_addr)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nWRITEL(y_addr, S5P_FIMV_E_SOURCE_LUMA_ADDR_V6);\r\nWRITEL(c_addr, S5P_FIMV_E_SOURCE_CHROMA_ADDR_V6);\r\nmfc_debug(2, "enc src y buf addr: 0x%08lx", y_addr);\r\nmfc_debug(2, "enc src c buf addr: 0x%08lx", c_addr);\r\n}\r\nvoid s5p_mfc_get_enc_frame_buffer_v6(struct s5p_mfc_ctx *ctx,\r\nunsigned long *y_addr, unsigned long *c_addr)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nunsigned long enc_recon_y_addr, enc_recon_c_addr;\r\n*y_addr = READL(S5P_FIMV_E_ENCODED_SOURCE_LUMA_ADDR_V6);\r\n*c_addr = READL(S5P_FIMV_E_ENCODED_SOURCE_CHROMA_ADDR_V6);\r\nenc_recon_y_addr = READL(S5P_FIMV_E_RECON_LUMA_DPB_ADDR_V6);\r\nenc_recon_c_addr = READL(S5P_FIMV_E_RECON_CHROMA_DPB_ADDR_V6);\r\nmfc_debug(2, "recon y addr: 0x%08lx", enc_recon_y_addr);\r\nmfc_debug(2, "recon c addr: 0x%08lx", enc_recon_c_addr);\r\n}\r\nint s5p_mfc_set_enc_ref_buffer_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nsize_t buf_addr1, buf_size1;\r\nint i;\r\nmfc_debug_enter();\r\nbuf_addr1 = ctx->bank1_phys;\r\nbuf_size1 = ctx->bank1_size;\r\nmfc_debug(2, "Buf1: %p (%d)\n", (void *)buf_addr1, buf_size1);\r\nfor (i = 0; i < ctx->dpb_count; i++) {\r\nWRITEL(buf_addr1, S5P_FIMV_E_LUMA_DPB_V6 + (4 * i));\r\nbuf_addr1 += ctx->luma_dpb_size;\r\nWRITEL(buf_addr1, S5P_FIMV_E_CHROMA_DPB_V6 + (4 * i));\r\nbuf_addr1 += ctx->chroma_dpb_size;\r\nWRITEL(buf_addr1, S5P_FIMV_E_ME_BUFFER_V6 + (4 * i));\r\nbuf_addr1 += ctx->me_buffer_size;\r\nbuf_size1 -= (ctx->luma_dpb_size + ctx->chroma_dpb_size +\r\nctx->me_buffer_size);\r\n}\r\nWRITEL(buf_addr1, S5P_FIMV_E_SCRATCH_BUFFER_ADDR_V6);\r\nWRITEL(ctx->scratch_buf_size, S5P_FIMV_E_SCRATCH_BUFFER_SIZE_V6);\r\nbuf_addr1 += ctx->scratch_buf_size;\r\nbuf_size1 -= ctx->scratch_buf_size;\r\nWRITEL(buf_addr1, S5P_FIMV_E_TMV_BUFFER0_V6);\r\nbuf_addr1 += ctx->tmv_buffer_size >> 1;\r\nWRITEL(buf_addr1, S5P_FIMV_E_TMV_BUFFER1_V6);\r\nbuf_addr1 += ctx->tmv_buffer_size >> 1;\r\nbuf_size1 -= ctx->tmv_buffer_size;\r\nmfc_debug(2, "Buf1: %u, buf_size1: %d (ref frames %d)\n",\r\nbuf_addr1, buf_size1, ctx->dpb_count);\r\nif (buf_size1 < 0) {\r\nmfc_debug(2, "Not enough memory has been allocated.\n");\r\nreturn -ENOMEM;\r\n}\r\nWRITEL(ctx->inst_no, S5P_FIMV_INSTANCE_ID_V6);\r\ns5p_mfc_hw_call(dev->mfc_cmds, cmd_host2risc, dev,\r\nS5P_FIMV_CH_INIT_BUFS_V6, NULL);\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nstatic int s5p_mfc_set_slice_mode(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nWRITEL(ctx->slice_mode, S5P_FIMV_E_MSLICE_MODE_V6);\r\nif (ctx->slice_mode == V4L2_MPEG_VIDEO_MULTI_SICE_MODE_MAX_MB) {\r\nWRITEL(ctx->slice_size.mb, S5P_FIMV_E_MSLICE_SIZE_MB_V6);\r\n} else if (ctx->slice_mode ==\r\nV4L2_MPEG_VIDEO_MULTI_SICE_MODE_MAX_BYTES) {\r\nWRITEL(ctx->slice_size.bits, S5P_FIMV_E_MSLICE_SIZE_BITS_V6);\r\n} else {\r\nWRITEL(0x0, S5P_FIMV_E_MSLICE_SIZE_MB_V6);\r\nWRITEL(0x0, S5P_FIMV_E_MSLICE_SIZE_BITS_V6);\r\n}\r\nreturn 0;\r\n}\r\nstatic int s5p_mfc_set_enc_params(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nstruct s5p_mfc_enc_params *p = &ctx->enc_params;\r\nunsigned int reg = 0;\r\nmfc_debug_enter();\r\nWRITEL(ctx->img_width, S5P_FIMV_E_FRAME_WIDTH_V6);\r\nWRITEL(ctx->img_height, S5P_FIMV_E_FRAME_HEIGHT_V6);\r\nWRITEL(ctx->img_width, S5P_FIMV_E_CROPPED_FRAME_WIDTH_V6);\r\nWRITEL(ctx->img_height, S5P_FIMV_E_CROPPED_FRAME_HEIGHT_V6);\r\nWRITEL(0x0, S5P_FIMV_E_FRAME_CROP_OFFSET_V6);\r\nreg = 0;\r\nreg |= p->gop_size & 0xFFFF;\r\nWRITEL(reg, S5P_FIMV_E_GOP_CONFIG_V6);\r\nctx->slice_mode = p->slice_mode;\r\nreg = 0;\r\nif (p->slice_mode == V4L2_MPEG_VIDEO_MULTI_SICE_MODE_MAX_MB) {\r\nreg |= (0x1 << 3);\r\nWRITEL(reg, S5P_FIMV_E_ENC_OPTIONS_V6);\r\nctx->slice_size.mb = p->slice_mb;\r\n} else if (p->slice_mode == V4L2_MPEG_VIDEO_MULTI_SICE_MODE_MAX_BYTES) {\r\nreg |= (0x1 << 3);\r\nWRITEL(reg, S5P_FIMV_E_ENC_OPTIONS_V6);\r\nctx->slice_size.bits = p->slice_bit;\r\n} else {\r\nreg &= ~(0x1 << 3);\r\nWRITEL(reg, S5P_FIMV_E_ENC_OPTIONS_V6);\r\n}\r\ns5p_mfc_set_slice_mode(ctx);\r\nWRITEL(p->intra_refresh_mb, S5P_FIMV_E_IR_SIZE_V6);\r\nreg = READL(S5P_FIMV_E_ENC_OPTIONS_V6);\r\nif (p->intra_refresh_mb == 0)\r\nreg &= ~(0x1 << 4);\r\nelse\r\nreg |= (0x1 << 4);\r\nWRITEL(reg, S5P_FIMV_E_ENC_OPTIONS_V6);\r\nreg = READL(S5P_FIMV_E_ENC_OPTIONS_V6);\r\nreg &= ~(0x1 << 9);\r\nWRITEL(reg, S5P_FIMV_E_ENC_OPTIONS_V6);\r\nif (ctx->src_fmt->fourcc == V4L2_PIX_FMT_NV12M) {\r\nreg = READL(S5P_FIMV_E_ENC_OPTIONS_V6);\r\nreg &= ~(0x1 << 7);\r\nWRITEL(reg, S5P_FIMV_E_ENC_OPTIONS_V6);\r\nWRITEL(0x0, S5P_FIMV_PIXEL_FORMAT_V6);\r\n} else if (ctx->src_fmt->fourcc == V4L2_PIX_FMT_NV21M) {\r\nreg = READL(S5P_FIMV_E_ENC_OPTIONS_V6);\r\nreg &= ~(0x1 << 7);\r\nWRITEL(reg, S5P_FIMV_E_ENC_OPTIONS_V6);\r\nWRITEL(0x1, S5P_FIMV_PIXEL_FORMAT_V6);\r\n} else if (ctx->src_fmt->fourcc == V4L2_PIX_FMT_NV12MT_16X16) {\r\nreg = READL(S5P_FIMV_E_ENC_OPTIONS_V6);\r\nreg |= (0x1 << 7);\r\nWRITEL(reg, S5P_FIMV_E_ENC_OPTIONS_V6);\r\nWRITEL(0x0, S5P_FIMV_PIXEL_FORMAT_V6);\r\n}\r\nreg = READL(S5P_FIMV_E_ENC_OPTIONS_V6);\r\nreg |= (0x1 << 8);\r\nWRITEL(reg, S5P_FIMV_E_ENC_OPTIONS_V6);\r\nWRITEL(0x0, S5P_FIMV_E_PADDING_CTRL_V6);\r\nif (p->pad) {\r\nreg = 0;\r\nreg |= (1 << 31);\r\nreg |= ((p->pad_cr & 0xFF) << 16);\r\nreg |= ((p->pad_cb & 0xFF) << 8);\r\nreg |= p->pad_luma & 0xFF;\r\nWRITEL(reg, S5P_FIMV_E_PADDING_CTRL_V6);\r\n}\r\nreg = 0;\r\nreg |= ((p->rc_frame & 0x1) << 9);\r\nWRITEL(reg, S5P_FIMV_E_RC_CONFIG_V6);\r\nif (p->rc_frame)\r\nWRITEL(p->rc_bitrate,\r\nS5P_FIMV_E_RC_BIT_RATE_V6);\r\nelse\r\nWRITEL(1, S5P_FIMV_E_RC_BIT_RATE_V6);\r\nif (p->rc_frame) {\r\nif (p->rc_reaction_coeff < TIGHT_CBR_MAX)\r\nWRITEL(1, S5P_FIMV_E_RC_RPARAM_V6);\r\nelse\r\nWRITEL(2, S5P_FIMV_E_RC_RPARAM_V6);\r\n}\r\nreg = READL(S5P_FIMV_E_ENC_OPTIONS_V6);\r\nreg &= ~(0x1 << 2);\r\nreg |= ((p->seq_hdr_mode & 0x1) << 2);\r\nreg &= ~(0x3);\r\nreg |= (p->frame_skip_mode & 0x3);\r\nWRITEL(reg, S5P_FIMV_E_ENC_OPTIONS_V6);\r\nreg = READL(S5P_FIMV_E_RC_CONFIG_V6);\r\nreg &= ~(0x1 << 10);\r\nWRITEL(reg, S5P_FIMV_E_RC_CONFIG_V6);\r\nreg = 0;\r\nreg &= ~(0x3FFF);\r\nreg = 256;\r\nWRITEL(reg, S5P_FIMV_E_MV_HOR_RANGE_V6);\r\nreg = 0;\r\nreg &= ~(0x3FFF);\r\nreg = 256;\r\nWRITEL(reg, S5P_FIMV_E_MV_VER_RANGE_V6);\r\nWRITEL(0x0, S5P_FIMV_E_FRAME_INSERTION_V6);\r\nWRITEL(0x0, S5P_FIMV_E_ROI_BUFFER_ADDR_V6);\r\nWRITEL(0x0, S5P_FIMV_E_PARAM_CHANGE_V6);\r\nWRITEL(0x0, S5P_FIMV_E_RC_ROI_CTRL_V6);\r\nWRITEL(0x0, S5P_FIMV_E_PICTURE_TAG_V6);\r\nWRITEL(0x0, S5P_FIMV_E_BIT_COUNT_ENABLE_V6);\r\nWRITEL(0x0, S5P_FIMV_E_MAX_BIT_COUNT_V6);\r\nWRITEL(0x0, S5P_FIMV_E_MIN_BIT_COUNT_V6);\r\nWRITEL(0x0, S5P_FIMV_E_METADATA_BUFFER_ADDR_V6);\r\nWRITEL(0x0, S5P_FIMV_E_METADATA_BUFFER_SIZE_V6);\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nstatic int s5p_mfc_set_enc_params_h264(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nstruct s5p_mfc_enc_params *p = &ctx->enc_params;\r\nstruct s5p_mfc_h264_enc_params *p_h264 = &p->codec.h264;\r\nunsigned int reg = 0;\r\nint i;\r\nmfc_debug_enter();\r\ns5p_mfc_set_enc_params(ctx);\r\nreg = READL(S5P_FIMV_E_GOP_CONFIG_V6);\r\nreg &= ~(0x3 << 16);\r\nreg |= ((p->num_b_frame & 0x3) << 16);\r\nWRITEL(reg, S5P_FIMV_E_GOP_CONFIG_V6);\r\nreg = 0;\r\nreg |= ((p_h264->level & 0xFF) << 8);\r\nreg |= p_h264->profile & 0x3F;\r\nWRITEL(reg, S5P_FIMV_E_PICTURE_PROFILE_V6);\r\nreg = READL(S5P_FIMV_E_RC_CONFIG_V6);\r\nreg &= ~(0x1 << 8);\r\nreg |= ((p->rc_mb & 0x1) << 8);\r\nWRITEL(reg, S5P_FIMV_E_RC_CONFIG_V6);\r\nreg &= ~(0x3F);\r\nreg |= p_h264->rc_frame_qp & 0x3F;\r\nWRITEL(reg, S5P_FIMV_E_RC_CONFIG_V6);\r\nreg = 0;\r\nreg |= ((p_h264->rc_max_qp & 0x3F) << 8);\r\nreg |= p_h264->rc_min_qp & 0x3F;\r\nWRITEL(reg, S5P_FIMV_E_RC_QP_BOUND_V6);\r\nWRITEL(0x0, S5P_FIMV_E_FIXED_PICTURE_QP_V6);\r\nif (!p->rc_frame && !p->rc_mb) {\r\nreg = 0;\r\nreg |= ((p_h264->rc_b_frame_qp & 0x3F) << 16);\r\nreg |= ((p_h264->rc_p_frame_qp & 0x3F) << 8);\r\nreg |= p_h264->rc_frame_qp & 0x3F;\r\nWRITEL(reg, S5P_FIMV_E_FIXED_PICTURE_QP_V6);\r\n}\r\nif (p->rc_frame && p->rc_framerate_num && p->rc_framerate_denom) {\r\nreg = 0;\r\nreg |= ((p->rc_framerate_num & 0xFFFF) << 16);\r\nreg |= p->rc_framerate_denom & 0xFFFF;\r\nWRITEL(reg, S5P_FIMV_E_RC_FRAME_RATE_V6);\r\n}\r\nif (p->frame_skip_mode ==\r\nV4L2_MPEG_MFC51_VIDEO_FRAME_SKIP_MODE_BUF_LIMIT) {\r\nWRITEL(p_h264->cpb_size & 0xFFFF,\r\nS5P_FIMV_E_VBV_BUFFER_SIZE_V6);\r\nif (p->rc_frame)\r\nWRITEL(p->vbv_delay, S5P_FIMV_E_VBV_INIT_DELAY_V6);\r\n}\r\nreg = 0;\r\nreg |= ((p_h264->interlace & 0x1) << 3);\r\nWRITEL(reg, S5P_FIMV_E_H264_OPTIONS_V6);\r\nif (p_h264->interlace) {\r\nWRITEL(ctx->img_height >> 1,\r\nS5P_FIMV_E_FRAME_HEIGHT_V6);\r\nWRITEL(ctx->img_height >> 1,\r\nS5P_FIMV_E_CROPPED_FRAME_HEIGHT_V6);\r\n}\r\nreg = READL(S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg &= ~(0x3 << 1);\r\nreg |= ((p_h264->loop_filter_mode & 0x3) << 1);\r\nWRITEL(reg, S5P_FIMV_E_H264_OPTIONS_V6);\r\nif (p_h264->loop_filter_alpha < 0) {\r\nreg = 0x10;\r\nreg |= (0xFF - p_h264->loop_filter_alpha) + 1;\r\n} else {\r\nreg = 0x00;\r\nreg |= (p_h264->loop_filter_alpha & 0xF);\r\n}\r\nWRITEL(reg, S5P_FIMV_E_H264_LF_ALPHA_OFFSET_V6);\r\nif (p_h264->loop_filter_beta < 0) {\r\nreg = 0x10;\r\nreg |= (0xFF - p_h264->loop_filter_beta) + 1;\r\n} else {\r\nreg = 0x00;\r\nreg |= (p_h264->loop_filter_beta & 0xF);\r\n}\r\nWRITEL(reg, S5P_FIMV_E_H264_LF_BETA_OFFSET_V6);\r\nreg = READL(S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg &= ~(0x1);\r\nreg |= p_h264->entropy_mode & 0x1;\r\nWRITEL(reg, S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg = READL(S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg &= ~(0x1 << 7);\r\nreg |= (((p_h264->num_ref_pic_4p - 1) & 0x1) << 7);\r\nWRITEL(reg, S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg = READL(S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg &= ~(0x3 << 12);\r\nreg |= ((p_h264->_8x8_transform & 0x3) << 12);\r\nWRITEL(reg, S5P_FIMV_E_H264_OPTIONS_V6);\r\nWRITEL(0x0, S5P_FIMV_E_MB_RC_CONFIG_V6);\r\nif (p->rc_mb) {\r\nreg = 0;\r\nreg |= ((p_h264->rc_mb_dark & 0x1) << 3);\r\nreg |= ((p_h264->rc_mb_smooth & 0x1) << 2);\r\nreg |= ((p_h264->rc_mb_static & 0x1) << 1);\r\nreg |= p_h264->rc_mb_activity & 0x1;\r\nWRITEL(reg, S5P_FIMV_E_MB_RC_CONFIG_V6);\r\n}\r\nreg = READL(S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg &= ~(0x1 << 5);\r\nreg |= ((p_h264->vui_sar & 0x1) << 5);\r\nWRITEL(reg, S5P_FIMV_E_H264_OPTIONS_V6);\r\nWRITEL(0x0, S5P_FIMV_E_ASPECT_RATIO_V6);\r\nWRITEL(0x0, S5P_FIMV_E_EXTENDED_SAR_V6);\r\nif (p_h264->vui_sar) {\r\nreg = 0;\r\nreg |= p_h264->vui_sar_idc & 0xFF;\r\nWRITEL(reg, S5P_FIMV_E_ASPECT_RATIO_V6);\r\nif (p_h264->vui_sar_idc == 0xFF) {\r\nreg = 0;\r\nreg |= (p_h264->vui_ext_sar_width & 0xFFFF) << 16;\r\nreg |= p_h264->vui_ext_sar_height & 0xFFFF;\r\nWRITEL(reg, S5P_FIMV_E_EXTENDED_SAR_V6);\r\n}\r\n}\r\nreg = READL(S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg &= ~(0x1 << 4);\r\nreg |= ((p_h264->open_gop & 0x1) << 4);\r\nWRITEL(reg, S5P_FIMV_E_H264_OPTIONS_V6);\r\nWRITEL(0x0, S5P_FIMV_E_H264_I_PERIOD_V6);\r\nif (p_h264->open_gop) {\r\nreg = 0;\r\nreg |= p_h264->open_gop_size & 0xFFFF;\r\nWRITEL(reg, S5P_FIMV_E_H264_I_PERIOD_V6);\r\n}\r\nreg = READL(S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg &= ~(0x3 << 9);\r\nWRITEL(reg, S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg = READL(S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg &= ~(0x1 << 14);\r\nWRITEL(reg, S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg = READL(S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg &= ~(0x1 << 6);\r\nreg |= ((p_h264->aso & 0x1) << 6);\r\nWRITEL(reg, S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg = READL(S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg &= ~(0x1 << 8);\r\nreg |= ((p_h264->open_gop & 0x1) << 8);\r\nWRITEL(reg, S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg = 0;\r\nif (p_h264->hier_qp && p_h264->hier_qp_layer) {\r\nreg |= (p_h264->hier_qp_type & 0x1) << 0x3;\r\nreg |= p_h264->hier_qp_layer & 0x7;\r\nWRITEL(reg, S5P_FIMV_E_H264_NUM_T_LAYER_V6);\r\nfor (i = 0; i < (p_h264->hier_qp_layer & 0x7); i++)\r\nWRITEL(p_h264->hier_qp_layer_qp[i],\r\nS5P_FIMV_E_H264_HIERARCHICAL_QP_LAYER0_V6 +\r\ni * 4);\r\n}\r\nWRITEL(reg, S5P_FIMV_E_H264_NUM_T_LAYER_V6);\r\nreg = READL(S5P_FIMV_E_H264_OPTIONS_V6);\r\nreg &= ~(0x1 << 25);\r\nreg |= ((p_h264->sei_frame_packing & 0x1) << 25);\r\nWRITEL(reg, S5P_FIMV_E_H264_OPTIONS_V6);\r\nif (p_h264->sei_frame_packing) {\r\nreg = 0;\r\nreg |= ((p_h264->sei_fp_curr_frame_0 & 0x1) << 2);\r\nreg |= p_h264->sei_fp_arrangement_type & 0x3;\r\nWRITEL(reg, S5P_FIMV_E_H264_FRAME_PACKING_SEI_INFO_V6);\r\n}\r\nif (p_h264->fmo) {\r\nswitch (p_h264->fmo_map_type) {\r\ncase V4L2_MPEG_VIDEO_H264_FMO_MAP_TYPE_INTERLEAVED_SLICES:\r\nif (p_h264->fmo_slice_grp > 4)\r\np_h264->fmo_slice_grp = 4;\r\nfor (i = 0; i < (p_h264->fmo_slice_grp & 0xF); i++)\r\nWRITEL(p_h264->fmo_run_len[i] - 1,\r\nS5P_FIMV_E_H264_FMO_RUN_LENGTH_MINUS1_0_V6 +\r\ni * 4);\r\nbreak;\r\ncase V4L2_MPEG_VIDEO_H264_FMO_MAP_TYPE_SCATTERED_SLICES:\r\nif (p_h264->fmo_slice_grp > 4)\r\np_h264->fmo_slice_grp = 4;\r\nbreak;\r\ncase V4L2_MPEG_VIDEO_H264_FMO_MAP_TYPE_RASTER_SCAN:\r\ncase V4L2_MPEG_VIDEO_H264_FMO_MAP_TYPE_WIPE_SCAN:\r\nif (p_h264->fmo_slice_grp > 2)\r\np_h264->fmo_slice_grp = 2;\r\nWRITEL(p_h264->fmo_chg_dir & 0x1,\r\nS5P_FIMV_E_H264_FMO_SLICE_GRP_CHANGE_DIR_V6);\r\nWRITEL(p_h264->fmo_chg_rate,\r\nS5P_FIMV_E_H264_FMO_SLICE_GRP_CHANGE_RATE_MINUS1_V6);\r\nbreak;\r\ndefault:\r\nmfc_err("Unsupported map type for FMO: %d\n",\r\np_h264->fmo_map_type);\r\np_h264->fmo_map_type = 0;\r\np_h264->fmo_slice_grp = 1;\r\nbreak;\r\n}\r\nWRITEL(p_h264->fmo_map_type,\r\nS5P_FIMV_E_H264_FMO_SLICE_GRP_MAP_TYPE_V6);\r\nWRITEL(p_h264->fmo_slice_grp - 1,\r\nS5P_FIMV_E_H264_FMO_NUM_SLICE_GRP_MINUS1_V6);\r\n} else {\r\nWRITEL(0, S5P_FIMV_E_H264_FMO_NUM_SLICE_GRP_MINUS1_V6);\r\n}\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nstatic int s5p_mfc_set_enc_params_mpeg4(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nstruct s5p_mfc_enc_params *p = &ctx->enc_params;\r\nstruct s5p_mfc_mpeg4_enc_params *p_mpeg4 = &p->codec.mpeg4;\r\nunsigned int reg = 0;\r\nmfc_debug_enter();\r\ns5p_mfc_set_enc_params(ctx);\r\nreg = READL(S5P_FIMV_E_GOP_CONFIG_V6);\r\nreg &= ~(0x3 << 16);\r\nreg |= ((p->num_b_frame & 0x3) << 16);\r\nWRITEL(reg, S5P_FIMV_E_GOP_CONFIG_V6);\r\nreg = 0;\r\nreg |= ((p_mpeg4->level & 0xFF) << 8);\r\nreg |= p_mpeg4->profile & 0x3F;\r\nWRITEL(reg, S5P_FIMV_E_PICTURE_PROFILE_V6);\r\nreg = READL(S5P_FIMV_E_RC_CONFIG_V6);\r\nreg &= ~(0x1 << 8);\r\nreg |= ((p->rc_mb & 0x1) << 8);\r\nWRITEL(reg, S5P_FIMV_E_RC_CONFIG_V6);\r\nreg &= ~(0x3F);\r\nreg |= p_mpeg4->rc_frame_qp & 0x3F;\r\nWRITEL(reg, S5P_FIMV_E_RC_CONFIG_V6);\r\nreg = 0;\r\nreg |= ((p_mpeg4->rc_max_qp & 0x3F) << 8);\r\nreg |= p_mpeg4->rc_min_qp & 0x3F;\r\nWRITEL(reg, S5P_FIMV_E_RC_QP_BOUND_V6);\r\nWRITEL(0x0, S5P_FIMV_E_FIXED_PICTURE_QP_V6);\r\nif (!p->rc_frame && !p->rc_mb) {\r\nreg = 0;\r\nreg |= ((p_mpeg4->rc_b_frame_qp & 0x3F) << 16);\r\nreg |= ((p_mpeg4->rc_p_frame_qp & 0x3F) << 8);\r\nreg |= p_mpeg4->rc_frame_qp & 0x3F;\r\nWRITEL(reg, S5P_FIMV_E_FIXED_PICTURE_QP_V6);\r\n}\r\nif (p->rc_frame && p->rc_framerate_num && p->rc_framerate_denom) {\r\nreg = 0;\r\nreg |= ((p->rc_framerate_num & 0xFFFF) << 16);\r\nreg |= p->rc_framerate_denom & 0xFFFF;\r\nWRITEL(reg, S5P_FIMV_E_RC_FRAME_RATE_V6);\r\n}\r\nif (p->frame_skip_mode ==\r\nV4L2_MPEG_MFC51_VIDEO_FRAME_SKIP_MODE_BUF_LIMIT) {\r\nWRITEL(p->vbv_size & 0xFFFF, S5P_FIMV_E_VBV_BUFFER_SIZE_V6);\r\nif (p->rc_frame)\r\nWRITEL(p->vbv_delay, S5P_FIMV_E_VBV_INIT_DELAY_V6);\r\n}\r\nWRITEL(0x0, S5P_FIMV_E_MPEG4_OPTIONS_V6);\r\nWRITEL(0x0, S5P_FIMV_E_MPEG4_HEC_PERIOD_V6);\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nstatic int s5p_mfc_set_enc_params_h263(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nstruct s5p_mfc_enc_params *p = &ctx->enc_params;\r\nstruct s5p_mfc_mpeg4_enc_params *p_h263 = &p->codec.mpeg4;\r\nunsigned int reg = 0;\r\nmfc_debug_enter();\r\ns5p_mfc_set_enc_params(ctx);\r\nreg = 0;\r\nreg |= (0x1 << 4);\r\nWRITEL(reg, S5P_FIMV_E_PICTURE_PROFILE_V6);\r\nreg = READL(S5P_FIMV_E_RC_CONFIG_V6);\r\nreg &= ~(0x1 << 8);\r\nreg |= ((p->rc_mb & 0x1) << 8);\r\nWRITEL(reg, S5P_FIMV_E_RC_CONFIG_V6);\r\nreg &= ~(0x3F);\r\nreg |= p_h263->rc_frame_qp & 0x3F;\r\nWRITEL(reg, S5P_FIMV_E_RC_CONFIG_V6);\r\nreg = 0;\r\nreg |= ((p_h263->rc_max_qp & 0x3F) << 8);\r\nreg |= p_h263->rc_min_qp & 0x3F;\r\nWRITEL(reg, S5P_FIMV_E_RC_QP_BOUND_V6);\r\nWRITEL(0x0, S5P_FIMV_E_FIXED_PICTURE_QP_V6);\r\nif (!p->rc_frame && !p->rc_mb) {\r\nreg = 0;\r\nreg |= ((p_h263->rc_b_frame_qp & 0x3F) << 16);\r\nreg |= ((p_h263->rc_p_frame_qp & 0x3F) << 8);\r\nreg |= p_h263->rc_frame_qp & 0x3F;\r\nWRITEL(reg, S5P_FIMV_E_FIXED_PICTURE_QP_V6);\r\n}\r\nif (p->rc_frame && p->rc_framerate_num && p->rc_framerate_denom) {\r\nreg = 0;\r\nreg |= ((p->rc_framerate_num & 0xFFFF) << 16);\r\nreg |= p->rc_framerate_denom & 0xFFFF;\r\nWRITEL(reg, S5P_FIMV_E_RC_FRAME_RATE_V6);\r\n}\r\nif (p->frame_skip_mode ==\r\nV4L2_MPEG_MFC51_VIDEO_FRAME_SKIP_MODE_BUF_LIMIT) {\r\nWRITEL(p->vbv_size & 0xFFFF, S5P_FIMV_E_VBV_BUFFER_SIZE_V6);\r\nif (p->rc_frame)\r\nWRITEL(p->vbv_delay, S5P_FIMV_E_VBV_INIT_DELAY_V6);\r\n}\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nint s5p_mfc_init_decode_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nunsigned int reg = 0;\r\nint fmo_aso_ctrl = 0;\r\nmfc_debug_enter();\r\nmfc_debug(2, "InstNo: %d/%d\n", ctx->inst_no,\r\nS5P_FIMV_CH_SEQ_HEADER_V6);\r\nmfc_debug(2, "BUFs: %08x %08x %08x\n",\r\nREADL(S5P_FIMV_D_CPB_BUFFER_ADDR_V6),\r\nREADL(S5P_FIMV_D_CPB_BUFFER_ADDR_V6),\r\nREADL(S5P_FIMV_D_CPB_BUFFER_ADDR_V6));\r\nreg |= (fmo_aso_ctrl << S5P_FIMV_D_OPT_FMO_ASO_CTRL_MASK_V6);\r\nif (ctx->display_delay >= 0) {\r\nreg |= (0x1 << S5P_FIMV_D_OPT_DDELAY_EN_SHIFT_V6);\r\nWRITEL(ctx->display_delay, S5P_FIMV_D_DISPLAY_DELAY_V6);\r\n}\r\nif (ctx->codec_mode == S5P_MFC_CODEC_MPEG4_DEC) {\r\nmfc_debug(2, "Set loop filter to: %d\n",\r\nctx->loop_filter_mpeg4);\r\nreg |= (ctx->loop_filter_mpeg4 <<\r\nS5P_FIMV_D_OPT_LF_CTRL_SHIFT_V6);\r\n}\r\nif (ctx->dst_fmt->fourcc == V4L2_PIX_FMT_NV12MT_16X16)\r\nreg |= (0x1 << S5P_FIMV_D_OPT_TILE_MODE_SHIFT_V6);\r\nWRITEL(reg, S5P_FIMV_D_DEC_OPTIONS_V6);\r\nif (ctx->dst_fmt->fourcc == V4L2_PIX_FMT_NV21M)\r\nWRITEL(0x1, S5P_FIMV_PIXEL_FORMAT_V6);\r\nelse\r\nWRITEL(0x0, S5P_FIMV_PIXEL_FORMAT_V6);\r\nWRITEL(ctx->sei_fp_parse & 0x1, S5P_FIMV_D_SEI_ENABLE_V6);\r\nWRITEL(ctx->inst_no, S5P_FIMV_INSTANCE_ID_V6);\r\ns5p_mfc_hw_call(dev->mfc_cmds, cmd_host2risc, dev,\r\nS5P_FIMV_CH_SEQ_HEADER_V6, NULL);\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nstatic inline void s5p_mfc_set_flush(struct s5p_mfc_ctx *ctx, int flush)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nunsigned int dpb;\r\nif (flush)\r\ndpb = READL(S5P_FIMV_SI_CH0_DPB_CONF_CTRL) | (1 << 14);\r\nelse\r\ndpb = READL(S5P_FIMV_SI_CH0_DPB_CONF_CTRL) & ~(1 << 14);\r\nWRITEL(dpb, S5P_FIMV_SI_CH0_DPB_CONF_CTRL);\r\n}\r\nint s5p_mfc_decode_one_frame_v6(struct s5p_mfc_ctx *ctx,\r\nenum s5p_mfc_decode_arg last_frame)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nWRITEL(ctx->dec_dst_flag, S5P_FIMV_D_AVAILABLE_DPB_FLAG_LOWER_V6);\r\nWRITEL(ctx->slice_interface & 0x1, S5P_FIMV_D_SLICE_IF_ENABLE_V6);\r\nWRITEL(ctx->inst_no, S5P_FIMV_INSTANCE_ID_V6);\r\nswitch (last_frame) {\r\ncase 0:\r\ns5p_mfc_hw_call(dev->mfc_cmds, cmd_host2risc, dev,\r\nS5P_FIMV_CH_FRAME_START_V6, NULL);\r\nbreak;\r\ncase 1:\r\ns5p_mfc_hw_call(dev->mfc_cmds, cmd_host2risc, dev,\r\nS5P_FIMV_CH_LAST_FRAME_V6, NULL);\r\nbreak;\r\ndefault:\r\nmfc_err("Unsupported last frame arg.\n");\r\nreturn -EINVAL;\r\n}\r\nmfc_debug(2, "Decoding a usual frame.\n");\r\nreturn 0;\r\n}\r\nint s5p_mfc_init_encode_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nif (ctx->codec_mode == S5P_MFC_CODEC_H264_ENC)\r\ns5p_mfc_set_enc_params_h264(ctx);\r\nelse if (ctx->codec_mode == S5P_MFC_CODEC_MPEG4_ENC)\r\ns5p_mfc_set_enc_params_mpeg4(ctx);\r\nelse if (ctx->codec_mode == S5P_MFC_CODEC_H263_ENC)\r\ns5p_mfc_set_enc_params_h263(ctx);\r\nelse {\r\nmfc_err("Unknown codec for encoding (%x).\n",\r\nctx->codec_mode);\r\nreturn -EINVAL;\r\n}\r\nWRITEL(ctx->inst_no, S5P_FIMV_INSTANCE_ID_V6);\r\ns5p_mfc_hw_call(dev->mfc_cmds, cmd_host2risc, dev,\r\nS5P_FIMV_CH_SEQ_HEADER_V6, NULL);\r\nreturn 0;\r\n}\r\nint s5p_mfc_h264_set_aso_slice_order_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nstruct s5p_mfc_enc_params *p = &ctx->enc_params;\r\nstruct s5p_mfc_h264_enc_params *p_h264 = &p->codec.h264;\r\nint i;\r\nif (p_h264->aso) {\r\nfor (i = 0; i < 8; i++)\r\nWRITEL(p_h264->aso_slice_order[i],\r\nS5P_FIMV_E_H264_ASO_SLICE_ORDER_0_V6 + i * 4);\r\n}\r\nreturn 0;\r\n}\r\nint s5p_mfc_encode_one_frame_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nmfc_debug(2, "++\n");\r\nif (ctx->codec_mode == S5P_MFC_CODEC_H264_ENC)\r\ns5p_mfc_h264_set_aso_slice_order_v6(ctx);\r\ns5p_mfc_set_slice_mode(ctx);\r\nWRITEL(ctx->inst_no, S5P_FIMV_INSTANCE_ID_V6);\r\ns5p_mfc_hw_call(dev->mfc_cmds, cmd_host2risc, dev,\r\nS5P_FIMV_CH_FRAME_START_V6, NULL);\r\nmfc_debug(2, "--\n");\r\nreturn 0;\r\n}\r\nstatic inline int s5p_mfc_get_new_ctx(struct s5p_mfc_dev *dev)\r\n{\r\nunsigned long flags;\r\nint new_ctx;\r\nint cnt;\r\nspin_lock_irqsave(&dev->condlock, flags);\r\nmfc_debug(2, "Previos context: %d (bits %08lx)\n", dev->curr_ctx,\r\ndev->ctx_work_bits);\r\nnew_ctx = (dev->curr_ctx + 1) % MFC_NUM_CONTEXTS;\r\ncnt = 0;\r\nwhile (!test_bit(new_ctx, &dev->ctx_work_bits)) {\r\nnew_ctx = (new_ctx + 1) % MFC_NUM_CONTEXTS;\r\ncnt++;\r\nif (cnt > MFC_NUM_CONTEXTS) {\r\nspin_unlock_irqrestore(&dev->condlock, flags);\r\nreturn -EAGAIN;\r\n}\r\n}\r\nspin_unlock_irqrestore(&dev->condlock, flags);\r\nreturn new_ctx;\r\n}\r\nstatic inline void s5p_mfc_run_dec_last_frames(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nstruct s5p_mfc_buf *temp_vb;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->irqlock, flags);\r\nif (list_empty(&ctx->src_queue)) {\r\nmfc_debug(2, "No src buffers.\n");\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\nreturn;\r\n}\r\ntemp_vb = list_entry(ctx->src_queue.next, struct s5p_mfc_buf, list);\r\ntemp_vb->flags |= MFC_BUF_FLAG_USED;\r\ns5p_mfc_set_dec_stream_buffer_v6(ctx,\r\nvb2_dma_contig_plane_dma_addr(temp_vb->b, 0), 0, 0);\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\ndev->curr_ctx = ctx->num;\r\ns5p_mfc_clean_ctx_int_flags(ctx);\r\ns5p_mfc_decode_one_frame_v6(ctx, 1);\r\n}\r\nstatic inline int s5p_mfc_run_dec_frame(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nstruct s5p_mfc_buf *temp_vb;\r\nunsigned long flags;\r\nint last_frame = 0;\r\nunsigned int index;\r\nspin_lock_irqsave(&dev->irqlock, flags);\r\nif (list_empty(&ctx->src_queue)) {\r\nmfc_debug(2, "No src buffers.\n");\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\nreturn -EAGAIN;\r\n}\r\ntemp_vb = list_entry(ctx->src_queue.next, struct s5p_mfc_buf, list);\r\ntemp_vb->flags |= MFC_BUF_FLAG_USED;\r\ns5p_mfc_set_dec_stream_buffer_v6(ctx,\r\nvb2_dma_contig_plane_dma_addr(temp_vb->b, 0),\r\nctx->consumed_stream,\r\ntemp_vb->b->v4l2_planes[0].bytesused);\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\nindex = temp_vb->b->v4l2_buf.index;\r\ndev->curr_ctx = ctx->num;\r\ns5p_mfc_clean_ctx_int_flags(ctx);\r\nif (temp_vb->b->v4l2_planes[0].bytesused == 0) {\r\nlast_frame = 1;\r\nmfc_debug(2, "Setting ctx->state to FINISHING\n");\r\nctx->state = MFCINST_FINISHING;\r\n}\r\ns5p_mfc_decode_one_frame_v6(ctx, last_frame);\r\nreturn 0;\r\n}\r\nstatic inline int s5p_mfc_run_enc_frame(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nunsigned long flags;\r\nstruct s5p_mfc_buf *dst_mb;\r\nstruct s5p_mfc_buf *src_mb;\r\nunsigned long src_y_addr, src_c_addr, dst_addr;\r\nunsigned int dst_size;\r\nunsigned int index;\r\nspin_lock_irqsave(&dev->irqlock, flags);\r\nif (list_empty(&ctx->src_queue)) {\r\nmfc_debug(2, "no src buffers.\n");\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\nreturn -EAGAIN;\r\n}\r\nif (list_empty(&ctx->dst_queue)) {\r\nmfc_debug(2, "no dst buffers.\n");\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\nreturn -EAGAIN;\r\n}\r\nsrc_mb = list_entry(ctx->src_queue.next, struct s5p_mfc_buf, list);\r\nsrc_mb->flags |= MFC_BUF_FLAG_USED;\r\nsrc_y_addr = vb2_dma_contig_plane_dma_addr(src_mb->b, 0);\r\nsrc_c_addr = vb2_dma_contig_plane_dma_addr(src_mb->b, 1);\r\nmfc_debug(2, "enc src y addr: 0x%08lx", src_y_addr);\r\nmfc_debug(2, "enc src c addr: 0x%08lx", src_c_addr);\r\ns5p_mfc_set_enc_frame_buffer_v6(ctx, src_y_addr, src_c_addr);\r\ndst_mb = list_entry(ctx->dst_queue.next, struct s5p_mfc_buf, list);\r\ndst_mb->flags |= MFC_BUF_FLAG_USED;\r\ndst_addr = vb2_dma_contig_plane_dma_addr(dst_mb->b, 0);\r\ndst_size = vb2_plane_size(dst_mb->b, 0);\r\ns5p_mfc_set_enc_stream_buffer_v6(ctx, dst_addr, dst_size);\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\nindex = src_mb->b->v4l2_buf.index;\r\ndev->curr_ctx = ctx->num;\r\ns5p_mfc_clean_ctx_int_flags(ctx);\r\ns5p_mfc_encode_one_frame_v6(ctx);\r\nreturn 0;\r\n}\r\nstatic inline void s5p_mfc_run_init_dec(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nunsigned long flags;\r\nstruct s5p_mfc_buf *temp_vb;\r\nspin_lock_irqsave(&dev->irqlock, flags);\r\nmfc_debug(2, "Preparing to init decoding.\n");\r\ntemp_vb = list_entry(ctx->src_queue.next, struct s5p_mfc_buf, list);\r\nmfc_debug(2, "Header size: %d\n", temp_vb->b->v4l2_planes[0].bytesused);\r\ns5p_mfc_set_dec_stream_buffer_v6(ctx,\r\nvb2_dma_contig_plane_dma_addr(temp_vb->b, 0), 0,\r\ntemp_vb->b->v4l2_planes[0].bytesused);\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\ndev->curr_ctx = ctx->num;\r\ns5p_mfc_clean_ctx_int_flags(ctx);\r\ns5p_mfc_init_decode_v6(ctx);\r\n}\r\nstatic inline void s5p_mfc_run_init_enc(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nunsigned long flags;\r\nstruct s5p_mfc_buf *dst_mb;\r\nunsigned long dst_addr;\r\nunsigned int dst_size;\r\nspin_lock_irqsave(&dev->irqlock, flags);\r\ndst_mb = list_entry(ctx->dst_queue.next, struct s5p_mfc_buf, list);\r\ndst_addr = vb2_dma_contig_plane_dma_addr(dst_mb->b, 0);\r\ndst_size = vb2_plane_size(dst_mb->b, 0);\r\ns5p_mfc_set_enc_stream_buffer_v6(ctx, dst_addr, dst_size);\r\nspin_unlock_irqrestore(&dev->irqlock, flags);\r\ndev->curr_ctx = ctx->num;\r\ns5p_mfc_clean_ctx_int_flags(ctx);\r\ns5p_mfc_init_encode_v6(ctx);\r\n}\r\nstatic inline int s5p_mfc_run_init_dec_buffers(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nint ret;\r\nif (ctx->capture_state != QUEUE_BUFS_MMAPED) {\r\nmfc_err("It seems that not all destionation buffers were\n"\r\n"mmaped.MFC requires that all destination are mmaped\n"\r\n"before starting processing.\n");\r\nreturn -EAGAIN;\r\n}\r\ndev->curr_ctx = ctx->num;\r\ns5p_mfc_clean_ctx_int_flags(ctx);\r\nret = s5p_mfc_set_dec_frame_buffer_v6(ctx);\r\nif (ret) {\r\nmfc_err("Failed to alloc frame mem.\n");\r\nctx->state = MFCINST_ERROR;\r\n}\r\nreturn ret;\r\n}\r\nstatic inline int s5p_mfc_run_init_enc_buffers(struct s5p_mfc_ctx *ctx)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nint ret;\r\nret = s5p_mfc_alloc_codec_buffers_v6(ctx);\r\nif (ret) {\r\nmfc_err("Failed to allocate encoding buffers.\n");\r\nreturn -ENOMEM;\r\n}\r\nif (ctx->capture_state != QUEUE_BUFS_REQUESTED) {\r\nmfc_err("It seems that destionation buffers were not\n"\r\n"requested.MFC requires that header should be generated\n"\r\n"before allocating codec buffer.\n");\r\nreturn -EAGAIN;\r\n}\r\ndev->curr_ctx = ctx->num;\r\ns5p_mfc_clean_ctx_int_flags(ctx);\r\nret = s5p_mfc_set_enc_ref_buffer_v6(ctx);\r\nif (ret) {\r\nmfc_err("Failed to alloc frame mem.\n");\r\nctx->state = MFCINST_ERROR;\r\n}\r\nreturn ret;\r\n}\r\nvoid s5p_mfc_try_run_v6(struct s5p_mfc_dev *dev)\r\n{\r\nstruct s5p_mfc_ctx *ctx;\r\nint new_ctx;\r\nunsigned int ret = 0;\r\nmfc_debug(1, "Try run dev: %p\n", dev);\r\nif (test_and_set_bit(0, &dev->hw_lock) != 0) {\r\nmfc_debug(1, "Couldn't lock HW.\n");\r\nreturn;\r\n}\r\nnew_ctx = s5p_mfc_get_new_ctx(dev);\r\nif (new_ctx < 0) {\r\nif (test_and_clear_bit(0, &dev->hw_lock) == 0) {\r\nmfc_err("Failed to unlock hardware.\n");\r\nreturn;\r\n}\r\nmfc_debug(1, "No ctx is scheduled to be run.\n");\r\nreturn;\r\n}\r\nmfc_debug(1, "New context: %d\n", new_ctx);\r\nctx = dev->ctx[new_ctx];\r\nmfc_debug(1, "Seting new context to %p\n", ctx);\r\nmfc_debug(1, "ctx->dst_queue_cnt=%d ctx->dpb_count=%d ctx->src_queue_cnt=%d\n",\r\nctx->dst_queue_cnt, ctx->dpb_count, ctx->src_queue_cnt);\r\nmfc_debug(1, "ctx->state=%d\n", ctx->state);\r\ns5p_mfc_clock_on();\r\nif (ctx->type == MFCINST_DECODER) {\r\nswitch (ctx->state) {\r\ncase MFCINST_FINISHING:\r\ns5p_mfc_run_dec_last_frames(ctx);\r\nbreak;\r\ncase MFCINST_RUNNING:\r\nret = s5p_mfc_run_dec_frame(ctx);\r\nbreak;\r\ncase MFCINST_INIT:\r\ns5p_mfc_clean_ctx_int_flags(ctx);\r\nret = s5p_mfc_hw_call(dev->mfc_cmds, open_inst_cmd,\r\nctx);\r\nbreak;\r\ncase MFCINST_RETURN_INST:\r\ns5p_mfc_clean_ctx_int_flags(ctx);\r\nret = s5p_mfc_hw_call(dev->mfc_cmds, close_inst_cmd,\r\nctx);\r\nbreak;\r\ncase MFCINST_GOT_INST:\r\ns5p_mfc_run_init_dec(ctx);\r\nbreak;\r\ncase MFCINST_HEAD_PARSED:\r\nret = s5p_mfc_run_init_dec_buffers(ctx);\r\nbreak;\r\ncase MFCINST_RES_CHANGE_INIT:\r\ns5p_mfc_run_dec_last_frames(ctx);\r\nbreak;\r\ncase MFCINST_RES_CHANGE_FLUSH:\r\ns5p_mfc_run_dec_last_frames(ctx);\r\nbreak;\r\ncase MFCINST_RES_CHANGE_END:\r\nmfc_debug(2, "Finished remaining frames after resolution change.\n");\r\nctx->capture_state = QUEUE_FREE;\r\nmfc_debug(2, "Will re-init the codec`.\n");\r\ns5p_mfc_run_init_dec(ctx);\r\nbreak;\r\ndefault:\r\nret = -EAGAIN;\r\n}\r\n} else if (ctx->type == MFCINST_ENCODER) {\r\nswitch (ctx->state) {\r\ncase MFCINST_FINISHING:\r\ncase MFCINST_RUNNING:\r\nret = s5p_mfc_run_enc_frame(ctx);\r\nbreak;\r\ncase MFCINST_INIT:\r\nret = s5p_mfc_hw_call(dev->mfc_cmds, open_inst_cmd,\r\nctx);\r\nbreak;\r\ncase MFCINST_RETURN_INST:\r\nret = s5p_mfc_hw_call(dev->mfc_cmds, close_inst_cmd,\r\nctx);\r\nbreak;\r\ncase MFCINST_GOT_INST:\r\ns5p_mfc_run_init_enc(ctx);\r\nbreak;\r\ncase MFCINST_HEAD_PARSED:\r\nret = s5p_mfc_run_init_enc_buffers(ctx);\r\nbreak;\r\ndefault:\r\nret = -EAGAIN;\r\n}\r\n} else {\r\nmfc_err("invalid context type: %d\n", ctx->type);\r\nret = -EAGAIN;\r\n}\r\nif (ret) {\r\nif (test_and_clear_bit(0, &dev->hw_lock) == 0)\r\nmfc_err("Failed to unlock hardware.\n");\r\ns5p_mfc_clock_off();\r\n}\r\n}\r\nvoid s5p_mfc_cleanup_queue_v6(struct list_head *lh, struct vb2_queue *vq)\r\n{\r\nstruct s5p_mfc_buf *b;\r\nint i;\r\nwhile (!list_empty(lh)) {\r\nb = list_entry(lh->next, struct s5p_mfc_buf, list);\r\nfor (i = 0; i < b->b->num_planes; i++)\r\nvb2_set_plane_payload(b->b, i, 0);\r\nvb2_buffer_done(b->b, VB2_BUF_STATE_ERROR);\r\nlist_del(&b->list);\r\n}\r\n}\r\nvoid s5p_mfc_clear_int_flags_v6(struct s5p_mfc_dev *dev)\r\n{\r\nmfc_write(dev, 0, S5P_FIMV_RISC2HOST_CMD_V6);\r\nmfc_write(dev, 0, S5P_FIMV_RISC2HOST_INT_V6);\r\n}\r\nvoid s5p_mfc_write_info_v6(struct s5p_mfc_ctx *ctx, unsigned int data,\r\nunsigned int ofs)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\ns5p_mfc_clock_on();\r\nWRITEL(data, ofs);\r\ns5p_mfc_clock_off();\r\n}\r\nunsigned int s5p_mfc_read_info_v6(struct s5p_mfc_ctx *ctx, unsigned int ofs)\r\n{\r\nstruct s5p_mfc_dev *dev = ctx->dev;\r\nint ret;\r\ns5p_mfc_clock_on();\r\nret = READL(ofs);\r\ns5p_mfc_clock_off();\r\nreturn ret;\r\n}\r\nint s5p_mfc_get_dspl_y_adr_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_D_DISPLAY_LUMA_ADDR_V6);\r\n}\r\nint s5p_mfc_get_dec_y_adr_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_D_DECODED_LUMA_ADDR_V6);\r\n}\r\nint s5p_mfc_get_dspl_status_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_D_DISPLAY_STATUS_V6);\r\n}\r\nint s5p_mfc_get_decoded_status_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_D_DECODED_STATUS_V6);\r\n}\r\nint s5p_mfc_get_dec_frame_type_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_D_DECODED_FRAME_TYPE_V6) &\r\nS5P_FIMV_DECODE_FRAME_MASK_V6;\r\n}\r\nint s5p_mfc_get_disp_frame_type_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nreturn mfc_read(ctx->dev, S5P_FIMV_D_DISPLAY_FRAME_TYPE_V6) &\r\nS5P_FIMV_DECODE_FRAME_MASK_V6;\r\n}\r\nint s5p_mfc_get_consumed_stream_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_D_DECODED_NAL_SIZE_V6);\r\n}\r\nint s5p_mfc_get_int_reason_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_RISC2HOST_CMD_V6) &\r\nS5P_FIMV_RISC2HOST_CMD_MASK;\r\n}\r\nint s5p_mfc_get_int_err_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_ERROR_CODE_V6);\r\n}\r\nint s5p_mfc_err_dec_v6(unsigned int err)\r\n{\r\nreturn (err & S5P_FIMV_ERR_DEC_MASK_V6) >> S5P_FIMV_ERR_DEC_SHIFT_V6;\r\n}\r\nint s5p_mfc_err_dspl_v6(unsigned int err)\r\n{\r\nreturn (err & S5P_FIMV_ERR_DSPL_MASK_V6) >> S5P_FIMV_ERR_DSPL_SHIFT_V6;\r\n}\r\nint s5p_mfc_get_img_width_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_D_DISPLAY_FRAME_WIDTH_V6);\r\n}\r\nint s5p_mfc_get_img_height_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_D_DISPLAY_FRAME_HEIGHT_V6);\r\n}\r\nint s5p_mfc_get_dpb_count_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_D_MIN_NUM_DPB_V6);\r\n}\r\nint s5p_mfc_get_mv_count_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_D_MIN_NUM_MV_V6);\r\n}\r\nint s5p_mfc_get_inst_no_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_RET_INSTANCE_ID_V6);\r\n}\r\nint s5p_mfc_get_enc_dpb_count_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_E_NUM_DPB_V6);\r\n}\r\nint s5p_mfc_get_enc_strm_size_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_E_STREAM_SIZE_V6);\r\n}\r\nint s5p_mfc_get_enc_slice_type_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_E_SLICE_TYPE_V6);\r\n}\r\nint s5p_mfc_get_enc_pic_count_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_E_PICTURE_COUNT_V6);\r\n}\r\nint s5p_mfc_get_sei_avail_status_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nreturn mfc_read(ctx->dev, S5P_FIMV_D_FRAME_PACK_SEI_AVAIL_V6);\r\n}\r\nint s5p_mfc_get_mvc_num_views_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_D_MVC_NUM_VIEWS_V6);\r\n}\r\nint s5p_mfc_get_mvc_view_id_v6(struct s5p_mfc_dev *dev)\r\n{\r\nreturn mfc_read(dev, S5P_FIMV_D_MVC_VIEW_ID_V6);\r\n}\r\nunsigned int s5p_mfc_get_pic_type_top_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nreturn s5p_mfc_read_info_v6(ctx, PIC_TIME_TOP_V6);\r\n}\r\nunsigned int s5p_mfc_get_pic_type_bot_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nreturn s5p_mfc_read_info_v6(ctx, PIC_TIME_BOT_V6);\r\n}\r\nunsigned int s5p_mfc_get_crop_info_h_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nreturn s5p_mfc_read_info_v6(ctx, CROP_INFO_H_V6);\r\n}\r\nunsigned int s5p_mfc_get_crop_info_v_v6(struct s5p_mfc_ctx *ctx)\r\n{\r\nreturn s5p_mfc_read_info_v6(ctx, CROP_INFO_V_V6);\r\n}\r\nstruct s5p_mfc_hw_ops *s5p_mfc_init_hw_ops_v6(void)\r\n{\r\nreturn &s5p_mfc_ops_v6;\r\n}

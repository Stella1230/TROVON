static inline struct l2tp_eth_net *l2tp_eth_pernet(struct net *net)\r\n{\r\nreturn net_generic(net, l2tp_eth_net_id);\r\n}\r\nstatic int l2tp_eth_dev_init(struct net_device *dev)\r\n{\r\nstruct l2tp_eth *priv = netdev_priv(dev);\r\npriv->dev = dev;\r\neth_hw_addr_random(dev);\r\nmemset(&dev->broadcast[0], 0xff, 6);\r\ndev->qdisc_tx_busylock = &l2tp_eth_tx_busylock;\r\nreturn 0;\r\n}\r\nstatic void l2tp_eth_dev_uninit(struct net_device *dev)\r\n{\r\nstruct l2tp_eth *priv = netdev_priv(dev);\r\nstruct l2tp_eth_net *pn = l2tp_eth_pernet(dev_net(dev));\r\nspin_lock(&pn->l2tp_eth_lock);\r\nlist_del_init(&priv->list);\r\nspin_unlock(&pn->l2tp_eth_lock);\r\ndev_put(dev);\r\n}\r\nstatic int l2tp_eth_dev_xmit(struct sk_buff *skb, struct net_device *dev)\r\n{\r\nstruct l2tp_eth *priv = netdev_priv(dev);\r\nstruct l2tp_session *session = priv->session;\r\nunsigned int len = skb->len;\r\nint ret = l2tp_xmit_skb(session, skb, session->hdr_len);\r\nif (likely(ret == NET_XMIT_SUCCESS)) {\r\natomic_long_add(len, &priv->tx_bytes);\r\natomic_long_inc(&priv->tx_packets);\r\n} else {\r\natomic_long_inc(&priv->tx_dropped);\r\n}\r\nreturn NETDEV_TX_OK;\r\n}\r\nstatic struct rtnl_link_stats64 *l2tp_eth_get_stats64(struct net_device *dev,\r\nstruct rtnl_link_stats64 *stats)\r\n{\r\nstruct l2tp_eth *priv = netdev_priv(dev);\r\nstats->tx_bytes = atomic_long_read(&priv->tx_bytes);\r\nstats->tx_packets = atomic_long_read(&priv->tx_packets);\r\nstats->tx_dropped = atomic_long_read(&priv->tx_dropped);\r\nstats->rx_bytes = atomic_long_read(&priv->rx_bytes);\r\nstats->rx_packets = atomic_long_read(&priv->rx_packets);\r\nstats->rx_errors = atomic_long_read(&priv->rx_errors);\r\nreturn stats;\r\n}\r\nstatic void l2tp_eth_dev_setup(struct net_device *dev)\r\n{\r\nether_setup(dev);\r\ndev->priv_flags &= ~IFF_TX_SKB_SHARING;\r\ndev->features |= NETIF_F_LLTX;\r\ndev->netdev_ops = &l2tp_eth_netdev_ops;\r\ndev->destructor = free_netdev;\r\n}\r\nstatic void l2tp_eth_dev_recv(struct l2tp_session *session, struct sk_buff *skb, int data_len)\r\n{\r\nstruct l2tp_eth_sess *spriv = l2tp_session_priv(session);\r\nstruct net_device *dev = spriv->dev;\r\nstruct l2tp_eth *priv = netdev_priv(dev);\r\nif (session->debug & L2TP_MSG_DATA) {\r\nunsigned int length;\r\nlength = min(32u, skb->len);\r\nif (!pskb_may_pull(skb, length))\r\ngoto error;\r\npr_debug("%s: eth recv\n", session->name);\r\nprint_hex_dump_bytes("", DUMP_PREFIX_OFFSET, skb->data, length);\r\n}\r\nif (!pskb_may_pull(skb, ETH_HLEN))\r\ngoto error;\r\nsecpath_reset(skb);\r\nskb->ip_summed = CHECKSUM_NONE;\r\nskb_dst_drop(skb);\r\nnf_reset(skb);\r\nif (dev_forward_skb(dev, skb) == NET_RX_SUCCESS) {\r\natomic_long_inc(&priv->rx_packets);\r\natomic_long_add(data_len, &priv->rx_bytes);\r\n} else {\r\natomic_long_inc(&priv->rx_errors);\r\n}\r\nreturn;\r\nerror:\r\natomic_long_inc(&priv->rx_errors);\r\nkfree_skb(skb);\r\n}\r\nstatic void l2tp_eth_delete(struct l2tp_session *session)\r\n{\r\nstruct l2tp_eth_sess *spriv;\r\nstruct net_device *dev;\r\nif (session) {\r\nspriv = l2tp_session_priv(session);\r\ndev = spriv->dev;\r\nif (dev) {\r\nunregister_netdev(dev);\r\nspriv->dev = NULL;\r\nmodule_put(THIS_MODULE);\r\n}\r\n}\r\n}\r\nstatic void l2tp_eth_show(struct seq_file *m, void *arg)\r\n{\r\nstruct l2tp_session *session = arg;\r\nstruct l2tp_eth_sess *spriv = l2tp_session_priv(session);\r\nstruct net_device *dev = spriv->dev;\r\nseq_printf(m, " interface %s\n", dev->name);\r\n}\r\nstatic int l2tp_eth_create(struct net *net, u32 tunnel_id, u32 session_id, u32 peer_session_id, struct l2tp_session_cfg *cfg)\r\n{\r\nstruct net_device *dev;\r\nchar name[IFNAMSIZ];\r\nstruct l2tp_tunnel *tunnel;\r\nstruct l2tp_session *session;\r\nstruct l2tp_eth *priv;\r\nstruct l2tp_eth_sess *spriv;\r\nint rc;\r\nstruct l2tp_eth_net *pn;\r\ntunnel = l2tp_tunnel_find(net, tunnel_id);\r\nif (!tunnel) {\r\nrc = -ENODEV;\r\ngoto out;\r\n}\r\nsession = l2tp_session_find(net, tunnel, session_id);\r\nif (session) {\r\nrc = -EEXIST;\r\ngoto out;\r\n}\r\nif (cfg->ifname) {\r\ndev = dev_get_by_name(net, cfg->ifname);\r\nif (dev) {\r\ndev_put(dev);\r\nrc = -EEXIST;\r\ngoto out;\r\n}\r\nstrlcpy(name, cfg->ifname, IFNAMSIZ);\r\n} else\r\nstrcpy(name, L2TP_ETH_DEV_NAME);\r\nsession = l2tp_session_create(sizeof(*spriv), tunnel, session_id,\r\npeer_session_id, cfg);\r\nif (!session) {\r\nrc = -ENOMEM;\r\ngoto out;\r\n}\r\ndev = alloc_netdev(sizeof(*priv), name, l2tp_eth_dev_setup);\r\nif (!dev) {\r\nrc = -ENOMEM;\r\ngoto out_del_session;\r\n}\r\ndev_net_set(dev, net);\r\nif (session->mtu == 0)\r\nsession->mtu = dev->mtu - session->hdr_len;\r\ndev->mtu = session->mtu;\r\ndev->needed_headroom += session->hdr_len;\r\npriv = netdev_priv(dev);\r\npriv->dev = dev;\r\npriv->session = session;\r\nINIT_LIST_HEAD(&priv->list);\r\npriv->tunnel_sock = tunnel->sock;\r\nsession->recv_skb = l2tp_eth_dev_recv;\r\nsession->session_close = l2tp_eth_delete;\r\n#if defined(CONFIG_L2TP_DEBUGFS) || defined(CONFIG_L2TP_DEBUGFS_MODULE)\r\nsession->show = l2tp_eth_show;\r\n#endif\r\nspriv = l2tp_session_priv(session);\r\nspriv->dev = dev;\r\nrc = register_netdev(dev);\r\nif (rc < 0)\r\ngoto out_del_dev;\r\n__module_get(THIS_MODULE);\r\nstrlcpy(session->ifname, dev->name, IFNAMSIZ);\r\ndev_hold(dev);\r\npn = l2tp_eth_pernet(dev_net(dev));\r\nspin_lock(&pn->l2tp_eth_lock);\r\nlist_add(&priv->list, &pn->l2tp_eth_dev_list);\r\nspin_unlock(&pn->l2tp_eth_lock);\r\nreturn 0;\r\nout_del_dev:\r\nfree_netdev(dev);\r\nspriv->dev = NULL;\r\nout_del_session:\r\nl2tp_session_delete(session);\r\nout:\r\nreturn rc;\r\n}\r\nstatic __net_init int l2tp_eth_init_net(struct net *net)\r\n{\r\nstruct l2tp_eth_net *pn = net_generic(net, l2tp_eth_net_id);\r\nINIT_LIST_HEAD(&pn->l2tp_eth_dev_list);\r\nspin_lock_init(&pn->l2tp_eth_lock);\r\nreturn 0;\r\n}\r\nstatic int __init l2tp_eth_init(void)\r\n{\r\nint err = 0;\r\nerr = l2tp_nl_register_ops(L2TP_PWTYPE_ETH, &l2tp_eth_nl_cmd_ops);\r\nif (err)\r\ngoto out;\r\nerr = register_pernet_device(&l2tp_eth_net_ops);\r\nif (err)\r\ngoto out_unreg;\r\npr_info("L2TP ethernet pseudowire support (L2TPv3)\n");\r\nreturn 0;\r\nout_unreg:\r\nl2tp_nl_unregister_ops(L2TP_PWTYPE_ETH);\r\nout:\r\nreturn err;\r\n}\r\nstatic void __exit l2tp_eth_exit(void)\r\n{\r\nunregister_pernet_device(&l2tp_eth_net_ops);\r\nl2tp_nl_unregister_ops(L2TP_PWTYPE_ETH);\r\n}

static acpi_status acpi_atlas_button_setup(acpi_handle region_handle,\r\nu32 function, void *handler_context, void **return_context)\r\n{\r\n*return_context =\r\n(function != ACPI_REGION_DEACTIVATE) ? handler_context : NULL;\r\nreturn AE_OK;\r\n}\r\nstatic acpi_status acpi_atlas_button_handler(u32 function,\r\nacpi_physical_address address,\r\nu32 bit_width, u64 *value,\r\nvoid *handler_context, void *region_context)\r\n{\r\nacpi_status status;\r\nif (function == ACPI_WRITE) {\r\nint code = address & 0x0f;\r\nint key_down = !(address & 0x10);\r\ninput_event(input_dev, EV_MSC, MSC_SCAN, code);\r\ninput_report_key(input_dev, atlas_keymap[code], key_down);\r\ninput_sync(input_dev);\r\nstatus = AE_OK;\r\n} else {\r\npr_warn("shrugged on unexpected function: function=%x,address=%lx,value=%x\n",\r\nfunction, (unsigned long)address, (u32)*value);\r\nstatus = AE_BAD_PARAMETER;\r\n}\r\nreturn status;\r\n}\r\nstatic int atlas_acpi_button_add(struct acpi_device *device)\r\n{\r\nacpi_status status;\r\nint i;\r\nint err;\r\ninput_dev = input_allocate_device();\r\nif (!input_dev) {\r\npr_err("unable to allocate input device\n");\r\nreturn -ENOMEM;\r\n}\r\ninput_dev->name = "Atlas ACPI button driver";\r\ninput_dev->phys = "ASIM0000/atlas/input0";\r\ninput_dev->id.bustype = BUS_HOST;\r\ninput_dev->keycode = atlas_keymap;\r\ninput_dev->keycodesize = sizeof(unsigned short);\r\ninput_dev->keycodemax = ARRAY_SIZE(atlas_keymap);\r\ninput_set_capability(input_dev, EV_MSC, MSC_SCAN);\r\n__set_bit(EV_KEY, input_dev->evbit);\r\nfor (i = 0; i < ARRAY_SIZE(atlas_keymap); i++) {\r\nif (i < 9) {\r\natlas_keymap[i] = KEY_F1 + i;\r\n__set_bit(KEY_F1 + i, input_dev->keybit);\r\n} else\r\natlas_keymap[i] = KEY_RESERVED;\r\n}\r\nerr = input_register_device(input_dev);\r\nif (err) {\r\npr_err("couldn't register input device\n");\r\ninput_free_device(input_dev);\r\nreturn err;\r\n}\r\nstatus = acpi_install_address_space_handler(device->handle,\r\n0x81, &acpi_atlas_button_handler,\r\n&acpi_atlas_button_setup, device);\r\nif (ACPI_FAILURE(status)) {\r\npr_err("error installing addr spc handler\n");\r\ninput_unregister_device(input_dev);\r\nerr = -EINVAL;\r\n}\r\nreturn err;\r\n}\r\nstatic int atlas_acpi_button_remove(struct acpi_device *device, int type)\r\n{\r\nacpi_status status;\r\nstatus = acpi_remove_address_space_handler(device->handle,\r\n0x81, &acpi_atlas_button_handler);\r\nif (ACPI_FAILURE(status))\r\npr_err("error removing addr spc handler\n");\r\ninput_unregister_device(input_dev);\r\nreturn 0;\r\n}

static int ds2404_gpio_map(struct ds2404 *chip, struct platform_device *pdev,\r\nstruct ds2404_platform_data *pdata)\r\n{\r\nint i, err;\r\nds2404_gpio[DS2404_RST].gpio = pdata->gpio_rst;\r\nds2404_gpio[DS2404_CLK].gpio = pdata->gpio_clk;\r\nds2404_gpio[DS2404_DQ].gpio = pdata->gpio_dq;\r\nfor (i = 0; i < ARRAY_SIZE(ds2404_gpio); i++) {\r\nerr = gpio_request(ds2404_gpio[i].gpio, ds2404_gpio[i].name);\r\nif (err) {\r\nprintk(KERN_ERR "error mapping gpio %s: %d\n",\r\nds2404_gpio[i].name, err);\r\ngoto err_request;\r\n}\r\nif (i != DS2404_DQ)\r\ngpio_direction_output(ds2404_gpio[i].gpio, 1);\r\n}\r\nchip->gpio = ds2404_gpio;\r\nreturn 0;\r\nerr_request:\r\nwhile (--i >= 0)\r\ngpio_free(ds2404_gpio[i].gpio);\r\nreturn err;\r\n}\r\nstatic void ds2404_gpio_unmap(struct ds2404 *chip)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ds2404_gpio); i++)\r\ngpio_free(ds2404_gpio[i].gpio);\r\n}\r\nstatic void ds2404_reset(struct device *dev)\r\n{\r\ngpio_set_value(ds2404_gpio[DS2404_RST].gpio, 0);\r\nudelay(1000);\r\ngpio_set_value(ds2404_gpio[DS2404_RST].gpio, 1);\r\ngpio_set_value(ds2404_gpio[DS2404_CLK].gpio, 0);\r\ngpio_direction_output(ds2404_gpio[DS2404_DQ].gpio, 0);\r\nudelay(10);\r\n}\r\nstatic void ds2404_write_byte(struct device *dev, u8 byte)\r\n{\r\nint i;\r\ngpio_direction_output(ds2404_gpio[DS2404_DQ].gpio, 1);\r\nfor (i = 0; i < 8; i++) {\r\ngpio_set_value(ds2404_gpio[DS2404_DQ].gpio, byte & (1 << i));\r\nudelay(10);\r\ngpio_set_value(ds2404_gpio[DS2404_CLK].gpio, 1);\r\nudelay(10);\r\ngpio_set_value(ds2404_gpio[DS2404_CLK].gpio, 0);\r\nudelay(10);\r\n}\r\n}\r\nstatic u8 ds2404_read_byte(struct device *dev)\r\n{\r\nint i;\r\nu8 ret = 0;\r\ngpio_direction_input(ds2404_gpio[DS2404_DQ].gpio);\r\nfor (i = 0; i < 8; i++) {\r\ngpio_set_value(ds2404_gpio[DS2404_CLK].gpio, 0);\r\nudelay(10);\r\nif (gpio_get_value(ds2404_gpio[DS2404_DQ].gpio))\r\nret |= 1 << i;\r\ngpio_set_value(ds2404_gpio[DS2404_CLK].gpio, 1);\r\nudelay(10);\r\n}\r\nreturn ret;\r\n}\r\nstatic void ds2404_read_memory(struct device *dev, u16 offset,\r\nint length, u8 *out)\r\n{\r\nds2404_reset(dev);\r\nds2404_write_byte(dev, DS2404_READ_MEMORY_CMD);\r\nds2404_write_byte(dev, offset & 0xff);\r\nds2404_write_byte(dev, (offset >> 8) & 0xff);\r\nwhile (length--)\r\n*out++ = ds2404_read_byte(dev);\r\n}\r\nstatic void ds2404_write_memory(struct device *dev, u16 offset,\r\nint length, u8 *out)\r\n{\r\nint i;\r\nu8 ta01, ta02, es;\r\nds2404_reset(dev);\r\nds2404_write_byte(dev, DS2404_WRITE_SCRATCHPAD_CMD);\r\nds2404_write_byte(dev, offset & 0xff);\r\nds2404_write_byte(dev, (offset >> 8) & 0xff);\r\nfor (i = 0; i < length; i++)\r\nds2404_write_byte(dev, out[i]);\r\nds2404_reset(dev);\r\nds2404_write_byte(dev, DS2404_READ_SCRATCHPAD_CMD);\r\nta01 = ds2404_read_byte(dev);\r\nta02 = ds2404_read_byte(dev);\r\nes = ds2404_read_byte(dev);\r\nfor (i = 0; i < length; i++) {\r\nif (out[i] != ds2404_read_byte(dev)) {\r\nprintk(KERN_ERR "read invalid data\n");\r\nreturn;\r\n}\r\n}\r\nds2404_reset(dev);\r\nds2404_write_byte(dev, DS2404_COPY_SCRATCHPAD_CMD);\r\nds2404_write_byte(dev, ta01);\r\nds2404_write_byte(dev, ta02);\r\nds2404_write_byte(dev, es);\r\ngpio_direction_input(ds2404_gpio[DS2404_DQ].gpio);\r\nwhile (gpio_get_value(ds2404_gpio[DS2404_DQ].gpio))\r\n;\r\n}\r\nstatic void ds2404_enable_osc(struct device *dev)\r\n{\r\nu8 in[1] = { 0x10 };\r\nds2404_write_memory(dev, 0x201, 1, in);\r\n}\r\nstatic int ds2404_read_time(struct device *dev, struct rtc_time *dt)\r\n{\r\nunsigned long time = 0;\r\nds2404_read_memory(dev, 0x203, 4, (u8 *)&time);\r\ntime = le32_to_cpu(time);\r\nrtc_time_to_tm(time, dt);\r\nreturn rtc_valid_tm(dt);\r\n}\r\nstatic int ds2404_set_mmss(struct device *dev, unsigned long secs)\r\n{\r\nu32 time = cpu_to_le32(secs);\r\nds2404_write_memory(dev, 0x203, 4, (u8 *)&time);\r\nreturn 0;\r\n}\r\nstatic int rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct ds2404_platform_data *pdata = pdev->dev.platform_data;\r\nstruct ds2404 *chip;\r\nint retval = -EBUSY;\r\nchip = kzalloc(sizeof(struct ds2404), GFP_KERNEL);\r\nif (!chip)\r\nreturn -ENOMEM;\r\nchip->ops = &ds2404_gpio_ops;\r\nretval = chip->ops->map_io(chip, pdev, pdata);\r\nif (retval)\r\ngoto err_chip;\r\ndev_info(&pdev->dev, "using GPIOs RST:%d, CLK:%d, DQ:%d\n",\r\nchip->gpio[DS2404_RST].gpio, chip->gpio[DS2404_CLK].gpio,\r\nchip->gpio[DS2404_DQ].gpio);\r\nplatform_set_drvdata(pdev, chip);\r\nchip->rtc = rtc_device_register("ds2404",\r\n&pdev->dev, &ds2404_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(chip->rtc)) {\r\nretval = PTR_ERR(chip->rtc);\r\ngoto err_io;\r\n}\r\nds2404_enable_osc(&pdev->dev);\r\nreturn 0;\r\nerr_io:\r\nchip->ops->unmap_io(chip);\r\nerr_chip:\r\nkfree(chip);\r\nreturn retval;\r\n}\r\nstatic int rtc_remove(struct platform_device *dev)\r\n{\r\nstruct ds2404 *chip = platform_get_drvdata(dev);\r\nstruct rtc_device *rtc = chip->rtc;\r\nif (rtc)\r\nrtc_device_unregister(rtc);\r\nchip->ops->unmap_io(chip);\r\nkfree(chip);\r\nreturn 0;\r\n}\r\nstatic __init int ds2404_init(void)\r\n{\r\nreturn platform_driver_register(&rtc_device_driver);\r\n}\r\nstatic __exit void ds2404_exit(void)\r\n{\r\nplatform_driver_unregister(&rtc_device_driver);\r\n}

static int clk_pll_prepare(struct clk_hw *hwclk)\r\n{\r\nstruct hb_clk *hbclk = to_hb_clk(hwclk);\r\nu32 reg;\r\nreg = readl(hbclk->reg);\r\nreg &= ~HB_PLL_RESET;\r\nwritel(reg, hbclk->reg);\r\nwhile ((readl(hbclk->reg) & HB_PLL_LOCK) == 0)\r\n;\r\nwhile ((readl(hbclk->reg) & HB_PLL_LOCK_500) == 0)\r\n;\r\nreturn 0;\r\n}\r\nstatic void clk_pll_unprepare(struct clk_hw *hwclk)\r\n{\r\nstruct hb_clk *hbclk = to_hb_clk(hwclk);\r\nu32 reg;\r\nreg = readl(hbclk->reg);\r\nreg |= HB_PLL_RESET;\r\nwritel(reg, hbclk->reg);\r\n}\r\nstatic int clk_pll_enable(struct clk_hw *hwclk)\r\n{\r\nstruct hb_clk *hbclk = to_hb_clk(hwclk);\r\nu32 reg;\r\nreg = readl(hbclk->reg);\r\nreg |= HB_PLL_EXT_ENA;\r\nwritel(reg, hbclk->reg);\r\nreturn 0;\r\n}\r\nstatic void clk_pll_disable(struct clk_hw *hwclk)\r\n{\r\nstruct hb_clk *hbclk = to_hb_clk(hwclk);\r\nu32 reg;\r\nreg = readl(hbclk->reg);\r\nreg &= ~HB_PLL_EXT_ENA;\r\nwritel(reg, hbclk->reg);\r\n}\r\nstatic unsigned long clk_pll_recalc_rate(struct clk_hw *hwclk,\r\nunsigned long parent_rate)\r\n{\r\nstruct hb_clk *hbclk = to_hb_clk(hwclk);\r\nunsigned long divf, divq, vco_freq, reg;\r\nreg = readl(hbclk->reg);\r\nif (reg & HB_PLL_EXT_BYPASS)\r\nreturn parent_rate;\r\ndivf = (reg & HB_PLL_DIVF_MASK) >> HB_PLL_DIVF_SHIFT;\r\ndivq = (reg & HB_PLL_DIVQ_MASK) >> HB_PLL_DIVQ_SHIFT;\r\nvco_freq = parent_rate * (divf + 1);\r\nreturn vco_freq / (1 << divq);\r\n}\r\nstatic void clk_pll_calc(unsigned long rate, unsigned long ref_freq,\r\nu32 *pdivq, u32 *pdivf)\r\n{\r\nu32 divq, divf;\r\nunsigned long vco_freq;\r\nif (rate < HB_PLL_MIN_FREQ)\r\nrate = HB_PLL_MIN_FREQ;\r\nif (rate > HB_PLL_MAX_FREQ)\r\nrate = HB_PLL_MAX_FREQ;\r\nfor (divq = 1; divq <= 6; divq++) {\r\nif ((rate * (1 << divq)) >= HB_PLL_VCO_MIN_FREQ)\r\nbreak;\r\n}\r\nvco_freq = rate * (1 << divq);\r\ndivf = (vco_freq + (ref_freq / 2)) / ref_freq;\r\ndivf--;\r\n*pdivq = divq;\r\n*pdivf = divf;\r\n}\r\nstatic long clk_pll_round_rate(struct clk_hw *hwclk, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nu32 divq, divf;\r\nunsigned long ref_freq = *parent_rate;\r\nclk_pll_calc(rate, ref_freq, &divq, &divf);\r\nreturn (ref_freq * (divf + 1)) / (1 << divq);\r\n}\r\nstatic int clk_pll_set_rate(struct clk_hw *hwclk, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct hb_clk *hbclk = to_hb_clk(hwclk);\r\nu32 divq, divf;\r\nu32 reg;\r\nclk_pll_calc(rate, parent_rate, &divq, &divf);\r\nreg = readl(hbclk->reg);\r\nif (divf != ((reg & HB_PLL_DIVF_MASK) >> HB_PLL_DIVF_SHIFT)) {\r\nreg |= HB_PLL_EXT_BYPASS;\r\nwritel(reg | HB_PLL_EXT_BYPASS, hbclk->reg);\r\nwritel(reg | HB_PLL_RESET, hbclk->reg);\r\nreg &= ~(HB_PLL_DIVF_MASK | HB_PLL_DIVQ_MASK);\r\nreg |= (divf << HB_PLL_DIVF_SHIFT) | (divq << HB_PLL_DIVQ_SHIFT);\r\nwritel(reg | HB_PLL_RESET, hbclk->reg);\r\nwritel(reg, hbclk->reg);\r\nwhile ((readl(hbclk->reg) & HB_PLL_LOCK) == 0)\r\n;\r\nwhile ((readl(hbclk->reg) & HB_PLL_LOCK_500) == 0)\r\n;\r\nreg |= HB_PLL_EXT_ENA;\r\nreg &= ~HB_PLL_EXT_BYPASS;\r\n} else {\r\nreg &= ~HB_PLL_DIVQ_MASK;\r\nreg |= divq << HB_PLL_DIVQ_SHIFT;\r\n}\r\nwritel(reg, hbclk->reg);\r\nreturn 0;\r\n}\r\nstatic unsigned long clk_cpu_periphclk_recalc_rate(struct clk_hw *hwclk,\r\nunsigned long parent_rate)\r\n{\r\nstruct hb_clk *hbclk = to_hb_clk(hwclk);\r\nu32 div = (readl(hbclk->reg) & HB_A9_PCLK_DIV) ? 8 : 4;\r\nreturn parent_rate / div;\r\n}\r\nstatic unsigned long clk_cpu_a9bclk_recalc_rate(struct clk_hw *hwclk,\r\nunsigned long parent_rate)\r\n{\r\nstruct hb_clk *hbclk = to_hb_clk(hwclk);\r\nu32 div = (readl(hbclk->reg) & HB_A9_BCLK_DIV_MASK) >> HB_A9_BCLK_DIV_SHIFT;\r\nreturn parent_rate / (div + 2);\r\n}\r\nstatic unsigned long clk_periclk_recalc_rate(struct clk_hw *hwclk,\r\nunsigned long parent_rate)\r\n{\r\nstruct hb_clk *hbclk = to_hb_clk(hwclk);\r\nu32 div;\r\ndiv = readl(hbclk->reg) & 0x1f;\r\ndiv++;\r\ndiv *= 2;\r\nreturn parent_rate / div;\r\n}\r\nstatic long clk_periclk_round_rate(struct clk_hw *hwclk, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nu32 div;\r\ndiv = *parent_rate / rate;\r\ndiv++;\r\ndiv &= ~0x1;\r\nreturn *parent_rate / div;\r\n}\r\nstatic int clk_periclk_set_rate(struct clk_hw *hwclk, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct hb_clk *hbclk = to_hb_clk(hwclk);\r\nu32 div;\r\ndiv = parent_rate / rate;\r\nif (div & 0x1)\r\nreturn -EINVAL;\r\nwritel(div >> 1, hbclk->reg);\r\nreturn 0;\r\n}\r\nvoid __init hb_pll_init(struct device_node *node)\r\n{\r\nhb_clk_init(node, &clk_pll_ops);\r\n}\r\nstatic void __init hb_a9periph_init(struct device_node *node)\r\n{\r\nhb_clk_init(node, &a9periphclk_ops);\r\n}\r\nstatic void __init hb_a9bus_init(struct device_node *node)\r\n{\r\nstruct clk *clk = hb_clk_init(node, &a9bclk_ops);\r\nclk_prepare_enable(clk);\r\n}\r\nstatic void __init hb_emmc_init(struct device_node *node)\r\n{\r\nhb_clk_init(node, &periclk_ops);\r\n}\r\nvoid __init highbank_clocks_init(void)\r\n{\r\nof_clk_init(clk_match);\r\n}

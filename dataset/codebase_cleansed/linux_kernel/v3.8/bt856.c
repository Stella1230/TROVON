static inline struct bt856 *to_bt856(struct v4l2_subdev *sd)\r\n{\r\nreturn container_of(sd, struct bt856, sd);\r\n}\r\nstatic inline int bt856_write(struct bt856 *encoder, u8 reg, u8 value)\r\n{\r\nstruct i2c_client *client = v4l2_get_subdevdata(&encoder->sd);\r\nencoder->reg[reg - BT856_REG_OFFSET] = value;\r\nreturn i2c_smbus_write_byte_data(client, reg, value);\r\n}\r\nstatic inline int bt856_setbit(struct bt856 *encoder, u8 reg, u8 bit, u8 value)\r\n{\r\nreturn bt856_write(encoder, reg,\r\n(encoder->reg[reg - BT856_REG_OFFSET] & ~(1 << bit)) |\r\n(value ? (1 << bit) : 0));\r\n}\r\nstatic void bt856_dump(struct bt856 *encoder)\r\n{\r\nint i;\r\nv4l2_info(&encoder->sd, "register dump:\n");\r\nfor (i = 0; i < BT856_NR_REG; i += 2)\r\nprintk(KERN_CONT " %02x", encoder->reg[i]);\r\nprintk(KERN_CONT "\n");\r\n}\r\nstatic int bt856_init(struct v4l2_subdev *sd, u32 arg)\r\n{\r\nstruct bt856 *encoder = to_bt856(sd);\r\nv4l2_dbg(1, debug, sd, "init\n");\r\nbt856_write(encoder, 0xdc, 0x18);\r\nbt856_write(encoder, 0xda, 0);\r\nbt856_write(encoder, 0xde, 0);\r\nbt856_setbit(encoder, 0xdc, 3, 1);\r\nbt856_setbit(encoder, 0xdc, 4, 1);\r\nif (encoder->norm & V4L2_STD_NTSC)\r\nbt856_setbit(encoder, 0xdc, 2, 0);\r\nelse\r\nbt856_setbit(encoder, 0xdc, 2, 1);\r\nbt856_setbit(encoder, 0xdc, 1, 1);\r\nbt856_setbit(encoder, 0xde, 4, 0);\r\nbt856_setbit(encoder, 0xde, 3, 1);\r\nif (debug != 0)\r\nbt856_dump(encoder);\r\nreturn 0;\r\n}\r\nstatic int bt856_s_std_output(struct v4l2_subdev *sd, v4l2_std_id std)\r\n{\r\nstruct bt856 *encoder = to_bt856(sd);\r\nv4l2_dbg(1, debug, sd, "set norm %llx\n", (unsigned long long)std);\r\nif (std & V4L2_STD_NTSC) {\r\nbt856_setbit(encoder, 0xdc, 2, 0);\r\n} else if (std & V4L2_STD_PAL) {\r\nbt856_setbit(encoder, 0xdc, 2, 1);\r\nbt856_setbit(encoder, 0xda, 0, 0);\r\n} else {\r\nreturn -EINVAL;\r\n}\r\nencoder->norm = std;\r\nif (debug != 0)\r\nbt856_dump(encoder);\r\nreturn 0;\r\n}\r\nstatic int bt856_s_routing(struct v4l2_subdev *sd,\r\nu32 input, u32 output, u32 config)\r\n{\r\nstruct bt856 *encoder = to_bt856(sd);\r\nv4l2_dbg(1, debug, sd, "set input %d\n", input);\r\nswitch (input) {\r\ncase 0:\r\nbt856_setbit(encoder, 0xde, 4, 0);\r\nbt856_setbit(encoder, 0xde, 3, 1);\r\nbt856_setbit(encoder, 0xdc, 3, 1);\r\nbt856_setbit(encoder, 0xdc, 6, 0);\r\nbreak;\r\ncase 1:\r\nbt856_setbit(encoder, 0xde, 4, 0);\r\nbt856_setbit(encoder, 0xde, 3, 1);\r\nbt856_setbit(encoder, 0xdc, 3, 1);\r\nbt856_setbit(encoder, 0xdc, 6, 1);\r\nbreak;\r\ncase 2:\r\nbt856_setbit(encoder, 0xdc, 3, 0);\r\nbt856_setbit(encoder, 0xde, 4, 1);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (debug != 0)\r\nbt856_dump(encoder);\r\nreturn 0;\r\n}\r\nstatic int bt856_g_chip_ident(struct v4l2_subdev *sd, struct v4l2_dbg_chip_ident *chip)\r\n{\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nreturn v4l2_chip_ident_i2c_client(client, chip, V4L2_IDENT_BT856, 0);\r\n}\r\nstatic int bt856_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct bt856 *encoder;\r\nstruct v4l2_subdev *sd;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -ENODEV;\r\nv4l_info(client, "chip found @ 0x%x (%s)\n",\r\nclient->addr << 1, client->adapter->name);\r\nencoder = kzalloc(sizeof(struct bt856), GFP_KERNEL);\r\nif (encoder == NULL)\r\nreturn -ENOMEM;\r\nsd = &encoder->sd;\r\nv4l2_i2c_subdev_init(sd, client, &bt856_ops);\r\nencoder->norm = V4L2_STD_NTSC;\r\nbt856_write(encoder, 0xdc, 0x18);\r\nbt856_write(encoder, 0xda, 0);\r\nbt856_write(encoder, 0xde, 0);\r\nbt856_setbit(encoder, 0xdc, 3, 1);\r\nbt856_setbit(encoder, 0xdc, 4, 1);\r\nif (encoder->norm & V4L2_STD_NTSC)\r\nbt856_setbit(encoder, 0xdc, 2, 0);\r\nelse\r\nbt856_setbit(encoder, 0xdc, 2, 1);\r\nbt856_setbit(encoder, 0xdc, 1, 1);\r\nbt856_setbit(encoder, 0xde, 4, 0);\r\nbt856_setbit(encoder, 0xde, 3, 1);\r\nif (debug != 0)\r\nbt856_dump(encoder);\r\nreturn 0;\r\n}\r\nstatic int bt856_remove(struct i2c_client *client)\r\n{\r\nstruct v4l2_subdev *sd = i2c_get_clientdata(client);\r\nv4l2_device_unregister_subdev(sd);\r\nkfree(to_bt856(sd));\r\nreturn 0;\r\n}

static bool tomoyo_check_task_acl(struct tomoyo_request_info *r,\r\nconst struct tomoyo_acl_info *ptr)\r\n{\r\nconst struct tomoyo_task_acl *acl = container_of(ptr, typeof(*acl),\r\nhead);\r\nreturn !tomoyo_pathcmp(r->param.task.domainname, acl->domainname);\r\n}\r\nstatic ssize_t tomoyo_write_self(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nchar *data;\r\nint error;\r\nif (!count || count >= TOMOYO_EXEC_TMPSIZE - 10)\r\nreturn -ENOMEM;\r\ndata = kzalloc(count + 1, GFP_NOFS);\r\nif (!data)\r\nreturn -ENOMEM;\r\nif (copy_from_user(data, buf, count)) {\r\nerror = -EFAULT;\r\ngoto out;\r\n}\r\ntomoyo_normalize_line(data);\r\nif (tomoyo_correct_domain(data)) {\r\nconst int idx = tomoyo_read_lock();\r\nstruct tomoyo_path_info name;\r\nstruct tomoyo_request_info r;\r\nname.name = data;\r\ntomoyo_fill_path_info(&name);\r\ntomoyo_init_request_info(&r, NULL, TOMOYO_MAC_FILE_EXECUTE);\r\nr.param_type = TOMOYO_TYPE_MANUAL_TASK_ACL;\r\nr.param.task.domainname = &name;\r\ntomoyo_check_acl(&r, tomoyo_check_task_acl);\r\nif (!r.granted)\r\nerror = -EPERM;\r\nelse {\r\nstruct tomoyo_domain_info *new_domain =\r\ntomoyo_assign_domain(data, true);\r\nif (!new_domain) {\r\nerror = -ENOENT;\r\n} else {\r\nstruct cred *cred = prepare_creds();\r\nif (!cred) {\r\nerror = -ENOMEM;\r\n} else {\r\nstruct tomoyo_domain_info *old_domain =\r\ncred->security;\r\ncred->security = new_domain;\r\natomic_inc(&new_domain->users);\r\natomic_dec(&old_domain->users);\r\ncommit_creds(cred);\r\nerror = 0;\r\n}\r\n}\r\n}\r\ntomoyo_read_unlock(idx);\r\n} else\r\nerror = -EINVAL;\r\nout:\r\nkfree(data);\r\nreturn error ? error : count;\r\n}\r\nstatic ssize_t tomoyo_read_self(struct file *file, char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nconst char *domain = tomoyo_domain()->domainname->name;\r\nloff_t len = strlen(domain);\r\nloff_t pos = *ppos;\r\nif (pos >= len || !count)\r\nreturn 0;\r\nlen -= pos;\r\nif (count < len)\r\nlen = count;\r\nif (copy_to_user(buf, domain + pos, len))\r\nreturn -EFAULT;\r\n*ppos += len;\r\nreturn len;\r\n}\r\nstatic int tomoyo_open(struct inode *inode, struct file *file)\r\n{\r\nconst int key = ((u8 *) file->f_path.dentry->d_inode->i_private)\r\n- ((u8 *) NULL);\r\nreturn tomoyo_open_control(key, file);\r\n}\r\nstatic int tomoyo_release(struct inode *inode, struct file *file)\r\n{\r\nreturn tomoyo_close_control(file->private_data);\r\n}\r\nstatic unsigned int tomoyo_poll(struct file *file, poll_table *wait)\r\n{\r\nreturn tomoyo_poll_control(file, wait);\r\n}\r\nstatic ssize_t tomoyo_read(struct file *file, char __user *buf, size_t count,\r\nloff_t *ppos)\r\n{\r\nreturn tomoyo_read_control(file->private_data, buf, count);\r\n}\r\nstatic ssize_t tomoyo_write(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nreturn tomoyo_write_control(file->private_data, buf, count);\r\n}\r\nstatic void __init tomoyo_create_entry(const char *name, const umode_t mode,\r\nstruct dentry *parent, const u8 key)\r\n{\r\nsecurityfs_create_file(name, mode, parent, ((u8 *) NULL) + key,\r\n&tomoyo_operations);\r\n}\r\nstatic int __init tomoyo_initerface_init(void)\r\n{\r\nstruct dentry *tomoyo_dir;\r\nif (current_cred()->security != &tomoyo_kernel_domain)\r\nreturn 0;\r\ntomoyo_dir = securityfs_create_dir("tomoyo", NULL);\r\ntomoyo_create_entry("query", 0600, tomoyo_dir,\r\nTOMOYO_QUERY);\r\ntomoyo_create_entry("domain_policy", 0600, tomoyo_dir,\r\nTOMOYO_DOMAINPOLICY);\r\ntomoyo_create_entry("exception_policy", 0600, tomoyo_dir,\r\nTOMOYO_EXCEPTIONPOLICY);\r\ntomoyo_create_entry("audit", 0400, tomoyo_dir,\r\nTOMOYO_AUDIT);\r\ntomoyo_create_entry(".process_status", 0600, tomoyo_dir,\r\nTOMOYO_PROCESS_STATUS);\r\ntomoyo_create_entry("stat", 0644, tomoyo_dir,\r\nTOMOYO_STAT);\r\ntomoyo_create_entry("profile", 0600, tomoyo_dir,\r\nTOMOYO_PROFILE);\r\ntomoyo_create_entry("manager", 0600, tomoyo_dir,\r\nTOMOYO_MANAGER);\r\ntomoyo_create_entry("version", 0400, tomoyo_dir,\r\nTOMOYO_VERSION);\r\nsecurityfs_create_file("self_domain", 0666, tomoyo_dir, NULL,\r\n&tomoyo_self_operations);\r\ntomoyo_load_builtin_policy();\r\nreturn 0;\r\n}

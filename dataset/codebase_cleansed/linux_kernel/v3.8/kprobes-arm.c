static void __kprobes simulate_bbl(struct kprobe *p, struct pt_regs *regs)\r\n{\r\nkprobe_opcode_t insn = p->opcode;\r\nlong iaddr = (long)p->addr;\r\nint disp = branch_displacement(insn);\r\nif (insn & (1 << 24))\r\nregs->ARM_lr = iaddr + 4;\r\nregs->ARM_pc = iaddr + 8 + disp;\r\n}\r\nstatic void __kprobes simulate_blx1(struct kprobe *p, struct pt_regs *regs)\r\n{\r\nkprobe_opcode_t insn = p->opcode;\r\nlong iaddr = (long)p->addr;\r\nint disp = branch_displacement(insn);\r\nregs->ARM_lr = iaddr + 4;\r\nregs->ARM_pc = iaddr + 8 + disp + ((insn >> 23) & 0x2);\r\nregs->ARM_cpsr |= PSR_T_BIT;\r\n}\r\nstatic void __kprobes simulate_blx2bx(struct kprobe *p, struct pt_regs *regs)\r\n{\r\nkprobe_opcode_t insn = p->opcode;\r\nint rm = insn & 0xf;\r\nlong rmv = regs->uregs[rm];\r\nif (insn & (1 << 5))\r\nregs->ARM_lr = (long)p->addr + 4;\r\nregs->ARM_pc = rmv & ~0x1;\r\nregs->ARM_cpsr &= ~PSR_T_BIT;\r\nif (rmv & 0x1)\r\nregs->ARM_cpsr |= PSR_T_BIT;\r\n}\r\nstatic void __kprobes simulate_mrs(struct kprobe *p, struct pt_regs *regs)\r\n{\r\nkprobe_opcode_t insn = p->opcode;\r\nint rd = (insn >> 12) & 0xf;\r\nunsigned long mask = 0xf8ff03df;\r\nregs->uregs[rd] = regs->ARM_cpsr & mask;\r\n}\r\nstatic void __kprobes simulate_mov_ipsp(struct kprobe *p, struct pt_regs *regs)\r\n{\r\nregs->uregs[12] = regs->uregs[13];\r\n}\r\nstatic void __kprobes\r\nemulate_ldrdstrd(struct kprobe *p, struct pt_regs *regs)\r\n{\r\nkprobe_opcode_t insn = p->opcode;\r\nunsigned long pc = (unsigned long)p->addr + 8;\r\nint rt = (insn >> 12) & 0xf;\r\nint rn = (insn >> 16) & 0xf;\r\nint rm = insn & 0xf;\r\nregister unsigned long rtv asm("r0") = regs->uregs[rt];\r\nregister unsigned long rt2v asm("r1") = regs->uregs[rt+1];\r\nregister unsigned long rnv asm("r2") = (rn == 15) ? pc\r\n: regs->uregs[rn];\r\nregister unsigned long rmv asm("r3") = regs->uregs[rm];\r\n__asm__ __volatile__ (\r\nBLX("%[fn]")\r\n: "=r" (rtv), "=r" (rt2v), "=r" (rnv)\r\n: "0" (rtv), "1" (rt2v), "2" (rnv), "r" (rmv),\r\n[fn] "r" (p->ainsn.insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nregs->uregs[rt] = rtv;\r\nregs->uregs[rt+1] = rt2v;\r\nif (is_writeback(insn))\r\nregs->uregs[rn] = rnv;\r\n}\r\nstatic void __kprobes\r\nemulate_ldr(struct kprobe *p, struct pt_regs *regs)\r\n{\r\nkprobe_opcode_t insn = p->opcode;\r\nunsigned long pc = (unsigned long)p->addr + 8;\r\nint rt = (insn >> 12) & 0xf;\r\nint rn = (insn >> 16) & 0xf;\r\nint rm = insn & 0xf;\r\nregister unsigned long rtv asm("r0");\r\nregister unsigned long rnv asm("r2") = (rn == 15) ? pc\r\n: regs->uregs[rn];\r\nregister unsigned long rmv asm("r3") = regs->uregs[rm];\r\n__asm__ __volatile__ (\r\nBLX("%[fn]")\r\n: "=r" (rtv), "=r" (rnv)\r\n: "1" (rnv), "r" (rmv), [fn] "r" (p->ainsn.insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nif (rt == 15)\r\nload_write_pc(rtv, regs);\r\nelse\r\nregs->uregs[rt] = rtv;\r\nif (is_writeback(insn))\r\nregs->uregs[rn] = rnv;\r\n}\r\nstatic void __kprobes\r\nemulate_str(struct kprobe *p, struct pt_regs *regs)\r\n{\r\nkprobe_opcode_t insn = p->opcode;\r\nunsigned long rtpc = (unsigned long)p->addr + str_pc_offset;\r\nunsigned long rnpc = (unsigned long)p->addr + 8;\r\nint rt = (insn >> 12) & 0xf;\r\nint rn = (insn >> 16) & 0xf;\r\nint rm = insn & 0xf;\r\nregister unsigned long rtv asm("r0") = (rt == 15) ? rtpc\r\n: regs->uregs[rt];\r\nregister unsigned long rnv asm("r2") = (rn == 15) ? rnpc\r\n: regs->uregs[rn];\r\nregister unsigned long rmv asm("r3") = regs->uregs[rm];\r\n__asm__ __volatile__ (\r\nBLX("%[fn]")\r\n: "=r" (rnv)\r\n: "r" (rtv), "0" (rnv), "r" (rmv), [fn] "r" (p->ainsn.insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nif (is_writeback(insn))\r\nregs->uregs[rn] = rnv;\r\n}\r\nstatic void __kprobes\r\nemulate_rd12rn16rm0rs8_rwflags(struct kprobe *p, struct pt_regs *regs)\r\n{\r\nkprobe_opcode_t insn = p->opcode;\r\nunsigned long pc = (unsigned long)p->addr + 8;\r\nint rd = (insn >> 12) & 0xf;\r\nint rn = (insn >> 16) & 0xf;\r\nint rm = insn & 0xf;\r\nint rs = (insn >> 8) & 0xf;\r\nregister unsigned long rdv asm("r0") = regs->uregs[rd];\r\nregister unsigned long rnv asm("r2") = (rn == 15) ? pc\r\n: regs->uregs[rn];\r\nregister unsigned long rmv asm("r3") = (rm == 15) ? pc\r\n: regs->uregs[rm];\r\nregister unsigned long rsv asm("r1") = regs->uregs[rs];\r\nunsigned long cpsr = regs->ARM_cpsr;\r\n__asm__ __volatile__ (\r\n"msr cpsr_fs, %[cpsr] \n\t"\r\nBLX("%[fn]")\r\n"mrs %[cpsr], cpsr \n\t"\r\n: "=r" (rdv), [cpsr] "=r" (cpsr)\r\n: "0" (rdv), "r" (rnv), "r" (rmv), "r" (rsv),\r\n"1" (cpsr), [fn] "r" (p->ainsn.insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nif (rd == 15)\r\nalu_write_pc(rdv, regs);\r\nelse\r\nregs->uregs[rd] = rdv;\r\nregs->ARM_cpsr = (regs->ARM_cpsr & ~APSR_MASK) | (cpsr & APSR_MASK);\r\n}\r\nstatic void __kprobes\r\nemulate_rd12rn16rm0_rwflags_nopc(struct kprobe *p, struct pt_regs *regs)\r\n{\r\nkprobe_opcode_t insn = p->opcode;\r\nint rd = (insn >> 12) & 0xf;\r\nint rn = (insn >> 16) & 0xf;\r\nint rm = insn & 0xf;\r\nregister unsigned long rdv asm("r0") = regs->uregs[rd];\r\nregister unsigned long rnv asm("r2") = regs->uregs[rn];\r\nregister unsigned long rmv asm("r3") = regs->uregs[rm];\r\nunsigned long cpsr = regs->ARM_cpsr;\r\n__asm__ __volatile__ (\r\n"msr cpsr_fs, %[cpsr] \n\t"\r\nBLX("%[fn]")\r\n"mrs %[cpsr], cpsr \n\t"\r\n: "=r" (rdv), [cpsr] "=r" (cpsr)\r\n: "0" (rdv), "r" (rnv), "r" (rmv),\r\n"1" (cpsr), [fn] "r" (p->ainsn.insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nregs->uregs[rd] = rdv;\r\nregs->ARM_cpsr = (regs->ARM_cpsr & ~APSR_MASK) | (cpsr & APSR_MASK);\r\n}\r\nstatic void __kprobes\r\nemulate_rd16rn12rm0rs8_rwflags_nopc(struct kprobe *p, struct pt_regs *regs)\r\n{\r\nkprobe_opcode_t insn = p->opcode;\r\nint rd = (insn >> 16) & 0xf;\r\nint rn = (insn >> 12) & 0xf;\r\nint rm = insn & 0xf;\r\nint rs = (insn >> 8) & 0xf;\r\nregister unsigned long rdv asm("r2") = regs->uregs[rd];\r\nregister unsigned long rnv asm("r0") = regs->uregs[rn];\r\nregister unsigned long rmv asm("r3") = regs->uregs[rm];\r\nregister unsigned long rsv asm("r1") = regs->uregs[rs];\r\nunsigned long cpsr = regs->ARM_cpsr;\r\n__asm__ __volatile__ (\r\n"msr cpsr_fs, %[cpsr] \n\t"\r\nBLX("%[fn]")\r\n"mrs %[cpsr], cpsr \n\t"\r\n: "=r" (rdv), [cpsr] "=r" (cpsr)\r\n: "0" (rdv), "r" (rnv), "r" (rmv), "r" (rsv),\r\n"1" (cpsr), [fn] "r" (p->ainsn.insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nregs->uregs[rd] = rdv;\r\nregs->ARM_cpsr = (regs->ARM_cpsr & ~APSR_MASK) | (cpsr & APSR_MASK);\r\n}\r\nstatic void __kprobes\r\nemulate_rd12rm0_noflags_nopc(struct kprobe *p, struct pt_regs *regs)\r\n{\r\nkprobe_opcode_t insn = p->opcode;\r\nint rd = (insn >> 12) & 0xf;\r\nint rm = insn & 0xf;\r\nregister unsigned long rdv asm("r0") = regs->uregs[rd];\r\nregister unsigned long rmv asm("r3") = regs->uregs[rm];\r\n__asm__ __volatile__ (\r\nBLX("%[fn]")\r\n: "=r" (rdv)\r\n: "0" (rdv), "r" (rmv), [fn] "r" (p->ainsn.insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nregs->uregs[rd] = rdv;\r\n}\r\nstatic void __kprobes\r\nemulate_rdlo12rdhi16rn0rm8_rwflags_nopc(struct kprobe *p, struct pt_regs *regs)\r\n{\r\nkprobe_opcode_t insn = p->opcode;\r\nint rdlo = (insn >> 12) & 0xf;\r\nint rdhi = (insn >> 16) & 0xf;\r\nint rn = insn & 0xf;\r\nint rm = (insn >> 8) & 0xf;\r\nregister unsigned long rdlov asm("r0") = regs->uregs[rdlo];\r\nregister unsigned long rdhiv asm("r2") = regs->uregs[rdhi];\r\nregister unsigned long rnv asm("r3") = regs->uregs[rn];\r\nregister unsigned long rmv asm("r1") = regs->uregs[rm];\r\nunsigned long cpsr = regs->ARM_cpsr;\r\n__asm__ __volatile__ (\r\n"msr cpsr_fs, %[cpsr] \n\t"\r\nBLX("%[fn]")\r\n"mrs %[cpsr], cpsr \n\t"\r\n: "=r" (rdlov), "=r" (rdhiv), [cpsr] "=r" (cpsr)\r\n: "0" (rdlov), "1" (rdhiv), "r" (rnv), "r" (rmv),\r\n"2" (cpsr), [fn] "r" (p->ainsn.insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nregs->uregs[rdlo] = rdlov;\r\nregs->uregs[rdhi] = rdhiv;\r\nregs->ARM_cpsr = (regs->ARM_cpsr & ~APSR_MASK) | (cpsr & APSR_MASK);\r\n}\r\nstatic void __kprobes arm_singlestep(struct kprobe *p, struct pt_regs *regs)\r\n{\r\nregs->ARM_pc += 4;\r\np->ainsn.insn_handler(p, regs);\r\n}\r\nenum kprobe_insn __kprobes\r\narm_kprobe_decode_insn(kprobe_opcode_t insn, struct arch_specific_insn *asi)\r\n{\r\nasi->insn_singlestep = arm_singlestep;\r\nasi->insn_check_cc = kprobe_condition_checks[insn>>28];\r\nreturn kprobe_decode_insn(insn, asi, kprobe_decode_arm_table, false);\r\n}

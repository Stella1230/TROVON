static void reg_write(struct ak4117 *ak4117, unsigned char reg, unsigned char val)\r\n{\r\nak4117->write(ak4117->private_data, reg, val);\r\nif (reg < sizeof(ak4117->regmap))\r\nak4117->regmap[reg] = val;\r\n}\r\nstatic inline unsigned char reg_read(struct ak4117 *ak4117, unsigned char reg)\r\n{\r\nreturn ak4117->read(ak4117->private_data, reg);\r\n}\r\nstatic void snd_ak4117_free(struct ak4117 *chip)\r\n{\r\ndel_timer(&chip->timer);\r\nkfree(chip);\r\n}\r\nstatic int snd_ak4117_dev_free(struct snd_device *device)\r\n{\r\nstruct ak4117 *chip = device->device_data;\r\nsnd_ak4117_free(chip);\r\nreturn 0;\r\n}\r\nint snd_ak4117_create(struct snd_card *card, ak4117_read_t *read, ak4117_write_t *write,\r\nconst unsigned char pgm[5], void *private_data, struct ak4117 **r_ak4117)\r\n{\r\nstruct ak4117 *chip;\r\nint err = 0;\r\nunsigned char reg;\r\nstatic struct snd_device_ops ops = {\r\n.dev_free = snd_ak4117_dev_free,\r\n};\r\nchip = kzalloc(sizeof(*chip), GFP_KERNEL);\r\nif (chip == NULL)\r\nreturn -ENOMEM;\r\nspin_lock_init(&chip->lock);\r\nchip->card = card;\r\nchip->read = read;\r\nchip->write = write;\r\nchip->private_data = private_data;\r\ninit_timer(&chip->timer);\r\nchip->timer.data = (unsigned long)chip;\r\nchip->timer.function = snd_ak4117_timer;\r\nfor (reg = 0; reg < 5; reg++)\r\nchip->regmap[reg] = pgm[reg];\r\nsnd_ak4117_reinit(chip);\r\nchip->rcs0 = reg_read(chip, AK4117_REG_RCS0) & ~(AK4117_QINT | AK4117_CINT | AK4117_STC);\r\nchip->rcs1 = reg_read(chip, AK4117_REG_RCS1);\r\nchip->rcs2 = reg_read(chip, AK4117_REG_RCS2);\r\nif ((err = snd_device_new(card, SNDRV_DEV_CODEC, chip, &ops)) < 0)\r\ngoto __fail;\r\nif (r_ak4117)\r\n*r_ak4117 = chip;\r\nreturn 0;\r\n__fail:\r\nsnd_ak4117_free(chip);\r\nreturn err < 0 ? err : -EIO;\r\n}\r\nvoid snd_ak4117_reg_write(struct ak4117 *chip, unsigned char reg, unsigned char mask, unsigned char val)\r\n{\r\nif (reg >= 5)\r\nreturn;\r\nreg_write(chip, reg, (chip->regmap[reg] & ~mask) | val);\r\n}\r\nvoid snd_ak4117_reinit(struct ak4117 *chip)\r\n{\r\nunsigned char old = chip->regmap[AK4117_REG_PWRDN], reg;\r\ndel_timer(&chip->timer);\r\nchip->init = 1;\r\nreg_write(chip, AK4117_REG_PWRDN, 0);\r\nudelay(200);\r\nreg_write(chip, AK4117_REG_PWRDN, (old | AK4117_RST) & ~AK4117_PWN);\r\nudelay(200);\r\nfor (reg = 1; reg < 5; reg++)\r\nreg_write(chip, reg, chip->regmap[reg]);\r\nreg_write(chip, AK4117_REG_PWRDN, old | AK4117_RST | AK4117_PWN);\r\nchip->init = 0;\r\nchip->timer.expires = 1 + jiffies;\r\nadd_timer(&chip->timer);\r\n}\r\nstatic unsigned int external_rate(unsigned char rcs1)\r\n{\r\nswitch (rcs1 & (AK4117_FS0|AK4117_FS1|AK4117_FS2|AK4117_FS3)) {\r\ncase AK4117_FS_32000HZ: return 32000;\r\ncase AK4117_FS_44100HZ: return 44100;\r\ncase AK4117_FS_48000HZ: return 48000;\r\ncase AK4117_FS_88200HZ: return 88200;\r\ncase AK4117_FS_96000HZ: return 96000;\r\ncase AK4117_FS_176400HZ: return 176400;\r\ncase AK4117_FS_192000HZ: return 192000;\r\ndefault: return 0;\r\n}\r\n}\r\nstatic int snd_ak4117_in_error_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 1;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = LONG_MAX;\r\nreturn 0;\r\n}\r\nstatic int snd_ak4117_in_error_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct ak4117 *chip = snd_kcontrol_chip(kcontrol);\r\nlong *ptr;\r\nspin_lock_irq(&chip->lock);\r\nptr = (long *)(((char *)chip) + kcontrol->private_value);\r\nucontrol->value.integer.value[0] = *ptr;\r\n*ptr = 0;\r\nspin_unlock_irq(&chip->lock);\r\nreturn 0;\r\n}\r\nstatic int snd_ak4117_in_bit_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct ak4117 *chip = snd_kcontrol_chip(kcontrol);\r\nunsigned char reg = kcontrol->private_value & 0xff;\r\nunsigned char bit = (kcontrol->private_value >> 8) & 0xff;\r\nunsigned char inv = (kcontrol->private_value >> 31) & 1;\r\nucontrol->value.integer.value[0] = ((reg_read(chip, reg) & (1 << bit)) ? 1 : 0) ^ inv;\r\nreturn 0;\r\n}\r\nstatic int snd_ak4117_rx_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 1;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 1;\r\nreturn 0;\r\n}\r\nstatic int snd_ak4117_rx_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct ak4117 *chip = snd_kcontrol_chip(kcontrol);\r\nucontrol->value.integer.value[0] = (chip->regmap[AK4117_REG_IO] & AK4117_IPS) ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic int snd_ak4117_rx_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct ak4117 *chip = snd_kcontrol_chip(kcontrol);\r\nint change;\r\nu8 old_val;\r\nspin_lock_irq(&chip->lock);\r\nold_val = chip->regmap[AK4117_REG_IO];\r\nchange = !!ucontrol->value.integer.value[0] != ((old_val & AK4117_IPS) ? 1 : 0);\r\nif (change)\r\nreg_write(chip, AK4117_REG_IO, (old_val & ~AK4117_IPS) | (ucontrol->value.integer.value[0] ? AK4117_IPS : 0));\r\nspin_unlock_irq(&chip->lock);\r\nreturn change;\r\n}\r\nstatic int snd_ak4117_rate_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 1;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 192000;\r\nreturn 0;\r\n}\r\nstatic int snd_ak4117_rate_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct ak4117 *chip = snd_kcontrol_chip(kcontrol);\r\nucontrol->value.integer.value[0] = external_rate(reg_read(chip, AK4117_REG_RCS1));\r\nreturn 0;\r\n}\r\nstatic int snd_ak4117_spdif_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_IEC958;\r\nuinfo->count = 1;\r\nreturn 0;\r\n}\r\nstatic int snd_ak4117_spdif_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct ak4117 *chip = snd_kcontrol_chip(kcontrol);\r\nunsigned i;\r\nfor (i = 0; i < AK4117_REG_RXCSB_SIZE; i++)\r\nucontrol->value.iec958.status[i] = reg_read(chip, AK4117_REG_RXCSB0 + i);\r\nreturn 0;\r\n}\r\nstatic int snd_ak4117_spdif_mask_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_IEC958;\r\nuinfo->count = 1;\r\nreturn 0;\r\n}\r\nstatic int snd_ak4117_spdif_mask_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nmemset(ucontrol->value.iec958.status, 0xff, AK4117_REG_RXCSB_SIZE);\r\nreturn 0;\r\n}\r\nstatic int snd_ak4117_spdif_pinfo(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 0xffff;\r\nuinfo->count = 4;\r\nreturn 0;\r\n}\r\nstatic int snd_ak4117_spdif_pget(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct ak4117 *chip = snd_kcontrol_chip(kcontrol);\r\nunsigned short tmp;\r\nucontrol->value.integer.value[0] = 0xf8f2;\r\nucontrol->value.integer.value[1] = 0x4e1f;\r\ntmp = reg_read(chip, AK4117_REG_Pc0) | (reg_read(chip, AK4117_REG_Pc1) << 8);\r\nucontrol->value.integer.value[2] = tmp;\r\ntmp = reg_read(chip, AK4117_REG_Pd0) | (reg_read(chip, AK4117_REG_Pd1) << 8);\r\nucontrol->value.integer.value[3] = tmp;\r\nreturn 0;\r\n}\r\nstatic int snd_ak4117_spdif_qinfo(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_BYTES;\r\nuinfo->count = AK4117_REG_QSUB_SIZE;\r\nreturn 0;\r\n}\r\nstatic int snd_ak4117_spdif_qget(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct ak4117 *chip = snd_kcontrol_chip(kcontrol);\r\nunsigned i;\r\nfor (i = 0; i < AK4117_REG_QSUB_SIZE; i++)\r\nucontrol->value.bytes.data[i] = reg_read(chip, AK4117_REG_QSUB_ADDR + i);\r\nreturn 0;\r\n}\r\nint snd_ak4117_build(struct ak4117 *ak4117, struct snd_pcm_substream *cap_substream)\r\n{\r\nstruct snd_kcontrol *kctl;\r\nunsigned int idx;\r\nint err;\r\nif (snd_BUG_ON(!cap_substream))\r\nreturn -EINVAL;\r\nak4117->substream = cap_substream;\r\nfor (idx = 0; idx < AK4117_CONTROLS; idx++) {\r\nkctl = snd_ctl_new1(&snd_ak4117_iec958_controls[idx], ak4117);\r\nif (kctl == NULL)\r\nreturn -ENOMEM;\r\nkctl->id.device = cap_substream->pcm->device;\r\nkctl->id.subdevice = cap_substream->number;\r\nerr = snd_ctl_add(ak4117->card, kctl);\r\nif (err < 0)\r\nreturn err;\r\nak4117->kctls[idx] = kctl;\r\n}\r\nreturn 0;\r\n}\r\nint snd_ak4117_external_rate(struct ak4117 *ak4117)\r\n{\r\nunsigned char rcs1;\r\nrcs1 = reg_read(ak4117, AK4117_REG_RCS1);\r\nreturn external_rate(rcs1);\r\n}\r\nint snd_ak4117_check_rate_and_errors(struct ak4117 *ak4117, unsigned int flags)\r\n{\r\nstruct snd_pcm_runtime *runtime = ak4117->substream ? ak4117->substream->runtime : NULL;\r\nunsigned long _flags;\r\nint res = 0;\r\nunsigned char rcs0, rcs1, rcs2;\r\nunsigned char c0, c1;\r\nrcs1 = reg_read(ak4117, AK4117_REG_RCS1);\r\nif (flags & AK4117_CHECK_NO_STAT)\r\ngoto __rate;\r\nrcs0 = reg_read(ak4117, AK4117_REG_RCS0);\r\nrcs2 = reg_read(ak4117, AK4117_REG_RCS2);\r\nspin_lock_irqsave(&ak4117->lock, _flags);\r\nif (rcs0 & AK4117_PAR)\r\nak4117->parity_errors++;\r\nif (rcs0 & AK4117_V)\r\nak4117->v_bit_errors++;\r\nif (rcs2 & AK4117_CCRC)\r\nak4117->ccrc_errors++;\r\nif (rcs2 & AK4117_QCRC)\r\nak4117->qcrc_errors++;\r\nc0 = (ak4117->rcs0 & (AK4117_QINT | AK4117_CINT | AK4117_STC | AK4117_AUDION | AK4117_AUTO | AK4117_UNLCK)) ^\r\n(rcs0 & (AK4117_QINT | AK4117_CINT | AK4117_STC | AK4117_AUDION | AK4117_AUTO | AK4117_UNLCK));\r\nc1 = (ak4117->rcs1 & (AK4117_DTSCD | AK4117_NPCM | AK4117_PEM | 0x0f)) ^\r\n(rcs1 & (AK4117_DTSCD | AK4117_NPCM | AK4117_PEM | 0x0f));\r\nak4117->rcs0 = rcs0 & ~(AK4117_QINT | AK4117_CINT | AK4117_STC);\r\nak4117->rcs1 = rcs1;\r\nak4117->rcs2 = rcs2;\r\nspin_unlock_irqrestore(&ak4117->lock, _flags);\r\nif (rcs0 & AK4117_PAR)\r\nsnd_ctl_notify(ak4117->card, SNDRV_CTL_EVENT_MASK_VALUE, &ak4117->kctls[0]->id);\r\nif (rcs0 & AK4117_V)\r\nsnd_ctl_notify(ak4117->card, SNDRV_CTL_EVENT_MASK_VALUE, &ak4117->kctls[1]->id);\r\nif (rcs2 & AK4117_CCRC)\r\nsnd_ctl_notify(ak4117->card, SNDRV_CTL_EVENT_MASK_VALUE, &ak4117->kctls[2]->id);\r\nif (rcs2 & AK4117_QCRC)\r\nsnd_ctl_notify(ak4117->card, SNDRV_CTL_EVENT_MASK_VALUE, &ak4117->kctls[3]->id);\r\nif (c1 & 0x0f)\r\nsnd_ctl_notify(ak4117->card, SNDRV_CTL_EVENT_MASK_VALUE, &ak4117->kctls[4]->id);\r\nif ((c1 & AK4117_PEM) | (c0 & AK4117_CINT))\r\nsnd_ctl_notify(ak4117->card, SNDRV_CTL_EVENT_MASK_VALUE, &ak4117->kctls[6]->id);\r\nif (c0 & AK4117_QINT)\r\nsnd_ctl_notify(ak4117->card, SNDRV_CTL_EVENT_MASK_VALUE, &ak4117->kctls[8]->id);\r\nif (c0 & AK4117_AUDION)\r\nsnd_ctl_notify(ak4117->card, SNDRV_CTL_EVENT_MASK_VALUE, &ak4117->kctls[9]->id);\r\nif (c1 & AK4117_NPCM)\r\nsnd_ctl_notify(ak4117->card, SNDRV_CTL_EVENT_MASK_VALUE, &ak4117->kctls[10]->id);\r\nif (c1 & AK4117_DTSCD)\r\nsnd_ctl_notify(ak4117->card, SNDRV_CTL_EVENT_MASK_VALUE, &ak4117->kctls[11]->id);\r\nif (ak4117->change_callback && (c0 | c1) != 0)\r\nak4117->change_callback(ak4117, c0, c1);\r\n__rate:\r\nres = external_rate(rcs1);\r\nif (!(flags & AK4117_CHECK_NO_RATE) && runtime && runtime->rate != res) {\r\nsnd_pcm_stream_lock_irqsave(ak4117->substream, _flags);\r\nif (snd_pcm_running(ak4117->substream)) {\r\nsnd_pcm_stop(ak4117->substream, SNDRV_PCM_STATE_DRAINING);\r\nwake_up(&runtime->sleep);\r\nres = 1;\r\n}\r\nsnd_pcm_stream_unlock_irqrestore(ak4117->substream, _flags);\r\n}\r\nreturn res;\r\n}\r\nstatic void snd_ak4117_timer(unsigned long data)\r\n{\r\nstruct ak4117 *chip = (struct ak4117 *)data;\r\nif (chip->init)\r\nreturn;\r\nsnd_ak4117_check_rate_and_errors(chip, 0);\r\nchip->timer.expires = 1 + jiffies;\r\nadd_timer(&chip->timer);\r\n}

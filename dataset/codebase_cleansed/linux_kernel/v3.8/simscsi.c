static int __init\r\nsimscsi_setup (char *s)\r\n{\r\nif (strlen(s) > MAX_ROOT_LEN) {\r\nprintk(KERN_ERR "simscsi_setup: prefix too long---using default %s\n",\r\nsimscsi_root);\r\n}\r\nsimscsi_root = s;\r\nreturn 1;\r\n}\r\nstatic void\r\nsimscsi_interrupt (unsigned long val)\r\n{\r\nstruct scsi_cmnd *sc;\r\nwhile ((sc = queue[rd].sc) != NULL) {\r\natomic_dec(&num_reqs);\r\nqueue[rd].sc = NULL;\r\nif (DBG)\r\nprintk("simscsi_interrupt: done with %ld\n", sc->serial_number);\r\n(*sc->scsi_done)(sc);\r\nrd = (rd + 1) % SIMSCSI_REQ_QUEUE_LEN;\r\n}\r\n}\r\nstatic int\r\nsimscsi_biosparam (struct scsi_device *sdev, struct block_device *n,\r\nsector_t capacity, int ip[])\r\n{\r\nip[0] = 64;\r\nip[1] = 32;\r\nip[2] = capacity >> 11;\r\nreturn 0;\r\n}\r\nstatic void\r\nsimscsi_sg_readwrite (struct scsi_cmnd *sc, int mode, unsigned long offset)\r\n{\r\nint i;\r\nstruct scatterlist *sl;\r\nstruct disk_stat stat;\r\nstruct disk_req req;\r\nstat.fd = desc[sc->device->id];\r\nscsi_for_each_sg(sc, sl, scsi_sg_count(sc), i) {\r\nreq.addr = __pa(sg_virt(sl));\r\nreq.len = sl->length;\r\nif (DBG)\r\nprintk("simscsi_sg_%s @ %lx (off %lx) use_sg=%d len=%d\n",\r\nmode == SSC_READ ? "read":"write", req.addr, offset,\r\nscsi_sg_count(sc) - i, sl->length);\r\nia64_ssc(stat.fd, 1, __pa(&req), offset, mode);\r\nia64_ssc(__pa(&stat), 0, 0, 0, SSC_WAIT_COMPLETION);\r\nif (stat.count != req.len) {\r\nsc->result = DID_ERROR << 16;\r\nreturn;\r\n}\r\noffset += sl->length;\r\n}\r\nsc->result = GOOD;\r\n}\r\nstatic void\r\nsimscsi_readwrite6 (struct scsi_cmnd *sc, int mode)\r\n{\r\nunsigned long offset;\r\noffset = (((sc->cmnd[1] & 0x1f) << 16) | (sc->cmnd[2] << 8) | sc->cmnd[3])*512;\r\nsimscsi_sg_readwrite(sc, mode, offset);\r\n}\r\nstatic size_t\r\nsimscsi_get_disk_size (int fd)\r\n{\r\nstruct disk_stat stat;\r\nsize_t bit, sectors = 0;\r\nstruct disk_req req;\r\nchar buf[512];\r\nfor (bit = (128UL << 30)/512; bit != 0; bit >>= 1) {\r\nreq.addr = __pa(&buf);\r\nreq.len = sizeof(buf);\r\nia64_ssc(fd, 1, __pa(&req), ((sectors | bit) - 1)*512, SSC_READ);\r\nstat.fd = fd;\r\nia64_ssc(__pa(&stat), 0, 0, 0, SSC_WAIT_COMPLETION);\r\nif (stat.count == sizeof(buf))\r\nsectors |= bit;\r\n}\r\nreturn sectors - 1;\r\n}\r\nstatic void\r\nsimscsi_readwrite10 (struct scsi_cmnd *sc, int mode)\r\n{\r\nunsigned long offset;\r\noffset = (((unsigned long)sc->cmnd[2] << 24)\r\n| ((unsigned long)sc->cmnd[3] << 16)\r\n| ((unsigned long)sc->cmnd[4] << 8)\r\n| ((unsigned long)sc->cmnd[5] << 0))*512UL;\r\nsimscsi_sg_readwrite(sc, mode, offset);\r\n}\r\nstatic int\r\nsimscsi_queuecommand_lck (struct scsi_cmnd *sc, void (*done)(struct scsi_cmnd *))\r\n{\r\nunsigned int target_id = sc->device->id;\r\nchar fname[MAX_ROOT_LEN+16];\r\nsize_t disk_size;\r\nchar *buf;\r\nchar localbuf[36];\r\n#if DEBUG_SIMSCSI\r\nregister long sp asm ("sp");\r\nif (DBG)\r\nprintk("simscsi_queuecommand: target=%d,cmnd=%u,sc=%lu,sp=%lx,done=%p\n",\r\ntarget_id, sc->cmnd[0], sc->serial_number, sp, done);\r\n#endif\r\nsc->result = DID_BAD_TARGET << 16;\r\nsc->scsi_done = done;\r\nif (target_id <= 15 && sc->device->lun == 0) {\r\nswitch (sc->cmnd[0]) {\r\ncase INQUIRY:\r\nif (scsi_bufflen(sc) < 35) {\r\nbreak;\r\n}\r\nsprintf (fname, "%s%c", simscsi_root, 'a' + target_id);\r\ndesc[target_id] = ia64_ssc(__pa(fname), SSC_READ_ACCESS|SSC_WRITE_ACCESS,\r\n0, 0, SSC_OPEN);\r\nif (desc[target_id] < 0) {\r\nbreak;\r\n}\r\nbuf = localbuf;\r\nbuf[0] = 0;\r\nbuf[1] = 0;\r\nbuf[2] = 2;\r\nbuf[3] = 2;\r\nbuf[4] = 31;\r\nbuf[5] = 0;\r\nbuf[6] = 0;\r\nbuf[7] = 0;\r\nmemcpy(buf + 8, "HP SIMULATED DISK 0.00", 28);\r\nscsi_sg_copy_from_buffer(sc, buf, 36);\r\nsc->result = GOOD;\r\nbreak;\r\ncase TEST_UNIT_READY:\r\nsc->result = GOOD;\r\nbreak;\r\ncase READ_6:\r\nif (desc[target_id] < 0 )\r\nbreak;\r\nsimscsi_readwrite6(sc, SSC_READ);\r\nbreak;\r\ncase READ_10:\r\nif (desc[target_id] < 0 )\r\nbreak;\r\nsimscsi_readwrite10(sc, SSC_READ);\r\nbreak;\r\ncase WRITE_6:\r\nif (desc[target_id] < 0)\r\nbreak;\r\nsimscsi_readwrite6(sc, SSC_WRITE);\r\nbreak;\r\ncase WRITE_10:\r\nif (desc[target_id] < 0)\r\nbreak;\r\nsimscsi_readwrite10(sc, SSC_WRITE);\r\nbreak;\r\ncase READ_CAPACITY:\r\nif (desc[target_id] < 0 || scsi_bufflen(sc) < 8) {\r\nbreak;\r\n}\r\nbuf = localbuf;\r\ndisk_size = simscsi_get_disk_size(desc[target_id]);\r\nbuf[0] = (disk_size >> 24) & 0xff;\r\nbuf[1] = (disk_size >> 16) & 0xff;\r\nbuf[2] = (disk_size >> 8) & 0xff;\r\nbuf[3] = (disk_size >> 0) & 0xff;\r\nbuf[4] = 0;\r\nbuf[5] = 0;\r\nbuf[6] = 2;\r\nbuf[7] = 0;\r\nscsi_sg_copy_from_buffer(sc, buf, 8);\r\nsc->result = GOOD;\r\nbreak;\r\ncase MODE_SENSE:\r\ncase MODE_SENSE_10:\r\nscsi_sg_copy_from_buffer(sc, (char *)empty_zero_page,\r\nPAGE_SIZE);\r\nsc->result = GOOD;\r\nbreak;\r\ncase START_STOP:\r\nprintk(KERN_ERR "START_STOP\n");\r\nbreak;\r\ndefault:\r\npanic("simscsi: unknown SCSI command %u\n", sc->cmnd[0]);\r\n}\r\n}\r\nif (sc->result == DID_BAD_TARGET) {\r\nsc->result |= DRIVER_SENSE << 24;\r\nsc->sense_buffer[0] = 0x70;\r\nsc->sense_buffer[2] = 0x00;\r\n}\r\nif (atomic_read(&num_reqs) >= SIMSCSI_REQ_QUEUE_LEN) {\r\npanic("Attempt to queue command while command is pending!!");\r\n}\r\natomic_inc(&num_reqs);\r\nqueue[wr].sc = sc;\r\nwr = (wr + 1) % SIMSCSI_REQ_QUEUE_LEN;\r\ntasklet_schedule(&simscsi_tasklet);\r\nreturn 0;\r\n}\r\nstatic int __init\r\nsimscsi_init(void)\r\n{\r\nint error;\r\nhost = scsi_host_alloc(&driver_template, 0);\r\nif (!host)\r\nreturn -ENOMEM;\r\nerror = scsi_add_host(host, NULL);\r\nif (error)\r\ngoto free_host;\r\nscsi_scan_host(host);\r\nreturn 0;\r\nfree_host:\r\nscsi_host_put(host);\r\nreturn error;\r\n}\r\nstatic void __exit\r\nsimscsi_exit(void)\r\n{\r\nscsi_remove_host(host);\r\nscsi_host_put(host);\r\n}

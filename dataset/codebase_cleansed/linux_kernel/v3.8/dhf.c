int\r\ncheck_comp_fw(memimage *fw)\r\n{\r\nCFG_RANGE20_STRCT *p;\r\nint rc = HCF_SUCCESS;\r\nCFG_RANGE_SPEC_STRCT *i;\r\nswitch (fw->identity->typ) {\r\ncase CFG_FW_IDENTITY:\r\ncase COMP_ID_FW_AP_FAKE:\r\nbreak;\r\ndefault:\r\nMMDASSERT(DO_ASSERT, fw->identity->typ)\r\nrc = DHF_ERR_INCOMP_FW;\r\nreturn rc;\r\n}\r\np = fw->compat;\r\ni = NULL;\r\nwhile (p->len && i == NULL) {\r\nif (p->typ == CFG_MFI_ACT_RANGES_STA) {\r\ni = mmd_check_comp((void *)p, &mfi_sup);\r\n}\r\np++;\r\n}\r\nMMDASSERT(i, 0)\r\nif (i) {\r\np = fw->compat;\r\ni = NULL;\r\nwhile (p->len && i == NULL) {\r\nif (p->typ == CFG_CFI_ACT_RANGES_STA) {\r\ni = mmd_check_comp((void *)p, &cfi_sup);\r\n}\r\np++;\r\n}\r\nMMDASSERT(i, 0)\r\n}\r\nif (i == NULL) {\r\nrc = DHF_ERR_INCOMP_FW;\r\n}\r\nreturn rc;\r\n}\r\nint\r\ndhf_download_binary(memimage *fw)\r\n{\r\nint rc = HCF_SUCCESS;\r\nCFG_PROG_STRCT *p;\r\nint i;\r\nfor (i = 0; i < sizeof(signature) && fw->signature[i] == signature[i]; i++)\r\n;\r\nif (i != sizeof(signature) ||\r\nfw->signature[i] != 0x01 ||\r\nfw->signature[i+1] != ( 'L'))\r\nrc = DHF_ERR_INCOMP_FW;\r\nelse {\r\nfw->codep = (CFG_PROG_STRCT FAR*)((char *)fw->codep + (hcf_32)fw);\r\nfw->identity = (CFG_IDENTITY_STRCT FAR*)((char *)fw->identity + (hcf_32)fw);\r\nfw->compat = (CFG_RANGE20_STRCT FAR*)((char *)fw->compat + (hcf_32)fw);\r\nfor (i = 0; fw->p[i]; i++)\r\nfw->p[i] = ((char *)fw->p[i] + (hcf_32)fw);\r\np = fw->codep;\r\nwhile (p->len) {\r\np->host_addr = (char *)p->host_addr + (hcf_32)fw;\r\np++;\r\n}\r\n}\r\nreturn rc;\r\n}\r\nint\r\ndhf_download_fw(void *ifbp, memimage *fw)\r\n{\r\nint rc = HCF_SUCCESS;\r\nLTV_INFO_STRUCT_PTR pp = ltv_info;\r\nCFG_PROG_STRCT *p = fw->codep;\r\nLTVP ltvp;\r\nint i;\r\nMMDASSERT(fw != NULL, 0)\r\nfor (i = 0; i < sizeof(signature) && fw->signature[i] == signature[i]; i++)\r\n;\r\nif (i != sizeof(signature) ||\r\nfw->signature[i] != 0x01 ||\r\n(fw->signature[i+1] != 'C' && fw->signature[i+1] != ( 'L')))\r\nrc = DHF_ERR_INCOMP_FW;\r\nwhile ((rc == HCF_SUCCESS) && ((ltvp = pp->ltvp) != NULL)) {\r\nltvp->len = pp++->len;\r\nrc = GET_INFO(ltvp);\r\nMMDASSERT(rc == HCF_SUCCESS, rc)\r\nMMDASSERT(rc == HCF_SUCCESS, ltvp->typ)\r\nMMDASSERT(rc == HCF_SUCCESS, ltvp->len)\r\n}\r\nif (rc == HCF_SUCCESS)\r\nrc = check_comp_fw(fw);\r\nif (rc == HCF_SUCCESS) {\r\nwhile (rc == HCF_SUCCESS && p->len) {\r\nrc = PUT_INFO(p);\r\np++;\r\n}\r\n}\r\nMMDASSERT(rc == HCF_SUCCESS, rc)\r\nreturn rc;\r\n}

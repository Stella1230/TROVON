BOOL WCTLbIsDuplicate (PSCache pCache, PS802_11Header pMACHeader)\r\n{\r\nunsigned int uIndex;\r\nunsigned int ii;\r\nPSCacheEntry pCacheEntry;\r\nif (IS_FC_RETRY(pMACHeader)) {\r\nuIndex = pCache->uInPtr;\r\nfor (ii = 0; ii < DUPLICATE_RX_CACHE_LENGTH; ii++) {\r\npCacheEntry = &(pCache->asCacheEntry[uIndex]);\r\nif ((pCacheEntry->wFmSequence == pMACHeader->wSeqCtl) &&\r\n(!compare_ether_addr(&(pCacheEntry->abyAddr2[0]),\r\n&(pMACHeader->abyAddr2[0]))) &&\r\n(LOBYTE(pCacheEntry->wFrameCtl) == LOBYTE(pMACHeader->wFrameCtl))\r\n) {\r\nreturn TRUE;\r\n}\r\nADD_ONE_WITH_WRAP_AROUND(uIndex, DUPLICATE_RX_CACHE_LENGTH);\r\n}\r\n}\r\npCacheEntry = &pCache->asCacheEntry[pCache->uInPtr];\r\npCacheEntry->wFmSequence = pMACHeader->wSeqCtl;\r\nmemcpy(&(pCacheEntry->abyAddr2[0]), &(pMACHeader->abyAddr2[0]), ETH_ALEN);\r\npCacheEntry->wFrameCtl = pMACHeader->wFrameCtl;\r\nADD_ONE_WITH_WRAP_AROUND(pCache->uInPtr, DUPLICATE_RX_CACHE_LENGTH);\r\nreturn FALSE;\r\n}\r\nunsigned int WCTLuSearchDFCB(PSDevice pDevice, PS802_11Header pMACHeader)\r\n{\r\nunsigned int ii;\r\nfor (ii = 0; ii < pDevice->cbDFCB; ii++) {\r\nif ((pDevice->sRxDFCB[ii].bInUse == TRUE) &&\r\n(!compare_ether_addr(&(pDevice->sRxDFCB[ii].abyAddr2[0]),\r\n&(pMACHeader->abyAddr2[0])))) {\r\nreturn ii;\r\n}\r\n}\r\nreturn pDevice->cbDFCB;\r\n}\r\nunsigned int WCTLuInsertDFCB(PSDevice pDevice, PS802_11Header pMACHeader)\r\n{\r\nunsigned int ii;\r\nif (pDevice->cbFreeDFCB == 0)\r\nreturn(pDevice->cbDFCB);\r\nfor (ii = 0; ii < pDevice->cbDFCB; ii++) {\r\nif (pDevice->sRxDFCB[ii].bInUse == FALSE) {\r\npDevice->cbFreeDFCB--;\r\npDevice->sRxDFCB[ii].uLifetime = pDevice->dwMaxReceiveLifetime;\r\npDevice->sRxDFCB[ii].bInUse = TRUE;\r\npDevice->sRxDFCB[ii].wSequence = (pMACHeader->wSeqCtl >> 4);\r\npDevice->sRxDFCB[ii].wFragNum = (pMACHeader->wSeqCtl & 0x000F);\r\nmemcpy(&(pDevice->sRxDFCB[ii].abyAddr2[0]),\r\n&(pMACHeader->abyAddr2[0]),\r\nETH_ALEN);\r\nreturn(ii);\r\n}\r\n}\r\nreturn(pDevice->cbDFCB);\r\n}\r\nBOOL WCTLbHandleFragment(PSDevice pDevice, PS802_11Header pMACHeader,\r\nunsigned int cbFrameLength, BOOL bWEP, BOOL bExtIV)\r\n{\r\nunsigned int uHeaderSize;\r\nif (bWEP == TRUE) {\r\nuHeaderSize = 28;\r\nif (bExtIV)\r\nuHeaderSize +=4;\r\n}\r\nelse {\r\nuHeaderSize = 24;\r\n}\r\nif (IS_FIRST_FRAGMENT_PKT(pMACHeader)) {\r\npDevice->uCurrentDFCBIdx = WCTLuSearchDFCB(pDevice, pMACHeader);\r\nif (pDevice->uCurrentDFCBIdx < pDevice->cbDFCB) {\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].uLifetime = pDevice->dwMaxReceiveLifetime;\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].wSequence = (pMACHeader->wSeqCtl >> 4);\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].wFragNum = (pMACHeader->wSeqCtl & 0x000F);\r\n}\r\nelse {\r\npDevice->uCurrentDFCBIdx = WCTLuInsertDFCB(pDevice, pMACHeader);\r\nif (pDevice->uCurrentDFCBIdx == pDevice->cbDFCB) {\r\nreturn(FALSE);\r\n}\r\n}\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].pbyRxBuffer = (PBYTE) (pDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].skb->data + 8);\r\nmemcpy(pDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].pbyRxBuffer, pMACHeader, cbFrameLength);\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].cbFrameLength = cbFrameLength;\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].pbyRxBuffer += cbFrameLength;\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].wFragNum++;\r\nreturn(FALSE);\r\n}\r\nelse {\r\npDevice->uCurrentDFCBIdx = WCTLuSearchDFCB(pDevice, pMACHeader);\r\nif (pDevice->uCurrentDFCBIdx != pDevice->cbDFCB) {\r\nif ((pDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].wSequence == (pMACHeader->wSeqCtl >> 4)) &&\r\n(pDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].wFragNum == (pMACHeader->wSeqCtl & 0x000F)) &&\r\n((pDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].cbFrameLength + cbFrameLength - uHeaderSize) < 2346)) {\r\nmemcpy(pDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].pbyRxBuffer, ((PBYTE) (pMACHeader) + uHeaderSize), (cbFrameLength - uHeaderSize));\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].cbFrameLength += (cbFrameLength - uHeaderSize);\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].pbyRxBuffer += (cbFrameLength - uHeaderSize);\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].wFragNum++;\r\n}\r\nelse {\r\npDevice->cbFreeDFCB++;\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].bInUse = FALSE;\r\nreturn(FALSE);\r\n}\r\n}\r\nelse {\r\nreturn(FALSE);\r\n}\r\nif (IS_LAST_FRAGMENT_PKT(pMACHeader)) {\r\npDevice->cbFreeDFCB++;\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].bInUse = FALSE;\r\nreturn(TRUE);\r\n}\r\nreturn(FALSE);\r\n}\r\n}

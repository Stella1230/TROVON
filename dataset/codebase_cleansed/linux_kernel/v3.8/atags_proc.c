static int\r\nread_buffer(char* page, char** start, off_t off, int count,\r\nint* eof, void* data)\r\n{\r\nstruct buffer *buffer = (struct buffer *)data;\r\nif (off >= buffer->size) {\r\n*eof = 1;\r\nreturn 0;\r\n}\r\ncount = min((int) (buffer->size - off), count);\r\nmemcpy(page, &buffer->data[off], count);\r\nreturn count;\r\n}\r\nvoid __init save_atags(const struct tag *tags)\r\n{\r\nmemcpy(atags_copy, tags, sizeof(atags_copy));\r\n}\r\nstatic int __init init_atags_procfs(void)\r\n{\r\nstruct proc_dir_entry *tags_entry;\r\nstruct tag *tag = (struct tag *)atags_copy;\r\nstruct buffer *b;\r\nsize_t size;\r\nif (tag->hdr.tag != ATAG_CORE) {\r\nprintk(KERN_INFO "No ATAGs?");\r\nreturn -EINVAL;\r\n}\r\nfor (; tag->hdr.size; tag = tag_next(tag))\r\n;\r\nsize = (char *)tag - atags_copy + sizeof(struct tag_header);\r\nWARN_ON(tag->hdr.tag != ATAG_NONE);\r\nb = kmalloc(sizeof(*b) + size, GFP_KERNEL);\r\nif (!b)\r\ngoto nomem;\r\nb->size = size;\r\nmemcpy(b->data, atags_copy, size);\r\ntags_entry = create_proc_read_entry("atags", 0400,\r\nNULL, read_buffer, b);\r\nif (!tags_entry)\r\ngoto nomem;\r\nreturn 0;\r\nnomem:\r\nkfree(b);\r\nprintk(KERN_ERR "Exporting ATAGs: not enough memory\n");\r\nreturn -ENOMEM;\r\n}

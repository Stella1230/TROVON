static int s3c24xx_dclk_enable(struct clk *clk, int enable)\r\n{\r\nunsigned long dclkcon = __raw_readl(S3C24XX_DCLKCON);\r\nif (enable)\r\ndclkcon |= clk->ctrlbit;\r\nelse\r\ndclkcon &= ~clk->ctrlbit;\r\n__raw_writel(dclkcon, S3C24XX_DCLKCON);\r\nreturn 0;\r\n}\r\nstatic int s3c24xx_dclk_setparent(struct clk *clk, struct clk *parent)\r\n{\r\nunsigned long dclkcon;\r\nunsigned int uclk;\r\nif (parent == &clk_upll)\r\nuclk = 1;\r\nelse if (parent == &clk_p)\r\nuclk = 0;\r\nelse\r\nreturn -EINVAL;\r\nclk->parent = parent;\r\ndclkcon = __raw_readl(S3C24XX_DCLKCON);\r\nif (clk->ctrlbit == S3C2410_DCLKCON_DCLK0EN) {\r\nif (uclk)\r\ndclkcon |= S3C2410_DCLKCON_DCLK0_UCLK;\r\nelse\r\ndclkcon &= ~S3C2410_DCLKCON_DCLK0_UCLK;\r\n} else {\r\nif (uclk)\r\ndclkcon |= S3C2410_DCLKCON_DCLK1_UCLK;\r\nelse\r\ndclkcon &= ~S3C2410_DCLKCON_DCLK1_UCLK;\r\n}\r\n__raw_writel(dclkcon, S3C24XX_DCLKCON);\r\nreturn 0;\r\n}\r\nstatic unsigned long s3c24xx_calc_div(struct clk *clk, unsigned long rate)\r\n{\r\nunsigned long div;\r\nif ((rate == 0) || !clk->parent)\r\nreturn 0;\r\ndiv = clk_get_rate(clk->parent) / rate;\r\nif (div < 2)\r\ndiv = 2;\r\nelse if (div > 16)\r\ndiv = 16;\r\nreturn div;\r\n}\r\nstatic unsigned long s3c24xx_round_dclk_rate(struct clk *clk,\r\nunsigned long rate)\r\n{\r\nunsigned long div = s3c24xx_calc_div(clk, rate);\r\nif (div == 0)\r\nreturn 0;\r\nreturn clk_get_rate(clk->parent) / div;\r\n}\r\nstatic int s3c24xx_set_dclk_rate(struct clk *clk, unsigned long rate)\r\n{\r\nunsigned long mask, data, div = s3c24xx_calc_div(clk, rate);\r\nif (div == 0)\r\nreturn -EINVAL;\r\nif (clk == &s3c24xx_dclk0) {\r\nmask = S3C2410_DCLKCON_DCLK0_DIV_MASK |\r\nS3C2410_DCLKCON_DCLK0_CMP_MASK;\r\ndata = S3C2410_DCLKCON_DCLK0_DIV(div) |\r\nS3C2410_DCLKCON_DCLK0_CMP((div + 1) / 2);\r\n} else if (clk == &s3c24xx_dclk1) {\r\nmask = S3C2410_DCLKCON_DCLK1_DIV_MASK |\r\nS3C2410_DCLKCON_DCLK1_CMP_MASK;\r\ndata = S3C2410_DCLKCON_DCLK1_DIV(div) |\r\nS3C2410_DCLKCON_DCLK1_CMP((div + 1) / 2);\r\n} else\r\nreturn -EINVAL;\r\nclk->rate = clk_get_rate(clk->parent) / div;\r\n__raw_writel(((__raw_readl(S3C24XX_DCLKCON) & ~mask) | data),\r\nS3C24XX_DCLKCON);\r\nreturn clk->rate;\r\n}\r\nstatic int s3c24xx_clkout_setparent(struct clk *clk, struct clk *parent)\r\n{\r\nunsigned long mask;\r\nunsigned long source;\r\nif (parent == &clk_mpll)\r\nsource = S3C2410_MISCCR_CLK0_MPLL;\r\nelse if (parent == &clk_upll)\r\nsource = S3C2410_MISCCR_CLK0_UPLL;\r\nelse if (parent == &clk_f)\r\nsource = S3C2410_MISCCR_CLK0_FCLK;\r\nelse if (parent == &clk_h)\r\nsource = S3C2410_MISCCR_CLK0_HCLK;\r\nelse if (parent == &clk_p)\r\nsource = S3C2410_MISCCR_CLK0_PCLK;\r\nelse if (clk == &s3c24xx_clkout0 && parent == &s3c24xx_dclk0)\r\nsource = S3C2410_MISCCR_CLK0_DCLK0;\r\nelse if (clk == &s3c24xx_clkout1 && parent == &s3c24xx_dclk1)\r\nsource = S3C2410_MISCCR_CLK0_DCLK0;\r\nelse\r\nreturn -EINVAL;\r\nclk->parent = parent;\r\nif (clk == &s3c24xx_clkout0)\r\nmask = S3C2410_MISCCR_CLK0_MASK;\r\nelse {\r\nsource <<= 4;\r\nmask = S3C2410_MISCCR_CLK1_MASK;\r\n}\r\ns3c2410_modify_misccr(mask, source);\r\nreturn 0;\r\n}

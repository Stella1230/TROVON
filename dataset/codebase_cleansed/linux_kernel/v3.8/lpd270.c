static void lpd270_mask_irq(struct irq_data *d)\r\n{\r\nint lpd270_irq = d->irq - LPD270_IRQ(0);\r\n__raw_writew(~(1 << lpd270_irq), LPD270_INT_STATUS);\r\nlpd270_irq_enabled &= ~(1 << lpd270_irq);\r\n__raw_writew(lpd270_irq_enabled, LPD270_INT_MASK);\r\n}\r\nstatic void lpd270_unmask_irq(struct irq_data *d)\r\n{\r\nint lpd270_irq = d->irq - LPD270_IRQ(0);\r\nlpd270_irq_enabled |= 1 << lpd270_irq;\r\n__raw_writew(lpd270_irq_enabled, LPD270_INT_MASK);\r\n}\r\nstatic void lpd270_irq_handler(unsigned int irq, struct irq_desc *desc)\r\n{\r\nunsigned long pending;\r\npending = __raw_readw(LPD270_INT_STATUS) & lpd270_irq_enabled;\r\ndo {\r\ndesc->irq_data.chip->irq_ack(&desc->irq_data);\r\nif (likely(pending)) {\r\nirq = LPD270_IRQ(0) + __ffs(pending);\r\ngeneric_handle_irq(irq);\r\npending = __raw_readw(LPD270_INT_STATUS) &\r\nlpd270_irq_enabled;\r\n}\r\n} while (pending);\r\n}\r\nstatic void __init lpd270_init_irq(void)\r\n{\r\nint irq;\r\npxa27x_init_irq();\r\n__raw_writew(0, LPD270_INT_MASK);\r\n__raw_writew(0, LPD270_INT_STATUS);\r\nfor (irq = LPD270_IRQ(2); irq <= LPD270_IRQ(4); irq++) {\r\nirq_set_chip_and_handler(irq, &lpd270_irq_chip,\r\nhandle_level_irq);\r\nset_irq_flags(irq, IRQF_VALID | IRQF_PROBE);\r\n}\r\nirq_set_chained_handler(PXA_GPIO_TO_IRQ(0), lpd270_irq_handler);\r\nirq_set_irq_type(PXA_GPIO_TO_IRQ(0), IRQ_TYPE_EDGE_FALLING);\r\n}\r\nstatic void lpd270_irq_resume(void)\r\n{\r\n__raw_writew(lpd270_irq_enabled, LPD270_INT_MASK);\r\n}\r\nstatic int __init lpd270_irq_device_init(void)\r\n{\r\nif (machine_is_logicpd_pxa270()) {\r\nregister_syscore_ops(&lpd270_irq_syscore_ops);\r\nreturn 0;\r\n}\r\nreturn -ENODEV;\r\n}\r\nstatic int __init lpd270_set_lcd(char *str)\r\n{\r\nif (!strnicmp(str, "lq057q3dc02", 11)) {\r\nlpd270_lcd_to_use = &sharp_lq057q3dc02;\r\n} else if (!strnicmp(str, "lq121s1dg31", 11)) {\r\nlpd270_lcd_to_use = &sharp_lq121s1dg31;\r\n} else if (!strnicmp(str, "lq036q1da01", 11)) {\r\nlpd270_lcd_to_use = &sharp_lq036q1da01;\r\n} else if (!strnicmp(str, "lq64d343", 8)) {\r\nlpd270_lcd_to_use = &sharp_lq64d343;\r\n} else if (!strnicmp(str, "lq10d368", 8)) {\r\nlpd270_lcd_to_use = &sharp_lq10d368;\r\n} else if (!strnicmp(str, "lq035q7db02-20", 14)) {\r\nlpd270_lcd_to_use = &sharp_lq035q7db02_20;\r\n} else {\r\nprintk(KERN_INFO "lpd270: unknown lcd panel [%s]\n", str);\r\n}\r\nreturn 1;\r\n}\r\nstatic void __init lpd270_init(void)\r\n{\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(lpd270_pin_config));\r\npxa_set_ffuart_info(NULL);\r\npxa_set_btuart_info(NULL);\r\npxa_set_stuart_info(NULL);\r\nlpd270_flash_data[0].width = (__raw_readl(BOOT_DEF) & 1) ? 2 : 4;\r\nlpd270_flash_data[1].width = 4;\r\nARB_CNTRL = ARB_CORE_PARK | 0x234;\r\nplatform_add_devices(platform_devices, ARRAY_SIZE(platform_devices));\r\npxa_set_ac97_info(NULL);\r\nif (lpd270_lcd_to_use != NULL)\r\npxa_set_fb_info(NULL, lpd270_lcd_to_use);\r\npxa_set_ohci_info(&lpd270_ohci_platform_data);\r\n}\r\nstatic void __init lpd270_map_io(void)\r\n{\r\npxa27x_map_io();\r\niotable_init(lpd270_io_desc, ARRAY_SIZE(lpd270_io_desc));\r\nPSLR |= 0x00000F04;\r\nPCFR = 0x00000066;\r\n}

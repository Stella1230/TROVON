void sync_set_event(struct sync_object *event)\r\n{\r\nspin_lock_bh(&sync_lock);\r\ncomplete(&event->comp);\r\nif (event->multi_comp)\r\ncomplete(event->multi_comp);\r\nspin_unlock_bh(&sync_lock);\r\n}\r\nint sync_wait_on_multiple_events(struct sync_object **events,\r\nunsigned count, unsigned timeout,\r\nunsigned *index)\r\n{\r\nunsigned i;\r\nint status = -EPERM;\r\nstruct completion m_comp;\r\ninit_completion(&m_comp);\r\nif (SYNC_INFINITE == timeout)\r\ntimeout = MAX_SCHEDULE_TIMEOUT;\r\nspin_lock_bh(&sync_lock);\r\nfor (i = 0; i < count; i++) {\r\nif (completion_done(&events[i]->comp)) {\r\nINIT_COMPLETION(events[i]->comp);\r\n*index = i;\r\nspin_unlock_bh(&sync_lock);\r\nstatus = 0;\r\ngoto func_end;\r\n}\r\n}\r\nfor (i = 0; i < count; i++)\r\nevents[i]->multi_comp = &m_comp;\r\nspin_unlock_bh(&sync_lock);\r\nif (!wait_for_completion_interruptible_timeout(&m_comp,\r\nmsecs_to_jiffies(timeout)))\r\nstatus = -ETIME;\r\nspin_lock_bh(&sync_lock);\r\nfor (i = 0; i < count; i++) {\r\nif (completion_done(&events[i]->comp)) {\r\nINIT_COMPLETION(events[i]->comp);\r\n*index = i;\r\nstatus = 0;\r\n}\r\nevents[i]->multi_comp = NULL;\r\n}\r\nspin_unlock_bh(&sync_lock);\r\nfunc_end:\r\nreturn status;\r\n}\r\nint dsp_notifier_event(struct notifier_block *this, unsigned long event,\r\nvoid *data)\r\n{\r\nstruct ntfy_event *ne = container_of(this, struct ntfy_event,\r\nnoti_block);\r\nif (ne->event & event)\r\nsync_set_event(&ne->sync_obj);\r\nreturn NOTIFY_OK;\r\n}

static int\r\nidtcps_route_add_entry(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu16 table, u16 route_destid, u8 route_port)\r\n{\r\nu32 result;\r\nif (route_port == RIO_INVALID_ROUTE)\r\nroute_port = CPS_DEFAULT_ROUTE;\r\nif (table == RIO_GLOBAL_TABLE) {\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nRIO_STD_RTE_CONF_DESTID_SEL_CSR, route_destid);\r\nrio_mport_read_config_32(mport, destid, hopcount,\r\nRIO_STD_RTE_CONF_PORT_SEL_CSR, &result);\r\nresult = (0xffffff00 & result) | (u32)route_port;\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nRIO_STD_RTE_CONF_PORT_SEL_CSR, result);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nidtcps_route_get_entry(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu16 table, u16 route_destid, u8 *route_port)\r\n{\r\nu32 result;\r\nif (table == RIO_GLOBAL_TABLE) {\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nRIO_STD_RTE_CONF_DESTID_SEL_CSR, route_destid);\r\nrio_mport_read_config_32(mport, destid, hopcount,\r\nRIO_STD_RTE_CONF_PORT_SEL_CSR, &result);\r\nif (CPS_DEFAULT_ROUTE == (u8)result ||\r\nCPS_NO_ROUTE == (u8)result)\r\n*route_port = RIO_INVALID_ROUTE;\r\nelse\r\n*route_port = (u8)result;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nidtcps_route_clr_table(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu16 table)\r\n{\r\nu32 i;\r\nif (table == RIO_GLOBAL_TABLE) {\r\nfor (i = 0x80000000; i <= 0x800000ff;) {\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nRIO_STD_RTE_CONF_DESTID_SEL_CSR, i);\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nRIO_STD_RTE_CONF_PORT_SEL_CSR,\r\n(CPS_DEFAULT_ROUTE << 24) |\r\n(CPS_DEFAULT_ROUTE << 16) |\r\n(CPS_DEFAULT_ROUTE << 8) | CPS_DEFAULT_ROUTE);\r\ni += 4;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nidtcps_set_domain(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu8 sw_domain)\r\n{\r\nrio_mport_write_config_32(mport, destid, hopcount,\r\nIDTCPS_RIO_DOMAIN, (u32)sw_domain);\r\nreturn 0;\r\n}\r\nstatic int\r\nidtcps_get_domain(struct rio_mport *mport, u16 destid, u8 hopcount,\r\nu8 *sw_domain)\r\n{\r\nu32 regval;\r\nrio_mport_read_config_32(mport, destid, hopcount,\r\nIDTCPS_RIO_DOMAIN, &regval);\r\n*sw_domain = (u8)(regval & 0xff);\r\nreturn 0;\r\n}\r\nstatic int idtcps_switch_init(struct rio_dev *rdev, int do_enum)\r\n{\r\npr_debug("RIO: %s for %s\n", __func__, rio_name(rdev));\r\nrdev->rswitch->add_entry = idtcps_route_add_entry;\r\nrdev->rswitch->get_entry = idtcps_route_get_entry;\r\nrdev->rswitch->clr_table = idtcps_route_clr_table;\r\nrdev->rswitch->set_domain = idtcps_set_domain;\r\nrdev->rswitch->get_domain = idtcps_get_domain;\r\nrdev->rswitch->em_init = NULL;\r\nrdev->rswitch->em_handle = NULL;\r\nif (do_enum) {\r\nrio_write_config_32(rdev,\r\nrdev->phys_efptr + RIO_PORT_LINKTO_CTL_CSR, 0x8e << 8);\r\nrio_write_config_32(rdev,\r\nRIO_STD_RTE_DEFAULT_PORT, CPS_NO_ROUTE);\r\n}\r\nreturn 0;\r\n}

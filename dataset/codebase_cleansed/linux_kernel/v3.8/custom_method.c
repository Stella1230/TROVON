static ssize_t cm_write(struct file *file, const char __user * user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstatic char *buf;\r\nstatic u32 max_size;\r\nstatic u32 uncopied_bytes;\r\nstruct acpi_table_header table;\r\nacpi_status status;\r\nif (!(*ppos)) {\r\nif (count <= sizeof(struct acpi_table_header))\r\nreturn -EINVAL;\r\nif (copy_from_user(&table, user_buf,\r\nsizeof(struct acpi_table_header)))\r\nreturn -EFAULT;\r\nuncopied_bytes = max_size = table.length;\r\nbuf = kzalloc(max_size, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\n}\r\nif (buf == NULL)\r\nreturn -EINVAL;\r\nif ((*ppos > max_size) ||\r\n(*ppos + count > max_size) ||\r\n(*ppos + count < count) ||\r\n(count > uncopied_bytes))\r\nreturn -EINVAL;\r\nif (copy_from_user(buf + (*ppos), user_buf, count)) {\r\nkfree(buf);\r\nbuf = NULL;\r\nreturn -EFAULT;\r\n}\r\nuncopied_bytes -= count;\r\n*ppos += count;\r\nif (!uncopied_bytes) {\r\nstatus = acpi_install_method(buf);\r\nkfree(buf);\r\nbuf = NULL;\r\nif (ACPI_FAILURE(status))\r\nreturn -EINVAL;\r\nadd_taint(TAINT_OVERRIDDEN_ACPI_TABLE);\r\n}\r\nreturn count;\r\n}\r\nstatic int __init acpi_custom_method_init(void)\r\n{\r\nif (acpi_debugfs_dir == NULL)\r\nreturn -ENOENT;\r\ncm_dentry = debugfs_create_file("custom_method", S_IWUSR,\r\nacpi_debugfs_dir, NULL, &cm_fops);\r\nif (cm_dentry == NULL)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic void __exit acpi_custom_method_exit(void)\r\n{\r\nif (cm_dentry)\r\ndebugfs_remove(cm_dentry);\r\n}

static unsigned long i915_stolen_to_phys(struct drm_device *dev, u32 offset)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nstruct pci_dev *pdev = dev_priv->bridge_dev;\r\nu32 base;\r\n#if 0\r\nif (INTEL_INFO(dev)->gen > 3 || IS_G33(dev)) {\r\npci_read_config_dword(pdev, 0xA4, &base);\r\n} else {\r\npci_bus_read_config_dword(pdev->bus, 2, 0x5C, &base);\r\n}\r\n#else\r\nif (INTEL_INFO(dev)->gen > 3 || IS_G33(dev)) {\r\nu16 val;\r\npci_read_config_word(pdev, 0xb0, &val);\r\nbase = val >> 4 << 20;\r\n} else {\r\nu8 val;\r\npci_read_config_byte(pdev, 0x9c, &val);\r\nbase = val >> 3 << 27;\r\n}\r\nbase -= dev_priv->mm.gtt->stolen_size;\r\n#endif\r\nreturn base + offset;\r\n}\r\nstatic void i915_warn_stolen(struct drm_device *dev)\r\n{\r\nDRM_INFO("not enough stolen space for compressed buffer, disabling\n");\r\nDRM_INFO("hint: you may be able to increase stolen memory size in the BIOS to avoid this\n");\r\n}\r\nstatic void i915_setup_compression(struct drm_device *dev, int size)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nstruct drm_mm_node *compressed_fb, *uninitialized_var(compressed_llb);\r\nunsigned long cfb_base;\r\nunsigned long ll_base = 0;\r\nintel_disable_fbc(dev);\r\ncompressed_fb = drm_mm_search_free(&dev_priv->mm.stolen, size, 4096, 0);\r\nif (compressed_fb)\r\ncompressed_fb = drm_mm_get_block(compressed_fb, size, 4096);\r\nif (!compressed_fb)\r\ngoto err;\r\ncfb_base = i915_stolen_to_phys(dev, compressed_fb->start);\r\nif (!cfb_base)\r\ngoto err_fb;\r\nif (!(IS_GM45(dev) || HAS_PCH_SPLIT(dev))) {\r\ncompressed_llb = drm_mm_search_free(&dev_priv->mm.stolen,\r\n4096, 4096, 0);\r\nif (compressed_llb)\r\ncompressed_llb = drm_mm_get_block(compressed_llb,\r\n4096, 4096);\r\nif (!compressed_llb)\r\ngoto err_fb;\r\nll_base = i915_stolen_to_phys(dev, compressed_llb->start);\r\nif (!ll_base)\r\ngoto err_llb;\r\n}\r\ndev_priv->cfb_size = size;\r\ndev_priv->compressed_fb = compressed_fb;\r\nif (HAS_PCH_SPLIT(dev))\r\nI915_WRITE(ILK_DPFC_CB_BASE, compressed_fb->start);\r\nelse if (IS_GM45(dev)) {\r\nI915_WRITE(DPFC_CB_BASE, compressed_fb->start);\r\n} else {\r\nI915_WRITE(FBC_CFB_BASE, cfb_base);\r\nI915_WRITE(FBC_LL_BASE, ll_base);\r\ndev_priv->compressed_llb = compressed_llb;\r\n}\r\nDRM_DEBUG_KMS("FBC base 0x%08lx, ll base 0x%08lx, size %dM\n",\r\ncfb_base, ll_base, size >> 20);\r\nreturn;\r\nerr_llb:\r\ndrm_mm_put_block(compressed_llb);\r\nerr_fb:\r\ndrm_mm_put_block(compressed_fb);\r\nerr:\r\ndev_priv->no_fbc_reason = FBC_STOLEN_TOO_SMALL;\r\ni915_warn_stolen(dev);\r\n}\r\nstatic void i915_cleanup_compression(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\ndrm_mm_put_block(dev_priv->compressed_fb);\r\nif (dev_priv->compressed_llb)\r\ndrm_mm_put_block(dev_priv->compressed_llb);\r\n}\r\nvoid i915_gem_cleanup_stolen(struct drm_device *dev)\r\n{\r\nif (I915_HAS_FBC(dev) && i915_powersave)\r\ni915_cleanup_compression(dev);\r\n}\r\nint i915_gem_init_stolen(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nunsigned long prealloc_size = dev_priv->mm.gtt->stolen_size;\r\ndrm_mm_init(&dev_priv->mm.stolen, 0, prealloc_size);\r\nif (I915_HAS_FBC(dev) && i915_powersave) {\r\nint cfb_size;\r\nif (prealloc_size > (36*1024*1024))\r\ncfb_size = 32*1024*1024;\r\nelse\r\ncfb_size = prealloc_size * 7 / 8;\r\ni915_setup_compression(dev, cfb_size);\r\n}\r\nreturn 0;\r\n}

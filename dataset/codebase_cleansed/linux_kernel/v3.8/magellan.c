static int magellan_crunch_nibbles(unsigned char *data, int count)\r\n{\r\nstatic unsigned char nibbles[16] = "0AB3D56GH9:K<MN?";\r\ndo {\r\nif (data[count] == nibbles[data[count] & 0xf])\r\ndata[count] = data[count] & 0xf;\r\nelse\r\nreturn -1;\r\n} while (--count);\r\nreturn 0;\r\n}\r\nstatic void magellan_process_packet(struct magellan* magellan)\r\n{\r\nstruct input_dev *dev = magellan->dev;\r\nunsigned char *data = magellan->data;\r\nint i, t;\r\nif (!magellan->idx) return;\r\nswitch (magellan->data[0]) {\r\ncase 'd':\r\nif (magellan->idx != 25) return;\r\nif (magellan_crunch_nibbles(data, 24)) return;\r\nfor (i = 0; i < 6; i++)\r\ninput_report_abs(dev, magellan_axes[i],\r\n(data[(i << 2) + 1] << 12 | data[(i << 2) + 2] << 8 |\r\ndata[(i << 2) + 3] << 4 | data[(i << 2) + 4]) - 32768);\r\nbreak;\r\ncase 'k':\r\nif (magellan->idx != 4) return;\r\nif (magellan_crunch_nibbles(data, 3)) return;\r\nt = (data[1] << 1) | (data[2] << 5) | data[3];\r\nfor (i = 0; i < 9; i++) input_report_key(dev, magellan_buttons[i], (t >> i) & 1);\r\nbreak;\r\n}\r\ninput_sync(dev);\r\n}\r\nstatic irqreturn_t magellan_interrupt(struct serio *serio,\r\nunsigned char data, unsigned int flags)\r\n{\r\nstruct magellan* magellan = serio_get_drvdata(serio);\r\nif (data == '\r') {\r\nmagellan_process_packet(magellan);\r\nmagellan->idx = 0;\r\n} else {\r\nif (magellan->idx < MAGELLAN_MAX_LENGTH)\r\nmagellan->data[magellan->idx++] = data;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void magellan_disconnect(struct serio *serio)\r\n{\r\nstruct magellan* magellan = serio_get_drvdata(serio);\r\nserio_close(serio);\r\nserio_set_drvdata(serio, NULL);\r\ninput_unregister_device(magellan->dev);\r\nkfree(magellan);\r\n}\r\nstatic int magellan_connect(struct serio *serio, struct serio_driver *drv)\r\n{\r\nstruct magellan *magellan;\r\nstruct input_dev *input_dev;\r\nint err = -ENOMEM;\r\nint i;\r\nmagellan = kzalloc(sizeof(struct magellan), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!magellan || !input_dev)\r\ngoto fail1;\r\nmagellan->dev = input_dev;\r\nsnprintf(magellan->phys, sizeof(magellan->phys), "%s/input0", serio->phys);\r\ninput_dev->name = "LogiCad3D Magellan / SpaceMouse";\r\ninput_dev->phys = magellan->phys;\r\ninput_dev->id.bustype = BUS_RS232;\r\ninput_dev->id.vendor = SERIO_MAGELLAN;\r\ninput_dev->id.product = 0x0001;\r\ninput_dev->id.version = 0x0100;\r\ninput_dev->dev.parent = &serio->dev;\r\ninput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\r\nfor (i = 0; i < 9; i++)\r\nset_bit(magellan_buttons[i], input_dev->keybit);\r\nfor (i = 0; i < 6; i++)\r\ninput_set_abs_params(input_dev, magellan_axes[i], -360, 360, 0, 0);\r\nserio_set_drvdata(serio, magellan);\r\nerr = serio_open(serio, drv);\r\nif (err)\r\ngoto fail2;\r\nerr = input_register_device(magellan->dev);\r\nif (err)\r\ngoto fail3;\r\nreturn 0;\r\nfail3: serio_close(serio);\r\nfail2: serio_set_drvdata(serio, NULL);\r\nfail1: input_free_device(input_dev);\r\nkfree(magellan);\r\nreturn err;\r\n}

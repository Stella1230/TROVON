static\r\nstruct rb_node *strlist__node_new(struct rblist *rblist, const void *entry)\r\n{\r\nconst char *s = entry;\r\nstruct rb_node *rc = NULL;\r\nstruct strlist *strlist = container_of(rblist, struct strlist, rblist);\r\nstruct str_node *snode = malloc(sizeof(*snode));\r\nif (snode != NULL) {\r\nif (strlist->dupstr) {\r\ns = strdup(s);\r\nif (s == NULL)\r\ngoto out_delete;\r\n}\r\nsnode->s = s;\r\nrc = &snode->rb_node;\r\n}\r\nreturn rc;\r\nout_delete:\r\nfree(snode);\r\nreturn NULL;\r\n}\r\nstatic void str_node__delete(struct str_node *self, bool dupstr)\r\n{\r\nif (dupstr)\r\nfree((void *)self->s);\r\nfree(self);\r\n}\r\nstatic\r\nvoid strlist__node_delete(struct rblist *rblist, struct rb_node *rb_node)\r\n{\r\nstruct strlist *slist = container_of(rblist, struct strlist, rblist);\r\nstruct str_node *snode = container_of(rb_node, struct str_node, rb_node);\r\nstr_node__delete(snode, slist->dupstr);\r\n}\r\nstatic int strlist__node_cmp(struct rb_node *rb_node, const void *entry)\r\n{\r\nconst char *str = entry;\r\nstruct str_node *snode = container_of(rb_node, struct str_node, rb_node);\r\nreturn strcmp(snode->s, str);\r\n}\r\nint strlist__add(struct strlist *self, const char *new_entry)\r\n{\r\nreturn rblist__add_node(&self->rblist, new_entry);\r\n}\r\nint strlist__load(struct strlist *self, const char *filename)\r\n{\r\nchar entry[1024];\r\nint err;\r\nFILE *fp = fopen(filename, "r");\r\nif (fp == NULL)\r\nreturn errno;\r\nwhile (fgets(entry, sizeof(entry), fp) != NULL) {\r\nconst size_t len = strlen(entry);\r\nif (len == 0)\r\ncontinue;\r\nentry[len - 1] = '\0';\r\nerr = strlist__add(self, entry);\r\nif (err != 0)\r\ngoto out;\r\n}\r\nerr = 0;\r\nout:\r\nfclose(fp);\r\nreturn err;\r\n}\r\nvoid strlist__remove(struct strlist *slist, struct str_node *snode)\r\n{\r\nrblist__remove_node(&slist->rblist, &snode->rb_node);\r\n}\r\nstruct str_node *strlist__find(struct strlist *slist, const char *entry)\r\n{\r\nstruct str_node *snode = NULL;\r\nstruct rb_node *rb_node = rblist__find(&slist->rblist, entry);\r\nif (rb_node)\r\nsnode = container_of(rb_node, struct str_node, rb_node);\r\nreturn snode;\r\n}\r\nstatic int strlist__parse_list_entry(struct strlist *self, const char *s)\r\n{\r\nif (strncmp(s, "file://", 7) == 0)\r\nreturn strlist__load(self, s + 7);\r\nreturn strlist__add(self, s);\r\n}\r\nint strlist__parse_list(struct strlist *self, const char *s)\r\n{\r\nchar *sep;\r\nint err;\r\nwhile ((sep = strchr(s, ',')) != NULL) {\r\n*sep = '\0';\r\nerr = strlist__parse_list_entry(self, s);\r\n*sep = ',';\r\nif (err != 0)\r\nreturn err;\r\ns = sep + 1;\r\n}\r\nreturn *s ? strlist__parse_list_entry(self, s) : 0;\r\n}\r\nstruct strlist *strlist__new(bool dupstr, const char *slist)\r\n{\r\nstruct strlist *self = malloc(sizeof(*self));\r\nif (self != NULL) {\r\nrblist__init(&self->rblist);\r\nself->rblist.node_cmp = strlist__node_cmp;\r\nself->rblist.node_new = strlist__node_new;\r\nself->rblist.node_delete = strlist__node_delete;\r\nself->dupstr = dupstr;\r\nif (slist && strlist__parse_list(self, slist) != 0)\r\ngoto out_error;\r\n}\r\nreturn self;\r\nout_error:\r\nfree(self);\r\nreturn NULL;\r\n}\r\nvoid strlist__delete(struct strlist *self)\r\n{\r\nif (self != NULL)\r\nrblist__delete(&self->rblist);\r\n}\r\nstruct str_node *strlist__entry(const struct strlist *slist, unsigned int idx)\r\n{\r\nstruct str_node *snode = NULL;\r\nstruct rb_node *rb_node;\r\nrb_node = rblist__entry(&slist->rblist, idx);\r\nif (rb_node)\r\nsnode = container_of(rb_node, struct str_node, rb_node);\r\nreturn snode;\r\n}

static int tape_proc_show(struct seq_file *m, void *v)\r\n{\r\nstruct tape_device *device;\r\nstruct tape_request *request;\r\nconst char *str;\r\nunsigned long n;\r\nn = (unsigned long) v - 1;\r\nif (!n) {\r\nseq_printf(m, "TapeNo\tBusID CuType/Model\t"\r\n"DevType/Model\tBlkSize\tState\tOp\tMedState\n");\r\n}\r\ndevice = tape_find_device(n);\r\nif (IS_ERR(device))\r\nreturn 0;\r\nspin_lock_irq(get_ccwdev_lock(device->cdev));\r\nseq_printf(m, "%d\t", (int) n);\r\nseq_printf(m, "%-10.10s ", dev_name(&device->cdev->dev));\r\nseq_printf(m, "%04X/", device->cdev->id.cu_type);\r\nseq_printf(m, "%02X\t", device->cdev->id.cu_model);\r\nseq_printf(m, "%04X/", device->cdev->id.dev_type);\r\nseq_printf(m, "%02X\t\t", device->cdev->id.dev_model);\r\nif (device->char_data.block_size == 0)\r\nseq_printf(m, "auto\t");\r\nelse\r\nseq_printf(m, "%i\t", device->char_data.block_size);\r\nif (device->tape_state >= 0 &&\r\ndevice->tape_state < TS_SIZE)\r\nstr = tape_state_verbose[device->tape_state];\r\nelse\r\nstr = "UNKNOWN";\r\nseq_printf(m, "%s\t", str);\r\nif (!list_empty(&device->req_queue)) {\r\nrequest = list_entry(device->req_queue.next,\r\nstruct tape_request, list);\r\nstr = tape_op_verbose[request->op];\r\n} else\r\nstr = "---";\r\nseq_printf(m, "%s\t", str);\r\nseq_printf(m, "%s\n", tape_med_st_verbose[device->medium_state]);\r\nspin_unlock_irq(get_ccwdev_lock(device->cdev));\r\ntape_put_device(device);\r\nreturn 0;\r\n}\r\nstatic void *tape_proc_start(struct seq_file *m, loff_t *pos)\r\n{\r\nif (*pos >= 256 / TAPE_MINORS_PER_DEV)\r\nreturn NULL;\r\nreturn (void *)((unsigned long) *pos + 1);\r\n}\r\nstatic void *tape_proc_next(struct seq_file *m, void *v, loff_t *pos)\r\n{\r\n++*pos;\r\nreturn tape_proc_start(m, pos);\r\n}\r\nstatic void tape_proc_stop(struct seq_file *m, void *v)\r\n{\r\n}\r\nstatic int tape_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &tape_proc_seq);\r\n}\r\nvoid\r\ntape_proc_init(void)\r\n{\r\ntape_proc_devices =\r\nproc_create("tapedevices", S_IFREG | S_IRUGO | S_IWUSR, NULL,\r\n&tape_proc_ops);\r\nif (tape_proc_devices == NULL) {\r\nreturn;\r\n}\r\n}\r\nvoid\r\ntape_proc_cleanup(void)\r\n{\r\nif (tape_proc_devices != NULL)\r\nremove_proc_entry ("tapedevices", NULL);\r\n}

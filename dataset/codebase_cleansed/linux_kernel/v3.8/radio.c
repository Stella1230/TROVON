static int uwb_radio_select_channel(struct uwb_rc *rc)\r\n{\r\nif (rc->active_pals == 0)\r\nreturn -1;\r\nif (rc->beaconing_forced)\r\nreturn rc->beaconing_forced;\r\nreturn 9;\r\n}\r\nstatic void uwb_radio_channel_changed(struct uwb_rc *rc, int channel)\r\n{\r\nstruct uwb_pal *pal;\r\nlist_for_each_entry(pal, &rc->pals, node) {\r\nif (pal->channel && channel != pal->channel) {\r\npal->channel = channel;\r\nif (pal->channel_changed)\r\npal->channel_changed(pal, pal->channel);\r\n}\r\n}\r\n}\r\nstatic int uwb_radio_change_channel(struct uwb_rc *rc, int channel)\r\n{\r\nint ret = 0;\r\nif (channel == -1)\r\nuwb_radio_channel_changed(rc, channel);\r\nif (channel != rc->beaconing) {\r\nif (rc->beaconing != -1 && channel != -1) {\r\nret = uwb_radio_change_channel(rc, -1);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nret = uwb_rc_beacon(rc, channel, 0);\r\n}\r\nif (channel != -1)\r\nuwb_radio_channel_changed(rc, rc->beaconing);\r\nreturn ret;\r\n}\r\nint uwb_radio_start(struct uwb_pal *pal)\r\n{\r\nstruct uwb_rc *rc = pal->rc;\r\nint ret = 0;\r\nmutex_lock(&rc->uwb_dev.mutex);\r\nif (!pal->channel) {\r\npal->channel = -1;\r\nrc->active_pals++;\r\nret = uwb_radio_change_channel(rc, uwb_radio_select_channel(rc));\r\n}\r\nmutex_unlock(&rc->uwb_dev.mutex);\r\nreturn ret;\r\n}\r\nvoid uwb_radio_stop(struct uwb_pal *pal)\r\n{\r\nstruct uwb_rc *rc = pal->rc;\r\nmutex_lock(&rc->uwb_dev.mutex);\r\nif (pal->channel) {\r\nrc->active_pals--;\r\nuwb_radio_change_channel(rc, uwb_radio_select_channel(rc));\r\npal->channel = 0;\r\n}\r\nmutex_unlock(&rc->uwb_dev.mutex);\r\n}\r\nint uwb_radio_force_channel(struct uwb_rc *rc, int channel)\r\n{\r\nint ret = 0;\r\nmutex_lock(&rc->uwb_dev.mutex);\r\nrc->beaconing_forced = channel;\r\nret = uwb_radio_change_channel(rc, uwb_radio_select_channel(rc));\r\nmutex_unlock(&rc->uwb_dev.mutex);\r\nreturn ret;\r\n}\r\nint uwb_radio_setup(struct uwb_rc *rc)\r\n{\r\nreturn uwb_rc_reset(rc);\r\n}\r\nvoid uwb_radio_reset_state(struct uwb_rc *rc)\r\n{\r\nstruct uwb_pal *pal;\r\nmutex_lock(&rc->uwb_dev.mutex);\r\nlist_for_each_entry(pal, &rc->pals, node) {\r\nif (pal->channel) {\r\npal->channel = -1;\r\nif (pal->channel_changed)\r\npal->channel_changed(pal, -1);\r\n}\r\n}\r\nrc->beaconing = -1;\r\nrc->scanning = -1;\r\nmutex_unlock(&rc->uwb_dev.mutex);\r\n}\r\nvoid uwb_radio_shutdown(struct uwb_rc *rc)\r\n{\r\nuwb_radio_reset_state(rc);\r\nuwb_rc_reset(rc);\r\n}

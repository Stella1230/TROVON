static int snd_gus_dram_poke(struct snd_gus_card *gus, char __user *_buffer,\r\nunsigned int address, unsigned int size)\r\n{\r\nunsigned long flags;\r\nunsigned int size1, size2;\r\nchar buffer[256], *pbuffer;\r\nwhile (size > 0) {\r\nsize1 = size > sizeof(buffer) ? sizeof(buffer) : size;\r\nif (copy_from_user(buffer, _buffer, size1))\r\nreturn -EFAULT;\r\nif (gus->interwave) {\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\nsnd_gf1_write8(gus, SNDRV_GF1_GB_MEMORY_CONTROL, 0x01);\r\nsnd_gf1_dram_addr(gus, address);\r\noutsb(GUSP(gus, DRAM), buffer, size1);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\naddress += size1;\r\n} else {\r\npbuffer = buffer;\r\nsize2 = size1;\r\nwhile (size2--)\r\nsnd_gf1_poke(gus, address++, *pbuffer++);\r\n}\r\nsize -= size1;\r\n_buffer += size1;\r\n}\r\nreturn 0;\r\n}\r\nint snd_gus_dram_write(struct snd_gus_card *gus, char __user *buffer,\r\nunsigned int address, unsigned int size)\r\n{\r\nreturn snd_gus_dram_poke(gus, buffer, address, size);\r\n}\r\nstatic int snd_gus_dram_peek(struct snd_gus_card *gus, char __user *_buffer,\r\nunsigned int address, unsigned int size,\r\nint rom)\r\n{\r\nunsigned long flags;\r\nunsigned int size1, size2;\r\nchar buffer[256], *pbuffer;\r\nwhile (size > 0) {\r\nsize1 = size > sizeof(buffer) ? sizeof(buffer) : size;\r\nif (gus->interwave) {\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\nsnd_gf1_write8(gus, SNDRV_GF1_GB_MEMORY_CONTROL, rom ? 0x03 : 0x01);\r\nsnd_gf1_dram_addr(gus, address);\r\ninsb(GUSP(gus, DRAM), buffer, size1);\r\nsnd_gf1_write8(gus, SNDRV_GF1_GB_MEMORY_CONTROL, 0x01);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\naddress += size1;\r\n} else {\r\npbuffer = buffer;\r\nsize2 = size1;\r\nwhile (size2--)\r\n*pbuffer++ = snd_gf1_peek(gus, address++);\r\n}\r\nif (copy_to_user(_buffer, buffer, size1))\r\nreturn -EFAULT;\r\nsize -= size1;\r\n_buffer += size1;\r\n}\r\nreturn 0;\r\n}\r\nint snd_gus_dram_read(struct snd_gus_card *gus, char __user *buffer,\r\nunsigned int address, unsigned int size,\r\nint rom)\r\n{\r\nreturn snd_gus_dram_peek(gus, buffer, address, size, rom);\r\n}

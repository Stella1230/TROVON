static inline int mips_pcibios_iack(void)\r\n{\r\nint irq;\r\nswitch (mips_revision_sconid) {\r\ncase MIPS_REVISION_SCON_SOCIT:\r\ncase MIPS_REVISION_SCON_ROCIT:\r\ncase MIPS_REVISION_SCON_SOCITSC:\r\ncase MIPS_REVISION_SCON_SOCITSCP:\r\nMSC_READ(MSC01_PCI_IACK, irq);\r\nirq &= 0xff;\r\nbreak;\r\ncase MIPS_REVISION_SCON_GT64120:\r\nirq = GT_READ(GT_PCI0_IACK_OFS);\r\nirq &= 0xff;\r\nbreak;\r\ncase MIPS_REVISION_SCON_BONITO:\r\nBONITO_PCIMAP_CFG = 0x20000;\r\n(void) BONITO_PCIMAP_CFG;\r\niob();\r\nirq = __raw_readl((u32 *)_pcictrl_bonito_pcicfg);\r\niob();\r\nirq &= 0xff;\r\nBONITO_PCIMAP_CFG = 0;\r\nbreak;\r\ndefault:\r\nprintk(KERN_WARNING "Unknown system controller.\n");\r\nreturn -1;\r\n}\r\nreturn irq;\r\n}\r\nstatic inline int get_int(void)\r\n{\r\nunsigned long flags;\r\nint irq;\r\nraw_spin_lock_irqsave(&mips_irq_lock, flags);\r\nirq = mips_pcibios_iack();\r\nraw_spin_unlock_irqrestore(&mips_irq_lock, flags);\r\nreturn irq;\r\n}\r\nstatic void malta_hw0_irqdispatch(void)\r\n{\r\nint irq;\r\nirq = get_int();\r\nif (irq < 0) {\r\nreturn;\r\n}\r\ndo_IRQ(MALTA_INT_BASE + irq);\r\n}\r\nstatic void malta_ipi_irqdispatch(void)\r\n{\r\nint irq;\r\nirq = gic_get_int();\r\nif (irq < 0)\r\nreturn;\r\ndo_IRQ(MIPS_GIC_IRQ_BASE + irq);\r\n}\r\nstatic void corehi_irqdispatch(void)\r\n{\r\nunsigned int intedge, intsteer, pcicmd, pcibadaddr;\r\nunsigned int pcimstat, intisr, inten, intpol;\r\nunsigned int intrcause, datalo, datahi;\r\nstruct pt_regs *regs = get_irq_regs();\r\nprintk(KERN_EMERG "CoreHI interrupt, shouldn't happen, we die here!\n");\r\nprintk(KERN_EMERG "epc : %08lx\nStatus: %08lx\n"\r\n"Cause : %08lx\nbadVaddr : %08lx\n",\r\nregs->cp0_epc, regs->cp0_status,\r\nregs->cp0_cause, regs->cp0_badvaddr);\r\nswitch (mips_revision_sconid) {\r\ncase MIPS_REVISION_SCON_SOCIT:\r\ncase MIPS_REVISION_SCON_ROCIT:\r\ncase MIPS_REVISION_SCON_SOCITSC:\r\ncase MIPS_REVISION_SCON_SOCITSCP:\r\nll_msc_irq();\r\nbreak;\r\ncase MIPS_REVISION_SCON_GT64120:\r\nintrcause = GT_READ(GT_INTRCAUSE_OFS);\r\ndatalo = GT_READ(GT_CPUERR_ADDRLO_OFS);\r\ndatahi = GT_READ(GT_CPUERR_ADDRHI_OFS);\r\nprintk(KERN_EMERG "GT_INTRCAUSE = %08x\n", intrcause);\r\nprintk(KERN_EMERG "GT_CPUERR_ADDR = %02x%08x\n",\r\ndatahi, datalo);\r\nbreak;\r\ncase MIPS_REVISION_SCON_BONITO:\r\npcibadaddr = BONITO_PCIBADADDR;\r\npcimstat = BONITO_PCIMSTAT;\r\nintisr = BONITO_INTISR;\r\ninten = BONITO_INTEN;\r\nintpol = BONITO_INTPOL;\r\nintedge = BONITO_INTEDGE;\r\nintsteer = BONITO_INTSTEER;\r\npcicmd = BONITO_PCICMD;\r\nprintk(KERN_EMERG "BONITO_INTISR = %08x\n", intisr);\r\nprintk(KERN_EMERG "BONITO_INTEN = %08x\n", inten);\r\nprintk(KERN_EMERG "BONITO_INTPOL = %08x\n", intpol);\r\nprintk(KERN_EMERG "BONITO_INTEDGE = %08x\n", intedge);\r\nprintk(KERN_EMERG "BONITO_INTSTEER = %08x\n", intsteer);\r\nprintk(KERN_EMERG "BONITO_PCICMD = %08x\n", pcicmd);\r\nprintk(KERN_EMERG "BONITO_PCIBADADDR = %08x\n", pcibadaddr);\r\nprintk(KERN_EMERG "BONITO_PCIMSTAT = %08x\n", pcimstat);\r\nbreak;\r\n}\r\ndie("CoreHi interrupt", regs);\r\n}\r\nstatic inline int clz(unsigned long x)\r\n{\r\n__asm__(\r\n" .set push \n"\r\n" .set mips32 \n"\r\n" clz %0, %1 \n"\r\n" .set pop \n"\r\n: "=r" (x)\r\n: "r" (x));\r\nreturn x;\r\n}\r\nstatic inline unsigned int irq_ffs(unsigned int pending)\r\n{\r\n#if defined(CONFIG_CPU_MIPS32) || defined(CONFIG_CPU_MIPS64)\r\nreturn -clz(pending) + 31 - CAUSEB_IP;\r\n#else\r\nunsigned int a0 = 7;\r\nunsigned int t0;\r\nt0 = pending & 0xf000;\r\nt0 = t0 < 1;\r\nt0 = t0 << 2;\r\na0 = a0 - t0;\r\npending = pending << t0;\r\nt0 = pending & 0xc000;\r\nt0 = t0 < 1;\r\nt0 = t0 << 1;\r\na0 = a0 - t0;\r\npending = pending << t0;\r\nt0 = pending & 0x8000;\r\nt0 = t0 < 1;\r\na0 = a0 - t0;\r\nreturn a0;\r\n#endif\r\n}\r\nasmlinkage void plat_irq_dispatch(void)\r\n{\r\nunsigned int pending = read_c0_cause() & read_c0_status() & ST0_IM;\r\nint irq;\r\nif (unlikely(!pending)) {\r\nspurious_interrupt();\r\nreturn;\r\n}\r\nirq = irq_ffs(pending);\r\nif (irq == MIPSCPU_INT_I8259A)\r\nmalta_hw0_irqdispatch();\r\nelse if (gic_present && ((1 << irq) & ipi_map[smp_processor_id()]))\r\nmalta_ipi_irqdispatch();\r\nelse\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + irq);\r\n}\r\nstatic void ipi_resched_dispatch(void)\r\n{\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + MIPS_CPU_IPI_RESCHED_IRQ);\r\n}\r\nstatic void ipi_call_dispatch(void)\r\n{\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + MIPS_CPU_IPI_CALL_IRQ);\r\n}\r\nstatic irqreturn_t ipi_resched_interrupt(int irq, void *dev_id)\r\n{\r\nscheduler_ipi();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ipi_call_interrupt(int irq, void *dev_id)\r\n{\r\nsmp_call_function_interrupt();\r\nreturn IRQ_HANDLED;\r\n}\r\nunsigned int plat_ipi_call_int_xlate(unsigned int cpu)\r\n{\r\nreturn GIC_CALL_INT(cpu);\r\n}\r\nunsigned int plat_ipi_resched_int_xlate(unsigned int cpu)\r\n{\r\nreturn GIC_RESCHED_INT(cpu);\r\n}\r\nint __init gcmp_probe(unsigned long addr, unsigned long size)\r\n{\r\nif (mips_revision_sconid != MIPS_REVISION_SCON_ROCIT) {\r\ngcmp_present = 0;\r\nreturn gcmp_present;\r\n}\r\nif (gcmp_present >= 0)\r\nreturn gcmp_present;\r\n_gcmp_base = (unsigned long) ioremap_nocache(GCMP_BASE_ADDR, GCMP_ADDRSPACE_SZ);\r\n_msc01_biu_base = (unsigned long) ioremap_nocache(MSC01_BIU_REG_BASE, MSC01_BIU_ADDRSPACE_SZ);\r\ngcmp_present = (GCMPGCB(GCMPB) & GCMP_GCB_GCMPB_GCMPBASE_MSK) == GCMP_BASE_ADDR;\r\nif (gcmp_present)\r\npr_debug("GCMP present\n");\r\nreturn gcmp_present;\r\n}\r\nint __init gcmp_niocu(void)\r\n{\r\nreturn gcmp_present ?\r\n(GCMPGCB(GC) & GCMP_GCB_GC_NUMIOCU_MSK) >> GCMP_GCB_GC_NUMIOCU_SHF :\r\n0;\r\n}\r\nvoid __init gcmp_setregion(int region, unsigned long base,\r\nunsigned long mask, int type)\r\n{\r\nGCMPGCBn(CMxBASE, region) = base;\r\nGCMPGCBn(CMxMASK, region) = mask | type;\r\n}\r\nstatic void __init fill_ipi_map1(int baseintr, int cpu, int cpupin)\r\n{\r\nint intr = baseintr + cpu;\r\ngic_intr_map[intr].cpunum = cpu;\r\ngic_intr_map[intr].pin = cpupin;\r\ngic_intr_map[intr].polarity = GIC_POL_POS;\r\ngic_intr_map[intr].trigtype = GIC_TRIG_EDGE;\r\ngic_intr_map[intr].flags = GIC_FLAG_IPI;\r\nipi_map[cpu] |= (1 << (cpupin + 2));\r\n}\r\nstatic void __init fill_ipi_map(void)\r\n{\r\nint cpu;\r\nfor (cpu = 0; cpu < NR_CPUS; cpu++) {\r\nfill_ipi_map1(gic_resched_int_base, cpu, GIC_CPU_INT1);\r\nfill_ipi_map1(gic_call_int_base, cpu, GIC_CPU_INT2);\r\n}\r\n}\r\nvoid __init arch_init_ipiirq(int irq, struct irqaction *action)\r\n{\r\nsetup_irq(irq, action);\r\nirq_set_handler(irq, handle_percpu_irq);\r\n}\r\nvoid __init arch_init_irq(void)\r\n{\r\ninit_i8259_irqs();\r\nif (!cpu_has_veic)\r\nmips_cpu_irq_init();\r\nif (gcmp_present) {\r\nGCMPGCB(GICBA) = GIC_BASE_ADDR | GCMP_GCB_GICBA_EN_MSK;\r\ngic_present = 1;\r\n} else {\r\nif (mips_revision_sconid == MIPS_REVISION_SCON_ROCIT) {\r\n_msc01_biu_base = (unsigned long)\r\nioremap_nocache(MSC01_BIU_REG_BASE,\r\nMSC01_BIU_ADDRSPACE_SZ);\r\ngic_present = (REG(_msc01_biu_base, MSC01_SC_CFG) &\r\nMSC01_SC_CFG_GICPRES_MSK) >>\r\nMSC01_SC_CFG_GICPRES_SHF;\r\n}\r\n}\r\nif (gic_present)\r\npr_debug("GIC present\n");\r\nswitch (mips_revision_sconid) {\r\ncase MIPS_REVISION_SCON_SOCIT:\r\ncase MIPS_REVISION_SCON_ROCIT:\r\nif (cpu_has_veic)\r\ninit_msc_irqs(MIPS_MSC01_IC_REG_BASE,\r\nMSC01E_INT_BASE, msc_eicirqmap,\r\nmsc_nr_eicirqs);\r\nelse\r\ninit_msc_irqs(MIPS_MSC01_IC_REG_BASE,\r\nMSC01C_INT_BASE, msc_irqmap,\r\nmsc_nr_irqs);\r\nbreak;\r\ncase MIPS_REVISION_SCON_SOCITSC:\r\ncase MIPS_REVISION_SCON_SOCITSCP:\r\nif (cpu_has_veic)\r\ninit_msc_irqs(MIPS_SOCITSC_IC_REG_BASE,\r\nMSC01E_INT_BASE, msc_eicirqmap,\r\nmsc_nr_eicirqs);\r\nelse\r\ninit_msc_irqs(MIPS_SOCITSC_IC_REG_BASE,\r\nMSC01C_INT_BASE, msc_irqmap,\r\nmsc_nr_irqs);\r\n}\r\nif (cpu_has_veic) {\r\nset_vi_handler(MSC01E_INT_I8259A, malta_hw0_irqdispatch);\r\nset_vi_handler(MSC01E_INT_COREHI, corehi_irqdispatch);\r\nsetup_irq(MSC01E_INT_BASE+MSC01E_INT_I8259A, &i8259irq);\r\nsetup_irq(MSC01E_INT_BASE+MSC01E_INT_COREHI, &corehi_irqaction);\r\n} else if (cpu_has_vint) {\r\nset_vi_handler(MIPSCPU_INT_I8259A, malta_hw0_irqdispatch);\r\nset_vi_handler(MIPSCPU_INT_COREHI, corehi_irqdispatch);\r\n#ifdef CONFIG_MIPS_MT_SMTC\r\nsetup_irq_smtc(MIPS_CPU_IRQ_BASE+MIPSCPU_INT_I8259A, &i8259irq,\r\n(0x100 << MIPSCPU_INT_I8259A));\r\nsetup_irq_smtc(MIPS_CPU_IRQ_BASE+MIPSCPU_INT_COREHI,\r\n&corehi_irqaction, (0x100 << MIPSCPU_INT_COREHI));\r\n{\r\nint i;\r\nfor (i = 0; i < 16; i++)\r\nirq_hwmask[i] = (0x100 << MIPSCPU_INT_I8259A);\r\n}\r\n#else\r\nsetup_irq(MIPS_CPU_IRQ_BASE+MIPSCPU_INT_I8259A, &i8259irq);\r\nsetup_irq(MIPS_CPU_IRQ_BASE+MIPSCPU_INT_COREHI,\r\n&corehi_irqaction);\r\n#endif\r\n} else {\r\nsetup_irq(MIPS_CPU_IRQ_BASE+MIPSCPU_INT_I8259A, &i8259irq);\r\nsetup_irq(MIPS_CPU_IRQ_BASE+MIPSCPU_INT_COREHI,\r\n&corehi_irqaction);\r\n}\r\nif (gic_present) {\r\nint i;\r\n#if defined(CONFIG_MIPS_MT_SMP)\r\ngic_call_int_base = GIC_NUM_INTRS - NR_CPUS;\r\ngic_resched_int_base = gic_call_int_base - NR_CPUS;\r\nfill_ipi_map();\r\n#endif\r\ngic_init(GIC_BASE_ADDR, GIC_ADDRSPACE_SZ, gic_intr_map,\r\nARRAY_SIZE(gic_intr_map), MIPS_GIC_IRQ_BASE);\r\nif (!gcmp_present) {\r\ni = REG(_msc01_biu_base, MSC01_SC_CFG);\r\nREG(_msc01_biu_base, MSC01_SC_CFG) =\r\n(i | (0x1 << MSC01_SC_CFG_GICENA_SHF));\r\npr_debug("GIC Enabled\n");\r\n}\r\n#if defined(CONFIG_MIPS_MT_SMP)\r\nif (cpu_has_vint) {\r\nset_vi_handler(MIPSCPU_INT_IPI0, malta_ipi_irqdispatch);\r\nset_vi_handler(MIPSCPU_INT_IPI1, malta_ipi_irqdispatch);\r\n}\r\nprintk("CPU%d: status register was %08x\n", smp_processor_id(), read_c0_status());\r\nwrite_c0_status(read_c0_status() | STATUSF_IP3 | STATUSF_IP4);\r\nprintk("CPU%d: status register now %08x\n", smp_processor_id(), read_c0_status());\r\nwrite_c0_status(0x1100dc00);\r\nprintk("CPU%d: status register frc %08x\n", smp_processor_id(), read_c0_status());\r\nfor (i = 0; i < NR_CPUS; i++) {\r\narch_init_ipiirq(MIPS_GIC_IRQ_BASE +\r\nGIC_RESCHED_INT(i), &irq_resched);\r\narch_init_ipiirq(MIPS_GIC_IRQ_BASE +\r\nGIC_CALL_INT(i), &irq_call);\r\n}\r\n#endif\r\n} else {\r\n#if defined(CONFIG_MIPS_MT_SMP)\r\nif (cpu_has_veic) {\r\nset_vi_handler (MSC01E_INT_SW0, ipi_resched_dispatch);\r\nset_vi_handler (MSC01E_INT_SW1, ipi_call_dispatch);\r\ncpu_ipi_resched_irq = MSC01E_INT_SW0;\r\ncpu_ipi_call_irq = MSC01E_INT_SW1;\r\n} else {\r\nif (cpu_has_vint) {\r\nset_vi_handler (MIPS_CPU_IPI_RESCHED_IRQ, ipi_resched_dispatch);\r\nset_vi_handler (MIPS_CPU_IPI_CALL_IRQ, ipi_call_dispatch);\r\n}\r\ncpu_ipi_resched_irq = MIPS_CPU_IRQ_BASE + MIPS_CPU_IPI_RESCHED_IRQ;\r\ncpu_ipi_call_irq = MIPS_CPU_IRQ_BASE + MIPS_CPU_IPI_CALL_IRQ;\r\n}\r\narch_init_ipiirq(cpu_ipi_resched_irq, &irq_resched);\r\narch_init_ipiirq(cpu_ipi_call_irq, &irq_call);\r\n#endif\r\n}\r\n}\r\nvoid malta_be_init(void)\r\n{\r\nif (gcmp_present) {\r\n}\r\n}\r\nint malta_be_handler(struct pt_regs *regs, int is_fixup)\r\n{\r\nint retval = is_fixup ? MIPS_BE_FIXUP : MIPS_BE_FATAL;\r\nif (gcmp_present) {\r\nunsigned long cm_error = GCMPGCB(GCMEC);\r\nunsigned long cm_addr = GCMPGCB(GCMEA);\r\nunsigned long cm_other = GCMPGCB(GCMEO);\r\nunsigned long cause, ocause;\r\nchar buf[256];\r\ncause = (cm_error & GCMP_GCB_GMEC_ERROR_TYPE_MSK);\r\nif (cause != 0) {\r\ncause >>= GCMP_GCB_GMEC_ERROR_TYPE_SHF;\r\nif (cause < 16) {\r\nunsigned long cca_bits = (cm_error >> 15) & 7;\r\nunsigned long tr_bits = (cm_error >> 12) & 7;\r\nunsigned long mcmd_bits = (cm_error >> 7) & 0x1f;\r\nunsigned long stag_bits = (cm_error >> 3) & 15;\r\nunsigned long sport_bits = (cm_error >> 0) & 7;\r\nsnprintf(buf, sizeof(buf),\r\n"CCA=%lu TR=%s MCmd=%s STag=%lu "\r\n"SPort=%lu\n",\r\ncca_bits, tr[tr_bits], mcmd[mcmd_bits],\r\nstag_bits, sport_bits);\r\n} else {\r\nunsigned long c3_bits = (cm_error >> 18) & 7;\r\nunsigned long c2_bits = (cm_error >> 15) & 7;\r\nunsigned long c1_bits = (cm_error >> 12) & 7;\r\nunsigned long c0_bits = (cm_error >> 9) & 7;\r\nunsigned long sc_bit = (cm_error >> 8) & 1;\r\nunsigned long mcmd_bits = (cm_error >> 3) & 0x1f;\r\nunsigned long sport_bits = (cm_error >> 0) & 7;\r\nsnprintf(buf, sizeof(buf),\r\n"C3=%s C2=%s C1=%s C0=%s SC=%s "\r\n"MCmd=%s SPort=%lu\n",\r\ncore[c3_bits], core[c2_bits],\r\ncore[c1_bits], core[c0_bits],\r\nsc_bit ? "True" : "False",\r\nmcmd[mcmd_bits], sport_bits);\r\n}\r\nocause = (cm_other & GCMP_GCB_GMEO_ERROR_2ND_MSK) >>\r\nGCMP_GCB_GMEO_ERROR_2ND_SHF;\r\nprintk("CM_ERROR=%08lx %s <%s>\n", cm_error,\r\ncauses[cause], buf);\r\nprintk("CM_ADDR =%08lx\n", cm_addr);\r\nprintk("CM_OTHER=%08lx %s\n", cm_other, causes[ocause]);\r\nGCMPGCB(GCMEC) = 0;\r\n}\r\n}\r\nreturn retval;\r\n}\r\nvoid gic_enable_interrupt(int irq_vec)\r\n{\r\nGIC_SET_INTR_MASK(irq_vec);\r\n}\r\nvoid gic_disable_interrupt(int irq_vec)\r\n{\r\nGIC_CLR_INTR_MASK(irq_vec);\r\n}\r\nvoid gic_irq_ack(struct irq_data *d)\r\n{\r\nint irq = (d->irq - gic_irq_base);\r\nGIC_CLR_INTR_MASK(irq);\r\nif (gic_irq_flags[irq] & GIC_TRIG_EDGE)\r\nGICWRITE(GIC_REG(SHARED, GIC_SH_WEDGE), irq);\r\n}\r\nvoid gic_finish_irq(struct irq_data *d)\r\n{\r\nGIC_SET_INTR_MASK(d->irq - gic_irq_base);\r\n}\r\nvoid __init gic_platform_init(int irqs, struct irq_chip *irq_controller)\r\n{\r\nint i;\r\nfor (i = gic_irq_base; i < (gic_irq_base + irqs); i++)\r\nirq_set_chip(i, irq_controller);\r\n}

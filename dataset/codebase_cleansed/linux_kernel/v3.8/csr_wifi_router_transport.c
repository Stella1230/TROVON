void CsrWifiRouterTransportInit(unifi_priv_t *priv)\r\n{\r\nunifi_trace(priv, UDBG1, "CsrWifiRouterTransportInit: \n");\r\ndrvpriv = priv;\r\n(void)CsrMsgConvInit();\r\nCsrWifiRouterConverterInit();\r\nCsrWifiRouterCtrlConverterInit();\r\nCsrWifiSmeConverterInit();\r\n#ifdef CSR_SUPPORT_WEXT\r\n#ifdef CSR_SUPPORT_WEXT_AP\r\nCsrWifiNmeApConverterInit();\r\n#endif\r\n#endif\r\n}\r\nvoid CsrWifiRouterTransportRecv(unifi_priv_t *priv, u8* buffer, size_t bufferLength)\r\n{\r\nCsrMsgConvMsgEntry* msgEntry;\r\nu16 primType;\r\nCsrSchedQid src;\r\nCsrSchedQid dest;\r\nu16 msgType;\r\nsize_t offset = 0;\r\nCsrWifiFsmEvent* msg;\r\nCsrUint16Des(&primType, buffer, &offset);\r\nCsrUint16Des(&src, buffer, &offset);\r\nCsrUint16Des(&dest, buffer, &offset);\r\nCsrUint16Des(&msgType, buffer, &offset);\r\noffset -= 2;\r\nunifi_trace(priv, UDBG4, "CsrWifiRouterTransportRecv: primType=0x%.4X, msgType=0x%.4X, bufferLength=%d\n",\r\nprimType, msgType, bufferLength);\r\nif (primType == CSR_WIFI_HOSTIO_PRIM)\r\n{\r\nCsrWifiRouterCtrlHipReq req = {{CSR_WIFI_ROUTER_CTRL_HIP_REQ, CSR_WIFI_ROUTER_CTRL_PRIM, dest, src, NULL}, 0, NULL, 0, NULL, 0, NULL};\r\nreq.mlmeCommandLength = bufferLength;\r\nreq.mlmeCommand = buffer;\r\noffset += 8;\r\nCsrUint16Des(&req.dataRef1Length, buffer, &offset);\r\noffset += 2;\r\nCsrUint16Des(&req.dataRef2Length, buffer, &offset);\r\nif (req.dataRef1Length)\r\n{\r\nu16 dr1Offset = (bufferLength - req.dataRef2Length) - req.dataRef1Length;\r\nreq.dataRef1 = &buffer[dr1Offset];\r\n}\r\nif (req.dataRef2Length)\r\n{\r\nu16 dr2Offset = bufferLength - req.dataRef2Length;\r\nreq.dataRef2 = &buffer[dr2Offset];\r\n}\r\nreq.mlmeCommandLength -= (req.dataRef1Length + req.dataRef2Length + 6);\r\nreq.mlmeCommand = &buffer[6];\r\nCsrWifiRouterCtrlHipReqHandler(priv, &req.common);\r\nreturn;\r\n}\r\nmsgEntry = CsrMsgConvFindEntry(primType, msgType);\r\nif (!msgEntry)\r\n{\r\nunifi_error(priv, "CsrWifiRouterTransportDeserialiseAndSend can not process the message. primType=0x%.4X, msgType=0x%.4X\n",\r\nprimType, msgType);\r\ndump(buffer, bufferLength);\r\nreturn;\r\n}\r\nmsg = (CsrWifiFsmEvent*)(msgEntry->deserFunc)(&buffer[offset], bufferLength - offset);\r\nmsg->primtype = primType;\r\nmsg->type = msgType;\r\nmsg->source = src;\r\nmsg->destination = dest;\r\nswitch(primType)\r\n{\r\ncase CSR_WIFI_ROUTER_CTRL_PRIM:\r\nCsrWifiRouterCtrlDownstreamStateHandlers[msg->type - CSR_WIFI_ROUTER_CTRL_PRIM_DOWNSTREAM_LOWEST](priv, msg);\r\nCsrWifiRouterCtrlFreeDownstreamMessageContents(CSR_WIFI_ROUTER_CTRL_PRIM, msg);\r\nbreak;\r\ncase CSR_WIFI_ROUTER_PRIM:\r\nCsrWifiRouterDownstreamStateHandlers[msg->type - CSR_WIFI_ROUTER_PRIM_DOWNSTREAM_LOWEST](priv, msg);\r\nCsrWifiRouterFreeDownstreamMessageContents(CSR_WIFI_ROUTER_PRIM, msg);\r\nbreak;\r\ncase CSR_WIFI_SME_PRIM:\r\nCsrWifiSmeUpstreamStateHandlers[msg->type - CSR_WIFI_SME_PRIM_UPSTREAM_LOWEST](priv, msg);\r\nCsrWifiSmeFreeUpstreamMessageContents(CSR_WIFI_SME_PRIM, msg);\r\nbreak;\r\n#ifdef CSR_SUPPORT_WEXT\r\n#ifdef CSR_SUPPORT_WEXT_AP\r\ncase CSR_WIFI_NME_AP_PRIM:\r\nCsrWifiNmeApUpstreamStateHandlers(priv, msg);\r\nCsrWifiNmeApFreeUpstreamMessageContents(CSR_WIFI_NME_AP_PRIM, msg);\r\nbreak;\r\n#endif\r\n#endif\r\ndefault:\r\nunifi_error(priv, "CsrWifiRouterTransportDeserialiseAndSend unhandled prim type 0x%.4X\n", primType);\r\nbreak;\r\n}\r\nkfree(msg);\r\n}\r\nstatic void CsrWifiRouterTransportSerialiseAndSend(u16 primType, void* msg)\r\n{\r\nCsrWifiFsmEvent* evt = (CsrWifiFsmEvent*)msg;\r\nCsrMsgConvMsgEntry* msgEntry;\r\nsize_t msgSize;\r\nsize_t encodeBufferLen = 0;\r\nsize_t offset = 0;\r\nu8* encodeBuffer;\r\nunifi_trace(drvpriv, UDBG4, "CsrWifiRouterTransportSerialiseAndSend: primType=0x%.4X, msgType=0x%.4X\n",\r\nprimType, evt->type);\r\nmsgEntry = CsrMsgConvFindEntry(primType, evt->type);\r\nif (!msgEntry)\r\n{\r\nunifi_error(drvpriv, "CsrWifiRouterTransportSerialiseAndSend can not process the message. primType=0x%.4X, msgType=0x%.4X\n",\r\nprimType, evt->type);\r\nreturn;\r\n}\r\nmsgSize = 6 + (msgEntry->sizeofFunc)((void*)msg);\r\nencodeBuffer = kmalloc(msgSize, GFP_KERNEL);\r\nCsrUint16Ser(encodeBuffer, &encodeBufferLen, primType);\r\nCsrUint16Ser(encodeBuffer, &encodeBufferLen, evt->source);\r\nCsrUint16Ser(encodeBuffer, &encodeBufferLen, evt->destination);\r\n(void)(msgEntry->serFunc)(&encodeBuffer[encodeBufferLen], &offset, msg);\r\nencodeBufferLen += offset;\r\nuf_sme_queue_message(drvpriv, encodeBuffer, encodeBufferLen);\r\nkfree(msg);\r\n}

static void cmd640_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct cmd640_reg *timing = ap->private_data;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nstruct ata_timing t;\r\nconst unsigned long T = 1000000 / 33;\r\nconst u8 setup_data[] = { 0x40, 0x40, 0x40, 0x80, 0x00 };\r\nu8 reg;\r\nint arttim = ARTIM0 + 2 * adev->devno;\r\nstruct ata_device *pair = ata_dev_pair(adev);\r\nif (ata_timing_compute(adev, adev->pio_mode, &t, T, 0) < 0) {\r\nprintk(KERN_ERR DRV_NAME ": mode computation failed.\n");\r\nreturn;\r\n}\r\nif (ap->port_no && pair) {\r\nstruct ata_timing p;\r\nata_timing_compute(pair, pair->pio_mode, &p, T, 1);\r\nata_timing_merge(&p, &t, &t, ATA_TIMING_SETUP);\r\n}\r\nif (t.recover > 16) {\r\nt.active += t.recover - 16;\r\nt.recover = 16;\r\n}\r\nif (t.active > 16)\r\nt.active = 16;\r\nif (t.recover > 1)\r\nt.recover--;\r\nelse\r\nt.recover = 15;\r\nif (t.setup > 4)\r\nt.setup = 0xC0;\r\nelse\r\nt.setup = setup_data[t.setup];\r\nif (ap->port_no == 0) {\r\nt.active &= 0x0F;\r\npci_read_config_byte(pdev, arttim, &reg);\r\nreg &= 0x3F;\r\nreg |= t.setup;\r\npci_write_config_byte(pdev, arttim, reg);\r\npci_write_config_byte(pdev, arttim + 1, (t.active << 4) | t.recover);\r\n} else {\r\npci_read_config_byte(pdev, ARTIM23, &reg);\r\nreg &= 0x3F;\r\nreg |= t.setup;\r\npci_write_config_byte(pdev, ARTIM23, reg);\r\ntiming->reg58[adev->devno] = (t.active << 4) | t.recover;\r\n}\r\n}\r\nstatic unsigned int cmd640_qc_issue(struct ata_queued_cmd *qc)\r\n{\r\nstruct ata_port *ap = qc->ap;\r\nstruct ata_device *adev = qc->dev;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nstruct cmd640_reg *timing = ap->private_data;\r\nif (ap->port_no != 0 && adev->devno != timing->last) {\r\npci_write_config_byte(pdev, DRWTIM23, timing->reg58[adev->devno]);\r\ntiming->last = adev->devno;\r\n}\r\nreturn ata_sff_qc_issue(qc);\r\n}\r\nstatic int cmd640_port_start(struct ata_port *ap)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nstruct cmd640_reg *timing;\r\ntiming = devm_kzalloc(&pdev->dev, sizeof(struct cmd640_reg), GFP_KERNEL);\r\nif (timing == NULL)\r\nreturn -ENOMEM;\r\ntiming->last = -1;\r\nap->private_data = timing;\r\nreturn 0;\r\n}\r\nstatic bool cmd640_sff_irq_check(struct ata_port *ap)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint irq_reg = ap->port_no ? ARTIM23 : CFR;\r\nu8 irq_stat, irq_mask = ap->port_no ? 0x10 : 0x04;\r\npci_read_config_byte(pdev, irq_reg, &irq_stat);\r\nreturn irq_stat & irq_mask;\r\n}\r\nstatic void cmd640_hardware_init(struct pci_dev *pdev)\r\n{\r\nu8 ctrl;\r\npci_write_config_byte(pdev, 0x5B, 0x00);\r\npci_write_config_byte(pdev, CMDTIM, 0);\r\npci_write_config_byte(pdev, BRST, 0x40);\r\npci_read_config_byte(pdev, CNTRL, &ctrl);\r\npci_write_config_byte(pdev, CNTRL, ctrl | 0xC0);\r\npci_read_config_byte(pdev, ARTIM23, &ctrl);\r\nctrl |= 0x0C;\r\npci_write_config_byte(pdev, ARTIM23, ctrl);\r\n}\r\nstatic int cmd640_init_one(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.port_ops = &cmd640_port_ops\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, NULL };\r\nint rc;\r\nrc = pcim_enable_device(pdev);\r\nif (rc)\r\nreturn rc;\r\ncmd640_hardware_init(pdev);\r\nreturn ata_pci_sff_init_one(pdev, ppi, &cmd640_sht, NULL, 0);\r\n}\r\nstatic int cmd640_reinit_one(struct pci_dev *pdev)\r\n{\r\nstruct ata_host *host = dev_get_drvdata(&pdev->dev);\r\nint rc;\r\nrc = ata_pci_device_do_resume(pdev);\r\nif (rc)\r\nreturn rc;\r\ncmd640_hardware_init(pdev);\r\nata_host_resume(host);\r\nreturn 0;\r\n}

static inline const char *get_mclk_str(enum mclk mclk_sel)\r\n{\r\nswitch (mclk_sel) {\r\ncase MCLK_SYSCLK:\r\nreturn "SYSCLK";\r\ncase MCLK_ULPCLK:\r\nreturn "ULPCLK";\r\ndefault:\r\nreturn "Unknown";\r\n}\r\n}\r\nstatic int mop500_ab8500_set_mclk(struct device *dev,\r\nstruct mop500_ab8500_drvdata *drvdata)\r\n{\r\nint status;\r\nstruct clk *clk_ptr;\r\nif (IS_ERR(drvdata->clk_ptr_intclk)) {\r\ndev_err(dev,\r\n"%s: ERROR: intclk not initialized!\n", __func__);\r\nreturn -EIO;\r\n}\r\nswitch (drvdata->mclk_sel) {\r\ncase MCLK_SYSCLK:\r\nclk_ptr = drvdata->clk_ptr_sysclk;\r\nbreak;\r\ncase MCLK_ULPCLK:\r\nclk_ptr = drvdata->clk_ptr_ulpclk;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (IS_ERR(clk_ptr)) {\r\ndev_err(dev, "%s: ERROR: %s not initialized!\n", __func__,\r\nget_mclk_str(drvdata->mclk_sel));\r\nreturn -EIO;\r\n}\r\nstatus = clk_set_parent(drvdata->clk_ptr_intclk, clk_ptr);\r\nif (status)\r\ndev_err(dev,\r\n"%s: ERROR: Setting intclk parent to %s failed (ret = %d)!",\r\n__func__, get_mclk_str(drvdata->mclk_sel), status);\r\nelse\r\ndev_dbg(dev,\r\n"%s: intclk parent changed to %s.\n",\r\n__func__, get_mclk_str(drvdata->mclk_sel));\r\nreturn status;\r\n}\r\nstatic int mclk_input_control_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_kcontrol_chip(kcontrol);\r\nstruct mop500_ab8500_drvdata *drvdata =\r\nsnd_soc_card_get_drvdata(codec->card);\r\nucontrol->value.enumerated.item[0] = drvdata->mclk_sel;\r\nreturn 0;\r\n}\r\nstatic int mclk_input_control_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_kcontrol_chip(kcontrol);\r\nstruct mop500_ab8500_drvdata *drvdata =\r\nsnd_soc_card_get_drvdata(codec->card);\r\nunsigned int val = ucontrol->value.enumerated.item[0];\r\nif (val > (unsigned int)MCLK_ULPCLK)\r\nreturn -EINVAL;\r\nif (drvdata->mclk_sel == val)\r\nreturn 0;\r\ndrvdata->mclk_sel = val;\r\nreturn 1;\r\n}\r\nint mop500_ab8500_startup(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nreturn mop500_ab8500_set_mclk(rtd->card->dev,\r\nsnd_soc_card_get_drvdata(rtd->card));\r\n}\r\nvoid mop500_ab8500_shutdown(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct device *dev = rtd->card->dev;\r\ndev_dbg(dev, "%s: Enter\n", __func__);\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\ntx_slots = DEF_TX_SLOTS;\r\nelse\r\nrx_slots = DEF_RX_SLOTS;\r\n}\r\nint mop500_ab8500_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nstruct device *dev = rtd->card->dev;\r\nunsigned int fmt;\r\nint channels, ret = 0, driver_mode, slots;\r\nunsigned int sw_codec, sw_cpu;\r\nbool is_playback;\r\ndev_dbg(dev, "%s: Enter\n", __func__);\r\ndev_dbg(dev, "%s: substream->pcm->name = %s\n"\r\n"substream->pcm->id = %s.\n"\r\n"substream->name = %s.\n"\r\n"substream->number = %d.\n",\r\n__func__,\r\nsubstream->pcm->name,\r\nsubstream->pcm->id,\r\nsubstream->name,\r\nsubstream->number);\r\nchannels = params_channels(params);\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S32_LE:\r\nsw_cpu = 32;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\nsw_cpu = 16;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (channels == 8)\r\ndriver_mode = DRIVERMODE_CODEC_ONLY;\r\nelse\r\ndriver_mode = DRIVERMODE_NORMAL;\r\ndev_dbg(dev, "%s: Driver-mode: %s.\n", __func__,\r\n(driver_mode == DRIVERMODE_NORMAL) ? "NORMAL" : "CODEC_ONLY");\r\nif (driver_mode == DRIVERMODE_NORMAL) {\r\nfmt = SND_SOC_DAIFMT_DSP_A |\r\nSND_SOC_DAIFMT_CBM_CFM |\r\nSND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CONT;\r\n} else {\r\nfmt = SND_SOC_DAIFMT_DSP_A |\r\nSND_SOC_DAIFMT_CBM_CFM |\r\nSND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_GATED;\r\n}\r\nret = snd_soc_dai_set_fmt(codec_dai, fmt);\r\nif (ret < 0) {\r\ndev_err(dev,\r\n"%s: ERROR: snd_soc_dai_set_fmt failed for codec_dai (ret = %d)!\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_fmt(cpu_dai, fmt);\r\nif (ret < 0) {\r\ndev_err(dev,\r\n"%s: ERROR: snd_soc_dai_set_fmt failed for cpu_dai (ret = %d)!\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\nis_playback = (substream->stream == SNDRV_PCM_STREAM_PLAYBACK);\r\nswitch (channels) {\r\ncase 1:\r\nslots = 16;\r\ntx_slots = (is_playback) ? TX_SLOT_MONO : 0;\r\nrx_slots = (is_playback) ? 0 : RX_SLOT_MONO;\r\nbreak;\r\ncase 2:\r\nslots = 16;\r\ntx_slots = (is_playback) ? TX_SLOT_STEREO : 0;\r\nrx_slots = (is_playback) ? 0 : RX_SLOT_STEREO;\r\nbreak;\r\ncase 8:\r\nslots = 16;\r\ntx_slots = (is_playback) ? TX_SLOT_8CH : 0;\r\nrx_slots = (is_playback) ? 0 : RX_SLOT_8CH;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (driver_mode == DRIVERMODE_NORMAL)\r\nsw_codec = sw_cpu;\r\nelse\r\nsw_codec = 20;\r\ndev_dbg(dev, "%s: CPU-DAI TDM: TX=0x%04X RX=0x%04x\n", __func__,\r\ntx_slots, rx_slots);\r\nret = snd_soc_dai_set_tdm_slot(cpu_dai, tx_slots, rx_slots, slots,\r\nsw_cpu);\r\nif (ret)\r\nreturn ret;\r\ndev_dbg(dev, "%s: CODEC-DAI TDM: TX=0x%04X RX=0x%04x\n", __func__,\r\ntx_slots, rx_slots);\r\nret = snd_soc_dai_set_tdm_slot(codec_dai, tx_slots, rx_slots, slots,\r\nsw_codec);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint mop500_ab8500_machine_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct device *dev = rtd->card->dev;\r\nstruct mop500_ab8500_drvdata *drvdata;\r\nint ret;\r\ndev_dbg(dev, "%s Enter.\n", __func__);\r\ndrvdata = devm_kzalloc(dev, sizeof(struct mop500_ab8500_drvdata),\r\nGFP_KERNEL);\r\nsnd_soc_card_set_drvdata(rtd->card, drvdata);\r\ndrvdata->clk_ptr_sysclk = clk_get(dev, "sysclk");\r\nif (IS_ERR(drvdata->clk_ptr_sysclk))\r\ndev_warn(dev, "%s: WARNING: clk_get failed for 'sysclk'!\n",\r\n__func__);\r\ndrvdata->clk_ptr_ulpclk = clk_get(dev, "ulpclk");\r\nif (IS_ERR(drvdata->clk_ptr_ulpclk))\r\ndev_warn(dev, "%s: WARNING: clk_get failed for 'ulpclk'!\n",\r\n__func__);\r\ndrvdata->clk_ptr_intclk = clk_get(dev, "intclk");\r\nif (IS_ERR(drvdata->clk_ptr_intclk))\r\ndev_warn(dev, "%s: WARNING: clk_get failed for 'intclk'!\n",\r\n__func__);\r\ndrvdata->mclk_sel = MCLK_ULPCLK;\r\nret = mop500_ab8500_set_mclk(dev, drvdata);\r\nif (ret < 0)\r\ndev_warn(dev, "%s: WARNING: mop500_ab8500_set_mclk!\n",\r\n__func__);\r\ndrvdata->mclk_sel = MCLK_ULPCLK;\r\nret = snd_soc_add_codec_controls(codec, mop500_ab8500_ctrls,\r\nARRAY_SIZE(mop500_ab8500_ctrls));\r\nif (ret < 0) {\r\npr_err("%s: Failed to add machine-controls (%d)!\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dapm_disable_pin(&codec->dapm, "Earpiece");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "Speaker Left");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "Speaker Right");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "LineOut Left");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "LineOut Right");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "Vibra 1");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "Vibra 2");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "Mic 1");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "Mic 2");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "LineIn Left");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "LineIn Right");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "DMic 1");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "DMic 2");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "DMic 3");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "DMic 4");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "DMic 5");\r\nret |= snd_soc_dapm_disable_pin(&codec->dapm, "DMic 6");\r\nreturn ret;\r\n}\r\nvoid mop500_ab8500_remove(struct snd_soc_card *card)\r\n{\r\nstruct mop500_ab8500_drvdata *drvdata = snd_soc_card_get_drvdata(card);\r\nif (drvdata->clk_ptr_sysclk != NULL)\r\nclk_put(drvdata->clk_ptr_sysclk);\r\nif (drvdata->clk_ptr_ulpclk != NULL)\r\nclk_put(drvdata->clk_ptr_ulpclk);\r\nif (drvdata->clk_ptr_intclk != NULL)\r\nclk_put(drvdata->clk_ptr_intclk);\r\nsnd_soc_card_set_drvdata(card, drvdata);\r\n}

static inline int SCALE(long val, int mul, int div)\r\n{\r\nif (val < 0)\r\nreturn (val * mul - div / 2) / div;\r\nelse\r\nreturn (val * mul + div / 2) / div;\r\n}\r\nstatic inline unsigned int IN_FROM_REG(u8 reg, int n)\r\n{\r\nreturn SCALE(reg, nom_mv[n], 192);\r\n}\r\nstatic inline u8 IN_TO_REG(unsigned long val, int n)\r\n{\r\nreturn SENSORS_LIMIT(SCALE(val, 192, nom_mv[n]), 0, 255);\r\n}\r\nstatic inline s8 TEMP_TO_REG(int val)\r\n{\r\nreturn SENSORS_LIMIT(SCALE(val, 1, 1000), -128000, 127000);\r\n}\r\nstatic inline int TEMP_FROM_REG(s8 val)\r\n{\r\nreturn val * 1000;\r\n}\r\nstatic ssize_t show_in(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct smsc47m192_data *data = smsc47m192_update_device(dev);\r\nreturn sprintf(buf, "%d\n", IN_FROM_REG(data->in[nr], nr));\r\n}\r\nstatic ssize_t show_in_min(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct smsc47m192_data *data = smsc47m192_update_device(dev);\r\nreturn sprintf(buf, "%d\n", IN_FROM_REG(data->in_min[nr], nr));\r\n}\r\nstatic ssize_t show_in_max(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct smsc47m192_data *data = smsc47m192_update_device(dev);\r\nreturn sprintf(buf, "%d\n", IN_FROM_REG(data->in_max[nr], nr));\r\n}\r\nstatic ssize_t set_in_min(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct smsc47m192_data *data = i2c_get_clientdata(client);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_min[nr] = IN_TO_REG(val, nr);\r\ni2c_smbus_write_byte_data(client, SMSC47M192_REG_IN_MIN(nr),\r\ndata->in_min[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_in_max(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct smsc47m192_data *data = i2c_get_clientdata(client);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_max[nr] = IN_TO_REG(val, nr);\r\ni2c_smbus_write_byte_data(client, SMSC47M192_REG_IN_MAX(nr),\r\ndata->in_max[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_temp(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct smsc47m192_data *data = smsc47m192_update_device(dev);\r\nreturn sprintf(buf, "%d\n", TEMP_FROM_REG(data->temp[nr]));\r\n}\r\nstatic ssize_t show_temp_min(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct smsc47m192_data *data = smsc47m192_update_device(dev);\r\nreturn sprintf(buf, "%d\n", TEMP_FROM_REG(data->temp_min[nr]));\r\n}\r\nstatic ssize_t show_temp_max(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct smsc47m192_data *data = smsc47m192_update_device(dev);\r\nreturn sprintf(buf, "%d\n", TEMP_FROM_REG(data->temp_max[nr]));\r\n}\r\nstatic ssize_t set_temp_min(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct smsc47m192_data *data = i2c_get_clientdata(client);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->temp_min[nr] = TEMP_TO_REG(val);\r\ni2c_smbus_write_byte_data(client, SMSC47M192_REG_TEMP_MIN[nr],\r\ndata->temp_min[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_temp_max(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct smsc47m192_data *data = i2c_get_clientdata(client);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->temp_max[nr] = TEMP_TO_REG(val);\r\ni2c_smbus_write_byte_data(client, SMSC47M192_REG_TEMP_MAX[nr],\r\ndata->temp_max[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_temp_offset(struct device *dev, struct device_attribute\r\n*attr, char *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct smsc47m192_data *data = smsc47m192_update_device(dev);\r\nreturn sprintf(buf, "%d\n", TEMP_FROM_REG(data->temp_offset[nr]));\r\n}\r\nstatic ssize_t set_temp_offset(struct device *dev, struct device_attribute\r\n*attr, const char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct smsc47m192_data *data = i2c_get_clientdata(client);\r\nu8 sfr = i2c_smbus_read_byte_data(client, SMSC47M192_REG_SFR);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->temp_offset[nr] = TEMP_TO_REG(val);\r\nif (nr > 1)\r\ni2c_smbus_write_byte_data(client,\r\nSMSC47M192_REG_TEMP_OFFSET(nr), data->temp_offset[nr]);\r\nelse if (data->temp_offset[nr] != 0) {\r\ni2c_smbus_write_byte_data(client, SMSC47M192_REG_SFR,\r\n(sfr & 0xef) | (nr == 0 ? 0x10 : 0));\r\ndata->temp_offset[1-nr] = 0;\r\ni2c_smbus_write_byte_data(client,\r\nSMSC47M192_REG_TEMP_OFFSET(nr), data->temp_offset[nr]);\r\n} else if ((sfr & 0x10) == (nr == 0 ? 0x10 : 0))\r\ni2c_smbus_write_byte_data(client,\r\nSMSC47M192_REG_TEMP_OFFSET(nr), 0);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_vid(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct smsc47m192_data *data = smsc47m192_update_device(dev);\r\nreturn sprintf(buf, "%d\n", vid_from_reg(data->vid, data->vrm));\r\n}\r\nstatic ssize_t show_vrm(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct smsc47m192_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n", data->vrm);\r\n}\r\nstatic ssize_t set_vrm(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct smsc47m192_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\ndata->vrm = val;\r\nreturn count;\r\n}\r\nstatic ssize_t show_alarm(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct smsc47m192_data *data = smsc47m192_update_device(dev);\r\nreturn sprintf(buf, "%u\n", (data->alarms & nr) ? 1 : 0);\r\n}\r\nstatic void smsc47m192_init_client(struct i2c_client *client)\r\n{\r\nint i;\r\nu8 config = i2c_smbus_read_byte_data(client, SMSC47M192_REG_CONFIG);\r\nu8 sfr = i2c_smbus_read_byte_data(client, SMSC47M192_REG_SFR);\r\ni2c_smbus_write_byte_data(client, SMSC47M192_REG_SFR,\r\n(sfr & 0xfd) | 0x02);\r\nif (!(config & 0x01)) {\r\nfor (i = 0; i < 8; i++) {\r\ni2c_smbus_write_byte_data(client,\r\nSMSC47M192_REG_IN_MIN(i), 0);\r\ni2c_smbus_write_byte_data(client,\r\nSMSC47M192_REG_IN_MAX(i), 0xff);\r\n}\r\nfor (i = 0; i < 3; i++) {\r\ni2c_smbus_write_byte_data(client,\r\nSMSC47M192_REG_TEMP_MIN[i], 0x80);\r\ni2c_smbus_write_byte_data(client,\r\nSMSC47M192_REG_TEMP_MAX[i], 0x7f);\r\n}\r\ni2c_smbus_write_byte_data(client, SMSC47M192_REG_CONFIG,\r\n(config & 0xf7) | 0x01);\r\n}\r\n}\r\nstatic int smsc47m192_detect(struct i2c_client *client,\r\nstruct i2c_board_info *info)\r\n{\r\nstruct i2c_adapter *adapter = client->adapter;\r\nint version;\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -ENODEV;\r\nversion = i2c_smbus_read_byte_data(client, SMSC47M192_REG_VERSION);\r\nif (i2c_smbus_read_byte_data(client,\r\nSMSC47M192_REG_COMPANY_ID) == 0x55\r\n&& (version & 0xf0) == 0x20\r\n&& (i2c_smbus_read_byte_data(client,\r\nSMSC47M192_REG_VID) & 0x70) == 0x00\r\n&& (i2c_smbus_read_byte_data(client,\r\nSMSC47M192_REG_VID4) & 0xfe) == 0x80) {\r\ndev_info(&adapter->dev,\r\n"found SMSC47M192 or compatible, "\r\n"version 2, stepping A%d\n", version & 0x0f);\r\n} else {\r\ndev_dbg(&adapter->dev,\r\n"SMSC47M192 detection failed at 0x%02x\n",\r\nclient->addr);\r\nreturn -ENODEV;\r\n}\r\nstrlcpy(info->type, "smsc47m192", I2C_NAME_SIZE);\r\nreturn 0;\r\n}\r\nstatic int smsc47m192_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct smsc47m192_data *data;\r\nint config;\r\nint err;\r\ndata = devm_kzalloc(&client->dev, sizeof(struct smsc47m192_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, data);\r\ndata->vrm = vid_which_vrm();\r\nmutex_init(&data->update_lock);\r\nsmsc47m192_init_client(client);\r\nerr = sysfs_create_group(&client->dev.kobj, &smsc47m192_group);\r\nif (err)\r\nreturn err;\r\nconfig = i2c_smbus_read_byte_data(client, SMSC47M192_REG_CONFIG);\r\nif (!(config & 0x20)) {\r\nerr = sysfs_create_group(&client->dev.kobj,\r\n&smsc47m192_group_in4);\r\nif (err)\r\ngoto exit_remove_files;\r\n}\r\ndata->hwmon_dev = hwmon_device_register(&client->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto exit_remove_files;\r\n}\r\nreturn 0;\r\nexit_remove_files:\r\nsysfs_remove_group(&client->dev.kobj, &smsc47m192_group);\r\nsysfs_remove_group(&client->dev.kobj, &smsc47m192_group_in4);\r\nreturn err;\r\n}\r\nstatic int smsc47m192_remove(struct i2c_client *client)\r\n{\r\nstruct smsc47m192_data *data = i2c_get_clientdata(client);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nsysfs_remove_group(&client->dev.kobj, &smsc47m192_group);\r\nsysfs_remove_group(&client->dev.kobj, &smsc47m192_group_in4);\r\nreturn 0;\r\n}\r\nstatic struct smsc47m192_data *smsc47m192_update_device(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct smsc47m192_data *data = i2c_get_clientdata(client);\r\nint i, config;\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->last_updated + HZ + HZ / 2)\r\n|| !data->valid) {\r\nu8 sfr = i2c_smbus_read_byte_data(client, SMSC47M192_REG_SFR);\r\ndev_dbg(&client->dev, "Starting smsc47m192 update\n");\r\nfor (i = 0; i <= 7; i++) {\r\ndata->in[i] = i2c_smbus_read_byte_data(client,\r\nSMSC47M192_REG_IN(i));\r\ndata->in_min[i] = i2c_smbus_read_byte_data(client,\r\nSMSC47M192_REG_IN_MIN(i));\r\ndata->in_max[i] = i2c_smbus_read_byte_data(client,\r\nSMSC47M192_REG_IN_MAX(i));\r\n}\r\nfor (i = 0; i < 3; i++) {\r\ndata->temp[i] = i2c_smbus_read_byte_data(client,\r\nSMSC47M192_REG_TEMP[i]);\r\ndata->temp_max[i] = i2c_smbus_read_byte_data(client,\r\nSMSC47M192_REG_TEMP_MAX[i]);\r\ndata->temp_min[i] = i2c_smbus_read_byte_data(client,\r\nSMSC47M192_REG_TEMP_MIN[i]);\r\n}\r\nfor (i = 1; i < 3; i++)\r\ndata->temp_offset[i] = i2c_smbus_read_byte_data(client,\r\nSMSC47M192_REG_TEMP_OFFSET(i));\r\nif (sfr & 0x10) {\r\ndata->temp_offset[0] = data->temp_offset[1];\r\ndata->temp_offset[1] = 0;\r\n} else\r\ndata->temp_offset[0] = 0;\r\ndata->vid = i2c_smbus_read_byte_data(client, SMSC47M192_REG_VID)\r\n& 0x0f;\r\nconfig = i2c_smbus_read_byte_data(client,\r\nSMSC47M192_REG_CONFIG);\r\nif (config & 0x20)\r\ndata->vid |= (i2c_smbus_read_byte_data(client,\r\nSMSC47M192_REG_VID4) & 0x01) << 4;\r\ndata->alarms = i2c_smbus_read_byte_data(client,\r\nSMSC47M192_REG_ALARM1) |\r\n(i2c_smbus_read_byte_data(client,\r\nSMSC47M192_REG_ALARM2) << 8);\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\n}\r\nmutex_unlock(&data->update_lock);\r\nreturn data;\r\n}

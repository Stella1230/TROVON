static void __init spitz_scoop_init(void)\r\n{\r\nplatform_device_register(&spitz_scoop_1_device);\r\nif (!machine_is_akita())\r\nplatform_device_register(&spitz_scoop_2_device);\r\n}\r\nstatic void spitz_card_pwr_ctrl(uint8_t enable, uint8_t new_cpr)\r\n{\r\nunsigned short cpr;\r\nunsigned long flags;\r\nif (new_cpr & 0x7) {\r\ngpio_set_value(SPITZ_GPIO_CF_POWER, 1);\r\nmdelay(5);\r\n}\r\nlocal_irq_save(flags);\r\ncpr = read_scoop_reg(&spitz_scoop_1_device.dev, SCOOP_CPR);\r\nif (enable & new_cpr)\r\ncpr |= new_cpr;\r\nelse\r\ncpr &= ~enable;\r\nwrite_scoop_reg(&spitz_scoop_1_device.dev, SCOOP_CPR, cpr);\r\nlocal_irq_restore(flags);\r\nif (!(cpr & 0x7)) {\r\nmdelay(1);\r\ngpio_set_value(SPITZ_GPIO_CF_POWER, 0);\r\n}\r\n}\r\nstatic inline void spitz_scoop_init(void) {}\r\nstatic inline void spitz_card_pwr_ctrl(uint8_t enable, uint8_t new_cpr) {}\r\nstatic void spitz_pcmcia_pwr(struct device *scoop, uint16_t cpr, int nr)\r\n{\r\nif (nr == 0)\r\nspitz_card_pwr_ctrl(\r\ncpr & (SCOOP_CPR_CF_3V | SCOOP_CPR_CF_XV), cpr);\r\nelse\r\nwrite_scoop_reg(scoop, SCOOP_CPR, cpr);\r\n}\r\nstatic void __init spitz_pcmcia_init(void)\r\n{\r\nif (machine_is_akita())\r\nspitz_pcmcia_config.num_devs = 1;\r\nplatform_scoop_config = &spitz_pcmcia_config;\r\n}\r\nstatic inline void spitz_pcmcia_init(void) {}\r\nstatic void __init spitz_mkp_init(void)\r\n{\r\nplatform_device_register(&spitz_mkp_device);\r\n}\r\nstatic inline void spitz_mkp_init(void) {}\r\nstatic void __init spitz_keys_init(void)\r\n{\r\nplatform_device_register(&spitz_gpio_keys_device);\r\n}\r\nstatic inline void spitz_keys_init(void) {}\r\nstatic void __init spitz_leds_init(void)\r\n{\r\nplatform_device_register(&spitz_led_device);\r\n}\r\nstatic inline void spitz_leds_init(void) {}\r\nstatic void spitz_ads7846_wait_for_hsync(void)\r\n{\r\nwhile (gpio_get_value(SPITZ_GPIO_HSYNC))\r\ncpu_relax();\r\nwhile (!gpio_get_value(SPITZ_GPIO_HSYNC))\r\ncpu_relax();\r\n}\r\nstatic void spitz_bl_kick_battery(void)\r\n{\r\nvoid (*kick_batt)(void);\r\nkick_batt = symbol_get(sharpsl_battery_kick);\r\nif (kick_batt) {\r\nkick_batt();\r\nsymbol_put(sharpsl_battery_kick);\r\n}\r\n}\r\nstatic void __init spitz_spi_init(void)\r\n{\r\nstruct corgi_lcd_platform_data *lcd_data = &spitz_lcdcon_info;\r\nif (machine_is_akita()) {\r\nlcd_data->gpio_backlight_cont = AKITA_GPIO_BACKLIGHT_CONT;\r\nlcd_data->gpio_backlight_on = AKITA_GPIO_BACKLIGHT_ON;\r\n}\r\npxa2xx_set_spi_info(2, &spitz_spi_info);\r\nspi_register_board_info(ARRAY_AND_SIZE(spitz_spi_devices));\r\n}\r\nstatic inline void spitz_spi_init(void) {}\r\nstatic void spitz_mci_setpower(struct device *dev, unsigned int vdd)\r\n{\r\nstruct pxamci_platform_data* p_d = dev->platform_data;\r\nif ((1 << vdd) & p_d->ocr_mask)\r\nspitz_card_pwr_ctrl(SCOOP_CPR_SD_3V, SCOOP_CPR_SD_3V);\r\nelse\r\nspitz_card_pwr_ctrl(SCOOP_CPR_SD_3V, 0x0);\r\n}\r\nstatic void __init spitz_mmc_init(void)\r\n{\r\npxa_set_mci_info(&spitz_mci_platform_data);\r\n}\r\nstatic inline void spitz_mmc_init(void) {}\r\nstatic int spitz_ohci_init(struct device *dev)\r\n{\r\nint err;\r\nerr = gpio_request(SPITZ_GPIO_USB_HOST, "USB_HOST");\r\nif (err)\r\nreturn err;\r\nUP2OCR = UP2OCR_HXS | UP2OCR_HXOE | UP2OCR_DPPDE | UP2OCR_DMPDE;\r\nreturn gpio_direction_output(SPITZ_GPIO_USB_HOST, 1);\r\n}\r\nstatic void spitz_ohci_exit(struct device *dev)\r\n{\r\ngpio_free(SPITZ_GPIO_USB_HOST);\r\n}\r\nstatic void __init spitz_uhc_init(void)\r\n{\r\npxa_set_ohci_info(&spitz_ohci_platform_data);\r\n}\r\nstatic inline void spitz_uhc_init(void) {}\r\nstatic void __init spitz_irda_init(void)\r\n{\r\nif (machine_is_akita())\r\nspitz_ficp_platform_data.gpio_pwdown = AKITA_GPIO_IR_ON;\r\nelse\r\nspitz_ficp_platform_data.gpio_pwdown = SPITZ_GPIO_IR_ON;\r\npxa_set_ficp_info(&spitz_ficp_platform_data);\r\n}\r\nstatic inline void spitz_irda_init(void) {}\r\nstatic void __init spitz_lcd_init(void)\r\n{\r\npxa_set_fb_info(NULL, &spitz_pxafb_info);\r\n}\r\nstatic inline void spitz_lcd_init(void) {}\r\nstatic void __init spitz_nand_init(void)\r\n{\r\nif (machine_is_spitz()) {\r\nspitz_nand_partitions[1].size = 5 * 1024 * 1024;\r\n} else if (machine_is_akita()) {\r\nspitz_nand_partitions[1].size = 58 * 1024 * 1024;\r\nspitz_nand_bbt.len = 1;\r\nspitz_nand_pdata.ecc_layout = &akita_oobinfo;\r\n} else if (machine_is_borzoi()) {\r\nspitz_nand_partitions[1].size = 32 * 1024 * 1024;\r\nspitz_nand_bbt.len = 1;\r\nspitz_nand_pdata.ecc_layout = &akita_oobinfo;\r\n}\r\nplatform_device_register(&spitz_nand_device);\r\n}\r\nstatic inline void spitz_nand_init(void) {}\r\nstatic void __init spitz_nor_init(void)\r\n{\r\nplatform_device_register(&spitz_rom_device);\r\n}\r\nstatic inline void spitz_nor_init(void) {}\r\nstatic void __init spitz_i2c_init(void)\r\n{\r\nint size = ARRAY_SIZE(spitz_i2c_devs);\r\nif (!machine_is_akita())\r\nsize--;\r\npxa_set_i2c_info(NULL);\r\npxa27x_set_i2c_power_info(NULL);\r\ni2c_register_board_info(0, spitz_i2c_devs, size);\r\ni2c_register_board_info(1, ARRAY_AND_SIZE(spitz_pi2c_devs));\r\n}\r\nstatic inline void spitz_i2c_init(void) {}\r\nstatic void spitz_poweroff(void)\r\n{\r\npxa_restart('g', NULL);\r\n}\r\nstatic void spitz_restart(char mode, const char *cmd)\r\n{\r\nuint32_t msc0 = __raw_readl(MSC0);\r\nif ((msc0 & 0xffff0000) == 0x7ff00000)\r\n__raw_writel((msc0 & 0xffff) | 0x7ee00000, MSC0);\r\nspitz_poweroff();\r\n}\r\nstatic void __init spitz_init(void)\r\n{\r\ninit_gpio_reset(SPITZ_GPIO_ON_RESET, 1, 0);\r\npm_power_off = spitz_poweroff;\r\nPMCR = 0x00;\r\nPCFR |= PCFR_OPDE;\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(spitz_pin_config));\r\npxa_set_ffuart_info(NULL);\r\npxa_set_btuart_info(NULL);\r\npxa_set_stuart_info(NULL);\r\nspitz_spi_init();\r\nspitz_scoop_init();\r\nspitz_mkp_init();\r\nspitz_keys_init();\r\nspitz_leds_init();\r\nspitz_mmc_init();\r\nspitz_pcmcia_init();\r\nspitz_irda_init();\r\nspitz_uhc_init();\r\nspitz_lcd_init();\r\nspitz_nor_init();\r\nspitz_nand_init();\r\nspitz_i2c_init();\r\n}\r\nstatic void __init spitz_fixup(struct tag *tags, char **cmdline,\r\nstruct meminfo *mi)\r\n{\r\nsharpsl_save_param();\r\nmi->nr_banks = 1;\r\nmi->bank[0].start = 0xa0000000;\r\nmi->bank[0].size = (64*1024*1024);\r\n}

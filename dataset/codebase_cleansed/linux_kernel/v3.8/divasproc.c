static ssize_t\r\ndivas_read(struct file *file, char __user *buf, size_t count, loff_t *off)\r\n{\r\nint len = 0;\r\nint cadapter;\r\nchar tmpbuf[80];\r\nchar tmpser[16];\r\nif (*off)\r\nreturn 0;\r\ndivas_get_version(tmpbuf);\r\nif (copy_to_user(buf + len, &tmpbuf, strlen(tmpbuf)))\r\nreturn -EFAULT;\r\nlen += strlen(tmpbuf);\r\nfor (cadapter = 0; cadapter < MAX_ADAPTER; cadapter++) {\r\nif (IoAdapters[cadapter]) {\r\ndiva_get_vserial_number(IoAdapters[cadapter],\r\ntmpser);\r\nsprintf(tmpbuf,\r\n"%2d: %-30s Serial:%-10s IRQ:%2d\n",\r\ncadapter + 1,\r\nIoAdapters[cadapter]->Properties.Name,\r\ntmpser,\r\nIoAdapters[cadapter]->irq_info.irq_nr);\r\nif ((strlen(tmpbuf) + len) > count)\r\nbreak;\r\nif (copy_to_user\r\n(buf + len, &tmpbuf,\r\nstrlen(tmpbuf))) return -EFAULT;\r\nlen += strlen(tmpbuf);\r\n}\r\n}\r\n*off += len;\r\nreturn (len);\r\n}\r\nstatic ssize_t\r\ndivas_write(struct file *file, const char __user *buf, size_t count, loff_t *off)\r\n{\r\nreturn (-ENODEV);\r\n}\r\nstatic unsigned int divas_poll(struct file *file, poll_table *wait)\r\n{\r\nreturn (POLLERR);\r\n}\r\nstatic int divas_open(struct inode *inode, struct file *file)\r\n{\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int divas_close(struct inode *inode, struct file *file)\r\n{\r\nreturn (0);\r\n}\r\nint create_divas_proc(void)\r\n{\r\ndivas_proc_entry = proc_create(divas_proc_name, S_IFREG | S_IRUGO,\r\nproc_net_eicon, &divas_fops);\r\nif (!divas_proc_entry)\r\nreturn (0);\r\nreturn (1);\r\n}\r\nvoid remove_divas_proc(void)\r\n{\r\nif (divas_proc_entry) {\r\nremove_proc_entry(divas_proc_name, proc_net_eicon);\r\ndivas_proc_entry = NULL;\r\n}\r\n}\r\nstatic ssize_t grp_opt_proc_write(struct file *file, const char __user *buffer,\r\nsize_t count, loff_t *pos)\r\n{\r\ndiva_os_xdi_adapter_t *a = PDE(file->f_path.dentry->d_inode)->data;\r\nPISDN_ADAPTER IoAdapter = IoAdapters[a->controller - 1];\r\nif ((count == 1) || (count == 2)) {\r\nchar c;\r\nif (get_user(c, buffer))\r\nreturn -EFAULT;\r\nswitch (c) {\r\ncase '0':\r\nIoAdapter->capi_cfg.cfg_1 &=\r\n~DIVA_XDI_CAPI_CFG_1_GROUP_POPTIMIZATION_ON;\r\nbreak;\r\ncase '1':\r\nIoAdapter->capi_cfg.cfg_1 |=\r\nDIVA_XDI_CAPI_CFG_1_GROUP_POPTIMIZATION_ON;\r\nbreak;\r\ndefault:\r\nreturn (-EINVAL);\r\n}\r\nreturn (count);\r\n}\r\nreturn (-EINVAL);\r\n}\r\nstatic ssize_t d_l1_down_proc_write(struct file *file, const char __user *buffer,\r\nsize_t count, loff_t *pos)\r\n{\r\ndiva_os_xdi_adapter_t *a = PDE(file->f_path.dentry->d_inode)->data;\r\nPISDN_ADAPTER IoAdapter = IoAdapters[a->controller - 1];\r\nif ((count == 1) || (count == 2)) {\r\nchar c;\r\nif (get_user(c, buffer))\r\nreturn -EFAULT;\r\nswitch (c) {\r\ncase '0':\r\nIoAdapter->capi_cfg.cfg_1 &=\r\n~DIVA_XDI_CAPI_CFG_1_DYNAMIC_L1_ON;\r\nbreak;\r\ncase '1':\r\nIoAdapter->capi_cfg.cfg_1 |=\r\nDIVA_XDI_CAPI_CFG_1_DYNAMIC_L1_ON;\r\nbreak;\r\ndefault:\r\nreturn (-EINVAL);\r\n}\r\nreturn (count);\r\n}\r\nreturn (-EINVAL);\r\n}\r\nstatic int d_l1_down_proc_show(struct seq_file *m, void *v)\r\n{\r\ndiva_os_xdi_adapter_t *a = m->private;\r\nPISDN_ADAPTER IoAdapter = IoAdapters[a->controller - 1];\r\nseq_printf(m, "%s\n",\r\n(IoAdapter->capi_cfg.\r\ncfg_1 & DIVA_XDI_CAPI_CFG_1_DYNAMIC_L1_ON) ? "1" :\r\n"0");\r\nreturn 0;\r\n}\r\nstatic int d_l1_down_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, d_l1_down_proc_show, PDE(inode)->data);\r\n}\r\nstatic int grp_opt_proc_show(struct seq_file *m, void *v)\r\n{\r\ndiva_os_xdi_adapter_t *a = m->private;\r\nPISDN_ADAPTER IoAdapter = IoAdapters[a->controller - 1];\r\nseq_printf(m, "%s\n",\r\n(IoAdapter->capi_cfg.\r\ncfg_1 & DIVA_XDI_CAPI_CFG_1_GROUP_POPTIMIZATION_ON)\r\n? "1" : "0");\r\nreturn 0;\r\n}\r\nstatic int grp_opt_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, grp_opt_proc_show, PDE(inode)->data);\r\n}\r\nstatic ssize_t info_proc_write(struct file *file, const char __user *buffer,\r\nsize_t count, loff_t *pos)\r\n{\r\ndiva_os_xdi_adapter_t *a = PDE(file->f_path.dentry->d_inode)->data;\r\nPISDN_ADAPTER IoAdapter = IoAdapters[a->controller - 1];\r\nchar c[4];\r\nif (count <= 4)\r\nreturn -EINVAL;\r\nif (copy_from_user(c, buffer, 4))\r\nreturn -EFAULT;\r\nif (!memcmp(c, "trap", 4)) {\r\n(*(IoAdapter->os_trap_nfy_Fnc)) (IoAdapter, IoAdapter->ANum);\r\nreturn (count);\r\n}\r\nreturn (-EINVAL);\r\n}\r\nstatic int info_proc_show(struct seq_file *m, void *v)\r\n{\r\nint i = 0;\r\nchar *p;\r\nchar tmpser[16];\r\ndiva_os_xdi_adapter_t *a = m->private;\r\nPISDN_ADAPTER IoAdapter = IoAdapters[a->controller - 1];\r\nseq_printf(m, "Name : %s\n", IoAdapter->Properties.Name);\r\nseq_printf(m, "DSP state : %08x\n", a->dsp_mask);\r\nseq_printf(m, "Channels : %02d\n", IoAdapter->Properties.Channels);\r\nseq_printf(m, "E. max/used : %03d/%03d\n",\r\nIoAdapter->e_max, IoAdapter->e_count);\r\ndiva_get_vserial_number(IoAdapter, tmpser);\r\nseq_printf(m, "Serial : %s\n", tmpser);\r\nseq_printf(m, "IRQ : %d\n", IoAdapter->irq_info.irq_nr);\r\nseq_printf(m, "CardIndex : %d\n", a->CardIndex);\r\nseq_printf(m, "CardOrdinal : %d\n", a->CardOrdinal);\r\nseq_printf(m, "Controller : %d\n", a->controller);\r\nseq_printf(m, "Bus-Type : %s\n",\r\n(a->Bus ==\r\nDIVAS_XDI_ADAPTER_BUS_ISA) ? "ISA" : "PCI");\r\nseq_printf(m, "Port-Name : %s\n", a->port_name);\r\nif (a->Bus == DIVAS_XDI_ADAPTER_BUS_PCI) {\r\nseq_printf(m, "PCI-bus : %d\n", a->resources.pci.bus);\r\nseq_printf(m, "PCI-func : %d\n", a->resources.pci.func);\r\nfor (i = 0; i < 8; i++) {\r\nif (a->resources.pci.bar[i]) {\r\nseq_printf(m,\r\n"Mem / I/O %d : 0x%x / mapped : 0x%lx",\r\ni, a->resources.pci.bar[i],\r\n(unsigned long) a->resources.\r\npci.addr[i]);\r\nif (a->resources.pci.length[i]) {\r\nseq_printf(m,\r\n" / length : %d",\r\na->resources.pci.\r\nlength[i]);\r\n}\r\nseq_putc(m, '\n');\r\n}\r\n}\r\n}\r\nif ((!a->xdi_adapter.port) &&\r\n((!a->xdi_adapter.ram) ||\r\n(!a->xdi_adapter.reset)\r\n|| (!a->xdi_adapter.cfg))) {\r\nif (!IoAdapter->irq_info.irq_nr) {\r\np = "slave";\r\n} else {\r\np = "out of service";\r\n}\r\n} else if (a->xdi_adapter.trapped) {\r\np = "trapped";\r\n} else if (a->xdi_adapter.Initialized) {\r\np = "active";\r\n} else {\r\np = "ready";\r\n}\r\nseq_printf(m, "State : %s\n", p);\r\nreturn 0;\r\n}\r\nstatic int info_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, info_proc_show, PDE(inode)->data);\r\n}\r\nint create_adapter_proc(diva_os_xdi_adapter_t *a)\r\n{\r\nstruct proc_dir_entry *de, *pe;\r\nchar tmp[16];\r\nsprintf(tmp, "%s%d", adapter_dir_name, a->controller);\r\nif (!(de = proc_mkdir(tmp, proc_net_eicon)))\r\nreturn (0);\r\na->proc_adapter_dir = (void *) de;\r\npe = proc_create_data(info_proc_name, S_IRUGO | S_IWUSR, de,\r\n&info_proc_fops, a);\r\nif (!pe)\r\nreturn (0);\r\na->proc_info = (void *) pe;\r\npe = proc_create_data(grp_opt_proc_name, S_IRUGO | S_IWUSR, de,\r\n&grp_opt_proc_fops, a);\r\nif (pe)\r\na->proc_grp_opt = (void *) pe;\r\npe = proc_create_data(d_l1_down_proc_name, S_IRUGO | S_IWUSR, de,\r\n&d_l1_down_proc_fops, a);\r\nif (pe)\r\na->proc_d_l1_down = (void *) pe;\r\nDBG_TRC(("proc entry %s created", tmp));\r\nreturn (1);\r\n}\r\nvoid remove_adapter_proc(diva_os_xdi_adapter_t *a)\r\n{\r\nchar tmp[16];\r\nif (a->proc_adapter_dir) {\r\nif (a->proc_d_l1_down) {\r\nremove_proc_entry(d_l1_down_proc_name,\r\n(struct proc_dir_entry *) a->proc_adapter_dir);\r\n}\r\nif (a->proc_grp_opt) {\r\nremove_proc_entry(grp_opt_proc_name,\r\n(struct proc_dir_entry *) a->proc_adapter_dir);\r\n}\r\nif (a->proc_info) {\r\nremove_proc_entry(info_proc_name,\r\n(struct proc_dir_entry *) a->proc_adapter_dir);\r\n}\r\nsprintf(tmp, "%s%d", adapter_dir_name, a->controller);\r\nremove_proc_entry(tmp, proc_net_eicon);\r\nDBG_TRC(("proc entry %s%d removed", adapter_dir_name,\r\na->controller));\r\n}\r\n}

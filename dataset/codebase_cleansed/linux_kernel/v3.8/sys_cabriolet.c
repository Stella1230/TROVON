static inline void\r\ncabriolet_update_irq_hw(unsigned int irq, unsigned long mask)\r\n{\r\nint ofs = (irq - 16) / 8;\r\noutb(mask >> (16 + ofs * 8), 0x804 + ofs);\r\n}\r\nstatic inline void\r\ncabriolet_enable_irq(struct irq_data *d)\r\n{\r\ncabriolet_update_irq_hw(d->irq, cached_irq_mask &= ~(1UL << d->irq));\r\n}\r\nstatic void\r\ncabriolet_disable_irq(struct irq_data *d)\r\n{\r\ncabriolet_update_irq_hw(d->irq, cached_irq_mask |= 1UL << d->irq);\r\n}\r\nstatic void\r\ncabriolet_device_interrupt(unsigned long v)\r\n{\r\nunsigned long pld;\r\nunsigned int i;\r\npld = inb(0x804) | (inb(0x805) << 8) | (inb(0x806) << 16);\r\nwhile (pld) {\r\ni = ffz(~pld);\r\npld &= pld - 1;\r\nif (i == 4) {\r\nisa_device_interrupt(v);\r\n} else {\r\nhandle_irq(16 + i);\r\n}\r\n}\r\n}\r\nstatic void __init\r\ncommon_init_irq(void (*srm_dev_int)(unsigned long v))\r\n{\r\ninit_i8259a_irqs();\r\nif (alpha_using_srm) {\r\nalpha_mv.device_interrupt = srm_dev_int;\r\ninit_srm_irqs(35, 0);\r\n}\r\nelse {\r\nlong i;\r\noutb(0xff, 0x804);\r\noutb(0xff, 0x805);\r\noutb(0xff, 0x806);\r\nfor (i = 16; i < 35; ++i) {\r\nirq_set_chip_and_handler(i, &cabriolet_irq_type,\r\nhandle_level_irq);\r\nirq_set_status_flags(i, IRQ_LEVEL);\r\n}\r\n}\r\ncommon_init_isa_dma();\r\nsetup_irq(16+4, &isa_cascade_irqaction);\r\n}\r\nstatic void __init\r\ncabriolet_init_irq(void)\r\n{\r\ncommon_init_irq(srm_device_interrupt);\r\n}\r\nstatic void\r\npc164_srm_device_interrupt(unsigned long v)\r\n{\r\n__min_ipl = getipl();\r\nsrm_device_interrupt(v);\r\n__min_ipl = 0;\r\n}\r\nstatic void\r\npc164_device_interrupt(unsigned long v)\r\n{\r\n__min_ipl = getipl();\r\ncabriolet_device_interrupt(v);\r\n__min_ipl = 0;\r\n}\r\nstatic void __init\r\npc164_init_irq(void)\r\n{\r\ncommon_init_irq(pc164_srm_device_interrupt);\r\n}\r\nstatic inline int __init\r\neb66p_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstatic char irq_tab[5][5] __initdata = {\r\n{16+0, 16+0, 16+5, 16+9, 16+13},\r\n{16+1, 16+1, 16+6, 16+10, 16+14},\r\n{ -1, -1, -1, -1, -1},\r\n{16+2, 16+2, 16+7, 16+11, 16+15},\r\n{16+3, 16+3, 16+8, 16+12, 16+6}\r\n};\r\nconst long min_idsel = 6, max_idsel = 10, irqs_per_slot = 5;\r\nreturn COMMON_TABLE_LOOKUP;\r\n}\r\nstatic inline int __init\r\ncabriolet_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstatic char irq_tab[5][5] __initdata = {\r\n{ 16+2, 16+2, 16+7, 16+11, 16+15},\r\n{ 16+0, 16+0, 16+5, 16+9, 16+13},\r\n{ 16+1, 16+1, 16+6, 16+10, 16+14},\r\n{ -1, -1, -1, -1, -1},\r\n{ 16+3, 16+3, 16+8, 16+12, 16+16}\r\n};\r\nconst long min_idsel = 5, max_idsel = 9, irqs_per_slot = 5;\r\nreturn COMMON_TABLE_LOOKUP;\r\n}\r\nstatic inline void __init\r\ncabriolet_enable_ide(void)\r\n{\r\nif (pc873xx_probe() == -1) {\r\nprintk(KERN_ERR "Probing for PC873xx Super IO chip failed.\n");\r\n} else {\r\nprintk(KERN_INFO "Found %s Super IO chip at 0x%x\n",\r\npc873xx_get_model(), pc873xx_get_base());\r\npc873xx_enable_ide();\r\n}\r\n}\r\nstatic inline void __init\r\ncabriolet_init_pci(void)\r\n{\r\ncommon_init_pci();\r\ncabriolet_enable_ide();\r\n}\r\nstatic inline void __init\r\ncia_cab_init_pci(void)\r\n{\r\ncia_init_pci();\r\ncabriolet_enable_ide();\r\n}\r\nstatic inline int __init\r\nalphapc164_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstatic char irq_tab[7][5] __initdata = {\r\n{ 16+2, 16+2, 16+9, 16+13, 16+17},\r\n{ 16+0, 16+0, 16+7, 16+11, 16+15},\r\n{ 16+1, 16+1, 16+8, 16+12, 16+16},\r\n{ -1, -1, -1, -1, -1},\r\n{ 16+3, 16+3, 16+10, 16+14, 16+18},\r\n{ 16+6, 16+6, 16+6, 16+6, 16+6},\r\n{ 16+5, 16+5, 16+5, 16+5, 16+5}\r\n};\r\nconst long min_idsel = 5, max_idsel = 11, irqs_per_slot = 5;\r\nreturn COMMON_TABLE_LOOKUP;\r\n}\r\nstatic inline void __init\r\nalphapc164_init_pci(void)\r\n{\r\ncia_init_pci();\r\nSMC93x_Init();\r\n}

static void wdt_send_data(unsigned char command, unsigned char data)\r\n{\r\noutb(data, DATA_PORT);\r\nmsleep(200);\r\noutb(command, COMMAND_PORT);\r\nmsleep(100);\r\n}\r\nstatic void wdt_enable(void)\r\n{\r\nmutex_lock(&wdt_lock);\r\nwdt_send_data(IFACE_ON_COMMAND, 1);\r\nwdt_send_data(REBOOT_COMMAND, margin);\r\nmutex_unlock(&wdt_lock);\r\n}\r\nstatic void wdt_disable(void)\r\n{\r\nmutex_lock(&wdt_lock);\r\nwdt_send_data(IFACE_ON_COMMAND, 0);\r\nwdt_send_data(REBOOT_COMMAND, 0);\r\nmutex_unlock(&wdt_lock);\r\n}\r\nstatic int fitpc2_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(WDT_IN_USE, &wdt_status))\r\nreturn -EBUSY;\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nwdt_enable();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic ssize_t fitpc2_wdt_write(struct file *file, const char *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nsize_t i;\r\nif (!len)\r\nreturn 0;\r\nif (nowayout) {\r\nlen = 0;\r\ngoto out;\r\n}\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nset_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\n}\r\nout:\r\nwdt_enable();\r\nreturn len;\r\n}\r\nstatic long fitpc2_wdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint ret = -ENOTTY;\r\nint time;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nret = copy_to_user((struct watchdog_info *)arg, &ident,\r\nsizeof(ident)) ? -EFAULT : 0;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\nret = put_user(0, (int *)arg);\r\nbreak;\r\ncase WDIOC_GETBOOTSTATUS:\r\nret = put_user(0, (int *)arg);\r\nbreak;\r\ncase WDIOC_KEEPALIVE:\r\nwdt_enable();\r\nret = 0;\r\nbreak;\r\ncase WDIOC_SETTIMEOUT:\r\nret = get_user(time, (int *)arg);\r\nif (ret)\r\nbreak;\r\nif (time < 31 || time > 255) {\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nmargin = time;\r\nwdt_enable();\r\ncase WDIOC_GETTIMEOUT:\r\nret = put_user(margin, (int *)arg);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int fitpc2_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nif (test_bit(WDT_OK_TO_CLOSE, &wdt_status)) {\r\nwdt_disable();\r\npr_info("Device disabled\n");\r\n} else {\r\npr_warn("Device closed unexpectedly - timer will not stop\n");\r\nwdt_enable();\r\n}\r\nclear_bit(WDT_IN_USE, &wdt_status);\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nreturn 0;\r\n}\r\nstatic int __init fitpc2_wdt_init(void)\r\n{\r\nint err;\r\nconst char *brd_name;\r\nbrd_name = dmi_get_system_info(DMI_BOARD_NAME);\r\nif (!brd_name || !strstr(brd_name, "SBC-FITPC2"))\r\nreturn -ENODEV;\r\npr_info("%s found\n", brd_name);\r\nif (!request_region(COMMAND_PORT, 1, WATCHDOG_NAME)) {\r\npr_err("I/O address 0x%04x already in use\n", COMMAND_PORT);\r\nreturn -EIO;\r\n}\r\nif (!request_region(DATA_PORT, 1, WATCHDOG_NAME)) {\r\npr_err("I/O address 0x%04x already in use\n", DATA_PORT);\r\nerr = -EIO;\r\ngoto err_data_port;\r\n}\r\nif (margin < 31 || margin > 255) {\r\npr_err("margin must be in range 31 - 255 seconds, you tried to set %d\n",\r\nmargin);\r\nerr = -EINVAL;\r\ngoto err_margin;\r\n}\r\nerr = misc_register(&fitpc2_wdt_miscdev);\r\nif (err) {\r\npr_err("cannot register miscdev on minor=%d (err=%d)\n",\r\nWATCHDOG_MINOR, err);\r\ngoto err_margin;\r\n}\r\nreturn 0;\r\nerr_margin:\r\nrelease_region(DATA_PORT, 1);\r\nerr_data_port:\r\nrelease_region(COMMAND_PORT, 1);\r\nreturn err;\r\n}\r\nstatic void __exit fitpc2_wdt_exit(void)\r\n{\r\nmisc_deregister(&fitpc2_wdt_miscdev);\r\nrelease_region(DATA_PORT, 1);\r\nrelease_region(COMMAND_PORT, 1);\r\n}

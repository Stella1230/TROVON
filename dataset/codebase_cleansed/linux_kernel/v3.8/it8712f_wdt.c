static int superio_inb(int reg)\r\n{\r\noutb(reg, REG);\r\nreturn inb(VAL);\r\n}\r\nstatic void superio_outb(int val, int reg)\r\n{\r\noutb(reg, REG);\r\noutb(val, VAL);\r\n}\r\nstatic int superio_inw(int reg)\r\n{\r\nint val;\r\noutb(reg++, REG);\r\nval = inb(VAL) << 8;\r\noutb(reg, REG);\r\nval |= inb(VAL);\r\nreturn val;\r\n}\r\nstatic inline void superio_select(int ldn)\r\n{\r\noutb(LDN, REG);\r\noutb(ldn, VAL);\r\n}\r\nstatic inline int superio_enter(void)\r\n{\r\nif (!request_muxed_region(REG, 2, NAME))\r\nreturn -EBUSY;\r\noutb(0x87, REG);\r\noutb(0x01, REG);\r\noutb(0x55, REG);\r\noutb(0x55, REG);\r\nreturn 0;\r\n}\r\nstatic inline void superio_exit(void)\r\n{\r\noutb(0x02, REG);\r\noutb(0x02, VAL);\r\nrelease_region(REG, 2);\r\n}\r\nstatic inline void it8712f_wdt_ping(void)\r\n{\r\nif (wdt_control_reg & WDT_RESET_GAME)\r\ninb(address);\r\n}\r\nstatic void it8712f_wdt_update_margin(void)\r\n{\r\nint config = WDT_OUT_KRST | WDT_OUT_PWROK;\r\nint units = margin;\r\nif (units <= max_units) {\r\nconfig |= WDT_UNIT_SEC;\r\npr_info("timer margin %d seconds\n", units);\r\n} else {\r\nunits /= 60;\r\npr_info("timer margin %d minutes\n", units);\r\n}\r\nsuperio_outb(config, WDT_CONFIG);\r\nif (revision >= 0x08)\r\nsuperio_outb(units >> 8, WDT_TIMEOUT + 1);\r\nsuperio_outb(units, WDT_TIMEOUT);\r\n}\r\nstatic int it8712f_wdt_get_status(void)\r\n{\r\nif (superio_inb(WDT_CONTROL) & 0x01)\r\nreturn WDIOF_CARDRESET;\r\nelse\r\nreturn 0;\r\n}\r\nstatic int it8712f_wdt_enable(void)\r\n{\r\nint ret = superio_enter();\r\nif (ret)\r\nreturn ret;\r\npr_debug("enabling watchdog timer\n");\r\nsuperio_select(LDN_GPIO);\r\nsuperio_outb(wdt_control_reg, WDT_CONTROL);\r\nit8712f_wdt_update_margin();\r\nsuperio_exit();\r\nit8712f_wdt_ping();\r\nreturn 0;\r\n}\r\nstatic int it8712f_wdt_disable(void)\r\n{\r\nint ret = superio_enter();\r\nif (ret)\r\nreturn ret;\r\npr_debug("disabling watchdog timer\n");\r\nsuperio_select(LDN_GPIO);\r\nsuperio_outb(0, WDT_CONFIG);\r\nsuperio_outb(0, WDT_CONTROL);\r\nif (revision >= 0x08)\r\nsuperio_outb(0, WDT_TIMEOUT + 1);\r\nsuperio_outb(0, WDT_TIMEOUT);\r\nsuperio_exit();\r\nreturn 0;\r\n}\r\nstatic int it8712f_wdt_notify(struct notifier_block *this,\r\nunsigned long code, void *unused)\r\n{\r\nif (code == SYS_HALT || code == SYS_POWER_OFF)\r\nif (!nowayout)\r\nit8712f_wdt_disable();\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic ssize_t it8712f_wdt_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nsize_t i;\r\nit8712f_wdt_ping();\r\nexpect_close = 0;\r\nfor (i = 0; i < len; ++i) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nexpect_close = 42;\r\n}\r\n}\r\nreturn len;\r\n}\r\nstatic long it8712f_wdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nstatic const struct watchdog_info ident = {\r\n.identity = "IT8712F Watchdog",\r\n.firmware_version = 1,\r\n.options = WDIOF_SETTIMEOUT | WDIOF_KEEPALIVEPING |\r\nWDIOF_MAGICCLOSE,\r\n};\r\nint value;\r\nint ret;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nif (copy_to_user(argp, &ident, sizeof(ident)))\r\nreturn -EFAULT;\r\nreturn 0;\r\ncase WDIOC_GETSTATUS:\r\nret = superio_enter();\r\nif (ret)\r\nreturn ret;\r\nsuperio_select(LDN_GPIO);\r\nvalue = it8712f_wdt_get_status();\r\nsuperio_exit();\r\nreturn put_user(value, p);\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, p);\r\ncase WDIOC_KEEPALIVE:\r\nit8712f_wdt_ping();\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT:\r\nif (get_user(value, p))\r\nreturn -EFAULT;\r\nif (value < 1)\r\nreturn -EINVAL;\r\nif (value > (max_units * 60))\r\nreturn -EINVAL;\r\nmargin = value;\r\nret = superio_enter();\r\nif (ret)\r\nreturn ret;\r\nsuperio_select(LDN_GPIO);\r\nit8712f_wdt_update_margin();\r\nsuperio_exit();\r\nit8712f_wdt_ping();\r\ncase WDIOC_GETTIMEOUT:\r\nif (put_user(margin, p))\r\nreturn -EFAULT;\r\nreturn 0;\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\n}\r\nstatic int it8712f_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nint ret;\r\nif (test_and_set_bit(0, &wdt_open))\r\nreturn -EBUSY;\r\nret = it8712f_wdt_enable();\r\nif (ret)\r\nreturn ret;\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int it8712f_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nif (expect_close != 42) {\r\npr_warn("watchdog device closed unexpectedly, will not disable the watchdog timer\n");\r\n} else if (!nowayout) {\r\nif (it8712f_wdt_disable())\r\npr_warn("Watchdog disable failed\n");\r\n}\r\nexpect_close = 0;\r\nclear_bit(0, &wdt_open);\r\nreturn 0;\r\n}\r\nstatic int __init it8712f_wdt_find(unsigned short *address)\r\n{\r\nint err = -ENODEV;\r\nint chip_type;\r\nint ret = superio_enter();\r\nif (ret)\r\nreturn ret;\r\nchip_type = superio_inw(DEVID);\r\nif (chip_type != IT8712F_DEVID)\r\ngoto exit;\r\nsuperio_select(LDN_GAME);\r\nsuperio_outb(1, ACT_REG);\r\nif (!(superio_inb(ACT_REG) & 0x01)) {\r\npr_err("Device not activated, skipping\n");\r\ngoto exit;\r\n}\r\n*address = superio_inw(BASE_REG);\r\nif (*address == 0) {\r\npr_err("Base address not set, skipping\n");\r\ngoto exit;\r\n}\r\nerr = 0;\r\nrevision = superio_inb(DEVREV) & 0x0f;\r\nif (revision >= 0x08)\r\nmax_units = 65535;\r\nif (margin > (max_units * 60))\r\nmargin = (max_units * 60);\r\npr_info("Found IT%04xF chip revision %d - using DogFood address 0x%x\n",\r\nchip_type, revision, *address);\r\nexit:\r\nsuperio_exit();\r\nreturn err;\r\n}\r\nstatic int __init it8712f_wdt_init(void)\r\n{\r\nint err = 0;\r\nif (it8712f_wdt_find(&address))\r\nreturn -ENODEV;\r\nif (!request_region(address, 1, "IT8712F Watchdog")) {\r\npr_warn("watchdog I/O region busy\n");\r\nreturn -EBUSY;\r\n}\r\nerr = it8712f_wdt_disable();\r\nif (err) {\r\npr_err("unable to disable watchdog timer\n");\r\ngoto out;\r\n}\r\nerr = register_reboot_notifier(&it8712f_wdt_notifier);\r\nif (err) {\r\npr_err("unable to register reboot notifier\n");\r\ngoto out;\r\n}\r\nerr = misc_register(&it8712f_wdt_miscdev);\r\nif (err) {\r\npr_err("cannot register miscdev on minor=%d (err=%d)\n",\r\nWATCHDOG_MINOR, err);\r\ngoto reboot_out;\r\n}\r\nreturn 0;\r\nreboot_out:\r\nunregister_reboot_notifier(&it8712f_wdt_notifier);\r\nout:\r\nrelease_region(address, 1);\r\nreturn err;\r\n}\r\nstatic void __exit it8712f_wdt_exit(void)\r\n{\r\nmisc_deregister(&it8712f_wdt_miscdev);\r\nunregister_reboot_notifier(&it8712f_wdt_notifier);\r\nrelease_region(address, 1);\r\n}

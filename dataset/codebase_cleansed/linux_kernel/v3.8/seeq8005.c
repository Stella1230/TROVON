struct net_device * __init seeq8005_probe(int unit)\r\n{\r\nstruct net_device *dev = alloc_etherdev(sizeof(struct net_local));\r\nunsigned *port;\r\nint err = 0;\r\nif (!dev)\r\nreturn ERR_PTR(-ENODEV);\r\nif (unit >= 0) {\r\nsprintf(dev->name, "eth%d", unit);\r\nnetdev_boot_setup_check(dev);\r\nio = dev->base_addr;\r\nirq = dev->irq;\r\n}\r\nif (io > 0x1ff) {\r\nerr = seeq8005_probe1(dev, io);\r\n} else if (io != 0) {\r\nerr = -ENXIO;\r\n} else {\r\nfor (port = seeq8005_portlist; *port; port++) {\r\nif (seeq8005_probe1(dev, *port) == 0)\r\nbreak;\r\n}\r\nif (!*port)\r\nerr = -ENODEV;\r\n}\r\nif (err)\r\ngoto out;\r\nerr = register_netdev(dev);\r\nif (err)\r\ngoto out1;\r\nreturn dev;\r\nout1:\r\nrelease_region(dev->base_addr, SEEQ8005_IO_EXTENT);\r\nout:\r\nfree_netdev(dev);\r\nreturn ERR_PTR(err);\r\n}\r\nstatic int __init seeq8005_probe1(struct net_device *dev, int ioaddr)\r\n{\r\nstatic unsigned version_printed;\r\nint i,j;\r\nunsigned char SA_prom[32];\r\nint old_cfg1;\r\nint old_cfg2;\r\nint old_stat;\r\nint old_dmaar;\r\nint old_rear;\r\nint retval;\r\nif (!request_region(ioaddr, SEEQ8005_IO_EXTENT, "seeq8005"))\r\nreturn -ENODEV;\r\nif (net_debug>1)\r\nprintk("seeq8005: probing at 0x%x\n",ioaddr);\r\nold_stat = inw(SEEQ_STATUS);\r\nif (old_stat == 0xffff) {\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\nif ( (old_stat & 0x1800) != 0x1800 ) {\r\nif (net_debug>1) {\r\nprintk("seeq8005: reserved stat bits != 0x1800\n");\r\nprintk(" == 0x%04x\n",old_stat);\r\n}\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\nold_rear = inw(SEEQ_REA);\r\nif (old_rear == 0xffff) {\r\noutw(0,SEEQ_REA);\r\nif (inw(SEEQ_REA) == 0xffff) {\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\n} else if ((old_rear & 0xff00) != 0xff00) {\r\nif (net_debug>1) {\r\nprintk("seeq8005: unused rear bits != 0xff00\n");\r\nprintk(" == 0x%04x\n",old_rear);\r\n}\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\nold_cfg2 = inw(SEEQ_CFG2);\r\nold_cfg1 = inw(SEEQ_CFG1);\r\nold_dmaar = inw(SEEQ_DMAAR);\r\nif (net_debug>4) {\r\nprintk("seeq8005: stat = 0x%04x\n",old_stat);\r\nprintk("seeq8005: cfg1 = 0x%04x\n",old_cfg1);\r\nprintk("seeq8005: cfg2 = 0x%04x\n",old_cfg2);\r\nprintk("seeq8005: raer = 0x%04x\n",old_rear);\r\nprintk("seeq8005: dmaar= 0x%04x\n",old_dmaar);\r\n}\r\noutw( SEEQCMD_FIFO_WRITE | SEEQCMD_SET_ALL_OFF, SEEQ_CMD);\r\noutw( 0, SEEQ_DMAAR);\r\noutw( SEEQCFG1_BUFFER_PROM, SEEQ_CFG1);\r\nj=0;\r\nfor(i=0; i <32; i++) {\r\nj+= SA_prom[i] = inw(SEEQ_BUFFER) & 0xff;\r\n}\r\n#if 0\r\nif ( (j&0xff) != 0 ) {\r\nif (net_debug>1) {\r\nprintk("seeq8005: prom sum error\n");\r\n}\r\noutw( old_stat, SEEQ_STATUS);\r\noutw( old_dmaar, SEEQ_DMAAR);\r\noutw( old_cfg1, SEEQ_CFG1);\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\n#endif\r\noutw( SEEQCFG2_RESET, SEEQ_CFG2);\r\nudelay(5);\r\noutw( SEEQCMD_SET_ALL_OFF, SEEQ_CMD);\r\nif (net_debug) {\r\nprintk("seeq8005: prom sum = 0x%08x\n",j);\r\nfor(j=0; j<32; j+=16) {\r\nprintk("seeq8005: prom %02x: ",j);\r\nfor(i=0;i<16;i++) {\r\nprintk("%02x ",SA_prom[j|i]);\r\n}\r\nprintk(" ");\r\nfor(i=0;i<16;i++) {\r\nif ((SA_prom[j|i]>31)&&(SA_prom[j|i]<127)) {\r\nprintk("%c", SA_prom[j|i]);\r\n} else {\r\nprintk(" ");\r\n}\r\n}\r\nprintk("\n");\r\n}\r\n}\r\n#if 0\r\nif (net_debug>1) {\r\nprintk("seeq8005: testing packet buffer ... ");\r\noutw( SEEQCFG1_BUFFER_BUFFER, SEEQ_CFG1);\r\noutw( SEEQCMD_FIFO_WRITE | SEEQCMD_SET_ALL_OFF, SEEQ_CMD);\r\noutw( 0 , SEEQ_DMAAR);\r\nfor(i=0;i<32768;i++) {\r\noutw(0x5a5a, SEEQ_BUFFER);\r\n}\r\nj=jiffies+HZ;\r\nwhile ( ((inw(SEEQ_STATUS) & SEEQSTAT_FIFO_EMPTY) != SEEQSTAT_FIFO_EMPTY) && time_before(jiffies, j) )\r\nmb();\r\noutw( 0 , SEEQ_DMAAR);\r\nwhile ( ((inw(SEEQ_STATUS) & SEEQSTAT_WINDOW_INT) != SEEQSTAT_WINDOW_INT) && time_before(jiffies, j+HZ))\r\nmb();\r\nif ( (inw(SEEQ_STATUS) & SEEQSTAT_WINDOW_INT) == SEEQSTAT_WINDOW_INT)\r\noutw( SEEQCMD_WINDOW_INT_ACK | (inw(SEEQ_STATUS)& SEEQCMD_INT_MASK), SEEQ_CMD);\r\noutw( SEEQCMD_FIFO_READ | SEEQCMD_SET_ALL_OFF, SEEQ_CMD);\r\nj=0;\r\nfor(i=0;i<32768;i++) {\r\nif (inw(SEEQ_BUFFER) != 0x5a5a)\r\nj++;\r\n}\r\nif (j) {\r\nprintk("%i\n",j);\r\n} else {\r\nprintk("ok.\n");\r\n}\r\n}\r\n#endif\r\nif (net_debug && version_printed++ == 0)\r\nprintk(version);\r\nprintk("%s: %s found at %#3x, ", dev->name, "seeq8005", ioaddr);\r\ndev->base_addr = ioaddr;\r\ndev->irq = irq;\r\nfor (i = 0; i < 6; i++)\r\ndev->dev_addr[i] = SA_prom[i+6];\r\nprintk("%pM", dev->dev_addr);\r\nif (dev->irq == 0xff)\r\n;\r\nelse if (dev->irq < 2) {\r\nunsigned long cookie = probe_irq_on();\r\noutw( SEEQCMD_RX_INT_EN | SEEQCMD_SET_RX_ON | SEEQCMD_SET_RX_OFF, SEEQ_CMD );\r\ndev->irq = probe_irq_off(cookie);\r\nif (net_debug >= 2)\r\nprintk(" autoirq is %d\n", dev->irq);\r\n} else if (dev->irq == 2)\r\ndev->irq = 9;\r\n#if 0\r\n{\r\nint irqval = request_irq(dev->irq, seeq8005_interrupt, 0, "seeq8005", dev);\r\nif (irqval) {\r\nprintk ("%s: unable to get IRQ %d (irqval=%d).\n", dev->name,\r\ndev->irq, irqval);\r\nretval = -EAGAIN;\r\ngoto out;\r\n}\r\n}\r\n#endif\r\ndev->netdev_ops = &seeq8005_netdev_ops;\r\ndev->watchdog_timeo = HZ/20;\r\ndev->flags &= ~IFF_MULTICAST;\r\nreturn 0;\r\nout:\r\nrelease_region(ioaddr, SEEQ8005_IO_EXTENT);\r\nreturn retval;\r\n}\r\nstatic int seeq8005_open(struct net_device *dev)\r\n{\r\nstruct net_local *lp = netdev_priv(dev);\r\n{\r\nint irqval = request_irq(dev->irq, seeq8005_interrupt, 0, "seeq8005", dev);\r\nif (irqval) {\r\nprintk ("%s: unable to get IRQ %d (irqval=%d).\n", dev->name,\r\ndev->irq, irqval);\r\nreturn -EAGAIN;\r\n}\r\n}\r\nseeq8005_init(dev, 1);\r\nlp->open_time = jiffies;\r\nnetif_start_queue(dev);\r\nreturn 0;\r\n}\r\nstatic void seeq8005_timeout(struct net_device *dev)\r\n{\r\nint ioaddr = dev->base_addr;\r\nprintk(KERN_WARNING "%s: transmit timed out, %s?\n", dev->name,\r\ntx_done(dev) ? "IRQ conflict" : "network cable problem");\r\nseeq8005_init(dev, 1);\r\ndev->trans_start = jiffies;\r\nnetif_wake_queue(dev);\r\n}\r\nstatic netdev_tx_t seeq8005_send_packet(struct sk_buff *skb,\r\nstruct net_device *dev)\r\n{\r\nshort length = skb->len;\r\nunsigned char *buf;\r\nif (length < ETH_ZLEN) {\r\nif (skb_padto(skb, ETH_ZLEN))\r\nreturn NETDEV_TX_OK;\r\nlength = ETH_ZLEN;\r\n}\r\nbuf = skb->data;\r\nnetif_stop_queue(dev);\r\nhardware_send_packet(dev, buf, length);\r\ndev->stats.tx_bytes += length;\r\ndev_kfree_skb (skb);\r\nreturn NETDEV_TX_OK;\r\n}\r\ninline void wait_for_buffer(struct net_device * dev)\r\n{\r\nint ioaddr = dev->base_addr;\r\nunsigned long tmp;\r\nint status;\r\ntmp = jiffies + HZ;\r\nwhile ( ( ((status=inw(SEEQ_STATUS)) & SEEQSTAT_WINDOW_INT) != SEEQSTAT_WINDOW_INT) && time_before(jiffies, tmp))\r\ncpu_relax();\r\nif ( (status & SEEQSTAT_WINDOW_INT) == SEEQSTAT_WINDOW_INT)\r\noutw( SEEQCMD_WINDOW_INT_ACK | (status & SEEQCMD_INT_MASK), SEEQ_CMD);\r\n}\r\nstatic irqreturn_t seeq8005_interrupt(int irq, void *dev_id)\r\n{\r\nstruct net_device *dev = dev_id;\r\nstruct net_local *lp;\r\nint ioaddr, status, boguscount = 0;\r\nint handled = 0;\r\nioaddr = dev->base_addr;\r\nlp = netdev_priv(dev);\r\nstatus = inw(SEEQ_STATUS);\r\ndo {\r\nif (net_debug >2) {\r\nprintk("%s: int, status=0x%04x\n",dev->name,status);\r\n}\r\nif (status & SEEQSTAT_WINDOW_INT) {\r\nhandled = 1;\r\noutw( SEEQCMD_WINDOW_INT_ACK | (status & SEEQCMD_INT_MASK), SEEQ_CMD);\r\nif (net_debug) {\r\nprintk("%s: window int!\n",dev->name);\r\n}\r\n}\r\nif (status & SEEQSTAT_TX_INT) {\r\nhandled = 1;\r\noutw( SEEQCMD_TX_INT_ACK | (status & SEEQCMD_INT_MASK), SEEQ_CMD);\r\ndev->stats.tx_packets++;\r\nnetif_wake_queue(dev);\r\n}\r\nif (status & SEEQSTAT_RX_INT) {\r\nhandled = 1;\r\nseeq8005_rx(dev);\r\n}\r\nstatus = inw(SEEQ_STATUS);\r\n} while ( (++boguscount < 10) && (status & SEEQSTAT_ANY_INT)) ;\r\nif(net_debug>2) {\r\nprintk("%s: eoi\n",dev->name);\r\n}\r\nreturn IRQ_RETVAL(handled);\r\n}\r\nstatic void seeq8005_rx(struct net_device *dev)\r\n{\r\nstruct net_local *lp = netdev_priv(dev);\r\nint boguscount = 10;\r\nint pkt_hdr;\r\nint ioaddr = dev->base_addr;\r\ndo {\r\nint next_packet;\r\nint pkt_len;\r\nint i;\r\nint status;\r\nstatus = inw(SEEQ_STATUS);\r\noutw( lp->receive_ptr, SEEQ_DMAAR);\r\noutw(SEEQCMD_FIFO_READ | SEEQCMD_RX_INT_ACK | (status & SEEQCMD_INT_MASK), SEEQ_CMD);\r\nwait_for_buffer(dev);\r\nnext_packet = ntohs(inw(SEEQ_BUFFER));\r\npkt_hdr = inw(SEEQ_BUFFER);\r\nif (net_debug>2) {\r\nprintk("%s: 0x%04x recv next=0x%04x, hdr=0x%04x\n",dev->name,lp->receive_ptr,next_packet,pkt_hdr);\r\n}\r\nif ((next_packet == 0) || ((pkt_hdr & SEEQPKTH_CHAIN)==0)) {\r\nreturn;\r\n}\r\nif ((pkt_hdr & SEEQPKTS_DONE)==0)\r\nbreak;\r\nif (next_packet < lp->receive_ptr) {\r\npkt_len = (next_packet + 0x10000 - ((DEFAULT_TEA+1)<<8)) - lp->receive_ptr - 4;\r\n} else {\r\npkt_len = next_packet - lp->receive_ptr - 4;\r\n}\r\nif (next_packet < ((DEFAULT_TEA+1)<<8)) {\r\nprintk("%s: recv packet ring corrupt, resetting board\n",dev->name);\r\nseeq8005_init(dev,1);\r\nreturn;\r\n}\r\nlp->receive_ptr = next_packet;\r\nif (net_debug>2) {\r\nprintk("%s: recv len=0x%04x\n",dev->name,pkt_len);\r\n}\r\nif (pkt_hdr & SEEQPKTS_ANY_ERROR) {\r\ndev->stats.rx_errors++;\r\nif (pkt_hdr & SEEQPKTS_SHORT) dev->stats.rx_frame_errors++;\r\nif (pkt_hdr & SEEQPKTS_DRIB) dev->stats.rx_frame_errors++;\r\nif (pkt_hdr & SEEQPKTS_OVERSIZE) dev->stats.rx_over_errors++;\r\nif (pkt_hdr & SEEQPKTS_CRC_ERR) dev->stats.rx_crc_errors++;\r\noutw( SEEQCMD_FIFO_WRITE | SEEQCMD_DMA_INT_ACK | (status & SEEQCMD_INT_MASK), SEEQ_CMD);\r\noutw( (lp->receive_ptr & 0xff00)>>8, SEEQ_REA);\r\n} else {\r\nstruct sk_buff *skb;\r\nunsigned char *buf;\r\nskb = netdev_alloc_skb(dev, pkt_len);\r\nif (skb == NULL) {\r\nprintk("%s: Memory squeeze, dropping packet.\n", dev->name);\r\ndev->stats.rx_dropped++;\r\nbreak;\r\n}\r\nskb_reserve(skb, 2);\r\nbuf = skb_put(skb,pkt_len);\r\ninsw(SEEQ_BUFFER, buf, (pkt_len + 1) >> 1);\r\nif (net_debug>2) {\r\nchar * p = buf;\r\nprintk("%s: recv ",dev->name);\r\nfor(i=0;i<14;i++) {\r\nprintk("%02x ",*(p++)&0xff);\r\n}\r\nprintk("\n");\r\n}\r\nskb->protocol=eth_type_trans(skb,dev);\r\nnetif_rx(skb);\r\ndev->stats.rx_packets++;\r\ndev->stats.rx_bytes += pkt_len;\r\n}\r\n} while ((--boguscount) && (pkt_hdr & SEEQPKTH_CHAIN));\r\n}\r\nstatic int seeq8005_close(struct net_device *dev)\r\n{\r\nstruct net_local *lp = netdev_priv(dev);\r\nint ioaddr = dev->base_addr;\r\nlp->open_time = 0;\r\nnetif_stop_queue(dev);\r\noutw( SEEQCMD_SET_ALL_OFF, SEEQ_CMD);\r\nfree_irq(dev->irq, dev);\r\nreturn 0;\r\n}\r\nstatic void set_multicast_list(struct net_device *dev)\r\n{\r\n#if 0\r\nint ioaddr = dev->base_addr;\r\nif (num_addrs) {\r\noutw( (inw(SEEQ_CFG1) & ~SEEQCFG1_MATCH_MASK)| SEEQCFG1_MATCH_ALL, SEEQ_CFG1);\r\ndev->flags|=IFF_PROMISC;\r\n} else {\r\noutw( (inw(SEEQ_CFG1) & ~SEEQCFG1_MATCH_MASK)| SEEQCFG1_MATCH_BROAD, SEEQ_CFG1);\r\n}\r\n#endif\r\n}\r\nvoid seeq8005_init(struct net_device *dev, int startp)\r\n{\r\nstruct net_local *lp = netdev_priv(dev);\r\nint ioaddr = dev->base_addr;\r\nint i;\r\noutw(SEEQCFG2_RESET, SEEQ_CFG2);\r\nudelay(5);\r\noutw( SEEQCMD_FIFO_WRITE | SEEQCMD_SET_ALL_OFF, SEEQ_CMD);\r\noutw( 0, SEEQ_DMAAR);\r\noutw( SEEQCFG1_BUFFER_MAC0, SEEQ_CFG1);\r\nfor(i=0;i<6;i++) {\r\noutb(dev->dev_addr[i], SEEQ_BUFFER);\r\nudelay(2);\r\n}\r\noutw( SEEQCFG1_BUFFER_TEA, SEEQ_CFG1);\r\noutb( DEFAULT_TEA, SEEQ_BUFFER);\r\nlp->receive_ptr = (DEFAULT_TEA+1)<<8;\r\noutw( lp->receive_ptr, SEEQ_RPR);\r\noutw( 0x00ff, SEEQ_REA);\r\nif (net_debug>4) {\r\nprintk("%s: SA0 = ",dev->name);\r\noutw( SEEQCMD_FIFO_READ | SEEQCMD_SET_ALL_OFF, SEEQ_CMD);\r\noutw( 0, SEEQ_DMAAR);\r\noutw( SEEQCFG1_BUFFER_MAC0, SEEQ_CFG1);\r\nfor(i=0;i<6;i++) {\r\nprintk("%02x ",inb(SEEQ_BUFFER));\r\n}\r\nprintk("\n");\r\n}\r\noutw( SEEQCFG1_MAC0_EN | SEEQCFG1_MATCH_BROAD | SEEQCFG1_BUFFER_BUFFER, SEEQ_CFG1);\r\noutw( SEEQCFG2_AUTO_REA | SEEQCFG2_CTRLO, SEEQ_CFG2);\r\noutw( SEEQCMD_SET_RX_ON | SEEQCMD_TX_INT_EN | SEEQCMD_RX_INT_EN, SEEQ_CMD);\r\nif (net_debug>4) {\r\nint old_cfg1;\r\nold_cfg1 = inw(SEEQ_CFG1);\r\nprintk("%s: stat = 0x%04x\n",dev->name,inw(SEEQ_STATUS));\r\nprintk("%s: cfg1 = 0x%04x\n",dev->name,old_cfg1);\r\nprintk("%s: cfg2 = 0x%04x\n",dev->name,inw(SEEQ_CFG2));\r\nprintk("%s: raer = 0x%04x\n",dev->name,inw(SEEQ_REA));\r\nprintk("%s: dmaar= 0x%04x\n",dev->name,inw(SEEQ_DMAAR));\r\n}\r\n}\r\nstatic void hardware_send_packet(struct net_device * dev, char *buf, int length)\r\n{\r\nint ioaddr = dev->base_addr;\r\nint status = inw(SEEQ_STATUS);\r\nint transmit_ptr = 0;\r\nunsigned long tmp;\r\nif (net_debug>4) {\r\nprintk("%s: send 0x%04x\n",dev->name,length);\r\n}\r\noutw( SEEQCMD_FIFO_WRITE | (status & SEEQCMD_INT_MASK), SEEQ_CMD);\r\noutw( transmit_ptr, SEEQ_DMAAR);\r\noutw( htons(length + 4), SEEQ_BUFFER);\r\noutw( SEEQPKTH_XMIT | SEEQPKTH_DATA_FOLLOWS | SEEQPKTH_XMIT_INT_EN, SEEQ_BUFFER );\r\noutsw( SEEQ_BUFFER, buf, (length +1) >> 1);\r\noutw( 0, SEEQ_BUFFER);\r\noutw( 0, SEEQ_BUFFER);\r\noutw( transmit_ptr, SEEQ_TPR);\r\ntmp = jiffies;\r\nwhile ( (((status=inw(SEEQ_STATUS)) & SEEQSTAT_FIFO_EMPTY) == 0) && time_before(jiffies, tmp + HZ))\r\nmb();\r\noutw( SEEQCMD_WINDOW_INT_ACK | SEEQCMD_SET_TX_ON | (status & SEEQCMD_INT_MASK), SEEQ_CMD);\r\n}\r\nint __init init_module(void)\r\n{\r\ndev_seeq = seeq8005_probe(-1);\r\nreturn PTR_RET(dev_seeq);\r\n}\r\nvoid __exit cleanup_module(void)\r\n{\r\nunregister_netdev(dev_seeq);\r\nrelease_region(dev_seeq->base_addr, SEEQ8005_IO_EXTENT);\r\nfree_netdev(dev_seeq);\r\n}

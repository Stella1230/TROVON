static inline void assert_ntab_array_sizes(void)\r\n{\r\n#undef check\r\n#define check(table, size) \\r\nBUILD_BUG_ON(ARRAY_SIZE(b43_ntab_##table) != B43_NTAB_##size##_SIZE)\r\ncheck(adjustpower0, C0_ADJPLT);\r\ncheck(adjustpower1, C1_ADJPLT);\r\ncheck(bdi, BDI);\r\ncheck(channelest, CHANEST);\r\ncheck(estimatepowerlt0, C0_ESTPLT);\r\ncheck(estimatepowerlt1, C1_ESTPLT);\r\ncheck(framelookup, FRAMELT);\r\ncheck(framestruct, FRAMESTRUCT);\r\ncheck(gainctl0, C0_GAINCTL);\r\ncheck(gainctl1, C1_GAINCTL);\r\ncheck(intlevel, INTLEVEL);\r\ncheck(iqlt0, C0_IQLT);\r\ncheck(iqlt1, C1_IQLT);\r\ncheck(loftlt0, C0_LOFEEDTH);\r\ncheck(loftlt1, C1_LOFEEDTH);\r\ncheck(mcs, MCS);\r\ncheck(noisevar10, NOISEVAR10);\r\ncheck(noisevar11, NOISEVAR11);\r\ncheck(pilot, PILOT);\r\ncheck(pilotlt, PILOTLT);\r\ncheck(tdi20a0, TDI20A0);\r\ncheck(tdi20a1, TDI20A1);\r\ncheck(tdi40a0, TDI40A0);\r\ncheck(tdi40a1, TDI40A1);\r\ncheck(tdtrn, TDTRN);\r\ncheck(tmap, TMAP);\r\n#undef check\r\n}\r\nu32 b43_ntab_read(struct b43_wldev *dev, u32 offset)\r\n{\r\nu32 type, value;\r\ntype = offset & B43_NTAB_TYPEMASK;\r\noffset &= ~B43_NTAB_TYPEMASK;\r\nB43_WARN_ON(offset > 0xFFFF);\r\nswitch (type) {\r\ncase B43_NTAB_8BIT:\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);\r\nvalue = b43_phy_read(dev, B43_NPHY_TABLE_DATALO) & 0xFF;\r\nbreak;\r\ncase B43_NTAB_16BIT:\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);\r\nvalue = b43_phy_read(dev, B43_NPHY_TABLE_DATALO);\r\nbreak;\r\ncase B43_NTAB_32BIT:\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);\r\nvalue = b43_phy_read(dev, B43_NPHY_TABLE_DATALO);\r\nvalue |= b43_phy_read(dev, B43_NPHY_TABLE_DATAHI) << 16;\r\nbreak;\r\ndefault:\r\nB43_WARN_ON(1);\r\nvalue = 0;\r\n}\r\nreturn value;\r\n}\r\nvoid b43_ntab_read_bulk(struct b43_wldev *dev, u32 offset,\r\nunsigned int nr_elements, void *_data)\r\n{\r\nu32 type;\r\nu8 *data = _data;\r\nunsigned int i;\r\ntype = offset & B43_NTAB_TYPEMASK;\r\noffset &= ~B43_NTAB_TYPEMASK;\r\nB43_WARN_ON(offset > 0xFFFF);\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);\r\nfor (i = 0; i < nr_elements; i++) {\r\nif (dev->dev->chip_id == 43224 && dev->dev->chip_rev == 1) {\r\nb43_phy_read(dev, B43_NPHY_TABLE_DATALO);\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset + i);\r\n}\r\nswitch (type) {\r\ncase B43_NTAB_8BIT:\r\n*data = b43_phy_read(dev, B43_NPHY_TABLE_DATALO) & 0xFF;\r\ndata++;\r\nbreak;\r\ncase B43_NTAB_16BIT:\r\n*((u16 *)data) = b43_phy_read(dev, B43_NPHY_TABLE_DATALO);\r\ndata += 2;\r\nbreak;\r\ncase B43_NTAB_32BIT:\r\n*((u32 *)data) =\r\nb43_phy_read(dev, B43_NPHY_TABLE_DATALO);\r\n*((u32 *)data) |=\r\nb43_phy_read(dev, B43_NPHY_TABLE_DATAHI) << 16;\r\ndata += 4;\r\nbreak;\r\ndefault:\r\nB43_WARN_ON(1);\r\n}\r\n}\r\n}\r\nvoid b43_ntab_write(struct b43_wldev *dev, u32 offset, u32 value)\r\n{\r\nu32 type;\r\ntype = offset & B43_NTAB_TYPEMASK;\r\noffset &= 0xFFFF;\r\nswitch (type) {\r\ncase B43_NTAB_8BIT:\r\nB43_WARN_ON(value & ~0xFF);\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, value);\r\nbreak;\r\ncase B43_NTAB_16BIT:\r\nB43_WARN_ON(value & ~0xFFFF);\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, value);\r\nbreak;\r\ncase B43_NTAB_32BIT:\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATAHI, value >> 16);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, value & 0xFFFF);\r\nbreak;\r\ndefault:\r\nB43_WARN_ON(1);\r\n}\r\nreturn;\r\nassert_ntab_array_sizes();\r\n}\r\nvoid b43_ntab_write_bulk(struct b43_wldev *dev, u32 offset,\r\nunsigned int nr_elements, const void *_data)\r\n{\r\nu32 type, value;\r\nconst u8 *data = _data;\r\nunsigned int i;\r\ntype = offset & B43_NTAB_TYPEMASK;\r\noffset &= ~B43_NTAB_TYPEMASK;\r\nB43_WARN_ON(offset > 0xFFFF);\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset);\r\nfor (i = 0; i < nr_elements; i++) {\r\nif ((offset >> 10) == 9 && dev->dev->chip_id == 43224 &&\r\ndev->dev->chip_rev == 1) {\r\nb43_phy_read(dev, B43_NPHY_TABLE_DATALO);\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, offset + i);\r\n}\r\nswitch (type) {\r\ncase B43_NTAB_8BIT:\r\nvalue = *data;\r\ndata++;\r\nB43_WARN_ON(value & ~0xFF);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, value);\r\nbreak;\r\ncase B43_NTAB_16BIT:\r\nvalue = *((u16 *)data);\r\ndata += 2;\r\nB43_WARN_ON(value & ~0xFFFF);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, value);\r\nbreak;\r\ncase B43_NTAB_32BIT:\r\nvalue = *((u32 *)data);\r\ndata += 4;\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATAHI, value >> 16);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO,\r\nvalue & 0xFFFF);\r\nbreak;\r\ndefault:\r\nB43_WARN_ON(1);\r\n}\r\n}\r\n}\r\nvoid b43_nphy_rev0_1_2_tables_init(struct b43_wldev *dev)\r\n{\r\nntab_upload(dev, B43_NTAB_FRAMESTRUCT, b43_ntab_framestruct);\r\nntab_upload(dev, B43_NTAB_FRAMELT, b43_ntab_framelookup);\r\nntab_upload(dev, B43_NTAB_TMAP, b43_ntab_tmap);\r\nntab_upload(dev, B43_NTAB_TDTRN, b43_ntab_tdtrn);\r\nntab_upload(dev, B43_NTAB_INTLEVEL, b43_ntab_intlevel);\r\nntab_upload(dev, B43_NTAB_PILOT, b43_ntab_pilot);\r\nntab_upload(dev, B43_NTAB_TDI20A0, b43_ntab_tdi20a0);\r\nntab_upload(dev, B43_NTAB_TDI20A1, b43_ntab_tdi20a1);\r\nntab_upload(dev, B43_NTAB_TDI40A0, b43_ntab_tdi40a0);\r\nntab_upload(dev, B43_NTAB_TDI40A1, b43_ntab_tdi40a1);\r\nntab_upload(dev, B43_NTAB_CHANEST, b43_ntab_channelest);\r\nntab_upload(dev, B43_NTAB_MCS, b43_ntab_mcs);\r\nntab_upload(dev, B43_NTAB_NOISEVAR10, b43_ntab_noisevar10);\r\nntab_upload(dev, B43_NTAB_NOISEVAR11, b43_ntab_noisevar11);\r\nntab_upload(dev, B43_NTAB_BDI, b43_ntab_bdi);\r\nntab_upload(dev, B43_NTAB_PILOTLT, b43_ntab_pilotlt);\r\nntab_upload(dev, B43_NTAB_C0_GAINCTL, b43_ntab_gainctl0);\r\nntab_upload(dev, B43_NTAB_C1_GAINCTL, b43_ntab_gainctl1);\r\nntab_upload(dev, B43_NTAB_C0_ESTPLT, b43_ntab_estimatepowerlt0);\r\nntab_upload(dev, B43_NTAB_C1_ESTPLT, b43_ntab_estimatepowerlt1);\r\nntab_upload(dev, B43_NTAB_C0_ADJPLT, b43_ntab_adjustpower0);\r\nntab_upload(dev, B43_NTAB_C1_ADJPLT, b43_ntab_adjustpower1);\r\nntab_upload(dev, B43_NTAB_C0_IQLT, b43_ntab_iqlt0);\r\nntab_upload(dev, B43_NTAB_C1_IQLT, b43_ntab_iqlt1);\r\nntab_upload(dev, B43_NTAB_C0_LOFEEDTH, b43_ntab_loftlt0);\r\nntab_upload(dev, B43_NTAB_C1_LOFEEDTH, b43_ntab_loftlt1);\r\n}\r\nvoid b43_nphy_rev3plus_tables_init(struct b43_wldev *dev)\r\n{\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nntab_upload_r3(dev, B43_NTAB_FRAMESTRUCT_R3, b43_ntab_framestruct_r3);\r\nntab_upload_r3(dev, B43_NTAB_PILOT_R3, b43_ntab_pilot_r3);\r\nntab_upload_r3(dev, B43_NTAB_TMAP_R3, b43_ntab_tmap_r3);\r\nntab_upload_r3(dev, B43_NTAB_INTLEVEL_R3, b43_ntab_intlevel_r3);\r\nntab_upload_r3(dev, B43_NTAB_TDTRN_R3, b43_ntab_tdtrn_r3);\r\nntab_upload_r3(dev, B43_NTAB_NOISEVAR0_R3, b43_ntab_noisevar0_r3);\r\nntab_upload_r3(dev, B43_NTAB_NOISEVAR1_R3, b43_ntab_noisevar1_r3);\r\nntab_upload_r3(dev, B43_NTAB_MCS_R3, b43_ntab_mcs_r3);\r\nntab_upload_r3(dev, B43_NTAB_TDI20A0_R3, b43_ntab_tdi20a0_r3);\r\nntab_upload_r3(dev, B43_NTAB_TDI20A1_R3, b43_ntab_tdi20a1_r3);\r\nntab_upload_r3(dev, B43_NTAB_TDI40A0_R3, b43_ntab_tdi40a0_r3);\r\nntab_upload_r3(dev, B43_NTAB_TDI40A1_R3, b43_ntab_tdi40a1_r3);\r\nntab_upload_r3(dev, B43_NTAB_PILOTLT_R3, b43_ntab_pilotlt_r3);\r\nntab_upload_r3(dev, B43_NTAB_CHANEST_R3, b43_ntab_channelest_r3);\r\nntab_upload_r3(dev, B43_NTAB_FRAMELT_R3, b43_ntab_framelookup_r3);\r\nntab_upload_r3(dev, B43_NTAB_C0_ESTPLT_R3,\r\nb43_ntab_estimatepowerlt0_r3);\r\nntab_upload_r3(dev, B43_NTAB_C1_ESTPLT_R3,\r\nb43_ntab_estimatepowerlt1_r3);\r\nntab_upload_r3(dev, B43_NTAB_C0_ADJPLT_R3, b43_ntab_adjustpower0_r3);\r\nntab_upload_r3(dev, B43_NTAB_C1_ADJPLT_R3, b43_ntab_adjustpower1_r3);\r\nntab_upload_r3(dev, B43_NTAB_C0_GAINCTL_R3, b43_ntab_gainctl0_r3);\r\nntab_upload_r3(dev, B43_NTAB_C1_GAINCTL_R3, b43_ntab_gainctl1_r3);\r\nntab_upload_r3(dev, B43_NTAB_C0_IQLT_R3, b43_ntab_iqlt0_r3);\r\nntab_upload_r3(dev, B43_NTAB_C1_IQLT_R3, b43_ntab_iqlt1_r3);\r\nntab_upload_r3(dev, B43_NTAB_C0_LOFEEDTH_R3, b43_ntab_loftlt0_r3);\r\nntab_upload_r3(dev, B43_NTAB_C1_LOFEEDTH_R3, b43_ntab_loftlt1_r3);\r\nif (sprom->fem.ghz2.antswlut < ARRAY_SIZE(b43_ntab_antswctl2g_r3))\r\nntab_upload_r3(dev, B43_NTAB_ANT_SW_CTL_R3,\r\nb43_ntab_antswctl2g_r3[sprom->fem.ghz2.antswlut]);\r\nelse\r\nB43_WARN_ON(1);\r\n}\r\nstatic const u32 *b43_nphy_get_ipa_gain_table(struct b43_wldev *dev)\r\n{\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {\r\nif (dev->phy.rev >= 6) {\r\nif (dev->dev->chip_id == 47162)\r\nreturn txpwrctrl_tx_gain_ipa_rev5;\r\nreturn txpwrctrl_tx_gain_ipa_rev6;\r\n} else if (dev->phy.rev >= 5) {\r\nreturn txpwrctrl_tx_gain_ipa_rev5;\r\n} else {\r\nreturn txpwrctrl_tx_gain_ipa;\r\n}\r\n} else {\r\nreturn txpwrctrl_tx_gain_ipa_5g;\r\n}\r\n}\r\nconst u32 *b43_nphy_get_tx_gain_table(struct b43_wldev *dev)\r\n{\r\nenum ieee80211_band band = b43_current_band(dev->wl);\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nif (dev->phy.rev < 3)\r\nreturn b43_ntab_tx_gain_rev0_1_2;\r\nif ((dev->phy.n->ipa2g_on && band == IEEE80211_BAND_2GHZ) ||\r\n(dev->phy.n->ipa5g_on && band == IEEE80211_BAND_5GHZ)) {\r\nreturn b43_nphy_get_ipa_gain_table(dev);\r\n} else if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ) {\r\nif (dev->phy.rev == 3)\r\nreturn b43_ntab_tx_gain_rev3_5ghz;\r\nif (dev->phy.rev == 4)\r\nreturn sprom->fem.ghz5.extpa_gain == 3 ?\r\nb43_ntab_tx_gain_rev4_5ghz :\r\nb43_ntab_tx_gain_rev4_5ghz;\r\nelse\r\nreturn b43_ntab_tx_gain_rev5plus_5ghz;\r\n} else {\r\nif (dev->phy.rev >= 5 && sprom->fem.ghz5.extpa_gain == 3)\r\nreturn b43_ntab_tx_gain_rev3plus_2ghz;\r\nelse\r\nreturn b43_ntab_tx_gain_rev3plus_2ghz;\r\n}\r\n}\r\nstruct nphy_gain_ctl_workaround_entry *b43_nphy_get_gain_ctl_workaround_ent(\r\nstruct b43_wldev *dev, bool ghz5, bool ext_lna)\r\n{\r\nstruct nphy_gain_ctl_workaround_entry *e;\r\nu8 phy_idx;\r\nu8 tr_iso = ghz5 ? dev->dev->bus_sprom->fem.ghz5.tr_iso :\r\ndev->dev->bus_sprom->fem.ghz2.tr_iso;\r\nif (!ghz5 && dev->phy.rev >= 6 && dev->phy.radio_rev == 11)\r\nreturn &nphy_gain_ctl_wa_phy6_radio11_ghz2;\r\nB43_WARN_ON(dev->phy.rev < 3);\r\nif (dev->phy.rev >= 6)\r\nphy_idx = 3;\r\nelse if (dev->phy.rev == 5)\r\nphy_idx = 2;\r\nelse if (dev->phy.rev == 4)\r\nphy_idx = 1;\r\nelse\r\nphy_idx = 0;\r\ne = &nphy_gain_ctl_workaround[ghz5][phy_idx];\r\nif (ghz5 && dev->phy.rev >= 6) {\r\nif (dev->phy.radio_rev == 11 &&\r\n!b43_channel_type_is_40mhz(dev->phy.channel_type))\r\ne->cliplo_gain = 0x2d;\r\n} else if (!ghz5 && dev->phy.rev >= 5) {\r\nif (ext_lna) {\r\ne->rfseq_init[0] &= ~0x4000;\r\ne->rfseq_init[1] &= ~0x4000;\r\ne->rfseq_init[2] &= ~0x4000;\r\ne->rfseq_init[3] &= ~0x4000;\r\ne->init_gain &= ~0x4000;\r\n}\r\nswitch (tr_iso) {\r\ncase 0:\r\ne->cliplo_gain = 0x0062;\r\ncase 1:\r\ne->cliplo_gain = 0x0064;\r\ncase 2:\r\ne->cliplo_gain = 0x006a;\r\ncase 3:\r\ne->cliplo_gain = 0x106a;\r\ncase 4:\r\ne->cliplo_gain = 0x106c;\r\ncase 5:\r\ne->cliplo_gain = 0x1074;\r\ncase 6:\r\ne->cliplo_gain = 0x107c;\r\ncase 7:\r\ne->cliplo_gain = 0x207c;\r\ndefault:\r\ne->cliplo_gain = 0x106a;\r\n}\r\n} else if (ghz5 && dev->phy.rev == 4 && ext_lna) {\r\ne->rfseq_init[0] &= ~0x4000;\r\ne->rfseq_init[1] &= ~0x4000;\r\ne->rfseq_init[2] &= ~0x4000;\r\ne->rfseq_init[3] &= ~0x4000;\r\ne->init_gain &= ~0x4000;\r\ne->rfseq_init[0] |= 0x1000;\r\ne->rfseq_init[1] |= 0x1000;\r\ne->rfseq_init[2] |= 0x1000;\r\ne->rfseq_init[3] |= 0x1000;\r\ne->init_gain |= 0x1000;\r\n}\r\nreturn e;\r\n}\r\nconst struct nphy_rf_control_override_rev7 *b43_nphy_get_rf_ctl_over_rev7(\r\nstruct b43_wldev *dev, u16 field, u8 override)\r\n{\r\nconst struct nphy_rf_control_override_rev7 *e;\r\nu8 size, i;\r\nswitch (override) {\r\ncase 0:\r\ne = tbl_rf_control_override_rev7_over0;\r\nsize = ARRAY_SIZE(tbl_rf_control_override_rev7_over0);\r\nbreak;\r\ncase 1:\r\ne = tbl_rf_control_override_rev7_over1;\r\nsize = ARRAY_SIZE(tbl_rf_control_override_rev7_over1);\r\nbreak;\r\ncase 2:\r\ne = tbl_rf_control_override_rev7_over2;\r\nsize = ARRAY_SIZE(tbl_rf_control_override_rev7_over2);\r\nbreak;\r\ndefault:\r\nb43err(dev->wl, "Invalid override value %d\n", override);\r\nreturn NULL;\r\n}\r\nfor (i = 0; i < size; i++) {\r\nif (e[i].field == field)\r\nreturn &e[i];\r\n}\r\nreturn NULL;\r\n}

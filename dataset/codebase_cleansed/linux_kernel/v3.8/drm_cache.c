static void\r\ndrm_clflush_page(struct page *page)\r\n{\r\nuint8_t *page_virtual;\r\nunsigned int i;\r\nconst int size = boot_cpu_data.x86_clflush_size;\r\nif (unlikely(page == NULL))\r\nreturn;\r\npage_virtual = kmap_atomic(page);\r\nfor (i = 0; i < PAGE_SIZE; i += size)\r\nclflush(page_virtual + i);\r\nkunmap_atomic(page_virtual);\r\n}\r\nstatic void drm_cache_flush_clflush(struct page *pages[],\r\nunsigned long num_pages)\r\n{\r\nunsigned long i;\r\nmb();\r\nfor (i = 0; i < num_pages; i++)\r\ndrm_clflush_page(*pages++);\r\nmb();\r\n}\r\nstatic void\r\ndrm_clflush_ipi_handler(void *null)\r\n{\r\nwbinvd();\r\n}\r\nvoid\r\ndrm_clflush_pages(struct page *pages[], unsigned long num_pages)\r\n{\r\n#if defined(CONFIG_X86)\r\nif (cpu_has_clflush) {\r\ndrm_cache_flush_clflush(pages, num_pages);\r\nreturn;\r\n}\r\nif (on_each_cpu(drm_clflush_ipi_handler, NULL, 1) != 0)\r\nprintk(KERN_ERR "Timed out waiting for cache flush.\n");\r\n#elif defined(__powerpc__)\r\nunsigned long i;\r\nfor (i = 0; i < num_pages; i++) {\r\nstruct page *page = pages[i];\r\nvoid *page_virtual;\r\nif (unlikely(page == NULL))\r\ncontinue;\r\npage_virtual = kmap_atomic(page);\r\nflush_dcache_range((unsigned long)page_virtual,\r\n(unsigned long)page_virtual + PAGE_SIZE);\r\nkunmap_atomic(page_virtual);\r\n}\r\n#else\r\nprintk(KERN_ERR "Architecture has no drm_cache.c support\n");\r\nWARN_ON_ONCE(1);\r\n#endif\r\n}\r\nvoid\r\ndrm_clflush_sg(struct sg_table *st)\r\n{\r\n#if defined(CONFIG_X86)\r\nif (cpu_has_clflush) {\r\nstruct scatterlist *sg;\r\nint i;\r\nmb();\r\nfor_each_sg(st->sgl, sg, st->nents, i)\r\ndrm_clflush_page(sg_page(sg));\r\nmb();\r\nreturn;\r\n}\r\nif (on_each_cpu(drm_clflush_ipi_handler, NULL, 1) != 0)\r\nprintk(KERN_ERR "Timed out waiting for cache flush.\n");\r\n#else\r\nprintk(KERN_ERR "Architecture has no drm_cache.c support\n");\r\nWARN_ON_ONCE(1);\r\n#endif\r\n}\r\nvoid\r\ndrm_clflush_virt_range(char *addr, unsigned long length)\r\n{\r\n#if defined(CONFIG_X86)\r\nif (cpu_has_clflush) {\r\nchar *end = addr + length;\r\nmb();\r\nfor (; addr < end; addr += boot_cpu_data.x86_clflush_size)\r\nclflush(addr);\r\nclflush(end - 1);\r\nmb();\r\nreturn;\r\n}\r\nif (on_each_cpu(drm_clflush_ipi_handler, NULL, 1) != 0)\r\nprintk(KERN_ERR "Timed out waiting for cache flush.\n");\r\n#else\r\nprintk(KERN_ERR "Architecture has no drm_cache.c support\n");\r\nWARN_ON_ONCE(1);\r\n#endif\r\n}

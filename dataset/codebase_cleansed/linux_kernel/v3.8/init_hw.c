int\r\nuf_init_hw(unifi_priv_t *priv)\r\n{\r\nint attempts = 0;\r\nint priv_instance;\r\nCsrResult csrResult = CSR_RESULT_FAILURE;\r\npriv_instance = uf_find_priv(priv);\r\nif (priv_instance == -1) {\r\nunifi_warning(priv, "uf_init_hw: Unknown priv instance, will use fw_init[0]\n");\r\npriv_instance = 0;\r\n}\r\nwhile (1) {\r\nif (attempts > MAX_INIT_ATTEMPTS) {\r\nunifi_error(priv, "Failed to initialise UniFi after %d attempts, "\r\n"giving up.\n",\r\nattempts);\r\nbreak;\r\n}\r\nattempts++;\r\nunifi_info(priv, "Initialising UniFi, attempt %d\n", attempts);\r\nif (fw_init[priv_instance] > 0) {\r\nunifi_notice(priv, "f/w init prevented by module parameter\n");\r\nbreak;\r\n} else if (fw_init[priv_instance] == 0) {\r\nfw_init[priv_instance] ++;\r\n}\r\nCsrSdioClaim(priv->sdio);\r\ncsrResult = unifi_init_card(priv->card, led_mask);\r\nCsrSdioRelease(priv->sdio);\r\nif (csrResult == CSR_WIFI_HIP_RESULT_NO_DEVICE) {\r\nreturn CsrHipResultToStatus(csrResult);\r\n}\r\nif (csrResult == CSR_WIFI_HIP_RESULT_NOT_FOUND) {\r\nunifi_error(priv, "Firmware file required, but not found.\n");\r\nreturn CsrHipResultToStatus(csrResult);\r\n}\r\nif (csrResult != CSR_RESULT_SUCCESS) {\r\nunifi_error(priv, "Failed to initialise UniFi chip.\n");\r\ncontinue;\r\n}\r\nunifi_card_info(priv->card, &priv->card_info);\r\nreturn CsrHipResultToStatus(csrResult);\r\n}\r\nreturn CsrHipResultToStatus(csrResult);\r\n}

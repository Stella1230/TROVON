acpi_status acpi_ns_evaluate(struct acpi_evaluate_info * info)\r\n{\r\nacpi_status status;\r\nstruct acpi_namespace_node *node;\r\nACPI_FUNCTION_TRACE(ns_evaluate);\r\nif (!info) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\ninfo->return_object = NULL;\r\ninfo->param_count = 0;\r\nstatus = acpi_ns_get_node(info->prefix_node, info->pathname,\r\nACPI_NS_NO_UPSEARCH, &info->resolved_node);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif (acpi_ns_get_type(info->resolved_node) ==\r\nACPI_TYPE_LOCAL_METHOD_ALIAS) {\r\ninfo->resolved_node =\r\nACPI_CAST_PTR(struct acpi_namespace_node,\r\ninfo->resolved_node->object);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_NAMES, "%s [%p] Value %p\n", info->pathname,\r\ninfo->resolved_node,\r\nacpi_ns_get_attached_object(info->resolved_node)));\r\nnode = info->resolved_node;\r\nif (acpi_ns_get_type(info->resolved_node) == ACPI_TYPE_METHOD) {\r\ninfo->obj_desc =\r\nacpi_ns_get_attached_object(info->resolved_node);\r\nif (!info->obj_desc) {\r\nACPI_ERROR((AE_INFO,\r\n"Control method has no attached sub-object"));\r\nreturn_ACPI_STATUS(AE_NULL_OBJECT);\r\n}\r\nif (info->parameters) {\r\nwhile (info->parameters[info->param_count]) {\r\nif (info->param_count > ACPI_METHOD_MAX_ARG) {\r\nreturn_ACPI_STATUS(AE_LIMIT);\r\n}\r\ninfo->param_count++;\r\n}\r\n}\r\nACPI_DUMP_PATHNAME(info->resolved_node, "ACPI: Execute Method",\r\nACPI_LV_INFO, _COMPONENT);\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"Method at AML address %p Length %X\n",\r\ninfo->obj_desc->method.aml_start + 1,\r\ninfo->obj_desc->method.aml_length - 1));\r\nacpi_ex_enter_interpreter();\r\nstatus = acpi_ps_execute_method(info);\r\nacpi_ex_exit_interpreter();\r\n} else {\r\nswitch (info->resolved_node->type) {\r\ncase ACPI_TYPE_DEVICE:\r\ncase ACPI_TYPE_EVENT:\r\ncase ACPI_TYPE_MUTEX:\r\ncase ACPI_TYPE_REGION:\r\ncase ACPI_TYPE_THERMAL:\r\ncase ACPI_TYPE_LOCAL_SCOPE:\r\nACPI_ERROR((AE_INFO,\r\n"[%4.4s] Evaluation of object type [%s] is not supported",\r\ninfo->resolved_node->name.ascii,\r\nacpi_ut_get_type_name(info->resolved_node->\r\ntype)));\r\nreturn_ACPI_STATUS(AE_TYPE);\r\ndefault:\r\nbreak;\r\n}\r\nacpi_ex_enter_interpreter();\r\nstatus =\r\nacpi_ex_resolve_node_to_value(&info->resolved_node, NULL);\r\nacpi_ex_exit_interpreter();\r\nif (ACPI_SUCCESS(status)) {\r\nstatus = AE_CTRL_RETURN_VALUE;\r\ninfo->return_object =\r\nACPI_CAST_PTR(union acpi_operand_object,\r\ninfo->resolved_node);\r\nACPI_DEBUG_PRINT((ACPI_DB_NAMES,\r\n"Returning object %p [%s]\n",\r\ninfo->return_object,\r\nacpi_ut_get_object_type_name(info->\r\nreturn_object)));\r\n}\r\n}\r\n(void)acpi_ns_check_predefined_names(node, info->param_count,\r\nstatus, &info->return_object);\r\nif (status == AE_CTRL_RETURN_VALUE) {\r\nif (info->flags & ACPI_IGNORE_RETURN_VALUE) {\r\nacpi_ut_remove_reference(info->return_object);\r\ninfo->return_object = NULL;\r\n}\r\nstatus = AE_OK;\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_NAMES,\r\n"*** Completed evaluation of object %s ***\n",\r\ninfo->pathname));\r\nreturn_ACPI_STATUS(status);\r\n}\r\nvoid acpi_ns_exec_module_code_list(void)\r\n{\r\nunion acpi_operand_object *prev;\r\nunion acpi_operand_object *next;\r\nstruct acpi_evaluate_info *info;\r\nu32 method_count = 0;\r\nACPI_FUNCTION_TRACE(ns_exec_module_code_list);\r\nnext = acpi_gbl_module_code_list;\r\nif (!next) {\r\nreturn_VOID;\r\n}\r\ninfo = ACPI_ALLOCATE(sizeof(struct acpi_evaluate_info));\r\nif (!info) {\r\nreturn_VOID;\r\n}\r\nwhile (next) {\r\nprev = next;\r\nnext = next->method.mutex;\r\nprev->method.mutex = NULL;\r\nacpi_ns_exec_module_code(prev, info);\r\nmethod_count++;\r\nacpi_ut_remove_reference(prev);\r\n}\r\nACPI_INFO((AE_INFO,\r\n"Executed %u blocks of module-level executable AML code",\r\nmethod_count));\r\nACPI_FREE(info);\r\nacpi_gbl_module_code_list = NULL;\r\nreturn_VOID;\r\n}\r\nstatic void\r\nacpi_ns_exec_module_code(union acpi_operand_object *method_obj,\r\nstruct acpi_evaluate_info *info)\r\n{\r\nunion acpi_operand_object *parent_obj;\r\nstruct acpi_namespace_node *parent_node;\r\nacpi_object_type type;\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(ns_exec_module_code);\r\nparent_node = ACPI_CAST_PTR(struct acpi_namespace_node,\r\nmethod_obj->method.next_object);\r\ntype = acpi_ns_get_type(parent_node);\r\nif ((type == ACPI_TYPE_DEVICE) && parent_node->object) {\r\nmethod_obj->method.dispatch.handler =\r\nparent_node->object->device.handler;\r\n}\r\nmethod_obj->method.next_object = NULL;\r\nACPI_MEMSET(info, 0, sizeof(struct acpi_evaluate_info));\r\ninfo->prefix_node = parent_node;\r\nparent_obj = acpi_ns_get_attached_object(parent_node);\r\nif (parent_obj) {\r\nacpi_ut_add_reference(parent_obj);\r\n}\r\nstatus = acpi_ns_attach_object(parent_node, method_obj,\r\nACPI_TYPE_METHOD);\r\nif (ACPI_FAILURE(status)) {\r\ngoto exit;\r\n}\r\nstatus = acpi_ns_evaluate(info);\r\nACPI_DEBUG_PRINT((ACPI_DB_INIT, "Executed module-level code at %p\n",\r\nmethod_obj->method.aml_start));\r\nif (info->return_object) {\r\nacpi_ut_remove_reference(info->return_object);\r\n}\r\nacpi_ns_detach_object(parent_node);\r\nif (parent_obj) {\r\nstatus = acpi_ns_attach_object(parent_node, parent_obj, type);\r\n} else {\r\nparent_node->type = (u8)type;\r\n}\r\nexit:\r\nif (parent_obj) {\r\nacpi_ut_remove_reference(parent_obj);\r\n}\r\nreturn_VOID;\r\n}

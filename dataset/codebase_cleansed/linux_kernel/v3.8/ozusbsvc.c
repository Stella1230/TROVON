int oz_usb_init(void)\r\n{\r\noz_event_log(OZ_EVT_SERVICE, 1, OZ_APPID_USB, 0, 0);\r\nreturn oz_hcd_init();\r\n}\r\nvoid oz_usb_term(void)\r\n{\r\noz_event_log(OZ_EVT_SERVICE, 2, OZ_APPID_USB, 0, 0);\r\noz_hcd_term();\r\n}\r\nint oz_usb_start(struct oz_pd *pd, int resume)\r\n{\r\nint rc = 0;\r\nstruct oz_usb_ctx *usb_ctx;\r\nstruct oz_usb_ctx *old_ctx = 0;\r\noz_event_log(OZ_EVT_SERVICE, 3, OZ_APPID_USB, 0, resume);\r\nif (resume) {\r\noz_trace("USB service resumed.\n");\r\nreturn 0;\r\n}\r\noz_trace("USB service started.\n");\r\nusb_ctx = kzalloc(sizeof(struct oz_usb_ctx), GFP_ATOMIC);\r\nif (usb_ctx == 0)\r\nreturn -ENOMEM;\r\natomic_set(&usb_ctx->ref_count, 1);\r\nusb_ctx->pd = pd;\r\nusb_ctx->stopped = 0;\r\nspin_lock_bh(&pd->app_lock[OZ_APPID_USB-1]);\r\nold_ctx = pd->app_ctx[OZ_APPID_USB-1];\r\nif (old_ctx == 0)\r\npd->app_ctx[OZ_APPID_USB-1] = usb_ctx;\r\noz_usb_get(pd->app_ctx[OZ_APPID_USB-1]);\r\nspin_unlock_bh(&pd->app_lock[OZ_APPID_USB-1]);\r\nif (old_ctx) {\r\noz_trace("Already have USB context.\n");\r\nkfree(usb_ctx);\r\nusb_ctx = old_ctx;\r\n} else if (usb_ctx) {\r\noz_pd_get(pd);\r\n}\r\nif (usb_ctx->hport) {\r\noz_hcd_pd_reset(usb_ctx, usb_ctx->hport);\r\n} else {\r\nusb_ctx->hport = oz_hcd_pd_arrived(usb_ctx);\r\nif (usb_ctx->hport == 0) {\r\noz_trace("USB hub returned null port.\n");\r\nspin_lock_bh(&pd->app_lock[OZ_APPID_USB-1]);\r\npd->app_ctx[OZ_APPID_USB-1] = 0;\r\nspin_unlock_bh(&pd->app_lock[OZ_APPID_USB-1]);\r\noz_usb_put(usb_ctx);\r\nrc = -1;\r\n}\r\n}\r\noz_usb_put(usb_ctx);\r\nreturn rc;\r\n}\r\nvoid oz_usb_stop(struct oz_pd *pd, int pause)\r\n{\r\nstruct oz_usb_ctx *usb_ctx;\r\noz_event_log(OZ_EVT_SERVICE, 4, OZ_APPID_USB, 0, pause);\r\nif (pause) {\r\noz_trace("USB service paused.\n");\r\nreturn;\r\n}\r\nspin_lock_bh(&pd->app_lock[OZ_APPID_USB-1]);\r\nusb_ctx = (struct oz_usb_ctx *)pd->app_ctx[OZ_APPID_USB-1];\r\npd->app_ctx[OZ_APPID_USB-1] = 0;\r\nspin_unlock_bh(&pd->app_lock[OZ_APPID_USB-1]);\r\nif (usb_ctx) {\r\nunsigned long tout = jiffies + HZ;\r\noz_trace("USB service stopping...\n");\r\nusb_ctx->stopped = 1;\r\nwhile ((atomic_read(&usb_ctx->ref_count) > 2) &&\r\ntime_before(jiffies, tout))\r\n;\r\noz_trace("USB service stopped.\n");\r\noz_hcd_pd_departed(usb_ctx->hport);\r\noz_usb_put(usb_ctx);\r\n}\r\n}\r\nvoid oz_usb_get(void *hpd)\r\n{\r\nstruct oz_usb_ctx *usb_ctx = (struct oz_usb_ctx *)hpd;\r\natomic_inc(&usb_ctx->ref_count);\r\n}\r\nvoid oz_usb_put(void *hpd)\r\n{\r\nstruct oz_usb_ctx *usb_ctx = (struct oz_usb_ctx *)hpd;\r\nif (atomic_dec_and_test(&usb_ctx->ref_count)) {\r\noz_trace("Dealloc USB context.\n");\r\noz_pd_put(usb_ctx->pd);\r\nkfree(usb_ctx);\r\n}\r\n}\r\nint oz_usb_heartbeat(struct oz_pd *pd)\r\n{\r\nstruct oz_usb_ctx *usb_ctx;\r\nint rc = 0;\r\nspin_lock_bh(&pd->app_lock[OZ_APPID_USB-1]);\r\nusb_ctx = (struct oz_usb_ctx *)pd->app_ctx[OZ_APPID_USB-1];\r\nif (usb_ctx)\r\noz_usb_get(usb_ctx);\r\nspin_unlock_bh(&pd->app_lock[OZ_APPID_USB-1]);\r\nif (usb_ctx == 0)\r\nreturn rc;\r\nif (usb_ctx->stopped)\r\ngoto done;\r\nif (usb_ctx->hport)\r\nif (oz_hcd_heartbeat(usb_ctx->hport))\r\nrc = 1;\r\ndone:\r\noz_usb_put(usb_ctx);\r\nreturn rc;\r\n}\r\nint oz_usb_stream_create(void *hpd, u8 ep_num)\r\n{\r\nstruct oz_usb_ctx *usb_ctx = (struct oz_usb_ctx *)hpd;\r\nstruct oz_pd *pd = usb_ctx->pd;\r\noz_trace("oz_usb_stream_create(0x%x)\n", ep_num);\r\nif (pd->mode & OZ_F_ISOC_NO_ELTS) {\r\noz_isoc_stream_create(pd, ep_num);\r\n} else {\r\noz_pd_get(pd);\r\nif (oz_elt_stream_create(&pd->elt_buff, ep_num,\r\n4*pd->max_tx_size)) {\r\noz_pd_put(pd);\r\nreturn -1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint oz_usb_stream_delete(void *hpd, u8 ep_num)\r\n{\r\nstruct oz_usb_ctx *usb_ctx = (struct oz_usb_ctx *)hpd;\r\nif (usb_ctx) {\r\nstruct oz_pd *pd = usb_ctx->pd;\r\nif (pd) {\r\noz_trace("oz_usb_stream_delete(0x%x)\n", ep_num);\r\nif (pd->mode & OZ_F_ISOC_NO_ELTS) {\r\noz_isoc_stream_delete(pd, ep_num);\r\n} else {\r\nif (oz_elt_stream_delete(&pd->elt_buff, ep_num))\r\nreturn -1;\r\noz_pd_put(pd);\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid oz_usb_request_heartbeat(void *hpd)\r\n{\r\nstruct oz_usb_ctx *usb_ctx = (struct oz_usb_ctx *)hpd;\r\nif (usb_ctx && usb_ctx->pd)\r\noz_pd_request_heartbeat(usb_ctx->pd);\r\n}

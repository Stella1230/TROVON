static void vp3054_bit_setscl(void *data, int state)\r\n{\r\nstruct cx8802_dev *dev = data;\r\nstruct cx88_core *core = dev->core;\r\nstruct vp3054_i2c_state *vp3054_i2c = dev->vp3054;\r\nif (state) {\r\nvp3054_i2c->state |= 0x0001;\r\nvp3054_i2c->state &= ~0x0100;\r\n} else {\r\nvp3054_i2c->state &= ~0x0001;\r\nvp3054_i2c->state |= 0x0100;\r\n}\r\ncx_write(MO_GP0_IO, 0x010000 | vp3054_i2c->state);\r\ncx_read(MO_GP0_IO);\r\n}\r\nstatic void vp3054_bit_setsda(void *data, int state)\r\n{\r\nstruct cx8802_dev *dev = data;\r\nstruct cx88_core *core = dev->core;\r\nstruct vp3054_i2c_state *vp3054_i2c = dev->vp3054;\r\nif (state) {\r\nvp3054_i2c->state |= 0x0002;\r\nvp3054_i2c->state &= ~0x0200;\r\n} else {\r\nvp3054_i2c->state &= ~0x0002;\r\nvp3054_i2c->state |= 0x0200;\r\n}\r\ncx_write(MO_GP0_IO, 0x020000 | vp3054_i2c->state);\r\ncx_read(MO_GP0_IO);\r\n}\r\nstatic int vp3054_bit_getscl(void *data)\r\n{\r\nstruct cx8802_dev *dev = data;\r\nstruct cx88_core *core = dev->core;\r\nu32 state;\r\nstate = cx_read(MO_GP0_IO);\r\nreturn (state & 0x01) ? 1 : 0;\r\n}\r\nstatic int vp3054_bit_getsda(void *data)\r\n{\r\nstruct cx8802_dev *dev = data;\r\nstruct cx88_core *core = dev->core;\r\nu32 state;\r\nstate = cx_read(MO_GP0_IO);\r\nreturn (state & 0x02) ? 1 : 0;\r\n}\r\nint vp3054_i2c_probe(struct cx8802_dev *dev)\r\n{\r\nstruct cx88_core *core = dev->core;\r\nstruct vp3054_i2c_state *vp3054_i2c;\r\nint rc;\r\nif (core->boardnr != CX88_BOARD_DNTV_LIVE_DVB_T_PRO)\r\nreturn 0;\r\nvp3054_i2c = kzalloc(sizeof(*vp3054_i2c), GFP_KERNEL);\r\nif (vp3054_i2c == NULL)\r\nreturn -ENOMEM;\r\ndev->vp3054 = vp3054_i2c;\r\nmemcpy(&vp3054_i2c->algo, &vp3054_i2c_algo_template,\r\nsizeof(vp3054_i2c->algo));\r\nvp3054_i2c->adap.dev.parent = &dev->pci->dev;\r\nstrlcpy(vp3054_i2c->adap.name, core->name,\r\nsizeof(vp3054_i2c->adap.name));\r\nvp3054_i2c->adap.owner = THIS_MODULE;\r\nvp3054_i2c->algo.data = dev;\r\ni2c_set_adapdata(&vp3054_i2c->adap, dev);\r\nvp3054_i2c->adap.algo_data = &vp3054_i2c->algo;\r\nvp3054_bit_setscl(dev,1);\r\nvp3054_bit_setsda(dev,1);\r\nrc = i2c_bit_add_bus(&vp3054_i2c->adap);\r\nif (0 != rc) {\r\nprintk("%s: vp3054_i2c register FAILED\n", core->name);\r\nkfree(dev->vp3054);\r\ndev->vp3054 = NULL;\r\n}\r\nreturn rc;\r\n}\r\nvoid vp3054_i2c_remove(struct cx8802_dev *dev)\r\n{\r\nstruct vp3054_i2c_state *vp3054_i2c = dev->vp3054;\r\nif (vp3054_i2c == NULL ||\r\ndev->core->boardnr != CX88_BOARD_DNTV_LIVE_DVB_T_PRO)\r\nreturn;\r\ni2c_del_adapter(&vp3054_i2c->adap);\r\nkfree(vp3054_i2c);\r\n}

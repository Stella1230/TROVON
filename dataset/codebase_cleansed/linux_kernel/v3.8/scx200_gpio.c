static int scx200_gpio_open(struct inode *inode, struct file *file)\r\n{\r\nunsigned m = iminor(inode);\r\nfile->private_data = &scx200_gpio_ops;\r\nif (m >= MAX_PINS)\r\nreturn -EINVAL;\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int scx200_gpio_release(struct inode *inode, struct file *file)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __init scx200_gpio_init(void)\r\n{\r\nint rc;\r\ndev_t devid;\r\nif (!scx200_gpio_present()) {\r\nprintk(KERN_ERR DRVNAME ": no SCx200 gpio present\n");\r\nreturn -ENODEV;\r\n}\r\npdev = platform_device_alloc(DRVNAME, 0);\r\nif (!pdev)\r\nreturn -ENOMEM;\r\nrc = platform_device_add(pdev);\r\nif (rc)\r\ngoto undo_malloc;\r\nscx200_gpio_ops.dev = &pdev->dev;\r\nif (major) {\r\ndevid = MKDEV(major, 0);\r\nrc = register_chrdev_region(devid, MAX_PINS, "scx200_gpio");\r\n} else {\r\nrc = alloc_chrdev_region(&devid, 0, MAX_PINS, "scx200_gpio");\r\nmajor = MAJOR(devid);\r\n}\r\nif (rc < 0) {\r\ndev_err(&pdev->dev, "SCx200 chrdev_region err: %d\n", rc);\r\ngoto undo_platform_device_add;\r\n}\r\ncdev_init(&scx200_gpio_cdev, &scx200_gpio_fileops);\r\ncdev_add(&scx200_gpio_cdev, devid, MAX_PINS);\r\nreturn 0;\r\nundo_platform_device_add:\r\nplatform_device_del(pdev);\r\nundo_malloc:\r\nplatform_device_put(pdev);\r\nreturn rc;\r\n}\r\nstatic void __exit scx200_gpio_cleanup(void)\r\n{\r\ncdev_del(&scx200_gpio_cdev);\r\nunregister_chrdev_region(MKDEV(major, 0), MAX_PINS);\r\nplatform_device_unregister(pdev);\r\n}

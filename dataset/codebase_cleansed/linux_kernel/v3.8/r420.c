void r420_pm_init_profile(struct radeon_device *rdev)\r\n{\r\nrdev->pm.profiles[PM_PROFILE_DEFAULT_IDX].dpms_off_ps_idx = rdev->pm.default_power_state_index;\r\nrdev->pm.profiles[PM_PROFILE_DEFAULT_IDX].dpms_on_ps_idx = rdev->pm.default_power_state_index;\r\nrdev->pm.profiles[PM_PROFILE_DEFAULT_IDX].dpms_off_cm_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_DEFAULT_IDX].dpms_on_cm_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_LOW_SH_IDX].dpms_off_ps_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_LOW_SH_IDX].dpms_on_ps_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_LOW_SH_IDX].dpms_off_cm_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_LOW_SH_IDX].dpms_on_cm_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_MID_SH_IDX].dpms_off_ps_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_MID_SH_IDX].dpms_on_ps_idx = 1;\r\nrdev->pm.profiles[PM_PROFILE_MID_SH_IDX].dpms_off_cm_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_MID_SH_IDX].dpms_on_cm_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_HIGH_SH_IDX].dpms_off_ps_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_HIGH_SH_IDX].dpms_on_ps_idx = rdev->pm.default_power_state_index;\r\nrdev->pm.profiles[PM_PROFILE_HIGH_SH_IDX].dpms_off_cm_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_HIGH_SH_IDX].dpms_on_cm_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_LOW_MH_IDX].dpms_off_ps_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_LOW_MH_IDX].dpms_on_ps_idx = rdev->pm.default_power_state_index;\r\nrdev->pm.profiles[PM_PROFILE_LOW_MH_IDX].dpms_off_cm_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_LOW_MH_IDX].dpms_on_cm_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_MID_MH_IDX].dpms_off_ps_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_MID_MH_IDX].dpms_on_ps_idx = rdev->pm.default_power_state_index;\r\nrdev->pm.profiles[PM_PROFILE_MID_MH_IDX].dpms_off_cm_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_MID_MH_IDX].dpms_on_cm_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_HIGH_MH_IDX].dpms_off_ps_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_HIGH_MH_IDX].dpms_on_ps_idx = rdev->pm.default_power_state_index;\r\nrdev->pm.profiles[PM_PROFILE_HIGH_MH_IDX].dpms_off_cm_idx = 0;\r\nrdev->pm.profiles[PM_PROFILE_HIGH_MH_IDX].dpms_on_cm_idx = 0;\r\n}\r\nstatic void r420_set_reg_safe(struct radeon_device *rdev)\r\n{\r\nrdev->config.r300.reg_safe_bm = r420_reg_safe_bm;\r\nrdev->config.r300.reg_safe_bm_size = ARRAY_SIZE(r420_reg_safe_bm);\r\n}\r\nvoid r420_pipes_init(struct radeon_device *rdev)\r\n{\r\nunsigned tmp;\r\nunsigned gb_pipe_select;\r\nunsigned num_pipes;\r\nWREG32(R300_GA_ENHANCE, R300_GA_DEADLOCK_CNTL | R300_GA_FASTSYNC_CNTL |\r\n(1 << 2) | (1 << 3));\r\nif (r100_gui_wait_for_idle(rdev)) {\r\nprintk(KERN_WARNING "Failed to wait GUI idle while "\r\n"programming pipes. Bad things might happen.\n");\r\n}\r\ngb_pipe_select = RREG32(R400_GB_PIPE_SELECT);\r\nnum_pipes = ((gb_pipe_select >> 12) & 3) + 1;\r\nif ((rdev->pdev->device == 0x5e4c) ||\r\n(rdev->pdev->device == 0x5e4f))\r\nnum_pipes = 1;\r\nrdev->num_gb_pipes = num_pipes;\r\ntmp = 0;\r\nswitch (num_pipes) {\r\ndefault:\r\nnum_pipes = 1;\r\ncase 1:\r\ntmp = (0 << 1);\r\nbreak;\r\ncase 2:\r\ntmp = (3 << 1);\r\nbreak;\r\ncase 3:\r\ntmp = (6 << 1);\r\nbreak;\r\ncase 4:\r\ntmp = (7 << 1);\r\nbreak;\r\n}\r\nWREG32(R500_SU_REG_DEST, (1 << num_pipes) - 1);\r\ntmp |= R300_TILE_SIZE_16 | R300_ENABLE_TILING;\r\nWREG32(R300_GB_TILE_CONFIG, tmp);\r\nif (r100_gui_wait_for_idle(rdev)) {\r\nprintk(KERN_WARNING "Failed to wait GUI idle while "\r\n"programming pipes. Bad things might happen.\n");\r\n}\r\ntmp = RREG32(R300_DST_PIPE_CONFIG);\r\nWREG32(R300_DST_PIPE_CONFIG, tmp | R300_PIPE_AUTO_CONFIG);\r\nWREG32(R300_RB2D_DSTCACHE_MODE,\r\nRREG32(R300_RB2D_DSTCACHE_MODE) |\r\nR300_DC_AUTOFLUSH_ENABLE |\r\nR300_DC_DC_DISABLE_IGNORE_PE);\r\nif (r100_gui_wait_for_idle(rdev)) {\r\nprintk(KERN_WARNING "Failed to wait GUI idle while "\r\n"programming pipes. Bad things might happen.\n");\r\n}\r\nif (rdev->family == CHIP_RV530) {\r\ntmp = RREG32(RV530_GB_PIPE_SELECT2);\r\nif ((tmp & 3) == 3)\r\nrdev->num_z_pipes = 2;\r\nelse\r\nrdev->num_z_pipes = 1;\r\n} else\r\nrdev->num_z_pipes = 1;\r\nDRM_INFO("radeon: %d quad pipes, %d z pipes initialized.\n",\r\nrdev->num_gb_pipes, rdev->num_z_pipes);\r\n}\r\nu32 r420_mc_rreg(struct radeon_device *rdev, u32 reg)\r\n{\r\nu32 r;\r\nWREG32(R_0001F8_MC_IND_INDEX, S_0001F8_MC_IND_ADDR(reg));\r\nr = RREG32(R_0001FC_MC_IND_DATA);\r\nreturn r;\r\n}\r\nvoid r420_mc_wreg(struct radeon_device *rdev, u32 reg, u32 v)\r\n{\r\nWREG32(R_0001F8_MC_IND_INDEX, S_0001F8_MC_IND_ADDR(reg) |\r\nS_0001F8_MC_IND_WR_EN(1));\r\nWREG32(R_0001FC_MC_IND_DATA, v);\r\n}\r\nstatic void r420_debugfs(struct radeon_device *rdev)\r\n{\r\nif (r100_debugfs_rbbm_init(rdev)) {\r\nDRM_ERROR("Failed to register debugfs file for RBBM !\n");\r\n}\r\nif (r420_debugfs_pipes_info_init(rdev)) {\r\nDRM_ERROR("Failed to register debugfs file for pipes !\n");\r\n}\r\n}\r\nstatic void r420_clock_resume(struct radeon_device *rdev)\r\n{\r\nu32 sclk_cntl;\r\nif (radeon_dynclks != -1 && radeon_dynclks)\r\nradeon_atom_set_clock_gating(rdev, 1);\r\nsclk_cntl = RREG32_PLL(R_00000D_SCLK_CNTL);\r\nsclk_cntl |= S_00000D_FORCE_CP(1) | S_00000D_FORCE_VIP(1);\r\nif (rdev->family == CHIP_R420)\r\nsclk_cntl |= S_00000D_FORCE_PX(1) | S_00000D_FORCE_TX(1);\r\nWREG32_PLL(R_00000D_SCLK_CNTL, sclk_cntl);\r\n}\r\nstatic void r420_cp_errata_init(struct radeon_device *rdev)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nradeon_scratch_get(rdev, &rdev->config.r300.resync_scratch);\r\nradeon_ring_lock(rdev, ring, 8);\r\nradeon_ring_write(ring, PACKET0(R300_CP_RESYNC_ADDR, 1));\r\nradeon_ring_write(ring, rdev->config.r300.resync_scratch);\r\nradeon_ring_write(ring, 0xDEADBEEF);\r\nradeon_ring_unlock_commit(rdev, ring);\r\n}\r\nstatic void r420_cp_errata_fini(struct radeon_device *rdev)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nradeon_ring_lock(rdev, ring, 8);\r\nradeon_ring_write(ring, PACKET0(R300_RB3D_DSTCACHE_CTLSTAT, 0));\r\nradeon_ring_write(ring, R300_RB3D_DC_FINISH);\r\nradeon_ring_unlock_commit(rdev, ring);\r\nradeon_scratch_free(rdev, rdev->config.r300.resync_scratch);\r\n}\r\nstatic int r420_startup(struct radeon_device *rdev)\r\n{\r\nint r;\r\nr100_set_common_regs(rdev);\r\nr300_mc_program(rdev);\r\nr420_clock_resume(rdev);\r\nif (rdev->flags & RADEON_IS_PCIE) {\r\nr = rv370_pcie_gart_enable(rdev);\r\nif (r)\r\nreturn r;\r\n}\r\nif (rdev->flags & RADEON_IS_PCI) {\r\nr = r100_pci_gart_enable(rdev);\r\nif (r)\r\nreturn r;\r\n}\r\nr420_pipes_init(rdev);\r\nr = radeon_wb_init(rdev);\r\nif (r)\r\nreturn r;\r\nr = radeon_fence_driver_start_ring(rdev, RADEON_RING_TYPE_GFX_INDEX);\r\nif (r) {\r\ndev_err(rdev->dev, "failed initializing CP fences (%d).\n", r);\r\nreturn r;\r\n}\r\nr100_irq_set(rdev);\r\nrdev->config.r300.hdp_cntl = RREG32(RADEON_HOST_PATH_CNTL);\r\nr = r100_cp_init(rdev, 1024 * 1024);\r\nif (r) {\r\ndev_err(rdev->dev, "failed initializing CP (%d).\n", r);\r\nreturn r;\r\n}\r\nr420_cp_errata_init(rdev);\r\nr = radeon_ib_pool_init(rdev);\r\nif (r) {\r\ndev_err(rdev->dev, "IB initialization failed (%d).\n", r);\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nint r420_resume(struct radeon_device *rdev)\r\n{\r\nint r;\r\nif (rdev->flags & RADEON_IS_PCIE)\r\nrv370_pcie_gart_disable(rdev);\r\nif (rdev->flags & RADEON_IS_PCI)\r\nr100_pci_gart_disable(rdev);\r\nr420_clock_resume(rdev);\r\nif (radeon_asic_reset(rdev)) {\r\ndev_warn(rdev->dev, "GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n",\r\nRREG32(R_000E40_RBBM_STATUS),\r\nRREG32(R_0007C0_CP_STAT));\r\n}\r\nif (rdev->is_atom_bios) {\r\natom_asic_init(rdev->mode_info.atom_context);\r\n} else {\r\nradeon_combios_asic_init(rdev->ddev);\r\n}\r\nr420_clock_resume(rdev);\r\nradeon_surface_init(rdev);\r\nrdev->accel_working = true;\r\nr = r420_startup(rdev);\r\nif (r) {\r\nrdev->accel_working = false;\r\n}\r\nreturn r;\r\n}\r\nint r420_suspend(struct radeon_device *rdev)\r\n{\r\nr420_cp_errata_fini(rdev);\r\nr100_cp_disable(rdev);\r\nradeon_wb_disable(rdev);\r\nr100_irq_disable(rdev);\r\nif (rdev->flags & RADEON_IS_PCIE)\r\nrv370_pcie_gart_disable(rdev);\r\nif (rdev->flags & RADEON_IS_PCI)\r\nr100_pci_gart_disable(rdev);\r\nreturn 0;\r\n}\r\nvoid r420_fini(struct radeon_device *rdev)\r\n{\r\nr100_cp_fini(rdev);\r\nradeon_wb_fini(rdev);\r\nradeon_ib_pool_fini(rdev);\r\nradeon_gem_fini(rdev);\r\nif (rdev->flags & RADEON_IS_PCIE)\r\nrv370_pcie_gart_fini(rdev);\r\nif (rdev->flags & RADEON_IS_PCI)\r\nr100_pci_gart_fini(rdev);\r\nradeon_agp_fini(rdev);\r\nradeon_irq_kms_fini(rdev);\r\nradeon_fence_driver_fini(rdev);\r\nradeon_bo_fini(rdev);\r\nif (rdev->is_atom_bios) {\r\nradeon_atombios_fini(rdev);\r\n} else {\r\nradeon_combios_fini(rdev);\r\n}\r\nkfree(rdev->bios);\r\nrdev->bios = NULL;\r\n}\r\nint r420_init(struct radeon_device *rdev)\r\n{\r\nint r;\r\nradeon_scratch_init(rdev);\r\nradeon_surface_init(rdev);\r\nr100_restore_sanity(rdev);\r\nif (!radeon_get_bios(rdev)) {\r\nif (ASIC_IS_AVIVO(rdev))\r\nreturn -EINVAL;\r\n}\r\nif (rdev->is_atom_bios) {\r\nr = radeon_atombios_init(rdev);\r\nif (r) {\r\nreturn r;\r\n}\r\n} else {\r\nr = radeon_combios_init(rdev);\r\nif (r) {\r\nreturn r;\r\n}\r\n}\r\nif (radeon_asic_reset(rdev)) {\r\ndev_warn(rdev->dev,\r\n"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n",\r\nRREG32(R_000E40_RBBM_STATUS),\r\nRREG32(R_0007C0_CP_STAT));\r\n}\r\nif (radeon_boot_test_post_card(rdev) == false)\r\nreturn -EINVAL;\r\nradeon_get_clock_info(rdev->ddev);\r\nif (rdev->flags & RADEON_IS_AGP) {\r\nr = radeon_agp_init(rdev);\r\nif (r) {\r\nradeon_agp_disable(rdev);\r\n}\r\n}\r\nr300_mc_init(rdev);\r\nr420_debugfs(rdev);\r\nr = radeon_fence_driver_init(rdev);\r\nif (r) {\r\nreturn r;\r\n}\r\nr = radeon_irq_kms_init(rdev);\r\nif (r) {\r\nreturn r;\r\n}\r\nr = radeon_bo_init(rdev);\r\nif (r) {\r\nreturn r;\r\n}\r\nif (rdev->family == CHIP_R420)\r\nr100_enable_bm(rdev);\r\nif (rdev->flags & RADEON_IS_PCIE) {\r\nr = rv370_pcie_gart_init(rdev);\r\nif (r)\r\nreturn r;\r\n}\r\nif (rdev->flags & RADEON_IS_PCI) {\r\nr = r100_pci_gart_init(rdev);\r\nif (r)\r\nreturn r;\r\n}\r\nr420_set_reg_safe(rdev);\r\nrdev->accel_working = true;\r\nr = r420_startup(rdev);\r\nif (r) {\r\ndev_err(rdev->dev, "Disabling GPU acceleration\n");\r\nr100_cp_fini(rdev);\r\nradeon_wb_fini(rdev);\r\nradeon_ib_pool_fini(rdev);\r\nradeon_irq_kms_fini(rdev);\r\nif (rdev->flags & RADEON_IS_PCIE)\r\nrv370_pcie_gart_fini(rdev);\r\nif (rdev->flags & RADEON_IS_PCI)\r\nr100_pci_gart_fini(rdev);\r\nradeon_agp_fini(rdev);\r\nrdev->accel_working = false;\r\n}\r\nreturn 0;\r\n}\r\nstatic int r420_debugfs_pipes_info(struct seq_file *m, void *data)\r\n{\r\nstruct drm_info_node *node = (struct drm_info_node *) m->private;\r\nstruct drm_device *dev = node->minor->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nuint32_t tmp;\r\ntmp = RREG32(R400_GB_PIPE_SELECT);\r\nseq_printf(m, "GB_PIPE_SELECT 0x%08x\n", tmp);\r\ntmp = RREG32(R300_GB_TILE_CONFIG);\r\nseq_printf(m, "GB_TILE_CONFIG 0x%08x\n", tmp);\r\ntmp = RREG32(R300_DST_PIPE_CONFIG);\r\nseq_printf(m, "DST_PIPE_CONFIG 0x%08x\n", tmp);\r\nreturn 0;\r\n}\r\nint r420_debugfs_pipes_info_init(struct radeon_device *rdev)\r\n{\r\n#if defined(CONFIG_DEBUG_FS)\r\nreturn radeon_debugfs_add_files(rdev, r420_pipes_info_list, 1);\r\n#else\r\nreturn 0;\r\n#endif\r\n}

void cifs_fscache_get_client_cookie(struct TCP_Server_Info *server)\r\n{\r\nserver->fscache =\r\nfscache_acquire_cookie(cifs_fscache_netfs.primary_index,\r\n&cifs_fscache_server_index_def, server);\r\ncFYI(1, "%s: (0x%p/0x%p)", __func__, server,\r\nserver->fscache);\r\n}\r\nvoid cifs_fscache_release_client_cookie(struct TCP_Server_Info *server)\r\n{\r\ncFYI(1, "%s: (0x%p/0x%p)", __func__, server,\r\nserver->fscache);\r\nfscache_relinquish_cookie(server->fscache, 0);\r\nserver->fscache = NULL;\r\n}\r\nvoid cifs_fscache_get_super_cookie(struct cifs_tcon *tcon)\r\n{\r\nstruct TCP_Server_Info *server = tcon->ses->server;\r\ntcon->fscache =\r\nfscache_acquire_cookie(server->fscache,\r\n&cifs_fscache_super_index_def, tcon);\r\ncFYI(1, "%s: (0x%p/0x%p)", __func__, server->fscache,\r\ntcon->fscache);\r\n}\r\nvoid cifs_fscache_release_super_cookie(struct cifs_tcon *tcon)\r\n{\r\ncFYI(1, "%s: (0x%p)", __func__, tcon->fscache);\r\nfscache_relinquish_cookie(tcon->fscache, 0);\r\ntcon->fscache = NULL;\r\n}\r\nstatic void cifs_fscache_enable_inode_cookie(struct inode *inode)\r\n{\r\nstruct cifsInodeInfo *cifsi = CIFS_I(inode);\r\nstruct cifs_sb_info *cifs_sb = CIFS_SB(inode->i_sb);\r\nstruct cifs_tcon *tcon = cifs_sb_master_tcon(cifs_sb);\r\nif (cifsi->fscache)\r\nreturn;\r\nif (cifs_sb->mnt_cifs_flags & CIFS_MOUNT_FSCACHE) {\r\ncifsi->fscache = fscache_acquire_cookie(tcon->fscache,\r\n&cifs_fscache_inode_object_def, cifsi);\r\ncFYI(1, "%s: got FH cookie (0x%p/0x%p)", __func__,\r\ntcon->fscache, cifsi->fscache);\r\n}\r\n}\r\nvoid cifs_fscache_release_inode_cookie(struct inode *inode)\r\n{\r\nstruct cifsInodeInfo *cifsi = CIFS_I(inode);\r\nif (cifsi->fscache) {\r\ncFYI(1, "%s: (0x%p)", __func__, cifsi->fscache);\r\nfscache_relinquish_cookie(cifsi->fscache, 0);\r\ncifsi->fscache = NULL;\r\n}\r\n}\r\nstatic void cifs_fscache_disable_inode_cookie(struct inode *inode)\r\n{\r\nstruct cifsInodeInfo *cifsi = CIFS_I(inode);\r\nif (cifsi->fscache) {\r\ncFYI(1, "%s: (0x%p)", __func__, cifsi->fscache);\r\nfscache_uncache_all_inode_pages(cifsi->fscache, inode);\r\nfscache_relinquish_cookie(cifsi->fscache, 1);\r\ncifsi->fscache = NULL;\r\n}\r\n}\r\nvoid cifs_fscache_set_inode_cookie(struct inode *inode, struct file *filp)\r\n{\r\nif ((filp->f_flags & O_ACCMODE) != O_RDONLY)\r\ncifs_fscache_disable_inode_cookie(inode);\r\nelse\r\ncifs_fscache_enable_inode_cookie(inode);\r\n}\r\nvoid cifs_fscache_reset_inode_cookie(struct inode *inode)\r\n{\r\nstruct cifsInodeInfo *cifsi = CIFS_I(inode);\r\nstruct cifs_sb_info *cifs_sb = CIFS_SB(inode->i_sb);\r\nstruct fscache_cookie *old = cifsi->fscache;\r\nif (cifsi->fscache) {\r\nfscache_relinquish_cookie(cifsi->fscache, 1);\r\ncifsi->fscache = fscache_acquire_cookie(\r\ncifs_sb_master_tcon(cifs_sb)->fscache,\r\n&cifs_fscache_inode_object_def,\r\ncifsi);\r\ncFYI(1, "%s: new cookie 0x%p oldcookie 0x%p",\r\n__func__, cifsi->fscache, old);\r\n}\r\n}\r\nint cifs_fscache_release_page(struct page *page, gfp_t gfp)\r\n{\r\nif (PageFsCache(page)) {\r\nstruct inode *inode = page->mapping->host;\r\nstruct cifsInodeInfo *cifsi = CIFS_I(inode);\r\ncFYI(1, "%s: (0x%p/0x%p)", __func__, page,\r\ncifsi->fscache);\r\nif (!fscache_maybe_release_page(cifsi->fscache, page, gfp))\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic void cifs_readpage_from_fscache_complete(struct page *page, void *ctx,\r\nint error)\r\n{\r\ncFYI(1, "%s: (0x%p/%d)", __func__, page, error);\r\nif (!error)\r\nSetPageUptodate(page);\r\nunlock_page(page);\r\n}\r\nint __cifs_readpage_from_fscache(struct inode *inode, struct page *page)\r\n{\r\nint ret;\r\ncFYI(1, "%s: (fsc:%p, p:%p, i:0x%p", __func__,\r\nCIFS_I(inode)->fscache, page, inode);\r\nret = fscache_read_or_alloc_page(CIFS_I(inode)->fscache, page,\r\ncifs_readpage_from_fscache_complete,\r\nNULL,\r\nGFP_KERNEL);\r\nswitch (ret) {\r\ncase 0:\r\ncFYI(1, "%s: submitted", __func__);\r\nreturn ret;\r\ncase -ENOBUFS:\r\ncase -ENODATA:\r\ncFYI(1, "%s: %d", __func__, ret);\r\nreturn 1;\r\ndefault:\r\ncERROR(1, "unknown error ret = %d", ret);\r\n}\r\nreturn ret;\r\n}\r\nint __cifs_readpages_from_fscache(struct inode *inode,\r\nstruct address_space *mapping,\r\nstruct list_head *pages,\r\nunsigned *nr_pages)\r\n{\r\nint ret;\r\ncFYI(1, "%s: (0x%p/%u/0x%p)", __func__,\r\nCIFS_I(inode)->fscache, *nr_pages, inode);\r\nret = fscache_read_or_alloc_pages(CIFS_I(inode)->fscache, mapping,\r\npages, nr_pages,\r\ncifs_readpage_from_fscache_complete,\r\nNULL,\r\nmapping_gfp_mask(mapping));\r\nswitch (ret) {\r\ncase 0:\r\ncFYI(1, "%s: submitted", __func__);\r\nreturn ret;\r\ncase -ENOBUFS:\r\ncase -ENODATA:\r\ncFYI(1, "%s: no page", __func__);\r\nreturn 1;\r\ndefault:\r\ncFYI(1, "unknown error ret = %d", ret);\r\n}\r\nreturn ret;\r\n}\r\nvoid __cifs_readpage_to_fscache(struct inode *inode, struct page *page)\r\n{\r\nint ret;\r\ncFYI(1, "%s: (fsc: %p, p: %p, i: %p)", __func__,\r\nCIFS_I(inode)->fscache, page, inode);\r\nret = fscache_write_page(CIFS_I(inode)->fscache, page, GFP_KERNEL);\r\nif (ret != 0)\r\nfscache_uncache_page(CIFS_I(inode)->fscache, page);\r\n}\r\nvoid __cifs_fscache_invalidate_page(struct page *page, struct inode *inode)\r\n{\r\nstruct cifsInodeInfo *cifsi = CIFS_I(inode);\r\nstruct fscache_cookie *cookie = cifsi->fscache;\r\ncFYI(1, "%s: (0x%p/0x%p)", __func__, page, cookie);\r\nfscache_wait_on_page_write(cookie, page);\r\nfscache_uncache_page(cookie, page);\r\n}

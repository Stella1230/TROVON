static void\r\nsable_update_irq_hw(unsigned long bit, unsigned long mask)\r\n{\r\nint port = 0x537;\r\nif (bit >= 16) {\r\nport = 0x53d;\r\nmask >>= 16;\r\n} else if (bit >= 8) {\r\nport = 0x53b;\r\nmask >>= 8;\r\n}\r\noutb(mask, port);\r\n}\r\nstatic void\r\nsable_ack_irq_hw(unsigned long bit)\r\n{\r\nint port, val1, val2;\r\nif (bit >= 16) {\r\nport = 0x53c;\r\nval1 = 0xE0 | (bit - 16);\r\nval2 = 0xE0 | 4;\r\n} else if (bit >= 8) {\r\nport = 0x53a;\r\nval1 = 0xE0 | (bit - 8);\r\nval2 = 0xE0 | 3;\r\n} else {\r\nport = 0x536;\r\nval1 = 0xE0 | (bit - 0);\r\nval2 = 0xE0 | 1;\r\n}\r\noutb(val1, port);\r\noutb(val2, 0x534);\r\n}\r\nstatic void __init\r\nsable_init_irq(void)\r\n{\r\noutb(-1, 0x537);\r\noutb(-1, 0x53b);\r\noutb(-1, 0x53d);\r\noutb(0x44, 0x535);\r\nsable_lynx_irq_swizzle = &sable_irq_swizzle;\r\nsable_lynx_init_irq(40);\r\n}\r\nstatic int __init\r\nsable_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstatic char irq_tab[9][5] __initdata = {\r\n{ 32+0, 32+0, 32+0, 32+0, 32+0},\r\n{ 32+1, 32+1, 32+1, 32+1, 32+1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ 32+2, 32+2, 32+2, 32+2, 32+2},\r\n{ 32+3, 32+3, 32+3, 32+3, 32+3},\r\n{ 32+4, 32+4, 32+4, 32+4, 32+4}\r\n};\r\nlong min_idsel = 0, max_idsel = 8, irqs_per_slot = 5;\r\nreturn COMMON_TABLE_LOOKUP;\r\n}\r\nstatic void\r\nlynx_update_irq_hw(unsigned long bit, unsigned long mask)\r\n{\r\n*(vulp)T2_AIR = 0x40;\r\nmb();\r\n*(vulp)T2_AIR;\r\nmb();\r\n*(vulp)T2_DIR = mask;\r\nmb();\r\nmb();\r\n}\r\nstatic void\r\nlynx_ack_irq_hw(unsigned long bit)\r\n{\r\n*(vulp)T2_VAR = (u_long) bit;\r\nmb();\r\nmb();\r\n}\r\nstatic void __init\r\nlynx_init_irq(void)\r\n{\r\nsable_lynx_irq_swizzle = &lynx_irq_swizzle;\r\nsable_lynx_init_irq(64);\r\n}\r\nstatic int __init\r\nlynx_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstatic char irq_tab[19][5] __initdata = {\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ 28, 28, 28, 28, 28},\r\n{ -1, -1, -1, -1, -1},\r\n{ 32, 32, 33, 34, 35},\r\n{ 36, 36, 37, 38, 39},\r\n{ 40, 40, 41, 42, 43},\r\n{ 44, 44, 45, 46, 47},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ 28, 28, 28, 28, 28},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ 48, 48, 49, 50, 51},\r\n{ 52, 52, 53, 54, 55},\r\n{ 56, 56, 57, 58, 59},\r\n{ 60, 60, 61, 62, 63}\r\n};\r\nconst long min_idsel = 2, max_idsel = 20, irqs_per_slot = 5;\r\nreturn COMMON_TABLE_LOOKUP;\r\n}\r\nstatic u8 __init\r\nlynx_swizzle(struct pci_dev *dev, u8 *pinp)\r\n{\r\nint slot, pin = *pinp;\r\nif (dev->bus->number == 0) {\r\nslot = PCI_SLOT(dev->devfn);\r\n}\r\nelse if (PCI_SLOT(dev->bus->self->devfn) == 3) {\r\nslot = PCI_SLOT(dev->devfn) + 11;\r\n}\r\nelse\r\n{\r\ndo {\r\nif (PCI_SLOT(dev->bus->self->devfn) == 3) {\r\nslot = PCI_SLOT(dev->devfn) + 11;\r\nbreak;\r\n}\r\npin = pci_swizzle_interrupt_pin(dev, pin);\r\ndev = dev->bus->self;\r\nslot = PCI_SLOT(dev->devfn);\r\n} while (dev->bus->self);\r\n}\r\n*pinp = pin;\r\nreturn slot;\r\n}\r\nstatic inline void\r\nsable_lynx_enable_irq(struct irq_data *d)\r\n{\r\nunsigned long bit, mask;\r\nbit = sable_lynx_irq_swizzle->irq_to_mask[d->irq];\r\nspin_lock(&sable_lynx_irq_lock);\r\nmask = sable_lynx_irq_swizzle->shadow_mask &= ~(1UL << bit);\r\nsable_lynx_irq_swizzle->update_irq_hw(bit, mask);\r\nspin_unlock(&sable_lynx_irq_lock);\r\n#if 0\r\nprintk("%s: mask 0x%lx bit 0x%lx irq 0x%x\n",\r\n__func__, mask, bit, irq);\r\n#endif\r\n}\r\nstatic void\r\nsable_lynx_disable_irq(struct irq_data *d)\r\n{\r\nunsigned long bit, mask;\r\nbit = sable_lynx_irq_swizzle->irq_to_mask[d->irq];\r\nspin_lock(&sable_lynx_irq_lock);\r\nmask = sable_lynx_irq_swizzle->shadow_mask |= 1UL << bit;\r\nsable_lynx_irq_swizzle->update_irq_hw(bit, mask);\r\nspin_unlock(&sable_lynx_irq_lock);\r\n#if 0\r\nprintk("%s: mask 0x%lx bit 0x%lx irq 0x%x\n",\r\n__func__, mask, bit, irq);\r\n#endif\r\n}\r\nstatic void\r\nsable_lynx_mask_and_ack_irq(struct irq_data *d)\r\n{\r\nunsigned long bit, mask;\r\nbit = sable_lynx_irq_swizzle->irq_to_mask[d->irq];\r\nspin_lock(&sable_lynx_irq_lock);\r\nmask = sable_lynx_irq_swizzle->shadow_mask |= 1UL << bit;\r\nsable_lynx_irq_swizzle->update_irq_hw(bit, mask);\r\nsable_lynx_irq_swizzle->ack_irq_hw(bit);\r\nspin_unlock(&sable_lynx_irq_lock);\r\n}\r\nstatic void\r\nsable_lynx_srm_device_interrupt(unsigned long vector)\r\n{\r\nint bit, irq;\r\nbit = (vector - 0x800) >> 4;\r\nirq = sable_lynx_irq_swizzle->mask_to_irq[bit];\r\n#if 0\r\nprintk("%s: vector 0x%lx bit 0x%x irq 0x%x\n",\r\n__func__, vector, bit, irq);\r\n#endif\r\nhandle_irq(irq);\r\n}\r\nstatic void __init\r\nsable_lynx_init_irq(int nr_of_irqs)\r\n{\r\nlong i;\r\nfor (i = 0; i < nr_of_irqs; ++i) {\r\nirq_set_chip_and_handler(i, &sable_lynx_irq_type,\r\nhandle_level_irq);\r\nirq_set_status_flags(i, IRQ_LEVEL);\r\n}\r\ncommon_init_isa_dma();\r\n}\r\nstatic void __init\r\nsable_lynx_init_pci(void)\r\n{\r\ncommon_init_pci();\r\n}

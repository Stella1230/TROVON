static void nlm_usb_intr_en(int node, int port)\r\n{\r\nuint32_t val;\r\nuint64_t port_addr;\r\nport_addr = nlm_get_usb_regbase(node, port);\r\nval = nlm_read_usb_reg(port_addr, USB_INT_EN);\r\nval = USB_CTRL_INTERRUPT_EN | USB_OHCI_INTERRUPT_EN |\r\nUSB_OHCI_INTERRUPT1_EN | USB_CTRL_INTERRUPT_EN |\r\nUSB_OHCI_INTERRUPT_EN | USB_OHCI_INTERRUPT2_EN;\r\nnlm_write_usb_reg(port_addr, USB_INT_EN, val);\r\n}\r\nstatic void nlm_usb_hw_reset(int node, int port)\r\n{\r\nuint64_t port_addr;\r\nuint32_t val;\r\nport_addr = nlm_get_usb_regbase(node, port);\r\nval = nlm_read_usb_reg(port_addr, USB_PHY_0);\r\nval &= ~(USB_PHY_RESET | USB_PHY_PORT_RESET_0 | USB_PHY_PORT_RESET_1);\r\nnlm_write_usb_reg(port_addr, USB_PHY_0, val);\r\nmdelay(100);\r\nval = nlm_read_usb_reg(port_addr, USB_CTL_0);\r\nval &= ~(USB_CONTROLLER_RESET);\r\nval |= 0x4;\r\nnlm_write_usb_reg(port_addr, USB_CTL_0, val);\r\n}\r\nstatic int __init nlm_platform_usb_init(void)\r\n{\r\npr_info("Initializing USB Interface\n");\r\nnlm_usb_hw_reset(0, 0);\r\nnlm_usb_hw_reset(0, 3);\r\nnlm_usb_intr_en(0, 0);\r\nnlm_usb_intr_en(0, 3);\r\nreturn 0;\r\n}\r\nstatic void nlm_usb_fixup_final(struct pci_dev *dev)\r\n{\r\ndev->dev.dma_mask = &xlp_usb_dmamask;\r\ndev->dev.coherent_dma_mask = DMA_BIT_MASK(64);\r\nswitch (dev->devfn) {\r\ncase 0x10:\r\ndev->irq = PIC_EHCI_0_IRQ;\r\nbreak;\r\ncase 0x11:\r\ndev->irq = PIC_OHCI_0_IRQ;\r\nbreak;\r\ncase 0x12:\r\ndev->irq = PIC_OHCI_1_IRQ;\r\nbreak;\r\ncase 0x13:\r\ndev->irq = PIC_EHCI_1_IRQ;\r\nbreak;\r\ncase 0x14:\r\ndev->irq = PIC_OHCI_2_IRQ;\r\nbreak;\r\ncase 0x15:\r\ndev->irq = PIC_OHCI_3_IRQ;\r\nbreak;\r\n}\r\n}

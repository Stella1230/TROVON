int iio_triggered_buffer_setup(struct iio_dev *indio_dev,\r\nirqreturn_t (*pollfunc_bh)(int irq, void *p),\r\nirqreturn_t (*pollfunc_th)(int irq, void *p),\r\nconst struct iio_buffer_setup_ops *setup_ops)\r\n{\r\nint ret;\r\nindio_dev->buffer = iio_kfifo_allocate(indio_dev);\r\nif (!indio_dev->buffer) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nindio_dev->pollfunc = iio_alloc_pollfunc(pollfunc_bh,\r\npollfunc_th,\r\nIRQF_ONESHOT,\r\nindio_dev,\r\n"%s_consumer%d",\r\nindio_dev->name,\r\nindio_dev->id);\r\nif (indio_dev->pollfunc == NULL) {\r\nret = -ENOMEM;\r\ngoto error_kfifo_free;\r\n}\r\nif (setup_ops)\r\nindio_dev->setup_ops = setup_ops;\r\nelse\r\nindio_dev->setup_ops = &iio_triggered_buffer_setup_ops;\r\nindio_dev->modes |= INDIO_BUFFER_TRIGGERED;\r\nret = iio_buffer_register(indio_dev,\r\nindio_dev->channels,\r\nindio_dev->num_channels);\r\nif (ret)\r\ngoto error_dealloc_pollfunc;\r\nreturn 0;\r\nerror_dealloc_pollfunc:\r\niio_dealloc_pollfunc(indio_dev->pollfunc);\r\nerror_kfifo_free:\r\niio_kfifo_free(indio_dev->buffer);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nvoid iio_triggered_buffer_cleanup(struct iio_dev *indio_dev)\r\n{\r\niio_buffer_unregister(indio_dev);\r\niio_dealloc_pollfunc(indio_dev->pollfunc);\r\niio_kfifo_free(indio_dev->buffer);\r\n}

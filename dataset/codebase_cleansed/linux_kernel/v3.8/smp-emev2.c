static void modify_scu_cpu_psr(unsigned long set, unsigned long clr)\r\n{\r\nunsigned long tmp;\r\nspin_lock(&scu_lock);\r\ntmp = readl(scu_base + 8);\r\ntmp &= ~clr;\r\ntmp |= set;\r\nwritel(tmp, scu_base + 8);\r\nspin_unlock(&scu_lock);\r\n}\r\nstatic unsigned int __init emev2_get_core_count(void)\r\n{\r\nif (!scu_base) {\r\nscu_base = ioremap(EMEV2_SCU_BASE, PAGE_SIZE);\r\nemev2_clock_init();\r\n}\r\nWARN_ON_ONCE(!scu_base);\r\nreturn scu_base ? scu_get_core_count(scu_base) : 1;\r\n}\r\nstatic int emev2_platform_cpu_kill(unsigned int cpu)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused emev2_cpu_kill(unsigned int cpu)\r\n{\r\nint k;\r\nfor (k = 0; k < 1000; k++) {\r\nif (shmobile_cpu_is_dead(cpu))\r\nreturn emev2_platform_cpu_kill(cpu);\r\nmdelay(1);\r\n}\r\nreturn 0;\r\n}\r\nstatic void __cpuinit emev2_secondary_init(unsigned int cpu)\r\n{\r\ngic_secondary_init(0);\r\n}\r\nstatic int __cpuinit emev2_boot_secondary(unsigned int cpu, struct task_struct *idle)\r\n{\r\ncpu = cpu_logical_map(cpu);\r\nmodify_scu_cpu_psr(0, 3 << (cpu * 8));\r\nemev2_set_boot_vector(__pa(shmobile_secondary_vector));\r\ngic_raise_softirq(cpumask_of(cpu), 0);\r\nreturn 0;\r\n}\r\nstatic void __init emev2_smp_prepare_cpus(unsigned int max_cpus)\r\n{\r\nint cpu = cpu_logical_map(0);\r\nscu_enable(scu_base);\r\nmodify_scu_cpu_psr(0, 3 << (cpu * 8));\r\n}\r\nstatic void __init emev2_smp_init_cpus(void)\r\n{\r\nunsigned int ncores = emev2_get_core_count();\r\nshmobile_smp_init_cpus(ncores);\r\n}

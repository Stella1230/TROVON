static void init(struct crypto_tfm *tfm)\r\n{\r\ntfm->__crt_alg->cra_digest.dia_init(crypto_tfm_ctx(tfm));\r\n}\r\nstatic void update(struct crypto_tfm *tfm,\r\nstruct scatterlist *sg, unsigned int nsg)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < nsg; i++) {\r\nstruct page *pg = sg[i].page;\r\nunsigned int offset = sg[i].offset;\r\nunsigned int l = sg[i].length;\r\ndo {\r\nunsigned int bytes_from_page = min(l, ((unsigned int)\r\n(PAGE_SIZE)) -\r\noffset);\r\nchar *p = kmap_atomic(pg) + offset;\r\ntfm->__crt_alg->cra_digest.dia_update\r\n(crypto_tfm_ctx(tfm), p,\r\nbytes_from_page);\r\nkunmap_atomic(p);\r\ncrypto_yield(tfm);\r\noffset = 0;\r\npg++;\r\nl -= bytes_from_page;\r\n} while (l > 0);\r\n}\r\n}\r\nstatic void final(struct crypto_tfm *tfm, u8 *out)\r\n{\r\ntfm->__crt_alg->cra_digest.dia_final(crypto_tfm_ctx(tfm), out);\r\n}\r\nstatic int setkey(struct crypto_tfm *tfm, const u8 *key, unsigned int keylen)\r\n{\r\nu32 flags;\r\nif (tfm->__crt_alg->cra_digest.dia_setkey == NULL)\r\nreturn -ENOSYS;\r\nreturn tfm->__crt_alg->cra_digest.dia_setkey(crypto_tfm_ctx(tfm),\r\nkey, keylen, &flags);\r\n}\r\nstatic void digest(struct crypto_tfm *tfm,\r\nstruct scatterlist *sg, unsigned int nsg, u8 *out)\r\n{\r\nunsigned int i;\r\ntfm->crt_digest.dit_init(tfm);\r\nfor (i = 0; i < nsg; i++) {\r\nchar *p = kmap_atomic(sg[i].page) + sg[i].offset;\r\ntfm->__crt_alg->cra_digest.dia_update(crypto_tfm_ctx(tfm),\r\np, sg[i].length);\r\nkunmap_atomic(p);\r\ncrypto_yield(tfm);\r\n}\r\ncrypto_digest_final(tfm, out);\r\n}\r\nint crypto_init_digest_flags(struct crypto_tfm *tfm, u32 flags)\r\n{\r\nreturn flags ? -EINVAL : 0;\r\n}\r\nint crypto_init_digest_ops(struct crypto_tfm *tfm)\r\n{\r\nstruct digest_tfm *ops = &tfm->crt_digest;\r\nops->dit_init = init;\r\nops->dit_update = update;\r\nops->dit_final = final;\r\nops->dit_digest = digest;\r\nops->dit_setkey = setkey;\r\nreturn crypto_alloc_hmac_block(tfm);\r\n}\r\nvoid crypto_exit_digest_ops(struct crypto_tfm *tfm)\r\n{\r\ncrypto_free_hmac_block(tfm);\r\n}

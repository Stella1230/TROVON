static int ft1000ReadProc(char *page, char **start, off_t off,\r\nint count, int *eof, void *data)\r\n{\r\nstruct net_device *dev;\r\nint len;\r\nint i;\r\nstruct ft1000_info *info;\r\nchar *status[] = {\r\n"Idle (Disconnect)", "Searching", "Active (Connected)",\r\n"Waiting for L2", "Sleep", "No Coverage", "", ""\r\n};\r\nchar *signal[] = { "", "*", "**", "***", "****" };\r\nint strength;\r\nint quality;\r\nstruct timeval tv;\r\ntime_t delta;\r\ndev = (struct net_device *)data;\r\ninfo = netdev_priv(dev);\r\nif (off > 0) {\r\n*eof = 1;\r\nreturn 0;\r\n}\r\nif (info->AsicID == ELECTRABUZZ_ID) {\r\nif (info->ProgConStat != 0xFF) {\r\ninfo->LedStat =\r\nft1000_read_dpram(dev, FT1000_DSP_LED);\r\ninfo->ConStat =\r\nft1000_read_dpram(dev,\r\nFT1000_DSP_CON_STATE);\r\n} else {\r\ninfo->ConStat = 0xf;\r\n}\r\n} else {\r\nif (info->ProgConStat != 0xFF) {\r\ninfo->LedStat =\r\nntohs(ft1000_read_dpram_mag_16\r\n(dev, FT1000_MAG_DSP_LED,\r\nFT1000_MAG_DSP_LED_INDX));\r\ninfo->ConStat =\r\nntohs(ft1000_read_dpram_mag_16\r\n(dev, FT1000_MAG_DSP_CON_STATE,\r\nFT1000_MAG_DSP_CON_STATE_INDX));\r\n} else {\r\ninfo->ConStat = 0xf;\r\n}\r\n}\r\ni = (info->LedStat) & 0xf;\r\nswitch (i) {\r\ncase 0x1:\r\nstrength = 1;\r\nbreak;\r\ncase 0x3:\r\nstrength = 2;\r\nbreak;\r\ncase 0x7:\r\nstrength = 3;\r\nbreak;\r\ncase 0xf:\r\nstrength = 4;\r\nbreak;\r\ndefault:\r\nstrength = 0;\r\n}\r\ni = (info->LedStat >> 8) & 0xf;\r\nswitch (i) {\r\ncase 0x1:\r\nquality = 1;\r\nbreak;\r\ncase 0x3:\r\nquality = 2;\r\nbreak;\r\ncase 0x7:\r\nquality = 3;\r\nbreak;\r\ncase 0xf:\r\nquality = 4;\r\nbreak;\r\ndefault:\r\nquality = 0;\r\n}\r\ndo_gettimeofday(&tv);\r\ndelta = (tv.tv_sec - info->ConTm);\r\nlen = 0;\r\nPUTM_TO_PAGE(len, page, "Connection Time: %02ld:%02ld:%02ld\n",\r\n((delta / 3600) % 24), ((delta / 60) % 60), (delta % 60));\r\nPUTM_TO_PAGE(len, page, "Connection Time[s]: %ld\n", delta);\r\nPUTM_TO_PAGE(len, page, "Asic ID: %s\n",\r\n(info->AsicID) ==\r\nELECTRABUZZ_ID ? "ELECTRABUZZ ASIC" : "MAGNEMITE ASIC");\r\nPUTX_TO_PAGE(len, page, "SKU: ", SKUSZ, info->Sku);\r\nPUTX_TO_PAGE(len, page, "EUI64: ", EUISZ, info->eui64);\r\nPUTD_TO_PAGE(len, page, "DSP version number: ", DSPVERSZ, info->DspVer);\r\nPUTX_TO_PAGE(len, page, "Hardware Serial Number: ", HWSERNUMSZ,\r\ninfo->HwSerNum);\r\nPUTX_TO_PAGE(len, page, "Caliberation Version: ", CALVERSZ,\r\ninfo->RfCalVer);\r\nPUTD_TO_PAGE(len, page, "Caliberation Date: ", CALDATESZ,\r\ninfo->RfCalDate);\r\nPUTM_TO_PAGE(len, page, "Media State: %s\n",\r\n(info->mediastate) ? "link" : "no link");\r\nPUTM_TO_PAGE(len, page, "Connection Status: %s\n",\r\nstatus[((info->ConStat) & 0x7)]);\r\nPUTM_TO_PAGE(len, page, "RX packets: %ld\n", info->stats.rx_packets);\r\nPUTM_TO_PAGE(len, page, "TX packets: %ld\n", info->stats.tx_packets);\r\nPUTM_TO_PAGE(len, page, "RX bytes: %ld\n", info->stats.rx_bytes);\r\nPUTM_TO_PAGE(len, page, "TX bytes: %ld\n", info->stats.tx_bytes);\r\nPUTM_TO_PAGE(len, page, "Signal Strength: %s\n", signal[strength]);\r\nPUTM_TO_PAGE(len, page, "Signal Quality: %s\n", signal[quality]);\r\nreturn len;\r\n}\r\nstatic int ft1000NotifyProc(struct notifier_block *this, unsigned long event,\r\nvoid *ptr)\r\n{\r\nstruct net_device *dev = ptr;\r\nstruct ft1000_info *info;\r\ninfo = netdev_priv(dev);\r\nswitch (event) {\r\ncase NETDEV_CHANGENAME:\r\nremove_proc_entry(info->netdevname, info->proc_ft1000);\r\ncreate_proc_read_entry(dev->name, 0644, info->proc_ft1000,\r\nft1000ReadProc, dev);\r\nsnprintf(info->netdevname, IFNAMSIZ, "%s", dev->name);\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nvoid ft1000InitProc(struct net_device *dev)\r\n{\r\nstruct ft1000_info *info;\r\ninfo = netdev_priv(dev);\r\ninfo->proc_ft1000 = proc_mkdir(FT1000_PROC, init_net.proc_net);\r\ncreate_proc_read_entry(dev->name, 0644, info->proc_ft1000,\r\nft1000ReadProc, dev);\r\nsnprintf(info->netdevname, IFNAMSIZ, "%s", dev->name);\r\nregister_netdevice_notifier(&ft1000_netdev_notifier);\r\n}\r\nvoid ft1000CleanupProc(struct net_device *dev)\r\n{\r\nstruct ft1000_info *info;\r\ninfo = netdev_priv(dev);\r\nremove_proc_entry(dev->name, info->proc_ft1000);\r\nremove_proc_entry(FT1000_PROC, init_net.proc_net);\r\nunregister_netdevice_notifier(&ft1000_netdev_notifier);\r\n}

static int sis_short_ata40(struct pci_dev *dev)\r\n{\r\nconst struct sis_laptop *lap = &sis_laptop[0];\r\nwhile (lap->device) {\r\nif (lap->device == dev->device &&\r\nlap->subvendor == dev->subsystem_vendor &&\r\nlap->subdevice == dev->subsystem_device)\r\nreturn 1;\r\nlap++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sis_old_port_base(struct ata_device *adev)\r\n{\r\nreturn 0x40 + (4 * adev->link->ap->port_no) + (2 * adev->devno);\r\n}\r\nstatic int sis_port_base(struct ata_device *adev)\r\n{\r\nstruct ata_port *ap = adev->link->ap;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint port = 0x40;\r\nu32 reg54;\r\npci_read_config_dword(pdev, 0x54, &reg54);\r\nif (reg54 & 0x40000000)\r\nport = 0x70;\r\nreturn port + (8 * ap->port_no) + (4 * adev->devno);\r\n}\r\nstatic int sis_133_cable_detect(struct ata_port *ap)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu16 tmp;\r\npci_read_config_word(pdev, 0x50 + 2 * ap->port_no, &tmp);\r\nif ((tmp & 0x8000) && !sis_short_ata40(pdev))\r\nreturn ATA_CBL_PATA40;\r\nreturn ATA_CBL_PATA80;\r\n}\r\nstatic int sis_66_cable_detect(struct ata_port *ap)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu8 tmp;\r\npci_read_config_byte(pdev, 0x48, &tmp);\r\ntmp >>= ap->port_no;\r\nif ((tmp & 0x10) && !sis_short_ata40(pdev))\r\nreturn ATA_CBL_PATA40;\r\nreturn ATA_CBL_PATA80;\r\n}\r\nstatic int sis_pre_reset(struct ata_link *link, unsigned long deadline)\r\n{\r\nstatic const struct pci_bits sis_enable_bits[] = {\r\n{ 0x4aU, 1U, 0x02UL, 0x02UL },\r\n{ 0x4aU, 1U, 0x04UL, 0x04UL },\r\n};\r\nstruct ata_port *ap = link->ap;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nif (!pci_test_config_bits(pdev, &sis_enable_bits[ap->port_no]))\r\nreturn -ENOENT;\r\npci_write_config_byte(pdev, 0x4B, 0);\r\nreturn ata_sff_prereset(link, deadline);\r\n}\r\nstatic void sis_set_fifo(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu8 fifoctrl;\r\nu8 mask = 0x11;\r\nmask <<= (2 * ap->port_no);\r\nmask <<= adev->devno;\r\npci_read_config_byte(pdev, 0x4B, &fifoctrl);\r\nfifoctrl &= ~mask;\r\nif (adev->class == ATA_DEV_ATA)\r\nfifoctrl |= mask;\r\npci_write_config_byte(pdev, 0x4B, fifoctrl);\r\n}\r\nstatic void sis_old_set_piomode (struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint port = sis_old_port_base(adev);\r\nu8 t1, t2;\r\nint speed = adev->pio_mode - XFER_PIO_0;\r\nstatic const u8 active[] = { 0x00, 0x07, 0x04, 0x03, 0x01 };\r\nstatic const u8 recovery[] = { 0x00, 0x06, 0x04, 0x03, 0x03 };\r\nsis_set_fifo(ap, adev);\r\npci_read_config_byte(pdev, port, &t1);\r\npci_read_config_byte(pdev, port + 1, &t2);\r\nt1 &= ~0x0F;\r\nt2 &= ~0x07;\r\nt1 |= active[speed];\r\nt2 |= recovery[speed];\r\npci_write_config_byte(pdev, port, t1);\r\npci_write_config_byte(pdev, port + 1, t2);\r\n}\r\nstatic void sis_100_set_piomode (struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint port = sis_old_port_base(adev);\r\nint speed = adev->pio_mode - XFER_PIO_0;\r\nstatic const u8 actrec[] = { 0x00, 0x67, 0x44, 0x33, 0x31 };\r\nsis_set_fifo(ap, adev);\r\npci_write_config_byte(pdev, port, actrec[speed]);\r\n}\r\nstatic void sis_133_set_piomode (struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint port;\r\nu32 t1;\r\nint speed = adev->pio_mode - XFER_PIO_0;\r\nstatic const u32 timing133[] = {\r\n0x28269000,\r\n0x0C266000,\r\n0x04263000,\r\n0x0C0A3000,\r\n0x05093000\r\n};\r\nstatic const u32 timing100[] = {\r\n0x1E1C6000,\r\n0x091C4000,\r\n0x031C2000,\r\n0x09072000,\r\n0x04062000\r\n};\r\nsis_set_fifo(ap, adev);\r\nport = sis_port_base(adev);\r\npci_read_config_dword(pdev, port, &t1);\r\nt1 &= 0xC0C00FFF;\r\nif (t1 & 0x08)\r\nt1 |= timing133[speed];\r\nelse\r\nt1 |= timing100[speed];\r\npci_write_config_byte(pdev, port, t1);\r\n}\r\nstatic void sis_old_set_dmamode (struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint speed = adev->dma_mode - XFER_MW_DMA_0;\r\nint drive_pci = sis_old_port_base(adev);\r\nu16 timing;\r\nstatic const u16 mwdma_bits[] = { 0x008, 0x302, 0x301 };\r\nstatic const u16 udma_bits[] = { 0xE000, 0xC000, 0xA000 };\r\npci_read_config_word(pdev, drive_pci, &timing);\r\nif (adev->dma_mode < XFER_UDMA_0) {\r\ntiming &= ~0x870F;\r\ntiming |= mwdma_bits[speed];\r\n} else {\r\nspeed = adev->dma_mode - XFER_UDMA_0;\r\ntiming &= ~0x6000;\r\ntiming |= udma_bits[speed];\r\n}\r\npci_write_config_word(pdev, drive_pci, timing);\r\n}\r\nstatic void sis_66_set_dmamode (struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint speed = adev->dma_mode - XFER_MW_DMA_0;\r\nint drive_pci = sis_old_port_base(adev);\r\nu16 timing;\r\nstatic const u16 mwdma_bits[] = { 0x008, 0x302, 0x301 };\r\nstatic const u16 udma_bits[] = { 0xF000, 0xD000, 0xB000, 0xA000, 0x9000, 0x8000 };\r\npci_read_config_word(pdev, drive_pci, &timing);\r\nif (adev->dma_mode < XFER_UDMA_0) {\r\ntiming &= ~0x870F;\r\ntiming |= mwdma_bits[speed];\r\n} else {\r\nspeed = adev->dma_mode - XFER_UDMA_0;\r\ntiming &= ~0xF000;\r\ntiming |= udma_bits[speed];\r\n}\r\npci_write_config_word(pdev, drive_pci, timing);\r\n}\r\nstatic void sis_100_set_dmamode (struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint speed = adev->dma_mode - XFER_MW_DMA_0;\r\nint drive_pci = sis_old_port_base(adev);\r\nu8 timing;\r\nstatic const u8 udma_bits[] = { 0x8B, 0x87, 0x85, 0x83, 0x82, 0x81};\r\npci_read_config_byte(pdev, drive_pci + 1, &timing);\r\nif (adev->dma_mode < XFER_UDMA_0) {\r\n} else {\r\nspeed = adev->dma_mode - XFER_UDMA_0;\r\ntiming &= ~0x8F;\r\ntiming |= udma_bits[speed];\r\n}\r\npci_write_config_byte(pdev, drive_pci + 1, timing);\r\n}\r\nstatic void sis_133_early_set_dmamode (struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint speed = adev->dma_mode - XFER_MW_DMA_0;\r\nint drive_pci = sis_old_port_base(adev);\r\nu8 timing;\r\nstatic const u8 udma_bits[] = { 0x8F, 0x8A, 0x87, 0x85, 0x83, 0x82, 0x81};\r\npci_read_config_byte(pdev, drive_pci + 1, &timing);\r\nif (adev->dma_mode < XFER_UDMA_0) {\r\n} else {\r\nspeed = adev->dma_mode - XFER_UDMA_0;\r\ntiming &= ~0x8F;\r\ntiming |= udma_bits[speed];\r\n}\r\npci_write_config_byte(pdev, drive_pci + 1, timing);\r\n}\r\nstatic void sis_133_set_dmamode (struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint port;\r\nu32 t1;\r\nport = sis_port_base(adev);\r\npci_read_config_dword(pdev, port, &t1);\r\nif (adev->dma_mode < XFER_UDMA_0) {\r\nstatic const u32 timing_u100[] = { 0x19154000, 0x06072000, 0x04062000 };\r\nstatic const u32 timing_u133[] = { 0x221C6000, 0x0C0A3000, 0x05093000 };\r\nint speed = adev->dma_mode - XFER_MW_DMA_0;\r\nt1 &= 0xC0C00FFF;\r\nt1 &= ~0x00000004;\r\nif (t1 & 0x08)\r\nt1 |= timing_u133[speed];\r\nelse\r\nt1 |= timing_u100[speed];\r\n} else {\r\nstatic const u32 timing_u100[] = { 0x6B0, 0x470, 0x350, 0x140, 0x120, 0x110, 0x000 };\r\nstatic const u32 timing_u133[] = { 0x9F0, 0x6A0, 0x470, 0x250, 0x230, 0x220, 0x210 };\r\nint speed = adev->dma_mode - XFER_UDMA_0;\r\nt1 &= ~0x00000FF0;\r\nt1 |= 0x00000004;\r\nif (t1 & 0x08)\r\nt1 |= timing_u133[speed];\r\nelse\r\nt1 |= timing_u100[speed];\r\n}\r\npci_write_config_dword(pdev, port, t1);\r\n}\r\nstatic unsigned long sis_133_mode_filter(struct ata_device *adev, unsigned long mask)\r\n{\r\nstruct ata_port *ap = adev->link->ap;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint port = sis_port_base(adev);\r\nu32 t1;\r\npci_read_config_dword(pdev, port, &t1);\r\nif (!(t1 & 0x08))\r\nmask &= ~(0xC0 << ATA_SHIFT_UDMA);\r\nreturn mask;\r\n}\r\nstatic void sis_fixup(struct pci_dev *pdev, struct sis_chipset *sis)\r\n{\r\nu16 regw;\r\nu8 reg;\r\nif (sis->info == &sis_info133) {\r\npci_read_config_word(pdev, 0x50, &regw);\r\nif (regw & 0x08)\r\npci_write_config_word(pdev, 0x50, regw & ~0x08);\r\npci_read_config_word(pdev, 0x52, &regw);\r\nif (regw & 0x08)\r\npci_write_config_word(pdev, 0x52, regw & ~0x08);\r\nreturn;\r\n}\r\nif (sis->info == &sis_info133_early || sis->info == &sis_info100) {\r\npci_write_config_byte(pdev, PCI_LATENCY_TIMER, 0x80);\r\npci_read_config_byte(pdev, 0x49, &reg);\r\nif (!(reg & 0x01))\r\npci_write_config_byte(pdev, 0x49, reg | 0x01);\r\nreturn;\r\n}\r\nif (sis->info == &sis_info66 || sis->info == &sis_info100_early) {\r\npci_write_config_byte(pdev, PCI_LATENCY_TIMER, 0x80);\r\npci_read_config_byte(pdev, 0x52, &reg);\r\nif (!(reg & 0x04))\r\npci_write_config_byte(pdev, 0x52, reg | 0x04);\r\nreturn;\r\n}\r\nif (sis->info == &sis_info33) {\r\npci_read_config_byte(pdev, PCI_CLASS_PROG, &reg);\r\nif (( reg & 0x0F ) != 0x00)\r\npci_write_config_byte(pdev, PCI_CLASS_PROG, reg & 0xF0);\r\n}\r\nif (sis->info == &sis_info || sis->info == &sis_info33) {\r\npci_read_config_byte(pdev, 0x52, &reg);\r\nif (!(reg & 0x08))\r\npci_write_config_byte(pdev, 0x52, reg|0x08);\r\nreturn;\r\n}\r\nBUG();\r\n}\r\nstatic int sis_init_one (struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nconst struct ata_port_info *ppi[] = { NULL, NULL };\r\nstruct pci_dev *host = NULL;\r\nstruct sis_chipset *chipset = NULL;\r\nstruct sis_chipset *sets;\r\nint rc;\r\nstatic struct sis_chipset sis_chipsets[] = {\r\n{ 0x0968, &sis_info133 },\r\n{ 0x0966, &sis_info133 },\r\n{ 0x0965, &sis_info133 },\r\n{ 0x0745, &sis_info100 },\r\n{ 0x0735, &sis_info100 },\r\n{ 0x0733, &sis_info100 },\r\n{ 0x0635, &sis_info100 },\r\n{ 0x0633, &sis_info100 },\r\n{ 0x0730, &sis_info100_early },\r\n{ 0x0550, &sis_info100_early },\r\n{ 0x0640, &sis_info66 },\r\n{ 0x0630, &sis_info66 },\r\n{ 0x0620, &sis_info66 },\r\n{ 0x0540, &sis_info66 },\r\n{ 0x0530, &sis_info66 },\r\n{ 0x5600, &sis_info33 },\r\n{ 0x5598, &sis_info33 },\r\n{ 0x5597, &sis_info33 },\r\n{ 0x5591, &sis_info33 },\r\n{ 0x5582, &sis_info33 },\r\n{ 0x5581, &sis_info33 },\r\n{ 0x5596, &sis_info },\r\n{ 0x5571, &sis_info },\r\n{ 0x5517, &sis_info },\r\n{ 0x5511, &sis_info },\r\n{0}\r\n};\r\nstatic struct sis_chipset sis133_early = {\r\n0x0, &sis_info133_early\r\n};\r\nstatic struct sis_chipset sis133 = {\r\n0x0, &sis_info133\r\n};\r\nstatic struct sis_chipset sis100_early = {\r\n0x0, &sis_info100_early\r\n};\r\nstatic struct sis_chipset sis100 = {\r\n0x0, &sis_info100\r\n};\r\nata_print_version_once(&pdev->dev, DRV_VERSION);\r\nrc = pcim_enable_device(pdev);\r\nif (rc)\r\nreturn rc;\r\nfor (sets = &sis_chipsets[0]; sets->device; sets++) {\r\nhost = pci_get_device(PCI_VENDOR_ID_SI, sets->device, NULL);\r\nif (host != NULL) {\r\nchipset = sets;\r\nif (sets->device == 0x630) {\r\nif (host->revision >= 0x30)\r\nchipset = &sis100_early;\r\n}\r\nbreak;\r\n}\r\n}\r\nif (chipset == NULL) {\r\nu32 idemisc;\r\nu16 trueid;\r\npci_read_config_dword(pdev, 0x54, &idemisc);\r\npci_write_config_dword(pdev, 0x54, idemisc & 0x7fffffff);\r\npci_read_config_word(pdev, PCI_DEVICE_ID, &trueid);\r\npci_write_config_dword(pdev, 0x54, idemisc);\r\nswitch(trueid) {\r\ncase 0x5518:\r\ndev_info(&pdev->dev,\r\n"SiS 962/963 MuTIOL IDE UDMA133 controller\n");\r\nchipset = &sis133;\r\nif ((idemisc & 0x40000000) == 0) {\r\npci_write_config_dword(pdev, 0x54, idemisc | 0x40000000);\r\ndev_info(&pdev->dev,\r\n"Switching to 5513 register mapping\n");\r\n}\r\nbreak;\r\ncase 0x0180:\r\nchipset = &sis133;\r\nbreak;\r\ncase 0x1180:\r\nchipset = &sis133;\r\nbreak;\r\n}\r\n}\r\nif (chipset == NULL) {\r\nstruct pci_dev *lpc_bridge;\r\nu16 trueid;\r\nu8 prefctl;\r\nu8 idecfg;\r\npci_read_config_byte(pdev, 0x4a, &idecfg);\r\npci_write_config_byte(pdev, 0x4a, idecfg | 0x10);\r\npci_read_config_word(pdev, PCI_DEVICE_ID, &trueid);\r\npci_write_config_byte(pdev, 0x4a, idecfg);\r\nswitch(trueid) {\r\ncase 0x5517:\r\nlpc_bridge = pci_get_slot(pdev->bus, 0x10);\r\nif (lpc_bridge == NULL)\r\nbreak;\r\npci_read_config_byte(pdev, 0x49, &prefctl);\r\npci_dev_put(lpc_bridge);\r\nif (lpc_bridge->revision == 0x10 && (prefctl & 0x80)) {\r\nchipset = &sis133_early;\r\nbreak;\r\n}\r\nchipset = &sis100;\r\nbreak;\r\n}\r\n}\r\npci_dev_put(host);\r\nif (chipset == NULL)\r\nreturn -ENODEV;\r\nppi[0] = chipset->info;\r\nsis_fixup(pdev, chipset);\r\nreturn ata_pci_bmdma_init_one(pdev, ppi, &sis_sht, chipset, 0);\r\n}\r\nstatic int sis_reinit_one(struct pci_dev *pdev)\r\n{\r\nstruct ata_host *host = dev_get_drvdata(&pdev->dev);\r\nint rc;\r\nrc = ata_pci_device_do_resume(pdev);\r\nif (rc)\r\nreturn rc;\r\nsis_fixup(pdev, host->private_data);\r\nata_host_resume(host);\r\nreturn 0;\r\n}

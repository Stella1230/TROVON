static int ns558_isa_probe(int io)\r\n{\r\nint i, j, b;\r\nunsigned char c, u, v;\r\nstruct ns558 *ns558;\r\nstruct gameport *port;\r\nif (!request_region(io, 1, "ns558-isa"))\r\nreturn -EBUSY;\r\nc = inb(io);\r\noutb(~c & ~3, io);\r\nif (~(u = v = inb(io)) & 3) {\r\noutb(c, io);\r\nrelease_region(io, 1);\r\nreturn -ENODEV;\r\n}\r\nfor (i = 0; i < 1000; i++) v &= inb(io);\r\nif (u == v) {\r\noutb(c, io);\r\nrelease_region(io, 1);\r\nreturn -ENODEV;\r\n}\r\nmsleep(3);\r\nu = inb(io);\r\nfor (i = 0; i < 1000; i++)\r\nif ((u ^ inb(io)) & 0xf) {\r\noutb(c, io);\r\nrelease_region(io, 1);\r\nreturn -ENODEV;\r\n}\r\nfor (i = 1; i < 5; i++) {\r\nrelease_region(io & (-1 << (i - 1)), (1 << (i - 1)));\r\nif (!request_region(io & (-1 << i), (1 << i), "ns558-isa"))\r\nbreak;\r\noutb(0xff, io & (-1 << i));\r\nfor (j = b = 0; j < 1000; j++)\r\nif (inb(io & (-1 << i)) != inb((io & (-1 << i)) + (1 << i) - 1)) b++;\r\nmsleep(3);\r\nif (b > 300) {\r\nrelease_region(io & (-1 << i), (1 << i));\r\nbreak;\r\n}\r\n}\r\ni--;\r\nif (i != 4) {\r\nif (!request_region(io & (-1 << i), (1 << i), "ns558-isa"))\r\nreturn -EBUSY;\r\n}\r\nns558 = kzalloc(sizeof(struct ns558), GFP_KERNEL);\r\nport = gameport_allocate_port();\r\nif (!ns558 || !port) {\r\nprintk(KERN_ERR "ns558: Memory allocation failed.\n");\r\nrelease_region(io & (-1 << i), (1 << i));\r\nkfree(ns558);\r\ngameport_free_port(port);\r\nreturn -ENOMEM;\r\n}\r\nns558->io = io;\r\nns558->size = 1 << i;\r\nns558->gameport = port;\r\nport->io = io;\r\ngameport_set_name(port, "NS558 ISA Gameport");\r\ngameport_set_phys(port, "isa%04x/gameport0", io & (-1 << i));\r\ngameport_register_port(port);\r\nlist_add(&ns558->node, &ns558_list);\r\nreturn 0;\r\n}\r\nstatic int ns558_pnp_probe(struct pnp_dev *dev, const struct pnp_device_id *did)\r\n{\r\nint ioport, iolen;\r\nstruct ns558 *ns558;\r\nstruct gameport *port;\r\nif (!pnp_port_valid(dev, 0)) {\r\nprintk(KERN_WARNING "ns558: No i/o ports on a gameport? Weird\n");\r\nreturn -ENODEV;\r\n}\r\nioport = pnp_port_start(dev, 0);\r\niolen = pnp_port_len(dev, 0);\r\nif (!request_region(ioport, iolen, "ns558-pnp"))\r\nreturn -EBUSY;\r\nns558 = kzalloc(sizeof(struct ns558), GFP_KERNEL);\r\nport = gameport_allocate_port();\r\nif (!ns558 || !port) {\r\nprintk(KERN_ERR "ns558: Memory allocation failed\n");\r\nkfree(ns558);\r\ngameport_free_port(port);\r\nreturn -ENOMEM;\r\n}\r\nns558->io = ioport;\r\nns558->size = iolen;\r\nns558->dev = dev;\r\nns558->gameport = port;\r\ngameport_set_name(port, "NS558 PnP Gameport");\r\ngameport_set_phys(port, "pnp%s/gameport0", dev_name(&dev->dev));\r\nport->dev.parent = &dev->dev;\r\nport->io = ioport;\r\ngameport_register_port(port);\r\nlist_add_tail(&ns558->node, &ns558_list);\r\nreturn 0;\r\n}\r\nstatic int __init ns558_init(void)\r\n{\r\nint i = 0;\r\nint error;\r\nerror = pnp_register_driver(&ns558_pnp_driver);\r\nif (error && error != -ENODEV)\r\nreturn error;\r\nwhile (ns558_isa_portlist[i])\r\nns558_isa_probe(ns558_isa_portlist[i++]);\r\nreturn list_empty(&ns558_list) && error ? -ENODEV : 0;\r\n}\r\nstatic void __exit ns558_exit(void)\r\n{\r\nstruct ns558 *ns558, *safe;\r\nlist_for_each_entry_safe(ns558, safe, &ns558_list, node) {\r\ngameport_unregister_port(ns558->gameport);\r\nrelease_region(ns558->io & ~(ns558->size - 1), ns558->size);\r\nkfree(ns558);\r\n}\r\npnp_unregister_driver(&ns558_pnp_driver);\r\n}

static long uv_mmtimer_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint ret = 0;\r\nswitch (cmd) {\r\ncase MMTIMER_GETOFFSET:\r\nif (uv_get_min_hub_revision_id() == 1)\r\nret = 0;\r\nelse\r\nret = ((uv_blade_processor_id() * L1_CACHE_BYTES) %\r\nPAGE_SIZE) / 8;\r\nbreak;\r\ncase MMTIMER_GETRES:\r\nif (copy_to_user((unsigned long __user *)arg,\r\n&uv_mmtimer_femtoperiod, sizeof(unsigned long)))\r\nret = -EFAULT;\r\nbreak;\r\ncase MMTIMER_GETFREQ:\r\nif (copy_to_user((unsigned long __user *)arg,\r\n&sn_rtc_cycles_per_second,\r\nsizeof(unsigned long)))\r\nret = -EFAULT;\r\nbreak;\r\ncase MMTIMER_GETBITS:\r\nret = hweight64(UVH_RTC_REAL_TIME_CLOCK_MASK);\r\nbreak;\r\ncase MMTIMER_MMAPAVAIL:\r\nret = 1;\r\nbreak;\r\ncase MMTIMER_GETCOUNTER:\r\nif (copy_to_user((unsigned long __user *)arg,\r\n(unsigned long *)uv_local_mmr_address(UVH_RTC),\r\nsizeof(unsigned long)))\r\nret = -EFAULT;\r\nbreak;\r\ndefault:\r\nret = -ENOTTY;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int uv_mmtimer_mmap(struct file *file, struct vm_area_struct *vma)\r\n{\r\nunsigned long uv_mmtimer_addr;\r\nif (vma->vm_end - vma->vm_start != PAGE_SIZE)\r\nreturn -EINVAL;\r\nif (vma->vm_flags & VM_WRITE)\r\nreturn -EPERM;\r\nif (PAGE_SIZE > (1 << 16))\r\nreturn -ENOSYS;\r\nvma->vm_page_prot = pgprot_noncached(vma->vm_page_prot);\r\nuv_mmtimer_addr = UV_LOCAL_MMR_BASE | UVH_RTC;\r\nuv_mmtimer_addr &= ~(PAGE_SIZE - 1);\r\nuv_mmtimer_addr &= 0xfffffffffffffffUL;\r\nif (remap_pfn_range(vma, vma->vm_start, uv_mmtimer_addr >> PAGE_SHIFT,\r\nPAGE_SIZE, vma->vm_page_prot)) {\r\nprintk(KERN_ERR "remap_pfn_range failed in uv_mmtimer_mmap\n");\r\nreturn -EAGAIN;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init uv_mmtimer_init(void)\r\n{\r\nif (!is_uv_system()) {\r\nprintk(KERN_ERR "%s: Hardware unsupported\n", UV_MMTIMER_NAME);\r\nreturn -1;\r\n}\r\nif (sn_rtc_cycles_per_second < 100000) {\r\nprintk(KERN_ERR "%s: unable to determine clock frequency\n",\r\nUV_MMTIMER_NAME);\r\nreturn -1;\r\n}\r\nuv_mmtimer_femtoperiod = ((unsigned long)1E15 +\r\nsn_rtc_cycles_per_second / 2) /\r\nsn_rtc_cycles_per_second;\r\nif (misc_register(&uv_mmtimer_miscdev)) {\r\nprintk(KERN_ERR "%s: failed to register device\n",\r\nUV_MMTIMER_NAME);\r\nreturn -1;\r\n}\r\nprintk(KERN_INFO "%s: v%s, %ld MHz\n", UV_MMTIMER_DESC,\r\nUV_MMTIMER_VERSION,\r\nsn_rtc_cycles_per_second/(unsigned long)1E6);\r\nreturn 0;\r\n}

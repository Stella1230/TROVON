static u16 led_reg_read(void)\r\n{\r\noutw(0x09, 0x24);\r\nreturn inw(0x26);\r\n}\r\nstatic void led_reg_write(u16 value)\r\n{\r\noutw(0x09, 0x24);\r\noutw(value, 0x26);\r\n}\r\nstatic void shark_led_set(struct led_classdev *cdev,\r\nenum led_brightness b)\r\n{\r\nstruct shark_led *led = container_of(cdev,\r\nstruct shark_led, cdev);\r\nu16 reg = led_reg_read();\r\nif (b != LED_OFF)\r\nreg |= led->mask;\r\nelse\r\nreg &= ~led->mask;\r\nled_reg_write(reg);\r\n}\r\nstatic enum led_brightness shark_led_get(struct led_classdev *cdev)\r\n{\r\nstruct shark_led *led = container_of(cdev,\r\nstruct shark_led, cdev);\r\nu16 reg = led_reg_read();\r\nreturn (reg & led->mask) ? LED_FULL : LED_OFF;\r\n}\r\nstatic int __init shark_leds_init(void)\r\n{\r\nint i;\r\nu16 reg;\r\nif (!machine_is_shark())\r\nreturn -ENODEV;\r\nfor (i = 0; i < ARRAY_SIZE(shark_leds); i++) {\r\nstruct shark_led *led;\r\nled = kzalloc(sizeof(*led), GFP_KERNEL);\r\nif (!led)\r\nbreak;\r\nled->cdev.name = shark_leds[i].name;\r\nled->cdev.brightness_set = shark_led_set;\r\nled->cdev.brightness_get = shark_led_get;\r\nled->cdev.default_trigger = shark_leds[i].trigger;\r\nled->mask = BIT(i + 5);\r\nif (led_classdev_register(NULL, &led->cdev) < 0) {\r\nkfree(led);\r\nbreak;\r\n}\r\n}\r\nrequest_region(0x24, 4, "led_reg");\r\nreg = led_reg_read();\r\nreg |= 1 << 10;\r\nled_reg_write(reg);\r\nreturn 0;\r\n}

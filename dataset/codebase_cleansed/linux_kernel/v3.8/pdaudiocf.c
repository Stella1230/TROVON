static void pdacf_release(struct pcmcia_device *link)\r\n{\r\npcmcia_disable_device(link);\r\n}\r\nstatic int snd_pdacf_free(struct snd_pdacf *pdacf)\r\n{\r\nstruct pcmcia_device *link = pdacf->p_dev;\r\npdacf_release(link);\r\ncard_list[pdacf->index] = NULL;\r\npdacf->card = NULL;\r\nkfree(pdacf);\r\nreturn 0;\r\n}\r\nstatic int snd_pdacf_dev_free(struct snd_device *device)\r\n{\r\nstruct snd_pdacf *chip = device->device_data;\r\nreturn snd_pdacf_free(chip);\r\n}\r\nstatic int snd_pdacf_probe(struct pcmcia_device *link)\r\n{\r\nint i, err;\r\nstruct snd_pdacf *pdacf;\r\nstruct snd_card *card;\r\nstatic struct snd_device_ops ops = {\r\n.dev_free = snd_pdacf_dev_free,\r\n};\r\nsnd_printdd(KERN_DEBUG "pdacf_attach called\n");\r\nfor (i = 0; i < SNDRV_CARDS; i++) {\r\nif (! card_list[i])\r\nbreak;\r\n}\r\nif (i >= SNDRV_CARDS) {\r\nsnd_printk(KERN_ERR "pdacf: too many cards found\n");\r\nreturn -EINVAL;\r\n}\r\nif (! enable[i])\r\nreturn -ENODEV;\r\nerr = snd_card_create(index[i], id[i], THIS_MODULE, 0, &card);\r\nif (err < 0) {\r\nsnd_printk(KERN_ERR "pdacf: cannot create a card instance\n");\r\nreturn err;\r\n}\r\npdacf = snd_pdacf_create(card);\r\nif (!pdacf) {\r\nsnd_card_free(card);\r\nreturn -ENOMEM;\r\n}\r\nerr = snd_device_new(card, SNDRV_DEV_LOWLEVEL, pdacf, &ops);\r\nif (err < 0) {\r\nkfree(pdacf);\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nsnd_card_set_dev(card, &link->dev);\r\npdacf->index = i;\r\ncard_list[i] = card;\r\npdacf->p_dev = link;\r\nlink->priv = pdacf;\r\nlink->resource[0]->flags |= IO_DATA_PATH_WIDTH_AUTO;\r\nlink->resource[0]->end = 16;\r\nlink->config_flags = CONF_ENABLE_IRQ | CONF_ENABLE_PULSE_IRQ;\r\nlink->config_index = 1;\r\nlink->config_regs = PRESENT_OPTION;\r\nreturn pdacf_config(link);\r\n}\r\nstatic int snd_pdacf_assign_resources(struct snd_pdacf *pdacf, int port, int irq)\r\n{\r\nint err;\r\nstruct snd_card *card = pdacf->card;\r\nsnd_printdd(KERN_DEBUG "pdacf assign resources: port = 0x%x, irq = %d\n", port, irq);\r\npdacf->port = port;\r\npdacf->irq = irq;\r\npdacf->chip_status |= PDAUDIOCF_STAT_IS_CONFIGURED;\r\nerr = snd_pdacf_ak4117_create(pdacf);\r\nif (err < 0)\r\nreturn err;\r\nstrcpy(card->driver, "PDAudio-CF");\r\nsprintf(card->shortname, "Core Sound %s", card->driver);\r\nsprintf(card->longname, "%s at 0x%x, irq %i",\r\ncard->shortname, port, irq);\r\nerr = snd_pdacf_pcm_new(pdacf);\r\nif (err < 0)\r\nreturn err;\r\nif ((err = snd_card_register(card)) < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic void snd_pdacf_detach(struct pcmcia_device *link)\r\n{\r\nstruct snd_pdacf *chip = link->priv;\r\nsnd_printdd(KERN_DEBUG "pdacf_detach called\n");\r\nif (chip->chip_status & PDAUDIOCF_STAT_IS_CONFIGURED)\r\nsnd_pdacf_powerdown(chip);\r\nchip->chip_status |= PDAUDIOCF_STAT_IS_STALE;\r\nsnd_card_disconnect(chip->card);\r\nsnd_card_free_when_closed(chip->card);\r\n}\r\nstatic int pdacf_config(struct pcmcia_device *link)\r\n{\r\nstruct snd_pdacf *pdacf = link->priv;\r\nint ret;\r\nsnd_printdd(KERN_DEBUG "pdacf_config called\n");\r\nlink->config_index = 0x5;\r\nlink->config_flags |= CONF_ENABLE_IRQ | CONF_ENABLE_PULSE_IRQ;\r\nret = pcmcia_request_io(link);\r\nif (ret)\r\ngoto failed;\r\nret = pcmcia_request_irq(link, pdacf_interrupt);\r\nif (ret)\r\ngoto failed;\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\nif (snd_pdacf_assign_resources(pdacf, link->resource[0]->start,\r\nlink->irq) < 0)\r\ngoto failed;\r\nreturn 0;\r\nfailed:\r\npcmcia_disable_device(link);\r\nreturn -ENODEV;\r\n}\r\nstatic int pdacf_suspend(struct pcmcia_device *link)\r\n{\r\nstruct snd_pdacf *chip = link->priv;\r\nsnd_printdd(KERN_DEBUG "SUSPEND\n");\r\nif (chip) {\r\nsnd_printdd(KERN_DEBUG "snd_pdacf_suspend calling\n");\r\nsnd_pdacf_suspend(chip);\r\n}\r\nreturn 0;\r\n}\r\nstatic int pdacf_resume(struct pcmcia_device *link)\r\n{\r\nstruct snd_pdacf *chip = link->priv;\r\nsnd_printdd(KERN_DEBUG "RESUME\n");\r\nif (pcmcia_dev_present(link)) {\r\nif (chip) {\r\nsnd_printdd(KERN_DEBUG "calling snd_pdacf_resume\n");\r\nsnd_pdacf_resume(chip);\r\n}\r\n}\r\nsnd_printdd(KERN_DEBUG "resume done!\n");\r\nreturn 0;\r\n}\r\nstatic int __init init_pdacf(void)\r\n{\r\nreturn pcmcia_register_driver(&pdacf_cs_driver);\r\n}\r\nstatic void __exit exit_pdacf(void)\r\n{\r\npcmcia_unregister_driver(&pdacf_cs_driver);\r\n}

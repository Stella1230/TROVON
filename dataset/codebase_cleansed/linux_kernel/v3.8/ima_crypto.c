static int init_desc(struct hash_desc *desc)\r\n{\r\nint rc;\r\ndesc->tfm = crypto_alloc_hash(ima_hash, 0, CRYPTO_ALG_ASYNC);\r\nif (IS_ERR(desc->tfm)) {\r\npr_info("IMA: failed to load %s transform: %ld\n",\r\nima_hash, PTR_ERR(desc->tfm));\r\nrc = PTR_ERR(desc->tfm);\r\nreturn rc;\r\n}\r\ndesc->flags = 0;\r\nrc = crypto_hash_init(desc);\r\nif (rc)\r\ncrypto_free_hash(desc->tfm);\r\nreturn rc;\r\n}\r\nint ima_calc_hash(struct file *file, char *digest)\r\n{\r\nstruct hash_desc desc;\r\nstruct scatterlist sg[1];\r\nloff_t i_size, offset = 0;\r\nchar *rbuf;\r\nint rc, read = 0;\r\nrc = init_desc(&desc);\r\nif (rc != 0)\r\nreturn rc;\r\nrbuf = kzalloc(PAGE_SIZE, GFP_KERNEL);\r\nif (!rbuf) {\r\nrc = -ENOMEM;\r\ngoto out;\r\n}\r\nif (!(file->f_mode & FMODE_READ)) {\r\nfile->f_mode |= FMODE_READ;\r\nread = 1;\r\n}\r\ni_size = i_size_read(file->f_dentry->d_inode);\r\nwhile (offset < i_size) {\r\nint rbuf_len;\r\nrbuf_len = kernel_read(file, offset, rbuf, PAGE_SIZE);\r\nif (rbuf_len < 0) {\r\nrc = rbuf_len;\r\nbreak;\r\n}\r\nif (rbuf_len == 0)\r\nbreak;\r\noffset += rbuf_len;\r\nsg_init_one(sg, rbuf, rbuf_len);\r\nrc = crypto_hash_update(&desc, sg, rbuf_len);\r\nif (rc)\r\nbreak;\r\n}\r\nkfree(rbuf);\r\nif (!rc)\r\nrc = crypto_hash_final(&desc, digest);\r\nif (read)\r\nfile->f_mode &= ~FMODE_READ;\r\nout:\r\ncrypto_free_hash(desc.tfm);\r\nreturn rc;\r\n}\r\nint ima_calc_template_hash(int template_len, void *template, char *digest)\r\n{\r\nstruct hash_desc desc;\r\nstruct scatterlist sg[1];\r\nint rc;\r\nrc = init_desc(&desc);\r\nif (rc != 0)\r\nreturn rc;\r\nsg_init_one(sg, template, template_len);\r\nrc = crypto_hash_update(&desc, sg, template_len);\r\nif (!rc)\r\nrc = crypto_hash_final(&desc, digest);\r\ncrypto_free_hash(desc.tfm);\r\nreturn rc;\r\n}\r\nstatic void __init ima_pcrread(int idx, u8 *pcr)\r\n{\r\nif (!ima_used_chip)\r\nreturn;\r\nif (tpm_pcr_read(TPM_ANY_NUM, idx, pcr) != 0)\r\npr_err("IMA: Error Communicating to TPM chip\n");\r\n}\r\nint __init ima_calc_boot_aggregate(char *digest)\r\n{\r\nstruct hash_desc desc;\r\nstruct scatterlist sg;\r\nu8 pcr_i[IMA_DIGEST_SIZE];\r\nint rc, i;\r\nrc = init_desc(&desc);\r\nif (rc != 0)\r\nreturn rc;\r\nfor (i = TPM_PCR0; i < TPM_PCR8; i++) {\r\nima_pcrread(i, pcr_i);\r\nsg_init_one(&sg, pcr_i, IMA_DIGEST_SIZE);\r\nrc = crypto_hash_update(&desc, &sg, IMA_DIGEST_SIZE);\r\n}\r\nif (!rc)\r\ncrypto_hash_final(&desc, digest);\r\ncrypto_free_hash(desc.tfm);\r\nreturn rc;\r\n}

static void cleanup_card(struct net_device *dev)\r\n{\r\nint ioaddr = dev->base_addr - ULTRA32_NIC_OFFSET;\r\nrelease_region(ioaddr, ULTRA32_IO_EXTENT);\r\niounmap(ei_status.mem);\r\n}\r\nstruct net_device * __init ultra32_probe(int unit)\r\n{\r\nstruct net_device *dev;\r\nint base;\r\nint irq;\r\nint err = -ENODEV;\r\nif (!EISA_bus)\r\nreturn ERR_PTR(-ENODEV);\r\ndev = alloc_ei_netdev();\r\nif (!dev)\r\nreturn ERR_PTR(-ENOMEM);\r\nif (unit >= 0) {\r\nsprintf(dev->name, "eth%d", unit);\r\nnetdev_boot_setup_check(dev);\r\n}\r\nirq = dev->irq;\r\nfor (base = 0x1000 + ULTRA32_BASE; base < 0x9000; base += 0x1000) {\r\nif (ultra32_probe1(dev, base) == 0)\r\nbreak;\r\ndev->irq = irq;\r\n}\r\nif (base >= 0x9000)\r\ngoto out;\r\nerr = register_netdev(dev);\r\nif (err)\r\ngoto out1;\r\nreturn dev;\r\nout1:\r\ncleanup_card(dev);\r\nout:\r\nfree_netdev(dev);\r\nreturn ERR_PTR(err);\r\n}\r\nstatic int __init ultra32_probe1(struct net_device *dev, int ioaddr)\r\n{\r\nint i, edge, media, retval;\r\nint checksum = 0;\r\nconst char *model_name;\r\nstatic unsigned version_printed;\r\nunsigned char idreg;\r\nunsigned char reg4;\r\nconst char *ifmap[] = {"UTP No Link", "", "UTP/AUI", "UTP/BNC"};\r\nif (!request_region(ioaddr, ULTRA32_IO_EXTENT, DRV_NAME))\r\nreturn -EBUSY;\r\nif (inb(ioaddr + ULTRA32_IDPORT) == 0xff ||\r\ninl(ioaddr + ULTRA32_IDPORT) != ULTRA32_ID) {\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\nmedia = inb(ioaddr + ULTRA32_CFG7) & 0x03;\r\nedge = inb(ioaddr + ULTRA32_CFG5) & 0x08;\r\nprintk("SMC Ultra32 in EISA Slot %d, Media: %s, %s IRQs.\n",\r\nioaddr >> 12, ifmap[media],\r\n(edge ? "Edge Triggered" : "Level Sensitive"));\r\nidreg = inb(ioaddr + 7);\r\nreg4 = inb(ioaddr + 4) & 0x7f;\r\nif ((idreg & 0xf0) != 0x20) {\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\noutb(reg4, ioaddr + 4);\r\nfor (i = 0; i < 8; i++)\r\nchecksum += inb(ioaddr + 8 + i);\r\nif ((checksum & 0xff) != 0xff) {\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\nif (ei_debug && version_printed++ == 0)\r\nprintk(version);\r\nmodel_name = "SMC Ultra32";\r\nfor (i = 0; i < 6; i++)\r\ndev->dev_addr[i] = inb(ioaddr + 8 + i);\r\nprintk("%s: %s at 0x%X, %pM",\r\ndev->name, model_name, ioaddr, dev->dev_addr);\r\noutb(0x80 | reg4, ioaddr + 4);\r\noutb(0x80 | inb(ioaddr + 0x0c), ioaddr + 0x0c);\r\noutb(0x00, ioaddr + 0x0b);\r\noutb(reg4, ioaddr + 4);\r\nif ((inb(ioaddr + ULTRA32_CFG5) & 0x40) == 0) {\r\nprintk("\nsmc-ultra32: Card RAM is disabled! "\r\n"Run EISA config utility.\n");\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\nif ((inb(ioaddr + ULTRA32_CFG2) & 0x04) == 0)\r\nprintk("\nsmc-ultra32: Ignoring Bus-Master enable bit. "\r\n"Run EISA config utility.\n");\r\nif (dev->irq < 2) {\r\nunsigned char irqmap[] = {0, 9, 3, 5, 7, 10, 11, 15};\r\nint irq = irqmap[inb(ioaddr + ULTRA32_CFG5) & 0x07];\r\nif (irq == 0) {\r\nprintk(", failed to detect IRQ line.\n");\r\nretval = -EAGAIN;\r\ngoto out;\r\n}\r\ndev->irq = irq;\r\n}\r\ndev->base_addr = ioaddr + ULTRA32_NIC_OFFSET;\r\nei_status.reg0 = inb(ioaddr + ULTRA32_CFG3) & 0xfc;\r\ndev->mem_start = 0xc0000 + ((ei_status.reg0 & 0x7c) << 11);\r\nei_status.name = model_name;\r\nei_status.word16 = 1;\r\nei_status.tx_start_page = 0;\r\nei_status.rx_start_page = TX_PAGES;\r\nei_status.stop_page = 128;\r\nei_status.mem = ioremap(dev->mem_start, 0x2000);\r\nif (!ei_status.mem) {\r\nprintk(", failed to ioremap.\n");\r\nretval = -ENOMEM;\r\ngoto out;\r\n}\r\ndev->mem_end = dev->mem_start + 0x1fff;\r\nprintk(", IRQ %d, 32KB memory, 8KB window at 0x%lx-0x%lx.\n",\r\ndev->irq, dev->mem_start, dev->mem_end);\r\nei_status.block_input = &ultra32_block_input;\r\nei_status.block_output = &ultra32_block_output;\r\nei_status.get_8390_hdr = &ultra32_get_8390_hdr;\r\nei_status.reset_8390 = &ultra32_reset_8390;\r\ndev->netdev_ops = &ultra32_netdev_ops;\r\nNS8390_init(dev, 0);\r\nreturn 0;\r\nout:\r\nrelease_region(ioaddr, ULTRA32_IO_EXTENT);\r\nreturn retval;\r\n}\r\nstatic int ultra32_open(struct net_device *dev)\r\n{\r\nint ioaddr = dev->base_addr - ULTRA32_NIC_OFFSET;\r\nint irq_flags = (inb(ioaddr + ULTRA32_CFG5) & 0x08) ? 0 : IRQF_SHARED;\r\nint retval;\r\nretval = request_irq(dev->irq, ei_interrupt, irq_flags, dev->name, dev);\r\nif (retval)\r\nreturn retval;\r\noutb(ULTRA32_MEMENB, ioaddr);\r\noutb(0x80, ioaddr + ULTRA32_CFG6);\r\noutb(0x84, ioaddr + 5);\r\noutb(0x01, ioaddr + 6);\r\noutb_p(E8390_NODMA+E8390_PAGE0, dev->base_addr);\r\noutb(0xff, dev->base_addr + EN0_ERWCNT);\r\nei_open(dev);\r\nreturn 0;\r\n}\r\nstatic int ultra32_close(struct net_device *dev)\r\n{\r\nint ioaddr = dev->base_addr - ULTRA32_NIC_OFFSET;\r\nnetif_stop_queue(dev);\r\nif (ei_debug > 1)\r\nprintk("%s: Shutting down ethercard.\n", dev->name);\r\noutb(0x00, ioaddr + ULTRA32_CFG6);\r\noutb(0x00, ioaddr + 6);\r\nfree_irq(dev->irq, dev);\r\nNS8390_init(dev, 0);\r\nreturn 0;\r\n}\r\nstatic void ultra32_reset_8390(struct net_device *dev)\r\n{\r\nint ioaddr = dev->base_addr - ULTRA32_NIC_OFFSET;\r\noutb(ULTRA32_RESET, ioaddr);\r\nif (ei_debug > 1) printk("resetting Ultra32, t=%ld...", jiffies);\r\nei_status.txing = 0;\r\noutb(ULTRA32_MEMENB, ioaddr);\r\noutb(0x80, ioaddr + ULTRA32_CFG6);\r\noutb(0x84, ioaddr + 5);\r\noutb(0x01, ioaddr + 6);\r\nif (ei_debug > 1) printk("reset done\n");\r\n}\r\nstatic void ultra32_get_8390_hdr(struct net_device *dev,\r\nstruct e8390_pkt_hdr *hdr,\r\nint ring_page)\r\n{\r\nvoid __iomem *hdr_start = ei_status.mem + ((ring_page & 0x1f) << 8);\r\nunsigned int RamReg = dev->base_addr - ULTRA32_NIC_OFFSET + ULTRA32_CFG3;\r\noutb(ei_status.reg0 | ((ring_page & 0x60) >> 5), RamReg);\r\n#ifdef __BIG_ENDIAN\r\nmemcpy_fromio(hdr, hdr_start, sizeof(struct e8390_pkt_hdr));\r\nhdr->count = le16_to_cpu(hdr->count);\r\n#else\r\n((unsigned int*)hdr)[0] = readl(hdr_start);\r\n#endif\r\n}\r\nstatic void ultra32_block_input(struct net_device *dev,\r\nint count,\r\nstruct sk_buff *skb,\r\nint ring_offset)\r\n{\r\nvoid __iomem *xfer_start = ei_status.mem + (ring_offset & 0x1fff);\r\nunsigned int RamReg = dev->base_addr - ULTRA32_NIC_OFFSET + ULTRA32_CFG3;\r\nif ((ring_offset & ~0x1fff) != ((ring_offset + count - 1) & ~0x1fff)) {\r\nint semi_count = 8192 - (ring_offset & 0x1FFF);\r\nmemcpy_fromio(skb->data, xfer_start, semi_count);\r\ncount -= semi_count;\r\nif (ring_offset < 96*256) {\r\nring_offset += semi_count;\r\noutb(ei_status.reg0 | ((ring_offset & 0x6000) >> 13), RamReg);\r\nmemcpy_fromio(skb->data + semi_count, ei_status.mem, count);\r\n} else {\r\noutb(ei_status.reg0, RamReg);\r\nmemcpy_fromio(skb->data + semi_count, ei_status.mem + TX_PAGES * 256, count);\r\n}\r\n} else {\r\nmemcpy_fromio(skb->data, xfer_start, count);\r\n}\r\n}\r\nstatic void ultra32_block_output(struct net_device *dev,\r\nint count,\r\nconst unsigned char *buf,\r\nint start_page)\r\n{\r\nvoid __iomem *xfer_start = ei_status.mem + (start_page<<8);\r\nunsigned int RamReg = dev->base_addr - ULTRA32_NIC_OFFSET + ULTRA32_CFG3;\r\noutb(ei_status.reg0, RamReg);\r\nmemcpy_toio(xfer_start, buf, count);\r\n}\r\nint __init init_module(void)\r\n{\r\nint this_dev, found = 0;\r\nfor (this_dev = 0; this_dev < MAX_ULTRA32_CARDS; this_dev++) {\r\nstruct net_device *dev = ultra32_probe(-1);\r\nif (IS_ERR(dev))\r\nbreak;\r\ndev_ultra[found++] = dev;\r\n}\r\nif (found)\r\nreturn 0;\r\nprintk(KERN_WARNING "smc-ultra32.c: No SMC Ultra32 found.\n");\r\nreturn -ENXIO;\r\n}\r\nvoid __exit cleanup_module(void)\r\n{\r\nint this_dev;\r\nfor (this_dev = 0; this_dev < MAX_ULTRA32_CARDS; this_dev++) {\r\nstruct net_device *dev = dev_ultra[this_dev];\r\nif (dev) {\r\nunregister_netdev(dev);\r\ncleanup_card(dev);\r\nfree_netdev(dev);\r\n}\r\n}\r\n}

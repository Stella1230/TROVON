int ess_raf_received_pack(struct s_smc *smc, SMbuf *mb, struct smt_header *sm,\r\nint fs)\r\n{\r\nvoid *p ;\r\nstruct smt_p_0016 *cmd ;\r\nSMbuf *db ;\r\nu_long msg_res_type ;\r\nu_long payload, overhead ;\r\nint local ;\r\nint i ;\r\nlocal = ((fs & L_INDICATOR) != 0) ;\r\nif (!(p = (void *) sm_to_para(smc,sm,SMT_P0015))) {\r\nDB_ESS("ESS: RAF frame error, parameter type not found\n",0,0) ;\r\nreturn fs;\r\n}\r\nmsg_res_type = ((struct smt_p_0015 *)p)->res_type ;\r\nif (!(cmd = (struct smt_p_0016 *) sm_to_para(smc,sm,SMT_P0016))) {\r\nDB_ESS("ESS: RAF frame error, parameter command not found\n",0,0);\r\nreturn fs;\r\n}\r\nDB_ESSN(2,"fc %x ft %x\n",sm->smt_class,sm->smt_type) ;\r\nDB_ESSN(2,"ver %x tran %lx\n",sm->smt_version,sm->smt_tid) ;\r\nDB_ESSN(2,"stn_id %s\n",addr_to_string(&sm->smt_source),0) ;\r\nDB_ESSN(2,"infolen %x res %x\n",sm->smt_len, msg_res_type) ;\r\nDB_ESSN(2,"sbacmd %x\n",cmd->sba_cmd,0) ;\r\nswitch (cmd->sba_cmd) {\r\ncase REQUEST_ALLOCATION :\r\nif (sm->smt_type == SMT_REQUEST) {\r\nif (!local || smc->mib.fddiESSPayload)\r\nreturn fs;\r\np = (void *) sm_to_para(smc,sm,SMT_P0019) ;\r\nfor (i = 0; i < 5; i++) {\r\nif (((struct smt_p_0019 *)p)->alloc_addr.a[i]) {\r\nreturn fs;\r\n}\r\n}\r\nsmc->ess.alloc_trans_id = sm->smt_tid ;\r\nDB_ESS("ESS: save Alloc Req Trans ID %lx\n",sm->smt_tid,0);\r\np = (void *) sm_to_para(smc,sm,SMT_P320F) ;\r\n((struct smt_p_320f *)p)->mib_payload =\r\nsmc->mib.a[PATH0].fddiPATHSbaPayload ;\r\np = (void *) sm_to_para(smc,sm,SMT_P3210) ;\r\n((struct smt_p_3210 *)p)->mib_overhead =\r\nsmc->mib.a[PATH0].fddiPATHSbaOverhead ;\r\nsm->smt_dest = smt_sba_da ;\r\nif (smc->ess.local_sba_active)\r\nreturn fs | I_INDICATOR;\r\nif (!(db = smt_get_mbuf(smc)))\r\nreturn fs;\r\ndb->sm_len = mb->sm_len ;\r\ndb->sm_off = mb->sm_off ;\r\nmemcpy(((char *)(db->sm_data+db->sm_off)),(char *)sm,\r\n(int)db->sm_len) ;\r\ndump_smt(smc,\r\n(struct smt_header *)(db->sm_data+db->sm_off),\r\n"RAF") ;\r\nsmt_send_frame(smc,db,FC_SMT_INFO,0) ;\r\nreturn fs;\r\n}\r\nif (smt_check_para(smc,sm,plist_raf_alc_res)) {\r\nDB_ESS("ESS: RAF with para problem, ignoring\n",0,0) ;\r\nreturn fs;\r\n}\r\nif ((((struct smt_p_320b *)sm_to_para(smc,sm,SMT_P320B))->path_index\r\n!= PRIMARY_RING) ||\r\n(msg_res_type != SYNC_BW) ||\r\n(((struct smt_p_reason *)sm_to_para(smc,sm,SMT_P0012))->rdf_reason\r\n!= SMT_RDF_SUCCESS) ||\r\n(sm->smt_tid != smc->ess.alloc_trans_id)) {\r\nDB_ESS("ESS: Allocation Response not accepted\n",0,0) ;\r\nreturn fs;\r\n}\r\np = (void *) sm_to_para(smc,sm,SMT_P320F) ;\r\nif (!p) {\r\nprintk(KERN_ERR "ESS: sm_to_para failed");\r\nreturn fs;\r\n}\r\npayload = ((struct smt_p_320f *)p)->mib_payload ;\r\np = (void *) sm_to_para(smc,sm,SMT_P3210) ;\r\nif (!p) {\r\nprintk(KERN_ERR "ESS: sm_to_para failed");\r\nreturn fs;\r\n}\r\noverhead = ((struct smt_p_3210 *)p)->mib_overhead ;\r\nDB_ESSN(2,"payload= %lx overhead= %lx\n",payload,overhead) ;\r\n(void)process_bw_alloc(smc,(long)payload,(long)overhead) ;\r\nreturn fs;\r\ncase CHANGE_ALLOCATION :\r\nif (sm->smt_type != SMT_REQUEST) {\r\nDB_ESS("ESS: Do not process Change Responses\n",0,0) ;\r\nreturn fs;\r\n}\r\nif (smt_check_para(smc,sm,plist_raf_chg_req)) {\r\nDB_ESS("ESS: RAF with para problem, ignoring\n",0,0) ;\r\nreturn fs;\r\n}\r\nif ((((struct smt_p_320b *)sm_to_para(smc,sm,SMT_P320B))->path_index\r\n!= PRIMARY_RING) || (msg_res_type != SYNC_BW)) {\r\nDB_ESS("ESS: RAF frame with para problem, ignoring\n",0,0) ;\r\nreturn fs;\r\n}\r\np = (void *) sm_to_para(smc,sm,SMT_P320F) ;\r\npayload = ((struct smt_p_320f *)p)->mib_payload ;\r\np = (void *) sm_to_para(smc,sm,SMT_P3210) ;\r\noverhead = ((struct smt_p_3210 *)p)->mib_overhead ;\r\nDB_ESSN(2,"ESS: Change Request from %s\n",\r\naddr_to_string(&sm->smt_source),0) ;\r\nDB_ESSN(2,"payload= %lx overhead= %lx\n",payload,overhead) ;\r\nif(!process_bw_alloc(smc,(long)payload,(long)overhead))\r\nreturn fs;\r\ness_send_response(smc,sm,CHANGE_ALLOCATION) ;\r\nreturn fs;\r\ncase REPORT_ALLOCATION :\r\nif (sm->smt_type != SMT_REQUEST) {\r\nDB_ESS("ESS: Do not process a Report Reply\n",0,0) ;\r\nreturn fs;\r\n}\r\nDB_ESSN(2,"ESS: Report Request from %s\n",\r\naddr_to_string(&(sm->smt_source)),0) ;\r\nif (msg_res_type != SYNC_BW) {\r\nDB_ESS("ESS: ignoring RAF with para problem\n",0,0) ;\r\nreturn fs;\r\n}\r\ness_send_response(smc,sm,REPORT_ALLOCATION) ;\r\nreturn fs;\r\ndefault:\r\nDB_ESS("ESS: ignoring RAF with bad sba_cmd\n",0,0) ;\r\nbreak ;\r\n}\r\nreturn fs;\r\n}\r\nstatic int process_bw_alloc(struct s_smc *smc, long int payload, long int overhead)\r\n{\r\nif (payload > MAX_PAYLOAD || overhead > 5000) {\r\nDB_ESS("ESS: payload / overhead not accepted\n",0,0) ;\r\nreturn FALSE;\r\n}\r\nif (smc->mib.fddiESSPayload &&\r\n((u_long)payload != smc->mib.fddiESSPayload ||\r\n(u_long)overhead != smc->mib.fddiESSOverhead)) {\r\nsmc->ess.raf_act_timer_poll = TRUE ;\r\nsmc->ess.timer_count = 0 ;\r\n}\r\nif (payload) {\r\nDB_ESSN(2,"ESS: turn SMT_ST_SYNC_SERVICE bit on\n",0,0) ;\r\nsmc->ess.sync_bw_available = TRUE ;\r\nsmc->ess.sync_bw = overhead -\r\n(long)smc->mib.m[MAC0].fddiMACT_Neg *\r\npayload / 1562 ;\r\n}\r\nelse {\r\nDB_ESSN(2,"ESS: turn SMT_ST_SYNC_SERVICE bit off\n",0,0) ;\r\nsmc->ess.sync_bw_available = FALSE ;\r\nsmc->ess.sync_bw = 0 ;\r\noverhead = 0 ;\r\n}\r\nsmc->mib.a[PATH0].fddiPATHSbaPayload = payload ;\r\nsmc->mib.a[PATH0].fddiPATHSbaOverhead = overhead ;\r\nDB_ESSN(2,"tsync = %lx\n",smc->ess.sync_bw,0) ;\r\ness_config_fifo(smc) ;\r\nset_formac_tsync(smc,smc->ess.sync_bw) ;\r\nreturn TRUE;\r\n}\r\nstatic void ess_send_response(struct s_smc *smc, struct smt_header *sm,\r\nint sba_cmd)\r\n{\r\nstruct smt_sba_chg *chg ;\r\nSMbuf *mb ;\r\nvoid *p ;\r\nif (sba_cmd == CHANGE_ALLOCATION) {\r\nif (!(mb=smt_build_frame(smc,SMT_RAF,SMT_REPLY,\r\nsizeof(struct smt_sba_chg))))\r\nreturn ;\r\n}\r\nelse {\r\nif (!(mb=smt_build_frame(smc,SMT_RAF,SMT_REPLY,\r\nsizeof(struct smt_sba_rep_res))))\r\nreturn ;\r\n}\r\nchg = smtod(mb,struct smt_sba_chg *) ;\r\nchg->smt.smt_tid = sm->smt_tid ;\r\nchg->smt.smt_dest = sm->smt_source ;\r\nchg->s_type.para.p_type = SMT_P0015 ;\r\nchg->s_type.para.p_len = sizeof(struct smt_p_0015) - PARA_LEN ;\r\nchg->s_type.res_type = SYNC_BW ;\r\nchg->cmd.para.p_type = SMT_P0016 ;\r\nchg->cmd.para.p_len = sizeof(struct smt_p_0016) - PARA_LEN ;\r\nchg->cmd.sba_cmd = sba_cmd ;\r\nchg->path.para.p_type = SMT_P320B ;\r\nchg->path.para.p_len = sizeof(struct smt_p_320b) - PARA_LEN ;\r\nchg->path.mib_index = SBAPATHINDEX ;\r\nchg->path.path_pad = 0;\r\nchg->path.path_index = PRIMARY_RING ;\r\nchg->payload.para.p_type = SMT_P320F ;\r\nchg->payload.para.p_len = sizeof(struct smt_p_320f) - PARA_LEN ;\r\nchg->payload.mib_index = SBAPATHINDEX ;\r\nchg->payload.mib_payload = smc->mib.a[PATH0].fddiPATHSbaPayload ;\r\nchg->overhead.para.p_type = SMT_P3210 ;\r\nchg->overhead.para.p_len = sizeof(struct smt_p_3210) - PARA_LEN ;\r\nchg->overhead.mib_index = SBAPATHINDEX ;\r\nchg->overhead.mib_overhead = smc->mib.a[PATH0].fddiPATHSbaOverhead ;\r\nif (sba_cmd == CHANGE_ALLOCATION) {\r\nchg->cat.para.p_type = SMT_P001A ;\r\nchg->cat.para.p_len = sizeof(struct smt_p_001a) - PARA_LEN ;\r\np = (void *) sm_to_para(smc,sm,SMT_P001A) ;\r\nchg->cat.category = ((struct smt_p_001a *)p)->category ;\r\n}\r\ndump_smt(smc,(struct smt_header *)chg,"RAF") ;\r\ness_send_frame(smc,mb) ;\r\n}\r\nvoid ess_timer_poll(struct s_smc *smc)\r\n{\r\nif (!smc->ess.raf_act_timer_poll)\r\nreturn ;\r\nDB_ESSN(2,"ESS: timer_poll\n",0,0) ;\r\nsmc->ess.timer_count++ ;\r\nif (smc->ess.timer_count == 10) {\r\nsmc->ess.timer_count = 0 ;\r\ness_send_alc_req(smc) ;\r\n}\r\n}\r\nstatic void ess_send_alc_req(struct s_smc *smc)\r\n{\r\nstruct smt_sba_alc_req *req ;\r\nSMbuf *mb ;\r\nif (!smc->mib.fddiESSPayload) {\r\nsmc->mib.fddiESSOverhead = 0 ;\r\n}\r\nelse {\r\nif (!smc->mib.fddiESSOverhead)\r\nsmc->mib.fddiESSOverhead = DEFAULT_OV ;\r\n}\r\nif (smc->mib.fddiESSOverhead ==\r\nsmc->mib.a[PATH0].fddiPATHSbaOverhead &&\r\nsmc->mib.fddiESSPayload ==\r\nsmc->mib.a[PATH0].fddiPATHSbaPayload){\r\nsmc->ess.raf_act_timer_poll = FALSE ;\r\nsmc->ess.timer_count = 7 ;\r\nreturn ;\r\n}\r\nif (!(mb=smt_build_frame(smc,SMT_RAF,SMT_REQUEST,\r\nsizeof(struct smt_sba_alc_req))))\r\nreturn ;\r\nreq = smtod(mb,struct smt_sba_alc_req *) ;\r\nreq->smt.smt_tid = smc->ess.alloc_trans_id = smt_get_tid(smc) ;\r\nreq->smt.smt_dest = smt_sba_da ;\r\nreq->s_type.para.p_type = SMT_P0015 ;\r\nreq->s_type.para.p_len = sizeof(struct smt_p_0015) - PARA_LEN ;\r\nreq->s_type.res_type = SYNC_BW ;\r\nreq->cmd.para.p_type = SMT_P0016 ;\r\nreq->cmd.para.p_len = sizeof(struct smt_p_0016) - PARA_LEN ;\r\nreq->cmd.sba_cmd = REQUEST_ALLOCATION ;\r\nreq->path.para.p_type = SMT_P320B ;\r\nreq->path.para.p_len = sizeof(struct smt_p_320b) - PARA_LEN ;\r\nreq->path.mib_index = SBAPATHINDEX ;\r\nreq->path.path_pad = 0;\r\nreq->path.path_index = PRIMARY_RING ;\r\nreq->pl_req.para.p_type = SMT_P0017 ;\r\nreq->pl_req.para.p_len = sizeof(struct smt_p_0017) - PARA_LEN ;\r\nreq->pl_req.sba_pl_req = smc->mib.fddiESSPayload -\r\nsmc->mib.a[PATH0].fddiPATHSbaPayload ;\r\nreq->ov_req.para.p_type = SMT_P0018 ;\r\nreq->ov_req.para.p_len = sizeof(struct smt_p_0018) - PARA_LEN ;\r\nreq->ov_req.sba_ov_req = smc->mib.fddiESSOverhead -\r\nsmc->mib.a[PATH0].fddiPATHSbaOverhead ;\r\nreq->payload.para.p_type = SMT_P320F ;\r\nreq->payload.para.p_len = sizeof(struct smt_p_320f) - PARA_LEN ;\r\nreq->payload.mib_index = SBAPATHINDEX ;\r\nreq->payload.mib_payload = smc->mib.a[PATH0].fddiPATHSbaPayload ;\r\nreq->overhead.para.p_type = SMT_P3210 ;\r\nreq->overhead.para.p_len = sizeof(struct smt_p_3210) - PARA_LEN ;\r\nreq->overhead.mib_index = SBAPATHINDEX ;\r\nreq->overhead.mib_overhead = smc->mib.a[PATH0].fddiPATHSbaOverhead ;\r\nreq->a_addr.para.p_type = SMT_P0019 ;\r\nreq->a_addr.para.p_len = sizeof(struct smt_p_0019) - PARA_LEN ;\r\nreq->a_addr.sba_pad = 0;\r\nreq->a_addr.alloc_addr = null_addr ;\r\nreq->cat.para.p_type = SMT_P001A ;\r\nreq->cat.para.p_len = sizeof(struct smt_p_001a) - PARA_LEN ;\r\nreq->cat.category = smc->mib.fddiESSCategory ;\r\nreq->tneg.para.p_type = SMT_P001B ;\r\nreq->tneg.para.p_len = sizeof(struct smt_p_001b) - PARA_LEN ;\r\nreq->tneg.max_t_neg = smc->mib.fddiESSMaxTNeg ;\r\nreq->segm.para.p_type = SMT_P001C ;\r\nreq->segm.para.p_len = sizeof(struct smt_p_001c) - PARA_LEN ;\r\nreq->segm.min_seg_siz = smc->mib.fddiESSMinSegmentSize ;\r\ndump_smt(smc,(struct smt_header *)req,"RAF") ;\r\ness_send_frame(smc,mb) ;\r\n}\r\nstatic void ess_send_frame(struct s_smc *smc, SMbuf *mb)\r\n{\r\nif (smc->ess.local_sba_active) {\r\nDB_ESS("ESS:Send to the local SBA\n",0,0) ;\r\nif (!smc->ess.sba_reply_pend)\r\nsmc->ess.sba_reply_pend = mb ;\r\nelse {\r\nDB_ESS("Frame is lost - another frame was pending\n",0,0);\r\nsmt_free_mbuf(smc,mb) ;\r\n}\r\n}\r\nelse {\r\nDB_ESS("ESS:Send to the network\n",0,0) ;\r\nsmt_send_frame(smc,mb,FC_SMT_INFO,0) ;\r\n}\r\n}\r\nvoid ess_para_change(struct s_smc *smc)\r\n{\r\n(void)process_bw_alloc(smc,(long)smc->mib.a[PATH0].fddiPATHSbaPayload,\r\n(long)smc->mib.a[PATH0].fddiPATHSbaOverhead) ;\r\n}\r\nstatic void ess_config_fifo(struct s_smc *smc)\r\n{\r\nif (smc->mib.a[PATH0].fddiPATHSbaPayload) {\r\nif (smc->hw.fp.fifo.fifo_config_mode & SYNC_TRAFFIC_ON &&\r\n(smc->hw.fp.fifo.fifo_config_mode&SEND_ASYNC_AS_SYNC) ==\r\nsmc->mib.fddiESSSynchTxMode) {\r\nreturn ;\r\n}\r\n}\r\nelse {\r\nif (!(smc->hw.fp.fifo.fifo_config_mode & SYNC_TRAFFIC_ON)) {\r\nreturn ;\r\n}\r\n}\r\nformac_reinit_tx(smc) ;\r\n}

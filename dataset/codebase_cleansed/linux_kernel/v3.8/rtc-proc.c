static bool is_rtc_hctosys(struct rtc_device *rtc)\r\n{\r\nint size;\r\nchar name[NAME_SIZE];\r\nsize = scnprintf(name, NAME_SIZE, "rtc%d", rtc->id);\r\nif (size > NAME_SIZE)\r\nreturn false;\r\nreturn !strncmp(name, CONFIG_RTC_HCTOSYS_DEVICE, NAME_SIZE);\r\n}\r\nstatic bool is_rtc_hctosys(struct rtc_device *rtc)\r\n{\r\nreturn (rtc->id == 0);\r\n}\r\nstatic int rtc_proc_show(struct seq_file *seq, void *offset)\r\n{\r\nint err;\r\nstruct rtc_device *rtc = seq->private;\r\nconst struct rtc_class_ops *ops = rtc->ops;\r\nstruct rtc_wkalrm alrm;\r\nstruct rtc_time tm;\r\nerr = rtc_read_time(rtc, &tm);\r\nif (err == 0) {\r\nseq_printf(seq,\r\n"rtc_time\t: %02d:%02d:%02d\n"\r\n"rtc_date\t: %04d-%02d-%02d\n",\r\ntm.tm_hour, tm.tm_min, tm.tm_sec,\r\ntm.tm_year + 1900, tm.tm_mon + 1, tm.tm_mday);\r\n}\r\nerr = rtc_read_alarm(rtc, &alrm);\r\nif (err == 0) {\r\nseq_printf(seq, "alrm_time\t: ");\r\nif ((unsigned int)alrm.time.tm_hour <= 24)\r\nseq_printf(seq, "%02d:", alrm.time.tm_hour);\r\nelse\r\nseq_printf(seq, "**:");\r\nif ((unsigned int)alrm.time.tm_min <= 59)\r\nseq_printf(seq, "%02d:", alrm.time.tm_min);\r\nelse\r\nseq_printf(seq, "**:");\r\nif ((unsigned int)alrm.time.tm_sec <= 59)\r\nseq_printf(seq, "%02d\n", alrm.time.tm_sec);\r\nelse\r\nseq_printf(seq, "**\n");\r\nseq_printf(seq, "alrm_date\t: ");\r\nif ((unsigned int)alrm.time.tm_year <= 200)\r\nseq_printf(seq, "%04d-", alrm.time.tm_year + 1900);\r\nelse\r\nseq_printf(seq, "****-");\r\nif ((unsigned int)alrm.time.tm_mon <= 11)\r\nseq_printf(seq, "%02d-", alrm.time.tm_mon + 1);\r\nelse\r\nseq_printf(seq, "**-");\r\nif (alrm.time.tm_mday && (unsigned int)alrm.time.tm_mday <= 31)\r\nseq_printf(seq, "%02d\n", alrm.time.tm_mday);\r\nelse\r\nseq_printf(seq, "**\n");\r\nseq_printf(seq, "alarm_IRQ\t: %s\n",\r\nalrm.enabled ? "yes" : "no");\r\nseq_printf(seq, "alrm_pending\t: %s\n",\r\nalrm.pending ? "yes" : "no");\r\nseq_printf(seq, "update IRQ enabled\t: %s\n",\r\n(rtc->uie_rtctimer.enabled) ? "yes" : "no");\r\nseq_printf(seq, "periodic IRQ enabled\t: %s\n",\r\n(rtc->pie_enabled) ? "yes" : "no");\r\nseq_printf(seq, "periodic IRQ frequency\t: %d\n",\r\nrtc->irq_freq);\r\nseq_printf(seq, "max user IRQ frequency\t: %d\n",\r\nrtc->max_user_freq);\r\n}\r\nseq_printf(seq, "24hr\t\t: yes\n");\r\nif (ops->proc)\r\nops->proc(rtc->dev.parent, seq);\r\nreturn 0;\r\n}\r\nstatic int rtc_proc_open(struct inode *inode, struct file *file)\r\n{\r\nint ret;\r\nstruct rtc_device *rtc = PDE(inode)->data;\r\nif (!try_module_get(THIS_MODULE))\r\nreturn -ENODEV;\r\nret = single_open(file, rtc_proc_show, rtc);\r\nif (ret)\r\nmodule_put(THIS_MODULE);\r\nreturn ret;\r\n}\r\nstatic int rtc_proc_release(struct inode *inode, struct file *file)\r\n{\r\nint res = single_release(inode, file);\r\nmodule_put(THIS_MODULE);\r\nreturn res;\r\n}\r\nvoid rtc_proc_add_device(struct rtc_device *rtc)\r\n{\r\nif (is_rtc_hctosys(rtc))\r\nproc_create_data("driver/rtc", 0, NULL, &rtc_proc_fops, rtc);\r\n}\r\nvoid rtc_proc_del_device(struct rtc_device *rtc)\r\n{\r\nif (is_rtc_hctosys(rtc))\r\nremove_proc_entry("driver/rtc", NULL);\r\n}

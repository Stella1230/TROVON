void falcon_setup_xaui(struct efx_nic *efx)\r\n{\r\nefx_oword_t sdctl, txdrv;\r\nif (efx->phy_type == PHY_TYPE_NONE)\r\nreturn;\r\nefx_reado(efx, &sdctl, FR_AB_XX_SD_CTL);\r\nEFX_SET_OWORD_FIELD(sdctl, FRF_AB_XX_HIDRVD, FFE_AB_XX_SD_CTL_DRV_DEF);\r\nEFX_SET_OWORD_FIELD(sdctl, FRF_AB_XX_LODRVD, FFE_AB_XX_SD_CTL_DRV_DEF);\r\nEFX_SET_OWORD_FIELD(sdctl, FRF_AB_XX_HIDRVC, FFE_AB_XX_SD_CTL_DRV_DEF);\r\nEFX_SET_OWORD_FIELD(sdctl, FRF_AB_XX_LODRVC, FFE_AB_XX_SD_CTL_DRV_DEF);\r\nEFX_SET_OWORD_FIELD(sdctl, FRF_AB_XX_HIDRVB, FFE_AB_XX_SD_CTL_DRV_DEF);\r\nEFX_SET_OWORD_FIELD(sdctl, FRF_AB_XX_LODRVB, FFE_AB_XX_SD_CTL_DRV_DEF);\r\nEFX_SET_OWORD_FIELD(sdctl, FRF_AB_XX_HIDRVA, FFE_AB_XX_SD_CTL_DRV_DEF);\r\nEFX_SET_OWORD_FIELD(sdctl, FRF_AB_XX_LODRVA, FFE_AB_XX_SD_CTL_DRV_DEF);\r\nefx_writeo(efx, &sdctl, FR_AB_XX_SD_CTL);\r\nEFX_POPULATE_OWORD_8(txdrv,\r\nFRF_AB_XX_DEQD, FFE_AB_XX_TXDRV_DEQ_DEF,\r\nFRF_AB_XX_DEQC, FFE_AB_XX_TXDRV_DEQ_DEF,\r\nFRF_AB_XX_DEQB, FFE_AB_XX_TXDRV_DEQ_DEF,\r\nFRF_AB_XX_DEQA, FFE_AB_XX_TXDRV_DEQ_DEF,\r\nFRF_AB_XX_DTXD, FFE_AB_XX_TXDRV_DTX_DEF,\r\nFRF_AB_XX_DTXC, FFE_AB_XX_TXDRV_DTX_DEF,\r\nFRF_AB_XX_DTXB, FFE_AB_XX_TXDRV_DTX_DEF,\r\nFRF_AB_XX_DTXA, FFE_AB_XX_TXDRV_DTX_DEF);\r\nefx_writeo(efx, &txdrv, FR_AB_XX_TXDRV_CTL);\r\n}\r\nint falcon_reset_xaui(struct efx_nic *efx)\r\n{\r\nstruct falcon_nic_data *nic_data = efx->nic_data;\r\nefx_oword_t reg;\r\nint count;\r\nWARN_ON(nic_data->stats_disable_count == 0);\r\nEFX_POPULATE_OWORD_1(reg, FRF_AB_XX_RST_XX_EN, 1);\r\nefx_writeo(efx, &reg, FR_AB_XX_PWR_RST);\r\nfor (count = 0; count < 1000; count++) {\r\nefx_reado(efx, &reg, FR_AB_XX_PWR_RST);\r\nif (EFX_OWORD_FIELD(reg, FRF_AB_XX_RST_XX_EN) == 0 &&\r\nEFX_OWORD_FIELD(reg, FRF_AB_XX_SD_RST_ACT) == 0) {\r\nfalcon_setup_xaui(efx);\r\nreturn 0;\r\n}\r\nudelay(10);\r\n}\r\nnetif_err(efx, hw, efx->net_dev,\r\n"timed out waiting for XAUI/XGXS reset\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic void falcon_ack_status_intr(struct efx_nic *efx)\r\n{\r\nstruct falcon_nic_data *nic_data = efx->nic_data;\r\nefx_oword_t reg;\r\nif ((efx_nic_rev(efx) != EFX_REV_FALCON_B0) || LOOPBACK_INTERNAL(efx))\r\nreturn;\r\nif (!EFX_WORKAROUND_5147(efx) || !efx->link_state.up)\r\nreturn;\r\nif (nic_data->xmac_poll_required)\r\nreturn;\r\nefx_reado(efx, &reg, FR_AB_XM_MGT_INT_MSK);\r\n}\r\nstatic bool falcon_xgxs_link_ok(struct efx_nic *efx)\r\n{\r\nefx_oword_t reg;\r\nbool align_done, link_ok = false;\r\nint sync_status;\r\nefx_reado(efx, &reg, FR_AB_XX_CORE_STAT);\r\nalign_done = EFX_OWORD_FIELD(reg, FRF_AB_XX_ALIGN_DONE);\r\nsync_status = EFX_OWORD_FIELD(reg, FRF_AB_XX_SYNC_STAT);\r\nif (align_done && (sync_status == FFE_AB_XX_STAT_ALL_LANES))\r\nlink_ok = true;\r\nEFX_SET_OWORD_FIELD(reg, FRF_AB_XX_COMMA_DET, FFE_AB_XX_STAT_ALL_LANES);\r\nEFX_SET_OWORD_FIELD(reg, FRF_AB_XX_CHAR_ERR, FFE_AB_XX_STAT_ALL_LANES);\r\nEFX_SET_OWORD_FIELD(reg, FRF_AB_XX_DISPERR, FFE_AB_XX_STAT_ALL_LANES);\r\nefx_writeo(efx, &reg, FR_AB_XX_CORE_STAT);\r\nreturn link_ok;\r\n}\r\nstatic bool falcon_xmac_link_ok(struct efx_nic *efx)\r\n{\r\nreturn (efx->loopback_mode == LOOPBACK_XGMII ||\r\nfalcon_xgxs_link_ok(efx)) &&\r\n(!(efx->mdio.mmds & (1 << MDIO_MMD_PHYXS)) ||\r\nLOOPBACK_INTERNAL(efx) ||\r\nefx_mdio_phyxgxs_lane_sync(efx));\r\n}\r\nstatic void falcon_reconfigure_xmac_core(struct efx_nic *efx)\r\n{\r\nunsigned int max_frame_len;\r\nefx_oword_t reg;\r\nbool rx_fc = !!(efx->link_state.fc & EFX_FC_RX);\r\nbool tx_fc = !!(efx->link_state.fc & EFX_FC_TX);\r\nEFX_POPULATE_OWORD_3(reg,\r\nFRF_AB_XM_RX_JUMBO_MODE, 1,\r\nFRF_AB_XM_TX_STAT_EN, 1,\r\nFRF_AB_XM_RX_STAT_EN, 1);\r\nefx_writeo(efx, &reg, FR_AB_XM_GLB_CFG);\r\nEFX_POPULATE_OWORD_6(reg,\r\nFRF_AB_XM_TXEN, 1,\r\nFRF_AB_XM_TX_PRMBL, 1,\r\nFRF_AB_XM_AUTO_PAD, 1,\r\nFRF_AB_XM_TXCRC, 1,\r\nFRF_AB_XM_FCNTL, tx_fc,\r\nFRF_AB_XM_IPG, 0x3);\r\nefx_writeo(efx, &reg, FR_AB_XM_TX_CFG);\r\nEFX_POPULATE_OWORD_5(reg,\r\nFRF_AB_XM_RXEN, 1,\r\nFRF_AB_XM_AUTO_DEPAD, 0,\r\nFRF_AB_XM_ACPT_ALL_MCAST, 1,\r\nFRF_AB_XM_ACPT_ALL_UCAST, efx->promiscuous,\r\nFRF_AB_XM_PASS_CRC_ERR, 1);\r\nefx_writeo(efx, &reg, FR_AB_XM_RX_CFG);\r\nmax_frame_len = EFX_MAX_FRAME_LEN(efx->net_dev->mtu);\r\nEFX_POPULATE_OWORD_1(reg, FRF_AB_XM_MAX_RX_FRM_SIZE, max_frame_len);\r\nefx_writeo(efx, &reg, FR_AB_XM_RX_PARAM);\r\nEFX_POPULATE_OWORD_2(reg,\r\nFRF_AB_XM_MAX_TX_FRM_SIZE, max_frame_len,\r\nFRF_AB_XM_TX_JUMBO_MODE, 1);\r\nefx_writeo(efx, &reg, FR_AB_XM_TX_PARAM);\r\nEFX_POPULATE_OWORD_2(reg,\r\nFRF_AB_XM_PAUSE_TIME, 0xfffe,\r\nFRF_AB_XM_DIS_FCNTL, !rx_fc);\r\nefx_writeo(efx, &reg, FR_AB_XM_FC);\r\nmemcpy(&reg, &efx->net_dev->dev_addr[0], 4);\r\nefx_writeo(efx, &reg, FR_AB_XM_ADR_LO);\r\nmemcpy(&reg, &efx->net_dev->dev_addr[4], 2);\r\nefx_writeo(efx, &reg, FR_AB_XM_ADR_HI);\r\n}\r\nstatic void falcon_reconfigure_xgxs_core(struct efx_nic *efx)\r\n{\r\nefx_oword_t reg;\r\nbool xgxs_loopback = (efx->loopback_mode == LOOPBACK_XGXS);\r\nbool xaui_loopback = (efx->loopback_mode == LOOPBACK_XAUI);\r\nbool xgmii_loopback = (efx->loopback_mode == LOOPBACK_XGMII);\r\nif (EFX_WORKAROUND_5147(efx)) {\r\nbool old_xgmii_loopback, old_xgxs_loopback, old_xaui_loopback;\r\nbool reset_xgxs;\r\nefx_reado(efx, &reg, FR_AB_XX_CORE_STAT);\r\nold_xgxs_loopback = EFX_OWORD_FIELD(reg, FRF_AB_XX_XGXS_LB_EN);\r\nold_xgmii_loopback =\r\nEFX_OWORD_FIELD(reg, FRF_AB_XX_XGMII_LB_EN);\r\nefx_reado(efx, &reg, FR_AB_XX_SD_CTL);\r\nold_xaui_loopback = EFX_OWORD_FIELD(reg, FRF_AB_XX_LPBKA);\r\nreset_xgxs = ((xgxs_loopback != old_xgxs_loopback) ||\r\n(xaui_loopback != old_xaui_loopback) ||\r\n(xgmii_loopback != old_xgmii_loopback));\r\nif (reset_xgxs)\r\nfalcon_reset_xaui(efx);\r\n}\r\nefx_reado(efx, &reg, FR_AB_XX_CORE_STAT);\r\nEFX_SET_OWORD_FIELD(reg, FRF_AB_XX_FORCE_SIG,\r\n(xgxs_loopback || xaui_loopback) ?\r\nFFE_AB_XX_FORCE_SIG_ALL_LANES : 0);\r\nEFX_SET_OWORD_FIELD(reg, FRF_AB_XX_XGXS_LB_EN, xgxs_loopback);\r\nEFX_SET_OWORD_FIELD(reg, FRF_AB_XX_XGMII_LB_EN, xgmii_loopback);\r\nefx_writeo(efx, &reg, FR_AB_XX_CORE_STAT);\r\nefx_reado(efx, &reg, FR_AB_XX_SD_CTL);\r\nEFX_SET_OWORD_FIELD(reg, FRF_AB_XX_LPBKD, xaui_loopback);\r\nEFX_SET_OWORD_FIELD(reg, FRF_AB_XX_LPBKC, xaui_loopback);\r\nEFX_SET_OWORD_FIELD(reg, FRF_AB_XX_LPBKB, xaui_loopback);\r\nEFX_SET_OWORD_FIELD(reg, FRF_AB_XX_LPBKA, xaui_loopback);\r\nefx_writeo(efx, &reg, FR_AB_XX_SD_CTL);\r\n}\r\nstatic bool falcon_xmac_link_ok_retry(struct efx_nic *efx, int tries)\r\n{\r\nbool mac_up = falcon_xmac_link_ok(efx);\r\nif (LOOPBACK_MASK(efx) & LOOPBACKS_EXTERNAL(efx) & LOOPBACKS_WS ||\r\nefx_phy_mode_disabled(efx->phy_mode))\r\nreturn mac_up;\r\nfalcon_stop_nic_stats(efx);\r\nwhile (!mac_up && tries) {\r\nnetif_dbg(efx, hw, efx->net_dev, "bashing xaui\n");\r\nfalcon_reset_xaui(efx);\r\nudelay(200);\r\nmac_up = falcon_xmac_link_ok(efx);\r\n--tries;\r\n}\r\nfalcon_start_nic_stats(efx);\r\nreturn mac_up;\r\n}\r\nbool falcon_xmac_check_fault(struct efx_nic *efx)\r\n{\r\nreturn !falcon_xmac_link_ok_retry(efx, 5);\r\n}\r\nint falcon_reconfigure_xmac(struct efx_nic *efx)\r\n{\r\nstruct falcon_nic_data *nic_data = efx->nic_data;\r\nfalcon_reconfigure_xgxs_core(efx);\r\nfalcon_reconfigure_xmac_core(efx);\r\nfalcon_reconfigure_mac_wrapper(efx);\r\nnic_data->xmac_poll_required = !falcon_xmac_link_ok_retry(efx, 5);\r\nfalcon_ack_status_intr(efx);\r\nreturn 0;\r\n}\r\nvoid falcon_update_stats_xmac(struct efx_nic *efx)\r\n{\r\nstruct efx_mac_stats *mac_stats = &efx->mac_stats;\r\nFALCON_STAT(efx, XgRxOctets, rx_bytes);\r\nFALCON_STAT(efx, XgRxOctetsOK, rx_good_bytes);\r\nFALCON_STAT(efx, XgRxPkts, rx_packets);\r\nFALCON_STAT(efx, XgRxPktsOK, rx_good);\r\nFALCON_STAT(efx, XgRxBroadcastPkts, rx_broadcast);\r\nFALCON_STAT(efx, XgRxMulticastPkts, rx_multicast);\r\nFALCON_STAT(efx, XgRxUnicastPkts, rx_unicast);\r\nFALCON_STAT(efx, XgRxUndersizePkts, rx_lt64);\r\nFALCON_STAT(efx, XgRxOversizePkts, rx_gtjumbo);\r\nFALCON_STAT(efx, XgRxJabberPkts, rx_bad_gtjumbo);\r\nFALCON_STAT(efx, XgRxUndersizeFCSerrorPkts, rx_bad_lt64);\r\nFALCON_STAT(efx, XgRxDropEvents, rx_overflow);\r\nFALCON_STAT(efx, XgRxFCSerrorPkts, rx_bad);\r\nFALCON_STAT(efx, XgRxAlignError, rx_align_error);\r\nFALCON_STAT(efx, XgRxSymbolError, rx_symbol_error);\r\nFALCON_STAT(efx, XgRxInternalMACError, rx_internal_error);\r\nFALCON_STAT(efx, XgRxControlPkts, rx_control);\r\nFALCON_STAT(efx, XgRxPausePkts, rx_pause);\r\nFALCON_STAT(efx, XgRxPkts64Octets, rx_64);\r\nFALCON_STAT(efx, XgRxPkts65to127Octets, rx_65_to_127);\r\nFALCON_STAT(efx, XgRxPkts128to255Octets, rx_128_to_255);\r\nFALCON_STAT(efx, XgRxPkts256to511Octets, rx_256_to_511);\r\nFALCON_STAT(efx, XgRxPkts512to1023Octets, rx_512_to_1023);\r\nFALCON_STAT(efx, XgRxPkts1024to15xxOctets, rx_1024_to_15xx);\r\nFALCON_STAT(efx, XgRxPkts15xxtoMaxOctets, rx_15xx_to_jumbo);\r\nFALCON_STAT(efx, XgRxLengthError, rx_length_error);\r\nFALCON_STAT(efx, XgTxPkts, tx_packets);\r\nFALCON_STAT(efx, XgTxOctets, tx_bytes);\r\nFALCON_STAT(efx, XgTxMulticastPkts, tx_multicast);\r\nFALCON_STAT(efx, XgTxBroadcastPkts, tx_broadcast);\r\nFALCON_STAT(efx, XgTxUnicastPkts, tx_unicast);\r\nFALCON_STAT(efx, XgTxControlPkts, tx_control);\r\nFALCON_STAT(efx, XgTxPausePkts, tx_pause);\r\nFALCON_STAT(efx, XgTxPkts64Octets, tx_64);\r\nFALCON_STAT(efx, XgTxPkts65to127Octets, tx_65_to_127);\r\nFALCON_STAT(efx, XgTxPkts128to255Octets, tx_128_to_255);\r\nFALCON_STAT(efx, XgTxPkts256to511Octets, tx_256_to_511);\r\nFALCON_STAT(efx, XgTxPkts512to1023Octets, tx_512_to_1023);\r\nFALCON_STAT(efx, XgTxPkts1024to15xxOctets, tx_1024_to_15xx);\r\nFALCON_STAT(efx, XgTxPkts1519toMaxOctets, tx_15xx_to_jumbo);\r\nFALCON_STAT(efx, XgTxUndersizePkts, tx_lt64);\r\nFALCON_STAT(efx, XgTxOversizePkts, tx_gtjumbo);\r\nFALCON_STAT(efx, XgTxNonTcpUdpPkt, tx_non_tcpudp);\r\nFALCON_STAT(efx, XgTxMacSrcErrPkt, tx_mac_src_error);\r\nFALCON_STAT(efx, XgTxIpSrcErrPkt, tx_ip_src_error);\r\nefx_update_diff_stat(&mac_stats->tx_good_bytes,\r\nmac_stats->tx_bytes - mac_stats->tx_bad_bytes -\r\nmac_stats->tx_control * 64);\r\nefx_update_diff_stat(&mac_stats->rx_bad_bytes,\r\nmac_stats->rx_bytes - mac_stats->rx_good_bytes -\r\nmac_stats->rx_control * 64);\r\n}\r\nvoid falcon_poll_xmac(struct efx_nic *efx)\r\n{\r\nstruct falcon_nic_data *nic_data = efx->nic_data;\r\nif (!EFX_WORKAROUND_5147(efx) || !efx->link_state.up ||\r\n!nic_data->xmac_poll_required)\r\nreturn;\r\nnic_data->xmac_poll_required = !falcon_xmac_link_ok_retry(efx, 1);\r\nfalcon_ack_status_intr(efx);\r\n}

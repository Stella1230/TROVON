static int picolcd_get_contrast(struct lcd_device *ldev)\r\n{\r\nstruct picolcd_data *data = lcd_get_data(ldev);\r\nreturn data->lcd_contrast;\r\n}\r\nstatic int picolcd_set_contrast(struct lcd_device *ldev, int contrast)\r\n{\r\nstruct picolcd_data *data = lcd_get_data(ldev);\r\nstruct hid_report *report = picolcd_out_report(REPORT_CONTRAST, data->hdev);\r\nunsigned long flags;\r\nif (!report || report->maxfield != 1 || report->field[0]->report_count != 1)\r\nreturn -ENODEV;\r\ndata->lcd_contrast = contrast & 0x0ff;\r\nspin_lock_irqsave(&data->lock, flags);\r\nhid_set_field(report->field[0], 0, data->lcd_contrast);\r\nif (!(data->status & PICOLCD_FAILED))\r\nusbhid_submit_report(data->hdev, report, USB_DIR_OUT);\r\nspin_unlock_irqrestore(&data->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int picolcd_check_lcd_fb(struct lcd_device *ldev, struct fb_info *fb)\r\n{\r\nreturn fb && fb == picolcd_fbinfo((struct picolcd_data *)lcd_get_data(ldev));\r\n}\r\nint picolcd_init_lcd(struct picolcd_data *data, struct hid_report *report)\r\n{\r\nstruct device *dev = &data->hdev->dev;\r\nstruct lcd_device *ldev;\r\nif (!report)\r\nreturn -ENODEV;\r\nif (report->maxfield != 1 || report->field[0]->report_count != 1 ||\r\nreport->field[0]->report_size != 8) {\r\ndev_err(dev, "unsupported CONTRAST report");\r\nreturn -EINVAL;\r\n}\r\nldev = lcd_device_register(dev_name(dev), dev, data, &picolcd_lcdops);\r\nif (IS_ERR(ldev)) {\r\ndev_err(dev, "failed to register LCD\n");\r\nreturn PTR_ERR(ldev);\r\n}\r\nldev->props.max_contrast = 0x0ff;\r\ndata->lcd_contrast = 0xe5;\r\ndata->lcd = ldev;\r\npicolcd_set_contrast(ldev, 0xe5);\r\nreturn 0;\r\n}\r\nvoid picolcd_exit_lcd(struct picolcd_data *data)\r\n{\r\nstruct lcd_device *ldev = data->lcd;\r\ndata->lcd = NULL;\r\nif (ldev)\r\nlcd_device_unregister(ldev);\r\n}\r\nint picolcd_resume_lcd(struct picolcd_data *data)\r\n{\r\nif (!data->lcd)\r\nreturn 0;\r\nreturn picolcd_set_contrast(data->lcd, data->lcd_contrast);\r\n}

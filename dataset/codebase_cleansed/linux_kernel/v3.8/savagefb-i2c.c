static void savage4_gpio_setscl(void *data, int val)\r\n{\r\nstruct savagefb_i2c_chan *chan = data;\r\nunsigned int r;\r\nr = readl(chan->ioaddr + chan->reg);\r\nif(val)\r\nr |= SAVAGE4_I2C_SCL_OUT;\r\nelse\r\nr &= ~SAVAGE4_I2C_SCL_OUT;\r\nwritel(r, chan->ioaddr + chan->reg);\r\nreadl(chan->ioaddr + chan->reg);\r\n}\r\nstatic void savage4_gpio_setsda(void *data, int val)\r\n{\r\nstruct savagefb_i2c_chan *chan = data;\r\nunsigned int r;\r\nr = readl(chan->ioaddr + chan->reg);\r\nif(val)\r\nr |= SAVAGE4_I2C_SDA_OUT;\r\nelse\r\nr &= ~SAVAGE4_I2C_SDA_OUT;\r\nwritel(r, chan->ioaddr + chan->reg);\r\nreadl(chan->ioaddr + chan->reg);\r\n}\r\nstatic int savage4_gpio_getscl(void *data)\r\n{\r\nstruct savagefb_i2c_chan *chan = data;\r\nreturn (0 != (readl(chan->ioaddr + chan->reg) & SAVAGE4_I2C_SCL_IN));\r\n}\r\nstatic int savage4_gpio_getsda(void *data)\r\n{\r\nstruct savagefb_i2c_chan *chan = data;\r\nreturn (0 != (readl(chan->ioaddr + chan->reg) & SAVAGE4_I2C_SDA_IN));\r\n}\r\nstatic void prosavage_gpio_setscl(void* data, int val)\r\n{\r\nstruct savagefb_i2c_chan *chan = data;\r\nu32 r;\r\nr = VGArCR(chan->reg, chan->par);\r\nr |= PROSAVAGE_I2C_ENAB;\r\nif (val) {\r\nr |= PROSAVAGE_I2C_SCL_OUT;\r\n} else {\r\nr &= ~PROSAVAGE_I2C_SCL_OUT;\r\n}\r\nVGAwCR(chan->reg, r, chan->par);\r\n}\r\nstatic void prosavage_gpio_setsda(void* data, int val)\r\n{\r\nstruct savagefb_i2c_chan *chan = data;\r\nunsigned int r;\r\nr = VGArCR(chan->reg, chan->par);\r\nr |= PROSAVAGE_I2C_ENAB;\r\nif (val) {\r\nr |= PROSAVAGE_I2C_SDA_OUT;\r\n} else {\r\nr &= ~PROSAVAGE_I2C_SDA_OUT;\r\n}\r\nVGAwCR(chan->reg, r, chan->par);\r\n}\r\nstatic int prosavage_gpio_getscl(void* data)\r\n{\r\nstruct savagefb_i2c_chan *chan = data;\r\nreturn (VGArCR(chan->reg, chan->par) & PROSAVAGE_I2C_SCL_IN) ? 1 : 0;\r\n}\r\nstatic int prosavage_gpio_getsda(void* data)\r\n{\r\nstruct savagefb_i2c_chan *chan = data;\r\nreturn (VGArCR(chan->reg, chan->par) & PROSAVAGE_I2C_SDA_IN) ? 1 : 0;\r\n}\r\nstatic int savage_setup_i2c_bus(struct savagefb_i2c_chan *chan,\r\nconst char *name)\r\n{\r\nint rc = 0;\r\nif (chan->par) {\r\nstrcpy(chan->adapter.name, name);\r\nchan->adapter.owner = THIS_MODULE;\r\nchan->adapter.algo_data = &chan->algo;\r\nchan->adapter.dev.parent = &chan->par->pcidev->dev;\r\nchan->algo.udelay = 10;\r\nchan->algo.timeout = 20;\r\nchan->algo.data = chan;\r\ni2c_set_adapdata(&chan->adapter, chan);\r\nchan->algo.setsda(chan, 1);\r\nchan->algo.setscl(chan, 1);\r\nudelay(20);\r\nrc = i2c_bit_add_bus(&chan->adapter);\r\nif (rc == 0)\r\ndev_dbg(&chan->par->pcidev->dev,\r\n"I2C bus %s registered.\n", name);\r\nelse\r\ndev_warn(&chan->par->pcidev->dev,\r\n"Failed to register I2C bus %s.\n", name);\r\n}\r\nreturn rc;\r\n}\r\nvoid savagefb_create_i2c_busses(struct fb_info *info)\r\n{\r\nstruct savagefb_par *par = info->par;\r\npar->chan.par = par;\r\nswitch (par->chip) {\r\ncase S3_PROSAVAGE:\r\ncase S3_PROSAVAGEDDR:\r\ncase S3_TWISTER:\r\npar->chan.reg = CR_SERIAL2;\r\npar->chan.ioaddr = par->mmio.vbase;\r\npar->chan.algo.setsda = prosavage_gpio_setsda;\r\npar->chan.algo.setscl = prosavage_gpio_setscl;\r\npar->chan.algo.getsda = prosavage_gpio_getsda;\r\npar->chan.algo.getscl = prosavage_gpio_getscl;\r\nbreak;\r\ncase S3_SAVAGE4:\r\npar->chan.reg = CR_SERIAL1;\r\nif (par->pcidev->revision > 1 && !(VGArCR(0xa6, par) & 0x40))\r\npar->chan.reg = CR_SERIAL2;\r\npar->chan.ioaddr = par->mmio.vbase;\r\npar->chan.algo.setsda = prosavage_gpio_setsda;\r\npar->chan.algo.setscl = prosavage_gpio_setscl;\r\npar->chan.algo.getsda = prosavage_gpio_getsda;\r\npar->chan.algo.getscl = prosavage_gpio_getscl;\r\nbreak;\r\ncase S3_SAVAGE2000:\r\npar->chan.reg = MM_SERIAL1;\r\npar->chan.ioaddr = par->mmio.vbase;\r\npar->chan.algo.setsda = savage4_gpio_setsda;\r\npar->chan.algo.setscl = savage4_gpio_setscl;\r\npar->chan.algo.getsda = savage4_gpio_getsda;\r\npar->chan.algo.getscl = savage4_gpio_getscl;\r\nbreak;\r\ndefault:\r\npar->chan.par = NULL;\r\n}\r\nsavage_setup_i2c_bus(&par->chan, "SAVAGE DDC2");\r\n}\r\nvoid savagefb_delete_i2c_busses(struct fb_info *info)\r\n{\r\nstruct savagefb_par *par = info->par;\r\nif (par->chan.par)\r\ni2c_del_adapter(&par->chan.adapter);\r\npar->chan.par = NULL;\r\n}\r\nint savagefb_probe_i2c_connector(struct fb_info *info, u8 **out_edid)\r\n{\r\nstruct savagefb_par *par = info->par;\r\nu8 *edid;\r\nif (par->chan.par)\r\nedid = fb_ddc_read(&par->chan.adapter);\r\nelse\r\nedid = NULL;\r\nif (!edid) {\r\nconst u8 *e = fb_firmware_edid(info->device);\r\nif (e)\r\nedid = kmemdup(e, EDID_LENGTH, GFP_KERNEL);\r\n}\r\n*out_edid = edid;\r\nreturn (edid) ? 0 : 1;\r\n}

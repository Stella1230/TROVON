static void r3081_wait(void)\r\n{\r\nunsigned long cfg = read_c0_conf();\r\nwrite_c0_conf(cfg | R30XX_CONF_HALT);\r\n}\r\nstatic void r39xx_wait(void)\r\n{\r\nlocal_irq_disable();\r\nif (!need_resched())\r\nwrite_c0_conf(read_c0_conf() | TX39_CONF_HALT);\r\nlocal_irq_enable();\r\n}\r\nvoid r4k_wait_irqoff(void)\r\n{\r\nlocal_irq_disable();\r\nif (!need_resched())\r\n__asm__(" .set push \n"\r\n" .set mips3 \n"\r\n" wait \n"\r\n" .set pop \n");\r\nlocal_irq_enable();\r\n__asm__(" .globl __pastwait \n"\r\n"__pastwait: \n");\r\n}\r\nstatic void rm7k_wait_irqoff(void)\r\n{\r\nlocal_irq_disable();\r\nif (!need_resched())\r\n__asm__(\r\n" .set push \n"\r\n" .set mips3 \n"\r\n" .set noat \n"\r\n" mfc0 $1, $12 \n"\r\n" sync \n"\r\n" mtc0 $1, $12 # stalls until W stage \n"\r\n" wait \n"\r\n" mtc0 $1, $12 # stalls until W stage \n"\r\n" .set pop \n");\r\nlocal_irq_enable();\r\n}\r\nstatic void au1k_wait(void)\r\n{\r\n__asm__(" .set mips3 \n"\r\n" cache 0x14, 0(%0) \n"\r\n" cache 0x14, 32(%0) \n"\r\n" sync \n"\r\n" nop \n"\r\n" wait \n"\r\n" nop \n"\r\n" nop \n"\r\n" nop \n"\r\n" nop \n"\r\n" .set mips0 \n"\r\n: : "r" (au1k_wait));\r\n}\r\nstatic int __init wait_disable(char *s)\r\n{\r\nnowait = 1;\r\nreturn 1;\r\n}\r\nstatic int __init fpu_disable(char *s)\r\n{\r\ncpu_data[0].options &= ~MIPS_CPU_FPU;\r\nmips_fpu_disabled = 1;\r\nreturn 1;\r\n}\r\nstatic int __init dsp_disable(char *s)\r\n{\r\ncpu_data[0].ases &= ~(MIPS_ASE_DSP | MIPS_ASE_DSP2P);\r\nmips_dsp_disabled = 1;\r\nreturn 1;\r\n}\r\nvoid __init check_wait(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nif (nowait) {\r\nprintk("Wait instruction disabled.\n");\r\nreturn;\r\n}\r\nswitch (c->cputype) {\r\ncase CPU_R3081:\r\ncase CPU_R3081E:\r\ncpu_wait = r3081_wait;\r\nbreak;\r\ncase CPU_TX3927:\r\ncpu_wait = r39xx_wait;\r\nbreak;\r\ncase CPU_R4200:\r\ncase CPU_R4600:\r\ncase CPU_R4640:\r\ncase CPU_R4650:\r\ncase CPU_R4700:\r\ncase CPU_R5000:\r\ncase CPU_R5500:\r\ncase CPU_NEVADA:\r\ncase CPU_4KC:\r\ncase CPU_4KEC:\r\ncase CPU_4KSC:\r\ncase CPU_5KC:\r\ncase CPU_25KF:\r\ncase CPU_PR4450:\r\ncase CPU_BMIPS3300:\r\ncase CPU_BMIPS4350:\r\ncase CPU_BMIPS4380:\r\ncase CPU_BMIPS5000:\r\ncase CPU_CAVIUM_OCTEON:\r\ncase CPU_CAVIUM_OCTEON_PLUS:\r\ncase CPU_CAVIUM_OCTEON2:\r\ncase CPU_JZRISC:\r\ncase CPU_LOONGSON1:\r\ncase CPU_XLR:\r\ncase CPU_XLP:\r\ncpu_wait = r4k_wait;\r\nbreak;\r\ncase CPU_RM7000:\r\ncpu_wait = rm7k_wait_irqoff;\r\nbreak;\r\ncase CPU_M14KC:\r\ncase CPU_24K:\r\ncase CPU_34K:\r\ncase CPU_1004K:\r\ncpu_wait = r4k_wait;\r\nif (read_c0_config7() & MIPS_CONF7_WII)\r\ncpu_wait = r4k_wait_irqoff;\r\nbreak;\r\ncase CPU_74K:\r\ncpu_wait = r4k_wait;\r\nif ((c->processor_id & 0xff) >= PRID_REV_ENCODE_332(2, 1, 0))\r\ncpu_wait = r4k_wait_irqoff;\r\nbreak;\r\ncase CPU_TX49XX:\r\ncpu_wait = r4k_wait_irqoff;\r\nbreak;\r\ncase CPU_ALCHEMY:\r\ncpu_wait = au1k_wait;\r\nbreak;\r\ncase CPU_20KC:\r\nif ((c->processor_id & 0xff) <= 0x64)\r\nbreak;\r\nbreak;\r\ncase CPU_RM9000:\r\nif ((c->processor_id & 0x00ff) >= 0x40)\r\ncpu_wait = r4k_wait;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic inline void check_errata(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nswitch (c->cputype) {\r\ncase CPU_34K:\r\nif ((c->processor_id & PRID_REV_MASK) <= PRID_REV_34K_V1_0_2)\r\nwrite_c0_config7(read_c0_config7() | MIPS_CONF7_RPS);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nvoid __init check_bugs32(void)\r\n{\r\ncheck_errata();\r\n}\r\nstatic inline int cpu_has_confreg(void)\r\n{\r\n#ifdef CONFIG_CPU_R3000\r\nextern unsigned long r3k_cache_size(unsigned long);\r\nunsigned long size1, size2;\r\nunsigned long cfg = read_c0_conf();\r\nsize1 = r3k_cache_size(ST0_ISC);\r\nwrite_c0_conf(cfg ^ R30XX_CONF_AC);\r\nsize2 = r3k_cache_size(ST0_ISC);\r\nwrite_c0_conf(cfg);\r\nreturn size1 != size2;\r\n#else\r\nreturn 0;\r\n#endif\r\n}\r\nstatic inline void set_elf_platform(int cpu, const char *plat)\r\n{\r\nif (cpu == 0)\r\n__elf_platform = plat;\r\n}\r\nstatic inline unsigned long cpu_get_fpu_id(void)\r\n{\r\nunsigned long tmp, fpu_id;\r\ntmp = read_c0_status();\r\n__enable_fpu();\r\nfpu_id = read_32bit_cp1_register(CP1_REVISION);\r\nwrite_c0_status(tmp);\r\nreturn fpu_id;\r\n}\r\nstatic inline int __cpu_has_fpu(void)\r\n{\r\nreturn ((cpu_get_fpu_id() & 0xff00) != FPIR_IMP_NONE);\r\n}\r\nstatic inline void cpu_probe_vmbits(struct cpuinfo_mips *c)\r\n{\r\n#ifdef __NEED_VMBITS_PROBE\r\nwrite_c0_entryhi(0x3fffffffffffe000ULL);\r\nback_to_back_c0_hazard();\r\nc->vmbits = fls64(read_c0_entryhi() & 0x3fffffffffffe000ULL);\r\n#endif\r\n}\r\nstatic inline unsigned int decode_config0(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config0;\r\nint isa;\r\nconfig0 = read_c0_config();\r\nif (((config0 & MIPS_CONF_MT) >> 7) == 1)\r\nc->options |= MIPS_CPU_TLB;\r\nisa = (config0 & MIPS_CONF_AT) >> 13;\r\nswitch (isa) {\r\ncase 0:\r\nswitch ((config0 & MIPS_CONF_AR) >> 10) {\r\ncase 0:\r\nc->isa_level = MIPS_CPU_ISA_M32R1;\r\nbreak;\r\ncase 1:\r\nc->isa_level = MIPS_CPU_ISA_M32R2;\r\nbreak;\r\ndefault:\r\ngoto unknown;\r\n}\r\nbreak;\r\ncase 2:\r\nswitch ((config0 & MIPS_CONF_AR) >> 10) {\r\ncase 0:\r\nc->isa_level = MIPS_CPU_ISA_M64R1;\r\nbreak;\r\ncase 1:\r\nc->isa_level = MIPS_CPU_ISA_M64R2;\r\nbreak;\r\ndefault:\r\ngoto unknown;\r\n}\r\nbreak;\r\ndefault:\r\ngoto unknown;\r\n}\r\nreturn config0 & MIPS_CONF_M;\r\nunknown:\r\npanic(unknown_isa, config0);\r\n}\r\nstatic inline unsigned int decode_config1(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config1;\r\nconfig1 = read_c0_config1();\r\nif (config1 & MIPS_CONF1_MD)\r\nc->ases |= MIPS_ASE_MDMX;\r\nif (config1 & MIPS_CONF1_WR)\r\nc->options |= MIPS_CPU_WATCH;\r\nif (config1 & MIPS_CONF1_CA)\r\nc->ases |= MIPS_ASE_MIPS16;\r\nif (config1 & MIPS_CONF1_EP)\r\nc->options |= MIPS_CPU_EJTAG;\r\nif (config1 & MIPS_CONF1_FP) {\r\nc->options |= MIPS_CPU_FPU;\r\nc->options |= MIPS_CPU_32FPR;\r\n}\r\nif (cpu_has_tlb)\r\nc->tlbsize = ((config1 & MIPS_CONF1_TLBS) >> 25) + 1;\r\nreturn config1 & MIPS_CONF_M;\r\n}\r\nstatic inline unsigned int decode_config2(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config2;\r\nconfig2 = read_c0_config2();\r\nif (config2 & MIPS_CONF2_SL)\r\nc->scache.flags &= ~MIPS_CACHE_NOT_PRESENT;\r\nreturn config2 & MIPS_CONF_M;\r\n}\r\nstatic inline unsigned int decode_config3(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config3;\r\nconfig3 = read_c0_config3();\r\nif (config3 & MIPS_CONF3_SM) {\r\nc->ases |= MIPS_ASE_SMARTMIPS;\r\nc->options |= MIPS_CPU_RIXI;\r\n}\r\nif (config3 & MIPS_CONF3_RXI)\r\nc->options |= MIPS_CPU_RIXI;\r\nif (config3 & MIPS_CONF3_DSP)\r\nc->ases |= MIPS_ASE_DSP;\r\nif (config3 & MIPS_CONF3_DSP2P)\r\nc->ases |= MIPS_ASE_DSP2P;\r\nif (config3 & MIPS_CONF3_VINT)\r\nc->options |= MIPS_CPU_VINT;\r\nif (config3 & MIPS_CONF3_VEIC)\r\nc->options |= MIPS_CPU_VEIC;\r\nif (config3 & MIPS_CONF3_MT)\r\nc->ases |= MIPS_ASE_MIPSMT;\r\nif (config3 & MIPS_CONF3_ULRI)\r\nc->options |= MIPS_CPU_ULRI;\r\nreturn config3 & MIPS_CONF_M;\r\n}\r\nstatic inline unsigned int decode_config4(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config4;\r\nconfig4 = read_c0_config4();\r\nif ((config4 & MIPS_CONF4_MMUEXTDEF) == MIPS_CONF4_MMUEXTDEF_MMUSIZEEXT\r\n&& cpu_has_tlb)\r\nc->tlbsize += (config4 & MIPS_CONF4_MMUSIZEEXT) * 0x40;\r\nc->kscratch_mask = (config4 >> 16) & 0xff;\r\nreturn config4 & MIPS_CONF_M;\r\n}\r\nstatic void __cpuinit decode_configs(struct cpuinfo_mips *c)\r\n{\r\nint ok;\r\nc->options = MIPS_CPU_4KEX | MIPS_CPU_4K_CACHE | MIPS_CPU_COUNTER |\r\nMIPS_CPU_DIVEC | MIPS_CPU_LLSC | MIPS_CPU_MCHECK;\r\nc->scache.flags = MIPS_CACHE_NOT_PRESENT;\r\nok = decode_config0(c);\r\nBUG_ON(!ok);\r\nif (ok)\r\nok = decode_config1(c);\r\nif (ok)\r\nok = decode_config2(c);\r\nif (ok)\r\nok = decode_config3(c);\r\nif (ok)\r\nok = decode_config4(c);\r\nmips_probe_watch_registers(c);\r\nif (cpu_has_mips_r2)\r\nc->core = read_c0_ebase() & 0x3ff;\r\n}\r\nstatic inline void cpu_probe_legacy(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\nswitch (c->processor_id & 0xff00) {\r\ncase PRID_IMP_R2000:\r\nc->cputype = CPU_R2000;\r\n__cpu_name[cpu] = "R2000";\r\nc->isa_level = MIPS_CPU_ISA_I;\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_3K_CACHE |\r\nMIPS_CPU_NOFPUEX;\r\nif (__cpu_has_fpu())\r\nc->options |= MIPS_CPU_FPU;\r\nc->tlbsize = 64;\r\nbreak;\r\ncase PRID_IMP_R3000:\r\nif ((c->processor_id & 0xff) == PRID_REV_R3000A) {\r\nif (cpu_has_confreg()) {\r\nc->cputype = CPU_R3081E;\r\n__cpu_name[cpu] = "R3081";\r\n} else {\r\nc->cputype = CPU_R3000A;\r\n__cpu_name[cpu] = "R3000A";\r\n}\r\n} else {\r\nc->cputype = CPU_R3000;\r\n__cpu_name[cpu] = "R3000";\r\n}\r\nc->isa_level = MIPS_CPU_ISA_I;\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_3K_CACHE |\r\nMIPS_CPU_NOFPUEX;\r\nif (__cpu_has_fpu())\r\nc->options |= MIPS_CPU_FPU;\r\nc->tlbsize = 64;\r\nbreak;\r\ncase PRID_IMP_R4000:\r\nif (read_c0_config() & CONF_SC) {\r\nif ((c->processor_id & 0xff) >= PRID_REV_R4400) {\r\nc->cputype = CPU_R4400PC;\r\n__cpu_name[cpu] = "R4400PC";\r\n} else {\r\nc->cputype = CPU_R4000PC;\r\n__cpu_name[cpu] = "R4000PC";\r\n}\r\n} else {\r\nif ((c->processor_id & 0xff) >= PRID_REV_R4400) {\r\nc->cputype = CPU_R4400SC;\r\n__cpu_name[cpu] = "R4400SC";\r\n} else {\r\nc->cputype = CPU_R4000SC;\r\n__cpu_name[cpu] = "R4000SC";\r\n}\r\n}\r\nc->isa_level = MIPS_CPU_ISA_III;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_WATCH | MIPS_CPU_VCE |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\ncase PRID_IMP_VR41XX:\r\nswitch (c->processor_id & 0xf0) {\r\ncase PRID_REV_VR4111:\r\nc->cputype = CPU_VR4111;\r\n__cpu_name[cpu] = "NEC VR4111";\r\nbreak;\r\ncase PRID_REV_VR4121:\r\nc->cputype = CPU_VR4121;\r\n__cpu_name[cpu] = "NEC VR4121";\r\nbreak;\r\ncase PRID_REV_VR4122:\r\nif ((c->processor_id & 0xf) < 0x3) {\r\nc->cputype = CPU_VR4122;\r\n__cpu_name[cpu] = "NEC VR4122";\r\n} else {\r\nc->cputype = CPU_VR4181A;\r\n__cpu_name[cpu] = "NEC VR4181A";\r\n}\r\nbreak;\r\ncase PRID_REV_VR4130:\r\nif ((c->processor_id & 0xf) < 0x4) {\r\nc->cputype = CPU_VR4131;\r\n__cpu_name[cpu] = "NEC VR4131";\r\n} else {\r\nc->cputype = CPU_VR4133;\r\n__cpu_name[cpu] = "NEC VR4133";\r\n}\r\nbreak;\r\ndefault:\r\nprintk(KERN_INFO "Unexpected CPU of NEC VR4100 series\n");\r\nc->cputype = CPU_VR41XX;\r\n__cpu_name[cpu] = "NEC Vr41xx";\r\nbreak;\r\n}\r\nc->isa_level = MIPS_CPU_ISA_III;\r\nc->options = R4K_OPTS;\r\nc->tlbsize = 32;\r\nbreak;\r\ncase PRID_IMP_R4300:\r\nc->cputype = CPU_R4300;\r\n__cpu_name[cpu] = "R4300";\r\nc->isa_level = MIPS_CPU_ISA_III;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 32;\r\nbreak;\r\ncase PRID_IMP_R4600:\r\nc->cputype = CPU_R4600;\r\n__cpu_name[cpu] = "R4600";\r\nc->isa_level = MIPS_CPU_ISA_III;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\n#if 0\r\ncase PRID_IMP_R4650:\r\nc->cputype = CPU_R4650;\r\n__cpu_name[cpu] = "R4650";\r\nc->isa_level = MIPS_CPU_ISA_III;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\n#endif\r\ncase PRID_IMP_TX39:\r\nc->isa_level = MIPS_CPU_ISA_I;\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_TX39_CACHE;\r\nif ((c->processor_id & 0xf0) == (PRID_REV_TX3927 & 0xf0)) {\r\nc->cputype = CPU_TX3927;\r\n__cpu_name[cpu] = "TX3927";\r\nc->tlbsize = 64;\r\n} else {\r\nswitch (c->processor_id & 0xff) {\r\ncase PRID_REV_TX3912:\r\nc->cputype = CPU_TX3912;\r\n__cpu_name[cpu] = "TX3912";\r\nc->tlbsize = 32;\r\nbreak;\r\ncase PRID_REV_TX3922:\r\nc->cputype = CPU_TX3922;\r\n__cpu_name[cpu] = "TX3922";\r\nc->tlbsize = 64;\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ncase PRID_IMP_R4700:\r\nc->cputype = CPU_R4700;\r\n__cpu_name[cpu] = "R4700";\r\nc->isa_level = MIPS_CPU_ISA_III;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\ncase PRID_IMP_TX49:\r\nc->cputype = CPU_TX49XX;\r\n__cpu_name[cpu] = "R49XX";\r\nc->isa_level = MIPS_CPU_ISA_III;\r\nc->options = R4K_OPTS | MIPS_CPU_LLSC;\r\nif (!(c->processor_id & 0x08))\r\nc->options |= MIPS_CPU_FPU | MIPS_CPU_32FPR;\r\nc->tlbsize = 48;\r\nbreak;\r\ncase PRID_IMP_R5000:\r\nc->cputype = CPU_R5000;\r\n__cpu_name[cpu] = "R5000";\r\nc->isa_level = MIPS_CPU_ISA_IV;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\ncase PRID_IMP_R5432:\r\nc->cputype = CPU_R5432;\r\n__cpu_name[cpu] = "R5432";\r\nc->isa_level = MIPS_CPU_ISA_IV;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_WATCH | MIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\ncase PRID_IMP_R5500:\r\nc->cputype = CPU_R5500;\r\n__cpu_name[cpu] = "R5500";\r\nc->isa_level = MIPS_CPU_ISA_IV;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_WATCH | MIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\ncase PRID_IMP_NEVADA:\r\nc->cputype = CPU_NEVADA;\r\n__cpu_name[cpu] = "Nevada";\r\nc->isa_level = MIPS_CPU_ISA_IV;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_DIVEC | MIPS_CPU_LLSC;\r\nc->tlbsize = 48;\r\nbreak;\r\ncase PRID_IMP_R6000:\r\nc->cputype = CPU_R6000;\r\n__cpu_name[cpu] = "R6000";\r\nc->isa_level = MIPS_CPU_ISA_II;\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_FPU |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 32;\r\nbreak;\r\ncase PRID_IMP_R6000A:\r\nc->cputype = CPU_R6000A;\r\n__cpu_name[cpu] = "R6000A";\r\nc->isa_level = MIPS_CPU_ISA_II;\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_FPU |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 32;\r\nbreak;\r\ncase PRID_IMP_RM7000:\r\nc->cputype = CPU_RM7000;\r\n__cpu_name[cpu] = "RM7000";\r\nc->isa_level = MIPS_CPU_ISA_IV;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = (read_c0_info() & (1 << 29)) ? 64 : 48;\r\nbreak;\r\ncase PRID_IMP_RM9000:\r\nc->cputype = CPU_RM9000;\r\n__cpu_name[cpu] = "RM9000";\r\nc->isa_level = MIPS_CPU_ISA_IV;\r\nc->options = R4K_OPTS | MIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = (read_c0_info() & (1 << 29)) ? 64 : 48;\r\nbreak;\r\ncase PRID_IMP_R8000:\r\nc->cputype = CPU_R8000;\r\n__cpu_name[cpu] = "RM8000";\r\nc->isa_level = MIPS_CPU_ISA_IV;\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_4KEX |\r\nMIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 384;\r\nbreak;\r\ncase PRID_IMP_R10000:\r\nc->cputype = CPU_R10000;\r\n__cpu_name[cpu] = "R10000";\r\nc->isa_level = MIPS_CPU_ISA_IV;\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_4K_CACHE | MIPS_CPU_4KEX |\r\nMIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_COUNTER | MIPS_CPU_WATCH |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 64;\r\nbreak;\r\ncase PRID_IMP_R12000:\r\nc->cputype = CPU_R12000;\r\n__cpu_name[cpu] = "R12000";\r\nc->isa_level = MIPS_CPU_ISA_IV;\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_4K_CACHE | MIPS_CPU_4KEX |\r\nMIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_COUNTER | MIPS_CPU_WATCH |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 64;\r\nbreak;\r\ncase PRID_IMP_R14000:\r\nc->cputype = CPU_R14000;\r\n__cpu_name[cpu] = "R14000";\r\nc->isa_level = MIPS_CPU_ISA_IV;\r\nc->options = MIPS_CPU_TLB | MIPS_CPU_4K_CACHE | MIPS_CPU_4KEX |\r\nMIPS_CPU_FPU | MIPS_CPU_32FPR |\r\nMIPS_CPU_COUNTER | MIPS_CPU_WATCH |\r\nMIPS_CPU_LLSC;\r\nc->tlbsize = 64;\r\nbreak;\r\ncase PRID_IMP_LOONGSON2:\r\nc->cputype = CPU_LOONGSON2;\r\n__cpu_name[cpu] = "ICT Loongson-2";\r\nswitch (c->processor_id & PRID_REV_MASK) {\r\ncase PRID_REV_LOONGSON2E:\r\nset_elf_platform(cpu, "loongson2e");\r\nbreak;\r\ncase PRID_REV_LOONGSON2F:\r\nset_elf_platform(cpu, "loongson2f");\r\nbreak;\r\n}\r\nc->isa_level = MIPS_CPU_ISA_III;\r\nc->options = R4K_OPTS |\r\nMIPS_CPU_FPU | MIPS_CPU_LLSC |\r\nMIPS_CPU_32FPR;\r\nc->tlbsize = 64;\r\nbreak;\r\ncase PRID_IMP_LOONGSON1:\r\ndecode_configs(c);\r\nc->cputype = CPU_LOONGSON1;\r\nswitch (c->processor_id & PRID_REV_MASK) {\r\ncase PRID_REV_LOONGSON1B:\r\n__cpu_name[cpu] = "Loongson 1B";\r\nbreak;\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_mips(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nswitch (c->processor_id & 0xff00) {\r\ncase PRID_IMP_4KC:\r\nc->cputype = CPU_4KC;\r\n__cpu_name[cpu] = "MIPS 4Kc";\r\nbreak;\r\ncase PRID_IMP_4KEC:\r\ncase PRID_IMP_4KECR2:\r\nc->cputype = CPU_4KEC;\r\n__cpu_name[cpu] = "MIPS 4KEc";\r\nbreak;\r\ncase PRID_IMP_4KSC:\r\ncase PRID_IMP_4KSD:\r\nc->cputype = CPU_4KSC;\r\n__cpu_name[cpu] = "MIPS 4KSc";\r\nbreak;\r\ncase PRID_IMP_5KC:\r\nc->cputype = CPU_5KC;\r\n__cpu_name[cpu] = "MIPS 5Kc";\r\nbreak;\r\ncase PRID_IMP_5KE:\r\nc->cputype = CPU_5KE;\r\n__cpu_name[cpu] = "MIPS 5KE";\r\nbreak;\r\ncase PRID_IMP_20KC:\r\nc->cputype = CPU_20KC;\r\n__cpu_name[cpu] = "MIPS 20Kc";\r\nbreak;\r\ncase PRID_IMP_24K:\r\ncase PRID_IMP_24KE:\r\nc->cputype = CPU_24K;\r\n__cpu_name[cpu] = "MIPS 24Kc";\r\nbreak;\r\ncase PRID_IMP_25KF:\r\nc->cputype = CPU_25KF;\r\n__cpu_name[cpu] = "MIPS 25Kc";\r\nbreak;\r\ncase PRID_IMP_34K:\r\nc->cputype = CPU_34K;\r\n__cpu_name[cpu] = "MIPS 34Kc";\r\nbreak;\r\ncase PRID_IMP_74K:\r\nc->cputype = CPU_74K;\r\n__cpu_name[cpu] = "MIPS 74Kc";\r\nbreak;\r\ncase PRID_IMP_M14KC:\r\nc->cputype = CPU_M14KC;\r\n__cpu_name[cpu] = "MIPS M14Kc";\r\nbreak;\r\ncase PRID_IMP_1004K:\r\nc->cputype = CPU_1004K;\r\n__cpu_name[cpu] = "MIPS 1004Kc";\r\nbreak;\r\ncase PRID_IMP_1074K:\r\nc->cputype = CPU_74K;\r\n__cpu_name[cpu] = "MIPS 1074Kc";\r\nbreak;\r\n}\r\nspram_config();\r\n}\r\nstatic inline void cpu_probe_alchemy(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nswitch (c->processor_id & 0xff00) {\r\ncase PRID_IMP_AU1_REV1:\r\ncase PRID_IMP_AU1_REV2:\r\nc->cputype = CPU_ALCHEMY;\r\nswitch ((c->processor_id >> 24) & 0xff) {\r\ncase 0:\r\n__cpu_name[cpu] = "Au1000";\r\nbreak;\r\ncase 1:\r\n__cpu_name[cpu] = "Au1500";\r\nbreak;\r\ncase 2:\r\n__cpu_name[cpu] = "Au1100";\r\nbreak;\r\ncase 3:\r\n__cpu_name[cpu] = "Au1550";\r\nbreak;\r\ncase 4:\r\n__cpu_name[cpu] = "Au1200";\r\nif ((c->processor_id & 0xff) == 2)\r\n__cpu_name[cpu] = "Au1250";\r\nbreak;\r\ncase 5:\r\n__cpu_name[cpu] = "Au1210";\r\nbreak;\r\ndefault:\r\n__cpu_name[cpu] = "Au1xxx";\r\nbreak;\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_sibyte(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nswitch (c->processor_id & 0xff00) {\r\ncase PRID_IMP_SB1:\r\nc->cputype = CPU_SB1;\r\n__cpu_name[cpu] = "SiByte SB1";\r\nif ((c->processor_id & 0xff) < 0x02)\r\nc->options &= ~(MIPS_CPU_FPU | MIPS_CPU_32FPR);\r\nbreak;\r\ncase PRID_IMP_SB1A:\r\nc->cputype = CPU_SB1A;\r\n__cpu_name[cpu] = "SiByte SB1A";\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_sandcraft(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nswitch (c->processor_id & 0xff00) {\r\ncase PRID_IMP_SR71000:\r\nc->cputype = CPU_SR71000;\r\n__cpu_name[cpu] = "Sandcraft SR71000";\r\nc->scache.ways = 8;\r\nc->tlbsize = 64;\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_nxp(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nswitch (c->processor_id & 0xff00) {\r\ncase PRID_IMP_PR4450:\r\nc->cputype = CPU_PR4450;\r\n__cpu_name[cpu] = "Philips PR4450";\r\nc->isa_level = MIPS_CPU_ISA_M32R1;\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_broadcom(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nswitch (c->processor_id & 0xff00) {\r\ncase PRID_IMP_BMIPS32_REV4:\r\ncase PRID_IMP_BMIPS32_REV8:\r\nc->cputype = CPU_BMIPS32;\r\n__cpu_name[cpu] = "Broadcom BMIPS32";\r\nset_elf_platform(cpu, "bmips32");\r\nbreak;\r\ncase PRID_IMP_BMIPS3300:\r\ncase PRID_IMP_BMIPS3300_ALT:\r\ncase PRID_IMP_BMIPS3300_BUG:\r\nc->cputype = CPU_BMIPS3300;\r\n__cpu_name[cpu] = "Broadcom BMIPS3300";\r\nset_elf_platform(cpu, "bmips3300");\r\nbreak;\r\ncase PRID_IMP_BMIPS43XX: {\r\nint rev = c->processor_id & 0xff;\r\nif (rev >= PRID_REV_BMIPS4380_LO &&\r\nrev <= PRID_REV_BMIPS4380_HI) {\r\nc->cputype = CPU_BMIPS4380;\r\n__cpu_name[cpu] = "Broadcom BMIPS4380";\r\nset_elf_platform(cpu, "bmips4380");\r\n} else {\r\nc->cputype = CPU_BMIPS4350;\r\n__cpu_name[cpu] = "Broadcom BMIPS4350";\r\nset_elf_platform(cpu, "bmips4350");\r\n}\r\nbreak;\r\n}\r\ncase PRID_IMP_BMIPS5000:\r\nc->cputype = CPU_BMIPS5000;\r\n__cpu_name[cpu] = "Broadcom BMIPS5000";\r\nset_elf_platform(cpu, "bmips5000");\r\nc->options |= MIPS_CPU_ULRI;\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_cavium(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nswitch (c->processor_id & 0xff00) {\r\ncase PRID_IMP_CAVIUM_CN38XX:\r\ncase PRID_IMP_CAVIUM_CN31XX:\r\ncase PRID_IMP_CAVIUM_CN30XX:\r\nc->cputype = CPU_CAVIUM_OCTEON;\r\n__cpu_name[cpu] = "Cavium Octeon";\r\ngoto platform;\r\ncase PRID_IMP_CAVIUM_CN58XX:\r\ncase PRID_IMP_CAVIUM_CN56XX:\r\ncase PRID_IMP_CAVIUM_CN50XX:\r\ncase PRID_IMP_CAVIUM_CN52XX:\r\nc->cputype = CPU_CAVIUM_OCTEON_PLUS;\r\n__cpu_name[cpu] = "Cavium Octeon+";\r\nplatform:\r\nset_elf_platform(cpu, "octeon");\r\nbreak;\r\ncase PRID_IMP_CAVIUM_CN61XX:\r\ncase PRID_IMP_CAVIUM_CN63XX:\r\ncase PRID_IMP_CAVIUM_CN66XX:\r\ncase PRID_IMP_CAVIUM_CN68XX:\r\nc->cputype = CPU_CAVIUM_OCTEON2;\r\n__cpu_name[cpu] = "Cavium Octeon II";\r\nset_elf_platform(cpu, "octeon2");\r\nbreak;\r\ndefault:\r\nprintk(KERN_INFO "Unknown Octeon chip!\n");\r\nc->cputype = CPU_UNKNOWN;\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_ingenic(struct cpuinfo_mips *c, unsigned int cpu)\r\n{\r\ndecode_configs(c);\r\nc->options &= ~MIPS_CPU_COUNTER;\r\nswitch (c->processor_id & 0xff00) {\r\ncase PRID_IMP_JZRISC:\r\nc->cputype = CPU_JZRISC;\r\n__cpu_name[cpu] = "Ingenic JZRISC";\r\nbreak;\r\ndefault:\r\npanic("Unknown Ingenic Processor ID!");\r\nbreak;\r\n}\r\n}\r\nstatic inline void cpu_probe_netlogic(struct cpuinfo_mips *c, int cpu)\r\n{\r\ndecode_configs(c);\r\nif ((c->processor_id & 0xff00) == PRID_IMP_NETLOGIC_AU13XX) {\r\nc->cputype = CPU_ALCHEMY;\r\n__cpu_name[cpu] = "Au1300";\r\nreturn;\r\n}\r\nc->options = (MIPS_CPU_TLB |\r\nMIPS_CPU_4KEX |\r\nMIPS_CPU_COUNTER |\r\nMIPS_CPU_DIVEC |\r\nMIPS_CPU_WATCH |\r\nMIPS_CPU_EJTAG |\r\nMIPS_CPU_LLSC);\r\nswitch (c->processor_id & 0xff00) {\r\ncase PRID_IMP_NETLOGIC_XLP8XX:\r\ncase PRID_IMP_NETLOGIC_XLP3XX:\r\nc->cputype = CPU_XLP;\r\n__cpu_name[cpu] = "Netlogic XLP";\r\nbreak;\r\ncase PRID_IMP_NETLOGIC_XLR732:\r\ncase PRID_IMP_NETLOGIC_XLR716:\r\ncase PRID_IMP_NETLOGIC_XLR532:\r\ncase PRID_IMP_NETLOGIC_XLR308:\r\ncase PRID_IMP_NETLOGIC_XLR532C:\r\ncase PRID_IMP_NETLOGIC_XLR516C:\r\ncase PRID_IMP_NETLOGIC_XLR508C:\r\ncase PRID_IMP_NETLOGIC_XLR308C:\r\nc->cputype = CPU_XLR;\r\n__cpu_name[cpu] = "Netlogic XLR";\r\nbreak;\r\ncase PRID_IMP_NETLOGIC_XLS608:\r\ncase PRID_IMP_NETLOGIC_XLS408:\r\ncase PRID_IMP_NETLOGIC_XLS404:\r\ncase PRID_IMP_NETLOGIC_XLS208:\r\ncase PRID_IMP_NETLOGIC_XLS204:\r\ncase PRID_IMP_NETLOGIC_XLS108:\r\ncase PRID_IMP_NETLOGIC_XLS104:\r\ncase PRID_IMP_NETLOGIC_XLS616B:\r\ncase PRID_IMP_NETLOGIC_XLS608B:\r\ncase PRID_IMP_NETLOGIC_XLS416B:\r\ncase PRID_IMP_NETLOGIC_XLS412B:\r\ncase PRID_IMP_NETLOGIC_XLS408B:\r\ncase PRID_IMP_NETLOGIC_XLS404B:\r\nc->cputype = CPU_XLR;\r\n__cpu_name[cpu] = "Netlogic XLS";\r\nbreak;\r\ndefault:\r\npr_info("Unknown Netlogic chip id [%02x]!\n",\r\nc->processor_id);\r\nc->cputype = CPU_XLR;\r\nbreak;\r\n}\r\nif (c->cputype == CPU_XLP) {\r\nc->isa_level = MIPS_CPU_ISA_M64R2;\r\nc->options |= (MIPS_CPU_FPU | MIPS_CPU_ULRI | MIPS_CPU_MCHECK);\r\nc->tlbsize = ((read_c0_config6() >> 16) & 0xffff) + 1;\r\n} else {\r\nc->isa_level = MIPS_CPU_ISA_M64R1;\r\nc->tlbsize = ((read_c0_config1() >> 25) & 0x3f) + 1;\r\n}\r\n}\r\n__cpuinit void cpu_probe(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nunsigned int cpu = smp_processor_id();\r\nc->processor_id = PRID_IMP_UNKNOWN;\r\nc->fpu_id = FPIR_IMP_NONE;\r\nc->cputype = CPU_UNKNOWN;\r\nc->processor_id = read_c0_prid();\r\nswitch (c->processor_id & 0xff0000) {\r\ncase PRID_COMP_LEGACY:\r\ncpu_probe_legacy(c, cpu);\r\nbreak;\r\ncase PRID_COMP_MIPS:\r\ncpu_probe_mips(c, cpu);\r\nbreak;\r\ncase PRID_COMP_ALCHEMY:\r\ncpu_probe_alchemy(c, cpu);\r\nbreak;\r\ncase PRID_COMP_SIBYTE:\r\ncpu_probe_sibyte(c, cpu);\r\nbreak;\r\ncase PRID_COMP_BROADCOM:\r\ncpu_probe_broadcom(c, cpu);\r\nbreak;\r\ncase PRID_COMP_SANDCRAFT:\r\ncpu_probe_sandcraft(c, cpu);\r\nbreak;\r\ncase PRID_COMP_NXP:\r\ncpu_probe_nxp(c, cpu);\r\nbreak;\r\ncase PRID_COMP_CAVIUM:\r\ncpu_probe_cavium(c, cpu);\r\nbreak;\r\ncase PRID_COMP_INGENIC:\r\ncpu_probe_ingenic(c, cpu);\r\nbreak;\r\ncase PRID_COMP_NETLOGIC:\r\ncpu_probe_netlogic(c, cpu);\r\nbreak;\r\n}\r\nBUG_ON(!__cpu_name[cpu]);\r\nBUG_ON(c->cputype == CPU_UNKNOWN);\r\nBUG_ON(current_cpu_type() != c->cputype);\r\nif (mips_fpu_disabled)\r\nc->options &= ~MIPS_CPU_FPU;\r\nif (mips_dsp_disabled)\r\nc->ases &= ~(MIPS_ASE_DSP | MIPS_ASE_DSP2P);\r\nif (c->options & MIPS_CPU_FPU) {\r\nc->fpu_id = cpu_get_fpu_id();\r\nif (c->isa_level == MIPS_CPU_ISA_M32R1 ||\r\nc->isa_level == MIPS_CPU_ISA_M32R2 ||\r\nc->isa_level == MIPS_CPU_ISA_M64R1 ||\r\nc->isa_level == MIPS_CPU_ISA_M64R2) {\r\nif (c->fpu_id & MIPS_FPIR_3D)\r\nc->ases |= MIPS_ASE_MIPS3D;\r\n}\r\n}\r\nif (cpu_has_mips_r2) {\r\nc->srsets = ((read_c0_srsctl() >> 26) & 0x0f) + 1;\r\nc->options |= MIPS_CPU_PCI;\r\n}\r\nelse\r\nc->srsets = 1;\r\ncpu_probe_vmbits(c);\r\n#ifdef CONFIG_64BIT\r\nif (cpu == 0)\r\n__ua_limit = ~((1ull << cpu_vmbits) - 1);\r\n#endif\r\n}\r\n__cpuinit void cpu_report(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nprintk(KERN_INFO "CPU revision is: %08x (%s)\n",\r\nc->processor_id, cpu_name_string());\r\nif (c->options & MIPS_CPU_FPU)\r\nprintk(KERN_INFO "FPU revision is: %08x\n", c->fpu_id);\r\n}

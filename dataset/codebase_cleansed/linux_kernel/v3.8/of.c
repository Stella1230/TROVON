static void *of_try_claim(unsigned long size)\r\n{\r\nunsigned long addr = 0;\r\nif (claim_base == 0)\r\nclaim_base = _ALIGN_UP((unsigned long)_end, ONE_MB);\r\nfor(; claim_base < RAM_END; claim_base += ONE_MB) {\r\n#ifdef DEBUG\r\nprintf(" trying: 0x%08lx\n\r", claim_base);\r\n#endif\r\naddr = (unsigned long)of_claim(claim_base, size, 0);\r\nif ((void *)addr != (void *)-1)\r\nbreak;\r\n}\r\nif (addr == 0)\r\nreturn NULL;\r\nclaim_base = PAGE_ALIGN(claim_base + size);\r\nreturn (void *)addr;\r\n}\r\nstatic void of_image_hdr(const void *hdr)\r\n{\r\nconst Elf64_Ehdr *elf64 = hdr;\r\nif (elf64->e_ident[EI_CLASS] == ELFCLASS64) {\r\nif (claim_base < PROG_START)\r\nclaim_base = PROG_START;\r\n}\r\n}\r\nvoid platform_init(unsigned long a1, unsigned long a2, void *promptr)\r\n{\r\nplatform_ops.image_hdr = of_image_hdr;\r\nplatform_ops.malloc = of_try_claim;\r\nplatform_ops.exit = of_exit;\r\nplatform_ops.vmlinux_alloc = of_vmlinux_alloc;\r\ndt_ops.finddevice = of_finddevice;\r\ndt_ops.getprop = of_getprop;\r\ndt_ops.setprop = of_setprop;\r\nof_console_init();\r\nof_init(promptr);\r\nloader_info.promptr = promptr;\r\nif (a1 && a2 && a2 != 0xdeadbeef) {\r\nloader_info.initrd_addr = a1;\r\nloader_info.initrd_size = a2;\r\n}\r\n}

int bridge_msg_create(struct msg_mgr **msg_man,\r\nstruct dev_object *hdev_obj,\r\nmsg_onexit msg_callback)\r\n{\r\nstruct msg_mgr *msg_mgr_obj;\r\nstruct io_mgr *hio_mgr;\r\nint status = 0;\r\nif (!msg_man || !msg_callback || !hdev_obj)\r\nreturn -EFAULT;\r\ndev_get_io_mgr(hdev_obj, &hio_mgr);\r\nif (!hio_mgr)\r\nreturn -EFAULT;\r\n*msg_man = NULL;\r\nmsg_mgr_obj = kzalloc(sizeof(struct msg_mgr), GFP_KERNEL);\r\nif (!msg_mgr_obj)\r\nreturn -ENOMEM;\r\nmsg_mgr_obj->on_exit = msg_callback;\r\nmsg_mgr_obj->iomgr = hio_mgr;\r\nINIT_LIST_HEAD(&msg_mgr_obj->queue_list);\r\nINIT_LIST_HEAD(&msg_mgr_obj->msg_free_list);\r\nINIT_LIST_HEAD(&msg_mgr_obj->msg_used_list);\r\nspin_lock_init(&msg_mgr_obj->msg_mgr_lock);\r\nmsg_mgr_obj->sync_event =\r\nkzalloc(sizeof(struct sync_object), GFP_KERNEL);\r\nif (!msg_mgr_obj->sync_event) {\r\nkfree(msg_mgr_obj);\r\nreturn -ENOMEM;\r\n}\r\nsync_init_event(msg_mgr_obj->sync_event);\r\n*msg_man = msg_mgr_obj;\r\nreturn status;\r\n}\r\nint bridge_msg_create_queue(struct msg_mgr *hmsg_mgr, struct msg_queue **msgq,\r\nu32 msgq_id, u32 max_msgs, void *arg)\r\n{\r\nu32 i;\r\nu32 num_allocated = 0;\r\nstruct msg_queue *msg_q;\r\nint status = 0;\r\nif (!hmsg_mgr || msgq == NULL)\r\nreturn -EFAULT;\r\n*msgq = NULL;\r\nmsg_q = kzalloc(sizeof(struct msg_queue), GFP_KERNEL);\r\nif (!msg_q)\r\nreturn -ENOMEM;\r\nmsg_q->max_msgs = max_msgs;\r\nmsg_q->msg_mgr = hmsg_mgr;\r\nmsg_q->arg = arg;\r\nmsg_q->msgq_id = msgq_id;\r\nINIT_LIST_HEAD(&msg_q->msg_free_list);\r\nINIT_LIST_HEAD(&msg_q->msg_used_list);\r\nmsg_q->sync_event = kzalloc(sizeof(struct sync_object), GFP_KERNEL);\r\nif (!msg_q->sync_event) {\r\nstatus = -ENOMEM;\r\ngoto out_err;\r\n}\r\nsync_init_event(msg_q->sync_event);\r\nmsg_q->ntfy_obj = kmalloc(sizeof(struct ntfy_object), GFP_KERNEL);\r\nif (!msg_q->ntfy_obj) {\r\nstatus = -ENOMEM;\r\ngoto out_err;\r\n}\r\nntfy_init(msg_q->ntfy_obj);\r\nmsg_q->sync_done = kzalloc(sizeof(struct sync_object), GFP_KERNEL);\r\nif (!msg_q->sync_done) {\r\nstatus = -ENOMEM;\r\ngoto out_err;\r\n}\r\nsync_init_event(msg_q->sync_done);\r\nmsg_q->sync_done_ack = kzalloc(sizeof(struct sync_object), GFP_KERNEL);\r\nif (!msg_q->sync_done_ack) {\r\nstatus = -ENOMEM;\r\ngoto out_err;\r\n}\r\nsync_init_event(msg_q->sync_done_ack);\r\nspin_lock_bh(&hmsg_mgr->msg_mgr_lock);\r\nfor (i = 0; i < max_msgs && !status; i++) {\r\nstatus = add_new_msg(&hmsg_mgr->msg_free_list);\r\nif (!status) {\r\nnum_allocated++;\r\nstatus = add_new_msg(&msg_q->msg_free_list);\r\n}\r\n}\r\nif (status) {\r\nspin_unlock_bh(&hmsg_mgr->msg_mgr_lock);\r\ngoto out_err;\r\n}\r\nlist_add_tail(&msg_q->list_elem, &hmsg_mgr->queue_list);\r\n*msgq = msg_q;\r\nif (!list_empty(&hmsg_mgr->msg_free_list))\r\nsync_set_event(hmsg_mgr->sync_event);\r\nspin_unlock_bh(&hmsg_mgr->msg_mgr_lock);\r\nreturn 0;\r\nout_err:\r\ndelete_msg_queue(msg_q, num_allocated);\r\nreturn status;\r\n}\r\nvoid bridge_msg_delete(struct msg_mgr *hmsg_mgr)\r\n{\r\nif (hmsg_mgr)\r\ndelete_msg_mgr(hmsg_mgr);\r\n}\r\nvoid bridge_msg_delete_queue(struct msg_queue *msg_queue_obj)\r\n{\r\nstruct msg_mgr *hmsg_mgr;\r\nu32 io_msg_pend;\r\nif (!msg_queue_obj || !msg_queue_obj->msg_mgr)\r\nreturn;\r\nhmsg_mgr = msg_queue_obj->msg_mgr;\r\nmsg_queue_obj->done = true;\r\nio_msg_pend = msg_queue_obj->io_msg_pend;\r\nwhile (io_msg_pend) {\r\nsync_set_event(msg_queue_obj->sync_done);\r\nsync_wait_on_event(msg_queue_obj->sync_done_ack, SYNC_INFINITE);\r\nio_msg_pend = msg_queue_obj->io_msg_pend;\r\n}\r\nspin_lock_bh(&hmsg_mgr->msg_mgr_lock);\r\nlist_del(&msg_queue_obj->list_elem);\r\ndelete_msg_queue(msg_queue_obj, msg_queue_obj->max_msgs);\r\nif (list_empty(&hmsg_mgr->msg_free_list))\r\nsync_reset_event(hmsg_mgr->sync_event);\r\nspin_unlock_bh(&hmsg_mgr->msg_mgr_lock);\r\n}\r\nint bridge_msg_get(struct msg_queue *msg_queue_obj,\r\nstruct dsp_msg *pmsg, u32 utimeout)\r\n{\r\nstruct msg_frame *msg_frame_obj;\r\nstruct msg_mgr *hmsg_mgr;\r\nstruct sync_object *syncs[2];\r\nu32 index;\r\nint status = 0;\r\nif (!msg_queue_obj || pmsg == NULL)\r\nreturn -ENOMEM;\r\nhmsg_mgr = msg_queue_obj->msg_mgr;\r\nspin_lock_bh(&hmsg_mgr->msg_mgr_lock);\r\nif (!list_empty(&msg_queue_obj->msg_used_list)) {\r\nmsg_frame_obj = list_first_entry(&msg_queue_obj->msg_used_list,\r\nstruct msg_frame, list_elem);\r\nlist_del(&msg_frame_obj->list_elem);\r\n*pmsg = msg_frame_obj->msg_data.msg;\r\nlist_add_tail(&msg_frame_obj->list_elem,\r\n&msg_queue_obj->msg_free_list);\r\nif (list_empty(&msg_queue_obj->msg_used_list))\r\nsync_reset_event(msg_queue_obj->sync_event);\r\nspin_unlock_bh(&hmsg_mgr->msg_mgr_lock);\r\nreturn 0;\r\n}\r\nif (msg_queue_obj->done) {\r\nspin_unlock_bh(&hmsg_mgr->msg_mgr_lock);\r\nreturn -EPERM;\r\n}\r\nmsg_queue_obj->io_msg_pend++;\r\nspin_unlock_bh(&hmsg_mgr->msg_mgr_lock);\r\nsyncs[0] = msg_queue_obj->sync_event;\r\nsyncs[1] = msg_queue_obj->sync_done;\r\nstatus = sync_wait_on_multiple_events(syncs, 2, utimeout, &index);\r\nspin_lock_bh(&hmsg_mgr->msg_mgr_lock);\r\nif (msg_queue_obj->done) {\r\nmsg_queue_obj->io_msg_pend--;\r\nspin_unlock_bh(&hmsg_mgr->msg_mgr_lock);\r\nsync_set_event(msg_queue_obj->sync_done_ack);\r\nreturn -EPERM;\r\n}\r\nif (!status && !list_empty(&msg_queue_obj->msg_used_list)) {\r\nmsg_frame_obj = list_first_entry(&msg_queue_obj->msg_used_list,\r\nstruct msg_frame, list_elem);\r\nlist_del(&msg_frame_obj->list_elem);\r\n*pmsg = msg_frame_obj->msg_data.msg;\r\nlist_add_tail(&msg_frame_obj->list_elem,\r\n&msg_queue_obj->msg_free_list);\r\n}\r\nmsg_queue_obj->io_msg_pend--;\r\nif (!list_empty(&msg_queue_obj->msg_used_list))\r\nsync_set_event(msg_queue_obj->sync_event);\r\nspin_unlock_bh(&hmsg_mgr->msg_mgr_lock);\r\nreturn status;\r\n}\r\nint bridge_msg_put(struct msg_queue *msg_queue_obj,\r\nconst struct dsp_msg *pmsg, u32 utimeout)\r\n{\r\nstruct msg_frame *msg_frame_obj;\r\nstruct msg_mgr *hmsg_mgr;\r\nstruct sync_object *syncs[2];\r\nu32 index;\r\nint status;\r\nif (!msg_queue_obj || !pmsg || !msg_queue_obj->msg_mgr)\r\nreturn -EFAULT;\r\nhmsg_mgr = msg_queue_obj->msg_mgr;\r\nspin_lock_bh(&hmsg_mgr->msg_mgr_lock);\r\nif (!list_empty(&hmsg_mgr->msg_free_list)) {\r\nmsg_frame_obj = list_first_entry(&hmsg_mgr->msg_free_list,\r\nstruct msg_frame, list_elem);\r\nlist_del(&msg_frame_obj->list_elem);\r\nmsg_frame_obj->msg_data.msg = *pmsg;\r\nmsg_frame_obj->msg_data.msgq_id =\r\nmsg_queue_obj->msgq_id;\r\nlist_add_tail(&msg_frame_obj->list_elem,\r\n&hmsg_mgr->msg_used_list);\r\nhmsg_mgr->msgs_pending++;\r\nif (list_empty(&hmsg_mgr->msg_free_list))\r\nsync_reset_event(hmsg_mgr->sync_event);\r\nspin_unlock_bh(&hmsg_mgr->msg_mgr_lock);\r\niosm_schedule(hmsg_mgr->iomgr);\r\nreturn 0;\r\n}\r\nif (msg_queue_obj->done) {\r\nspin_unlock_bh(&hmsg_mgr->msg_mgr_lock);\r\nreturn -EPERM;\r\n}\r\nmsg_queue_obj->io_msg_pend++;\r\nspin_unlock_bh(&hmsg_mgr->msg_mgr_lock);\r\nsyncs[0] = hmsg_mgr->sync_event;\r\nsyncs[1] = msg_queue_obj->sync_done;\r\nstatus = sync_wait_on_multiple_events(syncs, 2, utimeout, &index);\r\nif (status)\r\nreturn status;\r\nspin_lock_bh(&hmsg_mgr->msg_mgr_lock);\r\nif (msg_queue_obj->done) {\r\nmsg_queue_obj->io_msg_pend--;\r\nspin_unlock_bh(&hmsg_mgr->msg_mgr_lock);\r\nsync_set_event(msg_queue_obj->sync_done_ack);\r\nreturn -EPERM;\r\n}\r\nif (list_empty(&hmsg_mgr->msg_free_list)) {\r\nspin_unlock_bh(&hmsg_mgr->msg_mgr_lock);\r\nreturn -EFAULT;\r\n}\r\nmsg_frame_obj = list_first_entry(&hmsg_mgr->msg_free_list,\r\nstruct msg_frame, list_elem);\r\nlist_del(&msg_frame_obj->list_elem);\r\nmsg_frame_obj->msg_data.msg = *pmsg;\r\nmsg_frame_obj->msg_data.msgq_id = msg_queue_obj->msgq_id;\r\nlist_add_tail(&msg_frame_obj->list_elem, &hmsg_mgr->msg_used_list);\r\nhmsg_mgr->msgs_pending++;\r\niosm_schedule(hmsg_mgr->iomgr);\r\nmsg_queue_obj->io_msg_pend--;\r\nif (!list_empty(&hmsg_mgr->msg_free_list))\r\nsync_set_event(hmsg_mgr->sync_event);\r\nspin_unlock_bh(&hmsg_mgr->msg_mgr_lock);\r\nreturn 0;\r\n}\r\nint bridge_msg_register_notify(struct msg_queue *msg_queue_obj,\r\nu32 event_mask, u32 notify_type,\r\nstruct dsp_notification *hnotification)\r\n{\r\nint status = 0;\r\nif (!msg_queue_obj || !hnotification) {\r\nstatus = -ENOMEM;\r\ngoto func_end;\r\n}\r\nif (!(event_mask == DSP_NODEMESSAGEREADY || event_mask == 0)) {\r\nstatus = -EPERM;\r\ngoto func_end;\r\n}\r\nif (notify_type != DSP_SIGNALEVENT) {\r\nstatus = -EBADR;\r\ngoto func_end;\r\n}\r\nif (event_mask)\r\nstatus = ntfy_register(msg_queue_obj->ntfy_obj, hnotification,\r\nevent_mask, notify_type);\r\nelse\r\nstatus = ntfy_unregister(msg_queue_obj->ntfy_obj,\r\nhnotification);\r\nif (status == -EINVAL) {\r\nstatus = 0;\r\n}\r\nfunc_end:\r\nreturn status;\r\n}\r\nvoid bridge_msg_set_queue_id(struct msg_queue *msg_queue_obj, u32 msgq_id)\r\n{\r\nif (msg_queue_obj)\r\nmsg_queue_obj->msgq_id = msgq_id;\r\n}\r\nstatic int add_new_msg(struct list_head *msg_list)\r\n{\r\nstruct msg_frame *pmsg;\r\npmsg = kzalloc(sizeof(struct msg_frame), GFP_ATOMIC);\r\nif (!pmsg)\r\nreturn -ENOMEM;\r\nlist_add_tail(&pmsg->list_elem, msg_list);\r\nreturn 0;\r\n}\r\nstatic void delete_msg_mgr(struct msg_mgr *hmsg_mgr)\r\n{\r\nif (!hmsg_mgr)\r\nreturn;\r\nfree_msg_list(&hmsg_mgr->msg_free_list);\r\nfree_msg_list(&hmsg_mgr->msg_used_list);\r\nkfree(hmsg_mgr->sync_event);\r\nkfree(hmsg_mgr);\r\n}\r\nstatic void delete_msg_queue(struct msg_queue *msg_queue_obj, u32 num_to_dsp)\r\n{\r\nstruct msg_mgr *hmsg_mgr;\r\nstruct msg_frame *pmsg, *tmp;\r\nu32 i;\r\nif (!msg_queue_obj || !msg_queue_obj->msg_mgr)\r\nreturn;\r\nhmsg_mgr = msg_queue_obj->msg_mgr;\r\ni = 0;\r\nlist_for_each_entry_safe(pmsg, tmp, &hmsg_mgr->msg_free_list,\r\nlist_elem) {\r\nlist_del(&pmsg->list_elem);\r\nkfree(pmsg);\r\nif (i++ >= num_to_dsp)\r\nbreak;\r\n}\r\nfree_msg_list(&msg_queue_obj->msg_free_list);\r\nfree_msg_list(&msg_queue_obj->msg_used_list);\r\nif (msg_queue_obj->ntfy_obj) {\r\nntfy_delete(msg_queue_obj->ntfy_obj);\r\nkfree(msg_queue_obj->ntfy_obj);\r\n}\r\nkfree(msg_queue_obj->sync_event);\r\nkfree(msg_queue_obj->sync_done);\r\nkfree(msg_queue_obj->sync_done_ack);\r\nkfree(msg_queue_obj);\r\n}\r\nstatic void free_msg_list(struct list_head *msg_list)\r\n{\r\nstruct msg_frame *pmsg, *tmp;\r\nif (!msg_list)\r\nreturn;\r\nlist_for_each_entry_safe(pmsg, tmp, msg_list, list_elem) {\r\nlist_del(&pmsg->list_elem);\r\nkfree(pmsg);\r\n}\r\n}

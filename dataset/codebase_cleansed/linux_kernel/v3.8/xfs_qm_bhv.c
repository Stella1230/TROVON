STATIC void\r\nxfs_fill_statvfs_from_dquot(\r\nstruct kstatfs *statp,\r\nstruct xfs_dquot *dqp)\r\n{\r\n__uint64_t limit;\r\nlimit = dqp->q_core.d_blk_softlimit ?\r\nbe64_to_cpu(dqp->q_core.d_blk_softlimit) :\r\nbe64_to_cpu(dqp->q_core.d_blk_hardlimit);\r\nif (limit && statp->f_blocks > limit) {\r\nstatp->f_blocks = limit;\r\nstatp->f_bfree = statp->f_bavail =\r\n(statp->f_blocks > dqp->q_res_bcount) ?\r\n(statp->f_blocks - dqp->q_res_bcount) : 0;\r\n}\r\nlimit = dqp->q_core.d_ino_softlimit ?\r\nbe64_to_cpu(dqp->q_core.d_ino_softlimit) :\r\nbe64_to_cpu(dqp->q_core.d_ino_hardlimit);\r\nif (limit && statp->f_files > limit) {\r\nstatp->f_files = limit;\r\nstatp->f_ffree =\r\n(statp->f_files > dqp->q_res_icount) ?\r\n(statp->f_ffree - dqp->q_res_icount) : 0;\r\n}\r\n}\r\nvoid\r\nxfs_qm_statvfs(\r\nxfs_inode_t *ip,\r\nstruct kstatfs *statp)\r\n{\r\nxfs_mount_t *mp = ip->i_mount;\r\nxfs_dquot_t *dqp;\r\nif (!xfs_qm_dqget(mp, NULL, xfs_get_projid(ip), XFS_DQ_PROJ, 0, &dqp)) {\r\nxfs_fill_statvfs_from_dquot(statp, dqp);\r\nxfs_qm_dqput(dqp);\r\n}\r\n}\r\nint\r\nxfs_qm_newmount(\r\nxfs_mount_t *mp,\r\nuint *needquotamount,\r\nuint *quotaflags)\r\n{\r\nuint quotaondisk;\r\nuint uquotaondisk = 0, gquotaondisk = 0, pquotaondisk = 0;\r\nquotaondisk = xfs_sb_version_hasquota(&mp->m_sb) &&\r\n(mp->m_sb.sb_qflags & XFS_ALL_QUOTA_ACCT);\r\nif (quotaondisk) {\r\nuquotaondisk = mp->m_sb.sb_qflags & XFS_UQUOTA_ACCT;\r\npquotaondisk = mp->m_sb.sb_qflags & XFS_PQUOTA_ACCT;\r\ngquotaondisk = mp->m_sb.sb_qflags & XFS_GQUOTA_ACCT;\r\n}\r\nif (((uquotaondisk && !XFS_IS_UQUOTA_ON(mp)) ||\r\n(!uquotaondisk && XFS_IS_UQUOTA_ON(mp)) ||\r\n(pquotaondisk && !XFS_IS_PQUOTA_ON(mp)) ||\r\n(!pquotaondisk && XFS_IS_PQUOTA_ON(mp)) ||\r\n(gquotaondisk && !XFS_IS_GQUOTA_ON(mp)) ||\r\n(!gquotaondisk && XFS_IS_OQUOTA_ON(mp))) &&\r\nxfs_dev_is_read_only(mp, "changing quota state")) {\r\nxfs_warn(mp, "please mount with%s%s%s%s.",\r\n(!quotaondisk ? "out quota" : ""),\r\n(uquotaondisk ? " usrquota" : ""),\r\n(pquotaondisk ? " prjquota" : ""),\r\n(gquotaondisk ? " grpquota" : ""));\r\nreturn XFS_ERROR(EPERM);\r\n}\r\nif (XFS_IS_QUOTA_ON(mp) || quotaondisk) {\r\nif (quotaondisk && !XFS_QM_NEED_QUOTACHECK(mp)) {\r\nxfs_qm_mount_quotas(mp);\r\n} else {\r\n*needquotamount = B_TRUE;\r\n*quotaflags = mp->m_qflags;\r\nmp->m_qflags = 0;\r\n}\r\n}\r\nreturn 0;\r\n}

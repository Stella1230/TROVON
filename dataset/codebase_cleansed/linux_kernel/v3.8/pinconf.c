int pinconf_check_ops(struct pinctrl_dev *pctldev)\r\n{\r\nconst struct pinconf_ops *ops = pctldev->desc->confops;\r\nif (!ops->pin_config_get && !ops->pin_config_group_get) {\r\ndev_err(pctldev->dev,\r\n"pinconf must be able to read out pin status\n");\r\nreturn -EINVAL;\r\n}\r\nif (!ops->pin_config_set && !ops->pin_config_group_set) {\r\ndev_err(pctldev->dev,\r\n"pinconf has to be able to set a pins config\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint pinconf_validate_map(struct pinctrl_map const *map, int i)\r\n{\r\nif (!map->data.configs.group_or_pin) {\r\npr_err("failed to register map %s (%d): no group/pin given\n",\r\nmap->name, i);\r\nreturn -EINVAL;\r\n}\r\nif (!map->data.configs.num_configs ||\r\n!map->data.configs.configs) {\r\npr_err("failed to register map %s (%d): no configs given\n",\r\nmap->name, i);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint pin_config_get_for_pin(struct pinctrl_dev *pctldev, unsigned pin,\r\nunsigned long *config)\r\n{\r\nconst struct pinconf_ops *ops = pctldev->desc->confops;\r\nif (!ops || !ops->pin_config_get) {\r\ndev_err(pctldev->dev, "cannot get pin configuration, missing "\r\n"pin_config_get() function in driver\n");\r\nreturn -EINVAL;\r\n}\r\nreturn ops->pin_config_get(pctldev, pin, config);\r\n}\r\nint pin_config_get(const char *dev_name, const char *name,\r\nunsigned long *config)\r\n{\r\nstruct pinctrl_dev *pctldev;\r\nint pin;\r\nmutex_lock(&pinctrl_mutex);\r\npctldev = get_pinctrl_dev_from_devname(dev_name);\r\nif (!pctldev) {\r\npin = -EINVAL;\r\ngoto unlock;\r\n}\r\npin = pin_get_from_name(pctldev, name);\r\nif (pin < 0)\r\ngoto unlock;\r\npin = pin_config_get_for_pin(pctldev, pin, config);\r\nunlock:\r\nmutex_unlock(&pinctrl_mutex);\r\nreturn pin;\r\n}\r\nstatic int pin_config_set_for_pin(struct pinctrl_dev *pctldev, unsigned pin,\r\nunsigned long config)\r\n{\r\nconst struct pinconf_ops *ops = pctldev->desc->confops;\r\nint ret;\r\nif (!ops || !ops->pin_config_set) {\r\ndev_err(pctldev->dev, "cannot configure pin, missing "\r\n"config function in driver\n");\r\nreturn -EINVAL;\r\n}\r\nret = ops->pin_config_set(pctldev, pin, config);\r\nif (ret) {\r\ndev_err(pctldev->dev,\r\n"unable to set pin configuration on pin %d\n", pin);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nint pin_config_set(const char *dev_name, const char *name,\r\nunsigned long config)\r\n{\r\nstruct pinctrl_dev *pctldev;\r\nint pin, ret;\r\nmutex_lock(&pinctrl_mutex);\r\npctldev = get_pinctrl_dev_from_devname(dev_name);\r\nif (!pctldev) {\r\nret = -EINVAL;\r\ngoto unlock;\r\n}\r\npin = pin_get_from_name(pctldev, name);\r\nif (pin < 0) {\r\nret = pin;\r\ngoto unlock;\r\n}\r\nret = pin_config_set_for_pin(pctldev, pin, config);\r\nunlock:\r\nmutex_unlock(&pinctrl_mutex);\r\nreturn ret;\r\n}\r\nint pin_config_group_get(const char *dev_name, const char *pin_group,\r\nunsigned long *config)\r\n{\r\nstruct pinctrl_dev *pctldev;\r\nconst struct pinconf_ops *ops;\r\nint selector, ret;\r\nmutex_lock(&pinctrl_mutex);\r\npctldev = get_pinctrl_dev_from_devname(dev_name);\r\nif (!pctldev) {\r\nret = -EINVAL;\r\ngoto unlock;\r\n}\r\nops = pctldev->desc->confops;\r\nif (!ops || !ops->pin_config_group_get) {\r\ndev_err(pctldev->dev, "cannot get configuration for pin "\r\n"group, missing group config get function in "\r\n"driver\n");\r\nret = -EINVAL;\r\ngoto unlock;\r\n}\r\nselector = pinctrl_get_group_selector(pctldev, pin_group);\r\nif (selector < 0) {\r\nret = selector;\r\ngoto unlock;\r\n}\r\nret = ops->pin_config_group_get(pctldev, selector, config);\r\nunlock:\r\nmutex_unlock(&pinctrl_mutex);\r\nreturn ret;\r\n}\r\nint pin_config_group_set(const char *dev_name, const char *pin_group,\r\nunsigned long config)\r\n{\r\nstruct pinctrl_dev *pctldev;\r\nconst struct pinconf_ops *ops;\r\nconst struct pinctrl_ops *pctlops;\r\nint selector;\r\nconst unsigned *pins;\r\nunsigned num_pins;\r\nint ret;\r\nint i;\r\nmutex_lock(&pinctrl_mutex);\r\npctldev = get_pinctrl_dev_from_devname(dev_name);\r\nif (!pctldev) {\r\nret = -EINVAL;\r\ngoto unlock;\r\n}\r\nops = pctldev->desc->confops;\r\npctlops = pctldev->desc->pctlops;\r\nif (!ops || (!ops->pin_config_group_set && !ops->pin_config_set)) {\r\ndev_err(pctldev->dev, "cannot configure pin group, missing "\r\n"config function in driver\n");\r\nret = -EINVAL;\r\ngoto unlock;\r\n}\r\nselector = pinctrl_get_group_selector(pctldev, pin_group);\r\nif (selector < 0) {\r\nret = selector;\r\ngoto unlock;\r\n}\r\nret = pctlops->get_group_pins(pctldev, selector, &pins, &num_pins);\r\nif (ret) {\r\ndev_err(pctldev->dev, "cannot configure pin group, error "\r\n"getting pins\n");\r\ngoto unlock;\r\n}\r\nif (ops->pin_config_group_set) {\r\nret = ops->pin_config_group_set(pctldev, selector, config);\r\nif (ret != -EAGAIN)\r\ngoto unlock;\r\n}\r\nif (!ops->pin_config_set) {\r\nret = 0;\r\ngoto unlock;\r\n}\r\nfor (i = 0; i < num_pins; i++) {\r\nret = ops->pin_config_set(pctldev, pins[i], config);\r\nif (ret < 0)\r\ngoto unlock;\r\n}\r\nret = 0;\r\nunlock:\r\nmutex_unlock(&pinctrl_mutex);\r\nreturn ret;\r\n}\r\nint pinconf_map_to_setting(struct pinctrl_map const *map,\r\nstruct pinctrl_setting *setting)\r\n{\r\nstruct pinctrl_dev *pctldev = setting->pctldev;\r\nint pin;\r\nswitch (setting->type) {\r\ncase PIN_MAP_TYPE_CONFIGS_PIN:\r\npin = pin_get_from_name(pctldev,\r\nmap->data.configs.group_or_pin);\r\nif (pin < 0) {\r\ndev_err(pctldev->dev, "could not map pin config for \"%s\"",\r\nmap->data.configs.group_or_pin);\r\nreturn pin;\r\n}\r\nsetting->data.configs.group_or_pin = pin;\r\nbreak;\r\ncase PIN_MAP_TYPE_CONFIGS_GROUP:\r\npin = pinctrl_get_group_selector(pctldev,\r\nmap->data.configs.group_or_pin);\r\nif (pin < 0) {\r\ndev_err(pctldev->dev, "could not map group config for \"%s\"",\r\nmap->data.configs.group_or_pin);\r\nreturn pin;\r\n}\r\nsetting->data.configs.group_or_pin = pin;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nsetting->data.configs.num_configs = map->data.configs.num_configs;\r\nsetting->data.configs.configs = map->data.configs.configs;\r\nreturn 0;\r\n}\r\nvoid pinconf_free_setting(struct pinctrl_setting const *setting)\r\n{\r\n}\r\nint pinconf_apply_setting(struct pinctrl_setting const *setting)\r\n{\r\nstruct pinctrl_dev *pctldev = setting->pctldev;\r\nconst struct pinconf_ops *ops = pctldev->desc->confops;\r\nint i, ret;\r\nif (!ops) {\r\ndev_err(pctldev->dev, "missing confops\n");\r\nreturn -EINVAL;\r\n}\r\nswitch (setting->type) {\r\ncase PIN_MAP_TYPE_CONFIGS_PIN:\r\nif (!ops->pin_config_set) {\r\ndev_err(pctldev->dev, "missing pin_config_set op\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < setting->data.configs.num_configs; i++) {\r\nret = ops->pin_config_set(pctldev,\r\nsetting->data.configs.group_or_pin,\r\nsetting->data.configs.configs[i]);\r\nif (ret < 0) {\r\ndev_err(pctldev->dev,\r\n"pin_config_set op failed for pin %d config %08lx\n",\r\nsetting->data.configs.group_or_pin,\r\nsetting->data.configs.configs[i]);\r\nreturn ret;\r\n}\r\n}\r\nbreak;\r\ncase PIN_MAP_TYPE_CONFIGS_GROUP:\r\nif (!ops->pin_config_group_set) {\r\ndev_err(pctldev->dev,\r\n"missing pin_config_group_set op\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < setting->data.configs.num_configs; i++) {\r\nret = ops->pin_config_group_set(pctldev,\r\nsetting->data.configs.group_or_pin,\r\nsetting->data.configs.configs[i]);\r\nif (ret < 0) {\r\ndev_err(pctldev->dev,\r\n"pin_config_group_set op failed for group %d config %08lx\n",\r\nsetting->data.configs.group_or_pin,\r\nsetting->data.configs.configs[i]);\r\nreturn ret;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nvoid pinconf_show_map(struct seq_file *s, struct pinctrl_map const *map)\r\n{\r\nstruct pinctrl_dev *pctldev;\r\nconst struct pinconf_ops *confops;\r\nint i;\r\npctldev = get_pinctrl_dev_from_devname(map->ctrl_dev_name);\r\nif (pctldev)\r\nconfops = pctldev->desc->confops;\r\nelse\r\nconfops = NULL;\r\nswitch (map->type) {\r\ncase PIN_MAP_TYPE_CONFIGS_PIN:\r\nseq_printf(s, "pin ");\r\nbreak;\r\ncase PIN_MAP_TYPE_CONFIGS_GROUP:\r\nseq_printf(s, "group ");\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nseq_printf(s, "%s\n", map->data.configs.group_or_pin);\r\nfor (i = 0; i < map->data.configs.num_configs; i++) {\r\nseq_printf(s, "config ");\r\nif (confops && confops->pin_config_config_dbg_show)\r\nconfops->pin_config_config_dbg_show(pctldev, s,\r\nmap->data.configs.configs[i]);\r\nelse\r\nseq_printf(s, "%08lx", map->data.configs.configs[i]);\r\nseq_printf(s, "\n");\r\n}\r\n}\r\nvoid pinconf_show_setting(struct seq_file *s,\r\nstruct pinctrl_setting const *setting)\r\n{\r\nstruct pinctrl_dev *pctldev = setting->pctldev;\r\nconst struct pinctrl_ops *pctlops = pctldev->desc->pctlops;\r\nconst struct pinconf_ops *confops = pctldev->desc->confops;\r\nstruct pin_desc *desc;\r\nint i;\r\nswitch (setting->type) {\r\ncase PIN_MAP_TYPE_CONFIGS_PIN:\r\ndesc = pin_desc_get(setting->pctldev,\r\nsetting->data.configs.group_or_pin);\r\nseq_printf(s, "pin %s (%d)",\r\ndesc->name ? desc->name : "unnamed",\r\nsetting->data.configs.group_or_pin);\r\nbreak;\r\ncase PIN_MAP_TYPE_CONFIGS_GROUP:\r\nseq_printf(s, "group %s (%d)",\r\npctlops->get_group_name(pctldev,\r\nsetting->data.configs.group_or_pin),\r\nsetting->data.configs.group_or_pin);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nfor (i = 0; i < setting->data.configs.num_configs; i++) {\r\nseq_printf(s, " ");\r\nif (confops && confops->pin_config_config_dbg_show)\r\nconfops->pin_config_config_dbg_show(pctldev, s,\r\nsetting->data.configs.configs[i]);\r\nelse\r\nseq_printf(s, "%08lx",\r\nsetting->data.configs.configs[i]);\r\n}\r\nseq_printf(s, "\n");\r\n}\r\nstatic void pinconf_dump_pin(struct pinctrl_dev *pctldev,\r\nstruct seq_file *s, int pin)\r\n{\r\nconst struct pinconf_ops *ops = pctldev->desc->confops;\r\npinconf_generic_dump_pin(pctldev, s, pin);\r\nif (ops && ops->pin_config_dbg_show)\r\nops->pin_config_dbg_show(pctldev, s, pin);\r\n}\r\nstatic int pinconf_pins_show(struct seq_file *s, void *what)\r\n{\r\nstruct pinctrl_dev *pctldev = s->private;\r\nconst struct pinconf_ops *ops = pctldev->desc->confops;\r\nunsigned i, pin;\r\nif (!ops || !ops->pin_config_get)\r\nreturn 0;\r\nseq_puts(s, "Pin config settings per pin\n");\r\nseq_puts(s, "Format: pin (name): configs\n");\r\nmutex_lock(&pinctrl_mutex);\r\nfor (i = 0; i < pctldev->desc->npins; i++) {\r\nstruct pin_desc *desc;\r\npin = pctldev->desc->pins[i].number;\r\ndesc = pin_desc_get(pctldev, pin);\r\nif (desc == NULL)\r\ncontinue;\r\nseq_printf(s, "pin %d (%s):", pin,\r\ndesc->name ? desc->name : "unnamed");\r\npinconf_dump_pin(pctldev, s, pin);\r\nseq_printf(s, "\n");\r\n}\r\nmutex_unlock(&pinctrl_mutex);\r\nreturn 0;\r\n}\r\nstatic void pinconf_dump_group(struct pinctrl_dev *pctldev,\r\nstruct seq_file *s, unsigned selector,\r\nconst char *gname)\r\n{\r\nconst struct pinconf_ops *ops = pctldev->desc->confops;\r\npinconf_generic_dump_group(pctldev, s, gname);\r\nif (ops && ops->pin_config_group_dbg_show)\r\nops->pin_config_group_dbg_show(pctldev, s, selector);\r\n}\r\nstatic int pinconf_groups_show(struct seq_file *s, void *what)\r\n{\r\nstruct pinctrl_dev *pctldev = s->private;\r\nconst struct pinctrl_ops *pctlops = pctldev->desc->pctlops;\r\nconst struct pinconf_ops *ops = pctldev->desc->confops;\r\nunsigned ngroups = pctlops->get_groups_count(pctldev);\r\nunsigned selector = 0;\r\nif (!ops || !ops->pin_config_group_get)\r\nreturn 0;\r\nseq_puts(s, "Pin config settings per pin group\n");\r\nseq_puts(s, "Format: group (name): configs\n");\r\nwhile (selector < ngroups) {\r\nconst char *gname = pctlops->get_group_name(pctldev, selector);\r\nseq_printf(s, "%u (%s):", selector, gname);\r\npinconf_dump_group(pctldev, s, selector, gname);\r\nseq_printf(s, "\n");\r\nselector++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pinconf_pins_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, pinconf_pins_show, inode->i_private);\r\n}\r\nstatic int pinconf_groups_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, pinconf_groups_show, inode->i_private);\r\n}\r\nvoid pinconf_init_device_debugfs(struct dentry *devroot,\r\nstruct pinctrl_dev *pctldev)\r\n{\r\ndebugfs_create_file("pinconf-pins", S_IFREG | S_IRUGO,\r\ndevroot, pctldev, &pinconf_pins_ops);\r\ndebugfs_create_file("pinconf-groups", S_IFREG | S_IRUGO,\r\ndevroot, pctldev, &pinconf_groups_ops);\r\n}

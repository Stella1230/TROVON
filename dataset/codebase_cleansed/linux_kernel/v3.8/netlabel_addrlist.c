struct netlbl_af4list *netlbl_af4list_search(__be32 addr,\r\nstruct list_head *head)\r\n{\r\nstruct netlbl_af4list *iter;\r\nlist_for_each_entry_rcu(iter, head, list)\r\nif (iter->valid && (addr & iter->mask) == iter->addr)\r\nreturn iter;\r\nreturn NULL;\r\n}\r\nstruct netlbl_af4list *netlbl_af4list_search_exact(__be32 addr,\r\n__be32 mask,\r\nstruct list_head *head)\r\n{\r\nstruct netlbl_af4list *iter;\r\nlist_for_each_entry_rcu(iter, head, list)\r\nif (iter->valid && iter->addr == addr && iter->mask == mask)\r\nreturn iter;\r\nreturn NULL;\r\n}\r\nstruct netlbl_af6list *netlbl_af6list_search(const struct in6_addr *addr,\r\nstruct list_head *head)\r\n{\r\nstruct netlbl_af6list *iter;\r\nlist_for_each_entry_rcu(iter, head, list)\r\nif (iter->valid &&\r\nipv6_masked_addr_cmp(&iter->addr, &iter->mask, addr) == 0)\r\nreturn iter;\r\nreturn NULL;\r\n}\r\nstruct netlbl_af6list *netlbl_af6list_search_exact(const struct in6_addr *addr,\r\nconst struct in6_addr *mask,\r\nstruct list_head *head)\r\n{\r\nstruct netlbl_af6list *iter;\r\nlist_for_each_entry_rcu(iter, head, list)\r\nif (iter->valid &&\r\nipv6_addr_equal(&iter->addr, addr) &&\r\nipv6_addr_equal(&iter->mask, mask))\r\nreturn iter;\r\nreturn NULL;\r\n}\r\nint netlbl_af4list_add(struct netlbl_af4list *entry, struct list_head *head)\r\n{\r\nstruct netlbl_af4list *iter;\r\niter = netlbl_af4list_search(entry->addr, head);\r\nif (iter != NULL &&\r\niter->addr == entry->addr && iter->mask == entry->mask)\r\nreturn -EEXIST;\r\nlist_for_each_entry_rcu(iter, head, list)\r\nif (iter->valid &&\r\nntohl(entry->mask) > ntohl(iter->mask)) {\r\n__list_add_rcu(&entry->list,\r\niter->list.prev,\r\n&iter->list);\r\nreturn 0;\r\n}\r\nlist_add_tail_rcu(&entry->list, head);\r\nreturn 0;\r\n}\r\nint netlbl_af6list_add(struct netlbl_af6list *entry, struct list_head *head)\r\n{\r\nstruct netlbl_af6list *iter;\r\niter = netlbl_af6list_search(&entry->addr, head);\r\nif (iter != NULL &&\r\nipv6_addr_equal(&iter->addr, &entry->addr) &&\r\nipv6_addr_equal(&iter->mask, &entry->mask))\r\nreturn -EEXIST;\r\nlist_for_each_entry_rcu(iter, head, list)\r\nif (iter->valid &&\r\nipv6_addr_cmp(&entry->mask, &iter->mask) > 0) {\r\n__list_add_rcu(&entry->list,\r\niter->list.prev,\r\n&iter->list);\r\nreturn 0;\r\n}\r\nlist_add_tail_rcu(&entry->list, head);\r\nreturn 0;\r\n}\r\nvoid netlbl_af4list_remove_entry(struct netlbl_af4list *entry)\r\n{\r\nentry->valid = 0;\r\nlist_del_rcu(&entry->list);\r\n}\r\nstruct netlbl_af4list *netlbl_af4list_remove(__be32 addr, __be32 mask,\r\nstruct list_head *head)\r\n{\r\nstruct netlbl_af4list *entry;\r\nentry = netlbl_af4list_search_exact(addr, mask, head);\r\nif (entry == NULL)\r\nreturn NULL;\r\nnetlbl_af4list_remove_entry(entry);\r\nreturn entry;\r\n}\r\nvoid netlbl_af6list_remove_entry(struct netlbl_af6list *entry)\r\n{\r\nentry->valid = 0;\r\nlist_del_rcu(&entry->list);\r\n}\r\nstruct netlbl_af6list *netlbl_af6list_remove(const struct in6_addr *addr,\r\nconst struct in6_addr *mask,\r\nstruct list_head *head)\r\n{\r\nstruct netlbl_af6list *entry;\r\nentry = netlbl_af6list_search_exact(addr, mask, head);\r\nif (entry == NULL)\r\nreturn NULL;\r\nnetlbl_af6list_remove_entry(entry);\r\nreturn entry;\r\n}\r\nvoid netlbl_af4list_audit_addr(struct audit_buffer *audit_buf,\r\nint src, const char *dev,\r\n__be32 addr, __be32 mask)\r\n{\r\nu32 mask_val = ntohl(mask);\r\nchar *dir = (src ? "src" : "dst");\r\nif (dev != NULL)\r\naudit_log_format(audit_buf, " netif=%s", dev);\r\naudit_log_format(audit_buf, " %s=%pI4", dir, &addr);\r\nif (mask_val != 0xffffffff) {\r\nu32 mask_len = 0;\r\nwhile (mask_val > 0) {\r\nmask_val <<= 1;\r\nmask_len++;\r\n}\r\naudit_log_format(audit_buf, " %s_prefixlen=%d", dir, mask_len);\r\n}\r\n}\r\nvoid netlbl_af6list_audit_addr(struct audit_buffer *audit_buf,\r\nint src,\r\nconst char *dev,\r\nconst struct in6_addr *addr,\r\nconst struct in6_addr *mask)\r\n{\r\nchar *dir = (src ? "src" : "dst");\r\nif (dev != NULL)\r\naudit_log_format(audit_buf, " netif=%s", dev);\r\naudit_log_format(audit_buf, " %s=%pI6", dir, addr);\r\nif (ntohl(mask->s6_addr32[3]) != 0xffffffff) {\r\nu32 mask_len = 0;\r\nu32 mask_val;\r\nint iter = -1;\r\nwhile (ntohl(mask->s6_addr32[++iter]) == 0xffffffff)\r\nmask_len += 32;\r\nmask_val = ntohl(mask->s6_addr32[iter]);\r\nwhile (mask_val > 0) {\r\nmask_val <<= 1;\r\nmask_len++;\r\n}\r\naudit_log_format(audit_buf, " %s_prefixlen=%d", dir, mask_len);\r\n}\r\n}

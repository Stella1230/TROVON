STATIC uint\r\nxfs_calc_write_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn XFS_DQUOT_LOGRES(mp) +\r\nMAX((mp->m_sb.sb_inodesize +\r\nXFS_FSB_TO_B(mp, XFS_BM_MAXLEVELS(mp, XFS_DATA_FORK)) +\r\n2 * mp->m_sb.sb_sectsize +\r\nmp->m_sb.sb_sectsize +\r\nXFS_ALLOCFREE_LOG_RES(mp, 2) +\r\n128 * (4 + XFS_BM_MAXLEVELS(mp, XFS_DATA_FORK) +\r\nXFS_ALLOCFREE_LOG_COUNT(mp, 2))),\r\n(2 * mp->m_sb.sb_sectsize +\r\n2 * mp->m_sb.sb_sectsize +\r\nmp->m_sb.sb_sectsize +\r\nXFS_ALLOCFREE_LOG_RES(mp, 2) +\r\n128 * (5 + XFS_ALLOCFREE_LOG_COUNT(mp, 2))));\r\n}\r\nSTATIC uint\r\nxfs_calc_itruncate_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn XFS_DQUOT_LOGRES(mp) +\r\nMAX((mp->m_sb.sb_inodesize +\r\nXFS_FSB_TO_B(mp, XFS_BM_MAXLEVELS(mp, XFS_DATA_FORK) + 1) +\r\n128 * (2 + XFS_BM_MAXLEVELS(mp, XFS_DATA_FORK))),\r\n(4 * mp->m_sb.sb_sectsize +\r\n4 * mp->m_sb.sb_sectsize +\r\nmp->m_sb.sb_sectsize +\r\nXFS_ALLOCFREE_LOG_RES(mp, 4) +\r\n128 * (9 + XFS_ALLOCFREE_LOG_COUNT(mp, 4)) +\r\n128 * 5 +\r\nXFS_ALLOCFREE_LOG_RES(mp, 1) +\r\n128 * (2 + XFS_IALLOC_BLOCKS(mp) + mp->m_in_maxlevels +\r\nXFS_ALLOCFREE_LOG_COUNT(mp, 1))));\r\n}\r\nSTATIC uint\r\nxfs_calc_rename_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn XFS_DQUOT_LOGRES(mp) +\r\nMAX((4 * mp->m_sb.sb_inodesize +\r\n2 * XFS_DIROP_LOG_RES(mp) +\r\n128 * (4 + 2 * XFS_DIROP_LOG_COUNT(mp))),\r\n(3 * mp->m_sb.sb_sectsize +\r\n3 * mp->m_sb.sb_sectsize +\r\nmp->m_sb.sb_sectsize +\r\nXFS_ALLOCFREE_LOG_RES(mp, 3) +\r\n128 * (7 + XFS_ALLOCFREE_LOG_COUNT(mp, 3))));\r\n}\r\nSTATIC uint\r\nxfs_calc_link_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn XFS_DQUOT_LOGRES(mp) +\r\nMAX((mp->m_sb.sb_inodesize +\r\nmp->m_sb.sb_inodesize +\r\nXFS_DIROP_LOG_RES(mp) +\r\n128 * (2 + XFS_DIROP_LOG_COUNT(mp))),\r\n(mp->m_sb.sb_sectsize +\r\nmp->m_sb.sb_sectsize +\r\nmp->m_sb.sb_sectsize +\r\nXFS_ALLOCFREE_LOG_RES(mp, 1) +\r\n128 * (3 + XFS_ALLOCFREE_LOG_COUNT(mp, 1))));\r\n}\r\nSTATIC uint\r\nxfs_calc_remove_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn XFS_DQUOT_LOGRES(mp) +\r\nMAX((mp->m_sb.sb_inodesize +\r\nmp->m_sb.sb_inodesize +\r\nXFS_DIROP_LOG_RES(mp) +\r\n128 * (2 + XFS_DIROP_LOG_COUNT(mp))),\r\n(2 * mp->m_sb.sb_sectsize +\r\n2 * mp->m_sb.sb_sectsize +\r\nmp->m_sb.sb_sectsize +\r\nXFS_ALLOCFREE_LOG_RES(mp, 2) +\r\n128 * (5 + XFS_ALLOCFREE_LOG_COUNT(mp, 2))));\r\n}\r\nSTATIC uint\r\nxfs_calc_symlink_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn XFS_DQUOT_LOGRES(mp) +\r\nMAX((mp->m_sb.sb_inodesize +\r\nmp->m_sb.sb_inodesize +\r\nXFS_FSB_TO_B(mp, 1) +\r\nXFS_DIROP_LOG_RES(mp) +\r\n1024 +\r\n128 * (4 + XFS_DIROP_LOG_COUNT(mp))),\r\n(2 * mp->m_sb.sb_sectsize +\r\nXFS_FSB_TO_B(mp, XFS_IALLOC_BLOCKS(mp)) +\r\nXFS_FSB_TO_B(mp, mp->m_in_maxlevels) +\r\nXFS_ALLOCFREE_LOG_RES(mp, 1) +\r\n128 * (2 + XFS_IALLOC_BLOCKS(mp) + mp->m_in_maxlevels +\r\nXFS_ALLOCFREE_LOG_COUNT(mp, 1))));\r\n}\r\nSTATIC uint\r\nxfs_calc_create_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn XFS_DQUOT_LOGRES(mp) +\r\nMAX((mp->m_sb.sb_inodesize +\r\nmp->m_sb.sb_inodesize +\r\nmp->m_sb.sb_sectsize +\r\nXFS_FSB_TO_B(mp, 1) +\r\nXFS_DIROP_LOG_RES(mp) +\r\n128 * (3 + XFS_DIROP_LOG_COUNT(mp))),\r\n(3 * mp->m_sb.sb_sectsize +\r\nXFS_FSB_TO_B(mp, XFS_IALLOC_BLOCKS(mp)) +\r\nXFS_FSB_TO_B(mp, mp->m_in_maxlevels) +\r\nXFS_ALLOCFREE_LOG_RES(mp, 1) +\r\n128 * (2 + XFS_IALLOC_BLOCKS(mp) + mp->m_in_maxlevels +\r\nXFS_ALLOCFREE_LOG_COUNT(mp, 1))));\r\n}\r\nSTATIC uint\r\nxfs_calc_mkdir_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn xfs_calc_create_reservation(mp);\r\n}\r\nSTATIC uint\r\nxfs_calc_ifree_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn XFS_DQUOT_LOGRES(mp) +\r\nmp->m_sb.sb_inodesize +\r\nmp->m_sb.sb_sectsize +\r\nmp->m_sb.sb_sectsize +\r\nXFS_FSB_TO_B(mp, 1) +\r\nMAX((__uint16_t)XFS_FSB_TO_B(mp, 1),\r\nXFS_INODE_CLUSTER_SIZE(mp)) +\r\n128 * 5 +\r\nXFS_ALLOCFREE_LOG_RES(mp, 1) +\r\n128 * (2 + XFS_IALLOC_BLOCKS(mp) + mp->m_in_maxlevels +\r\nXFS_ALLOCFREE_LOG_COUNT(mp, 1));\r\n}\r\nSTATIC uint\r\nxfs_calc_ichange_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn XFS_DQUOT_LOGRES(mp) +\r\nmp->m_sb.sb_inodesize +\r\nmp->m_sb.sb_sectsize +\r\n512;\r\n}\r\nSTATIC uint\r\nxfs_calc_growdata_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn mp->m_sb.sb_sectsize * 3 +\r\nXFS_ALLOCFREE_LOG_RES(mp, 1) +\r\n128 * (3 + XFS_ALLOCFREE_LOG_COUNT(mp, 1));\r\n}\r\nSTATIC uint\r\nxfs_calc_growrtalloc_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn 2 * mp->m_sb.sb_sectsize +\r\nXFS_FSB_TO_B(mp, XFS_BM_MAXLEVELS(mp, XFS_DATA_FORK)) +\r\nmp->m_sb.sb_inodesize +\r\nXFS_ALLOCFREE_LOG_RES(mp, 1) +\r\n128 * (3 + XFS_BM_MAXLEVELS(mp, XFS_DATA_FORK) +\r\nXFS_ALLOCFREE_LOG_COUNT(mp, 1));\r\n}\r\nSTATIC uint\r\nxfs_calc_growrtzero_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn mp->m_sb.sb_blocksize + 128;\r\n}\r\nSTATIC uint\r\nxfs_calc_growrtfree_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn mp->m_sb.sb_sectsize +\r\n2 * mp->m_sb.sb_inodesize +\r\nmp->m_sb.sb_blocksize +\r\nmp->m_rsumsize +\r\n128 * 5;\r\n}\r\nSTATIC uint\r\nxfs_calc_swrite_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn mp->m_sb.sb_inodesize + 128;\r\n}\r\nSTATIC uint\r\nxfs_calc_writeid_reservation(xfs_mount_t *mp)\r\n{\r\nreturn mp->m_sb.sb_inodesize + 128;\r\n}\r\nSTATIC uint\r\nxfs_calc_addafork_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn XFS_DQUOT_LOGRES(mp) +\r\nmp->m_sb.sb_inodesize +\r\nmp->m_sb.sb_sectsize * 2 +\r\nmp->m_dirblksize +\r\nXFS_FSB_TO_B(mp, XFS_DAENTER_BMAP1B(mp, XFS_DATA_FORK) + 1) +\r\nXFS_ALLOCFREE_LOG_RES(mp, 1) +\r\n128 * (4 + XFS_DAENTER_BMAP1B(mp, XFS_DATA_FORK) + 1 +\r\nXFS_ALLOCFREE_LOG_COUNT(mp, 1));\r\n}\r\nSTATIC uint\r\nxfs_calc_attrinval_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn MAX((mp->m_sb.sb_inodesize +\r\nXFS_FSB_TO_B(mp, XFS_BM_MAXLEVELS(mp, XFS_ATTR_FORK)) +\r\n128 * (1 + XFS_BM_MAXLEVELS(mp, XFS_ATTR_FORK))),\r\n(4 * mp->m_sb.sb_sectsize +\r\n4 * mp->m_sb.sb_sectsize +\r\nmp->m_sb.sb_sectsize +\r\nXFS_ALLOCFREE_LOG_RES(mp, 4) +\r\n128 * (9 + XFS_ALLOCFREE_LOG_COUNT(mp, 4))));\r\n}\r\nSTATIC uint\r\nxfs_calc_attrset_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn XFS_DQUOT_LOGRES(mp) +\r\nmp->m_sb.sb_inodesize +\r\nmp->m_sb.sb_sectsize +\r\nXFS_FSB_TO_B(mp, XFS_DA_NODE_MAXDEPTH) +\r\n128 * (2 + XFS_DA_NODE_MAXDEPTH);\r\n}\r\nSTATIC uint\r\nxfs_calc_attrrm_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn XFS_DQUOT_LOGRES(mp) +\r\nMAX((mp->m_sb.sb_inodesize +\r\nXFS_FSB_TO_B(mp, XFS_DA_NODE_MAXDEPTH) +\r\nXFS_FSB_TO_B(mp, XFS_BM_MAXLEVELS(mp, XFS_ATTR_FORK)) +\r\n128 * (1 + XFS_DA_NODE_MAXDEPTH +\r\nXFS_BM_MAXLEVELS(mp, XFS_DATA_FORK))),\r\n(2 * mp->m_sb.sb_sectsize +\r\n2 * mp->m_sb.sb_sectsize +\r\nmp->m_sb.sb_sectsize +\r\nXFS_ALLOCFREE_LOG_RES(mp, 2) +\r\n128 * (5 + XFS_ALLOCFREE_LOG_COUNT(mp, 2))));\r\n}\r\nSTATIC uint\r\nxfs_calc_clear_agi_bucket_reservation(\r\nstruct xfs_mount *mp)\r\n{\r\nreturn mp->m_sb.sb_sectsize + 128;\r\n}\r\nvoid\r\nxfs_trans_init(\r\nstruct xfs_mount *mp)\r\n{\r\nstruct xfs_trans_reservations *resp = &mp->m_reservations;\r\nresp->tr_write = xfs_calc_write_reservation(mp);\r\nresp->tr_itruncate = xfs_calc_itruncate_reservation(mp);\r\nresp->tr_rename = xfs_calc_rename_reservation(mp);\r\nresp->tr_link = xfs_calc_link_reservation(mp);\r\nresp->tr_remove = xfs_calc_remove_reservation(mp);\r\nresp->tr_symlink = xfs_calc_symlink_reservation(mp);\r\nresp->tr_create = xfs_calc_create_reservation(mp);\r\nresp->tr_mkdir = xfs_calc_mkdir_reservation(mp);\r\nresp->tr_ifree = xfs_calc_ifree_reservation(mp);\r\nresp->tr_ichange = xfs_calc_ichange_reservation(mp);\r\nresp->tr_growdata = xfs_calc_growdata_reservation(mp);\r\nresp->tr_swrite = xfs_calc_swrite_reservation(mp);\r\nresp->tr_writeid = xfs_calc_writeid_reservation(mp);\r\nresp->tr_addafork = xfs_calc_addafork_reservation(mp);\r\nresp->tr_attrinval = xfs_calc_attrinval_reservation(mp);\r\nresp->tr_attrset = xfs_calc_attrset_reservation(mp);\r\nresp->tr_attrrm = xfs_calc_attrrm_reservation(mp);\r\nresp->tr_clearagi = xfs_calc_clear_agi_bucket_reservation(mp);\r\nresp->tr_growrtalloc = xfs_calc_growrtalloc_reservation(mp);\r\nresp->tr_growrtzero = xfs_calc_growrtzero_reservation(mp);\r\nresp->tr_growrtfree = xfs_calc_growrtfree_reservation(mp);\r\n}\r\nxfs_trans_t *\r\nxfs_trans_alloc(\r\nxfs_mount_t *mp,\r\nuint type)\r\n{\r\nxfs_trans_t *tp;\r\nsb_start_intwrite(mp->m_super);\r\ntp = _xfs_trans_alloc(mp, type, KM_SLEEP);\r\ntp->t_flags |= XFS_TRANS_FREEZE_PROT;\r\nreturn tp;\r\n}\r\nxfs_trans_t *\r\n_xfs_trans_alloc(\r\nxfs_mount_t *mp,\r\nuint type,\r\nxfs_km_flags_t memflags)\r\n{\r\nxfs_trans_t *tp;\r\nWARN_ON(mp->m_super->s_writers.frozen == SB_FREEZE_COMPLETE);\r\natomic_inc(&mp->m_active_trans);\r\ntp = kmem_zone_zalloc(xfs_trans_zone, memflags);\r\ntp->t_magic = XFS_TRANS_MAGIC;\r\ntp->t_type = type;\r\ntp->t_mountp = mp;\r\nINIT_LIST_HEAD(&tp->t_items);\r\nINIT_LIST_HEAD(&tp->t_busy);\r\nreturn tp;\r\n}\r\nSTATIC void\r\nxfs_trans_free(\r\nstruct xfs_trans *tp)\r\n{\r\nxfs_extent_busy_sort(&tp->t_busy);\r\nxfs_extent_busy_clear(tp->t_mountp, &tp->t_busy, false);\r\natomic_dec(&tp->t_mountp->m_active_trans);\r\nif (tp->t_flags & XFS_TRANS_FREEZE_PROT)\r\nsb_end_intwrite(tp->t_mountp->m_super);\r\nxfs_trans_free_dqinfo(tp);\r\nkmem_zone_free(xfs_trans_zone, tp);\r\n}\r\nxfs_trans_t *\r\nxfs_trans_dup(\r\nxfs_trans_t *tp)\r\n{\r\nxfs_trans_t *ntp;\r\nntp = kmem_zone_zalloc(xfs_trans_zone, KM_SLEEP);\r\nntp->t_magic = XFS_TRANS_MAGIC;\r\nntp->t_type = tp->t_type;\r\nntp->t_mountp = tp->t_mountp;\r\nINIT_LIST_HEAD(&ntp->t_items);\r\nINIT_LIST_HEAD(&ntp->t_busy);\r\nASSERT(tp->t_flags & XFS_TRANS_PERM_LOG_RES);\r\nASSERT(tp->t_ticket != NULL);\r\nntp->t_flags = XFS_TRANS_PERM_LOG_RES |\r\n(tp->t_flags & XFS_TRANS_RESERVE) |\r\n(tp->t_flags & XFS_TRANS_FREEZE_PROT);\r\ntp->t_flags &= ~XFS_TRANS_FREEZE_PROT;\r\nntp->t_ticket = xfs_log_ticket_get(tp->t_ticket);\r\nntp->t_blk_res = tp->t_blk_res - tp->t_blk_res_used;\r\ntp->t_blk_res = tp->t_blk_res_used;\r\nntp->t_rtx_res = tp->t_rtx_res - tp->t_rtx_res_used;\r\ntp->t_rtx_res = tp->t_rtx_res_used;\r\nntp->t_pflags = tp->t_pflags;\r\nxfs_trans_dup_dqinfo(tp, ntp);\r\natomic_inc(&tp->t_mountp->m_active_trans);\r\nreturn ntp;\r\n}\r\nint\r\nxfs_trans_reserve(\r\nxfs_trans_t *tp,\r\nuint blocks,\r\nuint logspace,\r\nuint rtextents,\r\nuint flags,\r\nuint logcount)\r\n{\r\nint error = 0;\r\nint rsvd = (tp->t_flags & XFS_TRANS_RESERVE) != 0;\r\ncurrent_set_flags_nested(&tp->t_pflags, PF_FSTRANS);\r\nif (blocks > 0) {\r\nerror = xfs_icsb_modify_counters(tp->t_mountp, XFS_SBS_FDBLOCKS,\r\n-((int64_t)blocks), rsvd);\r\nif (error != 0) {\r\ncurrent_restore_flags_nested(&tp->t_pflags, PF_FSTRANS);\r\nreturn (XFS_ERROR(ENOSPC));\r\n}\r\ntp->t_blk_res += blocks;\r\n}\r\nif (logspace > 0) {\r\nbool permanent = false;\r\nASSERT(tp->t_log_res == 0 || tp->t_log_res == logspace);\r\nASSERT(tp->t_log_count == 0 || tp->t_log_count == logcount);\r\nif (flags & XFS_TRANS_PERM_LOG_RES) {\r\ntp->t_flags |= XFS_TRANS_PERM_LOG_RES;\r\npermanent = true;\r\n} else {\r\nASSERT(tp->t_ticket == NULL);\r\nASSERT(!(tp->t_flags & XFS_TRANS_PERM_LOG_RES));\r\n}\r\nif (tp->t_ticket != NULL) {\r\nASSERT(flags & XFS_TRANS_PERM_LOG_RES);\r\nerror = xfs_log_regrant(tp->t_mountp, tp->t_ticket);\r\n} else {\r\nerror = xfs_log_reserve(tp->t_mountp, logspace,\r\nlogcount, &tp->t_ticket,\r\nXFS_TRANSACTION, permanent,\r\ntp->t_type);\r\n}\r\nif (error)\r\ngoto undo_blocks;\r\ntp->t_log_res = logspace;\r\ntp->t_log_count = logcount;\r\n}\r\nif (rtextents > 0) {\r\nerror = xfs_mod_incore_sb(tp->t_mountp, XFS_SBS_FREXTENTS,\r\n-((int64_t)rtextents), rsvd);\r\nif (error) {\r\nerror = XFS_ERROR(ENOSPC);\r\ngoto undo_log;\r\n}\r\ntp->t_rtx_res += rtextents;\r\n}\r\nreturn 0;\r\nundo_log:\r\nif (logspace > 0) {\r\nint log_flags;\r\nif (flags & XFS_TRANS_PERM_LOG_RES) {\r\nlog_flags = XFS_LOG_REL_PERM_RESERV;\r\n} else {\r\nlog_flags = 0;\r\n}\r\nxfs_log_done(tp->t_mountp, tp->t_ticket, NULL, log_flags);\r\ntp->t_ticket = NULL;\r\ntp->t_log_res = 0;\r\ntp->t_flags &= ~XFS_TRANS_PERM_LOG_RES;\r\n}\r\nundo_blocks:\r\nif (blocks > 0) {\r\nxfs_icsb_modify_counters(tp->t_mountp, XFS_SBS_FDBLOCKS,\r\n(int64_t)blocks, rsvd);\r\ntp->t_blk_res = 0;\r\n}\r\ncurrent_restore_flags_nested(&tp->t_pflags, PF_FSTRANS);\r\nreturn error;\r\n}\r\nvoid\r\nxfs_trans_mod_sb(\r\nxfs_trans_t *tp,\r\nuint field,\r\nint64_t delta)\r\n{\r\nuint32_t flags = (XFS_TRANS_DIRTY|XFS_TRANS_SB_DIRTY);\r\nxfs_mount_t *mp = tp->t_mountp;\r\nswitch (field) {\r\ncase XFS_TRANS_SB_ICOUNT:\r\ntp->t_icount_delta += delta;\r\nif (xfs_sb_version_haslazysbcount(&mp->m_sb))\r\nflags &= ~XFS_TRANS_SB_DIRTY;\r\nbreak;\r\ncase XFS_TRANS_SB_IFREE:\r\ntp->t_ifree_delta += delta;\r\nif (xfs_sb_version_haslazysbcount(&mp->m_sb))\r\nflags &= ~XFS_TRANS_SB_DIRTY;\r\nbreak;\r\ncase XFS_TRANS_SB_FDBLOCKS:\r\nif (delta < 0) {\r\ntp->t_blk_res_used += (uint)-delta;\r\nASSERT(tp->t_blk_res_used <= tp->t_blk_res);\r\n}\r\ntp->t_fdblocks_delta += delta;\r\nif (xfs_sb_version_haslazysbcount(&mp->m_sb))\r\nflags &= ~XFS_TRANS_SB_DIRTY;\r\nbreak;\r\ncase XFS_TRANS_SB_RES_FDBLOCKS:\r\nASSERT(delta < 0);\r\ntp->t_res_fdblocks_delta += delta;\r\nif (xfs_sb_version_haslazysbcount(&mp->m_sb))\r\nflags &= ~XFS_TRANS_SB_DIRTY;\r\nbreak;\r\ncase XFS_TRANS_SB_FREXTENTS:\r\nif (delta < 0) {\r\ntp->t_rtx_res_used += (uint)-delta;\r\nASSERT(tp->t_rtx_res_used <= tp->t_rtx_res);\r\n}\r\ntp->t_frextents_delta += delta;\r\nbreak;\r\ncase XFS_TRANS_SB_RES_FREXTENTS:\r\nASSERT(delta < 0);\r\ntp->t_res_frextents_delta += delta;\r\nbreak;\r\ncase XFS_TRANS_SB_DBLOCKS:\r\nASSERT(delta > 0);\r\ntp->t_dblocks_delta += delta;\r\nbreak;\r\ncase XFS_TRANS_SB_AGCOUNT:\r\nASSERT(delta > 0);\r\ntp->t_agcount_delta += delta;\r\nbreak;\r\ncase XFS_TRANS_SB_IMAXPCT:\r\ntp->t_imaxpct_delta += delta;\r\nbreak;\r\ncase XFS_TRANS_SB_REXTSIZE:\r\ntp->t_rextsize_delta += delta;\r\nbreak;\r\ncase XFS_TRANS_SB_RBMBLOCKS:\r\ntp->t_rbmblocks_delta += delta;\r\nbreak;\r\ncase XFS_TRANS_SB_RBLOCKS:\r\ntp->t_rblocks_delta += delta;\r\nbreak;\r\ncase XFS_TRANS_SB_REXTENTS:\r\ntp->t_rextents_delta += delta;\r\nbreak;\r\ncase XFS_TRANS_SB_REXTSLOG:\r\ntp->t_rextslog_delta += delta;\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\nreturn;\r\n}\r\ntp->t_flags |= flags;\r\n}\r\nSTATIC void\r\nxfs_trans_apply_sb_deltas(\r\nxfs_trans_t *tp)\r\n{\r\nxfs_dsb_t *sbp;\r\nxfs_buf_t *bp;\r\nint whole = 0;\r\nbp = xfs_trans_getsb(tp, tp->t_mountp, 0);\r\nsbp = XFS_BUF_TO_SBP(bp);\r\nASSERT((tp->t_fdblocks_delta + tp->t_res_fdblocks_delta) ==\r\n(tp->t_ag_freeblks_delta + tp->t_ag_flist_delta +\r\ntp->t_ag_btree_delta));\r\nif (!xfs_sb_version_haslazysbcount(&(tp->t_mountp->m_sb))) {\r\nif (tp->t_icount_delta)\r\nbe64_add_cpu(&sbp->sb_icount, tp->t_icount_delta);\r\nif (tp->t_ifree_delta)\r\nbe64_add_cpu(&sbp->sb_ifree, tp->t_ifree_delta);\r\nif (tp->t_fdblocks_delta)\r\nbe64_add_cpu(&sbp->sb_fdblocks, tp->t_fdblocks_delta);\r\nif (tp->t_res_fdblocks_delta)\r\nbe64_add_cpu(&sbp->sb_fdblocks, tp->t_res_fdblocks_delta);\r\n}\r\nif (tp->t_frextents_delta)\r\nbe64_add_cpu(&sbp->sb_frextents, tp->t_frextents_delta);\r\nif (tp->t_res_frextents_delta)\r\nbe64_add_cpu(&sbp->sb_frextents, tp->t_res_frextents_delta);\r\nif (tp->t_dblocks_delta) {\r\nbe64_add_cpu(&sbp->sb_dblocks, tp->t_dblocks_delta);\r\nwhole = 1;\r\n}\r\nif (tp->t_agcount_delta) {\r\nbe32_add_cpu(&sbp->sb_agcount, tp->t_agcount_delta);\r\nwhole = 1;\r\n}\r\nif (tp->t_imaxpct_delta) {\r\nsbp->sb_imax_pct += tp->t_imaxpct_delta;\r\nwhole = 1;\r\n}\r\nif (tp->t_rextsize_delta) {\r\nbe32_add_cpu(&sbp->sb_rextsize, tp->t_rextsize_delta);\r\nwhole = 1;\r\n}\r\nif (tp->t_rbmblocks_delta) {\r\nbe32_add_cpu(&sbp->sb_rbmblocks, tp->t_rbmblocks_delta);\r\nwhole = 1;\r\n}\r\nif (tp->t_rblocks_delta) {\r\nbe64_add_cpu(&sbp->sb_rblocks, tp->t_rblocks_delta);\r\nwhole = 1;\r\n}\r\nif (tp->t_rextents_delta) {\r\nbe64_add_cpu(&sbp->sb_rextents, tp->t_rextents_delta);\r\nwhole = 1;\r\n}\r\nif (tp->t_rextslog_delta) {\r\nsbp->sb_rextslog += tp->t_rextslog_delta;\r\nwhole = 1;\r\n}\r\nif (whole)\r\nxfs_trans_log_buf(tp, bp, 0, sizeof(xfs_dsb_t) - 1);\r\nelse\r\nxfs_trans_log_buf(tp, bp, offsetof(xfs_dsb_t, sb_icount),\r\noffsetof(xfs_dsb_t, sb_frextents) +\r\nsizeof(sbp->sb_frextents) - 1);\r\n}\r\nvoid\r\nxfs_trans_unreserve_and_mod_sb(\r\nxfs_trans_t *tp)\r\n{\r\nxfs_mod_sb_t msb[9];\r\nxfs_mod_sb_t *msbp;\r\nxfs_mount_t *mp = tp->t_mountp;\r\nint error;\r\nint rsvd;\r\nint64_t blkdelta = 0;\r\nint64_t rtxdelta = 0;\r\nint64_t idelta = 0;\r\nint64_t ifreedelta = 0;\r\nmsbp = msb;\r\nrsvd = (tp->t_flags & XFS_TRANS_RESERVE) != 0;\r\nif (tp->t_blk_res > 0)\r\nblkdelta = tp->t_blk_res;\r\nif ((tp->t_fdblocks_delta != 0) &&\r\n(xfs_sb_version_haslazysbcount(&mp->m_sb) ||\r\n(tp->t_flags & XFS_TRANS_SB_DIRTY)))\r\nblkdelta += tp->t_fdblocks_delta;\r\nif (tp->t_rtx_res > 0)\r\nrtxdelta = tp->t_rtx_res;\r\nif ((tp->t_frextents_delta != 0) &&\r\n(tp->t_flags & XFS_TRANS_SB_DIRTY))\r\nrtxdelta += tp->t_frextents_delta;\r\nif (xfs_sb_version_haslazysbcount(&mp->m_sb) ||\r\n(tp->t_flags & XFS_TRANS_SB_DIRTY)) {\r\nidelta = tp->t_icount_delta;\r\nifreedelta = tp->t_ifree_delta;\r\n}\r\nif (blkdelta) {\r\nerror = xfs_icsb_modify_counters(mp, XFS_SBS_FDBLOCKS,\r\nblkdelta, rsvd);\r\nif (error)\r\ngoto out;\r\n}\r\nif (idelta) {\r\nerror = xfs_icsb_modify_counters(mp, XFS_SBS_ICOUNT,\r\nidelta, rsvd);\r\nif (error)\r\ngoto out_undo_fdblocks;\r\n}\r\nif (ifreedelta) {\r\nerror = xfs_icsb_modify_counters(mp, XFS_SBS_IFREE,\r\nifreedelta, rsvd);\r\nif (error)\r\ngoto out_undo_icount;\r\n}\r\nif (rtxdelta != 0) {\r\nmsbp->msb_field = XFS_SBS_FREXTENTS;\r\nmsbp->msb_delta = rtxdelta;\r\nmsbp++;\r\n}\r\nif (tp->t_flags & XFS_TRANS_SB_DIRTY) {\r\nif (tp->t_dblocks_delta != 0) {\r\nmsbp->msb_field = XFS_SBS_DBLOCKS;\r\nmsbp->msb_delta = tp->t_dblocks_delta;\r\nmsbp++;\r\n}\r\nif (tp->t_agcount_delta != 0) {\r\nmsbp->msb_field = XFS_SBS_AGCOUNT;\r\nmsbp->msb_delta = tp->t_agcount_delta;\r\nmsbp++;\r\n}\r\nif (tp->t_imaxpct_delta != 0) {\r\nmsbp->msb_field = XFS_SBS_IMAX_PCT;\r\nmsbp->msb_delta = tp->t_imaxpct_delta;\r\nmsbp++;\r\n}\r\nif (tp->t_rextsize_delta != 0) {\r\nmsbp->msb_field = XFS_SBS_REXTSIZE;\r\nmsbp->msb_delta = tp->t_rextsize_delta;\r\nmsbp++;\r\n}\r\nif (tp->t_rbmblocks_delta != 0) {\r\nmsbp->msb_field = XFS_SBS_RBMBLOCKS;\r\nmsbp->msb_delta = tp->t_rbmblocks_delta;\r\nmsbp++;\r\n}\r\nif (tp->t_rblocks_delta != 0) {\r\nmsbp->msb_field = XFS_SBS_RBLOCKS;\r\nmsbp->msb_delta = tp->t_rblocks_delta;\r\nmsbp++;\r\n}\r\nif (tp->t_rextents_delta != 0) {\r\nmsbp->msb_field = XFS_SBS_REXTENTS;\r\nmsbp->msb_delta = tp->t_rextents_delta;\r\nmsbp++;\r\n}\r\nif (tp->t_rextslog_delta != 0) {\r\nmsbp->msb_field = XFS_SBS_REXTSLOG;\r\nmsbp->msb_delta = tp->t_rextslog_delta;\r\nmsbp++;\r\n}\r\n}\r\nif (msbp > msb) {\r\nerror = xfs_mod_incore_sb_batch(tp->t_mountp, msb,\r\n(uint)(msbp - msb), rsvd);\r\nif (error)\r\ngoto out_undo_ifreecount;\r\n}\r\nreturn;\r\nout_undo_ifreecount:\r\nif (ifreedelta)\r\nxfs_icsb_modify_counters(mp, XFS_SBS_IFREE, -ifreedelta, rsvd);\r\nout_undo_icount:\r\nif (idelta)\r\nxfs_icsb_modify_counters(mp, XFS_SBS_ICOUNT, -idelta, rsvd);\r\nout_undo_fdblocks:\r\nif (blkdelta)\r\nxfs_icsb_modify_counters(mp, XFS_SBS_FDBLOCKS, -blkdelta, rsvd);\r\nout:\r\nASSERT(error == 0);\r\nreturn;\r\n}\r\nvoid\r\nxfs_trans_add_item(\r\nstruct xfs_trans *tp,\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_log_item_desc *lidp;\r\nASSERT(lip->li_mountp == tp->t_mountp);\r\nASSERT(lip->li_ailp == tp->t_mountp->m_ail);\r\nlidp = kmem_zone_zalloc(xfs_log_item_desc_zone, KM_SLEEP | KM_NOFS);\r\nlidp->lid_item = lip;\r\nlidp->lid_flags = 0;\r\nlist_add_tail(&lidp->lid_trans, &tp->t_items);\r\nlip->li_desc = lidp;\r\n}\r\nSTATIC void\r\nxfs_trans_free_item_desc(\r\nstruct xfs_log_item_desc *lidp)\r\n{\r\nlist_del_init(&lidp->lid_trans);\r\nkmem_zone_free(xfs_log_item_desc_zone, lidp);\r\n}\r\nvoid\r\nxfs_trans_del_item(\r\nstruct xfs_log_item *lip)\r\n{\r\nxfs_trans_free_item_desc(lip->li_desc);\r\nlip->li_desc = NULL;\r\n}\r\nvoid\r\nxfs_trans_free_items(\r\nstruct xfs_trans *tp,\r\nxfs_lsn_t commit_lsn,\r\nint flags)\r\n{\r\nstruct xfs_log_item_desc *lidp, *next;\r\nlist_for_each_entry_safe(lidp, next, &tp->t_items, lid_trans) {\r\nstruct xfs_log_item *lip = lidp->lid_item;\r\nlip->li_desc = NULL;\r\nif (commit_lsn != NULLCOMMITLSN)\r\nIOP_COMMITTING(lip, commit_lsn);\r\nif (flags & XFS_TRANS_ABORT)\r\nlip->li_flags |= XFS_LI_ABORTED;\r\nIOP_UNLOCK(lip);\r\nxfs_trans_free_item_desc(lidp);\r\n}\r\n}\r\nstatic inline void\r\nxfs_log_item_batch_insert(\r\nstruct xfs_ail *ailp,\r\nstruct xfs_ail_cursor *cur,\r\nstruct xfs_log_item **log_items,\r\nint nr_items,\r\nxfs_lsn_t commit_lsn)\r\n{\r\nint i;\r\nspin_lock(&ailp->xa_lock);\r\nxfs_trans_ail_update_bulk(ailp, cur, log_items, nr_items, commit_lsn);\r\nfor (i = 0; i < nr_items; i++)\r\nIOP_UNPIN(log_items[i], 0);\r\n}\r\nvoid\r\nxfs_trans_committed_bulk(\r\nstruct xfs_ail *ailp,\r\nstruct xfs_log_vec *log_vector,\r\nxfs_lsn_t commit_lsn,\r\nint aborted)\r\n{\r\n#define LOG_ITEM_BATCH_SIZE 32\r\nstruct xfs_log_item *log_items[LOG_ITEM_BATCH_SIZE];\r\nstruct xfs_log_vec *lv;\r\nstruct xfs_ail_cursor cur;\r\nint i = 0;\r\nspin_lock(&ailp->xa_lock);\r\nxfs_trans_ail_cursor_last(ailp, &cur, commit_lsn);\r\nspin_unlock(&ailp->xa_lock);\r\nfor (lv = log_vector; lv; lv = lv->lv_next ) {\r\nstruct xfs_log_item *lip = lv->lv_item;\r\nxfs_lsn_t item_lsn;\r\nif (aborted)\r\nlip->li_flags |= XFS_LI_ABORTED;\r\nitem_lsn = IOP_COMMITTED(lip, commit_lsn);\r\nif (XFS_LSN_CMP(item_lsn, (xfs_lsn_t)-1) == 0)\r\ncontinue;\r\nif (aborted) {\r\nASSERT(XFS_FORCED_SHUTDOWN(ailp->xa_mount));\r\nIOP_UNPIN(lip, 1);\r\ncontinue;\r\n}\r\nif (item_lsn != commit_lsn) {\r\nspin_lock(&ailp->xa_lock);\r\nif (XFS_LSN_CMP(item_lsn, lip->li_lsn) > 0)\r\nxfs_trans_ail_update(ailp, lip, item_lsn);\r\nelse\r\nspin_unlock(&ailp->xa_lock);\r\nIOP_UNPIN(lip, 0);\r\ncontinue;\r\n}\r\nlog_items[i++] = lv->lv_item;\r\nif (i >= LOG_ITEM_BATCH_SIZE) {\r\nxfs_log_item_batch_insert(ailp, &cur, log_items,\r\nLOG_ITEM_BATCH_SIZE, commit_lsn);\r\ni = 0;\r\n}\r\n}\r\nif (i)\r\nxfs_log_item_batch_insert(ailp, &cur, log_items, i, commit_lsn);\r\nspin_lock(&ailp->xa_lock);\r\nxfs_trans_ail_cursor_done(ailp, &cur);\r\nspin_unlock(&ailp->xa_lock);\r\n}\r\nint\r\nxfs_trans_commit(\r\nstruct xfs_trans *tp,\r\nuint flags)\r\n{\r\nstruct xfs_mount *mp = tp->t_mountp;\r\nxfs_lsn_t commit_lsn = -1;\r\nint error = 0;\r\nint log_flags = 0;\r\nint sync = tp->t_flags & XFS_TRANS_SYNC;\r\nif (flags & XFS_TRANS_RELEASE_LOG_RES) {\r\nASSERT(tp->t_flags & XFS_TRANS_PERM_LOG_RES);\r\nlog_flags = XFS_LOG_REL_PERM_RESERV;\r\n}\r\nif (!(tp->t_flags & XFS_TRANS_DIRTY))\r\ngoto out_unreserve;\r\nif (XFS_FORCED_SHUTDOWN(mp)) {\r\nerror = XFS_ERROR(EIO);\r\ngoto out_unreserve;\r\n}\r\nASSERT(tp->t_ticket != NULL);\r\nif (tp->t_flags & XFS_TRANS_SB_DIRTY)\r\nxfs_trans_apply_sb_deltas(tp);\r\nxfs_trans_apply_dquot_deltas(tp);\r\nerror = xfs_log_commit_cil(mp, tp, &commit_lsn, flags);\r\nif (error == ENOMEM) {\r\nxfs_force_shutdown(mp, SHUTDOWN_LOG_IO_ERROR);\r\nerror = XFS_ERROR(EIO);\r\ngoto out_unreserve;\r\n}\r\ncurrent_restore_flags_nested(&tp->t_pflags, PF_FSTRANS);\r\nxfs_trans_free(tp);\r\nif (sync) {\r\nif (!error) {\r\nerror = _xfs_log_force_lsn(mp, commit_lsn,\r\nXFS_LOG_SYNC, NULL);\r\n}\r\nXFS_STATS_INC(xs_trans_sync);\r\n} else {\r\nXFS_STATS_INC(xs_trans_async);\r\n}\r\nreturn error;\r\nout_unreserve:\r\nxfs_trans_unreserve_and_mod_sb(tp);\r\nxfs_trans_unreserve_and_mod_dquots(tp);\r\nif (tp->t_ticket) {\r\ncommit_lsn = xfs_log_done(mp, tp->t_ticket, NULL, log_flags);\r\nif (commit_lsn == -1 && !error)\r\nerror = XFS_ERROR(EIO);\r\n}\r\ncurrent_restore_flags_nested(&tp->t_pflags, PF_FSTRANS);\r\nxfs_trans_free_items(tp, NULLCOMMITLSN, error ? XFS_TRANS_ABORT : 0);\r\nxfs_trans_free(tp);\r\nXFS_STATS_INC(xs_trans_empty);\r\nreturn error;\r\n}\r\nvoid\r\nxfs_trans_cancel(\r\nxfs_trans_t *tp,\r\nint flags)\r\n{\r\nint log_flags;\r\nxfs_mount_t *mp = tp->t_mountp;\r\nif ((flags & XFS_TRANS_ABORT) && !(tp->t_flags & XFS_TRANS_DIRTY))\r\nflags &= ~XFS_TRANS_ABORT;\r\nif ((tp->t_flags & XFS_TRANS_DIRTY) && !XFS_FORCED_SHUTDOWN(mp)) {\r\nXFS_ERROR_REPORT("xfs_trans_cancel", XFS_ERRLEVEL_LOW, mp);\r\nxfs_force_shutdown(mp, SHUTDOWN_CORRUPT_INCORE);\r\n}\r\n#ifdef DEBUG\r\nif (!(flags & XFS_TRANS_ABORT) && !XFS_FORCED_SHUTDOWN(mp)) {\r\nstruct xfs_log_item_desc *lidp;\r\nlist_for_each_entry(lidp, &tp->t_items, lid_trans)\r\nASSERT(!(lidp->lid_item->li_type == XFS_LI_EFD));\r\n}\r\n#endif\r\nxfs_trans_unreserve_and_mod_sb(tp);\r\nxfs_trans_unreserve_and_mod_dquots(tp);\r\nif (tp->t_ticket) {\r\nif (flags & XFS_TRANS_RELEASE_LOG_RES) {\r\nASSERT(tp->t_flags & XFS_TRANS_PERM_LOG_RES);\r\nlog_flags = XFS_LOG_REL_PERM_RESERV;\r\n} else {\r\nlog_flags = 0;\r\n}\r\nxfs_log_done(mp, tp->t_ticket, NULL, log_flags);\r\n}\r\ncurrent_restore_flags_nested(&tp->t_pflags, PF_FSTRANS);\r\nxfs_trans_free_items(tp, NULLCOMMITLSN, flags);\r\nxfs_trans_free(tp);\r\n}\r\nint\r\nxfs_trans_roll(\r\nstruct xfs_trans **tpp,\r\nstruct xfs_inode *dp)\r\n{\r\nstruct xfs_trans *trans;\r\nunsigned int logres, count;\r\nint error;\r\ntrans = *tpp;\r\nxfs_trans_log_inode(trans, dp, XFS_ILOG_CORE);\r\nlogres = trans->t_log_res;\r\ncount = trans->t_log_count;\r\n*tpp = xfs_trans_dup(trans);\r\nerror = xfs_trans_commit(trans, 0);\r\nif (error)\r\nreturn (error);\r\ntrans = *tpp;\r\nxfs_log_ticket_put(trans->t_ticket);\r\nerror = xfs_trans_reserve(trans, 0, logres, 0,\r\nXFS_TRANS_PERM_LOG_RES, count);\r\nif (error)\r\nreturn error;\r\nxfs_trans_ijoin(trans, dp, 0);\r\nreturn 0;\r\n}

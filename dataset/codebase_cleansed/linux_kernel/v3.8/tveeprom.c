static int hasRadioTuner(int tunerType)\r\n{\r\nswitch (tunerType) {\r\ncase 18:\r\ncase 23:\r\ncase 38:\r\ncase 16:\r\ncase 19:\r\ncase 21:\r\ncase 24:\r\ncase 17:\r\ncase 22:\r\ncase 20:\r\ncase 25:\r\ncase 33:\r\ncase 42:\r\ncase 52:\r\ncase 54:\r\ncase 44:\r\ncase 31:\r\ncase 30:\r\ncase 46:\r\ncase 47:\r\ncase 49:\r\ncase 60:\r\ncase 57:\r\ncase 59:\r\ncase 58:\r\ncase 68:\r\ncase 61:\r\ncase 78:\r\ncase 89:\r\ncase 92:\r\ncase 105:\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nvoid tveeprom_hauppauge_analog(struct i2c_client *c, struct tveeprom *tvee,\r\nunsigned char *eeprom_data)\r\n{\r\nint i, j, len, done, beenhere, tag, start;\r\nint tuner1 = 0, t_format1 = 0, audioic = -1;\r\nchar *t_name1 = NULL;\r\nconst char *t_fmt_name1[8] = { " none", "", "", "", "", "", "", "" };\r\nint tuner2 = 0, t_format2 = 0;\r\nchar *t_name2 = NULL;\r\nconst char *t_fmt_name2[8] = { " none", "", "", "", "", "", "", "" };\r\nmemset(tvee, 0, sizeof(*tvee));\r\ntvee->tuner_type = TUNER_ABSENT;\r\ntvee->tuner2_type = TUNER_ABSENT;\r\ndone = len = beenhere = 0;\r\nif (eeprom_data[0] == 0x1a &&\r\neeprom_data[1] == 0xeb &&\r\neeprom_data[2] == 0x67 &&\r\neeprom_data[3] == 0x95)\r\nstart = 0xa0;\r\nelse if ((eeprom_data[0] & 0xe1) == 0x01 &&\r\neeprom_data[1] == 0x00 &&\r\neeprom_data[2] == 0x00 &&\r\neeprom_data[8] == 0x84)\r\nstart = 8;\r\nelse if (eeprom_data[1] == 0x70 &&\r\neeprom_data[2] == 0x00 &&\r\neeprom_data[4] == 0x74 &&\r\neeprom_data[8] == 0x84)\r\nstart = 8;\r\nelse\r\nstart = 0;\r\nfor (i = start; !done && i < 256; i += len) {\r\nif (eeprom_data[i] == 0x84) {\r\nlen = eeprom_data[i + 1] + (eeprom_data[i + 2] << 8);\r\ni += 3;\r\n} else if ((eeprom_data[i] & 0xf0) == 0x70) {\r\nif (eeprom_data[i] & 0x08) {\r\ndone = 1;\r\nbreak;\r\n}\r\nlen = eeprom_data[i] & 0x07;\r\n++i;\r\n} else {\r\ntveeprom_warn("Encountered bad packet header [%02x]. "\r\n"Corrupt or not a Hauppauge eeprom.\n",\r\neeprom_data[i]);\r\nreturn;\r\n}\r\nif (debug) {\r\ntveeprom_info("Tag [%02x] + %d bytes:",\r\neeprom_data[i], len - 1);\r\nfor (j = 1; j < len; j++)\r\nprintk(KERN_CONT " %02x", eeprom_data[i + j]);\r\nprintk(KERN_CONT "\n");\r\n}\r\ntag = eeprom_data[i];\r\nswitch (tag) {\r\ncase 0x00:\r\ntuner1 = eeprom_data[i+6];\r\nt_format1 = eeprom_data[i+5];\r\ntvee->has_radio = eeprom_data[i+len-1];\r\ntvee->has_ir = 0;\r\ntvee->model =\r\neeprom_data[i+8] +\r\n(eeprom_data[i+9] << 8);\r\ntvee->revision = eeprom_data[i+10] +\r\n(eeprom_data[i+11] << 8) +\r\n(eeprom_data[i+12] << 16);\r\nbreak;\r\ncase 0x01:\r\ntvee->serial_number =\r\neeprom_data[i+6] +\r\n(eeprom_data[i+7] << 8) +\r\n(eeprom_data[i+8] << 16);\r\nbreak;\r\ncase 0x02:\r\naudioic = eeprom_data[i+2] & 0x7f;\r\nif (audioic < ARRAY_SIZE(audioIC))\r\ntvee->audio_processor = audioIC[audioic].id;\r\nelse\r\ntvee->audio_processor = V4L2_IDENT_UNKNOWN;\r\nbreak;\r\ncase 0x04:\r\ntvee->serial_number =\r\neeprom_data[i+5] +\r\n(eeprom_data[i+6] << 8) +\r\n(eeprom_data[i+7] << 16);\r\nif ((eeprom_data[i + 8] & 0xf0) &&\r\n(tvee->serial_number < 0xffffff)) {\r\ntvee->MAC_address[0] = 0x00;\r\ntvee->MAC_address[1] = 0x0D;\r\ntvee->MAC_address[2] = 0xFE;\r\ntvee->MAC_address[3] = eeprom_data[i + 7];\r\ntvee->MAC_address[4] = eeprom_data[i + 6];\r\ntvee->MAC_address[5] = eeprom_data[i + 5];\r\ntvee->has_MAC_address = 1;\r\n}\r\nbreak;\r\ncase 0x05:\r\naudioic = eeprom_data[i+1] & 0x7f;\r\nif (audioic < ARRAY_SIZE(audioIC))\r\ntvee->audio_processor = audioIC[audioic].id;\r\nelse\r\ntvee->audio_processor = V4L2_IDENT_UNKNOWN;\r\nbreak;\r\ncase 0x06:\r\ntvee->model =\r\neeprom_data[i + 1] +\r\n(eeprom_data[i + 2] << 8) +\r\n(eeprom_data[i + 3] << 16) +\r\n(eeprom_data[i + 4] << 24);\r\ntvee->revision =\r\neeprom_data[i + 5] +\r\n(eeprom_data[i + 6] << 8) +\r\n(eeprom_data[i + 7] << 16);\r\nbreak;\r\ncase 0x07:\r\nbreak;\r\ncase 0x09:\r\ntvee->decoder_processor = eeprom_data[i + 1];\r\nbreak;\r\ncase 0x0a:\r\nif (beenhere == 0) {\r\ntuner1 = eeprom_data[i + 2];\r\nt_format1 = eeprom_data[i + 1];\r\nbeenhere = 1;\r\n} else {\r\ntuner2 = eeprom_data[i + 2];\r\nt_format2 = eeprom_data[i + 1];\r\nif (t_format2 == 0)\r\ntvee->has_radio = 1;\r\n}\r\nbreak;\r\ncase 0x0b:\r\nbreak;\r\ncase 0x0e:\r\ntvee->has_radio = eeprom_data[i+1];\r\nbreak;\r\ncase 0x0f:\r\ntvee->has_ir = 1 | (eeprom_data[i+1] << 1);\r\nbreak;\r\ndefault:\r\ntveeprom_dbg("Not sure what to do with tag [%02x]\n",\r\ntag);\r\n}\r\n}\r\nif (!done) {\r\ntveeprom_warn("Ran out of data!\n");\r\nreturn;\r\n}\r\nif (tvee->revision != 0) {\r\ntvee->rev_str[0] = 32 + ((tvee->revision >> 18) & 0x3f);\r\ntvee->rev_str[1] = 32 + ((tvee->revision >> 12) & 0x3f);\r\ntvee->rev_str[2] = 32 + ((tvee->revision >> 6) & 0x3f);\r\ntvee->rev_str[3] = 32 + (tvee->revision & 0x3f);\r\ntvee->rev_str[4] = 0;\r\n}\r\nif (hasRadioTuner(tuner1) && !tvee->has_radio) {\r\ntveeprom_info("The eeprom says no radio is present, but the tuner type\n");\r\ntveeprom_info("indicates otherwise. I will assume that radio is present.\n");\r\ntvee->has_radio = 1;\r\n}\r\nif (tuner1 < ARRAY_SIZE(hauppauge_tuner)) {\r\ntvee->tuner_type = hauppauge_tuner[tuner1].id;\r\nt_name1 = hauppauge_tuner[tuner1].name;\r\n} else {\r\nt_name1 = "unknown";\r\n}\r\nif (tuner2 < ARRAY_SIZE(hauppauge_tuner)) {\r\ntvee->tuner2_type = hauppauge_tuner[tuner2].id;\r\nt_name2 = hauppauge_tuner[tuner2].name;\r\n} else {\r\nt_name2 = "unknown";\r\n}\r\ntvee->tuner_hauppauge_model = tuner1;\r\ntvee->tuner2_hauppauge_model = tuner2;\r\ntvee->tuner_formats = 0;\r\ntvee->tuner2_formats = 0;\r\nfor (i = j = 0; i < 8; i++) {\r\nif (t_format1 & (1 << i)) {\r\ntvee->tuner_formats |= hauppauge_tuner_fmt[i].id;\r\nt_fmt_name1[j++] = hauppauge_tuner_fmt[i].name;\r\n}\r\n}\r\nfor (i = j = 0; i < 8; i++) {\r\nif (t_format2 & (1 << i)) {\r\ntvee->tuner2_formats |= hauppauge_tuner_fmt[i].id;\r\nt_fmt_name2[j++] = hauppauge_tuner_fmt[i].name;\r\n}\r\n}\r\ntveeprom_info("Hauppauge model %d, rev %s, serial# %d\n",\r\ntvee->model, tvee->rev_str, tvee->serial_number);\r\nif (tvee->has_MAC_address == 1)\r\ntveeprom_info("MAC address is %pM\n", tvee->MAC_address);\r\ntveeprom_info("tuner model is %s (idx %d, type %d)\n",\r\nt_name1, tuner1, tvee->tuner_type);\r\ntveeprom_info("TV standards%s%s%s%s%s%s%s%s (eeprom 0x%02x)\n",\r\nt_fmt_name1[0], t_fmt_name1[1], t_fmt_name1[2],\r\nt_fmt_name1[3], t_fmt_name1[4], t_fmt_name1[5],\r\nt_fmt_name1[6], t_fmt_name1[7], t_format1);\r\nif (tuner2)\r\ntveeprom_info("second tuner model is %s (idx %d, type %d)\n",\r\nt_name2, tuner2, tvee->tuner2_type);\r\nif (t_format2)\r\ntveeprom_info("TV standards%s%s%s%s%s%s%s%s (eeprom 0x%02x)\n",\r\nt_fmt_name2[0], t_fmt_name2[1], t_fmt_name2[2],\r\nt_fmt_name2[3], t_fmt_name2[4], t_fmt_name2[5],\r\nt_fmt_name2[6], t_fmt_name2[7], t_format2);\r\nif (audioic < 0) {\r\ntveeprom_info("audio processor is unknown (no idx)\n");\r\ntvee->audio_processor = V4L2_IDENT_UNKNOWN;\r\n} else {\r\nif (audioic < ARRAY_SIZE(audioIC))\r\ntveeprom_info("audio processor is %s (idx %d)\n",\r\naudioIC[audioic].name, audioic);\r\nelse\r\ntveeprom_info("audio processor is unknown (idx %d)\n",\r\naudioic);\r\n}\r\nif (tvee->decoder_processor)\r\ntveeprom_info("decoder processor is %s (idx %d)\n",\r\nSTRM(decoderIC, tvee->decoder_processor),\r\ntvee->decoder_processor);\r\nif (tvee->has_ir)\r\ntveeprom_info("has %sradio, has %sIR receiver, has %sIR transmitter\n",\r\ntvee->has_radio ? "" : "no ",\r\n(tvee->has_ir & 2) ? "" : "no ",\r\n(tvee->has_ir & 4) ? "" : "no ");\r\nelse\r\ntveeprom_info("has %sradio\n",\r\ntvee->has_radio ? "" : "no ");\r\n}\r\nint tveeprom_read(struct i2c_client *c, unsigned char *eedata, int len)\r\n{\r\nunsigned char buf;\r\nint err;\r\nbuf = 0;\r\nerr = i2c_master_send(c, &buf, 1);\r\nif (err != 1) {\r\ntveeprom_info("Huh, no eeprom present (err=%d)?\n", err);\r\nreturn -1;\r\n}\r\nerr = i2c_master_recv(c, eedata, len);\r\nif (err != len) {\r\ntveeprom_warn("i2c eeprom read error (err=%d)\n", err);\r\nreturn -1;\r\n}\r\nif (debug) {\r\nint i;\r\ntveeprom_info("full 256-byte eeprom dump:\n");\r\nfor (i = 0; i < len; i++) {\r\nif (0 == (i % 16))\r\ntveeprom_info("%02x:", i);\r\nprintk(KERN_CONT " %02x", eedata[i]);\r\nif (15 == (i % 16))\r\nprintk(KERN_CONT "\n");\r\n}\r\n}\r\nreturn 0;\r\n}

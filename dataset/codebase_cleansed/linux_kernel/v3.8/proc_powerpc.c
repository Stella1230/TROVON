static loff_t page_map_seek( struct file *file, loff_t off, int whence)\r\n{\r\nloff_t new;\r\nstruct proc_dir_entry *dp = PDE(file->f_path.dentry->d_inode);\r\nswitch(whence) {\r\ncase 0:\r\nnew = off;\r\nbreak;\r\ncase 1:\r\nnew = file->f_pos + off;\r\nbreak;\r\ncase 2:\r\nnew = dp->size + off;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif ( new < 0 || new > dp->size )\r\nreturn -EINVAL;\r\nreturn (file->f_pos = new);\r\n}\r\nstatic ssize_t page_map_read( struct file *file, char __user *buf, size_t nbytes,\r\nloff_t *ppos)\r\n{\r\nstruct proc_dir_entry *dp = PDE(file->f_path.dentry->d_inode);\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, dp->data, dp->size);\r\n}\r\nstatic int page_map_mmap( struct file *file, struct vm_area_struct *vma )\r\n{\r\nstruct proc_dir_entry *dp = PDE(file->f_path.dentry->d_inode);\r\nif ((vma->vm_end - vma->vm_start) > dp->size)\r\nreturn -EINVAL;\r\nremap_pfn_range(vma, vma->vm_start, __pa(dp->data) >> PAGE_SHIFT,\r\ndp->size, vma->vm_page_prot);\r\nreturn 0;\r\n}\r\nstatic int __init proc_ppc64_init(void)\r\n{\r\nstruct proc_dir_entry *pde;\r\npde = proc_create_data("powerpc/systemcfg", S_IFREG|S_IRUGO, NULL,\r\n&page_map_fops, vdso_data);\r\nif (!pde)\r\nreturn 1;\r\npde->size = PAGE_SIZE;\r\nreturn 0;\r\n}\r\nstatic int __init proc_ppc64_create(void)\r\n{\r\nstruct proc_dir_entry *root;\r\nroot = proc_mkdir("powerpc", NULL);\r\nif (!root)\r\nreturn 1;\r\n#ifdef CONFIG_PPC64\r\nif (!proc_symlink("ppc64", NULL, "powerpc"))\r\npr_err("Failed to create link /proc/ppc64 -> /proc/powerpc\n");\r\n#endif\r\nif (!of_find_node_by_path("/rtas"))\r\nreturn 0;\r\nif (!proc_mkdir("rtas", root))\r\nreturn 1;\r\nif (!proc_symlink("rtas", NULL, "powerpc/rtas"))\r\nreturn 1;\r\nreturn 0;\r\n}

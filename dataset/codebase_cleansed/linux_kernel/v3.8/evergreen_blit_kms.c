static void\r\nset_render_target(struct radeon_device *rdev, int format,\r\nint w, int h, u64 gpu_addr)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nu32 cb_color_info;\r\nint pitch, slice;\r\nh = ALIGN(h, 8);\r\nif (h < 8)\r\nh = 8;\r\ncb_color_info = CB_FORMAT(format) |\r\nCB_SOURCE_FORMAT(CB_SF_EXPORT_NORM) |\r\nCB_ARRAY_MODE(ARRAY_1D_TILED_THIN1);\r\npitch = (w / 8) - 1;\r\nslice = ((w * h) / 64) - 1;\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 15));\r\nradeon_ring_write(ring, (CB_COLOR0_BASE - PACKET3_SET_CONTEXT_REG_START) >> 2);\r\nradeon_ring_write(ring, gpu_addr >> 8);\r\nradeon_ring_write(ring, pitch);\r\nradeon_ring_write(ring, slice);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, cb_color_info);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, (w - 1) | ((h - 1) << 16));\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, 0);\r\n}\r\nstatic void\r\ncp_set_surface_sync(struct radeon_device *rdev,\r\nu32 sync_type, u32 size,\r\nu64 mc_addr)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nu32 cp_coher_size;\r\nif (size == 0xffffffff)\r\ncp_coher_size = 0xffffffff;\r\nelse\r\ncp_coher_size = ((size + 255) >> 8);\r\nif (rdev->family >= CHIP_CAYMAN) {\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONFIG_REG, 1));\r\nradeon_ring_write(ring, (0x85e8 - PACKET3_SET_CONFIG_REG_START) >> 2);\r\nradeon_ring_write(ring, 0);\r\n}\r\nradeon_ring_write(ring, PACKET3(PACKET3_SURFACE_SYNC, 3));\r\nradeon_ring_write(ring, sync_type);\r\nradeon_ring_write(ring, cp_coher_size);\r\nradeon_ring_write(ring, mc_addr >> 8);\r\nradeon_ring_write(ring, 10);\r\n}\r\nstatic void\r\nset_shaders(struct radeon_device *rdev)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nu64 gpu_addr;\r\ngpu_addr = rdev->r600_blit.shader_gpu_addr + rdev->r600_blit.vs_offset;\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 3));\r\nradeon_ring_write(ring, (SQ_PGM_START_VS - PACKET3_SET_CONTEXT_REG_START) >> 2);\r\nradeon_ring_write(ring, gpu_addr >> 8);\r\nradeon_ring_write(ring, 2);\r\nradeon_ring_write(ring, 0);\r\ngpu_addr = rdev->r600_blit.shader_gpu_addr + rdev->r600_blit.ps_offset;\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 4));\r\nradeon_ring_write(ring, (SQ_PGM_START_PS - PACKET3_SET_CONTEXT_REG_START) >> 2);\r\nradeon_ring_write(ring, gpu_addr >> 8);\r\nradeon_ring_write(ring, 1);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, 2);\r\ngpu_addr = rdev->r600_blit.shader_gpu_addr + rdev->r600_blit.vs_offset;\r\ncp_set_surface_sync(rdev, PACKET3_SH_ACTION_ENA, 512, gpu_addr);\r\n}\r\nstatic void\r\nset_vtx_resource(struct radeon_device *rdev, u64 gpu_addr)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nu32 sq_vtx_constant_word2, sq_vtx_constant_word3;\r\nsq_vtx_constant_word2 = SQ_VTXC_BASE_ADDR_HI(upper_32_bits(gpu_addr) & 0xff) |\r\nSQ_VTXC_STRIDE(16);\r\n#ifdef __BIG_ENDIAN\r\nsq_vtx_constant_word2 |= SQ_VTXC_ENDIAN_SWAP(SQ_ENDIAN_8IN32);\r\n#endif\r\nsq_vtx_constant_word3 = SQ_VTCX_SEL_X(SQ_SEL_X) |\r\nSQ_VTCX_SEL_Y(SQ_SEL_Y) |\r\nSQ_VTCX_SEL_Z(SQ_SEL_Z) |\r\nSQ_VTCX_SEL_W(SQ_SEL_W);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_RESOURCE, 8));\r\nradeon_ring_write(ring, 0x580);\r\nradeon_ring_write(ring, gpu_addr & 0xffffffff);\r\nradeon_ring_write(ring, 48 - 1);\r\nradeon_ring_write(ring, sq_vtx_constant_word2);\r\nradeon_ring_write(ring, sq_vtx_constant_word3);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, S__SQ_CONSTANT_TYPE(SQ_TEX_VTX_VALID_BUFFER));\r\nif ((rdev->family == CHIP_CEDAR) ||\r\n(rdev->family == CHIP_PALM) ||\r\n(rdev->family == CHIP_SUMO) ||\r\n(rdev->family == CHIP_SUMO2) ||\r\n(rdev->family == CHIP_CAICOS))\r\ncp_set_surface_sync(rdev,\r\nPACKET3_TC_ACTION_ENA, 48, gpu_addr);\r\nelse\r\ncp_set_surface_sync(rdev,\r\nPACKET3_VC_ACTION_ENA, 48, gpu_addr);\r\n}\r\nstatic void\r\nset_tex_resource(struct radeon_device *rdev,\r\nint format, int w, int h, int pitch,\r\nu64 gpu_addr, u32 size)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nu32 sq_tex_resource_word0, sq_tex_resource_word1;\r\nu32 sq_tex_resource_word4, sq_tex_resource_word7;\r\nif (h < 1)\r\nh = 1;\r\nsq_tex_resource_word0 = TEX_DIM(SQ_TEX_DIM_2D);\r\nsq_tex_resource_word0 |= ((((pitch >> 3) - 1) << 6) |\r\n((w - 1) << 18));\r\nsq_tex_resource_word1 = ((h - 1) << 0) |\r\nTEX_ARRAY_MODE(ARRAY_1D_TILED_THIN1);\r\nsq_tex_resource_word4 = TEX_DST_SEL_X(SQ_SEL_X) |\r\nTEX_DST_SEL_Y(SQ_SEL_Y) |\r\nTEX_DST_SEL_Z(SQ_SEL_Z) |\r\nTEX_DST_SEL_W(SQ_SEL_W);\r\nsq_tex_resource_word7 = format |\r\nS__SQ_CONSTANT_TYPE(SQ_TEX_VTX_VALID_TEXTURE);\r\ncp_set_surface_sync(rdev,\r\nPACKET3_TC_ACTION_ENA, size, gpu_addr);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_RESOURCE, 8));\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, sq_tex_resource_word0);\r\nradeon_ring_write(ring, sq_tex_resource_word1);\r\nradeon_ring_write(ring, gpu_addr >> 8);\r\nradeon_ring_write(ring, gpu_addr >> 8);\r\nradeon_ring_write(ring, sq_tex_resource_word4);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, sq_tex_resource_word7);\r\n}\r\nstatic void\r\nset_scissors(struct radeon_device *rdev, int x1, int y1,\r\nint x2, int y2)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nif (x2 == 0)\r\nx1 = 1;\r\nif (y2 == 0)\r\ny1 = 1;\r\nif (rdev->family >= CHIP_CAYMAN) {\r\nif ((x2 == 1) && (y2 == 1))\r\nx2 = 2;\r\n}\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 2));\r\nradeon_ring_write(ring, (PA_SC_SCREEN_SCISSOR_TL - PACKET3_SET_CONTEXT_REG_START) >> 2);\r\nradeon_ring_write(ring, (x1 << 0) | (y1 << 16));\r\nradeon_ring_write(ring, (x2 << 0) | (y2 << 16));\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 2));\r\nradeon_ring_write(ring, (PA_SC_GENERIC_SCISSOR_TL - PACKET3_SET_CONTEXT_REG_START) >> 2);\r\nradeon_ring_write(ring, (x1 << 0) | (y1 << 16) | (1 << 31));\r\nradeon_ring_write(ring, (x2 << 0) | (y2 << 16));\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONTEXT_REG, 2));\r\nradeon_ring_write(ring, (PA_SC_WINDOW_SCISSOR_TL - PACKET3_SET_CONTEXT_REG_START) >> 2);\r\nradeon_ring_write(ring, (x1 << 0) | (y1 << 16) | (1 << 31));\r\nradeon_ring_write(ring, (x2 << 0) | (y2 << 16));\r\n}\r\nstatic void\r\ndraw_auto(struct radeon_device *rdev)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONFIG_REG, 1));\r\nradeon_ring_write(ring, (VGT_PRIMITIVE_TYPE - PACKET3_SET_CONFIG_REG_START) >> 2);\r\nradeon_ring_write(ring, DI_PT_RECTLIST);\r\nradeon_ring_write(ring, PACKET3(PACKET3_INDEX_TYPE, 0));\r\nradeon_ring_write(ring,\r\n#ifdef __BIG_ENDIAN\r\n(2 << 2) |\r\n#endif\r\nDI_INDEX_SIZE_16_BIT);\r\nradeon_ring_write(ring, PACKET3(PACKET3_NUM_INSTANCES, 0));\r\nradeon_ring_write(ring, 1);\r\nradeon_ring_write(ring, PACKET3(PACKET3_DRAW_INDEX_AUTO, 1));\r\nradeon_ring_write(ring, 3);\r\nradeon_ring_write(ring, DI_SRC_SEL_AUTO_INDEX);\r\n}\r\nstatic void\r\nset_default_state(struct radeon_device *rdev)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[RADEON_RING_TYPE_GFX_INDEX];\r\nu32 sq_config, sq_gpr_resource_mgmt_1, sq_gpr_resource_mgmt_2, sq_gpr_resource_mgmt_3;\r\nu32 sq_thread_resource_mgmt, sq_thread_resource_mgmt_2;\r\nu32 sq_stack_resource_mgmt_1, sq_stack_resource_mgmt_2, sq_stack_resource_mgmt_3;\r\nint num_ps_gprs, num_vs_gprs, num_temp_gprs;\r\nint num_gs_gprs, num_es_gprs, num_hs_gprs, num_ls_gprs;\r\nint num_ps_threads, num_vs_threads, num_gs_threads, num_es_threads;\r\nint num_hs_threads, num_ls_threads;\r\nint num_ps_stack_entries, num_vs_stack_entries, num_gs_stack_entries, num_es_stack_entries;\r\nint num_hs_stack_entries, num_ls_stack_entries;\r\nu64 gpu_addr;\r\nint dwords;\r\nradeon_ring_write(ring, PACKET3(PACKET3_CLEAR_STATE, 0));\r\nradeon_ring_write(ring, 0);\r\nif (rdev->family < CHIP_CAYMAN) {\r\nswitch (rdev->family) {\r\ncase CHIP_CEDAR:\r\ndefault:\r\nnum_ps_gprs = 93;\r\nnum_vs_gprs = 46;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 31;\r\nnum_es_gprs = 31;\r\nnum_hs_gprs = 23;\r\nnum_ls_gprs = 23;\r\nnum_ps_threads = 96;\r\nnum_vs_threads = 16;\r\nnum_gs_threads = 16;\r\nnum_es_threads = 16;\r\nnum_hs_threads = 16;\r\nnum_ls_threads = 16;\r\nnum_ps_stack_entries = 42;\r\nnum_vs_stack_entries = 42;\r\nnum_gs_stack_entries = 42;\r\nnum_es_stack_entries = 42;\r\nnum_hs_stack_entries = 42;\r\nnum_ls_stack_entries = 42;\r\nbreak;\r\ncase CHIP_REDWOOD:\r\nnum_ps_gprs = 93;\r\nnum_vs_gprs = 46;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 31;\r\nnum_es_gprs = 31;\r\nnum_hs_gprs = 23;\r\nnum_ls_gprs = 23;\r\nnum_ps_threads = 128;\r\nnum_vs_threads = 20;\r\nnum_gs_threads = 20;\r\nnum_es_threads = 20;\r\nnum_hs_threads = 20;\r\nnum_ls_threads = 20;\r\nnum_ps_stack_entries = 42;\r\nnum_vs_stack_entries = 42;\r\nnum_gs_stack_entries = 42;\r\nnum_es_stack_entries = 42;\r\nnum_hs_stack_entries = 42;\r\nnum_ls_stack_entries = 42;\r\nbreak;\r\ncase CHIP_JUNIPER:\r\nnum_ps_gprs = 93;\r\nnum_vs_gprs = 46;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 31;\r\nnum_es_gprs = 31;\r\nnum_hs_gprs = 23;\r\nnum_ls_gprs = 23;\r\nnum_ps_threads = 128;\r\nnum_vs_threads = 20;\r\nnum_gs_threads = 20;\r\nnum_es_threads = 20;\r\nnum_hs_threads = 20;\r\nnum_ls_threads = 20;\r\nnum_ps_stack_entries = 85;\r\nnum_vs_stack_entries = 85;\r\nnum_gs_stack_entries = 85;\r\nnum_es_stack_entries = 85;\r\nnum_hs_stack_entries = 85;\r\nnum_ls_stack_entries = 85;\r\nbreak;\r\ncase CHIP_CYPRESS:\r\ncase CHIP_HEMLOCK:\r\nnum_ps_gprs = 93;\r\nnum_vs_gprs = 46;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 31;\r\nnum_es_gprs = 31;\r\nnum_hs_gprs = 23;\r\nnum_ls_gprs = 23;\r\nnum_ps_threads = 128;\r\nnum_vs_threads = 20;\r\nnum_gs_threads = 20;\r\nnum_es_threads = 20;\r\nnum_hs_threads = 20;\r\nnum_ls_threads = 20;\r\nnum_ps_stack_entries = 85;\r\nnum_vs_stack_entries = 85;\r\nnum_gs_stack_entries = 85;\r\nnum_es_stack_entries = 85;\r\nnum_hs_stack_entries = 85;\r\nnum_ls_stack_entries = 85;\r\nbreak;\r\ncase CHIP_PALM:\r\nnum_ps_gprs = 93;\r\nnum_vs_gprs = 46;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 31;\r\nnum_es_gprs = 31;\r\nnum_hs_gprs = 23;\r\nnum_ls_gprs = 23;\r\nnum_ps_threads = 96;\r\nnum_vs_threads = 16;\r\nnum_gs_threads = 16;\r\nnum_es_threads = 16;\r\nnum_hs_threads = 16;\r\nnum_ls_threads = 16;\r\nnum_ps_stack_entries = 42;\r\nnum_vs_stack_entries = 42;\r\nnum_gs_stack_entries = 42;\r\nnum_es_stack_entries = 42;\r\nnum_hs_stack_entries = 42;\r\nnum_ls_stack_entries = 42;\r\nbreak;\r\ncase CHIP_SUMO:\r\nnum_ps_gprs = 93;\r\nnum_vs_gprs = 46;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 31;\r\nnum_es_gprs = 31;\r\nnum_hs_gprs = 23;\r\nnum_ls_gprs = 23;\r\nnum_ps_threads = 96;\r\nnum_vs_threads = 25;\r\nnum_gs_threads = 25;\r\nnum_es_threads = 25;\r\nnum_hs_threads = 25;\r\nnum_ls_threads = 25;\r\nnum_ps_stack_entries = 42;\r\nnum_vs_stack_entries = 42;\r\nnum_gs_stack_entries = 42;\r\nnum_es_stack_entries = 42;\r\nnum_hs_stack_entries = 42;\r\nnum_ls_stack_entries = 42;\r\nbreak;\r\ncase CHIP_SUMO2:\r\nnum_ps_gprs = 93;\r\nnum_vs_gprs = 46;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 31;\r\nnum_es_gprs = 31;\r\nnum_hs_gprs = 23;\r\nnum_ls_gprs = 23;\r\nnum_ps_threads = 96;\r\nnum_vs_threads = 25;\r\nnum_gs_threads = 25;\r\nnum_es_threads = 25;\r\nnum_hs_threads = 25;\r\nnum_ls_threads = 25;\r\nnum_ps_stack_entries = 85;\r\nnum_vs_stack_entries = 85;\r\nnum_gs_stack_entries = 85;\r\nnum_es_stack_entries = 85;\r\nnum_hs_stack_entries = 85;\r\nnum_ls_stack_entries = 85;\r\nbreak;\r\ncase CHIP_BARTS:\r\nnum_ps_gprs = 93;\r\nnum_vs_gprs = 46;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 31;\r\nnum_es_gprs = 31;\r\nnum_hs_gprs = 23;\r\nnum_ls_gprs = 23;\r\nnum_ps_threads = 128;\r\nnum_vs_threads = 20;\r\nnum_gs_threads = 20;\r\nnum_es_threads = 20;\r\nnum_hs_threads = 20;\r\nnum_ls_threads = 20;\r\nnum_ps_stack_entries = 85;\r\nnum_vs_stack_entries = 85;\r\nnum_gs_stack_entries = 85;\r\nnum_es_stack_entries = 85;\r\nnum_hs_stack_entries = 85;\r\nnum_ls_stack_entries = 85;\r\nbreak;\r\ncase CHIP_TURKS:\r\nnum_ps_gprs = 93;\r\nnum_vs_gprs = 46;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 31;\r\nnum_es_gprs = 31;\r\nnum_hs_gprs = 23;\r\nnum_ls_gprs = 23;\r\nnum_ps_threads = 128;\r\nnum_vs_threads = 20;\r\nnum_gs_threads = 20;\r\nnum_es_threads = 20;\r\nnum_hs_threads = 20;\r\nnum_ls_threads = 20;\r\nnum_ps_stack_entries = 42;\r\nnum_vs_stack_entries = 42;\r\nnum_gs_stack_entries = 42;\r\nnum_es_stack_entries = 42;\r\nnum_hs_stack_entries = 42;\r\nnum_ls_stack_entries = 42;\r\nbreak;\r\ncase CHIP_CAICOS:\r\nnum_ps_gprs = 93;\r\nnum_vs_gprs = 46;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 31;\r\nnum_es_gprs = 31;\r\nnum_hs_gprs = 23;\r\nnum_ls_gprs = 23;\r\nnum_ps_threads = 128;\r\nnum_vs_threads = 10;\r\nnum_gs_threads = 10;\r\nnum_es_threads = 10;\r\nnum_hs_threads = 10;\r\nnum_ls_threads = 10;\r\nnum_ps_stack_entries = 42;\r\nnum_vs_stack_entries = 42;\r\nnum_gs_stack_entries = 42;\r\nnum_es_stack_entries = 42;\r\nnum_hs_stack_entries = 42;\r\nnum_ls_stack_entries = 42;\r\nbreak;\r\n}\r\nif ((rdev->family == CHIP_CEDAR) ||\r\n(rdev->family == CHIP_PALM) ||\r\n(rdev->family == CHIP_SUMO) ||\r\n(rdev->family == CHIP_SUMO2) ||\r\n(rdev->family == CHIP_CAICOS))\r\nsq_config = 0;\r\nelse\r\nsq_config = VC_ENABLE;\r\nsq_config |= (EXPORT_SRC_C |\r\nCS_PRIO(0) |\r\nLS_PRIO(0) |\r\nHS_PRIO(0) |\r\nPS_PRIO(0) |\r\nVS_PRIO(1) |\r\nGS_PRIO(2) |\r\nES_PRIO(3));\r\nsq_gpr_resource_mgmt_1 = (NUM_PS_GPRS(num_ps_gprs) |\r\nNUM_VS_GPRS(num_vs_gprs) |\r\nNUM_CLAUSE_TEMP_GPRS(num_temp_gprs));\r\nsq_gpr_resource_mgmt_2 = (NUM_GS_GPRS(num_gs_gprs) |\r\nNUM_ES_GPRS(num_es_gprs));\r\nsq_gpr_resource_mgmt_3 = (NUM_HS_GPRS(num_hs_gprs) |\r\nNUM_LS_GPRS(num_ls_gprs));\r\nsq_thread_resource_mgmt = (NUM_PS_THREADS(num_ps_threads) |\r\nNUM_VS_THREADS(num_vs_threads) |\r\nNUM_GS_THREADS(num_gs_threads) |\r\nNUM_ES_THREADS(num_es_threads));\r\nsq_thread_resource_mgmt_2 = (NUM_HS_THREADS(num_hs_threads) |\r\nNUM_LS_THREADS(num_ls_threads));\r\nsq_stack_resource_mgmt_1 = (NUM_PS_STACK_ENTRIES(num_ps_stack_entries) |\r\nNUM_VS_STACK_ENTRIES(num_vs_stack_entries));\r\nsq_stack_resource_mgmt_2 = (NUM_GS_STACK_ENTRIES(num_gs_stack_entries) |\r\nNUM_ES_STACK_ENTRIES(num_es_stack_entries));\r\nsq_stack_resource_mgmt_3 = (NUM_HS_STACK_ENTRIES(num_hs_stack_entries) |\r\nNUM_LS_STACK_ENTRIES(num_ls_stack_entries));\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONFIG_REG, 1));\r\nradeon_ring_write(ring, (SQ_DYN_GPR_CNTL_PS_FLUSH_REQ - PACKET3_SET_CONFIG_REG_START) >> 2);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONFIG_REG, 1));\r\nradeon_ring_write(ring, (SQ_LDS_RESOURCE_MGMT - PACKET3_SET_CONFIG_REG_START) >> 2);\r\nradeon_ring_write(ring, 0x10001000);\r\nradeon_ring_write(ring, PACKET3(PACKET3_SET_CONFIG_REG, 11));\r\nradeon_ring_write(ring, (SQ_CONFIG - PACKET3_SET_CONFIG_REG_START) >> 2);\r\nradeon_ring_write(ring, sq_config);\r\nradeon_ring_write(ring, sq_gpr_resource_mgmt_1);\r\nradeon_ring_write(ring, sq_gpr_resource_mgmt_2);\r\nradeon_ring_write(ring, sq_gpr_resource_mgmt_3);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, sq_thread_resource_mgmt);\r\nradeon_ring_write(ring, sq_thread_resource_mgmt_2);\r\nradeon_ring_write(ring, sq_stack_resource_mgmt_1);\r\nradeon_ring_write(ring, sq_stack_resource_mgmt_2);\r\nradeon_ring_write(ring, sq_stack_resource_mgmt_3);\r\n}\r\nradeon_ring_write(ring, 0xc0012800);\r\nradeon_ring_write(ring, 0x80000000);\r\nradeon_ring_write(ring, 0x80000000);\r\nradeon_ring_write(ring, 0xc0026f00);\r\nradeon_ring_write(ring, 0x00000000);\r\nradeon_ring_write(ring, 0x00000000);\r\nradeon_ring_write(ring, 0x00000000);\r\nradeon_ring_write(ring, 0xc0036e00);\r\nradeon_ring_write(ring, 0x00000000);\r\nradeon_ring_write(ring, 0x00000012);\r\nradeon_ring_write(ring, 0x00000000);\r\nradeon_ring_write(ring, 0x00000000);\r\nradeon_ring_write(ring, PACKET3(PACKET3_MODE_CONTROL, 0));\r\nradeon_ring_write(ring, 1);\r\ndwords = ALIGN(rdev->r600_blit.state_len, 0x10);\r\ngpu_addr = rdev->r600_blit.shader_gpu_addr + rdev->r600_blit.state_offset;\r\nradeon_ring_write(ring, PACKET3(PACKET3_INDIRECT_BUFFER, 2));\r\nradeon_ring_write(ring, gpu_addr & 0xFFFFFFFC);\r\nradeon_ring_write(ring, upper_32_bits(gpu_addr) & 0xFF);\r\nradeon_ring_write(ring, dwords);\r\n}\r\nint evergreen_blit_init(struct radeon_device *rdev)\r\n{\r\nu32 obj_size;\r\nint i, r, dwords;\r\nvoid *ptr;\r\nu32 packet2s[16];\r\nint num_packet2s = 0;\r\nrdev->r600_blit.primitives.set_render_target = set_render_target;\r\nrdev->r600_blit.primitives.cp_set_surface_sync = cp_set_surface_sync;\r\nrdev->r600_blit.primitives.set_shaders = set_shaders;\r\nrdev->r600_blit.primitives.set_vtx_resource = set_vtx_resource;\r\nrdev->r600_blit.primitives.set_tex_resource = set_tex_resource;\r\nrdev->r600_blit.primitives.set_scissors = set_scissors;\r\nrdev->r600_blit.primitives.draw_auto = draw_auto;\r\nrdev->r600_blit.primitives.set_default_state = set_default_state;\r\nrdev->r600_blit.ring_size_common = 8;\r\nrdev->r600_blit.ring_size_common += 55;\r\nrdev->r600_blit.ring_size_common += 16;\r\nrdev->r600_blit.ring_size_common += 5;\r\nrdev->r600_blit.ring_size_common += 16;\r\nrdev->r600_blit.ring_size_per_loop = 74;\r\nif (rdev->family >= CHIP_CAYMAN)\r\nrdev->r600_blit.ring_size_per_loop += 9;\r\nrdev->r600_blit.max_dim = 16384;\r\nrdev->r600_blit.state_offset = 0;\r\nif (rdev->family < CHIP_CAYMAN)\r\nrdev->r600_blit.state_len = evergreen_default_size;\r\nelse\r\nrdev->r600_blit.state_len = cayman_default_size;\r\ndwords = rdev->r600_blit.state_len;\r\nwhile (dwords & 0xf) {\r\npacket2s[num_packet2s++] = cpu_to_le32(PACKET2(0));\r\ndwords++;\r\n}\r\nobj_size = dwords * 4;\r\nobj_size = ALIGN(obj_size, 256);\r\nrdev->r600_blit.vs_offset = obj_size;\r\nif (rdev->family < CHIP_CAYMAN)\r\nobj_size += evergreen_vs_size * 4;\r\nelse\r\nobj_size += cayman_vs_size * 4;\r\nobj_size = ALIGN(obj_size, 256);\r\nrdev->r600_blit.ps_offset = obj_size;\r\nif (rdev->family < CHIP_CAYMAN)\r\nobj_size += evergreen_ps_size * 4;\r\nelse\r\nobj_size += cayman_ps_size * 4;\r\nobj_size = ALIGN(obj_size, 256);\r\nif (!rdev->r600_blit.shader_obj) {\r\nr = radeon_bo_create(rdev, obj_size, PAGE_SIZE, true,\r\nRADEON_GEM_DOMAIN_VRAM,\r\nNULL, &rdev->r600_blit.shader_obj);\r\nif (r) {\r\nDRM_ERROR("evergreen failed to allocate shader\n");\r\nreturn r;\r\n}\r\nr = radeon_bo_reserve(rdev->r600_blit.shader_obj, false);\r\nif (unlikely(r != 0))\r\nreturn r;\r\nr = radeon_bo_pin(rdev->r600_blit.shader_obj, RADEON_GEM_DOMAIN_VRAM,\r\n&rdev->r600_blit.shader_gpu_addr);\r\nradeon_bo_unreserve(rdev->r600_blit.shader_obj);\r\nif (r) {\r\ndev_err(rdev->dev, "(%d) pin blit object failed\n", r);\r\nreturn r;\r\n}\r\n}\r\nDRM_DEBUG("evergreen blit allocated bo %08x vs %08x ps %08x\n",\r\nobj_size,\r\nrdev->r600_blit.vs_offset, rdev->r600_blit.ps_offset);\r\nr = radeon_bo_reserve(rdev->r600_blit.shader_obj, false);\r\nif (unlikely(r != 0))\r\nreturn r;\r\nr = radeon_bo_kmap(rdev->r600_blit.shader_obj, &ptr);\r\nif (r) {\r\nDRM_ERROR("failed to map blit object %d\n", r);\r\nreturn r;\r\n}\r\nif (rdev->family < CHIP_CAYMAN) {\r\nmemcpy_toio(ptr + rdev->r600_blit.state_offset,\r\nevergreen_default_state, rdev->r600_blit.state_len * 4);\r\nif (num_packet2s)\r\nmemcpy_toio(ptr + rdev->r600_blit.state_offset + (rdev->r600_blit.state_len * 4),\r\npacket2s, num_packet2s * 4);\r\nfor (i = 0; i < evergreen_vs_size; i++)\r\n*(u32 *)((unsigned long)ptr + rdev->r600_blit.vs_offset + i * 4) = cpu_to_le32(evergreen_vs[i]);\r\nfor (i = 0; i < evergreen_ps_size; i++)\r\n*(u32 *)((unsigned long)ptr + rdev->r600_blit.ps_offset + i * 4) = cpu_to_le32(evergreen_ps[i]);\r\n} else {\r\nmemcpy_toio(ptr + rdev->r600_blit.state_offset,\r\ncayman_default_state, rdev->r600_blit.state_len * 4);\r\nif (num_packet2s)\r\nmemcpy_toio(ptr + rdev->r600_blit.state_offset + (rdev->r600_blit.state_len * 4),\r\npacket2s, num_packet2s * 4);\r\nfor (i = 0; i < cayman_vs_size; i++)\r\n*(u32 *)((unsigned long)ptr + rdev->r600_blit.vs_offset + i * 4) = cpu_to_le32(cayman_vs[i]);\r\nfor (i = 0; i < cayman_ps_size; i++)\r\n*(u32 *)((unsigned long)ptr + rdev->r600_blit.ps_offset + i * 4) = cpu_to_le32(cayman_ps[i]);\r\n}\r\nradeon_bo_kunmap(rdev->r600_blit.shader_obj);\r\nradeon_bo_unreserve(rdev->r600_blit.shader_obj);\r\nradeon_ttm_set_active_vram_size(rdev, rdev->mc.real_vram_size);\r\nreturn 0;\r\n}

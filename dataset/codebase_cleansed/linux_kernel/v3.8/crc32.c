u32 __pure crc32_le(u32 crc, unsigned char const *p, size_t len)\r\n{\r\nreturn crc32_le_generic(crc, p, len, NULL, CRCPOLY_LE);\r\n}\r\nu32 __pure __crc32c_le(u32 crc, unsigned char const *p, size_t len)\r\n{\r\nreturn crc32_le_generic(crc, p, len, NULL, CRC32C_POLY_LE);\r\n}\r\nu32 __pure crc32_le(u32 crc, unsigned char const *p, size_t len)\r\n{\r\nreturn crc32_le_generic(crc, p, len,\r\n(const u32 (*)[256])crc32table_le, CRCPOLY_LE);\r\n}\r\nu32 __pure __crc32c_le(u32 crc, unsigned char const *p, size_t len)\r\n{\r\nreturn crc32_le_generic(crc, p, len,\r\n(const u32 (*)[256])crc32ctable_le, CRC32C_POLY_LE);\r\n}\r\nu32 __pure crc32_be(u32 crc, unsigned char const *p, size_t len)\r\n{\r\nreturn crc32_be_generic(crc, p, len, NULL, CRCPOLY_BE);\r\n}\r\nu32 __pure crc32_be(u32 crc, unsigned char const *p, size_t len)\r\n{\r\nreturn crc32_be_generic(crc, p, len,\r\n(const u32 (*)[256])crc32table_be, CRCPOLY_BE);\r\n}\r\nstatic int __init crc32c_test(void)\r\n{\r\nint i;\r\nint errors = 0;\r\nint bytes = 0;\r\nstruct timespec start, stop;\r\nu64 nsec;\r\nunsigned long flags;\r\nstatic u32 crc;\r\nfor (i = 0; i < 100; i++) {\r\nbytes += 2*test[i].length;\r\ncrc ^= __crc32c_le(test[i].crc, test_buf +\r\ntest[i].start, test[i].length);\r\n}\r\nlocal_irq_save(flags);\r\nlocal_irq_disable();\r\ngetnstimeofday(&start);\r\nfor (i = 0; i < 100; i++) {\r\nif (test[i].crc32c_le != __crc32c_le(test[i].crc, test_buf +\r\ntest[i].start, test[i].length))\r\nerrors++;\r\n}\r\ngetnstimeofday(&stop);\r\nlocal_irq_restore(flags);\r\nlocal_irq_enable();\r\nnsec = stop.tv_nsec - start.tv_nsec +\r\n1000000000 * (stop.tv_sec - start.tv_sec);\r\npr_info("crc32c: CRC_LE_BITS = %d\n", CRC_LE_BITS);\r\nif (errors)\r\npr_warn("crc32c: %d self tests failed\n", errors);\r\nelse {\r\npr_info("crc32c: self tests passed, processed %d bytes in %lld nsec\n",\r\nbytes, nsec);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init crc32_test(void)\r\n{\r\nint i;\r\nint errors = 0;\r\nint bytes = 0;\r\nstruct timespec start, stop;\r\nu64 nsec;\r\nunsigned long flags;\r\nstatic u32 crc;\r\nfor (i = 0; i < 100; i++) {\r\nbytes += 2*test[i].length;\r\ncrc ^= crc32_le(test[i].crc, test_buf +\r\ntest[i].start, test[i].length);\r\ncrc ^= crc32_be(test[i].crc, test_buf +\r\ntest[i].start, test[i].length);\r\n}\r\nlocal_irq_save(flags);\r\nlocal_irq_disable();\r\ngetnstimeofday(&start);\r\nfor (i = 0; i < 100; i++) {\r\nif (test[i].crc_le != crc32_le(test[i].crc, test_buf +\r\ntest[i].start, test[i].length))\r\nerrors++;\r\nif (test[i].crc_be != crc32_be(test[i].crc, test_buf +\r\ntest[i].start, test[i].length))\r\nerrors++;\r\n}\r\ngetnstimeofday(&stop);\r\nlocal_irq_restore(flags);\r\nlocal_irq_enable();\r\nnsec = stop.tv_nsec - start.tv_nsec +\r\n1000000000 * (stop.tv_sec - start.tv_sec);\r\npr_info("crc32: CRC_LE_BITS = %d, CRC_BE BITS = %d\n",\r\nCRC_LE_BITS, CRC_BE_BITS);\r\nif (errors)\r\npr_warn("crc32: %d self tests failed\n", errors);\r\nelse {\r\npr_info("crc32: self tests passed, processed %d bytes in %lld nsec\n",\r\nbytes, nsec);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init crc32test_init(void)\r\n{\r\ncrc32_test();\r\ncrc32c_test();\r\nreturn 0;\r\n}\r\nstatic void __exit crc32_exit(void)\r\n{\r\n}

static void __iomem *cs5530_port_base(struct ata_port *ap)\r\n{\r\nunsigned long bmdma = (unsigned long)ap->ioaddr.bmdma_addr;\r\nreturn (void __iomem *)((bmdma & ~0x0F) + 0x20 + 0x10 * ap->port_no);\r\n}\r\nstatic void cs5530_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstatic const unsigned int cs5530_pio_timings[2][5] = {\r\n{0x00009172, 0x00012171, 0x00020080, 0x00032010, 0x00040010},\r\n{0xd1329172, 0x71212171, 0x30200080, 0x20102010, 0x00100010}\r\n};\r\nvoid __iomem *base = cs5530_port_base(ap);\r\nu32 tuning;\r\nint format;\r\ntuning = ioread32(base + 0x04);\r\nformat = (tuning & 0x80000000UL) ? 1 : 0;\r\nif (adev->devno)\r\nbase += 0x08;\r\niowrite32(cs5530_pio_timings[format][adev->pio_mode - XFER_PIO_0], base);\r\n}\r\nstatic void cs5530_set_dmamode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nvoid __iomem *base = cs5530_port_base(ap);\r\nu32 tuning, timing = 0;\r\nu8 reg;\r\ntuning = ioread32(base + 0x04);\r\nswitch(adev->dma_mode) {\r\ncase XFER_UDMA_0:\r\ntiming = 0x00921250;break;\r\ncase XFER_UDMA_1:\r\ntiming = 0x00911140;break;\r\ncase XFER_UDMA_2:\r\ntiming = 0x00911030;break;\r\ncase XFER_MW_DMA_0:\r\ntiming = 0x00077771;break;\r\ncase XFER_MW_DMA_1:\r\ntiming = 0x00012121;break;\r\ncase XFER_MW_DMA_2:\r\ntiming = 0x00002020;break;\r\ndefault:\r\nBUG();\r\n}\r\ntiming |= (tuning & 0x80000000UL);\r\nif (adev->devno == 0)\r\niowrite32(timing, base + 0x04);\r\nelse {\r\nif (timing & 0x00100000)\r\ntuning |= 0x00100000;\r\nelse\r\ntuning &= ~0x00100000;\r\niowrite32(tuning, base + 0x04);\r\niowrite32(timing, base + 0x0C);\r\n}\r\nreg = ioread8(ap->ioaddr.bmdma_addr + ATA_DMA_STATUS);\r\nreg |= (1 << (5 + adev->devno));\r\niowrite8(reg, ap->ioaddr.bmdma_addr + ATA_DMA_STATUS);\r\nap->private_data = adev;\r\n}\r\nstatic unsigned int cs5530_qc_issue(struct ata_queued_cmd *qc)\r\n{\r\nstruct ata_port *ap = qc->ap;\r\nstruct ata_device *adev = qc->dev;\r\nstruct ata_device *prev = ap->private_data;\r\nif (ata_dma_enabled(adev) && adev != prev && prev != NULL) {\r\nif ((ata_using_udma(adev) && !ata_using_udma(prev)) ||\r\n(ata_using_udma(prev) && !ata_using_udma(adev)))\r\ncs5530_set_dmamode(ap, adev);\r\n}\r\nreturn ata_bmdma_qc_issue(qc);\r\n}\r\nstatic int cs5530_is_palmax(void)\r\n{\r\nif (dmi_check_system(palmax_dmi_table)) {\r\nprintk(KERN_INFO "Palmax PD1100: Disabling DMA on docking port.\n");\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cs5530_init_chip(void)\r\n{\r\nstruct pci_dev *master_0 = NULL, *cs5530_0 = NULL, *dev = NULL;\r\nwhile ((dev = pci_get_device(PCI_VENDOR_ID_CYRIX, PCI_ANY_ID, dev)) != NULL) {\r\nswitch (dev->device) {\r\ncase PCI_DEVICE_ID_CYRIX_PCI_MASTER:\r\nmaster_0 = pci_dev_get(dev);\r\nbreak;\r\ncase PCI_DEVICE_ID_CYRIX_5530_LEGACY:\r\ncs5530_0 = pci_dev_get(dev);\r\nbreak;\r\n}\r\n}\r\nif (!master_0) {\r\nprintk(KERN_ERR DRV_NAME ": unable to locate PCI MASTER function\n");\r\ngoto fail_put;\r\n}\r\nif (!cs5530_0) {\r\nprintk(KERN_ERR DRV_NAME ": unable to locate CS5530 LEGACY function\n");\r\ngoto fail_put;\r\n}\r\npci_set_master(cs5530_0);\r\npci_try_set_mwi(cs5530_0);\r\npci_write_config_byte(cs5530_0, PCI_CACHE_LINE_SIZE, 0x04);\r\npci_write_config_word(cs5530_0, 0xd0, 0x5006);\r\npci_write_config_byte(master_0, 0x40, 0x1e);\r\npci_write_config_byte(master_0, 0x41, 0x14);\r\npci_write_config_byte(master_0, 0x42, 0x00);\r\npci_write_config_byte(master_0, 0x43, 0xc1);\r\npci_dev_put(master_0);\r\npci_dev_put(cs5530_0);\r\nreturn 0;\r\nfail_put:\r\nif (master_0)\r\npci_dev_put(master_0);\r\nif (cs5530_0)\r\npci_dev_put(cs5530_0);\r\nreturn -ENODEV;\r\n}\r\nstatic int cs5530_init_one(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA2,\r\n.udma_mask = ATA_UDMA2,\r\n.port_ops = &cs5530_port_ops\r\n};\r\nstatic const struct ata_port_info info_palmax_secondary = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.port_ops = &cs5530_port_ops\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, NULL };\r\nint rc;\r\nrc = pcim_enable_device(pdev);\r\nif (rc)\r\nreturn rc;\r\nif (cs5530_init_chip())\r\nreturn -ENODEV;\r\nif (cs5530_is_palmax())\r\nppi[1] = &info_palmax_secondary;\r\nreturn ata_pci_bmdma_init_one(pdev, ppi, &cs5530_sht, NULL, 0);\r\n}\r\nstatic int cs5530_reinit_one(struct pci_dev *pdev)\r\n{\r\nstruct ata_host *host = dev_get_drvdata(&pdev->dev);\r\nint rc;\r\nrc = ata_pci_device_do_resume(pdev);\r\nif (rc)\r\nreturn rc;\r\nif (cs5530_init_chip())\r\nreturn -EIO;\r\nata_host_resume(host);\r\nreturn 0;\r\n}

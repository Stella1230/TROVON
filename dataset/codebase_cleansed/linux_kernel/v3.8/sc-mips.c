static void mips_sc_wback_inv(unsigned long addr, unsigned long size)\r\n{\r\nblast_scache_range(addr, addr + size);\r\n}\r\nstatic void mips_sc_inv(unsigned long addr, unsigned long size)\r\n{\r\nunsigned long lsize = cpu_scache_line_size();\r\nunsigned long almask = ~(lsize - 1);\r\ncache_op(Hit_Writeback_Inv_SD, addr & almask);\r\ncache_op(Hit_Writeback_Inv_SD, (addr + size - 1) & almask);\r\nblast_inv_scache_range(addr, addr + size);\r\n}\r\nstatic void mips_sc_enable(void)\r\n{\r\n}\r\nstatic void mips_sc_disable(void)\r\n{\r\n}\r\nstatic inline int mips_sc_is_activated(struct cpuinfo_mips *c)\r\n{\r\nunsigned int config2 = read_c0_config2();\r\nunsigned int tmp;\r\nswitch (c->cputype) {\r\ncase CPU_34K:\r\ncase CPU_74K:\r\ncase CPU_1004K:\r\ncase CPU_BMIPS5000:\r\nif (config2 & (1 << 12))\r\nreturn 0;\r\n}\r\ntmp = (config2 >> 4) & 0x0f;\r\nif (0 < tmp && tmp <= 7)\r\nc->scache.linesz = 2 << tmp;\r\nelse\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic inline int __init mips_sc_probe(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nunsigned int config1, config2;\r\nunsigned int tmp;\r\nc->scache.flags |= MIPS_CACHE_NOT_PRESENT;\r\nif (c->isa_level != MIPS_CPU_ISA_M32R1 &&\r\nc->isa_level != MIPS_CPU_ISA_M32R2 &&\r\nc->isa_level != MIPS_CPU_ISA_M64R1 &&\r\nc->isa_level != MIPS_CPU_ISA_M64R2)\r\nreturn 0;\r\nconfig1 = read_c0_config1();\r\nif (!(config1 & MIPS_CONF_M))\r\nreturn 0;\r\nconfig2 = read_c0_config2();\r\nif (!mips_sc_is_activated(c))\r\nreturn 0;\r\ntmp = (config2 >> 8) & 0x0f;\r\nif (0 <= tmp && tmp <= 7)\r\nc->scache.sets = 64 << tmp;\r\nelse\r\nreturn 0;\r\ntmp = (config2 >> 0) & 0x0f;\r\nif (0 <= tmp && tmp <= 7)\r\nc->scache.ways = tmp + 1;\r\nelse\r\nreturn 0;\r\nc->scache.waysize = c->scache.sets * c->scache.linesz;\r\nc->scache.waybit = __ffs(c->scache.waysize);\r\nc->scache.flags &= ~MIPS_CACHE_NOT_PRESENT;\r\nreturn 1;\r\n}\r\nint __cpuinit mips_sc_init(void)\r\n{\r\nint found = mips_sc_probe();\r\nif (found) {\r\nmips_sc_enable();\r\nbcops = &mips_sc_ops;\r\n}\r\nreturn found;\r\n}

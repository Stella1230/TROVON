static struct inode *fat_dget(struct super_block *sb, int i_logstart)\r\n{\r\nstruct msdos_sb_info *sbi = MSDOS_SB(sb);\r\nstruct hlist_head *head;\r\nstruct hlist_node *_p;\r\nstruct msdos_inode_info *i;\r\nstruct inode *inode = NULL;\r\nhead = sbi->dir_hashtable + fat_dir_hash(i_logstart);\r\nspin_lock(&sbi->dir_hash_lock);\r\nhlist_for_each_entry(i, _p, head, i_dir_hash) {\r\nBUG_ON(i->vfs_inode.i_sb != sb);\r\nif (i->i_logstart != i_logstart)\r\ncontinue;\r\ninode = igrab(&i->vfs_inode);\r\nif (inode)\r\nbreak;\r\n}\r\nspin_unlock(&sbi->dir_hash_lock);\r\nreturn inode;\r\n}\r\nstatic struct inode *fat_nfs_get_inode(struct super_block *sb,\r\nu64 ino, u32 generation)\r\n{\r\nstruct inode *inode;\r\nif ((ino < MSDOS_ROOT_INO) || (ino == MSDOS_FSINFO_INO))\r\nreturn NULL;\r\ninode = ilookup(sb, ino);\r\nif (inode && generation && (inode->i_generation != generation)) {\r\niput(inode);\r\ninode = NULL;\r\n}\r\nreturn inode;\r\n}\r\nstruct dentry *fat_fh_to_dentry(struct super_block *sb, struct fid *fid,\r\nint fh_len, int fh_type)\r\n{\r\nreturn generic_fh_to_dentry(sb, fid, fh_len, fh_type,\r\nfat_nfs_get_inode);\r\n}\r\nstruct dentry *fat_fh_to_parent(struct super_block *sb, struct fid *fid,\r\nint fh_len, int fh_type)\r\n{\r\nreturn generic_fh_to_parent(sb, fid, fh_len, fh_type,\r\nfat_nfs_get_inode);\r\n}\r\nstruct dentry *fat_get_parent(struct dentry *child_dir)\r\n{\r\nstruct super_block *sb = child_dir->d_sb;\r\nstruct buffer_head *bh = NULL;\r\nstruct msdos_dir_entry *de;\r\nstruct inode *parent_inode = NULL;\r\nif (!fat_get_dotdot_entry(child_dir->d_inode, &bh, &de)) {\r\nint parent_logstart = fat_get_start(MSDOS_SB(sb), de);\r\nparent_inode = fat_dget(sb, parent_logstart);\r\n}\r\nbrelse(bh);\r\nreturn d_obtain_alias(parent_inode);\r\n}

static int isl6421_set_voltage(struct dvb_frontend *fe, fe_sec_voltage_t voltage)\r\n{\r\nstruct isl6421 *isl6421 = (struct isl6421 *) fe->sec_priv;\r\nstruct i2c_msg msg = { .addr = isl6421->i2c_addr, .flags = 0,\r\n.buf = &isl6421->config,\r\n.len = sizeof(isl6421->config) };\r\nisl6421->config &= ~(ISL6421_VSEL1 | ISL6421_EN1);\r\nswitch(voltage) {\r\ncase SEC_VOLTAGE_OFF:\r\nbreak;\r\ncase SEC_VOLTAGE_13:\r\nisl6421->config |= ISL6421_EN1;\r\nbreak;\r\ncase SEC_VOLTAGE_18:\r\nisl6421->config |= (ISL6421_EN1 | ISL6421_VSEL1);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nisl6421->config |= isl6421->override_or;\r\nisl6421->config &= isl6421->override_and;\r\nreturn (i2c_transfer(isl6421->i2c, &msg, 1) == 1) ? 0 : -EIO;\r\n}\r\nstatic int isl6421_enable_high_lnb_voltage(struct dvb_frontend *fe, long arg)\r\n{\r\nstruct isl6421 *isl6421 = (struct isl6421 *) fe->sec_priv;\r\nstruct i2c_msg msg = { .addr = isl6421->i2c_addr, .flags = 0,\r\n.buf = &isl6421->config,\r\n.len = sizeof(isl6421->config) };\r\nif (arg)\r\nisl6421->config |= ISL6421_LLC1;\r\nelse\r\nisl6421->config &= ~ISL6421_LLC1;\r\nisl6421->config |= isl6421->override_or;\r\nisl6421->config &= isl6421->override_and;\r\nreturn (i2c_transfer(isl6421->i2c, &msg, 1) == 1) ? 0 : -EIO;\r\n}\r\nstatic void isl6421_release(struct dvb_frontend *fe)\r\n{\r\nisl6421_set_voltage(fe, SEC_VOLTAGE_OFF);\r\nkfree(fe->sec_priv);\r\nfe->sec_priv = NULL;\r\n}\r\nstruct dvb_frontend *isl6421_attach(struct dvb_frontend *fe, struct i2c_adapter *i2c, u8 i2c_addr,\r\nu8 override_set, u8 override_clear)\r\n{\r\nstruct isl6421 *isl6421 = kmalloc(sizeof(struct isl6421), GFP_KERNEL);\r\nif (!isl6421)\r\nreturn NULL;\r\nisl6421->config = ISL6421_ISEL1;\r\nisl6421->i2c = i2c;\r\nisl6421->i2c_addr = i2c_addr;\r\nfe->sec_priv = isl6421;\r\nisl6421->override_or = override_set;\r\nisl6421->override_and = ~override_clear;\r\nif (isl6421_set_voltage(fe, SEC_VOLTAGE_OFF)) {\r\nkfree(isl6421);\r\nfe->sec_priv = NULL;\r\nreturn NULL;\r\n}\r\nfe->ops.release_sec = isl6421_release;\r\nfe->ops.set_voltage = isl6421_set_voltage;\r\nfe->ops.enable_high_lnb_voltage = isl6421_enable_high_lnb_voltage;\r\nreturn fe;\r\n}

static acpi_status\r\nacpi_ut_copy_isimple_to_esimple(union acpi_operand_object *internal_object,\r\nunion acpi_object *external_object,\r\nu8 * data_space, acpi_size * buffer_space_used)\r\n{\r\nacpi_status status = AE_OK;\r\nACPI_FUNCTION_TRACE(ut_copy_isimple_to_esimple);\r\n*buffer_space_used = 0;\r\nif (!internal_object) {\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nACPI_MEMSET(external_object, 0, sizeof(union acpi_object));\r\nexternal_object->type = internal_object->common.type;\r\nswitch (internal_object->common.type) {\r\ncase ACPI_TYPE_STRING:\r\nexternal_object->string.pointer = (char *)data_space;\r\nexternal_object->string.length = internal_object->string.length;\r\n*buffer_space_used = ACPI_ROUND_UP_TO_NATIVE_WORD((acpi_size)\r\ninternal_object->\r\nstring.\r\nlength + 1);\r\nACPI_MEMCPY((void *)data_space,\r\n(void *)internal_object->string.pointer,\r\n(acpi_size) internal_object->string.length + 1);\r\nbreak;\r\ncase ACPI_TYPE_BUFFER:\r\nexternal_object->buffer.pointer = data_space;\r\nexternal_object->buffer.length = internal_object->buffer.length;\r\n*buffer_space_used =\r\nACPI_ROUND_UP_TO_NATIVE_WORD(internal_object->string.\r\nlength);\r\nACPI_MEMCPY((void *)data_space,\r\n(void *)internal_object->buffer.pointer,\r\ninternal_object->buffer.length);\r\nbreak;\r\ncase ACPI_TYPE_INTEGER:\r\nexternal_object->integer.value = internal_object->integer.value;\r\nbreak;\r\ncase ACPI_TYPE_LOCAL_REFERENCE:\r\nswitch (internal_object->reference.class) {\r\ncase ACPI_REFCLASS_NAME:\r\nexternal_object->reference.handle =\r\ninternal_object->reference.node;\r\nexternal_object->reference.actual_type =\r\nacpi_ns_get_type(internal_object->reference.node);\r\nbreak;\r\ndefault:\r\nreturn_ACPI_STATUS(AE_TYPE);\r\n}\r\nbreak;\r\ncase ACPI_TYPE_PROCESSOR:\r\nexternal_object->processor.proc_id =\r\ninternal_object->processor.proc_id;\r\nexternal_object->processor.pblk_address =\r\ninternal_object->processor.address;\r\nexternal_object->processor.pblk_length =\r\ninternal_object->processor.length;\r\nbreak;\r\ncase ACPI_TYPE_POWER:\r\nexternal_object->power_resource.system_level =\r\ninternal_object->power_resource.system_level;\r\nexternal_object->power_resource.resource_order =\r\ninternal_object->power_resource.resource_order;\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Unsupported object type, cannot convert to external object: %s",\r\nacpi_ut_get_type_name(internal_object->common.\r\ntype)));\r\nreturn_ACPI_STATUS(AE_SUPPORT);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatic acpi_status\r\nacpi_ut_copy_ielement_to_eelement(u8 object_type,\r\nunion acpi_operand_object *source_object,\r\nunion acpi_generic_state *state,\r\nvoid *context)\r\n{\r\nacpi_status status = AE_OK;\r\nstruct acpi_pkg_info *info = (struct acpi_pkg_info *)context;\r\nacpi_size object_space;\r\nu32 this_index;\r\nunion acpi_object *target_object;\r\nACPI_FUNCTION_ENTRY();\r\nthis_index = state->pkg.index;\r\ntarget_object = (union acpi_object *)\r\n&((union acpi_object *)(state->pkg.dest_object))->package.\r\nelements[this_index];\r\nswitch (object_type) {\r\ncase ACPI_COPY_TYPE_SIMPLE:\r\nstatus = acpi_ut_copy_isimple_to_esimple(source_object,\r\ntarget_object,\r\ninfo->free_space,\r\n&object_space);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\nbreak;\r\ncase ACPI_COPY_TYPE_PACKAGE:\r\ntarget_object->type = ACPI_TYPE_PACKAGE;\r\ntarget_object->package.count = source_object->package.count;\r\ntarget_object->package.elements =\r\nACPI_CAST_PTR(union acpi_object, info->free_space);\r\nstate->pkg.this_target_obj = target_object;\r\nobject_space = ACPI_ROUND_UP_TO_NATIVE_WORD((acpi_size)\r\ntarget_object->\r\npackage.count *\r\nsizeof(union\r\nacpi_object));\r\nbreak;\r\ndefault:\r\nreturn (AE_BAD_PARAMETER);\r\n}\r\ninfo->free_space += object_space;\r\ninfo->length += object_space;\r\nreturn (status);\r\n}\r\nstatic acpi_status\r\nacpi_ut_copy_ipackage_to_epackage(union acpi_operand_object *internal_object,\r\nu8 * buffer, acpi_size * space_used)\r\n{\r\nunion acpi_object *external_object;\r\nacpi_status status;\r\nstruct acpi_pkg_info info;\r\nACPI_FUNCTION_TRACE(ut_copy_ipackage_to_epackage);\r\nexternal_object = ACPI_CAST_PTR(union acpi_object, buffer);\r\ninfo.length = ACPI_ROUND_UP_TO_NATIVE_WORD(sizeof(union acpi_object));\r\ninfo.free_space =\r\nbuffer + ACPI_ROUND_UP_TO_NATIVE_WORD(sizeof(union acpi_object));\r\ninfo.object_space = 0;\r\ninfo.num_packages = 1;\r\nexternal_object->type = internal_object->common.type;\r\nexternal_object->package.count = internal_object->package.count;\r\nexternal_object->package.elements = ACPI_CAST_PTR(union acpi_object,\r\ninfo.free_space);\r\ninfo.length += (acpi_size) external_object->package.count *\r\nACPI_ROUND_UP_TO_NATIVE_WORD(sizeof(union acpi_object));\r\ninfo.free_space += external_object->package.count *\r\nACPI_ROUND_UP_TO_NATIVE_WORD(sizeof(union acpi_object));\r\nstatus = acpi_ut_walk_package_tree(internal_object, external_object,\r\nacpi_ut_copy_ielement_to_eelement,\r\n&info);\r\n*space_used = info.length;\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ut_copy_iobject_to_eobject(union acpi_operand_object *internal_object,\r\nstruct acpi_buffer *ret_buffer)\r\n{\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(ut_copy_iobject_to_eobject);\r\nif (internal_object->common.type == ACPI_TYPE_PACKAGE) {\r\nstatus = acpi_ut_copy_ipackage_to_epackage(internal_object,\r\nret_buffer->pointer,\r\n&ret_buffer->length);\r\n} else {\r\nstatus = acpi_ut_copy_isimple_to_esimple(internal_object,\r\nACPI_CAST_PTR(union\r\nacpi_object,\r\nret_buffer->\r\npointer),\r\nACPI_ADD_PTR(u8,\r\nret_buffer->\r\npointer,\r\nACPI_ROUND_UP_TO_NATIVE_WORD\r\n(sizeof\r\n(union\r\nacpi_object))),\r\n&ret_buffer->length);\r\nret_buffer->length += sizeof(union acpi_object);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatic acpi_status\r\nacpi_ut_copy_esimple_to_isimple(union acpi_object *external_object,\r\nunion acpi_operand_object **ret_internal_object)\r\n{\r\nunion acpi_operand_object *internal_object;\r\nACPI_FUNCTION_TRACE(ut_copy_esimple_to_isimple);\r\nswitch (external_object->type) {\r\ncase ACPI_TYPE_STRING:\r\ncase ACPI_TYPE_BUFFER:\r\ncase ACPI_TYPE_INTEGER:\r\ncase ACPI_TYPE_LOCAL_REFERENCE:\r\ninternal_object = acpi_ut_create_internal_object((u8)\r\nexternal_object->\r\ntype);\r\nif (!internal_object) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nbreak;\r\ncase ACPI_TYPE_ANY:\r\n*ret_internal_object = NULL;\r\nreturn_ACPI_STATUS(AE_OK);\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Unsupported object type, cannot convert to internal object: %s",\r\nacpi_ut_get_type_name(external_object->type)));\r\nreturn_ACPI_STATUS(AE_SUPPORT);\r\n}\r\nswitch (external_object->type) {\r\ncase ACPI_TYPE_STRING:\r\ninternal_object->string.pointer =\r\nACPI_ALLOCATE_ZEROED((acpi_size)\r\nexternal_object->string.length + 1);\r\nif (!internal_object->string.pointer) {\r\ngoto error_exit;\r\n}\r\nACPI_MEMCPY(internal_object->string.pointer,\r\nexternal_object->string.pointer,\r\nexternal_object->string.length);\r\ninternal_object->string.length = external_object->string.length;\r\nbreak;\r\ncase ACPI_TYPE_BUFFER:\r\ninternal_object->buffer.pointer =\r\nACPI_ALLOCATE_ZEROED(external_object->buffer.length);\r\nif (!internal_object->buffer.pointer) {\r\ngoto error_exit;\r\n}\r\nACPI_MEMCPY(internal_object->buffer.pointer,\r\nexternal_object->buffer.pointer,\r\nexternal_object->buffer.length);\r\ninternal_object->buffer.length = external_object->buffer.length;\r\ninternal_object->buffer.flags |= AOPOBJ_DATA_VALID;\r\nbreak;\r\ncase ACPI_TYPE_INTEGER:\r\ninternal_object->integer.value = external_object->integer.value;\r\nbreak;\r\ncase ACPI_TYPE_LOCAL_REFERENCE:\r\ninternal_object->reference.class = ACPI_REFCLASS_NAME;\r\ninternal_object->reference.node =\r\nexternal_object->reference.handle;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n*ret_internal_object = internal_object;\r\nreturn_ACPI_STATUS(AE_OK);\r\nerror_exit:\r\nacpi_ut_remove_reference(internal_object);\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nstatic acpi_status\r\nacpi_ut_copy_epackage_to_ipackage(union acpi_object *external_object,\r\nunion acpi_operand_object **internal_object)\r\n{\r\nacpi_status status = AE_OK;\r\nunion acpi_operand_object *package_object;\r\nunion acpi_operand_object **package_elements;\r\nu32 i;\r\nACPI_FUNCTION_TRACE(ut_copy_epackage_to_ipackage);\r\npackage_object =\r\nacpi_ut_create_package_object(external_object->package.count);\r\nif (!package_object) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\npackage_elements = package_object->package.elements;\r\nfor (i = 0; i < external_object->package.count; i++) {\r\nstatus =\r\nacpi_ut_copy_eobject_to_iobject(&external_object->package.\r\nelements[i],\r\n&package_elements[i]);\r\nif (ACPI_FAILURE(status)) {\r\npackage_object->package.count = i;\r\npackage_elements[i] = NULL;\r\nacpi_ut_remove_reference(package_object);\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\npackage_object->package.flags |= AOPOBJ_DATA_VALID;\r\n*internal_object = package_object;\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ut_copy_eobject_to_iobject(union acpi_object *external_object,\r\nunion acpi_operand_object **internal_object)\r\n{\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(ut_copy_eobject_to_iobject);\r\nif (external_object->type == ACPI_TYPE_PACKAGE) {\r\nstatus =\r\nacpi_ut_copy_epackage_to_ipackage(external_object,\r\ninternal_object);\r\n} else {\r\nstatus =\r\nacpi_ut_copy_esimple_to_isimple(external_object,\r\ninternal_object);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatic acpi_status\r\nacpi_ut_copy_simple_object(union acpi_operand_object *source_desc,\r\nunion acpi_operand_object *dest_desc)\r\n{\r\nu16 reference_count;\r\nunion acpi_operand_object *next_object;\r\nacpi_status status;\r\nacpi_size copy_size;\r\nreference_count = dest_desc->common.reference_count;\r\nnext_object = dest_desc->common.next_object;\r\ncopy_size = sizeof(union acpi_operand_object);\r\nif (ACPI_GET_DESCRIPTOR_TYPE(source_desc) == ACPI_DESC_TYPE_NAMED) {\r\ncopy_size = sizeof(struct acpi_namespace_node);\r\n}\r\nACPI_MEMCPY(ACPI_CAST_PTR(char, dest_desc),\r\nACPI_CAST_PTR(char, source_desc), copy_size);\r\ndest_desc->common.reference_count = reference_count;\r\ndest_desc->common.next_object = next_object;\r\ndest_desc->common.flags &= ~AOPOBJ_STATIC_POINTER;\r\nswitch (dest_desc->common.type) {\r\ncase ACPI_TYPE_BUFFER:\r\nif ((source_desc->buffer.pointer) &&\r\n(source_desc->buffer.length)) {\r\ndest_desc->buffer.pointer =\r\nACPI_ALLOCATE(source_desc->buffer.length);\r\nif (!dest_desc->buffer.pointer) {\r\nreturn (AE_NO_MEMORY);\r\n}\r\nACPI_MEMCPY(dest_desc->buffer.pointer,\r\nsource_desc->buffer.pointer,\r\nsource_desc->buffer.length);\r\n}\r\nbreak;\r\ncase ACPI_TYPE_STRING:\r\nif (source_desc->string.pointer) {\r\ndest_desc->string.pointer =\r\nACPI_ALLOCATE((acpi_size) source_desc->string.\r\nlength + 1);\r\nif (!dest_desc->string.pointer) {\r\nreturn (AE_NO_MEMORY);\r\n}\r\nACPI_MEMCPY(dest_desc->string.pointer,\r\nsource_desc->string.pointer,\r\n(acpi_size) source_desc->string.length + 1);\r\n}\r\nbreak;\r\ncase ACPI_TYPE_LOCAL_REFERENCE:\r\nif (source_desc->reference.class == ACPI_REFCLASS_TABLE) {\r\nbreak;\r\n}\r\nacpi_ut_add_reference(source_desc->reference.object);\r\nbreak;\r\ncase ACPI_TYPE_REGION:\r\nif (dest_desc->region.handler) {\r\nacpi_ut_add_reference(dest_desc->region.handler);\r\n}\r\nbreak;\r\ncase ACPI_TYPE_MUTEX:\r\nstatus = acpi_os_create_mutex(&dest_desc->mutex.os_mutex);\r\nif (ACPI_FAILURE(status)) {\r\nreturn status;\r\n}\r\nbreak;\r\ncase ACPI_TYPE_EVENT:\r\nstatus = acpi_os_create_semaphore(ACPI_NO_UNIT_LIMIT, 0,\r\n&dest_desc->event.\r\nos_semaphore);\r\nif (ACPI_FAILURE(status)) {\r\nreturn status;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn (AE_OK);\r\n}\r\nstatic acpi_status\r\nacpi_ut_copy_ielement_to_ielement(u8 object_type,\r\nunion acpi_operand_object *source_object,\r\nunion acpi_generic_state *state,\r\nvoid *context)\r\n{\r\nacpi_status status = AE_OK;\r\nu32 this_index;\r\nunion acpi_operand_object **this_target_ptr;\r\nunion acpi_operand_object *target_object;\r\nACPI_FUNCTION_ENTRY();\r\nthis_index = state->pkg.index;\r\nthis_target_ptr = (union acpi_operand_object **)\r\n&state->pkg.dest_object->package.elements[this_index];\r\nswitch (object_type) {\r\ncase ACPI_COPY_TYPE_SIMPLE:\r\nif (source_object) {\r\ntarget_object =\r\nacpi_ut_create_internal_object(source_object->\r\ncommon.type);\r\nif (!target_object) {\r\nreturn (AE_NO_MEMORY);\r\n}\r\nstatus =\r\nacpi_ut_copy_simple_object(source_object,\r\ntarget_object);\r\nif (ACPI_FAILURE(status)) {\r\ngoto error_exit;\r\n}\r\n*this_target_ptr = target_object;\r\n} else {\r\n*this_target_ptr = NULL;\r\n}\r\nbreak;\r\ncase ACPI_COPY_TYPE_PACKAGE:\r\ntarget_object =\r\nacpi_ut_create_package_object(source_object->package.count);\r\nif (!target_object) {\r\nreturn (AE_NO_MEMORY);\r\n}\r\ntarget_object->common.flags = source_object->common.flags;\r\nstate->pkg.this_target_obj = target_object;\r\n*this_target_ptr = target_object;\r\nbreak;\r\ndefault:\r\nreturn (AE_BAD_PARAMETER);\r\n}\r\nreturn (status);\r\nerror_exit:\r\nacpi_ut_remove_reference(target_object);\r\nreturn (status);\r\n}\r\nstatic acpi_status\r\nacpi_ut_copy_ipackage_to_ipackage(union acpi_operand_object *source_obj,\r\nunion acpi_operand_object *dest_obj,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status = AE_OK;\r\nACPI_FUNCTION_TRACE(ut_copy_ipackage_to_ipackage);\r\ndest_obj->common.type = source_obj->common.type;\r\ndest_obj->common.flags = source_obj->common.flags;\r\ndest_obj->package.count = source_obj->package.count;\r\ndest_obj->package.elements = ACPI_ALLOCATE_ZEROED(((acpi_size)\r\nsource_obj->package.\r\ncount +\r\n1) * sizeof(void *));\r\nif (!dest_obj->package.elements) {\r\nACPI_ERROR((AE_INFO, "Package allocation failure"));\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nstatus = acpi_ut_walk_package_tree(source_obj, dest_obj,\r\nacpi_ut_copy_ielement_to_ielement,\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nacpi_ut_remove_reference(dest_obj);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ut_copy_iobject_to_iobject(union acpi_operand_object *source_desc,\r\nunion acpi_operand_object **dest_desc,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status = AE_OK;\r\nACPI_FUNCTION_TRACE(ut_copy_iobject_to_iobject);\r\n*dest_desc = acpi_ut_create_internal_object(source_desc->common.type);\r\nif (!*dest_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nif (source_desc->common.type == ACPI_TYPE_PACKAGE) {\r\nstatus =\r\nacpi_ut_copy_ipackage_to_ipackage(source_desc, *dest_desc,\r\nwalk_state);\r\n} else {\r\nstatus = acpi_ut_copy_simple_object(source_desc, *dest_desc);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}

static __init int setup_nointremap(char *str)\r\n{\r\ndisable_irq_remap = 1;\r\nreturn 0;\r\n}\r\nstatic __init int setup_irqremap(char *str)\r\n{\r\nif (!str)\r\nreturn -EINVAL;\r\nwhile (*str) {\r\nif (!strncmp(str, "on", 2))\r\ndisable_irq_remap = 0;\r\nelse if (!strncmp(str, "off", 3))\r\ndisable_irq_remap = 1;\r\nelse if (!strncmp(str, "nosid", 5))\r\ndisable_sourceid_checking = 1;\r\nelse if (!strncmp(str, "no_x2apic_optout", 16))\r\nno_x2apic_optout = 1;\r\nstr += strcspn(str, ",");\r\nwhile (*str == ',')\r\nstr++;\r\n}\r\nreturn 0;\r\n}\r\nvoid __init setup_irq_remapping_ops(void)\r\n{\r\nremap_ops = &intel_irq_remap_ops;\r\n#ifdef CONFIG_AMD_IOMMU\r\nif (amd_iommu_irq_ops.prepare() == 0)\r\nremap_ops = &amd_iommu_irq_ops;\r\n#endif\r\n}\r\nint irq_remapping_supported(void)\r\n{\r\nif (disable_irq_remap)\r\nreturn 0;\r\nif (!remap_ops || !remap_ops->supported)\r\nreturn 0;\r\nreturn remap_ops->supported();\r\n}\r\nint __init irq_remapping_prepare(void)\r\n{\r\nif (!remap_ops || !remap_ops->prepare)\r\nreturn -ENODEV;\r\nreturn remap_ops->prepare();\r\n}\r\nint __init irq_remapping_enable(void)\r\n{\r\nif (!remap_ops || !remap_ops->enable)\r\nreturn -ENODEV;\r\nreturn remap_ops->enable();\r\n}\r\nvoid irq_remapping_disable(void)\r\n{\r\nif (!remap_ops || !remap_ops->disable)\r\nreturn;\r\nremap_ops->disable();\r\n}\r\nint irq_remapping_reenable(int mode)\r\n{\r\nif (!remap_ops || !remap_ops->reenable)\r\nreturn 0;\r\nreturn remap_ops->reenable(mode);\r\n}\r\nint __init irq_remap_enable_fault_handling(void)\r\n{\r\nif (!remap_ops || !remap_ops->enable_faulting)\r\nreturn -ENODEV;\r\nreturn remap_ops->enable_faulting();\r\n}\r\nint setup_ioapic_remapped_entry(int irq,\r\nstruct IO_APIC_route_entry *entry,\r\nunsigned int destination, int vector,\r\nstruct io_apic_irq_attr *attr)\r\n{\r\nif (!remap_ops || !remap_ops->setup_ioapic_entry)\r\nreturn -ENODEV;\r\nreturn remap_ops->setup_ioapic_entry(irq, entry, destination,\r\nvector, attr);\r\n}\r\nint set_remapped_irq_affinity(struct irq_data *data, const struct cpumask *mask,\r\nbool force)\r\n{\r\nif (!config_enabled(CONFIG_SMP) || !remap_ops ||\r\n!remap_ops->set_affinity)\r\nreturn 0;\r\nreturn remap_ops->set_affinity(data, mask, force);\r\n}\r\nvoid free_remapped_irq(int irq)\r\n{\r\nif (!remap_ops || !remap_ops->free_irq)\r\nreturn;\r\nremap_ops->free_irq(irq);\r\n}\r\nvoid compose_remapped_msi_msg(struct pci_dev *pdev,\r\nunsigned int irq, unsigned int dest,\r\nstruct msi_msg *msg, u8 hpet_id)\r\n{\r\nif (!remap_ops || !remap_ops->compose_msi_msg)\r\nreturn;\r\nremap_ops->compose_msi_msg(pdev, irq, dest, msg, hpet_id);\r\n}\r\nint msi_alloc_remapped_irq(struct pci_dev *pdev, int irq, int nvec)\r\n{\r\nif (!remap_ops || !remap_ops->msi_alloc_irq)\r\nreturn -ENODEV;\r\nreturn remap_ops->msi_alloc_irq(pdev, irq, nvec);\r\n}\r\nint msi_setup_remapped_irq(struct pci_dev *pdev, unsigned int irq,\r\nint index, int sub_handle)\r\n{\r\nif (!remap_ops || !remap_ops->msi_setup_irq)\r\nreturn -ENODEV;\r\nreturn remap_ops->msi_setup_irq(pdev, irq, index, sub_handle);\r\n}\r\nint setup_hpet_msi_remapped(unsigned int irq, unsigned int id)\r\n{\r\nif (!remap_ops || !remap_ops->setup_hpet_msi)\r\nreturn -ENODEV;\r\nreturn remap_ops->setup_hpet_msi(irq, id);\r\n}

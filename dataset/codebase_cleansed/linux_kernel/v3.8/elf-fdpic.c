void elf_fdpic_arch_lay_out_mm(struct elf_fdpic_params *exec_params,\r\nstruct elf_fdpic_params *interp_params,\r\nunsigned long *start_stack,\r\nunsigned long *start_brk)\r\n{\r\n*start_stack = 0x02200000UL;\r\nif (!(interp_params->flags & ELF_FDPIC_FLAG_PRESENT) &&\r\nexec_params->hdr.e_type != ET_EXEC\r\n) {\r\nexec_params->load_addr = PAGE_SIZE;\r\n*start_brk = 0x80000000UL;\r\n}\r\nelse {\r\nexec_params->load_addr = 0x02200000UL;\r\nif ((exec_params->flags & ELF_FDPIC_FLAG_ARRANGEMENT) ==\r\nELF_FDPIC_FLAG_INDEPENDENT\r\n) {\r\nexec_params->flags &= ~ELF_FDPIC_FLAG_ARRANGEMENT;\r\nexec_params->flags |= ELF_FDPIC_FLAG_CONSTDISP;\r\n}\r\n}\r\n}\r\nunsigned long arch_get_unmapped_area(struct file *filp, unsigned long addr, unsigned long len,\r\nunsigned long pgoff, unsigned long flags)\r\n{\r\nstruct vm_area_struct *vma;\r\nunsigned long limit;\r\nif (len > TASK_SIZE)\r\nreturn -ENOMEM;\r\nif (flags & MAP_FIXED)\r\nreturn addr;\r\nif (addr) {\r\naddr = PAGE_ALIGN(addr);\r\nvma = find_vma(current->mm, addr);\r\nif (TASK_SIZE - len >= addr &&\r\n(!vma || addr + len <= vma->vm_start))\r\ngoto success;\r\n}\r\naddr = PAGE_SIZE;\r\nlimit = (current->mm->start_stack - 0x00200000);\r\nif (addr + len <= limit) {\r\nlimit -= len;\r\nif (addr <= limit) {\r\nvma = find_vma(current->mm, PAGE_SIZE);\r\nfor (; vma; vma = vma->vm_next) {\r\nif (addr > limit)\r\nbreak;\r\nif (addr + len <= vma->vm_start)\r\ngoto success;\r\naddr = vma->vm_end;\r\n}\r\n}\r\n}\r\naddr = PAGE_ALIGN(0x80000000);\r\nlimit = TASK_SIZE - len;\r\nif (addr <= limit) {\r\nvma = find_vma(current->mm, addr);\r\nfor (; vma; vma = vma->vm_next) {\r\nif (addr > limit)\r\nbreak;\r\nif (addr + len <= vma->vm_start)\r\ngoto success;\r\naddr = vma->vm_end;\r\n}\r\nif (!vma && addr <= limit)\r\ngoto success;\r\n}\r\n#if 0\r\nprintk("[area] l=%lx (ENOMEM) f='%s'\n",\r\nlen, filp ? filp->f_path.dentry->d_name.name : "");\r\n#endif\r\nreturn -ENOMEM;\r\nsuccess:\r\n#if 0\r\nprintk("[area] l=%lx ad=%lx f='%s'\n",\r\nlen, addr, filp ? filp->f_path.dentry->d_name.name : "");\r\n#endif\r\nreturn addr;\r\n}

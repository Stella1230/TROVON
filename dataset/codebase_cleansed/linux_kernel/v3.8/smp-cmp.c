static void ipi_call_function(unsigned int cpu)\r\n{\r\npr_debug("CPU%d: %s cpu %d status %08x\n",\r\nsmp_processor_id(), __func__, cpu, read_c0_status());\r\ngic_send_ipi(plat_ipi_call_int_xlate(cpu));\r\n}\r\nstatic void ipi_resched(unsigned int cpu)\r\n{\r\npr_debug("CPU%d: %s cpu %d status %08x\n",\r\nsmp_processor_id(), __func__, cpu, read_c0_status());\r\ngic_send_ipi(plat_ipi_resched_int_xlate(cpu));\r\n}\r\nvoid cmp_send_ipi_single(int cpu, unsigned int action)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nswitch (action) {\r\ncase SMP_CALL_FUNCTION:\r\nipi_call_function(cpu);\r\nbreak;\r\ncase SMP_RESCHEDULE_YOURSELF:\r\nipi_resched(cpu);\r\nbreak;\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void cmp_send_ipi_mask(const struct cpumask *mask, unsigned int action)\r\n{\r\nunsigned int i;\r\nfor_each_cpu(i, mask)\r\ncmp_send_ipi_single(i, action);\r\n}\r\nstatic void cmp_init_secondary(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nchange_c0_status(ST0_IM, STATUSF_IP3 | STATUSF_IP4 | STATUSF_IP6 |\r\nSTATUSF_IP7);\r\nc->core = (read_c0_ebase() >> 1) & 0x1ff;\r\n#if defined(CONFIG_MIPS_MT_SMP) || defined(CONFIG_MIPS_MT_SMTC)\r\nc->vpe_id = (read_c0_tcbind() >> TCBIND_CURVPE_SHIFT) & TCBIND_CURVPE;\r\n#endif\r\n#ifdef CONFIG_MIPS_MT_SMTC\r\nc->tc_id = (read_c0_tcbind() & TCBIND_CURTC) >> TCBIND_CURTC_SHIFT;\r\n#endif\r\n}\r\nstatic void cmp_smp_finish(void)\r\n{\r\npr_debug("SMPCMP: CPU%d: %s\n", smp_processor_id(), __func__);\r\nwrite_c0_compare(read_c0_count() + (8 * mips_hpt_frequency / HZ));\r\n#ifdef CONFIG_MIPS_MT_FPAFF\r\nif (cpu_has_fpu)\r\ncpu_set(smp_processor_id(), mt_fpu_cpumask);\r\n#endif\r\nlocal_irq_enable();\r\n}\r\nstatic void cmp_cpus_done(void)\r\n{\r\npr_debug("SMPCMP: CPU%d: %s\n", smp_processor_id(), __func__);\r\n}\r\nstatic void cmp_boot_secondary(int cpu, struct task_struct *idle)\r\n{\r\nstruct thread_info *gp = task_thread_info(idle);\r\nunsigned long sp = __KSTK_TOS(idle);\r\nunsigned long pc = (unsigned long)&smp_bootstrap;\r\nunsigned long a0 = 0;\r\npr_debug("SMPCMP: CPU%d: %s cpu %d\n", smp_processor_id(),\r\n__func__, cpu);\r\n#if 0\r\nflush_icache_range((unsigned long)gp,\r\n(unsigned long)(gp + sizeof(struct thread_info)));\r\n#endif\r\namon_cpu_start(cpu, pc, sp, (unsigned long)gp, a0);\r\n}\r\nvoid __init cmp_smp_setup(void)\r\n{\r\nint i;\r\nint ncpu = 0;\r\npr_debug("SMPCMP: CPU%d: %s\n", smp_processor_id(), __func__);\r\n#ifdef CONFIG_MIPS_MT_FPAFF\r\nif (cpu_has_fpu)\r\ncpu_set(0, mt_fpu_cpumask);\r\n#endif\r\nfor (i = 1; i < NR_CPUS; i++) {\r\nif (amon_cpu_avail(i)) {\r\nset_cpu_possible(i, true);\r\n__cpu_number_map[i] = ++ncpu;\r\n__cpu_logical_map[ncpu] = i;\r\n}\r\n}\r\nif (cpu_has_mipsmt) {\r\nunsigned int nvpe, mvpconf0 = read_c0_mvpconf0();\r\nnvpe = ((mvpconf0 & MVPCONF0_PTC) >> MVPCONF0_PTC_SHIFT) + 1;\r\nsmp_num_siblings = nvpe;\r\n}\r\npr_info("Detected %i available secondary CPU(s)\n", ncpu);\r\n}\r\nvoid __init cmp_prepare_cpus(unsigned int max_cpus)\r\n{\r\npr_debug("SMPCMP: CPU%d: %s max_cpus=%d\n",\r\nsmp_processor_id(), __func__, max_cpus);\r\nmips_mt_set_cpuoptions();\r\n}

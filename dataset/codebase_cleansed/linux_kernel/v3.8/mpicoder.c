MPI mpi_read_raw_data(const void *xbuffer, size_t nbytes)\r\n{\r\nconst uint8_t *buffer = xbuffer;\r\nint i, j;\r\nunsigned nbits, nlimbs;\r\nmpi_limb_t a;\r\nMPI val = NULL;\r\nwhile (nbytes >= 0 && buffer[0] == 0) {\r\nbuffer++;\r\nnbytes--;\r\n}\r\nnbits = nbytes * 8;\r\nif (nbits > MAX_EXTERN_MPI_BITS) {\r\npr_info("MPI: mpi too large (%u bits)\n", nbits);\r\nreturn NULL;\r\n}\r\nif (nbytes > 0)\r\nnbits -= count_leading_zeros(buffer[0]);\r\nelse\r\nnbits = 0;\r\nnlimbs = (nbytes + BYTES_PER_MPI_LIMB - 1) / BYTES_PER_MPI_LIMB;\r\nval = mpi_alloc(nlimbs);\r\nif (!val)\r\nreturn NULL;\r\nval->nbits = nbits;\r\nval->sign = 0;\r\nval->nlimbs = nlimbs;\r\nif (nbytes > 0) {\r\ni = BYTES_PER_MPI_LIMB - nbytes % BYTES_PER_MPI_LIMB;\r\ni %= BYTES_PER_MPI_LIMB;\r\nfor (j = nlimbs; j > 0; j--) {\r\na = 0;\r\nfor (; i < BYTES_PER_MPI_LIMB; i++) {\r\na <<= 8;\r\na |= *buffer++;\r\n}\r\ni = 0;\r\nval->d[j - 1] = a;\r\n}\r\n}\r\nreturn val;\r\n}\r\nMPI mpi_read_from_buffer(const void *xbuffer, unsigned *ret_nread)\r\n{\r\nconst uint8_t *buffer = xbuffer;\r\nint i, j;\r\nunsigned nbits, nbytes, nlimbs, nread = 0;\r\nmpi_limb_t a;\r\nMPI val = NULL;\r\nif (*ret_nread < 2)\r\ngoto leave;\r\nnbits = buffer[0] << 8 | buffer[1];\r\nif (nbits > MAX_EXTERN_MPI_BITS) {\r\npr_info("MPI: mpi too large (%u bits)\n", nbits);\r\ngoto leave;\r\n}\r\nbuffer += 2;\r\nnread = 2;\r\nnbytes = (nbits + 7) / 8;\r\nnlimbs = (nbytes + BYTES_PER_MPI_LIMB - 1) / BYTES_PER_MPI_LIMB;\r\nval = mpi_alloc(nlimbs);\r\nif (!val)\r\nreturn NULL;\r\ni = BYTES_PER_MPI_LIMB - nbytes % BYTES_PER_MPI_LIMB;\r\ni %= BYTES_PER_MPI_LIMB;\r\nval->nbits = nbits;\r\nj = val->nlimbs = nlimbs;\r\nval->sign = 0;\r\nfor (; j > 0; j--) {\r\na = 0;\r\nfor (; i < BYTES_PER_MPI_LIMB; i++) {\r\nif (++nread > *ret_nread) {\r\nprintk\r\n("MPI: mpi larger than buffer nread=%d ret_nread=%d\n",\r\nnread, *ret_nread);\r\ngoto leave;\r\n}\r\na <<= 8;\r\na |= *buffer++;\r\n}\r\ni = 0;\r\nval->d[j - 1] = a;\r\n}\r\nleave:\r\n*ret_nread = nread;\r\nreturn val;\r\n}\r\nvoid *mpi_get_buffer(MPI a, unsigned *nbytes, int *sign)\r\n{\r\nuint8_t *p, *buffer;\r\nmpi_limb_t alimb;\r\nint i;\r\nunsigned int n;\r\nif (sign)\r\n*sign = a->sign;\r\n*nbytes = n = a->nlimbs * BYTES_PER_MPI_LIMB;\r\nif (!n)\r\nn++;\r\np = buffer = kmalloc(n, GFP_KERNEL);\r\nif (!p)\r\nreturn NULL;\r\nfor (i = a->nlimbs - 1; i >= 0; i--) {\r\nalimb = a->d[i];\r\n#if BYTES_PER_MPI_LIMB == 4\r\n*p++ = alimb >> 24;\r\n*p++ = alimb >> 16;\r\n*p++ = alimb >> 8;\r\n*p++ = alimb;\r\n#elif BYTES_PER_MPI_LIMB == 8\r\n*p++ = alimb >> 56;\r\n*p++ = alimb >> 48;\r\n*p++ = alimb >> 40;\r\n*p++ = alimb >> 32;\r\n*p++ = alimb >> 24;\r\n*p++ = alimb >> 16;\r\n*p++ = alimb >> 8;\r\n*p++ = alimb;\r\n#else\r\n#error please implement for this limb size.\r\n#endif\r\n}\r\nfor (p = buffer; !*p && *nbytes; p++, --*nbytes)\r\n;\r\nif (p != buffer)\r\nmemmove(buffer, p, *nbytes);\r\nreturn buffer;\r\n}\r\nint mpi_set_buffer(MPI a, const void *xbuffer, unsigned nbytes, int sign)\r\n{\r\nconst uint8_t *buffer = xbuffer, *p;\r\nmpi_limb_t alimb;\r\nint nlimbs;\r\nint i;\r\nnlimbs = (nbytes + BYTES_PER_MPI_LIMB - 1) / BYTES_PER_MPI_LIMB;\r\nif (RESIZE_IF_NEEDED(a, nlimbs) < 0)\r\nreturn -ENOMEM;\r\na->sign = sign;\r\nfor (i = 0, p = buffer + nbytes - 1; p >= buffer + BYTES_PER_MPI_LIMB;) {\r\n#if BYTES_PER_MPI_LIMB == 4\r\nalimb = (mpi_limb_t) *p--;\r\nalimb |= (mpi_limb_t) *p-- << 8;\r\nalimb |= (mpi_limb_t) *p-- << 16;\r\nalimb |= (mpi_limb_t) *p-- << 24;\r\n#elif BYTES_PER_MPI_LIMB == 8\r\nalimb = (mpi_limb_t) *p--;\r\nalimb |= (mpi_limb_t) *p-- << 8;\r\nalimb |= (mpi_limb_t) *p-- << 16;\r\nalimb |= (mpi_limb_t) *p-- << 24;\r\nalimb |= (mpi_limb_t) *p-- << 32;\r\nalimb |= (mpi_limb_t) *p-- << 40;\r\nalimb |= (mpi_limb_t) *p-- << 48;\r\nalimb |= (mpi_limb_t) *p-- << 56;\r\n#else\r\n#error please implement for this limb size.\r\n#endif\r\na->d[i++] = alimb;\r\n}\r\nif (p >= buffer) {\r\n#if BYTES_PER_MPI_LIMB == 4\r\nalimb = *p--;\r\nif (p >= buffer)\r\nalimb |= (mpi_limb_t) *p-- << 8;\r\nif (p >= buffer)\r\nalimb |= (mpi_limb_t) *p-- << 16;\r\nif (p >= buffer)\r\nalimb |= (mpi_limb_t) *p-- << 24;\r\n#elif BYTES_PER_MPI_LIMB == 8\r\nalimb = (mpi_limb_t) *p--;\r\nif (p >= buffer)\r\nalimb |= (mpi_limb_t) *p-- << 8;\r\nif (p >= buffer)\r\nalimb |= (mpi_limb_t) *p-- << 16;\r\nif (p >= buffer)\r\nalimb |= (mpi_limb_t) *p-- << 24;\r\nif (p >= buffer)\r\nalimb |= (mpi_limb_t) *p-- << 32;\r\nif (p >= buffer)\r\nalimb |= (mpi_limb_t) *p-- << 40;\r\nif (p >= buffer)\r\nalimb |= (mpi_limb_t) *p-- << 48;\r\nif (p >= buffer)\r\nalimb |= (mpi_limb_t) *p-- << 56;\r\n#else\r\n#error please implement for this limb size.\r\n#endif\r\na->d[i++] = alimb;\r\n}\r\na->nlimbs = i;\r\nif (i != nlimbs) {\r\npr_emerg("MPI: mpi_set_buffer: Assertion failed (%d != %d)", i,\r\nnlimbs);\r\nBUG();\r\n}\r\nreturn 0;\r\n}

int\r\nnouveau_therm_fan_get(struct nouveau_therm *therm)\r\n{\r\nstruct nouveau_therm_priv *priv = (void *)therm;\r\nstruct nouveau_gpio *gpio = nouveau_gpio(therm);\r\nstruct dcb_gpio_func func;\r\nint card_type = nv_device(therm)->card_type;\r\nu32 divs, duty;\r\nint ret;\r\nif (!priv->fan.pwm_get)\r\nreturn -ENODEV;\r\nret = gpio->find(gpio, 0, DCB_GPIO_PWM_FAN, 0xff, &func);\r\nif (ret == 0) {\r\nret = priv->fan.pwm_get(therm, func.line, &divs, &duty);\r\nif (ret == 0 && divs) {\r\ndivs = max(divs, duty);\r\nif (card_type <= NV_40 || (func.log[0] & 1))\r\nduty = divs - duty;\r\nreturn (duty * 100) / divs;\r\n}\r\nreturn gpio->get(gpio, 0, func.func, func.line) * 100;\r\n}\r\nreturn -ENODEV;\r\n}\r\nint\r\nnouveau_therm_fan_set(struct nouveau_therm *therm, int percent)\r\n{\r\nstruct nouveau_therm_priv *priv = (void *)therm;\r\nstruct nouveau_gpio *gpio = nouveau_gpio(therm);\r\nstruct dcb_gpio_func func;\r\nint card_type = nv_device(therm)->card_type;\r\nu32 divs, duty;\r\nint ret;\r\nif (priv->fan.mode == FAN_CONTROL_NONE)\r\nreturn -EINVAL;\r\nif (!priv->fan.pwm_set)\r\nreturn -ENODEV;\r\nif (percent < priv->bios_fan.min_duty)\r\npercent = priv->bios_fan.min_duty;\r\nif (percent > priv->bios_fan.max_duty)\r\npercent = priv->bios_fan.max_duty;\r\nret = gpio->find(gpio, 0, DCB_GPIO_PWM_FAN, 0xff, &func);\r\nif (ret == 0) {\r\ndivs = priv->bios_perf_fan.pwm_divisor;\r\nif (priv->bios_fan.pwm_freq) {\r\ndivs = 1;\r\nif (priv->fan.pwm_clock)\r\ndivs = priv->fan.pwm_clock(therm);\r\ndivs /= priv->bios_fan.pwm_freq;\r\n}\r\nduty = ((divs * percent) + 99) / 100;\r\nif (card_type <= NV_40 || (func.log[0] & 1))\r\nduty = divs - duty;\r\nret = priv->fan.pwm_set(therm, func.line, divs, duty);\r\nreturn ret;\r\n}\r\nreturn -ENODEV;\r\n}\r\nint\r\nnouveau_therm_fan_sense(struct nouveau_therm *therm)\r\n{\r\nstruct nouveau_timer *ptimer = nouveau_timer(therm);\r\nstruct nouveau_gpio *gpio = nouveau_gpio(therm);\r\nstruct dcb_gpio_func func;\r\nu32 cycles, cur, prev;\r\nu64 start, end, tach;\r\nif (gpio->find(gpio, 0, DCB_GPIO_FAN_SENSE, 0xff, &func))\r\nreturn -ENODEV;\r\nstart = ptimer->read(ptimer);\r\nprev = gpio->get(gpio, 0, func.func, func.line);\r\ncycles = 0;\r\ndo {\r\nusleep_range(500, 1000);\r\ncur = gpio->get(gpio, 0, func.func, func.line);\r\nif (prev != cur) {\r\nif (!start)\r\nstart = ptimer->read(ptimer);\r\ncycles++;\r\nprev = cur;\r\n}\r\n} while (cycles < 5 && ptimer->read(ptimer) - start < 250000000);\r\nend = ptimer->read(ptimer);\r\nif (cycles == 5) {\r\ntach = (u64)60000000000ULL;\r\ndo_div(tach, (end - start));\r\nreturn tach;\r\n} else\r\nreturn 0;\r\n}\r\nint\r\nnouveau_therm_fan_set_mode(struct nouveau_therm *therm,\r\nenum nouveau_therm_fan_mode mode)\r\n{\r\nstruct nouveau_therm_priv *priv = (void *)therm;\r\nif (priv->fan.mode == mode)\r\nreturn 0;\r\nif (mode < FAN_CONTROL_NONE || mode >= FAN_CONTROL_NR)\r\nreturn -EINVAL;\r\nswitch (mode)\r\n{\r\ncase FAN_CONTROL_NONE:\r\nnv_info(therm, "switch fan to no-control mode\n");\r\nbreak;\r\ncase FAN_CONTROL_MANUAL:\r\nnv_info(therm, "switch fan to manual mode\n");\r\nbreak;\r\ncase FAN_CONTROL_NR:\r\nbreak;\r\n}\r\npriv->fan.mode = mode;\r\nreturn 0;\r\n}\r\nint\r\nnouveau_therm_fan_user_get(struct nouveau_therm *therm)\r\n{\r\nreturn nouveau_therm_fan_get(therm);\r\n}\r\nint\r\nnouveau_therm_fan_user_set(struct nouveau_therm *therm, int percent)\r\n{\r\nstruct nouveau_therm_priv *priv = (void *)therm;\r\nif (priv->fan.mode != FAN_CONTROL_MANUAL)\r\nreturn -EINVAL;\r\nreturn nouveau_therm_fan_set(therm, percent);\r\n}\r\nvoid\r\nnouveau_therm_fan_set_defaults(struct nouveau_therm *therm)\r\n{\r\nstruct nouveau_therm_priv *priv = (void *)therm;\r\npriv->bios_fan.pwm_freq = 0;\r\npriv->bios_fan.min_duty = 0;\r\npriv->bios_fan.max_duty = 100;\r\n}\r\nstatic void\r\nnouveau_therm_fan_safety_checks(struct nouveau_therm *therm)\r\n{\r\nstruct nouveau_therm_priv *priv = (void *)therm;\r\nif (priv->bios_fan.min_duty > 100)\r\npriv->bios_fan.min_duty = 100;\r\nif (priv->bios_fan.max_duty > 100)\r\npriv->bios_fan.max_duty = 100;\r\nif (priv->bios_fan.min_duty > priv->bios_fan.max_duty)\r\npriv->bios_fan.min_duty = priv->bios_fan.max_duty;\r\n}\r\nint nouveau_fan_pwm_clock_dummy(struct nouveau_therm *therm)\r\n{\r\nreturn 1;\r\n}\r\nint\r\nnouveau_therm_fan_ctor(struct nouveau_therm *therm)\r\n{\r\nstruct nouveau_therm_priv *priv = (void *)therm;\r\nstruct nouveau_bios *bios = nouveau_bios(therm);\r\nnouveau_therm_fan_set_defaults(therm);\r\nnvbios_perf_fan_parse(bios, &priv->bios_perf_fan);\r\nif (nvbios_therm_fan_parse(bios, &priv->bios_fan))\r\nnv_error(therm, "parsing the thermal table failed\n");\r\nnouveau_therm_fan_safety_checks(therm);\r\nnouveau_therm_fan_set_mode(therm, FAN_CONTROL_NONE);\r\nreturn 0;\r\n}

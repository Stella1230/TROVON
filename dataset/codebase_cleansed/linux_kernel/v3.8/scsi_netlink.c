static void\r\nscsi_nl_rcv_msg(struct sk_buff *skb)\r\n{\r\nstruct nlmsghdr *nlh;\r\nstruct scsi_nl_hdr *hdr;\r\nu32 rlen;\r\nint err, tport;\r\nwhile (skb->len >= NLMSG_SPACE(0)) {\r\nerr = 0;\r\nnlh = nlmsg_hdr(skb);\r\nif ((nlh->nlmsg_len < (sizeof(*nlh) + sizeof(*hdr))) ||\r\n(skb->len < nlh->nlmsg_len)) {\r\nprintk(KERN_WARNING "%s: discarding partial skb\n",\r\n__func__);\r\nreturn;\r\n}\r\nrlen = NLMSG_ALIGN(nlh->nlmsg_len);\r\nif (rlen > skb->len)\r\nrlen = skb->len;\r\nif (nlh->nlmsg_type != SCSI_TRANSPORT_MSG) {\r\nerr = -EBADMSG;\r\ngoto next_msg;\r\n}\r\nhdr = NLMSG_DATA(nlh);\r\nif ((hdr->version != SCSI_NL_VERSION) ||\r\n(hdr->magic != SCSI_NL_MAGIC)) {\r\nerr = -EPROTOTYPE;\r\ngoto next_msg;\r\n}\r\nif (!capable(CAP_SYS_ADMIN)) {\r\nerr = -EPERM;\r\ngoto next_msg;\r\n}\r\nif (nlh->nlmsg_len < (sizeof(*nlh) + hdr->msglen)) {\r\nprintk(KERN_WARNING "%s: discarding partial message\n",\r\n__func__);\r\ngoto next_msg;\r\n}\r\ntport = hdr->transport;\r\nif (tport == SCSI_NL_TRANSPORT) {\r\nswitch (hdr->msgtype) {\r\ncase SCSI_NL_SHOST_VENDOR:\r\nerr = -ESRCH;\r\nbreak;\r\ndefault:\r\nerr = -EBADR;\r\nbreak;\r\n}\r\nif (err)\r\nprintk(KERN_WARNING "%s: Msgtype %d failed - err %d\n",\r\n__func__, hdr->msgtype, err);\r\n}\r\nelse\r\nerr = -ENOENT;\r\nnext_msg:\r\nif ((err) || (nlh->nlmsg_flags & NLM_F_ACK))\r\nnetlink_ack(skb, nlh, err);\r\nskb_pull(skb, rlen);\r\n}\r\n}\r\nvoid\r\nscsi_netlink_init(void)\r\n{\r\nstruct netlink_kernel_cfg cfg = {\r\n.input = scsi_nl_rcv_msg,\r\n.groups = SCSI_NL_GRP_CNT,\r\n};\r\nscsi_nl_sock = netlink_kernel_create(&init_net, NETLINK_SCSITRANSPORT,\r\n&cfg);\r\nif (!scsi_nl_sock) {\r\nprintk(KERN_ERR "%s: register of receive handler failed\n",\r\n__func__);\r\nreturn;\r\n}\r\nreturn;\r\n}\r\nvoid\r\nscsi_netlink_exit(void)\r\n{\r\nif (scsi_nl_sock) {\r\nnetlink_kernel_release(scsi_nl_sock);\r\n}\r\nreturn;\r\n}

static u16\r\nextdev_table(struct nouveau_bios *bios, u8 *ver, u8 *hdr, u8 *len, u8 *cnt)\r\n{\r\nu8 dcb_ver, dcb_hdr, dcb_cnt, dcb_len;\r\nu16 dcb, extdev = 0;\r\ndcb = dcb_table(bios, &dcb_ver, &dcb_hdr, &dcb_cnt, &dcb_len);\r\nif (!dcb || (dcb_ver != 0x30 && dcb_ver != 0x40))\r\nreturn 0x0000;\r\nextdev = nv_ro16(bios, dcb + 18);\r\nif (!extdev)\r\nreturn 0x0000;\r\n*ver = nv_ro08(bios, extdev + 0);\r\n*hdr = nv_ro08(bios, extdev + 1);\r\n*cnt = nv_ro08(bios, extdev + 2);\r\n*len = nv_ro08(bios, extdev + 3);\r\nreturn extdev + *hdr;\r\n}\r\nu16\r\nnvbios_extdev_entry(struct nouveau_bios *bios, int idx, u8 *ver, u8 *len)\r\n{\r\nu8 hdr, cnt;\r\nu16 extdev = extdev_table(bios, ver, &hdr, len, &cnt);\r\nif (extdev && idx < cnt)\r\nreturn extdev + idx * *len;\r\nreturn 0x0000;\r\n}\r\nstatic void\r\nextdev_parse_entry(struct nouveau_bios *bios, u16 offset,\r\nstruct nvbios_extdev_func *entry)\r\n{\r\nentry->type = nv_ro08(bios, offset + 0);\r\nentry->addr = nv_ro08(bios, offset + 1);\r\nentry->bus = (nv_ro08(bios, offset + 2) >> 4) & 1;\r\n}\r\nint\r\nnvbios_extdev_parse(struct nouveau_bios *bios, int idx,\r\nstruct nvbios_extdev_func *func)\r\n{\r\nu8 ver, len;\r\nu16 entry;\r\nif (!(entry = nvbios_extdev_entry(bios, idx, &ver, &len)))\r\nreturn -EINVAL;\r\nextdev_parse_entry(bios, entry, func);\r\nreturn 0;\r\n}\r\nint\r\nnvbios_extdev_find(struct nouveau_bios *bios, enum nvbios_extdev_type type,\r\nstruct nvbios_extdev_func *func)\r\n{\r\nu8 ver, len, i;\r\nu16 entry;\r\ni = 0;\r\nwhile (!(entry = nvbios_extdev_entry(bios, i++, &ver, &len))) {\r\nextdev_parse_entry(bios, entry, func);\r\nif (func->type == type)\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}

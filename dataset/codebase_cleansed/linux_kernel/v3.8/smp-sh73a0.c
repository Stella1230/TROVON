static void __iomem *scu_base_addr(void)\r\n{\r\nreturn (void __iomem *)0xf0000000;\r\n}\r\nvoid __init sh73a0_register_twd(void)\r\n{\r\ntwd_local_timer_register(&twd_local_timer);\r\n}\r\nstatic void modify_scu_cpu_psr(unsigned long set, unsigned long clr)\r\n{\r\nvoid __iomem *scu_base = scu_base_addr();\r\nspin_lock(&scu_lock);\r\ntmp = __raw_readl(scu_base + 8);\r\ntmp &= ~clr;\r\ntmp |= set;\r\nspin_unlock(&scu_lock);\r\n__raw_writel(tmp, scu_base + 8);\r\n}\r\nstatic unsigned int __init sh73a0_get_core_count(void)\r\n{\r\nvoid __iomem *scu_base = scu_base_addr();\r\nreturn scu_get_core_count(scu_base);\r\n}\r\nstatic void __cpuinit sh73a0_secondary_init(unsigned int cpu)\r\n{\r\ngic_secondary_init(0);\r\n}\r\nstatic int __cpuinit sh73a0_boot_secondary(unsigned int cpu, struct task_struct *idle)\r\n{\r\ncpu = cpu_logical_map(cpu);\r\nmodify_scu_cpu_psr(0, 3 << (cpu * 8));\r\nif (((__raw_readl(PSTR) >> (4 * cpu)) & 3) == 3)\r\n__raw_writel(1 << cpu, WUPCR);\r\nelse\r\n__raw_writel(1 << cpu, SRESCR);\r\nreturn 0;\r\n}\r\nstatic void __init sh73a0_smp_prepare_cpus(unsigned int max_cpus)\r\n{\r\nint cpu = cpu_logical_map(0);\r\nscu_enable(scu_base_addr());\r\n__raw_writel(0, APARMBAREA);\r\n__raw_writel(__pa(shmobile_secondary_vector), SBAR);\r\nmodify_scu_cpu_psr(0, 3 << (cpu * 8));\r\n}\r\nstatic void __init sh73a0_smp_init_cpus(void)\r\n{\r\nunsigned int ncores = sh73a0_get_core_count();\r\nshmobile_smp_init_cpus(ncores);\r\n}\r\nstatic int __maybe_unused sh73a0_cpu_kill(unsigned int cpu)\r\n{\r\nint k;\r\nfor (k = 0; k < 1000; k++) {\r\nif (shmobile_cpu_is_dead(cpu))\r\nreturn 1;\r\nmdelay(1);\r\n}\r\nreturn 0;\r\n}

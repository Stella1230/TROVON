static u16 bonito_fpga_read(u32 offset)\r\n{\r\nreturn __raw_readw(IOMEM(0xf0003000) + offset);\r\n}\r\nstatic void bonito_fpga_write(u32 offset, u16 val)\r\n{\r\n__raw_writew(val, IOMEM(0xf0003000) + offset);\r\n}\r\nstatic void bonito_fpga_irq_disable(struct irq_data *data)\r\n{\r\nunsigned int irq = data->irq;\r\nu32 addr = (irq < 1016) ? IRQMR0 : IRQMR1;\r\nint shift = irq % 16;\r\nbonito_fpga_write(addr, bonito_fpga_read(addr) | (1 << shift));\r\n}\r\nstatic void bonito_fpga_irq_enable(struct irq_data *data)\r\n{\r\nunsigned int irq = data->irq;\r\nu32 addr = (irq < 1016) ? IRQMR0 : IRQMR1;\r\nint shift = irq % 16;\r\nbonito_fpga_write(addr, bonito_fpga_read(addr) & ~(1 << shift));\r\n}\r\nstatic void bonito_fpga_irq_demux(unsigned int irq, struct irq_desc *desc)\r\n{\r\nu32 val = bonito_fpga_read(IRQSR1) << 16 |\r\nbonito_fpga_read(IRQSR0);\r\nu32 mask = bonito_fpga_read(IRQMR1) << 16 |\r\nbonito_fpga_read(IRQMR0);\r\nint i;\r\nval &= ~mask;\r\nfor (i = 0; i < 32; i++) {\r\nif (!(val & (1 << i)))\r\ncontinue;\r\ngeneric_handle_irq(FPGA_IRQ_BASE + i);\r\n}\r\n}\r\nstatic void bonito_fpga_init(void)\r\n{\r\nint i;\r\nbonito_fpga_write(IRQMR0, 0xffff);\r\nbonito_fpga_write(IRQMR1, 0xffff);\r\nbonito_fpga_write(DEVRSTCR1,\r\n(1 << 2));\r\nfor (i = FPGA_IRQ_BASE; i < FPGA_IRQ_BASE + 32; i++) {\r\nirq_set_chip_and_handler_name(i, &bonito_fpga_irq_chip,\r\nhandle_level_irq, "level");\r\nset_irq_flags(i, IRQF_VALID);\r\n}\r\nirq_set_chained_handler(evt2irq(0x0340), bonito_fpga_irq_demux);\r\nirq_set_irq_type(evt2irq(0x0340), IRQ_TYPE_LEVEL_LOW);\r\n}\r\nstatic int __init pmic_init(void)\r\n{\r\nstruct i2c_adapter *a = i2c_get_adapter(0);\r\nstruct i2c_msg msg;\r\n__u8 buf[2];\r\nint i, ret;\r\nif (!pmic_settings)\r\nreturn 0;\r\nif (!a)\r\nreturn 0;\r\nmsg.addr = 0x46;\r\nmsg.buf = buf;\r\nmsg.len = 2;\r\nmsg.flags = 0;\r\nfor (i = 0; ; i += 2) {\r\nbuf[0] = pmic_settings[i + 0];\r\nbuf[1] = pmic_settings[i + 1];\r\nif ((0xff == buf[0]) && (0xff == buf[1]))\r\nbreak;\r\nret = i2c_transfer(a, &msg, 1);\r\nif (ret < 0) {\r\npr_err("i2c transfer fail\n");\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void __init bonito_map_io(void)\r\n{\r\nr8a7740_map_io();\r\niotable_init(bonito_io_desc, ARRAY_SIZE(bonito_io_desc));\r\n}\r\nstatic void __init bonito_init(void)\r\n{\r\nu16 val;\r\nregulator_register_fixed(0, dummy_supplies, ARRAY_SIZE(dummy_supplies));\r\nr8a7740_pinmux_init();\r\nbonito_fpga_init();\r\npmic_settings = pmic_do_2A;\r\n#ifdef CONFIG_CACHE_L2X0\r\nl2x0_init(IOMEM(0xf0002000), 0x40440000, 0x82000fff);\r\n#endif\r\nr8a7740_add_standard_devices();\r\nplatform_add_devices(bonito_core_devices,\r\nARRAY_SIZE(bonito_core_devices));\r\ngpio_request(GPIO_PORT176, NULL);\r\ngpio_direction_input(GPIO_PORT176);\r\nif (!gpio_get_value(GPIO_PORT176)) {\r\nu16 bsw2;\r\nu16 bsw3;\r\nu16 bsw4;\r\ngpio_request(GPIO_FN_CS5B, NULL);\r\ngpio_request(GPIO_FN_CS6A, NULL);\r\ngpio_request(GPIO_FN_CS5A_PORT105, NULL);\r\ngpio_request(GPIO_FN_IRQ10, NULL);\r\nval = bonito_fpga_read(BVERR);\r\npr_info("bonito version: cpu %02x, base %02x\n",\r\n((val >> 8) & 0xFF),\r\n((val >> 0) & 0xFF));\r\nbsw2 = bonito_fpga_read(BUSSWMR2);\r\nbsw3 = bonito_fpga_read(BUSSWMR3);\r\nbsw4 = bonito_fpga_read(BUSSWMR4);\r\nif (BIT_OFF(bsw2, 1) &&\r\nBIT_OFF(bsw3, 9) &&\r\nBIT_OFF(bsw4, 4)) {\r\ngpio_request(GPIO_FN_SCIFA5_TXD_PORT91, NULL);\r\ngpio_request(GPIO_FN_SCIFA5_RXD_PORT92, NULL);\r\n}\r\nif (BIT_ON(bsw2, 3) &&\r\nBIT_ON(bsw2, 2)) {\r\ngpio_request(GPIO_FN_LCDC0_SELECT, NULL);\r\ngpio_request(GPIO_FN_LCD0_D0, NULL);\r\ngpio_request(GPIO_FN_LCD0_D1, NULL);\r\ngpio_request(GPIO_FN_LCD0_D2, NULL);\r\ngpio_request(GPIO_FN_LCD0_D3, NULL);\r\ngpio_request(GPIO_FN_LCD0_D4, NULL);\r\ngpio_request(GPIO_FN_LCD0_D5, NULL);\r\ngpio_request(GPIO_FN_LCD0_D6, NULL);\r\ngpio_request(GPIO_FN_LCD0_D7, NULL);\r\ngpio_request(GPIO_FN_LCD0_D8, NULL);\r\ngpio_request(GPIO_FN_LCD0_D9, NULL);\r\ngpio_request(GPIO_FN_LCD0_D10, NULL);\r\ngpio_request(GPIO_FN_LCD0_D11, NULL);\r\ngpio_request(GPIO_FN_LCD0_D12, NULL);\r\ngpio_request(GPIO_FN_LCD0_D13, NULL);\r\ngpio_request(GPIO_FN_LCD0_D14, NULL);\r\ngpio_request(GPIO_FN_LCD0_D15, NULL);\r\ngpio_request(GPIO_FN_LCD0_D16, NULL);\r\ngpio_request(GPIO_FN_LCD0_D17, NULL);\r\ngpio_request(GPIO_FN_LCD0_D18_PORT163, NULL);\r\ngpio_request(GPIO_FN_LCD0_D19_PORT162, NULL);\r\ngpio_request(GPIO_FN_LCD0_D20_PORT161, NULL);\r\ngpio_request(GPIO_FN_LCD0_D21_PORT158, NULL);\r\ngpio_request(GPIO_FN_LCD0_D22_PORT160, NULL);\r\ngpio_request(GPIO_FN_LCD0_D23_PORT159, NULL);\r\ngpio_request(GPIO_FN_LCD0_DCK, NULL);\r\ngpio_request(GPIO_FN_LCD0_VSYN, NULL);\r\ngpio_request(GPIO_FN_LCD0_HSYN, NULL);\r\ngpio_request(GPIO_FN_LCD0_DISP, NULL);\r\ngpio_request(GPIO_FN_LCD0_LCLK_PORT165, NULL);\r\ngpio_request(GPIO_PORT61, NULL);\r\ngpio_direction_output(GPIO_PORT61, 1);\r\nbonito_fpga_write(LCDCR, 1);\r\n__raw_writew(0x00FF , VCCQ1LCDCR);\r\n__raw_writew(0xFFFF , VCCQ1CR);\r\n}\r\nplatform_add_devices(bonito_base_devices,\r\nARRAY_SIZE(bonito_base_devices));\r\n}\r\n}\r\nstatic void __init bonito_earlytimer_init(void)\r\n{\r\nu16 val;\r\nu8 md_ck = 0;\r\nval = bonito_fpga_read(A1MDSR);\r\nif (val & (1 << 10))\r\nmd_ck |= MD_CK2;\r\nif (val & (1 << 9))\r\nmd_ck |= MD_CK1;\r\nif (val & (1 << 8))\r\nmd_ck |= MD_CK0;\r\nr8a7740_clock_init(md_ck);\r\nshmobile_earlytimer_init();\r\n}\r\nstatic void __init bonito_add_early_devices(void)\r\n{\r\nr8a7740_add_early_devices();\r\nshmobile_timer.init = bonito_earlytimer_init;\r\n}

static void\r\njensen_local_enable(struct irq_data *d)\r\n{\r\nif (d->irq == 7)\r\ni8259a_enable_irq(d);\r\n}\r\nstatic void\r\njensen_local_disable(struct irq_data *d)\r\n{\r\nif (d->irq == 7)\r\ni8259a_disable_irq(d);\r\n}\r\nstatic void\r\njensen_local_mask_ack(struct irq_data *d)\r\n{\r\nif (d->irq == 7)\r\ni8259a_mask_and_ack_irq(d);\r\n}\r\nstatic void\r\njensen_device_interrupt(unsigned long vector)\r\n{\r\nint irq;\r\nswitch (vector) {\r\ncase 0x660:\r\nprintk("Whee.. NMI received. Probable hardware error\n");\r\nprintk("61=%02x, 461=%02x\n", inb(0x61), inb(0x461));\r\nreturn;\r\ncase 0x900: irq = 4; break;\r\ncase 0x920: irq = 3; break;\r\ncase 0x980: irq = 1; break;\r\ncase 0x990: irq = 9; break;\r\ndefault:\r\nif (vector > 0x900) {\r\nprintk("Unknown local interrupt %lx\n", vector);\r\nreturn;\r\n}\r\nirq = (vector - 0x800) >> 4;\r\nif (irq == 1)\r\nirq = 7;\r\nbreak;\r\n}\r\nif (!irq_has_action(irq)) {\r\nif (vector >= 0x900)\r\n{\r\ninb(0x64);\r\ninb(0x60);\r\ninb(0x3fa);\r\ninb(0x2fa);\r\noutb(0x0c, 0x3fc);\r\noutb(0x0c, 0x2fc);\r\noutb(0,0x61);\r\noutb(0,0x461);\r\n}\r\n}\r\n#if 0\r\n{\r\nstatic unsigned int last_msg = 0, last_cc = 0;\r\nstatic int last_irq = -1, count = 0;\r\nunsigned int cc;\r\n__asm __volatile("rpcc %0" : "=r"(cc));\r\n++count;\r\n#define JENSEN_CYCLES_PER_SEC (150000000)\r\nif (cc - last_msg > ((JENSEN_CYCLES_PER_SEC) * 3) ||\r\nirq != last_irq) {\r\nprintk(KERN_CRIT " irq %d count %d cc %u @ %lx\n",\r\nirq, count, cc-last_cc, get_irq_regs()->pc);\r\ncount = 0;\r\nlast_msg = cc;\r\nlast_irq = irq;\r\n}\r\nlast_cc = cc;\r\n}\r\n#endif\r\nhandle_irq(irq);\r\n}\r\nstatic void __init\r\njensen_init_irq(void)\r\n{\r\ninit_i8259a_irqs();\r\nirq_set_chip_and_handler(1, &jensen_local_irq_type, handle_level_irq);\r\nirq_set_chip_and_handler(4, &jensen_local_irq_type, handle_level_irq);\r\nirq_set_chip_and_handler(3, &jensen_local_irq_type, handle_level_irq);\r\nirq_set_chip_and_handler(7, &jensen_local_irq_type, handle_level_irq);\r\nirq_set_chip_and_handler(9, &jensen_local_irq_type, handle_level_irq);\r\ncommon_init_isa_dma();\r\n}\r\nstatic void __init\r\njensen_init_arch(void)\r\n{\r\nstruct pci_controller *hose;\r\n#ifdef CONFIG_PCI\r\nstatic struct pci_dev fake_isa_bridge = { .dma_mask = 0xffffffffUL, };\r\nisa_bridge = &fake_isa_bridge;\r\n#endif\r\npci_isa_hose = hose = alloc_pci_controller();\r\nhose->io_space = &ioport_resource;\r\nhose->mem_space = &iomem_resource;\r\nhose->index = 0;\r\nhose->sparse_mem_base = EISA_MEM - IDENT_ADDR;\r\nhose->dense_mem_base = 0;\r\nhose->sparse_io_base = EISA_IO - IDENT_ADDR;\r\nhose->dense_io_base = 0;\r\nhose->sg_isa = hose->sg_pci = NULL;\r\n__direct_map_base = 0;\r\n__direct_map_size = 0xffffffff;\r\n}\r\nstatic void\r\njensen_machine_check(unsigned long vector, unsigned long la)\r\n{\r\nprintk(KERN_CRIT "Machine check\n");\r\n}

static int asymmetric_key_match(const struct key *key, const void *description)\r\n{\r\nconst struct asymmetric_key_subtype *subtype = asymmetric_key_subtype(key);\r\nconst char *spec = description;\r\nconst char *id, *kid;\r\nptrdiff_t speclen;\r\nsize_t idlen, kidlen;\r\nif (!subtype || !spec || !*spec)\r\nreturn 0;\r\nif (key->description && strcmp(key->description, description) == 0)\r\nreturn 1;\r\nid = strchr(spec, ':');\r\nif (!id)\r\nreturn 0;\r\nspeclen = id - spec;\r\nid++;\r\nkid = asymmetric_key_id(key);\r\nif (!kid)\r\nreturn 0;\r\nidlen = strlen(id);\r\nkidlen = strlen(kid);\r\nif (idlen > kidlen)\r\nreturn 0;\r\nkid += kidlen - idlen;\r\nif (strcasecmp(id, kid) != 0)\r\nreturn 0;\r\nif (speclen == 2 &&\r\nmemcmp(spec, "id", 2) == 0)\r\nreturn 1;\r\nif (speclen == subtype->name_len &&\r\nmemcmp(spec, subtype->name, speclen) == 0)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void asymmetric_key_describe(const struct key *key, struct seq_file *m)\r\n{\r\nconst struct asymmetric_key_subtype *subtype = asymmetric_key_subtype(key);\r\nconst char *kid = asymmetric_key_id(key);\r\nsize_t n;\r\nseq_puts(m, key->description);\r\nif (subtype) {\r\nseq_puts(m, ": ");\r\nsubtype->describe(key, m);\r\nif (kid) {\r\nseq_putc(m, ' ');\r\nn = strlen(kid);\r\nif (n <= 8)\r\nseq_puts(m, kid);\r\nelse\r\nseq_puts(m, kid + n - 8);\r\n}\r\nseq_puts(m, " [");\r\nseq_putc(m, ']');\r\n}\r\n}\r\nstatic int asymmetric_key_preparse(struct key_preparsed_payload *prep)\r\n{\r\nstruct asymmetric_key_parser *parser;\r\nint ret;\r\npr_devel("==>%s()\n", __func__);\r\nif (prep->datalen == 0)\r\nreturn -EINVAL;\r\ndown_read(&asymmetric_key_parsers_sem);\r\nret = -EBADMSG;\r\nlist_for_each_entry(parser, &asymmetric_key_parsers, link) {\r\npr_debug("Trying parser '%s'\n", parser->name);\r\nret = parser->parse(prep);\r\nif (ret != -EBADMSG) {\r\npr_debug("Parser recognised the format (ret %d)\n",\r\nret);\r\nbreak;\r\n}\r\n}\r\nup_read(&asymmetric_key_parsers_sem);\r\npr_devel("<==%s() = %d\n", __func__, ret);\r\nreturn ret;\r\n}\r\nstatic void asymmetric_key_free_preparse(struct key_preparsed_payload *prep)\r\n{\r\nstruct asymmetric_key_subtype *subtype = prep->type_data[0];\r\npr_devel("==>%s()\n", __func__);\r\nif (subtype) {\r\nsubtype->destroy(prep->payload);\r\nmodule_put(subtype->owner);\r\n}\r\nkfree(prep->type_data[1]);\r\nkfree(prep->description);\r\n}\r\nstatic int asymmetric_key_instantiate(struct key *key, struct key_preparsed_payload *prep)\r\n{\r\nint ret;\r\npr_devel("==>%s()\n", __func__);\r\nret = key_payload_reserve(key, prep->quotalen);\r\nif (ret == 0) {\r\nkey->type_data.p[0] = prep->type_data[0];\r\nkey->type_data.p[1] = prep->type_data[1];\r\nkey->payload.data = prep->payload;\r\nprep->type_data[0] = NULL;\r\nprep->type_data[1] = NULL;\r\nprep->payload = NULL;\r\n}\r\npr_devel("<==%s() = %d\n", __func__, ret);\r\nreturn ret;\r\n}\r\nstatic void asymmetric_key_destroy(struct key *key)\r\n{\r\nstruct asymmetric_key_subtype *subtype = asymmetric_key_subtype(key);\r\nif (subtype) {\r\nsubtype->destroy(key->payload.data);\r\nmodule_put(subtype->owner);\r\nkey->type_data.p[0] = NULL;\r\n}\r\nkfree(key->type_data.p[1]);\r\nkey->type_data.p[1] = NULL;\r\n}\r\nint register_asymmetric_key_parser(struct asymmetric_key_parser *parser)\r\n{\r\nstruct asymmetric_key_parser *cursor;\r\nint ret;\r\ndown_write(&asymmetric_key_parsers_sem);\r\nlist_for_each_entry(cursor, &asymmetric_key_parsers, link) {\r\nif (strcmp(cursor->name, parser->name) == 0) {\r\npr_err("Asymmetric key parser '%s' already registered\n",\r\nparser->name);\r\nret = -EEXIST;\r\ngoto out;\r\n}\r\n}\r\nlist_add_tail(&parser->link, &asymmetric_key_parsers);\r\npr_notice("Asymmetric key parser '%s' registered\n", parser->name);\r\nret = 0;\r\nout:\r\nup_write(&asymmetric_key_parsers_sem);\r\nreturn ret;\r\n}\r\nvoid unregister_asymmetric_key_parser(struct asymmetric_key_parser *parser)\r\n{\r\ndown_write(&asymmetric_key_parsers_sem);\r\nlist_del(&parser->link);\r\nup_write(&asymmetric_key_parsers_sem);\r\npr_notice("Asymmetric key parser '%s' unregistered\n", parser->name);\r\n}\r\nstatic int __init asymmetric_key_init(void)\r\n{\r\nreturn register_key_type(&key_type_asymmetric);\r\n}\r\nstatic void __exit asymmetric_key_cleanup(void)\r\n{\r\nunregister_key_type(&key_type_asymmetric);\r\n}

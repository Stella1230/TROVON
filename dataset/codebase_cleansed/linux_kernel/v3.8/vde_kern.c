static void vde_init(struct net_device *dev, void *data)\r\n{\r\nstruct vde_init *init = data;\r\nstruct uml_net_private *pri;\r\nstruct vde_data *vpri;\r\npri = netdev_priv(dev);\r\nvpri = (struct vde_data *) pri->user;\r\nvpri->vde_switch = init->vde_switch;\r\nvpri->descr = init->descr ? init->descr : "UML vde_transport";\r\nvpri->args = NULL;\r\nvpri->conn = NULL;\r\nvpri->dev = dev;\r\nprintk("vde backend - %s, ", vpri->vde_switch ?\r\nvpri->vde_switch : "(default socket)");\r\nvde_init_libstuff(vpri, init);\r\nprintk("\n");\r\n}\r\nstatic int vde_read(int fd, struct sk_buff *skb, struct uml_net_private *lp)\r\n{\r\nstruct vde_data *pri = (struct vde_data *) &lp->user;\r\nif (pri->conn != NULL)\r\nreturn vde_user_read(pri->conn, skb_mac_header(skb),\r\nskb->dev->mtu + ETH_HEADER_OTHER);\r\nprintk(KERN_ERR "vde_read - we have no VDECONN to read from");\r\nreturn -EBADF;\r\n}\r\nstatic int vde_write(int fd, struct sk_buff *skb, struct uml_net_private *lp)\r\n{\r\nstruct vde_data *pri = (struct vde_data *) &lp->user;\r\nif (pri->conn != NULL)\r\nreturn vde_user_write((void *)pri->conn, skb->data,\r\nskb->len);\r\nprintk(KERN_ERR "vde_write - we have no VDECONN to write to");\r\nreturn -EBADF;\r\n}\r\nstatic int vde_setup(char *str, char **mac_out, void *data)\r\n{\r\nstruct vde_init *init = data;\r\nchar *remain, *port_str = NULL, *mode_str = NULL, *last;\r\n*init = ((struct vde_init)\r\n{ .vde_switch = NULL,\r\n.descr = NULL,\r\n.port = 0,\r\n.group = NULL,\r\n.mode = 0 });\r\nremain = split_if_spec(str, &init->vde_switch, mac_out, &port_str,\r\n&init->group, &mode_str, &init->descr, NULL);\r\nif (remain != NULL)\r\nprintk(KERN_WARNING "vde_setup - Ignoring extra data :"\r\n"'%s'\n", remain);\r\nif (port_str != NULL) {\r\ninit->port = simple_strtoul(port_str, &last, 10);\r\nif ((*last != '\0') || (last == port_str)) {\r\nprintk(KERN_ERR "vde_setup - Bad port : '%s'\n",\r\nport_str);\r\nreturn 0;\r\n}\r\n}\r\nif (mode_str != NULL) {\r\ninit->mode = simple_strtoul(mode_str, &last, 8);\r\nif ((*last != '\0') || (last == mode_str)) {\r\nprintk(KERN_ERR "vde_setup - Bad mode : '%s'\n",\r\nmode_str);\r\nreturn 0;\r\n}\r\n}\r\nprintk(KERN_INFO "Configured vde device: %s\n", init->vde_switch ?\r\ninit->vde_switch : "(default socket)");\r\nreturn 1;\r\n}\r\nstatic int register_vde(void)\r\n{\r\nregister_transport(&vde_transport);\r\nreturn 0;\r\n}

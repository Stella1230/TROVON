static void dwmac100_core_init(void __iomem *ioaddr)\r\n{\r\nu32 value = readl(ioaddr + MAC_CONTROL);\r\nwritel((value | MAC_CORE_INIT), ioaddr + MAC_CONTROL);\r\n#ifdef STMMAC_VLAN_TAG_USED\r\nwritel(ETH_P_8021Q, ioaddr + MAC_VLAN1);\r\n#endif\r\n}\r\nstatic void dwmac100_dump_mac_regs(void __iomem *ioaddr)\r\n{\r\npr_info("\t----------------------------------------------\n"\r\n"\t DWMAC 100 CSR (base addr = 0x%p)\n"\r\n"\t----------------------------------------------\n",\r\nioaddr);\r\npr_info("\tcontrol reg (offset 0x%x): 0x%08x\n", MAC_CONTROL,\r\nreadl(ioaddr + MAC_CONTROL));\r\npr_info("\taddr HI (offset 0x%x): 0x%08x\n ", MAC_ADDR_HIGH,\r\nreadl(ioaddr + MAC_ADDR_HIGH));\r\npr_info("\taddr LO (offset 0x%x): 0x%08x\n", MAC_ADDR_LOW,\r\nreadl(ioaddr + MAC_ADDR_LOW));\r\npr_info("\tmulticast hash HI (offset 0x%x): 0x%08x\n",\r\nMAC_HASH_HIGH, readl(ioaddr + MAC_HASH_HIGH));\r\npr_info("\tmulticast hash LO (offset 0x%x): 0x%08x\n",\r\nMAC_HASH_LOW, readl(ioaddr + MAC_HASH_LOW));\r\npr_info("\tflow control (offset 0x%x): 0x%08x\n",\r\nMAC_FLOW_CTRL, readl(ioaddr + MAC_FLOW_CTRL));\r\npr_info("\tVLAN1 tag (offset 0x%x): 0x%08x\n", MAC_VLAN1,\r\nreadl(ioaddr + MAC_VLAN1));\r\npr_info("\tVLAN2 tag (offset 0x%x): 0x%08x\n", MAC_VLAN2,\r\nreadl(ioaddr + MAC_VLAN2));\r\n}\r\nstatic int dwmac100_rx_ipc_enable(void __iomem *ioaddr)\r\n{\r\nreturn 0;\r\n}\r\nstatic int dwmac100_irq_status(void __iomem *ioaddr)\r\n{\r\nreturn 0;\r\n}\r\nstatic void dwmac100_set_umac_addr(void __iomem *ioaddr, unsigned char *addr,\r\nunsigned int reg_n)\r\n{\r\nstmmac_set_mac_addr(ioaddr, addr, MAC_ADDR_HIGH, MAC_ADDR_LOW);\r\n}\r\nstatic void dwmac100_get_umac_addr(void __iomem *ioaddr, unsigned char *addr,\r\nunsigned int reg_n)\r\n{\r\nstmmac_get_mac_addr(ioaddr, addr, MAC_ADDR_HIGH, MAC_ADDR_LOW);\r\n}\r\nstatic void dwmac100_set_filter(struct net_device *dev, int id)\r\n{\r\nvoid __iomem *ioaddr = (void __iomem *) dev->base_addr;\r\nu32 value = readl(ioaddr + MAC_CONTROL);\r\nif (dev->flags & IFF_PROMISC) {\r\nvalue |= MAC_CONTROL_PR;\r\nvalue &= ~(MAC_CONTROL_PM | MAC_CONTROL_IF | MAC_CONTROL_HO |\r\nMAC_CONTROL_HP);\r\n} else if ((netdev_mc_count(dev) > HASH_TABLE_SIZE)\r\n|| (dev->flags & IFF_ALLMULTI)) {\r\nvalue |= MAC_CONTROL_PM;\r\nvalue &= ~(MAC_CONTROL_PR | MAC_CONTROL_IF | MAC_CONTROL_HO);\r\nwritel(0xffffffff, ioaddr + MAC_HASH_HIGH);\r\nwritel(0xffffffff, ioaddr + MAC_HASH_LOW);\r\n} else if (netdev_mc_empty(dev)) {\r\nvalue &= ~(MAC_CONTROL_PM | MAC_CONTROL_PR | MAC_CONTROL_IF |\r\nMAC_CONTROL_HO | MAC_CONTROL_HP);\r\n} else {\r\nu32 mc_filter[2];\r\nstruct netdev_hw_addr *ha;\r\nvalue |= MAC_CONTROL_HP;\r\nvalue &= ~(MAC_CONTROL_PM | MAC_CONTROL_PR |\r\nMAC_CONTROL_IF | MAC_CONTROL_HO);\r\nmemset(mc_filter, 0, sizeof(mc_filter));\r\nnetdev_for_each_mc_addr(ha, dev) {\r\nint bit_nr =\r\nether_crc(ETH_ALEN, ha->addr) >> 26;\r\nmc_filter[bit_nr >> 5] |= 1 << (bit_nr & 31);\r\n}\r\nwritel(mc_filter[0], ioaddr + MAC_HASH_LOW);\r\nwritel(mc_filter[1], ioaddr + MAC_HASH_HIGH);\r\n}\r\nwritel(value, ioaddr + MAC_CONTROL);\r\nCHIP_DBG(KERN_INFO "%s: CTRL reg: 0x%08x Hash regs: "\r\n"HI 0x%08x, LO 0x%08x\n",\r\n__func__, readl(ioaddr + MAC_CONTROL),\r\nreadl(ioaddr + MAC_HASH_HIGH), readl(ioaddr + MAC_HASH_LOW));\r\n}\r\nstatic void dwmac100_flow_ctrl(void __iomem *ioaddr, unsigned int duplex,\r\nunsigned int fc, unsigned int pause_time)\r\n{\r\nunsigned int flow = MAC_FLOW_CTRL_ENABLE;\r\nif (duplex)\r\nflow |= (pause_time << MAC_FLOW_CTRL_PT_SHIFT);\r\nwritel(flow, ioaddr + MAC_FLOW_CTRL);\r\n}\r\nstatic void dwmac100_pmt(void __iomem *ioaddr, unsigned long mode)\r\n{\r\nreturn;\r\n}\r\nstruct mac_device_info *dwmac100_setup(void __iomem *ioaddr)\r\n{\r\nstruct mac_device_info *mac;\r\nmac = kzalloc(sizeof(const struct mac_device_info), GFP_KERNEL);\r\nif (!mac)\r\nreturn NULL;\r\npr_info("\tDWMAC100\n");\r\nmac->mac = &dwmac100_ops;\r\nmac->dma = &dwmac100_dma_ops;\r\nmac->link.port = MAC_CONTROL_PS;\r\nmac->link.duplex = MAC_CONTROL_F;\r\nmac->link.speed = 0;\r\nmac->mii.addr = MAC_MII_ADDR;\r\nmac->mii.data = MAC_MII_DATA;\r\nmac->synopsys_uid = 0;\r\nreturn mac;\r\n}

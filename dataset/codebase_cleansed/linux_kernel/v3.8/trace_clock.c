u64 notrace trace_clock_local(void)\r\n{\r\nu64 clock;\r\npreempt_disable_notrace();\r\nclock = sched_clock();\r\npreempt_enable_notrace();\r\nreturn clock;\r\n}\r\nu64 notrace trace_clock(void)\r\n{\r\nreturn local_clock();\r\n}\r\nu64 notrace trace_clock_global(void)\r\n{\r\nunsigned long flags;\r\nint this_cpu;\r\nu64 now;\r\nlocal_irq_save(flags);\r\nthis_cpu = raw_smp_processor_id();\r\nnow = cpu_clock(this_cpu);\r\nif (unlikely(in_nmi()))\r\ngoto out;\r\narch_spin_lock(&trace_clock_struct.lock);\r\nif ((s64)(now - trace_clock_struct.prev_time) < 0)\r\nnow = trace_clock_struct.prev_time + 1;\r\ntrace_clock_struct.prev_time = now;\r\narch_spin_unlock(&trace_clock_struct.lock);\r\nout:\r\nlocal_irq_restore(flags);\r\nreturn now;\r\n}\r\nu64 notrace trace_clock_counter(void)\r\n{\r\nreturn atomic64_add_return(1, &trace_counter);\r\n}

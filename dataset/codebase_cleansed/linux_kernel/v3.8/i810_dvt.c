void round_off_xres(u32 *xres)\r\n{\r\nif (*xres <= 640)\r\n*xres = 640;\r\nelse if (*xres <= 800)\r\n*xres = 800;\r\nelse if (*xres <= 1024)\r\n*xres = 1024;\r\nelse if (*xres <= 1152)\r\n*xres = 1152;\r\nelse if (*xres <= 1280)\r\n*xres = 1280;\r\nelse\r\n*xres = 1600;\r\n}\r\ninline void round_off_yres(u32 *xres, u32 *yres)\r\n{\r\n*yres = (*xres * 3) >> 2;\r\n}\r\nstatic int i810fb_find_best_mode(u32 xres, u32 yres, u32 pixclock)\r\n{\r\nu32 diff = 0, diff_best = 0xFFFFFFFF, i = 0, i_best = 0;\r\nu8 hfl = (u8) ((xres >> 3) - 1);\r\nfor (i = 0; i < ARRAY_SIZE(std_modes); i++) {\r\nif (std_modes[i].cr01 == hfl) {\r\nif (std_modes[i].pixclock <= pixclock)\r\ndiff = pixclock - std_modes[i].pixclock;\r\nif (diff < diff_best) {\r\ni_best = i;\r\ndiff_best = diff;\r\n}\r\n}\r\n}\r\nreturn i_best;\r\n}\r\nvoid i810fb_encode_registers(const struct fb_var_screeninfo *var,\r\nstruct i810fb_par *par, u32 xres, u32 yres)\r\n{\r\nu32 i_best = i810fb_find_best_mode(xres, yres, par->regs.pixclock);\r\npar->regs = std_modes[i_best];\r\npar->ovract = ((xres + var->right_margin + var->hsync_len +\r\nvar->left_margin - 32) | ((xres - 32) << 16));\r\n}\r\nvoid i810fb_fill_var_timings(struct fb_var_screeninfo *var)\r\n{\r\nu32 total, xres, yres;\r\nu32 mode, pixclock;\r\nxres = var->xres;\r\nyres = var->yres;\r\npixclock = 1000000000 / var->pixclock;\r\nmode = i810fb_find_best_mode(xres, yres, pixclock);\r\ntotal = (std_modes[mode].cr00 | (std_modes[mode].cr35 & 1) << 8) + 3;\r\ntotal <<= 3;\r\nvar->pixclock = 1000000000 / std_modes[mode].pixclock;\r\nvar->right_margin = (std_modes[mode].cr04 << 3) - xres;\r\nvar->hsync_len = ((std_modes[mode].cr05 & 0x1F) -\r\n(std_modes[mode].cr04 & 0x1F)) << 3;\r\nvar->left_margin = (total - (xres + var->right_margin +\r\nvar->hsync_len));\r\nvar->sync = FB_SYNC_ON_GREEN;\r\nif (~(std_modes[mode].msr & (1 << 6)))\r\nvar->sync |= FB_SYNC_HOR_HIGH_ACT;\r\nif (~(std_modes[mode].msr & (1 << 7)))\r\nvar->sync |= FB_SYNC_VERT_HIGH_ACT;\r\ntotal = (std_modes[mode].cr06 | (std_modes[mode].cr30 & 0xF) << 8) + 2;\r\nvar->lower_margin = (std_modes[mode].cr10 |\r\n(std_modes[mode].cr32 & 0x0F) << 8) - yres;\r\nvar->vsync_len = (std_modes[mode].cr11 & 0x0F) -\r\n(var->lower_margin & 0x0F);\r\nvar->upper_margin = total - (yres + var->lower_margin + var->vsync_len);\r\n}\r\nu32 i810_get_watermark(struct fb_var_screeninfo *var,\r\nstruct i810fb_par *par)\r\n{\r\nstruct mode_registers *params = &par->regs;\r\nu32 wmark = 0;\r\nif (par->mem_freq == 100) {\r\nswitch (var->bits_per_pixel) {\r\ncase 8:\r\nwmark = params->bpp8_100;\r\nbreak;\r\ncase 16:\r\nwmark = params->bpp16_100;\r\nbreak;\r\ncase 24:\r\ncase 32:\r\nwmark = params->bpp24_100;\r\n}\r\n} else {\r\nswitch (var->bits_per_pixel) {\r\ncase 8:\r\nwmark = params->bpp8_133;\r\nbreak;\r\ncase 16:\r\nwmark = params->bpp16_133;\r\nbreak;\r\ncase 24:\r\ncase 32:\r\nwmark = params->bpp24_133;\r\n}\r\n}\r\nreturn wmark;\r\n}

static void hd64461_mask_irq(struct irq_data *data)\r\n{\r\nunsigned int irq = data->irq;\r\nunsigned short nimr;\r\nunsigned short mask = 1 << (irq - HD64461_IRQBASE);\r\nnimr = __raw_readw(HD64461_NIMR);\r\nnimr |= mask;\r\n__raw_writew(nimr, HD64461_NIMR);\r\n}\r\nstatic void hd64461_unmask_irq(struct irq_data *data)\r\n{\r\nunsigned int irq = data->irq;\r\nunsigned short nimr;\r\nunsigned short mask = 1 << (irq - HD64461_IRQBASE);\r\nnimr = __raw_readw(HD64461_NIMR);\r\nnimr &= ~mask;\r\n__raw_writew(nimr, HD64461_NIMR);\r\n}\r\nstatic void hd64461_mask_and_ack_irq(struct irq_data *data)\r\n{\r\nhd64461_mask_irq(data);\r\n#ifdef CONFIG_HD64461_ENABLER\r\nif (data->irq == HD64461_IRQBASE + 13)\r\n__raw_writeb(0x00, HD64461_PCC1CSCR);\r\n#endif\r\n}\r\nstatic void hd64461_irq_demux(unsigned int irq, struct irq_desc *desc)\r\n{\r\nunsigned short intv = __raw_readw(HD64461_NIRR);\r\nunsigned int ext_irq = HD64461_IRQBASE;\r\nintv &= (1 << HD64461_IRQ_NUM) - 1;\r\nfor (; intv; intv >>= 1, ext_irq++) {\r\nif (!(intv & 1))\r\ncontinue;\r\ngeneric_handle_irq(ext_irq);\r\n}\r\n}\r\nint __init setup_hd64461(void)\r\n{\r\nint irq_base, i;\r\nprintk(KERN_INFO\r\n"HD64461 configured at 0x%x on irq %d(mapped into %d to %d)\n",\r\nHD64461_IOBASE, CONFIG_HD64461_IRQ, HD64461_IRQBASE,\r\nHD64461_IRQBASE + 15);\r\n#if defined(CONFIG_CPU_SUBTYPE_SH7709)\r\n__raw_writew(0x2240, INTC_ICR1);\r\n#endif\r\n__raw_writew(0xffff, HD64461_NIMR);\r\nirq_base = irq_alloc_descs(HD64461_IRQBASE, HD64461_IRQBASE, 16, -1);\r\nif (IS_ERR_VALUE(irq_base)) {\r\npr_err("%s: failed hooking irqs for HD64461\n", __func__);\r\nreturn irq_base;\r\n}\r\nfor (i = 0; i < 16; i++)\r\nirq_set_chip_and_handler(irq_base + i, &hd64461_irq_chip,\r\nhandle_level_irq);\r\nirq_set_chained_handler(CONFIG_HD64461_IRQ, hd64461_irq_demux);\r\nirq_set_irq_type(CONFIG_HD64461_IRQ, IRQ_TYPE_LEVEL_LOW);\r\n#ifdef CONFIG_HD64461_ENABLER\r\nprintk(KERN_INFO "HD64461: enabling PCMCIA devices\n");\r\n__raw_writeb(0x4c, HD64461_PCC1CSCIER);\r\n__raw_writeb(0x00, HD64461_PCC1CSCR);\r\n#endif\r\nreturn 0;\r\n}

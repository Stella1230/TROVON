static void __init n2100_timer_init(void)\r\n{\r\niop_init_time(198000000);\r\n}\r\nvoid __init n2100_map_io(void)\r\n{\r\niop3xx_map_io();\r\niotable_init(n2100_io_desc, ARRAY_SIZE(n2100_io_desc));\r\n}\r\nstatic int __init\r\nn2100_pci_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nint irq;\r\nif (PCI_SLOT(dev->devfn) == 1) {\r\nirq = IRQ_IOP32X_XINT0;\r\n} else if (PCI_SLOT(dev->devfn) == 2) {\r\nirq = IRQ_IOP32X_XINT3;\r\n} else if (PCI_SLOT(dev->devfn) == 3) {\r\nirq = IRQ_IOP32X_XINT2;\r\n} else if (PCI_SLOT(dev->devfn) == 4 && pin == 1) {\r\nirq = IRQ_IOP32X_XINT1;\r\n} else if (PCI_SLOT(dev->devfn) == 4 && pin == 2) {\r\nirq = IRQ_IOP32X_XINT0;\r\n} else if (PCI_SLOT(dev->devfn) == 4 && pin == 3) {\r\nirq = IRQ_IOP32X_XINT2;\r\n} else if (PCI_SLOT(dev->devfn) == 5) {\r\nirq = IRQ_IOP32X_XINT3;\r\n} else {\r\nprintk(KERN_ERR "n2100_pci_map_irq() called for unknown "\r\n"device PCI:%d:%d:%d\n", dev->bus->number,\r\nPCI_SLOT(dev->devfn), PCI_FUNC(dev->devfn));\r\nirq = -1;\r\n}\r\nreturn irq;\r\n}\r\nstatic void n2100_fixup_r8169(struct pci_dev *dev)\r\n{\r\nif (dev->bus->number == 0 &&\r\n(dev->devfn == PCI_DEVFN(1, 0) ||\r\ndev->devfn == PCI_DEVFN(2, 0)))\r\ndev->broken_parity_status = 1;\r\n}\r\nstatic int __init n2100_pci_init(void)\r\n{\r\nif (machine_is_n2100())\r\npci_common_init(&n2100_pci);\r\nreturn 0;\r\n}\r\nstatic void n2100_power_off(void)\r\n{\r\nlocal_irq_disable();\r\n*IOP3XX_IDBR0 = 0xc0;\r\n*IOP3XX_ICR0 = 0xe9;\r\nmdelay(1);\r\n*IOP3XX_IDBR0 = 0x08;\r\n*IOP3XX_ICR0 = 0xe8;\r\nmdelay(1);\r\n*IOP3XX_IDBR0 = 0x01;\r\n*IOP3XX_ICR0 = 0xea;\r\nwhile (1)\r\n;\r\n}\r\nstatic void n2100_restart(char mode, const char *cmd)\r\n{\r\ngpio_line_set(N2100_HARDWARE_RESET, GPIO_LOW);\r\ngpio_line_config(N2100_HARDWARE_RESET, GPIO_OUT);\r\nwhile (1)\r\n;\r\n}\r\nstatic void power_button_poll(unsigned long dummy)\r\n{\r\nif (gpio_line_get(N2100_POWER_BUTTON) == 0) {\r\nctrl_alt_del();\r\nreturn;\r\n}\r\npower_button_poll_timer.expires = jiffies + (HZ / 10);\r\nadd_timer(&power_button_poll_timer);\r\n}\r\nstatic void __init n2100_init_machine(void)\r\n{\r\nplatform_device_register(&iop3xx_i2c0_device);\r\nplatform_device_register(&n2100_flash_device);\r\nplatform_device_register(&n2100_serial_device);\r\nplatform_device_register(&iop3xx_dma_0_channel);\r\nplatform_device_register(&iop3xx_dma_1_channel);\r\ni2c_register_board_info(0, n2100_i2c_devices,\r\nARRAY_SIZE(n2100_i2c_devices));\r\npm_power_off = n2100_power_off;\r\ninit_timer(&power_button_poll_timer);\r\npower_button_poll_timer.function = power_button_poll;\r\npower_button_poll_timer.expires = jiffies + (HZ / 10);\r\nadd_timer(&power_button_poll_timer);\r\n}

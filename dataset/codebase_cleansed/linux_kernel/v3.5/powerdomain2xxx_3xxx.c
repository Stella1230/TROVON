static int omap2_pwrdm_set_next_pwrst(struct powerdomain *pwrdm, u8 pwrst)\r\n{\r\nomap2_prm_rmw_mod_reg_bits(OMAP_POWERSTATE_MASK,\r\n(pwrst << OMAP_POWERSTATE_SHIFT),\r\npwrdm->prcm_offs, OMAP2_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic int omap2_pwrdm_read_next_pwrst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTCTRL,\r\nOMAP_POWERSTATE_MASK);\r\n}\r\nstatic int omap2_pwrdm_read_pwrst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTST,\r\nOMAP_POWERSTATEST_MASK);\r\n}\r\nstatic int omap2_pwrdm_set_mem_onst(struct powerdomain *pwrdm, u8 bank,\r\nu8 pwrst)\r\n{\r\nu32 m;\r\nm = omap2_pwrdm_get_mem_bank_onstate_mask(bank);\r\nomap2_prm_rmw_mod_reg_bits(m, (pwrst << __ffs(m)), pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic int omap2_pwrdm_set_mem_retst(struct powerdomain *pwrdm, u8 bank,\r\nu8 pwrst)\r\n{\r\nu32 m;\r\nm = omap2_pwrdm_get_mem_bank_retst_mask(bank);\r\nomap2_prm_rmw_mod_reg_bits(m, (pwrst << __ffs(m)), pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic int omap2_pwrdm_read_mem_pwrst(struct powerdomain *pwrdm, u8 bank)\r\n{\r\nu32 m;\r\nm = omap2_pwrdm_get_mem_bank_stst_mask(bank);\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs, OMAP2_PM_PWSTST,\r\nm);\r\n}\r\nstatic int omap2_pwrdm_read_mem_retst(struct powerdomain *pwrdm, u8 bank)\r\n{\r\nu32 m;\r\nm = omap2_pwrdm_get_mem_bank_retst_mask(bank);\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTCTRL, m);\r\n}\r\nstatic int omap2_pwrdm_set_logic_retst(struct powerdomain *pwrdm, u8 pwrst)\r\n{\r\nu32 v;\r\nv = pwrst << __ffs(OMAP3430_LOGICL1CACHERETSTATE_MASK);\r\nomap2_prm_rmw_mod_reg_bits(OMAP3430_LOGICL1CACHERETSTATE_MASK, v,\r\npwrdm->prcm_offs, OMAP2_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic int omap2_pwrdm_wait_transition(struct powerdomain *pwrdm)\r\n{\r\nu32 c = 0;\r\nwhile ((omap2_prm_read_mod_reg(pwrdm->prcm_offs, OMAP2_PM_PWSTST) &\r\nOMAP_INTRANSITION_MASK) &&\r\n(c++ < PWRDM_TRANSITION_BAILOUT))\r\nudelay(1);\r\nif (c > PWRDM_TRANSITION_BAILOUT) {\r\nprintk(KERN_ERR "powerdomain: waited too long for "\r\n"powerdomain %s to complete transition\n", pwrdm->name);\r\nreturn -EAGAIN;\r\n}\r\npr_debug("powerdomain: completed transition in %d loops\n", c);\r\nreturn 0;\r\n}\r\nstatic int omap3_pwrdm_read_prev_pwrst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP3430_PM_PREPWSTST,\r\nOMAP3430_LASTPOWERSTATEENTERED_MASK);\r\n}\r\nstatic int omap3_pwrdm_read_logic_pwrst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTST,\r\nOMAP3430_LOGICSTATEST_MASK);\r\n}\r\nstatic int omap3_pwrdm_read_logic_retst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTCTRL,\r\nOMAP3430_LOGICSTATEST_MASK);\r\n}\r\nstatic int omap3_pwrdm_read_prev_logic_pwrst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP3430_PM_PREPWSTST,\r\nOMAP3430_LASTLOGICSTATEENTERED_MASK);\r\n}\r\nstatic int omap3_get_mem_bank_lastmemst_mask(u8 bank)\r\n{\r\nswitch (bank) {\r\ncase 0:\r\nreturn OMAP3430_LASTMEM1STATEENTERED_MASK;\r\ncase 1:\r\nreturn OMAP3430_LASTMEM2STATEENTERED_MASK;\r\ncase 2:\r\nreturn OMAP3430_LASTSHAREDL2CACHEFLATSTATEENTERED_MASK;\r\ncase 3:\r\nreturn OMAP3430_LASTL2FLATMEMSTATEENTERED_MASK;\r\ndefault:\r\nWARN_ON(1);\r\nreturn -EEXIST;\r\n}\r\nreturn 0;\r\n}\r\nstatic int omap3_pwrdm_read_prev_mem_pwrst(struct powerdomain *pwrdm, u8 bank)\r\n{\r\nu32 m;\r\nm = omap3_get_mem_bank_lastmemst_mask(bank);\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP3430_PM_PREPWSTST, m);\r\n}\r\nstatic int omap3_pwrdm_clear_all_prev_pwrst(struct powerdomain *pwrdm)\r\n{\r\nomap2_prm_write_mod_reg(0, pwrdm->prcm_offs, OMAP3430_PM_PREPWSTST);\r\nreturn 0;\r\n}\r\nstatic int omap3_pwrdm_enable_hdwr_sar(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_rmw_mod_reg_bits(0,\r\n1 << OMAP3430ES2_SAVEANDRESTORE_SHIFT,\r\npwrdm->prcm_offs, OMAP2_PM_PWSTCTRL);\r\n}\r\nstatic int omap3_pwrdm_disable_hdwr_sar(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_rmw_mod_reg_bits(1 << OMAP3430ES2_SAVEANDRESTORE_SHIFT,\r\n0, pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTCTRL);\r\n}

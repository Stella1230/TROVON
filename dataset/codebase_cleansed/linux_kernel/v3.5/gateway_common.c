static void kbit_to_gw_bandwidth(int down, int up, long *gw_srv_class)\r\n{\r\nint mdown = 0, tdown, tup, difference;\r\nuint8_t sbit, part;\r\n*gw_srv_class = 0;\r\ndifference = 0x0FFFFFFF;\r\nfor (sbit = 0; sbit < 2; sbit++) {\r\nfor (part = 0; part < 16; part++) {\r\ntdown = 32 * (sbit + 2) * (1 << part);\r\nif (abs(tdown - down) < difference) {\r\n*gw_srv_class = (sbit << 7) + (part << 3);\r\ndifference = abs(tdown - down);\r\nmdown = tdown;\r\n}\r\n}\r\n}\r\ndifference = 0x0FFFFFFF;\r\nfor (part = 0; part < 8; part++) {\r\ntup = ((part + 1) * (mdown)) / 8;\r\nif (abs(tup - up) < difference) {\r\n*gw_srv_class = (*gw_srv_class & 0xF8) | part;\r\ndifference = abs(tup - up);\r\n}\r\n}\r\n}\r\nvoid gw_bandwidth_to_kbit(uint8_t gw_srv_class, int *down, int *up)\r\n{\r\nint sbit = (gw_srv_class & 0x80) >> 7;\r\nint dpart = (gw_srv_class & 0x78) >> 3;\r\nint upart = (gw_srv_class & 0x07);\r\nif (!gw_srv_class) {\r\n*down = 0;\r\n*up = 0;\r\nreturn;\r\n}\r\n*down = 32 * (sbit + 2) * (1 << dpart);\r\n*up = ((upart + 1) * (*down)) / 8;\r\n}\r\nstatic bool parse_gw_bandwidth(struct net_device *net_dev, char *buff,\r\nint *up, int *down)\r\n{\r\nint ret, multi = 1;\r\nchar *slash_ptr, *tmp_ptr;\r\nlong ldown, lup;\r\nslash_ptr = strchr(buff, '/');\r\nif (slash_ptr)\r\n*slash_ptr = 0;\r\nif (strlen(buff) > 4) {\r\ntmp_ptr = buff + strlen(buff) - 4;\r\nif (strnicmp(tmp_ptr, "mbit", 4) == 0)\r\nmulti = 1024;\r\nif ((strnicmp(tmp_ptr, "kbit", 4) == 0) ||\r\n(multi > 1))\r\n*tmp_ptr = '\0';\r\n}\r\nret = kstrtol(buff, 10, &ldown);\r\nif (ret) {\r\nbat_err(net_dev,\r\n"Download speed of gateway mode invalid: %s\n",\r\nbuff);\r\nreturn false;\r\n}\r\n*down = ldown * multi;\r\nif (slash_ptr) {\r\nmulti = 1;\r\nif (strlen(slash_ptr + 1) > 4) {\r\ntmp_ptr = slash_ptr + 1 - 4 + strlen(slash_ptr + 1);\r\nif (strnicmp(tmp_ptr, "mbit", 4) == 0)\r\nmulti = 1024;\r\nif ((strnicmp(tmp_ptr, "kbit", 4) == 0) ||\r\n(multi > 1))\r\n*tmp_ptr = '\0';\r\n}\r\nret = kstrtol(slash_ptr + 1, 10, &lup);\r\nif (ret) {\r\nbat_err(net_dev,\r\n"Upload speed of gateway mode invalid: %s\n",\r\nslash_ptr + 1);\r\nreturn false;\r\n}\r\n*up = lup * multi;\r\n}\r\nreturn true;\r\n}\r\nssize_t gw_bandwidth_set(struct net_device *net_dev, char *buff, size_t count)\r\n{\r\nstruct bat_priv *bat_priv = netdev_priv(net_dev);\r\nlong gw_bandwidth_tmp = 0;\r\nint up = 0, down = 0;\r\nbool ret;\r\nret = parse_gw_bandwidth(net_dev, buff, &up, &down);\r\nif (!ret)\r\ngoto end;\r\nif ((!down) || (down < 256))\r\ndown = 2000;\r\nif (!up)\r\nup = down / 5;\r\nkbit_to_gw_bandwidth(down, up, &gw_bandwidth_tmp);\r\ngw_bandwidth_to_kbit((uint8_t)gw_bandwidth_tmp, &down, &up);\r\ngw_deselect(bat_priv);\r\nbat_info(net_dev,\r\n"Changing gateway bandwidth from: '%i' to: '%ld' (propagating: %d%s/%d%s)\n",\r\natomic_read(&bat_priv->gw_bandwidth), gw_bandwidth_tmp,\r\n(down > 2048 ? down / 1024 : down),\r\n(down > 2048 ? "MBit" : "KBit"),\r\n(up > 2048 ? up / 1024 : up),\r\n(up > 2048 ? "MBit" : "KBit"));\r\natomic_set(&bat_priv->gw_bandwidth, gw_bandwidth_tmp);\r\nend:\r\nreturn count;\r\n}

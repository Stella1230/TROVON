static void snd_ac97_proc_read_functions(struct snd_ac97 *ac97, struct snd_info_buffer *buffer)\r\n{\r\nint header = 0, function;\r\nunsigned short info, sense_info;\r\nstatic const char *function_names[12] = {\r\n"Master Out", "AUX Out", "Center/LFE Out", "SPDIF Out",\r\n"Phone In", "Mic 1", "Mic 2", "Line In", "CD In", "Video In",\r\n"Aux In", "Mono Out"\r\n};\r\nstatic const char *locations[8] = {\r\n"Rear I/O Panel", "Front Panel", "Motherboard", "Dock/External",\r\n"reserved", "reserved", "reserved", "NC/unused"\r\n};\r\nfor (function = 0; function < 12; ++function) {\r\nsnd_ac97_write(ac97, AC97_FUNC_SELECT, function << 1);\r\ninfo = snd_ac97_read(ac97, AC97_FUNC_INFO);\r\nif (!(info & 0x0001))\r\ncontinue;\r\nif (!header) {\r\nsnd_iprintf(buffer, "\n Gain Inverted Buffer delay Location\n");\r\nheader = 1;\r\n}\r\nsense_info = snd_ac97_read(ac97, AC97_SENSE_INFO);\r\nsnd_iprintf(buffer, "%-17s: %3d.%d dBV %c %2d/fs %s\n",\r\nfunction_names[function],\r\n(info & 0x8000 ? -1 : 1) * ((info & 0x7000) >> 12) * 3 / 2,\r\n((info & 0x0800) >> 11) * 5,\r\ninfo & 0x0400 ? 'X' : '-',\r\n(info & 0x03e0) >> 5,\r\nlocations[sense_info >> 13]);\r\n}\r\n}\r\nstatic void snd_ac97_proc_read_main(struct snd_ac97 *ac97, struct snd_info_buffer *buffer, int subidx)\r\n{\r\nchar name[64];\r\nunsigned short val, tmp, ext, mext;\r\nstatic const char *spdif_slots[4] = { " SPDIF=3/4", " SPDIF=7/8", " SPDIF=6/9", " SPDIF=10/11" };\r\nstatic const char *spdif_rates[4] = { " Rate=44.1kHz", " Rate=res", " Rate=48kHz", " Rate=32kHz" };\r\nstatic const char *spdif_rates_cs4205[4] = { " Rate=48kHz", " Rate=44.1kHz", " Rate=res", " Rate=res" };\r\nstatic const char *double_rate_slots[4] = { "10/11", "7/8", "reserved", "reserved" };\r\nsnd_ac97_get_name(NULL, ac97->id, name, 0);\r\nsnd_iprintf(buffer, "%d-%d/%d: %s\n\n", ac97->addr, ac97->num, subidx, name);\r\nif ((ac97->scaps & AC97_SCAP_AUDIO) == 0)\r\ngoto __modem;\r\nsnd_iprintf(buffer, "PCI Subsys Vendor: 0x%04x\n",\r\nac97->subsystem_vendor);\r\nsnd_iprintf(buffer, "PCI Subsys Device: 0x%04x\n\n",\r\nac97->subsystem_device);\r\nsnd_iprintf(buffer, "Flags: %x\n", ac97->flags);\r\nif ((ac97->ext_id & AC97_EI_REV_MASK) >= AC97_EI_REV_23) {\r\nval = snd_ac97_read(ac97, AC97_INT_PAGING);\r\nsnd_ac97_update_bits(ac97, AC97_INT_PAGING,\r\nAC97_PAGE_MASK, AC97_PAGE_1);\r\ntmp = snd_ac97_read(ac97, AC97_CODEC_CLASS_REV);\r\nsnd_iprintf(buffer, "Revision : 0x%02x\n", tmp & 0xff);\r\nsnd_iprintf(buffer, "Compat. Class : 0x%02x\n", (tmp >> 8) & 0x1f);\r\nsnd_iprintf(buffer, "Subsys. Vendor ID: 0x%04x\n",\r\nsnd_ac97_read(ac97, AC97_PCI_SVID));\r\nsnd_iprintf(buffer, "Subsys. ID : 0x%04x\n\n",\r\nsnd_ac97_read(ac97, AC97_PCI_SID));\r\nsnd_ac97_update_bits(ac97, AC97_INT_PAGING,\r\nAC97_PAGE_MASK, val & AC97_PAGE_MASK);\r\n}\r\nval = ac97->caps;\r\nsnd_iprintf(buffer, "Capabilities :%s%s%s%s%s%s\n",\r\nval & AC97_BC_DEDICATED_MIC ? " -dedicated MIC PCM IN channel-" : "",\r\nval & AC97_BC_RESERVED1 ? " -reserved1-" : "",\r\nval & AC97_BC_BASS_TREBLE ? " -bass & treble-" : "",\r\nval & AC97_BC_SIM_STEREO ? " -simulated stereo-" : "",\r\nval & AC97_BC_HEADPHONE ? " -headphone out-" : "",\r\nval & AC97_BC_LOUDNESS ? " -loudness-" : "");\r\ntmp = ac97->caps & AC97_BC_DAC_MASK;\r\nsnd_iprintf(buffer, "DAC resolution : %s%s%s%s\n",\r\ntmp == AC97_BC_16BIT_DAC ? "16-bit" : "",\r\ntmp == AC97_BC_18BIT_DAC ? "18-bit" : "",\r\ntmp == AC97_BC_20BIT_DAC ? "20-bit" : "",\r\ntmp == AC97_BC_DAC_MASK ? "???" : "");\r\ntmp = ac97->caps & AC97_BC_ADC_MASK;\r\nsnd_iprintf(buffer, "ADC resolution : %s%s%s%s\n",\r\ntmp == AC97_BC_16BIT_ADC ? "16-bit" : "",\r\ntmp == AC97_BC_18BIT_ADC ? "18-bit" : "",\r\ntmp == AC97_BC_20BIT_ADC ? "20-bit" : "",\r\ntmp == AC97_BC_ADC_MASK ? "???" : "");\r\nsnd_iprintf(buffer, "3D enhancement : %s\n",\r\nsnd_ac97_stereo_enhancements[(val >> 10) & 0x1f]);\r\nsnd_iprintf(buffer, "\nCurrent setup\n");\r\nval = snd_ac97_read(ac97, AC97_MIC);\r\nsnd_iprintf(buffer, "Mic gain : %s [%s]\n", val & 0x0040 ? "+20dB" : "+0dB", ac97->regs[AC97_MIC] & 0x0040 ? "+20dB" : "+0dB");\r\nval = snd_ac97_read(ac97, AC97_GENERAL_PURPOSE);\r\nsnd_iprintf(buffer, "POP path : %s 3D\n"\r\n"Sim. stereo : %s\n"\r\n"3D enhancement : %s\n"\r\n"Loudness : %s\n"\r\n"Mono output : %s\n"\r\n"Mic select : %s\n"\r\n"ADC/DAC loopback : %s\n",\r\nval & 0x8000 ? "post" : "pre",\r\nval & 0x4000 ? "on" : "off",\r\nval & 0x2000 ? "on" : "off",\r\nval & 0x1000 ? "on" : "off",\r\nval & 0x0200 ? "Mic" : "MIX",\r\nval & 0x0100 ? "Mic2" : "Mic1",\r\nval & 0x0080 ? "on" : "off");\r\nif (ac97->ext_id & AC97_EI_DRA)\r\nsnd_iprintf(buffer, "Double rate slots: %s\n",\r\ndouble_rate_slots[(val >> 10) & 3]);\r\next = snd_ac97_read(ac97, AC97_EXTENDED_ID);\r\nif (ext == 0)\r\ngoto __modem;\r\nsnd_iprintf(buffer, "Extended ID : codec=%i rev=%i%s%s%s%s DSA=%i%s%s%s%s\n",\r\n(ext & AC97_EI_ADDR_MASK) >> AC97_EI_ADDR_SHIFT,\r\n(ext & AC97_EI_REV_MASK) >> AC97_EI_REV_SHIFT,\r\next & AC97_EI_AMAP ? " AMAP" : "",\r\next & AC97_EI_LDAC ? " LDAC" : "",\r\next & AC97_EI_SDAC ? " SDAC" : "",\r\next & AC97_EI_CDAC ? " CDAC" : "",\r\n(ext & AC97_EI_DACS_SLOT_MASK) >> AC97_EI_DACS_SLOT_SHIFT,\r\next & AC97_EI_VRM ? " VRM" : "",\r\next & AC97_EI_SPDIF ? " SPDIF" : "",\r\next & AC97_EI_DRA ? " DRA" : "",\r\next & AC97_EI_VRA ? " VRA" : "");\r\nval = snd_ac97_read(ac97, AC97_EXTENDED_STATUS);\r\nsnd_iprintf(buffer, "Extended status :%s%s%s%s%s%s%s%s%s%s%s%s%s%s\n",\r\nval & AC97_EA_PRL ? " PRL" : "",\r\nval & AC97_EA_PRK ? " PRK" : "",\r\nval & AC97_EA_PRJ ? " PRJ" : "",\r\nval & AC97_EA_PRI ? " PRI" : "",\r\nval & AC97_EA_SPCV ? " SPCV" : "",\r\nval & AC97_EA_MDAC ? " MADC" : "",\r\nval & AC97_EA_LDAC ? " LDAC" : "",\r\nval & AC97_EA_SDAC ? " SDAC" : "",\r\nval & AC97_EA_CDAC ? " CDAC" : "",\r\next & AC97_EI_SPDIF ? spdif_slots[(val & AC97_EA_SPSA_SLOT_MASK) >> AC97_EA_SPSA_SLOT_SHIFT] : "",\r\nval & AC97_EA_VRM ? " VRM" : "",\r\nval & AC97_EA_SPDIF ? " SPDIF" : "",\r\nval & AC97_EA_DRA ? " DRA" : "",\r\nval & AC97_EA_VRA ? " VRA" : "");\r\nif (ext & AC97_EI_VRA) {\r\nval = snd_ac97_read(ac97, AC97_PCM_FRONT_DAC_RATE);\r\nsnd_iprintf(buffer, "PCM front DAC : %iHz\n", val);\r\nif (ext & AC97_EI_SDAC) {\r\nval = snd_ac97_read(ac97, AC97_PCM_SURR_DAC_RATE);\r\nsnd_iprintf(buffer, "PCM Surr DAC : %iHz\n", val);\r\n}\r\nif (ext & AC97_EI_LDAC) {\r\nval = snd_ac97_read(ac97, AC97_PCM_LFE_DAC_RATE);\r\nsnd_iprintf(buffer, "PCM LFE DAC : %iHz\n", val);\r\n}\r\nval = snd_ac97_read(ac97, AC97_PCM_LR_ADC_RATE);\r\nsnd_iprintf(buffer, "PCM ADC : %iHz\n", val);\r\n}\r\nif (ext & AC97_EI_VRM) {\r\nval = snd_ac97_read(ac97, AC97_PCM_MIC_ADC_RATE);\r\nsnd_iprintf(buffer, "PCM MIC ADC : %iHz\n", val);\r\n}\r\nif ((ext & AC97_EI_SPDIF) || (ac97->flags & AC97_CS_SPDIF) ||\r\n(ac97->id == AC97_ID_YMF743)) {\r\nif (ac97->flags & AC97_CS_SPDIF)\r\nval = snd_ac97_read(ac97, AC97_CSR_SPDIF);\r\nelse if (ac97->id == AC97_ID_YMF743) {\r\nval = snd_ac97_read(ac97, AC97_YMF7X3_DIT_CTRL);\r\nval = 0x2000 | (val & 0xff00) >> 4 | (val & 0x38) >> 2;\r\n} else\r\nval = snd_ac97_read(ac97, AC97_SPDIF);\r\nsnd_iprintf(buffer, "SPDIF Control :%s%s%s%s Category=0x%x Generation=%i%s%s%s\n",\r\nval & AC97_SC_PRO ? " PRO" : " Consumer",\r\nval & AC97_SC_NAUDIO ? " Non-audio" : " PCM",\r\nval & AC97_SC_COPY ? "" : " Copyright",\r\nval & AC97_SC_PRE ? " Preemph50/15" : "",\r\n(val & AC97_SC_CC_MASK) >> AC97_SC_CC_SHIFT,\r\n(val & AC97_SC_L) >> 11,\r\n(ac97->flags & AC97_CS_SPDIF) ?\r\nspdif_rates_cs4205[(val & AC97_SC_SPSR_MASK) >> AC97_SC_SPSR_SHIFT] :\r\nspdif_rates[(val & AC97_SC_SPSR_MASK) >> AC97_SC_SPSR_SHIFT],\r\n(ac97->flags & AC97_CS_SPDIF) ?\r\n(val & AC97_SC_DRS ? " Validity" : "") :\r\n(val & AC97_SC_DRS ? " DRS" : ""),\r\n(ac97->flags & AC97_CS_SPDIF) ?\r\n(val & AC97_SC_V ? " Enabled" : "") :\r\n(val & AC97_SC_V ? " Validity" : ""));\r\nif ((ac97->id & 0xfffffff0) == 0x414c4720 &&\r\n(snd_ac97_read(ac97, AC97_ALC650_CLOCK) & 0x01)) {\r\nval = snd_ac97_read(ac97, AC97_ALC650_SPDIF_INPUT_STATUS2);\r\nif (val & AC97_ALC650_CLOCK_LOCK) {\r\nval = snd_ac97_read(ac97, AC97_ALC650_SPDIF_INPUT_STATUS1);\r\nsnd_iprintf(buffer, "SPDIF In Status :%s%s%s%s Category=0x%x Generation=%i",\r\nval & AC97_ALC650_PRO ? " PRO" : " Consumer",\r\nval & AC97_ALC650_NAUDIO ? " Non-audio" : " PCM",\r\nval & AC97_ALC650_COPY ? "" : " Copyright",\r\nval & AC97_ALC650_PRE ? " Preemph50/15" : "",\r\n(val & AC97_ALC650_CC_MASK) >> AC97_ALC650_CC_SHIFT,\r\n(val & AC97_ALC650_L) >> 15);\r\nval = snd_ac97_read(ac97, AC97_ALC650_SPDIF_INPUT_STATUS2);\r\nsnd_iprintf(buffer, "%s Accuracy=%i%s%s\n",\r\nspdif_rates[(val & AC97_ALC650_SPSR_MASK) >> AC97_ALC650_SPSR_SHIFT],\r\n(val & AC97_ALC650_CLOCK_ACCURACY) >> AC97_ALC650_CLOCK_SHIFT,\r\n(val & AC97_ALC650_CLOCK_LOCK ? " Locked" : " Unlocked"),\r\n(val & AC97_ALC650_V ? " Validity?" : ""));\r\n} else {\r\nsnd_iprintf(buffer, "SPDIF In Status : Not Locked\n");\r\n}\r\n}\r\n}\r\nif ((ac97->ext_id & AC97_EI_REV_MASK) >= AC97_EI_REV_23) {\r\nval = snd_ac97_read(ac97, AC97_INT_PAGING);\r\nsnd_ac97_update_bits(ac97, AC97_INT_PAGING,\r\nAC97_PAGE_MASK, AC97_PAGE_1);\r\nsnd_ac97_proc_read_functions(ac97, buffer);\r\nsnd_ac97_update_bits(ac97, AC97_INT_PAGING,\r\nAC97_PAGE_MASK, val & AC97_PAGE_MASK);\r\n}\r\n__modem:\r\nmext = snd_ac97_read(ac97, AC97_EXTENDED_MID);\r\nif (mext == 0)\r\nreturn;\r\nsnd_iprintf(buffer, "Extended modem ID: codec=%i%s%s%s%s%s\n",\r\n(mext & AC97_MEI_ADDR_MASK) >> AC97_MEI_ADDR_SHIFT,\r\nmext & AC97_MEI_CID2 ? " CID2" : "",\r\nmext & AC97_MEI_CID1 ? " CID1" : "",\r\nmext & AC97_MEI_HANDSET ? " HSET" : "",\r\nmext & AC97_MEI_LINE2 ? " LIN2" : "",\r\nmext & AC97_MEI_LINE1 ? " LIN1" : "");\r\nval = snd_ac97_read(ac97, AC97_EXTENDED_MSTATUS);\r\nsnd_iprintf(buffer, "Modem status :%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s\n",\r\nval & AC97_MEA_GPIO ? " GPIO" : "",\r\nval & AC97_MEA_MREF ? " MREF" : "",\r\nval & AC97_MEA_ADC1 ? " ADC1" : "",\r\nval & AC97_MEA_DAC1 ? " DAC1" : "",\r\nval & AC97_MEA_ADC2 ? " ADC2" : "",\r\nval & AC97_MEA_DAC2 ? " DAC2" : "",\r\nval & AC97_MEA_HADC ? " HADC" : "",\r\nval & AC97_MEA_HDAC ? " HDAC" : "",\r\nval & AC97_MEA_PRA ? " PRA(GPIO)" : "",\r\nval & AC97_MEA_PRB ? " PRB(res)" : "",\r\nval & AC97_MEA_PRC ? " PRC(ADC1)" : "",\r\nval & AC97_MEA_PRD ? " PRD(DAC1)" : "",\r\nval & AC97_MEA_PRE ? " PRE(ADC2)" : "",\r\nval & AC97_MEA_PRF ? " PRF(DAC2)" : "",\r\nval & AC97_MEA_PRG ? " PRG(HADC)" : "",\r\nval & AC97_MEA_PRH ? " PRH(HDAC)" : "");\r\nif (mext & AC97_MEI_LINE1) {\r\nval = snd_ac97_read(ac97, AC97_LINE1_RATE);\r\nsnd_iprintf(buffer, "Line1 rate : %iHz\n", val);\r\n}\r\nif (mext & AC97_MEI_LINE2) {\r\nval = snd_ac97_read(ac97, AC97_LINE2_RATE);\r\nsnd_iprintf(buffer, "Line2 rate : %iHz\n", val);\r\n}\r\nif (mext & AC97_MEI_HANDSET) {\r\nval = snd_ac97_read(ac97, AC97_HANDSET_RATE);\r\nsnd_iprintf(buffer, "Headset rate : %iHz\n", val);\r\n}\r\n}\r\nstatic void snd_ac97_proc_read(struct snd_info_entry *entry, struct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ac97 *ac97 = entry->private_data;\r\nmutex_lock(&ac97->page_mutex);\r\nif ((ac97->id & 0xffffff40) == AC97_ID_AD1881) {\r\nint idx;\r\nfor (idx = 0; idx < 3; idx++)\r\nif (ac97->spec.ad18xx.id[idx]) {\r\nsnd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG, 0x7000,\r\nac97->spec.ad18xx.unchained[idx] | ac97->spec.ad18xx.chained[idx]);\r\nsnd_ac97_proc_read_main(ac97, buffer, idx);\r\nsnd_iprintf(buffer, "\n\n");\r\n}\r\nsnd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG, 0x7000, 0x7000);\r\nsnd_iprintf(buffer, "\nAD18XX configuration\n");\r\nsnd_iprintf(buffer, "Unchained : 0x%04x,0x%04x,0x%04x\n",\r\nac97->spec.ad18xx.unchained[0],\r\nac97->spec.ad18xx.unchained[1],\r\nac97->spec.ad18xx.unchained[2]);\r\nsnd_iprintf(buffer, "Chained : 0x%04x,0x%04x,0x%04x\n",\r\nac97->spec.ad18xx.chained[0],\r\nac97->spec.ad18xx.chained[1],\r\nac97->spec.ad18xx.chained[2]);\r\n} else {\r\nsnd_ac97_proc_read_main(ac97, buffer, 0);\r\n}\r\nmutex_unlock(&ac97->page_mutex);\r\n}\r\nstatic void snd_ac97_proc_regs_write(struct snd_info_entry *entry, struct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ac97 *ac97 = entry->private_data;\r\nchar line[64];\r\nunsigned int reg, val;\r\nmutex_lock(&ac97->page_mutex);\r\nwhile (!snd_info_get_line(buffer, line, sizeof(line))) {\r\nif (sscanf(line, "%x %x", &reg, &val) != 2)\r\ncontinue;\r\nif (reg < 0x80 && (reg & 1) == 0 && val <= 0xffff)\r\nsnd_ac97_write_cache(ac97, reg, val);\r\n}\r\nmutex_unlock(&ac97->page_mutex);\r\n}\r\nstatic void snd_ac97_proc_regs_read_main(struct snd_ac97 *ac97, struct snd_info_buffer *buffer, int subidx)\r\n{\r\nint reg, val;\r\nfor (reg = 0; reg < 0x80; reg += 2) {\r\nval = snd_ac97_read(ac97, reg);\r\nsnd_iprintf(buffer, "%i:%02x = %04x\n", subidx, reg, val);\r\n}\r\n}\r\nstatic void snd_ac97_proc_regs_read(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ac97 *ac97 = entry->private_data;\r\nmutex_lock(&ac97->page_mutex);\r\nif ((ac97->id & 0xffffff40) == AC97_ID_AD1881) {\r\nint idx;\r\nfor (idx = 0; idx < 3; idx++)\r\nif (ac97->spec.ad18xx.id[idx]) {\r\nsnd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG, 0x7000,\r\nac97->spec.ad18xx.unchained[idx] | ac97->spec.ad18xx.chained[idx]);\r\nsnd_ac97_proc_regs_read_main(ac97, buffer, idx);\r\n}\r\nsnd_ac97_update_bits(ac97, AC97_AD_SERIAL_CFG, 0x7000, 0x7000);\r\n} else {\r\nsnd_ac97_proc_regs_read_main(ac97, buffer, 0);\r\n}\r\nmutex_unlock(&ac97->page_mutex);\r\n}\r\nvoid snd_ac97_proc_init(struct snd_ac97 * ac97)\r\n{\r\nstruct snd_info_entry *entry;\r\nchar name[32];\r\nconst char *prefix;\r\nif (ac97->bus->proc == NULL)\r\nreturn;\r\nprefix = ac97_is_audio(ac97) ? "ac97" : "mc97";\r\nsprintf(name, "%s#%d-%d", prefix, ac97->addr, ac97->num);\r\nif ((entry = snd_info_create_card_entry(ac97->bus->card, name, ac97->bus->proc)) != NULL) {\r\nsnd_info_set_text_ops(entry, ac97, snd_ac97_proc_read);\r\nif (snd_info_register(entry) < 0) {\r\nsnd_info_free_entry(entry);\r\nentry = NULL;\r\n}\r\n}\r\nac97->proc = entry;\r\nsprintf(name, "%s#%d-%d+regs", prefix, ac97->addr, ac97->num);\r\nif ((entry = snd_info_create_card_entry(ac97->bus->card, name, ac97->bus->proc)) != NULL) {\r\nsnd_info_set_text_ops(entry, ac97, snd_ac97_proc_regs_read);\r\n#ifdef CONFIG_SND_DEBUG\r\nentry->mode |= S_IWUSR;\r\nentry->c.text.write = snd_ac97_proc_regs_write;\r\n#endif\r\nif (snd_info_register(entry) < 0) {\r\nsnd_info_free_entry(entry);\r\nentry = NULL;\r\n}\r\n}\r\nac97->proc_regs = entry;\r\n}\r\nvoid snd_ac97_proc_done(struct snd_ac97 * ac97)\r\n{\r\nsnd_info_free_entry(ac97->proc_regs);\r\nac97->proc_regs = NULL;\r\nsnd_info_free_entry(ac97->proc);\r\nac97->proc = NULL;\r\n}\r\nvoid snd_ac97_bus_proc_init(struct snd_ac97_bus * bus)\r\n{\r\nstruct snd_info_entry *entry;\r\nchar name[32];\r\nsprintf(name, "codec97#%d", bus->num);\r\nif ((entry = snd_info_create_card_entry(bus->card, name, bus->card->proc_root)) != NULL) {\r\nentry->mode = S_IFDIR | S_IRUGO | S_IXUGO;\r\nif (snd_info_register(entry) < 0) {\r\nsnd_info_free_entry(entry);\r\nentry = NULL;\r\n}\r\n}\r\nbus->proc = entry;\r\n}\r\nvoid snd_ac97_bus_proc_done(struct snd_ac97_bus * bus)\r\n{\r\nsnd_info_free_entry(bus->proc);\r\nbus->proc = NULL;\r\n}

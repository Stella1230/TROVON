int mpi_invm(MPI x, const MPI a, const MPI n)\r\n{\r\nMPI u = NULL, v = NULL;\r\nMPI u1 = NULL, u2 = NULL, u3 = NULL;\r\nMPI v1 = NULL, v2 = NULL, v3 = NULL;\r\nMPI t1 = NULL, t2 = NULL, t3 = NULL;\r\nunsigned k;\r\nint sign;\r\nint odd = 0;\r\nint rc = -ENOMEM;\r\nif (mpi_copy(&u, a) < 0)\r\ngoto cleanup;\r\nif (mpi_copy(&v, n) < 0)\r\ngoto cleanup;\r\nfor (k = 0; !mpi_test_bit(u, 0) && !mpi_test_bit(v, 0); k++) {\r\nif (mpi_rshift(u, u, 1) < 0)\r\ngoto cleanup;\r\nif (mpi_rshift(v, v, 1) < 0)\r\ngoto cleanup;\r\n}\r\nodd = mpi_test_bit(v, 0);\r\nu1 = mpi_alloc_set_ui(1);\r\nif (!u1)\r\ngoto cleanup;\r\nif (!odd) {\r\nu2 = mpi_alloc_set_ui(0);\r\nif (!u2)\r\ngoto cleanup;\r\n}\r\nif (mpi_copy(&u3, u) < 0)\r\ngoto cleanup;\r\nif (mpi_copy(&v1, v) < 0)\r\ngoto cleanup;\r\nif (!odd) {\r\nv2 = mpi_alloc(mpi_get_nlimbs(u));\r\nif (!v2)\r\ngoto cleanup;\r\nif (mpi_sub(v2, u1, u) < 0)\r\ngoto cleanup;\r\n}\r\nif (mpi_copy(&v3, v) < 0)\r\ngoto cleanup;\r\nif (mpi_test_bit(u, 0)) {\r\nt1 = mpi_alloc_set_ui(0);\r\nif (!t1)\r\ngoto cleanup;\r\nif (!odd) {\r\nt2 = mpi_alloc_set_ui(1);\r\nif (!t2)\r\ngoto cleanup;\r\nt2->sign = 1;\r\n}\r\nif (mpi_copy(&t3, v) < 0)\r\ngoto cleanup;\r\nt3->sign = !t3->sign;\r\ngoto Y4;\r\n} else {\r\nt1 = mpi_alloc_set_ui(1);\r\nif (!t1)\r\ngoto cleanup;\r\nif (!odd) {\r\nt2 = mpi_alloc_set_ui(0);\r\nif (!t2)\r\ngoto cleanup;\r\n}\r\nif (mpi_copy(&t3, u) < 0)\r\ngoto cleanup;\r\n}\r\ndo {\r\ndo {\r\nif (!odd) {\r\nif (mpi_test_bit(t1, 0) || mpi_test_bit(t2, 0)) {\r\nif (mpi_add(t1, t1, v) < 0)\r\ngoto cleanup;\r\nif (mpi_sub(t2, t2, u) < 0)\r\ngoto cleanup;\r\n}\r\nif (mpi_rshift(t1, t1, 1) < 0)\r\ngoto cleanup;\r\nif (mpi_rshift(t2, t2, 1) < 0)\r\ngoto cleanup;\r\nif (mpi_rshift(t3, t3, 1) < 0)\r\ngoto cleanup;\r\n} else {\r\nif (mpi_test_bit(t1, 0))\r\nif (mpi_add(t1, t1, v) < 0)\r\ngoto cleanup;\r\nif (mpi_rshift(t1, t1, 1) < 0)\r\ngoto cleanup;\r\nif (mpi_rshift(t3, t3, 1) < 0)\r\ngoto cleanup;\r\n}\r\nY4:\r\n;\r\n} while (!mpi_test_bit(t3, 0));\r\nif (!t3->sign) {\r\nif (mpi_set(u1, t1) < 0)\r\ngoto cleanup;\r\nif (!odd)\r\nif (mpi_set(u2, t2) < 0)\r\ngoto cleanup;\r\nif (mpi_set(u3, t3) < 0)\r\ngoto cleanup;\r\n} else {\r\nif (mpi_sub(v1, v, t1) < 0)\r\ngoto cleanup;\r\nsign = u->sign;\r\nu->sign = !u->sign;\r\nif (!odd)\r\nif (mpi_sub(v2, u, t2) < 0)\r\ngoto cleanup;\r\nu->sign = sign;\r\nsign = t3->sign;\r\nt3->sign = !t3->sign;\r\nif (mpi_set(v3, t3) < 0)\r\ngoto cleanup;\r\nt3->sign = sign;\r\n}\r\nif (mpi_sub(t1, u1, v1) < 0)\r\ngoto cleanup;\r\nif (!odd)\r\nif (mpi_sub(t2, u2, v2) < 0)\r\ngoto cleanup;\r\nif (mpi_sub(t3, u3, v3) < 0)\r\ngoto cleanup;\r\nif (t1->sign) {\r\nif (mpi_add(t1, t1, v) < 0)\r\ngoto cleanup;\r\nif (!odd)\r\nif (mpi_sub(t2, t2, u) < 0)\r\ngoto cleanup;\r\n}\r\n} while (mpi_cmp_ui(t3, 0));\r\nrc = mpi_set(x, u1);\r\ncleanup:\r\nmpi_free(u1);\r\nmpi_free(v1);\r\nmpi_free(t1);\r\nif (!odd) {\r\nmpi_free(u2);\r\nmpi_free(v2);\r\nmpi_free(t2);\r\n}\r\nmpi_free(u3);\r\nmpi_free(v3);\r\nmpi_free(t3);\r\nmpi_free(u);\r\nmpi_free(v);\r\nreturn rc;\r\n}

static unsigned int cris_freq_get_cpu_frequency(unsigned int cpu)\r\n{\r\nreg_clkgen_rw_clk_ctrl clk_ctrl;\r\nclk_ctrl = REG_RD(clkgen, regi_clkgen, rw_clk_ctrl);\r\nreturn clk_ctrl.pll ? 200000 : 6000;\r\n}\r\nstatic void cris_freq_set_cpu_state(unsigned int state)\r\n{\r\nint i = 0;\r\nstruct cpufreq_freqs freqs;\r\nreg_clkgen_rw_clk_ctrl clk_ctrl;\r\nclk_ctrl = REG_RD(clkgen, regi_clkgen, rw_clk_ctrl);\r\n#ifdef CONFIG_SMP\r\nfor_each_present_cpu(i)\r\n#endif\r\n{\r\nfreqs.old = cris_freq_get_cpu_frequency(i);\r\nfreqs.new = cris_freq_table[state].frequency;\r\nfreqs.cpu = i;\r\n}\r\ncpufreq_notify_transition(&freqs, CPUFREQ_PRECHANGE);\r\nlocal_irq_disable();\r\nif (cris_freq_table[state].frequency == 200000)\r\nclk_ctrl.pll = 1;\r\nelse\r\nclk_ctrl.pll = 0;\r\nREG_WR(clkgen, regi_clkgen, rw_clk_ctrl, clk_ctrl);\r\nlocal_irq_enable();\r\ncpufreq_notify_transition(&freqs, CPUFREQ_POSTCHANGE);\r\n}\r\nstatic int cris_freq_verify(struct cpufreq_policy *policy)\r\n{\r\nreturn cpufreq_frequency_table_verify(policy, &cris_freq_table[0]);\r\n}\r\nstatic int cris_freq_target(struct cpufreq_policy *policy,\r\nunsigned int target_freq,\r\nunsigned int relation)\r\n{\r\nunsigned int newstate = 0;\r\nif (cpufreq_frequency_table_target(policy, cris_freq_table,\r\ntarget_freq, relation, &newstate))\r\nreturn -EINVAL;\r\ncris_freq_set_cpu_state(newstate);\r\nreturn 0;\r\n}\r\nstatic int cris_freq_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nint result;\r\npolicy->cpuinfo.transition_latency = 1000000;\r\npolicy->cur = cris_freq_get_cpu_frequency(0);\r\nresult = cpufreq_frequency_table_cpuinfo(policy, cris_freq_table);\r\nif (result)\r\nreturn (result);\r\ncpufreq_frequency_table_get_attr(cris_freq_table, policy->cpu);\r\nreturn 0;\r\n}\r\nstatic int cris_freq_cpu_exit(struct cpufreq_policy *policy)\r\n{\r\ncpufreq_frequency_table_put_attr(policy->cpu);\r\nreturn 0;\r\n}\r\nstatic int __init cris_freq_init(void)\r\n{\r\nint ret;\r\nret = cpufreq_register_driver(&cris_freq_driver);\r\ncpufreq_register_notifier(&cris_sdram_freq_notifier_block,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\nreturn ret;\r\n}\r\nstatic int\r\ncris_sdram_freq_notifier(struct notifier_block *nb, unsigned long val,\r\nvoid *data)\r\n{\r\nint i;\r\nstruct cpufreq_freqs *freqs = data;\r\nif (val == CPUFREQ_PRECHANGE) {\r\nreg_ddr2_rw_cfg cfg =\r\nREG_RD(ddr2, regi_ddr2_ctrl, rw_cfg);\r\ncfg.ref_interval = (freqs->new == 200000 ? 1560 : 46);\r\nif (freqs->new == 200000)\r\nfor (i = 0; i < 50000; i++);\r\nREG_WR(bif_core, regi_bif_core, rw_sdram_timing, timing);\r\n}\r\nreturn 0;\r\n}

static int pd_power_down(struct generic_pm_domain *genpd)\r\n{\r\nstruct sh7372_pm_domain *sh7372_pd = to_sh7372_pd(genpd);\r\nunsigned int mask = 1 << sh7372_pd->bit_shift;\r\nif (sh7372_pd->suspend) {\r\nint ret = sh7372_pd->suspend();\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (__raw_readl(PSTR) & mask) {\r\nunsigned int retry_count;\r\n__raw_writel(mask, SPDCR);\r\nfor (retry_count = PSTR_RETRIES; retry_count; retry_count--) {\r\nif (!(__raw_readl(SPDCR) & mask))\r\nbreak;\r\ncpu_relax();\r\n}\r\n}\r\nif (!sh7372_pd->no_debug)\r\npr_debug("%s: Power off, 0x%08x -> PSTR = 0x%08x\n",\r\ngenpd->name, mask, __raw_readl(PSTR));\r\nreturn 0;\r\n}\r\nstatic int __pd_power_up(struct sh7372_pm_domain *sh7372_pd, bool do_resume)\r\n{\r\nunsigned int mask = 1 << sh7372_pd->bit_shift;\r\nunsigned int retry_count;\r\nint ret = 0;\r\nif (__raw_readl(PSTR) & mask)\r\ngoto out;\r\n__raw_writel(mask, SWUCR);\r\nfor (retry_count = 2 * PSTR_RETRIES; retry_count; retry_count--) {\r\nif (!(__raw_readl(SWUCR) & mask))\r\nbreak;\r\nif (retry_count > PSTR_RETRIES)\r\nudelay(PSTR_DELAY_US);\r\nelse\r\ncpu_relax();\r\n}\r\nif (!retry_count)\r\nret = -EIO;\r\nif (!sh7372_pd->no_debug)\r\npr_debug("%s: Power on, 0x%08x -> PSTR = 0x%08x\n",\r\nsh7372_pd->genpd.name, mask, __raw_readl(PSTR));\r\nout:\r\nif (ret == 0 && sh7372_pd->resume && do_resume)\r\nsh7372_pd->resume();\r\nreturn ret;\r\n}\r\nstatic int pd_power_up(struct generic_pm_domain *genpd)\r\n{\r\nreturn __pd_power_up(to_sh7372_pd(genpd), true);\r\n}\r\nstatic int sh7372_a4r_suspend(void)\r\n{\r\nsh7372_intcs_suspend();\r\n__raw_writel(0x300fffff, WUPRMSK);\r\nreturn 0;\r\n}\r\nstatic bool pd_active_wakeup(struct device *dev)\r\n{\r\nbool (*active_wakeup)(struct device *dev);\r\nactive_wakeup = dev_gpd_data(dev)->ops.active_wakeup;\r\nreturn active_wakeup ? active_wakeup(dev) : true;\r\n}\r\nstatic int sh7372_stop_dev(struct device *dev)\r\n{\r\nint (*stop)(struct device *dev);\r\nstop = dev_gpd_data(dev)->ops.stop;\r\nif (stop) {\r\nint ret = stop(dev);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn pm_clk_suspend(dev);\r\n}\r\nstatic int sh7372_start_dev(struct device *dev)\r\n{\r\nint (*start)(struct device *dev);\r\nint ret;\r\nret = pm_clk_resume(dev);\r\nif (ret)\r\nreturn ret;\r\nstart = dev_gpd_data(dev)->ops.start;\r\nif (start)\r\nret = start(dev);\r\nreturn ret;\r\n}\r\nvoid sh7372_init_pm_domain(struct sh7372_pm_domain *sh7372_pd)\r\n{\r\nstruct generic_pm_domain *genpd = &sh7372_pd->genpd;\r\nstruct dev_power_governor *gov = sh7372_pd->gov;\r\npm_genpd_init(genpd, gov ? : &simple_qos_governor, false);\r\ngenpd->dev_ops.stop = sh7372_stop_dev;\r\ngenpd->dev_ops.start = sh7372_start_dev;\r\ngenpd->dev_ops.active_wakeup = pd_active_wakeup;\r\ngenpd->dev_irq_safe = true;\r\ngenpd->power_off = pd_power_down;\r\ngenpd->power_on = pd_power_up;\r\n__pd_power_up(sh7372_pd, false);\r\n}\r\nvoid sh7372_add_device_to_domain(struct sh7372_pm_domain *sh7372_pd,\r\nstruct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\npm_genpd_add_device(&sh7372_pd->genpd, dev);\r\nif (pm_clk_no_clocks(dev))\r\npm_clk_add(dev, NULL);\r\n}\r\nvoid sh7372_pm_add_subdomain(struct sh7372_pm_domain *sh7372_pd,\r\nstruct sh7372_pm_domain *sh7372_sd)\r\n{\r\npm_genpd_add_subdomain(&sh7372_pd->genpd, &sh7372_sd->genpd);\r\n}\r\nstatic int sh7372_a4s_suspend(void)\r\n{\r\nreturn -EBUSY;\r\n}\r\nstatic int sh7372_a3sp_suspend(void)\r\n{\r\nreturn console_suspend_enabled ? 0 : -EBUSY;\r\n}\r\nstatic inline void sh7372_a3sp_init(void) {}\r\nstatic int sh7372_do_idle_core_standby(unsigned long unused)\r\n{\r\ncpu_do_idle();\r\nreturn 0;\r\n}\r\nstatic void sh7372_set_reset_vector(unsigned long address)\r\n{\r\n__raw_writel(address, SBAR);\r\n__raw_writel(0, APARMBAREA);\r\n}\r\nstatic void sh7372_enter_core_standby(void)\r\n{\r\nsh7372_set_reset_vector(__pa(sh7372_resume_core_standby_sysc));\r\n__raw_writel(0x10, SYSTBCR);\r\ncpu_suspend(0, sh7372_do_idle_core_standby);\r\n__raw_writel(0, SYSTBCR);\r\n__raw_writel(0, SBAR);\r\n}\r\nstatic void sh7372_enter_sysc(int pllc0_on, unsigned long sleep_mode)\r\n{\r\nif (pllc0_on)\r\n__raw_writel(0, PLLC01STPCR);\r\nelse\r\n__raw_writel(1 << 28, PLLC01STPCR);\r\n__raw_readl(WUPSFAC);\r\ncpu_suspend(sleep_mode, sh7372_do_idle_sysc);\r\n__raw_readl(WUPSFAC);\r\n__raw_writel(0, SBAR);\r\n}\r\nstatic int sh7372_sysc_valid(unsigned long *mskp, unsigned long *msk2p)\r\n{\r\nunsigned long mstpsr0, mstpsr1, mstpsr2, mstpsr3, mstpsr4;\r\nunsigned long msk, msk2;\r\nmstpsr0 = __raw_readl(MSTPSR0);\r\nif ((mstpsr0 & 0x00000003) != 0x00000003) {\r\npr_debug("sh7372 mstpsr0 0x%08lx\n", mstpsr0);\r\nreturn 0;\r\n}\r\nmstpsr1 = __raw_readl(MSTPSR1);\r\nif ((mstpsr1 & 0xff079b7f) != 0xff079b7f) {\r\npr_debug("sh7372 mstpsr1 0x%08lx\n", mstpsr1);\r\nreturn 0;\r\n}\r\nmstpsr2 = __raw_readl(MSTPSR2);\r\nif ((mstpsr2 & 0x000741ff) != 0x000741ff) {\r\npr_debug("sh7372 mstpsr2 0x%08lx\n", mstpsr2);\r\nreturn 0;\r\n}\r\nmstpsr3 = __raw_readl(MSTPSR3);\r\nif ((mstpsr3 & 0x1a60f010) != 0x1a60f010) {\r\npr_debug("sh7372 mstpsr3 0x%08lx\n", mstpsr3);\r\nreturn 0;\r\n}\r\nmstpsr4 = __raw_readl(MSTPSR4);\r\nif ((mstpsr4 & 0x00008cf0) != 0x00008cf0) {\r\npr_debug("sh7372 mstpsr4 0x%08lx\n", mstpsr4);\r\nreturn 0;\r\n}\r\nmsk = 0;\r\nmsk2 = 0;\r\nif ((mstpsr2 & (1 << 23)) == 0)\r\nmsk |= 1 << 31;\r\nif ((mstpsr2 & (1 << 12)) == 0)\r\nmsk |= 1 << 21;\r\nif ((mstpsr4 & (1 << 3)) == 0)\r\nmsk |= 1 << 2;\r\nif ((mstpsr1 & (1 << 24)) == 0)\r\nmsk |= 1 << 1;\r\nif ((mstpsr3 & (1 << 29)) == 0)\r\nmsk |= 1 << 1;\r\nif ((mstpsr4 & (1 << 0)) == 0)\r\nmsk |= 1 << 1;\r\nif ((mstpsr2 & (1 << 13)) == 0)\r\nmsk2 |= 1 << 17;\r\n*mskp = msk;\r\n*msk2p = msk2;\r\nreturn 1;\r\n}\r\nstatic void sh7372_icr_to_irqcr(unsigned long icr, u16 *irqcr1p, u16 *irqcr2p)\r\n{\r\nu16 tmp, irqcr1, irqcr2;\r\nint k;\r\nirqcr1 = 0;\r\nirqcr2 = 0;\r\nfor (k = 0; k <= 7; k++) {\r\ntmp = (icr >> ((7 - k) * 4)) & 0xf;\r\nirqcr1 |= (tmp & 0x03) << (k * 2);\r\nirqcr2 |= (tmp >> 2) << (k * 2);\r\n}\r\n*irqcr1p = irqcr1;\r\n*irqcr2p = irqcr2;\r\n}\r\nstatic void sh7372_setup_sysc(unsigned long msk, unsigned long msk2)\r\n{\r\nu16 irqcrx_low, irqcrx_high, irqcry_low, irqcry_high;\r\nunsigned long tmp;\r\ntmp = bitrev8(__raw_readb(INTMSK00A));\r\ntmp |= bitrev8(__raw_readb(INTMSK10A)) << 8;\r\nmsk = (~msk & 0xc030000f) | (tmp << 4);\r\n__raw_writel(msk, WUPSMSK);\r\nsh7372_icr_to_irqcr(__raw_readl(ICR1A), &irqcrx_low, &irqcry_low);\r\nsh7372_icr_to_irqcr(__raw_readl(ICR2A), &irqcrx_high, &irqcry_high);\r\n__raw_writel((irqcrx_high << 16) | irqcrx_low, IRQCR);\r\n__raw_writel((irqcry_high << 16) | irqcry_low, IRQCR2);\r\ntmp = bitrev8(__raw_readb(INTMSK20A));\r\ntmp |= bitrev8(__raw_readb(INTMSK30A)) << 8;\r\nmsk2 = (~msk2 & 0x00030000) | tmp;\r\n__raw_writel(msk2, WUPSMSK2);\r\nsh7372_icr_to_irqcr(__raw_readl(ICR3A), &irqcrx_low, &irqcry_low);\r\nsh7372_icr_to_irqcr(__raw_readl(ICR4A), &irqcrx_high, &irqcry_high);\r\n__raw_writel((irqcrx_high << 16) | irqcrx_low, IRQCR3);\r\n__raw_writel((irqcry_high << 16) | irqcry_low, IRQCR4);\r\n}\r\nstatic void sh7372_enter_a3sm_common(int pllc0_on)\r\n{\r\nsh7372_set_reset_vector(__pa(sh7372_resume_core_standby_sysc));\r\nsh7372_enter_sysc(pllc0_on, 1 << 12);\r\n}\r\nstatic void sh7372_enter_a4s_common(int pllc0_on)\r\n{\r\nsh7372_intca_suspend();\r\nmemcpy((void *)SMFRAM, sh7372_resume_core_standby_sysc, 0x100);\r\nsh7372_set_reset_vector(SMFRAM);\r\nsh7372_enter_sysc(pllc0_on, 1 << 10);\r\nsh7372_intca_resume();\r\n}\r\nstatic void sh7372_cpuidle_setup(struct cpuidle_driver *drv)\r\n{\r\nstruct cpuidle_state *state = &drv->states[drv->state_count];\r\nsnprintf(state->name, CPUIDLE_NAME_LEN, "C2");\r\nstrncpy(state->desc, "Core Standby Mode", CPUIDLE_DESC_LEN);\r\nstate->exit_latency = 10;\r\nstate->target_residency = 20 + 10;\r\nstate->flags = CPUIDLE_FLAG_TIME_VALID;\r\nshmobile_cpuidle_modes[drv->state_count] = sh7372_enter_core_standby;\r\ndrv->state_count++;\r\n}\r\nstatic void sh7372_cpuidle_init(void)\r\n{\r\nshmobile_cpuidle_setup = sh7372_cpuidle_setup;\r\n}\r\nstatic void sh7372_cpuidle_init(void) {}\r\nstatic int sh7372_enter_suspend(suspend_state_t suspend_state)\r\n{\r\nunsigned long msk, msk2;\r\nif (sh7372_sysc_valid(&msk, &msk2)) {\r\nsh7372_setup_sysc(msk, msk2);\r\nif (!console_suspend_enabled &&\r\nsh7372_a4s.genpd.status == GPD_STATE_POWER_OFF) {\r\npr_debug("entering A4S\n");\r\nsh7372_enter_a4s_common(0);\r\n} else {\r\npr_debug("entering A3SM\n");\r\nsh7372_enter_a3sm_common(0);\r\n}\r\n} else {\r\npr_debug("entering Core Standby\n");\r\nsh7372_enter_core_standby();\r\n}\r\nreturn 0;\r\n}\r\nstatic int sh7372_pm_notifier_fn(struct notifier_block *notifier,\r\nunsigned long pm_event, void *unused)\r\n{\r\nswitch (pm_event) {\r\ncase PM_SUSPEND_PREPARE:\r\npm_genpd_poweron(&sh7372_a4r.genpd);\r\nbreak;\r\ncase PM_POST_SUSPEND:\r\npm_genpd_poweroff_unused();\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic void sh7372_suspend_init(void)\r\n{\r\nshmobile_suspend_ops.enter = sh7372_enter_suspend;\r\npm_notifier(sh7372_pm_notifier_fn, 0);\r\n}\r\nstatic void sh7372_suspend_init(void) {}\r\nvoid __init sh7372_pm_init(void)\r\n{\r\n__raw_writel(0x0000a500, DBGREG9);\r\n__raw_writel(0x0000a501, DBGREG9);\r\n__raw_writel(0x00000000, DBGREG1);\r\n__raw_writel(0, PDNSEL);\r\nsh7372_suspend_init();\r\nsh7372_cpuidle_init();\r\n}

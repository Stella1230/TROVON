static u32 notrace jiffy_sched_clock_read(void)\r\n{\r\nreturn (u32)(jiffies - INITIAL_JIFFIES);\r\n}\r\nstatic inline u64 cyc_to_ns(u64 cyc, u32 mult, u32 shift)\r\n{\r\nreturn (cyc * mult) >> shift;\r\n}\r\nstatic unsigned long long cyc_to_sched_clock(u32 cyc, u32 mask)\r\n{\r\nu64 epoch_ns;\r\nu32 epoch_cyc;\r\ndo {\r\nepoch_cyc = cd.epoch_cyc;\r\nsmp_rmb();\r\nepoch_ns = cd.epoch_ns;\r\nsmp_rmb();\r\n} while (epoch_cyc != cd.epoch_cyc_copy);\r\nreturn epoch_ns + cyc_to_ns((cyc - epoch_cyc) & mask, cd.mult, cd.shift);\r\n}\r\nstatic void notrace update_sched_clock(void)\r\n{\r\nunsigned long flags;\r\nu32 cyc;\r\nu64 ns;\r\ncyc = read_sched_clock();\r\nns = cd.epoch_ns +\r\ncyc_to_ns((cyc - cd.epoch_cyc) & sched_clock_mask,\r\ncd.mult, cd.shift);\r\nraw_local_irq_save(flags);\r\ncd.epoch_cyc = cyc;\r\nsmp_wmb();\r\ncd.epoch_ns = ns;\r\nsmp_wmb();\r\ncd.epoch_cyc_copy = cyc;\r\nraw_local_irq_restore(flags);\r\n}\r\nstatic void sched_clock_poll(unsigned long wrap_ticks)\r\n{\r\nmod_timer(&sched_clock_timer, round_jiffies(jiffies + wrap_ticks));\r\nupdate_sched_clock();\r\n}\r\nvoid __init setup_sched_clock(u32 (*read)(void), int bits, unsigned long rate)\r\n{\r\nunsigned long r, w;\r\nu64 res, wrap;\r\nchar r_unit;\r\nBUG_ON(bits > 32);\r\nWARN_ON(!irqs_disabled());\r\nWARN_ON(read_sched_clock != jiffy_sched_clock_read);\r\nread_sched_clock = read;\r\nsched_clock_mask = (1 << bits) - 1;\r\nclocks_calc_mult_shift(&cd.mult, &cd.shift, rate, NSEC_PER_SEC, 0);\r\nr = rate;\r\nif (r >= 4000000) {\r\nr /= 1000000;\r\nr_unit = 'M';\r\n} else if (r >= 1000) {\r\nr /= 1000;\r\nr_unit = 'k';\r\n} else\r\nr_unit = ' ';\r\nwrap = cyc_to_ns((1ULL << bits) - 1, cd.mult, cd.shift);\r\ndo_div(wrap, NSEC_PER_MSEC);\r\nw = wrap;\r\nres = cyc_to_ns(1ULL, cd.mult, cd.shift);\r\npr_info("sched_clock: %u bits at %lu%cHz, resolution %lluns, wraps every %lums\n",\r\nbits, r, r_unit, res, w);\r\nsched_clock_timer.data = msecs_to_jiffies(w - (w / 10));\r\nupdate_sched_clock();\r\ncd.epoch_ns = 0;\r\npr_debug("Registered %pF as sched_clock source\n", read);\r\n}\r\nunsigned long long notrace sched_clock(void)\r\n{\r\nu32 cyc = read_sched_clock();\r\nreturn cyc_to_sched_clock(cyc, sched_clock_mask);\r\n}\r\nvoid __init sched_clock_postinit(void)\r\n{\r\nif (read_sched_clock == jiffy_sched_clock_read)\r\nsetup_sched_clock(jiffy_sched_clock_read, 32, HZ);\r\nsched_clock_poll(sched_clock_timer.data);\r\n}\r\nstatic int sched_clock_suspend(void)\r\n{\r\nsched_clock_poll(sched_clock_timer.data);\r\nreturn 0;\r\n}\r\nstatic int __init sched_clock_syscore_init(void)\r\n{\r\nregister_syscore_ops(&sched_clock_ops);\r\nreturn 0;\r\n}

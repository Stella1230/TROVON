static int rz1000_set_mode(struct ata_link *link, struct ata_device **unused)\r\n{\r\nstruct ata_device *dev;\r\nata_for_each_dev(dev, link, ENABLED) {\r\ndev->pio_mode = XFER_PIO_0;\r\ndev->xfer_mode = XFER_PIO_0;\r\ndev->xfer_shift = ATA_SHIFT_PIO;\r\ndev->flags |= ATA_DFLAG_PIO;\r\nata_dev_info(dev, "configured for PIO\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int rz1000_fifo_disable(struct pci_dev *pdev)\r\n{\r\nu16 reg;\r\nif (pci_read_config_word(pdev, 0x40, &reg) != 0)\r\nreturn -1;\r\nreg &= 0xDFFF;\r\nif (pci_write_config_word(pdev, 0x40, reg) != 0)\r\nreturn -1;\r\nprintk(KERN_INFO DRV_NAME ": disabled chipset readahead.\n");\r\nreturn 0;\r\n}\r\nstatic int rz1000_init_one (struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.port_ops = &rz1000_port_ops\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, NULL };\r\nata_print_version_once(&pdev->dev, DRV_VERSION);\r\nif (rz1000_fifo_disable(pdev) == 0)\r\nreturn ata_pci_sff_init_one(pdev, ppi, &rz1000_sht, NULL, 0);\r\nprintk(KERN_ERR DRV_NAME ": failed to disable read-ahead on chipset..\n");\r\nreturn -ENODEV;\r\n}\r\nstatic int rz1000_reinit_one(struct pci_dev *pdev)\r\n{\r\nstruct ata_host *host = dev_get_drvdata(&pdev->dev);\r\nint rc;\r\nrc = ata_pci_device_do_resume(pdev);\r\nif (rc)\r\nreturn rc;\r\nif (rz1000_fifo_disable(pdev))\r\npanic("rz1000 fifo");\r\nata_host_resume(host);\r\nreturn 0;\r\n}\r\nstatic int __init rz1000_init(void)\r\n{\r\nreturn pci_register_driver(&rz1000_pci_driver);\r\n}\r\nstatic void __exit rz1000_exit(void)\r\n{\r\npci_unregister_driver(&rz1000_pci_driver);\r\n}

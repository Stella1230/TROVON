static int tegra_verify_speed(struct cpufreq_policy *policy)\r\n{\r\nreturn cpufreq_frequency_table_verify(policy, freq_table);\r\n}\r\nstatic unsigned int tegra_getspeed(unsigned int cpu)\r\n{\r\nunsigned long rate;\r\nif (cpu >= NUM_CPUS)\r\nreturn 0;\r\nrate = clk_get_rate(cpu_clk) / 1000;\r\nreturn rate;\r\n}\r\nstatic int tegra_update_cpu_speed(unsigned long rate)\r\n{\r\nint ret = 0;\r\nstruct cpufreq_freqs freqs;\r\nfreqs.old = tegra_getspeed(0);\r\nfreqs.new = rate;\r\nif (freqs.old == freqs.new)\r\nreturn ret;\r\nif (rate >= 816000)\r\nclk_set_rate(emc_clk, 600000000);\r\nelse if (rate >= 456000)\r\nclk_set_rate(emc_clk, 300000000);\r\nelse\r\nclk_set_rate(emc_clk, 100000000);\r\nfor_each_online_cpu(freqs.cpu)\r\ncpufreq_notify_transition(&freqs, CPUFREQ_PRECHANGE);\r\n#ifdef CONFIG_CPU_FREQ_DEBUG\r\nprintk(KERN_DEBUG "cpufreq-tegra: transition: %u --> %u\n",\r\nfreqs.old, freqs.new);\r\n#endif\r\nret = clk_set_rate(cpu_clk, freqs.new * 1000);\r\nif (ret) {\r\npr_err("cpu-tegra: Failed to set cpu frequency to %d kHz\n",\r\nfreqs.new);\r\nreturn ret;\r\n}\r\nfor_each_online_cpu(freqs.cpu)\r\ncpufreq_notify_transition(&freqs, CPUFREQ_POSTCHANGE);\r\nreturn 0;\r\n}\r\nstatic unsigned long tegra_cpu_highest_speed(void)\r\n{\r\nunsigned long rate = 0;\r\nint i;\r\nfor_each_online_cpu(i)\r\nrate = max(rate, target_cpu_speed[i]);\r\nreturn rate;\r\n}\r\nstatic int tegra_target(struct cpufreq_policy *policy,\r\nunsigned int target_freq,\r\nunsigned int relation)\r\n{\r\nunsigned int idx;\r\nunsigned int freq;\r\nint ret = 0;\r\nmutex_lock(&tegra_cpu_lock);\r\nif (is_suspended) {\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\ncpufreq_frequency_table_target(policy, freq_table, target_freq,\r\nrelation, &idx);\r\nfreq = freq_table[idx].frequency;\r\ntarget_cpu_speed[policy->cpu] = freq;\r\nret = tegra_update_cpu_speed(tegra_cpu_highest_speed());\r\nout:\r\nmutex_unlock(&tegra_cpu_lock);\r\nreturn ret;\r\n}\r\nstatic int tegra_pm_notify(struct notifier_block *nb, unsigned long event,\r\nvoid *dummy)\r\n{\r\nmutex_lock(&tegra_cpu_lock);\r\nif (event == PM_SUSPEND_PREPARE) {\r\nis_suspended = true;\r\npr_info("Tegra cpufreq suspend: setting frequency to %d kHz\n",\r\nfreq_table[0].frequency);\r\ntegra_update_cpu_speed(freq_table[0].frequency);\r\n} else if (event == PM_POST_SUSPEND) {\r\nis_suspended = false;\r\n}\r\nmutex_unlock(&tegra_cpu_lock);\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int tegra_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nif (policy->cpu >= NUM_CPUS)\r\nreturn -EINVAL;\r\ncpu_clk = clk_get_sys(NULL, "cpu");\r\nif (IS_ERR(cpu_clk))\r\nreturn PTR_ERR(cpu_clk);\r\nemc_clk = clk_get_sys("cpu", "emc");\r\nif (IS_ERR(emc_clk)) {\r\nclk_put(cpu_clk);\r\nreturn PTR_ERR(emc_clk);\r\n}\r\nclk_enable(emc_clk);\r\nclk_enable(cpu_clk);\r\ncpufreq_frequency_table_cpuinfo(policy, freq_table);\r\ncpufreq_frequency_table_get_attr(freq_table, policy->cpu);\r\npolicy->cur = tegra_getspeed(policy->cpu);\r\ntarget_cpu_speed[policy->cpu] = policy->cur;\r\npolicy->cpuinfo.transition_latency = 300 * 1000;\r\npolicy->shared_type = CPUFREQ_SHARED_TYPE_ALL;\r\ncpumask_copy(policy->related_cpus, cpu_possible_mask);\r\nif (policy->cpu == 0)\r\nregister_pm_notifier(&tegra_cpu_pm_notifier);\r\nreturn 0;\r\n}\r\nstatic int tegra_cpu_exit(struct cpufreq_policy *policy)\r\n{\r\ncpufreq_frequency_table_cpuinfo(policy, freq_table);\r\nclk_disable(emc_clk);\r\nclk_put(emc_clk);\r\nclk_put(cpu_clk);\r\nreturn 0;\r\n}\r\nstatic int __init tegra_cpufreq_init(void)\r\n{\r\nreturn cpufreq_register_driver(&tegra_cpufreq_driver);\r\n}\r\nstatic void __exit tegra_cpufreq_exit(void)\r\n{\r\ncpufreq_unregister_driver(&tegra_cpufreq_driver);\r\n}

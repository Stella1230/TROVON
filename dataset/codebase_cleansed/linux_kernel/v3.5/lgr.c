static inline int stsi_0(void)\r\n{\r\nint rc = stsi(NULL, 0, 0, 0);\r\nreturn rc == -ENOSYS ? rc : (((unsigned int) rc) >> 28);\r\n}\r\nstatic void cpascii(char *dst, char *src, int size)\r\n{\r\nmemcpy(dst, src, size);\r\nEBCASC(dst, size);\r\n}\r\nstatic void lgr_stsi_1_1_1(struct lgr_info *lgr_info)\r\n{\r\nstruct sysinfo_1_1_1 *si = lgr_page;\r\nif (stsi(si, 1, 1, 1) == -ENOSYS)\r\nreturn;\r\ncpascii(lgr_info->manufacturer, si->manufacturer,\r\nsizeof(si->manufacturer));\r\ncpascii(lgr_info->type, si->type, sizeof(si->type));\r\ncpascii(lgr_info->model, si->model, sizeof(si->model));\r\ncpascii(lgr_info->sequence, si->sequence, sizeof(si->sequence));\r\ncpascii(lgr_info->plant, si->plant, sizeof(si->plant));\r\n}\r\nstatic void lgr_stsi_2_2_2(struct lgr_info *lgr_info)\r\n{\r\nstruct sysinfo_2_2_2 *si = lgr_page;\r\nif (stsi(si, 2, 2, 2) == -ENOSYS)\r\nreturn;\r\ncpascii(lgr_info->name, si->name, sizeof(si->name));\r\nmemcpy(&lgr_info->lpar_number, &si->lpar_number,\r\nsizeof(lgr_info->lpar_number));\r\n}\r\nstatic void lgr_stsi_3_2_2(struct lgr_info *lgr_info)\r\n{\r\nstruct sysinfo_3_2_2 *si = lgr_page;\r\nint i;\r\nif (stsi(si, 3, 2, 2) == -ENOSYS)\r\nreturn;\r\nfor (i = 0; i < min_t(u8, si->count, VM_LEVEL_MAX); i++) {\r\ncpascii(lgr_info->vm[i].name, si->vm[i].name,\r\nsizeof(si->vm[i].name));\r\ncpascii(lgr_info->vm[i].cpi, si->vm[i].cpi,\r\nsizeof(si->vm[i].cpi));\r\n}\r\nlgr_info->vm_count = si->count;\r\n}\r\nstatic void lgr_info_get(struct lgr_info *lgr_info)\r\n{\r\nmemset(lgr_info, 0, sizeof(*lgr_info));\r\nstfle(lgr_info->stfle_fac_list, ARRAY_SIZE(lgr_info->stfle_fac_list));\r\nlgr_info->level = stsi_0();\r\nif (lgr_info->level == -ENOSYS)\r\nreturn;\r\nif (lgr_info->level >= 1)\r\nlgr_stsi_1_1_1(lgr_info);\r\nif (lgr_info->level >= 2)\r\nlgr_stsi_2_2_2(lgr_info);\r\nif (lgr_info->level >= 3)\r\nlgr_stsi_3_2_2(lgr_info);\r\n}\r\nvoid lgr_info_log(void)\r\n{\r\nstatic DEFINE_SPINLOCK(lgr_info_lock);\r\nunsigned long flags;\r\nif (!spin_trylock_irqsave(&lgr_info_lock, flags))\r\nreturn;\r\nlgr_info_get(&lgr_info_cur);\r\nif (memcmp(&lgr_info_last, &lgr_info_cur, sizeof(lgr_info_cur)) != 0) {\r\ndebug_event(lgr_dbf, 1, &lgr_info_cur, sizeof(lgr_info_cur));\r\nlgr_info_last = lgr_info_cur;\r\n}\r\nspin_unlock_irqrestore(&lgr_info_lock, flags);\r\n}\r\nstatic void lgr_timer_fn(unsigned long ignored)\r\n{\r\nlgr_info_log();\r\nlgr_timer_set();\r\n}\r\nstatic void lgr_timer_set(void)\r\n{\r\nmod_timer(&lgr_timer, jiffies + LGR_TIMER_INTERVAL_SECS * HZ);\r\n}\r\nstatic int __init lgr_init(void)\r\n{\r\nlgr_page = (void *) __get_free_pages(GFP_KERNEL, 0);\r\nif (!lgr_page)\r\nreturn -ENOMEM;\r\nlgr_dbf = debug_register("lgr", 1, 1, sizeof(struct lgr_info));\r\nif (!lgr_dbf) {\r\nfree_page((unsigned long) lgr_page);\r\nreturn -ENOMEM;\r\n}\r\ndebug_register_view(lgr_dbf, &debug_hex_ascii_view);\r\nlgr_info_get(&lgr_info_last);\r\ndebug_event(lgr_dbf, 1, &lgr_info_last, sizeof(lgr_info_last));\r\nlgr_timer_set();\r\nreturn 0;\r\n}

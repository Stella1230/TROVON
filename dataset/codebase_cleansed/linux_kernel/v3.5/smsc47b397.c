static inline void superio_outb(int reg, int val)\r\n{\r\noutb(reg, REG);\r\noutb(val, VAL);\r\n}\r\nstatic inline int superio_inb(int reg)\r\n{\r\noutb(reg, REG);\r\nreturn inb(VAL);\r\n}\r\nstatic inline void superio_select(int ld)\r\n{\r\nsuperio_outb(0x07, ld);\r\n}\r\nstatic inline void superio_enter(void)\r\n{\r\noutb(0x55, REG);\r\n}\r\nstatic inline void superio_exit(void)\r\n{\r\noutb(0xAA, REG);\r\n}\r\nstatic int smsc47b397_read_value(struct smsc47b397_data *data, u8 reg)\r\n{\r\nint res;\r\nmutex_lock(&data->lock);\r\noutb(reg, data->addr);\r\nres = inb_p(data->addr + 1);\r\nmutex_unlock(&data->lock);\r\nreturn res;\r\n}\r\nstatic struct smsc47b397_data *smsc47b397_update_device(struct device *dev)\r\n{\r\nstruct smsc47b397_data *data = dev_get_drvdata(dev);\r\nint i;\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->last_updated + HZ) || !data->valid) {\r\ndev_dbg(dev, "starting device update...\n");\r\nfor (i = 0; i < 4; i++) {\r\ndata->temp[i] = smsc47b397_read_value(data,\r\nSMSC47B397_REG_TEMP(i));\r\ndata->fan[i] = smsc47b397_read_value(data,\r\nSMSC47B397_REG_FAN_LSB(i));\r\ndata->fan[i] |= smsc47b397_read_value(data,\r\nSMSC47B397_REG_FAN_MSB(i)) << 8;\r\n}\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\ndev_dbg(dev, "... device update complete\n");\r\n}\r\nmutex_unlock(&data->update_lock);\r\nreturn data;\r\n}\r\nstatic int temp_from_reg(u8 reg)\r\n{\r\nreturn (s8)reg * 1000;\r\n}\r\nstatic ssize_t show_temp(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct smsc47b397_data *data = smsc47b397_update_device(dev);\r\nreturn sprintf(buf, "%d\n", temp_from_reg(data->temp[attr->index]));\r\n}\r\nstatic int fan_from_reg(u16 reg)\r\n{\r\nif (reg == 0 || reg == 0xffff)\r\nreturn 0;\r\nreturn 90000 * 60 / reg;\r\n}\r\nstatic ssize_t show_fan(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct smsc47b397_data *data = smsc47b397_update_device(dev);\r\nreturn sprintf(buf, "%d\n", fan_from_reg(data->fan[attr->index]));\r\n}\r\nstatic ssize_t show_name(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct smsc47b397_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%s\n", data->name);\r\n}\r\nstatic int __devexit smsc47b397_remove(struct platform_device *pdev)\r\n{\r\nstruct smsc47b397_data *data = platform_get_drvdata(pdev);\r\nstruct resource *res;\r\nhwmon_device_unregister(data->hwmon_dev);\r\nsysfs_remove_group(&pdev->dev.kobj, &smsc47b397_group);\r\nres = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nrelease_region(res->start, SMSC_EXTENT);\r\nkfree(data);\r\nreturn 0;\r\n}\r\nstatic int __devinit smsc47b397_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct smsc47b397_data *data;\r\nstruct resource *res;\r\nint err = 0;\r\nres = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nif (!request_region(res->start, SMSC_EXTENT,\r\nsmsc47b397_driver.driver.name)) {\r\ndev_err(dev, "Region 0x%lx-0x%lx already in use!\n",\r\n(unsigned long)res->start,\r\n(unsigned long)res->start + SMSC_EXTENT - 1);\r\nreturn -EBUSY;\r\n}\r\ndata = kzalloc(sizeof(struct smsc47b397_data), GFP_KERNEL);\r\nif (!data) {\r\nerr = -ENOMEM;\r\ngoto error_release;\r\n}\r\ndata->addr = res->start;\r\ndata->name = "smsc47b397";\r\nmutex_init(&data->lock);\r\nmutex_init(&data->update_lock);\r\nplatform_set_drvdata(pdev, data);\r\nerr = sysfs_create_group(&dev->kobj, &smsc47b397_group);\r\nif (err)\r\ngoto error_free;\r\ndata->hwmon_dev = hwmon_device_register(dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto error_remove;\r\n}\r\nreturn 0;\r\nerror_remove:\r\nsysfs_remove_group(&dev->kobj, &smsc47b397_group);\r\nerror_free:\r\nkfree(data);\r\nerror_release:\r\nrelease_region(res->start, SMSC_EXTENT);\r\nreturn err;\r\n}\r\nstatic int __init smsc47b397_device_add(unsigned short address)\r\n{\r\nstruct resource res = {\r\n.start = address,\r\n.end = address + SMSC_EXTENT - 1,\r\n.name = DRVNAME,\r\n.flags = IORESOURCE_IO,\r\n};\r\nint err;\r\nerr = acpi_check_resource_conflict(&res);\r\nif (err)\r\ngoto exit;\r\npdev = platform_device_alloc(DRVNAME, address);\r\nif (!pdev) {\r\nerr = -ENOMEM;\r\npr_err("Device allocation failed\n");\r\ngoto exit;\r\n}\r\nerr = platform_device_add_resources(pdev, &res, 1);\r\nif (err) {\r\npr_err("Device resource addition failed (%d)\n", err);\r\ngoto exit_device_put;\r\n}\r\nerr = platform_device_add(pdev);\r\nif (err) {\r\npr_err("Device addition failed (%d)\n", err);\r\ngoto exit_device_put;\r\n}\r\nreturn 0;\r\nexit_device_put:\r\nplatform_device_put(pdev);\r\nexit:\r\nreturn err;\r\n}\r\nstatic int __init smsc47b397_find(void)\r\n{\r\nu8 id, rev;\r\nchar *name;\r\nunsigned short addr;\r\nsuperio_enter();\r\nid = force_id ? force_id : superio_inb(SUPERIO_REG_DEVID);\r\nswitch (id) {\r\ncase 0x81:\r\nname = "SCH5307-NS";\r\nbreak;\r\ncase 0x6f:\r\nname = "LPC47B397-NC";\r\nbreak;\r\ncase 0x85:\r\ncase 0x8c:\r\nname = "SCH5317";\r\nbreak;\r\ndefault:\r\nsuperio_exit();\r\nreturn -ENODEV;\r\n}\r\nrev = superio_inb(SUPERIO_REG_DEVREV);\r\nsuperio_select(SUPERIO_REG_LD8);\r\naddr = (superio_inb(SUPERIO_REG_BASE_MSB) << 8)\r\n| superio_inb(SUPERIO_REG_BASE_LSB);\r\npr_info("found SMSC %s (base address 0x%04x, revision %u)\n",\r\nname, addr, rev);\r\nsuperio_exit();\r\nreturn addr;\r\n}\r\nstatic int __init smsc47b397_init(void)\r\n{\r\nunsigned short address;\r\nint ret;\r\nret = smsc47b397_find();\r\nif (ret < 0)\r\nreturn ret;\r\naddress = ret;\r\nret = platform_driver_register(&smsc47b397_driver);\r\nif (ret)\r\ngoto exit;\r\nret = smsc47b397_device_add(address);\r\nif (ret)\r\ngoto exit_driver;\r\nreturn 0;\r\nexit_driver:\r\nplatform_driver_unregister(&smsc47b397_driver);\r\nexit:\r\nreturn ret;\r\n}\r\nstatic void __exit smsc47b397_exit(void)\r\n{\r\nplatform_device_unregister(pdev);\r\nplatform_driver_unregister(&smsc47b397_driver);\r\n}

static void mpc52xx_lpbfifo_kick(struct mpc52xx_lpbfifo_request *req)\r\n{\r\nsize_t transfer_size = req->size - req->pos;\r\nstruct bcom_bd *bd;\r\nvoid __iomem *reg;\r\nu32 *data;\r\nint i;\r\nint bit_fields;\r\nint dma = !(req->flags & MPC52XX_LPBFIFO_FLAG_NO_DMA);\r\nint write = req->flags & MPC52XX_LPBFIFO_FLAG_WRITE;\r\nint poll_dma = req->flags & MPC52XX_LPBFIFO_FLAG_POLL_DMA;\r\nout_be32(lpbfifo.regs + LPBFIFO_REG_ENABLE, 0x01010000);\r\nout_be32(lpbfifo.regs + LPBFIFO_REG_ENABLE, 0x00000001);\r\nif (!dma) {\r\nif (transfer_size > 512)\r\ntransfer_size = 512;\r\nif (write) {\r\nreg = lpbfifo.regs + LPBFIFO_REG_FIFO_DATA;\r\ndata = req->data + req->pos;\r\nfor (i = 0; i < transfer_size; i += 4)\r\nout_be32(reg, *data++);\r\n}\r\nout_be32(lpbfifo.regs + LPBFIFO_REG_ENABLE, 0x00000301);\r\n} else {\r\nif (write) {\r\nout_be32(lpbfifo.regs + LPBFIFO_REG_FIFO_ALARM, 0x1e4);\r\nout_8(lpbfifo.regs + LPBFIFO_REG_FIFO_CONTROL, 7);\r\nlpbfifo.bcom_cur_task = lpbfifo.bcom_tx_task;\r\n} else {\r\nout_be32(lpbfifo.regs + LPBFIFO_REG_FIFO_ALARM, 0x1ff);\r\nout_8(lpbfifo.regs + LPBFIFO_REG_FIFO_CONTROL, 0);\r\nlpbfifo.bcom_cur_task = lpbfifo.bcom_rx_task;\r\nif (poll_dma) {\r\nif (lpbfifo.dma_irqs_enabled) {\r\ndisable_irq(bcom_get_task_irq(lpbfifo.bcom_rx_task));\r\nlpbfifo.dma_irqs_enabled = 0;\r\n}\r\n} else {\r\nif (!lpbfifo.dma_irqs_enabled) {\r\nenable_irq(bcom_get_task_irq(lpbfifo.bcom_rx_task));\r\nlpbfifo.dma_irqs_enabled = 1;\r\n}\r\n}\r\n}\r\nbd = bcom_prepare_next_buffer(lpbfifo.bcom_cur_task);\r\nbd->status = transfer_size;\r\nif (!write) {\r\ntransfer_size += 4;\r\n}\r\nbd->data[0] = req->data_phys + req->pos;\r\nbcom_submit_next_buffer(lpbfifo.bcom_cur_task, NULL);\r\nbit_fields = 0x00000201;\r\nif (write && (!poll_dma))\r\nbit_fields |= 0x00000100;\r\nout_be32(lpbfifo.regs + LPBFIFO_REG_ENABLE, bit_fields);\r\n}\r\nout_be32(lpbfifo.regs + LPBFIFO_REG_START_ADDRESS,\r\nreq->offset + req->pos);\r\nout_be32(lpbfifo.regs + LPBFIFO_REG_PACKET_SIZE, transfer_size);\r\nbit_fields = req->cs << 24 | 0x000008;\r\nif (!write)\r\nbit_fields |= 0x010000;\r\nout_be32(lpbfifo.regs + LPBFIFO_REG_CONTROL, bit_fields);\r\nout_8(lpbfifo.regs + LPBFIFO_REG_PACKET_SIZE, 0x01);\r\nif (dma)\r\nbcom_enable(lpbfifo.bcom_cur_task);\r\n}\r\nstatic irqreturn_t mpc52xx_lpbfifo_irq(int irq, void *dev_id)\r\n{\r\nstruct mpc52xx_lpbfifo_request *req;\r\nu32 status = in_8(lpbfifo.regs + LPBFIFO_REG_BYTES_DONE_STATUS);\r\nvoid __iomem *reg;\r\nu32 *data;\r\nint count, i;\r\nint do_callback = 0;\r\nu32 ts;\r\nunsigned long flags;\r\nint dma, write, poll_dma;\r\nspin_lock_irqsave(&lpbfifo.lock, flags);\r\nts = get_tbl();\r\nreq = lpbfifo.req;\r\nif (!req) {\r\nspin_unlock_irqrestore(&lpbfifo.lock, flags);\r\npr_err("bogus LPBFIFO IRQ\n");\r\nreturn IRQ_HANDLED;\r\n}\r\ndma = !(req->flags & MPC52XX_LPBFIFO_FLAG_NO_DMA);\r\nwrite = req->flags & MPC52XX_LPBFIFO_FLAG_WRITE;\r\npoll_dma = req->flags & MPC52XX_LPBFIFO_FLAG_POLL_DMA;\r\nif (dma && !write) {\r\nspin_unlock_irqrestore(&lpbfifo.lock, flags);\r\npr_err("bogus LPBFIFO IRQ (dma and not writting)\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nif ((status & 0x01) == 0) {\r\ngoto out;\r\n}\r\nif (status & 0x10) {\r\nout_be32(lpbfifo.regs + LPBFIFO_REG_ENABLE, 0x01010000);\r\ndo_callback = 1;\r\ngoto out;\r\n}\r\ncount = in_be32(lpbfifo.regs + LPBFIFO_REG_BYTES_DONE_STATUS);\r\ncount &= 0x00ffffff;\r\nif (!dma && !write) {\r\nreg = lpbfifo.regs + LPBFIFO_REG_FIFO_DATA;\r\ndata = req->data + req->pos;\r\nfor (i = 0; i < count; i += 4)\r\n*data++ = in_be32(reg);\r\n}\r\nreq->pos += count;\r\nif (req->size - req->pos)\r\nmpc52xx_lpbfifo_kick(req);\r\nelse\r\ndo_callback = 1;\r\nout:\r\nout_8(lpbfifo.regs + LPBFIFO_REG_BYTES_DONE_STATUS, 0x01);\r\nif (dma && (status & 0x11)) {\r\nbcom_retrieve_buffer(lpbfifo.bcom_cur_task, &status, NULL);\r\n}\r\nreq->last_byte = ((u8 *)req->data)[req->size - 1];\r\nif (do_callback)\r\nlpbfifo.req = NULL;\r\nif (irq != 0)\r\nreq->irq_count++;\r\nreq->irq_ticks += get_tbl() - ts;\r\nspin_unlock_irqrestore(&lpbfifo.lock, flags);\r\nif (do_callback && req->callback)\r\nreq->callback(req);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t mpc52xx_lpbfifo_bcom_irq(int irq, void *dev_id)\r\n{\r\nstruct mpc52xx_lpbfifo_request *req;\r\nunsigned long flags;\r\nu32 status;\r\nu32 ts;\r\nspin_lock_irqsave(&lpbfifo.lock, flags);\r\nts = get_tbl();\r\nreq = lpbfifo.req;\r\nif (!req || (req->flags & MPC52XX_LPBFIFO_FLAG_NO_DMA)) {\r\nspin_unlock_irqrestore(&lpbfifo.lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nif (irq != 0)\r\nreq->irq_count++;\r\nif (!bcom_buffer_done(lpbfifo.bcom_cur_task)) {\r\nspin_unlock_irqrestore(&lpbfifo.lock, flags);\r\nreq->buffer_not_done_cnt++;\r\nif ((req->buffer_not_done_cnt % 1000) == 0)\r\npr_err("transfer stalled\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nbcom_retrieve_buffer(lpbfifo.bcom_cur_task, &status, NULL);\r\nreq->last_byte = ((u8 *)req->data)[req->size - 1];\r\nreq->pos = status & 0x00ffffff;\r\nlpbfifo.req = NULL;\r\nreq->irq_ticks += get_tbl() - ts;\r\nspin_unlock_irqrestore(&lpbfifo.lock, flags);\r\nif (req->callback)\r\nreq->callback(req);\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid mpc52xx_lpbfifo_poll(void)\r\n{\r\nstruct mpc52xx_lpbfifo_request *req = lpbfifo.req;\r\nint dma = !(req->flags & MPC52XX_LPBFIFO_FLAG_NO_DMA);\r\nint write = req->flags & MPC52XX_LPBFIFO_FLAG_WRITE;\r\nif (dma && write)\r\nmpc52xx_lpbfifo_irq(0, NULL);\r\nelse\r\nmpc52xx_lpbfifo_bcom_irq(0, NULL);\r\n}\r\nint mpc52xx_lpbfifo_submit(struct mpc52xx_lpbfifo_request *req)\r\n{\r\nunsigned long flags;\r\nif (!lpbfifo.regs)\r\nreturn -ENODEV;\r\nspin_lock_irqsave(&lpbfifo.lock, flags);\r\nif (lpbfifo.req) {\r\nspin_unlock_irqrestore(&lpbfifo.lock, flags);\r\nreturn -EBUSY;\r\n}\r\nlpbfifo.req = req;\r\nreq->irq_count = 0;\r\nreq->irq_ticks = 0;\r\nreq->buffer_not_done_cnt = 0;\r\nreq->pos = 0;\r\nmpc52xx_lpbfifo_kick(req);\r\nspin_unlock_irqrestore(&lpbfifo.lock, flags);\r\nreturn 0;\r\n}\r\nvoid mpc52xx_lpbfifo_abort(struct mpc52xx_lpbfifo_request *req)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&lpbfifo.lock, flags);\r\nif (lpbfifo.req == req) {\r\nbcom_gen_bd_rx_reset(lpbfifo.bcom_rx_task);\r\nbcom_gen_bd_tx_reset(lpbfifo.bcom_tx_task);\r\nout_be32(lpbfifo.regs + LPBFIFO_REG_ENABLE, 0x01010000);\r\nlpbfifo.req = NULL;\r\n}\r\nspin_unlock_irqrestore(&lpbfifo.lock, flags);\r\n}\r\nstatic int __devinit mpc52xx_lpbfifo_probe(struct platform_device *op)\r\n{\r\nstruct resource res;\r\nint rc = -ENOMEM;\r\nif (lpbfifo.dev != NULL)\r\nreturn -ENOSPC;\r\nlpbfifo.irq = irq_of_parse_and_map(op->dev.of_node, 0);\r\nif (!lpbfifo.irq)\r\nreturn -ENODEV;\r\nif (of_address_to_resource(op->dev.of_node, 0, &res))\r\nreturn -ENODEV;\r\nlpbfifo.regs_phys = res.start;\r\nlpbfifo.regs = of_iomap(op->dev.of_node, 0);\r\nif (!lpbfifo.regs)\r\nreturn -ENOMEM;\r\nspin_lock_init(&lpbfifo.lock);\r\nout_be32(lpbfifo.regs + LPBFIFO_REG_ENABLE, 0x01010000);\r\nrc = request_irq(lpbfifo.irq, mpc52xx_lpbfifo_irq, 0,\r\n"mpc52xx-lpbfifo", &lpbfifo);\r\nif (rc)\r\ngoto err_irq;\r\nlpbfifo.bcom_rx_task =\r\nbcom_gen_bd_rx_init(2, res.start + LPBFIFO_REG_FIFO_DATA,\r\nBCOM_INITIATOR_SCLPC, BCOM_IPR_SCLPC,\r\n16*1024*1024);\r\nif (!lpbfifo.bcom_rx_task)\r\ngoto err_bcom_rx;\r\nrc = request_irq(bcom_get_task_irq(lpbfifo.bcom_rx_task),\r\nmpc52xx_lpbfifo_bcom_irq, 0,\r\n"mpc52xx-lpbfifo-rx", &lpbfifo);\r\nif (rc)\r\ngoto err_bcom_rx_irq;\r\nlpbfifo.dma_irqs_enabled = 1;\r\nlpbfifo.bcom_tx_task =\r\nbcom_gen_bd_tx_init(2, res.start + LPBFIFO_REG_FIFO_DATA,\r\nBCOM_INITIATOR_SCLPC, BCOM_IPR_SCLPC);\r\nif (!lpbfifo.bcom_tx_task)\r\ngoto err_bcom_tx;\r\nlpbfifo.dev = &op->dev;\r\nreturn 0;\r\nerr_bcom_tx:\r\nfree_irq(bcom_get_task_irq(lpbfifo.bcom_rx_task), &lpbfifo);\r\nerr_bcom_rx_irq:\r\nbcom_gen_bd_rx_release(lpbfifo.bcom_rx_task);\r\nerr_bcom_rx:\r\nerr_irq:\r\niounmap(lpbfifo.regs);\r\nlpbfifo.regs = NULL;\r\ndev_err(&op->dev, "mpc52xx_lpbfifo_probe() failed\n");\r\nreturn -ENODEV;\r\n}\r\nstatic int __devexit mpc52xx_lpbfifo_remove(struct platform_device *op)\r\n{\r\nif (lpbfifo.dev != &op->dev)\r\nreturn 0;\r\nout_be32(lpbfifo.regs + LPBFIFO_REG_ENABLE, 0x01010000);\r\nfree_irq(bcom_get_task_irq(lpbfifo.bcom_tx_task), &lpbfifo);\r\nbcom_gen_bd_tx_release(lpbfifo.bcom_tx_task);\r\nfree_irq(bcom_get_task_irq(lpbfifo.bcom_rx_task), &lpbfifo);\r\nbcom_gen_bd_rx_release(lpbfifo.bcom_rx_task);\r\nfree_irq(lpbfifo.irq, &lpbfifo);\r\niounmap(lpbfifo.regs);\r\nlpbfifo.regs = NULL;\r\nlpbfifo.dev = NULL;\r\nreturn 0;\r\n}\r\nstatic int __init mpc52xx_lpbfifo_init(void)\r\n{\r\nreturn platform_driver_register(&mpc52xx_lpbfifo_driver);\r\n}\r\nstatic void __exit mpc52xx_lpbfifo_exit(void)\r\n{\r\nplatform_driver_unregister(&mpc52xx_lpbfifo_driver);\r\n}

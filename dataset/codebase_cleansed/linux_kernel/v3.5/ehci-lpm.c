static int __maybe_unused ehci_lpm_set_da(struct ehci_hcd *ehci,\r\nint dev_addr, int port_num)\r\n{\r\nu32 __iomem portsc;\r\nehci_dbg(ehci, "set dev address %d for port %d\n", dev_addr, port_num);\r\nif (port_num > HCS_N_PORTS(ehci->hcs_params)) {\r\nehci_dbg(ehci, "invalid port number %d\n", port_num);\r\nreturn -ENODEV;\r\n}\r\nportsc = ehci_readl(ehci, &ehci->regs->port_status[port_num-1]);\r\nportsc &= ~PORT_DEV_ADDR;\r\nportsc |= dev_addr<<25;\r\nehci_writel(ehci, portsc, &ehci->regs->port_status[port_num-1]);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused ehci_lpm_check(struct ehci_hcd *ehci, int port)\r\n{\r\nu32 __iomem *portsc ;\r\nu32 val32;\r\nint retval;\r\nportsc = &ehci->regs->port_status[port-1];\r\nval32 = ehci_readl(ehci, portsc);\r\nif (!(val32 & PORT_DEV_ADDR)) {\r\nehci_dbg(ehci, "LPM: no device attached\n");\r\nreturn -ENODEV;\r\n}\r\nval32 |= PORT_LPM;\r\nehci_writel(ehci, val32, portsc);\r\nmsleep(5);\r\nval32 |= PORT_SUSPEND;\r\nehci_dbg(ehci, "Sending LPM 0x%08x to port %d\n", val32, port);\r\nehci_writel(ehci, val32, portsc);\r\nmsleep(10);\r\nretval = handshake(ehci, &ehci->regs->port_status[port-1], PORT_SSTS,\r\nPORTSC_SUSPEND_STS_ACK, 125);\r\ndbg_port(ehci, "LPM", port, val32);\r\nif (retval != -ETIMEDOUT) {\r\nehci_dbg(ehci, "LPM: device ACK for LPM\n");\r\nval32 |= PORT_LPM;\r\nehci_writel(ehci, val32, portsc);\r\nmsleep(10);\r\nval32 |= PORT_RESUME;\r\nehci_writel(ehci, val32, portsc);\r\n} else {\r\nehci_dbg(ehci, "LPM: device does not ACK, disable LPM %d\n",\r\nretval);\r\nval32 &= ~PORT_LPM;\r\nretval = -ETIMEDOUT;\r\nehci_writel(ehci, val32, portsc);\r\n}\r\nreturn retval;\r\n}

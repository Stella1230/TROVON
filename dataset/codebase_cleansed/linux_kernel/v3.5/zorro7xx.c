static int __devinit zorro7xx_init_one(struct zorro_dev *z,\r\nconst struct zorro_device_id *ent)\r\n{\r\nstruct Scsi_Host *host;\r\nstruct NCR_700_Host_Parameters *hostdata;\r\nstruct zorro_driver_data *zdd;\r\nunsigned long board, ioaddr;\r\nboard = zorro_resource_start(z);\r\nzdd = (struct zorro_driver_data *)ent->driver_data;\r\nif (zdd->absolute) {\r\nioaddr = zdd->offset;\r\n} else {\r\nioaddr = board + zdd->offset;\r\n}\r\nif (!zorro_request_device(z, zdd->name)) {\r\nprintk(KERN_ERR "zorro7xx: cannot reserve region 0x%lx, abort\n",\r\nboard);\r\nreturn -EBUSY;\r\n}\r\nhostdata = kzalloc(sizeof(struct NCR_700_Host_Parameters), GFP_KERNEL);\r\nif (!hostdata) {\r\nprintk(KERN_ERR "zorro7xx: Failed to allocate host data\n");\r\ngoto out_release;\r\n}\r\nif (ioaddr > 0x01000000)\r\nhostdata->base = ioremap(ioaddr, zorro_resource_len(z));\r\nelse\r\nhostdata->base = (void __iomem *)ZTWO_VADDR(ioaddr);\r\nhostdata->clock = 50;\r\nhostdata->chip710 = 1;\r\nhostdata->ctest7_extra = CTEST7_TT1;\r\nzorro7xx_scsi_driver_template.name = zdd->name;\r\nhost = NCR_700_detect(&zorro7xx_scsi_driver_template, hostdata,\r\n&z->dev);\r\nif (!host) {\r\nprintk(KERN_ERR "zorro7xx: No host detected; "\r\n"board configuration problem?\n");\r\ngoto out_free;\r\n}\r\nhost->this_id = 7;\r\nhost->base = ioaddr;\r\nhost->irq = IRQ_AMIGA_PORTS;\r\nif (request_irq(host->irq, NCR_700_intr, IRQF_SHARED, "zorro7xx-scsi",\r\nhost)) {\r\nprintk(KERN_ERR "zorro7xx: request_irq failed\n");\r\ngoto out_put_host;\r\n}\r\nzorro_set_drvdata(z, host);\r\nscsi_scan_host(host);\r\nreturn 0;\r\nout_put_host:\r\nscsi_host_put(host);\r\nout_free:\r\nif (ioaddr > 0x01000000)\r\niounmap(hostdata->base);\r\nkfree(hostdata);\r\nout_release:\r\nzorro_release_device(z);\r\nreturn -ENODEV;\r\n}\r\nstatic __devexit void zorro7xx_remove_one(struct zorro_dev *z)\r\n{\r\nstruct Scsi_Host *host = zorro_get_drvdata(z);\r\nstruct NCR_700_Host_Parameters *hostdata = shost_priv(host);\r\nscsi_remove_host(host);\r\nNCR_700_release(host);\r\nkfree(hostdata);\r\nfree_irq(host->irq, host);\r\nzorro_release_device(z);\r\n}\r\nstatic int __init zorro7xx_scsi_init(void)\r\n{\r\nreturn zorro_register_driver(&zorro7xx_driver);\r\n}\r\nstatic void __exit zorro7xx_scsi_exit(void)\r\n{\r\nzorro_unregister_driver(&zorro7xx_driver);\r\n}

static int am200_init_gpio_regs(struct metronomefb_par *par)\r\n{\r\nint i;\r\nint err;\r\nfor (i = 0; i < ARRAY_SIZE(gpios); i++) {\r\nerr = gpio_request(gpios[i], gpio_names[i]);\r\nif (err) {\r\ndev_err(&am200_device->dev, "failed requesting "\r\n"gpio %s, err=%d\n", gpio_names[i], err);\r\ngoto err_req_gpio;\r\n}\r\n}\r\ngpio_direction_output(LED_GPIO_PIN, 0);\r\ngpio_direction_output(STDBY_GPIO_PIN, 0);\r\ngpio_direction_output(RST_GPIO_PIN, 0);\r\ngpio_direction_input(RDY_GPIO_PIN);\r\ngpio_direction_input(ERR_GPIO_PIN);\r\ngpio_direction_output(PCBPWR_GPIO_PIN, 0);\r\nreturn 0;\r\nerr_req_gpio:\r\nwhile (--i >= 0)\r\ngpio_free(gpios[i]);\r\nreturn err;\r\n}\r\nstatic void am200_cleanup(struct metronomefb_par *par)\r\n{\r\nint i;\r\nfree_irq(PXA_GPIO_TO_IRQ(RDY_GPIO_PIN), par);\r\nfor (i = 0; i < ARRAY_SIZE(gpios); i++)\r\ngpio_free(gpios[i]);\r\n}\r\nstatic int am200_share_video_mem(struct fb_info *info)\r\n{\r\nif ((info->var.xres != am200_fb_info.modes->xres)\r\n|| (info->var.yres != am200_fb_info.modes->yres))\r\nreturn 0;\r\nam200_board.metromem = info->screen_base;\r\nam200_board.host_fbinfo = info;\r\nif (!try_module_get(info->fbops->owner))\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int am200_unshare_video_mem(struct fb_info *info)\r\n{\r\ndev_dbg(&am200_device->dev, "ENTER %s\n", __func__);\r\nif (info != am200_board.host_fbinfo)\r\nreturn 0;\r\nmodule_put(am200_board.host_fbinfo->fbops->owner);\r\nreturn 0;\r\n}\r\nstatic int am200_fb_notifier_callback(struct notifier_block *self,\r\nunsigned long event, void *data)\r\n{\r\nstruct fb_event *evdata = data;\r\nstruct fb_info *info = evdata->info;\r\ndev_dbg(&am200_device->dev, "ENTER %s\n", __func__);\r\nif (event == FB_EVENT_FB_REGISTERED)\r\nreturn am200_share_video_mem(info);\r\nelse if (event == FB_EVENT_FB_UNREGISTERED)\r\nreturn am200_unshare_video_mem(info);\r\nreturn 0;\r\n}\r\nstatic void __init am200_presetup_fb(void)\r\n{\r\nint fw;\r\nint fh;\r\nint padding_size;\r\nint totalsize;\r\nswitch (panel_type) {\r\ncase 6:\r\nam200_fb_info.modes = &am200_fb_mode_6inch;\r\nbreak;\r\ncase 8:\r\nam200_fb_info.modes = &am200_fb_mode_8inch;\r\nbreak;\r\ncase 97:\r\nam200_fb_info.modes = &am200_fb_mode_9inch7;\r\nbreak;\r\ndefault:\r\ndev_err(&am200_device->dev, "invalid panel_type selection,"\r\n" setting to 6\n");\r\nam200_fb_info.modes = &am200_fb_mode_6inch;\r\nbreak;\r\n}\r\nfw = am200_fb_info.modes->xres;\r\nfh = am200_fb_info.modes->yres;\r\nam200_board.wfm_size = roundup(16*1024 + 2, fw);\r\npadding_size = PAGE_SIZE + (4 * fw);\r\ntotalsize = fw + am200_board.wfm_size + padding_size + (fw*fh);\r\nam200_board.fw = fw;\r\nam200_board.fh = fh;\r\nam200_fb_info.modes->yres = DIV_ROUND_UP(totalsize, fw);\r\nam200_fb_info.modes->xres /= 2;\r\npxa_set_fb_info(NULL, &am200_fb_info);\r\n}\r\nstatic int am200_setup_fb(struct metronomefb_par *par)\r\n{\r\nint fw;\r\nint fh;\r\nfw = am200_board.fw;\r\nfh = am200_board.fh;\r\npar->metromem_cmd = (struct metromem_cmd *) am200_board.metromem;\r\npar->metromem_wfm = am200_board.metromem + fw;\r\npar->metromem_img = par->metromem_wfm + am200_board.wfm_size;\r\npar->metromem_img_csum = (u16 *) (par->metromem_img + (fw * fh));\r\npar->metromem_dma = am200_board.host_fbinfo->fix.smem_start;\r\nreturn 0;\r\n}\r\nstatic int am200_get_panel_type(void)\r\n{\r\nreturn panel_type;\r\n}\r\nstatic irqreturn_t am200_handle_irq(int irq, void *dev_id)\r\n{\r\nstruct metronomefb_par *par = dev_id;\r\nwake_up_interruptible(&par->waitq);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int am200_setup_irq(struct fb_info *info)\r\n{\r\nint ret;\r\nret = request_irq(PXA_GPIO_TO_IRQ(RDY_GPIO_PIN), am200_handle_irq,\r\nIRQF_DISABLED|IRQF_TRIGGER_FALLING,\r\n"AM200", info->par);\r\nif (ret)\r\ndev_err(&am200_device->dev, "request_irq failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void am200_set_rst(struct metronomefb_par *par, int state)\r\n{\r\ngpio_set_value(RST_GPIO_PIN, state);\r\n}\r\nstatic void am200_set_stdby(struct metronomefb_par *par, int state)\r\n{\r\ngpio_set_value(STDBY_GPIO_PIN, state);\r\n}\r\nstatic int am200_wait_event(struct metronomefb_par *par)\r\n{\r\nreturn wait_event_timeout(par->waitq, gpio_get_value(RDY_GPIO_PIN), HZ);\r\n}\r\nstatic int am200_wait_event_intr(struct metronomefb_par *par)\r\n{\r\nreturn wait_event_interruptible_timeout(par->waitq,\r\ngpio_get_value(RDY_GPIO_PIN), HZ);\r\n}\r\nint __init am200_init(void)\r\n{\r\nint ret;\r\nfb_register_client(&am200_fb_notif);\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(am200_pin_config));\r\nrequest_module("metronomefb");\r\nam200_device = platform_device_alloc("metronomefb", -1);\r\nif (!am200_device)\r\nreturn -ENOMEM;\r\nplatform_device_add_data(am200_device, &am200_board,\r\nsizeof(am200_board));\r\nret = platform_device_add(am200_device);\r\nif (ret) {\r\nplatform_device_put(am200_device);\r\nfb_unregister_client(&am200_fb_notif);\r\nreturn ret;\r\n}\r\nam200_presetup_fb();\r\nreturn 0;\r\n}

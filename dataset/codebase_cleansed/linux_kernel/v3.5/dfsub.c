int\r\ndbl_fsub(\r\ndbl_floating_point *leftptr,\r\ndbl_floating_point *rightptr,\r\ndbl_floating_point *dstptr,\r\nunsigned int *status)\r\n{\r\nregister unsigned int signless_upper_left, signless_upper_right, save;\r\nregister unsigned int leftp1, leftp2, rightp1, rightp2, extent;\r\nregister unsigned int resultp1 = 0, resultp2 = 0;\r\nregister int result_exponent, right_exponent, diff_exponent;\r\nregister int sign_save, jumpsize;\r\nregister boolean inexact = FALSE, underflowtrap;\r\nDbl_copyfromptr(leftptr,leftp1,leftp2);\r\nDbl_copyfromptr(rightptr,rightp1,rightp2);\r\nDbl_xortointp1(leftp1,rightp1,save);\r\nif ((result_exponent = Dbl_exponent(leftp1)) == DBL_INFINITY_EXPONENT)\r\n{\r\nif (Dbl_iszero_mantissa(leftp1,leftp2))\r\n{\r\nif (Dbl_isnotnan(rightp1,rightp2))\r\n{\r\nif (Dbl_isinfinity(rightp1,rightp2) && save==0)\r\n{\r\nif (Is_invalidtrap_enabled()) return(INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_makequietnan(resultp1,resultp2);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nDbl_copytoptr(leftp1,leftp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nelse\r\n{\r\nif (Dbl_isone_signaling(leftp1))\r\n{\r\nif (Is_invalidtrap_enabled()) return(INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_set_quiet(leftp1);\r\n}\r\nelse if (Dbl_is_signalingnan(rightp1))\r\n{\r\nif (Is_invalidtrap_enabled()) return(INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_set_quiet(rightp1);\r\nDbl_copytoptr(rightp1,rightp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nDbl_copytoptr(leftp1,leftp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nif (Dbl_isinfinity_exponent(rightp1))\r\n{\r\nif (Dbl_iszero_mantissa(rightp1,rightp2))\r\n{\r\nDbl_invert_sign(rightp1);\r\nDbl_copytoptr(rightp1,rightp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nif (Dbl_isone_signaling(rightp1))\r\n{\r\nif (Is_invalidtrap_enabled()) return(INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_set_quiet(rightp1);\r\n}\r\nDbl_copytoptr(rightp1,rightp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nDbl_copytoint_exponentmantissap1(leftp1,signless_upper_left);\r\nDbl_copytoint_exponentmantissap1(rightp1,signless_upper_right);\r\nif(Dbl_ismagnitudeless(leftp2,rightp2,signless_upper_left,signless_upper_right))\r\n{\r\nDbl_xorfromintp1(save,rightp1,rightp1);\r\nDbl_xorfromintp1(save,leftp1,leftp1);\r\nDbl_swap_lower(leftp2,rightp2);\r\nresult_exponent = Dbl_exponent(leftp1);\r\nDbl_invert_sign(leftp1);\r\n}\r\nif((right_exponent = Dbl_exponent(rightp1)) == 0)\r\n{\r\nif(Dbl_iszero_mantissa(rightp1,rightp2))\r\n{\r\nif(Dbl_iszero_exponentmantissa(leftp1,leftp2))\r\n{\r\nDbl_invert_sign(rightp1);\r\nif(Is_rounding_mode(ROUNDMINUS))\r\n{\r\nDbl_or_signs(leftp1,rightp1);\r\n}\r\nelse\r\n{\r\nDbl_and_signs(leftp1,rightp1);\r\n}\r\n}\r\nelse\r\n{\r\nif( (result_exponent == 0) && Is_underflowtrap_enabled() )\r\n{\r\nsign_save = Dbl_signextendedsign(leftp1);\r\nDbl_leftshiftby1(leftp1,leftp2);\r\nDbl_normalize(leftp1,leftp2,result_exponent);\r\nDbl_set_sign(leftp1,sign_save);\r\nDbl_setwrapped_exponent(leftp1,result_exponent,unfl);\r\nDbl_copytoptr(leftp1,leftp2,dstptr);\r\nreturn(UNDERFLOWEXCEPTION);\r\n}\r\n}\r\nDbl_copytoptr(leftp1,leftp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nDbl_clear_sign(rightp1);\r\nif(result_exponent == 0 )\r\n{\r\nif( (int) save >= 0 )\r\n{\r\nDbl_subtract(leftp1,leftp2,rightp1,rightp2,\r\nresultp1,resultp2);\r\nif(Dbl_iszero_mantissa(resultp1,resultp2))\r\n{\r\nif(Is_rounding_mode(ROUNDMINUS))\r\n{\r\nDbl_setone_sign(resultp1);\r\n}\r\nelse\r\n{\r\nDbl_setzero_sign(resultp1);\r\n}\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nelse\r\n{\r\nDbl_addition(leftp1,leftp2,rightp1,rightp2,\r\nresultp1,resultp2);\r\nif(Dbl_isone_hidden(resultp1))\r\n{\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nif(Is_underflowtrap_enabled())\r\n{\r\nsign_save = Dbl_signextendedsign(resultp1);\r\nDbl_leftshiftby1(resultp1,resultp2);\r\nDbl_normalize(resultp1,resultp2,result_exponent);\r\nDbl_set_sign(resultp1,sign_save);\r\nDbl_setwrapped_exponent(resultp1,result_exponent,unfl);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(UNDERFLOWEXCEPTION);\r\n}\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nright_exponent = 1;\r\n}\r\nelse\r\n{\r\nDbl_clear_signexponent_set_hidden(rightp1);\r\n}\r\nDbl_clear_exponent_set_hidden(leftp1);\r\ndiff_exponent = result_exponent - right_exponent;\r\nif(diff_exponent > DBL_THRESHOLD)\r\n{\r\ndiff_exponent = DBL_THRESHOLD;\r\n}\r\nDbl_right_align(rightp1,rightp2,diff_exponent,\r\nextent);\r\nif( (int) save >= 0 )\r\n{\r\nDbl_subtract_withextension(leftp1,leftp2,rightp1,rightp2,\r\nextent,resultp1,resultp2);\r\nif(Dbl_iszero_hidden(resultp1))\r\n{\r\nsign_save = Dbl_signextendedsign(resultp1);\r\nDbl_leftshiftby1_withextent(resultp1,resultp2,extent,resultp1,resultp2);\r\nif(Dbl_iszero(resultp1,resultp2))\r\n{\r\nif(Is_rounding_mode(ROUNDMINUS)) Dbl_setone_sign(resultp1);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nresult_exponent--;\r\nif(Dbl_isone_hidden(resultp1))\r\n{\r\nif(result_exponent==0)\r\n{\r\ngoto underflow;\r\n}\r\nelse\r\n{\r\nDbl_set_sign(resultp1,sign_save);\r\nExt_leftshiftby1(extent);\r\ngoto round;\r\n}\r\n}\r\nif(!(underflowtrap = Is_underflowtrap_enabled()) &&\r\nresult_exponent==0) goto underflow;\r\nExt_leftshiftby1(extent);\r\nwhile(Dbl_iszero_hiddenhigh7mantissa(resultp1))\r\n{\r\nDbl_leftshiftby8(resultp1,resultp2);\r\nif((result_exponent -= 8) <= 0 && !underflowtrap)\r\ngoto underflow;\r\n}\r\nif(Dbl_iszero_hiddenhigh3mantissa(resultp1))\r\n{\r\nDbl_leftshiftby4(resultp1,resultp2);\r\nif((result_exponent -= 4) <= 0 && !underflowtrap)\r\ngoto underflow;\r\n}\r\nif((jumpsize = Dbl_hiddenhigh3mantissa(resultp1)) > 7)\r\n{\r\nif(result_exponent <= 0) goto underflow;\r\nDbl_set_sign(resultp1,sign_save);\r\nDbl_set_exponent(resultp1,result_exponent);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nDbl_sethigh4bits(resultp1,sign_save);\r\nswitch(jumpsize)\r\n{\r\ncase 1:\r\n{\r\nDbl_leftshiftby3(resultp1,resultp2);\r\nresult_exponent -= 3;\r\nbreak;\r\n}\r\ncase 2:\r\ncase 3:\r\n{\r\nDbl_leftshiftby2(resultp1,resultp2);\r\nresult_exponent -= 2;\r\nbreak;\r\n}\r\ncase 4:\r\ncase 5:\r\ncase 6:\r\ncase 7:\r\n{\r\nDbl_leftshiftby1(resultp1,resultp2);\r\nresult_exponent -= 1;\r\nbreak;\r\n}\r\n}\r\nif(result_exponent > 0)\r\n{\r\nDbl_set_exponent(resultp1,result_exponent);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nunderflow:\r\nif(Is_underflowtrap_enabled())\r\n{\r\nDbl_set_sign(resultp1,sign_save);\r\nDbl_setwrapped_exponent(resultp1,result_exponent,unfl);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(UNDERFLOWEXCEPTION);\r\n}\r\nDbl_fix_overshift(resultp1,resultp2,(1-result_exponent),extent);\r\nDbl_clear_signexponent(resultp1);\r\nDbl_set_sign(resultp1,sign_save);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nelse\r\n{\r\nDbl_addition(leftp1,leftp2,rightp1,rightp2,resultp1,resultp2);\r\nif(Dbl_isone_hiddenoverflow(resultp1))\r\n{\r\nDbl_rightshiftby1_withextent(resultp2,extent,extent);\r\nDbl_arithrightshiftby1(resultp1,resultp2);\r\nresult_exponent++;\r\n}\r\n}\r\nround:\r\nif(Ext_isnotzero(extent))\r\n{\r\ninexact = TRUE;\r\nswitch(Rounding_mode())\r\n{\r\ncase ROUNDNEAREST:\r\nif(Ext_isone_sign(extent))\r\n{\r\nif(Ext_isnotzero_lower(extent) ||\r\nDbl_isone_lowmantissap2(resultp2))\r\n{\r\nDbl_increment(resultp1,resultp2);\r\n}\r\n}\r\nbreak;\r\ncase ROUNDPLUS:\r\nif(Dbl_iszero_sign(resultp1))\r\n{\r\nDbl_increment(resultp1,resultp2);\r\n}\r\nbreak;\r\ncase ROUNDMINUS:\r\nif(Dbl_isone_sign(resultp1))\r\n{\r\nDbl_increment(resultp1,resultp2);\r\n}\r\ncase ROUNDZERO:;\r\n}\r\nif(Dbl_isone_hiddenoverflow(resultp1)) result_exponent++;\r\n}\r\nif(result_exponent == DBL_INFINITY_EXPONENT)\r\n{\r\nif(Is_overflowtrap_enabled())\r\n{\r\nDbl_setwrapped_exponent(resultp1,result_exponent,ovfl);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nif (inexact)\r\nif (Is_inexacttrap_enabled())\r\nreturn(OVERFLOWEXCEPTION | INEXACTEXCEPTION);\r\nelse Set_inexactflag();\r\nreturn(OVERFLOWEXCEPTION);\r\n}\r\nelse\r\n{\r\ninexact = TRUE;\r\nSet_overflowflag();\r\nDbl_setoverflow(resultp1,resultp2);\r\n}\r\n}\r\nelse Dbl_set_exponent(resultp1,result_exponent);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nif(inexact)\r\nif(Is_inexacttrap_enabled()) return(INEXACTEXCEPTION);\r\nelse Set_inexactflag();\r\nreturn(NOEXCEPTION);\r\n}

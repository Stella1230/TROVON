static int ix2505v_read_status_reg(struct ix2505v_state *state)\r\n{\r\nu8 addr = state->config->tuner_address;\r\nu8 b2[] = {0};\r\nint ret;\r\nstruct i2c_msg msg[1] = {\r\n{ .addr = addr, .flags = I2C_M_RD, .buf = b2, .len = 1 }\r\n};\r\nret = i2c_transfer(state->i2c, msg, 1);\r\ndeb_i2c("Read %s ", __func__);\r\nreturn (ret == 1) ? (int) b2[0] : -1;\r\n}\r\nstatic int ix2505v_write(struct ix2505v_state *state, u8 buf[], u8 count)\r\n{\r\nstruct i2c_msg msg[1] = {\r\n{ .addr = state->config->tuner_address, .flags = 0,\r\n.buf = buf, .len = count },\r\n};\r\nint ret;\r\nret = i2c_transfer(state->i2c, msg, 1);\r\nif (ret != 1) {\r\ndeb_i2c("%s: i2c error, ret=%d\n", __func__, ret);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ix2505v_release(struct dvb_frontend *fe)\r\n{\r\nstruct ix2505v_state *state = fe->tuner_priv;\r\nfe->tuner_priv = NULL;\r\nkfree(state);\r\nreturn 0;\r\n}\r\nstatic int ix2505v_set_params(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nstruct ix2505v_state *state = fe->tuner_priv;\r\nu32 frequency = c->frequency;\r\nu32 b_w = (c->symbol_rate * 27) / 32000;\r\nu32 div_factor, N , A, x;\r\nint ret = 0, len;\r\nu8 gain, cc, ref, psc, local_osc, lpf;\r\nu8 data[4] = {0};\r\nif ((frequency < fe->ops.info.frequency_min)\r\n|| (frequency > fe->ops.info.frequency_max))\r\nreturn -EINVAL;\r\nif (state->config->tuner_gain)\r\ngain = (state->config->tuner_gain < 4)\r\n? state->config->tuner_gain : 0;\r\nelse\r\ngain = 0x0;\r\nif (state->config->tuner_chargepump)\r\ncc = state->config->tuner_chargepump;\r\nelse\r\ncc = 0x3;\r\nref = 8;\r\npsc = 32;\r\ndiv_factor = (frequency * ref) / 40;\r\nx = div_factor / psc;\r\nN = x/100;\r\nA = ((x - (N * 100)) * psc) / 100;\r\ndata[0] = ((gain & 0x3) << 5) | (N >> 3);\r\ndata[1] = (N << 5) | (A & 0x1f);\r\ndata[2] = 0x81 | ((cc & 0x3) << 5) ;\r\ndeb_info("Frq=%d x=%d N=%d A=%d\n", frequency, x, N, A);\r\nif (frequency <= 1065000)\r\nlocal_osc = (6 << 5) | 2;\r\nelse if (frequency <= 1170000)\r\nlocal_osc = (7 << 5) | 2;\r\nelse if (frequency <= 1300000)\r\nlocal_osc = (1 << 5);\r\nelse if (frequency <= 1445000)\r\nlocal_osc = (2 << 5);\r\nelse if (frequency <= 1607000)\r\nlocal_osc = (3 << 5);\r\nelse if (frequency <= 1778000)\r\nlocal_osc = (4 << 5);\r\nelse if (frequency <= 1942000)\r\nlocal_osc = (5 << 5);\r\nelse\r\nlocal_osc = (6 << 5);\r\ndata[3] = local_osc;\r\nif (b_w <= 10000)\r\nlpf = 0xc;\r\nelse if (b_w <= 12000)\r\nlpf = 0x2;\r\nelse if (b_w <= 14000)\r\nlpf = 0xa;\r\nelse if (b_w <= 16000)\r\nlpf = 0x6;\r\nelse if (b_w <= 18000)\r\nlpf = 0xe;\r\nelse if (b_w <= 20000)\r\nlpf = 0x1;\r\nelse if (b_w <= 22000)\r\nlpf = 0x9;\r\nelse if (b_w <= 24000)\r\nlpf = 0x5;\r\nelse if (b_w <= 26000)\r\nlpf = 0xd;\r\nelse if (b_w <= 28000)\r\nlpf = 0x3;\r\nelse\r\nlpf = 0xb;\r\ndeb_info("Osc=%x b_w=%x lpf=%x\n", local_osc, b_w, lpf);\r\ndeb_info("Data 0=[%x%x%x%x]\n", data[0], data[1], data[2], data[3]);\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nlen = sizeof(data);\r\nret |= ix2505v_write(state, data, len);\r\ndata[2] |= 0x4;\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nlen = 1;\r\nret |= ix2505v_write(state, &data[2], len);\r\nmsleep(10);\r\ndata[2] |= ((lpf >> 2) & 0x3) << 3;\r\ndata[3] |= (lpf & 0x3) << 2;\r\ndeb_info("Data 2=[%x%x]\n", data[2], data[3]);\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nlen = 2;\r\nret |= ix2505v_write(state, &data[2], len);\r\nif (state->config->min_delay_ms)\r\nmsleep(state->config->min_delay_ms);\r\nstate->frequency = frequency;\r\nreturn ret;\r\n}\r\nstatic int ix2505v_get_frequency(struct dvb_frontend *fe, u32 *frequency)\r\n{\r\nstruct ix2505v_state *state = fe->tuner_priv;\r\n*frequency = state->frequency;\r\nreturn 0;\r\n}\r\nstruct dvb_frontend *ix2505v_attach(struct dvb_frontend *fe,\r\nconst struct ix2505v_config *config,\r\nstruct i2c_adapter *i2c)\r\n{\r\nstruct ix2505v_state *state = NULL;\r\nint ret;\r\nif (NULL == config) {\r\ndeb_i2c("%s: no config ", __func__);\r\ngoto error;\r\n}\r\nstate = kzalloc(sizeof(struct ix2505v_state), GFP_KERNEL);\r\nif (NULL == state)\r\nreturn NULL;\r\nstate->config = config;\r\nstate->i2c = i2c;\r\nif (state->config->tuner_write_only) {\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nret = ix2505v_read_status_reg(state);\r\nif (ret & 0x80) {\r\ndeb_i2c("%s: No IX2505V found\n", __func__);\r\ngoto error;\r\n}\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\n}\r\nfe->tuner_priv = state;\r\nmemcpy(&fe->ops.tuner_ops, &ix2505v_tuner_ops,\r\nsizeof(struct dvb_tuner_ops));\r\ndeb_i2c("%s: initialization (%s addr=0x%02x) ok\n",\r\n__func__, fe->ops.tuner_ops.info.name, config->tuner_address);\r\nreturn fe;\r\nerror:\r\nkfree(state);\r\nreturn NULL;\r\n}

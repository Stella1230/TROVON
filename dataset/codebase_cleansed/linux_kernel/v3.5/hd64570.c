static inline struct net_device *port_to_dev(port_t *port)\r\n{\r\nreturn port->dev;\r\n}\r\nstatic inline int sca_intr_status(card_t *card)\r\n{\r\nu8 result = 0;\r\nu8 isr0 = sca_in(ISR0, card);\r\nu8 isr1 = sca_in(ISR1, card);\r\nif (isr1 & 0x03) result |= SCA_INTR_DMAC_RX(0);\r\nif (isr1 & 0x0C) result |= SCA_INTR_DMAC_TX(0);\r\nif (isr1 & 0x30) result |= SCA_INTR_DMAC_RX(1);\r\nif (isr1 & 0xC0) result |= SCA_INTR_DMAC_TX(1);\r\nif (isr0 & 0x0F) result |= SCA_INTR_MSCI(0);\r\nif (isr0 & 0xF0) result |= SCA_INTR_MSCI(1);\r\nif (!(result & SCA_INTR_DMAC_TX(0)))\r\nif (sca_in(DSR_TX(0), card) & DSR_EOM)\r\nresult |= SCA_INTR_DMAC_TX(0);\r\nif (!(result & SCA_INTR_DMAC_TX(1)))\r\nif (sca_in(DSR_TX(1), card) & DSR_EOM)\r\nresult |= SCA_INTR_DMAC_TX(1);\r\nreturn result;\r\n}\r\nstatic inline port_t* dev_to_port(struct net_device *dev)\r\n{\r\nreturn dev_to_hdlc(dev)->priv;\r\n}\r\nstatic inline u16 next_desc(port_t *port, u16 desc, int transmit)\r\n{\r\nreturn (desc + 1) % (transmit ? port_to_card(port)->tx_ring_buffers\r\n: port_to_card(port)->rx_ring_buffers);\r\n}\r\nstatic inline u16 desc_abs_number(port_t *port, u16 desc, int transmit)\r\n{\r\nu16 rx_buffs = port_to_card(port)->rx_ring_buffers;\r\nu16 tx_buffs = port_to_card(port)->tx_ring_buffers;\r\ndesc %= (transmit ? tx_buffs : rx_buffs);\r\nreturn log_node(port) * (rx_buffs + tx_buffs) +\r\ntransmit * rx_buffs + desc;\r\n}\r\nstatic inline u16 desc_offset(port_t *port, u16 desc, int transmit)\r\n{\r\nreturn desc_abs_number(port, desc, transmit) * sizeof(pkt_desc);\r\n}\r\nstatic inline pkt_desc __iomem *desc_address(port_t *port, u16 desc,\r\nint transmit)\r\n{\r\n#ifdef PAGE0_ALWAYS_MAPPED\r\nreturn (pkt_desc __iomem *)(win0base(port_to_card(port))\r\n+ desc_offset(port, desc, transmit));\r\n#else\r\nreturn (pkt_desc __iomem *)(winbase(port_to_card(port))\r\n+ desc_offset(port, desc, transmit));\r\n#endif\r\n}\r\nstatic inline u32 buffer_offset(port_t *port, u16 desc, int transmit)\r\n{\r\nreturn port_to_card(port)->buff_offset +\r\ndesc_abs_number(port, desc, transmit) * (u32)HDLC_MAX_MRU;\r\n}\r\nstatic inline void sca_set_carrier(port_t *port)\r\n{\r\nif (!(sca_in(get_msci(port) + ST3, port_to_card(port)) & ST3_DCD)) {\r\n#ifdef DEBUG_LINK\r\nprintk(KERN_DEBUG "%s: sca_set_carrier on\n",\r\nport_to_dev(port)->name);\r\n#endif\r\nnetif_carrier_on(port_to_dev(port));\r\n} else {\r\n#ifdef DEBUG_LINK\r\nprintk(KERN_DEBUG "%s: sca_set_carrier off\n",\r\nport_to_dev(port)->name);\r\n#endif\r\nnetif_carrier_off(port_to_dev(port));\r\n}\r\n}\r\nstatic void sca_init_port(port_t *port)\r\n{\r\ncard_t *card = port_to_card(port);\r\nint transmit, i;\r\nport->rxin = 0;\r\nport->txin = 0;\r\nport->txlast = 0;\r\n#ifndef PAGE0_ALWAYS_MAPPED\r\nopenwin(card, 0);\r\n#endif\r\nfor (transmit = 0; transmit < 2; transmit++) {\r\nu16 dmac = transmit ? get_dmac_tx(port) : get_dmac_rx(port);\r\nu16 buffs = transmit ? card->tx_ring_buffers\r\n: card->rx_ring_buffers;\r\nfor (i = 0; i < buffs; i++) {\r\npkt_desc __iomem *desc = desc_address(port, i, transmit);\r\nu16 chain_off = desc_offset(port, i + 1, transmit);\r\nu32 buff_off = buffer_offset(port, i, transmit);\r\nwritew(chain_off, &desc->cp);\r\nwritel(buff_off, &desc->bp);\r\nwritew(0, &desc->len);\r\nwriteb(0, &desc->stat);\r\n}\r\nsca_out(0, transmit ? DSR_TX(phy_node(port)) :\r\nDSR_RX(phy_node(port)), card);\r\nsca_out(DCR_ABORT, transmit ? DCR_TX(phy_node(port)) :\r\nDCR_RX(phy_node(port)), card);\r\nsca_out(0, dmac + CPB, card);\r\nsca_outw(desc_offset(port, 0, transmit), dmac + CDAL, card);\r\nif (!transmit)\r\nsca_outw(desc_offset(port, buffs - 1, transmit),\r\ndmac + EDAL, card);\r\nelse\r\nsca_outw(desc_offset(port, 0, transmit), dmac + EDAL,\r\ncard);\r\nsca_out(DCR_CLEAR_EOF, transmit ? DCR_TX(phy_node(port)) :\r\nDCR_RX(phy_node(port)), card);\r\nif (!transmit) {\r\nsca_outw(HDLC_MAX_MRU, dmac + BFLL, card);\r\nsca_out(0x14, DMR_RX(phy_node(port)), card);\r\nsca_out(DIR_EOME | DIR_BOFE, DIR_RX(phy_node(port)),\r\ncard);\r\nsca_out(DSR_DE, DSR_RX(phy_node(port)), card);\r\n} else {\r\nsca_out(0x14, DMR_TX(phy_node(port)), card);\r\nsca_out(DIR_BOFE, DIR_TX(phy_node(port)), card);\r\n}\r\n}\r\nsca_set_carrier(port);\r\n}\r\nstatic inline void sca_msci_intr(port_t *port)\r\n{\r\nu16 msci = get_msci(port);\r\ncard_t* card = port_to_card(port);\r\nu8 stat = sca_in(msci + ST1, card);\r\nsca_out(stat & (ST1_UDRN | ST1_CDCD), msci + ST1, card);\r\nif (stat & ST1_UDRN) {\r\nport_to_dev(port)->stats.tx_errors++;\r\nport_to_dev(port)->stats.tx_fifo_errors++;\r\n}\r\nif (stat & ST1_CDCD)\r\nsca_set_carrier(port);\r\n}\r\nstatic inline void sca_rx(card_t *card, port_t *port, pkt_desc __iomem *desc,\r\nu16 rxin)\r\n{\r\nstruct net_device *dev = port_to_dev(port);\r\nstruct sk_buff *skb;\r\nu16 len;\r\nu32 buff;\r\nu32 maxlen;\r\nu8 page;\r\nlen = readw(&desc->len);\r\nskb = dev_alloc_skb(len);\r\nif (!skb) {\r\ndev->stats.rx_dropped++;\r\nreturn;\r\n}\r\nbuff = buffer_offset(port, rxin, 0);\r\npage = buff / winsize(card);\r\nbuff = buff % winsize(card);\r\nmaxlen = winsize(card) - buff;\r\nopenwin(card, page);\r\nif (len > maxlen) {\r\nmemcpy_fromio(skb->data, winbase(card) + buff, maxlen);\r\nopenwin(card, page + 1);\r\nmemcpy_fromio(skb->data + maxlen, winbase(card), len - maxlen);\r\n} else\r\nmemcpy_fromio(skb->data, winbase(card) + buff, len);\r\n#ifndef PAGE0_ALWAYS_MAPPED\r\nopenwin(card, 0);\r\n#endif\r\nskb_put(skb, len);\r\n#ifdef DEBUG_PKT\r\nprintk(KERN_DEBUG "%s RX(%i):", dev->name, skb->len);\r\ndebug_frame(skb);\r\n#endif\r\ndev->stats.rx_packets++;\r\ndev->stats.rx_bytes += skb->len;\r\nskb->protocol = hdlc_type_trans(skb, dev);\r\nnetif_rx(skb);\r\n}\r\nstatic inline void sca_rx_intr(port_t *port)\r\n{\r\nstruct net_device *dev = port_to_dev(port);\r\nu16 dmac = get_dmac_rx(port);\r\ncard_t *card = port_to_card(port);\r\nu8 stat = sca_in(DSR_RX(phy_node(port)), card);\r\nsca_out((stat & (DSR_EOT | DSR_EOM | DSR_BOF | DSR_COF)) | DSR_DWE,\r\nDSR_RX(phy_node(port)), card);\r\nif (stat & DSR_BOF)\r\ndev->stats.rx_over_errors++;\r\nwhile (1) {\r\nu32 desc_off = desc_offset(port, port->rxin, 0);\r\npkt_desc __iomem *desc;\r\nu32 cda = sca_inw(dmac + CDAL, card);\r\nif ((cda >= desc_off) && (cda < desc_off + sizeof(pkt_desc)))\r\nbreak;\r\ndesc = desc_address(port, port->rxin, 0);\r\nstat = readb(&desc->stat);\r\nif (!(stat & ST_RX_EOM))\r\nport->rxpart = 1;\r\nelse if ((stat & ST_ERROR_MASK) || port->rxpart) {\r\ndev->stats.rx_errors++;\r\nif (stat & ST_RX_OVERRUN)\r\ndev->stats.rx_fifo_errors++;\r\nelse if ((stat & (ST_RX_SHORT | ST_RX_ABORT |\r\nST_RX_RESBIT)) || port->rxpart)\r\ndev->stats.rx_frame_errors++;\r\nelse if (stat & ST_RX_CRC)\r\ndev->stats.rx_crc_errors++;\r\nif (stat & ST_RX_EOM)\r\nport->rxpart = 0;\r\n} else\r\nsca_rx(card, port, desc, port->rxin);\r\nsca_outw(desc_off, dmac + EDAL, card);\r\nport->rxin = next_desc(port, port->rxin, 0);\r\n}\r\nsca_out(DSR_DE, DSR_RX(phy_node(port)), card);\r\n}\r\nstatic inline void sca_tx_intr(port_t *port)\r\n{\r\nstruct net_device *dev = port_to_dev(port);\r\nu16 dmac = get_dmac_tx(port);\r\ncard_t* card = port_to_card(port);\r\nu8 stat;\r\nspin_lock(&port->lock);\r\nstat = sca_in(DSR_TX(phy_node(port)), card);\r\nsca_out((stat & (DSR_EOT | DSR_EOM | DSR_BOF | DSR_COF)) | DSR_DWE,\r\nDSR_TX(phy_node(port)), card);\r\nwhile (1) {\r\npkt_desc __iomem *desc;\r\nu32 desc_off = desc_offset(port, port->txlast, 1);\r\nu32 cda = sca_inw(dmac + CDAL, card);\r\nif ((cda >= desc_off) && (cda < desc_off + sizeof(pkt_desc)))\r\nbreak;\r\ndesc = desc_address(port, port->txlast, 1);\r\ndev->stats.tx_packets++;\r\ndev->stats.tx_bytes += readw(&desc->len);\r\nwriteb(0, &desc->stat);\r\nport->txlast = next_desc(port, port->txlast, 1);\r\n}\r\nnetif_wake_queue(dev);\r\nspin_unlock(&port->lock);\r\n}\r\nstatic irqreturn_t sca_intr(int irq, void* dev_id)\r\n{\r\ncard_t *card = dev_id;\r\nint i;\r\nu8 stat;\r\nint handled = 0;\r\nu8 page = sca_get_page(card);\r\nwhile((stat = sca_intr_status(card)) != 0) {\r\nhandled = 1;\r\nfor (i = 0; i < 2; i++) {\r\nport_t *port = get_port(card, i);\r\nif (port) {\r\nif (stat & SCA_INTR_MSCI(i))\r\nsca_msci_intr(port);\r\nif (stat & SCA_INTR_DMAC_RX(i))\r\nsca_rx_intr(port);\r\nif (stat & SCA_INTR_DMAC_TX(i))\r\nsca_tx_intr(port);\r\n}\r\n}\r\n}\r\nopenwin(card, page);\r\nreturn IRQ_RETVAL(handled);\r\n}\r\nstatic void sca_set_port(port_t *port)\r\n{\r\ncard_t* card = port_to_card(port);\r\nu16 msci = get_msci(port);\r\nu8 md2 = sca_in(msci + MD2, card);\r\nunsigned int tmc, br = 10, brv = 1024;\r\nif (port->settings.clock_rate > 0) {\r\ndo {\r\nbr--;\r\nbrv >>= 1;\r\ntmc = CLOCK_BASE / brv / port->settings.clock_rate;\r\n}while (br > 1 && tmc <= 128);\r\nif (tmc < 1) {\r\ntmc = 1;\r\nbr = 0;\r\nbrv = 1;\r\n} else if (tmc > 255)\r\ntmc = 256;\r\nport->settings.clock_rate = CLOCK_BASE / brv / tmc;\r\n} else {\r\nbr = 9;\r\ntmc = 256;\r\nport->settings.clock_rate = CLOCK_BASE / (256 * 512);\r\n}\r\nport->rxs = (port->rxs & ~CLK_BRG_MASK) | br;\r\nport->txs = (port->txs & ~CLK_BRG_MASK) | br;\r\nport->tmc = tmc;\r\nsca_out(port->tmc, msci + TMC, card);\r\nsca_out(port->rxs, msci + RXS, card);\r\nsca_out(port->txs, msci + TXS, card);\r\nif (port->settings.loopback)\r\nmd2 |= MD2_LOOPBACK;\r\nelse\r\nmd2 &= ~MD2_LOOPBACK;\r\nsca_out(md2, msci + MD2, card);\r\n}\r\nstatic void sca_open(struct net_device *dev)\r\n{\r\nport_t *port = dev_to_port(dev);\r\ncard_t* card = port_to_card(port);\r\nu16 msci = get_msci(port);\r\nu8 md0, md2;\r\nswitch(port->encoding) {\r\ncase ENCODING_NRZ: md2 = MD2_NRZ; break;\r\ncase ENCODING_NRZI: md2 = MD2_NRZI; break;\r\ncase ENCODING_FM_MARK: md2 = MD2_FM_MARK; break;\r\ncase ENCODING_FM_SPACE: md2 = MD2_FM_SPACE; break;\r\ndefault: md2 = MD2_MANCHESTER;\r\n}\r\nif (port->settings.loopback)\r\nmd2 |= MD2_LOOPBACK;\r\nswitch(port->parity) {\r\ncase PARITY_CRC16_PR0: md0 = MD0_HDLC | MD0_CRC_16_0; break;\r\ncase PARITY_CRC16_PR1: md0 = MD0_HDLC | MD0_CRC_16; break;\r\ncase PARITY_CRC16_PR0_CCITT: md0 = MD0_HDLC | MD0_CRC_ITU_0; break;\r\ncase PARITY_CRC16_PR1_CCITT: md0 = MD0_HDLC | MD0_CRC_ITU; break;\r\ndefault: md0 = MD0_HDLC | MD0_CRC_NONE;\r\n}\r\nsca_out(CMD_RESET, msci + CMD, card);\r\nsca_out(md0, msci + MD0, card);\r\nsca_out(0x00, msci + MD1, card);\r\nsca_out(md2, msci + MD2, card);\r\nsca_out(0x7E, msci + IDL, card);\r\nsca_out(CTL_IDLE, msci + CTL, card);\r\nsca_out(0x07, msci + RRC, card);\r\nsca_out(0x10, msci + TRC0, card);\r\nsca_out(0x14, msci + TRC1, card);\r\nsca_set_carrier(port);\r\nsca_out(IE0_TXINT | IE0_RXINTA, msci + IE0, card);\r\nsca_out(IE1_UDRN | IE1_CDCD, msci + IE1, card);\r\nsca_out(sca_in(IER0, card) | (phy_node(port) ? 0xC0 : 0x0C),\r\nIER0, card);\r\nsca_out(sca_in(IER1, card) | (phy_node(port) ? 0xF0 : 0x0F),\r\nIER1, card);\r\nsca_out(port->tmc, msci + TMC, card);\r\nsca_out(port->rxs, msci + RXS, card);\r\nsca_out(port->txs, msci + TXS, card);\r\nsca_out(CMD_TX_ENABLE, msci + CMD, card);\r\nsca_out(CMD_RX_ENABLE, msci + CMD, card);\r\nnetif_start_queue(dev);\r\n}\r\nstatic void sca_close(struct net_device *dev)\r\n{\r\nport_t *port = dev_to_port(dev);\r\ncard_t* card = port_to_card(port);\r\nsca_out(CMD_RESET, get_msci(port) + CMD, port_to_card(port));\r\nsca_out(sca_in(IER0, card) & (phy_node(port) ? 0x0F : 0xF0),\r\nIER0, card);\r\nsca_out(sca_in(IER1, card) & (phy_node(port) ? 0x0F : 0xF0),\r\nIER1, card);\r\nnetif_stop_queue(dev);\r\n}\r\nstatic int sca_attach(struct net_device *dev, unsigned short encoding,\r\nunsigned short parity)\r\n{\r\nif (encoding != ENCODING_NRZ &&\r\nencoding != ENCODING_NRZI &&\r\nencoding != ENCODING_FM_MARK &&\r\nencoding != ENCODING_FM_SPACE &&\r\nencoding != ENCODING_MANCHESTER)\r\nreturn -EINVAL;\r\nif (parity != PARITY_NONE &&\r\nparity != PARITY_CRC16_PR0 &&\r\nparity != PARITY_CRC16_PR1 &&\r\nparity != PARITY_CRC16_PR0_CCITT &&\r\nparity != PARITY_CRC16_PR1_CCITT)\r\nreturn -EINVAL;\r\ndev_to_port(dev)->encoding = encoding;\r\ndev_to_port(dev)->parity = parity;\r\nreturn 0;\r\n}\r\nstatic void sca_dump_rings(struct net_device *dev)\r\n{\r\nport_t *port = dev_to_port(dev);\r\ncard_t *card = port_to_card(port);\r\nu16 cnt;\r\n#ifndef PAGE0_ALWAYS_MAPPED\r\nu8 page = sca_get_page(card);\r\nopenwin(card, 0);\r\n#endif\r\nprintk(KERN_DEBUG "RX ring: CDA=%u EDA=%u DSR=%02X in=%u %sactive",\r\nsca_inw(get_dmac_rx(port) + CDAL, card),\r\nsca_inw(get_dmac_rx(port) + EDAL, card),\r\nsca_in(DSR_RX(phy_node(port)), card), port->rxin,\r\nsca_in(DSR_RX(phy_node(port)), card) & DSR_DE ? "" : "in");\r\nfor (cnt = 0; cnt < port_to_card(port)->rx_ring_buffers; cnt++)\r\npr_cont(" %02X", readb(&(desc_address(port, cnt, 0)->stat)));\r\npr_cont("\n");\r\nprintk(KERN_DEBUG "TX ring: CDA=%u EDA=%u DSR=%02X in=%u "\r\n"last=%u %sactive",\r\nsca_inw(get_dmac_tx(port) + CDAL, card),\r\nsca_inw(get_dmac_tx(port) + EDAL, card),\r\nsca_in(DSR_TX(phy_node(port)), card), port->txin, port->txlast,\r\nsca_in(DSR_TX(phy_node(port)), card) & DSR_DE ? "" : "in");\r\nfor (cnt = 0; cnt < port_to_card(port)->tx_ring_buffers; cnt++)\r\npr_cont(" %02X", readb(&(desc_address(port, cnt, 1)->stat)));\r\npr_cont("\n");\r\nprintk(KERN_DEBUG "MSCI: MD: %02x %02x %02x, ST: %02x %02x %02x %02x,"\r\n" FST: %02x CST: %02x %02x\n",\r\nsca_in(get_msci(port) + MD0, card),\r\nsca_in(get_msci(port) + MD1, card),\r\nsca_in(get_msci(port) + MD2, card),\r\nsca_in(get_msci(port) + ST0, card),\r\nsca_in(get_msci(port) + ST1, card),\r\nsca_in(get_msci(port) + ST2, card),\r\nsca_in(get_msci(port) + ST3, card),\r\nsca_in(get_msci(port) + FST, card),\r\nsca_in(get_msci(port) + CST0, card),\r\nsca_in(get_msci(port) + CST1, card));\r\nprintk(KERN_DEBUG "ISR: %02x %02x %02x\n", sca_in(ISR0, card),\r\nsca_in(ISR1, card), sca_in(ISR2, card));\r\n#ifndef PAGE0_ALWAYS_MAPPED\r\nopenwin(card, page);\r\n#endif\r\n}\r\nstatic netdev_tx_t sca_xmit(struct sk_buff *skb, struct net_device *dev)\r\n{\r\nport_t *port = dev_to_port(dev);\r\ncard_t *card = port_to_card(port);\r\npkt_desc __iomem *desc;\r\nu32 buff, len;\r\nu8 page;\r\nu32 maxlen;\r\nspin_lock_irq(&port->lock);\r\ndesc = desc_address(port, port->txin + 1, 1);\r\nBUG_ON(readb(&desc->stat));\r\n#ifdef DEBUG_PKT\r\nprintk(KERN_DEBUG "%s TX(%i):", dev->name, skb->len);\r\ndebug_frame(skb);\r\n#endif\r\ndesc = desc_address(port, port->txin, 1);\r\nbuff = buffer_offset(port, port->txin, 1);\r\nlen = skb->len;\r\npage = buff / winsize(card);\r\nbuff = buff % winsize(card);\r\nmaxlen = winsize(card) - buff;\r\nopenwin(card, page);\r\nif (len > maxlen) {\r\nmemcpy_toio(winbase(card) + buff, skb->data, maxlen);\r\nopenwin(card, page + 1);\r\nmemcpy_toio(winbase(card), skb->data + maxlen, len - maxlen);\r\n} else\r\nmemcpy_toio(winbase(card) + buff, skb->data, len);\r\n#ifndef PAGE0_ALWAYS_MAPPED\r\nopenwin(card, 0);\r\n#endif\r\nwritew(len, &desc->len);\r\nwriteb(ST_TX_EOM, &desc->stat);\r\nport->txin = next_desc(port, port->txin, 1);\r\nsca_outw(desc_offset(port, port->txin, 1),\r\nget_dmac_tx(port) + EDAL, card);\r\nsca_out(DSR_DE, DSR_TX(phy_node(port)), card);\r\ndesc = desc_address(port, port->txin + 1, 1);\r\nif (readb(&desc->stat))\r\nnetif_stop_queue(dev);\r\nspin_unlock_irq(&port->lock);\r\ndev_kfree_skb(skb);\r\nreturn NETDEV_TX_OK;\r\n}\r\nstatic u32 __devinit sca_detect_ram(card_t *card, u8 __iomem *rambase,\r\nu32 ramsize)\r\n{\r\nu32 i = ramsize &= ~3;\r\nu32 size = winsize(card);\r\nopenwin(card, (i - 4) / size);\r\ndo {\r\ni -= 4;\r\nif ((i + 4) % size == 0)\r\nopenwin(card, i / size);\r\nwritel(i ^ 0x12345678, rambase + i % size);\r\n} while (i > 0);\r\nfor (i = 0; i < ramsize ; i += 4) {\r\nif (i % size == 0)\r\nopenwin(card, i / size);\r\nif (readl(rambase + i % size) != (i ^ 0x12345678))\r\nbreak;\r\n}\r\nreturn i;\r\n}\r\nstatic void __devinit sca_init(card_t *card, int wait_states)\r\n{\r\nsca_out(wait_states, WCRL, card);\r\nsca_out(wait_states, WCRM, card);\r\nsca_out(wait_states, WCRH, card);\r\nsca_out(0, DMER, card);\r\nsca_out(0x03, PCR, card);\r\nsca_out(0, DSR_RX(0), card);\r\nsca_out(0, DSR_TX(0), card);\r\nsca_out(0, DSR_RX(1), card);\r\nsca_out(0, DSR_TX(1), card);\r\nsca_out(DMER_DME, DMER, card);\r\n}

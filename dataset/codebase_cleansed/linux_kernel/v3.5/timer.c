static cycle_t vt8500_timer_read(struct clocksource *cs)\r\n{\r\nint loops = msecs_to_loops(10);\r\nwritel(3, regbase + TIMER_CTRL_VAL);\r\nwhile ((readl((regbase + TIMER_AS_VAL)) & TIMER_COUNT_R_ACTIVE)\r\n&& --loops)\r\ncpu_relax();\r\nreturn readl(regbase + TIMER_COUNT_VAL);\r\n}\r\nstatic int vt8500_timer_set_next_event(unsigned long cycles,\r\nstruct clock_event_device *evt)\r\n{\r\nint loops = msecs_to_loops(10);\r\ncycle_t alarm = clocksource.read(&clocksource) + cycles;\r\nwhile ((readl(regbase + TIMER_AS_VAL) & TIMER_MATCH_W_ACTIVE)\r\n&& --loops)\r\ncpu_relax();\r\nwritel((unsigned long)alarm, regbase + TIMER_MATCH_VAL);\r\nif ((signed)(alarm - clocksource.read(&clocksource)) <= 16)\r\nreturn -ETIME;\r\nwritel(1, regbase + TIMER_IER_VAL);\r\nreturn 0;\r\n}\r\nstatic void vt8500_timer_set_mode(enum clock_event_mode mode,\r\nstruct clock_event_device *evt)\r\n{\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_RESUME:\r\ncase CLOCK_EVT_MODE_PERIODIC:\r\nbreak;\r\ncase CLOCK_EVT_MODE_ONESHOT:\r\ncase CLOCK_EVT_MODE_UNUSED:\r\ncase CLOCK_EVT_MODE_SHUTDOWN:\r\nwritel(readl(regbase + TIMER_CTRL_VAL) | 1,\r\nregbase + TIMER_CTRL_VAL);\r\nwritel(0, regbase + TIMER_IER_VAL);\r\nbreak;\r\n}\r\n}\r\nstatic irqreturn_t vt8500_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = dev_id;\r\nwritel(0xf, regbase + TIMER_STATUS_VAL);\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __init vt8500_timer_init(void)\r\n{\r\nregbase = ioremap(wmt_pmc_base + VT8500_TIMER_OFFSET, 0x28);\r\nif (!regbase)\r\nprintk(KERN_ERR "vt8500_timer_init: failed to map MMIO registers\n");\r\nwritel(1, regbase + TIMER_CTRL_VAL);\r\nwritel(0xf, regbase + TIMER_STATUS_VAL);\r\nwritel(~0, regbase + TIMER_MATCH_VAL);\r\nif (clocksource_register_hz(&clocksource, VT8500_TIMER_HZ))\r\nprintk(KERN_ERR "vt8500_timer_init: clocksource_register failed for %s\n",\r\nclocksource.name);\r\nclockevents_calc_mult_shift(&clockevent, VT8500_TIMER_HZ, 4);\r\nclockevent.max_delta_ns =\r\nclockevent_delta2ns(0xf0000000, &clockevent);\r\nclockevent.min_delta_ns = clockevent_delta2ns(4, &clockevent);\r\nclockevent.cpumask = cpumask_of(0);\r\nif (setup_irq(wmt_timer_irq, &irq))\r\nprintk(KERN_ERR "vt8500_timer_init: setup_irq failed for %s\n",\r\nclockevent.name);\r\nclockevents_register_device(&clockevent);\r\n}

static int pas_midi_open(int dev, int mode,\r\nvoid (*input) (int dev, unsigned char data),\r\nvoid (*output) (int dev)\r\n)\r\n{\r\nint err;\r\nunsigned long flags;\r\nunsigned char ctrl;\r\nif (midi_busy)\r\nreturn -EBUSY;\r\npas_write(0x20 | 0x40,\r\n0x178b);\r\nspin_lock_irqsave(&pas_lock, flags);\r\nif ((err = pas_set_intr(0x10)) < 0)\r\n{\r\nspin_unlock_irqrestore(&pas_lock, flags);\r\nreturn err;\r\n}\r\nctrl = 0;\r\ninput_opened = 0;\r\nmidi_input_intr = input;\r\nif (mode == OPEN_READ || mode == OPEN_READWRITE)\r\n{\r\nctrl |= 0x04;\r\ninput_opened = 1;\r\n}\r\nif (mode == OPEN_WRITE || mode == OPEN_READWRITE)\r\n{\r\nctrl |= 0x08 | 0x10;\r\n}\r\npas_write(ctrl, 0x178b);\r\npas_write(0xff, 0x1B88);\r\nspin_unlock_irqrestore(&pas_lock, flags);\r\nmidi_busy = 1;\r\nqlen = qhead = qtail = 0;\r\nreturn 0;\r\n}\r\nstatic void pas_midi_close(int dev)\r\n{\r\npas_write(0x20 | 0x40, 0x178b);\r\npas_remove_intr(0x10);\r\nmidi_busy = 0;\r\n}\r\nstatic int dump_to_midi(unsigned char midi_byte)\r\n{\r\nint fifo_space, x;\r\nfifo_space = ((x = pas_read(0x1B89)) >> 4) & 0x0f;\r\nif (fifo_space < 2 && fifo_space != 0)\r\nreturn 0;\r\npas_write(midi_byte, 0x178A);\r\nreturn 1;\r\n}\r\nstatic int pas_midi_out(int dev, unsigned char midi_byte)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&pas_lock, flags);\r\nwhile (qlen && dump_to_midi(tmp_queue[qhead]))\r\n{\r\nqlen--;\r\nqhead++;\r\n}\r\nspin_unlock_irqrestore(&pas_lock, flags);\r\nif (!qlen)\r\nif (dump_to_midi(midi_byte))\r\nreturn 1;\r\nif (qlen >= 256)\r\nreturn 0;\r\nspin_lock_irqsave(&pas_lock, flags);\r\ntmp_queue[qtail] = midi_byte;\r\nqlen++;\r\nqtail++;\r\nspin_unlock_irqrestore(&pas_lock, flags);\r\nreturn 1;\r\n}\r\nstatic int pas_midi_start_read(int dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int pas_midi_end_read(int dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic void pas_midi_kick(int dev)\r\n{\r\n}\r\nstatic int pas_buffer_status(int dev)\r\n{\r\nreturn qlen;\r\n}\r\nvoid __init pas_midi_init(void)\r\n{\r\nint dev = sound_alloc_mididev();\r\nif (dev == -1)\r\n{\r\nprintk(KERN_WARNING "pas_midi_init: Too many midi devices detected\n");\r\nreturn;\r\n}\r\nstd_midi_synth.midi_dev = my_dev = dev;\r\nmidi_devs[dev] = &pas_midi_operations;\r\npas2_mididev = dev;\r\nsequencer_init();\r\n}\r\nvoid pas_midi_interrupt(void)\r\n{\r\nunsigned char stat;\r\nint i, incount;\r\nstat = pas_read(0x1B88);\r\nif (stat & 0x04)\r\n{\r\nincount = pas_read(0x1B89) & 0x0f;\r\nif (!incount)\r\nincount = 16;\r\nfor (i = 0; i < incount; i++)\r\nif (input_opened)\r\n{\r\nmidi_input_intr(my_dev, pas_read(0x178A));\r\n} else\r\npas_read(0x178A);\r\n}\r\nif (stat & (0x08 | 0x10))\r\n{\r\nspin_lock(&pas_lock);\r\nwhile (qlen && dump_to_midi(tmp_queue[qhead]))\r\n{\r\nqlen--;\r\nqhead++;\r\n}\r\nspin_unlock(&pas_lock);\r\n}\r\nif (stat & 0x40)\r\n{\r\nprintk(KERN_WARNING "MIDI output overrun %x,%x\n", pas_read(0x1B89), stat);\r\n}\r\npas_write(stat, 0x1B88);\r\n}

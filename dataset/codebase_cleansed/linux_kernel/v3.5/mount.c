static int tomoyo_audit_mount_log(struct tomoyo_request_info *r)\r\n{\r\nreturn tomoyo_supervisor(r, "file mount %s %s %s 0x%lX\n",\r\nr->param.mount.dev->name,\r\nr->param.mount.dir->name,\r\nr->param.mount.type->name,\r\nr->param.mount.flags);\r\n}\r\nstatic bool tomoyo_check_mount_acl(struct tomoyo_request_info *r,\r\nconst struct tomoyo_acl_info *ptr)\r\n{\r\nconst struct tomoyo_mount_acl *acl =\r\ncontainer_of(ptr, typeof(*acl), head);\r\nreturn tomoyo_compare_number_union(r->param.mount.flags,\r\n&acl->flags) &&\r\ntomoyo_compare_name_union(r->param.mount.type,\r\n&acl->fs_type) &&\r\ntomoyo_compare_name_union(r->param.mount.dir,\r\n&acl->dir_name) &&\r\n(!r->param.mount.need_dev ||\r\ntomoyo_compare_name_union(r->param.mount.dev,\r\n&acl->dev_name));\r\n}\r\nstatic int tomoyo_mount_acl(struct tomoyo_request_info *r, char *dev_name,\r\nstruct path *dir, const char *type,\r\nunsigned long flags)\r\n{\r\nstruct tomoyo_obj_info obj = { };\r\nstruct path path;\r\nstruct file_system_type *fstype = NULL;\r\nconst char *requested_type = NULL;\r\nconst char *requested_dir_name = NULL;\r\nconst char *requested_dev_name = NULL;\r\nstruct tomoyo_path_info rtype;\r\nstruct tomoyo_path_info rdev;\r\nstruct tomoyo_path_info rdir;\r\nint need_dev = 0;\r\nint error = -ENOMEM;\r\nr->obj = &obj;\r\nrequested_type = tomoyo_encode(type);\r\nif (!requested_type)\r\ngoto out;\r\nrtype.name = requested_type;\r\ntomoyo_fill_path_info(&rtype);\r\nobj.path2 = *dir;\r\nrequested_dir_name = tomoyo_realpath_from_path(dir);\r\nif (!requested_dir_name) {\r\nerror = -ENOMEM;\r\ngoto out;\r\n}\r\nrdir.name = requested_dir_name;\r\ntomoyo_fill_path_info(&rdir);\r\nif (type == tomoyo_mounts[TOMOYO_MOUNT_REMOUNT]) {\r\n} else if (type == tomoyo_mounts[TOMOYO_MOUNT_MAKE_UNBINDABLE] ||\r\ntype == tomoyo_mounts[TOMOYO_MOUNT_MAKE_PRIVATE] ||\r\ntype == tomoyo_mounts[TOMOYO_MOUNT_MAKE_SLAVE] ||\r\ntype == tomoyo_mounts[TOMOYO_MOUNT_MAKE_SHARED]) {\r\n} else if (type == tomoyo_mounts[TOMOYO_MOUNT_BIND] ||\r\ntype == tomoyo_mounts[TOMOYO_MOUNT_MOVE]) {\r\nneed_dev = -1;\r\n} else {\r\nfstype = get_fs_type(type);\r\nif (!fstype) {\r\nerror = -ENODEV;\r\ngoto out;\r\n}\r\nif (fstype->fs_flags & FS_REQUIRES_DEV)\r\nneed_dev = 1;\r\n}\r\nif (need_dev) {\r\nif (!dev_name || kern_path(dev_name, LOOKUP_FOLLOW, &path)) {\r\nerror = -ENOENT;\r\ngoto out;\r\n}\r\nobj.path1 = path;\r\nrequested_dev_name = tomoyo_realpath_from_path(&path);\r\nif (!requested_dev_name) {\r\nerror = -ENOENT;\r\ngoto out;\r\n}\r\n} else {\r\nif (!dev_name)\r\ndev_name = "<NULL>";\r\nrequested_dev_name = tomoyo_encode(dev_name);\r\nif (!requested_dev_name) {\r\nerror = -ENOMEM;\r\ngoto out;\r\n}\r\n}\r\nrdev.name = requested_dev_name;\r\ntomoyo_fill_path_info(&rdev);\r\nr->param_type = TOMOYO_TYPE_MOUNT_ACL;\r\nr->param.mount.need_dev = need_dev;\r\nr->param.mount.dev = &rdev;\r\nr->param.mount.dir = &rdir;\r\nr->param.mount.type = &rtype;\r\nr->param.mount.flags = flags;\r\ndo {\r\ntomoyo_check_acl(r, tomoyo_check_mount_acl);\r\nerror = tomoyo_audit_mount_log(r);\r\n} while (error == TOMOYO_RETRY_REQUEST);\r\nout:\r\nkfree(requested_dev_name);\r\nkfree(requested_dir_name);\r\nif (fstype)\r\nput_filesystem(fstype);\r\nkfree(requested_type);\r\nif (obj.path1.dentry)\r\npath_put(&obj.path1);\r\nreturn error;\r\n}\r\nint tomoyo_mount_permission(char *dev_name, struct path *path,\r\nconst char *type, unsigned long flags,\r\nvoid *data_page)\r\n{\r\nstruct tomoyo_request_info r;\r\nint error;\r\nint idx;\r\nif (tomoyo_init_request_info(&r, NULL, TOMOYO_MAC_FILE_MOUNT)\r\n== TOMOYO_CONFIG_DISABLED)\r\nreturn 0;\r\nif ((flags & MS_MGC_MSK) == MS_MGC_VAL)\r\nflags &= ~MS_MGC_MSK;\r\nif (flags & MS_REMOUNT) {\r\ntype = tomoyo_mounts[TOMOYO_MOUNT_REMOUNT];\r\nflags &= ~MS_REMOUNT;\r\n} else if (flags & MS_BIND) {\r\ntype = tomoyo_mounts[TOMOYO_MOUNT_BIND];\r\nflags &= ~MS_BIND;\r\n} else if (flags & MS_SHARED) {\r\nif (flags & (MS_PRIVATE | MS_SLAVE | MS_UNBINDABLE))\r\nreturn -EINVAL;\r\ntype = tomoyo_mounts[TOMOYO_MOUNT_MAKE_SHARED];\r\nflags &= ~MS_SHARED;\r\n} else if (flags & MS_PRIVATE) {\r\nif (flags & (MS_SHARED | MS_SLAVE | MS_UNBINDABLE))\r\nreturn -EINVAL;\r\ntype = tomoyo_mounts[TOMOYO_MOUNT_MAKE_PRIVATE];\r\nflags &= ~MS_PRIVATE;\r\n} else if (flags & MS_SLAVE) {\r\nif (flags & (MS_SHARED | MS_PRIVATE | MS_UNBINDABLE))\r\nreturn -EINVAL;\r\ntype = tomoyo_mounts[TOMOYO_MOUNT_MAKE_SLAVE];\r\nflags &= ~MS_SLAVE;\r\n} else if (flags & MS_UNBINDABLE) {\r\nif (flags & (MS_SHARED | MS_PRIVATE | MS_SLAVE))\r\nreturn -EINVAL;\r\ntype = tomoyo_mounts[TOMOYO_MOUNT_MAKE_UNBINDABLE];\r\nflags &= ~MS_UNBINDABLE;\r\n} else if (flags & MS_MOVE) {\r\ntype = tomoyo_mounts[TOMOYO_MOUNT_MOVE];\r\nflags &= ~MS_MOVE;\r\n}\r\nif (!type)\r\ntype = "<NULL>";\r\nidx = tomoyo_read_lock();\r\nerror = tomoyo_mount_acl(&r, dev_name, path, type, flags);\r\ntomoyo_read_unlock(idx);\r\nreturn error;\r\n}

static inline struct s5m_irq_data *\r\nirq_to_s5m8767_irq(struct s5m87xx_dev *s5m87xx, int irq)\r\n{\r\nreturn &s5m8767_irqs[irq - s5m87xx->irq_base];\r\n}\r\nstatic void s5m8767_irq_lock(struct irq_data *data)\r\n{\r\nstruct s5m87xx_dev *s5m87xx = irq_data_get_irq_chip_data(data);\r\nmutex_lock(&s5m87xx->irqlock);\r\n}\r\nstatic void s5m8767_irq_sync_unlock(struct irq_data *data)\r\n{\r\nstruct s5m87xx_dev *s5m87xx = irq_data_get_irq_chip_data(data);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(s5m87xx->irq_masks_cur); i++) {\r\nif (s5m87xx->irq_masks_cur[i] != s5m87xx->irq_masks_cache[i]) {\r\ns5m87xx->irq_masks_cache[i] = s5m87xx->irq_masks_cur[i];\r\ns5m_reg_write(s5m87xx, S5M8767_REG_INT1M + i,\r\ns5m87xx->irq_masks_cur[i]);\r\n}\r\n}\r\nmutex_unlock(&s5m87xx->irqlock);\r\n}\r\nstatic void s5m8767_irq_unmask(struct irq_data *data)\r\n{\r\nstruct s5m87xx_dev *s5m87xx = irq_data_get_irq_chip_data(data);\r\nstruct s5m_irq_data *irq_data = irq_to_s5m8767_irq(s5m87xx,\r\ndata->irq);\r\ns5m87xx->irq_masks_cur[irq_data->reg - 1] &= ~irq_data->mask;\r\n}\r\nstatic void s5m8767_irq_mask(struct irq_data *data)\r\n{\r\nstruct s5m87xx_dev *s5m87xx = irq_data_get_irq_chip_data(data);\r\nstruct s5m_irq_data *irq_data = irq_to_s5m8767_irq(s5m87xx,\r\ndata->irq);\r\ns5m87xx->irq_masks_cur[irq_data->reg - 1] |= irq_data->mask;\r\n}\r\nstatic inline struct s5m_irq_data *\r\nirq_to_s5m8763_irq(struct s5m87xx_dev *s5m87xx, int irq)\r\n{\r\nreturn &s5m8763_irqs[irq - s5m87xx->irq_base];\r\n}\r\nstatic void s5m8763_irq_lock(struct irq_data *data)\r\n{\r\nstruct s5m87xx_dev *s5m87xx = irq_data_get_irq_chip_data(data);\r\nmutex_lock(&s5m87xx->irqlock);\r\n}\r\nstatic void s5m8763_irq_sync_unlock(struct irq_data *data)\r\n{\r\nstruct s5m87xx_dev *s5m87xx = irq_data_get_irq_chip_data(data);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(s5m87xx->irq_masks_cur); i++) {\r\nif (s5m87xx->irq_masks_cur[i] != s5m87xx->irq_masks_cache[i]) {\r\ns5m87xx->irq_masks_cache[i] = s5m87xx->irq_masks_cur[i];\r\ns5m_reg_write(s5m87xx, S5M8763_REG_IRQM1 + i,\r\ns5m87xx->irq_masks_cur[i]);\r\n}\r\n}\r\nmutex_unlock(&s5m87xx->irqlock);\r\n}\r\nstatic void s5m8763_irq_unmask(struct irq_data *data)\r\n{\r\nstruct s5m87xx_dev *s5m87xx = irq_data_get_irq_chip_data(data);\r\nstruct s5m_irq_data *irq_data = irq_to_s5m8763_irq(s5m87xx,\r\ndata->irq);\r\ns5m87xx->irq_masks_cur[irq_data->reg - 1] &= ~irq_data->mask;\r\n}\r\nstatic void s5m8763_irq_mask(struct irq_data *data)\r\n{\r\nstruct s5m87xx_dev *s5m87xx = irq_data_get_irq_chip_data(data);\r\nstruct s5m_irq_data *irq_data = irq_to_s5m8763_irq(s5m87xx,\r\ndata->irq);\r\ns5m87xx->irq_masks_cur[irq_data->reg - 1] |= irq_data->mask;\r\n}\r\nstatic irqreturn_t s5m8767_irq_thread(int irq, void *data)\r\n{\r\nstruct s5m87xx_dev *s5m87xx = data;\r\nu8 irq_reg[NUM_IRQ_REGS-1];\r\nint ret;\r\nint i;\r\nret = s5m_bulk_read(s5m87xx, S5M8767_REG_INT1,\r\nNUM_IRQ_REGS - 1, irq_reg);\r\nif (ret < 0) {\r\ndev_err(s5m87xx->dev, "Failed to read interrupt register: %d\n",\r\nret);\r\nreturn IRQ_NONE;\r\n}\r\nfor (i = 0; i < NUM_IRQ_REGS - 1; i++)\r\nirq_reg[i] &= ~s5m87xx->irq_masks_cur[i];\r\nfor (i = 0; i < S5M8767_IRQ_NR; i++) {\r\nif (irq_reg[s5m8767_irqs[i].reg - 1] & s5m8767_irqs[i].mask)\r\nhandle_nested_irq(s5m87xx->irq_base + i);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t s5m8763_irq_thread(int irq, void *data)\r\n{\r\nstruct s5m87xx_dev *s5m87xx = data;\r\nu8 irq_reg[NUM_IRQ_REGS];\r\nint ret;\r\nint i;\r\nret = s5m_bulk_read(s5m87xx, S5M8763_REG_IRQ1,\r\nNUM_IRQ_REGS, irq_reg);\r\nif (ret < 0) {\r\ndev_err(s5m87xx->dev, "Failed to read interrupt register: %d\n",\r\nret);\r\nreturn IRQ_NONE;\r\n}\r\nfor (i = 0; i < NUM_IRQ_REGS; i++)\r\nirq_reg[i] &= ~s5m87xx->irq_masks_cur[i];\r\nfor (i = 0; i < S5M8763_IRQ_NR; i++) {\r\nif (irq_reg[s5m8763_irqs[i].reg - 1] & s5m8763_irqs[i].mask)\r\nhandle_nested_irq(s5m87xx->irq_base + i);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nint s5m_irq_resume(struct s5m87xx_dev *s5m87xx)\r\n{\r\nif (s5m87xx->irq && s5m87xx->irq_base){\r\nswitch (s5m87xx->device_type) {\r\ncase S5M8763X:\r\ns5m8763_irq_thread(s5m87xx->irq_base, s5m87xx);\r\nbreak;\r\ncase S5M8767X:\r\ns5m8767_irq_thread(s5m87xx->irq_base, s5m87xx);\r\nbreak;\r\ndefault:\r\ndev_err(s5m87xx->dev,\r\n"Unknown device type %d\n",\r\ns5m87xx->device_type);\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint s5m_irq_init(struct s5m87xx_dev *s5m87xx)\r\n{\r\nint i;\r\nint cur_irq;\r\nint ret = 0;\r\nint type = s5m87xx->device_type;\r\nif (!s5m87xx->irq) {\r\ndev_warn(s5m87xx->dev,\r\n"No interrupt specified, no interrupts\n");\r\ns5m87xx->irq_base = 0;\r\nreturn 0;\r\n}\r\nif (!s5m87xx->irq_base) {\r\ndev_err(s5m87xx->dev,\r\n"No interrupt base specified, no interrupts\n");\r\nreturn 0;\r\n}\r\nmutex_init(&s5m87xx->irqlock);\r\nswitch (type) {\r\ncase S5M8763X:\r\nfor (i = 0; i < NUM_IRQ_REGS; i++) {\r\ns5m87xx->irq_masks_cur[i] = 0xff;\r\ns5m87xx->irq_masks_cache[i] = 0xff;\r\ns5m_reg_write(s5m87xx, S5M8763_REG_IRQM1 + i,\r\n0xff);\r\n}\r\ns5m_reg_write(s5m87xx, S5M8763_REG_STATUSM1, 0xff);\r\ns5m_reg_write(s5m87xx, S5M8763_REG_STATUSM2, 0xff);\r\nfor (i = 0; i < S5M8763_IRQ_NR; i++) {\r\ncur_irq = i + s5m87xx->irq_base;\r\nirq_set_chip_data(cur_irq, s5m87xx);\r\nirq_set_chip_and_handler(cur_irq, &s5m8763_irq_chip,\r\nhandle_edge_irq);\r\nirq_set_nested_thread(cur_irq, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(cur_irq, IRQF_VALID);\r\n#else\r\nirq_set_noprobe(cur_irq);\r\n#endif\r\n}\r\nret = request_threaded_irq(s5m87xx->irq, NULL,\r\ns5m8763_irq_thread,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\n"s5m87xx-irq", s5m87xx);\r\nif (ret) {\r\ndev_err(s5m87xx->dev, "Failed to request IRQ %d: %d\n",\r\ns5m87xx->irq, ret);\r\nreturn ret;\r\n}\r\nbreak;\r\ncase S5M8767X:\r\nfor (i = 0; i < NUM_IRQ_REGS - 1; i++) {\r\ns5m87xx->irq_masks_cur[i] = 0xff;\r\ns5m87xx->irq_masks_cache[i] = 0xff;\r\ns5m_reg_write(s5m87xx, S5M8767_REG_INT1M + i,\r\n0xff);\r\n}\r\nfor (i = 0; i < S5M8767_IRQ_NR; i++) {\r\ncur_irq = i + s5m87xx->irq_base;\r\nirq_set_chip_data(cur_irq, s5m87xx);\r\nif (ret) {\r\ndev_err(s5m87xx->dev,\r\n"Failed to irq_set_chip_data %d: %d\n",\r\ns5m87xx->irq, ret);\r\nreturn ret;\r\n}\r\nirq_set_chip_and_handler(cur_irq, &s5m8767_irq_chip,\r\nhandle_edge_irq);\r\nirq_set_nested_thread(cur_irq, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(cur_irq, IRQF_VALID);\r\n#else\r\nirq_set_noprobe(cur_irq);\r\n#endif\r\n}\r\nret = request_threaded_irq(s5m87xx->irq, NULL,\r\ns5m8767_irq_thread,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\n"s5m87xx-irq", s5m87xx);\r\nif (ret) {\r\ndev_err(s5m87xx->dev, "Failed to request IRQ %d: %d\n",\r\ns5m87xx->irq, ret);\r\nreturn ret;\r\n}\r\nbreak;\r\ndefault:\r\ndev_err(s5m87xx->dev,\r\n"Unknown device type %d\n", s5m87xx->device_type);\r\nreturn -EINVAL;\r\n}\r\nif (!s5m87xx->ono)\r\nreturn 0;\r\nswitch (type) {\r\ncase S5M8763X:\r\nret = request_threaded_irq(s5m87xx->ono, NULL,\r\ns5m8763_irq_thread,\r\nIRQF_TRIGGER_FALLING |\r\nIRQF_TRIGGER_RISING |\r\nIRQF_ONESHOT, "s5m87xx-ono",\r\ns5m87xx);\r\nbreak;\r\ncase S5M8767X:\r\nret = request_threaded_irq(s5m87xx->ono, NULL,\r\ns5m8767_irq_thread,\r\nIRQF_TRIGGER_FALLING |\r\nIRQF_TRIGGER_RISING |\r\nIRQF_ONESHOT, "s5m87xx-ono", s5m87xx);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nif (ret) {\r\ndev_err(s5m87xx->dev, "Failed to request IRQ %d: %d\n",\r\ns5m87xx->ono, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nvoid s5m_irq_exit(struct s5m87xx_dev *s5m87xx)\r\n{\r\nif (s5m87xx->ono)\r\nfree_irq(s5m87xx->ono, s5m87xx);\r\nif (s5m87xx->irq)\r\nfree_irq(s5m87xx->irq, s5m87xx);\r\n}

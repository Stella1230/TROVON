irqreturn_t t3e3_intr(int irq, void *dev_instance)\r\n{\r\nstruct channel *sc = dev_to_priv(dev_instance);\r\nu32 val;\r\nirqreturn_t ret = IRQ_NONE;\r\nsc->interrupt_active = 1;\r\nval = cpld_read(sc, SBE_2T3E3_CPLD_REG_PICSR);\r\nif (val & SBE_2T3E3_CPLD_VAL_RECEIVE_LOSS_OF_SIGNAL_CHANGE) {\r\ndev_dbg(&sc->pdev->dev,\r\n"Rx LOS Chng Int r=%02x (LOS|OOF=%02x)\n",\r\nval, (sc->s.LOS << 4) | sc->s.OOF);\r\ncpld_LOS_update(sc);\r\nret = IRQ_HANDLED;\r\n}\r\nif (val & SBE_2T3E3_CPLD_VAL_INTERRUPT_FROM_ETHERNET_ASSERTED) {\r\ndc_intr(sc);\r\nret = IRQ_HANDLED;\r\n}\r\nif (val & SBE_2T3E3_CPLD_VAL_INTERRUPT_FROM_FRAMER_ASSERTED) {\r\nexar7250_intr(sc);\r\nret = IRQ_HANDLED;\r\n}\r\nsc->interrupt_active = 0;\r\nreturn ret;\r\n}\r\nvoid dc_intr(struct channel *sc)\r\n{\r\nu32 val;\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_INTERRUPT_ENABLE, 0);\r\nwhile ((val = dc_read(sc->addr, SBE_2T3E3_21143_REG_STATUS)) &\r\n(SBE_2T3E3_21143_VAL_RECEIVE_PROCESS_STOPPED |\r\nSBE_2T3E3_21143_VAL_RECEIVE_BUFFER_UNAVAILABLE |\r\nSBE_2T3E3_21143_VAL_RECEIVE_INTERRUPT |\r\nSBE_2T3E3_21143_VAL_TRANSMIT_UNDERFLOW |\r\nSBE_2T3E3_21143_VAL_TRANSMIT_BUFFER_UNAVAILABLE |\r\nSBE_2T3E3_21143_VAL_TRANSMIT_PROCESS_STOPPED |\r\nSBE_2T3E3_21143_VAL_TRANSMIT_INTERRUPT)) {\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_STATUS, val);\r\ndev_dbg(&sc->pdev->dev, "SBE 2T3E3: Ethernet controller interrupt! (CSR5 = %08X)\n",\r\nval);\r\nif (val & (SBE_2T3E3_21143_VAL_RECEIVE_INTERRUPT |\r\nSBE_2T3E3_21143_VAL_RECEIVE_BUFFER_UNAVAILABLE |\r\nSBE_2T3E3_21143_VAL_RECEIVE_PROCESS_STOPPED)) {\r\nif (val & SBE_2T3E3_21143_VAL_RECEIVE_INTERRUPT)\r\ndev_dbg(&sc->pdev->dev,\r\n"Receive interrupt (LOS=%d, OOF=%d)\n",\r\nsc->s.LOS, sc->s.OOF);\r\nif (val & SBE_2T3E3_21143_VAL_RECEIVE_BUFFER_UNAVAILABLE)\r\ndev_dbg(&sc->pdev->dev,\r\n"Receive buffer unavailable\n");\r\nif (val & SBE_2T3E3_21143_VAL_RECEIVE_PROCESS_STOPPED)\r\ndev_dbg(&sc->pdev->dev,\r\n"Receive process stopped\n");\r\ndc_intr_rx(sc);\r\n}\r\nif (val & SBE_2T3E3_21143_VAL_TRANSMIT_UNDERFLOW) {\r\ndev_dbg(&sc->pdev->dev, "Transmit underflow\n");\r\ndc_intr_tx_underflow(sc);\r\n}\r\nif (val & (SBE_2T3E3_21143_VAL_TRANSMIT_BUFFER_UNAVAILABLE |\r\nSBE_2T3E3_21143_VAL_TRANSMIT_INTERRUPT |\r\nSBE_2T3E3_21143_VAL_TRANSMIT_PROCESS_STOPPED)) {\r\nif (val & SBE_2T3E3_21143_VAL_TRANSMIT_INTERRUPT)\r\ndev_dbg(&sc->pdev->dev, "Transmit interrupt\n");\r\nif (val & SBE_2T3E3_21143_VAL_TRANSMIT_BUFFER_UNAVAILABLE)\r\ndev_dbg(&sc->pdev->dev,\r\n"Transmit buffer unavailable\n");\r\nif (val & SBE_2T3E3_21143_VAL_TRANSMIT_PROCESS_STOPPED)\r\ndev_dbg(&sc->pdev->dev,\r\n"Transmit process stopped\n");\r\ndc_intr_tx(sc);\r\n}\r\n}\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_INTERRUPT_ENABLE,\r\nsc->ether.interrupt_enable_mask);\r\n}\r\nvoid dc_intr_rx(struct channel *sc)\r\n{\r\nu32 current_read;\r\nu32 error_mask, error;\r\nt3e3_rx_desc_t *current_desc;\r\nstruct sk_buff *m, *m2;\r\nunsigned rcv_len;\r\nsc->rcv_count++;\r\ncurrent_read = sc->ether.rx_ring_current_read;\r\ndev_dbg(&sc->pdev->dev, "intr_rx current_read = %d\n", current_read);\r\nif ((sc->p.loopback != SBE_2T3E3_LOOPBACK_ETHERNET) && sc->s.OOF) {\r\nwhile (!(sc->ether.rx_ring[current_read].rdes0 &\r\nSBE_2T3E3_RX_DESC_21143_OWN)) {\r\ncurrent_desc = &sc->ether.rx_ring[current_read];\r\ncurrent_desc->rdes1 &= SBE_2T3E3_RX_DESC_END_OF_RING |\r\nSBE_2T3E3_RX_DESC_SECOND_ADDRESS_CHAINED;\r\ncurrent_desc->rdes1 |= SBE_2T3E3_MTU;\r\ncurrent_desc->rdes0 = SBE_2T3E3_RX_DESC_21143_OWN;\r\ncurrent_read = (current_read + 1) % SBE_2T3E3_RX_DESC_RING_SIZE;\r\n}\r\nsc->ether.rx_ring_current_read = current_read;\r\nreturn;\r\n}\r\nwhile (!(sc->ether.rx_ring[current_read].rdes0 &\r\nSBE_2T3E3_RX_DESC_21143_OWN)) {\r\ncurrent_desc = &sc->ether.rx_ring[current_read];\r\ndev_dbg(&sc->pdev->dev, "rdes0: %08X rdes1: %08X\n",\r\ncurrent_desc->rdes0, current_desc->rdes1);\r\nm = sc->ether.rx_data[current_read];\r\nrcv_len = (current_desc->rdes0 & SBE_2T3E3_RX_DESC_FRAME_LENGTH) >>\r\nSBE_2T3E3_RX_DESC_FRAME_LENGTH_SHIFT;\r\ndev_dbg(&sc->pdev->dev, "mbuf was received (mbuf len = %d)\n",\r\nrcv_len);\r\nswitch (sc->p.crc) {\r\ncase SBE_2T3E3_CRC_16:\r\nrcv_len -= SBE_2T3E3_CRC16_LENGTH;\r\nbreak;\r\ncase SBE_2T3E3_CRC_32:\r\nrcv_len -= SBE_2T3E3_CRC32_LENGTH;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (current_desc->rdes0 & SBE_2T3E3_RX_DESC_LAST_DESC) {\r\nerror_mask = SBE_2T3E3_RX_DESC_DESC_ERROR |\r\nSBE_2T3E3_RX_DESC_COLLISION_SEEN |\r\nSBE_2T3E3_RX_DESC_DRIBBLING_BIT;\r\nswitch (sc->p.frame_mode) {\r\ncase SBE_2T3E3_FRAME_MODE_HDLC:\r\nerror_mask |= SBE_2T3E3_RX_DESC_MII_ERROR;\r\nif (sc->p.crc == SBE_2T3E3_CRC_32)\r\nerror_mask |= SBE_2T3E3_RX_DESC_CRC_ERROR;\r\nbreak;\r\ncase SBE_2T3E3_FRAME_MODE_TRANSPARENT:\r\ncase SBE_2T3E3_FRAME_MODE_RAW:\r\nbreak;\r\ndefault:\r\nerror_mask = 0;\r\n}\r\nif (sc->s.LOS) {\r\nerror_mask &= ~(SBE_2T3E3_RX_DESC_DRIBBLING_BIT |\r\nSBE_2T3E3_RX_DESC_MII_ERROR);\r\n}\r\nerror = current_desc->rdes0 & error_mask;\r\nif (error) {\r\nsc->s.in_errors++;\r\ndev_dbg(&sc->pdev->dev,\r\n"error interrupt: NO_ERROR_MESSAGE = %d\n",\r\nsc->r.flags & SBE_2T3E3_FLAG_NO_ERROR_MESSAGES ? 1 : 0);\r\ncurrent_desc->rdes1 &= SBE_2T3E3_RX_DESC_END_OF_RING |\r\nSBE_2T3E3_RX_DESC_SECOND_ADDRESS_CHAINED;\r\ncurrent_desc->rdes1 |= SBE_2T3E3_MTU;\r\ncurrent_desc->rdes0 = SBE_2T3E3_RX_DESC_21143_OWN;\r\nif (error & SBE_2T3E3_RX_DESC_DESC_ERROR) {\r\nif (!(sc->r.flags & SBE_2T3E3_FLAG_NO_ERROR_MESSAGES))\r\ndev_err(&sc->pdev->dev,\r\n"SBE 2T3E3: descriptor error\n");\r\nsc->s.in_error_desc++;\r\n}\r\nif (error & SBE_2T3E3_RX_DESC_COLLISION_SEEN) {\r\nif (!(sc->r.flags & SBE_2T3E3_FLAG_NO_ERROR_MESSAGES))\r\ndev_err(&sc->pdev->dev,\r\n"SBE 2T3E3: collision seen\n");\r\nsc->s.in_error_coll++;\r\n} else {\r\nif (error & SBE_2T3E3_RX_DESC_DRIBBLING_BIT) {\r\nif (!(sc->r.flags & SBE_2T3E3_FLAG_NO_ERROR_MESSAGES))\r\ndev_err(&sc->pdev->dev,\r\n"SBE 2T3E3: dribbling bits error\n");\r\nsc->s.in_error_drib++;\r\n}\r\nif (error & SBE_2T3E3_RX_DESC_CRC_ERROR) {\r\nif (!(sc->r.flags & SBE_2T3E3_FLAG_NO_ERROR_MESSAGES))\r\ndev_err(&sc->pdev->dev,\r\n"SBE 2T3E3: crc error\n");\r\nsc->s.in_error_crc++;\r\n}\r\n}\r\nif (error & SBE_2T3E3_RX_DESC_MII_ERROR) {\r\nif (!(sc->r.flags & SBE_2T3E3_FLAG_NO_ERROR_MESSAGES))\r\ndev_err(&sc->pdev->dev, "SBE 2T3E3: mii error\n");\r\nsc->s.in_error_mii++;\r\n}\r\ncurrent_read = (current_read + 1) % SBE_2T3E3_RX_DESC_RING_SIZE;\r\nsc->r.flags |= SBE_2T3E3_FLAG_NO_ERROR_MESSAGES;\r\ncontinue;\r\n}\r\n}\r\ncurrent_desc->rdes1 &= SBE_2T3E3_RX_DESC_END_OF_RING |\r\nSBE_2T3E3_RX_DESC_SECOND_ADDRESS_CHAINED;\r\ncurrent_desc->rdes1 |= SBE_2T3E3_MTU;\r\nif (rcv_len > 1600) {\r\nsc->s.in_errors++;\r\nsc->s.in_dropped++;\r\nif (!(sc->r.flags & SBE_2T3E3_FLAG_NO_ERROR_MESSAGES))\r\ndev_err(&sc->pdev->dev, "SBE 2T3E3: oversized rx: rdes0 = %08X\n",\r\ncurrent_desc->rdes0);\r\n} else {\r\nm2 = dev_alloc_skb(MCLBYTES);\r\nif (m2 != NULL) {\r\ncurrent_desc->rdes2 = virt_to_phys(m2->data);\r\nsc->ether.rx_data[current_read] = m2;\r\nsc->s.in_packets++;\r\nsc->s.in_bytes += rcv_len;\r\nm->dev = sc->dev;\r\nskb_put(m, rcv_len);\r\nskb_reset_mac_header(m);\r\nm->protocol = hdlc_type_trans(m, m->dev);\r\nnetif_rx(m);\r\nif (sc->r.flags & SBE_2T3E3_FLAG_NO_ERROR_MESSAGES) {\r\ndev_dbg(&sc->pdev->dev,\r\n"setting ERROR_MESSAGES->0\n");\r\nsc->r.flags &= ~SBE_2T3E3_FLAG_NO_ERROR_MESSAGES;\r\n}\r\n} else {\r\nsc->s.in_errors++;\r\nsc->s.in_dropped++;\r\n}\r\n}\r\ncurrent_desc->rdes0 = SBE_2T3E3_RX_DESC_21143_OWN;\r\ncurrent_read = (current_read + 1) % SBE_2T3E3_RX_DESC_RING_SIZE;\r\n}\r\nsc->ether.rx_ring_current_read = current_read;\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_RECEIVE_POLL_DEMAND, 0xFFFFFFFF);\r\n}\r\nvoid dc_intr_tx(struct channel *sc)\r\n{\r\nu32 current_read, current_write;\r\nu32 last_segment, error;\r\nt3e3_tx_desc_t *current_desc;\r\nspin_lock(&sc->ether.tx_lock);\r\ncurrent_read = sc->ether.tx_ring_current_read;\r\ncurrent_write = sc->ether.tx_ring_current_write;\r\nwhile (current_read != current_write) {\r\ncurrent_desc = &sc->ether.tx_ring[current_read];\r\nif (current_desc->tdes0 & SBE_2T3E3_RX_DESC_21143_OWN)\r\nbreak;\r\ndev_dbg(&sc->pdev->dev,\r\n"txeof: tdes0 = %08X tdes1 = %08X\n",\r\ncurrent_desc->tdes0, current_desc->tdes1);\r\nerror = current_desc->tdes0 & (SBE_2T3E3_TX_DESC_ERROR_SUMMARY |\r\nSBE_2T3E3_TX_DESC_TRANSMIT_JABBER_TIMEOUT |\r\nSBE_2T3E3_TX_DESC_LOSS_OF_CARRIER |\r\nSBE_2T3E3_TX_DESC_NO_CARRIER |\r\nSBE_2T3E3_TX_DESC_LINK_FAIL_REPORT |\r\nSBE_2T3E3_TX_DESC_UNDERFLOW_ERROR |\r\nSBE_2T3E3_TX_DESC_DEFFERED);\r\nlast_segment = current_desc->tdes1 & SBE_2T3E3_TX_DESC_LAST_SEGMENT;\r\ncurrent_desc->tdes0 = 0;\r\ncurrent_desc->tdes1 &= SBE_2T3E3_TX_DESC_END_OF_RING |\r\nSBE_2T3E3_TX_DESC_SECOND_ADDRESS_CHAINED;\r\ncurrent_desc->tdes2 = 0;\r\nsc->ether.tx_free_cnt++;\r\nif (last_segment != SBE_2T3E3_TX_DESC_LAST_SEGMENT) {\r\ncurrent_read = (current_read + 1) % SBE_2T3E3_TX_DESC_RING_SIZE;\r\ncontinue;\r\n}\r\nif (sc->ether.tx_data[current_read]) {\r\nsc->s.out_packets++;\r\nsc->s.out_bytes += sc->ether.tx_data[current_read]->len;\r\ndev_kfree_skb_any(sc->ether.tx_data[current_read]);\r\nsc->ether.tx_data[current_read] = NULL;\r\n}\r\nif (error > 0) {\r\nsc->s.out_errors++;\r\nif (error & SBE_2T3E3_TX_DESC_TRANSMIT_JABBER_TIMEOUT) {\r\ndev_err(&sc->pdev->dev, "SBE 2T3E3: transmit jabber timeout\n");\r\nsc->s.out_error_jab++;\r\n}\r\nif (sc->p.loopback != SBE_2T3E3_LOOPBACK_ETHERNET) {\r\nif (error & SBE_2T3E3_TX_DESC_LOSS_OF_CARRIER) {\r\ndev_err(&sc->pdev->dev, "SBE 2T3E3: loss of carrier\n");\r\nsc->s.out_error_lost_carr++;\r\n}\r\nif (error & SBE_2T3E3_TX_DESC_NO_CARRIER) {\r\ndev_err(&sc->pdev->dev, "SBE 2T3E3: no carrier\n");\r\nsc->s.out_error_no_carr++;\r\n}\r\n}\r\nif (error & SBE_2T3E3_TX_DESC_LINK_FAIL_REPORT) {\r\ndev_err(&sc->pdev->dev, "SBE 2T3E3: link fail report\n");\r\nsc->s.out_error_link_fail++;\r\n}\r\nif (error & SBE_2T3E3_TX_DESC_UNDERFLOW_ERROR) {\r\ndev_err(&sc->pdev->dev, "SBE 2T3E3:"\r\n" transmission underflow error\n");\r\nsc->s.out_error_underflow++;\r\nspin_unlock(&sc->ether.tx_lock);\r\ndc_restart(sc);\r\nreturn;\r\n}\r\nif (error & SBE_2T3E3_TX_DESC_DEFFERED) {\r\ndev_err(&sc->pdev->dev, "SBE 2T3E3: transmission deferred\n");\r\nsc->s.out_error_dereferred++;\r\n}\r\n}\r\ncurrent_read = (current_read + 1) % SBE_2T3E3_TX_DESC_RING_SIZE;\r\n}\r\nsc->ether.tx_ring_current_read = current_read;\r\nif (sc->ether.tx_full &&\r\n(sc->ether.tx_free_cnt >= (SBE_2T3E3_TX_DESC_RING_SIZE / 2))) {\r\nsc->ether.tx_full = 0;\r\nnetif_wake_queue(sc->dev);\r\n}\r\nspin_unlock(&sc->ether.tx_lock);\r\n}\r\nvoid dc_intr_tx_underflow(struct channel *sc)\r\n{\r\nu32 val;\r\ndc_transmitter_onoff(sc, SBE_2T3E3_OFF);\r\nval = dc_read(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE);\r\ndc_clear_bits(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE,\r\nSBE_2T3E3_21143_VAL_THRESHOLD_CONTROL_BITS);\r\nswitch (val & SBE_2T3E3_21143_VAL_THRESHOLD_CONTROL_BITS) {\r\ncase SBE_2T3E3_21143_VAL_THRESHOLD_CONTROL_BITS_1:\r\ndc_set_bits(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE,\r\nSBE_2T3E3_21143_VAL_THRESHOLD_CONTROL_BITS_2);\r\nbreak;\r\ncase SBE_2T3E3_21143_VAL_THRESHOLD_CONTROL_BITS_2:\r\ndc_set_bits(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE,\r\nSBE_2T3E3_21143_VAL_THRESHOLD_CONTROL_BITS_3);\r\nbreak;\r\ncase SBE_2T3E3_21143_VAL_THRESHOLD_CONTROL_BITS_3:\r\ndc_set_bits(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE,\r\nSBE_2T3E3_21143_VAL_THRESHOLD_CONTROL_BITS_4);\r\nbreak;\r\ncase SBE_2T3E3_21143_VAL_THRESHOLD_CONTROL_BITS_4:\r\ndefault:\r\ndc_set_bits(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE,\r\nSBE_2T3E3_21143_VAL_STORE_AND_FORWARD);\r\nbreak;\r\n}\r\ndc_transmitter_onoff(sc, SBE_2T3E3_ON);\r\n}\r\nvoid exar7250_intr(struct channel *sc)\r\n{\r\nu32 status, old_OOF;\r\n#if 0\r\nexar7250_write(sc, SBE_2T3E3_FRAMER_REG_BLOCK_INTERRUPT_ENABLE, 0);\r\n#endif\r\nold_OOF = sc->s.OOF;\r\nstatus = exar7250_read(sc, SBE_2T3E3_FRAMER_REG_BLOCK_INTERRUPT_STATUS);\r\ndev_dbg(&sc->pdev->dev, "SBE 2T3E3: Framer interrupt! (REG[0x05] = %02X)\n", status);\r\nswitch (sc->p.frame_type) {\r\ncase SBE_2T3E3_FRAME_TYPE_E3_G751:\r\ncase SBE_2T3E3_FRAME_TYPE_E3_G832:\r\nexar7250_E3_intr(sc, status);\r\nbreak;\r\ncase SBE_2T3E3_FRAME_TYPE_T3_CBIT:\r\ncase SBE_2T3E3_FRAME_TYPE_T3_M13:\r\nexar7250_T3_intr(sc, status);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (sc->s.OOF != old_OOF) {\r\nif (sc->s.OOF) {\r\nif (sc->p.loopback == SBE_2T3E3_LOOPBACK_NONE) {\r\ndev_dbg(&sc->pdev->dev, "SBE 2T3E3: Disabling eth interrupts\n");\r\ndc_stop_intr(sc);\r\n}\r\n} else if (sc->r.flags & SBE_2T3E3_FLAG_NETWORK_UP) {\r\ndev_dbg(&sc->pdev->dev, "SBE 2T3E3: Enabling eth interrupts\n");\r\nsc->s.OOF = 1;\r\ndc_intr_rx(sc);\r\nsc->s.OOF = 0;\r\nif (sc->p.receiver_on) {\r\ndc_receiver_onoff(sc, SBE_2T3E3_OFF);\r\ndc_receiver_onoff(sc, SBE_2T3E3_ON);\r\n}\r\ndc_start_intr(sc);\r\n}\r\n}\r\n#if 0\r\nexar7250_write(sc, SBE_2T3E3_FRAMER_REG_BLOCK_INTERRUPT_ENABLE,\r\nSBE_2T3E3_FRAMER_VAL_RX_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_TX_INTERRUPT_ENABLE\r\n);\r\n#endif\r\n}\r\nvoid exar7250_T3_intr(struct channel *sc, u32 block_status)\r\n{\r\nu32 status, result;\r\nif (block_status & SBE_2T3E3_FRAMER_VAL_RX_INTERRUPT_STATUS) {\r\nstatus = exar7250_read(sc, SBE_2T3E3_FRAMER_REG_T3_RX_INTERRUPT_STATUS);\r\nif (status) {\r\ndev_dbg(&sc->pdev->dev,\r\n"Framer interrupt T3 RX (REG[0x13] = %02X)\n",\r\nstatus);\r\nresult = exar7250_read(sc, SBE_2T3E3_FRAMER_REG_T3_RX_CONFIGURATION_STATUS);\r\n#if 0\r\nif (status & SBE_2T3E3_FRAMER_VAL_T3_RX_LOS_INTERRUPT_STATUS) {\r\ndev_dbg(&sc->pdev->dev,\r\n"Framer interrupt T3: LOS\n");\r\nsc->s.LOS = result & SBE_2T3E3_FRAMER_VAL_T3_RX_LOS ? 1 : 0;\r\n}\r\n#else\r\ncpld_LOS_update(sc);\r\n#endif\r\nif (status & SBE_2T3E3_FRAMER_VAL_T3_RX_OOF_INTERRUPT_STATUS) {\r\nsc->s.OOF = result & SBE_2T3E3_FRAMER_VAL_T3_RX_OOF ? 1 : 0;\r\ndev_dbg(&sc->pdev->dev,\r\n"Framer interrupt T3: OOF (%d)\n",\r\nsc->s.OOF);\r\n}\r\nexar7250_write(sc, SBE_2T3E3_FRAMER_REG_T3_RX_INTERRUPT_ENABLE,\r\nSBE_2T3E3_FRAMER_VAL_T3_RX_LOS_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_T3_RX_OOF_INTERRUPT_ENABLE);\r\n#if 0\r\nSBE_2T3E3_FRAMER_VAL_T3_RX_CP_BIT_ERROR_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_T3_RX_LOS_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_T3_RX_AIS_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_T3_RX_IDLE_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_T3_RX_FERF_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_T3_RX_AIC_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_T3_RX_OOF_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_T3_RX_P_BIT_INTERRUPT_ENABLE\r\n#endif\r\n}\r\nstatus = exar7250_read(sc, SBE_2T3E3_FRAMER_REG_T3_RX_FEAC_INTERRUPT_ENABLE_STATUS);\r\nif (status) {\r\ndev_dbg(&sc->pdev->dev,\r\n"Framer interrupt T3 RX (REG[0x17] = %02X)\n",\r\nstatus);\r\n#if 0\r\nexar7250_write(sc, SBE_2T3E3_FRAMER_REG_T3_RX_FEAC_INTERRUPT_ENABLE_STATUS,\r\nSBE_2T3E3_FRAMER_VAL_T3_RX_FEAC_REMOVE_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_T3_RX_FEAC_VALID_INTERRUPT_ENABLE\r\n);\r\n#endif\r\n}\r\nstatus = exar7250_read(sc, SBE_2T3E3_FRAMER_REG_T3_RX_LAPD_CONTROL);\r\nif (status)\r\ndev_dbg(&sc->pdev->dev,\r\n"Framer interrupt T3 RX (REG[0x18] = %02X)\n",\r\nstatus);\r\n}\r\nif (block_status & SBE_2T3E3_FRAMER_VAL_TX_INTERRUPT_STATUS) {\r\nstatus = exar7250_read(sc, SBE_2T3E3_FRAMER_REG_T3_TX_FEAC_CONFIGURATION_STATUS);\r\ndev_dbg(&sc->pdev->dev, "SBE 2T3E3: Framer interrupt T3 TX (REG[0x31] = %02X)\n",\r\nstatus);\r\nstatus = exar7250_read(sc, SBE_2T3E3_FRAMER_REG_T3_TX_LAPD_STATUS);\r\ndev_dbg(&sc->pdev->dev, "SBE 2T3E3: Framer interrupt T3 TX (REG[0x34] = %02X)\n",\r\nstatus);\r\n}\r\n}\r\nvoid exar7250_E3_intr(struct channel *sc, u32 block_status)\r\n{\r\nu32 status, result;\r\nif (block_status & SBE_2T3E3_FRAMER_VAL_RX_INTERRUPT_STATUS) {\r\nstatus = exar7250_read(sc, SBE_2T3E3_FRAMER_REG_E3_RX_INTERRUPT_STATUS_1);\r\nif (status) {\r\ndev_dbg(&sc->pdev->dev,\r\n"Framer interrupt E3 RX (REG[0x14] = %02X)\n",\r\nstatus);\r\nresult = exar7250_read(sc, SBE_2T3E3_FRAMER_REG_E3_RX_CONFIGURATION_STATUS_2);\r\n#if 0\r\nif (status & SBE_2T3E3_FRAMER_VAL_E3_RX_LOS_INTERRUPT_STATUS) {\r\ndev_dbg(&sc->pdev->dev,\r\n"Framer interrupt E3: LOS\n");\r\nsc->s.LOS = result & SBE_2T3E3_FRAMER_VAL_E3_RX_LOS ? 1 : 0;\r\n}\r\n#else\r\ncpld_LOS_update(sc);\r\n#endif\r\nif (status & SBE_2T3E3_FRAMER_VAL_E3_RX_OOF_INTERRUPT_STATUS) {\r\nsc->s.OOF = result & SBE_2T3E3_FRAMER_VAL_E3_RX_OOF ? 1 : 0;\r\ndev_dbg(&sc->pdev->dev,\r\n"Framer interrupt E3: OOF (%d)\n",\r\nsc->s.OOF);\r\n}\r\nexar7250_write(sc, SBE_2T3E3_FRAMER_REG_E3_RX_INTERRUPT_ENABLE_1,\r\nSBE_2T3E3_FRAMER_VAL_E3_RX_OOF_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_E3_RX_LOS_INTERRUPT_ENABLE\r\n);\r\n#if 0\r\nSBE_2T3E3_FRAMER_VAL_E3_RX_COFA_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_E3_RX_OOF_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_E3_RX_LOF_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_E3_RX_LOS_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_E3_RX_AIS_INTERRUPT_ENABLE\r\n#endif\r\n}\r\nstatus = exar7250_read(sc, SBE_2T3E3_FRAMER_REG_E3_RX_INTERRUPT_STATUS_2);\r\nif (status) {\r\ndev_dbg(&sc->pdev->dev,\r\n"Framer interrupt E3 RX (REG[0x15] = %02X)\n",\r\nstatus);\r\n#if 0\r\nexar7250_write(sc, SBE_2T3E3_FRAMER_REG_E3_RX_INTERRUPT_ENABLE_2,\r\nSBE_2T3E3_FRAMER_VAL_E3_RX_FEBE_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_E3_RX_FERF_INTERRUPT_ENABLE |\r\nSBE_2T3E3_FRAMER_VAL_E3_RX_FRAMING_BYTE_ERROR_INTERRUPT_ENABLE);\r\n#endif\r\n}\r\n}\r\nif (block_status & SBE_2T3E3_FRAMER_VAL_TX_INTERRUPT_STATUS) {\r\nstatus = exar7250_read(sc, SBE_2T3E3_FRAMER_REG_E3_TX_LAPD_STATUS);\r\ndev_dbg(&sc->pdev->dev, "SBE 2T3E3: Framer interrupt E3 TX (REG[0x34] = %02X)\n",\r\nstatus);\r\n}\r\n}

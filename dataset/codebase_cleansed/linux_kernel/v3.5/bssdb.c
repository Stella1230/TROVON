PKnownBSS\r\nBSSpSearchBSSList(\r\nvoid *hDeviceContext,\r\nunsigned char *pbyDesireBSSID,\r\nunsigned char *pbyDesireSSID,\r\nCARD_PHY_TYPE ePhyType\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nunsigned char *pbyBSSID = NULL;\r\nPWLAN_IE_SSID pSSID = NULL;\r\nPKnownBSS pCurrBSS = NULL;\r\nPKnownBSS pSelect = NULL;\r\nunsigned char ZeroBSSID[WLAN_BSSID_LEN]={0x00,0x00,0x00,0x00,0x00,0x00};\r\nunsigned int ii = 0;\r\nif (pbyDesireBSSID != NULL) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"BSSpSearchBSSList BSSID[%02X %02X %02X-%02X %02X %02X]\n",\r\n*pbyDesireBSSID,*(pbyDesireBSSID+1),*(pbyDesireBSSID+2),\r\n*(pbyDesireBSSID+3),*(pbyDesireBSSID+4),*(pbyDesireBSSID+5));\r\nif ((!is_broadcast_ether_addr(pbyDesireBSSID)) &&\r\n(memcmp(pbyDesireBSSID, ZeroBSSID, 6)!= 0)){\r\npbyBSSID = pbyDesireBSSID;\r\n}\r\n}\r\nif (pbyDesireSSID != NULL) {\r\nif (((PWLAN_IE_SSID)pbyDesireSSID)->len != 0) {\r\npSSID = (PWLAN_IE_SSID) pbyDesireSSID;\r\n}\r\n}\r\nif (pbyBSSID != NULL) {\r\nfor (ii = 0; ii <MAX_BSS_NUM; ii++) {\r\npCurrBSS = &(pMgmt->sBSSList[ii]);\r\nif(pDevice->bLinkPass==false) pCurrBSS->bSelected = false;\r\nif ((pCurrBSS->bActive) &&\r\n(pCurrBSS->bSelected == false)) {\r\nif (!compare_ether_addr(pCurrBSS->abyBSSID, pbyBSSID)) {\r\nif (pSSID != NULL) {\r\nif ( !memcmp(pSSID->abySSID,\r\n((PWLAN_IE_SSID)pCurrBSS->abySSID)->abySSID,\r\npSSID->len)) {\r\nif ((pMgmt->eConfigMode == WMAC_CONFIG_AUTO) ||\r\n((pMgmt->eConfigMode == WMAC_CONFIG_IBSS_STA) && WLAN_GET_CAP_INFO_IBSS(pCurrBSS->wCapInfo)) ||\r\n((pMgmt->eConfigMode == WMAC_CONFIG_ESS_STA) && WLAN_GET_CAP_INFO_ESS(pCurrBSS->wCapInfo))\r\n) {\r\npCurrBSS->bSelected = true;\r\nreturn(pCurrBSS);\r\n}\r\n}\r\n} else {\r\nif ((pMgmt->eConfigMode == WMAC_CONFIG_AUTO) ||\r\n((pMgmt->eConfigMode == WMAC_CONFIG_IBSS_STA) && WLAN_GET_CAP_INFO_IBSS(pCurrBSS->wCapInfo)) ||\r\n((pMgmt->eConfigMode == WMAC_CONFIG_ESS_STA) && WLAN_GET_CAP_INFO_ESS(pCurrBSS->wCapInfo))\r\n) {\r\npCurrBSS->bSelected = true;\r\nreturn(pCurrBSS);\r\n}\r\n}\r\n}\r\n}\r\n}\r\n} else {\r\nfor (ii = 0; ii <MAX_BSS_NUM; ii++) {\r\npCurrBSS = &(pMgmt->sBSSList[ii]);\r\npCurrBSS->bSelected = false;\r\nif (pCurrBSS->bActive) {\r\nif (pSSID != NULL) {\r\nif (! !memcmp(pSSID->abySSID,\r\n((PWLAN_IE_SSID)pCurrBSS->abySSID)->abySSID,\r\npSSID->len) ||\r\n(pSSID->len != ((PWLAN_IE_SSID)pCurrBSS->abySSID)->len)) {\r\ncontinue;\r\n}\r\n}\r\nif (((pMgmt->eConfigMode == WMAC_CONFIG_IBSS_STA) && WLAN_GET_CAP_INFO_ESS(pCurrBSS->wCapInfo)) ||\r\n((pMgmt->eConfigMode == WMAC_CONFIG_ESS_STA) && WLAN_GET_CAP_INFO_IBSS(pCurrBSS->wCapInfo))\r\n){\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"BSS type mismatch.... Config[%d] BSS[0x%04x]\n", pMgmt->eConfigMode, pCurrBSS->wCapInfo);\r\ncontinue;\r\n}\r\nif (ePhyType != PHY_TYPE_AUTO) {\r\nif (((ePhyType == PHY_TYPE_11A) && (PHY_TYPE_11A != pCurrBSS->eNetworkTypeInUse)) ||\r\n((ePhyType != PHY_TYPE_11A) && (PHY_TYPE_11A == pCurrBSS->eNetworkTypeInUse))) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"Physical type mismatch.... ePhyType[%d] BSS[%d]\n", ePhyType, pCurrBSS->eNetworkTypeInUse);\r\ncontinue;\r\n}\r\n}\r\nif (pSelect == NULL) {\r\npSelect = pCurrBSS;\r\n} else {\r\nif (pCurrBSS->uRSSI < pSelect->uRSSI) {\r\npSelect = pCurrBSS;\r\n}\r\n}\r\n}\r\n}\r\nif (pSelect != NULL) {\r\npSelect->bSelected = true;\r\nreturn(pSelect);\r\n}\r\n}\r\nreturn(NULL);\r\n}\r\nvoid\r\nBSSvClearBSSList(\r\nvoid *hDeviceContext,\r\nbool bKeepCurrBSSID\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nunsigned int ii;\r\nfor (ii = 0; ii < MAX_BSS_NUM; ii++) {\r\nif (bKeepCurrBSSID) {\r\nif (pMgmt->sBSSList[ii].bActive &&\r\n!compare_ether_addr(pMgmt->sBSSList[ii].abyBSSID, pMgmt->abyCurrBSSID)) {\r\ncontinue;\r\n}\r\n}\r\nif ((pMgmt->sBSSList[ii].bActive) && (pMgmt->sBSSList[ii].uClearCount < BSS_CLEAR_COUNT)) {\r\npMgmt->sBSSList[ii].uClearCount ++;\r\ncontinue;\r\n}\r\npMgmt->sBSSList[ii].bActive = false;\r\nmemset(&pMgmt->sBSSList[ii], 0, sizeof(KnownBSS));\r\n}\r\nBSSvClearAnyBSSJoinRecord(pDevice);\r\nreturn;\r\n}\r\nPKnownBSS\r\nBSSpAddrIsInBSSList(\r\nvoid *hDeviceContext,\r\nunsigned char *abyBSSID,\r\nPWLAN_IE_SSID pSSID\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nPKnownBSS pBSSList = NULL;\r\nunsigned int ii;\r\nfor (ii = 0; ii < MAX_BSS_NUM; ii++) {\r\npBSSList = &(pMgmt->sBSSList[ii]);\r\nif (pBSSList->bActive) {\r\nif (!compare_ether_addr(pBSSList->abyBSSID, abyBSSID)) {\r\nif (pSSID->len == ((PWLAN_IE_SSID)pBSSList->abySSID)->len){\r\nif (memcmp(pSSID->abySSID,\r\n((PWLAN_IE_SSID)pBSSList->abySSID)->abySSID,\r\npSSID->len) == 0)\r\nreturn pBSSList;\r\n}\r\n}\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nbool\r\nBSSbInsertToBSSList (\r\nvoid *hDeviceContext,\r\nunsigned char *abyBSSIDAddr,\r\nQWORD qwTimestamp,\r\nunsigned short wBeaconInterval,\r\nunsigned short wCapInfo,\r\nunsigned char byCurrChannel,\r\nPWLAN_IE_SSID pSSID,\r\nPWLAN_IE_SUPP_RATES pSuppRates,\r\nPWLAN_IE_SUPP_RATES pExtSuppRates,\r\nPERPObject psERP,\r\nPWLAN_IE_RSN pRSN,\r\nPWLAN_IE_RSN_EXT pRSNWPA,\r\nPWLAN_IE_COUNTRY pIE_Country,\r\nPWLAN_IE_QUIET pIE_Quiet,\r\nunsigned int uIELength,\r\nunsigned char *pbyIEs,\r\nvoid *pRxPacketContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nPSRxMgmtPacket pRxPacket = (PSRxMgmtPacket)pRxPacketContext;\r\nPKnownBSS pBSSList = NULL;\r\nunsigned int ii;\r\nbool bParsingQuiet = false;\r\nPWLAN_IE_QUIET pQuiet = NULL;\r\npBSSList = (PKnownBSS)&(pMgmt->sBSSList[0]);\r\nfor (ii = 0; ii < MAX_BSS_NUM; ii++) {\r\npBSSList = (PKnownBSS)&(pMgmt->sBSSList[ii]);\r\nif (!pBSSList->bActive)\r\nbreak;\r\n}\r\nif (ii == MAX_BSS_NUM){\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Get free KnowBSS node failed.\n");\r\nreturn false;\r\n}\r\npBSSList->bActive = true;\r\nmemcpy( pBSSList->abyBSSID, abyBSSIDAddr, WLAN_BSSID_LEN);\r\nHIDWORD(pBSSList->qwBSSTimestamp) = cpu_to_le32(HIDWORD(qwTimestamp));\r\nLODWORD(pBSSList->qwBSSTimestamp) = cpu_to_le32(LODWORD(qwTimestamp));\r\npBSSList->wBeaconInterval = cpu_to_le16(wBeaconInterval);\r\npBSSList->wCapInfo = cpu_to_le16(wCapInfo);\r\npBSSList->uClearCount = 0;\r\nif (pSSID->len > WLAN_SSID_MAXLEN)\r\npSSID->len = WLAN_SSID_MAXLEN;\r\nmemcpy( pBSSList->abySSID, pSSID, pSSID->len + WLAN_IEHDR_LEN);\r\npBSSList->uChannel = byCurrChannel;\r\nif (pSuppRates->len > WLAN_RATES_MAXLEN)\r\npSuppRates->len = WLAN_RATES_MAXLEN;\r\nmemcpy( pBSSList->abySuppRates, pSuppRates, pSuppRates->len + WLAN_IEHDR_LEN);\r\nif (pExtSuppRates != NULL) {\r\nif (pExtSuppRates->len > WLAN_RATES_MAXLEN)\r\npExtSuppRates->len = WLAN_RATES_MAXLEN;\r\nmemcpy(pBSSList->abyExtSuppRates, pExtSuppRates, pExtSuppRates->len + WLAN_IEHDR_LEN);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"BSSbInsertToBSSList: pExtSuppRates->len = %d\n", pExtSuppRates->len);\r\n} else {\r\nmemset(pBSSList->abyExtSuppRates, 0, WLAN_IEHDR_LEN + WLAN_RATES_MAXLEN + 1);\r\n}\r\npBSSList->sERP.byERP = psERP->byERP;\r\npBSSList->sERP.bERPExist = psERP->bERPExist;\r\nif (pBSSList->uChannel > CB_MAX_CHANNEL_24G) {\r\npBSSList->eNetworkTypeInUse = PHY_TYPE_11A;\r\n} else {\r\nif (pBSSList->sERP.bERPExist == true) {\r\npBSSList->eNetworkTypeInUse = PHY_TYPE_11G;\r\n} else {\r\npBSSList->eNetworkTypeInUse = PHY_TYPE_11B;\r\n}\r\n}\r\npBSSList->byRxRate = pRxPacket->byRxRate;\r\npBSSList->qwLocalTSF = pRxPacket->qwLocalTSF;\r\npBSSList->uRSSI = pRxPacket->uRSSI;\r\npBSSList->bySQ = pRxPacket->bySQ;\r\nif ((pMgmt->eCurrMode == WMAC_MODE_ESS_STA) &&\r\n(pMgmt->eCurrState == WMAC_STATE_ASSOC)) {\r\nif (pBSSList == pMgmt->pCurrBSS) {\r\nbParsingQuiet = true;\r\n}\r\n}\r\nWPA_ClearRSN(pBSSList);\r\nif (pRSNWPA != NULL) {\r\nunsigned int uLen = pRSNWPA->len + 2;\r\nif (uLen <= (uIELength - (unsigned int)((unsigned char *)pRSNWPA - pbyIEs))) {\r\npBSSList->wWPALen = uLen;\r\nmemcpy(pBSSList->byWPAIE, pRSNWPA, uLen);\r\nWPA_ParseRSN(pBSSList, pRSNWPA);\r\n}\r\n}\r\nWPA2_ClearRSN(pBSSList);\r\nif (pRSN != NULL) {\r\nunsigned int uLen = pRSN->len + 2;\r\nif (uLen <= (uIELength - (unsigned int)((unsigned char *)pRSN - pbyIEs))) {\r\npBSSList->wRSNLen = uLen;\r\nmemcpy(pBSSList->byRSNIE, pRSN, uLen);\r\nWPA2vParseRSN(pBSSList, pRSN);\r\n}\r\n}\r\nif ((pMgmt->eAuthenMode == WMAC_AUTH_WPA2) || (pBSSList->bWPA2Valid == true)) {\r\nPSKeyItem pTransmitKey = NULL;\r\nbool bIs802_1x = false;\r\nfor (ii = 0; ii < pBSSList->wAKMSSAuthCount; ii ++) {\r\nif (pBSSList->abyAKMSSAuthType[ii] == WLAN_11i_AKMSS_802_1X) {\r\nbIs802_1x = true;\r\nbreak;\r\n}\r\n}\r\nif ((bIs802_1x == true) && (pSSID->len == ((PWLAN_IE_SSID)pMgmt->abyDesireSSID)->len) &&\r\n( !memcmp(pSSID->abySSID, ((PWLAN_IE_SSID)pMgmt->abyDesireSSID)->abySSID, pSSID->len))) {\r\nbAdd_PMKID_Candidate((void *)pDevice, pBSSList->abyBSSID, &pBSSList->sRSNCapObj);\r\nif ((pDevice->bLinkPass == true) && (pMgmt->eCurrState == WMAC_STATE_ASSOC)) {\r\nif ((KeybGetTransmitKey(&(pDevice->sKey), pDevice->abyBSSID, PAIRWISE_KEY, &pTransmitKey) == true) ||\r\n(KeybGetTransmitKey(&(pDevice->sKey), pDevice->abyBSSID, GROUP_KEY, &pTransmitKey) == true)) {\r\npDevice->gsPMKIDCandidate.StatusType = Ndis802_11StatusType_PMKID_CandidateList;\r\npDevice->gsPMKIDCandidate.Version = 1;\r\n}\r\n}\r\n}\r\n}\r\nif (pDevice->bUpdateBBVGA) {\r\npBSSList->byRSSIStatCnt = 0;\r\nRFvRSSITodBm(pDevice, (unsigned char)(pRxPacket->uRSSI), &pBSSList->ldBmMAX);\r\npBSSList->ldBmAverage[0] = pBSSList->ldBmMAX;\r\nfor (ii = 1; ii < RSSI_STAT_COUNT; ii++)\r\npBSSList->ldBmAverage[ii] = 0;\r\n}\r\nif ((pIE_Country != NULL) &&\r\n(pMgmt->b11hEnable == true)) {\r\nset_country_info(pMgmt->pAdapter, pBSSList->eNetworkTypeInUse,\r\npIE_Country);\r\n}\r\nif ((bParsingQuiet == true) && (pIE_Quiet != NULL)) {\r\nif ((((PWLAN_IE_QUIET)pIE_Quiet)->len == 8) &&\r\n(((PWLAN_IE_QUIET)pIE_Quiet)->byQuietCount != 0)) {\r\nif (pQuiet == NULL) {\r\npQuiet = (PWLAN_IE_QUIET)pIE_Quiet;\r\nCARDbSetQuiet( pMgmt->pAdapter,\r\ntrue,\r\npQuiet->byQuietCount,\r\npQuiet->byQuietPeriod,\r\n*((unsigned short *)pQuiet->abyQuietDuration),\r\n*((unsigned short *)pQuiet->abyQuietOffset)\r\n);\r\n} else {\r\npQuiet = (PWLAN_IE_QUIET)pIE_Quiet;\r\nCARDbSetQuiet( pMgmt->pAdapter,\r\nfalse,\r\npQuiet->byQuietCount,\r\npQuiet->byQuietPeriod,\r\n*((unsigned short *)pQuiet->abyQuietDuration),\r\n*((unsigned short *)pQuiet->abyQuietOffset)\r\n);\r\n}\r\n}\r\n}\r\nif ((bParsingQuiet == true) &&\r\n(pQuiet != NULL)) {\r\nCARDbStartQuiet(pMgmt->pAdapter);\r\n}\r\npBSSList->uIELength = uIELength;\r\nif (pBSSList->uIELength > WLAN_BEACON_FR_MAXLEN)\r\npBSSList->uIELength = WLAN_BEACON_FR_MAXLEN;\r\nmemcpy(pBSSList->abyIEs, pbyIEs, pBSSList->uIELength);\r\nreturn true;\r\n}\r\nbool\r\nBSSbUpdateToBSSList (\r\nvoid *hDeviceContext,\r\nQWORD qwTimestamp,\r\nunsigned short wBeaconInterval,\r\nunsigned short wCapInfo,\r\nunsigned char byCurrChannel,\r\nbool bChannelHit,\r\nPWLAN_IE_SSID pSSID,\r\nPWLAN_IE_SUPP_RATES pSuppRates,\r\nPWLAN_IE_SUPP_RATES pExtSuppRates,\r\nPERPObject psERP,\r\nPWLAN_IE_RSN pRSN,\r\nPWLAN_IE_RSN_EXT pRSNWPA,\r\nPWLAN_IE_COUNTRY pIE_Country,\r\nPWLAN_IE_QUIET pIE_Quiet,\r\nPKnownBSS pBSSList,\r\nunsigned int uIELength,\r\nunsigned char *pbyIEs,\r\nvoid *pRxPacketContext\r\n)\r\n{\r\nint ii;\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nPSRxMgmtPacket pRxPacket = (PSRxMgmtPacket)pRxPacketContext;\r\nlong ldBm;\r\nbool bParsingQuiet = false;\r\nPWLAN_IE_QUIET pQuiet = NULL;\r\nif (pBSSList == NULL)\r\nreturn false;\r\nHIDWORD(pBSSList->qwBSSTimestamp) = cpu_to_le32(HIDWORD(qwTimestamp));\r\nLODWORD(pBSSList->qwBSSTimestamp) = cpu_to_le32(LODWORD(qwTimestamp));\r\npBSSList->wBeaconInterval = cpu_to_le16(wBeaconInterval);\r\npBSSList->wCapInfo = cpu_to_le16(wCapInfo);\r\npBSSList->uClearCount = 0;\r\npBSSList->uChannel = byCurrChannel;\r\nif (pSSID->len > WLAN_SSID_MAXLEN)\r\npSSID->len = WLAN_SSID_MAXLEN;\r\nif ((pSSID->len != 0) && (pSSID->abySSID[0] != 0))\r\nmemcpy(pBSSList->abySSID, pSSID, pSSID->len + WLAN_IEHDR_LEN);\r\nmemcpy(pBSSList->abySuppRates, pSuppRates,pSuppRates->len + WLAN_IEHDR_LEN);\r\nif (pExtSuppRates != NULL) {\r\nmemcpy(pBSSList->abyExtSuppRates, pExtSuppRates,pExtSuppRates->len + WLAN_IEHDR_LEN);\r\n} else {\r\nmemset(pBSSList->abyExtSuppRates, 0, WLAN_IEHDR_LEN + WLAN_RATES_MAXLEN + 1);\r\n}\r\npBSSList->sERP.byERP = psERP->byERP;\r\npBSSList->sERP.bERPExist = psERP->bERPExist;\r\nif (pBSSList->uChannel > CB_MAX_CHANNEL_24G) {\r\npBSSList->eNetworkTypeInUse = PHY_TYPE_11A;\r\n} else {\r\nif (pBSSList->sERP.bERPExist == true) {\r\npBSSList->eNetworkTypeInUse = PHY_TYPE_11G;\r\n} else {\r\npBSSList->eNetworkTypeInUse = PHY_TYPE_11B;\r\n}\r\n}\r\npBSSList->byRxRate = pRxPacket->byRxRate;\r\npBSSList->qwLocalTSF = pRxPacket->qwLocalTSF;\r\nif(bChannelHit)\r\npBSSList->uRSSI = pRxPacket->uRSSI;\r\npBSSList->bySQ = pRxPacket->bySQ;\r\nif ((pMgmt->eCurrMode == WMAC_MODE_ESS_STA) &&\r\n(pMgmt->eCurrState == WMAC_STATE_ASSOC)) {\r\nif (pBSSList == pMgmt->pCurrBSS) {\r\nbParsingQuiet = true;\r\n}\r\n}\r\nWPA_ClearRSN(pBSSList);\r\nif (pRSNWPA != NULL) {\r\nunsigned int uLen = pRSNWPA->len + 2;\r\nif (uLen <= (uIELength - (unsigned int)((unsigned char *)pRSNWPA - pbyIEs))) {\r\npBSSList->wWPALen = uLen;\r\nmemcpy(pBSSList->byWPAIE, pRSNWPA, uLen);\r\nWPA_ParseRSN(pBSSList, pRSNWPA);\r\n}\r\n}\r\nWPA2_ClearRSN(pBSSList);\r\nif (pRSN != NULL) {\r\nunsigned int uLen = pRSN->len + 2;\r\nif (uLen <= (uIELength - (unsigned int)((unsigned char *)pRSN - pbyIEs))) {\r\npBSSList->wRSNLen = uLen;\r\nmemcpy(pBSSList->byRSNIE, pRSN, uLen);\r\nWPA2vParseRSN(pBSSList, pRSN);\r\n}\r\n}\r\nif (pRxPacket->uRSSI != 0) {\r\nRFvRSSITodBm(pDevice, (unsigned char)(pRxPacket->uRSSI), &ldBm);\r\npBSSList->byRSSIStatCnt++;\r\npBSSList->byRSSIStatCnt %= RSSI_STAT_COUNT;\r\npBSSList->ldBmAverage[pBSSList->byRSSIStatCnt] = ldBm;\r\nfor(ii=0;ii<RSSI_STAT_COUNT;ii++) {\r\nif (pBSSList->ldBmAverage[ii] != 0) {\r\npBSSList->ldBmMAX = max(pBSSList->ldBmAverage[ii], ldBm);\r\n}\r\n}\r\n}\r\nif ((pIE_Country != NULL) &&\r\n(pMgmt->b11hEnable == true)) {\r\nset_country_info(pMgmt->pAdapter, pBSSList->eNetworkTypeInUse,\r\npIE_Country);\r\n}\r\nif ((bParsingQuiet == true) && (pIE_Quiet != NULL)) {\r\nif ((((PWLAN_IE_QUIET)pIE_Quiet)->len == 8) &&\r\n(((PWLAN_IE_QUIET)pIE_Quiet)->byQuietCount != 0)) {\r\nif (pQuiet == NULL) {\r\npQuiet = (PWLAN_IE_QUIET)pIE_Quiet;\r\nCARDbSetQuiet( pMgmt->pAdapter,\r\ntrue,\r\npQuiet->byQuietCount,\r\npQuiet->byQuietPeriod,\r\n*((unsigned short *)pQuiet->abyQuietDuration),\r\n*((unsigned short *)pQuiet->abyQuietOffset)\r\n);\r\n} else {\r\npQuiet = (PWLAN_IE_QUIET)pIE_Quiet;\r\nCARDbSetQuiet( pMgmt->pAdapter,\r\nfalse,\r\npQuiet->byQuietCount,\r\npQuiet->byQuietPeriod,\r\n*((unsigned short *)pQuiet->abyQuietDuration),\r\n*((unsigned short *)pQuiet->abyQuietOffset)\r\n);\r\n}\r\n}\r\n}\r\nif ((bParsingQuiet == true) &&\r\n(pQuiet != NULL)) {\r\nCARDbStartQuiet(pMgmt->pAdapter);\r\n}\r\npBSSList->uIELength = uIELength;\r\nif (pBSSList->uIELength > WLAN_BEACON_FR_MAXLEN)\r\npBSSList->uIELength = WLAN_BEACON_FR_MAXLEN;\r\nmemcpy(pBSSList->abyIEs, pbyIEs, pBSSList->uIELength);\r\nreturn true;\r\n}\r\nbool\r\nBSSDBbIsSTAInNodeDB(void *pMgmtObject, unsigned char *abyDstAddr,\r\nunsigned int *puNodeIndex)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject) pMgmtObject;\r\nunsigned int ii;\r\nfor (ii = 1; ii < (MAX_NODE_NUM + 1); ii++) {\r\nif (pMgmt->sNodeDBTable[ii].bActive) {\r\nif (!compare_ether_addr(abyDstAddr, pMgmt->sNodeDBTable[ii].abyMACAddr)) {\r\n*puNodeIndex = ii;\r\nreturn true;\r\n}\r\n}\r\n}\r\nreturn false;\r\n}\r\nvoid\r\nBSSvCreateOneNode(void *hDeviceContext, unsigned int *puNodeIndex)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nunsigned int ii;\r\nunsigned int BigestCount = 0;\r\nunsigned int SelectIndex;\r\nstruct sk_buff *skb;\r\nSelectIndex = 1;\r\nfor (ii = 1; ii < (MAX_NODE_NUM + 1); ii++) {\r\nif (pMgmt->sNodeDBTable[ii].bActive) {\r\nif (pMgmt->sNodeDBTable[ii].uInActiveCount > BigestCount) {\r\nBigestCount = pMgmt->sNodeDBTable[ii].uInActiveCount;\r\nSelectIndex = ii;\r\n}\r\n}\r\nelse {\r\nbreak;\r\n}\r\n}\r\nif ( ii == (MAX_NODE_NUM + 1)) {\r\n*puNodeIndex = SelectIndex;\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Replace inactive node = %d\n", SelectIndex);\r\nif (pMgmt->sNodeDBTable[*puNodeIndex].sTxPSQueue.next != NULL) {\r\nwhile ((skb = skb_dequeue(&pMgmt->sNodeDBTable[*puNodeIndex].sTxPSQueue)) != NULL)\r\ndev_kfree_skb(skb);\r\n}\r\n}\r\nelse {\r\n*puNodeIndex = ii;\r\n}\r\nmemset(&pMgmt->sNodeDBTable[*puNodeIndex], 0, sizeof(KnownNodeDB));\r\npMgmt->sNodeDBTable[*puNodeIndex].bActive = true;\r\npMgmt->sNodeDBTable[*puNodeIndex].uRatePollTimeout = FALLBACK_POLL_SECOND;\r\nskb_queue_head_init(&pMgmt->sNodeDBTable[*puNodeIndex].sTxPSQueue);\r\npMgmt->sNodeDBTable[*puNodeIndex].byAuthSequence = 0;\r\npMgmt->sNodeDBTable[*puNodeIndex].wEnQueueCnt = 0;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Create node index = %d\n", ii);\r\nreturn;\r\n}\r\nvoid\r\nBSSvRemoveOneNode(\r\nvoid *hDeviceContext,\r\nunsigned int uNodeIndex\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nunsigned char byMask[8] = {1, 2, 4, 8, 0x10, 0x20, 0x40, 0x80};\r\nstruct sk_buff *skb;\r\nwhile ((skb = skb_dequeue(&pMgmt->sNodeDBTable[uNodeIndex].sTxPSQueue)) != NULL)\r\ndev_kfree_skb(skb);\r\nmemset(&pMgmt->sNodeDBTable[uNodeIndex], 0, sizeof(KnownNodeDB));\r\npMgmt->abyPSTxMap[pMgmt->sNodeDBTable[uNodeIndex].wAID >> 3] &= ~byMask[pMgmt->sNodeDBTable[uNodeIndex].wAID & 7];\r\nreturn;\r\n}\r\nvoid\r\nBSSvUpdateAPNode(\r\nvoid *hDeviceContext,\r\nunsigned short *pwCapInfo,\r\nPWLAN_IE_SUPP_RATES pSuppRates,\r\nPWLAN_IE_SUPP_RATES pExtSuppRates\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nunsigned int uRateLen = WLAN_RATES_MAXLEN;\r\nmemset(&pMgmt->sNodeDBTable[0], 0, sizeof(KnownNodeDB));\r\npMgmt->sNodeDBTable[0].bActive = true;\r\nif (pDevice->eCurrentPHYType == PHY_TYPE_11B) {\r\nuRateLen = WLAN_RATES_MAXLEN_11B;\r\n}\r\npMgmt->abyCurrSuppRates[1] = RATEuSetIE((PWLAN_IE_SUPP_RATES)pSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\nuRateLen);\r\npMgmt->abyCurrExtSuppRates[1] = RATEuSetIE((PWLAN_IE_SUPP_RATES)pExtSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrExtSuppRates,\r\nuRateLen);\r\nRATEvParseMaxRate((void *)pDevice,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrExtSuppRates,\r\ntrue,\r\n&(pMgmt->sNodeDBTable[0].wMaxBasicRate),\r\n&(pMgmt->sNodeDBTable[0].wMaxSuppRate),\r\n&(pMgmt->sNodeDBTable[0].wSuppRate),\r\n&(pMgmt->sNodeDBTable[0].byTopCCKBasicRate),\r\n&(pMgmt->sNodeDBTable[0].byTopOFDMBasicRate)\r\n);\r\nmemcpy(pMgmt->sNodeDBTable[0].abyMACAddr, pMgmt->abyCurrBSSID, WLAN_ADDR_LEN);\r\npMgmt->sNodeDBTable[0].wTxDataRate = pMgmt->sNodeDBTable[0].wMaxSuppRate;\r\npMgmt->sNodeDBTable[0].bShortPreamble = WLAN_GET_CAP_INFO_SHORTPREAMBLE(*pwCapInfo);\r\npMgmt->sNodeDBTable[0].uRatePollTimeout = FALLBACK_POLL_SECOND;\r\n#ifdef PLICE_DEBUG\r\nprintk("BSSvUpdateAPNode:MaxSuppRate is %d\n",pMgmt->sNodeDBTable[0].wMaxSuppRate);\r\n#endif\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"pMgmt->sNodeDBTable[0].wTxDataRate = %d \n", pMgmt->sNodeDBTable[0].wTxDataRate);\r\n}\r\nvoid\r\nBSSvAddMulticastNode(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nif (!pDevice->bEnableHostWEP)\r\nmemset(&pMgmt->sNodeDBTable[0], 0, sizeof(KnownNodeDB));\r\nmemset(pMgmt->sNodeDBTable[0].abyMACAddr, 0xff, WLAN_ADDR_LEN);\r\npMgmt->sNodeDBTable[0].bActive = true;\r\npMgmt->sNodeDBTable[0].bPSEnable = false;\r\nskb_queue_head_init(&pMgmt->sNodeDBTable[0].sTxPSQueue);\r\nRATEvParseMaxRate((void *)pDevice,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrExtSuppRates,\r\ntrue,\r\n&(pMgmt->sNodeDBTable[0].wMaxBasicRate),\r\n&(pMgmt->sNodeDBTable[0].wMaxSuppRate),\r\n&(pMgmt->sNodeDBTable[0].wSuppRate),\r\n&(pMgmt->sNodeDBTable[0].byTopCCKBasicRate),\r\n&(pMgmt->sNodeDBTable[0].byTopOFDMBasicRate)\r\n);\r\npMgmt->sNodeDBTable[0].wTxDataRate = pMgmt->sNodeDBTable[0].wMaxBasicRate;\r\n#ifdef PLICE_DEBUG\r\nprintk("BSSvAddMultiCastNode:pMgmt->sNodeDBTable[0].wTxDataRate is %d\n",pMgmt->sNodeDBTable[0].wTxDataRate);\r\n#endif\r\npMgmt->sNodeDBTable[0].uRatePollTimeout = FALLBACK_POLL_SECOND;\r\n}\r\nvoid\r\nBSSvSecondCallBack(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nunsigned int ii;\r\nPWLAN_IE_SSID pItemSSID, pCurrSSID;\r\nunsigned int uSleepySTACnt = 0;\r\nunsigned int uNonShortSlotSTACnt = 0;\r\nunsigned int uLongPreambleSTACnt = 0;\r\nviawget_wpa_header* wpahdr;\r\nspin_lock_irq(&pDevice->lock);\r\npDevice->uAssocCount = 0;\r\npDevice->byERPFlag &=\r\n~(WLAN_SET_ERP_BARKER_MODE(1) | WLAN_SET_ERP_NONERP_PRESENT(1));\r\n#ifdef FOR_LED_ON_NOTEBOOK\r\nMACvGPIOIn(pDevice->PortOffset, &pDevice->byGPIO);\r\nif ((( !(pDevice->byGPIO & GPIO0_DATA)&&(pDevice->bHWRadioOff == false))||((pDevice->byGPIO & GPIO0_DATA)&&(pDevice->bHWRadioOff == true)))&&(cc==false)){\r\ncc=true;\r\n}\r\nelse if(cc==true){\r\nif(pDevice->bHWRadioOff == true){\r\nif ( !(pDevice->byGPIO & GPIO0_DATA))\r\n{if(status==1) goto start;\r\nstatus=1;\r\nCARDbRadioPowerOff(pDevice);\r\npMgmt->sNodeDBTable[0].bActive = false;\r\npMgmt->eCurrMode = WMAC_MODE_STANDBY;\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\npDevice->bLinkPass = false;\r\n}\r\nif (pDevice->byGPIO &GPIO0_DATA)\r\n{if(status==2) goto start;\r\nstatus=2;\r\nCARDbRadioPowerOn(pDevice);\r\n} }\r\nelse{\r\nif (pDevice->byGPIO & GPIO0_DATA)\r\n{if(status==3) goto start;\r\nstatus=3;\r\nCARDbRadioPowerOff(pDevice);\r\npMgmt->sNodeDBTable[0].bActive = false;\r\npMgmt->eCurrMode = WMAC_MODE_STANDBY;\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\npDevice->bLinkPass = false;\r\n}\r\nif ( !(pDevice->byGPIO & GPIO0_DATA))\r\n{if(status==4) goto start;\r\nstatus=4;\r\nCARDbRadioPowerOn(pDevice);\r\n} }\r\n}\r\nstart:\r\n#endif\r\nif (pDevice->wUseProtectCntDown > 0) {\r\npDevice->wUseProtectCntDown --;\r\n}\r\nelse {\r\npDevice->byERPFlag &= ~(WLAN_SET_ERP_USE_PROTECTION(1));\r\n}\r\n{\r\npDevice->byReAssocCount++;\r\nif((pDevice->byReAssocCount > 10) && (pDevice->bLinkPass != true)) {\r\nprintk("Re-association timeout!!!\n");\r\npDevice->byReAssocCount = 0;\r\n#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT\r\n{\r\nunion iwreq_data wrqu;\r\nmemset(&wrqu, 0, sizeof (wrqu));\r\nwrqu.ap_addr.sa_family = ARPHRD_ETHER;\r\nPRINT_K("wireless_send_event--->SIOCGIWAP(disassociated)\n");\r\nwireless_send_event(pDevice->dev, SIOCGIWAP, &wrqu, NULL);\r\n}\r\n#endif\r\n}\r\nelse if(pDevice->bLinkPass == true)\r\npDevice->byReAssocCount = 0;\r\n}\r\n#ifdef Calcu_LinkQual\r\ns_uCalculateLinkQual((void *)pDevice);\r\n#endif\r\nfor (ii = 0; ii < (MAX_NODE_NUM + 1); ii++) {\r\nif (pMgmt->sNodeDBTable[ii].bActive) {\r\npMgmt->sNodeDBTable[ii].uInActiveCount++;\r\nif (ii > 0) {\r\nif (pMgmt->sNodeDBTable[ii].uInActiveCount > MAX_INACTIVE_COUNT) {\r\nBSSvRemoveOneNode(pDevice, ii);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO\r\n"Inactive timeout [%d] sec, STA index = [%d] remove\n", MAX_INACTIVE_COUNT, ii);\r\ncontinue;\r\n}\r\nif (pMgmt->sNodeDBTable[ii].eNodeState >= NODE_ASSOC) {\r\npDevice->uAssocCount++;\r\nif (pMgmt->sNodeDBTable[ii].uInActiveCount < ERP_RECOVER_COUNT) {\r\nif (!pMgmt->sNodeDBTable[ii].bShortPreamble) {\r\npDevice->byERPFlag |= WLAN_SET_ERP_BARKER_MODE(1);\r\nuLongPreambleSTACnt ++;\r\n}\r\nif (!pMgmt->sNodeDBTable[ii].bERPExist) {\r\npDevice->byERPFlag |= WLAN_SET_ERP_NONERP_PRESENT(1);\r\npDevice->byERPFlag |= WLAN_SET_ERP_USE_PROTECTION(1);\r\n}\r\nif (!pMgmt->sNodeDBTable[ii].bShortSlotTime)\r\nuNonShortSlotSTACnt++;\r\n}\r\n}\r\nif (pMgmt->sNodeDBTable[ii].bPSEnable)\r\nuSleepySTACnt++;\r\n}\r\nif (!pDevice->bFixRate) {\r\nif (ii > 0) {\r\nRATEvTxRateFallBack((void *)pDevice, &(pMgmt->sNodeDBTable[ii]));\r\n}\r\nelse {\r\nif (pMgmt->eCurrMode == WMAC_MODE_ESS_STA)\r\n#ifdef PLICE_DEBUG\r\nprintk("SecondCallback:Before:TxDataRate is %d\n",pMgmt->sNodeDBTable[0].wTxDataRate);\r\n#endif\r\nRATEvTxRateFallBack((void *)pDevice, &(pMgmt->sNodeDBTable[ii]));\r\n#ifdef PLICE_DEBUG\r\nprintk("SecondCallback:After:TxDataRate is %d\n",pMgmt->sNodeDBTable[0].wTxDataRate);\r\n#endif\r\n}\r\n}\r\nif (pMgmt->sNodeDBTable[ii].wEnQueueCnt != 0) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Index= %d, Queue = %d pending \n",\r\nii, pMgmt->sNodeDBTable[ii].wEnQueueCnt);\r\nif ((ii >0) && (pMgmt->sNodeDBTable[ii].wEnQueueCnt > 15)) {\r\nBSSvRemoveOneNode(pDevice, ii);\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Pending many queues PS STA Index = %d remove \n", ii);\r\ncontinue;\r\n}\r\n}\r\n}\r\n}\r\nif ((pMgmt->eCurrMode == WMAC_MODE_ESS_AP) && (pDevice->eCurrentPHYType == PHY_TYPE_11G)) {\r\nif (WLAN_GET_ERP_USE_PROTECTION(pDevice->byERPFlag)) {\r\nif (!pDevice->bProtectMode) {\r\nMACvEnableProtectMD(pDevice->PortOffset);\r\npDevice->bProtectMode = true;\r\n}\r\n}\r\nelse {\r\nif (pDevice->bProtectMode) {\r\nMACvDisableProtectMD(pDevice->PortOffset);\r\npDevice->bProtectMode = false;\r\n}\r\n}\r\nif (uNonShortSlotSTACnt > 0) {\r\nif (pDevice->bShortSlotTime) {\r\npDevice->bShortSlotTime = false;\r\nBBvSetShortSlotTime(pDevice);\r\nvUpdateIFS((void *)pDevice);\r\n}\r\n}\r\nelse {\r\nif (!pDevice->bShortSlotTime) {\r\npDevice->bShortSlotTime = true;\r\nBBvSetShortSlotTime(pDevice);\r\nvUpdateIFS((void *)pDevice);\r\n}\r\n}\r\nif (uLongPreambleSTACnt > 0) {\r\nif (!pDevice->bBarkerPreambleMd) {\r\nMACvEnableBarkerPreambleMd(pDevice->PortOffset);\r\npDevice->bBarkerPreambleMd = true;\r\n}\r\n}\r\nelse {\r\nif (pDevice->bBarkerPreambleMd) {\r\nMACvDisableBarkerPreambleMd(pDevice->PortOffset);\r\npDevice->bBarkerPreambleMd = false;\r\n}\r\n}\r\n}\r\nif (pMgmt->eCurrMode == WMAC_MODE_ESS_AP) {\r\nif (uSleepySTACnt > 0)\r\npMgmt->sNodeDBTable[0].bPSEnable = true;\r\nelse\r\npMgmt->sNodeDBTable[0].bPSEnable = false;\r\n}\r\npItemSSID = (PWLAN_IE_SSID)pMgmt->abyDesireSSID;\r\npCurrSSID = (PWLAN_IE_SSID)pMgmt->abyCurrSSID;\r\nif ((pMgmt->eCurrMode == WMAC_MODE_STANDBY) ||\r\n(pMgmt->eCurrMode == WMAC_MODE_ESS_STA)) {\r\nif (pMgmt->sNodeDBTable[0].bActive) {\r\nif (pDevice->bUpdateBBVGA) {\r\ns_vCheckPreEDThreshold((void *)pDevice);\r\n}\r\nif ((pMgmt->sNodeDBTable[0].uInActiveCount >= (LOST_BEACON_COUNT/2)) &&\r\n(pDevice->byBBVGACurrent != pDevice->abyBBVGA[0]) ) {\r\npDevice->byBBVGANew = pDevice->abyBBVGA[0];\r\nbScheduleCommand((void *) pDevice, WLAN_CMD_CHANGE_BBSENSITIVITY, NULL);\r\n}\r\nif (pMgmt->sNodeDBTable[0].uInActiveCount >= LOST_BEACON_COUNT) {\r\npMgmt->sNodeDBTable[0].bActive = false;\r\npMgmt->eCurrMode = WMAC_MODE_STANDBY;\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\nnetif_stop_queue(pDevice->dev);\r\npDevice->bLinkPass = false;\r\npDevice->bRoaming = true;\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Lost AP beacon [%d] sec, disconnected !\n", pMgmt->sNodeDBTable[0].uInActiveCount);\r\nif ((pDevice->bWPADEVUp) && (pDevice->skb != NULL)) {\r\nwpahdr = (viawget_wpa_header *)pDevice->skb->data;\r\nwpahdr->type = VIAWGET_DISASSOC_MSG;\r\nwpahdr->resp_ie_len = 0;\r\nwpahdr->req_ie_len = 0;\r\nskb_put(pDevice->skb, sizeof(viawget_wpa_header));\r\npDevice->skb->dev = pDevice->wpadev;\r\nskb_reset_mac_header(pDevice->skb);\r\npDevice->skb->pkt_type = PACKET_HOST;\r\npDevice->skb->protocol = htons(ETH_P_802_2);\r\nmemset(pDevice->skb->cb, 0, sizeof(pDevice->skb->cb));\r\nnetif_rx(pDevice->skb);\r\npDevice->skb = dev_alloc_skb((int)pDevice->rx_buf_sz);\r\n}\r\n#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT\r\n{\r\nunion iwreq_data wrqu;\r\nmemset(&wrqu, 0, sizeof (wrqu));\r\nwrqu.ap_addr.sa_family = ARPHRD_ETHER;\r\nPRINT_K("wireless_send_event--->SIOCGIWAP(disassociated)\n");\r\nwireless_send_event(pDevice->dev, SIOCGIWAP, &wrqu, NULL);\r\n}\r\n#endif\r\n}\r\n}\r\nelse if (pItemSSID->len != 0) {\r\nif (pDevice->uAutoReConnectTime < 10) {\r\npDevice->uAutoReConnectTime++;\r\n#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT\r\nif(pDevice->bWPASuppWextEnabled ==true)\r\npDevice->uAutoReConnectTime = 0;\r\n#endif\r\n}\r\nelse {\r\nif(pDevice->bWPADEVUp)\r\npDevice->eEncryptionStatus = pDevice->eOldEncryptionStatus;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Roaming ...\n");\r\nBSSvClearBSSList((void *)pDevice, pDevice->bLinkPass);\r\npMgmt->eScanType = WMAC_SCAN_ACTIVE;\r\nbScheduleCommand((void *) pDevice, WLAN_CMD_BSSID_SCAN, pMgmt->abyDesireSSID);\r\nbScheduleCommand((void *) pDevice, WLAN_CMD_SSID, pMgmt->abyDesireSSID);\r\npDevice->uAutoReConnectTime = 0;\r\n}\r\n}\r\n}\r\nif (pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) {\r\nif ((pMgmt->eCurrState == WMAC_STATE_STARTED) && (pCurrSSID->len == 0)) {\r\nif (pDevice->uAutoReConnectTime < 10) {\r\npDevice->uAutoReConnectTime++;\r\n}\r\nelse {\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Adhoc re-scanning ...\n");\r\npMgmt->eScanType = WMAC_SCAN_ACTIVE;\r\nbScheduleCommand((void *) pDevice, WLAN_CMD_BSSID_SCAN, NULL);\r\nbScheduleCommand((void *) pDevice, WLAN_CMD_SSID, NULL);\r\npDevice->uAutoReConnectTime = 0;\r\n};\r\n}\r\nif (pMgmt->eCurrState == WMAC_STATE_JOINTED) {\r\nif (pDevice->bUpdateBBVGA) {\r\ns_vCheckPreEDThreshold((void *)pDevice);\r\n}\r\nif (pMgmt->sNodeDBTable[0].uInActiveCount >=ADHOC_LOST_BEACON_COUNT) {\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Lost other STA beacon [%d] sec, started !\n", pMgmt->sNodeDBTable[0].uInActiveCount);\r\npMgmt->sNodeDBTable[0].uInActiveCount = 0;\r\npMgmt->eCurrState = WMAC_STATE_STARTED;\r\nnetif_stop_queue(pDevice->dev);\r\npDevice->bLinkPass = false;\r\n}\r\n}\r\n}\r\nspin_unlock_irq(&pDevice->lock);\r\npMgmt->sTimerSecondCallback.expires = RUN_AT(HZ);\r\nadd_timer(&pMgmt->sTimerSecondCallback);\r\nreturn;\r\n}\r\nvoid\r\nBSSvUpdateNodeTxCounter(\r\nvoid *hDeviceContext,\r\nunsigned char byTsr0,\r\nunsigned char byTsr1,\r\nunsigned char *pbyBuffer,\r\nunsigned int uFIFOHeaderSize\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nunsigned int uNodeIndex = 0;\r\nunsigned char byTxRetry = (byTsr0 & TSR0_NCR);\r\nPSTxBufHead pTxBufHead;\r\nPS802_11Header pMACHeader;\r\nunsigned short wRate;\r\nunsigned short wFallBackRate = RATE_1M;\r\nunsigned char byFallBack;\r\nunsigned int ii;\r\npTxBufHead = (PSTxBufHead) pbyBuffer;\r\nif (pTxBufHead->wFIFOCtl & FIFOCTL_AUTO_FB_0) {\r\nbyFallBack = AUTO_FB_0;\r\n} else if (pTxBufHead->wFIFOCtl & FIFOCTL_AUTO_FB_1) {\r\nbyFallBack = AUTO_FB_1;\r\n} else {\r\nbyFallBack = AUTO_FB_NONE;\r\n}\r\nwRate = pTxBufHead->wReserved;\r\nif (pTxBufHead->wFIFOCtl & FIFOCTL_NEEDACK) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"wRate %04X, byTsr0 %02X, byTsr1 %02X\n", wRate, byTsr0, byTsr1);\r\nif (pMgmt->eCurrMode == WMAC_MODE_ESS_STA) {\r\npMgmt->sNodeDBTable[0].uTxAttempts += 1;\r\nif ((byTsr1 & TSR1_TERR) == 0) {\r\npMgmt->sNodeDBTable[0].uTxOk[MAX_RATE]++;\r\nif ( (byFallBack == AUTO_FB_NONE) ||\r\n(wRate < RATE_18M) ) {\r\nwFallBackRate = wRate;\r\n} else if (byFallBack == AUTO_FB_0) {\r\nif (byTxRetry < 5)\r\nwFallBackRate = awHWRetry0[wRate-RATE_18M][byTxRetry];\r\nelse\r\nwFallBackRate = awHWRetry0[wRate-RATE_18M][4];\r\n} else if (byFallBack == AUTO_FB_1) {\r\nif (byTxRetry < 5)\r\nwFallBackRate = awHWRetry1[wRate-RATE_18M][byTxRetry];\r\nelse\r\nwFallBackRate = awHWRetry1[wRate-RATE_18M][4];\r\n}\r\npMgmt->sNodeDBTable[0].uTxOk[wFallBackRate]++;\r\n} else {\r\npMgmt->sNodeDBTable[0].uTxFailures ++;\r\n}\r\npMgmt->sNodeDBTable[0].uTxRetry += byTxRetry;\r\nif (byTxRetry != 0) {\r\npMgmt->sNodeDBTable[0].uTxFail[MAX_RATE]+=byTxRetry;\r\nif ( (byFallBack == AUTO_FB_NONE) ||\r\n(wRate < RATE_18M) ) {\r\npMgmt->sNodeDBTable[0].uTxFail[wRate]+=byTxRetry;\r\n} else if (byFallBack == AUTO_FB_0) {\r\nfor(ii=0;ii<byTxRetry;ii++)\r\n{\r\nif (ii < 5)\r\n{\r\nwFallBackRate = awHWRetry0[wRate-RATE_18M][ii];\r\n}\r\nelse\r\n{\r\nwFallBackRate = awHWRetry0[wRate-RATE_18M][4];\r\n}\r\npMgmt->sNodeDBTable[0].uTxFail[wFallBackRate]++;\r\n}\r\n} else if (byFallBack == AUTO_FB_1) {\r\nfor(ii=0;ii<byTxRetry;ii++) {\r\nif (ii < 5)\r\nwFallBackRate = awHWRetry1[wRate-RATE_18M][ii];\r\nelse\r\nwFallBackRate = awHWRetry1[wRate-RATE_18M][4];\r\npMgmt->sNodeDBTable[0].uTxFail[wFallBackRate]++;\r\n}\r\n}\r\n}\r\n}\r\nif ((pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) ||\r\n(pMgmt->eCurrMode == WMAC_MODE_ESS_AP)) {\r\npMACHeader = (PS802_11Header)(pbyBuffer + uFIFOHeaderSize);\r\nif (BSSDBbIsSTAInNodeDB((void *)pMgmt, &(pMACHeader->abyAddr1[0]), &uNodeIndex)){\r\npMgmt->sNodeDBTable[uNodeIndex].uTxAttempts += 1;\r\nif ((byTsr1 & TSR1_TERR) == 0) {\r\npMgmt->sNodeDBTable[uNodeIndex].uTxOk[MAX_RATE]++;\r\nif ( (byFallBack == AUTO_FB_NONE) ||\r\n(wRate < RATE_18M) ) {\r\nwFallBackRate = wRate;\r\n} else if (byFallBack == AUTO_FB_0) {\r\nif (byTxRetry < 5)\r\nwFallBackRate = awHWRetry0[wRate-RATE_18M][byTxRetry];\r\nelse\r\nwFallBackRate = awHWRetry0[wRate-RATE_18M][4];\r\n} else if (byFallBack == AUTO_FB_1) {\r\nif (byTxRetry < 5)\r\nwFallBackRate = awHWRetry1[wRate-RATE_18M][byTxRetry];\r\nelse\r\nwFallBackRate = awHWRetry1[wRate-RATE_18M][4];\r\n}\r\npMgmt->sNodeDBTable[uNodeIndex].uTxOk[wFallBackRate]++;\r\n} else {\r\npMgmt->sNodeDBTable[uNodeIndex].uTxFailures ++;\r\n}\r\npMgmt->sNodeDBTable[uNodeIndex].uTxRetry += byTxRetry;\r\nif (byTxRetry != 0) {\r\npMgmt->sNodeDBTable[uNodeIndex].uTxFail[MAX_RATE]+=byTxRetry;\r\nif ( (byFallBack == AUTO_FB_NONE) ||\r\n(wRate < RATE_18M) ) {\r\npMgmt->sNodeDBTable[uNodeIndex].uTxFail[wRate]+=byTxRetry;\r\n} else if (byFallBack == AUTO_FB_0) {\r\nfor(ii=0;ii<byTxRetry;ii++) {\r\nif (ii < 5)\r\nwFallBackRate = awHWRetry0[wRate-RATE_18M][ii];\r\nelse\r\nwFallBackRate = awHWRetry0[wRate-RATE_18M][4];\r\npMgmt->sNodeDBTable[uNodeIndex].uTxFail[wFallBackRate]++;\r\n}\r\n} else if (byFallBack == AUTO_FB_1) {\r\nfor(ii=0;ii<byTxRetry;ii++) {\r\nif (ii < 5)\r\nwFallBackRate = awHWRetry1[wRate-RATE_18M][ii];\r\nelse\r\nwFallBackRate = awHWRetry1[wRate-RATE_18M][4];\r\npMgmt->sNodeDBTable[uNodeIndex].uTxFail[wFallBackRate]++;\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\nreturn;\r\n}\r\nvoid\r\nBSSvClearNodeDBTable(\r\nvoid *hDeviceContext,\r\nunsigned int uStartIndex\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nstruct sk_buff *skb;\r\nunsigned int ii;\r\nfor (ii = uStartIndex; ii < (MAX_NODE_NUM + 1); ii++) {\r\nif (pMgmt->sNodeDBTable[ii].bActive) {\r\nif (pMgmt->sNodeDBTable[ii].sTxPSQueue.next != NULL) {\r\nwhile ((skb = skb_dequeue(&pMgmt->sNodeDBTable[ii].sTxPSQueue)) != NULL){\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "PS skb != NULL %d\n", ii);\r\ndev_kfree_skb(skb);\r\n}\r\n}\r\nmemset(&pMgmt->sNodeDBTable[ii], 0, sizeof(KnownNodeDB));\r\n}\r\n}\r\nreturn;\r\n}\r\nvoid s_vCheckSensitivity(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPKnownBSS pBSSList = NULL;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nint ii;\r\nif ((pDevice->byLocalID <= REV_ID_VT3253_A1) && (pDevice->byRFType == RF_RFMD2959) &&\r\n(pMgmt->eCurrMode == WMAC_MODE_IBSS_STA)) {\r\nreturn;\r\n}\r\nif ((pMgmt->eCurrState == WMAC_STATE_ASSOC) ||\r\n((pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) && (pMgmt->eCurrState == WMAC_STATE_JOINTED))) {\r\npBSSList = BSSpAddrIsInBSSList(pDevice, pMgmt->abyCurrBSSID, (PWLAN_IE_SSID)pMgmt->abyCurrSSID);\r\nif (pBSSList != NULL) {\r\nlong LocalldBmAverage = 0;\r\nlong uNumofdBm = 0;\r\nfor (ii = 0; ii < RSSI_STAT_COUNT; ii++) {\r\nif (pBSSList->ldBmAverage[ii] != 0) {\r\nuNumofdBm ++;\r\nLocalldBmAverage += pBSSList->ldBmAverage[ii];\r\n}\r\n}\r\nif (uNumofdBm > 0) {\r\nLocalldBmAverage = LocalldBmAverage/uNumofdBm;\r\nfor (ii=0;ii<BB_VGA_LEVEL;ii++) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"LocalldBmAverage:%ld, %ld %02x\n", LocalldBmAverage, pDevice->ldBmThreshold[ii], pDevice->abyBBVGA[ii]);\r\nif (LocalldBmAverage < pDevice->ldBmThreshold[ii]) {\r\npDevice->byBBVGANew = pDevice->abyBBVGA[ii];\r\nbreak;\r\n}\r\n}\r\nif (pDevice->byBBVGANew != pDevice->byBBVGACurrent) {\r\npDevice->uBBVGADiffCount++;\r\nif (pDevice->uBBVGADiffCount >= BB_VGA_CHANGE_THRESHOLD)\r\nbScheduleCommand((void *) pDevice, WLAN_CMD_CHANGE_BBSENSITIVITY, NULL);\r\n} else {\r\npDevice->uBBVGADiffCount = 0;\r\n}\r\n}\r\n}\r\n}\r\n}\r\nvoid\r\nBSSvClearAnyBSSJoinRecord (\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nunsigned int ii;\r\nfor (ii = 0; ii < MAX_BSS_NUM; ii++) {\r\npMgmt->sBSSList[ii].bSelected = false;\r\n}\r\nreturn;\r\n}\r\nvoid s_uCalculateLinkQual(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nunsigned long TxOkRatio, TxCnt;\r\nunsigned long RxOkRatio,RxCnt;\r\nunsigned long RssiRatio;\r\nlong ldBm;\r\nTxCnt = pDevice->scStatistic.TxNoRetryOkCount +\r\npDevice->scStatistic.TxRetryOkCount +\r\npDevice->scStatistic.TxFailCount;\r\nRxCnt = pDevice->scStatistic.RxFcsErrCnt +\r\npDevice->scStatistic.RxOkCnt;\r\nTxOkRatio = (TxCnt < 6) ? 4000:((pDevice->scStatistic.TxNoRetryOkCount * 4000) / TxCnt);\r\nRxOkRatio = (RxCnt < 6) ? 2000:((pDevice->scStatistic.RxOkCnt * 2000) / RxCnt);\r\nif(pDevice->bLinkPass !=true)\r\n{\r\npDevice->scStatistic.LinkQuality = 0;\r\npDevice->scStatistic.SignalStren = 0;\r\n}\r\nelse\r\n{\r\nRFvRSSITodBm(pDevice, (unsigned char)(pDevice->uCurrRSSI), &ldBm);\r\nif(-ldBm < 50) {\r\nRssiRatio = 4000;\r\n}\r\nelse if(-ldBm > 90) {\r\nRssiRatio = 0;\r\n}\r\nelse {\r\nRssiRatio = (40-(-ldBm-50))*4000/40;\r\n}\r\npDevice->scStatistic.SignalStren = RssiRatio/40;\r\npDevice->scStatistic.LinkQuality = (RssiRatio+TxOkRatio+RxOkRatio)/100;\r\n}\r\npDevice->scStatistic.RxFcsErrCnt = 0;\r\npDevice->scStatistic.RxOkCnt = 0;\r\npDevice->scStatistic.TxFailCount = 0;\r\npDevice->scStatistic.TxNoRetryOkCount = 0;\r\npDevice->scStatistic.TxRetryOkCount = 0;\r\nreturn;\r\n}\r\nvoid s_vCheckPreEDThreshold(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPKnownBSS pBSSList = NULL;\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nif ((pMgmt->eCurrState == WMAC_STATE_ASSOC) ||\r\n((pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) && (pMgmt->eCurrState == WMAC_STATE_JOINTED))) {\r\npBSSList = BSSpAddrIsInBSSList(pDevice, pMgmt->abyCurrBSSID, (PWLAN_IE_SSID)pMgmt->abyCurrSSID);\r\nif (pBSSList != NULL) {\r\npDevice->byBBPreEDRSSI = (unsigned char) (~(pBSSList->ldBmAverRange) + 1);\r\n}\r\n}\r\nreturn;\r\n}

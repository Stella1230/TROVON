static bool tfp410_readb(struct intel_dvo_device *dvo, int addr, uint8_t *ch)\r\n{\r\nstruct tfp410_priv *tfp = dvo->dev_priv;\r\nstruct i2c_adapter *adapter = dvo->i2c_bus;\r\nu8 out_buf[2];\r\nu8 in_buf[2];\r\nstruct i2c_msg msgs[] = {\r\n{\r\n.addr = dvo->slave_addr,\r\n.flags = 0,\r\n.len = 1,\r\n.buf = out_buf,\r\n},\r\n{\r\n.addr = dvo->slave_addr,\r\n.flags = I2C_M_RD,\r\n.len = 1,\r\n.buf = in_buf,\r\n}\r\n};\r\nout_buf[0] = addr;\r\nout_buf[1] = 0;\r\nif (i2c_transfer(adapter, msgs, 2) == 2) {\r\n*ch = in_buf[0];\r\nreturn true;\r\n};\r\nif (!tfp->quiet) {\r\nDRM_DEBUG_KMS("Unable to read register 0x%02x from %s:%02x.\n",\r\naddr, adapter->name, dvo->slave_addr);\r\n}\r\nreturn false;\r\n}\r\nstatic bool tfp410_writeb(struct intel_dvo_device *dvo, int addr, uint8_t ch)\r\n{\r\nstruct tfp410_priv *tfp = dvo->dev_priv;\r\nstruct i2c_adapter *adapter = dvo->i2c_bus;\r\nuint8_t out_buf[2];\r\nstruct i2c_msg msg = {\r\n.addr = dvo->slave_addr,\r\n.flags = 0,\r\n.len = 2,\r\n.buf = out_buf,\r\n};\r\nout_buf[0] = addr;\r\nout_buf[1] = ch;\r\nif (i2c_transfer(adapter, &msg, 1) == 1)\r\nreturn true;\r\nif (!tfp->quiet) {\r\nDRM_DEBUG_KMS("Unable to write register 0x%02x to %s:%d.\n",\r\naddr, adapter->name, dvo->slave_addr);\r\n}\r\nreturn false;\r\n}\r\nstatic int tfp410_getid(struct intel_dvo_device *dvo, int addr)\r\n{\r\nuint8_t ch1, ch2;\r\nif (tfp410_readb(dvo, addr+0, &ch1) &&\r\ntfp410_readb(dvo, addr+1, &ch2))\r\nreturn ((ch2 << 8) & 0xFF00) | (ch1 & 0x00FF);\r\nreturn -1;\r\n}\r\nstatic bool tfp410_init(struct intel_dvo_device *dvo,\r\nstruct i2c_adapter *adapter)\r\n{\r\nstruct tfp410_priv *tfp;\r\nint id;\r\ntfp = kzalloc(sizeof(struct tfp410_priv), GFP_KERNEL);\r\nif (tfp == NULL)\r\nreturn false;\r\ndvo->i2c_bus = adapter;\r\ndvo->dev_priv = tfp;\r\ntfp->quiet = true;\r\nif ((id = tfp410_getid(dvo, TFP410_VID_LO)) != TFP410_VID) {\r\nDRM_DEBUG_KMS("tfp410 not detected got VID %X: from %s "\r\n"Slave %d.\n",\r\nid, adapter->name, dvo->slave_addr);\r\ngoto out;\r\n}\r\nif ((id = tfp410_getid(dvo, TFP410_DID_LO)) != TFP410_DID) {\r\nDRM_DEBUG_KMS("tfp410 not detected got DID %X: from %s "\r\n"Slave %d.\n",\r\nid, adapter->name, dvo->slave_addr);\r\ngoto out;\r\n}\r\ntfp->quiet = false;\r\nreturn true;\r\nout:\r\nkfree(tfp);\r\nreturn false;\r\n}\r\nstatic enum drm_connector_status tfp410_detect(struct intel_dvo_device *dvo)\r\n{\r\nenum drm_connector_status ret = connector_status_disconnected;\r\nuint8_t ctl2;\r\nif (tfp410_readb(dvo, TFP410_CTL_2, &ctl2)) {\r\nif (ctl2 & TFP410_CTL_2_RSEN)\r\nret = connector_status_connected;\r\nelse\r\nret = connector_status_disconnected;\r\n}\r\nreturn ret;\r\n}\r\nstatic enum drm_mode_status tfp410_mode_valid(struct intel_dvo_device *dvo,\r\nstruct drm_display_mode *mode)\r\n{\r\nreturn MODE_OK;\r\n}\r\nstatic void tfp410_mode_set(struct intel_dvo_device *dvo,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nreturn;\r\n}\r\nstatic void tfp410_dpms(struct intel_dvo_device *dvo, int mode)\r\n{\r\nuint8_t ctl1;\r\nif (!tfp410_readb(dvo, TFP410_CTL_1, &ctl1))\r\nreturn;\r\nif (mode == DRM_MODE_DPMS_ON)\r\nctl1 |= TFP410_CTL_1_PD;\r\nelse\r\nctl1 &= ~TFP410_CTL_1_PD;\r\ntfp410_writeb(dvo, TFP410_CTL_1, ctl1);\r\n}\r\nstatic void tfp410_dump_regs(struct intel_dvo_device *dvo)\r\n{\r\nuint8_t val, val2;\r\ntfp410_readb(dvo, TFP410_REV, &val);\r\nDRM_LOG_KMS("TFP410_REV: 0x%02X\n", val);\r\ntfp410_readb(dvo, TFP410_CTL_1, &val);\r\nDRM_LOG_KMS("TFP410_CTL1: 0x%02X\n", val);\r\ntfp410_readb(dvo, TFP410_CTL_2, &val);\r\nDRM_LOG_KMS("TFP410_CTL2: 0x%02X\n", val);\r\ntfp410_readb(dvo, TFP410_CTL_3, &val);\r\nDRM_LOG_KMS("TFP410_CTL3: 0x%02X\n", val);\r\ntfp410_readb(dvo, TFP410_USERCFG, &val);\r\nDRM_LOG_KMS("TFP410_USERCFG: 0x%02X\n", val);\r\ntfp410_readb(dvo, TFP410_DE_DLY, &val);\r\nDRM_LOG_KMS("TFP410_DE_DLY: 0x%02X\n", val);\r\ntfp410_readb(dvo, TFP410_DE_CTL, &val);\r\nDRM_LOG_KMS("TFP410_DE_CTL: 0x%02X\n", val);\r\ntfp410_readb(dvo, TFP410_DE_TOP, &val);\r\nDRM_LOG_KMS("TFP410_DE_TOP: 0x%02X\n", val);\r\ntfp410_readb(dvo, TFP410_DE_CNT_LO, &val);\r\ntfp410_readb(dvo, TFP410_DE_CNT_HI, &val2);\r\nDRM_LOG_KMS("TFP410_DE_CNT: 0x%02X%02X\n", val2, val);\r\ntfp410_readb(dvo, TFP410_DE_LIN_LO, &val);\r\ntfp410_readb(dvo, TFP410_DE_LIN_HI, &val2);\r\nDRM_LOG_KMS("TFP410_DE_LIN: 0x%02X%02X\n", val2, val);\r\ntfp410_readb(dvo, TFP410_H_RES_LO, &val);\r\ntfp410_readb(dvo, TFP410_H_RES_HI, &val2);\r\nDRM_LOG_KMS("TFP410_H_RES: 0x%02X%02X\n", val2, val);\r\ntfp410_readb(dvo, TFP410_V_RES_LO, &val);\r\ntfp410_readb(dvo, TFP410_V_RES_HI, &val2);\r\nDRM_LOG_KMS("TFP410_V_RES: 0x%02X%02X\n", val2, val);\r\n}\r\nstatic void tfp410_destroy(struct intel_dvo_device *dvo)\r\n{\r\nstruct tfp410_priv *tfp = dvo->dev_priv;\r\nif (tfp) {\r\nkfree(tfp);\r\ndvo->dev_priv = NULL;\r\n}\r\n}

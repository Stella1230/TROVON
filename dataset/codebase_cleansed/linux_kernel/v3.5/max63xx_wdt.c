static struct max63xx_timeout *\r\nmax63xx_select_timeout(struct max63xx_timeout *table, int value)\r\n{\r\nwhile (table->twd) {\r\nif (value <= table->twd) {\r\nif (nodelay && table->tdelay == 0)\r\nreturn table;\r\nif (!nodelay)\r\nreturn table;\r\n}\r\ntable++;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int max63xx_wdt_ping(struct watchdog_device *wdd)\r\n{\r\nu8 val;\r\nspin_lock(&io_lock);\r\nval = __raw_readb(wdt_base);\r\n__raw_writeb(val | MAX6369_WDI, wdt_base);\r\n__raw_writeb(val & ~MAX6369_WDI, wdt_base);\r\nspin_unlock(&io_lock);\r\nreturn 0;\r\n}\r\nstatic int max63xx_wdt_start(struct watchdog_device *wdd)\r\n{\r\nstruct max63xx_timeout *entry = watchdog_get_drvdata(wdd);\r\nu8 val;\r\nspin_lock(&io_lock);\r\nval = __raw_readb(wdt_base);\r\nval &= ~MAX6369_WDSET;\r\nval |= entry->wdset;\r\n__raw_writeb(val, wdt_base);\r\nspin_unlock(&io_lock);\r\nif (entry->tdelay == 0)\r\nmax63xx_wdt_ping(wdd);\r\nreturn 0;\r\n}\r\nstatic int max63xx_wdt_stop(struct watchdog_device *wdd)\r\n{\r\nu8 val;\r\nspin_lock(&io_lock);\r\nval = __raw_readb(wdt_base);\r\nval &= ~MAX6369_WDSET;\r\nval |= 3;\r\n__raw_writeb(val, wdt_base);\r\nspin_unlock(&io_lock);\r\nreturn 0;\r\n}\r\nstatic int __devinit max63xx_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *wdt_mem;\r\nstruct max63xx_timeout *table;\r\ntable = (struct max63xx_timeout *)pdev->id_entry->driver_data;\r\nif (heartbeat < 1 || heartbeat > MAX_HEARTBEAT)\r\nheartbeat = DEFAULT_HEARTBEAT;\r\ndev_info(&pdev->dev, "requesting %ds heartbeat\n", heartbeat);\r\ncurrent_timeout = max63xx_select_timeout(table, heartbeat);\r\nif (!current_timeout) {\r\ndev_err(&pdev->dev, "unable to satisfy heartbeat request\n");\r\nreturn -EINVAL;\r\n}\r\ndev_info(&pdev->dev, "using %ds heartbeat with %ds initial delay\n",\r\ncurrent_timeout->twd, current_timeout->tdelay);\r\nheartbeat = current_timeout->twd;\r\nwdt_mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nwdt_base = devm_request_and_ioremap(&pdev->dev, wdt_mem);\r\nif (!wdt_base)\r\nreturn -ENOMEM;\r\nmax63xx_wdt_dev.timeout = heartbeat;\r\nwatchdog_set_nowayout(&max63xx_wdt_dev, nowayout);\r\nwatchdog_set_drvdata(&max63xx_wdt_dev, current_timeout);\r\nreturn watchdog_register_device(&max63xx_wdt_dev);\r\n}\r\nstatic int __devexit max63xx_wdt_remove(struct platform_device *pdev)\r\n{\r\nwatchdog_unregister_device(&max63xx_wdt_dev);\r\nreturn 0;\r\n}

static void nuc900_clockevent_setmode(enum clock_event_mode mode,\r\nstruct clock_event_device *clk)\r\n{\r\nunsigned int val;\r\nval = __raw_readl(REG_TCSR0);\r\nval &= ~(0x03 << 27);\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_PERIODIC:\r\n__raw_writel(timer0_load, REG_TICR0);\r\nval |= (PERIOD | COUNTEN | INTEN | PRESCALE);\r\nbreak;\r\ncase CLOCK_EVT_MODE_ONESHOT:\r\nval |= (ONESHOT | COUNTEN | INTEN | PRESCALE);\r\nbreak;\r\ncase CLOCK_EVT_MODE_UNUSED:\r\ncase CLOCK_EVT_MODE_SHUTDOWN:\r\ncase CLOCK_EVT_MODE_RESUME:\r\nbreak;\r\n}\r\n__raw_writel(val, REG_TCSR0);\r\n}\r\nstatic int nuc900_clockevent_setnextevent(unsigned long evt,\r\nstruct clock_event_device *clk)\r\n{\r\nunsigned int val;\r\n__raw_writel(evt, REG_TICR0);\r\nval = __raw_readl(REG_TCSR0);\r\nval |= (COUNTEN | INTEN | PRESCALE);\r\n__raw_writel(val, REG_TCSR0);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t nuc900_timer0_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = &nuc900_clockevent_device;\r\n__raw_writel(0x01, REG_TISR);\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __init nuc900_clockevents_init(void)\r\n{\r\nunsigned int rate;\r\nstruct clk *clk = clk_get(NULL, "timer0");\r\nBUG_ON(IS_ERR(clk));\r\n__raw_writel(0x00, REG_TCSR0);\r\nclk_enable(clk);\r\nrate = clk_get_rate(clk) / (PRESCALE + 1);\r\ntimer0_load = (rate / TICKS_PER_SEC);\r\n__raw_writel(RESETINT, REG_TISR);\r\nsetup_irq(IRQ_TIMER0, &nuc900_timer0_irq);\r\nnuc900_clockevent_device.mult = div_sc(rate, NSEC_PER_SEC,\r\nnuc900_clockevent_device.shift);\r\nnuc900_clockevent_device.max_delta_ns = clockevent_delta2ns(0xffffffff,\r\n&nuc900_clockevent_device);\r\nnuc900_clockevent_device.min_delta_ns = clockevent_delta2ns(0xf,\r\n&nuc900_clockevent_device);\r\nnuc900_clockevent_device.cpumask = cpumask_of(0);\r\nclockevents_register_device(&nuc900_clockevent_device);\r\n}\r\nstatic void __init nuc900_clocksource_init(void)\r\n{\r\nunsigned int val;\r\nunsigned int rate;\r\nstruct clk *clk = clk_get(NULL, "timer1");\r\nBUG_ON(IS_ERR(clk));\r\n__raw_writel(0x00, REG_TCSR1);\r\nclk_enable(clk);\r\nrate = clk_get_rate(clk) / (PRESCALE + 1);\r\n__raw_writel(0xffffffff, REG_TICR1);\r\nval = __raw_readl(REG_TCSR1);\r\nval |= (COUNTEN | PERIOD | PRESCALE);\r\n__raw_writel(val, REG_TCSR1);\r\nclocksource_mmio_init(REG_TDR1, "nuc900-timer1", rate, 200,\r\nTDR_SHIFT, clocksource_mmio_readl_down);\r\n}\r\nstatic void __init nuc900_timer_init(void)\r\n{\r\nnuc900_clocksource_init();\r\nnuc900_clockevents_init();\r\n}

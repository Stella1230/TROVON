static int mantis_i2c_read(struct mantis_pci *mantis, const struct i2c_msg *msg)\r\n{\r\nu32 rxd, i, stat, trials;\r\ndprintk(MANTIS_INFO, 0, " %s: Address=[0x%02x] <R>[ ",\r\n__func__, msg->addr);\r\nfor (i = 0; i < msg->len; i++) {\r\nrxd = (msg->addr << 25) | (1 << 24)\r\n| MANTIS_I2C_RATE_3\r\n| MANTIS_I2C_STOP\r\n| MANTIS_I2C_PGMODE;\r\nif (i == (msg->len - 1))\r\nrxd &= ~MANTIS_I2C_STOP;\r\nmmwrite(MANTIS_INT_I2CDONE, MANTIS_INT_STAT);\r\nmmwrite(rxd, MANTIS_I2CDATA_CTL);\r\nfor (trials = 0; trials < TRIALS; trials++) {\r\nstat = mmread(MANTIS_INT_STAT);\r\nif (stat & MANTIS_INT_I2CDONE)\r\nbreak;\r\n}\r\ndprintk(MANTIS_TMG, 0, "I2CDONE: trials=%d\n", trials);\r\nfor (trials = 0; trials < TRIALS; trials++) {\r\nstat = mmread(MANTIS_INT_STAT);\r\nif (stat & MANTIS_INT_I2CRACK)\r\nbreak;\r\n}\r\ndprintk(MANTIS_TMG, 0, "I2CRACK: trials=%d\n", trials);\r\nrxd = mmread(MANTIS_I2CDATA_CTL);\r\nmsg->buf[i] = (u8)((rxd >> 8) & 0xFF);\r\ndprintk(MANTIS_INFO, 0, "%02x ", msg->buf[i]);\r\n}\r\ndprintk(MANTIS_INFO, 0, "]\n");\r\nreturn 0;\r\n}\r\nstatic int mantis_i2c_write(struct mantis_pci *mantis, const struct i2c_msg *msg)\r\n{\r\nint i;\r\nu32 txd = 0, stat, trials;\r\ndprintk(MANTIS_INFO, 0, " %s: Address=[0x%02x] <W>[ ",\r\n__func__, msg->addr);\r\nfor (i = 0; i < msg->len; i++) {\r\ndprintk(MANTIS_INFO, 0, "%02x ", msg->buf[i]);\r\ntxd = (msg->addr << 25) | (msg->buf[i] << 8)\r\n| MANTIS_I2C_RATE_3\r\n| MANTIS_I2C_STOP\r\n| MANTIS_I2C_PGMODE;\r\nif (i == (msg->len - 1))\r\ntxd &= ~MANTIS_I2C_STOP;\r\nmmwrite(MANTIS_INT_I2CDONE, MANTIS_INT_STAT);\r\nmmwrite(txd, MANTIS_I2CDATA_CTL);\r\nfor (trials = 0; trials < TRIALS; trials++) {\r\nstat = mmread(MANTIS_INT_STAT);\r\nif (stat & MANTIS_INT_I2CDONE)\r\nbreak;\r\n}\r\ndprintk(MANTIS_TMG, 0, "I2CDONE: trials=%d\n", trials);\r\nfor (trials = 0; trials < TRIALS; trials++) {\r\nstat = mmread(MANTIS_INT_STAT);\r\nif (stat & MANTIS_INT_I2CRACK)\r\nbreak;\r\n}\r\ndprintk(MANTIS_TMG, 0, "I2CRACK: trials=%d\n", trials);\r\n}\r\ndprintk(MANTIS_INFO, 0, "]\n");\r\nreturn 0;\r\n}\r\nstatic int mantis_i2c_xfer(struct i2c_adapter *adapter, struct i2c_msg *msgs, int num)\r\n{\r\nint ret = 0, i = 0, trials;\r\nu32 stat, data, txd;\r\nstruct mantis_pci *mantis;\r\nstruct mantis_hwconfig *config;\r\nmantis = i2c_get_adapdata(adapter);\r\nBUG_ON(!mantis);\r\nconfig = mantis->hwconfig;\r\nBUG_ON(!config);\r\ndprintk(MANTIS_DEBUG, 1, "Messages:%d", num);\r\nmutex_lock(&mantis->i2c_lock);\r\nwhile (i < num) {\r\nif ((config->i2c_mode & MANTIS_BYTE_MODE) &&\r\n((i + 1) < num) &&\r\n(msgs[i].len < 2) &&\r\n(msgs[i + 1].len < 2) &&\r\n(msgs[i + 1].flags & I2C_M_RD)) {\r\ndprintk(MANTIS_DEBUG, 0, " Byte MODE:\n");\r\ntxd = msgs[i].addr << 25 | (0x1 << 24)\r\n| (msgs[i].buf[0] << 16)\r\n| MANTIS_I2C_RATE_3;\r\nmmwrite(txd, MANTIS_I2CDATA_CTL);\r\nfor (trials = 0; trials < TRIALS; trials++) {\r\nstat = mmread(MANTIS_INT_STAT);\r\nif (stat & MANTIS_INT_I2CDONE)\r\nbreak;\r\n}\r\nif (stat & MANTIS_INT_I2CDONE) {\r\nif (stat & MANTIS_INT_I2CRACK) {\r\ndata = mmread(MANTIS_I2CDATA_CTL);\r\nmsgs[i + 1].buf[0] = (data >> 8) & 0xff;\r\ndprintk(MANTIS_DEBUG, 0, " Byte <%d> RXD=0x%02x [%02x]\n", 0x0, data, msgs[i + 1].buf[0]);\r\n} else {\r\ndprintk(MANTIS_ERROR, 1, " I/O error, LINE:%d", __LINE__);\r\nret = -EIO;\r\nbreak;\r\n}\r\n} else {\r\ndprintk(MANTIS_ERROR, 1, " I/O error, LINE:%d", __LINE__);\r\nret = -EIO;\r\nbreak;\r\n}\r\ni += 2;\r\n}\r\nif (i < num) {\r\nif (msgs[i].flags & I2C_M_RD)\r\nret = mantis_i2c_read(mantis, &msgs[i]);\r\nelse\r\nret = mantis_i2c_write(mantis, &msgs[i]);\r\ni++;\r\nif (ret < 0)\r\ngoto bail_out;\r\n}\r\n}\r\nmutex_unlock(&mantis->i2c_lock);\r\nreturn num;\r\nbail_out:\r\nmutex_unlock(&mantis->i2c_lock);\r\nreturn ret;\r\n}\r\nstatic u32 mantis_i2c_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_SMBUS_EMUL;\r\n}\r\nint __devinit mantis_i2c_init(struct mantis_pci *mantis)\r\n{\r\nu32 intstat, intmask;\r\nstruct i2c_adapter *i2c_adapter = &mantis->adapter;\r\nstruct pci_dev *pdev = mantis->pdev;\r\ninit_waitqueue_head(&mantis->i2c_wq);\r\nmutex_init(&mantis->i2c_lock);\r\nstrncpy(i2c_adapter->name, "Mantis I2C", sizeof(i2c_adapter->name));\r\ni2c_set_adapdata(i2c_adapter, mantis);\r\ni2c_adapter->owner = THIS_MODULE;\r\ni2c_adapter->algo = &mantis_algo;\r\ni2c_adapter->algo_data = NULL;\r\ni2c_adapter->timeout = 500;\r\ni2c_adapter->retries = 3;\r\ni2c_adapter->dev.parent = &pdev->dev;\r\nmantis->i2c_rc = i2c_add_adapter(i2c_adapter);\r\nif (mantis->i2c_rc < 0)\r\nreturn mantis->i2c_rc;\r\ndprintk(MANTIS_DEBUG, 1, "Initializing I2C ..");\r\nintstat = mmread(MANTIS_INT_STAT);\r\nintmask = mmread(MANTIS_INT_MASK);\r\nmmwrite(intstat, MANTIS_INT_STAT);\r\ndprintk(MANTIS_DEBUG, 1, "Disabling I2C interrupt");\r\nintmask = mmread(MANTIS_INT_MASK);\r\nmmwrite((intmask & ~MANTIS_INT_I2CDONE), MANTIS_INT_MASK);\r\nreturn 0;\r\n}\r\nint mantis_i2c_exit(struct mantis_pci *mantis)\r\n{\r\nu32 intmask;\r\ndprintk(MANTIS_DEBUG, 1, "Disabling I2C interrupt");\r\nintmask = mmread(MANTIS_INT_MASK);\r\nmmwrite((intmask & ~MANTIS_INT_I2CDONE), MANTIS_INT_MASK);\r\ndprintk(MANTIS_DEBUG, 1, "Removing I2C adapter");\r\nreturn i2c_del_adapter(&mantis->adapter);\r\n}

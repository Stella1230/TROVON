static u_char dummyrr(struct IsdnCardState *cs, int chan, u_char off)\r\n{\r\nreturn (5);\r\n}\r\nstatic void dummywr(struct IsdnCardState *cs, int chan, u_char off, u_char value)\r\n{\r\n}\r\nstatic irqreturn_t\r\nnetjet_s_interrupt(int intno, void *dev_id)\r\n{\r\nstruct IsdnCardState *cs = dev_id;\r\nu_char val, s1val, s0val;\r\nu_long flags;\r\nspin_lock_irqsave(&cs->lock, flags);\r\ns1val = bytein(cs->hw.njet.base + NETJET_IRQSTAT1);\r\nif (!(s1val & NETJET_ISACIRQ)) {\r\nval = NETjet_ReadIC(cs, ISAC_ISTA);\r\nif (cs->debug & L1_DEB_ISAC)\r\ndebugl1(cs, "tiger: i1 %x %x", s1val, val);\r\nif (val) {\r\nisac_interrupt(cs, val);\r\nNETjet_WriteIC(cs, ISAC_MASK, 0xFF);\r\nNETjet_WriteIC(cs, ISAC_MASK, 0x0);\r\n}\r\ns1val = 1;\r\n} else\r\ns1val = 0;\r\ns0val = bytein(cs->hw.njet.base + NETJET_IRQSTAT0);\r\nif ((s0val | s1val) == 0) {\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_NONE;\r\n}\r\nif (s0val)\r\nbyteout(cs->hw.njet.base + NETJET_IRQSTAT0, s0val);\r\nif (inl(cs->hw.njet.base + NETJET_DMA_WRITE_ADR) <\r\ninl(cs->hw.njet.base + NETJET_DMA_WRITE_IRQ))\r\ns0val = 0x08;\r\nelse\r\ns0val = 0x04;\r\nif (inl(cs->hw.njet.base + NETJET_DMA_READ_ADR) <\r\ninl(cs->hw.njet.base + NETJET_DMA_READ_IRQ))\r\ns0val |= 0x02;\r\nelse\r\ns0val |= 0x01;\r\nif (s0val != cs->hw.njet.last_is0)\r\n{\r\nif (test_and_set_bit(FLG_LOCK_ATOMIC, &cs->HW_Flags)) {\r\nprintk(KERN_WARNING "nj LOCK_ATOMIC s0val %x->%x\n",\r\ncs->hw.njet.last_is0, s0val);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\ncs->hw.njet.irqstat0 = s0val;\r\nif ((cs->hw.njet.irqstat0 & NETJET_IRQM0_READ) !=\r\n(cs->hw.njet.last_is0 & NETJET_IRQM0_READ))\r\nread_tiger(cs);\r\nif ((cs->hw.njet.irqstat0 & NETJET_IRQM0_WRITE) !=\r\n(cs->hw.njet.last_is0 & NETJET_IRQM0_WRITE))\r\nwrite_tiger(cs);\r\ntest_and_clear_bit(FLG_LOCK_ATOMIC, &cs->HW_Flags);\r\n}\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void\r\nreset_netjet_s(struct IsdnCardState *cs)\r\n{\r\ncs->hw.njet.ctrl_reg = 0xff;\r\nbyteout(cs->hw.njet.base + NETJET_CTRL, cs->hw.njet.ctrl_reg);\r\nmdelay(10);\r\nif (cs->subtyp)\r\ncs->hw.njet.ctrl_reg = 0x40;\r\nelse\r\ncs->hw.njet.ctrl_reg = 0x00;\r\nbyteout(cs->hw.njet.base + NETJET_CTRL, cs->hw.njet.ctrl_reg);\r\nmdelay(10);\r\ncs->hw.njet.auxd = 0;\r\ncs->hw.njet.dmactrl = 0;\r\nbyteout(cs->hw.njet.base + NETJET_AUXCTRL, ~NETJET_ISACIRQ);\r\nbyteout(cs->hw.njet.base + NETJET_IRQMASK1, NETJET_ISACIRQ);\r\nbyteout(cs->hw.njet.auxa, cs->hw.njet.auxd);\r\n}\r\nstatic int\r\nNETjet_S_card_msg(struct IsdnCardState *cs, int mt, void *arg)\r\n{\r\nu_long flags;\r\nswitch (mt) {\r\ncase CARD_RESET:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nreset_netjet_s(cs);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn (0);\r\ncase CARD_RELEASE:\r\nrelease_io_netjet(cs);\r\nreturn (0);\r\ncase CARD_INIT:\r\nreset_netjet_s(cs);\r\ninittiger(cs);\r\nspin_lock_irqsave(&cs->lock, flags);\r\nclear_pending_isac_ints(cs);\r\ninitisac(cs);\r\ncs->writeisac(cs, ISAC_MASK, 0);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn (0);\r\ncase CARD_TEST:\r\nreturn (0);\r\n}\r\nreturn (0);\r\n}\r\nstatic int __devinit njs_pci_probe(struct pci_dev *dev_netjet,\r\nstruct IsdnCardState *cs)\r\n{\r\nu32 cfg;\r\nif (pci_enable_device(dev_netjet))\r\nreturn (0);\r\npci_set_master(dev_netjet);\r\ncs->irq = dev_netjet->irq;\r\nif (!cs->irq) {\r\nprintk(KERN_WARNING "NETjet-S: No IRQ for PCI card found\n");\r\nreturn (0);\r\n}\r\ncs->hw.njet.base = pci_resource_start(dev_netjet, 0);\r\nif (!cs->hw.njet.base) {\r\nprintk(KERN_WARNING "NETjet-S: No IO-Adr for PCI card found\n");\r\nreturn (0);\r\n}\r\npci_read_config_dword(dev_netjet, 0x04, &cfg);\r\nif (cfg & 0x00100000)\r\ncs->subtyp = 1;\r\nelse\r\ncs->subtyp = 0;\r\nif ((dev_netjet->subsystem_vendor == 0x55) &&\r\n(dev_netjet->subsystem_device == 0x02)) {\r\nprintk(KERN_WARNING "Netjet: You tried to load this driver with an incompatible TigerJet-card\n");\r\nprintk(KERN_WARNING "Use type=41 for Formula-n enter:now ISDN PCI and compatible\n");\r\nreturn (0);\r\n}\r\nreturn (1);\r\n}\r\nstatic int __devinit njs_cs_init(struct IsdnCard *card,\r\nstruct IsdnCardState *cs)\r\n{\r\ncs->hw.njet.auxa = cs->hw.njet.base + NETJET_AUXDATA;\r\ncs->hw.njet.isac = cs->hw.njet.base | NETJET_ISAC_OFF;\r\ncs->hw.njet.ctrl_reg = 0xff;\r\nbyteout(cs->hw.njet.base + NETJET_CTRL, cs->hw.njet.ctrl_reg);\r\nmdelay(10);\r\ncs->hw.njet.ctrl_reg = 0x00;\r\nbyteout(cs->hw.njet.base + NETJET_CTRL, cs->hw.njet.ctrl_reg);\r\nmdelay(10);\r\ncs->hw.njet.auxd = 0xC0;\r\ncs->hw.njet.dmactrl = 0;\r\nbyteout(cs->hw.njet.base + NETJET_AUXCTRL, ~NETJET_ISACIRQ);\r\nbyteout(cs->hw.njet.base + NETJET_IRQMASK1, NETJET_ISACIRQ);\r\nbyteout(cs->hw.njet.auxa, cs->hw.njet.auxd);\r\nswitch (((NETjet_ReadIC(cs, ISAC_RBCH) >> 5) & 3))\r\n{\r\ncase 0:\r\nreturn 1;\r\ncase 3:\r\nprintk(KERN_WARNING "NETjet-S: NETspider-U PCI card found\n");\r\nreturn -1;\r\ndefault:\r\nprintk(KERN_WARNING "NETjet-S: No PCI card found\n");\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int __devinit njs_cs_init_rest(struct IsdnCard *card,\r\nstruct IsdnCardState *cs)\r\n{\r\nconst int bytecnt = 256;\r\nprintk(KERN_INFO\r\n"NETjet-S: %s card configured at %#lx IRQ %d\n",\r\ncs->subtyp ? "TJ320" : "TJ300", cs->hw.njet.base, cs->irq);\r\nif (!request_region(cs->hw.njet.base, bytecnt, "netjet-s isdn")) {\r\nprintk(KERN_WARNING\r\n"HiSax: NETjet-S config port %#lx-%#lx already in use\n",\r\ncs->hw.njet.base,\r\ncs->hw.njet.base + bytecnt);\r\nreturn (0);\r\n}\r\ncs->readisac = &NETjet_ReadIC;\r\ncs->writeisac = &NETjet_WriteIC;\r\ncs->readisacfifo = &NETjet_ReadICfifo;\r\ncs->writeisacfifo = &NETjet_WriteICfifo;\r\ncs->BC_Read_Reg = &dummyrr;\r\ncs->BC_Write_Reg = &dummywr;\r\ncs->BC_Send_Data = &netjet_fill_dma;\r\nsetup_isac(cs);\r\ncs->cardmsg = &NETjet_S_card_msg;\r\ncs->irq_func = &netjet_s_interrupt;\r\ncs->irq_flags |= IRQF_SHARED;\r\nISACVersion(cs, "NETjet-S:");\r\nreturn (1);\r\n}\r\nint __devinit\r\nsetup_netjet_s(struct IsdnCard *card)\r\n{\r\nint ret;\r\nstruct IsdnCardState *cs = card->cs;\r\nchar tmp[64];\r\n#ifdef __BIG_ENDIAN\r\n#error "not running on big endian machines now"\r\n#endif\r\nstrcpy(tmp, NETjet_S_revision);\r\nprintk(KERN_INFO "HiSax: Traverse Tech. NETjet-S driver Rev. %s\n", HiSax_getrev(tmp));\r\nif (cs->typ != ISDN_CTYPE_NETJET_S)\r\nreturn (0);\r\ntest_and_clear_bit(FLG_LOCK_ATOMIC, &cs->HW_Flags);\r\nfor (;;)\r\n{\r\nif ((dev_netjet = hisax_find_pci_device(PCI_VENDOR_ID_TIGERJET,\r\nPCI_DEVICE_ID_TIGERJET_300, dev_netjet))) {\r\nret = njs_pci_probe(dev_netjet, cs);\r\nif (!ret)\r\nreturn (0);\r\n} else {\r\nprintk(KERN_WARNING "NETjet-S: No PCI card found\n");\r\nreturn (0);\r\n}\r\nret = njs_cs_init(card, cs);\r\nif (!ret)\r\nreturn (0);\r\nif (ret > 0)\r\nbreak;\r\n}\r\nreturn njs_cs_init_rest(card, cs);\r\n}

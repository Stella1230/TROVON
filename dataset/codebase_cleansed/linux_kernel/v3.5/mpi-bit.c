void mpi_normalize(MPI a)\r\n{\r\nfor (; a->nlimbs && !a->d[a->nlimbs - 1]; a->nlimbs--)\r\n;\r\n}\r\nunsigned mpi_get_nbits(MPI a)\r\n{\r\nunsigned n;\r\nmpi_normalize(a);\r\nif (a->nlimbs) {\r\nmpi_limb_t alimb = a->d[a->nlimbs - 1];\r\nif (alimb)\r\ncount_leading_zeros(n, alimb);\r\nelse\r\nn = BITS_PER_MPI_LIMB;\r\nn = BITS_PER_MPI_LIMB - n + (a->nlimbs - 1) * BITS_PER_MPI_LIMB;\r\n} else\r\nn = 0;\r\nreturn n;\r\n}\r\nint mpi_test_bit(MPI a, unsigned n)\r\n{\r\nunsigned limbno, bitno;\r\nmpi_limb_t limb;\r\nlimbno = n / BITS_PER_MPI_LIMB;\r\nbitno = n % BITS_PER_MPI_LIMB;\r\nif (limbno >= a->nlimbs)\r\nreturn 0;\r\nlimb = a->d[limbno];\r\nreturn (limb & (A_LIMB_1 << bitno)) ? 1 : 0;\r\n}\r\nint mpi_set_bit(MPI a, unsigned n)\r\n{\r\nunsigned limbno, bitno;\r\nlimbno = n / BITS_PER_MPI_LIMB;\r\nbitno = n % BITS_PER_MPI_LIMB;\r\nif (limbno >= a->nlimbs) {\r\nif (a->alloced >= limbno)\r\nif (mpi_resize(a, limbno + 1) < 0)\r\nreturn -ENOMEM;\r\na->nlimbs = limbno + 1;\r\n}\r\na->d[limbno] |= (A_LIMB_1 << bitno);\r\nreturn 0;\r\n}\r\nint mpi_set_highbit(MPI a, unsigned n)\r\n{\r\nunsigned limbno, bitno;\r\nlimbno = n / BITS_PER_MPI_LIMB;\r\nbitno = n % BITS_PER_MPI_LIMB;\r\nif (limbno >= a->nlimbs) {\r\nif (a->alloced >= limbno)\r\nif (mpi_resize(a, limbno + 1) < 0)\r\nreturn -ENOMEM;\r\na->nlimbs = limbno + 1;\r\n}\r\na->d[limbno] |= (A_LIMB_1 << bitno);\r\nfor (bitno++; bitno < BITS_PER_MPI_LIMB; bitno++)\r\na->d[limbno] &= ~(A_LIMB_1 << bitno);\r\na->nlimbs = limbno + 1;\r\nreturn 0;\r\n}\r\nvoid mpi_clear_highbit(MPI a, unsigned n)\r\n{\r\nunsigned limbno, bitno;\r\nlimbno = n / BITS_PER_MPI_LIMB;\r\nbitno = n % BITS_PER_MPI_LIMB;\r\nif (limbno >= a->nlimbs)\r\nreturn;\r\nfor (; bitno < BITS_PER_MPI_LIMB; bitno++)\r\na->d[limbno] &= ~(A_LIMB_1 << bitno);\r\na->nlimbs = limbno + 1;\r\n}\r\nvoid mpi_clear_bit(MPI a, unsigned n)\r\n{\r\nunsigned limbno, bitno;\r\nlimbno = n / BITS_PER_MPI_LIMB;\r\nbitno = n % BITS_PER_MPI_LIMB;\r\nif (limbno >= a->nlimbs)\r\nreturn;\r\na->d[limbno] &= ~(A_LIMB_1 << bitno);\r\n}\r\nint mpi_rshift(MPI x, MPI a, unsigned n)\r\n{\r\nmpi_ptr_t xp;\r\nmpi_size_t xsize;\r\nxsize = a->nlimbs;\r\nx->sign = a->sign;\r\nif (RESIZE_IF_NEEDED(x, (size_t) xsize) < 0)\r\nreturn -ENOMEM;\r\nxp = x->d;\r\nif (xsize) {\r\nmpihelp_rshift(xp, a->d, xsize, n);\r\nMPN_NORMALIZE(xp, xsize);\r\n}\r\nx->nlimbs = xsize;\r\nreturn 0;\r\n}\r\nint mpi_lshift_limbs(MPI a, unsigned int count)\r\n{\r\nconst int n = a->nlimbs;\r\nmpi_ptr_t ap;\r\nint i;\r\nif (!count || !n)\r\nreturn 0;\r\nif (RESIZE_IF_NEEDED(a, n + count) < 0)\r\nreturn -ENOMEM;\r\nap = a->d;\r\nfor (i = n - 1; i >= 0; i--)\r\nap[i + count] = ap[i];\r\nfor (i = 0; i < count; i++)\r\nap[i] = 0;\r\na->nlimbs += count;\r\nreturn 0;\r\n}\r\nvoid mpi_rshift_limbs(MPI a, unsigned int count)\r\n{\r\nmpi_ptr_t ap = a->d;\r\nmpi_size_t n = a->nlimbs;\r\nunsigned int i;\r\nif (count >= n) {\r\na->nlimbs = 0;\r\nreturn;\r\n}\r\nfor (i = 0; i < n - count; i++)\r\nap[i] = ap[i + count];\r\nap[i] = 0;\r\na->nlimbs -= count;\r\n}

static ssize_t evm_read_key(struct file *filp, char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nchar temp[80];\r\nssize_t rc;\r\nif (*ppos != 0)\r\nreturn 0;\r\nsprintf(temp, "%d", evm_initialized);\r\nrc = simple_read_from_buffer(buf, count, ppos, temp, strlen(temp));\r\nreturn rc;\r\n}\r\nstatic ssize_t evm_write_key(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nchar temp[80];\r\nint i, error;\r\nif (!capable(CAP_SYS_ADMIN) || evm_initialized)\r\nreturn -EPERM;\r\nif (count >= sizeof(temp) || count == 0)\r\nreturn -EINVAL;\r\nif (copy_from_user(temp, buf, count) != 0)\r\nreturn -EFAULT;\r\ntemp[count] = '\0';\r\nif ((sscanf(temp, "%d", &i) != 1) || (i != 1))\r\nreturn -EINVAL;\r\nerror = evm_init_key();\r\nif (!error) {\r\nevm_initialized = 1;\r\npr_info("EVM: initialized\n");\r\n} else\r\npr_err("EVM: initialization failed\n");\r\nreturn count;\r\n}\r\nint __init evm_init_secfs(void)\r\n{\r\nint error = 0;\r\nevm_init_tpm = securityfs_create_file("evm", S_IRUSR | S_IRGRP,\r\nNULL, NULL, &evm_key_ops);\r\nif (!evm_init_tpm || IS_ERR(evm_init_tpm))\r\nerror = -EFAULT;\r\nreturn error;\r\n}\r\nvoid __exit evm_cleanup_secfs(void)\r\n{\r\nif (evm_init_tpm)\r\nsecurityfs_remove(evm_init_tpm);\r\n}

void rmt_init(struct s_smc *smc)\r\n{\r\nsmc->mib.m[MAC0].fddiMACRMTState = ACTIONS(RM0_ISOLATED) ;\r\nsmc->r.dup_addr_test = DA_NONE ;\r\nsmc->r.da_flag = 0 ;\r\nsmc->mib.m[MAC0].fddiMACMA_UnitdataAvailable = FALSE ;\r\nsmc->r.sm_ma_avail = FALSE ;\r\nsmc->r.loop_avail = 0 ;\r\nsmc->r.bn_flag = 0 ;\r\nsmc->r.jm_flag = 0 ;\r\nsmc->r.no_flag = TRUE ;\r\n}\r\nvoid rmt(struct s_smc *smc, int event)\r\n{\r\nint state ;\r\ndo {\r\nDB_RMT("RMT : state %s%s",\r\n(smc->mib.m[MAC0].fddiMACRMTState & AFLAG) ? "ACTIONS " : "",\r\nrmt_states[smc->mib.m[MAC0].fddiMACRMTState & ~AFLAG]) ;\r\nDB_RMT(" event %s\n",rmt_events[event],0) ;\r\nstate = smc->mib.m[MAC0].fddiMACRMTState ;\r\nrmt_fsm(smc,event) ;\r\nevent = 0 ;\r\n} while (state != smc->mib.m[MAC0].fddiMACRMTState) ;\r\nrmt_state_change(smc,(int)smc->mib.m[MAC0].fddiMACRMTState) ;\r\n}\r\nstatic void rmt_fsm(struct s_smc *smc, int cmd)\r\n{\r\nif (!smc->r.rm_join && !smc->r.rm_loop &&\r\nsmc->mib.m[MAC0].fddiMACRMTState != ACTIONS(RM0_ISOLATED) &&\r\nsmc->mib.m[MAC0].fddiMACRMTState != RM0_ISOLATED) {\r\nRS_SET(smc,RS_NORINGOP) ;\r\nrmt_indication(smc,0) ;\r\nGO_STATE(RM0_ISOLATED) ;\r\nreturn ;\r\n}\r\nswitch(smc->mib.m[MAC0].fddiMACRMTState) {\r\ncase ACTIONS(RM0_ISOLATED) :\r\nstop_rmt_timer0(smc) ;\r\nstop_rmt_timer1(smc) ;\r\nstop_rmt_timer2(smc) ;\r\nsm_ma_control(smc,MA_OFFLINE) ;\r\nsmc->mib.m[MAC0].fddiMACMA_UnitdataAvailable = FALSE ;\r\nsmc->r.loop_avail = FALSE ;\r\nsmc->r.sm_ma_avail = FALSE ;\r\nsmc->r.no_flag = TRUE ;\r\nDB_RMTN(1,"RMT : ISOLATED\n",0,0) ;\r\nACTIONS_DONE() ;\r\nbreak ;\r\ncase RM0_ISOLATED :\r\nif (smc->r.rm_join || smc->r.rm_loop) {\r\nsm_ma_control(smc,MA_RESET) ;\r\nGO_STATE(RM1_NON_OP) ;\r\nbreak ;\r\n}\r\nbreak ;\r\ncase ACTIONS(RM1_NON_OP) :\r\nstart_rmt_timer0(smc,smc->s.rmt_t_non_op,RM_TIMEOUT_NON_OP) ;\r\nstop_rmt_timer1(smc) ;\r\nstop_rmt_timer2(smc) ;\r\nsm_ma_control(smc,MA_BEACON) ;\r\nDB_RMTN(1,"RMT : RING DOWN\n",0,0) ;\r\nRS_SET(smc,RS_NORINGOP) ;\r\nsmc->r.sm_ma_avail = FALSE ;\r\nrmt_indication(smc,0) ;\r\nACTIONS_DONE() ;\r\nbreak ;\r\ncase RM1_NON_OP :\r\nif (cmd == RM_RING_OP) {\r\nRS_SET(smc,RS_RINGOPCHANGE) ;\r\nGO_STATE(RM2_RING_OP) ;\r\nbreak ;\r\n}\r\nelse if (cmd == RM_TIMEOUT_NON_OP) {\r\nsmc->r.bn_flag = FALSE ;\r\nsmc->r.no_flag = TRUE ;\r\nGO_STATE(RM3_DETECT) ;\r\nbreak ;\r\n}\r\nbreak ;\r\ncase ACTIONS(RM2_RING_OP) :\r\nstop_rmt_timer0(smc) ;\r\nstop_rmt_timer1(smc) ;\r\nstop_rmt_timer2(smc) ;\r\nsmc->r.no_flag = FALSE ;\r\nif (smc->r.rm_loop)\r\nsmc->r.loop_avail = TRUE ;\r\nif (smc->r.rm_join) {\r\nsmc->r.sm_ma_avail = TRUE ;\r\nif (smc->mib.m[MAC0].fddiMACMA_UnitdataEnable)\r\nsmc->mib.m[MAC0].fddiMACMA_UnitdataAvailable = TRUE ;\r\nelse\r\nsmc->mib.m[MAC0].fddiMACMA_UnitdataAvailable = FALSE ;\r\n}\r\nDB_RMTN(1,"RMT : RING UP\n",0,0) ;\r\nRS_CLEAR(smc,RS_NORINGOP) ;\r\nRS_SET(smc,RS_RINGOPCHANGE) ;\r\nrmt_indication(smc,1) ;\r\nsmt_stat_counter(smc,0) ;\r\nACTIONS_DONE() ;\r\nbreak ;\r\ncase RM2_RING_OP :\r\nif (cmd == RM_RING_NON_OP) {\r\nsmc->mib.m[MAC0].fddiMACMA_UnitdataAvailable = FALSE ;\r\nsmc->r.loop_avail = FALSE ;\r\nRS_SET(smc,RS_RINGOPCHANGE) ;\r\nGO_STATE(RM1_NON_OP) ;\r\nbreak ;\r\n}\r\nelse if (cmd == RM_ENABLE_FLAG) {\r\nif (smc->mib.m[MAC0].fddiMACMA_UnitdataEnable)\r\nsmc->mib.m[MAC0].fddiMACMA_UnitdataAvailable = TRUE ;\r\nelse\r\nsmc->mib.m[MAC0].fddiMACMA_UnitdataAvailable = FALSE ;\r\n}\r\nelse if (smc->r.dup_addr_test == DA_FAILED) {\r\nsmc->mib.m[MAC0].fddiMACMA_UnitdataAvailable = FALSE ;\r\nsmc->r.loop_avail = FALSE ;\r\nsmc->r.da_flag = TRUE ;\r\nGO_STATE(RM5_RING_OP_DUP) ;\r\nbreak ;\r\n}\r\nbreak ;\r\ncase ACTIONS(RM3_DETECT) :\r\nstart_rmt_timer0(smc,smc->s.mac_d_max*2,RM_TIMEOUT_D_MAX) ;\r\nstart_rmt_timer1(smc,smc->s.rmt_t_stuck,RM_TIMEOUT_T_STUCK) ;\r\nstart_rmt_timer2(smc,smc->s.rmt_t_poll,RM_TIMEOUT_POLL) ;\r\nsm_mac_check_beacon_claim(smc) ;\r\nDB_RMTN(1,"RMT : RM3_DETECT\n",0,0) ;\r\nACTIONS_DONE() ;\r\nbreak ;\r\ncase RM3_DETECT :\r\nif (cmd == RM_TIMEOUT_POLL) {\r\nstart_rmt_timer2(smc,smc->s.rmt_t_poll,RM_TIMEOUT_POLL);\r\nsm_mac_check_beacon_claim(smc) ;\r\nbreak ;\r\n}\r\nif (cmd == RM_TIMEOUT_D_MAX) {\r\nsmc->r.timer0_exp = TRUE ;\r\n}\r\nif (cmd == RM_TX_STATE_CHANGE) {\r\nstart_rmt_timer0(smc,\r\nsmc->s.mac_d_max*2,\r\nRM_TIMEOUT_D_MAX) ;\r\n}\r\nif (cmd == RM_RING_OP) {\r\nGO_STATE(RM2_RING_OP) ;\r\nbreak ;\r\n}\r\nelse if ((cmd == RM_MY_BEACON || cmd == RM_OTHER_BEACON)\r\n&& smc->r.bn_flag) {\r\nsmc->r.bn_flag = FALSE ;\r\n}\r\nelse if (cmd == RM_TRT_EXP && !smc->r.bn_flag) {\r\nint tx ;\r\nif ((tx = sm_mac_get_tx_state(smc)) == 4 || tx == 5) {\r\nDB_RMTN(2,"RMT : DETECT && TRT_EXPIRED && T4/T5\n",0,0);\r\nsmc->r.bn_flag = TRUE ;\r\nstart_rmt_timer1(smc,smc->s.rmt_t_stuck,\r\nRM_TIMEOUT_T_STUCK) ;\r\n}\r\nDB_RMTN(2,\r\n"RMT : sm_mac_get_tx_state() = %d (bn_flag = %d)\n",\r\ntx,smc->r.bn_flag) ;\r\n}\r\nelse if (cmd == RM_MY_CLAIM && smc->r.timer0_exp) {\r\nrmt_new_dup_actions(smc) ;\r\nGO_STATE(RM4_NON_OP_DUP) ;\r\nbreak ;\r\n}\r\nelse if (cmd == RM_MY_BEACON && smc->r.timer0_exp) {\r\nrmt_new_dup_actions(smc) ;\r\nGO_STATE(RM4_NON_OP_DUP) ;\r\nbreak ;\r\n}\r\nelse if (cmd == RM_VALID_CLAIM) {\r\nrmt_new_dup_actions(smc) ;\r\nGO_STATE(RM4_NON_OP_DUP) ;\r\nbreak ;\r\n}\r\nelse if (cmd == RM_TIMEOUT_T_STUCK &&\r\nsmc->r.rm_join && smc->r.bn_flag) {\r\nGO_STATE(RM6_DIRECTED) ;\r\nbreak ;\r\n}\r\nbreak ;\r\ncase ACTIONS(RM4_NON_OP_DUP) :\r\nstart_rmt_timer0(smc,smc->s.rmt_t_announce,RM_TIMEOUT_ANNOUNCE);\r\nstart_rmt_timer1(smc,smc->s.rmt_t_stuck,RM_TIMEOUT_T_STUCK) ;\r\nstart_rmt_timer2(smc,smc->s.rmt_t_poll,RM_TIMEOUT_POLL) ;\r\nsm_mac_check_beacon_claim(smc) ;\r\nDB_RMTN(1,"RMT : RM4_NON_OP_DUP\n",0,0) ;\r\nACTIONS_DONE() ;\r\nbreak ;\r\ncase RM4_NON_OP_DUP :\r\nif (cmd == RM_TIMEOUT_POLL) {\r\nstart_rmt_timer2(smc,smc->s.rmt_t_poll,RM_TIMEOUT_POLL);\r\nsm_mac_check_beacon_claim(smc) ;\r\nbreak ;\r\n}\r\nif (!smc->r.da_flag) {\r\nGO_STATE(RM1_NON_OP) ;\r\nbreak ;\r\n}\r\nelse if ((cmd == RM_MY_BEACON || cmd == RM_OTHER_BEACON) &&\r\nsmc->r.bn_flag) {\r\nsmc->r.bn_flag = FALSE ;\r\n}\r\nelse if (cmd == RM_TRT_EXP && !smc->r.bn_flag) {\r\nint tx ;\r\nif ((tx = sm_mac_get_tx_state(smc)) == 4 || tx == 5) {\r\nDB_RMTN(2,"RMT : NOPDUP && TRT_EXPIRED && T4/T5\n",0,0);\r\nsmc->r.bn_flag = TRUE ;\r\nstart_rmt_timer1(smc,smc->s.rmt_t_stuck,\r\nRM_TIMEOUT_T_STUCK) ;\r\n}\r\nDB_RMTN(2,\r\n"RMT : sm_mac_get_tx_state() = %d (bn_flag = %d)\n",\r\ntx,smc->r.bn_flag) ;\r\n}\r\nelse if (cmd == RM_TIMEOUT_ANNOUNCE && !smc->r.bn_flag) {\r\nrmt_dup_actions(smc) ;\r\n}\r\nelse if (cmd == RM_RING_OP) {\r\nsmc->r.no_flag = FALSE ;\r\nGO_STATE(RM5_RING_OP_DUP) ;\r\nbreak ;\r\n}\r\nelse if (cmd == RM_TIMEOUT_T_STUCK &&\r\nsmc->r.rm_join && smc->r.bn_flag) {\r\nGO_STATE(RM6_DIRECTED) ;\r\nbreak ;\r\n}\r\nbreak ;\r\ncase ACTIONS(RM5_RING_OP_DUP) :\r\nstop_rmt_timer0(smc) ;\r\nstop_rmt_timer1(smc) ;\r\nstop_rmt_timer2(smc) ;\r\nDB_RMTN(1,"RMT : RM5_RING_OP_DUP\n",0,0) ;\r\nACTIONS_DONE() ;\r\nbreak;\r\ncase RM5_RING_OP_DUP :\r\nif (smc->r.dup_addr_test == DA_PASSED) {\r\nsmc->r.da_flag = FALSE ;\r\nGO_STATE(RM2_RING_OP) ;\r\nbreak ;\r\n}\r\nelse if (cmd == RM_RING_NON_OP) {\r\nsmc->r.jm_flag = FALSE ;\r\nsmc->r.bn_flag = FALSE ;\r\nGO_STATE(RM4_NON_OP_DUP) ;\r\nbreak ;\r\n}\r\nbreak ;\r\ncase ACTIONS(RM6_DIRECTED) :\r\nstart_rmt_timer0(smc,smc->s.rmt_t_direct,RM_TIMEOUT_T_DIRECT) ;\r\nstop_rmt_timer1(smc) ;\r\nstart_rmt_timer2(smc,smc->s.rmt_t_poll,RM_TIMEOUT_POLL) ;\r\nsm_ma_control(smc,MA_DIRECTED) ;\r\nRS_SET(smc,RS_BEACON) ;\r\nDB_RMTN(1,"RMT : RM6_DIRECTED\n",0,0) ;\r\nACTIONS_DONE() ;\r\nbreak ;\r\ncase RM6_DIRECTED :\r\nif (cmd == RM_TIMEOUT_POLL) {\r\nstart_rmt_timer2(smc,smc->s.rmt_t_poll,RM_TIMEOUT_POLL);\r\nsm_mac_check_beacon_claim(smc) ;\r\n#ifndef SUPERNET_3\r\nrestart_trt_for_dbcn(smc) ;\r\n#endif\r\nbreak ;\r\n}\r\nif ((cmd == RM_MY_BEACON || cmd == RM_OTHER_BEACON) &&\r\n!smc->r.da_flag) {\r\nsmc->r.bn_flag = FALSE ;\r\nGO_STATE(RM3_DETECT) ;\r\nbreak ;\r\n}\r\nelse if ((cmd == RM_MY_BEACON || cmd == RM_OTHER_BEACON) &&\r\nsmc->r.da_flag) {\r\nsmc->r.bn_flag = FALSE ;\r\nGO_STATE(RM4_NON_OP_DUP) ;\r\nbreak ;\r\n}\r\nelse if (cmd == RM_TIMEOUT_T_DIRECT) {\r\nGO_STATE(RM7_TRACE) ;\r\nbreak ;\r\n}\r\nbreak ;\r\ncase ACTIONS(RM7_TRACE) :\r\nstop_rmt_timer0(smc) ;\r\nstop_rmt_timer1(smc) ;\r\nstop_rmt_timer2(smc) ;\r\nsmc->e.trace_prop |= ENTITY_BIT(ENTITY_MAC) ;\r\nqueue_event(smc,EVENT_ECM,EC_TRACE_PROP) ;\r\nDB_RMTN(1,"RMT : RM7_TRACE\n",0,0) ;\r\nACTIONS_DONE() ;\r\nbreak ;\r\ncase RM7_TRACE :\r\nbreak ;\r\ndefault:\r\nSMT_PANIC(smc,SMT_E0122, SMT_E0122_MSG) ;\r\nbreak;\r\n}\r\n}\r\nstatic void rmt_dup_actions(struct s_smc *smc)\r\n{\r\nif (smc->r.jm_flag) {\r\n}\r\nelse {\r\nif (smc->s.rmt_dup_mac_behavior) {\r\nSMT_ERR_LOG(smc,SMT_E0138, SMT_E0138_MSG) ;\r\nrmt_reinsert_actions(smc) ;\r\n}\r\nelse {\r\nSMT_ERR_LOG(smc,SMT_E0135, SMT_E0135_MSG) ;\r\nrmt_leave_actions(smc) ;\r\n}\r\n}\r\n}\r\nstatic void rmt_reinsert_actions(struct s_smc *smc)\r\n{\r\nqueue_event(smc,EVENT_ECM,EC_DISCONNECT) ;\r\nqueue_event(smc,EVENT_ECM,EC_CONNECT) ;\r\n}\r\nstatic void rmt_new_dup_actions(struct s_smc *smc)\r\n{\r\nsmc->r.da_flag = TRUE ;\r\nsmc->r.bn_flag = FALSE ;\r\nsmc->r.jm_flag = FALSE ;\r\nif (smc->s.rmt_dup_mac_behavior) {\r\nSMT_ERR_LOG(smc,SMT_E0138, SMT_E0138_MSG) ;\r\nrmt_reinsert_actions(smc) ;\r\n}\r\nelse {\r\nSMT_ERR_LOG(smc,SMT_E0135, SMT_E0135_MSG) ;\r\nrmt_leave_actions(smc) ;\r\n}\r\n}\r\nstatic void rmt_leave_actions(struct s_smc *smc)\r\n{\r\nqueue_event(smc,EVENT_ECM,EC_DISCONNECT) ;\r\n}\r\nstatic void start_rmt_timer0(struct s_smc *smc, u_long value, int event)\r\n{\r\nsmc->r.timer0_exp = FALSE ;\r\nsmt_timer_start(smc,&smc->r.rmt_timer0,value,EV_TOKEN(EVENT_RMT,event));\r\n}\r\nstatic void start_rmt_timer1(struct s_smc *smc, u_long value, int event)\r\n{\r\nsmc->r.timer1_exp = FALSE ;\r\nsmt_timer_start(smc,&smc->r.rmt_timer1,value,EV_TOKEN(EVENT_RMT,event));\r\n}\r\nstatic void start_rmt_timer2(struct s_smc *smc, u_long value, int event)\r\n{\r\nsmc->r.timer2_exp = FALSE ;\r\nsmt_timer_start(smc,&smc->r.rmt_timer2,value,EV_TOKEN(EVENT_RMT,event));\r\n}\r\nstatic void stop_rmt_timer0(struct s_smc *smc)\r\n{\r\nif (smc->r.rmt_timer0.tm_active)\r\nsmt_timer_stop(smc,&smc->r.rmt_timer0) ;\r\n}\r\nstatic void stop_rmt_timer1(struct s_smc *smc)\r\n{\r\nif (smc->r.rmt_timer1.tm_active)\r\nsmt_timer_stop(smc,&smc->r.rmt_timer1) ;\r\n}\r\nstatic void stop_rmt_timer2(struct s_smc *smc)\r\n{\r\nif (smc->r.rmt_timer2.tm_active)\r\nsmt_timer_stop(smc,&smc->r.rmt_timer2) ;\r\n}

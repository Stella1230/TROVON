static void mxc_expio_irq_handler(u32 irq, struct irq_desc *desc)\r\n{\r\nu32 imr_val;\r\nu32 int_valid;\r\nu32 expio_irq;\r\ndesc->irq_data.chip->irq_mask(&desc->irq_data);\r\nimr_val = __raw_readw(brd_io + INTR_MASK_REG);\r\nint_valid = __raw_readw(brd_io + INTR_STATUS_REG) & ~imr_val;\r\nexpio_irq = MXC_BOARD_IRQ_START;\r\nfor (; int_valid != 0; int_valid >>= 1, expio_irq++) {\r\nif ((int_valid & 1) == 0)\r\ncontinue;\r\ngeneric_handle_irq(expio_irq);\r\n}\r\ndesc->irq_data.chip->irq_ack(&desc->irq_data);\r\ndesc->irq_data.chip->irq_unmask(&desc->irq_data);\r\n}\r\nstatic void expio_mask_irq(struct irq_data *d)\r\n{\r\nu16 reg;\r\nu32 expio = MXC_IRQ_TO_EXPIO(d->irq);\r\nreg = __raw_readw(brd_io + INTR_MASK_REG);\r\nreg |= (1 << expio);\r\n__raw_writew(reg, brd_io + INTR_MASK_REG);\r\n}\r\nstatic void expio_ack_irq(struct irq_data *d)\r\n{\r\nu32 expio = MXC_IRQ_TO_EXPIO(d->irq);\r\n__raw_writew(1 << expio, brd_io + INTR_RESET_REG);\r\n__raw_writew(0, brd_io + INTR_RESET_REG);\r\nexpio_mask_irq(d);\r\n}\r\nstatic void expio_unmask_irq(struct irq_data *d)\r\n{\r\nu16 reg;\r\nu32 expio = MXC_IRQ_TO_EXPIO(d->irq);\r\nreg = __raw_readw(brd_io + INTR_MASK_REG);\r\nreg &= ~(1 << expio);\r\n__raw_writew(reg, brd_io + INTR_MASK_REG);\r\n}\r\nint __init mxc_expio_init(u32 base, u32 p_irq)\r\n{\r\nint i;\r\nbrd_io = ioremap(BOARD_IO_ADDR(base), SZ_4K);\r\nif (brd_io == NULL)\r\nreturn -ENOMEM;\r\nif ((__raw_readw(brd_io + MAGIC_NUMBER1_REG) != 0xAAAA) ||\r\n(__raw_readw(brd_io + MAGIC_NUMBER2_REG) != 0x5555) ||\r\n(__raw_readw(brd_io + MAGIC_NUMBER3_REG) != 0xCAFE)) {\r\npr_info("3-Stack Debug board not detected\n");\r\niounmap(brd_io);\r\nbrd_io = NULL;\r\nreturn -ENODEV;\r\n}\r\npr_info("3-Stack Debug board detected, rev = 0x%04X\n",\r\nreadw(brd_io + CPLD_CODE_VER_REG));\r\ngpio_request(MXC_IRQ_TO_GPIO(p_irq), "expio_pirq");\r\ngpio_direction_input(MXC_IRQ_TO_GPIO(p_irq));\r\n__raw_writew(0, brd_io + INTR_MASK_REG);\r\n__raw_writew(0xFFFF, brd_io + INTR_RESET_REG);\r\n__raw_writew(0, brd_io + INTR_RESET_REG);\r\n__raw_writew(0x1F, brd_io + INTR_MASK_REG);\r\nfor (i = MXC_EXP_IO_BASE;\r\ni < (MXC_EXP_IO_BASE + MXC_MAX_EXP_IO_LINES); i++) {\r\nirq_set_chip_and_handler(i, &expio_irq_chip, handle_level_irq);\r\nset_irq_flags(i, IRQF_VALID);\r\n}\r\nirq_set_irq_type(p_irq, IRQF_TRIGGER_LOW);\r\nirq_set_chained_handler(p_irq, mxc_expio_irq_handler);\r\nregulator_register_fixed(0, dummy_supplies, ARRAY_SIZE(dummy_supplies));\r\nsmsc911x_resources[0].start = LAN9217_BASE_ADDR(base);\r\nsmsc911x_resources[0].end = LAN9217_BASE_ADDR(base) + 0x100 - 1;\r\nplatform_device_register(&smsc_lan9217_device);\r\nreturn 0;\r\n}

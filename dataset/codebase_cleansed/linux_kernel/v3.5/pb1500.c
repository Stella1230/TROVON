const char *get_system_type(void)\r\n{\r\nreturn "PB1500";\r\n}\r\nvoid __init board_setup(void)\r\n{\r\nu32 pin_func;\r\nu32 sys_freqctrl, sys_clksrc;\r\nbcsr_init(DB1000_BCSR_PHYS_ADDR,\r\nDB1000_BCSR_PHYS_ADDR + DB1000_BCSR_HEXLED_OFS);\r\nsys_clksrc = sys_freqctrl = pin_func = 0;\r\nau_writel(8, SYS_AUXPLL);\r\nalchemy_gpio1_input_enable();\r\nudelay(100);\r\nalchemy_gpio_direction_input(201);\r\nalchemy_gpio_direction_input(203);\r\n#if defined(CONFIG_USB_OHCI_HCD) || defined(CONFIG_USB_OHCI_HCD_MODULE)\r\nsys_freqctrl = au_readl(SYS_FREQCTRL0);\r\nsys_freqctrl &= ~0xFFF00000;\r\nau_writel(sys_freqctrl, SYS_FREQCTRL0);\r\nsys_clksrc = au_readl(SYS_CLKSRC);\r\nsys_clksrc &= ~(SYS_CS_CUD | SYS_CS_DUD | SYS_CS_MUD_MASK |\r\nSYS_CS_CUH | SYS_CS_DUH | SYS_CS_MUH_MASK);\r\nau_writel(sys_clksrc, SYS_CLKSRC);\r\nsys_freqctrl = au_readl(SYS_FREQCTRL0);\r\nsys_freqctrl &= ~0xFFF00000;\r\nsys_clksrc = au_readl(SYS_CLKSRC);\r\nsys_clksrc &= ~(SYS_CS_CUD | SYS_CS_DUD | SYS_CS_MUD_MASK |\r\nSYS_CS_CUH | SYS_CS_DUH | SYS_CS_MUH_MASK);\r\nsys_freqctrl |= (0 << SYS_FC_FRDIV2_BIT) | SYS_FC_FE2 | SYS_FC_FS2;\r\nau_writel(sys_freqctrl, SYS_FREQCTRL0);\r\nsys_clksrc |= SYS_CS_MUX_FQ2 << SYS_CS_MUH_BIT;\r\nau_writel(sys_clksrc, SYS_CLKSRC);\r\npin_func = au_readl(SYS_PINFUNC) & ~SYS_PF_USB;\r\npin_func |= SYS_PF_USB;\r\nau_writel(pin_func, SYS_PINFUNC);\r\n#endif\r\n#ifdef CONFIG_PCI\r\n{\r\nvoid __iomem *base =\r\n(void __iomem *)KSEG1ADDR(AU1500_PCI_PHYS_ADDR);\r\n__raw_writel(0x00003fff, base + PCI_REG_CMEM);\r\n__raw_writel(0xf0000000, base + PCI_REG_MWMASK_DEV);\r\n__raw_writel(0, base + PCI_REG_MWBASE_REV_CCL);\r\n__raw_writel(0x02a00356, base + PCI_REG_STATCMD);\r\n__raw_writel(0x00003c04, base + PCI_REG_PARAM);\r\n__raw_writel(0x00000008, base + PCI_REG_MBAR);\r\nwmb();\r\n}\r\n#endif\r\nau_writel(au_readl(SYS_POWERCTRL) | (0x3 << 5), SYS_POWERCTRL);\r\nif (!(au_readl(0xac000028) & 0x20)) {\r\nprintk(KERN_INFO "enabling clock ...\n");\r\nau_writel((au_readl(0xac000028) | 0x20), 0xac000028);\r\n}\r\nif (au_readl(0xac00002c) & 0x4) {\r\nau_writel(au_readl(0xac00002c) & ~0x4, 0xac00002c);\r\nau_sync();\r\n}\r\n}\r\nstatic int pb1500_map_pci_irq(const struct pci_dev *d, u8 slot, u8 pin)\r\n{\r\nif ((slot < 12) || (slot > 13) || pin == 0)\r\nreturn -1;\r\nif (slot == 12)\r\nreturn (pin == 1) ? AU1500_PCI_INTA : 0xff;\r\nif (slot == 13) {\r\nswitch (pin) {\r\ncase 1: return AU1500_PCI_INTA;\r\ncase 2: return AU1500_PCI_INTB;\r\ncase 3: return AU1500_PCI_INTC;\r\ncase 4: return AU1500_PCI_INTD;\r\n}\r\n}\r\nreturn -1;\r\n}\r\nstatic int __init pb1500_dev_init(void)\r\n{\r\nint swapped;\r\nirq_set_irq_type(AU1500_GPIO9_INT, IRQF_TRIGGER_LOW);\r\nirq_set_irq_type(AU1500_GPIO10_INT, IRQF_TRIGGER_LOW);\r\nirq_set_irq_type(AU1500_GPIO11_INT, IRQF_TRIGGER_LOW);\r\nirq_set_irq_type(AU1500_GPIO204_INT, IRQF_TRIGGER_HIGH);\r\nirq_set_irq_type(AU1500_GPIO201_INT, IRQF_TRIGGER_LOW);\r\nirq_set_irq_type(AU1500_GPIO202_INT, IRQF_TRIGGER_LOW);\r\nirq_set_irq_type(AU1500_GPIO203_INT, IRQF_TRIGGER_LOW);\r\nirq_set_irq_type(AU1500_GPIO205_INT, IRQF_TRIGGER_LOW);\r\ndb1x_register_pcmcia_socket(\r\nAU1000_PCMCIA_ATTR_PHYS_ADDR,\r\nAU1000_PCMCIA_ATTR_PHYS_ADDR + 0x000400000 - 1,\r\nAU1000_PCMCIA_MEM_PHYS_ADDR,\r\nAU1000_PCMCIA_MEM_PHYS_ADDR + 0x000400000 - 1,\r\nAU1000_PCMCIA_IO_PHYS_ADDR,\r\nAU1000_PCMCIA_IO_PHYS_ADDR + 0x000010000 - 1,\r\nAU1500_GPIO11_INT, AU1500_GPIO9_INT,\r\n0, 0, 0);\r\nswapped = bcsr_read(BCSR_STATUS) & BCSR_STATUS_DB1000_SWAPBOOT;\r\ndb1x_register_norflash(64 * 1024 * 1024, 4, swapped);\r\nplatform_device_register(&pb1500_pci_host);\r\nreturn 0;\r\n}

static void wdt_enable(u32 value)\r\n{\r\nspin_lock(&stmp3xxx_wdt_io_lock);\r\n__raw_writel(value, REGS_RTC_BASE + HW_RTC_WATCHDOG);\r\nstmp3xxx_setl(BM_RTC_CTRL_WATCHDOGEN, REGS_RTC_BASE + HW_RTC_CTRL);\r\nstmp3xxx_setl(BV_RTC_PERSISTENT1_GENERAL__RTC_FORCE_UPDATER,\r\nREGS_RTC_BASE + HW_RTC_PERSISTENT1);\r\nspin_unlock(&stmp3xxx_wdt_io_lock);\r\n}\r\nstatic void wdt_disable(void)\r\n{\r\nspin_lock(&stmp3xxx_wdt_io_lock);\r\nstmp3xxx_clearl(BV_RTC_PERSISTENT1_GENERAL__RTC_FORCE_UPDATER,\r\nREGS_RTC_BASE + HW_RTC_PERSISTENT1);\r\nstmp3xxx_clearl(BM_RTC_CTRL_WATCHDOGEN, REGS_RTC_BASE + HW_RTC_CTRL);\r\nspin_unlock(&stmp3xxx_wdt_io_lock);\r\n}\r\nstatic void wdt_ping(void)\r\n{\r\nwdt_enable(heartbeat * WDOG_COUNTER_RATE);\r\n}\r\nstatic int stmp3xxx_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(WDT_IN_USE, &wdt_status))\r\nreturn -EBUSY;\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nwdt_ping();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic ssize_t stmp3xxx_wdt_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nif (!nowayout) {\r\nsize_t i;\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nset_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\n}\r\n}\r\nwdt_ping();\r\n}\r\nreturn len;\r\n}\r\nstatic long stmp3xxx_wdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nint new_heartbeat, opts;\r\nint ret = -ENOTTY;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nret = copy_to_user(argp, &ident, sizeof(ident)) ? -EFAULT : 0;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\nret = put_user(0, p);\r\nbreak;\r\ncase WDIOC_GETBOOTSTATUS:\r\nret = put_user(boot_status, p);\r\nbreak;\r\ncase WDIOC_SETOPTIONS:\r\nif (get_user(opts, p)) {\r\nret = -EFAULT;\r\nbreak;\r\n}\r\nif (opts & WDIOS_DISABLECARD)\r\nwdt_disable();\r\nelse if (opts & WDIOS_ENABLECARD)\r\nwdt_ping();\r\nelse {\r\npr_debug("%s: unknown option 0x%x\n", __func__, opts);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nret = 0;\r\nbreak;\r\ncase WDIOC_KEEPALIVE:\r\nwdt_ping();\r\nret = 0;\r\nbreak;\r\ncase WDIOC_SETTIMEOUT:\r\nif (get_user(new_heartbeat, p)) {\r\nret = -EFAULT;\r\nbreak;\r\n}\r\nif (new_heartbeat <= 0 || new_heartbeat > MAX_HEARTBEAT) {\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nheartbeat = new_heartbeat;\r\nwdt_ping();\r\ncase WDIOC_GETTIMEOUT:\r\nret = put_user(heartbeat, p);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int stmp3xxx_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nint ret = 0;\r\nif (!nowayout) {\r\nif (!test_bit(WDT_OK_TO_CLOSE, &wdt_status)) {\r\nwdt_ping();\r\npr_debug("%s: Device closed unexpectedly\n", __func__);\r\nret = -EINVAL;\r\n} else {\r\nwdt_disable();\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\n}\r\n}\r\nclear_bit(WDT_IN_USE, &wdt_status);\r\nreturn ret;\r\n}\r\nstatic int __devinit stmp3xxx_wdt_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0;\r\nif (heartbeat < 1 || heartbeat > MAX_HEARTBEAT)\r\nheartbeat = DEFAULT_HEARTBEAT;\r\nboot_status = __raw_readl(REGS_RTC_BASE + HW_RTC_PERSISTENT1) &\r\nBV_RTC_PERSISTENT1_GENERAL__RTC_FORCE_UPDATER;\r\nboot_status = !!boot_status;\r\nstmp3xxx_clearl(BV_RTC_PERSISTENT1_GENERAL__RTC_FORCE_UPDATER,\r\nREGS_RTC_BASE + HW_RTC_PERSISTENT1);\r\nwdt_disable();\r\nret = misc_register(&stmp3xxx_wdt_miscdev);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "cannot register misc device\n");\r\nreturn ret;\r\n}\r\npr_info("initialized, heartbeat %d sec\n", heartbeat);\r\nreturn ret;\r\n}\r\nstatic int __devexit stmp3xxx_wdt_remove(struct platform_device *pdev)\r\n{\r\nmisc_deregister(&stmp3xxx_wdt_miscdev);\r\nreturn 0;\r\n}\r\nstatic int stmp3xxx_wdt_suspend(struct platform_device *pdev,\r\npm_message_t state)\r\n{\r\nif (__raw_readl(REGS_RTC_BASE + HW_RTC_CTRL) &\r\nBM_RTC_CTRL_WATCHDOGEN) {\r\nwdt_suspended = 1;\r\nwdt_saved_time = __raw_readl(REGS_RTC_BASE + HW_RTC_WATCHDOG);\r\nwdt_disable();\r\n}\r\nreturn 0;\r\n}\r\nstatic int stmp3xxx_wdt_resume(struct platform_device *pdev)\r\n{\r\nif (wdt_suspended) {\r\nwdt_enable(wdt_saved_time);\r\nwdt_suspended = 0;\r\n}\r\nreturn 0;\r\n}

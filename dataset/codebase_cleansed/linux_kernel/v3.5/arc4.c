static int arc4_set_key(struct crypto_tfm *tfm, const u8 *in_key,\r\nunsigned int key_len)\r\n{\r\nstruct arc4_ctx *ctx = crypto_tfm_ctx(tfm);\r\nint i, j = 0, k = 0;\r\nctx->x = 1;\r\nctx->y = 0;\r\nfor (i = 0; i < 256; i++)\r\nctx->S[i] = i;\r\nfor (i = 0; i < 256; i++) {\r\nu8 a = ctx->S[i];\r\nj = (j + in_key[k] + a) & 0xff;\r\nctx->S[i] = ctx->S[j];\r\nctx->S[j] = a;\r\nif (++k >= key_len)\r\nk = 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic void arc4_crypt(struct crypto_tfm *tfm, u8 *out, const u8 *in)\r\n{\r\nstruct arc4_ctx *ctx = crypto_tfm_ctx(tfm);\r\nu8 *const S = ctx->S;\r\nu8 x = ctx->x;\r\nu8 y = ctx->y;\r\nu8 a, b;\r\na = S[x];\r\ny = (y + a) & 0xff;\r\nb = S[y];\r\nS[x] = b;\r\nS[y] = a;\r\nx = (x + 1) & 0xff;\r\n*out++ = *in ^ S[(a + b) & 0xff];\r\nctx->x = x;\r\nctx->y = y;\r\n}\r\nstatic int __init arc4_init(void)\r\n{\r\nreturn crypto_register_alg(&arc4_alg);\r\n}\r\nstatic void __exit arc4_exit(void)\r\n{\r\ncrypto_unregister_alg(&arc4_alg);\r\n}

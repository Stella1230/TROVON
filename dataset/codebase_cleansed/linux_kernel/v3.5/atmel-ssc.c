struct ssc_device *ssc_request(unsigned int ssc_num)\r\n{\r\nint ssc_valid = 0;\r\nstruct ssc_device *ssc;\r\nspin_lock(&user_lock);\r\nlist_for_each_entry(ssc, &ssc_list, list) {\r\nif (ssc->pdev->id == ssc_num) {\r\nssc_valid = 1;\r\nbreak;\r\n}\r\n}\r\nif (!ssc_valid) {\r\nspin_unlock(&user_lock);\r\npr_err("ssc: ssc%d platform device is missing\n", ssc_num);\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\nif (ssc->user) {\r\nspin_unlock(&user_lock);\r\ndev_dbg(&ssc->pdev->dev, "module busy\n");\r\nreturn ERR_PTR(-EBUSY);\r\n}\r\nssc->user++;\r\nspin_unlock(&user_lock);\r\nclk_enable(ssc->clk);\r\nreturn ssc;\r\n}\r\nvoid ssc_free(struct ssc_device *ssc)\r\n{\r\nspin_lock(&user_lock);\r\nif (ssc->user) {\r\nssc->user--;\r\nclk_disable(ssc->clk);\r\n} else {\r\ndev_dbg(&ssc->pdev->dev, "device already free\n");\r\n}\r\nspin_unlock(&user_lock);\r\n}\r\nstatic int __init ssc_probe(struct platform_device *pdev)\r\n{\r\nint retval = 0;\r\nstruct resource *regs;\r\nstruct ssc_device *ssc;\r\nssc = kzalloc(sizeof(struct ssc_device), GFP_KERNEL);\r\nif (!ssc) {\r\ndev_dbg(&pdev->dev, "out of memory\n");\r\nretval = -ENOMEM;\r\ngoto out;\r\n}\r\nregs = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!regs) {\r\ndev_dbg(&pdev->dev, "no mmio resource defined\n");\r\nretval = -ENXIO;\r\ngoto out_free;\r\n}\r\nssc->clk = clk_get(&pdev->dev, "pclk");\r\nif (IS_ERR(ssc->clk)) {\r\ndev_dbg(&pdev->dev, "no pclk clock defined\n");\r\nretval = -ENXIO;\r\ngoto out_free;\r\n}\r\nssc->pdev = pdev;\r\nssc->regs = ioremap(regs->start, resource_size(regs));\r\nif (!ssc->regs) {\r\ndev_dbg(&pdev->dev, "ioremap failed\n");\r\nretval = -EINVAL;\r\ngoto out_clk;\r\n}\r\nclk_enable(ssc->clk);\r\nssc_writel(ssc->regs, IDR, ~0UL);\r\nssc_readl(ssc->regs, SR);\r\nclk_disable(ssc->clk);\r\nssc->irq = platform_get_irq(pdev, 0);\r\nif (!ssc->irq) {\r\ndev_dbg(&pdev->dev, "could not get irq\n");\r\nretval = -ENXIO;\r\ngoto out_unmap;\r\n}\r\nspin_lock(&user_lock);\r\nlist_add_tail(&ssc->list, &ssc_list);\r\nspin_unlock(&user_lock);\r\nplatform_set_drvdata(pdev, ssc);\r\ndev_info(&pdev->dev, "Atmel SSC device at 0x%p (irq %d)\n",\r\nssc->regs, ssc->irq);\r\ngoto out;\r\nout_unmap:\r\niounmap(ssc->regs);\r\nout_clk:\r\nclk_put(ssc->clk);\r\nout_free:\r\nkfree(ssc);\r\nout:\r\nreturn retval;\r\n}\r\nstatic int __devexit ssc_remove(struct platform_device *pdev)\r\n{\r\nstruct ssc_device *ssc = platform_get_drvdata(pdev);\r\nspin_lock(&user_lock);\r\niounmap(ssc->regs);\r\nclk_put(ssc->clk);\r\nlist_del(&ssc->list);\r\nkfree(ssc);\r\nspin_unlock(&user_lock);\r\nreturn 0;\r\n}\r\nstatic int __init ssc_init(void)\r\n{\r\nreturn platform_driver_probe(&ssc_driver, ssc_probe);\r\n}\r\nstatic void __exit ssc_exit(void)\r\n{\r\nplatform_driver_unregister(&ssc_driver);\r\n}

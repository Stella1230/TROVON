static int ehci_xls_setup(struct usb_hcd *hcd)\r\n{\r\nint retval;\r\nstruct ehci_hcd *ehci = hcd_to_ehci(hcd);\r\nehci->caps = hcd->regs;\r\nehci->regs = hcd->regs +\r\nHC_LENGTH(ehci, ehci_readl(ehci, &ehci->caps->hc_capbase));\r\ndbg_hcs_params(ehci, "reset");\r\ndbg_hcc_params(ehci, "reset");\r\nehci->hcs_params = ehci_readl(ehci, &ehci->caps->hcs_params);\r\nretval = ehci_halt(ehci);\r\nif (retval)\r\nreturn retval;\r\nretval = ehci_init(hcd);\r\nif (retval)\r\nreturn retval;\r\nehci_reset(ehci);\r\nreturn retval;\r\n}\r\nint ehci_xls_probe_internal(const struct hc_driver *driver,\r\nstruct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd;\r\nstruct resource *res;\r\nint retval, irq;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "Found HC with no IRQ. Check %s setup!\n",\r\ndev_name(&pdev->dev));\r\nreturn -ENODEV;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "Error: MMIO Handle %s setup!\n",\r\ndev_name(&pdev->dev));\r\nreturn -ENODEV;\r\n}\r\nhcd = usb_create_hcd(driver, &pdev->dev, dev_name(&pdev->dev));\r\nif (!hcd) {\r\nretval = -ENOMEM;\r\ngoto err1;\r\n}\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len,\r\ndriver->description)) {\r\ndev_dbg(&pdev->dev, "controller already in use\n");\r\nretval = -EBUSY;\r\ngoto err2;\r\n}\r\nhcd->regs = ioremap_nocache(hcd->rsrc_start, hcd->rsrc_len);\r\nif (hcd->regs == NULL) {\r\ndev_dbg(&pdev->dev, "error mapping memory\n");\r\nretval = -EFAULT;\r\ngoto err3;\r\n}\r\nretval = usb_add_hcd(hcd, irq, IRQF_SHARED);\r\nif (retval != 0)\r\ngoto err4;\r\nreturn retval;\r\nerr4:\r\niounmap(hcd->regs);\r\nerr3:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr2:\r\nusb_put_hcd(hcd);\r\nerr1:\r\ndev_err(&pdev->dev, "init %s fail, %d\n", dev_name(&pdev->dev),\r\nretval);\r\nreturn retval;\r\n}\r\nstatic int ehci_xls_probe(struct platform_device *pdev)\r\n{\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nreturn ehci_xls_probe_internal(&ehci_xls_hc_driver, pdev);\r\n}\r\nstatic int ehci_xls_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_remove_hcd(hcd);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}

bool tegra_apb_init(void)\r\n{\r\nstruct tegra_dma_channel *ch;\r\nmutex_lock(&tegra_apb_dma_lock);\r\nif (tegra_apb_dma)\r\ngoto out;\r\nch = tegra_dma_allocate_channel(TEGRA_DMA_MODE_ONESHOT |\r\nTEGRA_DMA_SHARED);\r\nif (!ch)\r\ngoto out_fail;\r\ntegra_apb_bb = dma_alloc_coherent(NULL, sizeof(u32),\r\n&tegra_apb_bb_phys, GFP_KERNEL);\r\nif (!tegra_apb_bb) {\r\npr_err("%s: can not allocate bounce buffer\n", __func__);\r\ntegra_dma_free_channel(ch);\r\ngoto out_fail;\r\n}\r\ntegra_apb_dma = ch;\r\nout:\r\nmutex_unlock(&tegra_apb_dma_lock);\r\nreturn true;\r\nout_fail:\r\nmutex_unlock(&tegra_apb_dma_lock);\r\nreturn false;\r\n}\r\nstatic void apb_dma_complete(struct tegra_dma_req *req)\r\n{\r\ncomplete(&tegra_apb_wait);\r\n}\r\nu32 tegra_apb_readl(unsigned long offset)\r\n{\r\nstruct tegra_dma_req req;\r\nint ret;\r\nif (!tegra_apb_dma && !tegra_apb_init())\r\nreturn readl(IO_TO_VIRT(offset));\r\nmutex_lock(&tegra_apb_dma_lock);\r\nreq.complete = apb_dma_complete;\r\nreq.to_memory = 1;\r\nreq.dest_addr = tegra_apb_bb_phys;\r\nreq.dest_bus_width = 32;\r\nreq.dest_wrap = 1;\r\nreq.source_addr = offset;\r\nreq.source_bus_width = 32;\r\nreq.source_wrap = 4;\r\nreq.req_sel = TEGRA_DMA_REQ_SEL_CNTR;\r\nreq.size = 4;\r\nINIT_COMPLETION(tegra_apb_wait);\r\ntegra_dma_enqueue_req(tegra_apb_dma, &req);\r\nret = wait_for_completion_timeout(&tegra_apb_wait,\r\nmsecs_to_jiffies(50));\r\nif (WARN(ret == 0, "apb read dma timed out")) {\r\ntegra_dma_dequeue_req(tegra_apb_dma, &req);\r\n*(u32 *)tegra_apb_bb = 0;\r\n}\r\nmutex_unlock(&tegra_apb_dma_lock);\r\nreturn *((u32 *)tegra_apb_bb);\r\n}\r\nvoid tegra_apb_writel(u32 value, unsigned long offset)\r\n{\r\nstruct tegra_dma_req req;\r\nint ret;\r\nif (!tegra_apb_dma && !tegra_apb_init()) {\r\nwritel(value, IO_TO_VIRT(offset));\r\nreturn;\r\n}\r\nmutex_lock(&tegra_apb_dma_lock);\r\n*((u32 *)tegra_apb_bb) = value;\r\nreq.complete = apb_dma_complete;\r\nreq.to_memory = 0;\r\nreq.dest_addr = offset;\r\nreq.dest_wrap = 4;\r\nreq.dest_bus_width = 32;\r\nreq.source_addr = tegra_apb_bb_phys;\r\nreq.source_bus_width = 32;\r\nreq.source_wrap = 1;\r\nreq.req_sel = TEGRA_DMA_REQ_SEL_CNTR;\r\nreq.size = 4;\r\nINIT_COMPLETION(tegra_apb_wait);\r\ntegra_dma_enqueue_req(tegra_apb_dma, &req);\r\nret = wait_for_completion_timeout(&tegra_apb_wait,\r\nmsecs_to_jiffies(50));\r\nif (WARN(ret == 0, "apb write dma timed out"))\r\ntegra_dma_dequeue_req(tegra_apb_dma, &req);\r\nmutex_unlock(&tegra_apb_dma_lock);\r\n}

static void h1940bt_enable(int on)\r\n{\r\nif (on) {\r\ngpio_set_value(H1940_LATCH_BLUETOOTH_POWER, 1);\r\nmdelay(10);\r\ngpio_set_value(S3C2410_GPH(1), 1);\r\nmdelay(10);\r\ngpio_set_value(S3C2410_GPH(1), 0);\r\nh1940_led_blink_set(-EINVAL, GPIO_LED_BLINK, NULL, NULL);\r\n}\r\nelse {\r\ngpio_set_value(S3C2410_GPH(1), 1);\r\nmdelay(10);\r\ngpio_set_value(S3C2410_GPH(1), 0);\r\nmdelay(10);\r\ngpio_set_value(H1940_LATCH_BLUETOOTH_POWER, 0);\r\nh1940_led_blink_set(-EINVAL, GPIO_LED_NO_BLINK_LOW, NULL, NULL);\r\n}\r\n}\r\nstatic int h1940bt_set_block(void *data, bool blocked)\r\n{\r\nh1940bt_enable(!blocked);\r\nreturn 0;\r\n}\r\nstatic int __devinit h1940bt_probe(struct platform_device *pdev)\r\n{\r\nstruct rfkill *rfk;\r\nint ret = 0;\r\nret = gpio_request(S3C2410_GPH(1), dev_name(&pdev->dev));\r\nif (ret) {\r\ndev_err(&pdev->dev, "could not get GPH1\n");\r\nreturn ret;\r\n}\r\nret = gpio_request(H1940_LATCH_BLUETOOTH_POWER, dev_name(&pdev->dev));\r\nif (ret) {\r\ngpio_free(S3C2410_GPH(1));\r\ndev_err(&pdev->dev, "could not get BT_POWER\n");\r\nreturn ret;\r\n}\r\ns3c_gpio_cfgpin(S3C2410_GPH(0), S3C2410_GPH0_nCTS0);\r\ns3c_gpio_setpull(S3C2410_GPH(0), S3C_GPIO_PULL_NONE);\r\ns3c_gpio_cfgpin(S3C2410_GPH(1), S3C2410_GPIO_OUTPUT);\r\ns3c_gpio_setpull(S3C2410_GPH(1), S3C_GPIO_PULL_NONE);\r\ns3c_gpio_cfgpin(S3C2410_GPH(2), S3C2410_GPH2_TXD0);\r\ns3c_gpio_setpull(S3C2410_GPH(2), S3C_GPIO_PULL_NONE);\r\ns3c_gpio_cfgpin(S3C2410_GPH(3), S3C2410_GPH3_RXD0);\r\ns3c_gpio_setpull(S3C2410_GPH(3), S3C_GPIO_PULL_NONE);\r\nrfk = rfkill_alloc(DRV_NAME, &pdev->dev, RFKILL_TYPE_BLUETOOTH,\r\n&h1940bt_rfkill_ops, NULL);\r\nif (!rfk) {\r\nret = -ENOMEM;\r\ngoto err_rfk_alloc;\r\n}\r\nret = rfkill_register(rfk);\r\nif (ret)\r\ngoto err_rfkill;\r\nplatform_set_drvdata(pdev, rfk);\r\nreturn 0;\r\nerr_rfkill:\r\nrfkill_destroy(rfk);\r\nerr_rfk_alloc:\r\nreturn ret;\r\n}\r\nstatic int h1940bt_remove(struct platform_device *pdev)\r\n{\r\nstruct rfkill *rfk = platform_get_drvdata(pdev);\r\nplatform_set_drvdata(pdev, NULL);\r\ngpio_free(S3C2410_GPH(1));\r\nif (rfk) {\r\nrfkill_unregister(rfk);\r\nrfkill_destroy(rfk);\r\n}\r\nrfk = NULL;\r\nh1940bt_enable(0);\r\nreturn 0;\r\n}\r\nstatic int __init h1940bt_init(void)\r\n{\r\nreturn platform_driver_register(&h1940bt_driver);\r\n}\r\nstatic void __exit h1940bt_exit(void)\r\n{\r\nplatform_driver_unregister(&h1940bt_driver);\r\n}

static int __devinit dwc3_exynos_probe(struct platform_device *pdev)\r\n{\r\nstruct dwc3_exynos_data *pdata = pdev->dev.platform_data;\r\nstruct platform_device *dwc3;\r\nstruct dwc3_exynos *exynos;\r\nstruct clk *clk;\r\nint devid;\r\nint ret = -ENOMEM;\r\nexynos = kzalloc(sizeof(*exynos), GFP_KERNEL);\r\nif (!exynos) {\r\ndev_err(&pdev->dev, "not enough memory\n");\r\ngoto err0;\r\n}\r\nplatform_set_drvdata(pdev, exynos);\r\ndevid = dwc3_get_device_id();\r\nif (devid < 0)\r\ngoto err1;\r\ndwc3 = platform_device_alloc("dwc3", devid);\r\nif (!dwc3) {\r\ndev_err(&pdev->dev, "couldn't allocate dwc3 device\n");\r\ngoto err2;\r\n}\r\nclk = clk_get(&pdev->dev, "usbdrd30");\r\nif (IS_ERR(clk)) {\r\ndev_err(&pdev->dev, "couldn't get clock\n");\r\nret = -EINVAL;\r\ngoto err3;\r\n}\r\ndma_set_coherent_mask(&dwc3->dev, pdev->dev.coherent_dma_mask);\r\ndwc3->dev.parent = &pdev->dev;\r\ndwc3->dev.dma_mask = pdev->dev.dma_mask;\r\ndwc3->dev.dma_parms = pdev->dev.dma_parms;\r\nexynos->dwc3 = dwc3;\r\nexynos->dev = &pdev->dev;\r\nexynos->clk = clk;\r\nclk_enable(exynos->clk);\r\nif (!pdata) {\r\ndev_dbg(&pdev->dev, "missing platform data\n");\r\n} else {\r\nif (pdata->phy_init)\r\npdata->phy_init(pdev, pdata->phy_type);\r\n}\r\nret = platform_device_add_resources(dwc3, pdev->resource,\r\npdev->num_resources);\r\nif (ret) {\r\ndev_err(&pdev->dev, "couldn't add resources to dwc3 device\n");\r\ngoto err4;\r\n}\r\nret = platform_device_add(dwc3);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to register dwc3 device\n");\r\ngoto err4;\r\n}\r\nreturn 0;\r\nerr4:\r\nif (pdata && pdata->phy_exit)\r\npdata->phy_exit(pdev, pdata->phy_type);\r\nclk_disable(clk);\r\nclk_put(clk);\r\nerr3:\r\nplatform_device_put(dwc3);\r\nerr2:\r\ndwc3_put_device_id(devid);\r\nerr1:\r\nkfree(exynos);\r\nerr0:\r\nreturn ret;\r\n}\r\nstatic int __devexit dwc3_exynos_remove(struct platform_device *pdev)\r\n{\r\nstruct dwc3_exynos *exynos = platform_get_drvdata(pdev);\r\nstruct dwc3_exynos_data *pdata = pdev->dev.platform_data;\r\nplatform_device_unregister(exynos->dwc3);\r\ndwc3_put_device_id(exynos->dwc3->id);\r\nif (pdata && pdata->phy_exit)\r\npdata->phy_exit(pdev, pdata->phy_type);\r\nclk_disable(exynos->clk);\r\nclk_put(exynos->clk);\r\nkfree(exynos);\r\nreturn 0;\r\n}

static int pm8xxx_read_wrapper(struct pm8xxx_rtc *rtc_dd, u8 *rtc_val,\r\nint base, int count)\r\n{\r\nint i, rc;\r\nstruct device *parent = rtc_dd->rtc_dev->parent;\r\nfor (i = 0; i < count; i++) {\r\nrc = pm8xxx_readb(parent, base + i, &rtc_val[i]);\r\nif (rc < 0) {\r\ndev_err(rtc_dd->rtc_dev, "PMIC read failed\n");\r\nreturn rc;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int pm8xxx_write_wrapper(struct pm8xxx_rtc *rtc_dd, u8 *rtc_val,\r\nint base, int count)\r\n{\r\nint i, rc;\r\nstruct device *parent = rtc_dd->rtc_dev->parent;\r\nfor (i = 0; i < count; i++) {\r\nrc = pm8xxx_writeb(parent, base + i, rtc_val[i]);\r\nif (rc < 0) {\r\ndev_err(rtc_dd->rtc_dev, "PMIC write failed\n");\r\nreturn rc;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int pm8xxx_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nint rc, i;\r\nunsigned long secs, irq_flags;\r\nu8 value[NUM_8_BIT_RTC_REGS], reg = 0, alarm_enabled = 0, ctrl_reg;\r\nstruct pm8xxx_rtc *rtc_dd = dev_get_drvdata(dev);\r\nrtc_tm_to_time(tm, &secs);\r\nfor (i = 0; i < NUM_8_BIT_RTC_REGS; i++) {\r\nvalue[i] = secs & 0xFF;\r\nsecs >>= 8;\r\n}\r\ndev_dbg(dev, "Seconds value to be written to RTC = %lu\n", secs);\r\nspin_lock_irqsave(&rtc_dd->ctrl_reg_lock, irq_flags);\r\nctrl_reg = rtc_dd->ctrl_reg;\r\nif (ctrl_reg & PM8xxx_RTC_ALARM_ENABLE) {\r\nalarm_enabled = 1;\r\nctrl_reg &= ~PM8xxx_RTC_ALARM_ENABLE;\r\nrc = pm8xxx_write_wrapper(rtc_dd, &ctrl_reg, rtc_dd->rtc_base,\r\n1);\r\nif (rc < 0) {\r\ndev_err(dev, "Write to RTC control register "\r\n"failed\n");\r\ngoto rtc_rw_fail;\r\n}\r\nrtc_dd->ctrl_reg = ctrl_reg;\r\n} else\r\nspin_unlock_irqrestore(&rtc_dd->ctrl_reg_lock, irq_flags);\r\nreg = 0;\r\nrc = pm8xxx_write_wrapper(rtc_dd, &reg, rtc_dd->rtc_write_base, 1);\r\nif (rc < 0) {\r\ndev_err(dev, "Write to RTC write data register failed\n");\r\ngoto rtc_rw_fail;\r\n}\r\nrc = pm8xxx_write_wrapper(rtc_dd, value + 1,\r\nrtc_dd->rtc_write_base + 1, 3);\r\nif (rc < 0) {\r\ndev_err(dev, "Write to RTC write data register failed\n");\r\ngoto rtc_rw_fail;\r\n}\r\nrc = pm8xxx_write_wrapper(rtc_dd, value, rtc_dd->rtc_write_base, 1);\r\nif (rc < 0) {\r\ndev_err(dev, "Write to RTC write data register failed\n");\r\ngoto rtc_rw_fail;\r\n}\r\nif (alarm_enabled) {\r\nctrl_reg |= PM8xxx_RTC_ALARM_ENABLE;\r\nrc = pm8xxx_write_wrapper(rtc_dd, &ctrl_reg, rtc_dd->rtc_base,\r\n1);\r\nif (rc < 0) {\r\ndev_err(dev, "Write to RTC control register "\r\n"failed\n");\r\ngoto rtc_rw_fail;\r\n}\r\nrtc_dd->ctrl_reg = ctrl_reg;\r\n}\r\nrtc_rw_fail:\r\nif (alarm_enabled)\r\nspin_unlock_irqrestore(&rtc_dd->ctrl_reg_lock, irq_flags);\r\nreturn rc;\r\n}\r\nstatic int pm8xxx_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nint rc;\r\nu8 value[NUM_8_BIT_RTC_REGS], reg;\r\nunsigned long secs;\r\nstruct pm8xxx_rtc *rtc_dd = dev_get_drvdata(dev);\r\nrc = pm8xxx_read_wrapper(rtc_dd, value, rtc_dd->rtc_read_base,\r\nNUM_8_BIT_RTC_REGS);\r\nif (rc < 0) {\r\ndev_err(dev, "RTC read data register failed\n");\r\nreturn rc;\r\n}\r\nrc = pm8xxx_read_wrapper(rtc_dd, &reg, rtc_dd->rtc_read_base, 1);\r\nif (rc < 0) {\r\ndev_err(dev, "RTC read data register failed\n");\r\nreturn rc;\r\n}\r\nif (unlikely(reg < value[0])) {\r\nrc = pm8xxx_read_wrapper(rtc_dd, value,\r\nrtc_dd->rtc_read_base, NUM_8_BIT_RTC_REGS);\r\nif (rc < 0) {\r\ndev_err(dev, "RTC read data register failed\n");\r\nreturn rc;\r\n}\r\n}\r\nsecs = value[0] | (value[1] << 8) | (value[2] << 16) | (value[3] << 24);\r\nrtc_time_to_tm(secs, tm);\r\nrc = rtc_valid_tm(tm);\r\nif (rc < 0) {\r\ndev_err(dev, "Invalid time read from RTC\n");\r\nreturn rc;\r\n}\r\ndev_dbg(dev, "secs = %lu, h:m:s == %d:%d:%d, d/m/y = %d/%d/%d\n",\r\nsecs, tm->tm_hour, tm->tm_min, tm->tm_sec,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year);\r\nreturn 0;\r\n}\r\nstatic int pm8xxx_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nint rc, i;\r\nu8 value[NUM_8_BIT_RTC_REGS], ctrl_reg;\r\nunsigned long secs, irq_flags;\r\nstruct pm8xxx_rtc *rtc_dd = dev_get_drvdata(dev);\r\nrtc_tm_to_time(&alarm->time, &secs);\r\nfor (i = 0; i < NUM_8_BIT_RTC_REGS; i++) {\r\nvalue[i] = secs & 0xFF;\r\nsecs >>= 8;\r\n}\r\nspin_lock_irqsave(&rtc_dd->ctrl_reg_lock, irq_flags);\r\nrc = pm8xxx_write_wrapper(rtc_dd, value, rtc_dd->alarm_rw_base,\r\nNUM_8_BIT_RTC_REGS);\r\nif (rc < 0) {\r\ndev_err(dev, "Write to RTC ALARM register failed\n");\r\ngoto rtc_rw_fail;\r\n}\r\nctrl_reg = rtc_dd->ctrl_reg;\r\nctrl_reg = alarm->enabled ? (ctrl_reg | PM8xxx_RTC_ALARM_ENABLE) :\r\n(ctrl_reg & ~PM8xxx_RTC_ALARM_ENABLE);\r\nrc = pm8xxx_write_wrapper(rtc_dd, &ctrl_reg, rtc_dd->rtc_base, 1);\r\nif (rc < 0) {\r\ndev_err(dev, "Write to RTC control register failed\n");\r\ngoto rtc_rw_fail;\r\n}\r\nrtc_dd->ctrl_reg = ctrl_reg;\r\ndev_dbg(dev, "Alarm Set for h:r:s=%d:%d:%d, d/m/y=%d/%d/%d\n",\r\nalarm->time.tm_hour, alarm->time.tm_min,\r\nalarm->time.tm_sec, alarm->time.tm_mday,\r\nalarm->time.tm_mon, alarm->time.tm_year);\r\nrtc_rw_fail:\r\nspin_unlock_irqrestore(&rtc_dd->ctrl_reg_lock, irq_flags);\r\nreturn rc;\r\n}\r\nstatic int pm8xxx_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nint rc;\r\nu8 value[NUM_8_BIT_RTC_REGS];\r\nunsigned long secs;\r\nstruct pm8xxx_rtc *rtc_dd = dev_get_drvdata(dev);\r\nrc = pm8xxx_read_wrapper(rtc_dd, value, rtc_dd->alarm_rw_base,\r\nNUM_8_BIT_RTC_REGS);\r\nif (rc < 0) {\r\ndev_err(dev, "RTC alarm time read failed\n");\r\nreturn rc;\r\n}\r\nsecs = value[0] | (value[1] << 8) | (value[2] << 16) | (value[3] << 24);\r\nrtc_time_to_tm(secs, &alarm->time);\r\nrc = rtc_valid_tm(&alarm->time);\r\nif (rc < 0) {\r\ndev_err(dev, "Invalid alarm time read from RTC\n");\r\nreturn rc;\r\n}\r\ndev_dbg(dev, "Alarm set for - h:r:s=%d:%d:%d, d/m/y=%d/%d/%d\n",\r\nalarm->time.tm_hour, alarm->time.tm_min,\r\nalarm->time.tm_sec, alarm->time.tm_mday,\r\nalarm->time.tm_mon, alarm->time.tm_year);\r\nreturn 0;\r\n}\r\nstatic int pm8xxx_rtc_alarm_irq_enable(struct device *dev, unsigned int enable)\r\n{\r\nint rc;\r\nunsigned long irq_flags;\r\nstruct pm8xxx_rtc *rtc_dd = dev_get_drvdata(dev);\r\nu8 ctrl_reg;\r\nspin_lock_irqsave(&rtc_dd->ctrl_reg_lock, irq_flags);\r\nctrl_reg = rtc_dd->ctrl_reg;\r\nctrl_reg = (enable) ? (ctrl_reg | PM8xxx_RTC_ALARM_ENABLE) :\r\n(ctrl_reg & ~PM8xxx_RTC_ALARM_ENABLE);\r\nrc = pm8xxx_write_wrapper(rtc_dd, &ctrl_reg, rtc_dd->rtc_base, 1);\r\nif (rc < 0) {\r\ndev_err(dev, "Write to RTC control register failed\n");\r\ngoto rtc_rw_fail;\r\n}\r\nrtc_dd->ctrl_reg = ctrl_reg;\r\nrtc_rw_fail:\r\nspin_unlock_irqrestore(&rtc_dd->ctrl_reg_lock, irq_flags);\r\nreturn rc;\r\n}\r\nstatic irqreturn_t pm8xxx_alarm_trigger(int irq, void *dev_id)\r\n{\r\nstruct pm8xxx_rtc *rtc_dd = dev_id;\r\nu8 ctrl_reg;\r\nint rc;\r\nunsigned long irq_flags;\r\nrtc_update_irq(rtc_dd->rtc, 1, RTC_IRQF | RTC_AF);\r\nspin_lock_irqsave(&rtc_dd->ctrl_reg_lock, irq_flags);\r\nctrl_reg = rtc_dd->ctrl_reg;\r\nctrl_reg &= ~PM8xxx_RTC_ALARM_ENABLE;\r\nrc = pm8xxx_write_wrapper(rtc_dd, &ctrl_reg, rtc_dd->rtc_base, 1);\r\nif (rc < 0) {\r\nspin_unlock_irqrestore(&rtc_dd->ctrl_reg_lock, irq_flags);\r\ndev_err(rtc_dd->rtc_dev, "Write to RTC control register "\r\n"failed\n");\r\ngoto rtc_alarm_handled;\r\n}\r\nrtc_dd->ctrl_reg = ctrl_reg;\r\nspin_unlock_irqrestore(&rtc_dd->ctrl_reg_lock, irq_flags);\r\nrc = pm8xxx_read_wrapper(rtc_dd, &ctrl_reg, rtc_dd->rtc_base +\r\nPM8XXX_ALARM_CTRL_OFFSET, 1);\r\nif (rc < 0) {\r\ndev_err(rtc_dd->rtc_dev, "RTC Alarm control register read "\r\n"failed\n");\r\ngoto rtc_alarm_handled;\r\n}\r\nctrl_reg &= ~PM8xxx_RTC_ALARM_CLEAR;\r\nrc = pm8xxx_write_wrapper(rtc_dd, &ctrl_reg, rtc_dd->rtc_base +\r\nPM8XXX_ALARM_CTRL_OFFSET, 1);\r\nif (rc < 0)\r\ndev_err(rtc_dd->rtc_dev, "Write to RTC Alarm control register"\r\n" failed\n");\r\nrtc_alarm_handled:\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __devinit pm8xxx_rtc_probe(struct platform_device *pdev)\r\n{\r\nint rc;\r\nu8 ctrl_reg;\r\nbool rtc_write_enable = false;\r\nstruct pm8xxx_rtc *rtc_dd;\r\nstruct resource *rtc_resource;\r\nconst struct pm8xxx_rtc_platform_data *pdata =\r\ndev_get_platdata(&pdev->dev);\r\nif (pdata != NULL)\r\nrtc_write_enable = pdata->rtc_write_enable;\r\nrtc_dd = kzalloc(sizeof(*rtc_dd), GFP_KERNEL);\r\nif (rtc_dd == NULL) {\r\ndev_err(&pdev->dev, "Unable to allocate memory!\n");\r\nreturn -ENOMEM;\r\n}\r\nspin_lock_init(&rtc_dd->ctrl_reg_lock);\r\nrtc_dd->rtc_alarm_irq = platform_get_irq(pdev, 0);\r\nif (rtc_dd->rtc_alarm_irq < 0) {\r\ndev_err(&pdev->dev, "Alarm IRQ resource absent!\n");\r\nrc = -ENXIO;\r\ngoto fail_rtc_enable;\r\n}\r\nrtc_resource = platform_get_resource_byname(pdev, IORESOURCE_IO,\r\n"pmic_rtc_base");\r\nif (!(rtc_resource && rtc_resource->start)) {\r\ndev_err(&pdev->dev, "RTC IO resource absent!\n");\r\nrc = -ENXIO;\r\ngoto fail_rtc_enable;\r\n}\r\nrtc_dd->rtc_base = rtc_resource->start;\r\nrtc_dd->rtc_write_base = rtc_dd->rtc_base + PM8XXX_RTC_WRITE_OFFSET;\r\nrtc_dd->rtc_read_base = rtc_dd->rtc_base + PM8XXX_RTC_READ_OFFSET;\r\nrtc_dd->alarm_rw_base = rtc_dd->rtc_base + PM8XXX_ALARM_RW_OFFSET;\r\nrtc_dd->rtc_dev = &pdev->dev;\r\nrc = pm8xxx_read_wrapper(rtc_dd, &ctrl_reg, rtc_dd->rtc_base, 1);\r\nif (rc < 0) {\r\ndev_err(&pdev->dev, "RTC control register read failed!\n");\r\ngoto fail_rtc_enable;\r\n}\r\nif (!(ctrl_reg & PM8xxx_RTC_ENABLE)) {\r\nctrl_reg |= PM8xxx_RTC_ENABLE;\r\nrc = pm8xxx_write_wrapper(rtc_dd, &ctrl_reg, rtc_dd->rtc_base,\r\n1);\r\nif (rc < 0) {\r\ndev_err(&pdev->dev, "Write to RTC control register "\r\n"failed\n");\r\ngoto fail_rtc_enable;\r\n}\r\n}\r\nrtc_dd->ctrl_reg = ctrl_reg;\r\nif (rtc_write_enable == true)\r\npm8xxx_rtc_ops.set_time = pm8xxx_rtc_set_time;\r\nplatform_set_drvdata(pdev, rtc_dd);\r\nrtc_dd->rtc = rtc_device_register("pm8xxx_rtc", &pdev->dev,\r\n&pm8xxx_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc_dd->rtc)) {\r\ndev_err(&pdev->dev, "%s: RTC registration failed (%ld)\n",\r\n__func__, PTR_ERR(rtc_dd->rtc));\r\nrc = PTR_ERR(rtc_dd->rtc);\r\ngoto fail_rtc_enable;\r\n}\r\nrc = request_any_context_irq(rtc_dd->rtc_alarm_irq,\r\npm8xxx_alarm_trigger, IRQF_TRIGGER_RISING,\r\n"pm8xxx_rtc_alarm", rtc_dd);\r\nif (rc < 0) {\r\ndev_err(&pdev->dev, "Request IRQ failed (%d)\n", rc);\r\ngoto fail_req_irq;\r\n}\r\ndevice_init_wakeup(&pdev->dev, 1);\r\ndev_dbg(&pdev->dev, "Probe success !!\n");\r\nreturn 0;\r\nfail_req_irq:\r\nrtc_device_unregister(rtc_dd->rtc);\r\nfail_rtc_enable:\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(rtc_dd);\r\nreturn rc;\r\n}\r\nstatic int __devexit pm8xxx_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct pm8xxx_rtc *rtc_dd = platform_get_drvdata(pdev);\r\ndevice_init_wakeup(&pdev->dev, 0);\r\nfree_irq(rtc_dd->rtc_alarm_irq, rtc_dd);\r\nrtc_device_unregister(rtc_dd->rtc);\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(rtc_dd);\r\nreturn 0;\r\n}\r\nstatic int pm8xxx_rtc_resume(struct device *dev)\r\n{\r\nstruct pm8xxx_rtc *rtc_dd = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(rtc_dd->rtc_alarm_irq);\r\nreturn 0;\r\n}\r\nstatic int pm8xxx_rtc_suspend(struct device *dev)\r\n{\r\nstruct pm8xxx_rtc *rtc_dd = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(rtc_dd->rtc_alarm_irq);\r\nreturn 0;\r\n}

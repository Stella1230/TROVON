static int ehci_ls1x_reset(struct usb_hcd *hcd)\r\n{\r\nstruct ehci_hcd *ehci = hcd_to_ehci(hcd);\r\nint ret;\r\nehci->caps = hcd->regs;\r\nret = ehci_setup(hcd);\r\nif (ret)\r\nreturn ret;\r\nehci_port_power(ehci, 0);\r\nreturn 0;\r\n}\r\nstatic int ehci_hcd_ls1x_probe(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd;\r\nstruct resource *res;\r\nint irq;\r\nint ret;\r\npr_debug("initializing loongson1 ehci USB Controller\n");\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nres = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev,\r\n"Found HC with no IRQ. Check %s setup!\n",\r\ndev_name(&pdev->dev));\r\nreturn -ENODEV;\r\n}\r\nirq = res->start;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev,\r\n"Found HC with no register addr. Check %s setup!\n",\r\ndev_name(&pdev->dev));\r\nreturn -ENODEV;\r\n}\r\nhcd = usb_create_hcd(&ehci_ls1x_hc_driver, &pdev->dev,\r\ndev_name(&pdev->dev));\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\ndev_dbg(&pdev->dev, "controller already in use\n");\r\nret = -EBUSY;\r\ngoto err_put_hcd;\r\n}\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (hcd->regs == NULL) {\r\ndev_dbg(&pdev->dev, "error mapping memory\n");\r\nret = -EFAULT;\r\ngoto err_release_region;\r\n}\r\nret = usb_add_hcd(hcd, irq, IRQF_DISABLED | IRQF_SHARED);\r\nif (ret)\r\ngoto err_iounmap;\r\nreturn ret;\r\nerr_iounmap:\r\niounmap(hcd->regs);\r\nerr_release_region:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr_put_hcd:\r\nusb_put_hcd(hcd);\r\nreturn ret;\r\n}\r\nstatic int ehci_hcd_ls1x_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_remove_hcd(hcd);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}

static int saa7164_dvb_stop_port(struct saa7164_port *port)\r\n{\r\nstruct saa7164_dev *dev = port->dev;\r\nint ret;\r\nret = saa7164_api_transition_port(port, SAA_DMASTATE_STOP);\r\nif ((ret != SAA_OK) && (ret != SAA_ERR_ALREADY_STOPPED)) {\r\nprintk(KERN_ERR "%s() stop transition failed, ret = 0x%x\n",\r\n__func__, ret);\r\nret = -EIO;\r\n} else {\r\ndprintk(DBGLVL_DVB, "%s() Stopped\n", __func__);\r\nret = 0;\r\n}\r\nreturn ret;\r\n}\r\nstatic int saa7164_dvb_acquire_port(struct saa7164_port *port)\r\n{\r\nstruct saa7164_dev *dev = port->dev;\r\nint ret;\r\nret = saa7164_api_transition_port(port, SAA_DMASTATE_ACQUIRE);\r\nif ((ret != SAA_OK) && (ret != SAA_ERR_ALREADY_STOPPED)) {\r\nprintk(KERN_ERR "%s() acquire transition failed, ret = 0x%x\n",\r\n__func__, ret);\r\nret = -EIO;\r\n} else {\r\ndprintk(DBGLVL_DVB, "%s() Acquired\n", __func__);\r\nret = 0;\r\n}\r\nreturn ret;\r\n}\r\nstatic int saa7164_dvb_pause_port(struct saa7164_port *port)\r\n{\r\nstruct saa7164_dev *dev = port->dev;\r\nint ret;\r\nret = saa7164_api_transition_port(port, SAA_DMASTATE_PAUSE);\r\nif ((ret != SAA_OK) && (ret != SAA_ERR_ALREADY_STOPPED)) {\r\nprintk(KERN_ERR "%s() pause transition failed, ret = 0x%x\n",\r\n__func__, ret);\r\nret = -EIO;\r\n} else {\r\ndprintk(DBGLVL_DVB, "%s() Paused\n", __func__);\r\nret = 0;\r\n}\r\nreturn ret;\r\n}\r\nstatic int saa7164_dvb_stop_streaming(struct saa7164_port *port)\r\n{\r\nstruct saa7164_dev *dev = port->dev;\r\nstruct saa7164_buffer *buf;\r\nstruct list_head *p, *q;\r\nint ret;\r\ndprintk(DBGLVL_DVB, "%s(port=%d)\n", __func__, port->nr);\r\nret = saa7164_dvb_pause_port(port);\r\nret = saa7164_dvb_acquire_port(port);\r\nret = saa7164_dvb_stop_port(port);\r\nmutex_lock(&port->dmaqueue_lock);\r\nlist_for_each_safe(p, q, &port->dmaqueue.list) {\r\nbuf = list_entry(p, struct saa7164_buffer, list);\r\nbuf->flags = SAA7164_BUFFER_FREE;\r\n}\r\nmutex_unlock(&port->dmaqueue_lock);\r\nreturn ret;\r\n}\r\nstatic int saa7164_dvb_start_port(struct saa7164_port *port)\r\n{\r\nstruct saa7164_dev *dev = port->dev;\r\nint ret = 0, result;\r\ndprintk(DBGLVL_DVB, "%s(port=%d)\n", __func__, port->nr);\r\nsaa7164_buffer_cfg_port(port);\r\nresult = saa7164_api_transition_port(port, SAA_DMASTATE_ACQUIRE);\r\nif ((result != SAA_OK) && (result != SAA_ERR_ALREADY_STOPPED)) {\r\nprintk(KERN_ERR "%s() acquire transition failed, res = 0x%x\n",\r\n__func__, result);\r\nresult = saa7164_api_transition_port(port, SAA_DMASTATE_STOP);\r\nif ((result != SAA_OK) && (result != SAA_ERR_ALREADY_STOPPED)) {\r\nprintk(KERN_ERR "%s() acquire/forced stop transition "\r\n"failed, res = 0x%x\n", __func__, result);\r\n}\r\nret = -EIO;\r\ngoto out;\r\n} else\r\ndprintk(DBGLVL_DVB, "%s() Acquired\n", __func__);\r\nresult = saa7164_api_transition_port(port, SAA_DMASTATE_PAUSE);\r\nif ((result != SAA_OK) && (result != SAA_ERR_ALREADY_STOPPED)) {\r\nprintk(KERN_ERR "%s() pause transition failed, res = 0x%x\n",\r\n__func__, result);\r\nresult = saa7164_api_transition_port(port, SAA_DMASTATE_STOP);\r\nif ((result != SAA_OK) && (result != SAA_ERR_ALREADY_STOPPED)) {\r\nprintk(KERN_ERR "%s() pause/forced stop transition "\r\n"failed, res = 0x%x\n", __func__, result);\r\n}\r\nret = -EIO;\r\ngoto out;\r\n} else\r\ndprintk(DBGLVL_DVB, "%s() Paused\n", __func__);\r\nresult = saa7164_api_transition_port(port, SAA_DMASTATE_RUN);\r\nif ((result != SAA_OK) && (result != SAA_ERR_ALREADY_STOPPED)) {\r\nprintk(KERN_ERR "%s() run transition failed, result = 0x%x\n",\r\n__func__, result);\r\nresult = saa7164_api_transition_port(port, SAA_DMASTATE_STOP);\r\nif ((result != SAA_OK) && (result != SAA_ERR_ALREADY_STOPPED)) {\r\nprintk(KERN_ERR "%s() run/forced stop transition "\r\n"failed, res = 0x%x\n", __func__, result);\r\n}\r\nret = -EIO;\r\n} else\r\ndprintk(DBGLVL_DVB, "%s() Running\n", __func__);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int saa7164_dvb_start_feed(struct dvb_demux_feed *feed)\r\n{\r\nstruct dvb_demux *demux = feed->demux;\r\nstruct saa7164_port *port = (struct saa7164_port *) demux->priv;\r\nstruct saa7164_dvb *dvb = &port->dvb;\r\nstruct saa7164_dev *dev = port->dev;\r\nint ret = 0;\r\ndprintk(DBGLVL_DVB, "%s(port=%d)\n", __func__, port->nr);\r\nif (!demux->dmx.frontend)\r\nreturn -EINVAL;\r\nif (dvb) {\r\nmutex_lock(&dvb->lock);\r\nif (dvb->feeding++ == 0) {\r\nret = saa7164_dvb_start_port(port);\r\n}\r\nmutex_unlock(&dvb->lock);\r\ndprintk(DBGLVL_DVB, "%s(port=%d) now feeding = %d\n",\r\n__func__, port->nr, dvb->feeding);\r\n}\r\nreturn ret;\r\n}\r\nstatic int saa7164_dvb_stop_feed(struct dvb_demux_feed *feed)\r\n{\r\nstruct dvb_demux *demux = feed->demux;\r\nstruct saa7164_port *port = (struct saa7164_port *) demux->priv;\r\nstruct saa7164_dvb *dvb = &port->dvb;\r\nstruct saa7164_dev *dev = port->dev;\r\nint ret = 0;\r\ndprintk(DBGLVL_DVB, "%s(port=%d)\n", __func__, port->nr);\r\nif (dvb) {\r\nmutex_lock(&dvb->lock);\r\nif (--dvb->feeding == 0) {\r\nret = saa7164_dvb_stop_streaming(port);\r\n}\r\nmutex_unlock(&dvb->lock);\r\ndprintk(DBGLVL_DVB, "%s(port=%d) now feeding = %d\n",\r\n__func__, port->nr, dvb->feeding);\r\n}\r\nreturn ret;\r\n}\r\nstatic int dvb_register(struct saa7164_port *port)\r\n{\r\nstruct saa7164_dvb *dvb = &port->dvb;\r\nstruct saa7164_dev *dev = port->dev;\r\nstruct saa7164_buffer *buf;\r\nint result, i;\r\ndprintk(DBGLVL_DVB, "%s(port=%d)\n", __func__, port->nr);\r\nif (port->type != SAA7164_MPEG_DVB)\r\nBUG();\r\nif (port->hwcfg.BARLocation == 0) {\r\nresult = -ENOMEM;\r\nprintk(KERN_ERR "%s: dvb_register_adapter failed "\r\n"(errno = %d), NO PCI configuration\n",\r\nDRIVER_NAME, result);\r\ngoto fail_adapter;\r\n}\r\nport->hw_streamingparams.bitspersample = 8;\r\nport->hw_streamingparams.samplesperline = 188;\r\nport->hw_streamingparams.numberoflines =\r\n(SAA7164_TS_NUMBER_OF_LINES * 188) / 188;\r\nport->hw_streamingparams.pitch = 188;\r\nport->hw_streamingparams.linethreshold = 0;\r\nport->hw_streamingparams.pagetablelistvirt = NULL;\r\nport->hw_streamingparams.pagetablelistphys = NULL;\r\nport->hw_streamingparams.numpagetables = 2 +\r\n((SAA7164_TS_NUMBER_OF_LINES * 188) / PAGE_SIZE);\r\nport->hw_streamingparams.numpagetableentries = port->hwcfg.buffercount;\r\nfor (i = 0; i < port->hwcfg.buffercount; i++) {\r\nbuf = saa7164_buffer_alloc(port,\r\nport->hw_streamingparams.numberoflines *\r\nport->hw_streamingparams.pitch);\r\nif (!buf) {\r\nresult = -ENOMEM;\r\nprintk(KERN_ERR "%s: dvb_register_adapter failed "\r\n"(errno = %d), unable to allocate buffers\n",\r\nDRIVER_NAME, result);\r\ngoto fail_adapter;\r\n}\r\nmutex_lock(&port->dmaqueue_lock);\r\nlist_add_tail(&buf->list, &port->dmaqueue.list);\r\nmutex_unlock(&port->dmaqueue_lock);\r\n}\r\nresult = dvb_register_adapter(&dvb->adapter, DRIVER_NAME, THIS_MODULE,\r\n&dev->pci->dev, adapter_nr);\r\nif (result < 0) {\r\nprintk(KERN_ERR "%s: dvb_register_adapter failed "\r\n"(errno = %d)\n", DRIVER_NAME, result);\r\ngoto fail_adapter;\r\n}\r\ndvb->adapter.priv = port;\r\nresult = dvb_register_frontend(&dvb->adapter, dvb->frontend);\r\nif (result < 0) {\r\nprintk(KERN_ERR "%s: dvb_register_frontend failed "\r\n"(errno = %d)\n", DRIVER_NAME, result);\r\ngoto fail_frontend;\r\n}\r\ndvb->demux.dmx.capabilities =\r\nDMX_TS_FILTERING | DMX_SECTION_FILTERING |\r\nDMX_MEMORY_BASED_FILTERING;\r\ndvb->demux.priv = port;\r\ndvb->demux.filternum = 256;\r\ndvb->demux.feednum = 256;\r\ndvb->demux.start_feed = saa7164_dvb_start_feed;\r\ndvb->demux.stop_feed = saa7164_dvb_stop_feed;\r\nresult = dvb_dmx_init(&dvb->demux);\r\nif (result < 0) {\r\nprintk(KERN_ERR "%s: dvb_dmx_init failed (errno = %d)\n",\r\nDRIVER_NAME, result);\r\ngoto fail_dmx;\r\n}\r\ndvb->dmxdev.filternum = 256;\r\ndvb->dmxdev.demux = &dvb->demux.dmx;\r\ndvb->dmxdev.capabilities = 0;\r\nresult = dvb_dmxdev_init(&dvb->dmxdev, &dvb->adapter);\r\nif (result < 0) {\r\nprintk(KERN_ERR "%s: dvb_dmxdev_init failed (errno = %d)\n",\r\nDRIVER_NAME, result);\r\ngoto fail_dmxdev;\r\n}\r\ndvb->fe_hw.source = DMX_FRONTEND_0;\r\nresult = dvb->demux.dmx.add_frontend(&dvb->demux.dmx, &dvb->fe_hw);\r\nif (result < 0) {\r\nprintk(KERN_ERR "%s: add_frontend failed "\r\n"(DMX_FRONTEND_0, errno = %d)\n", DRIVER_NAME, result);\r\ngoto fail_fe_hw;\r\n}\r\ndvb->fe_mem.source = DMX_MEMORY_FE;\r\nresult = dvb->demux.dmx.add_frontend(&dvb->demux.dmx, &dvb->fe_mem);\r\nif (result < 0) {\r\nprintk(KERN_ERR "%s: add_frontend failed "\r\n"(DMX_MEMORY_FE, errno = %d)\n", DRIVER_NAME, result);\r\ngoto fail_fe_mem;\r\n}\r\nresult = dvb->demux.dmx.connect_frontend(&dvb->demux.dmx, &dvb->fe_hw);\r\nif (result < 0) {\r\nprintk(KERN_ERR "%s: connect_frontend failed (errno = %d)\n",\r\nDRIVER_NAME, result);\r\ngoto fail_fe_conn;\r\n}\r\ndvb_net_init(&dvb->adapter, &dvb->net, &dvb->demux.dmx);\r\nreturn 0;\r\nfail_fe_conn:\r\ndvb->demux.dmx.remove_frontend(&dvb->demux.dmx, &dvb->fe_mem);\r\nfail_fe_mem:\r\ndvb->demux.dmx.remove_frontend(&dvb->demux.dmx, &dvb->fe_hw);\r\nfail_fe_hw:\r\ndvb_dmxdev_release(&dvb->dmxdev);\r\nfail_dmxdev:\r\ndvb_dmx_release(&dvb->demux);\r\nfail_dmx:\r\ndvb_unregister_frontend(dvb->frontend);\r\nfail_frontend:\r\ndvb_frontend_detach(dvb->frontend);\r\ndvb_unregister_adapter(&dvb->adapter);\r\nfail_adapter:\r\nreturn result;\r\n}\r\nint saa7164_dvb_unregister(struct saa7164_port *port)\r\n{\r\nstruct saa7164_dvb *dvb = &port->dvb;\r\nstruct saa7164_dev *dev = port->dev;\r\nstruct saa7164_buffer *b;\r\nstruct list_head *c, *n;\r\ndprintk(DBGLVL_DVB, "%s()\n", __func__);\r\nif (port->type != SAA7164_MPEG_DVB)\r\nBUG();\r\nmutex_lock(&port->dmaqueue_lock);\r\nlist_for_each_safe(c, n, &port->dmaqueue.list) {\r\nb = list_entry(c, struct saa7164_buffer, list);\r\nlist_del(c);\r\nsaa7164_buffer_dealloc(b);\r\n}\r\nmutex_unlock(&port->dmaqueue_lock);\r\nif (dvb->frontend == NULL)\r\nreturn 0;\r\ndvb_net_release(&dvb->net);\r\ndvb->demux.dmx.remove_frontend(&dvb->demux.dmx, &dvb->fe_mem);\r\ndvb->demux.dmx.remove_frontend(&dvb->demux.dmx, &dvb->fe_hw);\r\ndvb_dmxdev_release(&dvb->dmxdev);\r\ndvb_dmx_release(&dvb->demux);\r\ndvb_unregister_frontend(dvb->frontend);\r\ndvb_frontend_detach(dvb->frontend);\r\ndvb_unregister_adapter(&dvb->adapter);\r\nreturn 0;\r\n}\r\nint saa7164_dvb_register(struct saa7164_port *port)\r\n{\r\nstruct saa7164_dev *dev = port->dev;\r\nstruct saa7164_dvb *dvb = &port->dvb;\r\nstruct saa7164_i2c *i2c_bus = NULL;\r\nint ret;\r\ndprintk(DBGLVL_DVB, "%s()\n", __func__);\r\nswitch (dev->board) {\r\ncase SAA7164_BOARD_HAUPPAUGE_HVR2200:\r\ncase SAA7164_BOARD_HAUPPAUGE_HVR2200_2:\r\ncase SAA7164_BOARD_HAUPPAUGE_HVR2200_3:\r\ncase SAA7164_BOARD_HAUPPAUGE_HVR2200_4:\r\ncase SAA7164_BOARD_HAUPPAUGE_HVR2200_5:\r\ni2c_bus = &dev->i2c_bus[port->nr + 1];\r\nswitch (port->nr) {\r\ncase 0:\r\nport->dvb.frontend = dvb_attach(tda10048_attach,\r\n&hauppauge_hvr2200_1_config,\r\n&i2c_bus->i2c_adap);\r\nif (port->dvb.frontend != NULL) {\r\ndvb_attach(tda18271_attach, port->dvb.frontend,\r\n0xc0 >> 1, &i2c_bus->i2c_adap,\r\n&hauppauge_hvr22x0_tuner_config);\r\n}\r\nbreak;\r\ncase 1:\r\nport->dvb.frontend = dvb_attach(tda10048_attach,\r\n&hauppauge_hvr2200_2_config,\r\n&i2c_bus->i2c_adap);\r\nif (port->dvb.frontend != NULL) {\r\ndvb_attach(tda18271_attach, port->dvb.frontend,\r\n0xc0 >> 1, &i2c_bus->i2c_adap,\r\n&hauppauge_hvr22x0s_tuner_config);\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase SAA7164_BOARD_HAUPPAUGE_HVR2250:\r\ncase SAA7164_BOARD_HAUPPAUGE_HVR2250_2:\r\ncase SAA7164_BOARD_HAUPPAUGE_HVR2250_3:\r\ni2c_bus = &dev->i2c_bus[port->nr + 1];\r\nport->dvb.frontend = dvb_attach(s5h1411_attach,\r\n&hauppauge_s5h1411_config,\r\n&i2c_bus->i2c_adap);\r\nif (port->dvb.frontend != NULL) {\r\nif (port->nr == 0) {\r\ndvb_attach(tda18271_attach, port->dvb.frontend,\r\n0xc0 >> 1, &i2c_bus->i2c_adap,\r\n&hauppauge_hvr22x0_tuner_config);\r\n} else {\r\ndvb_attach(tda18271_attach, port->dvb.frontend,\r\n0xc0 >> 1, &i2c_bus->i2c_adap,\r\n&hauppauge_hvr22x0s_tuner_config);\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s: The frontend isn't supported\n",\r\ndev->name);\r\nbreak;\r\n}\r\nif (NULL == dvb->frontend) {\r\nprintk(KERN_ERR "%s() Frontend initialization failed\n",\r\n__func__);\r\nreturn -1;\r\n}\r\nret = dvb_register(port);\r\nif (ret < 0) {\r\nif (dvb->frontend->ops.release)\r\ndvb->frontend->ops.release(dvb->frontend);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

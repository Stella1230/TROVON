int\r\nnouveau_notifier_init_channel(struct nouveau_channel *chan)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_bo *ntfy = NULL;\r\nuint32_t flags, ttmpl;\r\nint ret;\r\nif (nouveau_vram_notify) {\r\nflags = NOUVEAU_GEM_DOMAIN_VRAM;\r\nttmpl = TTM_PL_FLAG_VRAM;\r\n} else {\r\nflags = NOUVEAU_GEM_DOMAIN_GART;\r\nttmpl = TTM_PL_FLAG_TT;\r\n}\r\nret = nouveau_gem_new(dev, PAGE_SIZE, 0, flags, 0, 0, &ntfy);\r\nif (ret)\r\nreturn ret;\r\nret = nouveau_bo_pin(ntfy, ttmpl);\r\nif (ret)\r\ngoto out_err;\r\nret = nouveau_bo_map(ntfy);\r\nif (ret)\r\ngoto out_err;\r\nif (dev_priv->card_type >= NV_50) {\r\nret = nouveau_bo_vma_add(ntfy, chan->vm, &chan->notifier_vma);\r\nif (ret)\r\ngoto out_err;\r\n}\r\nret = drm_mm_init(&chan->notifier_heap, 0, ntfy->bo.mem.size);\r\nif (ret)\r\ngoto out_err;\r\nchan->notifier_bo = ntfy;\r\nout_err:\r\nif (ret) {\r\nnouveau_bo_vma_del(ntfy, &chan->notifier_vma);\r\ndrm_gem_object_unreference_unlocked(ntfy->gem);\r\n}\r\nreturn ret;\r\n}\r\nvoid\r\nnouveau_notifier_takedown_channel(struct nouveau_channel *chan)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nif (!chan->notifier_bo)\r\nreturn;\r\nnouveau_bo_vma_del(chan->notifier_bo, &chan->notifier_vma);\r\nnouveau_bo_unmap(chan->notifier_bo);\r\nmutex_lock(&dev->struct_mutex);\r\nnouveau_bo_unpin(chan->notifier_bo);\r\nmutex_unlock(&dev->struct_mutex);\r\ndrm_gem_object_unreference_unlocked(chan->notifier_bo->gem);\r\ndrm_mm_takedown(&chan->notifier_heap);\r\n}\r\nstatic void\r\nnouveau_notifier_gpuobj_dtor(struct drm_device *dev,\r\nstruct nouveau_gpuobj *gpuobj)\r\n{\r\nNV_DEBUG(dev, "\n");\r\nif (gpuobj->priv)\r\ndrm_mm_put_block(gpuobj->priv);\r\n}\r\nint\r\nnouveau_notifier_alloc(struct nouveau_channel *chan, uint32_t handle,\r\nint size, uint32_t start, uint32_t end,\r\nuint32_t *b_offset)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_gpuobj *nobj = NULL;\r\nstruct drm_mm_node *mem;\r\nuint64_t offset;\r\nint target, ret;\r\nmem = drm_mm_search_free_in_range(&chan->notifier_heap, size, 0,\r\nstart, end, 0);\r\nif (mem)\r\nmem = drm_mm_get_block_range(mem, size, 0, start, end);\r\nif (!mem) {\r\nNV_ERROR(dev, "Channel %d notifier block full\n", chan->id);\r\nreturn -ENOMEM;\r\n}\r\nif (dev_priv->card_type < NV_50) {\r\nif (chan->notifier_bo->bo.mem.mem_type == TTM_PL_VRAM)\r\ntarget = NV_MEM_TARGET_VRAM;\r\nelse\r\ntarget = NV_MEM_TARGET_GART;\r\noffset = chan->notifier_bo->bo.offset;\r\n} else {\r\ntarget = NV_MEM_TARGET_VM;\r\noffset = chan->notifier_vma.offset;\r\n}\r\noffset += mem->start;\r\nret = nouveau_gpuobj_dma_new(chan, NV_CLASS_DMA_IN_MEMORY, offset,\r\nmem->size, NV_MEM_ACCESS_RW, target,\r\n&nobj);\r\nif (ret) {\r\ndrm_mm_put_block(mem);\r\nNV_ERROR(dev, "Error creating notifier ctxdma: %d\n", ret);\r\nreturn ret;\r\n}\r\nnobj->dtor = nouveau_notifier_gpuobj_dtor;\r\nnobj->priv = mem;\r\nret = nouveau_ramht_insert(chan, handle, nobj);\r\nnouveau_gpuobj_ref(NULL, &nobj);\r\nif (ret) {\r\ndrm_mm_put_block(mem);\r\nNV_ERROR(dev, "Error adding notifier to ramht: %d\n", ret);\r\nreturn ret;\r\n}\r\n*b_offset = mem->start;\r\nreturn 0;\r\n}\r\nint\r\nnouveau_notifier_offset(struct nouveau_gpuobj *nobj, uint32_t *poffset)\r\n{\r\nif (!nobj || nobj->dtor != nouveau_notifier_gpuobj_dtor)\r\nreturn -EINVAL;\r\nif (poffset) {\r\nstruct drm_mm_node *mem = nobj->priv;\r\nif (*poffset >= mem->size)\r\nreturn false;\r\n*poffset += mem->start;\r\n}\r\nreturn 0;\r\n}\r\nint\r\nnouveau_ioctl_notifier_alloc(struct drm_device *dev, void *data,\r\nstruct drm_file *file_priv)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct drm_nouveau_notifierobj_alloc *na = data;\r\nstruct nouveau_channel *chan;\r\nint ret;\r\nif (unlikely(dev_priv->card_type >= NV_C0))\r\nreturn -EINVAL;\r\nchan = nouveau_channel_get(file_priv, na->channel);\r\nif (IS_ERR(chan))\r\nreturn PTR_ERR(chan);\r\nret = nouveau_notifier_alloc(chan, na->handle, na->size, 0, 0x1000,\r\n&na->offset);\r\nnouveau_channel_put(&chan);\r\nreturn ret;\r\n}

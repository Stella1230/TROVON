static void rdc321x_wdt_trigger(unsigned long unused)\r\n{\r\nunsigned long flags;\r\nu32 val;\r\nif (rdc321x_wdt_device.running)\r\nticks--;\r\nspin_lock_irqsave(&rdc321x_wdt_device.lock, flags);\r\npci_read_config_dword(rdc321x_wdt_device.sb_pdev,\r\nrdc321x_wdt_device.base_reg, &val);\r\nval |= RDC_WDT_EN;\r\npci_write_config_dword(rdc321x_wdt_device.sb_pdev,\r\nrdc321x_wdt_device.base_reg, val);\r\nspin_unlock_irqrestore(&rdc321x_wdt_device.lock, flags);\r\nif (rdc321x_wdt_device.queue && ticks)\r\nmod_timer(&rdc321x_wdt_device.timer,\r\njiffies + RDC_WDT_INTERVAL);\r\nelse {\r\ncomplete(&rdc321x_wdt_device.stop);\r\n}\r\n}\r\nstatic void rdc321x_wdt_reset(void)\r\n{\r\nticks = rdc321x_wdt_device.default_ticks;\r\n}\r\nstatic void rdc321x_wdt_start(void)\r\n{\r\nunsigned long flags;\r\nif (!rdc321x_wdt_device.queue) {\r\nrdc321x_wdt_device.queue = 1;\r\nspin_lock_irqsave(&rdc321x_wdt_device.lock, flags);\r\npci_write_config_dword(rdc321x_wdt_device.sb_pdev,\r\nrdc321x_wdt_device.base_reg, RDC_CLS_TMR);\r\npci_write_config_dword(rdc321x_wdt_device.sb_pdev,\r\nrdc321x_wdt_device.base_reg,\r\nRDC_WDT_EN | RDC_WDT_CNT);\r\nspin_unlock_irqrestore(&rdc321x_wdt_device.lock, flags);\r\nmod_timer(&rdc321x_wdt_device.timer,\r\njiffies + RDC_WDT_INTERVAL);\r\n}\r\nrdc321x_wdt_device.running++;\r\n}\r\nstatic int rdc321x_wdt_stop(void)\r\n{\r\nif (rdc321x_wdt_device.running)\r\nrdc321x_wdt_device.running = 0;\r\nticks = rdc321x_wdt_device.default_ticks;\r\nreturn -EIO;\r\n}\r\nstatic int rdc321x_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &rdc321x_wdt_device.inuse))\r\nreturn -EBUSY;\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int rdc321x_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nclear_bit(0, &rdc321x_wdt_device.inuse);\r\nreturn 0;\r\n}\r\nstatic long rdc321x_wdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nvoid __user *argp = (void __user *)arg;\r\nu32 value;\r\nstatic const struct watchdog_info ident = {\r\n.options = WDIOF_CARDRESET,\r\n.identity = "RDC321x WDT",\r\n};\r\nunsigned long flags;\r\nswitch (cmd) {\r\ncase WDIOC_KEEPALIVE:\r\nrdc321x_wdt_reset();\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\nspin_lock_irqsave(&rdc321x_wdt_device.lock, flags);\r\npci_read_config_dword(rdc321x_wdt_device.sb_pdev,\r\nrdc321x_wdt_device.base_reg, &value);\r\nspin_unlock_irqrestore(&rdc321x_wdt_device.lock, flags);\r\nif (copy_to_user(argp, &value, sizeof(u32)))\r\nreturn -EFAULT;\r\nbreak;\r\ncase WDIOC_GETSUPPORT:\r\nif (copy_to_user(argp, &ident, sizeof(ident)))\r\nreturn -EFAULT;\r\nbreak;\r\ncase WDIOC_SETOPTIONS:\r\nif (copy_from_user(&value, argp, sizeof(int)))\r\nreturn -EFAULT;\r\nswitch (value) {\r\ncase WDIOS_ENABLECARD:\r\nrdc321x_wdt_start();\r\nbreak;\r\ncase WDIOS_DISABLECARD:\r\nreturn rdc321x_wdt_stop();\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t rdc321x_wdt_write(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nif (!count)\r\nreturn -EIO;\r\nrdc321x_wdt_reset();\r\nreturn count;\r\n}\r\nstatic int __devinit rdc321x_wdt_probe(struct platform_device *pdev)\r\n{\r\nint err;\r\nstruct resource *r;\r\nstruct rdc321x_wdt_pdata *pdata;\r\npdata = pdev->dev.platform_data;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "no platform data supplied\n");\r\nreturn -ENODEV;\r\n}\r\nr = platform_get_resource_byname(pdev, IORESOURCE_IO, "wdt-reg");\r\nif (!r) {\r\ndev_err(&pdev->dev, "failed to get wdt-reg resource\n");\r\nreturn -ENODEV;\r\n}\r\nrdc321x_wdt_device.sb_pdev = pdata->sb_pdev;\r\nrdc321x_wdt_device.base_reg = r->start;\r\nerr = misc_register(&rdc321x_wdt_misc);\r\nif (err < 0) {\r\ndev_err(&pdev->dev, "misc_register failed\n");\r\nreturn err;\r\n}\r\nspin_lock_init(&rdc321x_wdt_device.lock);\r\npci_write_config_dword(rdc321x_wdt_device.sb_pdev,\r\nrdc321x_wdt_device.base_reg, RDC_WDT_RST);\r\ninit_completion(&rdc321x_wdt_device.stop);\r\nrdc321x_wdt_device.queue = 0;\r\nclear_bit(0, &rdc321x_wdt_device.inuse);\r\nsetup_timer(&rdc321x_wdt_device.timer, rdc321x_wdt_trigger, 0);\r\nrdc321x_wdt_device.default_ticks = ticks;\r\ndev_info(&pdev->dev, "watchdog init success\n");\r\nreturn 0;\r\n}\r\nstatic int __devexit rdc321x_wdt_remove(struct platform_device *pdev)\r\n{\r\nif (rdc321x_wdt_device.queue) {\r\nrdc321x_wdt_device.queue = 0;\r\nwait_for_completion(&rdc321x_wdt_device.stop);\r\n}\r\nmisc_deregister(&rdc321x_wdt_misc);\r\nreturn 0;\r\n}

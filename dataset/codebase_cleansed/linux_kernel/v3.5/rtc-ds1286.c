static inline u8 ds1286_rtc_read(struct ds1286_priv *priv, int reg)\r\n{\r\nreturn __raw_readl(&priv->rtcregs[reg]) & 0xff;\r\n}\r\nstatic inline void ds1286_rtc_write(struct ds1286_priv *priv, u8 data, int reg)\r\n{\r\n__raw_writel(data, &priv->rtcregs[reg]);\r\n}\r\nstatic int ds1286_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct ds1286_priv *priv = dev_get_drvdata(dev);\r\nunsigned long flags;\r\nunsigned char val;\r\nspin_lock_irqsave(&priv->lock, flags);\r\nval = ds1286_rtc_read(priv, RTC_CMD);\r\nif (enabled)\r\nval &= ~RTC_TDM;\r\nelse\r\nval |= RTC_TDM;\r\nds1286_rtc_write(priv, val, RTC_CMD);\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int ds1286_ioctl(struct device *dev, unsigned int cmd, unsigned long arg)\r\n{\r\nstruct ds1286_priv *priv = dev_get_drvdata(dev);\r\nunsigned long flags;\r\nunsigned char val;\r\nswitch (cmd) {\r\ncase RTC_WIE_OFF:\r\nspin_lock_irqsave(&priv->lock, flags);\r\nval = ds1286_rtc_read(priv, RTC_CMD);\r\nval |= RTC_WAM;\r\nds1286_rtc_write(priv, val, RTC_CMD);\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nbreak;\r\ncase RTC_WIE_ON:\r\nspin_lock_irqsave(&priv->lock, flags);\r\nval = ds1286_rtc_read(priv, RTC_CMD);\r\nval &= ~RTC_WAM;\r\nds1286_rtc_write(priv, val, RTC_CMD);\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nbreak;\r\ndefault:\r\nreturn -ENOIOCTLCMD;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ds1286_proc(struct device *dev, struct seq_file *seq)\r\n{\r\nstruct ds1286_priv *priv = dev_get_drvdata(dev);\r\nunsigned char month, cmd, amode;\r\nconst char *s;\r\nmonth = ds1286_rtc_read(priv, RTC_MONTH);\r\nseq_printf(seq,\r\n"oscillator\t: %s\n"\r\n"square_wave\t: %s\n",\r\n(month & RTC_EOSC) ? "disabled" : "enabled",\r\n(month & RTC_ESQW) ? "disabled" : "enabled");\r\namode = ((ds1286_rtc_read(priv, RTC_MINUTES_ALARM) & 0x80) >> 5) |\r\n((ds1286_rtc_read(priv, RTC_HOURS_ALARM) & 0x80) >> 6) |\r\n((ds1286_rtc_read(priv, RTC_DAY_ALARM) & 0x80) >> 7);\r\nswitch (amode) {\r\ncase 7:\r\ns = "each minute";\r\nbreak;\r\ncase 3:\r\ns = "minutes match";\r\nbreak;\r\ncase 1:\r\ns = "hours and minutes match";\r\nbreak;\r\ncase 0:\r\ns = "days, hours and minutes match";\r\nbreak;\r\ndefault:\r\ns = "invalid";\r\nbreak;\r\n}\r\nseq_printf(seq, "alarm_mode\t: %s\n", s);\r\ncmd = ds1286_rtc_read(priv, RTC_CMD);\r\nseq_printf(seq,\r\n"alarm_enable\t: %s\n"\r\n"wdog_alarm\t: %s\n"\r\n"alarm_mask\t: %s\n"\r\n"wdog_alarm_mask\t: %s\n"\r\n"interrupt_mode\t: %s\n"\r\n"INTB_mode\t: %s_active\n"\r\n"interrupt_pins\t: %s\n",\r\n(cmd & RTC_TDF) ? "yes" : "no",\r\n(cmd & RTC_WAF) ? "yes" : "no",\r\n(cmd & RTC_TDM) ? "disabled" : "enabled",\r\n(cmd & RTC_WAM) ? "disabled" : "enabled",\r\n(cmd & RTC_PU_LVL) ? "pulse" : "level",\r\n(cmd & RTC_IBH_LO) ? "low" : "high",\r\n(cmd & RTC_IPSW) ? "unswapped" : "swapped");\r\nreturn 0;\r\n}\r\nstatic int ds1286_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct ds1286_priv *priv = dev_get_drvdata(dev);\r\nunsigned char save_control;\r\nunsigned long flags;\r\nunsigned long uip_watchdog = jiffies;\r\nif (ds1286_rtc_read(priv, RTC_CMD) & RTC_TE)\r\nwhile (time_before(jiffies, uip_watchdog + 2*HZ/100))\r\nbarrier();\r\nspin_lock_irqsave(&priv->lock, flags);\r\nsave_control = ds1286_rtc_read(priv, RTC_CMD);\r\nds1286_rtc_write(priv, (save_control|RTC_TE), RTC_CMD);\r\ntm->tm_sec = ds1286_rtc_read(priv, RTC_SECONDS);\r\ntm->tm_min = ds1286_rtc_read(priv, RTC_MINUTES);\r\ntm->tm_hour = ds1286_rtc_read(priv, RTC_HOURS) & 0x3f;\r\ntm->tm_mday = ds1286_rtc_read(priv, RTC_DATE);\r\ntm->tm_mon = ds1286_rtc_read(priv, RTC_MONTH) & 0x1f;\r\ntm->tm_year = ds1286_rtc_read(priv, RTC_YEAR);\r\nds1286_rtc_write(priv, save_control, RTC_CMD);\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\ntm->tm_sec = bcd2bin(tm->tm_sec);\r\ntm->tm_min = bcd2bin(tm->tm_min);\r\ntm->tm_hour = bcd2bin(tm->tm_hour);\r\ntm->tm_mday = bcd2bin(tm->tm_mday);\r\ntm->tm_mon = bcd2bin(tm->tm_mon);\r\ntm->tm_year = bcd2bin(tm->tm_year);\r\nif (tm->tm_year < 45)\r\ntm->tm_year += 30;\r\ntm->tm_year += 40;\r\nif (tm->tm_year < 70)\r\ntm->tm_year += 100;\r\ntm->tm_mon--;\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int ds1286_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct ds1286_priv *priv = dev_get_drvdata(dev);\r\nunsigned char mon, day, hrs, min, sec;\r\nunsigned char save_control;\r\nunsigned int yrs;\r\nunsigned long flags;\r\nyrs = tm->tm_year + 1900;\r\nmon = tm->tm_mon + 1;\r\nday = tm->tm_mday;\r\nhrs = tm->tm_hour;\r\nmin = tm->tm_min;\r\nsec = tm->tm_sec;\r\nif (yrs < 1970)\r\nreturn -EINVAL;\r\nyrs -= 1940;\r\nif (yrs > 255)\r\nreturn -EINVAL;\r\nif (yrs >= 100)\r\nyrs -= 100;\r\nsec = bin2bcd(sec);\r\nmin = bin2bcd(min);\r\nhrs = bin2bcd(hrs);\r\nday = bin2bcd(day);\r\nmon = bin2bcd(mon);\r\nyrs = bin2bcd(yrs);\r\nspin_lock_irqsave(&priv->lock, flags);\r\nsave_control = ds1286_rtc_read(priv, RTC_CMD);\r\nds1286_rtc_write(priv, (save_control|RTC_TE), RTC_CMD);\r\nds1286_rtc_write(priv, yrs, RTC_YEAR);\r\nds1286_rtc_write(priv, mon, RTC_MONTH);\r\nds1286_rtc_write(priv, day, RTC_DATE);\r\nds1286_rtc_write(priv, hrs, RTC_HOURS);\r\nds1286_rtc_write(priv, min, RTC_MINUTES);\r\nds1286_rtc_write(priv, sec, RTC_SECONDS);\r\nds1286_rtc_write(priv, 0, RTC_HUNDREDTH_SECOND);\r\nds1286_rtc_write(priv, save_control, RTC_CMD);\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int ds1286_read_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nstruct ds1286_priv *priv = dev_get_drvdata(dev);\r\nunsigned char cmd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&priv->lock, flags);\r\nalm->time.tm_min = ds1286_rtc_read(priv, RTC_MINUTES_ALARM) & 0x7f;\r\nalm->time.tm_hour = ds1286_rtc_read(priv, RTC_HOURS_ALARM) & 0x1f;\r\nalm->time.tm_wday = ds1286_rtc_read(priv, RTC_DAY_ALARM) & 0x07;\r\ncmd = ds1286_rtc_read(priv, RTC_CMD);\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nalm->time.tm_min = bcd2bin(alm->time.tm_min);\r\nalm->time.tm_hour = bcd2bin(alm->time.tm_hour);\r\nalm->time.tm_sec = 0;\r\nreturn 0;\r\n}\r\nstatic int ds1286_set_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nstruct ds1286_priv *priv = dev_get_drvdata(dev);\r\nunsigned char hrs, min, sec;\r\nhrs = alm->time.tm_hour;\r\nmin = alm->time.tm_min;\r\nsec = alm->time.tm_sec;\r\nif (hrs >= 24)\r\nhrs = 0xff;\r\nif (min >= 60)\r\nmin = 0xff;\r\nif (sec != 0)\r\nreturn -EINVAL;\r\nmin = bin2bcd(min);\r\nhrs = bin2bcd(hrs);\r\nspin_lock(&priv->lock);\r\nds1286_rtc_write(priv, hrs, RTC_HOURS_ALARM);\r\nds1286_rtc_write(priv, min, RTC_MINUTES_ALARM);\r\nspin_unlock(&priv->lock);\r\nreturn 0;\r\n}\r\nstatic int __devinit ds1286_probe(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc;\r\nstruct resource *res;\r\nstruct ds1286_priv *priv;\r\nint ret = 0;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\npriv = kzalloc(sizeof(struct ds1286_priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->size = resource_size(res);\r\nif (!request_mem_region(res->start, priv->size, pdev->name)) {\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\npriv->baseaddr = res->start;\r\npriv->rtcregs = ioremap(priv->baseaddr, priv->size);\r\nif (!priv->rtcregs) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nspin_lock_init(&priv->lock);\r\nplatform_set_drvdata(pdev, priv);\r\nrtc = rtc_device_register("ds1286", &pdev->dev,\r\n&ds1286_ops, THIS_MODULE);\r\nif (IS_ERR(rtc)) {\r\nret = PTR_ERR(rtc);\r\ngoto out;\r\n}\r\npriv->rtc = rtc;\r\nreturn 0;\r\nout:\r\nif (priv->rtc)\r\nrtc_device_unregister(priv->rtc);\r\nif (priv->rtcregs)\r\niounmap(priv->rtcregs);\r\nif (priv->baseaddr)\r\nrelease_mem_region(priv->baseaddr, priv->size);\r\nkfree(priv);\r\nreturn ret;\r\n}\r\nstatic int __devexit ds1286_remove(struct platform_device *pdev)\r\n{\r\nstruct ds1286_priv *priv = platform_get_drvdata(pdev);\r\nrtc_device_unregister(priv->rtc);\r\niounmap(priv->rtcregs);\r\nrelease_mem_region(priv->baseaddr, priv->size);\r\nkfree(priv);\r\nreturn 0;\r\n}

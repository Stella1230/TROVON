unsigned long probe_irq_on(void)\r\n{\r\nstruct irq_desc *desc;\r\nunsigned long mask = 0;\r\nint i;\r\nasync_synchronize_full();\r\nmutex_lock(&probing_active);\r\nfor_each_irq_desc_reverse(i, desc) {\r\nraw_spin_lock_irq(&desc->lock);\r\nif (!desc->action && irq_settings_can_probe(desc)) {\r\nif (desc->irq_data.chip->irq_set_type)\r\ndesc->irq_data.chip->irq_set_type(&desc->irq_data,\r\nIRQ_TYPE_PROBE);\r\nirq_startup(desc, false);\r\n}\r\nraw_spin_unlock_irq(&desc->lock);\r\n}\r\nmsleep(20);\r\nfor_each_irq_desc_reverse(i, desc) {\r\nraw_spin_lock_irq(&desc->lock);\r\nif (!desc->action && irq_settings_can_probe(desc)) {\r\ndesc->istate |= IRQS_AUTODETECT | IRQS_WAITING;\r\nif (irq_startup(desc, false))\r\ndesc->istate |= IRQS_PENDING;\r\n}\r\nraw_spin_unlock_irq(&desc->lock);\r\n}\r\nmsleep(100);\r\nfor_each_irq_desc(i, desc) {\r\nraw_spin_lock_irq(&desc->lock);\r\nif (desc->istate & IRQS_AUTODETECT) {\r\nif (!(desc->istate & IRQS_WAITING)) {\r\ndesc->istate &= ~IRQS_AUTODETECT;\r\nirq_shutdown(desc);\r\n} else\r\nif (i < 32)\r\nmask |= 1 << i;\r\n}\r\nraw_spin_unlock_irq(&desc->lock);\r\n}\r\nreturn mask;\r\n}\r\nunsigned int probe_irq_mask(unsigned long val)\r\n{\r\nunsigned int mask = 0;\r\nstruct irq_desc *desc;\r\nint i;\r\nfor_each_irq_desc(i, desc) {\r\nraw_spin_lock_irq(&desc->lock);\r\nif (desc->istate & IRQS_AUTODETECT) {\r\nif (i < 16 && !(desc->istate & IRQS_WAITING))\r\nmask |= 1 << i;\r\ndesc->istate &= ~IRQS_AUTODETECT;\r\nirq_shutdown(desc);\r\n}\r\nraw_spin_unlock_irq(&desc->lock);\r\n}\r\nmutex_unlock(&probing_active);\r\nreturn mask & val;\r\n}\r\nint probe_irq_off(unsigned long val)\r\n{\r\nint i, irq_found = 0, nr_of_irqs = 0;\r\nstruct irq_desc *desc;\r\nfor_each_irq_desc(i, desc) {\r\nraw_spin_lock_irq(&desc->lock);\r\nif (desc->istate & IRQS_AUTODETECT) {\r\nif (!(desc->istate & IRQS_WAITING)) {\r\nif (!nr_of_irqs)\r\nirq_found = i;\r\nnr_of_irqs++;\r\n}\r\ndesc->istate &= ~IRQS_AUTODETECT;\r\nirq_shutdown(desc);\r\n}\r\nraw_spin_unlock_irq(&desc->lock);\r\n}\r\nmutex_unlock(&probing_active);\r\nif (nr_of_irqs > 1)\r\nirq_found = -irq_found;\r\nreturn irq_found;\r\n}

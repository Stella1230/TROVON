static int initialize_otg_port(struct platform_device *pdev)\r\n{\r\nu32 v;\r\nvoid __iomem *usb_base;\r\nvoid __iomem *usbother_base;\r\nusb_base = ioremap(MX51_USB_OTG_BASE_ADDR, SZ_4K);\r\nif (!usb_base)\r\nreturn -ENOMEM;\r\nusbother_base = (void __iomem *)(usb_base + MX5_USBOTHER_REGS_OFFSET);\r\nv = __raw_readl(usbother_base + MXC_USB_PHY_CTR_FUNC2_OFFSET);\r\nv &= ~MX5_USB_UTMI_PHYCTRL1_PLLDIV_MASK;\r\nv |= MX51_USB_PLL_DIV_19_2_MHZ;\r\n__raw_writel(v, usbother_base + MXC_USB_PHY_CTR_FUNC2_OFFSET);\r\niounmap(usb_base);\r\nmdelay(10);\r\nreturn mx51_initialize_usb_hw(pdev->id, MXC_EHCI_INTERNAL_PHY);\r\n}\r\nstatic int initialize_usbh1_port(struct platform_device *pdev)\r\n{\r\niomux_v3_cfg_t usbh1stp = MX51_PAD_USBH1_STP__USBH1_STP;\r\niomux_v3_cfg_t usbh1gpio = MX51_PAD_USBH1_STP__GPIO1_27;\r\nu32 v;\r\nvoid __iomem *usb_base;\r\nvoid __iomem *socregs_base;\r\nmxc_iomux_v3_setup_pad(usbh1gpio);\r\ngpio_request(EFIKAMX_USBH1_STP, "usbh1_stp");\r\ngpio_direction_output(EFIKAMX_USBH1_STP, 0);\r\nmsleep(1);\r\ngpio_set_value(EFIKAMX_USBH1_STP, 1);\r\nmsleep(1);\r\nusb_base = ioremap(MX51_USB_OTG_BASE_ADDR, SZ_4K);\r\nsocregs_base = (void __iomem *)(usb_base + MX5_USBOTHER_REGS_OFFSET);\r\nv = __raw_readl(socregs_base + MX51_USB_CTRL_1_OFFSET);\r\n__raw_writel(v | MX51_USB_CTRL_UH1_EXT_CLK_EN,\r\nsocregs_base + MX51_USB_CTRL_1_OFFSET);\r\niounmap(usb_base);\r\ngpio_free(EFIKAMX_USBH1_STP);\r\nmxc_iomux_v3_setup_pad(usbh1stp);\r\nmdelay(10);\r\nreturn mx51_initialize_usb_hw(pdev->id, MXC_EHCI_ITC_NO_THRESHOLD);\r\n}\r\nstatic void mx51_efika_hubreset(void)\r\n{\r\ngpio_request(EFIKAMX_USB_HUB_RESET, "usb_hub_rst");\r\ngpio_direction_output(EFIKAMX_USB_HUB_RESET, 1);\r\nmsleep(1);\r\ngpio_set_value(EFIKAMX_USB_HUB_RESET, 0);\r\nmsleep(1);\r\ngpio_set_value(EFIKAMX_USB_HUB_RESET, 1);\r\n}\r\nstatic void __init mx51_efika_usb(void)\r\n{\r\nmx51_efika_hubreset();\r\ngpio_request(EFIKA_USB_PHY_RESET, "usb_phy_reset");\r\ngpio_direction_output(EFIKA_USB_PHY_RESET, 0);\r\nmsleep(1);\r\ngpio_set_value(EFIKA_USB_PHY_RESET, 1);\r\nusbh1_config.otg = imx_otg_ulpi_create(ULPI_OTG_DRVVBUS |\r\nULPI_OTG_DRVVBUS_EXT | ULPI_OTG_EXTVBUSIND);\r\nimx51_add_mxc_ehci_otg(&dr_utmi_config);\r\nif (usbh1_config.otg)\r\nimx51_add_mxc_ehci_hs(1, &usbh1_config);\r\n}\r\nvoid __init efika_board_common_init(void)\r\n{\r\nmxc_iomux_v3_setup_multiple_pads(mx51efika_pads,\r\nARRAY_SIZE(mx51efika_pads));\r\nimx51_add_imx_uart(0, &uart_pdata);\r\nmx51_efika_usb();\r\nif (mx51_revision() < IMX_CHIP_REVISION_2_0)\r\nsw2_init.constraints.state_mem.uV = 1100000;\r\nelse if (mx51_revision() == IMX_CHIP_REVISION_2_0) {\r\nsw2_init.constraints.state_mem.uV = 1250000;\r\nsw1_init.constraints.state_mem.uV = 1000000;\r\n}\r\nif (machine_is_mx51_efikasb())\r\nvgen1_init.constraints.max_uV = 1200000;\r\ngpio_request(EFIKAMX_PMIC, "pmic irq");\r\ngpio_direction_input(EFIKAMX_PMIC);\r\nspi_register_board_info(mx51_efika_spi_board_info,\r\nARRAY_SIZE(mx51_efika_spi_board_info));\r\nimx51_add_ecspi(0, &mx51_efika_spi_pdata);\r\nimx51_add_pata_imx();\r\n#if defined(CONFIG_CPU_FREQ_IMX)\r\nget_cpu_op = mx51_get_cpu_op;\r\n#endif\r\n}

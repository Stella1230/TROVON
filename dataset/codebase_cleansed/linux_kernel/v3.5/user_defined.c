int user_instantiate(struct key *key, const void *data, size_t datalen)\r\n{\r\nstruct user_key_payload *upayload;\r\nint ret;\r\nret = -EINVAL;\r\nif (datalen <= 0 || datalen > 32767 || !data)\r\ngoto error;\r\nret = key_payload_reserve(key, datalen);\r\nif (ret < 0)\r\ngoto error;\r\nret = -ENOMEM;\r\nupayload = kmalloc(sizeof(*upayload) + datalen, GFP_KERNEL);\r\nif (!upayload)\r\ngoto error;\r\nupayload->datalen = datalen;\r\nmemcpy(upayload->data, data, datalen);\r\nrcu_assign_keypointer(key, upayload);\r\nret = 0;\r\nerror:\r\nreturn ret;\r\n}\r\nint user_update(struct key *key, const void *data, size_t datalen)\r\n{\r\nstruct user_key_payload *upayload, *zap;\r\nint ret;\r\nret = -EINVAL;\r\nif (datalen <= 0 || datalen > 32767 || !data)\r\ngoto error;\r\nret = -ENOMEM;\r\nupayload = kmalloc(sizeof(*upayload) + datalen, GFP_KERNEL);\r\nif (!upayload)\r\ngoto error;\r\nupayload->datalen = datalen;\r\nmemcpy(upayload->data, data, datalen);\r\nzap = upayload;\r\nret = key_payload_reserve(key, datalen);\r\nif (ret == 0) {\r\nzap = key->payload.data;\r\nrcu_assign_keypointer(key, upayload);\r\nkey->expiry = 0;\r\n}\r\nif (zap)\r\nkfree_rcu(zap, rcu);\r\nerror:\r\nreturn ret;\r\n}\r\nint user_match(const struct key *key, const void *description)\r\n{\r\nreturn strcmp(key->description, description) == 0;\r\n}\r\nvoid user_revoke(struct key *key)\r\n{\r\nstruct user_key_payload *upayload = key->payload.data;\r\nkey_payload_reserve(key, 0);\r\nif (upayload) {\r\nrcu_assign_keypointer(key, NULL);\r\nkfree_rcu(upayload, rcu);\r\n}\r\n}\r\nvoid user_destroy(struct key *key)\r\n{\r\nstruct user_key_payload *upayload = key->payload.data;\r\nkfree(upayload);\r\n}\r\nvoid user_describe(const struct key *key, struct seq_file *m)\r\n{\r\nseq_puts(m, key->description);\r\nif (key_is_instantiated(key))\r\nseq_printf(m, ": %u", key->datalen);\r\n}\r\nlong user_read(const struct key *key, char __user *buffer, size_t buflen)\r\n{\r\nstruct user_key_payload *upayload;\r\nlong ret;\r\nupayload = rcu_dereference_key(key);\r\nret = upayload->datalen;\r\nif (buffer && buflen > 0) {\r\nif (buflen > upayload->datalen)\r\nbuflen = upayload->datalen;\r\nif (copy_to_user(buffer, upayload->data, buflen) != 0)\r\nret = -EFAULT;\r\n}\r\nreturn ret;\r\n}\r\nstatic int logon_vet_description(const char *desc)\r\n{\r\nchar *p;\r\np = strchr(desc, ':');\r\nif (!p)\r\nreturn -EINVAL;\r\nif (p == desc)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}

static int kgdboc_reset_connect(struct input_handler *handler,\r\nstruct input_dev *dev,\r\nconst struct input_device_id *id)\r\n{\r\ninput_reset_device(dev);\r\nreturn -ENODEV;\r\n}\r\nstatic void kgdboc_reset_disconnect(struct input_handle *handle)\r\n{\r\nBUG();\r\n}\r\nstatic void kgdboc_restore_input_helper(struct work_struct *dummy)\r\n{\r\nmutex_lock(&kgdboc_reset_mutex);\r\nif (input_register_handler(&kgdboc_reset_handler) == 0)\r\ninput_unregister_handler(&kgdboc_reset_handler);\r\nmutex_unlock(&kgdboc_reset_mutex);\r\n}\r\nstatic void kgdboc_restore_input(void)\r\n{\r\nif (likely(system_state == SYSTEM_RUNNING))\r\nschedule_work(&kgdboc_restore_input_work);\r\n}\r\nstatic int kgdboc_register_kbd(char **cptr)\r\n{\r\nif (strncmp(*cptr, "kbd", 3) == 0) {\r\nif (kdb_poll_idx < KDB_POLL_FUNC_MAX) {\r\nkdb_poll_funcs[kdb_poll_idx] = kdb_get_kbd_char;\r\nkdb_poll_idx++;\r\nif (cptr[0][3] == ',')\r\n*cptr += 4;\r\nelse\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void kgdboc_unregister_kbd(void)\r\n{\r\nint i;\r\nfor (i = 0; i < kdb_poll_idx; i++) {\r\nif (kdb_poll_funcs[i] == kdb_get_kbd_char) {\r\nkdb_poll_idx--;\r\nkdb_poll_funcs[i] = kdb_poll_funcs[kdb_poll_idx];\r\nkdb_poll_funcs[kdb_poll_idx] = NULL;\r\ni--;\r\n}\r\n}\r\nflush_work_sync(&kgdboc_restore_input_work);\r\n}\r\nstatic int kgdboc_option_setup(char *opt)\r\n{\r\nif (strlen(opt) >= MAX_CONFIG_LEN) {\r\nprintk(KERN_ERR "kgdboc: config string too long\n");\r\nreturn -ENOSPC;\r\n}\r\nstrcpy(config, opt);\r\nreturn 0;\r\n}\r\nstatic void cleanup_kgdboc(void)\r\n{\r\nkgdboc_unregister_kbd();\r\nif (configured == 1)\r\nkgdb_unregister_io_module(&kgdboc_io_ops);\r\n}\r\nstatic int configure_kgdboc(void)\r\n{\r\nstruct tty_driver *p;\r\nint tty_line = 0;\r\nint err;\r\nchar *cptr = config;\r\nstruct console *cons;\r\nerr = kgdboc_option_setup(config);\r\nif (err || !strlen(config) || isspace(config[0]))\r\ngoto noconfig;\r\nerr = -ENODEV;\r\nkgdboc_io_ops.is_console = 0;\r\nkgdb_tty_driver = NULL;\r\nkgdboc_use_kms = 0;\r\nif (strncmp(cptr, "kms,", 4) == 0) {\r\ncptr += 4;\r\nkgdboc_use_kms = 1;\r\n}\r\nif (kgdboc_register_kbd(&cptr))\r\ngoto do_register;\r\np = tty_find_polling_driver(cptr, &tty_line);\r\nif (!p)\r\ngoto noconfig;\r\ncons = console_drivers;\r\nwhile (cons) {\r\nint idx;\r\nif (cons->device && cons->device(cons, &idx) == p &&\r\nidx == tty_line) {\r\nkgdboc_io_ops.is_console = 1;\r\nbreak;\r\n}\r\ncons = cons->next;\r\n}\r\nkgdb_tty_driver = p;\r\nkgdb_tty_line = tty_line;\r\ndo_register:\r\nerr = kgdb_register_io_module(&kgdboc_io_ops);\r\nif (err)\r\ngoto noconfig;\r\nconfigured = 1;\r\nreturn 0;\r\nnoconfig:\r\nconfig[0] = 0;\r\nconfigured = 0;\r\ncleanup_kgdboc();\r\nreturn err;\r\n}\r\nstatic int __init init_kgdboc(void)\r\n{\r\nif (configured == 1)\r\nreturn 0;\r\nreturn configure_kgdboc();\r\n}\r\nstatic int kgdboc_get_char(void)\r\n{\r\nif (!kgdb_tty_driver)\r\nreturn -1;\r\nreturn kgdb_tty_driver->ops->poll_get_char(kgdb_tty_driver,\r\nkgdb_tty_line);\r\n}\r\nstatic void kgdboc_put_char(u8 chr)\r\n{\r\nif (!kgdb_tty_driver)\r\nreturn;\r\nkgdb_tty_driver->ops->poll_put_char(kgdb_tty_driver,\r\nkgdb_tty_line, chr);\r\n}\r\nstatic int param_set_kgdboc_var(const char *kmessage, struct kernel_param *kp)\r\n{\r\nint len = strlen(kmessage);\r\nif (len >= MAX_CONFIG_LEN) {\r\nprintk(KERN_ERR "kgdboc: config string too long\n");\r\nreturn -ENOSPC;\r\n}\r\nif (configured < 0) {\r\nstrcpy(config, kmessage);\r\nreturn 0;\r\n}\r\nif (kgdb_connected) {\r\nprintk(KERN_ERR\r\n"kgdboc: Cannot reconfigure while KGDB is connected.\n");\r\nreturn -EBUSY;\r\n}\r\nstrcpy(config, kmessage);\r\nif (config[len - 1] == '\n')\r\nconfig[len - 1] = '\0';\r\nif (configured == 1)\r\ncleanup_kgdboc();\r\nreturn configure_kgdboc();\r\n}\r\nstatic void kgdboc_pre_exp_handler(void)\r\n{\r\nif (!dbg_restore_graphics && kgdboc_use_kms) {\r\ndbg_restore_graphics = 1;\r\ncon_debug_enter(vc_cons[fg_console].d);\r\n}\r\nif (!kgdb_connected)\r\ntry_module_get(THIS_MODULE);\r\n}\r\nstatic void kgdboc_post_exp_handler(void)\r\n{\r\nif (!kgdb_connected)\r\nmodule_put(THIS_MODULE);\r\nif (kgdboc_use_kms && dbg_restore_graphics) {\r\ndbg_restore_graphics = 0;\r\ncon_debug_leave();\r\n}\r\nkgdboc_restore_input();\r\n}\r\nstatic int __init kgdboc_early_init(char *opt)\r\n{\r\nchar save_ch;\r\nkgdboc_option_setup(opt);\r\nsave_ch = config[0];\r\ninit_kgdboc();\r\nconfig[0] = save_ch;\r\nreturn 0;\r\n}

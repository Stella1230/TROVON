void ui_helpline__pop(void)\r\n{\r\n}\r\nvoid ui_helpline__push(const char *msg)\r\n{\r\nconst size_t sz = sizeof(ui_helpline__current);\r\nSLsmg_gotorc(SLtt_Screen_Rows - 1, 0);\r\nSLsmg_set_color(0);\r\nSLsmg_write_nstring((char *)msg, SLtt_Screen_Cols);\r\nSLsmg_refresh();\r\nstrncpy(ui_helpline__current, msg, sz)[sz - 1] = '\0';\r\n}\r\nvoid ui_helpline__vpush(const char *fmt, va_list ap)\r\n{\r\nchar *s;\r\nif (vasprintf(&s, fmt, ap) < 0)\r\nvfprintf(stderr, fmt, ap);\r\nelse {\r\nui_helpline__push(s);\r\nfree(s);\r\n}\r\n}\r\nvoid ui_helpline__fpush(const char *fmt, ...)\r\n{\r\nva_list ap;\r\nva_start(ap, fmt);\r\nui_helpline__vpush(fmt, ap);\r\nva_end(ap);\r\n}\r\nvoid ui_helpline__puts(const char *msg)\r\n{\r\nui_helpline__pop();\r\nui_helpline__push(msg);\r\n}\r\nvoid ui_helpline__init(void)\r\n{\r\nui_helpline__puts(" ");\r\n}\r\nint ui_helpline__show_help(const char *format, va_list ap)\r\n{\r\nint ret;\r\nstatic int backlog;\r\npthread_mutex_lock(&ui__lock);\r\nret = vscnprintf(ui_helpline__last_msg + backlog,\r\nsizeof(ui_helpline__last_msg) - backlog, format, ap);\r\nbacklog += ret;\r\nif (ui_helpline__last_msg[backlog - 1] == '\n') {\r\nui_helpline__puts(ui_helpline__last_msg);\r\nSLsmg_refresh();\r\nbacklog = 0;\r\n}\r\npthread_mutex_unlock(&ui__lock);\r\nreturn ret;\r\n}

int mpi_mul_ui(MPI prod, MPI mult, unsigned long small_mult)\r\n{\r\nmpi_size_t size, prod_size;\r\nmpi_ptr_t prod_ptr;\r\nmpi_limb_t cy;\r\nint sign;\r\nsize = mult->nlimbs;\r\nsign = mult->sign;\r\nif (!size || !small_mult) {\r\nprod->nlimbs = 0;\r\nprod->sign = 0;\r\nreturn 0;\r\n}\r\nprod_size = size + 1;\r\nif (prod->alloced < prod_size)\r\nif (mpi_resize(prod, prod_size) < 0)\r\nreturn -ENOMEM;\r\nprod_ptr = prod->d;\r\ncy = mpihelp_mul_1(prod_ptr, mult->d, size, (mpi_limb_t) small_mult);\r\nif (cy)\r\nprod_ptr[size++] = cy;\r\nprod->nlimbs = size;\r\nprod->sign = sign;\r\nreturn 0;\r\n}\r\nint mpi_mul_2exp(MPI w, MPI u, unsigned long cnt)\r\n{\r\nmpi_size_t usize, wsize, limb_cnt;\r\nmpi_ptr_t wp;\r\nmpi_limb_t wlimb;\r\nint usign, wsign;\r\nusize = u->nlimbs;\r\nusign = u->sign;\r\nif (!usize) {\r\nw->nlimbs = 0;\r\nw->sign = 0;\r\nreturn 0;\r\n}\r\nlimb_cnt = cnt / BITS_PER_MPI_LIMB;\r\nwsize = usize + limb_cnt + 1;\r\nif (w->alloced < wsize)\r\nif (mpi_resize(w, wsize) < 0)\r\nreturn -ENOMEM;\r\nwp = w->d;\r\nwsize = usize + limb_cnt;\r\nwsign = usign;\r\ncnt %= BITS_PER_MPI_LIMB;\r\nif (cnt) {\r\nwlimb = mpihelp_lshift(wp + limb_cnt, u->d, usize, cnt);\r\nif (wlimb) {\r\nwp[wsize] = wlimb;\r\nwsize++;\r\n}\r\n} else {\r\nMPN_COPY_DECR(wp + limb_cnt, u->d, usize);\r\n}\r\nMPN_ZERO(wp, limb_cnt);\r\nw->nlimbs = wsize;\r\nw->sign = wsign;\r\nreturn 0;\r\n}\r\nint mpi_mul(MPI w, MPI u, MPI v)\r\n{\r\nint rc = -ENOMEM;\r\nmpi_size_t usize, vsize, wsize;\r\nmpi_ptr_t up, vp, wp;\r\nmpi_limb_t cy;\r\nint usign, vsign, sign_product;\r\nint assign_wp = 0;\r\nmpi_ptr_t tmp_limb = NULL;\r\nif (u->nlimbs < v->nlimbs) {\r\nusize = v->nlimbs;\r\nusign = v->sign;\r\nup = v->d;\r\nvsize = u->nlimbs;\r\nvsign = u->sign;\r\nvp = u->d;\r\n} else {\r\nusize = u->nlimbs;\r\nusign = u->sign;\r\nup = u->d;\r\nvsize = v->nlimbs;\r\nvsign = v->sign;\r\nvp = v->d;\r\n}\r\nsign_product = usign ^ vsign;\r\nwp = w->d;\r\nwsize = usize + vsize;\r\nif (w->alloced < (size_t) wsize) {\r\nif (wp == up || wp == vp) {\r\nwp = mpi_alloc_limb_space(wsize);\r\nif (!wp)\r\ngoto nomem;\r\nassign_wp = 1;\r\n} else {\r\nif (mpi_resize(w, wsize) < 0)\r\ngoto nomem;\r\nwp = w->d;\r\n}\r\n} else {\r\nif (wp == up) {\r\nup = tmp_limb = mpi_alloc_limb_space(usize);\r\nif (!up)\r\ngoto nomem;\r\nif (wp == vp)\r\nvp = up;\r\nMPN_COPY(up, wp, usize);\r\n} else if (wp == vp) {\r\nvp = tmp_limb = mpi_alloc_limb_space(vsize);\r\nif (!vp)\r\ngoto nomem;\r\nMPN_COPY(vp, wp, vsize);\r\n}\r\n}\r\nif (!vsize)\r\nwsize = 0;\r\nelse {\r\nif (mpihelp_mul(wp, up, usize, vp, vsize, &cy) < 0)\r\ngoto nomem;\r\nwsize -= cy ? 0 : 1;\r\n}\r\nif (assign_wp)\r\nmpi_assign_limb_space(w, wp, wsize);\r\nw->nlimbs = wsize;\r\nw->sign = sign_product;\r\nrc = 0;\r\nnomem:\r\nif (tmp_limb)\r\nmpi_free_limb_space(tmp_limb);\r\nreturn rc;\r\n}\r\nint mpi_mulm(MPI w, MPI u, MPI v, MPI m)\r\n{\r\nif (mpi_mul(w, u, v) < 0)\r\nreturn -ENOMEM;\r\nreturn mpi_fdiv_r(w, w, m);\r\n}

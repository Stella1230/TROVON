static unsigned int ac97_read(struct snd_soc_codec *codec,\r\nunsigned int reg)\r\n{\r\nu16 *cache = codec->reg_cache;\r\nswitch (reg) {\r\ncase AC97_RESET:\r\ncase AC97_INT_PAGING:\r\ncase AC97_POWERDOWN:\r\ncase AC97_EXTENDED_STATUS:\r\ncase AC97_VENDOR_ID1:\r\ncase AC97_VENDOR_ID2:\r\nreturn soc_ac97_ops.read(codec->ac97, reg);\r\ndefault:\r\nreg = reg >> 1;\r\nif (reg >= ARRAY_SIZE(ad1980_reg))\r\nreturn -EINVAL;\r\nreturn cache[reg];\r\n}\r\n}\r\nstatic int ac97_write(struct snd_soc_codec *codec, unsigned int reg,\r\nunsigned int val)\r\n{\r\nu16 *cache = codec->reg_cache;\r\nsoc_ac97_ops.write(codec->ac97, reg, val);\r\nreg = reg >> 1;\r\nif (reg < ARRAY_SIZE(ad1980_reg))\r\ncache[reg] = val;\r\nreturn 0;\r\n}\r\nstatic int ad1980_reset(struct snd_soc_codec *codec, int try_warm)\r\n{\r\nu16 retry_cnt = 0;\r\nretry:\r\nif (try_warm && soc_ac97_ops.warm_reset) {\r\nsoc_ac97_ops.warm_reset(codec->ac97);\r\nif (ac97_read(codec, AC97_RESET) == 0x0090)\r\nreturn 1;\r\n}\r\nsoc_ac97_ops.reset(codec->ac97);\r\nac97_write(codec, AC97_AD_SERIAL_CFG, 0x9900);\r\nif (ac97_read(codec, AC97_RESET) != 0x0090)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\nwhile (retry_cnt++ < 10)\r\ngoto retry;\r\nprintk(KERN_ERR "AD1980 AC97 reset failed\n");\r\nreturn -EIO;\r\n}\r\nstatic int ad1980_soc_probe(struct snd_soc_codec *codec)\r\n{\r\nint ret;\r\nu16 vendor_id2;\r\nu16 ext_status;\r\nprintk(KERN_INFO "AD1980 SoC Audio Codec\n");\r\nret = snd_soc_new_ac97_codec(codec, &soc_ac97_ops, 0);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "ad1980: failed to register AC97 codec\n");\r\nreturn ret;\r\n}\r\nret = ad1980_reset(codec, 0);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "Failed to reset AD1980: AC97 link error\n");\r\ngoto reset_err;\r\n}\r\nif (ac97_read(codec, AC97_VENDOR_ID1) != 0x4144) {\r\nret = -ENODEV;\r\ngoto reset_err;\r\n}\r\nvendor_id2 = ac97_read(codec, AC97_VENDOR_ID2);\r\nif (vendor_id2 != 0x5370) {\r\nif (vendor_id2 != 0x5374) {\r\nret = -ENODEV;\r\ngoto reset_err;\r\n} else {\r\nprintk(KERN_WARNING "ad1980: "\r\n"Found AD1981 - only 2/2 IN/OUT Channels "\r\n"supported\n");\r\n}\r\n}\r\nac97_write(codec, AC97_MASTER, 0x0000);\r\nac97_write(codec, AC97_PCM, 0x0000);\r\nac97_write(codec, AC97_REC_GAIN, 0x0000);\r\nac97_write(codec, AC97_CENTER_LFE_MASTER, 0x0000);\r\nac97_write(codec, AC97_SURROUND_MASTER, 0x0000);\r\next_status = ac97_read(codec, AC97_EXTENDED_STATUS);\r\nac97_write(codec, AC97_EXTENDED_STATUS, ext_status&~0x3800);\r\nsnd_soc_add_codec_controls(codec, ad1980_snd_ac97_controls,\r\nARRAY_SIZE(ad1980_snd_ac97_controls));\r\nreturn 0;\r\nreset_err:\r\nsnd_soc_free_ac97_codec(codec);\r\nreturn ret;\r\n}\r\nstatic int ad1980_soc_remove(struct snd_soc_codec *codec)\r\n{\r\nsnd_soc_free_ac97_codec(codec);\r\nreturn 0;\r\n}\r\nstatic __devinit int ad1980_probe(struct platform_device *pdev)\r\n{\r\nreturn snd_soc_register_codec(&pdev->dev,\r\n&soc_codec_dev_ad1980, &ad1980_dai, 1);\r\n}\r\nstatic int __devexit ad1980_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_codec(&pdev->dev);\r\nreturn 0;\r\n}

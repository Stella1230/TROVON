static inline u32 tegra_fuse_readl(unsigned long offset)\r\n{\r\nreturn tegra_apb_readl(TEGRA_FUSE_BASE + offset);\r\n}\r\nstatic inline bool get_spare_fuse(int bit)\r\n{\r\nreturn tegra_fuse_readl(FUSE_SPARE_BIT + bit * 4);\r\n}\r\nstatic enum tegra_revision tegra_get_revision(u32 id)\r\n{\r\nu32 minor_rev = (id >> 16) & 0xf;\r\nswitch (minor_rev) {\r\ncase 1:\r\nreturn TEGRA_REVISION_A01;\r\ncase 2:\r\nreturn TEGRA_REVISION_A02;\r\ncase 3:\r\nif (tegra_chip_id == TEGRA20 &&\r\n(get_spare_fuse(18) || get_spare_fuse(19)))\r\nreturn TEGRA_REVISION_A03p;\r\nelse\r\nreturn TEGRA_REVISION_A03;\r\ncase 4:\r\nreturn TEGRA_REVISION_A04;\r\ndefault:\r\nreturn TEGRA_REVISION_UNKNOWN;\r\n}\r\n}\r\nvoid tegra_init_fuse(void)\r\n{\r\nu32 id;\r\nu32 reg = readl(IO_TO_VIRT(TEGRA_CLK_RESET_BASE + 0x48));\r\nreg |= 1 << 28;\r\nwritel(reg, IO_TO_VIRT(TEGRA_CLK_RESET_BASE + 0x48));\r\nreg = tegra_fuse_readl(FUSE_SKU_INFO);\r\ntegra_sku_id = reg & 0xFF;\r\nreg = tegra_fuse_readl(FUSE_SPARE_BIT);\r\ntegra_cpu_process_id = (reg >> 6) & 3;\r\nreg = tegra_fuse_readl(FUSE_SPARE_BIT);\r\ntegra_core_process_id = (reg >> 12) & 3;\r\nreg = tegra_apb_readl(TEGRA_APB_MISC_BASE + STRAP_OPT);\r\ntegra_bct_strapping = (reg & RAM_ID_MASK) >> RAM_CODE_SHIFT;\r\nid = readl_relaxed(IO_ADDRESS(TEGRA_APB_MISC_BASE) + 0x804);\r\ntegra_chip_id = (id >> 8) & 0xff;\r\ntegra_revision = tegra_get_revision(id);\r\npr_info("Tegra Revision: %s SKU: %d CPU Process: %d Core Process: %d\n",\r\ntegra_revision_name[tegra_revision],\r\ntegra_sku_id, tegra_cpu_process_id,\r\ntegra_core_process_id);\r\n}\r\nunsigned long long tegra_chip_uid(void)\r\n{\r\nunsigned long long lo, hi;\r\nlo = tegra_fuse_readl(FUSE_UID_LOW);\r\nhi = tegra_fuse_readl(FUSE_UID_HIGH);\r\nreturn (hi << 32ull) | lo;\r\n}

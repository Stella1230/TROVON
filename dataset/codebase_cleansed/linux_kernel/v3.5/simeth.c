static int __init\r\nsimeth_setup(char *str)\r\n{\r\nsimeth_device = str;\r\nreturn 1;\r\n}\r\nint __init\r\nsimeth_probe (void)\r\n{\r\nint r;\r\nprintk(KERN_INFO "simeth: v%s\n", simeth_version);\r\nr = simeth_probe1();\r\nif (r == 0) register_netdevice_notifier(&simeth_dev_notifier);\r\nreturn r;\r\n}\r\nstatic inline int\r\nnetdev_probe(char *name, unsigned char *ether)\r\n{\r\nreturn ia64_ssc(__pa(name), __pa(ether), 0,0, SSC_NETDEV_PROBE);\r\n}\r\nstatic inline int\r\nnetdev_attach(int fd, int irq, unsigned int ipaddr)\r\n{\r\nreturn ia64_ssc(fd, ipaddr, 0,0, SSC_NETDEV_ATTACH);\r\n}\r\nstatic inline int\r\nnetdev_detach(int fd)\r\n{\r\nreturn ia64_ssc(fd, 0,0,0, SSC_NETDEV_DETACH);\r\n}\r\nstatic inline int\r\nnetdev_send(int fd, unsigned char *buf, unsigned int len)\r\n{\r\nreturn ia64_ssc(fd, __pa(buf), len, 0, SSC_NETDEV_SEND);\r\n}\r\nstatic inline int\r\nnetdev_read(int fd, unsigned char *buf, unsigned int len)\r\n{\r\nreturn ia64_ssc(fd, __pa(buf), len, 0, SSC_NETDEV_RECV);\r\n}\r\nstatic int\r\nsimeth_probe1(void)\r\n{\r\nunsigned char mac_addr[ETH_ALEN];\r\nstruct simeth_local *local;\r\nstruct net_device *dev;\r\nint fd, err, rc;\r\nif (test_and_set_bit(0, &card_count))\r\nreturn -ENODEV;\r\nfd = netdev_probe(simeth_device, mac_addr);\r\nif (fd == -1)\r\nreturn -ENODEV;\r\ndev = alloc_etherdev(sizeof(struct simeth_local));\r\nif (!dev)\r\nreturn -ENOMEM;\r\nmemcpy(dev->dev_addr, mac_addr, sizeof(mac_addr));\r\nlocal = netdev_priv(dev);\r\nlocal->simfd = fd;\r\ndev->netdev_ops = &simeth_netdev_ops;\r\nerr = register_netdev(dev);\r\nif (err) {\r\nfree_netdev(dev);\r\nreturn err;\r\n}\r\nif ((rc = hpsim_get_irq(NETWORK_INTR)) < 0)\r\npanic("%s: out of interrupt vectors!\n", __func__);\r\ndev->irq = rc;\r\nprintk(KERN_INFO "%s: hosteth=%s simfd=%d, HwAddr=%pm, IRQ %d\n",\r\ndev->name, simeth_device, local->simfd, dev->dev_addr, dev->irq);\r\nreturn 0;\r\n}\r\nstatic int\r\nsimeth_open(struct net_device *dev)\r\n{\r\nif (request_irq(dev->irq, simeth_interrupt, 0, "simeth", dev)) {\r\nprintk(KERN_WARNING "simeth: unable to get IRQ %d.\n", dev->irq);\r\nreturn -EAGAIN;\r\n}\r\nnetif_start_queue(dev);\r\nreturn 0;\r\n}\r\nstatic __inline__ int dev_is_ethdev(struct net_device *dev)\r\n{\r\nreturn ( dev->type == ARPHRD_ETHER && strncmp(dev->name, "dummy", 5));\r\n}\r\nstatic int\r\nsimeth_device_event(struct notifier_block *this,unsigned long event, void *ptr)\r\n{\r\nstruct net_device *dev = ptr;\r\nstruct simeth_local *local;\r\nstruct in_device *in_dev;\r\nstruct in_ifaddr **ifap = NULL;\r\nstruct in_ifaddr *ifa = NULL;\r\nint r;\r\nif ( ! dev ) {\r\nprintk(KERN_WARNING "simeth_device_event dev=0\n");\r\nreturn NOTIFY_DONE;\r\n}\r\nif (dev_net(dev) != &init_net)\r\nreturn NOTIFY_DONE;\r\nif ( event != NETDEV_UP && event != NETDEV_DOWN ) return NOTIFY_DONE;\r\nif ( !dev_is_ethdev(dev) ) return NOTIFY_DONE;\r\nif ((in_dev=dev->ip_ptr) != NULL) {\r\nfor (ifap=&in_dev->ifa_list; (ifa=*ifap) != NULL; ifap=&ifa->ifa_next)\r\nif (strcmp(dev->name, ifa->ifa_label) == 0) break;\r\n}\r\nif ( ifa == NULL ) {\r\nprintk(KERN_ERR "simeth_open: can't find device %s's ifa\n", dev->name);\r\nreturn NOTIFY_DONE;\r\n}\r\nprintk(KERN_INFO "simeth_device_event: %s ipaddr=0x%x\n",\r\ndev->name, ntohl(ifa->ifa_local));\r\nlocal = netdev_priv(dev);\r\nr = event == NETDEV_UP ?\r\nnetdev_attach(local->simfd, dev->irq, ntohl(ifa->ifa_local)):\r\nnetdev_detach(local->simfd);\r\nprintk(KERN_INFO "simeth: netdev_attach/detach: event=%s ->%d\n",\r\nevent == NETDEV_UP ? "attach":"detach", r);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int\r\nsimeth_close(struct net_device *dev)\r\n{\r\nnetif_stop_queue(dev);\r\nfree_irq(dev->irq, dev);\r\nreturn 0;\r\n}\r\nstatic void\r\nframe_print(unsigned char *from, unsigned char *frame, int len)\r\n{\r\nint i;\r\nprintk("%s: (%d) %02x", from, len, frame[0] & 0xff);\r\nfor(i=1; i < 6; i++ ) {\r\nprintk(":%02x", frame[i] &0xff);\r\n}\r\nprintk(" %2x", frame[6] &0xff);\r\nfor(i=7; i < 12; i++ ) {\r\nprintk(":%02x", frame[i] &0xff);\r\n}\r\nprintk(" [%02x%02x]\n", frame[12], frame[13]);\r\nfor(i=14; i < len; i++ ) {\r\nprintk("%02x ", frame[i] &0xff);\r\nif ( (i%10)==0) printk("\n");\r\n}\r\nprintk("\n");\r\n}\r\nstatic int\r\nsimeth_tx(struct sk_buff *skb, struct net_device *dev)\r\n{\r\nstruct simeth_local *local = netdev_priv(dev);\r\n#if 0\r\nunsigned int length = ETH_ZLEN < skb->len ? skb->len : ETH_ZLEN;\r\n#else\r\nunsigned int length = skb->len;\r\n#endif\r\nlocal->stats.tx_bytes += skb->len;\r\nlocal->stats.tx_packets++;\r\nif (simeth_debug > 5) frame_print("simeth_tx", skb->data, length);\r\nnetdev_send(local->simfd, skb->data, length);\r\ndev_kfree_skb(skb);\r\nreturn NETDEV_TX_OK;\r\n}\r\nstatic inline struct sk_buff *\r\nmake_new_skb(struct net_device *dev)\r\n{\r\nstruct sk_buff *nskb;\r\nnskb = dev_alloc_skb(SIMETH_FRAME_SIZE + 2);\r\nif ( nskb == NULL ) {\r\nprintk(KERN_NOTICE "%s: memory squeeze. dropping packet.\n", dev->name);\r\nreturn NULL;\r\n}\r\nskb_reserve(nskb, 2);\r\nskb_put(nskb,SIMETH_FRAME_SIZE);\r\nreturn nskb;\r\n}\r\nstatic int\r\nsimeth_rx(struct net_device *dev)\r\n{\r\nstruct simeth_local *local;\r\nstruct sk_buff *skb;\r\nint len;\r\nint rcv_count = SIMETH_RECV_MAX;\r\nlocal = netdev_priv(dev);\r\ndo {\r\nif ( (skb=make_new_skb(dev)) == NULL ) {\r\nprintk(KERN_NOTICE "%s: memory squeeze. dropping packet.\n", dev->name);\r\nlocal->stats.rx_dropped++;\r\nreturn 0;\r\n}\r\nlen = netdev_read(local->simfd, skb->data, SIMETH_FRAME_SIZE);\r\nif ( len == 0 ) {\r\nif ( simeth_debug > 0 ) printk(KERN_WARNING "%s: count=%d netdev_read=0\n",\r\ndev->name, SIMETH_RECV_MAX-rcv_count);\r\nbreak;\r\n}\r\n#if 0\r\nskb_copy_to_linear_data(skb, frame, len);\r\n#endif\r\nskb->protocol = eth_type_trans(skb, dev);\r\nif ( simeth_debug > 6 ) frame_print("simeth_rx", skb->data, len);\r\nnetif_rx(skb);\r\nlocal->stats.rx_packets++;\r\nlocal->stats.rx_bytes += len;\r\n} while ( --rcv_count );\r\nreturn len;\r\n}\r\nstatic irqreturn_t\r\nsimeth_interrupt(int irq, void *dev_id)\r\n{\r\nstruct net_device *dev = dev_id;\r\nwhile (simeth_rx(dev));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic struct net_device_stats *\r\nsimeth_get_stats(struct net_device *dev)\r\n{\r\nstruct simeth_local *local = netdev_priv(dev);\r\nreturn &local->stats;\r\n}\r\nstatic void\r\nset_multicast_list(struct net_device *dev)\r\n{\r\nprintk(KERN_WARNING "%s: set_multicast_list called\n", dev->name);\r\n}

static int check_in_drive_lists (ide_drive_t *drive, const char **list)\r\n{\r\nchar *m = (char *)&drive->id[ATA_ID_PROD];\r\nwhile (*list)\r\nif (!strcmp(*list++, m))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic u8 svwks_udma_filter(ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(drive->hwif->dev);\r\nif (dev->device == PCI_DEVICE_ID_SERVERWORKS_HT1000IDE) {\r\nreturn 0x1f;\r\n} else if (dev->revision < SVWKS_CSB5_REVISION_NEW) {\r\nreturn 0x07;\r\n} else {\r\nu8 btr = 0, mode, mask;\r\npci_read_config_byte(dev, 0x5A, &btr);\r\nmode = btr & 0x3;\r\nif (mode > 2 && check_in_drive_lists(drive, svwks_bad_ata100))\r\nmode = 2;\r\nswitch(mode) {\r\ncase 3: mask = 0x3f; break;\r\ncase 2: mask = 0x1f; break;\r\ncase 1: mask = 0x07; break;\r\ndefault: mask = 0x00; break;\r\n}\r\nreturn mask;\r\n}\r\n}\r\nstatic u8 svwks_csb_check (struct pci_dev *dev)\r\n{\r\nswitch (dev->device) {\r\ncase PCI_DEVICE_ID_SERVERWORKS_CSB5IDE:\r\ncase PCI_DEVICE_ID_SERVERWORKS_CSB6IDE:\r\ncase PCI_DEVICE_ID_SERVERWORKS_CSB6IDE2:\r\ncase PCI_DEVICE_ID_SERVERWORKS_HT1000IDE:\r\nreturn 1;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic void svwks_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstatic const u8 pio_modes[] = { 0x5d, 0x47, 0x34, 0x22, 0x20 };\r\nstatic const u8 drive_pci[] = { 0x41, 0x40, 0x43, 0x42 };\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nconst u8 pio = drive->pio_mode - XFER_PIO_0;\r\npci_write_config_byte(dev, drive_pci[drive->dn], pio_modes[pio]);\r\nif (svwks_csb_check(dev)) {\r\nu16 csb_pio = 0;\r\npci_read_config_word(dev, 0x4a, &csb_pio);\r\ncsb_pio &= ~(0x0f << (4 * drive->dn));\r\ncsb_pio |= (pio << (4 * drive->dn));\r\npci_write_config_word(dev, 0x4a, csb_pio);\r\n}\r\n}\r\nstatic void svwks_set_dma_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstatic const u8 udma_modes[] = { 0x00, 0x01, 0x02, 0x03, 0x04, 0x05 };\r\nstatic const u8 dma_modes[] = { 0x77, 0x21, 0x20 };\r\nstatic const u8 drive_pci2[] = { 0x45, 0x44, 0x47, 0x46 };\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nconst u8 speed = drive->dma_mode;\r\nu8 unit = drive->dn & 1;\r\nu8 ultra_enable = 0, ultra_timing = 0, dma_timing = 0;\r\npci_read_config_byte(dev, (0x56|hwif->channel), &ultra_timing);\r\npci_read_config_byte(dev, 0x54, &ultra_enable);\r\nultra_timing &= ~(0x0F << (4*unit));\r\nultra_enable &= ~(0x01 << drive->dn);\r\nif (speed >= XFER_UDMA_0) {\r\ndma_timing |= dma_modes[2];\r\nultra_timing |= (udma_modes[speed - XFER_UDMA_0] << (4 * unit));\r\nultra_enable |= (0x01 << drive->dn);\r\n} else if (speed >= XFER_MW_DMA_0)\r\ndma_timing |= dma_modes[speed - XFER_MW_DMA_0];\r\npci_write_config_byte(dev, drive_pci2[drive->dn], dma_timing);\r\npci_write_config_byte(dev, (0x56|hwif->channel), ultra_timing);\r\npci_write_config_byte(dev, 0x54, ultra_enable);\r\n}\r\nstatic int init_chipset_svwks(struct pci_dev *dev)\r\n{\r\nunsigned int reg;\r\nu8 btr;\r\npci_write_config_byte(dev, PCI_LATENCY_TIMER, 0x40);\r\nif (dev->device == PCI_DEVICE_ID_SERVERWORKS_OSB4IDE) {\r\nstruct pci_dev *isa_dev =\r\npci_get_device(PCI_VENDOR_ID_SERVERWORKS,\r\nPCI_DEVICE_ID_SERVERWORKS_OSB4, NULL);\r\nif (isa_dev) {\r\npci_read_config_dword(isa_dev, 0x64, &reg);\r\nreg &= ~0x00002000;\r\nif(!(reg & 0x00004000))\r\nprintk(KERN_DEBUG DRV_NAME " %s: UDMA not BIOS "\r\n"enabled.\n", pci_name(dev));\r\nreg |= 0x00004000;\r\npci_write_config_dword(isa_dev, 0x64, reg);\r\npci_dev_put(isa_dev);\r\n}\r\n}\r\nelse if ((dev->device == PCI_DEVICE_ID_SERVERWORKS_CSB5IDE) ||\r\n(dev->device == PCI_DEVICE_ID_SERVERWORKS_CSB6IDE) ||\r\n(dev->device == PCI_DEVICE_ID_SERVERWORKS_CSB6IDE2)) {\r\nif (!(PCI_FUNC(dev->devfn) & 1)) {\r\nstruct pci_dev * findev = NULL;\r\nu32 reg4c = 0;\r\nfindev = pci_get_device(PCI_VENDOR_ID_SERVERWORKS,\r\nPCI_DEVICE_ID_SERVERWORKS_CSB5, NULL);\r\nif (findev) {\r\npci_read_config_dword(findev, 0x4C, &reg4c);\r\nreg4c &= ~0x000007FF;\r\nreg4c |= 0x00000040;\r\nreg4c |= 0x00000020;\r\npci_write_config_dword(findev, 0x4C, reg4c);\r\npci_dev_put(findev);\r\n}\r\noutb_p(0x06, 0x0c00);\r\ndev->irq = inb_p(0x0c01);\r\n} else {\r\nstruct pci_dev * findev = NULL;\r\nu8 reg41 = 0;\r\nfindev = pci_get_device(PCI_VENDOR_ID_SERVERWORKS,\r\nPCI_DEVICE_ID_SERVERWORKS_CSB6, NULL);\r\nif (findev) {\r\npci_read_config_byte(findev, 0x41, &reg41);\r\nreg41 &= ~0x40;\r\npci_write_config_byte(findev, 0x41, reg41);\r\npci_dev_put(findev);\r\n}\r\nif ((dev->class >> 8) == PCI_CLASS_STORAGE_IDE)\r\ndev->irq = 0;\r\n}\r\npci_read_config_byte(dev, 0x5A, &btr);\r\nbtr &= ~0x40;\r\nif (!(PCI_FUNC(dev->devfn) & 1))\r\nbtr |= 0x2;\r\nelse\r\nbtr |= (dev->revision >= SVWKS_CSB5_REVISION_NEW) ? 0x3 : 0x2;\r\npci_write_config_byte(dev, 0x5A, btr);\r\n}\r\nelse if (dev->device == PCI_DEVICE_ID_SERVERWORKS_HT1000IDE) {\r\npci_read_config_byte(dev, 0x5A, &btr);\r\nbtr &= ~0x40;\r\nbtr |= 0x3;\r\npci_write_config_byte(dev, 0x5A, btr);\r\n}\r\nreturn 0;\r\n}\r\nstatic u8 ata66_svwks_svwks(ide_hwif_t *hwif)\r\n{\r\nreturn ATA_CBL_PATA80;\r\n}\r\nstatic u8 ata66_svwks_dell(ide_hwif_t *hwif)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nif (dev->subsystem_vendor == PCI_VENDOR_ID_DELL &&\r\ndev->vendor == PCI_VENDOR_ID_SERVERWORKS &&\r\n(dev->device == PCI_DEVICE_ID_SERVERWORKS_CSB5IDE ||\r\ndev->device == PCI_DEVICE_ID_SERVERWORKS_CSB6IDE))\r\nreturn ((1 << (hwif->channel + 14)) &\r\ndev->subsystem_device) ? ATA_CBL_PATA80 : ATA_CBL_PATA40;\r\nreturn ATA_CBL_PATA40;\r\n}\r\nstatic u8 ata66_svwks_cobalt(ide_hwif_t *hwif)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nif (dev->subsystem_vendor == PCI_VENDOR_ID_SUN &&\r\ndev->vendor == PCI_VENDOR_ID_SERVERWORKS &&\r\ndev->device == PCI_DEVICE_ID_SERVERWORKS_CSB5IDE)\r\nreturn ((1 << (hwif->channel + 14)) &\r\ndev->subsystem_device) ? ATA_CBL_PATA80 : ATA_CBL_PATA40;\r\nreturn ATA_CBL_PATA40;\r\n}\r\nstatic u8 svwks_cable_detect(ide_hwif_t *hwif)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nif (dev->subsystem_vendor == PCI_VENDOR_ID_SERVERWORKS)\r\nreturn ata66_svwks_svwks (hwif);\r\nif (dev->subsystem_vendor == PCI_VENDOR_ID_DELL)\r\nreturn ata66_svwks_dell (hwif);\r\nif (dev->subsystem_vendor == PCI_VENDOR_ID_SUN)\r\nreturn ata66_svwks_cobalt (hwif);\r\nif ((dev->device == PCI_DEVICE_ID_SERVERWORKS_CSB6IDE) ||\r\n(dev->device == PCI_DEVICE_ID_SERVERWORKS_CSB6IDE2))\r\nreturn ATA_CBL_PATA80;\r\nreturn ATA_CBL_PATA40;\r\n}\r\nstatic int __devinit svwks_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstruct ide_port_info d;\r\nu8 idx = id->driver_data;\r\nd = serverworks_chipsets[idx];\r\nif (idx == 1)\r\nd.host_flags |= IDE_HFLAG_CLEAR_SIMPLEX;\r\nelse if (idx == 2 || idx == 3) {\r\nif ((PCI_FUNC(dev->devfn) & 1) == 0) {\r\nif (pci_resource_start(dev, 0) != 0x01f1)\r\nd.host_flags |= IDE_HFLAG_NON_BOOTABLE;\r\nd.host_flags |= IDE_HFLAG_SINGLE;\r\n} else\r\nd.host_flags &= ~IDE_HFLAG_SINGLE;\r\n}\r\nreturn ide_pci_init_one(dev, &d, NULL);\r\n}\r\nstatic int __init svwks_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&svwks_pci_driver);\r\n}\r\nstatic void __exit svwks_ide_exit(void)\r\n{\r\npci_unregister_driver(&svwks_pci_driver);\r\n}

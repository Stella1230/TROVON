void register_syscore_ops(struct syscore_ops *ops)\r\n{\r\nmutex_lock(&syscore_ops_lock);\r\nlist_add_tail(&ops->node, &syscore_ops_list);\r\nmutex_unlock(&syscore_ops_lock);\r\n}\r\nvoid unregister_syscore_ops(struct syscore_ops *ops)\r\n{\r\nmutex_lock(&syscore_ops_lock);\r\nlist_del(&ops->node);\r\nmutex_unlock(&syscore_ops_lock);\r\n}\r\nint syscore_suspend(void)\r\n{\r\nstruct syscore_ops *ops;\r\nint ret = 0;\r\npr_debug("Checking wakeup interrupts\n");\r\nret = check_wakeup_irqs();\r\nif (ret)\r\nreturn ret;\r\nWARN_ONCE(!irqs_disabled(),\r\n"Interrupts enabled before system core suspend.\n");\r\nlist_for_each_entry_reverse(ops, &syscore_ops_list, node)\r\nif (ops->suspend) {\r\nif (initcall_debug)\r\npr_info("PM: Calling %pF\n", ops->suspend);\r\nret = ops->suspend();\r\nif (ret)\r\ngoto err_out;\r\nWARN_ONCE(!irqs_disabled(),\r\n"Interrupts enabled after %pF\n", ops->suspend);\r\n}\r\nreturn 0;\r\nerr_out:\r\npr_err("PM: System core suspend callback %pF failed.\n", ops->suspend);\r\nlist_for_each_entry_continue(ops, &syscore_ops_list, node)\r\nif (ops->resume)\r\nops->resume();\r\nreturn ret;\r\n}\r\nvoid syscore_resume(void)\r\n{\r\nstruct syscore_ops *ops;\r\nWARN_ONCE(!irqs_disabled(),\r\n"Interrupts enabled before system core resume.\n");\r\nlist_for_each_entry(ops, &syscore_ops_list, node)\r\nif (ops->resume) {\r\nif (initcall_debug)\r\npr_info("PM: Calling %pF\n", ops->resume);\r\nops->resume();\r\nWARN_ONCE(!irqs_disabled(),\r\n"Interrupts enabled after %pF\n", ops->resume);\r\n}\r\n}\r\nvoid syscore_shutdown(void)\r\n{\r\nstruct syscore_ops *ops;\r\nmutex_lock(&syscore_ops_lock);\r\nlist_for_each_entry_reverse(ops, &syscore_ops_list, node)\r\nif (ops->shutdown) {\r\nif (initcall_debug)\r\npr_info("PM: Calling %pF\n", ops->shutdown);\r\nops->shutdown();\r\n}\r\nmutex_unlock(&syscore_ops_lock);\r\n}

static void dcon_clear_irq(void)\r\n{\r\noutb(BIT_GPIO12, VX855_GPI_STATUS_CHG);\r\n}\r\nstatic int dcon_was_irq(void)\r\n{\r\nu_int8_t tmp;\r\ntmp = inb(VX855_GPI_STATUS_CHG);\r\nreturn !!(tmp & BIT_GPIO12);\r\nreturn 0;\r\n}\r\nstatic int dcon_init_xo_1_5(struct dcon_priv *dcon)\r\n{\r\nunsigned int irq;\r\nu_int8_t tmp;\r\nstruct pci_dev *pdev;\r\npdev = pci_get_device(PCI_VENDOR_ID_VIA,\r\nPCI_DEVICE_ID_VIA_VX855, NULL);\r\nif (!pdev) {\r\nprintk(KERN_ERR "cannot find VX855 PCI ID\n");\r\nreturn 1;\r\n}\r\npci_read_config_byte(pdev, 0x95, &tmp);\r\npci_write_config_byte(pdev, 0x95, tmp|0x0c);\r\npci_read_config_byte(pdev, 0xe3, &tmp);\r\npci_write_config_byte(pdev, 0xe3, tmp | 0x04);\r\npci_read_config_byte(pdev, 0xe4, &tmp);\r\npci_write_config_byte(pdev, 0xe4, tmp|0x08);\r\npci_read_config_byte(pdev, 0xe1, &tmp);\r\npci_write_config_byte(pdev, 0xe1, tmp & ~BIT_GPIO12);\r\npci_read_config_byte(pdev, 0xe0, &tmp);\r\npci_write_config_byte(pdev, 0xe0, tmp & ~BIT_GPIO12);\r\ndcon_clear_irq();\r\noutb(inb(VX855_GPI_SCI_SMI)|BIT_GPIO12, VX855_GPI_SCI_SMI);\r\ndcon->curr_src = (inl(VX855_GENL_PURPOSE_OUTPUT) & 0x1000) ?\r\nDCON_SOURCE_CPU : DCON_SOURCE_DCON;\r\ndcon->pending_src = dcon->curr_src;\r\npci_dev_put(pdev);\r\nirq = acpi_gbl_FADT.sci_interrupt;\r\nif (request_irq(irq, &dcon_interrupt, IRQF_SHARED, "DCON", dcon)) {\r\nprintk(KERN_ERR PREFIX "DCON (IRQ%d) allocation failed\n", irq);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void set_i2c_line(int sda, int scl)\r\n{\r\nunsigned char tmp;\r\nunsigned int port = 0x26;\r\noutb(port, 0x3c4);\r\ntmp = inb(0x3c5);\r\nif (scl)\r\ntmp |= 0x20;\r\nelse\r\ntmp &= ~0x20;\r\nif (sda)\r\ntmp |= 0x10;\r\nelse\r\ntmp &= ~0x10;\r\ntmp |= 0x01;\r\noutb(port, 0x3c4);\r\noutb(tmp, 0x3c5);\r\n}\r\nstatic void dcon_wiggle_xo_1_5(void)\r\n{\r\nint x;\r\nset_i2c_line(1, 1);\r\nfor (x = 0; x < 16; x++) {\r\nudelay(5);\r\nset_i2c_line(1, 0);\r\nudelay(5);\r\nset_i2c_line(1, 1);\r\n}\r\nudelay(5);\r\noutb(inb(VX855_GPI_SCI_SMI)|BIT_GPIO12, VX855_GPI_SCI_SMI);\r\n}\r\nstatic void dcon_set_dconload_xo_1_5(int val)\r\n{\r\ngpio_set_value(VX855_GPIO(1), val);\r\n}\r\nstatic int dcon_read_status_xo_1_5(u8 *status)\r\n{\r\nif (!dcon_was_irq())\r\nreturn -1;\r\n*status = gpio_get_value(VX855_GPI(10));\r\n*status |= gpio_get_value(VX855_GPI(11)) << 1;\r\ndcon_clear_irq();\r\nreturn 0;\r\n}

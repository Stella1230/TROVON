static inline void mem_on(short port, volatile char __iomem *mem_base,\r\nunsigned char start_page )\r\n{\r\nreadb(mem_base+start_page);\r\ninb(port + E21_MEM_ENABLE);\r\noutb(E21_MEM_ON, port + E21_MEM_ENABLE + E21_MEM_ON);\r\n}\r\nstatic inline void mem_off(short port)\r\n{\r\ninb(port + E21_MEM_ENABLE);\r\noutb(0x00, port + E21_MEM_ENABLE);\r\n}\r\nstatic int __init do_e2100_probe(struct net_device *dev)\r\n{\r\nint *port;\r\nint base_addr = dev->base_addr;\r\nint irq = dev->irq;\r\nif (base_addr > 0x1ff)\r\nreturn e21_probe1(dev, base_addr);\r\nelse if (base_addr != 0)\r\nreturn -ENXIO;\r\nfor (port = e21_probe_list; *port; port++) {\r\ndev->irq = irq;\r\nif (e21_probe1(dev, *port) == 0)\r\nreturn 0;\r\n}\r\nreturn -ENODEV;\r\n}\r\nstruct net_device * __init e2100_probe(int unit)\r\n{\r\nstruct net_device *dev = alloc_ei_netdev();\r\nint err;\r\nif (!dev)\r\nreturn ERR_PTR(-ENOMEM);\r\nsprintf(dev->name, "eth%d", unit);\r\nnetdev_boot_setup_check(dev);\r\nerr = do_e2100_probe(dev);\r\nif (err)\r\ngoto out;\r\nreturn dev;\r\nout:\r\nfree_netdev(dev);\r\nreturn ERR_PTR(err);\r\n}\r\nstatic int __init e21_probe1(struct net_device *dev, int ioaddr)\r\n{\r\nint i, status, retval;\r\nunsigned char *station_addr = dev->dev_addr;\r\nstatic unsigned version_printed;\r\nif (!request_region(ioaddr, E21_IO_EXTENT, DRV_NAME))\r\nreturn -EBUSY;\r\nif (inb(ioaddr + E21_SAPROM + 0) != 0x00 ||\r\ninb(ioaddr + E21_SAPROM + 1) != 0x00 ||\r\ninb(ioaddr + E21_SAPROM + 2) != 0x1d) {\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\noutb(E8390_NODMA + E8390_STOP, ioaddr);\r\nudelay(1);\r\nstatus = inb(ioaddr);\r\nif (status != 0x21 && status != 0x23) {\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\nfor (i = 0; i < 6; i++)\r\nstation_addr[i] = inb(ioaddr + E21_SAPROM + i);\r\ninb(ioaddr + E21_MEDIA);\r\noutb(0, ioaddr + E21_ASIC);\r\nif (ei_debug && version_printed++ == 0)\r\nprintk(version);\r\nfor (i = 0; i < 6; i++)\r\nprintk(" %02X", station_addr[i]);\r\nif (dev->irq < 2) {\r\nstatic const int irqlist[] = {15, 11, 10, 12, 5, 9, 3, 4};\r\nfor (i = 0; i < ARRAY_SIZE(irqlist); i++)\r\nif (request_irq (irqlist[i], NULL, 0, "bogus", NULL) != -EBUSY) {\r\ndev->irq = irqlist[i];\r\nbreak;\r\n}\r\nif (i >= ARRAY_SIZE(irqlist)) {\r\nprintk(" unable to get IRQ %d.\n", dev->irq);\r\nretval = -EAGAIN;\r\ngoto out;\r\n}\r\n} else if (dev->irq == 2)\r\ndev->irq = 9;\r\ndev->base_addr = ioaddr;\r\nei_status.name = "E2100";\r\nei_status.word16 = 1;\r\nei_status.tx_start_page = E21_TX_START_PG;\r\nei_status.rx_start_page = E21_RX_START_PG;\r\nei_status.stop_page = E21_RX_STOP_PG;\r\nei_status.saved_irq = dev->irq;\r\nif (dev->mem_end & 15)\r\ndev->if_port = dev->mem_end & 7;\r\nelse {\r\ndev->if_port = 0;\r\ninb(ioaddr + E21_MEDIA);\r\nfor(i = 0; i < 6; i++)\r\nif (station_addr[i] != inb(ioaddr + E21_SAPROM + 8 + i)) {\r\ndev->if_port = 1;\r\nbreak;\r\n}\r\n}\r\nif (dev->mem_start == 0)\r\ndev->mem_start = 0xd0000;\r\nei_status.mem = ioremap(dev->mem_start, 2*1024);\r\nif (!ei_status.mem) {\r\nprintk("unable to remap memory\n");\r\nretval = -EAGAIN;\r\ngoto out;\r\n}\r\n#ifdef notdef\r\nei_status.rmem_start = dev->mem_start + TX_PAGES*256;\r\ndev->mem_end = ei_status.rmem_end = dev->mem_start + 2*1024;\r\n#endif\r\nprintk(", IRQ %d, %s media, memory @ %#lx.\n", dev->irq,\r\ndev->if_port ? "secondary" : "primary", dev->mem_start);\r\nei_status.reset_8390 = &e21_reset_8390;\r\nei_status.block_input = &e21_block_input;\r\nei_status.block_output = &e21_block_output;\r\nei_status.get_8390_hdr = &e21_get_8390_hdr;\r\ndev->netdev_ops = &e21_netdev_ops;\r\nNS8390_init(dev, 0);\r\nretval = register_netdev(dev);\r\nif (retval)\r\ngoto out;\r\nreturn 0;\r\nout:\r\nrelease_region(ioaddr, E21_IO_EXTENT);\r\nreturn retval;\r\n}\r\nstatic int\r\ne21_open(struct net_device *dev)\r\n{\r\nshort ioaddr = dev->base_addr;\r\nint retval;\r\nif ((retval = request_irq(dev->irq, ei_interrupt, 0, dev->name, dev)))\r\nreturn retval;\r\ninb(ioaddr + E21_IRQ_LOW);\r\noutb(0, ioaddr + E21_ASIC + (dev->irq & 7));\r\ninb(ioaddr + E21_IRQ_HIGH);\r\noutb(0, ioaddr + E21_ASIC + (dev->irq > 7 ? 1:0)\r\n+ (dev->if_port ? E21_ALT_IFPORT : 0));\r\ninb(ioaddr + E21_MEM_BASE);\r\noutb(0, ioaddr + E21_ASIC + ((dev->mem_start >> 17) & 7));\r\nei_open(dev);\r\nreturn 0;\r\n}\r\nstatic void\r\ne21_reset_8390(struct net_device *dev)\r\n{\r\nshort ioaddr = dev->base_addr;\r\noutb(0x01, ioaddr);\r\nif (ei_debug > 1) printk("resetting the E2180x3 t=%ld...", jiffies);\r\nei_status.txing = 0;\r\nif (ei_debug > 1) printk("reset done\n");\r\n}\r\nstatic void\r\ne21_get_8390_hdr(struct net_device *dev, struct e8390_pkt_hdr *hdr, int ring_page)\r\n{\r\nshort ioaddr = dev->base_addr;\r\nchar __iomem *shared_mem = ei_status.mem;\r\nmem_on(ioaddr, shared_mem, ring_page);\r\n#ifdef notdef\r\nmemcpy_fromio(hdr, shared_mem, sizeof(struct e8390_pkt_hdr));\r\n#else\r\n((unsigned int*)hdr)[0] = readl(shared_mem);\r\n#endif\r\nmem_off(ioaddr);\r\n}\r\nstatic void\r\ne21_block_input(struct net_device *dev, int count, struct sk_buff *skb, int ring_offset)\r\n{\r\nshort ioaddr = dev->base_addr;\r\nchar __iomem *shared_mem = ei_status.mem;\r\nmem_on(ioaddr, shared_mem, (ring_offset>>8));\r\nmemcpy_fromio(skb->data, ei_status.mem + (ring_offset & 0xff), count);\r\nmem_off(ioaddr);\r\n}\r\nstatic void\r\ne21_block_output(struct net_device *dev, int count, const unsigned char *buf,\r\nint start_page)\r\n{\r\nshort ioaddr = dev->base_addr;\r\nvolatile char __iomem *shared_mem = ei_status.mem;\r\nreadb(shared_mem + start_page);\r\nmem_on(ioaddr, shared_mem, start_page);\r\nmemcpy_toio(shared_mem, buf, count);\r\nmem_off(ioaddr);\r\n}\r\nstatic int\r\ne21_close(struct net_device *dev)\r\n{\r\nshort ioaddr = dev->base_addr;\r\nif (ei_debug > 1)\r\nprintk("%s: Shutting down ethercard.\n", dev->name);\r\nfree_irq(dev->irq, dev);\r\ndev->irq = ei_status.saved_irq;\r\ninb(ioaddr + E21_IRQ_LOW);\r\noutb(0, ioaddr + E21_ASIC);\r\ninb(ioaddr + E21_IRQ_HIGH);\r\noutb(0, ioaddr + E21_ASIC);\r\nei_close(dev);\r\nmem_off(ioaddr);\r\nreturn 0;\r\n}\r\nint __init init_module(void)\r\n{\r\nstruct net_device *dev;\r\nint this_dev, found = 0;\r\nfor (this_dev = 0; this_dev < MAX_E21_CARDS; this_dev++) {\r\nif (io[this_dev] == 0) {\r\nif (this_dev != 0) break;\r\nprintk(KERN_NOTICE "e2100.c: Presently autoprobing (not recommended) for a single card.\n");\r\n}\r\ndev = alloc_ei_netdev();\r\nif (!dev)\r\nbreak;\r\ndev->irq = irq[this_dev];\r\ndev->base_addr = io[this_dev];\r\ndev->mem_start = mem[this_dev];\r\ndev->mem_end = xcvr[this_dev];\r\nif (do_e2100_probe(dev) == 0) {\r\ndev_e21[found++] = dev;\r\ncontinue;\r\n}\r\nfree_netdev(dev);\r\nprintk(KERN_WARNING "e2100.c: No E2100 card found (i/o = 0x%x).\n", io[this_dev]);\r\nbreak;\r\n}\r\nif (found)\r\nreturn 0;\r\nreturn -ENXIO;\r\n}\r\nstatic void cleanup_card(struct net_device *dev)\r\n{\r\niounmap(ei_status.mem);\r\nrelease_region(dev->base_addr, E21_IO_EXTENT);\r\n}\r\nvoid __exit\r\ncleanup_module(void)\r\n{\r\nint this_dev;\r\nfor (this_dev = 0; this_dev < MAX_E21_CARDS; this_dev++) {\r\nstruct net_device *dev = dev_e21[this_dev];\r\nif (dev) {\r\nunregister_netdev(dev);\r\ncleanup_card(dev);\r\nfree_netdev(dev);\r\n}\r\n}\r\n}

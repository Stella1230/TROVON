static int __init ab3100_otp_read(struct ab3100_otp *otp)\r\n{\r\nu8 otpval[8];\r\nu8 otpp;\r\nint err;\r\nerr = abx500_get_register_interruptible(otp->dev, 0,\r\nAB3100_OTPP, &otpp);\r\nif (err) {\r\ndev_err(otp->dev, "unable to read OTPP register\n");\r\nreturn err;\r\n}\r\nerr = abx500_get_register_page_interruptible(otp->dev, 0,\r\nAB3100_OTP0, otpval, 8);\r\nif (err) {\r\ndev_err(otp->dev, "unable to read OTP register page\n");\r\nreturn err;\r\n}\r\notp->locked = (otpp & 0x80);\r\notp->freq = (otpp & 0x40) ? 32768 : 34100;\r\notp->paf = (otpval[1] & 0x80);\r\notp->imeich = (otpval[1] & 0x40);\r\notp->cid = ((otpval[1] << 8) | otpval[0]) & 0x3fff;\r\notp->tac = ((otpval[4] & 0x0f) << 16) | (otpval[3] << 8) | otpval[2];\r\notp->fac = ((otpval[5] & 0x0f) << 4) | (otpval[4] >> 4);\r\notp->svn = (otpval[7] << 12) | (otpval[6] << 4) | (otpval[5] >> 4);\r\nreturn 0;\r\n}\r\nstatic int ab3100_show_otp(struct seq_file *s, void *v)\r\n{\r\nstruct ab3100_otp *otp = s->private;\r\nseq_printf(s, "OTP is %s\n", otp->locked ? "LOCKED" : "UNLOCKED");\r\nseq_printf(s, "OTP clock switch startup is %uHz\n", otp->freq);\r\nseq_printf(s, "PAF is %s\n", otp->paf ? "SET" : "NOT SET");\r\nseq_printf(s, "IMEI is %s\n", otp->imeich ?\r\n"CHANGEABLE" : "NOT CHANGEABLE");\r\nseq_printf(s, "CID: 0x%04x (decimal: %d)\n", otp->cid, otp->cid);\r\nseq_printf(s, "IMEI: %u-%u-%u\n", otp->tac, otp->fac, otp->svn);\r\nreturn 0;\r\n}\r\nstatic int ab3100_otp_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab3100_show_otp, inode->i_private);\r\n}\r\nstatic int __init ab3100_otp_init_debugfs(struct device *dev,\r\nstruct ab3100_otp *otp)\r\n{\r\notp->debugfs = debugfs_create_file("ab3100_otp", S_IFREG | S_IRUGO,\r\nNULL, otp,\r\n&ab3100_otp_operations);\r\nif (!otp->debugfs) {\r\ndev_err(dev, "AB3100 debugfs OTP file registration failed!\n");\r\nreturn -ENOENT;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit ab3100_otp_exit_debugfs(struct ab3100_otp *otp)\r\n{\r\ndebugfs_remove(otp->debugfs);\r\n}\r\nstatic inline int __init ab3100_otp_init_debugfs(struct device *dev,\r\nstruct ab3100_otp *otp)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline void __exit ab3100_otp_exit_debugfs(struct ab3100_otp *otp)\r\n{\r\n}\r\nstatic int __init ab3100_otp_probe(struct platform_device *pdev)\r\n{\r\nstruct ab3100_otp *otp;\r\nint err = 0;\r\nint i;\r\notp = kzalloc(sizeof(struct ab3100_otp), GFP_KERNEL);\r\nif (!otp) {\r\ndev_err(&pdev->dev, "could not allocate AB3100 OTP device\n");\r\nreturn -ENOMEM;\r\n}\r\notp->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, otp);\r\nerr = ab3100_otp_read(otp);\r\nif (err)\r\ngoto err_otp_read;\r\ndev_info(&pdev->dev, "AB3100 OTP readout registered\n");\r\nfor (i = 0; i < ARRAY_SIZE(ab3100_otp_attrs); i++) {\r\nerr = device_create_file(&pdev->dev,\r\n&ab3100_otp_attrs[i]);\r\nif (err)\r\ngoto err_create_file;\r\n}\r\nerr = ab3100_otp_init_debugfs(&pdev->dev, otp);\r\nif (err)\r\ngoto err_init_debugfs;\r\nreturn 0;\r\nerr_init_debugfs:\r\nerr_create_file:\r\nwhile (--i >= 0)\r\ndevice_remove_file(&pdev->dev, &ab3100_otp_attrs[i]);\r\nerr_otp_read:\r\nkfree(otp);\r\nreturn err;\r\n}\r\nstatic int __exit ab3100_otp_remove(struct platform_device *pdev)\r\n{\r\nstruct ab3100_otp *otp = platform_get_drvdata(pdev);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ab3100_otp_attrs); i++)\r\ndevice_remove_file(&pdev->dev,\r\n&ab3100_otp_attrs[i]);\r\nab3100_otp_exit_debugfs(otp);\r\nkfree(otp);\r\nreturn 0;\r\n}\r\nstatic int __init ab3100_otp_init(void)\r\n{\r\nreturn platform_driver_probe(&ab3100_otp_driver,\r\nab3100_otp_probe);\r\n}\r\nstatic void __exit ab3100_otp_exit(void)\r\n{\r\nplatform_driver_unregister(&ab3100_otp_driver);\r\n}

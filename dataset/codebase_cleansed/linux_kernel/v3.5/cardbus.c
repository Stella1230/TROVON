static void cardbus_config_irq_and_cls(struct pci_bus *bus, int irq)\r\n{\r\nstruct pci_dev *dev;\r\nlist_for_each_entry(dev, &bus->devices, bus_list) {\r\nu8 irq_pin;\r\npci_read_config_byte(dev, PCI_INTERRUPT_PIN, &irq_pin);\r\nif (irq_pin) {\r\ndev->irq = irq;\r\npci_write_config_byte(dev, PCI_INTERRUPT_LINE, dev->irq);\r\n}\r\npci_set_cacheline_size(dev);\r\nif (dev->subordinate)\r\ncardbus_config_irq_and_cls(dev->subordinate, irq);\r\n}\r\n}\r\nint __ref cb_alloc(struct pcmcia_socket *s)\r\n{\r\nstruct pci_bus *bus = s->cb_dev->subordinate;\r\nstruct pci_dev *dev;\r\nunsigned int max, pass;\r\ns->functions = pci_scan_slot(bus, PCI_DEVFN(0, 0));\r\npci_fixup_cardbus(bus);\r\nmax = bus->secondary;\r\nfor (pass = 0; pass < 2; pass++)\r\nlist_for_each_entry(dev, &bus->devices, bus_list)\r\nif (dev->hdr_type == PCI_HEADER_TYPE_BRIDGE ||\r\ndev->hdr_type == PCI_HEADER_TYPE_CARDBUS)\r\nmax = pci_scan_bridge(bus, dev, max, pass);\r\npci_bus_size_bridges(bus);\r\npci_bus_assign_resources(bus);\r\ncardbus_config_irq_and_cls(bus, s->pci_irq);\r\nif (s->tune_bridge)\r\ns->tune_bridge(s, bus);\r\npci_enable_bridges(bus);\r\npci_bus_add_devices(bus);\r\nreturn 0;\r\n}\r\nvoid cb_free(struct pcmcia_socket *s)\r\n{\r\nstruct pci_dev *bridge = s->cb_dev;\r\nif (bridge)\r\npci_stop_and_remove_behind_bridge(bridge);\r\n}

static inline u_char\r\nreadisac(void __iomem *adr, u_char off)\r\n{\r\nregister unsigned int portdata;\r\nZORAN_WAIT_NOBUSY;\r\nwritel(WRITE_ADDR_ISAC | off, adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\nwritel(READ_DATA_ISAC, adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\nreturn ((u_char)(portdata & ZORAN_PO_DMASK));\r\n}\r\nstatic inline void\r\nwriteisac(void __iomem *adr, u_char off, u_char data)\r\n{\r\nregister unsigned int portdata;\r\nZORAN_WAIT_NOBUSY;\r\nwritel(WRITE_ADDR_ISAC | off, adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\nwritel(WRITE_DATA_ISAC | data, adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\n}\r\nstatic inline u_char\r\nreadhscx(void __iomem *adr, int hscx, u_char off)\r\n{\r\nregister unsigned int portdata;\r\nZORAN_WAIT_NOBUSY;\r\nwritel(WRITE_ADDR_HSCX | ((hscx ? 0x40 : 0) + off), adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\nwritel(READ_DATA_HSCX, adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\nreturn ((u_char)(portdata & ZORAN_PO_DMASK));\r\n}\r\nstatic inline void\r\nwritehscx(void __iomem *adr, int hscx, u_char off, u_char data)\r\n{\r\nregister unsigned int portdata;\r\nZORAN_WAIT_NOBUSY;\r\nwritel(WRITE_ADDR_HSCX | ((hscx ? 0x40 : 0) + off), adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\nwritel(WRITE_DATA_HSCX | data, adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\n}\r\nstatic inline void\r\nread_fifo_isac(void __iomem *adr, u_char *data, int size)\r\n{\r\nregister unsigned int portdata;\r\nregister int i;\r\nZORAN_WAIT_NOBUSY;\r\nfor (i = 0; i < size; i++) {\r\nwritel(WRITE_ADDR_ISAC | 0x1E, adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\nwritel(READ_DATA_ISAC, adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\ndata[i] = (u_char)(portdata & ZORAN_PO_DMASK);\r\n}\r\n}\r\nstatic void\r\nwrite_fifo_isac(void __iomem *adr, u_char *data, int size)\r\n{\r\nregister unsigned int portdata;\r\nregister int i;\r\nZORAN_WAIT_NOBUSY;\r\nfor (i = 0; i < size; i++) {\r\nwritel(WRITE_ADDR_ISAC | 0x1E, adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\nwritel(WRITE_DATA_ISAC | data[i], adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\n}\r\n}\r\nstatic inline void\r\nread_fifo_hscx(void __iomem *adr, int hscx, u_char *data, int size)\r\n{\r\nregister unsigned int portdata;\r\nregister int i;\r\nZORAN_WAIT_NOBUSY;\r\nfor (i = 0; i < size; i++) {\r\nwritel(WRITE_ADDR_HSCX | (hscx ? 0x5F : 0x1F), adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\nwritel(READ_DATA_HSCX, adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\ndata[i] = (u_char) (portdata & ZORAN_PO_DMASK);\r\n}\r\n}\r\nstatic inline void\r\nwrite_fifo_hscx(void __iomem *adr, int hscx, u_char *data, int size)\r\n{\r\nunsigned int portdata;\r\nregister int i;\r\nZORAN_WAIT_NOBUSY;\r\nfor (i = 0; i < size; i++) {\r\nwritel(WRITE_ADDR_HSCX | (hscx ? 0x5F : 0x1F), adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\nwritel(WRITE_DATA_HSCX | data[i], adr + 0x200);\r\nZORAN_WAIT_NOBUSY;\r\nudelay(10);\r\n}\r\n}\r\nstatic u_char\r\nReadISAC(struct IsdnCardState *cs, u_char offset)\r\n{\r\nreturn (readisac(cs->hw.teles0.membase, offset));\r\n}\r\nstatic void\r\nWriteISAC(struct IsdnCardState *cs, u_char offset, u_char value)\r\n{\r\nwriteisac(cs->hw.teles0.membase, offset, value);\r\n}\r\nstatic void\r\nReadISACfifo(struct IsdnCardState *cs, u_char *data, int size)\r\n{\r\nread_fifo_isac(cs->hw.teles0.membase, data, size);\r\n}\r\nstatic void\r\nWriteISACfifo(struct IsdnCardState *cs, u_char *data, int size)\r\n{\r\nwrite_fifo_isac(cs->hw.teles0.membase, data, size);\r\n}\r\nstatic u_char\r\nReadHSCX(struct IsdnCardState *cs, int hscx, u_char offset)\r\n{\r\nreturn (readhscx(cs->hw.teles0.membase, hscx, offset));\r\n}\r\nstatic void\r\nWriteHSCX(struct IsdnCardState *cs, int hscx, u_char offset, u_char value)\r\n{\r\nwritehscx(cs->hw.teles0.membase, hscx, offset, value);\r\n}\r\nstatic irqreturn_t\r\ntelespci_interrupt(int intno, void *dev_id)\r\n{\r\nstruct IsdnCardState *cs = dev_id;\r\nu_char hval, ival;\r\nu_long flags;\r\nspin_lock_irqsave(&cs->lock, flags);\r\nhval = readhscx(cs->hw.teles0.membase, 1, HSCX_ISTA);\r\nif (hval)\r\nhscx_int_main(cs, hval);\r\nival = readisac(cs->hw.teles0.membase, ISAC_ISTA);\r\nif ((hval | ival) == 0) {\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_NONE;\r\n}\r\nif (ival)\r\nisac_interrupt(cs, ival);\r\nwritel(0x70000000, cs->hw.teles0.membase + 0x3C);\r\nwritehscx(cs->hw.teles0.membase, 0, HSCX_MASK, 0xFF);\r\nwritehscx(cs->hw.teles0.membase, 1, HSCX_MASK, 0xFF);\r\nwriteisac(cs->hw.teles0.membase, ISAC_MASK, 0xFF);\r\nwriteisac(cs->hw.teles0.membase, ISAC_MASK, 0x0);\r\nwritehscx(cs->hw.teles0.membase, 0, HSCX_MASK, 0x0);\r\nwritehscx(cs->hw.teles0.membase, 1, HSCX_MASK, 0x0);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void\r\nrelease_io_telespci(struct IsdnCardState *cs)\r\n{\r\niounmap(cs->hw.teles0.membase);\r\n}\r\nstatic int\r\nTelesPCI_card_msg(struct IsdnCardState *cs, int mt, void *arg)\r\n{\r\nu_long flags;\r\nswitch (mt) {\r\ncase CARD_RESET:\r\nreturn (0);\r\ncase CARD_RELEASE:\r\nrelease_io_telespci(cs);\r\nreturn (0);\r\ncase CARD_INIT:\r\nspin_lock_irqsave(&cs->lock, flags);\r\ninithscxisac(cs, 3);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn (0);\r\ncase CARD_TEST:\r\nreturn (0);\r\n}\r\nreturn (0);\r\n}\r\nint __devinit\r\nsetup_telespci(struct IsdnCard *card)\r\n{\r\nstruct IsdnCardState *cs = card->cs;\r\nchar tmp[64];\r\n#ifdef __BIG_ENDIAN\r\n#error "not running on big endian machines now"\r\n#endif\r\nstrcpy(tmp, telespci_revision);\r\nprintk(KERN_INFO "HiSax: Teles/PCI driver Rev. %s\n", HiSax_getrev(tmp));\r\nif (cs->typ != ISDN_CTYPE_TELESPCI)\r\nreturn (0);\r\nif ((dev_tel = hisax_find_pci_device(PCI_VENDOR_ID_ZORAN, PCI_DEVICE_ID_ZORAN_36120, dev_tel))) {\r\nif (pci_enable_device(dev_tel))\r\nreturn (0);\r\ncs->irq = dev_tel->irq;\r\nif (!cs->irq) {\r\nprintk(KERN_WARNING "Teles: No IRQ for PCI card found\n");\r\nreturn (0);\r\n}\r\ncs->hw.teles0.membase = ioremap(pci_resource_start(dev_tel, 0),\r\nPAGE_SIZE);\r\nprintk(KERN_INFO "Found: Zoran, base-address: 0x%llx, irq: 0x%x\n",\r\n(unsigned long long)pci_resource_start(dev_tel, 0),\r\ndev_tel->irq);\r\n} else {\r\nprintk(KERN_WARNING "TelesPCI: No PCI card found\n");\r\nreturn (0);\r\n}\r\nwritel(0x00000000, cs->hw.teles0.membase + 0x28);\r\nwritel(0x01000000, cs->hw.teles0.membase + 0x28);\r\nwritel(0x01000000, cs->hw.teles0.membase + 0x28);\r\nwritel(0x7BFFFFFF, cs->hw.teles0.membase + 0x2C);\r\nwritel(0x70000000, cs->hw.teles0.membase + 0x3C);\r\nwritel(0x61000000, cs->hw.teles0.membase + 0x40);\r\nprintk(KERN_INFO\r\n"HiSax: Teles PCI config irq:%d mem:%p\n",\r\ncs->irq,\r\ncs->hw.teles0.membase);\r\nsetup_isac(cs);\r\ncs->readisac = &ReadISAC;\r\ncs->writeisac = &WriteISAC;\r\ncs->readisacfifo = &ReadISACfifo;\r\ncs->writeisacfifo = &WriteISACfifo;\r\ncs->BC_Read_Reg = &ReadHSCX;\r\ncs->BC_Write_Reg = &WriteHSCX;\r\ncs->BC_Send_Data = &hscx_fill_fifo;\r\ncs->cardmsg = &TelesPCI_card_msg;\r\ncs->irq_func = &telespci_interrupt;\r\ncs->irq_flags |= IRQF_SHARED;\r\nISACVersion(cs, "TelesPCI:");\r\nif (HscxVersion(cs, "TelesPCI:")) {\r\nprintk(KERN_WARNING\r\n"TelesPCI: wrong HSCX versions check IO/MEM addresses\n");\r\nrelease_io_telespci(cs);\r\nreturn (0);\r\n}\r\nreturn (1);\r\n}

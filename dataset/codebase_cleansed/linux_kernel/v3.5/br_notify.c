static int br_device_event(struct notifier_block *unused, unsigned long event, void *ptr)\r\n{\r\nstruct net_device *dev = ptr;\r\nstruct net_bridge_port *p;\r\nstruct net_bridge *br;\r\nbool changed_addr;\r\nint err;\r\nif ((dev->priv_flags & IFF_EBRIDGE) && event == NETDEV_REGISTER) {\r\nbr_sysfs_addbr(dev);\r\nreturn NOTIFY_DONE;\r\n}\r\np = br_port_get_rtnl(dev);\r\nif (!p)\r\nreturn NOTIFY_DONE;\r\nbr = p->br;\r\nswitch (event) {\r\ncase NETDEV_CHANGEMTU:\r\ndev_set_mtu(br->dev, br_min_mtu(br));\r\nbreak;\r\ncase NETDEV_CHANGEADDR:\r\nspin_lock_bh(&br->lock);\r\nbr_fdb_changeaddr(p, dev->dev_addr);\r\nchanged_addr = br_stp_recalculate_bridge_id(br);\r\nspin_unlock_bh(&br->lock);\r\nif (changed_addr)\r\ncall_netdevice_notifiers(NETDEV_CHANGEADDR, br->dev);\r\nbreak;\r\ncase NETDEV_CHANGE:\r\nbr_port_carrier_check(p);\r\nbreak;\r\ncase NETDEV_FEAT_CHANGE:\r\nnetdev_update_features(br->dev);\r\nbreak;\r\ncase NETDEV_DOWN:\r\nspin_lock_bh(&br->lock);\r\nif (br->dev->flags & IFF_UP)\r\nbr_stp_disable_port(p);\r\nspin_unlock_bh(&br->lock);\r\nbreak;\r\ncase NETDEV_UP:\r\nif (netif_carrier_ok(dev) && (br->dev->flags & IFF_UP)) {\r\nspin_lock_bh(&br->lock);\r\nbr_stp_enable_port(p);\r\nspin_unlock_bh(&br->lock);\r\n}\r\nbreak;\r\ncase NETDEV_UNREGISTER:\r\nbr_del_if(br, dev);\r\nbreak;\r\ncase NETDEV_CHANGENAME:\r\nerr = br_sysfs_renameif(p);\r\nif (err)\r\nreturn notifier_from_errno(err);\r\nbreak;\r\ncase NETDEV_PRE_TYPE_CHANGE:\r\nreturn NOTIFY_BAD;\r\n}\r\nif (event == NETDEV_CHANGEADDR || event == NETDEV_UP ||\r\nevent == NETDEV_CHANGE || event == NETDEV_DOWN)\r\nbr_ifinfo_notify(RTM_NEWLINK, p);\r\nreturn NOTIFY_DONE;\r\n}

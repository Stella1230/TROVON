static void pci_acpi_wake_bus(acpi_handle handle, u32 event, void *context)\r\n{\r\nstruct pci_bus *pci_bus = context;\r\nif (event == ACPI_NOTIFY_DEVICE_WAKE && pci_bus)\r\npci_pme_wakeup_bus(pci_bus);\r\n}\r\nstatic void pci_acpi_wake_dev(acpi_handle handle, u32 event, void *context)\r\n{\r\nstruct pci_dev *pci_dev = context;\r\nif (event != ACPI_NOTIFY_DEVICE_WAKE || !pci_dev)\r\nreturn;\r\nif (!pci_dev->pm_cap || !pci_dev->pme_support\r\n|| pci_check_pme_status(pci_dev)) {\r\nif (pci_dev->pme_poll)\r\npci_dev->pme_poll = false;\r\npci_wakeup_event(pci_dev);\r\npm_runtime_resume(&pci_dev->dev);\r\n}\r\nif (pci_dev->subordinate)\r\npci_pme_wakeup_bus(pci_dev->subordinate);\r\n}\r\nstatic acpi_status add_pm_notifier(struct acpi_device *dev,\r\nacpi_notify_handler handler,\r\nvoid *context)\r\n{\r\nacpi_status status = AE_ALREADY_EXISTS;\r\nmutex_lock(&pci_acpi_pm_notify_mtx);\r\nif (dev->wakeup.flags.notifier_present)\r\ngoto out;\r\nstatus = acpi_install_notify_handler(dev->handle,\r\nACPI_SYSTEM_NOTIFY,\r\nhandler, context);\r\nif (ACPI_FAILURE(status))\r\ngoto out;\r\ndev->wakeup.flags.notifier_present = true;\r\nout:\r\nmutex_unlock(&pci_acpi_pm_notify_mtx);\r\nreturn status;\r\n}\r\nstatic acpi_status remove_pm_notifier(struct acpi_device *dev,\r\nacpi_notify_handler handler)\r\n{\r\nacpi_status status = AE_BAD_PARAMETER;\r\nmutex_lock(&pci_acpi_pm_notify_mtx);\r\nif (!dev->wakeup.flags.notifier_present)\r\ngoto out;\r\nstatus = acpi_remove_notify_handler(dev->handle,\r\nACPI_SYSTEM_NOTIFY,\r\nhandler);\r\nif (ACPI_FAILURE(status))\r\ngoto out;\r\ndev->wakeup.flags.notifier_present = false;\r\nout:\r\nmutex_unlock(&pci_acpi_pm_notify_mtx);\r\nreturn status;\r\n}\r\nacpi_status pci_acpi_add_bus_pm_notifier(struct acpi_device *dev,\r\nstruct pci_bus *pci_bus)\r\n{\r\nreturn add_pm_notifier(dev, pci_acpi_wake_bus, pci_bus);\r\n}\r\nacpi_status pci_acpi_remove_bus_pm_notifier(struct acpi_device *dev)\r\n{\r\nreturn remove_pm_notifier(dev, pci_acpi_wake_bus);\r\n}\r\nacpi_status pci_acpi_add_pm_notifier(struct acpi_device *dev,\r\nstruct pci_dev *pci_dev)\r\n{\r\nreturn add_pm_notifier(dev, pci_acpi_wake_dev, pci_dev);\r\n}\r\nacpi_status pci_acpi_remove_pm_notifier(struct acpi_device *dev)\r\n{\r\nreturn remove_pm_notifier(dev, pci_acpi_wake_dev);\r\n}\r\nstatic pci_power_t acpi_pci_choose_state(struct pci_dev *pdev)\r\n{\r\nint acpi_state;\r\nacpi_state = acpi_pm_device_sleep_state(&pdev->dev, NULL);\r\nif (acpi_state < 0)\r\nreturn PCI_POWER_ERROR;\r\nswitch (acpi_state) {\r\ncase ACPI_STATE_D0:\r\nreturn PCI_D0;\r\ncase ACPI_STATE_D1:\r\nreturn PCI_D1;\r\ncase ACPI_STATE_D2:\r\nreturn PCI_D2;\r\ncase ACPI_STATE_D3_HOT:\r\nreturn PCI_D3hot;\r\ncase ACPI_STATE_D3_COLD:\r\nreturn PCI_D3cold;\r\n}\r\nreturn PCI_POWER_ERROR;\r\n}\r\nstatic bool acpi_pci_power_manageable(struct pci_dev *dev)\r\n{\r\nacpi_handle handle = DEVICE_ACPI_HANDLE(&dev->dev);\r\nreturn handle ? acpi_bus_power_manageable(handle) : false;\r\n}\r\nstatic int acpi_pci_set_power_state(struct pci_dev *dev, pci_power_t state)\r\n{\r\nacpi_handle handle = DEVICE_ACPI_HANDLE(&dev->dev);\r\nacpi_handle tmp;\r\nstatic const u8 state_conv[] = {\r\n[PCI_D0] = ACPI_STATE_D0,\r\n[PCI_D1] = ACPI_STATE_D1,\r\n[PCI_D2] = ACPI_STATE_D2,\r\n[PCI_D3hot] = ACPI_STATE_D3,\r\n[PCI_D3cold] = ACPI_STATE_D3\r\n};\r\nint error = -EINVAL;\r\nif (!handle || ACPI_SUCCESS(acpi_get_handle(handle, "_EJ0", &tmp)))\r\nreturn -ENODEV;\r\nswitch (state) {\r\ncase PCI_D0:\r\ncase PCI_D1:\r\ncase PCI_D2:\r\ncase PCI_D3hot:\r\ncase PCI_D3cold:\r\nerror = acpi_bus_set_power(handle, state_conv[state]);\r\n}\r\nif (!error)\r\ndev_printk(KERN_INFO, &dev->dev,\r\n"power state changed by ACPI to D%d\n", state);\r\nreturn error;\r\n}\r\nstatic bool acpi_pci_can_wakeup(struct pci_dev *dev)\r\n{\r\nacpi_handle handle = DEVICE_ACPI_HANDLE(&dev->dev);\r\nreturn handle ? acpi_bus_can_wakeup(handle) : false;\r\n}\r\nstatic void acpi_pci_propagate_wakeup_enable(struct pci_bus *bus, bool enable)\r\n{\r\nwhile (bus->parent) {\r\nif (!acpi_pm_device_sleep_wake(&bus->self->dev, enable))\r\nreturn;\r\nbus = bus->parent;\r\n}\r\nif (bus->bridge)\r\nacpi_pm_device_sleep_wake(bus->bridge, enable);\r\n}\r\nstatic int acpi_pci_sleep_wake(struct pci_dev *dev, bool enable)\r\n{\r\nif (acpi_pci_can_wakeup(dev))\r\nreturn acpi_pm_device_sleep_wake(&dev->dev, enable);\r\nacpi_pci_propagate_wakeup_enable(dev->bus, enable);\r\nreturn 0;\r\n}\r\nstatic void acpi_pci_propagate_run_wake(struct pci_bus *bus, bool enable)\r\n{\r\nwhile (bus->parent) {\r\nstruct pci_dev *bridge = bus->self;\r\nif (bridge->pme_interrupt)\r\nreturn;\r\nif (!acpi_pm_device_run_wake(&bridge->dev, enable))\r\nreturn;\r\nbus = bus->parent;\r\n}\r\nif (bus->bridge)\r\nacpi_pm_device_run_wake(bus->bridge, enable);\r\n}\r\nstatic int acpi_pci_run_wake(struct pci_dev *dev, bool enable)\r\n{\r\nif (dev->pme_interrupt)\r\nreturn 0;\r\nif (!acpi_pm_device_run_wake(&dev->dev, enable))\r\nreturn 0;\r\nacpi_pci_propagate_run_wake(dev->bus, enable);\r\nreturn 0;\r\n}\r\nstatic int acpi_pci_find_device(struct device *dev, acpi_handle *handle)\r\n{\r\nstruct pci_dev * pci_dev;\r\nu64 addr;\r\npci_dev = to_pci_dev(dev);\r\naddr = (PCI_SLOT(pci_dev->devfn) << 16) | PCI_FUNC(pci_dev->devfn);\r\n*handle = acpi_get_child(DEVICE_ACPI_HANDLE(dev->parent), addr);\r\nif (!*handle)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int acpi_pci_find_root_bridge(struct device *dev, acpi_handle *handle)\r\n{\r\nint num;\r\nunsigned int seg, bus;\r\nnum = sscanf(dev_name(dev), "pci%04x:%02x", &seg, &bus);\r\nif (num != 2)\r\nreturn -ENODEV;\r\n*handle = acpi_get_pci_rootbridge_handle(seg, bus);\r\nif (!*handle)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int __init acpi_pci_init(void)\r\n{\r\nint ret;\r\nif (acpi_gbl_FADT.boot_flags & ACPI_FADT_NO_MSI) {\r\nprintk(KERN_INFO"ACPI FADT declares the system doesn't support MSI, so disable it\n");\r\npci_no_msi();\r\n}\r\nif (acpi_gbl_FADT.boot_flags & ACPI_FADT_NO_ASPM) {\r\nprintk(KERN_INFO"ACPI FADT declares the system doesn't support PCIe ASPM, so disable it\n");\r\npcie_no_aspm();\r\n}\r\nret = register_acpi_bus_type(&acpi_pci_bus);\r\nif (ret)\r\nreturn 0;\r\npci_set_platform_pm(&acpi_pci_platform_pm);\r\nreturn 0;\r\n}

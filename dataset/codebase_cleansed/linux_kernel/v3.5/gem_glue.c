void drm_gem_object_release_wrap(struct drm_gem_object *obj)\r\n{\r\nif (obj->map_list.map) {\r\nstruct drm_gem_mm *mm = obj->dev->mm_private;\r\nstruct drm_map_list *list = &obj->map_list;\r\ndrm_ht_remove_item(&mm->offset_hash, &list->hash);\r\ndrm_mm_put_block(list->file_offset_node);\r\nkfree(list->map);\r\nlist->map = NULL;\r\n}\r\ndrm_gem_object_release(obj);\r\n}\r\nint gem_create_mmap_offset(struct drm_gem_object *obj)\r\n{\r\nstruct drm_device *dev = obj->dev;\r\nstruct drm_gem_mm *mm = dev->mm_private;\r\nstruct drm_map_list *list;\r\nstruct drm_local_map *map;\r\nint ret;\r\nlist = &obj->map_list;\r\nlist->map = kzalloc(sizeof(struct drm_map_list), GFP_KERNEL);\r\nif (list->map == NULL)\r\nreturn -ENOMEM;\r\nmap = list->map;\r\nmap->type = _DRM_GEM;\r\nmap->size = obj->size;\r\nmap->handle = obj;\r\nlist->file_offset_node = drm_mm_search_free(&mm->offset_manager,\r\nobj->size / PAGE_SIZE, 0, 0);\r\nif (!list->file_offset_node) {\r\ndev_err(dev->dev, "failed to allocate offset for bo %d\n",\r\nobj->name);\r\nret = -ENOSPC;\r\ngoto free_it;\r\n}\r\nlist->file_offset_node = drm_mm_get_block(list->file_offset_node,\r\nobj->size / PAGE_SIZE, 0);\r\nif (!list->file_offset_node) {\r\nret = -ENOMEM;\r\ngoto free_it;\r\n}\r\nlist->hash.key = list->file_offset_node->start;\r\nret = drm_ht_insert_item(&mm->offset_hash, &list->hash);\r\nif (ret) {\r\ndev_err(dev->dev, "failed to add to map hash\n");\r\ngoto free_mm;\r\n}\r\nreturn 0;\r\nfree_mm:\r\ndrm_mm_put_block(list->file_offset_node);\r\nfree_it:\r\nkfree(list->map);\r\nlist->map = NULL;\r\nreturn ret;\r\n}

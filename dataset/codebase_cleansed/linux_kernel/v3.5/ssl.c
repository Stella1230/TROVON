static void ssl_announce(char *dev_name, int dev)\r\n{\r\nprintk(KERN_INFO "Serial line %d assigned device '%s'\n", dev,\r\ndev_name);\r\n}\r\nstatic int ssl_config(char *str, char **error_out)\r\n{\r\nreturn line_config(serial_lines, ARRAY_SIZE(serial_lines), str, &opts,\r\nerror_out);\r\n}\r\nstatic int ssl_get_config(char *dev, char *str, int size, char **error_out)\r\n{\r\nreturn line_get_config(dev, serial_lines, ARRAY_SIZE(serial_lines), str,\r\nsize, error_out);\r\n}\r\nstatic int ssl_remove(int n, char **error_out)\r\n{\r\nreturn line_remove(serial_lines, ARRAY_SIZE(serial_lines), n,\r\nerror_out);\r\n}\r\nstatic int ssl_open(struct tty_struct *tty, struct file *filp)\r\n{\r\nint err = line_open(serial_lines, tty);\r\nif (err)\r\nprintk(KERN_ERR "Failed to open serial line %d, err = %d\n",\r\ntty->index, err);\r\nreturn err;\r\n}\r\nstatic void ssl_console_write(struct console *c, const char *string,\r\nunsigned len)\r\n{\r\nstruct line *line = &serial_lines[c->index];\r\nunsigned long flags;\r\nspin_lock_irqsave(&line->lock, flags);\r\nconsole_write_chan(line->chan_out, string, len);\r\nspin_unlock_irqrestore(&line->lock, flags);\r\n}\r\nstatic struct tty_driver *ssl_console_device(struct console *c, int *index)\r\n{\r\n*index = c->index;\r\nreturn driver.driver;\r\n}\r\nstatic int ssl_console_setup(struct console *co, char *options)\r\n{\r\nstruct line *line = &serial_lines[co->index];\r\nreturn console_open_chan(line, co);\r\n}\r\nstatic int ssl_init(void)\r\n{\r\nchar *new_title;\r\nint err;\r\nint i;\r\nprintk(KERN_INFO "Initializing software serial port version %d\n",\r\nssl_version);\r\nerr = register_lines(&driver, &ssl_ops, serial_lines,\r\nARRAY_SIZE(serial_lines));\r\nif (err)\r\nreturn err;\r\nnew_title = add_xterm_umid(opts.xterm_title);\r\nif (new_title != NULL)\r\nopts.xterm_title = new_title;\r\nfor (i = 0; i < NR_PORTS; i++) {\r\nchar *error;\r\nchar *s = conf[i];\r\nif (!s)\r\ns = def_conf;\r\nif (setup_one_line(serial_lines, i, s, &opts, &error))\r\nprintk(KERN_ERR "setup_one_line failed for "\r\n"device %d : %s\n", i, error);\r\n}\r\nssl_init_done = 1;\r\nregister_console(&ssl_cons);\r\nreturn 0;\r\n}\r\nstatic void ssl_exit(void)\r\n{\r\nif (!ssl_init_done)\r\nreturn;\r\nclose_lines(serial_lines, ARRAY_SIZE(serial_lines));\r\n}\r\nstatic int ssl_chan_setup(char *str)\r\n{\r\nline_setup(conf, NR_PORTS, &def_conf, str, "serial line");\r\nreturn 1;\r\n}

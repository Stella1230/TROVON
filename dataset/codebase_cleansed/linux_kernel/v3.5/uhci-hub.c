static int any_ports_active(struct uhci_hcd *uhci)\r\n{\r\nint port;\r\nfor (port = 0; port < uhci->rh_numports; ++port) {\r\nif ((uhci_readw(uhci, USBPORTSC1 + port * 2) &\r\n(USBPORTSC_CCS | RWC_BITS)) ||\r\ntest_bit(port, &uhci->port_c_suspend))\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int get_hub_status_data(struct uhci_hcd *uhci, char *buf)\r\n{\r\nint port;\r\nint mask = RWC_BITS;\r\nif (ignore_oc)\r\nmask &= ~USBPORTSC_OCC;\r\n*buf = 0;\r\nfor (port = 0; port < uhci->rh_numports; ++port) {\r\nif ((uhci_readw(uhci, USBPORTSC1 + port * 2) & mask) ||\r\ntest_bit(port, &uhci->port_c_suspend))\r\n*buf |= (1 << (port + 1));\r\n}\r\nreturn !!*buf;\r\n}\r\nstatic void uhci_finish_suspend(struct uhci_hcd *uhci, int port,\r\nunsigned long port_addr)\r\n{\r\nint status;\r\nint i;\r\nif (uhci_readw(uhci, port_addr) & SUSPEND_BITS) {\r\nCLR_RH_PORTSTAT(SUSPEND_BITS);\r\nif (test_bit(port, &uhci->resuming_ports))\r\nset_bit(port, &uhci->port_c_suspend);\r\nfor (i = 0; i < 10; ++i) {\r\nif (!(uhci_readw(uhci, port_addr) & SUSPEND_BITS))\r\nbreak;\r\nudelay(1);\r\n}\r\n}\r\nclear_bit(port, &uhci->resuming_ports);\r\n}\r\nstatic void wait_for_HP(struct uhci_hcd *uhci, unsigned long port_addr)\r\n{\r\nint i;\r\nfor (i = 10; i < 250; i += 10) {\r\nif (uhci_readw(uhci, port_addr) & USBPORTSC_CSC)\r\nreturn;\r\nudelay(10);\r\n}\r\n}\r\nstatic void uhci_check_ports(struct uhci_hcd *uhci)\r\n{\r\nunsigned int port;\r\nunsigned long port_addr;\r\nint status;\r\nfor (port = 0; port < uhci->rh_numports; ++port) {\r\nport_addr = USBPORTSC1 + 2 * port;\r\nstatus = uhci_readw(uhci, port_addr);\r\nif (unlikely(status & USBPORTSC_PR)) {\r\nif (time_after_eq(jiffies, uhci->ports_timeout)) {\r\nCLR_RH_PORTSTAT(USBPORTSC_PR);\r\nudelay(10);\r\nif (uhci->wait_for_hp)\r\nwait_for_HP(uhci, port_addr);\r\nCLR_RH_PORTSTAT(USBPORTSC_CSC | USBPORTSC_PEC);\r\nSET_RH_PORTSTAT(USBPORTSC_PE);\r\n}\r\n}\r\nif (unlikely(status & USBPORTSC_RD)) {\r\nif (!test_bit(port, &uhci->resuming_ports)) {\r\nset_bit(port, &uhci->resuming_ports);\r\nuhci->ports_timeout = jiffies +\r\nmsecs_to_jiffies(25);\r\nmod_timer(&uhci_to_hcd(uhci)->rh_timer,\r\nuhci->ports_timeout);\r\n} else if (time_after_eq(jiffies,\r\nuhci->ports_timeout)) {\r\nuhci_finish_suspend(uhci, port, port_addr);\r\n}\r\n}\r\n}\r\n}\r\nstatic int uhci_hub_status_data(struct usb_hcd *hcd, char *buf)\r\n{\r\nstruct uhci_hcd *uhci = hcd_to_uhci(hcd);\r\nunsigned long flags;\r\nint status = 0;\r\nspin_lock_irqsave(&uhci->lock, flags);\r\nuhci_scan_schedule(uhci);\r\nif (!HCD_HW_ACCESSIBLE(hcd) || uhci->dead)\r\ngoto done;\r\nuhci_check_ports(uhci);\r\nstatus = get_hub_status_data(uhci, buf);\r\nswitch (uhci->rh_state) {\r\ncase UHCI_RH_SUSPENDED:\r\nif (status || uhci->resuming_ports) {\r\nstatus = 1;\r\nusb_hcd_resume_root_hub(hcd);\r\n}\r\nbreak;\r\ncase UHCI_RH_AUTO_STOPPED:\r\nif (status)\r\nwakeup_rh(uhci);\r\nbreak;\r\ncase UHCI_RH_RUNNING:\r\nif (!any_ports_active(uhci)) {\r\nuhci->rh_state = UHCI_RH_RUNNING_NODEVS;\r\nuhci->auto_stop_time = jiffies + HZ;\r\n}\r\nbreak;\r\ncase UHCI_RH_RUNNING_NODEVS:\r\nif (any_ports_active(uhci))\r\nuhci->rh_state = UHCI_RH_RUNNING;\r\nelse if (time_after_eq(jiffies, uhci->auto_stop_time))\r\nsuspend_rh(uhci, UHCI_RH_AUTO_STOPPED);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ndone:\r\nspin_unlock_irqrestore(&uhci->lock, flags);\r\nreturn status;\r\n}\r\nstatic int uhci_hub_control(struct usb_hcd *hcd, u16 typeReq, u16 wValue,\r\nu16 wIndex, char *buf, u16 wLength)\r\n{\r\nstruct uhci_hcd *uhci = hcd_to_uhci(hcd);\r\nint status, lstatus, retval = 0, len = 0;\r\nunsigned int port = wIndex - 1;\r\nunsigned long port_addr = USBPORTSC1 + 2 * port;\r\nu16 wPortChange, wPortStatus;\r\nunsigned long flags;\r\nif (!HCD_HW_ACCESSIBLE(hcd) || uhci->dead)\r\nreturn -ETIMEDOUT;\r\nspin_lock_irqsave(&uhci->lock, flags);\r\nswitch (typeReq) {\r\ncase GetHubStatus:\r\n*(__le32 *)buf = cpu_to_le32(0);\r\nOK(4);\r\ncase GetPortStatus:\r\nif (port >= uhci->rh_numports)\r\ngoto err;\r\nuhci_check_ports(uhci);\r\nstatus = uhci_readw(uhci, port_addr);\r\nif (uhci->oc_low)\r\nstatus ^= USBPORTSC_OC;\r\nwPortChange = lstatus = 0;\r\nif (status & USBPORTSC_CSC)\r\nwPortChange |= USB_PORT_STAT_C_CONNECTION;\r\nif (status & USBPORTSC_PEC)\r\nwPortChange |= USB_PORT_STAT_C_ENABLE;\r\nif ((status & USBPORTSC_OCC) && !ignore_oc)\r\nwPortChange |= USB_PORT_STAT_C_OVERCURRENT;\r\nif (test_bit(port, &uhci->port_c_suspend)) {\r\nwPortChange |= USB_PORT_STAT_C_SUSPEND;\r\nlstatus |= 1;\r\n}\r\nif (test_bit(port, &uhci->resuming_ports))\r\nlstatus |= 4;\r\nwPortStatus = USB_PORT_STAT_POWER;\r\nif (status & USBPORTSC_CCS)\r\nwPortStatus |= USB_PORT_STAT_CONNECTION;\r\nif (status & USBPORTSC_PE) {\r\nwPortStatus |= USB_PORT_STAT_ENABLE;\r\nif (status & SUSPEND_BITS)\r\nwPortStatus |= USB_PORT_STAT_SUSPEND;\r\n}\r\nif (status & USBPORTSC_OC)\r\nwPortStatus |= USB_PORT_STAT_OVERCURRENT;\r\nif (status & USBPORTSC_PR)\r\nwPortStatus |= USB_PORT_STAT_RESET;\r\nif (status & USBPORTSC_LSDA)\r\nwPortStatus |= USB_PORT_STAT_LOW_SPEED;\r\nif (wPortChange)\r\ndev_dbg(uhci_dev(uhci), "port %d portsc %04x,%02x\n",\r\nwIndex, status, lstatus);\r\n*(__le16 *)buf = cpu_to_le16(wPortStatus);\r\n*(__le16 *)(buf + 2) = cpu_to_le16(wPortChange);\r\nOK(4);\r\ncase SetHubFeature:\r\ncase ClearHubFeature:\r\nswitch (wValue) {\r\ncase C_HUB_OVER_CURRENT:\r\ncase C_HUB_LOCAL_POWER:\r\nOK(0);\r\ndefault:\r\ngoto err;\r\n}\r\nbreak;\r\ncase SetPortFeature:\r\nif (port >= uhci->rh_numports)\r\ngoto err;\r\nswitch (wValue) {\r\ncase USB_PORT_FEAT_SUSPEND:\r\nSET_RH_PORTSTAT(USBPORTSC_SUSP);\r\nOK(0);\r\ncase USB_PORT_FEAT_RESET:\r\nSET_RH_PORTSTAT(USBPORTSC_PR);\r\nuhci_finish_suspend(uhci, port, port_addr);\r\nuhci->ports_timeout = jiffies + msecs_to_jiffies(50);\r\nOK(0);\r\ncase USB_PORT_FEAT_POWER:\r\nOK(0);\r\ndefault:\r\ngoto err;\r\n}\r\nbreak;\r\ncase ClearPortFeature:\r\nif (port >= uhci->rh_numports)\r\ngoto err;\r\nswitch (wValue) {\r\ncase USB_PORT_FEAT_ENABLE:\r\nCLR_RH_PORTSTAT(USBPORTSC_PE);\r\nuhci_finish_suspend(uhci, port, port_addr);\r\nOK(0);\r\ncase USB_PORT_FEAT_C_ENABLE:\r\nCLR_RH_PORTSTAT(USBPORTSC_PEC);\r\nOK(0);\r\ncase USB_PORT_FEAT_SUSPEND:\r\nif (!(uhci_readw(uhci, port_addr) & USBPORTSC_SUSP)) {\r\nuhci_finish_suspend(uhci, port, port_addr);\r\n} else if (!test_and_set_bit(port,\r\n&uhci->resuming_ports)) {\r\nSET_RH_PORTSTAT(USBPORTSC_RD);\r\nif (!(uhci_readw(uhci, port_addr) &\r\nUSBPORTSC_RD))\r\nuhci_finish_suspend(uhci, port,\r\nport_addr);\r\nelse\r\nuhci->ports_timeout = jiffies +\r\nmsecs_to_jiffies(20);\r\n}\r\nOK(0);\r\ncase USB_PORT_FEAT_C_SUSPEND:\r\nclear_bit(port, &uhci->port_c_suspend);\r\nOK(0);\r\ncase USB_PORT_FEAT_POWER:\r\ngoto err;\r\ncase USB_PORT_FEAT_C_CONNECTION:\r\nCLR_RH_PORTSTAT(USBPORTSC_CSC);\r\nOK(0);\r\ncase USB_PORT_FEAT_C_OVER_CURRENT:\r\nCLR_RH_PORTSTAT(USBPORTSC_OCC);\r\nOK(0);\r\ncase USB_PORT_FEAT_C_RESET:\r\nOK(0);\r\ndefault:\r\ngoto err;\r\n}\r\nbreak;\r\ncase GetHubDescriptor:\r\nlen = min_t(unsigned int, sizeof(root_hub_hub_des), wLength);\r\nmemcpy(buf, root_hub_hub_des, len);\r\nif (len > 2)\r\nbuf[2] = uhci->rh_numports;\r\nOK(len);\r\ndefault:\r\nerr:\r\nretval = -EPIPE;\r\n}\r\nspin_unlock_irqrestore(&uhci->lock, flags);\r\nreturn retval;\r\n}

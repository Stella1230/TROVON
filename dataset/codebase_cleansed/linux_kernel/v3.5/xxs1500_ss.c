static irqreturn_t cdirq(int irq, void *data)\r\n{\r\nstruct xxs1500_pcmcia_sock *sock = data;\r\npcmcia_parse_events(&sock->socket, SS_DETECT);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int xxs1500_pcmcia_configure(struct pcmcia_socket *skt,\r\nstruct socket_state_t *state)\r\n{\r\nstruct xxs1500_pcmcia_sock *sock = to_xxs_socket(skt);\r\nunsigned int changed;\r\nswitch (state->Vcc) {\r\ncase 0:\r\ngpio_set_value(GPIO_POWER, 1);\r\nbreak;\r\ncase 33:\r\ngpio_set_value(GPIO_POWER, 0);\r\nbreak;\r\ncase 50:\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nchanged = state->flags ^ sock->old_flags;\r\nif (changed & SS_RESET) {\r\nif (state->flags & SS_RESET) {\r\ngpio_set_value(GPIO_RESET, 1);\r\ngpio_set_value(GPIO_OUTEN, 1);\r\n} else {\r\ngpio_set_value(GPIO_RESET, 0);\r\ngpio_set_value(GPIO_OUTEN, 0);\r\nmsleep(500);\r\n}\r\n}\r\nsock->old_flags = state->flags;\r\nreturn 0;\r\n}\r\nstatic int xxs1500_pcmcia_get_status(struct pcmcia_socket *skt,\r\nunsigned int *value)\r\n{\r\nunsigned int status;\r\nint i;\r\nstatus = 0;\r\nif (!gpio_get_value(GPIO_CDA) && !gpio_get_value(GPIO_CDB))\r\nstatus |= SS_DETECT;\r\ni = (!!gpio_get_value(GPIO_VSL)) | ((!!gpio_get_value(GPIO_VSH)) << 1);\r\nswitch (i) {\r\ncase 0:\r\ncase 1:\r\ncase 2:\r\nstatus |= SS_3VCARD;\r\nbreak;\r\ncase 3:\r\ndefault:\r\nstatus |= SS_XVCARD;\r\n}\r\nstatus |= gpio_get_value(GPIO_POWER) ? 0 : SS_POWERON;\r\nstatus |= gpio_get_value(GPIO_RESET) ? SS_RESET : SS_READY;\r\nstatus |= gpio_get_value(GPIO_BATTDEAD) ? 0 : SS_BATDEAD;\r\nstatus |= gpio_get_value(GPIO_BATTWARN) ? 0 : SS_BATWARN;\r\n*value = status;\r\nreturn 0;\r\n}\r\nstatic int xxs1500_pcmcia_sock_init(struct pcmcia_socket *skt)\r\n{\r\ngpio_direction_input(GPIO_CDA);\r\ngpio_direction_input(GPIO_CDB);\r\ngpio_direction_input(GPIO_VSL);\r\ngpio_direction_input(GPIO_VSH);\r\ngpio_direction_input(GPIO_BATTDEAD);\r\ngpio_direction_input(GPIO_BATTWARN);\r\ngpio_direction_output(GPIO_RESET, 1);\r\ngpio_direction_output(GPIO_OUTEN, 1);\r\ngpio_direction_output(GPIO_POWER, 1);\r\nreturn 0;\r\n}\r\nstatic int xxs1500_pcmcia_sock_suspend(struct pcmcia_socket *skt)\r\n{\r\nreturn 0;\r\n}\r\nstatic int au1x00_pcmcia_set_io_map(struct pcmcia_socket *skt,\r\nstruct pccard_io_map *map)\r\n{\r\nstruct xxs1500_pcmcia_sock *sock = to_xxs_socket(skt);\r\nmap->start = (u32)sock->virt_io;\r\nmap->stop = map->start + IO_MAP_SIZE;\r\nreturn 0;\r\n}\r\nstatic int au1x00_pcmcia_set_mem_map(struct pcmcia_socket *skt,\r\nstruct pccard_mem_map *map)\r\n{\r\nstruct xxs1500_pcmcia_sock *sock = to_xxs_socket(skt);\r\nif (map->flags & MAP_ATTRIB)\r\nmap->static_start = sock->phys_attr + map->card_start;\r\nelse\r\nmap->static_start = sock->phys_mem + map->card_start;\r\nreturn 0;\r\n}\r\nstatic int __devinit xxs1500_pcmcia_probe(struct platform_device *pdev)\r\n{\r\nstruct xxs1500_pcmcia_sock *sock;\r\nstruct resource *r;\r\nint ret, irq;\r\nsock = kzalloc(sizeof(struct xxs1500_pcmcia_sock), GFP_KERNEL);\r\nif (!sock)\r\nreturn -ENOMEM;\r\nret = -ENODEV;\r\nr = platform_get_resource_byname(pdev, IORESOURCE_MEM, "pcmcia-attr");\r\nif (!r) {\r\ndev_err(&pdev->dev, "missing 'pcmcia-attr' resource!\n");\r\ngoto out0;\r\n}\r\nsock->phys_attr = r->start;\r\nr = platform_get_resource_byname(pdev, IORESOURCE_MEM, "pcmcia-mem");\r\nif (!r) {\r\ndev_err(&pdev->dev, "missing 'pcmcia-mem' resource!\n");\r\ngoto out0;\r\n}\r\nsock->phys_mem = r->start;\r\nr = platform_get_resource_byname(pdev, IORESOURCE_MEM, "pcmcia-io");\r\nif (!r) {\r\ndev_err(&pdev->dev, "missing 'pcmcia-io' resource!\n");\r\ngoto out0;\r\n}\r\nsock->phys_io = r->start;\r\nsock->virt_io = (void *)(ioremap(sock->phys_io, IO_MAP_SIZE) -\r\nmips_io_port_base);\r\nif (!sock->virt_io) {\r\ndev_err(&pdev->dev, "cannot remap IO area\n");\r\nret = -ENOMEM;\r\ngoto out0;\r\n}\r\nsock->socket.ops = &xxs1500_pcmcia_operations;\r\nsock->socket.owner = THIS_MODULE;\r\nsock->socket.pci_irq = gpio_to_irq(GPIO_CARDIRQ);\r\nsock->socket.features = SS_CAP_STATIC_MAP | SS_CAP_PCCARD;\r\nsock->socket.map_size = MEM_MAP_SIZE;\r\nsock->socket.io_offset = (unsigned long)sock->virt_io;\r\nsock->socket.dev.parent = &pdev->dev;\r\nsock->socket.resource_ops = &pccard_static_ops;\r\nplatform_set_drvdata(pdev, sock);\r\nirq = gpio_to_irq(GPIO_CDA);\r\nirq_set_irq_type(irq, IRQ_TYPE_EDGE_BOTH);\r\nret = request_irq(irq, cdirq, 0, "pcmcia_carddetect", sock);\r\nif (ret) {\r\ndev_err(&pdev->dev, "cannot setup cd irq\n");\r\ngoto out1;\r\n}\r\nret = pcmcia_register_socket(&sock->socket);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to register\n");\r\ngoto out2;\r\n}\r\nprintk(KERN_INFO "MyCable XXS1500 PCMCIA socket services\n");\r\nreturn 0;\r\nout2:\r\nfree_irq(gpio_to_irq(GPIO_CDA), sock);\r\nout1:\r\niounmap((void *)(sock->virt_io + (u32)mips_io_port_base));\r\nout0:\r\nkfree(sock);\r\nreturn ret;\r\n}\r\nstatic int __devexit xxs1500_pcmcia_remove(struct platform_device *pdev)\r\n{\r\nstruct xxs1500_pcmcia_sock *sock = platform_get_drvdata(pdev);\r\npcmcia_unregister_socket(&sock->socket);\r\nfree_irq(gpio_to_irq(GPIO_CDA), sock);\r\niounmap((void *)(sock->virt_io + (u32)mips_io_port_base));\r\nkfree(sock);\r\nreturn 0;\r\n}

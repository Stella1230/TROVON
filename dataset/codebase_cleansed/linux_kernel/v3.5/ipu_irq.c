static u32 ipu_read_reg(struct ipu *ipu, unsigned long reg)\r\n{\r\nreturn __raw_readl(ipu->reg_ipu + reg);\r\n}\r\nstatic void ipu_write_reg(struct ipu *ipu, u32 value, unsigned long reg)\r\n{\r\n__raw_writel(value, ipu->reg_ipu + reg);\r\n}\r\nstatic struct ipu_irq_map *src2map(unsigned int src)\r\n{\r\nint i;\r\nfor (i = 0; i < CONFIG_MX3_IPU_IRQS; i++)\r\nif (irq_map[i].source == src)\r\nreturn irq_map + i;\r\nreturn NULL;\r\n}\r\nstatic void ipu_irq_unmask(struct irq_data *d)\r\n{\r\nstruct ipu_irq_map *map = irq_data_get_irq_chip_data(d);\r\nstruct ipu_irq_bank *bank;\r\nuint32_t reg;\r\nunsigned long lock_flags;\r\nraw_spin_lock_irqsave(&bank_lock, lock_flags);\r\nbank = map->bank;\r\nif (!bank) {\r\nraw_spin_unlock_irqrestore(&bank_lock, lock_flags);\r\npr_err("IPU: %s(%u) - unmapped!\n", __func__, d->irq);\r\nreturn;\r\n}\r\nreg = ipu_read_reg(bank->ipu, bank->control);\r\nreg |= (1UL << (map->source & 31));\r\nipu_write_reg(bank->ipu, reg, bank->control);\r\nraw_spin_unlock_irqrestore(&bank_lock, lock_flags);\r\n}\r\nstatic void ipu_irq_mask(struct irq_data *d)\r\n{\r\nstruct ipu_irq_map *map = irq_data_get_irq_chip_data(d);\r\nstruct ipu_irq_bank *bank;\r\nuint32_t reg;\r\nunsigned long lock_flags;\r\nraw_spin_lock_irqsave(&bank_lock, lock_flags);\r\nbank = map->bank;\r\nif (!bank) {\r\nraw_spin_unlock_irqrestore(&bank_lock, lock_flags);\r\npr_err("IPU: %s(%u) - unmapped!\n", __func__, d->irq);\r\nreturn;\r\n}\r\nreg = ipu_read_reg(bank->ipu, bank->control);\r\nreg &= ~(1UL << (map->source & 31));\r\nipu_write_reg(bank->ipu, reg, bank->control);\r\nraw_spin_unlock_irqrestore(&bank_lock, lock_flags);\r\n}\r\nstatic void ipu_irq_ack(struct irq_data *d)\r\n{\r\nstruct ipu_irq_map *map = irq_data_get_irq_chip_data(d);\r\nstruct ipu_irq_bank *bank;\r\nunsigned long lock_flags;\r\nraw_spin_lock_irqsave(&bank_lock, lock_flags);\r\nbank = map->bank;\r\nif (!bank) {\r\nraw_spin_unlock_irqrestore(&bank_lock, lock_flags);\r\npr_err("IPU: %s(%u) - unmapped!\n", __func__, d->irq);\r\nreturn;\r\n}\r\nipu_write_reg(bank->ipu, 1UL << (map->source & 31), bank->status);\r\nraw_spin_unlock_irqrestore(&bank_lock, lock_flags);\r\n}\r\nbool ipu_irq_status(unsigned int irq)\r\n{\r\nstruct ipu_irq_map *map = irq_get_chip_data(irq);\r\nstruct ipu_irq_bank *bank;\r\nunsigned long lock_flags;\r\nbool ret;\r\nraw_spin_lock_irqsave(&bank_lock, lock_flags);\r\nbank = map->bank;\r\nret = bank && ipu_read_reg(bank->ipu, bank->status) &\r\n(1UL << (map->source & 31));\r\nraw_spin_unlock_irqrestore(&bank_lock, lock_flags);\r\nreturn ret;\r\n}\r\nint ipu_irq_map(unsigned int source)\r\n{\r\nint i, ret = -ENOMEM;\r\nstruct ipu_irq_map *map;\r\nmight_sleep();\r\nmutex_lock(&map_lock);\r\nmap = src2map(source);\r\nif (map) {\r\npr_err("IPU: Source %u already mapped to IRQ %u\n", source, map->irq);\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\nfor (i = 0; i < CONFIG_MX3_IPU_IRQS; i++) {\r\nif (irq_map[i].source < 0) {\r\nunsigned long lock_flags;\r\nraw_spin_lock_irqsave(&bank_lock, lock_flags);\r\nirq_map[i].source = source;\r\nirq_map[i].bank = irq_bank + source / 32;\r\nraw_spin_unlock_irqrestore(&bank_lock, lock_flags);\r\nret = irq_map[i].irq;\r\npr_debug("IPU: mapped source %u to IRQ %u\n",\r\nsource, ret);\r\nbreak;\r\n}\r\n}\r\nout:\r\nmutex_unlock(&map_lock);\r\nif (ret < 0)\r\npr_err("IPU: couldn't map source %u: %d\n", source, ret);\r\nreturn ret;\r\n}\r\nint ipu_irq_unmap(unsigned int source)\r\n{\r\nint i, ret = -EINVAL;\r\nmight_sleep();\r\nmutex_lock(&map_lock);\r\nfor (i = 0; i < CONFIG_MX3_IPU_IRQS; i++) {\r\nif (irq_map[i].source == source) {\r\nunsigned long lock_flags;\r\npr_debug("IPU: unmapped source %u from IRQ %u\n",\r\nsource, irq_map[i].irq);\r\nraw_spin_lock_irqsave(&bank_lock, lock_flags);\r\nirq_map[i].source = -EINVAL;\r\nirq_map[i].bank = NULL;\r\nraw_spin_unlock_irqrestore(&bank_lock, lock_flags);\r\nret = 0;\r\nbreak;\r\n}\r\n}\r\nmutex_unlock(&map_lock);\r\nreturn ret;\r\n}\r\nstatic void ipu_irq_err(unsigned int irq, struct irq_desc *desc)\r\n{\r\nstruct ipu *ipu = irq_get_handler_data(irq);\r\nu32 status;\r\nint i, line;\r\nfor (i = IPU_IRQ_NR_FN_BANKS; i < IPU_IRQ_NR_BANKS; i++) {\r\nstruct ipu_irq_bank *bank = irq_bank + i;\r\nraw_spin_lock(&bank_lock);\r\nstatus = ipu_read_reg(ipu, bank->status);\r\nstatus &= ipu_read_reg(ipu, bank->control);\r\nraw_spin_unlock(&bank_lock);\r\nwhile ((line = ffs(status))) {\r\nstruct ipu_irq_map *map;\r\nline--;\r\nstatus &= ~(1UL << line);\r\nraw_spin_lock(&bank_lock);\r\nmap = src2map(32 * i + line);\r\nif (map)\r\nirq = map->irq;\r\nraw_spin_unlock(&bank_lock);\r\nif (!map) {\r\npr_err("IPU: Interrupt on unmapped source %u bank %d\n",\r\nline, i);\r\ncontinue;\r\n}\r\ngeneric_handle_irq(irq);\r\n}\r\n}\r\n}\r\nstatic void ipu_irq_fn(unsigned int irq, struct irq_desc *desc)\r\n{\r\nstruct ipu *ipu = irq_desc_get_handler_data(desc);\r\nu32 status;\r\nint i, line;\r\nfor (i = 0; i < IPU_IRQ_NR_FN_BANKS; i++) {\r\nstruct ipu_irq_bank *bank = irq_bank + i;\r\nraw_spin_lock(&bank_lock);\r\nstatus = ipu_read_reg(ipu, bank->status);\r\nstatus &= ipu_read_reg(ipu, bank->control);\r\nraw_spin_unlock(&bank_lock);\r\nwhile ((line = ffs(status))) {\r\nstruct ipu_irq_map *map;\r\nline--;\r\nstatus &= ~(1UL << line);\r\nraw_spin_lock(&bank_lock);\r\nmap = src2map(32 * i + line);\r\nif (map)\r\nirq = map->irq;\r\nraw_spin_unlock(&bank_lock);\r\nif (!map) {\r\npr_err("IPU: Interrupt on unmapped source %u bank %d\n",\r\nline, i);\r\ncontinue;\r\n}\r\ngeneric_handle_irq(irq);\r\n}\r\n}\r\n}\r\nint __init ipu_irq_attach_irq(struct ipu *ipu, struct platform_device *dev)\r\n{\r\nstruct ipu_platform_data *pdata = dev->dev.platform_data;\r\nunsigned int irq, irq_base, i;\r\nirq_base = pdata->irq_base;\r\nfor (i = 0; i < IPU_IRQ_NR_BANKS; i++)\r\nirq_bank[i].ipu = ipu;\r\nfor (i = 0; i < CONFIG_MX3_IPU_IRQS; i++) {\r\nint ret;\r\nirq = irq_base + i;\r\nret = irq_set_chip(irq, &ipu_irq_chip);\r\nif (ret < 0)\r\nreturn ret;\r\nret = irq_set_chip_data(irq, irq_map + i);\r\nif (ret < 0)\r\nreturn ret;\r\nirq_map[i].ipu = ipu;\r\nirq_map[i].irq = irq;\r\nirq_map[i].source = -EINVAL;\r\nirq_set_handler(irq, handle_level_irq);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(irq, IRQF_VALID | IRQF_PROBE);\r\n#endif\r\n}\r\nirq_set_handler_data(ipu->irq_fn, ipu);\r\nirq_set_chained_handler(ipu->irq_fn, ipu_irq_fn);\r\nirq_set_handler_data(ipu->irq_err, ipu);\r\nirq_set_chained_handler(ipu->irq_err, ipu_irq_err);\r\nreturn 0;\r\n}\r\nvoid ipu_irq_detach_irq(struct ipu *ipu, struct platform_device *dev)\r\n{\r\nstruct ipu_platform_data *pdata = dev->dev.platform_data;\r\nunsigned int irq, irq_base;\r\nirq_base = pdata->irq_base;\r\nirq_set_chained_handler(ipu->irq_fn, NULL);\r\nirq_set_handler_data(ipu->irq_fn, NULL);\r\nirq_set_chained_handler(ipu->irq_err, NULL);\r\nirq_set_handler_data(ipu->irq_err, NULL);\r\nfor (irq = irq_base; irq < irq_base + CONFIG_MX3_IPU_IRQS; irq++) {\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(irq, 0);\r\n#endif\r\nirq_set_chip(irq, NULL);\r\nirq_set_chip_data(irq, NULL);\r\n}\r\n}

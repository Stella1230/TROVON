SYSCALL_DEFINE(fadvise64_64)(int fd, loff_t offset, loff_t len, int advice)\r\n{\r\nstruct file *file = fget(fd);\r\nstruct address_space *mapping;\r\nstruct backing_dev_info *bdi;\r\nloff_t endbyte;\r\npgoff_t start_index;\r\npgoff_t end_index;\r\nunsigned long nrpages;\r\nint ret = 0;\r\nif (!file)\r\nreturn -EBADF;\r\nif (S_ISFIFO(file->f_path.dentry->d_inode->i_mode)) {\r\nret = -ESPIPE;\r\ngoto out;\r\n}\r\nmapping = file->f_mapping;\r\nif (!mapping || len < 0) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nif (mapping->a_ops->get_xip_mem) {\r\nswitch (advice) {\r\ncase POSIX_FADV_NORMAL:\r\ncase POSIX_FADV_RANDOM:\r\ncase POSIX_FADV_SEQUENTIAL:\r\ncase POSIX_FADV_WILLNEED:\r\ncase POSIX_FADV_NOREUSE:\r\ncase POSIX_FADV_DONTNEED:\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\ngoto out;\r\n}\r\nendbyte = offset + len;\r\nif (!len || endbyte < len)\r\nendbyte = -1;\r\nelse\r\nendbyte--;\r\nbdi = mapping->backing_dev_info;\r\nswitch (advice) {\r\ncase POSIX_FADV_NORMAL:\r\nfile->f_ra.ra_pages = bdi->ra_pages;\r\nspin_lock(&file->f_lock);\r\nfile->f_mode &= ~FMODE_RANDOM;\r\nspin_unlock(&file->f_lock);\r\nbreak;\r\ncase POSIX_FADV_RANDOM:\r\nspin_lock(&file->f_lock);\r\nfile->f_mode |= FMODE_RANDOM;\r\nspin_unlock(&file->f_lock);\r\nbreak;\r\ncase POSIX_FADV_SEQUENTIAL:\r\nfile->f_ra.ra_pages = bdi->ra_pages * 2;\r\nspin_lock(&file->f_lock);\r\nfile->f_mode &= ~FMODE_RANDOM;\r\nspin_unlock(&file->f_lock);\r\nbreak;\r\ncase POSIX_FADV_WILLNEED:\r\nif (!mapping->a_ops->readpage) {\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nstart_index = offset >> PAGE_CACHE_SHIFT;\r\nend_index = endbyte >> PAGE_CACHE_SHIFT;\r\nnrpages = end_index - start_index + 1;\r\nif (!nrpages)\r\nnrpages = ~0UL;\r\nret = force_page_cache_readahead(mapping, file,\r\nstart_index,\r\nnrpages);\r\nif (ret > 0)\r\nret = 0;\r\nbreak;\r\ncase POSIX_FADV_NOREUSE:\r\nbreak;\r\ncase POSIX_FADV_DONTNEED:\r\nif (!bdi_write_congested(mapping->backing_dev_info))\r\n__filemap_fdatawrite_range(mapping, offset, endbyte,\r\nWB_SYNC_NONE);\r\nstart_index = (offset+(PAGE_CACHE_SIZE-1)) >> PAGE_CACHE_SHIFT;\r\nend_index = (endbyte >> PAGE_CACHE_SHIFT);\r\nif (end_index >= start_index)\r\ninvalidate_mapping_pages(mapping, start_index,\r\nend_index);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nout:\r\nfput(file);\r\nreturn ret;\r\n}\r\nasmlinkage long SyS_fadvise64_64(long fd, loff_t offset, loff_t len, long advice)\r\n{\r\nreturn SYSC_fadvise64_64((int) fd, offset, len, (int) advice);\r\n}\r\nSYSCALL_DEFINE(fadvise64)(int fd, loff_t offset, size_t len, int advice)\r\n{\r\nreturn sys_fadvise64_64(fd, offset, len, advice);\r\n}\r\nasmlinkage long SyS_fadvise64(long fd, loff_t offset, long len, long advice)\r\n{\r\nreturn SYSC_fadvise64((int) fd, offset, (size_t)len, (int)advice);\r\n}

static int compat_mga_init(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_mga_init32_t init32;\r\ndrm_mga_init_t __user *init;\r\nint err = 0, i;\r\nif (copy_from_user(&init32, (void __user *)arg, sizeof(init32)))\r\nreturn -EFAULT;\r\ninit = compat_alloc_user_space(sizeof(*init));\r\nif (!access_ok(VERIFY_WRITE, init, sizeof(*init))\r\n|| __put_user(init32.func, &init->func)\r\n|| __put_user(init32.sarea_priv_offset, &init->sarea_priv_offset)\r\n|| __put_user(init32.chipset, &init->chipset)\r\n|| __put_user(init32.sgram, &init->sgram)\r\n|| __put_user(init32.maccess, &init->maccess)\r\n|| __put_user(init32.fb_cpp, &init->fb_cpp)\r\n|| __put_user(init32.front_offset, &init->front_offset)\r\n|| __put_user(init32.front_pitch, &init->front_pitch)\r\n|| __put_user(init32.back_offset, &init->back_offset)\r\n|| __put_user(init32.back_pitch, &init->back_pitch)\r\n|| __put_user(init32.depth_cpp, &init->depth_cpp)\r\n|| __put_user(init32.depth_offset, &init->depth_offset)\r\n|| __put_user(init32.depth_pitch, &init->depth_pitch)\r\n|| __put_user(init32.fb_offset, &init->fb_offset)\r\n|| __put_user(init32.mmio_offset, &init->mmio_offset)\r\n|| __put_user(init32.status_offset, &init->status_offset)\r\n|| __put_user(init32.warp_offset, &init->warp_offset)\r\n|| __put_user(init32.primary_offset, &init->primary_offset)\r\n|| __put_user(init32.buffers_offset, &init->buffers_offset))\r\nreturn -EFAULT;\r\nfor (i = 0; i < MGA_NR_TEX_HEAPS; i++) {\r\nerr |=\r\n__put_user(init32.texture_offset[i],\r\n&init->texture_offset[i]);\r\nerr |=\r\n__put_user(init32.texture_size[i], &init->texture_size[i]);\r\n}\r\nif (err)\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_MGA_INIT, (unsigned long)init);\r\n}\r\nstatic int compat_mga_getparam(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_mga_getparam32_t getparam32;\r\ndrm_mga_getparam_t __user *getparam;\r\nif (copy_from_user(&getparam32, (void __user *)arg, sizeof(getparam32)))\r\nreturn -EFAULT;\r\ngetparam = compat_alloc_user_space(sizeof(*getparam));\r\nif (!access_ok(VERIFY_WRITE, getparam, sizeof(*getparam))\r\n|| __put_user(getparam32.param, &getparam->param)\r\n|| __put_user((void __user *)(unsigned long)getparam32.value,\r\n&getparam->value))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_MGA_GETPARAM, (unsigned long)getparam);\r\n}\r\nstatic int compat_mga_dma_bootstrap(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_mga_dma_bootstrap32_t dma_bootstrap32;\r\ndrm_mga_dma_bootstrap_t __user *dma_bootstrap;\r\nint err;\r\nif (copy_from_user(&dma_bootstrap32, (void __user *)arg,\r\nsizeof(dma_bootstrap32)))\r\nreturn -EFAULT;\r\ndma_bootstrap = compat_alloc_user_space(sizeof(*dma_bootstrap));\r\nif (!access_ok(VERIFY_WRITE, dma_bootstrap, sizeof(*dma_bootstrap))\r\n|| __put_user(dma_bootstrap32.texture_handle,\r\n&dma_bootstrap->texture_handle)\r\n|| __put_user(dma_bootstrap32.texture_size,\r\n&dma_bootstrap->texture_size)\r\n|| __put_user(dma_bootstrap32.primary_size,\r\n&dma_bootstrap->primary_size)\r\n|| __put_user(dma_bootstrap32.secondary_bin_count,\r\n&dma_bootstrap->secondary_bin_count)\r\n|| __put_user(dma_bootstrap32.secondary_bin_size,\r\n&dma_bootstrap->secondary_bin_size)\r\n|| __put_user(dma_bootstrap32.agp_mode, &dma_bootstrap->agp_mode)\r\n|| __put_user(dma_bootstrap32.agp_size, &dma_bootstrap->agp_size))\r\nreturn -EFAULT;\r\nerr = drm_ioctl(file, DRM_IOCTL_MGA_DMA_BOOTSTRAP,\r\n(unsigned long)dma_bootstrap);\r\nif (err)\r\nreturn err;\r\nif (__get_user(dma_bootstrap32.texture_handle,\r\n&dma_bootstrap->texture_handle)\r\n|| __get_user(dma_bootstrap32.texture_size,\r\n&dma_bootstrap->texture_size)\r\n|| __get_user(dma_bootstrap32.primary_size,\r\n&dma_bootstrap->primary_size)\r\n|| __get_user(dma_bootstrap32.secondary_bin_count,\r\n&dma_bootstrap->secondary_bin_count)\r\n|| __get_user(dma_bootstrap32.secondary_bin_size,\r\n&dma_bootstrap->secondary_bin_size)\r\n|| __get_user(dma_bootstrap32.agp_mode, &dma_bootstrap->agp_mode)\r\n|| __get_user(dma_bootstrap32.agp_size, &dma_bootstrap->agp_size))\r\nreturn -EFAULT;\r\nif (copy_to_user((void __user *)arg, &dma_bootstrap32,\r\nsizeof(dma_bootstrap32)))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nlong mga_compat_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\r\n{\r\nunsigned int nr = DRM_IOCTL_NR(cmd);\r\ndrm_ioctl_compat_t *fn = NULL;\r\nint ret;\r\nif (nr < DRM_COMMAND_BASE)\r\nreturn drm_compat_ioctl(filp, cmd, arg);\r\nif (nr < DRM_COMMAND_BASE + DRM_ARRAY_SIZE(mga_compat_ioctls))\r\nfn = mga_compat_ioctls[nr - DRM_COMMAND_BASE];\r\nif (fn != NULL)\r\nret = (*fn) (filp, cmd, arg);\r\nelse\r\nret = drm_ioctl(filp, cmd, arg);\r\nreturn ret;\r\n}

int tps65912_set_bits(struct tps65912 *tps65912, u8 reg, u8 mask)\r\n{\r\nu8 data;\r\nint err;\r\nmutex_lock(&tps65912->io_mutex);\r\nerr = tps65912->read(tps65912, reg, 1, &data);\r\nif (err) {\r\ndev_err(tps65912->dev, "Read from reg 0x%x failed\n", reg);\r\ngoto out;\r\n}\r\ndata |= mask;\r\nerr = tps65912->write(tps65912, reg, 1, &data);\r\nif (err)\r\ndev_err(tps65912->dev, "Write to reg 0x%x failed\n", reg);\r\nout:\r\nmutex_unlock(&tps65912->io_mutex);\r\nreturn err;\r\n}\r\nint tps65912_clear_bits(struct tps65912 *tps65912, u8 reg, u8 mask)\r\n{\r\nu8 data;\r\nint err;\r\nmutex_lock(&tps65912->io_mutex);\r\nerr = tps65912->read(tps65912, reg, 1, &data);\r\nif (err) {\r\ndev_err(tps65912->dev, "Read from reg 0x%x failed\n", reg);\r\ngoto out;\r\n}\r\ndata &= ~mask;\r\nerr = tps65912->write(tps65912, reg, 1, &data);\r\nif (err)\r\ndev_err(tps65912->dev, "Write to reg 0x%x failed\n", reg);\r\nout:\r\nmutex_unlock(&tps65912->io_mutex);\r\nreturn err;\r\n}\r\nstatic inline int tps65912_read(struct tps65912 *tps65912, u8 reg)\r\n{\r\nu8 val;\r\nint err;\r\nerr = tps65912->read(tps65912, reg, 1, &val);\r\nif (err < 0)\r\nreturn err;\r\nreturn val;\r\n}\r\nstatic inline int tps65912_write(struct tps65912 *tps65912, u8 reg, u8 val)\r\n{\r\nreturn tps65912->write(tps65912, reg, 1, &val);\r\n}\r\nint tps65912_reg_read(struct tps65912 *tps65912, u8 reg)\r\n{\r\nint data;\r\nmutex_lock(&tps65912->io_mutex);\r\ndata = tps65912_read(tps65912, reg);\r\nif (data < 0)\r\ndev_err(tps65912->dev, "Read from reg 0x%x failed\n", reg);\r\nmutex_unlock(&tps65912->io_mutex);\r\nreturn data;\r\n}\r\nint tps65912_reg_write(struct tps65912 *tps65912, u8 reg, u8 val)\r\n{\r\nint err;\r\nmutex_lock(&tps65912->io_mutex);\r\nerr = tps65912_write(tps65912, reg, val);\r\nif (err < 0)\r\ndev_err(tps65912->dev, "Write for reg 0x%x failed\n", reg);\r\nmutex_unlock(&tps65912->io_mutex);\r\nreturn err;\r\n}\r\nint tps65912_device_init(struct tps65912 *tps65912)\r\n{\r\nstruct tps65912_board *pmic_plat_data = tps65912->dev->platform_data;\r\nstruct tps65912_platform_data *init_data;\r\nint ret, dcdc_avs, value;\r\ninit_data = kzalloc(sizeof(struct tps65912_platform_data), GFP_KERNEL);\r\nif (init_data == NULL)\r\nreturn -ENOMEM;\r\nmutex_init(&tps65912->io_mutex);\r\ndev_set_drvdata(tps65912->dev, tps65912);\r\ndcdc_avs = (pmic_plat_data->is_dcdc1_avs << 0 |\r\npmic_plat_data->is_dcdc2_avs << 1 |\r\npmic_plat_data->is_dcdc3_avs << 2 |\r\npmic_plat_data->is_dcdc4_avs << 3);\r\nif (dcdc_avs) {\r\ntps65912->read(tps65912, TPS65912_I2C_SPI_CFG, 1, &value);\r\ndcdc_avs |= value;\r\ntps65912->write(tps65912, TPS65912_I2C_SPI_CFG, 1, &dcdc_avs);\r\n}\r\nret = mfd_add_devices(tps65912->dev, -1,\r\ntps65912s, ARRAY_SIZE(tps65912s),\r\nNULL, 0);\r\nif (ret < 0)\r\ngoto err;\r\ninit_data->irq = pmic_plat_data->irq;\r\ninit_data->irq_base = pmic_plat_data->irq_base;\r\nret = tps65912_irq_init(tps65912, init_data->irq, init_data);\r\nif (ret < 0)\r\ngoto err;\r\nkfree(init_data);\r\nreturn ret;\r\nerr:\r\nkfree(init_data);\r\nmfd_remove_devices(tps65912->dev);\r\nkfree(tps65912);\r\nreturn ret;\r\n}\r\nvoid tps65912_device_exit(struct tps65912 *tps65912)\r\n{\r\nmfd_remove_devices(tps65912->dev);\r\nkfree(tps65912);\r\n}

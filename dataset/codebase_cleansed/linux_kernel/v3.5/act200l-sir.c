static int __init act200l_sir_init(void)\r\n{\r\nreturn irda_register_dongle(&act200l);\r\n}\r\nstatic void __exit act200l_sir_cleanup(void)\r\n{\r\nirda_unregister_dongle(&act200l);\r\n}\r\nstatic int act200l_open(struct sir_dev *dev)\r\n{\r\nstruct qos_info *qos = &dev->qos;\r\nIRDA_DEBUG(2, "%s()\n", __func__ );\r\nsirdev_set_dtr_rts(dev, TRUE, TRUE);\r\nqos->baud_rate.bits &= IR_9600|IR_19200|IR_38400|IR_57600|IR_115200;\r\nqos->min_turn_time.bits = 0x03;\r\nirda_qos_bits_to_value(qos);\r\nreturn 0;\r\n}\r\nstatic int act200l_close(struct sir_dev *dev)\r\n{\r\nIRDA_DEBUG(2, "%s()\n", __func__ );\r\nsirdev_set_dtr_rts(dev, FALSE, FALSE);\r\nreturn 0;\r\n}\r\nstatic int act200l_change_speed(struct sir_dev *dev, unsigned speed)\r\n{\r\nu8 control[3];\r\nint ret = 0;\r\nIRDA_DEBUG(2, "%s()\n", __func__ );\r\nsirdev_set_dtr_rts(dev, FALSE, TRUE);\r\nswitch (speed) {\r\ndefault:\r\nret = -EINVAL;\r\ncase 9600:\r\ncontrol[0] = ACT200L_REG8 | (ACT200L_9600 & 0x0f);\r\ncontrol[1] = ACT200L_REG9 | ((ACT200L_9600 >> 4) & 0x0f);\r\nbreak;\r\ncase 19200:\r\ncontrol[0] = ACT200L_REG8 | (ACT200L_19200 & 0x0f);\r\ncontrol[1] = ACT200L_REG9 | ((ACT200L_19200 >> 4) & 0x0f);\r\nbreak;\r\ncase 38400:\r\ncontrol[0] = ACT200L_REG8 | (ACT200L_38400 & 0x0f);\r\ncontrol[1] = ACT200L_REG9 | ((ACT200L_38400 >> 4) & 0x0f);\r\nbreak;\r\ncase 57600:\r\ncontrol[0] = ACT200L_REG8 | (ACT200L_57600 & 0x0f);\r\ncontrol[1] = ACT200L_REG9 | ((ACT200L_57600 >> 4) & 0x0f);\r\nbreak;\r\ncase 115200:\r\ncontrol[0] = ACT200L_REG8 | (ACT200L_115200 & 0x0f);\r\ncontrol[1] = ACT200L_REG9 | ((ACT200L_115200 >> 4) & 0x0f);\r\nbreak;\r\n}\r\ncontrol[2] = ACT200L_REG1 | ACT200L_LODB | ACT200L_WIDE;\r\nsirdev_raw_write(dev, control, 3);\r\nmsleep(5);\r\nsirdev_set_dtr_rts(dev, TRUE, TRUE);\r\ndev->speed = speed;\r\nreturn ret;\r\n}\r\nstatic int act200l_reset(struct sir_dev *dev)\r\n{\r\nunsigned state = dev->fsm.substate;\r\nunsigned delay = 0;\r\nstatic const u8 control[9] = {\r\nACT200L_REG15,\r\nACT200L_REG13 | ACT200L_SHDW,\r\nACT200L_REG21 | ACT200L_EXCK | ACT200L_OSCL,\r\nACT200L_REG13,\r\nACT200L_REG7 | ACT200L_ENPOS,\r\nACT200L_REG6 | ACT200L_RS0 | ACT200L_RS1,\r\nACT200L_REG5 | ACT200L_RWIDL,\r\nACT200L_REG4 | ACT200L_OP0 | ACT200L_OP1 | ACT200L_BLKR,\r\nACT200L_REG0 | ACT200L_TXEN | ACT200L_RXEN\r\n};\r\nint ret = 0;\r\nIRDA_DEBUG(2, "%s()\n", __func__ );\r\nswitch (state) {\r\ncase SIRDEV_STATE_DONGLE_RESET:\r\nsirdev_set_dtr_rts(dev, TRUE, FALSE);\r\nstate = ACT200L_STATE_WAIT1_RESET;\r\ndelay = 50;\r\nbreak;\r\ncase ACT200L_STATE_WAIT1_RESET:\r\nsirdev_set_dtr_rts(dev, FALSE, TRUE);\r\nudelay(25);\r\nsirdev_raw_write(dev, control, sizeof(control));\r\nstate = ACT200L_STATE_WAIT2_RESET;\r\ndelay = 15;\r\nbreak;\r\ncase ACT200L_STATE_WAIT2_RESET:\r\nsirdev_set_dtr_rts(dev, TRUE, TRUE);\r\ndev->speed = 9600;\r\nbreak;\r\ndefault:\r\nIRDA_ERROR("%s(), unknown state %d\n", __func__, state);\r\nret = -1;\r\nbreak;\r\n}\r\ndev->fsm.substate = state;\r\nreturn (delay > 0) ? delay : ret;\r\n}

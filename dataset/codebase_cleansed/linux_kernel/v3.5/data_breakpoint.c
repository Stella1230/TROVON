static void sample_hbp_handler(struct perf_event *bp,\r\nstruct perf_sample_data *data,\r\nstruct pt_regs *regs)\r\n{\r\nprintk(KERN_INFO "%s value is changed\n", ksym_name);\r\ndump_stack();\r\nprintk(KERN_INFO "Dump stack from sample_hbp_handler\n");\r\n}\r\nstatic int __init hw_break_module_init(void)\r\n{\r\nint ret;\r\nstruct perf_event_attr attr;\r\nhw_breakpoint_init(&attr);\r\nattr.bp_addr = kallsyms_lookup_name(ksym_name);\r\nattr.bp_len = HW_BREAKPOINT_LEN_4;\r\nattr.bp_type = HW_BREAKPOINT_W | HW_BREAKPOINT_R;\r\nsample_hbp = register_wide_hw_breakpoint(&attr, sample_hbp_handler, NULL);\r\nif (IS_ERR((void __force *)sample_hbp)) {\r\nret = PTR_ERR((void __force *)sample_hbp);\r\ngoto fail;\r\n}\r\nprintk(KERN_INFO "HW Breakpoint for %s write installed\n", ksym_name);\r\nreturn 0;\r\nfail:\r\nprintk(KERN_INFO "Breakpoint registration failed\n");\r\nreturn ret;\r\n}\r\nstatic void __exit hw_break_module_exit(void)\r\n{\r\nunregister_wide_hw_breakpoint(sample_hbp);\r\nprintk(KERN_INFO "HW Breakpoint for %s write uninstalled\n", ksym_name);\r\n}

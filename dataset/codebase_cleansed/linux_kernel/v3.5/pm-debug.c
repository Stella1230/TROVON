void pm_dbg_update_time(struct powerdomain *pwrdm, int prev)\r\n{\r\ns64 t;\r\nif (!pm_dbg_init_done)\r\nreturn ;\r\nt = sched_clock();\r\npwrdm->state_timer[prev] += t - pwrdm->timer;\r\npwrdm->timer = t;\r\n}\r\nstatic int clkdm_dbg_show_counter(struct clockdomain *clkdm, void *user)\r\n{\r\nstruct seq_file *s = (struct seq_file *)user;\r\nif (strcmp(clkdm->name, "emu_clkdm") == 0 ||\r\nstrcmp(clkdm->name, "wkup_clkdm") == 0 ||\r\nstrncmp(clkdm->name, "dpll", 4) == 0)\r\nreturn 0;\r\nseq_printf(s, "%s->%s (%d)", clkdm->name,\r\nclkdm->pwrdm.ptr->name,\r\natomic_read(&clkdm->usecount));\r\nseq_printf(s, "\n");\r\nreturn 0;\r\n}\r\nstatic int pwrdm_dbg_show_counter(struct powerdomain *pwrdm, void *user)\r\n{\r\nstruct seq_file *s = (struct seq_file *)user;\r\nint i;\r\nif (strcmp(pwrdm->name, "emu_pwrdm") == 0 ||\r\nstrcmp(pwrdm->name, "wkup_pwrdm") == 0 ||\r\nstrncmp(pwrdm->name, "dpll", 4) == 0)\r\nreturn 0;\r\nif (pwrdm->state != pwrdm_read_pwrst(pwrdm))\r\nprintk(KERN_ERR "pwrdm state mismatch(%s) %d != %d\n",\r\npwrdm->name, pwrdm->state, pwrdm_read_pwrst(pwrdm));\r\nseq_printf(s, "%s (%s)", pwrdm->name,\r\npwrdm_state_names[pwrdm->state]);\r\nfor (i = 0; i < PWRDM_MAX_PWRSTS; i++)\r\nseq_printf(s, ",%s:%d", pwrdm_state_names[i],\r\npwrdm->state_counter[i]);\r\nseq_printf(s, ",RET-LOGIC-OFF:%d", pwrdm->ret_logic_off_counter);\r\nfor (i = 0; i < pwrdm->banks; i++)\r\nseq_printf(s, ",RET-MEMBANK%d-OFF:%d", i + 1,\r\npwrdm->ret_mem_off_counter[i]);\r\nseq_printf(s, "\n");\r\nreturn 0;\r\n}\r\nstatic int pwrdm_dbg_show_timer(struct powerdomain *pwrdm, void *user)\r\n{\r\nstruct seq_file *s = (struct seq_file *)user;\r\nint i;\r\nif (strcmp(pwrdm->name, "emu_pwrdm") == 0 ||\r\nstrcmp(pwrdm->name, "wkup_pwrdm") == 0 ||\r\nstrncmp(pwrdm->name, "dpll", 4) == 0)\r\nreturn 0;\r\npwrdm_state_switch(pwrdm);\r\nseq_printf(s, "%s (%s)", pwrdm->name,\r\npwrdm_state_names[pwrdm->state]);\r\nfor (i = 0; i < 4; i++)\r\nseq_printf(s, ",%s:%lld", pwrdm_state_names[i],\r\npwrdm->state_timer[i]);\r\nseq_printf(s, "\n");\r\nreturn 0;\r\n}\r\nstatic int pm_dbg_show_counters(struct seq_file *s, void *unused)\r\n{\r\npwrdm_for_each(pwrdm_dbg_show_counter, s);\r\nclkdm_for_each(clkdm_dbg_show_counter, s);\r\nreturn 0;\r\n}\r\nstatic int pm_dbg_show_timers(struct seq_file *s, void *unused)\r\n{\r\npwrdm_for_each(pwrdm_dbg_show_timer, s);\r\nreturn 0;\r\n}\r\nstatic int pm_dbg_open(struct inode *inode, struct file *file)\r\n{\r\nswitch ((int)inode->i_private) {\r\ncase DEBUG_FILE_COUNTERS:\r\nreturn single_open(file, pm_dbg_show_counters,\r\n&inode->i_private);\r\ncase DEBUG_FILE_TIMERS:\r\ndefault:\r\nreturn single_open(file, pm_dbg_show_timers,\r\n&inode->i_private);\r\n};\r\n}\r\nstatic int pwrdm_suspend_get(void *data, u64 *val)\r\n{\r\nint ret = -EINVAL;\r\nif (cpu_is_omap34xx())\r\nret = omap3_pm_get_suspend_state((struct powerdomain *)data);\r\n*val = ret;\r\nif (ret >= 0)\r\nreturn 0;\r\nreturn *val;\r\n}\r\nstatic int pwrdm_suspend_set(void *data, u64 val)\r\n{\r\nif (cpu_is_omap34xx())\r\nreturn omap3_pm_set_suspend_state(\r\n(struct powerdomain *)data, (int)val);\r\nreturn -EINVAL;\r\n}\r\nstatic int __init pwrdms_setup(struct powerdomain *pwrdm, void *dir)\r\n{\r\nint i;\r\ns64 t;\r\nstruct dentry *d;\r\nt = sched_clock();\r\nfor (i = 0; i < 4; i++)\r\npwrdm->state_timer[i] = 0;\r\npwrdm->timer = t;\r\nif (strncmp(pwrdm->name, "dpll", 4) == 0)\r\nreturn 0;\r\nd = debugfs_create_dir(pwrdm->name, (struct dentry *)dir);\r\nif (!(IS_ERR_OR_NULL(d)))\r\n(void) debugfs_create_file("suspend", S_IRUGO|S_IWUSR, d,\r\n(void *)pwrdm, &pwrdm_suspend_fops);\r\nreturn 0;\r\n}\r\nstatic int option_get(void *data, u64 *val)\r\n{\r\nu32 *option = data;\r\n*val = *option;\r\nreturn 0;\r\n}\r\nstatic int option_set(void *data, u64 val)\r\n{\r\nu32 *option = data;\r\n*option = val;\r\nif (option == &enable_off_mode) {\r\nif (val)\r\nomap_pm_enable_off_mode();\r\nelse\r\nomap_pm_disable_off_mode();\r\nif (cpu_is_omap34xx())\r\nomap3_pm_off_mode_enable(val);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init pm_dbg_init(void)\r\n{\r\nstruct dentry *d;\r\nif (pm_dbg_init_done)\r\nreturn 0;\r\nd = debugfs_create_dir("pm_debug", NULL);\r\nif (IS_ERR_OR_NULL(d))\r\nreturn PTR_ERR(d);\r\n(void) debugfs_create_file("count", S_IRUGO,\r\nd, (void *)DEBUG_FILE_COUNTERS, &debug_fops);\r\n(void) debugfs_create_file("time", S_IRUGO,\r\nd, (void *)DEBUG_FILE_TIMERS, &debug_fops);\r\npwrdm_for_each(pwrdms_setup, (void *)d);\r\n(void) debugfs_create_file("enable_off_mode", S_IRUGO | S_IWUSR, d,\r\n&enable_off_mode, &pm_dbg_option_fops);\r\npm_dbg_init_done = 1;\r\nreturn 0;\r\n}

static void xhci_plat_quirks(struct device *dev, struct xhci_hcd *xhci)\r\n{\r\nxhci->quirks |= XHCI_BROKEN_MSI;\r\n}\r\nstatic int xhci_plat_setup(struct usb_hcd *hcd)\r\n{\r\nreturn xhci_gen_setup(hcd, xhci_plat_quirks);\r\n}\r\nstatic int xhci_plat_probe(struct platform_device *pdev)\r\n{\r\nconst struct hc_driver *driver;\r\nstruct xhci_hcd *xhci;\r\nstruct resource *res;\r\nstruct usb_hcd *hcd;\r\nint ret;\r\nint irq;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\ndriver = &xhci_plat_xhci_driver;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0)\r\nreturn -ENODEV;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\nhcd = usb_create_hcd(driver, &pdev->dev, dev_name(&pdev->dev));\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len,\r\ndriver->description)) {\r\ndev_dbg(&pdev->dev, "controller already in use\n");\r\nret = -EBUSY;\r\ngoto put_hcd;\r\n}\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs) {\r\ndev_dbg(&pdev->dev, "error mapping memory\n");\r\nret = -EFAULT;\r\ngoto release_mem_region;\r\n}\r\nret = usb_add_hcd(hcd, irq, IRQF_SHARED);\r\nif (ret)\r\ngoto unmap_registers;\r\nhcd = dev_get_drvdata(&pdev->dev);\r\nxhci = hcd_to_xhci(hcd);\r\nxhci->shared_hcd = usb_create_shared_hcd(driver, &pdev->dev,\r\ndev_name(&pdev->dev), hcd);\r\nif (!xhci->shared_hcd) {\r\nret = -ENOMEM;\r\ngoto dealloc_usb2_hcd;\r\n}\r\n*((struct xhci_hcd **) xhci->shared_hcd->hcd_priv) = xhci;\r\nret = usb_add_hcd(xhci->shared_hcd, irq, IRQF_SHARED);\r\nif (ret)\r\ngoto put_usb3_hcd;\r\nreturn 0;\r\nput_usb3_hcd:\r\nusb_put_hcd(xhci->shared_hcd);\r\ndealloc_usb2_hcd:\r\nusb_remove_hcd(hcd);\r\nunmap_registers:\r\niounmap(hcd->regs);\r\nrelease_mem_region:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nput_hcd:\r\nusb_put_hcd(hcd);\r\nreturn ret;\r\n}\r\nstatic int xhci_plat_remove(struct platform_device *dev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(dev);\r\nstruct xhci_hcd *xhci = hcd_to_xhci(hcd);\r\nusb_remove_hcd(xhci->shared_hcd);\r\nusb_put_hcd(xhci->shared_hcd);\r\nusb_remove_hcd(hcd);\r\niounmap(hcd->regs);\r\nusb_put_hcd(hcd);\r\nkfree(xhci);\r\nreturn 0;\r\n}\r\nint xhci_register_plat(void)\r\n{\r\nreturn platform_driver_register(&usb_xhci_driver);\r\n}\r\nvoid xhci_unregister_plat(void)\r\n{\r\nplatform_driver_unregister(&usb_xhci_driver);\r\n}

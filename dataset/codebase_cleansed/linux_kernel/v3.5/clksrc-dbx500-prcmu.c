static cycle_t clksrc_dbx500_prcmu_read(struct clocksource *cs)\r\n{\r\nu32 count, count2;\r\ndo {\r\ncount = readl(clksrc_dbx500_timer_base +\r\nPRCMU_TIMER_DOWNCOUNT);\r\ncount2 = readl(clksrc_dbx500_timer_base +\r\nPRCMU_TIMER_DOWNCOUNT);\r\n} while (count2 != count);\r\nreturn ~count;\r\n}\r\nstatic u32 notrace dbx500_prcmu_sched_clock_read(void)\r\n{\r\nif (unlikely(!clksrc_dbx500_timer_base))\r\nreturn 0;\r\nreturn clksrc_dbx500_prcmu_read(&clocksource_dbx500_prcmu);\r\n}\r\nvoid __init clksrc_dbx500_prcmu_init(void __iomem *base)\r\n{\r\nclksrc_dbx500_timer_base = base;\r\nif (readl(clksrc_dbx500_timer_base + PRCMU_TIMER_MODE) !=\r\nTIMER_MODE_CONTINOUS) {\r\nwritel(TIMER_MODE_CONTINOUS,\r\nclksrc_dbx500_timer_base + PRCMU_TIMER_MODE);\r\nwritel(TIMER_DOWNCOUNT_VAL,\r\nclksrc_dbx500_timer_base + PRCMU_TIMER_REF);\r\n}\r\n#ifdef CONFIG_CLKSRC_DBX500_PRCMU_SCHED_CLOCK\r\nsetup_sched_clock(dbx500_prcmu_sched_clock_read,\r\n32, RATE_32K);\r\n#endif\r\nclocksource_register_hz(&clocksource_dbx500_prcmu, RATE_32K);\r\n}

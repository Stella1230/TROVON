void chipcHw_pll2Enable(uint32_t vcoFreqHz)\r\n{\r\nuint32_t pllPreDivider2 = 0;\r\n{\r\nREG_LOCAL_IRQ_SAVE;\r\npChipcHw->PLLConfig2 =\r\nchipcHw_REG_PLL_CONFIG_D_RESET |\r\nchipcHw_REG_PLL_CONFIG_A_RESET;\r\npllPreDivider2 = chipcHw_REG_PLL_PREDIVIDER_POWER_DOWN |\r\nchipcHw_REG_PLL_PREDIVIDER_NDIV_MODE_INTEGER |\r\n(chipcHw_REG_PLL_PREDIVIDER_NDIV_i(vcoFreqHz) <<\r\nchipcHw_REG_PLL_PREDIVIDER_NDIV_SHIFT) |\r\n(chipcHw_REG_PLL_PREDIVIDER_P1 <<\r\nchipcHw_REG_PLL_PREDIVIDER_P1_SHIFT) |\r\n(chipcHw_REG_PLL_PREDIVIDER_P2 <<\r\nchipcHw_REG_PLL_PREDIVIDER_P2_SHIFT);\r\npChipcHw->PLLStatus |= chipcHw_REG_PLL_STATUS_CONTROL_ENABLE;\r\npChipcHw->PLLPreDivider2 = pllPreDivider2;\r\npChipcHw->PLLDivider2 = chipcHw_REG_PLL_DIVIDER_NDIV_f;\r\npChipcHw->PLLControl12 = 0x38000700;\r\npChipcHw->PLLControl22 = 0x00000015;\r\nif (vcoFreqHz > chipcHw_REG_PLL_CONFIG_VCO_SPLIT_FREQ) {\r\npChipcHw->PLLConfig2 = chipcHw_REG_PLL_CONFIG_D_RESET |\r\nchipcHw_REG_PLL_CONFIG_A_RESET |\r\nchipcHw_REG_PLL_CONFIG_VCO_1601_3200 |\r\nchipcHw_REG_PLL_CONFIG_POWER_DOWN;\r\n} else {\r\npChipcHw->PLLConfig2 = chipcHw_REG_PLL_CONFIG_D_RESET |\r\nchipcHw_REG_PLL_CONFIG_A_RESET |\r\nchipcHw_REG_PLL_CONFIG_VCO_800_1600 |\r\nchipcHw_REG_PLL_CONFIG_POWER_DOWN;\r\n}\r\nREG_LOCAL_IRQ_RESTORE;\r\n}\r\nudelay(1);\r\n{\r\nREG_LOCAL_IRQ_SAVE;\r\npChipcHw->PLLConfig2 &=\r\n~(chipcHw_REG_PLL_CONFIG_A_RESET |\r\nchipcHw_REG_PLL_CONFIG_POWER_DOWN);\r\nREG_LOCAL_IRQ_RESTORE;\r\n}\r\nwhile (!(pChipcHw->PLLStatus2 & chipcHw_REG_PLL_STATUS_LOCKED))\r\n;\r\n{\r\nREG_LOCAL_IRQ_SAVE;\r\npChipcHw->PLLConfig2 &= ~chipcHw_REG_PLL_CONFIG_D_RESET;\r\nREG_LOCAL_IRQ_RESTORE;\r\n}\r\n}\r\nvoid chipcHw_pll1Enable(uint32_t vcoFreqHz, chipcHw_SPREAD_SPECTRUM_e ssSupport)\r\n{\r\nuint32_t pllPreDivider = 0;\r\n{\r\nREG_LOCAL_IRQ_SAVE;\r\npChipcHw->PLLConfig =\r\nchipcHw_REG_PLL_CONFIG_D_RESET |\r\nchipcHw_REG_PLL_CONFIG_A_RESET;\r\nif (ssSupport == chipcHw_SPREAD_SPECTRUM_ALLOW) {\r\npllPreDivider =\r\nchipcHw_REG_PLL_PREDIVIDER_NDIV_MODE_MASH_1_8 |\r\n((chipcHw_REG_PLL_PREDIVIDER_NDIV_i(vcoFreqHz) -\r\n1) << chipcHw_REG_PLL_PREDIVIDER_NDIV_SHIFT) |\r\n(chipcHw_REG_PLL_PREDIVIDER_P1 <<\r\nchipcHw_REG_PLL_PREDIVIDER_P1_SHIFT) |\r\n(chipcHw_REG_PLL_PREDIVIDER_P2 <<\r\nchipcHw_REG_PLL_PREDIVIDER_P2_SHIFT);\r\n} else {\r\npllPreDivider = chipcHw_REG_PLL_PREDIVIDER_POWER_DOWN |\r\nchipcHw_REG_PLL_PREDIVIDER_NDIV_MODE_INTEGER |\r\n(chipcHw_REG_PLL_PREDIVIDER_NDIV_i(vcoFreqHz) <<\r\nchipcHw_REG_PLL_PREDIVIDER_NDIV_SHIFT) |\r\n(chipcHw_REG_PLL_PREDIVIDER_P1 <<\r\nchipcHw_REG_PLL_PREDIVIDER_P1_SHIFT) |\r\n(chipcHw_REG_PLL_PREDIVIDER_P2 <<\r\nchipcHw_REG_PLL_PREDIVIDER_P2_SHIFT);\r\n}\r\npChipcHw->PLLStatus |= chipcHw_REG_PLL_STATUS_CONTROL_ENABLE;\r\npChipcHw->PLLPreDivider = pllPreDivider;\r\nif (ssSupport == chipcHw_SPREAD_SPECTRUM_ALLOW) {\r\npChipcHw->PLLDivider = chipcHw_REG_PLL_DIVIDER_M1DIV |\r\nchipcHw_REG_PLL_DIVIDER_NDIV_f_SS;\r\n} else {\r\npChipcHw->PLLDivider = chipcHw_REG_PLL_DIVIDER_M1DIV |\r\nchipcHw_REG_PLL_DIVIDER_NDIV_f;\r\n}\r\nif (vcoFreqHz > chipcHw_REG_PLL_CONFIG_VCO_SPLIT_FREQ) {\r\npChipcHw->PLLConfig = chipcHw_REG_PLL_CONFIG_D_RESET |\r\nchipcHw_REG_PLL_CONFIG_A_RESET |\r\nchipcHw_REG_PLL_CONFIG_VCO_1601_3200 |\r\nchipcHw_REG_PLL_CONFIG_POWER_DOWN;\r\n} else {\r\npChipcHw->PLLConfig = chipcHw_REG_PLL_CONFIG_D_RESET |\r\nchipcHw_REG_PLL_CONFIG_A_RESET |\r\nchipcHw_REG_PLL_CONFIG_VCO_800_1600 |\r\nchipcHw_REG_PLL_CONFIG_POWER_DOWN;\r\n}\r\nREG_LOCAL_IRQ_RESTORE;\r\nudelay(1);\r\n{\r\nREG_LOCAL_IRQ_SAVE;\r\npChipcHw->PLLConfig &=\r\n~(chipcHw_REG_PLL_CONFIG_A_RESET |\r\nchipcHw_REG_PLL_CONFIG_POWER_DOWN);\r\nREG_LOCAL_IRQ_RESTORE;\r\n}\r\nwhile (!(pChipcHw->PLLStatus & chipcHw_REG_PLL_STATUS_LOCKED)\r\n|| !(pChipcHw->\r\nPLLStatus2 & chipcHw_REG_PLL_STATUS_LOCKED))\r\n;\r\n{\r\nREG_LOCAL_IRQ_SAVE;\r\npChipcHw->PLLConfig &= ~chipcHw_REG_PLL_CONFIG_D_RESET;\r\nREG_LOCAL_IRQ_RESTORE;\r\n}\r\n}\r\n}\r\nvoid chipcHw_Init(chipcHw_INIT_PARAM_t *initParam\r\n) {\r\n#if !(defined(__KERNEL__) && !defined(STANDALONE))\r\ndelay_init();\r\n#endif\r\nif (!(chipcHw_getStickyBits() & chipcHw_REG_STICKY_CHIP_WARM_RESET)) {\r\nchipcHw_pll1Enable(initParam->pllVcoFreqHz,\r\ninitParam->ssSupport);\r\nchipcHw_pll2Enable(initParam->pll2VcoFreqHz);\r\n} else {\r\nchipcHw_clearStickyBits(chipcHw_REG_STICKY_CHIP_WARM_RESET);\r\n}\r\nchipcHw_clearStickyBits(chipcHw_REG_STICKY_CHIP_SOFT_RESET);\r\npChipcHw->ACLKClock =\r\n(pChipcHw->\r\nACLKClock & ~chipcHw_REG_ACLKClock_CLK_DIV_MASK) | (initParam->\r\narmBusRatio &\r\nchipcHw_REG_ACLKClock_CLK_DIV_MASK);\r\nchipcHw_setClockFrequency(chipcHw_CLOCK_ARM,\r\ninitParam->busClockFreqHz *\r\ninitParam->armBusRatio);\r\nchipcHw_setClockFrequency(chipcHw_CLOCK_BUS, initParam->busClockFreqHz);\r\nchipcHw_setClockFrequency(chipcHw_CLOCK_VPM,\r\ninitParam->busClockFreqHz *\r\ninitParam->vpmBusRatio);\r\nchipcHw_setClockFrequency(chipcHw_CLOCK_DDR,\r\ninitParam->busClockFreqHz *\r\ninitParam->ddrBusRatio);\r\nchipcHw_setClockFrequency(chipcHw_CLOCK_RTBUS,\r\ninitParam->busClockFreqHz / 2);\r\n}

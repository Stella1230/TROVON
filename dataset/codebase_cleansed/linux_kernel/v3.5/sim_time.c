static unsigned int __init estimate_cpu_frequency(void)\r\n{\r\nunsigned int prid = read_c0_prid() & 0xffff00;\r\nunsigned int count;\r\n#if 1\r\nif ((prid == (PRID_COMP_MIPS | PRID_IMP_20KC)) ||\r\n(prid == (PRID_COMP_MIPS | PRID_IMP_25KF)))\r\ncount = 12000000;\r\nelse\r\ncount = 6000000;\r\n#else\r\nunsigned int flags;\r\nlocal_irq_save(flags);\r\nwhile (CMOS_READ(RTC_REG_A) & RTC_UIP);\r\nwhile (!(CMOS_READ(RTC_REG_A) & RTC_UIP));\r\nwrite_c0_count(0);\r\nwhile (CMOS_READ(RTC_REG_A) & RTC_UIP);\r\nwhile (!(CMOS_READ(RTC_REG_A) & RTC_UIP));\r\ncount = read_c0_count();\r\nlocal_irq_restore(flags);\r\n#endif\r\nmips_hpt_frequency = count;\r\nif ((prid != (PRID_COMP_MIPS | PRID_IMP_20KC)) &&\r\n(prid != (PRID_COMP_MIPS | PRID_IMP_25KF)))\r\ncount *= 2;\r\ncount += 5000;\r\ncount -= count%10000;\r\nreturn count;\r\n}\r\nstatic void mips_timer_dispatch(void)\r\n{\r\ndo_IRQ(mips_cpu_timer_irq);\r\n}\r\nunsigned __cpuinit get_c0_compare_int(void)\r\n{\r\n#ifdef MSC01E_INT_BASE\r\nif (cpu_has_veic) {\r\nset_vi_handler(MSC01E_INT_CPUCTR, mips_timer_dispatch);\r\nmips_cpu_timer_irq = MSC01E_INT_BASE + MSC01E_INT_CPUCTR;\r\nreturn mips_cpu_timer_irq;\r\n}\r\n#endif\r\nif (cpu_has_vint)\r\nset_vi_handler(cp0_compare_irq, mips_timer_dispatch);\r\nmips_cpu_timer_irq = MIPS_CPU_IRQ_BASE + cp0_compare_irq;\r\nreturn mips_cpu_timer_irq;\r\n}\r\nvoid __init plat_time_init(void)\r\n{\r\nunsigned int est_freq;\r\nCMOS_WRITE(CMOS_READ(RTC_CONTROL) | RTC_DM_BINARY, RTC_CONTROL);\r\nest_freq = estimate_cpu_frequency();\r\nprintk(KERN_INFO "CPU frequency %d.%02d MHz\n", est_freq / 1000000,\r\n(est_freq % 1000000) * 100 / 1000000);\r\ncpu_khz = est_freq / 1000;\r\n}

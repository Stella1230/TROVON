int SM_FreeMem(void)\r\n{\r\nint i;\r\npr_info("SM_FreeMem start\n");\r\nfor (i=0; i<MAX_ZONENUM; i++)\r\n{\r\nif (Log2Phy[i]!=NULL)\r\n{\r\npr_info("Free Zone = %x, Addr = %p\n", i, Log2Phy[i]);\r\nkfree(Log2Phy[i]);\r\nLog2Phy[i] = NULL;\r\n}\r\n}\r\nreturn(NO_ERROR);\r\n}\r\nint Media_D_ReadSector(struct us_data *us, DWORD start,WORD count,BYTE *buf)\r\n{\r\nWORD len, bn;\r\nif (Conv_D_MediaAddr(us, start))\r\nreturn(ErrCode);\r\nwhile(1)\r\n{\r\nlen = Ssfdc.MaxSectors - Media.Sector;\r\nif (count > len)\r\nbn = len;\r\nelse\r\nbn = count;\r\nif (Media_D_ReadOneSect(us, bn, buf))\r\n{\r\nErrCode = ERR_EccReadErr;\r\nreturn(ErrCode);\r\n}\r\nMedia.Sector += bn;\r\ncount -= bn;\r\nif (count<=0)\r\nbreak;\r\nbuf += bn * SECTSIZE;\r\nif (Inc_D_MediaAddr(us))\r\nreturn(ErrCode);\r\n}\r\nreturn(NO_ERROR);\r\n}\r\nint Media_D_CopySector(struct us_data *us, DWORD start,WORD count,BYTE *buf)\r\n{\r\nWORD len, bn;\r\nif (Conv_D_MediaAddr(us, start))\r\nreturn(ErrCode);\r\nwhile(1)\r\n{\r\nif (Assign_D_WriteBlock())\r\nreturn(ERROR);\r\nlen = Ssfdc.MaxSectors - Media.Sector;\r\nif (count > len)\r\nbn = len;\r\nelse\r\nbn = count;\r\nif (Ssfdc_D_CopyBlock(us,bn,buf,Redundant))\r\n{\r\nErrCode = ERR_WriteFault;\r\nreturn(ErrCode);\r\n}\r\nMedia.Sector = 0x1F;\r\nif (Release_D_CopySector(us))\r\n{\r\nif (ErrCode==ERR_HwError)\r\n{\r\nErrCode = ERR_WriteFault;\r\nreturn(ErrCode);\r\n}\r\n}\r\ncount -= bn;\r\nif (count<=0)\r\nbreak;\r\nbuf += bn * SECTSIZE;\r\nif (Inc_D_MediaAddr(us))\r\nreturn(ErrCode);\r\n}\r\nreturn(NO_ERROR);\r\n}\r\nint Release_D_CopySector(struct us_data *us)\r\n{\r\nLog2Phy[Media.Zone][Media.LogBlock]=WriteBlock;\r\nMedia.PhyBlock=ReadBlock;\r\nif (Media.PhyBlock==NO_ASSIGN)\r\n{\r\nMedia.PhyBlock=WriteBlock;\r\nreturn(SMSUCCESS);\r\n}\r\nClr_D_Bit(Assign[Media.Zone],Media.PhyBlock);\r\nMedia.PhyBlock=WriteBlock;\r\nreturn(SMSUCCESS);\r\n}\r\nint Check_D_MediaFmt(struct us_data *us)\r\n{\r\npr_info("Check_D_MediaFmt\n");\r\nif (!MediaChange)\r\nreturn(SMSUCCESS);\r\nMediaChange = ERROR;\r\nSectCopyMode = COMPLETED;\r\nif (Set_D_PhyFmtValue(us))\r\n{\r\nErrCode = ERR_UnknownMedia;\r\nreturn(ERROR);\r\n}\r\nif (Search_D_CIS(us))\r\n{\r\nErrCode = ERR_IllegalFmt;\r\nreturn(ERROR);\r\n}\r\nMediaChange = SMSUCCESS;\r\nreturn(SMSUCCESS);\r\n}\r\nint Conv_D_MediaAddr(struct us_data *us, DWORD addr)\r\n{\r\nDWORD temp;\r\ntemp = addr/Ssfdc.MaxSectors;\r\nMedia.Zone = (BYTE) (temp/Ssfdc.MaxLogBlocks);\r\nif (Log2Phy[Media.Zone]==NULL)\r\n{\r\nif (Make_D_LogTable(us))\r\n{\r\nErrCode = ERR_IllegalFmt;\r\nreturn(ERROR);\r\n}\r\n}\r\nMedia.Sector = (BYTE) (addr%Ssfdc.MaxSectors);\r\nMedia.LogBlock = (WORD) (temp%Ssfdc.MaxLogBlocks);\r\nif (Media.Zone<Ssfdc.MaxZones)\r\n{\r\nClr_D_RedundantData(Redundant);\r\nSet_D_LogBlockAddr(Redundant);\r\nMedia.PhyBlock = Log2Phy[Media.Zone][Media.LogBlock];\r\nreturn(SMSUCCESS);\r\n}\r\nErrCode = ERR_OutOfLBA;\r\nreturn(ERROR);\r\n}\r\nint Inc_D_MediaAddr(struct us_data *us)\r\n{\r\nWORD LogBlock = Media.LogBlock;\r\nif (++Media.Sector<Ssfdc.MaxSectors)\r\nreturn(SMSUCCESS);\r\nif (Log2Phy[Media.Zone]==NULL)\r\n{\r\nif (Make_D_LogTable(us))\r\n{\r\nErrCode = ERR_IllegalFmt;\r\nreturn(ERROR);\r\n}\r\n}\r\nMedia.Sector=0;\r\nMedia.LogBlock = LogBlock;\r\nif (++Media.LogBlock<Ssfdc.MaxLogBlocks)\r\n{\r\nClr_D_RedundantData(Redundant);\r\nSet_D_LogBlockAddr(Redundant);\r\nMedia.PhyBlock=Log2Phy[Media.Zone][Media.LogBlock];\r\nreturn(SMSUCCESS);\r\n}\r\nMedia.LogBlock=0;\r\nif (++Media.Zone<Ssfdc.MaxZones)\r\n{\r\nif (Log2Phy[Media.Zone]==NULL)\r\n{\r\nif (Make_D_LogTable(us))\r\n{\r\nErrCode = ERR_IllegalFmt;\r\nreturn(ERROR);\r\n}\r\n}\r\nMedia.LogBlock = 0;\r\nClr_D_RedundantData(Redundant);\r\nSet_D_LogBlockAddr(Redundant);\r\nMedia.PhyBlock=Log2Phy[Media.Zone][Media.LogBlock];\r\nreturn(SMSUCCESS);\r\n}\r\nMedia.Zone=0;\r\nErrCode = ERR_OutOfLBA;\r\nreturn(ERROR);\r\n}\r\nint Media_D_ReadOneSect(struct us_data *us, WORD count, BYTE *buf)\r\n{\r\nDWORD err, retry;\r\nif (!Read_D_PhyOneSect(us, count, buf))\r\nreturn(SMSUCCESS);\r\nif (ErrCode==ERR_HwError)\r\nreturn(ERROR);\r\nif (ErrCode==ERR_DataStatus)\r\nreturn(ERROR);\r\n#ifdef RDERR_REASSIGN\r\nif (Ssfdc.Attribute &MWP)\r\n{\r\nif (ErrCode==ERR_CorReadErr)\r\nreturn(SMSUCCESS);\r\nreturn(ERROR);\r\n}\r\nerr=ErrCode;\r\nfor(retry=0; retry<2; retry++)\r\n{\r\nif (Copy_D_BlockAll(us, (err==ERR_EccReadErr)?REQ_FAIL:REQ_ERASE))\r\n{\r\nif (ErrCode==ERR_HwError)\r\nreturn(ERROR);\r\ncontinue;\r\n}\r\nErrCode = err;\r\nif (ErrCode==ERR_CorReadErr)\r\nreturn(SMSUCCESS);\r\nreturn(ERROR);\r\n}\r\nMediaChange = ERROR;\r\n#else\r\nif (ErrCode==ERR_CorReadErr) return(SMSUCCESS);\r\n#endif\r\nreturn(ERROR);\r\n}\r\nint Copy_D_BlockAll(struct us_data *us, DWORD mode)\r\n{\r\nBYTE sect;\r\nsect=Media.Sector;\r\nif (Assign_D_WriteBlock())\r\nreturn(ERROR);\r\nif (mode==REQ_FAIL)\r\nSectCopyMode=REQ_FAIL;\r\nfor(Media.Sector=0; Media.Sector<Ssfdc.MaxSectors; Media.Sector++)\r\n{\r\nif (Copy_D_PhyOneSect(us))\r\n{\r\nif (ErrCode==ERR_HwError)\r\nreturn(ERROR);\r\nif (Release_D_WriteBlock(us))\r\nreturn(ERROR);\r\nErrCode = ERR_WriteFault;\r\nMedia.PhyBlock=ReadBlock;\r\nMedia.Sector=sect;\r\nreturn(ERROR);\r\n}\r\n}\r\nif (Release_D_ReadBlock(us))\r\nreturn(ERROR);\r\nMedia.PhyBlock=WriteBlock;\r\nMedia.Sector=sect;\r\nreturn(SMSUCCESS);\r\n}\r\nint Assign_D_WriteBlock(void)\r\n{\r\nReadBlock=Media.PhyBlock;\r\nfor(WriteBlock=AssignStart[Media.Zone]; WriteBlock<Ssfdc.MaxBlocks; WriteBlock++)\r\n{\r\nif (!Chk_D_Bit(Assign[Media.Zone],WriteBlock))\r\n{\r\nSet_D_Bit(Assign[Media.Zone],WriteBlock);\r\nAssignStart[Media.Zone]=WriteBlock+1;\r\nMedia.PhyBlock=WriteBlock;\r\nSectCopyMode=REQ_ERASE;\r\nreturn(SMSUCCESS);\r\n}\r\n}\r\nfor(WriteBlock=0; WriteBlock<AssignStart[Media.Zone]; WriteBlock++)\r\n{\r\nif (!Chk_D_Bit(Assign[Media.Zone],WriteBlock))\r\n{\r\nSet_D_Bit(Assign[Media.Zone],WriteBlock);\r\nAssignStart[Media.Zone]=WriteBlock+1;\r\nMedia.PhyBlock=WriteBlock;\r\nSectCopyMode=REQ_ERASE;\r\nreturn(SMSUCCESS);\r\n}\r\n}\r\nWriteBlock=NO_ASSIGN;\r\nErrCode = ERR_WriteFault;\r\nreturn(ERROR);\r\n}\r\nint Release_D_ReadBlock(struct us_data *us)\r\n{\r\nDWORD mode;\r\nmode=SectCopyMode;\r\nSectCopyMode=COMPLETED;\r\nif (mode==COMPLETED)\r\nreturn(SMSUCCESS);\r\nLog2Phy[Media.Zone][Media.LogBlock]=WriteBlock;\r\nMedia.PhyBlock=ReadBlock;\r\nif (Media.PhyBlock==NO_ASSIGN)\r\n{\r\nMedia.PhyBlock=WriteBlock;\r\nreturn(SMSUCCESS);\r\n}\r\nif (mode==REQ_ERASE)\r\n{\r\nif (Erase_D_PhyOneBlock(us))\r\n{\r\nif (ErrCode==ERR_HwError) return(ERROR);\r\nif (MarkFail_D_PhyOneBlock(us)) return(ERROR);\r\n}\r\nelse\r\nClr_D_Bit(Assign[Media.Zone],Media.PhyBlock);\r\n}\r\nelse if (MarkFail_D_PhyOneBlock(us))\r\nreturn(ERROR);\r\nMedia.PhyBlock=WriteBlock;\r\nreturn(SMSUCCESS);\r\n}\r\nint Release_D_WriteBlock(struct us_data *us)\r\n{\r\nSectCopyMode=COMPLETED;\r\nMedia.PhyBlock=WriteBlock;\r\nif (MarkFail_D_PhyOneBlock(us))\r\nreturn(ERROR);\r\nMedia.PhyBlock=ReadBlock;\r\nreturn(SMSUCCESS);\r\n}\r\nint Copy_D_PhyOneSect(struct us_data *us)\r\n{\r\nint i;\r\nDWORD err, retry;\r\nif (ReadBlock!=NO_ASSIGN)\r\n{\r\nMedia.PhyBlock=ReadBlock;\r\nfor(retry=0; retry<2; retry++)\r\n{\r\nif (retry!=0)\r\n{\r\nSsfdc_D_Reset(us);\r\nif (Ssfdc_D_ReadCisSect(us,WorkBuf,WorkRedund))\r\n{ ErrCode = ERR_HwError; MediaChange=ERROR; return(ERROR); }\r\nif (Check_D_CISdata(WorkBuf,WorkRedund))\r\n{ ErrCode = ERR_HwError; MediaChange=ERROR; return(ERROR); }\r\n}\r\nif (Ssfdc_D_ReadSect(us,WorkBuf,WorkRedund))\r\n{ ErrCode = ERR_HwError; MediaChange=ERROR; return(ERROR); }\r\nif (Check_D_DataStatus(WorkRedund))\r\n{ err=ERROR; break; }\r\nif (!Check_D_ReadError(WorkRedund))\r\n{ err=SMSUCCESS; break; }\r\nif (!Check_D_Correct(WorkBuf,WorkRedund))\r\n{ err=SMSUCCESS; break; }\r\nerr=ERROR;\r\nSectCopyMode=REQ_FAIL;\r\n}\r\n}\r\nelse\r\n{\r\nerr=SMSUCCESS;\r\nfor(i=0; i<SECTSIZE; i++)\r\nWorkBuf[i]=DUMMY_DATA;\r\nClr_D_RedundantData(WorkRedund);\r\n}\r\nSet_D_LogBlockAddr(WorkRedund);\r\nif (err==ERROR)\r\n{\r\nSet_D_RightECC(WorkRedund);\r\nSet_D_DataStaus(WorkRedund);\r\n}\r\nMedia.PhyBlock=WriteBlock;\r\nif (Ssfdc_D_WriteSectForCopy(us, WorkBuf, WorkRedund))\r\n{ ErrCode = ERR_HwError; MediaChange=ERROR; return(ERROR); }\r\nif (Ssfdc_D_CheckStatus())\r\n{ ErrCode = ERR_WriteFault; return(ERROR); }\r\nMedia.PhyBlock=ReadBlock;\r\nreturn(SMSUCCESS);\r\n}\r\nint Read_D_PhyOneSect(struct us_data *us, WORD count, BYTE *buf)\r\n{\r\nint i;\r\nDWORD retry;\r\nif (Media.PhyBlock==NO_ASSIGN)\r\n{\r\nfor(i=0; i<SECTSIZE; i++)\r\n*buf++=DUMMY_DATA;\r\nreturn(SMSUCCESS);\r\n}\r\nfor(retry=0; retry<2; retry++)\r\n{\r\nif (retry!=0)\r\n{\r\nSsfdc_D_Reset(us);\r\nif (Ssfdc_D_ReadCisSect(us,WorkBuf,WorkRedund))\r\n{ ErrCode = ERR_HwError; MediaChange=ERROR; return(ERROR); }\r\nif (Check_D_CISdata(WorkBuf,WorkRedund))\r\n{ ErrCode = ERR_HwError; MediaChange=ERROR; return(ERROR); }\r\n}\r\nif (Ssfdc_D_ReadBlock(us,count,buf,Redundant))\r\n{ ErrCode = ERR_HwError; MediaChange=ERROR; return(ERROR); }\r\nif (Check_D_DataStatus(Redundant))\r\n{ ErrCode = ERR_DataStatus; return(ERROR); }\r\nif (!Check_D_ReadError(Redundant))\r\nreturn(SMSUCCESS);\r\nif (!Check_D_Correct(buf,Redundant))\r\n{ ErrCode = ERR_CorReadErr; return(ERROR); }\r\n}\r\nErrCode = ERR_EccReadErr;\r\nreturn(ERROR);\r\n}\r\nint Erase_D_PhyOneBlock(struct us_data *us)\r\n{\r\nif (Ssfdc_D_EraseBlock(us))\r\n{ ErrCode = ERR_HwError; MediaChange=ERROR; return(ERROR); }\r\nif (Ssfdc_D_CheckStatus())\r\n{ ErrCode = ERR_WriteFault; return(ERROR); }\r\nreturn(SMSUCCESS);\r\n}\r\nint Set_D_PhyFmtValue(struct us_data *us)\r\n{\r\nif (Set_D_SsfdcModel(us->SM_DeviceID))\r\nreturn(ERROR);\r\nreturn(SMSUCCESS);\r\n}\r\nint Search_D_CIS(struct us_data *us)\r\n{\r\nMedia.Zone=0; Media.Sector=0;\r\nfor (Media.PhyBlock=0; Media.PhyBlock<(Ssfdc.MaxBlocks-Ssfdc.MaxLogBlocks-1); Media.PhyBlock++)\r\n{\r\nif (Ssfdc_D_ReadRedtData(us, Redundant))\r\n{\r\nSsfdc_D_Reset(us);\r\nreturn(ERROR);\r\n}\r\nif (!Check_D_FailBlock(Redundant))\r\nbreak;\r\n}\r\nif (Media.PhyBlock==(Ssfdc.MaxBlocks-Ssfdc.MaxLogBlocks-1))\r\n{\r\nSsfdc_D_Reset(us);\r\nreturn(ERROR);\r\n}\r\nwhile (Media.Sector<CIS_SEARCH_SECT)\r\n{\r\nif (Media.Sector)\r\n{\r\nif (Ssfdc_D_ReadRedtData(us, Redundant))\r\n{\r\nSsfdc_D_Reset(us);\r\nreturn(ERROR);\r\n}\r\n}\r\nif (!Check_D_DataStatus(Redundant))\r\n{\r\nif (Ssfdc_D_ReadSect(us,WorkBuf,Redundant))\r\n{\r\nSsfdc_D_Reset(us);\r\nreturn(ERROR);\r\n}\r\nif (Check_D_CISdata(WorkBuf,Redundant))\r\n{\r\nSsfdc_D_Reset(us);\r\nreturn(ERROR);\r\n}\r\nCisArea.PhyBlock=Media.PhyBlock;\r\nCisArea.Sector=Media.Sector;\r\nSsfdc_D_Reset(us);\r\nreturn(SMSUCCESS);\r\n}\r\nMedia.Sector++;\r\n}\r\nSsfdc_D_Reset(us);\r\nreturn(ERROR);\r\n}\r\nint Make_D_LogTable(struct us_data *us)\r\n{\r\nWORD phyblock,logblock;\r\nif (Log2Phy[Media.Zone]==NULL)\r\n{\r\nLog2Phy[Media.Zone] = kmalloc(MAX_LOGBLOCK*sizeof(WORD), GFP_KERNEL);\r\nif (Log2Phy[Media.Zone]==NULL)\r\nreturn(ERROR);\r\n}\r\nMedia.Sector=0;\r\n{\r\nfor(Media.LogBlock=0; Media.LogBlock<Ssfdc.MaxLogBlocks; Media.LogBlock++)\r\nLog2Phy[Media.Zone][Media.LogBlock]=NO_ASSIGN;\r\nfor(Media.PhyBlock=0; Media.PhyBlock<(MAX_BLOCKNUM/8); Media.PhyBlock++)\r\nAssign[Media.Zone][Media.PhyBlock]=0x00;\r\nfor(Media.PhyBlock=0; Media.PhyBlock<Ssfdc.MaxBlocks; Media.PhyBlock++)\r\n{\r\nif ((!Media.Zone) && (Media.PhyBlock<=CisArea.PhyBlock))\r\n{\r\nSet_D_Bit(Assign[Media.Zone],Media.PhyBlock);\r\ncontinue;\r\n}\r\nif (Ssfdc_D_ReadRedtData(us, Redundant))\r\n{ Ssfdc_D_Reset(us); return(ERROR); }\r\nif (!Check_D_DataBlank(Redundant))\r\ncontinue;\r\nSet_D_Bit(Assign[Media.Zone],Media.PhyBlock);\r\nif (Check_D_FailBlock(Redundant))\r\ncontinue;\r\nif (Load_D_LogBlockAddr(Redundant))\r\ncontinue;\r\nif (Media.LogBlock>=Ssfdc.MaxLogBlocks)\r\ncontinue;\r\nif (Log2Phy[Media.Zone][Media.LogBlock]==NO_ASSIGN)\r\n{\r\nLog2Phy[Media.Zone][Media.LogBlock]=Media.PhyBlock;\r\ncontinue;\r\n}\r\nphyblock = Media.PhyBlock;\r\nlogblock = Media.LogBlock;\r\nMedia.Sector = (BYTE)(Ssfdc.MaxSectors-1);\r\nif (Ssfdc_D_ReadRedtData(us, Redundant))\r\n{ Ssfdc_D_Reset(us); return(ERROR); }\r\nif (!Load_D_LogBlockAddr(Redundant))\r\n{\r\nif (Media.LogBlock==logblock)\r\n{\r\nMedia.PhyBlock=Log2Phy[Media.Zone][logblock];\r\nif (Ssfdc_D_ReadRedtData(us, Redundant))\r\n{ Ssfdc_D_Reset(us); return(ERROR); }\r\nMedia.PhyBlock=phyblock;\r\nif (!Load_D_LogBlockAddr(Redundant))\r\n{\r\nif (Media.LogBlock!=logblock)\r\n{\r\nMedia.PhyBlock=Log2Phy[Media.Zone][logblock];\r\nLog2Phy[Media.Zone][logblock]=phyblock;\r\n}\r\n}\r\nelse\r\n{\r\nMedia.PhyBlock=Log2Phy[Media.Zone][logblock];\r\nLog2Phy[Media.Zone][logblock]=phyblock;\r\n}\r\n}\r\n}\r\nMedia.Sector=0;\r\nMedia.PhyBlock=phyblock;\r\n}\r\nAssignStart[Media.Zone]=0;\r\n}\r\nSsfdc_D_Reset(us);\r\nreturn(SMSUCCESS);\r\n}\r\nint MarkFail_D_PhyOneBlock(struct us_data *us)\r\n{\r\nBYTE sect;\r\nsect=Media.Sector;\r\nSet_D_FailBlock(WorkRedund);\r\nfor(Media.Sector=0; Media.Sector<Ssfdc.MaxSectors; Media.Sector++)\r\n{\r\nif (Ssfdc_D_WriteRedtData(us, WorkRedund))\r\n{\r\nSsfdc_D_Reset(us);\r\nMedia.Sector = sect;\r\nErrCode = ERR_HwError;\r\nMediaChange = ERROR;\r\nreturn(ERROR);\r\n}\r\n}\r\nSsfdc_D_Reset(us);\r\nMedia.Sector=sect;\r\nreturn(SMSUCCESS);\r\n}

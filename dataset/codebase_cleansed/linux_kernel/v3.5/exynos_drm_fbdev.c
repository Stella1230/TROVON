static int exynos_drm_fbdev_update(struct drm_fb_helper *helper,\r\nstruct drm_framebuffer *fb)\r\n{\r\nstruct fb_info *fbi = helper->fbdev;\r\nstruct drm_device *dev = helper->dev;\r\nstruct exynos_drm_gem_buf *buffer;\r\nunsigned int size = fb->width * fb->height * (fb->bits_per_pixel >> 3);\r\nunsigned long offset;\r\nDRM_DEBUG_KMS("%s\n", __FILE__);\r\ndrm_fb_helper_fill_fix(fbi, fb->pitches[0], fb->depth);\r\ndrm_fb_helper_fill_var(fbi, helper, fb->width, fb->height);\r\nbuffer = exynos_drm_fb_buffer(fb, 0);\r\nif (!buffer) {\r\nDRM_LOG_KMS("buffer is null.\n");\r\nreturn -EFAULT;\r\n}\r\noffset = fbi->var.xoffset * (fb->bits_per_pixel >> 3);\r\noffset += fbi->var.yoffset * fb->pitches[0];\r\ndev->mode_config.fb_base = (resource_size_t)buffer->dma_addr;\r\nfbi->screen_base = buffer->kvaddr + offset;\r\nfbi->fix.smem_start = (unsigned long)(buffer->dma_addr + offset);\r\nfbi->screen_size = size;\r\nfbi->fix.smem_len = size;\r\nreturn 0;\r\n}\r\nstatic int exynos_drm_fbdev_create(struct drm_fb_helper *helper,\r\nstruct drm_fb_helper_surface_size *sizes)\r\n{\r\nstruct exynos_drm_fbdev *exynos_fbdev = to_exynos_fbdev(helper);\r\nstruct exynos_drm_gem_obj *exynos_gem_obj;\r\nstruct drm_device *dev = helper->dev;\r\nstruct fb_info *fbi;\r\nstruct drm_mode_fb_cmd2 mode_cmd = { 0 };\r\nstruct platform_device *pdev = dev->platformdev;\r\nunsigned long size;\r\nint ret;\r\nDRM_DEBUG_KMS("%s\n", __FILE__);\r\nDRM_DEBUG_KMS("surface width(%d), height(%d) and bpp(%d\n",\r\nsizes->surface_width, sizes->surface_height,\r\nsizes->surface_bpp);\r\nmode_cmd.width = sizes->surface_width;\r\nmode_cmd.height = sizes->surface_height;\r\nmode_cmd.pitches[0] = sizes->surface_width * (sizes->surface_bpp >> 3);\r\nmode_cmd.pixel_format = drm_mode_legacy_fb_format(sizes->surface_bpp,\r\nsizes->surface_depth);\r\nmutex_lock(&dev->struct_mutex);\r\nfbi = framebuffer_alloc(0, &pdev->dev);\r\nif (!fbi) {\r\nDRM_ERROR("failed to allocate fb info.\n");\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nsize = mode_cmd.pitches[0] * mode_cmd.height;\r\nexynos_gem_obj = exynos_drm_gem_create(dev, 0, size);\r\nif (IS_ERR(exynos_gem_obj)) {\r\nret = PTR_ERR(exynos_gem_obj);\r\ngoto out;\r\n}\r\nexynos_fbdev->exynos_gem_obj = exynos_gem_obj;\r\nhelper->fb = exynos_drm_framebuffer_init(dev, &mode_cmd,\r\n&exynos_gem_obj->base);\r\nif (IS_ERR_OR_NULL(helper->fb)) {\r\nDRM_ERROR("failed to create drm framebuffer.\n");\r\nret = PTR_ERR(helper->fb);\r\ngoto out;\r\n}\r\nhelper->fbdev = fbi;\r\nfbi->par = helper;\r\nfbi->flags = FBINFO_FLAG_DEFAULT;\r\nfbi->fbops = &exynos_drm_fb_ops;\r\nret = fb_alloc_cmap(&fbi->cmap, 256, 0);\r\nif (ret) {\r\nDRM_ERROR("failed to allocate cmap.\n");\r\ngoto out;\r\n}\r\nret = exynos_drm_fbdev_update(helper, helper->fb);\r\nif (ret < 0) {\r\nfb_dealloc_cmap(&fbi->cmap);\r\ngoto out;\r\n}\r\nout:\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn ret;\r\n}\r\nstatic int exynos_drm_fbdev_probe(struct drm_fb_helper *helper,\r\nstruct drm_fb_helper_surface_size *sizes)\r\n{\r\nint ret = 0;\r\nDRM_DEBUG_KMS("%s\n", __FILE__);\r\nif (!helper->fb) {\r\nret = exynos_drm_fbdev_create(helper, sizes);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to create fbdev.\n");\r\nreturn ret;\r\n}\r\nret = 1;\r\n}\r\nreturn ret;\r\n}\r\nint exynos_drm_fbdev_init(struct drm_device *dev)\r\n{\r\nstruct exynos_drm_fbdev *fbdev;\r\nstruct exynos_drm_private *private = dev->dev_private;\r\nstruct drm_fb_helper *helper;\r\nunsigned int num_crtc;\r\nint ret;\r\nDRM_DEBUG_KMS("%s\n", __FILE__);\r\nif (!dev->mode_config.num_crtc || !dev->mode_config.num_connector)\r\nreturn 0;\r\nfbdev = kzalloc(sizeof(*fbdev), GFP_KERNEL);\r\nif (!fbdev) {\r\nDRM_ERROR("failed to allocate drm fbdev.\n");\r\nreturn -ENOMEM;\r\n}\r\nprivate->fb_helper = helper = &fbdev->drm_fb_helper;\r\nhelper->funcs = &exynos_drm_fb_helper_funcs;\r\nnum_crtc = dev->mode_config.num_crtc;\r\nret = drm_fb_helper_init(dev, helper, num_crtc, MAX_CONNECTOR);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to initialize drm fb helper.\n");\r\ngoto err_init;\r\n}\r\nret = drm_fb_helper_single_add_all_connectors(helper);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to register drm_fb_helper_connector.\n");\r\ngoto err_setup;\r\n}\r\nret = drm_fb_helper_initial_config(helper, PREFERRED_BPP);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to set up hw configuration.\n");\r\ngoto err_setup;\r\n}\r\nreturn 0;\r\nerr_setup:\r\ndrm_fb_helper_fini(helper);\r\nerr_init:\r\nprivate->fb_helper = NULL;\r\nkfree(fbdev);\r\nreturn ret;\r\n}\r\nstatic void exynos_drm_fbdev_destroy(struct drm_device *dev,\r\nstruct drm_fb_helper *fb_helper)\r\n{\r\nstruct drm_framebuffer *fb;\r\nif (fb_helper->fb && fb_helper->fb->funcs) {\r\nfb = fb_helper->fb;\r\nif (fb && fb->funcs->destroy)\r\nfb->funcs->destroy(fb);\r\n}\r\nif (fb_helper->fbdev) {\r\nstruct fb_info *info;\r\nint ret;\r\ninfo = fb_helper->fbdev;\r\nret = unregister_framebuffer(info);\r\nif (ret < 0)\r\nDRM_DEBUG_KMS("failed unregister_framebuffer()\n");\r\nif (info->cmap.len)\r\nfb_dealloc_cmap(&info->cmap);\r\nframebuffer_release(info);\r\n}\r\ndrm_fb_helper_fini(fb_helper);\r\n}\r\nvoid exynos_drm_fbdev_fini(struct drm_device *dev)\r\n{\r\nstruct exynos_drm_private *private = dev->dev_private;\r\nstruct exynos_drm_fbdev *fbdev;\r\nif (!private || !private->fb_helper)\r\nreturn;\r\nfbdev = to_exynos_fbdev(private->fb_helper);\r\nif (fbdev->exynos_gem_obj)\r\nexynos_drm_gem_destroy(fbdev->exynos_gem_obj);\r\nexynos_drm_fbdev_destroy(dev, private->fb_helper);\r\nkfree(fbdev);\r\nprivate->fb_helper = NULL;\r\n}\r\nvoid exynos_drm_fbdev_restore_mode(struct drm_device *dev)\r\n{\r\nstruct exynos_drm_private *private = dev->dev_private;\r\nif (!private || !private->fb_helper)\r\nreturn;\r\ndrm_fb_helper_restore_fbdev_mode(private->fb_helper);\r\n}

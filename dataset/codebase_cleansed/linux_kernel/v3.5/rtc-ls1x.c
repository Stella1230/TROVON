static int ls1x_rtc_read_time(struct device *dev, struct rtc_time *rtm)\r\n{\r\nunsigned long v, t;\r\nv = readl(SYS_TOYREAD0);\r\nt = readl(SYS_TOYREAD1);\r\nmemset(rtm, 0, sizeof(struct rtc_time));\r\nt = mktime((t & LS1X_YEAR_MASK), ls1x_get_month(v),\r\nls1x_get_day(v), ls1x_get_hour(v),\r\nls1x_get_min(v), ls1x_get_sec(v));\r\nrtc_time_to_tm(t, rtm);\r\nreturn rtc_valid_tm(rtm);\r\n}\r\nstatic int ls1x_rtc_set_time(struct device *dev, struct rtc_time *rtm)\r\n{\r\nunsigned long v, t, c;\r\nint ret = -ETIMEDOUT;\r\nv = ((rtm->tm_mon + 1) << LS1X_MONTH_OFFSET)\r\n| (rtm->tm_mday << LS1X_DAY_OFFSET)\r\n| (rtm->tm_hour << LS1X_HOUR_OFFSET)\r\n| (rtm->tm_min << LS1X_MIN_OFFSET)\r\n| (rtm->tm_sec << LS1X_SEC_OFFSET);\r\nwritel(v, SYS_TOYWRITE0);\r\nc = 0x10000;\r\nwhile ((readl(SYS_COUNTER_CNTRL) & SYS_CNTRL_TS) && --c)\r\nusleep_range(1000, 3000);\r\nif (!c) {\r\ndev_err(dev, "set time timeout!\n");\r\ngoto err;\r\n}\r\nt = rtm->tm_year + 1900;\r\nwritel(t, SYS_TOYWRITE1);\r\nc = 0x10000;\r\nwhile ((readl(SYS_COUNTER_CNTRL) & SYS_CNTRL_TS) && --c)\r\nusleep_range(1000, 3000);\r\nif (!c) {\r\ndev_err(dev, "set time timeout!\n");\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int __devinit ls1x_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtcdev;\r\nunsigned long v;\r\nint ret;\r\nv = readl(SYS_COUNTER_CNTRL);\r\nif (!(v & RTC_CNTR_OK)) {\r\ndev_err(&pdev->dev, "rtc counters not working\n");\r\nret = -ENODEV;\r\ngoto err;\r\n}\r\nret = -ETIMEDOUT;\r\nif (readl(SYS_TOYTRIM) != 32767) {\r\nv = 0x100000;\r\nwhile ((readl(SYS_COUNTER_CNTRL) & SYS_CNTRL_TTS) && --v)\r\nusleep_range(1000, 3000);\r\nif (!v) {\r\ndev_err(&pdev->dev, "time out\n");\r\ngoto err;\r\n}\r\nwritel(32767, SYS_TOYTRIM);\r\n}\r\nwhile (readl(SYS_COUNTER_CNTRL) & SYS_CNTRL_TTS)\r\nusleep_range(1000, 3000);\r\nrtcdev = rtc_device_register("ls1x-rtc", &pdev->dev,\r\n&ls1x_rtc_ops , THIS_MODULE);\r\nif (IS_ERR(rtcdev)) {\r\nret = PTR_ERR(rtcdev);\r\ngoto err;\r\n}\r\nplatform_set_drvdata(pdev, rtcdev);\r\nreturn 0;\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int __devexit ls1x_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtcdev = platform_get_drvdata(pdev);\r\nrtc_device_unregister(rtcdev);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}

static int __devinit dw_mci_pci_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *entries)\r\n{\r\nstruct dw_mci *host;\r\nint ret;\r\nret = pci_enable_device(pdev);\r\nif (ret)\r\nreturn ret;\r\nif (pci_request_regions(pdev, "dw_mmc_pci")) {\r\nret = -ENODEV;\r\ngoto err_disable_dev;\r\n}\r\nhost = kzalloc(sizeof(struct dw_mci), GFP_KERNEL);\r\nif (!host) {\r\nret = -ENOMEM;\r\ngoto err_release;\r\n}\r\nhost->irq = pdev->irq;\r\nhost->irq_flags = IRQF_SHARED;\r\nhost->dev = pdev->dev;\r\nhost->pdata = &pci_board_data;\r\nhost->regs = pci_iomap(pdev, PCI_BAR_NO, COMPLETE_BAR);\r\nif (!host->regs) {\r\nret = -EIO;\r\ngoto err_unmap;\r\n}\r\npci_set_drvdata(pdev, host);\r\nret = dw_mci_probe(host);\r\nif (ret)\r\ngoto err_probe_failed;\r\nreturn ret;\r\nerr_probe_failed:\r\npci_iounmap(pdev, host->regs);\r\nerr_unmap:\r\nkfree(host);\r\nerr_release:\r\npci_release_regions(pdev);\r\nerr_disable_dev:\r\npci_disable_device(pdev);\r\nreturn ret;\r\n}\r\nstatic void __devexit dw_mci_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct dw_mci *host = pci_get_drvdata(pdev);\r\ndw_mci_remove(host);\r\npci_set_drvdata(pdev, NULL);\r\npci_release_regions(pdev);\r\npci_iounmap(pdev, host->regs);\r\nkfree(host);\r\npci_disable_device(pdev);\r\n}\r\nstatic int dw_mci_pci_suspend(struct device *dev)\r\n{\r\nint ret;\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct dw_mci *host = pci_get_drvdata(pdev);\r\nret = dw_mci_suspend(host);\r\nreturn ret;\r\n}\r\nstatic int dw_mci_pci_resume(struct device *dev)\r\n{\r\nint ret;\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct dw_mci *host = pci_get_drvdata(pdev);\r\nret = dw_mci_resume(host);\r\nreturn ret;\r\n}\r\nstatic int __init dw_mci_init(void)\r\n{\r\nreturn pci_register_driver(&dw_mci_pci_driver);\r\n}\r\nstatic void __exit dw_mci_exit(void)\r\n{\r\npci_unregister_driver(&dw_mci_pci_driver);\r\n}

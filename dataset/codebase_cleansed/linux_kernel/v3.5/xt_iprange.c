static bool\r\niprange_mt4(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_iprange_mtinfo *info = par->matchinfo;\r\nconst struct iphdr *iph = ip_hdr(skb);\r\nbool m;\r\nif (info->flags & IPRANGE_SRC) {\r\nm = ntohl(iph->saddr) < ntohl(info->src_min.ip);\r\nm |= ntohl(iph->saddr) > ntohl(info->src_max.ip);\r\nm ^= !!(info->flags & IPRANGE_SRC_INV);\r\nif (m) {\r\npr_debug("src IP %pI4 NOT in range %s%pI4-%pI4\n",\r\n&iph->saddr,\r\n(info->flags & IPRANGE_SRC_INV) ? "(INV) " : "",\r\n&info->src_min.ip,\r\n&info->src_max.ip);\r\nreturn false;\r\n}\r\n}\r\nif (info->flags & IPRANGE_DST) {\r\nm = ntohl(iph->daddr) < ntohl(info->dst_min.ip);\r\nm |= ntohl(iph->daddr) > ntohl(info->dst_max.ip);\r\nm ^= !!(info->flags & IPRANGE_DST_INV);\r\nif (m) {\r\npr_debug("dst IP %pI4 NOT in range %s%pI4-%pI4\n",\r\n&iph->daddr,\r\n(info->flags & IPRANGE_DST_INV) ? "(INV) " : "",\r\n&info->dst_min.ip,\r\n&info->dst_max.ip);\r\nreturn false;\r\n}\r\n}\r\nreturn true;\r\n}\r\nstatic inline int\r\niprange_ipv6_lt(const struct in6_addr *a, const struct in6_addr *b)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < 4; ++i) {\r\nif (a->s6_addr32[i] != b->s6_addr32[i])\r\nreturn ntohl(a->s6_addr32[i]) < ntohl(b->s6_addr32[i]);\r\n}\r\nreturn 0;\r\n}\r\nstatic bool\r\niprange_mt6(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_iprange_mtinfo *info = par->matchinfo;\r\nconst struct ipv6hdr *iph = ipv6_hdr(skb);\r\nbool m;\r\nif (info->flags & IPRANGE_SRC) {\r\nm = iprange_ipv6_lt(&iph->saddr, &info->src_min.in6);\r\nm |= iprange_ipv6_lt(&info->src_max.in6, &iph->saddr);\r\nm ^= !!(info->flags & IPRANGE_SRC_INV);\r\nif (m) {\r\npr_debug("src IP %pI6 NOT in range %s%pI6-%pI6\n",\r\n&iph->saddr,\r\n(info->flags & IPRANGE_SRC_INV) ? "(INV) " : "",\r\n&info->src_min.in6,\r\n&info->src_max.in6);\r\nreturn false;\r\n}\r\n}\r\nif (info->flags & IPRANGE_DST) {\r\nm = iprange_ipv6_lt(&iph->daddr, &info->dst_min.in6);\r\nm |= iprange_ipv6_lt(&info->dst_max.in6, &iph->daddr);\r\nm ^= !!(info->flags & IPRANGE_DST_INV);\r\nif (m) {\r\npr_debug("dst IP %pI6 NOT in range %s%pI6-%pI6\n",\r\n&iph->daddr,\r\n(info->flags & IPRANGE_DST_INV) ? "(INV) " : "",\r\n&info->dst_min.in6,\r\n&info->dst_max.in6);\r\nreturn false;\r\n}\r\n}\r\nreturn true;\r\n}\r\nstatic int __init iprange_mt_init(void)\r\n{\r\nreturn xt_register_matches(iprange_mt_reg, ARRAY_SIZE(iprange_mt_reg));\r\n}\r\nstatic void __exit iprange_mt_exit(void)\r\n{\r\nxt_unregister_matches(iprange_mt_reg, ARRAY_SIZE(iprange_mt_reg));\r\n}

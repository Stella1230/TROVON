static unsigned long long period_to_sec(unsigned int period)\r\n{\r\nunsigned long long tmp = 1ULL << (64 - period);\r\nunsigned long tmp2 = ppc_tb_freq;\r\ntmp2 = tmp2 / 5 * 2;\r\ndo_div(tmp, tmp2);\r\nreturn tmp;\r\n}\r\nstatic unsigned int sec_to_period(unsigned int secs)\r\n{\r\nunsigned int period;\r\nfor (period = 63; period > 0; period--) {\r\nif (period_to_sec(period) >= secs)\r\nreturn period;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __booke_wdt_set(void *data)\r\n{\r\nu32 val;\r\nval = mfspr(SPRN_TCR);\r\nval &= ~WDTP_MASK;\r\nval |= WDTP(booke_wdt_period);\r\nmtspr(SPRN_TCR, val);\r\n}\r\nstatic void booke_wdt_set(void)\r\n{\r\non_each_cpu(__booke_wdt_set, NULL, 0);\r\n}\r\nstatic void __booke_wdt_ping(void *data)\r\n{\r\nmtspr(SPRN_TSR, TSR_ENW|TSR_WIS);\r\n}\r\nstatic void booke_wdt_ping(void)\r\n{\r\non_each_cpu(__booke_wdt_ping, NULL, 0);\r\n}\r\nstatic void __booke_wdt_enable(void *data)\r\n{\r\nu32 val;\r\n__booke_wdt_ping(NULL);\r\nval = mfspr(SPRN_TCR);\r\nval &= ~WDTP_MASK;\r\nval |= (TCR_WIE|TCR_WRC(WRC_CHIP)|WDTP(booke_wdt_period));\r\nmtspr(SPRN_TCR, val);\r\n}\r\nstatic void __booke_wdt_disable(void *data)\r\n{\r\nu32 val;\r\nval = mfspr(SPRN_TCR);\r\nval &= ~(TCR_WIE | WDTP_MASK);\r\nmtspr(SPRN_TCR, val);\r\n__booke_wdt_ping(NULL);\r\n}\r\nstatic ssize_t booke_wdt_write(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nbooke_wdt_ping();\r\nreturn count;\r\n}\r\nstatic long booke_wdt_ioctl(struct file *file,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nu32 tmp = 0;\r\nu32 __user *p = (u32 __user *)arg;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nif (copy_to_user((void *)arg, &ident, sizeof(ident)))\r\nreturn -EFAULT;\r\ncase WDIOC_GETSTATUS:\r\nreturn put_user(0, p);\r\ncase WDIOC_GETBOOTSTATUS:\r\ntmp = mfspr(SPRN_TSR) & TSR_WRS(3);\r\nreturn (tmp ? WDIOF_CARDRESET : 0);\r\ncase WDIOC_SETOPTIONS:\r\nif (get_user(tmp, p))\r\nreturn -EINVAL;\r\nif (tmp == WDIOS_ENABLECARD) {\r\nbooke_wdt_ping();\r\nbreak;\r\n} else\r\nreturn -EINVAL;\r\nreturn 0;\r\ncase WDIOC_KEEPALIVE:\r\nbooke_wdt_ping();\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT:\r\nif (get_user(tmp, p))\r\nreturn -EFAULT;\r\n#ifdef CONFIG_FSL_BOOKE\r\nif (tmp > period_to_sec(1))\r\nreturn -EINVAL;\r\nbooke_wdt_period = sec_to_period(tmp);\r\n#else\r\nbooke_wdt_period = tmp;\r\n#endif\r\nbooke_wdt_set();\r\ncase WDIOC_GETTIMEOUT:\r\n#ifdef CONFIG_FSL_BOOKE\r\nreturn put_user(period_to_sec(booke_wdt_period), p);\r\n#else\r\nreturn put_user(booke_wdt_period, p);\r\n#endif\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\nreturn 0;\r\n}\r\nstatic int booke_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &wdt_is_active))\r\nreturn -EBUSY;\r\nspin_lock(&booke_wdt_lock);\r\nif (booke_wdt_enabled == 0) {\r\nbooke_wdt_enabled = 1;\r\non_each_cpu(__booke_wdt_enable, NULL, 0);\r\npr_debug("watchdog enabled (timeout = %llu sec)\n",\r\nperiod_to_sec(booke_wdt_period));\r\n}\r\nspin_unlock(&booke_wdt_lock);\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int booke_wdt_release(struct inode *inode, struct file *file)\r\n{\r\n#ifndef CONFIG_WATCHDOG_NOWAYOUT\r\non_each_cpu(__booke_wdt_disable, NULL, 0);\r\nbooke_wdt_enabled = 0;\r\npr_debug("watchdog disabled\n");\r\n#endif\r\nclear_bit(0, &wdt_is_active);\r\nreturn 0;\r\n}\r\nstatic void __exit booke_wdt_exit(void)\r\n{\r\nmisc_deregister(&booke_wdt_miscdev);\r\n}\r\nstatic int __init booke_wdt_init(void)\r\n{\r\nint ret = 0;\r\npr_info("powerpc book-e watchdog driver loaded\n");\r\nident.firmware_version = cur_cpu_spec->pvr_value;\r\nret = misc_register(&booke_wdt_miscdev);\r\nif (ret) {\r\npr_err("cannot register device (minor=%u, ret=%i)\n",\r\nWATCHDOG_MINOR, ret);\r\nreturn ret;\r\n}\r\nspin_lock(&booke_wdt_lock);\r\nif (booke_wdt_enabled == 1) {\r\npr_info("watchdog enabled (timeout = %llu sec)\n",\r\nperiod_to_sec(booke_wdt_period));\r\non_each_cpu(__booke_wdt_enable, NULL, 0);\r\n}\r\nspin_unlock(&booke_wdt_lock);\r\nreturn ret;\r\n}

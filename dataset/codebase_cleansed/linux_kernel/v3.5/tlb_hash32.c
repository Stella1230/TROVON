void flush_hash_entry(struct mm_struct *mm, pte_t *ptep, unsigned long addr)\r\n{\r\nunsigned long ptephys;\r\nif (Hash != 0) {\r\nptephys = __pa(ptep) & PAGE_MASK;\r\nflush_hash_pages(mm->context.id, addr, ptephys, 1);\r\n}\r\n}\r\nvoid flush_tlb_page_nohash(struct vm_area_struct *vma, unsigned long addr)\r\n{\r\nif (Hash != 0)\r\nreturn;\r\n_tlbie(addr);\r\n}\r\nvoid tlb_flush(struct mmu_gather *tlb)\r\n{\r\nif (Hash == 0) {\r\n_tlbia();\r\n}\r\n}\r\nstatic void flush_range(struct mm_struct *mm, unsigned long start,\r\nunsigned long end)\r\n{\r\npmd_t *pmd;\r\nunsigned long pmd_end;\r\nint count;\r\nunsigned int ctx = mm->context.id;\r\nif (Hash == 0) {\r\n_tlbia();\r\nreturn;\r\n}\r\nstart &= PAGE_MASK;\r\nif (start >= end)\r\nreturn;\r\nend = (end - 1) | ~PAGE_MASK;\r\npmd = pmd_offset(pud_offset(pgd_offset(mm, start), start), start);\r\nfor (;;) {\r\npmd_end = ((start + PGDIR_SIZE) & PGDIR_MASK) - 1;\r\nif (pmd_end > end)\r\npmd_end = end;\r\nif (!pmd_none(*pmd)) {\r\ncount = ((pmd_end - start) >> PAGE_SHIFT) + 1;\r\nflush_hash_pages(ctx, start, pmd_val(*pmd), count);\r\n}\r\nif (pmd_end == end)\r\nbreak;\r\nstart = pmd_end + 1;\r\n++pmd;\r\n}\r\n}\r\nvoid flush_tlb_kernel_range(unsigned long start, unsigned long end)\r\n{\r\nflush_range(&init_mm, start, end);\r\n}\r\nvoid flush_tlb_mm(struct mm_struct *mm)\r\n{\r\nstruct vm_area_struct *mp;\r\nif (Hash == 0) {\r\n_tlbia();\r\nreturn;\r\n}\r\nfor (mp = mm->mmap; mp != NULL; mp = mp->vm_next)\r\nflush_range(mp->vm_mm, mp->vm_start, mp->vm_end);\r\n}\r\nvoid flush_tlb_page(struct vm_area_struct *vma, unsigned long vmaddr)\r\n{\r\nstruct mm_struct *mm;\r\npmd_t *pmd;\r\nif (Hash == 0) {\r\n_tlbie(vmaddr);\r\nreturn;\r\n}\r\nmm = (vmaddr < TASK_SIZE)? vma->vm_mm: &init_mm;\r\npmd = pmd_offset(pud_offset(pgd_offset(mm, vmaddr), vmaddr), vmaddr);\r\nif (!pmd_none(*pmd))\r\nflush_hash_pages(mm->context.id, vmaddr, pmd_val(*pmd), 1);\r\n}\r\nvoid flush_tlb_range(struct vm_area_struct *vma, unsigned long start,\r\nunsigned long end)\r\n{\r\nflush_range(vma->vm_mm, start, end);\r\n}\r\nvoid __init early_init_mmu(void)\r\n{\r\n}

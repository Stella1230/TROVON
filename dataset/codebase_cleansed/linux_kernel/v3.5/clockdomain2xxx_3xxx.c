static int omap2_clkdm_add_wkdep(struct clockdomain *clkdm1,\r\nstruct clockdomain *clkdm2)\r\n{\r\nomap2_prm_set_mod_reg_bits((1 << clkdm2->dep_bit),\r\nclkdm1->pwrdm.ptr->prcm_offs, PM_WKDEP);\r\nreturn 0;\r\n}\r\nstatic int omap2_clkdm_del_wkdep(struct clockdomain *clkdm1,\r\nstruct clockdomain *clkdm2)\r\n{\r\nomap2_prm_clear_mod_reg_bits((1 << clkdm2->dep_bit),\r\nclkdm1->pwrdm.ptr->prcm_offs, PM_WKDEP);\r\nreturn 0;\r\n}\r\nstatic int omap2_clkdm_read_wkdep(struct clockdomain *clkdm1,\r\nstruct clockdomain *clkdm2)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(clkdm1->pwrdm.ptr->prcm_offs,\r\nPM_WKDEP, (1 << clkdm2->dep_bit));\r\n}\r\nstatic int omap2_clkdm_clear_all_wkdeps(struct clockdomain *clkdm)\r\n{\r\nstruct clkdm_dep *cd;\r\nu32 mask = 0;\r\nfor (cd = clkdm->wkdep_srcs; cd && cd->clkdm_name; cd++) {\r\nif (!cd->clkdm)\r\ncontinue;\r\nmask |= 1 << cd->clkdm->dep_bit;\r\natomic_set(&cd->wkdep_usecount, 0);\r\n}\r\nomap2_prm_clear_mod_reg_bits(mask, clkdm->pwrdm.ptr->prcm_offs,\r\nPM_WKDEP);\r\nreturn 0;\r\n}\r\nstatic int omap3_clkdm_add_sleepdep(struct clockdomain *clkdm1,\r\nstruct clockdomain *clkdm2)\r\n{\r\nomap2_cm_set_mod_reg_bits((1 << clkdm2->dep_bit),\r\nclkdm1->pwrdm.ptr->prcm_offs,\r\nOMAP3430_CM_SLEEPDEP);\r\nreturn 0;\r\n}\r\nstatic int omap3_clkdm_del_sleepdep(struct clockdomain *clkdm1,\r\nstruct clockdomain *clkdm2)\r\n{\r\nomap2_cm_clear_mod_reg_bits((1 << clkdm2->dep_bit),\r\nclkdm1->pwrdm.ptr->prcm_offs,\r\nOMAP3430_CM_SLEEPDEP);\r\nreturn 0;\r\n}\r\nstatic int omap3_clkdm_read_sleepdep(struct clockdomain *clkdm1,\r\nstruct clockdomain *clkdm2)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(clkdm1->pwrdm.ptr->prcm_offs,\r\nOMAP3430_CM_SLEEPDEP, (1 << clkdm2->dep_bit));\r\n}\r\nstatic int omap3_clkdm_clear_all_sleepdeps(struct clockdomain *clkdm)\r\n{\r\nstruct clkdm_dep *cd;\r\nu32 mask = 0;\r\nfor (cd = clkdm->sleepdep_srcs; cd && cd->clkdm_name; cd++) {\r\nif (!cd->clkdm)\r\ncontinue;\r\nmask |= 1 << cd->clkdm->dep_bit;\r\natomic_set(&cd->sleepdep_usecount, 0);\r\n}\r\nomap2_prm_clear_mod_reg_bits(mask, clkdm->pwrdm.ptr->prcm_offs,\r\nOMAP3430_CM_SLEEPDEP);\r\nreturn 0;\r\n}\r\nstatic int omap2_clkdm_sleep(struct clockdomain *clkdm)\r\n{\r\nomap2_cm_set_mod_reg_bits(OMAP24XX_FORCESTATE_MASK,\r\nclkdm->pwrdm.ptr->prcm_offs,\r\nOMAP2_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic int omap2_clkdm_wakeup(struct clockdomain *clkdm)\r\n{\r\nomap2_cm_clear_mod_reg_bits(OMAP24XX_FORCESTATE_MASK,\r\nclkdm->pwrdm.ptr->prcm_offs,\r\nOMAP2_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic void omap2_clkdm_allow_idle(struct clockdomain *clkdm)\r\n{\r\nif (atomic_read(&clkdm->usecount) > 0)\r\n_clkdm_add_autodeps(clkdm);\r\nomap2xxx_cm_clkdm_enable_hwsup(clkdm->pwrdm.ptr->prcm_offs,\r\nclkdm->clktrctrl_mask);\r\n}\r\nstatic void omap2_clkdm_deny_idle(struct clockdomain *clkdm)\r\n{\r\nomap2xxx_cm_clkdm_disable_hwsup(clkdm->pwrdm.ptr->prcm_offs,\r\nclkdm->clktrctrl_mask);\r\nif (atomic_read(&clkdm->usecount) > 0)\r\n_clkdm_del_autodeps(clkdm);\r\n}\r\nstatic void _enable_hwsup(struct clockdomain *clkdm)\r\n{\r\nif (cpu_is_omap24xx())\r\nomap2xxx_cm_clkdm_enable_hwsup(clkdm->pwrdm.ptr->prcm_offs,\r\nclkdm->clktrctrl_mask);\r\nelse if (cpu_is_omap34xx())\r\nomap3xxx_cm_clkdm_enable_hwsup(clkdm->pwrdm.ptr->prcm_offs,\r\nclkdm->clktrctrl_mask);\r\n}\r\nstatic void _disable_hwsup(struct clockdomain *clkdm)\r\n{\r\nif (cpu_is_omap24xx())\r\nomap2xxx_cm_clkdm_disable_hwsup(clkdm->pwrdm.ptr->prcm_offs,\r\nclkdm->clktrctrl_mask);\r\nelse if (cpu_is_omap34xx())\r\nomap3xxx_cm_clkdm_disable_hwsup(clkdm->pwrdm.ptr->prcm_offs,\r\nclkdm->clktrctrl_mask);\r\n}\r\nstatic int omap2_clkdm_clk_enable(struct clockdomain *clkdm)\r\n{\r\nbool hwsup = false;\r\nif (!clkdm->clktrctrl_mask)\r\nreturn 0;\r\nhwsup = omap2_cm_is_clkdm_in_hwsup(clkdm->pwrdm.ptr->prcm_offs,\r\nclkdm->clktrctrl_mask);\r\nif (hwsup) {\r\n_disable_hwsup(clkdm);\r\n_clkdm_add_autodeps(clkdm);\r\n_enable_hwsup(clkdm);\r\n} else {\r\nif (clkdm->flags & CLKDM_CAN_FORCE_WAKEUP)\r\nomap2_clkdm_wakeup(clkdm);\r\n}\r\nreturn 0;\r\n}\r\nstatic int omap2_clkdm_clk_disable(struct clockdomain *clkdm)\r\n{\r\nbool hwsup = false;\r\nif (!clkdm->clktrctrl_mask)\r\nreturn 0;\r\nhwsup = omap2_cm_is_clkdm_in_hwsup(clkdm->pwrdm.ptr->prcm_offs,\r\nclkdm->clktrctrl_mask);\r\nif (hwsup) {\r\n_disable_hwsup(clkdm);\r\n_clkdm_del_autodeps(clkdm);\r\n_enable_hwsup(clkdm);\r\n} else {\r\nif (clkdm->flags & CLKDM_CAN_FORCE_SLEEP)\r\nomap2_clkdm_sleep(clkdm);\r\n}\r\nreturn 0;\r\n}\r\nstatic int omap3_clkdm_sleep(struct clockdomain *clkdm)\r\n{\r\nomap3xxx_cm_clkdm_force_sleep(clkdm->pwrdm.ptr->prcm_offs,\r\nclkdm->clktrctrl_mask);\r\nreturn 0;\r\n}\r\nstatic int omap3_clkdm_wakeup(struct clockdomain *clkdm)\r\n{\r\nomap3xxx_cm_clkdm_force_wakeup(clkdm->pwrdm.ptr->prcm_offs,\r\nclkdm->clktrctrl_mask);\r\nreturn 0;\r\n}\r\nstatic void omap3_clkdm_allow_idle(struct clockdomain *clkdm)\r\n{\r\nif (atomic_read(&clkdm->usecount) > 0)\r\n_clkdm_add_autodeps(clkdm);\r\nomap3xxx_cm_clkdm_enable_hwsup(clkdm->pwrdm.ptr->prcm_offs,\r\nclkdm->clktrctrl_mask);\r\n}\r\nstatic void omap3_clkdm_deny_idle(struct clockdomain *clkdm)\r\n{\r\nomap3xxx_cm_clkdm_disable_hwsup(clkdm->pwrdm.ptr->prcm_offs,\r\nclkdm->clktrctrl_mask);\r\nif (atomic_read(&clkdm->usecount) > 0)\r\n_clkdm_del_autodeps(clkdm);\r\n}

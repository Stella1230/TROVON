static int lm4857_write(struct snd_soc_codec *codec, unsigned int reg,\r\nunsigned int value)\r\n{\r\nuint8_t data;\r\nint ret;\r\nret = snd_soc_cache_write(codec, reg, value);\r\nif (ret < 0)\r\nreturn ret;\r\ndata = (reg << 6) | value;\r\nret = i2c_master_send(codec->control_data, &data, 1);\r\nif (ret != 1) {\r\ndev_err(codec->dev, "Failed to write register: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned int lm4857_read(struct snd_soc_codec *codec,\r\nunsigned int reg)\r\n{\r\nunsigned int val;\r\nint ret;\r\nret = snd_soc_cache_read(codec, reg, &val);\r\nif (ret)\r\nreturn -1;\r\nreturn val;\r\n}\r\nstatic int lm4857_get_mode(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_kcontrol_chip(kcontrol);\r\nstruct lm4857 *lm4857 = snd_soc_codec_get_drvdata(codec);\r\nucontrol->value.integer.value[0] = lm4857->mode;\r\nreturn 0;\r\n}\r\nstatic int lm4857_set_mode(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_kcontrol_chip(kcontrol);\r\nstruct lm4857 *lm4857 = snd_soc_codec_get_drvdata(codec);\r\nuint8_t value = ucontrol->value.integer.value[0];\r\nlm4857->mode = value;\r\nif (codec->dapm.bias_level == SND_SOC_BIAS_ON)\r\nsnd_soc_update_bits(codec, LM4857_CTRL, 0x0F, value + 6);\r\nreturn 1;\r\n}\r\nstatic int lm4857_set_bias_level(struct snd_soc_codec *codec,\r\nenum snd_soc_bias_level level)\r\n{\r\nstruct lm4857 *lm4857 = snd_soc_codec_get_drvdata(codec);\r\nswitch (level) {\r\ncase SND_SOC_BIAS_ON:\r\nsnd_soc_update_bits(codec, LM4857_CTRL, 0x0F, lm4857->mode + 6);\r\nbreak;\r\ncase SND_SOC_BIAS_STANDBY:\r\nsnd_soc_update_bits(codec, LM4857_CTRL, 0x0F, 0);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ncodec->dapm.bias_level = level;\r\nreturn 0;\r\n}\r\nstatic int lm4857_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct lm4857 *lm4857 = snd_soc_codec_get_drvdata(codec);\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nint ret;\r\ncodec->control_data = lm4857->i2c;\r\nret = snd_soc_add_codec_controls(codec, lm4857_controls,\r\nARRAY_SIZE(lm4857_controls));\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_dapm_new_controls(dapm, lm4857_dapm_widgets,\r\nARRAY_SIZE(lm4857_dapm_widgets));\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_dapm_add_routes(dapm, lm4857_routes,\r\nARRAY_SIZE(lm4857_routes));\r\nif (ret)\r\nreturn ret;\r\nsnd_soc_dapm_new_widgets(dapm);\r\nreturn 0;\r\n}\r\nstatic int __devinit lm4857_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct lm4857 *lm4857;\r\nint ret;\r\nlm4857 = devm_kzalloc(&i2c->dev, sizeof(*lm4857), GFP_KERNEL);\r\nif (!lm4857)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(i2c, lm4857);\r\nlm4857->i2c = i2c;\r\nret = snd_soc_register_codec(&i2c->dev, &soc_codec_dev_lm4857, NULL, 0);\r\nreturn ret;\r\n}\r\nstatic int __devexit lm4857_i2c_remove(struct i2c_client *i2c)\r\n{\r\nsnd_soc_unregister_codec(&i2c->dev);\r\nreturn 0;\r\n}\r\nstatic int __init lm4857_init(void)\r\n{\r\nreturn i2c_add_driver(&lm4857_i2c_driver);\r\n}\r\nstatic void __exit lm4857_exit(void)\r\n{\r\ni2c_del_driver(&lm4857_i2c_driver);\r\n}

static void ext_disable(struct wiimote_ext *ext)\r\n{\r\nunsigned long flags;\r\n__u8 wmem = 0x55;\r\nif (!wiimote_cmd_acquire(ext->wdata)) {\r\nwiimote_cmd_write(ext->wdata, 0xa400f0, &wmem, sizeof(wmem));\r\nwiimote_cmd_release(ext->wdata);\r\n}\r\nspin_lock_irqsave(&ext->wdata->state.lock, flags);\r\next->motionp = false;\r\next->ext_type = WIIEXT_NONE;\r\nwiiproto_req_drm(ext->wdata, WIIPROTO_REQ_NULL);\r\nspin_unlock_irqrestore(&ext->wdata->state.lock, flags);\r\n}\r\nstatic bool motionp_read(struct wiimote_ext *ext)\r\n{\r\n__u8 rmem[2], wmem;\r\nssize_t ret;\r\nbool avail = false;\r\nif (!atomic_read(&ext->mp_opened))\r\nreturn false;\r\nif (wiimote_cmd_acquire(ext->wdata))\r\nreturn false;\r\nwmem = 0x55;\r\nret = wiimote_cmd_write(ext->wdata, 0xa600f0, &wmem, sizeof(wmem));\r\nif (ret)\r\ngoto error;\r\nret = wiimote_cmd_read(ext->wdata, 0xa600fe, rmem, 2);\r\nif (ret == 2 || rmem[1] == 0x5)\r\navail = true;\r\nerror:\r\nwiimote_cmd_release(ext->wdata);\r\nreturn avail;\r\n}\r\nstatic __u8 ext_read(struct wiimote_ext *ext)\r\n{\r\nssize_t ret;\r\n__u8 rmem[2], wmem;\r\n__u8 type = WIIEXT_NONE;\r\nif (!ext->plugged || !atomic_read(&ext->opened))\r\nreturn WIIEXT_NONE;\r\nif (wiimote_cmd_acquire(ext->wdata))\r\nreturn WIIEXT_NONE;\r\nwmem = 0x55;\r\nret = wiimote_cmd_write(ext->wdata, 0xa400f0, &wmem, sizeof(wmem));\r\nif (!ret) {\r\nwmem = 0x0;\r\nwiimote_cmd_write(ext->wdata, 0xa400fb, &wmem, sizeof(wmem));\r\n}\r\nret = wiimote_cmd_read(ext->wdata, 0xa400fe, rmem, 2);\r\nif (ret == 2) {\r\nif (rmem[0] == 0 && rmem[1] == 0)\r\ntype = WIIEXT_NUNCHUCK;\r\nelse if (rmem[0] == 0x01 && rmem[1] == 0x01)\r\ntype = WIIEXT_CLASSIC;\r\n}\r\nwiimote_cmd_release(ext->wdata);\r\nreturn type;\r\n}\r\nstatic void ext_enable(struct wiimote_ext *ext, bool motionp, __u8 ext_type)\r\n{\r\nunsigned long flags;\r\n__u8 wmem;\r\nint ret;\r\nif (motionp) {\r\nif (wiimote_cmd_acquire(ext->wdata))\r\nreturn;\r\nif (ext_type == WIIEXT_CLASSIC)\r\nwmem = 0x07;\r\nelse if (ext_type == WIIEXT_NUNCHUCK)\r\nwmem = 0x05;\r\nelse\r\nwmem = 0x04;\r\nret = wiimote_cmd_write(ext->wdata, 0xa600fe, &wmem, sizeof(wmem));\r\nwiimote_cmd_release(ext->wdata);\r\nif (ret)\r\nreturn;\r\n}\r\nspin_lock_irqsave(&ext->wdata->state.lock, flags);\r\next->motionp = motionp;\r\next->ext_type = ext_type;\r\nwiiproto_req_drm(ext->wdata, WIIPROTO_REQ_NULL);\r\nspin_unlock_irqrestore(&ext->wdata->state.lock, flags);\r\n}\r\nstatic void wiiext_worker(struct work_struct *work)\r\n{\r\nstruct wiimote_ext *ext = container_of(work, struct wiimote_ext,\r\nworker);\r\nbool motionp;\r\n__u8 ext_type;\r\next_disable(ext);\r\nmotionp = motionp_read(ext);\r\next_type = ext_read(ext);\r\next_enable(ext, motionp, ext_type);\r\n}\r\nstatic void wiiext_schedule(struct wiimote_ext *ext)\r\n{\r\nqueue_work(system_nrt_wq, &ext->worker);\r\n}\r\nvoid wiiext_event(struct wiimote_data *wdata, bool plugged)\r\n{\r\nif (!wdata->ext)\r\nreturn;\r\nif (wdata->ext->plugged == plugged)\r\nreturn;\r\nwdata->ext->plugged = plugged;\r\nif (!plugged)\r\nwdata->ext->mp_plugged = false;\r\n}\r\nbool wiiext_active(struct wiimote_data *wdata)\r\n{\r\nif (!wdata->ext)\r\nreturn false;\r\nreturn wdata->ext->motionp || wdata->ext->ext_type;\r\n}\r\nstatic void handler_motionp(struct wiimote_ext *ext, const __u8 *payload)\r\n{\r\n__s32 x, y, z;\r\nbool plugged;\r\nx = payload[0];\r\ny = payload[1];\r\nz = payload[2];\r\nx |= (((__u16)payload[3]) << 6) & 0xff00;\r\ny |= (((__u16)payload[4]) << 6) & 0xff00;\r\nz |= (((__u16)payload[5]) << 6) & 0xff00;\r\nx -= 8192;\r\ny -= 8192;\r\nz -= 8192;\r\nif (!(payload[3] & 0x02))\r\nx *= 18;\r\nelse\r\nx *= 9;\r\nif (!(payload[4] & 0x02))\r\ny *= 18;\r\nelse\r\ny *= 9;\r\nif (!(payload[3] & 0x01))\r\nz *= 18;\r\nelse\r\nz *= 9;\r\ninput_report_abs(ext->mp_input, ABS_RX, x);\r\ninput_report_abs(ext->mp_input, ABS_RY, y);\r\ninput_report_abs(ext->mp_input, ABS_RZ, z);\r\ninput_sync(ext->mp_input);\r\nplugged = payload[5] & 0x01;\r\nif (plugged != ext->mp_plugged)\r\next->mp_plugged = plugged;\r\n}\r\nstatic void handler_nunchuck(struct wiimote_ext *ext, const __u8 *payload)\r\n{\r\n__s16 x, y, z, bx, by;\r\nbx = payload[0];\r\nby = payload[1];\r\nbx -= 128;\r\nby -= 128;\r\nx = payload[2] << 2;\r\ny = payload[3] << 2;\r\nz = payload[4] << 2;\r\nif (ext->motionp) {\r\nx |= (payload[5] >> 3) & 0x02;\r\ny |= (payload[5] >> 4) & 0x02;\r\nz &= ~0x4;\r\nz |= (payload[5] >> 5) & 0x06;\r\n} else {\r\nx |= (payload[5] >> 2) & 0x03;\r\ny |= (payload[5] >> 4) & 0x03;\r\nz |= (payload[5] >> 6) & 0x03;\r\n}\r\nx -= 0x200;\r\ny -= 0x200;\r\nz -= 0x200;\r\ninput_report_abs(ext->input, ABS_HAT0X, bx);\r\ninput_report_abs(ext->input, ABS_HAT0Y, by);\r\ninput_report_abs(ext->input, ABS_RX, x);\r\ninput_report_abs(ext->input, ABS_RY, y);\r\ninput_report_abs(ext->input, ABS_RZ, z);\r\nif (ext->motionp) {\r\ninput_report_key(ext->input,\r\nwiiext_keymap[WIIEXT_KEY_Z], !!(payload[5] & 0x04));\r\ninput_report_key(ext->input,\r\nwiiext_keymap[WIIEXT_KEY_C], !!(payload[5] & 0x08));\r\n} else {\r\ninput_report_key(ext->input,\r\nwiiext_keymap[WIIEXT_KEY_Z], !!(payload[5] & 0x01));\r\ninput_report_key(ext->input,\r\nwiiext_keymap[WIIEXT_KEY_C], !!(payload[5] & 0x02));\r\n}\r\ninput_sync(ext->input);\r\n}\r\nstatic void handler_classic(struct wiimote_ext *ext, const __u8 *payload)\r\n{\r\n__s8 rx, ry, lx, ly, lt, rt;\r\nif (ext->motionp) {\r\nlx = payload[0] & 0x3e;\r\nly = payload[0] & 0x3e;\r\n} else {\r\nlx = payload[0] & 0x3f;\r\nly = payload[0] & 0x3f;\r\n}\r\nrx = (payload[0] >> 3) & 0x14;\r\nrx |= (payload[1] >> 5) & 0x06;\r\nrx |= (payload[2] >> 7) & 0x01;\r\nry = payload[2] & 0x1f;\r\nrt = payload[3] & 0x1f;\r\nlt = (payload[2] >> 2) & 0x18;\r\nlt |= (payload[3] >> 5) & 0x07;\r\nrx <<= 1;\r\nry <<= 1;\r\nrt <<= 1;\r\nlt <<= 1;\r\ninput_report_abs(ext->input, ABS_HAT1X, lx - 0x20);\r\ninput_report_abs(ext->input, ABS_HAT1Y, ly - 0x20);\r\ninput_report_abs(ext->input, ABS_HAT2X, rx - 0x20);\r\ninput_report_abs(ext->input, ABS_HAT2Y, ry - 0x20);\r\ninput_report_abs(ext->input, ABS_HAT3X, rt - 0x20);\r\ninput_report_abs(ext->input, ABS_HAT3Y, lt - 0x20);\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_RIGHT],\r\n!!(payload[4] & 0x80));\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_DOWN],\r\n!!(payload[4] & 0x40));\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_LT],\r\n!!(payload[4] & 0x20));\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_MINUS],\r\n!!(payload[4] & 0x10));\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_HOME],\r\n!!(payload[4] & 0x08));\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_PLUS],\r\n!!(payload[4] & 0x04));\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_RT],\r\n!!(payload[4] & 0x02));\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_ZL],\r\n!!(payload[5] & 0x80));\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_B],\r\n!!(payload[5] & 0x40));\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_Y],\r\n!!(payload[5] & 0x20));\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_A],\r\n!!(payload[5] & 0x10));\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_X],\r\n!!(payload[5] & 0x08));\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_ZR],\r\n!!(payload[5] & 0x04));\r\nif (ext->motionp) {\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_UP],\r\n!!(payload[0] & 0x01));\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_LEFT],\r\n!!(payload[1] & 0x01));\r\n} else {\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_UP],\r\n!!(payload[5] & 0x01));\r\ninput_report_key(ext->input, wiiext_keymap[WIIEXT_KEY_LEFT],\r\n!!(payload[5] & 0x02));\r\n}\r\ninput_sync(ext->input);\r\n}\r\nvoid wiiext_handle(struct wiimote_data *wdata, const __u8 *payload)\r\n{\r\nstruct wiimote_ext *ext = wdata->ext;\r\nif (!ext)\r\nreturn;\r\nif (ext->motionp && (payload[5] & 0x02)) {\r\nhandler_motionp(ext, payload);\r\n} else if (ext->ext_type == WIIEXT_NUNCHUCK) {\r\nhandler_nunchuck(ext, payload);\r\n} else if (ext->ext_type == WIIEXT_CLASSIC) {\r\nhandler_classic(ext, payload);\r\n}\r\n}\r\nstatic ssize_t wiiext_show(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct wiimote_data *wdata = dev_to_wii(dev);\r\n__u8 type = WIIEXT_NONE;\r\nbool motionp = false;\r\nunsigned long flags;\r\nspin_lock_irqsave(&wdata->state.lock, flags);\r\nif (wdata->ext) {\r\nmotionp = wdata->ext->motionp;\r\ntype = wdata->ext->ext_type;\r\n}\r\nspin_unlock_irqrestore(&wdata->state.lock, flags);\r\nif (type == WIIEXT_NUNCHUCK) {\r\nif (motionp)\r\nreturn sprintf(buf, "motionp+nunchuck\n");\r\nelse\r\nreturn sprintf(buf, "nunchuck\n");\r\n} else if (type == WIIEXT_CLASSIC) {\r\nif (motionp)\r\nreturn sprintf(buf, "motionp+classic\n");\r\nelse\r\nreturn sprintf(buf, "classic\n");\r\n} else {\r\nif (motionp)\r\nreturn sprintf(buf, "motionp\n");\r\nelse\r\nreturn sprintf(buf, "none\n");\r\n}\r\n}\r\nstatic int wiiext_input_open(struct input_dev *dev)\r\n{\r\nstruct wiimote_ext *ext = input_get_drvdata(dev);\r\nint ret;\r\nret = hid_hw_open(ext->wdata->hdev);\r\nif (ret)\r\nreturn ret;\r\natomic_inc(&ext->opened);\r\nwiiext_schedule(ext);\r\nreturn 0;\r\n}\r\nstatic void wiiext_input_close(struct input_dev *dev)\r\n{\r\nstruct wiimote_ext *ext = input_get_drvdata(dev);\r\natomic_dec(&ext->opened);\r\nwiiext_schedule(ext);\r\nhid_hw_close(ext->wdata->hdev);\r\n}\r\nstatic int wiiext_mp_open(struct input_dev *dev)\r\n{\r\nstruct wiimote_ext *ext = input_get_drvdata(dev);\r\nint ret;\r\nret = hid_hw_open(ext->wdata->hdev);\r\nif (ret)\r\nreturn ret;\r\natomic_inc(&ext->mp_opened);\r\nwiiext_schedule(ext);\r\nreturn 0;\r\n}\r\nstatic void wiiext_mp_close(struct input_dev *dev)\r\n{\r\nstruct wiimote_ext *ext = input_get_drvdata(dev);\r\natomic_dec(&ext->mp_opened);\r\nwiiext_schedule(ext);\r\nhid_hw_close(ext->wdata->hdev);\r\n}\r\nint wiiext_init(struct wiimote_data *wdata)\r\n{\r\nstruct wiimote_ext *ext;\r\nunsigned long flags;\r\nint ret, i;\r\next = kzalloc(sizeof(*ext), GFP_KERNEL);\r\nif (!ext)\r\nreturn -ENOMEM;\r\next->wdata = wdata;\r\nINIT_WORK(&ext->worker, wiiext_worker);\r\next->input = input_allocate_device();\r\nif (!ext->input) {\r\nret = -ENOMEM;\r\ngoto err_input;\r\n}\r\ninput_set_drvdata(ext->input, ext);\r\next->input->open = wiiext_input_open;\r\next->input->close = wiiext_input_close;\r\next->input->dev.parent = &wdata->hdev->dev;\r\next->input->id.bustype = wdata->hdev->bus;\r\next->input->id.vendor = wdata->hdev->vendor;\r\next->input->id.product = wdata->hdev->product;\r\next->input->id.version = wdata->hdev->version;\r\next->input->name = WIIMOTE_NAME " Extension";\r\nset_bit(EV_KEY, ext->input->evbit);\r\nfor (i = 0; i < WIIEXT_KEY_COUNT; ++i)\r\nset_bit(wiiext_keymap[i], ext->input->keybit);\r\nset_bit(EV_ABS, ext->input->evbit);\r\nset_bit(ABS_HAT0X, ext->input->absbit);\r\nset_bit(ABS_HAT0Y, ext->input->absbit);\r\nset_bit(ABS_HAT1X, ext->input->absbit);\r\nset_bit(ABS_HAT1Y, ext->input->absbit);\r\nset_bit(ABS_HAT2X, ext->input->absbit);\r\nset_bit(ABS_HAT2Y, ext->input->absbit);\r\nset_bit(ABS_HAT3X, ext->input->absbit);\r\nset_bit(ABS_HAT3Y, ext->input->absbit);\r\ninput_set_abs_params(ext->input, ABS_HAT0X, -120, 120, 2, 4);\r\ninput_set_abs_params(ext->input, ABS_HAT0Y, -120, 120, 2, 4);\r\ninput_set_abs_params(ext->input, ABS_HAT1X, -30, 30, 1, 1);\r\ninput_set_abs_params(ext->input, ABS_HAT1Y, -30, 30, 1, 1);\r\ninput_set_abs_params(ext->input, ABS_HAT2X, -30, 30, 1, 1);\r\ninput_set_abs_params(ext->input, ABS_HAT2Y, -30, 30, 1, 1);\r\ninput_set_abs_params(ext->input, ABS_HAT3X, -30, 30, 1, 1);\r\ninput_set_abs_params(ext->input, ABS_HAT3Y, -30, 30, 1, 1);\r\nset_bit(ABS_RX, ext->input->absbit);\r\nset_bit(ABS_RY, ext->input->absbit);\r\nset_bit(ABS_RZ, ext->input->absbit);\r\ninput_set_abs_params(ext->input, ABS_RX, -500, 500, 2, 4);\r\ninput_set_abs_params(ext->input, ABS_RY, -500, 500, 2, 4);\r\ninput_set_abs_params(ext->input, ABS_RZ, -500, 500, 2, 4);\r\nret = input_register_device(ext->input);\r\nif (ret) {\r\ninput_free_device(ext->input);\r\ngoto err_input;\r\n}\r\next->mp_input = input_allocate_device();\r\nif (!ext->mp_input) {\r\nret = -ENOMEM;\r\ngoto err_mp;\r\n}\r\ninput_set_drvdata(ext->mp_input, ext);\r\next->mp_input->open = wiiext_mp_open;\r\next->mp_input->close = wiiext_mp_close;\r\next->mp_input->dev.parent = &wdata->hdev->dev;\r\next->mp_input->id.bustype = wdata->hdev->bus;\r\next->mp_input->id.vendor = wdata->hdev->vendor;\r\next->mp_input->id.product = wdata->hdev->product;\r\next->mp_input->id.version = wdata->hdev->version;\r\next->mp_input->name = WIIMOTE_NAME " Motion+";\r\nset_bit(EV_ABS, ext->mp_input->evbit);\r\nset_bit(ABS_RX, ext->mp_input->absbit);\r\nset_bit(ABS_RY, ext->mp_input->absbit);\r\nset_bit(ABS_RZ, ext->mp_input->absbit);\r\ninput_set_abs_params(ext->mp_input, ABS_RX, -160000, 160000, 4, 8);\r\ninput_set_abs_params(ext->mp_input, ABS_RY, -160000, 160000, 4, 8);\r\ninput_set_abs_params(ext->mp_input, ABS_RZ, -160000, 160000, 4, 8);\r\nret = input_register_device(ext->mp_input);\r\nif (ret) {\r\ninput_free_device(ext->mp_input);\r\ngoto err_mp;\r\n}\r\nret = device_create_file(&wdata->hdev->dev, &dev_attr_extension);\r\nif (ret)\r\ngoto err_dev;\r\nspin_lock_irqsave(&wdata->state.lock, flags);\r\nwdata->ext = ext;\r\nspin_unlock_irqrestore(&wdata->state.lock, flags);\r\nreturn 0;\r\nerr_dev:\r\ninput_unregister_device(ext->mp_input);\r\nerr_mp:\r\ninput_unregister_device(ext->input);\r\nerr_input:\r\nkfree(ext);\r\nreturn ret;\r\n}\r\nvoid wiiext_deinit(struct wiimote_data *wdata)\r\n{\r\nstruct wiimote_ext *ext = wdata->ext;\r\nunsigned long flags;\r\nif (!ext)\r\nreturn;\r\nspin_lock_irqsave(&wdata->state.lock, flags);\r\nwdata->ext = NULL;\r\nspin_unlock_irqrestore(&wdata->state.lock, flags);\r\ndevice_remove_file(&wdata->hdev->dev, &dev_attr_extension);\r\ninput_unregister_device(ext->mp_input);\r\ninput_unregister_device(ext->input);\r\ncancel_work_sync(&ext->worker);\r\nkfree(ext);\r\n}

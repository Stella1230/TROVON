static irqreturn_t sh73a0_intcs_demux(int irq, void *dev_id)\r\n{\r\nunsigned int evtcodeas = ioread32((void __iomem *)dev_id);\r\ngeneric_handle_irq(intcs_evt2irq(evtcodeas));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int sh73a0_set_wake(struct irq_data *data, unsigned int on)\r\n{\r\nreturn 0;\r\n}\r\nstatic int to_gic_irq(struct irq_data *data)\r\n{\r\nunsigned int vect = irq2evt(data->irq) - INTCS_VECT_BASE;\r\nif (vect >= 0x3200)\r\nvect -= 0x3000;\r\nelse\r\nvect -= 0x0200;\r\nreturn gic_spi((vect >> 5) + 1);\r\n}\r\nstatic int to_intca_reloc_irq(struct irq_data *data)\r\n{\r\nreturn data->irq + (RELOC_BASE >> 5);\r\n}\r\nstatic void intca_gic_enable(struct irq_data *data)\r\n{\r\nirq_cb(irq_unmask, to_intca_reloc_irq(data));\r\nirq_cb(irq_unmask, to_gic_irq(data));\r\n}\r\nstatic void intca_gic_disable(struct irq_data *data)\r\n{\r\nirq_cb(irq_mask, to_gic_irq(data));\r\nirq_cb(irq_mask, to_intca_reloc_irq(data));\r\n}\r\nstatic void intca_gic_mask_ack(struct irq_data *data)\r\n{\r\nirq_cb(irq_mask, to_gic_irq(data));\r\nirq_cb(irq_mask_ack, to_intca_reloc_irq(data));\r\n}\r\nstatic void intca_gic_eoi(struct irq_data *data)\r\n{\r\nirq_cb(irq_eoi, to_gic_irq(data));\r\n}\r\nstatic int intca_gic_set_type(struct irq_data *data, unsigned int type)\r\n{\r\nreturn irq_cbp(irq_set_type, to_intca_reloc_irq(data), type);\r\n}\r\nstatic int intca_gic_set_wake(struct irq_data *data, unsigned int on)\r\n{\r\nreturn irq_cbp(irq_set_wake, to_intca_reloc_irq(data), on);\r\n}\r\nstatic int intca_gic_set_affinity(struct irq_data *data,\r\nconst struct cpumask *cpumask,\r\nbool force)\r\n{\r\nreturn irq_cbp(irq_set_affinity, to_gic_irq(data), cpumask, force);\r\n}\r\nstatic int to_intc_vect(int irq)\r\n{\r\nunsigned int irq_pin = irq - gic_spi(1);\r\nunsigned int offs;\r\nif (irq_pin < 16)\r\noffs = 0x0200;\r\nelse\r\noffs = 0x3000;\r\nreturn offs + (irq_pin << 5);\r\n}\r\nstatic irqreturn_t sh73a0_irq_pin_demux(int irq, void *dev_id)\r\n{\r\ngeneric_handle_irq(intcs_evt2irq(to_intc_vect(irq)));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void pint_demux(unsigned long rr, unsigned long er, int base_irq)\r\n{\r\nunsigned long value = ioread32(rr) & ioread32(er);\r\nint k;\r\nfor (k = 0; k < 32; k++) {\r\nif (value & (1 << (31 - k))) {\r\ngeneric_handle_irq(base_irq + k);\r\niowrite32(~(1 << (31 - k)), rr);\r\n}\r\n}\r\n}\r\nstatic irqreturn_t sh73a0_pint0_demux(int irq, void *dev_id)\r\n{\r\npint_demux(PINTRR0, PINTER0, SH73A0_PINT0_IRQ(0));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t sh73a0_pint1_demux(int irq, void *dev_id)\r\n{\r\npint_demux(PINTRR1, PINTER1, SH73A0_PINT1_IRQ(0));\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid __init sh73a0_init_irq(void)\r\n{\r\nvoid __iomem *gic_dist_base = IOMEM(0xf0001000);\r\nvoid __iomem *gic_cpu_base = IOMEM(0xf0000100);\r\nvoid __iomem *intevtsa = ioremap_nocache(0xffd20100, PAGE_SIZE);\r\nint k, n;\r\ngic_init(0, 29, gic_dist_base, gic_cpu_base);\r\ngic_arch_extn.irq_set_wake = sh73a0_set_wake;\r\nregister_intc_controller(&intcs_desc);\r\nregister_intc_controller(&intca_irq_pins_desc);\r\nregister_intc_controller(&intc_pint0_desc);\r\nregister_intc_controller(&intc_pint1_desc);\r\nsh73a0_intcs_cascade.name = "INTCS cascade";\r\nsh73a0_intcs_cascade.handler = sh73a0_intcs_demux;\r\nsh73a0_intcs_cascade.dev_id = intevtsa;\r\nsetup_irq(gic_spi(50), &sh73a0_intcs_cascade);\r\nfor (k = 0; k < 32; k++) {\r\nsh73a0_irq_pin_cascade[k].name = "INTCA-GIC cascade";\r\nsh73a0_irq_pin_cascade[k].handler = sh73a0_irq_pin_demux;\r\nsetup_irq(gic_spi(1 + k), &sh73a0_irq_pin_cascade[k]);\r\nn = intcs_evt2irq(to_intc_vect(gic_spi(1 + k)));\r\nWARN_ON(irq_alloc_desc_at(n, numa_node_id()) != n);\r\nirq_set_chip_and_handler_name(n, &intca_gic_irq_chip,\r\nhandle_level_irq, "level");\r\nset_irq_flags(n, IRQF_VALID);\r\n}\r\nsh73a0_pint0_cascade.name = "PINT0 cascade";\r\nsh73a0_pint0_cascade.handler = sh73a0_pint0_demux;\r\nsetup_irq(gic_spi(33), &sh73a0_pint0_cascade);\r\nsh73a0_pint1_cascade.name = "PINT1 cascade";\r\nsh73a0_pint1_cascade.handler = sh73a0_pint1_demux;\r\nsetup_irq(gic_spi(34), &sh73a0_pint1_cascade);\r\n}

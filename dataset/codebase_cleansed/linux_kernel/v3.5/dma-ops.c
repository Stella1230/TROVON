static unsigned samsung_dmadev_request(enum dma_ch dma_ch,\r\nstruct samsung_dma_info *info)\r\n{\r\nstruct dma_chan *chan;\r\ndma_cap_mask_t mask;\r\nstruct dma_slave_config slave_config;\r\nvoid *filter_param;\r\ndma_cap_zero(mask);\r\ndma_cap_set(info->cap, mask);\r\nfilter_param = (dma_ch == DMACH_DT_PROP) ? (void *)info->dt_dmach_prop :\r\n(void *)dma_ch;\r\nchan = dma_request_channel(mask, pl330_filter, filter_param);\r\nif (info->direction == DMA_DEV_TO_MEM) {\r\nmemset(&slave_config, 0, sizeof(struct dma_slave_config));\r\nslave_config.direction = info->direction;\r\nslave_config.src_addr = info->fifo;\r\nslave_config.src_addr_width = info->width;\r\nslave_config.src_maxburst = 1;\r\ndmaengine_slave_config(chan, &slave_config);\r\n} else if (info->direction == DMA_MEM_TO_DEV) {\r\nmemset(&slave_config, 0, sizeof(struct dma_slave_config));\r\nslave_config.direction = info->direction;\r\nslave_config.dst_addr = info->fifo;\r\nslave_config.dst_addr_width = info->width;\r\nslave_config.dst_maxburst = 1;\r\ndmaengine_slave_config(chan, &slave_config);\r\n}\r\nreturn (unsigned)chan;\r\n}\r\nstatic int samsung_dmadev_release(unsigned ch,\r\nstruct s3c2410_dma_client *client)\r\n{\r\ndma_release_channel((struct dma_chan *)ch);\r\nreturn 0;\r\n}\r\nstatic int samsung_dmadev_prepare(unsigned ch,\r\nstruct samsung_dma_prep_info *info)\r\n{\r\nstruct scatterlist sg;\r\nstruct dma_chan *chan = (struct dma_chan *)ch;\r\nstruct dma_async_tx_descriptor *desc;\r\nswitch (info->cap) {\r\ncase DMA_SLAVE:\r\nsg_init_table(&sg, 1);\r\nsg_dma_len(&sg) = info->len;\r\nsg_set_page(&sg, pfn_to_page(PFN_DOWN(info->buf)),\r\ninfo->len, offset_in_page(info->buf));\r\nsg_dma_address(&sg) = info->buf;\r\ndesc = dmaengine_prep_slave_sg(chan,\r\n&sg, 1, info->direction, DMA_PREP_INTERRUPT);\r\nbreak;\r\ncase DMA_CYCLIC:\r\ndesc = dmaengine_prep_dma_cyclic(chan,\r\ninfo->buf, info->len, info->period, info->direction);\r\nbreak;\r\ndefault:\r\ndev_err(&chan->dev->device, "unsupported format\n");\r\nreturn -EFAULT;\r\n}\r\nif (!desc) {\r\ndev_err(&chan->dev->device, "cannot prepare cyclic dma\n");\r\nreturn -EFAULT;\r\n}\r\ndesc->callback = info->fp;\r\ndesc->callback_param = info->fp_param;\r\ndmaengine_submit((struct dma_async_tx_descriptor *)desc);\r\nreturn 0;\r\n}\r\nstatic inline int samsung_dmadev_trigger(unsigned ch)\r\n{\r\ndma_async_issue_pending((struct dma_chan *)ch);\r\nreturn 0;\r\n}\r\nstatic inline int samsung_dmadev_flush(unsigned ch)\r\n{\r\nreturn dmaengine_terminate_all((struct dma_chan *)ch);\r\n}\r\nvoid *samsung_dmadev_get_ops(void)\r\n{\r\nreturn &dmadev_ops;\r\n}

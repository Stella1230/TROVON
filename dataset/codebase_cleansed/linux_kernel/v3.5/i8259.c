static void mask_8259A_irq(unsigned int irq)\r\n{\r\nunsigned int mask = 1 << irq;\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&i8259A_lock, flags);\r\ncached_irq_mask |= mask;\r\nif (irq & 8)\r\noutb(cached_slave_mask, PIC_SLAVE_IMR);\r\nelse\r\noutb(cached_master_mask, PIC_MASTER_IMR);\r\nraw_spin_unlock_irqrestore(&i8259A_lock, flags);\r\n}\r\nstatic void disable_8259A_irq(struct irq_data *data)\r\n{\r\nmask_8259A_irq(data->irq);\r\n}\r\nstatic void unmask_8259A_irq(unsigned int irq)\r\n{\r\nunsigned int mask = ~(1 << irq);\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&i8259A_lock, flags);\r\ncached_irq_mask &= mask;\r\nif (irq & 8)\r\noutb(cached_slave_mask, PIC_SLAVE_IMR);\r\nelse\r\noutb(cached_master_mask, PIC_MASTER_IMR);\r\nraw_spin_unlock_irqrestore(&i8259A_lock, flags);\r\n}\r\nstatic void enable_8259A_irq(struct irq_data *data)\r\n{\r\nunmask_8259A_irq(data->irq);\r\n}\r\nstatic int i8259A_irq_pending(unsigned int irq)\r\n{\r\nunsigned int mask = 1<<irq;\r\nunsigned long flags;\r\nint ret;\r\nraw_spin_lock_irqsave(&i8259A_lock, flags);\r\nif (irq < 8)\r\nret = inb(PIC_MASTER_CMD) & mask;\r\nelse\r\nret = inb(PIC_SLAVE_CMD) & (mask >> 8);\r\nraw_spin_unlock_irqrestore(&i8259A_lock, flags);\r\nreturn ret;\r\n}\r\nstatic void make_8259A_irq(unsigned int irq)\r\n{\r\ndisable_irq_nosync(irq);\r\nio_apic_irqs &= ~(1<<irq);\r\nirq_set_chip_and_handler_name(irq, &i8259A_chip, handle_level_irq,\r\ni8259A_chip.name);\r\nenable_irq(irq);\r\n}\r\nstatic inline int i8259A_irq_real(unsigned int irq)\r\n{\r\nint value;\r\nint irqmask = 1<<irq;\r\nif (irq < 8) {\r\noutb(0x0B, PIC_MASTER_CMD);\r\nvalue = inb(PIC_MASTER_CMD) & irqmask;\r\noutb(0x0A, PIC_MASTER_CMD);\r\nreturn value;\r\n}\r\noutb(0x0B, PIC_SLAVE_CMD);\r\nvalue = inb(PIC_SLAVE_CMD) & (irqmask >> 8);\r\noutb(0x0A, PIC_SLAVE_CMD);\r\nreturn value;\r\n}\r\nstatic void mask_and_ack_8259A(struct irq_data *data)\r\n{\r\nunsigned int irq = data->irq;\r\nunsigned int irqmask = 1 << irq;\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&i8259A_lock, flags);\r\nif (cached_irq_mask & irqmask)\r\ngoto spurious_8259A_irq;\r\ncached_irq_mask |= irqmask;\r\nhandle_real_irq:\r\nif (irq & 8) {\r\ninb(PIC_SLAVE_IMR);\r\noutb(cached_slave_mask, PIC_SLAVE_IMR);\r\noutb(0x60+(irq&7), PIC_SLAVE_CMD);\r\noutb(0x60+PIC_CASCADE_IR, PIC_MASTER_CMD);\r\n} else {\r\ninb(PIC_MASTER_IMR);\r\noutb(cached_master_mask, PIC_MASTER_IMR);\r\noutb(0x60+irq, PIC_MASTER_CMD);\r\n}\r\nraw_spin_unlock_irqrestore(&i8259A_lock, flags);\r\nreturn;\r\nspurious_8259A_irq:\r\nif (i8259A_irq_real(irq))\r\ngoto handle_real_irq;\r\n{\r\nstatic int spurious_irq_mask;\r\nif (!(spurious_irq_mask & irqmask)) {\r\nprintk(KERN_DEBUG\r\n"spurious 8259A interrupt: IRQ%d.\n", irq);\r\nspurious_irq_mask |= irqmask;\r\n}\r\natomic_inc(&irq_err_count);\r\ngoto handle_real_irq;\r\n}\r\n}\r\nstatic void restore_ELCR(char *trigger)\r\n{\r\noutb(trigger[0], 0x4d0);\r\noutb(trigger[1], 0x4d1);\r\n}\r\nstatic void save_ELCR(char *trigger)\r\n{\r\ntrigger[0] = inb(0x4d0) & 0xF8;\r\ntrigger[1] = inb(0x4d1) & 0xDE;\r\n}\r\nstatic void i8259A_resume(void)\r\n{\r\ninit_8259A(i8259A_auto_eoi);\r\nrestore_ELCR(irq_trigger);\r\n}\r\nstatic int i8259A_suspend(void)\r\n{\r\nsave_ELCR(irq_trigger);\r\nreturn 0;\r\n}\r\nstatic void i8259A_shutdown(void)\r\n{\r\noutb(0xff, PIC_MASTER_IMR);\r\noutb(0xff, PIC_SLAVE_IMR);\r\n}\r\nstatic void mask_8259A(void)\r\n{\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&i8259A_lock, flags);\r\noutb(0xff, PIC_MASTER_IMR);\r\noutb(0xff, PIC_SLAVE_IMR);\r\nraw_spin_unlock_irqrestore(&i8259A_lock, flags);\r\n}\r\nstatic void unmask_8259A(void)\r\n{\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&i8259A_lock, flags);\r\noutb(cached_master_mask, PIC_MASTER_IMR);\r\noutb(cached_slave_mask, PIC_SLAVE_IMR);\r\nraw_spin_unlock_irqrestore(&i8259A_lock, flags);\r\n}\r\nstatic void init_8259A(int auto_eoi)\r\n{\r\nunsigned long flags;\r\ni8259A_auto_eoi = auto_eoi;\r\nraw_spin_lock_irqsave(&i8259A_lock, flags);\r\noutb(0xff, PIC_MASTER_IMR);\r\noutb(0xff, PIC_SLAVE_IMR);\r\noutb_pic(0x11, PIC_MASTER_CMD);\r\noutb_pic(IRQ0_VECTOR, PIC_MASTER_IMR);\r\noutb_pic(1U << PIC_CASCADE_IR, PIC_MASTER_IMR);\r\nif (auto_eoi)\r\noutb_pic(MASTER_ICW4_DEFAULT | PIC_ICW4_AEOI, PIC_MASTER_IMR);\r\nelse\r\noutb_pic(MASTER_ICW4_DEFAULT, PIC_MASTER_IMR);\r\noutb_pic(0x11, PIC_SLAVE_CMD);\r\noutb_pic(IRQ8_VECTOR, PIC_SLAVE_IMR);\r\noutb_pic(PIC_CASCADE_IR, PIC_SLAVE_IMR);\r\noutb_pic(SLAVE_ICW4_DEFAULT, PIC_SLAVE_IMR);\r\nif (auto_eoi)\r\ni8259A_chip.irq_mask_ack = disable_8259A_irq;\r\nelse\r\ni8259A_chip.irq_mask_ack = mask_and_ack_8259A;\r\nudelay(100);\r\noutb(cached_master_mask, PIC_MASTER_IMR);\r\noutb(cached_slave_mask, PIC_SLAVE_IMR);\r\nraw_spin_unlock_irqrestore(&i8259A_lock, flags);\r\n}\r\nstatic void legacy_pic_noop(void) { }\r\nstatic void legacy_pic_uint_noop(unsigned int unused) { }\r\nstatic void legacy_pic_int_noop(int unused) { }\r\nstatic int legacy_pic_irq_pending_noop(unsigned int irq)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __init i8259A_init_ops(void)\r\n{\r\nif (legacy_pic == &default_legacy_pic)\r\nregister_syscore_ops(&i8259_syscore_ops);\r\nreturn 0;\r\n}

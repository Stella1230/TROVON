int input_mt_init_slots(struct input_dev *dev, unsigned int num_slots)\r\n{\r\nint i;\r\nif (!num_slots)\r\nreturn 0;\r\nif (dev->mt)\r\nreturn dev->mtsize != num_slots ? -EINVAL : 0;\r\ndev->mt = kcalloc(num_slots, sizeof(struct input_mt_slot), GFP_KERNEL);\r\nif (!dev->mt)\r\nreturn -ENOMEM;\r\ndev->mtsize = num_slots;\r\ninput_set_abs_params(dev, ABS_MT_SLOT, 0, num_slots - 1, 0, 0);\r\ninput_set_abs_params(dev, ABS_MT_TRACKING_ID, 0, TRKID_MAX, 0, 0);\r\ninput_set_events_per_packet(dev, 6 * num_slots);\r\nfor (i = 0; i < num_slots; i++)\r\ninput_mt_set_value(&dev->mt[i], ABS_MT_TRACKING_ID, -1);\r\nreturn 0;\r\n}\r\nvoid input_mt_destroy_slots(struct input_dev *dev)\r\n{\r\nkfree(dev->mt);\r\ndev->mt = NULL;\r\ndev->mtsize = 0;\r\ndev->slot = 0;\r\ndev->trkid = 0;\r\n}\r\nvoid input_mt_report_slot_state(struct input_dev *dev,\r\nunsigned int tool_type, bool active)\r\n{\r\nstruct input_mt_slot *mt;\r\nint id;\r\nif (!dev->mt || !active) {\r\ninput_event(dev, EV_ABS, ABS_MT_TRACKING_ID, -1);\r\nreturn;\r\n}\r\nmt = &dev->mt[dev->slot];\r\nid = input_mt_get_value(mt, ABS_MT_TRACKING_ID);\r\nif (id < 0 || input_mt_get_value(mt, ABS_MT_TOOL_TYPE) != tool_type)\r\nid = input_mt_new_trkid(dev);\r\ninput_event(dev, EV_ABS, ABS_MT_TRACKING_ID, id);\r\ninput_event(dev, EV_ABS, ABS_MT_TOOL_TYPE, tool_type);\r\n}\r\nvoid input_mt_report_finger_count(struct input_dev *dev, int count)\r\n{\r\ninput_event(dev, EV_KEY, BTN_TOOL_FINGER, count == 1);\r\ninput_event(dev, EV_KEY, BTN_TOOL_DOUBLETAP, count == 2);\r\ninput_event(dev, EV_KEY, BTN_TOOL_TRIPLETAP, count == 3);\r\ninput_event(dev, EV_KEY, BTN_TOOL_QUADTAP, count == 4);\r\ninput_event(dev, EV_KEY, BTN_TOOL_QUINTTAP, count == 5);\r\n}\r\nvoid input_mt_report_pointer_emulation(struct input_dev *dev, bool use_count)\r\n{\r\nstruct input_mt_slot *oldest = 0;\r\nint oldid = dev->trkid;\r\nint count = 0;\r\nint i;\r\nfor (i = 0; i < dev->mtsize; ++i) {\r\nstruct input_mt_slot *ps = &dev->mt[i];\r\nint id = input_mt_get_value(ps, ABS_MT_TRACKING_ID);\r\nif (id < 0)\r\ncontinue;\r\nif ((id - oldid) & TRKID_SGN) {\r\noldest = ps;\r\noldid = id;\r\n}\r\ncount++;\r\n}\r\ninput_event(dev, EV_KEY, BTN_TOUCH, count > 0);\r\nif (use_count)\r\ninput_mt_report_finger_count(dev, count);\r\nif (oldest) {\r\nint x = input_mt_get_value(oldest, ABS_MT_POSITION_X);\r\nint y = input_mt_get_value(oldest, ABS_MT_POSITION_Y);\r\nint p = input_mt_get_value(oldest, ABS_MT_PRESSURE);\r\ninput_event(dev, EV_ABS, ABS_X, x);\r\ninput_event(dev, EV_ABS, ABS_Y, y);\r\ninput_event(dev, EV_ABS, ABS_PRESSURE, p);\r\n} else {\r\ninput_event(dev, EV_ABS, ABS_PRESSURE, 0);\r\n}\r\n}

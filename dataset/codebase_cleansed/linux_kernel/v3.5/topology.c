const struct cpumask *cpu_coregroup_mask(int cpu)\r\n{\r\nreturn &cpu_topology[cpu].core_sibling;\r\n}\r\nvoid store_cpu_topology(unsigned int cpuid)\r\n{\r\nstruct cputopo_arm *cpuid_topo = &cpu_topology[cpuid];\r\nunsigned int mpidr;\r\nunsigned int cpu;\r\nif (cpuid_topo->core_id != -1)\r\nreturn;\r\nmpidr = read_cpuid_mpidr();\r\nif ((mpidr & MPIDR_SMP_BITMASK) == MPIDR_SMP_VALUE) {\r\nif (mpidr & MPIDR_MT_BITMASK) {\r\ncpuid_topo->thread_id = (mpidr >> MPIDR_LEVEL0_SHIFT)\r\n& MPIDR_LEVEL0_MASK;\r\ncpuid_topo->core_id = (mpidr >> MPIDR_LEVEL1_SHIFT)\r\n& MPIDR_LEVEL1_MASK;\r\ncpuid_topo->socket_id = (mpidr >> MPIDR_LEVEL2_SHIFT)\r\n& MPIDR_LEVEL2_MASK;\r\n} else {\r\ncpuid_topo->thread_id = -1;\r\ncpuid_topo->core_id = (mpidr >> MPIDR_LEVEL0_SHIFT)\r\n& MPIDR_LEVEL0_MASK;\r\ncpuid_topo->socket_id = (mpidr >> MPIDR_LEVEL1_SHIFT)\r\n& MPIDR_LEVEL1_MASK;\r\n}\r\n} else {\r\ncpuid_topo->thread_id = -1;\r\ncpuid_topo->core_id = 0;\r\ncpuid_topo->socket_id = -1;\r\n}\r\nfor_each_possible_cpu(cpu) {\r\nstruct cputopo_arm *cpu_topo = &cpu_topology[cpu];\r\nif (cpuid_topo->socket_id == cpu_topo->socket_id) {\r\ncpumask_set_cpu(cpuid, &cpu_topo->core_sibling);\r\nif (cpu != cpuid)\r\ncpumask_set_cpu(cpu,\r\n&cpuid_topo->core_sibling);\r\nif (cpuid_topo->core_id == cpu_topo->core_id) {\r\ncpumask_set_cpu(cpuid,\r\n&cpu_topo->thread_sibling);\r\nif (cpu != cpuid)\r\ncpumask_set_cpu(cpu,\r\n&cpuid_topo->thread_sibling);\r\n}\r\n}\r\n}\r\nsmp_wmb();\r\nprintk(KERN_INFO "CPU%u: thread %d, cpu %d, socket %d, mpidr %x\n",\r\ncpuid, cpu_topology[cpuid].thread_id,\r\ncpu_topology[cpuid].core_id,\r\ncpu_topology[cpuid].socket_id, mpidr);\r\n}\r\nvoid init_cpu_topology(void)\r\n{\r\nunsigned int cpu;\r\nfor_each_possible_cpu(cpu) {\r\nstruct cputopo_arm *cpu_topo = &(cpu_topology[cpu]);\r\ncpu_topo->thread_id = -1;\r\ncpu_topo->core_id = -1;\r\ncpu_topo->socket_id = -1;\r\ncpumask_clear(&cpu_topo->core_sibling);\r\ncpumask_clear(&cpu_topo->thread_sibling);\r\n}\r\nsmp_wmb();\r\n}

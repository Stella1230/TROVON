static int tegra_idle_enter_lp3(struct cpuidle_device *dev,\r\nstruct cpuidle_driver *drv, int index)\r\n{\r\nktime_t enter, exit;\r\ns64 us;\r\nlocal_irq_disable();\r\nlocal_fiq_disable();\r\nenter = ktime_get();\r\ntegra_cpu_wfi();\r\nexit = ktime_sub(ktime_get(), enter);\r\nus = ktime_to_us(exit);\r\nlocal_fiq_enable();\r\nlocal_irq_enable();\r\ndev->last_residency = us;\r\nreturn index;\r\n}\r\nstatic int __init tegra_cpuidle_init(void)\r\n{\r\nint ret;\r\nunsigned int cpu;\r\nstruct cpuidle_device *dev;\r\nstruct cpuidle_driver *drv = &tegra_idle_driver;\r\nret = cpuidle_register_driver(&tegra_idle_driver);\r\nif (ret) {\r\npr_err("CPUidle driver registration failed\n");\r\nreturn ret;\r\n}\r\nfor_each_possible_cpu(cpu) {\r\ndev = &per_cpu(tegra_idle_device, cpu);\r\ndev->cpu = cpu;\r\ndev->state_count = drv->state_count;\r\nret = cpuidle_register_device(dev);\r\nif (ret) {\r\npr_err("CPU%u: CPUidle device registration failed\n",\r\ncpu);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}

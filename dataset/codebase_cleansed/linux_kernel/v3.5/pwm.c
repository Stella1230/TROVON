struct pwm_device *pwm_request(int pwm_id, const char *label)\r\n{\r\nstruct pwm_device *pwm;\r\nint ret;\r\nif (pwm_id < 0)\r\nreturn NULL;\r\npwm = kzalloc(sizeof(*pwm), GFP_KERNEL);\r\nif (!pwm)\r\nreturn pwm;\r\npwm->id = pwm_id;\r\nif (pwm->id >= ARRAY_SIZE(pwm_to_gptimer_per))\r\ngoto err;\r\npwm->pin = pwm_to_gptimer_per[pwm->id];\r\nret = peripheral_request(pwm->pin, label);\r\nif (ret)\r\ngoto err;\r\nreturn pwm;\r\nerr:\r\nkfree(pwm);\r\nreturn NULL;\r\n}\r\nvoid pwm_free(struct pwm_device *pwm)\r\n{\r\nperipheral_free(pwm->pin);\r\nkfree(pwm);\r\n}\r\nint pwm_config(struct pwm_device *pwm, int duty_ns, int period_ns)\r\n{\r\nunsigned long period, duty;\r\nunsigned long long val;\r\nif (duty_ns < 0 || duty_ns > period_ns)\r\nreturn -EINVAL;\r\nval = (unsigned long long)get_sclk() * period_ns;\r\ndo_div(val, NSEC_PER_SEC);\r\nperiod = val;\r\nval = (unsigned long long)period * duty_ns;\r\ndo_div(val, period_ns);\r\nduty = period - val;\r\nif (duty >= period)\r\nduty = period - 1;\r\nset_gptimer_config(pwm->id, TIMER_MODE_PWM | TIMER_PERIOD_CNT);\r\nset_gptimer_pwidth(pwm->id, duty);\r\nset_gptimer_period(pwm->id, period);\r\nreturn 0;\r\n}\r\nint pwm_enable(struct pwm_device *pwm)\r\n{\r\nenable_gptimer(pwm->id);\r\nreturn 0;\r\n}\r\nvoid pwm_disable(struct pwm_device *pwm)\r\n{\r\ndisable_gptimer(pwm->id);\r\n}

static int ttm_bo_man_get_node(struct ttm_mem_type_manager *man,\r\nstruct ttm_buffer_object *bo,\r\nstruct ttm_placement *placement,\r\nstruct ttm_mem_reg *mem)\r\n{\r\nstruct ttm_range_manager *rman = (struct ttm_range_manager *) man->priv;\r\nstruct drm_mm *mm = &rman->mm;\r\nstruct drm_mm_node *node = NULL;\r\nunsigned long lpfn;\r\nint ret;\r\nlpfn = placement->lpfn;\r\nif (!lpfn)\r\nlpfn = man->size;\r\ndo {\r\nret = drm_mm_pre_get(mm);\r\nif (unlikely(ret))\r\nreturn ret;\r\nspin_lock(&rman->lock);\r\nnode = drm_mm_search_free_in_range(mm,\r\nmem->num_pages, mem->page_alignment,\r\nplacement->fpfn, lpfn, 1);\r\nif (unlikely(node == NULL)) {\r\nspin_unlock(&rman->lock);\r\nreturn 0;\r\n}\r\nnode = drm_mm_get_block_atomic_range(node, mem->num_pages,\r\nmem->page_alignment,\r\nplacement->fpfn,\r\nlpfn);\r\nspin_unlock(&rman->lock);\r\n} while (node == NULL);\r\nmem->mm_node = node;\r\nmem->start = node->start;\r\nreturn 0;\r\n}\r\nstatic void ttm_bo_man_put_node(struct ttm_mem_type_manager *man,\r\nstruct ttm_mem_reg *mem)\r\n{\r\nstruct ttm_range_manager *rman = (struct ttm_range_manager *) man->priv;\r\nif (mem->mm_node) {\r\nspin_lock(&rman->lock);\r\ndrm_mm_put_block(mem->mm_node);\r\nspin_unlock(&rman->lock);\r\nmem->mm_node = NULL;\r\n}\r\n}\r\nstatic int ttm_bo_man_init(struct ttm_mem_type_manager *man,\r\nunsigned long p_size)\r\n{\r\nstruct ttm_range_manager *rman;\r\nint ret;\r\nrman = kzalloc(sizeof(*rman), GFP_KERNEL);\r\nif (!rman)\r\nreturn -ENOMEM;\r\nret = drm_mm_init(&rman->mm, 0, p_size);\r\nif (ret) {\r\nkfree(rman);\r\nreturn ret;\r\n}\r\nspin_lock_init(&rman->lock);\r\nman->priv = rman;\r\nreturn 0;\r\n}\r\nstatic int ttm_bo_man_takedown(struct ttm_mem_type_manager *man)\r\n{\r\nstruct ttm_range_manager *rman = (struct ttm_range_manager *) man->priv;\r\nstruct drm_mm *mm = &rman->mm;\r\nspin_lock(&rman->lock);\r\nif (drm_mm_clean(mm)) {\r\ndrm_mm_takedown(mm);\r\nspin_unlock(&rman->lock);\r\nkfree(rman);\r\nman->priv = NULL;\r\nreturn 0;\r\n}\r\nspin_unlock(&rman->lock);\r\nreturn -EBUSY;\r\n}\r\nstatic void ttm_bo_man_debug(struct ttm_mem_type_manager *man,\r\nconst char *prefix)\r\n{\r\nstruct ttm_range_manager *rman = (struct ttm_range_manager *) man->priv;\r\nspin_lock(&rman->lock);\r\ndrm_mm_debug_table(&rman->mm, prefix);\r\nspin_unlock(&rman->lock);\r\n}

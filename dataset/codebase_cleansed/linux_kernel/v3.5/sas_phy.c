static void sas_phye_loss_of_signal(struct work_struct *work)\r\n{\r\nstruct asd_sas_event *ev = to_asd_sas_event(work);\r\nstruct asd_sas_phy *phy = ev->phy;\r\nclear_bit(PHYE_LOSS_OF_SIGNAL, &phy->phy_events_pending);\r\nphy->error = 0;\r\nsas_deform_port(phy, 1);\r\n}\r\nstatic void sas_phye_oob_done(struct work_struct *work)\r\n{\r\nstruct asd_sas_event *ev = to_asd_sas_event(work);\r\nstruct asd_sas_phy *phy = ev->phy;\r\nclear_bit(PHYE_OOB_DONE, &phy->phy_events_pending);\r\nphy->error = 0;\r\n}\r\nstatic void sas_phye_oob_error(struct work_struct *work)\r\n{\r\nstruct asd_sas_event *ev = to_asd_sas_event(work);\r\nstruct asd_sas_phy *phy = ev->phy;\r\nstruct sas_ha_struct *sas_ha = phy->ha;\r\nstruct asd_sas_port *port = phy->port;\r\nstruct sas_internal *i =\r\nto_sas_internal(sas_ha->core.shost->transportt);\r\nclear_bit(PHYE_OOB_ERROR, &phy->phy_events_pending);\r\nsas_deform_port(phy, 1);\r\nif (!port && phy->enabled && i->dft->lldd_control_phy) {\r\nphy->error++;\r\nswitch (phy->error) {\r\ncase 1:\r\ncase 2:\r\ni->dft->lldd_control_phy(phy, PHY_FUNC_HARD_RESET,\r\nNULL);\r\nbreak;\r\ncase 3:\r\ndefault:\r\nphy->error = 0;\r\nphy->enabled = 0;\r\ni->dft->lldd_control_phy(phy, PHY_FUNC_DISABLE, NULL);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void sas_phye_spinup_hold(struct work_struct *work)\r\n{\r\nstruct asd_sas_event *ev = to_asd_sas_event(work);\r\nstruct asd_sas_phy *phy = ev->phy;\r\nstruct sas_ha_struct *sas_ha = phy->ha;\r\nstruct sas_internal *i =\r\nto_sas_internal(sas_ha->core.shost->transportt);\r\nclear_bit(PHYE_SPINUP_HOLD, &phy->phy_events_pending);\r\nphy->error = 0;\r\ni->dft->lldd_control_phy(phy, PHY_FUNC_RELEASE_SPINUP_HOLD, NULL);\r\n}\r\nint sas_register_phys(struct sas_ha_struct *sas_ha)\r\n{\r\nint i;\r\nstatic const work_func_t sas_phy_event_fns[PHY_NUM_EVENTS] = {\r\n[PHYE_LOSS_OF_SIGNAL] = sas_phye_loss_of_signal,\r\n[PHYE_OOB_DONE] = sas_phye_oob_done,\r\n[PHYE_OOB_ERROR] = sas_phye_oob_error,\r\n[PHYE_SPINUP_HOLD] = sas_phye_spinup_hold,\r\n};\r\nstatic const work_func_t sas_port_event_fns[PORT_NUM_EVENTS] = {\r\n[PORTE_BYTES_DMAED] = sas_porte_bytes_dmaed,\r\n[PORTE_BROADCAST_RCVD] = sas_porte_broadcast_rcvd,\r\n[PORTE_LINK_RESET_ERR] = sas_porte_link_reset_err,\r\n[PORTE_TIMER_EVENT] = sas_porte_timer_event,\r\n[PORTE_HARD_RESET] = sas_porte_hard_reset,\r\n};\r\nfor (i = 0; i < sas_ha->num_phys; i++) {\r\nint k;\r\nstruct asd_sas_phy *phy = sas_ha->sas_phy[i];\r\nphy->error = 0;\r\nINIT_LIST_HEAD(&phy->port_phy_el);\r\nfor (k = 0; k < PORT_NUM_EVENTS; k++) {\r\nINIT_SAS_WORK(&phy->port_events[k].work, sas_port_event_fns[k]);\r\nphy->port_events[k].phy = phy;\r\n}\r\nfor (k = 0; k < PHY_NUM_EVENTS; k++) {\r\nINIT_SAS_WORK(&phy->phy_events[k].work, sas_phy_event_fns[k]);\r\nphy->phy_events[k].phy = phy;\r\n}\r\nphy->port = NULL;\r\nphy->ha = sas_ha;\r\nspin_lock_init(&phy->frame_rcvd_lock);\r\nspin_lock_init(&phy->sas_prim_lock);\r\nphy->frame_rcvd_size = 0;\r\nphy->phy = sas_phy_alloc(&sas_ha->core.shost->shost_gendev, i);\r\nif (!phy->phy)\r\nreturn -ENOMEM;\r\nphy->phy->identify.initiator_port_protocols =\r\nphy->iproto;\r\nphy->phy->identify.target_port_protocols = phy->tproto;\r\nphy->phy->identify.sas_address = SAS_ADDR(sas_ha->sas_addr);\r\nphy->phy->identify.phy_identifier = i;\r\nphy->phy->minimum_linkrate_hw = SAS_LINK_RATE_UNKNOWN;\r\nphy->phy->maximum_linkrate_hw = SAS_LINK_RATE_UNKNOWN;\r\nphy->phy->minimum_linkrate = SAS_LINK_RATE_UNKNOWN;\r\nphy->phy->maximum_linkrate = SAS_LINK_RATE_UNKNOWN;\r\nphy->phy->negotiated_linkrate = SAS_LINK_RATE_UNKNOWN;\r\nsas_phy_add(phy->phy);\r\n}\r\nreturn 0;\r\n}

static void write_grf5101(struct ieee80211_hw *dev, u8 addr, u32 data)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nu32 phy_config;\r\nphy_config = grf5101_encode[(data >> 8) & 0xF];\r\nphy_config |= grf5101_encode[(data >> 4) & 0xF] << 4;\r\nphy_config |= grf5101_encode[data & 0xF] << 8;\r\nphy_config |= grf5101_encode[(addr >> 1) & 0xF] << 12;\r\nphy_config |= (addr & 1) << 16;\r\nphy_config |= grf5101_encode[(data & 0xf000) >> 12] << 24;\r\nphy_config |= 0x90000000;\r\nrtl818x_iowrite32(priv,\r\n(__le32 __iomem *) &priv->map->RFPinsOutput, phy_config);\r\nmsleep(3);\r\n}\r\nstatic void grf5101_write_phy_antenna(struct ieee80211_hw *dev, short chan)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nu8 ant = GRF5101_ANTENNA;\r\nif (priv->rfparam & RF_PARAM_ANTBDEFAULT)\r\nant |= BB_ANTENNA_B;\r\nif (chan == 14)\r\nant |= BB_ANTATTEN_CHAN14;\r\nrtl8180_write_phy(dev, 0x10, ant);\r\n}\r\nstatic u8 grf5101_rf_calc_rssi(u8 agc, u8 sq)\r\n{\r\nif (agc > 60)\r\nreturn 65;\r\nreturn 65 * agc / 60;\r\n}\r\nstatic void grf5101_rf_set_channel(struct ieee80211_hw *dev,\r\nstruct ieee80211_conf *conf)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nint channel = ieee80211_frequency_to_channel(conf->channel->center_freq);\r\nu32 txpw = priv->channels[channel - 1].hw_value & 0xFF;\r\nu32 chan = channel - 1;\r\nwrite_grf5101(dev, 0x15, 0x0);\r\nwrite_grf5101(dev, 0x06, txpw);\r\nwrite_grf5101(dev, 0x15, 0x10);\r\nwrite_grf5101(dev, 0x15, 0x0);\r\nwrite_grf5101(dev, 0x07, 0x0);\r\nwrite_grf5101(dev, 0x0B, chan);\r\nwrite_grf5101(dev, 0x07, 0x1000);\r\ngrf5101_write_phy_antenna(dev, channel);\r\n}\r\nstatic void grf5101_rf_stop(struct ieee80211_hw *dev)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nu32 anaparam;\r\nanaparam = priv->anaparam;\r\nanaparam &= 0x000fffff;\r\nanaparam |= 0x3f900000;\r\nrtl8180_set_anaparam(priv, anaparam);\r\nwrite_grf5101(dev, 0x07, 0x0);\r\nwrite_grf5101(dev, 0x1f, 0x45);\r\nwrite_grf5101(dev, 0x1f, 0x5);\r\nwrite_grf5101(dev, 0x00, 0x8e4);\r\n}\r\nstatic void grf5101_rf_init(struct ieee80211_hw *dev)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nrtl8180_set_anaparam(priv, priv->anaparam);\r\nwrite_grf5101(dev, 0x1f, 0x0);\r\nwrite_grf5101(dev, 0x1f, 0x0);\r\nwrite_grf5101(dev, 0x1f, 0x40);\r\nwrite_grf5101(dev, 0x1f, 0x60);\r\nwrite_grf5101(dev, 0x1f, 0x61);\r\nwrite_grf5101(dev, 0x1f, 0x61);\r\nwrite_grf5101(dev, 0x00, 0xae4);\r\nwrite_grf5101(dev, 0x1f, 0x1);\r\nwrite_grf5101(dev, 0x1f, 0x41);\r\nwrite_grf5101(dev, 0x1f, 0x61);\r\nwrite_grf5101(dev, 0x01, 0x1a23);\r\nwrite_grf5101(dev, 0x02, 0x4971);\r\nwrite_grf5101(dev, 0x03, 0x41de);\r\nwrite_grf5101(dev, 0x04, 0x2d80);\r\nwrite_grf5101(dev, 0x05, 0x68ff);\r\nwrite_grf5101(dev, 0x06, 0x0);\r\nwrite_grf5101(dev, 0x07, 0x0);\r\nwrite_grf5101(dev, 0x08, 0x7533);\r\nwrite_grf5101(dev, 0x09, 0xc401);\r\nwrite_grf5101(dev, 0x0a, 0x0);\r\nwrite_grf5101(dev, 0x0c, 0x1c7);\r\nwrite_grf5101(dev, 0x0d, 0x29d3);\r\nwrite_grf5101(dev, 0x0e, 0x2e8);\r\nwrite_grf5101(dev, 0x10, 0x192);\r\nwrite_grf5101(dev, 0x11, 0x248);\r\nwrite_grf5101(dev, 0x12, 0x0);\r\nwrite_grf5101(dev, 0x13, 0x20c4);\r\nwrite_grf5101(dev, 0x14, 0xf4fc);\r\nwrite_grf5101(dev, 0x15, 0x0);\r\nwrite_grf5101(dev, 0x16, 0x1500);\r\nwrite_grf5101(dev, 0x07, 0x1000);\r\nrtl8180_write_phy(dev, 0, 0xa8);\r\nrtl8180_write_phy(dev, 3, 0x0);\r\nrtl8180_write_phy(dev, 4, 0xc0);\r\nrtl8180_write_phy(dev, 5, 0x90);\r\nrtl8180_write_phy(dev, 6, 0x1e);\r\nrtl8180_write_phy(dev, 7, 0x64);\r\ngrf5101_write_phy_antenna(dev, 1);\r\nrtl8180_write_phy(dev, 0x11, 0x88);\r\nif (rtl818x_ioread8(priv, &priv->map->CONFIG2) &\r\nRTL818X_CONFIG2_ANTENNA_DIV)\r\nrtl8180_write_phy(dev, 0x12, 0xc0);\r\nelse\r\nrtl8180_write_phy(dev, 0x12, 0x40);\r\nrtl8180_write_phy(dev, 0x13, 0x90 | priv->csthreshold);\r\nrtl8180_write_phy(dev, 0x19, 0x0);\r\nrtl8180_write_phy(dev, 0x1a, 0xa0);\r\nrtl8180_write_phy(dev, 0x1b, 0x44);\r\n}

static unsigned int extract_operand(unsigned char *code,\r\nconst struct operand *operand)\r\n{\r\nunsigned int val;\r\nint bits;\r\ncode += operand->shift / 8;\r\nbits = (operand->shift & 7) + operand->bits;\r\nval = 0;\r\ndo {\r\nval <<= 8;\r\nval |= (unsigned int) *code++;\r\nbits -= 8;\r\n} while (bits > 0);\r\nval >>= -bits;\r\nval &= ((1U << (operand->bits - 1)) << 1) - 1;\r\nif (operand->bits == 20 && operand->shift == 20)\r\nval = (val & 0xff) << 12 | (val & 0xfff00) >> 8;\r\nif ((operand->flags & (OPERAND_SIGNED | OPERAND_PCREL)) &&\r\n(val & (1U << (operand->bits - 1))))\r\nval |= (-1U << (operand->bits - 1)) << 1;\r\nif (operand->flags & OPERAND_PCREL)\r\nval <<= 1;\r\nif (operand->flags & OPERAND_LENGTH)\r\nval++;\r\nreturn val;\r\n}\r\nstatic inline int insn_length(unsigned char code)\r\n{\r\nreturn ((((int) code + 64) >> 7) + 1) << 1;\r\n}\r\nstatic struct insn *find_insn(unsigned char *code)\r\n{\r\nunsigned char opfrag = code[1];\r\nunsigned char opmask;\r\nstruct insn *table;\r\nswitch (code[0]) {\r\ncase 0x01:\r\ntable = opcode_01;\r\nbreak;\r\ncase 0xa5:\r\ntable = opcode_a5;\r\nbreak;\r\ncase 0xa7:\r\ntable = opcode_a7;\r\nbreak;\r\ncase 0xb2:\r\ntable = opcode_b2;\r\nbreak;\r\ncase 0xb3:\r\ntable = opcode_b3;\r\nbreak;\r\ncase 0xb9:\r\ntable = opcode_b9;\r\nbreak;\r\ncase 0xc0:\r\ntable = opcode_c0;\r\nbreak;\r\ncase 0xc2:\r\ntable = opcode_c2;\r\nbreak;\r\ncase 0xc4:\r\ntable = opcode_c4;\r\nbreak;\r\ncase 0xc6:\r\ntable = opcode_c6;\r\nbreak;\r\ncase 0xc8:\r\ntable = opcode_c8;\r\nbreak;\r\ncase 0xcc:\r\ntable = opcode_cc;\r\nbreak;\r\ncase 0xe3:\r\ntable = opcode_e3;\r\nopfrag = code[5];\r\nbreak;\r\ncase 0xe5:\r\ntable = opcode_e5;\r\nbreak;\r\ncase 0xeb:\r\ntable = opcode_eb;\r\nopfrag = code[5];\r\nbreak;\r\ncase 0xec:\r\ntable = opcode_ec;\r\nopfrag = code[5];\r\nbreak;\r\ncase 0xed:\r\ntable = opcode_ed;\r\nopfrag = code[5];\r\nbreak;\r\ndefault:\r\ntable = opcode;\r\nopfrag = code[0];\r\nbreak;\r\n}\r\nwhile (table->format != INSTR_INVALID) {\r\nopmask = formats[table->format][0];\r\nif (table->opfrag == (opfrag & opmask))\r\nreturn table;\r\ntable++;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int print_insn(char *buffer, unsigned char *code, unsigned long addr)\r\n{\r\nstruct insn *insn;\r\nconst unsigned char *ops;\r\nconst struct operand *operand;\r\nunsigned int value;\r\nchar separator;\r\nchar *ptr;\r\nint i;\r\nptr = buffer;\r\ninsn = find_insn(code);\r\nif (insn) {\r\nif (insn->name[0] == '\0')\r\nptr += sprintf(ptr, "%s\t",\r\nlong_insn_name[(int) insn->name[1]]);\r\nelse\r\nptr += sprintf(ptr, "%.5s\t", insn->name);\r\nseparator = 0;\r\nfor (ops = formats[insn->format] + 1, i = 0;\r\n*ops != 0 && i < 6; ops++, i++) {\r\noperand = operands + *ops;\r\nvalue = extract_operand(code, operand);\r\nif ((operand->flags & OPERAND_INDEX) && value == 0)\r\ncontinue;\r\nif ((operand->flags & OPERAND_BASE) &&\r\nvalue == 0 && separator == '(') {\r\nseparator = ',';\r\ncontinue;\r\n}\r\nif (separator)\r\nptr += sprintf(ptr, "%c", separator);\r\nif (operand->flags & OPERAND_GPR)\r\nptr += sprintf(ptr, "%%r%i", value);\r\nelse if (operand->flags & OPERAND_FPR)\r\nptr += sprintf(ptr, "%%f%i", value);\r\nelse if (operand->flags & OPERAND_AR)\r\nptr += sprintf(ptr, "%%a%i", value);\r\nelse if (operand->flags & OPERAND_CR)\r\nptr += sprintf(ptr, "%%c%i", value);\r\nelse if (operand->flags & OPERAND_PCREL)\r\nptr += sprintf(ptr, "%lx", (signed int) value\r\n+ addr);\r\nelse if (operand->flags & OPERAND_SIGNED)\r\nptr += sprintf(ptr, "%i", value);\r\nelse\r\nptr += sprintf(ptr, "%u", value);\r\nif (operand->flags & OPERAND_DISP)\r\nseparator = '(';\r\nelse if (operand->flags & OPERAND_BASE) {\r\nptr += sprintf(ptr, ")");\r\nseparator = ',';\r\n} else\r\nseparator = ',';\r\n}\r\n} else\r\nptr += sprintf(ptr, "unknown");\r\nreturn (int) (ptr - buffer);\r\n}\r\nvoid show_code(struct pt_regs *regs)\r\n{\r\nchar *mode = (regs->psw.mask & PSW_MASK_PSTATE) ? "User" : "Krnl";\r\nunsigned char code[64];\r\nchar buffer[64], *ptr;\r\nmm_segment_t old_fs;\r\nunsigned long addr;\r\nint start, end, opsize, hops, i;\r\nold_fs = get_fs();\r\nset_fs((regs->psw.mask & PSW_MASK_PSTATE) ? USER_DS : KERNEL_DS);\r\nfor (start = 32; start && regs->psw.addr >= 34 - start; start -= 2) {\r\naddr = regs->psw.addr - 34 + start;\r\nif (__copy_from_user(code + start - 2,\r\n(char __user *) addr, 2))\r\nbreak;\r\n}\r\nfor (end = 32; end < 64; end += 2) {\r\naddr = regs->psw.addr + end - 32;\r\nif (__copy_from_user(code + end,\r\n(char __user *) addr, 2))\r\nbreak;\r\n}\r\nset_fs(old_fs);\r\nif ((regs->psw.addr & 1) || start >= end) {\r\nprintk("%s Code: Bad PSW.\n", mode);\r\nreturn;\r\n}\r\nwhile (start < 32) {\r\nfor (i = 0, hops = 0; start + i < 32 && hops < 3; hops++) {\r\nif (!find_insn(code + start + i))\r\nbreak;\r\ni += insn_length(code[start + i]);\r\n}\r\nif (start + i == 32)\r\nbreak;\r\nstart += 2;\r\n}\r\nptr = buffer;\r\nptr += sprintf(ptr, "%s Code:", mode);\r\nhops = 0;\r\nwhile (start < end && hops < 8) {\r\nopsize = insn_length(code[start]);\r\nif (start + opsize == 32)\r\n*ptr++ = '#';\r\nelse if (start == 32)\r\n*ptr++ = '>';\r\nelse\r\n*ptr++ = ' ';\r\naddr = regs->psw.addr + start - 32;\r\nptr += sprintf(ptr, ONELONG, addr);\r\nif (start + opsize >= end)\r\nbreak;\r\nfor (i = 0; i < opsize; i++)\r\nptr += sprintf(ptr, "%02x", code[start + i]);\r\n*ptr++ = '\t';\r\nif (i < 6)\r\n*ptr++ = '\t';\r\nptr += print_insn(ptr, code + start, addr);\r\nstart += opsize;\r\nprintk(buffer);\r\nptr = buffer;\r\nptr += sprintf(ptr, "\n ");\r\nhops++;\r\n}\r\nprintk("\n");\r\n}

static void __init sni_pcit_resource_init(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(pcit_io_resources); i++)\r\nrequest_resource(&sni_io_resource, pcit_io_resources + i);\r\n}\r\nstatic void enable_pcit_irq(struct irq_data *d)\r\n{\r\nu32 mask = 1 << (d->irq - SNI_PCIT_INT_START + 24);\r\n*(volatile u32 *)SNI_PCIT_INT_REG |= mask;\r\n}\r\nvoid disable_pcit_irq(struct irq_data *d)\r\n{\r\nu32 mask = 1 << (d->irq - SNI_PCIT_INT_START + 24);\r\n*(volatile u32 *)SNI_PCIT_INT_REG &= ~mask;\r\n}\r\nstatic void pcit_hwint1(void)\r\n{\r\nu32 pending = *(volatile u32 *)SNI_PCIT_INT_REG;\r\nint irq;\r\nclear_c0_status(IE_IRQ1);\r\nirq = ffs((pending >> 16) & 0x7f);\r\nif (likely(irq > 0))\r\ndo_IRQ(irq + SNI_PCIT_INT_START - 1);\r\nset_c0_status(IE_IRQ1);\r\n}\r\nstatic void pcit_hwint0(void)\r\n{\r\nu32 pending = *(volatile u32 *)SNI_PCIT_INT_REG;\r\nint irq;\r\nclear_c0_status(IE_IRQ0);\r\nirq = ffs((pending >> 16) & 0x3f);\r\nif (likely(irq > 0))\r\ndo_IRQ(irq + SNI_PCIT_INT_START - 1);\r\nset_c0_status(IE_IRQ0);\r\n}\r\nstatic void sni_pcit_hwint(void)\r\n{\r\nu32 pending = read_c0_cause() & read_c0_status();\r\nif (pending & C_IRQ1)\r\npcit_hwint1();\r\nelse if (pending & C_IRQ2)\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + 4);\r\nelse if (pending & C_IRQ3)\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + 5);\r\nelse if (pending & C_IRQ5)\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + 7);\r\n}\r\nstatic void sni_pcit_hwint_cplus(void)\r\n{\r\nu32 pending = read_c0_cause() & read_c0_status();\r\nif (pending & C_IRQ0)\r\npcit_hwint0();\r\nelse if (pending & C_IRQ1)\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + 3);\r\nelse if (pending & C_IRQ2)\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + 4);\r\nelse if (pending & C_IRQ3)\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + 5);\r\nelse if (pending & C_IRQ5)\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + 7);\r\n}\r\nvoid __init sni_pcit_irq_init(void)\r\n{\r\nint i;\r\nmips_cpu_irq_init();\r\nfor (i = SNI_PCIT_INT_START; i <= SNI_PCIT_INT_END; i++)\r\nirq_set_chip_and_handler(i, &pcit_irq_type, handle_level_irq);\r\n*(volatile u32 *)SNI_PCIT_INT_REG = 0;\r\nsni_hwint = sni_pcit_hwint;\r\nchange_c0_status(ST0_IM, IE_IRQ1);\r\nsetup_irq(SNI_PCIT_INT_START + 6, &sni_isa_irq);\r\n}\r\nvoid __init sni_pcit_cplus_irq_init(void)\r\n{\r\nint i;\r\nmips_cpu_irq_init();\r\nfor (i = SNI_PCIT_INT_START; i <= SNI_PCIT_INT_END; i++)\r\nirq_set_chip_and_handler(i, &pcit_irq_type, handle_level_irq);\r\n*(volatile u32 *)SNI_PCIT_INT_REG = 0x40000000;\r\nsni_hwint = sni_pcit_hwint_cplus;\r\nchange_c0_status(ST0_IM, IE_IRQ0);\r\nsetup_irq(MIPS_CPU_IRQ_BASE + 3, &sni_isa_irq);\r\n}\r\nvoid __init sni_pcit_init(void)\r\n{\r\nioport_resource.end = sni_io_resource.end;\r\n#ifdef CONFIG_PCI\r\nPCIBIOS_MIN_IO = 0x9000;\r\nregister_pci_controller(&sni_pcit_controller);\r\n#endif\r\nsni_pcit_resource_init();\r\n}\r\nstatic int __init snirm_pcit_setup_devinit(void)\r\n{\r\nswitch (sni_brd_type) {\r\ncase SNI_BRD_PCI_TOWER:\r\nplatform_device_register(&pcit_serial8250_device);\r\nplatform_device_register(&pcit_cmos_device);\r\nplatform_device_register(&pcit_pcspeaker_pdev);\r\nbreak;\r\ncase SNI_BRD_PCI_TOWER_CPLUS:\r\nplatform_device_register(&pcit_cplus_serial8250_device);\r\nplatform_device_register(&pcit_cmos_device);\r\nplatform_device_register(&pcit_pcspeaker_pdev);\r\nbreak;\r\n}\r\nreturn 0;\r\n}

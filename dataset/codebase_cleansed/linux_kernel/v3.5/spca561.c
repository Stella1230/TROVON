static void reg_w_val(struct usb_device *dev, __u16 index, __u8 value)\r\n{\r\nint ret;\r\nret = usb_control_msg(dev, usb_sndctrlpipe(dev, 0),\r\n0,\r\nUSB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\nvalue, index, NULL, 0, 500);\r\nPDEBUG(D_USBO, "reg write: 0x%02x:0x%02x", index, value);\r\nif (ret < 0)\r\npr_err("reg write: error %d\n", ret);\r\n}\r\nstatic void write_vector(struct gspca_dev *gspca_dev,\r\nconst __u16 data[][2])\r\n{\r\nstruct usb_device *dev = gspca_dev->dev;\r\nint i;\r\ni = 0;\r\nwhile (data[i][1] != 0) {\r\nreg_w_val(dev, data[i][1], data[i][0]);\r\ni++;\r\n}\r\n}\r\nstatic void reg_r(struct gspca_dev *gspca_dev,\r\n__u16 index, __u16 length)\r\n{\r\nusb_control_msg(gspca_dev->dev,\r\nusb_rcvctrlpipe(gspca_dev->dev, 0),\r\n0,\r\nUSB_DIR_IN | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\n0,\r\nindex, gspca_dev->usb_buf, length, 500);\r\n}\r\nstatic void reg_w_buf(struct gspca_dev *gspca_dev,\r\n__u16 index, __u16 len)\r\n{\r\nusb_control_msg(gspca_dev->dev,\r\nusb_sndctrlpipe(gspca_dev->dev, 0),\r\n0,\r\nUSB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\n0,\r\nindex, gspca_dev->usb_buf, len, 500);\r\n}\r\nstatic void i2c_write(struct gspca_dev *gspca_dev, __u16 value, __u16 reg)\r\n{\r\nint retry = 60;\r\nreg_w_val(gspca_dev->dev, 0x8801, reg);\r\nreg_w_val(gspca_dev->dev, 0x8805, value);\r\nreg_w_val(gspca_dev->dev, 0x8800, value >> 8);\r\ndo {\r\nreg_r(gspca_dev, 0x8803, 1);\r\nif (!gspca_dev->usb_buf[0])\r\nreturn;\r\nmsleep(10);\r\n} while (--retry);\r\n}\r\nstatic int i2c_read(struct gspca_dev *gspca_dev, __u16 reg, __u8 mode)\r\n{\r\nint retry = 60;\r\n__u8 value;\r\nreg_w_val(gspca_dev->dev, 0x8804, 0x92);\r\nreg_w_val(gspca_dev->dev, 0x8801, reg);\r\nreg_w_val(gspca_dev->dev, 0x8802, mode | 0x01);\r\ndo {\r\nreg_r(gspca_dev, 0x8803, 1);\r\nif (!gspca_dev->usb_buf[0]) {\r\nreg_r(gspca_dev, 0x8800, 1);\r\nvalue = gspca_dev->usb_buf[0];\r\nreg_r(gspca_dev, 0x8805, 1);\r\nreturn ((int) value << 8) | gspca_dev->usb_buf[0];\r\n}\r\nmsleep(10);\r\n} while (--retry);\r\nreturn -1;\r\n}\r\nstatic void init_161rev12A(struct gspca_dev *gspca_dev)\r\n{\r\nwrite_vector(gspca_dev, spca561_161rev12A_data1);\r\nsensor_mapwrite(gspca_dev, Pb100_1map8300);\r\nwrite_vector(gspca_dev, spca561_161rev12A_data2);\r\nsensor_mapwrite(gspca_dev, Pb100_2map8300);\r\n}\r\nstatic int sd_config(struct gspca_dev *gspca_dev,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nstruct cam *cam;\r\n__u16 vendor, product;\r\n__u8 data1, data2;\r\nreg_r(gspca_dev, 0x8104, 1);\r\ndata1 = gspca_dev->usb_buf[0];\r\nreg_r(gspca_dev, 0x8105, 1);\r\ndata2 = gspca_dev->usb_buf[0];\r\nvendor = (data2 << 8) | data1;\r\nreg_r(gspca_dev, 0x8106, 1);\r\ndata1 = gspca_dev->usb_buf[0];\r\nreg_r(gspca_dev, 0x8107, 1);\r\ndata2 = gspca_dev->usb_buf[0];\r\nproduct = (data2 << 8) | data1;\r\nif (vendor != id->idVendor || product != id->idProduct) {\r\nPDEBUG(D_PROBE, "Bad vendor / product from device");\r\nreturn -EINVAL;\r\n}\r\ncam = &gspca_dev->cam;\r\ncam->needs_full_bandwidth = 1;\r\nsd->chip_revision = id->driver_info;\r\nif (sd->chip_revision == Rev012A) {\r\ncam->cam_mode = sif_012a_mode;\r\ncam->nmodes = ARRAY_SIZE(sif_012a_mode);\r\n} else {\r\ncam->cam_mode = sif_072a_mode;\r\ncam->nmodes = ARRAY_SIZE(sif_072a_mode);\r\n}\r\nsd->brightness = BRIGHTNESS_DEF;\r\nsd->contrast = CONTRAST_DEF;\r\nsd->white = HUE_DEF;\r\nsd->exposure = EXPOSURE_DEF;\r\nsd->autogain = AUTOGAIN_DEF;\r\nsd->gain = GAIN_DEF;\r\nsd->expo12a = EXPO12A_DEF;\r\nreturn 0;\r\n}\r\nstatic int sd_init_12a(struct gspca_dev *gspca_dev)\r\n{\r\nPDEBUG(D_STREAM, "Chip revision: 012a");\r\ninit_161rev12A(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_init_72a(struct gspca_dev *gspca_dev)\r\n{\r\nPDEBUG(D_STREAM, "Chip revision: 072a");\r\nwrite_vector(gspca_dev, rev72a_reset);\r\nmsleep(200);\r\nwrite_vector(gspca_dev, rev72a_init_data1);\r\nwrite_sensor_72a(gspca_dev, rev72a_init_sensor1);\r\nwrite_vector(gspca_dev, rev72a_init_data2);\r\nwrite_sensor_72a(gspca_dev, rev72a_init_sensor2);\r\nreg_w_val(gspca_dev->dev, 0x8112, 0x30);\r\nreturn 0;\r\n}\r\nstatic void setbrightness(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nstruct usb_device *dev = gspca_dev->dev;\r\n__u8 value;\r\nvalue = sd->brightness;\r\nreg_w_val(dev, 0x8611, value);\r\nreg_w_val(dev, 0x8612, value);\r\nreg_w_val(dev, 0x8613, value);\r\nreg_w_val(dev, 0x8614, value);\r\n}\r\nstatic void setwhite(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n__u16 white;\r\n__u8 blue, red;\r\n__u16 reg;\r\nwhite = sd->white;\r\nred = 0x20 + white * 3 / 8;\r\nblue = 0x90 - white * 5 / 8;\r\nif (sd->chip_revision == Rev012A) {\r\nreg = 0x8614;\r\n} else {\r\nreg = 0x8651;\r\nred += sd->contrast - 0x20;\r\nblue += sd->contrast - 0x20;\r\n}\r\nreg_w_val(gspca_dev->dev, reg, red);\r\nreg_w_val(gspca_dev->dev, reg + 2, blue);\r\n}\r\nstatic void setcontrast(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nstruct usb_device *dev = gspca_dev->dev;\r\n__u8 value;\r\nif (sd->chip_revision != Rev072A)\r\nreturn;\r\nvalue = sd->contrast + 0x20;\r\nsetwhite(gspca_dev);\r\nreg_w_val(dev, 0x8652, value);\r\nreg_w_val(dev, 0x8654, value);\r\n}\r\nstatic void setexposure(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nint i, expo = 0;\r\nint table[] = { 0, 450, 550, 625, EXPOSURE_MAX };\r\nfor (i = 0; i < ARRAY_SIZE(table) - 1; i++) {\r\nif (sd->exposure <= table[i + 1]) {\r\nexpo = sd->exposure - table[i];\r\nif (i)\r\nexpo += 300;\r\nexpo |= i << 11;\r\nbreak;\r\n}\r\n}\r\ngspca_dev->usb_buf[0] = expo;\r\ngspca_dev->usb_buf[1] = expo >> 8;\r\nreg_w_buf(gspca_dev, 0x8309, 2);\r\n}\r\nstatic void setgain(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nif (sd->gain < 64)\r\ngspca_dev->usb_buf[0] = sd->gain;\r\nelse if (sd->gain < 128)\r\ngspca_dev->usb_buf[0] = (sd->gain / 2) | 0x40;\r\nelse\r\ngspca_dev->usb_buf[0] = (sd->gain / 4) | 0xc0;\r\ngspca_dev->usb_buf[1] = 0;\r\nreg_w_buf(gspca_dev, 0x8335, 2);\r\n}\r\nstatic void setautogain(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nif (sd->autogain)\r\nsd->ag_cnt = AG_CNT_START;\r\nelse\r\nsd->ag_cnt = -1;\r\n}\r\nstatic int sd_start_12a(struct gspca_dev *gspca_dev)\r\n{\r\nstruct usb_device *dev = gspca_dev->dev;\r\nint mode;\r\nstatic const __u8 Reg8391[8] =\r\n{0x92, 0x30, 0x20, 0x00, 0x0c, 0x00, 0x00, 0x00};\r\nmode = gspca_dev->cam.cam_mode[(int) gspca_dev->curr_mode].priv;\r\nif (mode <= 1) {\r\nreg_w_val(dev, 0x8500, 0x10 | mode);\r\n} else {\r\nreg_w_val(dev, 0x8500, mode);\r\n}\r\ngspca_dev->usb_buf[0] = 0xaa;\r\ngspca_dev->usb_buf[1] = 0x00;\r\nreg_w_buf(gspca_dev, 0x8307, 2);\r\nreg_w_val(gspca_dev->dev, 0x8700, 0x8a);\r\nreg_w_val(gspca_dev->dev, 0x8112, 0x1e | 0x20);\r\nreg_w_val(gspca_dev->dev, 0x850b, 0x03);\r\nmemcpy(gspca_dev->usb_buf, Reg8391, 8);\r\nreg_w_buf(gspca_dev, 0x8391, 8);\r\nreg_w_buf(gspca_dev, 0x8390, 8);\r\nsetwhite(gspca_dev);\r\nsetgain(gspca_dev);\r\nsetexposure(gspca_dev);\r\nreg_w_val(gspca_dev->dev, 0x8114, 0x00);\r\nreturn 0;\r\n}\r\nstatic int sd_start_72a(struct gspca_dev *gspca_dev)\r\n{\r\nstruct usb_device *dev = gspca_dev->dev;\r\nint Clck;\r\nint mode;\r\nwrite_vector(gspca_dev, rev72a_reset);\r\nmsleep(200);\r\nwrite_vector(gspca_dev, rev72a_init_data1);\r\nwrite_sensor_72a(gspca_dev, rev72a_init_sensor1);\r\nmode = gspca_dev->cam.cam_mode[(int) gspca_dev->curr_mode].priv;\r\nswitch (mode) {\r\ndefault:\r\ncase 0:\r\nClck = 0x27;\r\nbreak;\r\ncase 1:\r\nClck = 0x25;\r\nbreak;\r\ncase 2:\r\nClck = 0x22;\r\nbreak;\r\ncase 3:\r\nClck = 0x21;\r\nbreak;\r\n}\r\nreg_w_val(dev, 0x8700, Clck);\r\nreg_w_val(dev, 0x8702, 0x81);\r\nreg_w_val(dev, 0x8500, mode);\r\nwrite_sensor_72a(gspca_dev, rev72a_init_sensor2);\r\nsetcontrast(gspca_dev);\r\nsetautogain(gspca_dev);\r\nreg_w_val(dev, 0x8112, 0x10 | 0x20);\r\nreturn 0;\r\n}\r\nstatic void sd_stopN(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nif (sd->chip_revision == Rev012A) {\r\nreg_w_val(gspca_dev->dev, 0x8112, 0x0e);\r\nreg_w_val(gspca_dev->dev, 0x8114, 0x08);\r\n} else {\r\nreg_w_val(gspca_dev->dev, 0x8112, 0x20);\r\n}\r\n}\r\nstatic void do_autogain(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nint expotimes;\r\nint pixelclk;\r\nint gainG;\r\n__u8 R, Gr, Gb, B;\r\nint y;\r\n__u8 luma_mean = 110;\r\n__u8 luma_delta = 20;\r\n__u8 spring = 4;\r\nif (sd->ag_cnt < 0)\r\nreturn;\r\nif (--sd->ag_cnt >= 0)\r\nreturn;\r\nsd->ag_cnt = AG_CNT_START;\r\nswitch (sd->chip_revision) {\r\ncase Rev072A:\r\nreg_r(gspca_dev, 0x8621, 1);\r\nGr = gspca_dev->usb_buf[0];\r\nreg_r(gspca_dev, 0x8622, 1);\r\nR = gspca_dev->usb_buf[0];\r\nreg_r(gspca_dev, 0x8623, 1);\r\nB = gspca_dev->usb_buf[0];\r\nreg_r(gspca_dev, 0x8624, 1);\r\nGb = gspca_dev->usb_buf[0];\r\ny = (77 * R + 75 * (Gr + Gb) + 29 * B) >> 8;\r\nif (y < luma_mean - luma_delta ||\r\ny > luma_mean + luma_delta) {\r\nexpotimes = i2c_read(gspca_dev, 0x09, 0x10);\r\npixelclk = 0x0800;\r\nexpotimes = expotimes & 0x07ff;\r\ngainG = i2c_read(gspca_dev, 0x35, 0x10);\r\nexpotimes += (luma_mean - y) >> spring;\r\ngainG += (luma_mean - y) / 50;\r\nif (gainG > 0x3f)\r\ngainG = 0x3f;\r\nelse if (gainG < 3)\r\ngainG = 3;\r\ni2c_write(gspca_dev, gainG, 0x35);\r\nif (expotimes > 0x0256)\r\nexpotimes = 0x0256;\r\nelse if (expotimes < 3)\r\nexpotimes = 3;\r\ni2c_write(gspca_dev, expotimes | pixelclk, 0x09);\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic void sd_pkt_scan(struct gspca_dev *gspca_dev,\r\nu8 *data,\r\nint len)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nlen--;\r\nswitch (*data++) {\r\ncase 0:\r\ngspca_frame_add(gspca_dev, LAST_PACKET, NULL, 0);\r\nif (len < 2) {\r\nPDEBUG(D_ERR, "Short SOF packet, ignoring");\r\ngspca_dev->last_packet_type = DISCARD_PACKET;\r\nreturn;\r\n}\r\n#if defined(CONFIG_INPUT) || defined(CONFIG_INPUT_MODULE)\r\nif (data[0] & 0x20) {\r\ninput_report_key(gspca_dev->input_dev, KEY_CAMERA, 1);\r\ninput_sync(gspca_dev->input_dev);\r\ninput_report_key(gspca_dev->input_dev, KEY_CAMERA, 0);\r\ninput_sync(gspca_dev->input_dev);\r\n}\r\n#endif\r\nif (data[1] & 0x10) {\r\ngspca_frame_add(gspca_dev, FIRST_PACKET, data, len);\r\n} else {\r\nif (sd->chip_revision == Rev012A) {\r\ndata += 20;\r\nlen -= 20;\r\n} else {\r\ndata += 16;\r\nlen -= 16;\r\n}\r\ngspca_frame_add(gspca_dev, FIRST_PACKET, data, len);\r\n}\r\nreturn;\r\ncase 0xff:\r\nreturn;\r\n}\r\ngspca_frame_add(gspca_dev, INTER_PACKET, data, len);\r\n}\r\nstatic int sd_setbrightness(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->brightness = val;\r\nif (gspca_dev->streaming)\r\nsetbrightness(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_getbrightness(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*val = sd->brightness;\r\nreturn 0;\r\n}\r\nstatic int sd_setcontrast(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->contrast = val;\r\nif (gspca_dev->streaming)\r\nsetcontrast(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_getcontrast(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*val = sd->contrast;\r\nreturn 0;\r\n}\r\nstatic int sd_setautogain(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->autogain = val;\r\nif (gspca_dev->streaming)\r\nsetautogain(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_getautogain(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*val = sd->autogain;\r\nreturn 0;\r\n}\r\nstatic int sd_setwhite(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->white = val;\r\nif (gspca_dev->streaming)\r\nsetwhite(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_getwhite(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*val = sd->white;\r\nreturn 0;\r\n}\r\nstatic int sd_setexposure(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->exposure = val;\r\nif (gspca_dev->streaming)\r\nsetexposure(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_getexposure(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*val = sd->exposure;\r\nreturn 0;\r\n}\r\nstatic int sd_setgain(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->gain = val;\r\nif (gspca_dev->streaming)\r\nsetgain(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_getgain(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*val = sd->gain;\r\nreturn 0;\r\n}\r\nstatic int sd_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nreturn gspca_dev_probe(intf, id,\r\nsd_desc[id->driver_info],\r\nsizeof(struct sd),\r\nTHIS_MODULE);\r\n}

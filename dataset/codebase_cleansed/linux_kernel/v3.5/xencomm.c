static int xencomm_init(struct xencomm_desc *desc,\r\nvoid *buffer, unsigned long bytes)\r\n{\r\nunsigned long recorded = 0;\r\nint i = 0;\r\nwhile ((recorded < bytes) && (i < desc->nr_addrs)) {\r\nunsigned long vaddr = (unsigned long)buffer + recorded;\r\nunsigned long paddr;\r\nint offset;\r\nint chunksz;\r\noffset = vaddr % PAGE_SIZE;\r\nchunksz = min(PAGE_SIZE - offset, bytes - recorded);\r\npaddr = xencomm_vtop(vaddr);\r\nif (paddr == ~0UL) {\r\nprintk(KERN_DEBUG "%s: couldn't translate vaddr %lx\n",\r\n__func__, vaddr);\r\nreturn -EINVAL;\r\n}\r\ndesc->address[i++] = paddr;\r\nrecorded += chunksz;\r\n}\r\nif (recorded < bytes) {\r\nprintk(KERN_DEBUG\r\n"%s: could only translate %ld of %ld bytes\n",\r\n__func__, recorded, bytes);\r\nreturn -ENOSPC;\r\n}\r\nwhile (i < desc->nr_addrs)\r\ndesc->address[i++] = XENCOMM_INVALID;\r\ndesc->magic = XENCOMM_MAGIC;\r\nreturn 0;\r\n}\r\nstatic struct xencomm_desc *xencomm_alloc(gfp_t gfp_mask,\r\nvoid *buffer, unsigned long bytes)\r\n{\r\nstruct xencomm_desc *desc;\r\nunsigned long buffer_ulong = (unsigned long)buffer;\r\nunsigned long start = buffer_ulong & PAGE_MASK;\r\nunsigned long end = (buffer_ulong + bytes) | ~PAGE_MASK;\r\nunsigned long nr_addrs = (end - start + 1) >> PAGE_SHIFT;\r\nunsigned long size = sizeof(*desc) +\r\nsizeof(desc->address[0]) * nr_addrs;\r\nif (sizeof(*desc) > sizeof(void *)) {\r\nunsigned long order = get_order(size);\r\ndesc = (struct xencomm_desc *)__get_free_pages(gfp_mask,\r\norder);\r\nif (desc == NULL)\r\nreturn NULL;\r\ndesc->nr_addrs =\r\n((PAGE_SIZE << order) - sizeof(struct xencomm_desc)) /\r\nsizeof(*desc->address);\r\n} else {\r\ndesc = kmalloc(size, gfp_mask);\r\nif (desc == NULL)\r\nreturn NULL;\r\ndesc->nr_addrs = nr_addrs;\r\n}\r\nreturn desc;\r\n}\r\nvoid xencomm_free(struct xencomm_handle *desc)\r\n{\r\nif (desc && !((ulong)desc & XENCOMM_INLINE_FLAG)) {\r\nstruct xencomm_desc *desc__ = (struct xencomm_desc *)desc;\r\nif (sizeof(*desc__) > sizeof(void *)) {\r\nunsigned long size = sizeof(*desc__) +\r\nsizeof(desc__->address[0]) * desc__->nr_addrs;\r\nunsigned long order = get_order(size);\r\nfree_pages((unsigned long)__va(desc), order);\r\n} else\r\nkfree(__va(desc));\r\n}\r\n}\r\nstatic int xencomm_create(void *buffer, unsigned long bytes,\r\nstruct xencomm_desc **ret, gfp_t gfp_mask)\r\n{\r\nstruct xencomm_desc *desc;\r\nint rc;\r\npr_debug("%s: %p[%ld]\n", __func__, buffer, bytes);\r\nif (bytes == 0) {\r\nBUG_ON(buffer != NULL);\r\n*ret = NULL;\r\nreturn 0;\r\n}\r\nBUG_ON(buffer == NULL);\r\ndesc = xencomm_alloc(gfp_mask, buffer, bytes);\r\nif (!desc) {\r\nprintk(KERN_DEBUG "%s failure\n", "xencomm_alloc");\r\nreturn -ENOMEM;\r\n}\r\nrc = xencomm_init(desc, buffer, bytes);\r\nif (rc) {\r\nprintk(KERN_DEBUG "%s failure: %d\n", "xencomm_init", rc);\r\nxencomm_free((struct xencomm_handle *)__pa(desc));\r\nreturn rc;\r\n}\r\n*ret = desc;\r\nreturn 0;\r\n}\r\nstatic struct xencomm_handle *xencomm_create_inline(void *ptr)\r\n{\r\nunsigned long paddr;\r\nBUG_ON(!xencomm_is_phys_contiguous((unsigned long)ptr));\r\npaddr = (unsigned long)xencomm_pa(ptr);\r\nBUG_ON(paddr & XENCOMM_INLINE_FLAG);\r\nreturn (struct xencomm_handle *)(paddr | XENCOMM_INLINE_FLAG);\r\n}\r\nstatic int xencomm_create_mini(void *buffer,\r\nunsigned long bytes, struct xencomm_mini *xc_desc,\r\nstruct xencomm_desc **ret)\r\n{\r\nint rc = 0;\r\nstruct xencomm_desc *desc;\r\nBUG_ON(((unsigned long)xc_desc) % sizeof(*xc_desc) != 0);\r\ndesc = (void *)xc_desc;\r\ndesc->nr_addrs = XENCOMM_MINI_ADDRS;\r\nrc = xencomm_init(desc, buffer, bytes);\r\nif (!rc)\r\n*ret = desc;\r\nreturn rc;\r\n}\r\nstruct xencomm_handle *xencomm_map(void *ptr, unsigned long bytes)\r\n{\r\nint rc;\r\nstruct xencomm_desc *desc;\r\nif (xencomm_is_phys_contiguous((unsigned long)ptr))\r\nreturn xencomm_create_inline(ptr);\r\nrc = xencomm_create(ptr, bytes, &desc, GFP_KERNEL);\r\nif (rc || desc == NULL)\r\nreturn NULL;\r\nreturn xencomm_pa(desc);\r\n}\r\nstruct xencomm_handle *__xencomm_map_no_alloc(void *ptr, unsigned long bytes,\r\nstruct xencomm_mini *xc_desc)\r\n{\r\nint rc;\r\nstruct xencomm_desc *desc = NULL;\r\nif (xencomm_is_phys_contiguous((unsigned long)ptr))\r\nreturn xencomm_create_inline(ptr);\r\nrc = xencomm_create_mini(ptr, bytes, xc_desc,\r\n&desc);\r\nif (rc)\r\nreturn NULL;\r\nreturn xencomm_pa(desc);\r\n}

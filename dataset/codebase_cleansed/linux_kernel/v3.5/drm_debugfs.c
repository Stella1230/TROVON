static int drm_debugfs_open(struct inode *inode, struct file *file)\r\n{\r\nstruct drm_info_node *node = inode->i_private;\r\nreturn single_open(file, node->info_ent->show, node);\r\n}\r\nint drm_debugfs_create_files(struct drm_info_list *files, int count,\r\nstruct dentry *root, struct drm_minor *minor)\r\n{\r\nstruct drm_device *dev = minor->dev;\r\nstruct dentry *ent;\r\nstruct drm_info_node *tmp;\r\nint i, ret;\r\nfor (i = 0; i < count; i++) {\r\nu32 features = files[i].driver_features;\r\nif (features != 0 &&\r\n(dev->driver->driver_features & features) != features)\r\ncontinue;\r\ntmp = kmalloc(sizeof(struct drm_info_node), GFP_KERNEL);\r\nif (tmp == NULL) {\r\nret = -1;\r\ngoto fail;\r\n}\r\nent = debugfs_create_file(files[i].name, S_IFREG | S_IRUGO,\r\nroot, tmp, &drm_debugfs_fops);\r\nif (!ent) {\r\nDRM_ERROR("Cannot create /sys/kernel/debug/dri/%s/%s\n",\r\nroot->d_name.name, files[i].name);\r\nkfree(tmp);\r\nret = -1;\r\ngoto fail;\r\n}\r\ntmp->minor = minor;\r\ntmp->dent = ent;\r\ntmp->info_ent = &files[i];\r\nmutex_lock(&minor->debugfs_lock);\r\nlist_add(&tmp->list, &minor->debugfs_list);\r\nmutex_unlock(&minor->debugfs_lock);\r\n}\r\nreturn 0;\r\nfail:\r\ndrm_debugfs_remove_files(files, count, minor);\r\nreturn ret;\r\n}\r\nint drm_debugfs_init(struct drm_minor *minor, int minor_id,\r\nstruct dentry *root)\r\n{\r\nstruct drm_device *dev = minor->dev;\r\nchar name[64];\r\nint ret;\r\nINIT_LIST_HEAD(&minor->debugfs_list);\r\nmutex_init(&minor->debugfs_lock);\r\nsprintf(name, "%d", minor_id);\r\nminor->debugfs_root = debugfs_create_dir(name, root);\r\nif (!minor->debugfs_root) {\r\nDRM_ERROR("Cannot create /sys/kernel/debug/dri/%s\n", name);\r\nreturn -1;\r\n}\r\nret = drm_debugfs_create_files(drm_debugfs_list, DRM_DEBUGFS_ENTRIES,\r\nminor->debugfs_root, minor);\r\nif (ret) {\r\ndebugfs_remove(minor->debugfs_root);\r\nminor->debugfs_root = NULL;\r\nDRM_ERROR("Failed to create core drm debugfs files\n");\r\nreturn ret;\r\n}\r\nif (dev->driver->debugfs_init) {\r\nret = dev->driver->debugfs_init(minor);\r\nif (ret) {\r\nDRM_ERROR("DRM: Driver failed to initialize "\r\n"/sys/kernel/debug/dri.\n");\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint drm_debugfs_remove_files(struct drm_info_list *files, int count,\r\nstruct drm_minor *minor)\r\n{\r\nstruct list_head *pos, *q;\r\nstruct drm_info_node *tmp;\r\nint i;\r\nmutex_lock(&minor->debugfs_lock);\r\nfor (i = 0; i < count; i++) {\r\nlist_for_each_safe(pos, q, &minor->debugfs_list) {\r\ntmp = list_entry(pos, struct drm_info_node, list);\r\nif (tmp->info_ent == &files[i]) {\r\ndebugfs_remove(tmp->dent);\r\nlist_del(pos);\r\nkfree(tmp);\r\n}\r\n}\r\n}\r\nmutex_unlock(&minor->debugfs_lock);\r\nreturn 0;\r\n}\r\nint drm_debugfs_cleanup(struct drm_minor *minor)\r\n{\r\nstruct drm_device *dev = minor->dev;\r\nif (!minor->debugfs_root)\r\nreturn 0;\r\nif (dev->driver->debugfs_cleanup)\r\ndev->driver->debugfs_cleanup(minor);\r\ndrm_debugfs_remove_files(drm_debugfs_list, DRM_DEBUGFS_ENTRIES, minor);\r\ndebugfs_remove(minor->debugfs_root);\r\nminor->debugfs_root = NULL;\r\nreturn 0;\r\n}

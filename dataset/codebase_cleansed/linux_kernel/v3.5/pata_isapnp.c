static int isapnp_init_one(struct pnp_dev *idev, const struct pnp_device_id *dev_id)\r\n{\r\nstruct ata_host *host;\r\nstruct ata_port *ap;\r\nvoid __iomem *cmd_addr, *ctl_addr;\r\nint irq = 0;\r\nirq_handler_t handler = NULL;\r\nif (pnp_port_valid(idev, 0) == 0)\r\nreturn -ENODEV;\r\nif (pnp_irq_valid(idev, 0)) {\r\nirq = pnp_irq(idev, 0);\r\nhandler = ata_sff_interrupt;\r\n}\r\nhost = ata_host_alloc(&idev->dev, 1);\r\nif (!host)\r\nreturn -ENOMEM;\r\ncmd_addr = devm_ioport_map(&idev->dev, pnp_port_start(idev, 0), 8);\r\nif (!cmd_addr)\r\nreturn -ENOMEM;\r\nap = host->ports[0];\r\nap->ops = &isapnp_noalt_port_ops;\r\nap->pio_mask = ATA_PIO0;\r\nap->flags |= ATA_FLAG_SLAVE_POSS;\r\nap->ioaddr.cmd_addr = cmd_addr;\r\nif (pnp_port_valid(idev, 1) == 0) {\r\nctl_addr = devm_ioport_map(&idev->dev,\r\npnp_port_start(idev, 1), 1);\r\nap->ioaddr.altstatus_addr = ctl_addr;\r\nap->ioaddr.ctl_addr = ctl_addr;\r\nap->ops = &isapnp_port_ops;\r\n}\r\nata_sff_std_ports(&ap->ioaddr);\r\nata_port_desc(ap, "cmd 0x%llx ctl 0x%llx",\r\n(unsigned long long)pnp_port_start(idev, 0),\r\n(unsigned long long)pnp_port_start(idev, 1));\r\nreturn ata_host_activate(host, irq, handler, 0,\r\n&isapnp_sht);\r\n}\r\nstatic void isapnp_remove_one(struct pnp_dev *idev)\r\n{\r\nstruct device *dev = &idev->dev;\r\nstruct ata_host *host = dev_get_drvdata(dev);\r\nata_host_detach(host);\r\n}\r\nstatic int __init isapnp_init(void)\r\n{\r\nreturn pnp_register_driver(&isapnp_driver);\r\n}\r\nstatic void __exit isapnp_exit(void)\r\n{\r\npnp_unregister_driver(&isapnp_driver);\r\n}

int pwm_config(struct pwm_device *pwm, int duty_ns, int period_ns)\r\n{\r\nu8 duty_cycle;\r\nint ret;\r\nif (pwm == NULL || period_ns == 0 || duty_ns > period_ns)\r\nreturn -EINVAL;\r\nduty_cycle = (duty_ns * PWM_CTRL1_MAX) / period_ns;\r\nret = twl_i2c_write_u8(TWL6030_MODULE_ID1, duty_cycle, LED_PWM_CTRL1);\r\nif (ret < 0) {\r\npr_err("%s: Failed to configure PWM, Error %d\n",\r\npwm->label, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nint pwm_enable(struct pwm_device *pwm)\r\n{\r\nu8 val;\r\nint ret;\r\nret = twl_i2c_read_u8(TWL6030_MODULE_ID1, &val, LED_PWM_CTRL2);\r\nif (ret < 0) {\r\npr_err("%s: Failed to enable PWM, Error %d\n", pwm->label, ret);\r\nreturn ret;\r\n}\r\nval &= ~PWM_CTRL2_MODE_MASK;\r\nval |= PWM_CTRL2_MODE_SW;\r\nret = twl_i2c_write_u8(TWL6030_MODULE_ID1, val, LED_PWM_CTRL2);\r\nif (ret < 0) {\r\npr_err("%s: Failed to enable PWM, Error %d\n", pwm->label, ret);\r\nreturn ret;\r\n}\r\ntwl_i2c_read_u8(TWL6030_MODULE_ID1, &val, LED_PWM_CTRL2);\r\nreturn 0;\r\n}\r\nvoid pwm_disable(struct pwm_device *pwm)\r\n{\r\nu8 val;\r\nint ret;\r\nret = twl_i2c_read_u8(TWL6030_MODULE_ID1, &val, LED_PWM_CTRL2);\r\nif (ret < 0) {\r\npr_err("%s: Failed to disable PWM, Error %d\n",\r\npwm->label, ret);\r\nreturn;\r\n}\r\nval &= ~PWM_CTRL2_MODE_MASK;\r\nval |= PWM_CTRL2_MODE_HW;\r\nret = twl_i2c_write_u8(TWL6030_MODULE_ID1, val, LED_PWM_CTRL2);\r\nif (ret < 0) {\r\npr_err("%s: Failed to disable PWM, Error %d\n",\r\npwm->label, ret);\r\nreturn;\r\n}\r\nreturn;\r\n}\r\nstruct pwm_device *pwm_request(int pwm_id, const char *label)\r\n{\r\nu8 val;\r\nint ret;\r\nstruct pwm_device *pwm;\r\npwm = kzalloc(sizeof(struct pwm_device), GFP_KERNEL);\r\nif (pwm == NULL) {\r\npr_err("%s: failed to allocate memory\n", label);\r\nreturn NULL;\r\n}\r\npwm->label = label;\r\npwm->pwm_id = pwm_id;\r\nval = PWM_CTRL2_DIS_PD | PWM_CTRL2_CURR_02 | PWM_CTRL2_SRC_VAC |\r\nPWM_CTRL2_MODE_HW;\r\nret = twl_i2c_write_u8(TWL6030_MODULE_ID1, val, LED_PWM_CTRL2);\r\nif (ret < 0) {\r\npr_err("%s: Failed to configure PWM, Error %d\n",\r\npwm->label, ret);\r\nkfree(pwm);\r\nreturn NULL;\r\n}\r\nreturn pwm;\r\n}\r\nvoid pwm_free(struct pwm_device *pwm)\r\n{\r\npwm_disable(pwm);\r\nkfree(pwm);\r\n}

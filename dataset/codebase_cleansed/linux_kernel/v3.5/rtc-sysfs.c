static ssize_t\r\nrtc_sysfs_show_name(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "%s\n", to_rtc_device(dev)->name);\r\n}\r\nstatic ssize_t\r\nrtc_sysfs_show_date(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nssize_t retval;\r\nstruct rtc_time tm;\r\nretval = rtc_read_time(to_rtc_device(dev), &tm);\r\nif (retval == 0) {\r\nretval = sprintf(buf, "%04d-%02d-%02d\n",\r\ntm.tm_year + 1900, tm.tm_mon + 1, tm.tm_mday);\r\n}\r\nreturn retval;\r\n}\r\nstatic ssize_t\r\nrtc_sysfs_show_time(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nssize_t retval;\r\nstruct rtc_time tm;\r\nretval = rtc_read_time(to_rtc_device(dev), &tm);\r\nif (retval == 0) {\r\nretval = sprintf(buf, "%02d:%02d:%02d\n",\r\ntm.tm_hour, tm.tm_min, tm.tm_sec);\r\n}\r\nreturn retval;\r\n}\r\nstatic ssize_t\r\nrtc_sysfs_show_since_epoch(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nssize_t retval;\r\nstruct rtc_time tm;\r\nretval = rtc_read_time(to_rtc_device(dev), &tm);\r\nif (retval == 0) {\r\nunsigned long time;\r\nrtc_tm_to_time(&tm, &time);\r\nretval = sprintf(buf, "%lu\n", time);\r\n}\r\nreturn retval;\r\n}\r\nstatic ssize_t\r\nrtc_sysfs_show_max_user_freq(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", to_rtc_device(dev)->max_user_freq);\r\n}\r\nstatic ssize_t\r\nrtc_sysfs_set_max_user_freq(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t n)\r\n{\r\nstruct rtc_device *rtc = to_rtc_device(dev);\r\nunsigned long val = simple_strtoul(buf, NULL, 0);\r\nif (val >= 4096 || val == 0)\r\nreturn -EINVAL;\r\nrtc->max_user_freq = (int)val;\r\nreturn n;\r\n}\r\nstatic ssize_t\r\nrtc_sysfs_show_hctosys(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\n#ifdef CONFIG_RTC_HCTOSYS_DEVICE\r\nif (rtc_hctosys_ret == 0 &&\r\nstrcmp(dev_name(&to_rtc_device(dev)->dev),\r\nCONFIG_RTC_HCTOSYS_DEVICE) == 0)\r\nreturn sprintf(buf, "1\n");\r\nelse\r\n#endif\r\nreturn sprintf(buf, "0\n");\r\n}\r\nstatic ssize_t\r\nrtc_sysfs_show_wakealarm(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nssize_t retval;\r\nunsigned long alarm;\r\nstruct rtc_wkalrm alm;\r\nretval = rtc_read_alarm(to_rtc_device(dev), &alm);\r\nif (retval == 0 && alm.enabled) {\r\nrtc_tm_to_time(&alm.time, &alarm);\r\nretval = sprintf(buf, "%lu\n", alarm);\r\n}\r\nreturn retval;\r\n}\r\nstatic ssize_t\r\nrtc_sysfs_set_wakealarm(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t n)\r\n{\r\nssize_t retval;\r\nunsigned long now, alarm;\r\nstruct rtc_wkalrm alm;\r\nstruct rtc_device *rtc = to_rtc_device(dev);\r\nchar *buf_ptr;\r\nint adjust = 0;\r\nretval = rtc_read_time(rtc, &alm.time);\r\nif (retval < 0)\r\nreturn retval;\r\nrtc_tm_to_time(&alm.time, &now);\r\nbuf_ptr = (char *)buf;\r\nif (*buf_ptr == '+') {\r\nbuf_ptr++;\r\nadjust = 1;\r\n}\r\nalarm = simple_strtoul(buf_ptr, NULL, 0);\r\nif (adjust) {\r\nalarm += now;\r\n}\r\nif (alarm > now) {\r\nretval = rtc_read_alarm(rtc, &alm);\r\nif (retval < 0)\r\nreturn retval;\r\nif (alm.enabled)\r\nreturn -EBUSY;\r\nalm.enabled = 1;\r\n} else {\r\nalm.enabled = 0;\r\nalarm = now + 300;\r\n}\r\nrtc_time_to_tm(alarm, &alm.time);\r\nretval = rtc_set_alarm(rtc, &alm);\r\nreturn (retval < 0) ? retval : n;\r\n}\r\nstatic inline int rtc_does_wakealarm(struct rtc_device *rtc)\r\n{\r\nif (!device_can_wakeup(rtc->dev.parent))\r\nreturn 0;\r\nreturn rtc->ops->set_alarm != NULL;\r\n}\r\nvoid rtc_sysfs_add_device(struct rtc_device *rtc)\r\n{\r\nint err;\r\nif (!rtc_does_wakealarm(rtc))\r\nreturn;\r\nerr = device_create_file(&rtc->dev, &dev_attr_wakealarm);\r\nif (err)\r\ndev_err(rtc->dev.parent,\r\n"failed to create alarm attribute, %d\n", err);\r\n}\r\nvoid rtc_sysfs_del_device(struct rtc_device *rtc)\r\n{\r\nif (rtc_does_wakealarm(rtc))\r\ndevice_remove_file(&rtc->dev, &dev_attr_wakealarm);\r\n}\r\nvoid __init rtc_sysfs_init(struct class *rtc_class)\r\n{\r\nrtc_class->dev_attrs = rtc_attrs;\r\n}

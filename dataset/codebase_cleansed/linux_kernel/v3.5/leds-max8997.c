static void max8997_led_clear_mode(struct max8997_led *led,\r\nenum max8997_led_mode mode)\r\n{\r\nstruct i2c_client *client = led->iodev->i2c;\r\nu8 val = 0, mask = 0;\r\nint ret;\r\nswitch (mode) {\r\ncase MAX8997_FLASH_MODE:\r\nmask = led->id ?\r\nMAX8997_LED1_FLASH_MASK : MAX8997_LED0_FLASH_MASK;\r\nbreak;\r\ncase MAX8997_MOVIE_MODE:\r\nmask = led->id ?\r\nMAX8997_LED1_MOVIE_MASK : MAX8997_LED0_MOVIE_MASK;\r\nbreak;\r\ncase MAX8997_FLASH_PIN_CONTROL_MODE:\r\nmask = led->id ?\r\nMAX8997_LED1_FLASH_PIN_MASK : MAX8997_LED0_FLASH_PIN_MASK;\r\nbreak;\r\ncase MAX8997_MOVIE_PIN_CONTROL_MODE:\r\nmask = led->id ?\r\nMAX8997_LED1_MOVIE_PIN_MASK : MAX8997_LED0_MOVIE_PIN_MASK;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (mask) {\r\nret = max8997_update_reg(client,\r\nMAX8997_REG_LEN_CNTL, val, mask);\r\nif (ret)\r\ndev_err(led->iodev->dev,\r\n"failed to update register(%d)\n", ret);\r\n}\r\n}\r\nstatic void max8997_led_set_mode(struct max8997_led *led,\r\nenum max8997_led_mode mode)\r\n{\r\nint ret;\r\nstruct i2c_client *client = led->iodev->i2c;\r\nu8 mask = 0;\r\nmax8997_led_clear_mode(led, led->led_mode);\r\nswitch (mode) {\r\ncase MAX8997_FLASH_MODE:\r\nmask = led->id ?\r\nMAX8997_LED1_FLASH_MASK : MAX8997_LED0_FLASH_MASK;\r\nled->cdev.max_brightness = MAX8997_LED_FLASH_MAX_BRIGHTNESS;\r\nbreak;\r\ncase MAX8997_MOVIE_MODE:\r\nmask = led->id ?\r\nMAX8997_LED1_MOVIE_MASK : MAX8997_LED0_MOVIE_MASK;\r\nled->cdev.max_brightness = MAX8997_LED_MOVIE_MAX_BRIGHTNESS;\r\nbreak;\r\ncase MAX8997_FLASH_PIN_CONTROL_MODE:\r\nmask = led->id ?\r\nMAX8997_LED1_FLASH_PIN_MASK : MAX8997_LED0_FLASH_PIN_MASK;\r\nled->cdev.max_brightness = MAX8997_LED_FLASH_MAX_BRIGHTNESS;\r\nbreak;\r\ncase MAX8997_MOVIE_PIN_CONTROL_MODE:\r\nmask = led->id ?\r\nMAX8997_LED1_MOVIE_PIN_MASK : MAX8997_LED0_MOVIE_PIN_MASK;\r\nled->cdev.max_brightness = MAX8997_LED_MOVIE_MAX_BRIGHTNESS;\r\nbreak;\r\ndefault:\r\nled->cdev.max_brightness = MAX8997_LED_NONE_MAX_BRIGHTNESS;\r\nbreak;\r\n}\r\nif (mask) {\r\nret = max8997_update_reg(client,\r\nMAX8997_REG_LEN_CNTL, mask, mask);\r\nif (ret)\r\ndev_err(led->iodev->dev,\r\n"failed to update register(%d)\n", ret);\r\n}\r\nled->led_mode = mode;\r\n}\r\nstatic void max8997_led_enable(struct max8997_led *led, bool enable)\r\n{\r\nint ret;\r\nstruct i2c_client *client = led->iodev->i2c;\r\nu8 val = 0, mask = MAX8997_LED_BOOST_ENABLE_MASK;\r\nif (led->enabled == enable)\r\nreturn;\r\nval = enable ? MAX8997_LED_BOOST_ENABLE_MASK : 0;\r\nret = max8997_update_reg(client, MAX8997_REG_BOOST_CNTL, val, mask);\r\nif (ret)\r\ndev_err(led->iodev->dev,\r\n"failed to update register(%d)\n", ret);\r\nled->enabled = enable;\r\n}\r\nstatic void max8997_led_set_current(struct max8997_led *led,\r\nenum led_brightness value)\r\n{\r\nint ret;\r\nstruct i2c_client *client = led->iodev->i2c;\r\nu8 val = 0, mask = 0, reg = 0;\r\nswitch (led->led_mode) {\r\ncase MAX8997_FLASH_MODE:\r\ncase MAX8997_FLASH_PIN_CONTROL_MODE:\r\nval = value << MAX8997_LED_FLASH_SHIFT;\r\nmask = MAX8997_LED_FLASH_CUR_MASK;\r\nreg = led->id ? MAX8997_REG_FLASH2_CUR : MAX8997_REG_FLASH1_CUR;\r\nbreak;\r\ncase MAX8997_MOVIE_MODE:\r\ncase MAX8997_MOVIE_PIN_CONTROL_MODE:\r\nval = value << MAX8997_LED_MOVIE_SHIFT;\r\nmask = MAX8997_LED_MOVIE_CUR_MASK;\r\nreg = MAX8997_REG_MOVIE_CUR;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (mask) {\r\nret = max8997_update_reg(client, reg, val, mask);\r\nif (ret)\r\ndev_err(led->iodev->dev,\r\n"failed to update register(%d)\n", ret);\r\n}\r\n}\r\nstatic void max8997_led_brightness_set(struct led_classdev *led_cdev,\r\nenum led_brightness value)\r\n{\r\nstruct max8997_led *led =\r\ncontainer_of(led_cdev, struct max8997_led, cdev);\r\nif (value) {\r\nmax8997_led_set_current(led, value);\r\nmax8997_led_enable(led, true);\r\n} else {\r\nmax8997_led_set_current(led, value);\r\nmax8997_led_enable(led, false);\r\n}\r\n}\r\nstatic ssize_t max8997_led_show_mode(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct max8997_led *led =\r\ncontainer_of(led_cdev, struct max8997_led, cdev);\r\nssize_t ret = 0;\r\nmutex_lock(&led->mutex);\r\nswitch (led->led_mode) {\r\ncase MAX8997_FLASH_MODE:\r\nret += sprintf(buf, "FLASH\n");\r\nbreak;\r\ncase MAX8997_MOVIE_MODE:\r\nret += sprintf(buf, "MOVIE\n");\r\nbreak;\r\ncase MAX8997_FLASH_PIN_CONTROL_MODE:\r\nret += sprintf(buf, "FLASH_PIN_CONTROL\n");\r\nbreak;\r\ncase MAX8997_MOVIE_PIN_CONTROL_MODE:\r\nret += sprintf(buf, "MOVIE_PIN_CONTROL\n");\r\nbreak;\r\ndefault:\r\nret += sprintf(buf, "NONE\n");\r\nbreak;\r\n}\r\nmutex_unlock(&led->mutex);\r\nreturn ret;\r\n}\r\nstatic ssize_t max8997_led_store_mode(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nstruct max8997_led *led =\r\ncontainer_of(led_cdev, struct max8997_led, cdev);\r\nenum max8997_led_mode mode;\r\nmutex_lock(&led->mutex);\r\nif (!strncmp(buf, "FLASH_PIN_CONTROL", 17))\r\nmode = MAX8997_FLASH_PIN_CONTROL_MODE;\r\nelse if (!strncmp(buf, "MOVIE_PIN_CONTROL", 17))\r\nmode = MAX8997_MOVIE_PIN_CONTROL_MODE;\r\nelse if (!strncmp(buf, "FLASH", 5))\r\nmode = MAX8997_FLASH_MODE;\r\nelse if (!strncmp(buf, "MOVIE", 5))\r\nmode = MAX8997_MOVIE_MODE;\r\nelse\r\nmode = MAX8997_NONE;\r\nmax8997_led_set_mode(led, mode);\r\nmutex_unlock(&led->mutex);\r\nreturn size;\r\n}\r\nstatic int __devinit max8997_led_probe(struct platform_device *pdev)\r\n{\r\nstruct max8997_dev *iodev = dev_get_drvdata(pdev->dev.parent);\r\nstruct max8997_platform_data *pdata = dev_get_platdata(iodev->dev);\r\nstruct max8997_led *led;\r\nchar name[20];\r\nint ret = 0;\r\nif (pdata == NULL) {\r\ndev_err(&pdev->dev, "no platform data\n");\r\nreturn -ENODEV;\r\n}\r\nled = kzalloc(sizeof(*led), GFP_KERNEL);\r\nif (led == NULL) {\r\nret = -ENOMEM;\r\ngoto err_mem;\r\n}\r\nled->id = pdev->id;\r\nsnprintf(name, sizeof(name), "max8997-led%d", pdev->id);\r\nled->cdev.name = name;\r\nled->cdev.brightness_set = max8997_led_brightness_set;\r\nled->cdev.flags |= LED_CORE_SUSPENDRESUME;\r\nled->cdev.brightness = 0;\r\nled->iodev = iodev;\r\nif (pdata->led_pdata) {\r\nu8 mode = 0, brightness = 0;\r\nmode = pdata->led_pdata->mode[led->id];\r\nbrightness = pdata->led_pdata->brightness[led->id];\r\nmax8997_led_set_mode(led, pdata->led_pdata->mode[led->id]);\r\nif (brightness > led->cdev.max_brightness)\r\nbrightness = led->cdev.max_brightness;\r\nmax8997_led_set_current(led, brightness);\r\nled->cdev.brightness = brightness;\r\n} else {\r\nmax8997_led_set_mode(led, MAX8997_NONE);\r\nmax8997_led_set_current(led, 0);\r\n}\r\nmutex_init(&led->mutex);\r\nplatform_set_drvdata(pdev, led);\r\nret = led_classdev_register(&pdev->dev, &led->cdev);\r\nif (ret < 0)\r\ngoto err_led;\r\nret = device_create_file(led->cdev.dev, &dev_attr_mode);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev,\r\n"failed to create file: %d\n", ret);\r\ngoto err_file;\r\n}\r\nreturn 0;\r\nerr_file:\r\nled_classdev_unregister(&led->cdev);\r\nerr_led:\r\nkfree(led);\r\nerr_mem:\r\nreturn ret;\r\n}\r\nstatic int __devexit max8997_led_remove(struct platform_device *pdev)\r\n{\r\nstruct max8997_led *led = platform_get_drvdata(pdev);\r\ndevice_remove_file(led->cdev.dev, &dev_attr_mode);\r\nled_classdev_unregister(&led->cdev);\r\nkfree(led);\r\nreturn 0;\r\n}\r\nstatic int __init max8997_led_init(void)\r\n{\r\nreturn platform_driver_register(&max8997_led_driver);\r\n}\r\nstatic void __exit max8997_led_exit(void)\r\n{\r\nplatform_driver_unregister(&max8997_led_driver);\r\n}

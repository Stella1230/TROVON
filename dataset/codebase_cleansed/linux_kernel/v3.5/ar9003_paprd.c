void ar9003_paprd_enable(struct ath_hw *ah, bool val)\r\n{\r\nstruct ath9k_channel *chan = ah->curchan;\r\nstruct ar9300_eeprom *eep = &ah->eeprom.ar9300_eep;\r\nif (IS_CHAN_5GHZ(chan)) {\r\nif (chan->channel >= UPPER_5G_SUB_BAND_START) {\r\nif (le32_to_cpu(eep->modalHeader5G.papdRateMaskHt20)\r\n& BIT(30))\r\nval = false;\r\n} else if (chan->channel >= MID_5G_SUB_BAND_START) {\r\nif (le32_to_cpu(eep->modalHeader5G.papdRateMaskHt20)\r\n& BIT(29))\r\nval = false;\r\n} else {\r\nif (le32_to_cpu(eep->modalHeader5G.papdRateMaskHt20)\r\n& BIT(28))\r\nval = false;\r\n}\r\n}\r\nif (val) {\r\nah->paprd_table_write_done = true;\r\nath9k_hw_apply_txpower(ah, chan, false);\r\n}\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_CTRL0_B0,\r\nAR_PHY_PAPRD_CTRL0_PAPRD_ENABLE, !!val);\r\nif (ah->caps.tx_chainmask & BIT(1))\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_CTRL0_B1,\r\nAR_PHY_PAPRD_CTRL0_PAPRD_ENABLE, !!val);\r\nif (ah->caps.tx_chainmask & BIT(2))\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_CTRL0_B2,\r\nAR_PHY_PAPRD_CTRL0_PAPRD_ENABLE, !!val);\r\n}\r\nstatic int ar9003_get_training_power_2g(struct ath_hw *ah)\r\n{\r\nstruct ath9k_channel *chan = ah->curchan;\r\nunsigned int power, scale, delta;\r\nscale = ar9003_get_paprd_scale_factor(ah, chan);\r\npower = REG_READ_FIELD(ah, AR_PHY_POWERTX_RATE5,\r\nAR_PHY_POWERTX_RATE5_POWERTXHT20_0);\r\ndelta = abs((int) ah->paprd_target_power - (int) power);\r\nif (delta > scale)\r\nreturn -1;\r\nif (delta < 4)\r\npower -= 4 - delta;\r\nreturn power;\r\n}\r\nstatic int ar9003_get_training_power_5g(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nstruct ath9k_channel *chan = ah->curchan;\r\nunsigned int power, scale, delta;\r\nscale = ar9003_get_paprd_scale_factor(ah, chan);\r\nif (IS_CHAN_HT40(chan))\r\npower = REG_READ_FIELD(ah, AR_PHY_POWERTX_RATE8,\r\nAR_PHY_POWERTX_RATE8_POWERTXHT40_5);\r\nelse\r\npower = REG_READ_FIELD(ah, AR_PHY_POWERTX_RATE6,\r\nAR_PHY_POWERTX_RATE6_POWERTXHT20_5);\r\npower += scale;\r\ndelta = abs((int) ah->paprd_target_power - (int) power);\r\nif (delta > scale)\r\nreturn -1;\r\nswitch (get_streams(ah->txchainmask)) {\r\ncase 1:\r\ndelta = 6;\r\nbreak;\r\ncase 2:\r\ndelta = 4;\r\nbreak;\r\ncase 3:\r\ndelta = 2;\r\nbreak;\r\ndefault:\r\ndelta = 0;\r\nath_dbg(common, CALIBRATE, "Invalid tx-chainmask: %u\n",\r\nah->txchainmask);\r\n}\r\npower += delta;\r\nreturn power;\r\n}\r\nstatic int ar9003_paprd_setup_single_table(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nstatic const u32 ctrl0[3] = {\r\nAR_PHY_PAPRD_CTRL0_B0,\r\nAR_PHY_PAPRD_CTRL0_B1,\r\nAR_PHY_PAPRD_CTRL0_B2\r\n};\r\nstatic const u32 ctrl1[3] = {\r\nAR_PHY_PAPRD_CTRL1_B0,\r\nAR_PHY_PAPRD_CTRL1_B1,\r\nAR_PHY_PAPRD_CTRL1_B2\r\n};\r\nint training_power;\r\nint i, val;\r\nif (IS_CHAN_2GHZ(ah->curchan))\r\ntraining_power = ar9003_get_training_power_2g(ah);\r\nelse\r\ntraining_power = ar9003_get_training_power_5g(ah);\r\nath_dbg(common, CALIBRATE, "Training power: %d, Target power: %d\n",\r\ntraining_power, ah->paprd_target_power);\r\nif (training_power < 0) {\r\nath_dbg(common, CALIBRATE,\r\n"PAPRD target power delta out of range\n");\r\nreturn -ERANGE;\r\n}\r\nah->paprd_training_power = training_power;\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_AM2AM, AR_PHY_PAPRD_AM2AM_MASK,\r\nah->paprd_ratemask);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_AM2PM, AR_PHY_PAPRD_AM2PM_MASK,\r\nah->paprd_ratemask);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_HT40, AR_PHY_PAPRD_HT40_MASK,\r\nah->paprd_ratemask_ht40);\r\nfor (i = 0; i < ah->caps.max_txchains; i++) {\r\nREG_RMW_FIELD(ah, ctrl0[i],\r\nAR_PHY_PAPRD_CTRL0_USE_SINGLE_TABLE_MASK, 1);\r\nREG_RMW_FIELD(ah, ctrl1[i],\r\nAR_PHY_PAPRD_CTRL1_ADAPTIVE_AM2PM_ENABLE, 1);\r\nREG_RMW_FIELD(ah, ctrl1[i],\r\nAR_PHY_PAPRD_CTRL1_ADAPTIVE_AM2AM_ENABLE, 1);\r\nREG_RMW_FIELD(ah, ctrl1[i],\r\nAR_PHY_PAPRD_CTRL1_ADAPTIVE_SCALING_ENA, 0);\r\nREG_RMW_FIELD(ah, ctrl1[i],\r\nAR_PHY_PAPRD_CTRL1_PA_GAIN_SCALE_FACT_MASK, 181);\r\nREG_RMW_FIELD(ah, ctrl1[i],\r\nAR_PHY_PAPRD_CTRL1_PAPRD_MAG_SCALE_FACT, 361);\r\nREG_RMW_FIELD(ah, ctrl1[i],\r\nAR_PHY_PAPRD_CTRL1_ADAPTIVE_SCALING_ENA, 0);\r\nREG_RMW_FIELD(ah, ctrl0[i],\r\nAR_PHY_PAPRD_CTRL0_PAPRD_MAG_THRSH, 3);\r\n}\r\nar9003_paprd_enable(ah, false);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL1,\r\nAR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_SKIP, 0x30);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL1,\r\nAR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_ENABLE, 1);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL1,\r\nAR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_TX_GAIN_FORCE, 1);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL1,\r\nAR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_RX_BB_GAIN_FORCE, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL1,\r\nAR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_IQCORR_ENABLE, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL1,\r\nAR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_AGC2_SETTLING, 28);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL1,\r\nAR_PHY_PAPRD_TRAINER_CNTL1_CF_CF_PAPRD_TRAIN_ENABLE, 1);\r\nval = AR_SREV_9462(ah) ? 0x91 : 147;\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL2,\r\nAR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN, val);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3,\r\nAR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_FINE_CORR_LEN, 4);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3,\r\nAR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_COARSE_CORR_LEN, 4);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3,\r\nAR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_NUM_CORR_STAGES, 7);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3,\r\nAR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_MIN_LOOPBACK_DEL, 1);\r\nif (AR_SREV_9485(ah) || AR_SREV_9462(ah))\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3,\r\nAR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP,\r\n-3);\r\nelse\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3,\r\nAR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP,\r\n-6);\r\nval = AR_SREV_9462(ah) ? -10 : -15;\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3,\r\nAR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE,\r\nval);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3,\r\nAR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_BBTXMIX_DISABLE, 1);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL4,\r\nAR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_SAFETY_DELTA, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL4,\r\nAR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_MIN_CORR, 400);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL4,\r\nAR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_NUM_TRAIN_SAMPLES,\r\n100);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_0_B0,\r\nAR_PHY_PAPRD_PRE_POST_SCALING, 261376);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_1_B0,\r\nAR_PHY_PAPRD_PRE_POST_SCALING, 248079);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_2_B0,\r\nAR_PHY_PAPRD_PRE_POST_SCALING, 233759);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_3_B0,\r\nAR_PHY_PAPRD_PRE_POST_SCALING, 220464);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_4_B0,\r\nAR_PHY_PAPRD_PRE_POST_SCALING, 208194);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_5_B0,\r\nAR_PHY_PAPRD_PRE_POST_SCALING, 196949);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_6_B0,\r\nAR_PHY_PAPRD_PRE_POST_SCALING, 185706);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_7_B0,\r\nAR_PHY_PAPRD_PRE_POST_SCALING, 175487);\r\nreturn 0;\r\n}\r\nstatic void ar9003_paprd_get_gain_table(struct ath_hw *ah)\r\n{\r\nu32 *entry = ah->paprd_gain_table_entries;\r\nu8 *index = ah->paprd_gain_table_index;\r\nu32 reg = AR_PHY_TXGAIN_TABLE;\r\nint i;\r\nmemset(entry, 0, sizeof(ah->paprd_gain_table_entries));\r\nmemset(index, 0, sizeof(ah->paprd_gain_table_index));\r\nfor (i = 0; i < PAPRD_GAIN_TABLE_ENTRIES; i++) {\r\nentry[i] = REG_READ(ah, reg);\r\nindex[i] = (entry[i] >> 24) & 0xff;\r\nreg += 4;\r\n}\r\n}\r\nstatic unsigned int ar9003_get_desired_gain(struct ath_hw *ah, int chain,\r\nint target_power)\r\n{\r\nint olpc_gain_delta = 0, cl_gain_mod;\r\nint alpha_therm, alpha_volt;\r\nint therm_cal_value, volt_cal_value;\r\nint therm_value, volt_value;\r\nint thermal_gain_corr, voltage_gain_corr;\r\nint desired_scale, desired_gain = 0;\r\nu32 reg_olpc = 0, reg_cl_gain = 0;\r\nREG_CLR_BIT(ah, AR_PHY_PAPRD_TRAINER_STAT1,\r\nAR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE);\r\ndesired_scale = REG_READ_FIELD(ah, AR_PHY_TPC_12,\r\nAR_PHY_TPC_12_DESIRED_SCALE_HT40_5);\r\nalpha_therm = REG_READ_FIELD(ah, AR_PHY_TPC_19,\r\nAR_PHY_TPC_19_ALPHA_THERM);\r\nalpha_volt = REG_READ_FIELD(ah, AR_PHY_TPC_19,\r\nAR_PHY_TPC_19_ALPHA_VOLT);\r\ntherm_cal_value = REG_READ_FIELD(ah, AR_PHY_TPC_18,\r\nAR_PHY_TPC_18_THERM_CAL_VALUE);\r\nvolt_cal_value = REG_READ_FIELD(ah, AR_PHY_TPC_18,\r\nAR_PHY_TPC_18_VOLT_CAL_VALUE);\r\ntherm_value = REG_READ_FIELD(ah, AR_PHY_BB_THERM_ADC_4,\r\nAR_PHY_BB_THERM_ADC_4_LATEST_THERM_VALUE);\r\nvolt_value = REG_READ_FIELD(ah, AR_PHY_BB_THERM_ADC_4,\r\nAR_PHY_BB_THERM_ADC_4_LATEST_VOLT_VALUE);\r\nswitch (chain) {\r\ncase 0:\r\nreg_olpc = AR_PHY_TPC_11_B0;\r\nreg_cl_gain = AR_PHY_CL_TAB_0;\r\nbreak;\r\ncase 1:\r\nreg_olpc = AR_PHY_TPC_11_B1;\r\nreg_cl_gain = AR_PHY_CL_TAB_1;\r\nbreak;\r\ncase 2:\r\nreg_olpc = AR_PHY_TPC_11_B2;\r\nreg_cl_gain = AR_PHY_CL_TAB_2;\r\nbreak;\r\ndefault:\r\nath_dbg(ath9k_hw_common(ah), CALIBRATE,\r\n"Invalid chainmask: %d\n", chain);\r\nbreak;\r\n}\r\nolpc_gain_delta = REG_READ_FIELD(ah, reg_olpc,\r\nAR_PHY_TPC_11_OLPC_GAIN_DELTA);\r\ncl_gain_mod = REG_READ_FIELD(ah, reg_cl_gain,\r\nAR_PHY_CL_TAB_CL_GAIN_MOD);\r\nif (olpc_gain_delta >= 128)\r\nolpc_gain_delta = olpc_gain_delta - 256;\r\nthermal_gain_corr = (alpha_therm * (therm_value - therm_cal_value) +\r\n(256 / 2)) / 256;\r\nvoltage_gain_corr = (alpha_volt * (volt_value - volt_cal_value) +\r\n(128 / 2)) / 128;\r\ndesired_gain = target_power - olpc_gain_delta - thermal_gain_corr -\r\nvoltage_gain_corr + desired_scale + cl_gain_mod;\r\nreturn desired_gain;\r\n}\r\nstatic void ar9003_tx_force_gain(struct ath_hw *ah, unsigned int gain_index)\r\n{\r\nint selected_gain_entry, txbb1dbgain, txbb6dbgain, txmxrgain;\r\nint padrvgnA, padrvgnB, padrvgnC, padrvgnD;\r\nu32 *gain_table_entries = ah->paprd_gain_table_entries;\r\nselected_gain_entry = gain_table_entries[gain_index];\r\ntxbb1dbgain = selected_gain_entry & 0x7;\r\ntxbb6dbgain = (selected_gain_entry >> 3) & 0x3;\r\ntxmxrgain = (selected_gain_entry >> 5) & 0xf;\r\npadrvgnA = (selected_gain_entry >> 9) & 0xf;\r\npadrvgnB = (selected_gain_entry >> 13) & 0xf;\r\npadrvgnC = (selected_gain_entry >> 17) & 0xf;\r\npadrvgnD = (selected_gain_entry >> 21) & 0x3;\r\nREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\r\nAR_PHY_TX_FORCED_GAIN_FORCED_TXBB1DBGAIN, txbb1dbgain);\r\nREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\r\nAR_PHY_TX_FORCED_GAIN_FORCED_TXBB6DBGAIN, txbb6dbgain);\r\nREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\r\nAR_PHY_TX_FORCED_GAIN_FORCED_TXMXRGAIN, txmxrgain);\r\nREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\r\nAR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNA, padrvgnA);\r\nREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\r\nAR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNB, padrvgnB);\r\nREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\r\nAR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNC, padrvgnC);\r\nREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\r\nAR_PHY_TX_FORCED_GAIN_FORCED_PADRVGND, padrvgnD);\r\nREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\r\nAR_PHY_TX_FORCED_GAIN_FORCED_ENABLE_PAL, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\r\nAR_PHY_TX_FORCED_GAIN_FORCE_TX_GAIN, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_TPC_1, AR_PHY_TPC_1_FORCED_DAC_GAIN, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_TPC_1, AR_PHY_TPC_1_FORCE_DAC_GAIN, 0);\r\n}\r\nstatic inline int find_expn(int num)\r\n{\r\nreturn fls(num) - 1;\r\n}\r\nstatic inline int find_proper_scale(int expn, int N)\r\n{\r\nreturn (expn > N) ? expn - 10 : 0;\r\n}\r\nstatic bool create_pa_curve(u32 *data_L, u32 *data_U, u32 *pa_table, u16 *gain)\r\n{\r\nunsigned int thresh_accum_cnt;\r\nint x_est[NUM_BIN + 1], Y[NUM_BIN + 1], theta[NUM_BIN + 1];\r\nint PA_in[NUM_BIN + 1];\r\nint B1_tmp[NUM_BIN + 1], B2_tmp[NUM_BIN + 1];\r\nunsigned int B1_abs_max, B2_abs_max;\r\nint max_index, scale_factor;\r\nint y_est[NUM_BIN + 1];\r\nint x_est_fxp1_nonlin, x_tilde[NUM_BIN + 1];\r\nunsigned int x_tilde_abs;\r\nint G_fxp, Y_intercept, order_x_by_y, M, I, L, sum_y_sqr, sum_y_quad;\r\nint Q_x, Q_B1, Q_B2, beta_raw, alpha_raw, scale_B;\r\nint Q_scale_B, Q_beta, Q_alpha, alpha, beta, order_1, order_2;\r\nint order1_5x, order2_3x, order1_5x_rem, order2_3x_rem;\r\nint y5, y3, tmp;\r\nint theta_low_bin = 0;\r\nint i;\r\nthresh_accum_cnt = 16;\r\nscale_factor = 5;\r\nmax_index = 0;\r\nmemset(theta, 0, sizeof(theta));\r\nmemset(x_est, 0, sizeof(x_est));\r\nmemset(Y, 0, sizeof(Y));\r\nmemset(y_est, 0, sizeof(y_est));\r\nmemset(x_tilde, 0, sizeof(x_tilde));\r\nfor (i = 0; i < NUM_BIN; i++) {\r\ns32 accum_cnt, accum_tx, accum_rx, accum_ang;\r\naccum_cnt = data_L[i] & 0xffff;\r\nif (accum_cnt <= thresh_accum_cnt)\r\ncontinue;\r\naccum_tx = ((data_L[i] >> 16) & 0xffff) |\r\n((data_U[i] & 0x7ff) << 16);\r\naccum_rx = ((data_U[i] >> 11) & 0x1f) |\r\n((data_L[i + 23] & 0xffff) << 5);\r\naccum_ang = ((data_L[i + 23] >> 16) & 0xffff) |\r\n((data_U[i + 23] & 0x7ff) << 16);\r\naccum_tx <<= scale_factor;\r\naccum_rx <<= scale_factor;\r\nx_est[i + 1] = (((accum_tx + accum_cnt) / accum_cnt) + 32) >>\r\nscale_factor;\r\nY[i + 1] = ((((accum_rx + accum_cnt) / accum_cnt) + 32) >>\r\nscale_factor) +\r\n(1 << scale_factor) * max_index + 16;\r\nif (accum_ang >= (1 << 26))\r\naccum_ang -= 1 << 27;\r\ntheta[i + 1] = ((accum_ang * (1 << scale_factor)) + accum_cnt) /\r\naccum_cnt;\r\nmax_index++;\r\n}\r\nfor (i = 1; i < 6; i++)\r\ntheta_low_bin += theta[i];\r\ntheta_low_bin = theta_low_bin / 5;\r\nfor (i = 1; i < 6; i++)\r\ntheta[i] = theta_low_bin;\r\ntheta[0] = theta_low_bin;\r\nfor (i = 0; i <= max_index; i++)\r\ntheta[i] -= theta_low_bin;\r\nx_est[0] = 0;\r\nY[0] = 0;\r\nscale_factor = 8;\r\nif (x_est[6] == x_est[3])\r\nreturn false;\r\nG_fxp =\r\n(((Y[6] - Y[3]) * 1 << scale_factor) +\r\n(x_est[6] - x_est[3])) / (x_est[6] - x_est[3]);\r\nif (G_fxp == 0)\r\nreturn false;\r\nY_intercept =\r\n(G_fxp * (x_est[0] - x_est[3]) +\r\n(1 << scale_factor)) / (1 << scale_factor) + Y[3];\r\nfor (i = 0; i <= max_index; i++)\r\ny_est[i] = Y[i] - Y_intercept;\r\nfor (i = 0; i <= 3; i++) {\r\ny_est[i] = i * 32;\r\nx_est[i] = ((y_est[i] * 1 << scale_factor) + G_fxp) / G_fxp;\r\n}\r\nif (y_est[max_index] == 0)\r\nreturn false;\r\nx_est_fxp1_nonlin =\r\nx_est[max_index] - ((1 << scale_factor) * y_est[max_index] +\r\nG_fxp) / G_fxp;\r\norder_x_by_y =\r\n(x_est_fxp1_nonlin + y_est[max_index]) / y_est[max_index];\r\nif (order_x_by_y == 0)\r\nM = 10;\r\nelse if (order_x_by_y == 1)\r\nM = 9;\r\nelse\r\nM = 8;\r\nI = (max_index > 15) ? 7 : max_index >> 1;\r\nL = max_index - I;\r\nscale_factor = 8;\r\nsum_y_sqr = 0;\r\nsum_y_quad = 0;\r\nx_tilde_abs = 0;\r\nfor (i = 0; i <= L; i++) {\r\nunsigned int y_sqr;\r\nunsigned int y_quad;\r\nunsigned int tmp_abs;\r\nif (y_est[i + I] == 0)\r\nreturn false;\r\nx_est_fxp1_nonlin =\r\nx_est[i + I] - ((1 << scale_factor) * y_est[i + I] +\r\nG_fxp) / G_fxp;\r\nx_tilde[i] =\r\n(x_est_fxp1_nonlin * (1 << M) + y_est[i + I]) / y_est[i +\r\nI];\r\nx_tilde[i] =\r\n(x_tilde[i] * (1 << M) + y_est[i + I]) / y_est[i + I];\r\nx_tilde[i] =\r\n(x_tilde[i] * (1 << M) + y_est[i + I]) / y_est[i + I];\r\ny_sqr =\r\n(y_est[i + I] * y_est[i + I] +\r\n(scale_factor * scale_factor)) / (scale_factor *\r\nscale_factor);\r\ntmp_abs = abs(x_tilde[i]);\r\nif (tmp_abs > x_tilde_abs)\r\nx_tilde_abs = tmp_abs;\r\ny_quad = y_sqr * y_sqr;\r\nsum_y_sqr = sum_y_sqr + y_sqr;\r\nsum_y_quad = sum_y_quad + y_quad;\r\nB1_tmp[i] = y_sqr * (L + 1);\r\nB2_tmp[i] = y_sqr;\r\n}\r\nB1_abs_max = 0;\r\nB2_abs_max = 0;\r\nfor (i = 0; i <= L; i++) {\r\nint abs_val;\r\nB1_tmp[i] -= sum_y_sqr;\r\nB2_tmp[i] = sum_y_quad - sum_y_sqr * B2_tmp[i];\r\nabs_val = abs(B1_tmp[i]);\r\nif (abs_val > B1_abs_max)\r\nB1_abs_max = abs_val;\r\nabs_val = abs(B2_tmp[i]);\r\nif (abs_val > B2_abs_max)\r\nB2_abs_max = abs_val;\r\n}\r\nQ_x = find_proper_scale(find_expn(x_tilde_abs), 10);\r\nQ_B1 = find_proper_scale(find_expn(B1_abs_max), 10);\r\nQ_B2 = find_proper_scale(find_expn(B2_abs_max), 10);\r\nbeta_raw = 0;\r\nalpha_raw = 0;\r\nfor (i = 0; i <= L; i++) {\r\nx_tilde[i] = x_tilde[i] / (1 << Q_x);\r\nB1_tmp[i] = B1_tmp[i] / (1 << Q_B1);\r\nB2_tmp[i] = B2_tmp[i] / (1 << Q_B2);\r\nbeta_raw = beta_raw + B1_tmp[i] * x_tilde[i];\r\nalpha_raw = alpha_raw + B2_tmp[i] * x_tilde[i];\r\n}\r\nscale_B =\r\n((sum_y_quad / scale_factor) * (L + 1) -\r\n(sum_y_sqr / scale_factor) * sum_y_sqr) * scale_factor;\r\nQ_scale_B = find_proper_scale(find_expn(abs(scale_B)), 10);\r\nscale_B = scale_B / (1 << Q_scale_B);\r\nif (scale_B == 0)\r\nreturn false;\r\nQ_beta = find_proper_scale(find_expn(abs(beta_raw)), 10);\r\nQ_alpha = find_proper_scale(find_expn(abs(alpha_raw)), 10);\r\nbeta_raw = beta_raw / (1 << Q_beta);\r\nalpha_raw = alpha_raw / (1 << Q_alpha);\r\nalpha = (alpha_raw << 10) / scale_B;\r\nbeta = (beta_raw << 10) / scale_B;\r\norder_1 = 3 * M - Q_x - Q_B1 - Q_beta + 10 + Q_scale_B;\r\norder_2 = 3 * M - Q_x - Q_B2 - Q_alpha + 10 + Q_scale_B;\r\norder1_5x = order_1 / 5;\r\norder2_3x = order_2 / 3;\r\norder1_5x_rem = order_1 - 5 * order1_5x;\r\norder2_3x_rem = order_2 - 3 * order2_3x;\r\nfor (i = 0; i < PAPRD_TABLE_SZ; i++) {\r\ntmp = i * 32;\r\ny5 = ((beta * tmp) >> 6) >> order1_5x;\r\ny5 = (y5 * tmp) >> order1_5x;\r\ny5 = (y5 * tmp) >> order1_5x;\r\ny5 = (y5 * tmp) >> order1_5x;\r\ny5 = (y5 * tmp) >> order1_5x;\r\ny5 = y5 >> order1_5x_rem;\r\ny3 = (alpha * tmp) >> order2_3x;\r\ny3 = (y3 * tmp) >> order2_3x;\r\ny3 = (y3 * tmp) >> order2_3x;\r\ny3 = y3 >> order2_3x_rem;\r\nPA_in[i] = y5 + y3 + (256 * tmp) / G_fxp;\r\nif (i >= 2) {\r\ntmp = PA_in[i] - PA_in[i - 1];\r\nif (tmp < 0)\r\nPA_in[i] =\r\nPA_in[i - 1] + (PA_in[i - 1] -\r\nPA_in[i - 2]);\r\n}\r\nPA_in[i] = (PA_in[i] < 1400) ? PA_in[i] : 1400;\r\n}\r\nbeta_raw = 0;\r\nalpha_raw = 0;\r\nfor (i = 0; i <= L; i++) {\r\nint theta_tilde =\r\n((theta[i + I] << M) + y_est[i + I]) / y_est[i + I];\r\ntheta_tilde =\r\n((theta_tilde << M) + y_est[i + I]) / y_est[i + I];\r\ntheta_tilde =\r\n((theta_tilde << M) + y_est[i + I]) / y_est[i + I];\r\nbeta_raw = beta_raw + B1_tmp[i] * theta_tilde;\r\nalpha_raw = alpha_raw + B2_tmp[i] * theta_tilde;\r\n}\r\nQ_beta = find_proper_scale(find_expn(abs(beta_raw)), 10);\r\nQ_alpha = find_proper_scale(find_expn(abs(alpha_raw)), 10);\r\nbeta_raw = beta_raw / (1 << Q_beta);\r\nalpha_raw = alpha_raw / (1 << Q_alpha);\r\nalpha = (alpha_raw << 10) / scale_B;\r\nbeta = (beta_raw << 10) / scale_B;\r\norder_1 = 3 * M - Q_x - Q_B1 - Q_beta + 10 + Q_scale_B + 5;\r\norder_2 = 3 * M - Q_x - Q_B2 - Q_alpha + 10 + Q_scale_B + 5;\r\norder1_5x = order_1 / 5;\r\norder2_3x = order_2 / 3;\r\norder1_5x_rem = order_1 - 5 * order1_5x;\r\norder2_3x_rem = order_2 - 3 * order2_3x;\r\nfor (i = 0; i < PAPRD_TABLE_SZ; i++) {\r\nint PA_angle;\r\nif (i == 4)\r\ncontinue;\r\ntmp = i * 32;\r\nif (beta > 0)\r\ny5 = (((beta * tmp - 64) >> 6) -\r\n(1 << order1_5x)) / (1 << order1_5x);\r\nelse\r\ny5 = ((((beta * tmp - 64) >> 6) +\r\n(1 << order1_5x)) / (1 << order1_5x));\r\ny5 = (y5 * tmp) / (1 << order1_5x);\r\ny5 = (y5 * tmp) / (1 << order1_5x);\r\ny5 = (y5 * tmp) / (1 << order1_5x);\r\ny5 = (y5 * tmp) / (1 << order1_5x);\r\ny5 = y5 / (1 << order1_5x_rem);\r\nif (beta > 0)\r\ny3 = (alpha * tmp -\r\n(1 << order2_3x)) / (1 << order2_3x);\r\nelse\r\ny3 = (alpha * tmp +\r\n(1 << order2_3x)) / (1 << order2_3x);\r\ny3 = (y3 * tmp) / (1 << order2_3x);\r\ny3 = (y3 * tmp) / (1 << order2_3x);\r\ny3 = y3 / (1 << order2_3x_rem);\r\nif (i < 4) {\r\nPA_angle = 0;\r\n} else {\r\nPA_angle = y5 + y3;\r\nif (PA_angle < -150)\r\nPA_angle = -150;\r\nelse if (PA_angle > 150)\r\nPA_angle = 150;\r\n}\r\npa_table[i] = ((PA_in[i] & 0x7ff) << 11) + (PA_angle & 0x7ff);\r\nif (i == 5) {\r\nPA_angle = (PA_angle + 2) >> 1;\r\npa_table[i - 1] = ((PA_in[i - 1] & 0x7ff) << 11) +\r\n(PA_angle & 0x7ff);\r\n}\r\n}\r\n*gain = G_fxp;\r\nreturn true;\r\n}\r\nvoid ar9003_paprd_populate_single_table(struct ath_hw *ah,\r\nstruct ath9k_hw_cal_data *caldata,\r\nint chain)\r\n{\r\nu32 *paprd_table_val = caldata->pa_table[chain];\r\nu32 small_signal_gain = caldata->small_signal_gain[chain];\r\nu32 training_power = ah->paprd_training_power;\r\nu32 reg = 0;\r\nint i;\r\nif (chain == 0)\r\nreg = AR_PHY_PAPRD_MEM_TAB_B0;\r\nelse if (chain == 1)\r\nreg = AR_PHY_PAPRD_MEM_TAB_B1;\r\nelse if (chain == 2)\r\nreg = AR_PHY_PAPRD_MEM_TAB_B2;\r\nfor (i = 0; i < PAPRD_TABLE_SZ; i++) {\r\nREG_WRITE(ah, reg, paprd_table_val[i]);\r\nreg = reg + 4;\r\n}\r\nif (chain == 0)\r\nreg = AR_PHY_PA_GAIN123_B0;\r\nelse if (chain == 1)\r\nreg = AR_PHY_PA_GAIN123_B1;\r\nelse\r\nreg = AR_PHY_PA_GAIN123_B2;\r\nREG_RMW_FIELD(ah, reg, AR_PHY_PA_GAIN123_PA_GAIN1, small_signal_gain);\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_CTRL1_B0,\r\nAR_PHY_PAPRD_CTRL1_PAPRD_POWER_AT_AM2AM_CAL,\r\ntraining_power);\r\nif (ah->caps.tx_chainmask & BIT(1))\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_CTRL1_B1,\r\nAR_PHY_PAPRD_CTRL1_PAPRD_POWER_AT_AM2AM_CAL,\r\ntraining_power);\r\nif (ah->caps.tx_chainmask & BIT(2))\r\nREG_RMW_FIELD(ah, AR_PHY_PAPRD_CTRL1_B2,\r\nAR_PHY_PAPRD_CTRL1_PAPRD_POWER_AT_AM2AM_CAL,\r\ntraining_power);\r\n}\r\nint ar9003_paprd_setup_gain_table(struct ath_hw *ah, int chain)\r\n{\r\nunsigned int i, desired_gain, gain_index;\r\nunsigned int train_power = ah->paprd_training_power;\r\ndesired_gain = ar9003_get_desired_gain(ah, chain, train_power);\r\ngain_index = 0;\r\nfor (i = 0; i < PAPRD_GAIN_TABLE_ENTRIES; i++) {\r\nif (ah->paprd_gain_table_index[i] >= desired_gain)\r\nbreak;\r\ngain_index++;\r\n}\r\nar9003_tx_force_gain(ah, gain_index);\r\nREG_CLR_BIT(ah, AR_PHY_PAPRD_TRAINER_STAT1,\r\nAR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE);\r\nreturn 0;\r\n}\r\nint ar9003_paprd_create_curve(struct ath_hw *ah,\r\nstruct ath9k_hw_cal_data *caldata, int chain)\r\n{\r\nu16 *small_signal_gain = &caldata->small_signal_gain[chain];\r\nu32 *pa_table = caldata->pa_table[chain];\r\nu32 *data_L, *data_U;\r\nint i, status = 0;\r\nu32 *buf;\r\nu32 reg;\r\nmemset(caldata->pa_table[chain], 0, sizeof(caldata->pa_table[chain]));\r\nbuf = kmalloc(2 * 48 * sizeof(u32), GFP_ATOMIC);\r\nif (!buf)\r\nreturn -ENOMEM;\r\ndata_L = &buf[0];\r\ndata_U = &buf[48];\r\nREG_CLR_BIT(ah, AR_PHY_CHAN_INFO_MEMORY,\r\nAR_PHY_CHAN_INFO_MEMORY_CHANINFOMEM_S2_READ);\r\nreg = AR_PHY_CHAN_INFO_TAB_0;\r\nfor (i = 0; i < 48; i++)\r\ndata_L[i] = REG_READ(ah, reg + (i << 2));\r\nREG_SET_BIT(ah, AR_PHY_CHAN_INFO_MEMORY,\r\nAR_PHY_CHAN_INFO_MEMORY_CHANINFOMEM_S2_READ);\r\nfor (i = 0; i < 48; i++)\r\ndata_U[i] = REG_READ(ah, reg + (i << 2));\r\nif (!create_pa_curve(data_L, data_U, pa_table, small_signal_gain))\r\nstatus = -2;\r\nREG_CLR_BIT(ah, AR_PHY_PAPRD_TRAINER_STAT1,\r\nAR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE);\r\nkfree(buf);\r\nreturn status;\r\n}\r\nint ar9003_paprd_init_table(struct ath_hw *ah)\r\n{\r\nint ret;\r\nret = ar9003_paprd_setup_single_table(ah);\r\nif (ret < 0)\r\nreturn ret;\r\nar9003_paprd_get_gain_table(ah);\r\nreturn 0;\r\n}\r\nbool ar9003_paprd_is_done(struct ath_hw *ah)\r\n{\r\nint paprd_done, agc2_pwr;\r\npaprd_done = REG_READ_FIELD(ah, AR_PHY_PAPRD_TRAINER_STAT1,\r\nAR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE);\r\nif (paprd_done == 0x1) {\r\nagc2_pwr = REG_READ_FIELD(ah, AR_PHY_PAPRD_TRAINER_STAT1,\r\nAR_PHY_PAPRD_TRAINER_STAT1_PAPRD_AGC2_PWR);\r\nath_dbg(ath9k_hw_common(ah), CALIBRATE,\r\n"AGC2_PWR = 0x%x training done = 0x%x\n",\r\nagc2_pwr, paprd_done);\r\nif (agc2_pwr <= PAPRD_IDEAL_AGC2_PWR_RANGE)\r\npaprd_done = 0;\r\n}\r\nreturn !!paprd_done;\r\n}

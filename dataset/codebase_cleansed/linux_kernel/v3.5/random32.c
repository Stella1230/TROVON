u32 prandom32(struct rnd_state *state)\r\n{\r\n#define TAUSWORTHE(s,a,b,c,d) ((s&c)<<d) ^ (((s <<a) ^ s)>>b)\r\nstate->s1 = TAUSWORTHE(state->s1, 13, 19, 4294967294UL, 12);\r\nstate->s2 = TAUSWORTHE(state->s2, 2, 25, 4294967288UL, 4);\r\nstate->s3 = TAUSWORTHE(state->s3, 3, 11, 4294967280UL, 17);\r\nreturn (state->s1 ^ state->s2 ^ state->s3);\r\n}\r\nu32 random32(void)\r\n{\r\nunsigned long r;\r\nstruct rnd_state *state = &get_cpu_var(net_rand_state);\r\nr = prandom32(state);\r\nput_cpu_var(state);\r\nreturn r;\r\n}\r\nvoid srandom32(u32 entropy)\r\n{\r\nint i;\r\nfor_each_possible_cpu (i) {\r\nstruct rnd_state *state = &per_cpu(net_rand_state, i);\r\nstate->s1 = __seed(state->s1 ^ entropy, 1);\r\n}\r\n}\r\nstatic int __init random32_init(void)\r\n{\r\nint i;\r\nfor_each_possible_cpu(i) {\r\nstruct rnd_state *state = &per_cpu(net_rand_state,i);\r\n#define LCG(x) ((x) * 69069)\r\nstate->s1 = __seed(LCG(i + jiffies), 1);\r\nstate->s2 = __seed(LCG(state->s1), 7);\r\nstate->s3 = __seed(LCG(state->s2), 15);\r\nprandom32(state);\r\nprandom32(state);\r\nprandom32(state);\r\nprandom32(state);\r\nprandom32(state);\r\nprandom32(state);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init random32_reseed(void)\r\n{\r\nint i;\r\nfor_each_possible_cpu(i) {\r\nstruct rnd_state *state = &per_cpu(net_rand_state,i);\r\nu32 seeds[3];\r\nget_random_bytes(&seeds, sizeof(seeds));\r\nstate->s1 = __seed(seeds[0], 1);\r\nstate->s2 = __seed(seeds[1], 7);\r\nstate->s3 = __seed(seeds[2], 15);\r\nprandom32(state);\r\n}\r\nreturn 0;\r\n}

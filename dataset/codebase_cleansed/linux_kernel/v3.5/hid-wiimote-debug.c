static ssize_t wiidebug_eeprom_read(struct file *f, char __user *u, size_t s,\r\nloff_t *off)\r\n{\r\nstruct wiimote_debug *dbg = f->private_data;\r\nstruct wiimote_data *wdata = dbg->wdata;\r\nunsigned long flags;\r\nssize_t ret;\r\nchar buf[16];\r\n__u16 size;\r\nif (s == 0)\r\nreturn -EINVAL;\r\nif (*off > 0xffffff)\r\nreturn 0;\r\nif (s > 16)\r\ns = 16;\r\nret = wiimote_cmd_acquire(wdata);\r\nif (ret)\r\nreturn ret;\r\nspin_lock_irqsave(&wdata->state.lock, flags);\r\nwdata->state.cmd_read_size = s;\r\nwdata->state.cmd_read_buf = buf;\r\nwiimote_cmd_set(wdata, WIIPROTO_REQ_RMEM, *off & 0xffff);\r\nwiiproto_req_reeprom(wdata, *off, s);\r\nspin_unlock_irqrestore(&wdata->state.lock, flags);\r\nret = wiimote_cmd_wait(wdata);\r\nif (!ret)\r\nsize = wdata->state.cmd_read_size;\r\nspin_lock_irqsave(&wdata->state.lock, flags);\r\nwdata->state.cmd_read_buf = NULL;\r\nspin_unlock_irqrestore(&wdata->state.lock, flags);\r\nwiimote_cmd_release(wdata);\r\nif (ret)\r\nreturn ret;\r\nelse if (size == 0)\r\nreturn -EIO;\r\nif (copy_to_user(u, buf, size))\r\nreturn -EFAULT;\r\n*off += size;\r\nret = size;\r\nreturn ret;\r\n}\r\nstatic int wiidebug_drm_show(struct seq_file *f, void *p)\r\n{\r\nstruct wiimote_debug *dbg = f->private;\r\nconst char *str = NULL;\r\nunsigned long flags;\r\n__u8 drm;\r\nspin_lock_irqsave(&dbg->wdata->state.lock, flags);\r\ndrm = dbg->wdata->state.drm;\r\nspin_unlock_irqrestore(&dbg->wdata->state.lock, flags);\r\nif (drm < WIIPROTO_REQ_MAX)\r\nstr = wiidebug_drmmap[drm];\r\nif (!str)\r\nstr = "unknown";\r\nseq_printf(f, "%s\n", str);\r\nreturn 0;\r\n}\r\nstatic int wiidebug_drm_open(struct inode *i, struct file *f)\r\n{\r\nreturn single_open(f, wiidebug_drm_show, i->i_private);\r\n}\r\nstatic ssize_t wiidebug_drm_write(struct file *f, const char __user *u,\r\nsize_t s, loff_t *off)\r\n{\r\nstruct wiimote_debug *dbg = f->private_data;\r\nunsigned long flags;\r\nchar buf[16];\r\nssize_t len;\r\nint i;\r\nif (s == 0)\r\nreturn -EINVAL;\r\nlen = min((size_t) 15, s);\r\nif (copy_from_user(buf, u, len))\r\nreturn -EFAULT;\r\nbuf[15] = 0;\r\nfor (i = 0; i < WIIPROTO_REQ_MAX; ++i) {\r\nif (!wiidebug_drmmap[i])\r\ncontinue;\r\nif (!strcasecmp(buf, wiidebug_drmmap[i]))\r\nbreak;\r\n}\r\nif (i == WIIPROTO_REQ_MAX)\r\ni = simple_strtoul(buf, NULL, 10);\r\nspin_lock_irqsave(&dbg->wdata->state.lock, flags);\r\nwiiproto_req_drm(dbg->wdata, (__u8) i);\r\nspin_unlock_irqrestore(&dbg->wdata->state.lock, flags);\r\nreturn len;\r\n}\r\nint wiidebug_init(struct wiimote_data *wdata)\r\n{\r\nstruct wiimote_debug *dbg;\r\nunsigned long flags;\r\nint ret = -ENOMEM;\r\ndbg = kzalloc(sizeof(*dbg), GFP_KERNEL);\r\nif (!dbg)\r\nreturn -ENOMEM;\r\ndbg->wdata = wdata;\r\ndbg->eeprom = debugfs_create_file("eeprom", S_IRUSR,\r\ndbg->wdata->hdev->debug_dir, dbg, &wiidebug_eeprom_fops);\r\nif (!dbg->eeprom)\r\ngoto err;\r\ndbg->drm = debugfs_create_file("drm", S_IRUSR,\r\ndbg->wdata->hdev->debug_dir, dbg, &wiidebug_drm_fops);\r\nif (!dbg->drm)\r\ngoto err_drm;\r\nspin_lock_irqsave(&wdata->state.lock, flags);\r\nwdata->debug = dbg;\r\nspin_unlock_irqrestore(&wdata->state.lock, flags);\r\nreturn 0;\r\nerr_drm:\r\ndebugfs_remove(dbg->eeprom);\r\nerr:\r\nkfree(dbg);\r\nreturn ret;\r\n}\r\nvoid wiidebug_deinit(struct wiimote_data *wdata)\r\n{\r\nstruct wiimote_debug *dbg = wdata->debug;\r\nunsigned long flags;\r\nif (!dbg)\r\nreturn;\r\nspin_lock_irqsave(&wdata->state.lock, flags);\r\nwdata->debug = NULL;\r\nspin_unlock_irqrestore(&wdata->state.lock, flags);\r\ndebugfs_remove(dbg->drm);\r\ndebugfs_remove(dbg->eeprom);\r\nkfree(dbg);\r\n}

static int ad1843_read_bits(struct snd_ad1843 *ad1843,\r\nconst struct ad1843_bitfield *field)\r\n{\r\nint w;\r\nw = ad1843->read(ad1843->chip, field->reg);\r\nreturn w >> field->lo_bit & ((1 << field->nbits) - 1);\r\n}\r\nstatic int ad1843_write_bits(struct snd_ad1843 *ad1843,\r\nconst struct ad1843_bitfield *field,\r\nint newval)\r\n{\r\nint w, mask, oldval, newbits;\r\nw = ad1843->read(ad1843->chip, field->reg);\r\nmask = ((1 << field->nbits) - 1) << field->lo_bit;\r\noldval = (w & mask) >> field->lo_bit;\r\nnewbits = (newval << field->lo_bit) & mask;\r\nw = (w & ~mask) | newbits;\r\nad1843->write(ad1843->chip, field->reg, w);\r\nreturn oldval;\r\n}\r\nstatic void ad1843_read_multi(struct snd_ad1843 *ad1843, int argcount, ...)\r\n{\r\nva_list ap;\r\nconst struct ad1843_bitfield *fp;\r\nint w = 0, mask, *value, reg = -1;\r\nva_start(ap, argcount);\r\nwhile (--argcount >= 0) {\r\nfp = va_arg(ap, const struct ad1843_bitfield *);\r\nvalue = va_arg(ap, int *);\r\nif (reg == -1) {\r\nreg = fp->reg;\r\nw = ad1843->read(ad1843->chip, reg);\r\n}\r\nmask = (1 << fp->nbits) - 1;\r\n*value = w >> fp->lo_bit & mask;\r\n}\r\nva_end(ap);\r\n}\r\nstatic void ad1843_write_multi(struct snd_ad1843 *ad1843, int argcount, ...)\r\n{\r\nva_list ap;\r\nint reg;\r\nconst struct ad1843_bitfield *fp;\r\nint value;\r\nint w, m, mask, bits;\r\nmask = 0;\r\nbits = 0;\r\nreg = -1;\r\nva_start(ap, argcount);\r\nwhile (--argcount >= 0) {\r\nfp = va_arg(ap, const struct ad1843_bitfield *);\r\nvalue = va_arg(ap, int);\r\nif (reg == -1)\r\nreg = fp->reg;\r\nelse\r\nBUG_ON(reg != fp->reg);\r\nm = ((1 << fp->nbits) - 1) << fp->lo_bit;\r\nmask |= m;\r\nbits |= (value << fp->lo_bit) & m;\r\n}\r\nva_end(ap);\r\nif (~mask & 0xFFFF)\r\nw = ad1843->read(ad1843->chip, reg);\r\nelse\r\nw = 0;\r\nw = (w & ~mask) | bits;\r\nad1843->write(ad1843->chip, reg, w);\r\n}\r\nint ad1843_get_gain_max(struct snd_ad1843 *ad1843, int id)\r\n{\r\nconst struct ad1843_gain *gp = ad1843_gain[id];\r\nint ret;\r\nret = (1 << gp->lfield->nbits);\r\nif (!gp->lmute)\r\nret -= 1;\r\nreturn ret;\r\n}\r\nint ad1843_get_gain(struct snd_ad1843 *ad1843, int id)\r\n{\r\nint lg, rg, lm, rm;\r\nconst struct ad1843_gain *gp = ad1843_gain[id];\r\nunsigned short mask = (1 << gp->lfield->nbits) - 1;\r\nad1843_read_multi(ad1843, 2, gp->lfield, &lg, gp->rfield, &rg);\r\nif (gp->negative) {\r\nlg = mask - lg;\r\nrg = mask - rg;\r\n}\r\nif (gp->lmute) {\r\nad1843_read_multi(ad1843, 2, gp->lmute, &lm, gp->rmute, &rm);\r\nif (lm)\r\nlg = 0;\r\nif (rm)\r\nrg = 0;\r\n}\r\nreturn lg << 0 | rg << 8;\r\n}\r\nint ad1843_set_gain(struct snd_ad1843 *ad1843, int id, int newval)\r\n{\r\nconst struct ad1843_gain *gp = ad1843_gain[id];\r\nunsigned short mask = (1 << gp->lfield->nbits) - 1;\r\nint lg = (newval >> 0) & mask;\r\nint rg = (newval >> 8) & mask;\r\nint lm = (lg == 0) ? 1 : 0;\r\nint rm = (rg == 0) ? 1 : 0;\r\nif (gp->negative) {\r\nlg = mask - lg;\r\nrg = mask - rg;\r\n}\r\nif (gp->lmute)\r\nad1843_write_multi(ad1843, 2, gp->lmute, lm, gp->rmute, rm);\r\nad1843_write_multi(ad1843, 2, gp->lfield, lg, gp->rfield, rg);\r\nreturn ad1843_get_gain(ad1843, id);\r\n}\r\nint ad1843_get_recsrc(struct snd_ad1843 *ad1843)\r\n{\r\nint val = ad1843_read_bits(ad1843, &ad1843_LSS);\r\nif (val < 0 || val > 2) {\r\nval = 2;\r\nad1843_write_multi(ad1843, 2,\r\n&ad1843_LSS, val, &ad1843_RSS, val);\r\n}\r\nreturn val;\r\n}\r\nint ad1843_set_recsrc(struct snd_ad1843 *ad1843, int newsrc)\r\n{\r\nif (newsrc < 0 || newsrc > 2)\r\nreturn -EINVAL;\r\nad1843_write_multi(ad1843, 2, &ad1843_LSS, newsrc, &ad1843_RSS, newsrc);\r\nreturn newsrc;\r\n}\r\nvoid ad1843_setup_dac(struct snd_ad1843 *ad1843,\r\nunsigned int id,\r\nunsigned int framerate,\r\nsnd_pcm_format_t fmt,\r\nunsigned int channels)\r\n{\r\nint ad_fmt = 0, ad_mode = 0;\r\nswitch (fmt) {\r\ncase SNDRV_PCM_FORMAT_S8:\r\nad_fmt = 0;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_U8:\r\nad_fmt = 0;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\nad_fmt = 1;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_MU_LAW:\r\nad_fmt = 2;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_A_LAW:\r\nad_fmt = 3;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (channels) {\r\ncase 2:\r\nad_mode = 0;\r\nbreak;\r\ncase 1:\r\nad_mode = 1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (id) {\r\nad1843_write_bits(ad1843, &ad1843_C2C, framerate);\r\nad1843_write_multi(ad1843, 2,\r\n&ad1843_DA2SM, ad_mode,\r\n&ad1843_DA2F, ad_fmt);\r\n} else {\r\nad1843_write_bits(ad1843, &ad1843_C1C, framerate);\r\nad1843_write_multi(ad1843, 2,\r\n&ad1843_DA1SM, ad_mode,\r\n&ad1843_DA1F, ad_fmt);\r\n}\r\n}\r\nvoid ad1843_shutdown_dac(struct snd_ad1843 *ad1843, unsigned int id)\r\n{\r\nif (id)\r\nad1843_write_bits(ad1843, &ad1843_DA2F, 1);\r\nelse\r\nad1843_write_bits(ad1843, &ad1843_DA1F, 1);\r\n}\r\nvoid ad1843_setup_adc(struct snd_ad1843 *ad1843,\r\nunsigned int framerate,\r\nsnd_pcm_format_t fmt,\r\nunsigned int channels)\r\n{\r\nint da_fmt = 0;\r\nswitch (fmt) {\r\ncase SNDRV_PCM_FORMAT_S8: da_fmt = 0; break;\r\ncase SNDRV_PCM_FORMAT_U8: da_fmt = 0; break;\r\ncase SNDRV_PCM_FORMAT_S16_LE: da_fmt = 1; break;\r\ncase SNDRV_PCM_FORMAT_MU_LAW: da_fmt = 2; break;\r\ncase SNDRV_PCM_FORMAT_A_LAW: da_fmt = 3; break;\r\ndefault: break;\r\n}\r\nad1843_write_bits(ad1843, &ad1843_C3C, framerate);\r\nad1843_write_multi(ad1843, 2,\r\n&ad1843_ADLF, da_fmt, &ad1843_ADRF, da_fmt);\r\n}\r\nvoid ad1843_shutdown_adc(struct snd_ad1843 *ad1843)\r\n{\r\n}\r\nint ad1843_init(struct snd_ad1843 *ad1843)\r\n{\r\nunsigned long later;\r\nif (ad1843_read_bits(ad1843, &ad1843_INIT) != 0) {\r\nprintk(KERN_ERR "ad1843: AD1843 won't initialize\n");\r\nreturn -EIO;\r\n}\r\nad1843_write_bits(ad1843, &ad1843_SCF, 1);\r\nad1843_write_bits(ad1843, &ad1843_PDNI, 0);\r\nlater = jiffies + msecs_to_jiffies(500);\r\nwhile (ad1843_read_bits(ad1843, &ad1843_PDNO)) {\r\nif (time_after(jiffies, later)) {\r\nprintk(KERN_ERR\r\n"ad1843: AD1843 won't power up\n");\r\nreturn -EIO;\r\n}\r\nschedule_timeout_interruptible(5);\r\n}\r\nad1843_write_multi(ad1843, 3,\r\n&ad1843_C1EN, 1,\r\n&ad1843_C2EN, 1,\r\n&ad1843_C3EN, 1);\r\nad1843_write_multi(ad1843, 4,\r\n&ad1843_DA1C, 1,\r\n&ad1843_DA2C, 2,\r\n&ad1843_ADLC, 3,\r\n&ad1843_ADRC, 3);\r\nad1843_write_bits(ad1843, &ad1843_ADTLK, 1);\r\nad1843_write_multi(ad1843, 7,\r\n&ad1843_ANAEN, 1,\r\n&ad1843_AAMEN, 1,\r\n&ad1843_DA1EN, 1,\r\n&ad1843_DA2EN, 1,\r\n&ad1843_DDMEN, 1,\r\n&ad1843_ADLEN, 1,\r\n&ad1843_ADREN, 1);\r\nad1843_set_gain(ad1843, AD1843_GAIN_RECLEV, 0);\r\nad1843_set_gain(ad1843, AD1843_GAIN_LINE, 0);\r\nad1843_set_gain(ad1843, AD1843_GAIN_LINE_2, 0);\r\nad1843_set_gain(ad1843, AD1843_GAIN_MIC, 0);\r\nad1843_set_gain(ad1843, AD1843_GAIN_PCM_0, 0);\r\nad1843_set_gain(ad1843, AD1843_GAIN_PCM_1, 0);\r\nad1843_write_multi(ad1843, 2, &ad1843_LDA1GM, 0, &ad1843_RDA1GM, 0);\r\nad1843_write_multi(ad1843, 2, &ad1843_LDA2GM, 0, &ad1843_RDA2GM, 0);\r\nad1843_set_recsrc(ad1843, 2);\r\nad1843_write_multi(ad1843, 2, &ad1843_LMGE, 1, &ad1843_RMGE, 1);\r\nad1843_write_multi(ad1843, 3,\r\n&ad1843_HPOS, 1,\r\n&ad1843_HPOM, 0,\r\n&ad1843_MPOM, 0);\r\nreturn 0;\r\n}

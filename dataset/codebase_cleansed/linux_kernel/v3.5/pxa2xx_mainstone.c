static int mst_pcmcia_hw_init(struct soc_pcmcia_socket *skt)\r\n{\r\nif (skt->nr == 0) {\r\nskt->socket.pci_irq = MAINSTONE_S0_IRQ;\r\nskt->stat[SOC_STAT_CD].irq = MAINSTONE_S0_CD_IRQ;\r\nskt->stat[SOC_STAT_CD].name = "PCMCIA0 CD";\r\nskt->stat[SOC_STAT_BVD1].irq = MAINSTONE_S0_STSCHG_IRQ;\r\nskt->stat[SOC_STAT_BVD1].name = "PCMCIA0 STSCHG";\r\n} else {\r\nskt->socket.pci_irq = MAINSTONE_S1_IRQ;\r\nskt->stat[SOC_STAT_CD].irq = MAINSTONE_S1_CD_IRQ;\r\nskt->stat[SOC_STAT_CD].name = "PCMCIA1 CD";\r\nskt->stat[SOC_STAT_BVD1].irq = MAINSTONE_S1_STSCHG_IRQ;\r\nskt->stat[SOC_STAT_BVD1].name = "PCMCIA1 STSCHG";\r\n}\r\nreturn 0;\r\n}\r\nstatic void mst_pcmcia_socket_state(struct soc_pcmcia_socket *skt,\r\nstruct pcmcia_state *state)\r\n{\r\nunsigned long status, flip;\r\nstatus = (skt->nr == 0) ? MST_PCMCIA0 : MST_PCMCIA1;\r\nflip = (status ^ mst_pcmcia_status[skt->nr]) & MST_PCMCIA_nSTSCHG_BVD1;\r\nif (flip) {\r\nmst_pcmcia_status[skt->nr] = status;\r\nif (status & MST_PCMCIA_nSTSCHG_BVD1)\r\nenable_irq( (skt->nr == 0) ? MAINSTONE_S0_STSCHG_IRQ\r\n: MAINSTONE_S1_STSCHG_IRQ );\r\nelse\r\ndisable_irq( (skt->nr == 0) ? MAINSTONE_S0_STSCHG_IRQ\r\n: MAINSTONE_S1_STSCHG_IRQ );\r\n}\r\nstate->detect = (status & MST_PCMCIA_nCD) ? 0 : 1;\r\nstate->ready = (status & MST_PCMCIA_nIRQ) ? 1 : 0;\r\nstate->bvd1 = (status & MST_PCMCIA_nSTSCHG_BVD1) ? 1 : 0;\r\nstate->bvd2 = (status & MST_PCMCIA_nSPKR_BVD2) ? 1 : 0;\r\nstate->vs_3v = (status & MST_PCMCIA_nVS1) ? 0 : 1;\r\nstate->vs_Xv = (status & MST_PCMCIA_nVS2) ? 0 : 1;\r\n}\r\nstatic int mst_pcmcia_configure_socket(struct soc_pcmcia_socket *skt,\r\nconst socket_state_t *state)\r\n{\r\nunsigned long power = 0;\r\nint ret = 0;\r\nswitch (state->Vcc) {\r\ncase 0: power |= MST_PCMCIA_PWR_VCC_0; break;\r\ncase 33: power |= MST_PCMCIA_PWR_VCC_33; break;\r\ncase 50: power |= MST_PCMCIA_PWR_VCC_50; break;\r\ndefault:\r\nprintk(KERN_ERR "%s(): bad Vcc %u\n",\r\n__func__, state->Vcc);\r\nret = -1;\r\n}\r\nswitch (state->Vpp) {\r\ncase 0: power |= MST_PCMCIA_PWR_VPP_0; break;\r\ncase 120: power |= MST_PCMCIA_PWR_VPP_120; break;\r\ndefault:\r\nif(state->Vpp == state->Vcc) {\r\npower |= MST_PCMCIA_PWR_VPP_VCC;\r\n} else {\r\nprintk(KERN_ERR "%s(): bad Vpp %u\n",\r\n__func__, state->Vpp);\r\nret = -1;\r\n}\r\n}\r\nif (state->flags & SS_RESET)\r\npower |= MST_PCMCIA_RESET;\r\nswitch (skt->nr) {\r\ncase 0: MST_PCMCIA0 = power; break;\r\ncase 1: MST_PCMCIA1 = power; break;\r\ndefault: ret = -1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init mst_pcmcia_init(void)\r\n{\r\nint ret;\r\nif (!machine_is_mainstone())\r\nreturn -ENODEV;\r\nmst_pcmcia_device = platform_device_alloc("pxa2xx-pcmcia", -1);\r\nif (!mst_pcmcia_device)\r\nreturn -ENOMEM;\r\nret = platform_device_add_data(mst_pcmcia_device, &mst_pcmcia_ops,\r\nsizeof(mst_pcmcia_ops));\r\nif (ret == 0)\r\nret = platform_device_add(mst_pcmcia_device);\r\nif (ret)\r\nplatform_device_put(mst_pcmcia_device);\r\nreturn ret;\r\n}\r\nstatic void __exit mst_pcmcia_exit(void)\r\n{\r\nplatform_device_unregister(mst_pcmcia_device);\r\n}

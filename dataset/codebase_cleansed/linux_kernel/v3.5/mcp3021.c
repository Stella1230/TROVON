static int mcp3021_read16(struct i2c_client *client)\r\n{\r\nint ret;\r\nu16 reg;\r\n__be16 buf;\r\nret = i2c_master_recv(client, (char *)&buf, 2);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret != 2)\r\nreturn -EIO;\r\nreg = be16_to_cpu(buf);\r\nreg = (reg >> MCP3021_SAR_SHIFT) & MCP3021_SAR_MASK;\r\nreturn reg;\r\n}\r\nstatic inline u16 volts_from_reg(u16 vdd, u16 val)\r\n{\r\nif (val == 0)\r\nreturn 0;\r\nval = val * MCP3021_OUTPUT_SCALE - MCP3021_OUTPUT_SCALE / 2;\r\nreturn val * DIV_ROUND_CLOSEST(vdd,\r\n(1 << MCP3021_OUTPUT_RES) * MCP3021_OUTPUT_SCALE);\r\n}\r\nstatic ssize_t show_in_input(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct mcp3021_data *data = i2c_get_clientdata(client);\r\nint reg, in_input;\r\nreg = mcp3021_read16(client);\r\nif (reg < 0)\r\nreturn reg;\r\nin_input = volts_from_reg(data->vdd, reg);\r\nreturn sprintf(buf, "%d\n", in_input);\r\n}\r\nstatic int mcp3021_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nint err;\r\nstruct mcp3021_data *data = NULL;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C))\r\nreturn -ENODEV;\r\ndata = kzalloc(sizeof(struct mcp3021_data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, data);\r\nif (client->dev.platform_data) {\r\ndata->vdd = *(u32 *)client->dev.platform_data;\r\nif (data->vdd > MCP3021_VDD_MAX ||\r\ndata->vdd < MCP3021_VDD_MIN) {\r\nerr = -EINVAL;\r\ngoto exit_free;\r\n}\r\n} else\r\ndata->vdd = MCP3021_VDD_REF;\r\nerr = sysfs_create_file(&client->dev.kobj, &dev_attr_in0_input.attr);\r\nif (err)\r\ngoto exit_free;\r\ndata->hwmon_dev = hwmon_device_register(&client->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto exit_remove;\r\n}\r\nreturn 0;\r\nexit_remove:\r\nsysfs_remove_file(&client->dev.kobj, &dev_attr_in0_input.attr);\r\nexit_free:\r\nkfree(data);\r\nreturn err;\r\n}\r\nstatic int mcp3021_remove(struct i2c_client *client)\r\n{\r\nstruct mcp3021_data *data = i2c_get_clientdata(client);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nsysfs_remove_file(&client->dev.kobj, &dev_attr_in0_input.attr);\r\nkfree(data);\r\nreturn 0;\r\n}

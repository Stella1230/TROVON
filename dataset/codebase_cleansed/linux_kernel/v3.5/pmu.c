static void si_pmu_res_masks(struct si_pub *sih, u32 * pmin, u32 * pmax)\r\n{\r\nu32 min_mask = 0, max_mask = 0;\r\nuint rsrcs;\r\nrsrcs = (ai_get_pmucaps(sih) & PCAP_RC_MASK) >> PCAP_RC_SHIFT;\r\nswitch (ai_get_chip_id(sih)) {\r\ncase BCM43224_CHIP_ID:\r\ncase BCM43225_CHIP_ID:\r\nbreak;\r\ncase BCM4313_CHIP_ID:\r\nmin_mask = PMURES_BIT(RES4313_BB_PU_RSRC) |\r\nPMURES_BIT(RES4313_XTAL_PU_RSRC) |\r\nPMURES_BIT(RES4313_ALP_AVAIL_RSRC) |\r\nPMURES_BIT(RES4313_BB_PLL_PWRSW_RSRC);\r\nmax_mask = 0xffff;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n*pmin = min_mask;\r\n*pmax = max_mask;\r\n}\r\nvoid si_pmu_spuravoid_pllupdate(struct si_pub *sih, u8 spuravoid)\r\n{\r\nu32 tmp = 0;\r\nstruct bcma_device *core;\r\ncore = ai_findcore(sih, BCMA_CORE_CHIPCOMMON, 0);\r\nswitch (ai_get_chip_id(sih)) {\r\ncase BCM43224_CHIP_ID:\r\ncase BCM43225_CHIP_ID:\r\nif (spuravoid == 1) {\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_addr),\r\nPMU1_PLL0_PLLCTL0);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_data),\r\n0x11500010);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_addr),\r\nPMU1_PLL0_PLLCTL1);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_data),\r\n0x000C0C06);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_addr),\r\nPMU1_PLL0_PLLCTL2);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_data),\r\n0x0F600a08);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_addr),\r\nPMU1_PLL0_PLLCTL3);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_data),\r\n0x00000000);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_addr),\r\nPMU1_PLL0_PLLCTL4);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_data),\r\n0x2001E920);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_addr),\r\nPMU1_PLL0_PLLCTL5);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_data),\r\n0x88888815);\r\n} else {\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_addr),\r\nPMU1_PLL0_PLLCTL0);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_data),\r\n0x11100010);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_addr),\r\nPMU1_PLL0_PLLCTL1);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_data),\r\n0x000c0c06);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_addr),\r\nPMU1_PLL0_PLLCTL2);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_data),\r\n0x03000a08);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_addr),\r\nPMU1_PLL0_PLLCTL3);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_data),\r\n0x00000000);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_addr),\r\nPMU1_PLL0_PLLCTL4);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_data),\r\n0x200005c0);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_addr),\r\nPMU1_PLL0_PLLCTL5);\r\nbcma_write32(core, CHIPCREGOFFS(pllcontrol_data),\r\n0x88888815);\r\n}\r\ntmp = 1 << 10;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nbcma_set32(core, CHIPCREGOFFS(pmucontrol), tmp);\r\n}\r\nu16 si_pmu_fast_pwrup_delay(struct si_pub *sih)\r\n{\r\nuint delay = PMU_MAX_TRANSITION_DLY;\r\nswitch (ai_get_chip_id(sih)) {\r\ncase BCM43224_CHIP_ID:\r\ncase BCM43225_CHIP_ID:\r\ncase BCM4313_CHIP_ID:\r\ndelay = 3700;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn (u16) delay;\r\n}\r\nu32 si_pmu_chipcontrol(struct si_pub *sih, uint reg, u32 mask, u32 val)\r\n{\r\nai_cc_reg(sih, offsetof(struct chipcregs, chipcontrol_addr), ~0, reg);\r\nreturn ai_cc_reg(sih, offsetof(struct chipcregs, chipcontrol_data),\r\nmask, val);\r\n}\r\nu32 si_pmu_regcontrol(struct si_pub *sih, uint reg, u32 mask, u32 val)\r\n{\r\nai_cc_reg(sih, offsetof(struct chipcregs, regcontrol_addr), ~0, reg);\r\nreturn ai_cc_reg(sih, offsetof(struct chipcregs, regcontrol_data),\r\nmask, val);\r\n}\r\nu32 si_pmu_pllcontrol(struct si_pub *sih, uint reg, u32 mask, u32 val)\r\n{\r\nai_cc_reg(sih, offsetof(struct chipcregs, pllcontrol_addr), ~0, reg);\r\nreturn ai_cc_reg(sih, offsetof(struct chipcregs, pllcontrol_data),\r\nmask, val);\r\n}\r\nvoid si_pmu_pllupd(struct si_pub *sih)\r\n{\r\nai_cc_reg(sih, offsetof(struct chipcregs, pmucontrol),\r\nPCTL_PLL_PLLCTL_UPD, PCTL_PLL_PLLCTL_UPD);\r\n}\r\nu32 si_pmu_alp_clock(struct si_pub *sih)\r\n{\r\nu32 clock = ALP_CLOCK;\r\nif (!(ai_get_cccaps(sih) & CC_CAP_PMU))\r\nreturn clock;\r\nswitch (ai_get_chip_id(sih)) {\r\ncase BCM43224_CHIP_ID:\r\ncase BCM43225_CHIP_ID:\r\ncase BCM4313_CHIP_ID:\r\nclock = 20000 * 1000;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn clock;\r\n}\r\nvoid si_pmu_init(struct si_pub *sih)\r\n{\r\nstruct bcma_device *core;\r\ncore = ai_findcore(sih, BCMA_CORE_CHIPCOMMON, 0);\r\nif (ai_get_pmurev(sih) == 1)\r\nbcma_mask32(core, CHIPCREGOFFS(pmucontrol),\r\n~PCTL_NOILP_ON_WAIT);\r\nelse if (ai_get_pmurev(sih) >= 2)\r\nbcma_set32(core, CHIPCREGOFFS(pmucontrol), PCTL_NOILP_ON_WAIT);\r\n}\r\nvoid si_pmu_res_init(struct si_pub *sih)\r\n{\r\nstruct bcma_device *core;\r\nu32 min_mask = 0, max_mask = 0;\r\ncore = ai_findcore(sih, BCMA_CORE_CHIPCOMMON, 0);\r\nsi_pmu_res_masks(sih, &min_mask, &max_mask);\r\nif (max_mask)\r\nbcma_write32(core, CHIPCREGOFFS(max_res_mask), max_mask);\r\nif (min_mask)\r\nbcma_write32(core, CHIPCREGOFFS(min_res_mask), min_mask);\r\nmdelay(2);\r\n}\r\nu32 si_pmu_measure_alpclk(struct si_pub *sih)\r\n{\r\nstruct bcma_device *core;\r\nu32 alp_khz;\r\nif (ai_get_pmurev(sih) < 10)\r\nreturn 0;\r\ncore = ai_findcore(sih, BCMA_CORE_CHIPCOMMON, 0);\r\nif (bcma_read32(core, CHIPCREGOFFS(pmustatus)) & PST_EXTLPOAVAIL) {\r\nu32 ilp_ctr, alp_hz;\r\nbcma_write32(core, CHIPCREGOFFS(pmu_xtalfreq),\r\n1U << PMU_XTALFREQ_REG_MEASURE_SHIFT);\r\nudelay(1000);\r\nilp_ctr = bcma_read32(core, CHIPCREGOFFS(pmu_xtalfreq)) &\r\nPMU_XTALFREQ_REG_ILPCTR_MASK;\r\nbcma_write32(core, CHIPCREGOFFS(pmu_xtalfreq), 0);\r\nalp_hz = (ilp_ctr * EXT_ILP_HZ) / 4;\r\nalp_khz = (alp_hz + 50000) / 100000 * 100;\r\n} else\r\nalp_khz = 0;\r\nreturn alp_khz;\r\n}

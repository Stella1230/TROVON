static irqreturn_t max8925_onkey_handler(int irq, void *data)\r\n{\r\nstruct max8925_onkey_info *info = data;\r\nint state;\r\nstate = max8925_reg_read(info->i2c, MAX8925_ON_OFF_STATUS);\r\ninput_report_key(info->idev, KEY_POWER, state & SW_INPUT);\r\ninput_sync(info->idev);\r\ndev_dbg(info->dev, "onkey state:%d\n", state);\r\nmax8925_set_bits(info->i2c, MAX8925_SYSENSEL,\r\nHARDRESET_EN, HARDRESET_EN);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __devinit max8925_onkey_probe(struct platform_device *pdev)\r\n{\r\nstruct max8925_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct max8925_onkey_info *info;\r\nstruct input_dev *input;\r\nint irq[2], error;\r\nirq[0] = platform_get_irq(pdev, 0);\r\nif (irq[0] < 0) {\r\ndev_err(&pdev->dev, "No IRQ resource!\n");\r\nreturn -EINVAL;\r\n}\r\nirq[1] = platform_get_irq(pdev, 1);\r\nif (irq[1] < 0) {\r\ndev_err(&pdev->dev, "No IRQ resource!\n");\r\nreturn -EINVAL;\r\n}\r\ninfo = kzalloc(sizeof(struct max8925_onkey_info), GFP_KERNEL);\r\ninput = input_allocate_device();\r\nif (!info || !input) {\r\nerror = -ENOMEM;\r\ngoto err_free_mem;\r\n}\r\ninfo->idev = input;\r\ninfo->i2c = chip->i2c;\r\ninfo->dev = &pdev->dev;\r\ninfo->irq[0] = irq[0];\r\ninfo->irq[1] = irq[1];\r\ninput->name = "max8925_on";\r\ninput->phys = "max8925_on/input0";\r\ninput->id.bustype = BUS_I2C;\r\ninput->dev.parent = &pdev->dev;\r\ninput_set_capability(input, EV_KEY, KEY_POWER);\r\nirq[0] += chip->irq_base;\r\nirq[1] += chip->irq_base;\r\nerror = request_threaded_irq(irq[0], NULL, max8925_onkey_handler,\r\nIRQF_ONESHOT, "onkey-down", info);\r\nif (error < 0) {\r\ndev_err(chip->dev, "Failed to request IRQ: #%d: %d\n",\r\nirq[0], error);\r\ngoto err_free_mem;\r\n}\r\nerror = request_threaded_irq(irq[1], NULL, max8925_onkey_handler,\r\nIRQF_ONESHOT, "onkey-up", info);\r\nif (error < 0) {\r\ndev_err(chip->dev, "Failed to request IRQ: #%d: %d\n",\r\nirq[1], error);\r\ngoto err_free_irq0;\r\n}\r\nerror = input_register_device(info->idev);\r\nif (error) {\r\ndev_err(chip->dev, "Can't register input device: %d\n", error);\r\ngoto err_free_irq1;\r\n}\r\nplatform_set_drvdata(pdev, info);\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nreturn 0;\r\nerr_free_irq1:\r\nfree_irq(irq[1], info);\r\nerr_free_irq0:\r\nfree_irq(irq[0], info);\r\nerr_free_mem:\r\ninput_free_device(input);\r\nkfree(info);\r\nreturn error;\r\n}\r\nstatic int __devexit max8925_onkey_remove(struct platform_device *pdev)\r\n{\r\nstruct max8925_onkey_info *info = platform_get_drvdata(pdev);\r\nstruct max8925_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nfree_irq(info->irq[0] + chip->irq_base, info);\r\nfree_irq(info->irq[1] + chip->irq_base, info);\r\ninput_unregister_device(info->idev);\r\nkfree(info);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int max8925_onkey_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct max8925_onkey_info *info = platform_get_drvdata(pdev);\r\nstruct max8925_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nif (device_may_wakeup(dev)) {\r\nchip->wakeup_flag |= 1 << info->irq[0];\r\nchip->wakeup_flag |= 1 << info->irq[1];\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8925_onkey_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct max8925_onkey_info *info = platform_get_drvdata(pdev);\r\nstruct max8925_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nif (device_may_wakeup(dev)) {\r\nchip->wakeup_flag &= ~(1 << info->irq[0]);\r\nchip->wakeup_flag &= ~(1 << info->irq[1]);\r\n}\r\nreturn 0;\r\n}

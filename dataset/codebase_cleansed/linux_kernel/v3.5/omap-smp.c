void __iomem *omap4_get_scu_base(void)\r\n{\r\nreturn scu_base;\r\n}\r\nvoid __cpuinit platform_secondary_init(unsigned int cpu)\r\n{\r\nif (cpu_is_omap443x() && (omap_type() != OMAP2_DEVICE_TYPE_GP))\r\nomap_secure_dispatcher(OMAP4_PPA_CPU_ACTRL_SMP_INDEX,\r\n4, 0, 0, 0, 0, 0);\r\ngic_secondary_init(0);\r\nspin_lock(&boot_lock);\r\nspin_unlock(&boot_lock);\r\n}\r\nint __cpuinit boot_secondary(unsigned int cpu, struct task_struct *idle)\r\n{\r\nstatic struct clockdomain *cpu1_clkdm;\r\nstatic bool booted;\r\nspin_lock(&boot_lock);\r\nomap_modify_auxcoreboot0(0x200, 0xfffffdff);\r\nflush_cache_all();\r\nsmp_wmb();\r\nif (!cpu1_clkdm)\r\ncpu1_clkdm = clkdm_lookup("mpu1_clkdm");\r\nif (booted) {\r\nclkdm_wakeup(cpu1_clkdm);\r\nclkdm_allow_idle(cpu1_clkdm);\r\n} else {\r\ndsb_sev();\r\nbooted = true;\r\n}\r\ngic_raise_softirq(cpumask_of(cpu), 1);\r\nspin_unlock(&boot_lock);\r\nreturn 0;\r\n}\r\nstatic void __init wakeup_secondary(void)\r\n{\r\nomap_auxcoreboot_addr(virt_to_phys(omap_secondary_startup));\r\nsmp_wmb();\r\ndsb_sev();\r\nmb();\r\n}\r\nvoid __init smp_init_cpus(void)\r\n{\r\nunsigned int i, ncores;\r\nscu_base = OMAP2_L4_IO_ADDRESS(OMAP44XX_SCU_BASE);\r\nBUG_ON(!scu_base);\r\nncores = scu_get_core_count(scu_base);\r\nif (ncores > nr_cpu_ids) {\r\npr_warn("SMP: %u cores greater than maximum (%u), clipping\n",\r\nncores, nr_cpu_ids);\r\nncores = nr_cpu_ids;\r\n}\r\nfor (i = 0; i < ncores; i++)\r\nset_cpu_possible(i, true);\r\nset_smp_cross_call(gic_raise_softirq);\r\n}\r\nvoid __init platform_smp_prepare_cpus(unsigned int max_cpus)\r\n{\r\nscu_enable(scu_base);\r\nwakeup_secondary();\r\n}

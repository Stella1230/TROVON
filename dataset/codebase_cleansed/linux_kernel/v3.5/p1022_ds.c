static u32 p1022ds_get_pixel_format(enum fsl_diu_monitor_port port,\r\nunsigned int bits_per_pixel)\r\n{\r\nswitch (bits_per_pixel) {\r\ncase 32:\r\nreturn MAKE_AD(3, 2, 0, 1, 3, 8, 8, 8, 8);\r\ncase 24:\r\nreturn MAKE_AD(4, 0, 1, 2, 2, 0, 8, 8, 8);\r\ncase 16:\r\nreturn MAKE_AD(4, 2, 1, 0, 1, 5, 6, 5, 0);\r\ndefault:\r\npr_err("fsl-diu: unsupported pixel depth %u\n", bits_per_pixel);\r\nreturn 0;\r\n}\r\n}\r\nstatic void p1022ds_set_gamma_table(enum fsl_diu_monitor_port port,\r\nchar *gamma_table_base)\r\n{\r\n}\r\nstatic void p1022ds_set_monitor_port(enum fsl_diu_monitor_port port)\r\n{\r\nstruct device_node *guts_node;\r\nstruct device_node *indirect_node = NULL;\r\nstruct ccsr_guts __iomem *guts;\r\nu8 __iomem *lbc_lcs0_ba = NULL;\r\nu8 __iomem *lbc_lcs1_ba = NULL;\r\nu8 b;\r\nguts_node = of_find_compatible_node(NULL, NULL, "fsl,p1022-guts");\r\nif (!guts_node) {\r\npr_err("p1022ds: missing global utilties device node\n");\r\nreturn;\r\n}\r\nguts = of_iomap(guts_node, 0);\r\nif (!guts) {\r\npr_err("p1022ds: could not map global utilties device\n");\r\ngoto exit;\r\n}\r\nindirect_node = of_find_compatible_node(NULL, NULL,\r\n"fsl,p1022ds-indirect-pixis");\r\nif (!indirect_node) {\r\npr_err("p1022ds: missing pixis indirect mode node\n");\r\ngoto exit;\r\n}\r\nlbc_lcs0_ba = of_iomap(indirect_node, 0);\r\nif (!lbc_lcs0_ba) {\r\npr_err("p1022ds: could not map localbus chip select 0\n");\r\ngoto exit;\r\n}\r\nlbc_lcs1_ba = of_iomap(indirect_node, 1);\r\nif (!lbc_lcs1_ba) {\r\npr_err("p1022ds: could not map localbus chip select 1\n");\r\ngoto exit;\r\n}\r\nif ((in_be32(&guts->pmuxcr) & PMUXCR_ELBCDIU_MASK) !=\r\nPMUXCR_ELBCDIU_DIU) {\r\nstruct device_node *pixis_node;\r\nvoid __iomem *pixis;\r\npixis_node =\r\nof_find_compatible_node(NULL, NULL, "fsl,p1022ds-fpga");\r\nif (!pixis_node) {\r\npr_err("p1022ds: missing pixis node\n");\r\ngoto exit;\r\n}\r\npixis = of_iomap(pixis_node, 0);\r\nof_node_put(pixis_node);\r\nif (!pixis) {\r\npr_err("p1022ds: could not map pixis registers\n");\r\ngoto exit;\r\n}\r\nsetbits8(pixis + PX_CTL, PX_CTL_ALTACC);\r\niounmap(pixis);\r\nout_8(lbc_lcs0_ba, PX_BRDCFG0);\r\nb = in_8(lbc_lcs1_ba);\r\nb |= PX_BRDCFG0_ELBC_DIU;\r\nout_8(lbc_lcs1_ba, b);\r\nclrsetbits_be32(&guts->pmuxcr, PMUXCR_ELBCDIU_MASK,\r\nPMUXCR_ELBCDIU_DIU);\r\nin_be32(&guts->pmuxcr);\r\n}\r\nswitch (port) {\r\ncase FSL_DIU_PORT_DVI:\r\nout_8(lbc_lcs0_ba, PX_BRDCFG1);\r\nb = in_8(lbc_lcs1_ba);\r\nb &= ~(PX_BRDCFG1_DFPEN | PX_BRDCFG1_BACKLIGHT);\r\nb |= PX_BRDCFG1_DVIEN;\r\nout_8(lbc_lcs1_ba, b);\r\nbreak;\r\ncase FSL_DIU_PORT_LVDS:\r\nout_8(lbc_lcs0_ba, PX_BRDCFG1);\r\nb = in_8(lbc_lcs1_ba);\r\nb &= ~PX_BRDCFG1_DVIEN;\r\nb |= PX_BRDCFG1_DFPEN | PX_BRDCFG1_BACKLIGHT;\r\nout_8(lbc_lcs1_ba, b);\r\nbreak;\r\ndefault:\r\npr_err("p1022ds: unsupported monitor port %i\n", port);\r\n}\r\nexit:\r\nif (lbc_lcs1_ba)\r\niounmap(lbc_lcs1_ba);\r\nif (lbc_lcs0_ba)\r\niounmap(lbc_lcs0_ba);\r\nif (guts)\r\niounmap(guts);\r\nof_node_put(indirect_node);\r\nof_node_put(guts_node);\r\n}\r\nvoid p1022ds_set_pixel_clock(unsigned int pixclock)\r\n{\r\nstruct device_node *guts_np = NULL;\r\nstruct ccsr_guts __iomem *guts;\r\nunsigned long freq;\r\nu64 temp;\r\nu32 pxclk;\r\nguts_np = of_find_compatible_node(NULL, NULL, "fsl,p1022-guts");\r\nif (!guts_np) {\r\npr_err("p1022ds: missing global utilties device node\n");\r\nreturn;\r\n}\r\nguts = of_iomap(guts_np, 0);\r\nof_node_put(guts_np);\r\nif (!guts) {\r\npr_err("p1022ds: could not map global utilties device\n");\r\nreturn;\r\n}\r\ntemp = 1000000000000ULL;\r\ndo_div(temp, pixclock);\r\nfreq = temp;\r\npxclk = DIV_ROUND_CLOSEST(fsl_get_sys_freq(), freq);\r\npxclk = clamp_t(u32, pxclk, 2, 255);\r\nclrbits32(&guts->clkdvdr,\r\nCLKDVDR_PXCKEN | CLKDVDR_PXCKDLY | CLKDVDR_PXCLK_MASK);\r\nsetbits32(&guts->clkdvdr, CLKDVDR_PXCKEN | (pxclk << 16));\r\niounmap(guts);\r\n}\r\nenum fsl_diu_monitor_port\r\np1022ds_valid_monitor_port(enum fsl_diu_monitor_port port)\r\n{\r\nswitch (port) {\r\ncase FSL_DIU_PORT_DVI:\r\ncase FSL_DIU_PORT_LVDS:\r\nreturn port;\r\ndefault:\r\nreturn FSL_DIU_PORT_DVI;\r\n}\r\n}\r\nvoid __init p1022_ds_pic_init(void)\r\n{\r\nstruct mpic *mpic = mpic_alloc(NULL, 0, MPIC_BIG_ENDIAN |\r\nMPIC_SINGLE_DEST_CPU,\r\n0, 256, " OpenPIC ");\r\nBUG_ON(mpic == NULL);\r\nmpic_init(mpic);\r\n}\r\nstatic void __init disable_one_node(struct device_node *np, struct property *new)\r\n{\r\nstruct property *old;\r\nold = of_find_property(np, new->name, NULL);\r\nif (old)\r\nprom_update_property(np, new, old);\r\nelse\r\nprom_add_property(np, new);\r\n}\r\nstatic int __init early_video_setup(char *options)\r\n{\r\nfslfb = (strncmp(options, "fslfb:", 6) == 0);\r\nreturn 0;\r\n}\r\nstatic void __init p1022_ds_setup_arch(void)\r\n{\r\n#ifdef CONFIG_PCI\r\nstruct device_node *np;\r\n#endif\r\ndma_addr_t max = 0xffffffff;\r\nif (ppc_md.progress)\r\nppc_md.progress("p1022_ds_setup_arch()", 0);\r\n#ifdef CONFIG_PCI\r\nfor_each_compatible_node(np, "pci", "fsl,p1022-pcie") {\r\nstruct resource rsrc;\r\nstruct pci_controller *hose;\r\nof_address_to_resource(np, 0, &rsrc);\r\nif ((rsrc.start & 0xfffff) == 0x8000)\r\nfsl_add_bridge(np, 1);\r\nelse\r\nfsl_add_bridge(np, 0);\r\nhose = pci_find_hose_for_OF_device(np);\r\nmax = min(max, hose->dma_window_base_cur +\r\nhose->dma_window_size);\r\n}\r\n#endif\r\n#if defined(CONFIG_FB_FSL_DIU) || defined(CONFIG_FB_FSL_DIU_MODULE)\r\ndiu_ops.get_pixel_format = p1022ds_get_pixel_format;\r\ndiu_ops.set_gamma_table = p1022ds_set_gamma_table;\r\ndiu_ops.set_monitor_port = p1022ds_set_monitor_port;\r\ndiu_ops.set_pixel_clock = p1022ds_set_pixel_clock;\r\ndiu_ops.valid_monitor_port = p1022ds_valid_monitor_port;\r\nif (fslfb) {\r\nstruct device_node *np =\r\nof_find_compatible_node(NULL, NULL, "fsl,p1022-elbc");\r\nif (np) {\r\nnp = of_find_compatible_node(np, NULL, "cfi-flash");\r\nif (np) {\r\nstatic struct property nor_status = {\r\n.name = "status",\r\n.value = "disabled",\r\n.length = sizeof("disabled"),\r\n};\r\npr_info("p1022ds: disabling %s node",\r\nnp->full_name);\r\ndisable_one_node(np, &nor_status);\r\nof_node_put(np);\r\n}\r\n}\r\n}\r\n#endif\r\nmpc85xx_smp_init();\r\n#ifdef CONFIG_SWIOTLB\r\nif (memblock_end_of_DRAM() > max) {\r\nppc_swiotlb_enable = 1;\r\nset_pci_dma_ops(&swiotlb_dma_ops);\r\nppc_md.pci_dma_dev_setup = pci_dma_dev_setup_swiotlb;\r\n}\r\n#endif\r\npr_info("Freescale P1022 DS reference board\n");\r\n}\r\nstatic int __init p1022_ds_probe(void)\r\n{\r\nunsigned long root = of_get_flat_dt_root();\r\nreturn of_flat_dt_is_compatible(root, "fsl,p1022ds");\r\n}

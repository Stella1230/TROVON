static int reg_write(struct usb_device *dev,\r\nu16 req, u16 index, u16 value)\r\n{\r\nint ret;\r\nret = usb_control_msg(dev,\r\nusb_sndctrlpipe(dev, 0),\r\nreq,\r\nUSB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\nvalue, index, NULL, 0, 500);\r\nPDEBUG(D_USBO, "reg write: 0x%02x,0x%02x:0x%02x, %d",\r\nreq, index, value, ret);\r\nif (ret < 0)\r\npr_err("reg write: error %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int reg_read(struct gspca_dev *gspca_dev,\r\nu16 req,\r\nu16 index)\r\n{\r\nint ret;\r\nret = usb_control_msg(gspca_dev->dev,\r\nusb_rcvctrlpipe(gspca_dev->dev, 0),\r\nreq,\r\nUSB_DIR_IN | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\n0,\r\nindex,\r\ngspca_dev->usb_buf, 2,\r\n500);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn (gspca_dev->usb_buf[1] << 8) + gspca_dev->usb_buf[0];\r\n}\r\nstatic int write_vector(struct gspca_dev *gspca_dev,\r\nconst u8 data[][3])\r\n{\r\nstruct usb_device *dev = gspca_dev->dev;\r\nint ret, i = 0;\r\nwhile (data[i][0] != 0) {\r\nret = reg_write(dev, data[i][0], data[i][2], data[i][1]);\r\nif (ret < 0)\r\nreturn ret;\r\ni++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sd_config(struct gspca_dev *gspca_dev,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nstruct cam *cam;\r\ncam = &gspca_dev->cam;\r\ncam->cam_mode = vga_mode;\r\nsd->subtype = id->driver_info;\r\nif (sd->subtype != IntelPCCameraPro)\r\ncam->nmodes = ARRAY_SIZE(vga_mode);\r\nelse\r\ncam->nmodes = ARRAY_SIZE(vga_mode) - 1;\r\nsd->brightness = BRIGHTNESS_DEF;\r\nreturn 0;\r\n}\r\nstatic int sd_init(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nif (write_vector(gspca_dev,\r\nsd->subtype == Nxultra\r\n? spca505b_init_data\r\n: spca505_init_data))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic void setbrightness(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nu8 brightness = sd->brightness;\r\nreg_write(gspca_dev->dev, 0x05, 0x00, (255 - brightness) >> 6);\r\nreg_write(gspca_dev->dev, 0x05, 0x01, (255 - brightness) << 2);\r\n}\r\nstatic int sd_start(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nstruct usb_device *dev = gspca_dev->dev;\r\nint ret, mode;\r\nstatic u8 mode_tb[][3] = {\r\n{0x00, 0x10, 0x10},\r\n{0x01, 0x1a, 0x1a},\r\n{0x02, 0x1c, 0x1d},\r\n{0x04, 0x34, 0x34},\r\n{0x05, 0x40, 0x40}\r\n};\r\nif (sd->subtype == Nxultra)\r\nwrite_vector(gspca_dev, spca505b_open_data_ccd);\r\nelse\r\nwrite_vector(gspca_dev, spca505_open_data_ccd);\r\nret = reg_read(gspca_dev, 0x06, 0x16);\r\nif (ret < 0) {\r\nPDEBUG(D_ERR|D_CONF,\r\n"register read failed err: %d",\r\nret);\r\nreturn ret;\r\n}\r\nif (ret != 0x0101) {\r\npr_err("After vector read returns 0x%04x should be 0x0101\n",\r\nret);\r\n}\r\nret = reg_write(gspca_dev->dev, 0x06, 0x16, 0x0a);\r\nif (ret < 0)\r\nreturn ret;\r\nreg_write(gspca_dev->dev, 0x05, 0xc2, 0x12);\r\nreg_write(dev, 0x02, 0x00, 0x00);\r\nmode = gspca_dev->cam.cam_mode[(int) gspca_dev->curr_mode].priv;\r\nreg_write(dev, SPCA50X_REG_COMPRESS, 0x00, mode_tb[mode][0]);\r\nreg_write(dev, SPCA50X_REG_COMPRESS, 0x06, mode_tb[mode][1]);\r\nreg_write(dev, SPCA50X_REG_COMPRESS, 0x07, mode_tb[mode][2]);\r\nret = reg_write(dev, SPCA50X_REG_USB,\r\nSPCA50X_USB_CTRL,\r\nSPCA50X_CUSB_ENABLE);\r\nsetbrightness(gspca_dev);\r\nreturn ret;\r\n}\r\nstatic void sd_stopN(struct gspca_dev *gspca_dev)\r\n{\r\nreg_write(gspca_dev->dev, 0x02, 0x00, 0x00);\r\n}\r\nstatic void sd_stop0(struct gspca_dev *gspca_dev)\r\n{\r\nif (!gspca_dev->present)\r\nreturn;\r\nreg_write(gspca_dev->dev, 0x03, 0x03, 0x20);\r\nreg_write(gspca_dev->dev, 0x03, 0x01, 0x00);\r\nreg_write(gspca_dev->dev, 0x03, 0x00, 0x01);\r\nreg_write(gspca_dev->dev, 0x05, 0x10, 0x01);\r\nreg_write(gspca_dev->dev, 0x05, 0x11, 0x0f);\r\n}\r\nstatic void sd_pkt_scan(struct gspca_dev *gspca_dev,\r\nu8 *data,\r\nint len)\r\n{\r\nswitch (data[0]) {\r\ncase 0:\r\ngspca_frame_add(gspca_dev, LAST_PACKET, NULL, 0);\r\ndata += SPCA50X_OFFSET_DATA;\r\nlen -= SPCA50X_OFFSET_DATA;\r\ngspca_frame_add(gspca_dev, FIRST_PACKET, data, len);\r\nbreak;\r\ncase 0xff:\r\nbreak;\r\ndefault:\r\ndata += 1;\r\nlen -= 1;\r\ngspca_frame_add(gspca_dev, INTER_PACKET, data, len);\r\nbreak;\r\n}\r\n}\r\nstatic int sd_setbrightness(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->brightness = val;\r\nif (gspca_dev->streaming)\r\nsetbrightness(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_getbrightness(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*val = sd->brightness;\r\nreturn 0;\r\n}\r\nstatic int sd_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nreturn gspca_dev_probe(intf, id, &sd_desc, sizeof(struct sd),\r\nTHIS_MODULE);\r\n}

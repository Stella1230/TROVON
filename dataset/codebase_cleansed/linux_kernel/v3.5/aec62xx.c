static u8 pci_bus_clock_list (u8 speed, struct chipset_bus_clock_list_entry * chipset_table)\r\n{\r\nfor ( ; chipset_table->xfer_speed ; chipset_table++)\r\nif (chipset_table->xfer_speed == speed) {\r\nreturn chipset_table->chipset_settings;\r\n}\r\nreturn chipset_table->chipset_settings;\r\n}\r\nstatic u8 pci_bus_clock_list_ultra (u8 speed, struct chipset_bus_clock_list_entry * chipset_table)\r\n{\r\nfor ( ; chipset_table->xfer_speed ; chipset_table++)\r\nif (chipset_table->xfer_speed == speed) {\r\nreturn chipset_table->ultra_settings;\r\n}\r\nreturn chipset_table->ultra_settings;\r\n}\r\nstatic void aec6210_set_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nstruct ide_host *host = pci_get_drvdata(dev);\r\nstruct chipset_bus_clock_list_entry *bus_clock = host->host_priv;\r\nu16 d_conf = 0;\r\nu8 ultra = 0, ultra_conf = 0;\r\nu8 tmp0 = 0, tmp1 = 0, tmp2 = 0;\r\nconst u8 speed = drive->dma_mode;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\npci_read_config_word(dev, 0x40|(2*drive->dn), &d_conf);\r\ntmp0 = pci_bus_clock_list(speed, bus_clock);\r\nd_conf = ((tmp0 & 0xf0) << 4) | (tmp0 & 0xf);\r\npci_write_config_word(dev, 0x40|(2*drive->dn), d_conf);\r\ntmp1 = 0x00;\r\ntmp2 = 0x00;\r\npci_read_config_byte(dev, 0x54, &ultra);\r\ntmp1 = ((0x00 << (2*drive->dn)) | (ultra & ~(3 << (2*drive->dn))));\r\nultra_conf = pci_bus_clock_list_ultra(speed, bus_clock);\r\ntmp2 = ((ultra_conf << (2*drive->dn)) | (tmp1 & ~(3 << (2*drive->dn))));\r\npci_write_config_byte(dev, 0x54, tmp2);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void aec6260_set_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nstruct ide_host *host = pci_get_drvdata(dev);\r\nstruct chipset_bus_clock_list_entry *bus_clock = host->host_priv;\r\nu8 unit = drive->dn & 1;\r\nu8 tmp1 = 0, tmp2 = 0;\r\nu8 ultra = 0, drive_conf = 0, ultra_conf = 0;\r\nconst u8 speed = drive->dma_mode;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\npci_read_config_byte(dev, 0x40|drive->dn, &drive_conf);\r\ndrive_conf = pci_bus_clock_list(speed, bus_clock);\r\npci_write_config_byte(dev, 0x40|drive->dn, drive_conf);\r\npci_read_config_byte(dev, (0x44|hwif->channel), &ultra);\r\ntmp1 = ((0x00 << (4*unit)) | (ultra & ~(7 << (4*unit))));\r\nultra_conf = pci_bus_clock_list_ultra(speed, bus_clock);\r\ntmp2 = ((ultra_conf << (4*unit)) | (tmp1 & ~(7 << (4*unit))));\r\npci_write_config_byte(dev, (0x44|hwif->channel), tmp2);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void aec_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\ndrive->dma_mode = drive->pio_mode;\r\nhwif->port_ops->set_dma_mode(hwif, drive);\r\n}\r\nstatic int init_chipset_aec62xx(struct pci_dev *dev)\r\n{\r\nif ((dev->device == PCI_DEVICE_ID_ARTOP_ATP865) ||\r\n(dev->device == PCI_DEVICE_ID_ARTOP_ATP865R)) {\r\nu8 reg49h = 0, reg4ah = 0;\r\npci_read_config_byte(dev, 0x49, &reg49h);\r\npci_write_config_byte(dev, 0x49, reg49h & ~0x30);\r\npci_read_config_byte(dev, 0x4a, &reg4ah);\r\npci_write_config_byte(dev, 0x4a, reg4ah & ~0x01);\r\npci_read_config_byte(dev, 0x4a, &reg4ah);\r\npci_write_config_byte(dev, 0x4a, reg4ah | 0x80);\r\n}\r\nreturn 0;\r\n}\r\nstatic u8 atp86x_cable_detect(ide_hwif_t *hwif)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nu8 ata66 = 0, mask = hwif->channel ? 0x02 : 0x01;\r\npci_read_config_byte(dev, 0x49, &ata66);\r\nreturn (ata66 & mask) ? ATA_CBL_PATA40 : ATA_CBL_PATA80;\r\n}\r\nstatic int __devinit aec62xx_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nconst struct chipset_bus_clock_list_entry *bus_clock;\r\nstruct ide_port_info d;\r\nu8 idx = id->driver_data;\r\nint bus_speed = ide_pci_clk ? ide_pci_clk : 33;\r\nint err;\r\nif (bus_speed <= 33)\r\nbus_clock = aec6xxx_33_base;\r\nelse\r\nbus_clock = aec6xxx_34_base;\r\nerr = pci_enable_device(dev);\r\nif (err)\r\nreturn err;\r\nd = aec62xx_chipsets[idx];\r\nif (idx == 3 || idx == 4) {\r\nunsigned long dma_base = pci_resource_start(dev, 4);\r\nif (inb(dma_base + 2) & 0x10) {\r\nprintk(KERN_INFO DRV_NAME " %s: AEC6880%s card detected"\r\n"\n", pci_name(dev), (idx == 4) ? "R" : "");\r\nd.udma_mask = ATA_UDMA6;\r\n}\r\n}\r\nerr = ide_pci_init_one(dev, &d, (void *)bus_clock);\r\nif (err)\r\npci_disable_device(dev);\r\nreturn err;\r\n}\r\nstatic void __devexit aec62xx_remove(struct pci_dev *dev)\r\n{\r\nide_pci_remove(dev);\r\npci_disable_device(dev);\r\n}\r\nstatic int __init aec62xx_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&aec62xx_pci_driver);\r\n}\r\nstatic void __exit aec62xx_ide_exit(void)\r\n{\r\npci_unregister_driver(&aec62xx_pci_driver);\r\n}

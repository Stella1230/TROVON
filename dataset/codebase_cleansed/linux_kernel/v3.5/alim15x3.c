static void ali_fifo_control(ide_hwif_t *hwif, ide_drive_t *drive, int on)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(hwif->dev);\r\nint pio_fifo = 0x54 + hwif->channel;\r\nu8 fifo;\r\nint shift = 4 * (drive->dn & 1);\r\npci_read_config_byte(pdev, pio_fifo, &fifo);\r\nfifo &= ~(0x0F << shift);\r\nfifo |= (on << shift);\r\npci_write_config_byte(pdev, pio_fifo, fifo);\r\n}\r\nstatic void ali_program_timings(ide_hwif_t *hwif, ide_drive_t *drive,\r\nstruct ide_timing *t, u8 ultra)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nint port = hwif->channel ? 0x5c : 0x58;\r\nint udmat = 0x56 + hwif->channel;\r\nu8 unit = drive->dn & 1, udma;\r\nint shift = 4 * unit;\r\npci_read_config_byte(dev, udmat, &udma);\r\nudma &= ~(0x0F << shift);\r\nudma |= ultra << shift;\r\npci_write_config_byte(dev, udmat, udma);\r\nif (t == NULL)\r\nreturn;\r\nt->setup = clamp_val(t->setup, 1, 8) & 7;\r\nt->act8b = clamp_val(t->act8b, 1, 8) & 7;\r\nt->rec8b = clamp_val(t->rec8b, 1, 16) & 15;\r\nt->active = clamp_val(t->active, 1, 8) & 7;\r\nt->recover = clamp_val(t->recover, 1, 16) & 15;\r\npci_write_config_byte(dev, port, t->setup);\r\npci_write_config_byte(dev, port + 1, (t->act8b << 4) | t->rec8b);\r\npci_write_config_byte(dev, port + unit + 2,\r\n(t->active << 4) | t->recover);\r\n}\r\nstatic void ali_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nide_drive_t *pair = ide_get_pair_dev(drive);\r\nint bus_speed = ide_pci_clk ? ide_pci_clk : 33;\r\nunsigned long T = 1000000 / bus_speed;\r\nstruct ide_timing t;\r\nide_timing_compute(drive, drive->pio_mode, &t, T, 1);\r\nif (pair) {\r\nstruct ide_timing p;\r\nide_timing_compute(pair, pair->pio_mode, &p, T, 1);\r\nide_timing_merge(&p, &t, &t,\r\nIDE_TIMING_SETUP | IDE_TIMING_8BIT);\r\nif (pair->dma_mode) {\r\nide_timing_compute(pair, pair->dma_mode, &p, T, 1);\r\nide_timing_merge(&p, &t, &t,\r\nIDE_TIMING_SETUP | IDE_TIMING_8BIT);\r\n}\r\n}\r\nali_fifo_control(hwif, drive, (drive->media == ide_disk) ? 0x05 : 0x00);\r\nali_program_timings(hwif, drive, &t, 0);\r\n}\r\nstatic u8 ali_udma_filter(ide_drive_t *drive)\r\n{\r\nif (m5229_revision > 0x20 && m5229_revision < 0xC2) {\r\nif (drive->media != ide_disk)\r\nreturn 0;\r\nif (chip_is_1543c_e &&\r\nstrstr((char *)&drive->id[ATA_ID_PROD], "WDC "))\r\nreturn 0;\r\n}\r\nreturn drive->hwif->ultra_mask;\r\n}\r\nstatic void ali_set_dma_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstatic u8 udma_timing[7] = { 0xC, 0xB, 0xA, 0x9, 0x8, 0xF, 0xD };\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nide_drive_t *pair = ide_get_pair_dev(drive);\r\nint bus_speed = ide_pci_clk ? ide_pci_clk : 33;\r\nunsigned long T = 1000000 / bus_speed;\r\nconst u8 speed = drive->dma_mode;\r\nu8 tmpbyte = 0x00;\r\nstruct ide_timing t;\r\nif (speed < XFER_UDMA_0) {\r\nide_timing_compute(drive, drive->dma_mode, &t, T, 1);\r\nif (pair) {\r\nstruct ide_timing p;\r\nide_timing_compute(pair, pair->pio_mode, &p, T, 1);\r\nide_timing_merge(&p, &t, &t,\r\nIDE_TIMING_SETUP | IDE_TIMING_8BIT);\r\nif (pair->dma_mode) {\r\nide_timing_compute(pair, pair->dma_mode,\r\n&p, T, 1);\r\nide_timing_merge(&p, &t, &t,\r\nIDE_TIMING_SETUP | IDE_TIMING_8BIT);\r\n}\r\n}\r\nali_program_timings(hwif, drive, &t, 0);\r\n} else {\r\nali_program_timings(hwif, drive, NULL,\r\nudma_timing[speed - XFER_UDMA_0]);\r\nif (speed >= XFER_UDMA_3) {\r\npci_read_config_byte(dev, 0x4b, &tmpbyte);\r\ntmpbyte |= 1;\r\npci_write_config_byte(dev, 0x4b, tmpbyte);\r\n}\r\n}\r\n}\r\nstatic int ali_dma_check(ide_drive_t *drive, struct ide_cmd *cmd)\r\n{\r\nif (m5229_revision < 0xC2 && drive->media != ide_disk) {\r\nif (cmd->tf_flags & IDE_TFLAG_WRITE)\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int init_chipset_ali15x3(struct pci_dev *dev)\r\n{\r\nunsigned long flags;\r\nu8 tmpbyte;\r\nstruct pci_dev *north = pci_get_slot(dev->bus, PCI_DEVFN(0,0));\r\nm5229_revision = dev->revision;\r\nisa_dev = pci_get_device(PCI_VENDOR_ID_AL, PCI_DEVICE_ID_AL_M1533, NULL);\r\nlocal_irq_save(flags);\r\nif (m5229_revision < 0xC2) {\r\npci_read_config_byte(dev, 0x4b, &tmpbyte);\r\npci_write_config_byte(dev, 0x4b, tmpbyte & 0x7F);\r\nif (m5229_revision >= 0x20 && isa_dev) {\r\npci_read_config_byte(isa_dev, 0x5e, &tmpbyte);\r\nchip_is_1543c_e = ((tmpbyte & 0x1e) == 0x12) ? 1: 0;\r\n}\r\ngoto out;\r\n}\r\npci_read_config_byte(dev, 0x4b, &tmpbyte);\r\npci_write_config_byte(dev, 0x4b, tmpbyte | 0x08);\r\nif (north && north->vendor != PCI_VENDOR_ID_AL)\r\ngoto out;\r\nif (m5229_revision < 0xC5 && isa_dev)\r\n{\r\npci_read_config_byte(isa_dev, 0x79, &tmpbyte);\r\nif (m5229_revision == 0xC2) {\r\npci_write_config_byte(isa_dev, 0x79, tmpbyte | 0x04);\r\n} else if (m5229_revision >= 0xC3) {\r\npci_write_config_byte(isa_dev, 0x79, tmpbyte | 0x02);\r\n}\r\n}\r\nout:\r\nif (m5229_revision >= 0x20) {\r\npci_read_config_byte(dev, 0x53, &tmpbyte);\r\nif (m5229_revision <= 0x20)\r\ntmpbyte = (tmpbyte & (~0x02)) | 0x01;\r\nelse if (m5229_revision == 0xc7 || m5229_revision == 0xc8)\r\ntmpbyte |= 0x03;\r\nelse\r\ntmpbyte |= 0x01;\r\npci_write_config_byte(dev, 0x53, tmpbyte);\r\n}\r\npci_dev_put(north);\r\npci_dev_put(isa_dev);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int ali_cable_override(struct pci_dev *pdev)\r\n{\r\nif (pdev->subsystem_vendor == 0x10CF &&\r\npdev->subsystem_device == 0x10AF)\r\nreturn 1;\r\nif (pdev->subsystem_vendor == 0x1071 &&\r\npdev->subsystem_device == 0x8317)\r\nreturn 1;\r\nif (dmi_check_system(cable_dmi_table))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic u8 ali_cable_detect(ide_hwif_t *hwif)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nu8 cbl = ATA_CBL_PATA40, tmpbyte;\r\nif (m5229_revision >= 0xC2) {\r\nif (ali_cable_override(dev))\r\ncbl = ATA_CBL_PATA40_SHORT;\r\nelse {\r\npci_read_config_byte(dev, 0x4a, &tmpbyte);\r\nif ((tmpbyte & (1 << hwif->channel)) == 0)\r\ncbl = ATA_CBL_PATA80;\r\n}\r\n}\r\nreturn cbl;\r\n}\r\nstatic void __devinit init_hwif_ali15x3 (ide_hwif_t *hwif)\r\n{\r\nu8 ideic, inmir;\r\ns8 irq_routing_table[] = { -1, 9, 3, 10, 4, 5, 7, 6,\r\n1, 11, 0, 12, 0, 14, 0, 15 };\r\nint irq = -1;\r\nif (isa_dev) {\r\npci_read_config_byte(isa_dev, 0x58, &ideic);\r\nideic = ideic & 0x03;\r\nif ((hwif->channel && ideic == 0x03) ||\r\n(!hwif->channel && !ideic)) {\r\npci_read_config_byte(isa_dev, 0x44, &inmir);\r\ninmir = inmir & 0x0f;\r\nirq = irq_routing_table[inmir];\r\n} else if (hwif->channel && !(ideic & 0x01)) {\r\npci_read_config_byte(isa_dev, 0x75, &inmir);\r\ninmir = inmir & 0x0f;\r\nirq = irq_routing_table[inmir];\r\n}\r\nif(irq >= 0)\r\nhwif->irq = irq;\r\n}\r\n}\r\nstatic int __devinit init_dma_ali15x3(ide_hwif_t *hwif,\r\nconst struct ide_port_info *d)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nunsigned long base = ide_pci_dma_base(hwif, d);\r\nif (base == 0)\r\nreturn -1;\r\nhwif->dma_base = base;\r\nif (ide_pci_check_simplex(hwif, d) < 0)\r\nreturn -1;\r\nif (ide_pci_set_master(dev, d->name) < 0)\r\nreturn -1;\r\nif (!hwif->channel)\r\noutb(inb(base + 2) & 0x60, base + 2);\r\nprintk(KERN_INFO " %s: BM-DMA at 0x%04lx-0x%04lx\n",\r\nhwif->name, base, base + 7);\r\nif (ide_allocate_dma_engine(hwif))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int __devinit alim15x3_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstruct ide_port_info d = ali15x3_chipset;\r\nu8 rev = dev->revision, idx = id->driver_data;\r\nif (rev <= 0xC4)\r\nd.host_flags |= IDE_HFLAG_NO_LBA48_DMA;\r\nif (rev >= 0x20) {\r\nif (rev == 0x20)\r\nd.host_flags |= IDE_HFLAG_NO_ATAPI_DMA;\r\nif (rev < 0xC2)\r\nd.udma_mask = ATA_UDMA2;\r\nelse if (rev == 0xC2 || rev == 0xC3)\r\nd.udma_mask = ATA_UDMA4;\r\nelse if (rev == 0xC4)\r\nd.udma_mask = ATA_UDMA5;\r\nelse\r\nd.udma_mask = ATA_UDMA6;\r\nd.dma_ops = &ali_dma_ops;\r\n} else {\r\nd.host_flags |= IDE_HFLAG_NO_DMA;\r\nd.mwdma_mask = d.swdma_mask = 0;\r\n}\r\nif (idx == 0)\r\nd.host_flags |= IDE_HFLAG_CLEAR_SIMPLEX;\r\nreturn ide_pci_init_one(dev, &d, NULL);\r\n}\r\nstatic int __init ali15x3_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&alim15x3_pci_driver);\r\n}\r\nstatic void __exit ali15x3_ide_exit(void)\r\n{\r\npci_unregister_driver(&alim15x3_pci_driver);\r\n}

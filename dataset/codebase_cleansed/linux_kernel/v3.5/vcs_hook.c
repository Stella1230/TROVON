int hook_call(unsigned id, unsigned pcnt, ...)\r\n{\r\nva_list ap;\r\nunsigned i;\r\nunsigned ret;\r\n#ifdef USING_SOS\r\nPREEMPT_OFF_SAVE();\r\n#endif\r\nHOOK_DATA(0) = id;\r\nif (id == hook_print_str) {\r\nint i;\r\nchar *str;\r\nHOOK_DATA(1) = pcnt;\r\nva_start(ap, pcnt);\r\nstr = (char *)va_arg(ap, unsigned);\r\nfor (i = 0; i != pcnt; i++)\r\nHOOK_DATA_BYTE(8 + i) = str[i];\r\nHOOK_DATA_BYTE(8 + i) = 0;\r\n} else {\r\nva_start(ap, pcnt);\r\nfor (i = 1; i <= pcnt; i++)\r\nHOOK_DATA(i) = va_arg(ap, unsigned);\r\nva_end(ap);\r\n}\r\nret = *((volatile unsigned *)HOOK_MEM_BASE_ADDR);\r\nHOOK_TRIG(id);\r\nwhile (VHOOK_DATA(0) > 0) ;\r\nret = VHOOK_DATA(1);\r\n#ifdef USING_SOS\r\nPREEMPT_RESTORE();\r\n#endif\r\nreturn ret;\r\n}\r\nunsigned hook_buf(unsigned i)\r\n{\r\nreturn (HOOK_DATA(i));\r\n}\r\nvoid print_str(const char *str)\r\n{\r\nint i;\r\nfor (i = 1; str[i]; i++) ;\r\nhook_call(hook_print_str, i, str);\r\n}\r\nvoid CPU_KICK_DOG(void)\r\n{\r\n(void)hook_call(hook_kick_dog, 0);\r\n}\r\nvoid CPU_WATCHDOG_TIMEOUT(unsigned t)\r\n{\r\n(void)hook_call(hook_dog_timeout, 1, t);\r\n}

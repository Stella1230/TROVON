static int __devinit snd_pcsp_create(struct snd_card *card)\r\n{\r\nstatic struct snd_device_ops ops = { };\r\nstruct timespec tp;\r\nint err;\r\nint div, min_div, order;\r\nif (!nopcm) {\r\nhrtimer_get_res(CLOCK_MONOTONIC, &tp);\r\nif (tp.tv_sec || tp.tv_nsec > PCSP_MAX_PERIOD_NS) {\r\nprintk(KERN_ERR "PCSP: Timer resolution is not sufficient "\r\n"(%linS)\n", tp.tv_nsec);\r\nprintk(KERN_ERR "PCSP: Make sure you have HPET and ACPI "\r\n"enabled.\n");\r\nprintk(KERN_ERR "PCSP: Turned into nopcm mode.\n");\r\nnopcm = 1;\r\n}\r\n}\r\nif (loops_per_jiffy >= PCSP_MIN_LPJ && tp.tv_nsec <= PCSP_MIN_PERIOD_NS)\r\nmin_div = MIN_DIV;\r\nelse\r\nmin_div = MAX_DIV;\r\n#if PCSP_DEBUG\r\nprintk(KERN_DEBUG "PCSP: lpj=%li, min_div=%i, res=%li\n",\r\nloops_per_jiffy, min_div, tp.tv_nsec);\r\n#endif\r\ndiv = MAX_DIV / min_div;\r\norder = fls(div) - 1;\r\npcsp_chip.max_treble = min(order, PCSP_MAX_TREBLE);\r\npcsp_chip.treble = min(pcsp_chip.max_treble, PCSP_DEFAULT_TREBLE);\r\npcsp_chip.playback_ptr = 0;\r\npcsp_chip.period_ptr = 0;\r\natomic_set(&pcsp_chip.timer_active, 0);\r\npcsp_chip.enable = 1;\r\npcsp_chip.pcspkr = 1;\r\nspin_lock_init(&pcsp_chip.substream_lock);\r\npcsp_chip.card = card;\r\npcsp_chip.port = 0x61;\r\npcsp_chip.irq = -1;\r\npcsp_chip.dma = -1;\r\nerr = snd_device_new(card, SNDRV_DEV_LOWLEVEL, &pcsp_chip, &ops);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int __devinit snd_card_pcsp_probe(int devnum, struct device *dev)\r\n{\r\nstruct snd_card *card;\r\nint err;\r\nif (devnum != 0)\r\nreturn -EINVAL;\r\nhrtimer_init(&pcsp_chip.timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);\r\npcsp_chip.timer.function = pcsp_do_timer;\r\nerr = snd_card_create(index, id, THIS_MODULE, 0, &card);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_pcsp_create(card);\r\nif (err < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nif (!nopcm) {\r\nerr = snd_pcsp_new_pcm(&pcsp_chip);\r\nif (err < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\n}\r\nerr = snd_pcsp_new_mixer(&pcsp_chip, nopcm);\r\nif (err < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nsnd_card_set_dev(pcsp_chip.card, dev);\r\nstrcpy(card->driver, "PC-Speaker");\r\nstrcpy(card->shortname, "pcsp");\r\nsprintf(card->longname, "Internal PC-Speaker at port 0x%x",\r\npcsp_chip.port);\r\nerr = snd_card_register(card);\r\nif (err < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit alsa_card_pcsp_init(struct device *dev)\r\n{\r\nint err;\r\nerr = snd_card_pcsp_probe(0, dev);\r\nif (err) {\r\nprintk(KERN_ERR "PC-Speaker initialization failed.\n");\r\nreturn err;\r\n}\r\n#ifdef CONFIG_DEBUG_PAGEALLOC\r\nprintk(KERN_WARNING "PCSP: CONFIG_DEBUG_PAGEALLOC is enabled, "\r\n"which may make the sound noisy.\n");\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void __devexit alsa_card_pcsp_exit(struct snd_pcsp *chip)\r\n{\r\nsnd_card_free(chip->card);\r\n}\r\nstatic int __devinit pcsp_probe(struct platform_device *dev)\r\n{\r\nint err;\r\nerr = pcspkr_input_init(&pcsp_chip.input_dev, &dev->dev);\r\nif (err < 0)\r\nreturn err;\r\nerr = alsa_card_pcsp_init(&dev->dev);\r\nif (err < 0) {\r\npcspkr_input_remove(pcsp_chip.input_dev);\r\nreturn err;\r\n}\r\nplatform_set_drvdata(dev, &pcsp_chip);\r\nreturn 0;\r\n}\r\nstatic int __devexit pcsp_remove(struct platform_device *dev)\r\n{\r\nstruct snd_pcsp *chip = platform_get_drvdata(dev);\r\nalsa_card_pcsp_exit(chip);\r\npcspkr_input_remove(chip->input_dev);\r\nplatform_set_drvdata(dev, NULL);\r\nreturn 0;\r\n}\r\nstatic void pcsp_stop_beep(struct snd_pcsp *chip)\r\n{\r\npcsp_sync_stop(chip);\r\npcspkr_stop_sound();\r\n}\r\nstatic int pcsp_suspend(struct platform_device *dev, pm_message_t state)\r\n{\r\nstruct snd_pcsp *chip = platform_get_drvdata(dev);\r\npcsp_stop_beep(chip);\r\nsnd_pcm_suspend_all(chip->pcm);\r\nreturn 0;\r\n}\r\nstatic void pcsp_shutdown(struct platform_device *dev)\r\n{\r\nstruct snd_pcsp *chip = platform_get_drvdata(dev);\r\npcsp_stop_beep(chip);\r\n}\r\nstatic int __init pcsp_init(void)\r\n{\r\nif (!enable)\r\nreturn -ENODEV;\r\nreturn platform_driver_register(&pcsp_platform_driver);\r\n}\r\nstatic void __exit pcsp_exit(void)\r\n{\r\nplatform_driver_unregister(&pcsp_platform_driver);\r\n}

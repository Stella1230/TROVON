int InterfaceIdleModeRespond(PMINI_ADAPTER Adapter, unsigned int* puiBuffer)\r\n{\r\nint status = STATUS_SUCCESS;\r\nunsigned int uiRegRead = 0;\r\nint bytes;\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL,"SubType of Message :0x%X", ntohl(*puiBuffer));\r\nif(ntohl(*puiBuffer) == GO_TO_IDLE_MODE_PAYLOAD)\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL," Got GO_TO_IDLE_MODE_PAYLOAD(210) Msg Subtype");\r\nif(ntohl(*(puiBuffer+1)) == 0 )\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL,"Got IDLE MODE WAKE UP Response From F/W");\r\nstatus = wrmalt (Adapter,SW_ABORT_IDLEMODE_LOC, &uiRegRead, sizeof(uiRegRead));\r\nif(status)\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_PRINTK, 0, 0, "wrm failed while clearing Idle Mode Reg");\r\nreturn status;\r\n}\r\nif(Adapter->ulPowerSaveMode == DEVICE_POWERSAVE_MODE_AS_MANUAL_CLOCK_GATING)\r\n{\r\nuiRegRead = 0x00000000 ;\r\nstatus = wrmalt (Adapter,DEBUG_INTERRUPT_GENERATOR_REGISTOR, &uiRegRead, sizeof(uiRegRead));\r\nif(status)\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_PRINTK, 0, 0, "wrm failed while clearing Idle Mode Reg");\r\nreturn status;\r\n}\r\n}\r\nelse if(Adapter->ulPowerSaveMode != DEVICE_POWERSAVE_MODE_AS_PROTOCOL_IDLE_MODE)\r\n{\r\nbytes = rdmalt(Adapter, DEVICE_INT_OUT_EP_REG0, &uiRegRead, sizeof(uiRegRead));\r\nif (bytes < 0) {\r\nstatus = bytes;\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_PRINTK, 0, 0, "rdm failed while clearing H/W Abort Reg0");\r\nreturn status;\r\n}\r\nbytes = rdmalt(Adapter, DEVICE_INT_OUT_EP_REG1, &uiRegRead, sizeof(uiRegRead));\r\nif (bytes < 0) {\r\nstatus = bytes;\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_PRINTK, 0, 0, "rdm failed while clearing H/W Abort Reg1");\r\nreturn status;\r\n}\r\n}\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL, "Device Up from Idle Mode");\r\nAdapter->IdleMode = FALSE;\r\nAdapter->bTriedToWakeUpFromlowPowerMode = FALSE;\r\nwake_up(&Adapter->lowpower_mode_wait_queue);\r\n}\r\nelse\r\n{\r\nif(TRUE == Adapter->IdleMode)\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL,"Device is already in Idle mode....");\r\nreturn status ;\r\n}\r\nuiRegRead = 0;\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL, "Got Req from F/W to go in IDLE mode \n");\r\nif (Adapter->chip_id== BCS220_2 ||\r\nAdapter->chip_id == BCS220_2BC ||\r\nAdapter->chip_id== BCS250_BC ||\r\nAdapter->chip_id== BCS220_3)\r\n{\r\nbytes = rdmalt(Adapter, HPM_CONFIG_MSW, &uiRegRead, sizeof(uiRegRead));\r\nif (bytes < 0) {\r\nstatus = bytes;\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL, "rdm failed while Reading HPM_CONFIG_LDO145 Reg 0\n");\r\nreturn status;\r\n}\r\nuiRegRead |= (1<<17);\r\nstatus = wrmalt (Adapter,HPM_CONFIG_MSW, &uiRegRead, sizeof(uiRegRead));\r\nif(status)\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_PRINTK, 0, 0, "wrm failed while clearing Idle Mode Reg\n");\r\nreturn status;\r\n}\r\n}\r\nSendIdleModeResponse(Adapter);\r\n}\r\n}\r\nelse if(ntohl(*puiBuffer) == IDLE_MODE_SF_UPDATE_MSG)\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL, "OverRiding Service Flow Params");\r\nOverrideServiceFlowParams(Adapter,puiBuffer);\r\n}\r\nreturn status;\r\n}\r\nstatic int InterfaceAbortIdlemode(PMINI_ADAPTER Adapter, unsigned int Pattern)\r\n{\r\nint status = STATUS_SUCCESS;\r\nunsigned int value;\r\nunsigned int chip_id ;\r\nunsigned long timeout = 0 ,itr = 0;\r\nint lenwritten = 0;\r\nunsigned char aucAbortPattern[8]={0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF};\r\nPS_INTERFACE_ADAPTER psInterfaceAdapter = Adapter->pvInterfaceAdapter;\r\nif((TRUE == psInterfaceAdapter->bSuspended) && (TRUE == Adapter->bDoSuspend))\r\n{\r\nstatus = usb_autopm_get_interface(psInterfaceAdapter->interface);\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL,"Bus got wakeup..Aborting Idle mode... status:%d \n",status);\r\n}\r\nif((Adapter->ulPowerSaveMode == DEVICE_POWERSAVE_MODE_AS_MANUAL_CLOCK_GATING)\r\n||\r\n(Adapter->ulPowerSaveMode == DEVICE_POWERSAVE_MODE_AS_PROTOCOL_IDLE_MODE))\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL, "Writing pattern<%d> to SW_ABORT_IDLEMODE_LOC\n", Pattern);\r\nstatus = wrmalt(Adapter,SW_ABORT_IDLEMODE_LOC, &Pattern, sizeof(Pattern));\r\nif(status)\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL,"WRM to Register SW_ABORT_IDLEMODE_LOC failed..");\r\nreturn status;\r\n}\r\n}\r\nif(Adapter->ulPowerSaveMode == DEVICE_POWERSAVE_MODE_AS_MANUAL_CLOCK_GATING)\r\n{\r\nvalue = 0x80000000;\r\nstatus = wrmalt(Adapter,DEBUG_INTERRUPT_GENERATOR_REGISTOR, &value, sizeof(value));\r\nif(status)\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL,"WRM to DEBUG_INTERRUPT_GENERATOR_REGISTOR Register failed");\r\nreturn status;\r\n}\r\n}\r\nelse if(Adapter->ulPowerSaveMode != DEVICE_POWERSAVE_MODE_AS_PROTOCOL_IDLE_MODE)\r\n{\r\nstatus = usb_interrupt_msg (psInterfaceAdapter->udev,\r\nusb_sndintpipe(psInterfaceAdapter->udev,\r\npsInterfaceAdapter->sIntrOut.int_out_endpointAddr),\r\naucAbortPattern,\r\n8,\r\n&lenwritten,\r\n5000);\r\nif(status)\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL, "Sending Abort pattern down fails with status:%d..\n",status);\r\nreturn status;\r\n}\r\nelse\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL, "NOB Sent down :%d", lenwritten);\r\n}\r\ntimeout= jiffies + msecs_to_jiffies(50) ;\r\nwhile( timeout > jiffies )\r\n{\r\nitr++ ;\r\nrdmalt(Adapter, CHIP_ID_REG, &chip_id, sizeof(UINT));\r\nif(0xbece3200==(chip_id&~(0xF0)))\r\n{\r\nchip_id = chip_id&~(0xF0);\r\n}\r\nif(chip_id == Adapter->chip_id)\r\nbreak;\r\n}\r\nif(timeout < jiffies )\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL,"Not able to read chip-id even after 25 msec");\r\n}\r\nelse\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL,"Number of completed iteration to read chip-id :%lu", itr);\r\n}\r\nstatus = wrmalt(Adapter,SW_ABORT_IDLEMODE_LOC, &Pattern, sizeof(status));\r\nif(status)\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_PRINTK, 0, 0,"WRM to Register SW_ABORT_IDLEMODE_LOC failed..");\r\nreturn status;\r\n}\r\n}\r\nreturn status;\r\n}\r\nint InterfaceIdleModeWakeup(PMINI_ADAPTER Adapter)\r\n{\r\nULONG Status = 0;\r\nif(Adapter->bTriedToWakeUpFromlowPowerMode)\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL, "Wake up already attempted.. ignoring\n");\r\n}\r\nelse\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_OTHERS, IDLE_MODE, DBG_LVL_ALL,"Writing Low Power Mode Abort pattern to the Device\n");\r\nAdapter->bTriedToWakeUpFromlowPowerMode = TRUE;\r\nInterfaceAbortIdlemode(Adapter, Adapter->usIdleModePattern);\r\n}\r\nreturn Status;\r\n}\r\nvoid InterfaceHandleShutdownModeWakeup(PMINI_ADAPTER Adapter)\r\n{\r\nunsigned int uiRegVal = 0;\r\nINT Status = 0;\r\nint bytes;\r\nif(Adapter->ulPowerSaveMode == DEVICE_POWERSAVE_MODE_AS_MANUAL_CLOCK_GATING)\r\n{\r\nuiRegVal = 0;\r\nStatus =wrmalt(Adapter,DEBUG_INTERRUPT_GENERATOR_REGISTOR, &uiRegVal, sizeof(uiRegVal));\r\nif(Status)\r\n{\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_PRINTK, 0, 0,"WRM to DEBUG_INTERRUPT_GENERATOR_REGISTOR Failed with err :%d", Status);\r\nreturn;\r\n}\r\n}\r\nelse\r\n{\r\nbytes = rdmalt(Adapter,DEVICE_INT_OUT_EP_REG0, &uiRegVal, sizeof(uiRegVal));\r\nif (bytes < 0) {\r\nStatus = bytes;\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_PRINTK, 0, 0,"RDM of DEVICE_INT_OUT_EP_REG0 failed with Err :%d", Status);\r\nreturn;\r\n}\r\nbytes = rdmalt(Adapter,DEVICE_INT_OUT_EP_REG1, &uiRegVal, sizeof(uiRegVal));\r\nif (bytes < 0) {\r\nStatus = bytes;\r\nBCM_DEBUG_PRINT(Adapter,DBG_TYPE_PRINTK, 0, 0,"RDM of DEVICE_INT_OUT_EP_REG1 failed with Err :%d", Status);\r\nreturn;\r\n}\r\n}\r\n}

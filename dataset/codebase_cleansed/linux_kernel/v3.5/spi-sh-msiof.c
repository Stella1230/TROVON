static u32 sh_msiof_read(struct sh_msiof_spi_priv *p, int reg_offs)\r\n{\r\nswitch (reg_offs) {\r\ncase TSCR:\r\ncase RSCR:\r\nreturn ioread16(p->mapbase + reg_offs);\r\ndefault:\r\nreturn ioread32(p->mapbase + reg_offs);\r\n}\r\n}\r\nstatic void sh_msiof_write(struct sh_msiof_spi_priv *p, int reg_offs,\r\nu32 value)\r\n{\r\nswitch (reg_offs) {\r\ncase TSCR:\r\ncase RSCR:\r\niowrite16(value, p->mapbase + reg_offs);\r\nbreak;\r\ndefault:\r\niowrite32(value, p->mapbase + reg_offs);\r\nbreak;\r\n}\r\n}\r\nstatic int sh_msiof_modify_ctr_wait(struct sh_msiof_spi_priv *p,\r\nu32 clr, u32 set)\r\n{\r\nu32 mask = clr | set;\r\nu32 data;\r\nint k;\r\ndata = sh_msiof_read(p, CTR);\r\ndata &= ~clr;\r\ndata |= set;\r\nsh_msiof_write(p, CTR, data);\r\nfor (k = 100; k > 0; k--) {\r\nif ((sh_msiof_read(p, CTR) & mask) == set)\r\nbreak;\r\nudelay(10);\r\n}\r\nreturn k > 0 ? 0 : -ETIMEDOUT;\r\n}\r\nstatic irqreturn_t sh_msiof_spi_irq(int irq, void *data)\r\n{\r\nstruct sh_msiof_spi_priv *p = data;\r\nsh_msiof_write(p, IER, 0);\r\ncomplete(&p->done);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void sh_msiof_spi_set_clk_regs(struct sh_msiof_spi_priv *p,\r\nunsigned long parent_rate,\r\nunsigned long spi_hz)\r\n{\r\nunsigned long div = 1024;\r\nsize_t k;\r\nif (!WARN_ON(!spi_hz || !parent_rate))\r\ndiv = parent_rate / spi_hz;\r\nfor (k = 0; k < ARRAY_SIZE(sh_msiof_spi_clk_table); k++) {\r\nif (sh_msiof_spi_clk_table[k].div >= div)\r\nbreak;\r\n}\r\nk = min_t(int, k, ARRAY_SIZE(sh_msiof_spi_clk_table) - 1);\r\nsh_msiof_write(p, TSCR, sh_msiof_spi_clk_table[k].scr);\r\nsh_msiof_write(p, RSCR, sh_msiof_spi_clk_table[k].scr);\r\n}\r\nstatic void sh_msiof_spi_set_pin_regs(struct sh_msiof_spi_priv *p,\r\nu32 cpol, u32 cpha,\r\nu32 tx_hi_z, u32 lsb_first)\r\n{\r\nu32 tmp;\r\nint edge;\r\nsh_msiof_write(p, FCTR, 0);\r\nsh_msiof_write(p, TMDR1, 0xe2000005 | (lsb_first << 24));\r\nsh_msiof_write(p, RMDR1, 0x22000005 | (lsb_first << 24));\r\ntmp = 0xa0000000;\r\ntmp |= cpol << 30;\r\ntmp |= cpol << 28;\r\nedge = cpol ^ !cpha;\r\ntmp |= edge << 27;\r\ntmp |= edge << 26;\r\ntmp |= (tx_hi_z ? 2 : 0) << 22;\r\nsh_msiof_write(p, CTR, tmp);\r\n}\r\nstatic void sh_msiof_spi_set_mode_regs(struct sh_msiof_spi_priv *p,\r\nconst void *tx_buf, void *rx_buf,\r\nu32 bits, u32 words)\r\n{\r\nu32 dr2 = ((bits - 1) << 24) | ((words - 1) << 16);\r\nif (tx_buf)\r\nsh_msiof_write(p, TMDR2, dr2);\r\nelse\r\nsh_msiof_write(p, TMDR2, dr2 | 1);\r\nif (rx_buf)\r\nsh_msiof_write(p, RMDR2, dr2);\r\nsh_msiof_write(p, IER, STR_TEOF | STR_REOF);\r\n}\r\nstatic void sh_msiof_reset_str(struct sh_msiof_spi_priv *p)\r\n{\r\nsh_msiof_write(p, STR, sh_msiof_read(p, STR));\r\n}\r\nstatic void sh_msiof_spi_write_fifo_8(struct sh_msiof_spi_priv *p,\r\nconst void *tx_buf, int words, int fs)\r\n{\r\nconst u8 *buf_8 = tx_buf;\r\nint k;\r\nfor (k = 0; k < words; k++)\r\nsh_msiof_write(p, TFDR, buf_8[k] << fs);\r\n}\r\nstatic void sh_msiof_spi_write_fifo_16(struct sh_msiof_spi_priv *p,\r\nconst void *tx_buf, int words, int fs)\r\n{\r\nconst u16 *buf_16 = tx_buf;\r\nint k;\r\nfor (k = 0; k < words; k++)\r\nsh_msiof_write(p, TFDR, buf_16[k] << fs);\r\n}\r\nstatic void sh_msiof_spi_write_fifo_16u(struct sh_msiof_spi_priv *p,\r\nconst void *tx_buf, int words, int fs)\r\n{\r\nconst u16 *buf_16 = tx_buf;\r\nint k;\r\nfor (k = 0; k < words; k++)\r\nsh_msiof_write(p, TFDR, get_unaligned(&buf_16[k]) << fs);\r\n}\r\nstatic void sh_msiof_spi_write_fifo_32(struct sh_msiof_spi_priv *p,\r\nconst void *tx_buf, int words, int fs)\r\n{\r\nconst u32 *buf_32 = tx_buf;\r\nint k;\r\nfor (k = 0; k < words; k++)\r\nsh_msiof_write(p, TFDR, buf_32[k] << fs);\r\n}\r\nstatic void sh_msiof_spi_write_fifo_32u(struct sh_msiof_spi_priv *p,\r\nconst void *tx_buf, int words, int fs)\r\n{\r\nconst u32 *buf_32 = tx_buf;\r\nint k;\r\nfor (k = 0; k < words; k++)\r\nsh_msiof_write(p, TFDR, get_unaligned(&buf_32[k]) << fs);\r\n}\r\nstatic void sh_msiof_spi_write_fifo_s32(struct sh_msiof_spi_priv *p,\r\nconst void *tx_buf, int words, int fs)\r\n{\r\nconst u32 *buf_32 = tx_buf;\r\nint k;\r\nfor (k = 0; k < words; k++)\r\nsh_msiof_write(p, TFDR, swab32(buf_32[k] << fs));\r\n}\r\nstatic void sh_msiof_spi_write_fifo_s32u(struct sh_msiof_spi_priv *p,\r\nconst void *tx_buf, int words, int fs)\r\n{\r\nconst u32 *buf_32 = tx_buf;\r\nint k;\r\nfor (k = 0; k < words; k++)\r\nsh_msiof_write(p, TFDR, swab32(get_unaligned(&buf_32[k]) << fs));\r\n}\r\nstatic void sh_msiof_spi_read_fifo_8(struct sh_msiof_spi_priv *p,\r\nvoid *rx_buf, int words, int fs)\r\n{\r\nu8 *buf_8 = rx_buf;\r\nint k;\r\nfor (k = 0; k < words; k++)\r\nbuf_8[k] = sh_msiof_read(p, RFDR) >> fs;\r\n}\r\nstatic void sh_msiof_spi_read_fifo_16(struct sh_msiof_spi_priv *p,\r\nvoid *rx_buf, int words, int fs)\r\n{\r\nu16 *buf_16 = rx_buf;\r\nint k;\r\nfor (k = 0; k < words; k++)\r\nbuf_16[k] = sh_msiof_read(p, RFDR) >> fs;\r\n}\r\nstatic void sh_msiof_spi_read_fifo_16u(struct sh_msiof_spi_priv *p,\r\nvoid *rx_buf, int words, int fs)\r\n{\r\nu16 *buf_16 = rx_buf;\r\nint k;\r\nfor (k = 0; k < words; k++)\r\nput_unaligned(sh_msiof_read(p, RFDR) >> fs, &buf_16[k]);\r\n}\r\nstatic void sh_msiof_spi_read_fifo_32(struct sh_msiof_spi_priv *p,\r\nvoid *rx_buf, int words, int fs)\r\n{\r\nu32 *buf_32 = rx_buf;\r\nint k;\r\nfor (k = 0; k < words; k++)\r\nbuf_32[k] = sh_msiof_read(p, RFDR) >> fs;\r\n}\r\nstatic void sh_msiof_spi_read_fifo_32u(struct sh_msiof_spi_priv *p,\r\nvoid *rx_buf, int words, int fs)\r\n{\r\nu32 *buf_32 = rx_buf;\r\nint k;\r\nfor (k = 0; k < words; k++)\r\nput_unaligned(sh_msiof_read(p, RFDR) >> fs, &buf_32[k]);\r\n}\r\nstatic void sh_msiof_spi_read_fifo_s32(struct sh_msiof_spi_priv *p,\r\nvoid *rx_buf, int words, int fs)\r\n{\r\nu32 *buf_32 = rx_buf;\r\nint k;\r\nfor (k = 0; k < words; k++)\r\nbuf_32[k] = swab32(sh_msiof_read(p, RFDR) >> fs);\r\n}\r\nstatic void sh_msiof_spi_read_fifo_s32u(struct sh_msiof_spi_priv *p,\r\nvoid *rx_buf, int words, int fs)\r\n{\r\nu32 *buf_32 = rx_buf;\r\nint k;\r\nfor (k = 0; k < words; k++)\r\nput_unaligned(swab32(sh_msiof_read(p, RFDR) >> fs), &buf_32[k]);\r\n}\r\nstatic int sh_msiof_spi_bits(struct spi_device *spi, struct spi_transfer *t)\r\n{\r\nint bits;\r\nbits = t ? t->bits_per_word : 0;\r\nif (!bits)\r\nbits = spi->bits_per_word;\r\nreturn bits;\r\n}\r\nstatic unsigned long sh_msiof_spi_hz(struct spi_device *spi,\r\nstruct spi_transfer *t)\r\n{\r\nunsigned long hz;\r\nhz = t ? t->speed_hz : 0;\r\nif (!hz)\r\nhz = spi->max_speed_hz;\r\nreturn hz;\r\n}\r\nstatic int sh_msiof_spi_setup_transfer(struct spi_device *spi,\r\nstruct spi_transfer *t)\r\n{\r\nint bits;\r\nbits = sh_msiof_spi_bits(spi, t);\r\nif (bits < 8)\r\nreturn -EINVAL;\r\nif (bits > 32)\r\nreturn -EINVAL;\r\nreturn spi_bitbang_setup_transfer(spi, t);\r\n}\r\nstatic void sh_msiof_spi_chipselect(struct spi_device *spi, int is_on)\r\n{\r\nstruct sh_msiof_spi_priv *p = spi_master_get_devdata(spi->master);\r\nint value;\r\nif (spi->mode & SPI_CS_HIGH)\r\nvalue = (is_on == BITBANG_CS_ACTIVE) ? 1 : 0;\r\nelse\r\nvalue = (is_on == BITBANG_CS_ACTIVE) ? 0 : 1;\r\nif (is_on == BITBANG_CS_ACTIVE) {\r\nif (!test_and_set_bit(0, &p->flags)) {\r\npm_runtime_get_sync(&p->pdev->dev);\r\nclk_enable(p->clk);\r\n}\r\nsh_msiof_spi_set_pin_regs(p, !!(spi->mode & SPI_CPOL),\r\n!!(spi->mode & SPI_CPHA),\r\n!!(spi->mode & SPI_3WIRE),\r\n!!(spi->mode & SPI_LSB_FIRST));\r\n}\r\ngpio_set_value((unsigned)spi->controller_data, value);\r\nif (is_on == BITBANG_CS_INACTIVE) {\r\nif (test_and_clear_bit(0, &p->flags)) {\r\nclk_disable(p->clk);\r\npm_runtime_put(&p->pdev->dev);\r\n}\r\n}\r\n}\r\nstatic int sh_msiof_spi_txrx_once(struct sh_msiof_spi_priv *p,\r\nvoid (*tx_fifo)(struct sh_msiof_spi_priv *,\r\nconst void *, int, int),\r\nvoid (*rx_fifo)(struct sh_msiof_spi_priv *,\r\nvoid *, int, int),\r\nconst void *tx_buf, void *rx_buf,\r\nint words, int bits)\r\n{\r\nint fifo_shift;\r\nint ret;\r\nif (tx_buf)\r\nwords = min_t(int, words, p->tx_fifo_size);\r\nif (rx_buf)\r\nwords = min_t(int, words, p->rx_fifo_size);\r\nfifo_shift = 32 - bits;\r\nsh_msiof_spi_set_mode_regs(p, tx_buf, rx_buf, bits, words);\r\nif (tx_buf)\r\ntx_fifo(p, tx_buf, words, fifo_shift);\r\nret = sh_msiof_modify_ctr_wait(p, 0, CTR_TSCKE);\r\nif (rx_buf)\r\nret = ret ? ret : sh_msiof_modify_ctr_wait(p, 0, CTR_RXE);\r\nret = ret ? ret : sh_msiof_modify_ctr_wait(p, 0, CTR_TXE);\r\nINIT_COMPLETION(p->done);\r\nret = ret ? ret : sh_msiof_modify_ctr_wait(p, 0, CTR_TFSE);\r\nif (ret) {\r\ndev_err(&p->pdev->dev, "failed to start hardware\n");\r\ngoto err;\r\n}\r\nwait_for_completion(&p->done);\r\nif (rx_buf)\r\nrx_fifo(p, rx_buf, words, fifo_shift);\r\nsh_msiof_reset_str(p);\r\nret = sh_msiof_modify_ctr_wait(p, CTR_TFSE, 0);\r\nret = ret ? ret : sh_msiof_modify_ctr_wait(p, CTR_TXE, 0);\r\nif (rx_buf)\r\nret = ret ? ret : sh_msiof_modify_ctr_wait(p, CTR_RXE, 0);\r\nret = ret ? ret : sh_msiof_modify_ctr_wait(p, CTR_TSCKE, 0);\r\nif (ret) {\r\ndev_err(&p->pdev->dev, "failed to shut down hardware\n");\r\ngoto err;\r\n}\r\nreturn words;\r\nerr:\r\nsh_msiof_write(p, IER, 0);\r\nreturn ret;\r\n}\r\nstatic int sh_msiof_spi_txrx(struct spi_device *spi, struct spi_transfer *t)\r\n{\r\nstruct sh_msiof_spi_priv *p = spi_master_get_devdata(spi->master);\r\nvoid (*tx_fifo)(struct sh_msiof_spi_priv *, const void *, int, int);\r\nvoid (*rx_fifo)(struct sh_msiof_spi_priv *, void *, int, int);\r\nint bits;\r\nint bytes_per_word;\r\nint bytes_done;\r\nint words;\r\nint n;\r\nbool swab;\r\nbits = sh_msiof_spi_bits(spi, t);\r\nif (bits <= 8 && t->len > 15 && !(t->len & 3)) {\r\nbits = 32;\r\nswab = true;\r\n} else {\r\nswab = false;\r\n}\r\nif (bits <= 8) {\r\nbytes_per_word = 1;\r\ntx_fifo = sh_msiof_spi_write_fifo_8;\r\nrx_fifo = sh_msiof_spi_read_fifo_8;\r\n} else if (bits <= 16) {\r\nbytes_per_word = 2;\r\nif ((unsigned long)t->tx_buf & 0x01)\r\ntx_fifo = sh_msiof_spi_write_fifo_16u;\r\nelse\r\ntx_fifo = sh_msiof_spi_write_fifo_16;\r\nif ((unsigned long)t->rx_buf & 0x01)\r\nrx_fifo = sh_msiof_spi_read_fifo_16u;\r\nelse\r\nrx_fifo = sh_msiof_spi_read_fifo_16;\r\n} else if (swab) {\r\nbytes_per_word = 4;\r\nif ((unsigned long)t->tx_buf & 0x03)\r\ntx_fifo = sh_msiof_spi_write_fifo_s32u;\r\nelse\r\ntx_fifo = sh_msiof_spi_write_fifo_s32;\r\nif ((unsigned long)t->rx_buf & 0x03)\r\nrx_fifo = sh_msiof_spi_read_fifo_s32u;\r\nelse\r\nrx_fifo = sh_msiof_spi_read_fifo_s32;\r\n} else {\r\nbytes_per_word = 4;\r\nif ((unsigned long)t->tx_buf & 0x03)\r\ntx_fifo = sh_msiof_spi_write_fifo_32u;\r\nelse\r\ntx_fifo = sh_msiof_spi_write_fifo_32;\r\nif ((unsigned long)t->rx_buf & 0x03)\r\nrx_fifo = sh_msiof_spi_read_fifo_32u;\r\nelse\r\nrx_fifo = sh_msiof_spi_read_fifo_32;\r\n}\r\nsh_msiof_spi_set_clk_regs(p, clk_get_rate(p->clk),\r\nsh_msiof_spi_hz(spi, t));\r\nwords = t->len / bytes_per_word;\r\nbytes_done = 0;\r\nwhile (bytes_done < t->len) {\r\nvoid *rx_buf = t->rx_buf ? t->rx_buf + bytes_done : NULL;\r\nconst void *tx_buf = t->tx_buf ? t->tx_buf + bytes_done : NULL;\r\nn = sh_msiof_spi_txrx_once(p, tx_fifo, rx_fifo,\r\ntx_buf,\r\nrx_buf,\r\nwords, bits);\r\nif (n < 0)\r\nbreak;\r\nbytes_done += n * bytes_per_word;\r\nwords -= n;\r\n}\r\nreturn bytes_done;\r\n}\r\nstatic u32 sh_msiof_spi_txrx_word(struct spi_device *spi, unsigned nsecs,\r\nu32 word, u8 bits)\r\n{\r\nBUG();\r\nreturn 0;\r\n}\r\nstatic int sh_msiof_spi_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *r;\r\nstruct spi_master *master;\r\nstruct sh_msiof_spi_priv *p;\r\nchar clk_name[16];\r\nint i;\r\nint ret;\r\nmaster = spi_alloc_master(&pdev->dev, sizeof(struct sh_msiof_spi_priv));\r\nif (master == NULL) {\r\ndev_err(&pdev->dev, "failed to allocate spi master\n");\r\nret = -ENOMEM;\r\ngoto err0;\r\n}\r\np = spi_master_get_devdata(master);\r\nplatform_set_drvdata(pdev, p);\r\np->info = pdev->dev.platform_data;\r\ninit_completion(&p->done);\r\nsnprintf(clk_name, sizeof(clk_name), "msiof%d", pdev->id);\r\np->clk = clk_get(&pdev->dev, clk_name);\r\nif (IS_ERR(p->clk)) {\r\ndev_err(&pdev->dev, "cannot get clock \"%s\"\n", clk_name);\r\nret = PTR_ERR(p->clk);\r\ngoto err1;\r\n}\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ni = platform_get_irq(pdev, 0);\r\nif (!r || i < 0) {\r\ndev_err(&pdev->dev, "cannot get platform resources\n");\r\nret = -ENOENT;\r\ngoto err2;\r\n}\r\np->mapbase = ioremap_nocache(r->start, resource_size(r));\r\nif (!p->mapbase) {\r\ndev_err(&pdev->dev, "unable to ioremap\n");\r\nret = -ENXIO;\r\ngoto err2;\r\n}\r\nret = request_irq(i, sh_msiof_spi_irq, 0,\r\ndev_name(&pdev->dev), p);\r\nif (ret) {\r\ndev_err(&pdev->dev, "unable to request irq\n");\r\ngoto err3;\r\n}\r\np->pdev = pdev;\r\npm_runtime_enable(&pdev->dev);\r\np->tx_fifo_size = 64;\r\np->rx_fifo_size = 64;\r\nif (p->info->tx_fifo_override)\r\np->tx_fifo_size = p->info->tx_fifo_override;\r\nif (p->info->rx_fifo_override)\r\np->rx_fifo_size = p->info->rx_fifo_override;\r\nmaster->mode_bits = SPI_CPOL | SPI_CPHA | SPI_CS_HIGH;\r\nmaster->mode_bits |= SPI_LSB_FIRST | SPI_3WIRE;\r\nmaster->flags = 0;\r\nmaster->bus_num = pdev->id;\r\nmaster->num_chipselect = p->info->num_chipselect;\r\nmaster->setup = spi_bitbang_setup;\r\nmaster->cleanup = spi_bitbang_cleanup;\r\np->bitbang.master = master;\r\np->bitbang.chipselect = sh_msiof_spi_chipselect;\r\np->bitbang.setup_transfer = sh_msiof_spi_setup_transfer;\r\np->bitbang.txrx_bufs = sh_msiof_spi_txrx;\r\np->bitbang.txrx_word[SPI_MODE_0] = sh_msiof_spi_txrx_word;\r\np->bitbang.txrx_word[SPI_MODE_1] = sh_msiof_spi_txrx_word;\r\np->bitbang.txrx_word[SPI_MODE_2] = sh_msiof_spi_txrx_word;\r\np->bitbang.txrx_word[SPI_MODE_3] = sh_msiof_spi_txrx_word;\r\nret = spi_bitbang_start(&p->bitbang);\r\nif (ret == 0)\r\nreturn 0;\r\npm_runtime_disable(&pdev->dev);\r\nerr3:\r\niounmap(p->mapbase);\r\nerr2:\r\nclk_put(p->clk);\r\nerr1:\r\nspi_master_put(master);\r\nerr0:\r\nreturn ret;\r\n}\r\nstatic int sh_msiof_spi_remove(struct platform_device *pdev)\r\n{\r\nstruct sh_msiof_spi_priv *p = platform_get_drvdata(pdev);\r\nint ret;\r\nret = spi_bitbang_stop(&p->bitbang);\r\nif (!ret) {\r\npm_runtime_disable(&pdev->dev);\r\nfree_irq(platform_get_irq(pdev, 0), p);\r\niounmap(p->mapbase);\r\nclk_put(p->clk);\r\nspi_master_put(p->bitbang.master);\r\n}\r\nreturn ret;\r\n}\r\nstatic int sh_msiof_spi_runtime_nop(struct device *dev)\r\n{\r\nreturn 0;\r\n}

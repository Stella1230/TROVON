static inline void cpu_enter_lowpower(void)\r\n{\r\nunsigned int v;\r\nflush_cache_all();\r\nasm volatile(\r\n" mcr p15, 0, %1, c7, c5, 0\n"\r\n" mcr p15, 0, %1, c7, c10, 4\n"\r\n" mrc p15, 0, %0, c1, c0, 1\n"\r\n" bic %0, %0, #0x20\n"\r\n" mcr p15, 0, %0, c1, c0, 1\n"\r\n" mrc p15, 0, %0, c1, c0, 0\n"\r\n" bic %0, %0, %2\n"\r\n" mcr p15, 0, %0, c1, c0, 0\n"\r\n: "=&r" (v)\r\n: "r" (0), "Ir" (CR_C)\r\n: "cc");\r\n}\r\nstatic inline void cpu_leave_lowpower(void)\r\n{\r\nunsigned int v;\r\nasm volatile( "mrc p15, 0, %0, c1, c0, 0\n"\r\n" orr %0, %0, %1\n"\r\n" mcr p15, 0, %0, c1, c0, 0\n"\r\n" mrc p15, 0, %0, c1, c0, 1\n"\r\n" orr %0, %0, #0x20\n"\r\n" mcr p15, 0, %0, c1, c0, 1\n"\r\n: "=&r" (v)\r\n: "Ir" (CR_C)\r\n: "cc");\r\n}\r\nstatic inline void platform_do_lowpower(unsigned int cpu, int *spurious)\r\n{\r\nfor (;;) {\r\nasm(".word 0xe320f003\n"\r\n:\r\n:\r\n: "memory", "cc");\r\nif (pen_release == cpu_logical_map(cpu)) {\r\nbreak;\r\n}\r\n(*spurious)++;\r\n}\r\n}\r\nint platform_cpu_kill(unsigned int cpu)\r\n{\r\nreturn 1;\r\n}\r\nvoid platform_cpu_die(unsigned int cpu)\r\n{\r\nint spurious = 0;\r\ncpu_enter_lowpower();\r\nplatform_do_lowpower(cpu, &spurious);\r\ncpu_leave_lowpower();\r\nif (spurious)\r\npr_warn("CPU%u: %u spurious wakeup calls\n", cpu, spurious);\r\n}\r\nint platform_cpu_disable(unsigned int cpu)\r\n{\r\nreturn cpu == 0 ? -EPERM : 0;\r\n}

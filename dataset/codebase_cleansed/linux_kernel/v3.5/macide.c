int macide_test_irq(ide_hwif_t *hwif)\r\n{\r\nif (*ide_ifr & 0x20)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void macide_clear_irq(ide_drive_t *drive)\r\n{\r\n*ide_ifr &= ~0x20;\r\n}\r\nstatic void __init macide_setup_ports(struct ide_hw *hw, unsigned long base,\r\nint irq)\r\n{\r\nint i;\r\nmemset(hw, 0, sizeof(*hw));\r\nfor (i = 0; i < 8; i++)\r\nhw->io_ports_array[i] = base + i * 4;\r\nhw->io_ports.ctl_addr = base + IDE_CONTROL;\r\nhw->irq = irq;\r\n}\r\nstatic int __init macide_init(void)\r\n{\r\nunsigned long base;\r\nint irq;\r\nstruct ide_hw hw, *hws[] = { &hw };\r\nstruct ide_port_info d = macide_port_info;\r\nif (!MACH_IS_MAC)\r\nreturn -ENODEV;\r\nswitch (macintosh_config->ide_type) {\r\ncase MAC_IDE_QUADRA:\r\nbase = IDE_BASE;\r\nirq = IRQ_NUBUS_F;\r\nbreak;\r\ncase MAC_IDE_PB:\r\nbase = IDE_BASE;\r\nirq = IRQ_NUBUS_C;\r\nbreak;\r\ncase MAC_IDE_BABOON:\r\nbase = BABOON_BASE;\r\nd.port_ops = NULL;\r\nirq = IRQ_BABOON_1;\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\nprintk(KERN_INFO "ide: Macintosh %s IDE controller\n",\r\nmac_ide_name[macintosh_config->ide_type - 1]);\r\nmacide_setup_ports(&hw, base, irq);\r\nreturn ide_host_add(&d, hws, 1, NULL);\r\n}

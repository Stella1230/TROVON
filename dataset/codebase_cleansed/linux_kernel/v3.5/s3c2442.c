static unsigned long s3c2442_camif_upll_round(struct clk *clk,\r\nunsigned long rate)\r\n{\r\nunsigned long parent_rate = clk_get_rate(clk->parent);\r\nint div;\r\nif (rate > parent_rate)\r\nreturn parent_rate;\r\ndiv = parent_rate / rate;\r\nif (div == 3)\r\nreturn parent_rate / 3;\r\ndiv /= 2;\r\nif (div < 1)\r\ndiv = 1;\r\nelse if (div > 16)\r\ndiv = 16;\r\nreturn parent_rate / (div * 2);\r\n}\r\nstatic int s3c2442_camif_upll_setrate(struct clk *clk, unsigned long rate)\r\n{\r\nunsigned long parent_rate = clk_get_rate(clk->parent);\r\nunsigned long camdivn = __raw_readl(S3C2440_CAMDIVN);\r\nrate = s3c2442_camif_upll_round(clk, rate);\r\ncamdivn &= ~S3C2442_CAMDIVN_CAMCLK_DIV3;\r\nif (rate == parent_rate) {\r\ncamdivn &= ~S3C2440_CAMDIVN_CAMCLK_SEL;\r\n} else if ((parent_rate / rate) == 3) {\r\ncamdivn |= S3C2440_CAMDIVN_CAMCLK_SEL;\r\ncamdivn |= S3C2442_CAMDIVN_CAMCLK_DIV3;\r\n} else {\r\ncamdivn &= ~S3C2440_CAMDIVN_CAMCLK_MASK;\r\ncamdivn |= S3C2440_CAMDIVN_CAMCLK_SEL;\r\ncamdivn |= (((parent_rate / rate) / 2) - 1);\r\n}\r\n__raw_writel(camdivn, S3C2440_CAMDIVN);\r\nreturn 0;\r\n}\r\nstatic int s3c2442_clk_add(struct device *dev, struct subsys_interface *sif)\r\n{\r\nstruct clk *clock_upll;\r\nstruct clk *clock_h;\r\nstruct clk *clock_p;\r\nclock_p = clk_get(NULL, "pclk");\r\nclock_h = clk_get(NULL, "hclk");\r\nclock_upll = clk_get(NULL, "upll");\r\nif (IS_ERR(clock_p) || IS_ERR(clock_h) || IS_ERR(clock_upll)) {\r\nprintk(KERN_ERR "S3C2442: Failed to get parent clocks\n");\r\nreturn -EINVAL;\r\n}\r\ns3c2442_clk_cam.parent = clock_h;\r\ns3c2442_clk_cam_upll.parent = clock_upll;\r\ns3c24xx_register_clock(&s3c2442_clk_cam);\r\ns3c24xx_register_clock(&s3c2442_clk_cam_upll);\r\nclk_disable(&s3c2442_clk_cam);\r\nreturn 0;\r\n}\r\nstatic __init int s3c2442_clk_init(void)\r\n{\r\nreturn subsys_interface_register(&s3c2442_clk_interface);\r\n}\r\nint __init s3c2442_init(void)\r\n{\r\nprintk("S3C2442: Initialising architecture\n");\r\n#ifdef CONFIG_PM\r\nregister_syscore_ops(&s3c2410_pm_syscore_ops);\r\n#endif\r\nregister_syscore_ops(&s3c244x_pm_syscore_ops);\r\nregister_syscore_ops(&s3c24xx_irq_syscore_ops);\r\nreturn device_register(&s3c2442_dev);\r\n}\r\nvoid __init s3c2442_map_io(void)\r\n{\r\ns3c244x_map_io();\r\ns3c24xx_gpiocfg_default.set_pull = s3c24xx_gpio_setpull_1down;\r\ns3c24xx_gpiocfg_default.get_pull = s3c24xx_gpio_getpull_1down;\r\n}

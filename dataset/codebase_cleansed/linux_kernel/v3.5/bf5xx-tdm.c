static int bf5xx_tdm_set_dai_fmt(struct snd_soc_dai *cpu_dai,\r\nunsigned int fmt)\r\n{\r\nint ret = 0;\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_DSP_A:\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s: Unknown DAI format type\n", __func__);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\ncase SND_SOC_DAIFMT_CBM_CFS:\r\ncase SND_SOC_DAIFMT_CBS_CFM:\r\nret = -EINVAL;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s: Unknown DAI master type\n", __func__);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int bf5xx_tdm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct sport_device *sport_handle = snd_soc_dai_get_drvdata(dai);\r\nstruct bf5xx_tdm_port *bf5xx_tdm = sport_handle->private_data;\r\nint ret = 0;\r\nbf5xx_tdm->tcr2 &= ~0x1f;\r\nbf5xx_tdm->rcr2 &= ~0x1f;\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S32_LE:\r\nbf5xx_tdm->tcr2 |= 31;\r\nbf5xx_tdm->rcr2 |= 31;\r\nsport_handle->wdsize = 4;\r\nbreak;\r\ndefault:\r\npr_err("not supported PCM format yet\n");\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nif (!bf5xx_tdm->configured) {\r\nret = sport_config_rx(sport_handle, bf5xx_tdm->rcr1,\r\nbf5xx_tdm->rcr2, 0, 0);\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nreturn -EBUSY;\r\n}\r\nret = sport_config_tx(sport_handle, bf5xx_tdm->tcr1,\r\nbf5xx_tdm->tcr2, 0, 0);\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nreturn -EBUSY;\r\n}\r\nbf5xx_tdm->configured = 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void bf5xx_tdm_shutdown(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct sport_device *sport_handle = snd_soc_dai_get_drvdata(dai);\r\nstruct bf5xx_tdm_port *bf5xx_tdm = sport_handle->private_data;\r\nif (!dai->active)\r\nbf5xx_tdm->configured = 0;\r\n}\r\nstatic int bf5xx_tdm_set_channel_map(struct snd_soc_dai *dai,\r\nunsigned int tx_num, unsigned int *tx_slot,\r\nunsigned int rx_num, unsigned int *rx_slot)\r\n{\r\nstruct sport_device *sport_handle = snd_soc_dai_get_drvdata(dai);\r\nstruct bf5xx_tdm_port *bf5xx_tdm = sport_handle->private_data;\r\nint i;\r\nunsigned int slot;\r\nunsigned int tx_mapped = 0, rx_mapped = 0;\r\nif ((tx_num > BFIN_TDM_DAI_MAX_SLOTS) ||\r\n(rx_num > BFIN_TDM_DAI_MAX_SLOTS))\r\nreturn -EINVAL;\r\nfor (i = 0; i < tx_num; i++) {\r\nslot = tx_slot[i];\r\nif ((slot < BFIN_TDM_DAI_MAX_SLOTS) &&\r\n(!(tx_mapped & (1 << slot)))) {\r\nbf5xx_tdm->tx_map[i] = slot;\r\ntx_mapped |= 1 << slot;\r\n} else\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < rx_num; i++) {\r\nslot = rx_slot[i];\r\nif ((slot < BFIN_TDM_DAI_MAX_SLOTS) &&\r\n(!(rx_mapped & (1 << slot)))) {\r\nbf5xx_tdm->rx_map[i] = slot;\r\nrx_mapped |= 1 << slot;\r\n} else\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bf5xx_tdm_suspend(struct snd_soc_dai *dai)\r\n{\r\nstruct sport_device *sport = snd_soc_dai_get_drvdata(dai);\r\nif (dai->playback_active)\r\nsport_tx_stop(sport);\r\nif (dai->capture_active)\r\nsport_rx_stop(sport);\r\nperipheral_free_list(sport->pin_req);\r\nreturn 0;\r\n}\r\nstatic int bf5xx_tdm_resume(struct snd_soc_dai *dai)\r\n{\r\nint ret;\r\nstruct sport_device *sport = snd_soc_dai_get_drvdata(dai);\r\nret = sport_set_multichannel(sport, 8, 0xFF, 1);\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nret = -EBUSY;\r\n}\r\nret = sport_config_rx(sport, 0, 0x1F, 0, 0);\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nret = -EBUSY;\r\n}\r\nret = sport_config_tx(sport, 0, 0x1F, 0, 0);\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nret = -EBUSY;\r\n}\r\nperipheral_request_list(sport->pin_req, "soc-audio");\r\nreturn 0;\r\n}\r\nstatic int __devinit bfin_tdm_probe(struct platform_device *pdev)\r\n{\r\nstruct sport_device *sport_handle;\r\nint ret;\r\nsport_handle = sport_init(pdev, 4, 8 * sizeof(u32),\r\nsizeof(struct bf5xx_tdm_port));\r\nif (!sport_handle)\r\nreturn -ENODEV;\r\nret = sport_set_multichannel(sport_handle, 8, 0xFF, 1);\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nret = -EBUSY;\r\ngoto sport_config_err;\r\n}\r\nret = sport_config_rx(sport_handle, 0, 0x1F, 0, 0);\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nret = -EBUSY;\r\ngoto sport_config_err;\r\n}\r\nret = sport_config_tx(sport_handle, 0, 0x1F, 0, 0);\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nret = -EBUSY;\r\ngoto sport_config_err;\r\n}\r\nret = snd_soc_register_dai(&pdev->dev, &bf5xx_tdm_dai);\r\nif (ret) {\r\npr_err("Failed to register DAI: %d\n", ret);\r\ngoto sport_config_err;\r\n}\r\nreturn 0;\r\nsport_config_err:\r\nsport_done(sport_handle);\r\nreturn ret;\r\n}\r\nstatic int __devexit bfin_tdm_remove(struct platform_device *pdev)\r\n{\r\nstruct sport_device *sport_handle = platform_get_drvdata(pdev);\r\nsnd_soc_unregister_dai(&pdev->dev);\r\nsport_done(sport_handle);\r\nreturn 0;\r\n}

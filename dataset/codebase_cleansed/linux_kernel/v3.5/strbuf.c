int prefixcmp(const char *str, const char *prefix)\r\n{\r\nfor (; ; str++, prefix++)\r\nif (!*prefix)\r\nreturn 0;\r\nelse if (*str != *prefix)\r\nreturn (unsigned char)*prefix - (unsigned char)*str;\r\n}\r\nvoid strbuf_init(struct strbuf *sb, ssize_t hint)\r\n{\r\nsb->alloc = sb->len = 0;\r\nsb->buf = strbuf_slopbuf;\r\nif (hint)\r\nstrbuf_grow(sb, hint);\r\n}\r\nvoid strbuf_release(struct strbuf *sb)\r\n{\r\nif (sb->alloc) {\r\nfree(sb->buf);\r\nstrbuf_init(sb, 0);\r\n}\r\n}\r\nchar *strbuf_detach(struct strbuf *sb, size_t *sz)\r\n{\r\nchar *res = sb->alloc ? sb->buf : NULL;\r\nif (sz)\r\n*sz = sb->len;\r\nstrbuf_init(sb, 0);\r\nreturn res;\r\n}\r\nvoid strbuf_grow(struct strbuf *sb, size_t extra)\r\n{\r\nif (sb->len + extra + 1 <= sb->len)\r\ndie("you want to use way too much memory");\r\nif (!sb->alloc)\r\nsb->buf = NULL;\r\nALLOC_GROW(sb->buf, sb->len + extra + 1, sb->alloc);\r\n}\r\nstatic void strbuf_splice(struct strbuf *sb, size_t pos, size_t len,\r\nconst void *data, size_t dlen)\r\n{\r\nif (pos + len < pos)\r\ndie("you want to use way too much memory");\r\nif (pos > sb->len)\r\ndie("`pos' is too far after the end of the buffer");\r\nif (pos + len > sb->len)\r\ndie("`pos + len' is too far after the end of the buffer");\r\nif (dlen >= len)\r\nstrbuf_grow(sb, dlen - len);\r\nmemmove(sb->buf + pos + dlen,\r\nsb->buf + pos + len,\r\nsb->len - pos - len);\r\nmemcpy(sb->buf + pos, data, dlen);\r\nstrbuf_setlen(sb, sb->len + dlen - len);\r\n}\r\nvoid strbuf_remove(struct strbuf *sb, size_t pos, size_t len)\r\n{\r\nstrbuf_splice(sb, pos, len, NULL, 0);\r\n}\r\nvoid strbuf_add(struct strbuf *sb, const void *data, size_t len)\r\n{\r\nstrbuf_grow(sb, len);\r\nmemcpy(sb->buf + sb->len, data, len);\r\nstrbuf_setlen(sb, sb->len + len);\r\n}\r\nvoid strbuf_addf(struct strbuf *sb, const char *fmt, ...)\r\n{\r\nint len;\r\nva_list ap;\r\nif (!strbuf_avail(sb))\r\nstrbuf_grow(sb, 64);\r\nva_start(ap, fmt);\r\nlen = vscnprintf(sb->buf + sb->len, sb->alloc - sb->len, fmt, ap);\r\nva_end(ap);\r\nif (len < 0)\r\ndie("your vscnprintf is broken");\r\nif (len > strbuf_avail(sb)) {\r\nstrbuf_grow(sb, len);\r\nva_start(ap, fmt);\r\nlen = vscnprintf(sb->buf + sb->len, sb->alloc - sb->len, fmt, ap);\r\nva_end(ap);\r\nif (len > strbuf_avail(sb)) {\r\ndie("this should not happen, your snprintf is broken");\r\n}\r\n}\r\nstrbuf_setlen(sb, sb->len + len);\r\n}\r\nssize_t strbuf_read(struct strbuf *sb, int fd, ssize_t hint)\r\n{\r\nsize_t oldlen = sb->len;\r\nsize_t oldalloc = sb->alloc;\r\nstrbuf_grow(sb, hint ? hint : 8192);\r\nfor (;;) {\r\nssize_t cnt;\r\ncnt = read(fd, sb->buf + sb->len, sb->alloc - sb->len - 1);\r\nif (cnt < 0) {\r\nif (oldalloc == 0)\r\nstrbuf_release(sb);\r\nelse\r\nstrbuf_setlen(sb, oldlen);\r\nreturn -1;\r\n}\r\nif (!cnt)\r\nbreak;\r\nsb->len += cnt;\r\nstrbuf_grow(sb, 8192);\r\n}\r\nsb->buf[sb->len] = '\0';\r\nreturn sb->len - oldlen;\r\n}

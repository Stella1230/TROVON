static int txx9_gpio_get(struct gpio_chip *chip, unsigned int offset)\r\n{\r\nreturn __raw_readl(&txx9_pioptr->din) & (1 << offset);\r\n}\r\nstatic void txx9_gpio_set_raw(unsigned int offset, int value)\r\n{\r\nu32 val;\r\nval = __raw_readl(&txx9_pioptr->dout);\r\nif (value)\r\nval |= 1 << offset;\r\nelse\r\nval &= ~(1 << offset);\r\n__raw_writel(val, &txx9_pioptr->dout);\r\n}\r\nstatic void txx9_gpio_set(struct gpio_chip *chip, unsigned int offset,\r\nint value)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&txx9_gpio_lock, flags);\r\ntxx9_gpio_set_raw(offset, value);\r\nmmiowb();\r\nspin_unlock_irqrestore(&txx9_gpio_lock, flags);\r\n}\r\nstatic int txx9_gpio_dir_in(struct gpio_chip *chip, unsigned int offset)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&txx9_gpio_lock, flags);\r\n__raw_writel(__raw_readl(&txx9_pioptr->dir) & ~(1 << offset),\r\n&txx9_pioptr->dir);\r\nmmiowb();\r\nspin_unlock_irqrestore(&txx9_gpio_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int txx9_gpio_dir_out(struct gpio_chip *chip, unsigned int offset,\r\nint value)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&txx9_gpio_lock, flags);\r\ntxx9_gpio_set_raw(offset, value);\r\n__raw_writel(__raw_readl(&txx9_pioptr->dir) | (1 << offset),\r\n&txx9_pioptr->dir);\r\nmmiowb();\r\nspin_unlock_irqrestore(&txx9_gpio_lock, flags);\r\nreturn 0;\r\n}\r\nint __init txx9_gpio_init(unsigned long baseaddr,\r\nunsigned int base, unsigned int num)\r\n{\r\ntxx9_pioptr = ioremap(baseaddr, sizeof(struct txx9_pio_reg));\r\nif (!txx9_pioptr)\r\nreturn -ENODEV;\r\ntxx9_gpio_chip.base = base;\r\ntxx9_gpio_chip.ngpio = num;\r\nreturn gpiochip_add(&txx9_gpio_chip);\r\n}

static int m68kspkr_event(struct input_dev *dev, unsigned int type, unsigned int code, int value)\r\n{\r\nunsigned int count = 0;\r\nif (type != EV_SND)\r\nreturn -1;\r\nswitch (code) {\r\ncase SND_BELL: if (value) value = 1000;\r\ncase SND_TONE: break;\r\ndefault: return -1;\r\n}\r\nif (value > 20 && value < 32767)\r\ncount = 1193182 / value;\r\nmach_beep(count, -1);\r\nreturn 0;\r\n}\r\nstatic int __devinit m68kspkr_probe(struct platform_device *dev)\r\n{\r\nstruct input_dev *input_dev;\r\nint err;\r\ninput_dev = input_allocate_device();\r\nif (!input_dev)\r\nreturn -ENOMEM;\r\ninput_dev->name = "m68k beeper";\r\ninput_dev->phys = "m68k/generic";\r\ninput_dev->id.bustype = BUS_HOST;\r\ninput_dev->id.vendor = 0x001f;\r\ninput_dev->id.product = 0x0001;\r\ninput_dev->id.version = 0x0100;\r\ninput_dev->dev.parent = &dev->dev;\r\ninput_dev->evbit[0] = BIT_MASK(EV_SND);\r\ninput_dev->sndbit[0] = BIT_MASK(SND_BELL) | BIT_MASK(SND_TONE);\r\ninput_dev->event = m68kspkr_event;\r\nerr = input_register_device(input_dev);\r\nif (err) {\r\ninput_free_device(input_dev);\r\nreturn err;\r\n}\r\nplatform_set_drvdata(dev, input_dev);\r\nreturn 0;\r\n}\r\nstatic int __devexit m68kspkr_remove(struct platform_device *dev)\r\n{\r\nstruct input_dev *input_dev = platform_get_drvdata(dev);\r\ninput_unregister_device(input_dev);\r\nplatform_set_drvdata(dev, NULL);\r\nm68kspkr_event(NULL, EV_SND, SND_BELL, 0);\r\nreturn 0;\r\n}\r\nstatic void m68kspkr_shutdown(struct platform_device *dev)\r\n{\r\nm68kspkr_event(NULL, EV_SND, SND_BELL, 0);\r\n}\r\nstatic int __init m68kspkr_init(void)\r\n{\r\nint err;\r\nif (!mach_beep) {\r\nprintk(KERN_INFO "m68kspkr: no lowlevel beep support\n");\r\nreturn -ENODEV;\r\n}\r\nerr = platform_driver_register(&m68kspkr_platform_driver);\r\nif (err)\r\nreturn err;\r\nm68kspkr_platform_device = platform_device_alloc("m68kspkr", -1);\r\nif (!m68kspkr_platform_device) {\r\nerr = -ENOMEM;\r\ngoto err_unregister_driver;\r\n}\r\nerr = platform_device_add(m68kspkr_platform_device);\r\nif (err)\r\ngoto err_free_device;\r\nreturn 0;\r\nerr_free_device:\r\nplatform_device_put(m68kspkr_platform_device);\r\nerr_unregister_driver:\r\nplatform_driver_unregister(&m68kspkr_platform_driver);\r\nreturn err;\r\n}\r\nstatic void __exit m68kspkr_exit(void)\r\n{\r\nplatform_device_unregister(m68kspkr_platform_device);\r\nplatform_driver_unregister(&m68kspkr_platform_driver);\r\n}

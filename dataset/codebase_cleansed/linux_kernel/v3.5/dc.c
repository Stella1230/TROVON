void dc_init(struct channel *sc)\r\n{\r\nu32 val;\r\ndc_stop(sc);\r\nval = SBE_2T3E3_21143_VAL_READ_LINE_ENABLE |\r\nSBE_2T3E3_21143_VAL_READ_MULTIPLE_ENABLE |\r\nSBE_2T3E3_21143_VAL_TRANSMIT_AUTOMATIC_POLLING_200us |\r\nSBE_2T3E3_21143_VAL_BUS_ARBITRATION_RR;\r\nif (sc->h.command & 16)\r\nval |= SBE_2T3E3_21143_VAL_WRITE_AND_INVALIDATE_ENABLE;\r\nswitch (sc->h.cache_size) {\r\ncase 32:\r\nval |= SBE_2T3E3_21143_VAL_CACHE_ALIGNMENT_32;\r\nbreak;\r\ncase 16:\r\nval |= SBE_2T3E3_21143_VAL_CACHE_ALIGNMENT_16;\r\nbreak;\r\ncase 8:\r\nval |= SBE_2T3E3_21143_VAL_CACHE_ALIGNMENT_8;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_BUS_MODE, val);\r\nval = SBE_2T3E3_21143_VAL_RECEIVE_ALL |\r\nSBE_2T3E3_21143_VAL_MUST_BE_ONE |\r\nSBE_2T3E3_21143_VAL_THRESHOLD_CONTROL_BITS_1 |\r\nSBE_2T3E3_21143_VAL_LOOPBACK_OFF |\r\nSBE_2T3E3_21143_VAL_PASS_ALL_MULTICAST |\r\nSBE_2T3E3_21143_VAL_PROMISCUOUS_MODE |\r\nSBE_2T3E3_21143_VAL_PASS_BAD_FRAMES;\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE, val);\r\nif (sc->p.loopback == SBE_2T3E3_LOOPBACK_ETHERNET)\r\nsc->p.loopback = SBE_2T3E3_LOOPBACK_NONE;\r\n#if 0\r\nval = 0;\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_BOOT_ROM_SERIAL_ROM_AND_MII_MANAGEMENT, val);\r\n#endif\r\nval = SBE_2T3E3_21143_VAL_CYCLE_SIZE |\r\nSBE_2T3E3_21143_VAL_TRANSMIT_TIMER |\r\nSBE_2T3E3_21143_VAL_NUMBER_OF_TRANSMIT_PACKETS |\r\nSBE_2T3E3_21143_VAL_RECEIVE_TIMER |\r\nSBE_2T3E3_21143_VAL_NUMBER_OF_RECEIVE_PACKETS;\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_GENERAL_PURPOSE_TIMER_AND_INTERRUPT_MITIGATION_CONTROL, val);\r\nif (dc_init_descriptor_list(sc) != 0)\r\nreturn;\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_STATUS, 0xFFFFFFFF);\r\ndc_set_output_port(sc);\r\n}\r\nvoid dc_start(struct channel *sc)\r\n{\r\nu32 val;\r\nif (!(sc->r.flags & SBE_2T3E3_FLAG_NETWORK_UP))\r\nreturn;\r\ndc_init(sc);\r\nswitch (sc->p.frame_type) {\r\ncase SBE_2T3E3_FRAME_TYPE_E3_G751:\r\ncase SBE_2T3E3_FRAME_TYPE_E3_G832:\r\nval = exar7250_read(sc, SBE_2T3E3_FRAMER_REG_E3_RX_CONFIGURATION_STATUS_2);\r\ndev_dbg(&sc->pdev->dev, "Start Framer Rx Status = %02X\n", val);\r\nsc->s.OOF = val & SBE_2T3E3_FRAMER_VAL_E3_RX_OOF ? 1 : 0;\r\nbreak;\r\ncase SBE_2T3E3_FRAME_TYPE_T3_CBIT:\r\ncase SBE_2T3E3_FRAME_TYPE_T3_M13:\r\nval = exar7250_read(sc, SBE_2T3E3_FRAMER_REG_T3_RX_CONFIGURATION_STATUS);\r\ndev_dbg(&sc->pdev->dev, "Start Framer Rx Status = %02X\n", val);\r\nsc->s.OOF = val & SBE_2T3E3_FRAMER_VAL_T3_RX_OOF ? 1 : 0;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ncpld_LOS_update(sc);\r\ndc_transmitter_onoff(sc, SBE_2T3E3_ON);\r\ndc_receiver_onoff(sc, SBE_2T3E3_ON);\r\ndc_start_intr(sc);\r\n}\r\nvoid dc_stop(struct channel *sc)\r\n{\r\nint wcnt;\r\ndc_receiver_onoff(sc, SBE_2T3E3_OFF);\r\ndc_transmitter_onoff(sc, SBE_2T3E3_OFF);\r\ndc_stop_intr(sc);\r\nfor (wcnt = 0; wcnt < MAX_INT_WAIT_CNT; wcnt++) {\r\nudelay(5);\r\nif (!sc->interrupt_active)\r\nbreak;\r\n}\r\nif (wcnt >= MAX_INT_WAIT_CNT)\r\ndev_warn(&sc->pdev->dev, "SBE 2T3E3: Interrupt active too long\n");\r\ndc_drop_descriptor_list(sc);\r\n}\r\nvoid dc_start_intr(struct channel *sc)\r\n{\r\nif (sc->p.loopback == SBE_2T3E3_LOOPBACK_NONE && sc->s.OOF)\r\nreturn;\r\nif (sc->p.receiver_on || sc->p.transmitter_on) {\r\nif (!sc->ether.interrupt_enable_mask)\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_STATUS, 0xFFFFFFFF);\r\nsc->ether.interrupt_enable_mask =\r\nSBE_2T3E3_21143_VAL_NORMAL_INTERRUPT_SUMMARY_ENABLE |\r\nSBE_2T3E3_21143_VAL_ABNORMAL_INTERRUPT_SUMMARY_ENABLE |\r\nSBE_2T3E3_21143_VAL_RECEIVE_STOPPED_ENABLE |\r\nSBE_2T3E3_21143_VAL_RECEIVE_BUFFER_UNAVAILABLE_ENABLE |\r\nSBE_2T3E3_21143_VAL_RECEIVE_INTERRUPT_ENABLE |\r\nSBE_2T3E3_21143_VAL_TRANSMIT_UNDERFLOW_INTERRUPT_ENABLE |\r\nSBE_2T3E3_21143_VAL_TRANSMIT_BUFFER_UNAVAILABLE_ENABLE |\r\nSBE_2T3E3_21143_VAL_TRANSMIT_STOPPED_ENABLE |\r\nSBE_2T3E3_21143_VAL_TRANSMIT_INTERRUPT_ENABLE;\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_INTERRUPT_ENABLE,\r\nsc->ether.interrupt_enable_mask);\r\n}\r\n}\r\nvoid dc_stop_intr(struct channel *sc)\r\n{\r\nsc->ether.interrupt_enable_mask = 0;\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_INTERRUPT_ENABLE, 0);\r\n}\r\nvoid dc_reset(struct channel *sc)\r\n{\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_INTERRUPT_ENABLE, 0);\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_STATUS, 0xFFFFFFFF);\r\ndc_set_bits(sc->addr, SBE_2T3E3_21143_REG_BUS_MODE,\r\nSBE_2T3E3_21143_VAL_SOFTWARE_RESET);\r\nudelay(4);\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_BUS_MODE, 0);\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE, 0);\r\ndc_set_bits(sc->addr, SBE_2T3E3_21143_REG_SIA_CONNECTIVITY,\r\nSBE_2T3E3_21143_VAL_SIA_RESET);\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_SIA_TRANSMIT_AND_RECEIVE, 0);\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_SIA_AND_GENERAL_PURPOSE_PORT, 0);\r\n}\r\nvoid dc_receiver_onoff(struct channel *sc, u32 mode)\r\n{\r\nu32 i, state = 0;\r\nif (sc->p.receiver_on == mode)\r\nreturn;\r\nswitch (mode) {\r\ncase SBE_2T3E3_OFF:\r\nif (dc_read(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE) &\r\nSBE_2T3E3_21143_VAL_RECEIVE_START) {\r\ndc_clear_bits(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE,\r\nSBE_2T3E3_21143_VAL_RECEIVE_START);\r\nfor (i = 0; i < 16; i++) {\r\nstate = dc_read(sc->addr, SBE_2T3E3_21143_REG_STATUS) &\r\nSBE_2T3E3_21143_VAL_RECEIVE_PROCESS_STATE;\r\nif (state == SBE_2T3E3_21143_VAL_RX_STOPPED)\r\nbreak;\r\nudelay(5);\r\n}\r\nif (state != SBE_2T3E3_21143_VAL_RX_STOPPED)\r\ndev_warn(&sc->pdev->dev, "SBE 2T3E3: Rx failed to stop\n");\r\nelse\r\ndev_info(&sc->pdev->dev, "SBE 2T3E3: Rx off\n");\r\n}\r\nbreak;\r\ncase SBE_2T3E3_ON:\r\ndc_set_bits(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE,\r\nSBE_2T3E3_21143_VAL_RECEIVE_START);\r\nudelay(100);\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_RECEIVE_POLL_DEMAND, 0xFFFFFFFF);\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nsc->p.receiver_on = mode;\r\n}\r\nvoid dc_transmitter_onoff(struct channel *sc, u32 mode)\r\n{\r\nu32 i, state = 0;\r\nif (sc->p.transmitter_on == mode)\r\nreturn;\r\nswitch (mode) {\r\ncase SBE_2T3E3_OFF:\r\nif (dc_read(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE) &\r\nSBE_2T3E3_21143_VAL_TRANSMISSION_START) {\r\ndc_clear_bits(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE,\r\nSBE_2T3E3_21143_VAL_TRANSMISSION_START);\r\nfor (i = 0; i < 16; i++) {\r\nstate = dc_read(sc->addr, SBE_2T3E3_21143_REG_STATUS) &\r\nSBE_2T3E3_21143_VAL_TRANSMISSION_PROCESS_STATE;\r\nif (state == SBE_2T3E3_21143_VAL_TX_STOPPED)\r\nbreak;\r\nudelay(5);\r\n}\r\nif (state != SBE_2T3E3_21143_VAL_TX_STOPPED)\r\ndev_warn(&sc->pdev->dev, "SBE 2T3E3: Tx failed to stop\n");\r\n}\r\nbreak;\r\ncase SBE_2T3E3_ON:\r\ndc_set_bits(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE,\r\nSBE_2T3E3_21143_VAL_TRANSMISSION_START);\r\nudelay(100);\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_TRANSMIT_POLL_DEMAND, 0xFFFFFFFF);\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nsc->p.transmitter_on = mode;\r\n}\r\nvoid dc_set_loopback(struct channel *sc, u32 mode)\r\n{\r\nu32 val;\r\nswitch (mode) {\r\ncase SBE_2T3E3_21143_VAL_LOOPBACK_OFF:\r\ncase SBE_2T3E3_21143_VAL_LOOPBACK_INTERNAL:\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\n#if 0\r\ndc_clear_bits(sc->addr, SBE_2T3E3_21143_REG_SIA_CONNECTIVITY,\r\nSBE_2T3E3_21143_VAL_SIA_RESET);\r\nudelay(1000);\r\ndc_set_bits(sc->addr, SBE_2T3E3_21143_REG_SIA_CONNECTIVITY,\r\nSBE_2T3E3_21143_VAL_SIA_RESET);\r\n#endif\r\nval = dc_read(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE) &\r\n~SBE_2T3E3_21143_VAL_OPERATING_MODE;\r\nval |= mode;\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE, val);\r\nif (mode == SBE_2T3E3_21143_VAL_LOOPBACK_OFF)\r\ndc_set_bits(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE,\r\nSBE_2T3E3_21143_VAL_FULL_DUPLEX_MODE);\r\nelse\r\ndc_clear_bits(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE,\r\nSBE_2T3E3_21143_VAL_FULL_DUPLEX_MODE);\r\n}\r\nu32 dc_init_descriptor_list(struct channel *sc)\r\n{\r\nu32 i, j;\r\nstruct sk_buff *m;\r\nif (sc->ether.rx_ring == NULL)\r\nsc->ether.rx_ring = kzalloc(SBE_2T3E3_RX_DESC_RING_SIZE *\r\nsizeof(t3e3_rx_desc_t), GFP_KERNEL);\r\nif (sc->ether.rx_ring == NULL) {\r\ndev_err(&sc->pdev->dev, "SBE 2T3E3: no buffer space for RX ring\n");\r\nreturn ENOMEM;\r\n}\r\nif (sc->ether.tx_ring == NULL)\r\nsc->ether.tx_ring = kzalloc(SBE_2T3E3_TX_DESC_RING_SIZE *\r\nsizeof(t3e3_tx_desc_t), GFP_KERNEL);\r\nif (sc->ether.tx_ring == NULL) {\r\nkfree(sc->ether.rx_ring);\r\nsc->ether.rx_ring = NULL;\r\ndev_err(&sc->pdev->dev, "SBE 2T3E3: no buffer space for RX ring\n");\r\nreturn ENOMEM;\r\n}\r\nfor (i = 0; i < SBE_2T3E3_RX_DESC_RING_SIZE; i++) {\r\nsc->ether.rx_ring[i].rdes0 = SBE_2T3E3_RX_DESC_21143_OWN;\r\nsc->ether.rx_ring[i].rdes1 =\r\nSBE_2T3E3_RX_DESC_SECOND_ADDRESS_CHAINED | SBE_2T3E3_MTU;\r\nif (sc->ether.rx_data[i] == NULL) {\r\nif (!(m = dev_alloc_skb(MCLBYTES))) {\r\nfor (j = 0; j < i; j++) {\r\ndev_kfree_skb_any(sc->ether.rx_data[j]);\r\nsc->ether.rx_data[j] = NULL;\r\n}\r\nkfree(sc->ether.rx_ring);\r\nsc->ether.rx_ring = NULL;\r\nkfree(sc->ether.tx_ring);\r\nsc->ether.tx_ring = NULL;\r\ndev_err(&sc->pdev->dev, "SBE 2T3E3: token_alloc err:"\r\n" no buffer space for RX ring\n");\r\nreturn ENOBUFS;\r\n}\r\nsc->ether.rx_data[i] = m;\r\n}\r\nsc->ether.rx_ring[i].rdes2 = virt_to_phys(sc->ether.rx_data[i]->data);\r\nsc->ether.rx_ring[i].rdes3 = virt_to_phys(\r\n&sc->ether.rx_ring[(i + 1) % SBE_2T3E3_RX_DESC_RING_SIZE]);\r\n}\r\nsc->ether.rx_ring[SBE_2T3E3_RX_DESC_RING_SIZE - 1].rdes1 |=\r\nSBE_2T3E3_RX_DESC_END_OF_RING;\r\nsc->ether.rx_ring_current_read = 0;\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_RECEIVE_LIST_BASE_ADDRESS,\r\nvirt_to_phys(&sc->ether.rx_ring[0]));\r\nfor (i = 0; i < SBE_2T3E3_TX_DESC_RING_SIZE; i++) {\r\nsc->ether.tx_ring[i].tdes0 = 0;\r\nsc->ether.tx_ring[i].tdes1 = SBE_2T3E3_TX_DESC_SECOND_ADDRESS_CHAINED |\r\nSBE_2T3E3_TX_DESC_DISABLE_PADDING;\r\nsc->ether.tx_ring[i].tdes2 = 0;\r\nsc->ether.tx_data[i] = NULL;\r\nsc->ether.tx_ring[i].tdes3 = virt_to_phys(\r\n&sc->ether.tx_ring[(i + 1) % SBE_2T3E3_TX_DESC_RING_SIZE]);\r\n}\r\nsc->ether.tx_ring[SBE_2T3E3_TX_DESC_RING_SIZE - 1].tdes1 |=\r\nSBE_2T3E3_TX_DESC_END_OF_RING;\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_TRANSMIT_LIST_BASE_ADDRESS,\r\nvirt_to_phys(&sc->ether.tx_ring[0]));\r\nsc->ether.tx_ring_current_read = 0;\r\nsc->ether.tx_ring_current_write = 0;\r\nsc->ether.tx_free_cnt = SBE_2T3E3_TX_DESC_RING_SIZE;\r\nspin_lock_init(&sc->ether.tx_lock);\r\nreturn 0;\r\n}\r\nvoid dc_clear_descriptor_list(struct channel *sc)\r\n{\r\nu32 i;\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_RECEIVE_LIST_BASE_ADDRESS, 0);\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_TRANSMIT_LIST_BASE_ADDRESS, 0);\r\nfor (i = 0; i < SBE_2T3E3_TX_DESC_RING_SIZE; i++) {\r\nif (sc->ether.tx_data[i] != NULL) {\r\ndev_kfree_skb_any(sc->ether.tx_data[i]);\r\nsc->ether.tx_data[i] = NULL;\r\n}\r\n}\r\n}\r\nvoid dc_drop_descriptor_list(struct channel *sc)\r\n{\r\nu32 i;\r\ndc_clear_descriptor_list(sc);\r\nfor (i = 0; i < SBE_2T3E3_RX_DESC_RING_SIZE; i++) {\r\nif (sc->ether.rx_data[i] != NULL) {\r\ndev_kfree_skb_any(sc->ether.rx_data[i]);\r\nsc->ether.rx_data[i] = NULL;\r\n}\r\n}\r\nkfree(sc->ether.rx_ring);\r\nsc->ether.rx_ring = NULL;\r\nkfree(sc->ether.tx_ring);\r\nsc->ether.tx_ring = NULL;\r\n}\r\nvoid dc_set_output_port(struct channel *sc)\r\n{\r\ndc_clear_bits(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE,\r\nSBE_2T3E3_21143_VAL_PORT_SELECT);\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_SIA_STATUS, 0x00000301);\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_SIA_CONNECTIVITY, 0);\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_SIA_TRANSMIT_AND_RECEIVE, 0);\r\ndc_write(sc->addr, SBE_2T3E3_21143_REG_SIA_AND_GENERAL_PURPOSE_PORT, 0x08000011);\r\ndc_set_bits(sc->addr, SBE_2T3E3_21143_REG_OPERATION_MODE,\r\nSBE_2T3E3_21143_VAL_TRANSMIT_THRESHOLD_MODE_100Mbs |\r\nSBE_2T3E3_21143_VAL_HEARTBEAT_DISABLE |\r\nSBE_2T3E3_21143_VAL_PORT_SELECT |\r\nSBE_2T3E3_21143_VAL_FULL_DUPLEX_MODE);\r\n}\r\nvoid dc_restart(struct channel *sc)\r\n{\r\ndev_warn(&sc->pdev->dev, "SBE 2T3E3: 21143 restart\n");\r\ndc_stop(sc);\r\ndc_reset(sc);\r\ndc_init(sc);\r\ndc_start(sc);\r\n}

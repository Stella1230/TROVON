static struct ltc4151_data *ltc4151_update_device(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ltc4151_data *data = i2c_get_clientdata(client);\r\nstruct ltc4151_data *ret = data;\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->last_updated + HZ / 6) || !data->valid) {\r\nint i;\r\ndev_dbg(&client->dev, "Starting ltc4151 update\n");\r\nfor (i = 0; i < ARRAY_SIZE(data->regs); i++) {\r\nint val;\r\nval = i2c_smbus_read_byte_data(client, i);\r\nif (unlikely(val < 0)) {\r\ndev_dbg(dev,\r\n"Failed to read ADC value: error %d\n",\r\nval);\r\nret = ERR_PTR(val);\r\ngoto abort;\r\n}\r\ndata->regs[i] = val;\r\n}\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\n}\r\nabort:\r\nmutex_unlock(&data->update_lock);\r\nreturn ret;\r\n}\r\nstatic int ltc4151_get_value(struct ltc4151_data *data, u8 reg)\r\n{\r\nu32 val;\r\nval = (data->regs[reg] << 4) + (data->regs[reg + 1] >> 4);\r\nswitch (reg) {\r\ncase LTC4151_ADIN_H:\r\nval = val * 500 / 1000;\r\nbreak;\r\ncase LTC4151_SENSE_H:\r\nval = val * 20;\r\nbreak;\r\ncase LTC4151_VIN_H:\r\nval = val * 25;\r\nbreak;\r\ndefault:\r\nWARN_ON_ONCE(1);\r\nval = 0;\r\nbreak;\r\n}\r\nreturn val;\r\n}\r\nstatic ssize_t ltc4151_show_value(struct device *dev,\r\nstruct device_attribute *da, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nstruct ltc4151_data *data = ltc4151_update_device(dev);\r\nint value;\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nvalue = ltc4151_get_value(data, attr->index);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", value);\r\n}\r\nstatic int ltc4151_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct i2c_adapter *adapter = client->adapter;\r\nstruct ltc4151_data *data;\r\nint ret;\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -ENODEV;\r\ndata = kzalloc(sizeof(*data), GFP_KERNEL);\r\nif (!data) {\r\nret = -ENOMEM;\r\ngoto out_kzalloc;\r\n}\r\ni2c_set_clientdata(client, data);\r\nmutex_init(&data->update_lock);\r\nret = sysfs_create_group(&client->dev.kobj, &ltc4151_group);\r\nif (ret)\r\ngoto out_sysfs_create_group;\r\ndata->hwmon_dev = hwmon_device_register(&client->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nret = PTR_ERR(data->hwmon_dev);\r\ngoto out_hwmon_device_register;\r\n}\r\nreturn 0;\r\nout_hwmon_device_register:\r\nsysfs_remove_group(&client->dev.kobj, &ltc4151_group);\r\nout_sysfs_create_group:\r\nkfree(data);\r\nout_kzalloc:\r\nreturn ret;\r\n}\r\nstatic int ltc4151_remove(struct i2c_client *client)\r\n{\r\nstruct ltc4151_data *data = i2c_get_clientdata(client);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nsysfs_remove_group(&client->dev.kobj, &ltc4151_group);\r\nkfree(data);\r\nreturn 0;\r\n}

static int cyttsp_spi_xfer(struct cyttsp *ts,\r\nu8 op, u8 reg, u8 *buf, int length)\r\n{\r\nstruct spi_device *spi = to_spi_device(ts->dev);\r\nstruct spi_message msg;\r\nstruct spi_transfer xfer[2];\r\nu8 *wr_buf = &ts->xfer_buf[0];\r\nu8 *rd_buf = &ts->xfer_buf[CY_SPI_DATA_BUF_SIZE];\r\nint retval;\r\nint i;\r\nif (length > CY_SPI_DATA_SIZE) {\r\ndev_err(ts->dev, "%s: length %d is too big.\n",\r\n__func__, length);\r\nreturn -EINVAL;\r\n}\r\nmemset(wr_buf, 0, CY_SPI_DATA_BUF_SIZE);\r\nmemset(rd_buf, 0, CY_SPI_DATA_BUF_SIZE);\r\nwr_buf[0] = 0x00;\r\nwr_buf[1] = 0xFF;\r\nwr_buf[2] = reg;\r\nwr_buf[3] = op;\r\nif (op == CY_SPI_WR_OP)\r\nmemcpy(wr_buf + CY_SPI_CMD_BYTES, buf, length);\r\nmemset(xfer, 0, sizeof(xfer));\r\nspi_message_init(&msg);\r\nxfer[0].tx_buf = wr_buf;\r\nxfer[0].rx_buf = rd_buf;\r\nswitch (op) {\r\ncase CY_SPI_WR_OP:\r\nxfer[0].len = length + CY_SPI_CMD_BYTES;\r\nspi_message_add_tail(&xfer[0], &msg);\r\nbreak;\r\ncase CY_SPI_RD_OP:\r\nxfer[0].len = CY_SPI_CMD_BYTES;\r\nspi_message_add_tail(&xfer[0], &msg);\r\nxfer[1].rx_buf = buf;\r\nxfer[1].len = length;\r\nspi_message_add_tail(&xfer[1], &msg);\r\nbreak;\r\ndefault:\r\ndev_err(ts->dev, "%s: bad operation code=%d\n", __func__, op);\r\nreturn -EINVAL;\r\n}\r\nretval = spi_sync(spi, &msg);\r\nif (retval < 0) {\r\ndev_dbg(ts->dev, "%s: spi_sync() error %d, len=%d, op=%d\n",\r\n__func__, retval, xfer[1].len, op);\r\n}\r\nif (rd_buf[CY_SPI_SYNC_BYTE] != CY_SPI_SYNC_ACK1 ||\r\nrd_buf[CY_SPI_SYNC_BYTE + 1] != CY_SPI_SYNC_ACK2) {\r\ndev_dbg(ts->dev, "%s: operation %d failed\n", __func__, op);\r\nfor (i = 0; i < CY_SPI_CMD_BYTES; i++)\r\ndev_dbg(ts->dev, "%s: test rd_buf[%d]:0x%02x\n",\r\n__func__, i, rd_buf[i]);\r\nfor (i = 0; i < length; i++)\r\ndev_dbg(ts->dev, "%s: test buf[%d]:0x%02x\n",\r\n__func__, i, buf[i]);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cyttsp_spi_read_block_data(struct cyttsp *ts,\r\nu8 addr, u8 length, void *data)\r\n{\r\nreturn cyttsp_spi_xfer(ts, CY_SPI_RD_OP, addr, data, length);\r\n}\r\nstatic int cyttsp_spi_write_block_data(struct cyttsp *ts,\r\nu8 addr, u8 length, const void *data)\r\n{\r\nreturn cyttsp_spi_xfer(ts, CY_SPI_WR_OP, addr, (void *)data, length);\r\n}\r\nstatic int __devinit cyttsp_spi_probe(struct spi_device *spi)\r\n{\r\nstruct cyttsp *ts;\r\nint error;\r\nspi->bits_per_word = CY_SPI_BITS_PER_WORD;\r\nspi->mode = SPI_MODE_0;\r\nerror = spi_setup(spi);\r\nif (error < 0) {\r\ndev_err(&spi->dev, "%s: SPI setup error %d\n",\r\n__func__, error);\r\nreturn error;\r\n}\r\nts = cyttsp_probe(&cyttsp_spi_bus_ops, &spi->dev, spi->irq,\r\nCY_SPI_DATA_BUF_SIZE * 2);\r\nif (IS_ERR(ts))\r\nreturn PTR_ERR(ts);\r\nspi_set_drvdata(spi, ts);\r\nreturn 0;\r\n}\r\nstatic int __devexit cyttsp_spi_remove(struct spi_device *spi)\r\n{\r\nstruct cyttsp *ts = spi_get_drvdata(spi);\r\ncyttsp_remove(ts);\r\nreturn 0;\r\n}

static int __devinit dwc3_pci_probe(struct pci_dev *pci,\r\nconst struct pci_device_id *id)\r\n{\r\nstruct resource res[2];\r\nstruct platform_device *dwc3;\r\nstruct dwc3_pci *glue;\r\nint ret = -ENOMEM;\r\nint devid;\r\nstruct device *dev = &pci->dev;\r\nglue = devm_kzalloc(dev, sizeof(*glue), GFP_KERNEL);\r\nif (!glue) {\r\ndev_err(dev, "not enough memory\n");\r\nreturn -ENOMEM;\r\n}\r\nglue->dev = dev;\r\nret = pci_enable_device(pci);\r\nif (ret) {\r\ndev_err(dev, "failed to enable pci device\n");\r\nreturn -ENODEV;\r\n}\r\npci_set_power_state(pci, PCI_D0);\r\npci_set_master(pci);\r\ndevid = dwc3_get_device_id();\r\nif (devid < 0) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\ndwc3 = platform_device_alloc("dwc3", devid);\r\nif (!dwc3) {\r\ndev_err(dev, "couldn't allocate dwc3 device\n");\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nmemset(res, 0x00, sizeof(struct resource) * ARRAY_SIZE(res));\r\nres[0].start = pci_resource_start(pci, 0);\r\nres[0].end = pci_resource_end(pci, 0);\r\nres[0].name = "dwc_usb3";\r\nres[0].flags = IORESOURCE_MEM;\r\nres[1].start = pci->irq;\r\nres[1].name = "dwc_usb3";\r\nres[1].flags = IORESOURCE_IRQ;\r\nret = platform_device_add_resources(dwc3, res, ARRAY_SIZE(res));\r\nif (ret) {\r\ndev_err(dev, "couldn't add resources to dwc3 device\n");\r\ngoto err2;\r\n}\r\npci_set_drvdata(pci, glue);\r\ndma_set_coherent_mask(&dwc3->dev, dev->coherent_dma_mask);\r\ndwc3->dev.dma_mask = dev->dma_mask;\r\ndwc3->dev.dma_parms = dev->dma_parms;\r\ndwc3->dev.parent = dev;\r\nglue->dwc3 = dwc3;\r\nret = platform_device_add(dwc3);\r\nif (ret) {\r\ndev_err(dev, "failed to register dwc3 device\n");\r\ngoto err3;\r\n}\r\nreturn 0;\r\nerr3:\r\npci_set_drvdata(pci, NULL);\r\nplatform_device_put(dwc3);\r\nerr2:\r\ndwc3_put_device_id(devid);\r\nerr1:\r\npci_disable_device(pci);\r\nreturn ret;\r\n}\r\nstatic void __devexit dwc3_pci_remove(struct pci_dev *pci)\r\n{\r\nstruct dwc3_pci *glue = pci_get_drvdata(pci);\r\ndwc3_put_device_id(glue->dwc3->id);\r\nplatform_device_unregister(glue->dwc3);\r\npci_set_drvdata(pci, NULL);\r\npci_disable_device(pci);\r\n}

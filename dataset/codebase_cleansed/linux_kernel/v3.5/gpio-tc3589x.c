static inline struct tc3589x_gpio *to_tc3589x_gpio(struct gpio_chip *chip)\r\n{\r\nreturn container_of(chip, struct tc3589x_gpio, chip);\r\n}\r\nstatic int tc3589x_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = to_tc3589x_gpio(chip);\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nu8 reg = TC3589x_GPIODATA0 + (offset / 8) * 2;\r\nu8 mask = 1 << (offset % 8);\r\nint ret;\r\nret = tc3589x_reg_read(tc3589x, reg);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn ret & mask;\r\n}\r\nstatic void tc3589x_gpio_set(struct gpio_chip *chip, unsigned offset, int val)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = to_tc3589x_gpio(chip);\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nu8 reg = TC3589x_GPIODATA0 + (offset / 8) * 2;\r\nunsigned pos = offset % 8;\r\nu8 data[] = {!!val << pos, 1 << pos};\r\ntc3589x_block_write(tc3589x, reg, ARRAY_SIZE(data), data);\r\n}\r\nstatic int tc3589x_gpio_direction_output(struct gpio_chip *chip,\r\nunsigned offset, int val)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = to_tc3589x_gpio(chip);\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nu8 reg = TC3589x_GPIODIR0 + offset / 8;\r\nunsigned pos = offset % 8;\r\ntc3589x_gpio_set(chip, offset, val);\r\nreturn tc3589x_set_bits(tc3589x, reg, 1 << pos, 1 << pos);\r\n}\r\nstatic int tc3589x_gpio_direction_input(struct gpio_chip *chip,\r\nunsigned offset)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = to_tc3589x_gpio(chip);\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nu8 reg = TC3589x_GPIODIR0 + offset / 8;\r\nunsigned pos = offset % 8;\r\nreturn tc3589x_set_bits(tc3589x, reg, 1 << pos, 0);\r\n}\r\nstatic int tc3589x_gpio_to_irq(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = to_tc3589x_gpio(chip);\r\nreturn tc3589x_gpio->irq_base + offset;\r\n}\r\nstatic int tc3589x_gpio_irq_set_type(struct irq_data *d, unsigned int type)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = irq_data_get_irq_chip_data(d);\r\nint offset = d->irq - tc3589x_gpio->irq_base;\r\nint regoffset = offset / 8;\r\nint mask = 1 << (offset % 8);\r\nif (type == IRQ_TYPE_EDGE_BOTH) {\r\ntc3589x_gpio->regs[REG_IBE][regoffset] |= mask;\r\nreturn 0;\r\n}\r\ntc3589x_gpio->regs[REG_IBE][regoffset] &= ~mask;\r\nif (type == IRQ_TYPE_LEVEL_LOW || type == IRQ_TYPE_LEVEL_HIGH)\r\ntc3589x_gpio->regs[REG_IS][regoffset] |= mask;\r\nelse\r\ntc3589x_gpio->regs[REG_IS][regoffset] &= ~mask;\r\nif (type == IRQ_TYPE_EDGE_RISING || type == IRQ_TYPE_LEVEL_HIGH)\r\ntc3589x_gpio->regs[REG_IEV][regoffset] |= mask;\r\nelse\r\ntc3589x_gpio->regs[REG_IEV][regoffset] &= ~mask;\r\nreturn 0;\r\n}\r\nstatic void tc3589x_gpio_irq_lock(struct irq_data *d)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = irq_data_get_irq_chip_data(d);\r\nmutex_lock(&tc3589x_gpio->irq_lock);\r\n}\r\nstatic void tc3589x_gpio_irq_sync_unlock(struct irq_data *d)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = irq_data_get_irq_chip_data(d);\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nstatic const u8 regmap[] = {\r\n[REG_IBE] = TC3589x_GPIOIBE0,\r\n[REG_IEV] = TC3589x_GPIOIEV0,\r\n[REG_IS] = TC3589x_GPIOIS0,\r\n[REG_IE] = TC3589x_GPIOIE0,\r\n};\r\nint i, j;\r\nfor (i = 0; i < CACHE_NR_REGS; i++) {\r\nfor (j = 0; j < CACHE_NR_BANKS; j++) {\r\nu8 old = tc3589x_gpio->oldregs[i][j];\r\nu8 new = tc3589x_gpio->regs[i][j];\r\nif (new == old)\r\ncontinue;\r\ntc3589x_gpio->oldregs[i][j] = new;\r\ntc3589x_reg_write(tc3589x, regmap[i] + j * 8, new);\r\n}\r\n}\r\nmutex_unlock(&tc3589x_gpio->irq_lock);\r\n}\r\nstatic void tc3589x_gpio_irq_mask(struct irq_data *d)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = irq_data_get_irq_chip_data(d);\r\nint offset = d->irq - tc3589x_gpio->irq_base;\r\nint regoffset = offset / 8;\r\nint mask = 1 << (offset % 8);\r\ntc3589x_gpio->regs[REG_IE][regoffset] &= ~mask;\r\n}\r\nstatic void tc3589x_gpio_irq_unmask(struct irq_data *d)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = irq_data_get_irq_chip_data(d);\r\nint offset = d->irq - tc3589x_gpio->irq_base;\r\nint regoffset = offset / 8;\r\nint mask = 1 << (offset % 8);\r\ntc3589x_gpio->regs[REG_IE][regoffset] |= mask;\r\n}\r\nstatic irqreturn_t tc3589x_gpio_irq(int irq, void *dev)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = dev;\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nu8 status[CACHE_NR_BANKS];\r\nint ret;\r\nint i;\r\nret = tc3589x_block_read(tc3589x, TC3589x_GPIOMIS0,\r\nARRAY_SIZE(status), status);\r\nif (ret < 0)\r\nreturn IRQ_NONE;\r\nfor (i = 0; i < ARRAY_SIZE(status); i++) {\r\nunsigned int stat = status[i];\r\nif (!stat)\r\ncontinue;\r\nwhile (stat) {\r\nint bit = __ffs(stat);\r\nint line = i * 8 + bit;\r\nhandle_nested_irq(tc3589x_gpio->irq_base + line);\r\nstat &= ~(1 << bit);\r\n}\r\ntc3589x_reg_write(tc3589x, TC3589x_GPIOIC0 + i, status[i]);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int tc3589x_gpio_irq_init(struct tc3589x_gpio *tc3589x_gpio)\r\n{\r\nint base = tc3589x_gpio->irq_base;\r\nint irq;\r\nfor (irq = base; irq < base + tc3589x_gpio->chip.ngpio; irq++) {\r\nirq_set_chip_data(irq, tc3589x_gpio);\r\nirq_set_chip_and_handler(irq, &tc3589x_gpio_irq_chip,\r\nhandle_simple_irq);\r\nirq_set_nested_thread(irq, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(irq, IRQF_VALID);\r\n#else\r\nirq_set_noprobe(irq);\r\n#endif\r\n}\r\nreturn 0;\r\n}\r\nstatic void tc3589x_gpio_irq_remove(struct tc3589x_gpio *tc3589x_gpio)\r\n{\r\nint base = tc3589x_gpio->irq_base;\r\nint irq;\r\nfor (irq = base; irq < base + tc3589x_gpio->chip.ngpio; irq++) {\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(irq, 0);\r\n#endif\r\nirq_set_chip_and_handler(irq, NULL, NULL);\r\nirq_set_chip_data(irq, NULL);\r\n}\r\n}\r\nstatic int __devinit tc3589x_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct tc3589x *tc3589x = dev_get_drvdata(pdev->dev.parent);\r\nstruct tc3589x_gpio_platform_data *pdata;\r\nstruct tc3589x_gpio *tc3589x_gpio;\r\nint ret;\r\nint irq;\r\npdata = tc3589x->pdata->gpio;\r\nif (!pdata)\r\nreturn -ENODEV;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0)\r\nreturn irq;\r\ntc3589x_gpio = kzalloc(sizeof(struct tc3589x_gpio), GFP_KERNEL);\r\nif (!tc3589x_gpio)\r\nreturn -ENOMEM;\r\nmutex_init(&tc3589x_gpio->irq_lock);\r\ntc3589x_gpio->dev = &pdev->dev;\r\ntc3589x_gpio->tc3589x = tc3589x;\r\ntc3589x_gpio->chip = template_chip;\r\ntc3589x_gpio->chip.ngpio = tc3589x->num_gpio;\r\ntc3589x_gpio->chip.dev = &pdev->dev;\r\ntc3589x_gpio->chip.base = pdata->gpio_base;\r\ntc3589x_gpio->irq_base = tc3589x->irq_base + TC3589x_INT_GPIO(0);\r\nret = tc3589x_set_bits(tc3589x, TC3589x_RSTCTRL,\r\nTC3589x_RSTCTRL_GPIRST, 0);\r\nif (ret < 0)\r\ngoto out_free;\r\nret = tc3589x_gpio_irq_init(tc3589x_gpio);\r\nif (ret)\r\ngoto out_free;\r\nret = request_threaded_irq(irq, NULL, tc3589x_gpio_irq, IRQF_ONESHOT,\r\n"tc3589x-gpio", tc3589x_gpio);\r\nif (ret) {\r\ndev_err(&pdev->dev, "unable to get irq: %d\n", ret);\r\ngoto out_removeirq;\r\n}\r\nret = gpiochip_add(&tc3589x_gpio->chip);\r\nif (ret) {\r\ndev_err(&pdev->dev, "unable to add gpiochip: %d\n", ret);\r\ngoto out_freeirq;\r\n}\r\nif (pdata->setup)\r\npdata->setup(tc3589x, tc3589x_gpio->chip.base);\r\nplatform_set_drvdata(pdev, tc3589x_gpio);\r\nreturn 0;\r\nout_freeirq:\r\nfree_irq(irq, tc3589x_gpio);\r\nout_removeirq:\r\ntc3589x_gpio_irq_remove(tc3589x_gpio);\r\nout_free:\r\nkfree(tc3589x_gpio);\r\nreturn ret;\r\n}\r\nstatic int __devexit tc3589x_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct tc3589x_gpio *tc3589x_gpio = platform_get_drvdata(pdev);\r\nstruct tc3589x *tc3589x = tc3589x_gpio->tc3589x;\r\nstruct tc3589x_gpio_platform_data *pdata = tc3589x->pdata->gpio;\r\nint irq = platform_get_irq(pdev, 0);\r\nint ret;\r\nif (pdata->remove)\r\npdata->remove(tc3589x, tc3589x_gpio->chip.base);\r\nret = gpiochip_remove(&tc3589x_gpio->chip);\r\nif (ret < 0) {\r\ndev_err(tc3589x_gpio->dev,\r\n"unable to remove gpiochip: %d\n", ret);\r\nreturn ret;\r\n}\r\nfree_irq(irq, tc3589x_gpio);\r\ntc3589x_gpio_irq_remove(tc3589x_gpio);\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(tc3589x_gpio);\r\nreturn 0;\r\n}\r\nstatic int __init tc3589x_gpio_init(void)\r\n{\r\nreturn platform_driver_register(&tc3589x_gpio_driver);\r\n}\r\nstatic void __exit tc3589x_gpio_exit(void)\r\n{\r\nplatform_driver_unregister(&tc3589x_gpio_driver);\r\n}

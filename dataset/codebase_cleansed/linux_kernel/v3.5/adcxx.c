static ssize_t adcxx_read(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct adcxx *adc = spi_get_drvdata(spi);\r\nu8 tx_buf[2];\r\nu8 rx_buf[2];\r\nint status;\r\nu32 value;\r\nif (mutex_lock_interruptible(&adc->lock))\r\nreturn -ERESTARTSYS;\r\nif (adc->channels == 1) {\r\nstatus = spi_read(spi, rx_buf, sizeof(rx_buf));\r\n} else {\r\ntx_buf[0] = attr->index << 3;\r\nstatus = spi_write_then_read(spi, tx_buf, sizeof(tx_buf),\r\nrx_buf, sizeof(rx_buf));\r\n}\r\nif (status < 0) {\r\ndev_warn(dev, "SPI synch. transfer failed with status %d\n",\r\nstatus);\r\ngoto out;\r\n}\r\nvalue = (rx_buf[0] << 8) + rx_buf[1];\r\ndev_dbg(dev, "raw value = 0x%x\n", value);\r\nvalue = value * adc->reference >> 12;\r\nstatus = sprintf(buf, "%d\n", value);\r\nout:\r\nmutex_unlock(&adc->lock);\r\nreturn status;\r\n}\r\nstatic ssize_t adcxx_show_min(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nreturn sprintf(buf, "0\n");\r\n}\r\nstatic ssize_t adcxx_show_max(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct adcxx *adc = spi_get_drvdata(spi);\r\nu32 reference;\r\nif (mutex_lock_interruptible(&adc->lock))\r\nreturn -ERESTARTSYS;\r\nreference = adc->reference;\r\nmutex_unlock(&adc->lock);\r\nreturn sprintf(buf, "%d\n", reference);\r\n}\r\nstatic ssize_t adcxx_set_max(struct device *dev,\r\nstruct device_attribute *devattr, const char *buf, size_t count)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct adcxx *adc = spi_get_drvdata(spi);\r\nunsigned long value;\r\nif (kstrtoul(buf, 10, &value))\r\nreturn -EINVAL;\r\nif (mutex_lock_interruptible(&adc->lock))\r\nreturn -ERESTARTSYS;\r\nadc->reference = value;\r\nmutex_unlock(&adc->lock);\r\nreturn count;\r\n}\r\nstatic ssize_t adcxx_show_name(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct adcxx *adc = spi_get_drvdata(spi);\r\nreturn sprintf(buf, "adcxx%ds\n", adc->channels);\r\n}\r\nstatic int __devinit adcxx_probe(struct spi_device *spi)\r\n{\r\nint channels = spi_get_device_id(spi)->driver_data;\r\nstruct adcxx *adc;\r\nint status;\r\nint i;\r\nadc = kzalloc(sizeof *adc, GFP_KERNEL);\r\nif (!adc)\r\nreturn -ENOMEM;\r\nadc->reference = 3300;\r\nadc->channels = channels;\r\nmutex_init(&adc->lock);\r\nmutex_lock(&adc->lock);\r\nspi_set_drvdata(spi, adc);\r\nfor (i = 0; i < 3 + adc->channels; i++) {\r\nstatus = device_create_file(&spi->dev, &ad_input[i].dev_attr);\r\nif (status) {\r\ndev_err(&spi->dev, "device_create_file failed.\n");\r\ngoto out_err;\r\n}\r\n}\r\nadc->hwmon_dev = hwmon_device_register(&spi->dev);\r\nif (IS_ERR(adc->hwmon_dev)) {\r\ndev_err(&spi->dev, "hwmon_device_register failed.\n");\r\nstatus = PTR_ERR(adc->hwmon_dev);\r\ngoto out_err;\r\n}\r\nmutex_unlock(&adc->lock);\r\nreturn 0;\r\nout_err:\r\nfor (i--; i >= 0; i--)\r\ndevice_remove_file(&spi->dev, &ad_input[i].dev_attr);\r\nspi_set_drvdata(spi, NULL);\r\nmutex_unlock(&adc->lock);\r\nkfree(adc);\r\nreturn status;\r\n}\r\nstatic int __devexit adcxx_remove(struct spi_device *spi)\r\n{\r\nstruct adcxx *adc = spi_get_drvdata(spi);\r\nint i;\r\nmutex_lock(&adc->lock);\r\nhwmon_device_unregister(adc->hwmon_dev);\r\nfor (i = 0; i < 3 + adc->channels; i++)\r\ndevice_remove_file(&spi->dev, &ad_input[i].dev_attr);\r\nspi_set_drvdata(spi, NULL);\r\nmutex_unlock(&adc->lock);\r\nkfree(adc);\r\nreturn 0;\r\n}

int cpufreq_frequency_table_cpuinfo(struct cpufreq_policy *policy,\r\nstruct cpufreq_frequency_table *table)\r\n{\r\nunsigned int min_freq = ~0;\r\nunsigned int max_freq = 0;\r\nunsigned int i;\r\nfor (i = 0; (table[i].frequency != CPUFREQ_TABLE_END); i++) {\r\nunsigned int freq = table[i].frequency;\r\nif (freq == CPUFREQ_ENTRY_INVALID) {\r\npr_debug("table entry %u is invalid, skipping\n", i);\r\ncontinue;\r\n}\r\npr_debug("table entry %u: %u kHz, %u index\n",\r\ni, freq, table[i].index);\r\nif (freq < min_freq)\r\nmin_freq = freq;\r\nif (freq > max_freq)\r\nmax_freq = freq;\r\n}\r\npolicy->min = policy->cpuinfo.min_freq = min_freq;\r\npolicy->max = policy->cpuinfo.max_freq = max_freq;\r\nif (policy->min == ~0)\r\nreturn -EINVAL;\r\nelse\r\nreturn 0;\r\n}\r\nint cpufreq_frequency_table_verify(struct cpufreq_policy *policy,\r\nstruct cpufreq_frequency_table *table)\r\n{\r\nunsigned int next_larger = ~0;\r\nunsigned int i;\r\nunsigned int count = 0;\r\npr_debug("request for verification of policy (%u - %u kHz) for cpu %u\n",\r\npolicy->min, policy->max, policy->cpu);\r\nif (!cpu_online(policy->cpu))\r\nreturn -EINVAL;\r\ncpufreq_verify_within_limits(policy, policy->cpuinfo.min_freq,\r\npolicy->cpuinfo.max_freq);\r\nfor (i = 0; (table[i].frequency != CPUFREQ_TABLE_END); i++) {\r\nunsigned int freq = table[i].frequency;\r\nif (freq == CPUFREQ_ENTRY_INVALID)\r\ncontinue;\r\nif ((freq >= policy->min) && (freq <= policy->max))\r\ncount++;\r\nelse if ((next_larger > freq) && (freq > policy->max))\r\nnext_larger = freq;\r\n}\r\nif (!count)\r\npolicy->max = next_larger;\r\ncpufreq_verify_within_limits(policy, policy->cpuinfo.min_freq,\r\npolicy->cpuinfo.max_freq);\r\npr_debug("verification lead to (%u - %u kHz) for cpu %u\n",\r\npolicy->min, policy->max, policy->cpu);\r\nreturn 0;\r\n}\r\nint cpufreq_frequency_table_target(struct cpufreq_policy *policy,\r\nstruct cpufreq_frequency_table *table,\r\nunsigned int target_freq,\r\nunsigned int relation,\r\nunsigned int *index)\r\n{\r\nstruct cpufreq_frequency_table optimal = {\r\n.index = ~0,\r\n.frequency = 0,\r\n};\r\nstruct cpufreq_frequency_table suboptimal = {\r\n.index = ~0,\r\n.frequency = 0,\r\n};\r\nunsigned int i;\r\npr_debug("request for target %u kHz (relation: %u) for cpu %u\n",\r\ntarget_freq, relation, policy->cpu);\r\nswitch (relation) {\r\ncase CPUFREQ_RELATION_H:\r\nsuboptimal.frequency = ~0;\r\nbreak;\r\ncase CPUFREQ_RELATION_L:\r\noptimal.frequency = ~0;\r\nbreak;\r\n}\r\nif (!cpu_online(policy->cpu))\r\nreturn -EINVAL;\r\nfor (i = 0; (table[i].frequency != CPUFREQ_TABLE_END); i++) {\r\nunsigned int freq = table[i].frequency;\r\nif (freq == CPUFREQ_ENTRY_INVALID)\r\ncontinue;\r\nif ((freq < policy->min) || (freq > policy->max))\r\ncontinue;\r\nswitch (relation) {\r\ncase CPUFREQ_RELATION_H:\r\nif (freq <= target_freq) {\r\nif (freq >= optimal.frequency) {\r\noptimal.frequency = freq;\r\noptimal.index = i;\r\n}\r\n} else {\r\nif (freq <= suboptimal.frequency) {\r\nsuboptimal.frequency = freq;\r\nsuboptimal.index = i;\r\n}\r\n}\r\nbreak;\r\ncase CPUFREQ_RELATION_L:\r\nif (freq >= target_freq) {\r\nif (freq <= optimal.frequency) {\r\noptimal.frequency = freq;\r\noptimal.index = i;\r\n}\r\n} else {\r\nif (freq >= suboptimal.frequency) {\r\nsuboptimal.frequency = freq;\r\nsuboptimal.index = i;\r\n}\r\n}\r\nbreak;\r\n}\r\n}\r\nif (optimal.index > i) {\r\nif (suboptimal.index > i)\r\nreturn -EINVAL;\r\n*index = suboptimal.index;\r\n} else\r\n*index = optimal.index;\r\npr_debug("target is %u (%u kHz, %u)\n", *index, table[*index].frequency,\r\ntable[*index].index);\r\nreturn 0;\r\n}\r\nstatic ssize_t show_available_freqs(struct cpufreq_policy *policy, char *buf)\r\n{\r\nunsigned int i = 0;\r\nunsigned int cpu = policy->cpu;\r\nssize_t count = 0;\r\nstruct cpufreq_frequency_table *table;\r\nif (!per_cpu(cpufreq_show_table, cpu))\r\nreturn -ENODEV;\r\ntable = per_cpu(cpufreq_show_table, cpu);\r\nfor (i = 0; (table[i].frequency != CPUFREQ_TABLE_END); i++) {\r\nif (table[i].frequency == CPUFREQ_ENTRY_INVALID)\r\ncontinue;\r\ncount += sprintf(&buf[count], "%d ", table[i].frequency);\r\n}\r\ncount += sprintf(&buf[count], "\n");\r\nreturn count;\r\n}\r\nvoid cpufreq_frequency_table_get_attr(struct cpufreq_frequency_table *table,\r\nunsigned int cpu)\r\n{\r\npr_debug("setting show_table for cpu %u to %p\n", cpu, table);\r\nper_cpu(cpufreq_show_table, cpu) = table;\r\n}\r\nvoid cpufreq_frequency_table_put_attr(unsigned int cpu)\r\n{\r\npr_debug("clearing show_table for cpu %u\n", cpu);\r\nper_cpu(cpufreq_show_table, cpu) = NULL;\r\n}\r\nstruct cpufreq_frequency_table *cpufreq_frequency_get_table(unsigned int cpu)\r\n{\r\nreturn per_cpu(cpufreq_show_table, cpu);\r\n}

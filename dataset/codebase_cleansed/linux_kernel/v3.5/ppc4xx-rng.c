static int ppc4xx_rng_data_present(struct hwrng *rng, int wait)\r\n{\r\nvoid __iomem *rng_regs = (void __iomem *) rng->priv;\r\nint busy, i, present = 0;\r\nfor (i = 0; i < 20; i++) {\r\nbusy = (in_le32(rng_regs + PPC4XX_TRNG_STAT) & PPC4XX_TRNG_STAT_B);\r\nif (!busy || !wait) {\r\npresent = 1;\r\nbreak;\r\n}\r\nudelay(10);\r\n}\r\nreturn present;\r\n}\r\nstatic int ppc4xx_rng_data_read(struct hwrng *rng, u32 *data)\r\n{\r\nvoid __iomem *rng_regs = (void __iomem *) rng->priv;\r\n*data = in_le32(rng_regs + PPC4XX_TRNG_DATA);\r\nreturn 4;\r\n}\r\nstatic int ppc4xx_rng_enable(int enable)\r\n{\r\nstruct device_node *ctrl;\r\nvoid __iomem *ctrl_reg;\r\nint err = 0;\r\nu32 val;\r\nctrl = of_find_compatible_node(NULL, NULL, "amcc,ppc4xx-crypto");\r\nif (!ctrl)\r\nreturn -ENODEV;\r\nctrl_reg = of_iomap(ctrl, 0);\r\nif (!ctrl_reg) {\r\nerr = -ENODEV;\r\ngoto out;\r\n}\r\nval = in_le32(ctrl_reg + PPC4XX_TRNG_DEV_CTRL);\r\nif (enable)\r\nval |= PPC4XX_TRNGE;\r\nelse\r\nval = val & ~PPC4XX_TRNGE;\r\nout_le32(ctrl_reg + PPC4XX_TRNG_DEV_CTRL, val);\r\niounmap(ctrl_reg);\r\nout:\r\nof_node_put(ctrl);\r\nreturn err;\r\n}\r\nstatic int __devinit ppc4xx_rng_probe(struct platform_device *dev)\r\n{\r\nvoid __iomem *rng_regs;\r\nint err = 0;\r\nrng_regs = of_iomap(dev->dev.of_node, 0);\r\nif (!rng_regs)\r\nreturn -ENODEV;\r\nerr = ppc4xx_rng_enable(1);\r\nif (err)\r\nreturn err;\r\nout_le32(rng_regs + PPC4XX_TRNG_CTRL, PPC4XX_TRNG_CTRL_DALM);\r\nppc4xx_rng.priv = (unsigned long) rng_regs;\r\nerr = hwrng_register(&ppc4xx_rng);\r\nreturn err;\r\n}\r\nstatic int __devexit ppc4xx_rng_remove(struct platform_device *dev)\r\n{\r\nvoid __iomem *rng_regs = (void __iomem *) ppc4xx_rng.priv;\r\nhwrng_unregister(&ppc4xx_rng);\r\nppc4xx_rng_enable(0);\r\niounmap(rng_regs);\r\nreturn 0;\r\n}

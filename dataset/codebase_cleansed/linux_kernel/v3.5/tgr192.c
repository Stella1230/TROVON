static void tgr192_round(u64 * ra, u64 * rb, u64 * rc, u64 x, int mul)\r\n{\r\nu64 a = *ra;\r\nu64 b = *rb;\r\nu64 c = *rc;\r\nc ^= x;\r\na -= sbox1[c & 0xff] ^ sbox2[(c >> 16) & 0xff]\r\n^ sbox3[(c >> 32) & 0xff] ^ sbox4[(c >> 48) & 0xff];\r\nb += sbox4[(c >> 8) & 0xff] ^ sbox3[(c >> 24) & 0xff]\r\n^ sbox2[(c >> 40) & 0xff] ^ sbox1[(c >> 56) & 0xff];\r\nb *= mul;\r\n*ra = a;\r\n*rb = b;\r\n*rc = c;\r\n}\r\nstatic void tgr192_pass(u64 * ra, u64 * rb, u64 * rc, u64 * x, int mul)\r\n{\r\nu64 a = *ra;\r\nu64 b = *rb;\r\nu64 c = *rc;\r\ntgr192_round(&a, &b, &c, x[0], mul);\r\ntgr192_round(&b, &c, &a, x[1], mul);\r\ntgr192_round(&c, &a, &b, x[2], mul);\r\ntgr192_round(&a, &b, &c, x[3], mul);\r\ntgr192_round(&b, &c, &a, x[4], mul);\r\ntgr192_round(&c, &a, &b, x[5], mul);\r\ntgr192_round(&a, &b, &c, x[6], mul);\r\ntgr192_round(&b, &c, &a, x[7], mul);\r\n*ra = a;\r\n*rb = b;\r\n*rc = c;\r\n}\r\nstatic void tgr192_key_schedule(u64 * x)\r\n{\r\nx[0] -= x[7] ^ 0xa5a5a5a5a5a5a5a5ULL;\r\nx[1] ^= x[0];\r\nx[2] += x[1];\r\nx[3] -= x[2] ^ ((~x[1]) << 19);\r\nx[4] ^= x[3];\r\nx[5] += x[4];\r\nx[6] -= x[5] ^ ((~x[4]) >> 23);\r\nx[7] ^= x[6];\r\nx[0] += x[7];\r\nx[1] -= x[0] ^ ((~x[7]) << 19);\r\nx[2] ^= x[1];\r\nx[3] += x[2];\r\nx[4] -= x[3] ^ ((~x[2]) >> 23);\r\nx[5] ^= x[4];\r\nx[6] += x[5];\r\nx[7] -= x[6] ^ 0x0123456789abcdefULL;\r\n}\r\nstatic void tgr192_transform(struct tgr192_ctx *tctx, const u8 * data)\r\n{\r\nu64 a, b, c, aa, bb, cc;\r\nu64 x[8];\r\nint i;\r\nconst __le64 *ptr = (const __le64 *)data;\r\nfor (i = 0; i < 8; i++)\r\nx[i] = le64_to_cpu(ptr[i]);\r\na = aa = tctx->a;\r\nb = bb = tctx->b;\r\nc = cc = tctx->c;\r\ntgr192_pass(&a, &b, &c, x, 5);\r\ntgr192_key_schedule(x);\r\ntgr192_pass(&c, &a, &b, x, 7);\r\ntgr192_key_schedule(x);\r\ntgr192_pass(&b, &c, &a, x, 9);\r\na ^= aa;\r\nb -= bb;\r\nc += cc;\r\ntctx->a = a;\r\ntctx->b = b;\r\ntctx->c = c;\r\n}\r\nstatic int tgr192_init(struct shash_desc *desc)\r\n{\r\nstruct tgr192_ctx *tctx = shash_desc_ctx(desc);\r\ntctx->a = 0x0123456789abcdefULL;\r\ntctx->b = 0xfedcba9876543210ULL;\r\ntctx->c = 0xf096a5b4c3b2e187ULL;\r\ntctx->nblocks = 0;\r\ntctx->count = 0;\r\nreturn 0;\r\n}\r\nstatic int tgr192_update(struct shash_desc *desc, const u8 *inbuf,\r\nunsigned int len)\r\n{\r\nstruct tgr192_ctx *tctx = shash_desc_ctx(desc);\r\nif (tctx->count == 64) {\r\ntgr192_transform(tctx, tctx->hash);\r\ntctx->count = 0;\r\ntctx->nblocks++;\r\n}\r\nif (!inbuf) {\r\nreturn 0;\r\n}\r\nif (tctx->count) {\r\nfor (; len && tctx->count < 64; len--) {\r\ntctx->hash[tctx->count++] = *inbuf++;\r\n}\r\ntgr192_update(desc, NULL, 0);\r\nif (!len) {\r\nreturn 0;\r\n}\r\n}\r\nwhile (len >= 64) {\r\ntgr192_transform(tctx, inbuf);\r\ntctx->count = 0;\r\ntctx->nblocks++;\r\nlen -= 64;\r\ninbuf += 64;\r\n}\r\nfor (; len && tctx->count < 64; len--) {\r\ntctx->hash[tctx->count++] = *inbuf++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tgr192_final(struct shash_desc *desc, u8 * out)\r\n{\r\nstruct tgr192_ctx *tctx = shash_desc_ctx(desc);\r\n__be64 *dst = (__be64 *)out;\r\n__be64 *be64p;\r\n__le32 *le32p;\r\nu32 t, msb, lsb;\r\ntgr192_update(desc, NULL, 0); ;\r\nmsb = 0;\r\nt = tctx->nblocks;\r\nif ((lsb = t << 6) < t) {\r\nmsb++;\r\n}\r\nmsb += t >> 26;\r\nt = lsb;\r\nif ((lsb = t + tctx->count) < t) {\r\nmsb++;\r\n}\r\nt = lsb;\r\nif ((lsb = t << 3) < t) {\r\nmsb++;\r\n}\r\nmsb += t >> 29;\r\nif (tctx->count < 56) {\r\ntctx->hash[tctx->count++] = 0x01;\r\nwhile (tctx->count < 56) {\r\ntctx->hash[tctx->count++] = 0;\r\n}\r\n} else {\r\ntctx->hash[tctx->count++] = 0x01;\r\nwhile (tctx->count < 64) {\r\ntctx->hash[tctx->count++] = 0;\r\n}\r\ntgr192_update(desc, NULL, 0); ;\r\nmemset(tctx->hash, 0, 56);\r\n}\r\nle32p = (__le32 *)&tctx->hash[56];\r\nle32p[0] = cpu_to_le32(lsb);\r\nle32p[1] = cpu_to_le32(msb);\r\ntgr192_transform(tctx, tctx->hash);\r\nbe64p = (__be64 *)tctx->hash;\r\ndst[0] = be64p[0] = cpu_to_be64(tctx->a);\r\ndst[1] = be64p[1] = cpu_to_be64(tctx->b);\r\ndst[2] = be64p[2] = cpu_to_be64(tctx->c);\r\nreturn 0;\r\n}\r\nstatic int tgr160_final(struct shash_desc *desc, u8 * out)\r\n{\r\nu8 D[64];\r\ntgr192_final(desc, D);\r\nmemcpy(out, D, TGR160_DIGEST_SIZE);\r\nmemset(D, 0, TGR192_DIGEST_SIZE);\r\nreturn 0;\r\n}\r\nstatic int tgr128_final(struct shash_desc *desc, u8 * out)\r\n{\r\nu8 D[64];\r\ntgr192_final(desc, D);\r\nmemcpy(out, D, TGR128_DIGEST_SIZE);\r\nmemset(D, 0, TGR192_DIGEST_SIZE);\r\nreturn 0;\r\n}\r\nstatic int __init tgr192_mod_init(void)\r\n{\r\nint ret = 0;\r\nret = crypto_register_shash(&tgr192);\r\nif (ret < 0) {\r\ngoto out;\r\n}\r\nret = crypto_register_shash(&tgr160);\r\nif (ret < 0) {\r\ncrypto_unregister_shash(&tgr192);\r\ngoto out;\r\n}\r\nret = crypto_register_shash(&tgr128);\r\nif (ret < 0) {\r\ncrypto_unregister_shash(&tgr192);\r\ncrypto_unregister_shash(&tgr160);\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nstatic void __exit tgr192_mod_fini(void)\r\n{\r\ncrypto_unregister_shash(&tgr192);\r\ncrypto_unregister_shash(&tgr160);\r\ncrypto_unregister_shash(&tgr128);\r\n}

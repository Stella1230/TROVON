static irqreturn_t pm860x_onkey_handler(int irq, void *data)\r\n{\r\nstruct pm860x_onkey_info *info = data;\r\nint ret;\r\nret = pm860x_reg_read(info->i2c, PM8607_STATUS_2);\r\nret &= ONKEY_STATUS;\r\ninput_report_key(info->idev, KEY_POWER, ret);\r\ninput_sync(info->idev);\r\npm860x_set_bits(info->i2c, PM8607_WAKEUP, 3, LONG_ONKEY_EN);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __devinit pm860x_onkey_probe(struct platform_device *pdev)\r\n{\r\nstruct pm860x_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct pm860x_onkey_info *info;\r\nint irq, ret;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "No IRQ resource!\n");\r\nreturn -EINVAL;\r\n}\r\ninfo = kzalloc(sizeof(struct pm860x_onkey_info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->chip = chip;\r\ninfo->i2c = (chip->id == CHIP_PM8607) ? chip->client : chip->companion;\r\ninfo->dev = &pdev->dev;\r\ninfo->irq = irq;\r\ninfo->idev = input_allocate_device();\r\nif (!info->idev) {\r\ndev_err(chip->dev, "Failed to allocate input dev\n");\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\ninfo->idev->name = "88pm860x_on";\r\ninfo->idev->phys = "88pm860x_on/input0";\r\ninfo->idev->id.bustype = BUS_I2C;\r\ninfo->idev->dev.parent = &pdev->dev;\r\ninfo->idev->evbit[0] = BIT_MASK(EV_KEY);\r\ninfo->idev->keybit[BIT_WORD(KEY_POWER)] = BIT_MASK(KEY_POWER);\r\nret = input_register_device(info->idev);\r\nif (ret) {\r\ndev_err(chip->dev, "Can't register input device: %d\n", ret);\r\ngoto out_reg;\r\n}\r\nret = request_threaded_irq(info->irq, NULL, pm860x_onkey_handler,\r\nIRQF_ONESHOT, "onkey", info);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "Failed to request IRQ: #%d: %d\n",\r\ninfo->irq, ret);\r\ngoto out_irq;\r\n}\r\nplatform_set_drvdata(pdev, info);\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nreturn 0;\r\nout_irq:\r\ninput_unregister_device(info->idev);\r\nkfree(info);\r\nreturn ret;\r\nout_reg:\r\ninput_free_device(info->idev);\r\nout:\r\nkfree(info);\r\nreturn ret;\r\n}\r\nstatic int __devexit pm860x_onkey_remove(struct platform_device *pdev)\r\n{\r\nstruct pm860x_onkey_info *info = platform_get_drvdata(pdev);\r\nfree_irq(info->irq, info);\r\ninput_unregister_device(info->idev);\r\nkfree(info);\r\nreturn 0;\r\n}\r\nstatic int pm860x_onkey_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct pm860x_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nif (device_may_wakeup(dev))\r\nchip->wakeup_flag |= 1 << PM8607_IRQ_ONKEY;\r\nreturn 0;\r\n}\r\nstatic int pm860x_onkey_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct pm860x_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nif (device_may_wakeup(dev))\r\nchip->wakeup_flag &= ~(1 << PM8607_IRQ_ONKEY);\r\nreturn 0;\r\n}

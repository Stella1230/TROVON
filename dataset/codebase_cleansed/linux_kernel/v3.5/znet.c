static int znet_request_resources (struct net_device *dev)\r\n{\r\nstruct znet_private *znet = netdev_priv(dev);\r\nif (request_irq (dev->irq, znet_interrupt, 0, "ZNet", dev))\r\ngoto failed;\r\nif (request_dma (znet->rx_dma, "ZNet rx"))\r\ngoto free_irq;\r\nif (request_dma (znet->tx_dma, "ZNet tx"))\r\ngoto free_rx_dma;\r\nif (!request_region (znet->sia_base, znet->sia_size, "ZNet SIA"))\r\ngoto free_tx_dma;\r\nif (!request_region (dev->base_addr, znet->io_size, "ZNet I/O"))\r\ngoto free_sia;\r\nreturn 0;\r\nfree_sia:\r\nrelease_region (znet->sia_base, znet->sia_size);\r\nfree_tx_dma:\r\nfree_dma (znet->tx_dma);\r\nfree_rx_dma:\r\nfree_dma (znet->rx_dma);\r\nfree_irq:\r\nfree_irq (dev->irq, dev);\r\nfailed:\r\nreturn -1;\r\n}\r\nstatic void znet_release_resources (struct net_device *dev)\r\n{\r\nstruct znet_private *znet = netdev_priv(dev);\r\nrelease_region (znet->sia_base, znet->sia_size);\r\nrelease_region (dev->base_addr, znet->io_size);\r\nfree_dma (znet->tx_dma);\r\nfree_dma (znet->rx_dma);\r\nfree_irq (dev->irq, dev);\r\n}\r\nstatic void znet_transceiver_power (struct net_device *dev, int on)\r\n{\r\nstruct znet_private *znet = netdev_priv(dev);\r\nunsigned char v;\r\noutb(0x10, znet->sia_base);\r\nif (on)\r\nv = inb(znet->sia_base + 1) | 0x84;\r\nelse\r\nv = inb(znet->sia_base + 1) & ~0x84;\r\noutb(v, znet->sia_base+1);\r\n}\r\nstatic void znet_set_multicast_list (struct net_device *dev)\r\n{\r\nstruct znet_private *znet = netdev_priv(dev);\r\nshort ioaddr = dev->base_addr;\r\nstruct i82593_conf_block *cfblk = &znet->i593_init;\r\nmemset(cfblk, 0x00, sizeof(struct i82593_conf_block));\r\ncfblk->fifo_limit = 10;\r\ncfblk->forgnesi = 0;\r\ncfblk->fifo_32 = 1;\r\ncfblk->d6mod = 0;\r\ncfblk->throttle_enb = 1;\r\ncfblk->throttle = 8;\r\ncfblk->cntrxint = 0;\r\ncfblk->contin = 1;\r\ncfblk->addr_len = ETH_ALEN;\r\ncfblk->acloc = 1;\r\ncfblk->preamb_len = 2;\r\ncfblk->loopback = 0;\r\ncfblk->lin_prio = 0;\r\ncfblk->tbofstop = 0;\r\ncfblk->exp_prio = 0;\r\ncfblk->bof_met = 0;\r\ncfblk->ifrm_spc = 6;\r\ncfblk->slottim_low = 0;\r\ncfblk->slottim_hi = 2;\r\ncfblk->max_retr = 15;\r\ncfblk->prmisc = ((dev->flags & IFF_PROMISC) ? 1 : 0);\r\ncfblk->bc_dis = 0;\r\ncfblk->crs_1 = 0;\r\ncfblk->nocrc_ins = 0;\r\ncfblk->crc_1632 = 0;\r\ncfblk->crs_cdt = 0;\r\ncfblk->cs_filter = 0;\r\ncfblk->crs_src = 0;\r\ncfblk->cd_filter = 0;\r\ncfblk->min_fr_len = ETH_ZLEN >> 2;\r\ncfblk->lng_typ = 1;\r\ncfblk->lng_fld = 1;\r\ncfblk->rxcrc_xf = 1;\r\ncfblk->artx = 1;\r\ncfblk->sarec = 1;\r\ncfblk->tx_jabber = 0;\r\ncfblk->hash_1 = 1;\r\ncfblk->lbpkpol = 0;\r\ncfblk->fdx = 0;\r\ncfblk->dummy_6 = 0x3f;\r\ncfblk->mult_ia = 0;\r\ncfblk->dis_bof = 0;\r\ncfblk->dummy_1 = 1;\r\ncfblk->tx_ifs_retrig = 3;\r\ncfblk->mc_all = (!netdev_mc_empty(dev) ||\r\n(dev->flags & IFF_ALLMULTI));\r\ncfblk->rcv_mon = 0;\r\ncfblk->frag_acpt = 0;\r\ncfblk->tstrttrs = 0;\r\ncfblk->fretx = 1;\r\ncfblk->runt_eop = 0;\r\ncfblk->hw_sw_pin = 0;\r\ncfblk->big_endn = 0;\r\ncfblk->syncrqs = 1;\r\ncfblk->sttlen = 1;\r\ncfblk->rx_eop = 0;\r\ncfblk->tx_eop = 0;\r\ncfblk->rbuf_size = RX_BUF_SIZE >> 12;\r\ncfblk->rcvstop = 1;\r\nif (znet_debug > 2) {\r\nint i;\r\nunsigned char *c;\r\nfor (i = 0, c = (char *) cfblk; i < sizeof (*cfblk); i++)\r\nprintk ("%02X ", c[i]);\r\nprintk ("\n");\r\n}\r\n*znet->tx_cur++ = sizeof(struct i82593_conf_block);\r\nmemcpy(znet->tx_cur, cfblk, sizeof(struct i82593_conf_block));\r\nznet->tx_cur += sizeof(struct i82593_conf_block)/2;\r\noutb(OP0_CONFIGURE | CR0_CHNL, ioaddr);\r\n}\r\nstatic int __init znet_probe (void)\r\n{\r\nint i;\r\nstruct netidblk *netinfo;\r\nstruct znet_private *znet;\r\nstruct net_device *dev;\r\nchar *p;\r\nint err = -ENOMEM;\r\nfor(p = (char *)phys_to_virt(0xf0000); p < (char *)phys_to_virt(0x100000); p++)\r\nif (*p == 'N' && strncmp(p, "NETIDBLK", 8) == 0)\r\nbreak;\r\nif (p >= (char *)phys_to_virt(0x100000)) {\r\nif (znet_debug > 1)\r\nprintk(KERN_INFO "No Z-Note ethernet adaptor found.\n");\r\nreturn -ENODEV;\r\n}\r\ndev = alloc_etherdev(sizeof(struct znet_private));\r\nif (!dev)\r\nreturn -ENOMEM;\r\nznet = netdev_priv(dev);\r\nnetinfo = (struct netidblk *)p;\r\ndev->base_addr = netinfo->iobase1;\r\ndev->irq = netinfo->irq1;\r\nfor (i = 0; i < 6; i++)\r\ndev->dev_addr[i] = netinfo->netid[i];\r\nprintk(KERN_INFO "%s: ZNET at %#3lx, %pM"\r\n", using IRQ %d DMA %d and %d.\n",\r\ndev->name, dev->base_addr, dev->dev_addr,\r\ndev->irq, netinfo->dma1, netinfo->dma2);\r\nif (znet_debug > 1) {\r\nprintk(KERN_INFO "%s: vendor '%16.16s' IRQ1 %d IRQ2 %d DMA1 %d DMA2 %d.\n",\r\ndev->name, netinfo->vendor,\r\nnetinfo->irq1, netinfo->irq2,\r\nnetinfo->dma1, netinfo->dma2);\r\nprintk(KERN_INFO "%s: iobase1 %#x size %d iobase2 %#x size %d net type %2.2x.\n",\r\ndev->name, netinfo->iobase1, netinfo->iosize1,\r\nnetinfo->iobase2, netinfo->iosize2, netinfo->nettype);\r\n}\r\nif (znet_debug > 0)\r\nprintk(KERN_INFO "%s", version);\r\nznet->rx_dma = netinfo->dma1;\r\nznet->tx_dma = netinfo->dma2;\r\nspin_lock_init(&znet->lock);\r\nznet->sia_base = 0xe6;\r\nznet->sia_size = 2;\r\nznet->io_size = 2;\r\nif (!(znet->rx_start = kmalloc (DMA_BUF_SIZE, GFP_KERNEL | GFP_DMA)))\r\ngoto free_dev;\r\nif (!(znet->tx_start = kmalloc (DMA_BUF_SIZE, GFP_KERNEL | GFP_DMA)))\r\ngoto free_rx;\r\nif (!dma_page_eq (znet->rx_start, znet->rx_start + (RX_BUF_SIZE/2-1)) ||\r\n!dma_page_eq (znet->tx_start, znet->tx_start + (TX_BUF_SIZE/2-1))) {\r\nprintk (KERN_WARNING "tx/rx crossing DMA frontiers, giving up\n");\r\ngoto free_tx;\r\n}\r\nznet->rx_end = znet->rx_start + RX_BUF_SIZE/2;\r\nznet->tx_buf_len = TX_BUF_SIZE/2;\r\nznet->tx_end = znet->tx_start + znet->tx_buf_len;\r\ndev->netdev_ops = &znet_netdev_ops;\r\ndev->watchdog_timeo = TX_TIMEOUT;\r\nerr = register_netdev(dev);\r\nif (err)\r\ngoto free_tx;\r\nznet_dev = dev;\r\nreturn 0;\r\nfree_tx:\r\nkfree(znet->tx_start);\r\nfree_rx:\r\nkfree(znet->rx_start);\r\nfree_dev:\r\nfree_netdev(dev);\r\nreturn err;\r\n}\r\nstatic int znet_open(struct net_device *dev)\r\n{\r\nint ioaddr = dev->base_addr;\r\nif (znet_debug > 2)\r\nprintk(KERN_DEBUG "%s: znet_open() called.\n", dev->name);\r\nif (znet_request_resources (dev)) {\r\nprintk(KERN_WARNING "%s: Not opened -- resource busy?!?\n", dev->name);\r\nreturn -EBUSY;\r\n}\r\nznet_transceiver_power (dev, 1);\r\nmdelay (50);\r\nif (inb(ioaddr) != 0x10 && inb(ioaddr) != 0x00)\r\nprintk(KERN_WARNING "%s: Problem turning on the transceiver power.\n",\r\ndev->name);\r\nhardware_init(dev);\r\nnetif_start_queue (dev);\r\nreturn 0;\r\n}\r\nstatic void znet_tx_timeout (struct net_device *dev)\r\n{\r\nint ioaddr = dev->base_addr;\r\nushort event, tx_status, rx_offset, state;\r\noutb (CR0_STATUS_0, ioaddr);\r\nevent = inb (ioaddr);\r\noutb (CR0_STATUS_1, ioaddr);\r\ntx_status = inw (ioaddr);\r\noutb (CR0_STATUS_2, ioaddr);\r\nrx_offset = inw (ioaddr);\r\noutb (CR0_STATUS_3, ioaddr);\r\nstate = inb (ioaddr);\r\nprintk (KERN_WARNING "%s: transmit timed out, status %02x %04x %04x %02x,"\r\n" resetting.\n", dev->name, event, tx_status, rx_offset, state);\r\nif (tx_status == TX_LOST_CRS)\r\nprintk (KERN_WARNING "%s: Tx carrier error, check transceiver cable.\n",\r\ndev->name);\r\noutb (OP0_RESET, ioaddr);\r\nhardware_init (dev);\r\nnetif_wake_queue (dev);\r\n}\r\nstatic netdev_tx_t znet_send_packet(struct sk_buff *skb, struct net_device *dev)\r\n{\r\nint ioaddr = dev->base_addr;\r\nstruct znet_private *znet = netdev_priv(dev);\r\nunsigned long flags;\r\nshort length = skb->len;\r\nif (znet_debug > 4)\r\nprintk(KERN_DEBUG "%s: ZNet_send_packet.\n", dev->name);\r\nif (length < ETH_ZLEN) {\r\nif (skb_padto(skb, ETH_ZLEN))\r\nreturn NETDEV_TX_OK;\r\nlength = ETH_ZLEN;\r\n}\r\nnetif_stop_queue (dev);\r\noutb(CR0_STATUS_0, ioaddr);\r\nif (inw(ioaddr) == 0x0010 &&\r\ninw(ioaddr) == 0x0000 &&\r\ninw(ioaddr) == 0x0010) {\r\nif (znet_debug > 1)\r\nprintk (KERN_WARNING "%s : waking up\n", dev->name);\r\nhardware_init(dev);\r\nznet_transceiver_power (dev, 1);\r\n}\r\nif (1) {\r\nunsigned char *buf = (void *)skb->data;\r\nushort *tx_link = znet->tx_cur - 1;\r\nushort rnd_len = (length + 1)>>1;\r\ndev->stats.tx_bytes+=length;\r\nif (znet->tx_cur >= znet->tx_end)\r\nznet->tx_cur = znet->tx_start;\r\n*znet->tx_cur++ = length;\r\nif (znet->tx_cur + rnd_len + 1 > znet->tx_end) {\r\nint semi_cnt = (znet->tx_end - znet->tx_cur)<<1;\r\nmemcpy(znet->tx_cur, buf, semi_cnt);\r\nrnd_len -= semi_cnt>>1;\r\nmemcpy(znet->tx_start, buf + semi_cnt, length - semi_cnt);\r\nznet->tx_cur = znet->tx_start + rnd_len;\r\n} else {\r\nmemcpy(znet->tx_cur, buf, skb->len);\r\nznet->tx_cur += rnd_len;\r\n}\r\n*znet->tx_cur++ = 0;\r\nspin_lock_irqsave(&znet->lock, flags);\r\n{\r\n*tx_link = OP0_TRANSMIT | CR0_CHNL;\r\noutb(OP0_TRANSMIT | CR0_CHNL, ioaddr);\r\n}\r\nspin_unlock_irqrestore (&znet->lock, flags);\r\nnetif_start_queue (dev);\r\nif (znet_debug > 4)\r\nprintk(KERN_DEBUG "%s: Transmitter queued, length %d.\n", dev->name, length);\r\n}\r\ndev_kfree_skb(skb);\r\nreturn NETDEV_TX_OK;\r\n}\r\nstatic irqreturn_t znet_interrupt(int irq, void *dev_id)\r\n{\r\nstruct net_device *dev = dev_id;\r\nstruct znet_private *znet = netdev_priv(dev);\r\nint ioaddr;\r\nint boguscnt = 20;\r\nint handled = 0;\r\nspin_lock (&znet->lock);\r\nioaddr = dev->base_addr;\r\noutb(CR0_STATUS_0, ioaddr);\r\ndo {\r\nushort status = inb(ioaddr);\r\nif (znet_debug > 5) {\r\nushort result, rx_ptr, running;\r\noutb(CR0_STATUS_1, ioaddr);\r\nresult = inw(ioaddr);\r\noutb(CR0_STATUS_2, ioaddr);\r\nrx_ptr = inw(ioaddr);\r\noutb(CR0_STATUS_3, ioaddr);\r\nrunning = inb(ioaddr);\r\nprintk(KERN_DEBUG "%s: interrupt, status %02x, %04x %04x %02x serial %d.\n",\r\ndev->name, status, result, rx_ptr, running, boguscnt);\r\n}\r\nif ((status & SR0_INTERRUPT) == 0)\r\nbreak;\r\nhandled = 1;\r\nif ((status & SR0_EVENT_MASK) == SR0_TRANSMIT_DONE ||\r\n(status & SR0_EVENT_MASK) == SR0_RETRANSMIT_DONE ||\r\n(status & SR0_EVENT_MASK) == SR0_TRANSMIT_NO_CRC_DONE) {\r\nint tx_status;\r\noutb(CR0_STATUS_1, ioaddr);\r\ntx_status = inw(ioaddr);\r\nif (tx_status & TX_OK) {\r\ndev->stats.tx_packets++;\r\ndev->stats.collisions += tx_status & TX_NCOL_MASK;\r\n} else {\r\nif (tx_status & (TX_LOST_CTS | TX_LOST_CRS))\r\ndev->stats.tx_carrier_errors++;\r\nif (tx_status & TX_UND_RUN)\r\ndev->stats.tx_fifo_errors++;\r\nif (!(tx_status & TX_HRT_BEAT))\r\ndev->stats.tx_heartbeat_errors++;\r\nif (tx_status & TX_MAX_COL)\r\ndev->stats.tx_aborted_errors++;\r\nif ((tx_status | (TX_LOST_CRS | TX_LOST_CTS | TX_UND_RUN | TX_HRT_BEAT | TX_MAX_COL)) != (TX_LOST_CRS | TX_LOST_CTS | TX_UND_RUN | TX_HRT_BEAT | TX_MAX_COL))\r\ndev->stats.tx_errors++;\r\nznet_transceiver_power (dev, 0);\r\nznet_transceiver_power (dev, 1);\r\n}\r\nnetif_wake_queue (dev);\r\n}\r\nif ((status & SR0_RECEPTION) ||\r\n(status & SR0_EVENT_MASK) == SR0_STOP_REG_HIT) {\r\nznet_rx(dev);\r\n}\r\noutb(CR0_INT_ACK, ioaddr);\r\n} while (boguscnt--);\r\nspin_unlock (&znet->lock);\r\nreturn IRQ_RETVAL(handled);\r\n}\r\nstatic void znet_rx(struct net_device *dev)\r\n{\r\nstruct znet_private *znet = netdev_priv(dev);\r\nint ioaddr = dev->base_addr;\r\nint boguscount = 1;\r\nshort next_frame_end_offset = 0;\r\nshort *cur_frame_end;\r\nshort cur_frame_end_offset;\r\noutb(CR0_STATUS_2, ioaddr);\r\ncur_frame_end_offset = inw(ioaddr);\r\nif (cur_frame_end_offset == znet->rx_cur - znet->rx_start) {\r\nprintk(KERN_WARNING "%s: Interrupted, but nothing to receive, offset %03x.\n",\r\ndev->name, cur_frame_end_offset);\r\nreturn;\r\n}\r\nwhile (znet->rx_start + cur_frame_end_offset != znet->rx_cur &&\r\n++boguscount < 5) {\r\nunsigned short hi_cnt, lo_cnt, hi_status, lo_status;\r\nint count, status;\r\nif (cur_frame_end_offset < 4) {\r\nmemcpy(znet->rx_end, znet->rx_start, 8);\r\ncur_frame_end_offset += (RX_BUF_SIZE/2);\r\n}\r\ncur_frame_end = znet->rx_start + cur_frame_end_offset - 4;\r\nlo_status = *cur_frame_end++;\r\nhi_status = *cur_frame_end++;\r\nstatus = ((hi_status & 0xff) << 8) + (lo_status & 0xff);\r\nlo_cnt = *cur_frame_end++;\r\nhi_cnt = *cur_frame_end++;\r\ncount = ((hi_cnt & 0xff) << 8) + (lo_cnt & 0xff);\r\nif (znet_debug > 5)\r\nprintk(KERN_DEBUG "Constructing trailer at location %03x, %04x %04x %04x %04x"\r\n" count %#x status %04x.\n",\r\ncur_frame_end_offset<<1, lo_status, hi_status, lo_cnt, hi_cnt,\r\ncount, status);\r\ncur_frame_end[-4] = status;\r\ncur_frame_end[-3] = next_frame_end_offset;\r\ncur_frame_end[-2] = count;\r\nnext_frame_end_offset = cur_frame_end_offset;\r\ncur_frame_end_offset -= ((count + 1)>>1) + 3;\r\nif (cur_frame_end_offset < 0)\r\ncur_frame_end_offset += RX_BUF_SIZE/2;\r\n}\r\ndo {\r\nushort *this_rfp_ptr = znet->rx_start + next_frame_end_offset;\r\nint status = this_rfp_ptr[-4];\r\nint pkt_len = this_rfp_ptr[-2];\r\nif (znet_debug > 5)\r\nprintk(KERN_DEBUG "Looking at trailer ending at %04x status %04x length %03x"\r\n" next %04x.\n", next_frame_end_offset<<1, status, pkt_len,\r\nthis_rfp_ptr[-3]<<1);\r\nif ( ! (status & RX_RCV_OK)) {\r\ndev->stats.rx_errors++;\r\nif (status & RX_CRC_ERR) dev->stats.rx_crc_errors++;\r\nif (status & RX_ALG_ERR) dev->stats.rx_frame_errors++;\r\n#if 0\r\nif (status & 0x0200) dev->stats.rx_over_errors++;\r\nif (status & 0x0100) dev->stats.rx_fifo_errors++;\r\n#else\r\nif (status & RX_OVRRUN) dev->stats.rx_over_errors++;\r\n#endif\r\nif (status & RX_SRT_FRM) dev->stats.rx_length_errors++;\r\n} else if (pkt_len > 1536) {\r\ndev->stats.rx_length_errors++;\r\n} else {\r\nstruct sk_buff *skb;\r\nskb = netdev_alloc_skb(dev, pkt_len);\r\nif (skb == NULL) {\r\nif (znet_debug)\r\nprintk(KERN_WARNING "%s: Memory squeeze, dropping packet.\n", dev->name);\r\ndev->stats.rx_dropped++;\r\nbreak;\r\n}\r\nif (&znet->rx_cur[(pkt_len+1)>>1] > znet->rx_end) {\r\nint semi_cnt = (znet->rx_end - znet->rx_cur)<<1;\r\nmemcpy(skb_put(skb,semi_cnt), znet->rx_cur, semi_cnt);\r\nmemcpy(skb_put(skb,pkt_len-semi_cnt), znet->rx_start,\r\npkt_len - semi_cnt);\r\n} else {\r\nmemcpy(skb_put(skb,pkt_len), znet->rx_cur, pkt_len);\r\nif (znet_debug > 6) {\r\nunsigned int *packet = (unsigned int *) skb->data;\r\nprintk(KERN_DEBUG "Packet data is %08x %08x %08x %08x.\n", packet[0],\r\npacket[1], packet[2], packet[3]);\r\n}\r\n}\r\nskb->protocol=eth_type_trans(skb,dev);\r\nnetif_rx(skb);\r\ndev->stats.rx_packets++;\r\ndev->stats.rx_bytes += pkt_len;\r\n}\r\nznet->rx_cur = this_rfp_ptr;\r\nif (znet->rx_cur >= znet->rx_end)\r\nznet->rx_cur -= RX_BUF_SIZE/2;\r\nupdate_stop_hit(ioaddr, (znet->rx_cur - znet->rx_start)<<1);\r\nnext_frame_end_offset = this_rfp_ptr[-3];\r\nif (next_frame_end_offset == 0)\r\nbreak;\r\nthis_rfp_ptr = znet->rx_start + next_frame_end_offset;\r\n} while (--boguscount);\r\n}\r\nstatic int znet_close(struct net_device *dev)\r\n{\r\nint ioaddr = dev->base_addr;\r\nnetif_stop_queue (dev);\r\noutb(OP0_RESET, ioaddr);\r\nif (znet_debug > 1)\r\nprintk(KERN_DEBUG "%s: Shutting down ethercard.\n", dev->name);\r\nznet_transceiver_power (dev, 0);\r\nznet_release_resources (dev);\r\nreturn 0;\r\n}\r\nstatic void show_dma(struct net_device *dev)\r\n{\r\nshort ioaddr = dev->base_addr;\r\nunsigned char stat = inb (ioaddr);\r\nstruct znet_private *znet = netdev_priv(dev);\r\nunsigned long flags;\r\nshort dma_port = ((znet->tx_dma&3)<<2) + IO_DMA2_BASE;\r\nunsigned addr = inb(dma_port);\r\nshort residue;\r\naddr |= inb(dma_port) << 8;\r\nresidue = get_dma_residue(znet->tx_dma);\r\nif (znet_debug > 1) {\r\nflags=claim_dma_lock();\r\nprintk(KERN_DEBUG "Stat:%02x Addr: %04x cnt:%3x\n",\r\nstat, addr<<1, residue);\r\nrelease_dma_lock(flags);\r\n}\r\n}\r\nstatic void hardware_init(struct net_device *dev)\r\n{\r\nunsigned long flags;\r\nshort ioaddr = dev->base_addr;\r\nstruct znet_private *znet = netdev_priv(dev);\r\nznet->rx_cur = znet->rx_start;\r\nznet->tx_cur = znet->tx_start;\r\noutb(OP0_RESET, ioaddr);\r\nflags=claim_dma_lock();\r\ndisable_dma(znet->rx_dma);\r\nclear_dma_ff(znet->rx_dma);\r\nset_dma_mode(znet->rx_dma, DMA_RX_MODE);\r\nset_dma_addr(znet->rx_dma, (unsigned int) znet->rx_start);\r\nset_dma_count(znet->rx_dma, RX_BUF_SIZE);\r\nenable_dma(znet->rx_dma);\r\ndisable_dma(znet->tx_dma);\r\nclear_dma_ff(znet->tx_dma);\r\nset_dma_mode(znet->tx_dma, DMA_TX_MODE);\r\nset_dma_addr(znet->tx_dma, (unsigned int) znet->tx_start);\r\nset_dma_count(znet->tx_dma, znet->tx_buf_len<<1);\r\nenable_dma(znet->tx_dma);\r\nrelease_dma_lock(flags);\r\nif (znet_debug > 1)\r\nprintk(KERN_DEBUG "%s: Initializing the i82593, rx buf %p tx buf %p\n",\r\ndev->name, znet->rx_start,znet->tx_start);\r\n*znet->tx_cur++ = 0;\r\n*znet->tx_cur++ = 0;\r\nshow_dma(dev);\r\noutb(OP0_CONFIGURE | CR0_CHNL, ioaddr);\r\nznet_set_multicast_list (dev);\r\n*znet->tx_cur++ = 6;\r\nmemcpy(znet->tx_cur, dev->dev_addr, 6);\r\nznet->tx_cur += 3;\r\nshow_dma(dev);\r\noutb(OP0_IA_SETUP | CR0_CHNL, ioaddr);\r\nshow_dma(dev);\r\nupdate_stop_hit(ioaddr, 8192);\r\nif (znet_debug > 1) printk(KERN_DEBUG "enabling Rx.\n");\r\noutb(OP0_RCV_ENABLE, ioaddr);\r\nnetif_start_queue (dev);\r\n}\r\nstatic void update_stop_hit(short ioaddr, unsigned short rx_stop_offset)\r\n{\r\noutb(OP0_SWIT_TO_PORT_1 | CR0_CHNL, ioaddr);\r\nif (znet_debug > 5)\r\nprintk(KERN_DEBUG "Updating stop hit with value %02x.\n",\r\n(rx_stop_offset >> 6) | CR1_STOP_REG_UPDATE);\r\noutb((rx_stop_offset >> 6) | CR1_STOP_REG_UPDATE, ioaddr);\r\noutb(OP1_SWIT_TO_PORT_0, ioaddr);\r\n}\r\nstatic __exit void znet_cleanup (void)\r\n{\r\nif (znet_dev) {\r\nstruct znet_private *znet = netdev_priv(znet_dev);\r\nunregister_netdev (znet_dev);\r\nkfree (znet->rx_start);\r\nkfree (znet->tx_start);\r\nfree_netdev (znet_dev);\r\n}\r\n}

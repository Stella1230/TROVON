static void h3a_af_setup_regs(struct ispstat *af, void *priv)\r\n{\r\nstruct omap3isp_h3a_af_config *conf = priv;\r\nu32 pcr;\r\nu32 pax1;\r\nu32 pax2;\r\nu32 paxstart;\r\nu32 coef;\r\nu32 base_coef_set0;\r\nu32 base_coef_set1;\r\nint index;\r\nif (af->state == ISPSTAT_DISABLED)\r\nreturn;\r\nisp_reg_writel(af->isp, af->active_buf->iommu_addr, OMAP3_ISP_IOMEM_H3A,\r\nISPH3A_AFBUFST);\r\nif (!af->update)\r\nreturn;\r\npax1 = ((conf->paxel.width >> 1) - 1) << AF_PAXW_SHIFT;\r\npax1 |= (conf->paxel.height >> 1) - 1;\r\nisp_reg_writel(af->isp, pax1, OMAP3_ISP_IOMEM_H3A, ISPH3A_AFPAX1);\r\npax2 = ((conf->paxel.line_inc >> 1) - 1) << AF_LINE_INCR_SHIFT;\r\npax2 |= (conf->paxel.v_cnt - 1) << AF_VT_COUNT_SHIFT;\r\npax2 |= (conf->paxel.h_cnt - 1);\r\nisp_reg_writel(af->isp, pax2, OMAP3_ISP_IOMEM_H3A, ISPH3A_AFPAX2);\r\npaxstart = conf->paxel.h_start << AF_HZ_START_SHIFT;\r\npaxstart |= conf->paxel.v_start;\r\nisp_reg_writel(af->isp, paxstart, OMAP3_ISP_IOMEM_H3A,\r\nISPH3A_AFPAXSTART);\r\nisp_reg_writel(af->isp, conf->iir.h_start,\r\nOMAP3_ISP_IOMEM_H3A, ISPH3A_AFIIRSH);\r\nbase_coef_set0 = ISPH3A_AFCOEF010;\r\nbase_coef_set1 = ISPH3A_AFCOEF110;\r\nfor (index = 0; index <= 8; index += 2) {\r\ncoef = 0;\r\ncoef |= conf->iir.coeff_set0[index];\r\ncoef |= conf->iir.coeff_set0[index + 1] <<\r\nAF_COEF_SHIFT;\r\nisp_reg_writel(af->isp, coef, OMAP3_ISP_IOMEM_H3A,\r\nbase_coef_set0);\r\nbase_coef_set0 += AFCOEF_OFFSET;\r\ncoef = 0;\r\ncoef |= conf->iir.coeff_set1[index];\r\ncoef |= conf->iir.coeff_set1[index + 1] <<\r\nAF_COEF_SHIFT;\r\nisp_reg_writel(af->isp, coef, OMAP3_ISP_IOMEM_H3A,\r\nbase_coef_set1);\r\nbase_coef_set1 += AFCOEF_OFFSET;\r\n}\r\nisp_reg_writel(af->isp, conf->iir.coeff_set0[10],\r\nOMAP3_ISP_IOMEM_H3A, ISPH3A_AFCOEF0010);\r\nisp_reg_writel(af->isp, conf->iir.coeff_set1[10],\r\nOMAP3_ISP_IOMEM_H3A, ISPH3A_AFCOEF1010);\r\npcr = conf->rgb_pos << AF_RGBPOS_SHIFT;\r\nif (conf->fvmode == OMAP3ISP_AF_MODE_PEAK)\r\npcr |= AF_FVMODE;\r\nif (conf->alaw_enable)\r\npcr |= AF_ALAW_EN;\r\nif (conf->hmf.enable) {\r\npcr |= AF_MED_EN;\r\npcr |= conf->hmf.threshold << AF_MED_TH_SHIFT;\r\n}\r\nisp_reg_clr_set(af->isp, OMAP3_ISP_IOMEM_H3A, ISPH3A_PCR,\r\nAF_PCR_MASK, pcr);\r\naf->update = 0;\r\naf->config_counter += af->inc_config;\r\naf->inc_config = 0;\r\naf->buf_size = conf->buf_size;\r\n}\r\nstatic void h3a_af_enable(struct ispstat *af, int enable)\r\n{\r\nif (enable) {\r\nisp_reg_set(af->isp, OMAP3_ISP_IOMEM_H3A, ISPH3A_PCR,\r\nISPH3A_PCR_AF_EN);\r\nif (af->isp->isp_aewb.state != ISPSTAT_ENABLED)\r\nisp_reg_set(af->isp, OMAP3_ISP_IOMEM_MAIN, ISP_CTRL,\r\nISPCTRL_H3A_CLK_EN);\r\n} else {\r\nisp_reg_clr(af->isp, OMAP3_ISP_IOMEM_H3A, ISPH3A_PCR,\r\nISPH3A_PCR_AF_EN);\r\nif (af->isp->isp_aewb.state != ISPSTAT_ENABLED)\r\nisp_reg_clr(af->isp, OMAP3_ISP_IOMEM_MAIN, ISP_CTRL,\r\nISPCTRL_H3A_CLK_EN);\r\n}\r\n}\r\nstatic int h3a_af_busy(struct ispstat *af)\r\n{\r\nreturn isp_reg_readl(af->isp, OMAP3_ISP_IOMEM_H3A, ISPH3A_PCR)\r\n& ISPH3A_PCR_BUSYAF;\r\n}\r\nstatic u32 h3a_af_get_buf_size(struct omap3isp_h3a_af_config *conf)\r\n{\r\nreturn conf->paxel.h_cnt * conf->paxel.v_cnt * OMAP3ISP_AF_PAXEL_SIZE;\r\n}\r\nstatic int h3a_af_validate_params(struct ispstat *af, void *new_conf)\r\n{\r\nstruct omap3isp_h3a_af_config *user_cfg = new_conf;\r\nstruct omap3isp_h3a_af_paxel *paxel_cfg = &user_cfg->paxel;\r\nstruct omap3isp_h3a_af_iir *iir_cfg = &user_cfg->iir;\r\nint index;\r\nu32 buf_size;\r\nif (IS_OUT_OF_BOUNDS(paxel_cfg->h_cnt,\r\nOMAP3ISP_AF_PAXEL_HORIZONTAL_COUNT_MIN,\r\nOMAP3ISP_AF_PAXEL_HORIZONTAL_COUNT_MAX))\r\nreturn -EINVAL;\r\nif (IS_OUT_OF_BOUNDS(paxel_cfg->v_cnt,\r\nOMAP3ISP_AF_PAXEL_VERTICAL_COUNT_MIN,\r\nOMAP3ISP_AF_PAXEL_VERTICAL_COUNT_MAX))\r\nreturn -EINVAL;\r\nif (IS_OUT_OF_BOUNDS(paxel_cfg->height, OMAP3ISP_AF_PAXEL_HEIGHT_MIN,\r\nOMAP3ISP_AF_PAXEL_HEIGHT_MAX) ||\r\npaxel_cfg->height % 2)\r\nreturn -EINVAL;\r\nif (IS_OUT_OF_BOUNDS(paxel_cfg->width, OMAP3ISP_AF_PAXEL_WIDTH_MIN,\r\nOMAP3ISP_AF_PAXEL_WIDTH_MAX) ||\r\npaxel_cfg->width % 2)\r\nreturn -EINVAL;\r\nif (IS_OUT_OF_BOUNDS(paxel_cfg->line_inc,\r\nOMAP3ISP_AF_PAXEL_INCREMENT_MIN,\r\nOMAP3ISP_AF_PAXEL_INCREMENT_MAX) ||\r\npaxel_cfg->line_inc % 2)\r\nreturn -EINVAL;\r\nif ((paxel_cfg->h_start < iir_cfg->h_start) ||\r\nIS_OUT_OF_BOUNDS(paxel_cfg->h_start,\r\nOMAP3ISP_AF_PAXEL_HZSTART_MIN,\r\nOMAP3ISP_AF_PAXEL_HZSTART_MAX))\r\nreturn -EINVAL;\r\nfor (index = 0; index < OMAP3ISP_AF_NUM_COEF; index++) {\r\nif ((iir_cfg->coeff_set0[index]) > OMAP3ISP_AF_COEF_MAX)\r\nreturn -EINVAL;\r\nif ((iir_cfg->coeff_set1[index]) > OMAP3ISP_AF_COEF_MAX)\r\nreturn -EINVAL;\r\n}\r\nif (IS_OUT_OF_BOUNDS(iir_cfg->h_start, OMAP3ISP_AF_IIRSH_MIN,\r\nOMAP3ISP_AF_IIRSH_MAX))\r\nreturn -EINVAL;\r\nif ((paxel_cfg->h_cnt * paxel_cfg->v_cnt > 9) &&\r\n(paxel_cfg->width * paxel_cfg->height == 12))\r\nreturn -EINVAL;\r\nbuf_size = h3a_af_get_buf_size(user_cfg);\r\nif (buf_size > user_cfg->buf_size)\r\nuser_cfg->buf_size = buf_size;\r\nelse if (user_cfg->buf_size > OMAP3ISP_AF_MAX_BUF_SIZE)\r\nuser_cfg->buf_size = OMAP3ISP_AF_MAX_BUF_SIZE;\r\nreturn 0;\r\n}\r\nstatic void h3a_af_set_params(struct ispstat *af, void *new_conf)\r\n{\r\nstruct omap3isp_h3a_af_config *user_cfg = new_conf;\r\nstruct omap3isp_h3a_af_config *cur_cfg = af->priv;\r\nint update = 0;\r\nint index;\r\nif (cur_cfg->alaw_enable != user_cfg->alaw_enable) {\r\nupdate = 1;\r\ngoto out;\r\n}\r\nif (cur_cfg->hmf.enable != user_cfg->hmf.enable) {\r\nupdate = 1;\r\ngoto out;\r\n}\r\nif (cur_cfg->hmf.threshold != user_cfg->hmf.threshold) {\r\nupdate = 1;\r\ngoto out;\r\n}\r\nif (cur_cfg->rgb_pos != user_cfg->rgb_pos) {\r\nupdate = 1;\r\ngoto out;\r\n}\r\nif (cur_cfg->iir.h_start != user_cfg->iir.h_start) {\r\nupdate = 1;\r\ngoto out;\r\n}\r\nfor (index = 0; index < OMAP3ISP_AF_NUM_COEF; index++) {\r\nif (cur_cfg->iir.coeff_set0[index] !=\r\nuser_cfg->iir.coeff_set0[index]) {\r\nupdate = 1;\r\ngoto out;\r\n}\r\nif (cur_cfg->iir.coeff_set1[index] !=\r\nuser_cfg->iir.coeff_set1[index]) {\r\nupdate = 1;\r\ngoto out;\r\n}\r\n}\r\nif ((cur_cfg->paxel.width != user_cfg->paxel.width) ||\r\n(cur_cfg->paxel.height != user_cfg->paxel.height) ||\r\n(cur_cfg->paxel.h_start != user_cfg->paxel.h_start) ||\r\n(cur_cfg->paxel.v_start != user_cfg->paxel.v_start) ||\r\n(cur_cfg->paxel.h_cnt != user_cfg->paxel.h_cnt) ||\r\n(cur_cfg->paxel.v_cnt != user_cfg->paxel.v_cnt) ||\r\n(cur_cfg->paxel.line_inc != user_cfg->paxel.line_inc)) {\r\nupdate = 1;\r\ngoto out;\r\n}\r\nif (cur_cfg->fvmode != user_cfg->fvmode)\r\nupdate = 1;\r\nout:\r\nif (update || !af->configured) {\r\nmemcpy(cur_cfg, user_cfg, sizeof(*cur_cfg));\r\naf->inc_config++;\r\naf->update = 1;\r\ncur_cfg->buf_size = h3a_af_get_buf_size(cur_cfg);\r\n}\r\n}\r\nstatic long h3a_af_ioctl(struct v4l2_subdev *sd, unsigned int cmd, void *arg)\r\n{\r\nstruct ispstat *stat = v4l2_get_subdevdata(sd);\r\nswitch (cmd) {\r\ncase VIDIOC_OMAP3ISP_AF_CFG:\r\nreturn omap3isp_stat_config(stat, arg);\r\ncase VIDIOC_OMAP3ISP_STAT_REQ:\r\nreturn omap3isp_stat_request_statistics(stat, arg);\r\ncase VIDIOC_OMAP3ISP_STAT_EN: {\r\nint *en = arg;\r\nreturn omap3isp_stat_enable(stat, !!*en);\r\n}\r\n}\r\nreturn -ENOIOCTLCMD;\r\n}\r\nint omap3isp_h3a_af_init(struct isp_device *isp)\r\n{\r\nstruct ispstat *af = &isp->isp_af;\r\nstruct omap3isp_h3a_af_config *af_cfg;\r\nstruct omap3isp_h3a_af_config *af_recover_cfg;\r\nint ret;\r\naf_cfg = kzalloc(sizeof(*af_cfg), GFP_KERNEL);\r\nif (af_cfg == NULL)\r\nreturn -ENOMEM;\r\nmemset(af, 0, sizeof(*af));\r\naf->ops = &h3a_af_ops;\r\naf->priv = af_cfg;\r\naf->dma_ch = -1;\r\naf->event_type = V4L2_EVENT_OMAP3ISP_AF;\r\naf->isp = isp;\r\naf_recover_cfg = kzalloc(sizeof(*af_recover_cfg), GFP_KERNEL);\r\nif (!af_recover_cfg) {\r\ndev_err(af->isp->dev, "AF: cannot allocate memory for recover "\r\n"configuration.\n");\r\nret = -ENOMEM;\r\ngoto err_recover_alloc;\r\n}\r\naf_recover_cfg->paxel.h_start = OMAP3ISP_AF_PAXEL_HZSTART_MIN;\r\naf_recover_cfg->paxel.width = OMAP3ISP_AF_PAXEL_WIDTH_MIN;\r\naf_recover_cfg->paxel.height = OMAP3ISP_AF_PAXEL_HEIGHT_MIN;\r\naf_recover_cfg->paxel.h_cnt = OMAP3ISP_AF_PAXEL_HORIZONTAL_COUNT_MIN;\r\naf_recover_cfg->paxel.v_cnt = OMAP3ISP_AF_PAXEL_VERTICAL_COUNT_MIN;\r\naf_recover_cfg->paxel.line_inc = OMAP3ISP_AF_PAXEL_INCREMENT_MIN;\r\nif (h3a_af_validate_params(af, af_recover_cfg)) {\r\ndev_err(af->isp->dev, "AF: recover configuration is "\r\n"invalid.\n");\r\nret = -EINVAL;\r\ngoto err_conf;\r\n}\r\naf_recover_cfg->buf_size = h3a_af_get_buf_size(af_recover_cfg);\r\naf->recover_priv = af_recover_cfg;\r\nret = omap3isp_stat_init(af, "AF", &h3a_af_subdev_ops);\r\nif (ret)\r\ngoto err_conf;\r\nreturn 0;\r\nerr_conf:\r\nkfree(af_recover_cfg);\r\nerr_recover_alloc:\r\nkfree(af_cfg);\r\nreturn ret;\r\n}\r\nvoid omap3isp_h3a_af_cleanup(struct isp_device *isp)\r\n{\r\nkfree(isp->isp_af.priv);\r\nkfree(isp->isp_af.recover_priv);\r\nomap3isp_stat_cleanup(&isp->isp_af);\r\n}

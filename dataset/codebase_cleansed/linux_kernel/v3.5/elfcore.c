Elf32_Half elf_core_extra_phdrs(void)\r\n{\r\nreturn vsyscall_ehdr ? (((struct elfhdr *)vsyscall_ehdr)->e_phnum) : 0;\r\n}\r\nint elf_core_write_extra_phdrs(struct file *file, loff_t offset, size_t *size,\r\nunsigned long limit)\r\n{\r\nif ( vsyscall_ehdr ) {\r\nconst struct elfhdr *const ehdrp =\r\n(struct elfhdr *) vsyscall_ehdr;\r\nconst struct elf_phdr *const phdrp =\r\n(const struct elf_phdr *) (vsyscall_ehdr + ehdrp->e_phoff);\r\nint i;\r\nElf32_Off ofs = 0;\r\nfor (i = 0; i < ehdrp->e_phnum; ++i) {\r\nstruct elf_phdr phdr = phdrp[i];\r\nif (phdr.p_type == PT_LOAD) {\r\nofs = phdr.p_offset = offset;\r\noffset += phdr.p_filesz;\r\n} else {\r\nphdr.p_offset += ofs;\r\n}\r\nphdr.p_paddr = 0;\r\n*size += sizeof(phdr);\r\nif (*size > limit\r\n|| !dump_write(file, &phdr, sizeof(phdr)))\r\nreturn 0;\r\n}\r\n}\r\nreturn 1;\r\n}\r\nint elf_core_write_extra_data(struct file *file, size_t *size,\r\nunsigned long limit)\r\n{\r\nif ( vsyscall_ehdr ) {\r\nconst struct elfhdr *const ehdrp =\r\n(struct elfhdr *) vsyscall_ehdr;\r\nconst struct elf_phdr *const phdrp =\r\n(const struct elf_phdr *) (vsyscall_ehdr + ehdrp->e_phoff);\r\nint i;\r\nfor (i = 0; i < ehdrp->e_phnum; ++i) {\r\nif (phdrp[i].p_type == PT_LOAD) {\r\nvoid *addr = (void *) phdrp[i].p_vaddr;\r\nsize_t filesz = phdrp[i].p_filesz;\r\n*size += filesz;\r\nif (*size > limit\r\n|| !dump_write(file, addr, filesz))\r\nreturn 0;\r\n}\r\n}\r\n}\r\nreturn 1;\r\n}\r\nsize_t elf_core_extra_data_size(void)\r\n{\r\nif ( vsyscall_ehdr ) {\r\nconst struct elfhdr *const ehdrp =\r\n(struct elfhdr *)vsyscall_ehdr;\r\nconst struct elf_phdr *const phdrp =\r\n(const struct elf_phdr *) (vsyscall_ehdr + ehdrp->e_phoff);\r\nint i;\r\nfor (i = 0; i < ehdrp->e_phnum; ++i)\r\nif (phdrp[i].p_type == PT_LOAD)\r\nreturn (size_t) phdrp[i].p_filesz;\r\n}\r\nreturn 0;\r\n}

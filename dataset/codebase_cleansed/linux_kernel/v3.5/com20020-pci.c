static int __devinit com20020pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstruct net_device *dev;\r\nstruct arcnet_local *lp;\r\nint ioaddr, err;\r\nif (pci_enable_device(pdev))\r\nreturn -EIO;\r\ndev = alloc_arcdev(device);\r\nif (!dev)\r\nreturn -ENOMEM;\r\ndev->netdev_ops = &com20020_netdev_ops;\r\nlp = netdev_priv(dev);\r\npci_set_drvdata(pdev, dev);\r\nif (pdev->vendor==0x10B5) {\r\nBUGMSG(D_NORMAL, "SOHARD\n");\r\nioaddr = pci_resource_start(pdev, 4);\r\n}\r\nelse {\r\nBUGMSG(D_NORMAL, "Contemporary Controls\n");\r\nioaddr = pci_resource_start(pdev, 2);\r\n}\r\nif (!request_region(ioaddr, ARCNET_TOTAL_SIZE, "com20020-pci")) {\r\nBUGMSG(D_INIT, "IO region %xh-%xh already allocated.\n",\r\nioaddr, ioaddr + ARCNET_TOTAL_SIZE - 1);\r\nerr = -EBUSY;\r\ngoto out_dev;\r\n}\r\noutb(0x00,ioaddr+1);\r\ninb(ioaddr+1);\r\ndev->base_addr = ioaddr;\r\ndev->irq = pdev->irq;\r\ndev->dev_addr[0] = node;\r\nlp->card_name = "PCI COM20020";\r\nlp->card_flags = id->driver_data;\r\nlp->backplane = backplane;\r\nlp->clockp = clockp & 7;\r\nlp->clockm = clockm & 3;\r\nlp->timeout = timeout;\r\nlp->hw.owner = THIS_MODULE;\r\nif (ASTATUS() == 0xFF) {\r\nBUGMSG(D_NORMAL, "IO address %Xh was reported by PCI BIOS, "\r\n"but seems empty!\n", ioaddr);\r\nerr = -EIO;\r\ngoto out_port;\r\n}\r\nif (com20020_check(dev)) {\r\nerr = -EIO;\r\ngoto out_port;\r\n}\r\nif ((err = com20020_found(dev, IRQF_SHARED)) != 0)\r\ngoto out_port;\r\nreturn 0;\r\nout_port:\r\nrelease_region(ioaddr, ARCNET_TOTAL_SIZE);\r\nout_dev:\r\nfree_netdev(dev);\r\nreturn err;\r\n}\r\nstatic void __devexit com20020pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct net_device *dev = pci_get_drvdata(pdev);\r\nunregister_netdev(dev);\r\nfree_irq(dev->irq, dev);\r\nrelease_region(dev->base_addr, ARCNET_TOTAL_SIZE);\r\nfree_netdev(dev);\r\n}\r\nstatic int __init com20020pci_init(void)\r\n{\r\nBUGLVL(D_NORMAL) printk(VERSION);\r\nreturn pci_register_driver(&com20020pci_driver);\r\n}\r\nstatic void __exit com20020pci_cleanup(void)\r\n{\r\npci_unregister_driver(&com20020pci_driver);\r\n}

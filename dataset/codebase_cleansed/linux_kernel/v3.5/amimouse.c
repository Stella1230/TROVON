static irqreturn_t amimouse_interrupt(int irq, void *data)\r\n{\r\nstruct input_dev *dev = data;\r\nunsigned short joy0dat, potgor;\r\nint nx, ny, dx, dy;\r\njoy0dat = amiga_custom.joy0dat;\r\nnx = joy0dat & 0xff;\r\nny = joy0dat >> 8;\r\ndx = nx - amimouse_lastx;\r\ndy = ny - amimouse_lasty;\r\nif (dx < -127) dx = (256 + nx) - amimouse_lastx;\r\nif (dx > 127) dx = (nx - 256) - amimouse_lastx;\r\nif (dy < -127) dy = (256 + ny) - amimouse_lasty;\r\nif (dy > 127) dy = (ny - 256) - amimouse_lasty;\r\namimouse_lastx = nx;\r\namimouse_lasty = ny;\r\npotgor = amiga_custom.potgor;\r\ninput_report_rel(dev, REL_X, dx);\r\ninput_report_rel(dev, REL_Y, dy);\r\ninput_report_key(dev, BTN_LEFT, ciaa.pra & 0x40);\r\ninput_report_key(dev, BTN_MIDDLE, potgor & 0x0100);\r\ninput_report_key(dev, BTN_RIGHT, potgor & 0x0400);\r\ninput_sync(dev);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int amimouse_open(struct input_dev *dev)\r\n{\r\nunsigned short joy0dat;\r\nint error;\r\njoy0dat = amiga_custom.joy0dat;\r\namimouse_lastx = joy0dat & 0xff;\r\namimouse_lasty = joy0dat >> 8;\r\nerror = request_irq(IRQ_AMIGA_VERTB, amimouse_interrupt, 0, "amimouse",\r\ndev);\r\nif (error)\r\ndev_err(&dev->dev, "Can't allocate irq %d\n", IRQ_AMIGA_VERTB);\r\nreturn error;\r\n}\r\nstatic void amimouse_close(struct input_dev *dev)\r\n{\r\nfree_irq(IRQ_AMIGA_VERTB, dev);\r\n}\r\nstatic int __init amimouse_probe(struct platform_device *pdev)\r\n{\r\nint err;\r\nstruct input_dev *dev;\r\ndev = input_allocate_device();\r\nif (!dev)\r\nreturn -ENOMEM;\r\ndev->name = pdev->name;\r\ndev->phys = "amimouse/input0";\r\ndev->id.bustype = BUS_AMIGA;\r\ndev->id.vendor = 0x0001;\r\ndev->id.product = 0x0002;\r\ndev->id.version = 0x0100;\r\ndev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REL);\r\ndev->relbit[0] = BIT_MASK(REL_X) | BIT_MASK(REL_Y);\r\ndev->keybit[BIT_WORD(BTN_LEFT)] = BIT_MASK(BTN_LEFT) |\r\nBIT_MASK(BTN_MIDDLE) | BIT_MASK(BTN_RIGHT);\r\ndev->open = amimouse_open;\r\ndev->close = amimouse_close;\r\ndev->dev.parent = &pdev->dev;\r\nerr = input_register_device(dev);\r\nif (err) {\r\ninput_free_device(dev);\r\nreturn err;\r\n}\r\nplatform_set_drvdata(pdev, dev);\r\nreturn 0;\r\n}\r\nstatic int __exit amimouse_remove(struct platform_device *pdev)\r\n{\r\nstruct input_dev *dev = platform_get_drvdata(pdev);\r\nplatform_set_drvdata(pdev, NULL);\r\ninput_unregister_device(dev);\r\nreturn 0;\r\n}\r\nstatic int __init amimouse_init(void)\r\n{\r\nreturn platform_driver_probe(&amimouse_driver, amimouse_probe);\r\n}\r\nstatic void __exit amimouse_exit(void)\r\n{\r\nplatform_driver_unregister(&amimouse_driver);\r\n}

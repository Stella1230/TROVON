long compat_arch_ptrace(struct task_struct *child, compat_long_t request,\r\ncompat_ulong_t caddr, compat_ulong_t cdata)\r\n{\r\nint addr = caddr;\r\nint data = cdata;\r\nint ret;\r\nswitch (request) {\r\ncase PTRACE_PEEKTEXT_3264:\r\ncase PTRACE_PEEKDATA_3264: {\r\nu32 tmp;\r\nint copied;\r\nu32 __user * addrOthers;\r\nret = -EIO;\r\nif (get_user(addrOthers, (u32 __user * __user *) (unsigned long) addr) != 0)\r\nbreak;\r\ncopied = access_process_vm(child, (u64)addrOthers, &tmp,\r\nsizeof(tmp), 0);\r\nif (copied != sizeof(tmp))\r\nbreak;\r\nret = put_user(tmp, (u32 __user *) (unsigned long) data);\r\nbreak;\r\n}\r\ncase PTRACE_PEEKUSR: {\r\nstruct pt_regs *regs;\r\nunsigned int tmp;\r\nregs = task_pt_regs(child);\r\nret = 0;\r\nswitch (addr) {\r\ncase 0 ... 31:\r\ntmp = regs->regs[addr];\r\nbreak;\r\ncase FPR_BASE ... FPR_BASE + 31:\r\nif (tsk_used_math(child)) {\r\nfpureg_t *fregs = get_fpu_regs(child);\r\nif (addr & 1)\r\ntmp = (unsigned long) (fregs[((addr & ~1) - 32)] >> 32);\r\nelse\r\ntmp = (unsigned long) (fregs[(addr - 32)] & 0xffffffff);\r\n} else {\r\ntmp = -1;\r\n}\r\nbreak;\r\ncase PC:\r\ntmp = regs->cp0_epc;\r\nbreak;\r\ncase CAUSE:\r\ntmp = regs->cp0_cause;\r\nbreak;\r\ncase BADVADDR:\r\ntmp = regs->cp0_badvaddr;\r\nbreak;\r\ncase MMHI:\r\ntmp = regs->hi;\r\nbreak;\r\ncase MMLO:\r\ntmp = regs->lo;\r\nbreak;\r\ncase FPC_CSR:\r\ntmp = child->thread.fpu.fcr31;\r\nbreak;\r\ncase FPC_EIR: {\r\nunsigned int flags;\r\n#ifdef CONFIG_MIPS_MT_SMTC\r\nunsigned int irqflags;\r\nunsigned int mtflags;\r\n#endif\r\npreempt_disable();\r\nif (!cpu_has_fpu) {\r\npreempt_enable();\r\ntmp = 0;\r\nbreak;\r\n}\r\n#ifdef CONFIG_MIPS_MT_SMTC\r\nlocal_irq_save(irqflags);\r\nmtflags = dmt();\r\n#endif\r\nif (cpu_has_mipsmt) {\r\nunsigned int vpflags = dvpe();\r\nflags = read_c0_status();\r\n__enable_fpu();\r\n__asm__ __volatile__("cfc1\t%0,$0": "=r" (tmp));\r\nwrite_c0_status(flags);\r\nevpe(vpflags);\r\n} else {\r\nflags = read_c0_status();\r\n__enable_fpu();\r\n__asm__ __volatile__("cfc1\t%0,$0": "=r" (tmp));\r\nwrite_c0_status(flags);\r\n}\r\n#ifdef CONFIG_MIPS_MT_SMTC\r\nemt(mtflags);\r\nlocal_irq_restore(irqflags);\r\n#endif\r\npreempt_enable();\r\nbreak;\r\n}\r\ncase DSP_BASE ... DSP_BASE + 5: {\r\ndspreg_t *dregs;\r\nif (!cpu_has_dsp) {\r\ntmp = 0;\r\nret = -EIO;\r\ngoto out;\r\n}\r\ndregs = __get_dsp_regs(child);\r\ntmp = (unsigned long) (dregs[addr - DSP_BASE]);\r\nbreak;\r\n}\r\ncase DSP_CONTROL:\r\nif (!cpu_has_dsp) {\r\ntmp = 0;\r\nret = -EIO;\r\ngoto out;\r\n}\r\ntmp = child->thread.dsp.dspcontrol;\r\nbreak;\r\ndefault:\r\ntmp = 0;\r\nret = -EIO;\r\ngoto out;\r\n}\r\nret = put_user(tmp, (unsigned __user *) (unsigned long) data);\r\nbreak;\r\n}\r\ncase PTRACE_POKETEXT_3264:\r\ncase PTRACE_POKEDATA_3264: {\r\nu32 __user * addrOthers;\r\nret = -EIO;\r\nif (get_user(addrOthers, (u32 __user * __user *) (unsigned long) addr) != 0)\r\nbreak;\r\nret = 0;\r\nif (access_process_vm(child, (u64)addrOthers, &data,\r\nsizeof(data), 1) == sizeof(data))\r\nbreak;\r\nret = -EIO;\r\nbreak;\r\n}\r\ncase PTRACE_POKEUSR: {\r\nstruct pt_regs *regs;\r\nret = 0;\r\nregs = task_pt_regs(child);\r\nswitch (addr) {\r\ncase 0 ... 31:\r\nregs->regs[addr] = data;\r\nbreak;\r\ncase FPR_BASE ... FPR_BASE + 31: {\r\nfpureg_t *fregs = get_fpu_regs(child);\r\nif (!tsk_used_math(child)) {\r\nmemset(&child->thread.fpu, ~0,\r\nsizeof(child->thread.fpu));\r\nchild->thread.fpu.fcr31 = 0;\r\n}\r\nif (addr & 1) {\r\nfregs[(addr & ~1) - FPR_BASE] &= 0xffffffff;\r\nfregs[(addr & ~1) - FPR_BASE] |= ((unsigned long long) data) << 32;\r\n} else {\r\nfregs[addr - FPR_BASE] &= ~0xffffffffLL;\r\nfregs[addr - FPR_BASE] |= (unsigned int)data;\r\n}\r\nbreak;\r\n}\r\ncase PC:\r\nregs->cp0_epc = data;\r\nbreak;\r\ncase MMHI:\r\nregs->hi = data;\r\nbreak;\r\ncase MMLO:\r\nregs->lo = data;\r\nbreak;\r\ncase FPC_CSR:\r\nchild->thread.fpu.fcr31 = data;\r\nbreak;\r\ncase DSP_BASE ... DSP_BASE + 5: {\r\ndspreg_t *dregs;\r\nif (!cpu_has_dsp) {\r\nret = -EIO;\r\nbreak;\r\n}\r\ndregs = __get_dsp_regs(child);\r\ndregs[addr - DSP_BASE] = data;\r\nbreak;\r\n}\r\ncase DSP_CONTROL:\r\nif (!cpu_has_dsp) {\r\nret = -EIO;\r\nbreak;\r\n}\r\nchild->thread.dsp.dspcontrol = data;\r\nbreak;\r\ndefault:\r\nret = -EIO;\r\nbreak;\r\n}\r\nbreak;\r\n}\r\ncase PTRACE_GETREGS:\r\nret = ptrace_getregs(child, (__s64 __user *) (__u64) data);\r\nbreak;\r\ncase PTRACE_SETREGS:\r\nret = ptrace_setregs(child, (__s64 __user *) (__u64) data);\r\nbreak;\r\ncase PTRACE_GETFPREGS:\r\nret = ptrace_getfpregs(child, (__u32 __user *) (__u64) data);\r\nbreak;\r\ncase PTRACE_SETFPREGS:\r\nret = ptrace_setfpregs(child, (__u32 __user *) (__u64) data);\r\nbreak;\r\ncase PTRACE_GET_THREAD_AREA:\r\nret = put_user(task_thread_info(child)->tp_value,\r\n(unsigned int __user *) (unsigned long) data);\r\nbreak;\r\ncase PTRACE_GET_THREAD_AREA_3264:\r\nret = put_user(task_thread_info(child)->tp_value,\r\n(unsigned long __user *) (unsigned long) data);\r\nbreak;\r\ncase PTRACE_GET_WATCH_REGS:\r\nret = ptrace_get_watch_regs(child,\r\n(struct pt_watch_regs __user *) (unsigned long) addr);\r\nbreak;\r\ncase PTRACE_SET_WATCH_REGS:\r\nret = ptrace_set_watch_regs(child,\r\n(struct pt_watch_regs __user *) (unsigned long) addr);\r\nbreak;\r\ndefault:\r\nret = compat_ptrace_request(child, request, addr, data);\r\nbreak;\r\n}\r\nout:\r\nreturn ret;\r\n}

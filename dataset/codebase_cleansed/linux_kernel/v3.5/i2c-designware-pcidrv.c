static int i2c_dw_pci_suspend(struct device *dev)\r\n{\r\nstruct pci_dev *pdev = container_of(dev, struct pci_dev, dev);\r\nstruct dw_i2c_dev *i2c = pci_get_drvdata(pdev);\r\nint err;\r\ni2c_dw_disable(i2c);\r\nerr = pci_save_state(pdev);\r\nif (err) {\r\ndev_err(&pdev->dev, "pci_save_state failed\n");\r\nreturn err;\r\n}\r\nerr = pci_set_power_state(pdev, PCI_D3hot);\r\nif (err) {\r\ndev_err(&pdev->dev, "pci_set_power_state failed\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int i2c_dw_pci_resume(struct device *dev)\r\n{\r\nstruct pci_dev *pdev = container_of(dev, struct pci_dev, dev);\r\nstruct dw_i2c_dev *i2c = pci_get_drvdata(pdev);\r\nint err;\r\nu32 enabled;\r\nenabled = i2c_dw_is_enabled(i2c);\r\nif (enabled)\r\nreturn 0;\r\nerr = pci_set_power_state(pdev, PCI_D0);\r\nif (err) {\r\ndev_err(&pdev->dev, "pci_set_power_state() failed\n");\r\nreturn err;\r\n}\r\npci_restore_state(pdev);\r\ni2c_dw_init(i2c);\r\nreturn 0;\r\n}\r\nstatic int i2c_dw_pci_runtime_idle(struct device *dev)\r\n{\r\nint err = pm_schedule_suspend(dev, 500);\r\ndev_dbg(dev, "runtime_idle called\n");\r\nif (err != 0)\r\nreturn 0;\r\nreturn -EBUSY;\r\n}\r\nstatic u32 i2c_dw_get_clk_rate_khz(struct dw_i2c_dev *dev)\r\n{\r\nreturn dev->controller->clk_khz;\r\n}\r\nstatic int __devinit i2c_dw_pci_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nstruct dw_i2c_dev *dev;\r\nstruct i2c_adapter *adap;\r\nunsigned long start, len;\r\nvoid __iomem *base;\r\nint r;\r\nstruct dw_pci_controller *controller;\r\nif (id->driver_data >= ARRAY_SIZE(dw_pci_controllers)) {\r\nprintk(KERN_ERR "dw_i2c_pci_probe: invalid driver data %ld\n",\r\nid->driver_data);\r\nreturn -EINVAL;\r\n}\r\ncontroller = &dw_pci_controllers[id->driver_data];\r\nr = pci_enable_device(pdev);\r\nif (r) {\r\ndev_err(&pdev->dev, "Failed to enable I2C PCI device (%d)\n",\r\nr);\r\ngoto exit;\r\n}\r\nstart = pci_resource_start(pdev, 0);\r\nlen = pci_resource_len(pdev, 0);\r\nif (!start || len == 0) {\r\ndev_err(&pdev->dev, "base address not set\n");\r\nr = -ENODEV;\r\ngoto exit;\r\n}\r\nr = pci_request_region(pdev, 0, DRIVER_NAME);\r\nif (r) {\r\ndev_err(&pdev->dev, "failed to request I2C region "\r\n"0x%lx-0x%lx\n", start,\r\n(unsigned long)pci_resource_end(pdev, 0));\r\ngoto exit;\r\n}\r\nbase = ioremap_nocache(start, len);\r\nif (!base) {\r\ndev_err(&pdev->dev, "I/O memory remapping failed\n");\r\nr = -ENOMEM;\r\ngoto err_release_region;\r\n}\r\ndev = kzalloc(sizeof(struct dw_i2c_dev), GFP_KERNEL);\r\nif (!dev) {\r\nr = -ENOMEM;\r\ngoto err_release_region;\r\n}\r\ninit_completion(&dev->cmd_complete);\r\nmutex_init(&dev->lock);\r\ndev->clk = NULL;\r\ndev->controller = controller;\r\ndev->get_clk_rate_khz = i2c_dw_get_clk_rate_khz;\r\ndev->base = base;\r\ndev->dev = get_device(&pdev->dev);\r\ndev->functionality =\r\nI2C_FUNC_I2C |\r\nI2C_FUNC_SMBUS_BYTE |\r\nI2C_FUNC_SMBUS_BYTE_DATA |\r\nI2C_FUNC_SMBUS_WORD_DATA |\r\nI2C_FUNC_SMBUS_I2C_BLOCK;\r\ndev->master_cfg = controller->bus_cfg;\r\npci_set_drvdata(pdev, dev);\r\ndev->tx_fifo_depth = controller->tx_fifo_depth;\r\ndev->rx_fifo_depth = controller->rx_fifo_depth;\r\nr = i2c_dw_init(dev);\r\nif (r)\r\ngoto err_iounmap;\r\nadap = &dev->adapter;\r\ni2c_set_adapdata(adap, dev);\r\nadap->owner = THIS_MODULE;\r\nadap->class = 0;\r\nadap->algo = &i2c_dw_algo;\r\nadap->dev.parent = &pdev->dev;\r\nadap->nr = controller->bus_num;\r\nsnprintf(adap->name, sizeof(adap->name), "i2c-designware-pci-%d",\r\nadap->nr);\r\nr = request_irq(pdev->irq, i2c_dw_isr, IRQF_SHARED, adap->name, dev);\r\nif (r) {\r\ndev_err(&pdev->dev, "failure requesting irq %i\n", dev->irq);\r\ngoto err_iounmap;\r\n}\r\ni2c_dw_disable_int(dev);\r\ni2c_dw_clear_int(dev);\r\nr = i2c_add_numbered_adapter(adap);\r\nif (r) {\r\ndev_err(&pdev->dev, "failure adding adapter\n");\r\ngoto err_free_irq;\r\n}\r\npm_runtime_put_noidle(&pdev->dev);\r\npm_runtime_allow(&pdev->dev);\r\nreturn 0;\r\nerr_free_irq:\r\nfree_irq(pdev->irq, dev);\r\nerr_iounmap:\r\niounmap(dev->base);\r\npci_set_drvdata(pdev, NULL);\r\nput_device(&pdev->dev);\r\nkfree(dev);\r\nerr_release_region:\r\npci_release_region(pdev, 0);\r\nexit:\r\nreturn r;\r\n}\r\nstatic void __devexit i2c_dw_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct dw_i2c_dev *dev = pci_get_drvdata(pdev);\r\ni2c_dw_disable(dev);\r\npm_runtime_forbid(&pdev->dev);\r\npm_runtime_get_noresume(&pdev->dev);\r\npci_set_drvdata(pdev, NULL);\r\ni2c_del_adapter(&dev->adapter);\r\nput_device(&pdev->dev);\r\nfree_irq(dev->irq, dev);\r\nkfree(dev);\r\npci_release_region(pdev, 0);\r\n}\r\nstatic int __init dw_i2c_init_driver(void)\r\n{\r\nreturn pci_register_driver(&dw_i2c_driver);\r\n}\r\nstatic void __exit dw_i2c_exit_driver(void)\r\n{\r\npci_unregister_driver(&dw_i2c_driver);\r\n}

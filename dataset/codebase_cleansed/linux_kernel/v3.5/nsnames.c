acpi_status\r\nacpi_ns_build_external_path(struct acpi_namespace_node *node,\r\nacpi_size size, char *name_buffer)\r\n{\r\nacpi_size index;\r\nstruct acpi_namespace_node *parent_node;\r\nACPI_FUNCTION_ENTRY();\r\nindex = size - 1;\r\nif (index < ACPI_NAME_SIZE) {\r\nname_buffer[0] = AML_ROOT_PREFIX;\r\nname_buffer[1] = 0;\r\nreturn (AE_OK);\r\n}\r\nparent_node = node;\r\nname_buffer[index] = 0;\r\nwhile ((index > ACPI_NAME_SIZE) && (parent_node != acpi_gbl_root_node)) {\r\nindex -= ACPI_NAME_SIZE;\r\nACPI_MOVE_32_TO_32((name_buffer + index), &parent_node->name);\r\nparent_node = parent_node->parent;\r\nindex--;\r\nname_buffer[index] = ACPI_PATH_SEPARATOR;\r\n}\r\nname_buffer[index] = AML_ROOT_PREFIX;\r\nif (index != 0) {\r\nACPI_ERROR((AE_INFO,\r\n"Could not construct external pathname; index=%u, size=%u, Path=%s",\r\n(u32) index, (u32) size, &name_buffer[size]));\r\nreturn (AE_BAD_PARAMETER);\r\n}\r\nreturn (AE_OK);\r\n}\r\nchar *acpi_ns_get_external_pathname(struct acpi_namespace_node *node)\r\n{\r\nacpi_status status;\r\nchar *name_buffer;\r\nacpi_size size;\r\nACPI_FUNCTION_TRACE_PTR(ns_get_external_pathname, node);\r\nsize = acpi_ns_get_pathname_length(node);\r\nif (!size) {\r\nreturn_PTR(NULL);\r\n}\r\nname_buffer = ACPI_ALLOCATE_ZEROED(size);\r\nif (!name_buffer) {\r\nACPI_ERROR((AE_INFO, "Could not allocate %u bytes", (u32)size));\r\nreturn_PTR(NULL);\r\n}\r\nstatus = acpi_ns_build_external_path(node, size, name_buffer);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_FREE(name_buffer);\r\nreturn_PTR(NULL);\r\n}\r\nreturn_PTR(name_buffer);\r\n}\r\nacpi_size acpi_ns_get_pathname_length(struct acpi_namespace_node *node)\r\n{\r\nacpi_size size;\r\nstruct acpi_namespace_node *next_node;\r\nACPI_FUNCTION_ENTRY();\r\nsize = 0;\r\nnext_node = node;\r\nwhile (next_node && (next_node != acpi_gbl_root_node)) {\r\nif (ACPI_GET_DESCRIPTOR_TYPE(next_node) != ACPI_DESC_TYPE_NAMED) {\r\nACPI_ERROR((AE_INFO,\r\n"Invalid Namespace Node (%p) while traversing namespace",\r\nnext_node));\r\nreturn 0;\r\n}\r\nsize += ACPI_PATH_SEGMENT_LENGTH;\r\nnext_node = next_node->parent;\r\n}\r\nif (!size) {\r\nsize = 1;\r\n}\r\nreturn (size + 1);\r\n}\r\nacpi_status\r\nacpi_ns_handle_to_pathname(acpi_handle target_handle,\r\nstruct acpi_buffer * buffer)\r\n{\r\nacpi_status status;\r\nstruct acpi_namespace_node *node;\r\nacpi_size required_size;\r\nACPI_FUNCTION_TRACE_PTR(ns_handle_to_pathname, target_handle);\r\nnode = acpi_ns_validate_handle(target_handle);\r\nif (!node) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nrequired_size = acpi_ns_get_pathname_length(node);\r\nif (!required_size) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nstatus = acpi_ut_initialize_buffer(buffer, required_size);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus =\r\nacpi_ns_build_external_path(node, required_size, buffer->pointer);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "%s [%X]\n",\r\n(char *)buffer->pointer, (u32) required_size));\r\nreturn_ACPI_STATUS(AE_OK);\r\n}

int __init tx28_add_fec0(void)\r\n{\r\nint i, ret;\r\npr_debug("%s: Switching FEC PHY power off\n", __func__);\r\nret = mxs_iomux_setup_multiple_pads(tx28_fec_gpio_pads,\r\nARRAY_SIZE(tx28_fec_gpio_pads));\r\nfor (i = 0; i < ARRAY_SIZE(tx28_fec_gpio_pads); i++) {\r\nunsigned int gpio = MXS_GPIO_NR(PAD_BANK(tx28_fec_gpio_pads[i]),\r\nPAD_PIN(tx28_fec_gpio_pads[i]));\r\nret = gpio_request(gpio, "FEC");\r\nif (ret) {\r\npr_err("Failed to request GPIO_%d_%d: %d\n",\r\nPAD_BANK(tx28_fec_gpio_pads[i]),\r\nPAD_PIN(tx28_fec_gpio_pads[i]), ret);\r\ngoto free_gpios;\r\n}\r\nret = gpio_direction_output(gpio, 0);\r\nif (ret) {\r\npr_err("Failed to set direction of GPIO_%d_%d to output: %d\n",\r\ngpio / 32 + 1, gpio % 32, ret);\r\ngoto free_gpios;\r\n}\r\n}\r\npr_debug("%s: Switching FEC PHY power on\n", __func__);\r\nret = gpio_direction_output(TX28_FEC_PHY_POWER, 1);\r\nif (ret) {\r\npr_err("Failed to power on PHY: %d\n", ret);\r\ngoto free_gpios;\r\n}\r\nmdelay(26);\r\ngpio_direction_input(MXS_GPIO_NR(4, 5));\r\ngpio_direction_output(MXS_GPIO_NR(4, 2), 1);\r\ngpio_direction_output(MXS_GPIO_NR(4, 3), 1);\r\ngpio_direction_output(MXS_GPIO_NR(4, 4), 1);\r\nudelay(100);\r\npr_debug("%s: Deasserting FEC PHY RESET\n", __func__);\r\ngpio_set_value(TX28_FEC_PHY_RESET, 1);\r\nret = mxs_iomux_setup_multiple_pads(tx28_fec0_pads,\r\nARRAY_SIZE(tx28_fec0_pads));\r\nif (ret) {\r\npr_debug("%s: mxs_iomux_setup_multiple_pads() failed with rc: %d\n",\r\n__func__, ret);\r\ngoto free_gpios;\r\n}\r\npr_debug("%s: Registering FEC0 device\n", __func__);\r\nmx28_add_fec(0, &tx28_fec0_data);\r\nreturn 0;\r\nfree_gpios:\r\nwhile (--i >= 0) {\r\nunsigned int gpio = MXS_GPIO_NR(PAD_BANK(tx28_fec_gpio_pads[i]),\r\nPAD_PIN(tx28_fec_gpio_pads[i]));\r\ngpio_free(gpio);\r\n}\r\nreturn ret;\r\n}\r\nint __init tx28_add_fec1(void)\r\n{\r\nint ret;\r\nret = mxs_iomux_setup_multiple_pads(tx28_fec1_pads,\r\nARRAY_SIZE(tx28_fec1_pads));\r\nif (ret) {\r\npr_debug("%s: mxs_iomux_setup_multiple_pads() failed with rc: %d\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\npr_debug("%s: Registering FEC1 device\n", __func__);\r\nmx28_add_fec(1, &tx28_fec1_data);\r\nreturn 0;\r\n}

static inline void zl6100_wait(const struct zl6100_data *data)\r\n{\r\nif (data->delay) {\r\ns64 delta = ktime_us_delta(ktime_get(), data->access);\r\nif (delta < data->delay)\r\nudelay(data->delay - delta);\r\n}\r\n}\r\nstatic int zl6100_read_word_data(struct i2c_client *client, int page, int reg)\r\n{\r\nconst struct pmbus_driver_info *info = pmbus_get_driver_info(client);\r\nstruct zl6100_data *data = to_zl6100_data(info);\r\nint ret;\r\nif (page || reg >= PMBUS_VIRT_BASE)\r\nreturn -ENXIO;\r\nif (data->id == zl2005) {\r\nswitch (reg) {\r\ncase PMBUS_VOUT_OV_WARN_LIMIT:\r\ncase PMBUS_VOUT_UV_WARN_LIMIT:\r\ncase PMBUS_IOUT_OC_WARN_LIMIT:\r\nreturn -ENXIO;\r\n}\r\n}\r\nzl6100_wait(data);\r\nret = pmbus_read_word_data(client, page, reg);\r\ndata->access = ktime_get();\r\nreturn ret;\r\n}\r\nstatic int zl6100_read_byte_data(struct i2c_client *client, int page, int reg)\r\n{\r\nconst struct pmbus_driver_info *info = pmbus_get_driver_info(client);\r\nstruct zl6100_data *data = to_zl6100_data(info);\r\nint ret;\r\nif (page > 0)\r\nreturn -ENXIO;\r\nzl6100_wait(data);\r\nret = pmbus_read_byte_data(client, page, reg);\r\ndata->access = ktime_get();\r\nreturn ret;\r\n}\r\nstatic int zl6100_write_word_data(struct i2c_client *client, int page, int reg,\r\nu16 word)\r\n{\r\nconst struct pmbus_driver_info *info = pmbus_get_driver_info(client);\r\nstruct zl6100_data *data = to_zl6100_data(info);\r\nint ret;\r\nif (page || reg >= PMBUS_VIRT_BASE)\r\nreturn -ENXIO;\r\nzl6100_wait(data);\r\nret = pmbus_write_word_data(client, page, reg, word);\r\ndata->access = ktime_get();\r\nreturn ret;\r\n}\r\nstatic int zl6100_write_byte(struct i2c_client *client, int page, u8 value)\r\n{\r\nconst struct pmbus_driver_info *info = pmbus_get_driver_info(client);\r\nstruct zl6100_data *data = to_zl6100_data(info);\r\nint ret;\r\nif (page > 0)\r\nreturn -ENXIO;\r\nzl6100_wait(data);\r\nret = pmbus_write_byte(client, page, value);\r\ndata->access = ktime_get();\r\nreturn ret;\r\n}\r\nstatic int zl6100_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nint ret;\r\nstruct zl6100_data *data;\r\nstruct pmbus_driver_info *info;\r\nu8 device_id[I2C_SMBUS_BLOCK_MAX + 1];\r\nconst struct i2c_device_id *mid;\r\nif (!i2c_check_functionality(client->adapter,\r\nI2C_FUNC_SMBUS_READ_WORD_DATA\r\n| I2C_FUNC_SMBUS_READ_BLOCK_DATA))\r\nreturn -ENODEV;\r\nret = i2c_smbus_read_block_data(client, ZL6100_DEVICE_ID,\r\ndevice_id);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "Failed to read device ID\n");\r\nreturn ret;\r\n}\r\ndevice_id[ret] = '\0';\r\ndev_info(&client->dev, "Device ID %s\n", device_id);\r\nmid = NULL;\r\nfor (mid = zl6100_id; mid->name[0]; mid++) {\r\nif (!strncasecmp(mid->name, device_id, strlen(mid->name)))\r\nbreak;\r\n}\r\nif (!mid->name[0]) {\r\ndev_err(&client->dev, "Unsupported device\n");\r\nreturn -ENODEV;\r\n}\r\nif (id->driver_data != mid->driver_data)\r\ndev_notice(&client->dev,\r\n"Device mismatch: Configured %s, detected %s\n",\r\nid->name, mid->name);\r\ndata = devm_kzalloc(&client->dev, sizeof(struct zl6100_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->id = mid->driver_data;\r\ndata->delay = delay;\r\ndata->access = ktime_get();\r\nzl6100_wait(data);\r\ninfo = &data->info;\r\ninfo->pages = 1;\r\ninfo->func[0] = PMBUS_HAVE_VIN | PMBUS_HAVE_STATUS_INPUT\r\n| PMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT\r\n| PMBUS_HAVE_IOUT | PMBUS_HAVE_STATUS_IOUT\r\n| PMBUS_HAVE_TEMP | PMBUS_HAVE_STATUS_TEMP;\r\nret = i2c_smbus_read_word_data(client, ZL6100_MFR_CONFIG);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret & ZL6100_MFR_XTEMP_ENABLE)\r\ninfo->func[0] |= PMBUS_HAVE_TEMP2;\r\ndata->access = ktime_get();\r\nzl6100_wait(data);\r\ninfo->read_word_data = zl6100_read_word_data;\r\ninfo->read_byte_data = zl6100_read_byte_data;\r\ninfo->write_word_data = zl6100_write_word_data;\r\ninfo->write_byte = zl6100_write_byte;\r\nreturn pmbus_do_probe(client, mid, info);\r\n}

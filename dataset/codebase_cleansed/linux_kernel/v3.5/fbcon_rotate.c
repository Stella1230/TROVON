static int fbcon_rotate_font(struct fb_info *info, struct vc_data *vc)\r\n{\r\nstruct fbcon_ops *ops = info->fbcon_par;\r\nint len, err = 0;\r\nint s_cellsize, d_cellsize, i;\r\nconst u8 *src;\r\nu8 *dst;\r\nif (vc->vc_font.data == ops->fontdata &&\r\nops->p->con_rotate == ops->cur_rotate)\r\ngoto finished;\r\nsrc = ops->fontdata = vc->vc_font.data;\r\nops->cur_rotate = ops->p->con_rotate;\r\nlen = (!ops->p->userfont) ? 256 : FNTCHARCNT(src);\r\ns_cellsize = ((vc->vc_font.width + 7)/8) *\r\nvc->vc_font.height;\r\nd_cellsize = s_cellsize;\r\nif (ops->rotate == FB_ROTATE_CW ||\r\nops->rotate == FB_ROTATE_CCW)\r\nd_cellsize = ((vc->vc_font.height + 7)/8) *\r\nvc->vc_font.width;\r\nif (info->fbops->fb_sync)\r\ninfo->fbops->fb_sync(info);\r\nif (ops->fd_size < d_cellsize * len) {\r\ndst = kmalloc(d_cellsize * len, GFP_KERNEL);\r\nif (dst == NULL) {\r\nerr = -ENOMEM;\r\ngoto finished;\r\n}\r\nops->fd_size = d_cellsize * len;\r\nkfree(ops->fontbuffer);\r\nops->fontbuffer = dst;\r\n}\r\ndst = ops->fontbuffer;\r\nmemset(dst, 0, ops->fd_size);\r\nswitch (ops->rotate) {\r\ncase FB_ROTATE_UD:\r\nfor (i = len; i--; ) {\r\nrotate_ud(src, dst, vc->vc_font.width,\r\nvc->vc_font.height);\r\nsrc += s_cellsize;\r\ndst += d_cellsize;\r\n}\r\nbreak;\r\ncase FB_ROTATE_CW:\r\nfor (i = len; i--; ) {\r\nrotate_cw(src, dst, vc->vc_font.width,\r\nvc->vc_font.height);\r\nsrc += s_cellsize;\r\ndst += d_cellsize;\r\n}\r\nbreak;\r\ncase FB_ROTATE_CCW:\r\nfor (i = len; i--; ) {\r\nrotate_ccw(src, dst, vc->vc_font.width,\r\nvc->vc_font.height);\r\nsrc += s_cellsize;\r\ndst += d_cellsize;\r\n}\r\nbreak;\r\n}\r\nfinished:\r\nreturn err;\r\n}\r\nvoid fbcon_set_rotate(struct fbcon_ops *ops)\r\n{\r\nops->rotate_font = fbcon_rotate_font;\r\nswitch(ops->rotate) {\r\ncase FB_ROTATE_CW:\r\nfbcon_rotate_cw(ops);\r\nbreak;\r\ncase FB_ROTATE_UD:\r\nfbcon_rotate_ud(ops);\r\nbreak;\r\ncase FB_ROTATE_CCW:\r\nfbcon_rotate_ccw(ops);\r\nbreak;\r\n}\r\n}

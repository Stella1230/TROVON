static inline struct ab8500_usb *phy_to_ab(struct usb_phy *x)\r\n{\r\nreturn container_of(x, struct ab8500_usb, phy);\r\n}\r\nstatic void ab8500_usb_wd_workaround(struct ab8500_usb *ab)\r\n{\r\nabx500_set_register_interruptible(ab->dev,\r\nAB8500_SYS_CTRL2_BLOCK,\r\nAB8500_MAIN_WD_CTRL_REG,\r\nAB8500_BIT_WD_CTRL_ENABLE);\r\nudelay(AB8500_WD_KICK_DELAY_US);\r\nabx500_set_register_interruptible(ab->dev,\r\nAB8500_SYS_CTRL2_BLOCK,\r\nAB8500_MAIN_WD_CTRL_REG,\r\n(AB8500_BIT_WD_CTRL_ENABLE\r\n| AB8500_BIT_WD_CTRL_KICK));\r\nif (ab->rev > 0x10)\r\nudelay(AB8500_WD_V11_DISABLE_DELAY_US);\r\nelse\r\nmsleep(AB8500_WD_V10_DISABLE_DELAY_MS);\r\nabx500_set_register_interruptible(ab->dev,\r\nAB8500_SYS_CTRL2_BLOCK,\r\nAB8500_MAIN_WD_CTRL_REG,\r\n0);\r\n}\r\nstatic void ab8500_usb_phy_ctrl(struct ab8500_usb *ab, bool sel_host,\r\nbool enable)\r\n{\r\nu8 ctrl_reg;\r\nabx500_get_register_interruptible(ab->dev,\r\nAB8500_USB,\r\nAB8500_USB_PHY_CTRL_REG,\r\n&ctrl_reg);\r\nif (sel_host) {\r\nif (enable)\r\nctrl_reg |= AB8500_BIT_PHY_CTRL_HOST_EN;\r\nelse\r\nctrl_reg &= ~AB8500_BIT_PHY_CTRL_HOST_EN;\r\n} else {\r\nif (enable)\r\nctrl_reg |= AB8500_BIT_PHY_CTRL_DEVICE_EN;\r\nelse\r\nctrl_reg &= ~AB8500_BIT_PHY_CTRL_DEVICE_EN;\r\n}\r\nabx500_set_register_interruptible(ab->dev,\r\nAB8500_USB,\r\nAB8500_USB_PHY_CTRL_REG,\r\nctrl_reg);\r\nif (enable)\r\nab8500_usb_wd_workaround(ab);\r\n}\r\nstatic int ab8500_usb_link_status_update(struct ab8500_usb *ab)\r\n{\r\nu8 reg;\r\nenum ab8500_usb_link_status lsts;\r\nvoid *v = NULL;\r\nenum usb_phy_events event;\r\nabx500_get_register_interruptible(ab->dev,\r\nAB8500_USB,\r\nAB8500_USB_LINE_STAT_REG,\r\n&reg);\r\nlsts = (reg >> 3) & 0x0F;\r\nswitch (lsts) {\r\ncase USB_LINK_NOT_CONFIGURED:\r\ncase USB_LINK_RESERVED:\r\ncase USB_LINK_NOT_VALID_LINK:\r\nab8500_usb_host_phy_dis(ab);\r\nab8500_usb_peri_phy_dis(ab);\r\nab->phy.state = OTG_STATE_B_IDLE;\r\nab->phy.otg->default_a = false;\r\nab->vbus_draw = 0;\r\nevent = USB_EVENT_NONE;\r\nbreak;\r\ncase USB_LINK_STD_HOST_NC:\r\ncase USB_LINK_STD_HOST_C_NS:\r\ncase USB_LINK_STD_HOST_C_S:\r\ncase USB_LINK_HOST_CHG_NM:\r\ncase USB_LINK_HOST_CHG_HS:\r\ncase USB_LINK_HOST_CHG_HS_CHIRP:\r\nif (ab->phy.otg->gadget) {\r\nab8500_usb_peri_phy_en(ab);\r\nv = ab->phy.otg->gadget;\r\n}\r\nevent = USB_EVENT_VBUS;\r\nbreak;\r\ncase USB_LINK_HM_IDGND:\r\nif (ab->phy.otg->host) {\r\nab8500_usb_host_phy_en(ab);\r\nv = ab->phy.otg->host;\r\n}\r\nab->phy.state = OTG_STATE_A_IDLE;\r\nab->phy.otg->default_a = true;\r\nevent = USB_EVENT_ID;\r\nbreak;\r\ncase USB_LINK_ACA_RID_A:\r\ncase USB_LINK_ACA_RID_B:\r\ncase USB_LINK_ACA_RID_C_NM:\r\ncase USB_LINK_ACA_RID_C_HS:\r\ncase USB_LINK_ACA_RID_C_HS_CHIRP:\r\ncase USB_LINK_DEDICATED_CHG:\r\nevent = USB_EVENT_CHARGER;\r\nbreak;\r\n}\r\natomic_notifier_call_chain(&ab->phy.notifier, event, v);\r\nreturn 0;\r\n}\r\nstatic void ab8500_usb_delayed_work(struct work_struct *work)\r\n{\r\nstruct ab8500_usb *ab = container_of(work, struct ab8500_usb,\r\ndwork.work);\r\nab8500_usb_link_status_update(ab);\r\n}\r\nstatic irqreturn_t ab8500_usb_v1x_common_irq(int irq, void *data)\r\n{\r\nstruct ab8500_usb *ab = (struct ab8500_usb *) data;\r\nschedule_delayed_work(&ab->dwork, ab->link_status_wait);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_usb_v1x_vbus_fall_irq(int irq, void *data)\r\n{\r\nstruct ab8500_usb *ab = (struct ab8500_usb *) data;\r\nab8500_usb_peri_phy_dis(ab);\r\nschedule_delayed_work(&ab->dwork, ab->link_status_wait);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ab8500_usb_v20_irq(int irq, void *data)\r\n{\r\nstruct ab8500_usb *ab = (struct ab8500_usb *) data;\r\nab8500_usb_link_status_update(ab);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void ab8500_usb_phy_disable_work(struct work_struct *work)\r\n{\r\nstruct ab8500_usb *ab = container_of(work, struct ab8500_usb,\r\nphy_dis_work);\r\nif (!ab->phy.otg->host)\r\nab8500_usb_host_phy_dis(ab);\r\nif (!ab->phy.otg->gadget)\r\nab8500_usb_peri_phy_dis(ab);\r\n}\r\nstatic int ab8500_usb_set_power(struct usb_phy *phy, unsigned mA)\r\n{\r\nstruct ab8500_usb *ab;\r\nif (!phy)\r\nreturn -ENODEV;\r\nab = phy_to_ab(phy);\r\nab->vbus_draw = mA;\r\nif (mA)\r\natomic_notifier_call_chain(&ab->phy.notifier,\r\nUSB_EVENT_ENUMERATED, ab->phy.otg->gadget);\r\nreturn 0;\r\n}\r\nstatic int ab8500_usb_set_suspend(struct usb_phy *x, int suspend)\r\n{\r\nreturn 0;\r\n}\r\nstatic int ab8500_usb_set_peripheral(struct usb_otg *otg,\r\nstruct usb_gadget *gadget)\r\n{\r\nstruct ab8500_usb *ab;\r\nif (!otg)\r\nreturn -ENODEV;\r\nab = phy_to_ab(otg->phy);\r\nif (!gadget) {\r\notg->gadget = NULL;\r\nschedule_work(&ab->phy_dis_work);\r\n} else {\r\notg->gadget = gadget;\r\notg->phy->state = OTG_STATE_B_IDLE;\r\nschedule_delayed_work(&ab->dwork, ab->link_status_wait);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab8500_usb_set_host(struct usb_otg *otg, struct usb_bus *host)\r\n{\r\nstruct ab8500_usb *ab;\r\nif (!otg)\r\nreturn -ENODEV;\r\nab = phy_to_ab(otg->phy);\r\nif (!host) {\r\notg->host = NULL;\r\nschedule_work(&ab->phy_dis_work);\r\n} else {\r\notg->host = host;\r\nschedule_delayed_work(&ab->dwork, ab->link_status_wait);\r\n}\r\nreturn 0;\r\n}\r\nstatic void ab8500_usb_irq_free(struct ab8500_usb *ab)\r\n{\r\nif (ab->rev < 0x20) {\r\nfree_irq(ab->irq_num_id_rise, ab);\r\nfree_irq(ab->irq_num_id_fall, ab);\r\nfree_irq(ab->irq_num_vbus_rise, ab);\r\nfree_irq(ab->irq_num_vbus_fall, ab);\r\n} else {\r\nfree_irq(ab->irq_num_link_status, ab);\r\n}\r\n}\r\nstatic int ab8500_usb_v1x_res_setup(struct platform_device *pdev,\r\nstruct ab8500_usb *ab)\r\n{\r\nint err;\r\nab->irq_num_id_rise = platform_get_irq_byname(pdev, "ID_WAKEUP_R");\r\nif (ab->irq_num_id_rise < 0) {\r\ndev_err(&pdev->dev, "ID rise irq not found\n");\r\nreturn ab->irq_num_id_rise;\r\n}\r\nerr = request_threaded_irq(ab->irq_num_id_rise, NULL,\r\nab8500_usb_v1x_common_irq,\r\nIRQF_NO_SUSPEND | IRQF_SHARED,\r\n"usb-id-rise", ab);\r\nif (err < 0) {\r\ndev_err(ab->dev, "request_irq failed for ID rise irq\n");\r\ngoto fail0;\r\n}\r\nab->irq_num_id_fall = platform_get_irq_byname(pdev, "ID_WAKEUP_F");\r\nif (ab->irq_num_id_fall < 0) {\r\ndev_err(&pdev->dev, "ID fall irq not found\n");\r\nreturn ab->irq_num_id_fall;\r\n}\r\nerr = request_threaded_irq(ab->irq_num_id_fall, NULL,\r\nab8500_usb_v1x_common_irq,\r\nIRQF_NO_SUSPEND | IRQF_SHARED,\r\n"usb-id-fall", ab);\r\nif (err < 0) {\r\ndev_err(ab->dev, "request_irq failed for ID fall irq\n");\r\ngoto fail1;\r\n}\r\nab->irq_num_vbus_rise = platform_get_irq_byname(pdev, "VBUS_DET_R");\r\nif (ab->irq_num_vbus_rise < 0) {\r\ndev_err(&pdev->dev, "VBUS rise irq not found\n");\r\nreturn ab->irq_num_vbus_rise;\r\n}\r\nerr = request_threaded_irq(ab->irq_num_vbus_rise, NULL,\r\nab8500_usb_v1x_common_irq,\r\nIRQF_NO_SUSPEND | IRQF_SHARED,\r\n"usb-vbus-rise", ab);\r\nif (err < 0) {\r\ndev_err(ab->dev, "request_irq failed for Vbus rise irq\n");\r\ngoto fail2;\r\n}\r\nab->irq_num_vbus_fall = platform_get_irq_byname(pdev, "VBUS_DET_F");\r\nif (ab->irq_num_vbus_fall < 0) {\r\ndev_err(&pdev->dev, "VBUS fall irq not found\n");\r\nreturn ab->irq_num_vbus_fall;\r\n}\r\nerr = request_threaded_irq(ab->irq_num_vbus_fall, NULL,\r\nab8500_usb_v1x_vbus_fall_irq,\r\nIRQF_NO_SUSPEND | IRQF_SHARED,\r\n"usb-vbus-fall", ab);\r\nif (err < 0) {\r\ndev_err(ab->dev, "request_irq failed for Vbus fall irq\n");\r\ngoto fail3;\r\n}\r\nreturn 0;\r\nfail3:\r\nfree_irq(ab->irq_num_vbus_rise, ab);\r\nfail2:\r\nfree_irq(ab->irq_num_id_fall, ab);\r\nfail1:\r\nfree_irq(ab->irq_num_id_rise, ab);\r\nfail0:\r\nreturn err;\r\n}\r\nstatic int ab8500_usb_v2_res_setup(struct platform_device *pdev,\r\nstruct ab8500_usb *ab)\r\n{\r\nint err;\r\nab->irq_num_link_status = platform_get_irq_byname(pdev,\r\n"USB_LINK_STATUS");\r\nif (ab->irq_num_link_status < 0) {\r\ndev_err(&pdev->dev, "Link status irq not found\n");\r\nreturn ab->irq_num_link_status;\r\n}\r\nerr = request_threaded_irq(ab->irq_num_link_status, NULL,\r\nab8500_usb_v20_irq,\r\nIRQF_NO_SUSPEND | IRQF_SHARED,\r\n"usb-link-status", ab);\r\nif (err < 0) {\r\ndev_err(ab->dev,\r\n"request_irq failed for link status irq\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit ab8500_usb_probe(struct platform_device *pdev)\r\n{\r\nstruct ab8500_usb *ab;\r\nstruct usb_otg *otg;\r\nint err;\r\nint rev;\r\nrev = abx500_get_chip_id(&pdev->dev);\r\nif (rev < 0) {\r\ndev_err(&pdev->dev, "Chip id read failed\n");\r\nreturn rev;\r\n} else if (rev < 0x10) {\r\ndev_err(&pdev->dev, "Unsupported AB8500 chip\n");\r\nreturn -ENODEV;\r\n}\r\nab = kzalloc(sizeof *ab, GFP_KERNEL);\r\nif (!ab)\r\nreturn -ENOMEM;\r\notg = kzalloc(sizeof *otg, GFP_KERNEL);\r\nif (!otg) {\r\nkfree(ab);\r\nreturn -ENOMEM;\r\n}\r\nab->dev = &pdev->dev;\r\nab->rev = rev;\r\nab->phy.dev = ab->dev;\r\nab->phy.otg = otg;\r\nab->phy.label = "ab8500";\r\nab->phy.set_suspend = ab8500_usb_set_suspend;\r\nab->phy.set_power = ab8500_usb_set_power;\r\nab->phy.state = OTG_STATE_UNDEFINED;\r\notg->phy = &ab->phy;\r\notg->set_host = ab8500_usb_set_host;\r\notg->set_peripheral = ab8500_usb_set_peripheral;\r\nplatform_set_drvdata(pdev, ab);\r\nATOMIC_INIT_NOTIFIER_HEAD(&ab->phy.notifier);\r\nINIT_DELAYED_WORK(&ab->dwork, ab8500_usb_delayed_work);\r\nINIT_WORK(&ab->phy_dis_work, ab8500_usb_phy_disable_work);\r\nif (ab->rev < 0x20) {\r\nerr = ab8500_usb_v1x_res_setup(pdev, ab);\r\nab->link_status_wait = AB8500_V1x_LINK_STAT_WAIT;\r\n} else {\r\nerr = ab8500_usb_v2_res_setup(pdev, ab);\r\n}\r\nif (err < 0)\r\ngoto fail0;\r\nerr = usb_set_transceiver(&ab->phy);\r\nif (err) {\r\ndev_err(&pdev->dev, "Can't register transceiver\n");\r\ngoto fail1;\r\n}\r\ndev_info(&pdev->dev, "AB8500 usb driver initialized\n");\r\nreturn 0;\r\nfail1:\r\nab8500_usb_irq_free(ab);\r\nfail0:\r\nkfree(otg);\r\nkfree(ab);\r\nreturn err;\r\n}\r\nstatic int __devexit ab8500_usb_remove(struct platform_device *pdev)\r\n{\r\nstruct ab8500_usb *ab = platform_get_drvdata(pdev);\r\nab8500_usb_irq_free(ab);\r\ncancel_delayed_work_sync(&ab->dwork);\r\ncancel_work_sync(&ab->phy_dis_work);\r\nusb_set_transceiver(NULL);\r\nab8500_usb_host_phy_dis(ab);\r\nab8500_usb_peri_phy_dis(ab);\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(ab->phy.otg);\r\nkfree(ab);\r\nreturn 0;\r\n}\r\nstatic int __init ab8500_usb_init(void)\r\n{\r\nreturn platform_driver_register(&ab8500_usb_driver);\r\n}\r\nstatic void __exit ab8500_usb_exit(void)\r\n{\r\nplatform_driver_unregister(&ab8500_usb_driver);\r\n}

static int w1_bq27000_read(struct device *dev, unsigned int reg)\r\n{\r\nu8 val;\r\nstruct w1_slave *sl = container_of(dev->parent, struct w1_slave, dev);\r\nmutex_lock(&sl->master->mutex);\r\nw1_write_8(sl->master, HDQ_CMD_READ | reg);\r\nval = w1_read_8(sl->master);\r\nmutex_unlock(&sl->master->mutex);\r\nreturn val;\r\n}\r\nstatic int w1_bq27000_add_slave(struct w1_slave *sl)\r\n{\r\nint ret;\r\nstruct platform_device *pdev;\r\npdev = platform_device_alloc("bq27000-battery", -1);\r\nif (!pdev) {\r\nret = -ENOMEM;\r\nreturn ret;\r\n}\r\nret = platform_device_add_data(pdev,\r\n&bq27000_battery_info,\r\nsizeof(bq27000_battery_info));\r\npdev->dev.parent = &sl->dev;\r\nret = platform_device_add(pdev);\r\nif (ret)\r\ngoto pdev_add_failed;\r\ndev_set_drvdata(&sl->dev, pdev);\r\ngoto success;\r\npdev_add_failed:\r\nplatform_device_unregister(pdev);\r\nsuccess:\r\nreturn ret;\r\n}\r\nstatic void w1_bq27000_remove_slave(struct w1_slave *sl)\r\n{\r\nstruct platform_device *pdev = dev_get_drvdata(&sl->dev);\r\nplatform_device_unregister(pdev);\r\n}\r\nstatic int __init w1_bq27000_init(void)\r\n{\r\nif (F_ID)\r\nw1_bq27000_family.fid = F_ID;\r\nreturn w1_register_family(&w1_bq27000_family);\r\n}\r\nstatic void __exit w1_bq27000_exit(void)\r\n{\r\nw1_unregister_family(&w1_bq27000_family);\r\n}

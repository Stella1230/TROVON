static int pxa2xx_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct pxa2xx_runtime_data *prtd = runtime->private_data;\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct pxa2xx_pcm_dma_params *dma;\r\nint ret;\r\ndma = snd_soc_dai_get_dma_data(rtd->cpu_dai, substream);\r\nif (!dma)\r\nreturn 0;\r\nif (prtd->params == NULL) {\r\nprtd->params = dma;\r\nret = pxa_request_dma(prtd->params->name, DMA_PRIO_LOW,\r\npxa2xx_pcm_dma_irq, substream);\r\nif (ret < 0)\r\nreturn ret;\r\nprtd->dma_ch = ret;\r\n} else if (prtd->params != dma) {\r\npxa_free_dma(prtd->dma_ch);\r\nprtd->params = dma;\r\nret = pxa_request_dma(prtd->params->name, DMA_PRIO_LOW,\r\npxa2xx_pcm_dma_irq, substream);\r\nif (ret < 0)\r\nreturn ret;\r\nprtd->dma_ch = ret;\r\n}\r\nreturn __pxa2xx_pcm_hw_params(substream, params);\r\n}\r\nstatic int pxa2xx_pcm_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct pxa2xx_runtime_data *prtd = substream->runtime->private_data;\r\n__pxa2xx_pcm_hw_free(substream);\r\nif (prtd->dma_ch >= 0) {\r\npxa_free_dma(prtd->dma_ch);\r\nprtd->dma_ch = -1;\r\nprtd->params = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_soc_pcm_new(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_card *card = rtd->card->snd_card;\r\nstruct snd_pcm *pcm = rtd->pcm;\r\nint ret = 0;\r\nif (!card->dev->dma_mask)\r\ncard->dev->dma_mask = &pxa2xx_pcm_dmamask;\r\nif (!card->dev->coherent_dma_mask)\r\ncard->dev->coherent_dma_mask = DMA_BIT_MASK(32);\r\nif (pcm->streams[SNDRV_PCM_STREAM_PLAYBACK].substream) {\r\nret = pxa2xx_pcm_preallocate_dma_buffer(pcm,\r\nSNDRV_PCM_STREAM_PLAYBACK);\r\nif (ret)\r\ngoto out;\r\n}\r\nif (pcm->streams[SNDRV_PCM_STREAM_CAPTURE].substream) {\r\nret = pxa2xx_pcm_preallocate_dma_buffer(pcm,\r\nSNDRV_PCM_STREAM_CAPTURE);\r\nif (ret)\r\ngoto out;\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nstatic int __devinit pxa2xx_soc_platform_probe(struct platform_device *pdev)\r\n{\r\nreturn snd_soc_register_platform(&pdev->dev, &pxa2xx_soc_platform);\r\n}\r\nstatic int __devexit pxa2xx_soc_platform_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_platform(&pdev->dev);\r\nreturn 0;\r\n}

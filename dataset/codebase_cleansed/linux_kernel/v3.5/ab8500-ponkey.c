static irqreturn_t ab8500_ponkey_handler(int irq, void *data)\r\n{\r\nstruct ab8500_ponkey *ponkey = data;\r\nif (irq == ponkey->irq_dbf)\r\ninput_report_key(ponkey->idev, KEY_POWER, true);\r\nelse if (irq == ponkey->irq_dbr)\r\ninput_report_key(ponkey->idev, KEY_POWER, false);\r\ninput_sync(ponkey->idev);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __devinit ab8500_ponkey_probe(struct platform_device *pdev)\r\n{\r\nstruct ab8500 *ab8500 = dev_get_drvdata(pdev->dev.parent);\r\nstruct ab8500_ponkey *ponkey;\r\nstruct input_dev *input;\r\nint irq_dbf, irq_dbr;\r\nint error;\r\nirq_dbf = platform_get_irq_byname(pdev, "ONKEY_DBF");\r\nif (irq_dbf < 0) {\r\ndev_err(&pdev->dev, "No IRQ for ONKEY_DBF, error=%d\n", irq_dbf);\r\nreturn irq_dbf;\r\n}\r\nirq_dbr = platform_get_irq_byname(pdev, "ONKEY_DBR");\r\nif (irq_dbr < 0) {\r\ndev_err(&pdev->dev, "No IRQ for ONKEY_DBR, error=%d\n", irq_dbr);\r\nreturn irq_dbr;\r\n}\r\nponkey = kzalloc(sizeof(struct ab8500_ponkey), GFP_KERNEL);\r\ninput = input_allocate_device();\r\nif (!ponkey || !input) {\r\nerror = -ENOMEM;\r\ngoto err_free_mem;\r\n}\r\nponkey->idev = input;\r\nponkey->ab8500 = ab8500;\r\nponkey->irq_dbf = irq_dbf;\r\nponkey->irq_dbr = irq_dbr;\r\ninput->name = "AB8500 POn(PowerOn) Key";\r\ninput->dev.parent = &pdev->dev;\r\ninput_set_capability(input, EV_KEY, KEY_POWER);\r\nerror = request_any_context_irq(ponkey->irq_dbf, ab8500_ponkey_handler,\r\n0, "ab8500-ponkey-dbf", ponkey);\r\nif (error < 0) {\r\ndev_err(ab8500->dev, "Failed to request dbf IRQ#%d: %d\n",\r\nponkey->irq_dbf, error);\r\ngoto err_free_mem;\r\n}\r\nerror = request_any_context_irq(ponkey->irq_dbr, ab8500_ponkey_handler,\r\n0, "ab8500-ponkey-dbr", ponkey);\r\nif (error < 0) {\r\ndev_err(ab8500->dev, "Failed to request dbr IRQ#%d: %d\n",\r\nponkey->irq_dbr, error);\r\ngoto err_free_dbf_irq;\r\n}\r\nerror = input_register_device(ponkey->idev);\r\nif (error) {\r\ndev_err(ab8500->dev, "Can't register input device: %d\n", error);\r\ngoto err_free_dbr_irq;\r\n}\r\nplatform_set_drvdata(pdev, ponkey);\r\nreturn 0;\r\nerr_free_dbr_irq:\r\nfree_irq(ponkey->irq_dbr, ponkey);\r\nerr_free_dbf_irq:\r\nfree_irq(ponkey->irq_dbf, ponkey);\r\nerr_free_mem:\r\ninput_free_device(input);\r\nkfree(ponkey);\r\nreturn error;\r\n}\r\nstatic int __devexit ab8500_ponkey_remove(struct platform_device *pdev)\r\n{\r\nstruct ab8500_ponkey *ponkey = platform_get_drvdata(pdev);\r\nfree_irq(ponkey->irq_dbf, ponkey);\r\nfree_irq(ponkey->irq_dbr, ponkey);\r\ninput_unregister_device(ponkey->idev);\r\nkfree(ponkey);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}

int valid_mountpoint(const char *mount, long magic)\r\n{\r\nstruct statfs st_fs;\r\nif (statfs(mount, &st_fs) < 0)\r\nreturn -ENOENT;\r\nelse if ((long)st_fs.f_type != magic)\r\nreturn -ENOENT;\r\nreturn 0;\r\n}\r\nconst char *find_mountpoint(const char *fstype, long magic,\r\nchar *mountpoint, int len,\r\nconst char * const *known_mountpoints)\r\n{\r\nconst char * const *ptr;\r\nchar format[128];\r\nchar type[100];\r\nFILE *fp;\r\nif (known_mountpoints) {\r\nptr = known_mountpoints;\r\nwhile (*ptr) {\r\nif (valid_mountpoint(*ptr, magic) == 0) {\r\nstrncpy(mountpoint, *ptr, len - 1);\r\nmountpoint[len-1] = 0;\r\nreturn mountpoint;\r\n}\r\nptr++;\r\n}\r\n}\r\nfp = fopen("/proc/mounts", "r");\r\nif (fp == NULL)\r\nreturn NULL;\r\nsnprintf(format, 128, "%%*s %%%ds %%99s %%*s %%*d %%*d\n", len);\r\nwhile (fscanf(fp, format, mountpoint, type) == 2) {\r\nif (strcmp(type, fstype) == 0)\r\nbreak;\r\n}\r\nfclose(fp);\r\nif (strcmp(type, fstype) != 0)\r\nreturn NULL;\r\nreturn mountpoint;\r\n}

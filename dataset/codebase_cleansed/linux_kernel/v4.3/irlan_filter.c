void irlan_filter_request(struct irlan_cb *self, struct sk_buff *skb)\r\n{\r\nIRDA_ASSERT(self != NULL, return;);\r\nIRDA_ASSERT(self->magic == IRLAN_MAGIC, return;);\r\nif ((self->provider.filter_type == IRLAN_DIRECTED) &&\r\n(self->provider.filter_operation == DYNAMIC))\r\n{\r\npr_debug("Giving peer a dynamic Ethernet address\n");\r\nself->provider.mac_address[0] = 0x40;\r\nself->provider.mac_address[1] = 0x00;\r\nself->provider.mac_address[2] = 0x00;\r\nself->provider.mac_address[3] = 0x00;\r\nif (self->provider.access_type == ACCESS_PEER) {\r\nself->provider.mac_address[4] =\r\nself->provider.send_arb_val & 0xff;\r\nself->provider.mac_address[5] =\r\n(self->provider.send_arb_val >> 8) & 0xff;\r\n} else {\r\nget_random_bytes(self->provider.mac_address+4, 1);\r\nget_random_bytes(self->provider.mac_address+5, 1);\r\n}\r\nskb->data[0] = 0x00;\r\nskb->data[1] = 0x03;\r\nirlan_insert_string_param(skb, "FILTER_MODE", "NONE");\r\nirlan_insert_short_param(skb, "MAX_ENTRY", 0x0001);\r\nirlan_insert_array_param(skb, "FILTER_ENTRY",\r\nself->provider.mac_address, 6);\r\nreturn;\r\n}\r\nif ((self->provider.filter_type == IRLAN_DIRECTED) &&\r\n(self->provider.filter_mode == FILTER))\r\n{\r\npr_debug("Directed filter on\n");\r\nskb->data[0] = 0x00;\r\nskb->data[1] = 0x00;\r\nreturn;\r\n}\r\nif ((self->provider.filter_type == IRLAN_DIRECTED) &&\r\n(self->provider.filter_mode == NONE))\r\n{\r\npr_debug("Directed filter off\n");\r\nskb->data[0] = 0x00;\r\nskb->data[1] = 0x00;\r\nreturn;\r\n}\r\nif ((self->provider.filter_type == IRLAN_BROADCAST) &&\r\n(self->provider.filter_mode == FILTER))\r\n{\r\npr_debug("Broadcast filter on\n");\r\nskb->data[0] = 0x00;\r\nskb->data[1] = 0x00;\r\nreturn;\r\n}\r\nif ((self->provider.filter_type == IRLAN_BROADCAST) &&\r\n(self->provider.filter_mode == NONE))\r\n{\r\npr_debug("Broadcast filter off\n");\r\nskb->data[0] = 0x00;\r\nskb->data[1] = 0x00;\r\nreturn;\r\n}\r\nif ((self->provider.filter_type == IRLAN_MULTICAST) &&\r\n(self->provider.filter_mode == FILTER))\r\n{\r\npr_debug("Multicast filter on\n");\r\nskb->data[0] = 0x00;\r\nskb->data[1] = 0x00;\r\nreturn;\r\n}\r\nif ((self->provider.filter_type == IRLAN_MULTICAST) &&\r\n(self->provider.filter_mode == NONE))\r\n{\r\npr_debug("Multicast filter off\n");\r\nskb->data[0] = 0x00;\r\nskb->data[1] = 0x00;\r\nreturn;\r\n}\r\nif ((self->provider.filter_type == IRLAN_MULTICAST) &&\r\n(self->provider.filter_operation == GET))\r\n{\r\npr_debug("Multicast filter get\n");\r\nskb->data[0] = 0x00;\r\nskb->data[1] = 0x02;\r\nirlan_insert_string_param(skb, "FILTER_MODE", "NONE");\r\nirlan_insert_short_param(skb, "MAX_ENTRY", 16);\r\nreturn;\r\n}\r\nskb->data[0] = 0x00;\r\nskb->data[1] = 0x00;\r\npr_debug("Not implemented!\n");\r\n}\r\nvoid irlan_check_command_param(struct irlan_cb *self, char *param, char *value)\r\n{\r\nIRDA_ASSERT(self != NULL, return;);\r\nIRDA_ASSERT(self->magic == IRLAN_MAGIC, return;);\r\npr_debug("%s, %s\n", param, value);\r\nif (strcmp(param, "MODE") == 0) {\r\nself->use_udata = TRUE;\r\nreturn;\r\n}\r\nif (strcmp(param, "FILTER_TYPE") == 0) {\r\nif (strcmp(value, "DIRECTED") == 0) {\r\nself->provider.filter_type = IRLAN_DIRECTED;\r\nreturn;\r\n}\r\nif (strcmp(value, "MULTICAST") == 0) {\r\nself->provider.filter_type = IRLAN_MULTICAST;\r\nreturn;\r\n}\r\nif (strcmp(value, "BROADCAST") == 0) {\r\nself->provider.filter_type = IRLAN_BROADCAST;\r\nreturn;\r\n}\r\n}\r\nif (strcmp(param, "FILTER_MODE") == 0) {\r\nif (strcmp(value, "ALL") == 0) {\r\nself->provider.filter_mode = ALL;\r\nreturn;\r\n}\r\nif (strcmp(value, "FILTER") == 0) {\r\nself->provider.filter_mode = FILTER;\r\nreturn;\r\n}\r\nif (strcmp(value, "NONE") == 0) {\r\nself->provider.filter_mode = FILTER;\r\nreturn;\r\n}\r\n}\r\nif (strcmp(param, "FILTER_OPERATION") == 0) {\r\nif (strcmp(value, "DYNAMIC") == 0) {\r\nself->provider.filter_operation = DYNAMIC;\r\nreturn;\r\n}\r\nif (strcmp(value, "GET") == 0) {\r\nself->provider.filter_operation = GET;\r\nreturn;\r\n}\r\n}\r\n}\r\nvoid irlan_print_filter(struct seq_file *seq, int filter_type)\r\n{\r\nstatic struct {\r\nint mask;\r\nconst char *str;\r\n} filter_mask2str[] = {\r\nMASK2STR(IRLAN_DIRECTED, "DIRECTED"),\r\nMASK2STR(IRLAN_FUNCTIONAL, "FUNCTIONAL"),\r\nMASK2STR(IRLAN_GROUP, "GROUP"),\r\nMASK2STR(IRLAN_MAC_FRAME, "MAC_FRAME"),\r\nMASK2STR(IRLAN_MULTICAST, "MULTICAST"),\r\nMASK2STR(IRLAN_BROADCAST, "BROADCAST"),\r\nMASK2STR(IRLAN_IPX_SOCKET, "IPX_SOCKET"),\r\nMASK2STR(0, NULL)\r\n}, *p;\r\nfor (p = filter_mask2str; p->str; p++) {\r\nif (filter_type & p->mask)\r\nseq_printf(seq, "%s ", p->str);\r\n}\r\nseq_putc(seq, '\n');\r\n}

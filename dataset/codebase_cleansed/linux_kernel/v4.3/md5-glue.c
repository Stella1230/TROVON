static inline void ppc_md5_clear_context(struct md5_state *sctx)\r\n{\r\nint count = sizeof(struct md5_state) >> 2;\r\nu32 *ptr = (u32 *)sctx;\r\nBUILD_BUG_ON(sizeof(struct md5_state) % 4);\r\ndo { *ptr++ = 0; } while (--count);\r\n}\r\nstatic int ppc_md5_init(struct shash_desc *desc)\r\n{\r\nstruct md5_state *sctx = shash_desc_ctx(desc);\r\nsctx->hash[0] = MD5_H0;\r\nsctx->hash[1] = MD5_H1;\r\nsctx->hash[2] = MD5_H2;\r\nsctx->hash[3] = MD5_H3;\r\nsctx->byte_count = 0;\r\nreturn 0;\r\n}\r\nstatic int ppc_md5_update(struct shash_desc *desc, const u8 *data,\r\nunsigned int len)\r\n{\r\nstruct md5_state *sctx = shash_desc_ctx(desc);\r\nconst unsigned int offset = sctx->byte_count & 0x3f;\r\nunsigned int avail = 64 - offset;\r\nconst u8 *src = data;\r\nsctx->byte_count += len;\r\nif (avail > len) {\r\nmemcpy((char *)sctx->block + offset, src, len);\r\nreturn 0;\r\n}\r\nif (offset) {\r\nmemcpy((char *)sctx->block + offset, src, avail);\r\nppc_md5_transform(sctx->hash, (const u8 *)sctx->block, 1);\r\nlen -= avail;\r\nsrc += avail;\r\n}\r\nif (len > 63) {\r\nppc_md5_transform(sctx->hash, src, len >> 6);\r\nsrc += len & ~0x3f;\r\nlen &= 0x3f;\r\n}\r\nmemcpy((char *)sctx->block, src, len);\r\nreturn 0;\r\n}\r\nstatic int ppc_md5_final(struct shash_desc *desc, u8 *out)\r\n{\r\nstruct md5_state *sctx = shash_desc_ctx(desc);\r\nconst unsigned int offset = sctx->byte_count & 0x3f;\r\nconst u8 *src = (const u8 *)sctx->block;\r\nu8 *p = (u8 *)src + offset;\r\nint padlen = 55 - offset;\r\n__le64 *pbits = (__le64 *)((char *)sctx->block + 56);\r\n__le32 *dst = (__le32 *)out;\r\n*p++ = 0x80;\r\nif (padlen < 0) {\r\nmemset(p, 0x00, padlen + sizeof (u64));\r\nppc_md5_transform(sctx->hash, src, 1);\r\np = (char *)sctx->block;\r\npadlen = 56;\r\n}\r\nmemset(p, 0, padlen);\r\n*pbits = cpu_to_le64(sctx->byte_count << 3);\r\nppc_md5_transform(sctx->hash, src, 1);\r\ndst[0] = cpu_to_le32(sctx->hash[0]);\r\ndst[1] = cpu_to_le32(sctx->hash[1]);\r\ndst[2] = cpu_to_le32(sctx->hash[2]);\r\ndst[3] = cpu_to_le32(sctx->hash[3]);\r\nppc_md5_clear_context(sctx);\r\nreturn 0;\r\n}\r\nstatic int ppc_md5_export(struct shash_desc *desc, void *out)\r\n{\r\nstruct md5_state *sctx = shash_desc_ctx(desc);\r\nmemcpy(out, sctx, sizeof(*sctx));\r\nreturn 0;\r\n}\r\nstatic int ppc_md5_import(struct shash_desc *desc, const void *in)\r\n{\r\nstruct md5_state *sctx = shash_desc_ctx(desc);\r\nmemcpy(sctx, in, sizeof(*sctx));\r\nreturn 0;\r\n}\r\nstatic int __init ppc_md5_mod_init(void)\r\n{\r\nreturn crypto_register_shash(&alg);\r\n}\r\nstatic void __exit ppc_md5_mod_fini(void)\r\n{\r\ncrypto_unregister_shash(&alg);\r\n}

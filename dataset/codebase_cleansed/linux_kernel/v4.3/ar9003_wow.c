static void ath9k_hw_set_sta_powersave(struct ath_hw *ah)\r\n{\r\nif (!ath9k_hw_mci_is_enabled(ah))\r\ngoto set;\r\nif (ar9003_mci_state(ah, MCI_STATE_GET_WLAN_PS_STATE) != MCI_PS_DISABLE)\r\nreturn;\r\nset:\r\nREG_SET_BIT(ah, AR_STA_ID1, AR_STA_ID1_PWR_SAV);\r\n}\r\nstatic void ath9k_hw_set_powermode_wow_sleep(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nath9k_hw_set_sta_powersave(ah);\r\nREG_WRITE(ah, AR_CR, AR_CR_RXD);\r\nif (!ath9k_hw_wait(ah, AR_CR, AR_CR_RXE, 0, AH_WAIT_TIMEOUT)) {\r\nath_err(common, "Failed to stop Rx DMA in 10ms AR_CR=0x%08x AR_DIAG_SW=0x%08x\n",\r\nREG_READ(ah, AR_CR), REG_READ(ah, AR_DIAG_SW));\r\nreturn;\r\n}\r\nif (AR_SREV_9462(ah) || AR_SREV_9565(ah)) {\r\nif (!REG_READ(ah, AR_MAC_PCU_GEN_TIMER_TSF_SEL))\r\nREG_CLR_BIT(ah, AR_DIRECT_CONNECT, AR_DC_TSF2_ENABLE);\r\n} else if (AR_SREV_9485(ah)){\r\nif (!(REG_READ(ah, AR_NDP2_TIMER_MODE) &\r\nAR_GEN_TIMERS2_MODE_ENABLE_MASK))\r\nREG_CLR_BIT(ah, AR_DIRECT_CONNECT, AR_DC_TSF2_ENABLE);\r\n}\r\nif (ath9k_hw_mci_is_enabled(ah))\r\nREG_WRITE(ah, AR_RTC_KEEP_AWAKE, 0x2);\r\nREG_WRITE(ah, AR_RTC_FORCE_WAKE, AR_RTC_FORCE_WAKE_ON_INT);\r\n}\r\nstatic void ath9k_wow_create_keep_alive_pattern(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu8 sta_mac_addr[ETH_ALEN], ap_mac_addr[ETH_ALEN];\r\nu32 ctl[13] = {0};\r\nu32 data_word[KAL_NUM_DATA_WORDS];\r\nu8 i;\r\nu32 wow_ka_data_word0;\r\nmemcpy(sta_mac_addr, common->macaddr, ETH_ALEN);\r\nmemcpy(ap_mac_addr, common->curbssid, ETH_ALEN);\r\nctl[0] = (KAL_FRAME_LEN | (MAX_RATE_POWER << 16));\r\nctl[1] = 0;\r\nctl[4] = 0;\r\nctl[7] = (ah->txchainmask) << 2;\r\nctl[2] = 0xf << 16;\r\nif (IS_CHAN_2GHZ(ah->curchan))\r\nctl[3] = 0x1b;\r\nelse\r\nctl[3] = 0xb;\r\nfor (i = 0; i < KAL_NUM_DESC_WORDS; i++)\r\nREG_WRITE(ah, (AR_WOW_KA_DESC_WORD2 + i * 4), ctl[i]);\r\ndata_word[0] = (KAL_FRAME_TYPE << 2) | (KAL_FRAME_SUB_TYPE << 4) |\r\n(KAL_TO_DS << 8) | (KAL_DURATION_ID << 16);\r\ndata_word[1] = (ap_mac_addr[3] << 24) | (ap_mac_addr[2] << 16) |\r\n(ap_mac_addr[1] << 8) | (ap_mac_addr[0]);\r\ndata_word[2] = (sta_mac_addr[1] << 24) | (sta_mac_addr[0] << 16) |\r\n(ap_mac_addr[5] << 8) | (ap_mac_addr[4]);\r\ndata_word[3] = (sta_mac_addr[5] << 24) | (sta_mac_addr[4] << 16) |\r\n(sta_mac_addr[3] << 8) | (sta_mac_addr[2]);\r\ndata_word[4] = (ap_mac_addr[3] << 24) | (ap_mac_addr[2] << 16) |\r\n(ap_mac_addr[1] << 8) | (ap_mac_addr[0]);\r\ndata_word[5] = (ap_mac_addr[5] << 8) | (ap_mac_addr[4]);\r\nif (AR_SREV_9462_20_OR_LATER(ah) || AR_SREV_9565(ah)) {\r\nREG_WRITE(ah, (AR_WOW_KA_DESC_WORD2 + (12 * 4)), 0);\r\nwow_ka_data_word0 = AR_WOW_TXBUF(13);\r\n} else {\r\nwow_ka_data_word0 = AR_WOW_TXBUF(12);\r\n}\r\nfor (i = 0; i < KAL_NUM_DATA_WORDS; i++)\r\nREG_WRITE(ah, (wow_ka_data_word0 + i*4), data_word[i]);\r\n}\r\nint ath9k_hw_wow_apply_pattern(struct ath_hw *ah, u8 *user_pattern,\r\nu8 *user_mask, int pattern_count,\r\nint pattern_len)\r\n{\r\nint i;\r\nu32 pattern_val, mask_val;\r\nu32 set, clr;\r\nif (pattern_count >= ah->wow.max_patterns)\r\nreturn -ENOSPC;\r\nif (pattern_count < MAX_NUM_PATTERN_LEGACY)\r\nREG_SET_BIT(ah, AR_WOW_PATTERN, BIT(pattern_count));\r\nelse\r\nREG_SET_BIT(ah, AR_MAC_PCU_WOW4, BIT(pattern_count - 8));\r\nfor (i = 0; i < MAX_PATTERN_SIZE; i += 4) {\r\nmemcpy(&pattern_val, user_pattern, 4);\r\nREG_WRITE(ah, (AR_WOW_TB_PATTERN(pattern_count) + i),\r\npattern_val);\r\nuser_pattern += 4;\r\n}\r\nfor (i = 0; i < MAX_PATTERN_MASK_SIZE; i += 4) {\r\nmemcpy(&mask_val, user_mask, 4);\r\nREG_WRITE(ah, (AR_WOW_TB_MASK(pattern_count) + i), mask_val);\r\nuser_mask += 4;\r\n}\r\nif (pattern_count < MAX_NUM_PATTERN_LEGACY)\r\nah->wow.wow_event_mask |=\r\nBIT(pattern_count + AR_WOW_PAT_FOUND_SHIFT);\r\nelse\r\nah->wow.wow_event_mask2 |=\r\nBIT((pattern_count - 8) + AR_WOW_PAT_FOUND_SHIFT);\r\nif (pattern_count < 4) {\r\nset = (pattern_len & AR_WOW_LENGTH_MAX) <<\r\nAR_WOW_LEN1_SHIFT(pattern_count);\r\nclr = AR_WOW_LENGTH1_MASK(pattern_count);\r\nREG_RMW(ah, AR_WOW_LENGTH1, set, clr);\r\n} else if (pattern_count < 8) {\r\nset = (pattern_len & AR_WOW_LENGTH_MAX) <<\r\nAR_WOW_LEN2_SHIFT(pattern_count);\r\nclr = AR_WOW_LENGTH2_MASK(pattern_count);\r\nREG_RMW(ah, AR_WOW_LENGTH2, set, clr);\r\n} else if (pattern_count < 12) {\r\nset = (pattern_len & AR_WOW_LENGTH_MAX) <<\r\nAR_WOW_LEN3_SHIFT(pattern_count);\r\nclr = AR_WOW_LENGTH3_MASK(pattern_count);\r\nREG_RMW(ah, AR_WOW_LENGTH3, set, clr);\r\n} else if (pattern_count < MAX_NUM_PATTERN) {\r\nset = (pattern_len & AR_WOW_LENGTH_MAX) <<\r\nAR_WOW_LEN4_SHIFT(pattern_count);\r\nclr = AR_WOW_LENGTH4_MASK(pattern_count);\r\nREG_RMW(ah, AR_WOW_LENGTH4, set, clr);\r\n}\r\nreturn 0;\r\n}\r\nu32 ath9k_hw_wow_wakeup(struct ath_hw *ah)\r\n{\r\nu32 wow_status = 0;\r\nu32 val = 0, rval;\r\nrval = REG_READ(ah, AR_WOW_PATTERN);\r\nval = AR_WOW_STATUS(rval);\r\nval &= ah->wow.wow_event_mask;\r\nif (val) {\r\nif (val & AR_WOW_MAGIC_PAT_FOUND)\r\nwow_status |= AH_WOW_MAGIC_PATTERN_EN;\r\nif (AR_WOW_PATTERN_FOUND(val))\r\nwow_status |= AH_WOW_USER_PATTERN_EN;\r\nif (val & AR_WOW_KEEP_ALIVE_FAIL)\r\nwow_status |= AH_WOW_LINK_CHANGE;\r\nif (val & AR_WOW_BEACON_FAIL)\r\nwow_status |= AH_WOW_BEACON_MISS;\r\n}\r\nrval = REG_READ(ah, AR_MAC_PCU_WOW4);\r\nval = AR_WOW_STATUS2(rval);\r\nval &= ah->wow.wow_event_mask2;\r\nif (val) {\r\nif (AR_WOW2_PATTERN_FOUND(val))\r\nwow_status |= AH_WOW_USER_PATTERN_EN;\r\n}\r\nREG_RMW(ah, AR_PCIE_PM_CTRL, AR_PMCTRL_WOW_PME_CLR,\r\nAR_PMCTRL_PWR_STATE_D1D3);\r\nREG_WRITE(ah, AR_WOW_PATTERN,\r\nAR_WOW_CLEAR_EVENTS(REG_READ(ah, AR_WOW_PATTERN)));\r\nREG_WRITE(ah, AR_MAC_PCU_WOW4,\r\nAR_WOW_CLEAR_EVENTS2(REG_READ(ah, AR_MAC_PCU_WOW4)));\r\nREG_WRITE(ah, AR_RSSI_THR, INIT_RSSI_THR);\r\nif (ah->is_pciexpress)\r\nath9k_hw_configpcipowersave(ah, false);\r\nif (AR_SREV_9462(ah) || AR_SREV_9565(ah) || AR_SREV_9485(ah)) {\r\nu32 dc = REG_READ(ah, AR_DIRECT_CONNECT);\r\nif (!(dc & AR_DC_TSF2_ENABLE))\r\nath9k_hw_gen_timer_start_tsf2(ah);\r\n}\r\nah->wow.wow_event_mask = 0;\r\nah->wow.wow_event_mask2 = 0;\r\nreturn wow_status;\r\n}\r\nstatic void ath9k_hw_wow_set_arwr_reg(struct ath_hw *ah)\r\n{\r\nu32 wa_reg;\r\nif (!ah->is_pciexpress)\r\nreturn;\r\nwa_reg = REG_READ(ah, AR_WA);\r\nwa_reg &= ~AR_WA_UNTIE_RESET_EN;\r\nwa_reg |= AR_WA_RESET_EN;\r\nwa_reg |= AR_WA_POR_SHORT;\r\nREG_WRITE(ah, AR_WA, wa_reg);\r\n}\r\nvoid ath9k_hw_wow_enable(struct ath_hw *ah, u32 pattern_enable)\r\n{\r\nu32 wow_event_mask;\r\nu32 keep_alive, magic_pattern, host_pm_ctrl;\r\nwow_event_mask = ah->wow.wow_event_mask;\r\nREG_SET_BIT(ah, AR_PCIE_PM_CTRL, AR_PMCTRL_HOST_PME_EN |\r\nAR_PMCTRL_PWR_PM_CTRL_ENA |\r\nAR_PMCTRL_AUX_PWR_DET |\r\nAR_PMCTRL_WOW_PME_CLR);\r\nREG_CLR_BIT(ah, AR_PCIE_PM_CTRL, AR_PMCTRL_WOW_PME_CLR);\r\nREG_SET_BIT(ah, AR_WOW_PATTERN,\r\nAR_WOW_BACK_OFF_SHIFT(AR_WOW_PAT_BACKOFF));\r\nREG_SET_BIT(ah, AR_WOW_COUNT, AR_WOW_AIFS_CNT(AR_WOW_CNT_AIFS_CNT) |\r\nAR_WOW_SLOT_CNT(AR_WOW_CNT_SLOT_CNT) |\r\nAR_WOW_KEEP_ALIVE_CNT(AR_WOW_CNT_KA_CNT));\r\nif (pattern_enable & AH_WOW_BEACON_MISS)\r\nREG_WRITE(ah, AR_WOW_BCN_TIMO, AR_WOW_BEACON_TIMO);\r\nelse\r\nREG_WRITE(ah, AR_WOW_BCN_TIMO, AR_WOW_BEACON_TIMO_MAX);\r\nif (!pattern_enable)\r\nREG_WRITE(ah, AR_WOW_KEEP_ALIVE_TIMO, AR_WOW_KEEP_ALIVE_NEVER);\r\nelse\r\nREG_WRITE(ah, AR_WOW_KEEP_ALIVE_TIMO, KAL_TIMEOUT * 32);\r\nREG_WRITE(ah, AR_WOW_KEEP_ALIVE_DELAY, KAL_DELAY * 1000);\r\nath9k_wow_create_keep_alive_pattern(ah);\r\nkeep_alive = REG_READ(ah, AR_WOW_KEEP_ALIVE);\r\nkeep_alive &= ~AR_WOW_KEEP_ALIVE_AUTO_DIS;\r\nif (pattern_enable & AH_WOW_LINK_CHANGE) {\r\nkeep_alive &= ~AR_WOW_KEEP_ALIVE_FAIL_DIS;\r\nwow_event_mask |= AR_WOW_KEEP_ALIVE_FAIL;\r\n} else {\r\nkeep_alive |= AR_WOW_KEEP_ALIVE_FAIL_DIS;\r\n}\r\nREG_WRITE(ah, AR_WOW_KEEP_ALIVE, keep_alive);\r\nREG_RMW_FIELD(ah, AR_RSSI_THR, AR_RSSI_THR_BM_THR,\r\nAR_WOW_BMISSTHRESHOLD);\r\nif (pattern_enable & AH_WOW_BEACON_MISS) {\r\nwow_event_mask |= AR_WOW_BEACON_FAIL;\r\nREG_SET_BIT(ah, AR_WOW_BCN_EN, AR_WOW_BEACON_FAIL_EN);\r\n} else {\r\nREG_CLR_BIT(ah, AR_WOW_BCN_EN, AR_WOW_BEACON_FAIL_EN);\r\n}\r\nmagic_pattern = REG_READ(ah, AR_WOW_PATTERN);\r\nmagic_pattern |= AR_WOW_MAC_INTR_EN;\r\nif (pattern_enable & AH_WOW_MAGIC_PATTERN_EN) {\r\nmagic_pattern |= AR_WOW_MAGIC_EN;\r\nwow_event_mask |= AR_WOW_MAGIC_PAT_FOUND;\r\n} else {\r\nmagic_pattern &= ~AR_WOW_MAGIC_EN;\r\n}\r\nREG_WRITE(ah, AR_WOW_PATTERN, magic_pattern);\r\nREG_WRITE(ah, AR_WOW_PATTERN_MATCH_LT_256B,\r\nAR_WOW_PATTERN_SUPPORTED);\r\nhost_pm_ctrl = REG_READ(ah, AR_PCIE_PM_CTRL);\r\nhost_pm_ctrl |= AR_PMCTRL_PWR_STATE_D1D3 |\r\nAR_PMCTRL_HOST_PME_EN |\r\nAR_PMCTRL_PWR_PM_CTRL_ENA;\r\nhost_pm_ctrl &= ~AR_PCIE_PM_CTRL_ENA;\r\nif (AR_SREV_9462(ah)) {\r\nhost_pm_ctrl &= ~AR_PMCTRL_PWR_STATE_D1D3;\r\nhost_pm_ctrl |= AR_PMCTRL_PWR_STATE_D1D3_REAL;\r\n}\r\nREG_WRITE(ah, AR_PCIE_PM_CTRL, host_pm_ctrl);\r\nREG_CLR_BIT(ah, AR_STA_ID1, AR_STA_ID1_PRESERVE_SEQNUM);\r\nREG_SET_BIT(ah, AR_PCIE_PHY_REG3, BIT(13));\r\nath9k_hw_wow_set_arwr_reg(ah);\r\nif (ath9k_hw_mci_is_enabled(ah))\r\nREG_WRITE(ah, AR_RTC_KEEP_AWAKE, 0x2);\r\nREG_CLR_BIT(ah, AR_PCU_MISC_MODE3, BIT(5));\r\nath9k_hw_set_powermode_wow_sleep(ah);\r\nah->wow.wow_event_mask = wow_event_mask;\r\n}

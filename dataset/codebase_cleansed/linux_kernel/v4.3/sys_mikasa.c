static inline void\r\nmikasa_update_irq_hw(int mask)\r\n{\r\noutw(mask, 0x536);\r\n}\r\nstatic inline void\r\nmikasa_enable_irq(struct irq_data *d)\r\n{\r\nmikasa_update_irq_hw(cached_irq_mask |= 1 << (d->irq - 16));\r\n}\r\nstatic void\r\nmikasa_disable_irq(struct irq_data *d)\r\n{\r\nmikasa_update_irq_hw(cached_irq_mask &= ~(1 << (d->irq - 16)));\r\n}\r\nstatic void\r\nmikasa_device_interrupt(unsigned long vector)\r\n{\r\nunsigned long pld;\r\nunsigned int i;\r\npld = (((~inw(0x534) & 0x0000ffffUL) << 16)\r\n| (((unsigned long) inb(0xa0)) << 8)\r\n| inb(0x20));\r\nwhile (pld) {\r\ni = ffz(~pld);\r\npld &= pld - 1;\r\nif (i < 16) {\r\nisa_device_interrupt(vector);\r\n} else {\r\nhandle_irq(i);\r\n}\r\n}\r\n}\r\nstatic void __init\r\nmikasa_init_irq(void)\r\n{\r\nlong i;\r\nif (alpha_using_srm)\r\nalpha_mv.device_interrupt = srm_device_interrupt;\r\nmikasa_update_irq_hw(0);\r\nfor (i = 16; i < 32; ++i) {\r\nirq_set_chip_and_handler(i, &mikasa_irq_type,\r\nhandle_level_irq);\r\nirq_set_status_flags(i, IRQ_LEVEL);\r\n}\r\ninit_i8259a_irqs();\r\ncommon_init_isa_dma();\r\n}\r\nstatic int __init\r\nmikasa_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstatic char irq_tab[8][5] __initdata = {\r\n{16+12, 16+12, 16+12, 16+12, 16+12},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ -1, -1, -1, -1, -1},\r\n{ 16+0, 16+0, 16+1, 16+2, 16+3},\r\n{ 16+4, 16+4, 16+5, 16+6, 16+7},\r\n{ 16+8, 16+8, 16+9, 16+10, 16+11},\r\n};\r\nconst long min_idsel = 6, max_idsel = 13, irqs_per_slot = 5;\r\nreturn COMMON_TABLE_LOOKUP;\r\n}\r\nstatic void\r\nmikasa_apecs_machine_check(unsigned long vector, unsigned long la_ptr)\r\n{\r\n#define MCHK_NO_DEVSEL 0x205U\r\n#define MCHK_NO_TABT 0x204U\r\nstruct el_common *mchk_header;\r\nunsigned int code;\r\nmchk_header = (struct el_common *)la_ptr;\r\nmb();\r\nmb();\r\ndraina();\r\napecs_pci_clr_err();\r\nwrmces(0x7);\r\nmb();\r\ncode = mchk_header->code;\r\nprocess_mcheck_info(vector, la_ptr, "MIKASA APECS",\r\n(mcheck_expected(0)\r\n&& (code == MCHK_NO_DEVSEL\r\n|| code == MCHK_NO_TABT)));\r\n}

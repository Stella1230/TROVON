static u32 rcar_du_plane_read(struct rcar_du_group *rgrp,\r\nunsigned int index, u32 reg)\r\n{\r\nreturn rcar_du_read(rgrp->dev,\r\nrgrp->mmio_offset + index * PLANE_OFF + reg);\r\n}\r\nstatic void rcar_du_plane_write(struct rcar_du_group *rgrp,\r\nunsigned int index, u32 reg, u32 data)\r\n{\r\nrcar_du_write(rgrp->dev, rgrp->mmio_offset + index * PLANE_OFF + reg,\r\ndata);\r\n}\r\nstatic void rcar_du_plane_setup_fb(struct rcar_du_plane *plane)\r\n{\r\nstruct rcar_du_plane_state *state =\r\nto_rcar_plane_state(plane->plane.state);\r\nstruct drm_framebuffer *fb = plane->plane.state->fb;\r\nstruct rcar_du_group *rgrp = plane->group;\r\nunsigned int src_x = state->state.src_x >> 16;\r\nunsigned int src_y = state->state.src_y >> 16;\r\nunsigned int index = state->hwindex;\r\nstruct drm_gem_cma_object *gem;\r\nbool interlaced;\r\nu32 mwr;\r\ninterlaced = state->state.crtc->state->adjusted_mode.flags\r\n& DRM_MODE_FLAG_INTERLACE;\r\nif (state->format->planes == 2)\r\nmwr = fb->pitches[0];\r\nelse\r\nmwr = fb->pitches[0] * 8 / state->format->bpp;\r\nif (interlaced && state->format->bpp == 32)\r\nmwr *= 2;\r\nrcar_du_plane_write(rgrp, index, PnMWR, mwr);\r\nrcar_du_plane_write(rgrp, index, PnSPXR, src_x);\r\nrcar_du_plane_write(rgrp, index, PnSPYR, src_y *\r\n(!interlaced && state->format->bpp == 32 ? 2 : 1));\r\ngem = drm_fb_cma_get_gem_obj(fb, 0);\r\nrcar_du_plane_write(rgrp, index, PnDSA0R, gem->paddr + fb->offsets[0]);\r\nif (state->format->planes == 2) {\r\nindex = (index + 1) % 8;\r\nrcar_du_plane_write(rgrp, index, PnMWR, fb->pitches[0]);\r\nrcar_du_plane_write(rgrp, index, PnSPXR, src_x);\r\nrcar_du_plane_write(rgrp, index, PnSPYR, src_y *\r\n(state->format->bpp == 16 ? 2 : 1) / 2);\r\ngem = drm_fb_cma_get_gem_obj(fb, 1);\r\nrcar_du_plane_write(rgrp, index, PnDSA0R,\r\ngem->paddr + fb->offsets[1]);\r\n}\r\n}\r\nstatic void rcar_du_plane_setup_mode(struct rcar_du_plane *plane,\r\nunsigned int index)\r\n{\r\nstruct rcar_du_plane_state *state =\r\nto_rcar_plane_state(plane->plane.state);\r\nstruct rcar_du_group *rgrp = plane->group;\r\nu32 colorkey;\r\nu32 pnmr;\r\nif (state->format->fourcc != DRM_FORMAT_XRGB1555)\r\nrcar_du_plane_write(rgrp, index, PnALPHAR, PnALPHAR_ABIT_0);\r\nelse\r\nrcar_du_plane_write(rgrp, index, PnALPHAR,\r\nPnALPHAR_ABIT_X | state->alpha);\r\npnmr = PnMR_BM_MD | state->format->pnmr;\r\nif ((state->colorkey & RCAR_DU_COLORKEY_MASK) == RCAR_DU_COLORKEY_NONE)\r\npnmr |= PnMR_SPIM_TP_OFF;\r\nif (state->format->fourcc == DRM_FORMAT_YUYV)\r\npnmr |= PnMR_YCDF_YUYV;\r\nrcar_du_plane_write(rgrp, index, PnMR, pnmr);\r\nswitch (state->format->fourcc) {\r\ncase DRM_FORMAT_RGB565:\r\ncolorkey = ((state->colorkey & 0xf80000) >> 8)\r\n| ((state->colorkey & 0x00fc00) >> 5)\r\n| ((state->colorkey & 0x0000f8) >> 3);\r\nrcar_du_plane_write(rgrp, index, PnTC2R, colorkey);\r\nbreak;\r\ncase DRM_FORMAT_ARGB1555:\r\ncase DRM_FORMAT_XRGB1555:\r\ncolorkey = ((state->colorkey & 0xf80000) >> 9)\r\n| ((state->colorkey & 0x00f800) >> 6)\r\n| ((state->colorkey & 0x0000f8) >> 3);\r\nrcar_du_plane_write(rgrp, index, PnTC2R, colorkey);\r\nbreak;\r\ncase DRM_FORMAT_XRGB8888:\r\ncase DRM_FORMAT_ARGB8888:\r\nrcar_du_plane_write(rgrp, index, PnTC3R,\r\nPnTC3R_CODE | (state->colorkey & 0xffffff));\r\nbreak;\r\n}\r\n}\r\nstatic void __rcar_du_plane_setup(struct rcar_du_plane *plane,\r\nunsigned int index)\r\n{\r\nstruct rcar_du_plane_state *state =\r\nto_rcar_plane_state(plane->plane.state);\r\nstruct rcar_du_group *rgrp = plane->group;\r\nu32 ddcr2 = PnDDCR2_CODE;\r\nu32 ddcr4;\r\nddcr4 = rcar_du_plane_read(rgrp, index, PnDDCR4);\r\nddcr4 &= ~PnDDCR4_EDF_MASK;\r\nddcr4 |= state->format->edf | PnDDCR4_CODE;\r\nrcar_du_plane_setup_mode(plane, index);\r\nif (state->format->planes == 2) {\r\nif (state->hwindex != index) {\r\nif (state->format->fourcc == DRM_FORMAT_NV12 ||\r\nstate->format->fourcc == DRM_FORMAT_NV21)\r\nddcr2 |= PnDDCR2_Y420;\r\nif (state->format->fourcc == DRM_FORMAT_NV21)\r\nddcr2 |= PnDDCR2_NV21;\r\nddcr2 |= PnDDCR2_DIVU;\r\n} else {\r\nddcr2 |= PnDDCR2_DIVY;\r\n}\r\n}\r\nrcar_du_plane_write(rgrp, index, PnDDCR2, ddcr2);\r\nrcar_du_plane_write(rgrp, index, PnDDCR4, ddcr4);\r\nrcar_du_plane_write(rgrp, index, PnDSXR, plane->plane.state->crtc_w);\r\nrcar_du_plane_write(rgrp, index, PnDSYR, plane->plane.state->crtc_h);\r\nrcar_du_plane_write(rgrp, index, PnDPXR, plane->plane.state->crtc_x);\r\nrcar_du_plane_write(rgrp, index, PnDPYR, plane->plane.state->crtc_y);\r\nrcar_du_plane_write(rgrp, index, PnWASPR, 0);\r\nrcar_du_plane_write(rgrp, index, PnWAMWR, 4095);\r\nrcar_du_plane_write(rgrp, index, PnBTR, 0);\r\nrcar_du_plane_write(rgrp, index, PnMLR, 0);\r\n}\r\nvoid rcar_du_plane_setup(struct rcar_du_plane *plane)\r\n{\r\nstruct rcar_du_plane_state *state =\r\nto_rcar_plane_state(plane->plane.state);\r\n__rcar_du_plane_setup(plane, state->hwindex);\r\nif (state->format->planes == 2)\r\n__rcar_du_plane_setup(plane, (state->hwindex + 1) % 8);\r\nrcar_du_plane_setup_fb(plane);\r\n}\r\nstatic int rcar_du_plane_atomic_check(struct drm_plane *plane,\r\nstruct drm_plane_state *state)\r\n{\r\nstruct rcar_du_plane_state *rstate = to_rcar_plane_state(state);\r\nstruct rcar_du_plane *rplane = to_rcar_plane(plane);\r\nstruct rcar_du_device *rcdu = rplane->group->dev;\r\nif (!state->fb || !state->crtc) {\r\nrstate->format = NULL;\r\nreturn 0;\r\n}\r\nif (state->src_w >> 16 != state->crtc_w ||\r\nstate->src_h >> 16 != state->crtc_h) {\r\ndev_dbg(rcdu->dev, "%s: scaling not supported\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nrstate->format = rcar_du_format_info(state->fb->pixel_format);\r\nif (rstate->format == NULL) {\r\ndev_dbg(rcdu->dev, "%s: unsupported format %08x\n", __func__,\r\nstate->fb->pixel_format);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void rcar_du_plane_atomic_update(struct drm_plane *plane,\r\nstruct drm_plane_state *old_state)\r\n{\r\nstruct rcar_du_plane *rplane = to_rcar_plane(plane);\r\nif (plane->state->crtc)\r\nrcar_du_plane_setup(rplane);\r\n}\r\nstatic void rcar_du_plane_reset(struct drm_plane *plane)\r\n{\r\nstruct rcar_du_plane_state *state;\r\nif (plane->state && plane->state->fb)\r\ndrm_framebuffer_unreference(plane->state->fb);\r\nkfree(plane->state);\r\nplane->state = NULL;\r\nstate = kzalloc(sizeof(*state), GFP_KERNEL);\r\nif (state == NULL)\r\nreturn;\r\nstate->hwindex = -1;\r\nstate->alpha = 255;\r\nstate->colorkey = RCAR_DU_COLORKEY_NONE;\r\nstate->zpos = plane->type == DRM_PLANE_TYPE_PRIMARY ? 0 : 1;\r\nplane->state = &state->state;\r\nplane->state->plane = plane;\r\n}\r\nstatic struct drm_plane_state *\r\nrcar_du_plane_atomic_duplicate_state(struct drm_plane *plane)\r\n{\r\nstruct rcar_du_plane_state *state;\r\nstruct rcar_du_plane_state *copy;\r\nif (WARN_ON(!plane->state))\r\nreturn NULL;\r\nstate = to_rcar_plane_state(plane->state);\r\ncopy = kmemdup(state, sizeof(*state), GFP_KERNEL);\r\nif (copy == NULL)\r\nreturn NULL;\r\n__drm_atomic_helper_plane_duplicate_state(plane, &copy->state);\r\nreturn &copy->state;\r\n}\r\nstatic void rcar_du_plane_atomic_destroy_state(struct drm_plane *plane,\r\nstruct drm_plane_state *state)\r\n{\r\n__drm_atomic_helper_plane_destroy_state(plane, state);\r\nkfree(to_rcar_plane_state(state));\r\n}\r\nstatic int rcar_du_plane_atomic_set_property(struct drm_plane *plane,\r\nstruct drm_plane_state *state,\r\nstruct drm_property *property,\r\nuint64_t val)\r\n{\r\nstruct rcar_du_plane_state *rstate = to_rcar_plane_state(state);\r\nstruct rcar_du_device *rcdu = to_rcar_plane(plane)->group->dev;\r\nif (property == rcdu->props.alpha)\r\nrstate->alpha = val;\r\nelse if (property == rcdu->props.colorkey)\r\nrstate->colorkey = val;\r\nelse if (property == rcdu->props.zpos)\r\nrstate->zpos = val;\r\nelse\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int rcar_du_plane_atomic_get_property(struct drm_plane *plane,\r\nconst struct drm_plane_state *state, struct drm_property *property,\r\nuint64_t *val)\r\n{\r\nconst struct rcar_du_plane_state *rstate =\r\ncontainer_of(state, const struct rcar_du_plane_state, state);\r\nstruct rcar_du_device *rcdu = to_rcar_plane(plane)->group->dev;\r\nif (property == rcdu->props.alpha)\r\n*val = rstate->alpha;\r\nelse if (property == rcdu->props.colorkey)\r\n*val = rstate->colorkey;\r\nelse if (property == rcdu->props.zpos)\r\n*val = rstate->zpos;\r\nelse\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nint rcar_du_planes_init(struct rcar_du_group *rgrp)\r\n{\r\nstruct rcar_du_device *rcdu = rgrp->dev;\r\nunsigned int crtcs;\r\nunsigned int i;\r\nint ret;\r\nrgrp->num_planes = rgrp->num_crtcs + 7;\r\ncrtcs = ((1 << rcdu->num_crtcs) - 1) & (3 << (2 * rgrp->index));\r\nfor (i = 0; i < rgrp->num_planes; ++i) {\r\nenum drm_plane_type type = i < rgrp->num_crtcs\r\n? DRM_PLANE_TYPE_PRIMARY\r\n: DRM_PLANE_TYPE_OVERLAY;\r\nstruct rcar_du_plane *plane = &rgrp->planes[i];\r\nplane->group = rgrp;\r\nret = drm_universal_plane_init(rcdu->ddev, &plane->plane, crtcs,\r\n&rcar_du_plane_funcs, formats,\r\nARRAY_SIZE(formats), type);\r\nif (ret < 0)\r\nreturn ret;\r\ndrm_plane_helper_add(&plane->plane,\r\n&rcar_du_plane_helper_funcs);\r\nif (type == DRM_PLANE_TYPE_PRIMARY)\r\ncontinue;\r\ndrm_object_attach_property(&plane->plane.base,\r\nrcdu->props.alpha, 255);\r\ndrm_object_attach_property(&plane->plane.base,\r\nrcdu->props.colorkey,\r\nRCAR_DU_COLORKEY_NONE);\r\ndrm_object_attach_property(&plane->plane.base,\r\nrcdu->props.zpos, 1);\r\n}\r\nreturn 0;\r\n}

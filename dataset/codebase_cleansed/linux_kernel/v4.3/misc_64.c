static int prom_service_exists(const char *service_name)\r\n{\r\nunsigned long args[5];\r\nargs[0] = (unsigned long) "test";\r\nargs[1] = 1;\r\nargs[2] = 1;\r\nargs[3] = (unsigned long) service_name;\r\nargs[4] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nif (args[4])\r\nreturn 0;\r\nreturn 1;\r\n}\r\nvoid prom_sun4v_guest_soft_state(void)\r\n{\r\nconst char *svc = "SUNW,soft-state-supported";\r\nunsigned long args[3];\r\nif (!prom_service_exists(svc))\r\nreturn;\r\nargs[0] = (unsigned long) svc;\r\nargs[1] = 0;\r\nargs[2] = 0;\r\np1275_cmd_direct(args);\r\n}\r\nvoid prom_reboot(const char *bcommand)\r\n{\r\nunsigned long args[4];\r\n#ifdef CONFIG_SUN_LDOMS\r\nif (ldom_domaining_enabled)\r\nldom_reboot(bcommand);\r\n#endif\r\nargs[0] = (unsigned long) "boot";\r\nargs[1] = 1;\r\nargs[2] = 0;\r\nargs[3] = (unsigned long) bcommand;\r\np1275_cmd_direct(args);\r\n}\r\nvoid prom_feval(const char *fstring)\r\n{\r\nunsigned long args[5];\r\nif (!fstring || fstring[0] == 0)\r\nreturn;\r\nargs[0] = (unsigned long) "interpret";\r\nargs[1] = 1;\r\nargs[2] = 1;\r\nargs[3] = (unsigned long) fstring;\r\nargs[4] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\n}\r\nvoid prom_cmdline(void)\r\n{\r\nunsigned long args[3];\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\n#ifdef CONFIG_SMP\r\nsmp_capture();\r\n#endif\r\nargs[0] = (unsigned long) "enter";\r\nargs[1] = 0;\r\nargs[2] = 0;\r\np1275_cmd_direct(args);\r\n#ifdef CONFIG_SMP\r\nsmp_release();\r\n#endif\r\nlocal_irq_restore(flags);\r\n}\r\nvoid notrace prom_halt(void)\r\n{\r\nunsigned long args[3];\r\n#ifdef CONFIG_SUN_LDOMS\r\nif (ldom_domaining_enabled)\r\nldom_power_off();\r\n#endif\r\nagain:\r\nargs[0] = (unsigned long) "exit";\r\nargs[1] = 0;\r\nargs[2] = 0;\r\np1275_cmd_direct(args);\r\ngoto again;\r\n}\r\nvoid prom_halt_power_off(void)\r\n{\r\nunsigned long args[3];\r\n#ifdef CONFIG_SUN_LDOMS\r\nif (ldom_domaining_enabled)\r\nldom_power_off();\r\n#endif\r\nargs[0] = (unsigned long) "SUNW,power-off";\r\nargs[1] = 0;\r\nargs[2] = 0;\r\np1275_cmd_direct(args);\r\nprom_halt();\r\n}\r\nunsigned char prom_get_idprom(char *idbuf, int num_bytes)\r\n{\r\nint len;\r\nlen = prom_getproplen(prom_root_node, "idprom");\r\nif ((len >num_bytes) || (len == -1))\r\nreturn 0xff;\r\nif (!prom_getproperty(prom_root_node, "idprom", idbuf, num_bytes))\r\nreturn idbuf[0];\r\nreturn 0xff;\r\n}\r\nint prom_get_mmu_ihandle(void)\r\n{\r\nphandle node;\r\nint ret;\r\nif (prom_mmu_ihandle_cache != 0)\r\nreturn prom_mmu_ihandle_cache;\r\nnode = prom_finddevice(prom_chosen_path);\r\nret = prom_getint(node, prom_mmu_name);\r\nif (ret == -1 || ret == 0)\r\nprom_mmu_ihandle_cache = -1;\r\nelse\r\nprom_mmu_ihandle_cache = ret;\r\nreturn ret;\r\n}\r\nstatic int prom_get_memory_ihandle(void)\r\n{\r\nstatic int memory_ihandle_cache;\r\nphandle node;\r\nint ret;\r\nif (memory_ihandle_cache != 0)\r\nreturn memory_ihandle_cache;\r\nnode = prom_finddevice("/chosen");\r\nret = prom_getint(node, "memory");\r\nif (ret == -1 || ret == 0)\r\nmemory_ihandle_cache = -1;\r\nelse\r\nmemory_ihandle_cache = ret;\r\nreturn ret;\r\n}\r\nstatic long tlb_load(const char *type, unsigned long index,\r\nunsigned long tte_data, unsigned long vaddr)\r\n{\r\nunsigned long args[9];\r\nargs[0] = (unsigned long) prom_callmethod_name;\r\nargs[1] = 5;\r\nargs[2] = 1;\r\nargs[3] = (unsigned long) type;\r\nargs[4] = (unsigned int) prom_get_mmu_ihandle();\r\nargs[5] = vaddr;\r\nargs[6] = tte_data;\r\nargs[7] = index;\r\nargs[8] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nreturn (long) args[8];\r\n}\r\nlong prom_itlb_load(unsigned long index,\r\nunsigned long tte_data,\r\nunsigned long vaddr)\r\n{\r\nreturn tlb_load("SUNW,itlb-load", index, tte_data, vaddr);\r\n}\r\nlong prom_dtlb_load(unsigned long index,\r\nunsigned long tte_data,\r\nunsigned long vaddr)\r\n{\r\nreturn tlb_load("SUNW,dtlb-load", index, tte_data, vaddr);\r\n}\r\nint prom_map(int mode, unsigned long size,\r\nunsigned long vaddr, unsigned long paddr)\r\n{\r\nunsigned long args[11];\r\nint ret;\r\nargs[0] = (unsigned long) prom_callmethod_name;\r\nargs[1] = 7;\r\nargs[2] = 1;\r\nargs[3] = (unsigned long) prom_map_name;\r\nargs[4] = (unsigned int) prom_get_mmu_ihandle();\r\nargs[5] = (unsigned int) mode;\r\nargs[6] = size;\r\nargs[7] = vaddr;\r\nargs[8] = 0;\r\nargs[9] = paddr;\r\nargs[10] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nret = (int) args[10];\r\nif (ret == 0)\r\nret = -1;\r\nreturn ret;\r\n}\r\nvoid prom_unmap(unsigned long size, unsigned long vaddr)\r\n{\r\nunsigned long args[7];\r\nargs[0] = (unsigned long) prom_callmethod_name;\r\nargs[1] = 4;\r\nargs[2] = 0;\r\nargs[3] = (unsigned long) prom_unmap_name;\r\nargs[4] = (unsigned int) prom_get_mmu_ihandle();\r\nargs[5] = size;\r\nargs[6] = vaddr;\r\np1275_cmd_direct(args);\r\n}\r\nint prom_retain(const char *name, unsigned long size,\r\nunsigned long align, unsigned long *paddr)\r\n{\r\nunsigned long args[11];\r\nargs[0] = (unsigned long) prom_callmethod_name;\r\nargs[1] = 5;\r\nargs[2] = 3;\r\nargs[3] = (unsigned long) "SUNW,retain";\r\nargs[4] = (unsigned int) prom_get_memory_ihandle();\r\nargs[5] = align;\r\nargs[6] = size;\r\nargs[7] = (unsigned long) name;\r\nargs[8] = (unsigned long) -1;\r\nargs[9] = (unsigned long) -1;\r\nargs[10] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nif (args[8])\r\nreturn (int) args[8];\r\n*paddr = args[10];\r\nreturn 0;\r\n}\r\nint prom_getunumber(int syndrome_code,\r\nunsigned long phys_addr,\r\nchar *buf, int buflen)\r\n{\r\nunsigned long args[12];\r\nargs[0] = (unsigned long) prom_callmethod_name;\r\nargs[1] = 7;\r\nargs[2] = 2;\r\nargs[3] = (unsigned long) "SUNW,get-unumber";\r\nargs[4] = (unsigned int) prom_get_memory_ihandle();\r\nargs[5] = buflen;\r\nargs[6] = (unsigned long) buf;\r\nargs[7] = 0;\r\nargs[8] = phys_addr;\r\nargs[9] = (unsigned int) syndrome_code;\r\nargs[10] = (unsigned long) -1;\r\nargs[11] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nreturn (int) args[10];\r\n}\r\nvoid prom_sleepself(void)\r\n{\r\nunsigned long args[3];\r\nargs[0] = (unsigned long) "SUNW,sleep-self";\r\nargs[1] = 0;\r\nargs[2] = 0;\r\np1275_cmd_direct(args);\r\n}\r\nint prom_sleepsystem(void)\r\n{\r\nunsigned long args[4];\r\nargs[0] = (unsigned long) "SUNW,sleep-system";\r\nargs[1] = 0;\r\nargs[2] = 1;\r\nargs[3] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nreturn (int) args[3];\r\n}\r\nint prom_wakeupsystem(void)\r\n{\r\nunsigned long args[4];\r\nargs[0] = (unsigned long) "SUNW,wakeup-system";\r\nargs[1] = 0;\r\nargs[2] = 1;\r\nargs[3] = (unsigned long) -1;\r\np1275_cmd_direct(args);\r\nreturn (int) args[3];\r\n}\r\nvoid prom_startcpu(int cpunode, unsigned long pc, unsigned long arg)\r\n{\r\nunsigned long args[6];\r\nargs[0] = (unsigned long) "SUNW,start-cpu";\r\nargs[1] = 3;\r\nargs[2] = 0;\r\nargs[3] = (unsigned int) cpunode;\r\nargs[4] = pc;\r\nargs[5] = arg;\r\np1275_cmd_direct(args);\r\n}\r\nvoid prom_startcpu_cpuid(int cpuid, unsigned long pc, unsigned long arg)\r\n{\r\nunsigned long args[6];\r\nargs[0] = (unsigned long) "SUNW,start-cpu-by-cpuid";\r\nargs[1] = 3;\r\nargs[2] = 0;\r\nargs[3] = (unsigned int) cpuid;\r\nargs[4] = pc;\r\nargs[5] = arg;\r\np1275_cmd_direct(args);\r\n}\r\nvoid prom_stopcpu_cpuid(int cpuid)\r\n{\r\nunsigned long args[4];\r\nargs[0] = (unsigned long) "SUNW,stop-cpu-by-cpuid";\r\nargs[1] = 1;\r\nargs[2] = 0;\r\nargs[3] = (unsigned int) cpuid;\r\np1275_cmd_direct(args);\r\n}\r\nvoid prom_stopself(void)\r\n{\r\nunsigned long args[3];\r\nargs[0] = (unsigned long) "SUNW,stop-self";\r\nargs[1] = 0;\r\nargs[2] = 0;\r\np1275_cmd_direct(args);\r\n}\r\nvoid prom_idleself(void)\r\n{\r\nunsigned long args[3];\r\nargs[0] = (unsigned long) "SUNW,idle-self";\r\nargs[1] = 0;\r\nargs[2] = 0;\r\np1275_cmd_direct(args);\r\n}\r\nvoid prom_resumecpu(int cpunode)\r\n{\r\nunsigned long args[4];\r\nargs[0] = (unsigned long) "SUNW,resume-cpu";\r\nargs[1] = 1;\r\nargs[2] = 0;\r\nargs[3] = (unsigned int) cpunode;\r\np1275_cmd_direct(args);\r\n}

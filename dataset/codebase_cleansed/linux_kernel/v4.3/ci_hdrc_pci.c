static int ci_hdrc_pci_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nstruct ci_hdrc_platform_data *platdata = (void *)id->driver_data;\r\nstruct ci_hdrc_pci *ci;\r\nstruct resource res[3];\r\nint retval = 0, nres = 2;\r\nif (!platdata) {\r\ndev_err(&pdev->dev, "device doesn't provide driver data\n");\r\nreturn -ENODEV;\r\n}\r\nci = devm_kzalloc(&pdev->dev, sizeof(*ci), GFP_KERNEL);\r\nif (!ci)\r\nreturn -ENOMEM;\r\nretval = pcim_enable_device(pdev);\r\nif (retval)\r\nreturn retval;\r\nif (!pdev->irq) {\r\ndev_err(&pdev->dev, "No IRQ, check BIOS/PCI setup!");\r\nreturn -ENODEV;\r\n}\r\npci_set_master(pdev);\r\npci_try_set_mwi(pdev);\r\nci->phy = usb_phy_generic_register();\r\nif (!ci->phy)\r\nreturn -ENOMEM;\r\nmemset(res, 0, sizeof(res));\r\nres[0].start = pci_resource_start(pdev, 0);\r\nres[0].end = pci_resource_end(pdev, 0);\r\nres[0].flags = IORESOURCE_MEM;\r\nres[1].start = pdev->irq;\r\nres[1].flags = IORESOURCE_IRQ;\r\nci->ci = ci_hdrc_add_device(&pdev->dev, res, nres, platdata);\r\nif (IS_ERR(ci->ci)) {\r\ndev_err(&pdev->dev, "ci_hdrc_add_device failed!\n");\r\nusb_phy_generic_unregister(ci->phy);\r\nreturn PTR_ERR(ci->ci);\r\n}\r\npci_set_drvdata(pdev, ci);\r\nreturn 0;\r\n}\r\nstatic void ci_hdrc_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct ci_hdrc_pci *ci = pci_get_drvdata(pdev);\r\nci_hdrc_remove_device(ci->ci);\r\nusb_phy_generic_unregister(ci->phy);\r\n}

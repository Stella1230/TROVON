static inline void xlr_i2c_wreg(u32 __iomem *base, unsigned int reg, u32 val)\r\n{\r\n__raw_writel(val, base + reg);\r\n}\r\nstatic inline u32 xlr_i2c_rdreg(u32 __iomem *base, unsigned int reg)\r\n{\r\nreturn __raw_readl(base + reg);\r\n}\r\nstatic int xlr_i2c_tx(struct xlr_i2c_private *priv, u16 len,\r\nu8 *buf, u16 addr)\r\n{\r\nstruct i2c_adapter *adap = &priv->adap;\r\nunsigned long timeout, stoptime, checktime;\r\nu32 i2c_status;\r\nint pos, timedout;\r\nu8 offset, byte;\r\noffset = buf[0];\r\nxlr_i2c_wreg(priv->iobase, XLR_I2C_ADDR, offset);\r\nxlr_i2c_wreg(priv->iobase, XLR_I2C_DEVADDR, addr);\r\nxlr_i2c_wreg(priv->iobase, XLR_I2C_CFG, XLR_I2C_CFG_ADDR);\r\nxlr_i2c_wreg(priv->iobase, XLR_I2C_BYTECNT, len - 1);\r\ntimeout = msecs_to_jiffies(XLR_I2C_TIMEOUT);\r\nstoptime = jiffies + timeout;\r\ntimedout = 0;\r\npos = 1;\r\nretry:\r\nif (len == 1) {\r\nxlr_i2c_wreg(priv->iobase, XLR_I2C_STARTXFR,\r\nXLR_I2C_STARTXFR_ND);\r\n} else {\r\nxlr_i2c_wreg(priv->iobase, XLR_I2C_DATAOUT, buf[pos]);\r\nxlr_i2c_wreg(priv->iobase, XLR_I2C_STARTXFR,\r\nXLR_I2C_STARTXFR_WR);\r\n}\r\nwhile (!timedout) {\r\nchecktime = jiffies;\r\ni2c_status = xlr_i2c_rdreg(priv->iobase, XLR_I2C_STATUS);\r\nif (i2c_status & XLR_I2C_SDOEMPTY) {\r\npos++;\r\nbyte = (pos < len) ? buf[pos] : 0;\r\nxlr_i2c_wreg(priv->iobase, XLR_I2C_DATAOUT, byte);\r\nstoptime = jiffies + timeout;\r\n}\r\ntimedout = time_after(checktime, stoptime);\r\nif (i2c_status & XLR_I2C_ARB_STARTERR) {\r\nif (timedout)\r\nbreak;\r\ngoto retry;\r\n}\r\nif (i2c_status & XLR_I2C_ACK_ERR)\r\nreturn -EIO;\r\nif ((i2c_status & XLR_I2C_BUS_BUSY) == 0 && pos >= len)\r\nreturn 0;\r\n}\r\ndev_err(&adap->dev, "I2C transmit timeout\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int xlr_i2c_rx(struct xlr_i2c_private *priv, u16 len, u8 *buf, u16 addr)\r\n{\r\nstruct i2c_adapter *adap = &priv->adap;\r\nu32 i2c_status;\r\nunsigned long timeout, stoptime, checktime;\r\nint nbytes, timedout;\r\nu8 byte;\r\nxlr_i2c_wreg(priv->iobase, XLR_I2C_CFG, XLR_I2C_CFG_NOADDR);\r\nxlr_i2c_wreg(priv->iobase, XLR_I2C_BYTECNT, len);\r\nxlr_i2c_wreg(priv->iobase, XLR_I2C_DEVADDR, addr);\r\ntimeout = msecs_to_jiffies(XLR_I2C_TIMEOUT);\r\nstoptime = jiffies + timeout;\r\ntimedout = 0;\r\nnbytes = 0;\r\nretry:\r\nxlr_i2c_wreg(priv->iobase, XLR_I2C_STARTXFR, XLR_I2C_STARTXFR_RD);\r\nwhile (!timedout) {\r\nchecktime = jiffies;\r\ni2c_status = xlr_i2c_rdreg(priv->iobase, XLR_I2C_STATUS);\r\nif (i2c_status & XLR_I2C_RXRDY) {\r\nif (nbytes > len)\r\nreturn -EIO;\r\nbyte = xlr_i2c_rdreg(priv->iobase, XLR_I2C_DATAIN);\r\nif (nbytes < len)\r\nbuf[nbytes] = byte;\r\nnbytes++;\r\nstoptime = jiffies + timeout;\r\n}\r\ntimedout = time_after(checktime, stoptime);\r\nif (i2c_status & XLR_I2C_ARB_STARTERR) {\r\nif (timedout)\r\nbreak;\r\ngoto retry;\r\n}\r\nif (i2c_status & XLR_I2C_ACK_ERR)\r\nreturn -EIO;\r\nif ((i2c_status & XLR_I2C_BUS_BUSY) == 0)\r\nreturn 0;\r\n}\r\ndev_err(&adap->dev, "I2C receive timeout\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int xlr_i2c_xfer(struct i2c_adapter *adap,\r\nstruct i2c_msg *msgs, int num)\r\n{\r\nstruct i2c_msg *msg;\r\nint i;\r\nint ret = 0;\r\nstruct xlr_i2c_private *priv = i2c_get_adapdata(adap);\r\nfor (i = 0; ret == 0 && i < num; i++) {\r\nmsg = &msgs[i];\r\nif (msg->flags & I2C_M_RD)\r\nret = xlr_i2c_rx(priv, msg->len, &msg->buf[0],\r\nmsg->addr);\r\nelse\r\nret = xlr_i2c_tx(priv, msg->len, &msg->buf[0],\r\nmsg->addr);\r\n}\r\nreturn (ret != 0) ? ret : num;\r\n}\r\nstatic u32 xlr_func(struct i2c_adapter *adap)\r\n{\r\nreturn I2C_FUNC_SMBUS_EMUL | I2C_FUNC_I2C;\r\n}\r\nstatic int xlr_i2c_probe(struct platform_device *pdev)\r\n{\r\nstruct xlr_i2c_private *priv;\r\nstruct resource *res;\r\nint ret;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->iobase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->iobase))\r\nreturn PTR_ERR(priv->iobase);\r\npriv->adap.dev.parent = &pdev->dev;\r\npriv->adap.owner = THIS_MODULE;\r\npriv->adap.algo_data = priv;\r\npriv->adap.algo = &xlr_i2c_algo;\r\npriv->adap.nr = pdev->id;\r\npriv->adap.class = I2C_CLASS_HWMON;\r\nsnprintf(priv->adap.name, sizeof(priv->adap.name), "xlr-i2c");\r\ni2c_set_adapdata(&priv->adap, priv);\r\nret = i2c_add_numbered_adapter(&priv->adap);\r\nif (ret < 0) {\r\ndev_err(&priv->adap.dev, "Failed to add i2c bus.\n");\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, priv);\r\ndev_info(&priv->adap.dev, "Added I2C Bus.\n");\r\nreturn 0;\r\n}\r\nstatic int xlr_i2c_remove(struct platform_device *pdev)\r\n{\r\nstruct xlr_i2c_private *priv;\r\npriv = platform_get_drvdata(pdev);\r\ni2c_del_adapter(&priv->adap);\r\nreturn 0;\r\n}

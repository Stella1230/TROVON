void\r\ncfs_percpt_lock_free(struct cfs_percpt_lock *pcl)\r\n{\r\nLASSERT(pcl->pcl_locks != NULL);\r\nLASSERT(!pcl->pcl_locked);\r\ncfs_percpt_free(pcl->pcl_locks);\r\nLIBCFS_FREE(pcl, sizeof(*pcl));\r\n}\r\nstruct cfs_percpt_lock *\r\ncfs_percpt_lock_alloc(struct cfs_cpt_table *cptab)\r\n{\r\nstruct cfs_percpt_lock *pcl;\r\nspinlock_t *lock;\r\nint i;\r\nLIBCFS_ALLOC(pcl, sizeof(*pcl));\r\nif (pcl == NULL)\r\nreturn NULL;\r\npcl->pcl_cptab = cptab;\r\npcl->pcl_locks = cfs_percpt_alloc(cptab, sizeof(*lock));\r\nif (pcl->pcl_locks == NULL) {\r\nLIBCFS_FREE(pcl, sizeof(*pcl));\r\nreturn NULL;\r\n}\r\ncfs_percpt_for_each(lock, i, pcl->pcl_locks)\r\nspin_lock_init(lock);\r\nreturn pcl;\r\n}\r\nvoid\r\ncfs_percpt_lock(struct cfs_percpt_lock *pcl, int index)\r\n{\r\nint ncpt = cfs_cpt_number(pcl->pcl_cptab);\r\nint i;\r\nLASSERT(index >= CFS_PERCPT_LOCK_EX && index < ncpt);\r\nif (ncpt == 1) {\r\nindex = 0;\r\n} else {\r\nwhile (pcl->pcl_locked)\r\ncpu_relax();\r\n}\r\nif (likely(index != CFS_PERCPT_LOCK_EX)) {\r\nspin_lock(pcl->pcl_locks[index]);\r\nreturn;\r\n}\r\nfor (i = 0; i < ncpt; i++) {\r\nspin_lock(pcl->pcl_locks[i]);\r\nif (i == 0) {\r\nLASSERT(!pcl->pcl_locked);\r\npcl->pcl_locked = 1;\r\n}\r\n}\r\n}\r\nvoid\r\ncfs_percpt_unlock(struct cfs_percpt_lock *pcl, int index)\r\n{\r\nint ncpt = cfs_cpt_number(pcl->pcl_cptab);\r\nint i;\r\nindex = ncpt == 1 ? 0 : index;\r\nif (likely(index != CFS_PERCPT_LOCK_EX)) {\r\nspin_unlock(pcl->pcl_locks[index]);\r\nreturn;\r\n}\r\nfor (i = ncpt - 1; i >= 0; i--) {\r\nif (i == 0) {\r\nLASSERT(pcl->pcl_locked);\r\npcl->pcl_locked = 0;\r\n}\r\nspin_unlock(pcl->pcl_locks[i]);\r\n}\r\n}\r\nvoid\r\ncfs_percpt_atomic_free(atomic_t **refs)\r\n{\r\ncfs_percpt_free(refs);\r\n}\r\natomic_t **\r\ncfs_percpt_atomic_alloc(struct cfs_cpt_table *cptab, int init_val)\r\n{\r\natomic_t **refs;\r\natomic_t *ref;\r\nint i;\r\nrefs = cfs_percpt_alloc(cptab, sizeof(*ref));\r\nif (refs == NULL)\r\nreturn NULL;\r\ncfs_percpt_for_each(ref, i, refs)\r\natomic_set(ref, init_val);\r\nreturn refs;\r\n}\r\nint\r\ncfs_percpt_atomic_summary(atomic_t **refs)\r\n{\r\natomic_t *ref;\r\nint i;\r\nint val = 0;\r\ncfs_percpt_for_each(ref, i, refs)\r\nval += atomic_read(ref);\r\nreturn val;\r\n}

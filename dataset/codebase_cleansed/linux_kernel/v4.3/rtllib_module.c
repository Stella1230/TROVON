static inline int rtllib_networks_allocate(struct rtllib_device *ieee)\r\n{\r\nif (ieee->networks)\r\nreturn 0;\r\nieee->networks = kzalloc(\r\nMAX_NETWORK_COUNT * sizeof(struct rtllib_network),\r\nGFP_KERNEL);\r\nif (!ieee->networks)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic inline void rtllib_networks_free(struct rtllib_device *ieee)\r\n{\r\nif (!ieee->networks)\r\nreturn;\r\nkfree(ieee->networks);\r\nieee->networks = NULL;\r\n}\r\nstatic inline void rtllib_networks_initialize(struct rtllib_device *ieee)\r\n{\r\nint i;\r\nINIT_LIST_HEAD(&ieee->network_free_list);\r\nINIT_LIST_HEAD(&ieee->network_list);\r\nfor (i = 0; i < MAX_NETWORK_COUNT; i++)\r\nlist_add_tail(&ieee->networks[i].list,\r\n&ieee->network_free_list);\r\n}\r\nstruct net_device *alloc_rtllib(int sizeof_priv)\r\n{\r\nstruct rtllib_device *ieee = NULL;\r\nstruct net_device *dev;\r\nint i, err;\r\npr_debug("rtllib: Initializing...\n");\r\ndev = alloc_etherdev(sizeof(struct rtllib_device) + sizeof_priv);\r\nif (!dev) {\r\npr_err("Unable to allocate net_device.\n");\r\nreturn NULL;\r\n}\r\nieee = (struct rtllib_device *)netdev_priv_rsl(dev);\r\nmemset(ieee, 0, sizeof(struct rtllib_device)+sizeof_priv);\r\nieee->dev = dev;\r\nerr = rtllib_networks_allocate(ieee);\r\nif (err) {\r\npr_err("Unable to allocate beacon storage: %d\n", err);\r\ngoto failed;\r\n}\r\nrtllib_networks_initialize(ieee);\r\nieee->fts = DEFAULT_FTS;\r\nieee->scan_age = DEFAULT_MAX_SCAN_AGE;\r\nieee->open_wep = 1;\r\nieee->host_encrypt = 1;\r\nieee->host_decrypt = 1;\r\nieee->ieee802_1x = 1;\r\nieee->rtllib_ap_sec_type = rtllib_ap_sec_type;\r\nspin_lock_init(&ieee->lock);\r\nspin_lock_init(&ieee->wpax_suitlist_lock);\r\nspin_lock_init(&ieee->reorder_spinlock);\r\natomic_set(&(ieee->atm_swbw), 0);\r\nlib80211_crypt_info_init(&ieee->crypt_info, "RTLLIB", &ieee->lock);\r\nieee->wpa_enabled = 0;\r\nieee->tkip_countermeasures = 0;\r\nieee->drop_unencrypted = 0;\r\nieee->privacy_invoked = 0;\r\nieee->ieee802_1x = 1;\r\nieee->raw_tx = 0;\r\nieee->hwsec_active = 0;\r\nmemset(ieee->swcamtable, 0, sizeof(struct sw_cam_table) * 32);\r\nrtllib_softmac_init(ieee);\r\nieee->pHTInfo = kzalloc(sizeof(struct rt_hi_throughput), GFP_KERNEL);\r\nif (ieee->pHTInfo == NULL)\r\nreturn NULL;\r\nHTUpdateDefaultSetting(ieee);\r\nHTInitializeHTInfo(ieee);\r\nTSInitialize(ieee);\r\nfor (i = 0; i < IEEE_IBSS_MAC_HASH_SIZE; i++)\r\nINIT_LIST_HEAD(&ieee->ibss_mac_hash[i]);\r\nfor (i = 0; i < 17; i++) {\r\nieee->last_rxseq_num[i] = -1;\r\nieee->last_rxfrag_num[i] = -1;\r\nieee->last_packet_time[i] = 0;\r\n}\r\nreturn dev;\r\nfailed:\r\nfree_netdev(dev);\r\nreturn NULL;\r\n}\r\nvoid free_rtllib(struct net_device *dev)\r\n{\r\nstruct rtllib_device *ieee = (struct rtllib_device *)\r\nnetdev_priv_rsl(dev);\r\nkfree(ieee->pHTInfo);\r\nieee->pHTInfo = NULL;\r\nrtllib_softmac_free(ieee);\r\nlib80211_crypt_info_free(&ieee->crypt_info);\r\nrtllib_networks_free(ieee);\r\nfree_netdev(dev);\r\n}\r\nstatic int __init rtllib_init(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit rtllib_exit(void)\r\n{\r\n}

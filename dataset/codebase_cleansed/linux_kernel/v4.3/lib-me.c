int\r\nLNetMEAttach(unsigned int portal,\r\nlnet_process_id_t match_id,\r\n__u64 match_bits, __u64 ignore_bits,\r\nlnet_unlink_t unlink, lnet_ins_pos_t pos,\r\nlnet_handle_me_t *handle)\r\n{\r\nstruct lnet_match_table *mtable;\r\nstruct lnet_me *me;\r\nstruct list_head *head;\r\nLASSERT(the_lnet.ln_init);\r\nLASSERT(the_lnet.ln_refcount > 0);\r\nif ((int)portal >= the_lnet.ln_nportals)\r\nreturn -EINVAL;\r\nmtable = lnet_mt_of_attach(portal, match_id,\r\nmatch_bits, ignore_bits, pos);\r\nif (mtable == NULL)\r\nreturn -EPERM;\r\nme = lnet_me_alloc();\r\nif (me == NULL)\r\nreturn -ENOMEM;\r\nlnet_res_lock(mtable->mt_cpt);\r\nme->me_portal = portal;\r\nme->me_match_id = match_id;\r\nme->me_match_bits = match_bits;\r\nme->me_ignore_bits = ignore_bits;\r\nme->me_unlink = unlink;\r\nme->me_md = NULL;\r\nlnet_res_lh_initialize(the_lnet.ln_me_containers[mtable->mt_cpt],\r\n&me->me_lh);\r\nif (ignore_bits != 0)\r\nhead = &mtable->mt_mhash[LNET_MT_HASH_IGNORE];\r\nelse\r\nhead = lnet_mt_match_head(mtable, match_id, match_bits);\r\nme->me_pos = head - &mtable->mt_mhash[0];\r\nif (pos == LNET_INS_AFTER || pos == LNET_INS_LOCAL)\r\nlist_add_tail(&me->me_list, head);\r\nelse\r\nlist_add(&me->me_list, head);\r\nlnet_me2handle(handle, me);\r\nlnet_res_unlock(mtable->mt_cpt);\r\nreturn 0;\r\n}\r\nint\r\nLNetMEInsert(lnet_handle_me_t current_meh,\r\nlnet_process_id_t match_id,\r\n__u64 match_bits, __u64 ignore_bits,\r\nlnet_unlink_t unlink, lnet_ins_pos_t pos,\r\nlnet_handle_me_t *handle)\r\n{\r\nstruct lnet_me *current_me;\r\nstruct lnet_me *new_me;\r\nstruct lnet_portal *ptl;\r\nint cpt;\r\nLASSERT(the_lnet.ln_init);\r\nLASSERT(the_lnet.ln_refcount > 0);\r\nif (pos == LNET_INS_LOCAL)\r\nreturn -EPERM;\r\nnew_me = lnet_me_alloc();\r\nif (new_me == NULL)\r\nreturn -ENOMEM;\r\ncpt = lnet_cpt_of_cookie(current_meh.cookie);\r\nlnet_res_lock(cpt);\r\ncurrent_me = lnet_handle2me(&current_meh);\r\nif (current_me == NULL) {\r\nlnet_me_free(new_me);\r\nlnet_res_unlock(cpt);\r\nreturn -ENOENT;\r\n}\r\nLASSERT(current_me->me_portal < the_lnet.ln_nportals);\r\nptl = the_lnet.ln_portals[current_me->me_portal];\r\nif (lnet_ptl_is_unique(ptl)) {\r\nlnet_me_free(new_me);\r\nlnet_res_unlock(cpt);\r\nreturn -EPERM;\r\n}\r\nnew_me->me_pos = current_me->me_pos;\r\nnew_me->me_portal = current_me->me_portal;\r\nnew_me->me_match_id = match_id;\r\nnew_me->me_match_bits = match_bits;\r\nnew_me->me_ignore_bits = ignore_bits;\r\nnew_me->me_unlink = unlink;\r\nnew_me->me_md = NULL;\r\nlnet_res_lh_initialize(the_lnet.ln_me_containers[cpt], &new_me->me_lh);\r\nif (pos == LNET_INS_AFTER)\r\nlist_add(&new_me->me_list, &current_me->me_list);\r\nelse\r\nlist_add_tail(&new_me->me_list, &current_me->me_list);\r\nlnet_me2handle(handle, new_me);\r\nlnet_res_unlock(cpt);\r\nreturn 0;\r\n}\r\nint\r\nLNetMEUnlink(lnet_handle_me_t meh)\r\n{\r\nlnet_me_t *me;\r\nlnet_libmd_t *md;\r\nlnet_event_t ev;\r\nint cpt;\r\nLASSERT(the_lnet.ln_init);\r\nLASSERT(the_lnet.ln_refcount > 0);\r\ncpt = lnet_cpt_of_cookie(meh.cookie);\r\nlnet_res_lock(cpt);\r\nme = lnet_handle2me(&meh);\r\nif (me == NULL) {\r\nlnet_res_unlock(cpt);\r\nreturn -ENOENT;\r\n}\r\nmd = me->me_md;\r\nif (md != NULL) {\r\nmd->md_flags |= LNET_MD_FLAG_ABORTED;\r\nif (md->md_eq != NULL && md->md_refcount == 0) {\r\nlnet_build_unlink_event(md, &ev);\r\nlnet_eq_enqueue_event(md->md_eq, &ev);\r\n}\r\n}\r\nlnet_me_unlink(me);\r\nlnet_res_unlock(cpt);\r\nreturn 0;\r\n}\r\nvoid\r\nlnet_me_unlink(lnet_me_t *me)\r\n{\r\nlist_del(&me->me_list);\r\nif (me->me_md != NULL) {\r\nlnet_libmd_t *md = me->me_md;\r\nlnet_ptl_detach_md(me, md);\r\nlnet_md_unlink(md);\r\n}\r\nlnet_res_lh_invalidate(&me->me_lh);\r\nlnet_me_free(me);\r\n}

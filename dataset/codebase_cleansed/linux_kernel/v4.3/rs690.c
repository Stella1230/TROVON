int rs690_mc_wait_for_idle(struct radeon_device *rdev)\r\n{\r\nunsigned i;\r\nuint32_t tmp;\r\nfor (i = 0; i < rdev->usec_timeout; i++) {\r\ntmp = RREG32_MC(R_000090_MC_SYSTEM_STATUS);\r\nif (G_000090_MC_SYSTEM_IDLE(tmp))\r\nreturn 0;\r\nudelay(1);\r\n}\r\nreturn -1;\r\n}\r\nstatic void rs690_gpu_init(struct radeon_device *rdev)\r\n{\r\nr420_pipes_init(rdev);\r\nif (rs690_mc_wait_for_idle(rdev)) {\r\nprintk(KERN_WARNING "Failed to wait MC idle while "\r\n"programming pipes. Bad things might happen.\n");\r\n}\r\n}\r\nvoid rs690_pm_info(struct radeon_device *rdev)\r\n{\r\nint index = GetIndexIntoMasterTable(DATA, IntegratedSystemInfo);\r\nunion igp_info *info;\r\nuint16_t data_offset;\r\nuint8_t frev, crev;\r\nfixed20_12 tmp;\r\nif (atom_parse_data_header(rdev->mode_info.atom_context, index, NULL,\r\n&frev, &crev, &data_offset)) {\r\ninfo = (union igp_info *)(rdev->mode_info.atom_context->bios + data_offset);\r\nswitch (crev) {\r\ncase 1:\r\ntmp.full = dfixed_const(100);\r\nrdev->pm.igp_sideport_mclk.full = dfixed_const(le32_to_cpu(info->info.ulBootUpMemoryClock));\r\nrdev->pm.igp_sideport_mclk.full = dfixed_div(rdev->pm.igp_sideport_mclk, tmp);\r\nif (le16_to_cpu(info->info.usK8MemoryClock))\r\nrdev->pm.igp_system_mclk.full = dfixed_const(le16_to_cpu(info->info.usK8MemoryClock));\r\nelse if (rdev->clock.default_mclk) {\r\nrdev->pm.igp_system_mclk.full = dfixed_const(rdev->clock.default_mclk);\r\nrdev->pm.igp_system_mclk.full = dfixed_div(rdev->pm.igp_system_mclk, tmp);\r\n} else\r\nrdev->pm.igp_system_mclk.full = dfixed_const(400);\r\nrdev->pm.igp_ht_link_clk.full = dfixed_const(le16_to_cpu(info->info.usFSBClock));\r\nrdev->pm.igp_ht_link_width.full = dfixed_const(info->info.ucHTLinkWidth);\r\nbreak;\r\ncase 2:\r\ntmp.full = dfixed_const(100);\r\nrdev->pm.igp_sideport_mclk.full = dfixed_const(le32_to_cpu(info->info_v2.ulBootUpSidePortClock));\r\nrdev->pm.igp_sideport_mclk.full = dfixed_div(rdev->pm.igp_sideport_mclk, tmp);\r\nif (le32_to_cpu(info->info_v2.ulBootUpUMAClock))\r\nrdev->pm.igp_system_mclk.full = dfixed_const(le32_to_cpu(info->info_v2.ulBootUpUMAClock));\r\nelse if (rdev->clock.default_mclk)\r\nrdev->pm.igp_system_mclk.full = dfixed_const(rdev->clock.default_mclk);\r\nelse\r\nrdev->pm.igp_system_mclk.full = dfixed_const(66700);\r\nrdev->pm.igp_system_mclk.full = dfixed_div(rdev->pm.igp_system_mclk, tmp);\r\nrdev->pm.igp_ht_link_clk.full = dfixed_const(le32_to_cpu(info->info_v2.ulHTLinkFreq));\r\nrdev->pm.igp_ht_link_clk.full = dfixed_div(rdev->pm.igp_ht_link_clk, tmp);\r\nrdev->pm.igp_ht_link_width.full = dfixed_const(le16_to_cpu(info->info_v2.usMinHTLinkWidth));\r\nbreak;\r\ndefault:\r\nrdev->pm.igp_sideport_mclk.full = dfixed_const(200);\r\nrdev->pm.igp_system_mclk.full = dfixed_const(200);\r\nrdev->pm.igp_ht_link_clk.full = dfixed_const(1000);\r\nrdev->pm.igp_ht_link_width.full = dfixed_const(8);\r\nDRM_ERROR("No integrated system info for your GPU, using safe default\n");\r\nbreak;\r\n}\r\n} else {\r\nrdev->pm.igp_sideport_mclk.full = dfixed_const(200);\r\nrdev->pm.igp_system_mclk.full = dfixed_const(200);\r\nrdev->pm.igp_ht_link_clk.full = dfixed_const(1000);\r\nrdev->pm.igp_ht_link_width.full = dfixed_const(8);\r\nDRM_ERROR("No integrated system info for your GPU, using safe default\n");\r\n}\r\ntmp.full = dfixed_const(4);\r\nrdev->pm.k8_bandwidth.full = dfixed_mul(rdev->pm.igp_system_mclk, tmp);\r\ntmp.full = dfixed_const(5);\r\nrdev->pm.ht_bandwidth.full = dfixed_mul(rdev->pm.igp_ht_link_clk,\r\nrdev->pm.igp_ht_link_width);\r\nrdev->pm.ht_bandwidth.full = dfixed_div(rdev->pm.ht_bandwidth, tmp);\r\nif (tmp.full < rdev->pm.max_bandwidth.full) {\r\nrdev->pm.max_bandwidth.full = tmp.full;\r\n}\r\ntmp.full = dfixed_const(14);\r\nrdev->pm.sideport_bandwidth.full = dfixed_mul(rdev->pm.igp_sideport_mclk, tmp);\r\ntmp.full = dfixed_const(10);\r\nrdev->pm.sideport_bandwidth.full = dfixed_div(rdev->pm.sideport_bandwidth, tmp);\r\n}\r\nstatic void rs690_mc_init(struct radeon_device *rdev)\r\n{\r\nu64 base;\r\nuint32_t h_addr, l_addr;\r\nunsigned long long k8_addr;\r\nrs400_gart_adjust_size(rdev);\r\nrdev->mc.vram_is_ddr = true;\r\nrdev->mc.vram_width = 128;\r\nrdev->mc.real_vram_size = RREG32(RADEON_CONFIG_MEMSIZE);\r\nrdev->mc.mc_vram_size = rdev->mc.real_vram_size;\r\nrdev->mc.aper_base = pci_resource_start(rdev->pdev, 0);\r\nrdev->mc.aper_size = pci_resource_len(rdev->pdev, 0);\r\nrdev->mc.visible_vram_size = rdev->mc.aper_size;\r\nbase = RREG32_MC(R_000100_MCCFG_FB_LOCATION);\r\nbase = G_000100_MC_FB_START(base) << 16;\r\nrdev->mc.igp_sideport_enabled = radeon_atombios_sideport_present(rdev);\r\nif (rdev->mc.igp_sideport_enabled &&\r\n(rdev->mc.real_vram_size == (384 * 1024 * 1024))) {\r\nbase += 128 * 1024 * 1024;\r\nrdev->mc.real_vram_size -= 128 * 1024 * 1024;\r\nrdev->mc.mc_vram_size = rdev->mc.real_vram_size;\r\n}\r\nrdev->fastfb_working = false;\r\nh_addr = G_00005F_K8_ADDR_EXT(RREG32_MC(R_00005F_MC_MISC_UMA_CNTL));\r\nl_addr = RREG32_MC(R_00001E_K8_FB_LOCATION);\r\nk8_addr = ((unsigned long long)h_addr) << 32 | l_addr;\r\n#if defined(CONFIG_X86_32) && !defined(CONFIG_X86_PAE)\r\nif (k8_addr + rdev->mc.visible_vram_size < 0x100000000ULL)\r\n#endif\r\n{\r\nif (rdev->mc.igp_sideport_enabled == false && radeon_fastfb == 1) {\r\nDRM_INFO("Direct mapping: aper base at 0x%llx, replaced by direct mapping base 0x%llx.\n",\r\n(unsigned long long)rdev->mc.aper_base, k8_addr);\r\nrdev->mc.aper_base = (resource_size_t)k8_addr;\r\nrdev->fastfb_working = true;\r\n}\r\n}\r\nrs690_pm_info(rdev);\r\nradeon_vram_location(rdev, &rdev->mc, base);\r\nrdev->mc.gtt_base_align = rdev->mc.gtt_size - 1;\r\nradeon_gtt_location(rdev, &rdev->mc);\r\nradeon_update_bandwidth_info(rdev);\r\n}\r\nvoid rs690_line_buffer_adjust(struct radeon_device *rdev,\r\nstruct drm_display_mode *mode1,\r\nstruct drm_display_mode *mode2)\r\n{\r\nu32 tmp;\r\ntmp = RREG32(R_006520_DC_LB_MEMORY_SPLIT) & C_006520_DC_LB_MEMORY_SPLIT;\r\ntmp &= ~C_006520_DC_LB_MEMORY_SPLIT_MODE;\r\nif (mode1 && mode2) {\r\nif (mode1->hdisplay > mode2->hdisplay) {\r\nif (mode1->hdisplay > 2560)\r\ntmp |= V_006520_DC_LB_MEMORY_SPLIT_D1_3Q_D2_1Q;\r\nelse\r\ntmp |= V_006520_DC_LB_MEMORY_SPLIT_D1HALF_D2HALF;\r\n} else if (mode2->hdisplay > mode1->hdisplay) {\r\nif (mode2->hdisplay > 2560)\r\ntmp |= V_006520_DC_LB_MEMORY_SPLIT_D1_1Q_D2_3Q;\r\nelse\r\ntmp |= V_006520_DC_LB_MEMORY_SPLIT_D1HALF_D2HALF;\r\n} else\r\ntmp |= V_006520_DC_LB_MEMORY_SPLIT_D1HALF_D2HALF;\r\n} else if (mode1) {\r\ntmp |= V_006520_DC_LB_MEMORY_SPLIT_D1_ONLY;\r\n} else if (mode2) {\r\ntmp |= V_006520_DC_LB_MEMORY_SPLIT_D1_1Q_D2_3Q;\r\n}\r\nWREG32(R_006520_DC_LB_MEMORY_SPLIT, tmp);\r\n}\r\nstatic void rs690_crtc_bandwidth_compute(struct radeon_device *rdev,\r\nstruct radeon_crtc *crtc,\r\nstruct rs690_watermark *wm,\r\nbool low)\r\n{\r\nstruct drm_display_mode *mode = &crtc->base.mode;\r\nfixed20_12 a, b, c;\r\nfixed20_12 pclk, request_fifo_depth, tolerable_latency, estimated_width;\r\nfixed20_12 consumption_time, line_time, chunk_time, read_delay_latency;\r\nfixed20_12 sclk, core_bandwidth, max_bandwidth;\r\nu32 selected_sclk;\r\nif (!crtc->base.enabled) {\r\nwm->lb_request_fifo_depth = 4;\r\nreturn;\r\n}\r\nif (((rdev->family == CHIP_RS780) || (rdev->family == CHIP_RS880)) &&\r\n(rdev->pm.pm_method == PM_METHOD_DPM) && rdev->pm.dpm_enabled)\r\nselected_sclk = radeon_dpm_get_sclk(rdev, low);\r\nelse\r\nselected_sclk = rdev->pm.current_sclk;\r\na.full = dfixed_const(100);\r\nsclk.full = dfixed_const(selected_sclk);\r\nsclk.full = dfixed_div(sclk, a);\r\na.full = dfixed_const(16);\r\ncore_bandwidth.full = dfixed_div(rdev->pm.sclk, a);\r\nif (crtc->vsc.full > dfixed_const(2))\r\nwm->num_line_pair.full = dfixed_const(2);\r\nelse\r\nwm->num_line_pair.full = dfixed_const(1);\r\nb.full = dfixed_const(mode->crtc_hdisplay);\r\nc.full = dfixed_const(256);\r\na.full = dfixed_div(b, c);\r\nrequest_fifo_depth.full = dfixed_mul(a, wm->num_line_pair);\r\nrequest_fifo_depth.full = dfixed_ceil(request_fifo_depth);\r\nif (a.full < dfixed_const(4)) {\r\nwm->lb_request_fifo_depth = 4;\r\n} else {\r\nwm->lb_request_fifo_depth = dfixed_trunc(request_fifo_depth);\r\n}\r\na.full = dfixed_const(mode->clock);\r\nb.full = dfixed_const(1000);\r\na.full = dfixed_div(a, b);\r\npclk.full = dfixed_div(b, a);\r\nif (crtc->rmx_type != RMX_OFF) {\r\nb.full = dfixed_const(2);\r\nif (crtc->vsc.full > b.full)\r\nb.full = crtc->vsc.full;\r\nb.full = dfixed_mul(b, crtc->hsc);\r\nc.full = dfixed_const(2);\r\nb.full = dfixed_div(b, c);\r\nconsumption_time.full = dfixed_div(pclk, b);\r\n} else {\r\nconsumption_time.full = pclk.full;\r\n}\r\na.full = dfixed_const(1);\r\nwm->consumption_rate.full = dfixed_div(a, consumption_time);\r\na.full = dfixed_const(crtc->base.mode.crtc_htotal);\r\nline_time.full = dfixed_mul(a, pclk);\r\na.full = dfixed_const(crtc->base.mode.crtc_htotal);\r\nb.full = dfixed_const(crtc->base.mode.crtc_hdisplay);\r\nwm->active_time.full = dfixed_mul(line_time, b);\r\nwm->active_time.full = dfixed_div(wm->active_time, a);\r\nmax_bandwidth = core_bandwidth;\r\nif (rdev->mc.igp_sideport_enabled) {\r\nif (max_bandwidth.full > rdev->pm.sideport_bandwidth.full &&\r\nrdev->pm.sideport_bandwidth.full)\r\nmax_bandwidth = rdev->pm.sideport_bandwidth;\r\nread_delay_latency.full = dfixed_const(370 * 800);\r\na.full = dfixed_const(1000);\r\nb.full = dfixed_div(rdev->pm.igp_sideport_mclk, a);\r\nread_delay_latency.full = dfixed_div(read_delay_latency, b);\r\nread_delay_latency.full = dfixed_mul(read_delay_latency, a);\r\n} else {\r\nif (max_bandwidth.full > rdev->pm.k8_bandwidth.full &&\r\nrdev->pm.k8_bandwidth.full)\r\nmax_bandwidth = rdev->pm.k8_bandwidth;\r\nif (max_bandwidth.full > rdev->pm.ht_bandwidth.full &&\r\nrdev->pm.ht_bandwidth.full)\r\nmax_bandwidth = rdev->pm.ht_bandwidth;\r\nread_delay_latency.full = dfixed_const(5000);\r\n}\r\na.full = dfixed_const(16);\r\nsclk.full = dfixed_mul(max_bandwidth, a);\r\na.full = dfixed_const(1000);\r\nsclk.full = dfixed_div(a, sclk);\r\na.full = dfixed_const(256 * 13);\r\nchunk_time.full = dfixed_mul(sclk, a);\r\na.full = dfixed_const(10);\r\nchunk_time.full = dfixed_div(chunk_time, a);\r\nif (dfixed_trunc(wm->num_line_pair) > 1) {\r\na.full = dfixed_const(3);\r\nwm->worst_case_latency.full = dfixed_mul(a, chunk_time);\r\nwm->worst_case_latency.full += read_delay_latency.full;\r\n} else {\r\na.full = dfixed_const(2);\r\nwm->worst_case_latency.full = dfixed_mul(a, chunk_time);\r\nwm->worst_case_latency.full += read_delay_latency.full;\r\n}\r\nif ((2+wm->lb_request_fifo_depth) >= dfixed_trunc(request_fifo_depth)) {\r\ntolerable_latency.full = line_time.full;\r\n} else {\r\ntolerable_latency.full = dfixed_const(wm->lb_request_fifo_depth - 2);\r\ntolerable_latency.full = request_fifo_depth.full - tolerable_latency.full;\r\ntolerable_latency.full = dfixed_mul(tolerable_latency, chunk_time);\r\ntolerable_latency.full = line_time.full - tolerable_latency.full;\r\n}\r\nwm->dbpp.full = dfixed_const(4 * 8);\r\na.full = dfixed_const(16);\r\nwm->priority_mark_max.full = dfixed_const(crtc->base.mode.crtc_hdisplay);\r\nwm->priority_mark_max.full = dfixed_div(wm->priority_mark_max, a);\r\nwm->priority_mark_max.full = dfixed_ceil(wm->priority_mark_max);\r\nestimated_width.full = tolerable_latency.full - wm->worst_case_latency.full;\r\nestimated_width.full = dfixed_div(estimated_width, consumption_time);\r\nif (dfixed_trunc(estimated_width) > crtc->base.mode.crtc_hdisplay) {\r\nwm->priority_mark.full = dfixed_const(10);\r\n} else {\r\na.full = dfixed_const(16);\r\nwm->priority_mark.full = dfixed_div(estimated_width, a);\r\nwm->priority_mark.full = dfixed_ceil(wm->priority_mark);\r\nwm->priority_mark.full = wm->priority_mark_max.full - wm->priority_mark.full;\r\n}\r\n}\r\nstatic void rs690_compute_mode_priority(struct radeon_device *rdev,\r\nstruct rs690_watermark *wm0,\r\nstruct rs690_watermark *wm1,\r\nstruct drm_display_mode *mode0,\r\nstruct drm_display_mode *mode1,\r\nu32 *d1mode_priority_a_cnt,\r\nu32 *d2mode_priority_a_cnt)\r\n{\r\nfixed20_12 priority_mark02, priority_mark12, fill_rate;\r\nfixed20_12 a, b;\r\n*d1mode_priority_a_cnt = S_006548_D1MODE_PRIORITY_A_OFF(1);\r\n*d2mode_priority_a_cnt = S_006548_D1MODE_PRIORITY_A_OFF(1);\r\nif (mode0 && mode1) {\r\nif (dfixed_trunc(wm0->dbpp) > 64)\r\na.full = dfixed_mul(wm0->dbpp, wm0->num_line_pair);\r\nelse\r\na.full = wm0->num_line_pair.full;\r\nif (dfixed_trunc(wm1->dbpp) > 64)\r\nb.full = dfixed_mul(wm1->dbpp, wm1->num_line_pair);\r\nelse\r\nb.full = wm1->num_line_pair.full;\r\na.full += b.full;\r\nfill_rate.full = dfixed_div(wm0->sclk, a);\r\nif (wm0->consumption_rate.full > fill_rate.full) {\r\nb.full = wm0->consumption_rate.full - fill_rate.full;\r\nb.full = dfixed_mul(b, wm0->active_time);\r\na.full = dfixed_mul(wm0->worst_case_latency,\r\nwm0->consumption_rate);\r\na.full = a.full + b.full;\r\nb.full = dfixed_const(16 * 1000);\r\npriority_mark02.full = dfixed_div(a, b);\r\n} else {\r\na.full = dfixed_mul(wm0->worst_case_latency,\r\nwm0->consumption_rate);\r\nb.full = dfixed_const(16 * 1000);\r\npriority_mark02.full = dfixed_div(a, b);\r\n}\r\nif (wm1->consumption_rate.full > fill_rate.full) {\r\nb.full = wm1->consumption_rate.full - fill_rate.full;\r\nb.full = dfixed_mul(b, wm1->active_time);\r\na.full = dfixed_mul(wm1->worst_case_latency,\r\nwm1->consumption_rate);\r\na.full = a.full + b.full;\r\nb.full = dfixed_const(16 * 1000);\r\npriority_mark12.full = dfixed_div(a, b);\r\n} else {\r\na.full = dfixed_mul(wm1->worst_case_latency,\r\nwm1->consumption_rate);\r\nb.full = dfixed_const(16 * 1000);\r\npriority_mark12.full = dfixed_div(a, b);\r\n}\r\nif (wm0->priority_mark.full > priority_mark02.full)\r\npriority_mark02.full = wm0->priority_mark.full;\r\nif (wm0->priority_mark_max.full > priority_mark02.full)\r\npriority_mark02.full = wm0->priority_mark_max.full;\r\nif (wm1->priority_mark.full > priority_mark12.full)\r\npriority_mark12.full = wm1->priority_mark.full;\r\nif (wm1->priority_mark_max.full > priority_mark12.full)\r\npriority_mark12.full = wm1->priority_mark_max.full;\r\n*d1mode_priority_a_cnt = dfixed_trunc(priority_mark02);\r\n*d2mode_priority_a_cnt = dfixed_trunc(priority_mark12);\r\nif (rdev->disp_priority == 2) {\r\n*d1mode_priority_a_cnt |= S_006548_D1MODE_PRIORITY_A_ALWAYS_ON(1);\r\n*d2mode_priority_a_cnt |= S_006D48_D2MODE_PRIORITY_A_ALWAYS_ON(1);\r\n}\r\n} else if (mode0) {\r\nif (dfixed_trunc(wm0->dbpp) > 64)\r\na.full = dfixed_mul(wm0->dbpp, wm0->num_line_pair);\r\nelse\r\na.full = wm0->num_line_pair.full;\r\nfill_rate.full = dfixed_div(wm0->sclk, a);\r\nif (wm0->consumption_rate.full > fill_rate.full) {\r\nb.full = wm0->consumption_rate.full - fill_rate.full;\r\nb.full = dfixed_mul(b, wm0->active_time);\r\na.full = dfixed_mul(wm0->worst_case_latency,\r\nwm0->consumption_rate);\r\na.full = a.full + b.full;\r\nb.full = dfixed_const(16 * 1000);\r\npriority_mark02.full = dfixed_div(a, b);\r\n} else {\r\na.full = dfixed_mul(wm0->worst_case_latency,\r\nwm0->consumption_rate);\r\nb.full = dfixed_const(16 * 1000);\r\npriority_mark02.full = dfixed_div(a, b);\r\n}\r\nif (wm0->priority_mark.full > priority_mark02.full)\r\npriority_mark02.full = wm0->priority_mark.full;\r\nif (wm0->priority_mark_max.full > priority_mark02.full)\r\npriority_mark02.full = wm0->priority_mark_max.full;\r\n*d1mode_priority_a_cnt = dfixed_trunc(priority_mark02);\r\nif (rdev->disp_priority == 2)\r\n*d1mode_priority_a_cnt |= S_006548_D1MODE_PRIORITY_A_ALWAYS_ON(1);\r\n} else if (mode1) {\r\nif (dfixed_trunc(wm1->dbpp) > 64)\r\na.full = dfixed_mul(wm1->dbpp, wm1->num_line_pair);\r\nelse\r\na.full = wm1->num_line_pair.full;\r\nfill_rate.full = dfixed_div(wm1->sclk, a);\r\nif (wm1->consumption_rate.full > fill_rate.full) {\r\nb.full = wm1->consumption_rate.full - fill_rate.full;\r\nb.full = dfixed_mul(b, wm1->active_time);\r\na.full = dfixed_mul(wm1->worst_case_latency,\r\nwm1->consumption_rate);\r\na.full = a.full + b.full;\r\nb.full = dfixed_const(16 * 1000);\r\npriority_mark12.full = dfixed_div(a, b);\r\n} else {\r\na.full = dfixed_mul(wm1->worst_case_latency,\r\nwm1->consumption_rate);\r\nb.full = dfixed_const(16 * 1000);\r\npriority_mark12.full = dfixed_div(a, b);\r\n}\r\nif (wm1->priority_mark.full > priority_mark12.full)\r\npriority_mark12.full = wm1->priority_mark.full;\r\nif (wm1->priority_mark_max.full > priority_mark12.full)\r\npriority_mark12.full = wm1->priority_mark_max.full;\r\n*d2mode_priority_a_cnt = dfixed_trunc(priority_mark12);\r\nif (rdev->disp_priority == 2)\r\n*d2mode_priority_a_cnt |= S_006D48_D2MODE_PRIORITY_A_ALWAYS_ON(1);\r\n}\r\n}\r\nvoid rs690_bandwidth_update(struct radeon_device *rdev)\r\n{\r\nstruct drm_display_mode *mode0 = NULL;\r\nstruct drm_display_mode *mode1 = NULL;\r\nstruct rs690_watermark wm0_high, wm0_low;\r\nstruct rs690_watermark wm1_high, wm1_low;\r\nu32 tmp;\r\nu32 d1mode_priority_a_cnt, d1mode_priority_b_cnt;\r\nu32 d2mode_priority_a_cnt, d2mode_priority_b_cnt;\r\nif (!rdev->mode_info.mode_config_initialized)\r\nreturn;\r\nradeon_update_display_priority(rdev);\r\nif (rdev->mode_info.crtcs[0]->base.enabled)\r\nmode0 = &rdev->mode_info.crtcs[0]->base.mode;\r\nif (rdev->mode_info.crtcs[1]->base.enabled)\r\nmode1 = &rdev->mode_info.crtcs[1]->base.mode;\r\nif ((rdev->disp_priority == 2) &&\r\n((rdev->family == CHIP_RS690) || (rdev->family == CHIP_RS740))) {\r\ntmp = RREG32_MC(R_000104_MC_INIT_MISC_LAT_TIMER);\r\ntmp &= C_000104_MC_DISP0R_INIT_LAT;\r\ntmp &= C_000104_MC_DISP1R_INIT_LAT;\r\nif (mode0)\r\ntmp |= S_000104_MC_DISP0R_INIT_LAT(1);\r\nif (mode1)\r\ntmp |= S_000104_MC_DISP1R_INIT_LAT(1);\r\nWREG32_MC(R_000104_MC_INIT_MISC_LAT_TIMER, tmp);\r\n}\r\nrs690_line_buffer_adjust(rdev, mode0, mode1);\r\nif ((rdev->family == CHIP_RS690) || (rdev->family == CHIP_RS740))\r\nWREG32(R_006C9C_DCP_CONTROL, 0);\r\nif ((rdev->family == CHIP_RS780) || (rdev->family == CHIP_RS880))\r\nWREG32(R_006C9C_DCP_CONTROL, 2);\r\nrs690_crtc_bandwidth_compute(rdev, rdev->mode_info.crtcs[0], &wm0_high, false);\r\nrs690_crtc_bandwidth_compute(rdev, rdev->mode_info.crtcs[1], &wm1_high, false);\r\nrs690_crtc_bandwidth_compute(rdev, rdev->mode_info.crtcs[0], &wm0_low, true);\r\nrs690_crtc_bandwidth_compute(rdev, rdev->mode_info.crtcs[1], &wm1_low, true);\r\ntmp = (wm0_high.lb_request_fifo_depth - 1);\r\ntmp |= (wm1_high.lb_request_fifo_depth - 1) << 16;\r\nWREG32(R_006D58_LB_MAX_REQ_OUTSTANDING, tmp);\r\nrs690_compute_mode_priority(rdev,\r\n&wm0_high, &wm1_high,\r\nmode0, mode1,\r\n&d1mode_priority_a_cnt, &d2mode_priority_a_cnt);\r\nrs690_compute_mode_priority(rdev,\r\n&wm0_low, &wm1_low,\r\nmode0, mode1,\r\n&d1mode_priority_b_cnt, &d2mode_priority_b_cnt);\r\nWREG32(R_006548_D1MODE_PRIORITY_A_CNT, d1mode_priority_a_cnt);\r\nWREG32(R_00654C_D1MODE_PRIORITY_B_CNT, d1mode_priority_b_cnt);\r\nWREG32(R_006D48_D2MODE_PRIORITY_A_CNT, d2mode_priority_a_cnt);\r\nWREG32(R_006D4C_D2MODE_PRIORITY_B_CNT, d2mode_priority_b_cnt);\r\n}\r\nuint32_t rs690_mc_rreg(struct radeon_device *rdev, uint32_t reg)\r\n{\r\nunsigned long flags;\r\nuint32_t r;\r\nspin_lock_irqsave(&rdev->mc_idx_lock, flags);\r\nWREG32(R_000078_MC_INDEX, S_000078_MC_IND_ADDR(reg));\r\nr = RREG32(R_00007C_MC_DATA);\r\nWREG32(R_000078_MC_INDEX, ~C_000078_MC_IND_ADDR);\r\nspin_unlock_irqrestore(&rdev->mc_idx_lock, flags);\r\nreturn r;\r\n}\r\nvoid rs690_mc_wreg(struct radeon_device *rdev, uint32_t reg, uint32_t v)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&rdev->mc_idx_lock, flags);\r\nWREG32(R_000078_MC_INDEX, S_000078_MC_IND_ADDR(reg) |\r\nS_000078_MC_IND_WR_EN(1));\r\nWREG32(R_00007C_MC_DATA, v);\r\nWREG32(R_000078_MC_INDEX, 0x7F);\r\nspin_unlock_irqrestore(&rdev->mc_idx_lock, flags);\r\n}\r\nstatic void rs690_mc_program(struct radeon_device *rdev)\r\n{\r\nstruct rv515_mc_save save;\r\nrv515_mc_stop(rdev, &save);\r\nif (rs690_mc_wait_for_idle(rdev))\r\ndev_warn(rdev->dev, "Wait MC idle timeout before updating MC.\n");\r\nWREG32_MC(R_000100_MCCFG_FB_LOCATION,\r\nS_000100_MC_FB_START(rdev->mc.vram_start >> 16) |\r\nS_000100_MC_FB_TOP(rdev->mc.vram_end >> 16));\r\nWREG32(R_000134_HDP_FB_LOCATION,\r\nS_000134_HDP_FB_START(rdev->mc.vram_start >> 16));\r\nrv515_mc_resume(rdev, &save);\r\n}\r\nstatic int rs690_startup(struct radeon_device *rdev)\r\n{\r\nint r;\r\nrs690_mc_program(rdev);\r\nrv515_clock_startup(rdev);\r\nrs690_gpu_init(rdev);\r\nr = rs400_gart_enable(rdev);\r\nif (r)\r\nreturn r;\r\nr = radeon_wb_init(rdev);\r\nif (r)\r\nreturn r;\r\nr = radeon_fence_driver_start_ring(rdev, RADEON_RING_TYPE_GFX_INDEX);\r\nif (r) {\r\ndev_err(rdev->dev, "failed initializing CP fences (%d).\n", r);\r\nreturn r;\r\n}\r\nif (!rdev->irq.installed) {\r\nr = radeon_irq_kms_init(rdev);\r\nif (r)\r\nreturn r;\r\n}\r\nrs600_irq_set(rdev);\r\nrdev->config.r300.hdp_cntl = RREG32(RADEON_HOST_PATH_CNTL);\r\nr = r100_cp_init(rdev, 1024 * 1024);\r\nif (r) {\r\ndev_err(rdev->dev, "failed initializing CP (%d).\n", r);\r\nreturn r;\r\n}\r\nr = radeon_ib_pool_init(rdev);\r\nif (r) {\r\ndev_err(rdev->dev, "IB initialization failed (%d).\n", r);\r\nreturn r;\r\n}\r\nr = radeon_audio_init(rdev);\r\nif (r) {\r\ndev_err(rdev->dev, "failed initializing audio\n");\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nint rs690_resume(struct radeon_device *rdev)\r\n{\r\nint r;\r\nrs400_gart_disable(rdev);\r\nrv515_clock_startup(rdev);\r\nif (radeon_asic_reset(rdev)) {\r\ndev_warn(rdev->dev, "GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n",\r\nRREG32(R_000E40_RBBM_STATUS),\r\nRREG32(R_0007C0_CP_STAT));\r\n}\r\natom_asic_init(rdev->mode_info.atom_context);\r\nrv515_clock_startup(rdev);\r\nradeon_surface_init(rdev);\r\nrdev->accel_working = true;\r\nr = rs690_startup(rdev);\r\nif (r) {\r\nrdev->accel_working = false;\r\n}\r\nreturn r;\r\n}\r\nint rs690_suspend(struct radeon_device *rdev)\r\n{\r\nradeon_pm_suspend(rdev);\r\nradeon_audio_fini(rdev);\r\nr100_cp_disable(rdev);\r\nradeon_wb_disable(rdev);\r\nrs600_irq_disable(rdev);\r\nrs400_gart_disable(rdev);\r\nreturn 0;\r\n}\r\nvoid rs690_fini(struct radeon_device *rdev)\r\n{\r\nradeon_pm_fini(rdev);\r\nradeon_audio_fini(rdev);\r\nr100_cp_fini(rdev);\r\nradeon_wb_fini(rdev);\r\nradeon_ib_pool_fini(rdev);\r\nradeon_gem_fini(rdev);\r\nrs400_gart_fini(rdev);\r\nradeon_irq_kms_fini(rdev);\r\nradeon_fence_driver_fini(rdev);\r\nradeon_bo_fini(rdev);\r\nradeon_atombios_fini(rdev);\r\nkfree(rdev->bios);\r\nrdev->bios = NULL;\r\n}\r\nint rs690_init(struct radeon_device *rdev)\r\n{\r\nint r;\r\nrv515_vga_render_disable(rdev);\r\nradeon_scratch_init(rdev);\r\nradeon_surface_init(rdev);\r\nr100_restore_sanity(rdev);\r\nif (!radeon_get_bios(rdev)) {\r\nif (ASIC_IS_AVIVO(rdev))\r\nreturn -EINVAL;\r\n}\r\nif (rdev->is_atom_bios) {\r\nr = radeon_atombios_init(rdev);\r\nif (r)\r\nreturn r;\r\n} else {\r\ndev_err(rdev->dev, "Expecting atombios for RV515 GPU\n");\r\nreturn -EINVAL;\r\n}\r\nif (radeon_asic_reset(rdev)) {\r\ndev_warn(rdev->dev,\r\n"GPU reset failed ! (0xE40=0x%08X, 0x7C0=0x%08X)\n",\r\nRREG32(R_000E40_RBBM_STATUS),\r\nRREG32(R_0007C0_CP_STAT));\r\n}\r\nif (radeon_boot_test_post_card(rdev) == false)\r\nreturn -EINVAL;\r\nradeon_get_clock_info(rdev->ddev);\r\nrs690_mc_init(rdev);\r\nrv515_debugfs(rdev);\r\nr = radeon_fence_driver_init(rdev);\r\nif (r)\r\nreturn r;\r\nr = radeon_bo_init(rdev);\r\nif (r)\r\nreturn r;\r\nr = rs400_gart_init(rdev);\r\nif (r)\r\nreturn r;\r\nrs600_set_safe_registers(rdev);\r\nradeon_pm_init(rdev);\r\nrdev->accel_working = true;\r\nr = rs690_startup(rdev);\r\nif (r) {\r\ndev_err(rdev->dev, "Disabling GPU acceleration\n");\r\nr100_cp_fini(rdev);\r\nradeon_wb_fini(rdev);\r\nradeon_ib_pool_fini(rdev);\r\nrs400_gart_fini(rdev);\r\nradeon_irq_kms_fini(rdev);\r\nrdev->accel_working = false;\r\n}\r\nreturn 0;\r\n}

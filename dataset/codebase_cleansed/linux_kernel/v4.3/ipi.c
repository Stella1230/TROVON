void default_send_IPI_mask_sequence_phys(const struct cpumask *mask, int vector)\r\n{\r\nunsigned long query_cpu;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nfor_each_cpu(query_cpu, mask) {\r\n__default_send_IPI_dest_field(per_cpu(x86_cpu_to_apicid,\r\nquery_cpu), vector, APIC_DEST_PHYSICAL);\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\nvoid default_send_IPI_mask_allbutself_phys(const struct cpumask *mask,\r\nint vector)\r\n{\r\nunsigned int this_cpu = smp_processor_id();\r\nunsigned int query_cpu;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nfor_each_cpu(query_cpu, mask) {\r\nif (query_cpu == this_cpu)\r\ncontinue;\r\n__default_send_IPI_dest_field(per_cpu(x86_cpu_to_apicid,\r\nquery_cpu), vector, APIC_DEST_PHYSICAL);\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\nvoid default_send_IPI_mask_sequence_logical(const struct cpumask *mask,\r\nint vector)\r\n{\r\nunsigned long flags;\r\nunsigned int query_cpu;\r\nlocal_irq_save(flags);\r\nfor_each_cpu(query_cpu, mask)\r\n__default_send_IPI_dest_field(\r\nearly_per_cpu(x86_cpu_to_logical_apicid, query_cpu),\r\nvector, apic->dest_logical);\r\nlocal_irq_restore(flags);\r\n}\r\nvoid default_send_IPI_mask_allbutself_logical(const struct cpumask *mask,\r\nint vector)\r\n{\r\nunsigned long flags;\r\nunsigned int query_cpu;\r\nunsigned int this_cpu = smp_processor_id();\r\nlocal_irq_save(flags);\r\nfor_each_cpu(query_cpu, mask) {\r\nif (query_cpu == this_cpu)\r\ncontinue;\r\n__default_send_IPI_dest_field(\r\nearly_per_cpu(x86_cpu_to_logical_apicid, query_cpu),\r\nvector, apic->dest_logical);\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\nvoid default_send_IPI_mask_logical(const struct cpumask *cpumask, int vector)\r\n{\r\nunsigned long mask = cpumask_bits(cpumask)[0];\r\nunsigned long flags;\r\nif (!mask)\r\nreturn;\r\nlocal_irq_save(flags);\r\nWARN_ON(mask & ~cpumask_bits(cpu_online_mask)[0]);\r\n__default_send_IPI_dest_field(mask, vector, apic->dest_logical);\r\nlocal_irq_restore(flags);\r\n}\r\nvoid default_send_IPI_allbutself(int vector)\r\n{\r\nif (!(num_online_cpus() > 1))\r\nreturn;\r\n__default_local_send_IPI_allbutself(vector);\r\n}\r\nvoid default_send_IPI_all(int vector)\r\n{\r\n__default_local_send_IPI_all(vector);\r\n}\r\nvoid default_send_IPI_self(int vector)\r\n{\r\n__default_send_IPI_shortcut(APIC_DEST_SELF, vector, apic->dest_logical);\r\n}\r\nstatic int convert_apicid_to_cpu(int apic_id)\r\n{\r\nint i;\r\nfor_each_possible_cpu(i) {\r\nif (per_cpu(x86_cpu_to_apicid, i) == apic_id)\r\nreturn i;\r\n}\r\nreturn -1;\r\n}\r\nint safe_smp_processor_id(void)\r\n{\r\nint apicid, cpuid;\r\nif (!cpu_has_apic)\r\nreturn 0;\r\napicid = hard_smp_processor_id();\r\nif (apicid == BAD_APICID)\r\nreturn 0;\r\ncpuid = convert_apicid_to_cpu(apicid);\r\nreturn cpuid >= 0 ? cpuid : 0;\r\n}

static int get_next_ulong(char **str_p, unsigned long *val, char *sep, int base)\r\n{\r\nchar *p_val;\r\nint ret;\r\nif (!str_p || !(*str_p))\r\nreturn -EINVAL;\r\np_val = strsep(str_p, sep);\r\nif (!p_val)\r\nreturn -EINVAL;\r\nret = kstrtoul(p_val, base, val);\r\nif (ret)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nint fbtft_gamma_parse_str(struct fbtft_par *par, unsigned long *curves,\r\nconst char *str, int size)\r\n{\r\nchar *str_p, *curve_p = NULL;\r\nchar *tmp;\r\nunsigned long val = 0;\r\nint ret = 0;\r\nint curve_counter, value_counter;\r\nfbtft_par_dbg(DEBUG_SYSFS, par, "%s() str=\n", __func__);\r\nif (!str || !curves)\r\nreturn -EINVAL;\r\nfbtft_par_dbg(DEBUG_SYSFS, par, "%s\n", str);\r\ntmp = kmemdup(str, size + 1, GFP_KERNEL);\r\nif (!tmp)\r\nreturn -ENOMEM;\r\nstr_p = tmp;\r\nwhile (*str_p) {\r\nif (*str_p == ',')\r\n*str_p = ' ';\r\nif (*str_p == ';')\r\n*str_p = '\n';\r\nstr_p++;\r\n}\r\nstr_p = strim(tmp);\r\ncurve_counter = 0;\r\nwhile (str_p) {\r\nif (curve_counter == par->gamma.num_curves) {\r\ndev_err(par->info->device, "Gamma: Too many curves\n");\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\ncurve_p = strsep(&str_p, "\n");\r\nvalue_counter = 0;\r\nwhile (curve_p) {\r\nif (value_counter == par->gamma.num_values) {\r\ndev_err(par->info->device,\r\n"Gamma: Too many values\n");\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nret = get_next_ulong(&curve_p, &val, " ", 16);\r\nif (ret)\r\ngoto out;\r\ncurves[curve_counter * par->gamma.num_values + value_counter] = val;\r\nvalue_counter++;\r\n}\r\nif (value_counter != par->gamma.num_values) {\r\ndev_err(par->info->device, "Gamma: Too few values\n");\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\ncurve_counter++;\r\n}\r\nif (curve_counter != par->gamma.num_curves) {\r\ndev_err(par->info->device, "Gamma: Too few curves\n");\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nout:\r\nkfree(tmp);\r\nreturn ret;\r\n}\r\nstatic ssize_t\r\nsprintf_gamma(struct fbtft_par *par, unsigned long *curves, char *buf)\r\n{\r\nssize_t len = 0;\r\nunsigned int i, j;\r\nmutex_lock(&par->gamma.lock);\r\nfor (i = 0; i < par->gamma.num_curves; i++) {\r\nfor (j = 0; j < par->gamma.num_values; j++)\r\nlen += scnprintf(&buf[len], PAGE_SIZE,\r\n"%04lx ", curves[i*par->gamma.num_values + j]);\r\nbuf[len-1] = '\n';\r\n}\r\nmutex_unlock(&par->gamma.lock);\r\nreturn len;\r\n}\r\nstatic ssize_t store_gamma_curve(struct device *device,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nstruct fbtft_par *par = fb_info->par;\r\nunsigned long tmp_curves[FBTFT_GAMMA_MAX_VALUES_TOTAL];\r\nint ret;\r\nret = fbtft_gamma_parse_str(par, tmp_curves, buf, count);\r\nif (ret)\r\nreturn ret;\r\nret = par->fbtftops.set_gamma(par, tmp_curves);\r\nif (ret)\r\nreturn ret;\r\nmutex_lock(&par->gamma.lock);\r\nmemcpy(par->gamma.curves, tmp_curves,\r\npar->gamma.num_curves * par->gamma.num_values * sizeof(tmp_curves[0]));\r\nmutex_unlock(&par->gamma.lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_gamma_curve(struct device *device,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nstruct fbtft_par *par = fb_info->par;\r\nreturn sprintf_gamma(par, par->gamma.curves, buf);\r\n}\r\nvoid fbtft_expand_debug_value(unsigned long *debug)\r\n{\r\nswitch (*debug & 0x7) {\r\ncase 1:\r\n*debug |= DEBUG_LEVEL_1;\r\nbreak;\r\ncase 2:\r\n*debug |= DEBUG_LEVEL_2;\r\nbreak;\r\ncase 3:\r\n*debug |= DEBUG_LEVEL_3;\r\nbreak;\r\ncase 4:\r\n*debug |= DEBUG_LEVEL_4;\r\nbreak;\r\ncase 5:\r\n*debug |= DEBUG_LEVEL_5;\r\nbreak;\r\ncase 6:\r\n*debug |= DEBUG_LEVEL_6;\r\nbreak;\r\ncase 7:\r\n*debug = 0xFFFFFFFF;\r\nbreak;\r\n}\r\n}\r\nstatic ssize_t store_debug(struct device *device,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nstruct fbtft_par *par = fb_info->par;\r\nint ret;\r\nret = kstrtoul(buf, 10, &par->debug);\r\nif (ret)\r\nreturn ret;\r\nfbtft_expand_debug_value(&par->debug);\r\nreturn count;\r\n}\r\nstatic ssize_t show_debug(struct device *device,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct fb_info *fb_info = dev_get_drvdata(device);\r\nstruct fbtft_par *par = fb_info->par;\r\nreturn snprintf(buf, PAGE_SIZE, "%lu\n", par->debug);\r\n}\r\nvoid fbtft_sysfs_init(struct fbtft_par *par)\r\n{\r\ndevice_create_file(par->info->dev, &debug_device_attr);\r\nif (par->gamma.curves && par->fbtftops.set_gamma)\r\ndevice_create_file(par->info->dev, &gamma_device_attrs[0]);\r\n}\r\nvoid fbtft_sysfs_exit(struct fbtft_par *par)\r\n{\r\ndevice_remove_file(par->info->dev, &debug_device_attr);\r\nif (par->gamma.curves && par->fbtftops.set_gamma)\r\ndevice_remove_file(par->info->dev, &gamma_device_attrs[0]);\r\n}

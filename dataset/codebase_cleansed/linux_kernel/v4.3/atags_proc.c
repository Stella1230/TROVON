static ssize_t atags_read(struct file *file, char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct buffer *b = PDE_DATA(file_inode(file));\r\nreturn simple_read_from_buffer(buf, count, ppos, b->data, b->size);\r\n}\r\nvoid __init save_atags(const struct tag *tags)\r\n{\r\nmemcpy(atags_copy, tags, sizeof(atags_copy));\r\n}\r\nstatic int __init init_atags_procfs(void)\r\n{\r\nstruct proc_dir_entry *tags_entry;\r\nstruct tag *tag = (struct tag *)atags_copy;\r\nstruct buffer *b;\r\nsize_t size;\r\nif (tag->hdr.tag != ATAG_CORE) {\r\npr_info("No ATAGs?");\r\nreturn -EINVAL;\r\n}\r\nfor (; tag->hdr.size; tag = tag_next(tag))\r\n;\r\nsize = (char *)tag - atags_copy + sizeof(struct tag_header);\r\nWARN_ON(tag->hdr.tag != ATAG_NONE);\r\nb = kmalloc(sizeof(*b) + size, GFP_KERNEL);\r\nif (!b)\r\ngoto nomem;\r\nb->size = size;\r\nmemcpy(b->data, atags_copy, size);\r\ntags_entry = proc_create_data("atags", 0400, NULL, &atags_fops, b);\r\nif (!tags_entry)\r\ngoto nomem;\r\nreturn 0;\r\nnomem:\r\nkfree(b);\r\npr_err("Exporting ATAGs: not enough memory\n");\r\nreturn -ENOMEM;\r\n}

static void do_machine_quiesce(void)\r\n{\r\npsw_t quiesce_psw;\r\nsmp_send_stop();\r\nquiesce_psw.mask =\r\nPSW_MASK_BASE | PSW_MASK_EA | PSW_MASK_BA | PSW_MASK_WAIT;\r\nquiesce_psw.addr = 0xfff;\r\n__load_psw(quiesce_psw);\r\n}\r\nstatic void sclp_quiesce_handler(struct evbuf_header *evbuf)\r\n{\r\nif (_machine_restart != (void *) do_machine_quiesce) {\r\nold_machine_restart = _machine_restart;\r\nold_machine_halt = _machine_halt;\r\nold_machine_power_off = _machine_power_off;\r\n_machine_restart = (void *) do_machine_quiesce;\r\n_machine_halt = do_machine_quiesce;\r\n_machine_power_off = do_machine_quiesce;\r\n}\r\nctrl_alt_del();\r\n}\r\nstatic void sclp_quiesce_pm_event(struct sclp_register *reg,\r\nenum sclp_pm_event sclp_pm_event)\r\n{\r\nswitch (sclp_pm_event) {\r\ncase SCLP_PM_EVENT_RESTORE:\r\nif (old_machine_restart) {\r\n_machine_restart = old_machine_restart;\r\n_machine_halt = old_machine_halt;\r\n_machine_power_off = old_machine_power_off;\r\nold_machine_restart = NULL;\r\nold_machine_halt = NULL;\r\nold_machine_power_off = NULL;\r\n}\r\nbreak;\r\ncase SCLP_PM_EVENT_FREEZE:\r\ncase SCLP_PM_EVENT_THAW:\r\nbreak;\r\n}\r\n}\r\nstatic int __init sclp_quiesce_init(void)\r\n{\r\nreturn sclp_register(&sclp_quiesce_event);\r\n}

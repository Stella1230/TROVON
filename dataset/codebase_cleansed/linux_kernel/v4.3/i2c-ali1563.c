static int ali1563_transaction(struct i2c_adapter *a, int size)\r\n{\r\nu32 data;\r\nint timeout;\r\nint status = -EIO;\r\ndev_dbg(&a->dev, "Transaction (pre): STS=%02x, CNTL1=%02x, "\r\n"CNTL2=%02x, CMD=%02x, ADD=%02x, DAT0=%02x, DAT1=%02x\n",\r\ninb_p(SMB_HST_STS), inb_p(SMB_HST_CNTL1), inb_p(SMB_HST_CNTL2),\r\ninb_p(SMB_HST_CMD), inb_p(SMB_HST_ADD), inb_p(SMB_HST_DAT0),\r\ninb_p(SMB_HST_DAT1));\r\ndata = inb_p(SMB_HST_STS);\r\nif (data & HST_STS_BAD) {\r\ndev_err(&a->dev, "ali1563: Trying to reset busy device\n");\r\noutb_p(data | HST_STS_BAD, SMB_HST_STS);\r\ndata = inb_p(SMB_HST_STS);\r\nif (data & HST_STS_BAD)\r\nreturn -EBUSY;\r\n}\r\noutb_p(inb_p(SMB_HST_CNTL2) | HST_CNTL2_START, SMB_HST_CNTL2);\r\ntimeout = ALI1563_MAX_TIMEOUT;\r\ndo {\r\nmsleep(1);\r\n} while (((data = inb_p(SMB_HST_STS)) & HST_STS_BUSY) && --timeout);\r\ndev_dbg(&a->dev, "Transaction (post): STS=%02x, CNTL1=%02x, "\r\n"CNTL2=%02x, CMD=%02x, ADD=%02x, DAT0=%02x, DAT1=%02x\n",\r\ninb_p(SMB_HST_STS), inb_p(SMB_HST_CNTL1), inb_p(SMB_HST_CNTL2),\r\ninb_p(SMB_HST_CMD), inb_p(SMB_HST_ADD), inb_p(SMB_HST_DAT0),\r\ninb_p(SMB_HST_DAT1));\r\nif (timeout && !(data & HST_STS_BAD))\r\nreturn 0;\r\nif (!timeout) {\r\ndev_err(&a->dev, "Timeout - Trying to KILL transaction!\n");\r\noutb_p(HST_CNTL2_KILL, SMB_HST_CNTL2);\r\ndata = inb_p(SMB_HST_STS);\r\nstatus = -ETIMEDOUT;\r\n}\r\nif (data & HST_STS_DEVERR) {\r\nif (size != HST_CNTL2_QUICK)\r\ndev_err(&a->dev, "Device error!\n");\r\nstatus = -ENXIO;\r\n}\r\nif (data & HST_STS_BUSERR) {\r\ndev_err(&a->dev, "Bus collision!\n");\r\noutb_p(HST_CNTL1_TIMEOUT, SMB_HST_CNTL1);\r\n}\r\nif (data & HST_STS_FAIL) {\r\ndev_err(&a->dev, "Cleaning fail after KILL!\n");\r\noutb_p(0x0, SMB_HST_CNTL2);\r\n}\r\nreturn status;\r\n}\r\nstatic int ali1563_block_start(struct i2c_adapter *a)\r\n{\r\nu32 data;\r\nint timeout;\r\nint status = -EIO;\r\ndev_dbg(&a->dev, "Block (pre): STS=%02x, CNTL1=%02x, "\r\n"CNTL2=%02x, CMD=%02x, ADD=%02x, DAT0=%02x, DAT1=%02x\n",\r\ninb_p(SMB_HST_STS), inb_p(SMB_HST_CNTL1), inb_p(SMB_HST_CNTL2),\r\ninb_p(SMB_HST_CMD), inb_p(SMB_HST_ADD), inb_p(SMB_HST_DAT0),\r\ninb_p(SMB_HST_DAT1));\r\ndata = inb_p(SMB_HST_STS);\r\nif (data & HST_STS_BAD) {\r\ndev_warn(&a->dev, "ali1563: Trying to reset busy device\n");\r\noutb_p(data | HST_STS_BAD, SMB_HST_STS);\r\ndata = inb_p(SMB_HST_STS);\r\nif (data & HST_STS_BAD)\r\nreturn -EBUSY;\r\n}\r\noutb_p(data | HST_STS_DONE, SMB_HST_STS);\r\noutb_p(inb_p(SMB_HST_CNTL2) | HST_CNTL2_START, SMB_HST_CNTL2);\r\ntimeout = ALI1563_MAX_TIMEOUT;\r\ndo {\r\nmsleep(1);\r\n} while (!((data = inb_p(SMB_HST_STS)) & HST_STS_DONE) && --timeout);\r\ndev_dbg(&a->dev, "Block (post): STS=%02x, CNTL1=%02x, "\r\n"CNTL2=%02x, CMD=%02x, ADD=%02x, DAT0=%02x, DAT1=%02x\n",\r\ninb_p(SMB_HST_STS), inb_p(SMB_HST_CNTL1), inb_p(SMB_HST_CNTL2),\r\ninb_p(SMB_HST_CMD), inb_p(SMB_HST_ADD), inb_p(SMB_HST_DAT0),\r\ninb_p(SMB_HST_DAT1));\r\nif (timeout && !(data & HST_STS_BAD))\r\nreturn 0;\r\nif (timeout == 0)\r\nstatus = -ETIMEDOUT;\r\nif (data & HST_STS_DEVERR)\r\nstatus = -ENXIO;\r\ndev_err(&a->dev, "SMBus Error: %s%s%s%s%s\n",\r\ntimeout ? "" : "Timeout ",\r\ndata & HST_STS_FAIL ? "Transaction Failed " : "",\r\ndata & HST_STS_BUSERR ? "No response or Bus Collision " : "",\r\ndata & HST_STS_DEVERR ? "Device Error " : "",\r\n!(data & HST_STS_DONE) ? "Transaction Never Finished " : "");\r\nreturn status;\r\n}\r\nstatic int ali1563_block(struct i2c_adapter *a,\r\nunion i2c_smbus_data *data, u8 rw)\r\n{\r\nint i, len;\r\nint error = 0;\r\noutb_p(HST_CNTL1_LAST, SMB_HST_CNTL1);\r\nif (rw == I2C_SMBUS_WRITE) {\r\nlen = data->block[0];\r\nif (len < 1)\r\nlen = 1;\r\nelse if (len > 32)\r\nlen = 32;\r\noutb_p(len, SMB_HST_DAT0);\r\noutb_p(data->block[1], SMB_BLK_DAT);\r\n} else\r\nlen = 32;\r\noutb_p(inb_p(SMB_HST_CNTL2) | HST_CNTL2_BLOCK, SMB_HST_CNTL2);\r\nfor (i = 0; i < len; i++) {\r\nif (rw == I2C_SMBUS_WRITE) {\r\noutb_p(data->block[i + 1], SMB_BLK_DAT);\r\nerror = ali1563_block_start(a);\r\nif (error)\r\nbreak;\r\n} else {\r\nerror = ali1563_block_start(a);\r\nif (error)\r\nbreak;\r\nif (i == 0) {\r\nlen = inb_p(SMB_HST_DAT0);\r\nif (len < 1)\r\nlen = 1;\r\nelse if (len > 32)\r\nlen = 32;\r\n}\r\ndata->block[i+1] = inb_p(SMB_BLK_DAT);\r\n}\r\n}\r\noutb_p(HST_CNTL1_LAST, SMB_HST_CNTL1);\r\nreturn error;\r\n}\r\nstatic s32 ali1563_access(struct i2c_adapter *a, u16 addr,\r\nunsigned short flags, char rw, u8 cmd,\r\nint size, union i2c_smbus_data *data)\r\n{\r\nint error = 0;\r\nint timeout;\r\nu32 reg;\r\nfor (timeout = ALI1563_MAX_TIMEOUT; timeout; timeout--) {\r\nreg = inb_p(SMB_HST_STS);\r\nif (!(reg & HST_STS_BUSY))\r\nbreak;\r\n}\r\nif (!timeout)\r\ndev_warn(&a->dev, "SMBus not idle. HST_STS = %02x\n", reg);\r\noutb_p(0xff, SMB_HST_STS);\r\nswitch (size) {\r\ncase I2C_SMBUS_QUICK:\r\nsize = HST_CNTL2_QUICK;\r\nbreak;\r\ncase I2C_SMBUS_BYTE:\r\nsize = HST_CNTL2_BYTE;\r\nbreak;\r\ncase I2C_SMBUS_BYTE_DATA:\r\nsize = HST_CNTL2_BYTE_DATA;\r\nbreak;\r\ncase I2C_SMBUS_WORD_DATA:\r\nsize = HST_CNTL2_WORD_DATA;\r\nbreak;\r\ncase I2C_SMBUS_BLOCK_DATA:\r\nsize = HST_CNTL2_BLOCK;\r\nbreak;\r\ndefault:\r\ndev_warn(&a->dev, "Unsupported transaction %d\n", size);\r\nerror = -EOPNOTSUPP;\r\ngoto Done;\r\n}\r\noutb_p(((addr & 0x7f) << 1) | (rw & 0x01), SMB_HST_ADD);\r\noutb_p((inb_p(SMB_HST_CNTL2) & ~HST_CNTL2_SIZEMASK) |\r\n(size << 3), SMB_HST_CNTL2);\r\nswitch (size) {\r\ncase HST_CNTL2_BYTE:\r\nif (rw == I2C_SMBUS_WRITE)\r\noutb_p(cmd, SMB_HST_DAT0);\r\nbreak;\r\ncase HST_CNTL2_BYTE_DATA:\r\noutb_p(cmd, SMB_HST_CMD);\r\nif (rw == I2C_SMBUS_WRITE)\r\noutb_p(data->byte, SMB_HST_DAT0);\r\nbreak;\r\ncase HST_CNTL2_WORD_DATA:\r\noutb_p(cmd, SMB_HST_CMD);\r\nif (rw == I2C_SMBUS_WRITE) {\r\noutb_p(data->word & 0xff, SMB_HST_DAT0);\r\noutb_p((data->word & 0xff00) >> 8, SMB_HST_DAT1);\r\n}\r\nbreak;\r\ncase HST_CNTL2_BLOCK:\r\noutb_p(cmd, SMB_HST_CMD);\r\nerror = ali1563_block(a, data, rw);\r\ngoto Done;\r\n}\r\nerror = ali1563_transaction(a, size);\r\nif (error)\r\ngoto Done;\r\nif ((rw == I2C_SMBUS_WRITE) || (size == HST_CNTL2_QUICK))\r\ngoto Done;\r\nswitch (size) {\r\ncase HST_CNTL2_BYTE:\r\ndata->byte = inb_p(SMB_HST_DAT0);\r\nbreak;\r\ncase HST_CNTL2_BYTE_DATA:\r\ndata->byte = inb_p(SMB_HST_DAT0);\r\nbreak;\r\ncase HST_CNTL2_WORD_DATA:\r\ndata->word = inb_p(SMB_HST_DAT0) + (inb_p(SMB_HST_DAT1) << 8);\r\nbreak;\r\n}\r\nDone:\r\nreturn error;\r\n}\r\nstatic u32 ali1563_func(struct i2c_adapter *a)\r\n{\r\nreturn I2C_FUNC_SMBUS_QUICK | I2C_FUNC_SMBUS_BYTE |\r\nI2C_FUNC_SMBUS_BYTE_DATA | I2C_FUNC_SMBUS_WORD_DATA |\r\nI2C_FUNC_SMBUS_BLOCK_DATA;\r\n}\r\nstatic int ali1563_setup(struct pci_dev *dev)\r\n{\r\nu16 ctrl;\r\npci_read_config_word(dev, ALI1563_SMBBA, &ctrl);\r\nali1563_smba = ctrl & ~(ALI1563_SMB_IOSIZE - 1);\r\nif (!ali1563_smba) {\r\ndev_warn(&dev->dev, "ali1563_smba Uninitialized\n");\r\ngoto Err;\r\n}\r\nif (!(ctrl & ALI1563_SMB_HOSTEN)) {\r\ndev_warn(&dev->dev, "Host Controller not enabled\n");\r\ngoto Err;\r\n}\r\nif (!(ctrl & ALI1563_SMB_IOEN)) {\r\ndev_warn(&dev->dev, "I/O space not enabled, trying manually\n");\r\npci_write_config_word(dev, ALI1563_SMBBA,\r\nctrl | ALI1563_SMB_IOEN);\r\npci_read_config_word(dev, ALI1563_SMBBA, &ctrl);\r\nif (!(ctrl & ALI1563_SMB_IOEN)) {\r\ndev_err(&dev->dev,\r\n"I/O space still not enabled, giving up\n");\r\ngoto Err;\r\n}\r\n}\r\nif (acpi_check_region(ali1563_smba, ALI1563_SMB_IOSIZE,\r\nali1563_pci_driver.name))\r\ngoto Err;\r\nif (!request_region(ali1563_smba, ALI1563_SMB_IOSIZE,\r\nali1563_pci_driver.name)) {\r\ndev_err(&dev->dev, "Could not allocate I/O space at 0x%04x\n",\r\nali1563_smba);\r\ngoto Err;\r\n}\r\ndev_info(&dev->dev, "Found ALi1563 SMBus at 0x%04x\n", ali1563_smba);\r\nreturn 0;\r\nErr:\r\nreturn -ENODEV;\r\n}\r\nstatic void ali1563_shutdown(struct pci_dev *dev)\r\n{\r\nrelease_region(ali1563_smba, ALI1563_SMB_IOSIZE);\r\n}\r\nstatic int ali1563_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id_table)\r\n{\r\nint error;\r\nerror = ali1563_setup(dev);\r\nif (error)\r\ngoto exit;\r\nali1563_adapter.dev.parent = &dev->dev;\r\nsnprintf(ali1563_adapter.name, sizeof(ali1563_adapter.name),\r\n"SMBus ALi 1563 Adapter @ %04x", ali1563_smba);\r\nerror = i2c_add_adapter(&ali1563_adapter);\r\nif (error)\r\ngoto exit_shutdown;\r\nreturn 0;\r\nexit_shutdown:\r\nali1563_shutdown(dev);\r\nexit:\r\ndev_warn(&dev->dev, "ALi1563 SMBus probe failed (%d)\n", error);\r\nreturn error;\r\n}\r\nstatic void ali1563_remove(struct pci_dev *dev)\r\n{\r\ni2c_del_adapter(&ali1563_adapter);\r\nali1563_shutdown(dev);\r\n}

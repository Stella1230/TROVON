void rose_start_heartbeat(struct sock *sk)\r\n{\r\ndel_timer(&sk->sk_timer);\r\nsk->sk_timer.data = (unsigned long)sk;\r\nsk->sk_timer.function = &rose_heartbeat_expiry;\r\nsk->sk_timer.expires = jiffies + 5 * HZ;\r\nadd_timer(&sk->sk_timer);\r\n}\r\nvoid rose_start_t1timer(struct sock *sk)\r\n{\r\nstruct rose_sock *rose = rose_sk(sk);\r\ndel_timer(&rose->timer);\r\nrose->timer.data = (unsigned long)sk;\r\nrose->timer.function = &rose_timer_expiry;\r\nrose->timer.expires = jiffies + rose->t1;\r\nadd_timer(&rose->timer);\r\n}\r\nvoid rose_start_t2timer(struct sock *sk)\r\n{\r\nstruct rose_sock *rose = rose_sk(sk);\r\ndel_timer(&rose->timer);\r\nrose->timer.data = (unsigned long)sk;\r\nrose->timer.function = &rose_timer_expiry;\r\nrose->timer.expires = jiffies + rose->t2;\r\nadd_timer(&rose->timer);\r\n}\r\nvoid rose_start_t3timer(struct sock *sk)\r\n{\r\nstruct rose_sock *rose = rose_sk(sk);\r\ndel_timer(&rose->timer);\r\nrose->timer.data = (unsigned long)sk;\r\nrose->timer.function = &rose_timer_expiry;\r\nrose->timer.expires = jiffies + rose->t3;\r\nadd_timer(&rose->timer);\r\n}\r\nvoid rose_start_hbtimer(struct sock *sk)\r\n{\r\nstruct rose_sock *rose = rose_sk(sk);\r\ndel_timer(&rose->timer);\r\nrose->timer.data = (unsigned long)sk;\r\nrose->timer.function = &rose_timer_expiry;\r\nrose->timer.expires = jiffies + rose->hb;\r\nadd_timer(&rose->timer);\r\n}\r\nvoid rose_start_idletimer(struct sock *sk)\r\n{\r\nstruct rose_sock *rose = rose_sk(sk);\r\ndel_timer(&rose->idletimer);\r\nif (rose->idle > 0) {\r\nrose->idletimer.data = (unsigned long)sk;\r\nrose->idletimer.function = &rose_idletimer_expiry;\r\nrose->idletimer.expires = jiffies + rose->idle;\r\nadd_timer(&rose->idletimer);\r\n}\r\n}\r\nvoid rose_stop_heartbeat(struct sock *sk)\r\n{\r\ndel_timer(&sk->sk_timer);\r\n}\r\nvoid rose_stop_timer(struct sock *sk)\r\n{\r\ndel_timer(&rose_sk(sk)->timer);\r\n}\r\nvoid rose_stop_idletimer(struct sock *sk)\r\n{\r\ndel_timer(&rose_sk(sk)->idletimer);\r\n}\r\nstatic void rose_heartbeat_expiry(unsigned long param)\r\n{\r\nstruct sock *sk = (struct sock *)param;\r\nstruct rose_sock *rose = rose_sk(sk);\r\nbh_lock_sock(sk);\r\nswitch (rose->state) {\r\ncase ROSE_STATE_0:\r\nif (sock_flag(sk, SOCK_DESTROY) ||\r\n(sk->sk_state == TCP_LISTEN && sock_flag(sk, SOCK_DEAD))) {\r\nbh_unlock_sock(sk);\r\nrose_destroy_socket(sk);\r\nreturn;\r\n}\r\nbreak;\r\ncase ROSE_STATE_3:\r\nif (atomic_read(&sk->sk_rmem_alloc) < (sk->sk_rcvbuf / 2) &&\r\n(rose->condition & ROSE_COND_OWN_RX_BUSY)) {\r\nrose->condition &= ~ROSE_COND_OWN_RX_BUSY;\r\nrose->condition &= ~ROSE_COND_ACK_PENDING;\r\nrose->vl = rose->vr;\r\nrose_write_internal(sk, ROSE_RR);\r\nrose_stop_timer(sk);\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nrose_start_heartbeat(sk);\r\nbh_unlock_sock(sk);\r\n}\r\nstatic void rose_timer_expiry(unsigned long param)\r\n{\r\nstruct sock *sk = (struct sock *)param;\r\nstruct rose_sock *rose = rose_sk(sk);\r\nbh_lock_sock(sk);\r\nswitch (rose->state) {\r\ncase ROSE_STATE_1:\r\ncase ROSE_STATE_4:\r\nrose_write_internal(sk, ROSE_CLEAR_REQUEST);\r\nrose->state = ROSE_STATE_2;\r\nrose_start_t3timer(sk);\r\nbreak;\r\ncase ROSE_STATE_2:\r\nrose->neighbour->use--;\r\nrose_disconnect(sk, ETIMEDOUT, -1, -1);\r\nbreak;\r\ncase ROSE_STATE_3:\r\nif (rose->condition & ROSE_COND_ACK_PENDING) {\r\nrose->condition &= ~ROSE_COND_ACK_PENDING;\r\nrose_enquiry_response(sk);\r\n}\r\nbreak;\r\n}\r\nbh_unlock_sock(sk);\r\n}\r\nstatic void rose_idletimer_expiry(unsigned long param)\r\n{\r\nstruct sock *sk = (struct sock *)param;\r\nbh_lock_sock(sk);\r\nrose_clear_queues(sk);\r\nrose_write_internal(sk, ROSE_CLEAR_REQUEST);\r\nrose_sk(sk)->state = ROSE_STATE_2;\r\nrose_start_t3timer(sk);\r\nsk->sk_state = TCP_CLOSE;\r\nsk->sk_err = 0;\r\nsk->sk_shutdown |= SEND_SHUTDOWN;\r\nif (!sock_flag(sk, SOCK_DEAD)) {\r\nsk->sk_state_change(sk);\r\nsock_set_flag(sk, SOCK_DEAD);\r\n}\r\nbh_unlock_sock(sk);\r\n}

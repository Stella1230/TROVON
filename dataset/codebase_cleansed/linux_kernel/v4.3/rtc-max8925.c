static irqreturn_t rtc_update_handler(int irq, void *data)\r\n{\r\nstruct max8925_rtc_info *info = (struct max8925_rtc_info *)data;\r\nmax8925_set_bits(info->rtc, MAX8925_ALARM0_CNTL, 0x7f, 0);\r\nrtc_update_irq(info->rtc_dev, 1, RTC_IRQF | RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int tm_calc(struct rtc_time *tm, unsigned char *buf, int len)\r\n{\r\nif (len < TIME_NUM)\r\nreturn -EINVAL;\r\ntm->tm_year = (buf[RTC_YEAR2] >> 4) * 1000\r\n+ (buf[RTC_YEAR2] & 0xf) * 100\r\n+ (buf[RTC_YEAR1] >> 4) * 10\r\n+ (buf[RTC_YEAR1] & 0xf);\r\ntm->tm_year -= 1900;\r\ntm->tm_mon = ((buf[RTC_MONTH] >> 4) & 0x01) * 10\r\n+ (buf[RTC_MONTH] & 0x0f);\r\ntm->tm_mday = ((buf[RTC_DATE] >> 4) & 0x03) * 10\r\n+ (buf[RTC_DATE] & 0x0f);\r\ntm->tm_wday = buf[RTC_WEEKDAY] & 0x07;\r\nif (buf[RTC_HOUR] & HOUR_12) {\r\ntm->tm_hour = ((buf[RTC_HOUR] >> 4) & 0x1) * 10\r\n+ (buf[RTC_HOUR] & 0x0f);\r\nif (buf[RTC_HOUR] & HOUR_AM_PM)\r\ntm->tm_hour += 12;\r\n} else\r\ntm->tm_hour = ((buf[RTC_HOUR] >> 4) & 0x03) * 10\r\n+ (buf[RTC_HOUR] & 0x0f);\r\ntm->tm_min = ((buf[RTC_MIN] >> 4) & 0x7) * 10\r\n+ (buf[RTC_MIN] & 0x0f);\r\ntm->tm_sec = ((buf[RTC_SEC] >> 4) & 0x7) * 10\r\n+ (buf[RTC_SEC] & 0x0f);\r\nreturn 0;\r\n}\r\nstatic int data_calc(unsigned char *buf, struct rtc_time *tm, int len)\r\n{\r\nunsigned char high, low;\r\nif (len < TIME_NUM)\r\nreturn -EINVAL;\r\nhigh = (tm->tm_year + 1900) / 1000;\r\nlow = (tm->tm_year + 1900) / 100;\r\nlow = low - high * 10;\r\nbuf[RTC_YEAR2] = (high << 4) + low;\r\nhigh = (tm->tm_year + 1900) / 10;\r\nlow = tm->tm_year + 1900;\r\nlow = low - high * 10;\r\nhigh = high - (high / 10) * 10;\r\nbuf[RTC_YEAR1] = (high << 4) + low;\r\nhigh = tm->tm_mon / 10;\r\nlow = tm->tm_mon;\r\nlow = low - high * 10;\r\nbuf[RTC_MONTH] = (high << 4) + low;\r\nhigh = tm->tm_mday / 10;\r\nlow = tm->tm_mday;\r\nlow = low - high * 10;\r\nbuf[RTC_DATE] = (high << 4) + low;\r\nbuf[RTC_WEEKDAY] = tm->tm_wday;\r\nhigh = tm->tm_hour / 10;\r\nlow = tm->tm_hour;\r\nlow = low - high * 10;\r\nbuf[RTC_HOUR] = (high << 4) + low;\r\nhigh = tm->tm_min / 10;\r\nlow = tm->tm_min;\r\nlow = low - high * 10;\r\nbuf[RTC_MIN] = (high << 4) + low;\r\nhigh = tm->tm_sec / 10;\r\nlow = tm->tm_sec;\r\nlow = low - high * 10;\r\nbuf[RTC_SEC] = (high << 4) + low;\r\nreturn 0;\r\n}\r\nstatic int max8925_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct max8925_rtc_info *info = dev_get_drvdata(dev);\r\nunsigned char buf[TIME_NUM];\r\nint ret;\r\nret = max8925_bulk_read(info->rtc, MAX8925_RTC_SEC, TIME_NUM, buf);\r\nif (ret < 0)\r\ngoto out;\r\nret = tm_calc(tm, buf, TIME_NUM);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int max8925_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct max8925_rtc_info *info = dev_get_drvdata(dev);\r\nunsigned char buf[TIME_NUM];\r\nint ret;\r\nret = data_calc(buf, tm, TIME_NUM);\r\nif (ret < 0)\r\ngoto out;\r\nret = max8925_bulk_write(info->rtc, MAX8925_RTC_SEC, TIME_NUM, buf);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int max8925_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct max8925_rtc_info *info = dev_get_drvdata(dev);\r\nunsigned char buf[TIME_NUM];\r\nint ret;\r\nret = max8925_bulk_read(info->rtc, MAX8925_ALARM0_SEC, TIME_NUM, buf);\r\nif (ret < 0)\r\ngoto out;\r\nret = tm_calc(&alrm->time, buf, TIME_NUM);\r\nif (ret < 0)\r\ngoto out;\r\nret = max8925_reg_read(info->rtc, MAX8925_RTC_IRQ_MASK);\r\nif (ret < 0)\r\ngoto out;\r\nif (ret & ALARM0_IRQ) {\r\nalrm->enabled = 0;\r\n} else {\r\nret = max8925_reg_read(info->rtc, MAX8925_ALARM0_CNTL);\r\nif (ret < 0)\r\ngoto out;\r\nif (!ret)\r\nalrm->enabled = 0;\r\nelse\r\nalrm->enabled = 1;\r\n}\r\nret = max8925_reg_read(info->rtc, MAX8925_RTC_STATUS);\r\nif (ret < 0)\r\ngoto out;\r\nif (ret & ALARM0_STATUS)\r\nalrm->pending = 1;\r\nelse\r\nalrm->pending = 0;\r\nreturn 0;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int max8925_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct max8925_rtc_info *info = dev_get_drvdata(dev);\r\nunsigned char buf[TIME_NUM];\r\nint ret;\r\nret = data_calc(buf, &alrm->time, TIME_NUM);\r\nif (ret < 0)\r\ngoto out;\r\nret = max8925_bulk_write(info->rtc, MAX8925_ALARM0_SEC, TIME_NUM, buf);\r\nif (ret < 0)\r\ngoto out;\r\nif (alrm->enabled)\r\nret = max8925_reg_write(info->rtc, MAX8925_ALARM0_CNTL, 0x77);\r\nelse\r\nret = max8925_reg_write(info->rtc, MAX8925_ALARM0_CNTL, 0x0);\r\nif (ret < 0)\r\ngoto out;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int max8925_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct max8925_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct max8925_rtc_info *info;\r\nint ret;\r\ninfo = devm_kzalloc(&pdev->dev, sizeof(struct max8925_rtc_info),\r\nGFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->chip = chip;\r\ninfo->rtc = chip->rtc;\r\ninfo->dev = &pdev->dev;\r\ninfo->irq = platform_get_irq(pdev, 0);\r\nret = devm_request_threaded_irq(&pdev->dev, info->irq, NULL,\r\nrtc_update_handler, IRQF_ONESHOT,\r\n"rtc-alarm0", info);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "Failed to request IRQ: #%d: %d\n",\r\ninfo->irq, ret);\r\nreturn ret;\r\n}\r\ndev_set_drvdata(&pdev->dev, info);\r\nplatform_set_drvdata(pdev, info);\r\ndevice_init_wakeup(&pdev->dev, 1);\r\ninfo->rtc_dev = devm_rtc_device_register(&pdev->dev, "max8925-rtc",\r\n&max8925_rtc_ops, THIS_MODULE);\r\nret = PTR_ERR(info->rtc_dev);\r\nif (IS_ERR(info->rtc_dev)) {\r\ndev_err(&pdev->dev, "Failed to register RTC device: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8925_rtc_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct max8925_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nif (device_may_wakeup(dev))\r\nchip->wakeup_flag |= 1 << MAX8925_IRQ_RTC_ALARM0;\r\nreturn 0;\r\n}\r\nstatic int max8925_rtc_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct max8925_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nif (device_may_wakeup(dev))\r\nchip->wakeup_flag &= ~(1 << MAX8925_IRQ_RTC_ALARM0);\r\nreturn 0;\r\n}

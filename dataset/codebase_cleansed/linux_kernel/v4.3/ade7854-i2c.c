static int ade7854_i2c_write_reg_8(struct device *dev,\r\nu16 reg_address,\r\nu8 value)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = (reg_address >> 8) & 0xFF;\r\nst->tx[1] = reg_address & 0xFF;\r\nst->tx[2] = value;\r\nret = i2c_master_send(st->i2c, st->tx, 3);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_i2c_write_reg_16(struct device *dev,\r\nu16 reg_address,\r\nu16 value)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = (reg_address >> 8) & 0xFF;\r\nst->tx[1] = reg_address & 0xFF;\r\nst->tx[2] = (value >> 8) & 0xFF;\r\nst->tx[3] = value & 0xFF;\r\nret = i2c_master_send(st->i2c, st->tx, 4);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_i2c_write_reg_24(struct device *dev,\r\nu16 reg_address,\r\nu32 value)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = (reg_address >> 8) & 0xFF;\r\nst->tx[1] = reg_address & 0xFF;\r\nst->tx[2] = (value >> 16) & 0xFF;\r\nst->tx[3] = (value >> 8) & 0xFF;\r\nst->tx[4] = value & 0xFF;\r\nret = i2c_master_send(st->i2c, st->tx, 5);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_i2c_write_reg_32(struct device *dev,\r\nu16 reg_address,\r\nu32 value)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = (reg_address >> 8) & 0xFF;\r\nst->tx[1] = reg_address & 0xFF;\r\nst->tx[2] = (value >> 24) & 0xFF;\r\nst->tx[3] = (value >> 16) & 0xFF;\r\nst->tx[4] = (value >> 8) & 0xFF;\r\nst->tx[5] = value & 0xFF;\r\nret = i2c_master_send(st->i2c, st->tx, 6);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_i2c_read_reg_8(struct device *dev,\r\nu16 reg_address,\r\nu8 *val)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nint ret;\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = (reg_address >> 8) & 0xFF;\r\nst->tx[1] = reg_address & 0xFF;\r\nret = i2c_master_send(st->i2c, st->tx, 2);\r\nif (ret)\r\ngoto out;\r\nret = i2c_master_recv(st->i2c, st->rx, 1);\r\nif (ret)\r\ngoto out;\r\n*val = st->rx[0];\r\nout:\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_i2c_read_reg_16(struct device *dev,\r\nu16 reg_address,\r\nu16 *val)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nint ret;\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = (reg_address >> 8) & 0xFF;\r\nst->tx[1] = reg_address & 0xFF;\r\nret = i2c_master_send(st->i2c, st->tx, 2);\r\nif (ret)\r\ngoto out;\r\nret = i2c_master_recv(st->i2c, st->rx, 2);\r\nif (ret)\r\ngoto out;\r\n*val = (st->rx[0] << 8) | st->rx[1];\r\nout:\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_i2c_read_reg_24(struct device *dev,\r\nu16 reg_address,\r\nu32 *val)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nint ret;\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = (reg_address >> 8) & 0xFF;\r\nst->tx[1] = reg_address & 0xFF;\r\nret = i2c_master_send(st->i2c, st->tx, 2);\r\nif (ret)\r\ngoto out;\r\nret = i2c_master_recv(st->i2c, st->rx, 3);\r\nif (ret)\r\ngoto out;\r\n*val = (st->rx[0] << 16) | (st->rx[1] << 8) | st->rx[2];\r\nout:\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_i2c_read_reg_32(struct device *dev,\r\nu16 reg_address,\r\nu32 *val)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nint ret;\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = (reg_address >> 8) & 0xFF;\r\nst->tx[1] = reg_address & 0xFF;\r\nret = i2c_master_send(st->i2c, st->tx, 2);\r\nif (ret)\r\ngoto out;\r\nret = i2c_master_recv(st->i2c, st->rx, 3);\r\nif (ret)\r\ngoto out;\r\n*val = (st->rx[0] << 24) | (st->rx[1] << 16) |\r\n(st->rx[2] << 8) | st->rx[3];\r\nout:\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct ade7854_state *st;\r\nstruct iio_dev *indio_dev;\r\nindio_dev = devm_iio_device_alloc(&client->dev, sizeof(*st));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\nst = iio_priv(indio_dev);\r\ni2c_set_clientdata(client, indio_dev);\r\nst->read_reg_8 = ade7854_i2c_read_reg_8;\r\nst->read_reg_16 = ade7854_i2c_read_reg_16;\r\nst->read_reg_24 = ade7854_i2c_read_reg_24;\r\nst->read_reg_32 = ade7854_i2c_read_reg_32;\r\nst->write_reg_8 = ade7854_i2c_write_reg_8;\r\nst->write_reg_16 = ade7854_i2c_write_reg_16;\r\nst->write_reg_24 = ade7854_i2c_write_reg_24;\r\nst->write_reg_32 = ade7854_i2c_write_reg_32;\r\nst->i2c = client;\r\nst->irq = client->irq;\r\nreturn ade7854_probe(indio_dev, &client->dev);\r\n}\r\nstatic int ade7854_i2c_remove(struct i2c_client *client)\r\n{\r\nreturn ade7854_remove(i2c_get_clientdata(client));\r\n}

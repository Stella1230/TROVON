static u8 read_reg(u8 addr, u8 port)\r\n{\r\noutb(addr, port);\r\nreturn inb(port + 1);\r\n}\r\nstatic void write_reg(u8 data, u8 addr, u8 port)\r\n{\r\noutb(addr, port);\r\noutb(data, port + 1);\r\n}\r\nstatic void enter_conf_mode(u8 port)\r\n{\r\noutb(0x87, port);\r\noutb(0x61, port);\r\noutb(0x55, port);\r\noutb((port == 0x2e) ? 0x55 : 0xaa, port);\r\n}\r\nstatic void exit_conf_mode(u8 port)\r\n{\r\noutb(0x2, port);\r\noutb(0x2, port + 1);\r\n}\r\nstatic void enter_gpio_mode(u8 port)\r\n{\r\nwrite_reg(0x2, 0x7, port);\r\n}\r\nstatic int it8761e_gpio_get(struct gpio_chip *gc, unsigned gpio_num)\r\n{\r\nu16 reg;\r\nu8 bit;\r\nbit = gpio_num % 8;\r\nreg = (gpio_num >= 8) ? gpio_ba + 1 : gpio_ba;\r\nreturn !!(inb(reg) & (1 << bit));\r\n}\r\nstatic int it8761e_gpio_direction_in(struct gpio_chip *gc, unsigned gpio_num)\r\n{\r\nu8 curr_dirs;\r\nu8 io_reg, bit;\r\nbit = gpio_num % 8;\r\nio_reg = (gpio_num >= 8) ? GPIO2X_IO : GPIO1X_IO;\r\nspin_lock(&sio_lock);\r\nenter_conf_mode(port);\r\nenter_gpio_mode(port);\r\ncurr_dirs = read_reg(io_reg, port);\r\nif (curr_dirs & (1 << bit))\r\nwrite_reg(curr_dirs & ~(1 << bit), io_reg, port);\r\nexit_conf_mode(port);\r\nspin_unlock(&sio_lock);\r\nreturn 0;\r\n}\r\nstatic void it8761e_gpio_set(struct gpio_chip *gc,\r\nunsigned gpio_num, int val)\r\n{\r\nu8 curr_vals, bit;\r\nu16 reg;\r\nbit = gpio_num % 8;\r\nreg = (gpio_num >= 8) ? gpio_ba + 1 : gpio_ba;\r\nspin_lock(&sio_lock);\r\ncurr_vals = inb(reg);\r\nif (val)\r\noutb(curr_vals | (1 << bit), reg);\r\nelse\r\noutb(curr_vals & ~(1 << bit), reg);\r\nspin_unlock(&sio_lock);\r\n}\r\nstatic int it8761e_gpio_direction_out(struct gpio_chip *gc,\r\nunsigned gpio_num, int val)\r\n{\r\nu8 curr_dirs, io_reg, bit;\r\nbit = gpio_num % 8;\r\nio_reg = (gpio_num >= 8) ? GPIO2X_IO : GPIO1X_IO;\r\nit8761e_gpio_set(gc, gpio_num, val);\r\nspin_lock(&sio_lock);\r\nenter_conf_mode(port);\r\nenter_gpio_mode(port);\r\ncurr_dirs = read_reg(io_reg, port);\r\nif (!(curr_dirs & (1 << bit)))\r\nwrite_reg(curr_dirs | (1 << bit), io_reg, port);\r\nexit_conf_mode(port);\r\nspin_unlock(&sio_lock);\r\nreturn 0;\r\n}\r\nstatic int __init it8761e_gpio_init(void)\r\n{\r\nint i, id, err;\r\nfor (i = 0; i < ARRAY_SIZE(ports); i++) {\r\nspin_lock(&sio_lock);\r\nenter_conf_mode(ports[i]);\r\nid = (read_reg(CHIP_ID_HIGH_BYTE, ports[i]) << 8) +\r\nread_reg(CHIP_ID_LOW_BYTE, ports[i]);\r\nexit_conf_mode(ports[i]);\r\nspin_unlock(&sio_lock);\r\nif (id == SIO_CHIP_ID) {\r\nport = ports[i];\r\nbreak;\r\n}\r\n}\r\nif (!port)\r\nreturn -ENODEV;\r\nenter_conf_mode(port);\r\nenter_gpio_mode(port);\r\ngpio_ba = (read_reg(GPIO_BA_HIGH_BYTE, port) << 8) +\r\nread_reg(GPIO_BA_LOW_BYTE, port);\r\nexit_conf_mode(port);\r\nif (!request_region(gpio_ba, GPIO_IOSIZE, GPIO_NAME))\r\nreturn -EBUSY;\r\nit8761e_gpio_chip.base = -1;\r\nit8761e_gpio_chip.ngpio = 16;\r\nerr = gpiochip_add(&it8761e_gpio_chip);\r\nif (err < 0)\r\ngoto gpiochip_add_err;\r\nreturn 0;\r\ngpiochip_add_err:\r\nrelease_region(gpio_ba, GPIO_IOSIZE);\r\ngpio_ba = 0;\r\nreturn err;\r\n}\r\nstatic void __exit it8761e_gpio_exit(void)\r\n{\r\nif (gpio_ba) {\r\ngpiochip_remove(&it8761e_gpio_chip);\r\nrelease_region(gpio_ba, GPIO_IOSIZE);\r\ngpio_ba = 0;\r\n}\r\n}

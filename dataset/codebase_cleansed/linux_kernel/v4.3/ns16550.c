static int ns16550_open(void)\r\n{\r\nout_8(reg_base + (UART_FCR << reg_shift), 0x06);\r\nreturn 0;\r\n}\r\nstatic void ns16550_putc(unsigned char c)\r\n{\r\nwhile ((in_8(reg_base + (UART_LSR << reg_shift)) & UART_LSR_THRE) == 0);\r\nout_8(reg_base, c);\r\n}\r\nstatic unsigned char ns16550_getc(void)\r\n{\r\nwhile ((in_8(reg_base + (UART_LSR << reg_shift)) & UART_LSR_DR) == 0);\r\nreturn in_8(reg_base);\r\n}\r\nstatic u8 ns16550_tstc(void)\r\n{\r\nreturn ((in_8(reg_base + (UART_LSR << reg_shift)) & UART_LSR_DR) != 0);\r\n}\r\nint ns16550_console_init(void *devp, struct serial_console_data *scdp)\r\n{\r\nint n;\r\nu32 reg_offset;\r\nif (dt_get_virtual_reg(devp, (void **)&reg_base, 1) < 1)\r\nreturn -1;\r\nn = getprop(devp, "reg-offset", &reg_offset, sizeof(reg_offset));\r\nif (n == sizeof(reg_offset))\r\nreg_base += reg_offset;\r\nn = getprop(devp, "reg-shift", &reg_shift, sizeof(reg_shift));\r\nif (n != sizeof(reg_shift))\r\nreg_shift = 0;\r\nscdp->open = ns16550_open;\r\nscdp->putc = ns16550_putc;\r\nscdp->getc = ns16550_getc;\r\nscdp->tstc = ns16550_tstc;\r\nscdp->close = NULL;\r\nreturn 0;\r\n}

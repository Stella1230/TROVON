ssize_t v9fs_fid_xattr_get(struct p9_fid *fid, const char *name,\r\nvoid *buffer, size_t buffer_size)\r\n{\r\nssize_t retval;\r\nu64 attr_size;\r\nstruct p9_fid *attr_fid;\r\nstruct kvec kvec = {.iov_base = buffer, .iov_len = buffer_size};\r\nstruct iov_iter to;\r\nint err;\r\niov_iter_kvec(&to, READ | ITER_KVEC, &kvec, 1, buffer_size);\r\nattr_fid = p9_client_xattrwalk(fid, name, &attr_size);\r\nif (IS_ERR(attr_fid)) {\r\nretval = PTR_ERR(attr_fid);\r\np9_debug(P9_DEBUG_VFS, "p9_client_attrwalk failed %zd\n",\r\nretval);\r\nreturn retval;\r\n}\r\nif (attr_size > buffer_size) {\r\nif (!buffer_size)\r\nretval = attr_size;\r\nelse\r\nretval = -ERANGE;\r\n} else {\r\niov_iter_truncate(&to, attr_size);\r\nretval = p9_client_read(attr_fid, 0, &to, &err);\r\nif (err)\r\nretval = err;\r\n}\r\np9_client_clunk(attr_fid);\r\nreturn retval;\r\n}\r\nssize_t v9fs_xattr_get(struct dentry *dentry, const char *name,\r\nvoid *buffer, size_t buffer_size)\r\n{\r\nstruct p9_fid *fid;\r\np9_debug(P9_DEBUG_VFS, "name = %s value_len = %zu\n",\r\nname, buffer_size);\r\nfid = v9fs_fid_lookup(dentry);\r\nif (IS_ERR(fid))\r\nreturn PTR_ERR(fid);\r\nreturn v9fs_fid_xattr_get(fid, name, buffer, buffer_size);\r\n}\r\nint v9fs_xattr_set(struct dentry *dentry, const char *name,\r\nconst void *value, size_t value_len, int flags)\r\n{\r\nstruct p9_fid *fid = v9fs_fid_lookup(dentry);\r\nif (IS_ERR(fid))\r\nreturn PTR_ERR(fid);\r\nreturn v9fs_fid_xattr_set(fid, name, value, value_len, flags);\r\n}\r\nint v9fs_fid_xattr_set(struct p9_fid *fid, const char *name,\r\nconst void *value, size_t value_len, int flags)\r\n{\r\nstruct kvec kvec = {.iov_base = (void *)value, .iov_len = value_len};\r\nstruct iov_iter from;\r\nint retval;\r\niov_iter_kvec(&from, WRITE | ITER_KVEC, &kvec, 1, value_len);\r\np9_debug(P9_DEBUG_VFS, "name = %s value_len = %zu flags = %d\n",\r\nname, value_len, flags);\r\nfid = p9_client_walk(fid, 0, NULL, 1);\r\nif (IS_ERR(fid))\r\nreturn PTR_ERR(fid);\r\nretval = p9_client_xattrcreate(fid, name, value_len, flags);\r\nif (retval < 0)\r\np9_debug(P9_DEBUG_VFS, "p9_client_xattrcreate failed %d\n",\r\nretval);\r\nelse\r\np9_client_write(fid, 0, &from, &retval);\r\np9_client_clunk(fid);\r\nreturn retval;\r\n}\r\nssize_t v9fs_listxattr(struct dentry *dentry, char *buffer, size_t buffer_size)\r\n{\r\nreturn v9fs_xattr_get(dentry, NULL, buffer, buffer_size);\r\n}

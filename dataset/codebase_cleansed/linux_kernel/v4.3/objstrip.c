static void\r\nusage (void)\r\n{\r\nfprintf(stderr,\r\n"usage: %s [-v] -p file primary\n"\r\n" %s [-vb] file [secondary]\n", prog_name, prog_name);\r\nexit(1);\r\n}\r\nint\r\nmain (int argc, char *argv[])\r\n{\r\nsize_t nwritten, tocopy, n, mem_size, fil_size, pad = 0;\r\nint fd, ofd, i, j, verbose = 0, primary = 0;\r\nchar buf[8192], *inname;\r\nstruct exec * aout;\r\nlong offset;\r\n#ifdef __ELF__\r\nstruct elfhdr *elf;\r\nstruct elf_phdr *elf_phdr;\r\nunsigned long long e_entry;\r\n#endif\r\nprog_name = argv[0];\r\nfor (i = 1; i < argc && argv[i][0] == '-'; ++i) {\r\nfor (j = 1; argv[i][j]; ++j) {\r\nswitch (argv[i][j]) {\r\ncase 'v':\r\nverbose = ~verbose;\r\nbreak;\r\ncase 'b':\r\npad = BLOCK_SIZE;\r\nbreak;\r\ncase 'p':\r\nprimary = 1;\r\nbreak;\r\n}\r\n}\r\n}\r\nif (i >= argc) {\r\nusage();\r\n}\r\ninname = argv[i++];\r\nfd = open(inname, O_RDONLY);\r\nif (fd == -1) {\r\nperror("open");\r\nexit(1);\r\n}\r\nofd = 1;\r\nif (i < argc) {\r\nofd = open(argv[i++], O_WRONLY | O_CREAT | O_TRUNC, 0666);\r\nif (ofd == -1) {\r\nperror("open");\r\nexit(1);\r\n}\r\n}\r\nif (primary) {\r\nunsigned long bb[64], sum = 0;\r\nstruct stat st;\r\noff_t size;\r\nint i;\r\nif (ofd == 1) {\r\nusage();\r\n}\r\nif (fstat(fd, &st) == -1) {\r\nperror("fstat");\r\nexit(1);\r\n}\r\nsize = (st.st_size + BLOCK_SIZE - 1) & ~(BLOCK_SIZE - 1);\r\nmemset(bb, 0, sizeof(bb));\r\nstrcpy((char *) bb, "Linux SRM bootblock");\r\nbb[60] = size / BLOCK_SIZE;\r\nbb[61] = 1;\r\nbb[62] = 0;\r\nfor (i = 0; i < 63; ++i) {\r\nsum += bb[i];\r\n}\r\nbb[63] = sum;\r\nif (write(ofd, bb, sizeof(bb)) != sizeof(bb)) {\r\nperror("boot-block write");\r\nexit(1);\r\n}\r\nprintf("%lu\n", size);\r\nreturn 0;\r\n}\r\nif (read(fd, buf, sizeof(buf)) < 0) {\r\nperror("read");\r\nexit(1);\r\n}\r\n#ifdef __ELF__\r\nelf = (struct elfhdr *) buf;\r\nif (elf->e_ident[0] == 0x7f && strncmp((char *)elf->e_ident + 1, "ELF", 3) == 0) {\r\nif (elf->e_type != ET_EXEC) {\r\nfprintf(stderr, "%s: %s is not an ELF executable\n",\r\nprog_name, inname);\r\nexit(1);\r\n}\r\nif (!elf_check_arch(elf)) {\r\nfprintf(stderr, "%s: is not for this processor (e_machine=%d)\n",\r\nprog_name, elf->e_machine);\r\nexit(1);\r\n}\r\nif (elf->e_phnum != 1) {\r\nfprintf(stderr,\r\n"%s: %d program headers (forgot to link with -N?)\n",\r\nprog_name, elf->e_phnum);\r\n}\r\ne_entry = elf->e_entry;\r\nlseek(fd, elf->e_phoff, SEEK_SET);\r\nif (read(fd, buf, sizeof(*elf_phdr)) != sizeof(*elf_phdr)) {\r\nperror("read");\r\nexit(1);\r\n}\r\nelf_phdr = (struct elf_phdr *) buf;\r\noffset = elf_phdr->p_offset;\r\nmem_size = elf_phdr->p_memsz;\r\nfil_size = elf_phdr->p_filesz;\r\nif (elf_phdr->p_vaddr < e_entry) {\r\nunsigned long delta = e_entry - elf_phdr->p_vaddr;\r\noffset += delta;\r\nmem_size -= delta;\r\nfil_size -= delta;\r\nelf_phdr->p_vaddr += delta;\r\n}\r\nif (verbose) {\r\nfprintf(stderr, "%s: extracting %#016lx-%#016lx (at %lx)\n",\r\nprog_name, (long) elf_phdr->p_vaddr,\r\nelf_phdr->p_vaddr + fil_size, offset);\r\n}\r\n} else\r\n#endif\r\n{\r\naout = (struct exec *) buf;\r\nif (!(aout->fh.f_flags & COFF_F_EXEC)) {\r\nfprintf(stderr, "%s: %s is not in executable format\n",\r\nprog_name, inname);\r\nexit(1);\r\n}\r\nif (aout->fh.f_opthdr != sizeof(aout->ah)) {\r\nfprintf(stderr, "%s: %s has unexpected optional header size\n",\r\nprog_name, inname);\r\nexit(1);\r\n}\r\nif (N_MAGIC(*aout) != OMAGIC) {\r\nfprintf(stderr, "%s: %s is not an OMAGIC file\n",\r\nprog_name, inname);\r\nexit(1);\r\n}\r\noffset = N_TXTOFF(*aout);\r\nfil_size = aout->ah.tsize + aout->ah.dsize;\r\nmem_size = fil_size + aout->ah.bsize;\r\nif (verbose) {\r\nfprintf(stderr, "%s: extracting %#016lx-%#016lx (at %lx)\n",\r\nprog_name, aout->ah.text_start,\r\naout->ah.text_start + fil_size, offset);\r\n}\r\n}\r\nif (lseek(fd, offset, SEEK_SET) != offset) {\r\nperror("lseek");\r\nexit(1);\r\n}\r\nif (verbose) {\r\nfprintf(stderr, "%s: copying %lu byte from %s\n",\r\nprog_name, (unsigned long) fil_size, inname);\r\n}\r\ntocopy = fil_size;\r\nwhile (tocopy > 0) {\r\nn = tocopy;\r\nif (n > sizeof(buf)) {\r\nn = sizeof(buf);\r\n}\r\ntocopy -= n;\r\nif ((size_t) read(fd, buf, n) != n) {\r\nperror("read");\r\nexit(1);\r\n}\r\ndo {\r\nnwritten = write(ofd, buf, n);\r\nif ((ssize_t) nwritten == -1) {\r\nperror("write");\r\nexit(1);\r\n}\r\nn -= nwritten;\r\n} while (n > 0);\r\n}\r\nif (pad) {\r\nmem_size = ((mem_size + pad - 1) / pad) * pad;\r\n}\r\ntocopy = mem_size - fil_size;\r\nif (tocopy > 0) {\r\nfprintf(stderr,\r\n"%s: zero-filling bss and aligning to %lu with %lu bytes\n",\r\nprog_name, pad, (unsigned long) tocopy);\r\nmemset(buf, 0x00, sizeof(buf));\r\ndo {\r\nn = tocopy;\r\nif (n > sizeof(buf)) {\r\nn = sizeof(buf);\r\n}\r\nnwritten = write(ofd, buf, n);\r\nif ((ssize_t) nwritten == -1) {\r\nperror("write");\r\nexit(1);\r\n}\r\ntocopy -= nwritten;\r\n} while (tocopy > 0);\r\n}\r\nreturn 0;\r\n}

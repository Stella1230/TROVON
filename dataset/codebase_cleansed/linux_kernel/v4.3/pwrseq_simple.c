static void mmc_pwrseq_simple_set_gpios_value(struct mmc_pwrseq_simple *pwrseq,\r\nint value)\r\n{\r\nint i;\r\nfor (i = 0; i < pwrseq->nr_gpios; i++)\r\nif (!IS_ERR(pwrseq->reset_gpios[i]))\r\ngpiod_set_value_cansleep(pwrseq->reset_gpios[i], value);\r\n}\r\nstatic void mmc_pwrseq_simple_pre_power_on(struct mmc_host *host)\r\n{\r\nstruct mmc_pwrseq_simple *pwrseq = container_of(host->pwrseq,\r\nstruct mmc_pwrseq_simple, pwrseq);\r\nif (!IS_ERR(pwrseq->ext_clk) && !pwrseq->clk_enabled) {\r\nclk_prepare_enable(pwrseq->ext_clk);\r\npwrseq->clk_enabled = true;\r\n}\r\nmmc_pwrseq_simple_set_gpios_value(pwrseq, 1);\r\n}\r\nstatic void mmc_pwrseq_simple_post_power_on(struct mmc_host *host)\r\n{\r\nstruct mmc_pwrseq_simple *pwrseq = container_of(host->pwrseq,\r\nstruct mmc_pwrseq_simple, pwrseq);\r\nmmc_pwrseq_simple_set_gpios_value(pwrseq, 0);\r\n}\r\nstatic void mmc_pwrseq_simple_power_off(struct mmc_host *host)\r\n{\r\nstruct mmc_pwrseq_simple *pwrseq = container_of(host->pwrseq,\r\nstruct mmc_pwrseq_simple, pwrseq);\r\nmmc_pwrseq_simple_set_gpios_value(pwrseq, 1);\r\nif (!IS_ERR(pwrseq->ext_clk) && pwrseq->clk_enabled) {\r\nclk_disable_unprepare(pwrseq->ext_clk);\r\npwrseq->clk_enabled = false;\r\n}\r\n}\r\nstatic void mmc_pwrseq_simple_free(struct mmc_host *host)\r\n{\r\nstruct mmc_pwrseq_simple *pwrseq = container_of(host->pwrseq,\r\nstruct mmc_pwrseq_simple, pwrseq);\r\nint i;\r\nfor (i = 0; i < pwrseq->nr_gpios; i++)\r\nif (!IS_ERR(pwrseq->reset_gpios[i]))\r\ngpiod_put(pwrseq->reset_gpios[i]);\r\nif (!IS_ERR(pwrseq->ext_clk))\r\nclk_put(pwrseq->ext_clk);\r\nkfree(pwrseq);\r\n}\r\nstruct mmc_pwrseq *mmc_pwrseq_simple_alloc(struct mmc_host *host,\r\nstruct device *dev)\r\n{\r\nstruct mmc_pwrseq_simple *pwrseq;\r\nint i, nr_gpios, ret = 0;\r\nnr_gpios = of_gpio_named_count(dev->of_node, "reset-gpios");\r\nif (nr_gpios < 0)\r\nnr_gpios = 0;\r\npwrseq = kzalloc(sizeof(struct mmc_pwrseq_simple) + nr_gpios *\r\nsizeof(struct gpio_desc *), GFP_KERNEL);\r\nif (!pwrseq)\r\nreturn ERR_PTR(-ENOMEM);\r\npwrseq->ext_clk = clk_get(dev, "ext_clock");\r\nif (IS_ERR(pwrseq->ext_clk) &&\r\nPTR_ERR(pwrseq->ext_clk) != -ENOENT) {\r\nret = PTR_ERR(pwrseq->ext_clk);\r\ngoto free;\r\n}\r\nfor (i = 0; i < nr_gpios; i++) {\r\npwrseq->reset_gpios[i] = gpiod_get_index(dev, "reset", i,\r\nGPIOD_OUT_HIGH);\r\nif (IS_ERR(pwrseq->reset_gpios[i]) &&\r\nPTR_ERR(pwrseq->reset_gpios[i]) != -ENOENT &&\r\nPTR_ERR(pwrseq->reset_gpios[i]) != -ENOSYS) {\r\nret = PTR_ERR(pwrseq->reset_gpios[i]);\r\nwhile (i--)\r\ngpiod_put(pwrseq->reset_gpios[i]);\r\ngoto clk_put;\r\n}\r\n}\r\npwrseq->nr_gpios = nr_gpios;\r\npwrseq->pwrseq.ops = &mmc_pwrseq_simple_ops;\r\nreturn &pwrseq->pwrseq;\r\nclk_put:\r\nif (!IS_ERR(pwrseq->ext_clk))\r\nclk_put(pwrseq->ext_clk);\r\nfree:\r\nkfree(pwrseq);\r\nreturn ERR_PTR(ret);\r\n}

static int p970_marked_instr_event(u64 event)\r\n{\r\nint pmc, psel, unit, byte, bit;\r\nunsigned int mask;\r\npmc = (event >> PM_PMC_SH) & PM_PMC_MSK;\r\npsel = event & PM_PMCSEL_MSK;\r\nif (pmc) {\r\nif (direct_marked_event[pmc - 1] & (1 << psel))\r\nreturn 1;\r\nif (psel == 0)\r\nbit = (pmc <= 4)? pmc - 1: 8 - pmc;\r\nelse if (psel == 7 || psel == 13)\r\nbit = 4;\r\nelse\r\nreturn 0;\r\n} else\r\nbit = psel;\r\nbyte = (event >> PM_BYTE_SH) & PM_BYTE_MSK;\r\nunit = (event >> PM_UNIT_SH) & PM_UNIT_MSK;\r\nmask = 0;\r\nswitch (unit) {\r\ncase PM_VPU:\r\nmask = 0x4c;\r\nbreak;\r\ncase PM_LSU0:\r\nmask = 0x085dff00;\r\nbreak;\r\ncase PM_LSU1L:\r\nmask = 0x50 << 24;\r\nbreak;\r\n}\r\nreturn (mask >> (byte * 8 + bit)) & 1;\r\n}\r\nstatic int p970_get_constraint(u64 event, unsigned long *maskp,\r\nunsigned long *valp)\r\n{\r\nint pmc, byte, unit, sh, spcsel;\r\nunsigned long mask = 0, value = 0;\r\nint grp = -1;\r\npmc = (event >> PM_PMC_SH) & PM_PMC_MSK;\r\nif (pmc) {\r\nif (pmc > 8)\r\nreturn -1;\r\nsh = (pmc - 1) * 2;\r\nmask |= 2 << sh;\r\nvalue |= 1 << sh;\r\ngrp = ((pmc - 1) >> 1) & 1;\r\n}\r\nunit = (event >> PM_UNIT_SH) & PM_UNIT_MSK;\r\nif (unit) {\r\nif (unit > PM_LASTUNIT)\r\nreturn -1;\r\nmask |= unit_cons[unit][0];\r\nvalue |= unit_cons[unit][1];\r\nbyte = (event >> PM_BYTE_SH) & PM_BYTE_MSK;\r\nif (!pmc)\r\ngrp = byte & 1;\r\nmask |= 0xfULL << (28 - 4 * byte);\r\nvalue |= (unsigned long)unit << (28 - 4 * byte);\r\n}\r\nif (grp == 0) {\r\nmask |= 0x8000000000ull;\r\nvalue |= 0x1000000000ull;\r\n} else if (grp == 1) {\r\nmask |= 0x800000000ull;\r\nvalue |= 0x100000000ull;\r\n}\r\nspcsel = (event >> PM_SPCSEL_SH) & PM_SPCSEL_MSK;\r\nif (spcsel) {\r\nmask |= 3ull << 48;\r\nvalue |= (unsigned long)spcsel << 48;\r\n}\r\n*maskp = mask;\r\n*valp = value;\r\nreturn 0;\r\n}\r\nstatic int p970_get_alternatives(u64 event, unsigned int flags, u64 alt[])\r\n{\r\nalt[0] = event;\r\nif (event == 0x2002 || event == 0x3002) {\r\nalt[1] = event ^ 0x1000;\r\nreturn 2;\r\n}\r\nreturn 1;\r\n}\r\nstatic int p970_compute_mmcr(u64 event[], int n_ev,\r\nunsigned int hwc[], unsigned long mmcr[], struct perf_event *pevents[])\r\n{\r\nunsigned long mmcr0 = 0, mmcr1 = 0, mmcra = 0;\r\nunsigned int pmc, unit, byte, psel;\r\nunsigned int ttm, grp;\r\nunsigned int pmc_inuse = 0;\r\nunsigned int pmc_grp_use[2];\r\nunsigned char busbyte[4];\r\nunsigned char unituse[16];\r\nunsigned char unitmap[] = { 0, 0<<3, 3<<3, 1<<3, 2<<3, 0|4, 3|4 };\r\nunsigned char ttmuse[2];\r\nunsigned char pmcsel[8];\r\nint i;\r\nint spcsel;\r\nif (n_ev > 8)\r\nreturn -1;\r\npmc_grp_use[0] = pmc_grp_use[1] = 0;\r\nmemset(busbyte, 0, sizeof(busbyte));\r\nmemset(unituse, 0, sizeof(unituse));\r\nfor (i = 0; i < n_ev; ++i) {\r\npmc = (event[i] >> PM_PMC_SH) & PM_PMC_MSK;\r\nif (pmc) {\r\nif (pmc_inuse & (1 << (pmc - 1)))\r\nreturn -1;\r\npmc_inuse |= 1 << (pmc - 1);\r\n++pmc_grp_use[((pmc - 1) >> 1) & 1];\r\n}\r\nunit = (event[i] >> PM_UNIT_SH) & PM_UNIT_MSK;\r\nbyte = (event[i] >> PM_BYTE_SH) & PM_BYTE_MSK;\r\nif (unit) {\r\nif (unit > PM_LASTUNIT)\r\nreturn -1;\r\nif (!pmc)\r\n++pmc_grp_use[byte & 1];\r\nif (busbyte[byte] && busbyte[byte] != unit)\r\nreturn -1;\r\nbusbyte[byte] = unit;\r\nunituse[unit] = 1;\r\n}\r\n}\r\nif (pmc_grp_use[0] > 4 || pmc_grp_use[1] > 4)\r\nreturn -1;\r\nif (unituse[PM_ISU] &\r\n(unituse[PM_FPU] | unituse[PM_IFU] | unituse[PM_VPU]))\r\nunitmap[PM_ISU] = 2 | 4;\r\nttmuse[0] = ttmuse[1] = 0;\r\nfor (i = PM_FPU; i <= PM_STS; ++i) {\r\nif (!unituse[i])\r\ncontinue;\r\nttm = unitmap[i];\r\n++ttmuse[(ttm >> 2) & 1];\r\nmmcr1 |= (unsigned long)(ttm & ~4) << MMCR1_TTM1SEL_SH;\r\n}\r\nif (ttmuse[0] > 1 || ttmuse[1] > 1)\r\nreturn -1;\r\nfor (byte = 0; byte < 4; ++byte) {\r\nunit = busbyte[byte];\r\nif (!unit)\r\ncontinue;\r\nif (unit <= PM_STS)\r\nttm = (unitmap[unit] >> 2) & 1;\r\nelse if (unit == PM_LSU0)\r\nttm = 2;\r\nelse {\r\nttm = 3;\r\nif (unit == PM_LSU1L && byte >= 2)\r\nmmcr1 |= 1ull << (MMCR1_TTM3SEL_SH + 3 - byte);\r\n}\r\nmmcr1 |= (unsigned long)ttm\r\n<< (MMCR1_TD_CP_DBG0SEL_SH - 2 * byte);\r\n}\r\nmemset(pmcsel, 0x8, sizeof(pmcsel));\r\nfor (i = 0; i < n_ev; ++i) {\r\npmc = (event[i] >> PM_PMC_SH) & PM_PMC_MSK;\r\nunit = (event[i] >> PM_UNIT_SH) & PM_UNIT_MSK;\r\nbyte = (event[i] >> PM_BYTE_SH) & PM_BYTE_MSK;\r\npsel = event[i] & PM_PMCSEL_MSK;\r\nif (!pmc) {\r\nif (unit)\r\npsel |= 0x10 | ((byte & 2) << 2);\r\nelse\r\npsel |= 8;\r\nfor (pmc = 0; pmc < 8; ++pmc) {\r\nif (pmc_inuse & (1 << pmc))\r\ncontinue;\r\ngrp = (pmc >> 1) & 1;\r\nif (unit) {\r\nif (grp == (byte & 1))\r\nbreak;\r\n} else if (pmc_grp_use[grp] < 4) {\r\n++pmc_grp_use[grp];\r\nbreak;\r\n}\r\n}\r\npmc_inuse |= 1 << pmc;\r\n} else {\r\n--pmc;\r\nif (psel == 0 && (byte & 2))\r\nmmcr1 |= 1ull << mmcr1_adder_bits[pmc];\r\n}\r\npmcsel[pmc] = psel;\r\nhwc[i] = pmc;\r\nspcsel = (event[i] >> PM_SPCSEL_SH) & PM_SPCSEL_MSK;\r\nmmcr1 |= spcsel;\r\nif (p970_marked_instr_event(event[i]))\r\nmmcra |= MMCRA_SAMPLE_ENABLE;\r\n}\r\nfor (pmc = 0; pmc < 2; ++pmc)\r\nmmcr0 |= pmcsel[pmc] << (MMCR0_PMC1SEL_SH - 7 * pmc);\r\nfor (; pmc < 8; ++pmc)\r\nmmcr1 |= (unsigned long)pmcsel[pmc]\r\n<< (MMCR1_PMC3SEL_SH - 5 * (pmc - 2));\r\nif (pmc_inuse & 1)\r\nmmcr0 |= MMCR0_PMC1CE;\r\nif (pmc_inuse & 0xfe)\r\nmmcr0 |= MMCR0_PMCjCE;\r\nmmcra |= 0x2000;\r\nmmcr[0] = mmcr0;\r\nmmcr[1] = mmcr1;\r\nmmcr[2] = mmcra;\r\nreturn 0;\r\n}\r\nstatic void p970_disable_pmc(unsigned int pmc, unsigned long mmcr[])\r\n{\r\nint shift, i;\r\nif (pmc <= 1) {\r\nshift = MMCR0_PMC1SEL_SH - 7 * pmc;\r\ni = 0;\r\n} else {\r\nshift = MMCR1_PMC3SEL_SH - 5 * (pmc - 2);\r\ni = 1;\r\n}\r\nmmcr[i] = (mmcr[i] & ~(0x1fUL << shift)) | (0x08UL << shift);\r\n}\r\nstatic int __init init_ppc970_pmu(void)\r\n{\r\nif (!cur_cpu_spec->oprofile_cpu_type ||\r\n(strcmp(cur_cpu_spec->oprofile_cpu_type, "ppc64/970")\r\n&& strcmp(cur_cpu_spec->oprofile_cpu_type, "ppc64/970MP")))\r\nreturn -ENODEV;\r\nreturn register_power_pmu(&ppc970_pmu);\r\n}

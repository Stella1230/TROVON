static int badge4_sa1111_enable(void *data, unsigned devid)\r\n{\r\nif (devid == SA1111_DEVID_USB)\r\nbadge4_set_5V(BADGE4_5V_USB, 1);\r\nreturn 0;\r\n}\r\nstatic void badge4_sa1111_disable(void *data, unsigned devid)\r\n{\r\nif (devid == SA1111_DEVID_USB)\r\nbadge4_set_5V(BADGE4_5V_USB, 0);\r\n}\r\nstatic int __init badge4_sa1111_init(void)\r\n{\r\nsa1110_mb_disable();\r\nreturn platform_add_devices(devices, ARRAY_SIZE(devices));\r\n}\r\nstatic int __init five_v_on_setup(char *ignore)\r\n{\r\nfive_v_on = 1;\r\nreturn 1;\r\n}\r\nstatic int __init badge4_init(void)\r\n{\r\nint ret;\r\nif (!machine_is_badge4())\r\nreturn -ENODEV;\r\nGPCR = (BADGE4_GPIO_LGP2 | BADGE4_GPIO_LGP3 |\r\nBADGE4_GPIO_LGP4 | BADGE4_GPIO_LGP5 |\r\nBADGE4_GPIO_LGP6 | BADGE4_GPIO_LGP7 |\r\nBADGE4_GPIO_LGP8 | BADGE4_GPIO_LGP9 |\r\nBADGE4_GPIO_GPA_VID | BADGE4_GPIO_GPB_VID |\r\nBADGE4_GPIO_GPC_VID);\r\nGPDR &= ~BADGE4_GPIO_INT_VID;\r\nGPDR |= (BADGE4_GPIO_LGP2 | BADGE4_GPIO_LGP3 |\r\nBADGE4_GPIO_LGP4 | BADGE4_GPIO_LGP5 |\r\nBADGE4_GPIO_LGP6 | BADGE4_GPIO_LGP7 |\r\nBADGE4_GPIO_LGP8 | BADGE4_GPIO_LGP9 |\r\nBADGE4_GPIO_GPA_VID | BADGE4_GPIO_GPB_VID |\r\nBADGE4_GPIO_GPC_VID);\r\nGPCR = (BADGE4_GPIO_SDSDA | BADGE4_GPIO_SDSCL);\r\nGPDR |= (BADGE4_GPIO_SDSDA | BADGE4_GPIO_SDSCL);\r\nGPCR = (BADGE4_GPIO_UART_HS1 | BADGE4_GPIO_UART_HS2);\r\nGPDR |= (BADGE4_GPIO_UART_HS1 | BADGE4_GPIO_UART_HS2);\r\nGPCR = BADGE4_GPIO_MUXSEL0;\r\nGPDR |= BADGE4_GPIO_MUXSEL0;\r\nGPDR &= ~(BADGE4_GPIO_TESTPT_J5 | BADGE4_GPIO_TESTPT_J6);\r\nGPCR = BADGE4_GPIO_TESTPT_J7;\r\nGPDR |= BADGE4_GPIO_TESTPT_J7;\r\nGPCR = BADGE4_GPIO_PCMEN5V;\r\nGPDR |= BADGE4_GPIO_PCMEN5V;\r\nprintk(KERN_DEBUG __FILE__ ": SDRAM CPLD typ1=%d typ0=%d\n",\r\n!!(GPLR & BADGE4_GPIO_SDTYP1),\r\n!!(GPLR & BADGE4_GPIO_SDTYP0));\r\nPGSR = 0;\r\nPWER = 0;\r\nPCFR = 0;\r\nPSDR = 0;\r\nPWER |= PWER_GPIO26;\r\nPWER |= PWER_RTC;\r\nPGSR |= BADGE4_GPIO_SA1111_NRST;\r\nPGSR |= (GPLR & (BADGE4_GPIO_SDTYP0|BADGE4_GPIO_SDTYP1));\r\nret = badge4_sa1111_init();\r\nif (ret < 0)\r\nprintk(KERN_ERR\r\n"%s: SA-1111 initialization failed (%d)\n",\r\n__func__, ret);\r\nbadge4_set_5V(BADGE4_5V_INITIALLY, five_v_on);\r\nsa11x0_register_mtd(&badge4_flash_data, &badge4_flash_resource, 1);\r\nreturn 0;\r\n}\r\nvoid badge4_set_5V(unsigned subsystem, int on)\r\n{\r\nunsigned long flags;\r\nunsigned old_5V_bitmap;\r\nlocal_irq_save(flags);\r\nold_5V_bitmap = badge4_5V_bitmap;\r\nif (on) {\r\nbadge4_5V_bitmap |= subsystem;\r\n} else {\r\nbadge4_5V_bitmap &= ~subsystem;\r\n}\r\nif ((!old_5V_bitmap) && (badge4_5V_bitmap)) {\r\nprintk(KERN_INFO "%s: enabling 5V supply rail\n", __func__);\r\nGPSR = BADGE4_GPIO_PCMEN5V;\r\n} else if ((old_5V_bitmap) && (!badge4_5V_bitmap)) {\r\nprintk(KERN_INFO "%s: disabling 5V supply rail\n", __func__);\r\nGPCR = BADGE4_GPIO_PCMEN5V;\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void\r\nbadge4_uart_pm(struct uart_port *port, u_int state, u_int oldstate)\r\n{\r\nif (!state) {\r\nSer1SDCR0 |= SDCR0_UART;\r\n}\r\n}\r\nstatic void __init badge4_map_io(void)\r\n{\r\nsa1100_map_io();\r\niotable_init(badge4_io_desc, ARRAY_SIZE(badge4_io_desc));\r\nsa1100_register_uart_fns(&badge4_port_fns);\r\nsa1100_register_uart(0, 3);\r\nsa1100_register_uart(1, 1);\r\n}

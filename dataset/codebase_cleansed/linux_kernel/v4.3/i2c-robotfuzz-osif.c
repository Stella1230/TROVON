static int osif_usb_read(struct i2c_adapter *adapter, int cmd,\r\nint value, int index, void *data, int len)\r\n{\r\nstruct osif_priv *priv = adapter->algo_data;\r\nreturn usb_control_msg(priv->usb_dev, usb_rcvctrlpipe(priv->usb_dev, 0),\r\ncmd, USB_TYPE_VENDOR | USB_RECIP_INTERFACE |\r\nUSB_DIR_IN, value, index, data, len, 2000);\r\n}\r\nstatic int osif_usb_write(struct i2c_adapter *adapter, int cmd,\r\nint value, int index, void *data, int len)\r\n{\r\nstruct osif_priv *priv = adapter->algo_data;\r\nreturn usb_control_msg(priv->usb_dev, usb_sndctrlpipe(priv->usb_dev, 0),\r\ncmd, USB_TYPE_VENDOR | USB_RECIP_INTERFACE,\r\nvalue, index, data, len, 2000);\r\n}\r\nstatic int osif_xfer(struct i2c_adapter *adapter, struct i2c_msg *msgs,\r\nint num)\r\n{\r\nstruct osif_priv *priv = adapter->algo_data;\r\nstruct i2c_msg *pmsg;\r\nint ret = 0;\r\nint i, cmd;\r\nfor (i = 0; ret >= 0 && i < num; i++) {\r\npmsg = &msgs[i];\r\nif (pmsg->flags & I2C_M_RD) {\r\ncmd = OSIFI2C_READ;\r\nret = osif_usb_read(adapter, cmd, pmsg->flags,\r\npmsg->addr, pmsg->buf,\r\npmsg->len);\r\nif (ret != pmsg->len) {\r\ndev_err(&adapter->dev, "failure reading data\n");\r\nreturn -EREMOTEIO;\r\n}\r\n} else {\r\ncmd = OSIFI2C_WRITE;\r\nret = osif_usb_write(adapter, cmd, pmsg->flags,\r\npmsg->addr, pmsg->buf, pmsg->len);\r\nif (ret != pmsg->len) {\r\ndev_err(&adapter->dev, "failure writing data\n");\r\nreturn -EREMOTEIO;\r\n}\r\n}\r\nret = osif_usb_read(adapter, OSIFI2C_STOP, 0, 0, NULL, 0);\r\nif (ret) {\r\ndev_err(&adapter->dev, "failure sending STOP\n");\r\nreturn -EREMOTEIO;\r\n}\r\nret = osif_usb_read(adapter, OSIFI2C_STATUS, 0, 0,\r\n&priv->status, 1);\r\nif (ret != 1) {\r\ndev_err(&adapter->dev, "failure reading status\n");\r\nreturn -EREMOTEIO;\r\n}\r\nif (priv->status != STATUS_ADDRESS_ACK) {\r\ndev_dbg(&adapter->dev, "status = %d\n", priv->status);\r\nreturn -EREMOTEIO;\r\n}\r\n}\r\nreturn i;\r\n}\r\nstatic u32 osif_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL;\r\n}\r\nstatic int osif_probe(struct usb_interface *interface,\r\nconst struct usb_device_id *id)\r\n{\r\nint ret;\r\nstruct osif_priv *priv;\r\nu16 version;\r\npriv = devm_kzalloc(&interface->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->usb_dev = usb_get_dev(interface_to_usbdev(interface));\r\npriv->interface = interface;\r\nusb_set_intfdata(interface, priv);\r\npriv->adapter.owner = THIS_MODULE;\r\npriv->adapter.class = I2C_CLASS_HWMON;\r\npriv->adapter.algo = &osif_algorithm;\r\npriv->adapter.algo_data = priv;\r\nsnprintf(priv->adapter.name, sizeof(priv->adapter.name),\r\n"OSIF at bus %03d device %03d",\r\npriv->usb_dev->bus->busnum, priv->usb_dev->devnum);\r\nret = osif_usb_read(&priv->adapter, OSIFI2C_SET_BIT_RATE, 52, 0,\r\nNULL, 0);\r\nif (ret) {\r\ndev_err(&interface->dev, "failure sending bit rate");\r\nusb_put_dev(priv->usb_dev);\r\nreturn ret;\r\n}\r\ni2c_add_adapter(&(priv->adapter));\r\nversion = le16_to_cpu(priv->usb_dev->descriptor.bcdDevice);\r\ndev_info(&interface->dev,\r\n"version %x.%02x found at bus %03d address %03d",\r\nversion >> 8, version & 0xff,\r\npriv->usb_dev->bus->busnum, priv->usb_dev->devnum);\r\nreturn 0;\r\n}\r\nstatic void osif_disconnect(struct usb_interface *interface)\r\n{\r\nstruct osif_priv *priv = usb_get_intfdata(interface);\r\ni2c_del_adapter(&(priv->adapter));\r\nusb_set_intfdata(interface, NULL);\r\nusb_put_dev(priv->usb_dev);\r\n}

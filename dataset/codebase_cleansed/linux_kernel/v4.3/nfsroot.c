static int __init nfs_root_debug(char *__unused)\r\n{\r\nnfs_debug |= NFSDBG_ROOT | NFSDBG_MOUNT;\r\nreturn 1;\r\n}\r\nstatic int __init nfs_root_setup(char *line)\r\n{\r\nROOT_DEV = Root_NFS;\r\nif (line[0] == '/' || line[0] == ',' || (line[0] >= '0' && line[0] <= '9')) {\r\nstrlcpy(nfs_root_parms, line, sizeof(nfs_root_parms));\r\n} else {\r\nsize_t n = strlen(line) + sizeof(NFS_ROOT) - 1;\r\nif (n >= sizeof(nfs_root_parms))\r\nline[sizeof(nfs_root_parms) - sizeof(NFS_ROOT) - 2] = '\0';\r\nsprintf(nfs_root_parms, NFS_ROOT, line);\r\n}\r\nroot_server_addr = root_nfs_parse_addr(nfs_root_parms);\r\nreturn 1;\r\n}\r\nstatic int __init root_nfs_copy(char *dest, const char *src,\r\nconst size_t destlen)\r\n{\r\nif (strlcpy(dest, src, destlen) > destlen)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int __init root_nfs_cat(char *dest, const char *src,\r\nconst size_t destlen)\r\n{\r\nsize_t len = strlen(dest);\r\nif (len && dest[len - 1] != ',')\r\nif (strlcat(dest, ",", destlen) > destlen)\r\nreturn -1;\r\nif (strlcat(dest, src, destlen) > destlen)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int __init root_nfs_parse_options(char *incoming, char *exppath,\r\nconst size_t exppathlen)\r\n{\r\nchar *p;\r\np = strsep(&incoming, ",");\r\nif (*p != '\0' && strcmp(p, "default") != 0)\r\nif (root_nfs_copy(exppath, p, exppathlen))\r\nreturn -1;\r\nif (incoming != NULL && *incoming != '\0')\r\nif (root_nfs_cat(nfs_root_options, incoming,\r\nsizeof(nfs_root_options)))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int __init root_nfs_data(char *cmdline)\r\n{\r\nchar mand_options[sizeof("nolock,addr=") + INET_ADDRSTRLEN + 1];\r\nint len, retval = -1;\r\nchar *tmp = NULL;\r\nconst size_t tmplen = sizeof(nfs_export_path);\r\ntmp = kzalloc(tmplen, GFP_KERNEL);\r\nif (tmp == NULL)\r\ngoto out_nomem;\r\nstrcpy(tmp, NFS_ROOT);\r\nif (root_server_path[0] != '\0') {\r\ndprintk("Root-NFS: DHCPv4 option 17: %s\n",\r\nroot_server_path);\r\nif (root_nfs_parse_options(root_server_path, tmp, tmplen))\r\ngoto out_optionstoolong;\r\n}\r\nif (cmdline[0] != '\0') {\r\ndprintk("Root-NFS: nfsroot=%s\n", cmdline);\r\nif (root_nfs_parse_options(cmdline, tmp, tmplen))\r\ngoto out_optionstoolong;\r\n}\r\nsnprintf(mand_options, sizeof(mand_options), "nolock,addr=%pI4",\r\n&servaddr);\r\nif (root_nfs_cat(nfs_root_options, mand_options,\r\nsizeof(nfs_root_options)))\r\ngoto out_optionstoolong;\r\nlen = snprintf(nfs_export_path, sizeof(nfs_export_path),\r\ntmp, utsname()->nodename);\r\nif (len >= (int)sizeof(nfs_export_path))\r\ngoto out_devnametoolong;\r\nlen = snprintf(nfs_root_device, sizeof(nfs_root_device),\r\n"%pI4:%s", &servaddr, nfs_export_path);\r\nif (len >= (int)sizeof(nfs_root_device))\r\ngoto out_devnametoolong;\r\nretval = 0;\r\nout:\r\nkfree(tmp);\r\nreturn retval;\r\nout_nomem:\r\nprintk(KERN_ERR "Root-NFS: could not allocate memory\n");\r\ngoto out;\r\nout_optionstoolong:\r\nprintk(KERN_ERR "Root-NFS: mount options string too long\n");\r\ngoto out;\r\nout_devnametoolong:\r\nprintk(KERN_ERR "Root-NFS: root device name too long.\n");\r\ngoto out;\r\n}\r\nint __init nfs_root_data(char **root_device, char **root_data)\r\n{\r\nservaddr = root_server_addr;\r\nif (servaddr == htonl(INADDR_NONE)) {\r\nprintk(KERN_ERR "Root-NFS: no NFS server address\n");\r\nreturn -1;\r\n}\r\nif (root_nfs_data(nfs_root_parms) < 0)\r\nreturn -1;\r\n*root_device = nfs_root_device;\r\n*root_data = nfs_root_options;\r\nreturn 0;\r\n}

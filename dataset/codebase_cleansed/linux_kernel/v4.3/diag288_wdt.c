static int __diag288(unsigned int func, unsigned int timeout,\r\nunsigned long action, unsigned int len)\r\n{\r\nregister unsigned long __func asm("2") = func;\r\nregister unsigned long __timeout asm("3") = timeout;\r\nregister unsigned long __action asm("4") = action;\r\nregister unsigned long __len asm("5") = len;\r\nint err;\r\nerr = -EINVAL;\r\nasm volatile(\r\n" diag %1, %3, 0x288\n"\r\n"0: la %0, 0\n"\r\n"1:\n"\r\nEX_TABLE(0b, 1b)\r\n: "+d" (err) : "d"(__func), "d"(__timeout),\r\n"d"(__action), "d"(__len) : "1", "cc");\r\nreturn err;\r\n}\r\nstatic int __diag288_vm(unsigned int func, unsigned int timeout,\r\nchar *cmd, size_t len)\r\n{\r\nreturn __diag288(func, timeout, virt_to_phys(cmd), len);\r\n}\r\nstatic int __diag288_lpar(unsigned int func, unsigned int timeout,\r\nunsigned long action)\r\n{\r\nreturn __diag288(func, timeout, action, 0);\r\n}\r\nstatic int wdt_start(struct watchdog_device *dev)\r\n{\r\nchar *ebc_cmd;\r\nsize_t len;\r\nint ret;\r\nunsigned int func;\r\nret = -ENODEV;\r\nif (MACHINE_IS_VM) {\r\nebc_cmd = kmalloc(MAX_CMDLEN, GFP_KERNEL);\r\nif (!ebc_cmd)\r\nreturn -ENOMEM;\r\nlen = strlcpy(ebc_cmd, wdt_cmd, MAX_CMDLEN);\r\nASCEBC(ebc_cmd, MAX_CMDLEN);\r\nEBC_TOUPPER(ebc_cmd, MAX_CMDLEN);\r\nfunc = conceal_on ? (WDT_FUNC_INIT | WDT_FUNC_CONCEAL)\r\n: WDT_FUNC_INIT;\r\nret = __diag288_vm(func, dev->timeout, ebc_cmd, len);\r\nWARN_ON(ret != 0);\r\nkfree(ebc_cmd);\r\n} else {\r\nret = __diag288_lpar(WDT_FUNC_INIT,\r\ndev->timeout, LPARWDT_RESTART);\r\n}\r\nif (ret) {\r\npr_err("The watchdog cannot be activated\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wdt_stop(struct watchdog_device *dev)\r\n{\r\nint ret;\r\nret = __diag288(WDT_FUNC_CANCEL, 0, 0, 0);\r\nreturn ret;\r\n}\r\nstatic int wdt_ping(struct watchdog_device *dev)\r\n{\r\nchar *ebc_cmd;\r\nsize_t len;\r\nint ret;\r\nunsigned int func;\r\nret = -ENODEV;\r\nif (MACHINE_IS_VM) {\r\nebc_cmd = kmalloc(MAX_CMDLEN, GFP_KERNEL);\r\nif (!ebc_cmd)\r\nreturn -ENOMEM;\r\nlen = strlcpy(ebc_cmd, wdt_cmd, MAX_CMDLEN);\r\nASCEBC(ebc_cmd, MAX_CMDLEN);\r\nEBC_TOUPPER(ebc_cmd, MAX_CMDLEN);\r\nfunc = conceal_on ? (WDT_FUNC_INIT | WDT_FUNC_CONCEAL)\r\n: WDT_FUNC_INIT;\r\nret = __diag288_vm(func, dev->timeout, ebc_cmd, len);\r\nWARN_ON(ret != 0);\r\nkfree(ebc_cmd);\r\n} else {\r\nret = __diag288_lpar(WDT_FUNC_CHANGE, dev->timeout, 0);\r\n}\r\nif (ret)\r\npr_err("The watchdog timer cannot be started or reset\n");\r\nreturn ret;\r\n}\r\nstatic int wdt_set_timeout(struct watchdog_device * dev, unsigned int new_to)\r\n{\r\ndev->timeout = new_to;\r\nreturn wdt_ping(dev);\r\n}\r\nstatic int wdt_suspend(void)\r\n{\r\nif (test_and_set_bit(WDOG_DEV_OPEN, &wdt_dev.status)) {\r\npr_err("Linux cannot be suspended while the watchdog is in use\n");\r\nreturn notifier_from_errno(-EBUSY);\r\n}\r\nif (test_bit(WDOG_ACTIVE, &wdt_dev.status)) {\r\nclear_bit(WDOG_DEV_OPEN, &wdt_dev.status);\r\npr_err("Linux cannot be suspended while the watchdog is in use\n");\r\nreturn notifier_from_errno(-EBUSY);\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int wdt_resume(void)\r\n{\r\nclear_bit(WDOG_DEV_OPEN, &wdt_dev.status);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int wdt_power_event(struct notifier_block *this, unsigned long event,\r\nvoid *ptr)\r\n{\r\nswitch (event) {\r\ncase PM_POST_HIBERNATION:\r\ncase PM_POST_SUSPEND:\r\nreturn wdt_resume();\r\ncase PM_HIBERNATION_PREPARE:\r\ncase PM_SUSPEND_PREPARE:\r\nreturn wdt_suspend();\r\ndefault:\r\nreturn NOTIFY_DONE;\r\n}\r\n}\r\nstatic int __init diag288_init(void)\r\n{\r\nint ret;\r\nchar ebc_begin[] = {\r\n194, 197, 199, 201, 213\r\n};\r\nwatchdog_set_nowayout(&wdt_dev, nowayout_info);\r\nif (MACHINE_IS_VM) {\r\nif (__diag288_vm(WDT_FUNC_INIT, 15,\r\nebc_begin, sizeof(ebc_begin)) != 0) {\r\npr_err("The watchdog cannot be initialized\n");\r\nreturn -EINVAL;\r\n}\r\n} else {\r\nif (__diag288_lpar(WDT_FUNC_INIT, 30, LPARWDT_RESTART)) {\r\npr_err("The watchdog cannot be initialized\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (__diag288_lpar(WDT_FUNC_CANCEL, 0, 0)) {\r\npr_err("The watchdog cannot be deactivated\n");\r\nreturn -EINVAL;\r\n}\r\nret = register_pm_notifier(&wdt_power_notifier);\r\nif (ret)\r\nreturn ret;\r\nret = watchdog_register_device(&wdt_dev);\r\nif (ret)\r\nunregister_pm_notifier(&wdt_power_notifier);\r\nreturn ret;\r\n}\r\nstatic void __exit diag288_exit(void)\r\n{\r\nwatchdog_unregister_device(&wdt_dev);\r\nunregister_pm_notifier(&wdt_power_notifier);\r\n}

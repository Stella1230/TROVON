static unsigned int __init estimate_cpu_frequency(void)\r\n{\r\nunsigned int prid = read_c0_prid() & (PRID_COMP_MASK | PRID_IMP_MASK);\r\nunsigned int tick = 0;\r\nunsigned int freq;\r\nunsigned int orig;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\norig = readl(status_reg) & 0x2;\r\nwhile ((readl(status_reg) & 0x2) == orig)\r\n;\r\norig = orig ^ 0x2;\r\nwrite_c0_count(0);\r\nwhile (tick < 100) {\r\nwhile ((readl(status_reg) & 0x2) == orig)\r\n;\r\norig = orig ^ 0x2;\r\ntick++;\r\n}\r\nfreq = read_c0_count();\r\nlocal_irq_restore(flags);\r\nmips_hpt_frequency = freq;\r\nif ((prid != (PRID_COMP_MIPS | PRID_IMP_20KC)) &&\r\n(prid != (PRID_COMP_MIPS | PRID_IMP_25KF)))\r\nfreq *= 2;\r\nfreq += 5000;\r\nfreq -= freq%10000;\r\nreturn freq ;\r\n}\r\nvoid read_persistent_clock(struct timespec *ts)\r\n{\r\nts->tv_sec = 0;\r\nts->tv_nsec = 0;\r\n}\r\nint get_c0_perfcount_int(void)\r\n{\r\nif (gic_present)\r\nreturn gic_get_c0_perfcount_int();\r\nif (cp0_perfcount_irq >= 0)\r\nreturn MIPS_CPU_IRQ_BASE + cp0_perfcount_irq;\r\nreturn -1;\r\n}\r\nunsigned int get_c0_compare_int(void)\r\n{\r\nif (gic_present)\r\nreturn gic_get_c0_compare_int();\r\nreturn MIPS_CPU_IRQ_BASE + cp0_compare_irq;\r\n}\r\nvoid __init plat_time_init(void)\r\n{\r\nunsigned int est_freq;\r\nest_freq = estimate_cpu_frequency();\r\npr_debug("CPU frequency %d.%02d MHz\n", (est_freq / 1000000),\r\n(est_freq % 1000000) * 100 / 1000000);\r\nmips_scroll_message();\r\n}

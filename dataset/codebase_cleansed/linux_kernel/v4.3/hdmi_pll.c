void hdmi_pll_dump(struct hdmi_pll_data *pll, struct seq_file *s)\r\n{\r\n#define DUMPPLL(r) seq_printf(s, "%-35s %08x\n", #r,\\r\nhdmi_read_reg(pll->base, r))\r\nDUMPPLL(PLLCTRL_PLL_CONTROL);\r\nDUMPPLL(PLLCTRL_PLL_STATUS);\r\nDUMPPLL(PLLCTRL_PLL_GO);\r\nDUMPPLL(PLLCTRL_CFG1);\r\nDUMPPLL(PLLCTRL_CFG2);\r\nDUMPPLL(PLLCTRL_CFG3);\r\nDUMPPLL(PLLCTRL_SSC_CFG1);\r\nDUMPPLL(PLLCTRL_SSC_CFG2);\r\nDUMPPLL(PLLCTRL_CFG4);\r\n}\r\nvoid hdmi_pll_compute(struct hdmi_pll_data *pll,\r\nunsigned long target_tmds, struct dss_pll_clock_info *pi)\r\n{\r\nunsigned long fint, clkdco, clkout;\r\nunsigned long target_bitclk, target_clkdco;\r\nunsigned long min_dco;\r\nunsigned n, m, mf, m2, sd;\r\nunsigned long clkin;\r\nconst struct dss_pll_hw *hw = pll->pll.hw;\r\nclkin = clk_get_rate(pll->pll.clkin);\r\nDSSDBG("clkin %lu, target tmds %lu\n", clkin, target_tmds);\r\ntarget_bitclk = target_tmds * 10;\r\nn = DIV_ROUND_UP(clkin, hw->fint_max);\r\nfint = clkin / n;\r\nmin_dco = roundup(hw->clkdco_min, fint);\r\nm2 = DIV_ROUND_UP(min_dco, target_bitclk);\r\nif (m2 == 0)\r\nm2 = 1;\r\ntarget_clkdco = target_bitclk * m2;\r\nm = target_clkdco / fint;\r\nclkdco = fint * m;\r\nif (WARN_ON(target_clkdco - clkdco > fint))\r\nmf = 0;\r\nelse\r\nmf = (u32)div_u64(262144ull * (target_clkdco - clkdco), fint);\r\nif (mf > 0)\r\nclkdco += (u32)div_u64((u64)mf * fint, 262144);\r\nclkout = clkdco / m2;\r\nsd = DIV_ROUND_UP(fint * m, 250000000);\r\nDSSDBG("N = %u, M = %u, M.f = %u, M2 = %u, SD = %u\n",\r\nn, m, mf, m2, sd);\r\nDSSDBG("Fint %lu, clkdco %lu, clkout %lu\n", fint, clkdco, clkout);\r\npi->n = n;\r\npi->m = m;\r\npi->mf = mf;\r\npi->mX[0] = m2;\r\npi->sd = sd;\r\npi->fint = fint;\r\npi->clkdco = clkdco;\r\npi->clkout[0] = clkout;\r\n}\r\nstatic int hdmi_pll_enable(struct dss_pll *dsspll)\r\n{\r\nstruct hdmi_pll_data *pll = container_of(dsspll, struct hdmi_pll_data, pll);\r\nstruct hdmi_wp_data *wp = pll->wp;\r\nu16 r = 0;\r\ndss_ctrl_pll_enable(DSS_PLL_HDMI, true);\r\nr = hdmi_wp_set_pll_pwr(wp, HDMI_PLLPWRCMD_BOTHON_ALLCLKS);\r\nif (r)\r\nreturn r;\r\nreturn 0;\r\n}\r\nstatic void hdmi_pll_disable(struct dss_pll *dsspll)\r\n{\r\nstruct hdmi_pll_data *pll = container_of(dsspll, struct hdmi_pll_data, pll);\r\nstruct hdmi_wp_data *wp = pll->wp;\r\nhdmi_wp_set_pll_pwr(wp, HDMI_PLLPWRCMD_ALLOFF);\r\ndss_ctrl_pll_enable(DSS_PLL_HDMI, false);\r\n}\r\nstatic int dsi_init_pll_data(struct platform_device *pdev, struct hdmi_pll_data *hpll)\r\n{\r\nstruct dss_pll *pll = &hpll->pll;\r\nstruct clk *clk;\r\nint r;\r\nclk = devm_clk_get(&pdev->dev, "sys_clk");\r\nif (IS_ERR(clk)) {\r\nDSSERR("can't get sys_clk\n");\r\nreturn PTR_ERR(clk);\r\n}\r\npll->name = "hdmi";\r\npll->id = DSS_PLL_HDMI;\r\npll->base = hpll->base;\r\npll->clkin = clk;\r\nswitch (omapdss_get_version()) {\r\ncase OMAPDSS_VER_OMAP4430_ES1:\r\ncase OMAPDSS_VER_OMAP4430_ES2:\r\ncase OMAPDSS_VER_OMAP4:\r\npll->hw = &dss_omap4_hdmi_pll_hw;\r\nbreak;\r\ncase OMAPDSS_VER_OMAP5:\r\ncase OMAPDSS_VER_DRA7xx:\r\npll->hw = &dss_omap5_hdmi_pll_hw;\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\npll->ops = &dsi_pll_ops;\r\nr = dss_pll_register(pll);\r\nif (r)\r\nreturn r;\r\nreturn 0;\r\n}\r\nint hdmi_pll_init(struct platform_device *pdev, struct hdmi_pll_data *pll,\r\nstruct hdmi_wp_data *wp)\r\n{\r\nint r;\r\nstruct resource *res;\r\npll->wp = wp;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "pll");\r\nif (!res) {\r\nDSSERR("can't get PLL mem resource\n");\r\nreturn -EINVAL;\r\n}\r\npll->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(pll->base)) {\r\nDSSERR("can't ioremap PLLCTRL\n");\r\nreturn PTR_ERR(pll->base);\r\n}\r\nr = dsi_init_pll_data(pdev, pll);\r\nif (r) {\r\nDSSERR("failed to init HDMI PLL\n");\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nvoid hdmi_pll_uninit(struct hdmi_pll_data *hpll)\r\n{\r\nstruct dss_pll *pll = &hpll->pll;\r\ndss_pll_unregister(pll);\r\n}

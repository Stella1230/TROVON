static int ls_pcie_link_up(struct pcie_port *pp)\r\n{\r\nu32 state;\r\nstruct ls_pcie *pcie = to_ls_pcie(pp);\r\nregmap_read(pcie->scfg, SCFG_PEXMSCPORTSR(pcie->index), &state);\r\nstate = (state >> LTSSM_STATE_SHIFT) & LTSSM_STATE_MASK;\r\nif (state < LTSSM_PCIE_L0)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int ls_pcie_establish_link(struct pcie_port *pp)\r\n{\r\nunsigned int retries;\r\nfor (retries = 0; retries < 200; retries++) {\r\nif (dw_pcie_link_up(pp))\r\nreturn 0;\r\nusleep_range(100, 1000);\r\n}\r\ndev_err(pp->dev, "phy link never came up\n");\r\nreturn -EINVAL;\r\n}\r\nstatic void ls_pcie_host_init(struct pcie_port *pp)\r\n{\r\nstruct ls_pcie *pcie = to_ls_pcie(pp);\r\nu32 val;\r\ndw_pcie_setup_rc(pp);\r\nls_pcie_establish_link(pp);\r\nval = ioread32(pcie->dbi + PCIE_STRFMR1);\r\nval &= 0xffff;\r\niowrite32(val, pcie->dbi + PCIE_STRFMR1);\r\n}\r\nstatic int ls_add_pcie_port(struct ls_pcie *pcie)\r\n{\r\nstruct pcie_port *pp;\r\nint ret;\r\npp = &pcie->pp;\r\npp->dev = pcie->dev;\r\npp->dbi_base = pcie->dbi;\r\npp->root_bus_nr = -1;\r\npp->ops = &ls_pcie_host_ops;\r\nret = dw_pcie_host_init(pp);\r\nif (ret) {\r\ndev_err(pp->dev, "failed to initialize host\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init ls_pcie_probe(struct platform_device *pdev)\r\n{\r\nstruct ls_pcie *pcie;\r\nstruct resource *dbi_base;\r\nu32 index[2];\r\nint ret;\r\npcie = devm_kzalloc(&pdev->dev, sizeof(*pcie), GFP_KERNEL);\r\nif (!pcie)\r\nreturn -ENOMEM;\r\npcie->dev = &pdev->dev;\r\ndbi_base = platform_get_resource_byname(pdev, IORESOURCE_MEM, "regs");\r\npcie->dbi = devm_ioremap_resource(&pdev->dev, dbi_base);\r\nif (IS_ERR(pcie->dbi)) {\r\ndev_err(&pdev->dev, "missing *regs* space\n");\r\nreturn PTR_ERR(pcie->dbi);\r\n}\r\npcie->scfg = syscon_regmap_lookup_by_phandle(pdev->dev.of_node,\r\n"fsl,pcie-scfg");\r\nif (IS_ERR(pcie->scfg)) {\r\ndev_err(&pdev->dev, "No syscfg phandle specified\n");\r\nreturn PTR_ERR(pcie->scfg);\r\n}\r\nret = of_property_read_u32_array(pdev->dev.of_node,\r\n"fsl,pcie-scfg", index, 2);\r\nif (ret)\r\nreturn ret;\r\npcie->index = index[1];\r\nret = ls_add_pcie_port(pcie);\r\nif (ret < 0)\r\nreturn ret;\r\nplatform_set_drvdata(pdev, pcie);\r\nreturn 0;\r\n}

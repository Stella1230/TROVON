static unsigned int\r\nipt_mangle_out(struct sk_buff *skb, const struct nf_hook_state *state)\r\n{\r\nstruct net_device *out = state->out;\r\nunsigned int ret;\r\nconst struct iphdr *iph;\r\nu_int8_t tos;\r\n__be32 saddr, daddr;\r\nu_int32_t mark;\r\nint err;\r\nif (skb->len < sizeof(struct iphdr) ||\r\nip_hdrlen(skb) < sizeof(struct iphdr))\r\nreturn NF_ACCEPT;\r\nmark = skb->mark;\r\niph = ip_hdr(skb);\r\nsaddr = iph->saddr;\r\ndaddr = iph->daddr;\r\ntos = iph->tos;\r\nret = ipt_do_table(skb, NF_INET_LOCAL_OUT, state,\r\ndev_net(out)->ipv4.iptable_mangle);\r\nif (ret != NF_DROP && ret != NF_STOLEN) {\r\niph = ip_hdr(skb);\r\nif (iph->saddr != saddr ||\r\niph->daddr != daddr ||\r\nskb->mark != mark ||\r\niph->tos != tos) {\r\nerr = ip_route_me_harder(skb, RTN_UNSPEC);\r\nif (err < 0)\r\nret = NF_DROP_ERR(err);\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic unsigned int\r\niptable_mangle_hook(const struct nf_hook_ops *ops,\r\nstruct sk_buff *skb,\r\nconst struct nf_hook_state *state)\r\n{\r\nif (ops->hooknum == NF_INET_LOCAL_OUT)\r\nreturn ipt_mangle_out(skb, state);\r\nif (ops->hooknum == NF_INET_POST_ROUTING)\r\nreturn ipt_do_table(skb, ops->hooknum, state,\r\ndev_net(state->out)->ipv4.iptable_mangle);\r\nreturn ipt_do_table(skb, ops->hooknum, state,\r\ndev_net(state->in)->ipv4.iptable_mangle);\r\n}\r\nstatic int __net_init iptable_mangle_net_init(struct net *net)\r\n{\r\nstruct ipt_replace *repl;\r\nrepl = ipt_alloc_initial_table(&packet_mangler);\r\nif (repl == NULL)\r\nreturn -ENOMEM;\r\nnet->ipv4.iptable_mangle =\r\nipt_register_table(net, &packet_mangler, repl);\r\nkfree(repl);\r\nreturn PTR_ERR_OR_ZERO(net->ipv4.iptable_mangle);\r\n}\r\nstatic void __net_exit iptable_mangle_net_exit(struct net *net)\r\n{\r\nipt_unregister_table(net, net->ipv4.iptable_mangle);\r\n}\r\nstatic int __init iptable_mangle_init(void)\r\n{\r\nint ret;\r\nret = register_pernet_subsys(&iptable_mangle_net_ops);\r\nif (ret < 0)\r\nreturn ret;\r\nmangle_ops = xt_hook_link(&packet_mangler, iptable_mangle_hook);\r\nif (IS_ERR(mangle_ops)) {\r\nret = PTR_ERR(mangle_ops);\r\nunregister_pernet_subsys(&iptable_mangle_net_ops);\r\n}\r\nreturn ret;\r\n}\r\nstatic void __exit iptable_mangle_fini(void)\r\n{\r\nxt_hook_unlink(&packet_mangler, mangle_ops);\r\nunregister_pernet_subsys(&iptable_mangle_net_ops);\r\n}

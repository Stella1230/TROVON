static int itg3200_read_all_channels(struct i2c_client *i2c, __be16 *buf)\r\n{\r\nu8 tx = 0x80 | ITG3200_REG_TEMP_OUT_H;\r\nstruct i2c_msg msg[2] = {\r\n{\r\n.addr = i2c->addr,\r\n.flags = i2c->flags,\r\n.len = 1,\r\n.buf = &tx,\r\n},\r\n{\r\n.addr = i2c->addr,\r\n.flags = i2c->flags | I2C_M_RD,\r\n.len = ITG3200_SCAN_ELEMENTS * sizeof(s16),\r\n.buf = (char *)&buf,\r\n},\r\n};\r\nreturn i2c_transfer(i2c->adapter, msg, 2);\r\n}\r\nstatic irqreturn_t itg3200_trigger_handler(int irq, void *p)\r\n{\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->indio_dev;\r\nstruct itg3200 *st = iio_priv(indio_dev);\r\n__be16 buf[ITG3200_SCAN_ELEMENTS + sizeof(s64)/sizeof(u16)];\r\nint ret = itg3200_read_all_channels(st->i2c, buf);\r\nif (ret < 0)\r\ngoto error_ret;\r\niio_push_to_buffers_with_timestamp(indio_dev, buf, pf->timestamp);\r\niio_trigger_notify_done(indio_dev->trig);\r\nerror_ret:\r\nreturn IRQ_HANDLED;\r\n}\r\nint itg3200_buffer_configure(struct iio_dev *indio_dev)\r\n{\r\nreturn iio_triggered_buffer_setup(indio_dev, &iio_pollfunc_store_time,\r\nitg3200_trigger_handler, NULL);\r\n}\r\nvoid itg3200_buffer_unconfigure(struct iio_dev *indio_dev)\r\n{\r\niio_triggered_buffer_cleanup(indio_dev);\r\n}\r\nstatic int itg3200_data_rdy_trigger_set_state(struct iio_trigger *trig,\r\nbool state)\r\n{\r\nstruct iio_dev *indio_dev = iio_trigger_get_drvdata(trig);\r\nint ret;\r\nu8 msc;\r\nret = itg3200_read_reg_8(indio_dev, ITG3200_REG_IRQ_CONFIG, &msc);\r\nif (ret)\r\ngoto error_ret;\r\nif (state)\r\nmsc |= ITG3200_IRQ_DATA_RDY_ENABLE;\r\nelse\r\nmsc &= ~ITG3200_IRQ_DATA_RDY_ENABLE;\r\nret = itg3200_write_reg_8(indio_dev, ITG3200_REG_IRQ_CONFIG, msc);\r\nif (ret)\r\ngoto error_ret;\r\nerror_ret:\r\nreturn ret;\r\n}\r\nint itg3200_probe_trigger(struct iio_dev *indio_dev)\r\n{\r\nint ret;\r\nstruct itg3200 *st = iio_priv(indio_dev);\r\nst->trig = iio_trigger_alloc("%s-dev%d", indio_dev->name,\r\nindio_dev->id);\r\nif (!st->trig)\r\nreturn -ENOMEM;\r\nret = request_irq(st->i2c->irq,\r\n&iio_trigger_generic_data_rdy_poll,\r\nIRQF_TRIGGER_RISING,\r\n"itg3200_data_rdy",\r\nst->trig);\r\nif (ret)\r\ngoto error_free_trig;\r\nst->trig->dev.parent = &st->i2c->dev;\r\nst->trig->ops = &itg3200_trigger_ops;\r\niio_trigger_set_drvdata(st->trig, indio_dev);\r\nret = iio_trigger_register(st->trig);\r\nif (ret)\r\ngoto error_free_irq;\r\nindio_dev->trig = iio_trigger_get(st->trig);\r\nreturn 0;\r\nerror_free_irq:\r\nfree_irq(st->i2c->irq, st->trig);\r\nerror_free_trig:\r\niio_trigger_free(st->trig);\r\nreturn ret;\r\n}\r\nvoid itg3200_remove_trigger(struct iio_dev *indio_dev)\r\n{\r\nstruct itg3200 *st = iio_priv(indio_dev);\r\niio_trigger_unregister(st->trig);\r\nfree_irq(st->i2c->irq, st->trig);\r\niio_trigger_free(st->trig);\r\n}

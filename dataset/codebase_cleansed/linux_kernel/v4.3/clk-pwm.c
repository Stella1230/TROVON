static inline struct clk_pwm *to_clk_pwm(struct clk_hw *hw)\r\n{\r\nreturn container_of(hw, struct clk_pwm, hw);\r\n}\r\nstatic int clk_pwm_prepare(struct clk_hw *hw)\r\n{\r\nstruct clk_pwm *clk_pwm = to_clk_pwm(hw);\r\nreturn pwm_enable(clk_pwm->pwm);\r\n}\r\nstatic void clk_pwm_unprepare(struct clk_hw *hw)\r\n{\r\nstruct clk_pwm *clk_pwm = to_clk_pwm(hw);\r\npwm_disable(clk_pwm->pwm);\r\n}\r\nstatic unsigned long clk_pwm_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_pwm *clk_pwm = to_clk_pwm(hw);\r\nreturn clk_pwm->fixed_rate;\r\n}\r\nstatic int clk_pwm_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct clk_init_data init;\r\nstruct clk_pwm *clk_pwm;\r\nstruct pwm_device *pwm;\r\nconst char *clk_name;\r\nstruct clk *clk;\r\nint ret;\r\nclk_pwm = devm_kzalloc(&pdev->dev, sizeof(*clk_pwm), GFP_KERNEL);\r\nif (!clk_pwm)\r\nreturn -ENOMEM;\r\npwm = devm_pwm_get(&pdev->dev, NULL);\r\nif (IS_ERR(pwm))\r\nreturn PTR_ERR(pwm);\r\nif (!pwm->period) {\r\ndev_err(&pdev->dev, "invalid PWM period\n");\r\nreturn -EINVAL;\r\n}\r\nif (of_property_read_u32(node, "clock-frequency", &clk_pwm->fixed_rate))\r\nclk_pwm->fixed_rate = NSEC_PER_SEC / pwm->period;\r\nif (pwm->period != NSEC_PER_SEC / clk_pwm->fixed_rate &&\r\npwm->period != DIV_ROUND_UP(NSEC_PER_SEC, clk_pwm->fixed_rate)) {\r\ndev_err(&pdev->dev,\r\n"clock-frequency does not match PWM period\n");\r\nreturn -EINVAL;\r\n}\r\nret = pwm_config(pwm, (pwm->period + 1) >> 1, pwm->period);\r\nif (ret < 0)\r\nreturn ret;\r\nclk_name = node->name;\r\nof_property_read_string(node, "clock-output-names", &clk_name);\r\ninit.name = clk_name;\r\ninit.ops = &clk_pwm_ops;\r\ninit.flags = CLK_IS_BASIC | CLK_IS_ROOT;\r\ninit.num_parents = 0;\r\nclk_pwm->pwm = pwm;\r\nclk_pwm->hw.init = &init;\r\nclk = devm_clk_register(&pdev->dev, &clk_pwm->hw);\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nreturn of_clk_add_provider(node, of_clk_src_simple_get, clk);\r\n}\r\nstatic int clk_pwm_remove(struct platform_device *pdev)\r\n{\r\nof_clk_del_provider(pdev->dev.of_node);\r\nreturn 0;\r\n}

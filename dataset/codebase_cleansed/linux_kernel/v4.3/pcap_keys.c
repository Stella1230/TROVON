static irqreturn_t pcap_keys_handler(int irq, void *_pcap_keys)\r\n{\r\nstruct pcap_keys *pcap_keys = _pcap_keys;\r\nint pirq = irq_to_pcap(pcap_keys->pcap, irq);\r\nu32 pstat;\r\nezx_pcap_read(pcap_keys->pcap, PCAP_REG_PSTAT, &pstat);\r\npstat &= 1 << pirq;\r\nswitch (pirq) {\r\ncase PCAP_IRQ_ONOFF:\r\ninput_report_key(pcap_keys->input, KEY_POWER, !pstat);\r\nbreak;\r\ncase PCAP_IRQ_MIC:\r\ninput_report_key(pcap_keys->input, KEY_HP, !pstat);\r\nbreak;\r\n}\r\ninput_sync(pcap_keys->input);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int pcap_keys_probe(struct platform_device *pdev)\r\n{\r\nint err = -ENOMEM;\r\nstruct pcap_keys *pcap_keys;\r\nstruct input_dev *input_dev;\r\npcap_keys = kmalloc(sizeof(struct pcap_keys), GFP_KERNEL);\r\nif (!pcap_keys)\r\nreturn err;\r\npcap_keys->pcap = dev_get_drvdata(pdev->dev.parent);\r\ninput_dev = input_allocate_device();\r\nif (!input_dev)\r\ngoto fail;\r\npcap_keys->input = input_dev;\r\nplatform_set_drvdata(pdev, pcap_keys);\r\ninput_dev->name = pdev->name;\r\ninput_dev->phys = "pcap-keys/input0";\r\ninput_dev->id.bustype = BUS_HOST;\r\ninput_dev->dev.parent = &pdev->dev;\r\n__set_bit(EV_KEY, input_dev->evbit);\r\n__set_bit(KEY_POWER, input_dev->keybit);\r\n__set_bit(KEY_HP, input_dev->keybit);\r\nerr = input_register_device(input_dev);\r\nif (err)\r\ngoto fail_allocate;\r\nerr = request_irq(pcap_to_irq(pcap_keys->pcap, PCAP_IRQ_ONOFF),\r\npcap_keys_handler, 0, "Power key", pcap_keys);\r\nif (err)\r\ngoto fail_register;\r\nerr = request_irq(pcap_to_irq(pcap_keys->pcap, PCAP_IRQ_MIC),\r\npcap_keys_handler, 0, "Headphone button", pcap_keys);\r\nif (err)\r\ngoto fail_pwrkey;\r\nreturn 0;\r\nfail_pwrkey:\r\nfree_irq(pcap_to_irq(pcap_keys->pcap, PCAP_IRQ_ONOFF), pcap_keys);\r\nfail_register:\r\ninput_unregister_device(input_dev);\r\ngoto fail;\r\nfail_allocate:\r\ninput_free_device(input_dev);\r\nfail:\r\nkfree(pcap_keys);\r\nreturn err;\r\n}\r\nstatic int pcap_keys_remove(struct platform_device *pdev)\r\n{\r\nstruct pcap_keys *pcap_keys = platform_get_drvdata(pdev);\r\nfree_irq(pcap_to_irq(pcap_keys->pcap, PCAP_IRQ_ONOFF), pcap_keys);\r\nfree_irq(pcap_to_irq(pcap_keys->pcap, PCAP_IRQ_MIC), pcap_keys);\r\ninput_unregister_device(pcap_keys->input);\r\nkfree(pcap_keys);\r\nreturn 0;\r\n}

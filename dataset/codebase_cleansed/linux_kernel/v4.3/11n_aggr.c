static int\r\nmwifiex_11n_form_amsdu_pkt(struct sk_buff *skb_aggr,\r\nstruct sk_buff *skb_src, int *pad)\r\n{\r\nint dt_offset;\r\nstruct rfc_1042_hdr snap = {\r\n0xaa,\r\n0xaa,\r\n0x03,\r\n{0x00, 0x00, 0x00},\r\n0x0000\r\n};\r\nstruct tx_packet_hdr *tx_header;\r\ntx_header = (void *)skb_put(skb_aggr, sizeof(*tx_header));\r\ndt_offset = 2 * ETH_ALEN;\r\nmemcpy(&tx_header->eth803_hdr, skb_src->data, dt_offset);\r\nsnap.snap_type = ((struct ethhdr *)skb_src->data)->h_proto;\r\ndt_offset += sizeof(__be16);\r\nmemcpy(&tx_header->rfc1042_hdr, &snap, sizeof(struct rfc_1042_hdr));\r\nskb_pull(skb_src, dt_offset);\r\ntx_header->eth803_hdr.h_proto = htons(skb_src->len + LLC_SNAP_LEN);\r\nmemcpy(skb_put(skb_aggr, skb_src->len), skb_src->data, skb_src->len);\r\n*pad = (4 - ((unsigned long)skb_aggr->tail & 0x3)) % 4;\r\nreturn skb_aggr->len + *pad;\r\n}\r\nstatic void\r\nmwifiex_11n_form_amsdu_txpd(struct mwifiex_private *priv,\r\nstruct sk_buff *skb)\r\n{\r\nstruct txpd *local_tx_pd;\r\nstruct mwifiex_txinfo *tx_info = MWIFIEX_SKB_TXCB(skb);\r\nunsigned int pad;\r\nint headroom = (priv->adapter->iface_type ==\r\nMWIFIEX_USB) ? 0 : INTF_HEADER_LEN;\r\npad = ((void *)skb->data - sizeof(*local_tx_pd) -\r\nheadroom - NULL) & (MWIFIEX_DMA_ALIGN_SZ - 1);\r\nskb_push(skb, pad);\r\nskb_push(skb, sizeof(*local_tx_pd));\r\nlocal_tx_pd = (struct txpd *) skb->data;\r\nmemset(local_tx_pd, 0, sizeof(struct txpd));\r\nlocal_tx_pd->priority = (u8) skb->priority;\r\nlocal_tx_pd->pkt_delay_2ms =\r\nmwifiex_wmm_compute_drv_pkt_delay(priv, skb);\r\nlocal_tx_pd->bss_num = priv->bss_num;\r\nlocal_tx_pd->bss_type = priv->bss_type;\r\nlocal_tx_pd->tx_pkt_offset = cpu_to_le16(sizeof(struct txpd) +\r\npad);\r\nlocal_tx_pd->tx_pkt_type = cpu_to_le16(PKT_TYPE_AMSDU);\r\nlocal_tx_pd->tx_pkt_length = cpu_to_le16(skb->len -\r\nsizeof(*local_tx_pd) -\r\npad);\r\nif (tx_info->flags & MWIFIEX_BUF_FLAG_TDLS_PKT)\r\nlocal_tx_pd->flags |= MWIFIEX_TXPD_FLAGS_TDLS_PACKET;\r\nif (local_tx_pd->tx_control == 0)\r\nlocal_tx_pd->tx_control = cpu_to_le32(priv->pkt_tx_ctrl);\r\nif (GET_BSS_ROLE(priv) == MWIFIEX_BSS_ROLE_STA &&\r\npriv->adapter->pps_uapsd_mode) {\r\nif (true == mwifiex_check_last_packet_indication(priv)) {\r\npriv->adapter->tx_lock_flag = true;\r\nlocal_tx_pd->flags =\r\nMWIFIEX_TxPD_POWER_MGMT_LAST_PACKET;\r\n}\r\n}\r\n}\r\nint\r\nmwifiex_11n_aggregate_pkt(struct mwifiex_private *priv,\r\nstruct mwifiex_ra_list_tbl *pra_list,\r\nint ptrindex, unsigned long ra_list_flags)\r\n__releases(&priv->wmm.ra_list_spinlock

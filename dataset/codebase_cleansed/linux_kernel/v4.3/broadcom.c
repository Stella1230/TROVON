static int bcm54xx_exp_read(struct phy_device *phydev, u16 regnum)\r\n{\r\nint val;\r\nval = phy_write(phydev, MII_BCM54XX_EXP_SEL, regnum);\r\nif (val < 0)\r\nreturn val;\r\nval = phy_read(phydev, MII_BCM54XX_EXP_DATA);\r\nphy_write(phydev, MII_BCM54XX_EXP_SEL, 0);\r\nreturn val;\r\n}\r\nstatic int bcm54xx_exp_write(struct phy_device *phydev, u16 regnum, u16 val)\r\n{\r\nint ret;\r\nret = phy_write(phydev, MII_BCM54XX_EXP_SEL, regnum);\r\nif (ret < 0)\r\nreturn ret;\r\nret = phy_write(phydev, MII_BCM54XX_EXP_DATA, val);\r\nphy_write(phydev, MII_BCM54XX_EXP_SEL, 0);\r\nreturn ret;\r\n}\r\nstatic int bcm54xx_auxctl_write(struct phy_device *phydev, u16 regnum, u16 val)\r\n{\r\nreturn phy_write(phydev, MII_BCM54XX_AUX_CTL, regnum | val);\r\n}\r\nstatic int bcm50610_a0_workaround(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = bcm54xx_exp_write(phydev, MII_BCM54XX_EXP_AADJ1CH0,\r\nMII_BCM54XX_EXP_AADJ1CH0_SWP_ABCD_OEN |\r\nMII_BCM54XX_EXP_AADJ1CH0_SWSEL_THPF);\r\nif (err < 0)\r\nreturn err;\r\nerr = bcm54xx_exp_write(phydev, MII_BCM54XX_EXP_AADJ1CH3,\r\nMII_BCM54XX_EXP_AADJ1CH3_ADCCKADJ);\r\nif (err < 0)\r\nreturn err;\r\nerr = bcm54xx_exp_write(phydev, MII_BCM54XX_EXP_EXP75,\r\nMII_BCM54XX_EXP_EXP75_VDACCTRL);\r\nif (err < 0)\r\nreturn err;\r\nerr = bcm54xx_exp_write(phydev, MII_BCM54XX_EXP_EXP96,\r\nMII_BCM54XX_EXP_EXP96_MYST);\r\nif (err < 0)\r\nreturn err;\r\nerr = bcm54xx_exp_write(phydev, MII_BCM54XX_EXP_EXP97,\r\nMII_BCM54XX_EXP_EXP97_MYST);\r\nreturn err;\r\n}\r\nstatic int bcm54xx_phydsp_config(struct phy_device *phydev)\r\n{\r\nint err, err2;\r\nerr = bcm54xx_auxctl_write(phydev,\r\nMII_BCM54XX_AUXCTL_SHDWSEL_AUXCTL,\r\nMII_BCM54XX_AUXCTL_ACTL_SMDSP_ENA |\r\nMII_BCM54XX_AUXCTL_ACTL_TX_6DB);\r\nif (err < 0)\r\nreturn err;\r\nif (BRCM_PHY_MODEL(phydev) == PHY_ID_BCM50610 ||\r\nBRCM_PHY_MODEL(phydev) == PHY_ID_BCM50610M) {\r\nerr = bcm54xx_exp_write(phydev, MII_BCM54XX_EXP_EXP08,\r\nMII_BCM54XX_EXP_EXP08_RJCT_2MHZ);\r\nif (err < 0)\r\ngoto error;\r\nif (phydev->drv->phy_id == PHY_ID_BCM50610) {\r\nerr = bcm50610_a0_workaround(phydev);\r\nif (err < 0)\r\ngoto error;\r\n}\r\n}\r\nif (BRCM_PHY_MODEL(phydev) == PHY_ID_BCM57780) {\r\nint val;\r\nval = bcm54xx_exp_read(phydev, MII_BCM54XX_EXP_EXP75);\r\nif (val < 0)\r\ngoto error;\r\nval |= MII_BCM54XX_EXP_EXP75_CM_OSC;\r\nerr = bcm54xx_exp_write(phydev, MII_BCM54XX_EXP_EXP75, val);\r\n}\r\nerror:\r\nerr2 = bcm54xx_auxctl_write(phydev,\r\nMII_BCM54XX_AUXCTL_SHDWSEL_AUXCTL,\r\nMII_BCM54XX_AUXCTL_ACTL_TX_6DB);\r\nreturn err ? err : err2;\r\n}\r\nstatic void bcm54xx_adjust_rxrefclk(struct phy_device *phydev)\r\n{\r\nu32 orig;\r\nint val;\r\nbool clk125en = true;\r\nif (BRCM_PHY_MODEL(phydev) != PHY_ID_BCM57780 &&\r\nBRCM_PHY_MODEL(phydev) != PHY_ID_BCM50610 &&\r\nBRCM_PHY_MODEL(phydev) != PHY_ID_BCM50610M)\r\nreturn;\r\nval = bcm54xx_shadow_read(phydev, BCM54XX_SHD_SCR3);\r\nif (val < 0)\r\nreturn;\r\norig = val;\r\nif ((BRCM_PHY_MODEL(phydev) == PHY_ID_BCM50610 ||\r\nBRCM_PHY_MODEL(phydev) == PHY_ID_BCM50610M) &&\r\nBRCM_PHY_REV(phydev) >= 0x3) {\r\nclk125en = false;\r\n} else {\r\nif (phydev->dev_flags & PHY_BRCM_RX_REFCLK_UNUSED) {\r\nval &= ~BCM54XX_SHD_SCR3_DEF_CLK125;\r\nclk125en = false;\r\n}\r\n}\r\nif (!clk125en || (phydev->dev_flags & PHY_BRCM_AUTO_PWRDWN_ENABLE))\r\nval &= ~BCM54XX_SHD_SCR3_DLLAPD_DIS;\r\nelse\r\nval |= BCM54XX_SHD_SCR3_DLLAPD_DIS;\r\nif (phydev->dev_flags & PHY_BRCM_DIS_TXCRXC_NOENRGY)\r\nval |= BCM54XX_SHD_SCR3_TRDDAPD;\r\nif (orig != val)\r\nbcm54xx_shadow_write(phydev, BCM54XX_SHD_SCR3, val);\r\nval = bcm54xx_shadow_read(phydev, BCM54XX_SHD_APD);\r\nif (val < 0)\r\nreturn;\r\norig = val;\r\nif (!clk125en || (phydev->dev_flags & PHY_BRCM_AUTO_PWRDWN_ENABLE))\r\nval |= BCM54XX_SHD_APD_EN;\r\nelse\r\nval &= ~BCM54XX_SHD_APD_EN;\r\nif (orig != val)\r\nbcm54xx_shadow_write(phydev, BCM54XX_SHD_APD, val);\r\n}\r\nstatic int bcm54xx_config_init(struct phy_device *phydev)\r\n{\r\nint reg, err;\r\nreg = phy_read(phydev, MII_BCM54XX_ECR);\r\nif (reg < 0)\r\nreturn reg;\r\nreg |= MII_BCM54XX_ECR_IM;\r\nerr = phy_write(phydev, MII_BCM54XX_ECR, reg);\r\nif (err < 0)\r\nreturn err;\r\nreg = ~(MII_BCM54XX_INT_DUPLEX |\r\nMII_BCM54XX_INT_SPEED |\r\nMII_BCM54XX_INT_LINK);\r\nerr = phy_write(phydev, MII_BCM54XX_IMR, reg);\r\nif (err < 0)\r\nreturn err;\r\nif ((BRCM_PHY_MODEL(phydev) == PHY_ID_BCM50610 ||\r\nBRCM_PHY_MODEL(phydev) == PHY_ID_BCM50610M) &&\r\n(phydev->dev_flags & PHY_BRCM_CLEAR_RGMII_MODE))\r\nbcm54xx_shadow_write(phydev, BCM54XX_SHD_RGMII_MODE, 0);\r\nif ((phydev->dev_flags & PHY_BRCM_RX_REFCLK_UNUSED) ||\r\n(phydev->dev_flags & PHY_BRCM_DIS_TXCRXC_NOENRGY) ||\r\n(phydev->dev_flags & PHY_BRCM_AUTO_PWRDWN_ENABLE))\r\nbcm54xx_adjust_rxrefclk(phydev);\r\nbcm54xx_phydsp_config(phydev);\r\nreturn 0;\r\n}\r\nstatic int bcm5482_config_init(struct phy_device *phydev)\r\n{\r\nint err, reg;\r\nerr = bcm54xx_config_init(phydev);\r\nif (phydev->dev_flags & PHY_BCM_FLAGS_MODE_1000BX) {\r\nreg = bcm54xx_shadow_read(phydev, BCM5482_SHD_SSD);\r\nbcm54xx_shadow_write(phydev, BCM5482_SHD_SSD,\r\nreg |\r\nBCM5482_SHD_SSD_LEDM |\r\nBCM5482_SHD_SSD_EN);\r\nreg = BCM5482_SSD_SGMII_SLAVE | MII_BCM54XX_EXP_SEL_SSD;\r\nerr = bcm54xx_exp_read(phydev, reg);\r\nif (err < 0)\r\nreturn err;\r\nerr = bcm54xx_exp_write(phydev, reg, err |\r\nBCM5482_SSD_SGMII_SLAVE_EN |\r\nBCM5482_SSD_SGMII_SLAVE_AD);\r\nif (err < 0)\r\nreturn err;\r\nreg = BCM5482_SSD_1000BX_CTL | MII_BCM54XX_EXP_SEL_SSD;\r\nerr = bcm54xx_exp_read(phydev, reg);\r\nif (err < 0)\r\nreturn err;\r\nerr = bcm54xx_exp_write(phydev, reg,\r\nerr & ~BCM5482_SSD_1000BX_CTL_PWRDOWN);\r\nif (err < 0)\r\nreturn err;\r\nreg = bcm54xx_shadow_read(phydev, BCM5482_SHD_MODE);\r\nbcm54xx_shadow_write(phydev, BCM5482_SHD_MODE,\r\nreg | BCM5482_SHD_MODE_1000BX);\r\nbcm54xx_shadow_write(phydev, BCM5482_SHD_LEDS1,\r\nBCM5482_SHD_LEDS1_LED1(BCM_LED_SRC_ACTIVITYLED) |\r\nBCM5482_SHD_LEDS1_LED3(BCM_LED_SRC_LINKSPD2));\r\nphydev->autoneg = AUTONEG_DISABLE;\r\nphydev->speed = SPEED_1000;\r\nphydev->duplex = DUPLEX_FULL;\r\n}\r\nreturn err;\r\n}\r\nstatic int bcm5482_read_status(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = genphy_read_status(phydev);\r\nif (phydev->dev_flags & PHY_BCM_FLAGS_MODE_1000BX) {\r\nif (phydev->link) {\r\nphydev->speed = SPEED_1000;\r\nphydev->duplex = DUPLEX_FULL;\r\n}\r\n}\r\nreturn err;\r\n}\r\nstatic int bcm54xx_ack_interrupt(struct phy_device *phydev)\r\n{\r\nint reg;\r\nreg = phy_read(phydev, MII_BCM54XX_ISR);\r\nif (reg < 0)\r\nreturn reg;\r\nreturn 0;\r\n}\r\nstatic int bcm54xx_config_intr(struct phy_device *phydev)\r\n{\r\nint reg, err;\r\nreg = phy_read(phydev, MII_BCM54XX_ECR);\r\nif (reg < 0)\r\nreturn reg;\r\nif (phydev->interrupts == PHY_INTERRUPT_ENABLED)\r\nreg &= ~MII_BCM54XX_ECR_IM;\r\nelse\r\nreg |= MII_BCM54XX_ECR_IM;\r\nerr = phy_write(phydev, MII_BCM54XX_ECR, reg);\r\nreturn err;\r\n}\r\nstatic int bcm5481_config_aneg(struct phy_device *phydev)\r\n{\r\nint ret;\r\nret = genphy_config_aneg(phydev);\r\nif (phydev->interface == PHY_INTERFACE_MODE_RGMII_RXID) {\r\nu16 reg;\r\nreg = 0x7 | (0x7 << 12);\r\nphy_write(phydev, 0x18, reg);\r\nreg = phy_read(phydev, 0x18);\r\nreg |= (1 << 8);\r\nreg |= (1 << 15);\r\nphy_write(phydev, 0x18, reg);\r\n}\r\nreturn ret;\r\n}\r\nstatic int brcm_phy_setbits(struct phy_device *phydev, int reg, int set)\r\n{\r\nint val;\r\nval = phy_read(phydev, reg);\r\nif (val < 0)\r\nreturn val;\r\nreturn phy_write(phydev, reg, val | set);\r\n}\r\nstatic int brcm_fet_config_init(struct phy_device *phydev)\r\n{\r\nint reg, err, err2, brcmtest;\r\nerr = phy_write(phydev, MII_BMCR, BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\nreg = phy_read(phydev, MII_BRCM_FET_INTREG);\r\nif (reg < 0)\r\nreturn reg;\r\nreg = MII_BRCM_FET_IR_DUPLEX_EN |\r\nMII_BRCM_FET_IR_SPEED_EN |\r\nMII_BRCM_FET_IR_LINK_EN |\r\nMII_BRCM_FET_IR_ENABLE |\r\nMII_BRCM_FET_IR_MASK;\r\nerr = phy_write(phydev, MII_BRCM_FET_INTREG, reg);\r\nif (err < 0)\r\nreturn err;\r\nbrcmtest = phy_read(phydev, MII_BRCM_FET_BRCMTEST);\r\nif (brcmtest < 0)\r\nreturn brcmtest;\r\nreg = brcmtest | MII_BRCM_FET_BT_SRE;\r\nerr = phy_write(phydev, MII_BRCM_FET_BRCMTEST, reg);\r\nif (err < 0)\r\nreturn err;\r\nreg = phy_read(phydev, MII_BRCM_FET_SHDW_AUXMODE4);\r\nif (reg < 0) {\r\nerr = reg;\r\ngoto done;\r\n}\r\nreg &= ~MII_BRCM_FET_SHDW_AM4_LED_MASK;\r\nreg |= MII_BRCM_FET_SHDW_AM4_LED_MODE1;\r\nerr = phy_write(phydev, MII_BRCM_FET_SHDW_AUXMODE4, reg);\r\nif (err < 0)\r\ngoto done;\r\nerr = brcm_phy_setbits(phydev, MII_BRCM_FET_SHDW_MISCCTRL,\r\nMII_BRCM_FET_SHDW_MC_FAME);\r\nif (err < 0)\r\ngoto done;\r\nif (phydev->dev_flags & PHY_BRCM_AUTO_PWRDWN_ENABLE) {\r\nerr = brcm_phy_setbits(phydev, MII_BRCM_FET_SHDW_AUXSTAT2,\r\nMII_BRCM_FET_SHDW_AS2_APDE);\r\n}\r\ndone:\r\nerr2 = phy_write(phydev, MII_BRCM_FET_BRCMTEST, brcmtest);\r\nif (!err)\r\nerr = err2;\r\nreturn err;\r\n}\r\nstatic int brcm_fet_ack_interrupt(struct phy_device *phydev)\r\n{\r\nint reg;\r\nreg = phy_read(phydev, MII_BRCM_FET_INTREG);\r\nif (reg < 0)\r\nreturn reg;\r\nreturn 0;\r\n}\r\nstatic int brcm_fet_config_intr(struct phy_device *phydev)\r\n{\r\nint reg, err;\r\nreg = phy_read(phydev, MII_BRCM_FET_INTREG);\r\nif (reg < 0)\r\nreturn reg;\r\nif (phydev->interrupts == PHY_INTERRUPT_ENABLED)\r\nreg &= ~MII_BRCM_FET_IR_MASK;\r\nelse\r\nreg |= MII_BRCM_FET_IR_MASK;\r\nerr = phy_write(phydev, MII_BRCM_FET_INTREG, reg);\r\nreturn err;\r\n}

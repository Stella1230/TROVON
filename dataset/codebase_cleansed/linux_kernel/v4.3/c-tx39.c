static void tx39h_flush_icache_all(void)\r\n{\r\nunsigned long flags, config;\r\nlocal_irq_save(flags);\r\nconfig = read_c0_conf();\r\nwrite_c0_conf(config & ~TX39_CONF_ICE);\r\nTX39_STOP_STREAMING();\r\nblast_icache16();\r\nwrite_c0_conf(config);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void tx39h_dma_cache_wback_inv(unsigned long addr, unsigned long size)\r\n{\r\nBUG_ON(size == 0);\r\niob();\r\nblast_inv_dcache_range(addr, addr + size);\r\n}\r\nstatic inline void tx39_blast_dcache_page(unsigned long addr)\r\n{\r\nif (current_cpu_type() != CPU_TX3912)\r\nblast_dcache16_page(addr);\r\n}\r\nstatic inline void tx39_blast_dcache_page_indexed(unsigned long addr)\r\n{\r\nblast_dcache16_page_indexed(addr);\r\n}\r\nstatic inline void tx39_blast_dcache(void)\r\n{\r\nblast_dcache16();\r\n}\r\nstatic inline void tx39_blast_icache_page(unsigned long addr)\r\n{\r\nunsigned long flags, config;\r\nlocal_irq_save(flags);\r\nconfig = read_c0_conf();\r\nwrite_c0_conf(config & ~TX39_CONF_ICE);\r\nTX39_STOP_STREAMING();\r\nblast_icache16_page(addr);\r\nwrite_c0_conf(config);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic inline void tx39_blast_icache_page_indexed(unsigned long addr)\r\n{\r\nunsigned long flags, config;\r\nlocal_irq_save(flags);\r\nconfig = read_c0_conf();\r\nwrite_c0_conf(config & ~TX39_CONF_ICE);\r\nTX39_STOP_STREAMING();\r\nblast_icache16_page_indexed(addr);\r\nwrite_c0_conf(config);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic inline void tx39_blast_icache(void)\r\n{\r\nunsigned long flags, config;\r\nlocal_irq_save(flags);\r\nconfig = read_c0_conf();\r\nwrite_c0_conf(config & ~TX39_CONF_ICE);\r\nTX39_STOP_STREAMING();\r\nblast_icache16();\r\nwrite_c0_conf(config);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void tx39__flush_cache_vmap(void)\r\n{\r\ntx39_blast_dcache();\r\n}\r\nstatic void tx39__flush_cache_vunmap(void)\r\n{\r\ntx39_blast_dcache();\r\n}\r\nstatic inline void tx39_flush_cache_all(void)\r\n{\r\nif (!cpu_has_dc_aliases)\r\nreturn;\r\ntx39_blast_dcache();\r\n}\r\nstatic inline void tx39___flush_cache_all(void)\r\n{\r\ntx39_blast_dcache();\r\ntx39_blast_icache();\r\n}\r\nstatic void tx39_flush_cache_mm(struct mm_struct *mm)\r\n{\r\nif (!cpu_has_dc_aliases)\r\nreturn;\r\nif (cpu_context(smp_processor_id(), mm) != 0)\r\ntx39_blast_dcache();\r\n}\r\nstatic void tx39_flush_cache_range(struct vm_area_struct *vma,\r\nunsigned long start, unsigned long end)\r\n{\r\nif (!cpu_has_dc_aliases)\r\nreturn;\r\nif (!(cpu_context(smp_processor_id(), vma->vm_mm)))\r\nreturn;\r\ntx39_blast_dcache();\r\n}\r\nstatic void tx39_flush_cache_page(struct vm_area_struct *vma, unsigned long page, unsigned long pfn)\r\n{\r\nint exec = vma->vm_flags & VM_EXEC;\r\nstruct mm_struct *mm = vma->vm_mm;\r\npgd_t *pgdp;\r\npud_t *pudp;\r\npmd_t *pmdp;\r\npte_t *ptep;\r\nif (cpu_context(smp_processor_id(), mm) == 0)\r\nreturn;\r\npage &= PAGE_MASK;\r\npgdp = pgd_offset(mm, page);\r\npudp = pud_offset(pgdp, page);\r\npmdp = pmd_offset(pudp, page);\r\nptep = pte_offset(pmdp, page);\r\nif (!(pte_val(*ptep) & _PAGE_PRESENT))\r\nreturn;\r\nif ((mm == current->active_mm) && (pte_val(*ptep) & _PAGE_VALID)) {\r\nif (cpu_has_dc_aliases || exec)\r\ntx39_blast_dcache_page(page);\r\nif (exec)\r\ntx39_blast_icache_page(page);\r\nreturn;\r\n}\r\nif (cpu_has_dc_aliases || exec)\r\ntx39_blast_dcache_page_indexed(page);\r\nif (exec)\r\ntx39_blast_icache_page_indexed(page);\r\n}\r\nstatic void local_tx39_flush_data_cache_page(void * addr)\r\n{\r\ntx39_blast_dcache_page((unsigned long)addr);\r\n}\r\nstatic void tx39_flush_data_cache_page(unsigned long addr)\r\n{\r\ntx39_blast_dcache_page(addr);\r\n}\r\nstatic void tx39_flush_icache_range(unsigned long start, unsigned long end)\r\n{\r\nif (end - start > dcache_size)\r\ntx39_blast_dcache();\r\nelse\r\nprotected_blast_dcache_range(start, end);\r\nif (end - start > icache_size)\r\ntx39_blast_icache();\r\nelse {\r\nunsigned long flags, config;\r\nlocal_irq_save(flags);\r\nconfig = read_c0_conf();\r\nwrite_c0_conf(config & ~TX39_CONF_ICE);\r\nTX39_STOP_STREAMING();\r\nprotected_blast_icache_range(start, end);\r\nwrite_c0_conf(config);\r\nlocal_irq_restore(flags);\r\n}\r\n}\r\nstatic void tx39_flush_kernel_vmap_range(unsigned long vaddr, int size)\r\n{\r\nBUG();\r\n}\r\nstatic void tx39_dma_cache_wback_inv(unsigned long addr, unsigned long size)\r\n{\r\nunsigned long end;\r\nif (((size | addr) & (PAGE_SIZE - 1)) == 0) {\r\nend = addr + size;\r\ndo {\r\ntx39_blast_dcache_page(addr);\r\naddr += PAGE_SIZE;\r\n} while(addr != end);\r\n} else if (size > dcache_size) {\r\ntx39_blast_dcache();\r\n} else {\r\nblast_dcache_range(addr, addr + size);\r\n}\r\n}\r\nstatic void tx39_dma_cache_inv(unsigned long addr, unsigned long size)\r\n{\r\nunsigned long end;\r\nif (((size | addr) & (PAGE_SIZE - 1)) == 0) {\r\nend = addr + size;\r\ndo {\r\ntx39_blast_dcache_page(addr);\r\naddr += PAGE_SIZE;\r\n} while(addr != end);\r\n} else if (size > dcache_size) {\r\ntx39_blast_dcache();\r\n} else {\r\nblast_inv_dcache_range(addr, addr + size);\r\n}\r\n}\r\nstatic void tx39_flush_cache_sigtramp(unsigned long addr)\r\n{\r\nunsigned long ic_lsize = current_cpu_data.icache.linesz;\r\nunsigned long dc_lsize = current_cpu_data.dcache.linesz;\r\nunsigned long config;\r\nunsigned long flags;\r\nprotected_writeback_dcache_line(addr & ~(dc_lsize - 1));\r\nlocal_irq_save(flags);\r\nconfig = read_c0_conf();\r\nwrite_c0_conf(config & ~TX39_CONF_ICE);\r\nTX39_STOP_STREAMING();\r\nprotected_flush_icache_line(addr & ~(ic_lsize - 1));\r\nwrite_c0_conf(config);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic __init void tx39_probe_cache(void)\r\n{\r\nunsigned long config;\r\nconfig = read_c0_conf();\r\nicache_size = 1 << (10 + ((config & TX39_CONF_ICS_MASK) >>\r\nTX39_CONF_ICS_SHIFT));\r\ndcache_size = 1 << (10 + ((config & TX39_CONF_DCS_MASK) >>\r\nTX39_CONF_DCS_SHIFT));\r\ncurrent_cpu_data.icache.linesz = 16;\r\nswitch (current_cpu_type()) {\r\ncase CPU_TX3912:\r\ncurrent_cpu_data.icache.ways = 1;\r\ncurrent_cpu_data.dcache.ways = 1;\r\ncurrent_cpu_data.dcache.linesz = 4;\r\nbreak;\r\ncase CPU_TX3927:\r\ncurrent_cpu_data.icache.ways = 2;\r\ncurrent_cpu_data.dcache.ways = 2;\r\ncurrent_cpu_data.dcache.linesz = 16;\r\nbreak;\r\ncase CPU_TX3922:\r\ndefault:\r\ncurrent_cpu_data.icache.ways = 1;\r\ncurrent_cpu_data.dcache.ways = 1;\r\ncurrent_cpu_data.dcache.linesz = 16;\r\nbreak;\r\n}\r\n}\r\nvoid tx39_cache_init(void)\r\n{\r\nextern void build_clear_page(void);\r\nextern void build_copy_page(void);\r\nunsigned long config;\r\nconfig = read_c0_conf();\r\nconfig &= ~TX39_CONF_WBON;\r\nwrite_c0_conf(config);\r\ntx39_probe_cache();\r\nswitch (current_cpu_type()) {\r\ncase CPU_TX3912:\r\n__flush_cache_vmap = tx39__flush_cache_vmap;\r\n__flush_cache_vunmap = tx39__flush_cache_vunmap;\r\nflush_cache_all = tx39h_flush_icache_all;\r\n__flush_cache_all = tx39h_flush_icache_all;\r\nflush_cache_mm = (void *) tx39h_flush_icache_all;\r\nflush_cache_range = (void *) tx39h_flush_icache_all;\r\nflush_cache_page = (void *) tx39h_flush_icache_all;\r\nflush_icache_range = (void *) tx39h_flush_icache_all;\r\nlocal_flush_icache_range = (void *) tx39h_flush_icache_all;\r\nflush_cache_sigtramp = (void *) tx39h_flush_icache_all;\r\nlocal_flush_data_cache_page = (void *) tx39h_flush_icache_all;\r\nflush_data_cache_page = (void *) tx39h_flush_icache_all;\r\n_dma_cache_wback_inv = tx39h_dma_cache_wback_inv;\r\nshm_align_mask = PAGE_SIZE - 1;\r\nbreak;\r\ncase CPU_TX3922:\r\ncase CPU_TX3927:\r\ndefault:\r\n__flush_cache_vmap = tx39__flush_cache_vmap;\r\n__flush_cache_vunmap = tx39__flush_cache_vunmap;\r\nflush_cache_all = tx39_flush_cache_all;\r\n__flush_cache_all = tx39___flush_cache_all;\r\nflush_cache_mm = tx39_flush_cache_mm;\r\nflush_cache_range = tx39_flush_cache_range;\r\nflush_cache_page = tx39_flush_cache_page;\r\nflush_icache_range = tx39_flush_icache_range;\r\nlocal_flush_icache_range = tx39_flush_icache_range;\r\n__flush_kernel_vmap_range = tx39_flush_kernel_vmap_range;\r\nflush_cache_sigtramp = tx39_flush_cache_sigtramp;\r\nlocal_flush_data_cache_page = local_tx39_flush_data_cache_page;\r\nflush_data_cache_page = tx39_flush_data_cache_page;\r\n_dma_cache_wback_inv = tx39_dma_cache_wback_inv;\r\n_dma_cache_wback = tx39_dma_cache_wback_inv;\r\n_dma_cache_inv = tx39_dma_cache_inv;\r\nshm_align_mask = max_t(unsigned long,\r\n(dcache_size / current_cpu_data.dcache.ways) - 1,\r\nPAGE_SIZE - 1);\r\nbreak;\r\n}\r\ncurrent_cpu_data.icache.waysize = icache_size / current_cpu_data.icache.ways;\r\ncurrent_cpu_data.dcache.waysize = dcache_size / current_cpu_data.dcache.ways;\r\ncurrent_cpu_data.icache.sets =\r\ncurrent_cpu_data.icache.waysize / current_cpu_data.icache.linesz;\r\ncurrent_cpu_data.dcache.sets =\r\ncurrent_cpu_data.dcache.waysize / current_cpu_data.dcache.linesz;\r\nif (current_cpu_data.dcache.waysize > PAGE_SIZE)\r\ncurrent_cpu_data.dcache.flags |= MIPS_CACHE_ALIASES;\r\ncurrent_cpu_data.icache.waybit = 0;\r\ncurrent_cpu_data.dcache.waybit = 0;\r\nprintk("Primary instruction cache %ldkB, linesize %d bytes\n",\r\nicache_size >> 10, current_cpu_data.icache.linesz);\r\nprintk("Primary data cache %ldkB, linesize %d bytes\n",\r\ndcache_size >> 10, current_cpu_data.dcache.linesz);\r\nbuild_clear_page();\r\nbuild_copy_page();\r\ntx39h_flush_icache_all();\r\n}

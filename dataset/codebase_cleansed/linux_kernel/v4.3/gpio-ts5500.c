static inline struct ts5500_priv *ts5500_gc_to_priv(struct gpio_chip *chip)\r\n{\r\nreturn container_of(chip, struct ts5500_priv, gpio_chip);\r\n}\r\nstatic inline void ts5500_set_mask(u8 mask, u8 addr)\r\n{\r\nu8 val = inb(addr);\r\nval |= mask;\r\noutb(val, addr);\r\n}\r\nstatic inline void ts5500_clear_mask(u8 mask, u8 addr)\r\n{\r\nu8 val = inb(addr);\r\nval &= ~mask;\r\noutb(val, addr);\r\n}\r\nstatic int ts5500_gpio_input(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct ts5500_priv *priv = ts5500_gc_to_priv(chip);\r\nconst struct ts5500_dio line = priv->pinout[offset];\r\nunsigned long flags;\r\nif (line.no_input)\r\nreturn -ENXIO;\r\nif (line.no_output)\r\nreturn 0;\r\nspin_lock_irqsave(&priv->lock, flags);\r\nts5500_clear_mask(line.control_mask, line.control_addr);\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int ts5500_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct ts5500_priv *priv = ts5500_gc_to_priv(chip);\r\nconst struct ts5500_dio line = priv->pinout[offset];\r\nreturn !!(inb(line.value_addr) & line.value_mask);\r\n}\r\nstatic int ts5500_gpio_output(struct gpio_chip *chip, unsigned offset, int val)\r\n{\r\nstruct ts5500_priv *priv = ts5500_gc_to_priv(chip);\r\nconst struct ts5500_dio line = priv->pinout[offset];\r\nunsigned long flags;\r\nif (line.no_output)\r\nreturn -ENXIO;\r\nspin_lock_irqsave(&priv->lock, flags);\r\nif (!line.no_input)\r\nts5500_set_mask(line.control_mask, line.control_addr);\r\nif (val)\r\nts5500_set_mask(line.value_mask, line.value_addr);\r\nelse\r\nts5500_clear_mask(line.value_mask, line.value_addr);\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void ts5500_gpio_set(struct gpio_chip *chip, unsigned offset, int val)\r\n{\r\nstruct ts5500_priv *priv = ts5500_gc_to_priv(chip);\r\nconst struct ts5500_dio line = priv->pinout[offset];\r\nunsigned long flags;\r\nspin_lock_irqsave(&priv->lock, flags);\r\nif (val)\r\nts5500_set_mask(line.value_mask, line.value_addr);\r\nelse\r\nts5500_clear_mask(line.value_mask, line.value_addr);\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\n}\r\nstatic int ts5500_gpio_to_irq(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct ts5500_priv *priv = ts5500_gc_to_priv(chip);\r\nconst struct ts5500_dio *block = priv->pinout;\r\nconst struct ts5500_dio line = block[offset];\r\nif (line.irq)\r\nreturn line.irq;\r\nif (priv->strap)\r\nreturn priv->hwirq;\r\nreturn -ENXIO;\r\n}\r\nstatic int ts5500_enable_irq(struct ts5500_priv *priv)\r\n{\r\nint ret = 0;\r\nunsigned long flags;\r\nspin_lock_irqsave(&priv->lock, flags);\r\nif (priv->hwirq == 7)\r\nts5500_set_mask(BIT(7), 0x7a);\r\nelse if (priv->hwirq == 6)\r\nts5500_set_mask(BIT(7), 0x7d);\r\nelse if (priv->hwirq == 1)\r\nts5500_set_mask(BIT(6), 0x7d);\r\nelse\r\nret = -EINVAL;\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nreturn ret;\r\n}\r\nstatic void ts5500_disable_irq(struct ts5500_priv *priv)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&priv->lock, flags);\r\nif (priv->hwirq == 7)\r\nts5500_clear_mask(BIT(7), 0x7a);\r\nelse if (priv->hwirq == 6)\r\nts5500_clear_mask(BIT(7), 0x7d);\r\nelse if (priv->hwirq == 1)\r\nts5500_clear_mask(BIT(6), 0x7d);\r\nelse\r\ndev_err(priv->gpio_chip.dev, "invalid hwirq %d\n", priv->hwirq);\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\n}\r\nstatic int ts5500_dio_probe(struct platform_device *pdev)\r\n{\r\nenum ts5500_blocks block = platform_get_device_id(pdev)->driver_data;\r\nstruct ts5500_dio_platform_data *pdata = dev_get_platdata(&pdev->dev);\r\nstruct device *dev = &pdev->dev;\r\nconst char *name = dev_name(dev);\r\nstruct ts5500_priv *priv;\r\nstruct resource *res;\r\nunsigned long flags;\r\nint ret;\r\nres = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (!res) {\r\ndev_err(dev, "missing IRQ resource\n");\r\nreturn -EINVAL;\r\n}\r\npriv = devm_kzalloc(dev, sizeof(struct ts5500_priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, priv);\r\npriv->hwirq = res->start;\r\nspin_lock_init(&priv->lock);\r\npriv->gpio_chip.owner = THIS_MODULE;\r\npriv->gpio_chip.label = name;\r\npriv->gpio_chip.dev = dev;\r\npriv->gpio_chip.direction_input = ts5500_gpio_input;\r\npriv->gpio_chip.direction_output = ts5500_gpio_output;\r\npriv->gpio_chip.get = ts5500_gpio_get;\r\npriv->gpio_chip.set = ts5500_gpio_set;\r\npriv->gpio_chip.to_irq = ts5500_gpio_to_irq;\r\npriv->gpio_chip.base = -1;\r\nif (pdata) {\r\npriv->gpio_chip.base = pdata->base;\r\npriv->strap = pdata->strap;\r\n}\r\nswitch (block) {\r\ncase TS5500_DIO1:\r\npriv->pinout = ts5500_dio1;\r\npriv->gpio_chip.ngpio = ARRAY_SIZE(ts5500_dio1);\r\nif (!devm_request_region(dev, 0x7a, 3, name)) {\r\ndev_err(dev, "failed to request %s ports\n", name);\r\nreturn -EBUSY;\r\n}\r\nbreak;\r\ncase TS5500_DIO2:\r\npriv->pinout = ts5500_dio2;\r\npriv->gpio_chip.ngpio = ARRAY_SIZE(ts5500_dio2);\r\nif (!devm_request_region(dev, 0x7e, 2, name)) {\r\ndev_err(dev, "failed to request %s ports\n", name);\r\nreturn -EBUSY;\r\n}\r\nif (hex7d_reserved)\r\nbreak;\r\nif (!devm_request_region(dev, 0x7d, 1, name)) {\r\ndev_err(dev, "failed to request %s 7D\n", name);\r\nreturn -EBUSY;\r\n}\r\nhex7d_reserved = true;\r\nbreak;\r\ncase TS5500_LCD:\r\ncase TS5600_LCD:\r\npriv->pinout = ts5500_lcd;\r\npriv->gpio_chip.ngpio = ARRAY_SIZE(ts5500_lcd);\r\nif (!devm_request_region(dev, 0x72, 2, name)) {\r\ndev_err(dev, "failed to request %s ports\n", name);\r\nreturn -EBUSY;\r\n}\r\nif (!hex7d_reserved) {\r\nif (!devm_request_region(dev, 0x7d, 1, name)) {\r\ndev_err(dev, "failed to request %s 7D\n", name);\r\nreturn -EBUSY;\r\n}\r\nhex7d_reserved = true;\r\n}\r\nspin_lock_irqsave(&priv->lock, flags);\r\nts5500_clear_mask(BIT(4), 0x7d);\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nbreak;\r\n}\r\nret = gpiochip_add(&priv->gpio_chip);\r\nif (ret) {\r\ndev_err(dev, "failed to register the gpio chip\n");\r\nreturn ret;\r\n}\r\nret = ts5500_enable_irq(priv);\r\nif (ret) {\r\ndev_err(dev, "invalid interrupt %d\n", priv->hwirq);\r\ngoto cleanup;\r\n}\r\nreturn 0;\r\ncleanup:\r\ngpiochip_remove(&priv->gpio_chip);\r\nreturn ret;\r\n}\r\nstatic int ts5500_dio_remove(struct platform_device *pdev)\r\n{\r\nstruct ts5500_priv *priv = platform_get_drvdata(pdev);\r\nts5500_disable_irq(priv);\r\ngpiochip_remove(&priv->gpio_chip);\r\nreturn 0;\r\n}

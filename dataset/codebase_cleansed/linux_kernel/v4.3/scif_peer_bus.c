static inline struct scif_peer_dev *\r\ndev_to_scif_peer(struct device *dev)\r\n{\r\nreturn container_of(dev, struct scif_peer_dev, dev);\r\n}\r\nstatic inline struct scif_peer_driver *\r\ndrv_to_scif_peer(struct device_driver *drv)\r\n{\r\nreturn container_of(drv, struct scif_peer_driver, driver);\r\n}\r\nstatic int scif_peer_dev_match(struct device *dv, struct device_driver *dr)\r\n{\r\nreturn !strncmp(dev_name(dv), dr->name, 4);\r\n}\r\nstatic int scif_peer_dev_probe(struct device *d)\r\n{\r\nstruct scif_peer_dev *dev = dev_to_scif_peer(d);\r\nstruct scif_peer_driver *drv = drv_to_scif_peer(dev->dev.driver);\r\nreturn drv->probe(dev);\r\n}\r\nstatic int scif_peer_dev_remove(struct device *d)\r\n{\r\nstruct scif_peer_dev *dev = dev_to_scif_peer(d);\r\nstruct scif_peer_driver *drv = drv_to_scif_peer(dev->dev.driver);\r\ndrv->remove(dev);\r\nreturn 0;\r\n}\r\nint scif_peer_register_driver(struct scif_peer_driver *driver)\r\n{\r\ndriver->driver.bus = &scif_peer_bus;\r\nreturn driver_register(&driver->driver);\r\n}\r\nvoid scif_peer_unregister_driver(struct scif_peer_driver *driver)\r\n{\r\ndriver_unregister(&driver->driver);\r\n}\r\nstatic void scif_peer_release_dev(struct device *d)\r\n{\r\nstruct scif_peer_dev *sdev = dev_to_scif_peer(d);\r\nstruct scif_dev *scifdev = &scif_dev[sdev->dnode];\r\nscif_cleanup_scifdev(scifdev);\r\nkfree(sdev);\r\n}\r\nstruct scif_peer_dev *\r\nscif_peer_register_device(struct scif_dev *scifdev)\r\n{\r\nint ret;\r\nstruct scif_peer_dev *spdev;\r\nspdev = kzalloc(sizeof(*spdev), GFP_KERNEL);\r\nif (!spdev)\r\nreturn ERR_PTR(-ENOMEM);\r\nspdev->dev.parent = scifdev->sdev->dev.parent;\r\nspdev->dev.release = scif_peer_release_dev;\r\nspdev->dnode = scifdev->node;\r\nspdev->dev.bus = &scif_peer_bus;\r\ndev_set_name(&spdev->dev, "scif_peer-dev%u", spdev->dnode);\r\nret = device_register(&spdev->dev);\r\nif (ret)\r\ngoto free_spdev;\r\nreturn spdev;\r\nfree_spdev:\r\nkfree(spdev);\r\nreturn ERR_PTR(ret);\r\n}\r\nvoid scif_peer_unregister_device(struct scif_peer_dev *sdev)\r\n{\r\ndevice_unregister(&sdev->dev);\r\n}\r\nint scif_peer_bus_init(void)\r\n{\r\nreturn bus_register(&scif_peer_bus);\r\n}\r\nvoid scif_peer_bus_exit(void)\r\n{\r\nbus_unregister(&scif_peer_bus);\r\n}

static u8 rtl8411_get_ic_version(struct rtsx_pcr *pcr)\r\n{\r\nu8 val;\r\nrtsx_pci_read_register(pcr, SYS_VER, &val);\r\nreturn val & 0x0F;\r\n}\r\nstatic int rtl8411b_is_qfn48(struct rtsx_pcr *pcr)\r\n{\r\nu8 val = 0;\r\nrtsx_pci_read_register(pcr, RTL8411B_PACKAGE_MODE, &val);\r\nif (val & 0x2)\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic void rtl8411_fetch_vendor_settings(struct rtsx_pcr *pcr)\r\n{\r\nu32 reg1 = 0;\r\nu8 reg3 = 0;\r\nrtsx_pci_read_config_dword(pcr, PCR_SETTING_REG1, &reg1);\r\npcr_dbg(pcr, "Cfg 0x%x: 0x%x\n", PCR_SETTING_REG1, reg1);\r\nif (!rtsx_vendor_setting_valid(reg1))\r\nreturn;\r\npcr->aspm_en = rtsx_reg_to_aspm(reg1);\r\npcr->sd30_drive_sel_1v8 =\r\nmap_sd_drive(rtsx_reg_to_sd30_drive_sel_1v8(reg1));\r\npcr->card_drive_sel &= 0x3F;\r\npcr->card_drive_sel |= rtsx_reg_to_card_drive_sel(reg1);\r\nrtsx_pci_read_config_byte(pcr, PCR_SETTING_REG3, &reg3);\r\npcr_dbg(pcr, "Cfg 0x%x: 0x%x\n", PCR_SETTING_REG3, reg3);\r\npcr->sd30_drive_sel_3v3 = rtl8411_reg_to_sd30_drive_sel_3v3(reg3);\r\n}\r\nstatic void rtl8411b_fetch_vendor_settings(struct rtsx_pcr *pcr)\r\n{\r\nu32 reg = 0;\r\nrtsx_pci_read_config_dword(pcr, PCR_SETTING_REG1, &reg);\r\npcr_dbg(pcr, "Cfg 0x%x: 0x%x\n", PCR_SETTING_REG1, reg);\r\nif (!rtsx_vendor_setting_valid(reg))\r\nreturn;\r\npcr->aspm_en = rtsx_reg_to_aspm(reg);\r\npcr->sd30_drive_sel_1v8 =\r\nmap_sd_drive(rtsx_reg_to_sd30_drive_sel_1v8(reg));\r\npcr->sd30_drive_sel_3v3 =\r\nmap_sd_drive(rtl8411b_reg_to_sd30_drive_sel_3v3(reg));\r\n}\r\nstatic void rtl8411_force_power_down(struct rtsx_pcr *pcr, u8 pm_state)\r\n{\r\nrtsx_pci_write_register(pcr, FPDCTL, 0x07, 0x07);\r\n}\r\nstatic int rtl8411_extra_init_hw(struct rtsx_pcr *pcr)\r\n{\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_DRIVE_SEL,\r\n0xFF, pcr->sd30_drive_sel_3v3);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CD_PAD_CTL,\r\nCD_DISABLE_MASK | CD_AUTO_DISABLE, CD_ENABLE);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nstatic int rtl8411b_extra_init_hw(struct rtsx_pcr *pcr)\r\n{\r\nrtsx_pci_init_cmd(pcr);\r\nif (rtl8411b_is_qfn48(pcr))\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD,\r\nCARD_PULL_CTL3, 0xFF, 0xF5);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_DRIVE_SEL,\r\n0xFF, pcr->sd30_drive_sel_3v3);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CD_PAD_CTL,\r\nCD_DISABLE_MASK | CD_AUTO_DISABLE, CD_ENABLE);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, FUNC_FORCE_CTL,\r\n0x06, 0x00);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nstatic int rtl8411_turn_on_led(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, CARD_GPIO, 0x01, 0x00);\r\n}\r\nstatic int rtl8411_turn_off_led(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, CARD_GPIO, 0x01, 0x01);\r\n}\r\nstatic int rtl8411_enable_auto_blink(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, CARD_AUTO_BLINK, 0xFF, 0x0D);\r\n}\r\nstatic int rtl8411_disable_auto_blink(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, CARD_AUTO_BLINK, 0x08, 0x00);\r\n}\r\nstatic int rtl8411_card_power_on(struct rtsx_pcr *pcr, int card)\r\n{\r\nint err;\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\r\nBPP_POWER_MASK, BPP_POWER_5_PERCENT_ON);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LDO_CTL,\r\nBPP_LDO_POWB, BPP_LDO_SUSPEND);\r\nerr = rtsx_pci_send_cmd(pcr, 100);\r\nif (err < 0)\r\nreturn err;\r\nudelay(150);\r\nerr = rtsx_pci_write_register(pcr, CARD_PWR_CTL,\r\nBPP_POWER_MASK, BPP_POWER_10_PERCENT_ON);\r\nif (err < 0)\r\nreturn err;\r\nudelay(150);\r\nerr = rtsx_pci_write_register(pcr, CARD_PWR_CTL,\r\nBPP_POWER_MASK, BPP_POWER_15_PERCENT_ON);\r\nif (err < 0)\r\nreturn err;\r\nudelay(150);\r\nerr = rtsx_pci_write_register(pcr, CARD_PWR_CTL,\r\nBPP_POWER_MASK, BPP_POWER_ON);\r\nif (err < 0)\r\nreturn err;\r\nreturn rtsx_pci_write_register(pcr, LDO_CTL, BPP_LDO_POWB, BPP_LDO_ON);\r\n}\r\nstatic int rtl8411_card_power_off(struct rtsx_pcr *pcr, int card)\r\n{\r\nint err;\r\nerr = rtsx_pci_write_register(pcr, CARD_PWR_CTL,\r\nBPP_POWER_MASK, BPP_POWER_OFF);\r\nif (err < 0)\r\nreturn err;\r\nreturn rtsx_pci_write_register(pcr, LDO_CTL,\r\nBPP_LDO_POWB, BPP_LDO_SUSPEND);\r\n}\r\nstatic int rtl8411_do_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage,\r\nint bpp_tuned18_shift, int bpp_asic_1v8)\r\n{\r\nu8 mask, val;\r\nint err;\r\nmask = (BPP_REG_TUNED18 << bpp_tuned18_shift) | BPP_PAD_MASK;\r\nif (voltage == OUTPUT_3V3) {\r\nerr = rtsx_pci_write_register(pcr,\r\nSD30_DRIVE_SEL, 0x07, pcr->sd30_drive_sel_3v3);\r\nif (err < 0)\r\nreturn err;\r\nval = (BPP_ASIC_3V3 << bpp_tuned18_shift) | BPP_PAD_3V3;\r\n} else if (voltage == OUTPUT_1V8) {\r\nerr = rtsx_pci_write_register(pcr,\r\nSD30_DRIVE_SEL, 0x07, pcr->sd30_drive_sel_1v8);\r\nif (err < 0)\r\nreturn err;\r\nval = (bpp_asic_1v8 << bpp_tuned18_shift) | BPP_PAD_1V8;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\nreturn rtsx_pci_write_register(pcr, LDO_CTL, mask, val);\r\n}\r\nstatic int rtl8411_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\r\n{\r\nreturn rtl8411_do_switch_output_voltage(pcr, voltage,\r\nBPP_TUNED18_SHIFT_8411, BPP_ASIC_1V8);\r\n}\r\nstatic int rtl8402_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\r\n{\r\nreturn rtl8411_do_switch_output_voltage(pcr, voltage,\r\nBPP_TUNED18_SHIFT_8402, BPP_ASIC_2V0);\r\n}\r\nstatic unsigned int rtl8411_cd_deglitch(struct rtsx_pcr *pcr)\r\n{\r\nunsigned int card_exist;\r\ncard_exist = rtsx_pci_readl(pcr, RTSX_BIPR);\r\ncard_exist &= CARD_EXIST;\r\nif (!card_exist) {\r\nrtsx_pci_write_register(pcr, CD_PAD_CTL,\r\nCD_DISABLE_MASK, CD_ENABLE);\r\nrtsx_pci_write_register(pcr, EFUSE_CONTENT, 0xe0, 0x00);\r\nreturn 0;\r\n}\r\nif (hweight32(card_exist) > 1) {\r\nrtsx_pci_write_register(pcr, CARD_PWR_CTL,\r\nBPP_POWER_MASK, BPP_POWER_5_PERCENT_ON);\r\nmsleep(100);\r\ncard_exist = rtsx_pci_readl(pcr, RTSX_BIPR);\r\nif (card_exist & MS_EXIST)\r\ncard_exist = MS_EXIST;\r\nelse if (card_exist & SD_EXIST)\r\ncard_exist = SD_EXIST;\r\nelse\r\ncard_exist = 0;\r\nrtsx_pci_write_register(pcr, CARD_PWR_CTL,\r\nBPP_POWER_MASK, BPP_POWER_OFF);\r\npcr_dbg(pcr, "After CD deglitch, card_exist = 0x%x\n",\r\ncard_exist);\r\n}\r\nif (card_exist & MS_EXIST) {\r\nrtsx_pci_write_register(pcr, EFUSE_CONTENT, 0xe0, 0x40);\r\nrtsx_pci_write_register(pcr, CD_PAD_CTL,\r\nCD_DISABLE_MASK, MS_CD_EN_ONLY);\r\n} else if (card_exist & SD_EXIST) {\r\nrtsx_pci_write_register(pcr, EFUSE_CONTENT, 0xe0, 0x80);\r\nrtsx_pci_write_register(pcr, CD_PAD_CTL,\r\nCD_DISABLE_MASK, SD_CD_EN_ONLY);\r\n}\r\nreturn card_exist;\r\n}\r\nstatic int rtl8411_conv_clk_and_div_n(int input, int dir)\r\n{\r\nint output;\r\nif (dir == CLK_TO_DIV_N)\r\noutput = input * 4 / 5 - 2;\r\nelse\r\noutput = (input + 2) * 5 / 4;\r\nreturn output;\r\n}\r\nstatic void rtl8411_init_common_params(struct rtsx_pcr *pcr)\r\n{\r\npcr->extra_caps = EXTRA_CAPS_SD_SDR50 | EXTRA_CAPS_SD_SDR104;\r\npcr->num_slots = 2;\r\npcr->flags = 0;\r\npcr->card_drive_sel = RTL8411_CARD_DRIVE_DEFAULT;\r\npcr->sd30_drive_sel_1v8 = DRIVER_TYPE_B;\r\npcr->sd30_drive_sel_3v3 = DRIVER_TYPE_D;\r\npcr->aspm_en = ASPM_L1_EN;\r\npcr->tx_initial_phase = SET_CLOCK_PHASE(23, 7, 14);\r\npcr->rx_initial_phase = SET_CLOCK_PHASE(4, 3, 10);\r\npcr->ic_version = rtl8411_get_ic_version(pcr);\r\n}\r\nvoid rtl8411_init_params(struct rtsx_pcr *pcr)\r\n{\r\nrtl8411_init_common_params(pcr);\r\npcr->ops = &rtl8411_pcr_ops;\r\nset_pull_ctrl_tables(pcr, rtl8411);\r\n}\r\nvoid rtl8411b_init_params(struct rtsx_pcr *pcr)\r\n{\r\nrtl8411_init_common_params(pcr);\r\npcr->ops = &rtl8411b_pcr_ops;\r\nif (rtl8411b_is_qfn48(pcr))\r\nset_pull_ctrl_tables(pcr, rtl8411b_qfn48);\r\nelse\r\nset_pull_ctrl_tables(pcr, rtl8411b_qfn64);\r\n}\r\nvoid rtl8402_init_params(struct rtsx_pcr *pcr)\r\n{\r\nrtl8411_init_common_params(pcr);\r\npcr->ops = &rtl8402_pcr_ops;\r\nset_pull_ctrl_tables(pcr, rtl8411);\r\n}

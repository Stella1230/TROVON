static int __split_add_bits(struct sw842_param *p, u64 d, u8 n, u8 s)\r\n{\r\nint ret;\r\nif (n <= s)\r\nreturn -EINVAL;\r\nret = add_bits(p, d >> s, n - s);\r\nif (ret)\r\nreturn ret;\r\nreturn add_bits(p, d & GENMASK_ULL(s - 1, 0), s);\r\n}\r\nstatic int add_bits(struct sw842_param *p, u64 d, u8 n)\r\n{\r\nint b = p->bit, bits = b + n, s = round_up(bits, 8) - bits;\r\nu64 o;\r\nu8 *out = p->out;\r\npr_debug("add %u bits %lx\n", (unsigned char)n, (unsigned long)d);\r\nif (n > 64)\r\nreturn -EINVAL;\r\nif (bits > 64)\r\nreturn __split_add_bits(p, d, n, 32);\r\nelse if (p->olen < 8 && bits > 32 && bits <= 56)\r\nreturn __split_add_bits(p, d, n, 16);\r\nelse if (p->olen < 4 && bits > 16 && bits <= 24)\r\nreturn __split_add_bits(p, d, n, 8);\r\nif (DIV_ROUND_UP(bits, 8) > p->olen)\r\nreturn -ENOSPC;\r\no = *out & bmask[b];\r\nd <<= s;\r\nif (bits <= 8)\r\n*out = o | d;\r\nelse if (bits <= 16)\r\nput_unaligned(cpu_to_be16(o << 8 | d), (__be16 *)out);\r\nelse if (bits <= 24)\r\nput_unaligned(cpu_to_be32(o << 24 | d << 8), (__be32 *)out);\r\nelse if (bits <= 32)\r\nput_unaligned(cpu_to_be32(o << 24 | d), (__be32 *)out);\r\nelse if (bits <= 40)\r\nput_unaligned(cpu_to_be64(o << 56 | d << 24), (__be64 *)out);\r\nelse if (bits <= 48)\r\nput_unaligned(cpu_to_be64(o << 56 | d << 16), (__be64 *)out);\r\nelse if (bits <= 56)\r\nput_unaligned(cpu_to_be64(o << 56 | d << 8), (__be64 *)out);\r\nelse\r\nput_unaligned(cpu_to_be64(o << 56 | d), (__be64 *)out);\r\np->bit += n;\r\nif (p->bit > 7) {\r\np->out += p->bit / 8;\r\np->olen -= p->bit / 8;\r\np->bit %= 8;\r\n}\r\nreturn 0;\r\n}\r\nstatic int add_template(struct sw842_param *p, u8 c)\r\n{\r\nint ret, i, b = 0;\r\nu8 *t = comp_ops[c];\r\nbool inv = false;\r\nif (c >= OPS_MAX)\r\nreturn -EINVAL;\r\npr_debug("template %x\n", t[4]);\r\nret = add_bits(p, t[4], OP_BITS);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < 4; i++) {\r\npr_debug("op %x\n", t[i]);\r\nswitch (t[i] & OP_AMOUNT) {\r\ncase OP_AMOUNT_8:\r\nif (b)\r\ninv = true;\r\nelse if (t[i] & OP_ACTION_INDEX)\r\nret = add_bits(p, p->index8[0], I8_BITS);\r\nelse if (t[i] & OP_ACTION_DATA)\r\nret = add_bits(p, p->data8[0], 64);\r\nelse\r\ninv = true;\r\nbreak;\r\ncase OP_AMOUNT_4:\r\nif (b == 2 && t[i] & OP_ACTION_DATA)\r\nret = add_bits(p, get_input_data(p, 2, 32), 32);\r\nelse if (b != 0 && b != 4)\r\ninv = true;\r\nelse if (t[i] & OP_ACTION_INDEX)\r\nret = add_bits(p, p->index4[b >> 2], I4_BITS);\r\nelse if (t[i] & OP_ACTION_DATA)\r\nret = add_bits(p, p->data4[b >> 2], 32);\r\nelse\r\ninv = true;\r\nbreak;\r\ncase OP_AMOUNT_2:\r\nif (b != 0 && b != 2 && b != 4 && b != 6)\r\ninv = true;\r\nif (t[i] & OP_ACTION_INDEX)\r\nret = add_bits(p, p->index2[b >> 1], I2_BITS);\r\nelse if (t[i] & OP_ACTION_DATA)\r\nret = add_bits(p, p->data2[b >> 1], 16);\r\nelse\r\ninv = true;\r\nbreak;\r\ncase OP_AMOUNT_0:\r\ninv = (b != 8) || !(t[i] & OP_ACTION_NOOP);\r\nbreak;\r\ndefault:\r\ninv = true;\r\nbreak;\r\n}\r\nif (ret)\r\nreturn ret;\r\nif (inv) {\r\npr_err("Invalid templ %x op %d : %x %x %x %x\n",\r\nc, i, t[0], t[1], t[2], t[3]);\r\nreturn -EINVAL;\r\n}\r\nb += t[i] & OP_AMOUNT;\r\n}\r\nif (b != 8) {\r\npr_err("Invalid template %x len %x : %x %x %x %x\n",\r\nc, b, t[0], t[1], t[2], t[3]);\r\nreturn -EINVAL;\r\n}\r\nif (sw842_template_counts)\r\natomic_inc(&template_count[t[4]]);\r\nreturn 0;\r\n}\r\nstatic int add_repeat_template(struct sw842_param *p, u8 r)\r\n{\r\nint ret;\r\nif (!r || --r > REPEAT_BITS_MAX)\r\nreturn -EINVAL;\r\nret = add_bits(p, OP_REPEAT, OP_BITS);\r\nif (ret)\r\nreturn ret;\r\nret = add_bits(p, r, REPEAT_BITS);\r\nif (ret)\r\nreturn ret;\r\nif (sw842_template_counts)\r\natomic_inc(&template_repeat_count);\r\nreturn 0;\r\n}\r\nstatic int add_short_data_template(struct sw842_param *p, u8 b)\r\n{\r\nint ret, i;\r\nif (!b || b > SHORT_DATA_BITS_MAX)\r\nreturn -EINVAL;\r\nret = add_bits(p, OP_SHORT_DATA, OP_BITS);\r\nif (ret)\r\nreturn ret;\r\nret = add_bits(p, b, SHORT_DATA_BITS);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < b; i++) {\r\nret = add_bits(p, p->in[i], 8);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (sw842_template_counts)\r\natomic_inc(&template_short_data_count);\r\nreturn 0;\r\n}\r\nstatic int add_zeros_template(struct sw842_param *p)\r\n{\r\nint ret = add_bits(p, OP_ZEROS, OP_BITS);\r\nif (ret)\r\nreturn ret;\r\nif (sw842_template_counts)\r\natomic_inc(&template_zeros_count);\r\nreturn 0;\r\n}\r\nstatic int add_end_template(struct sw842_param *p)\r\n{\r\nint ret = add_bits(p, OP_END, OP_BITS);\r\nif (ret)\r\nreturn ret;\r\nif (sw842_template_counts)\r\natomic_inc(&template_end_count);\r\nreturn 0;\r\n}\r\nstatic bool check_template(struct sw842_param *p, u8 c)\r\n{\r\nu8 *t = comp_ops[c];\r\nint i, match, b = 0;\r\nif (c >= OPS_MAX)\r\nreturn false;\r\nfor (i = 0; i < 4; i++) {\r\nif (t[i] & OP_ACTION_INDEX) {\r\nif (t[i] & OP_AMOUNT_2)\r\nmatch = check_index(p, 2, b >> 1);\r\nelse if (t[i] & OP_AMOUNT_4)\r\nmatch = check_index(p, 4, b >> 2);\r\nelse if (t[i] & OP_AMOUNT_8)\r\nmatch = check_index(p, 8, 0);\r\nelse\r\nreturn false;\r\nif (!match)\r\nreturn false;\r\n}\r\nb += t[i] & OP_AMOUNT;\r\n}\r\nreturn true;\r\n}\r\nstatic void get_next_data(struct sw842_param *p)\r\n{\r\np->data8[0] = get_input_data(p, 0, 64);\r\np->data4[0] = get_input_data(p, 0, 32);\r\np->data4[1] = get_input_data(p, 4, 32);\r\np->data2[0] = get_input_data(p, 0, 16);\r\np->data2[1] = get_input_data(p, 2, 16);\r\np->data2[2] = get_input_data(p, 4, 16);\r\np->data2[3] = get_input_data(p, 6, 16);\r\n}\r\nstatic void update_hashtables(struct sw842_param *p)\r\n{\r\nu64 pos = p->in - p->instart;\r\nu64 n8 = (pos >> 3) % (1 << I8_BITS);\r\nu64 n4 = (pos >> 2) % (1 << I4_BITS);\r\nu64 n2 = (pos >> 1) % (1 << I2_BITS);\r\nreplace_hash(p, 8, n8, 0);\r\nreplace_hash(p, 4, n4, 0);\r\nreplace_hash(p, 4, n4, 1);\r\nreplace_hash(p, 2, n2, 0);\r\nreplace_hash(p, 2, n2, 1);\r\nreplace_hash(p, 2, n2, 2);\r\nreplace_hash(p, 2, n2, 3);\r\n}\r\nstatic int process_next(struct sw842_param *p)\r\n{\r\nint ret, i;\r\np->index8[0] = INDEX_NOT_CHECKED;\r\np->index4[0] = INDEX_NOT_CHECKED;\r\np->index4[1] = INDEX_NOT_CHECKED;\r\np->index2[0] = INDEX_NOT_CHECKED;\r\np->index2[1] = INDEX_NOT_CHECKED;\r\np->index2[2] = INDEX_NOT_CHECKED;\r\np->index2[3] = INDEX_NOT_CHECKED;\r\nfor (i = 0; i < OPS_MAX - 1; i++) {\r\nif (check_template(p, i))\r\nbreak;\r\n}\r\nret = add_template(p, i);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint sw842_compress(const u8 *in, unsigned int ilen,\r\nu8 *out, unsigned int *olen, void *wmem)\r\n{\r\nstruct sw842_param *p = (struct sw842_param *)wmem;\r\nint ret;\r\nu64 last, next, pad, total;\r\nu8 repeat_count = 0;\r\nBUILD_BUG_ON(sizeof(*p) > SW842_MEM_COMPRESS);\r\ninit_hashtable_nodes(p, 8);\r\ninit_hashtable_nodes(p, 4);\r\ninit_hashtable_nodes(p, 2);\r\np->in = (u8 *)in;\r\np->instart = p->in;\r\np->ilen = ilen;\r\np->out = out;\r\np->olen = *olen;\r\np->bit = 0;\r\ntotal = p->olen;\r\n*olen = 0;\r\nif (sw842_strict && (ilen % 8)) {\r\npr_err("Using strict mode, can't compress len %d\n", ilen);\r\nreturn -EINVAL;\r\n}\r\nif (unlikely(ilen < 8))\r\ngoto skip_comp;\r\nlast = ~get_unaligned((u64 *)p->in);\r\nwhile (p->ilen > 7) {\r\nnext = get_unaligned((u64 *)p->in);\r\nget_next_data(p);\r\nif (next == last) {\r\nif (++repeat_count <= REPEAT_BITS_MAX)\r\ngoto repeat;\r\n}\r\nif (repeat_count) {\r\nret = add_repeat_template(p, repeat_count);\r\nrepeat_count = 0;\r\nif (next == last)\r\ngoto repeat;\r\n}\r\nif (next == 0)\r\nret = add_zeros_template(p);\r\nelse\r\nret = process_next(p);\r\nif (ret)\r\nreturn ret;\r\nrepeat:\r\nlast = next;\r\nupdate_hashtables(p);\r\np->in += 8;\r\np->ilen -= 8;\r\n}\r\nif (repeat_count) {\r\nret = add_repeat_template(p, repeat_count);\r\nif (ret)\r\nreturn ret;\r\n}\r\nskip_comp:\r\nif (p->ilen > 0) {\r\nret = add_short_data_template(p, p->ilen);\r\nif (ret)\r\nreturn ret;\r\np->in += p->ilen;\r\np->ilen = 0;\r\n}\r\nret = add_end_template(p);\r\nif (ret)\r\nreturn ret;\r\nif (p->bit) {\r\np->out++;\r\np->olen--;\r\np->bit = 0;\r\n}\r\npad = (8 - ((total - p->olen) % 8)) % 8;\r\nif (pad) {\r\nif (pad > p->olen)\r\nreturn -ENOSPC;\r\nmemset(p->out, 0, pad);\r\np->out += pad;\r\np->olen -= pad;\r\n}\r\nif (unlikely((total - p->olen) > UINT_MAX))\r\nreturn -ENOSPC;\r\n*olen = total - p->olen;\r\nreturn 0;\r\n}\r\nstatic int __init sw842_init(void)\r\n{\r\nif (sw842_template_counts)\r\nsw842_debugfs_create();\r\nreturn 0;\r\n}\r\nstatic void __exit sw842_exit(void)\r\n{\r\nif (sw842_template_counts)\r\nsw842_debugfs_remove();\r\n}

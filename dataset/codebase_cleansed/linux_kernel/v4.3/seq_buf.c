static bool seq_buf_can_fit(struct seq_buf *s, size_t len)\r\n{\r\nreturn s->len + len <= s->size;\r\n}\r\nint seq_buf_print_seq(struct seq_file *m, struct seq_buf *s)\r\n{\r\nunsigned int len = seq_buf_used(s);\r\nreturn seq_write(m, s->buffer, len);\r\n}\r\nint seq_buf_vprintf(struct seq_buf *s, const char *fmt, va_list args)\r\n{\r\nint len;\r\nWARN_ON(s->size == 0);\r\nif (s->len < s->size) {\r\nlen = vsnprintf(s->buffer + s->len, s->size - s->len, fmt, args);\r\nif (s->len + len < s->size) {\r\ns->len += len;\r\nreturn 0;\r\n}\r\n}\r\nseq_buf_set_overflow(s);\r\nreturn -1;\r\n}\r\nint seq_buf_printf(struct seq_buf *s, const char *fmt, ...)\r\n{\r\nva_list ap;\r\nint ret;\r\nva_start(ap, fmt);\r\nret = seq_buf_vprintf(s, fmt, ap);\r\nva_end(ap);\r\nreturn ret;\r\n}\r\nint seq_buf_bprintf(struct seq_buf *s, const char *fmt, const u32 *binary)\r\n{\r\nunsigned int len = seq_buf_buffer_left(s);\r\nint ret;\r\nWARN_ON(s->size == 0);\r\nif (s->len < s->size) {\r\nret = bstr_printf(s->buffer + s->len, len, fmt, binary);\r\nif (s->len + ret < s->size) {\r\ns->len += ret;\r\nreturn 0;\r\n}\r\n}\r\nseq_buf_set_overflow(s);\r\nreturn -1;\r\n}\r\nint seq_buf_puts(struct seq_buf *s, const char *str)\r\n{\r\nunsigned int len = strlen(str);\r\nWARN_ON(s->size == 0);\r\nif (seq_buf_can_fit(s, len)) {\r\nmemcpy(s->buffer + s->len, str, len);\r\ns->len += len;\r\nreturn 0;\r\n}\r\nseq_buf_set_overflow(s);\r\nreturn -1;\r\n}\r\nint seq_buf_putc(struct seq_buf *s, unsigned char c)\r\n{\r\nWARN_ON(s->size == 0);\r\nif (seq_buf_can_fit(s, 1)) {\r\ns->buffer[s->len++] = c;\r\nreturn 0;\r\n}\r\nseq_buf_set_overflow(s);\r\nreturn -1;\r\n}\r\nint seq_buf_putmem(struct seq_buf *s, const void *mem, unsigned int len)\r\n{\r\nWARN_ON(s->size == 0);\r\nif (seq_buf_can_fit(s, len)) {\r\nmemcpy(s->buffer + s->len, mem, len);\r\ns->len += len;\r\nreturn 0;\r\n}\r\nseq_buf_set_overflow(s);\r\nreturn -1;\r\n}\r\nint seq_buf_path(struct seq_buf *s, const struct path *path, const char *esc)\r\n{\r\nchar *buf;\r\nsize_t size = seq_buf_get_buf(s, &buf);\r\nint res = -1;\r\nWARN_ON(s->size == 0);\r\nif (size) {\r\nchar *p = d_path(path, buf, size);\r\nif (!IS_ERR(p)) {\r\nchar *end = mangle_path(buf, p, esc);\r\nif (end)\r\nres = end - buf;\r\n}\r\n}\r\nseq_buf_commit(s, res);\r\nreturn res;\r\n}\r\nint seq_buf_to_user(struct seq_buf *s, char __user *ubuf, int cnt)\r\n{\r\nint len;\r\nint ret;\r\nif (!cnt)\r\nreturn 0;\r\nif (s->len <= s->readpos)\r\nreturn -EBUSY;\r\nlen = seq_buf_used(s) - s->readpos;\r\nif (cnt > len)\r\ncnt = len;\r\nret = copy_to_user(ubuf, s->buffer + s->readpos, cnt);\r\nif (ret == cnt)\r\nreturn -EFAULT;\r\ncnt -= ret;\r\ns->readpos += cnt;\r\nreturn cnt;\r\n}

static int ab8500_regulator_enable(struct regulator_dev *rdev)\r\n{\r\nint ret;\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nret = abx500_mask_and_set_register_interruptible(info->dev,\r\ninfo->update_bank, info->update_reg,\r\ninfo->update_mask, info->update_val);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't set enable bits for regulator\n");\r\nreturn ret;\r\n}\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-enable (bank, reg, mask, value): 0x%x, 0x%x, 0x%x, 0x%x\n",\r\ninfo->desc.name, info->update_bank, info->update_reg,\r\ninfo->update_mask, info->update_val);\r\nreturn ret;\r\n}\r\nstatic int ab8500_regulator_disable(struct regulator_dev *rdev)\r\n{\r\nint ret;\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nret = abx500_mask_and_set_register_interruptible(info->dev,\r\ninfo->update_bank, info->update_reg,\r\ninfo->update_mask, 0x0);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't set disable bits for regulator\n");\r\nreturn ret;\r\n}\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-disable (bank, reg, mask, value): 0x%x, 0x%x, 0x%x, 0x%x\n",\r\ninfo->desc.name, info->update_bank, info->update_reg,\r\ninfo->update_mask, 0x0);\r\nreturn ret;\r\n}\r\nstatic int ab8500_regulator_is_enabled(struct regulator_dev *rdev)\r\n{\r\nint ret;\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nu8 regval;\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nret = abx500_get_register_interruptible(info->dev,\r\ninfo->update_bank, info->update_reg, &regval);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't read 0x%x register\n", info->update_reg);\r\nreturn ret;\r\n}\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-is_enabled (bank, reg, mask, value): 0x%x, 0x%x, 0x%x,"\r\n" 0x%x\n",\r\ninfo->desc.name, info->update_bank, info->update_reg,\r\ninfo->update_mask, regval);\r\nif (regval & info->update_mask)\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic unsigned int ab8500_regulator_get_optimum_mode(\r\nstruct regulator_dev *rdev, int input_uV,\r\nint output_uV, int load_uA)\r\n{\r\nunsigned int mode;\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nif (load_uA <= info->load_lp_uA)\r\nmode = REGULATOR_MODE_IDLE;\r\nelse\r\nmode = REGULATOR_MODE_NORMAL;\r\nreturn mode;\r\n}\r\nstatic int ab8500_regulator_set_mode(struct regulator_dev *rdev,\r\nunsigned int mode)\r\n{\r\nint ret = 0;\r\nu8 bank, reg, mask, val;\r\nbool lp_mode_req = false;\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nif (info->mode_mask) {\r\nbank = info->mode_bank;\r\nreg = info->mode_reg;\r\nmask = info->mode_mask;\r\n} else {\r\nbank = info->update_bank;\r\nreg = info->update_reg;\r\nmask = info->update_mask;\r\n}\r\nif (info->shared_mode)\r\nmutex_lock(&shared_mode_mutex);\r\nswitch (mode) {\r\ncase REGULATOR_MODE_NORMAL:\r\nif (info->shared_mode)\r\nlp_mode_req = false;\r\nif (info->mode_mask)\r\nval = info->mode_val_normal;\r\nelse\r\nval = info->update_val_normal;\r\nbreak;\r\ncase REGULATOR_MODE_IDLE:\r\nif (info->shared_mode) {\r\nstruct ab8500_regulator_info *shared_regulator;\r\nshared_regulator = info->shared_mode->shared_regulator;\r\nif (!shared_regulator->shared_mode->lp_mode_req) {\r\ninfo->shared_mode->lp_mode_req = true;\r\ngoto out_unlock;\r\n}\r\nlp_mode_req = true;\r\n}\r\nif (info->mode_mask)\r\nval = info->mode_val_idle;\r\nelse\r\nval = info->update_val_idle;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\ngoto out_unlock;\r\n}\r\nif (info->mode_mask || ab8500_regulator_is_enabled(rdev)) {\r\nret = abx500_mask_and_set_register_interruptible(info->dev,\r\nbank, reg, mask, val);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't set regulator mode\n");\r\ngoto out_unlock;\r\n}\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-set_mode (bank, reg, mask, value): "\r\n"0x%x, 0x%x, 0x%x, 0x%x\n",\r\ninfo->desc.name, bank, reg,\r\nmask, val);\r\n}\r\nif (!info->mode_mask)\r\ninfo->update_val = val;\r\nif (info->shared_mode)\r\ninfo->shared_mode->lp_mode_req = lp_mode_req;\r\nout_unlock:\r\nif (info->shared_mode)\r\nmutex_unlock(&shared_mode_mutex);\r\nreturn ret;\r\n}\r\nstatic unsigned int ab8500_regulator_get_mode(struct regulator_dev *rdev)\r\n{\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nint ret;\r\nu8 val;\r\nu8 val_normal;\r\nu8 val_idle;\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nif (info->shared_mode) {\r\nif (info->shared_mode->lp_mode_req)\r\nreturn REGULATOR_MODE_IDLE;\r\nelse\r\nreturn REGULATOR_MODE_NORMAL;\r\n}\r\nif (info->mode_mask) {\r\nret = abx500_get_register_interruptible(info->dev,\r\ninfo->mode_bank, info->mode_reg, &val);\r\nval = val & info->mode_mask;\r\nval_normal = info->mode_val_normal;\r\nval_idle = info->mode_val_idle;\r\n} else {\r\nval = info->update_val;\r\nval_normal = info->update_val_normal;\r\nval_idle = info->update_val_idle;\r\n}\r\nif (val == val_normal)\r\nret = REGULATOR_MODE_NORMAL;\r\nelse if (val == val_idle)\r\nret = REGULATOR_MODE_IDLE;\r\nelse\r\nret = -EINVAL;\r\nreturn ret;\r\n}\r\nstatic int ab8500_regulator_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nint ret, voltage_shift;\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nu8 regval;\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nvoltage_shift = ffs(info->voltage_mask) - 1;\r\nret = abx500_get_register_interruptible(info->dev,\r\ninfo->voltage_bank, info->voltage_reg, &regval);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't read voltage reg for regulator\n");\r\nreturn ret;\r\n}\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-get_voltage (bank, reg, mask, shift, value): "\r\n"0x%x, 0x%x, 0x%x, 0x%x, 0x%x\n",\r\ninfo->desc.name, info->voltage_bank,\r\ninfo->voltage_reg, info->voltage_mask,\r\nvoltage_shift, regval);\r\nreturn (regval & info->voltage_mask) >> voltage_shift;\r\n}\r\nstatic int ab8540_aux3_regulator_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nint ret, voltage_shift;\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nu8 regval, regval_expand;\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nret = abx500_get_register_interruptible(info->dev,\r\ninfo->expand_register.voltage_bank,\r\ninfo->expand_register.voltage_reg, &regval_expand);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't read voltage expand reg for regulator\n");\r\nreturn ret;\r\n}\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-get_voltage expand (bank, reg, mask, value): 0x%x, 0x%x, 0x%x, 0x%x\n",\r\ninfo->desc.name, info->expand_register.voltage_bank,\r\ninfo->expand_register.voltage_reg,\r\ninfo->expand_register.voltage_mask, regval_expand);\r\nif (regval_expand & info->expand_register.voltage_mask)\r\nreturn info->expand_register.voltage_limit;\r\nret = abx500_get_register_interruptible(info->dev,\r\ninfo->voltage_bank, info->voltage_reg, &regval);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't read voltage reg for regulator\n");\r\nreturn ret;\r\n}\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-get_voltage (bank, reg, mask, value): 0x%x, 0x%x, 0x%x, 0x%x\n",\r\ninfo->desc.name, info->voltage_bank, info->voltage_reg,\r\ninfo->voltage_mask, regval);\r\nvoltage_shift = ffs(info->voltage_mask) - 1;\r\nreturn (regval & info->voltage_mask) >> voltage_shift;\r\n}\r\nstatic int ab8500_regulator_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nint ret, voltage_shift;\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nu8 regval;\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nvoltage_shift = ffs(info->voltage_mask) - 1;\r\nregval = (u8)selector << voltage_shift;\r\nret = abx500_mask_and_set_register_interruptible(info->dev,\r\ninfo->voltage_bank, info->voltage_reg,\r\ninfo->voltage_mask, regval);\r\nif (ret < 0)\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't set voltage reg for regulator\n");\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-set_voltage (bank, reg, mask, value): 0x%x, 0x%x, 0x%x,"\r\n" 0x%x\n",\r\ninfo->desc.name, info->voltage_bank, info->voltage_reg,\r\ninfo->voltage_mask, regval);\r\nreturn ret;\r\n}\r\nstatic int ab8540_aux3_regulator_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nint ret;\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nu8 regval, regval_expand;\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nif (selector < info->expand_register.voltage_limit) {\r\nint voltage_shift = ffs(info->voltage_mask) - 1;\r\nregval = (u8)selector << voltage_shift;\r\nret = abx500_mask_and_set_register_interruptible(info->dev,\r\ninfo->voltage_bank, info->voltage_reg,\r\ninfo->voltage_mask, regval);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't set voltage reg for regulator\n");\r\nreturn ret;\r\n}\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-set_voltage (bank, reg, mask, value): 0x%x, 0x%x, 0x%x, 0x%x\n",\r\ninfo->desc.name, info->voltage_bank, info->voltage_reg,\r\ninfo->voltage_mask, regval);\r\nregval_expand = 0;\r\n} else {\r\nregval_expand = info->expand_register.voltage_mask;\r\n}\r\nret = abx500_mask_and_set_register_interruptible(info->dev,\r\ninfo->expand_register.voltage_bank,\r\ninfo->expand_register.voltage_reg,\r\ninfo->expand_register.voltage_mask,\r\nregval_expand);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't set expand voltage reg for regulator\n");\r\nreturn ret;\r\n}\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-set_voltage expand (bank, reg, mask, value): 0x%x, 0x%x, 0x%x, 0x%x\n",\r\ninfo->desc.name, info->expand_register.voltage_bank,\r\ninfo->expand_register.voltage_reg,\r\ninfo->expand_register.voltage_mask, regval_expand);\r\nreturn 0;\r\n}\r\nstatic void abx500_get_regulator_info(struct ab8500 *ab8500)\r\n{\r\nif (is_ab9540(ab8500)) {\r\nabx500_regulator.info = ab9540_regulator_info;\r\nabx500_regulator.info_size = ARRAY_SIZE(ab9540_regulator_info);\r\nabx500_regulator.init = ab9540_reg_init;\r\nabx500_regulator.init_size = AB9540_NUM_REGULATOR_REGISTERS;\r\nabx500_regulator.match = ab9540_regulator_match;\r\nabx500_regulator.match_size = ARRAY_SIZE(ab9540_regulator_match);\r\n} else if (is_ab8505(ab8500)) {\r\nabx500_regulator.info = ab8505_regulator_info;\r\nabx500_regulator.info_size = ARRAY_SIZE(ab8505_regulator_info);\r\nabx500_regulator.init = ab8505_reg_init;\r\nabx500_regulator.init_size = AB8505_NUM_REGULATOR_REGISTERS;\r\nabx500_regulator.match = ab8505_regulator_match;\r\nabx500_regulator.match_size = ARRAY_SIZE(ab8505_regulator_match);\r\n} else if (is_ab8540(ab8500)) {\r\nabx500_regulator.info = ab8540_regulator_info;\r\nabx500_regulator.info_size = ARRAY_SIZE(ab8540_regulator_info);\r\nabx500_regulator.init = ab8540_reg_init;\r\nabx500_regulator.init_size = AB8540_NUM_REGULATOR_REGISTERS;\r\nabx500_regulator.match = ab8540_regulator_match;\r\nabx500_regulator.match_size = ARRAY_SIZE(ab8540_regulator_match);\r\n} else {\r\nabx500_regulator.info = ab8500_regulator_info;\r\nabx500_regulator.info_size = ARRAY_SIZE(ab8500_regulator_info);\r\nabx500_regulator.init = ab8500_reg_init;\r\nabx500_regulator.init_size = AB8500_NUM_REGULATOR_REGISTERS;\r\nabx500_regulator.match = ab8500_regulator_match;\r\nabx500_regulator.match_size = ARRAY_SIZE(ab8500_regulator_match);\r\n}\r\n}\r\nstatic int ab8500_regulator_register(struct platform_device *pdev,\r\nstruct regulator_init_data *init_data,\r\nint id, struct device_node *np)\r\n{\r\nstruct ab8500 *ab8500 = dev_get_drvdata(pdev->dev.parent);\r\nstruct ab8500_regulator_info *info = NULL;\r\nstruct regulator_config config = { };\r\ninfo = &abx500_regulator.info[id];\r\ninfo->dev = &pdev->dev;\r\nconfig.dev = &pdev->dev;\r\nconfig.init_data = init_data;\r\nconfig.driver_data = info;\r\nconfig.of_node = np;\r\nif (is_ab8500_1p1_or_earlier(ab8500)) {\r\nif (info->desc.id == AB8500_LDO_AUX3) {\r\ninfo->desc.n_voltages =\r\nARRAY_SIZE(ldo_vauxn_voltages);\r\ninfo->desc.volt_table = ldo_vauxn_voltages;\r\ninfo->voltage_mask = 0xf;\r\n}\r\n}\r\ninfo->regulator = devm_regulator_register(&pdev->dev, &info->desc,\r\n&config);\r\nif (IS_ERR(info->regulator)) {\r\ndev_err(&pdev->dev, "failed to register regulator %s\n",\r\ninfo->desc.name);\r\nreturn PTR_ERR(info->regulator);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab8500_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct ab8500 *ab8500 = dev_get_drvdata(pdev->dev.parent);\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct of_regulator_match *match;\r\nint err, i;\r\nif (!ab8500) {\r\ndev_err(&pdev->dev, "null mfd parent\n");\r\nreturn -EINVAL;\r\n}\r\nabx500_get_regulator_info(ab8500);\r\nerr = of_regulator_match(&pdev->dev, np,\r\nabx500_regulator.match,\r\nabx500_regulator.match_size);\r\nif (err < 0) {\r\ndev_err(&pdev->dev,\r\n"Error parsing regulator init data: %d\n", err);\r\nreturn err;\r\n}\r\nmatch = abx500_regulator.match;\r\nfor (i = 0; i < abx500_regulator.info_size; i++) {\r\nerr = ab8500_regulator_register(pdev, match[i].init_data, i,\r\nmatch[i].of_node);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init ab8500_regulator_init(void)\r\n{\r\nint ret;\r\nret = platform_driver_register(&ab8500_regulator_driver);\r\nif (ret != 0)\r\npr_err("Failed to register ab8500 regulator: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void __exit ab8500_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&ab8500_regulator_driver);\r\n}

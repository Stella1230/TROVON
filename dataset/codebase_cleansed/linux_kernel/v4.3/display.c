void omapdss_default_get_resolution(struct omap_dss_device *dssdev,\r\nu16 *xres, u16 *yres)\r\n{\r\n*xres = dssdev->panel.timings.x_res;\r\n*yres = dssdev->panel.timings.y_res;\r\n}\r\nint omapdss_default_get_recommended_bpp(struct omap_dss_device *dssdev)\r\n{\r\nswitch (dssdev->type) {\r\ncase OMAP_DISPLAY_TYPE_DPI:\r\nif (dssdev->phy.dpi.data_lines == 24)\r\nreturn 24;\r\nelse\r\nreturn 16;\r\ncase OMAP_DISPLAY_TYPE_DBI:\r\nif (dssdev->ctrl.pixel_size == 24)\r\nreturn 24;\r\nelse\r\nreturn 16;\r\ncase OMAP_DISPLAY_TYPE_DSI:\r\nif (dsi_get_pixel_size(dssdev->panel.dsi_pix_fmt) > 16)\r\nreturn 24;\r\nelse\r\nreturn 16;\r\ncase OMAP_DISPLAY_TYPE_VENC:\r\ncase OMAP_DISPLAY_TYPE_SDI:\r\ncase OMAP_DISPLAY_TYPE_HDMI:\r\ncase OMAP_DISPLAY_TYPE_DVI:\r\nreturn 24;\r\ndefault:\r\nBUG();\r\nreturn 0;\r\n}\r\n}\r\nvoid omapdss_default_get_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\n*timings = dssdev->panel.timings;\r\n}\r\nint dss_suspend_all_devices(void)\r\n{\r\nstruct omap_dss_device *dssdev = NULL;\r\nfor_each_dss_dev(dssdev) {\r\nif (!dssdev->driver)\r\ncontinue;\r\nif (dssdev->state == OMAP_DSS_DISPLAY_ACTIVE) {\r\ndssdev->driver->disable(dssdev);\r\ndssdev->activate_after_resume = true;\r\n} else {\r\ndssdev->activate_after_resume = false;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint dss_resume_all_devices(void)\r\n{\r\nstruct omap_dss_device *dssdev = NULL;\r\nfor_each_dss_dev(dssdev) {\r\nif (!dssdev->driver)\r\ncontinue;\r\nif (dssdev->activate_after_resume) {\r\ndssdev->driver->enable(dssdev);\r\ndssdev->activate_after_resume = false;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid dss_disable_all_devices(void)\r\n{\r\nstruct omap_dss_device *dssdev = NULL;\r\nfor_each_dss_dev(dssdev) {\r\nif (!dssdev->driver)\r\ncontinue;\r\nif (dssdev->state == OMAP_DSS_DISPLAY_ACTIVE)\r\ndssdev->driver->disable(dssdev);\r\n}\r\n}\r\nint omapdss_register_display(struct omap_dss_device *dssdev)\r\n{\r\nstruct omap_dss_driver *drv = dssdev->driver;\r\nint id;\r\nif (dssdev->dev->of_node) {\r\nid = of_alias_get_id(dssdev->dev->of_node, "display");\r\nif (id < 0)\r\nid = disp_num_counter++;\r\n} else {\r\nid = disp_num_counter++;\r\n}\r\nsnprintf(dssdev->alias, sizeof(dssdev->alias), "display%d", id);\r\nif (dssdev->dev->of_node)\r\nof_property_read_string(dssdev->dev->of_node, "label",\r\n&dssdev->name);\r\nif (dssdev->name == NULL)\r\ndssdev->name = dssdev->alias;\r\nif (drv && drv->get_resolution == NULL)\r\ndrv->get_resolution = omapdss_default_get_resolution;\r\nif (drv && drv->get_recommended_bpp == NULL)\r\ndrv->get_recommended_bpp = omapdss_default_get_recommended_bpp;\r\nif (drv && drv->get_timings == NULL)\r\ndrv->get_timings = omapdss_default_get_timings;\r\nmutex_lock(&panel_list_mutex);\r\nlist_add_tail(&dssdev->panel_list, &panel_list);\r\nmutex_unlock(&panel_list_mutex);\r\nreturn 0;\r\n}\r\nvoid omapdss_unregister_display(struct omap_dss_device *dssdev)\r\n{\r\nmutex_lock(&panel_list_mutex);\r\nlist_del(&dssdev->panel_list);\r\nmutex_unlock(&panel_list_mutex);\r\n}\r\nstruct omap_dss_device *omap_dss_get_device(struct omap_dss_device *dssdev)\r\n{\r\nif (!try_module_get(dssdev->owner))\r\nreturn NULL;\r\nif (get_device(dssdev->dev) == NULL) {\r\nmodule_put(dssdev->owner);\r\nreturn NULL;\r\n}\r\nreturn dssdev;\r\n}\r\nvoid omap_dss_put_device(struct omap_dss_device *dssdev)\r\n{\r\nput_device(dssdev->dev);\r\nmodule_put(dssdev->owner);\r\n}\r\nstruct omap_dss_device *omap_dss_get_next_device(struct omap_dss_device *from)\r\n{\r\nstruct list_head *l;\r\nstruct omap_dss_device *dssdev;\r\nmutex_lock(&panel_list_mutex);\r\nif (list_empty(&panel_list)) {\r\ndssdev = NULL;\r\ngoto out;\r\n}\r\nif (from == NULL) {\r\ndssdev = list_first_entry(&panel_list, struct omap_dss_device,\r\npanel_list);\r\nomap_dss_get_device(dssdev);\r\ngoto out;\r\n}\r\nomap_dss_put_device(from);\r\nlist_for_each(l, &panel_list) {\r\ndssdev = list_entry(l, struct omap_dss_device, panel_list);\r\nif (dssdev == from) {\r\nif (list_is_last(l, &panel_list)) {\r\ndssdev = NULL;\r\ngoto out;\r\n}\r\ndssdev = list_entry(l->next, struct omap_dss_device,\r\npanel_list);\r\nomap_dss_get_device(dssdev);\r\ngoto out;\r\n}\r\n}\r\nWARN(1, "'from' dssdev not found\n");\r\ndssdev = NULL;\r\nout:\r\nmutex_unlock(&panel_list_mutex);\r\nreturn dssdev;\r\n}\r\nstruct omap_dss_device *omap_dss_find_device(void *data,\r\nint (*match)(struct omap_dss_device *dssdev, void *data))\r\n{\r\nstruct omap_dss_device *dssdev = NULL;\r\nwhile ((dssdev = omap_dss_get_next_device(dssdev)) != NULL) {\r\nif (match(dssdev, data))\r\nreturn dssdev;\r\n}\r\nreturn NULL;\r\n}\r\nvoid videomode_to_omap_video_timings(const struct videomode *vm,\r\nstruct omap_video_timings *ovt)\r\n{\r\nmemset(ovt, 0, sizeof(*ovt));\r\novt->pixelclock = vm->pixelclock;\r\novt->x_res = vm->hactive;\r\novt->hbp = vm->hback_porch;\r\novt->hfp = vm->hfront_porch;\r\novt->hsw = vm->hsync_len;\r\novt->y_res = vm->vactive;\r\novt->vbp = vm->vback_porch;\r\novt->vfp = vm->vfront_porch;\r\novt->vsw = vm->vsync_len;\r\novt->vsync_level = vm->flags & DISPLAY_FLAGS_VSYNC_HIGH ?\r\nOMAPDSS_SIG_ACTIVE_HIGH :\r\nOMAPDSS_SIG_ACTIVE_LOW;\r\novt->hsync_level = vm->flags & DISPLAY_FLAGS_HSYNC_HIGH ?\r\nOMAPDSS_SIG_ACTIVE_HIGH :\r\nOMAPDSS_SIG_ACTIVE_LOW;\r\novt->de_level = vm->flags & DISPLAY_FLAGS_DE_HIGH ?\r\nOMAPDSS_SIG_ACTIVE_HIGH :\r\nOMAPDSS_SIG_ACTIVE_LOW;\r\novt->data_pclk_edge = vm->flags & DISPLAY_FLAGS_PIXDATA_POSEDGE ?\r\nOMAPDSS_DRIVE_SIG_RISING_EDGE :\r\nOMAPDSS_DRIVE_SIG_FALLING_EDGE;\r\novt->sync_pclk_edge = ovt->data_pclk_edge;\r\n}\r\nvoid omap_video_timings_to_videomode(const struct omap_video_timings *ovt,\r\nstruct videomode *vm)\r\n{\r\nmemset(vm, 0, sizeof(*vm));\r\nvm->pixelclock = ovt->pixelclock;\r\nvm->hactive = ovt->x_res;\r\nvm->hback_porch = ovt->hbp;\r\nvm->hfront_porch = ovt->hfp;\r\nvm->hsync_len = ovt->hsw;\r\nvm->vactive = ovt->y_res;\r\nvm->vback_porch = ovt->vbp;\r\nvm->vfront_porch = ovt->vfp;\r\nvm->vsync_len = ovt->vsw;\r\nif (ovt->hsync_level == OMAPDSS_SIG_ACTIVE_HIGH)\r\nvm->flags |= DISPLAY_FLAGS_HSYNC_HIGH;\r\nelse\r\nvm->flags |= DISPLAY_FLAGS_HSYNC_LOW;\r\nif (ovt->vsync_level == OMAPDSS_SIG_ACTIVE_HIGH)\r\nvm->flags |= DISPLAY_FLAGS_VSYNC_HIGH;\r\nelse\r\nvm->flags |= DISPLAY_FLAGS_VSYNC_LOW;\r\nif (ovt->de_level == OMAPDSS_SIG_ACTIVE_HIGH)\r\nvm->flags |= DISPLAY_FLAGS_DE_HIGH;\r\nelse\r\nvm->flags |= DISPLAY_FLAGS_DE_LOW;\r\nif (ovt->data_pclk_edge == OMAPDSS_DRIVE_SIG_RISING_EDGE)\r\nvm->flags |= DISPLAY_FLAGS_PIXDATA_POSEDGE;\r\nelse\r\nvm->flags |= DISPLAY_FLAGS_PIXDATA_NEGEDGE;\r\n}

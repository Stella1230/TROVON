static inline u32 bcm53xxspi_read(struct bcm53xxspi *b53spi, u16 offset)\r\n{\r\nreturn bcma_read32(b53spi->core, offset);\r\n}\r\nstatic inline void bcm53xxspi_write(struct bcm53xxspi *b53spi, u16 offset,\r\nu32 value)\r\n{\r\nbcma_write32(b53spi->core, offset, value);\r\n}\r\nstatic inline unsigned int bcm53xxspi_calc_timeout(size_t len)\r\n{\r\nreturn (len * 9000 / BCM53XXSPI_MAX_SPI_BAUD * 110 / 100) + 1;\r\n}\r\nstatic int bcm53xxspi_wait(struct bcm53xxspi *b53spi, unsigned int timeout_ms)\r\n{\r\nunsigned long deadline;\r\nu32 tmp;\r\ndeadline = jiffies + msecs_to_jiffies(BCM53XXSPI_SPE_TIMEOUT_MS);\r\ndo {\r\ntmp = bcm53xxspi_read(b53spi, B53SPI_MSPI_SPCR2);\r\nif (!(tmp & B53SPI_MSPI_SPCR2_SPE))\r\nbreak;\r\nudelay(5);\r\n} while (!time_after_eq(jiffies, deadline));\r\nif (tmp & B53SPI_MSPI_SPCR2_SPE)\r\ngoto spi_timeout;\r\ndeadline = jiffies + msecs_to_jiffies(timeout_ms);\r\ndo {\r\ntmp = bcm53xxspi_read(b53spi, B53SPI_MSPI_MSPI_STATUS);\r\nif (tmp & B53SPI_MSPI_MSPI_STATUS_SPIF) {\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_MSPI_STATUS, 0);\r\nreturn 0;\r\n}\r\ncpu_relax();\r\nudelay(100);\r\n} while (!time_after_eq(jiffies, deadline));\r\nspi_timeout:\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_MSPI_STATUS, 0);\r\npr_err("Timeout waiting for SPI to be ready!\n");\r\nreturn -EBUSY;\r\n}\r\nstatic void bcm53xxspi_buf_write(struct bcm53xxspi *b53spi, u8 *w_buf,\r\nsize_t len, bool cont)\r\n{\r\nu32 tmp;\r\nint i;\r\nfor (i = 0; i < len; i++) {\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_TXRAM + 4 * (i * 2),\r\n(unsigned int)w_buf[i]);\r\n}\r\nfor (i = 0; i < len; i++) {\r\ntmp = B53SPI_CDRAM_CONT | B53SPI_CDRAM_PCS_DISABLE_ALL |\r\nB53SPI_CDRAM_PCS_DSCK;\r\nif (!cont && i == len - 1)\r\ntmp &= ~B53SPI_CDRAM_CONT;\r\ntmp &= ~0x1;\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_CDRAM + 4 * i, tmp);\r\n}\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_NEWQP, 0);\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_ENDQP, len - 1);\r\nif (cont)\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_WRITE_LOCK, 1);\r\ntmp = bcm53xxspi_read(b53spi, B53SPI_MSPI_SPCR2);\r\ntmp |= B53SPI_MSPI_SPCR2_SPE;\r\nif (cont)\r\ntmp |= B53SPI_MSPI_SPCR2_CONT_AFTER_CMD;\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_SPCR2, tmp);\r\nbcm53xxspi_wait(b53spi, bcm53xxspi_calc_timeout(len));\r\nif (!cont)\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_WRITE_LOCK, 0);\r\nb53spi->read_offset = len;\r\n}\r\nstatic void bcm53xxspi_buf_read(struct bcm53xxspi *b53spi, u8 *r_buf,\r\nsize_t len, bool cont)\r\n{\r\nu32 tmp;\r\nint i;\r\nfor (i = 0; i < b53spi->read_offset + len; i++) {\r\ntmp = B53SPI_CDRAM_CONT | B53SPI_CDRAM_PCS_DISABLE_ALL |\r\nB53SPI_CDRAM_PCS_DSCK;\r\nif (!cont && i == b53spi->read_offset + len - 1)\r\ntmp &= ~B53SPI_CDRAM_CONT;\r\ntmp &= ~0x1;\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_CDRAM + 4 * i, tmp);\r\n}\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_NEWQP, 0);\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_ENDQP,\r\nb53spi->read_offset + len - 1);\r\nif (cont)\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_WRITE_LOCK, 1);\r\ntmp = bcm53xxspi_read(b53spi, B53SPI_MSPI_SPCR2);\r\ntmp |= B53SPI_MSPI_SPCR2_SPE;\r\nif (cont)\r\ntmp |= B53SPI_MSPI_SPCR2_CONT_AFTER_CMD;\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_SPCR2, tmp);\r\nbcm53xxspi_wait(b53spi, bcm53xxspi_calc_timeout(len));\r\nif (!cont)\r\nbcm53xxspi_write(b53spi, B53SPI_MSPI_WRITE_LOCK, 0);\r\nfor (i = 0; i < len; ++i) {\r\nint offset = b53spi->read_offset + i;\r\nr_buf[i] = (u8)bcm53xxspi_read(b53spi, B53SPI_MSPI_RXRAM + 4 * (1 + offset * 2));\r\n}\r\nb53spi->read_offset = 0;\r\n}\r\nstatic int bcm53xxspi_transfer_one(struct spi_master *master,\r\nstruct spi_device *spi,\r\nstruct spi_transfer *t)\r\n{\r\nstruct bcm53xxspi *b53spi = spi_master_get_devdata(master);\r\nu8 *buf;\r\nsize_t left;\r\nif (t->tx_buf) {\r\nbuf = (u8 *)t->tx_buf;\r\nleft = t->len;\r\nwhile (left) {\r\nsize_t to_write = min_t(size_t, 16, left);\r\nbool cont = left - to_write > 0;\r\nbcm53xxspi_buf_write(b53spi, buf, to_write, cont);\r\nleft -= to_write;\r\nbuf += to_write;\r\n}\r\n}\r\nif (t->rx_buf) {\r\nbuf = (u8 *)t->rx_buf;\r\nleft = t->len;\r\nwhile (left) {\r\nsize_t to_read = min_t(size_t, 16 - b53spi->read_offset,\r\nleft);\r\nbool cont = left - to_read > 0;\r\nbcm53xxspi_buf_read(b53spi, buf, to_read, cont);\r\nleft -= to_read;\r\nbuf += to_read;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int bcm53xxspi_bcma_probe(struct bcma_device *core)\r\n{\r\nstruct bcm53xxspi *b53spi;\r\nstruct spi_master *master;\r\nint err;\r\nif (core->bus->drv_cc.core->id.rev != 42) {\r\npr_err("SPI on SoC with unsupported ChipCommon rev\n");\r\nreturn -ENOTSUPP;\r\n}\r\nmaster = spi_alloc_master(&core->dev, sizeof(*b53spi));\r\nif (!master)\r\nreturn -ENOMEM;\r\nb53spi = spi_master_get_devdata(master);\r\nb53spi->master = master;\r\nb53spi->core = core;\r\nmaster->transfer_one = bcm53xxspi_transfer_one;\r\nbcma_set_drvdata(core, b53spi);\r\nerr = devm_spi_register_master(&core->dev, master);\r\nif (err) {\r\nspi_master_put(master);\r\nbcma_set_drvdata(core, NULL);\r\ngoto out;\r\n}\r\nspi_new_device(master, &bcm53xx_info);\r\nout:\r\nreturn err;\r\n}\r\nstatic void bcm53xxspi_bcma_remove(struct bcma_device *core)\r\n{\r\nstruct bcm53xxspi *b53spi = bcma_get_drvdata(core);\r\nspi_unregister_master(b53spi->master);\r\n}\r\nstatic int __init bcm53xxspi_module_init(void)\r\n{\r\nint err = 0;\r\nerr = bcma_driver_register(&bcm53xxspi_bcma_driver);\r\nif (err)\r\npr_err("Failed to register bcma driver: %d\n", err);\r\nreturn err;\r\n}\r\nstatic void __exit bcm53xxspi_module_exit(void)\r\n{\r\nbcma_driver_unregister(&bcm53xxspi_bcma_driver);\r\n}

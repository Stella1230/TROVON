static int compat_radeon_cp_init(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_radeon_init32_t init32;\r\ndrm_radeon_init_t __user *init;\r\nif (copy_from_user(&init32, (void __user *)arg, sizeof(init32)))\r\nreturn -EFAULT;\r\ninit = compat_alloc_user_space(sizeof(*init));\r\nif (!access_ok(VERIFY_WRITE, init, sizeof(*init))\r\n|| __put_user(init32.func, &init->func)\r\n|| __put_user(init32.sarea_priv_offset, &init->sarea_priv_offset)\r\n|| __put_user(init32.is_pci, &init->is_pci)\r\n|| __put_user(init32.cp_mode, &init->cp_mode)\r\n|| __put_user(init32.gart_size, &init->gart_size)\r\n|| __put_user(init32.ring_size, &init->ring_size)\r\n|| __put_user(init32.usec_timeout, &init->usec_timeout)\r\n|| __put_user(init32.fb_bpp, &init->fb_bpp)\r\n|| __put_user(init32.front_offset, &init->front_offset)\r\n|| __put_user(init32.front_pitch, &init->front_pitch)\r\n|| __put_user(init32.back_offset, &init->back_offset)\r\n|| __put_user(init32.back_pitch, &init->back_pitch)\r\n|| __put_user(init32.depth_bpp, &init->depth_bpp)\r\n|| __put_user(init32.depth_offset, &init->depth_offset)\r\n|| __put_user(init32.depth_pitch, &init->depth_pitch)\r\n|| __put_user(init32.fb_offset, &init->fb_offset)\r\n|| __put_user(init32.mmio_offset, &init->mmio_offset)\r\n|| __put_user(init32.ring_offset, &init->ring_offset)\r\n|| __put_user(init32.ring_rptr_offset, &init->ring_rptr_offset)\r\n|| __put_user(init32.buffers_offset, &init->buffers_offset)\r\n|| __put_user(init32.gart_textures_offset,\r\n&init->gart_textures_offset))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_RADEON_CP_INIT, (unsigned long)init);\r\n}\r\nstatic int compat_radeon_cp_clear(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_radeon_clear32_t clr32;\r\ndrm_radeon_clear_t __user *clr;\r\nif (copy_from_user(&clr32, (void __user *)arg, sizeof(clr32)))\r\nreturn -EFAULT;\r\nclr = compat_alloc_user_space(sizeof(*clr));\r\nif (!access_ok(VERIFY_WRITE, clr, sizeof(*clr))\r\n|| __put_user(clr32.flags, &clr->flags)\r\n|| __put_user(clr32.clear_color, &clr->clear_color)\r\n|| __put_user(clr32.clear_depth, &clr->clear_depth)\r\n|| __put_user(clr32.color_mask, &clr->color_mask)\r\n|| __put_user(clr32.depth_mask, &clr->depth_mask)\r\n|| __put_user((void __user *)(unsigned long)clr32.depth_boxes,\r\n&clr->depth_boxes))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_RADEON_CLEAR, (unsigned long)clr);\r\n}\r\nstatic int compat_radeon_cp_stipple(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_radeon_stipple32_t __user *argp = (void __user *)arg;\r\ndrm_radeon_stipple_t __user *request;\r\nu32 mask;\r\nif (get_user(mask, &argp->mask))\r\nreturn -EFAULT;\r\nrequest = compat_alloc_user_space(sizeof(*request));\r\nif (!access_ok(VERIFY_WRITE, request, sizeof(*request))\r\n|| __put_user((unsigned int __user *)(unsigned long)mask,\r\n&request->mask))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_RADEON_STIPPLE, (unsigned long)request);\r\n}\r\nstatic int compat_radeon_cp_texture(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_radeon_texture32_t req32;\r\ndrm_radeon_texture_t __user *request;\r\ndrm_radeon_tex_image32_t img32;\r\ndrm_radeon_tex_image_t __user *image;\r\nif (copy_from_user(&req32, (void __user *)arg, sizeof(req32)))\r\nreturn -EFAULT;\r\nif (req32.image == 0)\r\nreturn -EINVAL;\r\nif (copy_from_user(&img32, (void __user *)(unsigned long)req32.image,\r\nsizeof(img32)))\r\nreturn -EFAULT;\r\nrequest = compat_alloc_user_space(sizeof(*request) + sizeof(*image));\r\nif (!access_ok(VERIFY_WRITE, request,\r\nsizeof(*request) + sizeof(*image)))\r\nreturn -EFAULT;\r\nimage = (drm_radeon_tex_image_t __user *) (request + 1);\r\nif (__put_user(req32.offset, &request->offset)\r\n|| __put_user(req32.pitch, &request->pitch)\r\n|| __put_user(req32.format, &request->format)\r\n|| __put_user(req32.width, &request->width)\r\n|| __put_user(req32.height, &request->height)\r\n|| __put_user(image, &request->image)\r\n|| __put_user(img32.x, &image->x)\r\n|| __put_user(img32.y, &image->y)\r\n|| __put_user(img32.width, &image->width)\r\n|| __put_user(img32.height, &image->height)\r\n|| __put_user((const void __user *)(unsigned long)img32.data,\r\n&image->data))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_RADEON_TEXTURE, (unsigned long)request);\r\n}\r\nstatic int compat_radeon_cp_vertex2(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_radeon_vertex2_32_t req32;\r\ndrm_radeon_vertex2_t __user *request;\r\nif (copy_from_user(&req32, (void __user *)arg, sizeof(req32)))\r\nreturn -EFAULT;\r\nrequest = compat_alloc_user_space(sizeof(*request));\r\nif (!access_ok(VERIFY_WRITE, request, sizeof(*request))\r\n|| __put_user(req32.idx, &request->idx)\r\n|| __put_user(req32.discard, &request->discard)\r\n|| __put_user(req32.nr_states, &request->nr_states)\r\n|| __put_user((void __user *)(unsigned long)req32.state,\r\n&request->state)\r\n|| __put_user(req32.nr_prims, &request->nr_prims)\r\n|| __put_user((void __user *)(unsigned long)req32.prim,\r\n&request->prim))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_RADEON_VERTEX2, (unsigned long)request);\r\n}\r\nstatic int compat_radeon_cp_cmdbuf(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_radeon_cmd_buffer32_t req32;\r\ndrm_radeon_cmd_buffer_t __user *request;\r\nif (copy_from_user(&req32, (void __user *)arg, sizeof(req32)))\r\nreturn -EFAULT;\r\nrequest = compat_alloc_user_space(sizeof(*request));\r\nif (!access_ok(VERIFY_WRITE, request, sizeof(*request))\r\n|| __put_user(req32.bufsz, &request->bufsz)\r\n|| __put_user((void __user *)(unsigned long)req32.buf,\r\n&request->buf)\r\n|| __put_user(req32.nbox, &request->nbox)\r\n|| __put_user((void __user *)(unsigned long)req32.boxes,\r\n&request->boxes))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_RADEON_CMDBUF, (unsigned long)request);\r\n}\r\nstatic int compat_radeon_cp_getparam(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_radeon_getparam32_t req32;\r\ndrm_radeon_getparam_t __user *request;\r\nif (copy_from_user(&req32, (void __user *)arg, sizeof(req32)))\r\nreturn -EFAULT;\r\nrequest = compat_alloc_user_space(sizeof(*request));\r\nif (!access_ok(VERIFY_WRITE, request, sizeof(*request))\r\n|| __put_user(req32.param, &request->param)\r\n|| __put_user((void __user *)(unsigned long)req32.value,\r\n&request->value))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_RADEON_GETPARAM, (unsigned long)request);\r\n}\r\nstatic int compat_radeon_mem_alloc(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_radeon_mem_alloc32_t req32;\r\ndrm_radeon_mem_alloc_t __user *request;\r\nif (copy_from_user(&req32, (void __user *)arg, sizeof(req32)))\r\nreturn -EFAULT;\r\nrequest = compat_alloc_user_space(sizeof(*request));\r\nif (!access_ok(VERIFY_WRITE, request, sizeof(*request))\r\n|| __put_user(req32.region, &request->region)\r\n|| __put_user(req32.alignment, &request->alignment)\r\n|| __put_user(req32.size, &request->size)\r\n|| __put_user((int __user *)(unsigned long)req32.region_offset,\r\n&request->region_offset))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_RADEON_ALLOC, (unsigned long)request);\r\n}\r\nstatic int compat_radeon_irq_emit(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_radeon_irq_emit32_t req32;\r\ndrm_radeon_irq_emit_t __user *request;\r\nif (copy_from_user(&req32, (void __user *)arg, sizeof(req32)))\r\nreturn -EFAULT;\r\nrequest = compat_alloc_user_space(sizeof(*request));\r\nif (!access_ok(VERIFY_WRITE, request, sizeof(*request))\r\n|| __put_user((int __user *)(unsigned long)req32.irq_seq,\r\n&request->irq_seq))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_RADEON_IRQ_EMIT, (unsigned long)request);\r\n}\r\nstatic int compat_radeon_cp_setparam(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_radeon_setparam32_t req32;\r\ndrm_radeon_setparam_t __user *request;\r\nif (copy_from_user(&req32, (void __user *) arg, sizeof(req32)))\r\nreturn -EFAULT;\r\nrequest = compat_alloc_user_space(sizeof(*request));\r\nif (!access_ok(VERIFY_WRITE, request, sizeof(*request))\r\n|| __put_user(req32.param, &request->param)\r\n|| __put_user((void __user *)(unsigned long)req32.value,\r\n&request->value))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_RADEON_SETPARAM, (unsigned long) request);\r\n}\r\nlong radeon_compat_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\r\n{\r\nunsigned int nr = DRM_IOCTL_NR(cmd);\r\ndrm_ioctl_compat_t *fn = NULL;\r\nint ret;\r\nif (nr < DRM_COMMAND_BASE)\r\nreturn drm_compat_ioctl(filp, cmd, arg);\r\nif (nr < DRM_COMMAND_BASE + ARRAY_SIZE(radeon_compat_ioctls))\r\nfn = radeon_compat_ioctls[nr - DRM_COMMAND_BASE];\r\nif (fn != NULL)\r\nret = (*fn) (filp, cmd, arg);\r\nelse\r\nret = drm_ioctl(filp, cmd, arg);\r\nreturn ret;\r\n}\r\nlong radeon_kms_compat_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\r\n{\r\nunsigned int nr = DRM_IOCTL_NR(cmd);\r\nint ret;\r\nif (nr < DRM_COMMAND_BASE)\r\nreturn drm_compat_ioctl(filp, cmd, arg);\r\nret = radeon_drm_ioctl(filp, cmd, arg);\r\nreturn ret;\r\n}

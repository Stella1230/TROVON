static void reset_lcd_module(void)\r\n{\r\ngpio_set_value(GPIO_PTH2, 0);\r\nmdelay(2);\r\ngpio_set_value(GPIO_PTH2, 1);\r\nmdelay(1);\r\n}\r\nstatic unsigned long adjust_reg18(unsigned short data)\r\n{\r\nunsigned long tmp1, tmp2;\r\ntmp1 = (data<<1 | 0x00000001) & 0x000001FF;\r\ntmp2 = (data<<2 | 0x00000200) & 0x0003FE00;\r\nreturn tmp1 | tmp2;\r\n}\r\nstatic void write_reg(void *sys_ops_handle,\r\nstruct sh_mobile_lcdc_sys_bus_ops *sys_ops,\r\nunsigned short reg, unsigned short data)\r\n{\r\nsys_ops->write_index(sys_ops_handle, adjust_reg18(reg << 8 | data));\r\n}\r\nstatic void write_reg16(void *sys_ops_handle,\r\nstruct sh_mobile_lcdc_sys_bus_ops *sys_ops,\r\nunsigned short reg, unsigned short data)\r\n{\r\nsys_ops->write_index(sys_ops_handle, adjust_reg18(reg));\r\nsys_ops->write_data(sys_ops_handle, adjust_reg18(data));\r\n}\r\nstatic unsigned long read_reg16(void *sys_ops_handle,\r\nstruct sh_mobile_lcdc_sys_bus_ops *sys_ops,\r\nunsigned short reg)\r\n{\r\nunsigned long data;\r\nsys_ops->write_index(sys_ops_handle, adjust_reg18(reg));\r\ndata = sys_ops->read_data(sys_ops_handle);\r\nreturn ((data >> 1) & 0xff) | ((data >> 2) & 0xff00);\r\n}\r\nstatic void migor_lcd_qvga_seq(void *sys_ops_handle,\r\nstruct sh_mobile_lcdc_sys_bus_ops *sys_ops,\r\nunsigned short const *data, int no_data)\r\n{\r\nint i;\r\nfor (i = 0; i < no_data; i += 2)\r\nwrite_reg16(sys_ops_handle, sys_ops, data[i], data[i + 1]);\r\n}\r\nint migor_lcd_qvga_setup(void *sohandle, struct sh_mobile_lcdc_sys_bus_ops *so)\r\n{\r\nunsigned long xres = 320;\r\nunsigned long yres = 240;\r\nint k;\r\nreset_lcd_module();\r\nmigor_lcd_qvga_seq(sohandle, so, sync_data, ARRAY_SIZE(sync_data));\r\nif (read_reg16(sohandle, so, 0) != 0x1505)\r\nreturn -ENODEV;\r\npr_info("Migo-R QVGA LCD Module detected.\n");\r\nmigor_lcd_qvga_seq(sohandle, so, sync_data, ARRAY_SIZE(sync_data));\r\nwrite_reg16(sohandle, so, 0x00A4, 0x0001);\r\nmdelay(10);\r\nmigor_lcd_qvga_seq(sohandle, so, magic0_data, ARRAY_SIZE(magic0_data));\r\nmdelay(100);\r\nmigor_lcd_qvga_seq(sohandle, so, magic1_data, ARRAY_SIZE(magic1_data));\r\nwrite_reg16(sohandle, so, 0x0050, 0xef - (yres - 1));\r\nwrite_reg16(sohandle, so, 0x0051, 0x00ef);\r\nwrite_reg16(sohandle, so, 0x0052, 0x0000);\r\nwrite_reg16(sohandle, so, 0x0053, xres - 1);\r\nmigor_lcd_qvga_seq(sohandle, so, magic2_data, ARRAY_SIZE(magic2_data));\r\nmdelay(10);\r\nmigor_lcd_qvga_seq(sohandle, so, magic3_data, ARRAY_SIZE(magic3_data));\r\nmdelay(40);\r\nwrite_reg16(sohandle, so, 0x0020, 0x0000);\r\nwrite_reg16(sohandle, so, 0x0021, 0x0000);\r\nfor (k = 0; k < (xres * 256); k++)\r\nwrite_reg16(sohandle, so, 0x0022, 0x0000);\r\nwrite_reg16(sohandle, so, 0x0020, 0x0000);\r\nwrite_reg16(sohandle, so, 0x0021, 0x0000);\r\nwrite_reg16(sohandle, so, 0x0007, 0x0173);\r\nmdelay(40);\r\nwrite_reg(sohandle, so, 0x00, 0x22);\r\nmdelay(100);\r\nreturn 0;\r\n}

void *acpi_os_open_directory(char *dir_pathname,\r\nchar *wildcard_spec, char requested_file_type)\r\n{\r\nstruct external_find_info *external_info;\r\nDIR *dir;\r\nexternal_info = calloc(1, sizeof(struct external_find_info));\r\nif (!external_info) {\r\nreturn (NULL);\r\n}\r\ndir = opendir(dir_pathname);\r\nif (!dir) {\r\nfprintf(stderr, "Cannot open directory - %s\n", dir_pathname);\r\nfree(external_info);\r\nreturn (NULL);\r\n}\r\nexternal_info->wildcard_spec = wildcard_spec;\r\nexternal_info->requested_file_type = requested_file_type;\r\nexternal_info->dir_pathname = dir_pathname;\r\nexternal_info->dir_ptr = dir;\r\nreturn (external_info);\r\n}\r\nchar *acpi_os_get_next_filename(void *dir_handle)\r\n{\r\nstruct external_find_info *external_info = dir_handle;\r\nstruct dirent *dir_entry;\r\nchar *temp_str;\r\nint str_len;\r\nstruct stat temp_stat;\r\nint err;\r\nwhile ((dir_entry = readdir(external_info->dir_ptr))) {\r\nif (!fnmatch\r\n(external_info->wildcard_spec, dir_entry->d_name, 0)) {\r\nif (dir_entry->d_name[0] == '.') {\r\ncontinue;\r\n}\r\nstr_len = strlen(dir_entry->d_name) +\r\nstrlen(external_info->dir_pathname) + 2;\r\ntemp_str = calloc(str_len, 1);\r\nif (!temp_str) {\r\nfprintf(stderr,\r\n"Could not allocate buffer for temporary string\n");\r\nreturn (NULL);\r\n}\r\nstrcpy(temp_str, external_info->dir_pathname);\r\nstrcat(temp_str, "/");\r\nstrcat(temp_str, dir_entry->d_name);\r\nerr = stat(temp_str, &temp_stat);\r\nif (err == -1) {\r\nfprintf(stderr,\r\n"Cannot stat file (should not happen) - %s\n",\r\ntemp_str);\r\nfree(temp_str);\r\nreturn (NULL);\r\n}\r\nfree(temp_str);\r\nif ((S_ISDIR(temp_stat.st_mode)\r\n&& (external_info->requested_file_type ==\r\nREQUEST_DIR_ONLY))\r\n|| ((!S_ISDIR(temp_stat.st_mode)\r\n&& external_info->requested_file_type ==\r\nREQUEST_FILE_ONLY))) {\r\nstrcpy(external_info->temp_buffer,\r\ndir_entry->d_name);\r\nreturn (external_info->temp_buffer);\r\n}\r\n}\r\n}\r\nreturn (NULL);\r\n}\r\nvoid acpi_os_close_directory(void *dir_handle)\r\n{\r\nstruct external_find_info *external_info = dir_handle;\r\nclosedir(external_info->dir_ptr);\r\nfree(dir_handle);\r\n}

void write_ht_irq_msg(unsigned int irq, struct ht_irq_msg *msg)\r\n{\r\nstruct ht_irq_cfg *cfg = irq_get_handler_data(irq);\r\nunsigned long flags;\r\nspin_lock_irqsave(&ht_irq_lock, flags);\r\nif (cfg->msg.address_lo != msg->address_lo) {\r\npci_write_config_byte(cfg->dev, cfg->pos + 2, cfg->idx);\r\npci_write_config_dword(cfg->dev, cfg->pos + 4, msg->address_lo);\r\n}\r\nif (cfg->msg.address_hi != msg->address_hi) {\r\npci_write_config_byte(cfg->dev, cfg->pos + 2, cfg->idx + 1);\r\npci_write_config_dword(cfg->dev, cfg->pos + 4, msg->address_hi);\r\n}\r\nif (cfg->update)\r\ncfg->update(cfg->dev, irq, msg);\r\nspin_unlock_irqrestore(&ht_irq_lock, flags);\r\ncfg->msg = *msg;\r\n}\r\nvoid fetch_ht_irq_msg(unsigned int irq, struct ht_irq_msg *msg)\r\n{\r\nstruct ht_irq_cfg *cfg = irq_get_handler_data(irq);\r\n*msg = cfg->msg;\r\n}\r\nvoid mask_ht_irq(struct irq_data *data)\r\n{\r\nstruct ht_irq_cfg *cfg = irq_data_get_irq_handler_data(data);\r\nstruct ht_irq_msg msg = cfg->msg;\r\nmsg.address_lo |= 1;\r\nwrite_ht_irq_msg(data->irq, &msg);\r\n}\r\nvoid unmask_ht_irq(struct irq_data *data)\r\n{\r\nstruct ht_irq_cfg *cfg = irq_data_get_irq_handler_data(data);\r\nstruct ht_irq_msg msg = cfg->msg;\r\nmsg.address_lo &= ~1;\r\nwrite_ht_irq_msg(data->irq, &msg);\r\n}\r\nint __ht_create_irq(struct pci_dev *dev, int idx, ht_irq_update_t *update)\r\n{\r\nint max_irq, pos, irq;\r\nunsigned long flags;\r\nu32 data;\r\npos = pci_find_ht_capability(dev, HT_CAPTYPE_IRQ);\r\nif (!pos)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&ht_irq_lock, flags);\r\npci_write_config_byte(dev, pos + 2, 1);\r\npci_read_config_dword(dev, pos + 4, &data);\r\nspin_unlock_irqrestore(&ht_irq_lock, flags);\r\nmax_irq = (data >> 16) & 0xff;\r\nif (idx > max_irq)\r\nreturn -EINVAL;\r\nirq = arch_setup_ht_irq(idx, pos, dev, update);\r\nif (irq > 0)\r\ndev_dbg(&dev->dev, "irq %d for HT\n", irq);\r\nreturn irq;\r\n}\r\nint ht_create_irq(struct pci_dev *dev, int idx)\r\n{\r\nreturn __ht_create_irq(dev, idx, NULL);\r\n}\r\nvoid ht_destroy_irq(unsigned int irq)\r\n{\r\narch_teardown_ht_irq(irq);\r\n}

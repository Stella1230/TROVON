static void handler_call_die(const char *handler_name)\r\n{\r\nPyErr_Print();\r\nPy_FatalError("problem in Python trace event handler");\r\nabort();\r\n}\r\nstatic void pydict_set_item_string_decref(PyObject *dict, const char *key, PyObject *val)\r\n{\r\nPyDict_SetItemString(dict, key, val);\r\nPy_DECREF(val);\r\n}\r\nstatic PyObject *get_handler(const char *handler_name)\r\n{\r\nPyObject *handler;\r\nhandler = PyDict_GetItemString(main_dict, handler_name);\r\nif (handler && !PyCallable_Check(handler))\r\nreturn NULL;\r\nreturn handler;\r\n}\r\nstatic void call_object(PyObject *handler, PyObject *args, const char *die_msg)\r\n{\r\nPyObject *retval;\r\nretval = PyObject_CallObject(handler, args);\r\nif (retval == NULL)\r\nhandler_call_die(die_msg);\r\nPy_DECREF(retval);\r\n}\r\nstatic void try_call_object(const char *handler_name, PyObject *args)\r\n{\r\nPyObject *handler;\r\nhandler = get_handler(handler_name);\r\nif (handler)\r\ncall_object(handler, args, handler_name);\r\n}\r\nstatic void define_value(enum print_arg_type field_type,\r\nconst char *ev_name,\r\nconst char *field_name,\r\nconst char *field_value,\r\nconst char *field_str)\r\n{\r\nconst char *handler_name = "define_flag_value";\r\nPyObject *t;\r\nunsigned long long value;\r\nunsigned n = 0;\r\nif (field_type == PRINT_SYMBOL)\r\nhandler_name = "define_symbolic_value";\r\nt = PyTuple_New(4);\r\nif (!t)\r\nPy_FatalError("couldn't create Python tuple");\r\nvalue = eval_flag(field_value);\r\nPyTuple_SetItem(t, n++, PyString_FromString(ev_name));\r\nPyTuple_SetItem(t, n++, PyString_FromString(field_name));\r\nPyTuple_SetItem(t, n++, PyInt_FromLong(value));\r\nPyTuple_SetItem(t, n++, PyString_FromString(field_str));\r\ntry_call_object(handler_name, t);\r\nPy_DECREF(t);\r\n}\r\nstatic void define_values(enum print_arg_type field_type,\r\nstruct print_flag_sym *field,\r\nconst char *ev_name,\r\nconst char *field_name)\r\n{\r\ndefine_value(field_type, ev_name, field_name, field->value,\r\nfield->str);\r\nif (field->next)\r\ndefine_values(field_type, field->next, ev_name, field_name);\r\n}\r\nstatic void define_field(enum print_arg_type field_type,\r\nconst char *ev_name,\r\nconst char *field_name,\r\nconst char *delim)\r\n{\r\nconst char *handler_name = "define_flag_field";\r\nPyObject *t;\r\nunsigned n = 0;\r\nif (field_type == PRINT_SYMBOL)\r\nhandler_name = "define_symbolic_field";\r\nif (field_type == PRINT_FLAGS)\r\nt = PyTuple_New(3);\r\nelse\r\nt = PyTuple_New(2);\r\nif (!t)\r\nPy_FatalError("couldn't create Python tuple");\r\nPyTuple_SetItem(t, n++, PyString_FromString(ev_name));\r\nPyTuple_SetItem(t, n++, PyString_FromString(field_name));\r\nif (field_type == PRINT_FLAGS)\r\nPyTuple_SetItem(t, n++, PyString_FromString(delim));\r\ntry_call_object(handler_name, t);\r\nPy_DECREF(t);\r\n}\r\nstatic void define_event_symbols(struct event_format *event,\r\nconst char *ev_name,\r\nstruct print_arg *args)\r\n{\r\nswitch (args->type) {\r\ncase PRINT_NULL:\r\nbreak;\r\ncase PRINT_ATOM:\r\ndefine_value(PRINT_FLAGS, ev_name, cur_field_name, "0",\r\nargs->atom.atom);\r\nzero_flag_atom = 0;\r\nbreak;\r\ncase PRINT_FIELD:\r\nfree(cur_field_name);\r\ncur_field_name = strdup(args->field.name);\r\nbreak;\r\ncase PRINT_FLAGS:\r\ndefine_event_symbols(event, ev_name, args->flags.field);\r\ndefine_field(PRINT_FLAGS, ev_name, cur_field_name,\r\nargs->flags.delim);\r\ndefine_values(PRINT_FLAGS, args->flags.flags, ev_name,\r\ncur_field_name);\r\nbreak;\r\ncase PRINT_SYMBOL:\r\ndefine_event_symbols(event, ev_name, args->symbol.field);\r\ndefine_field(PRINT_SYMBOL, ev_name, cur_field_name, NULL);\r\ndefine_values(PRINT_SYMBOL, args->symbol.symbols, ev_name,\r\ncur_field_name);\r\nbreak;\r\ncase PRINT_HEX:\r\ndefine_event_symbols(event, ev_name, args->hex.field);\r\ndefine_event_symbols(event, ev_name, args->hex.size);\r\nbreak;\r\ncase PRINT_INT_ARRAY:\r\ndefine_event_symbols(event, ev_name, args->int_array.field);\r\ndefine_event_symbols(event, ev_name, args->int_array.count);\r\ndefine_event_symbols(event, ev_name, args->int_array.el_size);\r\nbreak;\r\ncase PRINT_STRING:\r\nbreak;\r\ncase PRINT_TYPE:\r\ndefine_event_symbols(event, ev_name, args->typecast.item);\r\nbreak;\r\ncase PRINT_OP:\r\nif (strcmp(args->op.op, ":") == 0)\r\nzero_flag_atom = 1;\r\ndefine_event_symbols(event, ev_name, args->op.left);\r\ndefine_event_symbols(event, ev_name, args->op.right);\r\nbreak;\r\ndefault:\r\ncase PRINT_BSTRING:\r\ncase PRINT_DYNAMIC_ARRAY:\r\ncase PRINT_FUNC:\r\ncase PRINT_BITMASK:\r\nreturn;\r\n}\r\nif (args->next)\r\ndefine_event_symbols(event, ev_name, args->next);\r\n}\r\nstatic PyObject *get_field_numeric_entry(struct event_format *event,\r\nstruct format_field *field, void *data)\r\n{\r\nbool is_array = field->flags & FIELD_IS_ARRAY;\r\nPyObject *obj, *list = NULL;\r\nunsigned long long val;\r\nunsigned int item_size, n_items, i;\r\nif (is_array) {\r\nlist = PyList_New(field->arraylen);\r\nitem_size = field->size / field->arraylen;\r\nn_items = field->arraylen;\r\n} else {\r\nitem_size = field->size;\r\nn_items = 1;\r\n}\r\nfor (i = 0; i < n_items; i++) {\r\nval = read_size(event, data + field->offset + i * item_size,\r\nitem_size);\r\nif (field->flags & FIELD_IS_SIGNED) {\r\nif ((long long)val >= LONG_MIN &&\r\n(long long)val <= LONG_MAX)\r\nobj = PyInt_FromLong(val);\r\nelse\r\nobj = PyLong_FromLongLong(val);\r\n} else {\r\nif (val <= LONG_MAX)\r\nobj = PyInt_FromLong(val);\r\nelse\r\nobj = PyLong_FromUnsignedLongLong(val);\r\n}\r\nif (is_array)\r\nPyList_SET_ITEM(list, i, obj);\r\n}\r\nif (is_array)\r\nobj = list;\r\nreturn obj;\r\n}\r\nstatic PyObject *python_process_callchain(struct perf_sample *sample,\r\nstruct perf_evsel *evsel,\r\nstruct addr_location *al)\r\n{\r\nPyObject *pylist;\r\npylist = PyList_New(0);\r\nif (!pylist)\r\nPy_FatalError("couldn't create Python list");\r\nif (!symbol_conf.use_callchain || !sample->callchain)\r\ngoto exit;\r\nif (thread__resolve_callchain(al->thread, evsel,\r\nsample, NULL, NULL,\r\nPERF_MAX_STACK_DEPTH) != 0) {\r\npr_err("Failed to resolve callchain. Skipping\n");\r\ngoto exit;\r\n}\r\ncallchain_cursor_commit(&callchain_cursor);\r\nwhile (1) {\r\nPyObject *pyelem;\r\nstruct callchain_cursor_node *node;\r\nnode = callchain_cursor_current(&callchain_cursor);\r\nif (!node)\r\nbreak;\r\npyelem = PyDict_New();\r\nif (!pyelem)\r\nPy_FatalError("couldn't create Python dictionary");\r\npydict_set_item_string_decref(pyelem, "ip",\r\nPyLong_FromUnsignedLongLong(node->ip));\r\nif (node->sym) {\r\nPyObject *pysym = PyDict_New();\r\nif (!pysym)\r\nPy_FatalError("couldn't create Python dictionary");\r\npydict_set_item_string_decref(pysym, "start",\r\nPyLong_FromUnsignedLongLong(node->sym->start));\r\npydict_set_item_string_decref(pysym, "end",\r\nPyLong_FromUnsignedLongLong(node->sym->end));\r\npydict_set_item_string_decref(pysym, "binding",\r\nPyInt_FromLong(node->sym->binding));\r\npydict_set_item_string_decref(pysym, "name",\r\nPyString_FromStringAndSize(node->sym->name,\r\nnode->sym->namelen));\r\npydict_set_item_string_decref(pyelem, "sym", pysym);\r\n}\r\nif (node->map) {\r\nstruct map *map = node->map;\r\nconst char *dsoname = "[unknown]";\r\nif (map && map->dso && (map->dso->name || map->dso->long_name)) {\r\nif (symbol_conf.show_kernel_path && map->dso->long_name)\r\ndsoname = map->dso->long_name;\r\nelse if (map->dso->name)\r\ndsoname = map->dso->name;\r\n}\r\npydict_set_item_string_decref(pyelem, "dso",\r\nPyString_FromString(dsoname));\r\n}\r\ncallchain_cursor_advance(&callchain_cursor);\r\nPyList_Append(pylist, pyelem);\r\nPy_DECREF(pyelem);\r\n}\r\nexit:\r\nreturn pylist;\r\n}\r\nstatic void python_process_tracepoint(struct perf_sample *sample,\r\nstruct perf_evsel *evsel,\r\nstruct addr_location *al)\r\n{\r\nstruct event_format *event = evsel->tp_format;\r\nPyObject *handler, *context, *t, *obj, *callchain;\r\nPyObject *dict = NULL;\r\nstatic char handler_name[256];\r\nstruct format_field *field;\r\nunsigned long s, ns;\r\nunsigned n = 0;\r\nint pid;\r\nint cpu = sample->cpu;\r\nvoid *data = sample->raw_data;\r\nunsigned long long nsecs = sample->time;\r\nconst char *comm = thread__comm_str(al->thread);\r\nt = PyTuple_New(MAX_FIELDS);\r\nif (!t)\r\nPy_FatalError("couldn't create Python tuple");\r\nif (!event)\r\ndie("ug! no event found for type %d", (int)evsel->attr.config);\r\npid = raw_field_value(event, "common_pid", data);\r\nsprintf(handler_name, "%s__%s", event->system, event->name);\r\nif (!test_and_set_bit(event->id, events_defined))\r\ndefine_event_symbols(event, handler_name, event->print_fmt.args);\r\nhandler = get_handler(handler_name);\r\nif (!handler) {\r\ndict = PyDict_New();\r\nif (!dict)\r\nPy_FatalError("couldn't create Python dict");\r\n}\r\ns = nsecs / NSECS_PER_SEC;\r\nns = nsecs - s * NSECS_PER_SEC;\r\nscripting_context->event_data = data;\r\nscripting_context->pevent = evsel->tp_format->pevent;\r\ncontext = PyCObject_FromVoidPtr(scripting_context, NULL);\r\nPyTuple_SetItem(t, n++, PyString_FromString(handler_name));\r\nPyTuple_SetItem(t, n++, context);\r\ncallchain = python_process_callchain(sample, evsel, al);\r\nif (handler) {\r\nPyTuple_SetItem(t, n++, PyInt_FromLong(cpu));\r\nPyTuple_SetItem(t, n++, PyInt_FromLong(s));\r\nPyTuple_SetItem(t, n++, PyInt_FromLong(ns));\r\nPyTuple_SetItem(t, n++, PyInt_FromLong(pid));\r\nPyTuple_SetItem(t, n++, PyString_FromString(comm));\r\nPyTuple_SetItem(t, n++, callchain);\r\n} else {\r\npydict_set_item_string_decref(dict, "common_cpu", PyInt_FromLong(cpu));\r\npydict_set_item_string_decref(dict, "common_s", PyInt_FromLong(s));\r\npydict_set_item_string_decref(dict, "common_ns", PyInt_FromLong(ns));\r\npydict_set_item_string_decref(dict, "common_pid", PyInt_FromLong(pid));\r\npydict_set_item_string_decref(dict, "common_comm", PyString_FromString(comm));\r\npydict_set_item_string_decref(dict, "common_callchain", callchain);\r\n}\r\nfor (field = event->format.fields; field; field = field->next) {\r\nif (field->flags & FIELD_IS_STRING) {\r\nint offset;\r\nif (field->flags & FIELD_IS_DYNAMIC) {\r\noffset = *(int *)(data + field->offset);\r\noffset &= 0xffff;\r\n} else\r\noffset = field->offset;\r\nobj = PyString_FromString((char *)data + offset);\r\n} else {\r\nobj = get_field_numeric_entry(event, field, data);\r\n}\r\nif (handler)\r\nPyTuple_SetItem(t, n++, obj);\r\nelse\r\npydict_set_item_string_decref(dict, field->name, obj);\r\n}\r\nif (!handler)\r\nPyTuple_SetItem(t, n++, dict);\r\nif (_PyTuple_Resize(&t, n) == -1)\r\nPy_FatalError("error resizing Python tuple");\r\nif (handler) {\r\ncall_object(handler, t, handler_name);\r\n} else {\r\ntry_call_object("trace_unhandled", t);\r\nPy_DECREF(dict);\r\n}\r\nPy_DECREF(t);\r\n}\r\nstatic PyObject *tuple_new(unsigned int sz)\r\n{\r\nPyObject *t;\r\nt = PyTuple_New(sz);\r\nif (!t)\r\nPy_FatalError("couldn't create Python tuple");\r\nreturn t;\r\n}\r\nstatic int tuple_set_u64(PyObject *t, unsigned int pos, u64 val)\r\n{\r\n#if BITS_PER_LONG == 64\r\nreturn PyTuple_SetItem(t, pos, PyInt_FromLong(val));\r\n#endif\r\n#if BITS_PER_LONG == 32\r\nreturn PyTuple_SetItem(t, pos, PyLong_FromLongLong(val));\r\n#endif\r\n}\r\nstatic int tuple_set_s32(PyObject *t, unsigned int pos, s32 val)\r\n{\r\nreturn PyTuple_SetItem(t, pos, PyInt_FromLong(val));\r\n}\r\nstatic int tuple_set_string(PyObject *t, unsigned int pos, const char *s)\r\n{\r\nreturn PyTuple_SetItem(t, pos, PyString_FromString(s));\r\n}\r\nstatic int python_export_evsel(struct db_export *dbe, struct perf_evsel *evsel)\r\n{\r\nstruct tables *tables = container_of(dbe, struct tables, dbe);\r\nPyObject *t;\r\nt = tuple_new(2);\r\ntuple_set_u64(t, 0, evsel->db_id);\r\ntuple_set_string(t, 1, perf_evsel__name(evsel));\r\ncall_object(tables->evsel_handler, t, "evsel_table");\r\nPy_DECREF(t);\r\nreturn 0;\r\n}\r\nstatic int python_export_machine(struct db_export *dbe,\r\nstruct machine *machine)\r\n{\r\nstruct tables *tables = container_of(dbe, struct tables, dbe);\r\nPyObject *t;\r\nt = tuple_new(3);\r\ntuple_set_u64(t, 0, machine->db_id);\r\ntuple_set_s32(t, 1, machine->pid);\r\ntuple_set_string(t, 2, machine->root_dir ? machine->root_dir : "");\r\ncall_object(tables->machine_handler, t, "machine_table");\r\nPy_DECREF(t);\r\nreturn 0;\r\n}\r\nstatic int python_export_thread(struct db_export *dbe, struct thread *thread,\r\nu64 main_thread_db_id, struct machine *machine)\r\n{\r\nstruct tables *tables = container_of(dbe, struct tables, dbe);\r\nPyObject *t;\r\nt = tuple_new(5);\r\ntuple_set_u64(t, 0, thread->db_id);\r\ntuple_set_u64(t, 1, machine->db_id);\r\ntuple_set_u64(t, 2, main_thread_db_id);\r\ntuple_set_s32(t, 3, thread->pid_);\r\ntuple_set_s32(t, 4, thread->tid);\r\ncall_object(tables->thread_handler, t, "thread_table");\r\nPy_DECREF(t);\r\nreturn 0;\r\n}\r\nstatic int python_export_comm(struct db_export *dbe, struct comm *comm)\r\n{\r\nstruct tables *tables = container_of(dbe, struct tables, dbe);\r\nPyObject *t;\r\nt = tuple_new(2);\r\ntuple_set_u64(t, 0, comm->db_id);\r\ntuple_set_string(t, 1, comm__str(comm));\r\ncall_object(tables->comm_handler, t, "comm_table");\r\nPy_DECREF(t);\r\nreturn 0;\r\n}\r\nstatic int python_export_comm_thread(struct db_export *dbe, u64 db_id,\r\nstruct comm *comm, struct thread *thread)\r\n{\r\nstruct tables *tables = container_of(dbe, struct tables, dbe);\r\nPyObject *t;\r\nt = tuple_new(3);\r\ntuple_set_u64(t, 0, db_id);\r\ntuple_set_u64(t, 1, comm->db_id);\r\ntuple_set_u64(t, 2, thread->db_id);\r\ncall_object(tables->comm_thread_handler, t, "comm_thread_table");\r\nPy_DECREF(t);\r\nreturn 0;\r\n}\r\nstatic int python_export_dso(struct db_export *dbe, struct dso *dso,\r\nstruct machine *machine)\r\n{\r\nstruct tables *tables = container_of(dbe, struct tables, dbe);\r\nchar sbuild_id[BUILD_ID_SIZE * 2 + 1];\r\nPyObject *t;\r\nbuild_id__sprintf(dso->build_id, sizeof(dso->build_id), sbuild_id);\r\nt = tuple_new(5);\r\ntuple_set_u64(t, 0, dso->db_id);\r\ntuple_set_u64(t, 1, machine->db_id);\r\ntuple_set_string(t, 2, dso->short_name);\r\ntuple_set_string(t, 3, dso->long_name);\r\ntuple_set_string(t, 4, sbuild_id);\r\ncall_object(tables->dso_handler, t, "dso_table");\r\nPy_DECREF(t);\r\nreturn 0;\r\n}\r\nstatic int python_export_symbol(struct db_export *dbe, struct symbol *sym,\r\nstruct dso *dso)\r\n{\r\nstruct tables *tables = container_of(dbe, struct tables, dbe);\r\nu64 *sym_db_id = symbol__priv(sym);\r\nPyObject *t;\r\nt = tuple_new(6);\r\ntuple_set_u64(t, 0, *sym_db_id);\r\ntuple_set_u64(t, 1, dso->db_id);\r\ntuple_set_u64(t, 2, sym->start);\r\ntuple_set_u64(t, 3, sym->end);\r\ntuple_set_s32(t, 4, sym->binding);\r\ntuple_set_string(t, 5, sym->name);\r\ncall_object(tables->symbol_handler, t, "symbol_table");\r\nPy_DECREF(t);\r\nreturn 0;\r\n}\r\nstatic int python_export_branch_type(struct db_export *dbe, u32 branch_type,\r\nconst char *name)\r\n{\r\nstruct tables *tables = container_of(dbe, struct tables, dbe);\r\nPyObject *t;\r\nt = tuple_new(2);\r\ntuple_set_s32(t, 0, branch_type);\r\ntuple_set_string(t, 1, name);\r\ncall_object(tables->branch_type_handler, t, "branch_type_table");\r\nPy_DECREF(t);\r\nreturn 0;\r\n}\r\nstatic int python_export_sample(struct db_export *dbe,\r\nstruct export_sample *es)\r\n{\r\nstruct tables *tables = container_of(dbe, struct tables, dbe);\r\nPyObject *t;\r\nt = tuple_new(21);\r\ntuple_set_u64(t, 0, es->db_id);\r\ntuple_set_u64(t, 1, es->evsel->db_id);\r\ntuple_set_u64(t, 2, es->al->machine->db_id);\r\ntuple_set_u64(t, 3, es->al->thread->db_id);\r\ntuple_set_u64(t, 4, es->comm_db_id);\r\ntuple_set_u64(t, 5, es->dso_db_id);\r\ntuple_set_u64(t, 6, es->sym_db_id);\r\ntuple_set_u64(t, 7, es->offset);\r\ntuple_set_u64(t, 8, es->sample->ip);\r\ntuple_set_u64(t, 9, es->sample->time);\r\ntuple_set_s32(t, 10, es->sample->cpu);\r\ntuple_set_u64(t, 11, es->addr_dso_db_id);\r\ntuple_set_u64(t, 12, es->addr_sym_db_id);\r\ntuple_set_u64(t, 13, es->addr_offset);\r\ntuple_set_u64(t, 14, es->sample->addr);\r\ntuple_set_u64(t, 15, es->sample->period);\r\ntuple_set_u64(t, 16, es->sample->weight);\r\ntuple_set_u64(t, 17, es->sample->transaction);\r\ntuple_set_u64(t, 18, es->sample->data_src);\r\ntuple_set_s32(t, 19, es->sample->flags & PERF_BRANCH_MASK);\r\ntuple_set_s32(t, 20, !!(es->sample->flags & PERF_IP_FLAG_IN_TX));\r\ncall_object(tables->sample_handler, t, "sample_table");\r\nPy_DECREF(t);\r\nreturn 0;\r\n}\r\nstatic int python_export_call_path(struct db_export *dbe, struct call_path *cp)\r\n{\r\nstruct tables *tables = container_of(dbe, struct tables, dbe);\r\nPyObject *t;\r\nu64 parent_db_id, sym_db_id;\r\nparent_db_id = cp->parent ? cp->parent->db_id : 0;\r\nsym_db_id = cp->sym ? *(u64 *)symbol__priv(cp->sym) : 0;\r\nt = tuple_new(4);\r\ntuple_set_u64(t, 0, cp->db_id);\r\ntuple_set_u64(t, 1, parent_db_id);\r\ntuple_set_u64(t, 2, sym_db_id);\r\ntuple_set_u64(t, 3, cp->ip);\r\ncall_object(tables->call_path_handler, t, "call_path_table");\r\nPy_DECREF(t);\r\nreturn 0;\r\n}\r\nstatic int python_export_call_return(struct db_export *dbe,\r\nstruct call_return *cr)\r\n{\r\nstruct tables *tables = container_of(dbe, struct tables, dbe);\r\nu64 comm_db_id = cr->comm ? cr->comm->db_id : 0;\r\nPyObject *t;\r\nt = tuple_new(11);\r\ntuple_set_u64(t, 0, cr->db_id);\r\ntuple_set_u64(t, 1, cr->thread->db_id);\r\ntuple_set_u64(t, 2, comm_db_id);\r\ntuple_set_u64(t, 3, cr->cp->db_id);\r\ntuple_set_u64(t, 4, cr->call_time);\r\ntuple_set_u64(t, 5, cr->return_time);\r\ntuple_set_u64(t, 6, cr->branch_count);\r\ntuple_set_u64(t, 7, cr->call_ref);\r\ntuple_set_u64(t, 8, cr->return_ref);\r\ntuple_set_u64(t, 9, cr->cp->parent->db_id);\r\ntuple_set_s32(t, 10, cr->flags);\r\ncall_object(tables->call_return_handler, t, "call_return_table");\r\nPy_DECREF(t);\r\nreturn 0;\r\n}\r\nstatic int python_process_call_return(struct call_return *cr, void *data)\r\n{\r\nstruct db_export *dbe = data;\r\nreturn db_export__call_return(dbe, cr);\r\n}\r\nstatic void python_process_general_event(struct perf_sample *sample,\r\nstruct perf_evsel *evsel,\r\nstruct addr_location *al)\r\n{\r\nPyObject *handler, *t, *dict, *callchain, *dict_sample;\r\nstatic char handler_name[64];\r\nunsigned n = 0;\r\nt = PyTuple_New(MAX_FIELDS);\r\nif (!t)\r\nPy_FatalError("couldn't create Python tuple");\r\ndict = PyDict_New();\r\nif (!dict)\r\nPy_FatalError("couldn't create Python dictionary");\r\ndict_sample = PyDict_New();\r\nif (!dict_sample)\r\nPy_FatalError("couldn't create Python dictionary");\r\nsnprintf(handler_name, sizeof(handler_name), "%s", "process_event");\r\nhandler = get_handler(handler_name);\r\nif (!handler)\r\ngoto exit;\r\npydict_set_item_string_decref(dict, "ev_name", PyString_FromString(perf_evsel__name(evsel)));\r\npydict_set_item_string_decref(dict, "attr", PyString_FromStringAndSize(\r\n(const char *)&evsel->attr, sizeof(evsel->attr)));\r\npydict_set_item_string_decref(dict_sample, "pid",\r\nPyInt_FromLong(sample->pid));\r\npydict_set_item_string_decref(dict_sample, "tid",\r\nPyInt_FromLong(sample->tid));\r\npydict_set_item_string_decref(dict_sample, "cpu",\r\nPyInt_FromLong(sample->cpu));\r\npydict_set_item_string_decref(dict_sample, "ip",\r\nPyLong_FromUnsignedLongLong(sample->ip));\r\npydict_set_item_string_decref(dict_sample, "time",\r\nPyLong_FromUnsignedLongLong(sample->time));\r\npydict_set_item_string_decref(dict_sample, "period",\r\nPyLong_FromUnsignedLongLong(sample->period));\r\npydict_set_item_string_decref(dict, "sample", dict_sample);\r\npydict_set_item_string_decref(dict, "raw_buf", PyString_FromStringAndSize(\r\n(const char *)sample->raw_data, sample->raw_size));\r\npydict_set_item_string_decref(dict, "comm",\r\nPyString_FromString(thread__comm_str(al->thread)));\r\nif (al->map) {\r\npydict_set_item_string_decref(dict, "dso",\r\nPyString_FromString(al->map->dso->name));\r\n}\r\nif (al->sym) {\r\npydict_set_item_string_decref(dict, "symbol",\r\nPyString_FromString(al->sym->name));\r\n}\r\ncallchain = python_process_callchain(sample, evsel, al);\r\npydict_set_item_string_decref(dict, "callchain", callchain);\r\nPyTuple_SetItem(t, n++, dict);\r\nif (_PyTuple_Resize(&t, n) == -1)\r\nPy_FatalError("error resizing Python tuple");\r\ncall_object(handler, t, handler_name);\r\nexit:\r\nPy_DECREF(dict);\r\nPy_DECREF(t);\r\n}\r\nstatic void python_process_event(union perf_event *event,\r\nstruct perf_sample *sample,\r\nstruct perf_evsel *evsel,\r\nstruct addr_location *al)\r\n{\r\nstruct tables *tables = &tables_global;\r\nswitch (evsel->attr.type) {\r\ncase PERF_TYPE_TRACEPOINT:\r\npython_process_tracepoint(sample, evsel, al);\r\nbreak;\r\ndefault:\r\nif (tables->db_export_mode)\r\ndb_export__sample(&tables->dbe, event, sample, evsel, al);\r\nelse\r\npython_process_general_event(sample, evsel, al);\r\n}\r\n}\r\nstatic int run_start_sub(void)\r\n{\r\nmain_module = PyImport_AddModule("__main__");\r\nif (main_module == NULL)\r\nreturn -1;\r\nPy_INCREF(main_module);\r\nmain_dict = PyModule_GetDict(main_module);\r\nif (main_dict == NULL)\r\ngoto error;\r\nPy_INCREF(main_dict);\r\ntry_call_object("trace_begin", NULL);\r\nreturn 0;\r\nerror:\r\nPy_XDECREF(main_dict);\r\nPy_XDECREF(main_module);\r\nreturn -1;\r\n}\r\nstatic void set_table_handlers(struct tables *tables)\r\n{\r\nconst char *perf_db_export_mode = "perf_db_export_mode";\r\nconst char *perf_db_export_calls = "perf_db_export_calls";\r\nPyObject *db_export_mode, *db_export_calls;\r\nbool export_calls = false;\r\nint ret;\r\nmemset(tables, 0, sizeof(struct tables));\r\nif (db_export__init(&tables->dbe))\r\nPy_FatalError("failed to initialize export");\r\ndb_export_mode = PyDict_GetItemString(main_dict, perf_db_export_mode);\r\nif (!db_export_mode)\r\nreturn;\r\nret = PyObject_IsTrue(db_export_mode);\r\nif (ret == -1)\r\nhandler_call_die(perf_db_export_mode);\r\nif (!ret)\r\nreturn;\r\ntables->dbe.crp = NULL;\r\ndb_export_calls = PyDict_GetItemString(main_dict, perf_db_export_calls);\r\nif (db_export_calls) {\r\nret = PyObject_IsTrue(db_export_calls);\r\nif (ret == -1)\r\nhandler_call_die(perf_db_export_calls);\r\nexport_calls = !!ret;\r\n}\r\nif (export_calls) {\r\ntables->dbe.crp =\r\ncall_return_processor__new(python_process_call_return,\r\n&tables->dbe);\r\nif (!tables->dbe.crp)\r\nPy_FatalError("failed to create calls processor");\r\n}\r\ntables->db_export_mode = true;\r\nsymbol_conf.priv_size = sizeof(u64);\r\nSET_TABLE_HANDLER(evsel);\r\nSET_TABLE_HANDLER(machine);\r\nSET_TABLE_HANDLER(thread);\r\nSET_TABLE_HANDLER(comm);\r\nSET_TABLE_HANDLER(comm_thread);\r\nSET_TABLE_HANDLER(dso);\r\nSET_TABLE_HANDLER(symbol);\r\nSET_TABLE_HANDLER(branch_type);\r\nSET_TABLE_HANDLER(sample);\r\nSET_TABLE_HANDLER(call_path);\r\nSET_TABLE_HANDLER(call_return);\r\n}\r\nstatic int python_start_script(const char *script, int argc, const char **argv)\r\n{\r\nstruct tables *tables = &tables_global;\r\nconst char **command_line;\r\nchar buf[PATH_MAX];\r\nint i, err = 0;\r\nFILE *fp;\r\ncommand_line = malloc((argc + 1) * sizeof(const char *));\r\ncommand_line[0] = script;\r\nfor (i = 1; i < argc + 1; i++)\r\ncommand_line[i] = argv[i - 1];\r\nPy_Initialize();\r\ninitperf_trace_context();\r\nPySys_SetArgv(argc + 1, (char **)command_line);\r\nfp = fopen(script, "r");\r\nif (!fp) {\r\nsprintf(buf, "Can't open python script \"%s\"", script);\r\nperror(buf);\r\nerr = -1;\r\ngoto error;\r\n}\r\nerr = PyRun_SimpleFile(fp, script);\r\nif (err) {\r\nfprintf(stderr, "Error running python script %s\n", script);\r\ngoto error;\r\n}\r\nerr = run_start_sub();\r\nif (err) {\r\nfprintf(stderr, "Error starting python script %s\n", script);\r\ngoto error;\r\n}\r\nfree(command_line);\r\nset_table_handlers(tables);\r\nif (tables->db_export_mode) {\r\nerr = db_export__branch_types(&tables->dbe);\r\nif (err)\r\ngoto error;\r\n}\r\nreturn err;\r\nerror:\r\nPy_Finalize();\r\nfree(command_line);\r\nreturn err;\r\n}\r\nstatic int python_flush_script(void)\r\n{\r\nstruct tables *tables = &tables_global;\r\nreturn db_export__flush(&tables->dbe);\r\n}\r\nstatic int python_stop_script(void)\r\n{\r\nstruct tables *tables = &tables_global;\r\ntry_call_object("trace_end", NULL);\r\ndb_export__exit(&tables->dbe);\r\nPy_XDECREF(main_dict);\r\nPy_XDECREF(main_module);\r\nPy_Finalize();\r\nreturn 0;\r\n}\r\nstatic int python_generate_script(struct pevent *pevent, const char *outfile)\r\n{\r\nstruct event_format *event = NULL;\r\nstruct format_field *f;\r\nchar fname[PATH_MAX];\r\nint not_first, count;\r\nFILE *ofp;\r\nsprintf(fname, "%s.py", outfile);\r\nofp = fopen(fname, "w");\r\nif (ofp == NULL) {\r\nfprintf(stderr, "couldn't open %s\n", fname);\r\nreturn -1;\r\n}\r\nfprintf(ofp, "# perf script event handlers, "\r\n"generated by perf script -g python\n");\r\nfprintf(ofp, "# Licensed under the terms of the GNU GPL"\r\n" License version 2\n\n");\r\nfprintf(ofp, "# The common_* event handler fields are the most useful "\r\n"fields common to\n");\r\nfprintf(ofp, "# all events. They don't necessarily correspond to "\r\n"the 'common_*' fields\n");\r\nfprintf(ofp, "# in the format files. Those fields not available as "\r\n"handler params can\n");\r\nfprintf(ofp, "# be retrieved using Python functions of the form "\r\n"common_*(context).\n");\r\nfprintf(ofp, "# See the perf-trace-python Documentation for the list "\r\n"of available functions.\n\n");\r\nfprintf(ofp, "import os\n");\r\nfprintf(ofp, "import sys\n\n");\r\nfprintf(ofp, "sys.path.append(os.environ['PERF_EXEC_PATH'] + \\\n");\r\nfprintf(ofp, "\t'/scripts/python/Perf-Trace-Util/lib/Perf/Trace')\n");\r\nfprintf(ofp, "\nfrom perf_trace_context import *\n");\r\nfprintf(ofp, "from Core import *\n\n\n");\r\nfprintf(ofp, "def trace_begin():\n");\r\nfprintf(ofp, "\tprint \"in trace_begin\"\n\n");\r\nfprintf(ofp, "def trace_end():\n");\r\nfprintf(ofp, "\tprint \"in trace_end\"\n\n");\r\nwhile ((event = trace_find_next_event(pevent, event))) {\r\nfprintf(ofp, "def %s__%s(", event->system, event->name);\r\nfprintf(ofp, "event_name, ");\r\nfprintf(ofp, "context, ");\r\nfprintf(ofp, "common_cpu,\n");\r\nfprintf(ofp, "\tcommon_secs, ");\r\nfprintf(ofp, "common_nsecs, ");\r\nfprintf(ofp, "common_pid, ");\r\nfprintf(ofp, "common_comm,\n\t");\r\nfprintf(ofp, "common_callchain, ");\r\nnot_first = 0;\r\ncount = 0;\r\nfor (f = event->format.fields; f; f = f->next) {\r\nif (not_first++)\r\nfprintf(ofp, ", ");\r\nif (++count % 5 == 0)\r\nfprintf(ofp, "\n\t");\r\nfprintf(ofp, "%s", f->name);\r\n}\r\nfprintf(ofp, "):\n");\r\nfprintf(ofp, "\t\tprint_header(event_name, common_cpu, "\r\n"common_secs, common_nsecs,\n\t\t\t"\r\n"common_pid, common_comm)\n\n");\r\nfprintf(ofp, "\t\tprint \"");\r\nnot_first = 0;\r\ncount = 0;\r\nfor (f = event->format.fields; f; f = f->next) {\r\nif (not_first++)\r\nfprintf(ofp, ", ");\r\nif (count && count % 3 == 0) {\r\nfprintf(ofp, "\" \\\n\t\t\"");\r\n}\r\ncount++;\r\nfprintf(ofp, "%s=", f->name);\r\nif (f->flags & FIELD_IS_STRING ||\r\nf->flags & FIELD_IS_FLAG ||\r\nf->flags & FIELD_IS_ARRAY ||\r\nf->flags & FIELD_IS_SYMBOLIC)\r\nfprintf(ofp, "%%s");\r\nelse if (f->flags & FIELD_IS_SIGNED)\r\nfprintf(ofp, "%%d");\r\nelse\r\nfprintf(ofp, "%%u");\r\n}\r\nfprintf(ofp, "\" %% \\\n\t\t(");\r\nnot_first = 0;\r\ncount = 0;\r\nfor (f = event->format.fields; f; f = f->next) {\r\nif (not_first++)\r\nfprintf(ofp, ", ");\r\nif (++count % 5 == 0)\r\nfprintf(ofp, "\n\t\t");\r\nif (f->flags & FIELD_IS_FLAG) {\r\nif ((count - 1) % 5 != 0) {\r\nfprintf(ofp, "\n\t\t");\r\ncount = 4;\r\n}\r\nfprintf(ofp, "flag_str(\"");\r\nfprintf(ofp, "%s__%s\", ", event->system,\r\nevent->name);\r\nfprintf(ofp, "\"%s\", %s)", f->name,\r\nf->name);\r\n} else if (f->flags & FIELD_IS_SYMBOLIC) {\r\nif ((count - 1) % 5 != 0) {\r\nfprintf(ofp, "\n\t\t");\r\ncount = 4;\r\n}\r\nfprintf(ofp, "symbol_str(\"");\r\nfprintf(ofp, "%s__%s\", ", event->system,\r\nevent->name);\r\nfprintf(ofp, "\"%s\", %s)", f->name,\r\nf->name);\r\n} else\r\nfprintf(ofp, "%s", f->name);\r\n}\r\nfprintf(ofp, ")\n\n");\r\nfprintf(ofp, "\t\tfor node in common_callchain:");\r\nfprintf(ofp, "\n\t\t\tif 'sym' in node:");\r\nfprintf(ofp, "\n\t\t\t\tprint \"\\t[%%x] %%s\" %% (node['ip'], node['sym']['name'])");\r\nfprintf(ofp, "\n\t\t\telse:");\r\nfprintf(ofp, "\n\t\t\t\tprint \"\t[%%x]\" %% (node['ip'])\n\n");\r\nfprintf(ofp, "\t\tprint \"\\n\"\n\n");\r\n}\r\nfprintf(ofp, "def trace_unhandled(event_name, context, "\r\n"event_fields_dict):\n");\r\nfprintf(ofp, "\t\tprint ' '.join(['%%s=%%s'%%(k,str(v))"\r\n"for k,v in sorted(event_fields_dict.items())])\n\n");\r\nfprintf(ofp, "def print_header("\r\n"event_name, cpu, secs, nsecs, pid, comm):\n"\r\n"\tprint \"%%-20s %%5u %%05u.%%09u %%8u %%-20s \" %% \\\n\t"\r\n"(event_name, cpu, secs, nsecs, pid, comm),\n");\r\nfclose(ofp);\r\nfprintf(stderr, "generated Python script: %s\n", fname);\r\nreturn 0;\r\n}

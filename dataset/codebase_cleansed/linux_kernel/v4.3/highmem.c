void *kmap(struct page *page)\r\n{\r\nvoid *addr;\r\nmight_sleep();\r\nif (!PageHighMem(page))\r\nreturn page_address(page);\r\naddr = kmap_high(page);\r\nflush_tlb_one((unsigned long)addr);\r\nreturn addr;\r\n}\r\nvoid kunmap(struct page *page)\r\n{\r\nBUG_ON(in_interrupt());\r\nif (!PageHighMem(page))\r\nreturn;\r\nkunmap_high(page);\r\n}\r\nvoid *kmap_atomic(struct page *page)\r\n{\r\nunsigned long vaddr;\r\nint idx, type;\r\npreempt_disable();\r\npagefault_disable();\r\nif (!PageHighMem(page))\r\nreturn page_address(page);\r\ntype = kmap_atomic_idx_push();\r\nidx = type + KM_TYPE_NR*smp_processor_id();\r\nvaddr = __fix_to_virt(FIX_KMAP_BEGIN + idx);\r\n#ifdef CONFIG_DEBUG_HIGHMEM\r\nBUG_ON(!pte_none(*(kmap_pte - idx)));\r\n#endif\r\nset_pte(kmap_pte-idx, mk_pte(page, PAGE_KERNEL));\r\nlocal_flush_tlb_one((unsigned long)vaddr);\r\nreturn (void*) vaddr;\r\n}\r\nvoid __kunmap_atomic(void *kvaddr)\r\n{\r\nunsigned long vaddr = (unsigned long) kvaddr & PAGE_MASK;\r\nint type __maybe_unused;\r\nif (vaddr < FIXADDR_START) {\r\npagefault_enable();\r\npreempt_enable();\r\nreturn;\r\n}\r\ntype = kmap_atomic_idx();\r\n#ifdef CONFIG_DEBUG_HIGHMEM\r\n{\r\nint idx = type + KM_TYPE_NR * smp_processor_id();\r\nBUG_ON(vaddr != __fix_to_virt(FIX_KMAP_BEGIN + idx));\r\npte_clear(&init_mm, vaddr, kmap_pte-idx);\r\nlocal_flush_tlb_one(vaddr);\r\n}\r\n#endif\r\nkmap_atomic_idx_pop();\r\npagefault_enable();\r\npreempt_enable();\r\n}\r\nvoid *kmap_atomic_pfn(unsigned long pfn)\r\n{\r\nunsigned long vaddr;\r\nint idx, type;\r\npreempt_disable();\r\npagefault_disable();\r\ntype = kmap_atomic_idx_push();\r\nidx = type + KM_TYPE_NR*smp_processor_id();\r\nvaddr = __fix_to_virt(FIX_KMAP_BEGIN + idx);\r\nset_pte(kmap_pte-idx, pfn_pte(pfn, PAGE_KERNEL));\r\nflush_tlb_one(vaddr);\r\nreturn (void*) vaddr;\r\n}\r\nstruct page *kmap_atomic_to_page(void *ptr)\r\n{\r\nunsigned long idx, vaddr = (unsigned long)ptr;\r\npte_t *pte;\r\nif (vaddr < FIXADDR_START)\r\nreturn virt_to_page(ptr);\r\nidx = virt_to_fix(vaddr);\r\npte = kmap_pte - (idx - FIX_KMAP_BEGIN);\r\nreturn pte_page(*pte);\r\n}\r\nvoid __init kmap_init(void)\r\n{\r\nunsigned long kmap_vstart;\r\nkmap_vstart = __fix_to_virt(FIX_KMAP_BEGIN);\r\nkmap_pte = kmap_get_fixmap_pte(kmap_vstart);\r\n}

void saa7164_buffer_display(struct saa7164_buffer *buf)\r\n{\r\nstruct saa7164_dev *dev = buf->port->dev;\r\nint i;\r\ndprintk(DBGLVL_BUF, "%s() buffer @ 0x%p nr=%d\n",\r\n__func__, buf, buf->idx);\r\ndprintk(DBGLVL_BUF, " pci_cpu @ 0x%p dma @ 0x%08llx len = 0x%x\n",\r\nbuf->cpu, (long long)buf->dma, buf->pci_size);\r\ndprintk(DBGLVL_BUF, " pt_cpu @ 0x%p pt_dma @ 0x%08llx len = 0x%x\n",\r\nbuf->pt_cpu, (long long)buf->pt_dma, buf->pt_size);\r\nfor (i = 0 ; i < SAA7164_PT_ENTRIES; i++) {\r\ndprintk(DBGLVL_BUF, " pt[%02d] = 0x%p -> 0x%llx\n",\r\ni, buf->pt_cpu, (u64)*(buf->pt_cpu));\r\n}\r\n}\r\nstruct saa7164_buffer *saa7164_buffer_alloc(struct saa7164_port *port,\r\nu32 len)\r\n{\r\nstruct tmHWStreamParameters *params = &port->hw_streamingparams;\r\nstruct saa7164_buffer *buf = NULL;\r\nstruct saa7164_dev *dev = port->dev;\r\nint i;\r\nif ((len == 0) || (len >= 65536) || (len % sizeof(u64))) {\r\nlog_warn("%s() SAA_ERR_BAD_PARAMETER\n", __func__);\r\ngoto ret;\r\n}\r\nbuf = kzalloc(sizeof(struct saa7164_buffer), GFP_KERNEL);\r\nif (!buf) {\r\nlog_warn("%s() SAA_ERR_NO_RESOURCES\n", __func__);\r\ngoto ret;\r\n}\r\nbuf->idx = -1;\r\nbuf->port = port;\r\nbuf->flags = SAA7164_BUFFER_FREE;\r\nbuf->pos = 0;\r\nbuf->actual_size = params->pitch * params->numberoflines;\r\nbuf->crc = 0;\r\nbuf->pci_size = SAA7164_PT_ENTRIES * 0x1000;\r\nbuf->pt_size = (SAA7164_PT_ENTRIES * sizeof(u64)) + 0x1000;\r\nbuf->cpu = pci_alloc_consistent(port->dev->pci, buf->pci_size,\r\n&buf->dma);\r\nif (!buf->cpu)\r\ngoto fail1;\r\nbuf->pt_cpu = pci_alloc_consistent(port->dev->pci, buf->pt_size,\r\n&buf->pt_dma);\r\nif (!buf->pt_cpu)\r\ngoto fail2;\r\nmemset(buf->cpu, 0xff, buf->pci_size);\r\nbuf->crc = crc32(0, buf->cpu, buf->actual_size);\r\nmemset(buf->pt_cpu, 0xff, buf->pt_size);\r\ndprintk(DBGLVL_BUF, "%s() allocated buffer @ 0x%p (%d pageptrs)\n",\r\n__func__, buf, params->numpagetables);\r\ndprintk(DBGLVL_BUF, " pci_cpu @ 0x%p dma @ 0x%08lx len = 0x%x\n",\r\nbuf->cpu, (long)buf->dma, buf->pci_size);\r\ndprintk(DBGLVL_BUF, " pt_cpu @ 0x%p pt_dma @ 0x%08lx len = 0x%x\n",\r\nbuf->pt_cpu, (long)buf->pt_dma, buf->pt_size);\r\nfor (i = 0 ; i < params->numpagetables; i++) {\r\n*(buf->pt_cpu + i) = buf->dma + (i * 0x1000);\r\ndprintk(DBGLVL_BUF, " pt[%02d] = 0x%p -> 0x%llx\n",\r\ni, buf->pt_cpu, (u64)*(buf->pt_cpu));\r\n}\r\ngoto ret;\r\nfail2:\r\npci_free_consistent(port->dev->pci, buf->pci_size, buf->cpu, buf->dma);\r\nfail1:\r\nkfree(buf);\r\nbuf = NULL;\r\nret:\r\nreturn buf;\r\n}\r\nint saa7164_buffer_dealloc(struct saa7164_buffer *buf)\r\n{\r\nstruct saa7164_dev *dev;\r\nif (!buf || !buf->port)\r\nreturn SAA_ERR_BAD_PARAMETER;\r\ndev = buf->port->dev;\r\ndprintk(DBGLVL_BUF, "%s() deallocating buffer @ 0x%p\n",\r\n__func__, buf);\r\nif (buf->flags != SAA7164_BUFFER_FREE)\r\nlog_warn(" freeing a non-free buffer\n");\r\npci_free_consistent(dev->pci, buf->pci_size, buf->cpu, buf->dma);\r\npci_free_consistent(dev->pci, buf->pt_size, buf->pt_cpu, buf->pt_dma);\r\nkfree(buf);\r\nreturn SAA_OK;\r\n}\r\nint saa7164_buffer_zero_offsets(struct saa7164_port *port, int i)\r\n{\r\nstruct saa7164_dev *dev = port->dev;\r\nif ((i < 0) || (i >= port->hwcfg.buffercount))\r\nreturn -EINVAL;\r\ndprintk(DBGLVL_BUF, "%s(idx = %d)\n", __func__, i);\r\nsaa7164_writel(port->bufoffset + (sizeof(u32) * i), 0);\r\nreturn 0;\r\n}\r\nint saa7164_buffer_activate(struct saa7164_buffer *buf, int i)\r\n{\r\nstruct saa7164_port *port = buf->port;\r\nstruct saa7164_dev *dev = port->dev;\r\nif ((i < 0) || (i >= port->hwcfg.buffercount))\r\nreturn -EINVAL;\r\ndprintk(DBGLVL_BUF, "%s(idx = %d)\n", __func__, i);\r\nbuf->idx = i;\r\nbuf->flags = SAA7164_BUFFER_BUSY;\r\nbuf->pos = 0;\r\nsaa7164_writel(port->bufoffset + (sizeof(u32) * i), 0);\r\nsaa7164_writel(port->bufptr32h + ((sizeof(u32) * 2) * i), buf->pt_dma);\r\nsaa7164_writel(port->bufptr32l + ((sizeof(u32) * 2) * i), 0);\r\ndprintk(DBGLVL_BUF, " buf[%d] offset 0x%llx (0x%x) "\r\n"buf 0x%llx/%llx (0x%x/%x) nr=%d\n",\r\nbuf->idx,\r\n(u64)port->bufoffset + (i * sizeof(u32)),\r\nsaa7164_readl(port->bufoffset + (sizeof(u32) * i)),\r\n(u64)port->bufptr32h + ((sizeof(u32) * 2) * i),\r\n(u64)port->bufptr32l + ((sizeof(u32) * 2) * i),\r\nsaa7164_readl(port->bufptr32h + ((sizeof(u32) * i) * 2)),\r\nsaa7164_readl(port->bufptr32l + ((sizeof(u32) * i) * 2)),\r\nbuf->idx);\r\nreturn 0;\r\n}\r\nint saa7164_buffer_cfg_port(struct saa7164_port *port)\r\n{\r\nstruct tmHWStreamParameters *params = &port->hw_streamingparams;\r\nstruct saa7164_dev *dev = port->dev;\r\nstruct saa7164_buffer *buf;\r\nstruct list_head *c, *n;\r\nint i = 0;\r\ndprintk(DBGLVL_BUF, "%s(port=%d)\n", __func__, port->nr);\r\nsaa7164_writel(port->bufcounter, 0);\r\nsaa7164_writel(port->pitch, params->pitch);\r\nsaa7164_writel(port->bufsize, params->pitch * params->numberoflines);\r\ndprintk(DBGLVL_BUF, " configured:\n");\r\ndprintk(DBGLVL_BUF, " lmmio 0x%p\n", dev->lmmio);\r\ndprintk(DBGLVL_BUF, " bufcounter 0x%x = 0x%x\n", port->bufcounter,\r\nsaa7164_readl(port->bufcounter));\r\ndprintk(DBGLVL_BUF, " pitch 0x%x = %d\n", port->pitch,\r\nsaa7164_readl(port->pitch));\r\ndprintk(DBGLVL_BUF, " bufsize 0x%x = %d\n", port->bufsize,\r\nsaa7164_readl(port->bufsize));\r\ndprintk(DBGLVL_BUF, " buffercount = %d\n", port->hwcfg.buffercount);\r\ndprintk(DBGLVL_BUF, " bufoffset = 0x%x\n", port->bufoffset);\r\ndprintk(DBGLVL_BUF, " bufptr32h = 0x%x\n", port->bufptr32h);\r\ndprintk(DBGLVL_BUF, " bufptr32l = 0x%x\n", port->bufptr32l);\r\nmutex_lock(&port->dmaqueue_lock);\r\nlist_for_each_safe(c, n, &port->dmaqueue.list) {\r\nbuf = list_entry(c, struct saa7164_buffer, list);\r\nif (buf->flags != SAA7164_BUFFER_FREE)\r\nBUG();\r\nsaa7164_buffer_activate(buf, i);\r\nif (i++ > port->hwcfg.buffercount)\r\nBUG();\r\n}\r\nmutex_unlock(&port->dmaqueue_lock);\r\nreturn 0;\r\n}\r\nstruct saa7164_user_buffer *saa7164_buffer_alloc_user(struct saa7164_dev *dev,\r\nu32 len)\r\n{\r\nstruct saa7164_user_buffer *buf;\r\nbuf = kzalloc(sizeof(struct saa7164_user_buffer), GFP_KERNEL);\r\nif (!buf)\r\nreturn NULL;\r\nbuf->data = kzalloc(len, GFP_KERNEL);\r\nif (!buf->data) {\r\nkfree(buf);\r\nreturn NULL;\r\n}\r\nbuf->actual_size = len;\r\nbuf->pos = 0;\r\nbuf->crc = 0;\r\ndprintk(DBGLVL_BUF, "%s() allocated user buffer @ 0x%p\n",\r\n__func__, buf);\r\nreturn buf;\r\n}\r\nvoid saa7164_buffer_dealloc_user(struct saa7164_user_buffer *buf)\r\n{\r\nif (!buf)\r\nreturn;\r\nkfree(buf->data);\r\nbuf->data = NULL;\r\nkfree(buf);\r\n}

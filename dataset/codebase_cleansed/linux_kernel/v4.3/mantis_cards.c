static irqreturn_t mantis_irq_handler(int irq, void *dev_id)\r\n{\r\nu32 stat = 0, mask = 0;\r\nu32 rst_stat = 0, rst_mask = 0;\r\nstruct mantis_pci *mantis;\r\nstruct mantis_ca *ca;\r\nmantis = (struct mantis_pci *) dev_id;\r\nif (unlikely(mantis == NULL)) {\r\ndprintk(MANTIS_ERROR, 1, "Mantis == NULL");\r\nreturn IRQ_NONE;\r\n}\r\nca = mantis->mantis_ca;\r\nstat = mmread(MANTIS_INT_STAT);\r\nmask = mmread(MANTIS_INT_MASK);\r\nif (!(stat & mask))\r\nreturn IRQ_NONE;\r\nrst_mask = MANTIS_GPIF_WRACK |\r\nMANTIS_GPIF_OTHERR |\r\nMANTIS_SBUF_WSTO |\r\nMANTIS_GPIF_EXTIRQ;\r\nrst_stat = mmread(MANTIS_GPIF_STATUS);\r\nrst_stat &= rst_mask;\r\nmmwrite(rst_stat, MANTIS_GPIF_STATUS);\r\nmantis->mantis_int_stat = stat;\r\nmantis->mantis_int_mask = mask;\r\ndprintk(MANTIS_DEBUG, 0, "\n-- Stat=<%02x> Mask=<%02x> --", stat, mask);\r\nif (stat & MANTIS_INT_RISCEN) {\r\ndprintk(MANTIS_DEBUG, 0, "<%s>", label[0]);\r\n}\r\nif (stat & MANTIS_INT_IRQ0) {\r\ndprintk(MANTIS_DEBUG, 0, "<%s>", label[1]);\r\nmantis->gpif_status = rst_stat;\r\nwake_up(&ca->hif_write_wq);\r\nschedule_work(&ca->hif_evm_work);\r\n}\r\nif (stat & MANTIS_INT_IRQ1) {\r\ndprintk(MANTIS_DEBUG, 0, "<%s>", label[2]);\r\nspin_lock(&mantis->intmask_lock);\r\nmmwrite(mmread(MANTIS_INT_MASK) & ~MANTIS_INT_IRQ1,\r\nMANTIS_INT_MASK);\r\nspin_unlock(&mantis->intmask_lock);\r\nschedule_work(&mantis->uart_work);\r\n}\r\nif (stat & MANTIS_INT_OCERR) {\r\ndprintk(MANTIS_DEBUG, 0, "<%s>", label[3]);\r\n}\r\nif (stat & MANTIS_INT_PABORT) {\r\ndprintk(MANTIS_DEBUG, 0, "<%s>", label[4]);\r\n}\r\nif (stat & MANTIS_INT_RIPERR) {\r\ndprintk(MANTIS_DEBUG, 0, "<%s>", label[5]);\r\n}\r\nif (stat & MANTIS_INT_PPERR) {\r\ndprintk(MANTIS_DEBUG, 0, "<%s>", label[6]);\r\n}\r\nif (stat & MANTIS_INT_FTRGT) {\r\ndprintk(MANTIS_DEBUG, 0, "<%s>", label[7]);\r\n}\r\nif (stat & MANTIS_INT_RISCI) {\r\ndprintk(MANTIS_DEBUG, 0, "<%s>", label[8]);\r\nmantis->busy_block = (stat & MANTIS_INT_RISCSTAT) >> 28;\r\ntasklet_schedule(&mantis->tasklet);\r\n}\r\nif (stat & MANTIS_INT_I2CDONE) {\r\ndprintk(MANTIS_DEBUG, 0, "<%s>", label[9]);\r\nwake_up(&mantis->i2c_wq);\r\n}\r\nmmwrite(stat, MANTIS_INT_STAT);\r\nstat &= ~(MANTIS_INT_RISCEN | MANTIS_INT_I2CDONE |\r\nMANTIS_INT_I2CRACK | MANTIS_INT_PCMCIA7 |\r\nMANTIS_INT_PCMCIA6 | MANTIS_INT_PCMCIA5 |\r\nMANTIS_INT_PCMCIA4 | MANTIS_INT_PCMCIA3 |\r\nMANTIS_INT_PCMCIA2 | MANTIS_INT_PCMCIA1 |\r\nMANTIS_INT_PCMCIA0 | MANTIS_INT_IRQ1 |\r\nMANTIS_INT_IRQ0 | MANTIS_INT_OCERR |\r\nMANTIS_INT_PABORT | MANTIS_INT_RIPERR |\r\nMANTIS_INT_PPERR | MANTIS_INT_FTRGT |\r\nMANTIS_INT_RISCI);\r\nif (stat)\r\ndprintk(MANTIS_DEBUG, 0, "<Unknown> Stat=<%02x> Mask=<%02x>", stat, mask);\r\ndprintk(MANTIS_DEBUG, 0, "\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int mantis_pci_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nstruct mantis_pci_drvdata *drvdata;\r\nstruct mantis_pci *mantis;\r\nstruct mantis_hwconfig *config;\r\nint err = 0;\r\nmantis = kzalloc(sizeof(struct mantis_pci), GFP_KERNEL);\r\nif (mantis == NULL) {\r\nprintk(KERN_ERR "%s ERROR: Out of memory\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\ndrvdata = (void *)pci_id->driver_data;\r\nmantis->num = devs;\r\nmantis->verbose = verbose;\r\nmantis->pdev = pdev;\r\nconfig = drvdata->hwconfig;\r\nconfig->irq_handler = &mantis_irq_handler;\r\nmantis->hwconfig = config;\r\nmantis->rc_map_name = drvdata->rc_map_name;\r\nspin_lock_init(&mantis->intmask_lock);\r\nerr = mantis_pci_init(mantis);\r\nif (err) {\r\ndprintk(MANTIS_ERROR, 1, "ERROR: Mantis PCI initialization failed <%d>", err);\r\ngoto err_free_mantis;\r\n}\r\nerr = mantis_stream_control(mantis, STREAM_TO_HIF);\r\nif (err < 0) {\r\ndprintk(MANTIS_ERROR, 1, "ERROR: Mantis stream control failed <%d>", err);\r\ngoto err_pci_exit;\r\n}\r\nerr = mantis_i2c_init(mantis);\r\nif (err < 0) {\r\ndprintk(MANTIS_ERROR, 1, "ERROR: Mantis I2C initialization failed <%d>", err);\r\ngoto err_pci_exit;\r\n}\r\nerr = mantis_get_mac(mantis);\r\nif (err < 0) {\r\ndprintk(MANTIS_ERROR, 1, "ERROR: Mantis MAC address read failed <%d>", err);\r\ngoto err_i2c_exit;\r\n}\r\nerr = mantis_dma_init(mantis);\r\nif (err < 0) {\r\ndprintk(MANTIS_ERROR, 1, "ERROR: Mantis DMA initialization failed <%d>", err);\r\ngoto err_i2c_exit;\r\n}\r\nerr = mantis_dvb_init(mantis);\r\nif (err < 0) {\r\ndprintk(MANTIS_ERROR, 1, "ERROR: Mantis DVB initialization failed <%d>", err);\r\ngoto err_dma_exit;\r\n}\r\nerr = mantis_input_init(mantis);\r\nif (err < 0) {\r\ndprintk(MANTIS_ERROR, 1,\r\n"ERROR: Mantis DVB initialization failed <%d>", err);\r\ngoto err_dvb_exit;\r\n}\r\nerr = mantis_uart_init(mantis);\r\nif (err < 0) {\r\ndprintk(MANTIS_ERROR, 1, "ERROR: Mantis UART initialization failed <%d>", err);\r\ngoto err_input_exit;\r\n}\r\ndevs++;\r\nreturn 0;\r\nerr_input_exit:\r\nmantis_input_exit(mantis);\r\nerr_dvb_exit:\r\nmantis_dvb_exit(mantis);\r\nerr_dma_exit:\r\nmantis_dma_exit(mantis);\r\nerr_i2c_exit:\r\nmantis_i2c_exit(mantis);\r\nerr_pci_exit:\r\nmantis_pci_exit(mantis);\r\nerr_free_mantis:\r\nkfree(mantis);\r\nreturn err;\r\n}\r\nstatic void mantis_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct mantis_pci *mantis = pci_get_drvdata(pdev);\r\nif (mantis) {\r\nmantis_uart_exit(mantis);\r\nmantis_input_exit(mantis);\r\nmantis_dvb_exit(mantis);\r\nmantis_dma_exit(mantis);\r\nmantis_i2c_exit(mantis);\r\nmantis_pci_exit(mantis);\r\nkfree(mantis);\r\n}\r\nreturn;\r\n}

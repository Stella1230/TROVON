void mctrl_gpio_set(struct mctrl_gpios *gpios, unsigned int mctrl)\r\n{\r\nenum mctrl_gpio_idx i;\r\nstruct gpio_desc *desc_array[UART_GPIO_MAX];\r\nint value_array[UART_GPIO_MAX];\r\nunsigned int count = 0;\r\nfor (i = 0; i < UART_GPIO_MAX; i++)\r\nif (gpios->gpio[i] && mctrl_gpios_desc[i].dir_out) {\r\ndesc_array[count] = gpios->gpio[i];\r\nvalue_array[count] = !!(mctrl & mctrl_gpios_desc[i].mctrl);\r\ncount++;\r\n}\r\ngpiod_set_array_value(count, desc_array, value_array);\r\n}\r\nstruct gpio_desc *mctrl_gpio_to_gpiod(struct mctrl_gpios *gpios,\r\nenum mctrl_gpio_idx gidx)\r\n{\r\nreturn gpios->gpio[gidx];\r\n}\r\nunsigned int mctrl_gpio_get(struct mctrl_gpios *gpios, unsigned int *mctrl)\r\n{\r\nenum mctrl_gpio_idx i;\r\nfor (i = 0; i < UART_GPIO_MAX; i++) {\r\nif (gpios->gpio[i] && !mctrl_gpios_desc[i].dir_out) {\r\nif (gpiod_get_value(gpios->gpio[i]))\r\n*mctrl |= mctrl_gpios_desc[i].mctrl;\r\nelse\r\n*mctrl &= ~mctrl_gpios_desc[i].mctrl;\r\n}\r\n}\r\nreturn *mctrl;\r\n}\r\nstruct mctrl_gpios *mctrl_gpio_init(struct device *dev, unsigned int idx)\r\n{\r\nstruct mctrl_gpios *gpios;\r\nenum mctrl_gpio_idx i;\r\ngpios = devm_kzalloc(dev, sizeof(*gpios), GFP_KERNEL);\r\nif (!gpios)\r\nreturn ERR_PTR(-ENOMEM);\r\nfor (i = 0; i < UART_GPIO_MAX; i++) {\r\nenum gpiod_flags flags;\r\nif (mctrl_gpios_desc[i].dir_out)\r\nflags = GPIOD_OUT_LOW;\r\nelse\r\nflags = GPIOD_IN;\r\ngpios->gpio[i] =\r\ndevm_gpiod_get_index_optional(dev,\r\nmctrl_gpios_desc[i].name,\r\nidx, flags);\r\nif (IS_ERR(gpios->gpio[i]))\r\nreturn ERR_CAST(gpios->gpio[i]);\r\n}\r\nreturn gpios;\r\n}\r\nvoid mctrl_gpio_free(struct device *dev, struct mctrl_gpios *gpios)\r\n{\r\nenum mctrl_gpio_idx i;\r\nfor (i = 0; i < UART_GPIO_MAX; i++)\r\nif (gpios->gpio[i])\r\ndevm_gpiod_put(dev, gpios->gpio[i]);\r\ndevm_kfree(dev, gpios);\r\n}

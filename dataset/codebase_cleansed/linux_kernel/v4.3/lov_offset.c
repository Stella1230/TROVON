u64 lov_stripe_size(struct lov_stripe_md *lsm, u64 ost_size,\r\nint stripeno)\r\n{\r\nunsigned long ssize = lsm->lsm_stripe_size;\r\nunsigned long stripe_size;\r\nu64 swidth;\r\nu64 lov_size;\r\nint magic = lsm->lsm_magic;\r\nif (ost_size == 0)\r\nreturn 0;\r\nLASSERT(lsm_op_find(magic) != NULL);\r\nlsm_op_find(magic)->lsm_stripe_by_index(lsm, &stripeno, NULL, &swidth);\r\nstripe_size = lov_do_div64(ost_size, ssize);\r\nif (stripe_size)\r\nlov_size = ost_size * swidth + stripeno * ssize + stripe_size;\r\nelse\r\nlov_size = (ost_size - 1) * swidth + (stripeno + 1) * ssize;\r\nreturn lov_size;\r\n}\r\nint lov_stripe_offset(struct lov_stripe_md *lsm, u64 lov_off,\r\nint stripeno, u64 *obdoff)\r\n{\r\nunsigned long ssize = lsm->lsm_stripe_size;\r\nu64 stripe_off, this_stripe, swidth;\r\nint magic = lsm->lsm_magic;\r\nint ret = 0;\r\nif (lov_off == OBD_OBJECT_EOF) {\r\n*obdoff = OBD_OBJECT_EOF;\r\nreturn 0;\r\n}\r\nLASSERT(lsm_op_find(magic) != NULL);\r\nlsm_op_find(magic)->lsm_stripe_by_index(lsm, &stripeno, &lov_off,\r\n&swidth);\r\nstripe_off = lov_do_div64(lov_off, swidth);\r\nthis_stripe = (u64)stripeno * ssize;\r\nif (stripe_off < this_stripe) {\r\nstripe_off = 0;\r\nret = -1;\r\n} else {\r\nstripe_off -= this_stripe;\r\nif (stripe_off >= ssize) {\r\nstripe_off = ssize;\r\nret = 1;\r\n}\r\n}\r\n*obdoff = lov_off * ssize + stripe_off;\r\nreturn ret;\r\n}\r\nu64 lov_size_to_stripe(struct lov_stripe_md *lsm, u64 file_size,\r\nint stripeno)\r\n{\r\nunsigned long ssize = lsm->lsm_stripe_size;\r\nu64 stripe_off, this_stripe, swidth;\r\nint magic = lsm->lsm_magic;\r\nif (file_size == OBD_OBJECT_EOF)\r\nreturn OBD_OBJECT_EOF;\r\nLASSERT(lsm_op_find(magic) != NULL);\r\nlsm_op_find(magic)->lsm_stripe_by_index(lsm, &stripeno, &file_size,\r\n&swidth);\r\nstripe_off = lov_do_div64(file_size, swidth);\r\nthis_stripe = (u64)stripeno * ssize;\r\nif (stripe_off < this_stripe) {\r\nif (file_size > 0) {\r\nfile_size--;\r\nstripe_off = ssize;\r\n} else {\r\nstripe_off = 0;\r\n}\r\n} else {\r\nstripe_off -= this_stripe;\r\nif (stripe_off >= ssize) {\r\nstripe_off = ssize;\r\n}\r\n}\r\nreturn (file_size * ssize + stripe_off);\r\n}\r\nint lov_stripe_intersects(struct lov_stripe_md *lsm, int stripeno,\r\nu64 start, u64 end, u64 *obd_start, u64 *obd_end)\r\n{\r\nint start_side, end_side;\r\nstart_side = lov_stripe_offset(lsm, start, stripeno, obd_start);\r\nend_side = lov_stripe_offset(lsm, end, stripeno, obd_end);\r\nCDEBUG(D_INODE, "[%llu->%llu] -> [(%d) %llu->%llu (%d)]\n",\r\nstart, end, start_side, *obd_start, *obd_end, end_side);\r\nif (start_side != 0 && end_side != 0 && *obd_start == *obd_end)\r\nreturn 0;\r\nif (end_side != 0)\r\n(*obd_end)--;\r\nreturn 1;\r\n}\r\nint lov_stripe_number(struct lov_stripe_md *lsm, u64 lov_off)\r\n{\r\nunsigned long ssize = lsm->lsm_stripe_size;\r\nu64 stripe_off, swidth;\r\nint magic = lsm->lsm_magic;\r\nLASSERT(lsm_op_find(magic) != NULL);\r\nlsm_op_find(magic)->lsm_stripe_by_offset(lsm, NULL, &lov_off, &swidth);\r\nstripe_off = lov_do_div64(lov_off, swidth);\r\nlov_do_div64(stripe_off, ssize);\r\nreturn stripe_off;\r\n}

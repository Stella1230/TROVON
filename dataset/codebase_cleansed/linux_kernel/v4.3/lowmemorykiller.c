static unsigned long lowmem_count(struct shrinker *s,\r\nstruct shrink_control *sc)\r\n{\r\nreturn global_page_state(NR_ACTIVE_ANON) +\r\nglobal_page_state(NR_ACTIVE_FILE) +\r\nglobal_page_state(NR_INACTIVE_ANON) +\r\nglobal_page_state(NR_INACTIVE_FILE);\r\n}\r\nstatic unsigned long lowmem_scan(struct shrinker *s, struct shrink_control *sc)\r\n{\r\nstruct task_struct *tsk;\r\nstruct task_struct *selected = NULL;\r\nunsigned long rem = 0;\r\nint tasksize;\r\nint i;\r\nshort min_score_adj = OOM_SCORE_ADJ_MAX + 1;\r\nint selected_tasksize = 0;\r\nshort selected_oom_score_adj;\r\nint array_size = ARRAY_SIZE(lowmem_adj);\r\nint other_free = global_page_state(NR_FREE_PAGES) - totalreserve_pages;\r\nint other_file = global_page_state(NR_FILE_PAGES) -\r\nglobal_page_state(NR_SHMEM) -\r\ntotal_swapcache_pages();\r\nif (lowmem_adj_size < array_size)\r\narray_size = lowmem_adj_size;\r\nif (lowmem_minfree_size < array_size)\r\narray_size = lowmem_minfree_size;\r\nfor (i = 0; i < array_size; i++) {\r\nif (other_free < lowmem_minfree[i] &&\r\nother_file < lowmem_minfree[i]) {\r\nmin_score_adj = lowmem_adj[i];\r\nbreak;\r\n}\r\n}\r\nlowmem_print(3, "lowmem_scan %lu, %x, ofree %d %d, ma %hd\n",\r\nsc->nr_to_scan, sc->gfp_mask, other_free,\r\nother_file, min_score_adj);\r\nif (min_score_adj == OOM_SCORE_ADJ_MAX + 1) {\r\nlowmem_print(5, "lowmem_scan %lu, %x, return 0\n",\r\nsc->nr_to_scan, sc->gfp_mask);\r\nreturn 0;\r\n}\r\nselected_oom_score_adj = min_score_adj;\r\nrcu_read_lock();\r\nfor_each_process(tsk) {\r\nstruct task_struct *p;\r\nshort oom_score_adj;\r\nif (tsk->flags & PF_KTHREAD)\r\ncontinue;\r\np = find_lock_task_mm(tsk);\r\nif (!p)\r\ncontinue;\r\nif (test_tsk_thread_flag(p, TIF_MEMDIE) &&\r\ntime_before_eq(jiffies, lowmem_deathpending_timeout)) {\r\ntask_unlock(p);\r\nrcu_read_unlock();\r\nreturn 0;\r\n}\r\noom_score_adj = p->signal->oom_score_adj;\r\nif (oom_score_adj < min_score_adj) {\r\ntask_unlock(p);\r\ncontinue;\r\n}\r\ntasksize = get_mm_rss(p->mm);\r\ntask_unlock(p);\r\nif (tasksize <= 0)\r\ncontinue;\r\nif (selected) {\r\nif (oom_score_adj < selected_oom_score_adj)\r\ncontinue;\r\nif (oom_score_adj == selected_oom_score_adj &&\r\ntasksize <= selected_tasksize)\r\ncontinue;\r\n}\r\nselected = p;\r\nselected_tasksize = tasksize;\r\nselected_oom_score_adj = oom_score_adj;\r\nlowmem_print(2, "select %d (%s), adj %hd, size %d, to kill\n",\r\np->pid, p->comm, oom_score_adj, tasksize);\r\n}\r\nif (selected) {\r\ntask_lock(selected);\r\nif (!selected->mm) {\r\ntask_unlock(selected);\r\ngoto out;\r\n}\r\nmark_oom_victim(selected);\r\ntask_unlock(selected);\r\nlowmem_print(1, "send sigkill to %d (%s), adj %hd, size %d\n",\r\nselected->pid, selected->comm,\r\nselected_oom_score_adj, selected_tasksize);\r\nlowmem_deathpending_timeout = jiffies + HZ;\r\nsend_sig(SIGKILL, selected, 0);\r\nrem += selected_tasksize;\r\n}\r\nout:\r\nlowmem_print(4, "lowmem_scan %lu, %x, return %lu\n",\r\nsc->nr_to_scan, sc->gfp_mask, rem);\r\nrcu_read_unlock();\r\nreturn rem;\r\n}\r\nstatic int __init lowmem_init(void)\r\n{\r\nregister_shrinker(&lowmem_shrinker);\r\nreturn 0;\r\n}\r\nstatic void __exit lowmem_exit(void)\r\n{\r\nunregister_shrinker(&lowmem_shrinker);\r\n}

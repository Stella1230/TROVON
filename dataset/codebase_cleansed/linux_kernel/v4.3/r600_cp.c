static int r600_do_wait_for_fifo(drm_radeon_private_t *dev_priv, int entries)\r\n{\r\nint i;\r\ndev_priv->stats.boxes |= RADEON_BOX_WAIT_IDLE;\r\nfor (i = 0; i < dev_priv->usec_timeout; i++) {\r\nint slots;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RV770)\r\nslots = (RADEON_READ(R600_GRBM_STATUS)\r\n& R700_CMDFIFO_AVAIL_MASK);\r\nelse\r\nslots = (RADEON_READ(R600_GRBM_STATUS)\r\n& R600_CMDFIFO_AVAIL_MASK);\r\nif (slots >= entries)\r\nreturn 0;\r\nDRM_UDELAY(1);\r\n}\r\nDRM_INFO("wait for fifo failed status : 0x%08X 0x%08X\n",\r\nRADEON_READ(R600_GRBM_STATUS),\r\nRADEON_READ(R600_GRBM_STATUS2));\r\nreturn -EBUSY;\r\n}\r\nstatic int r600_do_wait_for_idle(drm_radeon_private_t *dev_priv)\r\n{\r\nint i, ret;\r\ndev_priv->stats.boxes |= RADEON_BOX_WAIT_IDLE;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RV770)\r\nret = r600_do_wait_for_fifo(dev_priv, 8);\r\nelse\r\nret = r600_do_wait_for_fifo(dev_priv, 16);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < dev_priv->usec_timeout; i++) {\r\nif (!(RADEON_READ(R600_GRBM_STATUS) & R600_GUI_ACTIVE))\r\nreturn 0;\r\nDRM_UDELAY(1);\r\n}\r\nDRM_INFO("wait idle failed status : 0x%08X 0x%08X\n",\r\nRADEON_READ(R600_GRBM_STATUS),\r\nRADEON_READ(R600_GRBM_STATUS2));\r\nreturn -EBUSY;\r\n}\r\nvoid r600_page_table_cleanup(struct drm_device *dev, struct drm_ati_pcigart_info *gart_info)\r\n{\r\nstruct drm_sg_mem *entry = dev->sg;\r\nint max_pages;\r\nint pages;\r\nint i;\r\nif (!entry)\r\nreturn;\r\nif (gart_info->bus_addr) {\r\nmax_pages = (gart_info->table_size / sizeof(u64));\r\npages = (entry->pages <= max_pages)\r\n? entry->pages : max_pages;\r\nfor (i = 0; i < pages; i++) {\r\nif (!entry->busaddr[i])\r\nbreak;\r\npci_unmap_page(dev->pdev, entry->busaddr[i],\r\nPAGE_SIZE, PCI_DMA_BIDIRECTIONAL);\r\n}\r\nif (gart_info->gart_table_location == DRM_ATI_GART_MAIN)\r\ngart_info->bus_addr = 0;\r\n}\r\n}\r\nint r600_page_table_init(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nstruct drm_ati_pcigart_info *gart_info = &dev_priv->gart_info;\r\nstruct drm_local_map *map = &gart_info->mapping;\r\nstruct drm_sg_mem *entry = dev->sg;\r\nint ret = 0;\r\nint i, j;\r\nint pages;\r\nu64 page_base;\r\ndma_addr_t entry_addr;\r\nint max_ati_pages, max_real_pages, gart_idx;\r\nmax_ati_pages = (gart_info->table_size / sizeof(u64));\r\nmax_real_pages = max_ati_pages / (PAGE_SIZE / ATI_PCIGART_PAGE_SIZE);\r\npages = (entry->pages <= max_real_pages) ?\r\nentry->pages : max_real_pages;\r\nmemset_io((void __iomem *)map->handle, 0, max_ati_pages * sizeof(u64));\r\ngart_idx = 0;\r\nfor (i = 0; i < pages; i++) {\r\nentry->busaddr[i] = pci_map_page(dev->pdev,\r\nentry->pagelist[i], 0,\r\nPAGE_SIZE,\r\nPCI_DMA_BIDIRECTIONAL);\r\nif (pci_dma_mapping_error(dev->pdev, entry->busaddr[i])) {\r\nDRM_ERROR("unable to map PCIGART pages!\n");\r\nr600_page_table_cleanup(dev, gart_info);\r\ngoto done;\r\n}\r\nentry_addr = entry->busaddr[i];\r\nfor (j = 0; j < (PAGE_SIZE / ATI_PCIGART_PAGE_SIZE); j++) {\r\npage_base = (u64) entry_addr & ATI_PCIGART_PAGE_MASK;\r\npage_base |= R600_PTE_VALID | R600_PTE_SYSTEM | R600_PTE_SNOOPED;\r\npage_base |= R600_PTE_READABLE | R600_PTE_WRITEABLE;\r\nDRM_WRITE64(map, gart_idx * sizeof(u64), page_base);\r\ngart_idx++;\r\nif ((i % 128) == 0)\r\nDRM_DEBUG("page entry %d: 0x%016llx\n",\r\ni, (unsigned long long)page_base);\r\nentry_addr += ATI_PCIGART_PAGE_SIZE;\r\n}\r\n}\r\nret = 1;\r\ndone:\r\nreturn ret;\r\n}\r\nstatic void r600_vm_flush_gart_range(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nu32 resp, countdown = 1000;\r\nRADEON_WRITE(R600_VM_CONTEXT0_INVALIDATION_LOW_ADDR, dev_priv->gart_vm_start >> 12);\r\nRADEON_WRITE(R600_VM_CONTEXT0_INVALIDATION_HIGH_ADDR, (dev_priv->gart_vm_start + dev_priv->gart_size - 1) >> 12);\r\nRADEON_WRITE(R600_VM_CONTEXT0_REQUEST_RESPONSE, 2);\r\ndo {\r\nresp = RADEON_READ(R600_VM_CONTEXT0_REQUEST_RESPONSE);\r\ncountdown--;\r\nDRM_UDELAY(1);\r\n} while (((resp & 0xf0) == 0) && countdown);\r\n}\r\nstatic void r600_vm_init(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nu32 vm_c0, i;\r\nu32 mc_rd_a;\r\nu32 vm_l2_cntl, vm_l2_cntl3;\r\nRADEON_WRITE(R600_MC_VM_SYSTEM_APERTURE_LOW_ADDR, dev_priv->gart_vm_start >> 12);\r\nRADEON_WRITE(R600_MC_VM_SYSTEM_APERTURE_HIGH_ADDR, (dev_priv->gart_vm_start + dev_priv->gart_size - 1) >> 12);\r\nRADEON_WRITE(R600_MC_VM_SYSTEM_APERTURE_DEFAULT_ADDR, 0);\r\nmc_rd_a = R600_MCD_L1_TLB | R600_MCD_L1_FRAG_PROC | R600_MCD_SYSTEM_ACCESS_MODE_IN_SYS |\r\nR600_MCD_SYSTEM_APERTURE_UNMAPPED_ACCESS_PASS_THRU | R600_MCD_EFFECTIVE_L1_TLB_SIZE(5) |\r\nR600_MCD_EFFECTIVE_L1_QUEUE_SIZE(5) | R600_MCD_WAIT_L2_QUERY;\r\nRADEON_WRITE(R600_MCD_RD_A_CNTL, mc_rd_a);\r\nRADEON_WRITE(R600_MCD_RD_B_CNTL, mc_rd_a);\r\nRADEON_WRITE(R600_MCD_WR_A_CNTL, mc_rd_a);\r\nRADEON_WRITE(R600_MCD_WR_B_CNTL, mc_rd_a);\r\nRADEON_WRITE(R600_MCD_RD_GFX_CNTL, mc_rd_a);\r\nRADEON_WRITE(R600_MCD_WR_GFX_CNTL, mc_rd_a);\r\nRADEON_WRITE(R600_MCD_RD_SYS_CNTL, mc_rd_a);\r\nRADEON_WRITE(R600_MCD_WR_SYS_CNTL, mc_rd_a);\r\nRADEON_WRITE(R600_MCD_RD_HDP_CNTL, mc_rd_a | R600_MCD_L1_STRICT_ORDERING);\r\nRADEON_WRITE(R600_MCD_WR_HDP_CNTL, mc_rd_a );\r\nRADEON_WRITE(R600_MCD_RD_PDMA_CNTL, mc_rd_a);\r\nRADEON_WRITE(R600_MCD_WR_PDMA_CNTL, mc_rd_a);\r\nRADEON_WRITE(R600_MCD_RD_SEM_CNTL, mc_rd_a | R600_MCD_SEMAPHORE_MODE);\r\nRADEON_WRITE(R600_MCD_WR_SEM_CNTL, mc_rd_a);\r\nvm_l2_cntl = R600_VM_L2_CACHE_EN | R600_VM_L2_FRAG_PROC | R600_VM_ENABLE_PTE_CACHE_LRU_W;\r\nvm_l2_cntl |= R600_VM_L2_CNTL_QUEUE_SIZE(7);\r\nRADEON_WRITE(R600_VM_L2_CNTL, vm_l2_cntl);\r\nRADEON_WRITE(R600_VM_L2_CNTL2, 0);\r\nvm_l2_cntl3 = (R600_VM_L2_CNTL3_BANK_SELECT_0(0) |\r\nR600_VM_L2_CNTL3_BANK_SELECT_1(1) |\r\nR600_VM_L2_CNTL3_CACHE_UPDATE_MODE(2));\r\nRADEON_WRITE(R600_VM_L2_CNTL3, vm_l2_cntl3);\r\nvm_c0 = R600_VM_ENABLE_CONTEXT | R600_VM_PAGE_TABLE_DEPTH_FLAT;\r\nRADEON_WRITE(R600_VM_CONTEXT0_CNTL, vm_c0);\r\nvm_c0 &= ~R600_VM_ENABLE_CONTEXT;\r\nfor (i = 1; i < 8; i++)\r\nRADEON_WRITE(R600_VM_CONTEXT0_CNTL + (i * 4), vm_c0);\r\nRADEON_WRITE(R600_VM_CONTEXT0_PAGE_TABLE_BASE_ADDR, dev_priv->gart_info.bus_addr >> 12);\r\nRADEON_WRITE(R600_VM_CONTEXT0_PAGE_TABLE_START_ADDR, dev_priv->gart_vm_start >> 12);\r\nRADEON_WRITE(R600_VM_CONTEXT0_PAGE_TABLE_END_ADDR, (dev_priv->gart_vm_start + dev_priv->gart_size - 1) >> 12);\r\nr600_vm_flush_gart_range(dev);\r\n}\r\nstatic int r600_cp_init_microcode(drm_radeon_private_t *dev_priv)\r\n{\r\nstruct platform_device *pdev;\r\nconst char *chip_name;\r\nsize_t pfp_req_size, me_req_size;\r\nchar fw_name[30];\r\nint err;\r\npdev = platform_device_register_simple("r600_cp", 0, NULL, 0);\r\nerr = IS_ERR(pdev);\r\nif (err) {\r\nprintk(KERN_ERR "r600_cp: Failed to register firmware\n");\r\nreturn -EINVAL;\r\n}\r\nswitch (dev_priv->flags & RADEON_FAMILY_MASK) {\r\ncase CHIP_R600: chip_name = "R600"; break;\r\ncase CHIP_RV610: chip_name = "RV610"; break;\r\ncase CHIP_RV630: chip_name = "RV630"; break;\r\ncase CHIP_RV620: chip_name = "RV620"; break;\r\ncase CHIP_RV635: chip_name = "RV635"; break;\r\ncase CHIP_RV670: chip_name = "RV670"; break;\r\ncase CHIP_RS780:\r\ncase CHIP_RS880: chip_name = "RS780"; break;\r\ncase CHIP_RV770: chip_name = "RV770"; break;\r\ncase CHIP_RV730:\r\ncase CHIP_RV740: chip_name = "RV730"; break;\r\ncase CHIP_RV710: chip_name = "RV710"; break;\r\ndefault: BUG();\r\n}\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RV770) {\r\npfp_req_size = R700_PFP_UCODE_SIZE * 4;\r\nme_req_size = R700_PM4_UCODE_SIZE * 4;\r\n} else {\r\npfp_req_size = PFP_UCODE_SIZE * 4;\r\nme_req_size = PM4_UCODE_SIZE * 12;\r\n}\r\nDRM_INFO("Loading %s CP Microcode\n", chip_name);\r\nsnprintf(fw_name, sizeof(fw_name), "radeon/%s_pfp.bin", chip_name);\r\nerr = request_firmware(&dev_priv->pfp_fw, fw_name, &pdev->dev);\r\nif (err)\r\ngoto out;\r\nif (dev_priv->pfp_fw->size != pfp_req_size) {\r\nprintk(KERN_ERR\r\n"r600_cp: Bogus length %zu in firmware \"%s\"\n",\r\ndev_priv->pfp_fw->size, fw_name);\r\nerr = -EINVAL;\r\ngoto out;\r\n}\r\nsnprintf(fw_name, sizeof(fw_name), "radeon/%s_me.bin", chip_name);\r\nerr = request_firmware(&dev_priv->me_fw, fw_name, &pdev->dev);\r\nif (err)\r\ngoto out;\r\nif (dev_priv->me_fw->size != me_req_size) {\r\nprintk(KERN_ERR\r\n"r600_cp: Bogus length %zu in firmware \"%s\"\n",\r\ndev_priv->me_fw->size, fw_name);\r\nerr = -EINVAL;\r\n}\r\nout:\r\nplatform_device_unregister(pdev);\r\nif (err) {\r\nif (err != -EINVAL)\r\nprintk(KERN_ERR\r\n"r600_cp: Failed to load firmware \"%s\"\n",\r\nfw_name);\r\nrelease_firmware(dev_priv->pfp_fw);\r\ndev_priv->pfp_fw = NULL;\r\nrelease_firmware(dev_priv->me_fw);\r\ndev_priv->me_fw = NULL;\r\n}\r\nreturn err;\r\n}\r\nstatic void r600_cp_load_microcode(drm_radeon_private_t *dev_priv)\r\n{\r\nconst __be32 *fw_data;\r\nint i;\r\nif (!dev_priv->me_fw || !dev_priv->pfp_fw)\r\nreturn;\r\nr600_do_cp_stop(dev_priv);\r\nRADEON_WRITE(R600_CP_RB_CNTL,\r\n#ifdef __BIG_ENDIAN\r\nR600_BUF_SWAP_32BIT |\r\n#endif\r\nR600_RB_NO_UPDATE |\r\nR600_RB_BLKSZ(15) |\r\nR600_RB_BUFSZ(3));\r\nRADEON_WRITE(R600_GRBM_SOFT_RESET, R600_SOFT_RESET_CP);\r\nRADEON_READ(R600_GRBM_SOFT_RESET);\r\nmdelay(15);\r\nRADEON_WRITE(R600_GRBM_SOFT_RESET, 0);\r\nfw_data = (const __be32 *)dev_priv->me_fw->data;\r\nRADEON_WRITE(R600_CP_ME_RAM_WADDR, 0);\r\nfor (i = 0; i < PM4_UCODE_SIZE * 3; i++)\r\nRADEON_WRITE(R600_CP_ME_RAM_DATA,\r\nbe32_to_cpup(fw_data++));\r\nfw_data = (const __be32 *)dev_priv->pfp_fw->data;\r\nRADEON_WRITE(R600_CP_PFP_UCODE_ADDR, 0);\r\nfor (i = 0; i < PFP_UCODE_SIZE; i++)\r\nRADEON_WRITE(R600_CP_PFP_UCODE_DATA,\r\nbe32_to_cpup(fw_data++));\r\nRADEON_WRITE(R600_CP_PFP_UCODE_ADDR, 0);\r\nRADEON_WRITE(R600_CP_ME_RAM_WADDR, 0);\r\nRADEON_WRITE(R600_CP_ME_RAM_RADDR, 0);\r\n}\r\nstatic void r700_vm_init(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nu32 vm_c0, i;\r\nu32 mc_vm_md_l1;\r\nu32 vm_l2_cntl, vm_l2_cntl3;\r\nRADEON_WRITE(R700_MC_VM_SYSTEM_APERTURE_LOW_ADDR, dev_priv->gart_vm_start >> 12);\r\nRADEON_WRITE(R700_MC_VM_SYSTEM_APERTURE_HIGH_ADDR, (dev_priv->gart_vm_start + dev_priv->gart_size - 1) >> 12);\r\nRADEON_WRITE(R700_MC_VM_SYSTEM_APERTURE_DEFAULT_ADDR, 0);\r\nmc_vm_md_l1 = R700_ENABLE_L1_TLB |\r\nR700_ENABLE_L1_FRAGMENT_PROCESSING |\r\nR700_SYSTEM_ACCESS_MODE_IN_SYS |\r\nR700_SYSTEM_APERTURE_UNMAPPED_ACCESS_PASS_THRU |\r\nR700_EFFECTIVE_L1_TLB_SIZE(5) |\r\nR700_EFFECTIVE_L1_QUEUE_SIZE(5);\r\nRADEON_WRITE(R700_MC_VM_MD_L1_TLB0_CNTL, mc_vm_md_l1);\r\nRADEON_WRITE(R700_MC_VM_MD_L1_TLB1_CNTL, mc_vm_md_l1);\r\nRADEON_WRITE(R700_MC_VM_MD_L1_TLB2_CNTL, mc_vm_md_l1);\r\nRADEON_WRITE(R700_MC_VM_MB_L1_TLB0_CNTL, mc_vm_md_l1);\r\nRADEON_WRITE(R700_MC_VM_MB_L1_TLB1_CNTL, mc_vm_md_l1);\r\nRADEON_WRITE(R700_MC_VM_MB_L1_TLB2_CNTL, mc_vm_md_l1);\r\nRADEON_WRITE(R700_MC_VM_MB_L1_TLB3_CNTL, mc_vm_md_l1);\r\nvm_l2_cntl = R600_VM_L2_CACHE_EN | R600_VM_L2_FRAG_PROC | R600_VM_ENABLE_PTE_CACHE_LRU_W;\r\nvm_l2_cntl |= R700_VM_L2_CNTL_QUEUE_SIZE(7);\r\nRADEON_WRITE(R600_VM_L2_CNTL, vm_l2_cntl);\r\nRADEON_WRITE(R600_VM_L2_CNTL2, 0);\r\nvm_l2_cntl3 = R700_VM_L2_CNTL3_BANK_SELECT(0) | R700_VM_L2_CNTL3_CACHE_UPDATE_MODE(2);\r\nRADEON_WRITE(R600_VM_L2_CNTL3, vm_l2_cntl3);\r\nvm_c0 = R600_VM_ENABLE_CONTEXT | R600_VM_PAGE_TABLE_DEPTH_FLAT;\r\nRADEON_WRITE(R600_VM_CONTEXT0_CNTL, vm_c0);\r\nvm_c0 &= ~R600_VM_ENABLE_CONTEXT;\r\nfor (i = 1; i < 8; i++)\r\nRADEON_WRITE(R600_VM_CONTEXT0_CNTL + (i * 4), vm_c0);\r\nRADEON_WRITE(R700_VM_CONTEXT0_PAGE_TABLE_BASE_ADDR, dev_priv->gart_info.bus_addr >> 12);\r\nRADEON_WRITE(R700_VM_CONTEXT0_PAGE_TABLE_START_ADDR, dev_priv->gart_vm_start >> 12);\r\nRADEON_WRITE(R700_VM_CONTEXT0_PAGE_TABLE_END_ADDR, (dev_priv->gart_vm_start + dev_priv->gart_size - 1) >> 12);\r\nr600_vm_flush_gart_range(dev);\r\n}\r\nstatic void r700_cp_load_microcode(drm_radeon_private_t *dev_priv)\r\n{\r\nconst __be32 *fw_data;\r\nint i;\r\nif (!dev_priv->me_fw || !dev_priv->pfp_fw)\r\nreturn;\r\nr600_do_cp_stop(dev_priv);\r\nRADEON_WRITE(R600_CP_RB_CNTL,\r\n#ifdef __BIG_ENDIAN\r\nR600_BUF_SWAP_32BIT |\r\n#endif\r\nR600_RB_NO_UPDATE |\r\nR600_RB_BLKSZ(15) |\r\nR600_RB_BUFSZ(3));\r\nRADEON_WRITE(R600_GRBM_SOFT_RESET, R600_SOFT_RESET_CP);\r\nRADEON_READ(R600_GRBM_SOFT_RESET);\r\nmdelay(15);\r\nRADEON_WRITE(R600_GRBM_SOFT_RESET, 0);\r\nfw_data = (const __be32 *)dev_priv->pfp_fw->data;\r\nRADEON_WRITE(R600_CP_PFP_UCODE_ADDR, 0);\r\nfor (i = 0; i < R700_PFP_UCODE_SIZE; i++)\r\nRADEON_WRITE(R600_CP_PFP_UCODE_DATA, be32_to_cpup(fw_data++));\r\nRADEON_WRITE(R600_CP_PFP_UCODE_ADDR, 0);\r\nfw_data = (const __be32 *)dev_priv->me_fw->data;\r\nRADEON_WRITE(R600_CP_ME_RAM_WADDR, 0);\r\nfor (i = 0; i < R700_PM4_UCODE_SIZE; i++)\r\nRADEON_WRITE(R600_CP_ME_RAM_DATA, be32_to_cpup(fw_data++));\r\nRADEON_WRITE(R600_CP_ME_RAM_WADDR, 0);\r\nRADEON_WRITE(R600_CP_PFP_UCODE_ADDR, 0);\r\nRADEON_WRITE(R600_CP_ME_RAM_WADDR, 0);\r\nRADEON_WRITE(R600_CP_ME_RAM_RADDR, 0);\r\n}\r\nstatic void r600_test_writeback(drm_radeon_private_t *dev_priv)\r\n{\r\nu32 tmp;\r\ndev_priv->writeback_works = 0;\r\nradeon_write_ring_rptr(dev_priv, R600_SCRATCHOFF(1), 0);\r\nRADEON_WRITE(R600_SCRATCH_REG1, 0xdeadbeef);\r\nfor (tmp = 0; tmp < dev_priv->usec_timeout; tmp++) {\r\nu32 val;\r\nval = radeon_read_ring_rptr(dev_priv, R600_SCRATCHOFF(1));\r\nif (val == 0xdeadbeef)\r\nbreak;\r\nDRM_UDELAY(1);\r\n}\r\nif (tmp < dev_priv->usec_timeout) {\r\ndev_priv->writeback_works = 1;\r\nDRM_INFO("writeback test succeeded in %d usecs\n", tmp);\r\n} else {\r\ndev_priv->writeback_works = 0;\r\nDRM_INFO("writeback test failed\n");\r\n}\r\nif (radeon_no_wb == 1) {\r\ndev_priv->writeback_works = 0;\r\nDRM_INFO("writeback forced off\n");\r\n}\r\nif (!dev_priv->writeback_works) {\r\nRADEON_WRITE(R600_CP_RB_CNTL,\r\n#ifdef __BIG_ENDIAN\r\nR600_BUF_SWAP_32BIT |\r\n#endif\r\nRADEON_READ(R600_CP_RB_CNTL) |\r\nR600_RB_NO_UPDATE);\r\nRADEON_WRITE(R600_SCRATCH_UMSK, 0);\r\n}\r\n}\r\nint r600_do_engine_reset(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nu32 cp_ptr, cp_me_cntl, cp_rb_cntl;\r\nDRM_INFO("Resetting GPU\n");\r\ncp_ptr = RADEON_READ(R600_CP_RB_WPTR);\r\ncp_me_cntl = RADEON_READ(R600_CP_ME_CNTL);\r\nRADEON_WRITE(R600_CP_ME_CNTL, R600_CP_ME_HALT);\r\nRADEON_WRITE(R600_GRBM_SOFT_RESET, 0x7fff);\r\nRADEON_READ(R600_GRBM_SOFT_RESET);\r\nDRM_UDELAY(50);\r\nRADEON_WRITE(R600_GRBM_SOFT_RESET, 0);\r\nRADEON_READ(R600_GRBM_SOFT_RESET);\r\nRADEON_WRITE(R600_CP_RB_WPTR_DELAY, 0);\r\ncp_rb_cntl = RADEON_READ(R600_CP_RB_CNTL);\r\nRADEON_WRITE(R600_CP_RB_CNTL,\r\n#ifdef __BIG_ENDIAN\r\nR600_BUF_SWAP_32BIT |\r\n#endif\r\nR600_RB_RPTR_WR_ENA);\r\nRADEON_WRITE(R600_CP_RB_RPTR_WR, cp_ptr);\r\nRADEON_WRITE(R600_CP_RB_WPTR, cp_ptr);\r\nRADEON_WRITE(R600_CP_RB_CNTL, cp_rb_cntl);\r\nRADEON_WRITE(R600_CP_ME_CNTL, cp_me_cntl);\r\nr600_do_cp_reset(dev_priv);\r\ndev_priv->cp_running = 0;\r\nradeon_freelist_reset(dev);\r\nreturn 0;\r\n}\r\nstatic u32 r600_get_tile_pipe_to_backend_map(u32 num_tile_pipes,\r\nu32 num_backends,\r\nu32 backend_disable_mask)\r\n{\r\nu32 backend_map = 0;\r\nu32 enabled_backends_mask;\r\nu32 enabled_backends_count;\r\nu32 cur_pipe;\r\nu32 swizzle_pipe[R6XX_MAX_PIPES];\r\nu32 cur_backend;\r\nu32 i;\r\nif (num_tile_pipes > R6XX_MAX_PIPES)\r\nnum_tile_pipes = R6XX_MAX_PIPES;\r\nif (num_tile_pipes < 1)\r\nnum_tile_pipes = 1;\r\nif (num_backends > R6XX_MAX_BACKENDS)\r\nnum_backends = R6XX_MAX_BACKENDS;\r\nif (num_backends < 1)\r\nnum_backends = 1;\r\nenabled_backends_mask = 0;\r\nenabled_backends_count = 0;\r\nfor (i = 0; i < R6XX_MAX_BACKENDS; ++i) {\r\nif (((backend_disable_mask >> i) & 1) == 0) {\r\nenabled_backends_mask |= (1 << i);\r\n++enabled_backends_count;\r\n}\r\nif (enabled_backends_count == num_backends)\r\nbreak;\r\n}\r\nif (enabled_backends_count == 0) {\r\nenabled_backends_mask = 1;\r\nenabled_backends_count = 1;\r\n}\r\nif (enabled_backends_count != num_backends)\r\nnum_backends = enabled_backends_count;\r\nmemset((uint8_t *)&swizzle_pipe[0], 0, sizeof(u32) * R6XX_MAX_PIPES);\r\nswitch (num_tile_pipes) {\r\ncase 1:\r\nswizzle_pipe[0] = 0;\r\nbreak;\r\ncase 2:\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 1;\r\nbreak;\r\ncase 3:\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 1;\r\nswizzle_pipe[2] = 2;\r\nbreak;\r\ncase 4:\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 1;\r\nswizzle_pipe[2] = 2;\r\nswizzle_pipe[3] = 3;\r\nbreak;\r\ncase 5:\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 1;\r\nswizzle_pipe[2] = 2;\r\nswizzle_pipe[3] = 3;\r\nswizzle_pipe[4] = 4;\r\nbreak;\r\ncase 6:\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 2;\r\nswizzle_pipe[2] = 4;\r\nswizzle_pipe[3] = 5;\r\nswizzle_pipe[4] = 1;\r\nswizzle_pipe[5] = 3;\r\nbreak;\r\ncase 7:\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 2;\r\nswizzle_pipe[2] = 4;\r\nswizzle_pipe[3] = 6;\r\nswizzle_pipe[4] = 1;\r\nswizzle_pipe[5] = 3;\r\nswizzle_pipe[6] = 5;\r\nbreak;\r\ncase 8:\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 2;\r\nswizzle_pipe[2] = 4;\r\nswizzle_pipe[3] = 6;\r\nswizzle_pipe[4] = 1;\r\nswizzle_pipe[5] = 3;\r\nswizzle_pipe[6] = 5;\r\nswizzle_pipe[7] = 7;\r\nbreak;\r\n}\r\ncur_backend = 0;\r\nfor (cur_pipe = 0; cur_pipe < num_tile_pipes; ++cur_pipe) {\r\nwhile (((1 << cur_backend) & enabled_backends_mask) == 0)\r\ncur_backend = (cur_backend + 1) % R6XX_MAX_BACKENDS;\r\nbackend_map |= (u32)(((cur_backend & 3) << (swizzle_pipe[cur_pipe] * 2)));\r\ncur_backend = (cur_backend + 1) % R6XX_MAX_BACKENDS;\r\n}\r\nreturn backend_map;\r\n}\r\nstatic int r600_count_pipe_bits(uint32_t val)\r\n{\r\nreturn hweight32(val);\r\n}\r\nstatic void r600_gfx_init(struct drm_device *dev,\r\ndrm_radeon_private_t *dev_priv)\r\n{\r\nint i, j, num_qd_pipes;\r\nu32 sx_debug_1;\r\nu32 tc_cntl;\r\nu32 arb_pop;\r\nu32 num_gs_verts_per_thread;\r\nu32 vgt_gs_per_es;\r\nu32 gs_prim_buffer_depth = 0;\r\nu32 sq_ms_fifo_sizes;\r\nu32 sq_config;\r\nu32 sq_gpr_resource_mgmt_1 = 0;\r\nu32 sq_gpr_resource_mgmt_2 = 0;\r\nu32 sq_thread_resource_mgmt = 0;\r\nu32 sq_stack_resource_mgmt_1 = 0;\r\nu32 sq_stack_resource_mgmt_2 = 0;\r\nu32 hdp_host_path_cntl;\r\nu32 backend_map;\r\nu32 gb_tiling_config = 0;\r\nu32 cc_rb_backend_disable;\r\nu32 cc_gc_shader_pipe_config;\r\nu32 ramcfg;\r\nswitch (dev_priv->flags & RADEON_FAMILY_MASK) {\r\ncase CHIP_R600:\r\ndev_priv->r600_max_pipes = 4;\r\ndev_priv->r600_max_tile_pipes = 8;\r\ndev_priv->r600_max_simds = 4;\r\ndev_priv->r600_max_backends = 4;\r\ndev_priv->r600_max_gprs = 256;\r\ndev_priv->r600_max_threads = 192;\r\ndev_priv->r600_max_stack_entries = 256;\r\ndev_priv->r600_max_hw_contexts = 8;\r\ndev_priv->r600_max_gs_threads = 16;\r\ndev_priv->r600_sx_max_export_size = 128;\r\ndev_priv->r600_sx_max_export_pos_size = 16;\r\ndev_priv->r600_sx_max_export_smx_size = 128;\r\ndev_priv->r600_sq_num_cf_insts = 2;\r\nbreak;\r\ncase CHIP_RV630:\r\ncase CHIP_RV635:\r\ndev_priv->r600_max_pipes = 2;\r\ndev_priv->r600_max_tile_pipes = 2;\r\ndev_priv->r600_max_simds = 3;\r\ndev_priv->r600_max_backends = 1;\r\ndev_priv->r600_max_gprs = 128;\r\ndev_priv->r600_max_threads = 192;\r\ndev_priv->r600_max_stack_entries = 128;\r\ndev_priv->r600_max_hw_contexts = 8;\r\ndev_priv->r600_max_gs_threads = 4;\r\ndev_priv->r600_sx_max_export_size = 128;\r\ndev_priv->r600_sx_max_export_pos_size = 16;\r\ndev_priv->r600_sx_max_export_smx_size = 128;\r\ndev_priv->r600_sq_num_cf_insts = 2;\r\nbreak;\r\ncase CHIP_RV610:\r\ncase CHIP_RS780:\r\ncase CHIP_RS880:\r\ncase CHIP_RV620:\r\ndev_priv->r600_max_pipes = 1;\r\ndev_priv->r600_max_tile_pipes = 1;\r\ndev_priv->r600_max_simds = 2;\r\ndev_priv->r600_max_backends = 1;\r\ndev_priv->r600_max_gprs = 128;\r\ndev_priv->r600_max_threads = 192;\r\ndev_priv->r600_max_stack_entries = 128;\r\ndev_priv->r600_max_hw_contexts = 4;\r\ndev_priv->r600_max_gs_threads = 4;\r\ndev_priv->r600_sx_max_export_size = 128;\r\ndev_priv->r600_sx_max_export_pos_size = 16;\r\ndev_priv->r600_sx_max_export_smx_size = 128;\r\ndev_priv->r600_sq_num_cf_insts = 1;\r\nbreak;\r\ncase CHIP_RV670:\r\ndev_priv->r600_max_pipes = 4;\r\ndev_priv->r600_max_tile_pipes = 4;\r\ndev_priv->r600_max_simds = 4;\r\ndev_priv->r600_max_backends = 4;\r\ndev_priv->r600_max_gprs = 192;\r\ndev_priv->r600_max_threads = 192;\r\ndev_priv->r600_max_stack_entries = 256;\r\ndev_priv->r600_max_hw_contexts = 8;\r\ndev_priv->r600_max_gs_threads = 16;\r\ndev_priv->r600_sx_max_export_size = 128;\r\ndev_priv->r600_sx_max_export_pos_size = 16;\r\ndev_priv->r600_sx_max_export_smx_size = 128;\r\ndev_priv->r600_sq_num_cf_insts = 2;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nj = 0;\r\nfor (i = 0; i < 32; i++) {\r\nRADEON_WRITE((0x2c14 + j), 0x00000000);\r\nRADEON_WRITE((0x2c18 + j), 0x00000000);\r\nRADEON_WRITE((0x2c1c + j), 0x00000000);\r\nRADEON_WRITE((0x2c20 + j), 0x00000000);\r\nRADEON_WRITE((0x2c24 + j), 0x00000000);\r\nj += 0x18;\r\n}\r\nRADEON_WRITE(R600_GRBM_CNTL, R600_GRBM_READ_TIMEOUT(0xff));\r\nramcfg = RADEON_READ(R600_RAMCFG);\r\nswitch (dev_priv->r600_max_tile_pipes) {\r\ncase 1:\r\ngb_tiling_config |= R600_PIPE_TILING(0);\r\nbreak;\r\ncase 2:\r\ngb_tiling_config |= R600_PIPE_TILING(1);\r\nbreak;\r\ncase 4:\r\ngb_tiling_config |= R600_PIPE_TILING(2);\r\nbreak;\r\ncase 8:\r\ngb_tiling_config |= R600_PIPE_TILING(3);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ngb_tiling_config |= R600_BANK_TILING((ramcfg >> R600_NOOFBANK_SHIFT) & R600_NOOFBANK_MASK);\r\ngb_tiling_config |= R600_GROUP_SIZE(0);\r\nif (((ramcfg >> R600_NOOFROWS_SHIFT) & R600_NOOFROWS_MASK) > 3) {\r\ngb_tiling_config |= R600_ROW_TILING(3);\r\ngb_tiling_config |= R600_SAMPLE_SPLIT(3);\r\n} else {\r\ngb_tiling_config |=\r\nR600_ROW_TILING(((ramcfg >> R600_NOOFROWS_SHIFT) & R600_NOOFROWS_MASK));\r\ngb_tiling_config |=\r\nR600_SAMPLE_SPLIT(((ramcfg >> R600_NOOFROWS_SHIFT) & R600_NOOFROWS_MASK));\r\n}\r\ngb_tiling_config |= R600_BANK_SWAPS(1);\r\ncc_rb_backend_disable = RADEON_READ(R600_CC_RB_BACKEND_DISABLE) & 0x00ff0000;\r\ncc_rb_backend_disable |=\r\nR600_BACKEND_DISABLE((R6XX_MAX_BACKENDS_MASK << dev_priv->r600_max_backends) & R6XX_MAX_BACKENDS_MASK);\r\ncc_gc_shader_pipe_config = RADEON_READ(R600_CC_GC_SHADER_PIPE_CONFIG) & 0xffffff00;\r\ncc_gc_shader_pipe_config |=\r\nR600_INACTIVE_QD_PIPES((R6XX_MAX_PIPES_MASK << dev_priv->r600_max_pipes) & R6XX_MAX_PIPES_MASK);\r\ncc_gc_shader_pipe_config |=\r\nR600_INACTIVE_SIMDS((R6XX_MAX_SIMDS_MASK << dev_priv->r600_max_simds) & R6XX_MAX_SIMDS_MASK);\r\nbackend_map = r600_get_tile_pipe_to_backend_map(dev_priv->r600_max_tile_pipes,\r\n(R6XX_MAX_BACKENDS -\r\nr600_count_pipe_bits((cc_rb_backend_disable &\r\nR6XX_MAX_BACKENDS_MASK) >> 16)),\r\n(cc_rb_backend_disable >> 16));\r\ngb_tiling_config |= R600_BACKEND_MAP(backend_map);\r\nRADEON_WRITE(R600_GB_TILING_CONFIG, gb_tiling_config);\r\nRADEON_WRITE(R600_DCP_TILING_CONFIG, (gb_tiling_config & 0xffff));\r\nRADEON_WRITE(R600_HDP_TILING_CONFIG, (gb_tiling_config & 0xffff));\r\nif (gb_tiling_config & 0xc0) {\r\ndev_priv->r600_group_size = 512;\r\n} else {\r\ndev_priv->r600_group_size = 256;\r\n}\r\ndev_priv->r600_npipes = 1 << ((gb_tiling_config >> 1) & 0x7);\r\nif (gb_tiling_config & 0x30) {\r\ndev_priv->r600_nbanks = 8;\r\n} else {\r\ndev_priv->r600_nbanks = 4;\r\n}\r\nRADEON_WRITE(R600_CC_RB_BACKEND_DISABLE, cc_rb_backend_disable);\r\nRADEON_WRITE(R600_CC_GC_SHADER_PIPE_CONFIG, cc_gc_shader_pipe_config);\r\nRADEON_WRITE(R600_GC_USER_SHADER_PIPE_CONFIG, cc_gc_shader_pipe_config);\r\nnum_qd_pipes =\r\nR6XX_MAX_PIPES - r600_count_pipe_bits((cc_gc_shader_pipe_config & R600_INACTIVE_QD_PIPES_MASK) >> 8);\r\nRADEON_WRITE(R600_VGT_OUT_DEALLOC_CNTL, (num_qd_pipes * 4) & R600_DEALLOC_DIST_MASK);\r\nRADEON_WRITE(R600_VGT_VERTEX_REUSE_BLOCK_CNTL, ((num_qd_pipes * 4) - 2) & R600_VTX_REUSE_DEPTH_MASK);\r\nRADEON_WRITE(R600_CP_QUEUE_THRESHOLDS, (R600_ROQ_IB1_START(0x16) |\r\nR600_ROQ_IB2_START(0x2b)));\r\nRADEON_WRITE(R600_CP_MEQ_THRESHOLDS, (R600_MEQ_END(0x40) |\r\nR600_ROQ_END(0x40)));\r\nRADEON_WRITE(R600_TA_CNTL_AUX, (R600_DISABLE_CUBE_ANISO |\r\nR600_SYNC_GRADIENT |\r\nR600_SYNC_WALKER |\r\nR600_SYNC_ALIGNER));\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV670)\r\nRADEON_WRITE(R600_ARB_GDEC_RD_CNTL, 0x00000021);\r\nsx_debug_1 = RADEON_READ(R600_SX_DEBUG_1);\r\nsx_debug_1 |= R600_SMX_EVENT_RELEASE;\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) > CHIP_R600))\r\nsx_debug_1 |= R600_ENABLE_NEW_SMX_ADDRESS;\r\nRADEON_WRITE(R600_SX_DEBUG_1, sx_debug_1);\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R600) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV630) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV610) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV620) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS780) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS880))\r\nRADEON_WRITE(R600_DB_DEBUG, R600_PREZ_MUST_WAIT_FOR_POSTZ_DONE);\r\nelse\r\nRADEON_WRITE(R600_DB_DEBUG, 0);\r\nRADEON_WRITE(R600_DB_WATERMARKS, (R600_DEPTH_FREE(4) |\r\nR600_DEPTH_FLUSH(16) |\r\nR600_DEPTH_PENDING_FREE(4) |\r\nR600_DEPTH_CACHELINE_FREE(16)));\r\nRADEON_WRITE(R600_PA_SC_MULTI_CHIP_CNTL, 0);\r\nRADEON_WRITE(R600_VGT_NUM_INSTANCES, 0);\r\nRADEON_WRITE(R600_SPI_CONFIG_CNTL, R600_GPR_WRITE_PRIORITY(0));\r\nRADEON_WRITE(R600_SPI_CONFIG_CNTL_1, R600_VTX_DONE_DELAY(0));\r\nsq_ms_fifo_sizes = RADEON_READ(R600_SQ_MS_FIFO_SIZES);\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV610) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV620) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS780) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS880)) {\r\nsq_ms_fifo_sizes = (R600_CACHE_FIFO_SIZE(0xa) |\r\nR600_FETCH_FIFO_HIWATER(0xa) |\r\nR600_DONE_FIFO_HIWATER(0xe0) |\r\nR600_ALU_UPDATE_FIFO_HIWATER(0x8));\r\n} else if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R600) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV630)) {\r\nsq_ms_fifo_sizes &= ~R600_DONE_FIFO_HIWATER(0xff);\r\nsq_ms_fifo_sizes |= R600_DONE_FIFO_HIWATER(0x4);\r\n}\r\nRADEON_WRITE(R600_SQ_MS_FIFO_SIZES, sq_ms_fifo_sizes);\r\nsq_config = RADEON_READ(R600_SQ_CONFIG);\r\nsq_config &= ~(R600_PS_PRIO(3) |\r\nR600_VS_PRIO(3) |\r\nR600_GS_PRIO(3) |\r\nR600_ES_PRIO(3));\r\nsq_config |= (R600_DX9_CONSTS |\r\nR600_VC_ENABLE |\r\nR600_PS_PRIO(0) |\r\nR600_VS_PRIO(1) |\r\nR600_GS_PRIO(2) |\r\nR600_ES_PRIO(3));\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R600) {\r\nsq_gpr_resource_mgmt_1 = (R600_NUM_PS_GPRS(124) |\r\nR600_NUM_VS_GPRS(124) |\r\nR600_NUM_CLAUSE_TEMP_GPRS(4));\r\nsq_gpr_resource_mgmt_2 = (R600_NUM_GS_GPRS(0) |\r\nR600_NUM_ES_GPRS(0));\r\nsq_thread_resource_mgmt = (R600_NUM_PS_THREADS(136) |\r\nR600_NUM_VS_THREADS(48) |\r\nR600_NUM_GS_THREADS(4) |\r\nR600_NUM_ES_THREADS(4));\r\nsq_stack_resource_mgmt_1 = (R600_NUM_PS_STACK_ENTRIES(128) |\r\nR600_NUM_VS_STACK_ENTRIES(128));\r\nsq_stack_resource_mgmt_2 = (R600_NUM_GS_STACK_ENTRIES(0) |\r\nR600_NUM_ES_STACK_ENTRIES(0));\r\n} else if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV610) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV620) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS780) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS880)) {\r\nsq_config &= ~R600_VC_ENABLE;\r\nsq_gpr_resource_mgmt_1 = (R600_NUM_PS_GPRS(44) |\r\nR600_NUM_VS_GPRS(44) |\r\nR600_NUM_CLAUSE_TEMP_GPRS(2));\r\nsq_gpr_resource_mgmt_2 = (R600_NUM_GS_GPRS(17) |\r\nR600_NUM_ES_GPRS(17));\r\nsq_thread_resource_mgmt = (R600_NUM_PS_THREADS(79) |\r\nR600_NUM_VS_THREADS(78) |\r\nR600_NUM_GS_THREADS(4) |\r\nR600_NUM_ES_THREADS(31));\r\nsq_stack_resource_mgmt_1 = (R600_NUM_PS_STACK_ENTRIES(40) |\r\nR600_NUM_VS_STACK_ENTRIES(40));\r\nsq_stack_resource_mgmt_2 = (R600_NUM_GS_STACK_ENTRIES(32) |\r\nR600_NUM_ES_STACK_ENTRIES(16));\r\n} else if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV630) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV635)) {\r\nsq_gpr_resource_mgmt_1 = (R600_NUM_PS_GPRS(44) |\r\nR600_NUM_VS_GPRS(44) |\r\nR600_NUM_CLAUSE_TEMP_GPRS(2));\r\nsq_gpr_resource_mgmt_2 = (R600_NUM_GS_GPRS(18) |\r\nR600_NUM_ES_GPRS(18));\r\nsq_thread_resource_mgmt = (R600_NUM_PS_THREADS(79) |\r\nR600_NUM_VS_THREADS(78) |\r\nR600_NUM_GS_THREADS(4) |\r\nR600_NUM_ES_THREADS(31));\r\nsq_stack_resource_mgmt_1 = (R600_NUM_PS_STACK_ENTRIES(40) |\r\nR600_NUM_VS_STACK_ENTRIES(40));\r\nsq_stack_resource_mgmt_2 = (R600_NUM_GS_STACK_ENTRIES(32) |\r\nR600_NUM_ES_STACK_ENTRIES(16));\r\n} else if ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV670) {\r\nsq_gpr_resource_mgmt_1 = (R600_NUM_PS_GPRS(44) |\r\nR600_NUM_VS_GPRS(44) |\r\nR600_NUM_CLAUSE_TEMP_GPRS(2));\r\nsq_gpr_resource_mgmt_2 = (R600_NUM_GS_GPRS(17) |\r\nR600_NUM_ES_GPRS(17));\r\nsq_thread_resource_mgmt = (R600_NUM_PS_THREADS(79) |\r\nR600_NUM_VS_THREADS(78) |\r\nR600_NUM_GS_THREADS(4) |\r\nR600_NUM_ES_THREADS(31));\r\nsq_stack_resource_mgmt_1 = (R600_NUM_PS_STACK_ENTRIES(64) |\r\nR600_NUM_VS_STACK_ENTRIES(64));\r\nsq_stack_resource_mgmt_2 = (R600_NUM_GS_STACK_ENTRIES(64) |\r\nR600_NUM_ES_STACK_ENTRIES(64));\r\n}\r\nRADEON_WRITE(R600_SQ_CONFIG, sq_config);\r\nRADEON_WRITE(R600_SQ_GPR_RESOURCE_MGMT_1, sq_gpr_resource_mgmt_1);\r\nRADEON_WRITE(R600_SQ_GPR_RESOURCE_MGMT_2, sq_gpr_resource_mgmt_2);\r\nRADEON_WRITE(R600_SQ_THREAD_RESOURCE_MGMT, sq_thread_resource_mgmt);\r\nRADEON_WRITE(R600_SQ_STACK_RESOURCE_MGMT_1, sq_stack_resource_mgmt_1);\r\nRADEON_WRITE(R600_SQ_STACK_RESOURCE_MGMT_2, sq_stack_resource_mgmt_2);\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV610) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV620) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS780) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS880))\r\nRADEON_WRITE(R600_VGT_CACHE_INVALIDATION, R600_CACHE_INVALIDATION(R600_TC_ONLY));\r\nelse\r\nRADEON_WRITE(R600_VGT_CACHE_INVALIDATION, R600_CACHE_INVALIDATION(R600_VC_AND_TC));\r\nRADEON_WRITE(R600_PA_SC_AA_SAMPLE_LOCS_2S, (R600_S0_X(0xc) |\r\nR600_S0_Y(0x4) |\r\nR600_S1_X(0x4) |\r\nR600_S1_Y(0xc)));\r\nRADEON_WRITE(R600_PA_SC_AA_SAMPLE_LOCS_4S, (R600_S0_X(0xe) |\r\nR600_S0_Y(0xe) |\r\nR600_S1_X(0x2) |\r\nR600_S1_Y(0x2) |\r\nR600_S2_X(0xa) |\r\nR600_S2_Y(0x6) |\r\nR600_S3_X(0x6) |\r\nR600_S3_Y(0xa)));\r\nRADEON_WRITE(R600_PA_SC_AA_SAMPLE_LOCS_8S_WD0, (R600_S0_X(0xe) |\r\nR600_S0_Y(0xb) |\r\nR600_S1_X(0x4) |\r\nR600_S1_Y(0xc) |\r\nR600_S2_X(0x1) |\r\nR600_S2_Y(0x6) |\r\nR600_S3_X(0xa) |\r\nR600_S3_Y(0xe)));\r\nRADEON_WRITE(R600_PA_SC_AA_SAMPLE_LOCS_8S_WD1, (R600_S4_X(0x6) |\r\nR600_S4_Y(0x1) |\r\nR600_S5_X(0x0) |\r\nR600_S5_Y(0x0) |\r\nR600_S6_X(0xb) |\r\nR600_S6_Y(0x4) |\r\nR600_S7_X(0x7) |\r\nR600_S7_Y(0x8)));\r\nswitch (dev_priv->flags & RADEON_FAMILY_MASK) {\r\ncase CHIP_R600:\r\ncase CHIP_RV630:\r\ncase CHIP_RV635:\r\ngs_prim_buffer_depth = 0;\r\nbreak;\r\ncase CHIP_RV610:\r\ncase CHIP_RS780:\r\ncase CHIP_RS880:\r\ncase CHIP_RV620:\r\ngs_prim_buffer_depth = 32;\r\nbreak;\r\ncase CHIP_RV670:\r\ngs_prim_buffer_depth = 128;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nnum_gs_verts_per_thread = dev_priv->r600_max_pipes * 16;\r\nvgt_gs_per_es = gs_prim_buffer_depth + num_gs_verts_per_thread;\r\nif (vgt_gs_per_es > 256)\r\nvgt_gs_per_es = 256;\r\nRADEON_WRITE(R600_VGT_ES_PER_GS, 128);\r\nRADEON_WRITE(R600_VGT_GS_PER_ES, vgt_gs_per_es);\r\nRADEON_WRITE(R600_VGT_GS_PER_VS, 2);\r\nRADEON_WRITE(R600_VGT_GS_VERTEX_REUSE, 16);\r\nRADEON_WRITE(R600_PA_SC_LINE_STIPPLE_STATE, 0);\r\nRADEON_WRITE(R600_VGT_STRMOUT_EN, 0);\r\nRADEON_WRITE(R600_SX_MISC, 0);\r\nRADEON_WRITE(R600_PA_SC_MODE_CNTL, 0);\r\nRADEON_WRITE(R600_PA_SC_AA_CONFIG, 0);\r\nRADEON_WRITE(R600_PA_SC_LINE_STIPPLE, 0);\r\nRADEON_WRITE(R600_SPI_INPUT_Z, 0);\r\nRADEON_WRITE(R600_SPI_PS_IN_CONTROL_0, R600_NUM_INTERP(2));\r\nRADEON_WRITE(R600_CB_COLOR7_FRAG, 0);\r\nRADEON_WRITE(R600_CB_COLOR0_BASE, 0);\r\nRADEON_WRITE(R600_CB_COLOR1_BASE, 0);\r\nRADEON_WRITE(R600_CB_COLOR2_BASE, 0);\r\nRADEON_WRITE(R600_CB_COLOR3_BASE, 0);\r\nRADEON_WRITE(R600_CB_COLOR4_BASE, 0);\r\nRADEON_WRITE(R600_CB_COLOR5_BASE, 0);\r\nRADEON_WRITE(R600_CB_COLOR6_BASE, 0);\r\nRADEON_WRITE(R600_CB_COLOR7_BASE, 0);\r\nswitch (dev_priv->flags & RADEON_FAMILY_MASK) {\r\ncase CHIP_RV610:\r\ncase CHIP_RS780:\r\ncase CHIP_RS880:\r\ncase CHIP_RV620:\r\ntc_cntl = R600_TC_L2_SIZE(8);\r\nbreak;\r\ncase CHIP_RV630:\r\ncase CHIP_RV635:\r\ntc_cntl = R600_TC_L2_SIZE(4);\r\nbreak;\r\ncase CHIP_R600:\r\ntc_cntl = R600_TC_L2_SIZE(0) | R600_L2_DISABLE_LATE_HIT;\r\nbreak;\r\ndefault:\r\ntc_cntl = R600_TC_L2_SIZE(0);\r\nbreak;\r\n}\r\nRADEON_WRITE(R600_TC_CNTL, tc_cntl);\r\nhdp_host_path_cntl = RADEON_READ(R600_HDP_HOST_PATH_CNTL);\r\nRADEON_WRITE(R600_HDP_HOST_PATH_CNTL, hdp_host_path_cntl);\r\narb_pop = RADEON_READ(R600_ARB_POP);\r\narb_pop |= R600_ENABLE_TC128;\r\nRADEON_WRITE(R600_ARB_POP, arb_pop);\r\nRADEON_WRITE(R600_PA_SC_MULTI_CHIP_CNTL, 0);\r\nRADEON_WRITE(R600_PA_CL_ENHANCE, (R600_CLIP_VTX_REORDER_ENA |\r\nR600_NUM_CLIP_SEQ(3)));\r\nRADEON_WRITE(R600_PA_SC_ENHANCE, R600_FORCE_EOV_MAX_CLK_CNT(4095));\r\n}\r\nstatic u32 r700_get_tile_pipe_to_backend_map(drm_radeon_private_t *dev_priv,\r\nu32 num_tile_pipes,\r\nu32 num_backends,\r\nu32 backend_disable_mask)\r\n{\r\nu32 backend_map = 0;\r\nu32 enabled_backends_mask;\r\nu32 enabled_backends_count;\r\nu32 cur_pipe;\r\nu32 swizzle_pipe[R7XX_MAX_PIPES];\r\nu32 cur_backend;\r\nu32 i;\r\nbool force_no_swizzle;\r\nif (num_tile_pipes > R7XX_MAX_PIPES)\r\nnum_tile_pipes = R7XX_MAX_PIPES;\r\nif (num_tile_pipes < 1)\r\nnum_tile_pipes = 1;\r\nif (num_backends > R7XX_MAX_BACKENDS)\r\nnum_backends = R7XX_MAX_BACKENDS;\r\nif (num_backends < 1)\r\nnum_backends = 1;\r\nenabled_backends_mask = 0;\r\nenabled_backends_count = 0;\r\nfor (i = 0; i < R7XX_MAX_BACKENDS; ++i) {\r\nif (((backend_disable_mask >> i) & 1) == 0) {\r\nenabled_backends_mask |= (1 << i);\r\n++enabled_backends_count;\r\n}\r\nif (enabled_backends_count == num_backends)\r\nbreak;\r\n}\r\nif (enabled_backends_count == 0) {\r\nenabled_backends_mask = 1;\r\nenabled_backends_count = 1;\r\n}\r\nif (enabled_backends_count != num_backends)\r\nnum_backends = enabled_backends_count;\r\nswitch (dev_priv->flags & RADEON_FAMILY_MASK) {\r\ncase CHIP_RV770:\r\ncase CHIP_RV730:\r\nforce_no_swizzle = false;\r\nbreak;\r\ncase CHIP_RV710:\r\ncase CHIP_RV740:\r\ndefault:\r\nforce_no_swizzle = true;\r\nbreak;\r\n}\r\nmemset((uint8_t *)&swizzle_pipe[0], 0, sizeof(u32) * R7XX_MAX_PIPES);\r\nswitch (num_tile_pipes) {\r\ncase 1:\r\nswizzle_pipe[0] = 0;\r\nbreak;\r\ncase 2:\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 1;\r\nbreak;\r\ncase 3:\r\nif (force_no_swizzle) {\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 1;\r\nswizzle_pipe[2] = 2;\r\n} else {\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 2;\r\nswizzle_pipe[2] = 1;\r\n}\r\nbreak;\r\ncase 4:\r\nif (force_no_swizzle) {\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 1;\r\nswizzle_pipe[2] = 2;\r\nswizzle_pipe[3] = 3;\r\n} else {\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 2;\r\nswizzle_pipe[2] = 3;\r\nswizzle_pipe[3] = 1;\r\n}\r\nbreak;\r\ncase 5:\r\nif (force_no_swizzle) {\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 1;\r\nswizzle_pipe[2] = 2;\r\nswizzle_pipe[3] = 3;\r\nswizzle_pipe[4] = 4;\r\n} else {\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 2;\r\nswizzle_pipe[2] = 4;\r\nswizzle_pipe[3] = 1;\r\nswizzle_pipe[4] = 3;\r\n}\r\nbreak;\r\ncase 6:\r\nif (force_no_swizzle) {\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 1;\r\nswizzle_pipe[2] = 2;\r\nswizzle_pipe[3] = 3;\r\nswizzle_pipe[4] = 4;\r\nswizzle_pipe[5] = 5;\r\n} else {\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 2;\r\nswizzle_pipe[2] = 4;\r\nswizzle_pipe[3] = 5;\r\nswizzle_pipe[4] = 3;\r\nswizzle_pipe[5] = 1;\r\n}\r\nbreak;\r\ncase 7:\r\nif (force_no_swizzle) {\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 1;\r\nswizzle_pipe[2] = 2;\r\nswizzle_pipe[3] = 3;\r\nswizzle_pipe[4] = 4;\r\nswizzle_pipe[5] = 5;\r\nswizzle_pipe[6] = 6;\r\n} else {\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 2;\r\nswizzle_pipe[2] = 4;\r\nswizzle_pipe[3] = 6;\r\nswizzle_pipe[4] = 3;\r\nswizzle_pipe[5] = 1;\r\nswizzle_pipe[6] = 5;\r\n}\r\nbreak;\r\ncase 8:\r\nif (force_no_swizzle) {\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 1;\r\nswizzle_pipe[2] = 2;\r\nswizzle_pipe[3] = 3;\r\nswizzle_pipe[4] = 4;\r\nswizzle_pipe[5] = 5;\r\nswizzle_pipe[6] = 6;\r\nswizzle_pipe[7] = 7;\r\n} else {\r\nswizzle_pipe[0] = 0;\r\nswizzle_pipe[1] = 2;\r\nswizzle_pipe[2] = 4;\r\nswizzle_pipe[3] = 6;\r\nswizzle_pipe[4] = 3;\r\nswizzle_pipe[5] = 1;\r\nswizzle_pipe[6] = 7;\r\nswizzle_pipe[7] = 5;\r\n}\r\nbreak;\r\n}\r\ncur_backend = 0;\r\nfor (cur_pipe = 0; cur_pipe < num_tile_pipes; ++cur_pipe) {\r\nwhile (((1 << cur_backend) & enabled_backends_mask) == 0)\r\ncur_backend = (cur_backend + 1) % R7XX_MAX_BACKENDS;\r\nbackend_map |= (u32)(((cur_backend & 3) << (swizzle_pipe[cur_pipe] * 2)));\r\ncur_backend = (cur_backend + 1) % R7XX_MAX_BACKENDS;\r\n}\r\nreturn backend_map;\r\n}\r\nstatic void r700_gfx_init(struct drm_device *dev,\r\ndrm_radeon_private_t *dev_priv)\r\n{\r\nint i, j, num_qd_pipes;\r\nu32 ta_aux_cntl;\r\nu32 sx_debug_1;\r\nu32 smx_dc_ctl0;\r\nu32 db_debug3;\r\nu32 num_gs_verts_per_thread;\r\nu32 vgt_gs_per_es;\r\nu32 gs_prim_buffer_depth = 0;\r\nu32 sq_ms_fifo_sizes;\r\nu32 sq_config;\r\nu32 sq_thread_resource_mgmt;\r\nu32 hdp_host_path_cntl;\r\nu32 sq_dyn_gpr_size_simd_ab_0;\r\nu32 backend_map;\r\nu32 gb_tiling_config = 0;\r\nu32 cc_rb_backend_disable;\r\nu32 cc_gc_shader_pipe_config;\r\nu32 mc_arb_ramcfg;\r\nu32 db_debug4;\r\nswitch (dev_priv->flags & RADEON_FAMILY_MASK) {\r\ncase CHIP_RV770:\r\ndev_priv->r600_max_pipes = 4;\r\ndev_priv->r600_max_tile_pipes = 8;\r\ndev_priv->r600_max_simds = 10;\r\ndev_priv->r600_max_backends = 4;\r\ndev_priv->r600_max_gprs = 256;\r\ndev_priv->r600_max_threads = 248;\r\ndev_priv->r600_max_stack_entries = 512;\r\ndev_priv->r600_max_hw_contexts = 8;\r\ndev_priv->r600_max_gs_threads = 16 * 2;\r\ndev_priv->r600_sx_max_export_size = 128;\r\ndev_priv->r600_sx_max_export_pos_size = 16;\r\ndev_priv->r600_sx_max_export_smx_size = 112;\r\ndev_priv->r600_sq_num_cf_insts = 2;\r\ndev_priv->r700_sx_num_of_sets = 7;\r\ndev_priv->r700_sc_prim_fifo_size = 0xF9;\r\ndev_priv->r700_sc_hiz_tile_fifo_size = 0x30;\r\ndev_priv->r700_sc_earlyz_tile_fifo_fize = 0x130;\r\nbreak;\r\ncase CHIP_RV730:\r\ndev_priv->r600_max_pipes = 2;\r\ndev_priv->r600_max_tile_pipes = 4;\r\ndev_priv->r600_max_simds = 8;\r\ndev_priv->r600_max_backends = 2;\r\ndev_priv->r600_max_gprs = 128;\r\ndev_priv->r600_max_threads = 248;\r\ndev_priv->r600_max_stack_entries = 256;\r\ndev_priv->r600_max_hw_contexts = 8;\r\ndev_priv->r600_max_gs_threads = 16 * 2;\r\ndev_priv->r600_sx_max_export_size = 256;\r\ndev_priv->r600_sx_max_export_pos_size = 32;\r\ndev_priv->r600_sx_max_export_smx_size = 224;\r\ndev_priv->r600_sq_num_cf_insts = 2;\r\ndev_priv->r700_sx_num_of_sets = 7;\r\ndev_priv->r700_sc_prim_fifo_size = 0xf9;\r\ndev_priv->r700_sc_hiz_tile_fifo_size = 0x30;\r\ndev_priv->r700_sc_earlyz_tile_fifo_fize = 0x130;\r\nif (dev_priv->r600_sx_max_export_pos_size > 16) {\r\ndev_priv->r600_sx_max_export_pos_size -= 16;\r\ndev_priv->r600_sx_max_export_smx_size += 16;\r\n}\r\nbreak;\r\ncase CHIP_RV710:\r\ndev_priv->r600_max_pipes = 2;\r\ndev_priv->r600_max_tile_pipes = 2;\r\ndev_priv->r600_max_simds = 2;\r\ndev_priv->r600_max_backends = 1;\r\ndev_priv->r600_max_gprs = 256;\r\ndev_priv->r600_max_threads = 192;\r\ndev_priv->r600_max_stack_entries = 256;\r\ndev_priv->r600_max_hw_contexts = 4;\r\ndev_priv->r600_max_gs_threads = 8 * 2;\r\ndev_priv->r600_sx_max_export_size = 128;\r\ndev_priv->r600_sx_max_export_pos_size = 16;\r\ndev_priv->r600_sx_max_export_smx_size = 112;\r\ndev_priv->r600_sq_num_cf_insts = 1;\r\ndev_priv->r700_sx_num_of_sets = 7;\r\ndev_priv->r700_sc_prim_fifo_size = 0x40;\r\ndev_priv->r700_sc_hiz_tile_fifo_size = 0x30;\r\ndev_priv->r700_sc_earlyz_tile_fifo_fize = 0x130;\r\nbreak;\r\ncase CHIP_RV740:\r\ndev_priv->r600_max_pipes = 4;\r\ndev_priv->r600_max_tile_pipes = 4;\r\ndev_priv->r600_max_simds = 8;\r\ndev_priv->r600_max_backends = 4;\r\ndev_priv->r600_max_gprs = 256;\r\ndev_priv->r600_max_threads = 248;\r\ndev_priv->r600_max_stack_entries = 512;\r\ndev_priv->r600_max_hw_contexts = 8;\r\ndev_priv->r600_max_gs_threads = 16 * 2;\r\ndev_priv->r600_sx_max_export_size = 256;\r\ndev_priv->r600_sx_max_export_pos_size = 32;\r\ndev_priv->r600_sx_max_export_smx_size = 224;\r\ndev_priv->r600_sq_num_cf_insts = 2;\r\ndev_priv->r700_sx_num_of_sets = 7;\r\ndev_priv->r700_sc_prim_fifo_size = 0x100;\r\ndev_priv->r700_sc_hiz_tile_fifo_size = 0x30;\r\ndev_priv->r700_sc_earlyz_tile_fifo_fize = 0x130;\r\nif (dev_priv->r600_sx_max_export_pos_size > 16) {\r\ndev_priv->r600_sx_max_export_pos_size -= 16;\r\ndev_priv->r600_sx_max_export_smx_size += 16;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nj = 0;\r\nfor (i = 0; i < 32; i++) {\r\nRADEON_WRITE((0x2c14 + j), 0x00000000);\r\nRADEON_WRITE((0x2c18 + j), 0x00000000);\r\nRADEON_WRITE((0x2c1c + j), 0x00000000);\r\nRADEON_WRITE((0x2c20 + j), 0x00000000);\r\nRADEON_WRITE((0x2c24 + j), 0x00000000);\r\nj += 0x18;\r\n}\r\nRADEON_WRITE(R600_GRBM_CNTL, R600_GRBM_READ_TIMEOUT(0xff));\r\nmc_arb_ramcfg = RADEON_READ(R700_MC_ARB_RAMCFG);\r\nswitch (dev_priv->r600_max_tile_pipes) {\r\ncase 1:\r\ngb_tiling_config |= R600_PIPE_TILING(0);\r\nbreak;\r\ncase 2:\r\ngb_tiling_config |= R600_PIPE_TILING(1);\r\nbreak;\r\ncase 4:\r\ngb_tiling_config |= R600_PIPE_TILING(2);\r\nbreak;\r\ncase 8:\r\ngb_tiling_config |= R600_PIPE_TILING(3);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV770)\r\ngb_tiling_config |= R600_BANK_TILING(1);\r\nelse\r\ngb_tiling_config |= R600_BANK_TILING((mc_arb_ramcfg >> R700_NOOFBANK_SHIFT) & R700_NOOFBANK_MASK);\r\ngb_tiling_config |= R600_GROUP_SIZE(0);\r\nif (((mc_arb_ramcfg >> R700_NOOFROWS_SHIFT) & R700_NOOFROWS_MASK) > 3) {\r\ngb_tiling_config |= R600_ROW_TILING(3);\r\ngb_tiling_config |= R600_SAMPLE_SPLIT(3);\r\n} else {\r\ngb_tiling_config |=\r\nR600_ROW_TILING(((mc_arb_ramcfg >> R700_NOOFROWS_SHIFT) & R700_NOOFROWS_MASK));\r\ngb_tiling_config |=\r\nR600_SAMPLE_SPLIT(((mc_arb_ramcfg >> R700_NOOFROWS_SHIFT) & R700_NOOFROWS_MASK));\r\n}\r\ngb_tiling_config |= R600_BANK_SWAPS(1);\r\ncc_rb_backend_disable = RADEON_READ(R600_CC_RB_BACKEND_DISABLE) & 0x00ff0000;\r\ncc_rb_backend_disable |=\r\nR600_BACKEND_DISABLE((R7XX_MAX_BACKENDS_MASK << dev_priv->r600_max_backends) & R7XX_MAX_BACKENDS_MASK);\r\ncc_gc_shader_pipe_config = RADEON_READ(R600_CC_GC_SHADER_PIPE_CONFIG) & 0xffffff00;\r\ncc_gc_shader_pipe_config |=\r\nR600_INACTIVE_QD_PIPES((R7XX_MAX_PIPES_MASK << dev_priv->r600_max_pipes) & R7XX_MAX_PIPES_MASK);\r\ncc_gc_shader_pipe_config |=\r\nR600_INACTIVE_SIMDS((R7XX_MAX_SIMDS_MASK << dev_priv->r600_max_simds) & R7XX_MAX_SIMDS_MASK);\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV740)\r\nbackend_map = 0x28;\r\nelse\r\nbackend_map = r700_get_tile_pipe_to_backend_map(dev_priv,\r\ndev_priv->r600_max_tile_pipes,\r\n(R7XX_MAX_BACKENDS -\r\nr600_count_pipe_bits((cc_rb_backend_disable &\r\nR7XX_MAX_BACKENDS_MASK) >> 16)),\r\n(cc_rb_backend_disable >> 16));\r\ngb_tiling_config |= R600_BACKEND_MAP(backend_map);\r\nRADEON_WRITE(R600_GB_TILING_CONFIG, gb_tiling_config);\r\nRADEON_WRITE(R600_DCP_TILING_CONFIG, (gb_tiling_config & 0xffff));\r\nRADEON_WRITE(R600_HDP_TILING_CONFIG, (gb_tiling_config & 0xffff));\r\nif (gb_tiling_config & 0xc0) {\r\ndev_priv->r600_group_size = 512;\r\n} else {\r\ndev_priv->r600_group_size = 256;\r\n}\r\ndev_priv->r600_npipes = 1 << ((gb_tiling_config >> 1) & 0x7);\r\nif (gb_tiling_config & 0x30) {\r\ndev_priv->r600_nbanks = 8;\r\n} else {\r\ndev_priv->r600_nbanks = 4;\r\n}\r\nRADEON_WRITE(R600_CC_RB_BACKEND_DISABLE, cc_rb_backend_disable);\r\nRADEON_WRITE(R600_CC_GC_SHADER_PIPE_CONFIG, cc_gc_shader_pipe_config);\r\nRADEON_WRITE(R600_GC_USER_SHADER_PIPE_CONFIG, cc_gc_shader_pipe_config);\r\nRADEON_WRITE(R700_CC_SYS_RB_BACKEND_DISABLE, cc_rb_backend_disable);\r\nRADEON_WRITE(R700_CGTS_SYS_TCC_DISABLE, 0);\r\nRADEON_WRITE(R700_CGTS_TCC_DISABLE, 0);\r\nRADEON_WRITE(R700_CGTS_USER_SYS_TCC_DISABLE, 0);\r\nRADEON_WRITE(R700_CGTS_USER_TCC_DISABLE, 0);\r\nnum_qd_pipes =\r\nR7XX_MAX_PIPES - r600_count_pipe_bits((cc_gc_shader_pipe_config & R600_INACTIVE_QD_PIPES_MASK) >> 8);\r\nRADEON_WRITE(R600_VGT_OUT_DEALLOC_CNTL, (num_qd_pipes * 4) & R600_DEALLOC_DIST_MASK);\r\nRADEON_WRITE(R600_VGT_VERTEX_REUSE_BLOCK_CNTL, ((num_qd_pipes * 4) - 2) & R600_VTX_REUSE_DEPTH_MASK);\r\nRADEON_WRITE(R600_CP_QUEUE_THRESHOLDS, (R600_ROQ_IB1_START(0x16) |\r\nR600_ROQ_IB2_START(0x2b)));\r\nRADEON_WRITE(R600_CP_MEQ_THRESHOLDS, R700_STQ_SPLIT(0x30));\r\nta_aux_cntl = RADEON_READ(R600_TA_CNTL_AUX);\r\nRADEON_WRITE(R600_TA_CNTL_AUX, ta_aux_cntl | R600_DISABLE_CUBE_ANISO);\r\nsx_debug_1 = RADEON_READ(R700_SX_DEBUG_1);\r\nsx_debug_1 |= R700_ENABLE_NEW_SMX_ADDRESS;\r\nRADEON_WRITE(R700_SX_DEBUG_1, sx_debug_1);\r\nsmx_dc_ctl0 = RADEON_READ(R600_SMX_DC_CTL0);\r\nsmx_dc_ctl0 &= ~R700_CACHE_DEPTH(0x1ff);\r\nsmx_dc_ctl0 |= R700_CACHE_DEPTH((dev_priv->r700_sx_num_of_sets * 64) - 1);\r\nRADEON_WRITE(R600_SMX_DC_CTL0, smx_dc_ctl0);\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) != CHIP_RV740)\r\nRADEON_WRITE(R700_SMX_EVENT_CTL, (R700_ES_FLUSH_CTL(4) |\r\nR700_GS_FLUSH_CTL(4) |\r\nR700_ACK_FLUSH_CTL(3) |\r\nR700_SYNC_FLUSH_CTL));\r\ndb_debug3 = RADEON_READ(R700_DB_DEBUG3);\r\ndb_debug3 &= ~R700_DB_CLK_OFF_DELAY(0x1f);\r\nswitch (dev_priv->flags & RADEON_FAMILY_MASK) {\r\ncase CHIP_RV770:\r\ncase CHIP_RV740:\r\ndb_debug3 |= R700_DB_CLK_OFF_DELAY(0x1f);\r\nbreak;\r\ncase CHIP_RV710:\r\ncase CHIP_RV730:\r\ndefault:\r\ndb_debug3 |= R700_DB_CLK_OFF_DELAY(2);\r\nbreak;\r\n}\r\nRADEON_WRITE(R700_DB_DEBUG3, db_debug3);\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) != CHIP_RV770) {\r\ndb_debug4 = RADEON_READ(RV700_DB_DEBUG4);\r\ndb_debug4 |= RV700_DISABLE_TILE_COVERED_FOR_PS_ITER;\r\nRADEON_WRITE(RV700_DB_DEBUG4, db_debug4);\r\n}\r\nRADEON_WRITE(R600_SX_EXPORT_BUFFER_SIZES, (R600_COLOR_BUFFER_SIZE((dev_priv->r600_sx_max_export_size / 4) - 1) |\r\nR600_POSITION_BUFFER_SIZE((dev_priv->r600_sx_max_export_pos_size / 4) - 1) |\r\nR600_SMX_BUFFER_SIZE((dev_priv->r600_sx_max_export_smx_size / 4) - 1)));\r\nRADEON_WRITE(R700_PA_SC_FIFO_SIZE_R7XX, (R700_SC_PRIM_FIFO_SIZE(dev_priv->r700_sc_prim_fifo_size) |\r\nR700_SC_HIZ_TILE_FIFO_SIZE(dev_priv->r700_sc_hiz_tile_fifo_size) |\r\nR700_SC_EARLYZ_TILE_FIFO_SIZE(dev_priv->r700_sc_earlyz_tile_fifo_fize)));\r\nRADEON_WRITE(R600_PA_SC_MULTI_CHIP_CNTL, 0);\r\nRADEON_WRITE(R600_VGT_NUM_INSTANCES, 1);\r\nRADEON_WRITE(R600_SPI_CONFIG_CNTL, R600_GPR_WRITE_PRIORITY(0));\r\nRADEON_WRITE(R600_SPI_CONFIG_CNTL_1, R600_VTX_DONE_DELAY(4));\r\nRADEON_WRITE(R600_CP_PERFMON_CNTL, 0);\r\nsq_ms_fifo_sizes = (R600_CACHE_FIFO_SIZE(16 * dev_priv->r600_sq_num_cf_insts) |\r\nR600_DONE_FIFO_HIWATER(0xe0) |\r\nR600_ALU_UPDATE_FIFO_HIWATER(0x8));\r\nswitch (dev_priv->flags & RADEON_FAMILY_MASK) {\r\ncase CHIP_RV770:\r\ncase CHIP_RV730:\r\ncase CHIP_RV710:\r\nsq_ms_fifo_sizes |= R600_FETCH_FIFO_HIWATER(0x1);\r\nbreak;\r\ncase CHIP_RV740:\r\ndefault:\r\nsq_ms_fifo_sizes |= R600_FETCH_FIFO_HIWATER(0x4);\r\nbreak;\r\n}\r\nRADEON_WRITE(R600_SQ_MS_FIFO_SIZES, sq_ms_fifo_sizes);\r\nsq_config = RADEON_READ(R600_SQ_CONFIG);\r\nsq_config &= ~(R600_PS_PRIO(3) |\r\nR600_VS_PRIO(3) |\r\nR600_GS_PRIO(3) |\r\nR600_ES_PRIO(3));\r\nsq_config |= (R600_DX9_CONSTS |\r\nR600_VC_ENABLE |\r\nR600_EXPORT_SRC_C |\r\nR600_PS_PRIO(0) |\r\nR600_VS_PRIO(1) |\r\nR600_GS_PRIO(2) |\r\nR600_ES_PRIO(3));\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV710)\r\nsq_config &= ~R600_VC_ENABLE;\r\nRADEON_WRITE(R600_SQ_CONFIG, sq_config);\r\nRADEON_WRITE(R600_SQ_GPR_RESOURCE_MGMT_1, (R600_NUM_PS_GPRS((dev_priv->r600_max_gprs * 24)/64) |\r\nR600_NUM_VS_GPRS((dev_priv->r600_max_gprs * 24)/64) |\r\nR600_NUM_CLAUSE_TEMP_GPRS(((dev_priv->r600_max_gprs * 24)/64)/2)));\r\nRADEON_WRITE(R600_SQ_GPR_RESOURCE_MGMT_2, (R600_NUM_GS_GPRS((dev_priv->r600_max_gprs * 7)/64) |\r\nR600_NUM_ES_GPRS((dev_priv->r600_max_gprs * 7)/64)));\r\nsq_thread_resource_mgmt = (R600_NUM_PS_THREADS((dev_priv->r600_max_threads * 4)/8) |\r\nR600_NUM_VS_THREADS((dev_priv->r600_max_threads * 2)/8) |\r\nR600_NUM_ES_THREADS((dev_priv->r600_max_threads * 1)/8));\r\nif (((dev_priv->r600_max_threads * 1) / 8) > dev_priv->r600_max_gs_threads)\r\nsq_thread_resource_mgmt |= R600_NUM_GS_THREADS(dev_priv->r600_max_gs_threads);\r\nelse\r\nsq_thread_resource_mgmt |= R600_NUM_GS_THREADS((dev_priv->r600_max_gs_threads * 1)/8);\r\nRADEON_WRITE(R600_SQ_THREAD_RESOURCE_MGMT, sq_thread_resource_mgmt);\r\nRADEON_WRITE(R600_SQ_STACK_RESOURCE_MGMT_1, (R600_NUM_PS_STACK_ENTRIES((dev_priv->r600_max_stack_entries * 1)/4) |\r\nR600_NUM_VS_STACK_ENTRIES((dev_priv->r600_max_stack_entries * 1)/4)));\r\nRADEON_WRITE(R600_SQ_STACK_RESOURCE_MGMT_2, (R600_NUM_GS_STACK_ENTRIES((dev_priv->r600_max_stack_entries * 1)/4) |\r\nR600_NUM_ES_STACK_ENTRIES((dev_priv->r600_max_stack_entries * 1)/4)));\r\nsq_dyn_gpr_size_simd_ab_0 = (R700_SIMDA_RING0((dev_priv->r600_max_gprs * 38)/64) |\r\nR700_SIMDA_RING1((dev_priv->r600_max_gprs * 38)/64) |\r\nR700_SIMDB_RING0((dev_priv->r600_max_gprs * 38)/64) |\r\nR700_SIMDB_RING1((dev_priv->r600_max_gprs * 38)/64));\r\nRADEON_WRITE(R700_SQ_DYN_GPR_SIZE_SIMD_AB_0, sq_dyn_gpr_size_simd_ab_0);\r\nRADEON_WRITE(R700_SQ_DYN_GPR_SIZE_SIMD_AB_1, sq_dyn_gpr_size_simd_ab_0);\r\nRADEON_WRITE(R700_SQ_DYN_GPR_SIZE_SIMD_AB_2, sq_dyn_gpr_size_simd_ab_0);\r\nRADEON_WRITE(R700_SQ_DYN_GPR_SIZE_SIMD_AB_3, sq_dyn_gpr_size_simd_ab_0);\r\nRADEON_WRITE(R700_SQ_DYN_GPR_SIZE_SIMD_AB_4, sq_dyn_gpr_size_simd_ab_0);\r\nRADEON_WRITE(R700_SQ_DYN_GPR_SIZE_SIMD_AB_5, sq_dyn_gpr_size_simd_ab_0);\r\nRADEON_WRITE(R700_SQ_DYN_GPR_SIZE_SIMD_AB_6, sq_dyn_gpr_size_simd_ab_0);\r\nRADEON_WRITE(R700_SQ_DYN_GPR_SIZE_SIMD_AB_7, sq_dyn_gpr_size_simd_ab_0);\r\nRADEON_WRITE(R700_PA_SC_FORCE_EOV_MAX_CNTS, (R700_FORCE_EOV_MAX_CLK_CNT(4095) |\r\nR700_FORCE_EOV_MAX_REZ_CNT(255)));\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV710)\r\nRADEON_WRITE(R600_VGT_CACHE_INVALIDATION, (R600_CACHE_INVALIDATION(R600_TC_ONLY) |\r\nR700_AUTO_INVLD_EN(R700_ES_AND_GS_AUTO)));\r\nelse\r\nRADEON_WRITE(R600_VGT_CACHE_INVALIDATION, (R600_CACHE_INVALIDATION(R600_VC_AND_TC) |\r\nR700_AUTO_INVLD_EN(R700_ES_AND_GS_AUTO)));\r\nswitch (dev_priv->flags & RADEON_FAMILY_MASK) {\r\ncase CHIP_RV770:\r\ncase CHIP_RV730:\r\ncase CHIP_RV740:\r\ngs_prim_buffer_depth = 384;\r\nbreak;\r\ncase CHIP_RV710:\r\ngs_prim_buffer_depth = 128;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nnum_gs_verts_per_thread = dev_priv->r600_max_pipes * 16;\r\nvgt_gs_per_es = gs_prim_buffer_depth + num_gs_verts_per_thread;\r\nif (vgt_gs_per_es > 256)\r\nvgt_gs_per_es = 256;\r\nRADEON_WRITE(R600_VGT_ES_PER_GS, 128);\r\nRADEON_WRITE(R600_VGT_GS_PER_ES, vgt_gs_per_es);\r\nRADEON_WRITE(R600_VGT_GS_PER_VS, 2);\r\nRADEON_WRITE(R600_VGT_GS_VERTEX_REUSE, 16);\r\nRADEON_WRITE(R600_PA_SC_LINE_STIPPLE_STATE, 0);\r\nRADEON_WRITE(R600_VGT_STRMOUT_EN, 0);\r\nRADEON_WRITE(R600_SX_MISC, 0);\r\nRADEON_WRITE(R600_PA_SC_MODE_CNTL, 0);\r\nRADEON_WRITE(R700_PA_SC_EDGERULE, 0xaaaaaaaa);\r\nRADEON_WRITE(R600_PA_SC_AA_CONFIG, 0);\r\nRADEON_WRITE(R600_PA_SC_CLIPRECT_RULE, 0xffff);\r\nRADEON_WRITE(R600_PA_SC_LINE_STIPPLE, 0);\r\nRADEON_WRITE(R600_SPI_INPUT_Z, 0);\r\nRADEON_WRITE(R600_SPI_PS_IN_CONTROL_0, R600_NUM_INTERP(2));\r\nRADEON_WRITE(R600_CB_COLOR7_FRAG, 0);\r\nRADEON_WRITE(R600_CB_COLOR0_BASE, 0);\r\nRADEON_WRITE(R600_CB_COLOR1_BASE, 0);\r\nRADEON_WRITE(R600_CB_COLOR2_BASE, 0);\r\nRADEON_WRITE(R600_CB_COLOR3_BASE, 0);\r\nRADEON_WRITE(R600_CB_COLOR4_BASE, 0);\r\nRADEON_WRITE(R600_CB_COLOR5_BASE, 0);\r\nRADEON_WRITE(R600_CB_COLOR6_BASE, 0);\r\nRADEON_WRITE(R600_CB_COLOR7_BASE, 0);\r\nRADEON_WRITE(R700_TCP_CNTL, 0);\r\nhdp_host_path_cntl = RADEON_READ(R600_HDP_HOST_PATH_CNTL);\r\nRADEON_WRITE(R600_HDP_HOST_PATH_CNTL, hdp_host_path_cntl);\r\nRADEON_WRITE(R600_PA_SC_MULTI_CHIP_CNTL, 0);\r\nRADEON_WRITE(R600_PA_CL_ENHANCE, (R600_CLIP_VTX_REORDER_ENA |\r\nR600_NUM_CLIP_SEQ(3)));\r\n}\r\nstatic void r600_cp_init_ring_buffer(struct drm_device *dev,\r\ndrm_radeon_private_t *dev_priv,\r\nstruct drm_file *file_priv)\r\n{\r\nstruct drm_radeon_master_private *master_priv;\r\nu32 ring_start;\r\nu64 rptr_addr;\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RV770))\r\nr700_gfx_init(dev, dev_priv);\r\nelse\r\nr600_gfx_init(dev, dev_priv);\r\nRADEON_WRITE(R600_GRBM_SOFT_RESET, R600_SOFT_RESET_CP);\r\nRADEON_READ(R600_GRBM_SOFT_RESET);\r\nmdelay(15);\r\nRADEON_WRITE(R600_GRBM_SOFT_RESET, 0);\r\n#ifdef __BIG_ENDIAN\r\nRADEON_WRITE(R600_CP_RB_CNTL,\r\nR600_BUF_SWAP_32BIT |\r\nR600_RB_NO_UPDATE |\r\n(dev_priv->ring.rptr_update_l2qw << 8) |\r\ndev_priv->ring.size_l2qw);\r\n#else\r\nRADEON_WRITE(R600_CP_RB_CNTL,\r\nRADEON_RB_NO_UPDATE |\r\n(dev_priv->ring.rptr_update_l2qw << 8) |\r\ndev_priv->ring.size_l2qw);\r\n#endif\r\nRADEON_WRITE(R600_CP_SEM_WAIT_TIMER, 0x0);\r\nRADEON_WRITE(R600_CP_RB_WPTR_DELAY, 0);\r\n#ifdef __BIG_ENDIAN\r\nRADEON_WRITE(R600_CP_RB_CNTL,\r\nR600_BUF_SWAP_32BIT |\r\nR600_RB_NO_UPDATE |\r\nR600_RB_RPTR_WR_ENA |\r\n(dev_priv->ring.rptr_update_l2qw << 8) |\r\ndev_priv->ring.size_l2qw);\r\n#else\r\nRADEON_WRITE(R600_CP_RB_CNTL,\r\nR600_RB_NO_UPDATE |\r\nR600_RB_RPTR_WR_ENA |\r\n(dev_priv->ring.rptr_update_l2qw << 8) |\r\ndev_priv->ring.size_l2qw);\r\n#endif\r\nRADEON_WRITE(R600_CP_RB_RPTR_WR, 0);\r\nRADEON_WRITE(R600_CP_RB_WPTR, 0);\r\nSET_RING_HEAD(dev_priv, 0);\r\ndev_priv->ring.tail = 0;\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP) {\r\nrptr_addr = dev_priv->ring_rptr->offset\r\n- dev->agp->base +\r\ndev_priv->gart_vm_start;\r\n} else\r\n#endif\r\n{\r\nrptr_addr = dev_priv->ring_rptr->offset\r\n- ((unsigned long) dev->sg->virtual)\r\n+ dev_priv->gart_vm_start;\r\n}\r\nRADEON_WRITE(R600_CP_RB_RPTR_ADDR, (rptr_addr & 0xfffffffc));\r\nRADEON_WRITE(R600_CP_RB_RPTR_ADDR_HI, upper_32_bits(rptr_addr));\r\n#ifdef __BIG_ENDIAN\r\nRADEON_WRITE(R600_CP_RB_CNTL,\r\nRADEON_BUF_SWAP_32BIT |\r\n(dev_priv->ring.rptr_update_l2qw << 8) |\r\ndev_priv->ring.size_l2qw);\r\n#else\r\nRADEON_WRITE(R600_CP_RB_CNTL,\r\n(dev_priv->ring.rptr_update_l2qw << 8) |\r\ndev_priv->ring.size_l2qw);\r\n#endif\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP) {\r\nradeon_write_agp_base(dev_priv, dev->agp->base);\r\nradeon_write_agp_location(dev_priv,\r\n(((dev_priv->gart_vm_start - 1 +\r\ndev_priv->gart_size) & 0xffff0000) |\r\n(dev_priv->gart_vm_start >> 16)));\r\nring_start = (dev_priv->cp_ring->offset\r\n- dev->agp->base\r\n+ dev_priv->gart_vm_start);\r\n} else\r\n#endif\r\nring_start = (dev_priv->cp_ring->offset\r\n- (unsigned long)dev->sg->virtual\r\n+ dev_priv->gart_vm_start);\r\nRADEON_WRITE(R600_CP_RB_BASE, ring_start >> 8);\r\nRADEON_WRITE(R600_CP_ME_CNTL, 0xff);\r\nRADEON_WRITE(R600_CP_DEBUG, (1 << 27) | (1 << 28));\r\n{\r\nu64 scratch_addr;\r\nscratch_addr = RADEON_READ(R600_CP_RB_RPTR_ADDR) & 0xFFFFFFFC;\r\nscratch_addr |= ((u64)RADEON_READ(R600_CP_RB_RPTR_ADDR_HI)) << 32;\r\nscratch_addr += R600_SCRATCH_REG_OFFSET;\r\nscratch_addr >>= 8;\r\nscratch_addr &= 0xffffffff;\r\nRADEON_WRITE(R600_SCRATCH_ADDR, (uint32_t)scratch_addr);\r\n}\r\nRADEON_WRITE(R600_SCRATCH_UMSK, 0x7);\r\nradeon_enable_bm(dev_priv);\r\nradeon_write_ring_rptr(dev_priv, R600_SCRATCHOFF(0), 0);\r\nRADEON_WRITE(R600_LAST_FRAME_REG, 0);\r\nradeon_write_ring_rptr(dev_priv, R600_SCRATCHOFF(1), 0);\r\nRADEON_WRITE(R600_LAST_DISPATCH_REG, 0);\r\nradeon_write_ring_rptr(dev_priv, R600_SCRATCHOFF(2), 0);\r\nRADEON_WRITE(R600_LAST_CLEAR_REG, 0);\r\nmaster_priv = file_priv->master->driver_priv;\r\nif (master_priv->sarea_priv) {\r\nmaster_priv->sarea_priv->last_frame = 0;\r\nmaster_priv->sarea_priv->last_dispatch = 0;\r\nmaster_priv->sarea_priv->last_clear = 0;\r\n}\r\nr600_do_wait_for_idle(dev_priv);\r\n}\r\nint r600_do_cleanup_cp(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nDRM_DEBUG("\n");\r\nif (dev->irq_enabled)\r\ndrm_irq_uninstall(dev);\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP) {\r\nif (dev_priv->cp_ring != NULL) {\r\ndrm_legacy_ioremapfree(dev_priv->cp_ring, dev);\r\ndev_priv->cp_ring = NULL;\r\n}\r\nif (dev_priv->ring_rptr != NULL) {\r\ndrm_legacy_ioremapfree(dev_priv->ring_rptr, dev);\r\ndev_priv->ring_rptr = NULL;\r\n}\r\nif (dev->agp_buffer_map != NULL) {\r\ndrm_legacy_ioremapfree(dev->agp_buffer_map, dev);\r\ndev->agp_buffer_map = NULL;\r\n}\r\n} else\r\n#endif\r\n{\r\nif (dev_priv->gart_info.bus_addr)\r\nr600_page_table_cleanup(dev, &dev_priv->gart_info);\r\nif (dev_priv->gart_info.gart_table_location == DRM_ATI_GART_FB) {\r\ndrm_legacy_ioremapfree(&dev_priv->gart_info.mapping, dev);\r\ndev_priv->gart_info.addr = NULL;\r\n}\r\n}\r\nmemset(dev_priv, 0, offsetof(drm_radeon_private_t, flags));\r\nreturn 0;\r\n}\r\nint r600_do_init_cp(struct drm_device *dev, drm_radeon_init_t *init,\r\nstruct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nstruct drm_radeon_master_private *master_priv = file_priv->master->driver_priv;\r\nDRM_DEBUG("\n");\r\nmutex_init(&dev_priv->cs_mutex);\r\nr600_cs_legacy_init();\r\nif ((dev_priv->flags & RADEON_NEW_MEMMAP) && !dev_priv->new_memmap) {\r\nDRM_ERROR("Cannot initialise DRM on this card\nThis card requires a new X.org DDX for 3D\n");\r\nr600_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\nif (init->is_pci && (dev_priv->flags & RADEON_IS_AGP)) {\r\nDRM_DEBUG("Forcing AGP card to PCI mode\n");\r\ndev_priv->flags &= ~RADEON_IS_AGP;\r\nradeon_no_wb = 1;\r\n} else if (!(dev_priv->flags & (RADEON_IS_AGP | RADEON_IS_PCI | RADEON_IS_PCIE))\r\n&& !init->is_pci) {\r\nDRM_DEBUG("Restoring AGP flag\n");\r\ndev_priv->flags |= RADEON_IS_AGP;\r\n}\r\ndev_priv->usec_timeout = init->usec_timeout;\r\nif (dev_priv->usec_timeout < 1 ||\r\ndev_priv->usec_timeout > RADEON_MAX_USEC_TIMEOUT) {\r\nDRM_DEBUG("TIMEOUT problem!\n");\r\nr600_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\ndev_priv->vblank_crtc = DRM_RADEON_VBLANK_CRTC1;\r\ndev_priv->do_boxes = 0;\r\ndev_priv->cp_mode = init->cp_mode;\r\nif ((init->cp_mode != RADEON_CSQ_PRIBM_INDDIS) &&\r\n(init->cp_mode != RADEON_CSQ_PRIBM_INDBM)) {\r\nDRM_DEBUG("BAD cp_mode (%x)!\n", init->cp_mode);\r\nr600_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\nswitch (init->fb_bpp) {\r\ncase 16:\r\ndev_priv->color_fmt = RADEON_COLOR_FORMAT_RGB565;\r\nbreak;\r\ncase 32:\r\ndefault:\r\ndev_priv->color_fmt = RADEON_COLOR_FORMAT_ARGB8888;\r\nbreak;\r\n}\r\ndev_priv->front_offset = init->front_offset;\r\ndev_priv->front_pitch = init->front_pitch;\r\ndev_priv->back_offset = init->back_offset;\r\ndev_priv->back_pitch = init->back_pitch;\r\ndev_priv->ring_offset = init->ring_offset;\r\ndev_priv->ring_rptr_offset = init->ring_rptr_offset;\r\ndev_priv->buffers_offset = init->buffers_offset;\r\ndev_priv->gart_textures_offset = init->gart_textures_offset;\r\nmaster_priv->sarea = drm_legacy_getsarea(dev);\r\nif (!master_priv->sarea) {\r\nDRM_ERROR("could not find sarea!\n");\r\nr600_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\ndev_priv->cp_ring = drm_legacy_findmap(dev, init->ring_offset);\r\nif (!dev_priv->cp_ring) {\r\nDRM_ERROR("could not find cp ring region!\n");\r\nr600_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\ndev_priv->ring_rptr = drm_legacy_findmap(dev, init->ring_rptr_offset);\r\nif (!dev_priv->ring_rptr) {\r\nDRM_ERROR("could not find ring read pointer!\n");\r\nr600_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\ndev->agp_buffer_token = init->buffers_offset;\r\ndev->agp_buffer_map = drm_legacy_findmap(dev, init->buffers_offset);\r\nif (!dev->agp_buffer_map) {\r\nDRM_ERROR("could not find dma buffer region!\n");\r\nr600_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\nif (init->gart_textures_offset) {\r\ndev_priv->gart_textures =\r\ndrm_legacy_findmap(dev, init->gart_textures_offset);\r\nif (!dev_priv->gart_textures) {\r\nDRM_ERROR("could not find GART texture region!\n");\r\nr600_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\n}\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP) {\r\ndrm_legacy_ioremap_wc(dev_priv->cp_ring, dev);\r\ndrm_legacy_ioremap_wc(dev_priv->ring_rptr, dev);\r\ndrm_legacy_ioremap_wc(dev->agp_buffer_map, dev);\r\nif (!dev_priv->cp_ring->handle ||\r\n!dev_priv->ring_rptr->handle ||\r\n!dev->agp_buffer_map->handle) {\r\nDRM_ERROR("could not find ioremap agp regions!\n");\r\nr600_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\n} else\r\n#endif\r\n{\r\ndev_priv->cp_ring->handle = (void *)(unsigned long)dev_priv->cp_ring->offset;\r\ndev_priv->ring_rptr->handle =\r\n(void *)(unsigned long)dev_priv->ring_rptr->offset;\r\ndev->agp_buffer_map->handle =\r\n(void *)(unsigned long)dev->agp_buffer_map->offset;\r\nDRM_DEBUG("dev_priv->cp_ring->handle %p\n",\r\ndev_priv->cp_ring->handle);\r\nDRM_DEBUG("dev_priv->ring_rptr->handle %p\n",\r\ndev_priv->ring_rptr->handle);\r\nDRM_DEBUG("dev->agp_buffer_map->handle %p\n",\r\ndev->agp_buffer_map->handle);\r\n}\r\ndev_priv->fb_location = (radeon_read_fb_location(dev_priv) & 0xffff) << 24;\r\ndev_priv->fb_size =\r\n(((radeon_read_fb_location(dev_priv) & 0xffff0000u) << 8) + 0x1000000)\r\n- dev_priv->fb_location;\r\ndev_priv->front_pitch_offset = (((dev_priv->front_pitch / 64) << 22) |\r\n((dev_priv->front_offset\r\n+ dev_priv->fb_location) >> 10));\r\ndev_priv->back_pitch_offset = (((dev_priv->back_pitch / 64) << 22) |\r\n((dev_priv->back_offset\r\n+ dev_priv->fb_location) >> 10));\r\ndev_priv->depth_pitch_offset = (((dev_priv->depth_pitch / 64) << 22) |\r\n((dev_priv->depth_offset\r\n+ dev_priv->fb_location) >> 10));\r\ndev_priv->gart_size = init->gart_size;\r\nif (dev_priv->new_memmap) {\r\nu32 base = 0;\r\nDRM_INFO("Setting GART location based on new memory map\n");\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP) {\r\nbase = dev->agp->base;\r\nif ((base + dev_priv->gart_size - 1) >= dev_priv->fb_location &&\r\nbase < (dev_priv->fb_location + dev_priv->fb_size - 1)) {\r\nDRM_INFO("Can't use AGP base @0x%08lx, won't fit\n",\r\ndev->agp->base);\r\nbase = 0;\r\n}\r\n}\r\n#endif\r\nif (base == 0) {\r\nbase = dev_priv->fb_location + dev_priv->fb_size;\r\nif (base < dev_priv->fb_location ||\r\n((base + dev_priv->gart_size) & 0xfffffffful) < base)\r\nbase = dev_priv->fb_location\r\n- dev_priv->gart_size;\r\n}\r\ndev_priv->gart_vm_start = base & 0xffc00000u;\r\nif (dev_priv->gart_vm_start != base)\r\nDRM_INFO("GART aligned down from 0x%08x to 0x%08x\n",\r\nbase, dev_priv->gart_vm_start);\r\n}\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP)\r\ndev_priv->gart_buffers_offset = (dev->agp_buffer_map->offset\r\n- dev->agp->base\r\n+ dev_priv->gart_vm_start);\r\nelse\r\n#endif\r\ndev_priv->gart_buffers_offset = (dev->agp_buffer_map->offset\r\n- (unsigned long)dev->sg->virtual\r\n+ dev_priv->gart_vm_start);\r\nDRM_DEBUG("fb 0x%08x size %d\n",\r\n(unsigned int) dev_priv->fb_location,\r\n(unsigned int) dev_priv->fb_size);\r\nDRM_DEBUG("dev_priv->gart_size %d\n", dev_priv->gart_size);\r\nDRM_DEBUG("dev_priv->gart_vm_start 0x%08x\n",\r\n(unsigned int) dev_priv->gart_vm_start);\r\nDRM_DEBUG("dev_priv->gart_buffers_offset 0x%08lx\n",\r\ndev_priv->gart_buffers_offset);\r\ndev_priv->ring.start = (u32 *) dev_priv->cp_ring->handle;\r\ndev_priv->ring.end = ((u32 *) dev_priv->cp_ring->handle\r\n+ init->ring_size / sizeof(u32));\r\ndev_priv->ring.size = init->ring_size;\r\ndev_priv->ring.size_l2qw = order_base_2(init->ring_size / 8);\r\ndev_priv->ring.rptr_update = 4096;\r\ndev_priv->ring.rptr_update_l2qw = order_base_2( 4096 / 8);\r\ndev_priv->ring.fetch_size = 32;\r\ndev_priv->ring.fetch_size_l2ow = order_base_2( 32 / 16);\r\ndev_priv->ring.tail_mask = (dev_priv->ring.size / sizeof(u32)) - 1;\r\ndev_priv->ring.high_mark = RADEON_RING_HIGH_MARK;\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP) {\r\n} else\r\n#endif\r\n{\r\ndev_priv->gart_info.table_mask = DMA_BIT_MASK(32);\r\nif (!dev_priv->pcigart_offset_set) {\r\nDRM_ERROR("Need gart offset from userspace\n");\r\nr600_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\nDRM_DEBUG("Using gart offset 0x%08lx\n", dev_priv->pcigart_offset);\r\ndev_priv->gart_info.bus_addr =\r\ndev_priv->pcigart_offset + dev_priv->fb_location;\r\ndev_priv->gart_info.mapping.offset =\r\ndev_priv->pcigart_offset + dev_priv->fb_aper_offset;\r\ndev_priv->gart_info.mapping.size =\r\ndev_priv->gart_info.table_size;\r\ndrm_legacy_ioremap_wc(&dev_priv->gart_info.mapping, dev);\r\nif (!dev_priv->gart_info.mapping.handle) {\r\nDRM_ERROR("ioremap failed.\n");\r\nr600_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\ndev_priv->gart_info.addr =\r\ndev_priv->gart_info.mapping.handle;\r\nDRM_DEBUG("Setting phys_pci_gart to %p %08lX\n",\r\ndev_priv->gart_info.addr,\r\ndev_priv->pcigart_offset);\r\nif (!r600_page_table_init(dev)) {\r\nDRM_ERROR("Failed to init GART table\n");\r\nr600_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RV770))\r\nr700_vm_init(dev);\r\nelse\r\nr600_vm_init(dev);\r\n}\r\nif (!dev_priv->me_fw || !dev_priv->pfp_fw) {\r\nint err = r600_cp_init_microcode(dev_priv);\r\nif (err) {\r\nDRM_ERROR("Failed to load firmware!\n");\r\nr600_do_cleanup_cp(dev);\r\nreturn err;\r\n}\r\n}\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RV770))\r\nr700_cp_load_microcode(dev_priv);\r\nelse\r\nr600_cp_load_microcode(dev_priv);\r\nr600_cp_init_ring_buffer(dev, dev_priv, file_priv);\r\ndev_priv->last_buf = 0;\r\nr600_do_engine_reset(dev);\r\nr600_test_writeback(dev_priv);\r\nreturn 0;\r\n}\r\nint r600_do_resume_cp(struct drm_device *dev, struct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nDRM_DEBUG("\n");\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RV770)) {\r\nr700_vm_init(dev);\r\nr700_cp_load_microcode(dev_priv);\r\n} else {\r\nr600_vm_init(dev);\r\nr600_cp_load_microcode(dev_priv);\r\n}\r\nr600_cp_init_ring_buffer(dev, dev_priv, file_priv);\r\nr600_do_engine_reset(dev);\r\nreturn 0;\r\n}\r\nint r600_do_cp_idle(drm_radeon_private_t *dev_priv)\r\n{\r\nRING_LOCALS;\r\nDRM_DEBUG("\n");\r\nBEGIN_RING(5);\r\nOUT_RING(CP_PACKET3(R600_IT_EVENT_WRITE, 0));\r\nOUT_RING(R600_CACHE_FLUSH_AND_INV_EVENT);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONFIG_REG, 1));\r\nOUT_RING((R600_WAIT_UNTIL - R600_SET_CONFIG_REG_OFFSET) >> 2);\r\nOUT_RING(RADEON_WAIT_3D_IDLE | RADEON_WAIT_3D_IDLECLEAN);\r\nADVANCE_RING();\r\nCOMMIT_RING();\r\nreturn r600_do_wait_for_idle(dev_priv);\r\n}\r\nvoid r600_do_cp_start(drm_radeon_private_t *dev_priv)\r\n{\r\nu32 cp_me;\r\nRING_LOCALS;\r\nDRM_DEBUG("\n");\r\nBEGIN_RING(7);\r\nOUT_RING(CP_PACKET3(R600_IT_ME_INITIALIZE, 5));\r\nOUT_RING(0x00000001);\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) < CHIP_RV770))\r\nOUT_RING(0x00000003);\r\nelse\r\nOUT_RING(0x00000000);\r\nOUT_RING((dev_priv->r600_max_hw_contexts - 1));\r\nOUT_RING(R600_ME_INITIALIZE_DEVICE_ID(1));\r\nOUT_RING(0x00000000);\r\nOUT_RING(0x00000000);\r\nADVANCE_RING();\r\nCOMMIT_RING();\r\ncp_me = 0xff;\r\nRADEON_WRITE(R600_CP_ME_CNTL, cp_me);\r\ndev_priv->cp_running = 1;\r\n}\r\nvoid r600_do_cp_reset(drm_radeon_private_t *dev_priv)\r\n{\r\nu32 cur_read_ptr;\r\nDRM_DEBUG("\n");\r\ncur_read_ptr = RADEON_READ(R600_CP_RB_RPTR);\r\nRADEON_WRITE(R600_CP_RB_WPTR, cur_read_ptr);\r\nSET_RING_HEAD(dev_priv, cur_read_ptr);\r\ndev_priv->ring.tail = cur_read_ptr;\r\n}\r\nvoid r600_do_cp_stop(drm_radeon_private_t *dev_priv)\r\n{\r\nuint32_t cp_me;\r\nDRM_DEBUG("\n");\r\ncp_me = 0xff | R600_CP_ME_HALT;\r\nRADEON_WRITE(R600_CP_ME_CNTL, cp_me);\r\ndev_priv->cp_running = 0;\r\n}\r\nint r600_cp_dispatch_indirect(struct drm_device *dev,\r\nstruct drm_buf *buf, int start, int end)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nRING_LOCALS;\r\nif (start != end) {\r\nunsigned long offset = (dev_priv->gart_buffers_offset\r\n+ buf->offset + start);\r\nint dwords = (end - start + 3) / sizeof(u32);\r\nDRM_DEBUG("dwords:%d\n", dwords);\r\nDRM_DEBUG("offset 0x%lx\n", offset);\r\nwhile (dwords & 0xf) {\r\nu32 *data = (u32 *)\r\n((char *)dev->agp_buffer_map->handle\r\n+ buf->offset + start);\r\ndata[dwords++] = RADEON_CP_PACKET2;\r\n}\r\nBEGIN_RING(4);\r\nOUT_RING(CP_PACKET3(R600_IT_INDIRECT_BUFFER, 2));\r\nOUT_RING((offset & 0xfffffffc));\r\nOUT_RING((upper_32_bits(offset) & 0xff));\r\nOUT_RING(dwords);\r\nADVANCE_RING();\r\n}\r\nreturn 0;\r\n}\r\nvoid r600_cp_dispatch_swap(struct drm_device *dev, struct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nstruct drm_master *master = file_priv->master;\r\nstruct drm_radeon_master_private *master_priv = master->driver_priv;\r\ndrm_radeon_sarea_t *sarea_priv = master_priv->sarea_priv;\r\nint nbox = sarea_priv->nbox;\r\nstruct drm_clip_rect *pbox = sarea_priv->boxes;\r\nint i, cpp, src_pitch, dst_pitch;\r\nuint64_t src, dst;\r\nRING_LOCALS;\r\nDRM_DEBUG("\n");\r\nif (dev_priv->color_fmt == RADEON_COLOR_FORMAT_ARGB8888)\r\ncpp = 4;\r\nelse\r\ncpp = 2;\r\nif (sarea_priv->pfCurrentPage == 0) {\r\nsrc_pitch = dev_priv->back_pitch;\r\ndst_pitch = dev_priv->front_pitch;\r\nsrc = dev_priv->back_offset + dev_priv->fb_location;\r\ndst = dev_priv->front_offset + dev_priv->fb_location;\r\n} else {\r\nsrc_pitch = dev_priv->front_pitch;\r\ndst_pitch = dev_priv->back_pitch;\r\nsrc = dev_priv->front_offset + dev_priv->fb_location;\r\ndst = dev_priv->back_offset + dev_priv->fb_location;\r\n}\r\nif (r600_prepare_blit_copy(dev, file_priv)) {\r\nDRM_ERROR("unable to allocate vertex buffer for swap buffer\n");\r\nreturn;\r\n}\r\nfor (i = 0; i < nbox; i++) {\r\nint x = pbox[i].x1;\r\nint y = pbox[i].y1;\r\nint w = pbox[i].x2 - x;\r\nint h = pbox[i].y2 - y;\r\nDRM_DEBUG("%d,%d-%d,%d\n", x, y, w, h);\r\nr600_blit_swap(dev,\r\nsrc, dst,\r\nx, y, x, y, w, h,\r\nsrc_pitch, dst_pitch, cpp);\r\n}\r\nr600_done_blit_copy(dev);\r\nsarea_priv->last_frame++;\r\nBEGIN_RING(3);\r\nR600_FRAME_AGE(sarea_priv->last_frame);\r\nADVANCE_RING();\r\n}\r\nint r600_cp_dispatch_texture(struct drm_device *dev,\r\nstruct drm_file *file_priv,\r\ndrm_radeon_texture_t *tex,\r\ndrm_radeon_tex_image_t *image)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nstruct drm_buf *buf;\r\nu32 *buffer;\r\nconst u8 __user *data;\r\nunsigned int size, pass_size;\r\nu64 src_offset, dst_offset;\r\nif (!radeon_check_offset(dev_priv, tex->offset)) {\r\nDRM_ERROR("Invalid destination offset\n");\r\nreturn -EINVAL;\r\n}\r\nif (!radeon_check_offset(dev_priv, tex->offset + tex->height * tex->pitch - 1)) {\r\nDRM_ERROR("Invalid final destination offset\n");\r\nreturn -EINVAL;\r\n}\r\nsize = tex->height * tex->pitch;\r\nif (size == 0)\r\nreturn 0;\r\ndst_offset = tex->offset;\r\nif (r600_prepare_blit_copy(dev, file_priv)) {\r\nDRM_ERROR("unable to allocate vertex buffer for swap buffer\n");\r\nreturn -EAGAIN;\r\n}\r\ndo {\r\ndata = (const u8 __user *)image->data;\r\npass_size = size;\r\nbuf = radeon_freelist_get(dev);\r\nif (!buf) {\r\nDRM_DEBUG("EAGAIN\n");\r\nif (copy_to_user(tex->image, image, sizeof(*image)))\r\nreturn -EFAULT;\r\nreturn -EAGAIN;\r\n}\r\nif (pass_size > buf->total)\r\npass_size = buf->total;\r\nbuffer =\r\n(u32 *) ((char *)dev->agp_buffer_map->handle + buf->offset);\r\nif (copy_from_user(buffer, data, pass_size)) {\r\nDRM_ERROR("EFAULT on pad, %d bytes\n", pass_size);\r\nreturn -EFAULT;\r\n}\r\nbuf->file_priv = file_priv;\r\nbuf->used = pass_size;\r\nsrc_offset = dev_priv->gart_buffers_offset + buf->offset;\r\nr600_blit_copy(dev, src_offset, dst_offset, pass_size);\r\nradeon_cp_discard_buffer(dev, file_priv->master, buf);\r\nimage->data = (const u8 __user *)image->data + pass_size;\r\ndst_offset += pass_size;\r\nsize -= pass_size;\r\n} while (size > 0);\r\nr600_done_blit_copy(dev);\r\nreturn 0;\r\n}\r\nstatic u32 radeon_cs_id_get(struct drm_radeon_private *radeon)\r\n{\r\nradeon->cs_id_scnt = (radeon->cs_id_scnt + 1) & 0x00FFFFFF;\r\nif (!radeon->cs_id_scnt) {\r\nradeon->cs_id_wcnt += 0x01000000;\r\nradeon->cs_id_scnt = 1;\r\n}\r\nreturn (radeon->cs_id_scnt | radeon->cs_id_wcnt);\r\n}\r\nstatic void r600_cs_id_emit(drm_radeon_private_t *dev_priv, u32 *id)\r\n{\r\nRING_LOCALS;\r\n*id = radeon_cs_id_get(dev_priv);\r\nBEGIN_RING(3);\r\nR600_CLEAR_AGE(*id);\r\nADVANCE_RING();\r\nCOMMIT_RING();\r\n}\r\nstatic int r600_ib_get(struct drm_device *dev,\r\nstruct drm_file *fpriv,\r\nstruct drm_buf **buffer)\r\n{\r\nstruct drm_buf *buf;\r\n*buffer = NULL;\r\nbuf = radeon_freelist_get(dev);\r\nif (!buf) {\r\nreturn -EBUSY;\r\n}\r\nbuf->file_priv = fpriv;\r\n*buffer = buf;\r\nreturn 0;\r\n}\r\nstatic void r600_ib_free(struct drm_device *dev, struct drm_buf *buf,\r\nstruct drm_file *fpriv, int l, int r)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nif (buf) {\r\nif (!r)\r\nr600_cp_dispatch_indirect(dev, buf, 0, l * 4);\r\nradeon_cp_discard_buffer(dev, fpriv->master, buf);\r\nCOMMIT_RING();\r\n}\r\n}\r\nint r600_cs_legacy_ioctl(struct drm_device *dev, void *data, struct drm_file *fpriv)\r\n{\r\nstruct drm_radeon_private *dev_priv = dev->dev_private;\r\nstruct drm_radeon_cs *cs = data;\r\nstruct drm_buf *buf;\r\nunsigned family;\r\nint l, r = 0;\r\nu32 *ib, cs_id = 0;\r\nif (dev_priv == NULL) {\r\nDRM_ERROR("called with no initialization\n");\r\nreturn -EINVAL;\r\n}\r\nfamily = dev_priv->flags & RADEON_FAMILY_MASK;\r\nif (family < CHIP_R600) {\r\nDRM_ERROR("cs ioctl valid only for R6XX & R7XX in legacy mode\n");\r\nreturn -EINVAL;\r\n}\r\nmutex_lock(&dev_priv->cs_mutex);\r\nr = r600_ib_get(dev, fpriv, &buf);\r\nif (r) {\r\nDRM_ERROR("ib_get failed\n");\r\ngoto out;\r\n}\r\nib = dev->agp_buffer_map->handle + buf->offset;\r\nr = r600_cs_legacy(dev, data, fpriv, family, ib, &l);\r\nif (r) {\r\ngoto out;\r\n}\r\nout:\r\nr600_ib_free(dev, buf, fpriv, l, r);\r\nr600_cs_id_emit(dev_priv, &cs_id);\r\ncs->cs_id = cs_id;\r\nmutex_unlock(&dev_priv->cs_mutex);\r\nreturn r;\r\n}\r\nvoid r600_cs_legacy_get_tiling_conf(struct drm_device *dev, u32 *npipes, u32 *nbanks, u32 *group_size)\r\n{\r\nstruct drm_radeon_private *dev_priv = dev->dev_private;\r\n*npipes = dev_priv->r600_npipes;\r\n*nbanks = dev_priv->r600_nbanks;\r\n*group_size = dev_priv->r600_group_size;\r\n}

static psmouse_ret_t ps2pp_process_byte(struct psmouse *psmouse)\r\n{\r\nstruct input_dev *dev = psmouse->dev;\r\nunsigned char *packet = psmouse->packet;\r\nif (psmouse->pktcnt < 3)\r\nreturn PSMOUSE_GOOD_DATA;\r\nif ((packet[0] & 0x48) == 0x48 && (packet[1] & 0x02) == 0x02) {\r\nswitch ((packet[1] >> 4) | (packet[0] & 0x30)) {\r\ncase 0x0d:\r\ninput_report_rel(dev, packet[2] & 0x80 ? REL_HWHEEL : REL_WHEEL,\r\n(int) (packet[2] & 8) - (int) (packet[2] & 7));\r\ninput_report_key(dev, BTN_SIDE, (packet[2] >> 4) & 1);\r\ninput_report_key(dev, BTN_EXTRA, (packet[2] >> 5) & 1);\r\nbreak;\r\ncase 0x0e:\r\ninput_report_key(dev, BTN_SIDE, (packet[2]) & 1);\r\ninput_report_key(dev, BTN_EXTRA, (packet[2] >> 1) & 1);\r\ninput_report_key(dev, BTN_BACK, (packet[2] >> 3) & 1);\r\ninput_report_key(dev, BTN_FORWARD, (packet[2] >> 4) & 1);\r\ninput_report_key(dev, BTN_TASK, (packet[2] >> 2) & 1);\r\nbreak;\r\ncase 0x0f:\r\ninput_report_rel(dev, packet[2] & 0x08 ? REL_HWHEEL : REL_WHEEL,\r\n(int) ((packet[2] >> 4) & 8) - (int) ((packet[2] >> 4) & 7));\r\npacket[0] = packet[2] | 0x08;\r\nbreak;\r\ndefault:\r\npsmouse_dbg(psmouse,\r\n"Received PS2++ packet #%x, but don't know how to handle.\n",\r\n(packet[1] >> 4) | (packet[0] & 0x30));\r\nbreak;\r\n}\r\n} else {\r\ninput_report_rel(dev, REL_X, packet[1] ? (int) packet[1] - (int) ((packet[0] << 4) & 0x100) : 0);\r\ninput_report_rel(dev, REL_Y, packet[2] ? (int) ((packet[0] << 3) & 0x100) - (int) packet[2] : 0);\r\n}\r\ninput_report_key(dev, BTN_LEFT, packet[0] & 1);\r\ninput_report_key(dev, BTN_MIDDLE, (packet[0] >> 2) & 1);\r\ninput_report_key(dev, BTN_RIGHT, (packet[0] >> 1) & 1);\r\ninput_sync(dev);\r\nreturn PSMOUSE_FULL_PACKET;\r\n}\r\nstatic int ps2pp_cmd(struct psmouse *psmouse, unsigned char *param, unsigned char command)\r\n{\r\nif (psmouse_sliced_command(psmouse, command))\r\nreturn -1;\r\nif (ps2_command(&psmouse->ps2dev, param, PSMOUSE_CMD_POLL | 0x0300))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic void ps2pp_set_smartscroll(struct psmouse *psmouse, bool smartscroll)\r\n{\r\nstruct ps2dev *ps2dev = &psmouse->ps2dev;\r\nunsigned char param[4];\r\nps2pp_cmd(psmouse, param, 0x32);\r\nparam[0] = 0;\r\nps2_command(ps2dev, param, PSMOUSE_CMD_SETRES);\r\nps2_command(ps2dev, param, PSMOUSE_CMD_SETRES);\r\nps2_command(ps2dev, param, PSMOUSE_CMD_SETRES);\r\nparam[0] = smartscroll;\r\nps2_command(ps2dev, param, PSMOUSE_CMD_SETRES);\r\n}\r\nstatic ssize_t ps2pp_attr_show_smartscroll(struct psmouse *psmouse,\r\nvoid *data, char *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", psmouse->smartscroll);\r\n}\r\nstatic ssize_t ps2pp_attr_set_smartscroll(struct psmouse *psmouse, void *data,\r\nconst char *buf, size_t count)\r\n{\r\nunsigned int value;\r\nint err;\r\nerr = kstrtouint(buf, 10, &value);\r\nif (err)\r\nreturn err;\r\nif (value > 1)\r\nreturn -EINVAL;\r\nps2pp_set_smartscroll(psmouse, value);\r\npsmouse->smartscroll = value;\r\nreturn count;\r\n}\r\nstatic void ps2pp_set_resolution(struct psmouse *psmouse, unsigned int resolution)\r\n{\r\nif (resolution > 400) {\r\nstruct ps2dev *ps2dev = &psmouse->ps2dev;\r\nunsigned char param = 3;\r\nps2_command(ps2dev, NULL, PSMOUSE_CMD_SETSCALE11);\r\nps2_command(ps2dev, NULL, PSMOUSE_CMD_SETSCALE11);\r\nps2_command(ps2dev, NULL, PSMOUSE_CMD_SETSCALE11);\r\nps2_command(ps2dev, &param, PSMOUSE_CMD_SETRES);\r\npsmouse->resolution = 800;\r\n} else\r\npsmouse_set_resolution(psmouse, resolution);\r\n}\r\nstatic void ps2pp_disconnect(struct psmouse *psmouse)\r\n{\r\ndevice_remove_file(&psmouse->ps2dev.serio->dev, &psmouse_attr_smartscroll.dattr);\r\n}\r\nstatic const struct ps2pp_info *get_model_info(unsigned char model)\r\n{\r\nstatic const struct ps2pp_info ps2pp_list[] = {\r\n{ 1, 0, 0 },\r\n{ 12, 0, PS2PP_SIDE_BTN},\r\n{ 13, 0, 0 },\r\n{ 15, PS2PP_KIND_MX,\r\nPS2PP_WHEEL | PS2PP_SIDE_BTN | PS2PP_TASK_BTN |\r\nPS2PP_EXTRA_BTN | PS2PP_NAV_BTN | PS2PP_HWHEEL },\r\n{ 40, 0, PS2PP_SIDE_BTN },\r\n{ 41, 0, PS2PP_SIDE_BTN },\r\n{ 42, 0, PS2PP_SIDE_BTN },\r\n{ 43, 0, PS2PP_SIDE_BTN },\r\n{ 50, 0, 0 },\r\n{ 51, 0, 0 },\r\n{ 52, PS2PP_KIND_WHEEL, PS2PP_SIDE_BTN | PS2PP_WHEEL },\r\n{ 53, PS2PP_KIND_WHEEL, PS2PP_WHEEL },\r\n{ 56, PS2PP_KIND_WHEEL, PS2PP_SIDE_BTN | PS2PP_WHEEL },\r\n{ 61, PS2PP_KIND_MX,\r\nPS2PP_WHEEL | PS2PP_SIDE_BTN | PS2PP_TASK_BTN |\r\nPS2PP_EXTRA_BTN | PS2PP_NAV_BTN },\r\n{ 66, PS2PP_KIND_MX,\r\nPS2PP_WHEEL | PS2PP_SIDE_BTN | PS2PP_TASK_BTN |\r\nPS2PP_EXTRA_BTN | PS2PP_NAV_BTN | PS2PP_HWHEEL },\r\n{ 72, PS2PP_KIND_TRACKMAN, 0 },\r\n{ 73, PS2PP_KIND_TRACKMAN, PS2PP_SIDE_BTN },\r\n{ 75, PS2PP_KIND_WHEEL, PS2PP_WHEEL },\r\n{ 76, PS2PP_KIND_WHEEL, PS2PP_WHEEL },\r\n{ 79, PS2PP_KIND_TRACKMAN, PS2PP_WHEEL },\r\n{ 80, PS2PP_KIND_WHEEL, PS2PP_SIDE_BTN | PS2PP_WHEEL },\r\n{ 81, PS2PP_KIND_WHEEL, PS2PP_WHEEL },\r\n{ 83, PS2PP_KIND_WHEEL, PS2PP_WHEEL },\r\n{ 85, PS2PP_KIND_WHEEL, PS2PP_WHEEL },\r\n{ 86, PS2PP_KIND_WHEEL, PS2PP_WHEEL },\r\n{ 87, PS2PP_KIND_WHEEL, PS2PP_WHEEL },\r\n{ 88, PS2PP_KIND_WHEEL, PS2PP_WHEEL },\r\n{ 96, 0, 0 },\r\n{ 97, PS2PP_KIND_TP3, PS2PP_WHEEL | PS2PP_HWHEEL },\r\n{ 99, PS2PP_KIND_WHEEL, PS2PP_WHEEL },\r\n{ 100, PS2PP_KIND_MX,\r\nPS2PP_WHEEL | PS2PP_SIDE_BTN | PS2PP_TASK_BTN |\r\nPS2PP_EXTRA_BTN | PS2PP_NAV_BTN },\r\n{ 111, PS2PP_KIND_MX, PS2PP_WHEEL | PS2PP_SIDE_BTN },\r\n{ 112, PS2PP_KIND_MX,\r\nPS2PP_WHEEL | PS2PP_SIDE_BTN | PS2PP_TASK_BTN |\r\nPS2PP_EXTRA_BTN | PS2PP_NAV_BTN },\r\n{ 114, PS2PP_KIND_MX,\r\nPS2PP_WHEEL | PS2PP_SIDE_BTN |\r\nPS2PP_TASK_BTN | PS2PP_EXTRA_BTN }\r\n};\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ps2pp_list); i++)\r\nif (model == ps2pp_list[i].model)\r\nreturn &ps2pp_list[i];\r\nreturn NULL;\r\n}\r\nstatic void ps2pp_set_model_properties(struct psmouse *psmouse,\r\nconst struct ps2pp_info *model_info,\r\nbool using_ps2pp)\r\n{\r\nstruct input_dev *input_dev = psmouse->dev;\r\nif (model_info->features & PS2PP_SIDE_BTN)\r\n__set_bit(BTN_SIDE, input_dev->keybit);\r\nif (model_info->features & PS2PP_EXTRA_BTN)\r\n__set_bit(BTN_EXTRA, input_dev->keybit);\r\nif (model_info->features & PS2PP_TASK_BTN)\r\n__set_bit(BTN_TASK, input_dev->keybit);\r\nif (model_info->features & PS2PP_NAV_BTN) {\r\n__set_bit(BTN_FORWARD, input_dev->keybit);\r\n__set_bit(BTN_BACK, input_dev->keybit);\r\n}\r\nif (model_info->features & PS2PP_WHEEL)\r\n__set_bit(REL_WHEEL, input_dev->relbit);\r\nif (model_info->features & PS2PP_HWHEEL)\r\n__set_bit(REL_HWHEEL, input_dev->relbit);\r\nswitch (model_info->kind) {\r\ncase PS2PP_KIND_WHEEL:\r\npsmouse->name = "Wheel Mouse";\r\nbreak;\r\ncase PS2PP_KIND_MX:\r\npsmouse->name = "MX Mouse";\r\nbreak;\r\ncase PS2PP_KIND_TP3:\r\npsmouse->name = "TouchPad 3";\r\nbreak;\r\ncase PS2PP_KIND_TRACKMAN:\r\npsmouse->name = "TrackMan";\r\nbreak;\r\ndefault:\r\nif (using_ps2pp)\r\npsmouse->name = "Mouse";\r\nbreak;\r\n}\r\n}\r\nint ps2pp_init(struct psmouse *psmouse, bool set_properties)\r\n{\r\nstruct ps2dev *ps2dev = &psmouse->ps2dev;\r\nunsigned char param[4];\r\nunsigned char model, buttons;\r\nconst struct ps2pp_info *model_info;\r\nbool use_ps2pp = false;\r\nint error;\r\nparam[0] = 0;\r\nps2_command(ps2dev, param, PSMOUSE_CMD_SETRES);\r\nps2_command(ps2dev, NULL, PSMOUSE_CMD_SETSCALE11);\r\nps2_command(ps2dev, NULL, PSMOUSE_CMD_SETSCALE11);\r\nps2_command(ps2dev, NULL, PSMOUSE_CMD_SETSCALE11);\r\nparam[1] = 0;\r\nps2_command(ps2dev, param, PSMOUSE_CMD_GETINFO);\r\nmodel = ((param[0] >> 4) & 0x07) | ((param[0] << 3) & 0x78);\r\nbuttons = param[1];\r\nif (!model || !buttons)\r\nreturn -1;\r\nmodel_info = get_model_info(model);\r\nif (model_info) {\r\nif (model_info->kind == PS2PP_KIND_TP3) {\r\nparam[0] = 0x11; param[1] = 0x04; param[2] = 0x68;\r\nps2_command(ps2dev, param, 0x30d1);\r\nparam[0] = 0x11; param[1] = 0x05; param[2] = 0x0b;\r\nps2_command(ps2dev, param, 0x30d1);\r\nparam[0] = 0x11; param[1] = 0x09; param[2] = 0xc3;\r\nps2_command(ps2dev, param, 0x30d1);\r\nparam[0] = 0;\r\nif (!ps2_command(ps2dev, param, 0x13d1) &&\r\nparam[0] == 0x06 && param[1] == 0x00 && param[2] == 0x14) {\r\nuse_ps2pp = true;\r\n}\r\n} else {\r\nparam[0] = param[1] = param[2] = 0;\r\nps2pp_cmd(psmouse, param, 0x39);\r\nps2pp_cmd(psmouse, param, 0xDB);\r\nif ((param[0] & 0x78) == 0x48 &&\r\n(param[1] & 0xf3) == 0xc2 &&\r\n(param[2] & 0x03) == ((param[1] >> 2) & 3)) {\r\nps2pp_set_smartscroll(psmouse, false);\r\nuse_ps2pp = true;\r\n}\r\n}\r\n} else {\r\npsmouse_warn(psmouse, "Detected unknown Logitech mouse model %d\n", model);\r\n}\r\nif (set_properties) {\r\npsmouse->vendor = "Logitech";\r\npsmouse->model = model;\r\nif (use_ps2pp) {\r\npsmouse->protocol_handler = ps2pp_process_byte;\r\npsmouse->pktsize = 3;\r\nif (model_info->kind != PS2PP_KIND_TP3) {\r\npsmouse->set_resolution = ps2pp_set_resolution;\r\npsmouse->disconnect = ps2pp_disconnect;\r\nerror = device_create_file(&psmouse->ps2dev.serio->dev,\r\n&psmouse_attr_smartscroll.dattr);\r\nif (error) {\r\npsmouse_err(psmouse,\r\n"failed to create smartscroll sysfs attribute, error: %d\n",\r\nerror);\r\nreturn -1;\r\n}\r\n}\r\n}\r\nif (buttons >= 3)\r\n__set_bit(BTN_MIDDLE, psmouse->dev->keybit);\r\nif (model_info)\r\nps2pp_set_model_properties(psmouse, model_info, use_ps2pp);\r\n}\r\nreturn use_ps2pp ? 0 : -1;\r\n}

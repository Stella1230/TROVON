void dce3_2_afmt_hdmi_write_speaker_allocation(struct drm_encoder *encoder,\r\nu8 *sadb, int sad_count)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nu32 tmp;\r\ntmp = RREG32_ENDPOINT(0, AZ_F0_CODEC_PIN0_CONTROL_CHANNEL_SPEAKER);\r\ntmp &= ~(DP_CONNECTION | SPEAKER_ALLOCATION_MASK);\r\ntmp |= HDMI_CONNECTION;\r\nif (sad_count)\r\ntmp |= SPEAKER_ALLOCATION(sadb[0]);\r\nelse\r\ntmp |= SPEAKER_ALLOCATION(5);\r\nWREG32_ENDPOINT(0, AZ_F0_CODEC_PIN0_CONTROL_CHANNEL_SPEAKER, tmp);\r\n}\r\nvoid dce3_2_afmt_dp_write_speaker_allocation(struct drm_encoder *encoder,\r\nu8 *sadb, int sad_count)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nu32 tmp;\r\ntmp = RREG32_ENDPOINT(0, AZ_F0_CODEC_PIN0_CONTROL_CHANNEL_SPEAKER);\r\ntmp &= ~(HDMI_CONNECTION | SPEAKER_ALLOCATION_MASK);\r\ntmp |= DP_CONNECTION;\r\nif (sad_count)\r\ntmp |= SPEAKER_ALLOCATION(sadb[0]);\r\nelse\r\ntmp |= SPEAKER_ALLOCATION(5);\r\nWREG32_ENDPOINT(0, AZ_F0_CODEC_PIN0_CONTROL_CHANNEL_SPEAKER, tmp);\r\n}\r\nvoid dce3_2_afmt_write_sad_regs(struct drm_encoder *encoder,\r\nstruct cea_sad *sads, int sad_count)\r\n{\r\nint i;\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nstatic const u16 eld_reg_to_type[][2] = {\r\n{ AZ_F0_CODEC_PIN0_CONTROL_AUDIO_DESCRIPTOR0, HDMI_AUDIO_CODING_TYPE_PCM },\r\n{ AZ_F0_CODEC_PIN0_CONTROL_AUDIO_DESCRIPTOR1, HDMI_AUDIO_CODING_TYPE_AC3 },\r\n{ AZ_F0_CODEC_PIN0_CONTROL_AUDIO_DESCRIPTOR2, HDMI_AUDIO_CODING_TYPE_MPEG1 },\r\n{ AZ_F0_CODEC_PIN0_CONTROL_AUDIO_DESCRIPTOR3, HDMI_AUDIO_CODING_TYPE_MP3 },\r\n{ AZ_F0_CODEC_PIN0_CONTROL_AUDIO_DESCRIPTOR4, HDMI_AUDIO_CODING_TYPE_MPEG2 },\r\n{ AZ_F0_CODEC_PIN0_CONTROL_AUDIO_DESCRIPTOR5, HDMI_AUDIO_CODING_TYPE_AAC_LC },\r\n{ AZ_F0_CODEC_PIN0_CONTROL_AUDIO_DESCRIPTOR6, HDMI_AUDIO_CODING_TYPE_DTS },\r\n{ AZ_F0_CODEC_PIN0_CONTROL_AUDIO_DESCRIPTOR7, HDMI_AUDIO_CODING_TYPE_ATRAC },\r\n{ AZ_F0_CODEC_PIN0_CONTROL_AUDIO_DESCRIPTOR9, HDMI_AUDIO_CODING_TYPE_EAC3 },\r\n{ AZ_F0_CODEC_PIN0_CONTROL_AUDIO_DESCRIPTOR10, HDMI_AUDIO_CODING_TYPE_DTS_HD },\r\n{ AZ_F0_CODEC_PIN0_CONTROL_AUDIO_DESCRIPTOR11, HDMI_AUDIO_CODING_TYPE_MLP },\r\n{ AZ_F0_CODEC_PIN0_CONTROL_AUDIO_DESCRIPTOR13, HDMI_AUDIO_CODING_TYPE_WMA_PRO },\r\n};\r\nfor (i = 0; i < ARRAY_SIZE(eld_reg_to_type); i++) {\r\nu32 value = 0;\r\nu8 stereo_freqs = 0;\r\nint max_channels = -1;\r\nint j;\r\nfor (j = 0; j < sad_count; j++) {\r\nstruct cea_sad *sad = &sads[j];\r\nif (sad->format == eld_reg_to_type[i][1]) {\r\nif (sad->channels > max_channels) {\r\nvalue = MAX_CHANNELS(sad->channels) |\r\nDESCRIPTOR_BYTE_2(sad->byte2) |\r\nSUPPORTED_FREQUENCIES(sad->freq);\r\nmax_channels = sad->channels;\r\n}\r\nif (sad->format == HDMI_AUDIO_CODING_TYPE_PCM)\r\nstereo_freqs |= sad->freq;\r\nelse\r\nbreak;\r\n}\r\n}\r\nvalue |= SUPPORTED_FREQUENCIES_STEREO(stereo_freqs);\r\nWREG32_ENDPOINT(0, eld_reg_to_type[i][0], value);\r\n}\r\n}\r\nvoid dce3_2_audio_set_dto(struct radeon_device *rdev,\r\nstruct radeon_crtc *crtc, unsigned int clock)\r\n{\r\nstruct radeon_encoder *radeon_encoder;\r\nstruct radeon_encoder_atom_dig *dig;\r\nunsigned int max_ratio = clock / 24000;\r\nu32 dto_phase;\r\nu32 wallclock_ratio;\r\nu32 dto_cntl;\r\nif (!crtc)\r\nreturn;\r\nradeon_encoder = to_radeon_encoder(crtc->encoder);\r\ndig = radeon_encoder->enc_priv;\r\nif (!dig)\r\nreturn;\r\nif (max_ratio >= 8) {\r\ndto_phase = 192 * 1000;\r\nwallclock_ratio = 3;\r\n} else if (max_ratio >= 4) {\r\ndto_phase = 96 * 1000;\r\nwallclock_ratio = 2;\r\n} else if (max_ratio >= 2) {\r\ndto_phase = 48 * 1000;\r\nwallclock_ratio = 1;\r\n} else {\r\ndto_phase = 24 * 1000;\r\nwallclock_ratio = 0;\r\n}\r\nif (dig->dig_encoder == 0) {\r\ndto_cntl = RREG32(DCCG_AUDIO_DTO0_CNTL) & ~DCCG_AUDIO_DTO_WALLCLOCK_RATIO_MASK;\r\ndto_cntl |= DCCG_AUDIO_DTO_WALLCLOCK_RATIO(wallclock_ratio);\r\nWREG32(DCCG_AUDIO_DTO0_CNTL, dto_cntl);\r\nWREG32(DCCG_AUDIO_DTO0_PHASE, dto_phase);\r\nWREG32(DCCG_AUDIO_DTO0_MODULE, clock);\r\nWREG32(DCCG_AUDIO_DTO_SELECT, 0);\r\n} else {\r\ndto_cntl = RREG32(DCCG_AUDIO_DTO1_CNTL) & ~DCCG_AUDIO_DTO_WALLCLOCK_RATIO_MASK;\r\ndto_cntl |= DCCG_AUDIO_DTO_WALLCLOCK_RATIO(wallclock_ratio);\r\nWREG32(DCCG_AUDIO_DTO1_CNTL, dto_cntl);\r\nWREG32(DCCG_AUDIO_DTO1_PHASE, dto_phase);\r\nWREG32(DCCG_AUDIO_DTO1_MODULE, clock);\r\nWREG32(DCCG_AUDIO_DTO_SELECT, 1);\r\n}\r\n}\r\nvoid dce3_2_hdmi_update_acr(struct drm_encoder *encoder, long offset,\r\nconst struct radeon_hdmi_acr *acr)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nWREG32(DCE3_HDMI0_ACR_PACKET_CONTROL + offset,\r\nHDMI0_ACR_SOURCE |\r\nHDMI0_ACR_AUTO_SEND);\r\nWREG32_P(HDMI0_ACR_32_0 + offset,\r\nHDMI0_ACR_CTS_32(acr->cts_32khz),\r\n~HDMI0_ACR_CTS_32_MASK);\r\nWREG32_P(HDMI0_ACR_32_1 + offset,\r\nHDMI0_ACR_N_32(acr->n_32khz),\r\n~HDMI0_ACR_N_32_MASK);\r\nWREG32_P(HDMI0_ACR_44_0 + offset,\r\nHDMI0_ACR_CTS_44(acr->cts_44_1khz),\r\n~HDMI0_ACR_CTS_44_MASK);\r\nWREG32_P(HDMI0_ACR_44_1 + offset,\r\nHDMI0_ACR_N_44(acr->n_44_1khz),\r\n~HDMI0_ACR_N_44_MASK);\r\nWREG32_P(HDMI0_ACR_48_0 + offset,\r\nHDMI0_ACR_CTS_48(acr->cts_48khz),\r\n~HDMI0_ACR_CTS_48_MASK);\r\nWREG32_P(HDMI0_ACR_48_1 + offset,\r\nHDMI0_ACR_N_48(acr->n_48khz),\r\n~HDMI0_ACR_N_48_MASK);\r\n}\r\nvoid dce3_2_set_audio_packet(struct drm_encoder *encoder, u32 offset)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nWREG32(HDMI0_AUDIO_PACKET_CONTROL + offset,\r\nHDMI0_AUDIO_DELAY_EN(1) |\r\nHDMI0_AUDIO_PACKETS_PER_LINE(3));\r\nWREG32(AFMT_AUDIO_PACKET_CONTROL + offset,\r\nAFMT_AUDIO_SAMPLE_SEND |\r\nAFMT_60958_CS_UPDATE);\r\nWREG32_OR(HDMI0_INFOFRAME_CONTROL0 + offset,\r\nHDMI0_AUDIO_INFO_SEND |\r\nHDMI0_AUDIO_INFO_CONT);\r\nWREG32_OR(HDMI0_INFOFRAME_CONTROL1 + offset,\r\nHDMI0_AUDIO_INFO_LINE(2));\r\n}\r\nvoid dce3_2_set_mute(struct drm_encoder *encoder, u32 offset, bool mute)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nif (mute)\r\nWREG32_OR(HDMI0_GC + offset, HDMI0_GC_AVMUTE);\r\nelse\r\nWREG32_AND(HDMI0_GC + offset, ~HDMI0_GC_AVMUTE);\r\n}

static void phy_write_exp(struct phy_device *phydev,\r\nu16 reg, u16 value)\r\n{\r\nphy_write(phydev, MII_BCM54XX_EXP_SEL, MII_BCM54XX_EXP_SEL_ER | reg);\r\nphy_write(phydev, MII_BCM54XX_EXP_DATA, value);\r\n}\r\nstatic void phy_write_misc(struct phy_device *phydev,\r\nu16 reg, u16 chl, u16 value)\r\n{\r\nint tmp;\r\nphy_write(phydev, MII_BCM54XX_AUX_CTL, MII_BCM54XX_AUXCTL_SHDWSEL_MISC);\r\ntmp = phy_read(phydev, MII_BCM54XX_AUX_CTL);\r\ntmp |= MII_BCM54XX_AUXCTL_ACTL_SMDSP_ENA;\r\nphy_write(phydev, MII_BCM54XX_AUX_CTL, tmp);\r\ntmp = (chl * MII_BCM7XXX_CHANNEL_WIDTH) | reg;\r\nphy_write(phydev, MII_BCM54XX_EXP_SEL, tmp);\r\nphy_write(phydev, MII_BCM54XX_EXP_DATA, value);\r\n}\r\nstatic void r_rc_cal_reset(struct phy_device *phydev)\r\n{\r\nphy_write_exp(phydev, 0x00b0, 0x0010);\r\nphy_write_exp(phydev, 0x00b0, 0x0000);\r\n}\r\nstatic int bcm7xxx_28nm_b0_afe_config_init(struct phy_device *phydev)\r\n{\r\nphy_write_misc(phydev, PLL_PLLCTRL_1, 0x0048);\r\nphy_write_misc(phydev, PLL_PLLCTRL_2, 0x021b);\r\nphy_write_misc(phydev, PLL_PLLCTRL_4, 0x0e20);\r\nphy_write_misc(phydev, DSP_TAP10, 0x690b);\r\nphy_write(phydev, MII_BCM7XXX_CORE_BASE1E, 0xd);\r\nr_rc_cal_reset(phydev);\r\nphy_write_misc(phydev, AFE_RXCONFIG_0, 0xeb19);\r\nphy_write_misc(phydev, AFE_RXCONFIG_1, 0x9a3f);\r\nphy_write_misc(phydev, AFE_RX_LP_COUNTER, 0x7fc0);\r\nphy_write_misc(phydev, AFE_HPF_TRIM_OTHERS, 0x000b);\r\nphy_write_misc(phydev, AFE_TX_CONFIG, 0x0800);\r\nreturn 0;\r\n}\r\nstatic int bcm7xxx_28nm_d0_afe_config_init(struct phy_device *phydev)\r\n{\r\nphy_write_misc(phydev, AFE_RXCONFIG_0, 0xeb15);\r\nphy_write_misc(phydev, AFE_RXCONFIG_1, 0x9b2f);\r\nphy_write_misc(phydev, AFE_RXCONFIG_2, 0x2003);\r\nphy_write_misc(phydev, AFE_RX_LP_COUNTER, 0x7fc0);\r\nphy_write_misc(phydev, AFE_TX_CONFIG, 0x431);\r\nphy_write_misc(phydev, AFE_VDCA_ICTRL_0, 0xa7da);\r\nphy_write_misc(phydev, AFE_VDAC_OTHERS_0, 0xa020);\r\nphy_write_misc(phydev, AFE_HPF_TRIM_OTHERS, 0x00e3);\r\nphy_write(phydev, MII_BCM7XXX_CORE_BASE1E, 0x0010);\r\nphy_write_misc(phydev, DSP_TAP10, 0x011b);\r\nr_rc_cal_reset(phydev);\r\nreturn 0;\r\n}\r\nstatic int bcm7xxx_28nm_e0_plus_afe_config_init(struct phy_device *phydev)\r\n{\r\nphy_write_misc(phydev, AFE_RXCONFIG_1, 0x9b2f);\r\nphy_write_misc(phydev, AFE_TX_CONFIG, 0x431);\r\nphy_write_misc(phydev, AFE_VDCA_ICTRL_0, 0xa7da);\r\nphy_write_misc(phydev, AFE_HPF_TRIM_OTHERS, 0x00e3);\r\nphy_write(phydev, MII_BCM7XXX_CORE_BASE1E, 0x0010);\r\nphy_write_misc(phydev, DSP_TAP10, 0x011b);\r\nr_rc_cal_reset(phydev);\r\nreturn 0;\r\n}\r\nstatic int bcm7xxx_apd_enable(struct phy_device *phydev)\r\n{\r\nint val;\r\nval = bcm54xx_shadow_read(phydev, BCM54XX_SHD_SCR3);\r\nif (val < 0)\r\nreturn val;\r\nval |= BCM54XX_SHD_SCR3_DLLAPD_DIS;\r\nbcm54xx_shadow_write(phydev, BCM54XX_SHD_SCR3, val);\r\nval = bcm54xx_shadow_read(phydev, BCM54XX_SHD_APD);\r\nif (val < 0)\r\nreturn val;\r\nval |= BCM54XX_SHD_APD_EN;\r\nreturn bcm54xx_shadow_write(phydev, BCM54XX_SHD_APD, val);\r\n}\r\nstatic int bcm7xxx_eee_enable(struct phy_device *phydev)\r\n{\r\nint val;\r\nval = phy_read_mmd_indirect(phydev, BRCM_CL45VEN_EEE_CONTROL,\r\nMDIO_MMD_AN, phydev->addr);\r\nif (val < 0)\r\nreturn val;\r\nval |= LPI_FEATURE_EN | LPI_FEATURE_EN_DIG1000X;\r\nphy_write_mmd_indirect(phydev, BRCM_CL45VEN_EEE_CONTROL,\r\nMDIO_MMD_AN, phydev->addr, val);\r\nval = phy_read_mmd_indirect(phydev, MDIO_AN_EEE_ADV,\r\nMDIO_MMD_AN, phydev->addr);\r\nval |= (MDIO_AN_EEE_ADV_100TX | MDIO_AN_EEE_ADV_1000T);\r\nphy_write_mmd_indirect(phydev, MDIO_AN_EEE_ADV,\r\nMDIO_MMD_AN, phydev->addr, val);\r\nreturn 0;\r\n}\r\nstatic int bcm7xxx_28nm_config_init(struct phy_device *phydev)\r\n{\r\nu8 rev = PHY_BRCM_7XXX_REV(phydev->dev_flags);\r\nu8 patch = PHY_BRCM_7XXX_PATCH(phydev->dev_flags);\r\nint ret = 0;\r\npr_info_once("%s: %s PHY revision: 0x%02x, patch: %d\n",\r\ndev_name(&phydev->dev), phydev->drv->name, rev, patch);\r\nphy_read(phydev, MII_BMSR);\r\nswitch (rev) {\r\ncase 0xb0:\r\nret = bcm7xxx_28nm_b0_afe_config_init(phydev);\r\nbreak;\r\ncase 0xd0:\r\nret = bcm7xxx_28nm_d0_afe_config_init(phydev);\r\nbreak;\r\ncase 0xe0:\r\ncase 0xf0:\r\ncase 0x10:\r\nret = bcm7xxx_28nm_e0_plus_afe_config_init(phydev);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (ret)\r\nreturn ret;\r\nret = bcm7xxx_eee_enable(phydev);\r\nif (ret)\r\nreturn ret;\r\nreturn bcm7xxx_apd_enable(phydev);\r\n}\r\nstatic int bcm7xxx_28nm_resume(struct phy_device *phydev)\r\n{\r\nint ret;\r\nret = bcm7xxx_28nm_config_init(phydev);\r\nif (ret)\r\nreturn ret;\r\nreturn genphy_config_aneg(phydev);\r\n}\r\nstatic int phy_set_clr_bits(struct phy_device *dev, int location,\r\nint set_mask, int clr_mask)\r\n{\r\nint v, ret;\r\nv = phy_read(dev, location);\r\nif (v < 0)\r\nreturn v;\r\nv &= ~clr_mask;\r\nv |= set_mask;\r\nret = phy_write(dev, location, v);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn v;\r\n}\r\nstatic int bcm7xxx_config_init(struct phy_device *phydev)\r\n{\r\nint ret;\r\nphy_write(phydev, MII_BCM7XXX_AUX_MODE, MII_BCM7XX_64CLK_MDIO);\r\nphy_read(phydev, MII_BCM7XXX_AUX_MODE);\r\nif (phydev->supported & PHY_GBIT_FEATURES)\r\nreturn 0;\r\nret = phy_set_clr_bits(phydev, MII_BCM7XXX_TEST,\r\nMII_BCM7XXX_SHD_MODE_2, MII_BCM7XXX_SHD_MODE_2);\r\nif (ret < 0)\r\nreturn ret;\r\nphy_write(phydev, MII_BCM7XXX_100TX_DISC, 0x0F00);\r\nudelay(10);\r\nphy_write(phydev, MII_BCM7XXX_100TX_DISC, 0x0C00);\r\nphy_write(phydev, MII_BCM7XXX_100TX_FALSE_CAR, 0x7555);\r\nret = phy_set_clr_bits(phydev, MII_BCM7XXX_TEST, MII_BCM7XXX_SHD_MODE_2, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int bcm7xxx_suspend(struct phy_device *phydev)\r\n{\r\nint ret;\r\nconst struct bcm7xxx_regs {\r\nint reg;\r\nu16 value;\r\n} bcm7xxx_suspend_cfg[] = {\r\n{ MII_BCM7XXX_TEST, 0x008b },\r\n{ MII_BCM7XXX_100TX_AUX_CTL, 0x01c0 },\r\n{ MII_BCM7XXX_100TX_DISC, 0x7000 },\r\n{ MII_BCM7XXX_TEST, 0x000f },\r\n{ MII_BCM7XXX_100TX_AUX_CTL, 0x20d0 },\r\n{ MII_BCM7XXX_TEST, 0x000b },\r\n};\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(bcm7xxx_suspend_cfg); i++) {\r\nret = phy_write(phydev,\r\nbcm7xxx_suspend_cfg[i].reg,\r\nbcm7xxx_suspend_cfg[i].value);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bcm7xxx_dummy_config_init(struct phy_device *phydev)\r\n{\r\nreturn 0;\r\n}

static int jsm_probe_one(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nint rc = 0;\r\nstruct jsm_board *brd;\r\nstatic int adapter_count;\r\nrc = pci_enable_device(pdev);\r\nif (rc) {\r\ndev_err(&pdev->dev, "Device enable FAILED\n");\r\ngoto out;\r\n}\r\nrc = pci_request_regions(pdev, "jsm");\r\nif (rc) {\r\ndev_err(&pdev->dev, "pci_request_region FAILED\n");\r\ngoto out_disable_device;\r\n}\r\nbrd = kzalloc(sizeof(*brd), GFP_KERNEL);\r\nif (!brd) {\r\nrc = -ENOMEM;\r\ngoto out_release_regions;\r\n}\r\nbrd->boardnum = adapter_count++;\r\nbrd->pci_dev = pdev;\r\nswitch (pdev->device) {\r\ncase PCI_DEVICE_ID_NEO_2DB9:\r\ncase PCI_DEVICE_ID_NEO_2DB9PRI:\r\ncase PCI_DEVICE_ID_NEO_2RJ45:\r\ncase PCI_DEVICE_ID_NEO_2RJ45PRI:\r\ncase PCI_DEVICE_ID_NEO_2_422_485:\r\nbrd->maxports = 2;\r\nbreak;\r\ncase PCI_DEVICE_ID_CLASSIC_4:\r\ncase PCI_DEVICE_ID_CLASSIC_4_422:\r\ncase PCI_DEVICE_ID_NEO_4:\r\ncase PCIE_DEVICE_ID_NEO_4:\r\ncase PCIE_DEVICE_ID_NEO_4RJ45:\r\ncase PCIE_DEVICE_ID_NEO_4_IBM:\r\nbrd->maxports = 4;\r\nbreak;\r\ncase PCI_DEVICE_ID_CLASSIC_8:\r\ncase PCI_DEVICE_ID_CLASSIC_8_422:\r\ncase PCI_DEVICE_ID_DIGI_NEO_8:\r\ncase PCIE_DEVICE_ID_NEO_8:\r\ncase PCIE_DEVICE_ID_NEO_8RJ45:\r\nbrd->maxports = 8;\r\nbreak;\r\ndefault:\r\nbrd->maxports = 1;\r\nbreak;\r\n}\r\nspin_lock_init(&brd->bd_intr_lock);\r\nbrd->rev = pdev->revision;\r\nbrd->irq = pdev->irq;\r\nswitch (pdev->device) {\r\ncase PCI_DEVICE_ID_CLASSIC_4:\r\ncase PCI_DEVICE_ID_CLASSIC_4_422:\r\ncase PCI_DEVICE_ID_CLASSIC_8:\r\ncase PCI_DEVICE_ID_CLASSIC_8_422:\r\njsm_dbg(INIT, &brd->pci_dev,\r\n"jsm_found_board - Classic adapter\n");\r\nbrd->membase = pci_resource_start(pdev, 4);\r\nbrd->membase_end = pci_resource_end(pdev, 4);\r\nif (brd->membase & 0x1)\r\nbrd->membase &= ~0x3;\r\nelse\r\nbrd->membase &= ~0xF;\r\nbrd->iobase = pci_resource_start(pdev, 1);\r\nbrd->iobase_end = pci_resource_end(pdev, 1);\r\nbrd->iobase = ((unsigned int)(brd->iobase)) & 0xFFFE;\r\nbrd->bd_ops = &jsm_cls_ops;\r\nbrd->bd_uart_offset = 0x8;\r\nbrd->bd_dividend = 921600;\r\nbrd->re_map_membase = ioremap(brd->membase,\r\npci_resource_len(pdev, 4));\r\nif (!brd->re_map_membase) {\r\ndev_err(&pdev->dev,\r\n"Card has no PCI Memory resources, failing board.\n");\r\nrc = -ENOMEM;\r\ngoto out_kfree_brd;\r\n}\r\noutb(0x43, brd->iobase + 0x4c);\r\nbreak;\r\ncase PCI_DEVICE_ID_NEO_2DB9:\r\ncase PCI_DEVICE_ID_NEO_2DB9PRI:\r\ncase PCI_DEVICE_ID_NEO_2RJ45:\r\ncase PCI_DEVICE_ID_NEO_2RJ45PRI:\r\ncase PCI_DEVICE_ID_NEO_2_422_485:\r\ncase PCI_DEVICE_ID_NEO_4:\r\ncase PCIE_DEVICE_ID_NEO_4:\r\ncase PCIE_DEVICE_ID_NEO_4RJ45:\r\ncase PCIE_DEVICE_ID_NEO_4_IBM:\r\ncase PCI_DEVICE_ID_DIGI_NEO_8:\r\ncase PCIE_DEVICE_ID_NEO_8:\r\ncase PCIE_DEVICE_ID_NEO_8RJ45:\r\njsm_dbg(INIT, &brd->pci_dev, "jsm_found_board - NEO adapter\n");\r\nbrd->membase = pci_resource_start(pdev, 0);\r\nbrd->membase_end = pci_resource_end(pdev, 0);\r\nif (brd->membase & 1)\r\nbrd->membase &= ~0x3;\r\nelse\r\nbrd->membase &= ~0xF;\r\nbrd->bd_ops = &jsm_neo_ops;\r\nbrd->bd_uart_offset = 0x200;\r\nbrd->bd_dividend = 921600;\r\nbrd->re_map_membase = ioremap(brd->membase,\r\npci_resource_len(pdev, 0));\r\nif (!brd->re_map_membase) {\r\ndev_err(&pdev->dev,\r\n"Card has no PCI Memory resources, failing board.\n");\r\nrc = -ENOMEM;\r\ngoto out_kfree_brd;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -ENXIO;\r\n}\r\nrc = request_irq(brd->irq, brd->bd_ops->intr, IRQF_SHARED, "JSM", brd);\r\nif (rc) {\r\ndev_warn(&pdev->dev, "Failed to hook IRQ %d\n", brd->irq);\r\ngoto out_iounmap;\r\n}\r\nrc = jsm_tty_init(brd);\r\nif (rc < 0) {\r\ndev_err(&pdev->dev, "Can't init tty devices (%d)\n", rc);\r\nrc = -ENXIO;\r\ngoto out_free_irq;\r\n}\r\nrc = jsm_uart_port_init(brd);\r\nif (rc < 0) {\r\ndev_err(&pdev->dev, "Can't init uart port (%d)\n", rc);\r\nrc = -ENXIO;\r\ngoto out_free_irq;\r\n}\r\ndev_info(&pdev->dev, "board %d: Digi Classic/Neo (rev %d), irq %d\n",\r\nadapter_count, brd->rev, brd->irq);\r\npci_set_drvdata(pdev, brd);\r\npci_save_state(pdev);\r\nreturn 0;\r\nout_free_irq:\r\njsm_remove_uart_port(brd);\r\nfree_irq(brd->irq, brd);\r\nout_iounmap:\r\niounmap(brd->re_map_membase);\r\nout_kfree_brd:\r\nkfree(brd);\r\nout_release_regions:\r\npci_release_regions(pdev);\r\nout_disable_device:\r\npci_disable_device(pdev);\r\nout:\r\nreturn rc;\r\n}\r\nstatic void jsm_remove_one(struct pci_dev *pdev)\r\n{\r\nstruct jsm_board *brd = pci_get_drvdata(pdev);\r\nint i = 0;\r\nswitch (pdev->device) {\r\ncase PCI_DEVICE_ID_CLASSIC_4:\r\ncase PCI_DEVICE_ID_CLASSIC_4_422:\r\ncase PCI_DEVICE_ID_CLASSIC_8:\r\ncase PCI_DEVICE_ID_CLASSIC_8_422:\r\noutb(0x0, brd->iobase + 0x4c);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\njsm_remove_uart_port(brd);\r\nfree_irq(brd->irq, brd);\r\niounmap(brd->re_map_membase);\r\nfor (i = 0; i < brd->maxports; i++) {\r\nif (brd->channels[i]) {\r\nkfree(brd->channels[i]->ch_rqueue);\r\nkfree(brd->channels[i]->ch_equeue);\r\nkfree(brd->channels[i]);\r\n}\r\n}\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\nkfree(brd);\r\n}\r\nstatic pci_ers_result_t jsm_io_error_detected(struct pci_dev *pdev,\r\npci_channel_state_t state)\r\n{\r\nstruct jsm_board *brd = pci_get_drvdata(pdev);\r\njsm_remove_uart_port(brd);\r\nreturn PCI_ERS_RESULT_NEED_RESET;\r\n}\r\nstatic pci_ers_result_t jsm_io_slot_reset(struct pci_dev *pdev)\r\n{\r\nint rc;\r\nrc = pci_enable_device(pdev);\r\nif (rc)\r\nreturn PCI_ERS_RESULT_DISCONNECT;\r\npci_set_master(pdev);\r\nreturn PCI_ERS_RESULT_RECOVERED;\r\n}\r\nstatic void jsm_io_resume(struct pci_dev *pdev)\r\n{\r\nstruct jsm_board *brd = pci_get_drvdata(pdev);\r\npci_restore_state(pdev);\r\npci_save_state(pdev);\r\njsm_uart_port_init(brd);\r\n}\r\nstatic int __init jsm_init_module(void)\r\n{\r\nint rc;\r\nrc = uart_register_driver(&jsm_uart_driver);\r\nif (!rc) {\r\nrc = pci_register_driver(&jsm_driver);\r\nif (rc)\r\nuart_unregister_driver(&jsm_uart_driver);\r\n}\r\nreturn rc;\r\n}\r\nstatic void __exit jsm_exit_module(void)\r\n{\r\npci_unregister_driver(&jsm_driver);\r\nuart_unregister_driver(&jsm_uart_driver);\r\n}

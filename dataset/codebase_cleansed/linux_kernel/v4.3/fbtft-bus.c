void fbtft_write_reg8_bus9(struct fbtft_par *par, int len, ...)\r\n{\r\nva_list args;\r\nint i, ret;\r\nint pad = 0;\r\nu16 *buf = (u16 *)par->buf;\r\nif (unlikely(par->debug & DEBUG_WRITE_REGISTER)) {\r\nva_start(args, len);\r\nfor (i = 0; i < len; i++)\r\n*(((u8 *)buf) + i) = (u8)va_arg(args, unsigned int);\r\nva_end(args);\r\nfbtft_par_dbg_hex(DEBUG_WRITE_REGISTER, par,\r\npar->info->device, u8, buf, len, "%s: ", __func__);\r\n}\r\nif (len <= 0)\r\nreturn;\r\nif (par->spi && (par->spi->bits_per_word == 8)) {\r\npad = (len % 4) ? 4 - (len % 4) : 0;\r\nfor (i = 0; i < pad; i++)\r\n*buf++ = 0x000;\r\n}\r\nva_start(args, len);\r\n*buf++ = (u8)va_arg(args, unsigned int);\r\ni = len - 1;\r\nwhile (i--) {\r\n*buf = (u8)va_arg(args, unsigned int);\r\n*buf++ |= 0x100;\r\n}\r\nva_end(args);\r\nret = par->fbtftops.write(par, par->buf, (len + pad) * sizeof(u16));\r\nif (ret < 0) {\r\ndev_err(par->info->device,\r\n"write() failed and returned %d\n", ret);\r\nreturn;\r\n}\r\n}\r\nint fbtft_write_vmem16_bus8(struct fbtft_par *par, size_t offset, size_t len)\r\n{\r\nu16 *vmem16;\r\nu16 *txbuf16 = (u16 *)par->txbuf.buf;\r\nsize_t remain;\r\nsize_t to_copy;\r\nsize_t tx_array_size;\r\nint i;\r\nint ret = 0;\r\nsize_t startbyte_size = 0;\r\nfbtft_par_dbg(DEBUG_WRITE_VMEM, par, "%s(offset=%zu, len=%zu)\n",\r\n__func__, offset, len);\r\nremain = len / 2;\r\nvmem16 = (u16 *)(par->info->screen_base + offset);\r\nif (par->gpio.dc != -1)\r\ngpio_set_value(par->gpio.dc, 1);\r\nif (!par->txbuf.buf)\r\nreturn par->fbtftops.write(par, vmem16, len);\r\ntx_array_size = par->txbuf.len / 2;\r\nif (par->startbyte) {\r\ntxbuf16 = (u16 *)(par->txbuf.buf + 1);\r\ntx_array_size -= 2;\r\n*(u8 *)(par->txbuf.buf) = par->startbyte | 0x2;\r\nstartbyte_size = 1;\r\n}\r\nwhile (remain) {\r\nto_copy = remain > tx_array_size ? tx_array_size : remain;\r\ndev_dbg(par->info->device, " to_copy=%zu, remain=%zu\n",\r\nto_copy, remain - to_copy);\r\nfor (i = 0; i < to_copy; i++)\r\ntxbuf16[i] = cpu_to_be16(vmem16[i]);\r\nvmem16 = vmem16 + to_copy;\r\nret = par->fbtftops.write(par, par->txbuf.buf,\r\nstartbyte_size + to_copy * 2);\r\nif (ret < 0)\r\nreturn ret;\r\nremain -= to_copy;\r\n}\r\nreturn ret;\r\n}\r\nint fbtft_write_vmem16_bus9(struct fbtft_par *par, size_t offset, size_t len)\r\n{\r\nu8 __iomem *vmem8;\r\nu16 *txbuf16 = par->txbuf.buf;\r\nsize_t remain;\r\nsize_t to_copy;\r\nsize_t tx_array_size;\r\nint i;\r\nint ret = 0;\r\nfbtft_par_dbg(DEBUG_WRITE_VMEM, par, "%s(offset=%zu, len=%zu)\n",\r\n__func__, offset, len);\r\nif (!par->txbuf.buf) {\r\ndev_err(par->info->device, "%s: txbuf.buf is NULL\n", __func__);\r\nreturn -1;\r\n}\r\nremain = len;\r\nvmem8 = par->info->screen_base + offset;\r\ntx_array_size = par->txbuf.len / 2;\r\nwhile (remain) {\r\nto_copy = remain > tx_array_size ? tx_array_size : remain;\r\ndev_dbg(par->info->device, " to_copy=%zu, remain=%zu\n",\r\nto_copy, remain - to_copy);\r\n#ifdef __LITTLE_ENDIAN\r\nfor (i = 0; i < to_copy; i += 2) {\r\ntxbuf16[i] = 0x0100 | ioread8(vmem8 + i + 1);\r\ntxbuf16[i + 1] = 0x0100 | ioread8(vmem8 + i);\r\n}\r\n#else\r\nfor (i = 0; i < to_copy; i++)\r\ntxbuf16[i] = 0x0100 | ioread8(vmem8 + i);\r\n#endif\r\nvmem8 = vmem8 + to_copy;\r\nret = par->fbtftops.write(par, par->txbuf.buf, to_copy*2);\r\nif (ret < 0)\r\nreturn ret;\r\nremain -= to_copy;\r\n}\r\nreturn ret;\r\n}\r\nint fbtft_write_vmem8_bus8(struct fbtft_par *par, size_t offset, size_t len)\r\n{\r\ndev_err(par->info->device, "%s: function not implemented\n", __func__);\r\nreturn -1;\r\n}\r\nint fbtft_write_vmem16_bus16(struct fbtft_par *par, size_t offset, size_t len)\r\n{\r\nu16 *vmem16;\r\nfbtft_par_dbg(DEBUG_WRITE_VMEM, par, "%s(offset=%zu, len=%zu)\n",\r\n__func__, offset, len);\r\nvmem16 = (u16 *)(par->info->screen_base + offset);\r\nif (par->gpio.dc != -1)\r\ngpio_set_value(par->gpio.dc, 1);\r\nreturn par->fbtftops.write(par, vmem16, len);\r\n}

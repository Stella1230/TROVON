static int ocrdma_add_stat(char *start, char *pcur,\r\nchar *name, u64 count)\r\n{\r\nchar buff[128] = {0};\r\nint cpy_len = 0;\r\nsnprintf(buff, 128, "%s: %llu\n", name, count);\r\ncpy_len = strlen(buff);\r\nif (pcur + cpy_len > start + OCRDMA_MAX_DBGFS_MEM) {\r\npr_err("%s: No space in stats buff\n", __func__);\r\nreturn 0;\r\n}\r\nmemcpy(pcur, buff, cpy_len);\r\nreturn cpy_len;\r\n}\r\nstatic bool ocrdma_alloc_stats_mem(struct ocrdma_dev *dev)\r\n{\r\nstruct stats_mem *mem = &dev->stats_mem;\r\nmem->size = max_t(u32, sizeof(struct ocrdma_rdma_stats_req),\r\nsizeof(struct ocrdma_rdma_stats_resp));\r\nmem->va = dma_alloc_coherent(&dev->nic_info.pdev->dev, mem->size,\r\n&mem->pa, GFP_KERNEL);\r\nif (!mem->va) {\r\npr_err("%s: stats mbox allocation failed\n", __func__);\r\nreturn false;\r\n}\r\nmemset(mem->va, 0, mem->size);\r\nmem->debugfs_mem = kzalloc(OCRDMA_MAX_DBGFS_MEM, GFP_KERNEL);\r\nif (!mem->debugfs_mem) {\r\npr_err("%s: stats debugfs mem allocation failed\n", __func__);\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic void ocrdma_release_stats_mem(struct ocrdma_dev *dev)\r\n{\r\nstruct stats_mem *mem = &dev->stats_mem;\r\nif (mem->va)\r\ndma_free_coherent(&dev->nic_info.pdev->dev, mem->size,\r\nmem->va, mem->pa);\r\nkfree(mem->debugfs_mem);\r\n}\r\nstatic char *ocrdma_resource_stats(struct ocrdma_dev *dev)\r\n{\r\nchar *stats = dev->stats_mem.debugfs_mem, *pcur;\r\nstruct ocrdma_rdma_stats_resp *rdma_stats =\r\n(struct ocrdma_rdma_stats_resp *)dev->stats_mem.va;\r\nstruct ocrdma_rsrc_stats *rsrc_stats = &rdma_stats->act_rsrc_stats;\r\nmemset(stats, 0, (OCRDMA_MAX_DBGFS_MEM));\r\npcur = stats;\r\npcur += ocrdma_add_stat(stats, pcur, "active_dpp_pds",\r\n(u64)rsrc_stats->dpp_pds);\r\npcur += ocrdma_add_stat(stats, pcur, "active_non_dpp_pds",\r\n(u64)rsrc_stats->non_dpp_pds);\r\npcur += ocrdma_add_stat(stats, pcur, "active_rc_dpp_qps",\r\n(u64)rsrc_stats->rc_dpp_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "active_uc_dpp_qps",\r\n(u64)rsrc_stats->uc_dpp_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "active_ud_dpp_qps",\r\n(u64)rsrc_stats->ud_dpp_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "active_rc_non_dpp_qps",\r\n(u64)rsrc_stats->rc_non_dpp_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "active_uc_non_dpp_qps",\r\n(u64)rsrc_stats->uc_non_dpp_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "active_ud_non_dpp_qps",\r\n(u64)rsrc_stats->ud_non_dpp_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "active_srqs",\r\n(u64)rsrc_stats->srqs);\r\npcur += ocrdma_add_stat(stats, pcur, "active_rbqs",\r\n(u64)rsrc_stats->rbqs);\r\npcur += ocrdma_add_stat(stats, pcur, "active_64K_nsmr",\r\n(u64)rsrc_stats->r64K_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "active_64K_to_2M_nsmr",\r\n(u64)rsrc_stats->r64K_to_2M_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "active_2M_to_44M_nsmr",\r\n(u64)rsrc_stats->r2M_to_44M_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "active_44M_to_1G_nsmr",\r\n(u64)rsrc_stats->r44M_to_1G_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "active_1G_to_4G_nsmr",\r\n(u64)rsrc_stats->r1G_to_4G_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "active_nsmr_count_4G_to_32G",\r\n(u64)rsrc_stats->nsmr_count_4G_to_32G);\r\npcur += ocrdma_add_stat(stats, pcur, "active_32G_to_64G_nsmr",\r\n(u64)rsrc_stats->r32G_to_64G_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "active_64G_to_128G_nsmr",\r\n(u64)rsrc_stats->r64G_to_128G_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "active_128G_to_higher_nsmr",\r\n(u64)rsrc_stats->r128G_to_higher_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "active_embedded_nsmr",\r\n(u64)rsrc_stats->embedded_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "active_frmr",\r\n(u64)rsrc_stats->frmr);\r\npcur += ocrdma_add_stat(stats, pcur, "active_prefetch_qps",\r\n(u64)rsrc_stats->prefetch_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "active_ondemand_qps",\r\n(u64)rsrc_stats->ondemand_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "active_phy_mr",\r\n(u64)rsrc_stats->phy_mr);\r\npcur += ocrdma_add_stat(stats, pcur, "active_mw",\r\n(u64)rsrc_stats->mw);\r\nrsrc_stats = &rdma_stats->th_rsrc_stats;\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_dpp_pds",\r\n(u64)rsrc_stats->dpp_pds);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_non_dpp_pds",\r\n(u64)rsrc_stats->non_dpp_pds);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_rc_dpp_qps",\r\n(u64)rsrc_stats->rc_dpp_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_uc_dpp_qps",\r\n(u64)rsrc_stats->uc_dpp_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_ud_dpp_qps",\r\n(u64)rsrc_stats->ud_dpp_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_rc_non_dpp_qps",\r\n(u64)rsrc_stats->rc_non_dpp_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_uc_non_dpp_qps",\r\n(u64)rsrc_stats->uc_non_dpp_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_ud_non_dpp_qps",\r\n(u64)rsrc_stats->ud_non_dpp_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_srqs",\r\n(u64)rsrc_stats->srqs);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_rbqs",\r\n(u64)rsrc_stats->rbqs);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_64K_nsmr",\r\n(u64)rsrc_stats->r64K_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_64K_to_2M_nsmr",\r\n(u64)rsrc_stats->r64K_to_2M_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_2M_to_44M_nsmr",\r\n(u64)rsrc_stats->r2M_to_44M_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_44M_to_1G_nsmr",\r\n(u64)rsrc_stats->r44M_to_1G_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_1G_to_4G_nsmr",\r\n(u64)rsrc_stats->r1G_to_4G_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_nsmr_count_4G_to_32G",\r\n(u64)rsrc_stats->nsmr_count_4G_to_32G);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_32G_to_64G_nsmr",\r\n(u64)rsrc_stats->r32G_to_64G_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_64G_to_128G_nsmr",\r\n(u64)rsrc_stats->r64G_to_128G_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_128G_to_higher_nsmr",\r\n(u64)rsrc_stats->r128G_to_higher_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_embedded_nsmr",\r\n(u64)rsrc_stats->embedded_nsmr);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_frmr",\r\n(u64)rsrc_stats->frmr);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_prefetch_qps",\r\n(u64)rsrc_stats->prefetch_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_ondemand_qps",\r\n(u64)rsrc_stats->ondemand_qps);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_phy_mr",\r\n(u64)rsrc_stats->phy_mr);\r\npcur += ocrdma_add_stat(stats, pcur, "threshold_mw",\r\n(u64)rsrc_stats->mw);\r\nreturn stats;\r\n}\r\nstatic char *ocrdma_rx_stats(struct ocrdma_dev *dev)\r\n{\r\nchar *stats = dev->stats_mem.debugfs_mem, *pcur;\r\nstruct ocrdma_rdma_stats_resp *rdma_stats =\r\n(struct ocrdma_rdma_stats_resp *)dev->stats_mem.va;\r\nstruct ocrdma_rx_stats *rx_stats = &rdma_stats->rx_stats;\r\nmemset(stats, 0, (OCRDMA_MAX_DBGFS_MEM));\r\npcur = stats;\r\npcur += ocrdma_add_stat\r\n(stats, pcur, "roce_frame_bytes",\r\nconvert_to_64bit(rx_stats->roce_frame_bytes_lo,\r\nrx_stats->roce_frame_bytes_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "roce_frame_icrc_drops",\r\n(u64)rx_stats->roce_frame_icrc_drops);\r\npcur += ocrdma_add_stat(stats, pcur, "roce_frame_payload_len_drops",\r\n(u64)rx_stats->roce_frame_payload_len_drops);\r\npcur += ocrdma_add_stat(stats, pcur, "ud_drops",\r\n(u64)rx_stats->ud_drops);\r\npcur += ocrdma_add_stat(stats, pcur, "qp1_drops",\r\n(u64)rx_stats->qp1_drops);\r\npcur += ocrdma_add_stat(stats, pcur, "psn_error_request_packets",\r\n(u64)rx_stats->psn_error_request_packets);\r\npcur += ocrdma_add_stat(stats, pcur, "psn_error_resp_packets",\r\n(u64)rx_stats->psn_error_resp_packets);\r\npcur += ocrdma_add_stat(stats, pcur, "rnr_nak_timeouts",\r\n(u64)rx_stats->rnr_nak_timeouts);\r\npcur += ocrdma_add_stat(stats, pcur, "rnr_nak_receives",\r\n(u64)rx_stats->rnr_nak_receives);\r\npcur += ocrdma_add_stat(stats, pcur, "roce_frame_rxmt_drops",\r\n(u64)rx_stats->roce_frame_rxmt_drops);\r\npcur += ocrdma_add_stat(stats, pcur, "nak_count_psn_sequence_errors",\r\n(u64)rx_stats->nak_count_psn_sequence_errors);\r\npcur += ocrdma_add_stat(stats, pcur, "rc_drop_count_lookup_errors",\r\n(u64)rx_stats->rc_drop_count_lookup_errors);\r\npcur += ocrdma_add_stat(stats, pcur, "rq_rnr_naks",\r\n(u64)rx_stats->rq_rnr_naks);\r\npcur += ocrdma_add_stat(stats, pcur, "srq_rnr_naks",\r\n(u64)rx_stats->srq_rnr_naks);\r\npcur += ocrdma_add_stat(stats, pcur, "roce_frames",\r\nconvert_to_64bit(rx_stats->roce_frames_lo,\r\nrx_stats->roce_frames_hi));\r\nreturn stats;\r\n}\r\nstatic u64 ocrdma_sysfs_rcv_pkts(struct ocrdma_dev *dev)\r\n{\r\nstruct ocrdma_rdma_stats_resp *rdma_stats =\r\n(struct ocrdma_rdma_stats_resp *)dev->stats_mem.va;\r\nstruct ocrdma_rx_stats *rx_stats = &rdma_stats->rx_stats;\r\nreturn convert_to_64bit(rx_stats->roce_frames_lo,\r\nrx_stats->roce_frames_hi) + (u64)rx_stats->roce_frame_icrc_drops\r\n+ (u64)rx_stats->roce_frame_payload_len_drops;\r\n}\r\nstatic u64 ocrdma_sysfs_rcv_data(struct ocrdma_dev *dev)\r\n{\r\nstruct ocrdma_rdma_stats_resp *rdma_stats =\r\n(struct ocrdma_rdma_stats_resp *)dev->stats_mem.va;\r\nstruct ocrdma_rx_stats *rx_stats = &rdma_stats->rx_stats;\r\nreturn (convert_to_64bit(rx_stats->roce_frame_bytes_lo,\r\nrx_stats->roce_frame_bytes_hi))/4;\r\n}\r\nstatic char *ocrdma_tx_stats(struct ocrdma_dev *dev)\r\n{\r\nchar *stats = dev->stats_mem.debugfs_mem, *pcur;\r\nstruct ocrdma_rdma_stats_resp *rdma_stats =\r\n(struct ocrdma_rdma_stats_resp *)dev->stats_mem.va;\r\nstruct ocrdma_tx_stats *tx_stats = &rdma_stats->tx_stats;\r\nmemset(stats, 0, (OCRDMA_MAX_DBGFS_MEM));\r\npcur = stats;\r\npcur += ocrdma_add_stat(stats, pcur, "send_pkts",\r\nconvert_to_64bit(tx_stats->send_pkts_lo,\r\ntx_stats->send_pkts_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "write_pkts",\r\nconvert_to_64bit(tx_stats->write_pkts_lo,\r\ntx_stats->write_pkts_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "read_pkts",\r\nconvert_to_64bit(tx_stats->read_pkts_lo,\r\ntx_stats->read_pkts_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "read_rsp_pkts",\r\nconvert_to_64bit(tx_stats->read_rsp_pkts_lo,\r\ntx_stats->read_rsp_pkts_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "ack_pkts",\r\nconvert_to_64bit(tx_stats->ack_pkts_lo,\r\ntx_stats->ack_pkts_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "send_bytes",\r\nconvert_to_64bit(tx_stats->send_bytes_lo,\r\ntx_stats->send_bytes_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "write_bytes",\r\nconvert_to_64bit(tx_stats->write_bytes_lo,\r\ntx_stats->write_bytes_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "read_req_bytes",\r\nconvert_to_64bit(tx_stats->read_req_bytes_lo,\r\ntx_stats->read_req_bytes_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "read_rsp_bytes",\r\nconvert_to_64bit(tx_stats->read_rsp_bytes_lo,\r\ntx_stats->read_rsp_bytes_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "ack_timeouts",\r\n(u64)tx_stats->ack_timeouts);\r\nreturn stats;\r\n}\r\nstatic u64 ocrdma_sysfs_xmit_pkts(struct ocrdma_dev *dev)\r\n{\r\nstruct ocrdma_rdma_stats_resp *rdma_stats =\r\n(struct ocrdma_rdma_stats_resp *)dev->stats_mem.va;\r\nstruct ocrdma_tx_stats *tx_stats = &rdma_stats->tx_stats;\r\nreturn (convert_to_64bit(tx_stats->send_pkts_lo,\r\ntx_stats->send_pkts_hi) +\r\nconvert_to_64bit(tx_stats->write_pkts_lo, tx_stats->write_pkts_hi) +\r\nconvert_to_64bit(tx_stats->read_pkts_lo, tx_stats->read_pkts_hi) +\r\nconvert_to_64bit(tx_stats->read_rsp_pkts_lo,\r\ntx_stats->read_rsp_pkts_hi) +\r\nconvert_to_64bit(tx_stats->ack_pkts_lo, tx_stats->ack_pkts_hi));\r\n}\r\nstatic u64 ocrdma_sysfs_xmit_data(struct ocrdma_dev *dev)\r\n{\r\nstruct ocrdma_rdma_stats_resp *rdma_stats =\r\n(struct ocrdma_rdma_stats_resp *)dev->stats_mem.va;\r\nstruct ocrdma_tx_stats *tx_stats = &rdma_stats->tx_stats;\r\nreturn (convert_to_64bit(tx_stats->send_bytes_lo,\r\ntx_stats->send_bytes_hi) +\r\nconvert_to_64bit(tx_stats->write_bytes_lo,\r\ntx_stats->write_bytes_hi) +\r\nconvert_to_64bit(tx_stats->read_req_bytes_lo,\r\ntx_stats->read_req_bytes_hi) +\r\nconvert_to_64bit(tx_stats->read_rsp_bytes_lo,\r\ntx_stats->read_rsp_bytes_hi))/4;\r\n}\r\nstatic char *ocrdma_wqe_stats(struct ocrdma_dev *dev)\r\n{\r\nchar *stats = dev->stats_mem.debugfs_mem, *pcur;\r\nstruct ocrdma_rdma_stats_resp *rdma_stats =\r\n(struct ocrdma_rdma_stats_resp *)dev->stats_mem.va;\r\nstruct ocrdma_wqe_stats *wqe_stats = &rdma_stats->wqe_stats;\r\nmemset(stats, 0, (OCRDMA_MAX_DBGFS_MEM));\r\npcur = stats;\r\npcur += ocrdma_add_stat(stats, pcur, "large_send_rc_wqes",\r\nconvert_to_64bit(wqe_stats->large_send_rc_wqes_lo,\r\nwqe_stats->large_send_rc_wqes_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "large_write_rc_wqes",\r\nconvert_to_64bit(wqe_stats->large_write_rc_wqes_lo,\r\nwqe_stats->large_write_rc_wqes_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "read_wqes",\r\nconvert_to_64bit(wqe_stats->read_wqes_lo,\r\nwqe_stats->read_wqes_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "frmr_wqes",\r\nconvert_to_64bit(wqe_stats->frmr_wqes_lo,\r\nwqe_stats->frmr_wqes_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "mw_bind_wqes",\r\nconvert_to_64bit(wqe_stats->mw_bind_wqes_lo,\r\nwqe_stats->mw_bind_wqes_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "invalidate_wqes",\r\nconvert_to_64bit(wqe_stats->invalidate_wqes_lo,\r\nwqe_stats->invalidate_wqes_hi));\r\npcur += ocrdma_add_stat(stats, pcur, "dpp_wqe_drops",\r\n(u64)wqe_stats->dpp_wqe_drops);\r\nreturn stats;\r\n}\r\nstatic char *ocrdma_db_errstats(struct ocrdma_dev *dev)\r\n{\r\nchar *stats = dev->stats_mem.debugfs_mem, *pcur;\r\nstruct ocrdma_rdma_stats_resp *rdma_stats =\r\n(struct ocrdma_rdma_stats_resp *)dev->stats_mem.va;\r\nstruct ocrdma_db_err_stats *db_err_stats = &rdma_stats->db_err_stats;\r\nmemset(stats, 0, (OCRDMA_MAX_DBGFS_MEM));\r\npcur = stats;\r\npcur += ocrdma_add_stat(stats, pcur, "sq_doorbell_errors",\r\n(u64)db_err_stats->sq_doorbell_errors);\r\npcur += ocrdma_add_stat(stats, pcur, "cq_doorbell_errors",\r\n(u64)db_err_stats->cq_doorbell_errors);\r\npcur += ocrdma_add_stat(stats, pcur, "rq_srq_doorbell_errors",\r\n(u64)db_err_stats->rq_srq_doorbell_errors);\r\npcur += ocrdma_add_stat(stats, pcur, "cq_overflow_errors",\r\n(u64)db_err_stats->cq_overflow_errors);\r\nreturn stats;\r\n}\r\nstatic char *ocrdma_rxqp_errstats(struct ocrdma_dev *dev)\r\n{\r\nchar *stats = dev->stats_mem.debugfs_mem, *pcur;\r\nstruct ocrdma_rdma_stats_resp *rdma_stats =\r\n(struct ocrdma_rdma_stats_resp *)dev->stats_mem.va;\r\nstruct ocrdma_rx_qp_err_stats *rx_qp_err_stats =\r\n&rdma_stats->rx_qp_err_stats;\r\nmemset(stats, 0, (OCRDMA_MAX_DBGFS_MEM));\r\npcur = stats;\r\npcur += ocrdma_add_stat(stats, pcur, "nak_invalid_requst_errors",\r\n(u64)rx_qp_err_stats->nak_invalid_requst_errors);\r\npcur += ocrdma_add_stat(stats, pcur, "nak_remote_operation_errors",\r\n(u64)rx_qp_err_stats->nak_remote_operation_errors);\r\npcur += ocrdma_add_stat(stats, pcur, "nak_count_remote_access_errors",\r\n(u64)rx_qp_err_stats->nak_count_remote_access_errors);\r\npcur += ocrdma_add_stat(stats, pcur, "local_length_errors",\r\n(u64)rx_qp_err_stats->local_length_errors);\r\npcur += ocrdma_add_stat(stats, pcur, "local_protection_errors",\r\n(u64)rx_qp_err_stats->local_protection_errors);\r\npcur += ocrdma_add_stat(stats, pcur, "local_qp_operation_errors",\r\n(u64)rx_qp_err_stats->local_qp_operation_errors);\r\nreturn stats;\r\n}\r\nstatic char *ocrdma_txqp_errstats(struct ocrdma_dev *dev)\r\n{\r\nchar *stats = dev->stats_mem.debugfs_mem, *pcur;\r\nstruct ocrdma_rdma_stats_resp *rdma_stats =\r\n(struct ocrdma_rdma_stats_resp *)dev->stats_mem.va;\r\nstruct ocrdma_tx_qp_err_stats *tx_qp_err_stats =\r\n&rdma_stats->tx_qp_err_stats;\r\nmemset(stats, 0, (OCRDMA_MAX_DBGFS_MEM));\r\npcur = stats;\r\npcur += ocrdma_add_stat(stats, pcur, "local_length_errors",\r\n(u64)tx_qp_err_stats->local_length_errors);\r\npcur += ocrdma_add_stat(stats, pcur, "local_protection_errors",\r\n(u64)tx_qp_err_stats->local_protection_errors);\r\npcur += ocrdma_add_stat(stats, pcur, "local_qp_operation_errors",\r\n(u64)tx_qp_err_stats->local_qp_operation_errors);\r\npcur += ocrdma_add_stat(stats, pcur, "retry_count_exceeded_errors",\r\n(u64)tx_qp_err_stats->retry_count_exceeded_errors);\r\npcur += ocrdma_add_stat(stats, pcur, "rnr_retry_count_exceeded_errors",\r\n(u64)tx_qp_err_stats->rnr_retry_count_exceeded_errors);\r\nreturn stats;\r\n}\r\nstatic char *ocrdma_tx_dbg_stats(struct ocrdma_dev *dev)\r\n{\r\nint i;\r\nchar *pstats = dev->stats_mem.debugfs_mem;\r\nstruct ocrdma_rdma_stats_resp *rdma_stats =\r\n(struct ocrdma_rdma_stats_resp *)dev->stats_mem.va;\r\nstruct ocrdma_tx_dbg_stats *tx_dbg_stats =\r\n&rdma_stats->tx_dbg_stats;\r\nmemset(pstats, 0, (OCRDMA_MAX_DBGFS_MEM));\r\nfor (i = 0; i < 100; i++)\r\npstats += snprintf(pstats, 80, "DW[%d] = 0x%x\n", i,\r\ntx_dbg_stats->data[i]);\r\nreturn dev->stats_mem.debugfs_mem;\r\n}\r\nstatic char *ocrdma_rx_dbg_stats(struct ocrdma_dev *dev)\r\n{\r\nint i;\r\nchar *pstats = dev->stats_mem.debugfs_mem;\r\nstruct ocrdma_rdma_stats_resp *rdma_stats =\r\n(struct ocrdma_rdma_stats_resp *)dev->stats_mem.va;\r\nstruct ocrdma_rx_dbg_stats *rx_dbg_stats =\r\n&rdma_stats->rx_dbg_stats;\r\nmemset(pstats, 0, (OCRDMA_MAX_DBGFS_MEM));\r\nfor (i = 0; i < 200; i++)\r\npstats += snprintf(pstats, 80, "DW[%d] = 0x%x\n", i,\r\nrx_dbg_stats->data[i]);\r\nreturn dev->stats_mem.debugfs_mem;\r\n}\r\nstatic char *ocrdma_driver_dbg_stats(struct ocrdma_dev *dev)\r\n{\r\nchar *stats = dev->stats_mem.debugfs_mem, *pcur;\r\nmemset(stats, 0, (OCRDMA_MAX_DBGFS_MEM));\r\npcur = stats;\r\npcur += ocrdma_add_stat(stats, pcur, "async_cq_err",\r\n(u64)(dev->async_err_stats\r\n[OCRDMA_CQ_ERROR].counter));\r\npcur += ocrdma_add_stat(stats, pcur, "async_cq_overrun_err",\r\n(u64)dev->async_err_stats\r\n[OCRDMA_CQ_OVERRUN_ERROR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "async_cq_qpcat_err",\r\n(u64)dev->async_err_stats\r\n[OCRDMA_CQ_QPCAT_ERROR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "async_qp_access_err",\r\n(u64)dev->async_err_stats\r\n[OCRDMA_QP_ACCESS_ERROR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "async_qp_commm_est_evt",\r\n(u64)dev->async_err_stats\r\n[OCRDMA_QP_COMM_EST_EVENT].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "async_sq_drained_evt",\r\n(u64)dev->async_err_stats\r\n[OCRDMA_SQ_DRAINED_EVENT].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "async_dev_fatal_evt",\r\n(u64)dev->async_err_stats\r\n[OCRDMA_DEVICE_FATAL_EVENT].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "async_srqcat_err",\r\n(u64)dev->async_err_stats\r\n[OCRDMA_SRQCAT_ERROR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "async_srq_limit_evt",\r\n(u64)dev->async_err_stats\r\n[OCRDMA_SRQ_LIMIT_EVENT].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "async_qp_last_wqe_evt",\r\n(u64)dev->async_err_stats\r\n[OCRDMA_QP_LAST_WQE_EVENT].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_loc_len_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_LOC_LEN_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_loc_qp_op_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_LOC_QP_OP_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_loc_eec_op_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_LOC_EEC_OP_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_loc_prot_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_LOC_PROT_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_wr_flush_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_WR_FLUSH_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_mw_bind_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_MW_BIND_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_bad_resp_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_BAD_RESP_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_loc_access_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_LOC_ACCESS_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_rem_inv_req_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_REM_INV_REQ_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_rem_access_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_REM_ACCESS_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_rem_op_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_REM_OP_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_retry_exc_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_RETRY_EXC_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_rnr_retry_exc_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_RNR_RETRY_EXC_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_loc_rdd_viol_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_LOC_RDD_VIOL_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_rem_inv_rd_req_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_REM_INV_RD_REQ_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_rem_abort_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_REM_ABORT_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_inv_eecn_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_INV_EECN_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_inv_eec_state_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_INV_EEC_STATE_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_fatal_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_FATAL_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_resp_timeout_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_RESP_TIMEOUT_ERR].counter);\r\npcur += ocrdma_add_stat(stats, pcur, "cqe_general_err",\r\n(u64)dev->cqe_err_stats\r\n[OCRDMA_CQE_GENERAL_ERR].counter);\r\nreturn stats;\r\n}\r\nstatic void ocrdma_update_stats(struct ocrdma_dev *dev)\r\n{\r\nulong now = jiffies, secs;\r\nint status = 0;\r\nstruct ocrdma_rdma_stats_resp *rdma_stats =\r\n(struct ocrdma_rdma_stats_resp *)dev->stats_mem.va;\r\nstruct ocrdma_rsrc_stats *rsrc_stats = &rdma_stats->act_rsrc_stats;\r\nsecs = jiffies_to_msecs(now - dev->last_stats_time) / 1000U;\r\nif (secs) {\r\nstatus = ocrdma_mbx_rdma_stats(dev, false);\r\nif (status)\r\npr_err("%s: stats mbox failed with status = %d\n",\r\n__func__, status);\r\nif (dev->pd_mgr->pd_prealloc_valid) {\r\nrsrc_stats->dpp_pds = dev->pd_mgr->pd_dpp_count;\r\nrsrc_stats->non_dpp_pds = dev->pd_mgr->pd_norm_count;\r\nrsrc_stats = &rdma_stats->th_rsrc_stats;\r\nrsrc_stats->dpp_pds = dev->pd_mgr->pd_dpp_thrsh;\r\nrsrc_stats->non_dpp_pds = dev->pd_mgr->pd_norm_thrsh;\r\n}\r\ndev->last_stats_time = jiffies;\r\n}\r\n}\r\nstatic ssize_t ocrdma_dbgfs_ops_write(struct file *filp,\r\nconst char __user *buffer,\r\nsize_t count, loff_t *ppos)\r\n{\r\nchar tmp_str[32];\r\nlong reset;\r\nint status = 0;\r\nstruct ocrdma_stats *pstats = filp->private_data;\r\nstruct ocrdma_dev *dev = pstats->dev;\r\nif (count > 32)\r\ngoto err;\r\nif (copy_from_user(tmp_str, buffer, count))\r\ngoto err;\r\ntmp_str[count-1] = '\0';\r\nif (kstrtol(tmp_str, 10, &reset))\r\ngoto err;\r\nswitch (pstats->type) {\r\ncase OCRDMA_RESET_STATS:\r\nif (reset) {\r\nstatus = ocrdma_mbx_rdma_stats(dev, true);\r\nif (status) {\r\npr_err("Failed to reset stats = %d", status);\r\ngoto err;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\ngoto err;\r\n}\r\nreturn count;\r\nerr:\r\nreturn -EFAULT;\r\n}\r\nint ocrdma_pma_counters(struct ocrdma_dev *dev,\r\nstruct ib_mad *out_mad)\r\n{\r\nstruct ib_pma_portcounters *pma_cnt;\r\nmemset(out_mad->data, 0, sizeof out_mad->data);\r\npma_cnt = (void *)(out_mad->data + 40);\r\nocrdma_update_stats(dev);\r\npma_cnt->port_xmit_data = cpu_to_be32(ocrdma_sysfs_xmit_data(dev));\r\npma_cnt->port_rcv_data = cpu_to_be32(ocrdma_sysfs_rcv_data(dev));\r\npma_cnt->port_xmit_packets = cpu_to_be32(ocrdma_sysfs_xmit_pkts(dev));\r\npma_cnt->port_rcv_packets = cpu_to_be32(ocrdma_sysfs_rcv_pkts(dev));\r\nreturn 0;\r\n}\r\nstatic ssize_t ocrdma_dbgfs_ops_read(struct file *filp, char __user *buffer,\r\nsize_t usr_buf_len, loff_t *ppos)\r\n{\r\nstruct ocrdma_stats *pstats = filp->private_data;\r\nstruct ocrdma_dev *dev = pstats->dev;\r\nssize_t status = 0;\r\nchar *data = NULL;\r\nif (*ppos != 0)\r\nreturn 0;\r\nmutex_lock(&dev->stats_lock);\r\nocrdma_update_stats(dev);\r\nswitch (pstats->type) {\r\ncase OCRDMA_RSRC_STATS:\r\ndata = ocrdma_resource_stats(dev);\r\nbreak;\r\ncase OCRDMA_RXSTATS:\r\ndata = ocrdma_rx_stats(dev);\r\nbreak;\r\ncase OCRDMA_WQESTATS:\r\ndata = ocrdma_wqe_stats(dev);\r\nbreak;\r\ncase OCRDMA_TXSTATS:\r\ndata = ocrdma_tx_stats(dev);\r\nbreak;\r\ncase OCRDMA_DB_ERRSTATS:\r\ndata = ocrdma_db_errstats(dev);\r\nbreak;\r\ncase OCRDMA_RXQP_ERRSTATS:\r\ndata = ocrdma_rxqp_errstats(dev);\r\nbreak;\r\ncase OCRDMA_TXQP_ERRSTATS:\r\ndata = ocrdma_txqp_errstats(dev);\r\nbreak;\r\ncase OCRDMA_TX_DBG_STATS:\r\ndata = ocrdma_tx_dbg_stats(dev);\r\nbreak;\r\ncase OCRDMA_RX_DBG_STATS:\r\ndata = ocrdma_rx_dbg_stats(dev);\r\nbreak;\r\ncase OCRDMA_DRV_STATS:\r\ndata = ocrdma_driver_dbg_stats(dev);\r\nbreak;\r\ndefault:\r\nstatus = -EFAULT;\r\ngoto exit;\r\n}\r\nif (usr_buf_len < strlen(data)) {\r\nstatus = -ENOSPC;\r\ngoto exit;\r\n}\r\nstatus = simple_read_from_buffer(buffer, usr_buf_len, ppos, data,\r\nstrlen(data));\r\nexit:\r\nmutex_unlock(&dev->stats_lock);\r\nreturn status;\r\n}\r\nvoid ocrdma_add_port_stats(struct ocrdma_dev *dev)\r\n{\r\nif (!ocrdma_dbgfs_dir)\r\nreturn;\r\ndev->dir = debugfs_create_dir(dev->ibdev.name, ocrdma_dbgfs_dir);\r\nif (!dev->dir)\r\ngoto err;\r\ndev->rsrc_stats.type = OCRDMA_RSRC_STATS;\r\ndev->rsrc_stats.dev = dev;\r\nif (!debugfs_create_file("resource_stats", S_IRUSR, dev->dir,\r\n&dev->rsrc_stats, &ocrdma_dbg_ops))\r\ngoto err;\r\ndev->rx_stats.type = OCRDMA_RXSTATS;\r\ndev->rx_stats.dev = dev;\r\nif (!debugfs_create_file("rx_stats", S_IRUSR, dev->dir,\r\n&dev->rx_stats, &ocrdma_dbg_ops))\r\ngoto err;\r\ndev->wqe_stats.type = OCRDMA_WQESTATS;\r\ndev->wqe_stats.dev = dev;\r\nif (!debugfs_create_file("wqe_stats", S_IRUSR, dev->dir,\r\n&dev->wqe_stats, &ocrdma_dbg_ops))\r\ngoto err;\r\ndev->tx_stats.type = OCRDMA_TXSTATS;\r\ndev->tx_stats.dev = dev;\r\nif (!debugfs_create_file("tx_stats", S_IRUSR, dev->dir,\r\n&dev->tx_stats, &ocrdma_dbg_ops))\r\ngoto err;\r\ndev->db_err_stats.type = OCRDMA_DB_ERRSTATS;\r\ndev->db_err_stats.dev = dev;\r\nif (!debugfs_create_file("db_err_stats", S_IRUSR, dev->dir,\r\n&dev->db_err_stats, &ocrdma_dbg_ops))\r\ngoto err;\r\ndev->tx_qp_err_stats.type = OCRDMA_TXQP_ERRSTATS;\r\ndev->tx_qp_err_stats.dev = dev;\r\nif (!debugfs_create_file("tx_qp_err_stats", S_IRUSR, dev->dir,\r\n&dev->tx_qp_err_stats, &ocrdma_dbg_ops))\r\ngoto err;\r\ndev->rx_qp_err_stats.type = OCRDMA_RXQP_ERRSTATS;\r\ndev->rx_qp_err_stats.dev = dev;\r\nif (!debugfs_create_file("rx_qp_err_stats", S_IRUSR, dev->dir,\r\n&dev->rx_qp_err_stats, &ocrdma_dbg_ops))\r\ngoto err;\r\ndev->tx_dbg_stats.type = OCRDMA_TX_DBG_STATS;\r\ndev->tx_dbg_stats.dev = dev;\r\nif (!debugfs_create_file("tx_dbg_stats", S_IRUSR, dev->dir,\r\n&dev->tx_dbg_stats, &ocrdma_dbg_ops))\r\ngoto err;\r\ndev->rx_dbg_stats.type = OCRDMA_RX_DBG_STATS;\r\ndev->rx_dbg_stats.dev = dev;\r\nif (!debugfs_create_file("rx_dbg_stats", S_IRUSR, dev->dir,\r\n&dev->rx_dbg_stats, &ocrdma_dbg_ops))\r\ngoto err;\r\ndev->driver_stats.type = OCRDMA_DRV_STATS;\r\ndev->driver_stats.dev = dev;\r\nif (!debugfs_create_file("driver_dbg_stats", S_IRUSR, dev->dir,\r\n&dev->driver_stats, &ocrdma_dbg_ops))\r\ngoto err;\r\ndev->reset_stats.type = OCRDMA_RESET_STATS;\r\ndev->reset_stats.dev = dev;\r\nif (!debugfs_create_file("reset_stats", S_IRUSR, dev->dir,\r\n&dev->reset_stats, &ocrdma_dbg_ops))\r\ngoto err;\r\nif (!ocrdma_alloc_stats_mem(dev))\r\ngoto err;\r\nmutex_init(&dev->stats_lock);\r\nreturn;\r\nerr:\r\nocrdma_release_stats_mem(dev);\r\ndebugfs_remove_recursive(dev->dir);\r\ndev->dir = NULL;\r\n}\r\nvoid ocrdma_rem_port_stats(struct ocrdma_dev *dev)\r\n{\r\nif (!dev->dir)\r\nreturn;\r\nmutex_destroy(&dev->stats_lock);\r\nocrdma_release_stats_mem(dev);\r\ndebugfs_remove(dev->dir);\r\n}\r\nvoid ocrdma_init_debugfs(void)\r\n{\r\nocrdma_dbgfs_dir = debugfs_create_dir("ocrdma", NULL);\r\n}\r\nvoid ocrdma_rem_debugfs(void)\r\n{\r\ndebugfs_remove_recursive(ocrdma_dbgfs_dir);\r\n}

int __isa_exception_epc(struct pt_regs *regs)\r\n{\r\nunsigned short inst;\r\nlong epc = regs->cp0_epc;\r\nif (__get_user(inst, (u16 __user *) msk_isa16_mode(epc))) {\r\nforce_sig(SIGSEGV, current);\r\nreturn epc;\r\n}\r\nif (cpu_has_mips16) {\r\nunion mips16e_instruction inst_mips16e;\r\ninst_mips16e.full = inst;\r\nif (inst_mips16e.ri.opcode == MIPS16e_jal_op)\r\nepc += 4;\r\nelse\r\nepc += 2;\r\n} else if (mm_insn_16bit(inst))\r\nepc += 2;\r\nelse\r\nepc += 4;\r\nreturn epc;\r\n}\r\nint __mm_isBranchInstr(struct pt_regs *regs, struct mm_decoded_insn dec_insn,\r\nunsigned long *contpc)\r\n{\r\nunion mips_instruction insn = (union mips_instruction)dec_insn.insn;\r\nint bc_false = 0;\r\nunsigned int fcr31;\r\nunsigned int bit;\r\nif (!cpu_has_mmips)\r\nreturn 0;\r\nswitch (insn.mm_i_format.opcode) {\r\ncase mm_pool32a_op:\r\nif ((insn.mm_i_format.simmediate & MM_POOL32A_MINOR_MASK) ==\r\nmm_pool32axf_op) {\r\nswitch (insn.mm_i_format.simmediate >>\r\nMM_POOL32A_MINOR_SHIFT) {\r\ncase mm_jalr_op:\r\ncase mm_jalrhb_op:\r\ncase mm_jalrs_op:\r\ncase mm_jalrshb_op:\r\nif (insn.mm_i_format.rt != 0)\r\nregs->regs[insn.mm_i_format.rt] =\r\nregs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\n*contpc = regs->regs[insn.mm_i_format.rs];\r\nreturn 1;\r\n}\r\n}\r\nbreak;\r\ncase mm_pool32i_op:\r\nswitch (insn.mm_i_format.rt) {\r\ncase mm_bltzals_op:\r\ncase mm_bltzal_op:\r\nregs->regs[31] = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\ncase mm_bltz_op:\r\nif ((long)regs->regs[insn.mm_i_format.rs] < 0)\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.mm_i_format.simmediate << 1);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\ncase mm_bgezals_op:\r\ncase mm_bgezal_op:\r\nregs->regs[31] = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\ncase mm_bgez_op:\r\nif ((long)regs->regs[insn.mm_i_format.rs] >= 0)\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.mm_i_format.simmediate << 1);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\ncase mm_blez_op:\r\nif ((long)regs->regs[insn.mm_i_format.rs] <= 0)\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.mm_i_format.simmediate << 1);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\ncase mm_bgtz_op:\r\nif ((long)regs->regs[insn.mm_i_format.rs] <= 0)\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.mm_i_format.simmediate << 1);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\ncase mm_bc2f_op:\r\ncase mm_bc1f_op:\r\nbc_false = 1;\r\ncase mm_bc2t_op:\r\ncase mm_bc1t_op:\r\npreempt_disable();\r\nif (is_fpu_owner())\r\nfcr31 = read_32bit_cp1_register(CP1_STATUS);\r\nelse\r\nfcr31 = current->thread.fpu.fcr31;\r\npreempt_enable();\r\nif (bc_false)\r\nfcr31 = ~fcr31;\r\nbit = (insn.mm_i_format.rs >> 2);\r\nbit += (bit != 0);\r\nbit += 23;\r\nif (fcr31 & (1 << bit))\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.mm_i_format.simmediate << 1);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc + dec_insn.next_pc_inc;\r\nreturn 1;\r\n}\r\nbreak;\r\ncase mm_pool16c_op:\r\nswitch (insn.mm_i_format.rt) {\r\ncase mm_jalr16_op:\r\ncase mm_jalrs16_op:\r\nregs->regs[31] = regs->cp0_epc +\r\ndec_insn.pc_inc + dec_insn.next_pc_inc;\r\ncase mm_jr16_op:\r\n*contpc = regs->regs[insn.mm_i_format.rs];\r\nreturn 1;\r\n}\r\nbreak;\r\ncase mm_beqz16_op:\r\nif ((long)regs->regs[reg16to32map[insn.mm_b1_format.rs]] == 0)\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.mm_b1_format.simmediate << 1);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc + dec_insn.next_pc_inc;\r\nreturn 1;\r\ncase mm_bnez16_op:\r\nif ((long)regs->regs[reg16to32map[insn.mm_b1_format.rs]] != 0)\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.mm_b1_format.simmediate << 1);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc + dec_insn.next_pc_inc;\r\nreturn 1;\r\ncase mm_b16_op:\r\n*contpc = regs->cp0_epc + dec_insn.pc_inc +\r\n(insn.mm_b0_format.simmediate << 1);\r\nreturn 1;\r\ncase mm_beq32_op:\r\nif (regs->regs[insn.mm_i_format.rs] ==\r\nregs->regs[insn.mm_i_format.rt])\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.mm_i_format.simmediate << 1);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\ncase mm_bne32_op:\r\nif (regs->regs[insn.mm_i_format.rs] !=\r\nregs->regs[insn.mm_i_format.rt])\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.mm_i_format.simmediate << 1);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc + dec_insn.next_pc_inc;\r\nreturn 1;\r\ncase mm_jalx32_op:\r\nregs->regs[31] = regs->cp0_epc +\r\ndec_insn.pc_inc + dec_insn.next_pc_inc;\r\n*contpc = regs->cp0_epc + dec_insn.pc_inc;\r\n*contpc >>= 28;\r\n*contpc <<= 28;\r\n*contpc |= (insn.j_format.target << 2);\r\nreturn 1;\r\ncase mm_jals32_op:\r\ncase mm_jal32_op:\r\nregs->regs[31] = regs->cp0_epc +\r\ndec_insn.pc_inc + dec_insn.next_pc_inc;\r\ncase mm_j32_op:\r\n*contpc = regs->cp0_epc + dec_insn.pc_inc;\r\n*contpc >>= 27;\r\n*contpc <<= 27;\r\n*contpc |= (insn.j_format.target << 1);\r\nset_isa16_mode(*contpc);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nint __microMIPS_compute_return_epc(struct pt_regs *regs)\r\n{\r\nu16 __user *pc16;\r\nu16 halfword;\r\nunsigned int word;\r\nunsigned long contpc;\r\nstruct mm_decoded_insn mminsn = { 0 };\r\nmminsn.micro_mips_mode = 1;\r\npc16 = (unsigned short __user *)msk_isa16_mode(regs->cp0_epc);\r\n__get_user(halfword, pc16);\r\npc16++;\r\ncontpc = regs->cp0_epc + 2;\r\nword = ((unsigned int)halfword << 16);\r\nmminsn.pc_inc = 2;\r\nif (!mm_insn_16bit(halfword)) {\r\n__get_user(halfword, pc16);\r\npc16++;\r\ncontpc = regs->cp0_epc + 4;\r\nmminsn.pc_inc = 4;\r\nword |= halfword;\r\n}\r\nmminsn.insn = word;\r\nif (get_user(halfword, pc16))\r\ngoto sigsegv;\r\nmminsn.next_pc_inc = 2;\r\nword = ((unsigned int)halfword << 16);\r\nif (!mm_insn_16bit(halfword)) {\r\npc16++;\r\nif (get_user(halfword, pc16))\r\ngoto sigsegv;\r\nmminsn.next_pc_inc = 4;\r\nword |= halfword;\r\n}\r\nmminsn.next_insn = word;\r\nmm_isBranchInstr(regs, mminsn, &contpc);\r\nregs->cp0_epc = contpc;\r\nreturn 0;\r\nsigsegv:\r\nforce_sig(SIGSEGV, current);\r\nreturn -EFAULT;\r\n}\r\nint __MIPS16e_compute_return_epc(struct pt_regs *regs)\r\n{\r\nu16 __user *addr;\r\nunion mips16e_instruction inst;\r\nu16 inst2;\r\nu32 fullinst;\r\nlong epc;\r\nepc = regs->cp0_epc;\r\naddr = (u16 __user *)msk_isa16_mode(epc);\r\nif (__get_user(inst.full, addr)) {\r\nforce_sig(SIGSEGV, current);\r\nreturn -EFAULT;\r\n}\r\nswitch (inst.ri.opcode) {\r\ncase MIPS16e_extend_op:\r\nregs->cp0_epc += 4;\r\nreturn 0;\r\ncase MIPS16e_jal_op:\r\naddr += 1;\r\nif (__get_user(inst2, addr)) {\r\nforce_sig(SIGSEGV, current);\r\nreturn -EFAULT;\r\n}\r\nfullinst = ((unsigned)inst.full << 16) | inst2;\r\nregs->regs[31] = epc + 6;\r\nepc += 4;\r\nepc >>= 28;\r\nepc <<= 28;\r\nepc |=\r\n((fullinst & 0xffff) << 2) | ((fullinst & 0x3e00000) >> 3) |\r\n((fullinst & 0x1f0000) << 7);\r\nif (!inst.jal.x)\r\nset_isa16_mode(epc);\r\nregs->cp0_epc = epc;\r\nreturn 0;\r\ncase MIPS16e_rr_op:\r\nif (inst.rr.func == MIPS16e_jr_func) {\r\nif (inst.rr.ra)\r\nregs->cp0_epc = regs->regs[31];\r\nelse\r\nregs->cp0_epc =\r\nregs->regs[reg16to32[inst.rr.rx]];\r\nif (inst.rr.l) {\r\nif (inst.rr.nd)\r\nregs->regs[31] = epc + 2;\r\nelse\r\nregs->regs[31] = epc + 4;\r\n}\r\nreturn 0;\r\n}\r\nbreak;\r\n}\r\nregs->cp0_epc += 2;\r\nreturn 0;\r\n}\r\nint __compute_return_epc_for_insn(struct pt_regs *regs,\r\nunion mips_instruction insn)\r\n{\r\nunsigned int bit, fcr31, dspcontrol, reg;\r\nlong epc = regs->cp0_epc;\r\nint ret = 0;\r\nswitch (insn.i_format.opcode) {\r\ncase spec_op:\r\nswitch (insn.r_format.func) {\r\ncase jalr_op:\r\nregs->regs[insn.r_format.rd] = epc + 8;\r\ncase jr_op:\r\nif (NO_R6EMU && insn.r_format.func == jr_op)\r\ngoto sigill_r6;\r\nregs->cp0_epc = regs->regs[insn.r_format.rs];\r\nbreak;\r\n}\r\nbreak;\r\ncase bcond_op:\r\nswitch (insn.i_format.rt) {\r\ncase bltzl_op:\r\nif (NO_R6EMU)\r\ngoto sigill_r6;\r\ncase bltz_op:\r\nif ((long)regs->regs[insn.i_format.rs] < 0) {\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nif (insn.i_format.rt == bltzl_op)\r\nret = BRANCH_LIKELY_TAKEN;\r\n} else\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase bgezl_op:\r\nif (NO_R6EMU)\r\ngoto sigill_r6;\r\ncase bgez_op:\r\nif ((long)regs->regs[insn.i_format.rs] >= 0) {\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nif (insn.i_format.rt == bgezl_op)\r\nret = BRANCH_LIKELY_TAKEN;\r\n} else\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase bltzal_op:\r\ncase bltzall_op:\r\nif (NO_R6EMU && (insn.i_format.rs ||\r\ninsn.i_format.rt == bltzall_op)) {\r\nret = -SIGILL;\r\nbreak;\r\n}\r\nregs->regs[31] = epc + 8;\r\nif (!insn.i_format.rs) {\r\nregs->cp0_epc += 4 +\r\n(insn.i_format.simmediate << 2);\r\nbreak;\r\n}\r\nif ((long)regs->regs[insn.i_format.rs] < 0) {\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nif (insn.i_format.rt == bltzall_op)\r\nret = BRANCH_LIKELY_TAKEN;\r\n} else\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase bgezal_op:\r\ncase bgezall_op:\r\nif (NO_R6EMU && (insn.i_format.rs ||\r\ninsn.i_format.rt == bgezall_op)) {\r\nret = -SIGILL;\r\nbreak;\r\n}\r\nregs->regs[31] = epc + 8;\r\nif (!insn.i_format.rs) {\r\nregs->cp0_epc += 4 +\r\n(insn.i_format.simmediate << 2);\r\nbreak;\r\n}\r\nif ((long)regs->regs[insn.i_format.rs] >= 0) {\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nif (insn.i_format.rt == bgezall_op)\r\nret = BRANCH_LIKELY_TAKEN;\r\n} else\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase bposge32_op:\r\nif (!cpu_has_dsp)\r\ngoto sigill_dsp;\r\ndspcontrol = rddsp(0x01);\r\nif (dspcontrol >= 32) {\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\n} else\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\n}\r\nbreak;\r\ncase jal_op:\r\nregs->regs[31] = regs->cp0_epc + 8;\r\ncase j_op:\r\nepc += 4;\r\nepc >>= 28;\r\nepc <<= 28;\r\nepc |= (insn.j_format.target << 2);\r\nregs->cp0_epc = epc;\r\nif (insn.i_format.opcode == jalx_op)\r\nset_isa16_mode(regs->cp0_epc);\r\nbreak;\r\ncase beql_op:\r\nif (NO_R6EMU)\r\ngoto sigill_r6;\r\ncase beq_op:\r\nif (regs->regs[insn.i_format.rs] ==\r\nregs->regs[insn.i_format.rt]) {\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nif (insn.i_format.opcode == beql_op)\r\nret = BRANCH_LIKELY_TAKEN;\r\n} else\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase bnel_op:\r\nif (NO_R6EMU)\r\ngoto sigill_r6;\r\ncase bne_op:\r\nif (regs->regs[insn.i_format.rs] !=\r\nregs->regs[insn.i_format.rt]) {\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nif (insn.i_format.opcode == bnel_op)\r\nret = BRANCH_LIKELY_TAKEN;\r\n} else\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase blezl_op:\r\nif (!insn.i_format.rt && NO_R6EMU)\r\ngoto sigill_r6;\r\ncase blez_op:\r\nif (cpu_has_mips_r6 && insn.i_format.rt) {\r\nif ((insn.i_format.opcode == blez_op) &&\r\n((!insn.i_format.rs && insn.i_format.rt) ||\r\n(insn.i_format.rs == insn.i_format.rt)))\r\nregs->regs[31] = epc + 4;\r\nregs->cp0_epc += 8;\r\nbreak;\r\n}\r\nif ((long)regs->regs[insn.i_format.rs] <= 0) {\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nif (insn.i_format.opcode == blezl_op)\r\nret = BRANCH_LIKELY_TAKEN;\r\n} else\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase bgtzl_op:\r\nif (!insn.i_format.rt && NO_R6EMU)\r\ngoto sigill_r6;\r\ncase bgtz_op:\r\nif (cpu_has_mips_r6 && insn.i_format.rt) {\r\nif ((insn.i_format.opcode == blez_op) &&\r\n((!insn.i_format.rs && insn.i_format.rt) ||\r\n(insn.i_format.rs == insn.i_format.rt)))\r\nregs->regs[31] = epc + 4;\r\nregs->cp0_epc += 8;\r\nbreak;\r\n}\r\nif ((long)regs->regs[insn.i_format.rs] > 0) {\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nif (insn.i_format.opcode == bgtzl_op)\r\nret = BRANCH_LIKELY_TAKEN;\r\n} else\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase cop1_op:\r\nif (cpu_has_mips_r6 &&\r\n((insn.i_format.rs == bc1eqz_op) ||\r\n(insn.i_format.rs == bc1nez_op))) {\r\nif (!used_math()) {\r\nret = init_fpu();\r\nif (ret && NO_R6EMU) {\r\nret = -ret;\r\nbreak;\r\n}\r\nret = 0;\r\nset_used_math();\r\n}\r\nlose_fpu(1);\r\nreg = insn.i_format.rt;\r\nbit = 0;\r\nswitch (insn.i_format.rs) {\r\ncase bc1eqz_op:\r\nif (get_fpr32(&current->thread.fpu.fpr[reg], 0)\r\n& 0x1)\r\nbit = 1;\r\nbreak;\r\ncase bc1nez_op:\r\nif (!(get_fpr32(&current->thread.fpu.fpr[reg], 0)\r\n& 0x1))\r\nbit = 1;\r\nbreak;\r\n}\r\nown_fpu(1);\r\nif (bit)\r\nepc = epc + 4 +\r\n(insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\n} else {\r\npreempt_disable();\r\nif (is_fpu_owner())\r\nfcr31 = read_32bit_cp1_register(CP1_STATUS);\r\nelse\r\nfcr31 = current->thread.fpu.fcr31;\r\npreempt_enable();\r\nbit = (insn.i_format.rt >> 2);\r\nbit += (bit != 0);\r\nbit += 23;\r\nswitch (insn.i_format.rt & 3) {\r\ncase 0:\r\ncase 2:\r\nif (~fcr31 & (1 << bit)) {\r\nepc = epc + 4 +\r\n(insn.i_format.simmediate << 2);\r\nif (insn.i_format.rt == 2)\r\nret = BRANCH_LIKELY_TAKEN;\r\n} else\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase 1:\r\ncase 3:\r\nif (fcr31 & (1 << bit)) {\r\nepc = epc + 4 +\r\n(insn.i_format.simmediate << 2);\r\nif (insn.i_format.rt == 3)\r\nret = BRANCH_LIKELY_TAKEN;\r\n} else\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\n}\r\nbreak;\r\n}\r\n#ifdef CONFIG_CPU_CAVIUM_OCTEON\r\ncase lwc2_op:\r\nif ((regs->regs[insn.i_format.rs] & (1ull<<insn.i_format.rt))\r\n== 0)\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase ldc2_op:\r\nif ((regs->regs[insn.i_format.rs] &\r\n(1ull<<(insn.i_format.rt+32))) == 0)\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase swc2_op:\r\nif (regs->regs[insn.i_format.rs] & (1ull<<insn.i_format.rt))\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase sdc2_op:\r\nif (regs->regs[insn.i_format.rs] &\r\n(1ull<<(insn.i_format.rt+32)))\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\n#else\r\ncase bc6_op:\r\nif (!cpu_has_mips_r6) {\r\nret = -SIGILL;\r\nbreak;\r\n}\r\nregs->cp0_epc += 8;\r\nbreak;\r\ncase balc6_op:\r\nif (!cpu_has_mips_r6) {\r\nret = -SIGILL;\r\nbreak;\r\n}\r\nregs->regs[31] = epc + 4;\r\nepc += 4 + (insn.i_format.simmediate << 2);\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase beqzcjic_op:\r\nif (!cpu_has_mips_r6) {\r\nret = -SIGILL;\r\nbreak;\r\n}\r\nregs->cp0_epc += 8;\r\nbreak;\r\ncase bnezcjialc_op:\r\nif (!cpu_has_mips_r6) {\r\nret = -SIGILL;\r\nbreak;\r\n}\r\nif (insn.i_format.rs)\r\nregs->regs[31] = epc + 4;\r\nregs->cp0_epc += 8;\r\nbreak;\r\n#endif\r\ncase cbcond0_op:\r\ncase cbcond1_op:\r\nif (!cpu_has_mips_r6) {\r\nret = -SIGILL;\r\nbreak;\r\n}\r\nif (insn.i_format.rt && !insn.i_format.rs)\r\nregs->regs[31] = epc + 4;\r\nregs->cp0_epc += 8;\r\nbreak;\r\n}\r\nreturn ret;\r\nsigill_dsp:\r\nprintk("%s: DSP branch but not DSP ASE - sending SIGBUS.\n", current->comm);\r\nforce_sig(SIGBUS, current);\r\nreturn -EFAULT;\r\nsigill_r6:\r\npr_info("%s: R2 branch but r2-to-r6 emulator is not preset - sending SIGILL.\n",\r\ncurrent->comm);\r\nforce_sig(SIGILL, current);\r\nreturn -EFAULT;\r\n}\r\nint __compute_return_epc(struct pt_regs *regs)\r\n{\r\nunsigned int __user *addr;\r\nlong epc;\r\nunion mips_instruction insn;\r\nepc = regs->cp0_epc;\r\nif (epc & 3)\r\ngoto unaligned;\r\naddr = (unsigned int __user *) epc;\r\nif (__get_user(insn.word, addr)) {\r\nforce_sig(SIGSEGV, current);\r\nreturn -EFAULT;\r\n}\r\nreturn __compute_return_epc_for_insn(regs, insn);\r\nunaligned:\r\nprintk("%s: unaligned epc - sending SIGBUS.\n", current->comm);\r\nforce_sig(SIGBUS, current);\r\nreturn -EFAULT;\r\n}

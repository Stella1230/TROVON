static void print_binary(unsigned int number)\r\n{\r\nint i,i2;\r\nchar buffer[64];\r\nmemset(buffer,0,64);\r\ni2=0;\r\nfor (i=31;i>=0;i--) {\r\nif (number & (1<<i))\r\nbuffer[i2++]='1';\r\nelse\r\nbuffer[i2++]='0';\r\nif ((i&3)==0)\r\nbuffer[i2++]=' ';\r\n}\r\npr_debug("%s\n",buffer);\r\n}\r\nstatic int xircom_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstruct device *d = &pdev->dev;\r\nstruct net_device *dev = NULL;\r\nstruct xircom_private *private;\r\nunsigned long flags;\r\nunsigned short tmp16;\r\nint rc;\r\nrc = pci_enable_device(pdev);\r\nif (rc < 0)\r\ngoto out;\r\npci_write_config_dword(pdev, PCI_POWERMGMT, 0x0000);\r\npci_set_master(pdev);\r\npci_read_config_word (pdev,PCI_STATUS, &tmp16);\r\npci_write_config_word (pdev, PCI_STATUS,tmp16);\r\nrc = pci_request_regions(pdev, "xircom_cb");\r\nif (rc < 0) {\r\npr_err("%s: failed to allocate io-region\n", __func__);\r\ngoto err_disable;\r\n}\r\nrc = -ENOMEM;\r\ndev = alloc_etherdev(sizeof(struct xircom_private));\r\nif (!dev)\r\ngoto err_release;\r\nprivate = netdev_priv(dev);\r\nprivate->rx_buffer = dma_alloc_coherent(d, 8192,\r\n&private->rx_dma_handle,\r\nGFP_KERNEL);\r\nif (private->rx_buffer == NULL)\r\ngoto rx_buf_fail;\r\nprivate->tx_buffer = dma_alloc_coherent(d, 8192,\r\n&private->tx_dma_handle,\r\nGFP_KERNEL);\r\nif (private->tx_buffer == NULL)\r\ngoto tx_buf_fail;\r\nSET_NETDEV_DEV(dev, &pdev->dev);\r\nprivate->dev = dev;\r\nprivate->pdev = pdev;\r\nprivate->ioaddr = pci_iomap(pdev, 0, 0);\r\nif (!private->ioaddr)\r\ngoto reg_fail;\r\nspin_lock_init(&private->lock);\r\ninitialize_card(private);\r\nread_mac_address(private);\r\nsetup_descriptors(private);\r\ndev->netdev_ops = &netdev_ops;\r\npci_set_drvdata(pdev, dev);\r\nrc = register_netdev(dev);\r\nif (rc < 0) {\r\npr_err("%s: netdevice registration failed\n", __func__);\r\ngoto err_unmap;\r\n}\r\nnetdev_info(dev, "Xircom cardbus revision %i at irq %i\n",\r\npdev->revision, pdev->irq);\r\ntransceiver_voodoo(private);\r\nspin_lock_irqsave(&private->lock,flags);\r\nactivate_transmitter(private);\r\nactivate_receiver(private);\r\nspin_unlock_irqrestore(&private->lock,flags);\r\ntrigger_receive(private);\r\nout:\r\nreturn rc;\r\nerr_unmap:\r\npci_iounmap(pdev, private->ioaddr);\r\nreg_fail:\r\ndma_free_coherent(d, 8192, private->tx_buffer, private->tx_dma_handle);\r\ntx_buf_fail:\r\ndma_free_coherent(d, 8192, private->rx_buffer, private->rx_dma_handle);\r\nrx_buf_fail:\r\nfree_netdev(dev);\r\nerr_release:\r\npci_release_regions(pdev);\r\nerr_disable:\r\npci_disable_device(pdev);\r\ngoto out;\r\n}\r\nstatic void xircom_remove(struct pci_dev *pdev)\r\n{\r\nstruct net_device *dev = pci_get_drvdata(pdev);\r\nstruct xircom_private *card = netdev_priv(dev);\r\nstruct device *d = &pdev->dev;\r\nunregister_netdev(dev);\r\npci_iounmap(pdev, card->ioaddr);\r\ndma_free_coherent(d, 8192, card->tx_buffer, card->tx_dma_handle);\r\ndma_free_coherent(d, 8192, card->rx_buffer, card->rx_dma_handle);\r\nfree_netdev(dev);\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\n}\r\nstatic irqreturn_t xircom_interrupt(int irq, void *dev_instance)\r\n{\r\nstruct net_device *dev = (struct net_device *) dev_instance;\r\nstruct xircom_private *card = netdev_priv(dev);\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned int status;\r\nint i;\r\nspin_lock(&card->lock);\r\nstatus = xr32(CSR5);\r\n#if defined DEBUG && DEBUG > 1\r\nprint_binary(status);\r\npr_debug("tx status 0x%08x 0x%08x\n",\r\ncard->tx_buffer[0], card->tx_buffer[4]);\r\npr_debug("rx status 0x%08x 0x%08x\n",\r\ncard->rx_buffer[0], card->rx_buffer[4]);\r\n#endif\r\nif (status == 0 || status == 0xffffffff) {\r\nspin_unlock(&card->lock);\r\nreturn IRQ_NONE;\r\n}\r\nif (link_status_changed(card)) {\r\nint newlink;\r\nnetdev_dbg(dev, "Link status has changed\n");\r\nnewlink = link_status(card);\r\nnetdev_info(dev, "Link is %d mbit\n", newlink);\r\nif (newlink)\r\nnetif_carrier_on(dev);\r\nelse\r\nnetif_carrier_off(dev);\r\n}\r\nstatus |= 0xffffffff;\r\nxw32(CSR5, status);\r\nfor (i=0;i<NUMDESCRIPTORS;i++)\r\ninvestigate_write_descriptor(dev,card,i,bufferoffsets[i]);\r\nfor (i=0;i<NUMDESCRIPTORS;i++)\r\ninvestigate_read_descriptor(dev,card,i,bufferoffsets[i]);\r\nspin_unlock(&card->lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic netdev_tx_t xircom_start_xmit(struct sk_buff *skb,\r\nstruct net_device *dev)\r\n{\r\nstruct xircom_private *card;\r\nunsigned long flags;\r\nint nextdescriptor;\r\nint desc;\r\ncard = netdev_priv(dev);\r\nspin_lock_irqsave(&card->lock,flags);\r\nfor (desc=0;desc<NUMDESCRIPTORS;desc++)\r\ninvestigate_write_descriptor(dev,card,desc,bufferoffsets[desc]);\r\nnextdescriptor = (card->transmit_used +1) % (NUMDESCRIPTORS);\r\ndesc = card->transmit_used;\r\nif (card->tx_buffer[4*desc]==0) {\r\nmemset(&card->tx_buffer[bufferoffsets[desc]/4],0,1536);\r\nskb_copy_from_linear_data(skb,\r\n&(card->tx_buffer[bufferoffsets[desc] / 4]),\r\nskb->len);\r\ncard->tx_buffer[4*desc+1] = cpu_to_le32(skb->len);\r\nif (desc == NUMDESCRIPTORS - 1)\r\ncard->tx_buffer[4*desc+1] |= cpu_to_le32(1<<25);\r\ncard->tx_buffer[4*desc+1] |= cpu_to_le32(0xF0000000);\r\ncard->tx_skb[desc] = skb;\r\nwmb();\r\ncard->tx_buffer[4*desc] = cpu_to_le32(0x80000000);\r\ntrigger_transmit(card);\r\nif (card->tx_buffer[nextdescriptor*4] & cpu_to_le32(0x8000000)) {\r\nnetif_stop_queue(dev);\r\n}\r\ncard->transmit_used = nextdescriptor;\r\nspin_unlock_irqrestore(&card->lock,flags);\r\nreturn NETDEV_TX_OK;\r\n}\r\nnetif_stop_queue(dev);\r\nspin_unlock_irqrestore(&card->lock,flags);\r\ntrigger_transmit(card);\r\nreturn NETDEV_TX_BUSY;\r\n}\r\nstatic int xircom_open(struct net_device *dev)\r\n{\r\nstruct xircom_private *xp = netdev_priv(dev);\r\nconst int irq = xp->pdev->irq;\r\nint retval;\r\nnetdev_info(dev, "xircom cardbus adaptor found, using irq %i\n", irq);\r\nretval = request_irq(irq, xircom_interrupt, IRQF_SHARED, dev->name, dev);\r\nif (retval)\r\nreturn retval;\r\nxircom_up(xp);\r\nxp->open = 1;\r\nreturn 0;\r\n}\r\nstatic int xircom_close(struct net_device *dev)\r\n{\r\nstruct xircom_private *card;\r\nunsigned long flags;\r\ncard = netdev_priv(dev);\r\nnetif_stop_queue(dev);\r\nspin_lock_irqsave(&card->lock,flags);\r\ndisable_all_interrupts(card);\r\n#if 0\r\ndeactivate_receiver(card);\r\ndeactivate_transmitter(card);\r\n#endif\r\nremove_descriptors(card);\r\nspin_unlock_irqrestore(&card->lock,flags);\r\ncard->open = 0;\r\nfree_irq(card->pdev->irq, dev);\r\nreturn 0;\r\n}\r\nstatic void xircom_poll_controller(struct net_device *dev)\r\n{\r\nstruct xircom_private *xp = netdev_priv(dev);\r\nconst int irq = xp->pdev->irq;\r\ndisable_irq(irq);\r\nxircom_interrupt(irq, dev);\r\nenable_irq(irq);\r\n}\r\nstatic void initialize_card(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&card->lock, flags);\r\nval = xr32(CSR0);\r\nval |= 0x01;\r\nxw32(CSR0, val);\r\nudelay(100);\r\nval = xr32(CSR0);\r\nval &= ~0x01;\r\nxw32(CSR0, val);\r\nval = 0;\r\nxw32(CSR0, val);\r\ndisable_all_interrupts(card);\r\ndeactivate_receiver(card);\r\ndeactivate_transmitter(card);\r\nspin_unlock_irqrestore(&card->lock, flags);\r\n}\r\nstatic void trigger_transmit(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nxw32(CSR1, 0);\r\n}\r\nstatic void trigger_receive(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nxw32(CSR2, 0);\r\n}\r\nstatic void setup_descriptors(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nu32 address;\r\nint i;\r\nBUG_ON(card->rx_buffer == NULL);\r\nBUG_ON(card->tx_buffer == NULL);\r\nmemset(card->rx_buffer, 0, 128);\r\nfor (i=0;i<NUMDESCRIPTORS;i++ ) {\r\ncard->rx_buffer[i*4 + 0] = cpu_to_le32(0x80000000);\r\ncard->rx_buffer[i*4 + 1] = cpu_to_le32(1536);\r\nif (i == NUMDESCRIPTORS - 1)\r\ncard->rx_buffer[i*4 + 1] |= cpu_to_le32(1 << 25);\r\naddress = card->rx_dma_handle;\r\ncard->rx_buffer[i*4 + 2] = cpu_to_le32(address + bufferoffsets[i]);\r\ncard->rx_buffer[i*4 + 3] = 0;\r\n}\r\nwmb();\r\naddress = card->rx_dma_handle;\r\nxw32(CSR3, address);\r\nmemset(card->tx_buffer, 0, 128);\r\nfor (i=0;i<NUMDESCRIPTORS;i++ ) {\r\ncard->tx_buffer[i*4 + 0] = 0x00000000;\r\ncard->tx_buffer[i*4 + 1] = cpu_to_le32(1536);\r\nif (i == NUMDESCRIPTORS - 1)\r\ncard->tx_buffer[i*4 + 1] |= cpu_to_le32(1 << 25);\r\naddress = card->tx_dma_handle;\r\ncard->tx_buffer[i*4 + 2] = cpu_to_le32(address + bufferoffsets[i]);\r\ncard->tx_buffer[i*4 + 3] = 0;\r\n}\r\nwmb();\r\naddress = card->tx_dma_handle;\r\nxw32(CSR4, address);\r\n}\r\nstatic void remove_descriptors(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned int val;\r\nval = 0;\r\nxw32(CSR3, val);\r\nxw32(CSR4, val);\r\n}\r\nstatic int link_status_changed(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned int val;\r\nval = xr32(CSR5);\r\nif (!(val & (1 << 27)))\r\nreturn 0;\r\nval = (1 << 27);\r\nxw32(CSR5, val);\r\nreturn 1;\r\n}\r\nstatic int transmit_active(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nif (!(xr32(CSR5) & (7 << 20)))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int receive_active(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nif (!(xr32(CSR5) & (7 << 17)))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic void activate_receiver(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned int val;\r\nint counter;\r\nval = xr32(CSR6);\r\nif ((val&2) && (receive_active(card)))\r\nreturn;\r\nval = val & ~2;\r\nxw32(CSR6, val);\r\ncounter = 10;\r\nwhile (counter > 0) {\r\nif (!receive_active(card))\r\nbreak;\r\nudelay(50);\r\ncounter--;\r\nif (counter <= 0)\r\nnetdev_err(card->dev, "Receiver failed to deactivate\n");\r\n}\r\nval = xr32(CSR6);\r\nval = val | 2;\r\nxw32(CSR6, val);\r\ncounter = 10;\r\nwhile (counter > 0) {\r\nif (receive_active(card))\r\nbreak;\r\nudelay(50);\r\ncounter--;\r\nif (counter <= 0)\r\nnetdev_err(card->dev,\r\n"Receiver failed to re-activate\n");\r\n}\r\n}\r\nstatic void deactivate_receiver(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned int val;\r\nint counter;\r\nval = xr32(CSR6);\r\nval = val & ~2;\r\nxw32(CSR6, val);\r\ncounter = 10;\r\nwhile (counter > 0) {\r\nif (!receive_active(card))\r\nbreak;\r\nudelay(50);\r\ncounter--;\r\nif (counter <= 0)\r\nnetdev_err(card->dev, "Receiver failed to deactivate\n");\r\n}\r\n}\r\nstatic void activate_transmitter(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned int val;\r\nint counter;\r\nval = xr32(CSR6);\r\nif ((val&(1<<13)) && (transmit_active(card)))\r\nreturn;\r\nval = val & ~(1 << 13);\r\nxw32(CSR6, val);\r\ncounter = 10;\r\nwhile (counter > 0) {\r\nif (!transmit_active(card))\r\nbreak;\r\nudelay(50);\r\ncounter--;\r\nif (counter <= 0)\r\nnetdev_err(card->dev,\r\n"Transmitter failed to deactivate\n");\r\n}\r\nval = xr32(CSR6);\r\nval = val | (1 << 13);\r\nxw32(CSR6, val);\r\ncounter = 10;\r\nwhile (counter > 0) {\r\nif (transmit_active(card))\r\nbreak;\r\nudelay(50);\r\ncounter--;\r\nif (counter <= 0)\r\nnetdev_err(card->dev,\r\n"Transmitter failed to re-activate\n");\r\n}\r\n}\r\nstatic void deactivate_transmitter(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned int val;\r\nint counter;\r\nval = xr32(CSR6);\r\nval = val & ~2;\r\nxw32(CSR6, val);\r\ncounter = 20;\r\nwhile (counter > 0) {\r\nif (!transmit_active(card))\r\nbreak;\r\nudelay(50);\r\ncounter--;\r\nif (counter <= 0)\r\nnetdev_err(card->dev,\r\n"Transmitter failed to deactivate\n");\r\n}\r\n}\r\nstatic void enable_transmit_interrupt(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned int val;\r\nval = xr32(CSR7);\r\nval |= 1;\r\nxw32(CSR7, val);\r\n}\r\nstatic void enable_receive_interrupt(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned int val;\r\nval = xr32(CSR7);\r\nval = val | (1 << 6);\r\nxw32(CSR7, val);\r\n}\r\nstatic void enable_link_interrupt(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned int val;\r\nval = xr32(CSR7);\r\nval = val | (1 << 27);\r\nxw32(CSR7, val);\r\n}\r\nstatic void disable_all_interrupts(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nxw32(CSR7, 0);\r\n}\r\nstatic void enable_common_interrupts(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned int val;\r\nval = xr32(CSR7);\r\nval |= (1<<16);\r\nval |= (1<<15);\r\nval |= (1<<13);\r\nval |= (1<<8);\r\nval |= (1<<7);\r\nval |= (1<<5);\r\nval |= (1<<2);\r\nval |= (1<<1);\r\nxw32(CSR7, val);\r\n}\r\nstatic int enable_promisc(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned int val;\r\nval = xr32(CSR6);\r\nval = val | (1 << 6);\r\nxw32(CSR6, val);\r\nreturn 1;\r\n}\r\nstatic int link_status(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nu8 val;\r\nval = xr8(CSR12);\r\nif (!(val & (1 << 2)))\r\nreturn 10;\r\nif (!(val & (1 << 1)))\r\nreturn 100;\r\nreturn 0;\r\n}\r\nstatic void read_mac_address(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned long flags;\r\nu8 link;\r\nint i;\r\nspin_lock_irqsave(&card->lock, flags);\r\nxw32(CSR9, 1 << 12);\r\nfor (i = 0x100; i < 0x1f7; i += link + 2) {\r\nu8 tuple, data_id, data_count;\r\nxw32(CSR10, i);\r\ntuple = xr32(CSR9);\r\nxw32(CSR10, i + 1);\r\nlink = xr32(CSR9);\r\nxw32(CSR10, i + 2);\r\ndata_id = xr32(CSR9);\r\nxw32(CSR10, i + 3);\r\ndata_count = xr32(CSR9);\r\nif ((tuple == 0x22) && (data_id == 0x04) && (data_count == 0x06)) {\r\nint j;\r\nfor (j = 0; j < 6; j++) {\r\nxw32(CSR10, i + j + 4);\r\ncard->dev->dev_addr[j] = xr32(CSR9) & 0xff;\r\n}\r\nbreak;\r\n} else if (link == 0) {\r\nbreak;\r\n}\r\n}\r\nspin_unlock_irqrestore(&card->lock, flags);\r\npr_debug(" %pM\n", card->dev->dev_addr);\r\n}\r\nstatic void transceiver_voodoo(struct xircom_private *card)\r\n{\r\nvoid __iomem *ioaddr = card->ioaddr;\r\nunsigned long flags;\r\npci_write_config_dword(card->pdev, PCI_POWERMGMT, 0x0000);\r\nsetup_descriptors(card);\r\nspin_lock_irqsave(&card->lock, flags);\r\nxw32(CSR15, 0x0008);\r\nudelay(25);\r\nxw32(CSR15, 0xa8050000);\r\nudelay(25);\r\nxw32(CSR15, 0xa00f0000);\r\nudelay(25);\r\nspin_unlock_irqrestore(&card->lock, flags);\r\nnetif_start_queue(card->dev);\r\n}\r\nstatic void xircom_up(struct xircom_private *card)\r\n{\r\nunsigned long flags;\r\nint i;\r\npci_write_config_dword(card->pdev, PCI_POWERMGMT, 0x0000);\r\nsetup_descriptors(card);\r\nspin_lock_irqsave(&card->lock, flags);\r\nenable_link_interrupt(card);\r\nenable_transmit_interrupt(card);\r\nenable_receive_interrupt(card);\r\nenable_common_interrupts(card);\r\nenable_promisc(card);\r\nfor (i=0;i<NUMDESCRIPTORS;i++)\r\ninvestigate_read_descriptor(card->dev,card,i,bufferoffsets[i]);\r\nspin_unlock_irqrestore(&card->lock, flags);\r\ntrigger_receive(card);\r\ntrigger_transmit(card);\r\nnetif_start_queue(card->dev);\r\n}\r\nstatic void\r\ninvestigate_read_descriptor(struct net_device *dev, struct xircom_private *card,\r\nint descnr, unsigned int bufferoffset)\r\n{\r\nint status;\r\nstatus = le32_to_cpu(card->rx_buffer[4*descnr]);\r\nif (status > 0) {\r\nshort pkt_len = ((status >> 16) & 0x7ff) - 4;\r\nstruct sk_buff *skb;\r\nif (pkt_len > 1518) {\r\nnetdev_err(dev, "Packet length %i is bogus\n", pkt_len);\r\npkt_len = 1518;\r\n}\r\nskb = netdev_alloc_skb(dev, pkt_len + 2);\r\nif (skb == NULL) {\r\ndev->stats.rx_dropped++;\r\ngoto out;\r\n}\r\nskb_reserve(skb, 2);\r\nskb_copy_to_linear_data(skb,\r\n&card->rx_buffer[bufferoffset / 4],\r\npkt_len);\r\nskb_put(skb, pkt_len);\r\nskb->protocol = eth_type_trans(skb, dev);\r\nnetif_rx(skb);\r\ndev->stats.rx_packets++;\r\ndev->stats.rx_bytes += pkt_len;\r\nout:\r\ncard->rx_buffer[4*descnr] = cpu_to_le32(0x80000000);\r\ntrigger_receive(card);\r\n}\r\n}\r\nstatic void\r\ninvestigate_write_descriptor(struct net_device *dev,\r\nstruct xircom_private *card,\r\nint descnr, unsigned int bufferoffset)\r\n{\r\nint status;\r\nstatus = le32_to_cpu(card->tx_buffer[4*descnr]);\r\n#if 0\r\nif (status & 0x8000) {\r\npr_err("Major transmit error status %x\n", status);\r\ncard->tx_buffer[4*descnr] = 0;\r\nnetif_wake_queue (dev);\r\n}\r\n#endif\r\nif (status > 0) {\r\nif (card->tx_skb[descnr]!=NULL) {\r\ndev->stats.tx_bytes += card->tx_skb[descnr]->len;\r\ndev_kfree_skb_irq(card->tx_skb[descnr]);\r\n}\r\ncard->tx_skb[descnr] = NULL;\r\nif (status & (1 << 8))\r\ndev->stats.collisions++;\r\ncard->tx_buffer[4*descnr] = 0;\r\nnetif_wake_queue (dev);\r\ndev->stats.tx_packets++;\r\n}\r\n}

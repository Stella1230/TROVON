static void swI2CWait(void)\r\n{\r\n#if 0\r\nwhile (peekIO(0x3ce, 0x61) & 0x10);\r\n#else\r\nint i, Temp;\r\nfor (i = 0; i < 600; i++) {\r\nTemp = i;\r\nTemp += i;\r\n}\r\n#endif\r\n}\r\nvoid swI2CSCL(unsigned char value)\r\n{\r\nunsigned long ulGPIOData;\r\nunsigned long ulGPIODirection;\r\nulGPIODirection = PEEK32(g_i2cClkGPIODataDirReg);\r\nif (value) {\r\nulGPIODirection &= ~(1 << g_i2cClockGPIO);\r\nPOKE32(g_i2cClkGPIODataDirReg, ulGPIODirection);\r\n} else {\r\nulGPIOData = PEEK32(g_i2cClkGPIODataReg);\r\nulGPIOData &= ~(1 << g_i2cClockGPIO);\r\nPOKE32(g_i2cClkGPIODataReg, ulGPIOData);\r\nulGPIODirection |= (1 << g_i2cClockGPIO);\r\nPOKE32(g_i2cClkGPIODataDirReg, ulGPIODirection);\r\n}\r\n}\r\nvoid swI2CSDA(unsigned char value)\r\n{\r\nunsigned long ulGPIOData;\r\nunsigned long ulGPIODirection;\r\nulGPIODirection = PEEK32(g_i2cDataGPIODataDirReg);\r\nif (value) {\r\nulGPIODirection &= ~(1 << g_i2cDataGPIO);\r\nPOKE32(g_i2cDataGPIODataDirReg, ulGPIODirection);\r\n} else {\r\nulGPIOData = PEEK32(g_i2cDataGPIODataReg);\r\nulGPIOData &= ~(1 << g_i2cDataGPIO);\r\nPOKE32(g_i2cDataGPIODataReg, ulGPIOData);\r\nulGPIODirection |= (1 << g_i2cDataGPIO);\r\nPOKE32(g_i2cDataGPIODataDirReg, ulGPIODirection);\r\n}\r\n}\r\nstatic unsigned char swI2CReadSDA(void)\r\n{\r\nunsigned long ulGPIODirection;\r\nunsigned long ulGPIOData;\r\nulGPIODirection = PEEK32(g_i2cDataGPIODataDirReg);\r\nif ((ulGPIODirection & (1 << g_i2cDataGPIO)) != (~(1 << g_i2cDataGPIO))) {\r\nulGPIODirection &= ~(1 << g_i2cDataGPIO);\r\nPOKE32(g_i2cDataGPIODataDirReg, ulGPIODirection);\r\n}\r\nulGPIOData = PEEK32(g_i2cDataGPIODataReg);\r\nif (ulGPIOData & (1 << g_i2cDataGPIO))\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic void swI2CAck(void)\r\n{\r\nreturn;\r\n}\r\nstatic void swI2CStart(void)\r\n{\r\nswI2CSDA(1);\r\nswI2CSCL(1);\r\nswI2CSDA(0);\r\n}\r\nstatic void swI2CStop(void)\r\n{\r\nswI2CSCL(1);\r\nswI2CSDA(0);\r\nswI2CSDA(1);\r\n}\r\nstatic long swI2CWriteByte(unsigned char data)\r\n{\r\nunsigned char value = data;\r\nint i;\r\nfor (i = 0; i < 8; i++) {\r\nswI2CSCL(0);\r\nif ((value & 0x80) != 0)\r\nswI2CSDA(1);\r\nelse\r\nswI2CSDA(0);\r\nswI2CWait();\r\nswI2CSCL(1);\r\nswI2CWait();\r\nvalue = value << 1;\r\n}\r\nswI2CSCL(0);\r\nswI2CSDA(1);\r\nswI2CWait();\r\nswI2CSCL(1);\r\nswI2CWait();\r\nfor (i = 0; i < 0xff; i++) {\r\nif (!swI2CReadSDA())\r\nbreak;\r\nswI2CSCL(0);\r\nswI2CWait();\r\nswI2CSCL(1);\r\nswI2CWait();\r\n}\r\nswI2CSCL(0);\r\nswI2CSDA(1);\r\nif (i < 0xff)\r\nreturn 0;\r\nelse\r\nreturn -1;\r\n}\r\nstatic unsigned char swI2CReadByte(unsigned char ack)\r\n{\r\nint i;\r\nunsigned char data = 0;\r\nfor (i = 7; i >= 0; i--) {\r\nswI2CSCL(0);\r\nswI2CSDA(1);\r\nswI2CWait();\r\nswI2CSCL(1);\r\nswI2CWait();\r\ndata |= (swI2CReadSDA() << i);\r\n}\r\nif (ack)\r\nswI2CAck();\r\nswI2CSCL(0);\r\nswI2CSDA(1);\r\nreturn data;\r\n}\r\nstatic long swI2CInit_SM750LE(unsigned char i2cClkGPIO,\r\nunsigned char i2cDataGPIO)\r\n{\r\nint i;\r\ng_i2cClkGPIODataReg = GPIO_DATA_SM750LE;\r\ng_i2cClkGPIODataDirReg = GPIO_DATA_DIRECTION_SM750LE;\r\ng_i2cClockGPIO = i2cClkGPIO;\r\ng_i2cDataGPIODataReg = GPIO_DATA_SM750LE;\r\ng_i2cDataGPIODataDirReg = GPIO_DATA_DIRECTION_SM750LE;\r\ng_i2cDataGPIO = i2cDataGPIO;\r\nfor (i = 0; i < 9; i++)\r\nswI2CStop();\r\nreturn 0;\r\n}\r\nlong swI2CInit(\r\nunsigned char i2cClkGPIO,\r\nunsigned char i2cDataGPIO\r\n)\r\n{\r\nint i;\r\nif ((i2cClkGPIO > 31) || (i2cDataGPIO > 31))\r\nreturn -1;\r\nif (getChipType() == SM750LE)\r\nreturn swI2CInit_SM750LE(i2cClkGPIO, i2cDataGPIO);\r\ng_i2cClkGPIOMuxReg = GPIO_MUX;\r\ng_i2cClkGPIODataReg = GPIO_DATA;\r\ng_i2cClkGPIODataDirReg = GPIO_DATA_DIRECTION;\r\ng_i2cClockGPIO = i2cClkGPIO;\r\ng_i2cDataGPIOMuxReg = GPIO_MUX;\r\ng_i2cDataGPIODataReg = GPIO_DATA;\r\ng_i2cDataGPIODataDirReg = GPIO_DATA_DIRECTION;\r\ng_i2cDataGPIO = i2cDataGPIO;\r\nPOKE32(g_i2cClkGPIOMuxReg,\r\nPEEK32(g_i2cClkGPIOMuxReg) & ~(1 << g_i2cClockGPIO));\r\nPOKE32(g_i2cDataGPIOMuxReg,\r\nPEEK32(g_i2cDataGPIOMuxReg) & ~(1 << g_i2cDataGPIO));\r\nenableGPIO(1);\r\nfor (i = 0; i < 9; i++)\r\nswI2CStop();\r\nreturn 0;\r\n}\r\nunsigned char swI2CReadReg(\r\nunsigned char deviceAddress,\r\nunsigned char registerIndex\r\n)\r\n{\r\nunsigned char data;\r\nswI2CStart();\r\nswI2CWriteByte(deviceAddress);\r\nswI2CWriteByte(registerIndex);\r\nswI2CStart();\r\nswI2CWriteByte(deviceAddress + 1);\r\ndata = swI2CReadByte(1);\r\nswI2CStop();\r\nreturn data;\r\n}\r\nlong swI2CWriteReg(\r\nunsigned char deviceAddress,\r\nunsigned char registerIndex,\r\nunsigned char data\r\n)\r\n{\r\nlong returnValue = 0;\r\nswI2CStart();\r\nif ((swI2CWriteByte(deviceAddress) != 0) ||\r\n(swI2CWriteByte(registerIndex) != 0) ||\r\n(swI2CWriteByte(data) != 0)) {\r\nreturnValue = -1;\r\n}\r\nswI2CStop();\r\nreturn returnValue;\r\n}

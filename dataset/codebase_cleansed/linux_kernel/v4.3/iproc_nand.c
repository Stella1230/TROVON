static bool iproc_nand_intc_ack(struct brcmnand_soc *soc)\r\n{\r\nstruct iproc_nand_soc_priv *priv = soc->priv;\r\nvoid __iomem *mmio = priv->ext_base + IPROC_NAND_CTLR_READY_OFFSET;\r\nu32 val = brcmnand_readl(mmio);\r\nif (val & IPROC_NAND_CTLR_READY) {\r\nbrcmnand_writel(IPROC_NAND_CTLR_READY, mmio);\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic void iproc_nand_intc_set(struct brcmnand_soc *soc, bool en)\r\n{\r\nstruct iproc_nand_soc_priv *priv = soc->priv;\r\nvoid __iomem *mmio = priv->idm_base + IPROC_NAND_IO_CTRL_OFFSET;\r\nu32 val;\r\nunsigned long flags;\r\nspin_lock_irqsave(&priv->idm_lock, flags);\r\nval = brcmnand_readl(mmio);\r\nif (en)\r\nval |= IPROC_NAND_INT_CTRL_READ_ENABLE;\r\nelse\r\nval &= ~IPROC_NAND_INT_CTRL_READ_ENABLE;\r\nbrcmnand_writel(val, mmio);\r\nspin_unlock_irqrestore(&priv->idm_lock, flags);\r\n}\r\nstatic void iproc_nand_apb_access(struct brcmnand_soc *soc, bool prepare)\r\n{\r\nstruct iproc_nand_soc_priv *priv = soc->priv;\r\nvoid __iomem *mmio = priv->idm_base + IPROC_NAND_IO_CTRL_OFFSET;\r\nu32 val;\r\nunsigned long flags;\r\nspin_lock_irqsave(&priv->idm_lock, flags);\r\nval = brcmnand_readl(mmio);\r\nif (prepare)\r\nval |= IPROC_NAND_APB_LE_MODE;\r\nelse\r\nval &= ~IPROC_NAND_APB_LE_MODE;\r\nbrcmnand_writel(val, mmio);\r\nspin_unlock_irqrestore(&priv->idm_lock, flags);\r\n}\r\nstatic int iproc_nand_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct iproc_nand_soc_priv *priv;\r\nstruct brcmnand_soc *soc;\r\nstruct resource *res;\r\nsoc = devm_kzalloc(dev, sizeof(*soc), GFP_KERNEL);\r\nif (!soc)\r\nreturn -ENOMEM;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nspin_lock_init(&priv->idm_lock);\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "iproc-idm");\r\npriv->idm_base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(priv->idm_base))\r\nreturn PTR_ERR(priv->idm_base);\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "iproc-ext");\r\npriv->ext_base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(priv->ext_base))\r\nreturn PTR_ERR(priv->ext_base);\r\nsoc->pdev = pdev;\r\nsoc->priv = priv;\r\nsoc->ctlrdy_ack = iproc_nand_intc_ack;\r\nsoc->ctlrdy_set_enabled = iproc_nand_intc_set;\r\nsoc->prepare_data_bus = iproc_nand_apb_access;\r\nreturn brcmnand_probe(pdev, soc);\r\n}

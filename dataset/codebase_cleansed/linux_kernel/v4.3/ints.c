void process_int(int vec, struct pt_regs *fp)\r\n{\r\nint irq;\r\nint mask;\r\nunsigned long pend = ISR;\r\nwhile (pend) {\r\nif (pend & 0x0000ffff) {\r\nif (pend & 0x000000ff) {\r\nif (pend & 0x0000000f) {\r\nmask = 0x00000001;\r\nirq = 0;\r\n} else {\r\nmask = 0x00000010;\r\nirq = 4;\r\n}\r\n} else {\r\nif (pend & 0x00000f00) {\r\nmask = 0x00000100;\r\nirq = 8;\r\n} else {\r\nmask = 0x00001000;\r\nirq = 12;\r\n}\r\n}\r\n} else {\r\nif (pend & 0x00ff0000) {\r\nif (pend & 0x000f0000) {\r\nmask = 0x00010000;\r\nirq = 16;\r\n} else {\r\nmask = 0x00100000;\r\nirq = 20;\r\n}\r\n} else {\r\nif (pend & 0x0f000000) {\r\nmask = 0x01000000;\r\nirq = 24;\r\n} else {\r\nmask = 0x10000000;\r\nirq = 28;\r\n}\r\n}\r\n}\r\nwhile (! (mask & pend)) {\r\nmask <<=1;\r\nirq++;\r\n}\r\ndo_IRQ(irq, fp);\r\npend &= ~mask;\r\n}\r\n}\r\nstatic void intc_irq_unmask(struct irq_data *d)\r\n{\r\nIMR &= ~(1 << d->irq);\r\n}\r\nstatic void intc_irq_mask(struct irq_data *d)\r\n{\r\nIMR |= (1 << d->irq);\r\n}\r\nvoid __init trap_init(void)\r\n{\r\nint i;\r\nfor (i = 72; i < 256; ++i)\r\n_ramvec[i] = (e_vector) bad_interrupt;\r\n_ramvec[32] = system_call;\r\n_ramvec[65] = (e_vector) inthandler1;\r\n_ramvec[66] = (e_vector) inthandler2;\r\n_ramvec[67] = (e_vector) inthandler3;\r\n_ramvec[68] = (e_vector) inthandler4;\r\n_ramvec[69] = (e_vector) inthandler5;\r\n_ramvec[70] = (e_vector) inthandler6;\r\n_ramvec[71] = (e_vector) inthandler7;\r\n}\r\nvoid __init init_IRQ(void)\r\n{\r\nint i;\r\nIVR = 0x40;\r\nIMR = ~0;\r\nfor (i = 0; (i < NR_IRQS); i++) {\r\nirq_set_chip(i, &intc_irq_chip);\r\nirq_set_handler(i, handle_level_irq);\r\n}\r\n}

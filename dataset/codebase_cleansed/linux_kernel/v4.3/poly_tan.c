void poly_tan(FPU_REG *st0_ptr)\r\n{\r\nlong int exponent;\r\nint invert;\r\nXsig argSq, argSqSq, accumulatoro, accumulatore, accum,\r\nargSignif, fix_up;\r\nunsigned long adj;\r\nexponent = exponent(st0_ptr);\r\n#ifdef PARANOID\r\nif (signnegative(st0_ptr)) {\r\narith_invalid(0);\r\nreturn;\r\n}\r\n#endif\r\nif ((exponent == 0)\r\n|| ((exponent == -1) && (st0_ptr->sigh > 0xc90fdaa2))) {\r\ninvert = 1;\r\naccum.lsw = 0;\r\nXSIG_LL(accum) = significand(st0_ptr);\r\nif (exponent == 0) {\r\nXSIG_LL(accum) <<= 1;\r\n}\r\nXSIG_LL(accum) = 0x921fb54442d18469LL - XSIG_LL(accum);\r\nif (XSIG_LL(accum) == 0xffffffffffffffffLL) {\r\nFPU_settag0(TAG_Valid);\r\nsignificand(st0_ptr) = 0x8a51e04daabda360LL;\r\nsetexponent16(st0_ptr,\r\n(0x41 + EXTENDED_Ebias) | SIGN_Negative);\r\nreturn;\r\n}\r\nargSignif.lsw = accum.lsw;\r\nXSIG_LL(argSignif) = XSIG_LL(accum);\r\nexponent = -1 + norm_Xsig(&argSignif);\r\n} else {\r\ninvert = 0;\r\nargSignif.lsw = 0;\r\nXSIG_LL(accum) = XSIG_LL(argSignif) = significand(st0_ptr);\r\nif (exponent < -1) {\r\nif (FPU_shrx(&XSIG_LL(accum), -1 - exponent) >=\r\n0x80000000U)\r\nXSIG_LL(accum)++;\r\n}\r\n}\r\nXSIG_LL(argSq) = XSIG_LL(accum);\r\nargSq.lsw = accum.lsw;\r\nmul_Xsig_Xsig(&argSq, &argSq);\r\nXSIG_LL(argSqSq) = XSIG_LL(argSq);\r\nargSqSq.lsw = argSq.lsw;\r\nmul_Xsig_Xsig(&argSqSq, &argSqSq);\r\naccumulatoro.msw = accumulatoro.midw = accumulatoro.lsw = 0;\r\npolynomial_Xsig(&accumulatoro, &XSIG_LL(argSqSq), oddnegterm,\r\nHiPOWERon - 1);\r\nmul_Xsig_Xsig(&accumulatoro, &argSq);\r\nnegate_Xsig(&accumulatoro);\r\npolynomial_Xsig(&accumulatoro, &XSIG_LL(argSqSq), oddplterm,\r\nHiPOWERop - 1);\r\naccumulatore.msw = accumulatore.midw = accumulatore.lsw = 0;\r\npolynomial_Xsig(&accumulatore, &XSIG_LL(argSqSq), evenplterm,\r\nHiPOWERep - 1);\r\nmul_Xsig_Xsig(&accumulatore, &argSq);\r\nnegate_Xsig(&accumulatore);\r\npolynomial_Xsig(&accumulatore, &XSIG_LL(argSqSq), evennegterm,\r\nHiPOWERen - 1);\r\nmul64_Xsig(&accumulatore, &XSIG_LL(argSignif));\r\nmul64_Xsig(&accumulatore, &XSIG_LL(argSignif));\r\nshr_Xsig(&accumulatore, -2 * (1 + exponent) + 1);\r\nnegate_Xsig(&accumulatore);\r\nif (accumulatore.msw == 0) {\r\nXSIG_LL(accum) = 0x8000000000000000LL;\r\naccum.lsw = 0;\r\n} else {\r\ndiv_Xsig(&accumulatoro, &accumulatore, &accum);\r\n}\r\nmul64_Xsig(&accum, &XSIG_LL(argSignif));\r\nmul64_Xsig(&accum, &XSIG_LL(argSignif));\r\nmul64_Xsig(&accum, &XSIG_LL(argSignif));\r\nmul64_Xsig(&accum, &twothirds);\r\nshr_Xsig(&accum, -2 * (exponent + 1));\r\nadd_two_Xsig(&accum, &argSignif, &exponent);\r\nif (invert) {\r\nXSIG_LL(fix_up) = 0x898cc51701b839a2LL;\r\nfix_up.lsw = 0;\r\nif (exponent == 0)\r\nadj = 0xffffffff;\r\nelse if (exponent > -30) {\r\nadj = accum.msw >> -(exponent + 1);\r\nadj = mul_32_32(adj, adj);\r\n} else\r\nadj = 0;\r\nadj = mul_32_32(0x898cc517, adj);\r\nfix_up.msw += adj;\r\nif (!(fix_up.msw & 0x80000000)) {\r\nshr_Xsig(&fix_up, 1);\r\nfix_up.msw |= 0x80000000;\r\nshr_Xsig(&fix_up, 64 + exponent);\r\n} else\r\nshr_Xsig(&fix_up, 65 + exponent);\r\nadd_two_Xsig(&accum, &fix_up, &exponent);\r\naccumulatoro.lsw = accumulatoro.midw = 0;\r\naccumulatoro.msw = 0x80000000;\r\ndiv_Xsig(&accumulatoro, &accum, &accum);\r\nexponent = -exponent - 1;\r\n}\r\nround_Xsig(&accum);\r\nFPU_settag0(TAG_Valid);\r\nsignificand(st0_ptr) = XSIG_LL(accum);\r\nsetexponent16(st0_ptr, exponent + EXTENDED_Ebias);\r\n}

void mlx5_srq_event(struct mlx5_core_dev *dev, u32 srqn, int event_type)\r\n{\r\nstruct mlx5_srq_table *table = &dev->priv.srq_table;\r\nstruct mlx5_core_srq *srq;\r\nspin_lock(&table->lock);\r\nsrq = radix_tree_lookup(&table->tree, srqn);\r\nif (srq)\r\natomic_inc(&srq->refcount);\r\nspin_unlock(&table->lock);\r\nif (!srq) {\r\nmlx5_core_warn(dev, "Async event for bogus SRQ 0x%08x\n", srqn);\r\nreturn;\r\n}\r\nsrq->event(srq, event_type);\r\nif (atomic_dec_and_test(&srq->refcount))\r\ncomplete(&srq->free);\r\n}\r\nstatic int get_pas_size(void *srqc)\r\n{\r\nu32 log_page_size = MLX5_GET(srqc, srqc, log_page_size) + 12;\r\nu32 log_srq_size = MLX5_GET(srqc, srqc, log_srq_size);\r\nu32 log_rq_stride = MLX5_GET(srqc, srqc, log_rq_stride);\r\nu32 page_offset = MLX5_GET(srqc, srqc, page_offset);\r\nu32 po_quanta = 1 << (log_page_size - 6);\r\nu32 rq_sz = 1 << (log_srq_size + 4 + log_rq_stride);\r\nu32 page_size = 1 << log_page_size;\r\nu32 rq_sz_po = rq_sz + (page_offset * po_quanta);\r\nu32 rq_num_pas = (rq_sz_po + page_size - 1) / page_size;\r\nreturn rq_num_pas * sizeof(u64);\r\n}\r\nstatic void rmpc_srqc_reformat(void *srqc, void *rmpc, bool srqc_to_rmpc)\r\n{\r\nvoid *wq = MLX5_ADDR_OF(rmpc, rmpc, wq);\r\nif (srqc_to_rmpc) {\r\nswitch (MLX5_GET(srqc, srqc, state)) {\r\ncase MLX5_SRQC_STATE_GOOD:\r\nMLX5_SET(rmpc, rmpc, state, MLX5_RMPC_STATE_RDY);\r\nbreak;\r\ncase MLX5_SRQC_STATE_ERROR:\r\nMLX5_SET(rmpc, rmpc, state, MLX5_RMPC_STATE_ERR);\r\nbreak;\r\ndefault:\r\npr_warn("%s: %d: Unknown srq state = 0x%x\n", __func__,\r\n__LINE__, MLX5_GET(srqc, srqc, state));\r\nMLX5_SET(rmpc, rmpc, state, MLX5_GET(srqc, srqc, state));\r\n}\r\nMLX5_SET(wq, wq, wq_signature, MLX5_GET(srqc, srqc, wq_signature));\r\nMLX5_SET(wq, wq, log_wq_pg_sz, MLX5_GET(srqc, srqc, log_page_size));\r\nMLX5_SET(wq, wq, log_wq_stride, MLX5_GET(srqc, srqc, log_rq_stride) + 4);\r\nMLX5_SET(wq, wq, log_wq_sz, MLX5_GET(srqc, srqc, log_srq_size));\r\nMLX5_SET(wq, wq, page_offset, MLX5_GET(srqc, srqc, page_offset));\r\nMLX5_SET(wq, wq, lwm, MLX5_GET(srqc, srqc, lwm));\r\nMLX5_SET(wq, wq, pd, MLX5_GET(srqc, srqc, pd));\r\nMLX5_SET64(wq, wq, dbr_addr, MLX5_GET64(srqc, srqc, dbr_addr));\r\n} else {\r\nswitch (MLX5_GET(rmpc, rmpc, state)) {\r\ncase MLX5_RMPC_STATE_RDY:\r\nMLX5_SET(srqc, srqc, state, MLX5_SRQC_STATE_GOOD);\r\nbreak;\r\ncase MLX5_RMPC_STATE_ERR:\r\nMLX5_SET(srqc, srqc, state, MLX5_SRQC_STATE_ERROR);\r\nbreak;\r\ndefault:\r\npr_warn("%s: %d: Unknown rmp state = 0x%x\n",\r\n__func__, __LINE__,\r\nMLX5_GET(rmpc, rmpc, state));\r\nMLX5_SET(srqc, srqc, state,\r\nMLX5_GET(rmpc, rmpc, state));\r\n}\r\nMLX5_SET(srqc, srqc, wq_signature, MLX5_GET(wq, wq, wq_signature));\r\nMLX5_SET(srqc, srqc, log_page_size, MLX5_GET(wq, wq, log_wq_pg_sz));\r\nMLX5_SET(srqc, srqc, log_rq_stride, MLX5_GET(wq, wq, log_wq_stride) - 4);\r\nMLX5_SET(srqc, srqc, log_srq_size, MLX5_GET(wq, wq, log_wq_sz));\r\nMLX5_SET(srqc, srqc, page_offset, MLX5_GET(wq, wq, page_offset));\r\nMLX5_SET(srqc, srqc, lwm, MLX5_GET(wq, wq, lwm));\r\nMLX5_SET(srqc, srqc, pd, MLX5_GET(wq, wq, pd));\r\nMLX5_SET64(srqc, srqc, dbr_addr, MLX5_GET64(wq, wq, dbr_addr));\r\n}\r\n}\r\nstruct mlx5_core_srq *mlx5_core_get_srq(struct mlx5_core_dev *dev, u32 srqn)\r\n{\r\nstruct mlx5_srq_table *table = &dev->priv.srq_table;\r\nstruct mlx5_core_srq *srq;\r\nspin_lock(&table->lock);\r\nsrq = radix_tree_lookup(&table->tree, srqn);\r\nif (srq)\r\natomic_inc(&srq->refcount);\r\nspin_unlock(&table->lock);\r\nreturn srq;\r\n}\r\nstatic int create_srq_cmd(struct mlx5_core_dev *dev, struct mlx5_core_srq *srq,\r\nstruct mlx5_create_srq_mbox_in *in, int inlen)\r\n{\r\nstruct mlx5_create_srq_mbox_out out;\r\nint err;\r\nmemset(&out, 0, sizeof(out));\r\nin->hdr.opcode = cpu_to_be16(MLX5_CMD_OP_CREATE_SRQ);\r\nerr = mlx5_cmd_exec_check_status(dev, (u32 *)in, inlen, (u32 *)(&out),\r\nsizeof(out));\r\nsrq->srqn = be32_to_cpu(out.srqn) & 0xffffff;\r\nreturn err;\r\n}\r\nstatic int destroy_srq_cmd(struct mlx5_core_dev *dev,\r\nstruct mlx5_core_srq *srq)\r\n{\r\nstruct mlx5_destroy_srq_mbox_in in;\r\nstruct mlx5_destroy_srq_mbox_out out;\r\nmemset(&in, 0, sizeof(in));\r\nmemset(&out, 0, sizeof(out));\r\nin.hdr.opcode = cpu_to_be16(MLX5_CMD_OP_DESTROY_SRQ);\r\nin.srqn = cpu_to_be32(srq->srqn);\r\nreturn mlx5_cmd_exec_check_status(dev, (u32 *)(&in), sizeof(in),\r\n(u32 *)(&out), sizeof(out));\r\n}\r\nstatic int arm_srq_cmd(struct mlx5_core_dev *dev, struct mlx5_core_srq *srq,\r\nu16 lwm, int is_srq)\r\n{\r\nstruct mlx5_arm_srq_mbox_in in;\r\nstruct mlx5_arm_srq_mbox_out out;\r\nmemset(&in, 0, sizeof(in));\r\nmemset(&out, 0, sizeof(out));\r\nin.hdr.opcode = cpu_to_be16(MLX5_CMD_OP_ARM_RQ);\r\nin.hdr.opmod = cpu_to_be16(!!is_srq);\r\nin.srqn = cpu_to_be32(srq->srqn);\r\nin.lwm = cpu_to_be16(lwm);\r\nreturn mlx5_cmd_exec_check_status(dev, (u32 *)(&in),\r\nsizeof(in), (u32 *)(&out),\r\nsizeof(out));\r\n}\r\nstatic int query_srq_cmd(struct mlx5_core_dev *dev, struct mlx5_core_srq *srq,\r\nstruct mlx5_query_srq_mbox_out *out)\r\n{\r\nstruct mlx5_query_srq_mbox_in in;\r\nmemset(&in, 0, sizeof(in));\r\nin.hdr.opcode = cpu_to_be16(MLX5_CMD_OP_QUERY_SRQ);\r\nin.srqn = cpu_to_be32(srq->srqn);\r\nreturn mlx5_cmd_exec_check_status(dev, (u32 *)(&in), sizeof(in),\r\n(u32 *)out, sizeof(*out));\r\n}\r\nstatic int create_xrc_srq_cmd(struct mlx5_core_dev *dev,\r\nstruct mlx5_core_srq *srq,\r\nstruct mlx5_create_srq_mbox_in *in,\r\nint srq_inlen)\r\n{\r\nu32 create_out[MLX5_ST_SZ_DW(create_xrc_srq_out)];\r\nvoid *create_in;\r\nvoid *srqc;\r\nvoid *xrc_srqc;\r\nvoid *pas;\r\nint pas_size;\r\nint inlen;\r\nint err;\r\nsrqc = MLX5_ADDR_OF(create_srq_in, in, srq_context_entry);\r\npas_size = get_pas_size(srqc);\r\ninlen = MLX5_ST_SZ_BYTES(create_xrc_srq_in) + pas_size;\r\ncreate_in = mlx5_vzalloc(inlen);\r\nif (!create_in)\r\nreturn -ENOMEM;\r\nxrc_srqc = MLX5_ADDR_OF(create_xrc_srq_in, create_in,\r\nxrc_srq_context_entry);\r\npas = MLX5_ADDR_OF(create_xrc_srq_in, create_in, pas);\r\nmemcpy(xrc_srqc, srqc, MLX5_ST_SZ_BYTES(srqc));\r\nmemcpy(pas, in->pas, pas_size);\r\nMLX5_SET(xrc_srqc, xrc_srqc, user_index, 0xffffff);\r\nMLX5_SET(create_xrc_srq_in, create_in, opcode,\r\nMLX5_CMD_OP_CREATE_XRC_SRQ);\r\nmemset(create_out, 0, sizeof(create_out));\r\nerr = mlx5_cmd_exec_check_status(dev, create_in, inlen, create_out,\r\nsizeof(create_out));\r\nif (err)\r\ngoto out;\r\nsrq->srqn = MLX5_GET(create_xrc_srq_out, create_out, xrc_srqn);\r\nout:\r\nkvfree(create_in);\r\nreturn err;\r\n}\r\nstatic int destroy_xrc_srq_cmd(struct mlx5_core_dev *dev,\r\nstruct mlx5_core_srq *srq)\r\n{\r\nu32 xrcsrq_in[MLX5_ST_SZ_DW(destroy_xrc_srq_in)];\r\nu32 xrcsrq_out[MLX5_ST_SZ_DW(destroy_xrc_srq_out)];\r\nmemset(xrcsrq_in, 0, sizeof(xrcsrq_in));\r\nmemset(xrcsrq_out, 0, sizeof(xrcsrq_out));\r\nMLX5_SET(destroy_xrc_srq_in, xrcsrq_in, opcode,\r\nMLX5_CMD_OP_DESTROY_XRC_SRQ);\r\nMLX5_SET(destroy_xrc_srq_in, xrcsrq_in, xrc_srqn, srq->srqn);\r\nreturn mlx5_cmd_exec_check_status(dev, xrcsrq_in, sizeof(xrcsrq_in),\r\nxrcsrq_out, sizeof(xrcsrq_out));\r\n}\r\nstatic int arm_xrc_srq_cmd(struct mlx5_core_dev *dev,\r\nstruct mlx5_core_srq *srq, u16 lwm)\r\n{\r\nu32 xrcsrq_in[MLX5_ST_SZ_DW(arm_xrc_srq_in)];\r\nu32 xrcsrq_out[MLX5_ST_SZ_DW(arm_xrc_srq_out)];\r\nmemset(xrcsrq_in, 0, sizeof(xrcsrq_in));\r\nmemset(xrcsrq_out, 0, sizeof(xrcsrq_out));\r\nMLX5_SET(arm_xrc_srq_in, xrcsrq_in, opcode, MLX5_CMD_OP_ARM_XRC_SRQ);\r\nMLX5_SET(arm_xrc_srq_in, xrcsrq_in, op_mod, MLX5_ARM_XRC_SRQ_IN_OP_MOD_XRC_SRQ);\r\nMLX5_SET(arm_xrc_srq_in, xrcsrq_in, xrc_srqn, srq->srqn);\r\nMLX5_SET(arm_xrc_srq_in, xrcsrq_in, lwm, lwm);\r\nreturn mlx5_cmd_exec_check_status(dev, xrcsrq_in, sizeof(xrcsrq_in),\r\nxrcsrq_out, sizeof(xrcsrq_out));\r\n}\r\nstatic int query_xrc_srq_cmd(struct mlx5_core_dev *dev,\r\nstruct mlx5_core_srq *srq,\r\nstruct mlx5_query_srq_mbox_out *out)\r\n{\r\nu32 xrcsrq_in[MLX5_ST_SZ_DW(query_xrc_srq_in)];\r\nu32 *xrcsrq_out;\r\nvoid *srqc;\r\nvoid *xrc_srqc;\r\nint err;\r\nxrcsrq_out = mlx5_vzalloc(MLX5_ST_SZ_BYTES(query_xrc_srq_out));\r\nif (!xrcsrq_out)\r\nreturn -ENOMEM;\r\nmemset(xrcsrq_in, 0, sizeof(xrcsrq_in));\r\nMLX5_SET(query_xrc_srq_in, xrcsrq_in, opcode,\r\nMLX5_CMD_OP_QUERY_XRC_SRQ);\r\nMLX5_SET(query_xrc_srq_in, xrcsrq_in, xrc_srqn, srq->srqn);\r\nerr = mlx5_cmd_exec_check_status(dev, xrcsrq_in, sizeof(xrcsrq_in),\r\nxrcsrq_out,\r\nMLX5_ST_SZ_BYTES(query_xrc_srq_out));\r\nif (err)\r\ngoto out;\r\nxrc_srqc = MLX5_ADDR_OF(query_xrc_srq_out, xrcsrq_out,\r\nxrc_srq_context_entry);\r\nsrqc = MLX5_ADDR_OF(query_srq_out, out, srq_context_entry);\r\nmemcpy(srqc, xrc_srqc, MLX5_ST_SZ_BYTES(srqc));\r\nout:\r\nkvfree(xrcsrq_out);\r\nreturn err;\r\n}\r\nstatic int create_rmp_cmd(struct mlx5_core_dev *dev, struct mlx5_core_srq *srq,\r\nstruct mlx5_create_srq_mbox_in *in, int srq_inlen)\r\n{\r\nvoid *create_in;\r\nvoid *rmpc;\r\nvoid *srqc;\r\nint pas_size;\r\nint inlen;\r\nint err;\r\nsrqc = MLX5_ADDR_OF(create_srq_in, in, srq_context_entry);\r\npas_size = get_pas_size(srqc);\r\ninlen = MLX5_ST_SZ_BYTES(create_rmp_in) + pas_size;\r\ncreate_in = mlx5_vzalloc(inlen);\r\nif (!create_in)\r\nreturn -ENOMEM;\r\nrmpc = MLX5_ADDR_OF(create_rmp_in, create_in, ctx);\r\nmemcpy(MLX5_ADDR_OF(rmpc, rmpc, wq.pas), in->pas, pas_size);\r\nrmpc_srqc_reformat(srqc, rmpc, true);\r\nerr = mlx5_core_create_rmp(dev, create_in, inlen, &srq->srqn);\r\nkvfree(create_in);\r\nreturn err;\r\n}\r\nstatic int destroy_rmp_cmd(struct mlx5_core_dev *dev,\r\nstruct mlx5_core_srq *srq)\r\n{\r\nreturn mlx5_core_destroy_rmp(dev, srq->srqn);\r\n}\r\nstatic int arm_rmp_cmd(struct mlx5_core_dev *dev,\r\nstruct mlx5_core_srq *srq,\r\nu16 lwm)\r\n{\r\nvoid *in;\r\nvoid *rmpc;\r\nvoid *wq;\r\nvoid *bitmask;\r\nint err;\r\nin = mlx5_vzalloc(MLX5_ST_SZ_BYTES(modify_rmp_in));\r\nif (!in)\r\nreturn -ENOMEM;\r\nrmpc = MLX5_ADDR_OF(modify_rmp_in, in, ctx);\r\nbitmask = MLX5_ADDR_OF(modify_rmp_in, in, bitmask);\r\nwq = MLX5_ADDR_OF(rmpc, rmpc, wq);\r\nMLX5_SET(modify_rmp_in, in, rmp_state, MLX5_RMPC_STATE_RDY);\r\nMLX5_SET(modify_rmp_in, in, rmpn, srq->srqn);\r\nMLX5_SET(wq, wq, lwm, lwm);\r\nMLX5_SET(rmp_bitmask, bitmask, lwm, 1);\r\nMLX5_SET(rmpc, rmpc, state, MLX5_RMPC_STATE_RDY);\r\nerr = mlx5_core_modify_rmp(dev, in, MLX5_ST_SZ_BYTES(modify_rmp_in));\r\nkvfree(in);\r\nreturn err;\r\n}\r\nstatic int query_rmp_cmd(struct mlx5_core_dev *dev, struct mlx5_core_srq *srq,\r\nstruct mlx5_query_srq_mbox_out *out)\r\n{\r\nu32 *rmp_out;\r\nvoid *rmpc;\r\nvoid *srqc;\r\nint err;\r\nrmp_out = mlx5_vzalloc(MLX5_ST_SZ_BYTES(query_rmp_out));\r\nif (!rmp_out)\r\nreturn -ENOMEM;\r\nerr = mlx5_core_query_rmp(dev, srq->srqn, rmp_out);\r\nif (err)\r\ngoto out;\r\nsrqc = MLX5_ADDR_OF(query_srq_out, out, srq_context_entry);\r\nrmpc = MLX5_ADDR_OF(query_rmp_out, rmp_out, rmp_context);\r\nrmpc_srqc_reformat(srqc, rmpc, false);\r\nout:\r\nkvfree(rmp_out);\r\nreturn err;\r\n}\r\nstatic int create_srq_split(struct mlx5_core_dev *dev,\r\nstruct mlx5_core_srq *srq,\r\nstruct mlx5_create_srq_mbox_in *in,\r\nint inlen, int is_xrc)\r\n{\r\nif (!dev->issi)\r\nreturn create_srq_cmd(dev, srq, in, inlen);\r\nelse if (srq->common.res == MLX5_RES_XSRQ)\r\nreturn create_xrc_srq_cmd(dev, srq, in, inlen);\r\nelse\r\nreturn create_rmp_cmd(dev, srq, in, inlen);\r\n}\r\nstatic int destroy_srq_split(struct mlx5_core_dev *dev,\r\nstruct mlx5_core_srq *srq)\r\n{\r\nif (!dev->issi)\r\nreturn destroy_srq_cmd(dev, srq);\r\nelse if (srq->common.res == MLX5_RES_XSRQ)\r\nreturn destroy_xrc_srq_cmd(dev, srq);\r\nelse\r\nreturn destroy_rmp_cmd(dev, srq);\r\n}\r\nint mlx5_core_create_srq(struct mlx5_core_dev *dev, struct mlx5_core_srq *srq,\r\nstruct mlx5_create_srq_mbox_in *in, int inlen,\r\nint is_xrc)\r\n{\r\nint err;\r\nstruct mlx5_srq_table *table = &dev->priv.srq_table;\r\nsrq->common.res = is_xrc ? MLX5_RES_XSRQ : MLX5_RES_SRQ;\r\nerr = create_srq_split(dev, srq, in, inlen, is_xrc);\r\nif (err)\r\nreturn err;\r\natomic_set(&srq->refcount, 1);\r\ninit_completion(&srq->free);\r\nspin_lock_irq(&table->lock);\r\nerr = radix_tree_insert(&table->tree, srq->srqn, srq);\r\nspin_unlock_irq(&table->lock);\r\nif (err) {\r\nmlx5_core_warn(dev, "err %d, srqn 0x%x\n", err, srq->srqn);\r\ngoto err_destroy_srq_split;\r\n}\r\nreturn 0;\r\nerr_destroy_srq_split:\r\ndestroy_srq_split(dev, srq);\r\nreturn err;\r\n}\r\nint mlx5_core_destroy_srq(struct mlx5_core_dev *dev, struct mlx5_core_srq *srq)\r\n{\r\nstruct mlx5_srq_table *table = &dev->priv.srq_table;\r\nstruct mlx5_core_srq *tmp;\r\nint err;\r\nspin_lock_irq(&table->lock);\r\ntmp = radix_tree_delete(&table->tree, srq->srqn);\r\nspin_unlock_irq(&table->lock);\r\nif (!tmp) {\r\nmlx5_core_warn(dev, "srq 0x%x not found in tree\n", srq->srqn);\r\nreturn -EINVAL;\r\n}\r\nif (tmp != srq) {\r\nmlx5_core_warn(dev, "corruption on srqn 0x%x\n", srq->srqn);\r\nreturn -EINVAL;\r\n}\r\nerr = destroy_srq_split(dev, srq);\r\nif (err)\r\nreturn err;\r\nif (atomic_dec_and_test(&srq->refcount))\r\ncomplete(&srq->free);\r\nwait_for_completion(&srq->free);\r\nreturn 0;\r\n}\r\nint mlx5_core_query_srq(struct mlx5_core_dev *dev, struct mlx5_core_srq *srq,\r\nstruct mlx5_query_srq_mbox_out *out)\r\n{\r\nif (!dev->issi)\r\nreturn query_srq_cmd(dev, srq, out);\r\nelse if (srq->common.res == MLX5_RES_XSRQ)\r\nreturn query_xrc_srq_cmd(dev, srq, out);\r\nelse\r\nreturn query_rmp_cmd(dev, srq, out);\r\n}\r\nint mlx5_core_arm_srq(struct mlx5_core_dev *dev, struct mlx5_core_srq *srq,\r\nu16 lwm, int is_srq)\r\n{\r\nif (!dev->issi)\r\nreturn arm_srq_cmd(dev, srq, lwm, is_srq);\r\nelse if (srq->common.res == MLX5_RES_XSRQ)\r\nreturn arm_xrc_srq_cmd(dev, srq, lwm);\r\nelse\r\nreturn arm_rmp_cmd(dev, srq, lwm);\r\n}\r\nvoid mlx5_init_srq_table(struct mlx5_core_dev *dev)\r\n{\r\nstruct mlx5_srq_table *table = &dev->priv.srq_table;\r\nspin_lock_init(&table->lock);\r\nINIT_RADIX_TREE(&table->tree, GFP_ATOMIC);\r\n}\r\nvoid mlx5_cleanup_srq_table(struct mlx5_core_dev *dev)\r\n{\r\n}

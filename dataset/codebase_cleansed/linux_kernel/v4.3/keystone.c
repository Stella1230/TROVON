static int keystone_platform_notifier(struct notifier_block *nb,\r\nunsigned long event, void *data)\r\n{\r\nstruct device *dev = data;\r\nif (event != BUS_NOTIFY_ADD_DEVICE)\r\nreturn NOTIFY_DONE;\r\nif (!dev)\r\nreturn NOTIFY_BAD;\r\nif (!dev->of_node) {\r\ndev->dma_pfn_offset = keystone_dma_pfn_offset;\r\ndev_err(dev, "set dma_pfn_offset%08lx\n",\r\ndev->dma_pfn_offset);\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nstatic void __init keystone_init(void)\r\n{\r\nif (PHYS_OFFSET >= KEYSTONE_HIGH_PHYS_START) {\r\nkeystone_dma_pfn_offset = PFN_DOWN(KEYSTONE_HIGH_PHYS_START -\r\nKEYSTONE_LOW_PHYS_START);\r\nbus_register_notifier(&platform_bus_type, &platform_nb);\r\n}\r\nkeystone_pm_runtime_init();\r\nof_platform_populate(NULL, of_default_bus_match_table, NULL, NULL);\r\n}\r\nstatic phys_addr_t keystone_virt_to_idmap(unsigned long x)\r\n{\r\nreturn (phys_addr_t)(x) - CONFIG_PAGE_OFFSET + KEYSTONE_LOW_PHYS_START;\r\n}\r\nstatic long long __init keystone_pv_fixup(void)\r\n{\r\nlong long offset;\r\nphys_addr_t mem_start, mem_end;\r\nmem_start = memblock_start_of_DRAM();\r\nmem_end = memblock_end_of_DRAM();\r\nif (mem_start >= KEYSTONE_LOW_PHYS_START &&\r\nmem_end <= KEYSTONE_LOW_PHYS_END)\r\nreturn 0;\r\nif (mem_start < KEYSTONE_HIGH_PHYS_START ||\r\nmem_end > KEYSTONE_HIGH_PHYS_END) {\r\npr_crit("Invalid address space for memory (%08llx-%08llx)\n",\r\n(u64)mem_start, (u64)mem_end);\r\nreturn 0;\r\n}\r\noffset = KEYSTONE_HIGH_PHYS_START - KEYSTONE_LOW_PHYS_START;\r\narch_virt_to_idmap = keystone_virt_to_idmap;\r\nreturn offset;\r\n}

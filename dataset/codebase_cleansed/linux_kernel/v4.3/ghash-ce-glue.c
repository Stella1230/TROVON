static int ghash_init(struct shash_desc *desc)\r\n{\r\nstruct ghash_desc_ctx *ctx = shash_desc_ctx(desc);\r\n*ctx = (struct ghash_desc_ctx){};\r\nreturn 0;\r\n}\r\nstatic int ghash_update(struct shash_desc *desc, const u8 *src,\r\nunsigned int len)\r\n{\r\nstruct ghash_desc_ctx *ctx = shash_desc_ctx(desc);\r\nunsigned int partial = ctx->count % GHASH_BLOCK_SIZE;\r\nctx->count += len;\r\nif ((partial + len) >= GHASH_BLOCK_SIZE) {\r\nstruct ghash_key *key = crypto_shash_ctx(desc->tfm);\r\nint blocks;\r\nif (partial) {\r\nint p = GHASH_BLOCK_SIZE - partial;\r\nmemcpy(ctx->buf + partial, src, p);\r\nsrc += p;\r\nlen -= p;\r\n}\r\nblocks = len / GHASH_BLOCK_SIZE;\r\nlen %= GHASH_BLOCK_SIZE;\r\nkernel_neon_begin_partial(8);\r\npmull_ghash_update(blocks, ctx->digest, src, key,\r\npartial ? ctx->buf : NULL);\r\nkernel_neon_end();\r\nsrc += blocks * GHASH_BLOCK_SIZE;\r\npartial = 0;\r\n}\r\nif (len)\r\nmemcpy(ctx->buf + partial, src, len);\r\nreturn 0;\r\n}\r\nstatic int ghash_final(struct shash_desc *desc, u8 *dst)\r\n{\r\nstruct ghash_desc_ctx *ctx = shash_desc_ctx(desc);\r\nunsigned int partial = ctx->count % GHASH_BLOCK_SIZE;\r\nif (partial) {\r\nstruct ghash_key *key = crypto_shash_ctx(desc->tfm);\r\nmemset(ctx->buf + partial, 0, GHASH_BLOCK_SIZE - partial);\r\nkernel_neon_begin_partial(8);\r\npmull_ghash_update(1, ctx->digest, ctx->buf, key, NULL);\r\nkernel_neon_end();\r\n}\r\nput_unaligned_be64(ctx->digest[1], dst);\r\nput_unaligned_be64(ctx->digest[0], dst + 8);\r\n*ctx = (struct ghash_desc_ctx){};\r\nreturn 0;\r\n}\r\nstatic int ghash_setkey(struct crypto_shash *tfm,\r\nconst u8 *inkey, unsigned int keylen)\r\n{\r\nstruct ghash_key *key = crypto_shash_ctx(tfm);\r\nu64 a, b;\r\nif (keylen != GHASH_BLOCK_SIZE) {\r\ncrypto_shash_set_flags(tfm, CRYPTO_TFM_RES_BAD_KEY_LEN);\r\nreturn -EINVAL;\r\n}\r\nb = get_unaligned_be64(inkey);\r\na = get_unaligned_be64(inkey + 8);\r\nkey->a = (a << 1) | (b >> 63);\r\nkey->b = (b << 1) | (a >> 63);\r\nif (b >> 63)\r\nkey->b ^= 0xc200000000000000UL;\r\nreturn 0;\r\n}\r\nstatic int __init ghash_ce_mod_init(void)\r\n{\r\nreturn crypto_register_shash(&ghash_alg);\r\n}\r\nstatic void __exit ghash_ce_mod_exit(void)\r\n{\r\ncrypto_unregister_shash(&ghash_alg);\r\n}

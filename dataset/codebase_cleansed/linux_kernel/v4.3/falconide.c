static void falconide_release_lock(void)\r\n{\r\nif (falconide_intr_lock == 0) {\r\nprintk(KERN_ERR "%s: bug\n", __func__);\r\nreturn;\r\n}\r\nfalconide_intr_lock = 0;\r\nstdma_release();\r\n}\r\nstatic void falconide_get_lock(irq_handler_t handler, void *data)\r\n{\r\nif (falconide_intr_lock == 0) {\r\nif (in_interrupt() > 0)\r\npanic("Falcon IDE hasn't ST-DMA lock in interrupt");\r\nstdma_lock(handler, data);\r\nfalconide_intr_lock = 1;\r\n}\r\n}\r\nstatic void falconide_input_data(ide_drive_t *drive, struct ide_cmd *cmd,\r\nvoid *buf, unsigned int len)\r\n{\r\nunsigned long data_addr = drive->hwif->io_ports.data_addr;\r\nif (drive->media == ide_disk && cmd && (cmd->tf_flags & IDE_TFLAG_FS)) {\r\n__ide_mm_insw(data_addr, buf, (len + 1) / 2);\r\nreturn;\r\n}\r\nraw_insw_swapw((u16 *)data_addr, buf, (len + 1) / 2);\r\n}\r\nstatic void falconide_output_data(ide_drive_t *drive, struct ide_cmd *cmd,\r\nvoid *buf, unsigned int len)\r\n{\r\nunsigned long data_addr = drive->hwif->io_ports.data_addr;\r\nif (drive->media == ide_disk && cmd && (cmd->tf_flags & IDE_TFLAG_FS)) {\r\n__ide_mm_outsw(data_addr, buf, (len + 1) / 2);\r\nreturn;\r\n}\r\nraw_outsw_swapw((u16 *)data_addr, buf, (len + 1) / 2);\r\n}\r\nstatic void __init falconide_setup_ports(struct ide_hw *hw)\r\n{\r\nint i;\r\nmemset(hw, 0, sizeof(*hw));\r\nhw->io_ports.data_addr = ATA_HD_BASE;\r\nfor (i = 1; i < 8; i++)\r\nhw->io_ports_array[i] = ATA_HD_BASE + 1 + i * 4;\r\nhw->io_ports.ctl_addr = ATA_HD_BASE + ATA_HD_CONTROL;\r\nhw->irq = IRQ_MFP_IDE;\r\n}\r\nstatic int __init falconide_init(void)\r\n{\r\nstruct ide_host *host;\r\nstruct ide_hw hw, *hws[] = { &hw };\r\nint rc;\r\nif (!MACH_IS_ATARI || !ATARIHW_PRESENT(IDE))\r\nreturn -ENODEV;\r\nprintk(KERN_INFO "ide: Falcon IDE controller\n");\r\nif (!request_mem_region(ATA_HD_BASE, 0x40, DRV_NAME)) {\r\nprintk(KERN_ERR "%s: resources busy\n", DRV_NAME);\r\nreturn -EBUSY;\r\n}\r\nfalconide_setup_ports(&hw);\r\nhost = ide_host_alloc(&falconide_port_info, hws, 1);\r\nif (host == NULL) {\r\nrc = -ENOMEM;\r\ngoto err;\r\n}\r\nfalconide_get_lock(NULL, NULL);\r\nrc = ide_host_register(host, &falconide_port_info, hws);\r\nfalconide_release_lock();\r\nif (rc)\r\ngoto err_free;\r\nreturn 0;\r\nerr_free:\r\nide_host_free(host);\r\nerr:\r\nrelease_mem_region(ATA_HD_BASE, 0x40);\r\nreturn rc;\r\n}

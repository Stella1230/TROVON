static int rdmsr(unsigned int cpu, unsigned int msr,\r\nunsigned int *lo, unsigned int *hi)\r\n{\r\nint fd;\r\nchar file[20];\r\nunsigned long long val;\r\nint retval = -1;\r\n*lo = *hi = 0;\r\nif (cpu > MCPU)\r\ngoto err1;\r\nsprintf(file, "/dev/cpu/%d/msr", cpu);\r\nfd = open(file, O_RDONLY);\r\nif (fd < 0)\r\ngoto err1;\r\nif (lseek(fd, msr, SEEK_CUR) == -1)\r\ngoto err2;\r\nif (read(fd, &val, 8) != 8)\r\ngoto err2;\r\n*lo = (uint32_t )(val & 0xffffffffull);\r\n*hi = (uint32_t )(val>>32 & 0xffffffffull);\r\nretval = 0;\r\nerr2:\r\nclose(fd);\r\nerr1:\r\nreturn retval;\r\n}\r\nstatic void decode (unsigned int msr)\r\n{\r\nunsigned int multiplier;\r\nunsigned int mv;\r\nmultiplier = ((msr >> 8) & 0xFF);\r\nmv = (((msr & 0xFF) * 16) + 700);\r\nprintf("0x%x means multiplier %d @ %d mV\n", msr, multiplier, mv);\r\n}\r\nstatic int decode_live(unsigned int cpu)\r\n{\r\nunsigned int lo, hi;\r\nint err;\r\nerr = rdmsr(cpu, MSR_IA32_PERF_STATUS, &lo, &hi);\r\nif (err) {\r\nprintf("can't get MSR_IA32_PERF_STATUS for cpu %d\n", cpu);\r\nprintf("Possible trouble: you don't run an Enhanced SpeedStep capable cpu\n");\r\nprintf("or you are not root, or the msr driver is not present\n");\r\nreturn 1;\r\n}\r\ndecode(lo);\r\nreturn 0;\r\n}\r\nint main (int argc, char **argv)\r\n{\r\nunsigned int cpu, mode = 0;\r\nif (argc < 2)\r\ncpu = 0;\r\nelse {\r\ncpu = strtoul(argv[1], NULL, 0);\r\nif (cpu >= MCPU)\r\nmode = 1;\r\n}\r\nif (mode)\r\ndecode(cpu);\r\nelse\r\ndecode_live(cpu);\r\nreturn 0;\r\n}

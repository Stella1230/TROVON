static const struct radar_types *\r\nget_dfs_domain_radar_types(enum nl80211_dfs_regions region)\r\n{\r\nu32 i;\r\nfor (i = 0; i < ARRAY_SIZE(dfs_domains); i++) {\r\nif (dfs_domains[i]->region == region)\r\nreturn dfs_domains[i];\r\n}\r\nreturn NULL;\r\n}\r\nstatic void channel_detector_reset(struct dfs_pattern_detector *dpd,\r\nstruct channel_detector *cd)\r\n{\r\nu32 i;\r\nif (cd == NULL)\r\nreturn;\r\nfor (i = 0; i < dpd->num_radar_types; i++)\r\ncd->detectors[i]->reset(cd->detectors[i], dpd->last_pulse_ts);\r\n}\r\nstatic void channel_detector_exit(struct dfs_pattern_detector *dpd,\r\nstruct channel_detector *cd)\r\n{\r\nu32 i;\r\nif (cd == NULL)\r\nreturn;\r\nlist_del(&cd->head);\r\nfor (i = 0; i < dpd->num_radar_types; i++) {\r\nstruct pri_detector *de = cd->detectors[i];\r\nif (de != NULL)\r\nde->exit(de);\r\n}\r\nkfree(cd->detectors);\r\nkfree(cd);\r\n}\r\nstatic struct channel_detector *\r\nchannel_detector_create(struct dfs_pattern_detector *dpd, u16 freq)\r\n{\r\nu32 sz, i;\r\nstruct channel_detector *cd;\r\ncd = kmalloc(sizeof(*cd), GFP_ATOMIC);\r\nif (cd == NULL)\r\ngoto fail;\r\nINIT_LIST_HEAD(&cd->head);\r\ncd->freq = freq;\r\nsz = sizeof(cd->detectors) * dpd->num_radar_types;\r\ncd->detectors = kzalloc(sz, GFP_ATOMIC);\r\nif (cd->detectors == NULL)\r\ngoto fail;\r\nfor (i = 0; i < dpd->num_radar_types; i++) {\r\nconst struct radar_detector_specs *rs = &dpd->radar_spec[i];\r\nstruct pri_detector *de = pri_detector_init(rs);\r\nif (de == NULL)\r\ngoto fail;\r\ncd->detectors[i] = de;\r\n}\r\nlist_add(&cd->head, &dpd->channel_detectors);\r\nreturn cd;\r\nfail:\r\nath_dbg(dpd->common, DFS,\r\n"failed to allocate channel_detector for freq=%d\n", freq);\r\nchannel_detector_exit(dpd, cd);\r\nreturn NULL;\r\n}\r\nstatic struct channel_detector *\r\nchannel_detector_get(struct dfs_pattern_detector *dpd, u16 freq)\r\n{\r\nstruct channel_detector *cd;\r\nlist_for_each_entry(cd, &dpd->channel_detectors, head) {\r\nif (cd->freq == freq)\r\nreturn cd;\r\n}\r\nreturn channel_detector_create(dpd, freq);\r\n}\r\nstatic void dpd_reset(struct dfs_pattern_detector *dpd)\r\n{\r\nstruct channel_detector *cd;\r\nif (!list_empty(&dpd->channel_detectors))\r\nlist_for_each_entry(cd, &dpd->channel_detectors, head)\r\nchannel_detector_reset(dpd, cd);\r\n}\r\nstatic void dpd_exit(struct dfs_pattern_detector *dpd)\r\n{\r\nstruct channel_detector *cd, *cd0;\r\nif (!list_empty(&dpd->channel_detectors))\r\nlist_for_each_entry_safe(cd, cd0, &dpd->channel_detectors, head)\r\nchannel_detector_exit(dpd, cd);\r\nkfree(dpd);\r\n}\r\nstatic bool\r\ndpd_add_pulse(struct dfs_pattern_detector *dpd, struct pulse_event *event)\r\n{\r\nu32 i;\r\nstruct channel_detector *cd;\r\nif (dpd->region == NL80211_DFS_UNSET)\r\nreturn true;\r\ncd = channel_detector_get(dpd, event->freq);\r\nif (cd == NULL)\r\nreturn false;\r\ndpd->last_pulse_ts = event->ts;\r\nif (event->ts < dpd->last_pulse_ts)\r\ndpd_reset(dpd);\r\nfor (i = 0; i < dpd->num_radar_types; i++) {\r\nstruct pri_detector *pd = cd->detectors[i];\r\nstruct pri_sequence *ps = pd->add_pulse(pd, event);\r\nif (ps != NULL) {\r\nath_dbg(dpd->common, DFS,\r\n"DFS: radar found on freq=%d: id=%d, pri=%d, "\r\n"count=%d, count_false=%d\n",\r\nevent->freq, pd->rs->type_id,\r\nps->pri, ps->count, ps->count_falses);\r\npd->reset(pd, dpd->last_pulse_ts);\r\nreturn true;\r\n}\r\n}\r\nreturn false;\r\n}\r\nstatic struct ath_dfs_pool_stats\r\ndpd_get_stats(struct dfs_pattern_detector *dpd)\r\n{\r\nreturn global_dfs_pool_stats;\r\n}\r\nstatic bool dpd_set_domain(struct dfs_pattern_detector *dpd,\r\nenum nl80211_dfs_regions region)\r\n{\r\nconst struct radar_types *rt;\r\nstruct channel_detector *cd, *cd0;\r\nif (dpd->region == region)\r\nreturn true;\r\ndpd->region = NL80211_DFS_UNSET;\r\nrt = get_dfs_domain_radar_types(region);\r\nif (rt == NULL)\r\nreturn false;\r\nif (!list_empty(&dpd->channel_detectors))\r\nlist_for_each_entry_safe(cd, cd0, &dpd->channel_detectors, head)\r\nchannel_detector_exit(dpd, cd);\r\ndpd->radar_spec = rt->radar_types;\r\ndpd->num_radar_types = rt->num_radar_types;\r\ndpd->region = region;\r\nreturn true;\r\n}\r\nstruct dfs_pattern_detector *\r\ndfs_pattern_detector_init(struct ath_common *common,\r\nenum nl80211_dfs_regions region)\r\n{\r\nstruct dfs_pattern_detector *dpd;\r\nif (!config_enabled(CONFIG_CFG80211_CERTIFICATION_ONUS))\r\nreturn NULL;\r\ndpd = kmalloc(sizeof(*dpd), GFP_KERNEL);\r\nif (dpd == NULL)\r\nreturn NULL;\r\n*dpd = default_dpd;\r\nINIT_LIST_HEAD(&dpd->channel_detectors);\r\ndpd->common = common;\r\nif (dpd->set_dfs_domain(dpd, region))\r\nreturn dpd;\r\nath_dbg(common, DFS,"Could not set DFS domain to %d", region);\r\nkfree(dpd);\r\nreturn NULL;\r\n}

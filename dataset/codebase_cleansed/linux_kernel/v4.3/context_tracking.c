static bool context_tracking_recursion_enter(void)\r\n{\r\nint recursion;\r\nrecursion = __this_cpu_inc_return(context_tracking.recursion);\r\nif (recursion == 1)\r\nreturn true;\r\nWARN_ONCE((recursion < 1), "Invalid context tracking recursion value %d\n", recursion);\r\n__this_cpu_dec(context_tracking.recursion);\r\nreturn false;\r\n}\r\nstatic void context_tracking_recursion_exit(void)\r\n{\r\n__this_cpu_dec(context_tracking.recursion);\r\n}\r\nvoid context_tracking_enter(enum ctx_state state)\r\n{\r\nunsigned long flags;\r\nif (!context_tracking_is_enabled())\r\nreturn;\r\nif (in_interrupt())\r\nreturn;\r\nWARN_ON_ONCE(!current->mm);\r\nlocal_irq_save(flags);\r\nif (!context_tracking_recursion_enter())\r\ngoto out_irq_restore;\r\nif ( __this_cpu_read(context_tracking.state) != state) {\r\nif (__this_cpu_read(context_tracking.active)) {\r\nif (state == CONTEXT_USER) {\r\ntrace_user_enter(0);\r\nvtime_user_enter(current);\r\n}\r\nrcu_user_enter();\r\n}\r\n__this_cpu_write(context_tracking.state, state);\r\n}\r\ncontext_tracking_recursion_exit();\r\nout_irq_restore:\r\nlocal_irq_restore(flags);\r\n}\r\nvoid context_tracking_user_enter(void)\r\n{\r\ncontext_tracking_enter(CONTEXT_USER);\r\n}\r\nvoid context_tracking_exit(enum ctx_state state)\r\n{\r\nunsigned long flags;\r\nif (!context_tracking_is_enabled())\r\nreturn;\r\nif (in_interrupt())\r\nreturn;\r\nlocal_irq_save(flags);\r\nif (!context_tracking_recursion_enter())\r\ngoto out_irq_restore;\r\nif (__this_cpu_read(context_tracking.state) == state) {\r\nif (__this_cpu_read(context_tracking.active)) {\r\nrcu_user_exit();\r\nif (state == CONTEXT_USER) {\r\nvtime_user_exit(current);\r\ntrace_user_exit(0);\r\n}\r\n}\r\n__this_cpu_write(context_tracking.state, CONTEXT_KERNEL);\r\n}\r\ncontext_tracking_recursion_exit();\r\nout_irq_restore:\r\nlocal_irq_restore(flags);\r\n}\r\nvoid context_tracking_user_exit(void)\r\n{\r\ncontext_tracking_exit(CONTEXT_USER);\r\n}\r\nvoid __init context_tracking_cpu_set(int cpu)\r\n{\r\nstatic __initdata bool initialized = false;\r\nif (!per_cpu(context_tracking.active, cpu)) {\r\nper_cpu(context_tracking.active, cpu) = true;\r\nstatic_key_slow_inc(&context_tracking_enabled);\r\n}\r\nif (initialized)\r\nreturn;\r\nset_tsk_thread_flag(&init_task, TIF_NOHZ);\r\nWARN_ON_ONCE(!tasklist_empty());\r\ninitialized = true;\r\n}\r\nvoid __init context_tracking_init(void)\r\n{\r\nint cpu;\r\nfor_each_possible_cpu(cpu)\r\ncontext_tracking_cpu_set(cpu);\r\n}

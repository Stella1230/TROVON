void\r\nbfa_hwcb_reginit(struct bfa_s *bfa)\r\n{\r\nstruct bfa_iocfc_regs_s *bfa_regs = &bfa->iocfc.bfa_regs;\r\nvoid __iomem *kva = bfa_ioc_bar0(&bfa->ioc);\r\nint fn = bfa_ioc_pcifn(&bfa->ioc);\r\nif (fn == 0) {\r\nbfa_regs->intr_status = (kva + HOSTFN0_INT_STATUS);\r\nbfa_regs->intr_mask = (kva + HOSTFN0_INT_MSK);\r\n} else {\r\nbfa_regs->intr_status = (kva + HOSTFN1_INT_STATUS);\r\nbfa_regs->intr_mask = (kva + HOSTFN1_INT_MSK);\r\n}\r\n}\r\nstatic void\r\nbfa_hwcb_reqq_ack_msix(struct bfa_s *bfa, int reqq)\r\n{\r\nwritel(__HFN_INT_CPE_Q0 << CPE_Q_NUM(bfa_ioc_pcifn(&bfa->ioc), reqq),\r\nbfa->iocfc.bfa_regs.intr_status);\r\n}\r\nstatic void\r\nbfa_hwcb_rspq_ack_msix(struct bfa_s *bfa, int rspq, u32 ci)\r\n{\r\nwritel(__HFN_INT_RME_Q0 << RME_Q_NUM(bfa_ioc_pcifn(&bfa->ioc), rspq),\r\nbfa->iocfc.bfa_regs.intr_status);\r\nif (bfa_rspq_ci(bfa, rspq) == ci)\r\nreturn;\r\nbfa_rspq_ci(bfa, rspq) = ci;\r\nwritel(ci, bfa->iocfc.bfa_regs.rme_q_ci[rspq]);\r\nmmiowb();\r\n}\r\nvoid\r\nbfa_hwcb_rspq_ack(struct bfa_s *bfa, int rspq, u32 ci)\r\n{\r\nif (bfa_rspq_ci(bfa, rspq) == ci)\r\nreturn;\r\nbfa_rspq_ci(bfa, rspq) = ci;\r\nwritel(ci, bfa->iocfc.bfa_regs.rme_q_ci[rspq]);\r\nmmiowb();\r\n}\r\nvoid\r\nbfa_hwcb_msix_getvecs(struct bfa_s *bfa, u32 *msix_vecs_bmap,\r\nu32 *num_vecs, u32 *max_vec_bit)\r\n{\r\n#define __HFN_NUMINTS 13\r\nif (bfa_ioc_pcifn(&bfa->ioc) == 0) {\r\n*msix_vecs_bmap = (__HFN_INT_CPE_Q0 | __HFN_INT_CPE_Q1 |\r\n__HFN_INT_CPE_Q2 | __HFN_INT_CPE_Q3 |\r\n__HFN_INT_RME_Q0 | __HFN_INT_RME_Q1 |\r\n__HFN_INT_RME_Q2 | __HFN_INT_RME_Q3 |\r\n__HFN_INT_MBOX_LPU0);\r\n*max_vec_bit = __HFN_INT_MBOX_LPU0;\r\n} else {\r\n*msix_vecs_bmap = (__HFN_INT_CPE_Q4 | __HFN_INT_CPE_Q5 |\r\n__HFN_INT_CPE_Q6 | __HFN_INT_CPE_Q7 |\r\n__HFN_INT_RME_Q4 | __HFN_INT_RME_Q5 |\r\n__HFN_INT_RME_Q6 | __HFN_INT_RME_Q7 |\r\n__HFN_INT_MBOX_LPU1);\r\n*max_vec_bit = __HFN_INT_MBOX_LPU1;\r\n}\r\n*msix_vecs_bmap |= (__HFN_INT_ERR_EMC | __HFN_INT_ERR_LPU0 |\r\n__HFN_INT_ERR_LPU1 | __HFN_INT_ERR_PSS);\r\n*num_vecs = __HFN_NUMINTS;\r\n}\r\nstatic void\r\nbfa_hwcb_msix_dummy(struct bfa_s *bfa, int vec)\r\n{\r\n}\r\nvoid\r\nbfa_hwcb_msix_init(struct bfa_s *bfa, int nvecs)\r\n{\r\nWARN_ON((nvecs != 1) && (nvecs != __HFN_NUMINTS));\r\nbfa->msix.nvecs = nvecs;\r\nbfa_hwcb_msix_uninstall(bfa);\r\n}\r\nvoid\r\nbfa_hwcb_msix_ctrl_install(struct bfa_s *bfa)\r\n{\r\nint i;\r\nif (bfa->msix.nvecs == 0)\r\nreturn;\r\nif (bfa->msix.nvecs == 1) {\r\nfor (i = BFI_MSIX_CPE_QMIN_CB; i < BFI_MSIX_CB_MAX; i++)\r\nbfa->msix.handler[i] = bfa_msix_all;\r\nreturn;\r\n}\r\nfor (i = BFI_MSIX_RME_QMAX_CB+1; i < BFI_MSIX_CB_MAX; i++)\r\nbfa->msix.handler[i] = bfa_msix_lpu_err;\r\n}\r\nvoid\r\nbfa_hwcb_msix_queue_install(struct bfa_s *bfa)\r\n{\r\nint i;\r\nif (bfa->msix.nvecs == 0)\r\nreturn;\r\nif (bfa->msix.nvecs == 1) {\r\nfor (i = BFI_MSIX_CPE_QMIN_CB; i <= BFI_MSIX_RME_QMAX_CB; i++)\r\nbfa->msix.handler[i] = bfa_msix_all;\r\nreturn;\r\n}\r\nfor (i = BFI_MSIX_CPE_QMIN_CB; i <= BFI_MSIX_CPE_QMAX_CB; i++)\r\nbfa->msix.handler[i] = bfa_msix_reqq;\r\nfor (i = BFI_MSIX_RME_QMIN_CB; i <= BFI_MSIX_RME_QMAX_CB; i++)\r\nbfa->msix.handler[i] = bfa_msix_rspq;\r\n}\r\nvoid\r\nbfa_hwcb_msix_uninstall(struct bfa_s *bfa)\r\n{\r\nint i;\r\nfor (i = 0; i < BFI_MSIX_CB_MAX; i++)\r\nbfa->msix.handler[i] = bfa_hwcb_msix_dummy;\r\n}\r\nvoid\r\nbfa_hwcb_isr_mode_set(struct bfa_s *bfa, bfa_boolean_t msix)\r\n{\r\nif (msix) {\r\nbfa->iocfc.hwif.hw_reqq_ack = bfa_hwcb_reqq_ack_msix;\r\nbfa->iocfc.hwif.hw_rspq_ack = bfa_hwcb_rspq_ack_msix;\r\n} else {\r\nbfa->iocfc.hwif.hw_reqq_ack = NULL;\r\nbfa->iocfc.hwif.hw_rspq_ack = bfa_hwcb_rspq_ack;\r\n}\r\n}\r\nvoid\r\nbfa_hwcb_msix_get_rme_range(struct bfa_s *bfa, u32 *start, u32 *end)\r\n{\r\n*start = BFI_MSIX_RME_QMIN_CB;\r\n*end = BFI_MSIX_RME_QMAX_CB;\r\n}

static int ptl_send_buf(lnet_handle_md_t *mdh, void *base, int len,\r\nlnet_ack_req_t ack, struct ptlrpc_cb_id *cbid,\r\nstruct ptlrpc_connection *conn, int portal, __u64 xid,\r\nunsigned int offset)\r\n{\r\nint rc;\r\nlnet_md_t md;\r\nLASSERT(portal != 0);\r\nLASSERT(conn != NULL);\r\nCDEBUG(D_INFO, "conn=%p id %s\n", conn, libcfs_id2str(conn->c_peer));\r\nmd.start = base;\r\nmd.length = len;\r\nmd.threshold = (ack == LNET_ACK_REQ) ? 2 : 1;\r\nmd.options = PTLRPC_MD_OPTIONS;\r\nmd.user_ptr = cbid;\r\nmd.eq_handle = ptlrpc_eq_h;\r\nif (unlikely(ack == LNET_ACK_REQ &&\r\nOBD_FAIL_CHECK_ORSET(OBD_FAIL_PTLRPC_ACK,\r\nOBD_FAIL_ONCE))) {\r\nack = LNET_NOACK_REQ;\r\n}\r\nrc = LNetMDBind(md, LNET_UNLINK, mdh);\r\nif (unlikely(rc != 0)) {\r\nCERROR("LNetMDBind failed: %d\n", rc);\r\nLASSERT(rc == -ENOMEM);\r\nreturn -ENOMEM;\r\n}\r\nCDEBUG(D_NET, "Sending %d bytes to portal %d, xid %lld, offset %u\n",\r\nlen, portal, xid, offset);\r\nrc = LNetPut(conn->c_self, *mdh, ack,\r\nconn->c_peer, portal, xid, offset, 0);\r\nif (unlikely(rc != 0)) {\r\nint rc2;\r\nCERROR("LNetPut(%s, %d, %lld) failed: %d\n",\r\nlibcfs_id2str(conn->c_peer), portal, xid, rc);\r\nrc2 = LNetMDUnlink(*mdh);\r\nLASSERTF(rc2 == 0, "rc2 = %d\n", rc2);\r\n}\r\nreturn 0;\r\n}\r\nstatic void mdunlink_iterate_helper(lnet_handle_md_t *bd_mds, int count)\r\n{\r\nint i;\r\nfor (i = 0; i < count; i++)\r\nLNetMDUnlink(bd_mds[i]);\r\n}\r\nint ptlrpc_register_bulk(struct ptlrpc_request *req)\r\n{\r\nstruct ptlrpc_bulk_desc *desc = req->rq_bulk;\r\nlnet_process_id_t peer;\r\nint rc = 0;\r\nint rc2;\r\nint posted_md;\r\nint total_md;\r\n__u64 xid;\r\nlnet_handle_me_t me_h;\r\nlnet_md_t md;\r\nif (OBD_FAIL_CHECK(OBD_FAIL_PTLRPC_BULK_GET_NET))\r\nreturn 0;\r\nLASSERT(desc->bd_nob > 0);\r\nLASSERT(desc->bd_md_count == 0);\r\nLASSERT(desc->bd_md_max_brw <= PTLRPC_BULK_OPS_COUNT);\r\nLASSERT(desc->bd_iov_count <= PTLRPC_MAX_BRW_PAGES);\r\nLASSERT(desc->bd_req != NULL);\r\nLASSERT(desc->bd_type == BULK_PUT_SINK ||\r\ndesc->bd_type == BULK_GET_SOURCE);\r\nif (req->rq_resend || req->rq_send_state == LUSTRE_IMP_REPLAY)\r\ndesc->bd_nob_transferred = 0;\r\nelse\r\nLASSERT(desc->bd_nob_transferred == 0);\r\ndesc->bd_failure = 0;\r\npeer = desc->bd_import->imp_connection->c_peer;\r\nLASSERT(desc->bd_cbid.cbid_fn == client_bulk_callback);\r\nLASSERT(desc->bd_cbid.cbid_arg == desc);\r\nxid = req->rq_xid & ~((__u64)desc->bd_md_max_brw - 1);\r\nLASSERTF(!(desc->bd_registered &&\r\nreq->rq_send_state != LUSTRE_IMP_REPLAY) ||\r\nxid != desc->bd_last_xid,\r\n"registered: %d rq_xid: %llu bd_last_xid: %llu\n",\r\ndesc->bd_registered, xid, desc->bd_last_xid);\r\ntotal_md = (desc->bd_iov_count + LNET_MAX_IOV - 1) / LNET_MAX_IOV;\r\ndesc->bd_registered = 1;\r\ndesc->bd_last_xid = xid;\r\ndesc->bd_md_count = total_md;\r\nmd.user_ptr = &desc->bd_cbid;\r\nmd.eq_handle = ptlrpc_eq_h;\r\nmd.threshold = 1;\r\nfor (posted_md = 0; posted_md < total_md; posted_md++, xid++) {\r\nmd.options = PTLRPC_MD_OPTIONS |\r\n((desc->bd_type == BULK_GET_SOURCE) ?\r\nLNET_MD_OP_GET : LNET_MD_OP_PUT);\r\nptlrpc_fill_bulk_md(&md, desc, posted_md);\r\nrc = LNetMEAttach(desc->bd_portal, peer, xid, 0,\r\nLNET_UNLINK, LNET_INS_AFTER, &me_h);\r\nif (rc != 0) {\r\nCERROR("%s: LNetMEAttach failed x%llu/%d: rc = %d\n",\r\ndesc->bd_import->imp_obd->obd_name, xid,\r\nposted_md, rc);\r\nbreak;\r\n}\r\nrc = LNetMDAttach(me_h, md, LNET_UNLINK,\r\n&desc->bd_mds[posted_md]);\r\nif (rc != 0) {\r\nCERROR("%s: LNetMDAttach failed x%llu/%d: rc = %d\n",\r\ndesc->bd_import->imp_obd->obd_name, xid,\r\nposted_md, rc);\r\nrc2 = LNetMEUnlink(me_h);\r\nLASSERT(rc2 == 0);\r\nbreak;\r\n}\r\n}\r\nif (rc != 0) {\r\nLASSERT(rc == -ENOMEM);\r\nspin_lock(&desc->bd_lock);\r\ndesc->bd_md_count -= total_md - posted_md;\r\nspin_unlock(&desc->bd_lock);\r\nLASSERT(desc->bd_md_count >= 0);\r\nmdunlink_iterate_helper(desc->bd_mds, desc->bd_md_max_brw);\r\nreq->rq_status = -ENOMEM;\r\nreturn -ENOMEM;\r\n}\r\nreq->rq_xid = --xid;\r\nLASSERTF(desc->bd_last_xid == (req->rq_xid & PTLRPC_BULK_OPS_MASK),\r\n"bd_last_xid = x%llu, rq_xid = x%llu\n",\r\ndesc->bd_last_xid, req->rq_xid);\r\nspin_lock(&desc->bd_lock);\r\nif (desc->bd_md_count != total_md)\r\nCWARN("%s: Peer %s touched %d buffers while I registered\n",\r\ndesc->bd_import->imp_obd->obd_name, libcfs_id2str(peer),\r\ntotal_md - desc->bd_md_count);\r\nspin_unlock(&desc->bd_lock);\r\nCDEBUG(D_NET, "Setup %u bulk %s buffers: %u pages %u bytes, xid x%#llx-%#llx, portal %u\n",\r\ndesc->bd_md_count,\r\ndesc->bd_type == BULK_GET_SOURCE ? "get-source" : "put-sink",\r\ndesc->bd_iov_count, desc->bd_nob,\r\ndesc->bd_last_xid, req->rq_xid, desc->bd_portal);\r\nreturn 0;\r\n}\r\nint ptlrpc_unregister_bulk(struct ptlrpc_request *req, int async)\r\n{\r\nstruct ptlrpc_bulk_desc *desc = req->rq_bulk;\r\nwait_queue_head_t *wq;\r\nstruct l_wait_info lwi;\r\nint rc;\r\nLASSERT(!in_interrupt());\r\nif (OBD_FAIL_CHECK(OBD_FAIL_PTLRPC_LONG_BULK_UNLINK) &&\r\nasync && req->rq_bulk_deadline == 0)\r\nreq->rq_bulk_deadline = get_seconds() + LONG_UNLINK;\r\nif (ptlrpc_client_bulk_active(req) == 0)\r\nreturn 1;\r\nLASSERT(desc->bd_req == req);\r\nmdunlink_iterate_helper(desc->bd_mds, desc->bd_md_max_brw);\r\nif (ptlrpc_client_bulk_active(req) == 0)\r\nreturn 1;\r\nptlrpc_rqphase_move(req, RQ_PHASE_UNREGISTERING);\r\nif (async)\r\nreturn 0;\r\nif (req->rq_set != NULL)\r\nwq = &req->rq_set->set_waitq;\r\nelse\r\nwq = &req->rq_reply_waitq;\r\nfor (;;) {\r\nlwi = LWI_TIMEOUT_INTERVAL(cfs_time_seconds(LONG_UNLINK),\r\ncfs_time_seconds(1), NULL, NULL);\r\nrc = l_wait_event(*wq, !ptlrpc_client_bulk_active(req), &lwi);\r\nif (rc == 0) {\r\nptlrpc_rqphase_move(req, req->rq_next_phase);\r\nreturn 1;\r\n}\r\nLASSERT(rc == -ETIMEDOUT);\r\nDEBUG_REQ(D_WARNING, req, "Unexpectedly long timeout: desc %p",\r\ndesc);\r\n}\r\nreturn 0;\r\n}\r\nstatic void ptlrpc_at_set_reply(struct ptlrpc_request *req, int flags)\r\n{\r\nstruct ptlrpc_service_part *svcpt = req->rq_rqbd->rqbd_svcpt;\r\nstruct ptlrpc_service *svc = svcpt->scp_service;\r\nint service_time = max_t(int, get_seconds() -\r\nreq->rq_arrival_time.tv_sec, 1);\r\nif (!(flags & PTLRPC_REPLY_EARLY) &&\r\n(req->rq_type != PTL_RPC_MSG_ERR) &&\r\n(req->rq_reqmsg != NULL) &&\r\n!(lustre_msg_get_flags(req->rq_reqmsg) &\r\n(MSG_RESENT | MSG_REPLAY |\r\nMSG_REQ_REPLAY_DONE | MSG_LOCK_REPLAY_DONE))) {\r\nint oldse = at_measured(&svcpt->scp_at_estimate, service_time);\r\nif (oldse != 0) {\r\nDEBUG_REQ(D_ADAPTTO, req,\r\n"svc %s changed estimate from %d to %d",\r\nsvc->srv_name, oldse,\r\nat_get(&svcpt->scp_at_estimate));\r\n}\r\n}\r\nlustre_msg_set_service_time(req->rq_repmsg, service_time);\r\nif (req->rq_type == PTL_RPC_MSG_ERR &&\r\n(req->rq_export == NULL || req->rq_export->exp_obd->obd_recovering))\r\nlustre_msg_set_timeout(req->rq_repmsg, 0);\r\nelse\r\nlustre_msg_set_timeout(req->rq_repmsg,\r\nat_get(&svcpt->scp_at_estimate));\r\nif (req->rq_reqmsg &&\r\n!(lustre_msghdr_get_flags(req->rq_reqmsg) & MSGHDR_AT_SUPPORT)) {\r\nCDEBUG(D_ADAPTTO, "No early reply support: flags=%#x req_flags=%#x magic=%d:%x/%x len=%d\n",\r\nflags, lustre_msg_get_flags(req->rq_reqmsg),\r\nlustre_msg_is_v1(req->rq_reqmsg),\r\nlustre_msg_get_magic(req->rq_reqmsg),\r\nlustre_msg_get_magic(req->rq_repmsg), req->rq_replen);\r\n}\r\n}\r\nint ptlrpc_send_reply(struct ptlrpc_request *req, int flags)\r\n{\r\nstruct ptlrpc_reply_state *rs = req->rq_reply_state;\r\nstruct ptlrpc_connection *conn;\r\nint rc;\r\nLASSERT(req->rq_no_reply == 0);\r\nLASSERT(req->rq_reqbuf != NULL);\r\nLASSERT(rs != NULL);\r\nLASSERT((flags & PTLRPC_REPLY_MAYBE_DIFFICULT) || !rs->rs_difficult);\r\nLASSERT(req->rq_repmsg != NULL);\r\nLASSERT(req->rq_repmsg == rs->rs_msg);\r\nLASSERT(rs->rs_cb_id.cbid_fn == reply_out_callback);\r\nLASSERT(rs->rs_cb_id.cbid_arg == rs);\r\nif (unlikely(req->rq_export && req->rq_export->exp_obd &&\r\nreq->rq_export->exp_obd->obd_fail)) {\r\nreq->rq_type = PTL_RPC_MSG_ERR;\r\nreq->rq_status = -ENODEV;\r\nCDEBUG(D_HA, "sending ENODEV from failed obd %d\n",\r\nreq->rq_export->exp_obd->obd_minor);\r\n}\r\nreq->rq_replen = lustre_shrink_msg(req->rq_repmsg, 0,\r\nsizeof(struct ptlrpc_body_v2), 1);\r\nif (req->rq_type != PTL_RPC_MSG_ERR)\r\nreq->rq_type = PTL_RPC_MSG_REPLY;\r\nlustre_msg_set_type(req->rq_repmsg, req->rq_type);\r\nlustre_msg_set_status(req->rq_repmsg,\r\nptlrpc_status_hton(req->rq_status));\r\nlustre_msg_set_opc(req->rq_repmsg,\r\nreq->rq_reqmsg ? lustre_msg_get_opc(req->rq_reqmsg) : 0);\r\ntarget_pack_pool_reply(req);\r\nptlrpc_at_set_reply(req, flags);\r\nif (req->rq_export == NULL || req->rq_export->exp_connection == NULL)\r\nconn = ptlrpc_connection_get(req->rq_peer, req->rq_self, NULL);\r\nelse\r\nconn = ptlrpc_connection_addref(req->rq_export->exp_connection);\r\nif (unlikely(conn == NULL)) {\r\nCERROR("not replying on NULL connection\n");\r\nreturn -ENOTCONN;\r\n}\r\nptlrpc_rs_addref(rs);\r\nrc = sptlrpc_svc_wrap_reply(req);\r\nif (unlikely(rc))\r\ngoto out;\r\nreq->rq_sent = get_seconds();\r\nrc = ptl_send_buf(&rs->rs_md_h, rs->rs_repbuf, rs->rs_repdata_len,\r\n(rs->rs_difficult && !rs->rs_no_ack) ?\r\nLNET_ACK_REQ : LNET_NOACK_REQ,\r\n&rs->rs_cb_id, conn,\r\nptlrpc_req2svc(req)->srv_rep_portal,\r\nreq->rq_xid, req->rq_reply_off);\r\nout:\r\nif (unlikely(rc != 0))\r\nptlrpc_req_drop_rs(req);\r\nptlrpc_connection_put(conn);\r\nreturn rc;\r\n}\r\nint ptlrpc_reply(struct ptlrpc_request *req)\r\n{\r\nif (req->rq_no_reply)\r\nreturn 0;\r\nreturn ptlrpc_send_reply(req, 0);\r\n}\r\nint ptlrpc_send_error(struct ptlrpc_request *req, int may_be_difficult)\r\n{\r\nint rc;\r\nif (req->rq_no_reply)\r\nreturn 0;\r\nif (!req->rq_repmsg) {\r\nrc = lustre_pack_reply(req, 1, NULL, NULL);\r\nif (rc)\r\nreturn rc;\r\n}\r\nif (req->rq_status != -ENOSPC && req->rq_status != -EACCES &&\r\nreq->rq_status != -EPERM && req->rq_status != -ENOENT &&\r\nreq->rq_status != -EINPROGRESS && req->rq_status != -EDQUOT)\r\nreq->rq_type = PTL_RPC_MSG_ERR;\r\nrc = ptlrpc_send_reply(req, may_be_difficult);\r\nreturn rc;\r\n}\r\nint ptlrpc_error(struct ptlrpc_request *req)\r\n{\r\nreturn ptlrpc_send_error(req, 0);\r\n}\r\nint ptl_send_rpc(struct ptlrpc_request *request, int noreply)\r\n{\r\nint rc;\r\nint rc2;\r\nint mpflag = 0;\r\nstruct ptlrpc_connection *connection;\r\nlnet_handle_me_t reply_me_h;\r\nlnet_md_t reply_md;\r\nstruct obd_device *obd = request->rq_import->imp_obd;\r\nif (OBD_FAIL_CHECK(OBD_FAIL_PTLRPC_DROP_RPC))\r\nreturn 0;\r\nLASSERT(request->rq_type == PTL_RPC_MSG_REQUEST);\r\nLASSERT(request->rq_wait_ctx == 0);\r\nLASSERT(!request->rq_receiving_reply);\r\nLASSERT(!((lustre_msg_get_flags(request->rq_reqmsg) & MSG_REPLAY) &&\r\n(request->rq_import->imp_state == LUSTRE_IMP_FULL)));\r\nif (unlikely(obd != NULL && obd->obd_fail)) {\r\nCDEBUG(D_HA, "muting rpc for failed imp obd %s\n",\r\nobd->obd_name);\r\nspin_lock(&request->rq_lock);\r\nrequest->rq_err = 1;\r\nspin_unlock(&request->rq_lock);\r\nrequest->rq_status = -ENODEV;\r\nreturn -ENODEV;\r\n}\r\nconnection = request->rq_import->imp_connection;\r\nlustre_msg_set_handle(request->rq_reqmsg,\r\n&request->rq_import->imp_remote_handle);\r\nlustre_msg_set_type(request->rq_reqmsg, PTL_RPC_MSG_REQUEST);\r\nlustre_msg_set_conn_cnt(request->rq_reqmsg,\r\nrequest->rq_import->imp_conn_cnt);\r\nlustre_msghdr_set_flags(request->rq_reqmsg,\r\nrequest->rq_import->imp_msghdr_flags);\r\nif (request->rq_resend)\r\nlustre_msg_add_flags(request->rq_reqmsg, MSG_RESENT);\r\nif (request->rq_memalloc)\r\nmpflag = cfs_memory_pressure_get_and_set();\r\nrc = sptlrpc_cli_wrap_request(request);\r\nif (rc)\r\ngoto out;\r\nif (request->rq_bulk != NULL) {\r\nrc = ptlrpc_register_bulk(request);\r\nif (rc != 0)\r\ngoto out;\r\n}\r\nif (!noreply) {\r\nLASSERT(request->rq_replen != 0);\r\nif (request->rq_repbuf == NULL) {\r\nLASSERT(request->rq_repdata == NULL);\r\nLASSERT(request->rq_repmsg == NULL);\r\nrc = sptlrpc_cli_alloc_repbuf(request,\r\nrequest->rq_replen);\r\nif (rc) {\r\nspin_lock(&request->rq_lock);\r\nrequest->rq_err = 1;\r\nspin_unlock(&request->rq_lock);\r\nrequest->rq_status = rc;\r\ngoto cleanup_bulk;\r\n}\r\n} else {\r\nrequest->rq_repdata = NULL;\r\nrequest->rq_repmsg = NULL;\r\n}\r\nrc = LNetMEAttach(request->rq_reply_portal,\r\nconnection->c_peer, request->rq_xid, 0,\r\nLNET_UNLINK, LNET_INS_AFTER, &reply_me_h);\r\nif (rc != 0) {\r\nCERROR("LNetMEAttach failed: %d\n", rc);\r\nLASSERT(rc == -ENOMEM);\r\nrc = -ENOMEM;\r\ngoto cleanup_bulk;\r\n}\r\n}\r\nspin_lock(&request->rq_lock);\r\nrequest->rq_receiving_reply = !noreply;\r\nrequest->rq_req_unlink = 1;\r\nrequest->rq_reply_unlink = !noreply;\r\nrequest->rq_replied = 0;\r\nrequest->rq_err = 0;\r\nrequest->rq_timedout = 0;\r\nrequest->rq_net_err = 0;\r\nrequest->rq_resend = 0;\r\nrequest->rq_restart = 0;\r\nrequest->rq_reply_truncate = 0;\r\nspin_unlock(&request->rq_lock);\r\nif (!noreply) {\r\nreply_md.start = request->rq_repbuf;\r\nreply_md.length = request->rq_repbuf_len;\r\nreply_md.threshold = LNET_MD_THRESH_INF;\r\nreply_md.options = PTLRPC_MD_OPTIONS | LNET_MD_OP_PUT |\r\nLNET_MD_MANAGE_REMOTE |\r\nLNET_MD_TRUNCATE; ;\r\nreply_md.user_ptr = &request->rq_reply_cbid;\r\nreply_md.eq_handle = ptlrpc_eq_h;\r\nrc = LNetMDAttach(reply_me_h, reply_md, LNET_RETAIN,\r\n&request->rq_reply_md_h);\r\nif (rc != 0) {\r\nCERROR("LNetMDAttach failed: %d\n", rc);\r\nLASSERT(rc == -ENOMEM);\r\nspin_lock(&request->rq_lock);\r\nrequest->rq_receiving_reply = 0;\r\nspin_unlock(&request->rq_lock);\r\nrc = -ENOMEM;\r\ngoto cleanup_me;\r\n}\r\nCDEBUG(D_NET, "Setup reply buffer: %u bytes, xid %llu, portal %u\n",\r\nrequest->rq_repbuf_len, request->rq_xid,\r\nrequest->rq_reply_portal);\r\n}\r\nptlrpc_request_addref(request);\r\nif (obd != NULL && obd->obd_svc_stats != NULL)\r\nlprocfs_counter_add(obd->obd_svc_stats, PTLRPC_REQACTIVE_CNTR,\r\natomic_read(&request->rq_import->imp_inflight));\r\nOBD_FAIL_TIMEOUT(OBD_FAIL_PTLRPC_DELAY_SEND, request->rq_timeout + 5);\r\ndo_gettimeofday(&request->rq_arrival_time);\r\nrequest->rq_sent = get_seconds();\r\nrequest->rq_deadline = request->rq_sent + request->rq_timeout +\r\nptlrpc_at_get_net_latency(request);\r\nptlrpc_pinger_sending_on_import(request->rq_import);\r\nDEBUG_REQ(D_INFO, request, "send flg=%x",\r\nlustre_msg_get_flags(request->rq_reqmsg));\r\nrc = ptl_send_buf(&request->rq_req_md_h,\r\nrequest->rq_reqbuf, request->rq_reqdata_len,\r\nLNET_NOACK_REQ, &request->rq_req_cbid,\r\nconnection,\r\nrequest->rq_request_portal,\r\nrequest->rq_xid, 0);\r\nif (rc == 0)\r\ngoto out;\r\nptlrpc_req_finished(request);\r\nif (noreply)\r\ngoto out;\r\ncleanup_me:\r\nrc2 = LNetMEUnlink(reply_me_h);\r\nLASSERT(rc2 == 0);\r\nLASSERT(!request->rq_receiving_reply);\r\ncleanup_bulk:\r\nptlrpc_unregister_bulk(request, 0);\r\nout:\r\nif (request->rq_memalloc)\r\ncfs_memory_pressure_restore(mpflag);\r\nreturn rc;\r\n}\r\nint ptlrpc_register_rqbd(struct ptlrpc_request_buffer_desc *rqbd)\r\n{\r\nstruct ptlrpc_service *service = rqbd->rqbd_svcpt->scp_service;\r\nstatic lnet_process_id_t match_id = {LNET_NID_ANY, LNET_PID_ANY};\r\nint rc;\r\nlnet_md_t md;\r\nlnet_handle_me_t me_h;\r\nCDEBUG(D_NET, "LNetMEAttach: portal %d\n",\r\nservice->srv_req_portal);\r\nif (OBD_FAIL_CHECK(OBD_FAIL_PTLRPC_RQBD))\r\nreturn -ENOMEM;\r\nrc = LNetMEAttach(service->srv_req_portal,\r\nmatch_id, 0, ~0, LNET_UNLINK,\r\nrqbd->rqbd_svcpt->scp_cpt >= 0 ?\r\nLNET_INS_LOCAL : LNET_INS_AFTER, &me_h);\r\nif (rc != 0) {\r\nCERROR("LNetMEAttach failed: %d\n", rc);\r\nreturn -ENOMEM;\r\n}\r\nLASSERT(rqbd->rqbd_refcount == 0);\r\nrqbd->rqbd_refcount = 1;\r\nmd.start = rqbd->rqbd_buffer;\r\nmd.length = service->srv_buf_size;\r\nmd.max_size = service->srv_max_req_size;\r\nmd.threshold = LNET_MD_THRESH_INF;\r\nmd.options = PTLRPC_MD_OPTIONS | LNET_MD_OP_PUT | LNET_MD_MAX_SIZE;\r\nmd.user_ptr = &rqbd->rqbd_cbid;\r\nmd.eq_handle = ptlrpc_eq_h;\r\nrc = LNetMDAttach(me_h, md, LNET_UNLINK, &rqbd->rqbd_md_h);\r\nif (rc == 0)\r\nreturn 0;\r\nCERROR("LNetMDAttach failed: %d;\n", rc);\r\nLASSERT(rc == -ENOMEM);\r\nrc = LNetMEUnlink(me_h);\r\nLASSERT(rc == 0);\r\nrqbd->rqbd_refcount = 0;\r\nreturn -ENOMEM;\r\n}

static int __init init_vdso(void)\r\n{\r\nstruct page *um_vdso;\r\nBUG_ON(vdso_end - vdso_start > PAGE_SIZE);\r\num_vdso_addr = task_size - PAGE_SIZE;\r\nvdsop = kmalloc(sizeof(struct page *), GFP_KERNEL);\r\nif (!vdsop)\r\ngoto oom;\r\num_vdso = alloc_page(GFP_KERNEL);\r\nif (!um_vdso) {\r\nkfree(vdsop);\r\ngoto oom;\r\n}\r\ncopy_page(page_address(um_vdso), vdso_start);\r\n*vdsop = um_vdso;\r\nreturn 0;\r\noom:\r\nprintk(KERN_ERR "Cannot allocate vdso\n");\r\nvdso_enabled = 0;\r\nreturn -ENOMEM;\r\n}\r\nint arch_setup_additional_pages(struct linux_binprm *bprm, int uses_interp)\r\n{\r\nint err;\r\nstruct mm_struct *mm = current->mm;\r\nif (!vdso_enabled)\r\nreturn 0;\r\ndown_write(&mm->mmap_sem);\r\nerr = install_special_mapping(mm, um_vdso_addr, PAGE_SIZE,\r\nVM_READ|VM_EXEC|\r\nVM_MAYREAD|VM_MAYWRITE|VM_MAYEXEC,\r\nvdsop);\r\nup_write(&mm->mmap_sem);\r\nreturn err;\r\n}

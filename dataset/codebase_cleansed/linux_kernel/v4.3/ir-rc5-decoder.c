static int ir_rc5_decode(struct rc_dev *dev, struct ir_raw_event ev)\r\n{\r\nstruct rc5_dec *data = &dev->raw->rc5;\r\nu8 toggle;\r\nu32 scancode;\r\nenum rc_type protocol;\r\nif (!(dev->enabled_protocols & (RC_BIT_RC5 | RC_BIT_RC5X | RC_BIT_RC5_SZ)))\r\nreturn 0;\r\nif (!is_timing_event(ev)) {\r\nif (ev.reset)\r\ndata->state = STATE_INACTIVE;\r\nreturn 0;\r\n}\r\nif (!geq_margin(ev.duration, RC5_UNIT, RC5_UNIT / 2))\r\ngoto out;\r\nagain:\r\nIR_dprintk(2, "RC5(x/sz) decode started at state %i (%uus %s)\n",\r\ndata->state, TO_US(ev.duration), TO_STR(ev.pulse));\r\nif (!geq_margin(ev.duration, RC5_UNIT, RC5_UNIT / 2))\r\nreturn 0;\r\nswitch (data->state) {\r\ncase STATE_INACTIVE:\r\nif (!ev.pulse)\r\nbreak;\r\ndata->state = STATE_BIT_START;\r\ndata->count = 1;\r\ndecrease_duration(&ev, RC5_BIT_START);\r\ngoto again;\r\ncase STATE_BIT_START:\r\nif (!ev.pulse && geq_margin(ev.duration, RC5_TRAILER, RC5_UNIT / 2)) {\r\ndata->state = STATE_FINISHED;\r\ngoto again;\r\n}\r\nif (!eq_margin(ev.duration, RC5_BIT_START, RC5_UNIT / 2))\r\nbreak;\r\ndata->bits <<= 1;\r\nif (!ev.pulse)\r\ndata->bits |= 1;\r\ndata->count++;\r\ndata->state = STATE_BIT_END;\r\nreturn 0;\r\ncase STATE_BIT_END:\r\nif (!is_transition(&ev, &dev->raw->prev_ev))\r\nbreak;\r\nif (data->count == CHECK_RC5X_NBITS)\r\ndata->state = STATE_CHECK_RC5X;\r\nelse\r\ndata->state = STATE_BIT_START;\r\ndecrease_duration(&ev, RC5_BIT_END);\r\ngoto again;\r\ncase STATE_CHECK_RC5X:\r\nif (!ev.pulse && geq_margin(ev.duration, RC5X_SPACE, RC5_UNIT / 2)) {\r\ndata->is_rc5x = true;\r\ndecrease_duration(&ev, RC5X_SPACE);\r\n} else\r\ndata->is_rc5x = false;\r\ndata->state = STATE_BIT_START;\r\ngoto again;\r\ncase STATE_FINISHED:\r\nif (ev.pulse)\r\nbreak;\r\nif (data->is_rc5x && data->count == RC5X_NBITS) {\r\nu8 xdata, command, system;\r\nif (!(dev->enabled_protocols & RC_BIT_RC5X)) {\r\ndata->state = STATE_INACTIVE;\r\nreturn 0;\r\n}\r\nxdata = (data->bits & 0x0003F) >> 0;\r\ncommand = (data->bits & 0x00FC0) >> 6;\r\nsystem = (data->bits & 0x1F000) >> 12;\r\ntoggle = (data->bits & 0x20000) ? 1 : 0;\r\ncommand += (data->bits & 0x01000) ? 0 : 0x40;\r\nscancode = system << 16 | command << 8 | xdata;\r\nprotocol = RC_TYPE_RC5X;\r\n} else if (!data->is_rc5x && data->count == RC5_NBITS) {\r\nu8 command, system;\r\nif (!(dev->enabled_protocols & RC_BIT_RC5)) {\r\ndata->state = STATE_INACTIVE;\r\nreturn 0;\r\n}\r\ncommand = (data->bits & 0x0003F) >> 0;\r\nsystem = (data->bits & 0x007C0) >> 6;\r\ntoggle = (data->bits & 0x00800) ? 1 : 0;\r\ncommand += (data->bits & 0x01000) ? 0 : 0x40;\r\nscancode = system << 8 | command;\r\nprotocol = RC_TYPE_RC5;\r\n} else if (!data->is_rc5x && data->count == RC5_SZ_NBITS) {\r\nu8 command, system;\r\nif (!(dev->enabled_protocols & RC_BIT_RC5_SZ)) {\r\ndata->state = STATE_INACTIVE;\r\nreturn 0;\r\n}\r\ncommand = (data->bits & 0x0003F) >> 0;\r\nsystem = (data->bits & 0x02FC0) >> 6;\r\ntoggle = (data->bits & 0x01000) ? 1 : 0;\r\nscancode = system << 6 | command;\r\nprotocol = RC_TYPE_RC5_SZ;\r\n} else\r\nbreak;\r\nIR_dprintk(1, "RC5(x/sz) scancode 0x%06x (p: %u, t: %u)\n",\r\nscancode, protocol, toggle);\r\nrc_keydown(dev, protocol, scancode, toggle);\r\ndata->state = STATE_INACTIVE;\r\nreturn 0;\r\n}\r\nout:\r\nIR_dprintk(1, "RC5(x/sz) decode failed at state %i count %d (%uus %s)\n",\r\ndata->state, data->count, TO_US(ev.duration), TO_STR(ev.pulse));\r\ndata->state = STATE_INACTIVE;\r\nreturn -EINVAL;\r\n}\r\nstatic int __init ir_rc5_decode_init(void)\r\n{\r\nir_raw_handler_register(&rc5_handler);\r\nprintk(KERN_INFO "IR RC5(x/sz) protocol handler initialized\n");\r\nreturn 0;\r\n}\r\nstatic void __exit ir_rc5_decode_exit(void)\r\n{\r\nir_raw_handler_unregister(&rc5_handler);\r\n}

int drm_virtio_set_busid(struct drm_device *dev, struct drm_master *master)\r\n{\r\nstruct pci_dev *pdev = dev->pdev;\r\nif (pdev) {\r\nreturn drm_pci_set_busid(dev, master);\r\n}\r\nreturn 0;\r\n}\r\nstatic void virtio_pci_kick_out_firmware_fb(struct pci_dev *pci_dev)\r\n{\r\nstruct apertures_struct *ap;\r\nbool primary;\r\nap = alloc_apertures(1);\r\nif (!ap)\r\nreturn;\r\nap->ranges[0].base = pci_resource_start(pci_dev, 0);\r\nap->ranges[0].size = pci_resource_len(pci_dev, 0);\r\nprimary = pci_dev->resource[PCI_ROM_RESOURCE].flags\r\n& IORESOURCE_ROM_SHADOW;\r\nremove_conflicting_framebuffers(ap, "virtiodrmfb", primary);\r\nkfree(ap);\r\n}\r\nint drm_virtio_init(struct drm_driver *driver, struct virtio_device *vdev)\r\n{\r\nstruct drm_device *dev;\r\nint ret;\r\ndev = drm_dev_alloc(driver, &vdev->dev);\r\nif (!dev)\r\nreturn -ENOMEM;\r\ndev->virtdev = vdev;\r\nvdev->priv = dev;\r\nif (strcmp(vdev->dev.parent->bus->name, "pci") == 0) {\r\nstruct pci_dev *pdev = to_pci_dev(vdev->dev.parent);\r\nbool vga = (pdev->class >> 8) == PCI_CLASS_DISPLAY_VGA;\r\nDRM_INFO("pci: %s detected\n",\r\nvga ? "virtio-vga" : "virtio-gpu-pci");\r\ndev->pdev = pdev;\r\nif (vga)\r\nvirtio_pci_kick_out_firmware_fb(pdev);\r\n}\r\nret = drm_dev_register(dev, 0);\r\nif (ret)\r\ngoto err_free;\r\nDRM_INFO("Initialized %s %d.%d.%d %s on minor %d\n", driver->name,\r\ndriver->major, driver->minor, driver->patchlevel,\r\ndriver->date, dev->primary->index);\r\nreturn 0;\r\nerr_free:\r\ndrm_dev_unref(dev);\r\nreturn ret;\r\n}

bool si_dma_is_lockup(struct radeon_device *rdev, struct radeon_ring *ring)\r\n{\r\nu32 reset_mask = si_gpu_check_soft_reset(rdev);\r\nu32 mask;\r\nif (ring->idx == R600_RING_TYPE_DMA_INDEX)\r\nmask = RADEON_RESET_DMA;\r\nelse\r\nmask = RADEON_RESET_DMA1;\r\nif (!(reset_mask & mask)) {\r\nradeon_ring_lockup_update(rdev, ring);\r\nreturn false;\r\n}\r\nreturn radeon_ring_test_lockup(rdev, ring);\r\n}\r\nvoid si_dma_vm_copy_pages(struct radeon_device *rdev,\r\nstruct radeon_ib *ib,\r\nuint64_t pe, uint64_t src,\r\nunsigned count)\r\n{\r\nwhile (count) {\r\nunsigned bytes = count * 8;\r\nif (bytes > 0xFFFF8)\r\nbytes = 0xFFFF8;\r\nib->ptr[ib->length_dw++] = DMA_PACKET(DMA_PACKET_COPY,\r\n1, 0, 0, bytes);\r\nib->ptr[ib->length_dw++] = lower_32_bits(pe);\r\nib->ptr[ib->length_dw++] = lower_32_bits(src);\r\nib->ptr[ib->length_dw++] = upper_32_bits(pe) & 0xff;\r\nib->ptr[ib->length_dw++] = upper_32_bits(src) & 0xff;\r\npe += bytes;\r\nsrc += bytes;\r\ncount -= bytes / 8;\r\n}\r\n}\r\nvoid si_dma_vm_write_pages(struct radeon_device *rdev,\r\nstruct radeon_ib *ib,\r\nuint64_t pe,\r\nuint64_t addr, unsigned count,\r\nuint32_t incr, uint32_t flags)\r\n{\r\nuint64_t value;\r\nunsigned ndw;\r\nwhile (count) {\r\nndw = count * 2;\r\nif (ndw > 0xFFFFE)\r\nndw = 0xFFFFE;\r\nib->ptr[ib->length_dw++] = DMA_PACKET(DMA_PACKET_WRITE, 0, 0, 0, ndw);\r\nib->ptr[ib->length_dw++] = pe;\r\nib->ptr[ib->length_dw++] = upper_32_bits(pe) & 0xff;\r\nfor (; ndw > 0; ndw -= 2, --count, pe += 8) {\r\nif (flags & R600_PTE_SYSTEM) {\r\nvalue = radeon_vm_map_gart(rdev, addr);\r\n} else if (flags & R600_PTE_VALID) {\r\nvalue = addr;\r\n} else {\r\nvalue = 0;\r\n}\r\naddr += incr;\r\nvalue |= flags;\r\nib->ptr[ib->length_dw++] = value;\r\nib->ptr[ib->length_dw++] = upper_32_bits(value);\r\n}\r\n}\r\n}\r\nvoid si_dma_vm_set_pages(struct radeon_device *rdev,\r\nstruct radeon_ib *ib,\r\nuint64_t pe,\r\nuint64_t addr, unsigned count,\r\nuint32_t incr, uint32_t flags)\r\n{\r\nuint64_t value;\r\nunsigned ndw;\r\nwhile (count) {\r\nndw = count * 2;\r\nif (ndw > 0xFFFFE)\r\nndw = 0xFFFFE;\r\nif (flags & R600_PTE_VALID)\r\nvalue = addr;\r\nelse\r\nvalue = 0;\r\nib->ptr[ib->length_dw++] = DMA_PTE_PDE_PACKET(ndw);\r\nib->ptr[ib->length_dw++] = pe;\r\nib->ptr[ib->length_dw++] = upper_32_bits(pe) & 0xff;\r\nib->ptr[ib->length_dw++] = flags;\r\nib->ptr[ib->length_dw++] = 0;\r\nib->ptr[ib->length_dw++] = value;\r\nib->ptr[ib->length_dw++] = upper_32_bits(value);\r\nib->ptr[ib->length_dw++] = incr;\r\nib->ptr[ib->length_dw++] = 0;\r\npe += ndw * 4;\r\naddr += (ndw / 2) * incr;\r\ncount -= ndw / 2;\r\n}\r\n}\r\nvoid si_dma_vm_flush(struct radeon_device *rdev, struct radeon_ring *ring,\r\nunsigned vm_id, uint64_t pd_addr)\r\n{\r\nradeon_ring_write(ring, DMA_PACKET(DMA_PACKET_SRBM_WRITE, 0, 0, 0, 0));\r\nif (vm_id < 8) {\r\nradeon_ring_write(ring, (0xf << 16) | ((VM_CONTEXT0_PAGE_TABLE_BASE_ADDR + (vm_id << 2)) >> 2));\r\n} else {\r\nradeon_ring_write(ring, (0xf << 16) | ((VM_CONTEXT8_PAGE_TABLE_BASE_ADDR + ((vm_id - 8) << 2)) >> 2));\r\n}\r\nradeon_ring_write(ring, pd_addr >> 12);\r\nradeon_ring_write(ring, DMA_PACKET(DMA_PACKET_SRBM_WRITE, 0, 0, 0, 0));\r\nradeon_ring_write(ring, (0xf << 16) | (HDP_MEM_COHERENCY_FLUSH_CNTL >> 2));\r\nradeon_ring_write(ring, 1);\r\nradeon_ring_write(ring, DMA_PACKET(DMA_PACKET_SRBM_WRITE, 0, 0, 0, 0));\r\nradeon_ring_write(ring, (0xf << 16) | (VM_INVALIDATE_REQUEST >> 2));\r\nradeon_ring_write(ring, 1 << vm_id);\r\nradeon_ring_write(ring, DMA_PACKET(DMA_PACKET_POLL_REG_MEM, 0, 0, 0, 0));\r\nradeon_ring_write(ring, VM_INVALIDATE_REQUEST);\r\nradeon_ring_write(ring, 0xff << 16);\r\nradeon_ring_write(ring, 1 << vm_id);\r\nradeon_ring_write(ring, 0);\r\nradeon_ring_write(ring, (0 << 28) | 0x20);\r\n}\r\nstruct radeon_fence *si_copy_dma(struct radeon_device *rdev,\r\nuint64_t src_offset, uint64_t dst_offset,\r\nunsigned num_gpu_pages,\r\nstruct reservation_object *resv)\r\n{\r\nstruct radeon_fence *fence;\r\nstruct radeon_sync sync;\r\nint ring_index = rdev->asic->copy.dma_ring_index;\r\nstruct radeon_ring *ring = &rdev->ring[ring_index];\r\nu32 size_in_bytes, cur_size_in_bytes;\r\nint i, num_loops;\r\nint r = 0;\r\nradeon_sync_create(&sync);\r\nsize_in_bytes = (num_gpu_pages << RADEON_GPU_PAGE_SHIFT);\r\nnum_loops = DIV_ROUND_UP(size_in_bytes, 0xfffff);\r\nr = radeon_ring_lock(rdev, ring, num_loops * 5 + 11);\r\nif (r) {\r\nDRM_ERROR("radeon: moving bo (%d).\n", r);\r\nradeon_sync_free(rdev, &sync, NULL);\r\nreturn ERR_PTR(r);\r\n}\r\nradeon_sync_resv(rdev, &sync, resv, false);\r\nradeon_sync_rings(rdev, &sync, ring->idx);\r\nfor (i = 0; i < num_loops; i++) {\r\ncur_size_in_bytes = size_in_bytes;\r\nif (cur_size_in_bytes > 0xFFFFF)\r\ncur_size_in_bytes = 0xFFFFF;\r\nsize_in_bytes -= cur_size_in_bytes;\r\nradeon_ring_write(ring, DMA_PACKET(DMA_PACKET_COPY, 1, 0, 0, cur_size_in_bytes));\r\nradeon_ring_write(ring, lower_32_bits(dst_offset));\r\nradeon_ring_write(ring, lower_32_bits(src_offset));\r\nradeon_ring_write(ring, upper_32_bits(dst_offset) & 0xff);\r\nradeon_ring_write(ring, upper_32_bits(src_offset) & 0xff);\r\nsrc_offset += cur_size_in_bytes;\r\ndst_offset += cur_size_in_bytes;\r\n}\r\nr = radeon_fence_emit(rdev, &fence, ring->idx);\r\nif (r) {\r\nradeon_ring_unlock_undo(rdev, ring);\r\nradeon_sync_free(rdev, &sync, NULL);\r\nreturn ERR_PTR(r);\r\n}\r\nradeon_ring_unlock_commit(rdev, ring, false);\r\nradeon_sync_free(rdev, &sync, fence);\r\nreturn fence;\r\n}

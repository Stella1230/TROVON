static void ip_vs_read_cpu_stats(struct ip_vs_kstats *sum,\r\nstruct ip_vs_cpu_stats __percpu *stats)\r\n{\r\nint i;\r\nbool add = false;\r\nfor_each_possible_cpu(i) {\r\nstruct ip_vs_cpu_stats *s = per_cpu_ptr(stats, i);\r\nunsigned int start;\r\nu64 conns, inpkts, outpkts, inbytes, outbytes;\r\nif (add) {\r\ndo {\r\nstart = u64_stats_fetch_begin(&s->syncp);\r\nconns = s->cnt.conns;\r\ninpkts = s->cnt.inpkts;\r\noutpkts = s->cnt.outpkts;\r\ninbytes = s->cnt.inbytes;\r\noutbytes = s->cnt.outbytes;\r\n} while (u64_stats_fetch_retry(&s->syncp, start));\r\nsum->conns += conns;\r\nsum->inpkts += inpkts;\r\nsum->outpkts += outpkts;\r\nsum->inbytes += inbytes;\r\nsum->outbytes += outbytes;\r\n} else {\r\nadd = true;\r\ndo {\r\nstart = u64_stats_fetch_begin(&s->syncp);\r\nsum->conns = s->cnt.conns;\r\nsum->inpkts = s->cnt.inpkts;\r\nsum->outpkts = s->cnt.outpkts;\r\nsum->inbytes = s->cnt.inbytes;\r\nsum->outbytes = s->cnt.outbytes;\r\n} while (u64_stats_fetch_retry(&s->syncp, start));\r\n}\r\n}\r\n}\r\nstatic void estimation_timer(unsigned long arg)\r\n{\r\nstruct ip_vs_estimator *e;\r\nstruct ip_vs_stats *s;\r\nu64 rate;\r\nstruct net *net = (struct net *)arg;\r\nstruct netns_ipvs *ipvs;\r\nipvs = net_ipvs(net);\r\nspin_lock(&ipvs->est_lock);\r\nlist_for_each_entry(e, &ipvs->est_list, list) {\r\ns = container_of(e, struct ip_vs_stats, est);\r\nspin_lock(&s->lock);\r\nip_vs_read_cpu_stats(&s->kstats, s->cpustats);\r\nrate = (s->kstats.conns - e->last_conns) << 9;\r\ne->last_conns = s->kstats.conns;\r\ne->cps += ((s64)rate - (s64)e->cps) >> 2;\r\nrate = (s->kstats.inpkts - e->last_inpkts) << 9;\r\ne->last_inpkts = s->kstats.inpkts;\r\ne->inpps += ((s64)rate - (s64)e->inpps) >> 2;\r\nrate = (s->kstats.outpkts - e->last_outpkts) << 9;\r\ne->last_outpkts = s->kstats.outpkts;\r\ne->outpps += ((s64)rate - (s64)e->outpps) >> 2;\r\nrate = (s->kstats.inbytes - e->last_inbytes) << 4;\r\ne->last_inbytes = s->kstats.inbytes;\r\ne->inbps += ((s64)rate - (s64)e->inbps) >> 2;\r\nrate = (s->kstats.outbytes - e->last_outbytes) << 4;\r\ne->last_outbytes = s->kstats.outbytes;\r\ne->outbps += ((s64)rate - (s64)e->outbps) >> 2;\r\nspin_unlock(&s->lock);\r\n}\r\nspin_unlock(&ipvs->est_lock);\r\nmod_timer(&ipvs->est_timer, jiffies + 2*HZ);\r\n}\r\nvoid ip_vs_start_estimator(struct net *net, struct ip_vs_stats *stats)\r\n{\r\nstruct netns_ipvs *ipvs = net_ipvs(net);\r\nstruct ip_vs_estimator *est = &stats->est;\r\nINIT_LIST_HEAD(&est->list);\r\nspin_lock_bh(&ipvs->est_lock);\r\nlist_add(&est->list, &ipvs->est_list);\r\nspin_unlock_bh(&ipvs->est_lock);\r\n}\r\nvoid ip_vs_stop_estimator(struct net *net, struct ip_vs_stats *stats)\r\n{\r\nstruct netns_ipvs *ipvs = net_ipvs(net);\r\nstruct ip_vs_estimator *est = &stats->est;\r\nspin_lock_bh(&ipvs->est_lock);\r\nlist_del(&est->list);\r\nspin_unlock_bh(&ipvs->est_lock);\r\n}\r\nvoid ip_vs_zero_estimator(struct ip_vs_stats *stats)\r\n{\r\nstruct ip_vs_estimator *est = &stats->est;\r\nstruct ip_vs_kstats *k = &stats->kstats;\r\nest->last_inbytes = k->inbytes;\r\nest->last_outbytes = k->outbytes;\r\nest->last_conns = k->conns;\r\nest->last_inpkts = k->inpkts;\r\nest->last_outpkts = k->outpkts;\r\nest->cps = 0;\r\nest->inpps = 0;\r\nest->outpps = 0;\r\nest->inbps = 0;\r\nest->outbps = 0;\r\n}\r\nvoid ip_vs_read_estimator(struct ip_vs_kstats *dst, struct ip_vs_stats *stats)\r\n{\r\nstruct ip_vs_estimator *e = &stats->est;\r\ndst->cps = (e->cps + 0x1FF) >> 10;\r\ndst->inpps = (e->inpps + 0x1FF) >> 10;\r\ndst->outpps = (e->outpps + 0x1FF) >> 10;\r\ndst->inbps = (e->inbps + 0xF) >> 5;\r\ndst->outbps = (e->outbps + 0xF) >> 5;\r\n}\r\nint __net_init ip_vs_estimator_net_init(struct net *net)\r\n{\r\nstruct netns_ipvs *ipvs = net_ipvs(net);\r\nINIT_LIST_HEAD(&ipvs->est_list);\r\nspin_lock_init(&ipvs->est_lock);\r\nsetup_timer(&ipvs->est_timer, estimation_timer, (unsigned long)net);\r\nmod_timer(&ipvs->est_timer, jiffies + 2 * HZ);\r\nreturn 0;\r\n}\r\nvoid __net_exit ip_vs_estimator_net_cleanup(struct net *net)\r\n{\r\ndel_timer_sync(&net_ipvs(net)->est_timer);\r\n}

static void xhci_plat_quirks(struct device *dev, struct xhci_hcd *xhci)\r\n{\r\nxhci->quirks |= XHCI_PLAT;\r\n}\r\nstatic int xhci_plat_setup(struct usb_hcd *hcd)\r\n{\r\nstruct device_node *of_node = hcd->self.controller->of_node;\r\nint ret;\r\nif (of_device_is_compatible(of_node, "renesas,xhci-r8a7790") ||\r\nof_device_is_compatible(of_node, "renesas,xhci-r8a7791")) {\r\nret = xhci_rcar_init_quirk(hcd);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn xhci_gen_setup(hcd, xhci_plat_quirks);\r\n}\r\nstatic int xhci_plat_start(struct usb_hcd *hcd)\r\n{\r\nstruct device_node *of_node = hcd->self.controller->of_node;\r\nif (of_device_is_compatible(of_node, "renesas,xhci-r8a7790") ||\r\nof_device_is_compatible(of_node, "renesas,xhci-r8a7791"))\r\nxhci_rcar_start(hcd);\r\nreturn xhci_run(hcd);\r\n}\r\nstatic int xhci_plat_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct usb_xhci_pdata *pdata = dev_get_platdata(&pdev->dev);\r\nconst struct hc_driver *driver;\r\nstruct xhci_hcd *xhci;\r\nstruct resource *res;\r\nstruct usb_hcd *hcd;\r\nstruct clk *clk;\r\nint ret;\r\nint irq;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\ndriver = &xhci_plat_hc_driver;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0)\r\nreturn -ENODEV;\r\nret = dma_set_coherent_mask(&pdev->dev, DMA_BIT_MASK(32));\r\nif (ret)\r\nreturn ret;\r\nif (!pdev->dev.dma_mask)\r\npdev->dev.dma_mask = &pdev->dev.coherent_dma_mask;\r\nelse\r\ndma_set_mask(&pdev->dev, DMA_BIT_MASK(32));\r\nhcd = usb_create_hcd(driver, &pdev->dev, dev_name(&pdev->dev));\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nhcd->regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(hcd->regs)) {\r\nret = PTR_ERR(hcd->regs);\r\ngoto put_hcd;\r\n}\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nclk = devm_clk_get(&pdev->dev, NULL);\r\nif (!IS_ERR(clk)) {\r\nret = clk_prepare_enable(clk);\r\nif (ret)\r\ngoto put_hcd;\r\n}\r\nif (of_device_is_compatible(pdev->dev.of_node,\r\n"marvell,armada-375-xhci") ||\r\nof_device_is_compatible(pdev->dev.of_node,\r\n"marvell,armada-380-xhci")) {\r\nret = xhci_mvebu_mbus_init_quirk(pdev);\r\nif (ret)\r\ngoto disable_clk;\r\n}\r\ndevice_wakeup_enable(hcd->self.controller);\r\nxhci = hcd_to_xhci(hcd);\r\nxhci->clk = clk;\r\nxhci->main_hcd = hcd;\r\nxhci->shared_hcd = usb_create_shared_hcd(driver, &pdev->dev,\r\ndev_name(&pdev->dev), hcd);\r\nif (!xhci->shared_hcd) {\r\nret = -ENOMEM;\r\ngoto disable_clk;\r\n}\r\nif ((node && of_property_read_bool(node, "usb3-lpm-capable")) ||\r\n(pdata && pdata->usb3_lpm_capable))\r\nxhci->quirks |= XHCI_LPM_SUPPORT;\r\nif (HCC_MAX_PSA(xhci->hcc_params) >= 4)\r\nxhci->shared_hcd->can_do_streams = 1;\r\nhcd->usb_phy = devm_usb_get_phy_by_phandle(&pdev->dev, "usb-phy", 0);\r\nif (IS_ERR(hcd->usb_phy)) {\r\nret = PTR_ERR(hcd->usb_phy);\r\nif (ret == -EPROBE_DEFER)\r\ngoto put_usb3_hcd;\r\nhcd->usb_phy = NULL;\r\n} else {\r\nret = usb_phy_init(hcd->usb_phy);\r\nif (ret)\r\ngoto put_usb3_hcd;\r\n}\r\nret = usb_add_hcd(hcd, irq, IRQF_SHARED);\r\nif (ret)\r\ngoto disable_usb_phy;\r\nret = usb_add_hcd(xhci->shared_hcd, irq, IRQF_SHARED);\r\nif (ret)\r\ngoto dealloc_usb2_hcd;\r\nreturn 0;\r\ndealloc_usb2_hcd:\r\nusb_remove_hcd(hcd);\r\ndisable_usb_phy:\r\nusb_phy_shutdown(hcd->usb_phy);\r\nput_usb3_hcd:\r\nusb_put_hcd(xhci->shared_hcd);\r\ndisable_clk:\r\nif (!IS_ERR(clk))\r\nclk_disable_unprepare(clk);\r\nput_hcd:\r\nusb_put_hcd(hcd);\r\nreturn ret;\r\n}\r\nstatic int xhci_plat_remove(struct platform_device *dev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(dev);\r\nstruct xhci_hcd *xhci = hcd_to_xhci(hcd);\r\nstruct clk *clk = xhci->clk;\r\nusb_remove_hcd(xhci->shared_hcd);\r\nusb_phy_shutdown(hcd->usb_phy);\r\nusb_remove_hcd(hcd);\r\nusb_put_hcd(xhci->shared_hcd);\r\nif (!IS_ERR(clk))\r\nclk_disable_unprepare(clk);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}\r\nstatic int xhci_plat_suspend(struct device *dev)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\nstruct xhci_hcd *xhci = hcd_to_xhci(hcd);\r\nreturn xhci_suspend(xhci, device_may_wakeup(dev));\r\n}\r\nstatic int xhci_plat_resume(struct device *dev)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\nstruct xhci_hcd *xhci = hcd_to_xhci(hcd);\r\nreturn xhci_resume(xhci, 0);\r\n}\r\nstatic int __init xhci_plat_init(void)\r\n{\r\nxhci_init_driver(&xhci_plat_hc_driver, &xhci_plat_overrides);\r\nreturn platform_driver_register(&usb_xhci_driver);\r\n}\r\nstatic void __exit xhci_plat_exit(void)\r\n{\r\nplatform_driver_unregister(&usb_xhci_driver);\r\n}

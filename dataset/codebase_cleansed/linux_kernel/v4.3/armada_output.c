struct drm_encoder *armada_drm_connector_encoder(struct drm_connector *conn)\r\n{\r\nstruct drm_encoder *enc = conn->encoder;\r\nreturn enc ? enc : drm_encoder_find(conn->dev, conn->encoder_ids[0]);\r\n}\r\nstatic enum drm_connector_status armada_drm_connector_detect(\r\nstruct drm_connector *conn, bool force)\r\n{\r\nstruct armada_connector *dconn = drm_to_armada_conn(conn);\r\nenum drm_connector_status status = connector_status_disconnected;\r\nif (dconn->type->detect) {\r\nstatus = dconn->type->detect(conn, force);\r\n} else {\r\nstruct drm_encoder *enc = armada_drm_connector_encoder(conn);\r\nif (enc)\r\nstatus = encoder_helper_funcs(enc)->detect(enc, conn);\r\n}\r\nreturn status;\r\n}\r\nstatic void armada_drm_connector_destroy(struct drm_connector *conn)\r\n{\r\nstruct armada_connector *dconn = drm_to_armada_conn(conn);\r\ndrm_connector_unregister(conn);\r\ndrm_connector_cleanup(conn);\r\nkfree(dconn);\r\n}\r\nstatic int armada_drm_connector_set_property(struct drm_connector *conn,\r\nstruct drm_property *property, uint64_t value)\r\n{\r\nstruct armada_connector *dconn = drm_to_armada_conn(conn);\r\nif (!dconn->type->set_property)\r\nreturn -EINVAL;\r\nreturn dconn->type->set_property(conn, property, value);\r\n}\r\nint armada_drm_slave_encoder_mode_valid(struct drm_connector *conn,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct drm_encoder *encoder = armada_drm_connector_encoder(conn);\r\nint valid = MODE_BAD;\r\nif (encoder) {\r\nstruct drm_encoder_slave *slave = to_encoder_slave(encoder);\r\nvalid = slave->slave_funcs->mode_valid(encoder, mode);\r\n}\r\nreturn valid;\r\n}\r\nint armada_drm_slave_encoder_set_property(struct drm_connector *conn,\r\nstruct drm_property *property, uint64_t value)\r\n{\r\nstruct drm_encoder *encoder = armada_drm_connector_encoder(conn);\r\nint rc = -EINVAL;\r\nif (encoder) {\r\nstruct drm_encoder_slave *slave = to_encoder_slave(encoder);\r\nrc = slave->slave_funcs->set_property(encoder, conn, property,\r\nvalue);\r\n}\r\nreturn rc;\r\n}\r\nint armada_output_create(struct drm_device *dev,\r\nconst struct armada_output_type *type, const void *data)\r\n{\r\nstruct armada_connector *dconn;\r\nint ret;\r\ndconn = kzalloc(sizeof(*dconn), GFP_KERNEL);\r\nif (!dconn)\r\nreturn -ENOMEM;\r\ndconn->type = type;\r\nret = drm_connector_init(dev, &dconn->conn, &armada_drm_conn_funcs,\r\ntype->connector_type);\r\nif (ret) {\r\nDRM_ERROR("unable to init connector\n");\r\ngoto err_destroy_dconn;\r\n}\r\nret = type->create(&dconn->conn, data);\r\nif (ret)\r\ngoto err_conn;\r\nret = drm_connector_register(&dconn->conn);\r\nif (ret)\r\ngoto err_sysfs;\r\nreturn 0;\r\nerr_sysfs:\r\nif (dconn->conn.encoder)\r\ndconn->conn.encoder->funcs->destroy(dconn->conn.encoder);\r\nerr_conn:\r\ndrm_connector_cleanup(&dconn->conn);\r\nerr_destroy_dconn:\r\nkfree(dconn);\r\nreturn ret;\r\n}

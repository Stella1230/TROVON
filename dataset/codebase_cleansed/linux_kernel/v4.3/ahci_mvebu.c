static void ahci_mvebu_mbus_config(struct ahci_host_priv *hpriv,\r\nconst struct mbus_dram_target_info *dram)\r\n{\r\nint i;\r\nfor (i = 0; i < 4; i++) {\r\nwritel(0, hpriv->mmio + AHCI_WINDOW_CTRL(i));\r\nwritel(0, hpriv->mmio + AHCI_WINDOW_BASE(i));\r\nwritel(0, hpriv->mmio + AHCI_WINDOW_SIZE(i));\r\n}\r\nfor (i = 0; i < dram->num_cs; i++) {\r\nconst struct mbus_dram_window *cs = dram->cs + i;\r\nwritel((cs->mbus_attr << 8) |\r\n(dram->mbus_dram_target_id << 4) | 1,\r\nhpriv->mmio + AHCI_WINDOW_CTRL(i));\r\nwritel(cs->base >> 16, hpriv->mmio + AHCI_WINDOW_BASE(i));\r\nwritel(((cs->size - 1) & 0xffff0000),\r\nhpriv->mmio + AHCI_WINDOW_SIZE(i));\r\n}\r\n}\r\nstatic void ahci_mvebu_regret_option(struct ahci_host_priv *hpriv)\r\n{\r\nwritel(0x4, hpriv->mmio + AHCI_VENDOR_SPECIFIC_0_ADDR);\r\nwritel(0x80, hpriv->mmio + AHCI_VENDOR_SPECIFIC_0_DATA);\r\n}\r\nstatic int ahci_mvebu_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nreturn ahci_platform_suspend_host(&pdev->dev);\r\n}\r\nstatic int ahci_mvebu_resume(struct platform_device *pdev)\r\n{\r\nstruct ata_host *host = platform_get_drvdata(pdev);\r\nstruct ahci_host_priv *hpriv = host->private_data;\r\nconst struct mbus_dram_target_info *dram;\r\ndram = mv_mbus_dram_info();\r\nif (dram)\r\nahci_mvebu_mbus_config(hpriv, dram);\r\nahci_mvebu_regret_option(hpriv);\r\nreturn ahci_platform_resume_host(&pdev->dev);\r\n}\r\nstatic int ahci_mvebu_probe(struct platform_device *pdev)\r\n{\r\nstruct ahci_host_priv *hpriv;\r\nconst struct mbus_dram_target_info *dram;\r\nint rc;\r\nhpriv = ahci_platform_get_resources(pdev);\r\nif (IS_ERR(hpriv))\r\nreturn PTR_ERR(hpriv);\r\nrc = ahci_platform_enable_resources(hpriv);\r\nif (rc)\r\nreturn rc;\r\ndram = mv_mbus_dram_info();\r\nif (!dram)\r\nreturn -ENODEV;\r\nahci_mvebu_mbus_config(hpriv, dram);\r\nahci_mvebu_regret_option(hpriv);\r\nrc = ahci_platform_init_host(pdev, hpriv, &ahci_mvebu_port_info,\r\n&ahci_platform_sht);\r\nif (rc)\r\ngoto disable_resources;\r\nreturn 0;\r\ndisable_resources:\r\nahci_platform_disable_resources(hpriv);\r\nreturn rc;\r\n}

static __u8 *kye_consumer_control_fixup(struct hid_device *hdev, __u8 *rdesc,\r\nunsigned int *rsize, int offset, const char *device_name) {\r\nif (*rsize >= offset + 31 &&\r\nrdesc[offset] == 0x05 && rdesc[offset + 1] == 0x0c &&\r\nrdesc[offset + 2] == 0x09 && rdesc[offset + 3] == 0x01 &&\r\nrdesc[offset + 10] == 0x2a && rdesc[offset + 12] > 0x2f) {\r\nhid_info(hdev, "fixing up %s report descriptor\n", device_name);\r\nrdesc[offset + 12] = 0x2f;\r\n}\r\nreturn rdesc;\r\n}\r\nstatic __u8 *kye_report_fixup(struct hid_device *hdev, __u8 *rdesc,\r\nunsigned int *rsize)\r\n{\r\nswitch (hdev->product) {\r\ncase USB_DEVICE_ID_KYE_ERGO_525V:\r\nif (*rsize >= 75 &&\r\nrdesc[61] == 0x05 && rdesc[62] == 0x08 &&\r\nrdesc[63] == 0x19 && rdesc[64] == 0x08 &&\r\nrdesc[65] == 0x29 && rdesc[66] == 0x0f &&\r\nrdesc[71] == 0x75 && rdesc[72] == 0x08 &&\r\nrdesc[73] == 0x95 && rdesc[74] == 0x01) {\r\nhid_info(hdev,\r\n"fixing up Kye/Genius Ergo Mouse "\r\n"report descriptor\n");\r\nrdesc[62] = 0x09;\r\nrdesc[64] = 0x04;\r\nrdesc[66] = 0x07;\r\nrdesc[72] = 0x01;\r\nrdesc[74] = 0x08;\r\n}\r\nbreak;\r\ncase USB_DEVICE_ID_KYE_EASYPEN_I405X:\r\nif (*rsize == EASYPEN_I405X_RDESC_ORIG_SIZE) {\r\nrdesc = easypen_i405x_rdesc_fixed;\r\n*rsize = sizeof(easypen_i405x_rdesc_fixed);\r\n}\r\nbreak;\r\ncase USB_DEVICE_ID_KYE_MOUSEPEN_I608X:\r\ncase USB_DEVICE_ID_KYE_MOUSEPEN_I608X_2:\r\nif (*rsize == MOUSEPEN_I608X_RDESC_ORIG_SIZE) {\r\nrdesc = mousepen_i608x_rdesc_fixed;\r\n*rsize = sizeof(mousepen_i608x_rdesc_fixed);\r\n}\r\nbreak;\r\ncase USB_DEVICE_ID_KYE_EASYPEN_M610X:\r\nif (*rsize == EASYPEN_M610X_RDESC_ORIG_SIZE) {\r\nrdesc = easypen_m610x_rdesc_fixed;\r\n*rsize = sizeof(easypen_m610x_rdesc_fixed);\r\n}\r\nbreak;\r\ncase USB_DEVICE_ID_KYE_PENSKETCH_M912:\r\nif (*rsize == PENSKETCH_M912_RDESC_ORIG_SIZE) {\r\nrdesc = pensketch_m912_rdesc_fixed;\r\n*rsize = sizeof(pensketch_m912_rdesc_fixed);\r\n}\r\nbreak;\r\ncase USB_DEVICE_ID_GENIUS_GILA_GAMING_MOUSE:\r\nrdesc = kye_consumer_control_fixup(hdev, rdesc, rsize, 104,\r\n"Genius Gila Gaming Mouse");\r\nbreak;\r\ncase USB_DEVICE_ID_GENIUS_GX_IMPERATOR:\r\nrdesc = kye_consumer_control_fixup(hdev, rdesc, rsize, 83,\r\n"Genius Gx Imperator Keyboard");\r\nbreak;\r\ncase USB_DEVICE_ID_GENIUS_MANTICORE:\r\nrdesc = kye_consumer_control_fixup(hdev, rdesc, rsize, 104,\r\n"Genius Manticore Keyboard");\r\nbreak;\r\n}\r\nreturn rdesc;\r\n}\r\nstatic int kye_tablet_enable(struct hid_device *hdev)\r\n{\r\nstruct list_head *list;\r\nstruct list_head *head;\r\nstruct hid_report *report;\r\n__s32 *value;\r\nlist = &hdev->report_enum[HID_FEATURE_REPORT].report_list;\r\nlist_for_each(head, list) {\r\nreport = list_entry(head, struct hid_report, list);\r\nif (report->id == 5)\r\nbreak;\r\n}\r\nif (head == list) {\r\nhid_err(hdev, "tablet-enabling feature report not found\n");\r\nreturn -ENODEV;\r\n}\r\nif (report->maxfield < 1 || report->field[0]->report_count < 7) {\r\nhid_err(hdev, "invalid tablet-enabling feature report\n");\r\nreturn -ENODEV;\r\n}\r\nvalue = report->field[0]->value;\r\nvalue[0] = 0x12;\r\nvalue[1] = 0x10;\r\nvalue[2] = 0x11;\r\nvalue[3] = 0x12;\r\nvalue[4] = 0x00;\r\nvalue[5] = 0x00;\r\nvalue[6] = 0x00;\r\nhid_hw_request(hdev, report, HID_REQ_SET_REPORT);\r\nreturn 0;\r\n}\r\nstatic int kye_probe(struct hid_device *hdev, const struct hid_device_id *id)\r\n{\r\nint ret;\r\nret = hid_parse(hdev);\r\nif (ret) {\r\nhid_err(hdev, "parse failed\n");\r\ngoto err;\r\n}\r\nret = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\r\nif (ret) {\r\nhid_err(hdev, "hw start failed\n");\r\ngoto err;\r\n}\r\nswitch (id->product) {\r\ncase USB_DEVICE_ID_KYE_EASYPEN_I405X:\r\ncase USB_DEVICE_ID_KYE_MOUSEPEN_I608X:\r\ncase USB_DEVICE_ID_KYE_MOUSEPEN_I608X_2:\r\ncase USB_DEVICE_ID_KYE_EASYPEN_M610X:\r\ncase USB_DEVICE_ID_KYE_PENSKETCH_M912:\r\nret = kye_tablet_enable(hdev);\r\nif (ret) {\r\nhid_err(hdev, "tablet enabling failed\n");\r\ngoto enabling_err;\r\n}\r\nbreak;\r\ncase USB_DEVICE_ID_GENIUS_MANTICORE:\r\nif (hid_hw_open(hdev))\r\nhid_hw_close(hdev);\r\nbreak;\r\n}\r\nreturn 0;\r\nenabling_err:\r\nhid_hw_stop(hdev);\r\nerr:\r\nreturn ret;\r\n}

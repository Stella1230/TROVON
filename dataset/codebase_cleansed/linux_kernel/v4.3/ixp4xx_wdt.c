static void wdt_enable(void)\r\n{\r\nspin_lock(&wdt_lock);\r\n*IXP4XX_OSWK = IXP4XX_WDT_KEY;\r\n*IXP4XX_OSWE = 0;\r\n*IXP4XX_OSWT = WDT_TICK_RATE * heartbeat;\r\n*IXP4XX_OSWE = IXP4XX_WDT_COUNT_ENABLE | IXP4XX_WDT_RESET_ENABLE;\r\n*IXP4XX_OSWK = 0;\r\nspin_unlock(&wdt_lock);\r\n}\r\nstatic void wdt_disable(void)\r\n{\r\nspin_lock(&wdt_lock);\r\n*IXP4XX_OSWK = IXP4XX_WDT_KEY;\r\n*IXP4XX_OSWE = 0;\r\n*IXP4XX_OSWK = 0;\r\nspin_unlock(&wdt_lock);\r\n}\r\nstatic int ixp4xx_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(WDT_IN_USE, &wdt_status))\r\nreturn -EBUSY;\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nwdt_enable();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic ssize_t\r\nixp4xx_wdt_write(struct file *file, const char *data, size_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nif (!nowayout) {\r\nsize_t i;\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nset_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\n}\r\n}\r\nwdt_enable();\r\n}\r\nreturn len;\r\n}\r\nstatic long ixp4xx_wdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint ret = -ENOTTY;\r\nint time;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nret = copy_to_user((struct watchdog_info *)arg, &ident,\r\nsizeof(ident)) ? -EFAULT : 0;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\nret = put_user(0, (int *)arg);\r\nbreak;\r\ncase WDIOC_GETBOOTSTATUS:\r\nret = put_user(boot_status, (int *)arg);\r\nbreak;\r\ncase WDIOC_KEEPALIVE:\r\nwdt_enable();\r\nret = 0;\r\nbreak;\r\ncase WDIOC_SETTIMEOUT:\r\nret = get_user(time, (int *)arg);\r\nif (ret)\r\nbreak;\r\nif (time <= 0 || time > 60) {\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nheartbeat = time;\r\nwdt_enable();\r\ncase WDIOC_GETTIMEOUT:\r\nret = put_user(heartbeat, (int *)arg);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int ixp4xx_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nif (test_bit(WDT_OK_TO_CLOSE, &wdt_status))\r\nwdt_disable();\r\nelse\r\npr_crit("Device closed unexpectedly - timer will not stop\n");\r\nclear_bit(WDT_IN_USE, &wdt_status);\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nreturn 0;\r\n}\r\nstatic int __init ixp4xx_wdt_init(void)\r\n{\r\nint ret;\r\nif (!(read_cpuid_id() & 0xf) && !cpu_is_ixp46x()) {\r\npr_err("Rev. A0 IXP42x CPU detected - watchdog disabled\n");\r\nreturn -ENODEV;\r\n}\r\nboot_status = (*IXP4XX_OSST & IXP4XX_OSST_TIMER_WARM_RESET) ?\r\nWDIOF_CARDRESET : 0;\r\nret = misc_register(&ixp4xx_wdt_miscdev);\r\nif (ret == 0)\r\npr_info("timer heartbeat %d sec\n", heartbeat);\r\nreturn ret;\r\n}\r\nstatic void __exit ixp4xx_wdt_exit(void)\r\n{\r\nmisc_deregister(&ixp4xx_wdt_miscdev);\r\n}

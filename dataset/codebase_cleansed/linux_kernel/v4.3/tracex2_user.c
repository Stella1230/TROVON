static void stars(char *str, long val, long max, int width)\r\n{\r\nint i;\r\nfor (i = 0; i < (width * val / max) - 1 && i < width - 1; i++)\r\nstr[i] = '*';\r\nif (val > max)\r\nstr[i - 1] = '+';\r\nstr[i] = '\0';\r\n}\r\nstatic void print_hist_for_pid(int fd, void *task)\r\n{\r\nstruct hist_key key = {}, next_key;\r\nchar starstr[MAX_STARS];\r\nlong value;\r\nlong data[MAX_INDEX] = {};\r\nint max_ind = -1;\r\nlong max_value = 0;\r\nint i, ind;\r\nwhile (bpf_get_next_key(fd, &key, &next_key) == 0) {\r\nif (memcmp(&next_key, task, SIZE)) {\r\nkey = next_key;\r\ncontinue;\r\n}\r\nbpf_lookup_elem(fd, &next_key, &value);\r\nind = next_key.index;\r\ndata[ind] = value;\r\nif (value && ind > max_ind)\r\nmax_ind = ind;\r\nif (value > max_value)\r\nmax_value = value;\r\nkey = next_key;\r\n}\r\nprintf(" syscall write() stats\n");\r\nprintf(" byte_size : count distribution\n");\r\nfor (i = 1; i <= max_ind + 1; i++) {\r\nstars(starstr, data[i - 1], max_value, MAX_STARS);\r\nprintf("%8ld -> %-8ld : %-8ld |%-*s|\n",\r\n(1l << i) >> 1, (1l << i) - 1, data[i - 1],\r\nMAX_STARS, starstr);\r\n}\r\n}\r\nstatic void print_hist(int fd)\r\n{\r\nstruct hist_key key = {}, next_key;\r\nstatic struct task tasks[1024];\r\nint task_cnt = 0;\r\nint i;\r\nwhile (bpf_get_next_key(fd, &key, &next_key) == 0) {\r\nint found = 0;\r\nfor (i = 0; i < task_cnt; i++)\r\nif (memcmp(&tasks[i], &next_key, SIZE) == 0)\r\nfound = 1;\r\nif (!found)\r\nmemcpy(&tasks[task_cnt++], &next_key, SIZE);\r\nkey = next_key;\r\n}\r\nfor (i = 0; i < task_cnt; i++) {\r\nprintf("\npid %d cmd %s uid %d\n",\r\n(__u32) tasks[i].pid_tgid,\r\ntasks[i].comm,\r\n(__u32) tasks[i].uid_gid);\r\nprint_hist_for_pid(fd, &tasks[i]);\r\n}\r\n}\r\nstatic void int_exit(int sig)\r\n{\r\nprint_hist(map_fd[1]);\r\nexit(0);\r\n}\r\nint main(int ac, char **argv)\r\n{\r\nchar filename[256];\r\nlong key, next_key, value;\r\nFILE *f;\r\nint i;\r\nsnprintf(filename, sizeof(filename), "%s_kern.o", argv[0]);\r\nsignal(SIGINT, int_exit);\r\nf = popen("ping -c5 localhost", "r");\r\n(void) f;\r\nf = popen("dd if=/dev/zero of=/dev/null count=5000000", "r");\r\n(void) f;\r\nif (load_bpf_file(filename)) {\r\nprintf("%s", bpf_log_buf);\r\nreturn 1;\r\n}\r\nfor (i = 0; i < 5; i++) {\r\nkey = 0;\r\nwhile (bpf_get_next_key(map_fd[0], &key, &next_key) == 0) {\r\nbpf_lookup_elem(map_fd[0], &next_key, &value);\r\nprintf("location 0x%lx count %ld\n", next_key, value);\r\nkey = next_key;\r\n}\r\nif (key)\r\nprintf("\n");\r\nsleep(1);\r\n}\r\nprint_hist(map_fd[1]);\r\nreturn 0;\r\n}

void cryp_wait_until_done(struct cryp_device_data *device_data)\r\n{\r\nwhile (cryp_is_logic_busy(device_data))\r\ncpu_relax();\r\n}\r\nint cryp_check(struct cryp_device_data *device_data)\r\n{\r\nint peripheralid2 = 0;\r\nif (NULL == device_data)\r\nreturn -EINVAL;\r\nperipheralid2 = readl_relaxed(&device_data->base->periphId2);\r\nif (peripheralid2 != CRYP_PERIPHERAL_ID2_DB8500)\r\nreturn -EPERM;\r\nif ((CRYP_PERIPHERAL_ID0 ==\r\nreadl_relaxed(&device_data->base->periphId0))\r\n&& (CRYP_PERIPHERAL_ID1 ==\r\nreadl_relaxed(&device_data->base->periphId1))\r\n&& (CRYP_PERIPHERAL_ID3 ==\r\nreadl_relaxed(&device_data->base->periphId3))\r\n&& (CRYP_PCELL_ID0 ==\r\nreadl_relaxed(&device_data->base->pcellId0))\r\n&& (CRYP_PCELL_ID1 ==\r\nreadl_relaxed(&device_data->base->pcellId1))\r\n&& (CRYP_PCELL_ID2 ==\r\nreadl_relaxed(&device_data->base->pcellId2))\r\n&& (CRYP_PCELL_ID3 ==\r\nreadl_relaxed(&device_data->base->pcellId3))) {\r\nreturn 0;\r\n}\r\nreturn -EPERM;\r\n}\r\nvoid cryp_activity(struct cryp_device_data *device_data,\r\nenum cryp_crypen cryp_crypen)\r\n{\r\nCRYP_PUT_BITS(&device_data->base->cr,\r\ncryp_crypen,\r\nCRYP_CR_CRYPEN_POS,\r\nCRYP_CR_CRYPEN_MASK);\r\n}\r\nvoid cryp_flush_inoutfifo(struct cryp_device_data *device_data)\r\n{\r\ncryp_activity(device_data, CRYP_CRYPEN_DISABLE);\r\ncryp_wait_until_done(device_data);\r\nCRYP_SET_BITS(&device_data->base->cr, CRYP_CR_FFLUSH_MASK);\r\nwhile (readl_relaxed(&device_data->base->sr) !=\r\nCRYP_SR_INFIFO_READY_MASK)\r\ncpu_relax();\r\n}\r\nint cryp_set_configuration(struct cryp_device_data *device_data,\r\nstruct cryp_config *cryp_config,\r\nu32 *control_register)\r\n{\r\nu32 cr_for_kse;\r\nif (NULL == device_data || NULL == cryp_config)\r\nreturn -EINVAL;\r\n*control_register |= (cryp_config->keysize << CRYP_CR_KEYSIZE_POS);\r\nif ((CRYP_ALGORITHM_DECRYPT == cryp_config->algodir) &&\r\n((CRYP_ALGO_AES_ECB == cryp_config->algomode) ||\r\n(CRYP_ALGO_AES_CBC == cryp_config->algomode))) {\r\ncr_for_kse = *control_register;\r\ncr_for_kse |= ((CRYP_ALGORITHM_ENCRYPT << CRYP_CR_ALGODIR_POS) |\r\n(CRYP_ALGO_AES_ECB << CRYP_CR_ALGOMODE_POS) |\r\n(CRYP_CRYPEN_ENABLE << CRYP_CR_CRYPEN_POS) |\r\n(KSE_ENABLED << CRYP_CR_KSE_POS));\r\nwritel_relaxed(cr_for_kse, &device_data->base->cr);\r\ncryp_wait_until_done(device_data);\r\n}\r\n*control_register |=\r\n((cryp_config->algomode << CRYP_CR_ALGOMODE_POS) |\r\n(cryp_config->algodir << CRYP_CR_ALGODIR_POS));\r\nreturn 0;\r\n}\r\nint cryp_configure_protection(struct cryp_device_data *device_data,\r\nstruct cryp_protection_config *p_protect_config)\r\n{\r\nif (NULL == p_protect_config)\r\nreturn -EINVAL;\r\nCRYP_WRITE_BIT(&device_data->base->cr,\r\n(u32) p_protect_config->secure_access,\r\nCRYP_CR_SECURE_MASK);\r\nCRYP_PUT_BITS(&device_data->base->cr,\r\np_protect_config->privilege_access,\r\nCRYP_CR_PRLG_POS,\r\nCRYP_CR_PRLG_MASK);\r\nreturn 0;\r\n}\r\nint cryp_is_logic_busy(struct cryp_device_data *device_data)\r\n{\r\nreturn CRYP_TEST_BITS(&device_data->base->sr,\r\nCRYP_SR_BUSY_MASK);\r\n}\r\nvoid cryp_configure_for_dma(struct cryp_device_data *device_data,\r\nenum cryp_dma_req_type dma_req)\r\n{\r\nCRYP_SET_BITS(&device_data->base->dmacr,\r\n(u32) dma_req);\r\n}\r\nint cryp_configure_key_values(struct cryp_device_data *device_data,\r\nenum cryp_key_reg_index key_reg_index,\r\nstruct cryp_key_value key_value)\r\n{\r\nwhile (cryp_is_logic_busy(device_data))\r\ncpu_relax();\r\nswitch (key_reg_index) {\r\ncase CRYP_KEY_REG_1:\r\nwritel_relaxed(key_value.key_value_left,\r\n&device_data->base->key_1_l);\r\nwritel_relaxed(key_value.key_value_right,\r\n&device_data->base->key_1_r);\r\nbreak;\r\ncase CRYP_KEY_REG_2:\r\nwritel_relaxed(key_value.key_value_left,\r\n&device_data->base->key_2_l);\r\nwritel_relaxed(key_value.key_value_right,\r\n&device_data->base->key_2_r);\r\nbreak;\r\ncase CRYP_KEY_REG_3:\r\nwritel_relaxed(key_value.key_value_left,\r\n&device_data->base->key_3_l);\r\nwritel_relaxed(key_value.key_value_right,\r\n&device_data->base->key_3_r);\r\nbreak;\r\ncase CRYP_KEY_REG_4:\r\nwritel_relaxed(key_value.key_value_left,\r\n&device_data->base->key_4_l);\r\nwritel_relaxed(key_value.key_value_right,\r\n&device_data->base->key_4_r);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint cryp_configure_init_vector(struct cryp_device_data *device_data,\r\nenum cryp_init_vector_index\r\ninit_vector_index,\r\nstruct cryp_init_vector_value\r\ninit_vector_value)\r\n{\r\nwhile (cryp_is_logic_busy(device_data))\r\ncpu_relax();\r\nswitch (init_vector_index) {\r\ncase CRYP_INIT_VECTOR_INDEX_0:\r\nwritel_relaxed(init_vector_value.init_value_left,\r\n&device_data->base->init_vect_0_l);\r\nwritel_relaxed(init_vector_value.init_value_right,\r\n&device_data->base->init_vect_0_r);\r\nbreak;\r\ncase CRYP_INIT_VECTOR_INDEX_1:\r\nwritel_relaxed(init_vector_value.init_value_left,\r\n&device_data->base->init_vect_1_l);\r\nwritel_relaxed(init_vector_value.init_value_right,\r\n&device_data->base->init_vect_1_r);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nvoid cryp_save_device_context(struct cryp_device_data *device_data,\r\nstruct cryp_device_context *ctx,\r\nint cryp_mode)\r\n{\r\nenum cryp_algo_mode algomode;\r\nstruct cryp_register __iomem *src_reg = device_data->base;\r\nstruct cryp_config *config =\r\n(struct cryp_config *)device_data->current_ctx;\r\ncryp_activity(device_data, CRYP_CRYPEN_DISABLE);\r\ncryp_wait_until_done(device_data);\r\nif (cryp_mode == CRYP_MODE_DMA)\r\ncryp_configure_for_dma(device_data, CRYP_DMA_DISABLE_BOTH);\r\nif (CRYP_TEST_BITS(&src_reg->sr, CRYP_SR_IFEM_MASK) == 0)\r\nctx->din = readl_relaxed(&src_reg->din);\r\nctx->cr = readl_relaxed(&src_reg->cr) & CRYP_CR_CONTEXT_SAVE_MASK;\r\nswitch (config->keysize) {\r\ncase CRYP_KEY_SIZE_256:\r\nctx->key_4_l = readl_relaxed(&src_reg->key_4_l);\r\nctx->key_4_r = readl_relaxed(&src_reg->key_4_r);\r\ncase CRYP_KEY_SIZE_192:\r\nctx->key_3_l = readl_relaxed(&src_reg->key_3_l);\r\nctx->key_3_r = readl_relaxed(&src_reg->key_3_r);\r\ncase CRYP_KEY_SIZE_128:\r\nctx->key_2_l = readl_relaxed(&src_reg->key_2_l);\r\nctx->key_2_r = readl_relaxed(&src_reg->key_2_r);\r\ndefault:\r\nctx->key_1_l = readl_relaxed(&src_reg->key_1_l);\r\nctx->key_1_r = readl_relaxed(&src_reg->key_1_r);\r\n}\r\nalgomode = ((ctx->cr & CRYP_CR_ALGOMODE_MASK) >> CRYP_CR_ALGOMODE_POS);\r\nif (algomode == CRYP_ALGO_TDES_CBC ||\r\nalgomode == CRYP_ALGO_DES_CBC ||\r\nalgomode == CRYP_ALGO_AES_CBC) {\r\nctx->init_vect_0_l = readl_relaxed(&src_reg->init_vect_0_l);\r\nctx->init_vect_0_r = readl_relaxed(&src_reg->init_vect_0_r);\r\nctx->init_vect_1_l = readl_relaxed(&src_reg->init_vect_1_l);\r\nctx->init_vect_1_r = readl_relaxed(&src_reg->init_vect_1_r);\r\n}\r\n}\r\nvoid cryp_restore_device_context(struct cryp_device_data *device_data,\r\nstruct cryp_device_context *ctx)\r\n{\r\nstruct cryp_register __iomem *reg = device_data->base;\r\nstruct cryp_config *config =\r\n(struct cryp_config *)device_data->current_ctx;\r\nswitch (config->keysize) {\r\ncase CRYP_KEY_SIZE_256:\r\nwritel_relaxed(ctx->key_4_l, &reg->key_4_l);\r\nwritel_relaxed(ctx->key_4_r, &reg->key_4_r);\r\ncase CRYP_KEY_SIZE_192:\r\nwritel_relaxed(ctx->key_3_l, &reg->key_3_l);\r\nwritel_relaxed(ctx->key_3_r, &reg->key_3_r);\r\ncase CRYP_KEY_SIZE_128:\r\nwritel_relaxed(ctx->key_2_l, &reg->key_2_l);\r\nwritel_relaxed(ctx->key_2_r, &reg->key_2_r);\r\ndefault:\r\nwritel_relaxed(ctx->key_1_l, &reg->key_1_l);\r\nwritel_relaxed(ctx->key_1_r, &reg->key_1_r);\r\n}\r\nif (config->algomode == CRYP_ALGO_TDES_CBC ||\r\nconfig->algomode == CRYP_ALGO_DES_CBC ||\r\nconfig->algomode == CRYP_ALGO_AES_CBC) {\r\nwritel_relaxed(ctx->init_vect_0_l, &reg->init_vect_0_l);\r\nwritel_relaxed(ctx->init_vect_0_r, &reg->init_vect_0_r);\r\nwritel_relaxed(ctx->init_vect_1_l, &reg->init_vect_1_l);\r\nwritel_relaxed(ctx->init_vect_1_r, &reg->init_vect_1_r);\r\n}\r\n}

static void coda_memcpy_parabuf(void *parabuf,\r\nconst struct coda_memcpy_desc *desc)\r\n{\r\nu32 *dst = parabuf + desc->offset;\r\nconst u32 *src = desc->src;\r\nint len = desc->len / 4;\r\nint i;\r\nfor (i = 0; i < len; i += 2) {\r\ndst[i + 1] = swab32(src[i]);\r\ndst[i] = swab32(src[i + 1]);\r\n}\r\n}\r\nint coda_jpeg_write_tables(struct coda_ctx *ctx)\r\n{\r\nint i;\r\nstatic const struct coda_memcpy_desc huff[8] = {\r\n{ 0, luma_dc_bits, sizeof(luma_dc_bits) },\r\n{ 16, luma_dc_value, sizeof(luma_dc_value) },\r\n{ 32, luma_ac_bits, sizeof(luma_ac_bits) },\r\n{ 48, luma_ac_value, sizeof(luma_ac_value) },\r\n{ 216, chroma_dc_bits, sizeof(chroma_dc_bits) },\r\n{ 232, chroma_dc_value, sizeof(chroma_dc_value) },\r\n{ 248, chroma_ac_bits, sizeof(chroma_ac_bits) },\r\n{ 264, chroma_ac_value, sizeof(chroma_ac_value) },\r\n};\r\nstruct coda_memcpy_desc qmat[3] = {\r\n{ 512, ctx->params.jpeg_qmat_tab[0], 64 },\r\n{ 576, ctx->params.jpeg_qmat_tab[1], 64 },\r\n{ 640, ctx->params.jpeg_qmat_tab[1], 64 },\r\n};\r\nfor (i = 0; i < ARRAY_SIZE(huff); i++)\r\ncoda_memcpy_parabuf(ctx->parabuf.vaddr, huff + i);\r\nfor (i = 0; i < ARRAY_SIZE(qmat); i++)\r\ncoda_memcpy_parabuf(ctx->parabuf.vaddr, qmat + i);\r\nreturn 0;\r\n}\r\nbool coda_jpeg_check_buffer(struct coda_ctx *ctx, struct vb2_buffer *vb)\r\n{\r\nvoid *vaddr = vb2_plane_vaddr(vb, 0);\r\nu16 soi = be16_to_cpup((__be16 *)vaddr);\r\nu16 eoi = be16_to_cpup((__be16 *)(vaddr +\r\nvb2_get_plane_payload(vb, 0) - 2));\r\nreturn soi == SOI_MARKER && eoi == EOI_MARKER;\r\n}\r\nstatic void coda_scale_quant_table(u8 *q_tab, int scale)\r\n{\r\nunsigned int temp;\r\nint i;\r\nfor (i = 0; i < 64; i++) {\r\ntemp = DIV_ROUND_CLOSEST((unsigned int)q_tab[i] * scale, 100);\r\nif (temp <= 0)\r\ntemp = 1;\r\nif (temp > 255)\r\ntemp = 255;\r\nq_tab[i] = (unsigned char)temp;\r\n}\r\n}\r\nvoid coda_set_jpeg_compression_quality(struct coda_ctx *ctx, int quality)\r\n{\r\nunsigned int scale;\r\nctx->params.jpeg_quality = quality;\r\nif (quality > 100)\r\nquality = 100;\r\nif (quality < 5)\r\nquality = 5;\r\nif (quality < 50)\r\nscale = 5000 / quality;\r\nelse\r\nscale = 200 - 2 * quality;\r\nif (ctx->params.jpeg_qmat_tab[0]) {\r\nmemcpy(ctx->params.jpeg_qmat_tab[0], luma_q, 64);\r\ncoda_scale_quant_table(ctx->params.jpeg_qmat_tab[0], scale);\r\n}\r\nif (ctx->params.jpeg_qmat_tab[1]) {\r\nmemcpy(ctx->params.jpeg_qmat_tab[1], chroma_q, 64);\r\ncoda_scale_quant_table(ctx->params.jpeg_qmat_tab[1], scale);\r\n}\r\n}

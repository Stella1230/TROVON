static int br_is_designated_for_some_port(const struct net_bridge *br)\r\n{\r\nstruct net_bridge_port *p;\r\nlist_for_each_entry(p, &br->port_list, list) {\r\nif (p->state != BR_STATE_DISABLED &&\r\n!memcmp(&p->designated_bridge, &br->bridge_id, 8))\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void br_hello_timer_expired(unsigned long arg)\r\n{\r\nstruct net_bridge *br = (struct net_bridge *)arg;\r\nbr_debug(br, "hello timer expired\n");\r\nspin_lock(&br->lock);\r\nif (br->dev->flags & IFF_UP) {\r\nbr_config_bpdu_generation(br);\r\nif (br->stp_enabled != BR_USER_STP)\r\nmod_timer(&br->hello_timer,\r\nround_jiffies(jiffies + br->hello_time));\r\n}\r\nspin_unlock(&br->lock);\r\n}\r\nstatic void br_message_age_timer_expired(unsigned long arg)\r\n{\r\nstruct net_bridge_port *p = (struct net_bridge_port *) arg;\r\nstruct net_bridge *br = p->br;\r\nconst bridge_id *id = &p->designated_bridge;\r\nint was_root;\r\nif (p->state == BR_STATE_DISABLED)\r\nreturn;\r\nbr_info(br, "port %u(%s) neighbor %.2x%.2x.%pM lost\n",\r\n(unsigned int) p->port_no, p->dev->name,\r\nid->prio[0], id->prio[1], &id->addr);\r\nspin_lock(&br->lock);\r\nif (p->state == BR_STATE_DISABLED)\r\ngoto unlock;\r\nwas_root = br_is_root_bridge(br);\r\nbr_become_designated_port(p);\r\nbr_configuration_update(br);\r\nbr_port_state_selection(br);\r\nif (br_is_root_bridge(br) && !was_root)\r\nbr_become_root_bridge(br);\r\nunlock:\r\nspin_unlock(&br->lock);\r\n}\r\nstatic void br_forward_delay_timer_expired(unsigned long arg)\r\n{\r\nstruct net_bridge_port *p = (struct net_bridge_port *) arg;\r\nstruct net_bridge *br = p->br;\r\nbr_debug(br, "port %u(%s) forward delay timer\n",\r\n(unsigned int) p->port_no, p->dev->name);\r\nspin_lock(&br->lock);\r\nif (p->state == BR_STATE_LISTENING) {\r\nbr_set_state(p, BR_STATE_LEARNING);\r\nmod_timer(&p->forward_delay_timer,\r\njiffies + br->forward_delay);\r\n} else if (p->state == BR_STATE_LEARNING) {\r\nbr_set_state(p, BR_STATE_FORWARDING);\r\nif (br_is_designated_for_some_port(br))\r\nbr_topology_change_detection(br);\r\nnetif_carrier_on(br->dev);\r\n}\r\nbr_log_state(p);\r\nrcu_read_lock();\r\nbr_ifinfo_notify(RTM_NEWLINK, p);\r\nrcu_read_unlock();\r\nspin_unlock(&br->lock);\r\n}\r\nstatic void br_tcn_timer_expired(unsigned long arg)\r\n{\r\nstruct net_bridge *br = (struct net_bridge *) arg;\r\nbr_debug(br, "tcn timer expired\n");\r\nspin_lock(&br->lock);\r\nif (!br_is_root_bridge(br) && (br->dev->flags & IFF_UP)) {\r\nbr_transmit_tcn(br);\r\nmod_timer(&br->tcn_timer, jiffies + br->bridge_hello_time);\r\n}\r\nspin_unlock(&br->lock);\r\n}\r\nstatic void br_topology_change_timer_expired(unsigned long arg)\r\n{\r\nstruct net_bridge *br = (struct net_bridge *) arg;\r\nbr_debug(br, "topo change timer expired\n");\r\nspin_lock(&br->lock);\r\nbr->topology_change_detected = 0;\r\nbr->topology_change = 0;\r\nspin_unlock(&br->lock);\r\n}\r\nstatic void br_hold_timer_expired(unsigned long arg)\r\n{\r\nstruct net_bridge_port *p = (struct net_bridge_port *) arg;\r\nbr_debug(p->br, "port %u(%s) hold timer expired\n",\r\n(unsigned int) p->port_no, p->dev->name);\r\nspin_lock(&p->br->lock);\r\nif (p->config_pending)\r\nbr_transmit_config(p);\r\nspin_unlock(&p->br->lock);\r\n}\r\nvoid br_stp_timer_init(struct net_bridge *br)\r\n{\r\nsetup_timer(&br->hello_timer, br_hello_timer_expired,\r\n(unsigned long) br);\r\nsetup_timer(&br->tcn_timer, br_tcn_timer_expired,\r\n(unsigned long) br);\r\nsetup_timer(&br->topology_change_timer,\r\nbr_topology_change_timer_expired,\r\n(unsigned long) br);\r\nsetup_timer(&br->gc_timer, br_fdb_cleanup, (unsigned long) br);\r\n}\r\nvoid br_stp_port_timer_init(struct net_bridge_port *p)\r\n{\r\nsetup_timer(&p->message_age_timer, br_message_age_timer_expired,\r\n(unsigned long) p);\r\nsetup_timer(&p->forward_delay_timer, br_forward_delay_timer_expired,\r\n(unsigned long) p);\r\nsetup_timer(&p->hold_timer, br_hold_timer_expired,\r\n(unsigned long) p);\r\n}\r\nunsigned long br_timer_value(const struct timer_list *timer)\r\n{\r\nreturn timer_pending(timer)\r\n? jiffies_delta_to_clock_t(timer->expires - jiffies) : 0;\r\n}

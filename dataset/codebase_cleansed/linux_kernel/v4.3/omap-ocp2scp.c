static int ocp2scp_remove_devices(struct device *dev, void *c)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nplatform_device_unregister(pdev);\r\nreturn 0;\r\n}\r\nstatic int omap_ocp2scp_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nu32 reg;\r\nvoid __iomem *regs;\r\nstruct resource *res;\r\nstruct device_node *np = pdev->dev.of_node;\r\nif (np) {\r\nret = of_platform_populate(np, NULL, NULL, &pdev->dev);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"failed to add resources for ocp2scp child\n");\r\ngoto err0;\r\n}\r\n}\r\npm_runtime_enable(&pdev->dev);\r\nif (!of_device_is_compatible(np, "ti,am437x-ocp2scp")) {\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nregs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(regs))\r\ngoto err0;\r\npm_runtime_get_sync(&pdev->dev);\r\nreg = readl_relaxed(regs + OCP2SCP_TIMING);\r\nreg &= ~(SYNC2_MASK);\r\nreg |= 0x6;\r\nwritel_relaxed(reg, regs + OCP2SCP_TIMING);\r\npm_runtime_put_sync(&pdev->dev);\r\n}\r\nreturn 0;\r\nerr0:\r\ndevice_for_each_child(&pdev->dev, NULL, ocp2scp_remove_devices);\r\nreturn ret;\r\n}\r\nstatic int omap_ocp2scp_remove(struct platform_device *pdev)\r\n{\r\npm_runtime_disable(&pdev->dev);\r\ndevice_for_each_child(&pdev->dev, NULL, ocp2scp_remove_devices);\r\nreturn 0;\r\n}

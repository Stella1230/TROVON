static bool da9150_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase DA9150_PAGE_CON:\r\ncase DA9150_STATUS_A:\r\ncase DA9150_STATUS_B:\r\ncase DA9150_STATUS_C:\r\ncase DA9150_STATUS_D:\r\ncase DA9150_STATUS_E:\r\ncase DA9150_STATUS_F:\r\ncase DA9150_STATUS_G:\r\ncase DA9150_STATUS_H:\r\ncase DA9150_STATUS_I:\r\ncase DA9150_STATUS_J:\r\ncase DA9150_STATUS_K:\r\ncase DA9150_STATUS_L:\r\ncase DA9150_STATUS_N:\r\ncase DA9150_FAULT_LOG_A:\r\ncase DA9150_FAULT_LOG_B:\r\ncase DA9150_EVENT_E:\r\ncase DA9150_EVENT_F:\r\ncase DA9150_EVENT_G:\r\ncase DA9150_EVENT_H:\r\ncase DA9150_CONTROL_B:\r\ncase DA9150_CONTROL_C:\r\ncase DA9150_GPADC_MAN:\r\ncase DA9150_GPADC_RES_A:\r\ncase DA9150_GPADC_RES_B:\r\ncase DA9150_ADETVB_CFG_C:\r\ncase DA9150_ADETD_STAT:\r\ncase DA9150_ADET_CMPSTAT:\r\ncase DA9150_ADET_CTRL_A:\r\ncase DA9150_PPR_TCTR_B:\r\ncase DA9150_COREBTLD_STAT_A:\r\ncase DA9150_CORE_DATA_A:\r\ncase DA9150_CORE_DATA_B:\r\ncase DA9150_CORE_DATA_C:\r\ncase DA9150_CORE_DATA_D:\r\ncase DA9150_CORE2WIRE_STAT_A:\r\ncase DA9150_FW_CTRL_C:\r\ncase DA9150_FG_CTRL_B:\r\ncase DA9150_FW_CTRL_B:\r\ncase DA9150_GPADC_CMAN:\r\ncase DA9150_GPADC_CRES_A:\r\ncase DA9150_GPADC_CRES_B:\r\ncase DA9150_CC_ICHG_RES_A:\r\ncase DA9150_CC_ICHG_RES_B:\r\ncase DA9150_CC_IAVG_RES_A:\r\ncase DA9150_CC_IAVG_RES_B:\r\ncase DA9150_TAUX_CTRL_A:\r\ncase DA9150_TAUX_VALUE_H:\r\ncase DA9150_TAUX_VALUE_L:\r\ncase DA9150_TBAT_RES_A:\r\ncase DA9150_TBAT_RES_B:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nu8 da9150_reg_read(struct da9150 *da9150, u16 reg)\r\n{\r\nint val, ret;\r\nret = regmap_read(da9150->regmap, reg, &val);\r\nif (ret)\r\ndev_err(da9150->dev, "Failed to read from reg 0x%x: %d\n",\r\nreg, ret);\r\nreturn (u8) val;\r\n}\r\nvoid da9150_reg_write(struct da9150 *da9150, u16 reg, u8 val)\r\n{\r\nint ret;\r\nret = regmap_write(da9150->regmap, reg, val);\r\nif (ret)\r\ndev_err(da9150->dev, "Failed to write to reg 0x%x: %d\n",\r\nreg, ret);\r\n}\r\nvoid da9150_set_bits(struct da9150 *da9150, u16 reg, u8 mask, u8 val)\r\n{\r\nint ret;\r\nret = regmap_update_bits(da9150->regmap, reg, mask, val);\r\nif (ret)\r\ndev_err(da9150->dev, "Failed to set bits in reg 0x%x: %d\n",\r\nreg, ret);\r\n}\r\nvoid da9150_bulk_read(struct da9150 *da9150, u16 reg, int count, u8 *buf)\r\n{\r\nint ret;\r\nret = regmap_bulk_read(da9150->regmap, reg, buf, count);\r\nif (ret)\r\ndev_err(da9150->dev, "Failed to bulk read from reg 0x%x: %d\n",\r\nreg, ret);\r\n}\r\nvoid da9150_bulk_write(struct da9150 *da9150, u16 reg, int count, const u8 *buf)\r\n{\r\nint ret;\r\nret = regmap_raw_write(da9150->regmap, reg, buf, count);\r\nif (ret)\r\ndev_err(da9150->dev, "Failed to bulk write to reg 0x%x %d\n",\r\nreg, ret);\r\n}\r\nstatic int da9150_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct da9150 *da9150;\r\nstruct da9150_pdata *pdata = dev_get_platdata(&client->dev);\r\nint ret;\r\nda9150 = devm_kzalloc(&client->dev, sizeof(*da9150), GFP_KERNEL);\r\nif (!da9150)\r\nreturn -ENOMEM;\r\nda9150->dev = &client->dev;\r\nda9150->irq = client->irq;\r\ni2c_set_clientdata(client, da9150);\r\nda9150->regmap = devm_regmap_init_i2c(client, &da9150_regmap_config);\r\nif (IS_ERR(da9150->regmap)) {\r\nret = PTR_ERR(da9150->regmap);\r\ndev_err(da9150->dev, "Failed to allocate register map: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nda9150->irq_base = pdata ? pdata->irq_base : -1;\r\nret = regmap_add_irq_chip(da9150->regmap, da9150->irq,\r\nIRQF_TRIGGER_LOW | IRQF_ONESHOT,\r\nda9150->irq_base, &da9150_regmap_irq_chip,\r\n&da9150->regmap_irq_data);\r\nif (ret)\r\nreturn ret;\r\nda9150->irq_base = regmap_irq_chip_get_base(da9150->regmap_irq_data);\r\nenable_irq_wake(da9150->irq);\r\nret = mfd_add_devices(da9150->dev, -1, da9150_devs,\r\nARRAY_SIZE(da9150_devs), NULL,\r\nda9150->irq_base, NULL);\r\nif (ret) {\r\ndev_err(da9150->dev, "Failed to add child devices: %d\n", ret);\r\nregmap_del_irq_chip(da9150->irq, da9150->regmap_irq_data);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int da9150_remove(struct i2c_client *client)\r\n{\r\nstruct da9150 *da9150 = i2c_get_clientdata(client);\r\nregmap_del_irq_chip(da9150->irq, da9150->regmap_irq_data);\r\nmfd_remove_devices(da9150->dev);\r\nreturn 0;\r\n}\r\nstatic void da9150_shutdown(struct i2c_client *client)\r\n{\r\nstruct da9150 *da9150 = i2c_get_clientdata(client);\r\nda9150_set_bits(da9150, DA9150_CONFIG_D,\r\nDA9150_WKUP_PM_EN_MASK,\r\nDA9150_WKUP_PM_EN_MASK);\r\nda9150_set_bits(da9150, DA9150_CONTROL_C,\r\nDA9150_DISABLE_MASK, DA9150_DISABLE_MASK);\r\n}

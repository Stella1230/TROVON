static void __mmc_pwrseq_emmc_reset(struct mmc_pwrseq_emmc *pwrseq)\r\n{\r\ngpiod_set_value(pwrseq->reset_gpio, 1);\r\nudelay(1);\r\ngpiod_set_value(pwrseq->reset_gpio, 0);\r\nudelay(200);\r\n}\r\nstatic void mmc_pwrseq_emmc_reset(struct mmc_host *host)\r\n{\r\nstruct mmc_pwrseq_emmc *pwrseq = container_of(host->pwrseq,\r\nstruct mmc_pwrseq_emmc, pwrseq);\r\n__mmc_pwrseq_emmc_reset(pwrseq);\r\n}\r\nstatic void mmc_pwrseq_emmc_free(struct mmc_host *host)\r\n{\r\nstruct mmc_pwrseq_emmc *pwrseq = container_of(host->pwrseq,\r\nstruct mmc_pwrseq_emmc, pwrseq);\r\nunregister_restart_handler(&pwrseq->reset_nb);\r\ngpiod_put(pwrseq->reset_gpio);\r\nkfree(pwrseq);\r\n}\r\nstatic int mmc_pwrseq_emmc_reset_nb(struct notifier_block *this,\r\nunsigned long mode, void *cmd)\r\n{\r\nstruct mmc_pwrseq_emmc *pwrseq = container_of(this,\r\nstruct mmc_pwrseq_emmc, reset_nb);\r\n__mmc_pwrseq_emmc_reset(pwrseq);\r\nreturn NOTIFY_DONE;\r\n}\r\nstruct mmc_pwrseq *mmc_pwrseq_emmc_alloc(struct mmc_host *host,\r\nstruct device *dev)\r\n{\r\nstruct mmc_pwrseq_emmc *pwrseq;\r\nint ret = 0;\r\npwrseq = kzalloc(sizeof(struct mmc_pwrseq_emmc), GFP_KERNEL);\r\nif (!pwrseq)\r\nreturn ERR_PTR(-ENOMEM);\r\npwrseq->reset_gpio = gpiod_get_index(dev, "reset", 0, GPIOD_OUT_LOW);\r\nif (IS_ERR(pwrseq->reset_gpio)) {\r\nret = PTR_ERR(pwrseq->reset_gpio);\r\ngoto free;\r\n}\r\npwrseq->reset_nb.notifier_call = mmc_pwrseq_emmc_reset_nb;\r\npwrseq->reset_nb.priority = 129;\r\nregister_restart_handler(&pwrseq->reset_nb);\r\npwrseq->pwrseq.ops = &mmc_pwrseq_emmc_ops;\r\nreturn &pwrseq->pwrseq;\r\nfree:\r\nkfree(pwrseq);\r\nreturn ERR_PTR(ret);\r\n}

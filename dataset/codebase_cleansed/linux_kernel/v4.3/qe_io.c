int par_io_init(struct device_node *np)\r\n{\r\nstruct resource res;\r\nint ret;\r\nconst u32 *num_ports;\r\nret = of_address_to_resource(np, 0, &res);\r\nif (ret)\r\nreturn ret;\r\npar_io = ioremap(res.start, resource_size(&res));\r\nnum_ports = of_get_property(np, "num-ports", NULL);\r\nif (num_ports)\r\nnum_par_io_ports = *num_ports;\r\nreturn 0;\r\n}\r\nvoid __par_io_config_pin(struct qe_pio_regs __iomem *par_io, u8 pin, int dir,\r\nint open_drain, int assignment, int has_irq)\r\n{\r\nu32 pin_mask1bit;\r\nu32 pin_mask2bits;\r\nu32 new_mask2bits;\r\nu32 tmp_val;\r\npin_mask1bit = (u32) (1 << (QE_PIO_PINS - (pin + 1)));\r\ntmp_val = in_be32(&par_io->cpodr);\r\nif (open_drain)\r\nout_be32(&par_io->cpodr, pin_mask1bit | tmp_val);\r\nelse\r\nout_be32(&par_io->cpodr, ~pin_mask1bit & tmp_val);\r\ntmp_val = (pin > (QE_PIO_PINS / 2) - 1) ?\r\nin_be32(&par_io->cpdir2) :\r\nin_be32(&par_io->cpdir1);\r\npin_mask2bits = (u32) (0x3 << (QE_PIO_PINS -\r\n(pin % (QE_PIO_PINS / 2) + 1) * 2));\r\nnew_mask2bits = (u32) (dir << (QE_PIO_PINS -\r\n(pin % (QE_PIO_PINS / 2) + 1) * 2));\r\nif (pin > (QE_PIO_PINS / 2) - 1) {\r\nout_be32(&par_io->cpdir2,\r\n~pin_mask2bits & tmp_val);\r\ntmp_val &= ~pin_mask2bits;\r\nout_be32(&par_io->cpdir2, new_mask2bits | tmp_val);\r\n} else {\r\nout_be32(&par_io->cpdir1,\r\n~pin_mask2bits & tmp_val);\r\ntmp_val &= ~pin_mask2bits;\r\nout_be32(&par_io->cpdir1, new_mask2bits | tmp_val);\r\n}\r\ntmp_val = (pin > (QE_PIO_PINS / 2) - 1) ?\r\nin_be32(&par_io->cppar2) :\r\nin_be32(&par_io->cppar1);\r\nnew_mask2bits = (u32) (assignment << (QE_PIO_PINS -\r\n(pin % (QE_PIO_PINS / 2) + 1) * 2));\r\nif (pin > (QE_PIO_PINS / 2) - 1) {\r\nout_be32(&par_io->cppar2,\r\n~pin_mask2bits & tmp_val);\r\ntmp_val &= ~pin_mask2bits;\r\nout_be32(&par_io->cppar2, new_mask2bits | tmp_val);\r\n} else {\r\nout_be32(&par_io->cppar1,\r\n~pin_mask2bits & tmp_val);\r\ntmp_val &= ~pin_mask2bits;\r\nout_be32(&par_io->cppar1, new_mask2bits | tmp_val);\r\n}\r\n}\r\nint par_io_config_pin(u8 port, u8 pin, int dir, int open_drain,\r\nint assignment, int has_irq)\r\n{\r\nif (!par_io || port >= num_par_io_ports)\r\nreturn -EINVAL;\r\n__par_io_config_pin(&par_io[port], pin, dir, open_drain, assignment,\r\nhas_irq);\r\nreturn 0;\r\n}\r\nint par_io_data_set(u8 port, u8 pin, u8 val)\r\n{\r\nu32 pin_mask, tmp_val;\r\nif (port >= num_par_io_ports)\r\nreturn -EINVAL;\r\nif (pin >= QE_PIO_PINS)\r\nreturn -EINVAL;\r\npin_mask = (u32) (1 << (QE_PIO_PINS - 1 - pin));\r\ntmp_val = in_be32(&par_io[port].cpdata);\r\nif (val == 0)\r\nout_be32(&par_io[port].cpdata, ~pin_mask & tmp_val);\r\nelse\r\nout_be32(&par_io[port].cpdata, pin_mask | tmp_val);\r\nreturn 0;\r\n}\r\nint par_io_of_config(struct device_node *np)\r\n{\r\nstruct device_node *pio;\r\nconst phandle *ph;\r\nint pio_map_len;\r\nconst unsigned int *pio_map;\r\nif (par_io == NULL) {\r\nprintk(KERN_ERR "par_io not initialized\n");\r\nreturn -1;\r\n}\r\nph = of_get_property(np, "pio-handle", NULL);\r\nif (ph == NULL) {\r\nprintk(KERN_ERR "pio-handle not available\n");\r\nreturn -1;\r\n}\r\npio = of_find_node_by_phandle(*ph);\r\npio_map = of_get_property(pio, "pio-map", &pio_map_len);\r\nif (pio_map == NULL) {\r\nprintk(KERN_ERR "pio-map is not set!\n");\r\nreturn -1;\r\n}\r\npio_map_len /= sizeof(unsigned int);\r\nif ((pio_map_len % 6) != 0) {\r\nprintk(KERN_ERR "pio-map format wrong!\n");\r\nreturn -1;\r\n}\r\nwhile (pio_map_len > 0) {\r\npar_io_config_pin((u8) pio_map[0], (u8) pio_map[1],\r\n(int) pio_map[2], (int) pio_map[3],\r\n(int) pio_map[4], (int) pio_map[5]);\r\npio_map += 6;\r\npio_map_len -= 6;\r\n}\r\nof_node_put(pio);\r\nreturn 0;\r\n}

static int dwc2_driver_remove(struct platform_device *dev)\r\n{\r\nstruct dwc2_hsotg *hsotg = platform_get_drvdata(dev);\r\ndwc2_debugfs_exit(hsotg);\r\nif (hsotg->hcd_enabled)\r\ndwc2_hcd_remove(hsotg);\r\nif (hsotg->gadget_enabled)\r\ns3c_hsotg_remove(hsotg);\r\nreturn 0;\r\n}\r\nstatic int dwc2_driver_probe(struct platform_device *dev)\r\n{\r\nconst struct of_device_id *match;\r\nconst struct dwc2_core_params *params;\r\nstruct dwc2_core_params defparams;\r\nstruct dwc2_hsotg *hsotg;\r\nstruct resource *res;\r\nstruct phy *phy;\r\nstruct usb_phy *uphy;\r\nint retval;\r\nint irq;\r\nmatch = of_match_device(dwc2_of_match_table, &dev->dev);\r\nif (match && match->data) {\r\nparams = match->data;\r\n} else {\r\ndwc2_set_all_params(&defparams, -1);\r\nparams = &defparams;\r\ndefparams.dma_desc_enable = 0;\r\n}\r\nhsotg = devm_kzalloc(&dev->dev, sizeof(*hsotg), GFP_KERNEL);\r\nif (!hsotg)\r\nreturn -ENOMEM;\r\nhsotg->dev = &dev->dev;\r\nif (!dev->dev.dma_mask)\r\ndev->dev.dma_mask = &dev->dev.coherent_dma_mask;\r\nretval = dma_set_coherent_mask(&dev->dev, DMA_BIT_MASK(32));\r\nif (retval)\r\nreturn retval;\r\nirq = platform_get_irq(dev, 0);\r\nif (irq < 0) {\r\ndev_err(&dev->dev, "missing IRQ resource\n");\r\nreturn irq;\r\n}\r\ndev_dbg(hsotg->dev, "registering common handler for irq%d\n",\r\nirq);\r\nretval = devm_request_irq(hsotg->dev, irq,\r\ndwc2_handle_common_intr, IRQF_SHARED,\r\ndev_name(hsotg->dev), hsotg);\r\nif (retval)\r\nreturn retval;\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nhsotg->regs = devm_ioremap_resource(&dev->dev, res);\r\nif (IS_ERR(hsotg->regs))\r\nreturn PTR_ERR(hsotg->regs);\r\ndev_dbg(&dev->dev, "mapped PA %08lx to VA %p\n",\r\n(unsigned long)res->start, hsotg->regs);\r\nhsotg->dr_mode = of_usb_get_dr_mode(dev->dev.of_node);\r\nphy = devm_phy_get(&dev->dev, "usb2-phy");\r\nif (IS_ERR(phy)) {\r\nhsotg->phy = NULL;\r\nuphy = devm_usb_get_phy(&dev->dev, USB_PHY_TYPE_USB2);\r\nif (IS_ERR(uphy))\r\nhsotg->uphy = NULL;\r\nelse\r\nhsotg->uphy = uphy;\r\n} else {\r\nhsotg->phy = phy;\r\nphy_power_on(hsotg->phy);\r\nphy_init(hsotg->phy);\r\n}\r\nspin_lock_init(&hsotg->lock);\r\nmutex_init(&hsotg->init_mutex);\r\nretval = dwc2_get_hwparams(hsotg);\r\nif (retval)\r\nreturn retval;\r\nhsotg->core_params = devm_kzalloc(&dev->dev,\r\nsizeof(*hsotg->core_params), GFP_KERNEL);\r\nif (!hsotg->core_params)\r\nreturn -ENOMEM;\r\ndwc2_set_all_params(hsotg->core_params, -1);\r\ndwc2_set_parameters(hsotg, params);\r\nif (hsotg->dr_mode != USB_DR_MODE_HOST) {\r\nretval = dwc2_gadget_init(hsotg, irq);\r\nif (retval)\r\nreturn retval;\r\nhsotg->gadget_enabled = 1;\r\n}\r\nif (hsotg->dr_mode != USB_DR_MODE_PERIPHERAL) {\r\nretval = dwc2_hcd_init(hsotg, irq);\r\nif (retval) {\r\nif (hsotg->gadget_enabled)\r\ns3c_hsotg_remove(hsotg);\r\nreturn retval;\r\n}\r\nhsotg->hcd_enabled = 1;\r\n}\r\nplatform_set_drvdata(dev, hsotg);\r\ndwc2_debugfs_init(hsotg);\r\nreturn retval;\r\n}\r\nstatic int __maybe_unused dwc2_suspend(struct device *dev)\r\n{\r\nstruct dwc2_hsotg *dwc2 = dev_get_drvdata(dev);\r\nint ret = 0;\r\nif (dwc2_is_device_mode(dwc2)) {\r\nret = s3c_hsotg_suspend(dwc2);\r\n} else {\r\nif (dwc2->lx_state == DWC2_L0)\r\nreturn 0;\r\nphy_exit(dwc2->phy);\r\nphy_power_off(dwc2->phy);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __maybe_unused dwc2_resume(struct device *dev)\r\n{\r\nstruct dwc2_hsotg *dwc2 = dev_get_drvdata(dev);\r\nint ret = 0;\r\nif (dwc2_is_device_mode(dwc2)) {\r\nret = s3c_hsotg_resume(dwc2);\r\n} else {\r\nphy_power_on(dwc2->phy);\r\nphy_init(dwc2->phy);\r\n}\r\nreturn ret;\r\n}

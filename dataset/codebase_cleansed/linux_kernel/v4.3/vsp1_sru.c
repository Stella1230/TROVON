static inline u32 vsp1_sru_read(struct vsp1_sru *sru, u32 reg)\r\n{\r\nreturn vsp1_read(sru->entity.vsp1, reg);\r\n}\r\nstatic inline void vsp1_sru_write(struct vsp1_sru *sru, u32 reg, u32 data)\r\n{\r\nvsp1_write(sru->entity.vsp1, reg, data);\r\n}\r\nstatic int sru_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct vsp1_sru *sru =\r\ncontainer_of(ctrl->handler, struct vsp1_sru, ctrls);\r\nconst struct vsp1_sru_param *param;\r\nu32 value;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_VSP1_SRU_INTENSITY:\r\nparam = &vsp1_sru_params[ctrl->val - 1];\r\nvalue = vsp1_sru_read(sru, VI6_SRU_CTRL0);\r\nvalue &= ~(VI6_SRU_CTRL0_PARAM0_MASK |\r\nVI6_SRU_CTRL0_PARAM1_MASK);\r\nvalue |= param->ctrl0;\r\nvsp1_sru_write(sru, VI6_SRU_CTRL0, value);\r\nvsp1_sru_write(sru, VI6_SRU_CTRL2, param->ctrl2);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sru_s_stream(struct v4l2_subdev *subdev, int enable)\r\n{\r\nstruct vsp1_sru *sru = to_sru(subdev);\r\nstruct v4l2_mbus_framefmt *input;\r\nstruct v4l2_mbus_framefmt *output;\r\nu32 ctrl0;\r\nint ret;\r\nret = vsp1_entity_set_streaming(&sru->entity, enable);\r\nif (ret < 0)\r\nreturn ret;\r\nif (!enable)\r\nreturn 0;\r\ninput = &sru->entity.formats[SRU_PAD_SINK];\r\noutput = &sru->entity.formats[SRU_PAD_SOURCE];\r\nif (input->code == MEDIA_BUS_FMT_ARGB8888_1X32)\r\nctrl0 = VI6_SRU_CTRL0_PARAM2 | VI6_SRU_CTRL0_PARAM3\r\n| VI6_SRU_CTRL0_PARAM4;\r\nelse\r\nctrl0 = VI6_SRU_CTRL0_PARAM3;\r\nif (input->width != output->width)\r\nctrl0 |= VI6_SRU_CTRL0_MODE_UPSCALE;\r\nmutex_lock(sru->ctrls.lock);\r\nctrl0 |= vsp1_sru_read(sru, VI6_SRU_CTRL0)\r\n& (VI6_SRU_CTRL0_PARAM0_MASK | VI6_SRU_CTRL0_PARAM1_MASK);\r\nmutex_unlock(sru->ctrls.lock);\r\nvsp1_sru_write(sru, VI6_SRU_CTRL1, VI6_SRU_CTRL1_PARAM5);\r\nreturn 0;\r\n}\r\nstatic int sru_enum_mbus_code(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_mbus_code_enum *code)\r\n{\r\nstatic const unsigned int codes[] = {\r\nMEDIA_BUS_FMT_ARGB8888_1X32,\r\nMEDIA_BUS_FMT_AYUV8_1X32,\r\n};\r\nstruct vsp1_sru *sru = to_sru(subdev);\r\nstruct v4l2_mbus_framefmt *format;\r\nif (code->pad == SRU_PAD_SINK) {\r\nif (code->index >= ARRAY_SIZE(codes))\r\nreturn -EINVAL;\r\ncode->code = codes[code->index];\r\n} else {\r\nif (code->index)\r\nreturn -EINVAL;\r\nformat = vsp1_entity_get_pad_format(&sru->entity, cfg,\r\nSRU_PAD_SINK, code->which);\r\ncode->code = format->code;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sru_enum_frame_size(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_frame_size_enum *fse)\r\n{\r\nstruct vsp1_sru *sru = to_sru(subdev);\r\nstruct v4l2_mbus_framefmt *format;\r\nformat = vsp1_entity_get_pad_format(&sru->entity, cfg,\r\nSRU_PAD_SINK, fse->which);\r\nif (fse->index || fse->code != format->code)\r\nreturn -EINVAL;\r\nif (fse->pad == SRU_PAD_SINK) {\r\nfse->min_width = SRU_MIN_SIZE;\r\nfse->max_width = SRU_MAX_SIZE;\r\nfse->min_height = SRU_MIN_SIZE;\r\nfse->max_height = SRU_MAX_SIZE;\r\n} else {\r\nfse->min_width = format->width;\r\nfse->min_height = format->height;\r\nif (format->width <= SRU_MAX_SIZE / 2 &&\r\nformat->height <= SRU_MAX_SIZE / 2) {\r\nfse->max_width = format->width * 2;\r\nfse->max_height = format->height * 2;\r\n} else {\r\nfse->max_width = format->width;\r\nfse->max_height = format->height;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int sru_get_format(struct v4l2_subdev *subdev, struct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct vsp1_sru *sru = to_sru(subdev);\r\nfmt->format = *vsp1_entity_get_pad_format(&sru->entity, cfg, fmt->pad,\r\nfmt->which);\r\nreturn 0;\r\n}\r\nstatic void sru_try_format(struct vsp1_sru *sru, struct v4l2_subdev_pad_config *cfg,\r\nunsigned int pad, struct v4l2_mbus_framefmt *fmt,\r\nenum v4l2_subdev_format_whence which)\r\n{\r\nstruct v4l2_mbus_framefmt *format;\r\nunsigned int input_area;\r\nunsigned int output_area;\r\nswitch (pad) {\r\ncase SRU_PAD_SINK:\r\nif (fmt->code != MEDIA_BUS_FMT_ARGB8888_1X32 &&\r\nfmt->code != MEDIA_BUS_FMT_AYUV8_1X32)\r\nfmt->code = MEDIA_BUS_FMT_AYUV8_1X32;\r\nfmt->width = clamp(fmt->width, SRU_MIN_SIZE, SRU_MAX_SIZE);\r\nfmt->height = clamp(fmt->height, SRU_MIN_SIZE, SRU_MAX_SIZE);\r\nbreak;\r\ncase SRU_PAD_SOURCE:\r\nformat = vsp1_entity_get_pad_format(&sru->entity, cfg,\r\nSRU_PAD_SINK, which);\r\nfmt->code = format->code;\r\ninput_area = format->width * format->height;\r\noutput_area = min(fmt->width, SRU_MAX_SIZE)\r\n* min(fmt->height, SRU_MAX_SIZE);\r\nif (fmt->width <= SRU_MAX_SIZE / 2 &&\r\nfmt->height <= SRU_MAX_SIZE / 2 &&\r\noutput_area > input_area * 9 / 4) {\r\nfmt->width = format->width * 2;\r\nfmt->height = format->height * 2;\r\n} else {\r\nfmt->width = format->width;\r\nfmt->height = format->height;\r\n}\r\nbreak;\r\n}\r\nfmt->field = V4L2_FIELD_NONE;\r\nfmt->colorspace = V4L2_COLORSPACE_SRGB;\r\n}\r\nstatic int sru_set_format(struct v4l2_subdev *subdev, struct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct vsp1_sru *sru = to_sru(subdev);\r\nstruct v4l2_mbus_framefmt *format;\r\nsru_try_format(sru, cfg, fmt->pad, &fmt->format, fmt->which);\r\nformat = vsp1_entity_get_pad_format(&sru->entity, cfg, fmt->pad,\r\nfmt->which);\r\n*format = fmt->format;\r\nif (fmt->pad == SRU_PAD_SINK) {\r\nformat = vsp1_entity_get_pad_format(&sru->entity, cfg,\r\nSRU_PAD_SOURCE, fmt->which);\r\n*format = fmt->format;\r\nsru_try_format(sru, cfg, SRU_PAD_SOURCE, format, fmt->which);\r\n}\r\nreturn 0;\r\n}\r\nstruct vsp1_sru *vsp1_sru_create(struct vsp1_device *vsp1)\r\n{\r\nstruct v4l2_subdev *subdev;\r\nstruct vsp1_sru *sru;\r\nint ret;\r\nsru = devm_kzalloc(vsp1->dev, sizeof(*sru), GFP_KERNEL);\r\nif (sru == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nsru->entity.type = VSP1_ENTITY_SRU;\r\nret = vsp1_entity_init(vsp1, &sru->entity, 2);\r\nif (ret < 0)\r\nreturn ERR_PTR(ret);\r\nsubdev = &sru->entity.subdev;\r\nv4l2_subdev_init(subdev, &sru_ops);\r\nsubdev->entity.ops = &vsp1_media_ops;\r\nsubdev->internal_ops = &vsp1_subdev_internal_ops;\r\nsnprintf(subdev->name, sizeof(subdev->name), "%s sru",\r\ndev_name(vsp1->dev));\r\nv4l2_set_subdevdata(subdev, sru);\r\nsubdev->flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;\r\nvsp1_entity_init_formats(subdev, NULL);\r\nv4l2_ctrl_handler_init(&sru->ctrls, 1);\r\nv4l2_ctrl_new_custom(&sru->ctrls, &sru_intensity_control, NULL);\r\nsru->entity.subdev.ctrl_handler = &sru->ctrls;\r\nif (sru->ctrls.error) {\r\ndev_err(vsp1->dev, "sru: failed to initialize controls\n");\r\nret = sru->ctrls.error;\r\nvsp1_entity_destroy(&sru->entity);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn sru;\r\n}

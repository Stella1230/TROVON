void _p9_debug(enum p9_debug_flags level, const char *func,\r\nconst char *fmt, ...)\r\n{\r\nstruct va_format vaf;\r\nva_list args;\r\nif ((p9_debug_level & level) != level)\r\nreturn;\r\nva_start(args, fmt);\r\nvaf.fmt = fmt;\r\nvaf.va = &args;\r\nif (level == P9_DEBUG_9P)\r\npr_notice("(%8.8d) %pV", task_pid_nr(current), &vaf);\r\nelse\r\npr_notice("-- %s (%d): %pV", func, task_pid_nr(current), &vaf);\r\nva_end(args);\r\n}\r\nvoid v9fs_register_trans(struct p9_trans_module *m)\r\n{\r\nspin_lock(&v9fs_trans_lock);\r\nlist_add_tail(&m->list, &v9fs_trans_list);\r\nspin_unlock(&v9fs_trans_lock);\r\n}\r\nvoid v9fs_unregister_trans(struct p9_trans_module *m)\r\n{\r\nspin_lock(&v9fs_trans_lock);\r\nlist_del_init(&m->list);\r\nspin_unlock(&v9fs_trans_lock);\r\n}\r\nstruct p9_trans_module *v9fs_get_trans_by_name(char *s)\r\n{\r\nstruct p9_trans_module *t, *found = NULL;\r\nspin_lock(&v9fs_trans_lock);\r\nlist_for_each_entry(t, &v9fs_trans_list, list)\r\nif (strcmp(t->name, s) == 0 &&\r\ntry_module_get(t->owner)) {\r\nfound = t;\r\nbreak;\r\n}\r\nspin_unlock(&v9fs_trans_lock);\r\nreturn found;\r\n}\r\nstruct p9_trans_module *v9fs_get_default_trans(void)\r\n{\r\nstruct p9_trans_module *t, *found = NULL;\r\nspin_lock(&v9fs_trans_lock);\r\nlist_for_each_entry(t, &v9fs_trans_list, list)\r\nif (t->def && try_module_get(t->owner)) {\r\nfound = t;\r\nbreak;\r\n}\r\nif (!found)\r\nlist_for_each_entry(t, &v9fs_trans_list, list)\r\nif (try_module_get(t->owner)) {\r\nfound = t;\r\nbreak;\r\n}\r\nspin_unlock(&v9fs_trans_lock);\r\nreturn found;\r\n}\r\nvoid v9fs_put_trans(struct p9_trans_module *m)\r\n{\r\nif (m)\r\nmodule_put(m->owner);\r\n}\r\nstatic int __init init_p9(void)\r\n{\r\nint ret = 0;\r\np9_error_init();\r\npr_info("Installing 9P2000 support\n");\r\np9_trans_fd_init();\r\nreturn ret;\r\n}\r\nstatic void __exit exit_p9(void)\r\n{\r\npr_info("Unloading 9P2000 support\n");\r\np9_trans_fd_exit();\r\n}

u8 acpi_rs_decode_bitmask(u16 mask, u8 * list)\r\n{\r\nu8 i;\r\nu8 bit_count;\r\nACPI_FUNCTION_ENTRY();\r\nfor (i = 0, bit_count = 0; mask; i++) {\r\nif (mask & 0x0001) {\r\nlist[bit_count] = i;\r\nbit_count++;\r\n}\r\nmask >>= 1;\r\n}\r\nreturn (bit_count);\r\n}\r\nu16 acpi_rs_encode_bitmask(u8 * list, u8 count)\r\n{\r\nu32 i;\r\nu16 mask;\r\nACPI_FUNCTION_ENTRY();\r\nfor (i = 0, mask = 0; i < count; i++) {\r\nmask |= (0x1 << list[i]);\r\n}\r\nreturn (mask);\r\n}\r\nvoid\r\nacpi_rs_move_data(void *destination, void *source, u16 item_count, u8 move_type)\r\n{\r\nu32 i;\r\nACPI_FUNCTION_ENTRY();\r\nfor (i = 0; i < item_count; i++) {\r\nswitch (move_type) {\r\ncase ACPI_RSC_MOVE8:\r\ncase ACPI_RSC_MOVE_GPIO_RES:\r\ncase ACPI_RSC_MOVE_SERIAL_VEN:\r\ncase ACPI_RSC_MOVE_SERIAL_RES:\r\nmemcpy(destination, source, item_count);\r\nreturn;\r\ncase ACPI_RSC_MOVE16:\r\ncase ACPI_RSC_MOVE_GPIO_PIN:\r\nACPI_MOVE_16_TO_16(&ACPI_CAST_PTR(u16, destination)[i],\r\n&ACPI_CAST_PTR(u16, source)[i]);\r\nbreak;\r\ncase ACPI_RSC_MOVE32:\r\nACPI_MOVE_32_TO_32(&ACPI_CAST_PTR(u32, destination)[i],\r\n&ACPI_CAST_PTR(u32, source)[i]);\r\nbreak;\r\ncase ACPI_RSC_MOVE64:\r\nACPI_MOVE_64_TO_64(&ACPI_CAST_PTR(u64, destination)[i],\r\n&ACPI_CAST_PTR(u64, source)[i]);\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\n}\r\n}\r\nvoid\r\nacpi_rs_set_resource_length(acpi_rsdesc_size total_length,\r\nunion aml_resource *aml)\r\n{\r\nacpi_rs_length resource_length;\r\nACPI_FUNCTION_ENTRY();\r\nresource_length = (acpi_rs_length)\r\n(total_length - acpi_ut_get_resource_header_length(aml));\r\nif (aml->small_header.descriptor_type & ACPI_RESOURCE_NAME_LARGE) {\r\nACPI_MOVE_16_TO_16(&aml->large_header.resource_length,\r\n&resource_length);\r\n} else {\r\naml->small_header.descriptor_type = (u8)\r\n((aml->small_header.\r\ndescriptor_type & ~ACPI_RESOURCE_NAME_SMALL_LENGTH_MASK)\r\n| resource_length);\r\n}\r\n}\r\nvoid\r\nacpi_rs_set_resource_header(u8 descriptor_type,\r\nacpi_rsdesc_size total_length,\r\nunion aml_resource *aml)\r\n{\r\nACPI_FUNCTION_ENTRY();\r\naml->small_header.descriptor_type = descriptor_type;\r\nacpi_rs_set_resource_length(total_length, aml);\r\n}\r\nstatic u16 acpi_rs_strcpy(char *destination, char *source)\r\n{\r\nu16 i;\r\nACPI_FUNCTION_ENTRY();\r\nfor (i = 0; source[i]; i++) {\r\ndestination[i] = source[i];\r\n}\r\ndestination[i] = 0;\r\nreturn ((u16) (i + 1));\r\n}\r\nacpi_rs_length\r\nacpi_rs_get_resource_source(acpi_rs_length resource_length,\r\nacpi_rs_length minimum_length,\r\nstruct acpi_resource_source * resource_source,\r\nunion aml_resource * aml, char *string_ptr)\r\n{\r\nacpi_rsdesc_size total_length;\r\nu8 *aml_resource_source;\r\nACPI_FUNCTION_ENTRY();\r\ntotal_length =\r\nresource_length + sizeof(struct aml_resource_large_header);\r\naml_resource_source = ACPI_ADD_PTR(u8, aml, minimum_length);\r\nif (total_length > (acpi_rsdesc_size) (minimum_length + 1)) {\r\nresource_source->index = aml_resource_source[0];\r\nresource_source->string_ptr = string_ptr;\r\nif (!string_ptr) {\r\nresource_source->string_ptr =\r\nACPI_ADD_PTR(char, resource_source,\r\nsizeof(struct acpi_resource_source));\r\n}\r\ntotal_length =\r\n(u32)strlen(ACPI_CAST_PTR(char, &aml_resource_source[1])) +\r\n1;\r\ntotal_length = (u32)ACPI_ROUND_UP_TO_NATIVE_WORD(total_length);\r\nmemset(resource_source->string_ptr, 0, total_length);\r\nresource_source->string_length =\r\nacpi_rs_strcpy(resource_source->string_ptr,\r\nACPI_CAST_PTR(char,\r\n&aml_resource_source[1]));\r\nreturn ((acpi_rs_length) total_length);\r\n}\r\nresource_source->index = 0;\r\nresource_source->string_length = 0;\r\nresource_source->string_ptr = NULL;\r\nreturn (0);\r\n}\r\nacpi_rsdesc_size\r\nacpi_rs_set_resource_source(union aml_resource * aml,\r\nacpi_rs_length minimum_length,\r\nstruct acpi_resource_source * resource_source)\r\n{\r\nu8 *aml_resource_source;\r\nacpi_rsdesc_size descriptor_length;\r\nACPI_FUNCTION_ENTRY();\r\ndescriptor_length = minimum_length;\r\nif (resource_source->string_length) {\r\naml_resource_source = ACPI_ADD_PTR(u8, aml, minimum_length);\r\naml_resource_source[0] = (u8) resource_source->index;\r\nstrcpy(ACPI_CAST_PTR(char, &aml_resource_source[1]),\r\nresource_source->string_ptr);\r\ndescriptor_length +=\r\n((acpi_rsdesc_size) resource_source->string_length + 1);\r\n}\r\nreturn (descriptor_length);\r\n}\r\nacpi_status\r\nacpi_rs_get_prt_method_data(struct acpi_namespace_node * node,\r\nstruct acpi_buffer * ret_buffer)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(rs_get_prt_method_data);\r\nstatus = acpi_ut_evaluate_object(node, METHOD_NAME__PRT,\r\nACPI_BTYPE_PACKAGE, &obj_desc);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = acpi_rs_create_pci_routing_table(obj_desc, ret_buffer);\r\nacpi_ut_remove_reference(obj_desc);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_rs_get_crs_method_data(struct acpi_namespace_node *node,\r\nstruct acpi_buffer *ret_buffer)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(rs_get_crs_method_data);\r\nstatus = acpi_ut_evaluate_object(node, METHOD_NAME__CRS,\r\nACPI_BTYPE_BUFFER, &obj_desc);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = acpi_rs_create_resource_list(obj_desc, ret_buffer);\r\nacpi_ut_remove_reference(obj_desc);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_rs_get_prs_method_data(struct acpi_namespace_node *node,\r\nstruct acpi_buffer *ret_buffer)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(rs_get_prs_method_data);\r\nstatus = acpi_ut_evaluate_object(node, METHOD_NAME__PRS,\r\nACPI_BTYPE_BUFFER, &obj_desc);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = acpi_rs_create_resource_list(obj_desc, ret_buffer);\r\nacpi_ut_remove_reference(obj_desc);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_rs_get_aei_method_data(struct acpi_namespace_node *node,\r\nstruct acpi_buffer *ret_buffer)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(rs_get_aei_method_data);\r\nstatus = acpi_ut_evaluate_object(node, METHOD_NAME__AEI,\r\nACPI_BTYPE_BUFFER, &obj_desc);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = acpi_rs_create_resource_list(obj_desc, ret_buffer);\r\nacpi_ut_remove_reference(obj_desc);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_rs_get_method_data(acpi_handle handle,\r\nchar *path, struct acpi_buffer *ret_buffer)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(rs_get_method_data);\r\nstatus =\r\nacpi_ut_evaluate_object(ACPI_CAST_PTR\r\n(struct acpi_namespace_node, handle), path,\r\nACPI_BTYPE_BUFFER, &obj_desc);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = acpi_rs_create_resource_list(obj_desc, ret_buffer);\r\nacpi_ut_remove_reference(obj_desc);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_rs_set_srs_method_data(struct acpi_namespace_node *node,\r\nstruct acpi_buffer *in_buffer)\r\n{\r\nstruct acpi_evaluate_info *info;\r\nunion acpi_operand_object *args[2];\r\nacpi_status status;\r\nstruct acpi_buffer buffer;\r\nACPI_FUNCTION_TRACE(rs_set_srs_method_data);\r\ninfo = ACPI_ALLOCATE_ZEROED(sizeof(struct acpi_evaluate_info));\r\nif (!info) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\ninfo->prefix_node = node;\r\ninfo->relative_pathname = METHOD_NAME__SRS;\r\ninfo->parameters = args;\r\ninfo->flags = ACPI_IGNORE_RETURN_VALUE;\r\nbuffer.length = ACPI_ALLOCATE_LOCAL_BUFFER;\r\nstatus = acpi_rs_create_aml_resources(in_buffer, &buffer);\r\nif (ACPI_FAILURE(status)) {\r\ngoto cleanup;\r\n}\r\nargs[0] = acpi_ut_create_internal_object(ACPI_TYPE_BUFFER);\r\nif (!args[0]) {\r\nACPI_FREE(buffer.pointer);\r\nstatus = AE_NO_MEMORY;\r\ngoto cleanup;\r\n}\r\nargs[0]->buffer.length = (u32) buffer.length;\r\nargs[0]->buffer.pointer = buffer.pointer;\r\nargs[0]->common.flags = AOPOBJ_DATA_VALID;\r\nargs[1] = NULL;\r\nstatus = acpi_ns_evaluate(info);\r\nacpi_ut_remove_reference(args[0]);\r\ncleanup:\r\nACPI_FREE(info);\r\nreturn_ACPI_STATUS(status);\r\n}

void lubbock_set_hexled(uint32_t value)\r\n{\r\nLUB_HEXLED = value;\r\n}\r\nvoid lubbock_set_misc_wr(unsigned int mask, unsigned int set)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nLUB_MISC_WR = (LUB_MISC_WR & ~mask) | (set & mask);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic int lubbock_udc_is_connected(void)\r\n{\r\nreturn (LUB_MISC_RD & (1 << 9)) == 0;\r\n}\r\nstatic int lubbock_ads7846_pendown_state(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void ads7846_cs(u32 command)\r\n{\r\nstatic const unsigned TS_nCS = 1 << 11;\r\nlubbock_set_misc_wr(TS_nCS, (command == PXA2XX_CS_ASSERT) ? 0 : TS_nCS);\r\n}\r\nstatic void lubbock_mmc_poll(unsigned long data)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nLUB_IRQ_SET_CLR &= ~(1 << 0);\r\nlocal_irq_restore(flags);\r\nif (LUB_IRQ_SET_CLR & (1 << 0))\r\nmod_timer(&mmc_timer, jiffies + MMC_POLL_RATE);\r\nelse {\r\n(void) mmc_detect_int(LUBBOCK_SD_IRQ, (void *)data);\r\nenable_irq(LUBBOCK_SD_IRQ);\r\n}\r\n}\r\nstatic irqreturn_t lubbock_detect_int(int irq, void *data)\r\n{\r\ndisable_irq(irq);\r\nmod_timer(&mmc_timer, jiffies + MMC_POLL_RATE);\r\nreturn mmc_detect_int(irq, data);\r\n}\r\nstatic int lubbock_mci_init(struct device *dev,\r\nirq_handler_t detect_int,\r\nvoid *data)\r\n{\r\nmmc_detect_int = detect_int;\r\ninit_timer(&mmc_timer);\r\nmmc_timer.data = (unsigned long) data;\r\nreturn request_irq(LUBBOCK_SD_IRQ, lubbock_detect_int,\r\n0, "lubbock-sd-detect", data);\r\n}\r\nstatic int lubbock_mci_get_ro(struct device *dev)\r\n{\r\nreturn (LUB_MISC_RD & (1 << 2)) != 0;\r\n}\r\nstatic void lubbock_mci_exit(struct device *dev, void *data)\r\n{\r\nfree_irq(LUBBOCK_SD_IRQ, data);\r\ndel_timer_sync(&mmc_timer);\r\n}\r\nstatic void lubbock_irda_transceiver_mode(struct device *dev, int mode)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nif (mode & IR_SIRMODE) {\r\nLUB_MISC_WR &= ~(1 << 4);\r\n} else if (mode & IR_FIRMODE) {\r\nLUB_MISC_WR |= 1 << 4;\r\n}\r\npxa2xx_transceiver_mode(dev, mode);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void __init lubbock_init(void)\r\n{\r\nint flashboot = (LUB_CONF_SWITCHES & 1);\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(lubbock_pin_config));\r\npxa_set_ffuart_info(NULL);\r\npxa_set_btuart_info(NULL);\r\npxa_set_stuart_info(NULL);\r\nclk_add_alias("SA1111_CLK", NULL, "GPIO11_CLK", NULL);\r\npxa_set_udc_info(&udc_info);\r\npxa_set_fb_info(NULL, &sharp_lm8v31);\r\npxa_set_mci_info(&lubbock_mci_platform_data);\r\npxa_set_ficp_info(&lubbock_ficp_platform_data);\r\npxa_set_ac97_info(NULL);\r\nlubbock_flash_data[0].width = lubbock_flash_data[1].width =\r\n(__raw_readl(BOOT_DEF) & 1) ? 2 : 4;\r\nprintk(KERN_NOTICE "Lubbock configured to boot from %s (bank %d)\n",\r\nflashboot?"Flash":"ROM", flashboot);\r\nlubbock_flash_data[flashboot^1].name = "application-flash";\r\nlubbock_flash_data[flashboot].name = "boot-rom";\r\n(void) platform_add_devices(devices, ARRAY_SIZE(devices));\r\npxa2xx_set_spi_info(1, &pxa_ssp_master_info);\r\nspi_register_board_info(spi_board_info, ARRAY_SIZE(spi_board_info));\r\n}\r\nstatic void __init lubbock_map_io(void)\r\n{\r\npxa25x_map_io();\r\niotable_init(lubbock_io_desc, ARRAY_SIZE(lubbock_io_desc));\r\nPCFR |= PCFR_OPDE;\r\n}\r\nstatic void lubbock_led_set(struct led_classdev *cdev,\r\nenum led_brightness b)\r\n{\r\nstruct lubbock_led *led = container_of(cdev,\r\nstruct lubbock_led, cdev);\r\nu32 reg = LUB_DISC_BLNK_LED;\r\nif (b != LED_OFF)\r\nreg |= led->mask;\r\nelse\r\nreg &= ~led->mask;\r\nLUB_DISC_BLNK_LED = reg;\r\n}\r\nstatic enum led_brightness lubbock_led_get(struct led_classdev *cdev)\r\n{\r\nstruct lubbock_led *led = container_of(cdev,\r\nstruct lubbock_led, cdev);\r\nu32 reg = LUB_DISC_BLNK_LED;\r\nreturn (reg & led->mask) ? LED_FULL : LED_OFF;\r\n}\r\nstatic int __init lubbock_leds_init(void)\r\n{\r\nint i;\r\nif (!machine_is_lubbock())\r\nreturn -ENODEV;\r\nLUB_DISC_BLNK_LED |= 0xff;\r\nfor (i = 0; i < ARRAY_SIZE(lubbock_leds); i++) {\r\nstruct lubbock_led *led;\r\nled = kzalloc(sizeof(*led), GFP_KERNEL);\r\nif (!led)\r\nbreak;\r\nled->cdev.name = lubbock_leds[i].name;\r\nled->cdev.brightness_set = lubbock_led_set;\r\nled->cdev.brightness_get = lubbock_led_get;\r\nled->cdev.default_trigger = lubbock_leds[i].trigger;\r\nled->mask = BIT(i);\r\nif (led_classdev_register(NULL, &led->cdev) < 0) {\r\nkfree(led);\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}

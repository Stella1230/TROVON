static int dvb_usb_v2_generic_io(struct dvb_usb_device *d,\r\nu8 *wbuf, u16 wlen, u8 *rbuf, u16 rlen)\r\n{\r\nint ret, actual_length;\r\nif (!wbuf || !wlen || !d->props->generic_bulk_ctrl_endpoint ||\r\n!d->props->generic_bulk_ctrl_endpoint_response) {\r\ndev_dbg(&d->udev->dev, "%s: failed=%d\n", __func__, -EINVAL);\r\nreturn -EINVAL;\r\n}\r\ndev_dbg(&d->udev->dev, "%s: >>> %*ph\n", __func__, wlen, wbuf);\r\nret = usb_bulk_msg(d->udev, usb_sndbulkpipe(d->udev,\r\nd->props->generic_bulk_ctrl_endpoint), wbuf, wlen,\r\n&actual_length, 2000);\r\nif (ret < 0)\r\ndev_err(&d->udev->dev, "%s: usb_bulk_msg() failed=%d\n",\r\nKBUILD_MODNAME, ret);\r\nelse\r\nret = actual_length != wlen ? -EIO : 0;\r\nif (!ret && rbuf && rlen) {\r\nif (d->props->generic_bulk_ctrl_delay)\r\nusleep_range(d->props->generic_bulk_ctrl_delay,\r\nd->props->generic_bulk_ctrl_delay\r\n+ 20000);\r\nret = usb_bulk_msg(d->udev, usb_rcvbulkpipe(d->udev,\r\nd->props->generic_bulk_ctrl_endpoint_response),\r\nrbuf, rlen, &actual_length, 2000);\r\nif (ret)\r\ndev_err(&d->udev->dev,\r\n"%s: 2nd usb_bulk_msg() failed=%d\n",\r\nKBUILD_MODNAME, ret);\r\ndev_dbg(&d->udev->dev, "%s: <<< %*ph\n", __func__,\r\nactual_length, rbuf);\r\n}\r\nreturn ret;\r\n}\r\nint dvb_usbv2_generic_rw(struct dvb_usb_device *d,\r\nu8 *wbuf, u16 wlen, u8 *rbuf, u16 rlen)\r\n{\r\nint ret;\r\nmutex_lock(&d->usb_mutex);\r\nret = dvb_usb_v2_generic_io(d, wbuf, wlen, rbuf, rlen);\r\nmutex_unlock(&d->usb_mutex);\r\nreturn ret;\r\n}\r\nint dvb_usbv2_generic_write(struct dvb_usb_device *d, u8 *buf, u16 len)\r\n{\r\nint ret;\r\nmutex_lock(&d->usb_mutex);\r\nret = dvb_usb_v2_generic_io(d, buf, len, NULL, 0);\r\nmutex_unlock(&d->usb_mutex);\r\nreturn ret;\r\n}\r\nint dvb_usbv2_generic_rw_locked(struct dvb_usb_device *d,\r\nu8 *wbuf, u16 wlen, u8 *rbuf, u16 rlen)\r\n{\r\nreturn dvb_usb_v2_generic_io(d, wbuf, wlen, rbuf, rlen);\r\n}\r\nint dvb_usbv2_generic_write_locked(struct dvb_usb_device *d, u8 *buf, u16 len)\r\n{\r\nreturn dvb_usb_v2_generic_io(d, buf, len, NULL, 0);\r\n}

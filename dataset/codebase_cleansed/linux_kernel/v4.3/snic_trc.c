struct snic_trc_data *\r\nsnic_get_trc_buf(void)\r\n{\r\nstruct snic_trc *trc = &snic_glob->trc;\r\nstruct snic_trc_data *td = NULL;\r\nunsigned long flags;\r\nspin_lock_irqsave(&trc->lock, flags);\r\ntd = &trc->buf[trc->wr_idx];\r\ntrc->wr_idx++;\r\nif (trc->wr_idx == trc->max_idx)\r\ntrc->wr_idx = 0;\r\nif (trc->wr_idx != trc->rd_idx) {\r\nspin_unlock_irqrestore(&trc->lock, flags);\r\ngoto end;\r\n}\r\ntrc->rd_idx++;\r\nif (trc->rd_idx == trc->max_idx)\r\ntrc->rd_idx = 0;\r\ntd->ts = 0;\r\nspin_unlock_irqrestore(&trc->lock, flags);\r\nend:\r\nreturn td;\r\n}\r\nstatic int\r\nsnic_fmt_trc_data(struct snic_trc_data *td, char *buf, int buf_sz)\r\n{\r\nint len = 0;\r\nstruct timespec tmspec;\r\njiffies_to_timespec(td->ts, &tmspec);\r\nlen += snprintf(buf, buf_sz,\r\n"%lu.%10lu %-25s %3d %4x %16llx %16llx %16llx %16llx %16llx\n",\r\ntmspec.tv_sec,\r\ntmspec.tv_nsec,\r\ntd->fn,\r\ntd->hno,\r\ntd->tag,\r\ntd->data[0], td->data[1], td->data[2], td->data[3],\r\ntd->data[4]);\r\nreturn len;\r\n}\r\nint\r\nsnic_get_trc_data(char *buf, int buf_sz)\r\n{\r\nstruct snic_trc_data *td = NULL;\r\nstruct snic_trc *trc = &snic_glob->trc;\r\nunsigned long flags;\r\nspin_lock_irqsave(&trc->lock, flags);\r\nif (trc->rd_idx == trc->wr_idx) {\r\nspin_unlock_irqrestore(&trc->lock, flags);\r\nreturn -1;\r\n}\r\ntd = &trc->buf[trc->rd_idx];\r\nif (td->ts == 0) {\r\nspin_unlock_irqrestore(&trc->lock, flags);\r\nreturn -1;\r\n}\r\ntrc->rd_idx++;\r\nif (trc->rd_idx == trc->max_idx)\r\ntrc->rd_idx = 0;\r\nspin_unlock_irqrestore(&trc->lock, flags);\r\nreturn snic_fmt_trc_data(td, buf, buf_sz);\r\n}\r\nint\r\nsnic_trc_init(void)\r\n{\r\nstruct snic_trc *trc = &snic_glob->trc;\r\nvoid *tbuf = NULL;\r\nint tbuf_sz = 0, ret;\r\ntbuf_sz = (snic_trace_max_pages * PAGE_SIZE);\r\ntbuf = vmalloc(tbuf_sz);\r\nif (!tbuf) {\r\nSNIC_ERR("Failed to Allocate Trace Buffer Size. %d\n", tbuf_sz);\r\nSNIC_ERR("Trace Facility not enabled.\n");\r\nret = -ENOMEM;\r\nreturn ret;\r\n}\r\nmemset(tbuf, 0, tbuf_sz);\r\ntrc->buf = (struct snic_trc_data *) tbuf;\r\nspin_lock_init(&trc->lock);\r\nret = snic_trc_debugfs_init();\r\nif (ret) {\r\nSNIC_ERR("Failed to create Debugfs Files.\n");\r\ngoto error;\r\n}\r\ntrc->max_idx = (tbuf_sz / SNIC_TRC_ENTRY_SZ);\r\ntrc->rd_idx = trc->wr_idx = 0;\r\ntrc->enable = 1;\r\nSNIC_INFO("Trace Facility Enabled.\n Trace Buffer SZ %lu Pages.\n",\r\ntbuf_sz / PAGE_SIZE);\r\nret = 0;\r\nreturn ret;\r\nerror:\r\nsnic_trc_free();\r\nreturn ret;\r\n}\r\nvoid\r\nsnic_trc_free(void)\r\n{\r\nstruct snic_trc *trc = &snic_glob->trc;\r\ntrc->enable = 0;\r\nsnic_trc_debugfs_term();\r\nif (trc->buf) {\r\nvfree(trc->buf);\r\ntrc->buf = NULL;\r\n}\r\nSNIC_INFO("Trace Facility Disabled.\n");\r\n}

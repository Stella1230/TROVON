static int __init find_ibft_in_mem(void)\r\n{\r\nunsigned long pos;\r\nunsigned int len = 0;\r\nvoid *virt;\r\nint i;\r\nfor (pos = IBFT_START; pos < IBFT_END; pos += 16) {\r\nif (pos == VGA_MEM)\r\npos += VGA_SIZE;\r\nvirt = isa_bus_to_virt(pos);\r\nfor (i = 0; i < ARRAY_SIZE(ibft_signs); i++) {\r\nif (memcmp(virt, ibft_signs[i].sign, IBFT_SIGN_LEN) ==\r\n0) {\r\nunsigned long *addr =\r\n(unsigned long *)isa_bus_to_virt(pos + 4);\r\nlen = *addr;\r\nif (pos + len <= (IBFT_END-1)) {\r\nibft_addr = (struct acpi_table_ibft *)virt;\r\npr_info("iBFT found at 0x%lx.\n", pos);\r\ngoto done;\r\n}\r\n}\r\n}\r\n}\r\ndone:\r\nreturn len;\r\n}\r\nunsigned long __init find_ibft_region(unsigned long *sizep)\r\n{\r\nibft_addr = NULL;\r\nif (!efi_enabled(EFI_BOOT))\r\nfind_ibft_in_mem();\r\nif (ibft_addr) {\r\n*sizep = PAGE_ALIGN(ibft_addr->header.length);\r\nreturn (u64)isa_virt_to_bus(ibft_addr);\r\n}\r\n*sizep = 0;\r\nreturn 0;\r\n}

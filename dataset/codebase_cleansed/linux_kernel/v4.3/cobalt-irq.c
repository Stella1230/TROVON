static void cobalt_dma_stream_queue_handler(struct cobalt_stream *s)\r\n{\r\nstruct cobalt *cobalt = s->cobalt;\r\nint rx = s->video_channel;\r\nstruct m00473_freewheel_regmap __iomem *fw =\r\nCOBALT_CVI_FREEWHEEL(s->cobalt, rx);\r\nstruct m00233_video_measure_regmap __iomem *vmr =\r\nCOBALT_CVI_VMR(s->cobalt, rx);\r\nstruct m00389_cvi_regmap __iomem *cvi =\r\nCOBALT_CVI(s->cobalt, rx);\r\nstruct m00479_clk_loss_detector_regmap __iomem *clkloss =\r\nCOBALT_CVI_CLK_LOSS(s->cobalt, rx);\r\nstruct cobalt_buffer *cb;\r\nbool skip = false;\r\nspin_lock(&s->irqlock);\r\nif (list_empty(&s->bufs)) {\r\npr_err("no buffers!\n");\r\nspin_unlock(&s->irqlock);\r\nreturn;\r\n}\r\ncb = list_first_entry(&s->bufs, struct cobalt_buffer, list);\r\nlist_del(&cb->list);\r\nspin_unlock(&s->irqlock);\r\nif (s->is_audio || s->is_output)\r\ngoto done;\r\nif (s->unstable_frame) {\r\nuint32_t stat = ioread32(&vmr->irq_status);\r\niowrite32(stat, &vmr->irq_status);\r\nif (!(ioread32(&vmr->status) &\r\nM00233_STATUS_BITMAP_INIT_DONE_MSK)) {\r\ncobalt_dbg(1, "!init_done\n");\r\nif (s->enable_freewheel)\r\ngoto restart_fw;\r\ngoto done;\r\n}\r\nif (ioread32(&clkloss->status) &\r\nM00479_STATUS_BITMAP_CLOCK_MISSING_MSK) {\r\niowrite32(0, &clkloss->ctrl);\r\niowrite32(M00479_CTRL_BITMAP_ENABLE_MSK, &clkloss->ctrl);\r\ncobalt_dbg(1, "no clock\n");\r\nif (s->enable_freewheel)\r\ngoto restart_fw;\r\ngoto done;\r\n}\r\nif ((stat & (M00233_IRQ_STATUS_BITMAP_VACTIVE_AREA_MSK |\r\nM00233_IRQ_STATUS_BITMAP_HACTIVE_AREA_MSK)) ||\r\nioread32(&vmr->vactive_area) != s->timings.bt.height ||\r\nioread32(&vmr->hactive_area) != s->timings.bt.width) {\r\ncobalt_dbg(1, "unstable\n");\r\nif (s->enable_freewheel)\r\ngoto restart_fw;\r\ngoto done;\r\n}\r\nif (!s->enable_cvi) {\r\ns->enable_cvi = true;\r\niowrite32(M00389_CONTROL_BITMAP_ENABLE_MSK, &cvi->control);\r\ngoto done;\r\n}\r\nif (!(ioread32(&cvi->status) & M00389_STATUS_BITMAP_LOCK_MSK)) {\r\ncobalt_dbg(1, "cvi no lock\n");\r\nif (s->enable_freewheel)\r\ngoto restart_fw;\r\ngoto done;\r\n}\r\nif (!s->enable_freewheel) {\r\ncobalt_dbg(1, "stable\n");\r\ns->enable_freewheel = true;\r\niowrite32(0, &fw->ctrl);\r\ngoto done;\r\n}\r\ncobalt_dbg(1, "enabled fw\n");\r\niowrite32(M00233_CONTROL_BITMAP_ENABLE_MEASURE_MSK |\r\nM00233_CONTROL_BITMAP_ENABLE_INTERRUPT_MSK,\r\n&vmr->control);\r\niowrite32(M00473_CTRL_BITMAP_ENABLE_MSK, &fw->ctrl);\r\ns->enable_freewheel = false;\r\ns->unstable_frame = false;\r\ns->skip_first_frames = 2;\r\nskip = true;\r\ngoto done;\r\n}\r\nif (ioread32(&fw->status) & M00473_STATUS_BITMAP_FREEWHEEL_MODE_MSK) {\r\nrestart_fw:\r\ncobalt_dbg(1, "lost lock\n");\r\niowrite32(M00233_CONTROL_BITMAP_ENABLE_MEASURE_MSK,\r\n&vmr->control);\r\niowrite32(M00473_CTRL_BITMAP_ENABLE_MSK |\r\nM00473_CTRL_BITMAP_FORCE_FREEWHEEL_MODE_MSK,\r\n&fw->ctrl);\r\niowrite32(0, &cvi->control);\r\ns->unstable_frame = true;\r\ns->enable_freewheel = false;\r\ns->enable_cvi = false;\r\n}\r\ndone:\r\nif (s->skip_first_frames) {\r\nskip = true;\r\ns->skip_first_frames--;\r\n}\r\nv4l2_get_timestamp(&cb->vb.v4l2_buf.timestamp);\r\ncb->vb.v4l2_buf.sequence = s->sequence++;\r\nvb2_buffer_done(&cb->vb, (skip || s->unstable_frame) ?\r\nVB2_BUF_STATE_REQUEUEING : VB2_BUF_STATE_DONE);\r\n}\r\nirqreturn_t cobalt_irq_handler(int irq, void *dev_id)\r\n{\r\nstruct cobalt *cobalt = (struct cobalt *)dev_id;\r\nu32 dma_interrupt =\r\ncobalt_read_bar0(cobalt, DMA_INTERRUPT_STATUS_REG) & 0xffff;\r\nu32 mask = cobalt_read_bar1(cobalt, COBALT_SYS_STAT_MASK);\r\nu32 edge = cobalt_read_bar1(cobalt, COBALT_SYS_STAT_EDGE);\r\nint i;\r\ncobalt_write_bar0(cobalt, DMA_INTERRUPT_STATUS_REG, dma_interrupt);\r\ncobalt_write_bar1(cobalt, COBALT_SYS_STAT_MASK, mask & ~edge);\r\ncobalt_write_bar1(cobalt, COBALT_SYS_STAT_EDGE, edge);\r\nfor (i = 0; i < COBALT_NUM_STREAMS; i++) {\r\nstruct cobalt_stream *s = &cobalt->streams[i];\r\nunsigned dma_fifo_mask = s->dma_fifo_mask;\r\nif (dma_interrupt & (1 << s->dma_channel)) {\r\ncobalt->irq_dma[i]++;\r\ncobalt_dma_stream_queue_handler(s);\r\nif (!s->is_audio) {\r\nedge &= ~dma_fifo_mask;\r\ncobalt_write_bar1(cobalt, COBALT_SYS_STAT_MASK,\r\nmask & ~edge);\r\n}\r\n}\r\nif (s->is_audio)\r\ncontinue;\r\nif (edge & s->adv_irq_mask)\r\nset_bit(COBALT_STREAM_FL_ADV_IRQ, &s->flags);\r\nif ((edge & mask & dma_fifo_mask) && vb2_is_streaming(&s->q)) {\r\ncobalt_info("full rx FIFO %d\n", i);\r\ncobalt->irq_full_fifo++;\r\n}\r\n}\r\nqueue_work(cobalt->irq_work_queues, &cobalt->irq_work_queue);\r\nif (edge & mask & (COBALT_SYSSTAT_VI0_INT1_MSK |\r\nCOBALT_SYSSTAT_VI1_INT1_MSK |\r\nCOBALT_SYSSTAT_VI2_INT1_MSK |\r\nCOBALT_SYSSTAT_VI3_INT1_MSK |\r\nCOBALT_SYSSTAT_VIHSMA_INT1_MSK |\r\nCOBALT_SYSSTAT_VOHSMA_INT1_MSK))\r\ncobalt->irq_adv1++;\r\nif (edge & mask & (COBALT_SYSSTAT_VI0_INT2_MSK |\r\nCOBALT_SYSSTAT_VI1_INT2_MSK |\r\nCOBALT_SYSSTAT_VI2_INT2_MSK |\r\nCOBALT_SYSSTAT_VI3_INT2_MSK |\r\nCOBALT_SYSSTAT_VIHSMA_INT2_MSK))\r\ncobalt->irq_adv2++;\r\nif (edge & mask & COBALT_SYSSTAT_VOHSMA_INT1_MSK)\r\ncobalt->irq_advout++;\r\nif (dma_interrupt)\r\ncobalt->irq_dma_tot++;\r\nif (!(edge & mask) && !dma_interrupt)\r\ncobalt->irq_none++;\r\ndma_interrupt = cobalt_read_bar0(cobalt, DMA_INTERRUPT_STATUS_REG);\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid cobalt_irq_work_handler(struct work_struct *work)\r\n{\r\nstruct cobalt *cobalt =\r\ncontainer_of(work, struct cobalt, irq_work_queue);\r\nint i;\r\nfor (i = 0; i < COBALT_NUM_NODES; i++) {\r\nstruct cobalt_stream *s = &cobalt->streams[i];\r\nif (test_and_clear_bit(COBALT_STREAM_FL_ADV_IRQ, &s->flags)) {\r\nu32 mask;\r\nv4l2_subdev_call(cobalt->streams[i].sd, core,\r\ninterrupt_service_routine, 0, NULL);\r\nmask = cobalt_read_bar1(cobalt, COBALT_SYS_STAT_MASK);\r\ncobalt_write_bar1(cobalt, COBALT_SYS_STAT_MASK,\r\nmask | s->adv_irq_mask);\r\n}\r\n}\r\n}\r\nvoid cobalt_irq_log_status(struct cobalt *cobalt)\r\n{\r\nu32 mask;\r\nint i;\r\ncobalt_info("irq: adv1=%u adv2=%u advout=%u none=%u full=%u\n",\r\ncobalt->irq_adv1, cobalt->irq_adv2, cobalt->irq_advout,\r\ncobalt->irq_none, cobalt->irq_full_fifo);\r\ncobalt_info("irq: dma_tot=%u (", cobalt->irq_dma_tot);\r\nfor (i = 0; i < COBALT_NUM_STREAMS; i++)\r\npr_cont("%s%u", i ? "/" : "", cobalt->irq_dma[i]);\r\npr_cont(")\n");\r\ncobalt->irq_dma_tot = cobalt->irq_adv1 = cobalt->irq_adv2 = 0;\r\ncobalt->irq_advout = cobalt->irq_none = cobalt->irq_full_fifo = 0;\r\nmemset(cobalt->irq_dma, 0, sizeof(cobalt->irq_dma));\r\nmask = cobalt_read_bar1(cobalt, COBALT_SYS_STAT_MASK);\r\ncobalt_write_bar1(cobalt, COBALT_SYS_STAT_MASK,\r\nmask |\r\nCOBALT_SYSSTAT_VI0_LOST_DATA_MSK |\r\nCOBALT_SYSSTAT_VI1_LOST_DATA_MSK |\r\nCOBALT_SYSSTAT_VI2_LOST_DATA_MSK |\r\nCOBALT_SYSSTAT_VI3_LOST_DATA_MSK |\r\nCOBALT_SYSSTAT_VIHSMA_LOST_DATA_MSK |\r\nCOBALT_SYSSTAT_VOHSMA_LOST_DATA_MSK |\r\nCOBALT_SYSSTAT_AUD_IN_LOST_DATA_MSK |\r\nCOBALT_SYSSTAT_AUD_OUT_LOST_DATA_MSK);\r\n}

static irqreturn_t pxa930_trkball_interrupt(int irq, void *dev_id)\r\n{\r\nstruct pxa930_trkball *trkball = dev_id;\r\nstruct input_dev *input = trkball->input;\r\nint tbcntr, x, y;\r\ntbcntr = __raw_readl(trkball->mmio_base + TBCNTR);\r\nif (tbcntr == __raw_readl(trkball->mmio_base + TBCNTR)) {\r\nx = (TBCNTR_XP(tbcntr) - TBCNTR_XM(tbcntr)) / 2;\r\ny = (TBCNTR_YP(tbcntr) - TBCNTR_YM(tbcntr)) / 2;\r\ninput_report_rel(input, REL_X, x);\r\ninput_report_rel(input, REL_Y, y);\r\ninput_sync(input);\r\n}\r\n__raw_writel(TBSBC_TBSBC, trkball->mmio_base + TBSBC);\r\n__raw_writel(0, trkball->mmio_base + TBSBC);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int write_tbcr(struct pxa930_trkball *trkball, int v)\r\n{\r\nint i = 100;\r\n__raw_writel(v, trkball->mmio_base + TBCR);\r\nwhile (--i) {\r\nif (__raw_readl(trkball->mmio_base + TBCR) == v)\r\nbreak;\r\nmsleep(1);\r\n}\r\nif (i == 0) {\r\npr_err("%s: timed out writing TBCR(%x)!\n", __func__, v);\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic void pxa930_trkball_config(struct pxa930_trkball *trkball)\r\n{\r\nuint32_t tbcr;\r\ntbcr = __raw_readl(trkball->mmio_base + TBCR);\r\nwrite_tbcr(trkball, tbcr | TBCR_X_FLT(0xf) | TBCR_Y_FLT(0xf));\r\nwrite_tbcr(trkball, TBCR_X_FLT(trkball->pdata->x_filter) |\r\nTBCR_Y_FLT(trkball->pdata->y_filter));\r\ntbcr = __raw_readl(trkball->mmio_base + TBCR);\r\nwrite_tbcr(trkball, tbcr | TBCR_TBRST);\r\nwrite_tbcr(trkball, tbcr & ~TBCR_TBRST);\r\n__raw_writel(TBSBC_TBSBC, trkball->mmio_base + TBSBC);\r\n__raw_writel(0, trkball->mmio_base + TBSBC);\r\npr_debug("%s: final TBCR=%x!\n", __func__,\r\n__raw_readl(trkball->mmio_base + TBCR));\r\n}\r\nstatic int pxa930_trkball_open(struct input_dev *dev)\r\n{\r\nstruct pxa930_trkball *trkball = input_get_drvdata(dev);\r\npxa930_trkball_config(trkball);\r\nreturn 0;\r\n}\r\nstatic void pxa930_trkball_disable(struct pxa930_trkball *trkball)\r\n{\r\nuint32_t tbcr = __raw_readl(trkball->mmio_base + TBCR);\r\nwrite_tbcr(trkball, tbcr | TBCR_TBRST);\r\n}\r\nstatic void pxa930_trkball_close(struct input_dev *dev)\r\n{\r\nstruct pxa930_trkball *trkball = input_get_drvdata(dev);\r\npxa930_trkball_disable(trkball);\r\n}\r\nstatic int pxa930_trkball_probe(struct platform_device *pdev)\r\n{\r\nstruct pxa930_trkball *trkball;\r\nstruct input_dev *input;\r\nstruct resource *res;\r\nint irq, error;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "failed to get trkball irq\n");\r\nreturn -ENXIO;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "failed to get register memory\n");\r\nreturn -ENXIO;\r\n}\r\ntrkball = kzalloc(sizeof(struct pxa930_trkball), GFP_KERNEL);\r\nif (!trkball)\r\nreturn -ENOMEM;\r\ntrkball->pdata = dev_get_platdata(&pdev->dev);\r\nif (!trkball->pdata) {\r\ndev_err(&pdev->dev, "no platform data defined\n");\r\nerror = -EINVAL;\r\ngoto failed;\r\n}\r\ntrkball->mmio_base = ioremap_nocache(res->start, resource_size(res));\r\nif (!trkball->mmio_base) {\r\ndev_err(&pdev->dev, "failed to ioremap registers\n");\r\nerror = -ENXIO;\r\ngoto failed;\r\n}\r\npxa930_trkball_disable(trkball);\r\nerror = request_irq(irq, pxa930_trkball_interrupt, 0,\r\npdev->name, trkball);\r\nif (error) {\r\ndev_err(&pdev->dev, "failed to request irq: %d\n", error);\r\ngoto failed_free_io;\r\n}\r\nplatform_set_drvdata(pdev, trkball);\r\ninput = input_allocate_device();\r\nif (!input) {\r\ndev_err(&pdev->dev, "failed to allocate input device\n");\r\nerror = -ENOMEM;\r\ngoto failed_free_irq;\r\n}\r\ninput->name = pdev->name;\r\ninput->id.bustype = BUS_HOST;\r\ninput->open = pxa930_trkball_open;\r\ninput->close = pxa930_trkball_close;\r\ninput->dev.parent = &pdev->dev;\r\ninput_set_drvdata(input, trkball);\r\ntrkball->input = input;\r\ninput_set_capability(input, EV_REL, REL_X);\r\ninput_set_capability(input, EV_REL, REL_Y);\r\nerror = input_register_device(input);\r\nif (error) {\r\ndev_err(&pdev->dev, "unable to register input device\n");\r\ngoto failed_free_input;\r\n}\r\nreturn 0;\r\nfailed_free_input:\r\ninput_free_device(input);\r\nfailed_free_irq:\r\nfree_irq(irq, trkball);\r\nfailed_free_io:\r\niounmap(trkball->mmio_base);\r\nfailed:\r\nkfree(trkball);\r\nreturn error;\r\n}\r\nstatic int pxa930_trkball_remove(struct platform_device *pdev)\r\n{\r\nstruct pxa930_trkball *trkball = platform_get_drvdata(pdev);\r\nint irq = platform_get_irq(pdev, 0);\r\ninput_unregister_device(trkball->input);\r\nfree_irq(irq, trkball);\r\niounmap(trkball->mmio_base);\r\nkfree(trkball);\r\nreturn 0;\r\n}

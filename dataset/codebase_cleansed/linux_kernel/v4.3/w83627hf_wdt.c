static void superio_outb(int reg, int val)\r\n{\r\noutb(reg, WDT_EFER);\r\noutb(val, WDT_EFDR);\r\n}\r\nstatic inline int superio_inb(int reg)\r\n{\r\noutb(reg, WDT_EFER);\r\nreturn inb(WDT_EFDR);\r\n}\r\nstatic int superio_enter(void)\r\n{\r\nif (!request_muxed_region(wdt_io, 2, WATCHDOG_NAME))\r\nreturn -EBUSY;\r\noutb_p(0x87, WDT_EFER);\r\noutb_p(0x87, WDT_EFER);\r\nreturn 0;\r\n}\r\nstatic void superio_select(int ld)\r\n{\r\nsuperio_outb(0x07, ld);\r\n}\r\nstatic void superio_exit(void)\r\n{\r\noutb_p(0xAA, WDT_EFER);\r\nrelease_region(wdt_io, 2);\r\n}\r\nstatic int w83627hf_init(struct watchdog_device *wdog, enum chips chip)\r\n{\r\nint ret;\r\nunsigned char t;\r\nret = superio_enter();\r\nif (ret)\r\nreturn ret;\r\nsuperio_select(W83627HF_LD_WDT);\r\nt = superio_inb(0x30);\r\nif (!(t & 0x01))\r\nsuperio_outb(0x30, t | 0x01);\r\nswitch (chip) {\r\ncase w83627hf:\r\ncase w83627s:\r\nt = superio_inb(0x2B) & ~0x10;\r\nsuperio_outb(0x2B, t);\r\nbreak;\r\ncase w83697hf:\r\nt = superio_inb(0x29) & ~0x60;\r\nt |= 0x20;\r\nsuperio_outb(0x29, t);\r\nbreak;\r\ncase w83697ug:\r\nt = superio_inb(0x2b) & ~0x04;\r\nsuperio_outb(0x2b, t);\r\nbreak;\r\ncase w83627thf:\r\nt = (superio_inb(0x2B) & ~0x08) | 0x04;\r\nsuperio_outb(0x2B, t);\r\nbreak;\r\ncase w83627dhg:\r\ncase w83627dhg_p:\r\nt = superio_inb(0x2D) & ~0x01;\r\nsuperio_outb(0x2D, t);\r\nt = superio_inb(cr_wdt_control);\r\nt |= 0x02;\r\nsuperio_outb(cr_wdt_control, t);\r\nbreak;\r\ncase w83637hf:\r\nbreak;\r\ncase w83687thf:\r\nt = superio_inb(0x2C) & ~0x80;\r\nsuperio_outb(0x2C, t);\r\nbreak;\r\ncase w83627ehf:\r\ncase w83627uhg:\r\ncase w83667hg:\r\ncase w83667hg_b:\r\ncase nct6775:\r\ncase nct6776:\r\ncase nct6779:\r\ncase nct6791:\r\ncase nct6792:\r\nt = superio_inb(cr_wdt_control);\r\nt |= 0x02;\r\nsuperio_outb(cr_wdt_control, t);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nt = superio_inb(cr_wdt_timeout);\r\nif (t != 0) {\r\nif (early_disable) {\r\npr_warn("Stopping previously enabled watchdog until userland kicks in\n");\r\nsuperio_outb(cr_wdt_timeout, 0);\r\n} else {\r\npr_info("Watchdog already running. Resetting timeout to %d sec\n",\r\nwdog->timeout);\r\nsuperio_outb(cr_wdt_timeout, wdog->timeout);\r\n}\r\n}\r\nt = superio_inb(cr_wdt_control) & ~0x0C;\r\nsuperio_outb(cr_wdt_control, t);\r\nt = superio_inb(0xF7) & ~0xD0;\r\nsuperio_outb(0xF7, t);\r\nsuperio_exit();\r\nreturn 0;\r\n}\r\nstatic int wdt_set_time(unsigned int timeout)\r\n{\r\nint ret;\r\nret = superio_enter();\r\nif (ret)\r\nreturn ret;\r\nsuperio_select(W83627HF_LD_WDT);\r\nsuperio_outb(cr_wdt_timeout, timeout);\r\nsuperio_exit();\r\nreturn 0;\r\n}\r\nstatic int wdt_start(struct watchdog_device *wdog)\r\n{\r\nreturn wdt_set_time(wdog->timeout);\r\n}\r\nstatic int wdt_stop(struct watchdog_device *wdog)\r\n{\r\nreturn wdt_set_time(0);\r\n}\r\nstatic int wdt_set_timeout(struct watchdog_device *wdog, unsigned int timeout)\r\n{\r\nwdog->timeout = timeout;\r\nreturn 0;\r\n}\r\nstatic unsigned int wdt_get_time(struct watchdog_device *wdog)\r\n{\r\nunsigned int timeleft;\r\nint ret;\r\nret = superio_enter();\r\nif (ret)\r\nreturn 0;\r\nsuperio_select(W83627HF_LD_WDT);\r\ntimeleft = superio_inb(cr_wdt_timeout);\r\nsuperio_exit();\r\nreturn timeleft;\r\n}\r\nstatic int wdt_notify_sys(struct notifier_block *this, unsigned long code,\r\nvoid *unused)\r\n{\r\nif (code == SYS_DOWN || code == SYS_HALT)\r\nwdt_set_time(0);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int wdt_find(int addr)\r\n{\r\nu8 val;\r\nint ret;\r\ncr_wdt_timeout = W83627HF_WDT_TIMEOUT;\r\ncr_wdt_control = W83627HF_WDT_CONTROL;\r\nret = superio_enter();\r\nif (ret)\r\nreturn ret;\r\nsuperio_select(W83627HF_LD_WDT);\r\nval = superio_inb(0x20);\r\nswitch (val) {\r\ncase W83627HF_ID:\r\nret = w83627hf;\r\nbreak;\r\ncase W83627S_ID:\r\nret = w83627s;\r\nbreak;\r\ncase W83697HF_ID:\r\nret = w83697hf;\r\ncr_wdt_timeout = W83697HF_WDT_TIMEOUT;\r\ncr_wdt_control = W83697HF_WDT_CONTROL;\r\nbreak;\r\ncase W83697UG_ID:\r\nret = w83697ug;\r\ncr_wdt_timeout = W83697HF_WDT_TIMEOUT;\r\ncr_wdt_control = W83697HF_WDT_CONTROL;\r\nbreak;\r\ncase W83637HF_ID:\r\nret = w83637hf;\r\nbreak;\r\ncase W83627THF_ID:\r\nret = w83627thf;\r\nbreak;\r\ncase W83687THF_ID:\r\nret = w83687thf;\r\nbreak;\r\ncase W83627EHF_ID:\r\nret = w83627ehf;\r\nbreak;\r\ncase W83627DHG_ID:\r\nret = w83627dhg;\r\nbreak;\r\ncase W83627DHG_P_ID:\r\nret = w83627dhg_p;\r\nbreak;\r\ncase W83627UHG_ID:\r\nret = w83627uhg;\r\nbreak;\r\ncase W83667HG_ID:\r\nret = w83667hg;\r\nbreak;\r\ncase W83667HG_B_ID:\r\nret = w83667hg_b;\r\nbreak;\r\ncase NCT6775_ID:\r\nret = nct6775;\r\nbreak;\r\ncase NCT6776_ID:\r\nret = nct6776;\r\nbreak;\r\ncase NCT6779_ID:\r\nret = nct6779;\r\nbreak;\r\ncase NCT6791_ID:\r\nret = nct6791;\r\nbreak;\r\ncase NCT6792_ID:\r\nret = nct6792;\r\nbreak;\r\ncase 0xff:\r\nret = -ENODEV;\r\nbreak;\r\ndefault:\r\nret = -ENODEV;\r\npr_err("Unsupported chip ID: 0x%02x\n", val);\r\nbreak;\r\n}\r\nsuperio_exit();\r\nreturn ret;\r\n}\r\nstatic int __init wdt_init(void)\r\n{\r\nint ret;\r\nint chip;\r\nconst char * const chip_name[] = {\r\n"W83627HF",\r\n"W83627S",\r\n"W83697HF",\r\n"W83697UG",\r\n"W83637HF",\r\n"W83627THF",\r\n"W83687THF",\r\n"W83627EHF",\r\n"W83627DHG",\r\n"W83627UHG",\r\n"W83667HG",\r\n"W83667DHG-P",\r\n"W83667HG-B",\r\n"NCT6775",\r\n"NCT6776",\r\n"NCT6779",\r\n"NCT6791",\r\n"NCT6792",\r\n};\r\nwdt_io = 0x2e;\r\nchip = wdt_find(0x2e);\r\nif (chip < 0) {\r\nwdt_io = 0x4e;\r\nchip = wdt_find(0x4e);\r\nif (chip < 0)\r\nreturn chip;\r\n}\r\npr_info("WDT driver for %s Super I/O chip initialising\n",\r\nchip_name[chip]);\r\nwatchdog_init_timeout(&wdt_dev, timeout, NULL);\r\nwatchdog_set_nowayout(&wdt_dev, nowayout);\r\nret = w83627hf_init(&wdt_dev, chip);\r\nif (ret) {\r\npr_err("failed to initialize watchdog (err=%d)\n", ret);\r\nreturn ret;\r\n}\r\nret = register_reboot_notifier(&wdt_notifier);\r\nif (ret != 0) {\r\npr_err("cannot register reboot notifier (err=%d)\n", ret);\r\nreturn ret;\r\n}\r\nret = watchdog_register_device(&wdt_dev);\r\nif (ret)\r\ngoto unreg_reboot;\r\npr_info("initialized. timeout=%d sec (nowayout=%d)\n",\r\nwdt_dev.timeout, nowayout);\r\nreturn ret;\r\nunreg_reboot:\r\nunregister_reboot_notifier(&wdt_notifier);\r\nreturn ret;\r\n}\r\nstatic void __exit wdt_exit(void)\r\n{\r\nwatchdog_unregister_device(&wdt_dev);\r\nunregister_reboot_notifier(&wdt_notifier);\r\n}

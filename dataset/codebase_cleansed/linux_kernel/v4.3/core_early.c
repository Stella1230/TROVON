static bool __init check_loader_disabled_bsp(void)\r\n{\r\n#ifdef CONFIG_X86_32\r\nconst char *cmdline = (const char *)__pa_nodebug(boot_command_line);\r\nconst char *opt = "dis_ucode_ldr";\r\nconst char *option = (const char *)__pa_nodebug(opt);\r\nbool *res = (bool *)__pa_nodebug(&dis_ucode_ldr);\r\n#else\r\nconst char *cmdline = boot_command_line;\r\nconst char *option = "dis_ucode_ldr";\r\nbool *res = &dis_ucode_ldr;\r\n#endif\r\nif (cmdline_find_option_bool(cmdline, option))\r\n*res = true;\r\nreturn *res;\r\n}\r\nbool get_builtin_firmware(struct cpio_data *cd, const char *name)\r\n{\r\n#ifdef CONFIG_FW_LOADER\r\nstruct builtin_fw *b_fw;\r\nfor (b_fw = __start_builtin_fw; b_fw != __end_builtin_fw; b_fw++) {\r\nif (!strcmp(name, b_fw->name)) {\r\ncd->size = b_fw->size;\r\ncd->data = b_fw->data;\r\nreturn true;\r\n}\r\n}\r\n#endif\r\nreturn false;\r\n}\r\nvoid __init load_ucode_bsp(void)\r\n{\r\nint vendor;\r\nunsigned int family;\r\nif (check_loader_disabled_bsp())\r\nreturn;\r\nif (!have_cpuid_p())\r\nreturn;\r\nvendor = x86_vendor();\r\nfamily = x86_family();\r\nswitch (vendor) {\r\ncase X86_VENDOR_INTEL:\r\nif (family >= 6)\r\nload_ucode_intel_bsp();\r\nbreak;\r\ncase X86_VENDOR_AMD:\r\nif (family >= 0x10)\r\nload_ucode_amd_bsp(family);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic bool check_loader_disabled_ap(void)\r\n{\r\n#ifdef CONFIG_X86_32\r\nreturn *((bool *)__pa_nodebug(&dis_ucode_ldr));\r\n#else\r\nreturn dis_ucode_ldr;\r\n#endif\r\n}\r\nvoid load_ucode_ap(void)\r\n{\r\nint vendor, family;\r\nif (check_loader_disabled_ap())\r\nreturn;\r\nif (!have_cpuid_p())\r\nreturn;\r\nvendor = x86_vendor();\r\nfamily = x86_family();\r\nswitch (vendor) {\r\ncase X86_VENDOR_INTEL:\r\nif (family >= 6)\r\nload_ucode_intel_ap();\r\nbreak;\r\ncase X86_VENDOR_AMD:\r\nif (family >= 0x10)\r\nload_ucode_amd_ap();\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nint __init save_microcode_in_initrd(void)\r\n{\r\nstruct cpuinfo_x86 *c = &boot_cpu_data;\r\nswitch (c->x86_vendor) {\r\ncase X86_VENDOR_INTEL:\r\nif (c->x86 >= 6)\r\nsave_microcode_in_initrd_intel();\r\nbreak;\r\ncase X86_VENDOR_AMD:\r\nif (c->x86 >= 0x10)\r\nsave_microcode_in_initrd_amd();\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nvoid reload_early_microcode(void)\r\n{\r\nint vendor, family;\r\nvendor = x86_vendor();\r\nfamily = x86_family();\r\nswitch (vendor) {\r\ncase X86_VENDOR_INTEL:\r\nif (family >= 6)\r\nreload_ucode_intel();\r\nbreak;\r\ncase X86_VENDOR_AMD:\r\nif (family >= 0x10)\r\nreload_ucode_amd();\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}

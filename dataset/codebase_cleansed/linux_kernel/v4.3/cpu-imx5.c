static u32 imx5_read_srev_reg(const char *compat)\r\n{\r\nvoid __iomem *iim_base;\r\nstruct device_node *np;\r\nu32 srev;\r\nnp = of_find_compatible_node(NULL, NULL, compat);\r\niim_base = of_iomap(np, 0);\r\nWARN_ON(!iim_base);\r\nsrev = readl(iim_base + IIM_SREV) & 0xff;\r\niounmap(iim_base);\r\nreturn srev;\r\n}\r\nstatic int get_mx51_srev(void)\r\n{\r\nu32 rev = imx5_read_srev_reg("fsl,imx51-iim");\r\nswitch (rev) {\r\ncase 0x0:\r\nreturn IMX_CHIP_REVISION_2_0;\r\ncase 0x10:\r\nreturn IMX_CHIP_REVISION_3_0;\r\ndefault:\r\nreturn IMX_CHIP_REVISION_UNKNOWN;\r\n}\r\n}\r\nint mx51_revision(void)\r\n{\r\nif (!cpu_is_mx51())\r\nreturn -EINVAL;\r\nif (mx5_cpu_rev == -1)\r\nmx5_cpu_rev = get_mx51_srev();\r\nreturn mx5_cpu_rev;\r\n}\r\nint __init mx51_neon_fixup(void)\r\n{\r\nif (mx51_revision() < IMX_CHIP_REVISION_3_0 &&\r\n(elf_hwcap & HWCAP_NEON)) {\r\nelf_hwcap &= ~HWCAP_NEON;\r\npr_info("Turning off NEON support, detected broken NEON implementation\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int get_mx53_srev(void)\r\n{\r\nu32 rev = imx5_read_srev_reg("fsl,imx53-iim");\r\nswitch (rev) {\r\ncase 0x0:\r\nreturn IMX_CHIP_REVISION_1_0;\r\ncase 0x2:\r\nreturn IMX_CHIP_REVISION_2_0;\r\ncase 0x3:\r\nreturn IMX_CHIP_REVISION_2_1;\r\ndefault:\r\nreturn IMX_CHIP_REVISION_UNKNOWN;\r\n}\r\n}\r\nint mx53_revision(void)\r\n{\r\nif (!cpu_is_mx53())\r\nreturn -EINVAL;\r\nif (mx5_cpu_rev == -1)\r\nmx5_cpu_rev = get_mx53_srev();\r\nreturn mx5_cpu_rev;\r\n}

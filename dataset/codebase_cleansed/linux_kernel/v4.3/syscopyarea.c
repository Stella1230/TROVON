static void\r\nbitcpy(struct fb_info *p, unsigned long *dst, unsigned dst_idx,\r\nconst unsigned long *src, unsigned src_idx, int bits, unsigned n)\r\n{\r\nunsigned long first, last;\r\nint const shift = dst_idx-src_idx;\r\nint left, right;\r\nfirst = FB_SHIFT_HIGH(p, ~0UL, dst_idx);\r\nlast = ~(FB_SHIFT_HIGH(p, ~0UL, (dst_idx+n) % bits));\r\nif (!shift) {\r\nif (dst_idx+n <= bits) {\r\nif (last)\r\nfirst &= last;\r\n*dst = comp(*src, *dst, first);\r\n} else {\r\nif (first != ~0UL) {\r\n*dst = comp(*src, *dst, first);\r\ndst++;\r\nsrc++;\r\nn -= bits - dst_idx;\r\n}\r\nn /= bits;\r\nwhile (n >= 8) {\r\n*dst++ = *src++;\r\n*dst++ = *src++;\r\n*dst++ = *src++;\r\n*dst++ = *src++;\r\n*dst++ = *src++;\r\n*dst++ = *src++;\r\n*dst++ = *src++;\r\n*dst++ = *src++;\r\nn -= 8;\r\n}\r\nwhile (n--)\r\n*dst++ = *src++;\r\nif (last)\r\n*dst = comp(*src, *dst, last);\r\n}\r\n} else {\r\nunsigned long d0, d1;\r\nint m;\r\nright = shift & (bits - 1);\r\nleft = -shift & (bits - 1);\r\nif (dst_idx+n <= bits) {\r\nif (last)\r\nfirst &= last;\r\nif (shift > 0) {\r\n*dst = comp(*src << left, *dst, first);\r\n} else if (src_idx+n <= bits) {\r\n*dst = comp(*src >> right, *dst, first);\r\n} else {\r\nd0 = *src++;\r\nd1 = *src;\r\n*dst = comp(d0 >> right | d1 << left, *dst,\r\nfirst);\r\n}\r\n} else {\r\nd0 = *src++;\r\nif (shift > 0) {\r\n*dst = comp(d0 << left, *dst, first);\r\ndst++;\r\nn -= bits - dst_idx;\r\n} else {\r\nd1 = *src++;\r\n*dst = comp(d0 >> right | d1 << left, *dst,\r\nfirst);\r\nd0 = d1;\r\ndst++;\r\nn -= bits - dst_idx;\r\n}\r\nm = n % bits;\r\nn /= bits;\r\nwhile (n >= 4) {\r\nd1 = *src++;\r\n*dst++ = d0 >> right | d1 << left;\r\nd0 = d1;\r\nd1 = *src++;\r\n*dst++ = d0 >> right | d1 << left;\r\nd0 = d1;\r\nd1 = *src++;\r\n*dst++ = d0 >> right | d1 << left;\r\nd0 = d1;\r\nd1 = *src++;\r\n*dst++ = d0 >> right | d1 << left;\r\nd0 = d1;\r\nn -= 4;\r\n}\r\nwhile (n--) {\r\nd1 = *src++;\r\n*dst++ = d0 >> right | d1 << left;\r\nd0 = d1;\r\n}\r\nif (m) {\r\nif (m <= bits - right) {\r\nd0 >>= right;\r\n} else {\r\nd1 = *src;\r\nd0 = d0 >> right | d1 << left;\r\n}\r\n*dst = comp(d0, *dst, last);\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nbitcpy_rev(struct fb_info *p, unsigned long *dst, unsigned dst_idx,\r\nconst unsigned long *src, unsigned src_idx, unsigned bits,\r\nunsigned n)\r\n{\r\nunsigned long first, last;\r\nint shift;\r\ndst += (dst_idx + n - 1) / bits;\r\nsrc += (src_idx + n - 1) / bits;\r\ndst_idx = (dst_idx + n - 1) % bits;\r\nsrc_idx = (src_idx + n - 1) % bits;\r\nshift = dst_idx-src_idx;\r\nfirst = ~FB_SHIFT_HIGH(p, ~0UL, (dst_idx + 1) % bits);\r\nlast = FB_SHIFT_HIGH(p, ~0UL, (bits + dst_idx + 1 - n) % bits);\r\nif (!shift) {\r\nif ((unsigned long)dst_idx+1 >= n) {\r\nif (first)\r\nlast &= first;\r\n*dst = comp(*src, *dst, last);\r\n} else {\r\nif (first) {\r\n*dst = comp(*src, *dst, first);\r\ndst--;\r\nsrc--;\r\nn -= dst_idx+1;\r\n}\r\nn /= bits;\r\nwhile (n >= 8) {\r\n*dst-- = *src--;\r\n*dst-- = *src--;\r\n*dst-- = *src--;\r\n*dst-- = *src--;\r\n*dst-- = *src--;\r\n*dst-- = *src--;\r\n*dst-- = *src--;\r\n*dst-- = *src--;\r\nn -= 8;\r\n}\r\nwhile (n--)\r\n*dst-- = *src--;\r\nif (last != -1UL)\r\n*dst = comp(*src, *dst, last);\r\n}\r\n} else {\r\nint const left = shift & (bits-1);\r\nint const right = -shift & (bits-1);\r\nif ((unsigned long)dst_idx+1 >= n) {\r\nif (first)\r\nlast &= first;\r\nif (shift < 0) {\r\n*dst = comp(*src >> right, *dst, last);\r\n} else if (1+(unsigned long)src_idx >= n) {\r\n*dst = comp(*src << left, *dst, last);\r\n} else {\r\n*dst = comp(*src << left | *(src-1) >> right,\r\n*dst, last);\r\n}\r\n} else {\r\nunsigned long d0, d1;\r\nint m;\r\nd0 = *src--;\r\nif (shift < 0) {\r\nd1 = d0;\r\nd0 >>= right;\r\n} else {\r\nd1 = *src--;\r\nd0 = d0 << left | d1 >> right;\r\n}\r\nif (!first)\r\n*dst = d0;\r\nelse\r\n*dst = comp(d0, *dst, first);\r\nd0 = d1;\r\ndst--;\r\nn -= dst_idx+1;\r\nm = n % bits;\r\nn /= bits;\r\nwhile (n >= 4) {\r\nd1 = *src--;\r\n*dst-- = d0 << left | d1 >> right;\r\nd0 = d1;\r\nd1 = *src--;\r\n*dst-- = d0 << left | d1 >> right;\r\nd0 = d1;\r\nd1 = *src--;\r\n*dst-- = d0 << left | d1 >> right;\r\nd0 = d1;\r\nd1 = *src--;\r\n*dst-- = d0 << left | d1 >> right;\r\nd0 = d1;\r\nn -= 4;\r\n}\r\nwhile (n--) {\r\nd1 = *src--;\r\n*dst-- = d0 << left | d1 >> right;\r\nd0 = d1;\r\n}\r\nif (m) {\r\nif (m <= bits - left) {\r\nd0 <<= left;\r\n} else {\r\nd1 = *src;\r\nd0 = d0 << left | d1 >> right;\r\n}\r\n*dst = comp(d0, *dst, last);\r\n}\r\n}\r\n}\r\n}\r\nvoid sys_copyarea(struct fb_info *p, const struct fb_copyarea *area)\r\n{\r\nu32 dx = area->dx, dy = area->dy, sx = area->sx, sy = area->sy;\r\nu32 height = area->height, width = area->width;\r\nunsigned long const bits_per_line = p->fix.line_length*8u;\r\nunsigned long *base = NULL;\r\nint bits = BITS_PER_LONG, bytes = bits >> 3;\r\nunsigned dst_idx = 0, src_idx = 0, rev_copy = 0;\r\nif (p->state != FBINFO_STATE_RUNNING)\r\nreturn;\r\nif ((dy == sy && dx > sx) || (dy > sy)) {\r\ndy += height;\r\nsy += height;\r\nrev_copy = 1;\r\n}\r\nbase = (unsigned long *)((unsigned long)p->screen_base & ~(bytes-1));\r\ndst_idx = src_idx = 8*((unsigned long)p->screen_base & (bytes-1));\r\ndst_idx += dy*bits_per_line + dx*p->var.bits_per_pixel;\r\nsrc_idx += sy*bits_per_line + sx*p->var.bits_per_pixel;\r\nif (p->fbops->fb_sync)\r\np->fbops->fb_sync(p);\r\nif (rev_copy) {\r\nwhile (height--) {\r\ndst_idx -= bits_per_line;\r\nsrc_idx -= bits_per_line;\r\nbitcpy_rev(p, base + (dst_idx / bits), dst_idx % bits,\r\nbase + (src_idx / bits), src_idx % bits, bits,\r\nwidth*p->var.bits_per_pixel);\r\n}\r\n} else {\r\nwhile (height--) {\r\nbitcpy(p, base + (dst_idx / bits), dst_idx % bits,\r\nbase + (src_idx / bits), src_idx % bits, bits,\r\nwidth*p->var.bits_per_pixel);\r\ndst_idx += bits_per_line;\r\nsrc_idx += bits_per_line;\r\n}\r\n}\r\n}

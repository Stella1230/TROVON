static ssize_t max_rpcs_in_flight_show(struct kobject *kobj,\r\nstruct attribute *attr,\r\nchar *buf)\r\n{\r\nint len;\r\nstruct obd_device *dev = container_of(kobj, struct obd_device,\r\nobd_kobj);\r\nstruct client_obd *cli = &dev->u.cli;\r\nclient_obd_list_lock(&cli->cl_loi_list_lock);\r\nlen = sprintf(buf, "%u\n", cli->cl_max_rpcs_in_flight);\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nreturn len;\r\n}\r\nstatic ssize_t max_rpcs_in_flight_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buffer,\r\nsize_t count)\r\n{\r\nstruct obd_device *dev = container_of(kobj, struct obd_device,\r\nobd_kobj);\r\nstruct client_obd *cli = &dev->u.cli;\r\nint rc;\r\nunsigned long val;\r\nrc = kstrtoul(buffer, 10, &val);\r\nif (rc)\r\nreturn rc;\r\nif (val < 1 || val > MDC_MAX_RIF_MAX)\r\nreturn -ERANGE;\r\nclient_obd_list_lock(&cli->cl_loi_list_lock);\r\ncli->cl_max_rpcs_in_flight = val;\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nreturn count;\r\n}\r\nstatic int mdc_kuc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, NULL, inode->i_private);\r\n}\r\nstatic ssize_t mdc_kuc_write(struct file *file,\r\nconst char __user *buffer,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct obd_device *obd =\r\n((struct seq_file *)file->private_data)->private;\r\nstruct kuc_hdr *lh;\r\nstruct hsm_action_list *hal;\r\nstruct hsm_action_item *hai;\r\nint len;\r\nint fd, rc;\r\nrc = lprocfs_write_helper(buffer, count, &fd);\r\nif (rc)\r\nreturn rc;\r\nif (fd < 0)\r\nreturn -ERANGE;\r\nCWARN("message to fd %d\n", fd);\r\nlen = sizeof(*lh) + sizeof(*hal) + MTI_NAME_MAXLEN +\r\n2 * cfs_size_round(sizeof(*hai));\r\nlh = kzalloc(len, GFP_NOFS);\r\nif (!lh)\r\nreturn -ENOMEM;\r\nlh->kuc_magic = KUC_MAGIC;\r\nlh->kuc_transport = KUC_TRANSPORT_HSM;\r\nlh->kuc_msgtype = HMT_ACTION_LIST;\r\nlh->kuc_msglen = len;\r\nhal = (struct hsm_action_list *)(lh + 1);\r\nhal->hal_version = HAL_VERSION;\r\nhal->hal_archive_id = 1;\r\nhal->hal_flags = 0;\r\nobd_uuid2fsname(hal->hal_fsname, obd->obd_name, MTI_NAME_MAXLEN);\r\nhal->hal_count = 2;\r\nhai = hai_zero(hal);\r\nhai->hai_action = HSMA_ARCHIVE;\r\nhai->hai_fid.f_oid = 5;\r\nhai->hai_len = sizeof(*hai);\r\nhai = hai_next(hai);\r\nhai->hai_action = HSMA_RESTORE;\r\nhai->hai_fid.f_oid = 10;\r\nhai->hai_len = sizeof(*hai);\r\nif (fd == 0) {\r\nrc = libcfs_kkuc_group_put(KUC_GRP_HSM, lh);\r\n} else {\r\nstruct file *fp = fget(fd);\r\nrc = libcfs_kkuc_msg_put(fp, lh);\r\nfput(fp);\r\n}\r\nkfree(lh);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn count;\r\n}\r\nstatic ssize_t max_pages_per_rpc_show(struct kobject *kobj,\r\nstruct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct obd_device *dev = container_of(kobj, struct obd_device,\r\nobd_kobj);\r\nstruct client_obd *cli = &dev->u.cli;\r\nreturn sprintf(buf, "%d\n", cli->cl_max_pages_per_rpc);\r\n}\r\nvoid lprocfs_mdc_init_vars(struct lprocfs_static_vars *lvars)\r\n{\r\nlvars->sysfs_vars = &mdc_attr_group;\r\nlvars->obd_vars = lprocfs_mdc_obd_vars;\r\n}

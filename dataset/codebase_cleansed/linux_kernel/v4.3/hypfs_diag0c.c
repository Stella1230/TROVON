static void diag0c(struct hypfs_diag0c_entry *entry)\r\n{\r\nasm volatile (\r\n" sam31\n"\r\n" diag %0,%0,0x0c\n"\r\n" sam64\n"\r\n:\r\n: "a" (entry)\r\n: "memory");\r\n}\r\nstatic void diag0c_fn(void *data)\r\n{\r\ndiag0c(((void **) data)[smp_processor_id()]);\r\n}\r\nstatic void *diag0c_store(unsigned int *count)\r\n{\r\nstruct hypfs_diag0c_data *diag0c_data;\r\nunsigned int cpu_count, cpu, i;\r\nvoid **cpu_vec;\r\nget_online_cpus();\r\ncpu_count = num_online_cpus();\r\ncpu_vec = kmalloc(sizeof(*cpu_vec) * num_possible_cpus(), GFP_KERNEL);\r\nif (!cpu_vec)\r\ngoto fail_put_online_cpus;\r\ndiag0c_data = kzalloc(sizeof(struct hypfs_diag0c_hdr) +\r\ncpu_count * sizeof(struct hypfs_diag0c_entry),\r\nGFP_KERNEL | GFP_DMA);\r\nif (!diag0c_data)\r\ngoto fail_kfree_cpu_vec;\r\ni = 0;\r\nfor_each_online_cpu(cpu) {\r\ndiag0c_data->entry[i].cpu = cpu;\r\ncpu_vec[cpu] = &diag0c_data->entry[i++];\r\n}\r\non_each_cpu(diag0c_fn, cpu_vec, 1);\r\n*count = cpu_count;\r\nkfree(cpu_vec);\r\nput_online_cpus();\r\nreturn diag0c_data;\r\nfail_kfree_cpu_vec:\r\nkfree(cpu_vec);\r\nfail_put_online_cpus:\r\nput_online_cpus();\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nstatic void dbfs_diag0c_free(const void *data)\r\n{\r\nkfree(data);\r\n}\r\nstatic int dbfs_diag0c_create(void **data, void **data_free_ptr, size_t *size)\r\n{\r\nstruct hypfs_diag0c_data *diag0c_data;\r\nunsigned int count;\r\ndiag0c_data = diag0c_store(&count);\r\nif (IS_ERR(diag0c_data))\r\nreturn PTR_ERR(diag0c_data);\r\nmemset(&diag0c_data->hdr, 0, sizeof(diag0c_data->hdr));\r\nget_tod_clock_ext(diag0c_data->hdr.tod_ext);\r\ndiag0c_data->hdr.len = count * sizeof(struct hypfs_diag0c_entry);\r\ndiag0c_data->hdr.version = DBFS_D0C_HDR_VERSION;\r\ndiag0c_data->hdr.count = count;\r\n*data = diag0c_data;\r\n*data_free_ptr = diag0c_data;\r\n*size = diag0c_data->hdr.len + sizeof(struct hypfs_diag0c_hdr);\r\nreturn 0;\r\n}\r\nint __init hypfs_diag0c_init(void)\r\n{\r\nif (!MACHINE_IS_VM)\r\nreturn 0;\r\nreturn hypfs_dbfs_create_file(&dbfs_file_0c);\r\n}\r\nvoid hypfs_diag0c_exit(void)\r\n{\r\nif (!MACHINE_IS_VM)\r\nreturn;\r\nhypfs_dbfs_remove_file(&dbfs_file_0c);\r\n}

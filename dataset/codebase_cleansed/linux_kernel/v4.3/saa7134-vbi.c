static void task_init(struct saa7134_dev *dev, struct saa7134_buf *buf,\r\nint task)\r\n{\r\nstruct saa7134_tvnorm *norm = dev->tvnorm;\r\nsaa_writeb(SAA7134_VBI_H_START1(task), norm->h_start & 0xff);\r\nsaa_writeb(SAA7134_VBI_H_START2(task), norm->h_start >> 8);\r\nsaa_writeb(SAA7134_VBI_H_STOP1(task), norm->h_stop & 0xff);\r\nsaa_writeb(SAA7134_VBI_H_STOP2(task), norm->h_stop >> 8);\r\nsaa_writeb(SAA7134_VBI_V_START1(task), norm->vbi_v_start_0 & 0xff);\r\nsaa_writeb(SAA7134_VBI_V_START2(task), norm->vbi_v_start_0 >> 8);\r\nsaa_writeb(SAA7134_VBI_V_STOP1(task), norm->vbi_v_stop_0 & 0xff);\r\nsaa_writeb(SAA7134_VBI_V_STOP2(task), norm->vbi_v_stop_0 >> 8);\r\nsaa_writeb(SAA7134_VBI_H_SCALE_INC1(task), VBI_SCALE & 0xff);\r\nsaa_writeb(SAA7134_VBI_H_SCALE_INC2(task), VBI_SCALE >> 8);\r\nsaa_writeb(SAA7134_VBI_PHASE_OFFSET_LUMA(task), 0x00);\r\nsaa_writeb(SAA7134_VBI_PHASE_OFFSET_CHROMA(task), 0x00);\r\nsaa_writeb(SAA7134_VBI_H_LEN1(task), dev->vbi_hlen & 0xff);\r\nsaa_writeb(SAA7134_VBI_H_LEN2(task), dev->vbi_hlen >> 8);\r\nsaa_writeb(SAA7134_VBI_V_LEN1(task), dev->vbi_vlen & 0xff);\r\nsaa_writeb(SAA7134_VBI_V_LEN2(task), dev->vbi_vlen >> 8);\r\nsaa_andorb(SAA7134_DATA_PATH(task), 0xc0, 0x00);\r\n}\r\nstatic int buffer_activate(struct saa7134_dev *dev,\r\nstruct saa7134_buf *buf,\r\nstruct saa7134_buf *next)\r\n{\r\nstruct saa7134_dmaqueue *dmaq = buf->vb2.vb2_queue->drv_priv;\r\nunsigned long control, base;\r\nvbi_dbg("buffer_activate [%p]\n", buf);\r\nbuf->top_seen = 0;\r\ntask_init(dev, buf, TASK_A);\r\ntask_init(dev, buf, TASK_B);\r\nsaa_writeb(SAA7134_OFMT_DATA_A, 0x06);\r\nsaa_writeb(SAA7134_OFMT_DATA_B, 0x06);\r\nbase = saa7134_buffer_base(buf);\r\ncontrol = SAA7134_RS_CONTROL_BURST_16 |\r\nSAA7134_RS_CONTROL_ME |\r\n(dmaq->pt.dma >> 12);\r\nsaa_writel(SAA7134_RS_BA1(2), base);\r\nsaa_writel(SAA7134_RS_BA2(2), base + dev->vbi_hlen * dev->vbi_vlen);\r\nsaa_writel(SAA7134_RS_PITCH(2), dev->vbi_hlen);\r\nsaa_writel(SAA7134_RS_CONTROL(2), control);\r\nsaa_writel(SAA7134_RS_BA1(3), base);\r\nsaa_writel(SAA7134_RS_BA2(3), base + dev->vbi_hlen * dev->vbi_vlen);\r\nsaa_writel(SAA7134_RS_PITCH(3), dev->vbi_hlen);\r\nsaa_writel(SAA7134_RS_CONTROL(3), control);\r\nsaa7134_set_dmabits(dev);\r\nmod_timer(&dmaq->timeout, jiffies + BUFFER_TIMEOUT);\r\nreturn 0;\r\n}\r\nstatic int buffer_prepare(struct vb2_buffer *vb2)\r\n{\r\nstruct saa7134_dmaqueue *dmaq = vb2->vb2_queue->drv_priv;\r\nstruct saa7134_dev *dev = dmaq->dev;\r\nstruct saa7134_buf *buf = container_of(vb2, struct saa7134_buf, vb2);\r\nstruct sg_table *dma = vb2_dma_sg_plane_desc(&buf->vb2, 0);\r\nunsigned int size;\r\nif (dma->sgl->offset) {\r\npr_err("The buffer is not page-aligned\n");\r\nreturn -EINVAL;\r\n}\r\nsize = dev->vbi_hlen * dev->vbi_vlen * 2;\r\nif (vb2_plane_size(vb2, 0) < size)\r\nreturn -EINVAL;\r\nvb2_set_plane_payload(vb2, 0, size);\r\nreturn saa7134_pgtable_build(dev->pci, &dmaq->pt, dma->sgl, dma->nents,\r\nsaa7134_buffer_startpage(buf));\r\n}\r\nstatic int queue_setup(struct vb2_queue *q, const struct v4l2_format *fmt,\r\nunsigned int *nbuffers, unsigned int *nplanes,\r\nunsigned int sizes[], void *alloc_ctxs[])\r\n{\r\nstruct saa7134_dmaqueue *dmaq = q->drv_priv;\r\nstruct saa7134_dev *dev = dmaq->dev;\r\nunsigned int size;\r\ndev->vbi_vlen = dev->tvnorm->vbi_v_stop_0 - dev->tvnorm->vbi_v_start_0 + 1;\r\nif (dev->vbi_vlen > VBI_LINE_COUNT)\r\ndev->vbi_vlen = VBI_LINE_COUNT;\r\ndev->vbi_hlen = VBI_LINE_LENGTH;\r\nsize = dev->vbi_hlen * dev->vbi_vlen * 2;\r\n*nbuffers = saa7134_buffer_count(size, *nbuffers);\r\n*nplanes = 1;\r\nsizes[0] = size;\r\nalloc_ctxs[0] = dev->alloc_ctx;\r\nreturn 0;\r\n}\r\nstatic int buffer_init(struct vb2_buffer *vb2)\r\n{\r\nstruct saa7134_dmaqueue *dmaq = vb2->vb2_queue->drv_priv;\r\nstruct saa7134_buf *buf = container_of(vb2, struct saa7134_buf, vb2);\r\ndmaq->curr = NULL;\r\nbuf->activate = buffer_activate;\r\nreturn 0;\r\n}\r\nint saa7134_vbi_init1(struct saa7134_dev *dev)\r\n{\r\nINIT_LIST_HEAD(&dev->vbi_q.queue);\r\ninit_timer(&dev->vbi_q.timeout);\r\ndev->vbi_q.timeout.function = saa7134_buffer_timeout;\r\ndev->vbi_q.timeout.data = (unsigned long)(&dev->vbi_q);\r\ndev->vbi_q.dev = dev;\r\nif (vbibufs < 2)\r\nvbibufs = 2;\r\nif (vbibufs > VIDEO_MAX_FRAME)\r\nvbibufs = VIDEO_MAX_FRAME;\r\nreturn 0;\r\n}\r\nint saa7134_vbi_fini(struct saa7134_dev *dev)\r\n{\r\nreturn 0;\r\n}\r\nvoid saa7134_irq_vbi_done(struct saa7134_dev *dev, unsigned long status)\r\n{\r\nspin_lock(&dev->slock);\r\nif (dev->vbi_q.curr) {\r\nif ((status & 0x10) == 0x00) {\r\ndev->vbi_q.curr->top_seen = 1;\r\ngoto done;\r\n}\r\nif (!dev->vbi_q.curr->top_seen)\r\ngoto done;\r\nsaa7134_buffer_finish(dev, &dev->vbi_q, VB2_BUF_STATE_DONE);\r\n}\r\nsaa7134_buffer_next(dev, &dev->vbi_q);\r\ndone:\r\nspin_unlock(&dev->slock);\r\n}

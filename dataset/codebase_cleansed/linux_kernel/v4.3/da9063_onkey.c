static void da9063_poll_on(struct work_struct *work)\r\n{\r\nstruct da9063_onkey *onkey = container_of(work, struct da9063_onkey,\r\nwork.work);\r\nunsigned int val;\r\nint fault_log = 0;\r\nbool poll = true;\r\nint error;\r\nerror = regmap_read(onkey->hw->regmap, DA9063_REG_STATUS_A, &val);\r\nif (error) {\r\ndev_err(onkey->dev,\r\n"Failed to read ON status: %d\n", error);\r\ngoto err_poll;\r\n}\r\nif (!(val & DA9063_NONKEY)) {\r\nerror = regmap_update_bits(onkey->hw->regmap,\r\nDA9063_REG_CONTROL_B,\r\nDA9063_NONKEY_LOCK, 0);\r\nif (error) {\r\ndev_err(onkey->dev,\r\n"Failed to reset the Key Delay %d\n", error);\r\ngoto err_poll;\r\n}\r\ninput_report_key(onkey->input, KEY_POWER, 0);\r\ninput_sync(onkey->input);\r\npoll = false;\r\n}\r\nerror = regmap_read(onkey->hw->regmap,\r\nDA9063_REG_FAULT_LOG, &fault_log);\r\nif (error) {\r\ndev_warn(&onkey->input->dev,\r\n"Cannot read FAULT_LOG: %d\n", error);\r\n} else if (fault_log & DA9063_KEY_RESET) {\r\nerror = regmap_write(onkey->hw->regmap,\r\nDA9063_REG_FAULT_LOG,\r\nDA9063_KEY_RESET);\r\nif (error) {\r\ndev_warn(&onkey->input->dev,\r\n"Cannot reset KEY_RESET fault log: %d\n",\r\nerror);\r\n} else {\r\ndev_dbg(&onkey->input->dev,\r\n"Sending SHUTDOWN to DA9063 ...\n");\r\nerror = regmap_write(onkey->hw->regmap,\r\nDA9063_REG_CONTROL_F,\r\nDA9063_SHUTDOWN);\r\nif (error)\r\ndev_err(&onkey->input->dev,\r\n"Cannot SHUTDOWN DA9063: %d\n",\r\nerror);\r\n}\r\n}\r\nerr_poll:\r\nif (poll)\r\nschedule_delayed_work(&onkey->work, msecs_to_jiffies(50));\r\n}\r\nstatic irqreturn_t da9063_onkey_irq_handler(int irq, void *data)\r\n{\r\nstruct da9063_onkey *onkey = data;\r\nunsigned int val;\r\nint error;\r\nerror = regmap_read(onkey->hw->regmap, DA9063_REG_STATUS_A, &val);\r\nif (onkey->key_power && !error && (val & DA9063_NONKEY)) {\r\ninput_report_key(onkey->input, KEY_POWER, 1);\r\ninput_sync(onkey->input);\r\nschedule_delayed_work(&onkey->work, 0);\r\ndev_dbg(onkey->dev, "KEY_POWER pressed.\n");\r\n} else {\r\ninput_report_key(onkey->input, KEY_SLEEP, 1);\r\ninput_sync(onkey->input);\r\ninput_report_key(onkey->input, KEY_SLEEP, 0);\r\ninput_sync(onkey->input);\r\ndev_dbg(onkey->dev, "KEY_SLEEP pressed.\n");\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void da9063_cancel_poll(void *data)\r\n{\r\nstruct da9063_onkey *onkey = data;\r\ncancel_delayed_work_sync(&onkey->work);\r\n}\r\nstatic int da9063_onkey_probe(struct platform_device *pdev)\r\n{\r\nstruct da9063 *da9063 = dev_get_drvdata(pdev->dev.parent);\r\nstruct da9063_pdata *pdata = dev_get_platdata(da9063->dev);\r\nstruct da9063_onkey *onkey;\r\nint irq;\r\nint error;\r\nonkey = devm_kzalloc(&pdev->dev, sizeof(struct da9063_onkey),\r\nGFP_KERNEL);\r\nif (!onkey) {\r\ndev_err(&pdev->dev, "Failed to allocate memory.\n");\r\nreturn -ENOMEM;\r\n}\r\nonkey->dev = &pdev->dev;\r\nonkey->hw = da9063;\r\nif (pdata)\r\nonkey->key_power = pdata->key_power;\r\nelse\r\nonkey->key_power =\r\n!of_property_read_bool(pdev->dev.of_node,\r\n"dlg,disable-key-power");\r\nonkey->input = devm_input_allocate_device(&pdev->dev);\r\nif (!onkey->input) {\r\ndev_err(&pdev->dev, "Failed to allocated input device.\n");\r\nreturn -ENOMEM;\r\n}\r\nonkey->input->name = DA9063_DRVNAME_ONKEY;\r\nonkey->input->phys = DA9063_DRVNAME_ONKEY "/input0";\r\nonkey->input->dev.parent = &pdev->dev;\r\nif (onkey->key_power)\r\ninput_set_capability(onkey->input, EV_KEY, KEY_POWER);\r\ninput_set_capability(onkey->input, EV_KEY, KEY_SLEEP);\r\nINIT_DELAYED_WORK(&onkey->work, da9063_poll_on);\r\nerror = devm_add_action(&pdev->dev, da9063_cancel_poll, onkey);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"Failed to add cancel poll action: %d\n",\r\nerror);\r\nreturn error;\r\n}\r\nirq = platform_get_irq_byname(pdev, "ONKEY");\r\nif (irq < 0) {\r\nerror = irq;\r\ndev_err(&pdev->dev, "Failed to get platform IRQ: %d\n", error);\r\nreturn error;\r\n}\r\nerror = devm_request_threaded_irq(&pdev->dev, irq,\r\nNULL, da9063_onkey_irq_handler,\r\nIRQF_TRIGGER_LOW | IRQF_ONESHOT,\r\n"ONKEY", onkey);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"Failed to request IRQ %d: %d\n", irq, error);\r\nreturn error;\r\n}\r\nerror = input_register_device(onkey->input);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"Failed to register input device: %d\n", error);\r\nreturn error;\r\n}\r\nplatform_set_drvdata(pdev, onkey);\r\nreturn 0;\r\n}

static int u8500_hsem_trylock(struct hwspinlock *lock)\r\n{\r\nvoid __iomem *lock_addr = lock->priv;\r\nwritel(HSEM_MASTER_ID, lock_addr);\r\nreturn (HSEM_MASTER_ID == (0x0F & readl(lock_addr)));\r\n}\r\nstatic void u8500_hsem_unlock(struct hwspinlock *lock)\r\n{\r\nvoid __iomem *lock_addr = lock->priv;\r\nwritel(RESET_SEMAPHORE, lock_addr);\r\n}\r\nstatic void u8500_hsem_relax(struct hwspinlock *lock)\r\n{\r\nndelay(50);\r\n}\r\nstatic int u8500_hsem_probe(struct platform_device *pdev)\r\n{\r\nstruct hwspinlock_pdata *pdata = pdev->dev.platform_data;\r\nstruct hwspinlock_device *bank;\r\nstruct hwspinlock *hwlock;\r\nstruct resource *res;\r\nvoid __iomem *io_base;\r\nint i, ret, num_locks = U8500_MAX_SEMAPHORE;\r\nulong val;\r\nif (!pdata)\r\nreturn -ENODEV;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\nio_base = ioremap(res->start, resource_size(res));\r\nif (!io_base)\r\nreturn -ENOMEM;\r\nval = readl(io_base + HSEM_CTRL_REG);\r\nwritel((val & ~HSEM_PROTOCOL_1), io_base + HSEM_CTRL_REG);\r\nwritel(0xFFFF, io_base + HSEM_ICRALL);\r\nbank = kzalloc(sizeof(*bank) + num_locks * sizeof(*hwlock), GFP_KERNEL);\r\nif (!bank) {\r\nret = -ENOMEM;\r\ngoto iounmap_base;\r\n}\r\nplatform_set_drvdata(pdev, bank);\r\nfor (i = 0, hwlock = &bank->lock[0]; i < num_locks; i++, hwlock++)\r\nhwlock->priv = io_base + HSEM_REGISTER_OFFSET + sizeof(u32) * i;\r\npm_runtime_enable(&pdev->dev);\r\nret = hwspin_lock_register(bank, &pdev->dev, &u8500_hwspinlock_ops,\r\npdata->base_id, num_locks);\r\nif (ret)\r\ngoto reg_fail;\r\nreturn 0;\r\nreg_fail:\r\npm_runtime_disable(&pdev->dev);\r\nkfree(bank);\r\niounmap_base:\r\niounmap(io_base);\r\nreturn ret;\r\n}\r\nstatic int u8500_hsem_remove(struct platform_device *pdev)\r\n{\r\nstruct hwspinlock_device *bank = platform_get_drvdata(pdev);\r\nvoid __iomem *io_base = bank->lock[0].priv - HSEM_REGISTER_OFFSET;\r\nint ret;\r\nwritel(0xFFFF, io_base + HSEM_ICRALL);\r\nret = hwspin_lock_unregister(bank);\r\nif (ret) {\r\ndev_err(&pdev->dev, "%s failed: %d\n", __func__, ret);\r\nreturn ret;\r\n}\r\npm_runtime_disable(&pdev->dev);\r\niounmap(io_base);\r\nkfree(bank);\r\nreturn 0;\r\n}\r\nstatic int __init u8500_hsem_init(void)\r\n{\r\nreturn platform_driver_register(&u8500_hsem_driver);\r\n}\r\nstatic void __exit u8500_hsem_exit(void)\r\n{\r\nplatform_driver_unregister(&u8500_hsem_driver);\r\n}

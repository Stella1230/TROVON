static unsigned long hypfs_sprp_diag304(void *data, unsigned long cmd)\r\n{\r\nregister unsigned long _data asm("2") = (unsigned long) data;\r\nregister unsigned long _rc asm("3");\r\nregister unsigned long _cmd asm("4") = cmd;\r\nasm volatile("diag %1,%2,0x304\n"\r\n: "=d" (_rc) : "d" (_data), "d" (_cmd) : "memory");\r\nreturn _rc;\r\n}\r\nstatic void hypfs_sprp_free(const void *data)\r\n{\r\nfree_page((unsigned long) data);\r\n}\r\nstatic int hypfs_sprp_create(void **data_ptr, void **free_ptr, size_t *size)\r\n{\r\nunsigned long rc;\r\nvoid *data;\r\ndata = (void *) get_zeroed_page(GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nrc = hypfs_sprp_diag304(data, DIAG304_QUERY_PRP);\r\nif (rc != 1) {\r\n*data_ptr = *free_ptr = NULL;\r\n*size = 0;\r\nfree_page((unsigned long) data);\r\nreturn -EIO;\r\n}\r\n*data_ptr = *free_ptr = data;\r\n*size = PAGE_SIZE;\r\nreturn 0;\r\n}\r\nstatic int __hypfs_sprp_ioctl(void __user *user_area)\r\n{\r\nstruct hypfs_diag304 diag304;\r\nunsigned long cmd;\r\nvoid __user *udata;\r\nvoid *data;\r\nint rc;\r\nif (copy_from_user(&diag304, user_area, sizeof(diag304)))\r\nreturn -EFAULT;\r\nif ((diag304.args[0] >> 8) != 0 || diag304.args[1] > DIAG304_CMD_MAX)\r\nreturn -EINVAL;\r\ndata = (void *) get_zeroed_page(GFP_KERNEL | GFP_DMA);\r\nif (!data)\r\nreturn -ENOMEM;\r\nudata = (void __user *)(unsigned long) diag304.data;\r\nif (diag304.args[1] == DIAG304_SET_WEIGHTS ||\r\ndiag304.args[1] == DIAG304_SET_CAPPING)\r\nif (copy_from_user(data, udata, PAGE_SIZE)) {\r\nrc = -EFAULT;\r\ngoto out;\r\n}\r\ncmd = *(unsigned long *) &diag304.args[0];\r\ndiag304.rc = hypfs_sprp_diag304(data, cmd);\r\nif (diag304.args[1] == DIAG304_QUERY_PRP)\r\nif (copy_to_user(udata, data, PAGE_SIZE)) {\r\nrc = -EFAULT;\r\ngoto out;\r\n}\r\nrc = copy_to_user(user_area, &diag304, sizeof(diag304)) ? -EFAULT : 0;\r\nout:\r\nfree_page((unsigned long) data);\r\nreturn rc;\r\n}\r\nstatic long hypfs_sprp_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nvoid __user *argp;\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EACCES;\r\nif (is_compat_task())\r\nargp = compat_ptr(arg);\r\nelse\r\nargp = (void __user *) arg;\r\nswitch (cmd) {\r\ncase HYPFS_DIAG304:\r\nreturn __hypfs_sprp_ioctl(argp);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\nreturn 0;\r\n}\r\nint hypfs_sprp_init(void)\r\n{\r\nif (!sclp.has_sprp)\r\nreturn 0;\r\nreturn hypfs_dbfs_create_file(&hypfs_sprp_file);\r\n}\r\nvoid hypfs_sprp_exit(void)\r\n{\r\nif (!sclp.has_sprp)\r\nreturn;\r\nhypfs_dbfs_remove_file(&hypfs_sprp_file);\r\n}

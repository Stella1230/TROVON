int pl080_get_signal(const struct pl08x_channel_data *cd)\r\n{\r\nunsigned int signal = cd->min_signal, val;\r\nunsigned long flags;\r\nspin_lock_irqsave(&lock, flags);\r\nif (signals[signal].busy &&\r\n(signals[signal].val != cd->muxval)) {\r\nspin_unlock_irqrestore(&lock, flags);\r\nreturn -EBUSY;\r\n}\r\nif (!signals[signal].busy) {\r\nval = readl(DMA_CHN_CFG);\r\nval &= ~(0x3 << (signal * 2));\r\nval |= cd->muxval << (signal * 2);\r\nwritel(val, DMA_CHN_CFG);\r\n}\r\nsignals[signal].busy++;\r\nsignals[signal].val = cd->muxval;\r\nspin_unlock_irqrestore(&lock, flags);\r\nreturn signal;\r\n}\r\nvoid pl080_put_signal(const struct pl08x_channel_data *cd, int signal)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&lock, flags);\r\nif (!signals[signal].busy)\r\nBUG();\r\nsignals[signal].busy--;\r\nspin_unlock_irqrestore(&lock, flags);\r\n}

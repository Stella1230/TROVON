static int apply_r_mips_32_rela(struct module *me, u32 *location, Elf_Addr v)\r\n{\r\n*location = v;\r\nreturn 0;\r\n}\r\nstatic int apply_r_mips_26_rela(struct module *me, u32 *location, Elf_Addr v)\r\n{\r\nif (v % 4) {\r\npr_err("module %s: dangerous R_MIPS_26 RELArelocation\n",\r\nme->name);\r\nreturn -ENOEXEC;\r\n}\r\nif ((v & 0xf0000000) != (((unsigned long)location + 4) & 0xf0000000)) {\r\nprintk(KERN_ERR\r\n"module %s: relocation overflow\n",\r\nme->name);\r\nreturn -ENOEXEC;\r\n}\r\n*location = (*location & ~0x03ffffff) | ((v >> 2) & 0x03ffffff);\r\nreturn 0;\r\n}\r\nstatic int apply_r_mips_hi16_rela(struct module *me, u32 *location, Elf_Addr v)\r\n{\r\n*location = (*location & 0xffff0000) |\r\n((((long long) v + 0x8000LL) >> 16) & 0xffff);\r\nreturn 0;\r\n}\r\nstatic int apply_r_mips_lo16_rela(struct module *me, u32 *location, Elf_Addr v)\r\n{\r\n*location = (*location & 0xffff0000) | (v & 0xffff);\r\nreturn 0;\r\n}\r\nstatic int apply_r_mips_64_rela(struct module *me, u32 *location, Elf_Addr v)\r\n{\r\n*(Elf_Addr *)location = v;\r\nreturn 0;\r\n}\r\nstatic int apply_r_mips_higher_rela(struct module *me, u32 *location,\r\nElf_Addr v)\r\n{\r\n*location = (*location & 0xffff0000) |\r\n((((long long) v + 0x80008000LL) >> 32) & 0xffff);\r\nreturn 0;\r\n}\r\nstatic int apply_r_mips_highest_rela(struct module *me, u32 *location,\r\nElf_Addr v)\r\n{\r\n*location = (*location & 0xffff0000) |\r\n((((long long) v + 0x800080008000LL) >> 48) & 0xffff);\r\nreturn 0;\r\n}\r\nint apply_relocate_add(Elf_Shdr *sechdrs, const char *strtab,\r\nunsigned int symindex, unsigned int relsec,\r\nstruct module *me)\r\n{\r\nElf_Mips_Rela *rel = (void *) sechdrs[relsec].sh_addr;\r\nElf_Sym *sym;\r\nu32 *location;\r\nunsigned int i;\r\nElf_Addr v;\r\nint res;\r\npr_debug("Applying relocate section %u to %u\n", relsec,\r\nsechdrs[relsec].sh_info);\r\nfor (i = 0; i < sechdrs[relsec].sh_size / sizeof(*rel); i++) {\r\nlocation = (void *)sechdrs[sechdrs[relsec].sh_info].sh_addr\r\n+ rel[i].r_offset;\r\nsym = (Elf_Sym *)sechdrs[symindex].sh_addr\r\n+ ELF_MIPS_R_SYM(rel[i]);\r\nif (IS_ERR_VALUE(sym->st_value)) {\r\nif (ELF_ST_BIND(sym->st_info) == STB_WEAK)\r\ncontinue;\r\nprintk(KERN_WARNING "%s: Unknown symbol %s\n",\r\nme->name, strtab + sym->st_name);\r\nreturn -ENOENT;\r\n}\r\nv = sym->st_value + rel[i].r_addend;\r\nres = reloc_handlers_rela[ELF_MIPS_R_TYPE(rel[i])](me, location, v);\r\nif (res)\r\nreturn res;\r\n}\r\nreturn 0;\r\n}

static int sirf_audio_hp_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *ctrl, int event)\r\n{\r\nstruct snd_soc_dapm_context *dapm = w->dapm;\r\nstruct snd_soc_card *card = dapm->card;\r\nstruct sirf_audio_card *sirf_audio_card = snd_soc_card_get_drvdata(card);\r\nint on = !SND_SOC_DAPM_EVENT_OFF(event);\r\nif (gpio_is_valid(sirf_audio_card->gpio_hp_pa))\r\ngpio_set_value(sirf_audio_card->gpio_hp_pa, on);\r\nreturn 0;\r\n}\r\nstatic int sirf_audio_spk_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *ctrl, int event)\r\n{\r\nstruct snd_soc_dapm_context *dapm = w->dapm;\r\nstruct snd_soc_card *card = dapm->card;\r\nstruct sirf_audio_card *sirf_audio_card = snd_soc_card_get_drvdata(card);\r\nint on = !SND_SOC_DAPM_EVENT_OFF(event);\r\nif (gpio_is_valid(sirf_audio_card->gpio_spk_pa))\r\ngpio_set_value(sirf_audio_card->gpio_spk_pa, on);\r\nreturn 0;\r\n}\r\nstatic int sirf_audio_probe(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = &snd_soc_sirf_audio_card;\r\nstruct sirf_audio_card *sirf_audio_card;\r\nint ret;\r\nsirf_audio_card = devm_kzalloc(&pdev->dev, sizeof(struct sirf_audio_card),\r\nGFP_KERNEL);\r\nif (sirf_audio_card == NULL)\r\nreturn -ENOMEM;\r\nsirf_audio_dai_link[0].cpu_of_node =\r\nof_parse_phandle(pdev->dev.of_node, "sirf,audio-platform", 0);\r\nsirf_audio_dai_link[0].platform_of_node =\r\nof_parse_phandle(pdev->dev.of_node, "sirf,audio-platform", 0);\r\nsirf_audio_dai_link[0].codec_of_node =\r\nof_parse_phandle(pdev->dev.of_node, "sirf,audio-codec", 0);\r\nsirf_audio_card->gpio_spk_pa = of_get_named_gpio(pdev->dev.of_node,\r\n"spk-pa-gpios", 0);\r\nsirf_audio_card->gpio_hp_pa = of_get_named_gpio(pdev->dev.of_node,\r\n"hp-pa-gpios", 0);\r\nif (gpio_is_valid(sirf_audio_card->gpio_spk_pa)) {\r\nret = devm_gpio_request_one(&pdev->dev,\r\nsirf_audio_card->gpio_spk_pa,\r\nGPIOF_OUT_INIT_LOW, "SPA_PA_SD");\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"Failed to request GPIO_%d for reset: %d\n",\r\nsirf_audio_card->gpio_spk_pa, ret);\r\nreturn ret;\r\n}\r\n}\r\nif (gpio_is_valid(sirf_audio_card->gpio_hp_pa)) {\r\nret = devm_gpio_request_one(&pdev->dev,\r\nsirf_audio_card->gpio_hp_pa,\r\nGPIOF_OUT_INIT_LOW, "HP_PA_SD");\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"Failed to request GPIO_%d for reset: %d\n",\r\nsirf_audio_card->gpio_hp_pa, ret);\r\nreturn ret;\r\n}\r\n}\r\ncard->dev = &pdev->dev;\r\nsnd_soc_card_set_drvdata(card, sirf_audio_card);\r\nret = devm_snd_soc_register_card(&pdev->dev, card);\r\nif (ret)\r\ndev_err(&pdev->dev, "snd_soc_register_card() failed:%d\n", ret);\r\nreturn ret;\r\n}

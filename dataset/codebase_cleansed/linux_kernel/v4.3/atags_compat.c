static struct tag * __init memtag(struct tag *tag, unsigned long start, unsigned long size)\r\n{\r\ntag = tag_next(tag);\r\ntag->hdr.tag = ATAG_MEM;\r\ntag->hdr.size = tag_size(tag_mem32);\r\ntag->u.mem.size = size;\r\ntag->u.mem.start = start;\r\nreturn tag;\r\n}\r\nstatic void __init build_tag_list(struct param_struct *params, void *taglist)\r\n{\r\nstruct tag *tag = taglist;\r\nif (params->u1.s.page_size != PAGE_SIZE) {\r\npr_warn("Warning: bad configuration page, trying to continue\n");\r\nreturn;\r\n}\r\nprintk(KERN_DEBUG "Converting old-style param struct to taglist\n");\r\n#ifdef CONFIG_ARCH_NETWINDER\r\nif (params->u1.s.nr_pages != 0x02000 &&\r\nparams->u1.s.nr_pages != 0x04000 &&\r\nparams->u1.s.nr_pages != 0x08000 &&\r\nparams->u1.s.nr_pages != 0x10000) {\r\npr_warn("Warning: bad NeTTrom parameters detected, using defaults\n");\r\nparams->u1.s.nr_pages = 0x1000;\r\nparams->u1.s.ramdisk_size = 0;\r\nparams->u1.s.flags = FLAG_READONLY;\r\nparams->u1.s.initrd_start = 0;\r\nparams->u1.s.initrd_size = 0;\r\nparams->u1.s.rd_start = 0;\r\n}\r\n#endif\r\ntag->hdr.tag = ATAG_CORE;\r\ntag->hdr.size = tag_size(tag_core);\r\ntag->u.core.flags = params->u1.s.flags & FLAG_READONLY;\r\ntag->u.core.pagesize = params->u1.s.page_size;\r\ntag->u.core.rootdev = params->u1.s.rootdev;\r\ntag = tag_next(tag);\r\ntag->hdr.tag = ATAG_RAMDISK;\r\ntag->hdr.size = tag_size(tag_ramdisk);\r\ntag->u.ramdisk.flags = (params->u1.s.flags & FLAG_RDLOAD ? 1 : 0) |\r\n(params->u1.s.flags & FLAG_RDPROMPT ? 2 : 0);\r\ntag->u.ramdisk.size = params->u1.s.ramdisk_size;\r\ntag->u.ramdisk.start = params->u1.s.rd_start;\r\ntag = tag_next(tag);\r\ntag->hdr.tag = ATAG_INITRD;\r\ntag->hdr.size = tag_size(tag_initrd);\r\ntag->u.initrd.start = params->u1.s.initrd_start;\r\ntag->u.initrd.size = params->u1.s.initrd_size;\r\ntag = tag_next(tag);\r\ntag->hdr.tag = ATAG_SERIAL;\r\ntag->hdr.size = tag_size(tag_serialnr);\r\ntag->u.serialnr.low = params->u1.s.system_serial_low;\r\ntag->u.serialnr.high = params->u1.s.system_serial_high;\r\ntag = tag_next(tag);\r\ntag->hdr.tag = ATAG_REVISION;\r\ntag->hdr.size = tag_size(tag_revision);\r\ntag->u.revision.rev = params->u1.s.system_rev;\r\n#ifdef CONFIG_ARCH_ACORN\r\nif (machine_is_riscpc()) {\r\nint i;\r\nfor (i = 0; i < 4; i++)\r\ntag = memtag(tag, PHYS_OFFSET + (i << 26),\r\nparams->u1.s.pages_in_bank[i] * PAGE_SIZE);\r\n} else\r\n#endif\r\ntag = memtag(tag, PHYS_OFFSET, params->u1.s.nr_pages * PAGE_SIZE);\r\n#ifdef CONFIG_FOOTBRIDGE\r\nif (params->u1.s.mem_fclk_21285) {\r\ntag = tag_next(tag);\r\ntag->hdr.tag = ATAG_MEMCLK;\r\ntag->hdr.size = tag_size(tag_memclk);\r\ntag->u.memclk.fmemclk = params->u1.s.mem_fclk_21285;\r\n}\r\n#endif\r\n#ifdef CONFIG_ARCH_EBSA285\r\nif (machine_is_ebsa285()) {\r\ntag = tag_next(tag);\r\ntag->hdr.tag = ATAG_VIDEOTEXT;\r\ntag->hdr.size = tag_size(tag_videotext);\r\ntag->u.videotext.x = params->u1.s.video_x;\r\ntag->u.videotext.y = params->u1.s.video_y;\r\ntag->u.videotext.video_page = 0;\r\ntag->u.videotext.video_mode = 0;\r\ntag->u.videotext.video_cols = params->u1.s.video_num_cols;\r\ntag->u.videotext.video_ega_bx = 0;\r\ntag->u.videotext.video_lines = params->u1.s.video_num_rows;\r\ntag->u.videotext.video_isvga = 1;\r\ntag->u.videotext.video_points = 8;\r\n}\r\n#endif\r\n#ifdef CONFIG_ARCH_ACORN\r\ntag = tag_next(tag);\r\ntag->hdr.tag = ATAG_ACORN;\r\ntag->hdr.size = tag_size(tag_acorn);\r\ntag->u.acorn.memc_control_reg = params->u1.s.memc_control_reg;\r\ntag->u.acorn.vram_pages = params->u1.s.pages_in_vram;\r\ntag->u.acorn.sounddefault = params->u1.s.sounddefault;\r\ntag->u.acorn.adfsdrives = params->u1.s.adfsdrives;\r\n#endif\r\ntag = tag_next(tag);\r\ntag->hdr.tag = ATAG_CMDLINE;\r\ntag->hdr.size = (strlen(params->commandline) + 3 +\r\nsizeof(struct tag_header)) >> 2;\r\nstrcpy(tag->u.cmdline.cmdline, params->commandline);\r\ntag = tag_next(tag);\r\ntag->hdr.tag = ATAG_NONE;\r\ntag->hdr.size = 0;\r\nmemmove(params, taglist, ((int)tag) - ((int)taglist) +\r\nsizeof(struct tag_header));\r\n}\r\nvoid __init convert_to_tag_list(struct tag *tags)\r\n{\r\nstruct param_struct *params = (struct param_struct *)tags;\r\nbuild_tag_list(params, &params->u2);\r\n}

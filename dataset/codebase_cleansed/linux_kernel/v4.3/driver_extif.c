static inline u32 extif_read32(struct ssb_extif *extif, u16 offset)\r\n{\r\nreturn ssb_read32(extif->dev, offset);\r\n}\r\nstatic inline void extif_write32(struct ssb_extif *extif, u16 offset, u32 value)\r\n{\r\nssb_write32(extif->dev, offset, value);\r\n}\r\nstatic inline u32 extif_write32_masked(struct ssb_extif *extif, u16 offset,\r\nu32 mask, u32 value)\r\n{\r\nvalue &= mask;\r\nvalue |= extif_read32(extif, offset) & ~mask;\r\nextif_write32(extif, offset, value);\r\nreturn value;\r\n}\r\nstatic bool serial_exists(u8 *regs)\r\n{\r\nu8 save_mcr, msr = 0;\r\nif (regs) {\r\nsave_mcr = regs[UART_MCR];\r\nregs[UART_MCR] = (UART_MCR_LOOP | UART_MCR_OUT2 | UART_MCR_RTS);\r\nmsr = regs[UART_MSR] & (UART_MSR_DCD | UART_MSR_RI\r\n| UART_MSR_CTS | UART_MSR_DSR);\r\nregs[UART_MCR] = save_mcr;\r\n}\r\nreturn (msr == (UART_MSR_DCD | UART_MSR_CTS));\r\n}\r\nint ssb_extif_serial_init(struct ssb_extif *extif, struct ssb_serial_port *ports)\r\n{\r\nu32 i, nr_ports = 0;\r\nextif_write32(extif, SSB_EXTIF_GPIO_INTPOL, 0);\r\nextif_write32(extif, SSB_EXTIF_GPIO_INTMASK, 0);\r\nfor (i = 0; i < 2; i++) {\r\nvoid __iomem *uart_regs;\r\nuart_regs = ioremap_nocache(SSB_EUART, 16);\r\nif (uart_regs) {\r\nuart_regs += (i * 8);\r\nif (serial_exists(uart_regs) && ports) {\r\nextif_write32(extif, SSB_EXTIF_GPIO_INTMASK, 2);\r\nnr_ports++;\r\nports[i].regs = uart_regs;\r\nports[i].irq = 2;\r\nports[i].baud_base = 13500000;\r\nports[i].reg_shift = 0;\r\n}\r\niounmap(uart_regs);\r\n}\r\n}\r\nreturn nr_ports;\r\n}\r\nvoid ssb_extif_timing_init(struct ssb_extif *extif, unsigned long ns)\r\n{\r\nu32 tmp;\r\nextif_write32(extif, SSB_EXTIF_PROG_CFG, SSB_EXTCFG_EN);\r\ntmp = DIV_ROUND_UP(10, ns) << SSB_PROG_WCNT_3_SHIFT;\r\ntmp |= DIV_ROUND_UP(40, ns) << SSB_PROG_WCNT_1_SHIFT;\r\ntmp |= DIV_ROUND_UP(120, ns);\r\nextif_write32(extif, SSB_EXTIF_PROG_WAITCNT, tmp);\r\ntmp = DIV_ROUND_UP(10, ns) << SSB_PROG_WCNT_3_SHIFT;\r\ntmp |= DIV_ROUND_UP(20, ns) << SSB_PROG_WCNT_2_SHIFT;\r\ntmp |= DIV_ROUND_UP(100, ns) << SSB_PROG_WCNT_1_SHIFT;\r\ntmp |= DIV_ROUND_UP(120, ns);\r\nextif_write32(extif, SSB_EXTIF_PROG_WAITCNT, tmp);\r\n}\r\nvoid ssb_extif_get_clockcontrol(struct ssb_extif *extif,\r\nu32 *pll_type, u32 *n, u32 *m)\r\n{\r\n*pll_type = SSB_PLLTYPE_1;\r\n*n = extif_read32(extif, SSB_EXTIF_CLOCK_N);\r\n*m = extif_read32(extif, SSB_EXTIF_CLOCK_SB);\r\n}\r\nu32 ssb_extif_watchdog_timer_set_wdt(struct bcm47xx_wdt *wdt, u32 ticks)\r\n{\r\nstruct ssb_extif *extif = bcm47xx_wdt_get_drvdata(wdt);\r\nreturn ssb_extif_watchdog_timer_set(extif, ticks);\r\n}\r\nu32 ssb_extif_watchdog_timer_set_ms(struct bcm47xx_wdt *wdt, u32 ms)\r\n{\r\nstruct ssb_extif *extif = bcm47xx_wdt_get_drvdata(wdt);\r\nu32 ticks = (SSB_EXTIF_WATCHDOG_CLK / 1000) * ms;\r\nticks = ssb_extif_watchdog_timer_set(extif, ticks);\r\nreturn (ticks * 1000) / SSB_EXTIF_WATCHDOG_CLK;\r\n}\r\nu32 ssb_extif_watchdog_timer_set(struct ssb_extif *extif, u32 ticks)\r\n{\r\nif (ticks > SSB_EXTIF_WATCHDOG_MAX_TIMER)\r\nticks = SSB_EXTIF_WATCHDOG_MAX_TIMER;\r\nextif_write32(extif, SSB_EXTIF_WATCHDOG, ticks);\r\nreturn ticks;\r\n}\r\nvoid ssb_extif_init(struct ssb_extif *extif)\r\n{\r\nif (!extif->dev)\r\nreturn;\r\nspin_lock_init(&extif->gpio_lock);\r\n}\r\nu32 ssb_extif_gpio_in(struct ssb_extif *extif, u32 mask)\r\n{\r\nreturn extif_read32(extif, SSB_EXTIF_GPIO_IN) & mask;\r\n}\r\nu32 ssb_extif_gpio_out(struct ssb_extif *extif, u32 mask, u32 value)\r\n{\r\nunsigned long flags;\r\nu32 res = 0;\r\nspin_lock_irqsave(&extif->gpio_lock, flags);\r\nres = extif_write32_masked(extif, SSB_EXTIF_GPIO_OUT(0),\r\nmask, value);\r\nspin_unlock_irqrestore(&extif->gpio_lock, flags);\r\nreturn res;\r\n}\r\nu32 ssb_extif_gpio_outen(struct ssb_extif *extif, u32 mask, u32 value)\r\n{\r\nunsigned long flags;\r\nu32 res = 0;\r\nspin_lock_irqsave(&extif->gpio_lock, flags);\r\nres = extif_write32_masked(extif, SSB_EXTIF_GPIO_OUTEN(0),\r\nmask, value);\r\nspin_unlock_irqrestore(&extif->gpio_lock, flags);\r\nreturn res;\r\n}\r\nu32 ssb_extif_gpio_polarity(struct ssb_extif *extif, u32 mask, u32 value)\r\n{\r\nunsigned long flags;\r\nu32 res = 0;\r\nspin_lock_irqsave(&extif->gpio_lock, flags);\r\nres = extif_write32_masked(extif, SSB_EXTIF_GPIO_INTPOL, mask, value);\r\nspin_unlock_irqrestore(&extif->gpio_lock, flags);\r\nreturn res;\r\n}\r\nu32 ssb_extif_gpio_intmask(struct ssb_extif *extif, u32 mask, u32 value)\r\n{\r\nunsigned long flags;\r\nu32 res = 0;\r\nspin_lock_irqsave(&extif->gpio_lock, flags);\r\nres = extif_write32_masked(extif, SSB_EXTIF_GPIO_INTMASK, mask, value);\r\nspin_unlock_irqrestore(&extif->gpio_lock, flags);\r\nreturn res;\r\n}

static void cvm_oct_get_drvinfo(struct net_device *dev,\r\nstruct ethtool_drvinfo *info)\r\n{\r\nstrlcpy(info->driver, KBUILD_MODNAME, sizeof(info->driver));\r\nstrlcpy(info->version, UTS_RELEASE, sizeof(info->version));\r\nstrlcpy(info->bus_info, "Builtin", sizeof(info->bus_info));\r\n}\r\nstatic int cvm_oct_get_settings(struct net_device *dev, struct ethtool_cmd *cmd)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nif (priv->phydev)\r\nreturn phy_ethtool_gset(priv->phydev, cmd);\r\nreturn -EINVAL;\r\n}\r\nstatic int cvm_oct_set_settings(struct net_device *dev, struct ethtool_cmd *cmd)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nif (priv->phydev)\r\nreturn phy_ethtool_sset(priv->phydev, cmd);\r\nreturn -EINVAL;\r\n}\r\nstatic int cvm_oct_nway_reset(struct net_device *dev)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nif (priv->phydev)\r\nreturn phy_start_aneg(priv->phydev);\r\nreturn -EINVAL;\r\n}\r\nint cvm_oct_ioctl(struct net_device *dev, struct ifreq *rq, int cmd)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nif (!netif_running(dev))\r\nreturn -EINVAL;\r\nif (!priv->phydev)\r\nreturn -EINVAL;\r\nreturn phy_mii_ioctl(priv->phydev, rq, cmd);\r\n}\r\nvoid cvm_oct_note_carrier(struct octeon_ethernet *priv,\r\ncvmx_helper_link_info_t li)\r\n{\r\nif (li.s.link_up) {\r\npr_notice_ratelimited("%s: %u Mbps %s duplex, port %d, queue %d\n",\r\nnetdev_name(priv->netdev), li.s.speed,\r\n(li.s.full_duplex) ? "Full" : "Half",\r\npriv->port, priv->queue);\r\n} else {\r\npr_notice_ratelimited("%s: Link down\n",\r\nnetdev_name(priv->netdev));\r\n}\r\n}\r\nvoid cvm_oct_adjust_link(struct net_device *dev)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\ncvmx_helper_link_info_t link_info;\r\nif (priv->last_link != priv->phydev->link) {\r\npriv->last_link = priv->phydev->link;\r\nlink_info.u64 = 0;\r\nlink_info.s.link_up = priv->last_link ? 1 : 0;\r\nlink_info.s.full_duplex = priv->phydev->duplex ? 1 : 0;\r\nlink_info.s.speed = priv->phydev->speed;\r\ncvmx_helper_link_set(priv->port, link_info);\r\ncvm_oct_note_carrier(priv, link_info);\r\n}\r\n}\r\nint cvm_oct_common_stop(struct net_device *dev)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nint interface = INTERFACE(priv->port);\r\ncvmx_helper_link_info_t link_info;\r\nunion cvmx_gmxx_prtx_cfg gmx_cfg;\r\nint index = INDEX(priv->port);\r\ngmx_cfg.u64 = cvmx_read_csr(CVMX_GMXX_PRTX_CFG(index, interface));\r\ngmx_cfg.s.en = 0;\r\ncvmx_write_csr(CVMX_GMXX_PRTX_CFG(index, interface), gmx_cfg.u64);\r\npriv->poll = NULL;\r\nif (priv->phydev)\r\nphy_disconnect(priv->phydev);\r\npriv->phydev = NULL;\r\nif (priv->last_link) {\r\nlink_info.u64 = 0;\r\npriv->last_link = 0;\r\ncvmx_helper_link_set(priv->port, link_info);\r\ncvm_oct_note_carrier(priv, link_info);\r\n}\r\nreturn 0;\r\n}\r\nint cvm_oct_phy_setup_device(struct net_device *dev)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nstruct device_node *phy_node;\r\nif (!priv->of_node)\r\ngoto no_phy;\r\nphy_node = of_parse_phandle(priv->of_node, "phy-handle", 0);\r\nif (!phy_node)\r\ngoto no_phy;\r\npriv->phydev = of_phy_connect(dev, phy_node, cvm_oct_adjust_link, 0,\r\nPHY_INTERFACE_MODE_GMII);\r\nif (priv->phydev == NULL)\r\nreturn -ENODEV;\r\npriv->last_link = 0;\r\nphy_start_aneg(priv->phydev);\r\nreturn 0;\r\nno_phy:\r\nnetif_carrier_on(dev);\r\nreturn 0;\r\n}

static void random_recv_done(struct virtqueue *vq)\r\n{\r\nstruct virtrng_info *vi = vq->vdev->priv;\r\nif (!virtqueue_get_buf(vi->vq, &vi->data_avail))\r\nreturn;\r\ncomplete(&vi->have_data);\r\n}\r\nstatic void register_buffer(struct virtrng_info *vi, u8 *buf, size_t size)\r\n{\r\nstruct scatterlist sg;\r\nsg_init_one(&sg, buf, size);\r\nvirtqueue_add_inbuf(vi->vq, &sg, 1, buf, GFP_KERNEL);\r\nvirtqueue_kick(vi->vq);\r\n}\r\nstatic int virtio_read(struct hwrng *rng, void *buf, size_t size, bool wait)\r\n{\r\nint ret;\r\nstruct virtrng_info *vi = (struct virtrng_info *)rng->priv;\r\nif (vi->hwrng_removed)\r\nreturn -ENODEV;\r\nif (!vi->busy) {\r\nvi->busy = true;\r\ninit_completion(&vi->have_data);\r\nregister_buffer(vi, buf, size);\r\n}\r\nif (!wait)\r\nreturn 0;\r\nret = wait_for_completion_killable(&vi->have_data);\r\nif (ret < 0)\r\nreturn ret;\r\nvi->busy = false;\r\nreturn vi->data_avail;\r\n}\r\nstatic void virtio_cleanup(struct hwrng *rng)\r\n{\r\nstruct virtrng_info *vi = (struct virtrng_info *)rng->priv;\r\nif (vi->busy)\r\nwait_for_completion(&vi->have_data);\r\n}\r\nstatic int probe_common(struct virtio_device *vdev)\r\n{\r\nint err, index;\r\nstruct virtrng_info *vi = NULL;\r\nvi = kzalloc(sizeof(struct virtrng_info), GFP_KERNEL);\r\nif (!vi)\r\nreturn -ENOMEM;\r\nvi->index = index = ida_simple_get(&rng_index_ida, 0, 0, GFP_KERNEL);\r\nif (index < 0) {\r\nerr = index;\r\ngoto err_ida;\r\n}\r\nsprintf(vi->name, "virtio_rng.%d", index);\r\ninit_completion(&vi->have_data);\r\nvi->hwrng = (struct hwrng) {\r\n.read = virtio_read,\r\n.cleanup = virtio_cleanup,\r\n.priv = (unsigned long)vi,\r\n.name = vi->name,\r\n.quality = 1000,\r\n};\r\nvdev->priv = vi;\r\nvi->vq = virtio_find_single_vq(vdev, random_recv_done, "input");\r\nif (IS_ERR(vi->vq)) {\r\nerr = PTR_ERR(vi->vq);\r\ngoto err_find;\r\n}\r\nreturn 0;\r\nerr_find:\r\nida_simple_remove(&rng_index_ida, index);\r\nerr_ida:\r\nkfree(vi);\r\nreturn err;\r\n}\r\nstatic void remove_common(struct virtio_device *vdev)\r\n{\r\nstruct virtrng_info *vi = vdev->priv;\r\nvi->hwrng_removed = true;\r\nvi->data_avail = 0;\r\ncomplete(&vi->have_data);\r\nvdev->config->reset(vdev);\r\nvi->busy = false;\r\nif (vi->hwrng_register_done)\r\nhwrng_unregister(&vi->hwrng);\r\nvdev->config->del_vqs(vdev);\r\nida_simple_remove(&rng_index_ida, vi->index);\r\nkfree(vi);\r\n}\r\nstatic int virtrng_probe(struct virtio_device *vdev)\r\n{\r\nreturn probe_common(vdev);\r\n}\r\nstatic void virtrng_remove(struct virtio_device *vdev)\r\n{\r\nremove_common(vdev);\r\n}\r\nstatic void virtrng_scan(struct virtio_device *vdev)\r\n{\r\nstruct virtrng_info *vi = vdev->priv;\r\nint err;\r\nerr = hwrng_register(&vi->hwrng);\r\nif (!err)\r\nvi->hwrng_register_done = true;\r\n}\r\nstatic int virtrng_freeze(struct virtio_device *vdev)\r\n{\r\nremove_common(vdev);\r\nreturn 0;\r\n}\r\nstatic int virtrng_restore(struct virtio_device *vdev)\r\n{\r\nreturn probe_common(vdev);\r\n}

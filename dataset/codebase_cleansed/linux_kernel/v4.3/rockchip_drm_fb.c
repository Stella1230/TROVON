struct drm_gem_object *rockchip_fb_get_gem_obj(struct drm_framebuffer *fb,\r\nunsigned int plane)\r\n{\r\nstruct rockchip_drm_fb *rk_fb = to_rockchip_fb(fb);\r\nif (plane >= ROCKCHIP_MAX_FB_BUFFER)\r\nreturn NULL;\r\nreturn rk_fb->obj[plane];\r\n}\r\nstatic void rockchip_drm_fb_destroy(struct drm_framebuffer *fb)\r\n{\r\nstruct rockchip_drm_fb *rockchip_fb = to_rockchip_fb(fb);\r\nstruct drm_gem_object *obj;\r\nint i;\r\nfor (i = 0; i < ROCKCHIP_MAX_FB_BUFFER; i++) {\r\nobj = rockchip_fb->obj[i];\r\nif (obj)\r\ndrm_gem_object_unreference_unlocked(obj);\r\n}\r\ndrm_framebuffer_cleanup(fb);\r\nkfree(rockchip_fb);\r\n}\r\nstatic int rockchip_drm_fb_create_handle(struct drm_framebuffer *fb,\r\nstruct drm_file *file_priv,\r\nunsigned int *handle)\r\n{\r\nstruct rockchip_drm_fb *rockchip_fb = to_rockchip_fb(fb);\r\nreturn drm_gem_handle_create(file_priv,\r\nrockchip_fb->obj[0], handle);\r\n}\r\nstatic struct rockchip_drm_fb *\r\nrockchip_fb_alloc(struct drm_device *dev, struct drm_mode_fb_cmd2 *mode_cmd,\r\nstruct drm_gem_object **obj, unsigned int num_planes)\r\n{\r\nstruct rockchip_drm_fb *rockchip_fb;\r\nint ret;\r\nint i;\r\nrockchip_fb = kzalloc(sizeof(*rockchip_fb), GFP_KERNEL);\r\nif (!rockchip_fb)\r\nreturn ERR_PTR(-ENOMEM);\r\ndrm_helper_mode_fill_fb_struct(&rockchip_fb->fb, mode_cmd);\r\nfor (i = 0; i < num_planes; i++)\r\nrockchip_fb->obj[i] = obj[i];\r\nret = drm_framebuffer_init(dev, &rockchip_fb->fb,\r\n&rockchip_drm_fb_funcs);\r\nif (ret) {\r\ndev_err(dev->dev, "Failed to initialize framebuffer: %d\n",\r\nret);\r\nkfree(rockchip_fb);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn rockchip_fb;\r\n}\r\nstatic struct drm_framebuffer *\r\nrockchip_user_fb_create(struct drm_device *dev, struct drm_file *file_priv,\r\nstruct drm_mode_fb_cmd2 *mode_cmd)\r\n{\r\nstruct rockchip_drm_fb *rockchip_fb;\r\nstruct drm_gem_object *objs[ROCKCHIP_MAX_FB_BUFFER];\r\nstruct drm_gem_object *obj;\r\nunsigned int hsub;\r\nunsigned int vsub;\r\nint num_planes;\r\nint ret;\r\nint i;\r\nhsub = drm_format_horz_chroma_subsampling(mode_cmd->pixel_format);\r\nvsub = drm_format_vert_chroma_subsampling(mode_cmd->pixel_format);\r\nnum_planes = min(drm_format_num_planes(mode_cmd->pixel_format),\r\nROCKCHIP_MAX_FB_BUFFER);\r\nfor (i = 0; i < num_planes; i++) {\r\nunsigned int width = mode_cmd->width / (i ? hsub : 1);\r\nunsigned int height = mode_cmd->height / (i ? vsub : 1);\r\nunsigned int min_size;\r\nobj = drm_gem_object_lookup(dev, file_priv,\r\nmode_cmd->handles[i]);\r\nif (!obj) {\r\ndev_err(dev->dev, "Failed to lookup GEM object\n");\r\nret = -ENXIO;\r\ngoto err_gem_object_unreference;\r\n}\r\nmin_size = (height - 1) * mode_cmd->pitches[i] +\r\nmode_cmd->offsets[i] +\r\nwidth * drm_format_plane_cpp(mode_cmd->pixel_format, i);\r\nif (obj->size < min_size) {\r\ndrm_gem_object_unreference_unlocked(obj);\r\nret = -EINVAL;\r\ngoto err_gem_object_unreference;\r\n}\r\nobjs[i] = obj;\r\n}\r\nrockchip_fb = rockchip_fb_alloc(dev, mode_cmd, objs, i);\r\nif (IS_ERR(rockchip_fb)) {\r\nret = PTR_ERR(rockchip_fb);\r\ngoto err_gem_object_unreference;\r\n}\r\nreturn &rockchip_fb->fb;\r\nerr_gem_object_unreference:\r\nfor (i--; i >= 0; i--)\r\ndrm_gem_object_unreference_unlocked(objs[i]);\r\nreturn ERR_PTR(ret);\r\n}\r\nstatic void rockchip_drm_output_poll_changed(struct drm_device *dev)\r\n{\r\nstruct rockchip_drm_private *private = dev->dev_private;\r\nstruct drm_fb_helper *fb_helper = &private->fbdev_helper;\r\nif (fb_helper)\r\ndrm_fb_helper_hotplug_event(fb_helper);\r\n}\r\nstruct drm_framebuffer *\r\nrockchip_drm_framebuffer_init(struct drm_device *dev,\r\nstruct drm_mode_fb_cmd2 *mode_cmd,\r\nstruct drm_gem_object *obj)\r\n{\r\nstruct rockchip_drm_fb *rockchip_fb;\r\nrockchip_fb = rockchip_fb_alloc(dev, mode_cmd, &obj, 1);\r\nif (IS_ERR(rockchip_fb))\r\nreturn NULL;\r\nreturn &rockchip_fb->fb;\r\n}\r\nvoid rockchip_drm_mode_config_init(struct drm_device *dev)\r\n{\r\ndev->mode_config.min_width = 0;\r\ndev->mode_config.min_height = 0;\r\ndev->mode_config.max_width = 4096;\r\ndev->mode_config.max_height = 4096;\r\ndev->mode_config.funcs = &rockchip_drm_mode_config_funcs;\r\n}

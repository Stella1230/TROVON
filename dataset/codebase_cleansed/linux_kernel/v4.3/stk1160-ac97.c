static void stk1160_write_ac97(struct snd_ac97 *ac97, u16 reg, u16 value)\r\n{\r\nstruct stk1160 *dev = ac97->private_data;\r\nstk1160_write_reg(dev, STK1160_AC97_ADDR, reg);\r\nstk1160_write_reg(dev, STK1160_AC97_CMD, value & 0xff);\r\nstk1160_write_reg(dev, STK1160_AC97_CMD + 1, (value & 0xff00) >> 8);\r\nstk1160_write_reg(dev, STK1160_AC97CTL_0, 0x8c);\r\n}\r\nstatic u16 stk1160_read_ac97(struct snd_ac97 *ac97, u16 reg)\r\n{\r\nstruct stk1160 *dev = ac97->private_data;\r\nu8 vall = 0;\r\nu8 valh = 0;\r\nstk1160_write_reg(dev, STK1160_AC97_ADDR, reg);\r\nstk1160_write_reg(dev, STK1160_AC97CTL_0, 0x8b);\r\nstk1160_read_reg(dev, STK1160_AC97_CMD, &vall);\r\nstk1160_read_reg(dev, STK1160_AC97_CMD + 1, &valh);\r\nreturn (valh << 8) | vall;\r\n}\r\nstatic void stk1160_reset_ac97(struct snd_ac97 *ac97)\r\n{\r\nstruct stk1160 *dev = ac97->private_data;\r\nstk1160_write_reg(dev, STK1160_AC97CTL_0, 0x94);\r\nstk1160_write_reg(dev, STK1160_AC97CTL_0, 0x88);\r\nstk1160_write_reg(dev, STK1160_AC97CTL_1 + 2, 0x01);\r\n}\r\nint stk1160_ac97_register(struct stk1160 *dev)\r\n{\r\nstruct snd_card *card = NULL;\r\nstruct snd_ac97_bus *ac97_bus;\r\nstruct snd_ac97_template ac97_template;\r\nint rc;\r\nrc = snd_card_new(dev->dev, SNDRV_DEFAULT_IDX1, SNDRV_DEFAULT_STR1,\r\nTHIS_MODULE, 0, &card);\r\nif (rc < 0)\r\nreturn rc;\r\nsnprintf(card->shortname, sizeof(card->shortname),\r\n"stk1160-mixer");\r\nsnprintf(card->longname, sizeof(card->longname),\r\n"stk1160 ac97 codec mixer control");\r\nstrlcpy(card->driver, dev->dev->driver->name, sizeof(card->driver));\r\nrc = snd_ac97_bus(card, 0, &stk1160_ac97_ops, NULL, &ac97_bus);\r\nif (rc)\r\ngoto err;\r\nmemset(&ac97_template, 0, sizeof(ac97_template));\r\nac97_template.private_data = dev;\r\nac97_template.scaps = AC97_SCAP_SKIP_MODEM;\r\nrc = snd_ac97_mixer(ac97_bus, &ac97_template, &stk1160_ac97);\r\nif (rc)\r\ngoto err;\r\ndev->snd_card = card;\r\nrc = snd_card_register(card);\r\nif (rc)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndev->snd_card = NULL;\r\nsnd_card_free(card);\r\nreturn rc;\r\n}\r\nint stk1160_ac97_unregister(struct stk1160 *dev)\r\n{\r\nstruct snd_card *card = dev->snd_card;\r\nif (card && dev->udev)\r\nsnd_card_free(card);\r\nreturn 0;\r\n}

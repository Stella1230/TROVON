static void __iomem * __init earlycon_map(unsigned long paddr, size_t size)\r\n{\r\nvoid __iomem *base;\r\n#ifdef CONFIG_FIX_EARLYCON_MEM\r\nset_fixmap_io(FIX_EARLYCON_MEM_BASE, paddr & PAGE_MASK);\r\nbase = (void __iomem *)__fix_to_virt(FIX_EARLYCON_MEM_BASE);\r\nbase += paddr & ~PAGE_MASK;\r\n#else\r\nbase = ioremap(paddr, size);\r\n#endif\r\nif (!base)\r\npr_err("%s: Couldn't map 0x%llx\n", __func__,\r\n(unsigned long long)paddr);\r\nreturn base;\r\n}\r\nstatic int __init parse_options(struct earlycon_device *device, char *options)\r\n{\r\nstruct uart_port *port = &device->port;\r\nint length;\r\nunsigned long addr;\r\nif (uart_parse_earlycon(options, &port->iotype, &addr, &options))\r\nreturn -EINVAL;\r\nswitch (port->iotype) {\r\ncase UPIO_MEM32:\r\ncase UPIO_MEM32BE:\r\nport->regshift = 2;\r\ncase UPIO_MEM:\r\nport->mapbase = addr;\r\nbreak;\r\ncase UPIO_PORT:\r\nport->iobase = addr;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (options) {\r\ndevice->baud = simple_strtoul(options, NULL, 0);\r\nlength = min(strcspn(options, " ") + 1,\r\n(size_t)(sizeof(device->options)));\r\nstrlcpy(device->options, options, length);\r\n}\r\nif (port->iotype == UPIO_MEM || port->iotype == UPIO_MEM32 ||\r\nport->iotype == UPIO_MEM32BE)\r\npr_info("Early serial console at MMIO%s 0x%llx (options '%s')\n",\r\n(port->iotype == UPIO_MEM) ? "" :\r\n(port->iotype == UPIO_MEM32) ? "32" : "32be",\r\n(unsigned long long)port->mapbase,\r\ndevice->options);\r\nelse\r\npr_info("Early serial console at I/O port 0x%lx (options '%s')\n",\r\nport->iobase,\r\ndevice->options);\r\nreturn 0;\r\n}\r\nstatic int __init register_earlycon(char *buf, const struct earlycon_id *match)\r\n{\r\nint err;\r\nstruct uart_port *port = &early_console_dev.port;\r\nif (buf && !parse_options(&early_console_dev, buf))\r\nbuf = NULL;\r\nport->uartclk = BASE_BAUD * 16;\r\nif (port->mapbase)\r\nport->membase = earlycon_map(port->mapbase, 64);\r\nearly_console_dev.con->data = &early_console_dev;\r\nerr = match->setup(&early_console_dev, buf);\r\nif (err < 0)\r\nreturn err;\r\nif (!early_console_dev.con->write)\r\nreturn -ENODEV;\r\nregister_console(early_console_dev.con);\r\nreturn 0;\r\n}\r\nint __init setup_earlycon(char *buf)\r\n{\r\nconst struct earlycon_id *match;\r\nif (!buf || !buf[0])\r\nreturn -EINVAL;\r\nif (early_con.flags & CON_ENABLED)\r\nreturn -EALREADY;\r\nfor (match = __earlycon_table; match->name[0]; match++) {\r\nsize_t len = strlen(match->name);\r\nif (strncmp(buf, match->name, len))\r\ncontinue;\r\nif (buf[len]) {\r\nif (buf[len] != ',')\r\ncontinue;\r\nbuf += len + 1;\r\n} else\r\nbuf = NULL;\r\nreturn register_earlycon(buf, match);\r\n}\r\nreturn -ENOENT;\r\n}\r\nstatic int __init param_setup_earlycon(char *buf)\r\n{\r\nint err;\r\nif (!buf || !buf[0])\r\nreturn 0;\r\nerr = setup_earlycon(buf);\r\nif (err == -ENOENT || err == -EALREADY)\r\nreturn 0;\r\nreturn err;\r\n}\r\nint __init of_setup_earlycon(unsigned long addr,\r\nint (*setup)(struct earlycon_device *, const char *))\r\n{\r\nint err;\r\nstruct uart_port *port = &early_console_dev.port;\r\nport->iotype = UPIO_MEM;\r\nport->mapbase = addr;\r\nport->uartclk = BASE_BAUD * 16;\r\nport->membase = earlycon_map(addr, SZ_4K);\r\nearly_console_dev.con->data = &early_console_dev;\r\nerr = setup(&early_console_dev, NULL);\r\nif (err < 0)\r\nreturn err;\r\nif (!early_console_dev.con->write)\r\nreturn -ENODEV;\r\nregister_console(early_console_dev.con);\r\nreturn 0;\r\n}

static struct resource *get_amba_resource(struct vfio_platform_device *vdev,\r\nint i)\r\n{\r\nstruct amba_device *adev = (struct amba_device *) vdev->opaque;\r\nif (i == 0)\r\nreturn &adev->res;\r\nreturn NULL;\r\n}\r\nstatic int get_amba_irq(struct vfio_platform_device *vdev, int i)\r\n{\r\nstruct amba_device *adev = (struct amba_device *) vdev->opaque;\r\nint ret = 0;\r\nif (i < AMBA_NR_IRQS)\r\nret = adev->irq[i];\r\nreturn ret ? ret : -ENXIO;\r\n}\r\nstatic int vfio_amba_probe(struct amba_device *adev, const struct amba_id *id)\r\n{\r\nstruct vfio_platform_device *vdev;\r\nint ret;\r\nvdev = kzalloc(sizeof(*vdev), GFP_KERNEL);\r\nif (!vdev)\r\nreturn -ENOMEM;\r\nvdev->name = kasprintf(GFP_KERNEL, "vfio-amba-%08x", adev->periphid);\r\nif (!vdev->name) {\r\nkfree(vdev);\r\nreturn -ENOMEM;\r\n}\r\nvdev->opaque = (void *) adev;\r\nvdev->flags = VFIO_DEVICE_FLAGS_AMBA;\r\nvdev->get_resource = get_amba_resource;\r\nvdev->get_irq = get_amba_irq;\r\nret = vfio_platform_probe_common(vdev, &adev->dev);\r\nif (ret) {\r\nkfree(vdev->name);\r\nkfree(vdev);\r\n}\r\nreturn ret;\r\n}\r\nstatic int vfio_amba_remove(struct amba_device *adev)\r\n{\r\nstruct vfio_platform_device *vdev;\r\nvdev = vfio_platform_remove_common(&adev->dev);\r\nif (vdev) {\r\nkfree(vdev->name);\r\nkfree(vdev);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}

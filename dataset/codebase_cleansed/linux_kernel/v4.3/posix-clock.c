static struct posix_clock *get_posix_clock(struct file *fp)\r\n{\r\nstruct posix_clock *clk = fp->private_data;\r\ndown_read(&clk->rwsem);\r\nif (!clk->zombie)\r\nreturn clk;\r\nup_read(&clk->rwsem);\r\nreturn NULL;\r\n}\r\nstatic void put_posix_clock(struct posix_clock *clk)\r\n{\r\nup_read(&clk->rwsem);\r\n}\r\nstatic ssize_t posix_clock_read(struct file *fp, char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct posix_clock *clk = get_posix_clock(fp);\r\nint err = -EINVAL;\r\nif (!clk)\r\nreturn -ENODEV;\r\nif (clk->ops.read)\r\nerr = clk->ops.read(clk, fp->f_flags, buf, count);\r\nput_posix_clock(clk);\r\nreturn err;\r\n}\r\nstatic unsigned int posix_clock_poll(struct file *fp, poll_table *wait)\r\n{\r\nstruct posix_clock *clk = get_posix_clock(fp);\r\nint result = 0;\r\nif (!clk)\r\nreturn -ENODEV;\r\nif (clk->ops.poll)\r\nresult = clk->ops.poll(clk, fp, wait);\r\nput_posix_clock(clk);\r\nreturn result;\r\n}\r\nstatic int posix_clock_fasync(int fd, struct file *fp, int on)\r\n{\r\nstruct posix_clock *clk = get_posix_clock(fp);\r\nint err = 0;\r\nif (!clk)\r\nreturn -ENODEV;\r\nif (clk->ops.fasync)\r\nerr = clk->ops.fasync(clk, fd, fp, on);\r\nput_posix_clock(clk);\r\nreturn err;\r\n}\r\nstatic int posix_clock_mmap(struct file *fp, struct vm_area_struct *vma)\r\n{\r\nstruct posix_clock *clk = get_posix_clock(fp);\r\nint err = -ENODEV;\r\nif (!clk)\r\nreturn -ENODEV;\r\nif (clk->ops.mmap)\r\nerr = clk->ops.mmap(clk, vma);\r\nput_posix_clock(clk);\r\nreturn err;\r\n}\r\nstatic long posix_clock_ioctl(struct file *fp,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nstruct posix_clock *clk = get_posix_clock(fp);\r\nint err = -ENOTTY;\r\nif (!clk)\r\nreturn -ENODEV;\r\nif (clk->ops.ioctl)\r\nerr = clk->ops.ioctl(clk, cmd, arg);\r\nput_posix_clock(clk);\r\nreturn err;\r\n}\r\nstatic long posix_clock_compat_ioctl(struct file *fp,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nstruct posix_clock *clk = get_posix_clock(fp);\r\nint err = -ENOTTY;\r\nif (!clk)\r\nreturn -ENODEV;\r\nif (clk->ops.ioctl)\r\nerr = clk->ops.ioctl(clk, cmd, arg);\r\nput_posix_clock(clk);\r\nreturn err;\r\n}\r\nstatic int posix_clock_open(struct inode *inode, struct file *fp)\r\n{\r\nint err;\r\nstruct posix_clock *clk =\r\ncontainer_of(inode->i_cdev, struct posix_clock, cdev);\r\ndown_read(&clk->rwsem);\r\nif (clk->zombie) {\r\nerr = -ENODEV;\r\ngoto out;\r\n}\r\nif (clk->ops.open)\r\nerr = clk->ops.open(clk, fp->f_mode);\r\nelse\r\nerr = 0;\r\nif (!err) {\r\nkref_get(&clk->kref);\r\nfp->private_data = clk;\r\n}\r\nout:\r\nup_read(&clk->rwsem);\r\nreturn err;\r\n}\r\nstatic int posix_clock_release(struct inode *inode, struct file *fp)\r\n{\r\nstruct posix_clock *clk = fp->private_data;\r\nint err = 0;\r\nif (clk->ops.release)\r\nerr = clk->ops.release(clk);\r\nkref_put(&clk->kref, delete_clock);\r\nfp->private_data = NULL;\r\nreturn err;\r\n}\r\nint posix_clock_register(struct posix_clock *clk, dev_t devid)\r\n{\r\nint err;\r\nkref_init(&clk->kref);\r\ninit_rwsem(&clk->rwsem);\r\ncdev_init(&clk->cdev, &posix_clock_file_operations);\r\nclk->cdev.owner = clk->ops.owner;\r\nerr = cdev_add(&clk->cdev, devid, 1);\r\nreturn err;\r\n}\r\nstatic void delete_clock(struct kref *kref)\r\n{\r\nstruct posix_clock *clk = container_of(kref, struct posix_clock, kref);\r\nif (clk->release)\r\nclk->release(clk);\r\n}\r\nvoid posix_clock_unregister(struct posix_clock *clk)\r\n{\r\ncdev_del(&clk->cdev);\r\ndown_write(&clk->rwsem);\r\nclk->zombie = true;\r\nup_write(&clk->rwsem);\r\nkref_put(&clk->kref, delete_clock);\r\n}\r\nstatic int get_clock_desc(const clockid_t id, struct posix_clock_desc *cd)\r\n{\r\nstruct file *fp = fget(CLOCKID_TO_FD(id));\r\nint err = -EINVAL;\r\nif (!fp)\r\nreturn err;\r\nif (fp->f_op->open != posix_clock_open || !fp->private_data)\r\ngoto out;\r\ncd->fp = fp;\r\ncd->clk = get_posix_clock(fp);\r\nerr = cd->clk ? 0 : -ENODEV;\r\nout:\r\nif (err)\r\nfput(fp);\r\nreturn err;\r\n}\r\nstatic void put_clock_desc(struct posix_clock_desc *cd)\r\n{\r\nput_posix_clock(cd->clk);\r\nfput(cd->fp);\r\n}\r\nstatic int pc_clock_adjtime(clockid_t id, struct timex *tx)\r\n{\r\nstruct posix_clock_desc cd;\r\nint err;\r\nerr = get_clock_desc(id, &cd);\r\nif (err)\r\nreturn err;\r\nif ((cd.fp->f_mode & FMODE_WRITE) == 0) {\r\nerr = -EACCES;\r\ngoto out;\r\n}\r\nif (cd.clk->ops.clock_adjtime)\r\nerr = cd.clk->ops.clock_adjtime(cd.clk, tx);\r\nelse\r\nerr = -EOPNOTSUPP;\r\nout:\r\nput_clock_desc(&cd);\r\nreturn err;\r\n}\r\nstatic int pc_clock_gettime(clockid_t id, struct timespec *ts)\r\n{\r\nstruct posix_clock_desc cd;\r\nint err;\r\nerr = get_clock_desc(id, &cd);\r\nif (err)\r\nreturn err;\r\nif (cd.clk->ops.clock_gettime)\r\nerr = cd.clk->ops.clock_gettime(cd.clk, ts);\r\nelse\r\nerr = -EOPNOTSUPP;\r\nput_clock_desc(&cd);\r\nreturn err;\r\n}\r\nstatic int pc_clock_getres(clockid_t id, struct timespec *ts)\r\n{\r\nstruct posix_clock_desc cd;\r\nint err;\r\nerr = get_clock_desc(id, &cd);\r\nif (err)\r\nreturn err;\r\nif (cd.clk->ops.clock_getres)\r\nerr = cd.clk->ops.clock_getres(cd.clk, ts);\r\nelse\r\nerr = -EOPNOTSUPP;\r\nput_clock_desc(&cd);\r\nreturn err;\r\n}\r\nstatic int pc_clock_settime(clockid_t id, const struct timespec *ts)\r\n{\r\nstruct posix_clock_desc cd;\r\nint err;\r\nerr = get_clock_desc(id, &cd);\r\nif (err)\r\nreturn err;\r\nif ((cd.fp->f_mode & FMODE_WRITE) == 0) {\r\nerr = -EACCES;\r\ngoto out;\r\n}\r\nif (cd.clk->ops.clock_settime)\r\nerr = cd.clk->ops.clock_settime(cd.clk, ts);\r\nelse\r\nerr = -EOPNOTSUPP;\r\nout:\r\nput_clock_desc(&cd);\r\nreturn err;\r\n}\r\nstatic int pc_timer_create(struct k_itimer *kit)\r\n{\r\nclockid_t id = kit->it_clock;\r\nstruct posix_clock_desc cd;\r\nint err;\r\nerr = get_clock_desc(id, &cd);\r\nif (err)\r\nreturn err;\r\nif (cd.clk->ops.timer_create)\r\nerr = cd.clk->ops.timer_create(cd.clk, kit);\r\nelse\r\nerr = -EOPNOTSUPP;\r\nput_clock_desc(&cd);\r\nreturn err;\r\n}\r\nstatic int pc_timer_delete(struct k_itimer *kit)\r\n{\r\nclockid_t id = kit->it_clock;\r\nstruct posix_clock_desc cd;\r\nint err;\r\nerr = get_clock_desc(id, &cd);\r\nif (err)\r\nreturn err;\r\nif (cd.clk->ops.timer_delete)\r\nerr = cd.clk->ops.timer_delete(cd.clk, kit);\r\nelse\r\nerr = -EOPNOTSUPP;\r\nput_clock_desc(&cd);\r\nreturn err;\r\n}\r\nstatic void pc_timer_gettime(struct k_itimer *kit, struct itimerspec *ts)\r\n{\r\nclockid_t id = kit->it_clock;\r\nstruct posix_clock_desc cd;\r\nif (get_clock_desc(id, &cd))\r\nreturn;\r\nif (cd.clk->ops.timer_gettime)\r\ncd.clk->ops.timer_gettime(cd.clk, kit, ts);\r\nput_clock_desc(&cd);\r\n}\r\nstatic int pc_timer_settime(struct k_itimer *kit, int flags,\r\nstruct itimerspec *ts, struct itimerspec *old)\r\n{\r\nclockid_t id = kit->it_clock;\r\nstruct posix_clock_desc cd;\r\nint err;\r\nerr = get_clock_desc(id, &cd);\r\nif (err)\r\nreturn err;\r\nif (cd.clk->ops.timer_settime)\r\nerr = cd.clk->ops.timer_settime(cd.clk, kit, flags, ts, old);\r\nelse\r\nerr = -EOPNOTSUPP;\r\nput_clock_desc(&cd);\r\nreturn err;\r\n}

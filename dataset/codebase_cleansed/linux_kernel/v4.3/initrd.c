static int __init read_initrd(void)\r\n{\r\nvoid *area;\r\nlong long size;\r\nint err;\r\nif (initrd == NULL)\r\nreturn 0;\r\nerr = os_file_size(initrd, &size);\r\nif (err)\r\nreturn 0;\r\nif (size == 0) {\r\nprintk(KERN_ERR "\"%s\" is a zero-size initrd\n", initrd);\r\nreturn 0;\r\n}\r\narea = alloc_bootmem(size);\r\nif (area == NULL)\r\nreturn 0;\r\nif (load_initrd(initrd, area, size) == -1)\r\nreturn 0;\r\ninitrd_start = (unsigned long) area;\r\ninitrd_end = initrd_start + size;\r\nreturn 0;\r\n}\r\nstatic int __init uml_initrd_setup(char *line, int *add)\r\n{\r\ninitrd = line;\r\nreturn 0;\r\n}\r\nstatic int load_initrd(char *filename, void *buf, int size)\r\n{\r\nint fd, n;\r\nfd = os_open_file(filename, of_read(OPENFLAGS()), 0);\r\nif (fd < 0) {\r\nprintk(KERN_ERR "Opening '%s' failed - err = %d\n", filename,\r\n-fd);\r\nreturn -1;\r\n}\r\nn = os_read_file(fd, buf, size);\r\nif (n != size) {\r\nprintk(KERN_ERR "Read of %d bytes from '%s' failed, "\r\n"err = %d\n", size,\r\nfilename, -n);\r\nreturn -1;\r\n}\r\nos_close_file(fd);\r\nreturn 0;\r\n}

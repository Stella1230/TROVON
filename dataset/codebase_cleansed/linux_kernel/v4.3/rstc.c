static int sirfsoc_reset_module(struct reset_controller_dev *rcdev,\r\nunsigned long sw_reset_idx)\r\n{\r\nu32 reset_bit = sw_reset_idx;\r\nif (reset_bit >= SIRFSOC_RSTBIT_NUM)\r\nreturn -EINVAL;\r\nmutex_lock(&rstc_lock);\r\nwritel(readl(sirfsoc_rstc_base +\r\n(reset_bit / 32) * 4) | (1 << reset_bit),\r\nsirfsoc_rstc_base + (reset_bit / 32) * 4);\r\nmsleep(20);\r\nwritel(readl(sirfsoc_rstc_base +\r\n(reset_bit / 32) * 4) & ~(1 << reset_bit),\r\nsirfsoc_rstc_base + (reset_bit / 32) * 4);\r\nmutex_unlock(&rstc_lock);\r\nreturn 0;\r\n}\r\nstatic void sirfsoc_restart(enum reboot_mode mode, const char *cmd)\r\n{\r\nwritel(SIRFSOC_SYS_RST_BIT, sirfsoc_rstc_base);\r\n}\r\nstatic int sirfsoc_rstc_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nsirfsoc_rstc_base = of_iomap(np, 0);\r\nif (!sirfsoc_rstc_base) {\r\ndev_err(&pdev->dev, "unable to map rstc cpu registers\n");\r\nreturn -ENOMEM;\r\n}\r\nsirfsoc_reset_controller.of_node = np;\r\narm_pm_restart = sirfsoc_restart;\r\nif (IS_ENABLED(CONFIG_RESET_CONTROLLER))\r\nreset_controller_register(&sirfsoc_reset_controller);\r\nreturn 0;\r\n}\r\nstatic int __init sirfsoc_rstc_init(void)\r\n{\r\nreturn platform_driver_register(&sirfsoc_rstc_driver);\r\n}

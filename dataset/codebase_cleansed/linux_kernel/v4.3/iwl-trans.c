struct iwl_trans *iwl_trans_alloc(unsigned int priv_size,\r\nstruct device *dev,\r\nconst struct iwl_cfg *cfg,\r\nconst struct iwl_trans_ops *ops,\r\nsize_t dev_cmd_headroom)\r\n{\r\nstruct iwl_trans *trans;\r\n#ifdef CONFIG_LOCKDEP\r\nstatic struct lock_class_key __key;\r\n#endif\r\ntrans = kzalloc(sizeof(*trans) + priv_size, GFP_KERNEL);\r\nif (!trans)\r\nreturn NULL;\r\n#ifdef CONFIG_LOCKDEP\r\nlockdep_init_map(&trans->sync_cmd_lockdep_map, "sync_cmd_lockdep_map",\r\n&__key, 0);\r\n#endif\r\ntrans->dev = dev;\r\ntrans->cfg = cfg;\r\ntrans->ops = ops;\r\ntrans->dev_cmd_headroom = dev_cmd_headroom;\r\nsnprintf(trans->dev_cmd_pool_name, sizeof(trans->dev_cmd_pool_name),\r\n"iwl_cmd_pool:%s", dev_name(trans->dev));\r\ntrans->dev_cmd_pool =\r\nkmem_cache_create(trans->dev_cmd_pool_name,\r\nsizeof(struct iwl_device_cmd)\r\n+ trans->dev_cmd_headroom,\r\nsizeof(void *),\r\nSLAB_HWCACHE_ALIGN,\r\nNULL);\r\nif (!trans->dev_cmd_pool)\r\ngoto free;\r\nreturn trans;\r\nfree:\r\nkfree(trans);\r\nreturn NULL;\r\n}\r\nvoid iwl_trans_free(struct iwl_trans *trans)\r\n{\r\nkmem_cache_destroy(trans->dev_cmd_pool);\r\nkfree(trans);\r\n}

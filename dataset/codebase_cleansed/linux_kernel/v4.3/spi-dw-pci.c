static int spi_pci_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nstruct dw_spi_pci *dwpci;\r\nstruct dw_spi *dws;\r\nstruct spi_pci_desc *desc = (struct spi_pci_desc *)ent->driver_data;\r\nint pci_bar = 0;\r\nint ret;\r\nret = pcim_enable_device(pdev);\r\nif (ret)\r\nreturn ret;\r\ndwpci = devm_kzalloc(&pdev->dev, sizeof(struct dw_spi_pci),\r\nGFP_KERNEL);\r\nif (!dwpci)\r\nreturn -ENOMEM;\r\ndwpci->pdev = pdev;\r\ndws = &dwpci->dws;\r\ndws->paddr = pci_resource_start(pdev, pci_bar);\r\nret = pcim_iomap_regions(pdev, 1 << pci_bar, pci_name(pdev));\r\nif (ret)\r\nreturn ret;\r\ndws->regs = pcim_iomap_table(pdev)[pci_bar];\r\ndws->irq = pdev->irq;\r\nif (desc) {\r\ndws->num_cs = desc->num_cs;\r\ndws->bus_num = desc->bus_num;\r\nif (desc->setup) {\r\nret = desc->setup(dws);\r\nif (ret)\r\nreturn ret;\r\n}\r\n} else {\r\nreturn -ENODEV;\r\n}\r\nret = dw_spi_add_host(&pdev->dev, dws);\r\nif (ret)\r\nreturn ret;\r\npci_set_drvdata(pdev, dwpci);\r\ndev_info(&pdev->dev, "found PCI SPI controller(ID: %04x:%04x)\n",\r\npdev->vendor, pdev->device);\r\nreturn 0;\r\n}\r\nstatic void spi_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct dw_spi_pci *dwpci = pci_get_drvdata(pdev);\r\ndw_spi_remove_host(&dwpci->dws);\r\n}\r\nstatic int spi_suspend(struct device *dev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct dw_spi_pci *dwpci = pci_get_drvdata(pdev);\r\nreturn dw_spi_suspend_host(&dwpci->dws);\r\n}\r\nstatic int spi_resume(struct device *dev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct dw_spi_pci *dwpci = pci_get_drvdata(pdev);\r\nreturn dw_spi_resume_host(&dwpci->dws);\r\n}

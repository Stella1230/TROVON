static int hx8357_spi_write_then_read(struct lcd_device *lcdev,\r\nu8 *txbuf, u16 txlen,\r\nu8 *rxbuf, u16 rxlen)\r\n{\r\nstruct hx8357_data *lcd = lcd_get_data(lcdev);\r\nstruct spi_message msg;\r\nstruct spi_transfer xfer[2];\r\nu16 *local_txbuf = NULL;\r\nint ret = 0;\r\nmemset(xfer, 0, sizeof(xfer));\r\nspi_message_init(&msg);\r\nif (txlen) {\r\nint i;\r\nlocal_txbuf = kcalloc(txlen, sizeof(*local_txbuf), GFP_KERNEL);\r\nif (!local_txbuf)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < txlen; i++) {\r\nlocal_txbuf[i] = txbuf[i];\r\nif (i > 0)\r\nlocal_txbuf[i] |= 1 << 8;\r\n}\r\nxfer[0].len = 2 * txlen;\r\nxfer[0].bits_per_word = 9;\r\nxfer[0].tx_buf = local_txbuf;\r\nspi_message_add_tail(&xfer[0], &msg);\r\n}\r\nif (rxlen) {\r\nxfer[1].len = rxlen;\r\nxfer[1].bits_per_word = 8;\r\nxfer[1].rx_buf = rxbuf;\r\nspi_message_add_tail(&xfer[1], &msg);\r\n}\r\nret = spi_sync(lcd->spi, &msg);\r\nif (ret < 0)\r\ndev_err(&lcdev->dev, "Couldn't send SPI data\n");\r\nif (txlen)\r\nkfree(local_txbuf);\r\nreturn ret;\r\n}\r\nstatic inline int hx8357_spi_write_array(struct lcd_device *lcdev,\r\nu8 *value, u8 len)\r\n{\r\nreturn hx8357_spi_write_then_read(lcdev, value, len, NULL, 0);\r\n}\r\nstatic inline int hx8357_spi_write_byte(struct lcd_device *lcdev,\r\nu8 value)\r\n{\r\nreturn hx8357_spi_write_then_read(lcdev, &value, 1, NULL, 0);\r\n}\r\nstatic int hx8357_enter_standby(struct lcd_device *lcdev)\r\n{\r\nint ret;\r\nret = hx8357_spi_write_byte(lcdev, HX8357_SET_DISPLAY_OFF);\r\nif (ret < 0)\r\nreturn ret;\r\nusleep_range(10000, 12000);\r\nret = hx8357_spi_write_byte(lcdev, HX8357_ENTER_SLEEP_MODE);\r\nif (ret < 0)\r\nreturn ret;\r\nmsleep(120);\r\nreturn 0;\r\n}\r\nstatic int hx8357_exit_standby(struct lcd_device *lcdev)\r\n{\r\nint ret;\r\nret = hx8357_spi_write_byte(lcdev, HX8357_EXIT_SLEEP_MODE);\r\nif (ret < 0)\r\nreturn ret;\r\nmsleep(120);\r\nret = hx8357_spi_write_byte(lcdev, HX8357_SET_DISPLAY_ON);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic void hx8357_lcd_reset(struct lcd_device *lcdev)\r\n{\r\nstruct hx8357_data *lcd = lcd_get_data(lcdev);\r\ngpio_set_value(lcd->reset, 1);\r\nusleep_range(10000, 12000);\r\ngpio_set_value(lcd->reset, 0);\r\nusleep_range(10000, 12000);\r\ngpio_set_value(lcd->reset, 1);\r\nmsleep(120);\r\n}\r\nstatic int hx8357_lcd_init(struct lcd_device *lcdev)\r\n{\r\nstruct hx8357_data *lcd = lcd_get_data(lcdev);\r\nint ret;\r\nif (lcd->use_im_pins) {\r\ngpio_set_value_cansleep(lcd->im_pins[0], 1);\r\ngpio_set_value_cansleep(lcd->im_pins[1], 0);\r\ngpio_set_value_cansleep(lcd->im_pins[2], 1);\r\n}\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_power,\r\nARRAY_SIZE(hx8357_seq_power));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_vcom,\r\nARRAY_SIZE(hx8357_seq_vcom));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_power_normal,\r\nARRAY_SIZE(hx8357_seq_power_normal));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_panel_driving,\r\nARRAY_SIZE(hx8357_seq_panel_driving));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_display_frame,\r\nARRAY_SIZE(hx8357_seq_display_frame));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_panel_related,\r\nARRAY_SIZE(hx8357_seq_panel_related));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_undefined1,\r\nARRAY_SIZE(hx8357_seq_undefined1));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_undefined2,\r\nARRAY_SIZE(hx8357_seq_undefined2));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_gamma,\r\nARRAY_SIZE(hx8357_seq_gamma));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_address_mode,\r\nARRAY_SIZE(hx8357_seq_address_mode));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_pixel_format,\r\nARRAY_SIZE(hx8357_seq_pixel_format));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_column_address,\r\nARRAY_SIZE(hx8357_seq_column_address));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_page_address,\r\nARRAY_SIZE(hx8357_seq_page_address));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_rgb,\r\nARRAY_SIZE(hx8357_seq_rgb));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8357_seq_display_mode,\r\nARRAY_SIZE(hx8357_seq_display_mode));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_byte(lcdev, HX8357_EXIT_SLEEP_MODE);\r\nif (ret < 0)\r\nreturn ret;\r\nmsleep(120);\r\nret = hx8357_spi_write_byte(lcdev, HX8357_SET_DISPLAY_ON);\r\nif (ret < 0)\r\nreturn ret;\r\nusleep_range(5000, 7000);\r\nret = hx8357_spi_write_byte(lcdev, HX8357_WRITE_MEMORY_START);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int hx8369_lcd_init(struct lcd_device *lcdev)\r\n{\r\nint ret;\r\nret = hx8357_spi_write_array(lcdev, hx8369_seq_extension_command,\r\nARRAY_SIZE(hx8369_seq_extension_command));\r\nif (ret < 0)\r\nreturn ret;\r\nusleep_range(10000, 12000);\r\nret = hx8357_spi_write_array(lcdev, hx8369_seq_display_related,\r\nARRAY_SIZE(hx8369_seq_display_related));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8369_seq_panel_waveform_cycle,\r\nARRAY_SIZE(hx8369_seq_panel_waveform_cycle));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8369_seq_set_address_mode,\r\nARRAY_SIZE(hx8369_seq_set_address_mode));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8369_seq_vcom,\r\nARRAY_SIZE(hx8369_seq_vcom));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8369_seq_gip,\r\nARRAY_SIZE(hx8369_seq_gip));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev, hx8369_seq_power,\r\nARRAY_SIZE(hx8369_seq_power));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_byte(lcdev, HX8357_EXIT_SLEEP_MODE);\r\nif (ret < 0)\r\nreturn ret;\r\nmsleep(120);\r\nret = hx8357_spi_write_array(lcdev, hx8369_seq_gamma_curve_related,\r\nARRAY_SIZE(hx8369_seq_gamma_curve_related));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_byte(lcdev, HX8357_EXIT_SLEEP_MODE);\r\nif (ret < 0)\r\nreturn ret;\r\nusleep_range(1000, 1200);\r\nret = hx8357_spi_write_array(lcdev, hx8369_seq_write_CABC_control,\r\nARRAY_SIZE(hx8369_seq_write_CABC_control));\r\nif (ret < 0)\r\nreturn ret;\r\nusleep_range(10000, 12000);\r\nret = hx8357_spi_write_array(lcdev,\r\nhx8369_seq_write_CABC_control_setting,\r\nARRAY_SIZE(hx8369_seq_write_CABC_control_setting));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_array(lcdev,\r\nhx8369_seq_write_CABC_min_brightness,\r\nARRAY_SIZE(hx8369_seq_write_CABC_min_brightness));\r\nif (ret < 0)\r\nreturn ret;\r\nusleep_range(10000, 12000);\r\nret = hx8357_spi_write_array(lcdev, hx8369_seq_set_display_brightness,\r\nARRAY_SIZE(hx8369_seq_set_display_brightness));\r\nif (ret < 0)\r\nreturn ret;\r\nret = hx8357_spi_write_byte(lcdev, HX8357_SET_DISPLAY_ON);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int hx8357_set_power(struct lcd_device *lcdev, int power)\r\n{\r\nstruct hx8357_data *lcd = lcd_get_data(lcdev);\r\nint ret = 0;\r\nif (POWER_IS_ON(power) && !POWER_IS_ON(lcd->state))\r\nret = hx8357_exit_standby(lcdev);\r\nelse if (!POWER_IS_ON(power) && POWER_IS_ON(lcd->state))\r\nret = hx8357_enter_standby(lcdev);\r\nif (ret == 0)\r\nlcd->state = power;\r\nelse\r\ndev_warn(&lcdev->dev, "failed to set power mode %d\n", power);\r\nreturn ret;\r\n}\r\nstatic int hx8357_get_power(struct lcd_device *lcdev)\r\n{\r\nstruct hx8357_data *lcd = lcd_get_data(lcdev);\r\nreturn lcd->state;\r\n}\r\nstatic int hx8357_probe(struct spi_device *spi)\r\n{\r\nstruct lcd_device *lcdev;\r\nstruct hx8357_data *lcd;\r\nconst struct of_device_id *match;\r\nint i, ret;\r\nlcd = devm_kzalloc(&spi->dev, sizeof(*lcd), GFP_KERNEL);\r\nif (!lcd)\r\nreturn -ENOMEM;\r\nret = spi_setup(spi);\r\nif (ret < 0) {\r\ndev_err(&spi->dev, "SPI setup failed.\n");\r\nreturn ret;\r\n}\r\nlcd->spi = spi;\r\nmatch = of_match_device(hx8357_dt_ids, &spi->dev);\r\nif (!match || !match->data)\r\nreturn -EINVAL;\r\nlcd->reset = of_get_named_gpio(spi->dev.of_node, "gpios-reset", 0);\r\nif (!gpio_is_valid(lcd->reset)) {\r\ndev_err(&spi->dev, "Missing dt property: gpios-reset\n");\r\nreturn -EINVAL;\r\n}\r\nret = devm_gpio_request_one(&spi->dev, lcd->reset,\r\nGPIOF_OUT_INIT_HIGH,\r\n"hx8357-reset");\r\nif (ret) {\r\ndev_err(&spi->dev,\r\n"failed to request gpio %d: %d\n",\r\nlcd->reset, ret);\r\nreturn -EINVAL;\r\n}\r\nif (of_find_property(spi->dev.of_node, "im-gpios", NULL)) {\r\nlcd->use_im_pins = 1;\r\nfor (i = 0; i < HX8357_NUM_IM_PINS; i++) {\r\nlcd->im_pins[i] = of_get_named_gpio(spi->dev.of_node,\r\n"im-gpios", i);\r\nif (lcd->im_pins[i] == -EPROBE_DEFER) {\r\ndev_info(&spi->dev, "GPIO requested is not here yet, deferring the probe\n");\r\nreturn -EPROBE_DEFER;\r\n}\r\nif (!gpio_is_valid(lcd->im_pins[i])) {\r\ndev_err(&spi->dev, "Missing dt property: im-gpios\n");\r\nreturn -EINVAL;\r\n}\r\nret = devm_gpio_request_one(&spi->dev, lcd->im_pins[i],\r\nGPIOF_OUT_INIT_LOW,\r\n"im_pins");\r\nif (ret) {\r\ndev_err(&spi->dev, "failed to request gpio %d: %d\n",\r\nlcd->im_pins[i], ret);\r\nreturn -EINVAL;\r\n}\r\n}\r\n} else {\r\nlcd->use_im_pins = 0;\r\n}\r\nlcdev = devm_lcd_device_register(&spi->dev, "mxsfb", &spi->dev, lcd,\r\n&hx8357_ops);\r\nif (IS_ERR(lcdev)) {\r\nret = PTR_ERR(lcdev);\r\nreturn ret;\r\n}\r\nspi_set_drvdata(spi, lcdev);\r\nhx8357_lcd_reset(lcdev);\r\nret = ((int (*)(struct lcd_device *))match->data)(lcdev);\r\nif (ret) {\r\ndev_err(&spi->dev, "Couldn't initialize panel\n");\r\nreturn ret;\r\n}\r\ndev_info(&spi->dev, "Panel probed\n");\r\nreturn 0;\r\n}
